{"context": "Raspberry Pi \u306e\u30ab\u30e1\u30e9\u30e2\u30b8\u30e5\u30fc\u30eb\u3092\u4f7f\u3063\u3066\u9854\u8a8d\u8b58\u3092\u3057\u3066\u307f\u305f\u5fd8\u5099\u9332\u3067\u3059\u3002\n\n\n\u74b0\u5883\n\n\nRaspberry Pi3 (RASPBIAN JESSIE WITH PIXEL 4.4\u3000/ node.js v6.8.1)\nRaspberry Pi \u30ab\u30e1\u30e9\u30e2\u30b8\u30e5\u30fc\u30eb Raspberry Pi Camera Board\nRaspberry Pi \u30ab\u30e1\u30e9\u30e2\u30b8\u30e5\u30fc\u30eb\u5c02\u7528\u3000Black\u30b1\u30fc\u30b9\n\n\n\n\u30d1\u30eb\u30d7\u30fb\u30d5\u30a3\u30af\u30b7\u30e7\u30f3/ \u30b5\u30df\u30e5\u30a8\u30eb\u30fbL\u30fb\u30b8\u30e3\u30af\u30bd\u30f3 \u30b8\u30e5\u30fc\u30eb\u30b9\u30fb\u30a6\u30a3\u30f3\u30d5\u30a3\u30fc\u30eb\u30c9 13\u30a4\u30f3\u30c1 \u30c8\u30fc\u30ad\u30f3\u30b0\u30d5\u30a3\u30ae\u30e5\u30a2\n\n\n\u30ab\u30e1\u30e9\u30e2\u30b8\u30e5\u30fc\u30eb\u306e\u5199\u771f\u3092socket.io\u3067\u9001\u4fe1\u3059\u308b\n\u4ee5\u524d\u3053\u3093\u306a\u98a8\u306b\u8a66\u3057\u3066\u307f\u307e\u3057\u305f\u3002\nRaspberry Pi \u306e\u30ab\u30e1\u30e9\u30e2\u30b8\u30e5\u30fc\u30eb\u3068Node.js\u3067\u5199\u771f\u3092\u64ae\u308b - Qiita\nRaspberry Pi \u306e\u30ab\u30e1\u30e9\u30e2\u30b8\u30e5\u30fc\u30eb\u3068Node.js\u3067\u30b9\u30c8\u30ea\u30fc\u30df\u30f3\u30b0 - Qiita\n\u3069\u3061\u3089\u3082\u64ae\u5f71\u3057\u305f\u753b\u50cf\u3092\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u30b5\u30a4\u30c9\u3067\u66f4\u65b0\u3057\u3066\u3044\u305f\u306e\u3067\u3059\u304c\u3001\u3053\u308c\u3092\u30b5\u30fc\u30d0\u30fc\u30b5\u30a4\u30c9\u3067\u66f4\u65b0\u3057\u3066\u307f\u305f\u3044\u3068\u601d\u3044\u307e\u3059\u3002\n\n\napp.js\nvar express = require(\"express\"),\n    app = express(),\n    server = require('http').Server(app),\n    io = require('socket.io')(server),\n    fs = require('fs'),\n    exec = require('child_process').exec;\n\napp.use(express.static(__dirname + '/public'));\n\napp.get('/', function (req, res) {\n    res.sendFile(__dirname + '/index.html');\n});\n\nserver.listen(8080, function () {\n  console.log('listening on *:8080');\n});\n\nio.sockets.on('connection', function (socket) {\n\nsocket.on('shutter', function () {\n\n  var raspistill = exec('raspistill -o ./public/images/output.jpg -h 480 -w 640 -t 100 -n');\n\n  raspistill.on('close', function () {\n    console.log('\u5199\u771f\u3092\u64ae\u308a\u307e\u3057\u305f');\n  });\n\n  setTimeout(function () {\n  fs.readFile('./public/images/output.jpg', function(err, buf){\n    socket.emit('image', { image: true, buffer: buf.toString('base64')});\n    console.log('\u753b\u50cf\u3092\u9001\u4fe1\u3057\u307e\u3059\u2026');\n  });\n}, 800);\n});\n});\n\n\n\nexpress\u3067\u30b5\u30fc\u30d0\u30fc\u3092\u7acb\u3066\u3001socket.io\u3092\u5229\u7528\u3057\u3066\u753b\u50cf\u3092\u9001\u4fe1\u3057\u307e\u3059\u3002\u753b\u50cf\u306fpublic\u30d5\u30a9\u30eb\u30c0\u306b\u683c\u7d0d\u3057\u307e\u3059\u3002\uff08Express \u3067\u306e\u9759\u7684\u30d5\u30a1\u30a4\u30eb\u306e\u63d0\u4f9b\uff09\n\u30e9\u30ba\u30d1\u30a4\u306e\u30ab\u30e1\u30e9\u30e2\u30b8\u30e5\u30fc\u30eb\u3067child_process exec\u30b3\u30de\u30f3\u30c9\u3067\u5199\u771f\u3092\u64ae\u5f71\u3057\u3001\u5199\u771f\u306f/public/images\u30d5\u30a9\u30eb\u30c0\u306b\u4fdd\u5b58\u3057\u307e\u3059\u3002(child_process.exec(command[, options][, callback]) - Node.js)\n\u4fdd\u5b58\u3057\u305f\u5199\u771f\u3092Base64\u306b\u30a8\u30f3\u30b3\u30fc\u30c9\u3057\u3001\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u30b5\u30a4\u30c9\u306b\u9001\u4fe1\u3057\u307e\u3059\u3002(socket io, node js, Simple example to send image/files from server to client - Stack Overflow)\nBase64\u306b\u3059\u308b\u3053\u3068\u3067\u753b\u50cf\u306e\u540d\u524d\u3092\u66f4\u65b0\u3057\u306a\u304f\u3066\u3082\u826f\u3044\uff08\u4f8b\u3048\u3070image_20161112_01.jpg\u3001image_20161112_0\uff12.jpg\u2026\u306a\u3069\uff09\u3068\u8a00\u3046\u308f\u3051\u3067\u3059\u3002\n\nindex.html\n<!DOCTYPE html>\n<html>\n<head lang=\"ja\">\n    <meta charset=\"utf-8\">\n    <title>PonCam</title>\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">\n    <link rel=\"stylesheet\" href=\"https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css\" integrity=\"sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u\" crossorigin=\"anonymous\">\n    <link href=\"https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css\" rel=\"stylesheet\" integrity=\"sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1\" crossorigin=\"anonymous\">\n    <link href=\"https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/9.2.0/css/bootstrap-slider.css\" rel=\"stylesheet\">\n    <link href=\"https://fonts.googleapis.com/css?family=Orbitron\" rel=\"stylesheet\">\n    <link href=\"/css/style.css\" rel=\"stylesheet\">\n</head>\n<body>\n  <h1>PonCam</h1>\n<div id=\"container\">\n    <img class=\"img-responsive\" id=\"image\">\n    <br>\n    <button class=\"btn btn-default\" id=\"shutter\">Shutter</button>\n</div>\n<script src=\"https://cdn.socket.io/socket.io-1.2.0.js\"></script>\n<script src=\"http://code.jquery.com/jquery-3.0.0.js\"></script>\n<script src=\"/js/main.js\"></script>\n</body>\n</html>\n\n\n\n\npublic/css/style.css\nbody{\n  font-family: 'Orbitron', sans-serif;\n  background-color: #3D8EB9;\n  color: #f6f6f6;\n  max-width: 640px;\n  margin: 0 auto;;\n  padding: 20px;\n}\n\n\n\npublic/js/main.js\n$(document).ready(function() {\n  var socket = io();\n  $(\"#shutter\").click(function() {\n    socket.emit('shutter');\n  });\n  socket.on('image', function(face) {\n     $(\"#image\").attr('src', 'data:image/jpg;base64,' + face.buffer );\n  });\n});\n\n\n\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u30b5\u30a4\u30c9\u306e/js/main.js\u3068/css/style.css\u306f\u753b\u50cf\u306e\u4fdd\u5b58\u7528\u306b\u4f5c\u3063\u305fpublic\u30d5\u30a9\u30eb\u30c0\u306b\u683c\u7d0d\u3057\u307e\u3057\u305f\u3002\nsocket.io\u3067\u9001\u4fe1\u3055\u308c\u305fBase64\u306b\u5909\u63db\u3055\u308c\u305f\u753b\u50cf\u30c7\u30fc\u30bf\u3092\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u30b5\u30a4\u30c9\u3067\u53d7\u3051\u53d6\u308a\u3001img\u8981\u7d20\u306esrc\u5c5e\u6027\u306b\u6307\u5b9a\u3057\u307e\u3059\u3002\nsocket.io\u3067\u63a5\u7d9a\u3055\u308c\u3066\u3044\u308b\u306e\u3067\u3001window.onload\u306a\u3069\u3092\u4f7f\u308f\u306a\u304f\u3066\u3082\u753b\u50cf\u306f\u81ea\u52d5\u7684\u306b\u66f4\u65b0\u3055\u308c\u307e\u3059\u3002\n\n\u3000\u30b9\u30c8\u30ea\u30fc\u30df\u30f3\u30b0\u3059\u308b\n\n\u30b9\u30c8\u30ea\u30fc\u30df\u30f3\u30b0\u3059\u308b\u969b\u306f\u3001\u5199\u771f\u64ae\u5f71\u30fb\u9001\u4fe1\u3092\u30bb\u30c3\u30c8\u306b\u3057\u3066setInterval\u3092\u4f7f\u3044\u30eb\u30fc\u30d7\u51e6\u7406\u3092\u3057\u307e\u3059\u3002\n\napp.js\n//\u7565\n\nio.sockets.on('connection', function (socket) {\n\nsocket.on('shutter', function () {\n\n  setInterval(function () {\n\n  var raspistill = exec('raspistill -o ./public/images/output.jpg -h 480 -w 640 -t 100 -n');\n\n  raspistill.on('close', function () {\n    console.log('\u5199\u771f\u3092\u64ae\u308a\u307e\u3057\u305f');\n  });\n\n  setTimeout(function () {\n  fs.readFile('./public/images/output.jpg', function(err, buf){\n    socket.emit('image', { image: true, buffer: buf.toString('base64')});\n    console.log('\u753b\u50cf\u3092\u9001\u4fe1\u3057\u307e\u3059\u2026');\n  });\n}, 800);\n}, 1000);\n});\n});\n\n\n\u3053\u306e\u5834\u5408\u3082socke.io\u3067\u63a5\u7d9a\u3055\u308c\u3066\u3044\u308b\u306e\u3067\u81ea\u52d5\u7684\u306b\u753b\u50cf\u304c\u66f4\u65b0\u3055\u308c\u307e\u3059\u3002\n\nOpen CV3\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\nRasPi\u306bOpen CV3\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u65b9\u6cd5\u306f\u3053\u3061\u3089\u306e\u6d77\u5916\u8a18\u4e8b\u306b\u8a73\u3057\u304f\u89e3\u8aac\u3055\u308c\u3066\u3044\u307e\u3059\u3002\nInstall guide: Raspberry Pi 3 + Raspbian Jessie + OpenCV 3 - pyimageserch\n\u65e5\u672c\u8a9e\u306e\u89e3\u8aac\u8a18\u4e8b\u306f\u3053\u3061\u3089\u304c\u53c2\u8003\u306b\u306a\u308a\u307e\u3057\u305f\u3002\nRaspberry Pi 3\u306bOpenCV 3.1\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb - TomoSoft\n\u4eca\u56de\u306fNode.js\u3067\u5229\u7528\u3057\u307e\u3059\u306e\u3067\u3001\u4ee5\u4e0b\u306e\u30e2\u30b8\u30e5\u30fc\u30eb\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u307e\u3059\u3002\npeterbraden/node-opencv - GitHub\n\n\u9854\u8a8d\u8b58\u3059\u308b\nnode-opencv\u306e\u30b5\u30f3\u30d7\u30eb\u30d7\u30ed\u30b0\u30e9\u30e0\u3092\u5229\u7528\u3057\u3066\u9854\u8a8d\u8b58\u3057\u305f\u753b\u50cf\u3092\u8868\u793a\u3055\u305b\u3066\u307f\u307e\u3059\u3002\n\n\u9854\u8a8d\u8b58\n\u307e\u305a\u306f\u9854\u8a8d\u8b58\u3092\u3057\u3066\u307f\u307e\u3059\u3002\n\nnode-opencv\u306e\u30b5\u30f3\u30d7\u30ebface-detection.js\u3092\u305d\u306e\u307e\u307e\u5229\u7528\u3057\u307e\u3059\u3002\n\napp.js\nvar cv = require('opencv');\n\ncv.readImage(\"./public/images/output.jpg\", function(err, im){\n  im.detectObject(cv.FACE_CASCADE, {}, function(err, faces){\n    for (var i=0;i<faces.length; i++){\n      var x = faces[i]\n      im.ellipse(x.x + x.width/2, x.y + x.height/2, x.width/2, x.height/2);\n    }\n  im.save('./public/images/face.jpg');\n  console.log('\u9854\u8a8d\u8a3c\u3092\u3057\u307e\u3057\u305f');\n      fs.readFile('./public/images/face.jpg', function(err, buf){\n      socket.emit('image', { image: true, buffer: buf.toString('base64')});\n      console.log('\u753b\u50cf\u3092\u9001\u4fe1\u3057\u307e\u3059\u2026');\n    });\n  });\n});  \n}, 3000);\n\n\n\n\u5148\u7a0b\u306e\u5199\u771f\u64ae\u5f71\u3001\u9001\u4fe1\u306e\u9593\u306b\u3053\u306e\u9854\u8a8d\u8b58\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u633f\u5165\u3057\u307e\u3059\u3002\n\n\u9854\u8a8d\u8b58\uff08\u9577\u65b9\u5f62\uff09\n\u30ec\u30af\u30bf\u30f3\u30c0\u30eb\uff08\u9577\u65b9\u5f62\uff09\u3067\u9854\u8a8d\u8b58\u3059\u308b\u969b\u306fface-detection-rectangle.js\u3053\u3061\u3089\u306e\u30b3\u30fc\u30c9\u3092\u5229\u7528\u3057\u307e\u3059\u3002\n\n\napp.js\nvar cv = require('opencv');\n\nvar COLOR = [255, 255, 255]; // default red\nvar thickness = 2; // default 1\n\nsetTimeout(function () {\n  cv.readImage('./public/images/output.jpg', function(err, im) {\n  if (err) throw err;\n  if (im.width() < 1 || im.height() < 1) throw new Error('Image has no size');\n\n  im.detectObject('./node_modules/opencv/data/haarcascade_frontalface_alt2.xml', {}, function(err, faces) {\n    if (err) throw err;\n\n    for (var i = 0; i < faces.length; i++) {\n      face = faces[i];\n      im.rectangle([face.x, face.y], [face.width, face.height], COLOR, 2);\n    }\n\n    im.save('./public/images/face.jpg');\n    console.log('\u9854\u8a8d\u8b58\u3057\u307e\u3057\u305f');\n    fs.readFile('./public/images/face.jpg', function(err, buf){\n      socket.emit('image', { image: true, buffer: buf.toString('base64')});\n      console.log('\u753b\u50cf\u3092\u9001\u4fe1\u3057\u307e\u3059\u2026');\n    });\n  });\n});  \n}, 3000);\n\n\n\n\u9854\u8a8d\u8b58\uff08\u9577\u65b9\u5f62\uff09\u306e\u30b9\u30c8\u30ea\u30fc\u30df\u30f3\u30b0\n\u5148\u7a0b\u884c\u3063\u305f\u3088\u3046\u306b\u3001\u5199\u771f\u64ae\u5f71\u30fb\u9001\u4fe1\u3092\u30bb\u30c3\u30c8\u306b\u3057\u3066setInterval\u3092\u4f7f\u3044\u30eb\u30fc\u30d7\u51e6\u7406\u3092\u3059\u308c\u3070\u30b9\u30c8\u30ea\u30fc\u30df\u30f3\u30b0\u3057\u305f\u753b\u50cf\u306e\u9854\u8a8d\u8b58\u304c\u51fa\u6765\u307e\u3059\u3002\n\n\n\u9854\u8a8d\u8b58\u3057\u305f\u753b\u50cf\u3092\u5207\u308a\u51fa\u3059\n\u9854\u3092\u5207\u308a\u51fa\u3059\u5834\u5408\u306ftake-face-pics.js\u3092\u5229\u7528\u3057\u307e\u3059\u3002\n\n\napp.js\nvar cv = require('opencv');\n\ncv.readImage('./public/images/output.jpg', function(err, im) {\n  if (err) throw err;\n    if (im.size()[0] > 0 && im.size()[1] > 0){\n\n      im.detectObject(cv.FACE_CASCADE, {}, function(err, faces){\n        if (err) throw err;\n        if (!faces.length) return console.log(\"No Faces\");\n\n        var face = faces[0];\n        var ims = im.size();\n        var im2 = im.roi(face.x, face.y, face.width, face.height)\n\n        im.adjustROI(\n             -face.y\n           , (face.y + face.height) - ims[0]\n           , -face.x\n           , (face.x + face.width) - ims[1])\n\n        im2.save('./public/images/face_2.jpg')\n        console.log('\u9854\u8a8d\u8a3c\u3092\u5207\u308a\u51fa\u3057\u307e\u3057\u305f');\n      })\n    } else {\n      console.log(\"Camera didn't return image\")\n    }\n  });\n\n\n\u30b5\u30f3\u30d7\u30eb\u30b3\u30fc\u30c9\u306fWeb\u30ab\u30e1\u30e9\u306e\u52d5\u753b\u3092\u5207\u308a\u51fa\u3059\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u308b\u70ba\u3001cv.readImage\u3092\u5229\u7528\u3057\u3066\u753b\u50cf\u3092\u8aad\u307f\u8fbc\u3080\u3088\u3046\u306b\u5909\u66f4\u3057\u3066\u3044\u307e\u3059\u3002\n\n\u307e\u3068\u3081\n\u4eca\u56de\u306f\u30ab\u30e1\u30e9\u30e2\u30b8\u30e5\u30fc\u30eb\u3092\u5229\u7528\u3059\u308b\u70ba\u5c11\u3005\u9762\u5012\u306a\u8a18\u8ff0\u306b\u306a\u3063\u3066\u3057\u307e\u3044\u307e\u3057\u305f\u304c\u3001RasPi\u306bWeb\u30ab\u30e1\u30e9\u3092\u63a5\u7d9a\u3059\u308c\u3070\u3082\u3063\u3068\u7c21\u5358\u306b\u30b9\u30c8\u30ea\u30fc\u30df\u30f3\u30b0\u3057\u305f\u3082\u306e\u3092\u9854\u8a8d\u8a3c\u3055\u305b\u308b\u3053\u3068\u304c\u51fa\u6765\u307e\u3059\u3002\nReal-time face detection using OpenCV, Node.js, and WebSockets - Esther Jun Kim\nOpen CV\u306f\u30c7\u30d5\u30a9\u30eb\u30c8\u3067Web\u30ab\u30e1\u30e9\u3092\u8d77\u52d5\u3067\u304d\u308bcv.VideoCapture()\u3068\u8a00\u3046\u30b3\u30de\u30f3\u30c9\u304c\u4f7f\u3048\u308b\u306e\u3067\u3001\u624b\u3063\u53d6\u308a\u65e9\u304f\u5229\u7528\u3057\u305f\u3044\u65b9\u306f\u3053\u3061\u3089\u3092\u4f7f\u3063\u305f\u65b9\u304c\u826f\u3044\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u3002\n\u30ab\u30e1\u30e9\u30e2\u30b8\u30e5\u30fc\u30eb\u306f\u304b\u306a\u308a\u753b\u7d20\u6570\u3092\u7d30\u304b\u304f\u8a2d\u5b9a\u51fa\u6765\u308b\u306e\u3067\u3001\u8a8d\u8b58\u306e\u7cbe\u5ea6\u3092\u4e0a\u3052\u305f\u3044\u5834\u5408\u306a\u3069\u306b\u5229\u7528\u3059\u308b\u3068\u826f\u3044\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u3002\u3067\u306f\u3002\nRaspberry Pi \u306e\u30ab\u30e1\u30e9\u30e2\u30b8\u30e5\u30fc\u30eb\u3092\u4f7f\u3063\u3066\u9854\u8a8d\u8b58\u3092\u3057\u3066\u307f\u305f\u5fd8\u5099\u9332\u3067\u3059\u3002\n\n![2016-11-12 22_04_28.gif](https://qiita-image-store.s3.amazonaws.com/0/47128/37a7a1a0-e818-4922-4583-668512feb7bc.gif)\n\n## \u74b0\u5883\n\n![IMG_8845.jpg](https://qiita-image-store.s3.amazonaws.com/0/47128/b4c795e2-aa56-0710-3f4a-20a159d14f33.jpeg)\n\n- Raspberry Pi3 (RASPBIAN JESSIE WITH PIXEL 4.4\u3000/ node.js v6.8.1)\n- Raspberry Pi \u30ab\u30e1\u30e9\u30e2\u30b8\u30e5\u30fc\u30eb Raspberry Pi Camera Board\n- Raspberry Pi \u30ab\u30e1\u30e9\u30e2\u30b8\u30e5\u30fc\u30eb\u5c02\u7528\u3000Black\u30b1\u30fc\u30b9\n\n![IMG_8857.jpg](https://qiita-image-store.s3.amazonaws.com/0/47128/b318c1ca-9ebc-46d0-ce2b-8ed3208837c0.jpeg)\n\n- \u30d1\u30eb\u30d7\u30fb\u30d5\u30a3\u30af\u30b7\u30e7\u30f3/ \u30b5\u30df\u30e5\u30a8\u30eb\u30fbL\u30fb\u30b8\u30e3\u30af\u30bd\u30f3 \u30b8\u30e5\u30fc\u30eb\u30b9\u30fb\u30a6\u30a3\u30f3\u30d5\u30a3\u30fc\u30eb\u30c9 13\u30a4\u30f3\u30c1 \u30c8\u30fc\u30ad\u30f3\u30b0\u30d5\u30a3\u30ae\u30e5\u30a2\n\n## \u30ab\u30e1\u30e9\u30e2\u30b8\u30e5\u30fc\u30eb\u306e\u5199\u771f\u3092socket.io\u3067\u9001\u4fe1\u3059\u308b\n\n\u4ee5\u524d\u3053\u3093\u306a\u98a8\u306b\u8a66\u3057\u3066\u307f\u307e\u3057\u305f\u3002\n\n[Raspberry Pi \u306e\u30ab\u30e1\u30e9\u30e2\u30b8\u30e5\u30fc\u30eb\u3068Node.js\u3067\u5199\u771f\u3092\u64ae\u308b - Qiita](http://qiita.com/PonDad/items/de1fd557adf1d51ec0de)\n\n[Raspberry Pi \u306e\u30ab\u30e1\u30e9\u30e2\u30b8\u30e5\u30fc\u30eb\u3068Node.js\u3067\u30b9\u30c8\u30ea\u30fc\u30df\u30f3\u30b0 - Qiita](http://qiita.com/PonDad/items/9a6dbd6957df06a4532e)\n\n\u3069\u3061\u3089\u3082\u64ae\u5f71\u3057\u305f\u753b\u50cf\u3092\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u30b5\u30a4\u30c9\u3067\u66f4\u65b0\u3057\u3066\u3044\u305f\u306e\u3067\u3059\u304c\u3001\u3053\u308c\u3092\u30b5\u30fc\u30d0\u30fc\u30b5\u30a4\u30c9\u3067\u66f4\u65b0\u3057\u3066\u307f\u305f\u3044\u3068\u601d\u3044\u307e\u3059\u3002\n\n![PonCam 2016-11-12 10-48-13.png](https://qiita-image-store.s3.amazonaws.com/0/47128/96ded3ad-5f23-c16e-d2d5-2ac4a903db4c.png)\n\n\n```js:app.js\nvar express = require(\"express\"),\n    app = express(),\n    server = require('http').Server(app),\n    io = require('socket.io')(server),\n    fs = require('fs'),\n    exec = require('child_process').exec;\n\napp.use(express.static(__dirname + '/public'));\n\napp.get('/', function (req, res) {\n    res.sendFile(__dirname + '/index.html');\n});\n\nserver.listen(8080, function () {\n  console.log('listening on *:8080');\n});\n\nio.sockets.on('connection', function (socket) {\n\nsocket.on('shutter', function () {\n\n  var raspistill = exec('raspistill -o ./public/images/output.jpg -h 480 -w 640 -t 100 -n');\n\n  raspistill.on('close', function () {\n    console.log('\u5199\u771f\u3092\u64ae\u308a\u307e\u3057\u305f');\n  });\n\n  setTimeout(function () {\n  fs.readFile('./public/images/output.jpg', function(err, buf){\n    socket.emit('image', { image: true, buffer: buf.toString('base64')});\n    console.log('\u753b\u50cf\u3092\u9001\u4fe1\u3057\u307e\u3059\u2026');\n  });\n}, 800);\n});\n});\n\n```\n\n`express`\u3067\u30b5\u30fc\u30d0\u30fc\u3092\u7acb\u3066\u3001`socket.io`\u3092\u5229\u7528\u3057\u3066\u753b\u50cf\u3092\u9001\u4fe1\u3057\u307e\u3059\u3002\u753b\u50cf\u306f`public`\u30d5\u30a9\u30eb\u30c0\u306b\u683c\u7d0d\u3057\u307e\u3059\u3002\uff08[Express \u3067\u306e\u9759\u7684\u30d5\u30a1\u30a4\u30eb\u306e\u63d0\u4f9b](http://expressjs.com/ja/starter/static-files.html)\uff09\n\n\u30e9\u30ba\u30d1\u30a4\u306e\u30ab\u30e1\u30e9\u30e2\u30b8\u30e5\u30fc\u30eb\u3067`child_process exec`\u30b3\u30de\u30f3\u30c9\u3067\u5199\u771f\u3092\u64ae\u5f71\u3057\u3001\u5199\u771f\u306f`/public/images`\u30d5\u30a9\u30eb\u30c0\u306b\u4fdd\u5b58\u3057\u307e\u3059\u3002([child_process.exec(command[, options][, callback]) - Node.js](https://nodejs.org/api/child_process.html#child_process_child_process_exec_command_options_callback))\n\n\u4fdd\u5b58\u3057\u305f\u5199\u771f\u3092Base64\u306b\u30a8\u30f3\u30b3\u30fc\u30c9\u3057\u3001\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u30b5\u30a4\u30c9\u306b\u9001\u4fe1\u3057\u307e\u3059\u3002([socket io, node js, Simple example to send image/files from server to client - Stack Overflow](http://stackoverflow.com/questions/26331787/socket-io-node-js-simple-example-to-send-image-files-from-server-to-client))\n\nBase64\u306b\u3059\u308b\u3053\u3068\u3067\u753b\u50cf\u306e\u540d\u524d\u3092\u66f4\u65b0\u3057\u306a\u304f\u3066\u3082\u826f\u3044\uff08\u4f8b\u3048\u3070`image_20161112_01.jpg`\u3001`image_20161112_0\uff12.jpg`\u2026\u306a\u3069\uff09\u3068\u8a00\u3046\u308f\u3051\u3067\u3059\u3002\n\n```html:index.html\n<!DOCTYPE html>\n<html>\n<head lang=\"ja\">\n    <meta charset=\"utf-8\">\n    <title>PonCam</title>\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">\n    <link rel=\"stylesheet\" href=\"https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css\" integrity=\"sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u\" crossorigin=\"anonymous\">\n    <link href=\"https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css\" rel=\"stylesheet\" integrity=\"sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1\" crossorigin=\"anonymous\">\n    <link href=\"https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/9.2.0/css/bootstrap-slider.css\" rel=\"stylesheet\">\n    <link href=\"https://fonts.googleapis.com/css?family=Orbitron\" rel=\"stylesheet\">\n    <link href=\"/css/style.css\" rel=\"stylesheet\">\n</head>\n<body>\n  <h1>PonCam</h1>\n<div id=\"container\">\n    <img class=\"img-responsive\" id=\"image\">\n    <br>\n    <button class=\"btn btn-default\" id=\"shutter\">Shutter</button>\n</div>\n<script src=\"https://cdn.socket.io/socket.io-1.2.0.js\"></script>\n<script src=\"http://code.jquery.com/jquery-3.0.0.js\"></script>\n<script src=\"/js/main.js\"></script>\n</body>\n</html>\n\n```\n\n```css:public/css/style.css\nbody{\n  font-family: 'Orbitron', sans-serif;\n  background-color: #3D8EB9;\n  color: #f6f6f6;\n  max-width: 640px;\n  margin: 0 auto;;\n  padding: 20px;\n}\n```\n\n```js:public/js/main.js\n$(document).ready(function() {\n  var socket = io();\n  $(\"#shutter\").click(function() {\n    socket.emit('shutter');\n  });\n  socket.on('image', function(face) {\n     $(\"#image\").attr('src', 'data:image/jpg;base64,' + face.buffer );\n  });\n});\n```\n\n\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u30b5\u30a4\u30c9\u306e`/js/main.js`\u3068`/css/style.css`\u306f\u753b\u50cf\u306e\u4fdd\u5b58\u7528\u306b\u4f5c\u3063\u305f`public`\u30d5\u30a9\u30eb\u30c0\u306b\u683c\u7d0d\u3057\u307e\u3057\u305f\u3002\n\nsocket.io\u3067\u9001\u4fe1\u3055\u308c\u305fBase64\u306b\u5909\u63db\u3055\u308c\u305f\u753b\u50cf\u30c7\u30fc\u30bf\u3092\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u30b5\u30a4\u30c9\u3067\u53d7\u3051\u53d6\u308a\u3001`img`\u8981\u7d20\u306e`src`\u5c5e\u6027\u306b\u6307\u5b9a\u3057\u307e\u3059\u3002\n\nsocket.io\u3067\u63a5\u7d9a\u3055\u308c\u3066\u3044\u308b\u306e\u3067\u3001`window.onload`\u306a\u3069\u3092\u4f7f\u308f\u306a\u304f\u3066\u3082\u753b\u50cf\u306f\u81ea\u52d5\u7684\u306b\u66f4\u65b0\u3055\u308c\u307e\u3059\u3002\n\n##\u3000\u30b9\u30c8\u30ea\u30fc\u30df\u30f3\u30b0\u3059\u308b\n\n![2016-11-12 12_18_26.gif](https://qiita-image-store.s3.amazonaws.com/0/47128/ac73627d-182b-163b-2ca3-626841275049.gif)\n\n\n\u30b9\u30c8\u30ea\u30fc\u30df\u30f3\u30b0\u3059\u308b\u969b\u306f\u3001\u5199\u771f\u64ae\u5f71\u30fb\u9001\u4fe1\u3092\u30bb\u30c3\u30c8\u306b\u3057\u3066`setInterval`\u3092\u4f7f\u3044\u30eb\u30fc\u30d7\u51e6\u7406\u3092\u3057\u307e\u3059\u3002\n\n```js:app.js\n//\u7565\n\nio.sockets.on('connection', function (socket) {\n\nsocket.on('shutter', function () {\n\n  setInterval(function () {\n\n  var raspistill = exec('raspistill -o ./public/images/output.jpg -h 480 -w 640 -t 100 -n');\n\n  raspistill.on('close', function () {\n    console.log('\u5199\u771f\u3092\u64ae\u308a\u307e\u3057\u305f');\n  });\n\n  setTimeout(function () {\n  fs.readFile('./public/images/output.jpg', function(err, buf){\n    socket.emit('image', { image: true, buffer: buf.toString('base64')});\n    console.log('\u753b\u50cf\u3092\u9001\u4fe1\u3057\u307e\u3059\u2026');\n  });\n}, 800);\n}, 1000);\n});\n});\n```\n\u3053\u306e\u5834\u5408\u3082`socke.io`\u3067\u63a5\u7d9a\u3055\u308c\u3066\u3044\u308b\u306e\u3067\u81ea\u52d5\u7684\u306b\u753b\u50cf\u304c\u66f4\u65b0\u3055\u308c\u307e\u3059\u3002\n\n## Open CV3\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\nRasPi\u306bOpen CV3\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u65b9\u6cd5\u306f\u3053\u3061\u3089\u306e\u6d77\u5916\u8a18\u4e8b\u306b\u8a73\u3057\u304f\u89e3\u8aac\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n\n[Install guide: Raspberry Pi 3 + Raspbian Jessie + OpenCV 3 - pyimageserch](http://www.pyimagesearch.com/2016/04/18/install-guide-raspberry-pi-3-raspbian-jessie-opencv-3/)\n\n\u65e5\u672c\u8a9e\u306e\u89e3\u8aac\u8a18\u4e8b\u306f\u3053\u3061\u3089\u304c\u53c2\u8003\u306b\u306a\u308a\u307e\u3057\u305f\u3002\n\n[Raspberry Pi 3\u306bOpenCV 3.1\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb - TomoSoft](http://tomosoft.jp/design/?p=7476)\n\n\u4eca\u56de\u306fNode.js\u3067\u5229\u7528\u3057\u307e\u3059\u306e\u3067\u3001\u4ee5\u4e0b\u306e\u30e2\u30b8\u30e5\u30fc\u30eb\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u307e\u3059\u3002\n\n[peterbraden/node-opencv - GitHub](https://github.com/peterbraden/node-opencv)\n\n## \u9854\u8a8d\u8b58\u3059\u308b\n\n`node-opencv`\u306e\u30b5\u30f3\u30d7\u30eb\u30d7\u30ed\u30b0\u30e9\u30e0\u3092\u5229\u7528\u3057\u3066\u9854\u8a8d\u8b58\u3057\u305f\u753b\u50cf\u3092\u8868\u793a\u3055\u305b\u3066\u307f\u307e\u3059\u3002\n\n### \u9854\u8a8d\u8b58\n\n\u307e\u305a\u306f\u9854\u8a8d\u8b58\u3092\u3057\u3066\u307f\u307e\u3059\u3002\n\n![PonCam 2016-11-12 21-17-58.png](https://qiita-image-store.s3.amazonaws.com/0/47128/912fab84-8e21-060f-cf6f-175baf9f521e.png)\n\n`node-opencv`\u306e\u30b5\u30f3\u30d7\u30eb[`face-detection.js`](https://github.com/peterbraden/node-opencv/blob/master/examples/face-detection.js)\u3092\u305d\u306e\u307e\u307e\u5229\u7528\u3057\u307e\u3059\u3002\n\n```js:app.js\nvar cv = require('opencv');\n\ncv.readImage(\"./public/images/output.jpg\", function(err, im){\n  im.detectObject(cv.FACE_CASCADE, {}, function(err, faces){\n    for (var i=0;i<faces.length; i++){\n      var x = faces[i]\n      im.ellipse(x.x + x.width/2, x.y + x.height/2, x.width/2, x.height/2);\n    }\n  im.save('./public/images/face.jpg');\n  console.log('\u9854\u8a8d\u8a3c\u3092\u3057\u307e\u3057\u305f');\n      fs.readFile('./public/images/face.jpg', function(err, buf){\n      socket.emit('image', { image: true, buffer: buf.toString('base64')});\n      console.log('\u753b\u50cf\u3092\u9001\u4fe1\u3057\u307e\u3059\u2026');\n    });\n  });\n});  \n}, 3000);\n\n```\n\u5148\u7a0b\u306e\u5199\u771f\u64ae\u5f71\u3001\u9001\u4fe1\u306e\u9593\u306b\u3053\u306e\u9854\u8a8d\u8b58\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u633f\u5165\u3057\u307e\u3059\u3002\n\n### \u9854\u8a8d\u8b58\uff08\u9577\u65b9\u5f62\uff09\n\n\u30ec\u30af\u30bf\u30f3\u30c0\u30eb\uff08\u9577\u65b9\u5f62\uff09\u3067\u9854\u8a8d\u8b58\u3059\u308b\u969b\u306f[`face-detection-rectangle.js`](https://github.com/peterbraden/node-opencv/blob/master/examples/face-detection-rectangle.js)\u3053\u3061\u3089\u306e\u30b3\u30fc\u30c9\u3092\u5229\u7528\u3057\u307e\u3059\u3002\n\n![PonCam 2016-11-12 21-53-54.png](https://qiita-image-store.s3.amazonaws.com/0/47128/dea25f5d-088b-9f5d-46de-46911271af9f.png)\n\n\n```js:app.js\nvar cv = require('opencv');\n\nvar COLOR = [255, 255, 255]; // default red\nvar thickness = 2; // default 1\n\nsetTimeout(function () {\n  cv.readImage('./public/images/output.jpg', function(err, im) {\n  if (err) throw err;\n  if (im.width() < 1 || im.height() < 1) throw new Error('Image has no size');\n\n  im.detectObject('./node_modules/opencv/data/haarcascade_frontalface_alt2.xml', {}, function(err, faces) {\n    if (err) throw err;\n\n    for (var i = 0; i < faces.length; i++) {\n      face = faces[i];\n      im.rectangle([face.x, face.y], [face.width, face.height], COLOR, 2);\n    }\n\n    im.save('./public/images/face.jpg');\n    console.log('\u9854\u8a8d\u8b58\u3057\u307e\u3057\u305f');\n    fs.readFile('./public/images/face.jpg', function(err, buf){\n      socket.emit('image', { image: true, buffer: buf.toString('base64')});\n      console.log('\u753b\u50cf\u3092\u9001\u4fe1\u3057\u307e\u3059\u2026');\n    });\n  });\n});  \n}, 3000);\n```\n\n### \u9854\u8a8d\u8b58\uff08\u9577\u65b9\u5f62\uff09\u306e\u30b9\u30c8\u30ea\u30fc\u30df\u30f3\u30b0\n\n\u5148\u7a0b\u884c\u3063\u305f\u3088\u3046\u306b\u3001\u5199\u771f\u64ae\u5f71\u30fb\u9001\u4fe1\u3092\u30bb\u30c3\u30c8\u306b\u3057\u3066setInterval\u3092\u4f7f\u3044\u30eb\u30fc\u30d7\u51e6\u7406\u3092\u3059\u308c\u3070\u30b9\u30c8\u30ea\u30fc\u30df\u30f3\u30b0\u3057\u305f\u753b\u50cf\u306e\u9854\u8a8d\u8b58\u304c\u51fa\u6765\u307e\u3059\u3002\n\n![2016-11-12 22_04_28.gif](https://qiita-image-store.s3.amazonaws.com/0/47128/37a7a1a0-e818-4922-4583-668512feb7bc.gif)\n\n### \u9854\u8a8d\u8b58\u3057\u305f\u753b\u50cf\u3092\u5207\u308a\u51fa\u3059\n\n\u9854\u3092\u5207\u308a\u51fa\u3059\u5834\u5408\u306f[`take-face-pics.js`](https://github.com/peterbraden/node-opencv/blob/master/examples/take-face-pics.js)\u3092\u5229\u7528\u3057\u307e\u3059\u3002\n\n![face_2.jpg 2016-11-12 22-25-40.png](https://qiita-image-store.s3.amazonaws.com/0/47128/eb4482ae-9d9a-f5de-1ae7-fe509c4c4705.png)\n\n```js:app.js\nvar cv = require('opencv');\n\ncv.readImage('./public/images/output.jpg', function(err, im) {\n  if (err) throw err;\n    if (im.size()[0] > 0 && im.size()[1] > 0){\n\n      im.detectObject(cv.FACE_CASCADE, {}, function(err, faces){\n        if (err) throw err;\n        if (!faces.length) return console.log(\"No Faces\");\n\n        var face = faces[0];\n        var ims = im.size();\n        var im2 = im.roi(face.x, face.y, face.width, face.height)\n\n        im.adjustROI(\n             -face.y\n           , (face.y + face.height) - ims[0]\n           , -face.x\n           , (face.x + face.width) - ims[1])\n\n        im2.save('./public/images/face_2.jpg')\n        console.log('\u9854\u8a8d\u8a3c\u3092\u5207\u308a\u51fa\u3057\u307e\u3057\u305f');\n      })\n    } else {\n      console.log(\"Camera didn't return image\")\n    }\n  });\n```\n\u30b5\u30f3\u30d7\u30eb\u30b3\u30fc\u30c9\u306fWeb\u30ab\u30e1\u30e9\u306e\u52d5\u753b\u3092\u5207\u308a\u51fa\u3059\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u308b\u70ba\u3001`cv.readImage`\u3092\u5229\u7528\u3057\u3066\u753b\u50cf\u3092\u8aad\u307f\u8fbc\u3080\u3088\u3046\u306b\u5909\u66f4\u3057\u3066\u3044\u307e\u3059\u3002\n\n## \u307e\u3068\u3081\n\n\u4eca\u56de\u306f\u30ab\u30e1\u30e9\u30e2\u30b8\u30e5\u30fc\u30eb\u3092\u5229\u7528\u3059\u308b\u70ba\u5c11\u3005\u9762\u5012\u306a\u8a18\u8ff0\u306b\u306a\u3063\u3066\u3057\u307e\u3044\u307e\u3057\u305f\u304c\u3001RasPi\u306bWeb\u30ab\u30e1\u30e9\u3092\u63a5\u7d9a\u3059\u308c\u3070\u3082\u3063\u3068\u7c21\u5358\u306b\u30b9\u30c8\u30ea\u30fc\u30df\u30f3\u30b0\u3057\u305f\u3082\u306e\u3092\u9854\u8a8d\u8a3c\u3055\u305b\u308b\u3053\u3068\u304c\u51fa\u6765\u307e\u3059\u3002\n\n[Real-time face detection using OpenCV, Node.js, and WebSockets - Esther Jun Kim](http://drejkim.com/blog/2014/12/02/real-time-face-detection-using-opencv-nodejs-and-websockets/)\n\nOpen CV\u306f\u30c7\u30d5\u30a9\u30eb\u30c8\u3067Web\u30ab\u30e1\u30e9\u3092\u8d77\u52d5\u3067\u304d\u308b`cv.VideoCapture()`\u3068\u8a00\u3046\u30b3\u30de\u30f3\u30c9\u304c\u4f7f\u3048\u308b\u306e\u3067\u3001\u624b\u3063\u53d6\u308a\u65e9\u304f\u5229\u7528\u3057\u305f\u3044\u65b9\u306f\u3053\u3061\u3089\u3092\u4f7f\u3063\u305f\u65b9\u304c\u826f\u3044\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u3002\n\n\u30ab\u30e1\u30e9\u30e2\u30b8\u30e5\u30fc\u30eb\u306f\u304b\u306a\u308a\u753b\u7d20\u6570\u3092\u7d30\u304b\u304f\u8a2d\u5b9a\u51fa\u6765\u308b\u306e\u3067\u3001\u8a8d\u8b58\u306e\u7cbe\u5ea6\u3092\u4e0a\u3052\u305f\u3044\u5834\u5408\u306a\u3069\u306b\u5229\u7528\u3059\u308b\u3068\u826f\u3044\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u3002\u3067\u306f\u3002\n\n\n\n", "tags": ["RaspberryPi", "Node.js", "Socket.io", "OpenCV"]}