{"context": "\n\n\u521d\u6295\u7a3f\u3067\u3059\u304c\u3001\u305f\u3060\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u30e1\u30e2\u3067\u3059\n\u4eca\u56de\u306fAmazon Kinesis\u306b\u9001\u308b\n\nstream\u3092\u4f5c\u308b\n\naws kinesis create-stream --stream-name stream --shard-count 2\n\n\nstream\u306e\u60c5\u5831\u53d6\u5f97\n\naws kinesis describe-stream --stream-name stream\n{\n    \"StreamDescription\": {\n        \"StreamStatus\": \"ACTIVE\",\n        \"StreamName\": \"stream\",\n        \"StreamARN\": \"arn:aws:kinesis:ap-northeast-1:622601022736:stream/stream\",\n        \"Shards\": [\n            {\n                \"ShardId\": \"shardId-000000000000\",\n                \"HashKeyRange\": {\n                    \"EndingHashKey\": \"170141183460469231731687303715884105726\",\n                    \"StartingHashKey\": \"0\"\n                },\n                \"SequenceNumberRange\": {\n                    \"StartingSequenceNumber\": \"49562754734384102757616484984742799371518611138497478656\"\n                }\n            },\n            {\n                \"ShardId\": \"shardId-000000000001\",\n                \"HashKeyRange\": {\n                    \"EndingHashKey\": \"340282366920938463463374607431768211456\",\n                    \"StartingHashKey\": \"170141183460469231731687303715884105726\"\n                },\n                \"SequenceNumberRange\": {\n                    \"StartingSequenceNumber\": \"49562754734406403502815015607884335089791259500003459096\"\n                }\n            }\n        ]\n    }\n}\n\nfluentd\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\ncurl -L https://toolbelt.treasuredata.com/sh/install-redhat-td-agent2.sh | sh\n...\nInstalled:\n  td-agent.x86_64 0:2.3.1-0.el6\n\nComplete!\n\n\nfluent-plugin-kinesis\u3092\u4f7f\u3046\n\ntd-agent-gem install fluent-plugin-kinesis\nFetching: concurrent-ruby-1.0.2.gem (100%)\nSuccessfully installed concurrent-ruby-1.0.2\nFetching: os-0.9.6.gem (100%)\nSuccessfully installed os-0.9.6\nFetching: middleware-0.1.0.gem (100%)\nSuccessfully installed middleware-0.1.0\nFetching: protobuf-3.6.9.gem (100%)\nSuccessfully installed protobuf-3.6.9\nFetching: fluent-plugin-kinesis-1.0.1.gem (100%)\nSuccessfully installed fluent-plugin-kinesis-1.0.1\nParsing documentation for concurrent-ruby-1.0.2\nInstalling ri documentation for concurrent-ruby-1.0.2\nParsing documentation for os-0.9.6\nInstalling ri documentation for os-0.9.6\nParsing documentation for middleware-0.1.0\nInstalling ri documentation for middleware-0.1.0\nParsing documentation for protobuf-3.6.9\nInstalling ri documentation for protobuf-3.6.9\nParsing documentation for fluent-plugin-kinesis-1.0.1\nInstalling ri documentation for fluent-plugin-kinesis-1.0.1\nDone installing documentation for concurrent-ruby, os, middleware, protobuf, fluent-plugin-kinesis after 10 seconds\n5 gems installed\n\n\nfluentd\u306e\u8a2d\u5b9a\n\n\ntd-agent.conf\n<source>\n  type tail\n  format /^(?<month>[^ ]*) (?<day>[^ ]*) (?<times>[^ ]*) (?<proc>(.+))\\[(?<id>[^\\]]*)\\]: \\[(?<level>[^\\]]*)\\](?<content>(.+))$/\n  path /var/log/drive/activedrive-%Y%m%d.log\n  pos_file /var/log/td-agent/drive.kinesis.pos\n  tag drive.kinesis\n</source>\n\n<match drive.kinesis>\n  type kinesis\n  stream_name stream\n  region ap-northeast-1\n  random_partition_key true\n  use_yajl true\n  retry_limit 4\n  retry_wait 10s\n  flush_interval 1s\n  buffer_type file\n  buffer_path /var/log/td-agent/kinesis.*.buffer\n  buffer_chunk_limit 1024m\n  buffer_queue_limit 256\n</match>\n\n<filter drive.*>\n  type record_transformer\n  <record>\n    host \"#{Socket.gethostname}\"\n  </record>\n</filter>\n\n\n\n\ninclude_tag_key true\u3092\u8a2d\u5b9a\u3059\u308b\u3068\u51fa\u529b\u306btag\u3092\u8ffd\u52a0\u3067\u304d\u308b\n\u6d41\u308c\u308b\u30ed\u30b0\u306f\u3053\u3093\u306a\u306e\n\nJun 10 15:25:48 adfs[16132:36526832]: [DEV DEBUG]prop_server: quit()`\n\n\n\u51fa\u529b\u4f8b\n\n{\"month\":\"Jun\",\"day\":\"10\",\"times\":\"15:25:48\",\"proc\":\"adfs\",\"id\":\"16132:36526832\",\"level\":\"DEV DEBUG\",\"content\":\"prop_server: quit()\",\"host\":\"hostname\"}\n\n\n\u30ec\u30b3\u30fc\u30c9\u306e\u53d6\u5f97\n\u3068\u308a\u3042\u3048\u305aawscli\u3092\u4f7f\u3046\n\naws kinesis get-records --shard-iterator $(aws kinesis get-shard-iterator --stream-name stream --shard-id shardId-000000000000 --shard-iterator-type TRIM_HORIZON|jq .ShardIterator)\n{\n    \"Records\": [\n        {\n            \"PartitionKey\": \"390a8dfb-646b-4013-b730-02c02e77ae66\",\n            \"Data\": \"eyJtb250aCI6Ikp1biIsImRheSI6IjEwIiwidGltZXMiOiIxNToyNTo0OCIsInByb2MiOiJhZGZzIiwiaWQiOiIxNjEzMjozNjUyNjgzMiIsImxldmVsIjoiREVWIERFQlVHIiwiY29udGVudCI6InByb3Bfc2VydmVyOiBxdWl0KCkiLCJob3N0IjoiaG9zdG5hbWUifQ==\",\n            \"SequenceNumber\": \"49562754734384102757616484985846548644830444341887500296\"\n        }\n    ],\n    \"NextShardIterator\": \"AAAAAAAAAAFgVinmFZpF4IGMtKLEEzxkN+zIUDmjpf+j++pGcb92kMH+RgJ/D9IsV/IhG3dpgEhXZE7V9gdjG5zWABqLL/xr0eWIrtNIM5eGMOWB3Bx5ddrKNKcqFVa99PQD1cUXZehxIa7+2lHh3ZRS3bvXAiKg65SO533JOL/rHLcDCfI0HfVIJ2Wmcg/WwaNU13eaethTF3eHRx6Q6DQmO0aCJh06\"\n}\n\n\nawscli\u3067\u306fbase64\u306e\u30c7\u30b3\u30fc\u30c9\u306f\u63d0\u4f9b\u3055\u308c\u3066\u3044\u306a\u3044\nKPL,KCL\u3092\u4f7f\u7528\u3059\u308b\u306e\u304c\u524d\u63d0\u306b\u306a\u3063\u3066\u3044\u308b\u3068\u601d\u308f\u308c\u308b\u3002\nKPL\nKCL Ruby\n\n## \u521d\u6295\u7a3f\u3067\u3059\u304c\u3001\u305f\u3060\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u30e1\u30e2\u3067\u3059\n\u4eca\u56de\u306fAmazon Kinesis\u306b\u9001\u308b<br>\n\n- stream\u3092\u4f5c\u308b\n\n```\naws kinesis create-stream --stream-name stream --shard-count 2\n```\n- stream\u306e\u60c5\u5831\u53d6\u5f97\n\n```\naws kinesis describe-stream --stream-name stream\n{\n    \"StreamDescription\": {\n        \"StreamStatus\": \"ACTIVE\",\n        \"StreamName\": \"stream\",\n        \"StreamARN\": \"arn:aws:kinesis:ap-northeast-1:622601022736:stream/stream\",\n        \"Shards\": [\n            {\n                \"ShardId\": \"shardId-000000000000\",\n                \"HashKeyRange\": {\n                    \"EndingHashKey\": \"170141183460469231731687303715884105726\",\n                    \"StartingHashKey\": \"0\"\n                },\n                \"SequenceNumberRange\": {\n                    \"StartingSequenceNumber\": \"49562754734384102757616484984742799371518611138497478656\"\n                }\n            },\n            {\n                \"ShardId\": \"shardId-000000000001\",\n                \"HashKeyRange\": {\n                    \"EndingHashKey\": \"340282366920938463463374607431768211456\",\n                    \"StartingHashKey\": \"170141183460469231731687303715884105726\"\n                },\n                \"SequenceNumberRange\": {\n                    \"StartingSequenceNumber\": \"49562754734406403502815015607884335089791259500003459096\"\n                }\n            }\n        ]\n    }\n}\n```\nfluentd\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n```\ncurl -L https://toolbelt.treasuredata.com/sh/install-redhat-td-agent2.sh | sh\n...\nInstalled:\n  td-agent.x86_64 0:2.3.1-0.el6\n\nComplete!\n```\n- fluent-plugin-kinesis\u3092\u4f7f\u3046\n\n```\ntd-agent-gem install fluent-plugin-kinesis\nFetching: concurrent-ruby-1.0.2.gem (100%)\nSuccessfully installed concurrent-ruby-1.0.2\nFetching: os-0.9.6.gem (100%)\nSuccessfully installed os-0.9.6\nFetching: middleware-0.1.0.gem (100%)\nSuccessfully installed middleware-0.1.0\nFetching: protobuf-3.6.9.gem (100%)\nSuccessfully installed protobuf-3.6.9\nFetching: fluent-plugin-kinesis-1.0.1.gem (100%)\nSuccessfully installed fluent-plugin-kinesis-1.0.1\nParsing documentation for concurrent-ruby-1.0.2\nInstalling ri documentation for concurrent-ruby-1.0.2\nParsing documentation for os-0.9.6\nInstalling ri documentation for os-0.9.6\nParsing documentation for middleware-0.1.0\nInstalling ri documentation for middleware-0.1.0\nParsing documentation for protobuf-3.6.9\nInstalling ri documentation for protobuf-3.6.9\nParsing documentation for fluent-plugin-kinesis-1.0.1\nInstalling ri documentation for fluent-plugin-kinesis-1.0.1\nDone installing documentation for concurrent-ruby, os, middleware, protobuf, fluent-plugin-kinesis after 10 seconds\n5 gems installed\n```\n- fluentd\u306e\u8a2d\u5b9a\n\n```td-agent.conf\n<source>\n  type tail\n  format /^(?<month>[^ ]*) (?<day>[^ ]*) (?<times>[^ ]*) (?<proc>(.+))\\[(?<id>[^\\]]*)\\]: \\[(?<level>[^\\]]*)\\](?<content>(.+))$/\n  path /var/log/drive/activedrive-%Y%m%d.log\n  pos_file /var/log/td-agent/drive.kinesis.pos\n  tag drive.kinesis\n</source>\n\n<match drive.kinesis>\n  type kinesis\n  stream_name stream\n  region ap-northeast-1\n  random_partition_key true\n  use_yajl true\n  retry_limit 4\n  retry_wait 10s\n  flush_interval 1s\n  buffer_type file\n  buffer_path /var/log/td-agent/kinesis.*.buffer\n  buffer_chunk_limit 1024m\n  buffer_queue_limit 256\n</match>\n\n<filter drive.*>\n  type record_transformer\n  <record>\n    host \"#{Socket.gethostname}\"\n  </record>\n</filter>\n```\n- `include_tag_key true`\u3092\u8a2d\u5b9a\u3059\u308b\u3068\u51fa\u529b\u306btag\u3092\u8ffd\u52a0\u3067\u304d\u308b\n- \u6d41\u308c\u308b\u30ed\u30b0\u306f\u3053\u3093\u306a\u306e\n\n```\nJun 10 15:25:48 adfs[16132:36526832]: [DEV DEBUG]prop_server: quit()`\n```\n- \u51fa\u529b\u4f8b\n\n```\n{\"month\":\"Jun\",\"day\":\"10\",\"times\":\"15:25:48\",\"proc\":\"adfs\",\"id\":\"16132:36526832\",\"level\":\"DEV DEBUG\",\"content\":\"prop_server: quit()\",\"host\":\"hostname\"}\n```\n- \u30ec\u30b3\u30fc\u30c9\u306e\u53d6\u5f97<br>\n\u3068\u308a\u3042\u3048\u305aawscli\u3092\u4f7f\u3046\n\n```\naws kinesis get-records --shard-iterator $(aws kinesis get-shard-iterator --stream-name stream --shard-id shardId-000000000000 --shard-iterator-type TRIM_HORIZON|jq .ShardIterator)\n{\n    \"Records\": [\n        {\n            \"PartitionKey\": \"390a8dfb-646b-4013-b730-02c02e77ae66\",\n            \"Data\": \"eyJtb250aCI6Ikp1biIsImRheSI6IjEwIiwidGltZXMiOiIxNToyNTo0OCIsInByb2MiOiJhZGZzIiwiaWQiOiIxNjEzMjozNjUyNjgzMiIsImxldmVsIjoiREVWIERFQlVHIiwiY29udGVudCI6InByb3Bfc2VydmVyOiBxdWl0KCkiLCJob3N0IjoiaG9zdG5hbWUifQ==\",\n            \"SequenceNumber\": \"49562754734384102757616484985846548644830444341887500296\"\n        }\n    ],\n    \"NextShardIterator\": \"AAAAAAAAAAFgVinmFZpF4IGMtKLEEzxkN+zIUDmjpf+j++pGcb92kMH+RgJ/D9IsV/IhG3dpgEhXZE7V9gdjG5zWABqLL/xr0eWIrtNIM5eGMOWB3Bx5ddrKNKcqFVa99PQD1cUXZehxIa7+2lHh3ZRS3bvXAiKg65SO533JOL/rHLcDCfI0HfVIJ2Wmcg/WwaNU13eaethTF3eHRx6Q6DQmO0aCJh06\"\n}\n```\n- awscli\u3067\u306fbase64\u306e\u30c7\u30b3\u30fc\u30c9\u306f\u63d0\u4f9b\u3055\u308c\u3066\u3044\u306a\u3044\n- KPL,KCL\u3092\u4f7f\u7528\u3059\u308b\u306e\u304c\u524d\u63d0\u306b\u306a\u3063\u3066\u3044\u308b\u3068\u601d\u308f\u308c\u308b\u3002\n- [KPL](https://github.com/awslabs/amazon-kinesis-producer)\n- [KCL Ruby](https://github.com/awslabs/amazon-kinesis-client-ruby)\n", "tags": ["fluentd", "td-agent", "fluent-plugin-kinesis", "AmazonKinesisStream"]}