{"context": "\u4ee5\u524d\u3001Apps Script\u304b\u3089Slack\u306bKPI\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u9001\u3063\u3066\u3044\u305f\u306e\u3067\u3059\u304c\u3001\u5225\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u3067HipChat\u3067\u3067\u3082\u9001\u308a\u305f\u304f\u306a\u3063\u305f\u306e\u3067\u30e1\u30e2\u3092\u8a18\u8f09\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\n\u306f\u3058\u3081\u306b\n\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u9001\u308b\u306b\u306fToken\u304c\u5165\u308a\u307e\u3059\u3002API access Token\u306b\u306f\u5404\u7a2e\u3042\u308b\u306e\u3067\u3059\u304c\u3001\u4eca\u56de\u306fpersonal access token\u3092\u4f7f\u3044\u307e\u3059\u3002\u3053\u3053\u306e\u30ea\u30f3\u30af\u304b\u3089Create new token\u3067\u3001\u300cSend Message\u300d\u3068\u300cSend Notification\u300d\u306e\u30a2\u30af\u30bb\u30b9\u30c8\u30fc\u30af\u30f3\u3092\u4f5c\u308a\u307e\u3059\u3002\n\n\nSend Message API\n\n\u7c21\u6613\u7684\u306a\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u9001\u308b\u305f\u3081\u306eAPI\u3067\u3059\u3002\u6307\u5b9a\u3067\u304d\u308b\u306e\u306f\u30e1\u30c3\u30bb\u30fc\u30b8\u306e\u307f\u30671~1000\u6587\u5b57\u307e\u3067\u3067\u3059\u3002\n\u9001\u4fe1\u3059\u308b\u3068\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\n\nApps Script\u306e\u30b3\u30fc\u30c9\u306f\u4ee5\u4e0b\u3068\u306a\u308a\u307e\u3059\u3002Send Message\u306e\u307b\u3046\u306eToken\u3092\u4f7f\u3044\u307e\u3059\u3002\nfunction sendMessage() {\n  var room_id_or_name = \"bot_test\";\n  var params = {\n    \"contentType\" : \"application/json\",\n    \"method\": \"post\",\n    'payload' : JSON.stringify({\"message\": \"test\"})\n  };\n  var responseString = UrlFetchApp.fetch(getMessageRequestURL(room_id_or_name), params).getContentText();\n  Logger.log(responseString);\n}\n\nfunction getMessageRequestURL(room_id_or_name){\n  var authToken = \"xxx\";\n  var url = \"http://api.hipchat.com/v2/room/\" + room_id_or_name + \"/message\";\n  return url + '?auth_token=' + authToken;\n}\n\n\nSend Room Notification API\n\n\u30ea\u30c3\u30c1\u306a\u30d5\u30a9\u30fc\u30de\u30c3\u30c8\u306e\u30e1\u30c3\u30bb\u30fc\u30b8\u304c\u9001\u308c\u307e\u3059\u3002\u5404\u30e1\u30c3\u30bb\u30fc\u30b8\u306e\u30b5\u30f3\u30d7\u30eb\u306fSending Message\u306e\u30ea\u30f3\u30af\u306b\u3042\u308a\u307e\u3059\u3002\nmessage\u306f1-10000\u6587\u5b57\u307e\u3067\u3067\u3059\u3002Token\u306fNotification\u7528\u306e\u3092\u4f7f\u3044\u307e\u3059\u3002\n\nText\u306eNotification\n\u307e\u305a\u306fText\u3067\u9001\u3063\u3066\u307f\u307e\u3059\u3002\u30c7\u30d5\u30a9\u30eb\u30c8\u3067\u9ec4\u8272\u306ecolor\u304c\u3064\u3044\u3066\u3044\u307e\u3059\u3002\n\n\u30b3\u30fc\u30c9\u306f\u4ee5\u4e0b\u3067\u3059\u3002\n\nfunction sendNotification() {\n  var room_id_or_name = \"bot_test\";\n  var params = {\n    \"contentType\" : \"application/json\",\n    \"method\": \"post\",\n    'payload' : JSON.stringify({\"message\": \"test\"})\n  };\n  var responseString = UrlFetchApp.fetch(getNotificationUrl(room_id_or_name), params).getContentText();\n  Logger.log(responseString);\n}\n\nfunction getNotificationUrl(room_id_or_name) {\n  var authToken = \"xxx\";\n  var url = \"http://api.hipchat.com/v2/room/\" + room_id_or_name + \"/notification\";\n  return url + '?auth_token=' + authToken;\n}\n\n\nHTML\u306eNotification\nKPI\u3092\u9001\u308b\u4e8b\u3092\u60f3\u5b9a\u3057\u3066\u3001HTML\u306e\u30c6\u30fc\u30d6\u30eb\u3092\u4f7f\u3063\u3066\u9001\u3063\u3066\u307f\u307e\u3059\u3002\n\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u300c\u30ec\u30dd\u30fc\u30c8\u300d\u30b7\u30fc\u30c8\u304cGoogle\u30b9\u30d7\u30ec\u30c3\u30c9\u30b7\u30fc\u30c8\u306b\u3042\u308b\u3068\u3057\u307e\u3059\u3002\n\n\u7d50\u679c\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u308a\u307e\u3057\u305f\u3002Slack\u3067\u306f\u30c6\u30fc\u30d6\u30eb\u3067\u51fa\u305b\u306a\u3044\u306e\u3067\u3001HipChat\u306e\u307b\u3046\u304c\u3044\u3044\u611f\u3058\u306b\u3060\u305b\u307e\u3059\u3002\n\n\u4ee5\u4e0b\u306e\u30b3\u30fc\u30c9\u3067\u5b9f\u884c\u3067\u304d\u307e\u3059\u3002token\u3068ssID(\u30b9\u30d7\u30ec\u30c3\u30c9\u30b7\u30fc\u30c8\u306eID)\u306f\u9069\u5f53\u306a\u3082\u306e\u306b\u3057\u3066\u304f\u3060\u3055\u3044\u3002\nvar ssId = 'xxx';\n\nfunction sendNotification() {\n  var room_id_or_name = \"bot_test\";\n  var params = {\n    \"contentType\" : \"application/json\",\n    \"message_format\": \"html\",\n    \"method\": \"post\",\n    'payload' : JSON.stringify({\"message\": getHtmlTable()})\n  };\n  var responseString = UrlFetchApp.fetch(getNotificationUrl(room_id_or_name), params).getContentText();\n  Logger.log(responseString);\n}\n\nfunction getNotificationUrl(room_id_or_name) {\n  var authToken = \"yyy\";\n  var url = \"http://api.hipchat.com/v2/room/\" + room_id_or_name + \"/notification\";\n  return url + '?auth_token=' + authToken;\n}\n\nfunction getHtmlTable() {\n  var sheetName = '\u30ec\u30dd\u30fc\u30c8';\n  var sheet = SpreadsheetApp.openById(ssId).getSheetByName(sheetName);\n  var data = sheet.getSheetValues(1, 1, sheet.getMaxRows(), 3)\n  var kpi_date = sheet.getRange(1, 2).getValue();\n  var msg = \"KPI\u30ec\u30dd\u30fc\u30c8\";\n  msg += \"<table>\"\n\n  for (var i = 0; i < data.length; i++) {\n    var row_msg = \"\";\n    for (var j = 0; j < data[i].length; j++) {\n      var value = data[i][j];\n      if (value == '' && i != 0) continue;\n      if (Number(value) === value && value % 1 !== 0) {\n        value = (value * 100).toFixed(2) + \"%\"; \n      }\n      if (value instanceof Date) {\n        value = formatDate(value, \"MM\u6708DD\u65e5\");\n      }\n      if (j == 0 || j == 1 || j == 2) { // 2, 3\u5217\u76ee\n        if (typeof value === 'string') {\n          value = value.replace(/ /g, \"\u3000\");          \n        }\n        var output = HtmlService.createHtmlOutput();\n        output.appendUntrusted(value);\n        if (i == 0) {\n          row_msg += '<th>' + output.getContent() + \"</th>\";\n        } else {\n          row_msg += '<td>' + output.getContent() + \"</td>\";\n        }\n      }\n    }\n    msg += \"<tr>\" + row_msg + \"</tr>\";      \n  }\n\n  msg += \"</table>\"\n  msg = msg.replace(/<tr><\\/tr>/gi, \"\");\n  Logger.log(msg);\n  return msg;\n}\n\nfunction formatDate(date, format) {\n  if (!format) format = 'YYYY-MM-DD hh:mm:ss.SSS';\n  format = format.replace(/YYYY/g, date.getFullYear());\n  format = format.replace(/MM/g, ('0' + (date.getMonth() + 1)).slice(-2));\n  format = format.replace(/DD/g, ('0' + date.getDate()).slice(-2));\n  format = format.replace(/hh/g, ('0' + date.getHours()).slice(-2));\n  format = format.replace(/mm/g, ('0' + date.getMinutes()).slice(-2));\n  format = format.replace(/ss/g, ('0' + date.getSeconds()).slice(-2));\n  if (format.match(/S/g)) {\n    var milliSeconds = ('00' + date.getMilliseconds()).slice(-3);\n    var length = format.match(/S/g).length;\n    for (var i = 0; i < length; i++) format = format.replace(/S/, milliSeconds.substring(i, i + 1));\n  }\n  return format;\n};\n\n\u306a\u304a\u3001\u30e6\u30fc\u30b6\u3068\u3057\u3066\u3067\u306f\u306a\u304fRoom Notification Tokens\u3068\u3057\u3066Token\u3092\u53d6\u5f97\u3059\u308b\u5834\u5408\u306f\u3001\u30eb\u30fc\u30e0\u4e8b\u306b\u3001\u53d6\u5f97\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\u8a2d\u5b9a\u3067\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u3057\u3066\u53d6\u5f97\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n\n\u307e\u3068\u3081\nREST API\u3092\u3064\u304b\u3048\u3070\u3001Apps Script\u304b\u3089HipChat\u306bKPI\u30ec\u30dd\u30fc\u30c8\u3092\u9001\u308b\u4e8b\u304c\u3067\u304d\u307e\u3057\u305f\u3002\nKPI\u3092\u30c1\u30fc\u30e0\u306b\u5b9a\u671f\u7684\u306b\u5171\u6709\u3057\u3001\u3044\u3044\u611f\u3058\u306b\u30d7\u30ed\u30c0\u30af\u30c8\u6539\u5584\u3057\u3066\u3044\u304d\u307e\u3057\u3087\u3046\uff01\n\u4ee5\u524d\u3001Apps Script\u304b\u3089Slack\u306bKPI\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u9001\u3063\u3066\u3044\u305f\u306e\u3067\u3059\u304c\u3001\u5225\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u3067HipChat\u3067\u3067\u3082\u9001\u308a\u305f\u304f\u306a\u3063\u305f\u306e\u3067\u30e1\u30e2\u3092\u8a18\u8f09\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\n# \u306f\u3058\u3081\u306b\n\n\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u9001\u308b\u306b\u306fToken\u304c\u5165\u308a\u307e\u3059\u3002[API access Token\u306b\u306f\u5404\u7a2e\u3042\u308b](https://developer.atlassian.com/hipchat/guide/hipchat-rest-api)\u306e\u3067\u3059\u304c\u3001\u4eca\u56de\u306fpersonal access token\u3092\u4f7f\u3044\u307e\u3059\u3002[\u3053\u3053\u306e\u30ea\u30f3\u30af](https://www.hipchat.com/account/api)\u304b\u3089Create new token\u3067\u3001\u300cSend Message\u300d\u3068\u300cSend Notification\u300d\u306e\u30a2\u30af\u30bb\u30b9\u30c8\u30fc\u30af\u30f3\u3092\u4f5c\u308a\u307e\u3059\u3002\n\n![image](https://qiita-image-store.s3.amazonaws.com/0/30079/61549240-6c2a-7b4d-e64b-05a5d33eda72.png)\n\n# [Send Message API](https://www.hipchat.com/docs/apiv2/method/send_message)\n\n\u7c21\u6613\u7684\u306a\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u9001\u308b\u305f\u3081\u306eAPI\u3067\u3059\u3002\u6307\u5b9a\u3067\u304d\u308b\u306e\u306f\u30e1\u30c3\u30bb\u30fc\u30b8\u306e\u307f\u30671~1000\u6587\u5b57\u307e\u3067\u3067\u3059\u3002\n\u9001\u4fe1\u3059\u308b\u3068\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\n\n![image](https://qiita-image-store.s3.amazonaws.com/0/30079/d931b9e4-62da-b46b-cd1f-ce29f7bc491c.png)\n\nApps Script\u306e\u30b3\u30fc\u30c9\u306f\u4ee5\u4e0b\u3068\u306a\u308a\u307e\u3059\u3002```Send Message```\u306e\u307b\u3046\u306eToken\u3092\u4f7f\u3044\u307e\u3059\u3002\n\n```js\nfunction sendMessage() {\n  var room_id_or_name = \"bot_test\";\n  var params = {\n    \"contentType\" : \"application/json\",\n    \"method\": \"post\",\n    'payload' : JSON.stringify({\"message\": \"test\"})\n  };\n  var responseString = UrlFetchApp.fetch(getMessageRequestURL(room_id_or_name), params).getContentText();\n  Logger.log(responseString);\n}\n\nfunction getMessageRequestURL(room_id_or_name){\n  var authToken = \"xxx\";\n  var url = \"http://api.hipchat.com/v2/room/\" + room_id_or_name + \"/message\";\n  return url + '?auth_token=' + authToken;\n}\n```\n\n# [Send Room Notification API](https://www.hipchat.com/docs/apiv2/method/send_room_notification)\n\n\u30ea\u30c3\u30c1\u306a\u30d5\u30a9\u30fc\u30de\u30c3\u30c8\u306e\u30e1\u30c3\u30bb\u30fc\u30b8\u304c\u9001\u308c\u307e\u3059\u3002\u5404\u30e1\u30c3\u30bb\u30fc\u30b8\u306e\u30b5\u30f3\u30d7\u30eb\u306f[Sending Message](https://developer.atlassian.com/hipchat/guide/sending-messages)\u306e\u30ea\u30f3\u30af\u306b\u3042\u308a\u307e\u3059\u3002\n\nmessage\u306f1-10000\u6587\u5b57\u307e\u3067\u3067\u3059\u3002Token\u306fNotification\u7528\u306e\u3092\u4f7f\u3044\u307e\u3059\u3002\n\n## Text\u306eNotification\n\n\u307e\u305a\u306fText\u3067\u9001\u3063\u3066\u307f\u307e\u3059\u3002\u30c7\u30d5\u30a9\u30eb\u30c8\u3067\u9ec4\u8272\u306ecolor\u304c\u3064\u3044\u3066\u3044\u307e\u3059\u3002\n\n![image](https://qiita-image-store.s3.amazonaws.com/0/30079/631195cf-6556-8ba7-8b6b-e496c7d3bb4d.png)\n\n\u30b3\u30fc\u30c9\u306f\u4ee5\u4e0b\u3067\u3059\u3002\n\n```js\n\nfunction sendNotification() {\n  var room_id_or_name = \"bot_test\";\n  var params = {\n    \"contentType\" : \"application/json\",\n    \"method\": \"post\",\n    'payload' : JSON.stringify({\"message\": \"test\"})\n  };\n  var responseString = UrlFetchApp.fetch(getNotificationUrl(room_id_or_name), params).getContentText();\n  Logger.log(responseString);\n}\n\nfunction getNotificationUrl(room_id_or_name) {\n  var authToken = \"xxx\";\n  var url = \"http://api.hipchat.com/v2/room/\" + room_id_or_name + \"/notification\";\n  return url + '?auth_token=' + authToken;\n}\n```\n\n## HTML\u306eNotification\n\nKPI\u3092\u9001\u308b\u4e8b\u3092\u60f3\u5b9a\u3057\u3066\u3001HTML\u306e\u30c6\u30fc\u30d6\u30eb\u3092\u4f7f\u3063\u3066\u9001\u3063\u3066\u307f\u307e\u3059\u3002\n\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u300c\u30ec\u30dd\u30fc\u30c8\u300d\u30b7\u30fc\u30c8\u304cGoogle\u30b9\u30d7\u30ec\u30c3\u30c9\u30b7\u30fc\u30c8\u306b\u3042\u308b\u3068\u3057\u307e\u3059\u3002\n\n![image](https://qiita-image-store.s3.amazonaws.com/0/30079/3e43320f-d413-35f8-84af-304c91a1e98a.png)\n\n\u7d50\u679c\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u308a\u307e\u3057\u305f\u3002Slack\u3067\u306f\u30c6\u30fc\u30d6\u30eb\u3067\u51fa\u305b\u306a\u3044\u306e\u3067\u3001HipChat\u306e\u307b\u3046\u304c\u3044\u3044\u611f\u3058\u306b\u3060\u305b\u307e\u3059\u3002\n\n![image](https://qiita-image-store.s3.amazonaws.com/0/30079/cd19b875-796b-a533-8df7-bec832ba45ec.png)\n\n\u4ee5\u4e0b\u306e\u30b3\u30fc\u30c9\u3067\u5b9f\u884c\u3067\u304d\u307e\u3059\u3002token\u3068ssID(\u30b9\u30d7\u30ec\u30c3\u30c9\u30b7\u30fc\u30c8\u306eID)\u306f\u9069\u5f53\u306a\u3082\u306e\u306b\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n```js\nvar ssId = 'xxx';\n\nfunction sendNotification() {\n  var room_id_or_name = \"bot_test\";\n  var params = {\n    \"contentType\" : \"application/json\",\n    \"message_format\": \"html\",\n    \"method\": \"post\",\n    'payload' : JSON.stringify({\"message\": getHtmlTable()})\n  };\n  var responseString = UrlFetchApp.fetch(getNotificationUrl(room_id_or_name), params).getContentText();\n  Logger.log(responseString);\n}\n\nfunction getNotificationUrl(room_id_or_name) {\n  var authToken = \"yyy\";\n  var url = \"http://api.hipchat.com/v2/room/\" + room_id_or_name + \"/notification\";\n  return url + '?auth_token=' + authToken;\n}\n\nfunction getHtmlTable() {\n  var sheetName = '\u30ec\u30dd\u30fc\u30c8';\n  var sheet = SpreadsheetApp.openById(ssId).getSheetByName(sheetName);\n  var data = sheet.getSheetValues(1, 1, sheet.getMaxRows(), 3)\n  var kpi_date = sheet.getRange(1, 2).getValue();\n  var msg = \"KPI\u30ec\u30dd\u30fc\u30c8\";\n  msg += \"<table>\"\n  \n  for (var i = 0; i < data.length; i++) {\n    var row_msg = \"\";\n    for (var j = 0; j < data[i].length; j++) {\n      var value = data[i][j];\n      if (value == '' && i != 0) continue;\n      if (Number(value) === value && value % 1 !== 0) {\n        value = (value * 100).toFixed(2) + \"%\"; \n      }\n      if (value instanceof Date) {\n        value = formatDate(value, \"MM\u6708DD\u65e5\");\n      }\n      if (j == 0 || j == 1 || j == 2) { // 2, 3\u5217\u76ee\n        if (typeof value === 'string') {\n          value = value.replace(/ /g, \"\u3000\");          \n        }\n        var output = HtmlService.createHtmlOutput();\n        output.appendUntrusted(value);\n        if (i == 0) {\n          row_msg += '<th>' + output.getContent() + \"</th>\";\n        } else {\n          row_msg += '<td>' + output.getContent() + \"</td>\";\n        }\n      }\n    }\n    msg += \"<tr>\" + row_msg + \"</tr>\";      \n  }\n  \n  msg += \"</table>\"\n  msg = msg.replace(/<tr><\\/tr>/gi, \"\");\n  Logger.log(msg);\n  return msg;\n}\n\nfunction formatDate(date, format) {\n  if (!format) format = 'YYYY-MM-DD hh:mm:ss.SSS';\n  format = format.replace(/YYYY/g, date.getFullYear());\n  format = format.replace(/MM/g, ('0' + (date.getMonth() + 1)).slice(-2));\n  format = format.replace(/DD/g, ('0' + date.getDate()).slice(-2));\n  format = format.replace(/hh/g, ('0' + date.getHours()).slice(-2));\n  format = format.replace(/mm/g, ('0' + date.getMinutes()).slice(-2));\n  format = format.replace(/ss/g, ('0' + date.getSeconds()).slice(-2));\n  if (format.match(/S/g)) {\n    var milliSeconds = ('00' + date.getMilliseconds()).slice(-3);\n    var length = format.match(/S/g).length;\n    for (var i = 0; i < length; i++) format = format.replace(/S/, milliSeconds.substring(i, i + 1));\n  }\n  return format;\n};\n```\n\n\u306a\u304a\u3001\u30e6\u30fc\u30b6\u3068\u3057\u3066\u3067\u306f\u306a\u304fRoom Notification Tokens\u3068\u3057\u3066Token\u3092\u53d6\u5f97\u3059\u308b\u5834\u5408\u306f\u3001\u30eb\u30fc\u30e0\u4e8b\u306b\u3001\u53d6\u5f97\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\u8a2d\u5b9a\u3067\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u3057\u3066\u53d6\u5f97\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n![image](https://qiita-image-store.s3.amazonaws.com/0/30079/fe04b6ec-92d7-c66d-ba3c-5e685b66c159.png)\n\n# \u307e\u3068\u3081\n\nREST API\u3092\u3064\u304b\u3048\u3070\u3001Apps Script\u304b\u3089HipChat\u306bKPI\u30ec\u30dd\u30fc\u30c8\u3092\u9001\u308b\u4e8b\u304c\u3067\u304d\u307e\u3057\u305f\u3002\nKPI\u3092\u30c1\u30fc\u30e0\u306b\u5b9a\u671f\u7684\u306b\u5171\u6709\u3057\u3001\u3044\u3044\u611f\u3058\u306b\u30d7\u30ed\u30c0\u30af\u30c8\u6539\u5584\u3057\u3066\u3044\u304d\u307e\u3057\u3087\u3046\uff01\n\n\n\n\n", "tags": ["GoogleAppsScript", "hipchat", "JavaScript"]}