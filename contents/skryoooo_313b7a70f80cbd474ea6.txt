{"context": "\n\n\u80cc\u666f\n\u5f0a\u793e\u3067\u306f\u8907\u6570\u306e\u30b5\u30fc\u30d3\u30b9\u3067TreasureData\u3092\u5229\u7528\u3057\u3066\u304a\u308a\u3001\u30e6\u30fc\u30b6\u6570\u3082100\u4ee5\u4e0a\u3067\u30a8\u30f3\u30b8\u30cb\u30a2\u304b\u3089\u30c7\u30fc\u30bf\u30b5\u30a4\u30a8\u30f3\u30c6\u30a3\u30b9\u30c8\u3001\u30d3\u30b8\u30cd\u30b9\u30b5\u30a4\u30c9\u306e\u4eba\u9593\u3068\u3055\u307e\u3056\u307e\u3067\u3059\u3002\n\u30a2\u30c9\u30db\u30c3\u30af\u306a\u30af\u30a8\u30ea\u3092\u6295\u3052\u305f\u969b\u306b\u3001 TD_TIME_RANGE \u306e\u8a2d\u5b9a\u3092\u3057\u5fd8\u308c\u3066\u3001\u30ea\u30bd\u30fc\u30b9\u3092\u5927\u91cf\u306b\u98df\u3063\u3066\u3057\u307e\u3044\u3001\u4ed6\u306e\u30af\u30a8\u30ea\u306b\u5f71\u97ff\u3092\u4e0e\u3048\u3066\u3057\u307e\u3046\u306a\u3093\u3066\u3053\u3068\u304c\u3088\u304f\u3042\u308a\u307e\u3059\u3002\n\u3082\u3061\u308d\u3093\u3001priority\u3092\u4f7f\u3063\u3066\u904b\u7528\u3059\u308b\u3088\u3046\u306b\u3057\u3066\u3044\u307e\u3059\u304c\u3001\u5b9f\u969b\u306e\u30b5\u30fc\u30d3\u30b9\u3067\u5229\u7528\u3057\u3066\u3044\u308b\u30af\u30a8\u30ea\u306b\u5f71\u97ff\u3059\u308b\u3053\u3068\u3082\u3042\u308a\u307e\u3059\u3002\n\u305d\u3053\u3067\u3001\u4e00\u5b9a\u4ee5\u4e0a\u306e\u6642\u9593\u52d5\u3044\u3066\u3044\u308b\u30af\u30a8\u30ea\u3092API\u7d4c\u7531\u3067\u53d6\u5f97\u3057\u3001\u305d\u308c\u3092Slack\u306b\u901a\u77e5\u3059\u308bGoogleAppsScript\u3092\u66f8\u304d\u307e\u3057\u305f\u3002\n\u3057\u304d\u3044\u5024\u4ee5\u4e0a\u306e\u30af\u30a8\u30ea\u3067\u3082\u3001\u5358\u306bS3\u306a\u3069\u3078\u306e\u5916\u90e8\u306e\u66f8\u304d\u51fa\u3057\u306b\u6642\u9593\u304c\u304b\u304b\u3063\u3066\u3044\u308b\u3053\u3068\u3082\u3042\u308b\u306e\u3067\u3001\u30ea\u30bd\u30fc\u30b9\u72b6\u6cc1\uff08Mapper,Reducer\u306e\u6570\uff09\u3082\u4e00\u7dd2\u306b\u901a\u77e5\u3057\u3066\u307f\u307e\u3057\u305f\u3002\n\nGoogle Apps Script\n\u3042\u307e\u308a\u304d\u308c\u3044\u306a\u3082\u306e\u3067\u306f\u306a\u3044\u3067\u3059\u304c\u3001\u52d5\u3044\u3066\u3044\u308b\u306e\u3067\u304a\u8a31\u3057\u4e0b\u3055\u3044\u3002\n\u4eca\u56de\u306fHive\u30af\u30a8\u30ea\u3060\u3051\u3092\u5bfe\u8c61\u306b\u3057\u3066\u3044\u307e\u3059\u3002\n\nvar THRESHOLD = 1800; // \u3057\u304d\u3044\u502430\u5206\u4ee5\u4e0a\nvar TDAPIKEY  = '(TreasureData APIKEY)';\nvar WEBHOOKURL = 'https://(Slack Webhook URL)';\n\n\nfunction postSlack(message) {\n  var payload = {\n    \"text\" : message,\n    \"username\" : \"The Machine\", // \"Person of Interest\"\u304c\u597d\u304d\u306a\u306e\u3067\n    \"channel\" : \"#treasuredata_alert\"\n  };\n  var params = {\n    \"method\" : \"POST\",\n    \"payload\" : JSON.stringify(payload)\n  };\n  var response = UrlFetchApp.fetch(WEBHOOKURL, params);\n}\n\nfunction tdJobList() {\n  var options = {\n    \"method\": \"GET\",\n    \"contentType\" : \"application/json\",\n    \"headers\" : {\n      \"AUTHORIZATION\" : \"TD1 \" + TDAPIKEY\n    }\n  };\n  var response = UrlFetchApp.fetch('https://api.treasuredata.com/v3/job/list?status=running&from=0&to=99', options);\n  return JSON.parse(response);\n}\n\nfunction tdJobDetail(jobid) {\n  var options = {\n    \"method\": \"GET\",\n    \"contentType\" : \"application/json\",\n    \"headers\" : {\n      \"AUTHORIZATION\" : \"TD1 \" + TDAPIKEY\n    }\n  };\n  var response = UrlFetchApp.fetch('https://api.treasuredata.com/v3/job/show/' + jobid, options);\n  return JSON.parse(response);\n}\n\nfunction getCpuUsage(jobid) {\n  var job = tdJobDetail(jobid);\n  var logs = job.debug.stderr.split('\\n');\n  var cpuUsage = [];\n  logs.forEach(function(line) {\n    if(line.match(/^Hadoop job information for /)) {\n      cpuUsage.push(line)\n    }\n  });\n  return cpuUsage;\n}\n\nfunction createAlertMsg(userName, url, database, query, cpuUsage) {\n  var msg =  THRESHOLD / 60 + '\u5206\u4ee5\u4e0a\u5b9f\u884c\u3055\u308c\u3066\u3044\u308b\u30af\u30a8\u30ea\u304c\u3042\u308a\u307e\u3059\uff01 :dizzy_face: \\n';\n  msg += 'User: ' + userName + '\\n';\n  msg += 'Database: ' + database + '\\n';\n  msg += 'Query: ' + query.split('\\n')[0] + ' .....\\n';\n  msg += '<' + url + '>\\n';\n  msg += 'Resource Usage:\\n';\n  msg += '```\\n' + cpuUsage.join('\\n') + '\\n```\\n';\n\n  return msg;\n}\n\nfunction parseDate(str) {\n  return new Date(str.replace(/-/g, \"/\").replace(\"UTC\", \"+00:00\"));\n}\n\nfunction checkTdJobs() {\n  var now = new Date();\n  var response = tdJobList();\n  var jobs = response.jobs\n  jobs.forEach(function(job) {\n    if (job.type !== 'hive') return;\n    var startAt = parseDate(job.start_at);\n    var duration = (now - startAt) / 1000;\n    if (duration > THRESHOLD) {\n      var cpuUsage = getCpuUsage(job.job_id);\n      postSlack(createAlertMsg(job.user_name, job.url, job.database, job.query, cpuUsage));\n    }\n  })\n}\n\n\n\u901a\u77e5\u7d50\u679c\n\u3053\u3093\u306a\u611f\u3058\u3067\u901a\u77e5\u3055\u308c\u307e\u3059\u3002\n\n# \u80cc\u666f\n\n\u5f0a\u793e\u3067\u306f\u8907\u6570\u306e\u30b5\u30fc\u30d3\u30b9\u3067TreasureData\u3092\u5229\u7528\u3057\u3066\u304a\u308a\u3001\u30e6\u30fc\u30b6\u6570\u3082100\u4ee5\u4e0a\u3067\u30a8\u30f3\u30b8\u30cb\u30a2\u304b\u3089\u30c7\u30fc\u30bf\u30b5\u30a4\u30a8\u30f3\u30c6\u30a3\u30b9\u30c8\u3001\u30d3\u30b8\u30cd\u30b9\u30b5\u30a4\u30c9\u306e\u4eba\u9593\u3068\u3055\u307e\u3056\u307e\u3067\u3059\u3002\n\n\u30a2\u30c9\u30db\u30c3\u30af\u306a\u30af\u30a8\u30ea\u3092\u6295\u3052\u305f\u969b\u306b\u3001 `TD_TIME_RANGE` \u306e\u8a2d\u5b9a\u3092\u3057\u5fd8\u308c\u3066\u3001\u30ea\u30bd\u30fc\u30b9\u3092\u5927\u91cf\u306b\u98df\u3063\u3066\u3057\u307e\u3044\u3001\u4ed6\u306e\u30af\u30a8\u30ea\u306b\u5f71\u97ff\u3092\u4e0e\u3048\u3066\u3057\u307e\u3046\u306a\u3093\u3066\u3053\u3068\u304c\u3088\u304f\u3042\u308a\u307e\u3059\u3002\n\u3082\u3061\u308d\u3093\u3001priority\u3092\u4f7f\u3063\u3066\u904b\u7528\u3059\u308b\u3088\u3046\u306b\u3057\u3066\u3044\u307e\u3059\u304c\u3001\u5b9f\u969b\u306e\u30b5\u30fc\u30d3\u30b9\u3067\u5229\u7528\u3057\u3066\u3044\u308b\u30af\u30a8\u30ea\u306b\u5f71\u97ff\u3059\u308b\u3053\u3068\u3082\u3042\u308a\u307e\u3059\u3002\n\n\u305d\u3053\u3067\u3001\u4e00\u5b9a\u4ee5\u4e0a\u306e\u6642\u9593\u52d5\u3044\u3066\u3044\u308b\u30af\u30a8\u30ea\u3092API\u7d4c\u7531\u3067\u53d6\u5f97\u3057\u3001\u305d\u308c\u3092Slack\u306b\u901a\u77e5\u3059\u308bGoogleAppsScript\u3092\u66f8\u304d\u307e\u3057\u305f\u3002\n\u3057\u304d\u3044\u5024\u4ee5\u4e0a\u306e\u30af\u30a8\u30ea\u3067\u3082\u3001\u5358\u306bS3\u306a\u3069\u3078\u306e\u5916\u90e8\u306e\u66f8\u304d\u51fa\u3057\u306b\u6642\u9593\u304c\u304b\u304b\u3063\u3066\u3044\u308b\u3053\u3068\u3082\u3042\u308b\u306e\u3067\u3001\u30ea\u30bd\u30fc\u30b9\u72b6\u6cc1\uff08Mapper,Reducer\u306e\u6570\uff09\u3082\u4e00\u7dd2\u306b\u901a\u77e5\u3057\u3066\u307f\u307e\u3057\u305f\u3002\n\n# Google Apps Script\n\n\u3042\u307e\u308a\u304d\u308c\u3044\u306a\u3082\u306e\u3067\u306f\u306a\u3044\u3067\u3059\u304c\u3001\u52d5\u3044\u3066\u3044\u308b\u306e\u3067\u304a\u8a31\u3057\u4e0b\u3055\u3044\u3002\n\u4eca\u56de\u306fHive\u30af\u30a8\u30ea\u3060\u3051\u3092\u5bfe\u8c61\u306b\u3057\u3066\u3044\u307e\u3059\u3002\n\n```js\n\nvar THRESHOLD = 1800; // \u3057\u304d\u3044\u502430\u5206\u4ee5\u4e0a\nvar TDAPIKEY  = '(TreasureData APIKEY)';\nvar WEBHOOKURL = 'https://(Slack Webhook URL)';\n\n\nfunction postSlack(message) {\n  var payload = {\n    \"text\" : message,\n    \"username\" : \"The Machine\", // \"Person of Interest\"\u304c\u597d\u304d\u306a\u306e\u3067\n    \"channel\" : \"#treasuredata_alert\"\n  };\n  var params = {\n    \"method\" : \"POST\",\n    \"payload\" : JSON.stringify(payload)\n  };\n  var response = UrlFetchApp.fetch(WEBHOOKURL, params);\n}\n\nfunction tdJobList() {\n  var options = {\n    \"method\": \"GET\",\n    \"contentType\" : \"application/json\",\n    \"headers\" : {\n      \"AUTHORIZATION\" : \"TD1 \" + TDAPIKEY\n    }\n  };\n  var response = UrlFetchApp.fetch('https://api.treasuredata.com/v3/job/list?status=running&from=0&to=99', options);\n  return JSON.parse(response);\n}\n\nfunction tdJobDetail(jobid) {\n  var options = {\n    \"method\": \"GET\",\n    \"contentType\" : \"application/json\",\n    \"headers\" : {\n      \"AUTHORIZATION\" : \"TD1 \" + TDAPIKEY\n    }\n  };\n  var response = UrlFetchApp.fetch('https://api.treasuredata.com/v3/job/show/' + jobid, options);\n  return JSON.parse(response);\n}\n\nfunction getCpuUsage(jobid) {\n  var job = tdJobDetail(jobid);\n  var logs = job.debug.stderr.split('\\n');\n  var cpuUsage = [];\n  logs.forEach(function(line) {\n    if(line.match(/^Hadoop job information for /)) {\n      cpuUsage.push(line)\n    }\n  });\n  return cpuUsage;\n}\n\nfunction createAlertMsg(userName, url, database, query, cpuUsage) {\n  var msg =  THRESHOLD / 60 + '\u5206\u4ee5\u4e0a\u5b9f\u884c\u3055\u308c\u3066\u3044\u308b\u30af\u30a8\u30ea\u304c\u3042\u308a\u307e\u3059\uff01 :dizzy_face: \\n';\n  msg += 'User: ' + userName + '\\n';\n  msg += 'Database: ' + database + '\\n';\n  msg += 'Query: ' + query.split('\\n')[0] + ' .....\\n';\n  msg += '<' + url + '>\\n';\n  msg += 'Resource Usage:\\n';\n  msg += '```\\n' + cpuUsage.join('\\n') + '\\n```\\n';\n  \n  return msg;\n}\n\nfunction parseDate(str) {\n  return new Date(str.replace(/-/g, \"/\").replace(\"UTC\", \"+00:00\"));\n}\n\nfunction checkTdJobs() {\n  var now = new Date();\n  var response = tdJobList();\n  var jobs = response.jobs\n  jobs.forEach(function(job) {\n    if (job.type !== 'hive') return;\n    var startAt = parseDate(job.start_at);\n    var duration = (now - startAt) / 1000;\n    if (duration > THRESHOLD) {\n      var cpuUsage = getCpuUsage(job.job_id);\n      postSlack(createAlertMsg(job.user_name, job.url, job.database, job.query, cpuUsage));\n    }\n  })\n}\n```\n\n# \u901a\u77e5\u7d50\u679c\n\n\u3053\u3093\u306a\u611f\u3058\u3067\u901a\u77e5\u3055\u308c\u307e\u3059\u3002\n\n![image](https://qiita-image-store.s3.amazonaws.com/0/48307/fa956fac-1ea9-464b-01e4-3872e3618d8e.png)\n\n\n", "tags": ["GoogleAppsScript", "TreasureData", "Slack"]}