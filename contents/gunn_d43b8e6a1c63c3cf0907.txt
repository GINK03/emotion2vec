{"tags": ["AVX", "SIMD"], "context": " More than 1 year has passed since last update.\n\nSIMD(AVX)\u3067\u5de8\u5927\u306a\u884c\u5217\u3092\u8ee2\u7f6e\u3059\u308b\u3002\n4*4\u306e\u8ee2\u7f6e\u306f\u3053\u3061\u3089\u306e\u8a18\u4e8b\u3092\u3042\u308a\u304c\u305f\u304f\u5229\u7528\u3059\u308b\u3002\n10000*10000\u306e\u884c\u5217\u3092\u8ee2\u7f6e\u3059\u308b\u3088\u3046\u306a\u30b1\u30fc\u30b9\u30024*4\u306e\u30d6\u30ed\u30c3\u30af\u5358\u4f4d\u3067\u8ee2\u7f6e\u3057\u3066\u3044\u304f\u3002\n\u5bfe\u89d2\u4e0a\u306e\u30d6\u30ed\u30c3\u30af\u306f\u3001\u305d\u306e\u307e\u307e\u8ee2\u7f6e\u3002\u5bfe\u89d2\u7dda\u306b\u5bfe\u3057\u3066\u5bfe\u79f0\u306a\u4f4d\u7f6e\u306b\u3042\u308b\u30d6\u30ed\u30c3\u30af\u3069\u3046\u3057\u3092\u8ee2\u7f6e\u3057\u3066\u4ea4\u63db\u3059\u308b\u3002\n\ntrans.c\n+---+---+---+    +---+---+---+\n| A | B | C |    | At| Dt| Gt|\n+---+---+---+    +---+---+---+\n| D | E | F | => | Bt| Et| Ht|\n+---+---+---+    +---+---+---+\n| G | H | I |    | Ct| Ft| It|\n+---+---+---+    +---+---+---+\n/*\n1\u3064\u306e\u30d6\u30ed\u30c3\u30af\u306f4*4\u3002\nAEI\u306f\u305f\u3060\u8ee2\u7f6e\u3002B\u3068D\u3001C\u3068G\u3001F\u3068H\u306f\u8ee2\u7f6e\u3057\u3066\u4ea4\u63db\u3059\u308b\u3002\n*/\nvoid  transpose_pd(double **mat, int row, int col)\n{\n  // row\u306f4\u306e\u500d\u6570\u3001row==col\u3092\u524d\u63d0\u3068\u3059\u308b\u3002\n  int i,j;\n  for (i=0; i<row; i+=4) {\n    j=i;\n    __m256d ymm_mat0 = _mm256_loadu_pd(&mat[i+0][j]); // |03|02|01|00|\n    __m256d ymm_mat1 = _mm256_loadu_pd(&mat[i+1][j]); // |13|12|11|10|\n    __m256d ymm_mat2 = _mm256_loadu_pd(&mat[i+2][j]); // |23|22|21|20|\n    __m256d ymm_mat3 = _mm256_loadu_pd(&mat[i+3][j]); // |33|32|31|30|\n\n    __m256d ymm_mat01_lo = _mm256_unpacklo_pd(ymm_mat0, ymm_mat1); // |12|02|10|00|\n    __m256d ymm_mat01_hi = _mm256_unpackhi_pd(ymm_mat0, ymm_mat1); // |13|03|11|01|\n    __m256d ymm_mat23_lo = _mm256_unpacklo_pd(ymm_mat2, ymm_mat3); // |32|22|30|20|\n    __m256d ymm_mat23_hi = _mm256_unpackhi_pd(ymm_mat2, ymm_mat3); // |33|23|31|21|\n    __m256d ymm_swap0 = _mm256_permute2f128_pd(ymm_mat01_lo, ymm_mat23_lo, 0b00100000); // |30|20|10|00|\n    __m256d ymm_swap1 = _mm256_permute2f128_pd(ymm_mat01_hi, ymm_mat23_hi, 0b00100000); // |31|21|11|01|\n    __m256d ymm_swap2 = _mm256_permute2f128_pd(ymm_mat01_lo, ymm_mat23_lo, 0b00110001); // |32|22|12|02|\n    __m256d ymm_swap3 = _mm256_permute2f128_pd(ymm_mat01_hi, ymm_mat23_hi, 0b00110001); // |33|23|13|03|\n\n    _mm256_storeu_pd(&mat[i+0][j], ymm_swap0);\n    _mm256_storeu_pd(&mat[i+1][j], ymm_swap1);\n    _mm256_storeu_pd(&mat[i+2][j], ymm_swap2);\n    _mm256_storeu_pd(&mat[i+3][j], ymm_swap3);\n    for (j=i+4; j<col; j+=4) {\n      __m256d ymm_matA0 = _mm256_loadu_pd(&mat[i+0][j]); // |03|02|01|00|\n      __m256d ymm_matA1 = _mm256_loadu_pd(&mat[i+1][j]); // |13|12|11|10|\n      __m256d ymm_matA2 = _mm256_loadu_pd(&mat[i+2][j]); // |23|22|21|20|\n      __m256d ymm_matA3 = _mm256_loadu_pd(&mat[i+3][j]); // |33|32|31|30|\n      __m256d ymm_matA01_lo = _mm256_unpacklo_pd(ymm_matA0, ymm_matA1); // |12|02|10|00|\n      __m256d ymm_matA01_hi = _mm256_unpackhi_pd(ymm_matA0, ymm_matA1); // |13|03|11|01|\n      __m256d ymm_matA23_lo = _mm256_unpacklo_pd(ymm_matA2, ymm_matA3); // |32|22|30|20|\n      __m256d ymm_matA23_hi = _mm256_unpackhi_pd(ymm_matA2, ymm_matA3); // |33|23|31|21|\n      __m256d ymm_swapA0 = _mm256_permute2f128_pd(ymm_matA01_lo, ymm_matA23_lo, 0b00100000); // |30|20|10|00|\n      __m256d ymm_swapA1 = _mm256_permute2f128_pd(ymm_matA01_hi, ymm_matA23_hi, 0b00100000); // |31|21|11|01|\n      __m256d ymm_swapA2 = _mm256_permute2f128_pd(ymm_matA01_lo, ymm_matA23_lo, 0b00110001); // |32|22|12|02|\n      __m256d ymm_swapA3 = _mm256_permute2f128_pd(ymm_matA01_hi, ymm_matA23_hi, 0b00110001); // |33|23|13|03|\n\n      __m256d ymm_matB0 = _mm256_loadu_pd(&mat[j+0][i]);\n      __m256d ymm_matB1 = _mm256_loadu_pd(&mat[j+1][i]);\n      __m256d ymm_matB2 = _mm256_loadu_pd(&mat[j+2][i]);\n      __m256d ymm_matB3 = _mm256_loadu_pd(&mat[j+3][i]);\n      __m256d ymm_matB01_lo = _mm256_unpacklo_pd(ymm_matB0, ymm_matB1);\n      __m256d ymm_matB01_hi = _mm256_unpackhi_pd(ymm_matB0, ymm_matB1);\n      __m256d ymm_matB23_lo = _mm256_unpacklo_pd(ymm_matB2, ymm_matB3);\n      __m256d ymm_matB23_hi = _mm256_unpackhi_pd(ymm_matB2, ymm_matB3);\n      __m256d ymm_swapB0 = _mm256_permute2f128_pd(ymm_matB01_lo, ymm_matB23_lo, 0b00100000);\n      __m256d ymm_swapB1 = _mm256_permute2f128_pd(ymm_matB01_hi, ymm_matB23_hi, 0b00100000);\n      __m256d ymm_swapB2 = _mm256_permute2f128_pd(ymm_matB01_lo, ymm_matB23_lo, 0b00110001);\n      __m256d ymm_swapB3 = _mm256_permute2f128_pd(ymm_matB01_hi, ymm_matB23_hi, 0b00110001);\n\n      _mm256_storeu_pd(&mat[j+0][i], ymm_swapA0);\n      _mm256_storeu_pd(&mat[j+1][i], ymm_swapA1);\n      _mm256_storeu_pd(&mat[j+2][i], ymm_swapA2);\n      _mm256_storeu_pd(&mat[j+3][i], ymm_swapA3);\n      _mm256_storeu_pd(&mat[i+0][j], ymm_swapB0);\n      _mm256_storeu_pd(&mat[i+1][j], ymm_swapB1);\n      _mm256_storeu_pd(&mat[i+2][j], ymm_swapB2);\n      _mm256_storeu_pd(&mat[i+3][j], ymm_swapB3);\n    }\n  }\n  return;\n}\n\n\n\nC\u3067\u66f8\u3044\u305f\u306e\u3068\u6bd4\u3079\u308b\n\u3042\u3093\u307e\u308a\u901f\u304f\u306a\u3044\u306a\u30021.5\u500d\u5f31\u306e\u9ad8\u901f\u5316\u3002\n\ntrans.c\nvoid transpose(double **mat, int row, int col)\n{\n  int i,j;\n  for (i=0; i<row; i++) {\n    for (j=i+1; j<col; j++) {\n      double swap = mat[i][j];\n      mat[i][j] = mat[j][i];\n      mat[j][i] = swap;\n    }\n  }\n  return;\n}\n\n\n#SIMD(AVX)\u3067\u5de8\u5927\u306a\u884c\u5217\u3092\u8ee2\u7f6e\u3059\u308b\u3002\n4*4\u306e\u8ee2\u7f6e\u306f[\u3053\u3061\u3089\u306e\u8a18\u4e8b](http://qiita.com/nbjiao/items/db1a5ff2c0afafb5717a)\u3092\u3042\u308a\u304c\u305f\u304f\u5229\u7528\u3059\u308b\u3002\n10000*10000\u306e\u884c\u5217\u3092\u8ee2\u7f6e\u3059\u308b\u3088\u3046\u306a\u30b1\u30fc\u30b9\u30024*4\u306e\u30d6\u30ed\u30c3\u30af\u5358\u4f4d\u3067\u8ee2\u7f6e\u3057\u3066\u3044\u304f\u3002\n\u5bfe\u89d2\u4e0a\u306e\u30d6\u30ed\u30c3\u30af\u306f\u3001\u305d\u306e\u307e\u307e\u8ee2\u7f6e\u3002\u5bfe\u89d2\u7dda\u306b\u5bfe\u3057\u3066\u5bfe\u79f0\u306a\u4f4d\u7f6e\u306b\u3042\u308b\u30d6\u30ed\u30c3\u30af\u3069\u3046\u3057\u3092\u8ee2\u7f6e\u3057\u3066\u4ea4\u63db\u3059\u308b\u3002\n\n```c:trans.c\n+---+---+---+    +---+---+---+\n| A | B | C |    | At| Dt| Gt|\n+---+---+---+    +---+---+---+\n| D | E | F | => | Bt| Et| Ht|\n+---+---+---+    +---+---+---+\n| G | H | I |    | Ct| Ft| It|\n+---+---+---+    +---+---+---+\n/*\n1\u3064\u306e\u30d6\u30ed\u30c3\u30af\u306f4*4\u3002\nAEI\u306f\u305f\u3060\u8ee2\u7f6e\u3002B\u3068D\u3001C\u3068G\u3001F\u3068H\u306f\u8ee2\u7f6e\u3057\u3066\u4ea4\u63db\u3059\u308b\u3002\n*/\nvoid  transpose_pd(double **mat, int row, int col)\n{\n  // row\u306f4\u306e\u500d\u6570\u3001row==col\u3092\u524d\u63d0\u3068\u3059\u308b\u3002\n  int i,j;\n  for (i=0; i<row; i+=4) {\n    j=i;\n    __m256d ymm_mat0 = _mm256_loadu_pd(&mat[i+0][j]); // |03|02|01|00|\n    __m256d ymm_mat1 = _mm256_loadu_pd(&mat[i+1][j]); // |13|12|11|10|\n    __m256d ymm_mat2 = _mm256_loadu_pd(&mat[i+2][j]); // |23|22|21|20|\n    __m256d ymm_mat3 = _mm256_loadu_pd(&mat[i+3][j]); // |33|32|31|30|\n\n    __m256d ymm_mat01_lo = _mm256_unpacklo_pd(ymm_mat0, ymm_mat1); // |12|02|10|00|\n    __m256d ymm_mat01_hi = _mm256_unpackhi_pd(ymm_mat0, ymm_mat1); // |13|03|11|01|\n    __m256d ymm_mat23_lo = _mm256_unpacklo_pd(ymm_mat2, ymm_mat3); // |32|22|30|20|\n    __m256d ymm_mat23_hi = _mm256_unpackhi_pd(ymm_mat2, ymm_mat3); // |33|23|31|21|\n    __m256d ymm_swap0 = _mm256_permute2f128_pd(ymm_mat01_lo, ymm_mat23_lo, 0b00100000); // |30|20|10|00|\n    __m256d ymm_swap1 = _mm256_permute2f128_pd(ymm_mat01_hi, ymm_mat23_hi, 0b00100000); // |31|21|11|01|\n    __m256d ymm_swap2 = _mm256_permute2f128_pd(ymm_mat01_lo, ymm_mat23_lo, 0b00110001); // |32|22|12|02|\n    __m256d ymm_swap3 = _mm256_permute2f128_pd(ymm_mat01_hi, ymm_mat23_hi, 0b00110001); // |33|23|13|03|\n\n    _mm256_storeu_pd(&mat[i+0][j], ymm_swap0);\n    _mm256_storeu_pd(&mat[i+1][j], ymm_swap1);\n    _mm256_storeu_pd(&mat[i+2][j], ymm_swap2);\n    _mm256_storeu_pd(&mat[i+3][j], ymm_swap3);\n    for (j=i+4; j<col; j+=4) {\n      __m256d ymm_matA0 = _mm256_loadu_pd(&mat[i+0][j]); // |03|02|01|00|\n      __m256d ymm_matA1 = _mm256_loadu_pd(&mat[i+1][j]); // |13|12|11|10|\n      __m256d ymm_matA2 = _mm256_loadu_pd(&mat[i+2][j]); // |23|22|21|20|\n      __m256d ymm_matA3 = _mm256_loadu_pd(&mat[i+3][j]); // |33|32|31|30|\n      __m256d ymm_matA01_lo = _mm256_unpacklo_pd(ymm_matA0, ymm_matA1); // |12|02|10|00|\n      __m256d ymm_matA01_hi = _mm256_unpackhi_pd(ymm_matA0, ymm_matA1); // |13|03|11|01|\n      __m256d ymm_matA23_lo = _mm256_unpacklo_pd(ymm_matA2, ymm_matA3); // |32|22|30|20|\n      __m256d ymm_matA23_hi = _mm256_unpackhi_pd(ymm_matA2, ymm_matA3); // |33|23|31|21|\n      __m256d ymm_swapA0 = _mm256_permute2f128_pd(ymm_matA01_lo, ymm_matA23_lo, 0b00100000); // |30|20|10|00|\n      __m256d ymm_swapA1 = _mm256_permute2f128_pd(ymm_matA01_hi, ymm_matA23_hi, 0b00100000); // |31|21|11|01|\n      __m256d ymm_swapA2 = _mm256_permute2f128_pd(ymm_matA01_lo, ymm_matA23_lo, 0b00110001); // |32|22|12|02|\n      __m256d ymm_swapA3 = _mm256_permute2f128_pd(ymm_matA01_hi, ymm_matA23_hi, 0b00110001); // |33|23|13|03|\n\n      __m256d ymm_matB0 = _mm256_loadu_pd(&mat[j+0][i]);\n      __m256d ymm_matB1 = _mm256_loadu_pd(&mat[j+1][i]);\n      __m256d ymm_matB2 = _mm256_loadu_pd(&mat[j+2][i]);\n      __m256d ymm_matB3 = _mm256_loadu_pd(&mat[j+3][i]);\n      __m256d ymm_matB01_lo = _mm256_unpacklo_pd(ymm_matB0, ymm_matB1);\n      __m256d ymm_matB01_hi = _mm256_unpackhi_pd(ymm_matB0, ymm_matB1);\n      __m256d ymm_matB23_lo = _mm256_unpacklo_pd(ymm_matB2, ymm_matB3);\n      __m256d ymm_matB23_hi = _mm256_unpackhi_pd(ymm_matB2, ymm_matB3);\n      __m256d ymm_swapB0 = _mm256_permute2f128_pd(ymm_matB01_lo, ymm_matB23_lo, 0b00100000);\n      __m256d ymm_swapB1 = _mm256_permute2f128_pd(ymm_matB01_hi, ymm_matB23_hi, 0b00100000);\n      __m256d ymm_swapB2 = _mm256_permute2f128_pd(ymm_matB01_lo, ymm_matB23_lo, 0b00110001);\n      __m256d ymm_swapB3 = _mm256_permute2f128_pd(ymm_matB01_hi, ymm_matB23_hi, 0b00110001);\n\n      _mm256_storeu_pd(&mat[j+0][i], ymm_swapA0);\n      _mm256_storeu_pd(&mat[j+1][i], ymm_swapA1);\n      _mm256_storeu_pd(&mat[j+2][i], ymm_swapA2);\n      _mm256_storeu_pd(&mat[j+3][i], ymm_swapA3);\n      _mm256_storeu_pd(&mat[i+0][j], ymm_swapB0);\n      _mm256_storeu_pd(&mat[i+1][j], ymm_swapB1);\n      _mm256_storeu_pd(&mat[i+2][j], ymm_swapB2);\n      _mm256_storeu_pd(&mat[i+3][j], ymm_swapB3);\n    }\n  }\n  return;\n}\n```\n\n##C\u3067\u66f8\u3044\u305f\u306e\u3068\u6bd4\u3079\u308b\n\u3042\u3093\u307e\u308a\u901f\u304f\u306a\u3044\u306a\u30021.5\u500d\u5f31\u306e\u9ad8\u901f\u5316\u3002\n\n```c:trans.c\nvoid transpose(double **mat, int row, int col)\n{\n  int i,j;\n  for (i=0; i<row; i++) {\n    for (j=i+1; j<col; j++) {\n      double swap = mat[i][j];\n      mat[i][j] = mat[j][i];\n      mat[j][i] = swap;\n    }\n  }\n  return;\n}\n```\n"}