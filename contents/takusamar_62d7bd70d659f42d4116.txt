{"context": " More than 1 year has passed since last update.\n\n\u524d\u7f6e\u304d\n\u4ee5\u4e0b\u306e\u8a18\u4e8b\u306e\u304a\u307e\u3051\u3067\u3059\u3002\nCentOS6.6\u306eLinux-HA\u3067DRBD\u4e0a\u306bOracle\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u3092\u69cb\u7bc9\u3059\u308b\nOracle\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u524d\u307e\u3067\u306eLinux-HA\u69cb\u7bc9\u624b\u9806\u3092\u30e1\u30e2\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\nCentOS\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\u30db\u30b9\u30c8\u540d\u3001IP\u30a2\u30c9\u30ec\u30b9\u8a2d\u5b9a\n\n\u30ce\u30fc\u30c9A\u3000\u30db\u30b9\u30c8\u540d:OraSv1\u3000eth0:192.168.10.101\u3000eth1:192.168.1.101\n\u30ce\u30fc\u30c9B\u3000\u30db\u30b9\u30c8\u540d:OraSv2\u3000eth0:192.168.10.102\u3000eth1:192.168.1.102\n\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u6642\u3001DRBD\u3067\uff12\u91cd\u5316\u3059\u308b\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\uff08/ora ext4\uff09\u3092\u8ffd\u52a0\u3059\u308b\u3002\n/etc/fstab\u304c\u3053\u3046\u306a\u308b\u3088\u3046\u306b\u3002\n\n/etc/fstab\n/dev/mapper/vg-lv_root  /             ext4    defaults        1 1\n/dev/mapper/vg-lv_home  /home         ext4    defaults        1 2\n/dev/mapper/vg-lv_ora   /ora          ext4    defaults        1 2\n\n\n\n\u521d\u671f\u8a2d\u5b9a\nDRBD\u3067\u7ba1\u7406\u3059\u308b\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u3092\u30de\u30a6\u30f3\u30c8\u3057\u306a\u3044\u3088\u3046\u3001/ora\u3092\u30b3\u30e1\u30f3\u30c8\u30a2\u30a6\u30c8\u3059\u308b\u3002\n\n/etc/fstab`\n/dev/mapper/vg-lv_root  /             ext4    defaults        1 1\n/dev/mapper/vg-lv_home  /home         ext4    defaults        1 2\n# /dev/mapper/vg-lv_ora   /ora          ext4    defaults        1 2\n\n\n/ora\u3092\u30a2\u30f3\u30de\u30a6\u30f3\u30c8\u3059\u308b\u3002\numount /ora\n\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u306e\u4e2d\u8eab\u3092\u7a7a\u306b\u3059\u308b\ndd if=/dev/zero bs=1M count=1 of=/dev/mapper/vg-lv_ora;sync\n\u30db\u30b9\u30c8\u540d\u8a2d\u5b9a\n\n/etc/hosts\n192.168.10.101  OraSv1\n192.168.10.102  OraSv2\n\n\nHA\u7528\u306e\u30e6\u30fc\u30b6\u30fb\u30b0\u30eb\u30fc\u30d7\u4f5c\u6210\ngroupadd -g 1310 haclient\nuseradd -u 1310 -g haclient -d /home/haclient -s /bin/bash -m haclient\npasswd haclient\n\niptables\u8a2d\u5b9a\niptables -L -n --line-number\n\niptables -I INPUT 1 -m tcp  -p tcp --dport 7788 -j ACCEPT\niptables -I INPUT 2 -m tcp  -p tcp --sport 7788 -j ACCEPT\niptables -I OUTPUT 1 -m tcp  -p tcp --dport 7788 -j ACCEPT\niptables -I OUTPUT 2 -m tcp  -p tcp --sport 7788 -j ACCEPT\n\niptables -I INPUT 3 -m udp -p udp --dport 5405 -j ACCEPT\niptables -I INPUT 4 -m udp -p udp --sport 5405 -j ACCEPT\niptables -I OUTPUT 3 -m udp -p udp --dport 5405 -j ACCEPT\niptables -I OUTPUT 4 -m udp -p udp --sport 5405 -j ACCEPT\n\niptables -L -n --line-number\nservice iptables save\nservice iptables restart\n\n\u6700\u65b0\u306b\u30a2\u30c3\u30d7\u30c7\u30fc\u30c8\u3057\u3066\u304a\u304f\nyum update\n\nDRBD\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\nDRBD\u95a2\u9023\u30d1\u30c3\u30b1\u30fc\u30b8\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\nrpm --import https://www.elrepo.org/RPM-GPG-KEY-elrepo.org\nrpm -Uvh http://www.elrepo.org/elrepo-release-6-6.el6.elrepo.noarch.rpm\nyum install -y drbd84-utils kmod-drbd84\n\nDRBD\u306e\u8a2d\u5b9a\n\n/etc/drbd.conf\n# You can find an example in  /usr/share/doc/drbd.../drbd.conf.example\n\n#include \"drbd.d/global_common.conf\";   \u2190\u30b3\u30e1\u30f3\u30c8\u30a2\u30a6\u30c8\u3059\u308b\n#include \"drbd.d/*.res\";        \u2190\u30b3\u30e1\u30f3\u30c8\u30a2\u30a6\u30c8\u3059\u308b\n\nglobal {\n       usage-count no;\n}\n\ncommon {\n       syncer { rate 50M; }\n}\n\nresource r0 {\n       protocol C;\n       startup {\n               wfc-timeout 120;\n               degr-wfc-timeout 120;\n       }\n       net {\n               cram-hmac-alg \"sha1\";\n               shared-secret \"password\";\n               after-sb-0pri disconnect;\n               after-sb-1pri disconnect;\n               after-sb-2pri disconnect;\n       }\n       disk {\n               on-io-error pass_on;\n       }\n    # \u30ce\u30fc\u30c9A\u306e\u30db\u30b9\u30c8\u540d\u3001IP\u30a2\u30c9\u30ec\u30b9\u3001DRBD\u3067\uff12\u91cd\u5316\u3059\u308b\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u3092\u5b9a\u7fa9\n       on OraSv1 {                  # uname -n\u3000\u3067\u8868\u793a\u3055\u308c\u308b\u30db\u30b9\u30c8\u540d\n               device /dev/drbd0;\n               disk /dev/mapper/vg-lv_ora;\n               address 192.168.10.101:7788;\n               meta-disk internal;\n       }\n    # \u30ce\u30fc\u30c9B\u306e\u30db\u30b9\u30c8\u540d\u3001IP\u30a2\u30c9\u30ec\u30b9\u3001DRBD\u3067\uff12\u91cd\u5316\u3059\u308b\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u3092\u5b9a\u7fa9\n       on OraSv2 {                  # uname -n\u3000\u3067\u8868\u793a\u3055\u308c\u308b\u30db\u30b9\u30c8\u540d\n               device /dev/drbd0;\n               disk /dev/mapper/vg-lv_ora;\n               address 192.168.10.102:7788;\n               meta-disk internal;\n       }\n}\n\n\n\u81ea\u52d5\u8d77\u52d5OFF\u306b\u3059\u308b\nchkconfig --list drbd\nchkconfig drbd off\nchkconfig --list drbd\n\nDRBD\u306e\u30e1\u30bf\u30c7\u30fc\u30bf\u3092\u521d\u671f\u5316\ndrbdadm create-md r0\n\u304a\u307e\u3058\u306a\u3044\ndrbdadm -- 6::::1 set-gi r0\ndrbdadm dump-md r0 > /tmp/md\nsed -i -r -e 's/0xF{16}/0x0000000000000000/g' /tmp/md\ndrbdmeta /dev/drbd0 v08 /dev/mapper/vg-lv_ora internal restore-md /tmp/md ; rm -f /tmp/md\n\n\nDRBD\u8d77\u52d5\uff08\u521d\u56de\u306e\u307f\uff09\nDRBD\u8d77\u52d5\uff08Primary, Secondary\u4e21\u65b9\u3067\u5b9f\u884c\uff09\nservice drbd start\nservice drbd status\ndrbd driver loaded OK; device status:\nversion: 8.4.5 (api:1/proto:86-101)\nGIT-hash: 1d360bde0e095d495786eaeb2a1ac76888e4db96 build by\nmockbuild@Build64R6, 2014-08-17 19:26:04\nm:res  cs         ro                   ds                         p mounted  fstype\n0:r0   Connected  Secondary/Secondary  Inconsistent/Inconsistent  C \n\n\u4e21\u65b9\u306e\u30ce\u30fc\u30c9\u3067\u3053\u306e\u72b6\u614b\n\uff08Connected  Secondary/Secondary Inconsistent/Inconsistent\uff09\n\u306b\u306a\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3059\u308b\u3002\n\u4ee5\u4e0b\u3001\u30ce\u30fc\u30c9A\u3092Primary\u3001\u30ce\u30fc\u30c9B\u3092Secondary\u3068\u3057\u3066\u8a2d\u5b9a\u3092\u9032\u3081\u308b\u3002\nSecondary\u5074\uff08\u30ce\u30fc\u30c9B\uff09\u3067\u5b9f\u884c\ndrbdadm invalidate r0\n\ncat /proc/drbd\nversion: 8.4.5 (api:1/proto:86-101)\nGIT-hash: 1d360bde0e095d495786eaeb2a1ac76888e4db96 build by\nmockbuild@Build64R6, 2014-08-17 19:26:04\n 0: cs:SyncSource ro:Secondary/Secondary ds:UpToDate/Inconsistent C r-----\n    ns:2473212 nr:0 dw:0 dr:2473212 al:0 bm:0 lo:0 pe:4 ua:0 ap:0 ep:1\nwo:f oos:23742668\n        [>...................] sync'ed:  9.5% (23184/25596)M\n        finish: 0:18:25 speed: 21,444 (21,484) K/sec\n\n\u540c\u671f\u304c\u7d42\u308f\u308b\u307e\u3067\uff08sync'ed \u304c100\uff05\u306b\u306a\u308b\u307e\u3067\uff09\u5f85\u3064\u3002\n\u540c\u671f\u5b8c\u4e86\u3059\u308b\u3068\u3053\u3046\u306a\u308b\u3002\n\n\u30ce\u30fc\u30c9A\n\n# service drbd status\ndrbd driver loaded OK; device status:\nversion: 8.4.5 (api:1/proto:86-101)\nGIT-hash: 1d360bde0e095d495786eaeb2a1ac76888e4db96 build by\nphil@Build64R6, 2014-10-28 10:32:53\nm:res  cs         ro                 ds                 p  mounted  fstype\n0:r0   Connected  Primary/Secondary  UpToDate/UpToDate  C\n\n\n\u30ce\u30fc\u30c9B\n\n# service drbd status\ndrbd driver loaded OK; device status:\nversion: 8.4.5 (api:1/proto:86-101)\nGIT-hash: 1d360bde0e095d495786eaeb2a1ac76888e4db96 build by\nphil@Build64R6, 2014-10-28 10:32:53\nm:res  cs         ro                 ds                 p  mounted  fstype\n0:r0   Connected  Secondary/Primary  UpToDate/UpToDate  C\n\n\u30ce\u30fc\u30c9A\u3067\u5b9f\u884c     \ndrbdadm primary r0\nmkfs.ext4 /dev/drbd0\nmount /dev/drbd0 /ora\ndf\n/dev/drbd0            25671160   44992  24315492   1% /ora\n\n/dev/drbd0\u304c/ora\u3068\u3057\u3066\u8aad\u307f\u66f8\u304d\u53ef\u80fd\u3067\u3042\u308b\u3053\u3068\u3002\n\u9069\u5f53\u306a\u30d5\u30a1\u30a4\u30eb\u3092\u30ce\u30fc\u30c9A\u3067\u4f5c\u6210\u3057\u3066\u307f\u308b\u3002\n\u30ce\u30fc\u30c9A\u3067\u5b9f\u884c\necho \"DRBD TEST from Node A\" > /ora/test.txt\nls /ora\ncat /ora/test.txt\nDRBD TEST from Node A\n\nPrimary/Secondary\u3092\u5207\u308a\u66ff\u3048\u3066\u307f\u308b\u3002\numount /ora\ndrbdadm secondary r0\n\n\u30ce\u30fc\u30c9B\u3067\u5b9f\u884c\ndrbdadm primary r0\nmount /dev/drbd0 /ora\ndf\n/dev/drbd0            25671160   44992  24315492   1% /ora\ncat /ora/test.txt\nDRBD TEST from Node A\n\necho \"DRBD TEST from Node B\" >> /ora/test.txt\n\nPrimary/Secondary\u3092\u5207\u308a\u66ff\u3048\u3066\u307f\u308b\u3002\numount /ora\ndrbdadm secondary r0\n\n\u30ce\u30fc\u30c9A\u3067\u5b9f\u884c\ndrbdadm primary r0\nmount /dev/drbd0 /ora\ncat /ora/test.txt\nDRBD TEST from Node A\nDRBD TEST from Node B\n\n\nPacemaker\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\nPacemaker\u30ea\u30dd\u30b8\u30c8\u30ea\u3092\u53d6\u5f97\u3001\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\ncd /tmp\nwget \"http://sourceforge.jp/frs/redir.php?m=jaist&f=%2Flinux-ha%2F62369%2Fpacemaker-repo-1.1.12-1.1.el6.x86_64.rpm\"\nmv redir.php?m=jaist&f=%2Flinux-ha%2F62369%2Fpacemaker-repo-1.1.12-1.1.el6.x86_64.rpm pacemaker-repo-1.1.12-1.1.el6.x86_64.rpm\n\nrpm -ivh pacemaker-repo-1.1.12-1.1.el6.x86_64.rpm\nyum install pacemaker-all\n\nCorosync\u306e\u8a2d\u5b9a\n\n/etc/corosync/corosync.conf\ncompatibility: whitetank\n\naisexec {\n       user: root\n       group: root\n}\n\nservice {\n       name: pacemaker\n       ver: 0\n       use_mgmtd: yes\n}\n\namf {\n       mode: disabled\n}\n\ntotem {\n       version: 2\n       secauth: off\n       threads: 0\n       rrp_mode: none\n       clear_node_high_bit: yes\n       token: 4000\n       censensus: 7000\n       join: 60\n       interface {\n               member {\n                       memberaddr: 192.168.1.101    #\u30ce\u30fc\u30c9A\n               }\n               member {\n                       memberaddr: 192.168.1.102    #\u30ce\u30fc\u30c9B\n               }\n               ringnumber: 0\n               bindnetaddr: 192.168.1.0         #\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u30a2\u30c9\u30ec\u30b9\n               mcastport: 5405\n               ttl: 1\n       }\n       transport: udpu\n}\n\nlogging {\n       fileline: off\n       to_logfile: yes\n       to_syslog: no\n       logfile: /var/log/cluster/corosync.log\n       debug: off\n       timestamp: on\n       logger_subsys {\n               subsys: AMF\n               debug: off\n       }\n}\n\nquorum {\n       provider: corosync_votequorum\n       expected_votes: 2\n       two_node: 1\n}\n\n\n\u81ea\u52d5\u8d77\u52d5ON\u306b\u3059\u308b\nchkconfig pacemaker on\nchkconfig --list pacemaker\nchkconfig corosync on\nchkconfig --list corosync\n\nPacemaker, Corosync\u8d77\u52d5\uff08\u521d\u56de\u306e\u307f\uff09\n\u4e21\u65b9\u306e\u30ce\u30fc\u30c9\u3067\u8d77\u52d5\u3059\u308b\nservice corosync start\nservice pacemaker start\n\n\n\u624b\u52d5\u3067\u505c\u6b62\u3059\u308b\u3068\u304d\u306f\u3053\u306e\u9806\u756a\u3067\u505c\u6b62\u3059\u308b\u3053\u3068\nservice pacemaker stop\nservice corosync stop\n\n\u8d77\u52d5\u72b6\u614b\u306e\u78ba\u8a8d\uff08\u7247\u65b9\u306e\u30ce\u30fc\u30c9\u3067\u5b9f\u884c\u3059\u308c\u3070\u3088\u3044\uff09\ncrm_mon -Aro\nLast updated: Thu Dec 25 19:27:45 2014  \nLast change: Thu Dec 25 19:24:22 2014   \nStack: corosync \nCurrent DC: OraSv1 (740103615) - partition with quorum  \nVersion: 1.1.12-561c4cf \n2 Nodes configured  \n0 Resources configured  \n\n\nOnline: [ OraSv1 OraSv2 ]   \n\nFull list of resources: \n\n\nNode Attributes:    \n* Node OraSv1:\n* Node OraSv2:\n\nOperations:\n* Node OraSv1:\n* Node OraSv2:\n\n\u4e21\u65b9\u304cOnline\u306b\u306a\u3063\u3066\u308c\u3070OK\uff08Ctrl+C\u3067\u8868\u793a\u7d42\u4e86\uff09\n\nCRM\u8a2d\u5b9a\n\u7247\u65b9\u306e\u30ce\u30fc\u30c9\u3067\u5b9f\u884c\u3059\u308c\u3070\u3088\u3044\ncrm configure\nproperty no-quorum-policy=ignore stonith-enabled=false\nrsc_defaults resource-stickiness=INFINITY migration-threshold=1\ncommit\nexit\n\n\nDRBD\u3092\u6b7b\u6d3b\u76e3\u8996\u5bfe\u8c61\u306b\u8a2d\u5b9a\n\u5ff5\u306e\u305f\u3081\u3001/dev/drbd0 \u3092\u30a2\u30f3\u30de\u30a6\u30f3\u30c8\u3057\u3066\u304a\u304f\u3002\numount /ora\ncrm configure\nprimitive drbd_ora ocf:linbit:drbd params drbdconf=/etc/drbd.conf \\\ndrbd_resource=r0 \\\nop start interval=0s timeout=240s \\\nop monitor interval=10 role=Slave \\\nop monitor interval=11 role=Master \\\nop stop interval=0 timeout=100s on-fail=block\n\nms ms-drbd_ora drbd_ora meta notify=true\n\nprimitive fs_ora ocf:heartbeat:Filesystem params run_fsck=no \\\ndevice=/dev/drbd0 directory=/ora fstype=ext4 \\\nop start interval=0s timeout=60s \\\nop monitor interval=15 timeout=40s \\\nop stop interval=0 timeout=60s on-fail=ignore\n\ncolocation coloc-drbd_fs inf: fs_ora ms-drbd_ora:Master\norder order-drbd_fs inf: ms-drbd_ora:promote fs_ora:start\n\ncommit\nexit\n\n\u72b6\u6cc1\u78ba\u8a8d\ncrm_mon\n Master/Slave Set: ms-drbd_ora [drbd_ora]\n     Masters: [ OraSv1 ]\n     Slaves: [ OraSv2 ]\nfs_ora      (ocf::heartbeat:Filesystem):    Started OraSv1\n\nMasters\u306b\u306a\u3063\u3066\u3044\u308b\u30ce\u30fc\u30c9\uff08OraSv1\uff09\u3067/ora\u304c\u30de\u30a6\u30f3\u30c8\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3002\ndf\ncat /ora/test.txt\n\nMaster\u5074\u3092\u30ea\u30d6\u30fc\u30c8\nshutdown -r now\nSlave\u5074\u304cMaster\u306b\u6607\u683c\u3059\u308b\u3053\u3068\ncrm_mon\n Master/Slave Set: ms-drbd_ora [drbd_ora]\n     Masters: [ OraSv2 ]\n     Slaves: [ OraSv1 ]\nfs_ora      (ocf::heartbeat:Filesystem):    Started OraSv2\n\n/ora\u304c\u30de\u30a6\u30f3\u30c8\u3055\u308c\u3066\u3044\u308b\u3053\u3068\ndf\n\u518d\u8d77\u52d5\u3057\u305f\u65b9\u304cSlaves\u306b\u306a\u3063\u3066\u3044\u308b\u3053\u3068\n\n\u4eee\u60f3IP\u30a2\u30c9\u30ec\u30b9\u4f5c\u6210\n\u4eee\u60f3IP\u30a2\u30c9\u30ec\u30b9\u3000192.168.10.100\u3092\u4f5c\u308b\u3002\nFilesystem\uff08fs_ora\uff09\u3068\u30b0\u30eb\u30fc\u30d7\u5316\u3057\u3001\u540c\u4e00\u30ce\u30fc\u30c9\u3067\u5b9f\u884c\u3059\u308b\u3088\u3046\u8a2d\u5b9a\u3059\u308b\u3002\ncrm configure\nprimitive VIP1 ocf:heartbeat:IPaddr2 \\\nparams ip=192.168.10.100 nic=eth0 cidr_netmask=24 \\\nop start interval=0s timeout=20s \\\nop stop interval=0s timeout=20s \\\nop monitor interval=30s\n\ngroup grpora fs_ora VIP1\n\ncommit\nexit\n\n\u72b6\u6cc1\u78ba\u8a8d\ncrm_mon\nVIP1    (ocf::heartbeat:IPaddr2):       Started OraSv2\n Master/Slave Set: ms-drbd_ora [drbd_ora]       \n     Masters: [ OraSv2 ]        \n     Slaves: [ OraSv1 ]     \nfs_ora      (ocf::heartbeat:Filesystem):    Started OraSv2      \n\nfs_ora\u3068VIP1\u304c\u540c\u4e00\u30ce\u30fc\u30c9\u3067\u8d77\u52d5\u3059\u308b\u3053\u3068\u3002\n\u5225\u30de\u30b7\u30f3\u304b\u3089\u4eee\u60f3IP\u306b\u63a5\u7d9a\u3057\u3001\u4eee\u60f3IP\u304c\u8d77\u52d5\u3057\u3066\u3044\u308b\u30ce\u30fc\u30c9\uff08\u4e0a\u8a18\u306e\u4f8b\u3060\u3068OraSv2\uff09\u306b\u63a5\u7d9a\u3059\u308b\u3053\u3068\u3002\n\n\u8a2d\u5b9a\u306f\u4ee5\u4e0a\u3067\u3059\u3002\n\u3053\u3053\u307e\u3067\u51fa\u6765\u305f\u3089\u3001\u5143\u8a18\u4e8b\u306b\u623b\u3063\u3066Oracle\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u307e\u3059\u3002\nCentOS6.6\u306eLinux-HA\u3067DRBD\u4e0a\u306bOracle\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u3092\u69cb\u7bc9\u3059\u308b\n# \u524d\u7f6e\u304d\n\n\u4ee5\u4e0b\u306e\u8a18\u4e8b\u306e\u304a\u307e\u3051\u3067\u3059\u3002\n[CentOS6.6\u306eLinux-HA\u3067DRBD\u4e0a\u306bOracle\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u3092\u69cb\u7bc9\u3059\u308b](http://qiita.com/takusamar/items/134fbb8fbb736fd8a8a6)\n\nOracle\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u524d\u307e\u3067\u306eLinux-HA\u69cb\u7bc9\u624b\u9806\u3092\u30e1\u30e2\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\n# CentOS\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n\u30db\u30b9\u30c8\u540d\u3001IP\u30a2\u30c9\u30ec\u30b9\u8a2d\u5b9a\n\n* \u30ce\u30fc\u30c9A\u3000\u30db\u30b9\u30c8\u540d:OraSv1\u3000eth0:192.168.10.101\u3000eth1:192.168.1.101\n* \u30ce\u30fc\u30c9B\u3000\u30db\u30b9\u30c8\u540d:OraSv2\u3000eth0:192.168.10.102\u3000eth1:192.168.1.102\n\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u6642\u3001DRBD\u3067\uff12\u91cd\u5316\u3059\u308b\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\uff08/ora ext4\uff09\u3092\u8ffd\u52a0\u3059\u308b\u3002\n/etc/fstab\u304c\u3053\u3046\u306a\u308b\u3088\u3046\u306b\u3002\n\n```sh:/etc/fstab\n/dev/mapper/vg-lv_root  /             ext4    defaults        1 1\n/dev/mapper/vg-lv_home  /home         ext4    defaults        1 2\n/dev/mapper/vg-lv_ora   /ora          ext4    defaults        1 2\n```\n\n# \u521d\u671f\u8a2d\u5b9a\n\t\t\t\nDRBD\u3067\u7ba1\u7406\u3059\u308b\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u3092\u30de\u30a6\u30f3\u30c8\u3057\u306a\u3044\u3088\u3046\u3001/ora\u3092\u30b3\u30e1\u30f3\u30c8\u30a2\u30a6\u30c8\u3059\u308b\u3002\n\n```sh:/etc/fstab`\n/dev/mapper/vg-lv_root  /             ext4    defaults        1 1\n/dev/mapper/vg-lv_home  /home         ext4    defaults        1 2\n# /dev/mapper/vg-lv_ora   /ora          ext4    defaults        1 2\n```\n\n/ora\u3092\u30a2\u30f3\u30de\u30a6\u30f3\u30c8\u3059\u308b\u3002\n`umount /ora`\n\n\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u306e\u4e2d\u8eab\u3092\u7a7a\u306b\u3059\u308b\t\t\t\n`dd if=/dev/zero bs=1M count=1 of=/dev/mapper/vg-lv_ora;sync`\n\n\u30db\u30b9\u30c8\u540d\u8a2d\u5b9a\n\n```sh:/etc/hosts\n192.168.10.101  OraSv1\n192.168.10.102  OraSv2\n```\t\t\t\n\nHA\u7528\u306e\u30e6\u30fc\u30b6\u30fb\u30b0\u30eb\u30fc\u30d7\u4f5c\u6210\n\n```sh:\ngroupadd -g 1310 haclient\nuseradd -u 1310 -g haclient -d /home/haclient -s /bin/bash -m haclient\npasswd haclient\n```\n\niptables\u8a2d\u5b9a\n\n```sh:\niptables -L -n --line-number\n\niptables -I INPUT 1 -m tcp  -p tcp --dport 7788 -j ACCEPT\niptables -I INPUT 2 -m tcp  -p tcp --sport 7788 -j ACCEPT\niptables -I OUTPUT 1 -m tcp  -p tcp --dport 7788 -j ACCEPT\niptables -I OUTPUT 2 -m tcp  -p tcp --sport 7788 -j ACCEPT\n\niptables -I INPUT 3 -m udp -p udp --dport 5405 -j ACCEPT\niptables -I INPUT 4 -m udp -p udp --sport 5405 -j ACCEPT\niptables -I OUTPUT 3 -m udp -p udp --dport 5405 -j ACCEPT\niptables -I OUTPUT 4 -m udp -p udp --sport 5405 -j ACCEPT\n\niptables -L -n --line-number\nservice iptables save\nservice iptables restart\n```\n\n\u6700\u65b0\u306b\u30a2\u30c3\u30d7\u30c7\u30fc\u30c8\u3057\u3066\u304a\u304f\n`yum update`\n\n# DRBD\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\nDRBD\u95a2\u9023\u30d1\u30c3\u30b1\u30fc\u30b8\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n```sh:\nrpm --import https://www.elrepo.org/RPM-GPG-KEY-elrepo.org\nrpm -Uvh http://www.elrepo.org/elrepo-release-6-6.el6.elrepo.noarch.rpm\nyum install -y drbd84-utils kmod-drbd84\n```\n\nDRBD\u306e\u8a2d\u5b9a\n\n```sh:/etc/drbd.conf\n# You can find an example in  /usr/share/doc/drbd.../drbd.conf.example\n\n#include \"drbd.d/global_common.conf\";\t\u2190\u30b3\u30e1\u30f3\u30c8\u30a2\u30a6\u30c8\u3059\u308b\n#include \"drbd.d/*.res\";\t\t\u2190\u30b3\u30e1\u30f3\u30c8\u30a2\u30a6\u30c8\u3059\u308b\n\nglobal {\n       usage-count no;\n}\n\ncommon {\n       syncer { rate 50M; }\n}\n\nresource r0 {\n       protocol C;\n       startup {\n               wfc-timeout 120;\n               degr-wfc-timeout 120;\n       }\n       net {\n               cram-hmac-alg \"sha1\";\n               shared-secret \"password\";\n               after-sb-0pri disconnect;\n               after-sb-1pri disconnect;\n               after-sb-2pri disconnect;\n       }\n       disk {\n               on-io-error pass_on;\n       }\n\t# \u30ce\u30fc\u30c9A\u306e\u30db\u30b9\u30c8\u540d\u3001IP\u30a2\u30c9\u30ec\u30b9\u3001DRBD\u3067\uff12\u91cd\u5316\u3059\u308b\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u3092\u5b9a\u7fa9\n       on OraSv1 {                  # uname -n\u3000\u3067\u8868\u793a\u3055\u308c\u308b\u30db\u30b9\u30c8\u540d\n               device /dev/drbd0;\n               disk /dev/mapper/vg-lv_ora;\n               address 192.168.10.101:7788;\n               meta-disk internal;\n       }\n\t# \u30ce\u30fc\u30c9B\u306e\u30db\u30b9\u30c8\u540d\u3001IP\u30a2\u30c9\u30ec\u30b9\u3001DRBD\u3067\uff12\u91cd\u5316\u3059\u308b\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u3092\u5b9a\u7fa9\n       on OraSv2 {                  # uname -n\u3000\u3067\u8868\u793a\u3055\u308c\u308b\u30db\u30b9\u30c8\u540d\n               device /dev/drbd0;\n               disk /dev/mapper/vg-lv_ora;\n               address 192.168.10.102:7788;\n               meta-disk internal;\n       }\n}\n```\n\n\u81ea\u52d5\u8d77\u52d5OFF\u306b\u3059\u308b\n\n```sh:\nchkconfig --list drbd\nchkconfig drbd off\nchkconfig --list drbd\n```\n\nDRBD\u306e\u30e1\u30bf\u30c7\u30fc\u30bf\u3092\u521d\u671f\u5316\n`drbdadm create-md r0`\n\n\u304a\u307e\u3058\u306a\u3044\n\n```sh:\ndrbdadm -- 6::::1 set-gi r0\ndrbdadm dump-md r0 > /tmp/md\nsed -i -r -e 's/0xF{16}/0x0000000000000000/g' /tmp/md\ndrbdmeta /dev/drbd0 v08 /dev/mapper/vg-lv_ora internal restore-md /tmp/md ; rm -f /tmp/md\n```\n\n# DRBD\u8d77\u52d5\uff08\u521d\u56de\u306e\u307f\uff09\n\nDRBD\u8d77\u52d5\uff08Primary, Secondary\u4e21\u65b9\u3067\u5b9f\u884c\uff09\n\n```sh:\nservice drbd start\nservice drbd status\ndrbd driver loaded OK; device status:\nversion: 8.4.5 (api:1/proto:86-101)\nGIT-hash: 1d360bde0e095d495786eaeb2a1ac76888e4db96 build by\nmockbuild@Build64R6, 2014-08-17 19:26:04\nm:res  cs         ro                   ds                         p mounted  fstype\n0:r0   Connected  Secondary/Secondary  Inconsistent/Inconsistent  C\t\n```\n\n\u4e21\u65b9\u306e\u30ce\u30fc\u30c9\u3067\u3053\u306e\u72b6\u614b\n\uff08Connected  Secondary/Secondary Inconsistent/Inconsistent\uff09\n\u306b\u306a\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3059\u308b\u3002\n\n\u4ee5\u4e0b\u3001\u30ce\u30fc\u30c9A\u3092Primary\u3001\u30ce\u30fc\u30c9B\u3092Secondary\u3068\u3057\u3066\u8a2d\u5b9a\u3092\u9032\u3081\u308b\u3002\n\nSecondary\u5074\uff08\u30ce\u30fc\u30c9B\uff09\u3067\u5b9f\u884c\n\n```sh:\ndrbdadm invalidate r0\n\ncat /proc/drbd\nversion: 8.4.5 (api:1/proto:86-101)\nGIT-hash: 1d360bde0e095d495786eaeb2a1ac76888e4db96 build by\nmockbuild@Build64R6, 2014-08-17 19:26:04\n 0: cs:SyncSource ro:Secondary/Secondary ds:UpToDate/Inconsistent C r-----\n    ns:2473212 nr:0 dw:0 dr:2473212 al:0 bm:0 lo:0 pe:4 ua:0 ap:0 ep:1\nwo:f oos:23742668\n        [>...................] sync'ed:  9.5% (23184/25596)M\n        finish: 0:18:25 speed: 21,444 (21,484) K/sec\n```\n\n\u540c\u671f\u304c\u7d42\u308f\u308b\u307e\u3067\uff08sync'ed \u304c100\uff05\u306b\u306a\u308b\u307e\u3067\uff09\u5f85\u3064\u3002\n\n\u540c\u671f\u5b8c\u4e86\u3059\u308b\u3068\u3053\u3046\u306a\u308b\u3002\n\n* \u30ce\u30fc\u30c9A\n\n```sh:\n# service drbd status\ndrbd driver loaded OK; device status:\nversion: 8.4.5 (api:1/proto:86-101)\nGIT-hash: 1d360bde0e095d495786eaeb2a1ac76888e4db96 build by\nphil@Build64R6, 2014-10-28 10:32:53\nm:res  cs         ro                 ds                 p  mounted  fstype\n0:r0   Connected  Primary/Secondary  UpToDate/UpToDate  C\n```\n\n* \u30ce\u30fc\u30c9B\n\n```sh:\n# service drbd status\ndrbd driver loaded OK; device status:\nversion: 8.4.5 (api:1/proto:86-101)\nGIT-hash: 1d360bde0e095d495786eaeb2a1ac76888e4db96 build by\nphil@Build64R6, 2014-10-28 10:32:53\nm:res  cs         ro                 ds                 p  mounted  fstype\n0:r0   Connected  Secondary/Primary  UpToDate/UpToDate  C\n```\n\n\u30ce\u30fc\u30c9A\u3067\u5b9f\u884c\t\t\n\n```sh:\ndrbdadm primary r0\nmkfs.ext4 /dev/drbd0\nmount /dev/drbd0 /ora\ndf\n/dev/drbd0            25671160   44992  24315492   1% /ora\n```\n\n/dev/drbd0\u304c/ora\u3068\u3057\u3066\u8aad\u307f\u66f8\u304d\u53ef\u80fd\u3067\u3042\u308b\u3053\u3068\u3002\n\u9069\u5f53\u306a\u30d5\u30a1\u30a4\u30eb\u3092\u30ce\u30fc\u30c9A\u3067\u4f5c\u6210\u3057\u3066\u307f\u308b\u3002\n\n\u30ce\u30fc\u30c9A\u3067\u5b9f\u884c\n\n```sh:\necho \"DRBD TEST from Node A\" > /ora/test.txt\nls /ora\ncat /ora/test.txt\nDRBD TEST from Node A\n```\n\nPrimary/Secondary\u3092\u5207\u308a\u66ff\u3048\u3066\u307f\u308b\u3002\n\n```sh:\numount /ora\ndrbdadm secondary r0\n```\n\n\u30ce\u30fc\u30c9B\u3067\u5b9f\u884c\n\n```sh:\ndrbdadm primary r0\nmount /dev/drbd0 /ora\ndf\n/dev/drbd0            25671160   44992  24315492   1% /ora\ncat /ora/test.txt\nDRBD TEST from Node A\n\necho \"DRBD TEST from Node B\" >> /ora/test.txt\n```\n\nPrimary/Secondary\u3092\u5207\u308a\u66ff\u3048\u3066\u307f\u308b\u3002\n\n```sh:\numount /ora\ndrbdadm secondary r0\n```\n\n\u30ce\u30fc\u30c9A\u3067\u5b9f\u884c\n\n```sh:\ndrbdadm primary r0\nmount /dev/drbd0 /ora\ncat /ora/test.txt\nDRBD TEST from Node A\nDRBD TEST from Node B\n```\n\n# Pacemaker\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\nPacemaker\u30ea\u30dd\u30b8\u30c8\u30ea\u3092\u53d6\u5f97\u3001\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n```sh:\ncd /tmp\nwget \"http://sourceforge.jp/frs/redir.php?m=jaist&f=%2Flinux-ha%2F62369%2Fpacemaker-repo-1.1.12-1.1.el6.x86_64.rpm\"\nmv redir.php?m=jaist&f=%2Flinux-ha%2F62369%2Fpacemaker-repo-1.1.12-1.1.el6.x86_64.rpm pacemaker-repo-1.1.12-1.1.el6.x86_64.rpm\n\nrpm -ivh pacemaker-repo-1.1.12-1.1.el6.x86_64.rpm\nyum install pacemaker-all\n```\n\nCorosync\u306e\u8a2d\u5b9a\n\n```sh:/etc/corosync/corosync.conf\ncompatibility: whitetank\n\naisexec {\n       user: root\n       group: root\n}\n\nservice {\n       name: pacemaker\n       ver: 0\n       use_mgmtd: yes\n}\n\namf {\n       mode: disabled\n}\n\ntotem {\n       version: 2\n       secauth: off\n       threads: 0\n       rrp_mode: none\n       clear_node_high_bit: yes\n       token: 4000\n       censensus: 7000\n       join: 60\n       interface {\n               member {\n                       memberaddr: 192.168.1.101\t#\u30ce\u30fc\u30c9A\n               }\n               member {\n                       memberaddr: 192.168.1.102\t#\u30ce\u30fc\u30c9B\n               }\n               ringnumber: 0\n               bindnetaddr: 192.168.1.0\t\t\t#\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u30a2\u30c9\u30ec\u30b9\n               mcastport: 5405\n               ttl: 1\n       }\n       transport: udpu\n}\n\nlogging {\n       fileline: off\n       to_logfile: yes\n       to_syslog: no\n       logfile: /var/log/cluster/corosync.log\n       debug: off\n       timestamp: on\n       logger_subsys {\n               subsys: AMF\n               debug: off\n       }\n}\n\nquorum {\n       provider: corosync_votequorum\n       expected_votes: 2\n       two_node: 1\n}\n```\n\n\u81ea\u52d5\u8d77\u52d5ON\u306b\u3059\u308b\n\n```sh:\nchkconfig pacemaker on\nchkconfig --list pacemaker\nchkconfig corosync on\nchkconfig --list corosync\n```\n\nPacemaker, Corosync\u8d77\u52d5\uff08\u521d\u56de\u306e\u307f\uff09\n\n\u4e21\u65b9\u306e\u30ce\u30fc\u30c9\u3067\u8d77\u52d5\u3059\u308b\n\n```sh:\nservice corosync start\nservice pacemaker start\n```\n\n> \u624b\u52d5\u3067\u505c\u6b62\u3059\u308b\u3068\u304d\u306f\u3053\u306e\u9806\u756a\u3067\u505c\u6b62\u3059\u308b\u3053\u3068\n> service pacemaker stop\n> service corosync stop\n\n\u8d77\u52d5\u72b6\u614b\u306e\u78ba\u8a8d\uff08\u7247\u65b9\u306e\u30ce\u30fc\u30c9\u3067\u5b9f\u884c\u3059\u308c\u3070\u3088\u3044\uff09\n`crm_mon -Aro`\n\n```sh:\nLast updated: Thu Dec 25 19:27:45 2014\t\nLast change: Thu Dec 25 19:24:22 2014\t\nStack: corosync\t\nCurrent DC: OraSv1 (740103615) - partition with quorum\t\nVersion: 1.1.12-561c4cf\t\n2 Nodes configured\t\n0 Resources configured\t\n\t\n\t\nOnline: [ OraSv1 OraSv2 ]\t\n\t\nFull list of resources:\t\n\n\nNode Attributes:\t\n* Node OraSv1:\n* Node OraSv2:\n\t\nOperations:\n* Node OraSv1:\n* Node OraSv2:\n```\n\n\u4e21\u65b9\u304cOnline\u306b\u306a\u3063\u3066\u308c\u3070OK\uff08Ctrl+C\u3067\u8868\u793a\u7d42\u4e86\uff09\n\n# CRM\u8a2d\u5b9a\n\t\t\n\u7247\u65b9\u306e\u30ce\u30fc\u30c9\u3067\u5b9f\u884c\u3059\u308c\u3070\u3088\u3044\n`crm configure`\n\n```sh:\nproperty no-quorum-policy=ignore stonith-enabled=false\nrsc_defaults resource-stickiness=INFINITY migration-threshold=1\ncommit\nexit\n```\n\n## DRBD\u3092\u6b7b\u6d3b\u76e3\u8996\u5bfe\u8c61\u306b\u8a2d\u5b9a\n\n\u5ff5\u306e\u305f\u3081\u3001/dev/drbd0 \u3092\u30a2\u30f3\u30de\u30a6\u30f3\u30c8\u3057\u3066\u304a\u304f\u3002\t\t\n`umount /ora`\n\n`crm configure`\n\n```sh:\nprimitive drbd_ora ocf:linbit:drbd params drbdconf=/etc/drbd.conf \\\ndrbd_resource=r0 \\\nop start interval=0s timeout=240s \\\nop monitor interval=10 role=Slave \\\nop monitor interval=11 role=Master \\\nop stop interval=0 timeout=100s on-fail=block\n\t\nms ms-drbd_ora drbd_ora meta notify=true\n\nprimitive fs_ora ocf:heartbeat:Filesystem params run_fsck=no \\\ndevice=/dev/drbd0 directory=/ora fstype=ext4 \\\nop start interval=0s timeout=60s \\\nop monitor interval=15 timeout=40s \\\nop stop interval=0 timeout=60s on-fail=ignore\n\ncolocation coloc-drbd_fs inf: fs_ora ms-drbd_ora:Master\norder order-drbd_fs inf: ms-drbd_ora:promote fs_ora:start\n\ncommit\nexit\n```\n\n\u72b6\u6cc1\u78ba\u8a8d\n`crm_mon`\n\n```sh:\n Master/Slave Set: ms-drbd_ora [drbd_ora]\n     Masters: [ OraSv1 ]\n     Slaves: [ OraSv2 ]\nfs_ora      (ocf::heartbeat:Filesystem):    Started OraSv1\n```\n\nMasters\u306b\u306a\u3063\u3066\u3044\u308b\u30ce\u30fc\u30c9\uff08OraSv1\uff09\u3067/ora\u304c\u30de\u30a6\u30f3\u30c8\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3002\n\n```sh:\ndf\ncat /ora/test.txt\n```\n\nMaster\u5074\u3092\u30ea\u30d6\u30fc\u30c8\n`shutdown -r now`\n\t\t\nSlave\u5074\u304cMaster\u306b\u6607\u683c\u3059\u308b\u3053\u3068\n`crm_mon`\n\n```\n Master/Slave Set: ms-drbd_ora [drbd_ora]\n     Masters: [ OraSv2 ]\n     Slaves: [ OraSv1 ]\nfs_ora      (ocf::heartbeat:Filesystem):    Started OraSv2\n```\n\t\t\t\n/ora\u304c\u30de\u30a6\u30f3\u30c8\u3055\u308c\u3066\u3044\u308b\u3053\u3068\n`df`\n\n\u518d\u8d77\u52d5\u3057\u305f\u65b9\u304cSlaves\u306b\u306a\u3063\u3066\u3044\u308b\u3053\u3068\n\n# \u4eee\u60f3IP\u30a2\u30c9\u30ec\u30b9\u4f5c\u6210\n\t\t\t\n\u4eee\u60f3IP\u30a2\u30c9\u30ec\u30b9\u3000192.168.10.100\u3092\u4f5c\u308b\u3002\nFilesystem\uff08fs_ora\uff09\u3068\u30b0\u30eb\u30fc\u30d7\u5316\u3057\u3001\u540c\u4e00\u30ce\u30fc\u30c9\u3067\u5b9f\u884c\u3059\u308b\u3088\u3046\u8a2d\u5b9a\u3059\u308b\u3002\n\t\t\n`crm configure`\n\n```sh:\nprimitive VIP1 ocf:heartbeat:IPaddr2 \\\nparams ip=192.168.10.100 nic=eth0 cidr_netmask=24 \\\nop start interval=0s timeout=20s \\\nop stop interval=0s timeout=20s \\\nop monitor interval=30s\n\ngroup grpora fs_ora VIP1\n\ncommit\nexit\n```\n\n\u72b6\u6cc1\u78ba\u8a8d\n`crm_mon`\n\n```sh:\nVIP1    (ocf::heartbeat:IPaddr2):       Started OraSv2\n Master/Slave Set: ms-drbd_ora [drbd_ora]\t\t\n     Masters: [ OraSv2 ]\t\t\n     Slaves: [ OraSv1 ]\t\t\nfs_ora      (ocf::heartbeat:Filesystem):    Started OraSv2\t\t\n```\n\nfs_ora\u3068VIP1\u304c\u540c\u4e00\u30ce\u30fc\u30c9\u3067\u8d77\u52d5\u3059\u308b\u3053\u3068\u3002\n\n\u5225\u30de\u30b7\u30f3\u304b\u3089\u4eee\u60f3IP\u306b\u63a5\u7d9a\u3057\u3001\u4eee\u60f3IP\u304c\u8d77\u52d5\u3057\u3066\u3044\u308b\u30ce\u30fc\u30c9\uff08\u4e0a\u8a18\u306e\u4f8b\u3060\u3068OraSv2\uff09\u306b\u63a5\u7d9a\u3059\u308b\u3053\u3068\u3002\n\n* * *\n\n\u8a2d\u5b9a\u306f\u4ee5\u4e0a\u3067\u3059\u3002\n\n\u3053\u3053\u307e\u3067\u51fa\u6765\u305f\u3089\u3001\u5143\u8a18\u4e8b\u306b\u623b\u3063\u3066Oracle\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u307e\u3059\u3002\n[CentOS6.6\u306eLinux-HA\u3067DRBD\u4e0a\u306bOracle\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u3092\u69cb\u7bc9\u3059\u308b](http://qiita.com/takusamar/items/134fbb8fbb736fd8a8a6)\n\n\n\n\n", "tags": ["CentOS6.6", "drbd8.4", "pacemaker1.1.12", "corosync2.3.4"]}