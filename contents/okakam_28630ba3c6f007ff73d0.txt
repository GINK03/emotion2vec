{"context": "\n\n\u80cc\u666f\nNodejs + Express + nodejs-facebook-sdk \u3092\u4f7f\u3063\u3066 OAuth \u8a8d\u8a3c\u3092\u3057\u3066\u307f\u305f\u304b\u3063\u305f\n\n\u74b0\u5883\n\nexpress-generator \u3092\u4f7f\u3063\u3066 Express \u306e\u30c7\u30d5\u30a9\u30eb\u30c8\u74b0\u5883\u3092\u69cb\u7bc9\u3057\u307e\u3059\u3002\n\n$ express fb-test\n$ cd fb-test\n$ npm install\n\n\nfacebook-node-sdk \u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\n\n$ npm install fb --save\n\n\n\u753b\u9762\u306a\u3069\n\nLogin\u30ea\u30f3\u30af\u7528\u306e\u753b\u9762\n\n\nindex.jade\nextends layout\n\nblock content\n    h1= title\n    p Welcome to #{title}\n    a(href=\"#{loginUrl}\") #{loginUrl}\n\n\n\nRouting \u306e\u5b9a\u7fa9\n\n\nindex.js\nvar express = require('express');\nvar router = express.Router();\nvar FB = require('fb');\nvar config = require('../config');     // AppID, appSecret, redirectUrl \u5b9a\u7fa9\u6e08\u307f\u3067\u3042\u308b\u3053\u3068\nvar step = require('step');\n\n// Facebook\u30a2\u30d7\u30ea\u306e AppID, APPSecret \u306f\u4e88\u3081\u53d6\u5f97\u3057\u3066 config.js \u306b\u5b9a\u7fa9\u3057\u3066\u304a\u304f\n// config.facebook.redirectUri \u306b \u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u7528\u306e URL \u3092\u5b9a\u7fa9\u3057\u3066\u304a\u304f\n// \u4f8b\u3067\u306f https://example.com/login/callback \u3092\u60f3\u5b9a\u3059\u308b\nFB.options({\n    appId: config.facebook.appId,\n    appSecret: config.facebook.appSecret,\n    redirectUri: config.facebook.redirectUri,\n    version: 'v2.6'\n});\n\n/* GET home page. */\nrouter.get('/', function (req, res, next) {\n    var accessToken = req.session.access_token;\n    if (!accessToken) {\n        res.render('index', {\n            title: 'Facebook Login',\n            // \u5fc5\u8981\u306aScope\u3092\u5b9a\u7fa9\u3057\u3064\u3064\u3001OAuth Login \u7528\u306eURL\u3092\u751f\u6210\u3059\u308b\n            loginUrl: FB.getLoginUrl({scope: ['user_about_me', 'publish_actions', 'user_friends']})\n        });\n    }\n    else {\n        res.render('index');\n    }\n});\n\n\n\u203b \u6ce8\u610f\nCallback\u7528\u306eURL \u306f Facebook\u30a2\u30d7\u30ea\u306e\u30c0\u30c3\u30b7\u30e5\u30dc\u30fc\u30c9 \u2192\u300cFacebook\u30ed\u30b0\u30a4\u30f3\u300d\u2192 \u300c\u6709\u52b9\u306aOAuth\u30ea\u30c0\u30a4\u30ec\u30af\u30c8URI\u300d\u306b\u8a2d\u5b9a\u3057\u3066\u304a\u304f\u3053\u3068\n\nCallback \u306e\u5b9a\u7fa9\n\n\nindex.js\nrouter.get('/login/callback', function (req, res, next) {\n    var code = req.query.code;\n    step(\n        function () {\n            // access token \u53d6\u5f97\n            FB.napi('oauth/access_token', {\n                client_id: FB.options('appId'),\n                client_secret: FB.options('appSecret'),\n                redirect_uri: FB.options('redirectUri'),\n                code: code\n            }, this);\n        },\n        function (err, result) {\n            if (err) throw(err);\n\n            // access token \u306e\u6709\u52b9\u671f\u9650\u3092\u6700\u5927\u307e\u3067\u4f38\u3070\u3059\n            // 2016/9 \u73fe\u5728 60\u65e5 \u306b\u8a2d\u5b9a\u3055\u308c\u308b \uff08\u4eca\u5f8c\u5909\u308f\u308b\u53ef\u80fd\u6027\u304c\u3042\u308b\u305f\u3081\u8981\u8abf\u67fb\uff09\n            FB.napi('oauth/access_token', {\n                client_id: FB.options('appId'),\n                client_secret: FB.options('appSecret'),\n                grant_type: 'fb_exchange_token',\n                fb_exchange_token: result.access_token\n            }, this);\n        },\n        function (err, result) {\n            if (err) throw(err);\n\n            // access token \u3092 Session \u306b\u683c\u7d0d\n            req.session.access_token = result.access_token;\n            req.session.expires = result.expires || 0;\n\n            // \u81ea\u5206\u306e\u540d\u524d\u3068\u3001FacebookID \u53d6\u5f97\n            FB.napi('me', {access_token: req.session.access_token}, this)\n        },\n        function (err, result) {\n            if (err) throw(err);\n            console.log(util.inspect(result));\n\n            // \u4f55\u304b\u6b21\u306e\u753b\u9762\u8868\u793a\n            res.render('NextPage');\n        },\n    );\n});\n\n\n\n\n\u305d\u306e\u4ed6\u3084\u3063\u3066\u307f\u305f\u3053\u3068\n\nAPI \u3067\u8a18\u4e8b\u3092\u6295\u7a3f\u3057\u3066\u307f\u308b\n\u4e0a\u8a18\u3067AccessToken \u53d6\u5f97\u5f8c\u3001\u306a\u306b\u304b\u6295\u7a3f\u3057\u3066\u307f\u308b\n\nindex.js\nrouter.get('/feed', function (req, res, next) {\n    var result_string = [];\n    step(\n        function () {\n            FB.napi('me/feed', 'POST',\n                {\n                    message: 'TEST\u3067\u3059',\n                    access_token: req.session.access_token\n                }, this);\n        },\n        function (err, result) {\n            if (err) throw(err);\n            // \u4f55\u304b\u6b21\u306e\u753b\u9762\n            res.render('NextPage');\n        }\n    )\n});\n\n\n\n\u3053\u308c\u3067\nhttp://example.com/feed\n\n\u3078\u30a2\u30af\u30bb\u3059\u308b\u3068\u3001\u6295\u7a3f\u3055\u308c\u307e\u3059\n# \u80cc\u666f\nNodejs + Express + nodejs-facebook-sdk \u3092\u4f7f\u3063\u3066 OAuth \u8a8d\u8a3c\u3092\u3057\u3066\u307f\u305f\u304b\u3063\u305f\n\n# \u74b0\u5883\n- express-generator \u3092\u4f7f\u3063\u3066 Express \u306e\u30c7\u30d5\u30a9\u30eb\u30c8\u74b0\u5883\u3092\u69cb\u7bc9\u3057\u307e\u3059\u3002\n\n```bash\n$ express fb-test\n$ cd fb-test\n$ npm install\n```\n\n- facebook-node-sdk \u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\n\n```bash\n$ npm install fb --save\n```\n\n# \u753b\u9762\u306a\u3069\n\n- Login\u30ea\u30f3\u30af\u7528\u306e\u753b\u9762\n\n```jade:index.jade\nextends layout\n\nblock content\n    h1= title\n    p Welcome to #{title}\n    a(href=\"#{loginUrl}\") #{loginUrl}\n```\n\n- Routing \u306e\u5b9a\u7fa9\n\n```js:index.js\nvar express = require('express');\nvar router = express.Router();\nvar FB = require('fb');\nvar config = require('../config');     // AppID, appSecret, redirectUrl \u5b9a\u7fa9\u6e08\u307f\u3067\u3042\u308b\u3053\u3068\nvar step = require('step');\n\n// Facebook\u30a2\u30d7\u30ea\u306e AppID, APPSecret \u306f\u4e88\u3081\u53d6\u5f97\u3057\u3066 config.js \u306b\u5b9a\u7fa9\u3057\u3066\u304a\u304f\n// config.facebook.redirectUri \u306b \u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u7528\u306e URL \u3092\u5b9a\u7fa9\u3057\u3066\u304a\u304f\n// \u4f8b\u3067\u306f https://example.com/login/callback \u3092\u60f3\u5b9a\u3059\u308b\nFB.options({\n    appId: config.facebook.appId,\n    appSecret: config.facebook.appSecret,\n    redirectUri: config.facebook.redirectUri,\n    version: 'v2.6'\n});\n\n/* GET home page. */\nrouter.get('/', function (req, res, next) {\n    var accessToken = req.session.access_token;\n    if (!accessToken) {\n        res.render('index', {\n            title: 'Facebook Login',\n            // \u5fc5\u8981\u306aScope\u3092\u5b9a\u7fa9\u3057\u3064\u3064\u3001OAuth Login \u7528\u306eURL\u3092\u751f\u6210\u3059\u308b\n            loginUrl: FB.getLoginUrl({scope: ['user_about_me', 'publish_actions', 'user_friends']})\n        });\n    }\n    else {\n        res.render('index');\n    }\n});\n```\n\n**\u203b \u6ce8\u610f**\nCallback\u7528\u306eURL \u306f Facebook\u30a2\u30d7\u30ea\u306e\u30c0\u30c3\u30b7\u30e5\u30dc\u30fc\u30c9 \u2192\u300cFacebook\u30ed\u30b0\u30a4\u30f3\u300d\u2192 \u300c\u6709\u52b9\u306aOAuth\u30ea\u30c0\u30a4\u30ec\u30af\u30c8URI\u300d\u306b\u8a2d\u5b9a\u3057\u3066\u304a\u304f\u3053\u3068\n\n- Callback \u306e\u5b9a\u7fa9\n\n```js:index.js\nrouter.get('/login/callback', function (req, res, next) {\n    var code = req.query.code;\n    step(\n        function () {\n            // access token \u53d6\u5f97\n            FB.napi('oauth/access_token', {\n                client_id: FB.options('appId'),\n                client_secret: FB.options('appSecret'),\n                redirect_uri: FB.options('redirectUri'),\n                code: code\n            }, this);\n        },\n        function (err, result) {\n            if (err) throw(err);\n\n            // access token \u306e\u6709\u52b9\u671f\u9650\u3092\u6700\u5927\u307e\u3067\u4f38\u3070\u3059\n            // 2016/9 \u73fe\u5728 60\u65e5 \u306b\u8a2d\u5b9a\u3055\u308c\u308b \uff08\u4eca\u5f8c\u5909\u308f\u308b\u53ef\u80fd\u6027\u304c\u3042\u308b\u305f\u3081\u8981\u8abf\u67fb\uff09\n            FB.napi('oauth/access_token', {\n                client_id: FB.options('appId'),\n                client_secret: FB.options('appSecret'),\n                grant_type: 'fb_exchange_token',\n                fb_exchange_token: result.access_token\n            }, this);\n        },\n        function (err, result) {\n            if (err) throw(err);\n\n            // access token \u3092 Session \u306b\u683c\u7d0d\n            req.session.access_token = result.access_token;\n            req.session.expires = result.expires || 0;\n\n            // \u81ea\u5206\u306e\u540d\u524d\u3068\u3001FacebookID \u53d6\u5f97\n            FB.napi('me', {access_token: req.session.access_token}, this)\n        },\n        function (err, result) {\n            if (err) throw(err);\n            console.log(util.inspect(result));\n\n            // \u4f55\u304b\u6b21\u306e\u753b\u9762\u8868\u793a\n            res.render('NextPage');\n        },\n    );\n});\n\n```\n\n# \u305d\u306e\u4ed6\u3084\u3063\u3066\u307f\u305f\u3053\u3068\n## API \u3067\u8a18\u4e8b\u3092\u6295\u7a3f\u3057\u3066\u307f\u308b\n\n\u4e0a\u8a18\u3067AccessToken \u53d6\u5f97\u5f8c\u3001\u306a\u306b\u304b\u6295\u7a3f\u3057\u3066\u307f\u308b\n\n```js:index.js\nrouter.get('/feed', function (req, res, next) {\n    var result_string = [];\n    step(\n        function () {\n            FB.napi('me/feed', 'POST',\n                {\n                    message: 'TEST\u3067\u3059',\n                    access_token: req.session.access_token\n                }, this);\n        },\n        function (err, result) {\n            if (err) throw(err);\n            // \u4f55\u304b\u6b21\u306e\u753b\u9762\n            res.render('NextPage');\n        }\n    )\n});\n\n```\n\n\u3053\u308c\u3067\n\n```text\nhttp://example.com/feed\n```\n\n\u3078\u30a2\u30af\u30bb\u3059\u308b\u3068\u3001\u6295\u7a3f\u3055\u308c\u307e\u3059\n", "tags": ["Node", "Facebook", "GraphAPI", "nodejs"]}