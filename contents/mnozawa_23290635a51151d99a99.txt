{"context": " More than 1 year has passed since last update.\n\n\u30c6\u30fc\u30de\n\u300c\u671f\u9593A\u3068\u671f\u9593B\u3067\u5358\u8a9e\u306e\u51fa\u73fe\u983b\u5ea6\u306e\u5dee\u3092\u7b97\u51fa\u3059\u308b\u300d\n\nif-idf\u7684\u306a\u3053\u3068\u3092\u3084\u308b\u305f\u3081\u306e\u304a\u8a66\u3057\u3068\u3044\u3063\u305f\u611f\u3058\u3067\u3059\n\u51fa\u73fe\u983b\u5ea6\uff1a\u305d\u306e\u5358\u8a9e\u3092\u542b\u3080\u8a18\u4e8b\u6570\n\n\n\u65b9\u91dd\n\nterms aggregation\u3000\u2192\u3000\u5358\u8a9e\u6bce\u306e\u51fa\u73fe\u983b\u5ea6\u3092\u6570\u3048\u308b\nfilter aggregation\u3000\u2192\u3000\u671f\u9593A\u3068\u671f\u9593B\u306b\u5206\u5272\n\nbucket script aggregation\u3000\u2192\u3000\u671f\u9593A\u3068\u671f\u9593B\u3092\u6bd4\u8f03\n\n\n\u8a2d\u5b9a\n\nelasticsearch.yml\nscript.engine.groovy.inline.aggs: on\n\n\n\nquery\n\nbucket-script-agg.json\nGET _search?search_type=count\n{\n  \"query\": {\n    \"match_all\": {}\n  },\n  \"aggs\": { // 1.terms aggregation\n    \"term\": {\n      \"terms\": {\n        \"field\": \"text\",\n        \"size\": 5\n      },\n      \"aggs\": { // 2.filter aggregation\n        \"dateRange1\": { // \u671f\u9593A\n          \"filter\": {\n            \"range\": {\n              \"datetime\": {\n                \"gte\": \"2014-04-01T00:00:00+0900\",\n                \"lte\": \"2014-04-10T23:59:59+0900\"\n              }\n            }\n          }\n        },\n        \"dateRange2\": { // \u671f\u9593B\n          \"filter\": {\n            \"range\": {\n              \"datetime\": {\n                \"gte\": \"2014-04-11T00:00:00+0900\",\n                \"lte\": \"2014-04-20T23:59:59+0900\"\n              }\n            }\n          }\n        },\n        \"tf-idf\": { // \u8a9e\u5f0a\u3042\u308a\n          \"bucket_script\": { // 3.bucket script aggregation\n            \"buckets_path\": {\n              \"range1\": \"dateRange1._count\", //doc_count\u3092\u53d6\u308a\u51fa\u3059\n              \"range2\": \"dateRange2._count\"\n            },\n            \"script\": \"range2 - range1\" //\u7c21\u5358\u306ascript\n          }\n        }\n      }\n    }\n  }\n}\n\n\n\n\u7d50\u679c\n\nresponse.json\n{\n  \"took\": 133,\n  \"timed_out\": false,\n  \"_shards\": {\n    \"total\": 7,\n    \"successful\": 7,\n    \"failed\": 0\n  },\n  \"hits\": {\n    \"total\": 48762,\n    \"max_score\": 0,\n    \"hits\": []\n  },\n  \"aggregations\": {\n    \"term\": {\n      \"doc_count_error_upper_bound\": 6688,\n      \"sum_other_doc_count\": 904138,\n      \"buckets\": [\n        {\n          \"key\": \"\u3044\", // term(analyzer\u306e\u8a2d\u5b9a\u304c\u9069\u5f53\u306a\u306e\u3067\u5909\u306a\u611f\u3058)\n          \"doc_count\": 23490, // hits\u5168\u4f53\u3067\u306e\u4ef6\u6570\n          \"dateRange2\": {\n            \"doc_count\": 7642 // \u671f\u9593A\u3067\u306e\u4ef6\u6570\n          },\n          \"dateRange1\": {\n            \"doc_count\": 8270\u3000// \u671f\u9593B\u3067\u306e\u4ef6\u6570\n          },\n          \"if-idf\": {\n            \"value\": -628 // \u671f\u9593B - \u671f\u9593A \u306e\u7d50\u679c\n          }\n        }\n...\n      ]\n    }\n  }\n}\n\n\n\n\n\u307e\u3068\u3081\u3068\u611f\u60f3\n\n\u304b\u306a\u308a\u67d4\u8edf\u306b\u51e6\u7406\u3092\u66f8\u3051\u305d\u3046\nscript\u3067\u6271\u3046bucket\u306e\u6570\u304c\u7279\u5b9a\u3067\u304d\u306a\u3044\u3068\u4f7f\u3048\u306a\u3044\u3088\u3046\u306a\u6c17\u304c\nbucket\u304b\u3089\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u4ef6\u6570\u3092\u53d6\u308a\u51fa\u3059\u306b\u306f{backet_path}._count\u3092\u4f7f\u3046\n\u3072\u3068\u307e\u305a\u601d\u3063\u305f\u3068\u304a\u308a\u306e\u3053\u3068\u304c\u3067\u304d\u305f\nbucket\u3092\u4efb\u610f\u306e\u6761\u4ef6\u3067filter\u3059\u308baggregation\u306e\u69cb\u60f3\u3082\u3042\u308b\u3089\u3057\u3044\u306e\u3067\u671f\u5f85\n\n\n(20151112\u8ffd\u8a18) bucket selector aggregation\u3068\u8a00\u3046\u306e\u304c\u305d\u308c\u3089\u3057\u3044\n\n\nSense\u304c\u8d85\u4fbf\u5229\n\n\n\u8ab2\u984c\n\n\u671f\u9593A\u3068\u671f\u9593B\u305d\u308c\u305e\u308c\u306e\u5168\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u6570\u3067\u6b63\u898f\u5316\u3059\u308b\u3088\u3046\u306a\u51e6\u7406\u3092\u5165\u308c\u305f\u3044\nterms aggregation\u3068filter aggregation\u306e\u9806\u5e8f\u3092\u9006\u306b\u51fa\u6765\u308b\u3060\u308d\u3046\u304b\n\n\n\u53c2\u8003\n\nhttps://www.elastic.co/guide/en/elasticsearch/reference/master/search-aggregations-pipeline-bucket-script-aggregation.html\nhttps://www.elastic.co/blog/out-of-this-world-aggregations\n\n###\u30c6\u30fc\u30de\n**\u300c\u671f\u9593A\u3068\u671f\u9593B\u3067\u5358\u8a9e\u306e\u51fa\u73fe\u983b\u5ea6\u306e\u5dee\u3092\u7b97\u51fa\u3059\u308b\u300d**\n\n* if-idf\u7684\u306a\u3053\u3068\u3092\u3084\u308b\u305f\u3081\u306e\u304a\u8a66\u3057\u3068\u3044\u3063\u305f\u611f\u3058\u3067\u3059\n* \u51fa\u73fe\u983b\u5ea6\uff1a\u305d\u306e\u5358\u8a9e\u3092\u542b\u3080\u8a18\u4e8b\u6570\n\n###\u65b9\u91dd\n1. terms aggregation\u3000\u2192\u3000\u5358\u8a9e\u6bce\u306e\u51fa\u73fe\u983b\u5ea6\u3092\u6570\u3048\u308b\n2. filter aggregation\u3000\u2192\u3000\u671f\u9593A\u3068\u671f\u9593B\u306b\u5206\u5272\n3. **bucket script aggregation**\u3000\u2192\u3000\u671f\u9593A\u3068\u671f\u9593B\u3092\u6bd4\u8f03\n\n###\u8a2d\u5b9a\n\n```yaml:elasticsearch.yml\nscript.engine.groovy.inline.aggs: on\n```\n\n###query\n\n```json:bucket-script-agg.json\nGET _search?search_type=count\n{\n  \"query\": {\n    \"match_all\": {}\n  },\n  \"aggs\": { // 1.terms aggregation\n    \"term\": {\n      \"terms\": {\n        \"field\": \"text\",\n        \"size\": 5\n      },\n      \"aggs\": { // 2.filter aggregation\n        \"dateRange1\": { // \u671f\u9593A\n          \"filter\": {\n            \"range\": {\n              \"datetime\": {\n                \"gte\": \"2014-04-01T00:00:00+0900\",\n                \"lte\": \"2014-04-10T23:59:59+0900\"\n              }\n            }\n          }\n        },\n        \"dateRange2\": { // \u671f\u9593B\n          \"filter\": {\n            \"range\": {\n              \"datetime\": {\n                \"gte\": \"2014-04-11T00:00:00+0900\",\n                \"lte\": \"2014-04-20T23:59:59+0900\"\n              }\n            }\n          }\n        },\n        \"tf-idf\": { // \u8a9e\u5f0a\u3042\u308a\n          \"bucket_script\": { // 3.bucket script aggregation\n            \"buckets_path\": {\n              \"range1\": \"dateRange1._count\", //doc_count\u3092\u53d6\u308a\u51fa\u3059\n              \"range2\": \"dateRange2._count\"\n            },\n            \"script\": \"range2 - range1\" //\u7c21\u5358\u306ascript\n          }\n        }\n      }\n    }\n  }\n}\n```\n\n###\u7d50\u679c\n\n```json:response.json\n{\n  \"took\": 133,\n  \"timed_out\": false,\n  \"_shards\": {\n    \"total\": 7,\n    \"successful\": 7,\n    \"failed\": 0\n  },\n  \"hits\": {\n    \"total\": 48762,\n    \"max_score\": 0,\n    \"hits\": []\n  },\n  \"aggregations\": {\n    \"term\": {\n      \"doc_count_error_upper_bound\": 6688,\n      \"sum_other_doc_count\": 904138,\n      \"buckets\": [\n        {\n          \"key\": \"\u3044\", // term(analyzer\u306e\u8a2d\u5b9a\u304c\u9069\u5f53\u306a\u306e\u3067\u5909\u306a\u611f\u3058)\n          \"doc_count\": 23490, // hits\u5168\u4f53\u3067\u306e\u4ef6\u6570\n          \"dateRange2\": {\n            \"doc_count\": 7642 // \u671f\u9593A\u3067\u306e\u4ef6\u6570\n          },\n          \"dateRange1\": {\n            \"doc_count\": 8270\u3000// \u671f\u9593B\u3067\u306e\u4ef6\u6570\n          },\n          \"if-idf\": {\n            \"value\": -628 // \u671f\u9593B - \u671f\u9593A \u306e\u7d50\u679c\n          }\n        }\n...\n      ]\n    }\n  }\n}\n\n```\n\n###\u307e\u3068\u3081\u3068\u611f\u60f3\n* \u304b\u306a\u308a\u67d4\u8edf\u306b\u51e6\u7406\u3092\u66f8\u3051\u305d\u3046\n* script\u3067\u6271\u3046bucket\u306e\u6570\u304c\u7279\u5b9a\u3067\u304d\u306a\u3044\u3068\u4f7f\u3048\u306a\u3044\u3088\u3046\u306a\u6c17\u304c\n* bucket\u304b\u3089\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u4ef6\u6570\u3092\u53d6\u308a\u51fa\u3059\u306b\u306f`{backet_path}._count`\u3092\u4f7f\u3046\n* \u3072\u3068\u307e\u305a\u601d\u3063\u305f\u3068\u304a\u308a\u306e\u3053\u3068\u304c\u3067\u304d\u305f\n* bucket\u3092\u4efb\u610f\u306e\u6761\u4ef6\u3067filter\u3059\u308baggregation\u306e\u69cb\u60f3\u3082\u3042\u308b\u3089\u3057\u3044\u306e\u3067\u671f\u5f85\n    * (20151112\u8ffd\u8a18) bucket selector aggregation\u3068\u8a00\u3046\u306e\u304c\u305d\u308c\u3089\u3057\u3044\n* Sense\u304c\u8d85\u4fbf\u5229\n\n\n###\u8ab2\u984c\n* \u671f\u9593A\u3068\u671f\u9593B\u305d\u308c\u305e\u308c\u306e\u5168\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u6570\u3067\u6b63\u898f\u5316\u3059\u308b\u3088\u3046\u306a\u51e6\u7406\u3092\u5165\u308c\u305f\u3044\n* terms aggregation\u3068filter aggregation\u306e\u9806\u5e8f\u3092\u9006\u306b\u51fa\u6765\u308b\u3060\u308d\u3046\u304b\n\n###\u53c2\u8003\n* https://www.elastic.co/guide/en/elasticsearch/reference/master/search-aggregations-pipeline-bucket-script-aggregation.html\n* https://www.elastic.co/blog/out-of-this-world-aggregations\n", "tags": ["Elasticsearch", "Kibana4", "sense"]}