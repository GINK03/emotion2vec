{"context": "\n\n\u6982\u8981\n\u4ee5\u524d\u306e\u6295\u7a3f\u3067\u69cb\u7bc9\u3057\u305f\u306eCentOS7\u306eWeb\u30b5\u30fc\u30d0\u304b\u3089\u3001fluentd\u3092\u4f7f\u3063\u3066Nginx\u306e\u30ed\u30b0\u3092\u53ce\u96c6\u3059\u308b\u3088\u3046\u306b\u8a2d\u5b9a\u3092\u8ffd\u52a0\u3059\u308b\n\n\u69cb\u7bc9\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\n\u25aa\ufe0f 192.168.56.101 \n centos7-admin(\u7ba1\u7406\u30b5\u30fc\u30d0\u30fc)\n itamae\u5b9f\u884c\u30b5\u30fc\u30d0\u30fc\u3068fluentd\u3067\u306e\u30ed\u30b0\u96c6\u7a4d\u30b5\u30fc\u30d0\u30fc\n\u25aa\ufe0f 192.168.56.102\n centos7-web(web\u30b5\u30fc\u30d0\u30fc)\n Nginx\u3092\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u3057\u3066\u3042\u308bweb\u30b5\u30fc\u30d0\u30fc\u3001fluentd\u3067\u30ed\u30b0\u9001\u4fe1\u30b5\u30fc\u30d0\u30fc\u306e\u8a2d\u5b9a\u3092\u8ffd\u52a0\u3059\u308b\n\n\u524d\u6e96\u5099\n\n\nnginx\u306e\u30ed\u30b0\u306e\u30d5\u30a9\u30fc\u30de\u30c3\u30c8\u3092\u5909\u66f4\u3059\u308b\nlog_format     main  '$remote_addr $remote_user [$time_local] \"$request\" '\n                     '$status $body_bytes_sent \"$http_referer\" '\n                     '\"$http_user_agent\" \"$http_x_forwarded_for\" '\n                     '$request_time $upstream_response_time';\n\n\n\nnginx\u306e\u30ed\u30b0\u306e\u540d\u524d\u3001\u30d1\u30b9\u3092\u78ba\u5b9f\u306b\u6307\u5b9a\u3057\u3066\u3044\u304f\naccess_log /var/log/nginx/80.access.log  main;\nerror_log  /var/log/nginx/80.error.log;\n\naccess_log /var/log/nginx/443.access.log  main;\nerror_log  /var/log/nginx/443.error.log;\n\n\n\nnginx\u306e\u30ed\u30b0\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u4ed6\u306e\u30e6\u30fc\u30b6\u30fc\u30a2\u30ab\u30a6\u30f3\u30c8\u3067\u8aad\u3081\u308b\u3088\u3046\u306b\u5909\u66f4\nchmod 655 /var/log/nginx\n\n\n\n\n\u672c\u7de8\n\nfluentd\u306frubygem\u7248\u3067\u306f\u306a\u304f\u3001td\u2212agent\u7248\u3067\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n \u5b9f\u884c\u30e6\u30fc\u30b6\u30fc\u304ctd\u2212agent\u306b\u306a\u308b\u306e\u3067\u3001\u30c7\u30fc\u30bf\u306e\u8aad\u307f\u8fbc\u307f\u30d1\u30fc\u30df\u30c3\u30b7\u30e7\u30f3\u306b\u6ce8\u610f\nnginx\u306e\u30ed\u30b0\u8aad\u307f\u8fbc\u307f\u306f\u3001plugin\u306etail\u2212ex\u3092\u4f7f\u7528\n \u4ee5\u524d\u3001\u691c\u8a3c\u3057\u305f\u969b\u306b\u3001 \u6a19\u6e96\u306etail\u3067\u6e80\u305f\u305b\u306a\u304b\u3063\u305f\u8981\u4ef6\u304ctail\u2212ex\u3067\u6e80\u305f\u305b\u305f\u3068\u3044\u3046\u8a18\u61b6\u304c\u3042\u308a\u3001(\u3069\u3046\u3044\u3046\u8981\u4ef6\u304b\u306f\u5931\u5ff5)tail\u2212ex\u304c\u4f7f\u3044\u52dd\u624b\u304c\u3044\u3044\u6c17\u304c\u3059\u308b\u306e\u3067\u4f7f\u7528\u3059\u308b\u3053\u3068\u306b\u3059\u308b\nplugin\u306ehostname\u3067\u30c7\u30fc\u30bf\u306b\u3082hostname\u3092\u57cb\u3081\u8fbc\u3080\n fluent\u53d6\u5f97\u5148\u3067\u306e\u5229\u7528\u65b9\u91dd\u304c\u307e\u3067\u56fa\u307e\u3063\u3066\u304a\u3089\u305a\u3001tag\u3060\u3051\u3088\u308a\u4f7f\u3044\u52dd\u624b\u3092\u5411\u4e0a\u3055\u305b\u308b\u305f\u3081\u306bhostname\u3092\u4f7f\u7528\u3057\u3066\u3001tag\u3060\u3051\u3067\u306a\u304f\u3001\u30c7\u30fc\u30bf\u306b\u3082hostname\u3092\u8ffd\u52a0\u3059\u308b\nconf\u30d5\u30a1\u30a4\u30eb\u306e\u8a18\u8f09\u65b9\u91dd\u3068\u3057\u3066include\u3092\u4f7f\u7528\u3059\u308b\n 1\u3064\u306e\u30d5\u30a1\u30a4\u30eb\u306b\u5168\u3066\u8a18\u8f09\u3057\u3066\u30d5\u30a1\u30a4\u30eb\u304c\u5927\u304d\u304f\u306a\u308b\u3068\u3001\u7de8\u96c6\u30df\u30b9\u306e\u30ea\u30b9\u30af\u304c\u5897\u3048\u308b\u306e\u3067\u3001\u8a2d\u5b9a\u5358\u4f4d\u30671\u30d5\u30a1\u30a4\u30eb\u3065\u3064\u306b\u5206\u5272\u3057\u3001include\u3057\u3066\u3044\u304f\u3088\u3046\u306b\u3059\u308b\nLAN\u5185\u901a\u4fe1\u306e\u307f\u3092\u524d\u63d0\u3068\u3059\u308b\u306e\u3067\u3001\u901a\u4fe1\u65b9\u6cd5\u3092\u7279\u306b\u51dd\u3089\u306a\u3044\n LAN\u5185\u306e\u53ce\u96c6\u30b5\u30fc\u30d0\u30fc\u3078\u306e\u901a\u4fe1\u306e\u307f\u306a\u306e\u3067\u3001\u6697\u53f7\u5316\u306a\u3069\u8003\u3048\u305a\u5e73\u6587\u901a\u4fe1\u306e\u307e\u307e\u3067OK\u3068\u3059\u308b\n\n\n\u672c\u7a3f\u3067\u4f7f\u7528\u3057\u305f\u30ec\u30b7\u30d4\u306fgithub\u306b\u4e0a\u3052\u3066\u3042\u308b\n\n\u30ea\u30dd\u30b8\u30c8\u30ea\u306e\u8ffd\u52a0\ntreasuredata\u30aa\u30d5\u30a3\u30b7\u30e3\u30eb\u306e\u30ea\u30dd\u30b8\u30c8\u30ea\u306e\u8ffd\u52a0\n\ntd.rb\nexecute \"Add td repo\" do\n    action  :run\n    command \"rpm --import https://packages.treasuredata.com/GPG-KEY-td-agent\"\nend\n\ntemplate \"/etc/yum.repos.d/td.repo\" do\n    action :create\n    owner  \"root\"\n    group  \"root\"\n    mode   \"644\"\n    source \"files/td.repo\"\nend\n\n\n(\u7ba1\u7406\u30b5\u30fc\u30d0\u30fc\u304b\u3089\u5b9f\u884c)\ncd ~/itamae_cookbooks/repos\n\nitamae ssh -u xxx -h 192.168.56.102 -i id_rsa_xxx td.rb\n\n\nfluentd(td-agent)\u306e\u8ffd\u52a0\n\ntd-agent\u306e\u8ffd\u52a0\nplugin\u306e\u8ffd\u52a0\n\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u8a2d\u7f6e\ntd-agent\u306e\u81ea\u52d5\u8d77\u52d5\u8a2d\u5b9a/\u958b\u59cb\n\n\nfluent.rb\npackage \"td-agent\" do\n    action :install\nend\n\n[\n    \"fluent-plugin-hostname\",\n    \"fluent-plugin-tail-ex\",\n].each{| plugin |\n    execute plugin do\n        action  :run\n        command \"/sbin/td-agent-gem install #{plugin}\"\n    end\n}\n\n[\n    \"source.d\",\n    \"match.d\",\n].each{| dir |\n    directory \"/etc/td-agent/#{dir}\" do\n        action :create\n        owner  \"td-agent\"\n        group  \"td-agent\"\n        mode   \"777\"\n    end\n}\n\n[\n    [\"80.access.conf\",             \"/source.d/\"],\n    [\"80.error.conf\",              \"/source.d/\"],\n    [\"443.access.conf\",            \"/source.d/\"],\n    [\"443.error.conf\",             \"/source.d/\"],\n    [\"tcp.conf\",                   \"/source.d/\"],\n    [\"socket.conf\",                \"/source.d/\"],\n    [\"debug.conf\",                 \"/match.d/\" ],\n    [\"hostname.conf\",              \"/match.d/\" ],\n    [\"forward_centos7-admin.conf\", \"/match.d/\" ],\n    [\"td-agent.conf\",              \"/\"        ],\n].each{| file_ary |\n    template \"/etc/td-agent#{file_ary[1]}#{file_ary[0]}\" do\n        action  :create\n        owner   \"td-agent\"\n        group   \"td-agent\"\n        mode    \"644\"\n        source  \"files#{file_ary[1]}#{file_ary[0]}\"\n    end\n}\n\nservice \"td-agent\" do\n    action [:enable, :restart]\nend\n\n\n\n(\u7ba1\u7406\u30b5\u30fc\u30d0\u30fc\u304b\u3089\u5b9f\u884c)\ncd ~/itamae_cookbooks/fluent\n\nitamae ssh -u xxx -h 192.168.56.102 -i id_rsa_xxx fluent.rb\n\n\n\u78ba\u8a8d\u4f5c\u696d\n\n(web\u30b5\u30fc\u30d0\u30fc\u3067)nginx\u306e\u8d77\u52d5\u78ba\u8a8d\n\nps axwww|grep nginx|grep -v grep\n\n#=>  911 ?        Ss     0:00 nginx: master process /usr/sbin/nginx\n#=>  912 ?        S      0:00 nginx: worker process\n#=>  913 ?        S      0:00 nginx: worker process\n#=>  914 ?        S      0:00 nginx: worker process\n#=>  915 ?        S      0:00 nginx: worker process\n\n\n(web\u30b5\u30fc\u30d0\u30fc\u3067)td-agent\u306e\u8d77\u52d5\u78ba\u8a8d\n\nps axwww|grep td-agent|grep -v grep\n\n#=>   1031 ?        Sl     0:00 /opt/td-agent/embedded/bin/ruby /usr/sbin/td-agent --log /var/log/td-agent/td-agent.log --use-v1-config --group td-agent --daemon /var/run/td-agent/td-agent.pid\n#=>   1034 ?        Sl     0:02 /opt/td-agent/embedded/bin/ruby /usr/sbin/td-agent --log /var/log/td-agent/td-agent.log --use-v1-config --group td-agent --daemon /var/run/td-agent/td-agent.pid\n\n\n(web\u30b5\u30fc\u30d0\u30fc\u3067)td-agent\u306e\u8a2d\u5b9a\u78ba\u8a8d\ntd-agent.log\u3092\u78ba\u8a8d\u3059\u308b\ncat /var/log/td-agent/td-agent.log\n\n# fluentd(td-agent)\u306e\u8d77\u52d5\u30ed\u30b0\n2016-09-15 01:29:16 +0900 [info]: starting fluentd-0.12.26\n\n.....\n.....\n\n# \u8ffd\u52a0\u3057\u305f\u30d7\u30e9\u30b0\u30a4\u30f3\u306e\u8aad\u307f\u8fbc\u307f\u72b6\u614b\n2016-09-15 01:29:16 +0900 [info]: gem 'fluent-plugin-hostname' version '0.0.2'\n.....\n\n2016-09-15 01:29:16 +0900 [info]: gem 'fluent-plugin-tail-ex' version '0.1.1'\n\n\uff03 \u8aad\u307f\u8fbc\u3093\u3060\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u30ec\u30b3\u30fc\u30c9\n2016-09-15 01:29:17 +0900 [info]: using configuration file: <ROOT>\n  <source>\n.....\n.....\n  </match>\n</ROOT>\n\n\uff03 tail(tajil\u2212ex)\u3057\u3066\u3044\u308b\u30d5\u30a1\u30a4\u30eb\n2016-09-15 01:29:17 +0900 [info]: following tail of /var/log/nginx/80.access.log\n2016-09-15 01:29:17 +0900 [info]: following tail of /var/log/nginx/80.error.log\n2016-09-15 01:29:17 +0900 [info]: following tail of /var/log/nginx/443.access.log\n2016-09-15 01:29:17 +0900 [info]: following tail of /var/log/nginx/443.error.log\n\n\n\u30d6\u30e9\u30a6\u30b6\u3067\u30a2\u30af\u30bb\u30b9\u3057\u3066\u3001\u53ce\u96c6\u30b5\u30fc\u30d0\u30fc\u5074\u306efluentd\u306b\u30c7\u30fc\u30bf\u304c\u9001\u3089\u308c\u3066\u304f\u308b\u3053\u3068\u3092\u78ba\u8a8d\n\u3068\u308a\u3042\u3048\u305a\u3001\u73fe\u6642\u70b9\u3067\u306e\u53ce\u96c6\u30b5\u30fc\u30d0\u30fc\u5074\u3067\u306e\u6d3b\u7528\u65b9\u6cd5\u306b\u95a2\u3059\u308b\u4ed5\u69d8\u304c\u672a\u5b9a\u306e\u305f\u3081\u3001\u53ce\u96c6\u30b5\u30fc\u30d0\u30fc\u3067\u306f\u3001\u6700\u4f4e\u9650\n\n\n\u5168IP\u304b\u3089\u30dd\u30fc\u30c824224(fluentd\u65e2\u5b9a)\u304b\u3089\u3092\u7121\u6761\u4ef6\u306b\u53d7\u3051\u5165\u308c\u308b\u8a2d\u5b9a\n<source>\n@type forward\nport 24224\nbind \"0.0.0.0\"\n</source>\n\n\n\ntag\u304c *.nginx.** \u306e\u30c7\u30fc\u30bf\u306b\u3064\u3044\u3066\u6a19\u6e96\u51fa\u529b\u306b\u8868\u793a\u3059\u308b\u8a2d\u5b9a\n<match *.nginx.**>\n@type stdout\n</match>\n\n\n\n\u306e\uff12\u3064\u306e\u307f\u8a2d\u5b9a\u3057\u3066 verbose level trace\u3067\u8d77\u52d5\u3057\u306a\u304c\u3089\u6a19\u6e96\u51fa\u529b\u3092\u76e3\u8996\u3059\u308b\n# verbose level trace\nta-agent -vv\n\n#=> 2016-09-15 01:54:40 +0900 addhost.nginx.80.access.centos7-web: {\"remote\":\"192.168.56.1\",\"user\":\"-\",\"method\":\"GET\",\"path\":\"/\",\"code\":\"200\",\"size\":\"612\",\"referer\":\"-\",\"agent\":\"Mozilla/5.0 (Macintosh; Intel Mac OS X 10.11; rv:48.0) Gecko/20100101 Firefox/48.0\",\"http_x_forwarded_for\":\"-\",\"request_time\":\"0.000\",\"upstream_response_time\":\"-\",\"hostname\":\"centos7-web\"}\n.....\n#=> 2016-09-15 01:54:50 +0900 addhost.nginx.80.access.centos7-web: {\"remote\":\"192.168.56.1\",\"user\":\"-\",\"method\":\"GET\",\"path\":\"/auth/\",\"code\":\"200\",\"size\":\"15\",\"referer\":\"-\",\"agent\":\"Mozilla/5.0 (Macintosh; Intel Mac OS X 10.11; rv:48.0) Gecko/20100101 Firefox/48.0\",\"http_x_forwarded_for\":\"-\",\"request_time\":\"0.000\",\"upstream_response_time\":\"-\",\"hostname\":\"centos7-web\"}\n.....\n#=> 2016-09-15 01:56:10 +0900 addhost.nginx.443.access.centos7-web: {\"remote\":\"192.168.56.1\",\"user\":\"ldusr01\",\"method\":\"GET\",\"path\":\"/\",\"code\":\"200\",\"size\":\"19\",\"referer\":\"-\",\"agent\":\"Mozilla/5.0 (Macintosh; Intel Mac OS X 10.11; rv:48.0) Gecko/20100101 Firefox/48.0\",\"http_x_forwarded_for\":\"-\",\"request_time\":\"0.026\",\"upstream_response_time\":\"-\",\"hostname\":\"centos7-web\"}\n\n#\u6982\u8981\n[\u4ee5\u524d\u306e\u6295\u7a3f\u3067\u69cb\u7bc9\u3057\u305f](http://qiita.com/hirotaka-tajiri/items/f7c5797c2840394c321f)\u306eCentOS7\u306eWeb\u30b5\u30fc\u30d0\u304b\u3089\u3001fluentd\u3092\u4f7f\u3063\u3066Nginx\u306e\u30ed\u30b0\u3092\u53ce\u96c6\u3059\u308b\u3088\u3046\u306b\u8a2d\u5b9a\u3092\u8ffd\u52a0\u3059\u308b\n\n#\u69cb\u7bc9\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\n\u25aa\ufe0f 192.168.56.101 \n centos7-admin(\u7ba1\u7406\u30b5\u30fc\u30d0\u30fc)\n itamae\u5b9f\u884c\u30b5\u30fc\u30d0\u30fc\u3068fluentd\u3067\u306e\u30ed\u30b0\u96c6\u7a4d\u30b5\u30fc\u30d0\u30fc\n \n\u25aa\ufe0f 192.168.56.102\n centos7-web(web\u30b5\u30fc\u30d0\u30fc)\n Nginx\u3092\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u3057\u3066\u3042\u308bweb\u30b5\u30fc\u30d0\u30fc\u3001fluentd\u3067\u30ed\u30b0\u9001\u4fe1\u30b5\u30fc\u30d0\u30fc\u306e\u8a2d\u5b9a\u3092\u8ffd\u52a0\u3059\u308b\n\n# \u524d\u6e96\u5099\n- nginx\u306e\u30ed\u30b0\u306e\u30d5\u30a9\u30fc\u30de\u30c3\u30c8\u3092\u5909\u66f4\u3059\u308b\n\n    ```shell\n    log_format     main  '$remote_addr $remote_user [$time_local] \"$request\" '\n                         '$status $body_bytes_sent \"$http_referer\" '\n                         '\"$http_user_agent\" \"$http_x_forwarded_for\" '\n                         '$request_time $upstream_response_time';\n    ```\n\n- nginx\u306e\u30ed\u30b0\u306e\u540d\u524d\u3001\u30d1\u30b9\u3092\u78ba\u5b9f\u306b\u6307\u5b9a\u3057\u3066\u3044\u304f\n\n    ```sh\n    access_log /var/log/nginx/80.access.log  main;\n    error_log  /var/log/nginx/80.error.log;\n\n    access_log /var/log/nginx/443.access.log  main;\n    error_log  /var/log/nginx/443.error.log;\n    ```\n\n- nginx\u306e\u30ed\u30b0\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u4ed6\u306e\u30e6\u30fc\u30b6\u30fc\u30a2\u30ab\u30a6\u30f3\u30c8\u3067\u8aad\u3081\u308b\u3088\u3046\u306b\u5909\u66f4\n\n    ```sh\n    chmod 655 /var/log/nginx\n    ```\n\n# \u672c\u7de8\n\n- fluentd\u306frubygem\u7248\u3067\u306f\u306a\u304f\u3001td\u2212agent\u7248\u3067\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n     \u5b9f\u884c\u30e6\u30fc\u30b6\u30fc\u304ctd\u2212agent\u306b\u306a\u308b\u306e\u3067\u3001\u30c7\u30fc\u30bf\u306e\u8aad\u307f\u8fbc\u307f\u30d1\u30fc\u30df\u30c3\u30b7\u30e7\u30f3\u306b\u6ce8\u610f\n\n\n- nginx\u306e\u30ed\u30b0\u8aad\u307f\u8fbc\u307f\u306f\u3001plugin\u306etail\u2212ex\u3092\u4f7f\u7528\n     \u4ee5\u524d\u3001\u691c\u8a3c\u3057\u305f\u969b\u306b\u3001 \u6a19\u6e96\u306etail\u3067\u6e80\u305f\u305b\u306a\u304b\u3063\u305f\u8981\u4ef6\u304ctail\u2212ex\u3067\u6e80\u305f\u305b\u305f\u3068\u3044\u3046\u8a18\u61b6\u304c\u3042\u308a\u3001(\u3069\u3046\u3044\u3046\u8981\u4ef6\u304b\u306f\u5931\u5ff5)tail\u2212ex\u304c\u4f7f\u3044\u52dd\u624b\u304c\u3044\u3044\u6c17\u304c\u3059\u308b\u306e\u3067\u4f7f\u7528\u3059\u308b\u3053\u3068\u306b\u3059\u308b\n\n\n- plugin\u306ehostname\u3067\u30c7\u30fc\u30bf\u306b\u3082hostname\u3092\u57cb\u3081\u8fbc\u3080\n     fluent\u53d6\u5f97\u5148\u3067\u306e\u5229\u7528\u65b9\u91dd\u304c\u307e\u3067\u56fa\u307e\u3063\u3066\u304a\u3089\u305a\u3001tag\u3060\u3051\u3088\u308a\u4f7f\u3044\u52dd\u624b\u3092\u5411\u4e0a\u3055\u305b\u308b\u305f\u3081\u306bhostname\u3092\u4f7f\u7528\u3057\u3066\u3001tag\u3060\u3051\u3067\u306a\u304f\u3001\u30c7\u30fc\u30bf\u306b\u3082hostname\u3092\u8ffd\u52a0\u3059\u308b\n\n\n- conf\u30d5\u30a1\u30a4\u30eb\u306e\u8a18\u8f09\u65b9\u91dd\u3068\u3057\u3066include\u3092\u4f7f\u7528\u3059\u308b\n     1\u3064\u306e\u30d5\u30a1\u30a4\u30eb\u306b\u5168\u3066\u8a18\u8f09\u3057\u3066\u30d5\u30a1\u30a4\u30eb\u304c\u5927\u304d\u304f\u306a\u308b\u3068\u3001\u7de8\u96c6\u30df\u30b9\u306e\u30ea\u30b9\u30af\u304c\u5897\u3048\u308b\u306e\u3067\u3001\u8a2d\u5b9a\u5358\u4f4d\u30671\u30d5\u30a1\u30a4\u30eb\u3065\u3064\u306b\u5206\u5272\u3057\u3001include\u3057\u3066\u3044\u304f\u3088\u3046\u306b\u3059\u308b\n\n\n- LAN\u5185\u901a\u4fe1\u306e\u307f\u3092\u524d\u63d0\u3068\u3059\u308b\u306e\u3067\u3001\u901a\u4fe1\u65b9\u6cd5\u3092\u7279\u306b\u51dd\u3089\u306a\u3044\n     LAN\u5185\u306e\u53ce\u96c6\u30b5\u30fc\u30d0\u30fc\u3078\u306e\u901a\u4fe1\u306e\u307f\u306a\u306e\u3067\u3001\u6697\u53f7\u5316\u306a\u3069\u8003\u3048\u305a\u5e73\u6587\u901a\u4fe1\u306e\u307e\u307e\u3067OK\u3068\u3059\u308b\n\n----\n\n[\u672c\u7a3f\u3067\u4f7f\u7528\u3057\u305f\u30ec\u30b7\u30d4\u306fgithub\u306b\u4e0a\u3052\u3066\u3042\u308b](https://github.com/hirotaka-tajiri/itamae_cookbooks)\n\n## \u30ea\u30dd\u30b8\u30c8\u30ea\u306e\u8ffd\u52a0\n\ntreasuredata\u30aa\u30d5\u30a3\u30b7\u30e3\u30eb\u306e\u30ea\u30dd\u30b8\u30c8\u30ea\u306e\u8ffd\u52a0\n\n```rb:td.rb\nexecute \"Add td repo\" do\n    action  :run\n    command \"rpm --import https://packages.treasuredata.com/GPG-KEY-td-agent\"\nend\n\ntemplate \"/etc/yum.repos.d/td.repo\" do\n    action :create\n    owner  \"root\"\n    group  \"root\"\n    mode   \"644\"\n    source \"files/td.repo\"\nend\n```\n(\u7ba1\u7406\u30b5\u30fc\u30d0\u30fc\u304b\u3089\u5b9f\u884c)\n\n```shell-session\ncd ~/itamae_cookbooks/repos\n\nitamae ssh -u xxx -h 192.168.56.102 -i id_rsa_xxx td.rb\n```\n\n## fluentd(td-agent)\u306e\u8ffd\u52a0\n\n0. td-agent\u306e\u8ffd\u52a0\n0. plugin\u306e\u8ffd\u52a0\n0. \u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u8a2d\u7f6e\n0. td-agent\u306e\u81ea\u52d5\u8d77\u52d5\u8a2d\u5b9a/\u958b\u59cb\n\n```rb:fluent.rb\npackage \"td-agent\" do\n    action :install\nend\n\n[\n    \"fluent-plugin-hostname\",\n    \"fluent-plugin-tail-ex\",\n].each{| plugin |\n    execute plugin do\n        action  :run\n        command \"/sbin/td-agent-gem install #{plugin}\"\n    end\n}\n\n[\n    \"source.d\",\n    \"match.d\",\n].each{| dir |\n    directory \"/etc/td-agent/#{dir}\" do\n        action :create\n        owner  \"td-agent\"\n        group  \"td-agent\"\n        mode   \"777\"\n    end\n}\n\n[\n    [\"80.access.conf\",             \"/source.d/\"],\n    [\"80.error.conf\",              \"/source.d/\"],\n    [\"443.access.conf\",            \"/source.d/\"],\n    [\"443.error.conf\",             \"/source.d/\"],\n    [\"tcp.conf\",                   \"/source.d/\"],\n    [\"socket.conf\",                \"/source.d/\"],\n    [\"debug.conf\",                 \"/match.d/\" ],\n    [\"hostname.conf\",              \"/match.d/\" ],\n    [\"forward_centos7-admin.conf\", \"/match.d/\" ],\n    [\"td-agent.conf\",              \"/\"        ],\n].each{| file_ary |\n    template \"/etc/td-agent#{file_ary[1]}#{file_ary[0]}\" do\n        action  :create\n        owner   \"td-agent\"\n        group   \"td-agent\"\n        mode    \"644\"\n        source  \"files#{file_ary[1]}#{file_ary[0]}\"\n    end\n}\n\nservice \"td-agent\" do\n    action [:enable, :restart]\nend\n\n```\n(\u7ba1\u7406\u30b5\u30fc\u30d0\u30fc\u304b\u3089\u5b9f\u884c)\n\n```shell-session\ncd ~/itamae_cookbooks/fluent\n\nitamae ssh -u xxx -h 192.168.56.102 -i id_rsa_xxx fluent.rb\n```\n\n\n# \u78ba\u8a8d\u4f5c\u696d\n\n## (web\u30b5\u30fc\u30d0\u30fc\u3067)nginx\u306e\u8d77\u52d5\u78ba\u8a8d\n\n```shell-session\n\nps axwww|grep nginx|grep -v grep\n\n#=>  911 ?        Ss     0:00 nginx: master process /usr/sbin/nginx\n#=>  912 ?        S      0:00 nginx: worker process\n#=>  913 ?        S      0:00 nginx: worker process\n#=>  914 ?        S      0:00 nginx: worker process\n#=>  915 ?        S      0:00 nginx: worker process\n```\n\n## (web\u30b5\u30fc\u30d0\u30fc\u3067)td-agent\u306e\u8d77\u52d5\u78ba\u8a8d\n\n```shell-session\n\nps axwww|grep td-agent|grep -v grep\n\n#=>   1031 ?        Sl     0:00 /opt/td-agent/embedded/bin/ruby /usr/sbin/td-agent --log /var/log/td-agent/td-agent.log --use-v1-config --group td-agent --daemon /var/run/td-agent/td-agent.pid\n#=>   1034 ?        Sl     0:02 /opt/td-agent/embedded/bin/ruby /usr/sbin/td-agent --log /var/log/td-agent/td-agent.log --use-v1-config --group td-agent --daemon /var/run/td-agent/td-agent.pid\n```\n\n## (web\u30b5\u30fc\u30d0\u30fc\u3067)td-agent\u306e\u8a2d\u5b9a\u78ba\u8a8d\n\ntd-agent.log\u3092\u78ba\u8a8d\u3059\u308b\n\n```shell-session\ncat /var/log/td-agent/td-agent.log\n\n# fluentd(td-agent)\u306e\u8d77\u52d5\u30ed\u30b0\n2016-09-15 01:29:16 +0900 [info]: starting fluentd-0.12.26\n\n.....\n.....\n\n# \u8ffd\u52a0\u3057\u305f\u30d7\u30e9\u30b0\u30a4\u30f3\u306e\u8aad\u307f\u8fbc\u307f\u72b6\u614b\n2016-09-15 01:29:16 +0900 [info]: gem 'fluent-plugin-hostname' version '0.0.2'\n.....\n\n2016-09-15 01:29:16 +0900 [info]: gem 'fluent-plugin-tail-ex' version '0.1.1'\n\n\uff03 \u8aad\u307f\u8fbc\u3093\u3060\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u30ec\u30b3\u30fc\u30c9\n2016-09-15 01:29:17 +0900 [info]: using configuration file: <ROOT>\n  <source>\n.....\n.....\n  </match>\n</ROOT>\n\n\uff03 tail(tajil\u2212ex)\u3057\u3066\u3044\u308b\u30d5\u30a1\u30a4\u30eb\n2016-09-15 01:29:17 +0900 [info]: following tail of /var/log/nginx/80.access.log\n2016-09-15 01:29:17 +0900 [info]: following tail of /var/log/nginx/80.error.log\n2016-09-15 01:29:17 +0900 [info]: following tail of /var/log/nginx/443.access.log\n2016-09-15 01:29:17 +0900 [info]: following tail of /var/log/nginx/443.error.log\n```\n\n## \u30d6\u30e9\u30a6\u30b6\u3067\u30a2\u30af\u30bb\u30b9\u3057\u3066\u3001\u53ce\u96c6\u30b5\u30fc\u30d0\u30fc\u5074\u306efluentd\u306b\u30c7\u30fc\u30bf\u304c\u9001\u3089\u308c\u3066\u304f\u308b\u3053\u3068\u3092\u78ba\u8a8d\n\n\u3068\u308a\u3042\u3048\u305a\u3001\u73fe\u6642\u70b9\u3067\u306e\u53ce\u96c6\u30b5\u30fc\u30d0\u30fc\u5074\u3067\u306e\u6d3b\u7528\u65b9\u6cd5\u306b\u95a2\u3059\u308b\u4ed5\u69d8\u304c\u672a\u5b9a\u306e\u305f\u3081\u3001\u53ce\u96c6\u30b5\u30fc\u30d0\u30fc\u3067\u306f\u3001\u6700\u4f4e\u9650\n\n- \u5168IP\u304b\u3089\u30dd\u30fc\u30c824224(fluentd\u65e2\u5b9a)\u304b\u3089\u3092\u7121\u6761\u4ef6\u306b\u53d7\u3051\u5165\u308c\u308b\u8a2d\u5b9a\n\n    ```shell-session\n  <source>\n    @type forward\n    port 24224\n    bind \"0.0.0.0\"\n  </source>\n    ```\n\n- tag\u304c \\*.nginx.\\*\\* \u306e\u30c7\u30fc\u30bf\u306b\u3064\u3044\u3066\u6a19\u6e96\u51fa\u529b\u306b\u8868\u793a\u3059\u308b\u8a2d\u5b9a\n\n    ```shell-session\n  <match *.nginx.**>\n    @type stdout\n  </match>\n    ````\n\n\u306e\uff12\u3064\u306e\u307f\u8a2d\u5b9a\u3057\u3066 verbose level trace\u3067\u8d77\u52d5\u3057\u306a\u304c\u3089\u6a19\u6e96\u51fa\u529b\u3092\u76e3\u8996\u3059\u308b\n\n```shell-session\n# verbose level trace\nta-agent -vv\n\n#=> 2016-09-15 01:54:40 +0900 addhost.nginx.80.access.centos7-web: {\"remote\":\"192.168.56.1\",\"user\":\"-\",\"method\":\"GET\",\"path\":\"/\",\"code\":\"200\",\"size\":\"612\",\"referer\":\"-\",\"agent\":\"Mozilla/5.0 (Macintosh; Intel Mac OS X 10.11; rv:48.0) Gecko/20100101 Firefox/48.0\",\"http_x_forwarded_for\":\"-\",\"request_time\":\"0.000\",\"upstream_response_time\":\"-\",\"hostname\":\"centos7-web\"}\n.....\n#=> 2016-09-15 01:54:50 +0900 addhost.nginx.80.access.centos7-web: {\"remote\":\"192.168.56.1\",\"user\":\"-\",\"method\":\"GET\",\"path\":\"/auth/\",\"code\":\"200\",\"size\":\"15\",\"referer\":\"-\",\"agent\":\"Mozilla/5.0 (Macintosh; Intel Mac OS X 10.11; rv:48.0) Gecko/20100101 Firefox/48.0\",\"http_x_forwarded_for\":\"-\",\"request_time\":\"0.000\",\"upstream_response_time\":\"-\",\"hostname\":\"centos7-web\"}\n.....\n#=> 2016-09-15 01:56:10 +0900 addhost.nginx.443.access.centos7-web: {\"remote\":\"192.168.56.1\",\"user\":\"ldusr01\",\"method\":\"GET\",\"path\":\"/\",\"code\":\"200\",\"size\":\"19\",\"referer\":\"-\",\"agent\":\"Mozilla/5.0 (Macintosh; Intel Mac OS X 10.11; rv:48.0) Gecko/20100101 Firefox/48.0\",\"http_x_forwarded_for\":\"-\",\"request_time\":\"0.026\",\"upstream_response_time\":\"-\",\"hostname\":\"centos7-web\"}\n```\n", "tags": ["itamae", "nginx", "fluentd", "td-agent", "centos7"]}