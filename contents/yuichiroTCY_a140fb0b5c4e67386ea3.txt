{"context": " More than 1 year has passed since last update.FuelPHP\u306e\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u306e\u30e6\u30cb\u30c3\u30c8\u30c6\u30b9\u30c8\u306e\u66f8\u304d\u65b9\u306f\nfuelPHP\u3067PHPUnit\u3092\u4f7f\u3063\u305f\u30e6\u30cb\u30c3\u30c8\u30fb\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u30fc\u30c6\u30b9\u30c8\u3092\u3059\u308b\u306b\u306f\n\u306a\u3069\u306b\u8a18\u4e8b\u304c\u3042\u308a\u307e\u3059\u304c\uff0c\n\u305d\u308c\u306b\u52a0\u3048\u3066\n\nAuth\u30d1\u30c3\u30b1\u30fc\u30b8\u306b\u3088\u308b\u8a8d\u8a3c\u3082\u542b\u3081\u305f\u30c6\u30b9\u30c8\n\nRequest::is_hmvc()\u304c\u6b63\u3057\u304f\u52d5\u304b\u306a\u3044\u554f\u984c\u306e\u89e3\u6c7a\n\nResponse::redirect()\u3067 exit\u3057\u3066\u3057\u307e\u3046\u554f\u984c\u306e\u89e3\u6c7a\uff08\u4e0a\u8a18\u8a18\u4e8b\u306b\u3082\u3042\u308a\u307e\u3059\u304c\uff0c\u5225\u89e3\u3092\uff09\n\u30c6\u30b9\u30c8\u3060\u3068Asset\u30af\u30e9\u30b9\u306e\u30e1\u30bd\u30c3\u30c9\u304c\u3046\u307e\u304f\u52d5\u304b\u306a\u3044\u554f\u984c\u306e\u89e3\u6c7a\uff08\u4e0a\u8a18\u8a18\u4e8b\u306b\u3082\u3042\u308a\u307e\u3059\u304c\uff0c\u3053\u308c\u3082\u5225\u89e3\u3092\uff09\n\n\u3092\u3059\u308b\u305f\u3081\u306e\u4f8b\u3092\u66f8\u3053\u3046\u3068\u601d\u3044\u307e\u3059\uff0e\n\u4eca\u56de\u306fAspect Mock\u3092\u4f7f\u3044\u307e\u3059\uff0e\nAspeck Mock\u3092\u4f7f\u3063\u305fFuelPHP\u306e\u30c6\u30b9\u30c8\u306f\nAspectMock\u3067FuelPHP\u306e\u30a2\u30d7\u30ea\u3092100\uff05\u30c6\u30b9\u30c8\u53ef\u80fd\u306b\u3059\u308b\n\u306b\u8a73\u3057\u3044\u8a18\u4e8b\u304c\u3042\u308a\u307e\u3059\uff0e\n\n\u4e0b\u6e96\u5099\n\n\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\nFuelPHP\u3067\u65b0\u3057\u3044\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u3092\u4f5c\u308a\uff0csimpleauth\u3092\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\uff0e\n\u307e\u305f\uff0c\nphp oil g admin entity name:varchar[255]\n\n\u3067\u7ba1\u7406\u753b\u9762\u3092\u4f5c\u3063\u3066\u304a\u304f\uff0e\u3053\u306e\u7ba1\u7406\u753b\u9762\u306e\u30c6\u30b9\u30c8\u3092\u4f8b\u306b\u3057\u3066\u66f8\u3044\u3066\u3044\u304f\uff0e\n\uff08\u8a8d\u8a3c\u30da\u30fc\u30b8\u304c\u4f8b\u3068\u3057\u3066\u6b32\u3057\u304b\u3063\u305f\u3060\u3051\u3067\u3042\u3063\u3066\uff0c\u4eca\u56deCRUD\u7b49\u306f\u4f7f\u308f\u306a\u3044\uff09\n\nPHPUnit\u306e\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\nphp composer.phar require phpunit/phpunit=4.6.*\n\n\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3068\u30d6\u30fc\u30c8\u30b9\u30c8\u30e9\u30c3\u30d7\u3092\u30b3\u30d4\u30fc\ncp fuel/core/bootstrap_phpunit.php fuel/app/.\ncp fuel/core/phpunit.xml fuel/app/.\n\nfuel/app/phpunit.xml\u3092\u7de8\u96c6\n\nfuel/app/phpunit.xml\n- <phpunit colors=\"true\" stopOnFailure=\"false\" bootstrap=\"../core/bootstrap_phpunit.php\">\n+ <phpunit colors=\"true\" stopOnFailure=\"false\" bootstrap=\"../app/bootstrap_phpunit.php\">\n\n\n\u30c6\u30b9\u30c8\u304c\u8d70\u308b\u3053\u3068\u3092\u78ba\u8a8d\nphp oil test\n\n\nAspect Mock \u306e\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\nhttp://blog.a-way-out.net/blog/2013/12/09/fuelphp-aspectmock/\n\u3092\u53c2\u8003\u306bAspect Mock\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\uff0e\nphp composer.phar require codeception/aspect-mock=*\n\n\u4e0a\u8a18\u30b5\u30a4\u30c8\u3067\u306fbootstrap_phpunit.php\u306e\u66f8\u304d\u63db\u3048\u304c\u6307\u793a\u3055\u308c\u3066\u3044\u308b\u304c\uff0c\u6700\u65b0\u7248\u306eFuelPHP\u306ebootstrap_phpunit.php\u306f\u306f\u3058\u3081\u304b\u3089Aspect Mock\u5bfe\u5fdc\u306e\u3088\u3046\n\n\u30c8\u30e9\u30d6\u30eb\nAspect Mock\u3092\u5165\u308c\u305f\u3089\nphp oil test\n\n\u3067\u5168\u3066\u306e\u30c6\u30b9\u30c8\u30b1\u30fc\u30b9\u306b\u5bfe\u3057\u3066\nException: Serialization of 'Closure' is not allowed\n\u304c\u51fa\u308b\u3088\u3046\u306b\u306a\u3063\u3066\u3057\u307e\u3063\u305f\uff0e\nhttps://github.com/Codeception/AspectMock/issues/1#issuecomment-21446411\n\u306b\u89e3\u6c7a\u304c\u8f09\u3063\u3066\u3044\u305f\uff0e\nfuel/app/phpunit.xml\u3092\u7de8\u96c6\n\nfuel/app/phpunit.xml\n- <phpunit colors=\"true\" stopOnFailure=\"false\" bootstrap=\"../app/bootstrap_phpunit.php\">\n+ <phpunit colors=\"true\" stopOnFailure=\"false\" bootstrap=\"../app/bootstrap_phpunit.php\" backupGlobals=\"false\">\n\n\n\n\u30c0\u30df\u30fc\u30c7\u30fc\u30bf\u3092\u4f7f\u3063\u3066Auth\u30d1\u30c3\u30b1\u30fc\u30b8\u306b\u3088\u308b\u8a8d\u8a3c\u30da\u30fc\u30b8\u3092\u30c6\u30b9\u30c8\u3059\u308b\uff0e\nController_Admin::action_index()\u306e\u30c6\u30b9\u30c8\u3092\u3064\u304f\u308b\uff0e\n\nfuel/app/tests/controller/admin.php\n<?php\n\nuse AspectMock\\Test as test;\n\n/**\n * @group Controller\n */\nclass Test_Controller_Admin extends \\TestCase\n{\n    public function test_action_index_logged_in()\n    {\n        $response = \\Request::forge('admin/index')->execute()->response();\n    }\n}\n\n\n\u3053\u308c\u3067\u30c6\u30b9\u30c8\u3092\u5b9f\u884c\u3059\u308b\u3068\u9014\u4e2d\u7d42\u4e86\u3057\u3066\u3057\u307e\u3046\uff0e\n\u3053\u308c\u306f\uff0c\u30ed\u30b0\u30a2\u30a6\u30c8\u72b6\u614b\u3067admin/index\u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3068admin/login\u3078\u30ea\u30c0\u30a4\u30ec\u30af\u30c8\u3055\u308c\u308b\u51e6\u7406\u306b\u306a\u3063\u3066\u3044\u3066\uff0c\nResponse::redirect()\u306e\u4e2d\u3067exit\u3057\u3066\u3044\u308b\u304b\u3089\uff0e\nResponse::redirect()\u306eexit\u3092\u6b63\u3057\u304f\u30c6\u30b9\u30c8\u3059\u308b\u65b9\u6cd5\u306f\u5f8c\u8ff0\u3059\u308b\u304c\uff0c\n\u3053\u3053\u3067\u306f\u30ed\u30b0\u30a4\u30f3\u72b6\u614b\u306e\u30a2\u30af\u30bb\u30b9\u3092\u30b7\u30df\u30e5\u30ec\u30fc\u30c8\u3057\u3066\u6b63\u3057\u304f\u30c6\u30b9\u30c8\u304c\u901a\u308b\u3088\u3046\u306b\u3057\u3066\u307f\u308b\uff0e\n\u307e\u305a\uff0cAuth_Login_Simpleauth\u3092\u7d99\u627f\u3057\u305f\u30af\u30e9\u30b9\u3067validate_user()\u3068create_login_hash()\u3092\u30aa\u30fc\u30d0\u30fc\u30e9\u30a4\u30c9\uff0e\nvalidate_user()\u306f\u30c0\u30df\u30fc\u306e\u30e6\u30fc\u30b6\u30fc\u30c7\u30fc\u30bf\u3092\u751f\u6210\u3059\u308b\u305f\u3081\uff0e\ncreate_login_hash()\u306fDB\u3078\u306e\u30a2\u30af\u30bb\u30b9\u304c\u3042\u308b\u305f\u3081\uff0c\u30aa\u30fc\u30d0\u30fc\u30e9\u30a4\u30c9\u3057\u3066DB\u30a2\u30af\u30bb\u30b9\u90e8\u5206\u3060\u3051\u6d88\u3057\u305f\uff0e\n\nfuel/classes/testcase/auth/login/simpleauth.php\n<?php\nclass Auth_Login_Simpleauth extends \\Auth\\Auth_Login_Simpleauth\n{\n    /**\n     * Check the user exists\n     *\n     * @return  bool\n     */\n    public function validate_user($username_or_email = '', $password = '')\n    {\n        switch ($username_or_email)\n        {\n            case 'admin':\n                return array(\n                    'id' => 1,\n                    'username' => 'admin',\n                    'email' => 'admin@example.com',\n                    'group' => 100,\n                );\n            break;\n\n            default:\n                return false;\n        }\n    }\n\n\n    /**\n     * Creates a temporary hash that will validate the current login\n     *\n     * @return  string\n     */\n    public function create_login_hash()\n    {\n        if (empty($this->user))\n        {\n            throw new \\SimpleUserUpdateException('User not logged in, can\\'t create login hash.', 10);\n        }\n\n        $last_login = \\Date::forge()->get_timestamp();\n        $login_hash = sha1(\\Config::get('simpleauth.login_hash_salt').$this->user['username'].$last_login);\n\n        $this->user['login_hash'] = $login_hash;\n\n        return $login_hash;\n    }\n}\n\n\n\u3053\u306e\u30af\u30e9\u30b9\u3092Simpleauth\u306e\u30ed\u30b0\u30a4\u30f3\u30c9\u30e9\u30a4\u30d0\u3068\u3057\u3066\u4f7f\u3046\u305f\u3081\u8a2d\u5b9a\uff0e\u30c6\u30b9\u30c8\u306e\u6642\u3060\u3051\u8aad\u307f\u8fbc\u307e\u308c\u308b\u3088\u3046\uff0cbootstrap_phpunit.php\u306b\u8ffd\u8a18\uff0e\n\nfuel/app/bootstrap_phpunit.php\n// Boot the app\nrequire_once APPPATH.'bootstrap.php';\n+\n+ Autoloader::add_classes(array(\n+   'Auth_Login_Simpleauth' => APPPATH.'classes/testcase/auth/login/simpleauth.php',\n+ ));\n\n// Set test mode\nFuel::$is_test = true;\n\n\n\u3053\u308c\u3067\uff0cSimpleauth\u30ed\u30b0\u30a4\u30f3\u30c9\u30e9\u30a4\u30d0\u3067\u30c0\u30df\u30fc\u30c7\u30fc\u30bf\u3067\u30ed\u30b0\u30a4\u30f3\u3067\u304d\u308b\uff0e\n\u30c6\u30b9\u30c8\u30b1\u30fc\u30b9\u3092\u4fee\u6b63\u3059\u308b\uff0e\n\nfuel/tests/controller/admin.php\n<?php\n\nuse AspectMock\\Test as test;\n\n/**\n * @group Controller\n */\nclass Test_Controller_Admin extends \\TestCase\n{\n    protected function tearDown() {\n        \\Auth::logout();\n        test::clean();\n    }\n\n    public function test_action_index_logged_in()\n    {\n        $admin_user = \\Model_User::forge(array(\n            'id' => 1,\n            'username' => 'admin',\n            'email' => 'admin@example.com',\n            'group' => 100,\n        ));\n        test::double('Model_User', array('find_by_username' => $admin_user));\n\n        \\Auth::login('admin');\n\n        $response = \\Request::forge('admin/index')->execute()->response();\n    }\n}\n\n\n\u3053\u3053\u3067\uff0c\\Auth::login('admin');\u304c\u30c0\u30df\u30fc\u30c7\u30fc\u30bf\u306b\u3088\u308b\u30ed\u30b0\u30a4\u30f3\uff0e\n\u3053\u308c\u3067fuel/classes/testcase/auth/login/simpleauth.php\u3067\u30aa\u30fc\u30d0\u30fc\u30e9\u30a4\u30c9\u3057\u305fAuth_Login_Simpleauth::validate_user()\u304c\u6700\u7d42\u7684\u306b\u547c\u3070\u308c\uff0c\u305d\u3053\u3067\u751f\u6210\u3057\u3066\u3044\u308b\u30c0\u30df\u30fc\u30c7\u30fc\u30bf\u304c\u30ed\u30b0\u30a4\u30f3\u30c9\u30e9\u30a4\u30d0\u306b\u30ed\u30b0\u30a4\u30f3\u4e2d\u30e6\u30fc\u30b6\u30fc\u3068\u3057\u3066\u30bb\u30c3\u30c8\u3055\u308c\u308b\uff0e\n\u3053\u3046\u3057\u3066\u3057\u307e\u3048\u3070\u5f8c\u306fAuth::check()\u3084Auth::member, Auth::has_access\u306a\u3069\u304c\u30c0\u30df\u30fc\u30c7\u30fc\u30bf\u3092\u57fa\u306b\u6b63\u3057\u304f\u632f\u308b\u821e\u3046\u3088\u3046\u306b\u306a\u308b\uff0e\n\n        $admin_user = \\Model_User::forge(array(\n            'id' => 1,\n            'username' => 'admin',\n            'email' => 'admin@example.com',\n            'group' => 100,\n        ));\n        test::double('Model_User', array('find_by_username' => $admin_user));\n\n\n\u306e\u90e8\u5206\u306f\u30ed\u30b0\u30a4\u30f3\u306e\u30a8\u30df\u30e5\u30ec\u30fc\u30c8\u3068\u306f\u76f4\u63a5\u95a2\u4fc2\u306a\u3044\u304c\uff0c\nController_Base\u3067\nModel_User::find_by_username(Auth::get_screen_name()) \u304c\u547c\u3070\u308c\u3066\u3044\u308b\u306e\u3067\uff0c\n\u3053\u3053\u3067Auth_Login_Simpleauth::validate_user()\u3067\u751f\u6210\u3057\u3066\u3044\u308b\u30c0\u30df\u30fc\u30c7\u30fc\u30bf\u3068\u540c\u3058\u7269\u3092\u8fd4\u3059\u3088\u3046\u306b\nAspeckMock\u3067\u8a2d\u5b9a\u3057\u3066\u3044\u308b\uff0e\n\u30c6\u30b9\u30c8\u30b1\u30fc\u30b9\u7d42\u4e86\u6642\u306b\u30ed\u30b0\u30a2\u30a6\u30c8\u3068AspectMock\u306e\u30ea\u30bb\u30c3\u30c8\u3092\u3057\u3066\u5f8c\u7247\u4ed8\u3051\u7d42\u4e86\uff0e\n\n    protected function tearDown() {\n        \\Auth::logout();\n        test::clean();\n    }\n\n\n\u4ee5\u4e0a\u3067Simpleauth\u306e\u8a8d\u8a3c\u3092\u30a8\u30df\u30e5\u30ec\u30fc\u30c8\u3067\u304d\u305f\uff0e\n\nResponse::redirect() \u306e exit \u3092\u56de\u907f\u3059\u308b\nResponse::redirect()\u306f\u5185\u90e8\u3067exit\u3057\u3066\u304a\u308a\uff0c\u3053\u306e\u307e\u307e\u30c6\u30b9\u30c8\u3059\u308b\u3068\u9014\u4e2d\u7d42\u4e86\u3057\u3066\u3057\u307e\u3046\uff0e\nfuelPHP\u3067PHPUnit\u3092\u4f7f\u3063\u305f\u30e6\u30cb\u30c3\u30c8\u30fb\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u30fc\u30c6\u30b9\u30c8\u3092\u3059\u308b\u306b\u306f\n\u306b\u3053\u306e\u554f\u984c\u3078\u306e\u89e3\u6c7a\u304c\u3042\u308b\u304c\uff0c\u3053\u3053\u3067\u306f\u5c11\u3057\u5909\u3048\u3066\u4f8b\u5916\u3092\u4f7f\u3063\u305f\u5bfe\u51e6\u6cd5\u3092\u4e0e\u3048\u308b\uff0e\n\u30ed\u30b0\u30a2\u30a6\u30c8\u72b6\u614b\u3067admin/index\u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u30c6\u30b9\u30c8\u30b1\u30fc\u30b9\u3092\u8ffd\u52a0\u3059\u308b\uff0e\n\nfuel/tests/controller/admin.php\n<?php\n\nuse AspectMock\\Test as test;\n\n/**\n * @group Controller\n */\nclass Test_Controller_Admin extends \\TestCase\n{\n    protected function tearDown() {\n        \\Auth::logout();\n        test::clean();\n    }\n\n    public function test_action_index_logged_in()\n    {\n        $admin_user = \\Model_User::forge(array(\n            'id' => 1,\n            'username' => 'admin',\n            'email' => 'admin@example.com',\n            'group' => 100,\n        ));\n        test::double('Model_User', array('find_by_username' => $admin_user));\n        \\Auth::login('admin');\n        $response = \\Request::forge('admin/index')->execute()->response();\n    }\n\n    public function test_action_index_logged_out()\n    {\n        \\Auth::logout();\n        $response = \\Request::forge('admin/index')->execute()->response();\n    }\n}\n\n\n\u30ed\u30b0\u30a2\u30a6\u30c8\u72b6\u614b\u3067\u306eadmin/index\u3078\u306e\u30a2\u30af\u30bb\u30b9\u306f\uff0c\u4e0a\u3067\u8ff0\u3079\u305f\u3068\u304a\u308a\uff0cadmin/login\u306b\u30ea\u30c0\u30a4\u30ec\u30af\u30c8\u3055\u308c\u308b\u306f\u305a\uff0e\n$ php oil test --group=Controller\nTests Running...This may take a few moments.\n....\n\n\u30c6\u30b9\u30c8\u3092\u5b9f\u884c\u3057\u3066\u307f\u308b\u3068\uff0c\u3084\u306f\u308a\u9014\u4e2d\u3067\u7d42\u4e86\u3057\u3066\u3057\u307e\u3063\u305f\uff0e\n\u30c6\u30b9\u30c8\u30b1\u30fc\u30b9\u3092\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u4fee\u6b63\u3059\u308b\uff0e\n\nfuel/app/tests/controller/admin.php\n<?php\n\nuse AspectMock\\Test as test;\n\nclass TestRedirectException extends \\Exception\n{}\n\n/**\n * @group Controller\n */\nclass Test_Controller_Admin extends \\TestCase\n{\n    protected function tearDown() {\n        \\Auth::logout();\n        test::clean();\n    }\n\n    public function test_action_index_logged_in()\n    {\n        $admin_user = \\Model_User::forge(array(\n            'id' => 1,\n            'username' => 'admin',\n            'email' => 'admin@example.com',\n            'group' => 100,\n        ));\n        test::double('Model_User', array('find_by_username' => $admin_user));\n        \\Auth::login('admin');\n        $response = \\Request::forge('admin/index')->execute()->response();\n    }\n\n    /**\n     * @expectedException TestRedirectException\n     * @expectedExceptionMessage admin/login:location:302\n     */\n    public function test_action_index_logged_out()\n    {\n        test::double('Fuel\\Core\\Response', array(\n            'redirect' => function($url = '', $method = 'location', $code = 302){\n                throw new TestRedirectException(sprintf('%s:%s:%s', $url, $method, $code));\n            }\n        ));\n        \\Auth::logout();\n        $response = \\Request::forge('admin/index')->execute()->response();\n    }\n}\n\n\n\u30ad\u30e2\u306f\n\n        test::double('Fuel\\Core\\Response', array(\n            'redirect' => function($url = '', $method = 'location', $code = 302){\n                throw new TestRedirectException(sprintf('%s:%s:%s', $url, $method, $code));\n            }\n        ));\n\n\n\u3053\u308c\u3067\uff0cResponse::redirect()\u306e\u547c\u3073\u51fa\u3057\u3092AspectMock\u306b\u3088\u3063\u3066\u4e0a\u66f8\u304d\u3057\u3066\u3044\u308b\uff0e\nResponse::redirect()\u304c\u547c\u3070\u308c\u308b\u3068\uff0c\u4f8b\u5916TestRedirectException\u304c\u30b9\u30ed\u30fc\u3055\u308c\u308b\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u308b\uff0e\nTestRedirectException\u306e\u30e1\u30c3\u30bb\u30fc\u30b8\u306b\u306fResponse::redirect()\u306e\u5f15\u6570$url,$method,$code\u304c\u5165\u308b\u306e\u3067\uff0c\n@expectedExceptionMessage\u30a2\u30ce\u30c6\u30fc\u30b7\u30e7\u30f3\u3067\u30ea\u30c0\u30a4\u30ec\u30af\u30c8\u5148\u3084\u30b9\u30c6\u30fc\u30bf\u30b9\u30b3\u30fc\u30c9\u3082\u30c1\u30a7\u30c3\u30af\u3067\u304d\u308b\uff0e\n\u4ee5\u4e0a\u3067Response::redirect()\u3092\u542b\u3080\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u3092\u30c6\u30b9\u30c8\u53ef\u80fd\u306b\u306a\u3063\u305f\uff0e\n\n\u307e\u3068\u3081\u308b\n\u4ee5\u4e0a\uff0c\u8a8d\u8a3c\u306e\u30a8\u30df\u30e5\u30ec\u30fc\u30c8\u3068Response::redirect()\u306eexit\u56de\u907f\u306e\u30b3\u30fc\u30c9\u3092\u66f8\u3044\u3066\u304d\u305f\u304c\uff0c\n\u4e00\u3064\u306e\u57fa\u5e95\u30af\u30e9\u30b9\u306b\u307e\u3068\u3081\u3066\u3057\u307e\u3046\u3068\u4f7f\u3044\u52dd\u624b\u304c\u3088\u3044\uff0e\n\nfuel/app/classes/testcase/controller.php\n<?php\nuse AspectMock\\Test as test;\n\nclass TestRedirectException extends \\Exception\n{}\n\nclass TestCase_Controller extends \\TestCase\n{\n    protected function setup()\n    {\n        test::double('Fuel\\Core\\Response', array(\n            'redirect' => function($url = '', $method = 'location', $code = 302){\n                throw new TestRedirectException(sprintf('%s:%s:%s', $url, $method, $code));\n            }\n        ));\n    }\n\n    protected function tearDown()\n    {\n        \\Auth::logout();\n        test::clean();\n    }\n\n    protected function emulate_logged_in()\n    {\n        $admin_user = \\Model_User::forge(array(\n            'id' => 1,\n            'username' => 'admin',\n            'email' => 'admin@example.com',\n            'group' => 100,\n        ));\n        test::double('Model_User', array('find_by_username' => $admin_user));\n        \\Auth::login('admin');\n    }\n\n    protected function emulate_logged_out()\n    {\n        \\Auth::logout();\n    }\n}\n\n\n\nfuel/app/tests/controller/admin.php\n<?php\n\n/**\n * @group Controller\n */\nclass Test_Controller_Admin extends TestCase_Controller\n{\n    public function test_action_index_logged_in()\n    {\n        $this->emulate_logged_in();\n        $response = \\Request::forge('admin/index')->execute()->response();\n    }\n\n    /**\n     * @expectedException TestRedirectException\n     * @expectedExceptionMessage admin/login:location:302\n     */\n    public function test_action_index_logged_out()\n    {\n        $this->emulate_logged_out();\n        $response = \\Request::forge('admin/index')->execute()->response();\n    }\n}\n\n\n\nfuel/app/bootstrap_phpunit.php\nAutoloader::add_classes(array(\n    'Auth_Login_Simpleauth' => APPPATH.'classes/testcase/auth/login/simpleauth.php',\n+   'TestCase_Controller' => APPPATH.'classes/testcase/controller.php',\n+   'TestRedirectException' => APPPATH.'classes/testcase/controller.php',\n));\n\n\n\n\u5225\u306e\u30b0\u30eb\u30fc\u30d7\u306e\u30e6\u30fc\u30b6\u30fc\u3092\u8ffd\u52a0\u3057\u3066\u307f\u308b\nadmin\u4ee5\u5916\u306e\u30e6\u30fc\u30b6\u30fc\u3067\u30ed\u30b0\u30a4\u30f3\u3059\u308b\u3068\uff0c/\u306b\u30ea\u30c0\u30a4\u30ec\u30af\u30c8\u3055\u308c\u308b\uff0e\n\u3053\u308c\u3092\u30c6\u30b9\u30c8\u3057\u3066\u307f\u308b\uff0e\nSimpleauth\u306e\u30ed\u30b0\u30a4\u30f3\u30c9\u30e9\u30a4\u30d0\u306evalidate_user()\u306b\u5225\u306e\u30e6\u30fc\u30b6\u30fc\u30bf\u30a4\u30d7\u306e\u30c0\u30df\u30fc\u30c7\u30fc\u30bf\u3092\u8ffd\u52a0\u3059\u308b\n\nfuel/app/classes/testcase/auth/login/simpleauth.php\n    public function validate_user($username_or_email = '', $password = '')\n    {\n        switch ($username_or_email)\n        {\n            case 'admin':\n                return array(\n                    'id' => 1,\n                    'username' => 'admin',\n                    'email' => 'admin@example.com',\n                    'group' => 100,\n                );\n            break;\n\n            case 'user':\n                return array(\n                    'id' => 2,\n                    'username' => 'user',\n                    'email' => 'user@example.com',\n                    'group' => 1,\n                );\n            break;\n\n            default:\n                return false;\n        }\n    }\n\n\nemulate_logged_in()\u3092\u8907\u6570\u30e6\u30fc\u30b6\u30fc\u30bf\u30a4\u30d7\u306b\u5bfe\u5fdc\u3055\u305b\u308b\uff0e\n\nfuel/app/classes/testcase/controller.php\n    protected function emulate_logged_in($usertype = '')\n    {\n        switch ($usertype)\n        {\n            case 'admin':\n                \\Auth::login('admin');\n                $user = \\Model_User::forge(array(\n                    'id' => 1,\n                    'username' => 'admin',\n                    'email' => 'admin@example.com',\n                    'group' => 100,\n                ));\n            break;\n\n            case 'user':\n                \\Auth::login('user');\n                $user = \\Model_User::forge(array(\n                    'id' => 2,\n                    'username' => 'user',\n                    'email' => 'user@example.com',\n                    'group' => 1,\n                ));\n            break;\n\n            default:\n                $user = null;\n        }\n        test::double('Model_User', array('find_by_username' => $user));\n    }\n}\n\n\n\u3053\u308c\u3089\u3092\u4f7f\u3063\u3066\u30c6\u30b9\u30c8\u30b1\u30fc\u30b9\u3092\u4fee\u6b63\uff06\u8ffd\u52a0\n\nfuel/app/tests/controller/admin.php\n<?php\n\n/**\n * @group Controller\n */\nclass Test_Controller_Admin extends TestCase_Controller\n{\n    public function test_action_index_logged_in()\n    {\n        $this->emulate_logged_in('admin');\n        $response = \\Request::forge('admin/index')->execute()->response();\n    }\n\n    /**\n     * @expectedException TestRedirectException\n     * @expectedExceptionMessage /:location:302\n     */\n    public function test_action_index_logged_in_invalid_auth()\n    {\n        $this->emulate_logged_in('user');\n        $response = \\Request::forge('admin/index')->execute()->response();\n    }\n\n    /**\n     * @expectedException TestRedirectException\n     * @expectedExceptionMessage admin/login:location:302\n     */\n    public function test_action_index_logged_out()\n    {\n        $this->emulate_logged_out();\n        $response = \\Request::forge('admin/index')->execute()->response();\n    }\n}\n\n\n\nRequest::is_hmvc() \u3092\u6b63\u3057\u304f\u6a5f\u80fd\u3055\u305b\u308b\uff0e\nRequest::is_hmvc()\u304c\u30c6\u30b9\u30c8\u3067\u306f\u3046\u307e\u304f\u6a5f\u80fd\u3057\u306a\u3044\uff0e\n\u30b5\u30f3\u30d7\u30eb\u3068\u306a\u308b\u30c6\u30b9\u30c8\u30b1\u30fc\u30b9\u306f\u793a\u3055\u306a\u3044\u304c\uff0c\nprotected function setup() {\n    test::double('Fuel\\\\Core\\\\Request', array(\n        'is_hmvc' => function() {\n            return \\Request::active() !== \\Request::main();\n        }\n    ));\n\n    \\Request::reset_request(true);\n}\n\n\u3068\u3059\u308b\u3053\u3068\u3067\u6b63\u3057\u304f\u6a5f\u80fd\u3055\u305b\u308b\u3053\u3068\u304c\u3067\u304d\u308b\uff0e\nRequest::is_hmvc()\u306e\u30aa\u30ea\u30b8\u30ca\u30eb\u306f\n\nfuel/core/classes/request.php\n    public static function is_hmvc()\n    {\n        return ((\\Fuel::$is_cli and static::main()) or static::active() !== static::main());\n    }\n\n\n\u3068\u306a\u3063\u3066\u3044\u3066\uff0c\u30c6\u30b9\u30c8\u6642\u306f\\Fuel::$is_cli = true\u3068\u306a\u3063\u3066\u3057\u307e\u3046\u305f\u3081\uff0e\nAspectMock\u3067\u3053\u306e\u6761\u4ef6\u5f0f\u304c\u7121\u3044\u3082\u306e\u306b\u66f8\u304d\u63db\u3048\u3066\u3044\u308b\uff0e\n\u307e\u305f\uff0cRequest::reset_request(true);\u3059\u308b\u3053\u3068\u3067\uff0cRequest::$main\u3092null\u306b\u3057\u3066\u3044\u308b\uff0e\n\u3053\u308c\u3092\u3057\u306a\u3044\u3068\uff0c\u524d\u56de\u306e\u30c6\u30b9\u30c8\u30b1\u30fc\u30b9\u3067Request::forge()\u3057\u305f\u3068\u304d\u306eRequest::$main\u304c\u6b8b\u3063\u3066\u3057\u307e\u3044\uff0c\n\uff12\u3064\u76ee\u4ee5\u964d\u306eRequest::is_hmvc()\u304c\u6b63\u3057\u304f\u52d5\u304b\u306a\u304f\u306a\u308b\uff0e\n\n\u3055\u3089\u306b\u307e\u3068\u3081\u308b\uff08\u6700\u7d42\u7248\uff09\n\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u30c6\u30b9\u30c8\u306e\u305f\u3081\u306e\u57fa\u5e95\u30c6\u30b9\u30c8\u30b1\u30fc\u30b9\u30af\u30e9\u30b9\u6700\u7d42\u7248\uff0e\n\nfuel/classes/testcase/controller.php\n<?php\nuse AspectMock\\Test as test;\n\nclass TestRedirectException extends \\Exception\n{}\n\nclass TestCase_Controller extends \\TestCase\n{\n    protected function setup()\n    {\n        // Response::redirect()\u306eexit\u3092\u56de\u907f\u3059\u308b\uff0e\n        test::double('Fuel\\Core\\Response', array(\n            'redirect' => function($url = '', $method = 'location', $code = 302){\n                throw new TestRedirectException(sprintf('%s:%s:%s', $url, $method, $code));\n            }\n        ));\n\n        // \u672c\u7269\u306eRequest::is_hmvc()\u306f \\Fuel::$is_cli and static::main() \u6761\u4ef6\u304c\u3042\u3063\u3066cli\u304b\u3089\u5b9f\u884c\u3059\u308btest\u3060\u3068true\u306b\u306a\u3063\u3066\u3057\u307e\u3046\u306e\u3067\uff0c\u305d\u306e\u6761\u4ef6\u3092\u5916\u3059\u305f\u3081\u306b\u7f6e\u304d\u63db\u3048\u308b\n        test::double('Fuel\\\\Core\\\\Request', array(\n            'is_hmvc' => function() {\n                return \\Request::active() !== \\Request::main();\n            }\n        ));\n\n        // Request\u3092\u30ea\u30bb\u30c3\u30c8\u3057\u306a\u3044\u3068\\Request::$main\u304c\u6b8b\u3063\u305f\u307e\u307e\u306b\u306a\u3063\u3066\uff12\u5ea6\u76ee\u4ee5\u964d\u306e\\Request::forge()\u304b\u3089\u306e\\Request::is_hmvc()\u3067\u554f\u984c\u306b\u306a\u308b\n        \\Request::reset_request(true);\n\n        chdir('public');\n    }\n\n    protected function tearDown()\n    {\n        \\Auth::logout();\n        test::clean();\n    }\n\n    protected function emulate_logged_in($usertype = '')\n    {\n        switch ($usertype)\n        {\n            case 'admin':\n                \\Auth::login('admin');\n                $user = \\Model_User::forge(array(\n                    'id' => 1,\n                    'username' => 'admin',\n                    'email' => 'admin@example.com',\n                    'group' => 100,\n                ));\n            break;\n\n            case 'user':\n                \\Auth::login('user');\n                $user = \\Model_User::forge(array(\n                    'id' => 2,\n                    'username' => 'user',\n                    'email' => 'user@example.com',\n                    'group' => 1,\n                ));\n            break;\n\n            default:\n                $user = null;\n        }\n        test::double('Model_User', array('find_by_username' => $user));\n    }\n\n    protected function emulate_logged_out()\n    {\n        \\Auth::logout();\n    }\n}\n\n\n\u4eca\u307e\u3067\u8aac\u660e\u3057\u305f\n* \u8a8d\u8a3c\u30b7\u30df\u30e5\u30ec\u30fc\u30c8\n* Response::redirect()\u306eexit\u56de\u907f\n* Request::is_hmvc()\u306e\u8aa4\u52d5\u4f5c\u56de\u907f\n\u3092\u307e\u3068\u3081\u305f\uff0e\n\nAsset\u5bfe\u5fdc\n\u307e\u305f\uff0cAsset::img\u306a\u3069\u3092\u6b63\u3057\u304f\u52d5\u4f5c\u3055\u305b\u308b\u305f\u3081\u306bchdir('public')\u3082\u8ffd\u52a0\u3055\u308c\u3066\u3044\u308b\uff0e\nWeb\u30da\u30fc\u30b8\u3068\u3057\u3066\u95b2\u89a7\u3059\u308b\u3068\u304d\u306f\u6700\u521d\u306b/public/index.php\u3078\u30a2\u30af\u30bb\u30b9\u3059\u308b\u305f\u3081\uff0cAsset_Instance::find_file()\u5185\u306eis_file\u304c\u30d5\u30a1\u30a4\u30eb\u3092\u63a2\u3059\u8d77\u70b9\u304c/public\u306a\u306e\u306b\u5bfe\u3057\uff0c\u30c6\u30b9\u30c8\u6642\u306f/\u3092\u8d77\u70b9\u306b\u30d5\u30a1\u30a4\u30eb\u3092\u63a2\u305d\u3046\u3068\u3059\u308b\u305f\u3081\uff0cchdir('public')\u3057\u3066\u304a\u304b\u306a\u3044\u3068Could not find asset: ~~~\u3068\u30a8\u30e9\u30fc\u306b\u306a\u308b\uff0e\n\n\u305d\u306e\u4ed6\n\n\u3053\u306e\u4f8b\u3067\u306ffuel/app/classes/testcase/auth\u4ee5\u4e0b\u306bSimpleauth\u306e\u62e1\u5f35\u30af\u30e9\u30b9\u3092\u7f6e\u3044\u3066\u3057\u307e\u3063\u3066\u3044\u308b\uff0e\nbootstrap_phpunit.php\u3067Autoloader\u3092\u3061\u3083\u3093\u3068\u8a2d\u5b9a\u3057\u3066\u3044\u308b\u306e\u3067\u52d5\u304f\u304c\uff0c\u547d\u540d\u898f\u5247\u7684\u306b\u3088\u308d\u3057\u304f\u306a\u3044\u6c17\u304c\u3059\u308b\uff0e\n\u30c6\u30b9\u30c8\u3067\u3057\u304b\u4f7f\u308f\u306a\u3044\u306e\u3067fuel/app/classes/testcase\u4ee5\u4e0b\u306b\u307e\u3068\u3081\u3066\u3057\u307e\u3044\u305f\u304b\u3063\u305f\u306e\u3060\u304c\u2026\n\u3053\u306e\u8a18\u4e8b\u3067\u4f5c\u6210\u3057\u305f\u30b3\u30fc\u30c9\u306f https://github.com/yuichiroTCY/fuel-controller-test \u306b\u7f6e\u3044\u3066\u3042\u308a\u307e\u3059\uff0e\n\nFuelPHP\u306e\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u306e\u30e6\u30cb\u30c3\u30c8\u30c6\u30b9\u30c8\u306e\u66f8\u304d\u65b9\u306f\n[fuelPHP\u3067PHPUnit\u3092\u4f7f\u3063\u305f\u30e6\u30cb\u30c3\u30c8\u30fb\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u30fc\u30c6\u30b9\u30c8\u3092\u3059\u308b\u306b\u306f](http://qiita.com/masahikoofjoyto/items/206e6f8d5b0aa7126678)\n\u306a\u3069\u306b\u8a18\u4e8b\u304c\u3042\u308a\u307e\u3059\u304c\uff0c\n\u305d\u308c\u306b\u52a0\u3048\u3066\n\n- Auth\u30d1\u30c3\u30b1\u30fc\u30b8\u306b\u3088\u308b\u8a8d\u8a3c\u3082\u542b\u3081\u305f\u30c6\u30b9\u30c8\n- `Request::is_hmvc()`\u304c\u6b63\u3057\u304f\u52d5\u304b\u306a\u3044\u554f\u984c\u306e\u89e3\u6c7a\n- `Response::redirect()`\u3067 exit\u3057\u3066\u3057\u307e\u3046\u554f\u984c\u306e\u89e3\u6c7a\uff08\u4e0a\u8a18\u8a18\u4e8b\u306b\u3082\u3042\u308a\u307e\u3059\u304c\uff0c\u5225\u89e3\u3092\uff09\n- \u30c6\u30b9\u30c8\u3060\u3068`Asset`\u30af\u30e9\u30b9\u306e\u30e1\u30bd\u30c3\u30c9\u304c\u3046\u307e\u304f\u52d5\u304b\u306a\u3044\u554f\u984c\u306e\u89e3\u6c7a\uff08\u4e0a\u8a18\u8a18\u4e8b\u306b\u3082\u3042\u308a\u307e\u3059\u304c\uff0c\u3053\u308c\u3082\u5225\u89e3\u3092\uff09\n\n\u3092\u3059\u308b\u305f\u3081\u306e\u4f8b\u3092\u66f8\u3053\u3046\u3068\u601d\u3044\u307e\u3059\uff0e\n\n\u4eca\u56de\u306fAspect Mock\u3092\u4f7f\u3044\u307e\u3059\uff0e\nAspeck Mock\u3092\u4f7f\u3063\u305fFuelPHP\u306e\u30c6\u30b9\u30c8\u306f\n[AspectMock\u3067FuelPHP\u306e\u30a2\u30d7\u30ea\u3092100\uff05\u30c6\u30b9\u30c8\u53ef\u80fd\u306b\u3059\u308b](http://blog.a-way-out.net/blog/2013/12/09/fuelphp-aspectmock/)\n\u306b\u8a73\u3057\u3044\u8a18\u4e8b\u304c\u3042\u308a\u307e\u3059\uff0e\n\n# \u4e0b\u6e96\u5099\n## \u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\nFuelPHP\u3067\u65b0\u3057\u3044\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u3092\u4f5c\u308a\uff0csimpleauth\u3092\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\uff0e\n\u307e\u305f\uff0c\n\n```bash\nphp oil g admin entity name:varchar[255]\n```\n\n\u3067\u7ba1\u7406\u753b\u9762\u3092\u4f5c\u3063\u3066\u304a\u304f\uff0e\u3053\u306e\u7ba1\u7406\u753b\u9762\u306e\u30c6\u30b9\u30c8\u3092\u4f8b\u306b\u3057\u3066\u66f8\u3044\u3066\u3044\u304f\uff0e\n\uff08\u8a8d\u8a3c\u30da\u30fc\u30b8\u304c\u4f8b\u3068\u3057\u3066\u6b32\u3057\u304b\u3063\u305f\u3060\u3051\u3067\u3042\u3063\u3066\uff0c\u4eca\u56deCRUD\u7b49\u306f\u4f7f\u308f\u306a\u3044\uff09\n\n## PHPUnit\u306e\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\n\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n```bash\nphp composer.phar require phpunit/phpunit=4.6.*\n```\n\n\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3068\u30d6\u30fc\u30c8\u30b9\u30c8\u30e9\u30c3\u30d7\u3092\u30b3\u30d4\u30fc\n\n```bash\ncp fuel/core/bootstrap_phpunit.php fuel/app/.\ncp fuel/core/phpunit.xml fuel/app/.\n```\n\nfuel/app/phpunit.xml\u3092\u7de8\u96c6\n\n```diff:fuel/app/phpunit.xml\n- <phpunit colors=\"true\" stopOnFailure=\"false\" bootstrap=\"../core/bootstrap_phpunit.php\">\n+ <phpunit colors=\"true\" stopOnFailure=\"false\" bootstrap=\"../app/bootstrap_phpunit.php\">\n```\n\n\n\u30c6\u30b9\u30c8\u304c\u8d70\u308b\u3053\u3068\u3092\u78ba\u8a8d\n\n```bash\nphp oil test\n```\n\n## Aspect Mock \u306e\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\nhttp://blog.a-way-out.net/blog/2013/12/09/fuelphp-aspectmock/\n\u3092\u53c2\u8003\u306bAspect Mock\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\uff0e\n\n```bash\nphp composer.phar require codeception/aspect-mock=*\n```\n\n\u4e0a\u8a18\u30b5\u30a4\u30c8\u3067\u306fbootstrap_phpunit.php\u306e\u66f8\u304d\u63db\u3048\u304c\u6307\u793a\u3055\u308c\u3066\u3044\u308b\u304c\uff0c\u6700\u65b0\u7248\u306eFuelPHP\u306ebootstrap_phpunit.php\u306f\u306f\u3058\u3081\u304b\u3089Aspect Mock\u5bfe\u5fdc\u306e\u3088\u3046\n\n#### \u30c8\u30e9\u30d6\u30eb\nAspect Mock\u3092\u5165\u308c\u305f\u3089\n\n```bash\nphp oil test\n```\n\u3067\u5168\u3066\u306e\u30c6\u30b9\u30c8\u30b1\u30fc\u30b9\u306b\u5bfe\u3057\u3066\n`Exception: Serialization of 'Closure' is not allowed`\n\u304c\u51fa\u308b\u3088\u3046\u306b\u306a\u3063\u3066\u3057\u307e\u3063\u305f\uff0e\nhttps://github.com/Codeception/AspectMock/issues/1#issuecomment-21446411\n\u306b\u89e3\u6c7a\u304c\u8f09\u3063\u3066\u3044\u305f\uff0e\nfuel/app/phpunit.xml\u3092\u7de8\u96c6\n\n```diff:fuel/app/phpunit.xml\n- <phpunit colors=\"true\" stopOnFailure=\"false\" bootstrap=\"../app/bootstrap_phpunit.php\">\n+ <phpunit colors=\"true\" stopOnFailure=\"false\" bootstrap=\"../app/bootstrap_phpunit.php\" backupGlobals=\"false\">\n```\n\n# \u30c0\u30df\u30fc\u30c7\u30fc\u30bf\u3092\u4f7f\u3063\u3066Auth\u30d1\u30c3\u30b1\u30fc\u30b8\u306b\u3088\u308b\u8a8d\u8a3c\u30da\u30fc\u30b8\u3092\u30c6\u30b9\u30c8\u3059\u308b\uff0e\n\n`Controller_Admin::action_index()`\u306e\u30c6\u30b9\u30c8\u3092\u3064\u304f\u308b\uff0e\n\n```php:fuel/app/tests/controller/admin.php\n<?php\n\nuse AspectMock\\Test as test;\n\n/**\n * @group Controller\n */\nclass Test_Controller_Admin extends \\TestCase\n{\n\tpublic function test_action_index_logged_in()\n\t{\n\t\t$response = \\Request::forge('admin/index')->execute()->response();\n\t}\n}\n```\n\n\u3053\u308c\u3067\u30c6\u30b9\u30c8\u3092\u5b9f\u884c\u3059\u308b\u3068\u9014\u4e2d\u7d42\u4e86\u3057\u3066\u3057\u307e\u3046\uff0e\n\u3053\u308c\u306f\uff0c\u30ed\u30b0\u30a2\u30a6\u30c8\u72b6\u614b\u3067admin/index\u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3068admin/login\u3078\u30ea\u30c0\u30a4\u30ec\u30af\u30c8\u3055\u308c\u308b\u51e6\u7406\u306b\u306a\u3063\u3066\u3044\u3066\uff0c\nResponse::redirect()\u306e\u4e2d\u3067exit\u3057\u3066\u3044\u308b\u304b\u3089\uff0e\nResponse::redirect()\u306eexit\u3092\u6b63\u3057\u304f\u30c6\u30b9\u30c8\u3059\u308b\u65b9\u6cd5\u306f\u5f8c\u8ff0\u3059\u308b\u304c\uff0c\n\u3053\u3053\u3067\u306f\u30ed\u30b0\u30a4\u30f3\u72b6\u614b\u306e\u30a2\u30af\u30bb\u30b9\u3092\u30b7\u30df\u30e5\u30ec\u30fc\u30c8\u3057\u3066\u6b63\u3057\u304f\u30c6\u30b9\u30c8\u304c\u901a\u308b\u3088\u3046\u306b\u3057\u3066\u307f\u308b\uff0e\n\n\u307e\u305a\uff0cAuth_Login_Simpleauth\u3092\u7d99\u627f\u3057\u305f\u30af\u30e9\u30b9\u3067validate_user()\u3068create_login_hash()\u3092\u30aa\u30fc\u30d0\u30fc\u30e9\u30a4\u30c9\uff0e\nvalidate_user()\u306f\u30c0\u30df\u30fc\u306e\u30e6\u30fc\u30b6\u30fc\u30c7\u30fc\u30bf\u3092\u751f\u6210\u3059\u308b\u305f\u3081\uff0e\ncreate_login_hash()\u306fDB\u3078\u306e\u30a2\u30af\u30bb\u30b9\u304c\u3042\u308b\u305f\u3081\uff0c\u30aa\u30fc\u30d0\u30fc\u30e9\u30a4\u30c9\u3057\u3066DB\u30a2\u30af\u30bb\u30b9\u90e8\u5206\u3060\u3051\u6d88\u3057\u305f\uff0e\n\n```php:fuel/classes/testcase/auth/login/simpleauth.php\n<?php\nclass Auth_Login_Simpleauth extends \\Auth\\Auth_Login_Simpleauth\n{\n\t/**\n\t * Check the user exists\n\t *\n\t * @return  bool\n\t */\n\tpublic function validate_user($username_or_email = '', $password = '')\n\t{\n\t\tswitch ($username_or_email)\n\t\t{\n\t\t\tcase 'admin':\n\t\t\t\treturn array(\n\t\t\t\t\t'id' => 1,\n\t\t\t\t\t'username' => 'admin',\n\t\t\t\t\t'email' => 'admin@example.com',\n\t\t\t\t\t'group' => 100,\n\t\t\t\t);\n\t\t\tbreak;\n\t\t\n\t\t\tdefault:\n\t\t\t\treturn false;\n\t\t}\n\t}\n\t\n\t\n\t/**\n\t * Creates a temporary hash that will validate the current login\n\t *\n\t * @return  string\n\t */\n\tpublic function create_login_hash()\n\t{\n\t\tif (empty($this->user))\n\t\t{\n\t\t\tthrow new \\SimpleUserUpdateException('User not logged in, can\\'t create login hash.', 10);\n\t\t}\n\n\t\t$last_login = \\Date::forge()->get_timestamp();\n\t\t$login_hash = sha1(\\Config::get('simpleauth.login_hash_salt').$this->user['username'].$last_login);\n\n\t\t$this->user['login_hash'] = $login_hash;\n\n\t\treturn $login_hash;\n\t}\n}\n```\n\n\u3053\u306e\u30af\u30e9\u30b9\u3092Simpleauth\u306e\u30ed\u30b0\u30a4\u30f3\u30c9\u30e9\u30a4\u30d0\u3068\u3057\u3066\u4f7f\u3046\u305f\u3081\u8a2d\u5b9a\uff0e\u30c6\u30b9\u30c8\u306e\u6642\u3060\u3051\u8aad\u307f\u8fbc\u307e\u308c\u308b\u3088\u3046\uff0cbootstrap_phpunit.php\u306b\u8ffd\u8a18\uff0e\n\n```diff:fuel/app/bootstrap_phpunit.php\n// Boot the app\nrequire_once APPPATH.'bootstrap.php';\n+\n+ Autoloader::add_classes(array(\n+ \t'Auth_Login_Simpleauth' => APPPATH.'classes/testcase/auth/login/simpleauth.php',\n+ ));\n\n// Set test mode\nFuel::$is_test = true;\n```\n\n\u3053\u308c\u3067\uff0cSimpleauth\u30ed\u30b0\u30a4\u30f3\u30c9\u30e9\u30a4\u30d0\u3067\u30c0\u30df\u30fc\u30c7\u30fc\u30bf\u3067\u30ed\u30b0\u30a4\u30f3\u3067\u304d\u308b\uff0e\n\n\u30c6\u30b9\u30c8\u30b1\u30fc\u30b9\u3092\u4fee\u6b63\u3059\u308b\uff0e\n\n```php:fuel/tests/controller/admin.php\n<?php\n\nuse AspectMock\\Test as test;\n\n/**\n * @group Controller\n */\nclass Test_Controller_Admin extends \\TestCase\n{\n\tprotected function tearDown() {\n\t\t\\Auth::logout();\n\t\ttest::clean();\n\t}\n\n\tpublic function test_action_index_logged_in()\n\t{\n\t\t$admin_user = \\Model_User::forge(array(\n\t\t\t'id' => 1,\n\t\t\t'username' => 'admin',\n\t\t\t'email' => 'admin@example.com',\n\t\t\t'group' => 100,\n\t\t));\n\t\ttest::double('Model_User', array('find_by_username' => $admin_user));\n\n\t\t\\Auth::login('admin');\n\n\t\t$response = \\Request::forge('admin/index')->execute()->response();\n\t}\n}\n```\n\u3053\u3053\u3067\uff0c`\\Auth::login('admin');`\u304c\u30c0\u30df\u30fc\u30c7\u30fc\u30bf\u306b\u3088\u308b\u30ed\u30b0\u30a4\u30f3\uff0e\n\u3053\u308c\u3067`fuel/classes/testcase/auth/login/simpleauth.php`\u3067\u30aa\u30fc\u30d0\u30fc\u30e9\u30a4\u30c9\u3057\u305f`Auth_Login_Simpleauth::validate_user()`\u304c\u6700\u7d42\u7684\u306b\u547c\u3070\u308c\uff0c\u305d\u3053\u3067\u751f\u6210\u3057\u3066\u3044\u308b\u30c0\u30df\u30fc\u30c7\u30fc\u30bf\u304c\u30ed\u30b0\u30a4\u30f3\u30c9\u30e9\u30a4\u30d0\u306b\u30ed\u30b0\u30a4\u30f3\u4e2d\u30e6\u30fc\u30b6\u30fc\u3068\u3057\u3066\u30bb\u30c3\u30c8\u3055\u308c\u308b\uff0e\n\u3053\u3046\u3057\u3066\u3057\u307e\u3048\u3070\u5f8c\u306f`Auth::check()`\u3084`Auth::member`, `Auth::has_access`\u306a\u3069\u304c\u30c0\u30df\u30fc\u30c7\u30fc\u30bf\u3092\u57fa\u306b\u6b63\u3057\u304f\u632f\u308b\u821e\u3046\u3088\u3046\u306b\u306a\u308b\uff0e\n\n> ```php\n\t\t$admin_user = \\Model_User::forge(array(\n\t\t\t'id' => 1,\n\t\t\t'username' => 'admin',\n\t\t\t'email' => 'admin@example.com',\n\t\t\t'group' => 100,\n\t\t));\n\t\ttest::double('Model_User', array('find_by_username' => $admin_user));\n```\n\n\u306e\u90e8\u5206\u306f\u30ed\u30b0\u30a4\u30f3\u306e\u30a8\u30df\u30e5\u30ec\u30fc\u30c8\u3068\u306f\u76f4\u63a5\u95a2\u4fc2\u306a\u3044\u304c\uff0c\n`Controller_Base`\u3067\n`Model_User::find_by_username(Auth::get_screen_name())` \u304c\u547c\u3070\u308c\u3066\u3044\u308b\u306e\u3067\uff0c\n\u3053\u3053\u3067`Auth_Login_Simpleauth::validate_user()`\u3067\u751f\u6210\u3057\u3066\u3044\u308b\u30c0\u30df\u30fc\u30c7\u30fc\u30bf\u3068\u540c\u3058\u7269\u3092\u8fd4\u3059\u3088\u3046\u306b\nAspeckMock\u3067\u8a2d\u5b9a\u3057\u3066\u3044\u308b\uff0e\n\n\u30c6\u30b9\u30c8\u30b1\u30fc\u30b9\u7d42\u4e86\u6642\u306b\u30ed\u30b0\u30a2\u30a6\u30c8\u3068AspectMock\u306e\u30ea\u30bb\u30c3\u30c8\u3092\u3057\u3066\u5f8c\u7247\u4ed8\u3051\u7d42\u4e86\uff0e\n> ```php\n\tprotected function tearDown() {\n\t\t\\Auth::logout();\n\t\ttest::clean();\n\t}\n```\n\n\u4ee5\u4e0a\u3067Simpleauth\u306e\u8a8d\u8a3c\u3092\u30a8\u30df\u30e5\u30ec\u30fc\u30c8\u3067\u304d\u305f\uff0e\n\n# Response::redirect() \u306e exit \u3092\u56de\u907f\u3059\u308b\nResponse::redirect()\u306f\u5185\u90e8\u3067exit\u3057\u3066\u304a\u308a\uff0c\u3053\u306e\u307e\u307e\u30c6\u30b9\u30c8\u3059\u308b\u3068\u9014\u4e2d\u7d42\u4e86\u3057\u3066\u3057\u307e\u3046\uff0e\n\n[fuelPHP\u3067PHPUnit\u3092\u4f7f\u3063\u305f\u30e6\u30cb\u30c3\u30c8\u30fb\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u30fc\u30c6\u30b9\u30c8\u3092\u3059\u308b\u306b\u306f](http://qiita.com/masahikoofjoyto/items/206e6f8d5b0aa7126678)\n\u306b\u3053\u306e\u554f\u984c\u3078\u306e\u89e3\u6c7a\u304c\u3042\u308b\u304c\uff0c\u3053\u3053\u3067\u306f\u5c11\u3057\u5909\u3048\u3066\u4f8b\u5916\u3092\u4f7f\u3063\u305f\u5bfe\u51e6\u6cd5\u3092\u4e0e\u3048\u308b\uff0e\n\n\u30ed\u30b0\u30a2\u30a6\u30c8\u72b6\u614b\u3067`admin/index`\u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u30c6\u30b9\u30c8\u30b1\u30fc\u30b9\u3092\u8ffd\u52a0\u3059\u308b\uff0e\n\n```php:fuel/tests/controller/admin.php\n<?php\n\nuse AspectMock\\Test as test;\n\n/**\n * @group Controller\n */\nclass Test_Controller_Admin extends \\TestCase\n{\n\tprotected function tearDown() {\n\t\t\\Auth::logout();\n\t\ttest::clean();\n\t}\n\t\n\tpublic function test_action_index_logged_in()\n\t{\n\t\t$admin_user = \\Model_User::forge(array(\n\t\t\t'id' => 1,\n\t\t\t'username' => 'admin',\n\t\t\t'email' => 'admin@example.com',\n\t\t\t'group' => 100,\n\t\t));\n\t\ttest::double('Model_User', array('find_by_username' => $admin_user));\n\t\t\\Auth::login('admin');\n\t\t$response = \\Request::forge('admin/index')->execute()->response();\n\t}\n\t\n\tpublic function test_action_index_logged_out()\n\t{\n\t\t\\Auth::logout();\n\t\t$response = \\Request::forge('admin/index')->execute()->response();\n\t}\n}\n```\n\n\u30ed\u30b0\u30a2\u30a6\u30c8\u72b6\u614b\u3067\u306e`admin/index`\u3078\u306e\u30a2\u30af\u30bb\u30b9\u306f\uff0c\u4e0a\u3067\u8ff0\u3079\u305f\u3068\u304a\u308a\uff0c`admin/login`\u306b\u30ea\u30c0\u30a4\u30ec\u30af\u30c8\u3055\u308c\u308b\u306f\u305a\uff0e\n\n```bash\n$ php oil test --group=Controller\nTests Running...This may take a few moments.\n....\n```\n\u30c6\u30b9\u30c8\u3092\u5b9f\u884c\u3057\u3066\u307f\u308b\u3068\uff0c\u3084\u306f\u308a\u9014\u4e2d\u3067\u7d42\u4e86\u3057\u3066\u3057\u307e\u3063\u305f\uff0e\n\n\u30c6\u30b9\u30c8\u30b1\u30fc\u30b9\u3092\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u4fee\u6b63\u3059\u308b\uff0e\n\n```php:fuel/app/tests/controller/admin.php\n<?php\n\nuse AspectMock\\Test as test;\n\nclass TestRedirectException extends \\Exception\n{}\n\n/**\n * @group Controller\n */\nclass Test_Controller_Admin extends \\TestCase\n{\n\tprotected function tearDown() {\n\t\t\\Auth::logout();\n\t\ttest::clean();\n\t}\n\t\n\tpublic function test_action_index_logged_in()\n\t{\n\t\t$admin_user = \\Model_User::forge(array(\n\t\t\t'id' => 1,\n\t\t\t'username' => 'admin',\n\t\t\t'email' => 'admin@example.com',\n\t\t\t'group' => 100,\n\t\t));\n\t\ttest::double('Model_User', array('find_by_username' => $admin_user));\n\t\t\\Auth::login('admin');\n\t\t$response = \\Request::forge('admin/index')->execute()->response();\n\t}\n\t\n\t/**\n\t * @expectedException TestRedirectException\n\t * @expectedExceptionMessage admin/login:location:302\n\t */\n\tpublic function test_action_index_logged_out()\n\t{\n\t\ttest::double('Fuel\\Core\\Response', array(\n\t\t\t'redirect' => function($url = '', $method = 'location', $code = 302){\n\t\t\t\tthrow new TestRedirectException(sprintf('%s:%s:%s', $url, $method, $code));\n\t\t\t}\n\t\t));\n\t\t\\Auth::logout();\n\t\t$response = \\Request::forge('admin/index')->execute()->response();\n\t}\n}\n```\n\n\u30ad\u30e2\u306f\n> ```php\n\t\ttest::double('Fuel\\Core\\Response', array(\n\t\t\t'redirect' => function($url = '', $method = 'location', $code = 302){\n\t\t\t\tthrow new TestRedirectException(sprintf('%s:%s:%s', $url, $method, $code));\n\t\t\t}\n\t\t));\n```\n\n\u3053\u308c\u3067\uff0c`Response::redirect()`\u306e\u547c\u3073\u51fa\u3057\u3092AspectMock\u306b\u3088\u3063\u3066\u4e0a\u66f8\u304d\u3057\u3066\u3044\u308b\uff0e\n`Response::redirect()`\u304c\u547c\u3070\u308c\u308b\u3068\uff0c\u4f8b\u5916`TestRedirectException`\u304c\u30b9\u30ed\u30fc\u3055\u308c\u308b\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u308b\uff0e\n`TestRedirectException`\u306e\u30e1\u30c3\u30bb\u30fc\u30b8\u306b\u306f`Response::redirect()`\u306e\u5f15\u6570`$url`,`$method`,`$code`\u304c\u5165\u308b\u306e\u3067\uff0c\n`@expectedExceptionMessage`\u30a2\u30ce\u30c6\u30fc\u30b7\u30e7\u30f3\u3067\u30ea\u30c0\u30a4\u30ec\u30af\u30c8\u5148\u3084\u30b9\u30c6\u30fc\u30bf\u30b9\u30b3\u30fc\u30c9\u3082\u30c1\u30a7\u30c3\u30af\u3067\u304d\u308b\uff0e\n\n\u4ee5\u4e0a\u3067`Response::redirect()`\u3092\u542b\u3080\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u3092\u30c6\u30b9\u30c8\u53ef\u80fd\u306b\u306a\u3063\u305f\uff0e\n\n# \u307e\u3068\u3081\u308b\n\u4ee5\u4e0a\uff0c\u8a8d\u8a3c\u306e\u30a8\u30df\u30e5\u30ec\u30fc\u30c8\u3068Response::redirect()\u306eexit\u56de\u907f\u306e\u30b3\u30fc\u30c9\u3092\u66f8\u3044\u3066\u304d\u305f\u304c\uff0c\n\u4e00\u3064\u306e\u57fa\u5e95\u30af\u30e9\u30b9\u306b\u307e\u3068\u3081\u3066\u3057\u307e\u3046\u3068\u4f7f\u3044\u52dd\u624b\u304c\u3088\u3044\uff0e\n\n```php:fuel/app/classes/testcase/controller.php\n<?php\nuse AspectMock\\Test as test;\n\nclass TestRedirectException extends \\Exception\n{}\n\nclass TestCase_Controller extends \\TestCase\n{\n\tprotected function setup()\n\t{\n\t\ttest::double('Fuel\\Core\\Response', array(\n\t\t\t'redirect' => function($url = '', $method = 'location', $code = 302){\n\t\t\t\tthrow new TestRedirectException(sprintf('%s:%s:%s', $url, $method, $code));\n\t\t\t}\n\t\t));\n\t}\n\t\n\tprotected function tearDown()\n\t{\n\t\t\\Auth::logout();\n\t\ttest::clean();\n\t}\n\t\n\tprotected function emulate_logged_in()\n\t{\n\t\t$admin_user = \\Model_User::forge(array(\n\t\t\t'id' => 1,\n\t\t\t'username' => 'admin',\n\t\t\t'email' => 'admin@example.com',\n\t\t\t'group' => 100,\n\t\t));\n\t\ttest::double('Model_User', array('find_by_username' => $admin_user));\n\t\t\\Auth::login('admin');\n\t}\n\t\n\tprotected function emulate_logged_out()\n\t{\n\t\t\\Auth::logout();\n\t}\n}\n```\n\n```php:fuel/app/tests/controller/admin.php\n<?php\n\n/**\n * @group Controller\n */\nclass Test_Controller_Admin extends TestCase_Controller\n{\n\tpublic function test_action_index_logged_in()\n\t{\n\t\t$this->emulate_logged_in();\n\t\t$response = \\Request::forge('admin/index')->execute()->response();\n\t}\n\t\n\t/**\n\t * @expectedException TestRedirectException\n\t * @expectedExceptionMessage admin/login:location:302\n\t */\n\tpublic function test_action_index_logged_out()\n\t{\n\t\t$this->emulate_logged_out();\n\t\t$response = \\Request::forge('admin/index')->execute()->response();\n\t}\n}\n```\n\n```diff:fuel/app/bootstrap_phpunit.php\nAutoloader::add_classes(array(\n\t'Auth_Login_Simpleauth' => APPPATH.'classes/testcase/auth/login/simpleauth.php',\n+\t'TestCase_Controller' => APPPATH.'classes/testcase/controller.php',\n+\t'TestRedirectException' => APPPATH.'classes/testcase/controller.php',\n));\n```\n\n# \u5225\u306e\u30b0\u30eb\u30fc\u30d7\u306e\u30e6\u30fc\u30b6\u30fc\u3092\u8ffd\u52a0\u3057\u3066\u307f\u308b\nadmin\u4ee5\u5916\u306e\u30e6\u30fc\u30b6\u30fc\u3067\u30ed\u30b0\u30a4\u30f3\u3059\u308b\u3068\uff0c`/`\u306b\u30ea\u30c0\u30a4\u30ec\u30af\u30c8\u3055\u308c\u308b\uff0e\n\u3053\u308c\u3092\u30c6\u30b9\u30c8\u3057\u3066\u307f\u308b\uff0e\n\nSimpleauth\u306e\u30ed\u30b0\u30a4\u30f3\u30c9\u30e9\u30a4\u30d0\u306e`validate_user()`\u306b\u5225\u306e\u30e6\u30fc\u30b6\u30fc\u30bf\u30a4\u30d7\u306e\u30c0\u30df\u30fc\u30c7\u30fc\u30bf\u3092\u8ffd\u52a0\u3059\u308b\n\n```php:fuel/app/classes/testcase/auth/login/simpleauth.php\n\tpublic function validate_user($username_or_email = '', $password = '')\n\t{\n\t\tswitch ($username_or_email)\n\t\t{\n\t\t\tcase 'admin':\n\t\t\t\treturn array(\n\t\t\t\t\t'id' => 1,\n\t\t\t\t\t'username' => 'admin',\n\t\t\t\t\t'email' => 'admin@example.com',\n\t\t\t\t\t'group' => 100,\n\t\t\t\t);\n\t\t\tbreak;\n\t\t\n\t\t\tcase 'user':\n\t\t\t\treturn array(\n\t\t\t\t\t'id' => 2,\n\t\t\t\t\t'username' => 'user',\n\t\t\t\t\t'email' => 'user@example.com',\n\t\t\t\t\t'group' => 1,\n\t\t\t\t);\n\t\t\tbreak;\n\t\t\n\t\t\tdefault:\n\t\t\t\treturn false;\n\t\t}\n\t}\n```\n\n`emulate_logged_in()`\u3092\u8907\u6570\u30e6\u30fc\u30b6\u30fc\u30bf\u30a4\u30d7\u306b\u5bfe\u5fdc\u3055\u305b\u308b\uff0e\n\n```php:fuel/app/classes/testcase/controller.php\n\tprotected function emulate_logged_in($usertype = '')\n\t{\n\t\tswitch ($usertype)\n\t\t{\n\t\t\tcase 'admin':\n\t\t\t\t\\Auth::login('admin');\n\t\t\t\t$user = \\Model_User::forge(array(\n\t\t\t\t\t'id' => 1,\n\t\t\t\t\t'username' => 'admin',\n\t\t\t\t\t'email' => 'admin@example.com',\n\t\t\t\t\t'group' => 100,\n\t\t\t\t));\n\t\t\tbreak;\n\t\t\n\t\t\tcase 'user':\n\t\t\t\t\\Auth::login('user');\n\t\t\t\t$user = \\Model_User::forge(array(\n\t\t\t\t\t'id' => 2,\n\t\t\t\t\t'username' => 'user',\n\t\t\t\t\t'email' => 'user@example.com',\n\t\t\t\t\t'group' => 1,\n\t\t\t\t));\n\t\t\tbreak;\n\t\t\n\t\t\tdefault:\n\t\t\t\t$user = null;\n\t\t}\n\t\ttest::double('Model_User', array('find_by_username' => $user));\n\t}\n}\n```\n\n\u3053\u308c\u3089\u3092\u4f7f\u3063\u3066\u30c6\u30b9\u30c8\u30b1\u30fc\u30b9\u3092\u4fee\u6b63\uff06\u8ffd\u52a0\n\n```php:fuel/app/tests/controller/admin.php\n<?php\n\n/**\n * @group Controller\n */\nclass Test_Controller_Admin extends TestCase_Controller\n{\n\tpublic function test_action_index_logged_in()\n\t{\n\t\t$this->emulate_logged_in('admin');\n\t\t$response = \\Request::forge('admin/index')->execute()->response();\n\t}\n\t\n\t/**\n\t * @expectedException TestRedirectException\n\t * @expectedExceptionMessage /:location:302\n\t */\n\tpublic function test_action_index_logged_in_invalid_auth()\n\t{\n\t\t$this->emulate_logged_in('user');\n\t\t$response = \\Request::forge('admin/index')->execute()->response();\n\t}\n\t\n\t/**\n\t * @expectedException TestRedirectException\n\t * @expectedExceptionMessage admin/login:location:302\n\t */\n\tpublic function test_action_index_logged_out()\n\t{\n\t\t$this->emulate_logged_out();\n\t\t$response = \\Request::forge('admin/index')->execute()->response();\n\t}\n}\n```\n\n# Request::is_hmvc() \u3092\u6b63\u3057\u304f\u6a5f\u80fd\u3055\u305b\u308b\uff0e\n`Request::is_hmvc()`\u304c\u30c6\u30b9\u30c8\u3067\u306f\u3046\u307e\u304f\u6a5f\u80fd\u3057\u306a\u3044\uff0e\n\u30b5\u30f3\u30d7\u30eb\u3068\u306a\u308b\u30c6\u30b9\u30c8\u30b1\u30fc\u30b9\u306f\u793a\u3055\u306a\u3044\u304c\uff0c\n\n```php\nprotected function setup() {\n\ttest::double('Fuel\\\\Core\\\\Request', array(\n\t\t'is_hmvc' => function() {\n\t\t\treturn \\Request::active() !== \\Request::main();\n\t\t}\n\t));\n\n\t\\Request::reset_request(true);\n}\n```\n\u3068\u3059\u308b\u3053\u3068\u3067\u6b63\u3057\u304f\u6a5f\u80fd\u3055\u305b\u308b\u3053\u3068\u304c\u3067\u304d\u308b\uff0e\n`Request::is_hmvc()`\u306e\u30aa\u30ea\u30b8\u30ca\u30eb\u306f\n\n```php:fuel/core/classes/request.php\n\tpublic static function is_hmvc()\n\t{\n\t\treturn ((\\Fuel::$is_cli and static::main()) or static::active() !== static::main());\n\t}\n```\n\u3068\u306a\u3063\u3066\u3044\u3066\uff0c\u30c6\u30b9\u30c8\u6642\u306f`\\Fuel::$is_cli = true`\u3068\u306a\u3063\u3066\u3057\u307e\u3046\u305f\u3081\uff0e\nAspectMock\u3067\u3053\u306e\u6761\u4ef6\u5f0f\u304c\u7121\u3044\u3082\u306e\u306b\u66f8\u304d\u63db\u3048\u3066\u3044\u308b\uff0e\n\u307e\u305f\uff0c`Request::reset_request(true);`\u3059\u308b\u3053\u3068\u3067\uff0c`Request::$main`\u3092null\u306b\u3057\u3066\u3044\u308b\uff0e\n\u3053\u308c\u3092\u3057\u306a\u3044\u3068\uff0c\u524d\u56de\u306e\u30c6\u30b9\u30c8\u30b1\u30fc\u30b9\u3067`Request::forge()`\u3057\u305f\u3068\u304d\u306e`Request::$main`\u304c\u6b8b\u3063\u3066\u3057\u307e\u3044\uff0c\n\uff12\u3064\u76ee\u4ee5\u964d\u306e`Request::is_hmvc()`\u304c\u6b63\u3057\u304f\u52d5\u304b\u306a\u304f\u306a\u308b\uff0e\n\n# \u3055\u3089\u306b\u307e\u3068\u3081\u308b\uff08\u6700\u7d42\u7248\uff09\n\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u30c6\u30b9\u30c8\u306e\u305f\u3081\u306e\u57fa\u5e95\u30c6\u30b9\u30c8\u30b1\u30fc\u30b9\u30af\u30e9\u30b9\u6700\u7d42\u7248\uff0e\n\n```php:fuel/classes/testcase/controller.php\n<?php\nuse AspectMock\\Test as test;\n\nclass TestRedirectException extends \\Exception\n{}\n\nclass TestCase_Controller extends \\TestCase\n{\n\tprotected function setup()\n\t{\n\t\t// Response::redirect()\u306eexit\u3092\u56de\u907f\u3059\u308b\uff0e\n\t\ttest::double('Fuel\\Core\\Response', array(\n\t\t\t'redirect' => function($url = '', $method = 'location', $code = 302){\n\t\t\t\tthrow new TestRedirectException(sprintf('%s:%s:%s', $url, $method, $code));\n\t\t\t}\n\t\t));\n\t\t\n\t\t// \u672c\u7269\u306eRequest::is_hmvc()\u306f \\Fuel::$is_cli and static::main() \u6761\u4ef6\u304c\u3042\u3063\u3066cli\u304b\u3089\u5b9f\u884c\u3059\u308btest\u3060\u3068true\u306b\u306a\u3063\u3066\u3057\u307e\u3046\u306e\u3067\uff0c\u305d\u306e\u6761\u4ef6\u3092\u5916\u3059\u305f\u3081\u306b\u7f6e\u304d\u63db\u3048\u308b\n\t\ttest::double('Fuel\\\\Core\\\\Request', array(\n\t\t\t'is_hmvc' => function() {\n\t\t\t\treturn \\Request::active() !== \\Request::main();\n\t\t\t}\n\t\t));\n\t\t\n\t\t// Request\u3092\u30ea\u30bb\u30c3\u30c8\u3057\u306a\u3044\u3068\\Request::$main\u304c\u6b8b\u3063\u305f\u307e\u307e\u306b\u306a\u3063\u3066\uff12\u5ea6\u76ee\u4ee5\u964d\u306e\\Request::forge()\u304b\u3089\u306e\\Request::is_hmvc()\u3067\u554f\u984c\u306b\u306a\u308b\n\t\t\\Request::reset_request(true);\n\t\t\n\t\tchdir('public');\n\t}\n\t\n\tprotected function tearDown()\n\t{\n\t\t\\Auth::logout();\n\t\ttest::clean();\n\t}\n\t\n\tprotected function emulate_logged_in($usertype = '')\n\t{\n\t\tswitch ($usertype)\n\t\t{\n\t\t\tcase 'admin':\n\t\t\t\t\\Auth::login('admin');\n\t\t\t\t$user = \\Model_User::forge(array(\n\t\t\t\t\t'id' => 1,\n\t\t\t\t\t'username' => 'admin',\n\t\t\t\t\t'email' => 'admin@example.com',\n\t\t\t\t\t'group' => 100,\n\t\t\t\t));\n\t\t\tbreak;\n\t\t\n\t\t\tcase 'user':\n\t\t\t\t\\Auth::login('user');\n\t\t\t\t$user = \\Model_User::forge(array(\n\t\t\t\t\t'id' => 2,\n\t\t\t\t\t'username' => 'user',\n\t\t\t\t\t'email' => 'user@example.com',\n\t\t\t\t\t'group' => 1,\n\t\t\t\t));\n\t\t\tbreak;\n\t\t\n\t\t\tdefault:\n\t\t\t\t$user = null;\n\t\t}\n\t\ttest::double('Model_User', array('find_by_username' => $user));\n\t}\n\t\n\tprotected function emulate_logged_out()\n\t{\n\t\t\\Auth::logout();\n\t}\n}\n```\n\n\u4eca\u307e\u3067\u8aac\u660e\u3057\u305f\n* \u8a8d\u8a3c\u30b7\u30df\u30e5\u30ec\u30fc\u30c8\n* Response::redirect()\u306eexit\u56de\u907f\n* Request::is_hmvc()\u306e\u8aa4\u52d5\u4f5c\u56de\u907f\n\u3092\u307e\u3068\u3081\u305f\uff0e\n\n## Asset\u5bfe\u5fdc\n\u307e\u305f\uff0cAsset::img\u306a\u3069\u3092\u6b63\u3057\u304f\u52d5\u4f5c\u3055\u305b\u308b\u305f\u3081\u306b`chdir('public')`\u3082\u8ffd\u52a0\u3055\u308c\u3066\u3044\u308b\uff0e\nWeb\u30da\u30fc\u30b8\u3068\u3057\u3066\u95b2\u89a7\u3059\u308b\u3068\u304d\u306f\u6700\u521d\u306b`/public/index.php`\u3078\u30a2\u30af\u30bb\u30b9\u3059\u308b\u305f\u3081\uff0c`Asset_Instance::find_file()`\u5185\u306e`is_file`\u304c\u30d5\u30a1\u30a4\u30eb\u3092\u63a2\u3059\u8d77\u70b9\u304c`/public`\u306a\u306e\u306b\u5bfe\u3057\uff0c\u30c6\u30b9\u30c8\u6642\u306f`/`\u3092\u8d77\u70b9\u306b\u30d5\u30a1\u30a4\u30eb\u3092\u63a2\u305d\u3046\u3068\u3059\u308b\u305f\u3081\uff0c`chdir('public')`\u3057\u3066\u304a\u304b\u306a\u3044\u3068`Could not find asset: ~~~`\u3068\u30a8\u30e9\u30fc\u306b\u306a\u308b\uff0e\n\n# \u305d\u306e\u4ed6\n* \u3053\u306e\u4f8b\u3067\u306f`fuel/app/classes/testcase/auth`\u4ee5\u4e0b\u306bSimpleauth\u306e\u62e1\u5f35\u30af\u30e9\u30b9\u3092\u7f6e\u3044\u3066\u3057\u307e\u3063\u3066\u3044\u308b\uff0e\n`bootstrap_phpunit.php`\u3067`Autoloader`\u3092\u3061\u3083\u3093\u3068\u8a2d\u5b9a\u3057\u3066\u3044\u308b\u306e\u3067\u52d5\u304f\u304c\uff0c\u547d\u540d\u898f\u5247\u7684\u306b\u3088\u308d\u3057\u304f\u306a\u3044\u6c17\u304c\u3059\u308b\uff0e\n\u30c6\u30b9\u30c8\u3067\u3057\u304b\u4f7f\u308f\u306a\u3044\u306e\u3067`fuel/app/classes/testcase`\u4ee5\u4e0b\u306b\u307e\u3068\u3081\u3066\u3057\u307e\u3044\u305f\u304b\u3063\u305f\u306e\u3060\u304c\u2026\n* \u3053\u306e\u8a18\u4e8b\u3067\u4f5c\u6210\u3057\u305f\u30b3\u30fc\u30c9\u306f https://github.com/yuichiroTCY/fuel-controller-test \u306b\u7f6e\u3044\u3066\u3042\u308a\u307e\u3059\uff0e\n", "tags": ["FuelPHP", "PHPUnit", "AspectMock"]}