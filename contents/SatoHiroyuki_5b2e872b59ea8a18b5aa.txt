{"tags": ["AWS", "serf"], "context": " More than 1 year has passed since last update.\n\nSerf\n\u969c\u5bb3\u306e\u691c\u77e5\u3068\u3001\u30a4\u30d9\u30f3\u30c8\u30cf\u30f3\u30c9\u30e9\u30fc\u3092\u884c\u3048\u308bhashicorp\u306e\u30c4\u30fc\u30eb\u3002\n\u6982\u8981\u306f\u3053\u3061\u3089\u304c\u308f\u304b\u308a\u3084\u3059\u3044\u3067\u3059\u3002\nhttp://gihyo.jp/admin/feature/01/serf-consul\n\nNAT\u5197\u9577\u5316\n\u6700\u8fd1\u306fAutoScaling\u306b\u3088\u308b\u5197\u9577\u5316\u3082\u3042\u308b\u304c\u3001\n\u5207\u308a\u66ff\u308f\u308a\u6642\u9593\u3092\u77ed\u304f\u3057\u305f\u3044\u305f\u3081Active/Standby\u306b\u3088\u308b\u5197\u9577\u5316\u3092\u5b9f\u88c5\u3002\nSerf\u306b\u3088\u308a\u969c\u5bb3\u3092\u691c\u77e5\u3057\u3001API\u3092\u4f7f\u7528\u3057RouteTable\u3092\u5207\u308a\u66ff\u3048\u308b\u3002\n\n\nSerf\u5b9f\u88c5\nActive\u5074\u304c\u6b63\u5e38\u3067\u3042\u308c\u3070\u3001\u5e38\u306b\u7d4c\u8def\u3092\u5bc4\u305b\u308b\u3088\u3046\u306b\u3059\u308b\u3002\nStandby\u5074\u306fActive\u5074\u306e\u969c\u5bb3\u3092\u691c\u77e5\u3057\u305f\u969b\u306bRouteTable\u3092\u66f8\u304d\u63db\u3048\u308b\u3002\n\u307e\u305f\u3001\u758e\u901a\u9593\u9694\u30924\u79d2\u3068\u3057\u3001\u30bf\u30a4\u30e0\u30a2\u30a6\u30c812\u79d2\u8a2d\u5b9a\u3059\u308b\u3053\u3068\u3067\u6700\u9577\u306e\u969c\u5bb3\u6642\u9593\u309212\u79d2\u306b\u3059\u308b\u3002\n\u30aa\u30d7\u30b7\u30e7\u30f3\u7b49\u306f\u4ee5\u4e0b\u304c\u53c2\u8003\u306b\u306a\u308a\u307e\u3059\u3002\nhttps://www.serfdom.io/docs/agent/options.html\nhttp://qiita.com/zembutsu/items/1e2cddd0a424ef7a4895\n\nSerf Active\n{\n  \"node_name\": \"nat1\",\n  \"enable_syslog\": true,\n  \"tags\": {\n    \"role\": \"nat\"\n  },\n  \"reconnect_interval\": \"4s\",\u2190\u758e\u901a\u9593\u9694\u306f\uff14\u79d2\n  \"reconnect_timeout\": \"12s\",\u2190\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u691c\u77e512\u79d2\n  \"tombstone_timeout\": \"12s\",\u2190\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u691c\u77e512\u79d2\n  \"event_handlers\": [\n    \"member-join=ha-nat -R [\u5909\u66f4\u3059\u308bRouteTable\u306eTagName] -N 0.0.0.0/0 -r ap-northeast-1 >> /var/log/ha-nat.log 2>&1\"\n  ]\n}\n\n\nSerf Standby\n{\n  \"node_name\": \"nat2\",\n  \"enable_syslog\": true,\n  \"tags\": {\n    \"role\": \"nat\"\n  },\n  \"reconnect_interval\": \"4s\",\n  \"reconnect_timeout\": \"12s\",\n  \"tombstone_timeout\": \"12s\",\n  \"start_join\": [\n    \"Active\u5074\u306ePrivateIP\"\n  ],\n  \"event_handlers\": [\n    \"member-failed,member-leave=ha-nat -R [\u5909\u66f4\u3059\u308bRouteTable\u306eTagName] -N 0.0.0.0/0 -r ap-northeast-1 >> /var/log/ha-nat.log 2>&1\"\n  ]\n}\n\n\ninit\u30b9\u30af\u30ea\u30d7\u30c8\nzembutsu\u3055\u3093\u306e\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u4f7f\u308f\u305b\u3066\u9802\u304d\u307e\u3057\u305f\u3002\nlockfile\u7b49\u3092\u3061\u3087\u3053\u3063\u3068\u76f4\u3057\u3066\u4f7f\u3063\u3066\u307e\u3059\u3002\nhttps://gist.github.com/zembutsu/7640108\n\nRouteTable\u66f8\u304d\u63db\u3048\u30b9\u30af\u30ea\u30d7\u30c8\nBoto\u306b\u3088\u308bRouteTable\u64cd\u4f5c\u3092\u5b9f\u88c5\u3057\u307e\u3057\u305f\u3002\n\u7406\u7531\u3068\u3057\u3066\u306f\u3001AWS\u3067\u63d0\u4f9b\u3059\u308bNAT\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306fAmazonLinux\u306e\u305f\u3081\u3001\nboto\u3067\u3042\u308c\u3070\u3059\u3067\u306b\u74b0\u5883\u306f\u6574\u3063\u3066\u3044\u308b\u306e\u3067\u8ffd\u52a0\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u306f\u5fc5\u8981\u306a\u304f\u306a\u308a\u307e\u3059\u3002\nhttps://github.com/SatoHiroyuki/ha-nat-script/blob/master/ha-nat\nha-nat -R [\u5909\u66f4\u3059\u308bRouteTable\u306eTagName] -N [\u66f8\u304d\u63db\u3048\u308b\u7d4c\u8def(Cidr\u8fbc\u307f)] -r [\u30ea\u30fc\u30b8\u30e7\u30f3]\n\n\n\u8d77\u52d5\nActive\u5074\u306e\u30b5\u30fc\u30d3\u30b9\u3092\u5148\u306b\u4e0a\u3052\u308b\u3002\n\u305d\u306e\u5f8c\u3001Standby\u5074\u306e\u30b5\u30fc\u30d3\u30b9\u3082\u4e0a\u3052\u308b\u3002\n\n$ sudo /etc/init.d/ha-serf start\n\n\n\u969c\u5bb3\u8a66\u9a13\n\u6570\u56de\u8a66\u9a13\u3057\u307e\u3057\u305f\u304c\u6700\u9577\u3067\u3001\nPing1\u79d2\u9593\u9694\u306e\u969c\u5bb3\u8a66\u9a13\u3067\u5207\u308a\u66ff\u308f\u308a\u6642\u306b8\u30d1\u30b1\u30c3\u30c8\u30ed\u30b9\u3068\u306a\u308a8\u79d2\u30c0\u30a6\u30f3\u3002\n--- 8.8.8.8 ping statistics ---\n42 packets transmitted, 34 received, 19% packet loss, time 42087ms\nrtt min/avg/max/mdev = 2.181/2.454/2.867/0.176 ms\n\n\u305d\u306e\u4ed6\u3001\u30bf\u30a4\u30df\u30f3\u30b0\u306b\u3088\u308a\u307e\u3059\u304c\u3053\u308c\u3088\u3044\u77ed\u3044\u5834\u5408\u3082\u3042\u308a\u307e\u3059\u3002\n\u5c1a\u3001\u4e21\u65b9\u304c\u6b63\u5e38\u3067\u3042\u308b\u5834\u5408\u306eStandby\u304b\u3089Active\u3078\u623b\u3059\u969b\u306e\u30d1\u30b1\u30ed\u30b9\u306f\u306a\u3057\u3002\n#Serf\n\n\u969c\u5bb3\u306e\u691c\u77e5\u3068\u3001\u30a4\u30d9\u30f3\u30c8\u30cf\u30f3\u30c9\u30e9\u30fc\u3092\u884c\u3048\u308bhashicorp\u306e\u30c4\u30fc\u30eb\u3002\n\n\u6982\u8981\u306f\u3053\u3061\u3089\u304c\u308f\u304b\u308a\u3084\u3059\u3044\u3067\u3059\u3002\nhttp://gihyo.jp/admin/feature/01/serf-consul\n\n#NAT\u5197\u9577\u5316\n\n\u6700\u8fd1\u306fAutoScaling\u306b\u3088\u308b\u5197\u9577\u5316\u3082\u3042\u308b\u304c\u3001\n\u5207\u308a\u66ff\u308f\u308a\u6642\u9593\u3092\u77ed\u304f\u3057\u305f\u3044\u305f\u3081Active/Standby\u306b\u3088\u308b\u5197\u9577\u5316\u3092\u5b9f\u88c5\u3002\n\nSerf\u306b\u3088\u308a\u969c\u5bb3\u3092\u691c\u77e5\u3057\u3001API\u3092\u4f7f\u7528\u3057RouteTable\u3092\u5207\u308a\u66ff\u3048\u308b\u3002\n\n![ha-nat.png](https://qiita-image-store.s3.amazonaws.com/0/49877/fcc94d7e-0ccf-75d7-9136-1435298e60d7.png)\n\n\n#Serf\u5b9f\u88c5\n\nActive\u5074\u304c\u6b63\u5e38\u3067\u3042\u308c\u3070\u3001\u5e38\u306b\u7d4c\u8def\u3092\u5bc4\u305b\u308b\u3088\u3046\u306b\u3059\u308b\u3002\nStandby\u5074\u306fActive\u5074\u306e\u969c\u5bb3\u3092\u691c\u77e5\u3057\u305f\u969b\u306bRouteTable\u3092\u66f8\u304d\u63db\u3048\u308b\u3002\n\u307e\u305f\u3001\u758e\u901a\u9593\u9694\u30924\u79d2\u3068\u3057\u3001\u30bf\u30a4\u30e0\u30a2\u30a6\u30c812\u79d2\u8a2d\u5b9a\u3059\u308b\u3053\u3068\u3067\u6700\u9577\u306e\u969c\u5bb3\u6642\u9593\u309212\u79d2\u306b\u3059\u308b\u3002\n\n\u30aa\u30d7\u30b7\u30e7\u30f3\u7b49\u306f\u4ee5\u4e0b\u304c\u53c2\u8003\u306b\u306a\u308a\u307e\u3059\u3002\nhttps://www.serfdom.io/docs/agent/options.html\nhttp://qiita.com/zembutsu/items/1e2cddd0a424ef7a4895\n\n##Serf Active\n\n```\n{\n  \"node_name\": \"nat1\",\n  \"enable_syslog\": true,\n  \"tags\": {\n    \"role\": \"nat\"\n  },\n  \"reconnect_interval\": \"4s\",\u2190\u758e\u901a\u9593\u9694\u306f\uff14\u79d2\n  \"reconnect_timeout\": \"12s\",\u2190\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u691c\u77e512\u79d2\n  \"tombstone_timeout\": \"12s\",\u2190\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u691c\u77e512\u79d2\n  \"event_handlers\": [\n    \"member-join=ha-nat -R [\u5909\u66f4\u3059\u308bRouteTable\u306eTagName] -N 0.0.0.0/0 -r ap-northeast-1 >> /var/log/ha-nat.log 2>&1\"\n  ]\n}\n```\n\n##Serf Standby\n\n```\n{\n  \"node_name\": \"nat2\",\n  \"enable_syslog\": true,\n  \"tags\": {\n    \"role\": \"nat\"\n  },\n  \"reconnect_interval\": \"4s\",\n  \"reconnect_timeout\": \"12s\",\n  \"tombstone_timeout\": \"12s\",\n  \"start_join\": [\n    \"Active\u5074\u306ePrivateIP\"\n  ],\n  \"event_handlers\": [\n    \"member-failed,member-leave=ha-nat -R [\u5909\u66f4\u3059\u308bRouteTable\u306eTagName] -N 0.0.0.0/0 -r ap-northeast-1 >> /var/log/ha-nat.log 2>&1\"\n  ]\n}\n```\n\n##init\u30b9\u30af\u30ea\u30d7\u30c8\n\nzembutsu\u3055\u3093\u306e\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u4f7f\u308f\u305b\u3066\u9802\u304d\u307e\u3057\u305f\u3002\nlockfile\u7b49\u3092\u3061\u3087\u3053\u3063\u3068\u76f4\u3057\u3066\u4f7f\u3063\u3066\u307e\u3059\u3002\nhttps://gist.github.com/zembutsu/7640108\n\n##RouteTable\u66f8\u304d\u63db\u3048\u30b9\u30af\u30ea\u30d7\u30c8\n\nBoto\u306b\u3088\u308bRouteTable\u64cd\u4f5c\u3092\u5b9f\u88c5\u3057\u307e\u3057\u305f\u3002\n\u7406\u7531\u3068\u3057\u3066\u306f\u3001AWS\u3067\u63d0\u4f9b\u3059\u308bNAT\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306fAmazonLinux\u306e\u305f\u3081\u3001\nboto\u3067\u3042\u308c\u3070\u3059\u3067\u306b\u74b0\u5883\u306f\u6574\u3063\u3066\u3044\u308b\u306e\u3067\u8ffd\u52a0\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u306f\u5fc5\u8981\u306a\u304f\u306a\u308a\u307e\u3059\u3002\n\nhttps://github.com/SatoHiroyuki/ha-nat-script/blob/master/ha-nat\n\n```\nha-nat -R [\u5909\u66f4\u3059\u308bRouteTable\u306eTagName] -N [\u66f8\u304d\u63db\u3048\u308b\u7d4c\u8def(Cidr\u8fbc\u307f)] -r [\u30ea\u30fc\u30b8\u30e7\u30f3]\n```\n\n#\u8d77\u52d5\n\nActive\u5074\u306e\u30b5\u30fc\u30d3\u30b9\u3092\u5148\u306b\u4e0a\u3052\u308b\u3002\n\u305d\u306e\u5f8c\u3001Standby\u5074\u306e\u30b5\u30fc\u30d3\u30b9\u3082\u4e0a\u3052\u308b\u3002\n```\n$ sudo /etc/init.d/ha-serf start\n```\n\n#\u969c\u5bb3\u8a66\u9a13\n\n\u6570\u56de\u8a66\u9a13\u3057\u307e\u3057\u305f\u304c\u6700\u9577\u3067\u3001\nPing1\u79d2\u9593\u9694\u306e\u969c\u5bb3\u8a66\u9a13\u3067\u5207\u308a\u66ff\u308f\u308a\u6642\u306b8\u30d1\u30b1\u30c3\u30c8\u30ed\u30b9\u3068\u306a\u308a8\u79d2\u30c0\u30a6\u30f3\u3002\n\n```\n--- 8.8.8.8 ping statistics ---\n42 packets transmitted, 34 received, 19% packet loss, time 42087ms\nrtt min/avg/max/mdev = 2.181/2.454/2.867/0.176 ms\n```\n\n\u305d\u306e\u4ed6\u3001\u30bf\u30a4\u30df\u30f3\u30b0\u306b\u3088\u308a\u307e\u3059\u304c\u3053\u308c\u3088\u3044\u77ed\u3044\u5834\u5408\u3082\u3042\u308a\u307e\u3059\u3002\n\u5c1a\u3001\u4e21\u65b9\u304c\u6b63\u5e38\u3067\u3042\u308b\u5834\u5408\u306eStandby\u304b\u3089Active\u3078\u623b\u3059\u969b\u306e\u30d1\u30b1\u30ed\u30b9\u306f\u306a\u3057\u3002\n\n"}