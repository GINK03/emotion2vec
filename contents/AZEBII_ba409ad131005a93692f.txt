{"tags": ["Heroku", "Node.js", "websocket", "MongoDB", "mongoose"], "context": "\n\n\u306f\u3058\u3081\u306b\n\u52d5\u3044\u3066\u3044\u308b\u30b5\u30f3\u30d7\u30eb \u2192 https://nwmsample.herokuapp.com/\n\u8abf\u3079\u308b\u306e\u304c\u5927\u5909\u3060\u3063\u305f\u306e\u3067\u3053\u3053\u306b\u66f8\u3044\u3066\u304a\u304d\u307e\u3059\u3002\n\u4f55\u304b\u9593\u9055\u3063\u3066\u3044\u305f\u3089\u6559\u3048\u3066\u3044\u305f\u3060\u3051\u308b\u3068\u5e78\u3044\u3067\u3059\u3002\n\u8457\u8005\u306e\u6027\u683c\u4e0a\u3001\u8aac\u660e\u306f\u30a2\u30d0\u30a6\u30c8\u3067\u3059\u3002\n\n\u30c1\u30e3\u30c3\u30c8\u306e\u4ed5\u69d8\n\n\u3042\u304f\u307e\u3067\u30b7\u30f3\u30d7\u30eb\u306b\u3002\n\u5358\u306b\u30ed\u30b0\u3092\u66f8\u304d\u6b8b\u305b\u308b\u3060\u3051\u306e\u30b5\u30f3\u30d7\u30eb\u3002\n\u65b0\u3057\u3044\u30ed\u30b0\u3092\u30ea\u30a2\u30eb\u30bf\u30a4\u30e0\u306b\u8868\u793a\u3002\n\u904e\u53bb\u306e\u30ed\u30b0\u3082\u898b\u308c\u308b\u3002\n\n\n\u6700\u65b0\u306e\uff12\uff10\u4ef6\u307e\u3067\u4fdd\u5b58\u3002\n\n\n\u5165\u9000\u51fa\u306f\u7121\u3057\u3001\u9001\u4fe1\u8005\u540d\u306a\u3069\u3082\u7121\u3057\u3002\n\n\n\u4f7f\u3063\u305f\u6280\u8853\n\u9069\u5f53\u3067\u3059\u304c\u7d39\u4ecb\u3002\n\nHeroku\n\n\nWeb\u30a2\u30d7\u30ea\u3092\u7c21\u5358\u306b\u516c\u958b\u3067\u304d\u308b\u30b5\u30fc\u30d3\u30b9\u3067\u3059\u3002\n\u7121\u6599\u3067\u3082\u4f7f\u3048\u307e\u3059\u304c\u3001\u5236\u9650\u306f\u3042\u308a\u307e\u3059\u3002\n\u82f1\u8a9e\u3002\n\n\nNode.js\n\n\n\u30b5\u30fc\u30d0\u30fc\u5074\u3067\u52d5\u304fJavaScript\u74b0\u5883\u306e\u4e8b\u3067\u3059\u3002\n\u5fc5\u8981\u4e0d\u53ef\u6b20\u3067\u3059\u3002\n\n\nWebSocket\n\n\u30ea\u30a2\u30eb\u30bf\u30a4\u30e0\u306b\u30b5\u30fc\u30d0\u30fc\u304c\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u3068\u901a\u4fe1\u3059\u308b\u305f\u3081\u306b\u5fc5\u8981\u3067\u3059\u3002\n\n\u30b5\u30fc\u30d0\u30fc\u304b\u3089\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u306b\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u9001\u308b\u3068\u3044\u3063\u305f\u4e8b\u304c\u53ef\u80fd\u306b\u306a\u308a\u307e\u3059\u3002\n\u4eca\u56de\u306f\u3001\u65b0\u3057\u304f\u5165\u5ba4\u3057\u305f\u4eba\u306b\u904e\u53bb\u30ed\u30b0\u3092\u9001\u3063\u305f\u308a\u3001\u8ab0\u304b\u304c\u9001\u4fe1\u3057\u305f\u30ed\u30b0\u3092\u53c2\u52a0\u8005\u5168\u54e1\u306b\u9001\u308b\u51e6\u7406\u306b\u4f7f\u3063\u3066\u3044\u307e\u3059\u3002\n\n\nMongoDB (mLab)\n\n\u7c21\u5358\u306b\u8a00\u3048\u3070\u30b5\u30fc\u30d0\u30fc\u5074\u3067\u30c7\u30fc\u30bf\u306e\u4fdd\u5b58\u3084\u691c\u7d22\u306a\u3069\u306b\u4f7f\u3044\u307e\u3059\u3002\n\u4eca\u56de\u306f\u3001\u6700\u5927\uff12\uff10\u4ef6\u306e\u904e\u53bb\u30ed\u30b0\u306e\u4fdd\u5b58\u306b\u4f7f\u3063\u3066\u3044\u307e\u3059\u3002\n\n\n\u3053\u308c\u304c\u7121\u3044\u3068\u3001\u65b0\u3057\u304f\u30c1\u30e3\u30c3\u30c8\u306b\u6765\u305f\u4eba\u304c\u3001\u6765\u305f\u4ee5\u524d\u306e\u30ed\u30b0\u3092\u53d6\u5f97\u3067\u304d\u307e\u305b\u3093\u3002\n\n\nJavaScript\u3068\u76f8\u6027\u304c\u3044\u3044\u3067\u3059\u3002\nHeroku\u3067MongoDB\u3092\u4f7f\u3046\u306b\u306fmLab\uff08\u5143MongoLAB\uff09\u3068\u3044\u3046\u30a2\u30c9\u30aa\u30f3\u304c\u5fc5\u8981\u3067\u3059\u3002\n\n\n\u7121\u6599\u3067\u4f7f\u3046\u5834\u5408\u306b\u3082\u30af\u30ec\u30b8\u30c3\u30c8\u30ab\u30fc\u30c9\u3084\u30c7\u30d3\u30c3\u30c8\u30ab\u30fc\u30c9\u306e\u767b\u9332\u304c\u5fc5\u8981\u3067\u3059\u3002\n\u3084\u306f\u308a\u82f1\u8a9e\u3002\n\n\nMongoose\u3068\u3044\u3046\u30e9\u30a4\u30d6\u30e9\u30ea\u3092\u4f7f\u7528\u3002\u7406\u7531\u306f\u7c21\u5358\u3089\u3057\u3044\u304b\u3089\u3002\n\n\n\u30b3\u30fc\u30c9\n\n\u30b5\u30fc\u30d0\u30fc\u5074\u306ejs\n\nindex.js\nvar WebSocketServer = require(\"ws\").Server;\nvar http = require(\"http\");\nvar express = require(\"express\");\nvar app = express();\nvar port = process.env.PORT;\napp.use(express.static(__dirname + \"/\"));\nvar server = http.createServer(app);\nserver.listen(port);\nvar wss = new WebSocketServer({server: server});\nvar mongoose = require (\"mongoose\");\nvar mongo_uri = process.env.MONGODB_URI;\nmongoose.connect(mongo_uri);\n\n\nvar ws_arr = []; // \u53c2\u52a0\u8005\u914d\u5217\nvar msg_limit = 20; // \u30ed\u30b0\u6570\u306e\u5236\u9650\nvar msg_length = 64; // \u30ed\u30b0\u306e\u6587\u5b57\u6570\u5236\u9650\n\n// mongoose\u306e\u30b9\u30ad\u30fc\u30de\u3092\u4f5c\u6210\nvar message_schema = new mongoose.Schema({\n    message: String,\n    date: Date\n});\n// mongoose\u306eMessage\u30e2\u30c7\u30eb\u3092\u53d6\u5f97\nvar Message = mongoose.model('Message', message_schema);\n\n// \u8ab0\u304b\u304c\u53c2\u52a0\u3057\u305f\nwss.on(\"connection\", function(ws) {\n    ws_arr.push(ws); // \u53c2\u52a0\u8005\u3092\u914d\u5217\u306b\u8ffd\u52a0\n\n    // \u6700\u521d\u306b\u904e\u53bb\u30ed\u30b0\u3092\u5168\u3066\u9001\u308b\n    Message.find({}, {}, {sort: {date: 1}}, function (error, messages) {\n        if(error)return console.error(error);\n        messages.forEach(function (m){\n            var msg = sanitize_string(m.message);\n            ws.send(msg, function(){});\n        });\n    });\n\n    // \u30e1\u30c3\u30bb\u30fc\u30b8\u304c\u9001\u4fe1\u3055\u308c\u3066\u304d\u305f\n    ws.addEventListener(\"message\", function(e) {\n        if(e.data != \"\")okuru(e.data);\n    });\n\n    // \u5207\u65ad\u3055\u308c\u305f\n    ws.on(\"close\", function() {\n        // \u914d\u5217\u304b\u3089\u53c2\u52a0\u8005\u3092\u524a\u9664\n        ws_arr.forEach(function (w, i){\n            if(w == ws)ws_arr.splice(i, 1);\n        });\n    });\n});\n\n// DB\u306b\u767b\u9332\u3057\u3066\u53c2\u52a0\u8005\u5168\u54e1\u306b\u53d7\u4fe1\u3055\u305b\u308b\u95a2\u6570\nfunction okuru(msg){\n    msg = msg.substr(0, msg_length); // \u9577\u3055\u306e\u5236\u9650\n\n    // \u30e1\u30c3\u30bb\u30fc\u30b8\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u4f5c\u6210\n    var mes = new Message({\n        message: msg,\n        date: new Date()\n    });\n\n    // \u30ed\u30b0\u8ffd\u52a0\n    mes.save(function(error){\n        if(error)return console.error(error);\n\n        // \u6700\u5927\u4ef6\u6570\u4ee5\u4e0a\u5897\u3048\u305f\u3089\u53e4\u3044\u7269\u3092\u6d88\u3059\u51e6\u7406\uff08\u3053\u3053\u8907\u96d1\u306b\u306a\u3063\u3066\u3057\u307e\u3044\u307e\u3057\u305f\uff09\n        Message.count({}, function(error, count){\n            if(count > msg_limit){ // \u4ef6\u6570\u304c\u591a\u3059\u304e\u308b\u5834\u5408\n                    Message.find() // \u691c\u7d22\uff08\u5168\u3066\uff09\n                        .sort({date: -1}) // \u65e5\u4ed8\u304c\u65b0\u3057\u3044\u9806\n                        .skip(msg_limit) // \u6700\u5927\u4ef6\u6570\u5206\u3068\u3070\u3059\n                        .exec(function(err,res){ // \u5b9f\u884c\u3001\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u306e\u914d\u5217\u304c\u53d6\u5f97\u3067\u304d\u308b\n                            res.forEach(function (d){ // \u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u305d\u308c\u305e\u308c\u306e\n                                Message.remove({_id: d._id}, function(){}); // \uff29\uff24\u304c\u4e00\u81f4\u3059\u308b\u7269\u3092\u524a\u9664\n                            });\n                        });\n            }\n        });\n    });\n\n    // \u30b5\u30cb\u30bf\u30a4\u30ba\n    msg = sanitize_string(msg);\n\n    // \u53c2\u52a0\u8005\u5168\u54e1\u306b\u9001\u308b\n    ws_arr.forEach(function (w){\n        w.send(msg, function(){});\n    });\n}\n\n// \u30b5\u30cb\u30bf\u30a4\u30ba\uff08\u30bf\u30b0\u7b49\u304c\u9001\u4fe1\u3055\u308c\u305f\u6642\u306b\u7121\u52b9\u306b\u3059\u308b\uff09\u95a2\u6570\nfunction sanitize_string(str) {\n    return str\n        .replace(/&/g, '&amp;')\n        .replace(/</g, '&lt;')\n        .replace(/>/g, '&gt;')\n        .replace(/\"/g, '&quot;')\n        .replace(/'/g, '&#39;');\n}\n\n\n\n'Message'\u3068\u3044\u3046\u30e2\u30c7\u30eb\u3078\u4fdd\u5b58\u3059\u308b\u3068\u3001MongoDB\u306e\u300cmessages\u300d\u30b3\u30ec\u30af\u30b7\u30e7\u30f3\u306b\u4fdd\u5b58\u3055\u308c\u308b\u307f\u305f\u3044\u3067\u3059\u3002\n\n\nmessages\u30b3\u30ec\u30af\u30b7\u30e7\u30f3\u304c\u7121\u304f\u3066\u3082\u81ea\u52d5\u3067\u4f5c\u3089\u308c\u307e\u3059\u3002\n\n\n\u4eca\u56de\u306f\u6587\u5b57\u5217\u3092\u305d\u306e\u307e\u307e\u9001\u53d7\u4fe1\u3057\u3066\u3044\u307e\u3059\u304c\u3001\u8907\u6570\u306e\u30c7\u30fc\u30bf\u3092\u3084\u308a\u3068\u308a\u3057\u305f\u3044\u5834\u5408\u306a\u3069\u306f\u3001json\u3092\u6587\u5b57\u5217\u306b\u5909\u63db\u3057\u3066\u9001\u308a\u3001\u53d7\u3051\u53d6\u3063\u305f\u5074\u3067\u30d1\u30fc\u30b9\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n\nJSON.stringify\u3084JSON.parse\u3092\u6d3b\u7528\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n\n\n\u65e9\u901f\u8352\u3089\u3057\u306b\u3042\u3063\u3066\u3057\u307e\u3044\u307e\u3057\u305f\u3002\n\n\n\u30e1\u30c3\u30bb\u30fc\u30b8\u304c\uff12\uff10\u4ef6\u4ee5\u4e0a\u5897\u3048\u305f\u3089\u53e4\u3044\u7269\u3092\u6d88\u3059\u51e6\u7406\u3092\u8ffd\u52a0\u3002\u3053\u308c\u304c\u8907\u96d1\u306a\u51e6\u7406\u306b\u306a\u3063\u3066\u3057\u307e\u3044\u307e\u3057\u305f\u3002\n\u6700\u5927\u6587\u5b57\u6570\u3092\uff16\uff14\u6587\u5b57\u306b\u5236\u9650\u3059\u308b\u51e6\u7406\u3092\u8ffd\u52a0\u3002\n\u672c\u5f53\u306a\u3089\u3001\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u9001\u308c\u308b\u6642\u9593\u306e\u9593\u9694\u306b\u5236\u9650\u3092\u8a2d\u3051\u305f\u307b\u3046\u304c\u3044\u3044\u305d\u3046\u3067\u3059\u3002\u30b3\u30fc\u30c9\u304c\u8907\u96d1\u306b\u306a\u308a\u305d\u3046\u306a\u306e\u3067\u4eca\u56de\u306f\u3084\u308a\u307e\u305b\u3093\u3002\n\n\n\u3053\u306e\u30b3\u30fc\u30c9\u3060\u3068\u3001\u30da\u30fc\u30b8\u3092\u958b\u3044\u305f\u6642\u306b\u904e\u53bb\u30ed\u30b0\u304c\u6642\u7cfb\u5217\u9806\u306b\u4e26\u3070\u306a\u3044\u53ef\u80fd\u6027\u3082\u7121\u304f\u306f\u3042\u308a\u307e\u305b\u3093\u3002\u304c\u3001\u4eca\u56de\u306f\u6587\u5b57\u5217\u3092\u305d\u306e\u307e\u307e\u7c21\u5358\u306b\u3084\u308a\u3068\u308a\u3059\u308b\u3060\u3051\u306e\u30b5\u30f3\u30d7\u30eb\u306b\u3057\u305f\u3044\u306e\u3067\u3001\u3053\u306e\u307e\u307e\u306b\u3057\u307e\u3059\u3002\n\n\n\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u5074\u306ehtml\n\nindex.html\n<!DOCTYPE HTML>\n<html>\n    <head>\n        <meta http-equiv=\"content-type\" content=\"text/html; charset=UTF-8\" />\n        <title>\u30c1\u30e3\u30c3\u30c8\u30b5\u30f3\u30d7\u30eb</title>\n        <meta http-equiv=\"content-style-type\" content=\"text/css\" />\n        <meta name=\"viewport\" content=\"width=device-width\" />\n        <meta name=\"keywords\" content=\"\" />\n        <meta name=\"description\" content=\"\" />\n        <meta name=\"theme-color\" content=\"#FFAA00\">\n        <link rel=\"SHORTCUT ICON\" href=\"./favicon.png\" />\n        <link rel=\"stylesheet\" type=\"text/css\" href=\"./style.css\" />\n    </head>\n    <body>\n        <h1>\u30c1\u30e3\u30c3\u30c8\u30b5\u30f3\u30d7\u30eb</h1>\n\n        <ul id=\"messages\"></ul>\n\n        <input type=\"text\" value=\"\" id=\"message\" />\n        <input type=\"button\" value=\"\u9001\u4fe1\" onclick=\"soshin();\" />\n\n\n        <script>\n            var host = location.origin.replace(/^http/, 'ws');\n            var ws = new WebSocket(host);\n            var msg_limit = 20;\n\n            // \u30e1\u30c3\u30bb\u30fc\u30b8\u306e\u53d7\u4fe1\n            ws.addEventListener('message', function (e) {\n                var li = document.createElement('li');\n                li.innerHTML = e.data;\n                var messages = document.getElementById('messages');\n                messages.appendChild(li);\n                while(messages.childNodes.length > msg_limit){ // \u30ed\u30b0\u304c\u591a\u3059\u304e\u308b\u5834\u5408\u306b\u524a\u9664\n                    messages.removeChild(messages.firstChild);\n                }\n            });\n\n            // \u30e1\u30c3\u30bb\u30fc\u30b8\u306e\u9001\u4fe1\n            function soshin(){\n                var message = document.getElementById('message');\n                ws.send(message.value,function(){}); // \u9001\u4fe1\n                message.value = '';\n            }\n\n            // \uff11\uff10\u79d2\u3054\u3068\u306b\u7a7a\u306e\u6587\u5b57\u5217\u3092\u9001\u4fe1\uff08\u3053\u3046\u3057\u306a\u3044\u3068\u306a\u305c\u304b\u5207\u65ad\u3055\u308c\u3066\u3057\u307e\u3046\uff09\n            setInterval(function(){ws.send('', function(){});}, 10000);\n        </script>\n    </body>\n</html>\n\n\n\n\u30b5\u30fc\u30d0\u30fc\u304c\u6570\u5341\u79d2\u9593\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u53d7\u4fe1\u3057\u306a\u3044\u3068\u5207\u65ad\u3059\u308b\u7406\u7531\u306f\u308f\u304b\u308a\u307e\u305b\u3093\u3002\u305d\u3046\u3044\u3046\u4ed5\u69d8\u3089\u3057\u3044\u3067\u3059\u3002\nstyle.css\u3084favicon.png\u307e\u3067\u8aad\u307f\u8fbc\u3093\u3067\u3044\u307e\u3059\u304c\u3001\u81ea\u524d\u3067\u7528\u610f\u3059\u308b\u304b\u3001\u30bf\u30b0\u3092\u6d88\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n\n\u30d1\u30c3\u30b1\u30fc\u30b8json\n\npackage.json\n{\n    \"name\": \"nwmsample\",\n    \"version\": \"0.0.5\",\n    \"dependencies\": {\n        \"express\": \"*\",\n        \"ws\": \"*\",\n        \"mongoose\": \"*\"\n    },\n    \"engines\": {\n        \"node\": \"*\"\n    },\n    \"scripts\": {\n        \"start\": \"node index.js\"\n    }\n}\n\n\n\n\u672c\u5f53\u306f\u30d0\u30fc\u30b8\u30e7\u30f3\u3092\"*\"\u306b\u3059\u308b\u306e\u306f\u3088\u304f\u306a\u3044\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u304c\u3001\u6700\u65b0\u7248\u304c\u308f\u304b\u3089\u306a\u304b\u3063\u305f\u306e\u3067\u3053\u3046\u3057\u3066\u3044\u307e\u3059\u3002\n\n\n\u30d7\u30ed\u30d5\u30a1\u30a4\u30eb\n\nprofile\nweb: node index.js\n\n\n\n\u62e1\u5f35\u5b50\u306e\u7121\u3044\u30d5\u30a1\u30a4\u30eb\u3067\u3059\u3002\u30b5\u30fc\u30d0\u30fc\u3067\u8d77\u52d5\u3059\u308bjs\u306e\u540d\u524d\u3092\u66f8\u3044\u3066\u304a\u304d\u307e\u3059\u3002\n\n\n\u304a\u308f\u308a\u306b\n\u306a\u3093\u3068\u304b\u5b8c\u6210\u3057\u3066\u3088\u304b\u3063\u305f\u3067\u3059\u3002\n\u53c2\u8003\u306b\u306a\u308c\u308c\u3070\u3046\u308c\u3057\u3044\u3067\u3059\u3002\n\u8cea\u554f\u306a\u3069\u3042\u308c\u3070\u3001\u7b54\u3048\u3089\u308c\u308b\u7bc4\u56f2\u3067\u7b54\u3048\u307e\u3059\uff08\u8fd4\u4fe1\u9045\u308c\u305f\u3089\u3059\u307f\u307e\u305b\u3093\uff09\u3002\n# \u306f\u3058\u3081\u306b\n\u52d5\u3044\u3066\u3044\u308b\u30b5\u30f3\u30d7\u30eb \u2192 https://nwmsample.herokuapp.com/\n\n\u8abf\u3079\u308b\u306e\u304c\u5927\u5909\u3060\u3063\u305f\u306e\u3067\u3053\u3053\u306b\u66f8\u3044\u3066\u304a\u304d\u307e\u3059\u3002\n\u4f55\u304b\u9593\u9055\u3063\u3066\u3044\u305f\u3089\u6559\u3048\u3066\u3044\u305f\u3060\u3051\u308b\u3068\u5e78\u3044\u3067\u3059\u3002\n\u8457\u8005\u306e\u6027\u683c\u4e0a\u3001\u8aac\u660e\u306f\u30a2\u30d0\u30a6\u30c8\u3067\u3059\u3002\n\n## \u30c1\u30e3\u30c3\u30c8\u306e\u4ed5\u69d8\n- \u3042\u304f\u307e\u3067\u30b7\u30f3\u30d7\u30eb\u306b\u3002\n- \u5358\u306b\u30ed\u30b0\u3092\u66f8\u304d\u6b8b\u305b\u308b\u3060\u3051\u306e\u30b5\u30f3\u30d7\u30eb\u3002\n- \u65b0\u3057\u3044\u30ed\u30b0\u3092\u30ea\u30a2\u30eb\u30bf\u30a4\u30e0\u306b\u8868\u793a\u3002\n- \u904e\u53bb\u306e\u30ed\u30b0\u3082\u898b\u308c\u308b\u3002\n - \u6700\u65b0\u306e\uff12\uff10\u4ef6\u307e\u3067\u4fdd\u5b58\u3002\n- \u5165\u9000\u51fa\u306f\u7121\u3057\u3001\u9001\u4fe1\u8005\u540d\u306a\u3069\u3082\u7121\u3057\u3002\n\n## \u4f7f\u3063\u305f\u6280\u8853\n\u9069\u5f53\u3067\u3059\u304c\u7d39\u4ecb\u3002\n\n### Heroku\n- **Web\u30a2\u30d7\u30ea\u3092\u7c21\u5358\u306b\u516c\u958b\u3067\u304d\u308b**\u30b5\u30fc\u30d3\u30b9\u3067\u3059\u3002\n- \u7121\u6599\u3067\u3082\u4f7f\u3048\u307e\u3059\u304c\u3001\u5236\u9650\u306f\u3042\u308a\u307e\u3059\u3002\n- \u82f1\u8a9e\u3002\n\n### Node.js\n- **\u30b5\u30fc\u30d0\u30fc\u5074\u3067\u52d5\u304f**JavaScript\u74b0\u5883\u306e\u4e8b\u3067\u3059\u3002\n- \u5fc5\u8981\u4e0d\u53ef\u6b20\u3067\u3059\u3002\n\n### WebSocket\n- \u30ea\u30a2\u30eb\u30bf\u30a4\u30e0\u306b\u30b5\u30fc\u30d0\u30fc\u304c\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u3068\u901a\u4fe1\u3059\u308b\u305f\u3081\u306b\u5fc5\u8981\u3067\u3059\u3002\n- **\u30b5\u30fc\u30d0\u30fc\u304b\u3089\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u306b\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u9001\u308b**\u3068\u3044\u3063\u305f\u4e8b\u304c\u53ef\u80fd\u306b\u306a\u308a\u307e\u3059\u3002\n- \u4eca\u56de\u306f\u3001\u65b0\u3057\u304f\u5165\u5ba4\u3057\u305f\u4eba\u306b\u904e\u53bb\u30ed\u30b0\u3092\u9001\u3063\u305f\u308a\u3001\u8ab0\u304b\u304c\u9001\u4fe1\u3057\u305f\u30ed\u30b0\u3092\u53c2\u52a0\u8005\u5168\u54e1\u306b\u9001\u308b\u51e6\u7406\u306b\u4f7f\u3063\u3066\u3044\u307e\u3059\u3002\n\n### MongoDB (mLab)\n- \u7c21\u5358\u306b\u8a00\u3048\u3070\u30b5\u30fc\u30d0\u30fc\u5074\u3067**\u30c7\u30fc\u30bf\u306e\u4fdd\u5b58\u3084\u691c\u7d22\u306a\u3069**\u306b\u4f7f\u3044\u307e\u3059\u3002\n- \u4eca\u56de\u306f\u3001\u6700\u5927\uff12\uff10\u4ef6\u306e\u904e\u53bb\u30ed\u30b0\u306e\u4fdd\u5b58\u306b\u4f7f\u3063\u3066\u3044\u307e\u3059\u3002\n - \u3053\u308c\u304c\u7121\u3044\u3068\u3001\u65b0\u3057\u304f\u30c1\u30e3\u30c3\u30c8\u306b\u6765\u305f\u4eba\u304c\u3001\u6765\u305f\u4ee5\u524d\u306e\u30ed\u30b0\u3092\u53d6\u5f97\u3067\u304d\u307e\u305b\u3093\u3002\n- JavaScript\u3068\u76f8\u6027\u304c\u3044\u3044\u3067\u3059\u3002\n- Heroku\u3067MongoDB\u3092\u4f7f\u3046\u306b\u306fmLab\uff08\u5143MongoLAB\uff09\u3068\u3044\u3046\u30a2\u30c9\u30aa\u30f3\u304c\u5fc5\u8981\u3067\u3059\u3002\n - \u7121\u6599\u3067\u4f7f\u3046\u5834\u5408\u306b\u3082\u30af\u30ec\u30b8\u30c3\u30c8\u30ab\u30fc\u30c9\u3084\u30c7\u30d3\u30c3\u30c8\u30ab\u30fc\u30c9\u306e\u767b\u9332\u304c\u5fc5\u8981\u3067\u3059\u3002\n - \u3084\u306f\u308a\u82f1\u8a9e\u3002\n- Mongoose\u3068\u3044\u3046\u30e9\u30a4\u30d6\u30e9\u30ea\u3092\u4f7f\u7528\u3002\u7406\u7531\u306f\u7c21\u5358\u3089\u3057\u3044\u304b\u3089\u3002\n\n# \u30b3\u30fc\u30c9\n\n## \u30b5\u30fc\u30d0\u30fc\u5074\u306ejs\n```js:index.js\nvar WebSocketServer = require(\"ws\").Server;\nvar http = require(\"http\");\nvar express = require(\"express\");\nvar app = express();\nvar port = process.env.PORT;\napp.use(express.static(__dirname + \"/\"));\nvar server = http.createServer(app);\nserver.listen(port);\nvar wss = new WebSocketServer({server: server});\nvar mongoose = require (\"mongoose\");\nvar mongo_uri = process.env.MONGODB_URI;\nmongoose.connect(mongo_uri);\n\n\nvar ws_arr = []; // \u53c2\u52a0\u8005\u914d\u5217\nvar msg_limit = 20; // \u30ed\u30b0\u6570\u306e\u5236\u9650\nvar msg_length = 64; // \u30ed\u30b0\u306e\u6587\u5b57\u6570\u5236\u9650\n\n// mongoose\u306e\u30b9\u30ad\u30fc\u30de\u3092\u4f5c\u6210\nvar message_schema = new mongoose.Schema({\n\tmessage: String,\n\tdate: Date\n});\n// mongoose\u306eMessage\u30e2\u30c7\u30eb\u3092\u53d6\u5f97\nvar Message = mongoose.model('Message', message_schema);\n\n// \u8ab0\u304b\u304c\u53c2\u52a0\u3057\u305f\nwss.on(\"connection\", function(ws) {\n\tws_arr.push(ws); // \u53c2\u52a0\u8005\u3092\u914d\u5217\u306b\u8ffd\u52a0\n\t\n\t// \u6700\u521d\u306b\u904e\u53bb\u30ed\u30b0\u3092\u5168\u3066\u9001\u308b\n\tMessage.find({}, {}, {sort: {date: 1}}, function (error, messages) {\n\t\tif(error)return console.error(error);\n\t\tmessages.forEach(function (m){\n\t\t\tvar msg = sanitize_string(m.message);\n\t\t\tws.send(msg, function(){});\n\t\t});\n\t});\n\n\t// \u30e1\u30c3\u30bb\u30fc\u30b8\u304c\u9001\u4fe1\u3055\u308c\u3066\u304d\u305f\n\tws.addEventListener(\"message\", function(e) {\n\t\tif(e.data != \"\")okuru(e.data);\n\t});\n\t\n\t// \u5207\u65ad\u3055\u308c\u305f\n\tws.on(\"close\", function() {\n\t\t// \u914d\u5217\u304b\u3089\u53c2\u52a0\u8005\u3092\u524a\u9664\n\t\tws_arr.forEach(function (w, i){\n\t\t\tif(w == ws)ws_arr.splice(i, 1);\n\t\t});\n\t});\n});\n\n// DB\u306b\u767b\u9332\u3057\u3066\u53c2\u52a0\u8005\u5168\u54e1\u306b\u53d7\u4fe1\u3055\u305b\u308b\u95a2\u6570\nfunction okuru(msg){\n\tmsg = msg.substr(0, msg_length); // \u9577\u3055\u306e\u5236\u9650\n\t\n\t// \u30e1\u30c3\u30bb\u30fc\u30b8\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u4f5c\u6210\n\tvar mes = new Message({\n\t\tmessage: msg,\n\t\tdate: new Date()\n\t});\n\t\n\t// \u30ed\u30b0\u8ffd\u52a0\n\tmes.save(function(error){\n\t\tif(error)return console.error(error);\n\t\t\n\t\t// \u6700\u5927\u4ef6\u6570\u4ee5\u4e0a\u5897\u3048\u305f\u3089\u53e4\u3044\u7269\u3092\u6d88\u3059\u51e6\u7406\uff08\u3053\u3053\u8907\u96d1\u306b\u306a\u3063\u3066\u3057\u307e\u3044\u307e\u3057\u305f\uff09\n\t\tMessage.count({}, function(error, count){\n\t\t\tif(count > msg_limit){ // \u4ef6\u6570\u304c\u591a\u3059\u304e\u308b\u5834\u5408\n\t\t\t\t\tMessage.find() // \u691c\u7d22\uff08\u5168\u3066\uff09\n\t\t\t\t\t\t.sort({date: -1}) // \u65e5\u4ed8\u304c\u65b0\u3057\u3044\u9806\n\t\t\t\t\t\t.skip(msg_limit) // \u6700\u5927\u4ef6\u6570\u5206\u3068\u3070\u3059\n\t\t\t\t\t\t.exec(function(err,res){ // \u5b9f\u884c\u3001\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u306e\u914d\u5217\u304c\u53d6\u5f97\u3067\u304d\u308b\n\t\t\t\t\t\t\tres.forEach(function (d){ // \u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u305d\u308c\u305e\u308c\u306e\n\t\t\t\t\t\t\t\tMessage.remove({_id: d._id}, function(){}); // \uff29\uff24\u304c\u4e00\u81f4\u3059\u308b\u7269\u3092\u524a\u9664\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t});\n\t\t\t}\n\t\t});\n\t});\n\t\n\t// \u30b5\u30cb\u30bf\u30a4\u30ba\n\tmsg = sanitize_string(msg);\n\t\n\t// \u53c2\u52a0\u8005\u5168\u54e1\u306b\u9001\u308b\n\tws_arr.forEach(function (w){\n\t\tw.send(msg, function(){});\n\t});\n}\n\n// \u30b5\u30cb\u30bf\u30a4\u30ba\uff08\u30bf\u30b0\u7b49\u304c\u9001\u4fe1\u3055\u308c\u305f\u6642\u306b\u7121\u52b9\u306b\u3059\u308b\uff09\u95a2\u6570\nfunction sanitize_string(str) {\n\treturn str\n\t\t.replace(/&/g, '&amp;')\n\t\t.replace(/</g, '&lt;')\n\t\t.replace(/>/g, '&gt;')\n\t\t.replace(/\"/g, '&quot;')\n\t\t.replace(/'/g, '&#39;');\n}\n```\n- 'Message'\u3068\u3044\u3046\u30e2\u30c7\u30eb\u3078\u4fdd\u5b58\u3059\u308b\u3068\u3001MongoDB\u306e\u300cmessages\u300d\u30b3\u30ec\u30af\u30b7\u30e7\u30f3\u306b\u4fdd\u5b58\u3055\u308c\u308b\u307f\u305f\u3044\u3067\u3059\u3002\n - messages\u30b3\u30ec\u30af\u30b7\u30e7\u30f3\u304c\u7121\u304f\u3066\u3082\u81ea\u52d5\u3067\u4f5c\u3089\u308c\u307e\u3059\u3002\n- \u4eca\u56de\u306f\u6587\u5b57\u5217\u3092\u305d\u306e\u307e\u307e\u9001\u53d7\u4fe1\u3057\u3066\u3044\u307e\u3059\u304c\u3001\u8907\u6570\u306e\u30c7\u30fc\u30bf\u3092\u3084\u308a\u3068\u308a\u3057\u305f\u3044\u5834\u5408\u306a\u3069\u306f\u3001json\u3092\u6587\u5b57\u5217\u306b\u5909\u63db\u3057\u3066\u9001\u308a\u3001\u53d7\u3051\u53d6\u3063\u305f\u5074\u3067\u30d1\u30fc\u30b9\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n - JSON.stringify\u3084JSON.parse\u3092\u6d3b\u7528\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n- **\u65e9\u901f\u8352\u3089\u3057\u306b\u3042\u3063\u3066\u3057\u307e\u3044\u307e\u3057\u305f**\u3002\n - \u30e1\u30c3\u30bb\u30fc\u30b8\u304c\uff12\uff10\u4ef6\u4ee5\u4e0a\u5897\u3048\u305f\u3089\u53e4\u3044\u7269\u3092\u6d88\u3059\u51e6\u7406\u3092\u8ffd\u52a0\u3002\u3053\u308c\u304c\u8907\u96d1\u306a\u51e6\u7406\u306b\u306a\u3063\u3066\u3057\u307e\u3044\u307e\u3057\u305f\u3002\n - \u6700\u5927\u6587\u5b57\u6570\u3092\uff16\uff14\u6587\u5b57\u306b\u5236\u9650\u3059\u308b\u51e6\u7406\u3092\u8ffd\u52a0\u3002\n - \u672c\u5f53\u306a\u3089\u3001**\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u9001\u308c\u308b\u6642\u9593\u306e\u9593\u9694\u306b\u5236\u9650\u3092\u8a2d\u3051\u305f\u307b\u3046\u304c\u3044\u3044**\u305d\u3046\u3067\u3059\u3002\u30b3\u30fc\u30c9\u304c\u8907\u96d1\u306b\u306a\u308a\u305d\u3046\u306a\u306e\u3067\u4eca\u56de\u306f\u3084\u308a\u307e\u305b\u3093\u3002\n- \u3053\u306e\u30b3\u30fc\u30c9\u3060\u3068\u3001**\u30da\u30fc\u30b8\u3092\u958b\u3044\u305f\u6642\u306b\u904e\u53bb\u30ed\u30b0\u304c\u6642\u7cfb\u5217\u9806\u306b\u4e26\u3070\u306a\u3044\u53ef\u80fd\u6027\u3082\u7121\u304f\u306f\u3042\u308a\u307e\u305b\u3093**\u3002\u304c\u3001\u4eca\u56de\u306f\u6587\u5b57\u5217\u3092\u305d\u306e\u307e\u307e\u7c21\u5358\u306b\u3084\u308a\u3068\u308a\u3059\u308b\u3060\u3051\u306e\u30b5\u30f3\u30d7\u30eb\u306b\u3057\u305f\u3044\u306e\u3067\u3001\u3053\u306e\u307e\u307e\u306b\u3057\u307e\u3059\u3002\n\n## \u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u5074\u306ehtml\n```html:index.html\n<!DOCTYPE HTML>\n<html>\n\t<head>\n\t\t<meta http-equiv=\"content-type\" content=\"text/html; charset=UTF-8\" />\n\t\t<title>\u30c1\u30e3\u30c3\u30c8\u30b5\u30f3\u30d7\u30eb</title>\n\t\t<meta http-equiv=\"content-style-type\" content=\"text/css\" />\n\t\t<meta name=\"viewport\" content=\"width=device-width\" />\n\t\t<meta name=\"keywords\" content=\"\" />\n\t\t<meta name=\"description\" content=\"\" />\n\t\t<meta name=\"theme-color\" content=\"#FFAA00\">\n\t\t<link rel=\"SHORTCUT ICON\" href=\"./favicon.png\" />\n\t\t<link rel=\"stylesheet\" type=\"text/css\" href=\"./style.css\" />\n\t</head>\n\t<body>\n\t\t<h1>\u30c1\u30e3\u30c3\u30c8\u30b5\u30f3\u30d7\u30eb</h1>\n\t\t\n\t\t<ul id=\"messages\"></ul>\n\t\t\n\t\t<input type=\"text\" value=\"\" id=\"message\" />\n\t\t<input type=\"button\" value=\"\u9001\u4fe1\" onclick=\"soshin();\" />\n\t\t\n\t\t\n\t\t<script>\n\t\t\tvar host = location.origin.replace(/^http/, 'ws');\n\t\t\tvar ws = new WebSocket(host);\n\t\t\tvar msg_limit = 20;\n\t\t\t\n\t\t\t// \u30e1\u30c3\u30bb\u30fc\u30b8\u306e\u53d7\u4fe1\n\t\t\tws.addEventListener('message', function (e) {\n\t\t\t\tvar li = document.createElement('li');\n\t\t\t\tli.innerHTML = e.data;\n\t\t\t\tvar messages = document.getElementById('messages');\n\t\t\t\tmessages.appendChild(li);\n\t\t\t\twhile(messages.childNodes.length > msg_limit){ // \u30ed\u30b0\u304c\u591a\u3059\u304e\u308b\u5834\u5408\u306b\u524a\u9664\n\t\t\t\t\tmessages.removeChild(messages.firstChild);\n\t\t\t\t}\n\t\t\t});\n\t\t\t\n\t\t\t// \u30e1\u30c3\u30bb\u30fc\u30b8\u306e\u9001\u4fe1\n\t\t\tfunction soshin(){\n\t\t\t\tvar message = document.getElementById('message');\n\t\t\t\tws.send(message.value,function(){}); // \u9001\u4fe1\n\t\t\t\tmessage.value = '';\n\t\t\t}\n\t\t\t\n\t\t\t// \uff11\uff10\u79d2\u3054\u3068\u306b\u7a7a\u306e\u6587\u5b57\u5217\u3092\u9001\u4fe1\uff08\u3053\u3046\u3057\u306a\u3044\u3068\u306a\u305c\u304b\u5207\u65ad\u3055\u308c\u3066\u3057\u307e\u3046\uff09\n\t\t\tsetInterval(function(){ws.send('', function(){});}, 10000);\n\t\t</script>\n\t</body>\n</html>\n```\n- \u30b5\u30fc\u30d0\u30fc\u304c\u6570\u5341\u79d2\u9593\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u53d7\u4fe1\u3057\u306a\u3044\u3068\u5207\u65ad\u3059\u308b\u7406\u7531\u306f\u308f\u304b\u308a\u307e\u305b\u3093\u3002\u305d\u3046\u3044\u3046\u4ed5\u69d8\u3089\u3057\u3044\u3067\u3059\u3002\n- style.css\u3084favicon.png\u307e\u3067\u8aad\u307f\u8fbc\u3093\u3067\u3044\u307e\u3059\u304c\u3001\u81ea\u524d\u3067\u7528\u610f\u3059\u308b\u304b\u3001\u30bf\u30b0\u3092\u6d88\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n## \u30d1\u30c3\u30b1\u30fc\u30b8json\n```json:package.json\n{\n\t\"name\": \"nwmsample\",\n\t\"version\": \"0.0.5\",\n\t\"dependencies\": {\n\t\t\"express\": \"*\",\n\t\t\"ws\": \"*\",\n\t\t\"mongoose\": \"*\"\n\t},\n\t\"engines\": {\n\t\t\"node\": \"*\"\n\t},\n\t\"scripts\": {\n\t\t\"start\": \"node index.js\"\n\t}\n}\n```\n- \u672c\u5f53\u306f\u30d0\u30fc\u30b8\u30e7\u30f3\u3092\"*\"\u306b\u3059\u308b\u306e\u306f\u3088\u304f\u306a\u3044\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u304c\u3001\u6700\u65b0\u7248\u304c\u308f\u304b\u3089\u306a\u304b\u3063\u305f\u306e\u3067\u3053\u3046\u3057\u3066\u3044\u307e\u3059\u3002\n\n## \u30d7\u30ed\u30d5\u30a1\u30a4\u30eb\n```:profile\nweb: node index.js\n```\n- \u62e1\u5f35\u5b50\u306e\u7121\u3044\u30d5\u30a1\u30a4\u30eb\u3067\u3059\u3002\u30b5\u30fc\u30d0\u30fc\u3067\u8d77\u52d5\u3059\u308bjs\u306e\u540d\u524d\u3092\u66f8\u3044\u3066\u304a\u304d\u307e\u3059\u3002\n\n# \u304a\u308f\u308a\u306b\n\u306a\u3093\u3068\u304b\u5b8c\u6210\u3057\u3066\u3088\u304b\u3063\u305f\u3067\u3059\u3002\n\n\u53c2\u8003\u306b\u306a\u308c\u308c\u3070\u3046\u308c\u3057\u3044\u3067\u3059\u3002\n\u8cea\u554f\u306a\u3069\u3042\u308c\u3070\u3001\u7b54\u3048\u3089\u308c\u308b\u7bc4\u56f2\u3067\u7b54\u3048\u307e\u3059\uff08\u8fd4\u4fe1\u9045\u308c\u305f\u3089\u3059\u307f\u307e\u305b\u3093\uff09\u3002\n"}