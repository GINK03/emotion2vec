{"context": "\n\u57fa\u672c\u8a2d\u8a08\u3001\u30e6\u30fc\u30b6\u30fc\u30e2\u30c7\u30eb\n\u30aa\u30fc\u30c8\u30ed\u30fc\u30c0\u30fc\n\u4f8b\u5916\u30fb\u30ed\u30b0\n\nPDO \u30b7\u30f3\u30b0\u30eb\u30c8\u30f3\u3000SQL\u30a4\u30f3\u30b8\u30a7\u30af\u30b7\u30e7\u30f3\n\n\u6c4e\u7528\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u30fb\u30af\u30e9\u30b9\u4f5c\u6210\n\n\n\u30e6\u30fc\u30b6\u30fc\u30e2\u30c7\u30eb\u306e\u4f5c\u6210\n\u30af\u30e9\u30b9\u306e\u7d99\u627f\n\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u30fb\u30af\u30e9\u30b9\u306e\u5b9f\u88c5\n\u30a2\u30ab\u30a6\u30f3\u30c8\u30ed\u30c3\u30af\u6a5f\u80fd\u306e\u5b9f\u88c5\n\u30e1\u30fc\u30eb\u9001\u4fe1\u6a5f\u80fd\u306e\u5b9f\u88c5\n\u30a2\u30ab\u30a6\u30f3\u30c8\u30ed\u30c3\u30af\u89e3\u9664\u6a5f\u80fd\u306e\u5b9f\u88c5\nCSRF\u5bfe\u7b56\n\nCSRF(\u30af\u30ed\u30b9\u30b5\u30a4\u30c8\u30ea\u30af\u30a8\u30b9\u30c8\u30d5\u30a9\u30fc\u30b8\u30a7\u30ea) \u5bfe\u7b56\u306b\u3064\u3044\u3066\u306fwiki\u3092\u53c2\u7167\u304f\u3060\u3055\u3044\u3002\n\u3064\u307e\u308a\u306f\u3001<form> \u304b\u3089\u4f55\u3089\u304b\u306e\u5024\u3092\u9001\u4fe1\u3057\u3066\u3001\u30b5\u30fc\u30d0\u30fc\u306b\u51e6\u7406\u3055\u305b\u308b\u5834\u5408\u3001\u3053\u306e\u5bfe\u7b56\u3092\u6020\u3089\u306a\u3044\u3088\u3046\u306b\u3057\u307e\u3057\u3087\u3046\u3068\u3044\u3046\u3053\u3068\u3002\n\u57fa\u672c\u7684\u306b\u306f\u3001form \u306e\u5185\u90e8\u306b\u3001<input type=\"hidden\"> \u3067\u5024\u3092\u9001\u4fe1\u3057\u3001SESSION\u306b\u4fdd\u5b58\u3055\u308c\u305f\u5024\u3068\u4e00\u81f4\u3059\u308b\u304b\u3069\u3046\u304b\u3092\u78ba\u8a8d\u3059\u308b\u3002\n\u3053\u306eCSRF\u5bfe\u7b56\u306b\u306f\u3001\u4e8c\u91cd\u9001\u4fe1\u3092\u9632\u6b62\u3059\u308b\u3068\u3044\u3046\u526f\u7523\u7269\u3082\u3042\u308a\u3001\u6b63\u898f\u30e6\u30fc\u30b6\u30fc\u306b\u5bfe\u3057\u3066\u306f\u3001\u300cCSRF\u3092\u691c\u77e5\u3057\u305f\u306e\u3067\u3001\u51e6\u7406\u3092\u4e2d\u65ad\u3057\u307e\u3057\u305f\u300d\u3068\u3044\u3046\u3088\u3046\u306a\u300c\u4e0d\u6b63\u300d\u3092\u8868\u73fe\u3059\u308b\u306e\u3067\u306f\u306a\u304f\u3001\u300c\u4e8c\u91cd\u9001\u4fe1\u3055\u308c\u305f\u306e\u3067\u51e6\u7406\u3092\u4e2d\u65ad\u3057\u307e\u3057\u305f\u3002\u300d\u306e\u3088\u3046\u306a\u30e1\u30c3\u30bb\u30fc\u30b8\u306b\u3059\u308b\u3068\u826f\u3044\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u3002\n\n\u5b9f\u88c5\nclasses/common/Csrf.class.php\u306bCsrf\u30af\u30e9\u30b9\u3092\u5b9a\u7fa9\u3057\u307e\u3057\u305f\u3002\n\nclasses/common/Csrf.class.php\n\nclasses/common/Csrf.class.php\n<?php\n\nnamespace MyApp\\common;\n\n/**\n * Csrf.class.php\n */\nclass Csrf\n{\n\n    /**\n     * \u30c8\u30fc\u30af\u30f3\n     * @var string\n     */\n    private static $token = null;\n\n    /**\n     * \u521d\u671f\u5316\n     */\n    private static function init()\n    {\n        self::$token = sha1(uniqid());\n    }\n\n    /**\n     * CSRF\u7528\u306b\u30c8\u30fc\u30af\u30f3\u3092\u751f\u6210\u3059\u308b\n     * @return string\n     */\n    public static function get()\n    {\n        if (is_null(self::$token)) {\n            self::init();\n        }\n        $_SESSION['csrf_token'] = self::$token;\n        return self::$token;\n    }\n\n    /**\n     * CSRF\u3092\u30c1\u30a7\u30c3\u30af\u3059\u308b\n     * @return boolean\n     * @throws ApplicationErrorException\n     */\n    public static function check()\n    {\n        $csrf_token = (isset($_SESSION['csrf_token'])) ? $_SESSION['csrf_token'] : null;\n        $_SESSION['csrf_token'] = null;\n\n        if (filter_input(INPUT_POST, 'csrf_token') !== $csrf_token) {\n            // \u4e8c\u91cd\u9001\u4fe1\u3055\u308c\u305f\u306e\u3067\u51e6\u7406\u3092\u4e2d\u65ad\u3057\u307e\u3057\u305f\u3002\n            throw new InvalidErrorException(ExceptionCode::INVALID_CSRF_ERR);\n        }\n        return true;\n    }\n\n}\n\n\n\nclasses/common/ExceptionCode.class.php\n\nclasses/common/ExceptionCode.class.php\n<?php\n\nnamespace MyApp\\common;\n\n/**\n * ExceptionCode.class.php\n * @since 2015/07/25\n */\nclass ExceptionCode\n{\n\n    /**\n     * InvalidError\n     */\n    const INVALID_ERR = 1000;\n    const INVALID_LOCK = 1001;\n    const INVALID_LOGIN_FAIL = 1002;\n    const ARGUMENT_REQUIRED = 1003;\n    const INVALID_CSRF_ERR = 1004;\n\n    /**\n     * ApplicationError\n     */\n    const APPLICATION_ERR = 2000;\n\n    /**\n     * SystemError\n     */\n    const SYSTEM_ERR = 3000;\n    const TEMPLATE_ERR = 3001;\n    const TEMPLATE_ARG_ERR = 3002;\n\n    /**\n     * \u30a8\u30e9\u30fc\u30e1\u30c3\u30bb\u30fc\u30b8\n     * @var array<string>\n     */\n    private static $_arrMessage = array(\n        self::INVALID_ERR => '\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3057\u307e\u3057\u305f\u3002'\n        , self::INVALID_LOCK => '\u30a2\u30ab\u30a6\u30f3\u30c8\u304c\u30ed\u30c3\u30af\u3055\u308c\u3066\u3044\u307e\u3059\u3002'\n        , self::INVALID_LOGIN_FAIL => '\u30ed\u30b0\u30a4\u30f3\u306b\u5931\u6557\u3057\u307e\u3057\u305f\u3002'\n        , self::INVALID_CSRF_ERR => '\u4e8c\u91cd\u9001\u4fe1\u3055\u308c\u305f\u306e\u3067\u51e6\u7406\u3092\u4e2d\u65ad\u3057\u307e\u3057\u305f\u3002'\n        , self::ARGUMENT_REQUIRED => '\u30e1\u30fc\u30eb\u30a2\u30c9\u30ec\u30b9\u304a\u3088\u3073\u30d1\u30b9\u30ef\u30fc\u30c9\u306f\u5165\u529b\u5fc5\u9808\u3067\u3059\u3002'\n        , self::APPLICATION_ERR => '\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30fb\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3057\u307e\u3057\u305f\u3002'\n        , self::SYSTEM_ERR => '\u30b7\u30b9\u30c6\u30e0\u30fb\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3057\u307e\u3057\u305f\u3002'\n        , self::TEMPLATE_ERR => '\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8[%s]\u304c\u898b\u3064\u304b\u308a\u307e\u305b\u3093\u3002'\n        , self::TEMPLATE_ARG_ERR => '\u5f15\u6570\u306b[%s]\u306f\u5229\u7528\u3067\u304d\u307e\u305b\u3093\u3002'\n    );\n\n    /**\n     * \u30a8\u30e9\u30fc\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u53d6\u5f97\u3059\u308b\n     * @param int $intCode\n     * @return string\n     */\n    static public function getMessage($intCode)\n    {\n        if (array_key_exists($intCode, self::$_arrMessage)) {\n            return self::$_arrMessage[$intCode];\n        }\n    }\n\n}\n\n\n\n\u5229\u7528\u65b9\u6cd5\n\u524d\u8ff0\u306e\u3088\u3046\u306b\u3001form \u306e\u4e2d\u306b hidden \u3067\u6885\u5b50\u898b\u308b\u306e\u3067\u3059\u304b\u3089\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u4f7f\u3044\u65b9\u306b\u306a\u308a\u307e\u3059\u3002\n<form method=\"post\">\n\n    // \u305d\u306e\u4ed6\u306e\u30d5\u30a9\u30fc\u30e0\u90e8\u54c1\n\n    <input type=\"hidden\" name=\"csrf_token\" value=\"<?= Csrf::get(); ?>\">\n</form>\n\n\u57fa\u672c\u7684\u306b form \u3092\u5229\u7528\u3059\u308b\u3068\u3053\u308d\u306b\u306f\u3001CSRF\u5bfe\u7b56\u3092\u65bd\u3059\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u304c\u3001\u958b\u767a\u30e1\u30f3\u30d0\u30fc\u306e\u5168\u54e1\u304c CSRF\u306b\u3064\u3044\u3066\u7406\u89e3\u3057\u305f\u4e0a\u3067\u3001\u5229\u7528\u3057\u3066\u3044\u308b\u3068\u306f\u9650\u308a\u307e\u305b\u3093\u3002\u300c\u51e6\u7406\u306b\u95a2\u4fc2\u306a\u3044\u5024\u300d\u3068\u601d\u3063\u3066\u308f\u3056\u308f\u3056\u524a\u9664\u3057\u3066\u3057\u307e\u308f\u306a\u3044\u3068\u3082\u9650\u308a\u307e\u305b\u3093\u3002\u591a\u304f\u306e\u30d5\u30ec\u30fc\u30e0\u30ef\u30fc\u30af\u3067\u3001\u305f\u304b\u3060\u304b <form> \u3092\u751f\u6210\u3059\u308b\u305f\u3081\u306e\u30d8\u30eb\u30d1\u30fc\u30e1\u30bd\u30c3\u30c9\u304c\u7528\u610f\u3055\u308c\u3066\u3044\u308b\u306b\u306f\u3001\u7406\u7531\u304c\u3042\u308a\u3001\u3053\u306e CSRF\u5bfe\u7b56\u304c form\u30d8\u30eb\u30d1\u30fc\u3067\u81ea\u52d5\u7684\u306b\u4ed8\u4e0e\u3055\u308c\u308b\u4ed5\u7d44\u307f\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002\n\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u30fb\u30a8\u30f3\u30b8\u30f3 Smarty\u306b\u306f\u3001\u30ab\u30b9\u30bf\u30e0\u30d7\u30e9\u30b0\u30a4\u30f3\u6a5f\u80fd\u304c\u7528\u610f\u3055\u308c\u3066\u304a\u308a\u3001form \u306e\u3088\u3046\u306b\u3001\u958b\u59cb\u30bf\u30b0\u3068\u7d42\u4e86\u30bf\u30b0\u3092\u751f\u6210\u3059\u308b\u305f\u3081\u306e\u30d6\u30ed\u30c3\u30af\u95a2\u6570\u3092\u62e1\u5f35\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\nsmarty/plugins/block.form.php\n\nsmarty/plugins/block.form.php\n<?php\n\n/**\n * block.form.php\n */\nfunction smarty_block_form($params, $contents)\n{\n    if (!$contents) {\n        return;\n    }\n\n    $attr = [];\n    foreach ($params as $key => $val) {\n        $attr[] = sprintf('%s=\"%s\"', $key, $val);\n    }\n    $attribute = (count($attr) > 0) ? ' ' . implode(' ', $attr) : '';\n\n    $html = sprintf('<form%s>', $attribute);\n    $html .= $contents;\n\n    $html .= sprintf('<input type=\"hidden\" name=\"csrf_token\" value=\"%s\">'\n        , MyApp\\common\\Csrf::get()\n    );\n    $html .= '</form>';\n\n    return $html;\n}\n\n\n\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u5074\u306b\u3064\u3044\u3066\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u3057\u3066\u547c\u3073\u51fa\u3057\u307e\u3059\u3002\n{form method=\"post\"} \u3068 {/form} \u306e\u90e8\u5206\u304c\u305d\u308c\u306b\u3042\u305f\u308a\u307e\u3059\u3002\n\nsmarty/templates/unlock.tpl\n\nsmarty/templates/unlock.tpl\n{block name='meta'}\n    <style type=\"text/css\">\n        .login-box, .register-box {\n            margin: 20px auto;\n        }\n    </style>\n{/block}\n{block name='content'}\n    <div class=\"login-box\">\n        <div class=\"login-logo\">\n            <a href=\"/\">\n                <b>Admin</b>\n                LTE\n            </a>\n        </div>\n        <!-- /.login-logo -->\n        <div class=\"login-box-body\">\n\n            {if $success|default:null}\n                <p class=\"login-box-msg\">\u30a2\u30ab\u30a6\u30f3\u30c8\u30ed\u30c3\u30af\u3092\u89e3\u9664\u3057\u307e\u3057\u305f\u3002</p>\n                <p class=\"login-box-msg\">\n                    <a href=\"/\">\u30ed\u30b0\u30a4\u30f3\u30da\u30fc\u30b8</a> \u3088\u308a\u30ed\u30b0\u30a4\u30f3\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n                </p>\n            {else}\n\n                {if $is_lock}\n                    <p class=\"login-box-msg\">\u30ed\u30c3\u30af\u3092\u89e3\u9664\u3059\u308b\u306b\u306f\u3001\u4e0b\u306e\u30dc\u30bf\u30f3\u3092\u62bc\u3057\u3066\u304f\u3060\u3055\u3044\u3002</p>\n\n                    {form method=\"post\"}\n\n                    <div class=\"row\">\n                        <div class=\"col-xs-6 col-xs-offset-3\">\n                            <button type=\"submit\" class=\"btn btn-primary btn-block btn-flat\">\n                                \u30ed\u30c3\u30af\u3092\u89e3\u9664\u3059\u308b\n                            </button>\n                        </div>\n                    </div>\n\n                    {/form}\n\n                {else}\n                    <p class=\"login-box-msg\">\u30a2\u30ab\u30a6\u30f3\u30c8\u306f\u30ed\u30c3\u30af\u3055\u308c\u3066\u3044\u307e\u305b\u3093\u3002</p>\n                    <p class=\"login-box-msg\">\n                        <a href=\"/\">\u30ed\u30b0\u30a4\u30f3\u30da\u30fc\u30b8</a> \u3088\u308a\u30ed\u30b0\u30a4\u30f3\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n                    </p>\n                {/if}\n            {/if}\n\n        </div>\n        <!-- /.login-box-body -->\n    </div>\n    <!-- /.login-box -->\n{/block}\n{block name='script'}\n{/block}\n\n\n\u540c\u69d8\u306b index.tpl \u306b\u3064\u3044\u3066\u3082\u884c\u3063\u3066\u304a\u3051\u3070\u826f\u3044\u3067\u3057\u3087\u3046\u3002\n\nCsrf::check()\u306e\u4f7f\u3044\u65b9\n\nclasses/controller/LoginController.class.php\n    /**\n     * \u30ed\u30c3\u30af\u3092\u89e3\u9664\u3059\u308b\n     * @return boolean\n     */\n    public static function unlock()\n    {\n        if (null == filter_input_array(INPUT_POST)) {\n            return;\n        }\n\n        // CSRF\u30c1\u30a7\u30c3\u30af\n        Csrf::check();\n\n        $token = filter_input(INPUT_GET, 'token');\n\n        Db::transaction();\n        $objUserModel = new UserModel();\n        $objUserModel->getModelByToken($token);\n        $objUserModel->setLoginFailureCount(0)\n            ->setLoginFailureDatetime(NULL)\n            ->setToken('')\n            ->save();\n        DB::commit();\n\n        return true;\n    }\n\n\n\nGitHub \u30ec\u30dd\u30b8\u30c8\u30ea\n\u3053\u308c\u307e\u3067\u306e\u89e3\u8aac\u3067\u4f5c\u6210\u3057\u305f\u30bd\u30fc\u30b9\u30b3\u30fc\u30c9\u306b\u3064\u3044\u3066\u306f\u3001\u3053\u3061\u3089\u306b\u3002\n\u30ec\u30dd\u30b8\u30c8\u30ea\n\n1. [\u57fa\u672c\u8a2d\u8a08\u3001\u30e6\u30fc\u30b6\u30fc\u30e2\u30c7\u30eb](http://qiita.com/ShibuyaKosuke/items/f114ffccf441edb2b745)\n2. [\u30aa\u30fc\u30c8\u30ed\u30fc\u30c0\u30fc](http://qiita.com/ShibuyaKosuke/items/6109810464a7293293bd)\n3. [\u4f8b\u5916\u30fb\u30ed\u30b0](http://qiita.com/ShibuyaKosuke/items/88b1305a4ff0c5f3e728)\n4. [PDO \u30b7\u30f3\u30b0\u30eb\u30c8\u30f3\u3000SQL\u30a4\u30f3\u30b8\u30a7\u30af\u30b7\u30e7\u30f3](http://qiita.com/ShibuyaKosuke/items/094df7f399912ae7df56)\n\t* [\u6c4e\u7528\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u30fb\u30af\u30e9\u30b9\u4f5c\u6210](http://qiita.com/ShibuyaKosuke/items/8502492ac024362b528d)\n\n5. [\u30e6\u30fc\u30b6\u30fc\u30e2\u30c7\u30eb\u306e\u4f5c\u6210](http://qiita.com/ShibuyaKosuke/items/81c556d836d70a29c5f3)\n6. [\u30af\u30e9\u30b9\u306e\u7d99\u627f](http://qiita.com/ShibuyaKosuke/items/490ffa6a92670cf6c644)\n7. [\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u30fb\u30af\u30e9\u30b9\u306e\u5b9f\u88c5](http://qiita.com/ShibuyaKosuke/items/803dc58a23601118942e)\n8. [\u30a2\u30ab\u30a6\u30f3\u30c8\u30ed\u30c3\u30af\u6a5f\u80fd\u306e\u5b9f\u88c5](http://qiita.com/ShibuyaKosuke/items/e890becdb8193d3def05)\n9. [\u30e1\u30fc\u30eb\u9001\u4fe1\u6a5f\u80fd\u306e\u5b9f\u88c5](http://qiita.com/ShibuyaKosuke/items/78c8673782ebbf51584b)\n10. [\u30a2\u30ab\u30a6\u30f3\u30c8\u30ed\u30c3\u30af\u89e3\u9664\u6a5f\u80fd\u306e\u5b9f\u88c5](http://qiita.com/ShibuyaKosuke/items/ee4b1896071eeca37628)\n11. CSRF\u5bfe\u7b56\n\nCSRF(\u30af\u30ed\u30b9\u30b5\u30a4\u30c8\u30ea\u30af\u30a8\u30b9\u30c8\u30d5\u30a9\u30fc\u30b8\u30a7\u30ea) \u5bfe\u7b56\u306b\u3064\u3044\u3066\u306f[wiki](https://ja.wikipedia.org/wiki/%E3%82%AF%E3%83%AD%E3%82%B9%E3%82%B5%E3%82%A4%E3%83%88%E3%83%AA%E3%82%AF%E3%82%A8%E3%82%B9%E3%83%88%E3%83%95%E3%82%A9%E3%83%BC%E3%82%B8%E3%82%A7%E3%83%AA)\u3092\u53c2\u7167\u304f\u3060\u3055\u3044\u3002\n\n\u3064\u307e\u308a\u306f\u3001`<form>` \u304b\u3089\u4f55\u3089\u304b\u306e\u5024\u3092\u9001\u4fe1\u3057\u3066\u3001\u30b5\u30fc\u30d0\u30fc\u306b\u51e6\u7406\u3055\u305b\u308b\u5834\u5408\u3001\u3053\u306e\u5bfe\u7b56\u3092\u6020\u3089\u306a\u3044\u3088\u3046\u306b\u3057\u307e\u3057\u3087\u3046\u3068\u3044\u3046\u3053\u3068\u3002\n\n\u57fa\u672c\u7684\u306b\u306f\u3001form \u306e\u5185\u90e8\u306b\u3001`<input type=\"hidden\">` \u3067\u5024\u3092\u9001\u4fe1\u3057\u3001`SESSION`\u306b\u4fdd\u5b58\u3055\u308c\u305f\u5024\u3068\u4e00\u81f4\u3059\u308b\u304b\u3069\u3046\u304b\u3092\u78ba\u8a8d\u3059\u308b\u3002\n\n\u3053\u306eCSRF\u5bfe\u7b56\u306b\u306f\u3001\u4e8c\u91cd\u9001\u4fe1\u3092\u9632\u6b62\u3059\u308b\u3068\u3044\u3046\u526f\u7523\u7269\u3082\u3042\u308a\u3001\u6b63\u898f\u30e6\u30fc\u30b6\u30fc\u306b\u5bfe\u3057\u3066\u306f\u3001\u300cCSRF\u3092\u691c\u77e5\u3057\u305f\u306e\u3067\u3001\u51e6\u7406\u3092\u4e2d\u65ad\u3057\u307e\u3057\u305f\u300d\u3068\u3044\u3046\u3088\u3046\u306a\u300c\u4e0d\u6b63\u300d\u3092\u8868\u73fe\u3059\u308b\u306e\u3067\u306f\u306a\u304f\u3001\u300c\u4e8c\u91cd\u9001\u4fe1\u3055\u308c\u305f\u306e\u3067\u51e6\u7406\u3092\u4e2d\u65ad\u3057\u307e\u3057\u305f\u3002\u300d\u306e\u3088\u3046\u306a\u30e1\u30c3\u30bb\u30fc\u30b8\u306b\u3059\u308b\u3068\u826f\u3044\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u3002\n\n##\u5b9f\u88c5\n\n`classes/common/Csrf.class.php`\u306b`Csrf`\u30af\u30e9\u30b9\u3092\u5b9a\u7fa9\u3057\u307e\u3057\u305f\u3002\n\n###classes/common/Csrf.class.php\n\n```php:classes/common/Csrf.class.php\n<?php\n\nnamespace MyApp\\common;\n\n/**\n * Csrf.class.php\n */\nclass Csrf\n{\n\n\t/**\n\t * \u30c8\u30fc\u30af\u30f3\n\t * @var string\n\t */\n\tprivate static $token = null;\n\n\t/**\n\t * \u521d\u671f\u5316\n\t */\n\tprivate static function init()\n\t{\n\t\tself::$token = sha1(uniqid());\n\t}\n\n\t/**\n\t * CSRF\u7528\u306b\u30c8\u30fc\u30af\u30f3\u3092\u751f\u6210\u3059\u308b\n\t * @return string\n\t */\n\tpublic static function get()\n\t{\n\t\tif (is_null(self::$token)) {\n\t\t\tself::init();\n\t\t}\n\t\t$_SESSION['csrf_token'] = self::$token;\n\t\treturn self::$token;\n\t}\n\n\t/**\n\t * CSRF\u3092\u30c1\u30a7\u30c3\u30af\u3059\u308b\n\t * @return boolean\n\t * @throws ApplicationErrorException\n\t */\n\tpublic static function check()\n\t{\n\t\t$csrf_token = (isset($_SESSION['csrf_token'])) ? $_SESSION['csrf_token'] : null;\n\t\t$_SESSION['csrf_token'] = null;\n\n\t\tif (filter_input(INPUT_POST, 'csrf_token') !== $csrf_token) {\n\t\t\t// \u4e8c\u91cd\u9001\u4fe1\u3055\u308c\u305f\u306e\u3067\u51e6\u7406\u3092\u4e2d\u65ad\u3057\u307e\u3057\u305f\u3002\n\t\t\tthrow new InvalidErrorException(ExceptionCode::INVALID_CSRF_ERR);\n\t\t}\n\t\treturn true;\n\t}\n\n}\n```\n\n###classes/common/ExceptionCode.class.php\n\n```php:classes/common/ExceptionCode.class.php\n<?php\n\nnamespace MyApp\\common;\n\n/**\n * ExceptionCode.class.php\n * @since 2015/07/25\n */\nclass ExceptionCode\n{\n\n\t/**\n\t * InvalidError\n\t */\n\tconst INVALID_ERR = 1000;\n\tconst INVALID_LOCK = 1001;\n\tconst INVALID_LOGIN_FAIL = 1002;\n\tconst ARGUMENT_REQUIRED = 1003;\n\tconst INVALID_CSRF_ERR = 1004;\n\n\t/**\n\t * ApplicationError\n\t */\n\tconst APPLICATION_ERR = 2000;\n\n\t/**\n\t * SystemError\n\t */\n\tconst SYSTEM_ERR = 3000;\n\tconst TEMPLATE_ERR = 3001;\n\tconst TEMPLATE_ARG_ERR = 3002;\n\n\t/**\n\t * \u30a8\u30e9\u30fc\u30e1\u30c3\u30bb\u30fc\u30b8\n\t * @var array<string>\n\t */\n\tprivate static $_arrMessage = array(\n\t\tself::INVALID_ERR => '\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3057\u307e\u3057\u305f\u3002'\n\t\t, self::INVALID_LOCK => '\u30a2\u30ab\u30a6\u30f3\u30c8\u304c\u30ed\u30c3\u30af\u3055\u308c\u3066\u3044\u307e\u3059\u3002'\n\t\t, self::INVALID_LOGIN_FAIL => '\u30ed\u30b0\u30a4\u30f3\u306b\u5931\u6557\u3057\u307e\u3057\u305f\u3002'\n\t\t, self::INVALID_CSRF_ERR => '\u4e8c\u91cd\u9001\u4fe1\u3055\u308c\u305f\u306e\u3067\u51e6\u7406\u3092\u4e2d\u65ad\u3057\u307e\u3057\u305f\u3002'\n\t\t, self::ARGUMENT_REQUIRED => '\u30e1\u30fc\u30eb\u30a2\u30c9\u30ec\u30b9\u304a\u3088\u3073\u30d1\u30b9\u30ef\u30fc\u30c9\u306f\u5165\u529b\u5fc5\u9808\u3067\u3059\u3002'\n\t\t, self::APPLICATION_ERR => '\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30fb\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3057\u307e\u3057\u305f\u3002'\n\t\t, self::SYSTEM_ERR => '\u30b7\u30b9\u30c6\u30e0\u30fb\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3057\u307e\u3057\u305f\u3002'\n\t\t, self::TEMPLATE_ERR => '\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8[%s]\u304c\u898b\u3064\u304b\u308a\u307e\u305b\u3093\u3002'\n\t\t, self::TEMPLATE_ARG_ERR => '\u5f15\u6570\u306b[%s]\u306f\u5229\u7528\u3067\u304d\u307e\u305b\u3093\u3002'\n\t);\n\n\t/**\n\t * \u30a8\u30e9\u30fc\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u53d6\u5f97\u3059\u308b\n\t * @param int $intCode\n\t * @return string\n\t */\n\tstatic public function getMessage($intCode)\n\t{\n\t\tif (array_key_exists($intCode, self::$_arrMessage)) {\n\t\t\treturn self::$_arrMessage[$intCode];\n\t\t}\n\t}\n\n}\n```\n\n##\u5229\u7528\u65b9\u6cd5\n\n\u524d\u8ff0\u306e\u3088\u3046\u306b\u3001form \u306e\u4e2d\u306b hidden \u3067\u6885\u5b50\u898b\u308b\u306e\u3067\u3059\u304b\u3089\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u4f7f\u3044\u65b9\u306b\u306a\u308a\u307e\u3059\u3002\n\n```php\n<form method=\"post\">\n\n\t// \u305d\u306e\u4ed6\u306e\u30d5\u30a9\u30fc\u30e0\u90e8\u54c1\n\n\t<input type=\"hidden\" name=\"csrf_token\" value=\"<?= Csrf::get(); ?>\">\n</form>\n```\n\n\u57fa\u672c\u7684\u306b `form` \u3092\u5229\u7528\u3059\u308b\u3068\u3053\u308d\u306b\u306f\u3001CSRF\u5bfe\u7b56\u3092\u65bd\u3059\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u304c\u3001\u958b\u767a\u30e1\u30f3\u30d0\u30fc\u306e\u5168\u54e1\u304c `CSRF`\u306b\u3064\u3044\u3066\u7406\u89e3\u3057\u305f\u4e0a\u3067\u3001\u5229\u7528\u3057\u3066\u3044\u308b\u3068\u306f\u9650\u308a\u307e\u305b\u3093\u3002\u300c\u51e6\u7406\u306b\u95a2\u4fc2\u306a\u3044\u5024\u300d\u3068\u601d\u3063\u3066\u308f\u3056\u308f\u3056\u524a\u9664\u3057\u3066\u3057\u307e\u308f\u306a\u3044\u3068\u3082\u9650\u308a\u307e\u305b\u3093\u3002\u591a\u304f\u306e\u30d5\u30ec\u30fc\u30e0\u30ef\u30fc\u30af\u3067\u3001\u305f\u304b\u3060\u304b `<form>` \u3092\u751f\u6210\u3059\u308b\u305f\u3081\u306e\u30d8\u30eb\u30d1\u30fc\u30e1\u30bd\u30c3\u30c9\u304c\u7528\u610f\u3055\u308c\u3066\u3044\u308b\u306b\u306f\u3001\u7406\u7531\u304c\u3042\u308a\u3001\u3053\u306e `CSRF\u5bfe\u7b56`\u304c `form\u30d8\u30eb\u30d1\u30fc`\u3067\u81ea\u52d5\u7684\u306b\u4ed8\u4e0e\u3055\u308c\u308b\u4ed5\u7d44\u307f\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002\n\n\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u30fb\u30a8\u30f3\u30b8\u30f3 `Smarty`\u306b\u306f\u3001[\u30ab\u30b9\u30bf\u30e0\u30d7\u30e9\u30b0\u30a4\u30f3\u6a5f\u80fd](http://www.smarty.net/docs/ja/plugins.tpl)\u304c\u7528\u610f\u3055\u308c\u3066\u304a\u308a\u3001`form` \u306e\u3088\u3046\u306b\u3001\u958b\u59cb\u30bf\u30b0\u3068\u7d42\u4e86\u30bf\u30b0\u3092\u751f\u6210\u3059\u308b\u305f\u3081\u306e[\u30d6\u30ed\u30c3\u30af\u95a2\u6570](http://www.smarty.net/docs/ja/plugins.block.functions.tpl)\u3092\u62e1\u5f35\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\n###smarty/plugins/block.form.php\n\n```php:smarty/plugins/block.form.php\n<?php\n\n/**\n * block.form.php\n */\nfunction smarty_block_form($params, $contents)\n{\n\tif (!$contents) {\n\t\treturn;\n\t}\n\n\t$attr = [];\n\tforeach ($params as $key => $val) {\n\t\t$attr[] = sprintf('%s=\"%s\"', $key, $val);\n\t}\n\t$attribute = (count($attr) > 0) ? ' ' . implode(' ', $attr) : '';\n\n\t$html = sprintf('<form%s>', $attribute);\n\t$html .= $contents;\n\n\t$html .= sprintf('<input type=\"hidden\" name=\"csrf_token\" value=\"%s\">'\n\t\t, MyApp\\common\\Csrf::get()\n\t);\n\t$html .= '</form>';\n\n\treturn $html;\n}\n```\n\n\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u5074\u306b\u3064\u3044\u3066\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u3057\u3066\u547c\u3073\u51fa\u3057\u307e\u3059\u3002\n\n`{form method=\"post\"}` \u3068 `{/form}` \u306e\u90e8\u5206\u304c\u305d\u308c\u306b\u3042\u305f\u308a\u307e\u3059\u3002\n\n###smarty/templates/unlock.tpl\n\n```html:smarty/templates/unlock.tpl\n{block name='meta'}\n\t<style type=\"text/css\">\n\t\t.login-box, .register-box {\n\t\t\tmargin: 20px auto;\n\t\t}\n\t</style>\n{/block}\n{block name='content'}\n\t<div class=\"login-box\">\n\t\t<div class=\"login-logo\">\n\t\t\t<a href=\"/\">\n\t\t\t\t<b>Admin</b>\n\t\t\t\tLTE\n\t\t\t</a>\n\t\t</div>\n\t\t<!-- /.login-logo -->\n\t\t<div class=\"login-box-body\">\n\n\t\t\t{if $success|default:null}\n\t\t\t\t<p class=\"login-box-msg\">\u30a2\u30ab\u30a6\u30f3\u30c8\u30ed\u30c3\u30af\u3092\u89e3\u9664\u3057\u307e\u3057\u305f\u3002</p>\n\t\t\t\t<p class=\"login-box-msg\">\n\t\t\t\t\t<a href=\"/\">\u30ed\u30b0\u30a4\u30f3\u30da\u30fc\u30b8</a> \u3088\u308a\u30ed\u30b0\u30a4\u30f3\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\t\t\t\t</p>\n\t\t\t{else}\n\n\t\t\t\t{if $is_lock}\n\t\t\t\t\t<p class=\"login-box-msg\">\u30ed\u30c3\u30af\u3092\u89e3\u9664\u3059\u308b\u306b\u306f\u3001\u4e0b\u306e\u30dc\u30bf\u30f3\u3092\u62bc\u3057\u3066\u304f\u3060\u3055\u3044\u3002</p>\n\n\t\t\t\t\t{form method=\"post\"}\n\n\t\t\t\t\t<div class=\"row\">\n\t\t\t\t\t\t<div class=\"col-xs-6 col-xs-offset-3\">\n\t\t\t\t\t\t\t<button type=\"submit\" class=\"btn btn-primary btn-block btn-flat\">\n\t\t\t\t\t\t\t\t\u30ed\u30c3\u30af\u3092\u89e3\u9664\u3059\u308b\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t{/form}\n\n\t\t\t\t{else}\n\t\t\t\t\t<p class=\"login-box-msg\">\u30a2\u30ab\u30a6\u30f3\u30c8\u306f\u30ed\u30c3\u30af\u3055\u308c\u3066\u3044\u307e\u305b\u3093\u3002</p>\n\t\t\t\t\t<p class=\"login-box-msg\">\n\t\t\t\t\t\t<a href=\"/\">\u30ed\u30b0\u30a4\u30f3\u30da\u30fc\u30b8</a> \u3088\u308a\u30ed\u30b0\u30a4\u30f3\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\t\t\t\t\t</p>\n\t\t\t\t{/if}\n\t\t\t{/if}\n\n\t\t</div>\n\t\t<!-- /.login-box-body -->\n\t</div>\n\t<!-- /.login-box -->\n{/block}\n{block name='script'}\n{/block}\n```\n\n\u540c\u69d8\u306b `index.tpl` \u306b\u3064\u3044\u3066\u3082\u884c\u3063\u3066\u304a\u3051\u3070\u826f\u3044\u3067\u3057\u3087\u3046\u3002\n\n###Csrf::check()\u306e\u4f7f\u3044\u65b9\n\n```php:classes/controller/LoginController.class.php\n\t/**\n\t * \u30ed\u30c3\u30af\u3092\u89e3\u9664\u3059\u308b\n\t * @return boolean\n\t */\n\tpublic static function unlock()\n\t{\n\t\tif (null == filter_input_array(INPUT_POST)) {\n\t\t\treturn;\n\t\t}\n\n\t\t// CSRF\u30c1\u30a7\u30c3\u30af\n\t\tCsrf::check();\n\n\t\t$token = filter_input(INPUT_GET, 'token');\n\n\t\tDb::transaction();\n\t\t$objUserModel = new UserModel();\n\t\t$objUserModel->getModelByToken($token);\n\t\t$objUserModel->setLoginFailureCount(0)\n\t\t\t->setLoginFailureDatetime(NULL)\n\t\t\t->setToken('')\n\t\t\t->save();\n\t\tDB::commit();\n\n\t\treturn true;\n\t}\n```\n\n##GitHub \u30ec\u30dd\u30b8\u30c8\u30ea\n\n\u3053\u308c\u307e\u3067\u306e\u89e3\u8aac\u3067\u4f5c\u6210\u3057\u305f\u30bd\u30fc\u30b9\u30b3\u30fc\u30c9\u306b\u3064\u3044\u3066\u306f\u3001\u3053\u3061\u3089\u306b\u3002\n\n[\u30ec\u30dd\u30b8\u30c8\u30ea](https://github.com/ShibuyaKosuke/LoginSample)\n", "tags": ["\u30ed\u30b0\u30a4\u30f3", "PHP"]}