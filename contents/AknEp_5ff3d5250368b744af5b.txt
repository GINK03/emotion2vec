{"context": "\n\n\u6982\u8981\n\uff08Rspec\u5185\u3067\uff09 FactoryGirl \u3092\u4f7f\u3063\u3066 Mongoid::Document \u3092 create\u3059\u308b\u3068 \nMongo::Error::OperationFailure:\n       E11000 duplicate key error index: myapp_test.users.$_id_ dup key: { : ObjectId('56f1928569abcf62dfacdc41') } (11000) \u307f\u305f\u3044\u306a\u30a8\u30e9\u30fc\u304c\u51fa\u308b\n\n\u539f\u56e0\uff1f\ncascade_callbacks:true \u306b\u3057\u305f\u95a2\u9023\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092save\u3088\u308a\u524d\u306b\u53c2\u7167\u3055\u305b\u308b\u3068\u8d77\u304d\u308b\u3002\u4ee5\u4e0b\u306e\u3069\u306e\u65b9\u6cd5\u3067\u3082\u767a\u751f\u3059\u308b\u3002\n\uff08FactoryGirl\u5185\u3067\u3001belongs_to/has_many\u306b\u305b\u3088embeds_one/many\u306b\u305b\u3088\u3001\u53c2\u7167\u3092\u6301\u305f\u305b\u308b\u3068\u767a\u751f\u3059\u308b\u3002 \u4ee5\u4e0b\u306e\u3088\u3046\u306a\u611f\u3058\u3002\uff09\nclass User\n  include Mongoid::Document\n  include Mongoid::Timestamps\n  embeds_one :profile, cascade_callbacks: true\nend\n\nclass Profile\n  include Mongoid::Document\n  embedded_in :user\nend\n\nfactory :user do\n  profile{ build(:profile) }\nend\n\n# \u3053\u3063\u3061\u3067\u3082\u30c0\u30e1\nfactory :user do\n  after(:build) do |u|\n    u.profile = build(:profile)\n  end\nend\n\n\n\u5bfe\u7b56\n\ncascade_callbacks \u3092\u306a\u308b\u3079\u304f\u4f7f\u308f\u306a\u3044\ncascade_callbacks \u3092\u4f7f\u3046\u5834\u5408\u3001 after(:create) do ~~ end \u306e\u4e2d\u3067\u95a2\u9023\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u5165\u308c\u308b\u3002 \uff08build\u3060\u3068\u95a2\u9023\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u304c\u5165\u3089\u306a\u3044\u306e\u306f\u8ae6\u3081\u3001\u5834\u5f53\u305f\u308a\u7684\u306b\u90fd\u5ea6\u5bfe\u5fdc\u3059\u308b\u3002\uff09\n\n## \u6982\u8981\n\n\uff08Rspec\u5185\u3067\uff09 FactoryGirl \u3092\u4f7f\u3063\u3066 Mongoid::Document \u3092 create\u3059\u308b\u3068 \n`Mongo::Error::OperationFailure:\n       E11000 duplicate key error index: myapp_test.users.$_id_ dup key: { : ObjectId('56f1928569abcf62dfacdc41') } (11000)` \u307f\u305f\u3044\u306a\u30a8\u30e9\u30fc\u304c\u51fa\u308b\n\n## \u539f\u56e0\uff1f\n\ncascade_callbacks:true \u306b\u3057\u305f\u95a2\u9023\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092save\u3088\u308a\u524d\u306b\u53c2\u7167\u3055\u305b\u308b\u3068\u8d77\u304d\u308b\u3002\u4ee5\u4e0b\u306e\u3069\u306e\u65b9\u6cd5\u3067\u3082\u767a\u751f\u3059\u308b\u3002\n\n\uff08FactoryGirl\u5185\u3067\u3001belongs_to/has_many\u306b\u305b\u3088embeds_one/many\u306b\u305b\u3088\u3001\u53c2\u7167\u3092\u6301\u305f\u305b\u308b\u3068\u767a\u751f\u3059\u308b\u3002 \u4ee5\u4e0b\u306e\u3088\u3046\u306a\u611f\u3058\u3002\uff09\n\n```rb\nclass User\n  include Mongoid::Document\n  include Mongoid::Timestamps\n  embeds_one :profile, cascade_callbacks: true\nend\n\nclass Profile\n  include Mongoid::Document\n  embedded_in :user\nend\n\nfactory :user do\n  profile{ build(:profile) }\nend\n\n# \u3053\u3063\u3061\u3067\u3082\u30c0\u30e1\nfactory :user do\n  after(:build) do |u|\n    u.profile = build(:profile)\n  end\nend\n```\n\n## \u5bfe\u7b56\n\n1. cascade_callbacks \u3092\u306a\u308b\u3079\u304f\u4f7f\u308f\u306a\u3044\n2. cascade_callbacks \u3092\u4f7f\u3046\u5834\u5408\u3001 `after(:create) do ~~ end` \u306e\u4e2d\u3067\u95a2\u9023\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u5165\u308c\u308b\u3002 \uff08build\u3060\u3068\u95a2\u9023\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u304c\u5165\u3089\u306a\u3044\u306e\u306f\u8ae6\u3081\u3001\u5834\u5f53\u305f\u308a\u7684\u306b\u90fd\u5ea6\u5bfe\u5fdc\u3059\u308b\u3002\uff09\n", "tags": ["FactoryGirl", "mongoid", "MongoDB", "Rails"]}