{"context": "\n\n\u524d\u63d0\u6761\u4ef6\n\nEC2\u3078\u306e\u6a29\u9650\nEC2\u3001ECS\u3001AWS Batch \u306a\u3069\u306b\u5bfe\u3057\u3066\u30d5\u30eb\u6a29\u9650\u304c\u3042\u308b\u3053\u3068\u3002\n\n0. \u6e96\u5099\n\n0.1. \u3088\u308a\u5b9f\u8df5\u7684\u306a\u4f7f\u3044\u65b9\u306e\u5b8c\u4e86\nAWS Batch #3 \u3088\u308a\u5b9f\u8df5\u7684\u306a\u4f7f\u3044\u65b9 \u304c\u7d42\u308f\u3063\u3066\u3044\u308b\u3053\u3068\n\n0.2. \u5909\u6570\u306e\u78ba\u8a8d\n#1, #2, #3 \u304b\u3089\u5f15\u304d\u7d9a\u304d\u5229\u7528\u3059\u308b\u5909\u6570\u3092\u78ba\u8a8d\u3057\u307e\u3059\n\n\u30b3\u30de\u30f3\u30c9\ncat << ETX\n\n    CFN_STACK_NAME:         ${CFN_STACK_NAME}\n    COMPUTE_ENV_NAME:       ${COMPUTE_ENV_NAME}\n    JOB_QUEUE_NAME:         ${JOB_QUEUE_NAME}\n    JOB_DEFINITION_NAME:    ${JOB_DEFINITION_NAME}\n\n    CONRAINER_PROPS_FILE:   ${CONRAINER_PROPS_FILE}\n    DOCKER_ENTRYPOINT_FILE: ${DOCKER_ENTRYPOINT_FILE}\n    DOCKER_FILE:            ${DOCKER_FILE}\n    DOCKER_REPO:            ${DOCKER_REPO}\n    S3_BUCKET_NAME:         ${S3_BUCKET_NAME}\n\n    Managed \u7de8\u306e\u307f\n    BATCH_RESOURCES_FILE:   ${BATCH_RESOURCES_FILE}\n\nETX\n\n\n\n\u7d50\u679c\uff08\u4f8b\uff09\n\n    CFN_STACK_NAME:         aws-batch-xxxxxxxxxx\n    COMPUTE_ENV_NAME:       aws-batch-managed-xxxxxxxxxx\n    JOB_QUEUE_NAME:         aws-batch-job-queue-xxxxxxxxxx\n    JOB_DEFINITION_NAME:    aws-batch-job-def-xxxxxxxxxx\n\n    CONRAINER_PROPS_FILE:   aws_batch_container_props.json\n    DOCKER_ENTRYPOINT_FILE: entrypoint.sh\n    DOCKER_FILE:            Dockerfile\n    DOCKER_REPO:            xxxxxxxxxxxx.dkr.ecr.us-east-1.amazonaws.com/aws-batch-xxxxxxxxxx/sample\n    S3_BUCKET_NAME:         aws-batch-xxxxxxxxxx-xxxxxxxx-xxxxxxxxxxx\n\n    Managed \u7de8\u306e\u307f\n    BATCH_RESOURCES_FILE:   aws_batch_compute_resources.json\n\n\n\n\n0.3. AWS CLI\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\n\u4ee5\u4e0b\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u3067\u52d5\u4f5c\u78ba\u8a8d\u6e08\n\nAWS CLI 1.11.36\n\n\n\u30b3\u30de\u30f3\u30c9\naws --version\n\n\n\n\u7d50\u679c\uff08\u4f8b\uff09\n aws-cli/1.11.36 Python/2.7.5 Darwin/13.4.0 botocore/1.4.93\n\n\n\u30d0\u30fc\u30b8\u30e7\u30f3\u304c\u53e4\u3044\u5834\u5408\u306f\u6700\u65b0\u7248\u306b\u66f4\u65b0\u3057\u307e\u3057\u3087\u3046\u3002\n\n\u30b3\u30de\u30f3\u30c9\nsudo -H pip install -U awscli\n\n\n\n0.4. AWS \u30a2\u30ab\u30a6\u30f3\u30c8\u306e\u5c5e\u6027\nEC2-Classic \u304c\u898b\u3048\u306a\u3044 AWS \u30a2\u30ab\u30a6\u30f3\u30c8\u3067\u3042\u308b\u3053\u3068\u3002\n\n\u30b3\u30de\u30f3\u30c9\nAWS_SUPPORT_PLATFORMS=$( \\\n         aws ec2 describe-account-attributes \\\n           --query 'AccountAttributes[?AttributeName == `supported-platforms`].AttributeValues[].AttributeValue' \\\n           --output text \\\n) && echo ${AWS_SUPPORT_PLATFORMS}\n\n\n\n\u7d50\u679c\n VPC\n\n\n\n1. \u30ea\u30bd\u30fc\u30b9\u306e\u524a\u9664\n\n1.1. \u5b9a\u7fa9\u30d5\u30a1\u30a4\u30eb\u306e\u524a\u9664\n\n\u30b3\u30de\u30f3\u30c9\nrm -f ${CFN_STACK_NAME}.yaml \\\n    ${CFN_STACK_NAME}-ecs.yaml ${CFN_STACK_NAME}-job.yaml \\\n    ${CONRAINER_PROPS_FILE} ${BATCH_RESOURCES_FILE} \\\n    ${DOCKER_ENTRYPOINT_FILE} ${DOCKER_FILE}\n\n\n\n1.2. \u30b8\u30e7\u30d6\u6295\u5165\u30b9\u30bf\u30c3\u30af\u306e\u524a\u9664\n\n\u30b3\u30de\u30f3\u30c9\naws cloudformation delete-stack \\\n  --stack-name ${CFN_STACK_NAME}-job\n\n\n\u524a\u9664\u304c\u5b8c\u4e86\u3059\u308b\u307e\u3067\u5f85\u6a5f\u3057\u307e\u3059\n\n\u30b3\u30de\u30f3\u30c9\naws cloudformation wait stack-delete-complete \\\n  --stack-name ${CFN_STACK_NAME}-job\n\n\n\n1.3. \u30b8\u30e7\u30d6\u6295\u5165\u306e\u305f\u3081\u306e\u6b8b\u30ea\u30bd\u30fc\u30b9\u524a\u9664\n\nECR \u30ea\u30dd\u30b8\u30c8\u30ea\u306e\u524a\u9664\n\n\n\u30b3\u30de\u30f3\u30c9\naws ecr delete-repository --force \\\n  --repository-name $( aws ecr describe-repositories \\\n    | jq '.repositories' \\\n    | jq \"map(select(.repositoryUri==\\\"${DOCKER_REPO}\\\"))\" \\\n    | jq -r '.[].repositoryName' )\n\n\n\n\u7d50\u679c\uff08\u4f8b\uff09\n{\n    \"repository\": {\n        \"registryId\": \"xxxxxxxxxxxx\",\n        \"repositoryName\": \"aws-batch-xxxxxxxxxx/sample\",\n        \"repositoryArn\": \"arn:aws:ecr:us-east-1:xxxxxxxxxxxx:repository/aws-batch-xxxxxxxxxx/sample\",\n        \"createdAt\": 1488376409.0,\n        \"repositoryUri\": \"xxxxxxxxxxxx.dkr.ecr.us-east-1.amazonaws.com/aws-batch-xxxxxxxxxx/sample\"\n    }\n}\n\n\n\n\u30ed\u30fc\u30ab\u30eb\u306b\u3042\u308b Docker \u30a4\u30e1\u30fc\u30b8\u306e\u524a\u9664\n\n\n\u30b3\u30de\u30f3\u30c9\ndocker rmi ${DOCKER_REPO}\n\n\n\n\u7d50\u679c\nUntagged: xxxxxxxxxxxx.dkr.ecr.us-east-1.amazonaws.com/aws-batch-xxxxxxxxxx/sample:latest\nUntagged: xxxxxxxxxxxx.dkr.ecr.us-east-1.amazonaws.com/aws-batch-xxxxxxxxxx/sample@sha256:be2fbdefdbfb6b08e6298333e857aa138d293d5804b77ddd61a6145900538f27\nDeleted: sha256:a4c9ee04eaea67d8a2c5dc4815b8e9d2d3f064eb48d991eba110c6bd0a4f93d2\nDeleted: sha256:81f188eeecd0e2755eef4252aec9248e8d75a67b3d2b637a444e3179eaf27a9a\nDeleted: sha256:6a3b014a68b4ce0acd84decd60f5e77c09f0c620fdb123891f2650eb7c3b51d9\n\n\n\nCloudWatch Logs \u30ed\u30b0\u30b0\u30eb\u30fc\u30d7\u306e\u524a\u9664\n\n\n\u30b3\u30de\u30f3\u30c9\nfor group in batch/job lambda/BatchJobTriggerResource\ndo\n  aws logs delete-log-group \\\n    --log-group-name /aws/${group}\ndone\n\n\n\n\u7d50\u679c\n\u8fd4\u308a\u5024\u306a\u3057\n\n\n\n\u7d50\u679c\u683c\u7d0d\u7528 S3 \u30d0\u30b1\u30c3\u30c8\n\uff08CloudFormation \u30b9\u30bf\u30c3\u30af\u3068\u3057\u3066\u751f\u6210\u3057\u305f\u3082\u306e\u306e\u3001\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u304c\u3042\u308b\u3068\u304d\u308c\u3044\u306b\u6d88\u3048\u306a\u3044\u305f\u3081\u3053\u3053\u3067\u524a\u9664\u3057\u307e\u3059\uff09\n\n\n\u30b3\u30de\u30f3\u30c9\naws s3 rb s3://${S3_BUCKET_NAME} --force\n\n\n\n\u7d50\u679c\n\u8fd4\u308a\u5024\u306a\u3057\n\n\n\n\u30ed\u30fc\u30ab\u30eb\u306b\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u305f\u5e33\u7968\u30d5\u30a1\u30a4\u30eb\n\n\n\u30b3\u30de\u30f3\u30c9\nrm ./result-*\n\n\n\n\u7d50\u679c\n\u8fd4\u308a\u5024\u306a\u3057\n\n\n\n1.4. \u30b8\u30e7\u30d6\u5b9a\u7fa9\u306e\u7121\u52b9\u5316\n\n\u30b3\u30de\u30f3\u30c9\nfor arn in $( aws batch describe-job-definitions \\\n    --job-definition-name ${JOB_DEFINITION_NAME} \\\n    --status ACTIVE \\\n    --query 'jobDefinitions[].jobDefinitionArn' \\\n    --output text)\ndo\n  aws batch deregister-job-definition \\\n    --job-definition $arn\ndone\n\n\n\n\u7d50\u679c\n\u8fd4\u308a\u5024\u306a\u3057\n\n\n\n1.5. \u30b8\u30e7\u30d6\u30ad\u30e5\u30fc\u306e\u524a\u9664\n\u30b8\u30e7\u30d6\u30ad\u30e5\u30fc\u3092\u524a\u9664\u3059\u308b\u306b\u306f\u3001\u307e\u305a\u30ad\u30e5\u30fc\u3092\u7121\u52b9\u5316\u3057\u307e\u3059\u3002\n\n\u30b3\u30de\u30f3\u30c9\naws batch update-job-queue \\\n  --job-queue ${JOB_QUEUE_NAME} \\\n  --state DISABLED\n\n\n\n\u7d50\u679c\uff08\u4f8b\uff09\n{\n    \"jobQueueArn\": \"arn:aws:batch:us-east-1:xxxxxxxxxxxx:job-queue/aws-batch-job-queue-xxxxxxxxxx\", \n    \"jobQueueName\": \"aws-batch-job-queue-xxxxxxxxxx\"\n}\n\n\n\u305d\u306e\u4e0a\u3067\u524a\u9664\u3057\u307e\u3059\n\n\u30b3\u30de\u30f3\u30c9\naws batch delete-job-queue --job-queue ${JOB_QUEUE_NAME}\n\n\n\n\u7d50\u679c\n\u8fd4\u308a\u5024\u306a\u3057\n\n\n[ \u91cd\u8981\uff01\uff01] \nAWS Batch \u306b\u306f\u307e\u3060 wait \u30b3\u30de\u30f3\u30c9\u304c\u306a\u304f\u4e0d\u4fbf\u306a\u306e\u3067\u3059\u304c\u3001\n\u9806\u5e8f\u3088\u304f\u6d88\u3055\u306a\u3044\u3068 INVALID \u306a\u72b6\u614b\u3068\u306a\u308a\u30ea\u30bd\u30fc\u30b9\u304c\u6d88\u305b\u306a\u3044\n\u53ef\u80fd\u6027\u304c\u3042\u308a\u307e\u3059\u3002\u306a\u306e\u3067\u3001\u78ba\u5b9f\u306b\u6d88\u3048\u305f\u3053\u3068\u3092\u78ba\u304b\u3081\u307e\u3059\u3002\n\n\u30b3\u30de\u30f3\u30c9\naws batch describe-job-queues --job-queues ${JOB_QUEUE_NAME}\n\n\n\n\u7d50\u679c\n{\n    \"jobQueues\": []\n}\n\n\n\n1.6. ECS \u30af\u30e9\u30b9\u30bf\u306e\u524a\u9664\n\uff08Unmanaged \u7de8\u306e\u307f\uff09\n\n\u30b3\u30de\u30f3\u30c9\naws cloudformation delete-stack \\\n  --stack-name ${CFN_STACK_NAME}-ecs\n\n\n\u524a\u9664\u304c\u5b8c\u4e86\u3059\u308b\u307e\u3067\u5f85\u6a5f\u3057\u307e\u3059\n\n\u30b3\u30de\u30f3\u30c9\naws cloudformation wait stack-delete-complete \\\n  --stack-name ${CFN_STACK_NAME}-ecs\n\n\n\n1.7. \u30b3\u30f3\u30d4\u30e5\u30fc\u30c6\u30a3\u30f3\u30b0\u74b0\u5883\u306e\u524a\u9664\n\u30b3\u30f3\u30d4\u30e5\u30fc\u30c6\u30a3\u30f3\u30b0\u74b0\u5883\u3082\u3001\u524a\u9664\u3059\u308b\u306b\u306f\u307e\u305a\u7121\u52b9\u5316\u304c\u5fc5\u8981\u3067\u3059\u3002\n\n\u30b3\u30de\u30f3\u30c9\naws batch update-compute-environment \\\n  --compute-environment ${COMPUTE_ENV_NAME} \\\n  --state DISABLED\n\n\n\n\u7d50\u679c\uff08\u4f8b\uff09\n{\n    \"computeEnvironmentName\": \"aws-batch-refarch\", \n    \"computeEnvironmentArn\": \"arn:aws:batch:us-east-1:xxxxxxxxxxxx:compute-environment/aws-batch-refarch\"\n}\n\n\n\u305d\u306e\u4e0a\u3067\u524a\u9664\u3057\u307e\u3059\n\n\u30b3\u30de\u30f3\u30c9\naws batch delete-compute-environment \\\n  --compute-environment ${COMPUTE_ENV_NAME}\n\n\n\n\u7d50\u679c\n\u8fd4\u308a\u5024\u306a\u3057\n\n\n[ \u91cd\u8981\uff01\uff01] \u3057\u3070\u3089\u304f\u5f85\u3061\u3001\u3053\u3061\u3089\u3082\u6b63\u5e38\u306b\u6d88\u3048\u305f\u3053\u3068\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n\u30b3\u30de\u30f3\u30c9\naws batch describe-compute-environments \\\n  --compute-environments ${COMPUTE_ENV_NAME}\n\n\n\n\u7d50\u679c\n{\n    \"computeEnvironments\": []\n}\n\n\n\n1.8. VPC \u3084 IAM \u306e\u524a\u9664\n\n\u30b3\u30de\u30f3\u30c9\naws cloudformation delete-stack \\\n  --stack-name ${CFN_STACK_NAME}\n\n\n\n\u7d50\u679c\n\u8fd4\u308a\u5024\u306a\u3057\n\n\n\u524a\u9664\u304c\u5b8c\u4e86\u3059\u308b\u307e\u3067\u5f85\u6a5f\u3057\u307e\u3059\n\n\u30b3\u30de\u30f3\u30c9\naws cloudformation wait stack-delete-complete \\\n  --stack-name ${CFN_STACK_NAME}\n\n\n\n\u5b8c\u4e86\n\u304a\u75b2\u308c\u3055\u307e\u3067\u3057\u305f\n# \u524d\u63d0\u6761\u4ef6\n\n## EC2\u3078\u306e\u6a29\u9650\n\nEC2\u3001ECS\u3001AWS Batch \u306a\u3069\u306b\u5bfe\u3057\u3066\u30d5\u30eb\u6a29\u9650\u304c\u3042\u308b\u3053\u3068\u3002\n\n# 0. \u6e96\u5099\n\n## 0.1. \u3088\u308a\u5b9f\u8df5\u7684\u306a\u4f7f\u3044\u65b9\u306e\u5b8c\u4e86\n\n[AWS Batch #3 \u3088\u308a\u5b9f\u8df5\u7684\u306a\u4f7f\u3044\u65b9](http://qiita.com/pottava/items/a1d316e5a622b705efba) \u304c\u7d42\u308f\u3063\u3066\u3044\u308b\u3053\u3068\n\n## 0.2. \u5909\u6570\u306e\u78ba\u8a8d\n\n`#1`, `#2`, `#3` \u304b\u3089\u5f15\u304d\u7d9a\u304d\u5229\u7528\u3059\u308b\u5909\u6570\u3092\u78ba\u8a8d\u3057\u307e\u3059\n\n```sh:\u30b3\u30de\u30f3\u30c9\ncat << ETX\n\n    CFN_STACK_NAME:         ${CFN_STACK_NAME}\n    COMPUTE_ENV_NAME:       ${COMPUTE_ENV_NAME}\n    JOB_QUEUE_NAME:         ${JOB_QUEUE_NAME}\n    JOB_DEFINITION_NAME:    ${JOB_DEFINITION_NAME}\n\n    CONRAINER_PROPS_FILE:   ${CONRAINER_PROPS_FILE}\n    DOCKER_ENTRYPOINT_FILE: ${DOCKER_ENTRYPOINT_FILE}\n    DOCKER_FILE:            ${DOCKER_FILE}\n    DOCKER_REPO:            ${DOCKER_REPO}\n    S3_BUCKET_NAME:         ${S3_BUCKET_NAME}\n\n    Managed \u7de8\u306e\u307f\n    BATCH_RESOURCES_FILE:   ${BATCH_RESOURCES_FILE}\n\nETX\n```\n\n```sh:\u7d50\u679c\uff08\u4f8b\uff09\n\n    CFN_STACK_NAME:         aws-batch-xxxxxxxxxx\n    COMPUTE_ENV_NAME:       aws-batch-managed-xxxxxxxxxx\n    JOB_QUEUE_NAME:         aws-batch-job-queue-xxxxxxxxxx\n    JOB_DEFINITION_NAME:    aws-batch-job-def-xxxxxxxxxx\n\n    CONRAINER_PROPS_FILE:   aws_batch_container_props.json\n    DOCKER_ENTRYPOINT_FILE: entrypoint.sh\n    DOCKER_FILE:            Dockerfile\n    DOCKER_REPO:            xxxxxxxxxxxx.dkr.ecr.us-east-1.amazonaws.com/aws-batch-xxxxxxxxxx/sample\n    S3_BUCKET_NAME:         aws-batch-xxxxxxxxxx-xxxxxxxx-xxxxxxxxxxx\n\n    Managed \u7de8\u306e\u307f\n    BATCH_RESOURCES_FILE:   aws_batch_compute_resources.json\n\n```\n\n## 0.3. AWS CLI\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\n\n\u4ee5\u4e0b\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u3067\u52d5\u4f5c\u78ba\u8a8d\u6e08\n\n* AWS CLI 1.11.36\n\n```sh:\u30b3\u30de\u30f3\u30c9\naws --version\n```\n\n```sh:\u7d50\u679c\uff08\u4f8b\uff09\n aws-cli/1.11.36 Python/2.7.5 Darwin/13.4.0 botocore/1.4.93\n```\n\n\u30d0\u30fc\u30b8\u30e7\u30f3\u304c\u53e4\u3044\u5834\u5408\u306f\u6700\u65b0\u7248\u306b\u66f4\u65b0\u3057\u307e\u3057\u3087\u3046\u3002\n\n```sh:\u30b3\u30de\u30f3\u30c9\nsudo -H pip install -U awscli\n```\n\n## 0.4. AWS \u30a2\u30ab\u30a6\u30f3\u30c8\u306e\u5c5e\u6027\n\nEC2-Classic \u304c\u898b\u3048\u306a\u3044 AWS \u30a2\u30ab\u30a6\u30f3\u30c8\u3067\u3042\u308b\u3053\u3068\u3002\n\n```sh:\u30b3\u30de\u30f3\u30c9\nAWS_SUPPORT_PLATFORMS=$( \\\n         aws ec2 describe-account-attributes \\\n           --query 'AccountAttributes[?AttributeName == `supported-platforms`].AttributeValues[].AttributeValue' \\\n           --output text \\\n) && echo ${AWS_SUPPORT_PLATFORMS}\n```\n\n```sh:\u7d50\u679c\n VPC\n```\n\n# 1. \u30ea\u30bd\u30fc\u30b9\u306e\u524a\u9664\n\n## 1.1. \u5b9a\u7fa9\u30d5\u30a1\u30a4\u30eb\u306e\u524a\u9664\n\n```sh:\u30b3\u30de\u30f3\u30c9\nrm -f ${CFN_STACK_NAME}.yaml \\\n    ${CFN_STACK_NAME}-ecs.yaml ${CFN_STACK_NAME}-job.yaml \\\n    ${CONRAINER_PROPS_FILE} ${BATCH_RESOURCES_FILE} \\\n    ${DOCKER_ENTRYPOINT_FILE} ${DOCKER_FILE}\n```\n\n## 1.2. \u30b8\u30e7\u30d6\u6295\u5165\u30b9\u30bf\u30c3\u30af\u306e\u524a\u9664\n\n```sh:\u30b3\u30de\u30f3\u30c9\naws cloudformation delete-stack \\\n  --stack-name ${CFN_STACK_NAME}-job\n```\n\n\u524a\u9664\u304c\u5b8c\u4e86\u3059\u308b\u307e\u3067\u5f85\u6a5f\u3057\u307e\u3059\n\n```sh:\u30b3\u30de\u30f3\u30c9\naws cloudformation wait stack-delete-complete \\\n  --stack-name ${CFN_STACK_NAME}-job\n```\n\n## 1.3. \u30b8\u30e7\u30d6\u6295\u5165\u306e\u305f\u3081\u306e\u6b8b\u30ea\u30bd\u30fc\u30b9\u524a\u9664\n\n- ECR \u30ea\u30dd\u30b8\u30c8\u30ea\u306e\u524a\u9664\n\n```sh:\u30b3\u30de\u30f3\u30c9\naws ecr delete-repository --force \\\n  --repository-name $( aws ecr describe-repositories \\\n    | jq '.repositories' \\\n    | jq \"map(select(.repositoryUri==\\\"${DOCKER_REPO}\\\"))\" \\\n    | jq -r '.[].repositoryName' )\n```\n\n```sh:\u7d50\u679c\uff08\u4f8b\uff09\n{\n    \"repository\": {\n        \"registryId\": \"xxxxxxxxxxxx\",\n        \"repositoryName\": \"aws-batch-xxxxxxxxxx/sample\",\n        \"repositoryArn\": \"arn:aws:ecr:us-east-1:xxxxxxxxxxxx:repository/aws-batch-xxxxxxxxxx/sample\",\n        \"createdAt\": 1488376409.0,\n        \"repositoryUri\": \"xxxxxxxxxxxx.dkr.ecr.us-east-1.amazonaws.com/aws-batch-xxxxxxxxxx/sample\"\n    }\n}\n```\n\n- \u30ed\u30fc\u30ab\u30eb\u306b\u3042\u308b Docker \u30a4\u30e1\u30fc\u30b8\u306e\u524a\u9664\n\n```sh:\u30b3\u30de\u30f3\u30c9\ndocker rmi ${DOCKER_REPO}\n```\n\n```sh:\u7d50\u679c\nUntagged: xxxxxxxxxxxx.dkr.ecr.us-east-1.amazonaws.com/aws-batch-xxxxxxxxxx/sample:latest\nUntagged: xxxxxxxxxxxx.dkr.ecr.us-east-1.amazonaws.com/aws-batch-xxxxxxxxxx/sample@sha256:be2fbdefdbfb6b08e6298333e857aa138d293d5804b77ddd61a6145900538f27\nDeleted: sha256:a4c9ee04eaea67d8a2c5dc4815b8e9d2d3f064eb48d991eba110c6bd0a4f93d2\nDeleted: sha256:81f188eeecd0e2755eef4252aec9248e8d75a67b3d2b637a444e3179eaf27a9a\nDeleted: sha256:6a3b014a68b4ce0acd84decd60f5e77c09f0c620fdb123891f2650eb7c3b51d9\n```\n\n- CloudWatch Logs \u30ed\u30b0\u30b0\u30eb\u30fc\u30d7\u306e\u524a\u9664\n\n```sh:\u30b3\u30de\u30f3\u30c9\nfor group in batch/job lambda/BatchJobTriggerResource\ndo\n  aws logs delete-log-group \\\n    --log-group-name /aws/${group}\ndone\n```\n\n```sh:\u7d50\u679c\n\u8fd4\u308a\u5024\u306a\u3057\n```\n\n- \u7d50\u679c\u683c\u7d0d\u7528 S3 \u30d0\u30b1\u30c3\u30c8  \n\uff08CloudFormation \u30b9\u30bf\u30c3\u30af\u3068\u3057\u3066\u751f\u6210\u3057\u305f\u3082\u306e\u306e\u3001\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u304c\u3042\u308b\u3068\u304d\u308c\u3044\u306b\u6d88\u3048\u306a\u3044\u305f\u3081\u3053\u3053\u3067\u524a\u9664\u3057\u307e\u3059\uff09\n\n```sh:\u30b3\u30de\u30f3\u30c9\naws s3 rb s3://${S3_BUCKET_NAME} --force\n```\n\n```sh:\u7d50\u679c\n\u8fd4\u308a\u5024\u306a\u3057\n```\n\n- \u30ed\u30fc\u30ab\u30eb\u306b\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u305f\u5e33\u7968\u30d5\u30a1\u30a4\u30eb\n\n```sh:\u30b3\u30de\u30f3\u30c9\nrm ./result-*\n```\n\n```sh:\u7d50\u679c\n\u8fd4\u308a\u5024\u306a\u3057\n```\n\n## 1.4. \u30b8\u30e7\u30d6\u5b9a\u7fa9\u306e\u7121\u52b9\u5316\n\n```sh:\u30b3\u30de\u30f3\u30c9\nfor arn in $( aws batch describe-job-definitions \\\n    --job-definition-name ${JOB_DEFINITION_NAME} \\\n    --status ACTIVE \\\n    --query 'jobDefinitions[].jobDefinitionArn' \\\n    --output text)\ndo\n  aws batch deregister-job-definition \\\n    --job-definition $arn\ndone\n```\n\n```sh:\u7d50\u679c\n\u8fd4\u308a\u5024\u306a\u3057\n```\n\n## 1.5. \u30b8\u30e7\u30d6\u30ad\u30e5\u30fc\u306e\u524a\u9664\n\n\u30b8\u30e7\u30d6\u30ad\u30e5\u30fc\u3092\u524a\u9664\u3059\u308b\u306b\u306f\u3001\u307e\u305a\u30ad\u30e5\u30fc\u3092\u7121\u52b9\u5316\u3057\u307e\u3059\u3002\n\n```sh:\u30b3\u30de\u30f3\u30c9\naws batch update-job-queue \\\n  --job-queue ${JOB_QUEUE_NAME} \\\n  --state DISABLED\n```\n\n```sh:\u7d50\u679c\uff08\u4f8b\uff09\n{\n    \"jobQueueArn\": \"arn:aws:batch:us-east-1:xxxxxxxxxxxx:job-queue/aws-batch-job-queue-xxxxxxxxxx\", \n    \"jobQueueName\": \"aws-batch-job-queue-xxxxxxxxxx\"\n}\n```\n\n\u305d\u306e\u4e0a\u3067\u524a\u9664\u3057\u307e\u3059\n\n```sh:\u30b3\u30de\u30f3\u30c9\naws batch delete-job-queue --job-queue ${JOB_QUEUE_NAME}\n```\n\n```sh:\u7d50\u679c\n\u8fd4\u308a\u5024\u306a\u3057\n```\n\n[ \u91cd\u8981\uff01\uff01] \nAWS Batch \u306b\u306f\u307e\u3060 `wait` \u30b3\u30de\u30f3\u30c9\u304c\u306a\u304f\u4e0d\u4fbf\u306a\u306e\u3067\u3059\u304c\u3001\n\u9806\u5e8f\u3088\u304f\u6d88\u3055\u306a\u3044\u3068 `INVALID` \u306a\u72b6\u614b\u3068\u306a\u308a\u30ea\u30bd\u30fc\u30b9\u304c\u6d88\u305b\u306a\u3044\n\u53ef\u80fd\u6027\u304c\u3042\u308a\u307e\u3059\u3002\u306a\u306e\u3067\u3001\u78ba\u5b9f\u306b\u6d88\u3048\u305f\u3053\u3068\u3092\u78ba\u304b\u3081\u307e\u3059\u3002\n\n```sh:\u30b3\u30de\u30f3\u30c9\naws batch describe-job-queues --job-queues ${JOB_QUEUE_NAME}\n```\n\n```sh:\u7d50\u679c\n{\n    \"jobQueues\": []\n}\n```\n\n## 1.6. ECS \u30af\u30e9\u30b9\u30bf\u306e\u524a\u9664\n\n\uff08Unmanaged \u7de8\u306e\u307f\uff09\n\n```sh:\u30b3\u30de\u30f3\u30c9\naws cloudformation delete-stack \\\n  --stack-name ${CFN_STACK_NAME}-ecs\n```\n\n\u524a\u9664\u304c\u5b8c\u4e86\u3059\u308b\u307e\u3067\u5f85\u6a5f\u3057\u307e\u3059\n\n```sh:\u30b3\u30de\u30f3\u30c9\naws cloudformation wait stack-delete-complete \\\n  --stack-name ${CFN_STACK_NAME}-ecs\n```\n\n## 1.7. \u30b3\u30f3\u30d4\u30e5\u30fc\u30c6\u30a3\u30f3\u30b0\u74b0\u5883\u306e\u524a\u9664\n\n\u30b3\u30f3\u30d4\u30e5\u30fc\u30c6\u30a3\u30f3\u30b0\u74b0\u5883\u3082\u3001\u524a\u9664\u3059\u308b\u306b\u306f\u307e\u305a\u7121\u52b9\u5316\u304c\u5fc5\u8981\u3067\u3059\u3002\n\n```sh:\u30b3\u30de\u30f3\u30c9\naws batch update-compute-environment \\\n  --compute-environment ${COMPUTE_ENV_NAME} \\\n  --state DISABLED\n```\n\n```sh:\u7d50\u679c\uff08\u4f8b\uff09\n{\n    \"computeEnvironmentName\": \"aws-batch-refarch\", \n    \"computeEnvironmentArn\": \"arn:aws:batch:us-east-1:xxxxxxxxxxxx:compute-environment/aws-batch-refarch\"\n}\n```\n\n\u305d\u306e\u4e0a\u3067\u524a\u9664\u3057\u307e\u3059\n\n```sh:\u30b3\u30de\u30f3\u30c9\naws batch delete-compute-environment \\\n  --compute-environment ${COMPUTE_ENV_NAME}\n```\n\n```sh:\u7d50\u679c\n\u8fd4\u308a\u5024\u306a\u3057\n```\n\n[ \u91cd\u8981\uff01\uff01] \u3057\u3070\u3089\u304f\u5f85\u3061\u3001\u3053\u3061\u3089\u3082\u6b63\u5e38\u306b\u6d88\u3048\u305f\u3053\u3068\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n```sh:\u30b3\u30de\u30f3\u30c9\naws batch describe-compute-environments \\\n  --compute-environments ${COMPUTE_ENV_NAME}\n```\n\n```sh:\u7d50\u679c\n{\n    \"computeEnvironments\": []\n}\n```\n\n## 1.8. VPC \u3084 IAM \u306e\u524a\u9664\n\n```sh:\u30b3\u30de\u30f3\u30c9\naws cloudformation delete-stack \\\n  --stack-name ${CFN_STACK_NAME}\n```\n\n```sh:\u7d50\u679c\n\u8fd4\u308a\u5024\u306a\u3057\n```\n\n\u524a\u9664\u304c\u5b8c\u4e86\u3059\u308b\u307e\u3067\u5f85\u6a5f\u3057\u307e\u3059\n\n```sh:\u30b3\u30de\u30f3\u30c9\naws cloudformation wait stack-delete-complete \\\n  --stack-name ${CFN_STACK_NAME}\n```\n\n# \u5b8c\u4e86\n\n\u304a\u75b2\u308c\u3055\u307e\u3067\u3057\u305f\n", "tags": ["AWS", "aws-cli", "AWS-Batch"]}