{"tags": ["solr", "facet", "\u691c\u7d22\u30a8\u30f3\u30b8\u30f3", "AdventCalendar"], "context": "Solr Advent Calendar 2016 \u306e 22 \u65e5\u76ee\u3067\u3059\u3002\n\u3068\u3044\u3063\u3066\u3082\u65e2\u306b\u30e1\u30ea\u30fc\u30af\u30ea\u30b9\u30de\u30b9\u3067\u3059\u3002\u3059\u307f\u307e\u305b\u3093orz\nJSON Facet \u4f7f\u7528\u4e0a\u306e\u6ce8\u610f\u70b9\u306b\u3064\u3044\u3066\u3086\u308b\u3075\u308f\u306b\u66f8\u304d\u307e\u3059\u3002\n\n\u7d50\u8ad6\u304b\u3089\n\nJSON Facet \u306f\u5fc5\u305a\u3057\u3082\u6b63\u78ba\u306a\u30ab\u30a6\u30f3\u30c8\u6570\u3092\u8fd4\u3059\u4fdd\u8a3c\u306f\u3042\u308a\u307e\u305b\u3093\u3002\n\u96c6\u7d04\u51e6\u7406\u306b\u3088\u308b\u5024 \uff08count, sum, avg \u306a\u3069) \u3067\u30d0\u30b1\u30c3\u30c8\u3092\u30bd\u30fc\u30c8\u3059\u308b\u5834\u5408\u306b\u3001\u4e0d\u6b63\u78ba\u306b\u306a\u308b\u5834\u5408\u304c\u3042\u308a\u307e\u3059\u3002\n\u6b63\u78ba\u3055\u304c\u6c42\u3081\u3089\u308c\u308b\u5834\u5408\u306f\u3001\u5fc5\u8981\u306b\u5fdc\u3058\u3066 overrequest \u3092\u5229\u7528\u3057\u3066\u307f\u307e\u3057\u3087\u3046\u3002\n\n\nJSON Facet \u3068\u306f\nSolr-5.x \u304b\u3089\u5c0e\u5165\u3055\u308c\u305f\u6a5f\u80fd\u3067\u3059\u3002\u30ea\u30af\u30a8\u30b9\u30c8\u304c JSON \u5f62\u5f0f\u3067\u3042\u308a\u3001\u305d\u308c\u307e\u3067\u306e facet=true \u3067\u30ea\u30af\u30a8\u30b9\u30c8\u3059\u308b (Legacy) Facet \u3088\u308a\u3082\u9ad8\u901f\u306b\u52d5\u4f5c\u3057\u307e\u3059\u3002\u306a\u305c\u9ad8\u901f\u306b\u52d5\u4f5c\u3059\u308b\u306e\u304b\u306b\u3064\u3044\u3066\u306f\u5f8c\u307b\u3069\u5c11\u3057\u3060\u3051\u89e6\u308c\u307e\u3059\u3002\n\u672c\u8a18\u4e8b\u3067\u306f\u8a73\u7d30\u306a\u4f7f\u3044\u65b9\u3084\u901f\u5ea6\u6bd4\u8f03\u306b\u3064\u3044\u3066\u306f\u89e6\u308c\u307e\u305b\u3093\u306e\u3067\u3001\u5fc5\u8981\u3067\u3042\u308c\u3070\u4ee5\u4e0b\u3092\u53c2\u8003\u306b\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\nJSON Facet API\nFacet & Analytics Performance\nApache Solr 5.x\u3067\u30d5\u30a1\u30bb\u30c3\u30c8\u3092\u8a66\u3059\n\n\n\u8a66\u3057\u306b\u4f7f\u3063\u3066\u307f\u308b\n\u5bff\u53f8\u3092\u4f8b\u306b JSON Facet \u3092\u8a66\u3057\u3066\u307f\u307e\u3059\u3002\n* \u5bff\u53f8\u306e\u60c5\u5831\u306f\u30b9\u30b7\u30ed\u30fc\u3092\u53c2\u8003\u306b\u3055\u305b\u3066\u3044\u305f\u3060\u304d\u307e\u3057\u305f\u3002\n\n\u74b0\u5883\u3068\u30c7\u30fc\u30bf\n\nSolrCloud\nshard \u6570\u306f 4\ncollection \u540d\u306f sushi\n\u5168\u4ef6\u6570\u306f 344\n\u30d5\u30a3\u30fc\u30eb\u30c9\u306f name, price, kcal \u306e 3 \u30d5\u30a3\u30fc\u30eb\u30c9\n\n\n\n\n\u30d5\u30a3\u30fc\u30eb\u30c9\n\u8aac\u660e\n\u30ab\u30fc\u30c7\u30a3\u30ca\u30ea\u30c6\u30a3\n\n\n\n\nname\n\u5bff\u53f8\u306e\u30cd\u30bf\u540d\n-\n\n\nprice\n\u4fa1\u683c(\u5186)\n\u4f4e\u3044 [ 9 \u7a2e\u985e ]\n\n\nkcal\n\u30ab\u30ed\u30ea\u30fc(kcal)\n\u9ad8\u3044 [ 96 \u7a2e\u985e ]\n\n\n\n\u30ab\u30fc\u30c7\u30a3\u30ca\u30ea\u30c6\u30a3\u306f\u3001\u305d\u306e\u30d5\u30a3\u30fc\u30eb\u30c9\u306b\u542b\u307e\u308c\u308b\u5024\u306e\u7a2e\u985e\u6570\u306e\u3053\u3068\u3067\u3059\u3002\n\u4f8b\u3048\u3070 price \u306f\u3001\u4ee5\u4e0b\u306e 9 \u7a2e\u985e\u306e\u30c7\u30fc\u30bf\u3057\u304b\u542b\u307e\u308c\u3066\u304a\u3089\u305a\u3001\u30ab\u30fc\u30c7\u30a3\u30ca\u30ea\u30c6\u30a3\u306f\u4f4e\u3044\u3068\u8a00\u3048\u307e\u3059\u3002\n100 / 130 / 150 / 180 / 280 / 350 / 380 / 480 / 980 \u5186\n\n\u4ee5\u4e0b\u306f\u5b9f\u969b\u306b\u5165\u3063\u3066\u3044\u308b\u30c7\u30fc\u30bf\u306b\u306a\u308a\u307e\u3059\u3002\n<result name=\"response\" numFound=\"344\" start=\"0\" maxScore=\"1.0\">\n  <doc>\n    <str name=\"name\">\u751f\u672c\u305a\u308f\u3044\u87f9</str>\n    <int name=\"price\">180</int>\n    <int name=\"kcal\">39</int>\n  </doc>\n  <doc>\n    <str name=\"name\">\u307e\u3050\u308d</str>\n    <int name=\"price\">100</int>\n    <int name=\"kcal\">80</int>\n  </doc>\n  <doc>\n    <str name=\"name\">\u30b5\u30fc\u30e2\u30f3</str>\n    <int name=\"price\">100</int>\n    <int name=\"kcal\">84</int>\n  </doc>\n  <doc>\n    <str name=\"name\">\u3044\u304b</str>\n    <int name=\"price\">100</int>\n    <int name=\"kcal\">68</int>\n  </doc>\n\n  ...\n\n</result>\n\n\nJSON Facet \u3067\u5404\u4fa1\u683c\u306e\u4ef6\u6570\u3092\u53d6\u5f97\u3059\u308b\n\u4ee5\u4e0b\u306e\u3088\u3046\u306a JSON \u5f62\u5f0f\u306e\u30ea\u30af\u30a8\u30b9\u30c8\u306b\u3088\u308a\u53d6\u5f97\u3067\u304d\u307e\u3059\u3002\n$ curl http://localhost:8983/solr/sushi/select -d 'q=*:*&rows=0&\njson.facet={\n  price:{\n    type:terms,\n    field:price\n  }\n}\n'\n\n<lst name=\"facets\">\n  <long name=\"count\">344</long>\n  <lst name=\"price\">\n    <arr name=\"buckets\">\n      <lst>\n        <long name=\"val\">100</long>    // 100 \u5186\u306e\u30cd\u30bf\u304c\n        <long name=\"count\">214</long>  // 214 \u4ef6\n      </lst>\n      <lst>\n        <long name=\"val\">180</long>\n        <long name=\"count\">54</long>\n      </lst>\n      <lst>\n        <long name=\"val\">280</long>\n        <long name=\"count\">42</long>\n      </lst>\n      <lst>\n        <long name=\"val\">150</long>\n        <long name=\"count\">16</long>\n      </lst>\n      <lst>\n        <long name=\"val\">350</long>\n        <long name=\"count\">8</long>\n      </lst>\n      <lst>\n        <long name=\"val\">980</long>\n        <long name=\"count\">4</long>\n      </lst>\n      <lst>\n        <long name=\"val\">130</long>\n        <long name=\"count\">2</long>\n      </lst>\n      <lst>\n        <long name=\"val\">380</long>\n        <long name=\"count\">2</long>\n      </lst>\n      <lst>\n        <long name=\"val\">480</long>\n        <long name=\"count\">2</long>\n      </lst>\n    </arr>\n  </lst>\n</lst>\n\n\nJSON Facet vs. Legacy Facet\n\u3082\u3061\u308d\u3093 Legacy Facet \u3067\u3082\u53d6\u5f97\u3067\u304d\u307e\u3059\u3002\n\u7d50\u679c\u3092\u6bd4\u8f03\u3057\u3066\u307f\u307e\u3057\u3087\u3046\u3002\n\n\u30ab\u30fc\u30c7\u30a3\u30ca\u30ea\u30c6\u30a3\u304c\u4f4e\u3044\u5834\u5408 (price)\n\u30d5\u30a3\u30fc\u30eb\u30c9 price \u3092\u5bfe\u8c61\u3068\u3057\u305f\u5834\u5408\u3067\u3059\u3002\nJSON Facet\uff08\u518d\u63b2\uff09\n$ curl http://localhost:8983/solr/sushi/select -d 'q=*:*&rows=0&\njson.facet={\n  price:{\n    type:terms,\n    field:price\n  }\n}\n'\n\n<lst name=\"facets\">\n  <long name=\"count\">344</long>\n  <lst name=\"price\">\n    <arr name=\"buckets\">\n      <lst>\n        <long name=\"val\">100</long>    // 100 \u5186\u306e\u30cd\u30bf\u304c\n        <long name=\"count\">214</long>  // 214 \u4ef6\n      </lst>\n      <lst>\n        <long name=\"val\">180</long>\n        <long name=\"count\">54</long>\n      </lst>\n      <lst>\n        <long name=\"val\">280</long>\n        <long name=\"count\">42</long>\n      </lst>\n      <lst>\n        <long name=\"val\">150</long>\n        <long name=\"count\">16</long>\n      </lst>\n      <lst>\n        <long name=\"val\">350</long>\n        <long name=\"count\">8</long>\n      </lst>\n      <lst>\n        <long name=\"val\">980</long>\n        <long name=\"count\">4</long>\n      </lst>\n      <lst>\n        <long name=\"val\">130</long>\n        <long name=\"count\">2</long>\n      </lst>\n      <lst>\n        <long name=\"val\">380</long>\n        <long name=\"count\">2</long>\n      </lst>\n      <lst>\n        <long name=\"val\">480</long>\n        <long name=\"count\">2</long>\n      </lst>\n    </arr>\n  </lst>\n</lst>\n\nLegacy Facet\n$ curl http://localhost:8983/solr/sushi/select -d 'q=*:*&rows=0&\nfacet=true\n&facet.field=price\n\n<lst name=\"facet_counts\">\n  <lst name=\"facet_queries\"/>\n  <lst name=\"facet_fields\">\n    <lst name=\"price\">\n      <int name=\"100\">214</int>  // 100 \u5186\u306e\u30cd\u30bf\u304c 214 \u4ef6\n      <int name=\"180\">54</int>\n      <int name=\"280\">42</int>\n      <int name=\"150\">16</int>\n      <int name=\"350\">8</int>\n      <int name=\"980\">4</int>\n      <int name=\"130\">2</int>\n      <int name=\"380\">2</int>\n      <int name=\"480\">2</int>\n    </lst>\n  </lst>\n  <lst name=\"facet_ranges\"/>\n  <lst name=\"facet_intervals\"/>\n  <lst name=\"facet_heatmaps\"/>\n</lst>\n\n\u591a\u5c11 XML \u306b\u5dee\u306f\u3042\u308a\u307e\u3059\u304c\u3001\u8fd4\u3063\u3066\u304d\u3066\u3044\u308b\u5185\u5bb9\uff08\u4ef6\u6570\u3068\u4e26\u3073\uff09\u306f\u540c\u3058\u3067\u3042\u308b\u3053\u3068\u304c\u5206\u304b\u308a\u307e\u3059\u3002\n\u7d50\u679c\u304c\u540c\u3058\u3067\u3042\u308a\u3001\u51e6\u7406\u304c\u9ad8\u901f\u3067\u3042\u308b\u3068\u3044\u3046\u3053\u3068\u3067\u3042\u308c\u3070\u3001JSON Facet \u4e00\u629e\u3068\u8a00\u3048\u305d\u3046\u3067\u304c\u3001\u30ab\u30fc\u30c7\u30a3\u30ca\u30ea\u30c6\u30a3\u306e\u9ad8\u3044\u30d5\u30a3\u30fc\u30eb\u30c9\u306b\u5bfe\u3057\u3066\u306f JSON Facet \u306e\u5229\u7528\u3067\u6ce8\u610f\u3057\u306a\u3051\u308c\u3070\u306a\u3089\u306a\u3044\u3053\u3068\u304c\u3042\u308a\u307e\u3059\u3002\n\n\u30ab\u30fc\u30c7\u30a3\u30ca\u30ea\u30c6\u30a3\u304c\u9ad8\u3044\u5834\u5408 (kcal)\n\u5bfe\u8c61\u30d5\u30a3\u30fc\u30eb\u30c9\u3092 kcal \u3068\u3057\u3066\u6bd4\u8f03\u3057\u3066\u307f\u307e\u3057\u3087\u3046\u3002\n\u8aac\u660e\u306e\u305f\u3081 limit \u3092\u5229\u7528\u3057\u3066 5 \u30d0\u30b1\u30c3\u30c8\u306b\u7d5e\u3063\u3066\u3044\u307e\u3059\u3002\nJSON Facet\n$ curl http://localhost:8983/solr/sushi/select -d 'q=*:*&rows=0&\njson.facet={\n  kcal:{\n    type:terms,\n    field:kcal,\n    limit:5\n  }\n}\n'\n\n<lst name=\"facets\">\n  <long name=\"count\">344</long>\n  <lst name=\"kcal\">\n    <arr name=\"buckets\">\n      <lst>\n        <long name=\"val\">74</long>\n        <long name=\"count\">11</long>\n      </lst>\n      <lst>\n        <long name=\"val\">72</long>\n        <long name=\"count\">10</long>\n      </lst>\n      <lst>\n        <long name=\"val\">82</long>\n        <long name=\"count\">10</long>\n      </lst>\n      <lst>\n        <long name=\"val\">66</long>\n        <long name=\"count\">9</long>\n      </lst>\n      <lst>\n        <long name=\"val\">68</long>\n        <long name=\"count\">8</long>\n      </lst>\n    </arr>\n  </lst>\n</lst>\n\nLegacy Facet\n$ curl http://192.168.110.11:8901/solr/sushi/select -d 'q=*:*&rows=0&\nfacet=true\n&facet.field=kcal\n&facet.limit=5\n\n<lst name=\"facet_counts\">\n  <lst name=\"facet_queries\"/>\n  <lst name=\"facet_fields\">\n    <lst name=\"kcal\">\n      <int name=\"66\">12</int>\n      <int name=\"74\">12</int>\n      <int name=\"68\">10</int>\n      <int name=\"72\">10</int>\n      <int name=\"82\">10</int>\n    </lst>\n  </lst>\n  <lst name=\"facet_ranges\"/>\n  <lst name=\"facet_intervals\"/>\n  <lst name=\"facet_heatmaps\"/>\n</lst>\n\n\u7d50\u679c\u306b\u5dee\u304c\u51fa\u3066\u3044\u307e\u3059\u3002\u3069\u3061\u3089\u306e\u6b63\u3057\u3044\u5024\u304b\u3068\u3044\u3046\u3068 Legacy Facet \u304c\u6b63\u3057\u3044\u5024\u3068\u306a\u308a\u307e\u3059\u3002\u8a66\u3057\u306b kcal:66 \u3067\u691c\u7d22\u3057\u3066\u307f\u308b\u3068\u300112 \u4ef6\u3068\u8fd4\u3063\u3066\u304d\u307e\u3059\u304c\u3001JSON Facet \u306e\u7d50\u679c \u3067\u306f 9 \u4ef6\u3067\u3042\u308a\u3001\u8aa4\u3063\u305f\u5024\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002\n$ curl http://localhost:8983/solr/sushi/select?q=kcal:66\n\n...\n\n# numFound \u304c 12\n<result name=\"response\" numFound=\"12\" start=\"0\" maxScore=\"4.048882\"/>\n\n\n\u306a\u305c JSON Facet \u3067\u8aa4\u3063\u305f\u5024\u304c\u8fd4\u3063\u305f\u306e\u304b\uff1f\n\u3053\u308c\u306f\u3001Legacy Facet \u3067\u306f refine \u51e6\u7406\u304c\u884c\u308f\u308c\u308b\u306e\u306b\u5bfe\u3057\u3066\u3001JSON Facet \u3067\u306f refine \u51e6\u7406\u304c\u884c\u308f\u308c\u306a\u3044\u305f\u3081\u3067\u3059\u3002\n\u7c21\u5358\u306b JSON Facet \u3068 Legacy Facet \u306e\u51e6\u7406\u306e\u9055\u3044\u3092\u78ba\u8a8d\u3057\u3066\u307f\u307e\u3057\u3087\u3046\u3002\n\u5c1a\u3001\u4eca\u56de\u306e\u8aac\u660e\u306f\u30d0\u30b1\u30c3\u30c8\u306e\u30bd\u30fc\u30c8\u3092\u4ef6\u6570\u9806 (count) \u3068\u3057\u3066\u3044\u308b\u3002\nJSON Facet\n\nshard \u3054\u3068\u306b\u5404\u30d0\u30b1\u30c3\u30c8\u306b\u542b\u307e\u308c\u308b\u4ef6\u6570\u3092\u30ab\u30a6\u30f3\u30c8\u3059\u308b\u3002\n\u4e0a\u4f4d limit \u6570\u3060\u3051\u306e\u30d0\u30b1\u30c3\u30c8\u3092\u5404 shard \u304b\u3089\u53d6\u5f97\u3057\u3001\u4ef6\u6570\u3092\u30de\u30fc\u30b8\u3059\u308b\u3002\n\u4ef6\u6570\u306e\u591a\u3044\u4e0a\u4f4d limit \u4ef6\u306e\u30d0\u30b1\u30c3\u30c8\u3092\u30ec\u30b9\u30dd\u30f3\u30b9\u3068\u3057\u3066\u8fd4\u3059\u3002\n\n\u3053\u306e\u6642\u3001\u56f3\u304b\u3089\u5206\u304b\u308b\u3088\u3046\u306b\u3001\nshard1 \u306e kcal:74\u3001shard2 \u306e kcal:66, kcal:68 \u306e\u4ef6\u6570\u306f\u7121\u8996\u3055\u308c\u3066\u3057\u307e\u3063\u3066\u3044\u308b\u3002\u305d\u306e\u305f\u3081\u3001\u6700\u7d42\u7684\u306b\u4ef6\u6570\u306b\u305a\u308c\u304c\u751f\u3058\u308b\u3002\n\nLegacy Facet\n\nshard \u3054\u3068\u306b\u5404\u30d0\u30b1\u30c3\u30c8\u306b\u542b\u307e\u308c\u308b\u4ef6\u6570\u3092\u30ab\u30a6\u30f3\u30c8\u3059\u308b\u3002\n\u4e0a\u4f4d limit \u6570\u3060\u3051\u306e\u30d0\u30b1\u30c3\u30c8\u3092\u5404 shard \u304b\u3089\u53d6\u5f97\u3057\u3001\u4ef6\u6570\u3092\u30de\u30fc\u30b8\u3059\u308b\u3002\n\u4ef6\u6570\u306e\u591a\u3044\u4e0a\u4f4d limit \u4ef6\u306e\u30d0\u30b1\u30c3\u30c8\u3092\u7279\u5b9a\u3059\u308b\u3002\n\u518d\u5ea6\u5404 shard \u306b\u554f\u3044\u5408\u308f\u305b\u3001\u7279\u5b9a\u3057\u305f\u30d0\u30b1\u30c3\u30c8\u306b\u3064\u3044\u3066\u30d0\u30b1\u30c3\u30c8\u306b\u542b\u307e\u308c\u308b\u4ef6\u6570\u3092\u30ab\u30a6\u30f3\u30c8\u3059\u308b\u3002\uff08refine \u51e6\u7406)\n\u30d0\u30b1\u30c3\u30c8\u3092\u5404 shard \u304b\u3089\u53d6\u5f97\u3057\u4ef6\u6570\u3092\u30de\u30fc\u30b8\u3059\u308b\u3002\n\u30ec\u30b9\u30dd\u30f3\u30b9\u3068\u3057\u3066\u8fd4\u3059\u3002\n\nLegacy Facet \u306f JSON Facet \u3068\u7570\u306a\u308a\u3001\u300c4\u300d\u306b\u3066\u5404 shard \u306b\u518d\u5ea6\u554f\u3044\u5408\u308f\u305b\u308b\u3053\u3068\u3067\u3001\u4ef6\u6570\u306e refine \u51e6\u7406\u3092\u884c\u3063\u3066\u3044\u308b\u3002\n\n\n\u4e21\u8005\u3092\u6bd4\u8f03\u3059\u308b\u3068\u3001JSON Facet \u306b\u306f Legacy Facet \u3067\u884c\u3063\u3066\u3044\u308b refine \u51e6\u7406\u304c\u306a\u3044\u305f\u3081\u3001\u9ad8\u901f\u306b\u51e6\u7406\u3092\u8fd4\u3059\u3053\u3068\u304c\u3067\u304d\u308b\u53cd\u9762\u3001\u4ef6\u6570\u306b\u305a\u308c\u304c\u751f\u3058\u308b\u3053\u3068\u304c\u5206\u304b\u308b\u3002\n\n\u30ab\u30fc\u30c7\u30a3\u30ca\u30ea\u30c6\u30a3\u3068\u306e\u7d61\u307f\n\u30ab\u30fc\u30c7\u30a3\u30ca\u30ea\u30c6\u30a3\u304c\u4f4e\u3044\u5834\u5408\u306f\u3001\u30d0\u30b1\u30c3\u30c8\u6570\u304c\u5c11\u306a\u3044\u72b6\u614b\u3067\u3042\u308b\u305f\u3081\u3001\u6700\u7d42\u7684\u306b\u4e0a\u4f4d\u306b\u306a\u308b\u30d0\u30b1\u30c3\u30c8\u304c\u5404 shard \u306e\u4e0a\u4f4d limit \u306b\u542b\u307e\u308c\u3084\u3059\u304f\u306a\u308b\u3002\u305d\u306e\u305f\u3081\u3001\u4ef6\u6570\u3092\u53d6\u308a\u3053\u307c\u3059\u53ef\u80fd\u6027\u304c\u4f4e\u304f\u306a\u308b\u3002\n\u30ab\u30fc\u30c7\u30a3\u30ca\u30ea\u30c6\u30a3\u304c\u9ad8\u3044\u5834\u5408\u306f\u3001\u305d\u306e\u9006\u3067\u3001\u6700\u7d42\u7684\u306b\u4e0a\u4f4d\u306b\u306a\u308b\u30d0\u30b1\u30c3\u30c8\u304c\u5404 shard \u306e\u4e0a\u4f4d limit \u306b\u542b\u307e\u308c\u3065\u3089\u304f\u306a\u308b\u3002\u3088\u3063\u3066\u3001\u4ef6\u6570\u3092\u53d6\u308a\u3053\u307c\u3059\u53ef\u80fd\u6027\u304c\u9ad8\u304f\u306a\u308b\u3002\n\n\u3058\u3083\u3042\u3069\u3046\u3059\u308c\u3070\uff1f\n\u65b9\u6cd5\u306f\u3044\u304f\u3064\u304b\u3042\u308a\u307e\u3059\u3002\n\nLegacy Facet\n\u5fc5\u8981\u306a\u4ef6\u6570\u3088\u308a\u5927\u304d\u3044 limit \u3092\u6307\u5b9a\u3059\u308b\uff08limit:-1 \u3067\u5168\u4ef6)\nshard \u6570\u3092\u5897\u3084\u3059\n\noverrequest \u3092\u5229\u7528\u3059\u308b\n\n\u3044\u308d\u3044\u308d\u30e1\u30ea\u30c3\u30c8\u30fb\u30c7\u30e1\u30ea\u30c3\u30c8\u304c\u3042\u308a\u307e\u3059\u304c\u3001\u3053\u3053\u3067\u306f\u300c4\u300d\u306e\u65b9\u6cd5\u3067\u8a71\u3092\u9032\u3081\u307e\u3059\u3002\n\noverrequest\nJSON Facet \u306e overrequest \u306f Solr-6.3.0 \u304b\u3089\u5b9f\u88c5\u3055\u308c\u3066\u3044\u308b\u30aa\u30d7\u30b7\u30e7\u30f3\u3067\u3059\u3002\n\nAdd \"overrequest\" parameter to JSON Facet API to control amount of overrequest on a distributed terms facet\n\nhttp://lucene.apache.org/solr/news.html\n\u3053\u308c\u3092\u5229\u7528\u3059\u308b\u3053\u3068\u3067\u3001\u5404 shard \u304b\u3089\u8fd4\u5374\u3055\u308c\u308b\u30d0\u30b1\u30c3\u30c8\u6570\u3092 limit \u3088\u308a\u3082 over \u306b request \u3059\u308b\u3053\u3068\u304c\u53ef\u80fd\u306b\u306a\u308a\u3001\u8003\u616e\u3067\u304d\u3066\u3044\u306a\u304b\u3063\u305f\u4e0b\u4f4d\u306e\u30d0\u30b1\u30c3\u30c8\u306e\u4ef6\u6570\u3082\u8003\u616e\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\n\n\u5b9f\u306f\u3001\u4ee5\u524d\u304b\u3089 JSON Facet \u306e\u51e6\u7406\u306e\u5185\u90e8\u3067\u306f overrequest \u3092\u884c\u306a\u3063\u3066\u3044\u305f\u306e\u3067\u3059\u304c\u3001\u30c7\u30d5\u30a9\u30eb\u30c8\u5024\u304c\u6307\u5b9a\u3055\u308c\u3066\u304a\u308a\u3001\u5916\u304b\u3089\u30b3\u30f3\u30c8\u30ed\u30fc\u30eb\u3067\u304d\u307e\u305b\u3093\u3067\u3057\u305f\u3002\n\u4ee5\u4e0b\u306e freq.limit \u306f\u30ea\u30af\u30a8\u30b9\u30c8\u6642\u306e limit \u30aa\u30d7\u30b7\u30e7\u30f3\u3067\u6307\u5b9a\u3057\u305f\u5024\u3067\u3059\u304c\u3001\u3053\u308c\u306b\u5b9a\u6570\u500d\u3057\u3066\u3044\u308b\u306e\u304c\u5206\u304b\u308a\u307e\u3059\u3002\nSolr-6.0.0 - FacetField.java#L582-L583\n// add a modest amount of over-request if this is a shard request\nint lim = freq.limit >= 0 ? (fcontext.isShard() ? (int)(freq.limit*1.1+4) : (int)freq.limit) : Integer.MAX_VALUE;\n\n\u2193\nSolr-6.3.0 \u304b\u3089\u306f\u30ea\u30af\u30a8\u30b9\u30c8\u6642\u306b\u6307\u5b9a\u3057\u305f overrequest \u30aa\u30d7\u30b7\u30e7\u30f3\u306e\u5024 (freq.overrequest) \u3092 limit \u306e\u5024\uff08effectiveLimit\uff09 \u306b\u52a0\u7b97\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u308b\u306e\u304c\u5206\u304b\u308a\u307e\u3059\u3002\u3053\u308c\u3067\u6700\u7d42\u7684\u306b\u5404 shard \u304b\u3089\u8fd4\u3059\u30d0\u30b1\u30c3\u30c8\u6570\u304c limit + overrequest \u306b\u5897\u3048\u308b\u3053\u3068\u306b\u306a\u308a\u307e\u3059\u3002\nSolr-6.3.0 - FacetFieldProcessor.java#L221-L225\nif (freq.overrequest == -1) {  // \u2190 overrequest \u3092\u6307\u5b9a\u3057\u306a\u3044\u3068\u304d\u306e\u30c7\u30d5\u30a9\u30eb\u30c8\u5024\u306f -1\n  effectiveLimit = (long) (effectiveLimit*1.1+4); // default: add 10% plus 4 (to overrequest for very small limits)\n} else {\n  effectiveLimit += freq.overrequest;  // \u2190 \u6307\u5b9a\u3059\u308b\u3053\u3068\u3067\u30b3\u30f3\u30c8\u30ed\u30fc\u30eb\u3067\u304d\u308b\n}\n\n\noverrequest \u3092\u8a66\u3059\noverrequest \u306e\u5024\u3092\u6307\u5b9a\u3057\u3066 Legacy Facet \u3068\u540c\u3058\u7d50\u679c\u3092\u53d6\u5f97\u3067\u304d\u308b\u304b\u78ba\u8a8d\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n$ curl http://localhost:8983/solr/sushi/select -d 'q=*:*&rows=0&\njson.facet={\n  kcal:{\n    type:terms,\n    field:kcal,\n    limit:5,\n    overrequest:31\n  }\n}\n'\n\n<lst name=\"facets\">\n  <long name=\"count\">344</long>\n  <lst name=\"kcal\">\n    <arr name=\"buckets\">\n      <lst>\n        <long name=\"val\">66</long>\n        <long name=\"count\">12</long>\n      </lst>\n      <lst>\n        <long name=\"val\">74</long>\n        <long name=\"count\">12</long>\n      </lst>\n      <lst>\n        <long name=\"val\">68</long>\n        <long name=\"count\">10</long>\n      </lst>\n      <lst>\n        <long name=\"val\">72</long>\n        <long name=\"count\">10</long>\n      </lst>\n      <lst>\n        <long name=\"val\">82</long>\n        <long name=\"count\">10</long>\n      </lst>\n    </arr>\n  </lst>\n</lst>\n\n\u306f\u3044\u3001\u540c\u3058\u306b\u306a\u308a\u307e\u3057\u305f\u3002overrequest \u306e\u5024\u306b 31 \u3092\u6307\u5b9a\u3057\u3066\u3044\u307e\u3059\u304c\u3001\u4eca\u56de\u306e\u30b1\u30fc\u30b9\u3067\u306f limit + 31 \u306e\u30d0\u30b1\u30c3\u30c8\u3092\u5404 shard \u304b\u3089\u8fd4\u3059\u5fc5\u8981\u304c\u3042\u3063\u305f\u3088\u3046\u3067\u3059\u300231 \u3068\u3044\u3046\u5024\u306f\u3001\u7d50\u679c\u304c\u540c\u3058\u306b\u306a\u308b\u307e\u3067\u30a4\u30f3\u30af\u30ea\u30e1\u30f3\u30c8\u3057\u305f\u7d50\u679c\u3067\u3059\u30fb\u30fb\u30fb\u3002\u7d39\u4ecb\u3057\u3066\u304a\u3044\u3066\u306a\u3093\u3067\u3059\u304c\u3001\u6b63\u76f4\u4f7f\u3044\u3065r\uff08ry\n\n\u307e\u3068\u3081\n\nJSON Facet \u306f Legacy Facet \u3088\u308a\u3082\u901f\u304f\u3066\u4f7f\u3044\u3084\u3059\u3044\u3067\u3059\u304c\u3001\u7528\u6cd5\u7528\u91cf\u3092\u5b88\u308a\u307e\u3057\u3087\u3046\u3002\n\u30ab\u30fc\u30c7\u30a3\u30ca\u30ea\u30c6\u30a3\u306e\u9ad8\u3044\u30d5\u30a3\u30fc\u30eb\u30c9\u3067\u306f overrequest \u304c\u52b9\u304f\u30b1\u30fc\u30b9\u3082\u3042\u308b\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u3002\n\n\n\u88dc\u8db3\noverrequest \u306b\u306f\u3001\u5404\u30d0\u30b1\u30c3\u30c8\u306e\u4ef6\u6570\u306e\u6b63\u78ba\u6027\u3092\u9ad8\u3081\u308b\u305f\u3081\u3060\u3051\u3067\u306a\u304f\u3001\u4e0a\u4f4d\u306b\u6765\u308b\u30d0\u30b1\u30c3\u30c8\u81ea\u4f53\u306e\u6b63\u78ba\u6027\u3092\u9ad8\u3081\u308b\u3068\u3044\u3046\u76ee\u7684\u3082\u3042\u308a\u307e\u3059\u3002\u3053\u308c\u306f JSON Facet\u3001Legacy Facet \u3044\u305a\u308c\u306b\u3082\u5f53\u3066\u306f\u307e\u308b\u3082\u306e\u3067\u3059\u3002\u4f59\u529b\u304c\u3042\u308c\u3070\u3001\u3044\u3064\u304b\u66f8\u3053\u3046\u3068\u601d\u3044\u307e\u3059\u3002\n[Solr Advent Calendar 2016](http://qiita.com/advent-calendar/2016/solr) \u306e 22 \u65e5\u76ee\u3067\u3059\u3002\n\u3068\u3044\u3063\u3066\u3082\u65e2\u306b\u30e1\u30ea\u30fc\u30af\u30ea\u30b9\u30de\u30b9\u3067\u3059\u3002\u3059\u307f\u307e\u305b\u3093orz\nJSON Facet \u4f7f\u7528\u4e0a\u306e\u6ce8\u610f\u70b9\u306b\u3064\u3044\u3066\u3086\u308b\u3075\u308f\u306b\u66f8\u304d\u307e\u3059\u3002\n\n## \u7d50\u8ad6\u304b\u3089\n- JSON Facet \u306f\u5fc5\u305a\u3057\u3082\u6b63\u78ba\u306a\u30ab\u30a6\u30f3\u30c8\u6570\u3092\u8fd4\u3059\u4fdd\u8a3c\u306f\u3042\u308a\u307e\u305b\u3093\u3002\n- \u96c6\u7d04\u51e6\u7406\u306b\u3088\u308b\u5024 \uff08count, sum, avg \u306a\u3069) \u3067\u30d0\u30b1\u30c3\u30c8\u3092\u30bd\u30fc\u30c8\u3059\u308b\u5834\u5408\u306b\u3001\u4e0d\u6b63\u78ba\u306b\u306a\u308b\u5834\u5408\u304c\u3042\u308a\u307e\u3059\u3002\n- \u6b63\u78ba\u3055\u304c\u6c42\u3081\u3089\u308c\u308b\u5834\u5408\u306f\u3001\u5fc5\u8981\u306b\u5fdc\u3058\u3066 **overrequest** \u3092\u5229\u7528\u3057\u3066\u307f\u307e\u3057\u3087\u3046\u3002\n\n## JSON Facet \u3068\u306f\nSolr-5.x \u304b\u3089\u5c0e\u5165\u3055\u308c\u305f\u6a5f\u80fd\u3067\u3059\u3002\u30ea\u30af\u30a8\u30b9\u30c8\u304c JSON \u5f62\u5f0f\u3067\u3042\u308a\u3001\u305d\u308c\u307e\u3067\u306e ```facet=true``` \u3067\u30ea\u30af\u30a8\u30b9\u30c8\u3059\u308b (Legacy) Facet \u3088\u308a\u3082\u9ad8\u901f\u306b\u52d5\u4f5c\u3057\u307e\u3059\u3002\u306a\u305c\u9ad8\u901f\u306b\u52d5\u4f5c\u3059\u308b\u306e\u304b\u306b\u3064\u3044\u3066\u306f\u5f8c\u307b\u3069\u5c11\u3057\u3060\u3051\u89e6\u308c\u307e\u3059\u3002\n\n\u672c\u8a18\u4e8b\u3067\u306f\u8a73\u7d30\u306a\u4f7f\u3044\u65b9\u3084\u901f\u5ea6\u6bd4\u8f03\u306b\u3064\u3044\u3066\u306f\u89e6\u308c\u307e\u305b\u3093\u306e\u3067\u3001\u5fc5\u8981\u3067\u3042\u308c\u3070\u4ee5\u4e0b\u3092\u53c2\u8003\u306b\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n- [JSON Facet API](http://yonik.com/json-facet-api/)\n- [Facet & Analytics Performance](http://yonik.com/facet-performance/)\n- [Apache Solr 5.x\u3067\u30d5\u30a1\u30bb\u30c3\u30c8\u3092\u8a66\u3059](http://d.hatena.ne.jp/Kazuhira/20151003/1443892724)\n\n## \u8a66\u3057\u306b\u4f7f\u3063\u3066\u307f\u308b\n\u5bff\u53f8\u3092\u4f8b\u306b JSON Facet \u3092\u8a66\u3057\u3066\u307f\u307e\u3059\u3002\n\\* \u5bff\u53f8\u306e\u60c5\u5831\u306f[\u30b9\u30b7\u30ed\u30fc](https://www.akindo-sushiro.co.jp/menu/)\u3092\u53c2\u8003\u306b\u3055\u305b\u3066\u3044\u305f\u3060\u304d\u307e\u3057\u305f\u3002\n\n### \u74b0\u5883\u3068\u30c7\u30fc\u30bf\n\n- SolrCloud\n- shard \u6570\u306f 4\n- collection \u540d\u306f sushi\n- \u5168\u4ef6\u6570\u306f 344\n- \u30d5\u30a3\u30fc\u30eb\u30c9\u306f name, price, kcal \u306e 3 \u30d5\u30a3\u30fc\u30eb\u30c9\n\n| \u30d5\u30a3\u30fc\u30eb\u30c9 | \u8aac\u660e | \u30ab\u30fc\u30c7\u30a3\u30ca\u30ea\u30c6\u30a3 |\n|---|---|---|\n| name | \u5bff\u53f8\u306e\u30cd\u30bf\u540d | - |\n| price | \u4fa1\u683c(\u5186) | \u4f4e\u3044 [ 9 \u7a2e\u985e ] |\n| kcal | \u30ab\u30ed\u30ea\u30fc(kcal) | \u9ad8\u3044 [ 96 \u7a2e\u985e ] |\n\n\u30ab\u30fc\u30c7\u30a3\u30ca\u30ea\u30c6\u30a3\u306f\u3001\u305d\u306e\u30d5\u30a3\u30fc\u30eb\u30c9\u306b\u542b\u307e\u308c\u308b\u5024\u306e\u7a2e\u985e\u6570\u306e\u3053\u3068\u3067\u3059\u3002\n\u4f8b\u3048\u3070 price \u306f\u3001\u4ee5\u4e0b\u306e 9 \u7a2e\u985e\u306e\u30c7\u30fc\u30bf\u3057\u304b\u542b\u307e\u308c\u3066\u304a\u3089\u305a\u3001\u30ab\u30fc\u30c7\u30a3\u30ca\u30ea\u30c6\u30a3\u306f\u4f4e\u3044\u3068\u8a00\u3048\u307e\u3059\u3002\n\n```\n100 / 130 / 150 / 180 / 280 / 350 / 380 / 480 / 980 \u5186\n```\n\n\u4ee5\u4e0b\u306f\u5b9f\u969b\u306b\u5165\u3063\u3066\u3044\u308b\u30c7\u30fc\u30bf\u306b\u306a\u308a\u307e\u3059\u3002\n\n```\n<result name=\"response\" numFound=\"344\" start=\"0\" maxScore=\"1.0\">\n  <doc>\n    <str name=\"name\">\u751f\u672c\u305a\u308f\u3044\u87f9</str>\n    <int name=\"price\">180</int>\n    <int name=\"kcal\">39</int>\n  </doc>\n  <doc>\n    <str name=\"name\">\u307e\u3050\u308d</str>\n    <int name=\"price\">100</int>\n    <int name=\"kcal\">80</int>\n  </doc>\n  <doc>\n    <str name=\"name\">\u30b5\u30fc\u30e2\u30f3</str>\n    <int name=\"price\">100</int>\n    <int name=\"kcal\">84</int>\n  </doc>\n  <doc>\n    <str name=\"name\">\u3044\u304b</str>\n    <int name=\"price\">100</int>\n    <int name=\"kcal\">68</int>\n  </doc>\n\n  ...\n\n</result>\n```\n\n### JSON Facet \u3067\u5404\u4fa1\u683c\u306e\u4ef6\u6570\u3092\u53d6\u5f97\u3059\u308b\n\u4ee5\u4e0b\u306e\u3088\u3046\u306a JSON \u5f62\u5f0f\u306e\u30ea\u30af\u30a8\u30b9\u30c8\u306b\u3088\u308a\u53d6\u5f97\u3067\u304d\u307e\u3059\u3002\n\n```\n$ curl http://localhost:8983/solr/sushi/select -d 'q=*:*&rows=0&\njson.facet={\n  price:{\n    type:terms,\n    field:price\n  }\n}\n'\n```\n```xml\n<lst name=\"facets\">\n  <long name=\"count\">344</long>\n  <lst name=\"price\">\n    <arr name=\"buckets\">\n      <lst>\n        <long name=\"val\">100</long>    // 100 \u5186\u306e\u30cd\u30bf\u304c\n        <long name=\"count\">214</long>  // 214 \u4ef6\n      </lst>\n      <lst>\n        <long name=\"val\">180</long>\n        <long name=\"count\">54</long>\n      </lst>\n      <lst>\n        <long name=\"val\">280</long>\n        <long name=\"count\">42</long>\n      </lst>\n      <lst>\n        <long name=\"val\">150</long>\n        <long name=\"count\">16</long>\n      </lst>\n      <lst>\n        <long name=\"val\">350</long>\n        <long name=\"count\">8</long>\n      </lst>\n      <lst>\n        <long name=\"val\">980</long>\n        <long name=\"count\">4</long>\n      </lst>\n      <lst>\n        <long name=\"val\">130</long>\n        <long name=\"count\">2</long>\n      </lst>\n      <lst>\n        <long name=\"val\">380</long>\n        <long name=\"count\">2</long>\n      </lst>\n      <lst>\n        <long name=\"val\">480</long>\n        <long name=\"count\">2</long>\n      </lst>\n    </arr>\n  </lst>\n</lst>\n```\n\n## JSON Facet vs. Legacy Facet\n\u3082\u3061\u308d\u3093 Legacy Facet \u3067\u3082\u53d6\u5f97\u3067\u304d\u307e\u3059\u3002\n\u7d50\u679c\u3092\u6bd4\u8f03\u3057\u3066\u307f\u307e\u3057\u3087\u3046\u3002\n\n### \u30ab\u30fc\u30c7\u30a3\u30ca\u30ea\u30c6\u30a3\u304c\u4f4e\u3044\u5834\u5408 (price)\n\u30d5\u30a3\u30fc\u30eb\u30c9 price \u3092\u5bfe\u8c61\u3068\u3057\u305f\u5834\u5408\u3067\u3059\u3002\n\n**JSON Facet**\uff08\u518d\u63b2\uff09\n\n```\n$ curl http://localhost:8983/solr/sushi/select -d 'q=*:*&rows=0&\njson.facet={\n  price:{\n    type:terms,\n    field:price\n  }\n}\n'\n```\n```xml\n<lst name=\"facets\">\n  <long name=\"count\">344</long>\n  <lst name=\"price\">\n    <arr name=\"buckets\">\n      <lst>\n        <long name=\"val\">100</long>    // 100 \u5186\u306e\u30cd\u30bf\u304c\n        <long name=\"count\">214</long>  // 214 \u4ef6\n      </lst>\n      <lst>\n        <long name=\"val\">180</long>\n        <long name=\"count\">54</long>\n      </lst>\n      <lst>\n        <long name=\"val\">280</long>\n        <long name=\"count\">42</long>\n      </lst>\n      <lst>\n        <long name=\"val\">150</long>\n        <long name=\"count\">16</long>\n      </lst>\n      <lst>\n        <long name=\"val\">350</long>\n        <long name=\"count\">8</long>\n      </lst>\n      <lst>\n        <long name=\"val\">980</long>\n        <long name=\"count\">4</long>\n      </lst>\n      <lst>\n        <long name=\"val\">130</long>\n        <long name=\"count\">2</long>\n      </lst>\n      <lst>\n        <long name=\"val\">380</long>\n        <long name=\"count\">2</long>\n      </lst>\n      <lst>\n        <long name=\"val\">480</long>\n        <long name=\"count\">2</long>\n      </lst>\n    </arr>\n  </lst>\n</lst>\n```\n\n**Legacy Facet**\n\n```\n$ curl http://localhost:8983/solr/sushi/select -d 'q=*:*&rows=0&\nfacet=true\n&facet.field=price\n```\n```xml\n<lst name=\"facet_counts\">\n  <lst name=\"facet_queries\"/>\n  <lst name=\"facet_fields\">\n    <lst name=\"price\">\n      <int name=\"100\">214</int>  // 100 \u5186\u306e\u30cd\u30bf\u304c 214 \u4ef6\n      <int name=\"180\">54</int>\n      <int name=\"280\">42</int>\n      <int name=\"150\">16</int>\n      <int name=\"350\">8</int>\n      <int name=\"980\">4</int>\n      <int name=\"130\">2</int>\n      <int name=\"380\">2</int>\n      <int name=\"480\">2</int>\n    </lst>\n  </lst>\n  <lst name=\"facet_ranges\"/>\n  <lst name=\"facet_intervals\"/>\n  <lst name=\"facet_heatmaps\"/>\n</lst>\n```\n\n\u591a\u5c11 XML \u306b\u5dee\u306f\u3042\u308a\u307e\u3059\u304c\u3001\u8fd4\u3063\u3066\u304d\u3066\u3044\u308b\u5185\u5bb9\uff08\u4ef6\u6570\u3068\u4e26\u3073\uff09\u306f\u540c\u3058\u3067\u3042\u308b\u3053\u3068\u304c\u5206\u304b\u308a\u307e\u3059\u3002\n\n\u7d50\u679c\u304c\u540c\u3058\u3067\u3042\u308a\u3001\u51e6\u7406\u304c\u9ad8\u901f\u3067\u3042\u308b\u3068\u3044\u3046\u3053\u3068\u3067\u3042\u308c\u3070\u3001JSON Facet \u4e00\u629e\u3068\u8a00\u3048\u305d\u3046\u3067\u304c\u3001**\u30ab\u30fc\u30c7\u30a3\u30ca\u30ea\u30c6\u30a3\u306e\u9ad8\u3044\u30d5\u30a3\u30fc\u30eb\u30c9\u306b\u5bfe\u3057\u3066\u306f JSON Facet \u306e\u5229\u7528\u3067\u6ce8\u610f\u3057\u306a\u3051\u308c\u3070\u306a\u3089\u306a\u3044\u3053\u3068**\u304c\u3042\u308a\u307e\u3059\u3002\n\n### \u30ab\u30fc\u30c7\u30a3\u30ca\u30ea\u30c6\u30a3\u304c\u9ad8\u3044\u5834\u5408 (kcal)\n\u5bfe\u8c61\u30d5\u30a3\u30fc\u30eb\u30c9\u3092 kcal \u3068\u3057\u3066\u6bd4\u8f03\u3057\u3066\u307f\u307e\u3057\u3087\u3046\u3002\n\u8aac\u660e\u306e\u305f\u3081 limit \u3092\u5229\u7528\u3057\u3066 5 \u30d0\u30b1\u30c3\u30c8\u306b\u7d5e\u3063\u3066\u3044\u307e\u3059\u3002\n\n**JSON Facet**\n\n```\n$ curl http://localhost:8983/solr/sushi/select -d 'q=*:*&rows=0&\njson.facet={\n  kcal:{\n    type:terms,\n    field:kcal,\n    limit:5\n  }\n}\n'\n```\n```xml\n<lst name=\"facets\">\n  <long name=\"count\">344</long>\n  <lst name=\"kcal\">\n    <arr name=\"buckets\">\n      <lst>\n        <long name=\"val\">74</long>\n        <long name=\"count\">11</long>\n      </lst>\n      <lst>\n        <long name=\"val\">72</long>\n        <long name=\"count\">10</long>\n      </lst>\n      <lst>\n        <long name=\"val\">82</long>\n        <long name=\"count\">10</long>\n      </lst>\n      <lst>\n        <long name=\"val\">66</long>\n        <long name=\"count\">9</long>\n      </lst>\n      <lst>\n        <long name=\"val\">68</long>\n        <long name=\"count\">8</long>\n      </lst>\n    </arr>\n  </lst>\n</lst>\n```\n\n**Legacy Facet**\n\n```\n$ curl http://192.168.110.11:8901/solr/sushi/select -d 'q=*:*&rows=0&\nfacet=true\n&facet.field=kcal\n&facet.limit=5\n```\n```xml\n<lst name=\"facet_counts\">\n  <lst name=\"facet_queries\"/>\n  <lst name=\"facet_fields\">\n    <lst name=\"kcal\">\n      <int name=\"66\">12</int>\n      <int name=\"74\">12</int>\n      <int name=\"68\">10</int>\n      <int name=\"72\">10</int>\n      <int name=\"82\">10</int>\n    </lst>\n  </lst>\n  <lst name=\"facet_ranges\"/>\n  <lst name=\"facet_intervals\"/>\n  <lst name=\"facet_heatmaps\"/>\n</lst>\n```\n\n\u7d50\u679c\u306b\u5dee\u304c\u51fa\u3066\u3044\u307e\u3059\u3002\u3069\u3061\u3089\u306e\u6b63\u3057\u3044\u5024\u304b\u3068\u3044\u3046\u3068 Legacy Facet \u304c\u6b63\u3057\u3044\u5024\u3068\u306a\u308a\u307e\u3059\u3002\u8a66\u3057\u306b ```kcal:66``` \u3067\u691c\u7d22\u3057\u3066\u307f\u308b\u3068\u300112 \u4ef6\u3068\u8fd4\u3063\u3066\u304d\u307e\u3059\u304c\u3001JSON Facet \u306e\u7d50\u679c \u3067\u306f 9 \u4ef6\u3067\u3042\u308a\u3001\u8aa4\u3063\u305f\u5024\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002\n\n```\n$ curl http://localhost:8983/solr/sushi/select?q=kcal:66\n\n...\n\n# numFound \u304c 12\n<result name=\"response\" numFound=\"12\" start=\"0\" maxScore=\"4.048882\"/>\n```\n\n### \u306a\u305c JSON Facet \u3067\u8aa4\u3063\u305f\u5024\u304c\u8fd4\u3063\u305f\u306e\u304b\uff1f\n\n\u3053\u308c\u306f\u3001Legacy Facet \u3067\u306f refine \u51e6\u7406\u304c\u884c\u308f\u308c\u308b\u306e\u306b\u5bfe\u3057\u3066\u3001**JSON Facet \u3067\u306f refine \u51e6\u7406\u304c\u884c\u308f\u308c\u306a\u3044**\u305f\u3081\u3067\u3059\u3002\n\u7c21\u5358\u306b JSON Facet \u3068 Legacy Facet \u306e\u51e6\u7406\u306e\u9055\u3044\u3092\u78ba\u8a8d\u3057\u3066\u307f\u307e\u3057\u3087\u3046\u3002\n\u5c1a\u3001\u4eca\u56de\u306e\u8aac\u660e\u306f\u30d0\u30b1\u30c3\u30c8\u306e\u30bd\u30fc\u30c8\u3092\u4ef6\u6570\u9806 (count) \u3068\u3057\u3066\u3044\u308b\u3002\n\n**JSON Facet**\n\n1. shard \u3054\u3068\u306b\u5404\u30d0\u30b1\u30c3\u30c8\u306b\u542b\u307e\u308c\u308b\u4ef6\u6570\u3092\u30ab\u30a6\u30f3\u30c8\u3059\u308b\u3002\n2. \u4e0a\u4f4d limit \u6570\u3060\u3051\u306e\u30d0\u30b1\u30c3\u30c8\u3092\u5404 shard \u304b\u3089\u53d6\u5f97\u3057\u3001\u4ef6\u6570\u3092\u30de\u30fc\u30b8\u3059\u308b\u3002\n3. \u4ef6\u6570\u306e\u591a\u3044\u4e0a\u4f4d limit \u4ef6\u306e\u30d0\u30b1\u30c3\u30c8\u3092\u30ec\u30b9\u30dd\u30f3\u30b9\u3068\u3057\u3066\u8fd4\u3059\u3002\n\n\u3053\u306e\u6642\u3001\u56f3\u304b\u3089\u5206\u304b\u308b\u3088\u3046\u306b\u3001\nshard1 \u306e kcal:74\u3001shard2 \u306e kcal:66, kcal:68 \u306e\u4ef6\u6570\u306f\u7121\u8996\u3055\u308c\u3066\u3057\u307e\u3063\u3066\u3044\u308b\u3002\u305d\u306e\u305f\u3081\u3001\u6700\u7d42\u7684\u306b\u4ef6\u6570\u306b\u305a\u308c\u304c\u751f\u3058\u308b\u3002\n\n![JSON Facet - \u51e6\u7406\u30d5\u30ed\u30fc](https://qiita-image-store.s3.amazonaws.com/0/155697/32118c1e-8d96-2beb-371d-96edd5072019.png)\n\n**Legacy Facet**\n\n1. shard \u3054\u3068\u306b\u5404\u30d0\u30b1\u30c3\u30c8\u306b\u542b\u307e\u308c\u308b\u4ef6\u6570\u3092\u30ab\u30a6\u30f3\u30c8\u3059\u308b\u3002\n2. \u4e0a\u4f4d limit \u6570\u3060\u3051\u306e\u30d0\u30b1\u30c3\u30c8\u3092\u5404 shard \u304b\u3089\u53d6\u5f97\u3057\u3001\u4ef6\u6570\u3092\u30de\u30fc\u30b8\u3059\u308b\u3002\n3. \u4ef6\u6570\u306e\u591a\u3044\u4e0a\u4f4d limit \u4ef6\u306e\u30d0\u30b1\u30c3\u30c8\u3092**\u7279\u5b9a**\u3059\u308b\u3002\n4. **\u518d\u5ea6\u5404 shard \u306b\u554f\u3044\u5408\u308f\u305b\u3001\u7279\u5b9a\u3057\u305f\u30d0\u30b1\u30c3\u30c8\u306b\u3064\u3044\u3066\u30d0\u30b1\u30c3\u30c8\u306b\u542b\u307e\u308c\u308b\u4ef6\u6570\u3092\u30ab\u30a6\u30f3\u30c8\u3059\u308b\u3002\uff08refine \u51e6\u7406)**\n5. \u30d0\u30b1\u30c3\u30c8\u3092\u5404 shard \u304b\u3089\u53d6\u5f97\u3057\u4ef6\u6570\u3092\u30de\u30fc\u30b8\u3059\u308b\u3002\n6. \u30ec\u30b9\u30dd\u30f3\u30b9\u3068\u3057\u3066\u8fd4\u3059\u3002\n\nLegacy Facet \u306f JSON Facet \u3068\u7570\u306a\u308a\u3001\u300c4\u300d\u306b\u3066\u5404 shard \u306b\u518d\u5ea6\u554f\u3044\u5408\u308f\u305b\u308b\u3053\u3068\u3067\u3001\u4ef6\u6570\u306e refine \u51e6\u7406\u3092\u884c\u3063\u3066\u3044\u308b\u3002\n\n![Legacy Facet - \u51e6\u7406\u30d5\u30ed\u30fc1](https://qiita-image-store.s3.amazonaws.com/0/155697/f79e4d10-6f32-91b1-bc3b-4a11234b89ff.png)\n\n![Legacy Facet - \u51e6\u7406\u30d5\u30ed\u30fc2](https://qiita-image-store.s3.amazonaws.com/0/155697/e919e768-3e3f-f881-4a22-df18f10eac9e.png)\n\n\u4e21\u8005\u3092\u6bd4\u8f03\u3059\u308b\u3068\u3001**JSON Facet \u306b\u306f Legacy Facet \u3067\u884c\u3063\u3066\u3044\u308b refine \u51e6\u7406\u304c\u306a\u3044\u305f\u3081\u3001\u9ad8\u901f\u306b\u51e6\u7406\u3092\u8fd4\u3059\u3053\u3068\u304c\u3067\u304d\u308b\u53cd\u9762\u3001\u4ef6\u6570\u306b\u305a\u308c\u304c\u751f\u3058\u308b**\u3053\u3068\u304c\u5206\u304b\u308b\u3002\n\n### \u30ab\u30fc\u30c7\u30a3\u30ca\u30ea\u30c6\u30a3\u3068\u306e\u7d61\u307f\n\n**\u30ab\u30fc\u30c7\u30a3\u30ca\u30ea\u30c6\u30a3\u304c\u4f4e\u3044\u5834\u5408**\u306f\u3001\u30d0\u30b1\u30c3\u30c8\u6570\u304c\u5c11\u306a\u3044\u72b6\u614b\u3067\u3042\u308b\u305f\u3081\u3001\u6700\u7d42\u7684\u306b\u4e0a\u4f4d\u306b\u306a\u308b\u30d0\u30b1\u30c3\u30c8\u304c\u5404 shard \u306e\u4e0a\u4f4d limit \u306b\u542b\u307e\u308c\u3084\u3059\u304f\u306a\u308b\u3002\u305d\u306e\u305f\u3081\u3001**\u4ef6\u6570\u3092\u53d6\u308a\u3053\u307c\u3059\u53ef\u80fd\u6027\u304c\u4f4e\u304f\u306a\u308b**\u3002\n\n**\u30ab\u30fc\u30c7\u30a3\u30ca\u30ea\u30c6\u30a3\u304c\u9ad8\u3044\u5834\u5408**\u306f\u3001\u305d\u306e\u9006\u3067\u3001\u6700\u7d42\u7684\u306b\u4e0a\u4f4d\u306b\u306a\u308b\u30d0\u30b1\u30c3\u30c8\u304c\u5404 shard \u306e\u4e0a\u4f4d limit \u306b\u542b\u307e\u308c\u3065\u3089\u304f\u306a\u308b\u3002\u3088\u3063\u3066\u3001**\u4ef6\u6570\u3092\u53d6\u308a\u3053\u307c\u3059\u53ef\u80fd\u6027\u304c\u9ad8\u304f\u306a\u308b**\u3002\n\n## \u3058\u3083\u3042\u3069\u3046\u3059\u308c\u3070\uff1f\n\n\u65b9\u6cd5\u306f\u3044\u304f\u3064\u304b\u3042\u308a\u307e\u3059\u3002\n\n1. Legacy Facet\n2. \u5fc5\u8981\u306a\u4ef6\u6570\u3088\u308a\u5927\u304d\u3044 limit \u3092\u6307\u5b9a\u3059\u308b\uff08```limit:-1``` \u3067\u5168\u4ef6)\n3. shard \u6570\u3092\u5897\u3084\u3059\n4. **overrequest** \u3092\u5229\u7528\u3059\u308b\n\n\u3044\u308d\u3044\u308d\u30e1\u30ea\u30c3\u30c8\u30fb\u30c7\u30e1\u30ea\u30c3\u30c8\u304c\u3042\u308a\u307e\u3059\u304c\u3001\u3053\u3053\u3067\u306f\u300c4\u300d\u306e\u65b9\u6cd5\u3067\u8a71\u3092\u9032\u3081\u307e\u3059\u3002\n\n### overrequest\nJSON Facet \u306e overrequest \u306f Solr-6.3.0 \u304b\u3089\u5b9f\u88c5\u3055\u308c\u3066\u3044\u308b\u30aa\u30d7\u30b7\u30e7\u30f3\u3067\u3059\u3002\n\n> Add \"overrequest\" parameter to JSON Facet API to control amount of overrequest on a distributed terms facet\n\nhttp://lucene.apache.org/solr/news.html\n\n\u3053\u308c\u3092\u5229\u7528\u3059\u308b\u3053\u3068\u3067\u3001\u5404 shard \u304b\u3089\u8fd4\u5374\u3055\u308c\u308b\u30d0\u30b1\u30c3\u30c8\u6570\u3092 limit \u3088\u308a\u3082 over \u306b request \u3059\u308b\u3053\u3068\u304c\u53ef\u80fd\u306b\u306a\u308a\u3001\u8003\u616e\u3067\u304d\u3066\u3044\u306a\u304b\u3063\u305f\u4e0b\u4f4d\u306e\u30d0\u30b1\u30c3\u30c8\u306e\u4ef6\u6570\u3082\u8003\u616e\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\n\n![JSON Facet - overrequest](https://qiita-image-store.s3.amazonaws.com/0/155697/0370e9e8-9ef5-2f2b-4c5d-e1069df6c447.png)\n\n\u5b9f\u306f\u3001\u4ee5\u524d\u304b\u3089 JSON Facet \u306e\u51e6\u7406\u306e\u5185\u90e8\u3067\u306f overrequest \u3092\u884c\u306a\u3063\u3066\u3044\u305f\u306e\u3067\u3059\u304c\u3001\u30c7\u30d5\u30a9\u30eb\u30c8\u5024\u304c\u6307\u5b9a\u3055\u308c\u3066\u304a\u308a\u3001\u5916\u304b\u3089\u30b3\u30f3\u30c8\u30ed\u30fc\u30eb\u3067\u304d\u307e\u305b\u3093\u3067\u3057\u305f\u3002\n\u4ee5\u4e0b\u306e ```freq.limit``` \u306f\u30ea\u30af\u30a8\u30b9\u30c8\u6642\u306e limit \u30aa\u30d7\u30b7\u30e7\u30f3\u3067\u6307\u5b9a\u3057\u305f\u5024\u3067\u3059\u304c\u3001\u3053\u308c\u306b\u5b9a\u6570\u500d\u3057\u3066\u3044\u308b\u306e\u304c\u5206\u304b\u308a\u307e\u3059\u3002\n[Solr-6.0.0 - FacetField.java#L582-L583](https://github.com/apache/lucene-solr/blob/releases/lucene-solr/6.0.0/solr/core/src/java/org/apache/solr/search/facet/FacetField.java#L582-L583)\n\n```java\n// add a modest amount of over-request if this is a shard request\nint lim = freq.limit >= 0 ? (fcontext.isShard() ? (int)(freq.limit*1.1+4) : (int)freq.limit) : Integer.MAX_VALUE;\n```\n\n\u2193\n\nSolr-6.3.0 \u304b\u3089\u306f\u30ea\u30af\u30a8\u30b9\u30c8\u6642\u306b\u6307\u5b9a\u3057\u305f overrequest \u30aa\u30d7\u30b7\u30e7\u30f3\u306e\u5024 (```freq.overrequest```) \u3092 limit \u306e\u5024\uff08```effectiveLimit```\uff09 \u306b\u52a0\u7b97\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u308b\u306e\u304c\u5206\u304b\u308a\u307e\u3059\u3002\u3053\u308c\u3067\u6700\u7d42\u7684\u306b\u5404 shard \u304b\u3089\u8fd4\u3059\u30d0\u30b1\u30c3\u30c8\u6570\u304c limit + overrequest \u306b\u5897\u3048\u308b\u3053\u3068\u306b\u306a\u308a\u307e\u3059\u3002\n[Solr-6.3.0 - FacetFieldProcessor.java#L221-L225](https://github.com/apache/lucene-solr/blob/releases/lucene-solr/6.3.0/solr/core/src/java/org/apache/solr/search/facet/FacetFieldProcessor.java#L221-L225)\n\n```java\nif (freq.overrequest == -1) {  // \u2190 overrequest \u3092\u6307\u5b9a\u3057\u306a\u3044\u3068\u304d\u306e\u30c7\u30d5\u30a9\u30eb\u30c8\u5024\u306f -1\n  effectiveLimit = (long) (effectiveLimit*1.1+4); // default: add 10% plus 4 (to overrequest for very small limits)\n} else {\n  effectiveLimit += freq.overrequest;  // \u2190 \u6307\u5b9a\u3059\u308b\u3053\u3068\u3067\u30b3\u30f3\u30c8\u30ed\u30fc\u30eb\u3067\u304d\u308b\n}\n```\n\n### overrequest \u3092\u8a66\u3059\n\noverrequest \u306e\u5024\u3092\u6307\u5b9a\u3057\u3066 Legacy Facet \u3068\u540c\u3058\u7d50\u679c\u3092\u53d6\u5f97\u3067\u304d\u308b\u304b\u78ba\u8a8d\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\n```\n$ curl http://localhost:8983/solr/sushi/select -d 'q=*:*&rows=0&\njson.facet={\n  kcal:{\n    type:terms,\n    field:kcal,\n    limit:5,\n    overrequest:31\n  }\n}\n'\n```\n```xml\n<lst name=\"facets\">\n  <long name=\"count\">344</long>\n  <lst name=\"kcal\">\n    <arr name=\"buckets\">\n      <lst>\n        <long name=\"val\">66</long>\n        <long name=\"count\">12</long>\n      </lst>\n      <lst>\n        <long name=\"val\">74</long>\n        <long name=\"count\">12</long>\n      </lst>\n      <lst>\n        <long name=\"val\">68</long>\n        <long name=\"count\">10</long>\n      </lst>\n      <lst>\n        <long name=\"val\">72</long>\n        <long name=\"count\">10</long>\n      </lst>\n      <lst>\n        <long name=\"val\">82</long>\n        <long name=\"count\">10</long>\n      </lst>\n    </arr>\n  </lst>\n</lst>\n```\n\n\u306f\u3044\u3001\u540c\u3058\u306b\u306a\u308a\u307e\u3057\u305f\u3002overrequest \u306e\u5024\u306b 31 \u3092\u6307\u5b9a\u3057\u3066\u3044\u307e\u3059\u304c\u3001\u4eca\u56de\u306e\u30b1\u30fc\u30b9\u3067\u306f limit + 31 \u306e\u30d0\u30b1\u30c3\u30c8\u3092\u5404 shard \u304b\u3089\u8fd4\u3059\u5fc5\u8981\u304c\u3042\u3063\u305f\u3088\u3046\u3067\u3059\u300231 \u3068\u3044\u3046\u5024\u306f\u3001\u7d50\u679c\u304c\u540c\u3058\u306b\u306a\u308b\u307e\u3067\u30a4\u30f3\u30af\u30ea\u30e1\u30f3\u30c8\u3057\u305f\u7d50\u679c\u3067\u3059\u30fb\u30fb\u30fb\u3002\u7d39\u4ecb\u3057\u3066\u304a\u3044\u3066\u306a\u3093\u3067\u3059\u304c\u3001\u6b63\u76f4\u4f7f\u3044\u3065r\uff08ry\n\n## \u307e\u3068\u3081\n\n- JSON Facet \u306f Legacy Facet \u3088\u308a\u3082\u901f\u304f\u3066\u4f7f\u3044\u3084\u3059\u3044\u3067\u3059\u304c\u3001\u7528\u6cd5\u7528\u91cf\u3092\u5b88\u308a\u307e\u3057\u3087\u3046\u3002\n- \u30ab\u30fc\u30c7\u30a3\u30ca\u30ea\u30c6\u30a3\u306e\u9ad8\u3044\u30d5\u30a3\u30fc\u30eb\u30c9\u3067\u306f overrequest \u304c\u52b9\u304f\u30b1\u30fc\u30b9\u3082\u3042\u308b\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u3002\n\n## \u88dc\u8db3\n\noverrequest \u306b\u306f\u3001\u5404\u30d0\u30b1\u30c3\u30c8\u306e\u4ef6\u6570\u306e\u6b63\u78ba\u6027\u3092\u9ad8\u3081\u308b\u305f\u3081\u3060\u3051\u3067\u306a\u304f\u3001\u4e0a\u4f4d\u306b\u6765\u308b\u30d0\u30b1\u30c3\u30c8\u81ea\u4f53\u306e\u6b63\u78ba\u6027\u3092\u9ad8\u3081\u308b\u3068\u3044\u3046\u76ee\u7684\u3082\u3042\u308a\u307e\u3059\u3002\u3053\u308c\u306f JSON Facet\u3001Legacy Facet \u3044\u305a\u308c\u306b\u3082\u5f53\u3066\u306f\u307e\u308b\u3082\u306e\u3067\u3059\u3002\u4f59\u529b\u304c\u3042\u308c\u3070\u3001\u3044\u3064\u304b\u66f8\u3053\u3046\u3068\u601d\u3044\u307e\u3059\u3002\n"}