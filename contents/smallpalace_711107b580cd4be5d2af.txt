{"tags": ["GitLab"], "context": "gitlab\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u30a2\u30c3\u30d7\u3068\u79fb\u884c\u3092\u3068\u3044\u3046\u3053\u3068\u3067\u3084\u308a\u307e\u3057\u305f\u3002\n\u305d\u306e\u5099\u5fd8\u9332\u3067\u3059\u3002\n6.8\u304b\u30898.11\u306bup\u304b\u3064\u30bd\u30fc\u30b9mysql\u304b\u3089ommunibus\u306epostgresql\u306b\u30b3\u30f3\u30d0\u30fc\u30c8\n\uff08CentOS6\u304b\u30897\u306b\u3082\u4e0a\u3052\u3066\u3044\u308b\u304cAMI\u3092Packer\u3067\u3064\u304f\u3063\u305f\u308achef\u3063\u3066\u3044\u308b\u8a73\u7d30\u306f\u5272\u611b\u3002\uff09\n\u3081\u3063\u3061\u3083\u306a\u304c\u3044\u3067\u3059\u3002\u30e1\u30f3\u30c66\u6642\u9593\u304f\u3089\u3044\u3002\n\u30d0\u30fc\u30b8\u30e7\u30f3\u30a2\u30c3\u30d7\u306f\u57fa\u672c\u7684\u306b\u306f\u3053\u306e\u8fba\u304b\u3089\u305f\u3069\u308b\u3068\u5927\u4f53\u66f8\u3044\u3066\u3042\u308b\u3068\u304a\u308a\u3067\u3059\u3002\nhttps://github.com/gitlabhq/gitlabhq/tree/master/doc/update\n\n\u65e7\u74b0\u5883\u3068\u65b0\u74b0\u5883\u306e\u60c5\u5831\n\u65e7\uff1a\nCentOS6\napache+passenger,mysql,redis,git,gitlab6.8,ldap\u8a8d\u8a3c\n\u65b0\uff1a\nCentOS7\nommunibus gitlab(nginx,redis,postgresql\u7b49\u305c\u3093\u3076\u3044\u308a\u3067\u5225\u306b\u5165\u308c\u308b\u5fc5\u8981\u304c\u306a\u3044\uff09\n\u6697\u53f7\u5316\u3001\u8a8d\u8a3c\u307e\u308f\u308a\u306f\u540c\u69d8\u306b\u8a2d\u5b9a\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u3002\n\u7279\u8a18\u4e8b\u9805\uff1a\n\u30fb\u30d0\u30fc\u30b8\u30e7\u30f3\u5909\u308f\u308b\u3054\u3068\u306b\u6bce\u56dedb\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u3057\u3066\u3044\u308b\u3088\u3046\u3067\u3001\n\u3000\u7570\u306a\u308b\u30d0\u30fc\u30b8\u30e7\u30f3\u3069\u3046\u3057\u3067mysqldump\u3067\u5fa9\u65e7\u306f\u3067\u304d\u306a\u3044\u4ed5\u69d8\u3002\n\u30fb\u30bd\u30fc\u30b9\u7248\u3060\u3068\u30d0\u30fc\u30b8\u30e7\u30f3\u30a2\u30c3\u30d7\u306e\u624b\u9593\u304c\u304b\u304b\u308b\u306e\u3067\u904b\u7528\u304c\u697d\u306b\u306a\u308b\u306e\u3092\u898b\u8d8a\u3057\u3066ommunibus\u7248\u306b\u3059\u308b\u3002\n\u3000mysql\u304b\u3089postgresql\u306b\u306a\u308b\u306e\u3067\u30c7\u30fc\u30bf\u306e\u30b3\u30f3\u30d0\u30fc\u30c8\u304c\u5fc5\u8981\u3002\n\u3000mysql\u306b\u3057\u3066\u305f\u306e\u306fRDS\u4f7f\u3044\u305f\u304b\u3063\u305f\u305b\u3044\u3002\u5197\u9577\u6027\u3092\u697d\u306b\u5b9f\u73fe\u3067\u304d\u308bMultiAZ\u306b\u3057\u305f\u3044\u3002\n\u3000\u3044\u307e\u306fpostgresql\u306eRDS\u3082\u3042\u308b\u306e\u3067\u305d\u308c\u3092\u3064\u304b\u3046\u3002\n\u30fbCentOS6->7\u3067\u304b\u308f\u308b\u306a\u3068\u601d\u3063\u305f\u306e\u306f\u4e3b\u306b\u4ee5\u4e0b\uff08gitlab\u306f\u307b\u307c\u95a2\u4fc2\u306a\u3044\uff09\n\u3000systemd\u306b\u306a\u308b\uff08service\u304b\u3089systemctl\u306b\u306a\u308b\u3051\u3069chef\u7684\u306b\u610f\u8b58\u4e0d\u5fc5\u8981\u3001host\u540d\u5909\u66f4\u304c\u30aa\u30d7\u30b7\u30e7\u30f3\u6307\u5b9a\u3067\u6c38\u7d9a\u5316\u3067\u3079\u3093\u308a\uff09\n\u3000ntpd\u304c\u6a19\u6e96\u3067\u306a\u304f\u306a\u308b\u304c\u4ee3\u308f\u308a\u306e\u306f\u3046\u308b\u3046\u79d2\u306e\u30d0\u30fc\u30b9\u30c8\u66f4\u65b0\u7684\u306a\u6319\u52d5\u304c\u3042\u3084\u3046\u3044\u306e\u3067ntpd\u3064\u304b\u3046\u306e\u304c\u3044\u3044\u6c17\u304c\u3057\u3066\u3044\u308b\n\u3000apache\u304c2.4\u6a19\u6e96\u306b\u306a\u3063\u3066\u30a2\u30af\u30bb\u30b9\u5236\u5fa1\u306e\u8a18\u8ff0\u306e\u4ed5\u65b9\u3068\u30ed\u30fc\u30c9\u30e2\u30b8\u30e5\u30fc\u30eb\u3068\u304b\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u306e\u69cb\u9020\u304c\u304b\u308f\u308b\n\u3000\u3042\u3068\u306f\u30d1\u30c3\u3068\u601d\u3044\u51fa\u305b\u306a\u3044\u3002\n\n\uff10\uff0e\u30de\u30a4\u30b0\u30ec\u74b0\u5883\u306e\u4e0b\u6e96\u5099\u3092\u3059\u308b\n\u30fbAMI\u3068\u3063\u3066\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u74b0\u5883\u3092\u8907\u88fd\u3059\u308b\n\u5148\u306bgitlab\u306b\u30ed\u30b0\u30a4\u30f3\u3057\u3066\u4ee5\u4e0b\u3092\u6253\u3064\n$ sudo chkconfig gitlab off\n\nAMI\u306f\u30b3\u30f3\u30bd\u30fc\u30eb\u304b\u3089no_reboot\u3067\u3068\u308b\uff08\u5148\u306b\u66f4\u65b0\u3067\u304d\u306a\u3044\u3088\u3046\u306b\u65e7\u30b5\u30fc\u30d0\u3092\u4e38\u3054\u3068\u6b62\u3081\u3068\u3044\u3066\u3082\u3044\u3044\u304b\u3082\nAMI\u304c\u3067\u304d\u305f\u3089\u305d\u3053\u304b\u3089\u8d77\u52d5\u3057\u305f\u306e\u3082\u3092\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u74b0\u5883\u3068\u3057\n\u30ed\u30b0\u30a4\u30f3\u3059\u308b\n\uff08\u30d0\u30fc\u30b8\u30e7\u30f3\u30a2\u30c3\u30d7\u3068\u30c7\u30fc\u30bf\u306e\u30b3\u30f3\u30d0\u30fc\u30c8\u3092\u3059\u3059\u3081\u308b\u74b0\u5883\uff09\n# aws ec2 describe-security-groups --filters Name=group-name,Values=SG_xxxxxx --profile xxxxx\n# aws ec2 describe-instances --instance-ids i-xxxxx --profile xxxxx\n\n\u672c\u79fb\u884c\u7528\u306f\u6700\u65b0AMI\u3092\u3068\u3063\u3066\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u8d77\u52d5\u3059\u308b\n(\u65e7\u4e16\u4ee3\u3067HVM\u3067\u306f\u306a\u304b\u3063\u305f\u306e\u3067m4\u3068\u304b\u4f7f\u3048\u306a\u304b\u3063\u305f\u306f\u305a\uff09\naws ec2 run-instances \\\n--profile xxxx \\\n--image-id ami-xxxxxx \\\n--count 1 \\\n--key-name hogexxxx \\\n--security-group-ids sg-xxxxxx sg-xxxxxx \\\n--instance-type m3.large \\\n--placement AvailabilityZone=us-xxxx-xa,Tenancy=default \\\n--monitoring Enabled=false \\\n--subnet-id subnet-xxxxxxx \\\n--associate-public-ip-address\n\nnewip=\nssh user@${newip}\n\ngitlab\u304c\u505c\u6b62\u3057\u3066\u3044\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3059\u308b\n$ netstat -lnpt\n$ ps -ef\n$ sudo service gitlab status\n\n\u30b3\u30d4\u30fc\u5143\u3068\u533a\u5225\u3059\u308b\u305f\u3081\u306bhost\u540d\u3092\u5909\u66f4\u3059\u308b\n$ sudo hostname gitlab-test   ##\u540d\u524d\u9055\u3048\u3070\u306a\u3093\u3067\u3082\u3044\u3044\u304chosts\u3082\u4f75\u305b\u3066\u5909\u3048\u308b\n$ bash\n$ uname -n\n\nhosts\u3092\u7de8\u96c6\u3057\u3066\u81ea\u5206\u304c\u672c\u7269\u306egitlab\u3060\u3068\u8a8d\u8b58\u3055\u305b\u3066\u304a\u304f\n$ sudo vi /etc/hosts\n\n10.124.0.xxx    gitlab-test   gitlab  gitlab.xxxx.xxxx.xxxxx.net localhost\n\n\u65e7gitlab\u306e\u306f\u30b3\u30e1\u30f3\u30c8\u5316\u3059\u308b\u3002\n\u30fbRDS\u306emysqldump\u3092\u3068\u3063\u3066\u30ed\u30fc\u30ab\u30ebdb\u306b\u6295\u5165\u3001database.yml\u3092\u7de8\u96c6\u3057DB\u63a5\u7d9a\u3092\u30ed\u30fc\u30ab\u30eb\u306b\u5909\u3048\u308b\nmysql\u3092\u8d77\u52d5\n$ sudo vi /etc/my.cnf\n\u5fc5\u8981\u304c\u3042\u308c\u3070\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092\u9069\u5f53\u306b\u76f4\u3059\uff08\u8d77\u52d5\u3057\u306a\u304b\u3063\u305f\u3089\u30a8\u30e9\u30fc\u30ed\u30b0\u307f\u3066\u76f4\u3059\uff09\n$ sudo service mysql start\n$ sudo view /var/log/mysqld/mysqld.log\n\nrake\u3067\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u3068\u308d\u3046\u3068\u3059\u308b\u3068\u4ee5\u4e0b\u30a8\u30e9\u30fc\u304c\u3067\u308b\u306e\u3067\u30b7\u30f3\u30dc\u30ea\u30c3\u30af\u30ea\u30f3\u30af\u3092\u8cbc\u308b\n\uff08\u307e\u305f\u306f/etc/my.cnf\u306esocket=\u3092\u4fee\u6b63\u3057\u3066mysql\u3092\u518d\u8d77\u52d5\u3059\u308b\uff09\nCan't connect to local MySQL server through socket '/tmp/mysql.sock' (2)\n$ sudo ln -s /var/lib/mysql/mysql.sock /tmp/mysql.sock\n\n\u672c\u756a\u304b\u3089single-transaction\u3067\u30c7\u30fc\u30bf\u3092\u30c0\u30f3\u30d7\u3057\u3066\u30ed\u30fc\u30ab\u30eb\u306b\u3044\u308c\u308b\n$ mysqldump -u gitlab -p -h hoge-gitlab-rds.mng.hoge.local --databases gitlabhq_production --quote-names --opt --single-transaction --hex-blob -R > /tmp/mysqldump-`date +%Y%m%d`.sql\n$ mysql -u gitlab -p --default-character-set=utf8 < /tmp/mysqldump-`date +%Y%m%d`.sql\n\n\u30a2\u30ab\u30a6\u30f3\u30c8\u307e\u308f\u308a\u3092\u4e00\u5fdc\u78ba\u8a8d\u3059\u308b\n$ pt-show-grants -u root -p\n\n\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092\u7de8\u96c6\u3057\u3066gitlab\u304b\u3089\u8a8d\u8b58\u3055\u308c\u308b\u5148\u3092\u30ed\u30fc\u30ab\u30eb\u306b\u5909\u3048\u308b\n$ sudo vi /home/git/gitlab/config/database.yml\n  host: hoge-gitlab-rds.mng.hoge.local\n   \u2193\n  host: localhost\n\n\u305f\u3076\u3093\u30b5\u30fc\u30d3\u30b9\u8d77\u52d5\u505c\u6b62\u4ee5\u5916\u306fgit\u30e6\u30fc\u30b6\u3067\u4f5c\u696d\u3002\n\n\uff11\uff0e6.x\u304b\u30897.14\u3078\u30d0\u30fc\u30b8\u30e7\u30f3\u30a2\u30c3\u30d7\n\u30fbrake\u3067backup\u3092\u3068\u308b\uff08\u4f7f\u308f\u306a\u3044\u304c\u5ff5\u306e\u305f\u3081\n$ sudo su - git\n$ cd gitlab\n$ bundle exec rake gitlab:backup:create RAILS_ENV=production\n\n$ ls -lh tmp/backups/\n-rw-r--r-- 1 git git 705M  3\u6708  5 15:17 2015 1425568606_gitlab_backup.tar\n$ df -h;df -i\n\n\u30fbruby\u3092\u5165\u308c\u308b\nmkdir /tmp/ruby && cd /tmp/ruby\ncurl --progress https://cache.ruby-lang.org/pub/ruby/2.1/ruby-2.1.6.tar.gz | tar xz\ncd ruby-2.1.6\n./configure --disable-install-rdoc\nmake -j 2\nsudo make install\n\n$ /usr/local/bin/gem environment\n\n\u3044\u308d\u3044\u308dPATH\u3092\u901a\u3057\u3066\u304a\u304f\n$ sudo su - git\n$ vi ~/.bashrc\nexport PATH=/usr/local/bin:/opt/chef/embedded/bin:$PATH\nexport LD_LIBRARY_PATH=/usr/local/lib:/usr/local/lib/ruby/2.1.0:$LD_LIBRARY_PATH\nexport RUBYLIB=/usr/local/lib/ruby/2.1.0:$RUBYLIB\n\n$ vi ~/.gemrc \ngempath:\n- /usr/local/lib/ruby/2.1.0\ngem: --no-rdoc --no-ri\n\n$ bash\n$ gem env\n\n\u30fbbundler\u5165\u308c\u308b\n$ sudo /usr/local/bin/gem install bundler --no-ri --no-rdoc\n\ngitlab\u306f\u3068\u307e\u3063\u3066\u308b\u306e\u3067\u305d\u306e\u307e\u307e\u30d0\u30fc\u30b8\u30e7\u30f3\u30a2\u30c3\u30d7\u4f5c\u696d\u3092\u3059\u3059\u3081\u308b\n\u30fb7\u7cfb\u306egitlab\u306b\u30c1\u30a7\u30c3\u30af\u30a2\u30a6\u30c8\n$ sudo su - git\n$ cd /home/git/gitlab\n$ git fetch --all\n\n$ git checkout -- db/schema.rb\n$ git checkout 7-14-stable\n\n\u30fb\u5fc5\u8981\u306a\u30d1\u30c3\u30b1\u30fc\u30b8\u5165\u308c\u308b\n$ sudo yum install logrotate cmake nodejs libkrb5-dev pkg-config\n\n\u30fbredis\u3092unix\u30bd\u30b1\u30c3\u30c8\u4f7f\u3046\u3088\u3046\u306b\u3059\u308b\n$ sudo service redis stop\n$ sudo cp -p /etc/redis.conf{,.org}\n$ sudo vi /etc/redis.conf\n$ diff /etc/redis.conf{,.org} \n72,73c72\n< unixsocket /var/run/redis/redis.sock\n< unixsocketperm 775\n---\n> # unixsocketperm 755\n$ sudo service redis start\n\n\u30fbgit\u30e6\u30fc\u30b6\u306e\u30b5\u30d6\u30b0\u30eb\u30fc\u30d7\u306bredis\u3092\u8ffd\u52a0\n$ sudo usermod -aG redis git\n$ id git\nuid=1001(git) gid=1001(git) \u6240\u5c5e\u30b0\u30eb\u30fc\u30d7=1001(git),494(redis)\n\n$ sudo su - git\n$ cd gitlab\n$ cp config/resque.yml.example config/resque.yml\n$ cat config/resque.yml\n\n$ vim /home/git/gitlab-shell/config.yml\n  socket: /var/run/redis/redis.sock\n\n\u30fbgitlab-shell\u3092\u5408\u3046\u30d0\u30fc\u30b8\u30e7\u30f3\u306b\u30c1\u30a7\u30c3\u30af\u30a2\u30a6\u30c8\u3059\u308b\n$ cd /home/git/gitlab-shell\n$ git fetch\n$ git checkout v2.6.5\n\n\u30fb\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\uff08mysql\u306e\u5834\u5408\uff09\n$ cd /home/git/gitlab\n$ /usr/local/bin/bundle install --without development test postgres --deployment\n\n\u30fb# Enable internal issue IDs (introduced in GitLab 6.1)\n$ /usr/local/bin/bundle exec rake migrate_iids RAILS_ENV=production\n\nrouge\u306e\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u30a8\u30e9\u30fc\u304c\u3067\u305f\u3089Gemfile.lock\u7de8\u96c6\u3057\u3066rouge\u30921.10.0\u306b\u4fee\u6b63\u3059\u308b\u3068\u51fa\u306a\u304f\u306a\u308b\u3051\u3069\u51fa\u3066\u3082\u5225\u306b\u4f5c\u696d\u3059\u3059\u307e\u306a\u3044\u3053\u3068\u3082\u306a\u3044\u3057checkout\u3067\u306a\u304a\u3055\u306a\u3044\u3068pull\u5931\u6557\u3059\u308b\u306e\u3067\u7121\u8996\u3057\u3066\u5927\u4e08\u592b\n/home/git/gitlab/vendor/bundle/ruby/2.1.0/gems/rouge-1.9.1/lib/rouge/lexers/shell.rb:20: warning: already initialized constant Rouge::Lexers::Shell::KEYWORDS\n/home/git/gitlab/vendor/bundle/ruby/2.1.0/gems/rouge-1.9.1/lib/rouge/lexers/shell.rb:20: warning: previous definition of KEYWORDS was here\n/home/git/gitlab/vendor/bundle/ruby/2.1.0/gems/rouge-1.9.1/lib/rouge/lexers/shell.rb:25: warning: already initialized constant Rouge::Lexers::Shell::BUILTINS\n\n\u30fbdb\u3092\u30de\u30a4\u30b0\u30ec\n$ /usr/local/bin/bundle exec rake db:migrate RAILS_ENV=production\n\n\u30fb\u30d7\u30ec\u30b3\u30f3\u30d1\u30a4\u30eb\n$ bundle exec rake assets:clean assets:precompile cache:clear RAILS_ENV=production\n\n$ chmod u+rwx,g+rx,o-rwx /home/git/gitlab-satellites\n\n$ ls -dl /home/git/gitlab-satellites\ndrwxr-x--- 6 git git 4096  8\u6708 19 08:40 2016 /home/git/gitlab-satellites\n\n$ cp -p /etc/init.d/gitlab{,.`date +%Y%m%d-1`}\n$ cp lib/support/init.d/gitlab /etc/init.d/gitlab\n\n\u30fb\u8a2d\u5b9a\n$ vi config/gitlab.yml\n\n\u30b3\u30e1\u30f3\u30c8\u4ee5\u5916\u306e\u3068\u3053\u308d\u3092\u4fee\u6b63\u3002gitlab.yml\u306f\u3053\u306e\u6bb5\u968e\u3067\u306a\u304a\u3055\u306a\u304f\u3066\u3082\u5225\u306b\u5927\u4e08\u592b\u3002\n$ git diff 6-8-stable:config/unicorn.rb.example 7-14-stable:config/unicorn.rb.example\n\n-worker_processes 2\n+worker_processes 3\n\n-listen \"/home/git/gitlab/tmp/sockets/gitlab.socket\", :backlog => 64\n+listen \"/home/git/gitlab/tmp/sockets/gitlab.socket\", :backlog => 1024\n\n-timeout 30\n+timeout 60\n\n$ vi config/unicorn.rb\n\n$ cd ../gitlab-shell/\n$ cat VERSION \n$ git diff v1.9.4:config.yml.example v2.6.5:config.yml.example\n\n+  # pass: redispass # Allows you to specify the password for Redis\n+  database: 0\n+  socket: /var/run/redis/redis.sock # Comment out this line if you want to use TCP\n\n # Log file.\n@@ -39,3 +55,11 @@ log_level: INFO\n\n+git_annex_enabled: false\n\n$ vi config.yml\n\n$ cd ../gitlab\n\n$ diff config/initializers/rack_attack.rb{,.example}\n$ cp config/initializers/rack_attack.rb.example config/initializers/rack_attack.rb\n\n\u30fb\u8d77\u52d5\n$ sudo service gitlab start\n\n\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u30a8\u30e9\u30fc\u304c\u51fa\u305f\u3089yml\u306e\u30b7\u30f3\u30bf\u30c3\u30af\u30b9\u30a8\u30e9\u30fc\u306a\u306e\u3067typo\u3092\u307f\u306a\u304a\u3059\u3002\nPsych::SyntaxError: (<unknown>): did not find expected key while parsing a block mapping at line 129 column 4\n\n\u30a8\u30e9\u30fc\u304c\u3069\u3046\u306b\u3082\u306a\u3089\u306a\u304b\u3063\u305f\u3089\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u306e\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u3068\u3063\u3066\u304b\u3089\u65b0\u30d0\u30fc\u30b8\u30e7\u30f3\u306e\u30b5\u30f3\u30d7\u30eb\u3068\u898b\u6bd4\u3079\u306a\u304c\u3089\u4fee\u6b63\u3059\u308b\n\u3082\u3057apache\u304c\u304a\u3061\u3066\u305f\u3089\u8d77\u52d5\n$ sudo service httpd start\n\n\u30fb\u74b0\u5883\u60c5\u5831\u78ba\u8a8d\u3068\u30c6\u30b9\u30c8\n$ sudo su - git\n$ cd gitlab\n$ bundle exec rake gitlab:env:info RAILS_ENV=production\n\n$ bundle exec rake gitlab:check RAILS_ENV=production\n\nSend ping to redis server: Could not connect to Redis at /var/run/redis/redis.socket: No such file or directory\ngitlab-shell self-check failed\n  Try fixing it:\n  Make sure GitLab is running;\n  Check the gitlab-shell configuration file:\n  sudo -u git -H editor /home/git/gitlab-shell/config.yml\n  Please fix the error above and rerun the checks.\n\nvim /home/git/gitlab-shell/config.yml\n/var/run/redis/redis.socket\n\u2193\n/var/run/redis/redis.sock\n\n\u30fbdb\u306eALTER\u7b49\u3092\u30de\u30cb\u30e5\u30a2\u30eb\u3069\u304a\u308a\u3084\u308b\n\u30de\u30cb\u30e5\u30a2\u30eb\u3069\u304a\u308a\u672c\u4f53\u306f\u3068\u3081\u3068\u304f\n$ sudo service gitlab stop\n\n$ mysql -u gitlab -p\n\n6.8\u304b\u3089\u5fc5\u8981\u305d\u3046\u306a\u306e\u3092\u9078\u3093\u3067\u5b9f\u65bd\u3002\nmysql> use gitlabhq_production\nmysql> SELECT CONCAT('ALTER TABLE gitlabhq_production.', table_name, ' ENGINE=InnoDB;') AS 'Copy & run these SQL statements:' FROM information_schema.tables WHERE table_schema = 'gitlabhq_production' AND `ENGINE` <> 'InnoDB' AND `TABLE_TYPE` = 'BASE TABLE';\nmysql> SET foreign_key_checks = 0;\nmysql> SELECT CONCAT('ALTER TABLE gitlabhq_production.', table_name, ' CONVERT TO CHARACTER SET utf8 COLLATE utf8_general_ci;') AS 'Copy & run these SQL statements:' FROM information_schema.tables WHERE table_schema = 'gitlabhq_production' AND `TABLE_COLLATION` <> 'utf8_unicode_ci' AND `TABLE_TYPE` = 'BASE TABLE';\nmysql> SET foreign_key_checks = 1;\nmysql> show grants for 'gitlab'@'localhost';\n\n\u30fbgitlab\u3092\u8d77\u52d5\u3057\u3066\u30ed\u30b0\u30a4\u30f3\u78ba\u8a8d\u3092\u3059\u308b\u3001help\u3067\u30d0\u30fc\u30b8\u30e7\u30f3\u304c\u4e0a\u304c\u3063\u3066\u3044\u308b\u3053\u3068\u3092\u78ba\u8a8d\ngitlab\u3092\u8d77\u52d5\u3059\u308b\n$ sudo service gitlab start\n\ngitlab.mng.hoge.example.net\u3092\u30ed\u30fc\u30ab\u30ebPC\u306ehost\u306b\u767b\u9332\u3057\u3066\u30d6\u30e9\u30a6\u30b6\u304b\u3089\u898b\u3066\u307f\u308b\u3002\n\"PublicIpAddress\"\u3092\u78ba\u8a8d\n$ aws ec2 describe-instances --instance-ids i-xxxxxxxx --profile xxxx\nor\n$ curl -s http://169.254.169.254/latest/meta-data/public-ipv4\n\n\u30d6\u30e9\u30a6\u30b6\u3067help\u304b\u3089\u30d0\u30fc\u30b8\u30e7\u30f3\u304c\u4e0a\u304c\u3063\u3066\u3044\u308b\u3053\u3068\u3092\u78ba\u8a8d\n\n\uff12\uff0e7.14\u304b\u30898.0\u3078\u30d0\u30fc\u30b8\u30e7\u30f3\u30a2\u30c3\u30d7\n\u30fbgitlab\u3092\u6b62\u3081\u308b\n$ sudo service gitlab stop\n\n\u30fbrake\u3067bkup\u3057\u3088\u3046\u3068\u3057\u305f\u3089\u6a29\u9650\u304c\u305f\u3089\u306a\u304b\u3063\u305f\u3089\u3057\u3044\u306e\u3067\u4ed8\u4e0e\nDumping MySQL database gitlabhq_production ... mysqldump: Got error: 1044: Access denied for user 'gitlab'@'localhost' to database 'gitlabhq_production' when using LOCK TABLES\n\n$ mysql -u root -p\nmysql> GRANT LOCK TABLES ON gitlabhq_production.* TO 'gitlab'@'localhost';\nmysql> FLUSH PRIVILEGES;\n\n\u30fbrake\u3067backup\u3092\u3068\u308b\n$ sudo su - git\n$ cd gitlab\n$ bundle exec rake gitlab:backup:create RAILS_ENV=production\n$ ls -lh tmp/backups/\n\n-rw-rw-r-- 1 git git 1.9G  9\u6708 14 07:32 2016 1473838054_gitlab_backup.tar\n-rw------- 1 git git 1.9G  9\u6708 15 01:10 2016 1473901803_gitlab_backup.tar\n\n\u30fbgit\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u3092\u4e0a\u3052\u308b\n$ /usr/local/bin/git --version\ngit version 1.9.0\n\n\u4f9d\u5b58\u30d1\u30c3\u30b1\u30fc\u30b8\u3092update\u3059\u308b\n$ sudo yum install libcurl-devel libxslt-devel libxml2-devel expat-devel gettext openssl-devel zlib-devel\n\nsudo wget https://www.kernel.org/pub/software/scm/git/git-2.9.3.tar.gz -P /usr/local/src\ncd /usr/local/src/\nsudo tar zxf git-2.9.3.tar.gz\ncd /usr/local/src/git-2.9.3\nsudo ./configure --prefix=/usr/local/git\nsudo make all\nsudo make install\n\n$ /usr/local/bin/git --version\ngit version 2.9.3\n\n\u30fb\u30d0\u30fc\u30b8\u30e7\u30f3\u30a2\u30c3\u30d7\u4f5c\u696d\u3092\u3059\u3059\u3081\u308b\n\u30fb8.0\u306egitlab\u306b\u30c1\u30a7\u30c3\u30af\u30a2\u30a6\u30c8\nlatest\u3060\u30688-11-stable\u3060\u3063\u305f\u3063\u307d\u3044\u304c\u30e1\u30b8\u30e3\u30fc\u30d0\u30fc\u30b8\u30e7\u30f3\u304c\u4e0a\u304c\u308b\u306e\u306f\u6bb5\u968e\u3092\u8e0f\u307e\u306a\u3044\u3068\u5371\u967a\u305d\u3046\u306a\u306e\u30678.0\u306e\u30b3\u30fc\u30c9\u306bcheckout\u3059\u308b\n$ sudo su - git\n$ cd gitlab\n\n    rouge\u3092\u7121\u7406\u3084\u308a\u4e0a\u3052\u305a\u306b\u30a8\u30e9\u30fc\u7121\u8996\u306e\u5834\u5408\u306f\u4ee5\u4e0b\u4e0d\u8981\n    $ git checkout  Gemfile.lock\n$ git fetch --all\n$ git checkout db/schema.rb\n$ git checkout 8-0-stable\n\n\u30fbGo\u3092\u5165\u308c\u308b\ncurl --remote-name --progress https://storage.googleapis.com/golang/go1.5.linux-amd64.tar.gz\nsudo tar -C /usr/local -xzf go1.5.linux-amd64.tar.gz\nsudo ln -sf /usr/local/go/bin/{go,godoc,gofmt} /usr/local/bin/\nrm go1.5.linux-amd64.tar.gz\n$ which go\n\n\u30fbgitlab-git-http-server\u306f\u5165\u308c\u305a\u306bgitlab-workhorse\u3092\u5165\u308c\u3066\u6700\u65b0\u306b\u3059\u308b\uff08replace\u3068update\u306e\u624b\u9593\u3092\u306f\u3076\u304f\uff09\nsudo su - git\n$ cd /home/git\ngit clone https://gitlab.com/gitlab-org/gitlab-workhorse.git\ncd /home/git/gitlab-workhorse\ngit fetch --all\ngit checkout v0.7.11\nmake\n\n$ cd /home/git/gitlab\n$ git checkout 8-2-stable\n$ git diff 8-0-stable:lib/support/init.d/gitlab.default.example 8-2-stable:lib/support/init.d/gitlab.default.example\n$ exit\n$ sudo cp -p /home/git/gitlab/lib/support/init.d/gitlab.default.example /etc/default/gitlab\n$ view /etc/default/gitlab\n\n\u3051\u3063\u3053\u3046\u3061\u304c\u3046\u3088\u3046\u306a\u306e\u3067\u8d77\u52d5\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u30b3\u30d4\u30fc\u3057\u3066\u304a\u304f\n\uff088.2\u306e\u8d77\u52d5\u30b9\u30af\u30ea\u30d7\u30c8\u3067\u306a\u3044\u3068workhouse\u304c\u8d77\u52d5\u3057\u306a\u3044\u306e\u30678-2-stable\u306bcheckout\u3057\u305f\u72b6\u614b\u3067\u30b3\u30d4\u30fc\uff09\n$ exit\n$ sudo cp -p /etc/init.d/gitlab{,.714.bk}\n$ sudo cp /home/git/gitlab/lib/support/init.d/gitlab /etc/init.d/gitlab\n$ sudo cp -p /etc/init.d/gitlab{,.80.bk}\n\n$ sudo su - git\n$ cd gitlab\n$ git checkout 8-0-stable\n\n\u30fb\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306e\u9375\u60c5\u5831\u304c\u5fc5\u8981\u306b\u306a\u308b\u3089\u3057\u3044\u306e\u3067\u8ffd\u52a0\u3057\u3066\u304a\u304f\n# cp config/secrets.yml.example config/secrets.yml\n# chmod 0600 config/secrets.yml\n# chown git. /home/git/gitlab/config/secrets.yml    ###\u30aa\u30fc\u30ca\u30fc\u304cgit\u3067\u306a\u3044\u3068db:migrate\u3057\u3063\u3071\u3044\u3059\u308b\u3002\n# vi config/secrets.yml\n  db_key_base: **********\n\nsudo su - git\ncd gitlab\n$ bundle install --without postgres development test --deployment\n$ bundle exec rake db:migrate RAILS_ENV=production\n\n$ bundle exec rake assets:clean assets:precompile cache:clear RAILS_ENV=production\n\ndiff lib/support/init.d/gitlab /etc/init.d/gitlab\n\n\u30fbgitlab\u3092\u8d77\u52d5\u3057\u3066\u30ed\u30b0\u30a4\u30f3\u78ba\u8a8d\u3092\u3059\u308b\u3001help\u3067\u30d0\u30fc\u30b8\u30e7\u30f3\u304c\u4e0a\u304c\u3063\u3066\u3044\u308b\u3053\u3068\u3092\u78ba\u8a8d\n\u30b5\u30fc\u30d0\u8d77\u52d5\n$ sudo service gitlab start\n\n$ sudo su - git\n$ cd gitlab\n$ bundle exec rake gitlab:env:info RAILS_ENV=production\n\n\u30c1\u30a7\u30c3\u30af\u306e\u524d\u306b\u6a29\u9650\u4fee\u6b63\u3001\nchmod 0750 /home/git/gitlab/public/uploads\n mkdir /home/git/gitlab/public/uploads/tmp\nfind /home/git/gitlab/public/uploads -type d -not -path /home/git/gitlab/public/uploads -exec chmod 0755 {} \\;\nls -lh /home/git/gitlab/public/uploads\n\n\u30c1\u30a7\u30c3\u30af\n$ bundle exec rake gitlab:check RAILS_ENV=production\n\nInit script up-to-date? ... no\u3000\u306b\u306a\u308b\u3051\u3069\u3055\u3089\u306b\u65b0\u3057\u304f\u3057\u3066\u308b\u3060\u3051\u3067\u8d77\u52d5\u3057\u3066\u308b\u306e\u3067\u554f\u984c\u306a\u3057\n\u3068\u308a\u3042\u3048\u305a\u30d6\u30e9\u30a6\u30b6\u3067\u78ba\u8a8d\u3002\n\u30d0\u30fc\u30b8\u30e7\u30f3\u304c8.05\u306b\u306a\u3063\u3066\u308b\u3053\u3068\u3092\u78ba\u8a8d\n\n\uff13\uff0e8.0\u304b\u30898.11\u3078\u30d0\u30fc\u30b8\u30e7\u30f3\u30a2\u30c3\u30d7\n\u30fbrake\u3067backup\u3092\u3068\u308b\uff08\u5ff5\u306e\u305f\u3081\uff09\nbundle exec rake gitlab:backup:create RAILS_ENV=production\n$ ls -lh tmp/backups\n\n-rw------- 1 git git 1.9G  9\u6708 15 02:09 2016 1473905330_gitlab_backup.tar\n\n\u30fbgitlab\u3092\u6b62\u3081\u308b\n$ sudo service gitlab stop\n\n\u30fb\u30d0\u30fc\u30b8\u30e7\u30f3\u30a2\u30c3\u30d7\u4f5c\u696d\u3092\u3059\u3059\u3081\u308b\n$ sudo su - git\n$ cd gitlab\n$ pwd\n/home/git/gitlab\n\n\u30fbUpdate Ruby\n$ cd /tmp/ruby\ncurl --remote-name --progress https://cache.ruby-lang.org/pub/ruby/2.3/ruby-2.3.1.tar.gz\ntar xzf ruby-2.3.1.tar.gz\ncd ruby-2.3.1\n./configure --disable-install-rdoc\nmake\nsudo make install\n\n$ ruby -v\nruby 2.3.1p112 (2016-04-26 revision 54768) [x86_64-linux]\n\n\u30e9\u30a4\u30d6\u30e9\u30ea\u306e\u30d1\u30b9\u3092\u901a\u3059(/usr/local/lib/ruby/2.3.0)\n$ sudo su - git\n$ vi ~/.bashrc\nexport LD_LIBRARY_PATH=/usr/local/lib:/usr/local/lib/ruby/2.3.0:$LD_LIBRARY_PATH\nexport RUBYLIB=/usr/local/lib/ruby/2.3.0:$RUBYLIB\n$ vi ~/.gemrc\ngempath:\n- /usr/local/lib/ruby/2.3.0\ngem: --no-rdoc --no-ri\n$ gem env gempath\n\nsudo su -\n\ngit\u3068\u540c\u3058\u3088\u3046\u306bpath\u3092\u3068\u304a\u3059\u3001bundler\u3092\u5165\u308c\u308b\n$ bash\n$ sudo /usr/local/bin/gem install bundler --no-ri --no-rdoc\n\n\u30fb\u30c1\u30a7\u30c3\u30af\u30a2\u30a6\u30c8\n$ cd gitlab\n$ git checkout -- db/schema.rb\n$ git checkout 8-11-stable\n$ git branch\n\n\u30fbUpdate gitlab-shell\ncd /home/git/gitlab-shell\n$ git fetch --all --tags\ngit checkout v3.4.0\n\n\u30fb\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3068\u30de\u30a4\u30b0\u30ec\u30fc\u30c8\u3068\u30d7\u30ec\u30b3\u30f3\u30d1\u30a4\u30eb\u3068\u30ad\u30e3\u30c3\u30b7\u30e5\u30af\u30ea\u30a2\u3001\u8d77\u52d5\u30b9\u30af\u30ea\u30d7\u30c8\u30b3\u30d4\u30fc\u3002\ncd /home/git/gitlab\n$ bundle install --without postgres development test --deployment\n$ bundle clean\n$ bundle exec rake db:migrate RAILS_ENV=production\n$ bundle exec rake assets:clean assets:precompile cache:clear RAILS_ENV=production\n\n$ sudo cp -p /etc/init.d/gitlab{,.8.2}\n$ sudo cp /home/git/gitlab/lib/support/init.d/gitlab /etc/init.d/gitlab\n\n\u30fb\u8a2d\u5b9a\u6bd4\u8f03,\u4fee\u6b63\n$ sudo su - git\n$ cd gitlab\n$ git diff origin/8-0-stable:config/gitlab.yml.example origin/8-11-stable:config/gitlab.yml.example\n$ cp -p config/gitlab.yml{,.80}\n$ cp -p config/gitlab.yml.example config/gitlab.yml\n$ vim config/gitlab.yml\n$ vim config/gitlab.yml.80\n\u898b\u6bd4\u3079\u306a\u304c\u3089\u306a\u304a\u3059\n$ diff config/gitlab.yml{,.example}\n32,34c32,34\n<     host: gitlab.mng.hoge.example.net\n<     port: 443 # Set to 443 if using HTTPS, see installation.md#using-https for additional HTTPS configuration details\n<     https: true # Set to true if using HTTPS, see installation.md#using-https for additional HTTPS configuration details\n---\n>     host: localhost\n>     port: 80 # Set to 443 if using HTTPS, see installation.md#using-https for additional HTTPS configuration details\n>     https: false # Set to true if using HTTPS, see installation.md#using-https for additional HTTPS configuration details\n70c70\n<     email_from: gitlab@mng.hoge.example.com\n---\n>     email_from: example@example.com\n215c215\n<     enabled: true\n---\n>     enabled: false\n235c235\n<         host: '10.xxx.xxx.xxx'\n---\n>         host: '_your_ldap_server'\n237,238c237\n<         #uid: 'sAMAccountName'\n<         uid: 'uid'\n---\n>         uid: 'sAMAccountName'\n240,241c239,240\n<         bind_dn: 'uid=Auth,ou=System,dc=hoge,dc=example,dc=net'\n<         password: '******'\n---\n>         bind_dn: '_the_full_dn_of_the_user_you_will_bind_with'\n>         password: '_the_password_of_the_bind_user'\n251c250\n<         active_directory: false\n---\n>         active_directory: true\n262c261\n<         allow_username_or_email_login: true\n---\n>         allow_username_or_email_login: false\n273c272\n<         base: 'dc=hoge,dc=example,dc=net'\n---\n>         base: ''\n282c281\n<         user_filter: \"\"\n---\n>         user_filter: ''\n480c479\n<     bin_path: /usr/local/bin/git\n---\n>     bin_path: /usr/bin/git\n\n\u30fbsmtp\u307e\u308f\u308a\n$ cp -p config/initializers/smtp_settings.rb.sample config/initializers/smtp_settings.rb\n$ vi config/initializers/smtp_settings.rb\n\n\u3044\u3061\u304a\u3046\u30ed\u30fc\u30ab\u30eb\u306b\u3064\u306a\u3050\u4f53\u3067\u4fee\u6b63\n$ diff config/initializers/smtp_settings.rb.sample config/initializers/smtp_settings.rb\n15,22c15,22\n<     address: \"email.server.com\",\n<     port: 465,\n<     user_name: \"smtp\",\n<     password: \"123456\",\n<     domain: \"gitlab.company.com\",\n<     authentication: :login,\n<     enable_starttls_auto: true,\n<     openssl_verify_mode: 'peer' # See ActionMailer documentation for other possible options\n---\n>     address: \"localhost\",\n>     port: 25,\n>     user_name: \"git\",\n>     password: \"\",\n>     domain: \"gitlab.mng.hoge.example.net\",\n> #    authentication: :login,\n>     enable_starttls_auto: false,\n> #    openssl_verify_mode: 'peer' # See ActionMailer documentation for other possible options\n\n$ sudo cp /home/git/gitlab/lib/support/init.d/gitlab /etc/init.d/gitlab\n\n$ sudo chmod 700 /home/git/gitlab/public/uploads\n$ sudo find /home/git/gitlab/public/uploads -type f -exec chmod 0644 {} \\;\n$ sudo find /home/git/gitlab/public/uploads -type d -not -path /home/git/gitlab/public/uploads -exec chmod 0700 {} \\;\n\n$ sudo cp -p /home/git/gitlab-shell/config.yml{,.80}\n$ sudo vim /home/git/gitlab-shell/config.yml\n$ vim /home/git/gitlab-shell/config.yml.example \n\n\u307f\u304f\u3089\u3079\u3066\u3044\u3089\u306a\u3044\u306e\u6d88\u3059\u306a\u3069\u4fee\u6b63\u3059\u308b\n$ sudo diff /home/git/gitlab-shell/config.yml{,.80}\n18c18\n< #repos_path: \"/home/git/repositories\"\n---\n> repos_path: \"/home/git/repositories\"\n\nunicorn\u4e00\u5fdc\u78ba\u8a8d\n$ cp -p config/unicorn.rb{,.80}\n$ diff config/unicorn.rb{,.80}\n39c39\n< listen \"/home/git/gitlab/tmp/sockets/gitlab.socket\", :backlog => 1024\n---\n> listen \"/home/git/gitlab/tmp/sockets/gitlab.socket\", :backlog => 64\n43c43\n< timeout 60\n---\n> timeout 30\n\n\u8d77\u52d5\u3057\u306a\u304b\u3063\u305f\u3089/home/git/gitlab/log\u306e\u3057\u305f\u306e\u30ed\u30b0\u3092\u307f\u308b\uff08\u5927\u4f53\u30d1\u30fc\u30b9\u30a8\u30e9\u30fc\u306a\u306e\u3067\u30b5\u30f3\u30d7\u30eb\u30b3\u30d4\u30fc\u3057\u3066\u7de8\u96c6\u63a8\u5968\uff09\n\u30fbgitlab\u3092\u8d77\u52d5\u3057\u3066\u30ed\u30b0\u30a4\u30f3\u78ba\u8a8d\u3092\u3059\u308b\u3001help\u3067\u30d0\u30fc\u30b8\u30e7\u30f3\u304c\u4e0a\u304c\u3063\u3066\u3044\u308b\u3053\u3068\u3092\u78ba\u8a8d\n$ sudo service gitlab start\n$ service httpd restart\n$ sudo su - git\n$ cd gitlab\n\n$ bundle exec rake gitlab:env:info RAILS_ENV=production\n$ bundle exec rake gitlab:check RAILS_ENV=production\n\n\u30d6\u30e9\u30a6\u30b6\u304b\u3089\u307f\u308b\nhttps://gitlab.mng.hoge.example.net/help\n\u306a\u3093\u304b8.11.7\u306b\u306a\u3063\u3066\u30de\u30a4\u30ca\u30fc\u30d0\u30fc\u30b8\u30e7\u30f3\u304c\u4e0a\u304c\u3063\u3066\u305f\u306e\u3067\u4e8b\u524d\u306b\u4fee\u6b63\u3057\u3066\u3042\u3063\u305fchef\u30ea\u30dd\u30b8\u30c8\u30ea\u306e\u30d1\u30c3\u30b1\u30fc\u30b8\u30d0\u30fc\u30b8\u30e7\u30f3\u3092\u306a\u304a\u3059\u306a\u3069\u3002\n\n\uff14\uff0emysql\u304b\u3089postgresql\u3078\u30b3\u30f3\u30d0\u30fc\u30c8\n\u30fbgitlab\u3092\u6b62\u3081\u308b\n$ sudo service gitlab stop\n\n\u30fbrake\u3067backup\u3092\u3068\u308b\n$ sudo su - git\n$ cd gitlab\n$ bundle exec rake gitlab:backup:create RAILS_ENV=production\n$ ls -lh tmp/backups/\n-rw------- 1 git git 1.9G  9\u6708 15 04:50 2016 1473915031_gitlab_backup.tar\n\n\n$ bk_prefix=1473915031 ##\u2605ls\u306e\u7d50\u679c\u3092\u5909\u6570\u306b\u5165\u308c\u308b\n\n\u30fbpython\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u30922.7\u4ee5\u4e0a\u306b\u3059\u308b\n$ python -V \nPython 2.6.6\n$ cd /usr/local/src\n$ sudo curl -O https://www.python.org/ftp/python/2.7.12/Python-2.7.12.tgz \n$ sudo tar zxf Python-2.7.12.tgz \n$ cd Python-2.7.12\n$ sudo ./configure\n$ sudo make\n$ sudo make install\n\n$ which python\n/usr/local/bin/python\n$ /usr/local/bin/python -V\nPython 2.7.12\n\n\u30fb\u30b3\u30f3\u30d0\u30fc\u30c8\u30c4\u30fc\u30eb\u3067\u30b3\u30f3\u30d0\u30fc\u30c8\u3059\u308b\n$ sudo su - git\ncd gitlab\n$ mkdir -p tmp/backups/postgresql\n$ cp tmp/backups/${bk_prefix}_gitlab_backup.tar tmp/backups/postgresql/\n\ndisk\u304c\u8db3\u3089\u306a\u304f\u306a\u308b\u306e\u3067\u3053\u3053\u3067\u4e0d\u8981\u306a\u53e4\u3044backup\u306f\u6d88\u3059\u3002\n$ df -h\n$ ls -lh /home/git/gitlab/tmp/backups\n$ rm -f /home/git/gitlab/tmp/backups/1425568606_gitlab_backup.tar\n$ rm -f /home/git/gitlab/tmp/backups/1425914208_gitlab_backup.tar\n$ df -h\n$ ls -lh /home/git/gitlab/tmp/backups\n\n$ sudo su - git\n$ cd tmp/backups/postgresql\n$ mysqldump --compatible=postgresql --default-character-set=utf8 -r gitlabhq_production.mysql -u root gitlabhq_production -p\nEnter password: \n$ ls\n\n$ git clone https://github.com/gitlabhq/mysql-postgresql-converter.git -b gitlab\n$ ls\n\n$ mkdir db\n$ python mysql-postgresql-converter/db_converter.py gitlabhq_production.mysql db/database.sql\n$ ed -s db/database.sql < mysql-postgresql-converter/move_drop_indexes.ed\n\n\u30a2\u30fc\u30ab\u30a4\u30d6\u3059\u308b\n$ gzip db/database.sql\n$ ls db\ndatabase.sql.gz\n\n\u30fb\u540c\u540d\u306emysql\u306e\u30a2\u30fc\u30ab\u30a4\u30d6\u30c7\u30fc\u30bf\u3068\u5165\u308c\u66ff\u3048\u308b\n$ tar tf ${bk_prefix}_gitlab_backup.tar\n$ tar rf ${bk_prefix}_gitlab_backup.tar db/database.sql.gz\n\n\u7acb\u3066\u305f\u3089omunibus\u306egitlab\u306b\u30b3\u30f3\u30d0\u30fc\u30c8\u6e08\u307f\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u3092\u8ee2\u9001\u3059\u308b\n$ newgitlab=\n$ bk_prefix=\n$ sudo scp -Cp /home/git/gitlab/tmp/backups/postgresql/${bk_prefix}_gitlab_backup.tar user@${newgitlab}:/tmp/\n\n\n\uff15\uff0epostgresql\u306eRDS\u3092\u7528\u610f\u3001\u30d1\u30e9\u30e1\u30fc\u30bf\u30b0\u30eb\u30fc\u30d7\u8abf\u6574\n\u30b9\u30da\u30c3\u30af\u306fdb.t2.large\u306b\u78ba\u5b9a\nhttp://qiita.com/awakia/items/9981f37d5cbcbcd155eb\nhttp://dev.classmethod.jp/cloud/aws/rds-postgres-log-settings/\nhttp://tdoc.info/blog/2012/07/09/postgres_tuning.html\nhttps://www.postgresql.org/docs/9.5/static/runtime-config-logging.html\ngitlab-postgres-9-5\u7b49\u306e\u540d\u524d\u3067postgresql9.5\u7528\u306b\u4f5c\u6210\n\u30c7\u30d5\u30a9\u30eb\u30c8\u5024\u7b49\u3092\u78ba\u8a8d\u3002\nSELECT name,setting,unit FROM pg_settings;\n\nlog_min_duration_statement = 250ms\nlog_temp_files = 0\nlog_checkpoints = 1\nlog_lock_waits = 1\nlog_connections = 1\nlog_disconnections = 1\n\nshared_buffers instance\u30bf\u30a4\u30d7\u3054\u3068\u306b\u52dd\u624b\u306b\u8abf\u6574\u3055\u308c\u308b\u306e\u3067\u6c17\u306b\u3057\u306a\u3044\u3053\u3068\u306b\u3059\u308b\nwork_mem 32768\u3000\u30c7\u30d5\u30a94096kb\u3060\u3063\u305f\u306e\u306732MB\u304b\u3089\u306f\u3058\u3081\u308b\u3089\u3057\u3044\u306e\u3067\u5897\u3084\u3059\nmaintenance_work_mem instance\u30bf\u30a4\u30d7\u3054\u3068\u306b\u52dd\u624b\u306b\u8abf\u6574\u3055\u308c\u308b\u306e\u3067\u6c17\u306b\u3057\u306a\u3044\u3053\u3068\u306b\u3059\u308b\neffective_cache_size instance\u30bf\u30a4\u30d7\u3054\u3068\u306b\u52dd\u624b\u306b\u8abf\u6574\u3055\u308c\u308b\u306e\u3067\u6c17\u306b\u3057\u306a\u3044\u3053\u3068\u306b\u3059\u308b\nrandom_page_cost 2 4\u3060\u3068\u304a\u304a\u304d\u3044\u3089\u3057\u3044\u306e\u30672\u306b\u3059\u308b\nsynchronous_commit \u6c7a\u6e08\u3092\u6271\u3046DB\u3067\u306f\u306a\u3044\u304c\u843d\u3061\u305f\u3068\u304d\u306b\u5371\u306a\u3044\u304b\u3089\u3044\u3058\u3089\u306a\u3044\n\npostgresql\u7528security_group\u66f4\u65b0\u307e\u305f\u306f\u4f5c\u6210\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u3002\n$ aws ec2 describe-security-groups --filters Name=group-name,Values=SG_xxxxxx --profile xxxx\n\nRDS\u3092\u4f5c\u6210\u3059\u308b\n\n    aws rds create-db-instance \\\n    --profile hoge \\\n    --db-name gitlabhq_production \\\n    --db-instance-identifier hoge-gitlab-rds \\\n    --storage-type gp2 \\\n    --allocated-storage 100 \\\n    --db-instance-class db.t2.large \\\n    --engine postgres \\\n    --engine-version 9.5 \\\n    --master-username gitlab \\\n    --master-user-password 'xxxxx***' \\\n    --db-security-groups sg-xxxxxxxx \\\n    --availability-zone us-xxxx-xa \\\n    --db-subnet-group-name xxxxxxxx \\\n    --db-parameter-group-name gitlab-postgres-9-5 \\\n    --preferred-maintenance-window \"tue:14:00-tue:14:30\" \\\n    --preferred-backup-window \"18:00-18:30\" \\\n    --backup-retention-period 7 \\\n    --port 5432 \\\n    --multi-az \\\n    --no-auto-minor-version-upgrade \\\n    --no-publicly-accessible\n\n\u203bcli\u3067\u3046\u307e\u304f\u3044\u304b\u305a\u30de\u30cd\u30b8\u30e1\u30f3\u30c8\u30b3\u30f3\u30bd\u30fc\u30eb\u306b\u3066\u540c\u69d8\u306e\u4f5c\u696d\u3092\u5b9f\u65bd\u3002\n\n\u30a8\u30f3\u30c9\u30dd\u30a4\u30f3\u30c8\u3092chef\u30ea\u30dd\u30b8\u30c8\u30ea\u306b\u767b\u9332\u6e08\u307f\u306e\u540d\u79f0\u3067route53\u306e\u30d7\u30e9\u30a4\u30d9\u30fc\u30c8\u30be\u30fc\u30f3\u306b\u767b\u9332\u3057\u3066\u304a\u304f\nMuliti-AZ\u3067\u5207\u308a\u66ff\u308f\u3063\u305f\u3068\u304d\u7528\u306bttl\u306f60\u3067CNAME\u3067\u767b\u9332\u3059\u308b\n\u3067\u3001gitlab\u540c\u68b1\u306eposgresql\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u304cOS\u6a19\u6e96\u3068\u540c\u30589.2\u3067RDS\u3067\u4f7f\u3048\u308b\u30d0\u30fc\u30b8\u30e7\u30f3\u304c9.3\uff5e9.5\u3068\u304b\u3060\u3063\u305f\u306e\u3067\u3001\u305d\u308c\u3060\u3068rails\u3067\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u304c\u4e0d\u53ef\u80fd\u306a\u30a8\u30e9\u30fc\u304c\u51fa\u305f\u306e\u3067\u3001\n$ sudo gitlab-rake gitlab:backup:create\nDumping database ... \nDumping PostgreSQL database gitlabhq_production ... pg_dump: server version: 9.5.2; pg_dump version: 9.2.18\npg_dump: aborting because of server version mismatch\n[FAILED]\nBackup failed\n\n9.5\u306e\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u5165\u308c\u3066/etc/gitlab/gitlab.rb\u306ePATH\u306e\u9806\u5e8f\u3092\u8abf\u6574\u3057\u307e\u3057\u305f\u3002\n$ sudo yum install https://yum.postgresql.org/9.5/redhat/rhel-7-x86_64/postgresql95-libs-9.5.4-2PGDG.rhel7.x86_64.rpm\n$ sudo yum install https://yum.postgresql.org/9.5/redhat/rhel-7-x86_64/postgresql95-9.5.4-2PGDG.rhel7.x86_64.rpm\n$ which psql\n/usr/bin/psql\n$ psql --version\npsql (PostgreSQL) 9.5.4\n\n$ sudo diff /etc/gitlab/gitlab.rb{,.`date +%Y%m%d`}\n\uff5e\u7565\uff5e\n247,248c247,248\n<   'PATH' => \"/usr/bin:/opt/gitlab/bin:/opt/gitlab/embedded/bin:/bin\" \n< }\n---\n> #   'PATH' => \"/opt/gitlab/bin:/opt/gitlab/embedded/bin:/bin:/usr/bin\" \n> # }\n\n\n\uff16\uff0eCentOS7\u304b\u3064ommunibus gitlab8.11\u306e\u65b0\u74b0\u5883\u3092\u69cb\u7bc9\nnginx\u306ehttps\u3001ldap\u8a8d\u8a3c\u3001smtp\u306f\u9001\u4fe1\u306e\u307f\u7b49\n\u4f5c\u3063\u3066\u304a\u3044\u305fAMI\u3068\u30ec\u30b7\u30d4\u3067\u305f\u3066\u307e\u3057\u305f\u3002\u8a73\u7d30\u306f\u5272\u611b\u3002\n/etc/gitlab/gitlab.rb\u306e\u5dee\u5206\u3060\u3051\u7f6e\u3044\u3068\u304d\u307e\u3059\u3002\n$ sudo diff /var/chef/backup/etc/gitlab/gitlab.rb.chef-20160915082044.674309 /etc/gitlab/gitlab.rb \n11c11\n< external_url 'http://ec2-xxxxxxx.us-xxxx-2.compute.amazonaws.com'\n---\n> external_url 'https://gitlab.mng.hoge.example.net/'\n21,24c21,24\n< # gitlab_rails['time_zone'] = 'UTC'\n< # gitlab_rails['gitlab_email_enabled'] = true\n< # gitlab_rails['gitlab_email_from'] = 'example@example.com'\n< # gitlab_rails['gitlab_email_display_name'] = 'Example'\n---\n> gitlab_rails['time_zone'] = 'UTC'\n> gitlab_rails['gitlab_email_enabled'] = true\n> gitlab_rails['gitlab_email_from'] = 'gitlab@mng.hoge.example.net'\n> gitlab_rails['gitlab_email_display_name'] = 'Gitlab'\n59c59\n< # gitlab_rails['incoming_email_enabled'] = true\n---\n> gitlab_rails['incoming_email_enabled'] = false\n107,127c107,127\n< # gitlab_rails['ldap_enabled'] = false\n< # gitlab_rails['ldap_servers'] = YAML.load <<-'EOS' # remember to close this block with 'EOS' below\n< #   main: # 'main' is the GitLab 'provider ID' of this LDAP server\n< #     label: 'LDAP'\n< #     host: '_your_ldap_server'\n< #     port: 389\n< #     uid: 'sAMAccountName'\n< #     method: 'plain' # \"tls\" or \"ssl\" or \"plain\"\n< #     bind_dn: '_the_full_dn_of_the_user_you_will_bind_with'\n< #     password: '_the_password_of_the_bind_user'\n< #     active_directory: true\n< #     allow_username_or_email_login: false\n< #     block_auto_created_users: false\n< #     base: ''\n< #     user_filter: ''\n< #     attributes:\n< #       username: ['uid', 'userid', 'sAMAccountName']\n< #       email:    ['mail', 'email', 'userPrincipalName']\n< #       name:       'cn'\n< #       first_name: 'givenName'\n< #       last_name:  'sn'\n---\n> gitlab_rails['ldap_enabled'] = true\n> gitlab_rails['ldap_servers'] = YAML.load <<-'EOS' # remember to close this block with 'EOS' below\n>   main: # 'main' is the GitLab 'provider ID' of this LDAP server\n>     label: 'LDAP'\n>     host: 'ldap1.mng.hoge.local'\n>     port: 389\n>     uid: 'uid'\n>     method: 'plain' # \"tls\" or \"ssl\" or \"plain\"\n>     bind_dn: 'uid=Auth,ou=System,dc=hoge,dc=example,dc=net'\n>     password: '************'\n>     active_directory: 'false'\n>     allow_username_or_email_login: 'true'\n>     block_auto_created_users: false\n>     base: 'dc=hoge,dc=example,dc=net'\n>     user_filter: ''\n>     attributes:\n>       username: ['uid', 'userid', 'sAMAccountName']\n>       email:    ['mail', 'email', 'userPrincipalName']\n>       name:       'cn'\n>       first_name: 'givenName'\n>       last_name:  'sn'\n247,248c247,248\n<   'PATH' => \"/usr/bin:/opt/gitlab/bin:/opt/gitlab/embedded/bin:/bin\" \n< }\n---\n> #   'PATH' => \"/opt/gitlab/bin:/opt/gitlab/embedded/bin:/bin:/usr/bin\" \n> # }\n281,283c281,283\n< # gitlab_rails['db_username'] = \"gitlab\"\n< # gitlab_rails['db_password'] = nil\n< # gitlab_rails['db_host'] = nil\n---\n> gitlab_rails['db_username'] = \"gitlab\"\n> gitlab_rails['db_password'] = '*******'\n> gitlab_rails['db_host'] = 'gitlab-db-psql.mng.hoge.local'\n322,323c322,323\n< # gitlab_rails['smtp_address'] = \"smtp.server\"\n< # gitlab_rails['smtp_port'] = 465\n---\n> gitlab_rails['smtp_address'] = \"elb-int-smtp.mng.hoge.local\"\n> gitlab_rails['smtp_port'] = 25\n326c326\n< # gitlab_rails['smtp_domain'] = \"example.com\"\n---\n> gitlab_rails['smtp_domain'] = \"mail.mng.hoge.example.net\"\n509d508\n< # postgresql['log_line_prefix'] = \"%a\"\n511d509\n< # postgresql['shared_preload_libraries'] = nil\n570d567\n< \n573c570\n< # nginx['redirect_http_to_https'] = false\n---\n> nginx['redirect_http_to_https'] = true\n576c573\n< # nginx['ssl_verify_client'] = \"off\" # enable/disable 2-way SSL client authentication\n---\n> nginx['ssl_verify_client'] = \"off\" # enable/disable 2-way SSL client authentication\n578,579c575,576\n< # nginx['ssl_certificate'] = \"/etc/gitlab/ssl/#{node['fqdn']}.crt\"\n< # nginx['ssl_certificate_key'] = \"/etc/gitlab/ssl/#{node['fqdn']}.key\"\n---\n> nginx['ssl_certificate'] = \"/etc/gitlab/ssl/gitlab.mng.hoge.example.net.crt\"\n> nginx['ssl_certificate_key'] = \"/etc/gitlab/ssl/gitlab.mng.hoge.example.net.key\"\n593,599c590,596\n< # nginx['proxy_set_headers'] = {\n< #  \"Host\" => \"$http_host\",\n< #  \"X-Real-IP\" => \"$remote_addr\",\n< #  \"X-Forwarded-For\" => \"$proxy_add_x_forwarded_for\",\n< #  \"X-Forwarded-Proto\" => \"https\",\n< #  \"X-Forwarded-Ssl\" => \"on\"\n< # }\n---\n> nginx['proxy_set_headers'] = {\n>   \"Host\" => \"$http_host\",\n>   \"X-Real-IP\" => \"$remote_addr\",\n>   \"X-Forwarded-For\" => \"$proxy_add_x_forwarded_for\",\n>   \"X-Forwarded-Proto\" => \"https\",\n>   \"X-Forwarded-Ssl\" => \"on\"\n>  }\n603,604c600\n< # nginx['real_ip_trusted_addresses'] = []\n< # nginx['real_ip_header'] = nil\n---\n> nginx['real_ip_trusted_addresses'] = ['10.xxx.xxx.0/20']# nginx['real_ip_header'] = nil\n\nnginx\u3092ssl\u3067\u3064\u304b\u3046\u305f\u3081\u306b\u306f\u8a3c\u660e\u66f8\u3092\u6240\u5b9a\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306bcommon\u30cd\u30fc\u30e0.{crt,key}\u3068\u3044\u3046\u3088\u3046\u306a\u611f\u3058\u306b\u7f6e\u3044\u3068\u304b\u306a\u3044\u3068\u8a8d\u8b58\u3055\u308c\u306a\u304b\u3063\u305f\u306e\u304c\u7f60\u3063\u307d\u304b\u3063\u305f\u3067\u3059\u3002\nldap\u306fsecondary\u6307\u5b9a\u3059\u308b\u3068\u30a8\u30e9\u30fc\u3067\u3066\u305f\u3002\u3042\u3068ldap\u306eCA\u8a3c\u660e\u66f8\u3064\u304b\u3046tls\u8a8d\u8a3c\u306f\u516c\u5f0f\u30b5\u30dd\u30fc\u30c8\u5916\u98a8\u3002\n \u21d2\u305d\u306e\u3054\u3001method:\u304ctls\u3058\u3083\u306a\u304f\u3066ssl\u306a\u3089\u8a3c\u660e\u66f8\u691c\u8a3c\u305b\u305a\u306b\u6697\u53f7\u5316\u901a\u4fe1\u53ef\u80fd\u3001\u3068\u3044\u3046\u3053\u3068\u304c\u308f\u304b\u308a\u307e\u3057\u305f\u3002\nssh 10.xxx.xxx.xxx\n\nchef\u306e\u5b9f\u884c\u72b6\u6cc1\u3092\u898b\u5b88\u308b\u3002\n\u51fa\u6765\u4e0a\u304c\u3063\u305f\u3089\u30ed\u30fc\u30ab\u30ebPC\u306ehosts\u3092\u3060\u307e\u3057\u3066\u30ed\u30b0\u30a4\u30f3\u3057\u3066\u307f\u308b\u3002\n    \u4fee\u6b63\u306e\u95a2\u4fc2\u3067\u5143\u306egitlab\u3092\u898b\u305f\u3044\u5834\u5408\u306fDNS\u30ad\u30e3\u30c3\u30b7\u30e5\u3092\u30af\u30ea\u30a2\u3059\u308b\u304b\u5143\u306egitlab\u3092\u30ed\u30fc\u30ab\u30ebPC\u306ehosts\u306b\u660e\u793a\u7684\u306b\u66f8\u304f\n    (windows\u306a\u3089ipconfig /flushdns\u3059\u308b\uff09\n$ sudo vim /etc/hosts\n\n\u3042\u3068hosts\u306e\u30c7\u30fc\u30bf\u3092chef\u30ea\u30dd\u30b8\u30c8\u30ea\u4fee\u6b63\u3057\u3066\u30b3\u30df\u30c3\u30c8\u3002\n\n\uff17\uff0e\u30b3\u30f3\u30d0\u30fc\u30c8\u6e08\u307f\u306e\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u3092\u65b0\u74b0\u5883\u306b\u30ec\u30b9\u30c8\u30a2\u3059\u308b\nomunibus-gitlab\u3067\u30ec\u30b9\u30c8\u30a2\u3059\u308b\n$ newgitlab=\n$ ls /tmp\n$ bkup_prefix=\n$ ssh user@${newgitlab}\n$ sudo cp /tmp/${bkup_prefix}_gitlab_backup.tar /var/opt/gitlab/backups/\n$ sudo chown -R git. /var/opt/gitlab/backups\n$ sudo gitlab-ctl stop unicorn\n$ sudo gitlab-ctl stop sidekiq\n$ sudo gitlab-rake gitlab:backup:restore BACKUP=${bkup_prefix}\n$ sudo gitlab-ctl start\n\n$ sudo chmod -R ug+rwX,o-rwx /var/opt/gitlab/git-data/repositories\n$ sudo chmod -R ug-s /var/opt/gitlab/git-data/repositories\n$ sudo find /var/opt/gitlab/git-data/repositories -type d -print0 | sudo xargs -0 chmod g+s\n$ sudo -u git -H /opt/gitlab/embedded/service/gitlab-shell/bin/create-hooks /var/opt/gitlab/git-data/repositories\n\n$ sudo gitlab-rake gitlab:check\n\n\u3053\u3053\u3067\u30ed\u30b0\u30a4\u30f3\u3067\u304d\u308b\u304b\u3092\u78ba\u8a8d(Standard/LDAP)\u3002\n\u30e1\u30fc\u30eb\u304c\u81ea\u5206\u306b\u5c4a\u304f\u304b\u3092mail\u30b3\u30de\u30f3\u30c9\u3067\u78ba\u8a8d\n\uff08gitlab\u304b\u3089\u306flocalhost\u306b\u5411\u3051\u3066\u3044\u3066postfix\u304c\u5225\u306eMTA\u306b\u30ea\u30ec\u30fc\u3057\u3066\u308b\u30ec\u30b7\u30d4\u3092\u524d\u304b\u3089chef\u3063\u3066\u3042\u308b\u306e\u3067\u7279\u306b\u624b\u4f5c\u696d\u306f\u306a\u3057\uff09\n$ echo test-komi |mail -s new-gittest test@fuga.co.jp\n\n\n\uff18\uff0eDNS\u3092\u5207\u308a\u66ff\u3048EIP\u3092\u4ed8\u3051\u66ff\u3048\u308b\u3001\u52d5\u4f5c\u3092\u78ba\u8a8d\u3059\u308b\n\u307e\u305ahosts\u3092\u5207\u308a\u66ff\u3048\u3066\u78ba\u8a8d\u3001\n\u554f\u984c\u306a\u3055\u305d\u3046\u3067\u3042\u308c\u3070\u30b0\u30ed\u30fc\u30d0\u30eb\u306e\u30ec\u30b3\u30fc\u30c9\u3092\u4fee\u6b63\ngitlab.mng.hoge.example.net \u3092\u30ed\u30fc\u30ab\u30ebIP\u306b\u4fee\u6b63\uff08VPN\u8d8a\u3057\u306b\u3064\u306a\u3050\u306e\u3067\u30d7\u30e9\u30a4\u30d9\u30fc\u30c8IP\uff09\nEIP \u3092\u65e7gitlab\u304b\u3089\u306f\u305a\u3057\u3066\u65b0gitlab\u306b\u3064\u3051\u308b\npull\u3057\u3066\u307f\u305f\u308a\u66f4\u65b0\u3057\u305f\u30ea\u30dd\u30b8\u30c8\u30ea\u3092push\u3059\u308b\u306a\u3069\n\u3000\u3000\u554f\u984c\u304c\u3042\u3063\u3066\u5207\u308a\u623b\u3059\u5834\u5408\u306f\u6b62\u3081\u3068\u3044\u305f\u65e7\u30b5\u30fc\u30d0\u3092\u8d77\u52d5\u3059\u308b\u3002DNS\u3068\u304bEIP\u3068\u304b\u5909\u3048\u3066\u305f\u3089\u623b\u3059\u3002\n\u305d\u308c\u3068\u3001jenkins\u7684\u306aCI\u30c4\u30fc\u30eb\u9023\u643a\u3057\u3066\u308b\u5834\u5408\u306f\u305d\u3053\u304b\u3089\u306e\u63a5\u7d9a\u306e\u8a8d\u8b58\u3092\u30c9\u30e1\u30a4\u30f3\u4ee5\u5916\u306eIP\u3068\u304b\u3067\u76f4\u306b\u6307\u5b9a\u3057\u3066\u3057\u307e\u3063\u3066\u308b\u5834\u5408\u3068\u304bssh\u7684\u306aknown_hosts\u307e\u308f\u308a\u306e\u30a8\u30f3\u30c8\u30ea\u3092\u5dee\u3057\u66ff\u3048\u308b\u3068\u304b\u3092\u3057\u306a\u3044\u3068\u3044\u3051\u306a\u304b\u3063\u305f\u3067\u3059\u306d\u3002\njenkins\u3060\u3068\u4ee5\u4e0b\u306e\u304b\u3093\u3058\u3067\u3057\u305f\u3002\n$ sudo vi /etc/hosts\ndomain\u306fdig\u3067\u89e3\u6c7a\u3067\u304d\u308b\u306e\u3067hosts\u304b\u3089\u524a\u9664\n\n10.xxx.xxx.xxx   gitlab  gitlab.mng.hoge.example.net\n\u2193\n10.xxx.yyy.zzz    gitlab  \n\n\u3044\u3061\u304a\u3046jenkins\u30ea\u30b9\u30bf\u30fc\u30c8\n$ sudo service jenkins restart\n\nssh/config\u3092\u306a\u304a\u3059\n\n$ sudo vi /var/lib/jenkins/config\n$ sudo vi /var/lib/jenkins/.ssh/config\n\nHostName gitlab.mng.hoge.example.net    ##\u76f4IP\u3060\u3063\u305f\u306e\u3067\u30c9\u30e1\u30a4\u30f3\u306b\u76f4\u3059\n\nknown_hosts\u6d88\u3057\u3066\u5165\u308c\u306a\u304a\u3059\n$ sudo vi /var/lib/jenkins/.ssh/known_hosts\n$ sudo su - jenkins\n$ ssh gitlab.mng.hoge.example.net\n\u5b9f\u969b\u30ed\u30b0\u30a4\u30f3\u3057\u306a\u304f\u3066\u3082known_hosts\u306b\u306f\u304b\u304b\u308c\u308b\n\ngitlab\u304b\u3089jenkins\u306b\u5411\u3051\u305f\u901a\u4fe1\u3067Webhook\u306essl verification\u3092\u500b\u5225\u306e\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u3067\u5916\u3059\n\n\u3082\u3057gitlab\u304b\u3089clone\u3067\u304d\u306a\u3044\u5834\u5408\u306f\u305d\u306e\u30b5\u30fc\u30d0\u3067http.sslverify\u3092false\u306b\u3059\u308b\n$ sudo su - jenkins\n$ git config --global http.sslverify false\n\u304b\n$ vi /var/lib/jenkins/.gitconfig\n[http]\n        sslverify = false\n\n\n\u4eca\u5f8c\u306eommunibus-gitlab-ce\u30d0\u30fc\u30b8\u30e7\u30f3\u30a2\u30c3\u30d7\u65b9\u6cd5\n\u30ea\u30dd\u30b8\u30c8\u30ea\u8ffd\u52a0\ncurl -s https://packages.gitlab.com/install/repositories/gitlab/gitlab-ce/script.rpm.sh | sudo bash\nyum repolist\n\nyum\u30b3\u30de\u30f3\u30c9\u3067\u30d0\u30fc\u30b8\u30e7\u30f3\u30a2\u30c3\u30d7\nsudo yum update gitlab-ce\nsudo gitlab-ctl reconfigure\nsudo gitlab-ctl restart\n\n\n\u53c2\u8003\u60c5\u5831\n\u30d0\u30fc\u30b8\u30e7\u30f3\u30a2\u30c3\u30d7\u95a2\u9023\nhttps://wiki.archlinux.org/index.php/Gitlab#Redis_Over_Unix_Socket\nhttp://docs.gitlab.com/ce/install/installation.html#initial-login\nhttps://github.com/gitlabhq/gitlabhq/issues/6100\nhttp://interprism.hatenablog.com/entry/gitlab6to8\nhttp://d.hatena.ne.jp/akishin999/201308\nhttp://qiita.com/nobuhito/items/7df5f9eb550c300999ff\nhttps://gitlab.com/gitlab-org/gitlab-recipes/blob/master/web-server/apache/gitlab-ssl-apache24.conf\nhttps://github.com/gitlabhq/gitlabhq/tree/master/doc/update\nhttps://github.com/gitlabhq/gitlabhq/blob/master/doc/update/7.14-to-8.0.md\nhttps://github.com/gitlabhq/gitlabhq/blob/master/doc/update/8.0-to-8.1.md\nhttps://github.com/gitlabhq/gitlabhq/blob/master/doc/update/8.1-to-8.2.md\nhttps://github.com/gitlabhq/gitlabhq/blob/master/doc/update/8.8-to-8.9.md\nhttps://github.com/gitlabhq/gitlabhq/blob/master/doc/update/8.10-to-8.11.md\nOmmunibus\u53c2\u8003\nhttps://rythgs.co/archives/2015/10/31/switch-omnibus-gitlab/\nhttp://qiita.com/int512/items/632adb4d0b02439d1a9c\nhttp://qiita.com/hosopy/items/965a34d59a0d46731f7c\nhttps://about.gitlab.com/downloads/#centos7\nruby\u307e\u308f\u308a\uff08\u74b0\u5883\u5909\u6570\u3068\u304b\u3067PATH\u304c\u3068\u304a\u3063\u3066\u306a\u3044\u7684\u306a\u6df7\u4e71\u304c\u3042\u3063\u305f\uff09\nhttp://docs.ruby-lang.org/ja/2.0.0/library/rubygems.html\nhttp://d.hatena.ne.jp/zariganitosh/20141016/minimum_making_of_gem\npython\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u30a2\u30c3\u30d7\nhttps://gitlab.com/gitlab-org/gitlab-ce/blob/52e903e99f3b220553e65be7b6034dfbaeef6d81/doc/update/mysql_to_postgresql.md\nhttps://www.python.org/ftp/python/\nhttp://qiita.com/Hiroyama-Yutaka/items/8a52d54819a0923436a7\nnginx\u95a2\u9023\nhttp://next49.hatenadiary.jp/entry/20141114/p2\nhttps://gitlab.com/gitlab-org/omnibus-gitlab/blob/master/doc/settings/nginx.md#supporting-proxied-ssl\nhttp://qiita.com/TaskeHAMANO/items/b01f2d8590c23d6b2bce\nhttps\u307e\u308f\u308a\nhttp://mudanakaigi.blogspot.jp/2013/10/gitlab.html\nldaps\u95a2\u9023\uff08TLS\u3067\u304d\u306a\u3044\u554f\u984c\uff09\n \u21d2\u305d\u306e\u3054\u3001method:\u304ctls\u3058\u3083\u306a\u304f\u3066ssl\u306a\u3089\u8a3c\u660e\u66f8\u691c\u8a3c\u305b\u305a\u306b\u6697\u53f7\u5316\u901a\u4fe1\u53ef\u80fd\u3001\u3068\u3044\u3046\u3053\u3068\u304c\u308f\u304b\u308a\u307e\u3057\u305f\u3002\nhttps://docs.gitlab.com/ce/administration/auth/ldap.html\nhttp://stackoverflow.com/questions/18984198/how-to-debug-gitlab-ldap-authentication\nhttps://gitlab.com/gitlab-org/omnibus-gitlab/blob/master/doc/settings/ldap.md\nhttp://stackoverflow.com/questions/24457408/openssl-command-to-check-if-a-server-is-presenting-a-certificate\nhttps://gitlab.com/gitlab-org/omnibus-gitlab/issues/712\nhttps://gitlab.com/gitlab-org/omnibus-gitlab/issues/1370\nhttps://gitlab.com/gitlab-org/gitlab-ce/issues/1168\nhttp://simosan.minibird.jp/wordpress/openldap/openldap%E3%81%AEssltls%E8%A8%AD%E5%AE%9A/\nhttp://stackoverflow.com/questions/21477210/correct-location-of-openssl-cnf-file\nhttps://gitlab.com/gitlab-org/gitlab-ce/issues/13669\npostgresql\u95a2\u9023\uff08\u30b3\u30f3\u30d0\u30fc\u30c8\u3068\u30d1\u30e9\u30e1\u30fc\u30bf\u30b0\u30eb\u30fc\u30d7\u8abf\u6574\uff09\nhttps://gitlab.com/gitlab-org/gitlab-ce/blob/master/doc/update/mysql_to_postgresql.md#converting-a-gitlab-backup-file-from-mysql-to-postgres\nhttp://qiita.com/awakia/items/9981f37d5cbcbcd155eb\nhttp://dev.classmethod.jp/cloud/aws/rds-postgres-log-settings/\nhttp://qiita.com/Morihaya/items/d09f6f41ba3c374b8cc2\nhttp://db.just4fun.biz/PostgreSQL/%E3%82%AF%E3%83%A9%E3%82%A4%E3%82%A2%E3%83%B3%E3%83%88%E5%81%B4%E3%81%AE%E3%81%BF%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E6%96%B9%E6%B3%95.html\nhttp://tdoc.info/blog/2012/07/09/postgres_tuning.html\nhttps://www.postgresql.org/docs/9.5/static/runtime-config-logging.html\n\n\u6539\u5584\u3055\u308c\u305f\u70b9\u3068\u6b8b\u308a\n\u30fbapache+passenger\u306e\u3088\u3046\u306a\u306e\u3084\u30bd\u30fc\u30b9\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u30a2\u30c3\u30d7\u3067\u3042\u308b\u3088\u3046\u306a\u624b\u9593\u306e\u304b\u304b\u308b\u66f4\u65b0\u304c\u3044\u3089\u306a\u304f\u306a\u3063\u305f\n\u30fb\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u304c\u4e00\u5143\u5316\u3057\u305f\n\u30fbldaps\u306eTLS\u8a8d\u8a3c\u304c\u3067\u304d\u306a\u304b\u3063\u305f\uff08\u73fe\u72b6\u89e3\u6c7a\u624b\u6bb5\u304c\u306a\u3055\u305d\u3046\u306a\u306e\u3067\u4eca\u5f8c\u306e\u8ab2\u984c\n \u21d2\u305d\u306e\u3054\u3001method:\u304ctls\u3058\u3083\u306a\u304f\u3066ssl\u306a\u3089\u8a3c\u660e\u66f8\u691c\u8a3c\u305b\u305a\u306b\u6697\u53f7\u5316\u901a\u4fe1\u53ef\u80fd\u3001\u3068\u3044\u3046\u3053\u3068\u304c\u308f\u304b\u308a\u307e\u3057\u305f\u3002\u306a\u30fc\u3093\u3060\u3002\n\u30fbpostgresql\u306e\u30c1\u30a7\u30c3\u30af\u3059\u308b\u30dd\u30a4\u30f3\u30c8\u306b\u306a\u308b\u30ed\u30b0\u51fa\u3057\u3066\u304a\u304d\u306a\u304c\u3089\u76e3\u8996\u306e\u4ed5\u7d44\u307f\u3092\u3064\u304f\u308c\u3066\u306a\u3044\n\u30fbrake\u3067\u306e\u5b9a\u671f\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u306e\u5b9f\u88c5\u306b\u3064\u3044\u3066\u3001IAM\u30ed\u30fc\u30eb\u306f\u3001'use_iam_profile' => true,\u3068\u304b\u66f8\u304f\u3068\u3044\u3051\u308b\u6a21\u69d8\u3002\n\u3000\u30b5\u30d6\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3068\u3044\u3046\u304bpath\u3092\u6307\u5b9a\u3057\u3066\u7f6e\u304f\u306e\u306f\u306a\u3093\u3060\u304b\u3067\u304d\u306a\u3044\u307d\u3044\u306e\u3067\u4ee5\u4e0b\u306e\u3088\u3046\u306as3 sync\u3068\u304b\u3067\u3002\n\u3000\u30b5\u30d6\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3044\u3089\u306a\u3044\u5834\u5408\u306f\u5b9a\u671f\u524a\u9664\u306f\u30d0\u30b1\u30c3\u30c8\u306e\u30e9\u30a4\u30d5\u30b5\u30a4\u30af\u30eb\u3067\u3088\u3055\u305d\u3046\u3002\n# cat /opt/bin/s3backup-gitlab.sh\n#!/bin/bash\n#\n# s3 backup script for local gitlab.\n# see: https://gitlab.com/gitlab-org/omnibus-gitlab/blob/master/README.md#backups\nDATE=`date +%Y%m%d`\nWEEK=`date +%w`\nBK_DIR=/var/opt/gitlab/backups\nLOG=/opt/bin/bk.log\nS3URL=s3://<mybucket-name>/backup/hoge-git01\nexport AWS_CONFIG_FILE=/root/.aws/config\n\n## daily backup.\necho \"`date +%Y%m%d.%H%M%S` aws s3 backup start.\" >> ${LOG}\ncd ${BK_DIR}/\naws s3 sync . ${S3URL} --delete --acl private --exclude \"*\" --include \"*_gitlab_backup.tar\" --profile hoge\necho \"`date +%Y%m%d.%H%M%S` aws s3 backup end.\" >> ${LOG}\n\nexit\n\n\u304a\u308f\u308a\u3067\u3059\u3002\ngitlab\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u30a2\u30c3\u30d7\u3068\u79fb\u884c\u3092\u3068\u3044\u3046\u3053\u3068\u3067\u3084\u308a\u307e\u3057\u305f\u3002\n\u305d\u306e\u5099\u5fd8\u9332\u3067\u3059\u3002\n6.8\u304b\u30898.11\u306bup\u304b\u3064\u30bd\u30fc\u30b9mysql\u304b\u3089ommunibus\u306epostgresql\u306b\u30b3\u30f3\u30d0\u30fc\u30c8\n\uff08CentOS6\u304b\u30897\u306b\u3082\u4e0a\u3052\u3066\u3044\u308b\u304cAMI\u3092Packer\u3067\u3064\u304f\u3063\u305f\u308achef\u3063\u3066\u3044\u308b\u8a73\u7d30\u306f\u5272\u611b\u3002\uff09\n\n\u3081\u3063\u3061\u3083\u306a\u304c\u3044\u3067\u3059\u3002\u30e1\u30f3\u30c66\u6642\u9593\u304f\u3089\u3044\u3002\n\n\u30d0\u30fc\u30b8\u30e7\u30f3\u30a2\u30c3\u30d7\u306f\u57fa\u672c\u7684\u306b\u306f\u3053\u306e\u8fba\u304b\u3089\u305f\u3069\u308b\u3068\u5927\u4f53\u66f8\u3044\u3066\u3042\u308b\u3068\u304a\u308a\u3067\u3059\u3002\nhttps://github.com/gitlabhq/gitlabhq/tree/master/doc/update\n\n### \u65e7\u74b0\u5883\u3068\u65b0\u74b0\u5883\u306e\u60c5\u5831\n\n\u65e7\uff1a\nCentOS6\napache+passenger,mysql,redis,git,gitlab6.8,ldap\u8a8d\u8a3c\n\n\u65b0\uff1a\nCentOS7\nommunibus gitlab(nginx,redis,postgresql\u7b49\u305c\u3093\u3076\u3044\u308a\u3067\u5225\u306b\u5165\u308c\u308b\u5fc5\u8981\u304c\u306a\u3044\uff09\n\u6697\u53f7\u5316\u3001\u8a8d\u8a3c\u307e\u308f\u308a\u306f\u540c\u69d8\u306b\u8a2d\u5b9a\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u3002\n\n\u7279\u8a18\u4e8b\u9805\uff1a\n\u30fb\u30d0\u30fc\u30b8\u30e7\u30f3\u5909\u308f\u308b\u3054\u3068\u306b\u6bce\u56dedb\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u3057\u3066\u3044\u308b\u3088\u3046\u3067\u3001\n\u3000\u7570\u306a\u308b\u30d0\u30fc\u30b8\u30e7\u30f3\u3069\u3046\u3057\u3067mysqldump\u3067\u5fa9\u65e7\u306f\u3067\u304d\u306a\u3044\u4ed5\u69d8\u3002\n\n\u30fb\u30bd\u30fc\u30b9\u7248\u3060\u3068\u30d0\u30fc\u30b8\u30e7\u30f3\u30a2\u30c3\u30d7\u306e\u624b\u9593\u304c\u304b\u304b\u308b\u306e\u3067\u904b\u7528\u304c\u697d\u306b\u306a\u308b\u306e\u3092\u898b\u8d8a\u3057\u3066ommunibus\u7248\u306b\u3059\u308b\u3002\n\u3000mysql\u304b\u3089postgresql\u306b\u306a\u308b\u306e\u3067\u30c7\u30fc\u30bf\u306e\u30b3\u30f3\u30d0\u30fc\u30c8\u304c\u5fc5\u8981\u3002\n\u3000mysql\u306b\u3057\u3066\u305f\u306e\u306fRDS\u4f7f\u3044\u305f\u304b\u3063\u305f\u305b\u3044\u3002\u5197\u9577\u6027\u3092\u697d\u306b\u5b9f\u73fe\u3067\u304d\u308bMultiAZ\u306b\u3057\u305f\u3044\u3002\n\u3000\u3044\u307e\u306fpostgresql\u306eRDS\u3082\u3042\u308b\u306e\u3067\u305d\u308c\u3092\u3064\u304b\u3046\u3002\n\n\u30fbCentOS6->7\u3067\u304b\u308f\u308b\u306a\u3068\u601d\u3063\u305f\u306e\u306f\u4e3b\u306b\u4ee5\u4e0b\uff08gitlab\u306f\u307b\u307c\u95a2\u4fc2\u306a\u3044\uff09\n\u3000systemd\u306b\u306a\u308b\uff08service\u304b\u3089systemctl\u306b\u306a\u308b\u3051\u3069chef\u7684\u306b\u610f\u8b58\u4e0d\u5fc5\u8981\u3001host\u540d\u5909\u66f4\u304c\u30aa\u30d7\u30b7\u30e7\u30f3\u6307\u5b9a\u3067\u6c38\u7d9a\u5316\u3067\u3079\u3093\u308a\uff09\n\u3000ntpd\u304c\u6a19\u6e96\u3067\u306a\u304f\u306a\u308b\u304c\u4ee3\u308f\u308a\u306e\u306f\u3046\u308b\u3046\u79d2\u306e\u30d0\u30fc\u30b9\u30c8\u66f4\u65b0\u7684\u306a\u6319\u52d5\u304c\u3042\u3084\u3046\u3044\u306e\u3067ntpd\u3064\u304b\u3046\u306e\u304c\u3044\u3044\u6c17\u304c\u3057\u3066\u3044\u308b\n\u3000apache\u304c2.4\u6a19\u6e96\u306b\u306a\u3063\u3066\u30a2\u30af\u30bb\u30b9\u5236\u5fa1\u306e\u8a18\u8ff0\u306e\u4ed5\u65b9\u3068\u30ed\u30fc\u30c9\u30e2\u30b8\u30e5\u30fc\u30eb\u3068\u304b\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u306e\u69cb\u9020\u304c\u304b\u308f\u308b\n\u3000\u3042\u3068\u306f\u30d1\u30c3\u3068\u601d\u3044\u51fa\u305b\u306a\u3044\u3002\n\n### \uff10\uff0e\u30de\u30a4\u30b0\u30ec\u74b0\u5883\u306e\u4e0b\u6e96\u5099\u3092\u3059\u308b\n\n\u30fbAMI\u3068\u3063\u3066\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u74b0\u5883\u3092\u8907\u88fd\u3059\u308b\n\n\u5148\u306bgitlab\u306b\u30ed\u30b0\u30a4\u30f3\u3057\u3066\u4ee5\u4e0b\u3092\u6253\u3064\n\n```\n$ sudo chkconfig gitlab off\n```\n\nAMI\u306f\u30b3\u30f3\u30bd\u30fc\u30eb\u304b\u3089no_reboot\u3067\u3068\u308b\uff08\u5148\u306b\u66f4\u65b0\u3067\u304d\u306a\u3044\u3088\u3046\u306b\u65e7\u30b5\u30fc\u30d0\u3092\u4e38\u3054\u3068\u6b62\u3081\u3068\u3044\u3066\u3082\u3044\u3044\u304b\u3082\nAMI\u304c\u3067\u304d\u305f\u3089\u305d\u3053\u304b\u3089\u8d77\u52d5\u3057\u305f\u306e\u3082\u3092\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u74b0\u5883\u3068\u3057\n\u30ed\u30b0\u30a4\u30f3\u3059\u308b\n\uff08\u30d0\u30fc\u30b8\u30e7\u30f3\u30a2\u30c3\u30d7\u3068\u30c7\u30fc\u30bf\u306e\u30b3\u30f3\u30d0\u30fc\u30c8\u3092\u3059\u3059\u3081\u308b\u74b0\u5883\uff09\n\n```\n# aws ec2 describe-security-groups --filters Name=group-name,Values=SG_xxxxxx --profile xxxxx\n# aws ec2 describe-instances --instance-ids i-xxxxx --profile xxxxx\n```\n\n\u672c\u79fb\u884c\u7528\u306f\u6700\u65b0AMI\u3092\u3068\u3063\u3066\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u8d77\u52d5\u3059\u308b\n(\u65e7\u4e16\u4ee3\u3067HVM\u3067\u306f\u306a\u304b\u3063\u305f\u306e\u3067m4\u3068\u304b\u4f7f\u3048\u306a\u304b\u3063\u305f\u306f\u305a\uff09\n\n```\naws ec2 run-instances \\\n--profile xxxx \\\n--image-id ami-xxxxxx \\\n--count 1 \\\n--key-name hogexxxx \\\n--security-group-ids sg-xxxxxx sg-xxxxxx \\\n--instance-type m3.large \\\n--placement AvailabilityZone=us-xxxx-xa,Tenancy=default \\\n--monitoring Enabled=false \\\n--subnet-id subnet-xxxxxxx \\\n--associate-public-ip-address\n\nnewip=\nssh user@${newip}\n```\n\ngitlab\u304c\u505c\u6b62\u3057\u3066\u3044\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3059\u308b\n\n```\n$ netstat -lnpt\n$ ps -ef\n$ sudo service gitlab status\n```\n\n\u30b3\u30d4\u30fc\u5143\u3068\u533a\u5225\u3059\u308b\u305f\u3081\u306bhost\u540d\u3092\u5909\u66f4\u3059\u308b\n\n```\n$ sudo hostname gitlab-test   ##\u540d\u524d\u9055\u3048\u3070\u306a\u3093\u3067\u3082\u3044\u3044\u304chosts\u3082\u4f75\u305b\u3066\u5909\u3048\u308b\n$ bash\n$ uname -n\n```\n\nhosts\u3092\u7de8\u96c6\u3057\u3066\u81ea\u5206\u304c\u672c\u7269\u306egitlab\u3060\u3068\u8a8d\u8b58\u3055\u305b\u3066\u304a\u304f\n\n```\n$ sudo vi /etc/hosts\n\n10.124.0.xxx    gitlab-test   gitlab  gitlab.xxxx.xxxx.xxxxx.net localhost\n```\n\n\u65e7gitlab\u306e\u306f\u30b3\u30e1\u30f3\u30c8\u5316\u3059\u308b\u3002\n\n\u30fbRDS\u306emysqldump\u3092\u3068\u3063\u3066\u30ed\u30fc\u30ab\u30ebdb\u306b\u6295\u5165\u3001database.yml\u3092\u7de8\u96c6\u3057DB\u63a5\u7d9a\u3092\u30ed\u30fc\u30ab\u30eb\u306b\u5909\u3048\u308b\n\nmysql\u3092\u8d77\u52d5\n\n```\n$ sudo vi /etc/my.cnf\n\u5fc5\u8981\u304c\u3042\u308c\u3070\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092\u9069\u5f53\u306b\u76f4\u3059\uff08\u8d77\u52d5\u3057\u306a\u304b\u3063\u305f\u3089\u30a8\u30e9\u30fc\u30ed\u30b0\u307f\u3066\u76f4\u3059\uff09\n$ sudo service mysql start\n$ sudo view /var/log/mysqld/mysqld.log\n```\n\nrake\u3067\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u3068\u308d\u3046\u3068\u3059\u308b\u3068\u4ee5\u4e0b\u30a8\u30e9\u30fc\u304c\u3067\u308b\u306e\u3067\u30b7\u30f3\u30dc\u30ea\u30c3\u30af\u30ea\u30f3\u30af\u3092\u8cbc\u308b\n\uff08\u307e\u305f\u306f/etc/my.cnf\u306esocket=\u3092\u4fee\u6b63\u3057\u3066mysql\u3092\u518d\u8d77\u52d5\u3059\u308b\uff09\n\nCan't connect to local MySQL server through socket '/tmp/mysql.sock' (2)\n\n```\n$ sudo ln -s /var/lib/mysql/mysql.sock /tmp/mysql.sock\n```\n\n\u672c\u756a\u304b\u3089single-transaction\u3067\u30c7\u30fc\u30bf\u3092\u30c0\u30f3\u30d7\u3057\u3066\u30ed\u30fc\u30ab\u30eb\u306b\u3044\u308c\u308b\n\n```\n$ mysqldump -u gitlab -p -h hoge-gitlab-rds.mng.hoge.local --databases gitlabhq_production --quote-names --opt --single-transaction --hex-blob -R > /tmp/mysqldump-`date +%Y%m%d`.sql\n$ mysql -u gitlab -p --default-character-set=utf8 < /tmp/mysqldump-`date +%Y%m%d`.sql\n```\n\n\u30a2\u30ab\u30a6\u30f3\u30c8\u307e\u308f\u308a\u3092\u4e00\u5fdc\u78ba\u8a8d\u3059\u308b\n\n```\n$ pt-show-grants -u root -p\n```\n\n\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092\u7de8\u96c6\u3057\u3066gitlab\u304b\u3089\u8a8d\u8b58\u3055\u308c\u308b\u5148\u3092\u30ed\u30fc\u30ab\u30eb\u306b\u5909\u3048\u308b\n\n```\n$ sudo vi /home/git/gitlab/config/database.yml\n  host: hoge-gitlab-rds.mng.hoge.local\n   \u2193\n  host: localhost\n```\n\n\u305f\u3076\u3093\u30b5\u30fc\u30d3\u30b9\u8d77\u52d5\u505c\u6b62\u4ee5\u5916\u306fgit\u30e6\u30fc\u30b6\u3067\u4f5c\u696d\u3002\n\n### \uff11\uff0e6.x\u304b\u30897.14\u3078\u30d0\u30fc\u30b8\u30e7\u30f3\u30a2\u30c3\u30d7\n\n\u30fbrake\u3067backup\u3092\u3068\u308b\uff08\u4f7f\u308f\u306a\u3044\u304c\u5ff5\u306e\u305f\u3081\n\n```\n$ sudo su - git\n$ cd gitlab\n$ bundle exec rake gitlab:backup:create RAILS_ENV=production\n\n$ ls -lh tmp/backups/\n-rw-r--r-- 1 git git 705M  3\u6708  5 15:17 2015 1425568606_gitlab_backup.tar\n$ df -h;df -i\n```\n\n\u30fbruby\u3092\u5165\u308c\u308b\n\n```\nmkdir /tmp/ruby && cd /tmp/ruby\ncurl --progress https://cache.ruby-lang.org/pub/ruby/2.1/ruby-2.1.6.tar.gz | tar xz\ncd ruby-2.1.6\n./configure --disable-install-rdoc\nmake -j 2\nsudo make install\n\n$ /usr/local/bin/gem environment\n```\n\n\u3044\u308d\u3044\u308dPATH\u3092\u901a\u3057\u3066\u304a\u304f\n\n```\n$ sudo su - git\n$ vi ~/.bashrc\nexport PATH=/usr/local/bin:/opt/chef/embedded/bin:$PATH\nexport LD_LIBRARY_PATH=/usr/local/lib:/usr/local/lib/ruby/2.1.0:$LD_LIBRARY_PATH\nexport RUBYLIB=/usr/local/lib/ruby/2.1.0:$RUBYLIB\n\n$ vi ~/.gemrc \ngempath:\n- /usr/local/lib/ruby/2.1.0\ngem: --no-rdoc --no-ri\n\n$ bash\n$ gem env\n```\n\n\u30fbbundler\u5165\u308c\u308b\n\n```\n$ sudo /usr/local/bin/gem install bundler --no-ri --no-rdoc\n```\n\ngitlab\u306f\u3068\u307e\u3063\u3066\u308b\u306e\u3067\u305d\u306e\u307e\u307e\u30d0\u30fc\u30b8\u30e7\u30f3\u30a2\u30c3\u30d7\u4f5c\u696d\u3092\u3059\u3059\u3081\u308b\n\n\u30fb7\u7cfb\u306egitlab\u306b\u30c1\u30a7\u30c3\u30af\u30a2\u30a6\u30c8\n\n```\n$ sudo su - git\n$ cd /home/git/gitlab\n$ git fetch --all\n\n$ git checkout -- db/schema.rb\n$ git checkout 7-14-stable\n```\n\n\u30fb\u5fc5\u8981\u306a\u30d1\u30c3\u30b1\u30fc\u30b8\u5165\u308c\u308b\n\n```\n$ sudo yum install logrotate cmake nodejs libkrb5-dev pkg-config\n```\n\n\u30fbredis\u3092unix\u30bd\u30b1\u30c3\u30c8\u4f7f\u3046\u3088\u3046\u306b\u3059\u308b\n\n```\n$ sudo service redis stop\n$ sudo cp -p /etc/redis.conf{,.org}\n$ sudo vi /etc/redis.conf\n$ diff /etc/redis.conf{,.org} \n72,73c72\n< unixsocket /var/run/redis/redis.sock\n< unixsocketperm 775\n---\n> # unixsocketperm 755\n$ sudo service redis start\n```\n\n\u30fbgit\u30e6\u30fc\u30b6\u306e\u30b5\u30d6\u30b0\u30eb\u30fc\u30d7\u306bredis\u3092\u8ffd\u52a0\n\n```\n$ sudo usermod -aG redis git\n$ id git\nuid=1001(git) gid=1001(git) \u6240\u5c5e\u30b0\u30eb\u30fc\u30d7=1001(git),494(redis)\n\n$ sudo su - git\n$ cd gitlab\n$ cp config/resque.yml.example config/resque.yml\n$ cat config/resque.yml\n\n$ vim /home/git/gitlab-shell/config.yml\n  socket: /var/run/redis/redis.sock\n```\n\n\u30fbgitlab-shell\u3092\u5408\u3046\u30d0\u30fc\u30b8\u30e7\u30f3\u306b\u30c1\u30a7\u30c3\u30af\u30a2\u30a6\u30c8\u3059\u308b\n\n```\n$ cd /home/git/gitlab-shell\n$ git fetch\n$ git checkout v2.6.5\n```\n\n\u30fb\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\uff08mysql\u306e\u5834\u5408\uff09\n\n```\n$ cd /home/git/gitlab\n$ /usr/local/bin/bundle install --without development test postgres --deployment\n\n\u30fb# Enable internal issue IDs (introduced in GitLab 6.1)\n$ /usr/local/bin/bundle exec rake migrate_iids RAILS_ENV=production\n```\n\nrouge\u306e\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u30a8\u30e9\u30fc\u304c\u3067\u305f\u3089Gemfile.lock\u7de8\u96c6\u3057\u3066rouge\u30921.10.0\u306b\u4fee\u6b63\u3059\u308b\u3068\u51fa\u306a\u304f\u306a\u308b\u3051\u3069\u51fa\u3066\u3082\u5225\u306b\u4f5c\u696d\u3059\u3059\u307e\u306a\u3044\u3053\u3068\u3082\u306a\u3044\u3057checkout\u3067\u306a\u304a\u3055\u306a\u3044\u3068pull\u5931\u6557\u3059\u308b\u306e\u3067\u7121\u8996\u3057\u3066\u5927\u4e08\u592b\n\n```\n/home/git/gitlab/vendor/bundle/ruby/2.1.0/gems/rouge-1.9.1/lib/rouge/lexers/shell.rb:20: warning: already initialized constant Rouge::Lexers::Shell::KEYWORDS\n/home/git/gitlab/vendor/bundle/ruby/2.1.0/gems/rouge-1.9.1/lib/rouge/lexers/shell.rb:20: warning: previous definition of KEYWORDS was here\n/home/git/gitlab/vendor/bundle/ruby/2.1.0/gems/rouge-1.9.1/lib/rouge/lexers/shell.rb:25: warning: already initialized constant Rouge::Lexers::Shell::BUILTINS\n```\n\n\u30fbdb\u3092\u30de\u30a4\u30b0\u30ec\n\n```\n$ /usr/local/bin/bundle exec rake db:migrate RAILS_ENV=production\n```\n\n\u30fb\u30d7\u30ec\u30b3\u30f3\u30d1\u30a4\u30eb\n\n```\n$ bundle exec rake assets:clean assets:precompile cache:clear RAILS_ENV=production\n\n$ chmod u+rwx,g+rx,o-rwx /home/git/gitlab-satellites\n\n$ ls -dl /home/git/gitlab-satellites\ndrwxr-x--- 6 git git 4096  8\u6708 19 08:40 2016 /home/git/gitlab-satellites\n\n$ cp -p /etc/init.d/gitlab{,.`date +%Y%m%d-1`}\n$ cp lib/support/init.d/gitlab /etc/init.d/gitlab\n```\n\n\u30fb\u8a2d\u5b9a\n\n```\n$ vi config/gitlab.yml\n```\n\n\u30b3\u30e1\u30f3\u30c8\u4ee5\u5916\u306e\u3068\u3053\u308d\u3092\u4fee\u6b63\u3002gitlab.yml\u306f\u3053\u306e\u6bb5\u968e\u3067\u306a\u304a\u3055\u306a\u304f\u3066\u3082\u5225\u306b\u5927\u4e08\u592b\u3002\n\n```\n$ git diff 6-8-stable:config/unicorn.rb.example 7-14-stable:config/unicorn.rb.example\n\n-worker_processes 2\n+worker_processes 3\n\n-listen \"/home/git/gitlab/tmp/sockets/gitlab.socket\", :backlog => 64\n+listen \"/home/git/gitlab/tmp/sockets/gitlab.socket\", :backlog => 1024\n\n-timeout 30\n+timeout 60\n\n$ vi config/unicorn.rb\n\n$ cd ../gitlab-shell/\n$ cat VERSION \n$ git diff v1.9.4:config.yml.example v2.6.5:config.yml.example\n\n+  # pass: redispass # Allows you to specify the password for Redis\n+  database: 0\n+  socket: /var/run/redis/redis.sock # Comment out this line if you want to use TCP\n\n # Log file.\n@@ -39,3 +55,11 @@ log_level: INFO\n\n+git_annex_enabled: false\n\n$ vi config.yml\n```\n\n```\n$ cd ../gitlab\n\n$ diff config/initializers/rack_attack.rb{,.example}\n$ cp config/initializers/rack_attack.rb.example config/initializers/rack_attack.rb\n```\n\n\u30fb\u8d77\u52d5\n\n```\n$ sudo service gitlab start\n```\n\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u30a8\u30e9\u30fc\u304c\u51fa\u305f\u3089yml\u306e\u30b7\u30f3\u30bf\u30c3\u30af\u30b9\u30a8\u30e9\u30fc\u306a\u306e\u3067typo\u3092\u307f\u306a\u304a\u3059\u3002\n\n```\nPsych::SyntaxError: (<unknown>): did not find expected key while parsing a block mapping at line 129 column 4\n```\n\n\u30a8\u30e9\u30fc\u304c\u3069\u3046\u306b\u3082\u306a\u3089\u306a\u304b\u3063\u305f\u3089\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u306e\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u3068\u3063\u3066\u304b\u3089\u65b0\u30d0\u30fc\u30b8\u30e7\u30f3\u306e\u30b5\u30f3\u30d7\u30eb\u3068\u898b\u6bd4\u3079\u306a\u304c\u3089\u4fee\u6b63\u3059\u308b\n\n\u3082\u3057apache\u304c\u304a\u3061\u3066\u305f\u3089\u8d77\u52d5\n\n```\n$ sudo service httpd start\n```\n\n\u30fb\u74b0\u5883\u60c5\u5831\u78ba\u8a8d\u3068\u30c6\u30b9\u30c8\n\n```\n$ sudo su - git\n$ cd gitlab\n$ bundle exec rake gitlab:env:info RAILS_ENV=production\n\n$ bundle exec rake gitlab:check RAILS_ENV=production\n\nSend ping to redis server: Could not connect to Redis at /var/run/redis/redis.socket: No such file or directory\ngitlab-shell self-check failed\n  Try fixing it:\n  Make sure GitLab is running;\n  Check the gitlab-shell configuration file:\n  sudo -u git -H editor /home/git/gitlab-shell/config.yml\n  Please fix the error above and rerun the checks.\n\nvim /home/git/gitlab-shell/config.yml\n/var/run/redis/redis.socket\n\u2193\n/var/run/redis/redis.sock\n```\n\n\u30fbdb\u306eALTER\u7b49\u3092\u30de\u30cb\u30e5\u30a2\u30eb\u3069\u304a\u308a\u3084\u308b\n\n\u30de\u30cb\u30e5\u30a2\u30eb\u3069\u304a\u308a\u672c\u4f53\u306f\u3068\u3081\u3068\u304f\n\n```\n$ sudo service gitlab stop\n\n$ mysql -u gitlab -p\n```\n\n6.8\u304b\u3089\u5fc5\u8981\u305d\u3046\u306a\u306e\u3092\u9078\u3093\u3067\u5b9f\u65bd\u3002\n\n```\nmysql> use gitlabhq_production\nmysql> SELECT CONCAT('ALTER TABLE gitlabhq_production.', table_name, ' ENGINE=InnoDB;') AS 'Copy & run these SQL statements:' FROM information_schema.tables WHERE table_schema = 'gitlabhq_production' AND `ENGINE` <> 'InnoDB' AND `TABLE_TYPE` = 'BASE TABLE';\nmysql> SET foreign_key_checks = 0;\nmysql> SELECT CONCAT('ALTER TABLE gitlabhq_production.', table_name, ' CONVERT TO CHARACTER SET utf8 COLLATE utf8_general_ci;') AS 'Copy & run these SQL statements:' FROM information_schema.tables WHERE table_schema = 'gitlabhq_production' AND `TABLE_COLLATION` <> 'utf8_unicode_ci' AND `TABLE_TYPE` = 'BASE TABLE';\nmysql> SET foreign_key_checks = 1;\nmysql> show grants for 'gitlab'@'localhost';\n```\n\n\u30fbgitlab\u3092\u8d77\u52d5\u3057\u3066\u30ed\u30b0\u30a4\u30f3\u78ba\u8a8d\u3092\u3059\u308b\u3001help\u3067\u30d0\u30fc\u30b8\u30e7\u30f3\u304c\u4e0a\u304c\u3063\u3066\u3044\u308b\u3053\u3068\u3092\u78ba\u8a8d\n\ngitlab\u3092\u8d77\u52d5\u3059\u308b\n\n```\n$ sudo service gitlab start\n```\n\ngitlab.mng.hoge.example.net\u3092\u30ed\u30fc\u30ab\u30ebPC\u306ehost\u306b\u767b\u9332\u3057\u3066\u30d6\u30e9\u30a6\u30b6\u304b\u3089\u898b\u3066\u307f\u308b\u3002\n\n\"PublicIpAddress\"\u3092\u78ba\u8a8d\n\n```\n$ aws ec2 describe-instances --instance-ids i-xxxxxxxx --profile xxxx\nor\n$ curl -s http://169.254.169.254/latest/meta-data/public-ipv4\n```\n\n\u30d6\u30e9\u30a6\u30b6\u3067help\u304b\u3089\u30d0\u30fc\u30b8\u30e7\u30f3\u304c\u4e0a\u304c\u3063\u3066\u3044\u308b\u3053\u3068\u3092\u78ba\u8a8d\n\n\n### \uff12\uff0e7.14\u304b\u30898.0\u3078\u30d0\u30fc\u30b8\u30e7\u30f3\u30a2\u30c3\u30d7\n\n\u30fbgitlab\u3092\u6b62\u3081\u308b\n\n```\n$ sudo service gitlab stop\n```\n\n\u30fbrake\u3067bkup\u3057\u3088\u3046\u3068\u3057\u305f\u3089\u6a29\u9650\u304c\u305f\u3089\u306a\u304b\u3063\u305f\u3089\u3057\u3044\u306e\u3067\u4ed8\u4e0e\n\n```\nDumping MySQL database gitlabhq_production ... mysqldump: Got error: 1044: Access denied for user 'gitlab'@'localhost' to database 'gitlabhq_production' when using LOCK TABLES\n\n$ mysql -u root -p\nmysql> GRANT LOCK TABLES ON gitlabhq_production.* TO 'gitlab'@'localhost';\nmysql> FLUSH PRIVILEGES;\n```\n\n\u30fbrake\u3067backup\u3092\u3068\u308b\n\n```\n$ sudo su - git\n$ cd gitlab\n$ bundle exec rake gitlab:backup:create RAILS_ENV=production\n$ ls -lh tmp/backups/\n\n-rw-rw-r-- 1 git git 1.9G  9\u6708 14 07:32 2016 1473838054_gitlab_backup.tar\n-rw------- 1 git git 1.9G  9\u6708 15 01:10 2016 1473901803_gitlab_backup.tar\n```\n\n\u30fbgit\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u3092\u4e0a\u3052\u308b\n\n```\n$ /usr/local/bin/git --version\ngit version 1.9.0\n```\n\n\u4f9d\u5b58\u30d1\u30c3\u30b1\u30fc\u30b8\u3092update\u3059\u308b\n\n```\n$ sudo yum install libcurl-devel libxslt-devel libxml2-devel expat-devel gettext openssl-devel zlib-devel\n\nsudo wget https://www.kernel.org/pub/software/scm/git/git-2.9.3.tar.gz -P /usr/local/src\ncd /usr/local/src/\nsudo tar zxf git-2.9.3.tar.gz\ncd /usr/local/src/git-2.9.3\nsudo ./configure --prefix=/usr/local/git\nsudo make all\nsudo make install\n\n$ /usr/local/bin/git --version\ngit version 2.9.3\n```\n\n\u30fb\u30d0\u30fc\u30b8\u30e7\u30f3\u30a2\u30c3\u30d7\u4f5c\u696d\u3092\u3059\u3059\u3081\u308b\n\n\u30fb8.0\u306egitlab\u306b\u30c1\u30a7\u30c3\u30af\u30a2\u30a6\u30c8\n\nlatest\u3060\u30688-11-stable\u3060\u3063\u305f\u3063\u307d\u3044\u304c\u30e1\u30b8\u30e3\u30fc\u30d0\u30fc\u30b8\u30e7\u30f3\u304c\u4e0a\u304c\u308b\u306e\u306f\u6bb5\u968e\u3092\u8e0f\u307e\u306a\u3044\u3068\u5371\u967a\u305d\u3046\u306a\u306e\u30678.0\u306e\u30b3\u30fc\u30c9\u306bcheckout\u3059\u308b\n\n```\n$ sudo su - git\n$ cd gitlab\n\n\trouge\u3092\u7121\u7406\u3084\u308a\u4e0a\u3052\u305a\u306b\u30a8\u30e9\u30fc\u7121\u8996\u306e\u5834\u5408\u306f\u4ee5\u4e0b\u4e0d\u8981\n\t$ git checkout  Gemfile.lock\n$ git fetch --all\n$ git checkout db/schema.rb\n$ git checkout 8-0-stable\n```\n\n\u30fbGo\u3092\u5165\u308c\u308b\n\n```\ncurl --remote-name --progress https://storage.googleapis.com/golang/go1.5.linux-amd64.tar.gz\nsudo tar -C /usr/local -xzf go1.5.linux-amd64.tar.gz\nsudo ln -sf /usr/local/go/bin/{go,godoc,gofmt} /usr/local/bin/\nrm go1.5.linux-amd64.tar.gz\n$ which go\n```\n\n\u30fbgitlab-git-http-server\u306f\u5165\u308c\u305a\u306bgitlab-workhorse\u3092\u5165\u308c\u3066\u6700\u65b0\u306b\u3059\u308b\uff08replace\u3068update\u306e\u624b\u9593\u3092\u306f\u3076\u304f\uff09\n\n```\nsudo su - git\n$ cd /home/git\ngit clone https://gitlab.com/gitlab-org/gitlab-workhorse.git\ncd /home/git/gitlab-workhorse\ngit fetch --all\ngit checkout v0.7.11\nmake\n\n$ cd /home/git/gitlab\n$ git checkout 8-2-stable\n$ git diff 8-0-stable:lib/support/init.d/gitlab.default.example 8-2-stable:lib/support/init.d/gitlab.default.example\n$ exit\n$ sudo cp -p /home/git/gitlab/lib/support/init.d/gitlab.default.example /etc/default/gitlab\n$ view /etc/default/gitlab\n```\n\n\u3051\u3063\u3053\u3046\u3061\u304c\u3046\u3088\u3046\u306a\u306e\u3067\u8d77\u52d5\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u30b3\u30d4\u30fc\u3057\u3066\u304a\u304f\n\uff088.2\u306e\u8d77\u52d5\u30b9\u30af\u30ea\u30d7\u30c8\u3067\u306a\u3044\u3068workhouse\u304c\u8d77\u52d5\u3057\u306a\u3044\u306e\u30678-2-stable\u306bcheckout\u3057\u305f\u72b6\u614b\u3067\u30b3\u30d4\u30fc\uff09\n\n```\n$ exit\n$ sudo cp -p /etc/init.d/gitlab{,.714.bk}\n$ sudo cp /home/git/gitlab/lib/support/init.d/gitlab /etc/init.d/gitlab\n$ sudo cp -p /etc/init.d/gitlab{,.80.bk}\n\n$ sudo su - git\n$ cd gitlab\n$ git checkout 8-0-stable\n```\n\n\u30fb\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306e\u9375\u60c5\u5831\u304c\u5fc5\u8981\u306b\u306a\u308b\u3089\u3057\u3044\u306e\u3067\u8ffd\u52a0\u3057\u3066\u304a\u304f\n\n```\n# cp config/secrets.yml.example config/secrets.yml\n# chmod 0600 config/secrets.yml\n# chown git. /home/git/gitlab/config/secrets.yml\t###\u30aa\u30fc\u30ca\u30fc\u304cgit\u3067\u306a\u3044\u3068db:migrate\u3057\u3063\u3071\u3044\u3059\u308b\u3002\n# vi config/secrets.yml\n  db_key_base: **********\n\nsudo su - git\ncd gitlab\n$ bundle install --without postgres development test --deployment\n$ bundle exec rake db:migrate RAILS_ENV=production\n\n$ bundle exec rake assets:clean assets:precompile cache:clear RAILS_ENV=production\n\ndiff lib/support/init.d/gitlab /etc/init.d/gitlab\n```\n\n\u30fbgitlab\u3092\u8d77\u52d5\u3057\u3066\u30ed\u30b0\u30a4\u30f3\u78ba\u8a8d\u3092\u3059\u308b\u3001help\u3067\u30d0\u30fc\u30b8\u30e7\u30f3\u304c\u4e0a\u304c\u3063\u3066\u3044\u308b\u3053\u3068\u3092\u78ba\u8a8d\n\n\u30b5\u30fc\u30d0\u8d77\u52d5\n\n```\n$ sudo service gitlab start\n\n$ sudo su - git\n$ cd gitlab\n$ bundle exec rake gitlab:env:info RAILS_ENV=production\n```\n\n\u30c1\u30a7\u30c3\u30af\u306e\u524d\u306b\u6a29\u9650\u4fee\u6b63\u3001\n\n```\nchmod 0750 /home/git/gitlab/public/uploads\n mkdir /home/git/gitlab/public/uploads/tmp\nfind /home/git/gitlab/public/uploads -type d -not -path /home/git/gitlab/public/uploads -exec chmod 0755 {} \\;\nls -lh /home/git/gitlab/public/uploads\n```\n\n\u30c1\u30a7\u30c3\u30af\n\n```\n$ bundle exec rake gitlab:check RAILS_ENV=production\n```\n\n`Init script up-to-date? ... no`\u3000\u306b\u306a\u308b\u3051\u3069\u3055\u3089\u306b\u65b0\u3057\u304f\u3057\u3066\u308b\u3060\u3051\u3067\u8d77\u52d5\u3057\u3066\u308b\u306e\u3067\u554f\u984c\u306a\u3057\n\n\u3068\u308a\u3042\u3048\u305a\u30d6\u30e9\u30a6\u30b6\u3067\u78ba\u8a8d\u3002\n\u30d0\u30fc\u30b8\u30e7\u30f3\u304c8.05\u306b\u306a\u3063\u3066\u308b\u3053\u3068\u3092\u78ba\u8a8d\n\n\n### \uff13\uff0e8.0\u304b\u30898.11\u3078\u30d0\u30fc\u30b8\u30e7\u30f3\u30a2\u30c3\u30d7\n\n\n\u30fbrake\u3067backup\u3092\u3068\u308b\uff08\u5ff5\u306e\u305f\u3081\uff09\n\n```\nbundle exec rake gitlab:backup:create RAILS_ENV=production\n$ ls -lh tmp/backups\n\n-rw------- 1 git git 1.9G  9\u6708 15 02:09 2016 1473905330_gitlab_backup.tar\n```\n\n\u30fbgitlab\u3092\u6b62\u3081\u308b\n\n```\n$ sudo service gitlab stop\n```\n\n\u30fb\u30d0\u30fc\u30b8\u30e7\u30f3\u30a2\u30c3\u30d7\u4f5c\u696d\u3092\u3059\u3059\u3081\u308b\n\n```\n$ sudo su - git\n$ cd gitlab\n$ pwd\n/home/git/gitlab\n```\n\n\u30fbUpdate Ruby\n\n```\n$ cd /tmp/ruby\ncurl --remote-name --progress https://cache.ruby-lang.org/pub/ruby/2.3/ruby-2.3.1.tar.gz\ntar xzf ruby-2.3.1.tar.gz\ncd ruby-2.3.1\n./configure --disable-install-rdoc\nmake\nsudo make install\n\n$ ruby -v\nruby 2.3.1p112 (2016-04-26 revision 54768) [x86_64-linux]\n```\n\n\u30e9\u30a4\u30d6\u30e9\u30ea\u306e\u30d1\u30b9\u3092\u901a\u3059(/usr/local/lib/ruby/2.3.0)\n\n```\n$ sudo su - git\n$ vi ~/.bashrc\nexport LD_LIBRARY_PATH=/usr/local/lib:/usr/local/lib/ruby/2.3.0:$LD_LIBRARY_PATH\nexport RUBYLIB=/usr/local/lib/ruby/2.3.0:$RUBYLIB\n$ vi ~/.gemrc\ngempath:\n- /usr/local/lib/ruby/2.3.0\ngem: --no-rdoc --no-ri\n$ gem env gempath\n\nsudo su -\n```\n\ngit\u3068\u540c\u3058\u3088\u3046\u306bpath\u3092\u3068\u304a\u3059\u3001bundler\u3092\u5165\u308c\u308b\n\n```\n$ bash\n$ sudo /usr/local/bin/gem install bundler --no-ri --no-rdoc\n```\n\n\u30fb\u30c1\u30a7\u30c3\u30af\u30a2\u30a6\u30c8\n\n```\n$ cd gitlab\n$ git checkout -- db/schema.rb\n$ git checkout 8-11-stable\n$ git branch\n```\n\n\u30fbUpdate gitlab-shell\n\n```\ncd /home/git/gitlab-shell\n$ git fetch --all --tags\ngit checkout v3.4.0\n```\n\n\u30fb\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3068\u30de\u30a4\u30b0\u30ec\u30fc\u30c8\u3068\u30d7\u30ec\u30b3\u30f3\u30d1\u30a4\u30eb\u3068\u30ad\u30e3\u30c3\u30b7\u30e5\u30af\u30ea\u30a2\u3001\u8d77\u52d5\u30b9\u30af\u30ea\u30d7\u30c8\u30b3\u30d4\u30fc\u3002\n\n```\ncd /home/git/gitlab\n$ bundle install --without postgres development test --deployment\n$ bundle clean\n$ bundle exec rake db:migrate RAILS_ENV=production\n$ bundle exec rake assets:clean assets:precompile cache:clear RAILS_ENV=production\n\n$ sudo cp -p /etc/init.d/gitlab{,.8.2}\n$ sudo cp /home/git/gitlab/lib/support/init.d/gitlab /etc/init.d/gitlab\n```\n\n\u30fb\u8a2d\u5b9a\u6bd4\u8f03,\u4fee\u6b63\n\n```\n$ sudo su - git\n$ cd gitlab\n$ git diff origin/8-0-stable:config/gitlab.yml.example origin/8-11-stable:config/gitlab.yml.example\n$ cp -p config/gitlab.yml{,.80}\n$ cp -p config/gitlab.yml.example config/gitlab.yml\n$ vim config/gitlab.yml\n$ vim config/gitlab.yml.80\n\u898b\u6bd4\u3079\u306a\u304c\u3089\u306a\u304a\u3059\n$ diff config/gitlab.yml{,.example}\n32,34c32,34\n<     host: gitlab.mng.hoge.example.net\n<     port: 443 # Set to 443 if using HTTPS, see installation.md#using-https for additional HTTPS configuration details\n<     https: true # Set to true if using HTTPS, see installation.md#using-https for additional HTTPS configuration details\n---\n>     host: localhost\n>     port: 80 # Set to 443 if using HTTPS, see installation.md#using-https for additional HTTPS configuration details\n>     https: false # Set to true if using HTTPS, see installation.md#using-https for additional HTTPS configuration details\n70c70\n<     email_from: gitlab@mng.hoge.example.com\n---\n>     email_from: example@example.com\n215c215\n<     enabled: true\n---\n>     enabled: false\n235c235\n<         host: '10.xxx.xxx.xxx'\n---\n>         host: '_your_ldap_server'\n237,238c237\n<         #uid: 'sAMAccountName'\n<         uid: 'uid'\n---\n>         uid: 'sAMAccountName'\n240,241c239,240\n<         bind_dn: 'uid=Auth,ou=System,dc=hoge,dc=example,dc=net'\n<         password: '******'\n---\n>         bind_dn: '_the_full_dn_of_the_user_you_will_bind_with'\n>         password: '_the_password_of_the_bind_user'\n251c250\n<         active_directory: false\n---\n>         active_directory: true\n262c261\n<         allow_username_or_email_login: true\n---\n>         allow_username_or_email_login: false\n273c272\n<         base: 'dc=hoge,dc=example,dc=net'\n---\n>         base: ''\n282c281\n<         user_filter: \"\"\n---\n>         user_filter: ''\n480c479\n<     bin_path: /usr/local/bin/git\n---\n>     bin_path: /usr/bin/git\n```\n\n\u30fbsmtp\u307e\u308f\u308a\n\n```\n$ cp -p config/initializers/smtp_settings.rb.sample config/initializers/smtp_settings.rb\n$ vi config/initializers/smtp_settings.rb\n```\n\n\u3044\u3061\u304a\u3046\u30ed\u30fc\u30ab\u30eb\u306b\u3064\u306a\u3050\u4f53\u3067\u4fee\u6b63\n\n```\n$ diff config/initializers/smtp_settings.rb.sample config/initializers/smtp_settings.rb\n15,22c15,22\n<     address: \"email.server.com\",\n<     port: 465,\n<     user_name: \"smtp\",\n<     password: \"123456\",\n<     domain: \"gitlab.company.com\",\n<     authentication: :login,\n<     enable_starttls_auto: true,\n<     openssl_verify_mode: 'peer' # See ActionMailer documentation for other possible options\n---\n>     address: \"localhost\",\n>     port: 25,\n>     user_name: \"git\",\n>     password: \"\",\n>     domain: \"gitlab.mng.hoge.example.net\",\n> #    authentication: :login,\n>     enable_starttls_auto: false,\n> #    openssl_verify_mode: 'peer' # See ActionMailer documentation for other possible options\n\n$ sudo cp /home/git/gitlab/lib/support/init.d/gitlab /etc/init.d/gitlab\n\n$ sudo chmod 700 /home/git/gitlab/public/uploads\n$ sudo find /home/git/gitlab/public/uploads -type f -exec chmod 0644 {} \\;\n$ sudo find /home/git/gitlab/public/uploads -type d -not -path /home/git/gitlab/public/uploads -exec chmod 0700 {} \\;\n\n$ sudo cp -p /home/git/gitlab-shell/config.yml{,.80}\n$ sudo vim /home/git/gitlab-shell/config.yml\n$ vim /home/git/gitlab-shell/config.yml.example \n```\n\n\u307f\u304f\u3089\u3079\u3066\u3044\u3089\u306a\u3044\u306e\u6d88\u3059\u306a\u3069\u4fee\u6b63\u3059\u308b\n\n```\n$ sudo diff /home/git/gitlab-shell/config.yml{,.80}\n18c18\n< #repos_path: \"/home/git/repositories\"\n---\n> repos_path: \"/home/git/repositories\"\n```\n\nunicorn\u4e00\u5fdc\u78ba\u8a8d\n\n```\n$ cp -p config/unicorn.rb{,.80}\n$ diff config/unicorn.rb{,.80}\n39c39\n< listen \"/home/git/gitlab/tmp/sockets/gitlab.socket\", :backlog => 1024\n---\n> listen \"/home/git/gitlab/tmp/sockets/gitlab.socket\", :backlog => 64\n43c43\n< timeout 60\n---\n> timeout 30\n```\n\n\u8d77\u52d5\u3057\u306a\u304b\u3063\u305f\u3089/home/git/gitlab/log\u306e\u3057\u305f\u306e\u30ed\u30b0\u3092\u307f\u308b\uff08\u5927\u4f53\u30d1\u30fc\u30b9\u30a8\u30e9\u30fc\u306a\u306e\u3067\u30b5\u30f3\u30d7\u30eb\u30b3\u30d4\u30fc\u3057\u3066\u7de8\u96c6\u63a8\u5968\uff09\n\n\u30fbgitlab\u3092\u8d77\u52d5\u3057\u3066\u30ed\u30b0\u30a4\u30f3\u78ba\u8a8d\u3092\u3059\u308b\u3001help\u3067\u30d0\u30fc\u30b8\u30e7\u30f3\u304c\u4e0a\u304c\u3063\u3066\u3044\u308b\u3053\u3068\u3092\u78ba\u8a8d\n\n```\n$ sudo service gitlab start\n$ service httpd restart\n$ sudo su - git\n$ cd gitlab\n\n$ bundle exec rake gitlab:env:info RAILS_ENV=production\n$ bundle exec rake gitlab:check RAILS_ENV=production\n```\n\n\u30d6\u30e9\u30a6\u30b6\u304b\u3089\u307f\u308b\n`https://gitlab.mng.hoge.example.net/help`\n\u306a\u3093\u304b8.11.7\u306b\u306a\u3063\u3066\u30de\u30a4\u30ca\u30fc\u30d0\u30fc\u30b8\u30e7\u30f3\u304c\u4e0a\u304c\u3063\u3066\u305f\u306e\u3067\u4e8b\u524d\u306b\u4fee\u6b63\u3057\u3066\u3042\u3063\u305fchef\u30ea\u30dd\u30b8\u30c8\u30ea\u306e\u30d1\u30c3\u30b1\u30fc\u30b8\u30d0\u30fc\u30b8\u30e7\u30f3\u3092\u306a\u304a\u3059\u306a\u3069\u3002\n\n### \uff14\uff0emysql\u304b\u3089postgresql\u3078\u30b3\u30f3\u30d0\u30fc\u30c8\n\n\u30fbgitlab\u3092\u6b62\u3081\u308b\n\n```\n$ sudo service gitlab stop\n```\n\n\u30fbrake\u3067backup\u3092\u3068\u308b\n\n```\n$ sudo su - git\n$ cd gitlab\n$ bundle exec rake gitlab:backup:create RAILS_ENV=production\n$ ls -lh tmp/backups/\n-rw------- 1 git git 1.9G  9\u6708 15 04:50 2016 1473915031_gitlab_backup.tar\n\n\n$ bk_prefix=1473915031 ##\u2605ls\u306e\u7d50\u679c\u3092\u5909\u6570\u306b\u5165\u308c\u308b\n```\n\n\u30fbpython\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u30922.7\u4ee5\u4e0a\u306b\u3059\u308b\n\n```\n$ python -V \nPython 2.6.6\n$ cd /usr/local/src\n$ sudo curl -O https://www.python.org/ftp/python/2.7.12/Python-2.7.12.tgz \n$ sudo tar zxf Python-2.7.12.tgz \n$ cd Python-2.7.12\n$ sudo ./configure\n$ sudo make\n$ sudo make install\n\n$ which python\n/usr/local/bin/python\n$ /usr/local/bin/python -V\nPython 2.7.12\n```\n\n\u30fb\u30b3\u30f3\u30d0\u30fc\u30c8\u30c4\u30fc\u30eb\u3067\u30b3\u30f3\u30d0\u30fc\u30c8\u3059\u308b\n\n```\n$ sudo su - git\ncd gitlab\n$ mkdir -p tmp/backups/postgresql\n$ cp tmp/backups/${bk_prefix}_gitlab_backup.tar tmp/backups/postgresql/\n```\n\ndisk\u304c\u8db3\u3089\u306a\u304f\u306a\u308b\u306e\u3067\u3053\u3053\u3067\u4e0d\u8981\u306a\u53e4\u3044backup\u306f\u6d88\u3059\u3002\n\n```\n$ df -h\n$ ls -lh /home/git/gitlab/tmp/backups\n$ rm -f /home/git/gitlab/tmp/backups/1425568606_gitlab_backup.tar\n$ rm -f /home/git/gitlab/tmp/backups/1425914208_gitlab_backup.tar\n$ df -h\n$ ls -lh /home/git/gitlab/tmp/backups\n\n$ sudo su - git\n$ cd tmp/backups/postgresql\n$ mysqldump --compatible=postgresql --default-character-set=utf8 -r gitlabhq_production.mysql -u root gitlabhq_production -p\nEnter password: \n$ ls\n\n$ git clone https://github.com/gitlabhq/mysql-postgresql-converter.git -b gitlab\n$ ls\n\n$ mkdir db\n$ python mysql-postgresql-converter/db_converter.py gitlabhq_production.mysql db/database.sql\n$ ed -s db/database.sql < mysql-postgresql-converter/move_drop_indexes.ed\n```\n\n\u30a2\u30fc\u30ab\u30a4\u30d6\u3059\u308b\n\n```\n$ gzip db/database.sql\n$ ls db\ndatabase.sql.gz\n```\n\n\u30fb\u540c\u540d\u306emysql\u306e\u30a2\u30fc\u30ab\u30a4\u30d6\u30c7\u30fc\u30bf\u3068\u5165\u308c\u66ff\u3048\u308b\n\n```\n$ tar tf ${bk_prefix}_gitlab_backup.tar\n$ tar rf ${bk_prefix}_gitlab_backup.tar db/database.sql.gz\n```\n\n\u7acb\u3066\u305f\u3089omunibus\u306egitlab\u306b\u30b3\u30f3\u30d0\u30fc\u30c8\u6e08\u307f\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u3092\u8ee2\u9001\u3059\u308b\n\n```\n$ newgitlab=\n$ bk_prefix=\n$ sudo scp -Cp /home/git/gitlab/tmp/backups/postgresql/${bk_prefix}_gitlab_backup.tar user@${newgitlab}:/tmp/\n```\n\n### \uff15\uff0epostgresql\u306eRDS\u3092\u7528\u610f\u3001\u30d1\u30e9\u30e1\u30fc\u30bf\u30b0\u30eb\u30fc\u30d7\u8abf\u6574\n\n\u30b9\u30da\u30c3\u30af\u306fdb.t2.large\u306b\u78ba\u5b9a\n\nhttp://qiita.com/awakia/items/9981f37d5cbcbcd155eb\nhttp://dev.classmethod.jp/cloud/aws/rds-postgres-log-settings/\nhttp://tdoc.info/blog/2012/07/09/postgres_tuning.html\nhttps://www.postgresql.org/docs/9.5/static/runtime-config-logging.html\n\ngitlab-postgres-9-5\u7b49\u306e\u540d\u524d\u3067postgresql9.5\u7528\u306b\u4f5c\u6210\n\n\u30c7\u30d5\u30a9\u30eb\u30c8\u5024\u7b49\u3092\u78ba\u8a8d\u3002\n\n```\nSELECT name,setting,unit FROM pg_settings;\n```\n\n```\nlog_min_duration_statement = 250ms\nlog_temp_files = 0\nlog_checkpoints = 1\nlog_lock_waits = 1\nlog_connections = 1\nlog_disconnections = 1\n\nshared_buffers instance\u30bf\u30a4\u30d7\u3054\u3068\u306b\u52dd\u624b\u306b\u8abf\u6574\u3055\u308c\u308b\u306e\u3067\u6c17\u306b\u3057\u306a\u3044\u3053\u3068\u306b\u3059\u308b\nwork_mem 32768\u3000\u30c7\u30d5\u30a94096kb\u3060\u3063\u305f\u306e\u306732MB\u304b\u3089\u306f\u3058\u3081\u308b\u3089\u3057\u3044\u306e\u3067\u5897\u3084\u3059\nmaintenance_work_mem instance\u30bf\u30a4\u30d7\u3054\u3068\u306b\u52dd\u624b\u306b\u8abf\u6574\u3055\u308c\u308b\u306e\u3067\u6c17\u306b\u3057\u306a\u3044\u3053\u3068\u306b\u3059\u308b\neffective_cache_size instance\u30bf\u30a4\u30d7\u3054\u3068\u306b\u52dd\u624b\u306b\u8abf\u6574\u3055\u308c\u308b\u306e\u3067\u6c17\u306b\u3057\u306a\u3044\u3053\u3068\u306b\u3059\u308b\nrandom_page_cost 2 4\u3060\u3068\u304a\u304a\u304d\u3044\u3089\u3057\u3044\u306e\u30672\u306b\u3059\u308b\nsynchronous_commit \u6c7a\u6e08\u3092\u6271\u3046DB\u3067\u306f\u306a\u3044\u304c\u843d\u3061\u305f\u3068\u304d\u306b\u5371\u306a\u3044\u304b\u3089\u3044\u3058\u3089\u306a\u3044\n```\n\npostgresql\u7528security_group\u66f4\u65b0\u307e\u305f\u306f\u4f5c\u6210\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u3002\n\n```\n$ aws ec2 describe-security-groups --filters Name=group-name,Values=SG_xxxxxx --profile xxxx\n```\n\n\tRDS\u3092\u4f5c\u6210\u3059\u308b\n\n```\n\taws rds create-db-instance \\\n\t--profile hoge \\\n\t--db-name gitlabhq_production \\\n\t--db-instance-identifier hoge-gitlab-rds \\\n\t--storage-type gp2 \\\n\t--allocated-storage 100 \\\n\t--db-instance-class db.t2.large \\\n\t--engine postgres \\\n\t--engine-version 9.5 \\\n\t--master-username gitlab \\\n\t--master-user-password 'xxxxx***' \\\n\t--db-security-groups sg-xxxxxxxx \\\n\t--availability-zone us-xxxx-xa \\\n\t--db-subnet-group-name xxxxxxxx \\\n\t--db-parameter-group-name gitlab-postgres-9-5 \\\n\t--preferred-maintenance-window \"tue:14:00-tue:14:30\" \\\n\t--preferred-backup-window \"18:00-18:30\" \\\n\t--backup-retention-period 7 \\\n\t--port 5432 \\\n\t--multi-az \\\n\t--no-auto-minor-version-upgrade \\\n\t--no-publicly-accessible\n```\n\n\t\u203bcli\u3067\u3046\u307e\u304f\u3044\u304b\u305a\u30de\u30cd\u30b8\u30e1\u30f3\u30c8\u30b3\u30f3\u30bd\u30fc\u30eb\u306b\u3066\u540c\u69d8\u306e\u4f5c\u696d\u3092\u5b9f\u65bd\u3002\n\n\u30a8\u30f3\u30c9\u30dd\u30a4\u30f3\u30c8\u3092chef\u30ea\u30dd\u30b8\u30c8\u30ea\u306b\u767b\u9332\u6e08\u307f\u306e\u540d\u79f0\u3067route53\u306e\u30d7\u30e9\u30a4\u30d9\u30fc\u30c8\u30be\u30fc\u30f3\u306b\u767b\u9332\u3057\u3066\u304a\u304f\nMuliti-AZ\u3067\u5207\u308a\u66ff\u308f\u3063\u305f\u3068\u304d\u7528\u306bttl\u306f60\u3067CNAME\u3067\u767b\u9332\u3059\u308b\n\n\u3067\u3001gitlab\u540c\u68b1\u306eposgresql\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u304cOS\u6a19\u6e96\u3068\u540c\u30589.2\u3067RDS\u3067\u4f7f\u3048\u308b\u30d0\u30fc\u30b8\u30e7\u30f3\u304c9.3\uff5e9.5\u3068\u304b\u3060\u3063\u305f\u306e\u3067\u3001\u305d\u308c\u3060\u3068rails\u3067\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u304c\u4e0d\u53ef\u80fd\u306a\u30a8\u30e9\u30fc\u304c\u51fa\u305f\u306e\u3067\u3001\n\n```\n$ sudo gitlab-rake gitlab:backup:create\nDumping database ... \nDumping PostgreSQL database gitlabhq_production ... pg_dump: server version: 9.5.2; pg_dump version: 9.2.18\npg_dump: aborting because of server version mismatch\n[FAILED]\nBackup failed\n```\n\n9.5\u306e\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u5165\u308c\u3066/etc/gitlab/gitlab.rb\u306ePATH\u306e\u9806\u5e8f\u3092\u8abf\u6574\u3057\u307e\u3057\u305f\u3002\n\n```\n$ sudo yum install https://yum.postgresql.org/9.5/redhat/rhel-7-x86_64/postgresql95-libs-9.5.4-2PGDG.rhel7.x86_64.rpm\n$ sudo yum install https://yum.postgresql.org/9.5/redhat/rhel-7-x86_64/postgresql95-9.5.4-2PGDG.rhel7.x86_64.rpm\n$ which psql\n/usr/bin/psql\n$ psql --version\npsql (PostgreSQL) 9.5.4\n\n$ sudo diff /etc/gitlab/gitlab.rb{,.`date +%Y%m%d`}\n\uff5e\u7565\uff5e\n247,248c247,248\n<   'PATH' => \"/usr/bin:/opt/gitlab/bin:/opt/gitlab/embedded/bin:/bin\" \n< }\n---\n> #   'PATH' => \"/opt/gitlab/bin:/opt/gitlab/embedded/bin:/bin:/usr/bin\" \n> # }\n```\n\n### \uff16\uff0eCentOS7\u304b\u3064ommunibus gitlab8.11\u306e\u65b0\u74b0\u5883\u3092\u69cb\u7bc9\n\nnginx\u306ehttps\u3001ldap\u8a8d\u8a3c\u3001smtp\u306f\u9001\u4fe1\u306e\u307f\u7b49\n\n\u4f5c\u3063\u3066\u304a\u3044\u305fAMI\u3068\u30ec\u30b7\u30d4\u3067\u305f\u3066\u307e\u3057\u305f\u3002\u8a73\u7d30\u306f\u5272\u611b\u3002\n/etc/gitlab/gitlab.rb\u306e\u5dee\u5206\u3060\u3051\u7f6e\u3044\u3068\u304d\u307e\u3059\u3002\n\n```\n$ sudo diff /var/chef/backup/etc/gitlab/gitlab.rb.chef-20160915082044.674309 /etc/gitlab/gitlab.rb \n11c11\n< external_url 'http://ec2-xxxxxxx.us-xxxx-2.compute.amazonaws.com'\n---\n> external_url 'https://gitlab.mng.hoge.example.net/'\n21,24c21,24\n< # gitlab_rails['time_zone'] = 'UTC'\n< # gitlab_rails['gitlab_email_enabled'] = true\n< # gitlab_rails['gitlab_email_from'] = 'example@example.com'\n< # gitlab_rails['gitlab_email_display_name'] = 'Example'\n---\n> gitlab_rails['time_zone'] = 'UTC'\n> gitlab_rails['gitlab_email_enabled'] = true\n> gitlab_rails['gitlab_email_from'] = 'gitlab@mng.hoge.example.net'\n> gitlab_rails['gitlab_email_display_name'] = 'Gitlab'\n59c59\n< # gitlab_rails['incoming_email_enabled'] = true\n---\n> gitlab_rails['incoming_email_enabled'] = false\n107,127c107,127\n< # gitlab_rails['ldap_enabled'] = false\n< # gitlab_rails['ldap_servers'] = YAML.load <<-'EOS' # remember to close this block with 'EOS' below\n< #   main: # 'main' is the GitLab 'provider ID' of this LDAP server\n< #     label: 'LDAP'\n< #     host: '_your_ldap_server'\n< #     port: 389\n< #     uid: 'sAMAccountName'\n< #     method: 'plain' # \"tls\" or \"ssl\" or \"plain\"\n< #     bind_dn: '_the_full_dn_of_the_user_you_will_bind_with'\n< #     password: '_the_password_of_the_bind_user'\n< #     active_directory: true\n< #     allow_username_or_email_login: false\n< #     block_auto_created_users: false\n< #     base: ''\n< #     user_filter: ''\n< #     attributes:\n< #       username: ['uid', 'userid', 'sAMAccountName']\n< #       email:    ['mail', 'email', 'userPrincipalName']\n< #       name:       'cn'\n< #       first_name: 'givenName'\n< #       last_name:  'sn'\n---\n> gitlab_rails['ldap_enabled'] = true\n> gitlab_rails['ldap_servers'] = YAML.load <<-'EOS' # remember to close this block with 'EOS' below\n>   main: # 'main' is the GitLab 'provider ID' of this LDAP server\n>     label: 'LDAP'\n>     host: 'ldap1.mng.hoge.local'\n>     port: 389\n>     uid: 'uid'\n>     method: 'plain' # \"tls\" or \"ssl\" or \"plain\"\n>     bind_dn: 'uid=Auth,ou=System,dc=hoge,dc=example,dc=net'\n>     password: '************'\n>     active_directory: 'false'\n>     allow_username_or_email_login: 'true'\n>     block_auto_created_users: false\n>     base: 'dc=hoge,dc=example,dc=net'\n>     user_filter: ''\n>     attributes:\n>       username: ['uid', 'userid', 'sAMAccountName']\n>       email:    ['mail', 'email', 'userPrincipalName']\n>       name:       'cn'\n>       first_name: 'givenName'\n>       last_name:  'sn'\n247,248c247,248\n<   'PATH' => \"/usr/bin:/opt/gitlab/bin:/opt/gitlab/embedded/bin:/bin\" \n< }\n---\n> #   'PATH' => \"/opt/gitlab/bin:/opt/gitlab/embedded/bin:/bin:/usr/bin\" \n> # }\n281,283c281,283\n< # gitlab_rails['db_username'] = \"gitlab\"\n< # gitlab_rails['db_password'] = nil\n< # gitlab_rails['db_host'] = nil\n---\n> gitlab_rails['db_username'] = \"gitlab\"\n> gitlab_rails['db_password'] = '*******'\n> gitlab_rails['db_host'] = 'gitlab-db-psql.mng.hoge.local'\n322,323c322,323\n< # gitlab_rails['smtp_address'] = \"smtp.server\"\n< # gitlab_rails['smtp_port'] = 465\n---\n> gitlab_rails['smtp_address'] = \"elb-int-smtp.mng.hoge.local\"\n> gitlab_rails['smtp_port'] = 25\n326c326\n< # gitlab_rails['smtp_domain'] = \"example.com\"\n---\n> gitlab_rails['smtp_domain'] = \"mail.mng.hoge.example.net\"\n509d508\n< # postgresql['log_line_prefix'] = \"%a\"\n511d509\n< # postgresql['shared_preload_libraries'] = nil\n570d567\n< \n573c570\n< # nginx['redirect_http_to_https'] = false\n---\n> nginx['redirect_http_to_https'] = true\n576c573\n< # nginx['ssl_verify_client'] = \"off\" # enable/disable 2-way SSL client authentication\n---\n> nginx['ssl_verify_client'] = \"off\" # enable/disable 2-way SSL client authentication\n578,579c575,576\n< # nginx['ssl_certificate'] = \"/etc/gitlab/ssl/#{node['fqdn']}.crt\"\n< # nginx['ssl_certificate_key'] = \"/etc/gitlab/ssl/#{node['fqdn']}.key\"\n---\n> nginx['ssl_certificate'] = \"/etc/gitlab/ssl/gitlab.mng.hoge.example.net.crt\"\n> nginx['ssl_certificate_key'] = \"/etc/gitlab/ssl/gitlab.mng.hoge.example.net.key\"\n593,599c590,596\n< # nginx['proxy_set_headers'] = {\n< #  \"Host\" => \"$http_host\",\n< #  \"X-Real-IP\" => \"$remote_addr\",\n< #  \"X-Forwarded-For\" => \"$proxy_add_x_forwarded_for\",\n< #  \"X-Forwarded-Proto\" => \"https\",\n< #  \"X-Forwarded-Ssl\" => \"on\"\n< # }\n---\n> nginx['proxy_set_headers'] = {\n>   \"Host\" => \"$http_host\",\n>   \"X-Real-IP\" => \"$remote_addr\",\n>   \"X-Forwarded-For\" => \"$proxy_add_x_forwarded_for\",\n>   \"X-Forwarded-Proto\" => \"https\",\n>   \"X-Forwarded-Ssl\" => \"on\"\n>  }\n603,604c600\n< # nginx['real_ip_trusted_addresses'] = []\n< # nginx['real_ip_header'] = nil\n---\n> nginx['real_ip_trusted_addresses'] = ['10.xxx.xxx.0/20']# nginx['real_ip_header'] = nil\n```\n\nnginx\u3092ssl\u3067\u3064\u304b\u3046\u305f\u3081\u306b\u306f\u8a3c\u660e\u66f8\u3092\u6240\u5b9a\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306bcommon\u30cd\u30fc\u30e0.{crt,key}\u3068\u3044\u3046\u3088\u3046\u306a\u611f\u3058\u306b\u7f6e\u3044\u3068\u304b\u306a\u3044\u3068\u8a8d\u8b58\u3055\u308c\u306a\u304b\u3063\u305f\u306e\u304c\u7f60\u3063\u307d\u304b\u3063\u305f\u3067\u3059\u3002\nldap\u306fsecondary\u6307\u5b9a\u3059\u308b\u3068\u30a8\u30e9\u30fc\u3067\u3066\u305f\u3002\u3042\u3068ldap\u306eCA\u8a3c\u660e\u66f8\u3064\u304b\u3046tls\u8a8d\u8a3c\u306f\u516c\u5f0f\u30b5\u30dd\u30fc\u30c8\u5916\u98a8\u3002\n \u21d2\u305d\u306e\u3054\u3001method:\u304ctls\u3058\u3083\u306a\u304f\u3066ssl\u306a\u3089\u8a3c\u660e\u66f8\u691c\u8a3c\u305b\u305a\u306b\u6697\u53f7\u5316\u901a\u4fe1\u53ef\u80fd\u3001\u3068\u3044\u3046\u3053\u3068\u304c\u308f\u304b\u308a\u307e\u3057\u305f\u3002\n\n```\nssh 10.xxx.xxx.xxx\n```\n\nchef\u306e\u5b9f\u884c\u72b6\u6cc1\u3092\u898b\u5b88\u308b\u3002\n\u51fa\u6765\u4e0a\u304c\u3063\u305f\u3089\u30ed\u30fc\u30ab\u30ebPC\u306ehosts\u3092\u3060\u307e\u3057\u3066\u30ed\u30b0\u30a4\u30f3\u3057\u3066\u307f\u308b\u3002\n\t\u4fee\u6b63\u306e\u95a2\u4fc2\u3067\u5143\u306egitlab\u3092\u898b\u305f\u3044\u5834\u5408\u306fDNS\u30ad\u30e3\u30c3\u30b7\u30e5\u3092\u30af\u30ea\u30a2\u3059\u308b\u304b\u5143\u306egitlab\u3092\u30ed\u30fc\u30ab\u30ebPC\u306ehosts\u306b\u660e\u793a\u7684\u306b\u66f8\u304f\n\t(windows\u306a\u3089ipconfig /flushdns\u3059\u308b\uff09\n\n```\n$ sudo vim /etc/hosts\n```\n\n\u3042\u3068hosts\u306e\u30c7\u30fc\u30bf\u3092chef\u30ea\u30dd\u30b8\u30c8\u30ea\u4fee\u6b63\u3057\u3066\u30b3\u30df\u30c3\u30c8\u3002\n\n\n### \uff17\uff0e\u30b3\u30f3\u30d0\u30fc\u30c8\u6e08\u307f\u306e\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u3092\u65b0\u74b0\u5883\u306b\u30ec\u30b9\u30c8\u30a2\u3059\u308b\n\nomunibus-gitlab\u3067\u30ec\u30b9\u30c8\u30a2\u3059\u308b\n\n```\n$ newgitlab=\n$ ls /tmp\n$ bkup_prefix=\n$ ssh user@${newgitlab}\n$ sudo cp /tmp/${bkup_prefix}_gitlab_backup.tar /var/opt/gitlab/backups/\n$ sudo chown -R git. /var/opt/gitlab/backups\n$ sudo gitlab-ctl stop unicorn\n$ sudo gitlab-ctl stop sidekiq\n$ sudo gitlab-rake gitlab:backup:restore BACKUP=${bkup_prefix}\n$ sudo gitlab-ctl start\n\n$ sudo chmod -R ug+rwX,o-rwx /var/opt/gitlab/git-data/repositories\n$ sudo chmod -R ug-s /var/opt/gitlab/git-data/repositories\n$ sudo find /var/opt/gitlab/git-data/repositories -type d -print0 | sudo xargs -0 chmod g+s\n$ sudo -u git -H /opt/gitlab/embedded/service/gitlab-shell/bin/create-hooks /var/opt/gitlab/git-data/repositories\n\n$ sudo gitlab-rake gitlab:check\n```\n\n\u3053\u3053\u3067\u30ed\u30b0\u30a4\u30f3\u3067\u304d\u308b\u304b\u3092\u78ba\u8a8d(Standard/LDAP)\u3002\n\n\u30e1\u30fc\u30eb\u304c\u81ea\u5206\u306b\u5c4a\u304f\u304b\u3092mail\u30b3\u30de\u30f3\u30c9\u3067\u78ba\u8a8d\n\uff08gitlab\u304b\u3089\u306flocalhost\u306b\u5411\u3051\u3066\u3044\u3066postfix\u304c\u5225\u306eMTA\u306b\u30ea\u30ec\u30fc\u3057\u3066\u308b\u30ec\u30b7\u30d4\u3092\u524d\u304b\u3089chef\u3063\u3066\u3042\u308b\u306e\u3067\u7279\u306b\u624b\u4f5c\u696d\u306f\u306a\u3057\uff09\n\n```\n$ echo test-komi |mail -s new-gittest test@fuga.co.jp\n```\n\n\n### \uff18\uff0eDNS\u3092\u5207\u308a\u66ff\u3048EIP\u3092\u4ed8\u3051\u66ff\u3048\u308b\u3001\u52d5\u4f5c\u3092\u78ba\u8a8d\u3059\u308b\n\n\u307e\u305ahosts\u3092\u5207\u308a\u66ff\u3048\u3066\u78ba\u8a8d\u3001\n\u554f\u984c\u306a\u3055\u305d\u3046\u3067\u3042\u308c\u3070\u30b0\u30ed\u30fc\u30d0\u30eb\u306e\u30ec\u30b3\u30fc\u30c9\u3092\u4fee\u6b63\n\ngitlab.mng.hoge.example.net \u3092\u30ed\u30fc\u30ab\u30ebIP\u306b\u4fee\u6b63\uff08VPN\u8d8a\u3057\u306b\u3064\u306a\u3050\u306e\u3067\u30d7\u30e9\u30a4\u30d9\u30fc\u30c8IP\uff09\n\nEIP \u3092\u65e7gitlab\u304b\u3089\u306f\u305a\u3057\u3066\u65b0gitlab\u306b\u3064\u3051\u308b\n\npull\u3057\u3066\u307f\u305f\u308a\u66f4\u65b0\u3057\u305f\u30ea\u30dd\u30b8\u30c8\u30ea\u3092push\u3059\u308b\u306a\u3069\n\n\u3000\u3000\u554f\u984c\u304c\u3042\u3063\u3066\u5207\u308a\u623b\u3059\u5834\u5408\u306f\u6b62\u3081\u3068\u3044\u305f\u65e7\u30b5\u30fc\u30d0\u3092\u8d77\u52d5\u3059\u308b\u3002DNS\u3068\u304bEIP\u3068\u304b\u5909\u3048\u3066\u305f\u3089\u623b\u3059\u3002\n\n\u305d\u308c\u3068\u3001jenkins\u7684\u306aCI\u30c4\u30fc\u30eb\u9023\u643a\u3057\u3066\u308b\u5834\u5408\u306f\u305d\u3053\u304b\u3089\u306e\u63a5\u7d9a\u306e\u8a8d\u8b58\u3092\u30c9\u30e1\u30a4\u30f3\u4ee5\u5916\u306eIP\u3068\u304b\u3067\u76f4\u306b\u6307\u5b9a\u3057\u3066\u3057\u307e\u3063\u3066\u308b\u5834\u5408\u3068\u304bssh\u7684\u306aknown_hosts\u307e\u308f\u308a\u306e\u30a8\u30f3\u30c8\u30ea\u3092\u5dee\u3057\u66ff\u3048\u308b\u3068\u304b\u3092\u3057\u306a\u3044\u3068\u3044\u3051\u306a\u304b\u3063\u305f\u3067\u3059\u306d\u3002\njenkins\u3060\u3068\u4ee5\u4e0b\u306e\u304b\u3093\u3058\u3067\u3057\u305f\u3002\n\n```\n$ sudo vi /etc/hosts\ndomain\u306fdig\u3067\u89e3\u6c7a\u3067\u304d\u308b\u306e\u3067hosts\u304b\u3089\u524a\u9664\n\n10.xxx.xxx.xxx   gitlab  gitlab.mng.hoge.example.net\n\u2193\n10.xxx.yyy.zzz    gitlab  \n\n\u3044\u3061\u304a\u3046jenkins\u30ea\u30b9\u30bf\u30fc\u30c8\n$ sudo service jenkins restart\n\nssh/config\u3092\u306a\u304a\u3059\n\n$ sudo vi /var/lib/jenkins/config\n$ sudo vi /var/lib/jenkins/.ssh/config\n\nHostName gitlab.mng.hoge.example.net\t##\u76f4IP\u3060\u3063\u305f\u306e\u3067\u30c9\u30e1\u30a4\u30f3\u306b\u76f4\u3059\n\nknown_hosts\u6d88\u3057\u3066\u5165\u308c\u306a\u304a\u3059\n$ sudo vi /var/lib/jenkins/.ssh/known_hosts\n$ sudo su - jenkins\n$ ssh gitlab.mng.hoge.example.net\n\u5b9f\u969b\u30ed\u30b0\u30a4\u30f3\u3057\u306a\u304f\u3066\u3082known_hosts\u306b\u306f\u304b\u304b\u308c\u308b\n\ngitlab\u304b\u3089jenkins\u306b\u5411\u3051\u305f\u901a\u4fe1\u3067Webhook\u306essl verification\u3092\u500b\u5225\u306e\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u3067\u5916\u3059\n\n\u3082\u3057gitlab\u304b\u3089clone\u3067\u304d\u306a\u3044\u5834\u5408\u306f\u305d\u306e\u30b5\u30fc\u30d0\u3067http.sslverify\u3092false\u306b\u3059\u308b\n$ sudo su - jenkins\n$ git config --global http.sslverify false\n\u304b\n$ vi /var/lib/jenkins/.gitconfig\n[http]\n        sslverify = false\n```\n\n### \u4eca\u5f8c\u306eommunibus-gitlab-ce\u30d0\u30fc\u30b8\u30e7\u30f3\u30a2\u30c3\u30d7\u65b9\u6cd5\n\n\u30ea\u30dd\u30b8\u30c8\u30ea\u8ffd\u52a0\n\n```\ncurl -s https://packages.gitlab.com/install/repositories/gitlab/gitlab-ce/script.rpm.sh | sudo bash\nyum repolist\n```\n\nyum\u30b3\u30de\u30f3\u30c9\u3067\u30d0\u30fc\u30b8\u30e7\u30f3\u30a2\u30c3\u30d7\n\n```\nsudo yum update gitlab-ce\nsudo gitlab-ctl reconfigure\nsudo gitlab-ctl restart\n```\n\n\n### \u53c2\u8003\u60c5\u5831\n\n\u30d0\u30fc\u30b8\u30e7\u30f3\u30a2\u30c3\u30d7\u95a2\u9023\nhttps://wiki.archlinux.org/index.php/Gitlab#Redis_Over_Unix_Socket\nhttp://docs.gitlab.com/ce/install/installation.html#initial-login\nhttps://github.com/gitlabhq/gitlabhq/issues/6100\nhttp://interprism.hatenablog.com/entry/gitlab6to8\nhttp://d.hatena.ne.jp/akishin999/201308\nhttp://qiita.com/nobuhito/items/7df5f9eb550c300999ff\nhttps://gitlab.com/gitlab-org/gitlab-recipes/blob/master/web-server/apache/gitlab-ssl-apache24.conf\nhttps://github.com/gitlabhq/gitlabhq/tree/master/doc/update\nhttps://github.com/gitlabhq/gitlabhq/blob/master/doc/update/7.14-to-8.0.md\nhttps://github.com/gitlabhq/gitlabhq/blob/master/doc/update/8.0-to-8.1.md\nhttps://github.com/gitlabhq/gitlabhq/blob/master/doc/update/8.1-to-8.2.md\nhttps://github.com/gitlabhq/gitlabhq/blob/master/doc/update/8.8-to-8.9.md\nhttps://github.com/gitlabhq/gitlabhq/blob/master/doc/update/8.10-to-8.11.md\n\nOmmunibus\u53c2\u8003\nhttps://rythgs.co/archives/2015/10/31/switch-omnibus-gitlab/\nhttp://qiita.com/int512/items/632adb4d0b02439d1a9c\nhttp://qiita.com/hosopy/items/965a34d59a0d46731f7c\nhttps://about.gitlab.com/downloads/#centos7\n\nruby\u307e\u308f\u308a\uff08\u74b0\u5883\u5909\u6570\u3068\u304b\u3067PATH\u304c\u3068\u304a\u3063\u3066\u306a\u3044\u7684\u306a\u6df7\u4e71\u304c\u3042\u3063\u305f\uff09\nhttp://docs.ruby-lang.org/ja/2.0.0/library/rubygems.html\nhttp://d.hatena.ne.jp/zariganitosh/20141016/minimum_making_of_gem\n\npython\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u30a2\u30c3\u30d7\nhttps://gitlab.com/gitlab-org/gitlab-ce/blob/52e903e99f3b220553e65be7b6034dfbaeef6d81/doc/update/mysql_to_postgresql.md\nhttps://www.python.org/ftp/python/\nhttp://qiita.com/Hiroyama-Yutaka/items/8a52d54819a0923436a7\n\nnginx\u95a2\u9023\nhttp://next49.hatenadiary.jp/entry/20141114/p2\nhttps://gitlab.com/gitlab-org/omnibus-gitlab/blob/master/doc/settings/nginx.md#supporting-proxied-ssl\nhttp://qiita.com/TaskeHAMANO/items/b01f2d8590c23d6b2bce\n\nhttps\u307e\u308f\u308a\nhttp://mudanakaigi.blogspot.jp/2013/10/gitlab.html\n\nldaps\u95a2\u9023\uff08TLS\u3067\u304d\u306a\u3044\u554f\u984c\uff09\n \u21d2\u305d\u306e\u3054\u3001method:\u304ctls\u3058\u3083\u306a\u304f\u3066ssl\u306a\u3089\u8a3c\u660e\u66f8\u691c\u8a3c\u305b\u305a\u306b\u6697\u53f7\u5316\u901a\u4fe1\u53ef\u80fd\u3001\u3068\u3044\u3046\u3053\u3068\u304c\u308f\u304b\u308a\u307e\u3057\u305f\u3002\nhttps://docs.gitlab.com/ce/administration/auth/ldap.html\nhttp://stackoverflow.com/questions/18984198/how-to-debug-gitlab-ldap-authentication\nhttps://gitlab.com/gitlab-org/omnibus-gitlab/blob/master/doc/settings/ldap.md\nhttp://stackoverflow.com/questions/24457408/openssl-command-to-check-if-a-server-is-presenting-a-certificate\nhttps://gitlab.com/gitlab-org/omnibus-gitlab/issues/712\nhttps://gitlab.com/gitlab-org/omnibus-gitlab/issues/1370\nhttps://gitlab.com/gitlab-org/gitlab-ce/issues/1168\nhttp://simosan.minibird.jp/wordpress/openldap/openldap%E3%81%AEssltls%E8%A8%AD%E5%AE%9A/\nhttp://stackoverflow.com/questions/21477210/correct-location-of-openssl-cnf-file\nhttps://gitlab.com/gitlab-org/gitlab-ce/issues/13669\n\npostgresql\u95a2\u9023\uff08\u30b3\u30f3\u30d0\u30fc\u30c8\u3068\u30d1\u30e9\u30e1\u30fc\u30bf\u30b0\u30eb\u30fc\u30d7\u8abf\u6574\uff09\nhttps://gitlab.com/gitlab-org/gitlab-ce/blob/master/doc/update/mysql_to_postgresql.md#converting-a-gitlab-backup-file-from-mysql-to-postgres\nhttp://qiita.com/awakia/items/9981f37d5cbcbcd155eb\nhttp://dev.classmethod.jp/cloud/aws/rds-postgres-log-settings/\nhttp://qiita.com/Morihaya/items/d09f6f41ba3c374b8cc2\nhttp://db.just4fun.biz/PostgreSQL/%E3%82%AF%E3%83%A9%E3%82%A4%E3%82%A2%E3%83%B3%E3%83%88%E5%81%B4%E3%81%AE%E3%81%BF%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E6%96%B9%E6%B3%95.html\nhttp://tdoc.info/blog/2012/07/09/postgres_tuning.html\nhttps://www.postgresql.org/docs/9.5/static/runtime-config-logging.html\n\n### \u6539\u5584\u3055\u308c\u305f\u70b9\u3068\u6b8b\u308a\n\n\u30fbapache+passenger\u306e\u3088\u3046\u306a\u306e\u3084\u30bd\u30fc\u30b9\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u30a2\u30c3\u30d7\u3067\u3042\u308b\u3088\u3046\u306a\u624b\u9593\u306e\u304b\u304b\u308b\u66f4\u65b0\u304c\u3044\u3089\u306a\u304f\u306a\u3063\u305f\n\u30fb\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u304c\u4e00\u5143\u5316\u3057\u305f\n\n\u30fbldaps\u306eTLS\u8a8d\u8a3c\u304c\u3067\u304d\u306a\u304b\u3063\u305f\uff08\u73fe\u72b6\u89e3\u6c7a\u624b\u6bb5\u304c\u306a\u3055\u305d\u3046\u306a\u306e\u3067\u4eca\u5f8c\u306e\u8ab2\u984c\n \u21d2\u305d\u306e\u3054\u3001method:\u304ctls\u3058\u3083\u306a\u304f\u3066ssl\u306a\u3089\u8a3c\u660e\u66f8\u691c\u8a3c\u305b\u305a\u306b\u6697\u53f7\u5316\u901a\u4fe1\u53ef\u80fd\u3001\u3068\u3044\u3046\u3053\u3068\u304c\u308f\u304b\u308a\u307e\u3057\u305f\u3002\u306a\u30fc\u3093\u3060\u3002\n\u30fbpostgresql\u306e\u30c1\u30a7\u30c3\u30af\u3059\u308b\u30dd\u30a4\u30f3\u30c8\u306b\u306a\u308b\u30ed\u30b0\u51fa\u3057\u3066\u304a\u304d\u306a\u304c\u3089\u76e3\u8996\u306e\u4ed5\u7d44\u307f\u3092\u3064\u304f\u308c\u3066\u306a\u3044\n\u30fbrake\u3067\u306e\u5b9a\u671f\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u306e\u5b9f\u88c5\u306b\u3064\u3044\u3066\u3001IAM\u30ed\u30fc\u30eb\u306f\u3001`'use_iam_profile' => true,`\u3068\u304b\u66f8\u304f\u3068\u3044\u3051\u308b\u6a21\u69d8\u3002\n\u3000\u30b5\u30d6\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3068\u3044\u3046\u304bpath\u3092\u6307\u5b9a\u3057\u3066\u7f6e\u304f\u306e\u306f\u306a\u3093\u3060\u304b\u3067\u304d\u306a\u3044\u307d\u3044\u306e\u3067\u4ee5\u4e0b\u306e\u3088\u3046\u306a`s3 sync`\u3068\u304b\u3067\u3002\n\u3000\u30b5\u30d6\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3044\u3089\u306a\u3044\u5834\u5408\u306f\u5b9a\u671f\u524a\u9664\u306f\u30d0\u30b1\u30c3\u30c8\u306e\u30e9\u30a4\u30d5\u30b5\u30a4\u30af\u30eb\u3067\u3088\u3055\u305d\u3046\u3002\n\n```\n# cat /opt/bin/s3backup-gitlab.sh\n#!/bin/bash\n#\n# s3 backup script for local gitlab.\n# see: https://gitlab.com/gitlab-org/omnibus-gitlab/blob/master/README.md#backups\nDATE=`date +%Y%m%d`\nWEEK=`date +%w`\nBK_DIR=/var/opt/gitlab/backups\nLOG=/opt/bin/bk.log\nS3URL=s3://<mybucket-name>/backup/hoge-git01\nexport AWS_CONFIG_FILE=/root/.aws/config\n\n## daily backup.\necho \"`date +%Y%m%d.%H%M%S` aws s3 backup start.\" >> ${LOG}\ncd ${BK_DIR}/\naws s3 sync . ${S3URL} --delete --acl private --exclude \"*\" --include \"*_gitlab_backup.tar\" --profile hoge\necho \"`date +%Y%m%d.%H%M%S` aws s3 backup end.\" >> ${LOG}\n\nexit\n```\n\n\n\u304a\u308f\u308a\u3067\u3059\u3002\n\n\n\n"}