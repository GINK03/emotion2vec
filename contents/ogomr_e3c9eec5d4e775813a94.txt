{"context": "Flux \u306f Smalltalk \u306e MVC \u3092\u5b9f\u88c5\u3057\u305f\u30d5\u30ec\u30fc\u30e0\u30ef\u30fc\u30af\u3068\u8a00\u308f\u308c\u3066\u3044\u307e\u3059\u3002\nMVC \u306e\u6d41\u308c\u3067\u306f GUI \u3067\u5229\u7528\u3055\u308c\u308b Smalltalk \u306e MVC \u304c\u539f\u70b9\u3067\u3059\u3002\n\u307e\u305f\u3001MVC \u306e\u6b74\u53f2\u3067\u306f Web \u3067\u5229\u7528\u3055\u308c\u308b \u30b5\u30fc\u30d0\u30fc\u30b5\u30a4\u30c9 \u306e MVC(Model 2) \u304c\u767b\u5834\u3057\u307e\u3059\u3002\n\u3053\u306e GUI-MVC(\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u30b5\u30a4\u30c9) \u3068 Web-MVC(\u30b5\u30fc\u30d0\u30fc\u30b5\u30a4\u30c9) \u306e\u5b9f\u88c5\u3092\u500b\u5225\u306b\u8aac\u660e\u3057\u3066\n\u3055\u3089\u306b 2\u3064\u306e MVC \u3092 \u30b3\u30e9\u30dc\u30ec\u30fc\u30b7\u30e7\u30f3 \u3059\u308b\u307e\u3067\u3092\u7d39\u4ecb\u3057\u307e\u3059\u3002\n\n\nAgenda\n\nGUI-MVC \u306f Smalltalk \u306e MVC \u3092 React \u3068 Flux(\u7c21\u6613) \u3067\u8aac\u660e\nWeb-MVC \u306f Rails \u306e MVC \u3092 API only apps \u3067\u8aac\u660e\nGUI-MVC \u3068 Web-MVC \u306e\u63a5\u7d9a\u3092 client-server(C/S) \u30e2\u30c7\u30eb \u3067\u8aac\u660e\nGUI-MVC \u3068 Web-MVC \u306e\u4f9d\u5b58\u3092 Action Cable \u3067\u8aac\u660e\n\n(\u30af\u30e9\u30b9\u56f3\u3084\u30b3\u30f3\u30dd\u30fc\u30cd\u30f3\u30c8\u56f3\u306a\u3069\u306e\u69cb\u9020\u56f3\u306f PlantUML \u3092\u5229\u7528\u3057\u3066\u3044\u307e\u3059\u3002 )\n\n\nSmalltalk\nSmalltalk \u306e MVC \u306f\u60c5\u5831(Model), \u8868\u73fe\u65b9\u6cd5(View), \u5236\u5fa1(Controller)\u306e3\u3064\u306b\u8cac\u52d9\u3092\u5206\u96e2\u3059\u308b\u8a2d\u8a08\u65b9\u91dd\u3067\u3059\u3002\n\u307e\u305f\u3001Observer Pattern \u304c\u8a8d\u8b58\u3055\u308c\u308b\u6570\u5341\u5e74\u524d\u304b\u3089 Observer \u304c\u5b9f\u88c5\u3055\u308c\u3066\u3044\u307e\u3057\u305f\u3002\n\n\nObserver Pattern\nObserver Pattern \u306f \u89b3\u5bdf\u5bfe\u8c61(Subject) \u306e\u72b6\u614b\u306e\u5909\u5316\u3092 \u89b3\u5bdf\u8005(Observer) \u306b\u901a\u77e5\u3092\u3059\u308b\u4ed5\u7d44\u307f\u3067\u3059\u3002\nObserver Pattern \u306e\u5225\u540d\u306f Dependents \u3084 Publish-Subscribe \u3068\u547c\u3070\u308c\u307e\u3059\u3002\n\n@startuml\n\nclass Observer {\n  +update()\n}\n\nclass ConcreteObserver {\n  +update()\n}\n\nclass Subject {\n  state\n  observers\n  +addObserver(observer)\n  +notifyObservers()\n  +getState()\n}\n\nclass ConcreteSubject {\n  +action()\n}\n\nObserver <|.. ConcreteObserver\nSubject <|-- ConcreteSubject\nObserver <-o Subject\n\n@enduml\n\n\n\nGUI-MVC\nGUI-MVC \u306f C -> M -> V \u3068 Flow \u304c\u4e00\u65b9\u5411\u3067\u3059\u3002 Observer Pattern \u3067\u5b9f\u88c5\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n\nController \u304c Model \u306e\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u5b9f\u884c\u3057\u3066 Model \u3092\u66f4\u65b0\u3057\u307e\u3059\u3002\nModel \u306f \u72b6\u614b\u306e\u5909\u66f4\u3092 View \u306b\u901a\u77e5\u3057\u307e\u3059\u3002\nView \u306f\u30e2\u30c7\u30eb\u306e\u72b6\u614b\u3092\u53d6\u5f97\u3057\u3066\u518d\u8868\u793a\u3057\u307e\u3059\u3002\n\n\n@startuml\n\npackage \"GUI-MVC\" {\n  boundary View\n  control Controller\n  entity Model\n\n  [Browser] ...> Controller : 1.Key Down\n\n  Controller ...> Model : 2.Update\n  View ...> Model : 4.Get Data\n  View <... Model : 3.Notify\n\n  [Browser] <... View : 5.Display\n}\n\n@enduml\n\n\n\nCounterView\n\u3053\u308c\u304b\u3089 Redux \u306e\u30b5\u30f3\u30d7\u30eb\u306b\u3082\u3042\u308b\u30ab\u30a6\u30f3\u30bf\u30fc\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\u30e6\u30fc\u30b6\u306e\u5165\u529b\u3067\u6570\u5024\u306e\u5897\u52a0\u3084\u6e1b\u5c11\u3092\u8868\u793a\u3059\u308b\u30b7\u30f3\u30d7\u30eb\u306a\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3067\u3059\u3002\nCounterView \u306f Smalltalk \u306e MVC \u3092\u64ec\u4f3c\u7684\u306b JavaScript \u3067\u5b9f\u88c5\u3057\u307e\u3057\u305f\u3002\nSmalltalk \u306e\u5f8c\u7d99\u306e Squeak \u306e\u30b5\u30f3\u30d7\u30eb\u30b3\u30fc\u30c9\u3092\u53c2\u8003\u306b\u3057\u3066\u3044\u307e\u3059\u3002\n\n\nExample\n\n\nFrontend Boilerplate \u3092\u5229\u7528\u3059\u308b\u304b\u500b\u5225\u306b\u30e9\u30a4\u30d6\u30e9\u30ea\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3092\u3057\u3066\u74b0\u5883\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n$ mkdir react-counter-view-example\n$ cd react-counter-view-example\n$ npm init --force\n$ npm install webpack webpack-dev-server --save-dev\n$ npm install babel-core babel-loader --save-dev\n$ npm install babel-preset-react babel-preset-es2015 --save-dev\n$ npm install react react-hot-loader react-dom --save-dev\n\n$ tree\n.\n\u251c\u2500\u2500 app\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 controllers\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2514\u2500\u2500 CounterKeyboardController.js\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 models\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 Counter.js\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2514\u2500\u2500 Subject.js\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 views\n\u2502\u00a0\u00a0 \u2502   \u2514\u2500\u2500 CounterTextView.js\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 index.js\n\u251c\u2500\u2500 .babelrc\n\u251c\u2500\u2500 index.html\n\u251c\u2500\u2500 package.json\n\u2514\u2500\u2500 webpack.config.js\n\n\n\nModel\n\nSubject\n\nSubject \u30af\u30e9\u30b9\u306b\u306f\u72b6\u614b\u3068 Observer \u306e\u30ea\u30b9\u30c8\u304c\u4fdd\u6301\u3055\u308c\u307e\u3059\u3002\nObserver \u3092\u8ffd\u52a0\u3059\u308b\u30e1\u30bd\u30c3\u30c9\u3068\u901a\u77e5\u3059\u308b\u30e1\u30bd\u30c3\u30c9\u304c\u5b9f\u88c5\u3055\u308c\u307e\u3059\u3002\n\u72b6\u614b\u3092\u53d6\u5f97\u3059\u308b\u30e1\u30bd\u30c3\u30c9\u304c\u5b9f\u88c5\u3055\u308c\u307e\u3059\u3002\n\n(\u7c21\u6613\u306a Flux \u3067\u3059\u304c Redux \u306e\u30b3\u30fc\u30c9\u3092\u53c2\u8003\u306b\u3057\u3066\u3044\u307e\u3059\u3002)\n\napp/models/Subject.js\nclass Subject {\n  constructor() {\n    this.state = undefined\n    this.observers = []\n  }\n\n  addObserver(observer) {\n    this.observers.push(observer)\n  }\n\n  notifyObservers() {\n    this.observers.forEach(observer => observer())\n  }\n\n  getState() {\n    return this.state\n  }\n}\n\nexport default Subject\n\n\n\n\nConcreteSubject\n\nSubject \u30af\u30e9\u30b9\u3092\u7d99\u627f\u3057\u3066\u3001ConcreteSubject \u30af\u30e9\u30b9\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\nCounter \u30af\u30e9\u30b9\u306b Model \u306e\u72b6\u614b\u3092\u5909\u66f4\u3059\u308b action \u30e1\u30bd\u30c3\u30c9\u304c\u5b9f\u88c5\u3055\u308c\u307e\u3059\u3002\n\n\napp/models/Counter.js\nimport Subject from './Subject'\n\nclass Counter extends Subject {\n  constructor() {\n    super()\n    this.state = 0\n  }\n\n  action(type) {\n    switch (type) {\n    case 'increase':\n      this.state += 1\n      break\n    case 'decrease':\n      this.state -= 1\n      break\n    }\n\n    this.notifyObservers()\n  }\n}\n\nexport default Counter\n\n\n\n\nController\n\n\u30ad\u30fc\u306e\u5165\u529b\u3068 Model \u306e\u30a2\u30af\u30b7\u30e7\u30f3\u3092\u8a2d\u5b9a\u3057\u307e\u3059\u3002\nu(up)\u306e\u30ad\u30fc\u3067\u5897\u52a0\u3057\u3066\u3001d(down)\u306e\u30ad\u30fc\u3067\u6e1b\u5c11\u3059\u308b\u4ed5\u69d8\u3067\u3059\u3002\n\n\napp/controllers/CounterKeyboardController.js\nexport default function CounterKeyboardController(model) {\n  return {\n    u: () => model.action('increase'),\n    d: () => model.action('decrease')\n  }\n}\n\n\n\n\nView\n\nReact \u306e Component \u30af\u30e9\u30b9\u3092\u7d99\u627f\u3057\u3066\u3001ConcreteObserver \u30af\u30e9\u30b9\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\ncomponentDidMount \u30e1\u30bd\u30c3\u30c9\u3067\u3001\u30ad\u30fc\u306e\u5165\u529b\u3068 Controller \u3092\u8a2d\u5b9a\u3057\u307e\u3059\u3002\nrender \u30e1\u30bd\u30c3\u30c9\u3067\u3001\u8868\u793a\u3092\u3059\u308b\u8981\u7d20\u306e\u69cb\u6210\u3092\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\n\napp/views/CounterTextView.js\nimport React, { Component } from 'react'\n\nclass CounterTextView extends Component {\n  componentDidMount() {\n    window.document.addEventListener(\n      'keydown',\n      this.handleKeyDown.bind(this)\n    )\n  }\n\n  handleKeyDown(e) {\n    this.props.controller[e.key]()\n  }\n\n  render() {\n    return (\n      <div>\n        <h1>Counter</h1>\n        <p>Key Downed: {this.props.count} times</p>\n        <div>Increase in the key of u (up)</div>\n        <div>Decrease in the key of d (down)</div>\n      </div>\n    )\n  }\n}\n\nexport default CounterTextView\n\n\n\n\nContainer\n\nMVC \u3092\u7d50\u3073\u3064\u3051\u307e\u3059\u3002Model \u3092 Controller \u306b\u8a2d\u5b9a\u3057\u307e\u3059\u3002\nView \u306b Controller \u3068 Model \u306e\u72b6\u614b\u306e\u53d6\u5f97\u3092\u8a2d\u5b9a\u3057\u307e\u3059\u3002\nView \u3092 Observer \u306b\u8ffd\u52a0\u3057\u307e\u3059\u3002\n\n\napp/index.js\nimport React from 'react'\nimport ReactDOM from 'react-dom'\nimport Counter from './models/Counter'\nimport CounterTextView from './views/CounterTextView'\nimport CounterKeyboardController from './controllers/CounterKeyboardController'\n\nconst model = new Counter()\nconst controller = CounterKeyboardController(model)\n\nfunction render() {\n  ReactDOM.render(\n    <CounterTextView\n      controller={controller}\n      count={model.getState()}\n    />,\n    document.getElementById('root')\n  )\n}\n\nrender()\nmodel.addObserver(render)\n\n\n\n\nDemo\n\n\u30b5\u30f3\u30d7\u30eb\u3067\u5206\u304b\u308b\u3088\u3046\u306b MVC \u306f Model, View, Controller \u304c\u758e\u7d50\u5408\u306b\u306a\u308a\u3001\u8cac\u52d9\u306e\u5206\u96e2\u304c\u5b9f\u73fe\u3067\u304d\u307e\u3059\u3002\n\n\nWeb-MVC\nWeb \u306e MVC \u3082\u60c5\u5831(Model), \u8868\u73fe\u65b9\u6cd5(View), \u5236\u5fa1(Controller)\u306e3\u3064\u306b\u8cac\u52d9\u3092\u5206\u96e2\u3059\u308b\u8a2d\u8a08\u65b9\u91dd\u3067\u3059\u3002\n\u3057\u304b\u3057\u3001GUI \u3068 Web \u306f\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u30c9\u30e1\u30a4\u30f3\u304c\u9055\u3046\u306e\u3067 MVC \u306e\u5f79\u5272\u306f\u540c\u3058\u3067\u306f\u3042\u308a\u307e\u305b\u3093\u3002\n\u3082\u3061\u308d\u3093 Model \u3068 View \u306b Observer Pattern \u306f\u5b9f\u88c5\u3055\u308c\u3066\u3044\u307e\u305b\u3093\u3002\nWeb-MVC \u306f C -> M -> C -> V -> C \u3068 Flow \u306b Controller \u304c\u4f55\u5ea6\u3082\u767b\u5834\u3057\u307e\u3059\u3002\n\nController \u304c Request \u3092\u53d7\u3051\u3066 Model \u3092\u64cd\u4f5c\u3057\u3066\u30c7\u30fc\u30bf\u3092\u53d6\u5f97\u3057\u307e\u3059\u3002\nController \u304c View \u306b Model \u306e\u30c7\u30fc\u30bf\u3092\u30bb\u30c3\u30c8\u3057\u3066\u3001\u30b3\u30f3\u30c6\u30f3\u30c4\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\nController \u304c Response \u3092\u8fd4\u3057\u307e\u3059\u3002\n\n\n@startuml\n\npackage \"Web-MVC\" {\n  boundary View\n  control Controller\n  entity Model\n\n  [Browser] <... Controller : 6.Response\n  [Browser] ...> Controller : 1.Request\n\n  Controller ...> Model : 2.Get Data\n  Controller ...> Model : 3.Set Data\n\n  Controller <... View : 5.Render\n  Controller ...> View : 4.Set Data\n}\n\n@enduml\n\n\n\nCounterViewApi\nCounterViewApi \u306f Ruby on Rails \u306e API only apps \u3092\u5229\u7528\u3057\u3066\u5b9f\u88c5\u3057\u307e\u3057\u305f\u3002\nCounterView \u3068\u540c\u3058\u304f\u30ab\u30a6\u30f3\u30bf\u30fc\u306e\u30b7\u30f3\u30d7\u30eb\u306a\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3067\u3059\u3002\n\n\nrails new \u30b3\u30de\u30f3\u30c9\u306b --api \u30aa\u30d7\u30b7\u30e7\u30f3\u3067 API \u3060\u3051\u306e Web \u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u304c\u4f5c\u6210\u3067\u304d\u307e\u3059\u3002\n\nrails generate scaffold \u30b3\u30de\u30f3\u30c9\u3067 counter \u306e MVC \u304c\u4f5c\u6210\u3067\u304d\u307e\u3059\u3002\n\n\n\nExample\n$ rails new counter-view-api --api\n$ mv counter-view-api rails-counter-view-example\n$ cd rails-counter-view-example\n$ edit Gemfile\n$ rails generate scaffold counter state:integer\n\n$ tree\n.\n\u251c\u2500\u2500 app\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 controllers\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 application_controller.rb\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2514\u2500\u2500 counters_controller.rb\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 models\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 application_record.rb\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2514\u2500\u2500 counter.rb\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 views\n\u2502\u00a0\u00a0     \u2514\u2500\u2500 counters\n\u2502\u00a0\u00a0       \u00a0\u00a0  \u2514\u2500\u2500 show.json.jbuilder\n\u251c\u2500\u2500 bin\n\u251c\u2500\u2500 config\n\u251c\u2500\u2500 db\n\u251c\u2500\u2500 lib\n\u251c\u2500\u2500 public\n\u251c\u2500\u2500 config.ru\n\u251c\u2500\u2500 Gemfile\n\u2514\u2500\u2500 Rakefile\n\n\n\nModel\n\nApplicationRecord \u30af\u30e9\u30b9\u3092\u7d99\u627f\u3057\u3066\u3001Counter \u30af\u30e9\u30b9\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\u30ab\u30f3\u30bf\u30fc\u306e\u72b6\u614b\u3092\u4fdd\u6301\u3057\u3001\u5897\u52a0\u3068\u6e1b\u5c11\u306e\u30e1\u30bd\u30c3\u30c9\u3092\u5b9f\u88c5\u3057\u307e\u3059\u3002\n\n\napp/models/counter.rb\nclass Counter < ApplicationRecord\n  def initialize\n    super\n    self.state = 0\n  end\n\n  def increase\n    self.state = self.state + 1\n  end\n\n  def decrease\n    self.state = self.state - 1\n  end\nend\n\n\n\n\nController\n\nApplicationController \u30af\u30e9\u30b9\u3092\u7d99\u627f\u3057\u3066\u3001CounterController \u30af\u30e9\u30b9\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\u30ab\u30f3\u30bf\u30fc\u306e\u72b6\u614b\u3092\u8868\u793a\u3059\u308b\u30e1\u30bd\u30c3\u30c9\u3068\u5897\u52a0\u3068\u6e1b\u5c11\u306e\u30e1\u30bd\u30c3\u30c9\u3092\u5b9f\u88c5\u3057\u307e\u3059\u3002\n\n(Rails \u306f Controller \u306e\u30e1\u30bd\u30c3\u30c9\u3092\u30a2\u30af\u30b7\u30e7\u30f3\u3068\u547c\u3073\u307e\u3059\u3002)\n\napp/controllers/counters_controller.rb\nclass CountersController < ApplicationController\n  before_action :set_counter\n\n  def show\n  end\n\n  def create\n    @counter.increase\n    @counter.save!\n  end\n\n  def destroy\n    @counter.decrease\n    @counter.save!\n  end\n\n  private\n    def set_counter\n      @counter = Counter.last || Counter.new\n    end\nend\n\n\n\n\nView\n\nModel \u306e\u30c7\u30fc\u30bf\u3092 View \u306e\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u306b\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\n\napp/views/counters/show.json.jbuilder\njson.extract! @counter, :state\n\n\n\n\nRouter\n\nURL \u306e \u30eb\u30fc\u30c6\u30a3\u30f3\u30b0 \u3092\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u30fc\u3068\u30a2\u30af\u30b7\u30e7\u30f3\u3092\u7d50\u3073\u3064\u3051\u307e\u3059\u3002\n\n\nconfig/routes.rb\nRails.application.routes.draw do\n  resource :counter, only: [:show, :create, :destroy]\nend\n\n\n\n\nDemo\n\n\u30ab\u30a6\u30f3\u30bf\u30fc\u3092\u8868\u793a\u3059\u308b curl \u306e\u30b3\u30de\u30f3\u30c9\u3067\u3059\u3002\n\n$ curl -X GET http://localhost:3000/counter\n{\"state\":8}\n\n\n\u30ab\u30a6\u30f3\u30bf\u30fc\u3092\u5897\u52a0\u3059\u308b\u30b3\u30de\u30f3\u30c9\u3067\u3059\u3002\n\n$ curl -X POST http://localhost:3000/counter\n\n\n\u30ab\u30a6\u30f3\u30bf\u30fc\u3092\u6e1b\u5c11\u3059\u308b\u30b3\u30de\u30f3\u30c9\u3067\u3059\u3002\n\n$ curl -X DELETE http://localhost:3000/counter\n\nREST API \u306a\u306e\u3067 \u30a8\u30f3\u30c9\u30dd\u30a4\u30f3\u30c8\u306f\u540c\u3058\u3067\u3082\u3001\u30e1\u30bd\u30c3\u30c9\u3067\u632f\u308b\u821e\u3044\u304c\u5909\u308f\u308a\u307e\u3059\u3002\n\n\nGUI-MVC\u3068Web-MVC\u306e\u63a5\u7d9a\nWeb \u3082 Web-browser \u3068 Web-server \u306e client-server(C/S) \u306a\u306e\u3067\u3059\u304c\nGUI-MVC(client) \u3068 Web-MVC(server) \u3092\u7d50\u3073\u3064\u3051\u3066\u30c7\u30fc\u30bf\u3092\u9023\u643a\u3057\u307e\u3059\u3002\nC/S \u306f \u30d7\u30ec\u30bc\u30f3\u30c6\u30fc\u30b7\u30e7\u30f3\u5c64(\u30e6\u30fc\u30b6\u30a4\u30f3\u30bf\u30fc\u30d5\u30a7\u30fc\u30b9)\u3001\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u5c64(\u30d3\u30b8\u30cd\u30b9\u30ed\u30b8\u30c3\u30af)\u3001\n\u30c7\u30fc\u30bf\u5c64(\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9) \u30673\u968e\u5c64\u30e2\u30c7\u30eb\u3068\u547c\u3070\u308c\u307e\u3059\u3002\n\n@startuml\n\npackage \"GUI-MVC\" {\n  boundary View\n  control Controller\n  entity Model\n\n  [Browser] ...> Controller : 1.Key Down\n\n  Controller ...> Model : 2.Update\n  View ...> Model : 10.Get Data\n  View <... Model : 9.Notify\n\n  [Browser] <... View : 11.Display\n}\n\npackage \"Web-MVC\" {\n  boundary View2\n  control Controller2\n  entity Model2\n\n  Model <.. Controller2 : 8.Response\n  Model ..> Controller2 : 3.Request\n\n  Controller2 ...> Model2 : 5.Set Data\n  Controller2 ...> Model2 : 4.Get Data\n\n  Controller2 <... View2 : 7.Render\n  Controller2 ...> View2 : 6.Set Data\n}\n\n@enduml\n\n\n\nGUI-MVC(client)\n\naction \u30e1\u30bd\u30c3\u30c9\u306b fetch \u3067 CounterViewApi \u3068\u7d50\u3073\u3064\u3051\u307e\u3059\u3002\n\n\n\nModel\n\napp/models/Counter.js\nimport Subject from './Subject'\nimport fetch from 'isomorphic-fetch'\n\nconst endpoint = 'http://localhost:3000/counter'\n\nclass Counter extends Subject {\n  constructor() {\n    super()\n    this.state = 0\n  }\n\n  action(type) {\n    switch (type) {\n    case 'show':\n      fetch(endpoint, {headers: {accept: 'application/json'}})\n        .then(response => response.json())\n        .then(json => {\n          this.state = json.state\n          this.notifyObservers()\n        })\n      break\n    case 'increase':\n      fetch(endpoint, {method: 'post'})\n        .then(response => this.action('show'))\n      break\n    case 'decrease':\n      fetch(endpoint, {method: 'delete'})\n        .then(response => this.action('show'))\n      break\n    }\n  }\n}\n\nexport default Counter\n\n\n\n\nContainer\n\nView \u3092 Observer \u306b\u8ffd\u52a0\u3057\u305f\u5f8c\u306b\u3001\u8868\u793a\u306e\u30a2\u30af\u30b7\u30e7\u30f3\u3092\u5b9f\u65bd\u3057\u307e\u3059\u3002\n\n\napp/index.js\nimport React from 'react'\nimport ReactDOM from 'react-dom'\nimport Counter from './models/Counter'\nimport CounterTextView from './views/CounterTextView'\nimport CounterKeyboardController from './controllers/CounterKeyboardController'\n\nconst model = new Counter()\nconst controller = CounterKeyboardController(model)\n\nfunction render() {\n  ReactDOM.render(\n    <CounterTextView\n      controller={controller}\n      count={model.getState()}\n    />,\n    document.getElementById('root')\n  )\n}\n\nrender()\nmodel.addObserver(render)\nmodel.action('show')\n\n\n\n\nWeb-MVC(server)\n\nclient \u304c No Access-Control-Allow-Origin \u3092\u8868\u793a\u3059\u308b\u306e\u3067 CORS \u306b\u5bfe\u5fdc\u3057\u307e\u3059\u3002\nRails 5 \u304b\u3089 gem 'rack-cors' \u304c\u6a19\u6e96\u3067\u8a2d\u5b9a\u3055\u308c\u3066\u3044\u308b\u306e\u3067 CORS \u306e\u5bfe\u5fdc\u304c\u7c21\u5358\u3067\u3059\u3002\n\n\nconfig/initializers/cors.rb\nRails.application.config.middleware.insert_before 0, Rack::Cors do\n  allow do\n    origins 'localhost'\n\n    resource '*',\n      headers: :any,\n      methods: [:get, :post, :put, :patch, :delete, :options, :head]\n  end\nend\n\n\n\n\nDemo\n\n\u30c9\u30e1\u30a4\u30f3\u99c6\u52d5\u8a2d\u8a08 \u3067\u306f \u30ec\u30a4\u30e4\u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3 \u3067\u8cac\u52d9\u306b\u5fdc\u3058\u305f4\u3064\u306e\u5c64\u304c\u8aac\u660e\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n\u305d\u306e\u30d7\u30ec\u30bc\u30f3\u30c6\u30fc\u30b7\u30e7\u30f3\u5c64\u3068\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u5c64\u3067 MVC \u3092\u5229\u7528\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3057\u305f\u3002\n\n\nGUI-MVC\u3068Web-MVC\u306e\u4f9d\u5b58\nclient-server(C/S) \u306b\u3082 Observer Pattern \u3092\u5b9f\u88c5\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\nGUI-MVC(client) \u3068 Web-MVC(server) \u3092\u4f9d\u5b58\u3055\u305b\u3066\u72b6\u614b\u5909\u66f4\u3092\u901a\u77e5\u3057\u307e\u3059\u3002\n\n@startuml\n\npackage \"GUI-MVC\" {\n  boundary View\n  control Controller\n  entity Model\n\n  [Browser] ...> Controller : 1.Key Down\n\n  Controller ...> Model : 2.Update\n  View ...> Model : 11.Get Data\n  View <... Model : 10.Notify\n\n  [Browser] <... View : 12.Display\n}\n\npackage \"Web-MVC\" {\n  boundary View2\n  control Controller2\n  entity Model2\n\n  Model <.. Controller2 : 8.Response\n  Model <.. Controller2 : 9.Notify\n  Model ..> Controller2 : 3.Request\n\n  Controller2 ...> Model2 : 5.Set Data\n  Controller2 ...> Model2 : 4.Get Data\n\n  Controller2 <... View2 : 7.Render\n  Controller2 ...> View2 : 6.Set Data\n}\n\n@enduml\n\n\n\nGUI-MVC(subscribe)\n\n\nActionCable(WebSocket) \u3067 CounterViewApi \u3068\u7d50\u3073\u3064\u3051\u307e\u3059\u3002\nSubscribe \u3092\u8ffd\u52a0\u3059\u308b\u30e1\u30bd\u30c3\u30c9\u304c\u5b9f\u88c5\u3055\u308c\u307e\u3059\u3002\n\n\n\nModel\n\napp/models/Counter.js\nimport Subject from './Subject'\nimport fetch from 'isomorphic-fetch'\nimport ActionCable from 'actioncable'\n\nconst endpoint = 'http://localhost:3000/counter'\nconst cable = ActionCable.createConsumer('ws://localhost:3000/cable')\n\nclass Counter extends Subject {\n  constructor() {\n    super()\n    this.state = 0\n  }\n\n  action(type) {\n    switch (type) {\n    case 'show':\n      fetch(endpoint, {headers: {accept: 'application/json'}})\n        .then(response => response.json())\n        .then(json => {\n          this.state = json.state\n          this.notifyObservers()\n        })\n      break\n    case 'increase':\n      fetch(endpoint, {method: 'post'})\n        .then(response => this.action('show'))\n      break\n    case 'decrease':\n      fetch(endpoint, {method: 'delete'})\n        .then(response => this.action('show'))\n      break\n    }\n  }\n\n  addSubscribe(channel) {\n    cable.subscriptions.create(\n      channel,\n      {\n        connected() {\n          this.handleShow()\n        },\n        received() {\n          this.handleShow()\n        },\n        handleShow: () => this.action('show')\n      }\n    )\n  }\n}\n\nexport default Counter\n\n\n\n\nContainer\n\nView \u3092 Observer \u306b\u8ffd\u52a0\u3057\u305f\u5f8c\u306b Subscribe \u3092\u8ffd\u52a0\u3057\u307e\u3059\u3002\n\n\napp/index.js\nimport React from 'react'\nimport ReactDOM from 'react-dom'\nimport Counter from './models/Counter'\nimport CounterTextView from './views/CounterTextView'\nimport CounterKeyboardController from './controllers/CounterKeyboardController'\n\nconst model = new Counter()\nconst controller = CounterKeyboardController(model)\n\nfunction render() {\n  ReactDOM.render(\n    <CounterTextView\n      controller={controller}\n      count={model.getState()}\n    />,\n    document.getElementById('root')\n  )\n}\n\nrender()\nmodel.addObserver(render)\nmodel.addSubscribe('CounterChannel')\n\n\n\n\nWeb-MVC(publish)\n\nRails Action Cable(WebSocket) \u3067 CounterView \u3068\u7d50\u3073\u3064\u3051\u307e\u3059\u3002\n\nrails generate channel \u30b3\u30de\u30f3\u30c9\u3067 counter \u306e ActionCable \u304c\u4f5c\u6210\u3067\u304d\u307e\u3059\u3002\n\n\n\nExample\n$ rails generate channel counter\n\n$ tree\n.\n\u251c\u2500\u2500 app\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 channels\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 application_cable\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 channel.rb\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2514\u2500\u2500 connection.rb\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2514\u2500\u2500 counter_channel.rb\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 controllers\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 models\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 views\n\n\n\nChannel\n\n\nsubscribed \u306b counter \u3092\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\n\napp/channels/counter_channel.rb\nclass CounterChannel < ApplicationCable::Channel\n  def subscribed\n    stream_from 'counter'\n  end\n\n  def unsubscribed\n    # Any cleanup needed when channel is unsubscribed\n  end\nend\n\n\n\n\nController\n\n\u72b6\u614b\u3092\u5909\u66f4\u3057\u305f\u5f8c\u306b ActionCable.server.broadcast \u3067 counter \u3092\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\n\napp/controllers/counters_controller.rb\nclass CountersController < ApplicationController\n  before_action :set_counter\n\n  def show\n  end\n\n  def create\n    @counter.increase\n    @counter.save!\n    ActionCable.server.broadcast 'counter', nil\n  end\n\n  def destroy\n    @counter.decrease\n    @counter.save!\n    ActionCable.server.broadcast 'counter', nil\n  end\n\n  private\n    def set_counter\n      @counter = Counter.last || Counter.new\n    end\nend\n\n\n\n\u63a5\u7d9a\u3092\u8a31\u53ef\u3059\u308b \u30a8\u30f3\u30c9\u30dd\u30a4\u30f3\u30c8 \u3092\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\n\nconfig/application.rb\nmodule CounterView\n  class Application < Rails::Application\n    config.api_only = true\n    config.action_cable.allowed_request_origins = ['http://localhost:4000']\n  end\nend\n\n\n\n\nDemo\n\n\n\u5b9f\u8df5\u30c9\u30e1\u30a4\u30f3\u99c6\u52d5\u8a2d\u8a08 \u3067\u306f \u30c9\u30e1\u30a4\u30f3\u30a4\u30d9\u30f3\u30c8 \u3067\u51fa\u7248-\u8cfc\u8aad\u578b\u30e2\u30c7\u30eb\u304c\u8aac\u660e\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n\u30e1\u30c3\u30bb\u30fc\u30b8\u30f3\u30b0\u30df\u30c9\u30eb\u30a6\u30a7\u30a2\u306b\u306f RabbitMQ \u306a\u3069\u306e AMQP \u3092\u5229\u7528\u3059\u308b\u3053\u3068\u3092\u52e7\u3081\u3089\u308c\u3066\u3044\u307e\u3059\u3002\n\n\nAsync\n\nRails \u306f Active Job \u3092\u5229\u7528\u3059\u308b\u3068 Publish \u3092\u975e\u540c\u671f\u306b\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\nrails generate channel \u30b3\u30de\u30f3\u30c9\u3067 counter \u306e ActionCable \u304c\u4f5c\u6210\u3067\u304d\u307e\u3059\u3002\n\n\n\nExample\n$ rails generate job counter\n\n$ tree\n.\n\u251c\u2500\u2500 app\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 channels\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 controllers\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 jobs\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 application_job.rb\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2514\u2500\u2500 counter_job.rb\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 models\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 views\n\n\n\nJob\n\n\nActionCable.server.broadcast \u306e counter \u3092\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\n\napp/jobs/counter_job.rb\nclass CounterJob < ApplicationJob\n  queue_as :default\n\n  def perform(*args)\n    ActionCable.server.broadcast 'counter', nil\n  end\nend\n\n\n\n\nController\n\n\u72b6\u614b\u3092\u5909\u66f4\u3057\u305f\u5f8c\u306b CounterJob.perform_later \u3092\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\n\napp/controllers/counters_controller.rb\nclass CountersController < ApplicationController\n  before_action :set_counter\n\n  def show\n  end\n\n  def create\n    @counter.increase\n    @counter.save!\n    CounterJob.perform_later\n  end\n\n  def destroy\n    @counter.decrease\n    @counter.save!\n    CounterJob.perform_later\n  end\n\n  private\n    def set_counter\n      @counter = Counter.last || Counter.new\n    end\nend\n\n\n\n\nDemo\n\nActive Job \u306f \u30df\u30c9\u30eb\u30a6\u30a7\u30a2\u306b Redis \u3092\u5229\u7528\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\n\nRedux\nRedux \u306f Flux \u306e\u6d41\u308c\u306a\u306e\u3067\u6700\u521d\u306b\u8aac\u660e\u3092\u3057\u305f GUI-MVC \u306e\u5f71\u97ff\u3092\u53d7\u3051\u3066\u3044\u307e\u3059\u3002\n\u3055\u3089\u306b Redux \u306f CQRS \u3084 Event Sourcing \u306e\u5f71\u97ff\u3092\u53d7\u3051\u3066 \u4e09\u539f\u5247 \u306b\u53cd\u6620\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n\n@startuml\n\npackage \"Redux\" {\n  boundary View\n  entity Store\n  control Action\n  control Reducer\n\n  [Browser] ..> Action\n\n  Action ..> Store\n  Store <.. Reducer\n  Store ..> Reducer\n  View <.. Store\n\n  [Browser] <.. View\n}\n\n@enduml\n\n\n\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30bd\u30d5\u30c8\u30a6\u30a7\u30a2 \u306f\u8981\u6c42\u306b\u3088\u3063\u3066\u8907\u96d1\u306b\u306a\u308a\u307e\u3059\u3002\n\u305d\u306e\u8907\u96d1\u306b\u306f\u69d8\u3005\u306a\u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3\u3092\u99c6\u4f7f\u3057\u3066\u7acb\u3061\u5411\u304b\u3044\u307e\u3057\u3087\u3046\u3002\n\n[Flux](http://facebook.github.io/flux/) \u306f [Smalltalk](https://ja.wikipedia.org/wiki/Smalltalk) \u306e MVC \u3092\u5b9f\u88c5\u3057\u305f\u30d5\u30ec\u30fc\u30e0\u30ef\u30fc\u30af\u3068\u8a00\u308f\u308c\u3066\u3044\u307e\u3059\u3002\n[MVC \u306e\u6d41\u308c](http://qiita.com/hirokidaichi/items/0de5ca336de862cc91bd)\u3067\u306f GUI \u3067\u5229\u7528\u3055\u308c\u308b Smalltalk \u306e MVC \u304c\u539f\u70b9\u3067\u3059\u3002\n\u307e\u305f\u3001[MVC \u306e\u6b74\u53f2](https://ja.wikipedia.org/wiki/Model_View_Controller)\u3067\u306f Web \u3067\u5229\u7528\u3055\u308c\u308b \u30b5\u30fc\u30d0\u30fc\u30b5\u30a4\u30c9 \u306e MVC(Model 2) \u304c\u767b\u5834\u3057\u307e\u3059\u3002\n\n\u3053\u306e GUI-MVC(\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u30b5\u30a4\u30c9) \u3068 Web-MVC(\u30b5\u30fc\u30d0\u30fc\u30b5\u30a4\u30c9) \u306e\u5b9f\u88c5\u3092\u500b\u5225\u306b\u8aac\u660e\u3057\u3066\n\u3055\u3089\u306b 2\u3064\u306e MVC \u3092 \u30b3\u30e9\u30dc\u30ec\u30fc\u30b7\u30e7\u30f3 \u3059\u308b\u307e\u3067\u3092\u7d39\u4ecb\u3057\u307e\u3059\u3002\n\n----\n\n## Agenda\n\n1. GUI-MVC \u306f Smalltalk \u306e MVC \u3092 React \u3068 Flux(\u7c21\u6613) \u3067\u8aac\u660e\n2. Web-MVC \u306f Rails \u306e MVC \u3092 API only apps \u3067\u8aac\u660e\n3. GUI-MVC \u3068 Web-MVC \u306e\u63a5\u7d9a\u3092 client-server(C/S) \u30e2\u30c7\u30eb \u3067\u8aac\u660e\n4. GUI-MVC \u3068 Web-MVC \u306e\u4f9d\u5b58\u3092 Action Cable \u3067\u8aac\u660e\n\n(\u30af\u30e9\u30b9\u56f3\u3084\u30b3\u30f3\u30dd\u30fc\u30cd\u30f3\u30c8\u56f3\u306a\u3069\u306e\u69cb\u9020\u56f3\u306f [PlantUML](http://qiita.com/ogomr/items/0b5c4de7f38fd1482a48) \u3092\u5229\u7528\u3057\u3066\u3044\u307e\u3059\u3002 )\n\n----\n\n## Smalltalk\n\nSmalltalk \u306e MVC \u306f\u60c5\u5831(Model), \u8868\u73fe\u65b9\u6cd5(View), \u5236\u5fa1(Controller)\u306e3\u3064\u306b\u8cac\u52d9\u3092\u5206\u96e2\u3059\u308b\u8a2d\u8a08\u65b9\u91dd\u3067\u3059\u3002\n\u307e\u305f\u3001Observer Pattern \u304c\u8a8d\u8b58\u3055\u308c\u308b\u6570\u5341\u5e74\u524d\u304b\u3089 Observer \u304c\u5b9f\u88c5\u3055\u308c\u3066\u3044\u307e\u3057\u305f\u3002\n\n----\n\n### Observer Pattern\n\n[Observer Pattern](http://www.techscore.com/tech/DesignPattern/Observer.html) \u306f *\u89b3\u5bdf\u5bfe\u8c61(Subject)* \u306e\u72b6\u614b\u306e\u5909\u5316\u3092 *\u89b3\u5bdf\u8005(Observer)* \u306b\u901a\u77e5\u3092\u3059\u308b\u4ed5\u7d44\u307f\u3067\u3059\u3002\n*Observer Pattern* \u306e\u5225\u540d\u306f *Dependents* \u3084 *Publish-Subscribe* \u3068\u547c\u3070\u308c\u307e\u3059\u3002\n\n![observer](https://dl.dropboxusercontent.com/u/14690051/images/notes/lang/framework/dmvc/observer.png)\n\n```PlantUML\n@startuml\n\nclass Observer {\n  +update()\n}\n\nclass ConcreteObserver {\n  +update()\n}\n\nclass Subject {\n  state\n  observers\n  +addObserver(observer)\n  +notifyObservers()\n  +getState()\n}\n\nclass ConcreteSubject {\n  +action()\n}\n\nObserver <|.. ConcreteObserver\nSubject <|-- ConcreteSubject\nObserver <-o Subject\n\n@enduml\n```\n\n----\n\n## GUI-MVC\n\nGUI-MVC \u306f `C -> M -> V` \u3068 Flow \u304c\u4e00\u65b9\u5411\u3067\u3059\u3002 *Observer Pattern* \u3067\u5b9f\u88c5\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n\n* Controller \u304c Model \u306e\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u5b9f\u884c\u3057\u3066 Model \u3092\u66f4\u65b0\u3057\u307e\u3059\u3002\n* Model \u306f \u72b6\u614b\u306e\u5909\u66f4\u3092 View \u306b\u901a\u77e5\u3057\u307e\u3059\u3002\n* View \u306f\u30e2\u30c7\u30eb\u306e\u72b6\u614b\u3092\u53d6\u5f97\u3057\u3066\u518d\u8868\u793a\u3057\u307e\u3059\u3002\n\n![mvc1](https://dl.dropboxusercontent.com/u/14690051/images/notes/lang/framework/dmvc/mvc1.png)\n\n```PlantUML\n@startuml\n\npackage \"GUI-MVC\" {\n  boundary View\n  control Controller\n  entity Model\n\n  [Browser] ...> Controller : 1.Key Down\n\n  Controller ...> Model : 2.Update\n  View ...> Model : 4.Get Data\n  View <... Model : 3.Notify\n\n  [Browser] <... View : 5.Display\n}\n\n@enduml\n```\n\n----\n\n### CounterView\n\n\u3053\u308c\u304b\u3089 [Redux \u306e\u30b5\u30f3\u30d7\u30eb](https://github.com/reactjs/redux/tree/master/examples/counter)\u306b\u3082\u3042\u308b\u30ab\u30a6\u30f3\u30bf\u30fc\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\u30e6\u30fc\u30b6\u306e\u5165\u529b\u3067\u6570\u5024\u306e\u5897\u52a0\u3084\u6e1b\u5c11\u3092\u8868\u793a\u3059\u308b\u30b7\u30f3\u30d7\u30eb\u306a\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3067\u3059\u3002\n\nCounterView \u306f Smalltalk \u306e MVC \u3092\u64ec\u4f3c\u7684\u306b JavaScript \u3067\u5b9f\u88c5\u3057\u307e\u3057\u305f\u3002\nSmalltalk \u306e\u5f8c\u7d99\u306e Squeak \u306e[\u30b5\u30f3\u30d7\u30eb\u30b3\u30fc\u30c9](https://www.ogis-ri.co.jp/otc/hiroba/technical/Squeak5/index.html)\u3092\u53c2\u8003\u306b\u3057\u3066\u3044\u307e\u3059\u3002\n\n----\n\n#### Example\n\n* [Frontend Boilerplate](https://github.com/tj/frontend-boilerplate) \u3092\u5229\u7528\u3059\u308b\u304b\u500b\u5225\u306b\u30e9\u30a4\u30d6\u30e9\u30ea\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3092\u3057\u3066\u74b0\u5883\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n```bash\n$ mkdir react-counter-view-example\n$ cd react-counter-view-example\n$ npm init --force\n$ npm install webpack webpack-dev-server --save-dev\n$ npm install babel-core babel-loader --save-dev\n$ npm install babel-preset-react babel-preset-es2015 --save-dev\n$ npm install react react-hot-loader react-dom --save-dev\n```\n\n```bash\n$ tree\n.\n\u251c\u2500\u2500 app\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 controllers\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2514\u2500\u2500 CounterKeyboardController.js\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 models\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 Counter.js\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2514\u2500\u2500 Subject.js\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 views\n\u2502\u00a0\u00a0 \u2502   \u2514\u2500\u2500 CounterTextView.js\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 index.js\n\u251c\u2500\u2500 .babelrc\n\u251c\u2500\u2500 index.html\n\u251c\u2500\u2500 package.json\n\u2514\u2500\u2500 webpack.config.js\n```\n\n----\n\n#### Model\n\n##### Subject\n\n* Subject \u30af\u30e9\u30b9\u306b\u306f\u72b6\u614b\u3068 Observer \u306e\u30ea\u30b9\u30c8\u304c\u4fdd\u6301\u3055\u308c\u307e\u3059\u3002\n* Observer \u3092\u8ffd\u52a0\u3059\u308b\u30e1\u30bd\u30c3\u30c9\u3068\u901a\u77e5\u3059\u308b\u30e1\u30bd\u30c3\u30c9\u304c\u5b9f\u88c5\u3055\u308c\u307e\u3059\u3002\n* \u72b6\u614b\u3092\u53d6\u5f97\u3059\u308b\u30e1\u30bd\u30c3\u30c9\u304c\u5b9f\u88c5\u3055\u308c\u307e\u3059\u3002\n\n(\u7c21\u6613\u306a Flux \u3067\u3059\u304c [Redux \u306e\u30b3\u30fc\u30c9](https://github.com/reactjs/redux/blob/master/src/createStore.js)\u3092\u53c2\u8003\u306b\u3057\u3066\u3044\u307e\u3059\u3002)\n\n```app/models/Subject.js\nclass Subject {\n  constructor() {\n    this.state = undefined\n    this.observers = []\n  }\n\n  addObserver(observer) {\n    this.observers.push(observer)\n  }\n\n  notifyObservers() {\n    this.observers.forEach(observer => observer())\n  }\n\n  getState() {\n    return this.state\n  }\n}\n\nexport default Subject\n```\n\n----\n\n##### ConcreteSubject\n\n* Subject \u30af\u30e9\u30b9\u3092\u7d99\u627f\u3057\u3066\u3001ConcreteSubject \u30af\u30e9\u30b9\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n* Counter \u30af\u30e9\u30b9\u306b Model \u306e\u72b6\u614b\u3092\u5909\u66f4\u3059\u308b action \u30e1\u30bd\u30c3\u30c9\u304c\u5b9f\u88c5\u3055\u308c\u307e\u3059\u3002\n\n```app/models/Counter.js\nimport Subject from './Subject'\n\nclass Counter extends Subject {\n  constructor() {\n    super()\n    this.state = 0\n  }\n\n  action(type) {\n    switch (type) {\n    case 'increase':\n      this.state += 1\n      break\n    case 'decrease':\n      this.state -= 1\n      break\n    }\n\n    this.notifyObservers()\n  }\n}\n\nexport default Counter\n```\n\n----\n\n#### Controller\n\n* \u30ad\u30fc\u306e\u5165\u529b\u3068 Model \u306e\u30a2\u30af\u30b7\u30e7\u30f3\u3092\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n* u(up)\u306e\u30ad\u30fc\u3067\u5897\u52a0\u3057\u3066\u3001d(down)\u306e\u30ad\u30fc\u3067\u6e1b\u5c11\u3059\u308b\u4ed5\u69d8\u3067\u3059\u3002\n\n```app/controllers/CounterKeyboardController.js\nexport default function CounterKeyboardController(model) {\n  return {\n    u: () => model.action('increase'),\n    d: () => model.action('decrease')\n  }\n}\n```\n\n----\n\n#### View\n\n* React \u306e Component \u30af\u30e9\u30b9\u3092\u7d99\u627f\u3057\u3066\u3001ConcreteObserver \u30af\u30e9\u30b9\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n* componentDidMount \u30e1\u30bd\u30c3\u30c9\u3067\u3001\u30ad\u30fc\u306e\u5165\u529b\u3068 Controller \u3092\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n* render \u30e1\u30bd\u30c3\u30c9\u3067\u3001\u8868\u793a\u3092\u3059\u308b\u8981\u7d20\u306e\u69cb\u6210\u3092\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\n```app/views/CounterTextView.js\nimport React, { Component } from 'react'\n\nclass CounterTextView extends Component {\n  componentDidMount() {\n    window.document.addEventListener(\n      'keydown',\n      this.handleKeyDown.bind(this)\n    )\n  }\n\n  handleKeyDown(e) {\n    this.props.controller[e.key]()\n  }\n\n  render() {\n    return (\n      <div>\n        <h1>Counter</h1>\n        <p>Key Downed: {this.props.count} times</p>\n        <div>Increase in the key of u (up)</div>\n        <div>Decrease in the key of d (down)</div>\n      </div>\n    )\n  }\n}\n\nexport default CounterTextView\n```\n\n----\n\n#### Container\n\n* MVC \u3092\u7d50\u3073\u3064\u3051\u307e\u3059\u3002Model \u3092 Controller \u306b\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n* View \u306b Controller \u3068 Model \u306e\u72b6\u614b\u306e\u53d6\u5f97\u3092\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n* View \u3092 Observer \u306b\u8ffd\u52a0\u3057\u307e\u3059\u3002\n\n```app/index.js\nimport React from 'react'\nimport ReactDOM from 'react-dom'\nimport Counter from './models/Counter'\nimport CounterTextView from './views/CounterTextView'\nimport CounterKeyboardController from './controllers/CounterKeyboardController'\n\nconst model = new Counter()\nconst controller = CounterKeyboardController(model)\n\nfunction render() {\n  ReactDOM.render(\n    <CounterTextView\n      controller={controller}\n      count={model.getState()}\n    />,\n    document.getElementById('root')\n  )\n}\n\nrender()\nmodel.addObserver(render)\n```\n\n----\n\n#### Demo\n\n![counter_view](https://dl.dropboxusercontent.com/u/14690051/images/notes/lang/framework/dmvc/counter_view.png)\n\n\u30b5\u30f3\u30d7\u30eb\u3067\u5206\u304b\u308b\u3088\u3046\u306b MVC \u306f Model, View, Controller \u304c\u758e\u7d50\u5408\u306b\u306a\u308a\u3001\u8cac\u52d9\u306e\u5206\u96e2\u304c\u5b9f\u73fe\u3067\u304d\u307e\u3059\u3002\n\n----\n\n## Web-MVC\n\nWeb \u306e MVC \u3082\u60c5\u5831(Model), \u8868\u73fe\u65b9\u6cd5(View), \u5236\u5fa1(Controller)\u306e3\u3064\u306b\u8cac\u52d9\u3092\u5206\u96e2\u3059\u308b\u8a2d\u8a08\u65b9\u91dd\u3067\u3059\u3002\n\u3057\u304b\u3057\u3001GUI \u3068 Web \u306f\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u30c9\u30e1\u30a4\u30f3\u304c\u9055\u3046\u306e\u3067 MVC \u306e\u5f79\u5272\u306f\u540c\u3058\u3067\u306f\u3042\u308a\u307e\u305b\u3093\u3002\n\u3082\u3061\u308d\u3093 Model \u3068 View \u306b *Observer Pattern* \u306f\u5b9f\u88c5\u3055\u308c\u3066\u3044\u307e\u305b\u3093\u3002\n\nWeb-MVC \u306f `C -> M -> C -> V -> C` \u3068 Flow \u306b Controller \u304c\u4f55\u5ea6\u3082\u767b\u5834\u3057\u307e\u3059\u3002\n\n* Controller \u304c Request \u3092\u53d7\u3051\u3066 Model \u3092\u64cd\u4f5c\u3057\u3066\u30c7\u30fc\u30bf\u3092\u53d6\u5f97\u3057\u307e\u3059\u3002\n* Controller \u304c View \u306b Model \u306e\u30c7\u30fc\u30bf\u3092\u30bb\u30c3\u30c8\u3057\u3066\u3001\u30b3\u30f3\u30c6\u30f3\u30c4\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n* Controller \u304c Response \u3092\u8fd4\u3057\u307e\u3059\u3002\n\n![mvc2](https://dl.dropboxusercontent.com/u/14690051/images/notes/lang/framework/dmvc/mvc2.png)\n\n```PlantUML\n@startuml\n\npackage \"Web-MVC\" {\n  boundary View\n  control Controller\n  entity Model\n\n  [Browser] <... Controller : 6.Response\n  [Browser] ...> Controller : 1.Request\n\n  Controller ...> Model : 2.Get Data\n  Controller ...> Model : 3.Set Data\n\n  Controller <... View : 5.Render\n  Controller ...> View : 4.Set Data\n}\n\n@enduml\n```\n\n----\n\n### CounterViewApi\n\nCounterViewApi \u306f Ruby on Rails \u306e [API only apps](http://edgeguides.rubyonrails.org/5_0_release_notes.html#api-applications) \u3092\u5229\u7528\u3057\u3066\u5b9f\u88c5\u3057\u307e\u3057\u305f\u3002\nCounterView \u3068\u540c\u3058\u304f\u30ab\u30a6\u30f3\u30bf\u30fc\u306e\u30b7\u30f3\u30d7\u30eb\u306a\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3067\u3059\u3002\n\n* `rails new` \u30b3\u30de\u30f3\u30c9\u306b `--api` \u30aa\u30d7\u30b7\u30e7\u30f3\u3067 API \u3060\u3051\u306e Web \u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u304c\u4f5c\u6210\u3067\u304d\u307e\u3059\u3002\n* `rails generate scaffold` \u30b3\u30de\u30f3\u30c9\u3067 counter \u306e MVC \u304c\u4f5c\u6210\u3067\u304d\u307e\u3059\u3002\n\n----\n\n#### Example\n\n```bash\n$ rails new counter-view-api --api\n$ mv counter-view-api rails-counter-view-example\n$ cd rails-counter-view-example\n$ edit Gemfile\n$ rails generate scaffold counter state:integer\n```\n\n```bash\n$ tree\n.\n\u251c\u2500\u2500 app\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 controllers\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 application_controller.rb\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2514\u2500\u2500 counters_controller.rb\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 models\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 application_record.rb\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2514\u2500\u2500 counter.rb\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 views\n\u2502\u00a0\u00a0     \u2514\u2500\u2500 counters\n\u2502\u00a0\u00a0       \u00a0\u00a0  \u2514\u2500\u2500 show.json.jbuilder\n\u251c\u2500\u2500 bin\n\u251c\u2500\u2500 config\n\u251c\u2500\u2500 db\n\u251c\u2500\u2500 lib\n\u251c\u2500\u2500 public\n\u251c\u2500\u2500 config.ru\n\u251c\u2500\u2500 Gemfile\n\u2514\u2500\u2500 Rakefile\n```\n\n----\n\n#### Model\n\n* ApplicationRecord \u30af\u30e9\u30b9\u3092\u7d99\u627f\u3057\u3066\u3001Counter \u30af\u30e9\u30b9\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n* \u30ab\u30f3\u30bf\u30fc\u306e\u72b6\u614b\u3092\u4fdd\u6301\u3057\u3001\u5897\u52a0\u3068\u6e1b\u5c11\u306e\u30e1\u30bd\u30c3\u30c9\u3092\u5b9f\u88c5\u3057\u307e\u3059\u3002\n\n```app/models/counter.rb\nclass Counter < ApplicationRecord\n  def initialize\n    super\n    self.state = 0\n  end\n\n  def increase\n    self.state = self.state + 1\n  end\n\n  def decrease\n    self.state = self.state - 1\n  end\nend\n```\n\n----\n\n#### Controller\n\n* ApplicationController \u30af\u30e9\u30b9\u3092\u7d99\u627f\u3057\u3066\u3001CounterController \u30af\u30e9\u30b9\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n* \u30ab\u30f3\u30bf\u30fc\u306e\u72b6\u614b\u3092\u8868\u793a\u3059\u308b\u30e1\u30bd\u30c3\u30c9\u3068\u5897\u52a0\u3068\u6e1b\u5c11\u306e\u30e1\u30bd\u30c3\u30c9\u3092\u5b9f\u88c5\u3057\u307e\u3059\u3002\n\n(Rails \u306f Controller \u306e\u30e1\u30bd\u30c3\u30c9\u3092\u30a2\u30af\u30b7\u30e7\u30f3\u3068\u547c\u3073\u307e\u3059\u3002)\n\n```app/controllers/counters_controller.rb\nclass CountersController < ApplicationController\n  before_action :set_counter\n\n  def show\n  end\n\n  def create\n    @counter.increase\n    @counter.save!\n  end\n\n  def destroy\n    @counter.decrease\n    @counter.save!\n  end\n\n  private\n    def set_counter\n      @counter = Counter.last || Counter.new\n    end\nend\n```\n\n----\n\n#### View\n\n* Model \u306e\u30c7\u30fc\u30bf\u3092 View \u306e\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u306b\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\n```app/views/counters/show.json.jbuilder\njson.extract! @counter, :state\n```\n\n----\n\n#### Router\n\n* URL \u306e \u30eb\u30fc\u30c6\u30a3\u30f3\u30b0 \u3092\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n* \u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u30fc\u3068\u30a2\u30af\u30b7\u30e7\u30f3\u3092\u7d50\u3073\u3064\u3051\u307e\u3059\u3002\n\n```config/routes.rb\nRails.application.routes.draw do\n  resource :counter, only: [:show, :create, :destroy]\nend\n```\n\n----\n\n#### Demo\n\n* \u30ab\u30a6\u30f3\u30bf\u30fc\u3092\u8868\u793a\u3059\u308b `curl` \u306e\u30b3\u30de\u30f3\u30c9\u3067\u3059\u3002\n\n```bash\n$ curl -X GET http://localhost:3000/counter\n{\"state\":8}\n```\n\n* \u30ab\u30a6\u30f3\u30bf\u30fc\u3092\u5897\u52a0\u3059\u308b\u30b3\u30de\u30f3\u30c9\u3067\u3059\u3002\n\n```bash\n$ curl -X POST http://localhost:3000/counter\n```\n\n* \u30ab\u30a6\u30f3\u30bf\u30fc\u3092\u6e1b\u5c11\u3059\u308b\u30b3\u30de\u30f3\u30c9\u3067\u3059\u3002\n\n```bash\n$ curl -X DELETE http://localhost:3000/counter\n```\n\nREST API \u306a\u306e\u3067 \u30a8\u30f3\u30c9\u30dd\u30a4\u30f3\u30c8\u306f\u540c\u3058\u3067\u3082\u3001\u30e1\u30bd\u30c3\u30c9\u3067\u632f\u308b\u821e\u3044\u304c\u5909\u308f\u308a\u307e\u3059\u3002\n\n----\n\n## GUI-MVC\u3068Web-MVC\u306e\u63a5\u7d9a\n\nWeb \u3082 Web-browser \u3068 Web-server \u306e client-server(C/S) \u306a\u306e\u3067\u3059\u304c\nGUI-MVC(client) \u3068 Web-MVC(server) \u3092\u7d50\u3073\u3064\u3051\u3066\u30c7\u30fc\u30bf\u3092\u9023\u643a\u3057\u307e\u3059\u3002\n\nC/S \u306f \u30d7\u30ec\u30bc\u30f3\u30c6\u30fc\u30b7\u30e7\u30f3\u5c64(\u30e6\u30fc\u30b6\u30a4\u30f3\u30bf\u30fc\u30d5\u30a7\u30fc\u30b9)\u3001\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u5c64(\u30d3\u30b8\u30cd\u30b9\u30ed\u30b8\u30c3\u30af)\u3001\n\u30c7\u30fc\u30bf\u5c64(\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9) \u30673\u968e\u5c64\u30e2\u30c7\u30eb\u3068\u547c\u3070\u308c\u307e\u3059\u3002\n\n![cs](https://dl.dropboxusercontent.com/u/14690051/images/notes/lang/framework/dmvc/cs.png)\n\n```PlantUML\n@startuml\n\npackage \"GUI-MVC\" {\n  boundary View\n  control Controller\n  entity Model\n\n  [Browser] ...> Controller : 1.Key Down\n\n  Controller ...> Model : 2.Update\n  View ...> Model : 10.Get Data\n  View <... Model : 9.Notify\n\n  [Browser] <... View : 11.Display\n}\n\npackage \"Web-MVC\" {\n  boundary View2\n  control Controller2\n  entity Model2\n\n  Model <.. Controller2 : 8.Response\n  Model ..> Controller2 : 3.Request\n\n  Controller2 ...> Model2 : 5.Set Data\n  Controller2 ...> Model2 : 4.Get Data\n\n  Controller2 <... View2 : 7.Render\n  Controller2 ...> View2 : 6.Set Data\n}\n\n@enduml\n```\n\n----\n\n### GUI-MVC(client)\n\n* action \u30e1\u30bd\u30c3\u30c9\u306b [fetch](https://github.com/matthew-andrews/isomorphic-fetch) \u3067 CounterViewApi \u3068\u7d50\u3073\u3064\u3051\u307e\u3059\u3002\n\n----\n\n#### Model\n\n```app/models/Counter.js\nimport Subject from './Subject'\nimport fetch from 'isomorphic-fetch'\n\nconst endpoint = 'http://localhost:3000/counter'\n\nclass Counter extends Subject {\n  constructor() {\n    super()\n    this.state = 0\n  }\n\n  action(type) {\n    switch (type) {\n    case 'show':\n      fetch(endpoint, {headers: {accept: 'application/json'}})\n        .then(response => response.json())\n        .then(json => {\n          this.state = json.state\n          this.notifyObservers()\n        })\n      break\n    case 'increase':\n      fetch(endpoint, {method: 'post'})\n        .then(response => this.action('show'))\n      break\n    case 'decrease':\n      fetch(endpoint, {method: 'delete'})\n        .then(response => this.action('show'))\n      break\n    }\n  }\n}\n\nexport default Counter\n```\n\n----\n\n#### Container\n\n* View \u3092 Observer \u306b\u8ffd\u52a0\u3057\u305f\u5f8c\u306b\u3001\u8868\u793a\u306e\u30a2\u30af\u30b7\u30e7\u30f3\u3092\u5b9f\u65bd\u3057\u307e\u3059\u3002\n\n```app/index.js\nimport React from 'react'\nimport ReactDOM from 'react-dom'\nimport Counter from './models/Counter'\nimport CounterTextView from './views/CounterTextView'\nimport CounterKeyboardController from './controllers/CounterKeyboardController'\n\nconst model = new Counter()\nconst controller = CounterKeyboardController(model)\n\nfunction render() {\n  ReactDOM.render(\n    <CounterTextView\n      controller={controller}\n      count={model.getState()}\n    />,\n    document.getElementById('root')\n  )\n}\n\nrender()\nmodel.addObserver(render)\nmodel.action('show')\n```\n\n----\n\n### Web-MVC(server)\n\n* client \u304c `No Access-Control-Allow-Origin` \u3092\u8868\u793a\u3059\u308b\u306e\u3067 CORS \u306b\u5bfe\u5fdc\u3057\u307e\u3059\u3002\n* Rails 5 \u304b\u3089 `gem 'rack-cors'` \u304c\u6a19\u6e96\u3067\u8a2d\u5b9a\u3055\u308c\u3066\u3044\u308b\u306e\u3067 CORS \u306e\u5bfe\u5fdc\u304c\u7c21\u5358\u3067\u3059\u3002\n\n```config/initializers/cors.rb\nRails.application.config.middleware.insert_before 0, Rack::Cors do\n  allow do\n    origins 'localhost'\n\n    resource '*',\n      headers: :any,\n      methods: [:get, :post, :put, :patch, :delete, :options, :head]\n  end\nend\n```\n\n----\n\n### Demo\n\n![counter_view](https://dl.dropboxusercontent.com/u/14690051/images/notes/lang/framework/dmvc/counter_view.png)\n\n[\u30c9\u30e1\u30a4\u30f3\u99c6\u52d5\u8a2d\u8a08](http://www.shoeisha.co.jp/book/detail/9784798121963) \u3067\u306f *\u30ec\u30a4\u30e4\u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3* \u3067\u8cac\u52d9\u306b\u5fdc\u3058\u305f4\u3064\u306e\u5c64\u304c\u8aac\u660e\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n\u305d\u306e\u30d7\u30ec\u30bc\u30f3\u30c6\u30fc\u30b7\u30e7\u30f3\u5c64\u3068\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u5c64\u3067 MVC \u3092\u5229\u7528\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3057\u305f\u3002\n\n----\n\n## GUI-MVC\u3068Web-MVC\u306e\u4f9d\u5b58\n\nclient-server(C/S) \u306b\u3082 Observer Pattern \u3092\u5b9f\u88c5\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\nGUI-MVC(client) \u3068 Web-MVC(server) \u3092\u4f9d\u5b58\u3055\u305b\u3066\u72b6\u614b\u5909\u66f4\u3092\u901a\u77e5\u3057\u307e\u3059\u3002\n\n![pubsub](https://dl.dropboxusercontent.com/u/14690051/images/notes/lang/framework/dmvc/pubsub.png)\n\n```PlantUML\n@startuml\n\npackage \"GUI-MVC\" {\n  boundary View\n  control Controller\n  entity Model\n\n  [Browser] ...> Controller : 1.Key Down\n\n  Controller ...> Model : 2.Update\n  View ...> Model : 11.Get Data\n  View <... Model : 10.Notify\n\n  [Browser] <... View : 12.Display\n}\n\npackage \"Web-MVC\" {\n  boundary View2\n  control Controller2\n  entity Model2\n\n  Model <.. Controller2 : 8.Response\n  Model <.. Controller2 : 9.Notify\n  Model ..> Controller2 : 3.Request\n\n  Controller2 ...> Model2 : 5.Set Data\n  Controller2 ...> Model2 : 4.Get Data\n\n  Controller2 <... View2 : 7.Render\n  Controller2 ...> View2 : 6.Set Data\n}\n\n@enduml\n```\n\n----\n\n### GUI-MVC(subscribe)\n\n* [ActionCable(WebSocket)](https://www.npmjs.com/package/actioncable) \u3067 CounterViewApi \u3068\u7d50\u3073\u3064\u3051\u307e\u3059\u3002\n* Subscribe \u3092\u8ffd\u52a0\u3059\u308b\u30e1\u30bd\u30c3\u30c9\u304c\u5b9f\u88c5\u3055\u308c\u307e\u3059\u3002\n\n----\n\n#### Model\n\n```app/models/Counter.js\nimport Subject from './Subject'\nimport fetch from 'isomorphic-fetch'\nimport ActionCable from 'actioncable'\n\nconst endpoint = 'http://localhost:3000/counter'\nconst cable = ActionCable.createConsumer('ws://localhost:3000/cable')\n\nclass Counter extends Subject {\n  constructor() {\n    super()\n    this.state = 0\n  }\n\n  action(type) {\n    switch (type) {\n    case 'show':\n      fetch(endpoint, {headers: {accept: 'application/json'}})\n        .then(response => response.json())\n        .then(json => {\n          this.state = json.state\n          this.notifyObservers()\n        })\n      break\n    case 'increase':\n      fetch(endpoint, {method: 'post'})\n        .then(response => this.action('show'))\n      break\n    case 'decrease':\n      fetch(endpoint, {method: 'delete'})\n        .then(response => this.action('show'))\n      break\n    }\n  }\n\n  addSubscribe(channel) {\n    cable.subscriptions.create(\n      channel,\n      {\n        connected() {\n          this.handleShow()\n        },\n        received() {\n          this.handleShow()\n        },\n        handleShow: () => this.action('show')\n      }\n    )\n  }\n}\n\nexport default Counter\n```\n\n----\n\n#### Container\n\n* View \u3092 Observer \u306b\u8ffd\u52a0\u3057\u305f\u5f8c\u306b Subscribe \u3092\u8ffd\u52a0\u3057\u307e\u3059\u3002\n\n```app/index.js\nimport React from 'react'\nimport ReactDOM from 'react-dom'\nimport Counter from './models/Counter'\nimport CounterTextView from './views/CounterTextView'\nimport CounterKeyboardController from './controllers/CounterKeyboardController'\n\nconst model = new Counter()\nconst controller = CounterKeyboardController(model)\n\nfunction render() {\n  ReactDOM.render(\n    <CounterTextView\n      controller={controller}\n      count={model.getState()}\n    />,\n    document.getElementById('root')\n  )\n}\n\nrender()\nmodel.addObserver(render)\nmodel.addSubscribe('CounterChannel')\n```\n\n----\n\n### Web-MVC(publish)\n\n* Rails [Action Cable(WebSocket)](http://railsguides.jp/action_cable_overview.html) \u3067 CounterView \u3068\u7d50\u3073\u3064\u3051\u307e\u3059\u3002\n* `rails generate channel` \u30b3\u30de\u30f3\u30c9\u3067 counter \u306e ActionCable \u304c\u4f5c\u6210\u3067\u304d\u307e\u3059\u3002\n\n----\n\n#### Example\n\n```bash\n$ rails generate channel counter\n```\n\n```bash\n$ tree\n.\n\u251c\u2500\u2500 app\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 channels\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 application_cable\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 channel.rb\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2514\u2500\u2500 connection.rb\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2514\u2500\u2500 counter_channel.rb\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 controllers\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 models\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 views\n```\n\n----\n\n#### Channel\n\n* `subscribed` \u306b `counter` \u3092\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\n```app/channels/counter_channel.rb\nclass CounterChannel < ApplicationCable::Channel\n  def subscribed\n    stream_from 'counter'\n  end\n\n  def unsubscribed\n    # Any cleanup needed when channel is unsubscribed\n  end\nend\n```\n\n----\n\n#### Controller\n\n* \u72b6\u614b\u3092\u5909\u66f4\u3057\u305f\u5f8c\u306b `ActionCable.server.broadcast` \u3067 `counter` \u3092\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\n```app/controllers/counters_controller.rb\nclass CountersController < ApplicationController\n  before_action :set_counter\n\n  def show\n  end\n\n  def create\n    @counter.increase\n    @counter.save!\n    ActionCable.server.broadcast 'counter', nil\n  end\n\n  def destroy\n    @counter.decrease\n    @counter.save!\n    ActionCable.server.broadcast 'counter', nil\n  end\n\n  private\n    def set_counter\n      @counter = Counter.last || Counter.new\n    end\nend\n```\n\n* \u63a5\u7d9a\u3092\u8a31\u53ef\u3059\u308b \u30a8\u30f3\u30c9\u30dd\u30a4\u30f3\u30c8 \u3092\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\n```config/application.rb\nmodule CounterView\n  class Application < Rails::Application\n    config.api_only = true\n    config.action_cable.allowed_request_origins = ['http://localhost:4000']\n  end\nend\n```\n\n----\n\n#### Demo\n\n![counter_view](https://dl.dropboxusercontent.com/u/14690051/images/notes/lang/framework/dmvc/counter_view.png)\n\n![counter_view](https://dl.dropboxusercontent.com/u/14690051/images/notes/lang/framework/dmvc/counter_view.png)\n\n[\u5b9f\u8df5\u30c9\u30e1\u30a4\u30f3\u99c6\u52d5\u8a2d\u8a08](http://www.shoeisha.co.jp/book/detail/9784798131610) \u3067\u306f *\u30c9\u30e1\u30a4\u30f3\u30a4\u30d9\u30f3\u30c8* \u3067\u51fa\u7248-\u8cfc\u8aad\u578b\u30e2\u30c7\u30eb\u304c\u8aac\u660e\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n\u30e1\u30c3\u30bb\u30fc\u30b8\u30f3\u30b0\u30df\u30c9\u30eb\u30a6\u30a7\u30a2\u306b\u306f RabbitMQ \u306a\u3069\u306e AMQP \u3092\u5229\u7528\u3059\u308b\u3053\u3068\u3092\u52e7\u3081\u3089\u308c\u3066\u3044\u307e\u3059\u3002\n\n----\n\n## Async\n\n* Rails \u306f [Active Job](http://railsguides.jp/active_job_basics.html) \u3092\u5229\u7528\u3059\u308b\u3068 Publish \u3092\u975e\u540c\u671f\u306b\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n* `rails generate channel` \u30b3\u30de\u30f3\u30c9\u3067 counter \u306e ActionCable \u304c\u4f5c\u6210\u3067\u304d\u307e\u3059\u3002\n\n----\n\n### Example\n\n```bash\n$ rails generate job counter\n```\n\n```bash\n$ tree\n.\n\u251c\u2500\u2500 app\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 channels\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 controllers\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 jobs\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 application_job.rb\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2514\u2500\u2500 counter_job.rb\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 models\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 views\n```\n\n----\n\n#### Job\n\n* `ActionCable.server.broadcast` \u306e `counter` \u3092\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\n```app/jobs/counter_job.rb\nclass CounterJob < ApplicationJob\n  queue_as :default\n\n  def perform(*args)\n    ActionCable.server.broadcast 'counter', nil\n  end\nend\n```\n\n----\n\n#### Controller\n\n* \u72b6\u614b\u3092\u5909\u66f4\u3057\u305f\u5f8c\u306b `CounterJob.perform_later` \u3092\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\n```app/controllers/counters_controller.rb\nclass CountersController < ApplicationController\n  before_action :set_counter\n\n  def show\n  end\n\n  def create\n    @counter.increase\n    @counter.save!\n    CounterJob.perform_later\n  end\n\n  def destroy\n    @counter.decrease\n    @counter.save!\n    CounterJob.perform_later\n  end\n\n  private\n    def set_counter\n      @counter = Counter.last || Counter.new\n    end\nend\n```\n\n----\n\n### Demo\n\n![counter_view](https://dl.dropboxusercontent.com/u/14690051/images/notes/lang/framework/dmvc/counter_view.png)\n\nActive Job \u306f \u30df\u30c9\u30eb\u30a6\u30a7\u30a2\u306b Redis \u3092\u5229\u7528\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\n----\n\n## Redux\n\nRedux \u306f Flux \u306e\u6d41\u308c\u306a\u306e\u3067\u6700\u521d\u306b\u8aac\u660e\u3092\u3057\u305f GUI-MVC \u306e\u5f71\u97ff\u3092\u53d7\u3051\u3066\u3044\u307e\u3059\u3002\n\u3055\u3089\u306b Redux \u306f [CQRS](http://www.minato.tv/cqrs/cqrs_documents_jp.pdf) \u3084 [Event Sourcing](http://martinfowler.com/eaaDev/EventSourcing.html) \u306e\u5f71\u97ff\u3092\u53d7\u3051\u3066 [\u4e09\u539f\u5247](http://redux.js.org/docs/introduction/ThreePrinciples.html) \u306b\u53cd\u6620\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n\n![redux](https://dl.dropboxusercontent.com/u/14690051/images/notes/lang/framework/dmvc/redux.png)\n\n```PlantUML\n@startuml\n\npackage \"Redux\" {\n  boundary View\n  entity Store\n  control Action\n  control Reducer\n\n  [Browser] ..> Action\n\n  Action ..> Store\n  Store <.. Reducer\n  Store ..> Reducer\n  View <.. Store\n\n  [Browser] <.. View\n}\n\n@enduml\n```\n\n----\n\n*\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30bd\u30d5\u30c8\u30a6\u30a7\u30a2* \u306f\u8981\u6c42\u306b\u3088\u3063\u3066\u8907\u96d1\u306b\u306a\u308a\u307e\u3059\u3002\n\u305d\u306e\u8907\u96d1\u306b\u306f\u69d8\u3005\u306a\u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3\u3092\u99c6\u4f7f\u3057\u3066\u7acb\u3061\u5411\u304b\u3044\u307e\u3057\u3087\u3046\u3002\n", "tags": ["reactjs", "Rails", "mvc", "redux"]}