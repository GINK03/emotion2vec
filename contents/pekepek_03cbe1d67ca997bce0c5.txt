{"context": " More than 1 year has passed since last update.\u300cPrettyBacktrace \u3067\u30c7\u30d0\u30c3\u30b0\u3092\u697d\u306b\u3059\u308b\u300d\u3067\u7d39\u4ecb\u3057\u305f PrettyBacktrace \u3092\u53c2\u8003\u306b\u3057\u3066\u81ea\u5206\u3067\u3082\u30aa\u30ea\u30b8\u30ca\u30eb\u306e\u30d0\u30c3\u30af\u30c8\u30ec\u30fc\u30b9\u3092\u5b9f\u88c5\u3057\u3066\u307f\u307e\u3059\u3002\n\u3084\u308b\u3053\u3068\u306f\u3001\n1. TracePoint \u3067\u4f8b\u5916\u3092\u30c8\u30ec\u30fc\u30b9\u3059\u308b\n2. DebugInspector \u3067\u30d0\u30c3\u30af\u30c8\u30ec\u30fc\u30b9\u306e\u60c5\u5831\u3092\u53d6\u5f97\u3059\u308b\n3. \u30aa\u30ea\u30b8\u30ca\u30eb\u306e\u30d0\u30c3\u30af\u30c8\u30ec\u30fc\u30b9\u3092\u5b9f\u88c5\uff01\n\u3067\u3059\u3002\n\nTracePoint \u3067\u4f8b\u5916\u3092\u30c8\u30ec\u30fc\u30b9\u3059\u308b\nTracePoint \u306f\u3001\u6307\u5b9a\u3057\u305f\u30a4\u30d9\u30f3\u30c8\u3092\u30c8\u30ec\u30fc\u30b9\u3059\u308b\u305f\u3081\u306e\u6a5f\u80fd\u3092\u5099\u3048\u305f Ruby \u306e\u6a19\u6e96\u30e9\u30a4\u30d6\u30e9\u30ea\u3067\u3059\u3002\n\u6307\u5b9a\u3067\u304d\u308b\u30a4\u30d9\u30f3\u30c8\u306f\u30ea\u30d5\u30a1\u30ec\u30f3\u30b9\u3092\u898b\u308b\u3068\u308f\u304b\u308a\u307e\u3059\u304c\u3001\u4f8b\u3048\u3070\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u3059\u308b\u3068\u3001\u30e1\u30bd\u30c3\u30c9\u306e\u547c\u3073\u51fa\u3057\u3092\u30c8\u30ec\u30fc\u30b9\u3067\u304d\u307e\u3059\u3002\n\nsample.rb\nTracePoint.trace(:call) do |tp|\n  puts [tp.path, tp.lineno, tp.defined_class, tp.method_id, tp.event].join(', ')\nend\n\nclass HogeClass\n  def hoge\n  end\nend\n\nHogeClass.new.hoge\n\n\ncall \u3092\u5f15\u6570\u306b\u6e21\u3057\u3066\u3001trace \u3092\u547c\u3076\u3068\u3001ruby \u3067\u5b9a\u7fa9\u3055\u308c\u305f\u30e1\u30bd\u30c3\u30c9\u306e\u547c\u3073\u51fa\u3057\u3092\u30c8\u30ec\u30fc\u30b9\u3057\u307e\u3059\u3002\u5b9f\u884c\u3059\u308b\u3068\n$ ruby sample.rb\nsample.rb, 6, HogeClass, hoge, call\n\n\u300c\u5b9f\u884c\u30d5\u30a1\u30a4\u30eb\u306e\u30d1\u30b9\u3001\u547c\u3073\u51fa\u3055\u308c\u305f\u884c\u3001\u30e1\u30bd\u30c3\u30c9\u306e\u5b9a\u7fa9\u30af\u30e9\u30b9\u3001\u30e1\u30bd\u30c3\u30c9\u540d\u3001\u30c8\u30ec\u30fc\u30b9\u30a4\u30d9\u30f3\u30c8\u300d\u304c\u53d6\u308c\u3066\u3044\u308b\u306e\u304c\u5206\u304b\u308a\u307e\u3059\u3002\ntrace \u30e1\u30bd\u30c3\u30c9\u306f\u3001new \u3068 enable \u3067\u7f6e\u304d\u63db\u3048\u308b\u4e8b\u3082\u51fa\u6765\u307e\u3059\u3002\n\nsample.rb\ntrace = TracePoint.new(:call) {|tp|\n  puts [tp.path, tp.lineno, tp.defined_class, tp.method_id, tp.event].join(', ')\n}\n\ntrace.enable # NOTE \u4ee5\u964d trace \u304c\u6709\u52b9\u306b\u306a\u308b\n...\n\n\n\n\u4f8b\u5916\u3092\u30c8\u30ec\u30fc\u30b9\u3059\u308b\n\u305d\u3093\u306a TracePoint \u3067\u3001\u4eca\u56de\u306e\u76ee\u7684\u3067\u3042\u308b\u4f8b\u5916\u3092\u30c8\u30ec\u30fc\u30b9\u3057\u307e\u3059\u3002\n\nsample.rb\nTracePoint.trace(:raise) do |tp|\n  puts [tp.path, tp.lineno, tp.defined_class, tp.method_id, tp.raised_exception].join(', ')\nend\n\nclass HogeClass\n  def hoge\n    not_defined\n  end\nend\n\nHogeClass.new.hoge\n\n\n$ ruby sample.rb\nsample.rb, 7, HogeClass, hoge, undefined local variable or method `not_defined' for #<HogeClass:0x007ffbfa1a1a00>\nsample.rb:7:in `hoge': undefined local variable or method `not_defined' for #<HogeClass:0x007ffbfa1a1a00> (NameError)\n    from sample.rb:11:in `<main>'\n\n\u6700\u521d\u306e\u884c\u306f puts \u3057\u305f\u5185\u5bb9\u3002\u5f8c\u534a\u306e\u884c\u306f ruby \u304c\u81ea\u52d5\u7684\u306b\u51fa\u529b\u3059\u308b\u30a8\u30e9\u30fc\u30ed\u30b0\u3067\u3059\u3002\n\u65e2\u306b\u4f3c\u305f\u3088\u3046\u306a\u5185\u5bb9\u304c\u51fa\u529b\u3055\u308c\u3066\u3044\u307e\u3059\u306d\u3002\n\ndebug_inspector\nPrettyBacktrace \u306e\u4e2d\u8eab\u3092\u898b\u308b\u3068 debug_inspector \u3092\u4f7f\u3063\u3066\u3044\u308b\u306e\u304c\u5206\u304b\u308a\u307e\u3059\u3002\u3053\u308c\u3082\u3001Sasada \u3055\u3093\u304c\u4f5c\u3063\u3066\u3044\u308b\u3093\u3067\u3059\u306d\u3002\u30c7\u30d0\u30c3\u30b0\u7528\u306b\u4f5c\u3089\u308c\u3066\u3044\u3066\u3001\u30c7\u30d0\u30c3\u30b0\u4ee5\u5916\u306b\u4f7f\u3046\u306a\u3068\u66f8\u3044\u3066\u3042\u308a\u307e\u3059\u3002\n\n\u4f55\u3092\u3059\u308b Gem\uff1f\n\u898b\u3066\u3044\u308b\u3068\u3001\u30b9\u30bf\u30c3\u30af\u30d5\u30ec\u30fc\u30e0\u306e\u60c5\u5831\u3092\u53d6\u308a\u51fa\u3059\u305f\u3081\u306e\u30e9\u30a4\u30d6\u30e9\u30ea\u306e\u3088\u3046\u3067\u3059\u3002\u8a66\u3057\u306b\u3001\u5148\u307b\u3069\u306e hoge \u3092\u5b9f\u884c\u3057\u305f\u969b\u306e\u30b9\u30bf\u30c3\u30af\u30d5\u30ec\u30fc\u30e0\u3092\u51fa\u529b\u3057\u3066\u307f\u307e\u3059\u3002\n\nsample.rb\nrequire 'debug_inspector'\n\nTracePoint.trace(:raise) do |tp|\n  RubyVM::DebugInspector.open {|dc|\n    locs = dc.backtrace_locations\n\n    locs.each do |loc|\n      puts [loc, loc.path, loc.lineno].join(', ')\n    end\n  }\nend\n\nclass HogeClass\n  def hoge\n    not_defined\n  end\nend\n\nHogeClass.new.hoge\n\n\ndc.backtrace_locations \u3067 Thread::Backtrace::Location \u306e\u914d\u5217\u304c\u53d6\u5f97\u51fa\u6765\u307e\u3059\u3002Thread::Backtrace::Location \u306f\u4f8b\u5916\u767a\u751f\u6642\u306b\u4f5c\u6210\u3055\u308c\u308b\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3067\u3001\u30d0\u30c3\u30af\u30c8\u30ec\u30fc\u30b9\u306e\u60c5\u5831\u3092\u53d6\u5f97\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\u30e1\u30bd\u30c3\u30c9\u306a\u3069\u306f\u3001\u30ea\u30d5\u30a1\u30ec\u30f3\u30b9\u3092\u53c2\u7167\u3057\u3066\u4e0b\u3055\u3044\u3002\n\u5b9f\u884c\u3057\u3066\u307f\u308b\u3068\n$ ruby sample.rb\nsample.rb:4:in `open', sample.rb, 4\nsample.rb:4:in `block in <main>', sample.rb, 4\nsample.rb:15:in `hoge', sample.rb, 15\nsample.rb:19:in `<main>', sample.rb, 19\nsample.rb:15:in `hoge': undefined local variable or method `not_defined' for #<HogeClass:0x007f9bd287c808> (NameError)\n    from sample.rb:19:in `<main>'\n\n\u304a\u30fc\uff01\u30d5\u30ec\u30fc\u30e0\u306e\u60c5\u5831\u304c\u51fa\u529b\u3055\u308c\u3066\u3044\u307e\u3059\u3002\uff08\u6700\u5f8c\u306e 2 \u884c\u306f Ruby \u304c\u52dd\u624b\u306b\u51fa\u529b\u3059\u308b\u30d0\u30c3\u30af\u30c8\u30ec\u30fc\u30b9\u3067\u3059\uff09\n\n\u8a66\u3057\u306b\u81ea\u5206\u3067\u30d0\u30c3\u30af\u30c8\u30ec\u30fc\u30b9\u3092\u51fa\u529b\u3055\u305b\u308b\n\u81ea\u52d5\u3067\u51fa\u308b\u30d0\u30c3\u30af\u30c8\u30ec\u30fc\u30b9\u3092\u307e\u306d\u3066\u3001\u81ea\u5206\u3067\u3082\u51fa\u529b\u3055\u305b\u3066\u307f\u307e\u3059\u3002\n\nsample.rb\nrequire 'debug_inspector'\n\nTracePoint.trace(:raise) do |tp|\n  RubyVM::DebugInspector.open {|dc|\n    locs = dc.backtrace_locations\n\n    message = locs[2, locs.length].map.with_index {|loc, i|\n      if i.zero?\n        \"#{loc}: #{tp.raised_exception} (#{tp.raised_exception.class})\"\n      else\n        \"\\tfrom #{loc}\"\n      end\n    }.join(\"\\n\")\n\n    puts message\n  }\nend\n\nclass HogeClass\n  def hoge\n    not_defined\n  end\nend\n\nHogeClass.new.hoge\n\n\n$ ruby sample.rb\nsample.rb:21:in `hoge': undefined local variable or method `not_defined' for #<HogeClass:0x007fd86a07b558> (NameError)\n    from sample.rb:25:in `<main>'\nsample.rb:21:in `hoge': undefined local variable or method `not_defined' for #<HogeClass:0x007fd86a07b558> (NameError)\n    from sample.rb:25:in `<main>'\n\n\u4e0a\u304c\u81ea\u5206\u3067\u51fa\u529b\u3057\u3066\u3044\u308b\u3001\u4e0b\u304c\u81ea\u52d5\u3067\u51fa\u529b\u3055\u308c\u308b\u30d0\u30c3\u30af\u30c8\u30ec\u30fc\u30b9\u3002\u3060\u3044\u3076\u7121\u7406\u77e2\u7406\u3060\u3051\u3069\u3067\u304d\u305f\uff01\uff01\n\nset_backtrace\n\n\u3053\u306e\u307e\u307e\u3060\u3068\u3001\u4e8c\u3064\u30a8\u30e9\u30fc\u30e1\u30c3\u30bb\u30fc\u30b8\u304c\u8868\u793a\u3055\u308c\u3066\u3057\u307e\u3063\u3066\u90aa\u9b54\u306a\u306e\u3067\u3001\u81ea\u5206\u3067\u4f5c\u6210\u3057\u305f\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u3001Ruby \u306e\u51fa\u529b\u3059\u308b\u30a8\u30e9\u30fc\u30e1\u30c3\u30bb\u30fc\u30b8\u3068\u3057\u3066\u30bb\u30c3\u30c8\u3057\u307e\u3059\u3002\n\u305d\u3053\u3067\u4f7f\u3046\u306e\u304c Exception#set_backtrace \u3067\u3059\u3002Exception#set_backtrace \u3092\u4f7f\u3048\u3070\u3001\u7121\u7406\u77e2\u7406 tp.raised_exception.class \u306a\u3069\u3092\u8ffd\u52a0\u3057\u306a\u304f\u3066\u826f\u304f\u306a\u308a\u307e\u3059\u3002\n\nsample.rb\nrequire 'debug_inspector'\n\nTracePoint.trace(:raise) do |tp|\n  RubyVM::DebugInspector.open {|dc|\n    locs = dc.backtrace_locations\n\n    message = locs[2, locs.length].map.with_index {|loc, i|\n      loc.to_s\n    }\n\n    tp.raised_exception.set_backtrace message\n  }\nend\n\nclass HogeClass\n  def hoge\n    not_defined\n  end\nend\n\nHogeClass.new.hoge\n\n\n$ ruby sample.rb\nsample.rb:17:in `hoge': undefined local variable or method `not_defined' for #<HogeClass:0x007fda22958ab8> (NameError)\n    from sample.rb:21:in `<main>'\n\n\u304b\u306a\u308a\u3059\u3063\u304d\u308a\u3057\u307e\u3057\u305f\u306d\u3002\n\n\u3084\u3063\u3068\u30aa\u30ea\u30b8\u30ca\u30eb\u306e\u30d0\u30c3\u30af\u30c8\u30ec\u30fc\u30b9\u3092\u5b9f\u88c5\n\u3057\u307e\u3059\uff01\uff08\u9577\u304b\u3063\u305f\u3002\u3002\u3002\uff09\n\u5909\u6570\u3068\u4e0d\u8981\u306a\uff08\u90aa\u9b54\u306a\uff09\u6587\u5b57\u5217\u3092\u51fa\u529b\u3059\u308b\u30a8\u30e9\u30fc\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u4f5c\u3063\u3066\u307f\u305f\u3044\u3068\u601d\u3044\u307e\u3059\u3002\n\u5b9f\u884c\u3059\u308b\u30e1\u30bd\u30c3\u30c9\u306f\u4ee5\u4e0b\u3067\u3059\u3002\n\nsample.rb\nclass HogeClass\n  def hoge(n)\n    str = \"hoge #{n}\"\n\n    if n > 0\n      hoge(n - 1)\n    else\n      not_defined\n    end\n  end\nend\n\nHogeClass.new.hoge(3)\n\n\n\u6a19\u6e96\u306e\u30a8\u30e9\u30fc\u30e1\u30c3\u30bb\u30fc\u30b8\u306f\u3053\u3093\u306a\u611f\u3058\u3002\nsample.rb:23:in `hoge': undefined local variable or method `not_defined' for #<HogeClass:0x007f960285b520> (NameError)\n    from sample.rb:21:in `hoge'\n    from sample.rb:21:in `hoge'\n    from sample.rb:21:in `hoge'\n    from sample.rb:28:in `<main>'\n\n\u3067\u306f\u3001\u5b9f\u88c5\u3057\u307e\u3059\u3002\n\u5909\u6570\u3092\u53d6\u308a\u51fa\u3059\u3068\u3053\u308d\u306f\u3001PrettyBacktrace \u3092\u53c2\u8003\u306b\u3057\u3066\u3001\u3001\u3001\n\nsample.rb\nrequire 'debug_inspector'\n\nTracePoint.trace(:raise) do |tp|\n  RubyVM::DebugInspector.open {|dc|\n    locs = dc.backtrace_locations\n\n    message = locs[2, locs.length].map.with_index(2) {|loc, i|\n        iseq = dc.frame_iseq(i)\n\n        variables = if iseq\n            binding_obj = dc.frame_binding(i)\n\n            iseq.to_a[10].inject({}){|variables, name|\n              begin\n                variables[name] = binding_obj.local_variable_get(name)\n              rescue NameError, TypeError\n              end\n              variables\n            }\n          else\n            {}\n          end\n\n        unnecessary_str = unless variables.empty?\n            variables.map {|k, v|\n              \"#{k} (\u30ce\uff40\u0414)\u30ce\u5f61 #{v}\"\n            }.join(' | (\uff9f\u2200\uff9f)\u4eba(\uff9f\u2200\uff9f) | ')\n          else\n            '(\u30fe\uff89\uff65\u2200\uff65`)\uff85\uff72\uff85\uff72'\n          end\n\n        \"#{loc} : #{unnecessary_str}\"\n      }\n\n    tp.raised_exception.set_backtrace message\n  }\nend\n\nclass HogeClass\n  def hoge(n)\n    str = \"hoge #{n}\"\n    if n > 0\n      hoge(n - 1)\n    else\n      not_defined\n    end\n  end\nend\n\nHogeClass.new.hoge(3)\n\n\n\u3067\u304d\u305f\u3002\n\u5b9f\u884c\u3057\u3066\u307f\u308b\u3068\n$ ruby sample.rb\nsample.rb:45:in `hoge' : n (\u30ce\uff40\u0414)\u30ce\u5f61 0 | (\uff9f\u2200\uff9f)\u4eba(\uff9f\u2200\uff9f) | str (\u30ce\uff40\u0414)\u30ce\u5f61 hoge 0: undefined local variable or method `not_defined' for #<HogeClass:0x007f98a1133490> (NameError)\n    from sample.rb:43:in `hoge' : n (\u30ce\uff40\u0414)\u30ce\u5f61 1 | (\uff9f\u2200\uff9f)\u4eba(\uff9f\u2200\uff9f) | str (\u30ce\uff40\u0414)\u30ce\u5f61 hoge 1\n    from sample.rb:43:in `hoge' : n (\u30ce\uff40\u0414)\u30ce\u5f61 2 | (\uff9f\u2200\uff9f)\u4eba(\uff9f\u2200\uff9f) | str (\u30ce\uff40\u0414)\u30ce\u5f61 hoge 2\n    from sample.rb:43:in `hoge' : n (\u30ce\uff40\u0414)\u30ce\u5f61 3 | (\uff9f\u2200\uff9f)\u4eba(\uff9f\u2200\uff9f) | str (\u30ce\uff40\u0414)\u30ce\u5f61 hoge 3\n    from sample.rb:50:in `<main>' : (\u30fe\uff89\uff65\u2200\uff65`)\uff85\uff72\uff85\uff72\n\n\u3067\u304d\u305f\uff01\uff01\n\u3046\u3093\u3046\u3093\u3001\u3044\u3044\u3067\u3059\u306d\u3002\n\u305d\u308c\u3067\u306f\u3001\u307f\u306a\u3055\u3093\u3082\u30d0\u30c3\u30af\u30c8\u30ec\u30fc\u30b9\u3092\u81ea\u4f5c\u3057\u3066\u3001\u7d20\u6575\u306a\u30c7\u30d0\u30c3\u30b0\u30e9\u30a4\u30d5\u3092\uff01\n[\u300cPrettyBacktrace \u3067\u30c7\u30d0\u30c3\u30b0\u3092\u697d\u306b\u3059\u308b\u300d](http://qiita.com/pekepek/items/8f01a1e76a57e119b74b)\u3067\u7d39\u4ecb\u3057\u305f [PrettyBacktrace](https://github.com/ko1/pretty_backtrace) \u3092\u53c2\u8003\u306b\u3057\u3066\u81ea\u5206\u3067\u3082\u30aa\u30ea\u30b8\u30ca\u30eb\u306e\u30d0\u30c3\u30af\u30c8\u30ec\u30fc\u30b9\u3092\u5b9f\u88c5\u3057\u3066\u307f\u307e\u3059\u3002\n\n\u3084\u308b\u3053\u3068\u306f\u3001\n1. TracePoint \u3067\u4f8b\u5916\u3092\u30c8\u30ec\u30fc\u30b9\u3059\u308b\n2. DebugInspector \u3067\u30d0\u30c3\u30af\u30c8\u30ec\u30fc\u30b9\u306e\u60c5\u5831\u3092\u53d6\u5f97\u3059\u308b\n3. \u30aa\u30ea\u30b8\u30ca\u30eb\u306e\u30d0\u30c3\u30af\u30c8\u30ec\u30fc\u30b9\u3092\u5b9f\u88c5\uff01\n\u3067\u3059\u3002\n\n# TracePoint \u3067\u4f8b\u5916\u3092\u30c8\u30ec\u30fc\u30b9\u3059\u308b\n\nTracePoint \u306f\u3001\u6307\u5b9a\u3057\u305f\u30a4\u30d9\u30f3\u30c8\u3092\u30c8\u30ec\u30fc\u30b9\u3059\u308b\u305f\u3081\u306e\u6a5f\u80fd\u3092\u5099\u3048\u305f Ruby \u306e\u6a19\u6e96\u30e9\u30a4\u30d6\u30e9\u30ea\u3067\u3059\u3002\n\u6307\u5b9a\u3067\u304d\u308b\u30a4\u30d9\u30f3\u30c8\u306f[\u30ea\u30d5\u30a1\u30ec\u30f3\u30b9](http://docs.ruby-lang.org/ja/2.0.0/method/TracePoint/s/new.html)\u3092\u898b\u308b\u3068\u308f\u304b\u308a\u307e\u3059\u304c\u3001\u4f8b\u3048\u3070\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u3059\u308b\u3068\u3001\u30e1\u30bd\u30c3\u30c9\u306e\u547c\u3073\u51fa\u3057\u3092\u30c8\u30ec\u30fc\u30b9\u3067\u304d\u307e\u3059\u3002\n\n```rb:sample.rb\nTracePoint.trace(:call) do |tp|\n  puts [tp.path, tp.lineno, tp.defined_class, tp.method_id, tp.event].join(', ')\nend\n\nclass HogeClass\n  def hoge\n  end\nend\n\nHogeClass.new.hoge\n```\n\n`call` \u3092\u5f15\u6570\u306b\u6e21\u3057\u3066\u3001`trace` \u3092\u547c\u3076\u3068\u3001ruby \u3067\u5b9a\u7fa9\u3055\u308c\u305f\u30e1\u30bd\u30c3\u30c9\u306e\u547c\u3073\u51fa\u3057\u3092\u30c8\u30ec\u30fc\u30b9\u3057\u307e\u3059\u3002\u5b9f\u884c\u3059\u308b\u3068\n\n```\n$ ruby sample.rb\nsample.rb, 6, HogeClass, hoge, call\n```\n\n\u300c\u5b9f\u884c\u30d5\u30a1\u30a4\u30eb\u306e\u30d1\u30b9\u3001\u547c\u3073\u51fa\u3055\u308c\u305f\u884c\u3001\u30e1\u30bd\u30c3\u30c9\u306e\u5b9a\u7fa9\u30af\u30e9\u30b9\u3001\u30e1\u30bd\u30c3\u30c9\u540d\u3001\u30c8\u30ec\u30fc\u30b9\u30a4\u30d9\u30f3\u30c8\u300d\u304c\u53d6\u308c\u3066\u3044\u308b\u306e\u304c\u5206\u304b\u308a\u307e\u3059\u3002\n\n`trace` \u30e1\u30bd\u30c3\u30c9\u306f\u3001`new` \u3068 `enable` \u3067\u7f6e\u304d\u63db\u3048\u308b\u4e8b\u3082\u51fa\u6765\u307e\u3059\u3002\n\n```rb:sample.rb\ntrace = TracePoint.new(:call) {|tp|\n  puts [tp.path, tp.lineno, tp.defined_class, tp.method_id, tp.event].join(', ')\n}\n\ntrace.enable # NOTE \u4ee5\u964d trace \u304c\u6709\u52b9\u306b\u306a\u308b\n...\n```\n\n## \u4f8b\u5916\u3092\u30c8\u30ec\u30fc\u30b9\u3059\u308b\n\n\u305d\u3093\u306a TracePoint \u3067\u3001\u4eca\u56de\u306e\u76ee\u7684\u3067\u3042\u308b\u4f8b\u5916\u3092\u30c8\u30ec\u30fc\u30b9\u3057\u307e\u3059\u3002\n\n```rb:sample.rb\nTracePoint.trace(:raise) do |tp|\n  puts [tp.path, tp.lineno, tp.defined_class, tp.method_id, tp.raised_exception].join(', ')\nend\n\nclass HogeClass\n  def hoge\n    not_defined\n  end\nend\n\nHogeClass.new.hoge\n```\n\n```\n$ ruby sample.rb\nsample.rb, 7, HogeClass, hoge, undefined local variable or method `not_defined' for #<HogeClass:0x007ffbfa1a1a00>\nsample.rb:7:in `hoge': undefined local variable or method `not_defined' for #<HogeClass:0x007ffbfa1a1a00> (NameError)\n\tfrom sample.rb:11:in `<main>'\n```\n\n\u6700\u521d\u306e\u884c\u306f `puts` \u3057\u305f\u5185\u5bb9\u3002\u5f8c\u534a\u306e\u884c\u306f ruby \u304c\u81ea\u52d5\u7684\u306b\u51fa\u529b\u3059\u308b\u30a8\u30e9\u30fc\u30ed\u30b0\u3067\u3059\u3002\n\u65e2\u306b\u4f3c\u305f\u3088\u3046\u306a\u5185\u5bb9\u304c\u51fa\u529b\u3055\u308c\u3066\u3044\u307e\u3059\u306d\u3002\n\n\n# debug_inspector\n\n`PrettyBacktrace` \u306e\u4e2d\u8eab\u3092\u898b\u308b\u3068 [debug_inspector](https://github.com/banister/debug_inspector) \u3092\u4f7f\u3063\u3066\u3044\u308b\u306e\u304c\u5206\u304b\u308a\u307e\u3059\u3002\u3053\u308c\u3082\u3001[Sasada \u3055\u3093](https://github.com/ko1)\u304c\u4f5c\u3063\u3066\u3044\u308b\u3093\u3067\u3059\u306d\u3002\u30c7\u30d0\u30c3\u30b0\u7528\u306b\u4f5c\u3089\u308c\u3066\u3044\u3066\u3001\u30c7\u30d0\u30c3\u30b0\u4ee5\u5916\u306b\u4f7f\u3046\u306a\u3068\u66f8\u3044\u3066\u3042\u308a\u307e\u3059\u3002\n\n## \u4f55\u3092\u3059\u308b Gem\uff1f\n\n\u898b\u3066\u3044\u308b\u3068\u3001\u30b9\u30bf\u30c3\u30af\u30d5\u30ec\u30fc\u30e0\u306e\u60c5\u5831\u3092\u53d6\u308a\u51fa\u3059\u305f\u3081\u306e\u30e9\u30a4\u30d6\u30e9\u30ea\u306e\u3088\u3046\u3067\u3059\u3002\u8a66\u3057\u306b\u3001\u5148\u307b\u3069\u306e `hoge` \u3092\u5b9f\u884c\u3057\u305f\u969b\u306e\u30b9\u30bf\u30c3\u30af\u30d5\u30ec\u30fc\u30e0\u3092\u51fa\u529b\u3057\u3066\u307f\u307e\u3059\u3002\n\n```rb:sample.rb\nrequire 'debug_inspector'\n\nTracePoint.trace(:raise) do |tp|\n  RubyVM::DebugInspector.open {|dc|\n    locs = dc.backtrace_locations\n\n    locs.each do |loc|\n      puts [loc, loc.path, loc.lineno].join(', ')\n    end\n  }\nend\n\nclass HogeClass\n  def hoge\n    not_defined\n  end\nend\n\nHogeClass.new.hoge\n```\n\n`dc.backtrace_locations` \u3067 `Thread::Backtrace::Location` \u306e\u914d\u5217\u304c\u53d6\u5f97\u51fa\u6765\u307e\u3059\u3002`Thread::Backtrace::Location` \u306f\u4f8b\u5916\u767a\u751f\u6642\u306b\u4f5c\u6210\u3055\u308c\u308b\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3067\u3001\u30d0\u30c3\u30af\u30c8\u30ec\u30fc\u30b9\u306e\u60c5\u5831\u3092\u53d6\u5f97\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\u30e1\u30bd\u30c3\u30c9\u306a\u3069\u306f\u3001[\u30ea\u30d5\u30a1\u30ec\u30f3\u30b9](http://docs.ruby-lang.org/ja/2.2.0/class/Thread=3a=3aBacktrace=3a=3aLocation.html)\u3092\u53c2\u7167\u3057\u3066\u4e0b\u3055\u3044\u3002\n\n\u5b9f\u884c\u3057\u3066\u307f\u308b\u3068\n\n```\n$ ruby sample.rb\nsample.rb:4:in `open', sample.rb, 4\nsample.rb:4:in `block in <main>', sample.rb, 4\nsample.rb:15:in `hoge', sample.rb, 15\nsample.rb:19:in `<main>', sample.rb, 19\nsample.rb:15:in `hoge': undefined local variable or method `not_defined' for #<HogeClass:0x007f9bd287c808> (NameError)\n\tfrom sample.rb:19:in `<main>'\n```\n\n\u304a\u30fc\uff01\u30d5\u30ec\u30fc\u30e0\u306e\u60c5\u5831\u304c\u51fa\u529b\u3055\u308c\u3066\u3044\u307e\u3059\u3002\uff08\u6700\u5f8c\u306e 2 \u884c\u306f Ruby \u304c\u52dd\u624b\u306b\u51fa\u529b\u3059\u308b\u30d0\u30c3\u30af\u30c8\u30ec\u30fc\u30b9\u3067\u3059\uff09\n\n## \u8a66\u3057\u306b\u81ea\u5206\u3067\u30d0\u30c3\u30af\u30c8\u30ec\u30fc\u30b9\u3092\u51fa\u529b\u3055\u305b\u308b\n\n\u81ea\u52d5\u3067\u51fa\u308b\u30d0\u30c3\u30af\u30c8\u30ec\u30fc\u30b9\u3092\u307e\u306d\u3066\u3001\u81ea\u5206\u3067\u3082\u51fa\u529b\u3055\u305b\u3066\u307f\u307e\u3059\u3002\n\n```rb:sample.rb\nrequire 'debug_inspector'\n\nTracePoint.trace(:raise) do |tp|\n  RubyVM::DebugInspector.open {|dc|\n    locs = dc.backtrace_locations\n\n    message = locs[2, locs.length].map.with_index {|loc, i|\n      if i.zero?\n        \"#{loc}: #{tp.raised_exception} (#{tp.raised_exception.class})\"\n      else\n        \"\\tfrom #{loc}\"\n      end\n    }.join(\"\\n\")\n\n    puts message\n  }\nend\n\nclass HogeClass\n  def hoge\n    not_defined\n  end\nend\n\nHogeClass.new.hoge\n```\n\n```\n$ ruby sample.rb\nsample.rb:21:in `hoge': undefined local variable or method `not_defined' for #<HogeClass:0x007fd86a07b558> (NameError)\n\tfrom sample.rb:25:in `<main>'\nsample.rb:21:in `hoge': undefined local variable or method `not_defined' for #<HogeClass:0x007fd86a07b558> (NameError)\n\tfrom sample.rb:25:in `<main>'\n```\n\n\u4e0a\u304c\u81ea\u5206\u3067\u51fa\u529b\u3057\u3066\u3044\u308b\u3001\u4e0b\u304c\u81ea\u52d5\u3067\u51fa\u529b\u3055\u308c\u308b\u30d0\u30c3\u30af\u30c8\u30ec\u30fc\u30b9\u3002\u3060\u3044\u3076\u7121\u7406\u77e2\u7406\u3060\u3051\u3069\u3067\u304d\u305f\uff01\uff01\n\n# `set_backtrace`\n\n\u3053\u306e\u307e\u307e\u3060\u3068\u3001\u4e8c\u3064\u30a8\u30e9\u30fc\u30e1\u30c3\u30bb\u30fc\u30b8\u304c\u8868\u793a\u3055\u308c\u3066\u3057\u307e\u3063\u3066\u90aa\u9b54\u306a\u306e\u3067\u3001\u81ea\u5206\u3067\u4f5c\u6210\u3057\u305f\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u3001Ruby \u306e\u51fa\u529b\u3059\u308b\u30a8\u30e9\u30fc\u30e1\u30c3\u30bb\u30fc\u30b8\u3068\u3057\u3066\u30bb\u30c3\u30c8\u3057\u307e\u3059\u3002\n\u305d\u3053\u3067\u4f7f\u3046\u306e\u304c `Exception#set_backtrace` \u3067\u3059\u3002`Exception#set_backtrace` \u3092\u4f7f\u3048\u3070\u3001\u7121\u7406\u77e2\u7406 `tp.raised_exception.class` \u306a\u3069\u3092\u8ffd\u52a0\u3057\u306a\u304f\u3066\u826f\u304f\u306a\u308a\u307e\u3059\u3002\n\n```rb:sample.rb\nrequire 'debug_inspector'\n\nTracePoint.trace(:raise) do |tp|\n  RubyVM::DebugInspector.open {|dc|\n    locs = dc.backtrace_locations\n\n    message = locs[2, locs.length].map.with_index {|loc, i|\n      loc.to_s\n    }\n\n    tp.raised_exception.set_backtrace message\n  }\nend\n\nclass HogeClass\n  def hoge\n    not_defined\n  end\nend\n\nHogeClass.new.hoge\n```\n\n```\n$ ruby sample.rb\nsample.rb:17:in `hoge': undefined local variable or method `not_defined' for #<HogeClass:0x007fda22958ab8> (NameError)\n\tfrom sample.rb:21:in `<main>'\n```\n\n\u304b\u306a\u308a\u3059\u3063\u304d\u308a\u3057\u307e\u3057\u305f\u306d\u3002\n\n\n# \u3084\u3063\u3068\u30aa\u30ea\u30b8\u30ca\u30eb\u306e\u30d0\u30c3\u30af\u30c8\u30ec\u30fc\u30b9\u3092\u5b9f\u88c5\n\n\u3057\u307e\u3059\uff01\uff08\u9577\u304b\u3063\u305f\u3002\u3002\u3002\uff09\n\u5909\u6570\u3068\u4e0d\u8981\u306a\uff08\u90aa\u9b54\u306a\uff09\u6587\u5b57\u5217\u3092\u51fa\u529b\u3059\u308b\u30a8\u30e9\u30fc\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u4f5c\u3063\u3066\u307f\u305f\u3044\u3068\u601d\u3044\u307e\u3059\u3002\n\n\u5b9f\u884c\u3059\u308b\u30e1\u30bd\u30c3\u30c9\u306f\u4ee5\u4e0b\u3067\u3059\u3002\n\n```rb:sample.rb\nclass HogeClass\n  def hoge(n)\n    str = \"hoge #{n}\"\n\n    if n > 0\n      hoge(n - 1)\n    else\n      not_defined\n    end\n  end\nend\n\nHogeClass.new.hoge(3)\n```\n\n\u6a19\u6e96\u306e\u30a8\u30e9\u30fc\u30e1\u30c3\u30bb\u30fc\u30b8\u306f\u3053\u3093\u306a\u611f\u3058\u3002\n\n```\nsample.rb:23:in `hoge': undefined local variable or method `not_defined' for #<HogeClass:0x007f960285b520> (NameError)\n\tfrom sample.rb:21:in `hoge'\n\tfrom sample.rb:21:in `hoge'\n\tfrom sample.rb:21:in `hoge'\n\tfrom sample.rb:28:in `<main>'\n```\n\n\u3067\u306f\u3001\u5b9f\u88c5\u3057\u307e\u3059\u3002\n\u5909\u6570\u3092\u53d6\u308a\u51fa\u3059\u3068\u3053\u308d\u306f\u3001PrettyBacktrace \u3092\u53c2\u8003\u306b\u3057\u3066\u3001\u3001\u3001\n\n```rb:sample.rb\nrequire 'debug_inspector'\n\nTracePoint.trace(:raise) do |tp|\n  RubyVM::DebugInspector.open {|dc|\n    locs = dc.backtrace_locations\n\n    message = locs[2, locs.length].map.with_index(2) {|loc, i|\n        iseq = dc.frame_iseq(i)\n\n        variables = if iseq\n            binding_obj = dc.frame_binding(i)\n\n            iseq.to_a[10].inject({}){|variables, name|\n              begin\n                variables[name] = binding_obj.local_variable_get(name)\n              rescue NameError, TypeError\n              end\n              variables\n            }\n          else\n            {}\n          end\n\n        unnecessary_str = unless variables.empty?\n            variables.map {|k, v|\n              \"#{k} (\u30ce\uff40\u0414)\u30ce\u5f61 #{v}\"\n            }.join(' | (\uff9f\u2200\uff9f)\u4eba(\uff9f\u2200\uff9f) | ')\n          else\n            '(\u30fe\uff89\uff65\u2200\uff65`)\uff85\uff72\uff85\uff72'\n          end\n\n        \"#{loc} : #{unnecessary_str}\"\n      }\n\n    tp.raised_exception.set_backtrace message\n  }\nend\n\nclass HogeClass\n  def hoge(n)\n    str = \"hoge #{n}\"\n    if n > 0\n      hoge(n - 1)\n    else\n      not_defined\n    end\n  end\nend\n\nHogeClass.new.hoge(3)\n```\n\n\u3067\u304d\u305f\u3002\n\u5b9f\u884c\u3057\u3066\u307f\u308b\u3068\n\n```\n$ ruby sample.rb\nsample.rb:45:in `hoge' : n (\u30ce\uff40\u0414)\u30ce\u5f61 0 | (\uff9f\u2200\uff9f)\u4eba(\uff9f\u2200\uff9f) | str (\u30ce\uff40\u0414)\u30ce\u5f61 hoge 0: undefined local variable or method `not_defined' for #<HogeClass:0x007f98a1133490> (NameError)\n\tfrom sample.rb:43:in `hoge' : n (\u30ce\uff40\u0414)\u30ce\u5f61 1 | (\uff9f\u2200\uff9f)\u4eba(\uff9f\u2200\uff9f) | str (\u30ce\uff40\u0414)\u30ce\u5f61 hoge 1\n\tfrom sample.rb:43:in `hoge' : n (\u30ce\uff40\u0414)\u30ce\u5f61 2 | (\uff9f\u2200\uff9f)\u4eba(\uff9f\u2200\uff9f) | str (\u30ce\uff40\u0414)\u30ce\u5f61 hoge 2\n\tfrom sample.rb:43:in `hoge' : n (\u30ce\uff40\u0414)\u30ce\u5f61 3 | (\uff9f\u2200\uff9f)\u4eba(\uff9f\u2200\uff9f) | str (\u30ce\uff40\u0414)\u30ce\u5f61 hoge 3\n\tfrom sample.rb:50:in `<main>' : (\u30fe\uff89\uff65\u2200\uff65`)\uff85\uff72\uff85\uff72\n```\n\n\u3067\u304d\u305f\uff01\uff01\n\n\u3046\u3093\u3046\u3093\u3001\u3044\u3044\u3067\u3059\u306d\u3002\n\u305d\u308c\u3067\u306f\u3001\u307f\u306a\u3055\u3093\u3082\u30d0\u30c3\u30af\u30c8\u30ec\u30fc\u30b9\u3092\u81ea\u4f5c\u3057\u3066\u3001\u7d20\u6575\u306a\u30c7\u30d0\u30c3\u30b0\u30e9\u30a4\u30d5\u3092\uff01\n", "tags": ["Ruby", "\u30c7\u30d0\u30c3\u30b0"]}