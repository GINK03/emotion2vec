{"context": " More than 1 year has passed since last update.cocos2dx 3.3\u304c\u30ea\u30ea\u30fc\u30b9\u3055\u308c\u3066saveToFile\u306bcallback\u304c\u8ffd\u52a0\u3055\u308c\u305f\u3002\nhttp://www.cocos2d-x.org/news/387\n\u30fbRenderTexture: add a callback function for saveToFile()`\n\u3044\u307e\u307e\u3067\u306fsaveToFile\u304c\u3044\u3064\u7d42\u308f\u3063\u3066\u3044\u308b\u306e\u304b\u308f\u304b\u3089\u306a\u3044\u304b\u3063\u305f\u306e\u3067\u3001runAction\u3067DelayTime\u3057\u3066\u3044\u305f\u3002\ntests/cpp-test\u3082\u540c\u3058\u3088\u3046\u306bDelayTime\u3057\u3066\u3044\u305f\u304b\u3089\u3053\u308c\u3057\u304b\u65b9\u6cd5\u304c\u306a\u304b\u3063\u305f\u3068\u4fe1\u3058\u3066\u3044\u308b\u3002\ncallback\u304c\u8ffd\u52a0\u3055\u308c\u305f\u3053\u3068\u3067DelayTime\u3067\uff11\u79d2\u3068\u304b\u6839\u62e0\u306e\u306a\u3044\u5024\u3092\u8a2d\u5b9a\u3057\u306a\u3044\u3067\u3059\u3080\u3002\n\nGameScene.h\n#ifndef __GAME_SCENE_H__\n#define __GAME_SCENE_H__\n\n#include \"cocos2d.h\"\n#include \"extensions/cocos-ext.h\"\n#include \"ui/CocosGUI.h\"\n#include \"ProtocolShare.h\"\n\nclass GameScene : public cocos2d::Layer\n, public cocos2d::plugin::ShareResultListener\n{\nprotected:\n    cocos2d::RenderTexture* mTexture;\n    cocos2d::plugin::ProtocolShare* mTwitter;\npublic:\n    static cocos2d::Scene* createScene();\n\n    GameScene();\n    virtual ~GameScene();\n\n    virtual bool init();\n    virtual void onShareResult(cocos2d::plugin::ShareResultCode, const char*);\n\n    void tweet(cocos2d::Ref*, cocos2d::extension::Control::EventType);\n\n    CREATE_FUNC(GameScene);\n};\n\n#endif\n\n\n\n\nGameScene.cpp\n#include \"GameScene.h\"\n#include \"PluginManager.h\"\n\n\nScene* GameScene::createScene()\n{\n    // 'scene' is an autorelease object\n    auto scene = Scene::create();\n\n    // 'layer' is an autorelease object\n    auto layer = GameScene::create();\n\n    // add layer as a child to scene\n    scene->addChild(layer);\n\n    // return the scene\n    return scene;\n}\n\nGameScene::GameScene()\n: mTwitter(nullptr)\n, mTexture(nullptr)\n{\n}\n\nGameScene::~GameScene()\n{\n    if(nullptr != mTwitter) {\n        plugin::PluginManager::getInstance()->unloadPlugin(\"ShareTwitter\");\n        mTwitter = nullptr;\n    }\n    if(nullptr != mTexture) {\n        mTexture->release();\n        Director::getInstance()->getTextureCache()->removeUnusedTextures();\n    }\n}\n\n\nbool GameScene::init()\n{\n    if ( !Layer::init() )\n    {\n        return false;\n    }\n\n   Size visibleSize = Director::getInstance()->getVisibleSize();\n    Vec2 origin = Director::getInstance()->getVisibleOrigin();\n\n    auto btn = ControlButton::create(Scale9Sprite::createWithSpriteFrameName(\"btn_tweet.png\"));\n    btn->setAdjustBackgroundImage(false);\n    btn->setAnchorPoint(Vec2::ZERO);\n    btn->setPosition(Vec2::ZERO);\n    btn->addTargetWithActionForControlEvents(this, cccontrol_selector(GameScene::tweet), Control::EventType::TOUCH_DOWN);\n    this->addChild(btn);\n\n\n\n    mTwitter =  dynamic_cast<plugin::ProtocolShare*>(plugin::PluginManager::getInstance()->loadPlugin(\"ShareTwitter\"));\n\n    plugin::TShareDeveloperInfo pTwitterInfo;\n    pTwitterInfo[\"TwitterKey\"] = TWEET_KEY;\n    pTwitterInfo[\"TwitterSecret\"] = TWEET_SECRET;\n\n#if defined(COCOS2D_DEBUG)\n    mTwitter->setDebugMode(true);\n#endif\n\n    mTwitter->configDeveloperInfo(pTwitterInfo);\n    mTwitter->setResultListener(this);\n\n    mTexture = RenderTexture::create(visibleSize.width, visibleSize.height);\n    mTexture->retain();\n    mTexture->setPosition(Vec2(visibleSize.width/2, visibleSize.height/2));\n\n\n\n    return true;\n}\n\nvoid GameScene::tweet(Ref* pSender, Control::EventType type)\n{\n    auto btn = static_cast<ControlButton*>(pSender);\n    btn->setEnabled(false);\n\n    mTexture->clear(CCRANDOM_0_1(), CCRANDOM_0_1(), CCRANDOM_0_1(), CCRANDOM_0_1());\n    mTexture->begin();\n    Director::getInstance()->getRunningScene()->visit();\n    mTexture->end();\n\n    // \u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u8ffd\u52a0\u3055\u308c\u305f\u3084\u3063\u305f\u30fc\uff01\uff01\n    mTexture->saveToFile(\"a.png\", Image::Format::PNG, true, [&](RenderTexture* rt, const std::string& path) {\n        plugin::TShareInfo pInfo;\n       pInfo[\"SharedText\"] = \"tweet msg\";\n       pInfo[\"SharedImagePath\"] = path;\n       mTwitter->share(pInfo);\n\n        btn->setEnabled(true);\n    });\n\n/*\u3061\u306a\u307f\u306b\u3044\u307e\u307e\u3067\u306f\u3053\u3046\u66f8\u3044\u3066\u3044\u305f\n    if(mTexture->saveToFile(\"a.png\")) {\n        this->runAction(Sequence::create(\n            DelayTime::create(1.0f),\n           CallFunc::create([this](){\n\n                btn->setEnabled(true);\n\n                plugin::TShareInfo pInfo;\n                pInfo[\"SharedText\"] = \"tweet msg\";\n                pInfo[\"SharedImagePath\"] = FileUtils::getInstance()->getWritablePath().append(\"a.png\");\n                mTwitter->share(pInfo);\n            }),\n           nullptr));\n    }\n\n*/\n\n\n\n\n}\n\nvoid GameScene::onShareResult(plugin::ShareResultCode ret, const char* msg)\n{\n    if(ret == plugin::kShareSuccess) {\n        MessageBox(msg, \"success\");\n    }\n}\n\n\n\n\u3053\u3093\u306a\u611f\u3058\u3067\u304b\u3051\u308b\u3088\u3046\u306b\u306a\u308b\u3002\n\u3046\u308c\u3057\u3044\u3002\n\ncocos2dx 3.3\u304c\u30ea\u30ea\u30fc\u30b9\u3055\u308c\u3066saveToFile\u306bcallback\u304c\u8ffd\u52a0\u3055\u308c\u305f\u3002\nhttp://www.cocos2d-x.org/news/387\n\n\u30fbRenderTexture: add a callback function for saveToFile()`\n\n\n\u3044\u307e\u307e\u3067\u306fsaveToFile\u304c\u3044\u3064\u7d42\u308f\u3063\u3066\u3044\u308b\u306e\u304b\u308f\u304b\u3089\u306a\u3044\u304b\u3063\u305f\u306e\u3067\u3001runAction\u3067DelayTime\u3057\u3066\u3044\u305f\u3002\ntests/cpp-test\u3082\u540c\u3058\u3088\u3046\u306bDelayTime\u3057\u3066\u3044\u305f\u304b\u3089\u3053\u308c\u3057\u304b\u65b9\u6cd5\u304c\u306a\u304b\u3063\u305f\u3068\u4fe1\u3058\u3066\u3044\u308b\u3002\n\ncallback\u304c\u8ffd\u52a0\u3055\u308c\u305f\u3053\u3068\u3067DelayTime\u3067\uff11\u79d2\u3068\u304b\u6839\u62e0\u306e\u306a\u3044\u5024\u3092\u8a2d\u5b9a\u3057\u306a\u3044\u3067\u3059\u3080\u3002\n\n\n\n```h:GameScene.h\n#ifndef __GAME_SCENE_H__\n#define __GAME_SCENE_H__\n\n#include \"cocos2d.h\"\n#include \"extensions/cocos-ext.h\"\n#include \"ui/CocosGUI.h\"\n#include \"ProtocolShare.h\"\n\nclass GameScene : public cocos2d::Layer\n, public cocos2d::plugin::ShareResultListener\n{\nprotected:\n\tcocos2d::RenderTexture* mTexture;\n\tcocos2d::plugin::ProtocolShare* mTwitter;\npublic:\n\tstatic cocos2d::Scene* createScene();\n\n    GameScene();\n    virtual ~GameScene();\n\n\tvirtual bool init();\n\tvirtual void onShareResult(cocos2d::plugin::ShareResultCode, const char*);\n\n\tvoid tweet(cocos2d::Ref*, cocos2d::extension::Control::EventType);\n\n\tCREATE_FUNC(GameScene);\n};\n\n#endif\n\n```\n\n\n```cpp:GameScene.cpp\n#include \"GameScene.h\"\n#include \"PluginManager.h\"\n\n\nScene* GameScene::createScene()\n{\n    // 'scene' is an autorelease object\n    auto scene = Scene::create();\n    \n    // 'layer' is an autorelease object\n    auto layer = GameScene::create();\n\n    // add layer as a child to scene\n    scene->addChild(layer);\n\n    // return the scene\n    return scene;\n}\n\nGameScene::GameScene()\n: mTwitter(nullptr)\n, mTexture(nullptr)\n{\n}\n\nGameScene::~GameScene()\n{\n\tif(nullptr != mTwitter) {\n\t\tplugin::PluginManager::getInstance()->unloadPlugin(\"ShareTwitter\");\n\t\tmTwitter = nullptr;\n\t}\n\tif(nullptr != mTexture) {\n    \tmTexture->release();\n    \tDirector::getInstance()->getTextureCache()->removeUnusedTextures();\n\t}\n}\n\n\nbool GameScene::init()\n{\n    if ( !Layer::init() )\n    {\n        return false;\n    }\n\n   Size visibleSize = Director::getInstance()->getVisibleSize();\n    Vec2 origin = Director::getInstance()->getVisibleOrigin();\n\n\tauto btn = ControlButton::create(Scale9Sprite::createWithSpriteFrameName(\"btn_tweet.png\"));\n    btn->setAdjustBackgroundImage(false);\n    btn->setAnchorPoint(Vec2::ZERO);\n    btn->setPosition(Vec2::ZERO);\n    btn->addTargetWithActionForControlEvents(this, cccontrol_selector(GameScene::tweet), Control::EventType::TOUCH_DOWN);\n    this->addChild(btn);\n\t\n\n\n\tmTwitter = \tdynamic_cast<plugin::ProtocolShare*>(plugin::PluginManager::getInstance()->loadPlugin(\"ShareTwitter\"));\n\n\tplugin::TShareDeveloperInfo pTwitterInfo;\n\tpTwitterInfo[\"TwitterKey\"] = TWEET_KEY;\n\tpTwitterInfo[\"TwitterSecret\"] = TWEET_SECRET;\n\n#if defined(COCOS2D_DEBUG)\n\tmTwitter->setDebugMode(true);\n#endif\n\n\tmTwitter->configDeveloperInfo(pTwitterInfo);\n\tmTwitter->setResultListener(this);\n\n    mTexture = RenderTexture::create(visibleSize.width, visibleSize.height);\n    mTexture->retain();\n    mTexture->setPosition(Vec2(visibleSize.width/2, visibleSize.height/2));\n\n\n\n\treturn true;\n}\n\nvoid GameScene::tweet(Ref* pSender, Control::EventType type)\n{\n\tauto btn = static_cast<ControlButton*>(pSender);\n\tbtn->setEnabled(false);\n\n\tmTexture->clear(CCRANDOM_0_1(), CCRANDOM_0_1(), CCRANDOM_0_1(), CCRANDOM_0_1());\n\tmTexture->begin();\n\tDirector::getInstance()->getRunningScene()->visit();\n\tmTexture->end();\n\n\t// \u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u8ffd\u52a0\u3055\u308c\u305f\u3084\u3063\u305f\u30fc\uff01\uff01\n\tmTexture->saveToFile(\"a.png\", Image::Format::PNG, true, [&](RenderTexture* rt, const std::string& path) {\n\t\tplugin::TShareInfo pInfo;\n       pInfo[\"SharedText\"] = \"tweet msg\";\n       pInfo[\"SharedImagePath\"] = path;\n       mTwitter->share(pInfo);\n\n\t\tbtn->setEnabled(true);\n\t});\n\n/*\u3061\u306a\u307f\u306b\u3044\u307e\u307e\u3067\u306f\u3053\u3046\u66f8\u3044\u3066\u3044\u305f\n\tif(mTexture->saveToFile(\"a.png\")) {\n\t\tthis->runAction(Sequence::create(\n       \t\tDelayTime::create(1.0f),\n           CallFunc::create([this](){\n\n\t\t\t\tbtn->setEnabled(true);\n\n \t\t\t\tplugin::TShareInfo pInfo;\n              \tpInfo[\"SharedText\"] = \"tweet msg\";\n              \tpInfo[\"SharedImagePath\"] = FileUtils::getInstance()->getWritablePath().append(\"a.png\");\n              \tmTwitter->share(pInfo);\n          \t}),\n           nullptr));\n\t}\n\n*/\n\n\n\n \n}\n\nvoid GameScene::onShareResult(plugin::ShareResultCode ret, const char* msg)\n{\n\tif(ret == plugin::kShareSuccess) {\n\t\tMessageBox(msg, \"success\");\n\t}\n}\n\n```\n\n\n\u3053\u3093\u306a\u611f\u3058\u3067\u304b\u3051\u308b\u3088\u3046\u306b\u306a\u308b\u3002\n\n\u3046\u308c\u3057\u3044\u3002\n", "tags": ["cocos2d-x"]}