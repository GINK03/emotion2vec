{"tags": ["BTC", "Terraform", "ECS", "docker", "HHVM"], "context": "\u524d\u56de\u306e\u7d9a\u304d\u3067\u3059\u3002\nHHVM\u30b3\u30f3\u30c6\u30ca\u3092FactCGI\u30e2\u30fc\u30c9\u3067\u52d5\u304b\u3057\u3066\u307f\u307e\u3059\u3002\n\u69cb\u7bc9\u306fTerraForm\u3092\u5229\u7528\u3057\u3001\u30b3\u30f3\u30c6\u30ca\u5b9f\u884c\u74b0\u5883\u306fAmazon ECS\u3092\u5229\u7528\u3057\u307e\u3059\u3002\n\n\u69cb\u7bc9\u30a4\u30e1\u30fc\u30b8\nELB(Public)\u3088\u308a\u3001apache\u30b3\u30f3\u30c6\u30ca\u306b\u6d41\u3057\u3001ELB(Internal)\u3092\u7d4c\u3066\u3001HHVM\u30b3\u30f3\u30c6\u30ca(FactCGI)\u306b\u63a5\u7d9a\u3057\u307e\u3059\u3002\n\n\n\u5fc5\u8981\u306a\u3082\u306e\n\nTerraForm\nAmaozon AccessKey/SecretKey(secret.tfvars)\nAmazon VPC\nAWS \u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u30b0\u30eb\u30fc\u30d7\nEC2\u30ad\u30fc\u30da\u30a2\napache\u30b3\u30f3\u30c6\u30ca\u30a4\u30e1\u30fc\u30b8\n\n\n\u5229\u7528\u3057\u305fDocker\u30a4\u30e1\u30fc\u30b8\n\napache\nhhvm\n\n\n\u4e8b\u524d\u6e96\u5099(\u629c\u7c8b)\n\u4e8b\u524d\u6e96\u5099\u306e\u4e00\u90e8\u3092\u8a18\u8f09\u3057\u307e\u3059\u3002\n\n\u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u30b0\u30eb\u30fc\u30d7\n\u4ee5\u4e0b\uff13\u3064\u306e\u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u30b0\u30eb\u30fc\u30d7\uff08\u203b\u30a2\u30a6\u30c8\u30d0\u30a6\u30f3\u30c9\u306f\u3059\u3079\u3066\u8a31\u53ef\uff09\u3092\u7528\u610f\u3057\u307e\u3059\u3002\n\n\n\n\nPublic ELB\u7528(security_group1)\n\u30a4\u30f3\u30d0\u30a6\u30f3\u30c9\uff1aHTTP\u3001HTTPS\u306e\u307f\u3059\u3079\u3066\u8a31\u53ef\n\n\u5185\u90e8 ELB\u7528(security_group2)\n\u30a4\u30f3\u30d0\u30a6\u30f3\u30c9\uff1aVPC\u5185\uff08private network\uff09\u306e\u307f9000(FactCGI)\u30dd\u30fc\u30c8\u8a31\u53ef\n\nEC2 container instance\u7528(security_group3)\n\u30a4\u30f3\u30d0\u30a6\u30f3\u30c9\uff1aVPC\u5185\uff08private network\uff09\u306e\u307f\u5168\u30dd\u30fc\u30c8\u8a31\u53ef\u3001\u63a5\u7d9a\u5143\u7aef\u672b\u3088\u308a\uff08\u30de\u30a4IP\uff09\u5168\u30dd\u30fc\u30c8\u8a31\u53ef\uff08\u203b\u5404\u7a2e\u78ba\u8a8d\u7528\uff09\n\n\n\napache\u30b3\u30f3\u30c6\u30ca\u30a4\u30e1\u30fc\u30b8\ndocker\u3078\u306eenv(environment)\u306e\u5f15\u304d\u56de\u3057\u304c\u3046\u307e\u304f\u52d5\u4f5c\u3057\u306a\u304b\u3063\u305f\u305f\u3081\u3001apache\u30b3\u30f3\u30c6\u30ca\u306eELB\uff08internal\uff09\u63a5\u7d9a\u306f\u30d9\u30bf\u66f8\u304d\u3057\u3066\u3044\u307e\u3059\u3002\u3002\u3002\n\u4ee5\u4e0b\u3092\u52d5\u4f5c\u3055\u305b\u308b\u306b\u306fhttps://github.com/Thirosue/docker-apache2\u3092\u30af\u30ed\u30fc\u30f3\u3057\u3066\u3001\u4ee5\u4e0b\u3092\u4fee\u6b63\u3057\u3001DocekrHub\u3078\u30d7\u30c3\u30b7\u30e5\u3057\u3066\u304f\u3060\u3055\u3044\u3002\uff08\u53c2\u8003\u624b\u9806\uff09\n\n\n\nhhvm_proxy_fcgi.conf\nProxyPassMatch ^/(.+\\.(hh|php)(/.*)?)$ fcgi://{\u5185\u90e8ELB\u306eA\u30ec\u30b3\u30fc\u30c9\u3092\u8a18\u8f09}:9000/app/$1\n\n\n\n\u69cb\u7bc9\nTerraForm\u3067\u69cb\u7bc9\u3057\u307e\u3059\u3002\nEC2\u30b3\u30f3\u30c6\u30ca\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306f\u3001Auto Scaling\u3067\u69cb\u6210\u3057\u307e\u3059\u3002\n\u4f5c\u6210\u3057\u305fELB\u3092ECS Service\uff08Task Difinision\uff09\u306b\u7d10\u4ed8\u3051\u307e\u3059\u3002\n\u30b5\u30f3\u30d7\u30eb\u30bd\u30fc\u30b9\n\nplan\n\nterraform plan -var-file=../secret.tfvars \\\n -var 'ssh_key_name=[EC2\u30ad\u30fc\u30da\u30a2\u540d]' \\\n -var 'security_groups_internal=[security_group3\u306eID\u3092\u8a18\u8f09]' \\\n -var 'security_groups_dmz=[security_group3\u306eID\u3092\u8a18\u8f09]' \\\n -var 'hhvm_vip=internal-hhvm-892282372.ap-northeast-1.elb.amazonaws.com'\n\n\napply\n\nterraform apply -var-file=../secret.tfvars \\\n -var 'ssh_key_name=[EC2\u30ad\u30fc\u30da\u30a2\u540d]' \\\n -var 'security_groups_internal=[security_group3\u306eID\u3092\u8a18\u8f09]' \\\n -var 'security_groups_dmz=[security_group3\u306eID\u3092\u8a18\u8f09]' \\\n -var 'hhvm_vip=internal-hhvm-892282372.ap-northeast-1.elb.amazonaws.com'\n\n\nvariable.tf\n#######################\n# Required\n#######################\n\nvariable \"access_key\" {}\nvariable \"secret_key\" {}\n\n# SSH key\nvariable \"ssh_key_name\" {}\n\n# security group internal\nvariable \"security_groups_internal\" {}\n\n# security group dmz\nvariable \"security_groups_dmz\" {}\n\n# internal elb for hhvm\nvariable \"hhvm_vip\" {}\n\n#######################\n# Option\n#######################\n\nvariable \"region\" {\n  default = \"ap-northeast-1\"\n}\n\nvariable \"aws_amis\" {\n  default = {\n      \"ap-northeast-1\" = \"ami-2b08f44a\"\n  }\n}\n\n# Instance Type\nvariable \"instance_type\" {\n  default = \"t2.micro\"\n}\n\n\n\necs_cluster.tf\nprovider \"aws\" {\n    access_key = \"${var.access_key}\"\n    secret_key = \"${var.secret_key}\"\n    region = \"${var.region}\"\n}\n\nresource \"aws_ecs_cluster\" \"hhvm\" {\n  name = \"hhvm\"\n}\n\n\n\u203b\u4ee5\u4e0b\u8a73\u7d30\u306a\u30bd\u30fc\u30b9\n\ntask_difinision.tf\nresource \"aws_ecs_task_definition\" \"hhvm\" {\n  family = \"hhvm\"\n  container_definitions = \"${file(\"task-definitions/hhvm.json\")}\"\n}\n\nresource \"aws_ecs_task_definition\" \"httpd\" {\n  family = \"httpd\"\n  container_definitions = \"${file(\"task-definitions/httpd.json\")}\"\n}\n\n\n\nhhvm.json\n[\n  {\n    \"name\": \"hhvm\",\n    \"image\": \"mirrored1976/hhvm-sample\",\n    \"cpu\": 10,\n    \"memory\": 300,\n    \"essential\": true,\n    \"portMappings\": [\n      {\n        \"containerPort\": 9000,\n        \"hostPort\": 9000\n      }\n    ]\n  }\n]\n\n\n\nhttpd.json\n[\n  {\n    \"name\": \"httpd\",\n    \"image\": \"[\u7528\u610f\u3057\u305fapache\u30b3\u30f3\u30c6\u30ca\u306e\u30a4\u30e1\u30fc\u30b8\u3092\u6307\u5b9a]\",\n    \"cpu\": 10,\n    \"memory\": 300,\n    \"essential\": true,\n    \"portMappings\": [\n      {\n        \"containerPort\": 80,\n        \"hostPort\": 80\n      }\n    ],\n    \"environment\": [\n        {\n            \"name\": \"HHVM_VIP\",\n            \"value\": \"internal-hhvm-892282372.ap-northeast-1.elb.amazonaws.com\"\n        }\n    ]\n  }\n]\n\n\n\nelb.tf\nresource \"aws_elb\" \"httpd\" {\n  name = \"httpd\"\n  availability_zones = [\"ap-northeast-1a\"]\n  security_groups = [\"${var.security_groups_dmz}\"]\n\n  listener {\n    instance_port = 80\n    instance_protocol = \"http\"\n    lb_port = 80\n    lb_protocol = \"http\"\n  }\n\n  health_check {\n    healthy_threshold = 2\n    unhealthy_threshold = 10\n    timeout = 10\n    target = \"HTTP:80/\"\n    interval = 30\n  }\n\n  cross_zone_load_balancing = true\n  idle_timeout = 400\n  connection_draining = true\n  connection_draining_timeout = 400\n}\n\n\n\nauto_scaling.tf\nresource \"aws_launch_configuration\" \"hhvm\" {\n    name = \"hhvm\"\n    image_id = \"${lookup(var.aws_amis, var.region)}\"\n    key_name = \"${var.ssh_key_name}\"\n    instance_type = \"${var.instance_type}\"\n    iam_instance_profile = \"ecsInstanceRole\"\n    security_groups = [\n        \"${var.security_groups_internal}\"\n    ]\n    user_data = \"${file(\"user_data/userdata.sh\")}\"\n}\n\nresource \"aws_autoscaling_group\" \"hhvm\" {\n  availability_zones = [\"ap-northeast-1a\"]\n  name = \"hhvm\"\n  max_size = 2\n  min_size = 2\n  desired_capacity = 2\n  health_check_grace_period = 300\n  health_check_type = \"ELB\"\n  force_delete = true\n  launch_configuration = \"${aws_launch_configuration.hhvm.name}\"\n}\n\n\n\necs_service.tf\nresource \"aws_ecs_service\" \"hhvm\" {\n  name = \"hhvm\"\n  cluster = \"${aws_ecs_cluster.hhvm.id}\"\n  task_definition = \"${aws_ecs_task_definition.hhvm.arn}\"\n  desired_count = 2\n  iam_role = \"ecsServiceRole\"\n\n  load_balancer {\n    elb_name = \"[\u7528\u610f\u3057\u305f\u5185\u90e8ELB\u306e\u540d\u524d\u3092\u8a18\u8f09]\"\n    container_name = \"hhvm\"\n    container_port = 9000\n  }\n}\n\nresource \"aws_ecs_service\" \"httpd\" {\n  name = \"httpd\"\n  cluster = \"${aws_ecs_cluster.hhvm.id}\"\n  task_definition = \"${aws_ecs_task_definition.httpd.arn}\"\n  desired_count = 2\n  iam_role = \"ecsServiceRole\"\n\n  load_balancer {\n    elb_name = \"${aws_elb.httpd.name}\"\n    container_name = \"httpd\"\n    container_port = 80\n  }\n}\n\n\n\n\u78ba\u8a8d\n\nHTTP/FactCGI\n\u30d6\u30e9\u30a6\u30b6\u3067\u4ee5\u4e0b\u306b\u30a2\u30af\u30bb\u30b9\u3002\nhttp://[Public ELB\u306eIP]/phpinfo.php\n\ndocker\u30b3\u30f3\u30c6\u30ca\n\u5404EC2 container\u3000Instance\u3078ssh\u3059\u308b\u3068\u3001apache\u30b3\u30f3\u30c6\u30ca\u3068hhvm\u30b3\u30f3\u30c6\u30ca\u53ca\u3073ecs-agent\u30b3\u30f3\u30c6\u30ca\u304c\u52d5\u3044\u3066\u3044\u308b\u306e\u304c\u78ba\u8a8d\u3067\u304d\u308b\u3002\n\n$ ssh -i \"[EC2\u30ad\u30fc\u30da\u30a2\u540d]\" ec2-user@ec2-52-197-239-125.ap-northeast-1.compute.amazonaws.com\n$ docker ps\nCONTAINER ID        IMAGE                            COMMAND                  CREATED             STATUS              PORTS                    NAMES\nad616c73345f        mirrored1976/apache2             \"/usr/sbin/apachectl \"   About an hour ago   Up About an hour    0.0.0.0:80->80/tcp       ecs-httpd-11-httpd-88cea3affcb5c0c55e00\n1d70ef3a503c        mirrored1976/hhvm-sample         \"/start.sh\"              About an hour ago   Up About an hour    0.0.0.0:9000->9000/tcp   ecs-hhvm-23-hhvm-e2b583edaa80be909501\n6172ac18f2af        amazon/amazon-ecs-agent:latest   \"/agent\"                 About an hour ago   Up About an hour                             ecs-agent\n\n\n\u5f8c\u51e6\u7406\n\u30b5\u30f3\u30d7\u30eb\u3092\u7834\u68c4\u3057\u307e\u3059\u3002\n\nplan destroy\n\nterraform plan -destroy -out=./terraform.tfstate -var-file=../secret.tfvars \\\n -var 'ssh_key_name=[EC2\u30ad\u30fc\u30da\u30a2\u540d]' \\\n -var 'security_groups_internal=[security_group3\u306eID\u3092\u8a18\u8f09]' \\\n -var 'security_groups_dmz=[security_group3\u306eID\u3092\u8a18\u8f09]' \\\n -var 'hhvm_vip=internal-hhvm-892282372.ap-northeast-1.elb.amazonaws.com'\n\n\ndo destroy\n\nterraform apply ./terraform.tfstate\n\n\n\u6700\u5f8c\u306b\n\u4eca\u56de\u306e\u69cb\u7bc9\u306f\u304b\u306a\u308a\u624b\u3053\u305a\u308a\u307e\u3057\u305f\u304c\u3001\u304a\u9670\u3055\u307e\u3067Amazon ECS\u304c\u5927\u5206\u7406\u89e3\u3067\u304d\u307e\u3057\u305f\u3002\n\u521d\u3081\u306f\u3001ECS\u306f\u96e3\u3057\u3044\u3068\u611f\u3058\u307e\u3057\u305f\u304c\u3001\u7406\u89e3\u3067\u304d\u308b\u3068\u30b7\u30f3\u30d7\u30eb\u306a\u306e\u3067\u3001\u5b9f\u6226\u6295\u5165\u3067\u304d\u308b\u3088\u3046\u8a70\u3081\u3066\u3044\u304d\u307e\u3059\u3002\n[\u524d\u56de](http://qiita.com/takeshi_hirosue/items/c4dea2cde71b7921c4a0 \"\u524d\u56de\")\u306e\u7d9a\u304d\u3067\u3059\u3002\nHHVM\u30b3\u30f3\u30c6\u30ca\u3092FactCGI\u30e2\u30fc\u30c9\u3067\u52d5\u304b\u3057\u3066\u307f\u307e\u3059\u3002\n\u69cb\u7bc9\u306fTerraForm\u3092\u5229\u7528\u3057\u3001\u30b3\u30f3\u30c6\u30ca\u5b9f\u884c\u74b0\u5883\u306fAmazon ECS\u3092\u5229\u7528\u3057\u307e\u3059\u3002\n\n## \u69cb\u7bc9\u30a4\u30e1\u30fc\u30b8\n\nELB(Public)\u3088\u308a\u3001apache\u30b3\u30f3\u30c6\u30ca\u306b\u6d41\u3057\u3001ELB(Internal)\u3092\u7d4c\u3066\u3001HHVM\u30b3\u30f3\u30c6\u30ca(FactCGI)\u306b\u63a5\u7d9a\u3057\u307e\u3059\u3002\n\n![ECS.png](https://qiita-image-store.s3.amazonaws.com/0/73176/d1cd4080-d864-355e-7902-a8cff0d1d8bf.png)\n\n## \u5fc5\u8981\u306a\u3082\u306e\n+ TerraForm\n+ Amaozon AccessKey/SecretKey(secret.tfvars)\n+ Amazon VPC\n+ AWS \u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u30b0\u30eb\u30fc\u30d7\n+ EC2\u30ad\u30fc\u30da\u30a2\n+ apache\u30b3\u30f3\u30c6\u30ca\u30a4\u30e1\u30fc\u30b8\n\n## \u5229\u7528\u3057\u305fDocker\u30a4\u30e1\u30fc\u30b8\n+ [apache](https://hub.docker.com/r/mirrored1976/apache2/)\n+ [hhvm](https://hub.docker.com/r/mirrored1976/hhvm-sample/)\n\n## \u4e8b\u524d\u6e96\u5099(\u629c\u7c8b)\n\u4e8b\u524d\u6e96\u5099\u306e\u4e00\u90e8\u3092\u8a18\u8f09\u3057\u307e\u3059\u3002\n\n+ \u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u30b0\u30eb\u30fc\u30d7<p>\n\u4ee5\u4e0b\uff13\u3064\u306e\u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u30b0\u30eb\u30fc\u30d7\uff08\u203b\u30a2\u30a6\u30c8\u30d0\u30a6\u30f3\u30c9\u306f\u3059\u3079\u3066\u8a31\u53ef\uff09\u3092\u7528\u610f\u3057\u307e\u3059\u3002<p>\n\n  1. Public ELB\u7528(security_group1)<p>\n  \u30a4\u30f3\u30d0\u30a6\u30f3\u30c9\uff1aHTTP\u3001HTTPS\u306e\u307f\u3059\u3079\u3066\u8a31\u53ef\n  1. \u5185\u90e8 ELB\u7528(security_group2)<p>\n  \u30a4\u30f3\u30d0\u30a6\u30f3\u30c9\uff1aVPC\u5185\uff08private network\uff09\u306e\u307f9000(FactCGI)\u30dd\u30fc\u30c8\u8a31\u53ef\n  1. EC2 container instance\u7528(security_group3)<p>\n  \u30a4\u30f3\u30d0\u30a6\u30f3\u30c9\uff1aVPC\u5185\uff08private network\uff09\u306e\u307f\u5168\u30dd\u30fc\u30c8\u8a31\u53ef\u3001\u63a5\u7d9a\u5143\u7aef\u672b\u3088\u308a\uff08\u30de\u30a4IP\uff09\u5168\u30dd\u30fc\u30c8\u8a31\u53ef\uff08\u203b\u5404\u7a2e\u78ba\u8a8d\u7528\uff09\n\n+ apache\u30b3\u30f3\u30c6\u30ca\u30a4\u30e1\u30fc\u30b8<p>\ndocker\u3078\u306eenv(environment)\u306e\u5f15\u304d\u56de\u3057\u304c\u3046\u307e\u304f\u52d5\u4f5c\u3057\u306a\u304b\u3063\u305f\u305f\u3081\u3001apache\u30b3\u30f3\u30c6\u30ca\u306eELB\uff08internal\uff09\u63a5\u7d9a\u306f\u30d9\u30bf\u66f8\u304d\u3057\u3066\u3044\u307e\u3059\u3002\u3002\u3002<br>\n\u4ee5\u4e0b\u3092\u52d5\u4f5c\u3055\u305b\u308b\u306b\u306f[https://github.com/Thirosue/docker-apache2](https://github.com/Thirosue/docker-apache2)\u3092\u30af\u30ed\u30fc\u30f3\u3057\u3066\u3001\u4ee5\u4e0b\u3092\u4fee\u6b63\u3057\u3001DocekrHub\u3078\u30d7\u30c3\u30b7\u30e5\u3057\u3066\u304f\u3060\u3055\u3044\u3002\uff08[\u53c2\u8003\u624b\u9806](http://qiita.com/takeshi_hirosue/items/9cfd22c2263866cece99)\uff09\n\n```:hhvm_proxy_fcgi.conf\nProxyPassMatch ^/(.+\\.(hh|php)(/.*)?)$ fcgi://{\u5185\u90e8ELB\u306eA\u30ec\u30b3\u30fc\u30c9\u3092\u8a18\u8f09}:9000/app/$1\n```\n\n## \u69cb\u7bc9\nTerraForm\u3067\u69cb\u7bc9\u3057\u307e\u3059\u3002\nEC2\u30b3\u30f3\u30c6\u30ca\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306f\u3001Auto Scaling\u3067\u69cb\u6210\u3057\u307e\u3059\u3002\n\u4f5c\u6210\u3057\u305fELB\u3092ECS Service\uff08Task Difinision\uff09\u306b\u7d10\u4ed8\u3051\u307e\u3059\u3002\n[\u30b5\u30f3\u30d7\u30eb\u30bd\u30fc\u30b9](https://github.com/Thirosue/terraform-sample/tree/master/aws_ecs \"\u30b5\u30f3\u30d7\u30eb\u30bd\u30fc\u30b9\")\n\n+ plan\n\n```bash\nterraform plan -var-file=../secret.tfvars \\\n -var 'ssh_key_name=[EC2\u30ad\u30fc\u30da\u30a2\u540d]' \\\n -var 'security_groups_internal=[security_group3\u306eID\u3092\u8a18\u8f09]' \\\n -var 'security_groups_dmz=[security_group3\u306eID\u3092\u8a18\u8f09]' \\\n -var 'hhvm_vip=internal-hhvm-892282372.ap-northeast-1.elb.amazonaws.com'\n```\n\n+ apply\n\n```bash\nterraform apply -var-file=../secret.tfvars \\\n -var 'ssh_key_name=[EC2\u30ad\u30fc\u30da\u30a2\u540d]' \\\n -var 'security_groups_internal=[security_group3\u306eID\u3092\u8a18\u8f09]' \\\n -var 'security_groups_dmz=[security_group3\u306eID\u3092\u8a18\u8f09]' \\\n -var 'hhvm_vip=internal-hhvm-892282372.ap-northeast-1.elb.amazonaws.com'\n```\n\n```:variable.tf\n#######################\n# Required\n#######################\n\nvariable \"access_key\" {}\nvariable \"secret_key\" {}\n\n# SSH key\nvariable \"ssh_key_name\" {}\n\n# security group internal\nvariable \"security_groups_internal\" {}\n\n# security group dmz\nvariable \"security_groups_dmz\" {}\n\n# internal elb for hhvm\nvariable \"hhvm_vip\" {}\n\n#######################\n# Option\n#######################\n\nvariable \"region\" {\n  default = \"ap-northeast-1\"\n}\n\nvariable \"aws_amis\" {\n  default = {\n      \"ap-northeast-1\" = \"ami-2b08f44a\"\n  }\n}\n\n# Instance Type\nvariable \"instance_type\" {\n  default = \"t2.micro\"\n}\n```\n\n```:ecs_cluster.tf\nprovider \"aws\" {\n    access_key = \"${var.access_key}\"\n    secret_key = \"${var.secret_key}\"\n    region = \"${var.region}\"\n}\n\nresource \"aws_ecs_cluster\" \"hhvm\" {\n  name = \"hhvm\"\n}\n```\n\n\u203b\u4ee5\u4e0b\u8a73\u7d30\u306a\u30bd\u30fc\u30b9\n\n```:task_difinision.tf\nresource \"aws_ecs_task_definition\" \"hhvm\" {\n  family = \"hhvm\"\n  container_definitions = \"${file(\"task-definitions/hhvm.json\")}\"\n}\n\nresource \"aws_ecs_task_definition\" \"httpd\" {\n  family = \"httpd\"\n  container_definitions = \"${file(\"task-definitions/httpd.json\")}\"\n}\n```\n\n```:hhvm.json\n[\n  {\n    \"name\": \"hhvm\",\n    \"image\": \"mirrored1976/hhvm-sample\",\n    \"cpu\": 10,\n    \"memory\": 300,\n    \"essential\": true,\n    \"portMappings\": [\n      {\n        \"containerPort\": 9000,\n        \"hostPort\": 9000\n      }\n    ]\n  }\n]\n```\n\n```:httpd.json\n[\n  {\n    \"name\": \"httpd\",\n    \"image\": \"[\u7528\u610f\u3057\u305fapache\u30b3\u30f3\u30c6\u30ca\u306e\u30a4\u30e1\u30fc\u30b8\u3092\u6307\u5b9a]\",\n    \"cpu\": 10,\n    \"memory\": 300,\n    \"essential\": true,\n    \"portMappings\": [\n      {\n        \"containerPort\": 80,\n        \"hostPort\": 80\n      }\n    ],\n    \"environment\": [\n        {\n            \"name\": \"HHVM_VIP\",\n            \"value\": \"internal-hhvm-892282372.ap-northeast-1.elb.amazonaws.com\"\n        }\n    ]\n  }\n]\n```\n\n```:elb.tf\nresource \"aws_elb\" \"httpd\" {\n  name = \"httpd\"\n  availability_zones = [\"ap-northeast-1a\"]\n  security_groups = [\"${var.security_groups_dmz}\"]\n\n  listener {\n    instance_port = 80\n    instance_protocol = \"http\"\n    lb_port = 80\n    lb_protocol = \"http\"\n  }\n\n  health_check {\n    healthy_threshold = 2\n    unhealthy_threshold = 10\n    timeout = 10\n    target = \"HTTP:80/\"\n    interval = 30\n  }\n\n  cross_zone_load_balancing = true\n  idle_timeout = 400\n  connection_draining = true\n  connection_draining_timeout = 400\n}\n```\n\n```:auto_scaling.tf\nresource \"aws_launch_configuration\" \"hhvm\" {\n    name = \"hhvm\"\n    image_id = \"${lookup(var.aws_amis, var.region)}\"\n    key_name = \"${var.ssh_key_name}\"\n    instance_type = \"${var.instance_type}\"\n    iam_instance_profile = \"ecsInstanceRole\"\n    security_groups = [\n        \"${var.security_groups_internal}\"\n    ]\n    user_data = \"${file(\"user_data/userdata.sh\")}\"\n}\n\nresource \"aws_autoscaling_group\" \"hhvm\" {\n  availability_zones = [\"ap-northeast-1a\"]\n  name = \"hhvm\"\n  max_size = 2\n  min_size = 2\n  desired_capacity = 2\n  health_check_grace_period = 300\n  health_check_type = \"ELB\"\n  force_delete = true\n  launch_configuration = \"${aws_launch_configuration.hhvm.name}\"\n}\n```\n\n```:ecs_service.tf\nresource \"aws_ecs_service\" \"hhvm\" {\n  name = \"hhvm\"\n  cluster = \"${aws_ecs_cluster.hhvm.id}\"\n  task_definition = \"${aws_ecs_task_definition.hhvm.arn}\"\n  desired_count = 2\n  iam_role = \"ecsServiceRole\"\n\n  load_balancer {\n    elb_name = \"[\u7528\u610f\u3057\u305f\u5185\u90e8ELB\u306e\u540d\u524d\u3092\u8a18\u8f09]\"\n    container_name = \"hhvm\"\n    container_port = 9000\n  }\n}\n\nresource \"aws_ecs_service\" \"httpd\" {\n  name = \"httpd\"\n  cluster = \"${aws_ecs_cluster.hhvm.id}\"\n  task_definition = \"${aws_ecs_task_definition.httpd.arn}\"\n  desired_count = 2\n  iam_role = \"ecsServiceRole\"\n\n  load_balancer {\n    elb_name = \"${aws_elb.httpd.name}\"\n    container_name = \"httpd\"\n    container_port = 80\n  }\n}\n```\n\n## \u78ba\u8a8d\n\n+ HTTP/FactCGI\n\u30d6\u30e9\u30a6\u30b6\u3067\u4ee5\u4e0b\u306b\u30a2\u30af\u30bb\u30b9\u3002\nhttp://[Public ELB\u306eIP]/phpinfo.php\n<br>\n\n+ docker\u30b3\u30f3\u30c6\u30ca\n\u5404EC2 container\u3000Instance\u3078ssh\u3059\u308b\u3068\u3001apache\u30b3\u30f3\u30c6\u30ca\u3068hhvm\u30b3\u30f3\u30c6\u30ca\u53ca\u3073ecs-agent\u30b3\u30f3\u30c6\u30ca\u304c\u52d5\u3044\u3066\u3044\u308b\u306e\u304c\u78ba\u8a8d\u3067\u304d\u308b\u3002\n\n```bash\n$ ssh -i \"[EC2\u30ad\u30fc\u30da\u30a2\u540d]\" ec2-user@ec2-52-197-239-125.ap-northeast-1.compute.amazonaws.com\n$ docker ps\nCONTAINER ID        IMAGE                            COMMAND                  CREATED             STATUS              PORTS                    NAMES\nad616c73345f        mirrored1976/apache2             \"/usr/sbin/apachectl \"   About an hour ago   Up About an hour    0.0.0.0:80->80/tcp       ecs-httpd-11-httpd-88cea3affcb5c0c55e00\n1d70ef3a503c        mirrored1976/hhvm-sample         \"/start.sh\"              About an hour ago   Up About an hour    0.0.0.0:9000->9000/tcp   ecs-hhvm-23-hhvm-e2b583edaa80be909501\n6172ac18f2af        amazon/amazon-ecs-agent:latest   \"/agent\"                 About an hour ago   Up About an hour                             ecs-agent\n```\n\n## \u5f8c\u51e6\u7406\n\u30b5\u30f3\u30d7\u30eb\u3092\u7834\u68c4\u3057\u307e\u3059\u3002\n\n+ plan destroy\n\n```bash\nterraform plan -destroy -out=./terraform.tfstate -var-file=../secret.tfvars \\\n -var 'ssh_key_name=[EC2\u30ad\u30fc\u30da\u30a2\u540d]' \\\n -var 'security_groups_internal=[security_group3\u306eID\u3092\u8a18\u8f09]' \\\n -var 'security_groups_dmz=[security_group3\u306eID\u3092\u8a18\u8f09]' \\\n -var 'hhvm_vip=internal-hhvm-892282372.ap-northeast-1.elb.amazonaws.com'\n```\n\n+ do destroy\n\n```bash\nterraform apply ./terraform.tfstate\n```\n\n## \u6700\u5f8c\u306b\n\u4eca\u56de\u306e\u69cb\u7bc9\u306f\u304b\u306a\u308a\u624b\u3053\u305a\u308a\u307e\u3057\u305f\u304c\u3001\u304a\u9670\u3055\u307e\u3067Amazon ECS\u304c\u5927\u5206\u7406\u89e3\u3067\u304d\u307e\u3057\u305f\u3002\n\u521d\u3081\u306f\u3001ECS\u306f\u96e3\u3057\u3044\u3068\u611f\u3058\u307e\u3057\u305f\u304c\u3001\u7406\u89e3\u3067\u304d\u308b\u3068\u30b7\u30f3\u30d7\u30eb\u306a\u306e\u3067\u3001\u5b9f\u6226\u6295\u5165\u3067\u304d\u308b\u3088\u3046\u8a70\u3081\u3066\u3044\u304d\u307e\u3059\u3002\n"}