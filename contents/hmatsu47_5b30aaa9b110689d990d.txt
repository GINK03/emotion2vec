{"context": "Pound\u306f\u3001\u8efd\u91cf\u306a\u30ea\u30d0\u30fc\u30b9\u30d7\u30ed\u30ad\u30b7\u3067\u3059\u3002SSL\uff08TLS\uff09\u30e9\u30c3\u30d1\u30fc\u3068\u3057\u3066\u3082\u5229\u7528\u3067\u304d\u307e\u3059\u3002\n\u7279\u306b\u76ee\u65b0\u3057\u3044\u8a71\u984c\u3082\u3042\u308a\u307e\u305b\u3093\u304c\u3001iPhone\u30a2\u30d7\u30ea\u304b\u3089\u547c\u3073\u51fa\u3059\u30b5\u30fc\u30d0API\u3092\u80cc\u5f8c\u306b\u7f6e\u304f\u306a\u3069\u3001ATS\u306e\u5236\u9650\u306b\u5f15\u3063\u304b\u304b\u308b\u3053\u3068\u3082\u3042\u308b\u304b\u3082\u3057\u308c\u306a\u3044\u306e\u3067\u3001\u3068\u308a\u3042\u3048\u305a\u3042\u3052\u3066\u304a\u304d\u307e\u3059\u3002\n\u306a\u304a\u3001\u3053\u3053\u3067\u306f\u30bd\u30fc\u30b9\u304b\u3089\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u65b9\u6cd5\u3092\u3068\u308a\u3042\u3052\u307e\u3059\u3002\u7279\u306b\u8a18\u8ff0\u304c\u306a\u3051\u308c\u3070\u3001\u5bfe\u8c61\u30d0\u30fc\u30b8\u30e7\u30f3\u306f2.7\u3067\u3059\u3002\n\nHTTP\u30ea\u30af\u30a8\u30b9\u30c8\uff0f\u30ec\u30b9\u30dd\u30f3\u30b9\u30d8\u30c3\u30c0\u30b5\u30a4\u30ba\u306e\u5236\u9650\u3092\u5909\u66f4\u3059\u308b\nPound\u306f\u3001\u30c7\u30d5\u30a9\u30eb\u30c8\u3067\u306fHTTP\u30ea\u30af\u30a8\u30b9\u30c8\uff0f\u30ec\u30b9\u30dd\u30f3\u30b9\u30d8\u30c3\u30c0\u30b5\u30a4\u30ba\u306e\u4e0a\u9650\u304c4096\u30d0\u30a4\u30c8\u3067\u3059\u3002\n\u901a\u5e38\u306f\u3053\u308c\u3067\u554f\u984c\u306a\u3044\u306f\u305a\u3067\u3059\u304c\u3001\u9577\u3044cookie\u3092\u767a\u884c\u3059\u308b\u306a\u3069\u3067\u30b5\u30a4\u30ba\u304c\u8d85\u904e\u3057\u3001\u80cc\u5f8c\u306eWeb\u30b5\u30fc\u30d0\u3067\u7a3c\u50cd\u3057\u3066\u3044\u308b\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306a\u3069\u304c\u6b63\u3057\u304f\u52d5\u4f5c\u3057\u306a\u3044\u3053\u3068\u304c\u3042\u308a\u307e\u3059\u3002\nApache\u306a\u3069\u3067\u306f\u8a2d\u5b9a\u3067\u4e0a\u9650\u3092\u5909\u66f4\u3067\u304d\u307e\u3059\u304c\u3001Pound\u306e\u5834\u5408\u306fconfigure\u3067\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u6307\u5b9a\u3057\u3066make\u3057\u76f4\u3059\u3053\u3068\u306b\u306a\u308a\u307e\u3059\u3002\n\uff08\u4ee5\u4e0b\u3001\u30ab\u30ec\u30f3\u30c8\u304c\u30bd\u30fc\u30b9\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u5185\u306b\u306a\u3063\u3066\u3044\u308b\u524d\u63d0\u3067\u3002\u30bd\u30fc\u30b9\u5c55\u958b\u6642\u306eowner\u306b\u6ce8\u610f\u3057\u3066\u3002\uff09\n$ make clean\n$ ./configure --with-maxbuf=\u3010\u8a2d\u5b9a\u3059\u308b\u30d0\u30a4\u30c8\u6570\u3011 --with-ssl --with-dh=2048\n$ make\n$ sudo make install\n\n\u203b\u672c\u6765\u306f\u30ea\u30af\u30a8\u30b9\u30c8\u7b49\u3092\u51e6\u7406\u3059\u308b\u305f\u3081\u306e\u30d0\u30c3\u30d5\u30a1\u30b5\u30a4\u30ba\u306e\u6307\u5b9a\u3067\u3059\u304c\u3001HTTP\u30ea\u30af\u30a8\u30b9\u30c8\uff0f\u30ec\u30b9\u30dd\u30f3\u30b9\u30d8\u30c3\u30c0\u3068\u3057\u3066\u51e6\u7406\u3067\u304d\u308b\u30b5\u30a4\u30ba\u304c\u3053\u306e\u30d0\u30c3\u30d5\u30a1\u30b5\u30a4\u30ba\u306e\u5236\u9650\u3092\u53d7\u3051\u308b\u305f\u3081\u3001\u3053\u3053\u3092\u8abf\u6574\u3057\u307e\u3059\u3002\n\n\u9375\u4ea4\u63db\u306bECDHE\u3092\u4f7f\u3046\n\u9375\u4ea4\u63db\u306bECDHE\u3092\u4f7f\u3046\u8a2d\u5b9a\u3067\u3059\u3002PFS\uff08Perfect Forward Secrecy\uff09\u5bfe\u5fdc\u3068\u306a\u308b\u306e\u3067\u3001TLS\u901a\u4fe1\u304c\u3088\u308a\u30bb\u30ad\u30e5\u30a2\u306b\u306a\u308a\u307e\u3059\u3002\n\u307e\u305f\u3001iPhone\u30a2\u30d7\u30ea\uff08iOS9\u4ee5\u4e0a\uff09\u304b\u3089\u547c\u3073\u51fa\u3059\u30b5\u30fc\u30d0API\u3092\u80cc\u5f8c\u306b\u7f6e\u304f\u3068\u304d\u306b\u3001ATS\uff08App Transport Security\uff09\u306e\u5236\u9650\u306b\u5f15\u3063\u304b\u304b\u3063\u3066TLS\u901a\u4fe1\u3067\u304d\u306a\u3044\u30fb\u30a2\u30d7\u30ea\u306e\u5be9\u67fb\u3067\u30ea\u30b8\u30a7\u30af\u30c8\u3055\u308c\u308b\u2026\u3068\u3044\u3046\u4e8b\u614b\u3092\u907f\u3051\u308b\u305f\u3081\u306b\u5fc5\u8981\u306b\u306a\u308a\u307e\u3059\uff08Pound 2.7\u304b\u3089\u306e\u6a5f\u80fd\u3067\u3059\uff09\u3002\n\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3078\u306e\u8a18\u8ff0\u3067\u5bfe\u5fdc\u3057\u307e\u3059\u3002\n\npound.cfg\uff08\u4e00\u90e8\u629c\u7c8b\uff09\nECDHcurve   \"prime256v1\"\n\nListenHTTPS\n        Address                     \u3010\u5f85\u3061\u53d7\u3051IP\u30a2\u30c9\u30ec\u30b9\u3011\n        Port                        443\n        Cert                        \"\u3010\u8a3c\u660e\u66f8\u30d5\u30a1\u30a4\u30eb\u306e\u30d1\u30b9\u3011\"\n        Disable                     SSLv3\n        SSLAllowClientRenegotiation 0\n        SSLHonorCipherOrder         1\n        Ciphers                     \"EECDH+ECDSA+AESGCM:EECDH+aRSA+AESGCM:EECDH+ECDSA+SHA384:EECDH+ECDSA+SHA256:EECDH+aRSA+SHA384:EECDH+aRSA+SHA256:EECDH:EDH+aRSA:-RC4:!aNULL:!eNULL:!LOW:!3DES:!MD5:!EXP:!PSK:!SRP:!DSS\"\n\n\uff08\u4ee5\u4e0b\u7565\uff09\n\n\n\u6697\u53f7\u30b9\u30a4\u30fc\u30c8\u306e\u6307\u5b9a\u306f\u9069\u5b9c\u8abf\u6574\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n\u30d7\u30ed\u30c8\u30b3\u30eb\u3068\u6697\u53f7\u30b9\u30a4\u30fc\u30c8\u306e\u6307\u5b9a\u306b\u3064\u3044\u3066\nApache\u3084Nginx\u3068OpenSSL\u3092\u7d44\u307f\u5408\u308f\u305b\u3066\u4f7f\u3063\u3066\u3044\u308b\u4eba\u306b\u3068\u3063\u3066\u306f\u5f53\u305f\u308a\u524d\u306e\u8a71\u3060\u3068\u601d\u3044\u307e\u3059\u304c\u3001Pound\u306f2.6\u307e\u3067\u30d7\u30ed\u30c8\u30b3\u30eb\u306e\u6307\u5b9a\u3092\u3059\u308b\u8a2d\u5b9a\u9805\u76ee\u304c\u306a\u304b\u3063\u305f\u3053\u3068\u3068\u3001SSL 2.0\u306e\u7121\u52b9\u5316\u306f\u6697\u53f7\u30b9\u30a4\u30fc\u30c8\u306e\u6307\u5b9a\u3067\u884c\u3063\u3066\u3044\u305f\u306e\u3067\u3001\u3082\u3057\u304b\u3059\u308b\u3068\u52d8\u9055\u3044\u304c\u3042\u308b\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u3002\n\u8106\u5f31\u6027\u5bfe\u51e6\u306e\u305f\u3081\u306bSSL 3.0\u307e\u3067\u3092\u7121\u52b9\u5316\u3059\u308b\u5834\u5408\u3001\u30d7\u30ed\u30c8\u30b3\u30eb\u306e\u7121\u52b9\u5316\u6307\u5b9a\uff08Disable\uff09\u3067SSLv3\u3092\u7121\u52b9\u306b\u3059\u308b\u306e\u304c\u6b63\u3057\u3044\u306e\u3067\u3059\u304c\u3001Pound 2.6\u307e\u3067\u3053\u306e\u9805\u76ee\u304c\u306a\u304b\u3063\u305f\u305f\u3081\u3001\u5834\u5408\u306b\u3088\u3063\u3066\u306f\u6697\u53f7\u30b9\u30a4\u30fc\u30c8\u306e\u6307\u5b9a\uff08Ciphers\uff09\u3067SSLv3\u3092\u7121\u52b9\u5316\uff08!SSLv3\u3084-SSLv3\uff09\u3057\u3066\u3057\u307e\u3063\u3066\u3044\u308b\u30b1\u30fc\u30b9\u304c\u3042\u308b\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u3002\n\u6697\u53f7\u30b9\u30a4\u30fc\u30c8\u306e\u6307\u5b9a\u3067SSLv3\u3092\u7121\u52b9\u5316\u3059\u308b\u3068\u3001SSL 3.0\u3060\u3051\u3067\u306f\u306a\u304f\u3001TLS 1.0\u3084TLS 1.1\u3082\u5229\u7528\u3067\u304d\u306a\u304f\u306a\u3063\u3066\u3057\u307e\u3044\u307e\u3059\u3002\n\u306a\u304a\u3001Pound 2.7\u3067\u306f\u3001\u30c7\u30d5\u30a9\u30eb\u30c8\u3067\u300cDisable SSLv3\u300d\u304c\u6307\u5b9a\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u306b\u306a\u3063\u3066\u3044\u308b\u306e\u3067\u3001\u7279\u306b\u8a2d\u5b9a\u3092\u66f8\u304d\u52a0\u3048\u308b\u3053\u3068\u306a\u304f\u3001SSL 3.0\u306f\u7121\u52b9\u5316\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n\n\u30bd\u30fc\u30b9\u304b\u3089\u4e0a\u66f8\u304d\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u3068\u304d\u306e\u6ce8\u610f\nPound\u3092\u30d0\u30fc\u30b8\u30e7\u30f3\u30a2\u30c3\u30d7\u3057\u305f\u308a\u3001configure\u306e\u30d1\u30e9\u30e1\u30fc\u30bf\u6307\u5b9a\u3092\u5909\u3048\u305f\u3044\u3068\u304d\u306e\u6ce8\u610f\u70b9\u3067\u3059\u3002\n\u30b5\u30fc\u30d3\u30b9\u505c\u6b62\u6642\u9593\u3092\u77ed\u304f\u3057\u305f\u3044\u3068\u8003\u3048\u308b\u3042\u307e\u308a\u3001\u30b5\u30fc\u30d3\u30b9\u3092\u6b62\u3081\u305a\u306b\u300cmake install\u300d\u3057\u3001\u305d\u308c\u304b\u3089\u30b5\u30fc\u30d3\u30b9\u306e\u518d\u8d77\u52d5\u3092\u3057\u3066\u3057\u307e\u3046\u3068\u3001\u5f53\u7136\u3067\u3059\u304c\u7570\u5e38\u304c\u767a\u751f\u3057\u307e\u3059\u3002\n\u300cDH\u30d1\u30e9\u30e1\u30fc\u30bf\u306e\u751f\u6210\u306b\u6642\u9593\u304c\u304b\u304b\u308b\u304b\u3089make\u5f8c\u306b\u30b5\u30fc\u30d3\u30b9\u3092\u505c\u6b62\u3057\u305f\u3044\u300d\u5834\u5408\u3067\u3082\u3001\u5fc5\u305a\u3001\u30b5\u30fc\u30d3\u30b9\u3092\u505c\u6b62\uff08\u300cservice pound stop\u300d\u306a\u3069\uff09\u3057\u3066\u304b\u3089\u300cmake install\u300d\u3057\u3001\u305d\u306e\u5f8c\u30b5\u30fc\u30d3\u30b9\u3092\u8d77\u52d5\uff08\u300cservice pound start\u300d\u306a\u3069\uff09\u3057\u307e\u3059\u3002\n\u300cmake install\u300d\u306f\u30d5\u30a1\u30a4\u30eb\u3092\u30b3\u30d4\u30fc\u3057\u3066\u3044\u308b\u3060\u3051\u306a\u306e\u3067\u3001\u6240\u8981\u6642\u9593\u306f\u308f\u305a\u304b\u3067\u3059\u3002\u5b89\u5fc3\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\u305f\u3060\u3001\u3061\u3087\u3063\u3068\u5384\u4ecb\u306a\u306e\u306f\u3001\u624b\u9806\u3092\u9593\u9055\u3048\u305f\u5834\u5408\u306b\u300c\u8d77\u52d5\u305b\u305a\u306b\u505c\u6b62\u3057\u3066\u3057\u307e\u3046\u300d\u306e\u3067\u306f\u306a\u304f\u3001\u300c\u4e00\u898b\u6b63\u5e38\u306b\u8d77\u52d5\u3057\u3066\u3044\u308b\u3088\u3046\u306b\u898b\u3048\u308b\u304c\u3001\u4e00\u90e8\u306e\u6697\u53f7\u30b9\u30a4\u30fc\u30c8\u304c\u4f7f\u3048\u306a\u3044\u300d\u72b6\u614b\u306b\u306a\u308b\u3053\u3068\u3067\u3059\u3002\n\u3053\u3061\u3089\u306e\u30e1\u30fc\u30ea\u30f3\u30b0\u30ea\u30b9\u30c8\u3067\u8cea\u554f\u3055\u308c\u3066\u3044\u308b\u65b9\u306f\u3001\u3069\u3046\u3084\u3089\u3053\u306e\u30df\u30b9\u3092\u72af\u3057\u3066\u3057\u307e\u3063\u305f\u3088\u3046\u3067\u3059\uff08\u305f\u3076\u3093\uff09\u3002\n\u3046\u3063\u304b\u308a\u3084\u3063\u3066\u3057\u307e\u3063\u305f\u5834\u5408\u306f\u3001\u5bfe\u8c61\u30d7\u30ed\u30bb\u30b9\u3092kill\u3057\u3066\uff08-9\u306f\u4e0d\u8981\uff09\u3001\u3042\u3089\u305f\u3081\u3066\u30b5\u30fc\u30d3\u30b9\u3092\u8d77\u52d5\u3059\u308b\u304b\u3001OS\u3092\u518d\u8d77\u52d5\u3059\u308b\u3068\u3001\u6b63\u5e38\u306a\u72b6\u614b\u306b\u306a\u308a\u307e\u3059\u3002\n\nHSTS\u306b\u5bfe\u5fdc\u3059\u308b\n\u4e2d\u9593\u8005\u653b\u6483\u306b\u3088\u308b\u4e0d\u6b63\u30b5\u30a4\u30c8\u3078\u306e\u30ea\u30c0\u30a4\u30ec\u30af\u30c8\u3084\u3001\u30bb\u30c3\u30b7\u30e7\u30f3\u30cf\u30a4\u30b8\u30e3\u30c3\u30af\u306a\u3069\u3092\u9632\u3050\u30fb\u8efd\u6e1b\u3059\u308b\u4ed5\u7d44\u307f\u3068\u3057\u3066\u3001HSTS\uff08HTTP Strict Transport Security\uff09\u304c\u3042\u308a\u307e\u3059\u3002\nHSTS\u95a2\u9023\u306e\u8a2d\u5b9a\u6a5f\u80fd\u306f\u3001Pound 2.7\u306estable\u7248\u306b\u306f\u63a1\u7528\u3055\u308c\u306a\u304b\u3063\u305f\u3088\u3046\u3067\u3059\u304c\u30012.7c\u7528\u306e\u30d1\u30c3\u30c1\u304c\u3042\u308b\u306e\u3067\u3001stable\u7248\u306b\u9069\u7528\u3067\u304d\u308b\u3088\u3046\u3001\u4fee\u6b63\u3057\u3066\u307f\u307e\u3057\u305f\u3002\n\npound_27_sts.patch\ndiff -uprN Pound-2.7.original/config.c Pound-2.7/config.c\n--- Pound-2.7.original/config.c 2015-01-27 01:47:53.000000000 +0900\n+++ Pound-2.7/config.c  2016-07-06 18:31:24.148061328 +0900\n@@ -76,7 +76,7 @@ static CODE facilitynames[] = {\n static regex_t  Empty, Comment, User, Group, RootJail, Daemon, LogFacility, LogLevel, Alive, SSLEngine, Control;\n static regex_t  ListenHTTP, ListenHTTPS, End, Address, Port, Cert, xHTTP, Client, CheckURL;\n static regex_t  Err414, Err500, Err501, Err503, MaxRequest, HeadRemove, RewriteLocation, RewriteDestination;\n-static regex_t  Service, ServiceName, URL, HeadRequire, HeadDeny, BackEnd, Emergency, Priority, HAport, HAportAddr;\n+static regex_t  Service, ServiceName, URL, HeadRequire, HeadDeny, BackEnd, Emergency, Priority, HAport, HAportAddr, StrictTransportSecurity;\n static regex_t  Redirect, RedirectN, TimeOut, Session, Type, TTL, ID, DynScale;\n static regex_t  ClientCert, AddHeader, DisableProto, SSLAllowClientRenegotiation, SSLHonorCipherOrder, Ciphers;\n static regex_t  CAlist, VerifyList, CRLlist, NoHTTPS11, Grace, Include, ConnTO, IgnoreCase, HTTPS;\n@@ -564,6 +564,7 @@ parse_service(const char *svc_name)\n     memset(res, 0, sizeof(SERVICE));\n     res->sess_type = SESS_NONE;\n     res->dynscale = dynscale;\n+    res->sts = -1;\n     pthread_mutex_init(&res->mut, NULL);\n     if(svc_name)\n         strncpy(res->name, svc_name, KEY_SIZE);\n@@ -625,6 +626,8 @@ parse_service(const char *svc_name)\n             lin[matches[1].rm_eo] = '\\0';\n             if(regcomp(&m->pat, lin + matches[1].rm_so, REG_ICASE | REG_NEWLINE | REG_EXTENDED))\n                 conf_err(\"HeadDeny bad pattern - aborted\");\n+        } else if(!regexec(&StrictTransportSecurity, lin, 4, matches, 0)) {\n+            res->sts = atoi(lin + matches[1].rm_so);\n         } else if(!regexec(&Redirect, lin, 4, matches, 0)) {\n             if(res->backends) {\n                 for(be = res->backends; be->next; be = be->next)\n@@ -851,12 +854,16 @@ parse_HTTP(void)\n         } else if(!regexec(&LogLevel, lin, 4, matches, 0)) {\n             res->log_level = atoi(lin + matches[1].rm_so);\n         } else if(!regexec(&Service, lin, 4, matches, 0)) {\n-            if(res->services == NULL)\n+            if(res->services == NULL) {\n                 res->services = parse_service(NULL);\n-            else {\n+                if(res->services->sts >= 0)\n+                    conf_err(\"StrictTransportSecurity not allowed in HTTP listener - aborted\");\n+            } else {\n                 for(svc = res->services; svc->next; svc = svc->next)\n                     ;\n                 svc->next = parse_service(NULL);\n+                if(svc->next->sts >= 0)\n+                    conf_err(\"StrictTransportSecurity not allowed in HTTP listener - aborted\");\n             }\n         } else if(!regexec(&ServiceName, lin, 4, matches, 0)) {\n             lin[matches[1].rm_eo] = '\\0';\n@@ -1469,6 +1476,7 @@ config_parse(const int argc, char **cons\n     || regcomp(&URL, \"^[ \\t]*URL[ \\t]+\\\"(.+)\\\"[ \\t]*$\", REG_ICASE | REG_NEWLINE | REG_EXTENDED)\n     || regcomp(&HeadRequire, \"^[ \\t]*HeadRequire[ \\t]+\\\"(.+)\\\"[ \\t]*$\", REG_ICASE | REG_NEWLINE | REG_EXTENDED)\n     || regcomp(&HeadDeny, \"^[ \\t]*HeadDeny[ \\t]+\\\"(.+)\\\"[ \\t]*$\", REG_ICASE | REG_NEWLINE | REG_EXTENDED)\n+    || regcomp(&StrictTransportSecurity, \"^[ \\t]*StrictTransportSecurity[ \\t]+([0-9]+)[ \\t]*$\", REG_ICASE | REG_NEWLINE | REG_EXTENDED)\n     || regcomp(&BackEnd, \"^[ \\t]*BackEnd[ \\t]*$\", REG_ICASE | REG_NEWLINE | REG_EXTENDED)\n     || regcomp(&Emergency, \"^[ \\t]*Emergency[ \\t]*$\", REG_ICASE | REG_NEWLINE | REG_EXTENDED)\n     || regcomp(&Priority, \"^[ \\t]*Priority[ \\t]+([1-9])[ \\t]*$\", REG_ICASE | REG_NEWLINE | REG_EXTENDED)\n@@ -1639,6 +1647,7 @@ config_parse(const int argc, char **cons\n     regfree(&URL);\n     regfree(&HeadRequire);\n     regfree(&HeadDeny);\n+    regfree(&StrictTransportSecurity);\n     regfree(&BackEnd);\n     regfree(&Emergency);\n     regfree(&Priority);\ndiff -uprN Pound-2.7.original/http.c Pound-2.7/http.c\n--- Pound-2.7.original/http.c   2015-01-27 01:47:53.000000000 +0900\n+++ Pound-2.7/http.c    2016-07-06 18:37:45.584260067 +0900\n@@ -1382,6 +1382,8 @@ do_http(thr_arg *arg)\n             if(!no_cont && !regexec(&RESP_IGN, response, 0, NULL, 0))\n                 no_cont = 1;\n\n+            for(n = 0; n < MAXHEADERS; n++)\n+                headers_ok[n] = 1;\n             for(chunked = 0, cont = -1L, n = 1; n < MAXHEADERS && headers[n]; n++) {\n                 switch(check_header(headers[n], buf)) {\n                 case HEADER_CONNECTION:\n@@ -1432,6 +1434,11 @@ do_http(thr_arg *arg)\n                         }\n                     }\n                     break;\n+                case HEADER_STRICT_TRANSPORT_SECURITY:\n+                    /* enforce pound's STS header */\n+                    if(svc->sts >= 0)\n+                        headers_ok[n] = 0;\n+                    break;\n                 }\n             }\n\n@@ -1441,6 +1448,8 @@ do_http(thr_arg *arg)\n             /* send the response */\n             if(!skip)\n                 for(n = 0; n < MAXHEADERS && headers[n]; n++) {\n+                    if(!headers_ok[n])\n+                        continue;\n                     if(BIO_printf(cl, \"%s\\r\\n\", headers[n]) <= 0) {\n                         if(errno) {\n                             addr2str(caddr, MAXBUF - 1, &from_host, 1);\n@@ -1452,6 +1461,8 @@ do_http(thr_arg *arg)\n                     }\n                 }\n             free_headers(headers);\n+            if(!skip && ssl && svc->sts >= 0)\n+                BIO_printf(cl, \"Strict-Transport-Security: max-age=%d\\r\\n\", svc->sts);\n\n             /* final CRLF */\n             if(!skip)\ndiff -uprN Pound-2.7.original/pound.h Pound-2.7/pound.h\n--- Pound-2.7.original/pound.h  2015-01-27 01:47:53.000000000 +0900\n+++ Pound-2.7/pound.h   2016-07-06 18:41:18.769273399 +0900\n@@ -370,6 +370,7 @@ typedef struct _service {\n #endif\n     int                 dynscale;   /* true if the back-ends should be dynamically rescaled */\n     int                 disabled;   /* true if the service is disabled */\n+    int                 sts;        /* strict transport security */\n     struct _service     *next;\n }   SERVICE;\n\n@@ -441,6 +442,7 @@ typedef enum { RENEG_INIT=0, RENEG_REJEC\n #define HEADER_URI                  9\n #define HEADER_DESTINATION          10\n #define HEADER_EXPECT               11\n+#define HEADER_STRICT_TRANSPORT_SECURITY 12\n\n /* control request stuff */\n typedef enum    {\ndiff -uprN Pound-2.7.original/svc.c Pound-2.7/svc.c\n--- Pound-2.7.original/svc.c    2015-01-27 01:47:53.000000000 +0900\n+++ Pound-2.7/svc.c     2016-07-06 18:42:10.738253739 +0900\n@@ -395,6 +395,7 @@ check_header(const char *header, char *c\n         { \"User-agent\",         10, HEADER_USER_AGENT },\n         { \"Destination\",        11, HEADER_DESTINATION },\n         { \"Expect\",             6,  HEADER_EXPECT },\n+        { \"Strict-Transport-Security\", 25, HEADER_STRICT_TRANSPORT_SECURITY },\n         { \"\",                   0,  HEADER_OTHER },\n     };\n     int i;\n\n\n\uff08\u3059\u307f\u307e\u305b\u3093\u3001GitHub\u9023\u643a\u3057\u3066\u306a\u3044\u306e\u3067\u3001\u30b3\u30d4\u30da\u3057\u3066\u4f7f\u3063\u3066\u304f\u3060\u3055\u3044\u3002\uff09\nPound\u306e\u30bd\u30fc\u30b9\u3092\u5c55\u958b\u3057\u305f\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306e1\u968e\u5c64\u4e0a\u3067\u3001\u4ee5\u4e0b\u306e\u3068\u304a\u308a\u306b\u9069\u7528\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n$ patch -p1 -d Pound-2.7 < pound_27_sts.patch\n\n\u306a\u304a\u3001\u30ea\u30f3\u30af\u5143\u306e\u8a18\u8ff0\u306b\u3042\u308b\u3068\u304a\u308a\u3001\u3053\u306e\u30d1\u30c3\u30c1\u306b\u306f\u3001\u300cincludeSubDomains\u30aa\u30d7\u30b7\u30e7\u30f3\u304c\u4f7f\u3048\u306a\u3044\u300d\uff08\uff1d\u653b\u6483\u5bfe\u7b56\u3068\u3057\u3066\u306f\u4e00\u90e8\u4e0d\u5341\u5206\u306a\u3068\u3053\u308d\u304c\u3042\u308b\uff09\u3001\u300cHTTPListener\u3067\u51e6\u7406\u3059\u308b\u30ea\u30af\u30a8\u30b9\u30c8\u306b\u3064\u3044\u3066HSTS\u30d8\u30c3\u30c0\u3092\u9664\u53bb\u3057\u306a\u3044\u300d\u306a\u3069\u306e\u5236\u7d04\u304c\u3042\u308a\u307e\u3059\u3002\n\u307e\u305f\u3001\u30ea\u30f3\u30af\u5143\u306e\u8a18\u8ff0\u3067\u306f\u300cHTTPSListeners\uff08ListenHTTPS\u30c7\u30a3\u30ec\u30af\u30c6\u30a3\u30d6\uff09\u306e\u5185\u5074\u306b\u8a18\u8ff0\u3057\u3066\u306d\u300d\u3068\u3044\u3046\u3088\u3046\u306a\u3053\u3068\u304c\u66f8\u304b\u308c\u3066\u3044\u307e\u3059\u304c\u3001\u6b63\u78ba\u306b\u306f\u3001\u3055\u3089\u306b\u305d\u306e\u4e2d\u306e\u3001Service\u30c7\u30a3\u30ec\u30af\u30c6\u30a3\u30d6\u306e\u5185\u5074\u306b\u8a2d\u5b9a\uff08\u300cStrictTransportSecurity \u6709\u52b9\u671f\u9593\uff1d\u79d2\u6570\u300d\uff09\u3092\u8a18\u8ff0\u3057\u307e\u3059\u3002\n\npound.cfg\uff08\u4e00\u90e8\u629c\u7c8b\uff09\nECDHcurve   \"prime256v1\"\n\nListenHTTPS\n        Address                     \u3010\u5f85\u3061\u53d7\u3051IP\u30a2\u30c9\u30ec\u30b9\u3011\n        Port                        443\n        Cert                        \"\u3010\u8a3c\u660e\u66f8\u30d5\u30a1\u30a4\u30eb\u306e\u30d1\u30b9\u3011\"\n        Disable                     SSLv3\n        SSLAllowClientRenegotiation 0\n        SSLHonorCipherOrder         1\n        Ciphers                     \"EECDH+ECDSA+AESGCM:EECDH+aRSA+AESGCM:EECDH+ECDSA+SHA384:EECDH+ECDSA+SHA256:EECDH+aRSA+SHA384:EECDH+aRSA+SHA256:EECDH:EDH+aRSA:-RC4:!aNULL:!eNULL:!LOW:!3DES:!MD5:!EXP:!PSK:!SRP:!DSS\"\n\n        Service\n                StrictTransportSecurity 31536000\n\n\uff08\u4ee5\u4e0b\u7565\uff09\n\n\n\u4ee5\u4e0a\u3001\u4f7f\u3063\u3066\u3044\u308b\u65b9\u306f\u5c11\u306a\u3044\u3068\u601d\u3044\u307e\u3059\u304c\u3001Pound\u306e\u5c0f\u30cd\u30bf\u96c6\u3067\u3057\u305f\u3002\n[Pound](http://www.apsis.ch/pound/)\u306f\u3001\u8efd\u91cf\u306a\u30ea\u30d0\u30fc\u30b9\u30d7\u30ed\u30ad\u30b7\u3067\u3059\u3002SSL\uff08TLS\uff09\u30e9\u30c3\u30d1\u30fc\u3068\u3057\u3066\u3082\u5229\u7528\u3067\u304d\u307e\u3059\u3002\n\n\u7279\u306b\u76ee\u65b0\u3057\u3044\u8a71\u984c\u3082\u3042\u308a\u307e\u305b\u3093\u304c\u3001iPhone\u30a2\u30d7\u30ea\u304b\u3089\u547c\u3073\u51fa\u3059\u30b5\u30fc\u30d0API\u3092\u80cc\u5f8c\u306b\u7f6e\u304f\u306a\u3069\u3001ATS\u306e\u5236\u9650\u306b\u5f15\u3063\u304b\u304b\u308b\u3053\u3068\u3082\u3042\u308b\u304b\u3082\u3057\u308c\u306a\u3044\u306e\u3067\u3001\u3068\u308a\u3042\u3048\u305a\u3042\u3052\u3066\u304a\u304d\u307e\u3059\u3002\n\n\u306a\u304a\u3001\u3053\u3053\u3067\u306f\u30bd\u30fc\u30b9\u304b\u3089\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u65b9\u6cd5\u3092\u3068\u308a\u3042\u3052\u307e\u3059\u3002\u7279\u306b\u8a18\u8ff0\u304c\u306a\u3051\u308c\u3070\u3001\u5bfe\u8c61\u30d0\u30fc\u30b8\u30e7\u30f3\u306f2.7\u3067\u3059\u3002\n\n# HTTP\u30ea\u30af\u30a8\u30b9\u30c8\uff0f\u30ec\u30b9\u30dd\u30f3\u30b9\u30d8\u30c3\u30c0\u30b5\u30a4\u30ba\u306e\u5236\u9650\u3092\u5909\u66f4\u3059\u308b\nPound\u306f\u3001\u30c7\u30d5\u30a9\u30eb\u30c8\u3067\u306fHTTP\u30ea\u30af\u30a8\u30b9\u30c8\uff0f\u30ec\u30b9\u30dd\u30f3\u30b9\u30d8\u30c3\u30c0\u30b5\u30a4\u30ba\u306e\u4e0a\u9650\u304c4096\u30d0\u30a4\u30c8\u3067\u3059\u3002\n\u901a\u5e38\u306f\u3053\u308c\u3067\u554f\u984c\u306a\u3044\u306f\u305a\u3067\u3059\u304c\u3001\u9577\u3044cookie\u3092\u767a\u884c\u3059\u308b\u306a\u3069\u3067\u30b5\u30a4\u30ba\u304c\u8d85\u904e\u3057\u3001\u80cc\u5f8c\u306eWeb\u30b5\u30fc\u30d0\u3067\u7a3c\u50cd\u3057\u3066\u3044\u308b\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306a\u3069\u304c\u6b63\u3057\u304f\u52d5\u4f5c\u3057\u306a\u3044\u3053\u3068\u304c\u3042\u308a\u307e\u3059\u3002\n\nApache\u306a\u3069\u3067\u306f\u8a2d\u5b9a\u3067\u4e0a\u9650\u3092\u5909\u66f4\u3067\u304d\u307e\u3059\u304c\u3001Pound\u306e\u5834\u5408\u306fconfigure\u3067\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u6307\u5b9a\u3057\u3066make\u3057\u76f4\u3059\u3053\u3068\u306b\u306a\u308a\u307e\u3059\u3002\n\n\uff08\u4ee5\u4e0b\u3001\u30ab\u30ec\u30f3\u30c8\u304c\u30bd\u30fc\u30b9\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u5185\u306b\u306a\u3063\u3066\u3044\u308b\u524d\u63d0\u3067\u3002\u30bd\u30fc\u30b9\u5c55\u958b\u6642\u306eowner\u306b\u6ce8\u610f\u3057\u3066\u3002\uff09\n\n```\n$ make clean\n$ ./configure --with-maxbuf=\u3010\u8a2d\u5b9a\u3059\u308b\u30d0\u30a4\u30c8\u6570\u3011 --with-ssl --with-dh=2048\n$ make\n$ sudo make install\n```\n\u203b\u672c\u6765\u306f\u30ea\u30af\u30a8\u30b9\u30c8\u7b49\u3092\u51e6\u7406\u3059\u308b\u305f\u3081\u306e\u30d0\u30c3\u30d5\u30a1\u30b5\u30a4\u30ba\u306e\u6307\u5b9a\u3067\u3059\u304c\u3001HTTP\u30ea\u30af\u30a8\u30b9\u30c8\uff0f\u30ec\u30b9\u30dd\u30f3\u30b9\u30d8\u30c3\u30c0\u3068\u3057\u3066\u51e6\u7406\u3067\u304d\u308b\u30b5\u30a4\u30ba\u304c\u3053\u306e\u30d0\u30c3\u30d5\u30a1\u30b5\u30a4\u30ba\u306e\u5236\u9650\u3092\u53d7\u3051\u308b\u305f\u3081\u3001\u3053\u3053\u3092\u8abf\u6574\u3057\u307e\u3059\u3002\n\n# \u9375\u4ea4\u63db\u306bECDHE\u3092\u4f7f\u3046\n\u9375\u4ea4\u63db\u306bECDHE\u3092\u4f7f\u3046\u8a2d\u5b9a\u3067\u3059\u3002PFS\uff08Perfect Forward Secrecy\uff09\u5bfe\u5fdc\u3068\u306a\u308b\u306e\u3067\u3001TLS\u901a\u4fe1\u304c\u3088\u308a\u30bb\u30ad\u30e5\u30a2\u306b\u306a\u308a\u307e\u3059\u3002\n\n\u307e\u305f\u3001iPhone\u30a2\u30d7\u30ea\uff08iOS9\u4ee5\u4e0a\uff09\u304b\u3089\u547c\u3073\u51fa\u3059\u30b5\u30fc\u30d0API\u3092\u80cc\u5f8c\u306b\u7f6e\u304f\u3068\u304d\u306b\u3001ATS\uff08App Transport Security\uff09\u306e\u5236\u9650\u306b\u5f15\u3063\u304b\u304b\u3063\u3066TLS\u901a\u4fe1\u3067\u304d\u306a\u3044\u30fb\u30a2\u30d7\u30ea\u306e\u5be9\u67fb\u3067\u30ea\u30b8\u30a7\u30af\u30c8\u3055\u308c\u308b\u2026\u3068\u3044\u3046\u4e8b\u614b\u3092\u907f\u3051\u308b\u305f\u3081\u306b\u5fc5\u8981\u306b\u306a\u308a\u307e\u3059\uff08Pound 2.7\u304b\u3089\u306e\u6a5f\u80fd\u3067\u3059\uff09\u3002\n\n\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3078\u306e\u8a18\u8ff0\u3067\u5bfe\u5fdc\u3057\u307e\u3059\u3002\n\n```text:pound.cfg\uff08\u4e00\u90e8\u629c\u7c8b\uff09\nECDHcurve   \"prime256v1\"\n\nListenHTTPS\n        Address                     \u3010\u5f85\u3061\u53d7\u3051IP\u30a2\u30c9\u30ec\u30b9\u3011\n        Port                        443\n        Cert                        \"\u3010\u8a3c\u660e\u66f8\u30d5\u30a1\u30a4\u30eb\u306e\u30d1\u30b9\u3011\"\n        Disable                     SSLv3\n        SSLAllowClientRenegotiation 0\n        SSLHonorCipherOrder         1\n        Ciphers                     \"EECDH+ECDSA+AESGCM:EECDH+aRSA+AESGCM:EECDH+ECDSA+SHA384:EECDH+ECDSA+SHA256:EECDH+aRSA+SHA384:EECDH+aRSA+SHA256:EECDH:EDH+aRSA:-RC4:!aNULL:!eNULL:!LOW:!3DES:!MD5:!EXP:!PSK:!SRP:!DSS\"\n\n\uff08\u4ee5\u4e0b\u7565\uff09\n```\n\n\u6697\u53f7\u30b9\u30a4\u30fc\u30c8\u306e\u6307\u5b9a\u306f\u9069\u5b9c\u8abf\u6574\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n# \u30d7\u30ed\u30c8\u30b3\u30eb\u3068\u6697\u53f7\u30b9\u30a4\u30fc\u30c8\u306e\u6307\u5b9a\u306b\u3064\u3044\u3066\nApache\u3084Nginx\u3068OpenSSL\u3092\u7d44\u307f\u5408\u308f\u305b\u3066\u4f7f\u3063\u3066\u3044\u308b\u4eba\u306b\u3068\u3063\u3066\u306f\u5f53\u305f\u308a\u524d\u306e\u8a71\u3060\u3068\u601d\u3044\u307e\u3059\u304c\u3001Pound\u306f2.6\u307e\u3067\u30d7\u30ed\u30c8\u30b3\u30eb\u306e\u6307\u5b9a\u3092\u3059\u308b\u8a2d\u5b9a\u9805\u76ee\u304c\u306a\u304b\u3063\u305f\u3053\u3068\u3068\u3001SSL 2.0\u306e\u7121\u52b9\u5316\u306f\u6697\u53f7\u30b9\u30a4\u30fc\u30c8\u306e\u6307\u5b9a\u3067\u884c\u3063\u3066\u3044\u305f\u306e\u3067\u3001\u3082\u3057\u304b\u3059\u308b\u3068\u52d8\u9055\u3044\u304c\u3042\u308b\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u3002\n\n\u8106\u5f31\u6027\u5bfe\u51e6\u306e\u305f\u3081\u306bSSL 3.0\u307e\u3067\u3092\u7121\u52b9\u5316\u3059\u308b\u5834\u5408\u3001\u30d7\u30ed\u30c8\u30b3\u30eb\u306e\u7121\u52b9\u5316\u6307\u5b9a\uff08Disable\uff09\u3067SSLv3\u3092\u7121\u52b9\u306b\u3059\u308b\u306e\u304c\u6b63\u3057\u3044\u306e\u3067\u3059\u304c\u3001Pound 2.6\u307e\u3067\u3053\u306e\u9805\u76ee\u304c\u306a\u304b\u3063\u305f\u305f\u3081\u3001\u5834\u5408\u306b\u3088\u3063\u3066\u306f\u6697\u53f7\u30b9\u30a4\u30fc\u30c8\u306e\u6307\u5b9a\uff08Ciphers\uff09\u3067SSLv3\u3092\u7121\u52b9\u5316\uff08!SSLv3\u3084-SSLv3\uff09\u3057\u3066\u3057\u307e\u3063\u3066\u3044\u308b\u30b1\u30fc\u30b9\u304c\u3042\u308b\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u3002\n\n\u6697\u53f7\u30b9\u30a4\u30fc\u30c8\u306e\u6307\u5b9a\u3067SSLv3\u3092\u7121\u52b9\u5316\u3059\u308b\u3068\u3001SSL 3.0\u3060\u3051\u3067\u306f\u306a\u304f\u3001TLS 1.0\u3084TLS 1.1\u3082\u5229\u7528\u3067\u304d\u306a\u304f\u306a\u3063\u3066\u3057\u307e\u3044\u307e\u3059\u3002\n\n\u306a\u304a\u3001Pound 2.7\u3067\u306f\u3001\u30c7\u30d5\u30a9\u30eb\u30c8\u3067\u300cDisable SSLv3\u300d\u304c\u6307\u5b9a\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u306b\u306a\u3063\u3066\u3044\u308b\u306e\u3067\u3001\u7279\u306b\u8a2d\u5b9a\u3092\u66f8\u304d\u52a0\u3048\u308b\u3053\u3068\u306a\u304f\u3001SSL 3.0\u306f\u7121\u52b9\u5316\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n\n# \u30bd\u30fc\u30b9\u304b\u3089\u4e0a\u66f8\u304d\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u3068\u304d\u306e\u6ce8\u610f\nPound\u3092\u30d0\u30fc\u30b8\u30e7\u30f3\u30a2\u30c3\u30d7\u3057\u305f\u308a\u3001configure\u306e\u30d1\u30e9\u30e1\u30fc\u30bf\u6307\u5b9a\u3092\u5909\u3048\u305f\u3044\u3068\u304d\u306e\u6ce8\u610f\u70b9\u3067\u3059\u3002\n\u30b5\u30fc\u30d3\u30b9\u505c\u6b62\u6642\u9593\u3092\u77ed\u304f\u3057\u305f\u3044\u3068\u8003\u3048\u308b\u3042\u307e\u308a\u3001\u30b5\u30fc\u30d3\u30b9\u3092\u6b62\u3081\u305a\u306b\u300cmake install\u300d\u3057\u3001\u305d\u308c\u304b\u3089\u30b5\u30fc\u30d3\u30b9\u306e\u518d\u8d77\u52d5\u3092\u3057\u3066\u3057\u307e\u3046\u3068\u3001\u5f53\u7136\u3067\u3059\u304c\u7570\u5e38\u304c\u767a\u751f\u3057\u307e\u3059\u3002\n\n\u300cDH\u30d1\u30e9\u30e1\u30fc\u30bf\u306e\u751f\u6210\u306b\u6642\u9593\u304c\u304b\u304b\u308b\u304b\u3089make\u5f8c\u306b\u30b5\u30fc\u30d3\u30b9\u3092\u505c\u6b62\u3057\u305f\u3044\u300d\u5834\u5408\u3067\u3082\u3001\u5fc5\u305a\u3001\u30b5\u30fc\u30d3\u30b9\u3092\u505c\u6b62\uff08\u300cservice pound stop\u300d\u306a\u3069\uff09\u3057\u3066\u304b\u3089\u300cmake install\u300d\u3057\u3001\u305d\u306e\u5f8c\u30b5\u30fc\u30d3\u30b9\u3092\u8d77\u52d5\uff08\u300cservice pound start\u300d\u306a\u3069\uff09\u3057\u307e\u3059\u3002\n\u300cmake install\u300d\u306f\u30d5\u30a1\u30a4\u30eb\u3092\u30b3\u30d4\u30fc\u3057\u3066\u3044\u308b\u3060\u3051\u306a\u306e\u3067\u3001\u6240\u8981\u6642\u9593\u306f\u308f\u305a\u304b\u3067\u3059\u3002\u5b89\u5fc3\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n\u305f\u3060\u3001\u3061\u3087\u3063\u3068\u5384\u4ecb\u306a\u306e\u306f\u3001\u624b\u9806\u3092\u9593\u9055\u3048\u305f\u5834\u5408\u306b\u300c\u8d77\u52d5\u305b\u305a\u306b\u505c\u6b62\u3057\u3066\u3057\u307e\u3046\u300d\u306e\u3067\u306f\u306a\u304f\u3001\u300c\u4e00\u898b\u6b63\u5e38\u306b\u8d77\u52d5\u3057\u3066\u3044\u308b\u3088\u3046\u306b\u898b\u3048\u308b\u304c\u3001\u4e00\u90e8\u306e\u6697\u53f7\u30b9\u30a4\u30fc\u30c8\u304c\u4f7f\u3048\u306a\u3044\u300d\u72b6\u614b\u306b\u306a\u308b\u3053\u3068\u3067\u3059\u3002\n\n[\u3053\u3061\u3089](http://www.apsis.ch/pound/pound_list/archive/2016/2016-03/1457022333000)\u306e\u30e1\u30fc\u30ea\u30f3\u30b0\u30ea\u30b9\u30c8\u3067\u8cea\u554f\u3055\u308c\u3066\u3044\u308b\u65b9\u306f\u3001\u3069\u3046\u3084\u3089\u3053\u306e\u30df\u30b9\u3092\u72af\u3057\u3066\u3057\u307e\u3063\u305f\u3088\u3046\u3067\u3059\uff08\u305f\u3076\u3093\uff09\u3002\n\n\u3046\u3063\u304b\u308a\u3084\u3063\u3066\u3057\u307e\u3063\u305f\u5834\u5408\u306f\u3001\u5bfe\u8c61\u30d7\u30ed\u30bb\u30b9\u3092kill\u3057\u3066\uff08-9\u306f\u4e0d\u8981\uff09\u3001\u3042\u3089\u305f\u3081\u3066\u30b5\u30fc\u30d3\u30b9\u3092\u8d77\u52d5\u3059\u308b\u304b\u3001OS\u3092\u518d\u8d77\u52d5\u3059\u308b\u3068\u3001\u6b63\u5e38\u306a\u72b6\u614b\u306b\u306a\u308a\u307e\u3059\u3002\n\n# HSTS\u306b\u5bfe\u5fdc\u3059\u308b\n\u4e2d\u9593\u8005\u653b\u6483\u306b\u3088\u308b\u4e0d\u6b63\u30b5\u30a4\u30c8\u3078\u306e\u30ea\u30c0\u30a4\u30ec\u30af\u30c8\u3084\u3001\u30bb\u30c3\u30b7\u30e7\u30f3\u30cf\u30a4\u30b8\u30e3\u30c3\u30af\u306a\u3069\u3092\u9632\u3050\u30fb\u8efd\u6e1b\u3059\u308b\u4ed5\u7d44\u307f\u3068\u3057\u3066\u3001[HSTS](https://developer.mozilla.org/ja/docs/Web/Security/HTTP_Strict_Transport_Security)\uff08HTTP Strict Transport Security\uff09\u304c\u3042\u308a\u307e\u3059\u3002\n\nHSTS\u95a2\u9023\u306e\u8a2d\u5b9a\u6a5f\u80fd\u306f\u3001Pound 2.7\u306estable\u7248\u306b\u306f\u63a1\u7528\u3055\u308c\u306a\u304b\u3063\u305f\u3088\u3046\u3067\u3059\u304c\u3001[2.7c\u7528\u306e\u30d1\u30c3\u30c1](http://www.apsis.ch/pound/pound_list/archive/2014/2014-09/1411468078000)\u304c\u3042\u308b\u306e\u3067\u3001stable\u7248\u306b\u9069\u7528\u3067\u304d\u308b\u3088\u3046\u3001\u4fee\u6b63\u3057\u3066\u307f\u307e\u3057\u305f\u3002\n\n```text:pound_27_sts.patch\ndiff -uprN Pound-2.7.original/config.c Pound-2.7/config.c\n--- Pound-2.7.original/config.c 2015-01-27 01:47:53.000000000 +0900\n+++ Pound-2.7/config.c  2016-07-06 18:31:24.148061328 +0900\n@@ -76,7 +76,7 @@ static CODE facilitynames[] = {\n static regex_t  Empty, Comment, User, Group, RootJail, Daemon, LogFacility, LogLevel, Alive, SSLEngine, Control;\n static regex_t  ListenHTTP, ListenHTTPS, End, Address, Port, Cert, xHTTP, Client, CheckURL;\n static regex_t  Err414, Err500, Err501, Err503, MaxRequest, HeadRemove, RewriteLocation, RewriteDestination;\n-static regex_t  Service, ServiceName, URL, HeadRequire, HeadDeny, BackEnd, Emergency, Priority, HAport, HAportAddr;\n+static regex_t  Service, ServiceName, URL, HeadRequire, HeadDeny, BackEnd, Emergency, Priority, HAport, HAportAddr, StrictTransportSecurity;\n static regex_t  Redirect, RedirectN, TimeOut, Session, Type, TTL, ID, DynScale;\n static regex_t  ClientCert, AddHeader, DisableProto, SSLAllowClientRenegotiation, SSLHonorCipherOrder, Ciphers;\n static regex_t  CAlist, VerifyList, CRLlist, NoHTTPS11, Grace, Include, ConnTO, IgnoreCase, HTTPS;\n@@ -564,6 +564,7 @@ parse_service(const char *svc_name)\n     memset(res, 0, sizeof(SERVICE));\n     res->sess_type = SESS_NONE;\n     res->dynscale = dynscale;\n+    res->sts = -1;\n     pthread_mutex_init(&res->mut, NULL);\n     if(svc_name)\n         strncpy(res->name, svc_name, KEY_SIZE);\n@@ -625,6 +626,8 @@ parse_service(const char *svc_name)\n             lin[matches[1].rm_eo] = '\\0';\n             if(regcomp(&m->pat, lin + matches[1].rm_so, REG_ICASE | REG_NEWLINE | REG_EXTENDED))\n                 conf_err(\"HeadDeny bad pattern - aborted\");\n+        } else if(!regexec(&StrictTransportSecurity, lin, 4, matches, 0)) {\n+            res->sts = atoi(lin + matches[1].rm_so);\n         } else if(!regexec(&Redirect, lin, 4, matches, 0)) {\n             if(res->backends) {\n                 for(be = res->backends; be->next; be = be->next)\n@@ -851,12 +854,16 @@ parse_HTTP(void)\n         } else if(!regexec(&LogLevel, lin, 4, matches, 0)) {\n             res->log_level = atoi(lin + matches[1].rm_so);\n         } else if(!regexec(&Service, lin, 4, matches, 0)) {\n-            if(res->services == NULL)\n+            if(res->services == NULL) {\n                 res->services = parse_service(NULL);\n-            else {\n+                if(res->services->sts >= 0)\n+                    conf_err(\"StrictTransportSecurity not allowed in HTTP listener - aborted\");\n+            } else {\n                 for(svc = res->services; svc->next; svc = svc->next)\n                     ;\n                 svc->next = parse_service(NULL);\n+                if(svc->next->sts >= 0)\n+                    conf_err(\"StrictTransportSecurity not allowed in HTTP listener - aborted\");\n             }\n         } else if(!regexec(&ServiceName, lin, 4, matches, 0)) {\n             lin[matches[1].rm_eo] = '\\0';\n@@ -1469,6 +1476,7 @@ config_parse(const int argc, char **cons\n     || regcomp(&URL, \"^[ \\t]*URL[ \\t]+\\\"(.+)\\\"[ \\t]*$\", REG_ICASE | REG_NEWLINE | REG_EXTENDED)\n     || regcomp(&HeadRequire, \"^[ \\t]*HeadRequire[ \\t]+\\\"(.+)\\\"[ \\t]*$\", REG_ICASE | REG_NEWLINE | REG_EXTENDED)\n     || regcomp(&HeadDeny, \"^[ \\t]*HeadDeny[ \\t]+\\\"(.+)\\\"[ \\t]*$\", REG_ICASE | REG_NEWLINE | REG_EXTENDED)\n+    || regcomp(&StrictTransportSecurity, \"^[ \\t]*StrictTransportSecurity[ \\t]+([0-9]+)[ \\t]*$\", REG_ICASE | REG_NEWLINE | REG_EXTENDED)\n     || regcomp(&BackEnd, \"^[ \\t]*BackEnd[ \\t]*$\", REG_ICASE | REG_NEWLINE | REG_EXTENDED)\n     || regcomp(&Emergency, \"^[ \\t]*Emergency[ \\t]*$\", REG_ICASE | REG_NEWLINE | REG_EXTENDED)\n     || regcomp(&Priority, \"^[ \\t]*Priority[ \\t]+([1-9])[ \\t]*$\", REG_ICASE | REG_NEWLINE | REG_EXTENDED)\n@@ -1639,6 +1647,7 @@ config_parse(const int argc, char **cons\n     regfree(&URL);\n     regfree(&HeadRequire);\n     regfree(&HeadDeny);\n+    regfree(&StrictTransportSecurity);\n     regfree(&BackEnd);\n     regfree(&Emergency);\n     regfree(&Priority);\ndiff -uprN Pound-2.7.original/http.c Pound-2.7/http.c\n--- Pound-2.7.original/http.c   2015-01-27 01:47:53.000000000 +0900\n+++ Pound-2.7/http.c    2016-07-06 18:37:45.584260067 +0900\n@@ -1382,6 +1382,8 @@ do_http(thr_arg *arg)\n             if(!no_cont && !regexec(&RESP_IGN, response, 0, NULL, 0))\n                 no_cont = 1;\n\n+            for(n = 0; n < MAXHEADERS; n++)\n+                headers_ok[n] = 1;\n             for(chunked = 0, cont = -1L, n = 1; n < MAXHEADERS && headers[n]; n++) {\n                 switch(check_header(headers[n], buf)) {\n                 case HEADER_CONNECTION:\n@@ -1432,6 +1434,11 @@ do_http(thr_arg *arg)\n                         }\n                     }\n                     break;\n+                case HEADER_STRICT_TRANSPORT_SECURITY:\n+                    /* enforce pound's STS header */\n+                    if(svc->sts >= 0)\n+                        headers_ok[n] = 0;\n+                    break;\n                 }\n             }\n\n@@ -1441,6 +1448,8 @@ do_http(thr_arg *arg)\n             /* send the response */\n             if(!skip)\n                 for(n = 0; n < MAXHEADERS && headers[n]; n++) {\n+                    if(!headers_ok[n])\n+                        continue;\n                     if(BIO_printf(cl, \"%s\\r\\n\", headers[n]) <= 0) {\n                         if(errno) {\n                             addr2str(caddr, MAXBUF - 1, &from_host, 1);\n@@ -1452,6 +1461,8 @@ do_http(thr_arg *arg)\n                     }\n                 }\n             free_headers(headers);\n+            if(!skip && ssl && svc->sts >= 0)\n+                BIO_printf(cl, \"Strict-Transport-Security: max-age=%d\\r\\n\", svc->sts);\n\n             /* final CRLF */\n             if(!skip)\ndiff -uprN Pound-2.7.original/pound.h Pound-2.7/pound.h\n--- Pound-2.7.original/pound.h  2015-01-27 01:47:53.000000000 +0900\n+++ Pound-2.7/pound.h   2016-07-06 18:41:18.769273399 +0900\n@@ -370,6 +370,7 @@ typedef struct _service {\n #endif\n     int                 dynscale;   /* true if the back-ends should be dynamically rescaled */\n     int                 disabled;   /* true if the service is disabled */\n+    int                 sts;        /* strict transport security */\n     struct _service     *next;\n }   SERVICE;\n\n@@ -441,6 +442,7 @@ typedef enum { RENEG_INIT=0, RENEG_REJEC\n #define HEADER_URI                  9\n #define HEADER_DESTINATION          10\n #define HEADER_EXPECT               11\n+#define HEADER_STRICT_TRANSPORT_SECURITY 12\n\n /* control request stuff */\n typedef enum    {\ndiff -uprN Pound-2.7.original/svc.c Pound-2.7/svc.c\n--- Pound-2.7.original/svc.c    2015-01-27 01:47:53.000000000 +0900\n+++ Pound-2.7/svc.c     2016-07-06 18:42:10.738253739 +0900\n@@ -395,6 +395,7 @@ check_header(const char *header, char *c\n         { \"User-agent\",         10, HEADER_USER_AGENT },\n         { \"Destination\",        11, HEADER_DESTINATION },\n         { \"Expect\",             6,  HEADER_EXPECT },\n+        { \"Strict-Transport-Security\", 25, HEADER_STRICT_TRANSPORT_SECURITY },\n         { \"\",                   0,  HEADER_OTHER },\n     };\n     int i;\n```\n\uff08\u3059\u307f\u307e\u305b\u3093\u3001GitHub\u9023\u643a\u3057\u3066\u306a\u3044\u306e\u3067\u3001\u30b3\u30d4\u30da\u3057\u3066\u4f7f\u3063\u3066\u304f\u3060\u3055\u3044\u3002\uff09\n\nPound\u306e\u30bd\u30fc\u30b9\u3092\u5c55\u958b\u3057\u305f\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306e1\u968e\u5c64\u4e0a\u3067\u3001\u4ee5\u4e0b\u306e\u3068\u304a\u308a\u306b\u9069\u7528\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n```\n$ patch -p1 -d Pound-2.7 < pound_27_sts.patch\n```\n\n\u306a\u304a\u3001\u30ea\u30f3\u30af\u5143\u306e\u8a18\u8ff0\u306b\u3042\u308b\u3068\u304a\u308a\u3001\u3053\u306e\u30d1\u30c3\u30c1\u306b\u306f\u3001\u300cincludeSubDomains\u30aa\u30d7\u30b7\u30e7\u30f3\u304c\u4f7f\u3048\u306a\u3044\u300d\uff08\uff1d\u653b\u6483\u5bfe\u7b56\u3068\u3057\u3066\u306f\u4e00\u90e8\u4e0d\u5341\u5206\u306a\u3068\u3053\u308d\u304c\u3042\u308b\uff09\u3001\u300cHTTPListener\u3067\u51e6\u7406\u3059\u308b\u30ea\u30af\u30a8\u30b9\u30c8\u306b\u3064\u3044\u3066HSTS\u30d8\u30c3\u30c0\u3092\u9664\u53bb\u3057\u306a\u3044\u300d\u306a\u3069\u306e\u5236\u7d04\u304c\u3042\u308a\u307e\u3059\u3002\n\n\u307e\u305f\u3001\u30ea\u30f3\u30af\u5143\u306e\u8a18\u8ff0\u3067\u306f\u300cHTTPSListeners\uff08ListenHTTPS\u30c7\u30a3\u30ec\u30af\u30c6\u30a3\u30d6\uff09\u306e\u5185\u5074\u306b\u8a18\u8ff0\u3057\u3066\u306d\u300d\u3068\u3044\u3046\u3088\u3046\u306a\u3053\u3068\u304c\u66f8\u304b\u308c\u3066\u3044\u307e\u3059\u304c\u3001\u6b63\u78ba\u306b\u306f\u3001\u3055\u3089\u306b\u305d\u306e\u4e2d\u306e\u3001Service\u30c7\u30a3\u30ec\u30af\u30c6\u30a3\u30d6\u306e\u5185\u5074\u306b\u8a2d\u5b9a\uff08\u300cStrictTransportSecurity \u6709\u52b9\u671f\u9593\uff1d\u79d2\u6570\u300d\uff09\u3092\u8a18\u8ff0\u3057\u307e\u3059\u3002\n\n```text:pound.cfg\uff08\u4e00\u90e8\u629c\u7c8b\uff09\nECDHcurve   \"prime256v1\"\n\nListenHTTPS\n        Address                     \u3010\u5f85\u3061\u53d7\u3051IP\u30a2\u30c9\u30ec\u30b9\u3011\n        Port                        443\n        Cert                        \"\u3010\u8a3c\u660e\u66f8\u30d5\u30a1\u30a4\u30eb\u306e\u30d1\u30b9\u3011\"\n        Disable                     SSLv3\n        SSLAllowClientRenegotiation 0\n        SSLHonorCipherOrder         1\n        Ciphers                     \"EECDH+ECDSA+AESGCM:EECDH+aRSA+AESGCM:EECDH+ECDSA+SHA384:EECDH+ECDSA+SHA256:EECDH+aRSA+SHA384:EECDH+aRSA+SHA256:EECDH:EDH+aRSA:-RC4:!aNULL:!eNULL:!LOW:!3DES:!MD5:!EXP:!PSK:!SRP:!DSS\"\n\n        Service\n                StrictTransportSecurity 31536000\n\n\uff08\u4ee5\u4e0b\u7565\uff09\n```\n\n\u4ee5\u4e0a\u3001\u4f7f\u3063\u3066\u3044\u308b\u65b9\u306f\u5c11\u306a\u3044\u3068\u601d\u3044\u307e\u3059\u304c\u3001Pound\u306e\u5c0f\u30cd\u30bf\u96c6\u3067\u3057\u305f\u3002\n", "tags": ["pound", "openssl", "Linux"]}