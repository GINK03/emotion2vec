{"tags": ["Node.js", "JavaScript", "ECMAScript6", "generator", "promise"], "context": " \u3053\u306e\u8a18\u4e8b\u306f\u6700\u7d42\u66f4\u65b0\u65e5\u304b\u30891\u5e74\u4ee5\u4e0a\u304c\u7d4c\u904e\u3057\u3066\u3044\u307e\u3059\u3002\uff082015/10/21\u8ffd\u8a18\uff09\n\u8a18\u4e8b\u3092\u66f8\u3044\u3066\u304b\u3089\u534a\u5e74\u7d4c\u3061\u307e\u3057\u305f\u304c\u3001\u6700\u8fd1\u306fRx\u306e\u826f\u3055\u3092\u7406\u89e3\u3057\u305f\u308a\u3001ES7\u306easync/await\u304cbabel\u306b\u3088\u3063\u3066\u5b9f\u7528\u7684\u306b\u306a\u308a\u3064\u3064\u3042\u3063\u305f\u308a\u7b49\u3001\u307e\u305f\u3082\u3084\u30d9\u30b9\u30c8\u30d7\u30e9\u30af\u30c6\u30a3\u30b9\u3068\u306f\u306a\u3093\u3060\u3063\u305f\u306e\u304b\u72b6\u614b\u3067\u3059\u3002\u3068\u306f\u3044\u3048\u3001\u3044\u307e\u306e\u3068\u3053\u308dPromise\u306f\u975e\u540c\u671f\u51e6\u7406\u306e\u571f\u53f0\u3067\u3042\u308a\u7d9a\u3051\u305d\u3046\u3067\u3059\u3057\u3001Generator\u3082async/await\u3078\u306e\u8db3\u304c\u304b\u308a\u3068\u3057\u3066\u77e5\u3063\u3066\u304a\u304f\u3053\u3068\u306e\u30e1\u30ea\u30c3\u30c8\u306f\u5927\u304d\u3044\u304b\u3068\u601d\u3044\u307e\u3059\u306e\u3067\u3001\u5f15\u304d\u7d9a\u304d\u516c\u958b\u3055\u305b\u305f\u307e\u307e\u3068\u3055\u305b\u3066\u9802\u304d\u307e\u3059\u3002\n\uff08\u8ffd\u8a18\u3053\u3053\u307e\u3067\uff09\n\u6570\u3042\u308b\u975e\u540c\u671f\u51e6\u7406\u306e\u30d7\u30e9\u30af\u30c6\u30a3\u30b9\u3092\u8a66\u3057\u3066\u307f\u3066\u3001\u3060\u3044\u305f\u3044\u3053\u308c\u304c\u826f\u3044\u3093\u3058\u3083\u306a\u3044\u304b\u3068\u3044\u3046\u30d1\u30bf\u30fc\u30f3\u304c\u56fa\u307e\u3063\u305f\u306e\u3067\u66f8\u304d\u307e\u3059\u3002\u52b9\u7528\u306f\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u5730\u7344\u304b\u3089\u306e\u8131\u51fa\u3068\u7d50\u5c40\u975e\u540c\u671f\u3069\u308c\u304c\u826f\u3044\u306e\u611f\u306e\u6255\u62ed\u3002ES6\u5bc4\u308a\u3067\u3059\u3002\n\n\u524d\u63d0\u77e5\u8b58\nJavaScript Promise\u306e\u672c\nhttp://azu.github.io/promises-book/\n\u30b8\u30a7\u30cd\u30ec\u30fc\u30bf\u306e\u89e3\u8aac\u3068\u975e\u540c\u671f\u3078\u306e\u9069\u7528 - Block Rockin\u2019 Codes\nhttp://jxck.hatenablog.com/entry/2014-01-12/generator-screencaset\n\n\u7d50\u8ad6\n1.\u57fa\u672c\u306f\u5168\u3066Promise\u3067\u304f\u308b\u3080\u3002\n2.\u4e26\u5217\u51e6\u7406\u306fPromise.all\u3002\n3.\u76f4\u5217\u51e6\u7406\u306f1\u3092\u3055\u3089\u306bGenerator\u3067\u5305\u3080\u3002\n\uff08\u8ffd\u8a18\uff092,3\u306f\u3042\u304f\u307e\u3067\u304a\u3059\u3059\u3081\u3002\u8a73\u3057\u304f\u306f\u307e\u3068\u3081\u3068\u8ffd\u8a18\u3092\u3069\u3046\u305e\u3002\n\nExample\n\n\u3042\u308b\u975e\u540c\u671f\u51e6\u7406\nfunction p(str) {\n  setTimeout(function() {\n    resolve(str);\n  }, 1000);\n}\n\n\u307e\u305a\u306fPromise\u3067\u304f\u308b\u3080\u3002\nfunction p(str) {\n  return new Promise(function(resolve) {\n    setTimeout(function() {\n      resolve(str);\n    }, 1000);\n  });\n}\n\n\u6e96\u5099ok\u3002\n\n\u57fa\u672c\u547c\u3073\u51fa\u3057\n\npromise.js\np('Async 1').then(function(result) {\n  console.log(result);\n});\n\nconsole.log('Sync 1');\n\n\n\u5b9f\u884c\u7d50\u679c\n$ time node --harmony promise.js\nSync 1\nAsync 1\n# node --harmony promise.js  0.05s user 0.05s system 8% cpu 1.179 total\n\n\n\u4e26\u5217\u51e6\u7406\nPromise.all\u3092\u4f7f\u3046\u3002\n\npromise.js\nvar tasks = [\n  p('Async 1'),\n  p('Async 2'),\n  p('Async 3')\n];\nPromise.all(tasks).then(function(results) {\n  console.log(results);\n});\n\nconsole.log('Sync 1');\n\n\n\u5b9f\u884c\u7d50\u679c\n$ time node --harmony promise.js\nSync 1\n[ 'Async 1', 'Async 2', 'Async 3' ]\n# node --harmony promise.js  0.07s user 0.03s system 8% cpu 1.079 total\n\n\u4e26\u5217\u51e6\u7406\u306a\u306e\u3067\u5b9f\u884c\u6642\u9593\u306f\u7d041\u79d2\uff081000ms\uff09\u3002\n\n\u76f4\u5217\u51e6\u7406\uff08\u4e0d\u63a1\u7528\uff09\n\u4e26\u5217\u51e6\u7406\u306a\u3089Promise.all\u306e\u3088\u3046\u306a\u76f4\u611f\u7684\u306aAPI\u304c\u3042\u308b\u304c\u3001\u76f4\u5217\u51e6\u7406\u306f\u3042\u307e\u308a\u7f8e\u5473\u3057\u304f\u306a\u3044\uff08\u4e0b\u8a18\uff09\u3002\n\u307e\u305a\u306f\u3088\u304f\u898b\u304b\u3051\u308b\u300c\u3042\u304f\u307e\u3067Promise\u3067\u5de5\u592b\u3059\u308b\u65b9\u6cd5\u300d\u3092\u898b\u3066\u307f\u308b\u3002\n\nArray.prototype.reduce\u3092\u4f7f\u3046\n\npromise.js\nvar tasks = [p, p, p];\nvar serial = tasks.reduce(function(promise, task, i) {\n  return promise.then(function(_) {\n    return task('Async '+ (i+1));\n  })\n}, Promise.resolve());\n\nserial.then(function(result) {\n  console.log(result);\n});\n\nconsole.log('Sync 1');\n\n\n\u5b9f\u884c\u7d50\u679c\n$ time node --harmony promise.js\nSync 1\nAsync 3\n# node --harmony promise.js  0.07s user 0.03s system 3% cpu 3.099 total\n\n\u76f4\u5217\u306a\u306e\u3067\u5b9f\u884c\u6642\u9593\u306f3\u79d2\u3002\n\u5f53\u7136\u3060\u304cserial.then()\u306b\u6e21\u3055\u308c\u3066\u304f\u308b\u30c7\u30fc\u30bf\u306f\u300c\u6700\u5f8c\u306e\u76f4\u5217\u51e6\u7406\u3067resolve()\u3055\u308c\u305f\u3082\u306e\u300d\u306a\u306e\u3067\u3001Async 3\u3057\u304b\u51fa\u529b\u3055\u308c\u3066\u3044\u306a\u3044\u3002\n\u3082\u3061\u308d\u3093\u305d\u308c\u81ea\u4f53\u306freduce\u30eb\u30fc\u30d7\u5074\u306bconsole.log\u3092\u4ed5\u8fbc\u3081\u3070\u89e3\u6c7a\u3059\u308b\u304c\u3001\u5404\u51e6\u7406\u7d50\u679c\u306b\u7570\u306a\u308b\u51e6\u7406\u3092\u65bd\u3057\u305f\u3044\u6642\u306f\u30eb\u30fc\u30d7\u306e\u4e2d\u3067\u6761\u4ef6\u5206\u5c90\u3055\u305b\u308b\u5fc5\u8981\u304c\u3042\u308b\u3002\n\u30cd\u30b9\u30c8\u5897\u3048\u308b\u3057\u3001\u304b\u3086\u3044\u3068\u3053\u308d\u306b\u624b\u304c\u5c4a\u304b\u306a\u3044\u611f\u3058\u3002\n\n\u76f4\u5217\u51e6\u7406\uff08\u63a1\u7528\uff09\n\u3068\u3044\u3046\u3053\u3068\u3067\u3001Generator\u3068co\u3092\u4f7f\u3063\u3066\u76f4\u611f\u7684\u306b\u51e6\u7406\u3059\u308b\u3002\nco\u306fpromise\u306e\u30a4\u30f3\u30bf\u30fc\u30d5\u30a7\u30a4\u30b9\u306b\u3082\u5bfe\u5fdc\u3057\u3066\u3044\u308b\u306e\u3067\u305d\u306e\u307e\u307eyield\u306b\u6e21\u3059\u3053\u3068\u304c\u51fa\u6765\u308b\u3002\n\ngenerator.js\nvar co = require('co');\nco(function *() {\n  var res1 = yield p('Async 1');\n  console.log(res1);\n\n  var res2 = yield p('Async 2');\n  console.log(res2);\n\n  var res3 = yield p('Async 3');\n  console.log(res3);\n});\n\nconsole.log('Sync 1');\n\n\n\u5b9f\u884c\u7d50\u679c\n$ time node --harmony generator.js\nSync 1\nAsync 1\nAsync 2\nAsync 3\n# node --harmony generator.js  0.06s user 0.02s system 2% cpu 3.081 total\n\n\u5b9f\u884c\u6642\u9593\u306f3\u79d2\u3001\u3061\u3083\u3093\u3068\u76f4\u5217\u306b\u51e6\u7406\u3055\u308c\u3066\u3044\u308b\u3002\n\u307e\u305f\u898b\u3066\u306e\u901a\u308a\u540c\u671f\u7684\u306b\u7e26\u306b\u66f8\u3051\u308b\u305f\u3081\u3001\u5404\u51e6\u7406\u7d50\u679c\u306b\u5bfe\u3057\u500b\u5225\u306b\u8ffd\u52a0\u51e6\u7406\u3059\u308b\u306e\u3082\u7c21\u5358\u3002\n\ngenerator.js\nvar co = require('co');\nco(function *() {\n  var res1 = yield p('aSyNc');\n  console.log(res1);\n\n  var res2 = yield p(res1.toUpperCase());\n  console.log(res2);\n\n  var res3 = yield p(res2.toLowerCase());\n  console.log(res3);\n});\n\nconsole.log('Sync');\n\n\n\u5b9f\u884c\u7d50\u679c\n$ time node --harmony generator.js\nSync\naSyNc\nASYNC\nasync\n# node --harmony generator.js  0.07s user 0.02s system 2% cpu 3.074 total\n\n\nError handling\nPromise\u306e\u30a4\u30f3\u30bf\u30fc\u30d5\u30a7\u30a4\u30b9\u3067reject&catch\u3067\u304d\u308b\u3002\nfunction p(str) {\n  return new Promise(function(_, reject) {\n    setTimeout(function() {\n      reject(new Error('err!'));\n    }, 1000);\n  });\n}\n\n\ngenerator.js\nvar co = require('co');\nco(function *() {\n  var res1 = yield p('aSyNc');\n  console.log(res1);\n\n}).catch(function(err) {\n  console.log(err.message);\n});\n\nconsole.log('Sync');\n\n\n\u5b9f\u884c\u7d50\u679c\n$ time node --harmony generator.js\nSync\nerr!\n# node --harmony generator.js  0.07s user 0.03s system 8% cpu 1.076 total\n\ngenerator\u3063\u307d\u304ftry~catch\u3067\u3082\u826f\u3044\u3051\u3069\u3001\u30cd\u30b9\u30c8\u4e00\u6bb5\u6e1b\u3089\u305b\u308b\u3053\u3061\u3089\u306e\u65b9\u304c\u597d\u307f\u3002\n\n\u307e\u3068\u3081\nPromise\u3068Generator\u306e\u4f7f\u3044\u5206\u3051\u306b\u53b3\u5bc6\u306a\u3053\u3060\u308f\u308a\u306f\u306a\u304f\u300c\u4ffa\u306f\u4e26\u5217\u51e6\u7406\u3082Generator\u300d\u3067\u3082\u826f\u3044\u3068\u601d\u3044\u307e\u3059\u3002\n\u5358\u7d14\u306bPromise.all\u306f\u4f7f\u3044\u3084\u3059\u3044\u306e\u3067\u3001\u306a\u3089\u305d\u308c\u3067\u826f\u3044\u3060\u308d\u3046\u3068\u3044\u3046\u7a0b\u5ea6\u3002\n\u3053\u306e\u8a18\u4e8b\u306e\u809d\u3068\u3057\u3066\u306f\n\nthenrable\uff08Promise\u306b\u4f7f\u3048\u308b\u30a4\u30f3\u30bf\u30fc\u30d5\u30a7\u30a4\u30b9\uff09\u306fyieldable\uff08Generator\u306b\u4f7f\u3048\u308b\u30a4\u30f3\u30bf\u30fc\u30d5\u30a7\u30a4\u30b9\uff09\u3067\u3042\u308b\n\n\u3064\u307e\u308a\u300c\u5171\u5b58\u3067\u304d\u308b\u300d\u3068\u3044\u3046\u3053\u3068\u3002\n\u5f53\u521d\u306f\u300cPromise\u304bGenerator\uff08\u304b\u751fcollback\u304basync.js\u304betc\uff09\u304b\u3089\u4e00\u3064\u3069\u308c\u3092\u9078\u3076\u304b\u300d\u3068\u3044\u3046\u89b3\u70b9\u3067\nGenerator\u4f7f\u3046\u306a\u3089\u5168\u304f\u65b0\u3057\u3044\u30a8\u30b3\u30b7\u30b9\u30c6\u30e0\u3092\u4f5c\u3089\u306a\u3051\u308c\u3070\u306a\u3089\u306a\u3044\u3001\u3068\u8003\u3048\u3066\u3044\u307e\u3057\u305f\u3002\n\u3057\u3070\u3089\u304f\u306f\u30e2\u30ea\u30e2\u30eathunkify\u3059\u308b\u65e5\u3005\u3092\u7d9a\u3051\u305f\u306e\u3067\u3059\u304c\u3001\u3053\u308c\u306f\u306a\u304b\u306a\u304b\u30ad\u30c4\u30a4\u306a\u3068\uff08\u65e2\u5b58\u8cc7\u7523\u3068\u306e\u4e56\u96e2\u304c\u5927\u304d\u3044&\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u5168\u4f53\u304cGenerator\u3067lockin\u3055\u308c\u3066\u3057\u307e\u3046\u611f\uff09\u3002\n\u305d\u308c\u304cthenrable\u306fyieldable\u306b\u6c17\u3065\u3044\u3066\u304b\u3089\u300c\u307e\u305a\u306fPromise\u300d\u3067\u826f\u3044\u3068\u5206\u304b\u3063\u3066\u3060\u3044\u3076\u6c17\u697d\u306b\u306a\u3063\u305f&\u4eca\u5f8c\u306f\u3053\u306e\u65b9\u5411\u304b\u306a\u3001\u3068\u8151\u306b\u843d\u3061\u305f\u7d4c\u7def\u304c\u3042\u308a\u307e\u3059\u3002\nco\u3082v4\u304b\u3089thunk\u3092depricated\u306b\u3057\u3066\u3044\u308b\u306e\u3067\u3001\u5272\u3068\u3053\u3093\u306a\u6d41\u308c\u306b\u306a\u308b\u3093\u3058\u3083\u306a\u3044\u304b\u306a\u3068\u601d\u3063\u3066\u3044\u307e\u3059\u3002\n\n\uff08\u8ffd\u8a18\uff09then()\u30c1\u30a7\u30a4\u30f3\u306f\uff1f\n\u305d\u3082\u305d\u3082\u76f4\u5217\u51e6\u7406\u306fthen()\u30c1\u30a7\u30a4\u30f3\u3067\u3069\u3046\uff1f\u3068\u3044\u3046\u30b3\u30e1\u30f3\u30c8\u3092\u9802\u3044\u305f\u306e\u3067\u8ffd\u8a18\u3002\n\npromise.js\np('Async 1').then(function(result) {\n  console.log(result);\n  return p('Async 2')\n}).then(function(result) {\n  console.log(result);\n  return p('Async 3')\n}).then(function(result) {\n  console.log(result);\n});\n\n\n\u5b9f\u884c\u7d50\u679c\n $ time node --harmony promise.js\nAsync 1\nAsync 2\nAsync 3\nnode --harmony promise.js  0.06s user 0.06s system 3% cpu 3.218 total\n\n\u5b8c\u5168\u306b\u898b\u305f\u76ee\u306e\u554f\u984c\u3067\u3059\u304c\u3001\n\n\u30ce\u30a4\u30ba\u304c\u81a8\u3089\u307f\u3084\u3059\u3044\uff08\u4e00\u3064\u7e4b\u3052\u308b\u305f\u3073\u306b.then(function() {})\uff09\n\u51e6\u7406\uff08p('Async')\uff09\u304c\u5de6\u53f3\u306b\u6563\u3089\u3070\u308b\n\n\u3068\u3053\u308d\u304c\u3059\u3063\u304d\u308a\u305b\u305a\u3001\u500b\u4eba\u7684\u306b\u306fGenerator\u304c\u597d\u304d\u3067\u3059\u3002\n\u597d\u304d\u5acc\u3044\u306e\u8a71\u304b\u3088\u3068\u3044\u3046\u3068\u307e\u3055\u306b\u305d\u306e\u901a\u308a\u3067\u3001\u307e\u3068\u3081\u306b\u3082\u66f8\u3044\u305f\u901a\u308a\u5927\u4e8b\u306a\u306e\u306f\u300c\u5171\u5b58\u3067\u304d\u308b\u300d\u3053\u3068\u3001\u3064\u307e\u308a\u6c17\u6301\u3088\u304f\u66f8\u3051\u308b\u65b9\u3078\u884c\u304d\u6765\u3067\u304d\u308b\u67d4\u8edf\u3055\u304c\u3042\u308b\u3053\u3068\u3060\u3068\u601d\u3044\u307e\u3059\u3002\u3068\u308a\u3042\u3048\u305a\u306fPromise\u3067\u66f8\u3044\u3066\u304a\u304d\u3001\u3061\u3087\u3063\u3068chain\u5897\u3048\u3066\u30ab\u30aa\u30b9\u306b\u306a\u3063\u3066\u304d\u305f\u304b\u3089Generator\u3044\u304f\u304b\u301c\u3001\u3082\u5168\u7136\u30a2\u30ea\u3067\u3059\u3002\u3082\u3046\u300c\u975e\u540c\u671f\u3069\u308c\u304c\u826f\u3044\u306e\u300d\u3067\u60a9\u307e\u306a\u304f\u3066\u3088\u304f\u306a\u308b\u5b89\u5fc3\u611f\u4ed8\u304d\u3002\n\u3053\u306e\u3086\u308b\u3075\u308f\u3055\u306e\u8a31\u5bb9\u304cthenrable\u306fyieldable\u306e\u3088\u3044\u3068\u3053\u308d\u3067\u3042\u308a\u3001Generator\u306e\u6577\u5c45\u3092\u5927\u304d\u304f\u4e0b\u3052\u308b\u8981\u56e0\u306b\u306a\u308b\u306e\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u3002\n\n\uff082015/10/21\u8ffd\u8a18\uff09\n\u8a18\u4e8b\u3092\u66f8\u3044\u3066\u304b\u3089\u534a\u5e74\u7d4c\u3061\u307e\u3057\u305f\u304c\u3001\u6700\u8fd1\u306f[Rx\u306e\u826f\u3055\u3092\u7406\u89e3\u3057\u305f\u308a](http://qiita.com/kidach1/items/5fd764c18de7cdae24ca)\u3001[ES7\u306easync/await\u304cbabel\u306b\u3088\u3063\u3066\u5b9f\u7528\u7684\u306b\u306a\u308a\u3064\u3064\u3042\u3063\u305f\u308a](https://babeljs.io/docs/advanced/transformers/)\u7b49\u3001\u307e\u305f\u3082\u3084\u30d9\u30b9\u30c8\u30d7\u30e9\u30af\u30c6\u30a3\u30b9\u3068\u306f\u306a\u3093\u3060\u3063\u305f\u306e\u304b\u72b6\u614b\u3067\u3059\u3002\u3068\u306f\u3044\u3048\u3001\u3044\u307e\u306e\u3068\u3053\u308dPromise\u306f\u975e\u540c\u671f\u51e6\u7406\u306e\u571f\u53f0\u3067\u3042\u308a\u7d9a\u3051\u305d\u3046\u3067\u3059\u3057\u3001Generator\u3082async/await\u3078\u306e\u8db3\u304c\u304b\u308a\u3068\u3057\u3066\u77e5\u3063\u3066\u304a\u304f\u3053\u3068\u306e\u30e1\u30ea\u30c3\u30c8\u306f\u5927\u304d\u3044\u304b\u3068\u601d\u3044\u307e\u3059\u306e\u3067\u3001\u5f15\u304d\u7d9a\u304d\u516c\u958b\u3055\u305b\u305f\u307e\u307e\u3068\u3055\u305b\u3066\u9802\u304d\u307e\u3059\u3002\n\uff08\u8ffd\u8a18\u3053\u3053\u307e\u3067\uff09\n\n\n\u6570\u3042\u308b\u975e\u540c\u671f\u51e6\u7406\u306e\u30d7\u30e9\u30af\u30c6\u30a3\u30b9\u3092\u8a66\u3057\u3066\u307f\u3066\u3001\u3060\u3044\u305f\u3044\u3053\u308c\u304c\u826f\u3044\u3093\u3058\u3083\u306a\u3044\u304b\u3068\u3044\u3046\u30d1\u30bf\u30fc\u30f3\u304c\u56fa\u307e\u3063\u305f\u306e\u3067\u66f8\u304d\u307e\u3059\u3002\u52b9\u7528\u306f\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u5730\u7344\u304b\u3089\u306e\u8131\u51fa\u3068\u7d50\u5c40\u975e\u540c\u671f\u3069\u308c\u304c\u826f\u3044\u306e\u611f\u306e\u6255\u62ed\u3002ES6\u5bc4\u308a\u3067\u3059\u3002\n\n# \u524d\u63d0\u77e5\u8b58\n\nJavaScript Promise\u306e\u672c\nhttp://azu.github.io/promises-book/\n\n\u30b8\u30a7\u30cd\u30ec\u30fc\u30bf\u306e\u89e3\u8aac\u3068\u975e\u540c\u671f\u3078\u306e\u9069\u7528 - Block Rockin\u2019 Codes\nhttp://jxck.hatenablog.com/entry/2014-01-12/generator-screencaset\n\n# \u7d50\u8ad6\n\n1.\u57fa\u672c\u306f\u5168\u3066Promise\u3067\u304f\u308b\u3080\u3002\n2.\u4e26\u5217\u51e6\u7406\u306f`Promise.all`\u3002\n3.\u76f4\u5217\u51e6\u7406\u306f1\u3092\u3055\u3089\u306bGenerator\u3067\u5305\u3080\u3002\n\n\uff08\u8ffd\u8a18\uff092,3\u306f\u3042\u304f\u307e\u3067\u304a\u3059\u3059\u3081\u3002\u8a73\u3057\u304f\u306f[\u307e\u3068\u3081](http://qiita.com/kidach1/items/d997df84a0ede39d76ad#%E3%81%BE%E3%81%A8%E3%82%81)\u3068[\u8ffd\u8a18](http://qiita.com/kidach1/items/d997df84a0ede39d76ad#%E8%BF%BD%E8%A8%98then%E3%83%81%E3%82%A7%E3%82%A4%E3%83%B3%E3%81%AF)\u3092\u3069\u3046\u305e\u3002\n\n# Example\n\n## \u3042\u308b\u975e\u540c\u671f\u51e6\u7406\n\n```js\nfunction p(str) {\n  setTimeout(function() {\n    resolve(str);\n  }, 1000);\n}\n```\n\n\u307e\u305a\u306fPromise\u3067\u304f\u308b\u3080\u3002\n\n```js\nfunction p(str) {\n  return new Promise(function(resolve) {\n    setTimeout(function() {\n      resolve(str);\n    }, 1000);\n  });\n}\n```\n\n\u6e96\u5099ok\u3002\n\n## \u57fa\u672c\u547c\u3073\u51fa\u3057\n\n```promise.js\np('Async 1').then(function(result) {\n  console.log(result);\n});\n\nconsole.log('Sync 1');\n```\n\n\u5b9f\u884c\u7d50\u679c\n\n```bash\n$ time node --harmony promise.js\nSync 1\nAsync 1\n# node --harmony promise.js  0.05s user 0.05s system 8% cpu 1.179 total\n```\n\n## \u4e26\u5217\u51e6\u7406\n\n`Promise.all`\u3092\u4f7f\u3046\u3002\n\n\n```promise.js\nvar tasks = [\n  p('Async 1'),\n  p('Async 2'),\n  p('Async 3')\n];\nPromise.all(tasks).then(function(results) {\n  console.log(results);\n});\n\nconsole.log('Sync 1');\n```\n\n\u5b9f\u884c\u7d50\u679c\n\n```bash\n$ time node --harmony promise.js\nSync 1\n[ 'Async 1', 'Async 2', 'Async 3' ]\n# node --harmony promise.js  0.07s user 0.03s system 8% cpu 1.079 total\n```\n\n\u4e26\u5217\u51e6\u7406\u306a\u306e\u3067\u5b9f\u884c\u6642\u9593\u306f\u7d041\u79d2\uff081000ms\uff09\u3002\n\n\n## \u76f4\u5217\u51e6\u7406\uff08\u4e0d\u63a1\u7528\uff09\n\n\u4e26\u5217\u51e6\u7406\u306a\u3089Promise.all\u306e\u3088\u3046\u306a\u76f4\u611f\u7684\u306aAPI\u304c\u3042\u308b\u304c\u3001\u76f4\u5217\u51e6\u7406\u306f\u3042\u307e\u308a\u7f8e\u5473\u3057\u304f\u306a\u3044\uff08\u4e0b\u8a18\uff09\u3002\n\u307e\u305a\u306f\u3088\u304f\u898b\u304b\u3051\u308b\u300c\u3042\u304f\u307e\u3067Promise\u3067\u5de5\u592b\u3059\u308b\u65b9\u6cd5\u300d\u3092\u898b\u3066\u307f\u308b\u3002\n\n\n### Array.prototype.reduce\u3092\u4f7f\u3046\n\n```promise.js\nvar tasks = [p, p, p];\nvar serial = tasks.reduce(function(promise, task, i) {\n  return promise.then(function(_) {\n    return task('Async '+ (i+1));\n  })\n}, Promise.resolve());\n\nserial.then(function(result) {\n  console.log(result);\n});\n\nconsole.log('Sync 1');\n```\n\n\u5b9f\u884c\u7d50\u679c\n\n```bash\n$ time node --harmony promise.js\nSync 1\nAsync 3\n# node --harmony promise.js  0.07s user 0.03s system 3% cpu 3.099 total\n```\n\n\u76f4\u5217\u306a\u306e\u3067\u5b9f\u884c\u6642\u9593\u306f3\u79d2\u3002\n\u5f53\u7136\u3060\u304c`serial.then()`\u306b\u6e21\u3055\u308c\u3066\u304f\u308b\u30c7\u30fc\u30bf\u306f\u300c\u6700\u5f8c\u306e\u76f4\u5217\u51e6\u7406\u3067resolve()\u3055\u308c\u305f\u3082\u306e\u300d\u306a\u306e\u3067\u3001`Async 3`\u3057\u304b\u51fa\u529b\u3055\u308c\u3066\u3044\u306a\u3044\u3002\n\n\u3082\u3061\u308d\u3093\u305d\u308c\u81ea\u4f53\u306freduce\u30eb\u30fc\u30d7\u5074\u306b`console.log`\u3092\u4ed5\u8fbc\u3081\u3070\u89e3\u6c7a\u3059\u308b\u304c\u3001\u5404\u51e6\u7406\u7d50\u679c\u306b\u7570\u306a\u308b\u51e6\u7406\u3092\u65bd\u3057\u305f\u3044\u6642\u306f\u30eb\u30fc\u30d7\u306e\u4e2d\u3067\u6761\u4ef6\u5206\u5c90\u3055\u305b\u308b\u5fc5\u8981\u304c\u3042\u308b\u3002\n\n\u30cd\u30b9\u30c8\u5897\u3048\u308b\u3057\u3001\u304b\u3086\u3044\u3068\u3053\u308d\u306b\u624b\u304c\u5c4a\u304b\u306a\u3044\u611f\u3058\u3002\n\n\n## \u76f4\u5217\u51e6\u7406\uff08\u63a1\u7528\uff09\n\n\u3068\u3044\u3046\u3053\u3068\u3067\u3001Generator\u3068co\u3092\u4f7f\u3063\u3066\u76f4\u611f\u7684\u306b\u51e6\u7406\u3059\u308b\u3002\n[co\u306fpromise\u306e\u30a4\u30f3\u30bf\u30fc\u30d5\u30a7\u30a4\u30b9\u306b\u3082\u5bfe\u5fdc\u3057\u3066\u3044\u308b](https://github.com/tj/co#yieldables)\u306e\u3067\u305d\u306e\u307e\u307eyield\u306b\u6e21\u3059\u3053\u3068\u304c\u51fa\u6765\u308b\u3002\n\n```generator.js\nvar co = require('co');\nco(function *() {\n  var res1 = yield p('Async 1');\n  console.log(res1);\n\n  var res2 = yield p('Async 2');\n  console.log(res2);\n\n  var res3 = yield p('Async 3');\n  console.log(res3);\n});\n\nconsole.log('Sync 1');\n```\n\n\u5b9f\u884c\u7d50\u679c\n\n```bash\n$ time node --harmony generator.js\nSync 1\nAsync 1\nAsync 2\nAsync 3\n# node --harmony generator.js  0.06s user 0.02s system 2% cpu 3.081 total\n```\n\n\u5b9f\u884c\u6642\u9593\u306f3\u79d2\u3001\u3061\u3083\u3093\u3068\u76f4\u5217\u306b\u51e6\u7406\u3055\u308c\u3066\u3044\u308b\u3002\n\u307e\u305f\u898b\u3066\u306e\u901a\u308a\u540c\u671f\u7684\u306b\u7e26\u306b\u66f8\u3051\u308b\u305f\u3081\u3001\u5404\u51e6\u7406\u7d50\u679c\u306b\u5bfe\u3057\u500b\u5225\u306b\u8ffd\u52a0\u51e6\u7406\u3059\u308b\u306e\u3082\u7c21\u5358\u3002\n\n```generator.js\nvar co = require('co');\nco(function *() {\n  var res1 = yield p('aSyNc');\n  console.log(res1);\n\n  var res2 = yield p(res1.toUpperCase());\n  console.log(res2);\n\n  var res3 = yield p(res2.toLowerCase());\n  console.log(res3);\n});\n\nconsole.log('Sync');\n```\n\n\u5b9f\u884c\u7d50\u679c\n\n```bash\n$ time node --harmony generator.js\nSync\naSyNc\nASYNC\nasync\n# node --harmony generator.js  0.07s user 0.02s system 2% cpu 3.074 total\n```\n\n### Error handling\n\nPromise\u306e\u30a4\u30f3\u30bf\u30fc\u30d5\u30a7\u30a4\u30b9\u3067reject&catch\u3067\u304d\u308b\u3002\n\n```\nfunction p(str) {\n  return new Promise(function(_, reject) {\n    setTimeout(function() {\n      reject(new Error('err!'));\n    }, 1000);\n  });\n}\n```\n\n```generator.js\nvar co = require('co');\nco(function *() {\n  var res1 = yield p('aSyNc');\n  console.log(res1);\n\n}).catch(function(err) {\n  console.log(err.message);\n});\n\nconsole.log('Sync');\n```\n\n\u5b9f\u884c\u7d50\u679c\n\n```bash\n$ time node --harmony generator.js\nSync\nerr!\n# node --harmony generator.js  0.07s user 0.03s system 8% cpu 1.076 total\n```\n\ngenerator\u3063\u307d\u304f`try~catch`\u3067\u3082\u826f\u3044\u3051\u3069\u3001\u30cd\u30b9\u30c8\u4e00\u6bb5\u6e1b\u3089\u305b\u308b\u3053\u3061\u3089\u306e\u65b9\u304c\u597d\u307f\u3002\n\n\n## \u307e\u3068\u3081\n\nPromise\u3068Generator\u306e\u4f7f\u3044\u5206\u3051\u306b\u53b3\u5bc6\u306a\u3053\u3060\u308f\u308a\u306f\u306a\u304f\u300c\u4ffa\u306f\u4e26\u5217\u51e6\u7406\u3082Generator\u300d\u3067\u3082\u826f\u3044\u3068\u601d\u3044\u307e\u3059\u3002\n\u5358\u7d14\u306b`Promise.all`\u306f\u4f7f\u3044\u3084\u3059\u3044\u306e\u3067\u3001\u306a\u3089\u305d\u308c\u3067\u826f\u3044\u3060\u308d\u3046\u3068\u3044\u3046\u7a0b\u5ea6\u3002\n\n\u3053\u306e\u8a18\u4e8b\u306e\u809d\u3068\u3057\u3066\u306f\n\n- thenrable\uff08Promise\u306b\u4f7f\u3048\u308b\u30a4\u30f3\u30bf\u30fc\u30d5\u30a7\u30a4\u30b9\uff09\u306fyieldable\uff08Generator\u306b\u4f7f\u3048\u308b\u30a4\u30f3\u30bf\u30fc\u30d5\u30a7\u30a4\u30b9\uff09\u3067\u3042\u308b\n\n\u3064\u307e\u308a\u300c\u5171\u5b58\u3067\u304d\u308b\u300d\u3068\u3044\u3046\u3053\u3068\u3002\n\n\u5f53\u521d\u306f\u300cPromise\u304bGenerator\uff08\u304b\u751fcollback\u304basync.js\u304betc\uff09\u304b\u3089\u4e00\u3064\u3069\u308c\u3092\u9078\u3076\u304b\u300d\u3068\u3044\u3046\u89b3\u70b9\u3067\nGenerator\u4f7f\u3046\u306a\u3089\u5168\u304f\u65b0\u3057\u3044\u30a8\u30b3\u30b7\u30b9\u30c6\u30e0\u3092\u4f5c\u3089\u306a\u3051\u308c\u3070\u306a\u3089\u306a\u3044\u3001\u3068\u8003\u3048\u3066\u3044\u307e\u3057\u305f\u3002\n\n\u3057\u3070\u3089\u304f\u306f\u30e2\u30ea\u30e2\u30ea[thunkify](https://github.com/tj/node-thunkify#thunkify)\u3059\u308b\u65e5\u3005\u3092\u7d9a\u3051\u305f\u306e\u3067\u3059\u304c\u3001\u3053\u308c\u306f\u306a\u304b\u306a\u304b\u30ad\u30c4\u30a4\u306a\u3068\uff08\u65e2\u5b58\u8cc7\u7523\u3068\u306e\u4e56\u96e2\u304c\u5927\u304d\u3044&\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u5168\u4f53\u304cGenerator\u3067lockin\u3055\u308c\u3066\u3057\u307e\u3046\u611f\uff09\u3002\n\n\u305d\u308c\u304c[thenrable\u306fyieldable](https://github.com/tj/co#yieldables)\u306b\u6c17\u3065\u3044\u3066\u304b\u3089\u300c\u307e\u305a\u306fPromise\u300d\u3067\u826f\u3044\u3068\u5206\u304b\u3063\u3066\u3060\u3044\u3076\u6c17\u697d\u306b\u306a\u3063\u305f&\u4eca\u5f8c\u306f\u3053\u306e\u65b9\u5411\u304b\u306a\u3001\u3068\u8151\u306b\u843d\u3061\u305f\u7d4c\u7def\u304c\u3042\u308a\u307e\u3059\u3002\n\nco\u3082v4\u304b\u3089[thunk\u3092depricated\u306b\u3057\u3066\u3044\u308b](https://github.com/tj/co#thunks)\u306e\u3067\u3001\u5272\u3068\u3053\u3093\u306a\u6d41\u308c\u306b\u306a\u308b\u3093\u3058\u3083\u306a\u3044\u304b\u306a\u3068\u601d\u3063\u3066\u3044\u307e\u3059\u3002\n\n## \uff08\u8ffd\u8a18\uff09then()\u30c1\u30a7\u30a4\u30f3\u306f\uff1f\n\n\u305d\u3082\u305d\u3082\u76f4\u5217\u51e6\u7406\u306fthen()\u30c1\u30a7\u30a4\u30f3\u3067\u3069\u3046\uff1f\u3068\u3044\u3046\u30b3\u30e1\u30f3\u30c8\u3092\u9802\u3044\u305f\u306e\u3067\u8ffd\u8a18\u3002\n\n```promise.js\np('Async 1').then(function(result) {\n  console.log(result);\n  return p('Async 2')\n}).then(function(result) {\n  console.log(result);\n  return p('Async 3')\n}).then(function(result) {\n  console.log(result);\n});\n```\n\n\u5b9f\u884c\u7d50\u679c\n\n```bash\n $ time node --harmony promise.js\nAsync 1\nAsync 2\nAsync 3\nnode --harmony promise.js  0.06s user 0.06s system 3% cpu 3.218 total\n```\n\n\n\u5b8c\u5168\u306b\u898b\u305f\u76ee\u306e\u554f\u984c\u3067\u3059\u304c\u3001\n\n- \u30ce\u30a4\u30ba\u304c\u81a8\u3089\u307f\u3084\u3059\u3044\uff08\u4e00\u3064\u7e4b\u3052\u308b\u305f\u3073\u306b`.then(function() {})`\uff09\n- \u51e6\u7406\uff08`p('Async')`\uff09\u304c\u5de6\u53f3\u306b\u6563\u3089\u3070\u308b\n\n\u3068\u3053\u308d\u304c\u3059\u3063\u304d\u308a\u305b\u305a\u3001\u500b\u4eba\u7684\u306b\u306fGenerator\u304c\u597d\u304d\u3067\u3059\u3002\n\n\u597d\u304d\u5acc\u3044\u306e\u8a71\u304b\u3088\u3068\u3044\u3046\u3068\u307e\u3055\u306b\u305d\u306e\u901a\u308a\u3067\u3001\u307e\u3068\u3081\u306b\u3082\u66f8\u3044\u305f\u901a\u308a\u5927\u4e8b\u306a\u306e\u306f\u300c\u5171\u5b58\u3067\u304d\u308b\u300d\u3053\u3068\u3001\u3064\u307e\u308a\u6c17\u6301\u3088\u304f\u66f8\u3051\u308b\u65b9\u3078\u884c\u304d\u6765\u3067\u304d\u308b\u67d4\u8edf\u3055\u304c\u3042\u308b\u3053\u3068\u3060\u3068\u601d\u3044\u307e\u3059\u3002\u3068\u308a\u3042\u3048\u305a\u306fPromise\u3067\u66f8\u3044\u3066\u304a\u304d\u3001\u3061\u3087\u3063\u3068chain\u5897\u3048\u3066\u30ab\u30aa\u30b9\u306b\u306a\u3063\u3066\u304d\u305f\u304b\u3089Generator\u3044\u304f\u304b\u301c\u3001\u3082\u5168\u7136\u30a2\u30ea\u3067\u3059\u3002\u3082\u3046\u300c\u975e\u540c\u671f\u3069\u308c\u304c\u826f\u3044\u306e\u300d\u3067\u60a9\u307e\u306a\u304f\u3066\u3088\u304f\u306a\u308b\u5b89\u5fc3\u611f\u4ed8\u304d\u3002\n\n\u3053\u306e\u3086\u308b\u3075\u308f\u3055\u306e\u8a31\u5bb9\u304c`thenrable\u306fyieldable`\u306e\u3088\u3044\u3068\u3053\u308d\u3067\u3042\u308a\u3001Generator\u306e\u6577\u5c45\u3092\u5927\u304d\u304f\u4e0b\u3052\u308b\u8981\u56e0\u306b\u306a\u308b\u306e\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u3002\n"}