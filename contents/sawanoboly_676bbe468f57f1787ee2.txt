{"context": " More than 1 year has passed since last update.\n\n\u3053\u306e\u8a18\u4e8b\u306f\u6700\u7d42\u66f4\u65b0\u304b\u30891\u5e74\u4ee5\u4e0a\u7d4c\u904e\u3057\u3066\u3044\u307e\u3059\u3002 \u6c17\u3092\u3064\u3051\u3066\u306d\u3002\n\nOpscode Chef\u3067\u3042\u308brails\u30a2\u30d7\u30ea\u3092\u30c7\u30d7\u30ed\u30a4\u3059\u308b\u30ec\u30b7\u30d4\u3092\u66f8\u3044\u305f\u306e\u3067\u30e1\u30e2\u3002\n\n\u672cRails\u30c7\u30d7\u30ed\u30a4\u6982\u8981\n\n\u524d\u63d0: ruby\u304c\u5165\u3063\u3066\u3044\u308b\u3001postgresql\u30b5\u30fc\u30d0\u306f\u65e2\u306b\u3042\u308b\nstart, stop\u306f\u5c02\u7528\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u7528\u610f\u3001monit\u914d\u4e0b\u3067\u7ba1\u7406\u3059\u308b\u3002\n\u30c7\u30d7\u30ed\u30a4\u306e\u30d7\u30e9\u30c3\u30c8\u30d5\u30a9\u30fc\u30e0\u306f\u3068\u308a\u3042\u3048\u305aJoyent SmartOS\u3001\u591a\u5206\u307b\u304b\u3067\u3082\u3042\u307e\u308a\u9055\u3044\u306f\u306a\u3044\u3002\nRackup\u306funicorn, socket\u3067nginx\u304b\u3089\u30ea\u30d0\u30fc\u30b9\u30d7\u30ed\u30ad\u30b7\n\nasset_pipiline\u3092\u4f7f\u3044\u3001assets\u4ee5\u4e0b\u306fnginx\u3067\u30db\u30b9\u30c8\u3002\n\n\n\u30ec\u30b7\u30d4\n\u95a2\u9023Cookbooks\u3084data_bags\u306e\u3053\u3068\u306f\u8003\u3048\u305a\u3001\u56fa\u6709\u540d\u79f0\u3084\u8907\u96d1\u306a\u7b87\u6240\u306f\u8aac\u660e\u7528\u306b\u6539\u5909\u3057\u3066\u307e\u3059\u3002\nchef\u306edeploy\u30ea\u30bd\u30fc\u30b9\u306f\u57fa\u672c\u7684\u306bcapistrano/deploy\u306e\u3088\u3046\u306b\u6c7a\u3081\u3089\u308c\u305f\u30d5\u30a7\u30fc\u30ba\u304c\u3042\u308a\u3001\u305d\u308c\u305e\u308c\u306b\u30d5\u30c3\u30af\u304c\u8a2d\u5b9a\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n\u30d5\u30c3\u30af\u6642\u306b\u5b9f\u884c\u3059\u308b\u5185\u5bb9\u306fRails\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u30ea\u30dd\u30b8\u30c8\u30ea\u5074\u306bdeploy/#{hook_name}.rb\u306e\u3088\u3046\u306b\u7f6e\u3044\u3066\u304a\u304f\u3053\u3068\u3082\u3067\u304d\u307e\u3059\u3002\n## //\u3067\u306f\u3058\u307e\u308b\u884c\u304c\u66f8\u304d\u4e0b\u308d\u3057\u306e\u89e3\u8aac\n\nrails_app/deploy.rb\n#\n# Cookbook Name:: rails_app\n# Recipe:: deploy\n#\n\n## // \u30c7\u30d7\u30ed\u30a4\u3059\u308b\u5148\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u9069\u5f53\u306b\u8a2d\u5b9a\napp_name = 'my_app'\ndir_localsystem = ::File.join(node[:my_app_common][:basedir], app_name, 'shared/localsystem')\n\n\n## // node\u306eenvironment\u3092\u30ad\u30fc\u306b\u3057\u3066\u3001\u5404\u7a2e\u63a5\u7d9a\u60c5\u5831\u3092data_bags\u304b\u3089\u53d6\u3063\u3066\u304f\u308b\n## build settings\n## // \u30d6\u30e9\u30f3\u30c1\u60c5\u5831\u3084deploy or force_deploy\u3092\u9078\u3079\u308b\ndeploy_settings = data_bag_item(:deploy,:items)[node.environment]\n## // Postgres\u306erole, password\nconnection= data_bag_item(:postgresql,:connections)[node.environment]\n## // \u8272\u3005URL\u3092\u62fe\u3063\u3066\u304f\u308b\u3001\u3053\u3053\u3067\u306fNginx\u306e\u4eee\u60f3\u30db\u30b9\u30c8\u3084\u3001\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u30b3\u30f3\u30d5\u30a3\u30b0\u3067\u4f7f\u7528\ndomains = data_bag_item(:domains,:items)[node.environment]\n## // Postgresql\u306e\u69cb\u6210\u6b21\u7b2c\u3067\u63a5\u7d9a\u5148\u3092\u5909\u3048\u305f\u3044\npg_master = data_bag_item(:postgresql,:clusters)[node.environment]['master']\n\n\n## // \u3053\u3053\u304b\u3089`deploy`\u30ea\u30bd\u30fc\u30b9\ndeploy_branch ::File.join(node[:my_app_common][:basedir], app_name)  do\n\n  ## // \u30c7\u30d7\u30ed\u30a4\u57fa\u672c\u60c5\u5831\n  repo 'https://github.com/higanworks/my_app.git'\n  branch  deploy_settings[app_name]['ref'] ## // 'master' \u304c\u5165\u3063\u305f\u308a\u3059\u308b\n  action deploy_settings[app_name]['action'] ## // 'deploy' \u307e\u305f\u306f 'force_deploy'\u3084 'roleback'\u3068\u304b\n  migrate deploy_settings[app_name]['migrate'] ## // true or false\n\n\n  ## // \u5404\u7a2e\u30b3\u30de\u30f3\u30c9\u5b9f\u884c\u6642\u306e\u74b0\u5883\u5909\u6570\n  environment \"RAILS_ENV\" => node.environment,  'BUNDLE_GEMFILE' => 'MyGemfile'\n\n  ## // \u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u306e\u30d5\u30a7\u30fc\u30ba\u3067\u5b9f\u884c\u3059\u308b\u30b3\u30de\u30f3\u30c9\u3002\n  migration_command 'bundle exec rake db:migrate'\n\n  ## // \u30c7\u30d7\u30ed\u30a4\u57fa\u672c\u60c5\u5831\n  create_dirs_before_symlink %w{tmp}\n\n  ## // \u6a19\u6e96\u306esymlink\u306bassets\u3092\u8ffd\u52a0\u3057\u3066\u3044\u308b\n  symlinks \"system\"=>\"public/system\",\n           \"assets\"=>\"public/assets\",                                                                                               \n           \"pids\"=>\"tmp/pids\",\n           \"log\"=>\"log\"\n\n  ## // \u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u524d\u306e\u30d5\u30c3\u30af\u3001shared\u306e\u4e0b\u306b\u5410\u3044\u305f\u30b3\u30f3\u30d5\u30a3\u30b0\u3092symlink\u306b\u3057\u3066`rails_root`\u306e\u4e0b\u306b\u6301\u3063\u3066\u304f\u308b\n  ## // \u30ad\u30fc\u5074\u306f `shared_dir`\u304b\u3089\u306e\u76f8\u5bfe\u30d1\u30b9\u3001\u30bf\u30fc\u30b2\u30c3\u30c8\u5074\u306f`release_path`\u304b\u3089\u306e\u76f8\u5bfe\u30d1\u30b9\u3067\u6307\u5b9a\n  symlink_before_migrate \"config/database.yml\" => \"config/database.yml\",\n                         \"config/app_config.yml\" => \"config/app_config.yml\"\n\n  ## // \u4ee5\u964d`relase_path`\u306f\u4f7f\u3048\u308b\u3051\u3069\u3001`shared_path`\u304c\u4f7f\u3048\u305f\u308a\u4f7f\u3048\u306a\u304b\u3063\u305f\u308a\u3059\u308b\u3002\u3002\n  ## // Shared_Dir\u306e\u4e0b\u306b\u5fc5\u8981\u306a\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u7f6e\u304f\u3001Doc\u306b\u3088\u308b\u3064\u30c7\u30d5\u30a9\u30eb\u30c8\u3067\u5e7e\u3064\u304b\u4f5c\u308a\u305d\u3046\u3060\u3051\u3069\u4f5c\u3089\u308c\u306a\u304b\u3063\u305f\u306e\u3067\u660e\u793a\u3002\n  before_migrate do\n    %w{config pids log assets system localsystem}.each do |dir|\n      directory ::File.join(release_path, \"../../shared\" , dir) do\n        action :create\n      end\n    end\n\n    ## // database.yml \u306e\u751f\u6210\n    ## // db\u306e\u540d\u524d\u306f\"#{app_name}_#(node.environment)\"\n    template ::File.expand_path(::File.join(release_path, '../../shared/config/database.yml')) do\n      cookbook 'my_app_common'\n      source 'database.yml.erb'\n      variables({\n        :connection => connection,\n        :domains => domains,\n        :pg_master => pg_master,\n        :app_name => app_name\n      })\n    end\n\n    ## // \u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u56fa\u6709\u306e\u30b3\u30f3\u30d5\u30a3\u30b0\u3092\u751f\u6210\n    template ::File.expand_path(::File.join(release_path, '../../shared/config/app_config.yml')) do\n      source 'app_config.yml.erb'\n      variables({\n        :domains => domains\n      })\n    end\n\n    ## // unicorn\u306e\u8a2d\u5b9a\n    ## // \u30ef\u30fc\u30ab\u30fc\u30d7\u30ed\u30bb\u30b9\u6570\u3092data_bag\u304b\u3089\n    ## // socket\u306e\u30d1\u30b9\u306b`app_name`\u3092\u4f7f\u7528\n    template ::File.expand_path(::File.join(release_path, '../../shared/config/unicorn.rb')) do\n      cookbook 'nginx_upstream'\n      source 'unicorn.rb.erb'\n      variables({\n        :worker_processes => node[:deploy][app_name][:unicorn_wps],\n        :app_name => app_name\n      })\n    end\n\n    ## // bundler\u3092\u4f7f\u3063\u3066\u3044\u308b\u306e\u3067\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u5b9f\u884c\u524d\u306bbundle\n    ## // Gem\u3092\u4f3c\u305f\u3088\u3046\u306arails\u30a2\u30d7\u30ea\u3068\u5171\u6709\u3059\u308b\u305f\u3081\u3001\u4e00\u6bb5\u968e\u4e0a\u306eShared\u306b\u7f6e\u304f\n    bash \"bundle install #{app_name}\" do\n      cwd release_path\n      flags '-ex'\n      code <<-BASHCODE\n         bundle install --deployment --gemfile MyGemfile --without development test --path=#{::File.join(node[:my_app_common][:basedir], 'shared/bundle')}\n      BASHCODE\n    end\n  end\n\n\n\n  ## // \u30ea\u30b9\u30bf\u30fc\u30c8\u524d\u306e\u30d5\u30c3\u30af\n  before_restart do\n\n    ## // data_bag\u306b\u6307\u5b9a\u304c\u3042\u3063\u305f\u3089assets\u3092\u751f\u6210\u3059\u308b\n    ## // RAILS_GROUPS\u306e\u6307\u5b9a\u3092\u3059\u308b\u306e\u3067enviroment\u3092\u8a2d\u5b9a\n    ## asset pipeline\n    if deploy_settings[app_name]['assets']\n      bash \"assets precompile #{app_name}\" do\n        cwd release_path\n        environment \"RAILS_ENV\" => node.environment,\n                    'BUNDLE_GEMFILE' => 'MyGemfile',\n                    'RAILS_GROUPS' => 'assets'\n        flags '-ex'\n        code <<-BASHCODE\n           bundle exec rake assets:precompile\n        BASHCODE\n      end\n    end\n\n    ## // monit\u304b\u3089\u30b3\u30f3\u30c8\u30ed\u30fc\u30eb\u3059\u308b\u305f\u3081\u3001\u5236\u5fa1\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u8a2d\u7f6e\u3059\u308b\n    ## // \u4e2d\u8eab\u306b\u306fPATH\u3084\u3089ENV\u3084\u3089\u8272\u3005\u8a2d\u5b9a\u3057\u3066\u3042\u308b\n    %W(start_#{app_name}.sh stop_#{app_name}.sh).each do |cmd|\n      template ::File.join(dir_localsystem, cmd) do\n        source cmd + '.erb'\n        mode '0700'\n        variables({\n          :app_name => app_name,\n          :pid_file => 'unicorn.pid',\n          :bundle_command => \"bundle exec unicorn_rails -c #{::File.expand_path(::File.join(release_path, '../../shared/config/unicorn.rb'))} -D\"\n        })\n      end\n    end\n\n    ## // monit\u306e\u30b3\u30f3\u30d5\u30a3\u30b0\u8a2d\u7f6e/\u66f4\u65b0\u3092\u76e3\u8996\u3057\u3066\u30ea\u30ed\u30fc\u30c9\u3059\u308b \n    ## // \u521d\u56de\u3084\u3001\u73fe\u5728\u30d7\u30ed\u30bb\u30b9\u304c\u8d77\u52d5\u3057\u3066\u306a\u3044\u5834\u5408\u306a\u3069\u306fInitalize\u306b\u5c11\u3005\u3082\u305f\u3064\u304f\u306e\u3067Sleep\u3067wait. \n    ## // wait\u306f\u3060\u3044\u305f\u30445\u79d2\u304f\u3089\u3044\n    execute 'monit_reload_' + app_name do\n      action :nothing\n      command \"monit reload ; sleep #{node[:deploy][:monit][:sleep]}\"\n      subscribes :run, \"template[/opt/local/etc/monit/conf.avail/#{app_name}]\"\n    end\n\n    ## // monit\u306e\u30b3\u30f3\u30d5\u30a3\u30b0\u30d5\u30a1\u30a4\u30eb\u3092include\u30d1\u30b9\u306b\u30ea\u30f3\u30af\u3059\u308b\n    execute 'monit_ensite_' + app_name do\n      action :nothing\n      command \"monitensite #{app_name}\"\n      notifies :run, \"execute[monit_reload_#{app_name}]\"\n      not_if \"test -f #{node[:monit][:dir]}/conf.enable/#{app_name}\"\n    end\n\n    ## // monit_bin\u306eLWRP\u3092\u4f7f\u3063\u3066\u30b3\u30f3\u30d5\u30a3\u30b0\u3092\u751f\u6210\u3059\u308b\n    monit_bin_check_process app_name do\n      action :create\n      type \"pid\"\n      pidfile ::File.join(node[:my_app_common][:basedir], app_name , 'shared/pids/unicorn.pid')\n      start_program ::File.join(node[:my_app_common][:basedir], app_name , 'shared/localsystem', \"start_#{app_name}.sh\")\n      stop_program ::File.join(node[:my_app_common][:basedir], app_name ,'shared/localsystem', \"stop_#{app_name}.sh\")\n      notifies :run, \"execute[monit_ensite_#{app_name}]\"\n    end\n  end\n\n  ## // \u30ea\u30b9\u30bf\u30fc\u30c8\u306e\u30b3\u30de\u30f3\u30c9\u3002\n  ## // \u521d\u56de\u306frestart\u306b\u306a\u3089\u306a\u3044\u304c\u554f\u984c\u306a\u3044\u3002\n  restart_command \"monit restart #{app_name}\"\n  after_restart nil\nend\n\n\n## // \u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30ed\u30b0\u306e\u30ed\u30fc\u30c6\u30fc\u30b7\u30e7\u30f3\u3092\u8a2d\u5b9a\u3057\u3066\u304a\u304f\n## // mv\u306f\u8272\u3005\u9762\u5012\u306a\u306e\u3067 copy & truncate\nlogadm \"app_#{app_name}\" do\n  path ::File.join(node[:my_app_common][:basedir], app_name , 'shared/log/*.log')\n  copy true\n  size '100m'\n  period '7d'\n  action :create\nend\n\n### add nginx upstream\n\n## // nginx\u306b\u30db\u30b9\u30c8\u3055\u305b\u308b\n## // domains\u306e\u30c7\u30fc\u30bf\u30d0\u30c3\u30af\u304b\u3089SSL\u306e\u30f4\u30a1\u30fc\u30c1\u30e3\u30eb\u30db\u30b9\u30c8\u540d\u3092\u62fe\u3063\u3066\u304d\u3066\u3044\u308b\n## // \u540d\u524d\u30d9\u30fc\u30b9\u306eSSL(SNI)\u3067\u8907\u6570\u306e\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3092\u5b9f\u884c\n## // Nginx\u3067\u306eUpstream\u8a2d\u5b9a\u3084assets pipeline\u307e\u308f\u308a\u306f RailsCasts\u306e#341\u3092\u53c2\u8003\u306b\u3057\u3066\u3044\u308b\ntemplate ::File.join(node[:nginx_upstream][:conf_dir] , \"conf.d/#{domains[app_name]}.conf\") do\n  cookbook 'nginx_upstream'\n  source 'upstream_ssl.erb'\n  variables({\n    :app_name => app_name,\n    :assets => deploy_settings[app_name]['assets'],\n    :server_name => domains[app_name],\n    :upstreams => [\"unix:#{::File.join(node[:my_app_common][:basedir], app_name , 'shared/pids/unicorn.sock')}\"]\n  })\n  notifies :restart, 'service[nginx]'\nend\n\n\n\n\u6240\u611f\n\n\ncapistrano\u304c\u4f7f\u3048\u308c\u3070\u3001\u6d41\u308c\u306f\u540c\u3058\u306a\u306e\u3067\u308f\u304b\u308a\u3084\u3059\u3044\ndata_bag\u3092\u4f7f\u3046\u6240\u306fCookbook\u306b\u3059\u308b\u307b\u3046\u304c\u7248\u306e\u7ba1\u7406\u304c\u3067\u304d\u3066\u3044\u3044\u304b\u3082\u3057\u308c\u306a\u3044\u3002\n\u958b\u767a\u4e2d\u306e\u30c7\u30d7\u30ed\u30a4\u5b9a\u671f\u5b9f\u884c\u306f\u30a2\u30ea\n\u672c\u756a\u66f4\u65b0\u306b\u306f\u8272\u3005\u3042\u308b\u306e\u3067\u3001node\u306e\u30c7\u30d5\u30a9\u30eb\u30c8\u30e9\u30f3\u30ea\u30b9\u30c8\u306f\u74b0\u5883\u5468\u308a\u306e\u6574\u5099\u306b\u3057\u3066\u304a\u304d\u305d\u308c\u3092\u5b9a\u671f\u5b9f\u884c\u3001deploy, rollback\u306e\u30e9\u30f3\u30ea\u30b9\u30c8(role)\u3092\u6307\u5b9a\u3057\u3066knife\u304b\u3089\u6d41\u3057\u3066\u3042\u3052\u308b\u306e\u304c\u3044\u3044\u304b\u3082\u3057\u308c\u306a\u3044\u3002\n\n\n\u8ffd\u8a18\u30ed\u30b0\n\n\nsymlink_before_migrate\u3067assets\u3092\u4f5c\u308b\u3068\u306a\u305c\u304bassets/assets\u304c\u5897\u3048\u305f\u306e\u3067symlink\u306b\u79fb\u52d5\n\n<!-- too_old -->\n> **\u3053\u306e\u8a18\u4e8b\u306f\u6700\u7d42\u66f4\u65b0\u304b\u30891\u5e74\u4ee5\u4e0a\u7d4c\u904e\u3057\u3066\u3044\u307e\u3059\u3002** \u6c17\u3092\u3064\u3051\u3066\u306d\u3002\n\n[Opscode Chef](http://www.opscode.com/chef/)\u3067\u3042\u308brails\u30a2\u30d7\u30ea\u3092\u30c7\u30d7\u30ed\u30a4\u3059\u308b\u30ec\u30b7\u30d4\u3092\u66f8\u3044\u305f\u306e\u3067\u30e1\u30e2\u3002\n\n## \u672cRails\u30c7\u30d7\u30ed\u30a4\u6982\u8981\n\n- \u524d\u63d0: ruby\u304c\u5165\u3063\u3066\u3044\u308b\u3001postgresql\u30b5\u30fc\u30d0\u306f\u65e2\u306b\u3042\u308b\n- start, stop\u306f\u5c02\u7528\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u7528\u610f\u3001`monit`\u914d\u4e0b\u3067\u7ba1\u7406\u3059\u308b\u3002\n- \u30c7\u30d7\u30ed\u30a4\u306e\u30d7\u30e9\u30c3\u30c8\u30d5\u30a9\u30fc\u30e0\u306f\u3068\u308a\u3042\u3048\u305a`Joyent SmartOS`\u3001\u591a\u5206\u307b\u304b\u3067\u3082\u3042\u307e\u308a\u9055\u3044\u306f\u306a\u3044\u3002\n- Rackup\u306funicorn, socket\u3067nginx\u304b\u3089\u30ea\u30d0\u30fc\u30b9\u30d7\u30ed\u30ad\u30b7\n- `asset_pipiline`\u3092\u4f7f\u3044\u3001`assets`\u4ee5\u4e0b\u306f`nginx`\u3067\u30db\u30b9\u30c8\u3002\n\n## \u30ec\u30b7\u30d4\n\n\u95a2\u9023`Cookbooks`\u3084`data_bags`\u306e\u3053\u3068\u306f\u8003\u3048\u305a\u3001\u56fa\u6709\u540d\u79f0\u3084\u8907\u96d1\u306a\u7b87\u6240\u306f\u8aac\u660e\u7528\u306b\u6539\u5909\u3057\u3066\u307e\u3059\u3002\n`chef`\u306e`deploy`\u30ea\u30bd\u30fc\u30b9\u306f\u57fa\u672c\u7684\u306b`capistrano/deploy`\u306e\u3088\u3046\u306b\u6c7a\u3081\u3089\u308c\u305f\u30d5\u30a7\u30fc\u30ba\u304c\u3042\u308a\u3001\u305d\u308c\u305e\u308c\u306b\u30d5\u30c3\u30af\u304c\u8a2d\u5b9a\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n\u30d5\u30c3\u30af\u6642\u306b\u5b9f\u884c\u3059\u308b\u5185\u5bb9\u306f**Rails\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e**\u30ea\u30dd\u30b8\u30c8\u30ea\u5074\u306b`deploy/#{hook_name}.rb`\u306e\u3088\u3046\u306b\u7f6e\u3044\u3066\u304a\u304f\u3053\u3068\u3082\u3067\u304d\u307e\u3059\u3002\n\n`## // `\u3067\u306f\u3058\u307e\u308b\u884c\u304c\u66f8\u304d\u4e0b\u308d\u3057\u306e\u89e3\u8aac\n\n```ruby:rails_app/deploy.rb\n#\n# Cookbook Name:: rails_app\n# Recipe:: deploy\n#\n\n## // \u30c7\u30d7\u30ed\u30a4\u3059\u308b\u5148\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u9069\u5f53\u306b\u8a2d\u5b9a\napp_name = 'my_app'\ndir_localsystem = ::File.join(node[:my_app_common][:basedir], app_name, 'shared/localsystem')\n\n\n## // node\u306eenvironment\u3092\u30ad\u30fc\u306b\u3057\u3066\u3001\u5404\u7a2e\u63a5\u7d9a\u60c5\u5831\u3092data_bags\u304b\u3089\u53d6\u3063\u3066\u304f\u308b\n## build settings\n## // \u30d6\u30e9\u30f3\u30c1\u60c5\u5831\u3084deploy or force_deploy\u3092\u9078\u3079\u308b\ndeploy_settings = data_bag_item(:deploy,:items)[node.environment]\n## // Postgres\u306erole, password\nconnection= data_bag_item(:postgresql,:connections)[node.environment]\n## // \u8272\u3005URL\u3092\u62fe\u3063\u3066\u304f\u308b\u3001\u3053\u3053\u3067\u306fNginx\u306e\u4eee\u60f3\u30db\u30b9\u30c8\u3084\u3001\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u30b3\u30f3\u30d5\u30a3\u30b0\u3067\u4f7f\u7528\ndomains = data_bag_item(:domains,:items)[node.environment]\n## // Postgresql\u306e\u69cb\u6210\u6b21\u7b2c\u3067\u63a5\u7d9a\u5148\u3092\u5909\u3048\u305f\u3044\npg_master = data_bag_item(:postgresql,:clusters)[node.environment]['master']\n\n\n## // \u3053\u3053\u304b\u3089`deploy`\u30ea\u30bd\u30fc\u30b9\ndeploy_branch ::File.join(node[:my_app_common][:basedir], app_name)  do\n\n  ## // \u30c7\u30d7\u30ed\u30a4\u57fa\u672c\u60c5\u5831\n  repo 'https://github.com/higanworks/my_app.git'\n  branch  deploy_settings[app_name]['ref'] ## // 'master' \u304c\u5165\u3063\u305f\u308a\u3059\u308b\n  action deploy_settings[app_name]['action'] ## // 'deploy' \u307e\u305f\u306f 'force_deploy'\u3084 'roleback'\u3068\u304b\n  migrate deploy_settings[app_name]['migrate'] ## // true or false\n\n\n  ## // \u5404\u7a2e\u30b3\u30de\u30f3\u30c9\u5b9f\u884c\u6642\u306e\u74b0\u5883\u5909\u6570\n  environment \"RAILS_ENV\" => node.environment,  'BUNDLE_GEMFILE' => 'MyGemfile'\n\n  ## // \u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u306e\u30d5\u30a7\u30fc\u30ba\u3067\u5b9f\u884c\u3059\u308b\u30b3\u30de\u30f3\u30c9\u3002\n  migration_command 'bundle exec rake db:migrate'\n\n  ## // \u30c7\u30d7\u30ed\u30a4\u57fa\u672c\u60c5\u5831\n  create_dirs_before_symlink %w{tmp}\n\n  ## // \u6a19\u6e96\u306esymlink\u306bassets\u3092\u8ffd\u52a0\u3057\u3066\u3044\u308b\n  symlinks \"system\"=>\"public/system\",\n           \"assets\"=>\"public/assets\",                                                                                               \n           \"pids\"=>\"tmp/pids\",\n           \"log\"=>\"log\"\n\n  ## // \u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u524d\u306e\u30d5\u30c3\u30af\u3001shared\u306e\u4e0b\u306b\u5410\u3044\u305f\u30b3\u30f3\u30d5\u30a3\u30b0\u3092symlink\u306b\u3057\u3066`rails_root`\u306e\u4e0b\u306b\u6301\u3063\u3066\u304f\u308b\n  ## // \u30ad\u30fc\u5074\u306f `shared_dir`\u304b\u3089\u306e\u76f8\u5bfe\u30d1\u30b9\u3001\u30bf\u30fc\u30b2\u30c3\u30c8\u5074\u306f`release_path`\u304b\u3089\u306e\u76f8\u5bfe\u30d1\u30b9\u3067\u6307\u5b9a\n  symlink_before_migrate \"config/database.yml\" => \"config/database.yml\",\n                         \"config/app_config.yml\" => \"config/app_config.yml\"\n\n  ## // \u4ee5\u964d`relase_path`\u306f\u4f7f\u3048\u308b\u3051\u3069\u3001`shared_path`\u304c\u4f7f\u3048\u305f\u308a\u4f7f\u3048\u306a\u304b\u3063\u305f\u308a\u3059\u308b\u3002\u3002\n  ## // Shared_Dir\u306e\u4e0b\u306b\u5fc5\u8981\u306a\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u7f6e\u304f\u3001Doc\u306b\u3088\u308b\u3064\u30c7\u30d5\u30a9\u30eb\u30c8\u3067\u5e7e\u3064\u304b\u4f5c\u308a\u305d\u3046\u3060\u3051\u3069\u4f5c\u3089\u308c\u306a\u304b\u3063\u305f\u306e\u3067\u660e\u793a\u3002\n  before_migrate do\n    %w{config pids log assets system localsystem}.each do |dir|\n      directory ::File.join(release_path, \"../../shared\" , dir) do\n        action :create\n      end\n    end\n\n    ## // database.yml \u306e\u751f\u6210\n    ## // db\u306e\u540d\u524d\u306f\"#{app_name}_#(node.environment)\"\n    template ::File.expand_path(::File.join(release_path, '../../shared/config/database.yml')) do\n      cookbook 'my_app_common'\n      source 'database.yml.erb'\n      variables({\n        :connection => connection,\n        :domains => domains,\n        :pg_master => pg_master,\n        :app_name => app_name\n      })\n    end\n\n    ## // \u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u56fa\u6709\u306e\u30b3\u30f3\u30d5\u30a3\u30b0\u3092\u751f\u6210\n    template ::File.expand_path(::File.join(release_path, '../../shared/config/app_config.yml')) do\n      source 'app_config.yml.erb'\n      variables({\n        :domains => domains\n      })\n    end\n\n    ## // unicorn\u306e\u8a2d\u5b9a\n    ## // \u30ef\u30fc\u30ab\u30fc\u30d7\u30ed\u30bb\u30b9\u6570\u3092data_bag\u304b\u3089\n    ## // socket\u306e\u30d1\u30b9\u306b`app_name`\u3092\u4f7f\u7528\n    template ::File.expand_path(::File.join(release_path, '../../shared/config/unicorn.rb')) do\n      cookbook 'nginx_upstream'\n      source 'unicorn.rb.erb'\n      variables({\n        :worker_processes => node[:deploy][app_name][:unicorn_wps],\n        :app_name => app_name\n      })\n    end\n\n    ## // bundler\u3092\u4f7f\u3063\u3066\u3044\u308b\u306e\u3067\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u5b9f\u884c\u524d\u306bbundle\n    ## // Gem\u3092\u4f3c\u305f\u3088\u3046\u306arails\u30a2\u30d7\u30ea\u3068\u5171\u6709\u3059\u308b\u305f\u3081\u3001\u4e00\u6bb5\u968e\u4e0a\u306eShared\u306b\u7f6e\u304f\n    bash \"bundle install #{app_name}\" do\n      cwd release_path\n      flags '-ex'\n      code <<-BASHCODE\n         bundle install --deployment --gemfile MyGemfile --without development test --path=#{::File.join(node[:my_app_common][:basedir], 'shared/bundle')}\n      BASHCODE\n    end\n  end\n\n\n\n  ## // \u30ea\u30b9\u30bf\u30fc\u30c8\u524d\u306e\u30d5\u30c3\u30af\n  before_restart do\n\n    ## // data_bag\u306b\u6307\u5b9a\u304c\u3042\u3063\u305f\u3089assets\u3092\u751f\u6210\u3059\u308b\n    ## // RAILS_GROUPS\u306e\u6307\u5b9a\u3092\u3059\u308b\u306e\u3067enviroment\u3092\u8a2d\u5b9a\n    ## asset pipeline\n    if deploy_settings[app_name]['assets']\n      bash \"assets precompile #{app_name}\" do\n        cwd release_path\n        environment \"RAILS_ENV\" => node.environment,\n                    'BUNDLE_GEMFILE' => 'MyGemfile',\n                    'RAILS_GROUPS' => 'assets'\n        flags '-ex'\n        code <<-BASHCODE\n           bundle exec rake assets:precompile\n        BASHCODE\n      end\n    end\n\n    ## // monit\u304b\u3089\u30b3\u30f3\u30c8\u30ed\u30fc\u30eb\u3059\u308b\u305f\u3081\u3001\u5236\u5fa1\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u8a2d\u7f6e\u3059\u308b\n    ## // \u4e2d\u8eab\u306b\u306fPATH\u3084\u3089ENV\u3084\u3089\u8272\u3005\u8a2d\u5b9a\u3057\u3066\u3042\u308b\n    %W(start_#{app_name}.sh stop_#{app_name}.sh).each do |cmd|\n      template ::File.join(dir_localsystem, cmd) do\n        source cmd + '.erb'\n        mode '0700'\n        variables({\n          :app_name => app_name,\n          :pid_file => 'unicorn.pid',\n          :bundle_command => \"bundle exec unicorn_rails -c #{::File.expand_path(::File.join(release_path, '../../shared/config/unicorn.rb'))} -D\"\n        })\n      end\n    end\n\n    ## // monit\u306e\u30b3\u30f3\u30d5\u30a3\u30b0\u8a2d\u7f6e/\u66f4\u65b0\u3092\u76e3\u8996\u3057\u3066\u30ea\u30ed\u30fc\u30c9\u3059\u308b \n    ## // \u521d\u56de\u3084\u3001\u73fe\u5728\u30d7\u30ed\u30bb\u30b9\u304c\u8d77\u52d5\u3057\u3066\u306a\u3044\u5834\u5408\u306a\u3069\u306fInitalize\u306b\u5c11\u3005\u3082\u305f\u3064\u304f\u306e\u3067Sleep\u3067wait. \n    ## // wait\u306f\u3060\u3044\u305f\u30445\u79d2\u304f\u3089\u3044\n    execute 'monit_reload_' + app_name do\n      action :nothing\n      command \"monit reload ; sleep #{node[:deploy][:monit][:sleep]}\"\n      subscribes :run, \"template[/opt/local/etc/monit/conf.avail/#{app_name}]\"\n    end\n\n    ## // monit\u306e\u30b3\u30f3\u30d5\u30a3\u30b0\u30d5\u30a1\u30a4\u30eb\u3092include\u30d1\u30b9\u306b\u30ea\u30f3\u30af\u3059\u308b\n    execute 'monit_ensite_' + app_name do\n      action :nothing\n      command \"monitensite #{app_name}\"\n      notifies :run, \"execute[monit_reload_#{app_name}]\"\n      not_if \"test -f #{node[:monit][:dir]}/conf.enable/#{app_name}\"\n    end\n\n    ## // monit_bin\u306eLWRP\u3092\u4f7f\u3063\u3066\u30b3\u30f3\u30d5\u30a3\u30b0\u3092\u751f\u6210\u3059\u308b\n    monit_bin_check_process app_name do\n      action :create\n      type \"pid\"\n      pidfile ::File.join(node[:my_app_common][:basedir], app_name , 'shared/pids/unicorn.pid')\n      start_program ::File.join(node[:my_app_common][:basedir], app_name , 'shared/localsystem', \"start_#{app_name}.sh\")\n      stop_program ::File.join(node[:my_app_common][:basedir], app_name ,'shared/localsystem', \"stop_#{app_name}.sh\")\n      notifies :run, \"execute[monit_ensite_#{app_name}]\"\n    end\n  end\n\n  ## // \u30ea\u30b9\u30bf\u30fc\u30c8\u306e\u30b3\u30de\u30f3\u30c9\u3002\n  ## // \u521d\u56de\u306frestart\u306b\u306a\u3089\u306a\u3044\u304c\u554f\u984c\u306a\u3044\u3002\n  restart_command \"monit restart #{app_name}\"\n  after_restart nil\nend\n\n\n## // \u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30ed\u30b0\u306e\u30ed\u30fc\u30c6\u30fc\u30b7\u30e7\u30f3\u3092\u8a2d\u5b9a\u3057\u3066\u304a\u304f\n## // mv\u306f\u8272\u3005\u9762\u5012\u306a\u306e\u3067 copy & truncate\nlogadm \"app_#{app_name}\" do\n  path ::File.join(node[:my_app_common][:basedir], app_name , 'shared/log/*.log')\n  copy true\n  size '100m'\n  period '7d'\n  action :create\nend\n\n### add nginx upstream\n\n## // nginx\u306b\u30db\u30b9\u30c8\u3055\u305b\u308b\n## // domains\u306e\u30c7\u30fc\u30bf\u30d0\u30c3\u30af\u304b\u3089SSL\u306e\u30f4\u30a1\u30fc\u30c1\u30e3\u30eb\u30db\u30b9\u30c8\u540d\u3092\u62fe\u3063\u3066\u304d\u3066\u3044\u308b\n## // \u540d\u524d\u30d9\u30fc\u30b9\u306eSSL(SNI)\u3067\u8907\u6570\u306e\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3092\u5b9f\u884c\n## // Nginx\u3067\u306eUpstream\u8a2d\u5b9a\u3084assets pipeline\u307e\u308f\u308a\u306f RailsCasts\u306e#341\u3092\u53c2\u8003\u306b\u3057\u3066\u3044\u308b\ntemplate ::File.join(node[:nginx_upstream][:conf_dir] , \"conf.d/#{domains[app_name]}.conf\") do\n  cookbook 'nginx_upstream'\n  source 'upstream_ssl.erb'\n  variables({\n    :app_name => app_name,\n    :assets => deploy_settings[app_name]['assets'],\n    :server_name => domains[app_name],\n    :upstreams => [\"unix:#{::File.join(node[:my_app_common][:basedir], app_name , 'shared/pids/unicorn.sock')}\"]\n  })\n  notifies :restart, 'service[nginx]'\nend\n```\n\n## \u6240\u611f\n\n- `capistrano`\u304c\u4f7f\u3048\u308c\u3070\u3001\u6d41\u308c\u306f\u540c\u3058\u306a\u306e\u3067\u308f\u304b\u308a\u3084\u3059\u3044\n- data_bag\u3092\u4f7f\u3046\u6240\u306fCookbook\u306b\u3059\u308b\u307b\u3046\u304c\u7248\u306e\u7ba1\u7406\u304c\u3067\u304d\u3066\u3044\u3044\u304b\u3082\u3057\u308c\u306a\u3044\u3002\n- \u958b\u767a\u4e2d\u306e\u30c7\u30d7\u30ed\u30a4\u5b9a\u671f\u5b9f\u884c\u306f\u30a2\u30ea\n- \u672c\u756a\u66f4\u65b0\u306b\u306f\u8272\u3005\u3042\u308b\u306e\u3067\u3001`node`\u306e\u30c7\u30d5\u30a9\u30eb\u30c8\u30e9\u30f3\u30ea\u30b9\u30c8\u306f\u74b0\u5883\u5468\u308a\u306e\u6574\u5099\u306b\u3057\u3066\u304a\u304d\u305d\u308c\u3092\u5b9a\u671f\u5b9f\u884c\u3001deploy, rollback\u306e\u30e9\u30f3\u30ea\u30b9\u30c8(role)\u3092\u6307\u5b9a\u3057\u3066`knife`\u304b\u3089\u6d41\u3057\u3066\u3042\u3052\u308b\u306e\u304c\u3044\u3044\u304b\u3082\u3057\u308c\u306a\u3044\u3002\n\n\n----\n\u8ffd\u8a18\u30ed\u30b0\n\n- `symlink_before_migrate`\u3067assets\u3092\u4f5c\u308b\u3068\u306a\u305c\u304b`assets/assets`\u304c\u5897\u3048\u305f\u306e\u3067`symlink`\u306b\u79fb\u52d5\n", "tags": ["deploy", "Rails", "chef", "Ruby"]}