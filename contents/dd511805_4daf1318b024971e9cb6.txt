{"context": "TreasureData\u88fd\u306e\u5206\u6563\u30ad\u30e5\u30fc PerfectQueue\u3092\u4f7f\u3063\u3066\u307f\u307e\u3059\u3002\nredis\u3092\u5229\u7528\u3057\u305fSidekiq\u3084AWS SQS\u3092\u5229\u7528\u3057\u305fShoryuken\u306e\u3088\u3046\u306bRuby\u3067\u4f7f\u3048\u308b\n\u30b8\u30e7\u30d6\u30ad\u30e5\u30fc\u306fPerfectQueue\u4ee5\u5916\u306b\u3082\u5b58\u5728\u3057\u3066\u3044\u307e\u3059\u304c\u3001PerfectQueue\u306f\u30ad\u30e5\u30fc\u306e\u7ba1\u7406\u306bMySQL\u3092\u4f7f\u3063\u3066\u3044\u308b\u3068\u3053\u308d\u304c\u7279\u5fb4\u7684\u3067\u3059\u3002\n\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\nPerfectQueue\u306fRuby\u3067\u4f5c\u3089\u308c\u3066\u3044\u308b\u306e\u3067\u3001\u901a\u5e38\u306eRuby\u306e\u30d7\u30ed\u30c0\u30af\u30c8\u3068\u540c\u3058\u3088\u3046\u306bbundler\u3092\u7528\u3044\u3066\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3092\u884c\u3044\u307e\u3059\u3002\nmkdir perfectqueue\ncd ./perfectqueue\nbundle init\n\nGemfile\u3092\u4f5c\u6210\u3057\u305f\u5f8c\u306b\u3001\u4ee5\u4e0b\u306e\u69d8\u306bGem\u30d5\u30a1\u30a4\u30eb\u3092\u7de8\u96c6\u3057\u307e\u3059\u3002\n\nGemfile\n# frozen_string_literal: true\nsource \"https://rubygems.org\"\n\ngem \"perfectqueue\"\ngem \"json\"\ngem \"mysql2\"\n\n\nGemfile\u3092\u7de8\u96c6\u304c\u7d42\u308f\u3063\u305f\u3042\u3068\u306fbundler\u3067\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3092\u5b9f\u884c\u3057\u307e\u3059\u3002\nbundle install --path=./vendor/bundle\n\nPerfectQueue\u306fMySQL\u306b\u30ad\u30e5\u30fc\u3092\u5165\u308c\u3066\u3044\u304f\u306e\u3067\u3001PerfectQueue\u3067\u4f7f\u7528\u3059\u308b\nMySQL\u306e\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\nmysql> create database perfectqueue;\nQuery OK, 1 row affected (0.00 sec)\n\nPerfectQueue\u3067\u4f7f\u7528\u3059\u308bDB\u306e\u8a2d\u5b9a\u306f\u3001config/perfectqueue.yml\u306b\u8a18\u8ff0\u3057\u307e\u3059\u3002\n\nconfig/perfectqueue.yml\ndevelopment:\n  type: rdb_compat\n  url: mysql2://root:@localhost:3306/perfectqueue\n  table: queues\n  processors: 1\n\n\nDB\u306e\u8a2d\u5b9a\u304c\u5b8c\u4e86\u3057\u305f\u3089\u3001perfectqueue\u306einit\u30b3\u30de\u30f3\u30c9\u3067MySQL\u306bqueue\u7528\u306e\u30c6\u30fc\u30d6\u30eb\n\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n$ bundle exec perfectqueue init\n\nMySQL\u4e0a\u3067\u30c6\u30fc\u30d6\u30eb\u306e\u78ba\u8a8d\u3092\u884c\u3046\u3068\u3001queue\u7528\u306e\u30c6\u30fc\u30d6\u30eb\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002\nmysql> use perfectqueue;\nmysql> desc queues;\n+-------------+---------------------+------+-----+---------+-------+\n| Field       | Type                | Null | Key | Default | Extra |\n+-------------+---------------------+------+-----+---------+-------+\n| id          | varchar(255)        | NO   | PRI | NULL    |       |\n| timeout     | int(11)             | NO   | MUL | NULL    |       |\n| data        | longblob            | NO   |     | NULL    |       |\n| created_at  | int(11)             | YES  |     | NULL    |       |\n| resource    | varchar(255)        | YES  |     | NULL    |       |\n| max_running | int(11)             | YES  |     | NULL    |       |\n| owner       | bigint(21) unsigned | NO   |     | 0       |       |\n+-------------+---------------------+------+-----+---------+-------+\n\n\nCLI\u3067\u306e\u30ad\u30e5\u30fc\u306e\u6295\u5165\nPerfectQueue\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u304c\u5b8c\u4e86\u3057\u305f\u306e\u3067\u5b9f\u969b\u306e\u30ad\u30e5\u30fc\u3092\u5c0e\u5165\u3057\u3066\u307f\u307e\u3059\u3002\n$ bundle exec perfectqueue submit k1 my_task '{\"uid\":1}' -u user_1\n\nperfectqueue submit\u304c\u30ad\u30e5\u30fc\u3092\u6295\u5165\u3059\u308b\u305f\u3081\u306e\u30b3\u30de\u30f3\u30c9\u306b\u306a\u308a\u307e\u3059\u3002\n\u305d\u308c\u4ee5\u964d\u306e\u5f15\u6570\u306fid\u3001\u30bf\u30b9\u30af\u306e\u30bf\u30a4\u30d7\u3001\u30c7\u30fc\u30bf\u306e\u9806\u306b\u8a18\u8ff0\u3057\u307e\u3059\u3002\n\u30ad\u30e5\u30fc\u306e\u6295\u5165\u304c\u5b8c\u4e86\u3057\u305f\u3089\u3001MySQL\u3067queue\u30c6\u30fc\u30d6\u30eb\u3092\u691c\u7d22\u3057\u3066\u307f\u307e\u3059\u3002\nmysql> select * from queues;\n+----+------------+------------------------------+------------+----------+-------------+-------+\n| id | timeout    | data                         | created_at | resource | max_running | owner |\n+----+------------+------------------------------+------------+----------+-------------+-------+\n| k1 | 1479699578 | {\"uid\":1,\"type\":\"my_task\"} | 1479699578 | user_1   |        NULL |     0 |\n+----+------------+------------------------------+------------+----------+-------------+-------+\n\nperfectqueue\u306e\u30b3\u30de\u30f3\u30c9\u3067\u3082\u30ad\u30e5\u30fc\u306e\u4e2d\u8eab\u3092\u78ba\u8a8d\u3059\u308b\u3053\u3068\u304c\u51fa\u6765\u307e\u3059\u3002\n\u7c21\u5358\u306a\u30b3\u30de\u30f3\u30c9\u306a\u306e\u3067\u3001ruby\u4ee5\u5916\u306e\u30d7\u30ed\u30b0\u30e9\u30e0\u304b\u3089\u3082\u30b7\u30b9\u30c6\u30e0\u30b3\u30fc\u30eb\u3067\u30ad\u30e5\u30fc\u3092\u6295\u5165\u3059\u308b\n\u3053\u3068\u306f\u5bb9\u6613\u3060\u3068\u601d\u3044\u307e\u3059\u3002\n\u305d\u306e\u5834\u5408\u306f\u3001gem install perfectqueue\u3092\u884c\u3063\u3066\u3001bundler\u306a\u3057\u3067\u3001perfectqueue\u3092\u5b9f\u884c\u3067\u304d\u308b\n\u74b0\u5883\u306b\u3057\u3066\u304a\u3044\u305f\u307b\u3046\u304c\u3044\u3044\u3067\u3057\u3087\u3046\u3002\n$ bundle exec perfectqueue list\n                           key            type               user             status                   created_at                      timeout   data\n                            k1         my_task             user_1            waiting    2016-11-21 12:39:38 +0900    2016-11-21 12:39:38 +0900   {\"uid\"=>1}\n1 entries.\n\n\nRuby\u3067\u306e\u30ad\u30e5\u30fc\u306e\u6295\u5165\n\u30ad\u30e5\u30fc\u306e\u6295\u5165\u3092ruby\u304b\u3089\u3067\u3082\u8a66\u3057\u3066\u307f\u307e\u3059\u3002\n\nenqueue.rb\nrequire 'bundler'\nBundler.require\nrequire 'yaml'\n\nenvironment = \"development\"\n\nconfigration = YAML.load_file(File.expand_path(File.join(File.dirname(__FILE__),\"..\",\"config\",\"perfectqueue.yml\")))[environment]\nqueue = PerfectQueue.open(configration)\n\nqueue.submit(\"k2\", \"my_task\", {uid:'2'},{user:\"user_2\"})\n\n\nqueue.submit\u304c\u30ad\u30e5\u30fc\u306e\u6295\u5165\u3092\u5b9f\u884c\u3059\u308b\u30e1\u30bd\u30c3\u30c9\u306b\u306a\u308a\u307e\u3059\u3002\n\u5f15\u6570\u306e\u9806\u756a\u306fperfectqueue\u30b3\u30de\u30f3\u30c9\u306e\u3068\u304d\u3068\u540c\u3058\u3067\u3059\u3002\n\u7b2c4\u5f15\u6570\u306e\u30aa\u30d7\u30b7\u30e7\u30f3\u306b\u306fuser\u306e\u4ed6\u306b\u3001now,run_at,max_runnning,compression\n\u3092\u4f7f\u3046\u3053\u3068\u304c\u51fa\u6765\u307e\u3059\u3002\nnow\u3068run_at\u306fqueue\u30c6\u30fc\u30d6\u30eb\u306etimeout\u306b\u5024\u304c\u5165\u308a\u3001max_running\u306fmax_running\u306b\u5024\u304c\u5165\u308a\u307e\u3059\u3002\n\u7c21\u5358\u306b\u30ad\u30e5\u30fc\u306e\u6295\u5165\u3092\u884c\u3048\u307e\u3059\u304c\u3001\u6ce8\u610f\u3059\u308b\u3079\u304d\u3053\u3068\u3068\u3057\u3066\u306f\u3001\u5148\u307b\u3069\u306equeue\u30c6\u30fc\u30d6\u30eb\u306e\n\u69cb\u9020\u3067\u3082\u308f\u304b\u308b\u901a\u308aid\u304c\u30e6\u30cb\u30fc\u30af\u306b\u306a\u3063\u3066\u3044\u308b\u3053\u3068\u3067\u3059\u3002\u305d\u306e\u305f\u3081\u306b\u540c\u3058key\u306e\u30ad\u30e5\u30fc\u3092\n\u6295\u5165\u3057\u3088\u3046\u3068\u3059\u308b\u3068\u30a8\u30e9\u30fc\u306b\u306a\u3063\u3066\u3057\u307e\u3044\u307e\u3059\u3002\n$ bundle exec ruby ./app/enqueue.rb \ndisconnects current connection: task key=k2 already exists\n\n\u305d\u306e\u305f\u3081\u306b\u30ad\u30e5\u30fc\u3092\u6295\u5165\u3059\u308b\u305f\u3081\u306eid\u306f\u91cd\u8907\u3057\u306a\u3044\u3088\u3046\u306b\u5b9f\u884c\u3059\u308bhost\u306e\u540d\u524d\u3067\n\u3042\u3063\u305f\u308a\u3001\u5c0e\u5165\u3059\u308b\u6642\u523b\u3001\u3042\u308b\u3044\u306fSecureRandom.hex\u306a\u3069\u306e\u95a2\u6570\u3092\u3064\u304b\u3063\u3066\nid\u3092\u30e6\u30cb\u30fc\u30af\u306b\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\n\u30ef\u30fc\u30ab\u30fc\u306e\u5b9f\u88c5\nPerfectQueue\u3067\u306f\u3001\u6295\u5165\u3055\u308c\u305f\u30ad\u30e5\u30fc\u3092\u51e6\u7406\u305f\u3081\u306b\u306f\u3001\u30ad\u30e5\u30fc\u306e\u53d6\u308a\u51fa\u3057\u3092\u884c\u3046\ndispatcher\u3068\u30ad\u30e5\u30fc\u306b\u5fdc\u3058\u305f\u51e6\u7406\u3092\u884c\u3046handler\u306e2\u3064\u306e\u4ed5\u7d44\u307f\u3067\u30ad\u30e5\u30fc\u3092\u51e6\u7406\u3057\u3066\u304d\u307e\u3059\u3002\n\u307e\u305a\u306fdispatcher\u306e\u8a18\u8ff0\u3092\u304a\u3053\u306a\u3044\u307e\u3059\u3002\n\napp/workers/dispatch.rb\nDir[File.join(File.dirname(__FILE__), 'dispatch', '*.rb')].each {|file| require file }\n\nclass Dispatch < PerfectQueue::Application::Dispatch\n  # describe routing\n  route \"type1\" => TestHandler\n  route /^regexp-.*$/ => :TestHandler\n  route \"my_task\" => MyTaskHandler\nend\n\n\nroute\u3067\u5148\u307b\u3069\u30ad\u30e5\u30fc\u3092\u6295\u5165\u3059\u308b\u3068\u304d\u306b\u6307\u5b9a\u3057\u305f\u30ad\u30e5\u30fc\u306e\u30bf\u30a4\u30d7\u3068\u305d\u308c\u306b\u51e6\u7406\u3059\u308b\nhandler\u3092\u6307\u5b9a\u3057\u307e\u3059\u3002\nhandler\u306f\u4ee5\u4e0b\u306e\u69d8\u306b\u8a18\u8ff0\u3057\u307e\u3059\u3002\n\napp/workers/dispatch/my_task_handler.rb\nclass MyTaskHandler < PerfectQueue::Application::Base\n  # implement run method\n  def run\n    # do something ...\n    puts \"acquired task: #{task.inspect}\"\n\n    # call task.finish!, task.retry! or task.release!\n    task.finish!\n  end\nend\n\n\n\u30ad\u30e5\u30fc\u306e\u6295\u5165\u306e\u969b\u306b\u6307\u5b9a\u3057\u305f\u30c7\u30fc\u30bf\u306ftask.data\u30e1\u30bd\u30c3\u30c9\u3067\u53d6\u308a\u51fa\u3059\u3053\u3068\u304c\u51fa\u6765\u307e\u3059\u3002\n\nPerfectQueue\u306e\u5b9f\u884c\n\u30ad\u30e5\u30fc\u306e\u5b9f\u884c\u306f\u4ee5\u4e0b\u306e\u30b3\u30de\u30f3\u30c9\u3067\u5b9f\u884c\u3057\u307e\u3059\u3002\nbundle exec perfectqueue run -I. -rapp/workers/dispatch Dispatch\n\n\u30ad\u30e5\u30fc\u306e\u5b9f\u884c\u304c\u5b8c\u4e86\u3057\u305f\u72b6\u614b\u306emysql\u306e\u30c6\u30fc\u30d6\u30eb\u3067\u3059\u3002\nmysql> select * from queues;\n+---------+------------+------------------------------------+------------+----------+-------------+-------+\n| id      | timeout    | data                               | created_at | resource | max_running | owner |\n+---------+------------+------------------------------------+------------+----------+-------------+-------+\n| k1      |  479709237 | {\"uid\":1,\"type\":\"my_task\"}         |       NULL | NULL     |        NULL |     0 |\n| k2      |  479709237 | {\"uid\":\"2\",\"type\":\"my_task\"}       |       NULL | NULL     |        NULL |     0 |\n+---------+------------+------------------------------------+------------+----------+-------------+-------+\n\ncreated_at\u3084reource\u304cNULL\u306b\u66f4\u65b0\u3055\u308c\u3001timeout\u3082\u66f4\u65b0\u3055\u308c\u3066\u3044\u307e\u3059\u3002\nworker\u30d7\u30ed\u30bb\u30b9\u3092\u8907\u6570\u8d77\u52d5\u3057\u305f\u3044\u5834\u5408\u306f\u3001perfectqueue.yml\u306bprocessors\n\u306e\u9805\u76ee\u3092\u8ffd\u52a0\u3057\u307e\u3059\u3002\n\nconfig/perfectqueue.yml\ndevelopment:\n  type: rdb_compat\n  url: mysql2://root:@localhost:3306/perfectqueue\n  table: queues\n  processors: 2\n\n\n\u3053\u306e\u72b6\u614b\u3067PerfectQueue\u3092\u8d77\u52d5\u3057\u3066\u30d7\u30ed\u30bb\u30b9\u3092\u78ba\u8a8d\u3059\u308b\u3068\u4ee5\u4e0b\u306e\u3088\u3046\u306b\n2\u3064\u306e\u30d7\u30ed\u30bb\u30b9\u304c\u52d5\u3044\u3066\u3044\u308b\u3053\u3068\u304c\u78ba\u8a8d\u3067\u304d\u307e\u3059\u3002\n$ ps aux | grep perfectqueue\nec2-user  9478  5.8  2.9 297856 30392 pts/2    Sl+  15:58   0:00 ruby2.2 /home/ec2-user/projects/perfectqueue/vendor/bundle/ruby/2.2/bin/perfectqueue run -I. -rapp/workers/dispatch Dispatch\nec2-user  9481  0.0  2.5 298020 26324 pts/2    Sl+  15:58   0:00 perfectqueue-supervisor:Dispatch                                                                                            \nec2-user  9486  0.2  2.9 385320 30548 pts/2    Sl+  15:58   0:00 perfectqueue:Dispatch 1                                                                                                     \nec2-user  9491  0.2  2.9 385188 30532 pts/2    Sl+  15:58   0:00 perfectqueue:Dispatch 2 \n\n\n\u307e\u3068\u3081\n\u99c6\u3051\u8db3\u3067\u306f\u3042\u308a\u307e\u3057\u305f\u304c\u3001PerfectQueue\u306e\u4f7f\u3044\u65b9\u3092\u898b\u3066\u304d\u307e\u3057\u305f\u3002\nAmazon RDS\u306e\u3088\u3046\u306aMySQL\u306e\u30de\u30cd\u30fc\u30b8\u30c9\u30b5\u30fc\u30d3\u30b9\u3092\u4f7f\u3048\u3070MySQL\u3082\u3059\u3050\u306b\u6e96\u5099\u3067\u304d\u308b\u306e\u3067\u3001\nRails\u306f\u4f7f\u3063\u3066\u3044\u306a\u3044\u3051\u3069\u3001Ruby\u304c\u4f7f\u3048\u308b\u74b0\u5883\u3067\u3001\u30b8\u30e7\u30d6\u30ad\u30e5\u30fc\u306e\u4ed5\u7d44\u307f\u3092\u4f7f\u3044\u305f\u3044\u3068\u3044\u3063\u305f\n\u72b6\u6cc1\u3067\u306fPerfectQueue\u306f\u6700\u9069\u3067\u306f\u306a\u3044\u304b\u3068\u601d\u3044\u307e\u3059\u3002\n\u307e\u305f\u30ad\u30e5\u30fc\u3092\u6295\u5165\u3057\u305f\u72b6\u614b\u306eMySQL\u3092dump\u3057\u3066\u304a\u3051\u3070\u3001\u30ad\u30e5\u30fc\u3092\u51e6\u7406\u3057\u305f\u5f8c\u3067\u3082\u30ea\u30b9\u30c8\u30a2\u3057\u3066\u518d\u5ea6\n\u30ad\u30e5\u30fc\u3092\u51e6\u7406\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u308b\u306e\u3067\u3001handler\u306e\u5b9f\u88c5\u3068\u52d5\u4f5c\u78ba\u8a8d\u3082\u7c21\u5358\u306b\u884c\u3046\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\nTreasureData\u88fd\u306e\u5206\u6563\u30ad\u30e5\u30fc [PerfectQueue](https://github.com/treasure-data/perfectqueue)\u3092\u4f7f\u3063\u3066\u307f\u307e\u3059\u3002\nredis\u3092\u5229\u7528\u3057\u305f[Sidekiq](https://github.com/mperham/sidekiq)\u3084AWS SQS\u3092\u5229\u7528\u3057\u305f[Shoryuken](https://github.com/phstc/shoryuken)\u306e\u3088\u3046\u306bRuby\u3067\u4f7f\u3048\u308b\n\u30b8\u30e7\u30d6\u30ad\u30e5\u30fc\u306fPerfectQueue\u4ee5\u5916\u306b\u3082\u5b58\u5728\u3057\u3066\u3044\u307e\u3059\u304c\u3001PerfectQueue\u306f\u30ad\u30e5\u30fc\u306e\u7ba1\u7406\u306bMySQL\u3092\u4f7f\u3063\u3066\u3044\u308b\u3068\u3053\u308d\u304c\u7279\u5fb4\u7684\u3067\u3059\u3002\n\n# \u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\nPerfectQueue\u306fRuby\u3067\u4f5c\u3089\u308c\u3066\u3044\u308b\u306e\u3067\u3001\u901a\u5e38\u306eRuby\u306e\u30d7\u30ed\u30c0\u30af\u30c8\u3068\u540c\u3058\u3088\u3046\u306bbundler\u3092\u7528\u3044\u3066\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3092\u884c\u3044\u307e\u3059\u3002\n\n```\nmkdir perfectqueue\ncd ./perfectqueue\nbundle init\n```\n\nGemfile\u3092\u4f5c\u6210\u3057\u305f\u5f8c\u306b\u3001\u4ee5\u4e0b\u306e\u69d8\u306bGem\u30d5\u30a1\u30a4\u30eb\u3092\u7de8\u96c6\u3057\u307e\u3059\u3002\n\n```ruby:Gemfile\n# frozen_string_literal: true\nsource \"https://rubygems.org\"\n\ngem \"perfectqueue\"\ngem \"json\"\ngem \"mysql2\"\n```\nGemfile\u3092\u7de8\u96c6\u304c\u7d42\u308f\u3063\u305f\u3042\u3068\u306fbundler\u3067\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3092\u5b9f\u884c\u3057\u307e\u3059\u3002\n\n```\nbundle install --path=./vendor/bundle\n```\n\nPerfectQueue\u306fMySQL\u306b\u30ad\u30e5\u30fc\u3092\u5165\u308c\u3066\u3044\u304f\u306e\u3067\u3001PerfectQueue\u3067\u4f7f\u7528\u3059\u308b\nMySQL\u306e\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n```\nmysql> create database perfectqueue;\nQuery OK, 1 row affected (0.00 sec)\n```\n\nPerfectQueue\u3067\u4f7f\u7528\u3059\u308bDB\u306e\u8a2d\u5b9a\u306f\u3001config/perfectqueue.yml\u306b\u8a18\u8ff0\u3057\u307e\u3059\u3002\n\n```yaml:config/perfectqueue.yml\ndevelopment:\n  type: rdb_compat\n  url: mysql2://root:@localhost:3306/perfectqueue\n  table: queues\n  processors: 1\n```\n\nDB\u306e\u8a2d\u5b9a\u304c\u5b8c\u4e86\u3057\u305f\u3089\u3001perfectqueue\u306einit\u30b3\u30de\u30f3\u30c9\u3067MySQL\u306bqueue\u7528\u306e\u30c6\u30fc\u30d6\u30eb\n\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n```\n$ bundle exec perfectqueue init\n```\n\nMySQL\u4e0a\u3067\u30c6\u30fc\u30d6\u30eb\u306e\u78ba\u8a8d\u3092\u884c\u3046\u3068\u3001queue\u7528\u306e\u30c6\u30fc\u30d6\u30eb\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002\n\n```\nmysql> use perfectqueue;\nmysql> desc queues;\n+-------------+---------------------+------+-----+---------+-------+\n| Field       | Type                | Null | Key | Default | Extra |\n+-------------+---------------------+------+-----+---------+-------+\n| id          | varchar(255)        | NO   | PRI | NULL    |       |\n| timeout     | int(11)             | NO   | MUL | NULL    |       |\n| data        | longblob            | NO   |     | NULL    |       |\n| created_at  | int(11)             | YES  |     | NULL    |       |\n| resource    | varchar(255)        | YES  |     | NULL    |       |\n| max_running | int(11)             | YES  |     | NULL    |       |\n| owner       | bigint(21) unsigned | NO   |     | 0       |       |\n+-------------+---------------------+------+-----+---------+-------+\n```\n\n# CLI\u3067\u306e\u30ad\u30e5\u30fc\u306e\u6295\u5165\n\nPerfectQueue\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u304c\u5b8c\u4e86\u3057\u305f\u306e\u3067\u5b9f\u969b\u306e\u30ad\u30e5\u30fc\u3092\u5c0e\u5165\u3057\u3066\u307f\u307e\u3059\u3002\n\n```\n$ bundle exec perfectqueue submit k1 my_task '{\"uid\":1}' -u user_1\n```\n\nperfectqueue submit\u304c\u30ad\u30e5\u30fc\u3092\u6295\u5165\u3059\u308b\u305f\u3081\u306e\u30b3\u30de\u30f3\u30c9\u306b\u306a\u308a\u307e\u3059\u3002\n\u305d\u308c\u4ee5\u964d\u306e\u5f15\u6570\u306fid\u3001\u30bf\u30b9\u30af\u306e\u30bf\u30a4\u30d7\u3001\u30c7\u30fc\u30bf\u306e\u9806\u306b\u8a18\u8ff0\u3057\u307e\u3059\u3002\n\u30ad\u30e5\u30fc\u306e\u6295\u5165\u304c\u5b8c\u4e86\u3057\u305f\u3089\u3001MySQL\u3067queue\u30c6\u30fc\u30d6\u30eb\u3092\u691c\u7d22\u3057\u3066\u307f\u307e\u3059\u3002\n\n```\nmysql> select * from queues;\n+----+------------+------------------------------+------------+----------+-------------+-------+\n| id | timeout    | data                         | created_at | resource | max_running | owner |\n+----+------------+------------------------------+------------+----------+-------------+-------+\n| k1 | 1479699578 | {\"uid\":1,\"type\":\"my_task\"} | 1479699578 | user_1   |        NULL |     0 |\n+----+------------+------------------------------+------------+----------+-------------+-------+\n```\n\nperfectqueue\u306e\u30b3\u30de\u30f3\u30c9\u3067\u3082\u30ad\u30e5\u30fc\u306e\u4e2d\u8eab\u3092\u78ba\u8a8d\u3059\u308b\u3053\u3068\u304c\u51fa\u6765\u307e\u3059\u3002\n\u7c21\u5358\u306a\u30b3\u30de\u30f3\u30c9\u306a\u306e\u3067\u3001ruby\u4ee5\u5916\u306e\u30d7\u30ed\u30b0\u30e9\u30e0\u304b\u3089\u3082\u30b7\u30b9\u30c6\u30e0\u30b3\u30fc\u30eb\u3067\u30ad\u30e5\u30fc\u3092\u6295\u5165\u3059\u308b\n\u3053\u3068\u306f\u5bb9\u6613\u3060\u3068\u601d\u3044\u307e\u3059\u3002\n\u305d\u306e\u5834\u5408\u306f\u3001gem install perfectqueue\u3092\u884c\u3063\u3066\u3001bundler\u306a\u3057\u3067\u3001perfectqueue\u3092\u5b9f\u884c\u3067\u304d\u308b\n\u74b0\u5883\u306b\u3057\u3066\u304a\u3044\u305f\u307b\u3046\u304c\u3044\u3044\u3067\u3057\u3087\u3046\u3002\n\n```\n$ bundle exec perfectqueue list\n                           key            type               user             status                   created_at                      timeout   data\n                            k1         my_task             user_1            waiting    2016-11-21 12:39:38 +0900    2016-11-21 12:39:38 +0900   {\"uid\"=>1}\n1 entries.\n```\n\n# Ruby\u3067\u306e\u30ad\u30e5\u30fc\u306e\u6295\u5165\n\u30ad\u30e5\u30fc\u306e\u6295\u5165\u3092ruby\u304b\u3089\u3067\u3082\u8a66\u3057\u3066\u307f\u307e\u3059\u3002\n\n```rb:enqueue.rb\nrequire 'bundler'\nBundler.require\nrequire 'yaml'\n\nenvironment = \"development\"\n\nconfigration = YAML.load_file(File.expand_path(File.join(File.dirname(__FILE__),\"..\",\"config\",\"perfectqueue.yml\")))[environment]\nqueue = PerfectQueue.open(configration)\n\nqueue.submit(\"k2\", \"my_task\", {uid:'2'},{user:\"user_2\"})\n```\nqueue.submit\u304c\u30ad\u30e5\u30fc\u306e\u6295\u5165\u3092\u5b9f\u884c\u3059\u308b\u30e1\u30bd\u30c3\u30c9\u306b\u306a\u308a\u307e\u3059\u3002\n\u5f15\u6570\u306e\u9806\u756a\u306fperfectqueue\u30b3\u30de\u30f3\u30c9\u306e\u3068\u304d\u3068\u540c\u3058\u3067\u3059\u3002\n\u7b2c4\u5f15\u6570\u306e\u30aa\u30d7\u30b7\u30e7\u30f3\u306b\u306fuser\u306e\u4ed6\u306b\u3001now,run_at,max_runnning,compression\n\u3092\u4f7f\u3046\u3053\u3068\u304c\u51fa\u6765\u307e\u3059\u3002\nnow\u3068run_at\u306fqueue\u30c6\u30fc\u30d6\u30eb\u306etimeout\u306b\u5024\u304c\u5165\u308a\u3001max_running\u306fmax_running\u306b\u5024\u304c\u5165\u308a\u307e\u3059\u3002\n\u7c21\u5358\u306b\u30ad\u30e5\u30fc\u306e\u6295\u5165\u3092\u884c\u3048\u307e\u3059\u304c\u3001\u6ce8\u610f\u3059\u308b\u3079\u304d\u3053\u3068\u3068\u3057\u3066\u306f\u3001\u5148\u307b\u3069\u306equeue\u30c6\u30fc\u30d6\u30eb\u306e\n\u69cb\u9020\u3067\u3082\u308f\u304b\u308b\u901a\u308aid\u304c\u30e6\u30cb\u30fc\u30af\u306b\u306a\u3063\u3066\u3044\u308b\u3053\u3068\u3067\u3059\u3002\u305d\u306e\u305f\u3081\u306b\u540c\u3058key\u306e\u30ad\u30e5\u30fc\u3092\n\u6295\u5165\u3057\u3088\u3046\u3068\u3059\u308b\u3068\u30a8\u30e9\u30fc\u306b\u306a\u3063\u3066\u3057\u307e\u3044\u307e\u3059\u3002\n\n```\n$ bundle exec ruby ./app/enqueue.rb \ndisconnects current connection: task key=k2 already exists\n```\n\n\u305d\u306e\u305f\u3081\u306b\u30ad\u30e5\u30fc\u3092\u6295\u5165\u3059\u308b\u305f\u3081\u306eid\u306f\u91cd\u8907\u3057\u306a\u3044\u3088\u3046\u306b\u5b9f\u884c\u3059\u308bhost\u306e\u540d\u524d\u3067\n\u3042\u3063\u305f\u308a\u3001\u5c0e\u5165\u3059\u308b\u6642\u523b\u3001\u3042\u308b\u3044\u306fSecureRandom.hex\u306a\u3069\u306e\u95a2\u6570\u3092\u3064\u304b\u3063\u3066\nid\u3092\u30e6\u30cb\u30fc\u30af\u306b\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\n# \u30ef\u30fc\u30ab\u30fc\u306e\u5b9f\u88c5\nPerfectQueue\u3067\u306f\u3001\u6295\u5165\u3055\u308c\u305f\u30ad\u30e5\u30fc\u3092\u51e6\u7406\u305f\u3081\u306b\u306f\u3001\u30ad\u30e5\u30fc\u306e\u53d6\u308a\u51fa\u3057\u3092\u884c\u3046\ndispatcher\u3068\u30ad\u30e5\u30fc\u306b\u5fdc\u3058\u305f\u51e6\u7406\u3092\u884c\u3046handler\u306e2\u3064\u306e\u4ed5\u7d44\u307f\u3067\u30ad\u30e5\u30fc\u3092\u51e6\u7406\u3057\u3066\u304d\u307e\u3059\u3002\n\u307e\u305a\u306fdispatcher\u306e\u8a18\u8ff0\u3092\u304a\u3053\u306a\u3044\u307e\u3059\u3002\n\n```rb:app/workers/dispatch.rb\nDir[File.join(File.dirname(__FILE__), 'dispatch', '*.rb')].each {|file| require file }\n\nclass Dispatch < PerfectQueue::Application::Dispatch\n  # describe routing\n  route \"type1\" => TestHandler\n  route /^regexp-.*$/ => :TestHandler\n  route \"my_task\" => MyTaskHandler\nend\n```\nroute\u3067\u5148\u307b\u3069\u30ad\u30e5\u30fc\u3092\u6295\u5165\u3059\u308b\u3068\u304d\u306b\u6307\u5b9a\u3057\u305f\u30ad\u30e5\u30fc\u306e\u30bf\u30a4\u30d7\u3068\u305d\u308c\u306b\u51e6\u7406\u3059\u308b\nhandler\u3092\u6307\u5b9a\u3057\u307e\u3059\u3002\nhandler\u306f\u4ee5\u4e0b\u306e\u69d8\u306b\u8a18\u8ff0\u3057\u307e\u3059\u3002\n\n```rb:app/workers/dispatch/my_task_handler.rb\nclass MyTaskHandler < PerfectQueue::Application::Base\n  # implement run method\n  def run\n    # do something ...\n    puts \"acquired task: #{task.inspect}\"\n\n    # call task.finish!, task.retry! or task.release!\n    task.finish!\n  end\nend\n```\n\n\u30ad\u30e5\u30fc\u306e\u6295\u5165\u306e\u969b\u306b\u6307\u5b9a\u3057\u305f\u30c7\u30fc\u30bf\u306ftask.data\u30e1\u30bd\u30c3\u30c9\u3067\u53d6\u308a\u51fa\u3059\u3053\u3068\u304c\u51fa\u6765\u307e\u3059\u3002\n# PerfectQueue\u306e\u5b9f\u884c\n\n\u30ad\u30e5\u30fc\u306e\u5b9f\u884c\u306f\u4ee5\u4e0b\u306e\u30b3\u30de\u30f3\u30c9\u3067\u5b9f\u884c\u3057\u307e\u3059\u3002\n\n```\nbundle exec perfectqueue run -I. -rapp/workers/dispatch Dispatch\n```\n\n\u30ad\u30e5\u30fc\u306e\u5b9f\u884c\u304c\u5b8c\u4e86\u3057\u305f\u72b6\u614b\u306emysql\u306e\u30c6\u30fc\u30d6\u30eb\u3067\u3059\u3002\n\n```\nmysql> select * from queues;\n+---------+------------+------------------------------------+------------+----------+-------------+-------+\n| id      | timeout    | data                               | created_at | resource | max_running | owner |\n+---------+------------+------------------------------------+------------+----------+-------------+-------+\n| k1      |  479709237 | {\"uid\":1,\"type\":\"my_task\"}         |       NULL | NULL     |        NULL |     0 |\n| k2      |  479709237 | {\"uid\":\"2\",\"type\":\"my_task\"}       |       NULL | NULL     |        NULL |     0 |\n+---------+------------+------------------------------------+------------+----------+-------------+-------+\n```\n\ncreated_at\u3084reource\u304cNULL\u306b\u66f4\u65b0\u3055\u308c\u3001timeout\u3082\u66f4\u65b0\u3055\u308c\u3066\u3044\u307e\u3059\u3002\nworker\u30d7\u30ed\u30bb\u30b9\u3092\u8907\u6570\u8d77\u52d5\u3057\u305f\u3044\u5834\u5408\u306f\u3001perfectqueue.yml\u306bprocessors\n\u306e\u9805\u76ee\u3092\u8ffd\u52a0\u3057\u307e\u3059\u3002\n\n```yaml:config/perfectqueue.yml\ndevelopment:\n  type: rdb_compat\n  url: mysql2://root:@localhost:3306/perfectqueue\n  table: queues\n  processors: 2\n```\n\n\u3053\u306e\u72b6\u614b\u3067PerfectQueue\u3092\u8d77\u52d5\u3057\u3066\u30d7\u30ed\u30bb\u30b9\u3092\u78ba\u8a8d\u3059\u308b\u3068\u4ee5\u4e0b\u306e\u3088\u3046\u306b\n2\u3064\u306e\u30d7\u30ed\u30bb\u30b9\u304c\u52d5\u3044\u3066\u3044\u308b\u3053\u3068\u304c\u78ba\u8a8d\u3067\u304d\u307e\u3059\u3002\n\n```\n$ ps aux | grep perfectqueue\nec2-user  9478  5.8  2.9 297856 30392 pts/2    Sl+  15:58   0:00 ruby2.2 /home/ec2-user/projects/perfectqueue/vendor/bundle/ruby/2.2/bin/perfectqueue run -I. -rapp/workers/dispatch Dispatch\nec2-user  9481  0.0  2.5 298020 26324 pts/2    Sl+  15:58   0:00 perfectqueue-supervisor:Dispatch                                                                                            \nec2-user  9486  0.2  2.9 385320 30548 pts/2    Sl+  15:58   0:00 perfectqueue:Dispatch 1                                                                                                     \nec2-user  9491  0.2  2.9 385188 30532 pts/2    Sl+  15:58   0:00 perfectqueue:Dispatch 2 \n```\n\n# \u307e\u3068\u3081\n\u99c6\u3051\u8db3\u3067\u306f\u3042\u308a\u307e\u3057\u305f\u304c\u3001PerfectQueue\u306e\u4f7f\u3044\u65b9\u3092\u898b\u3066\u304d\u307e\u3057\u305f\u3002\nAmazon RDS\u306e\u3088\u3046\u306aMySQL\u306e\u30de\u30cd\u30fc\u30b8\u30c9\u30b5\u30fc\u30d3\u30b9\u3092\u4f7f\u3048\u3070MySQL\u3082\u3059\u3050\u306b\u6e96\u5099\u3067\u304d\u308b\u306e\u3067\u3001\nRails\u306f\u4f7f\u3063\u3066\u3044\u306a\u3044\u3051\u3069\u3001Ruby\u304c\u4f7f\u3048\u308b\u74b0\u5883\u3067\u3001\u30b8\u30e7\u30d6\u30ad\u30e5\u30fc\u306e\u4ed5\u7d44\u307f\u3092\u4f7f\u3044\u305f\u3044\u3068\u3044\u3063\u305f\n\u72b6\u6cc1\u3067\u306fPerfectQueue\u306f\u6700\u9069\u3067\u306f\u306a\u3044\u304b\u3068\u601d\u3044\u307e\u3059\u3002\n\u307e\u305f\u30ad\u30e5\u30fc\u3092\u6295\u5165\u3057\u305f\u72b6\u614b\u306eMySQL\u3092dump\u3057\u3066\u304a\u3051\u3070\u3001\u30ad\u30e5\u30fc\u3092\u51e6\u7406\u3057\u305f\u5f8c\u3067\u3082\u30ea\u30b9\u30c8\u30a2\u3057\u3066\u518d\u5ea6\n\u30ad\u30e5\u30fc\u3092\u51e6\u7406\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u308b\u306e\u3067\u3001handler\u306e\u5b9f\u88c5\u3068\u52d5\u4f5c\u78ba\u8a8d\u3082\u7c21\u5358\u306b\u884c\u3046\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n", "tags": ["PerfectQueue", "Ruby", "TreasureData"]}