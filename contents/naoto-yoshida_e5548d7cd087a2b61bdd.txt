{"tags": ["Linux", "chef", "knife-solo"], "context": " More than 1 year has passed since last update.\nChef/knife-solo\u3092\u5229\u7528\u3059\u308b\ncookbook\u540d\u306f\u300cadd_user\u300d\u3068\u3059\u308b\n\u4f5c\u6210\u3059\u308b\u30e6\u30fc\u30b6\u306e\u60c5\u5831\u306fdatabag\u3078\u683c\u7d0d\u3059\u308b\n\u9375\u8a8d\u8a3cssh\u63a5\u7d9a\u306b\u5099\u3048\u3001authorized_key\u3092\u914d\u7f6e\u3059\u308b\n\n\ndata bag\u30c4\u30fc\u30eb\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3001\u30e6\u30fc\u30b6\u60c5\u5831\u3092\u683c\u7d0d\u3059\u308b\n\ndata bag \u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\u307e\u305a\u306fdata bag\u30c4\u30fc\u30eb\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3001\u5229\u7528\u3067\u304d\u308b\u3088\u3046\u306b\u3059\u308b\u3002\n# gem install knife-solo_data_bag\nFetching: knife-solo_data_bag-1.1.0.gem (100%)\nSuccessfully installed knife-solo_data_bag-1.1.0\nParsing documentation for knife-solo_data_bag-1.1.0\nInstalling ri documentation for knife-solo_data_bag-1.1.0\nDone installing documentation for knife-solo_data_bag after 0 seconds\n1 gem installed\n\n\ndata bag \u3092\u4f5c\u6210\u3059\u308b\n\u4f5c\u6210\u3059\u308b\u30e6\u30fc\u30b6\u60c5\u5831\u3092\u3057\u307e\u3046\u305f\u3081\u306e\u7bb1\u3092\u6e96\u5099\u3059\u308b\n\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3059\u308b\u3068data_bags\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306e\u4e0b\u306b\u300cusers\u300d\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u304c\u4f5c\u6210\u3055\u308c\u308b\n$ knife solo data bag create users\n$ ls data_bags/\nusers\n\n\n\u4f5c\u6210\u3059\u308b\u30e6\u30fc\u30b6\u306e\u60c5\u5831\u3092\u4f5c\u6210\u3057\u3001\u4fdd\u5b58\u3059\u308b\n\u30e6\u30fc\u30b6\u60c5\u5831\u3092json\u306b\u8a18\u8f09\u3057\u3066\u3001data_bags/users\u914d\u4e0b\u3078\u4fdd\u5b58\u3059\u308b\n\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3059\u308b\u3068\u305d\u306e\u307e\u307e\u7de8\u96c6\u30e2\u30fc\u30c9\u306b\u306a\u308b\u306e\u3067\u3001\u7de8\u96c6\u5b9f\u65bd\n$ export DISPLAY=vi\n$ knife solo data bag create users hogehoge\n\n\nhogehoge.json\n{\n  \"id\": \"hogehoge\",\n  \"groups\": [\n    {\n      \"name\": \"hogehoge\",\n      \"gid\": 2001\n    }\n  ],\n  \"users\": [\n    {\n      \"name\": \"hogehoge\",\n      \"home\": \"/home/hogehoge\",\n      \"shell\": \"/bin/nologin\",\n      \"uid\": 2001,\n      \"gid\": 2001\n    }\n  ]\n}\n\n\n\u4f5c\u6210\u3059\u308b\u30e6\u30fc\u30b6\u5206\u540c\u69d8\u306bjson\u3092\u4f5c\u6210\u3059\u308b\n\nCookbook\u3092\u4f5c\u6210\u3057\u3001Recipe\u306a\u3069\u3092\u7de8\u96c6\u3057\u3066\u3044\u304f\n\ncookbook\u3092\u4f5c\u6210\u3059\u308b\n$ knife cookbook create add_user -o site-cookbooks\nDL is deprecated, please use Fiddle\nffi-yajl/json_gem is deprecated, these monkeypatches will be dropped shortly\n** Creating cookbook add_user\n** Creating README for cookbook: add_user\n** Creating CHANGELOG for cookbook: add_user\n** Creating metadata for cookbook: add_user\n\n\nRecipe\u3092\u7de8\u96c6\u3059\u308b\n\n\u30e6\u30fc\u30b6\u306e\u30db\u30fc\u30e0\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306f/home\n\u305f\u3060\u3057\u3001/home\u306f/var/home\u3078\u306e\u30b7\u30f3\u30dc\u30ea\u30c3\u30af\u30ea\u30f3\u30af\n\u306a\u306e\u3067\u3001/var/home\u3092\u4f5c\u6210\u3057\u3001/home\u306e\u30b7\u30f3\u30dc\u30ea\u30c3\u30af\u30ea\u30f3\u30af\u3092\u4f5c\u6210\u3059\u308b\nknife-solo\u5b9f\u884c\u30e6\u30fc\u30b6\u306f\u3001\u4e88\u3081\u300c/opt/home\u300d\u3092\u30db\u30fc\u30e0\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3068\u3057\u3066\u4f5c\u6210\u6e08\u307f\n\n\nsite-cookbooks/add_user/recipes/default.rb\n# /var/home\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u4f5c\u6210\n# /var/home\u306e\u5b58\u5728\u78ba\u8a8d\u3092not_if\u306b\u3066\u5b9f\u65bd\ndirectory \"/var/home\" do\n  owner \"root\"\n  group \"root\"\n  mode  \"0777\"\n  action :create\n  not_if { File.exists? \"/var/home\" }\nend\n\n# /home\u524a\u9664\n# /home\u306e\u5b58\u5728\u78ba\u8a8d\u3092not_if\u306b\u3066\u5b9f\u65bd\ndirectory \"/home\" do\n  action :delete\n  not_if \"test -L /home\"\nend\n\n# \u30b7\u30f3\u30dc\u30ea\u30c3\u30af\u30ea\u30f3\u30af\u3092\u4f5c\u6210\n# /home\u306e\u5b58\u5728\u78ba\u8a8d\u3092not_if\u306b\u3066\u5b9f\u65bd\nlink \"/home\" do\n  to \"/var/home\"\n  not_if \"test -L /home\"\nend\n\n\n# \u30e6\u30fc\u30b6\u4f5c\u6210\n# data_bag/users\u914d\u4e0b\u306b\u3042\u308bjson\u3059\u3079\u3066\u3092\u8aad\u307f\u306b\u884c\u304f\ndata_ids = data_bag('users')\n\ndata_ids.each do |id|\n  item = data_bag_item('users',id)\n\n item['groups'].each do |g|\n    group g['name'] do\n      gid g['gid']\n      action :create\n    end\n  end\n\n  item['users'].each do |u|\n    user u['name'] do\n      home  u['home']\n      shell u['shell']\n      password u['password']\n      uid   u['uid']\n      gid   u['gid']\n      supports :manage_home => true\n      action :create\n    end\n    directory \"/#{u['home']}/.ssh\" do\n      owner u['uid']\n      group u['gid']\n      mode  '0700'\n      action :create\n    end\n    # ssh_authorized_keys \u3092\u914d\u7f6e\n    # site-cookbooks/add_user/files/default/\u306b\u9375\u3092\u914d\u7f6e\u3057\u3066\u304a\u304f\n    cookbook_file \"/#{u['home']}/.ssh/authorized_keys\" do\n      source \"#{u['name']}_authorized_keys\"\n      action :create\n      owner  u['uid']\n      group  u['gid']\n      mode   '0600'\n    end\n  end\nend\n\n# wheel\u30b0\u30eb\u30fc\u30d7\u3078\u306e\u30e6\u30fc\u30b6\u8ffd\u52a0\n# attribute\u3078\u5bfe\u8c61\u30e6\u30fc\u30b6\u3092\u8a18\u8f09\u3059\u308b\ngroup 'wheel' do\n  group_name 'wheel'\n  members node['add_user']['wheel']\n  action :modify\nend\n\n\n\nauthorized_key\u306e\u914d\u7f6e\nauthrize_key\u3092\u5229\u7528\u3057\u306a\u3044\u30e6\u30fc\u30b6\u306e\u5834\u5408\u3067\u3082\u3001\u7a7a\u30d5\u30a1\u30a4\u30eb\u3092\u914d\u7f6e\u3057\u3066\u304a\u304f\n$ ls site-cookbooks/add_user/files/default/\nhogehoge_authorized_keys  fugafuga_authorized_keys\n\n\nAttribute\u3078\u5909\u6570\u5b9a\u7fa9\nwheel\u30b0\u30eb\u30fc\u30d7\u3078\u8ffd\u52a0\u3059\u308b\u30e6\u30fc\u30b6\u3092\u5916\u51fa\u3057\u5909\u6570\u3068\u3057\u3066\u8a2d\u5b9a\u3059\u308b\n\nsite-cookbooks/add_user/recipes/default.rb\ndefault['add_user']['wheel'] = ['root','hogehoge','fugafuga']\n\n\n\nnode\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u7de8\u96c6\u3057\u3001\u5b9f\u969b\u306b\u8a66\u3057\u3066\u307f\u308b\n\nnode\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u7de8\u96c6\n\nnodes/Test-hogehoge.json\n{\n    \"run_list\": [\n      \"recipe[add_user]\"\n    ]\n}\n\n\n\n\u5b9f\u884c\u3057\u3066\u307f\u308b\n$ knife solo cook -i ~/.ssh/usr-fugafuga.pem usr-fugafuga@remote-hogehoge\n\nusr-fugafuga\u304c\u30d7\u30ed\u30d3\u30b8\u30e7\u30cb\u30f3\u30b0\u7528\u306e\u30e6\u30fc\u30b6\n\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u5074\u3067\u306f\u30e6\u30fc\u30b6\u306e\u4f5c\u6210\u3068sudo\u8a2d\u5b9a\u304c\u5b8c\u4e86\u3057\u3066\u3044\u308b\n* Chef/knife-solo\u3092\u5229\u7528\u3059\u308b\n* cookbook\u540d\u306f\u300cadd_user\u300d\u3068\u3059\u308b\n* \u4f5c\u6210\u3059\u308b\u30e6\u30fc\u30b6\u306e\u60c5\u5831\u306fdatabag\u3078\u683c\u7d0d\u3059\u308b\n* \u9375\u8a8d\u8a3cssh\u63a5\u7d9a\u306b\u5099\u3048\u3001authorized_key\u3092\u914d\u7f6e\u3059\u308b\n\n\n# data bag\u30c4\u30fc\u30eb\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3001\u30e6\u30fc\u30b6\u60c5\u5831\u3092\u683c\u7d0d\u3059\u308b\n## data bag \u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\u307e\u305a\u306fdata bag\u30c4\u30fc\u30eb\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3001\u5229\u7528\u3067\u304d\u308b\u3088\u3046\u306b\u3059\u308b\u3002\n<pre>\n\\# gem install knife-solo_data_bag\nFetching: knife-solo_data_bag-1.1.0.gem (100%)\nSuccessfully installed knife-solo_data_bag-1.1.0\nParsing documentation for knife-solo_data_bag-1.1.0\nInstalling ri documentation for knife-solo_data_bag-1.1.0\nDone installing documentation for knife-solo_data_bag after 0 seconds\n1 gem installed\n</pre>\n\n## data bag \u3092\u4f5c\u6210\u3059\u308b\n\u4f5c\u6210\u3059\u308b\u30e6\u30fc\u30b6\u60c5\u5831\u3092\u3057\u307e\u3046\u305f\u3081\u306e\u7bb1\u3092\u6e96\u5099\u3059\u308b\n\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3059\u308b\u3068data_bags\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306e\u4e0b\u306b\u300cusers\u300d\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u304c\u4f5c\u6210\u3055\u308c\u308b\n<pre>\n$ knife solo data bag create users\n$ ls data_bags/\nusers\n</pre>\n\n## \u4f5c\u6210\u3059\u308b\u30e6\u30fc\u30b6\u306e\u60c5\u5831\u3092\u4f5c\u6210\u3057\u3001\u4fdd\u5b58\u3059\u308b\n\u30e6\u30fc\u30b6\u60c5\u5831\u3092json\u306b\u8a18\u8f09\u3057\u3066\u3001data_bags/users\u914d\u4e0b\u3078\u4fdd\u5b58\u3059\u308b\n\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3059\u308b\u3068\u305d\u306e\u307e\u307e\u7de8\u96c6\u30e2\u30fc\u30c9\u306b\u306a\u308b\u306e\u3067\u3001\u7de8\u96c6\u5b9f\u65bd\n<pre>\n$ export DISPLAY=vi\n$ knife solo data bag create users hogehoge\n</pre>\n\n```json:hogehoge.json\n{\n  \"id\": \"hogehoge\",\n  \"groups\": [\n    {\n      \"name\": \"hogehoge\",\n      \"gid\": 2001\n    }\n  ],\n  \"users\": [\n    {\n      \"name\": \"hogehoge\",\n      \"home\": \"/home/hogehoge\",\n      \"shell\": \"/bin/nologin\",\n      \"uid\": 2001,\n      \"gid\": 2001\n    }\n  ]\n}\n```\n\u4f5c\u6210\u3059\u308b\u30e6\u30fc\u30b6\u5206\u540c\u69d8\u306bjson\u3092\u4f5c\u6210\u3059\u308b\n\n# Cookbook\u3092\u4f5c\u6210\u3057\u3001Recipe\u306a\u3069\u3092\u7de8\u96c6\u3057\u3066\u3044\u304f\n## cookbook\u3092\u4f5c\u6210\u3059\u308b\n<pre>\n$ knife cookbook create add_user -o site-cookbooks\nDL is deprecated, please use Fiddle\nffi-yajl/json_gem is deprecated, these monkeypatches will be dropped shortly\n** Creating cookbook add_user\n** Creating README for cookbook: add_user\n** Creating CHANGELOG for cookbook: add_user\n** Creating metadata for cookbook: add_user\n</pre>\n\n## Recipe\u3092\u7de8\u96c6\u3059\u308b\n* \u30e6\u30fc\u30b6\u306e\u30db\u30fc\u30e0\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306f/home<br />\n\u305f\u3060\u3057\u3001/home\u306f/var/home\u3078\u306e\u30b7\u30f3\u30dc\u30ea\u30c3\u30af\u30ea\u30f3\u30af<br />\n\u306a\u306e\u3067\u3001/var/home\u3092\u4f5c\u6210\u3057\u3001/home\u306e\u30b7\u30f3\u30dc\u30ea\u30c3\u30af\u30ea\u30f3\u30af\u3092\u4f5c\u6210\u3059\u308b\n* knife-solo\u5b9f\u884c\u30e6\u30fc\u30b6\u306f\u3001\u4e88\u3081\u300c/opt/home\u300d\u3092\u30db\u30fc\u30e0\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3068\u3057\u3066\u4f5c\u6210\u6e08\u307f\n\n```rb:site-cookbooks/add_user/recipes/default.rb\n# /var/home\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u4f5c\u6210\n# /var/home\u306e\u5b58\u5728\u78ba\u8a8d\u3092not_if\u306b\u3066\u5b9f\u65bd\ndirectory \"/var/home\" do\n  owner \"root\"\n  group \"root\"\n  mode  \"0777\"\n  action :create\n  not_if { File.exists? \"/var/home\" }\nend\n\n# /home\u524a\u9664\n# /home\u306e\u5b58\u5728\u78ba\u8a8d\u3092not_if\u306b\u3066\u5b9f\u65bd\ndirectory \"/home\" do\n  action :delete\n  not_if \"test -L /home\"\nend\n\n# \u30b7\u30f3\u30dc\u30ea\u30c3\u30af\u30ea\u30f3\u30af\u3092\u4f5c\u6210\n# /home\u306e\u5b58\u5728\u78ba\u8a8d\u3092not_if\u306b\u3066\u5b9f\u65bd\nlink \"/home\" do\n  to \"/var/home\"\n  not_if \"test -L /home\"\nend\n\n\n# \u30e6\u30fc\u30b6\u4f5c\u6210\n# data_bag/users\u914d\u4e0b\u306b\u3042\u308bjson\u3059\u3079\u3066\u3092\u8aad\u307f\u306b\u884c\u304f\ndata_ids = data_bag('users')\n\ndata_ids.each do |id|\n  item = data_bag_item('users',id)\n\n item['groups'].each do |g|\n    group g['name'] do\n      gid g['gid']\n      action :create\n    end\n  end\n\n  item['users'].each do |u|\n    user u['name'] do\n      home  u['home']\n      shell u['shell']\n      password u['password']\n      uid   u['uid']\n      gid   u['gid']\n      supports :manage_home => true\n      action :create\n    end\n    directory \"/#{u['home']}/.ssh\" do\n      owner u['uid']\n      group u['gid']\n      mode  '0700'\n      action :create\n    end\n    # ssh_authorized_keys \u3092\u914d\u7f6e\n    # site-cookbooks/add_user/files/default/\u306b\u9375\u3092\u914d\u7f6e\u3057\u3066\u304a\u304f\n    cookbook_file \"/#{u['home']}/.ssh/authorized_keys\" do\n      source \"#{u['name']}_authorized_keys\"\n      action :create\n      owner  u['uid']\n      group  u['gid']\n      mode   '0600'\n    end\n  end\nend\n\n# wheel\u30b0\u30eb\u30fc\u30d7\u3078\u306e\u30e6\u30fc\u30b6\u8ffd\u52a0\n# attribute\u3078\u5bfe\u8c61\u30e6\u30fc\u30b6\u3092\u8a18\u8f09\u3059\u308b\ngroup 'wheel' do\n  group_name 'wheel'\n  members node['add_user']['wheel']\n  action :modify\nend\n```\n\n## authorized_key\u306e\u914d\u7f6e\nauthrize_key\u3092\u5229\u7528\u3057\u306a\u3044\u30e6\u30fc\u30b6\u306e\u5834\u5408\u3067\u3082\u3001\u7a7a\u30d5\u30a1\u30a4\u30eb\u3092\u914d\u7f6e\u3057\u3066\u304a\u304f\n<pre>\n$ ls site-cookbooks/add_user/files/default/\nhogehoge_authorized_keys  fugafuga_authorized_keys\n</pre>\n\n## Attribute\u3078\u5909\u6570\u5b9a\u7fa9\nwheel\u30b0\u30eb\u30fc\u30d7\u3078\u8ffd\u52a0\u3059\u308b\u30e6\u30fc\u30b6\u3092\u5916\u51fa\u3057\u5909\u6570\u3068\u3057\u3066\u8a2d\u5b9a\u3059\u308b\n\n```rb:site-cookbooks/add_user/recipes/default.rb\ndefault['add_user']['wheel'] = ['root','hogehoge','fugafuga']\n```\n\n# node\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u7de8\u96c6\u3057\u3001\u5b9f\u969b\u306b\u8a66\u3057\u3066\u307f\u308b\n## node\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u7de8\u96c6\n\n```json:nodes/Test-hogehoge.json\n{\n    \"run_list\": [\n      \"recipe[add_user]\"\n    ]\n}\n```\n\n# \u5b9f\u884c\u3057\u3066\u307f\u308b\n<pre>\n$ knife solo cook -i ~/.ssh/usr-fugafuga.pem usr-fugafuga@remote-hogehoge\n</pre>\nusr-fugafuga\u304c\u30d7\u30ed\u30d3\u30b8\u30e7\u30cb\u30f3\u30b0\u7528\u306e\u30e6\u30fc\u30b6\n\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u5074\u3067\u306f\u30e6\u30fc\u30b6\u306e\u4f5c\u6210\u3068sudo\u8a2d\u5b9a\u304c\u5b8c\u4e86\u3057\u3066\u3044\u308b\n"}