{"context": "\u30c7\u30d5\u30a9\u30eb\u30c8\u3067\u7528\u610f\u3055\u308c\u3066\u3044\u308bData source\u306e\u300cre:dash metadata\u300d\u3067\u53d6\u308c\u308b\u5404\u7a2e\u7d71\u8a08\u5024\u3067\u3059\u3002\n\n\u65e5\u5225\u306e\u30af\u30a8\u30ea\u6570\u3001\u95b2\u89a7\u6570\nSELECT \n  to_date(to_char(created_at,'YYYY-MM-DD'),'YYYY-MM-DD') AS created_at,\n  SUM(CASE WHEN action = 'execute' THEN 1 ELSE 0 END) AS execute,\n  SUM(CASE WHEN action = 'view' THEN 1 ELSE 0 END) AS view\nFROM events\nWHERE \n  created_at BETWEEN NOW() - interval '6 month' AND NOW()\nGROUP BY 1\nORDER BY 1\n\n\n\u30c0\u30c3\u30b7\u30e5\u30dc\u30fc\u30c9\u5225\u95b2\u89a7\u6570(query\u3078\u306e\u30ea\u30f3\u30af\u4ed8\u304d)\nSELECT\n  '<a href=\"/dashboard/' || d.slug || '\" target=\"_blank\">' || d.name || '</a>' AS name,\n  COUNT(e.id) AS cnt,\n  COUNT(DISTINCT e.user_id) AS uu_cnt\nFROM events e \nINNER JOIN dashboards d ON CAST(e.object_id AS INTEGER) = d.id\nWHERE \n  e.action = 'view' AND e.object_type = 'dashboard'\n  AND e.created_at BETWEEN NOW() - INTERVAL '2 week' AND NOW()\nGROUP BY 1\nORDER BY 2 DESC\n\n\n\u6708\u5225query\u4f5c\u6210\u6570\nSELECT\n  to_char(created_at, 'YYYY-mm-01') AS month,\n  COUNT(id) AS cnt\nFROM queries\nGROUP BY 1\nORDER BY 1\n\n\n\u30b9\u30b1\u30b8\u30e5\u30fc\u30eb\u3055\u308c\u305fquery\u6570(\u6642\u9593\u5225\u3001data source\u5225)\nWITH cal AS (\n  SELECT t1.schedule, ds.id, ds.name\n  FROM (\n    SELECT schedule\n    FROM queries\n    WHERE schedule LIKE '__:__'\n    GROUP BY 1\n  ) AS t1, data_sources ds\n), q AS (\n  SELECT\n    qs.schedule,\n    qs.data_source_id,\n    COUNT(qs.id) AS cnt,\n    SUM(qr.runtime) AS runtime\n  FROM queries qs\n  INNER JOIN query_results qr ON qs.latest_query_data_id = qr.id\n  WHERE qs.is_archived = false AND qs.schedule LIKE '__:__'\n  GROUP BY 1,2\n)\n\nSELECT\n  to_char(to_timestamp(to_char(CURRENT_DATE - interval '1 day','YYYY-MM-DD ') || cal.schedule,'YYYY-MM-DD HH24:MI') + interval '9 hour', 'HH24:MI') AS schedule,\n  cal.name,\n  q.cnt,\n  q.runtime\nFROM \n  cal \n  LEFT OUTER JOIN q ON q.data_source_id = cal.id AND q.schedule = cal.schedule\nORDER BY 1\n\n\u30b0\u30e9\u30d5\u5316\u306f\u9069\u5f53\u306b\u3084\u3063\u3066\u304f\u3060\u3055\u3044\u3002\n\n\u30c7\u30d5\u30a9\u30eb\u30c8\u3067\u7528\u610f\u3055\u308c\u3066\u3044\u308bData source\u306e\u300cre:dash metadata\u300d\u3067\u53d6\u308c\u308b\u5404\u7a2e\u7d71\u8a08\u5024\u3067\u3059\u3002\n\n\n### \u65e5\u5225\u306e\u30af\u30a8\u30ea\u6570\u3001\u95b2\u89a7\u6570\n```sql\nSELECT \n  to_date(to_char(created_at,'YYYY-MM-DD'),'YYYY-MM-DD') AS created_at,\n  SUM(CASE WHEN action = 'execute' THEN 1 ELSE 0 END) AS execute,\n  SUM(CASE WHEN action = 'view' THEN 1 ELSE 0 END) AS view\nFROM events\nWHERE \n  created_at BETWEEN NOW() - interval '6 month' AND NOW()\nGROUP BY 1\nORDER BY 1\n```\n\n### \u30c0\u30c3\u30b7\u30e5\u30dc\u30fc\u30c9\u5225\u95b2\u89a7\u6570(query\u3078\u306e\u30ea\u30f3\u30af\u4ed8\u304d)\n```sql\nSELECT\n  '<a href=\"/dashboard/' || d.slug || '\" target=\"_blank\">' || d.name || '</a>' AS name,\n  COUNT(e.id) AS cnt,\n  COUNT(DISTINCT e.user_id) AS uu_cnt\nFROM events e \nINNER JOIN dashboards d ON CAST(e.object_id AS INTEGER) = d.id\nWHERE \n  e.action = 'view' AND e.object_type = 'dashboard'\n  AND e.created_at BETWEEN NOW() - INTERVAL '2 week' AND NOW()\nGROUP BY 1\nORDER BY 2 DESC\n```\n\n### \u6708\u5225query\u4f5c\u6210\u6570\n\n```sql\nSELECT\n  to_char(created_at, 'YYYY-mm-01') AS month,\n  COUNT(id) AS cnt\nFROM queries\nGROUP BY 1\nORDER BY 1\n```\n\n### \u30b9\u30b1\u30b8\u30e5\u30fc\u30eb\u3055\u308c\u305fquery\u6570(\u6642\u9593\u5225\u3001data source\u5225)\n\n```sql\nWITH cal AS (\n  SELECT t1.schedule, ds.id, ds.name\n  FROM (\n    SELECT schedule\n    FROM queries\n    WHERE schedule LIKE '__:__'\n    GROUP BY 1\n  ) AS t1, data_sources ds\n), q AS (\n  SELECT\n    qs.schedule,\n    qs.data_source_id,\n    COUNT(qs.id) AS cnt,\n    SUM(qr.runtime) AS runtime\n  FROM queries qs\n  INNER JOIN query_results qr ON qs.latest_query_data_id = qr.id\n  WHERE qs.is_archived = false AND qs.schedule LIKE '__:__'\n  GROUP BY 1,2\n)\n\nSELECT\n  to_char(to_timestamp(to_char(CURRENT_DATE - interval '1 day','YYYY-MM-DD ') || cal.schedule,'YYYY-MM-DD HH24:MI') + interval '9 hour', 'HH24:MI') AS schedule,\n  cal.name,\n  q.cnt,\n  q.runtime\nFROM \n  cal \n  LEFT OUTER JOIN q ON q.data_source_id = cal.id AND q.schedule = cal.schedule\nORDER BY 1\n```\n\n\u30b0\u30e9\u30d5\u5316\u306f\u9069\u5f53\u306b\u3084\u3063\u3066\u304f\u3060\u3055\u3044\u3002\n", "tags": ["redash"]}