{"context": "devise\u3068OmniAuth\u3092\u4f7f\u3063\u305f\u30ed\u30b0\u30a4\u30f3\u3092\u5b9f\u73fe\u3059\u308b\u624b\u7d9a\u304d\u3092\u7d39\u4ecb\u3057\u305f\u8a18\u4e8b\u306f\u591a\u3044\u3082\u306e\u306e\u3001\u30ed\u30b0\u30a4\u30f3\u5f8c\u3001Google API\u3092\u4f7f\u3063\u3066\u30c7\u30fc\u30bf\u3092\u53d6\u5f97\u3059\u308b\u969b\u306b\u5fc5\u8981\u3068\u306a\u308brefresh_token\u306b\u3064\u3044\u3066\u66f8\u304b\u308c\u305f\u30da\u30fc\u30b8\u304c\u3042\u307e\u308a\u898b\u3064\u304b\u3089\u305a\u3001\u8907\u6570\u306e\u8a18\u4e8b\u306e\u5185\u5bb9\u3092\u30d4\u30c3\u30af\u30a2\u30c3\u30d7\u3057\u306a\u304c\u3089\u5b9f\u88c5\u3059\u308b\u5fc5\u8981\u306b\u8feb\u3089\u308c\u305f\u306e\u3067\u3001\u305d\u306e\u6642\u306b\u53c2\u7167\u3057\u305f\u5185\u5bb9\u3092\u307e\u3068\u3081\u307e\u3057\u305f\u3002\n\n\n\u74b0\u5883\n\n\nruby 2.3.1p112\nRails 4.2.6\n\n\n\n\n\n1.\u4e0b\u6e96\u5099\n\u5fc5\u8981\u306agem\u3092Gemfile\u306b\u8ffd\u8a18\u3057\u3066\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u307e\u3059\u3002\n\nGemfile\ngem 'devise'\ngem 'omniauth'\ngem 'omniauth-google-oauth2'\n\n\n$ bundle install\n\ndevise\u306e\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u3068\u3001devise\u3067User\u30e2\u30c7\u30eb\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n$ rails g devise:install\n$ rails g devise user\n$ rails g migration add_omniauth_to_users\n\n\n2.\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306e\u7528\u610f\ndevise\u304c\u4f5c\u6210\u3057\u305fUser\u30e2\u30c7\u30eb\u306bOmniAuth\u3067\u5fc5\u8981\u3068\u306a\u308b\u30ab\u30e9\u30e0\u3092\u8ffd\u52a0\u3057\u307e\u3059\u3002\n\ndb/migrate/add_omniauth_to_users.rb\nclass AddOmniauthToUsers < ActiveRecord::Migration\n  def change\n    add_column :users, :provider, :string\n    add_column :users, :uid, :string\n    add_column :users, :name, :string\n    add_column :users, :refresh_token, :string\n    add_column :users, :access_token, :string\n  end\nend\n\n\n\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n$ rake db:create\n$ rake db:migrate\n\n\n3.OmniAuth\u306e\u8a2d\u5b9a\u306a\u3069\ndevise\u3067\u306f\u3001\u30c7\u30d5\u30a9\u30eb\u30c8\u3067OmniAuth\u304c\u6709\u52b9\u306b\u306a\u3063\u3066\u3044\u306a\u3044\u3053\u3068\u304b\u3089\u3001app/models/user.rb\u3092\u7de8\u96c6\u3057\u3066\u6709\u52b9\u306b\u3057\u307e\u3059\u3002\n\napp/models/user.rb\nclass User < ActiveRecord::Base\n  # Include default devise modules. Others available are:\n  # :confirmable, :lockable, :timeoutable and :omniauthable\n  devise :database_authenticatable, :registerable, :recoverable,\n         :rememberable, :trackable, :validatable,:omniauthable,\n         :omniauthable, :omniauth_providers => [:google_oauth2]\n\n  def self.find_for_google_oauth2(auth)\n    user = User.where(email: auth.info.email).first\n    unless user\n      user = User.create(name:     auth.info.name,\n                         provider: auth.provider,\n                         uid:      auth.uid,\n                         email:    auth.info.email,\n                         token:    auth.credentials.token,\n                         password: Devise.friendly_token[0, 20])\n    end\n    user\n  end\nend\n\n\ndevise\u306e\u8d77\u52d5\u6642\u306e\u8a2d\u5b9a\u3092\u884c\u3046\u305f\u3081\u3001config/initializers/omniauth.rb\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3057\u3066\u6b21\u306e\u3068\u304a\u308a\u7de8\u96c6\u3057\u307e\u3059\u30021\n\nconfig/initializers/omniauth.rb\nRails.application.config.middleware.use OmniAuth::Builder do\n  provider :google_oauth2,\n    Rails.application.secrets.google_client_id,\n    Rails.application.secrets.google_client_secret,\n    {\n# \u30ed\u30b0\u30a4\u30f3\u5f8c\u306bGoogle Calendar\u306e\u30c7\u30fc\u30bf\u3092\u53d6\u5f97\u3057\u305f\u3044\u306e\u3067\u3001scope\u306b\n# https://www.googleapis.com/auth/calendar\u3092\u8a18\u8ff0\u3057\u3066\u3044\u307e\u3059\u3002\n# \u307e\u305f\u3001prompt\u3068access_type\u3092\u4ee5\u4e0b\u306e\u8a2d\u5b9a\u306b\u3059\u308b\u3068refresh_token\u304c\u5f97\u3089\u308c\u308b\n# \uff08\u305d\u306e\u4ed6\u306e\u7d44\u307f\u5408\u308f\u305b\u306f\u8a66\u3057\u3066\u3044\u307e\u305b\u3093\uff09\u3002\n      scope: \"https://www.googleapis.com/auth/userinfo.email,\n              https://www.googleapis.com/auth/userinfo.profile,\n              https://www.googleapis.com/auth/calendar\",\n      prompt: \"select_account\",\n      access_type: \"offline\"\n    }\nend\n\n\nGoogle API Console \u3067\u5272\u308a\u5f53\u3066\u3089\u308c\u305f\u30af\u30e9\u30a4\u30a2\u30f3\u30c8ID\u306a\u3069\u3092config/secret.yml\u306b\u8a18\u8ff0\u3057\u307e\u3059\u30022 \u306a\u304a\u3001\u30af\u30e9\u30a4\u30a2\u30f3\u30c8ID\u306e\u5272\u308a\u5f53\u3066\u7b49\u3092\u542b\u3081\u305fGoogle API\u306e\u8a2d\u5b9a\u306b\u3064\u3044\u3066\u306f\u3001\u4ee5\u4e0b\u306e\u30da\u30fc\u30b8\u304c\u53c2\u8003\u306b\u306a\u308a\u307e\u3059\u3002\ngoogle\u304b\u3089\u306e\u30ed\u30b0\u30a4\u30f3\u5b9f\u88c5 - Qiita\n\nconfig/secret.yml\ngoogle_client_id: #[google api console]\u3067\u5272\u308a\u5f53\u3066\u3089\u308c\u305f\u30af\u30e9\u30a4\u30a2\u30f3\u30c8ID\u3092\u8a18\u5165\ngoogle_client_secret: #[google api console]\u3067\u5272\u308a\u5f53\u3066\u3089\u308c\u305f\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u30b7\u30fc\u30af\u30ec\u30c3\u30c8\u3092\u8a18\u5165\n\n\napp/controllers/users/omniauth_callbacks_controller.rb\u3092\u7de8\u96c6\u3059\u308b\u3002\n\napp/controllers/users/omniauth_callbacks_controller.rb\nclass Users::OmniauthCallbacksController < Devise::OmniauthCallbacksController\n  def google_oauth2\n   @user = User.find_for_google_oauth2(request.env[\"omniauth.auth\"])\n\n    if @user.persisted?\n      flash[:notice] = I18n.t \"devise.omniauth_callbacks.success\",\n                              :kind => \"Google\"\n      sign_in_and_redirect @user, :event => :authentication\n    else\n      session[\"devise.google_data\"] = request.env[\"omniauth.auth\"]\n      redirect_to new_user_registration_url\n    end\n  end\n#\u4ee5\u4e0b\u7701\u7565\nend\n\n\n\n\u30ed\u30b0\u30a4\u30f3\u7528\u306e\u30ea\u30f3\u30af\u3092\u8868\u793a\u3059\u308b\u753b\u9762\u3068\u30ed\u30b0\u30a4\u30f3\u5f8c\u306b\u8868\u793a\u3059\u308b\u753b\u9762\u3092\u4f5c\u6210\u3059\u308b\u305f\u3081\u3001\u4ee5\u4e0b\u306e\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3057\u3001\u4f5c\u6210\u3055\u308c\u305f\u30d5\u30a1\u30a4\u30eb\u3092\u4ee5\u4e0b\u306e\u3068\u304a\u308a\u7de8\u96c6\u3057\u307e\u3059\u3002\n$ rails g controller welcome  #\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u30fc\u540d\u306f\u81ea\u7531\n$ rails g controller user\n\n\napp/controllers/welcome_controller.rb\nclass WelcomeController < ApplicationController\n  def index\n  end\nend\n\n\n\napp/controllers/user_controller.rb\nclass UserController < ApplicationController\n  def user_cal\n  end\nend\n\n\napp/views/welcome/index.html.erb\u3068app/views/user/user_cal.html.erb\u3092\u4f5c\u6210\u3057\u3066\u4ee5\u4e0b\u306e\u3068\u304a\u308a\u7de8\u96c6\u3057\u307e\u3059\u3002\n\napp/views/welcome/index.html.erb\n<h1>Google OAuth2 Test</h1>\n\n<p>app/views/welcome/index.html.erb</p>\n\n<%= link_to \"Sign in with Google\", user_google_oauth2_omniauth_authorize_path %>\n\n\n\napp/views/user/user_cal.html.erb\n<h1><%= current_user.name %>\u306e\u30ab\u30ec\u30f3\u30c0\u30fc</h1>\n<hr>\n# \u5b9f\u969b\u306e\u30ab\u30ec\u30f3\u30c0\u30fc\u8868\u793a\u90e8\u5206\u306f\u5f8c\u307b\u3069\u4f5c\u6210\n\n\nroute.rb\u3092\u4ee5\u4e0b\u306e\u3068\u304a\u308a\u7de8\u96c6\u3057\u3066\u30eb\u30fc\u30c6\u30a3\u30f3\u30b0\u3092\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\nroute.rb\nRails.application.routes.draw do\n  devise_for :users, controllers: {\n    :omniauth_callbacks => \"users/omniauth_callbacks\",\n  }\n  get 'user/cal', as: 'user_root'  #\u30ed\u30b0\u30a4\u30f3\u5f8c\u306b\u8868\u793a\u3059\u308b\u753b\u9762\u306e\u8a2d\u5b9a\n  root to: 'welcome#index'\n#\u4ee5\u4e0b\u7701\u7565\n\n\n\n4.\u5b9f\u969b\u306b\u30ed\u30b0\u30a4\u30f3\u3057\u3066\u307f\u308b\n\u3053\u308c\u3067http://localhost:3000\u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3068\u3001\u4ee5\u4e0b\u306e\u753b\u9762\u304c\u8868\u793a\u3055\u308c\u308b\u306e\u3067\u3001Sign in with Google\u3092\u30af\u30ea\u30c3\u30af\u3057\u307e\u3059\u3002\n\nGoogle\u306e\u8a8d\u8a3c\u753b\u9762\u304c\u8868\u793a\u3055\u308c\u308b\u306e\u3067\u3001\u8a31\u53ef\u3092\u30af\u30ea\u30c3\u30af\u3057\u307e\u3059\u3002\n\n\u3053\u306e\u753b\u9762\u304c\u8868\u793a\u3055\u308c\u308b\u306f\u305a\u3002\n\n\u307e\u305f\u3001\u4f5c\u6210\u3057\u3066\u304a\u3044\u305fusers\u30c6\u30fc\u30d6\u30eb\u306b\u3001refresh_token\u3068access_token\u304c\u4fdd\u5b58\u3055\u308c\u3066\u3044\u308b\u306f\u305a\u3002\n\n\n\u53c2\u8003\u306b\u3057\u305f\u30a6\u30a7\u30d6\u30b5\u30a4\u30c8\nGitHub - plataformatec/devise: Flexible authentication solution for Rails with Warden.\nGitHub - zquestz/omniauth-google-oauth2: Oauth2 strategy for Google\ngoogle\u304b\u3089\u306e\u30ed\u30b0\u30a4\u30f3\u5b9f\u88c5 - Qiita\ndevise \u306b\u95a2\u3059\u308b routes \u307e\u3068\u3081 - Qiita\nRails 4.1 + devise + omniauth-google-oauth2 \u3067\u8a8d\u8a3c\u6a5f\u80fd\u3092\u5b9f\u88c5\u3059\u308b \u2013 Oh My Enter!\nomniauth-google-oauth2\u3067\u30cf\u30de\u3063\u305f\u30e1\u30e2 - blog.takuyan.com 3\n\n\n\n\n\n\u306a\u304a\u3001config/initializers/devise.rb\u3092\u7de8\u96c6\u3059\u308b\u3068\u7d39\u4ecb\u3059\u308b\u30da\u30fc\u30b8\u3082\u3042\u308b\u304c\u3001\u81ea\u5206\u306e\u74b0\u5883\u3067\u306f\u3001\u305d\u3061\u3089\u306b\u8a18\u8ff0\u3059\u308b\u3068\u30ed\u30b0\u30a4\u30f3\u306f\u3067\u304d\u308b\u304c\u3001\u30ed\u30b0\u30a4\u30f3\u5f8c\u306bGoogle\u304b\u3089\u8fd4\u3063\u3066\u304f\u308bjson\u30c7\u30fc\u30bf\u306brefresh_token\u304c\u542b\u307e\u308c\u306a\u304b\u3063\u305f\u3002\u00a0\u21a9\n\n\nGoogle\u304b\u3089\u5272\u308a\u5f53\u3066\u3089\u308c\u305f\u30af\u30e9\u30a4\u30a2\u30f3\u30c8ID\u306a\u3069\u3092\u76f4\u63a5config/initializers/omniauth.rb\u306b\u66f8\u304d\u8fbc\u3080\u3068\u3001RAILS_ENV\u74b0\u5883\u6bce\u306b\u5207\u308a\u66ff\u3048\u3089\u308c\u306a\u3044\u3002\u00a0\u21a9\n\n\n\u4e8c\u6bb5\u968e\u8a8d\u8a3c\u3057\u3066\u3044\u308b\u30e6\u30fc\u30b6\u30fc\u306frefresh_token\u304c\u3082\u3089\u3048\u306a\u3044\u304b\u3082\u3057\u308c\u306a\u3044\u3068\u3042\u308b\u304c\u3001\u81ea\u5206\u306e\u74b0\u5883\u3067\u306frefresh_token\u304c\u767a\u884c\u3055\u308c\u305f\u3002\u00a0\u21a9\n\n\n\ndevise\u3068OmniAuth\u3092\u4f7f\u3063\u305f\u30ed\u30b0\u30a4\u30f3\u3092\u5b9f\u73fe\u3059\u308b\u624b\u7d9a\u304d\u3092\u7d39\u4ecb\u3057\u305f\u8a18\u4e8b\u306f\u591a\u3044\u3082\u306e\u306e\u3001\u30ed\u30b0\u30a4\u30f3\u5f8c\u3001Google API\u3092\u4f7f\u3063\u3066\u30c7\u30fc\u30bf\u3092\u53d6\u5f97\u3059\u308b\u969b\u306b\u5fc5\u8981\u3068\u306a\u308brefresh_token\u306b\u3064\u3044\u3066\u66f8\u304b\u308c\u305f\u30da\u30fc\u30b8\u304c\u3042\u307e\u308a\u898b\u3064\u304b\u3089\u305a\u3001\u8907\u6570\u306e\u8a18\u4e8b\u306e\u5185\u5bb9\u3092\u30d4\u30c3\u30af\u30a2\u30c3\u30d7\u3057\u306a\u304c\u3089\u5b9f\u88c5\u3059\u308b\u5fc5\u8981\u306b\u8feb\u3089\u308c\u305f\u306e\u3067\u3001\u305d\u306e\u6642\u306b\u53c2\u7167\u3057\u305f\u5185\u5bb9\u3092\u307e\u3068\u3081\u307e\u3057\u305f\u3002\n\n***\n* \u74b0\u5883\n - ruby 2.3.1p112\n - Rails 4.2.6\n\n***\n\n#1.\u4e0b\u6e96\u5099\n\n\u5fc5\u8981\u306agem\u3092`Gemfile`\u306b\u8ffd\u8a18\u3057\u3066\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u307e\u3059\u3002\n\n``` ruby:Gemfile\ngem 'devise'\ngem 'omniauth'\ngem 'omniauth-google-oauth2'\n```\n\n```\n$ bundle install\n```\n\n`devise`\u306e\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u3068\u3001`devise`\u3067`User`\u30e2\u30c7\u30eb\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n```\n$ rails g devise:install\n$ rails g devise user\n$ rails g migration add_omniauth_to_users\n```\n\n#2.\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306e\u7528\u610f\n\n`devise`\u304c\u4f5c\u6210\u3057\u305f`User`\u30e2\u30c7\u30eb\u306b`OmniAuth`\u3067\u5fc5\u8981\u3068\u306a\u308b\u30ab\u30e9\u30e0\u3092\u8ffd\u52a0\u3057\u307e\u3059\u3002\n\n```ruby:db/migrate/add_omniauth_to_users.rb\nclass AddOmniauthToUsers < ActiveRecord::Migration\n  def change\n    add_column :users, :provider, :string\n    add_column :users, :uid, :string\n    add_column :users, :name, :string\n    add_column :users, :refresh_token, :string\n    add_column :users, :access_token, :string\n  end\nend\n```\n\n\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n```\n$ rake db:create\n$ rake db:migrate\n```\n\n#3.OmniAuth\u306e\u8a2d\u5b9a\u306a\u3069\n\n`devise`\u3067\u306f\u3001\u30c7\u30d5\u30a9\u30eb\u30c8\u3067`OmniAuth`\u304c\u6709\u52b9\u306b\u306a\u3063\u3066\u3044\u306a\u3044\u3053\u3068\u304b\u3089\u3001`app/models/user.rb`\u3092\u7de8\u96c6\u3057\u3066\u6709\u52b9\u306b\u3057\u307e\u3059\u3002\n\n```app/models/user.rb\nclass User < ActiveRecord::Base\n  # Include default devise modules. Others available are:\n  # :confirmable, :lockable, :timeoutable and :omniauthable\n  devise :database_authenticatable, :registerable, :recoverable,\n         :rememberable, :trackable, :validatable,:omniauthable,\n         :omniauthable, :omniauth_providers => [:google_oauth2]\n\n  def self.find_for_google_oauth2(auth)\n    user = User.where(email: auth.info.email).first\n    unless user\n      user = User.create(name:     auth.info.name,\n                         provider: auth.provider,\n                         uid:      auth.uid,\n                         email:    auth.info.email,\n                         token:    auth.credentials.token,\n                         password: Devise.friendly_token[0, 20])\n    end\n    user\n  end\nend\n```\n\n`devise`\u306e\u8d77\u52d5\u6642\u306e\u8a2d\u5b9a\u3092\u884c\u3046\u305f\u3081\u3001`config/initializers/omniauth.rb`\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3057\u3066\u6b21\u306e\u3068\u304a\u308a\u7de8\u96c6\u3057\u307e\u3059\u3002[^1]\n\n```ruby:config/initializers/omniauth.rb\nRails.application.config.middleware.use OmniAuth::Builder do\n  provider :google_oauth2,\n    Rails.application.secrets.google_client_id,\n    Rails.application.secrets.google_client_secret,\n    {\n# \u30ed\u30b0\u30a4\u30f3\u5f8c\u306bGoogle Calendar\u306e\u30c7\u30fc\u30bf\u3092\u53d6\u5f97\u3057\u305f\u3044\u306e\u3067\u3001scope\u306b\n# https://www.googleapis.com/auth/calendar\u3092\u8a18\u8ff0\u3057\u3066\u3044\u307e\u3059\u3002\n# \u307e\u305f\u3001prompt\u3068access_type\u3092\u4ee5\u4e0b\u306e\u8a2d\u5b9a\u306b\u3059\u308b\u3068refresh_token\u304c\u5f97\u3089\u308c\u308b\n# \uff08\u305d\u306e\u4ed6\u306e\u7d44\u307f\u5408\u308f\u305b\u306f\u8a66\u3057\u3066\u3044\u307e\u305b\u3093\uff09\u3002\n      scope: \"https://www.googleapis.com/auth/userinfo.email,\n              https://www.googleapis.com/auth/userinfo.profile,\n              https://www.googleapis.com/auth/calendar\",\n      prompt: \"select_account\",\n      access_type: \"offline\"\n    }\nend\n```\n\nGoogle API Console \u3067\u5272\u308a\u5f53\u3066\u3089\u308c\u305f\u30af\u30e9\u30a4\u30a2\u30f3\u30c8ID\u306a\u3069\u3092`config/secret.yml`\u306b\u8a18\u8ff0\u3057\u307e\u3059\u3002[^2] \u306a\u304a\u3001\u30af\u30e9\u30a4\u30a2\u30f3\u30c8ID\u306e\u5272\u308a\u5f53\u3066\u7b49\u3092\u542b\u3081\u305fGoogle API\u306e\u8a2d\u5b9a\u306b\u3064\u3044\u3066\u306f\u3001\u4ee5\u4e0b\u306e\u30da\u30fc\u30b8\u304c\u53c2\u8003\u306b\u306a\u308a\u307e\u3059\u3002\n[google\u304b\u3089\u306e\u30ed\u30b0\u30a4\u30f3\u5b9f\u88c5 - Qiita](http://qiita.com/ttaka66/items/9ea3052a6f17a0b8f5fc)\n\n```ruby:config/secret.yml\ngoogle_client_id: #[google api console]\u3067\u5272\u308a\u5f53\u3066\u3089\u308c\u305f\u30af\u30e9\u30a4\u30a2\u30f3\u30c8ID\u3092\u8a18\u5165\ngoogle_client_secret: #[google api console]\u3067\u5272\u308a\u5f53\u3066\u3089\u308c\u305f\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u30b7\u30fc\u30af\u30ec\u30c3\u30c8\u3092\u8a18\u5165\n```\n\n`app/controllers/users/omniauth_callbacks_controller.rb`\u3092\u7de8\u96c6\u3059\u308b\u3002\n\n```ruby:app/controllers/users/omniauth_callbacks_controller.rb\nclass Users::OmniauthCallbacksController < Devise::OmniauthCallbacksController\n  def google_oauth2\n   @user = User.find_for_google_oauth2(request.env[\"omniauth.auth\"])\n \n    if @user.persisted?\n      flash[:notice] = I18n.t \"devise.omniauth_callbacks.success\",\n                              :kind => \"Google\"\n      sign_in_and_redirect @user, :event => :authentication\n    else\n      session[\"devise.google_data\"] = request.env[\"omniauth.auth\"]\n      redirect_to new_user_registration_url\n    end\n  end\n#\u4ee5\u4e0b\u7701\u7565\nend\n\n```\n\n\u30ed\u30b0\u30a4\u30f3\u7528\u306e\u30ea\u30f3\u30af\u3092\u8868\u793a\u3059\u308b\u753b\u9762\u3068\u30ed\u30b0\u30a4\u30f3\u5f8c\u306b\u8868\u793a\u3059\u308b\u753b\u9762\u3092\u4f5c\u6210\u3059\u308b\u305f\u3081\u3001\u4ee5\u4e0b\u306e\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3057\u3001\u4f5c\u6210\u3055\u308c\u305f\u30d5\u30a1\u30a4\u30eb\u3092\u4ee5\u4e0b\u306e\u3068\u304a\u308a\u7de8\u96c6\u3057\u307e\u3059\u3002\n\n```\n$ rails g controller welcome  #\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u30fc\u540d\u306f\u81ea\u7531\n$ rails g controller user\n```\n\n```ruby:app/controllers/welcome_controller.rb\nclass WelcomeController < ApplicationController\n  def index\n  end\nend\n```\n\n```ruby:app/controllers/user_controller.rb\nclass UserController < ApplicationController\n  def user_cal\n  end\nend\n```\n\n\n`app/views/welcome/index.html.erb`\u3068`app/views/user/user_cal.html.erb`\u3092\u4f5c\u6210\u3057\u3066\u4ee5\u4e0b\u306e\u3068\u304a\u308a\u7de8\u96c6\u3057\u307e\u3059\u3002\n\n```html+erb:app/views/welcome/index.html.erb\n<h1>Google OAuth2 Test</h1>\n\n<p>app/views/welcome/index.html.erb</p>\n\n<%= link_to \"Sign in with Google\", user_google_oauth2_omniauth_authorize_path %>\n```\n\n```html+erb:app/views/user/user_cal.html.erb\n<h1><%= current_user.name %>\u306e\u30ab\u30ec\u30f3\u30c0\u30fc</h1>\n<hr>\n# \u5b9f\u969b\u306e\u30ab\u30ec\u30f3\u30c0\u30fc\u8868\u793a\u90e8\u5206\u306f\u5f8c\u307b\u3069\u4f5c\u6210\n```\n\n`route.rb`\u3092\u4ee5\u4e0b\u306e\u3068\u304a\u308a\u7de8\u96c6\u3057\u3066\u30eb\u30fc\u30c6\u30a3\u30f3\u30b0\u3092\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\n```ruby:route.rb\nRails.application.routes.draw do\n  devise_for :users, controllers: {\n    :omniauth_callbacks => \"users/omniauth_callbacks\",\n  }\n  get 'user/cal', as: 'user_root'  #\u30ed\u30b0\u30a4\u30f3\u5f8c\u306b\u8868\u793a\u3059\u308b\u753b\u9762\u306e\u8a2d\u5b9a\n  root to: 'welcome#index'\n#\u4ee5\u4e0b\u7701\u7565\n```\n\n#4.\u5b9f\u969b\u306b\u30ed\u30b0\u30a4\u30f3\u3057\u3066\u307f\u308b\n\u3053\u308c\u3067`http://localhost:3000`\u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3068\u3001\u4ee5\u4e0b\u306e\u753b\u9762\u304c\u8868\u793a\u3055\u308c\u308b\u306e\u3067\u3001*Sign in with Google*\u3092\u30af\u30ea\u30c3\u30af\u3057\u307e\u3059\u3002\n![Gcaltest_-_top.png](https://qiita-image-store.s3.amazonaws.com/0/136890/44b488e1-9653-d203-f012-5f0dd6e09068.png)\n\nGoogle\u306e\u8a8d\u8a3c\u753b\u9762\u304c\u8868\u793a\u3055\u308c\u308b\u306e\u3067\u3001\u8a31\u53ef\u3092\u30af\u30ea\u30c3\u30af\u3057\u307e\u3059\u3002\n![Gcaltest_-_authorization.png](https://qiita-image-store.s3.amazonaws.com/0/136890/8f9a550f-3478-cec1-d95b-09e13613d5be.png)\n\n\u3053\u306e\u753b\u9762\u304c\u8868\u793a\u3055\u308c\u308b\u306f\u305a\u3002\n![Gcaltest_-_cal.png](https://qiita-image-store.s3.amazonaws.com/0/136890/ddcdaf9a-98f5-0773-bb8c-42955a5fda47.png)\n\n\u307e\u305f\u3001\u4f5c\u6210\u3057\u3066\u304a\u3044\u305f`users`\u30c6\u30fc\u30d6\u30eb\u306b\u3001`refresh_token`\u3068`access_token`\u304c\u4fdd\u5b58\u3055\u308c\u3066\u3044\u308b\u306f\u305a\u3002\n![sequelpro-screenshot_Fotor.jpg](https://qiita-image-store.s3.amazonaws.com/0/136890/ca7531e0-88d3-83fc-d7ab-209d79a8d92c.jpeg)\n\n***\n\u53c2\u8003\u306b\u3057\u305f\u30a6\u30a7\u30d6\u30b5\u30a4\u30c8\n[GitHub - plataformatec/devise: Flexible authentication solution for Rails with Warden.](https://github.com/plataformatec/devise#configuring-views)\n[GitHub - zquestz/omniauth-google-oauth2: Oauth2 strategy for Google](\nhttps://github.com/zquestz/omniauth-google-oauth2)\n[google\u304b\u3089\u306e\u30ed\u30b0\u30a4\u30f3\u5b9f\u88c5 - Qiita](\nhttp://qiita.com/ttaka66/items/9ea3052a6f17a0b8f5fc)\n[devise \u306b\u95a2\u3059\u308b routes \u307e\u3068\u3081 - Qiita](\nhttp://qiita.com/masarakki/items/52751a49f9ec487169e4)\n[Rails 4.1 + devise + omniauth-google-oauth2 \u3067\u8a8d\u8a3c\u6a5f\u80fd\u3092\u5b9f\u88c5\u3059\u308b \u2013 Oh My Enter!](http://www.ohmyenter.com/rails-4-1-devise-omniauth-google-oauth2-%e3%81%a7%e8%aa%8d%e8%a8%bc%e6%a9%9f%e8%83%bd%e3%82%92%e5%ae%9f%e8%a3%85%e3%81%99%e3%82%8b/)\n[omniauth-google-oauth2\u3067\u30cf\u30de\u3063\u305f\u30e1\u30e2 - blog.takuyan.com](\nhttp://blog.takuyan.com/posts/2013/06/14/insufficientpermissions-error-in-omniauth-google-oauth2/) [^3]\n\n***\n[^1]: \u306a\u304a\u3001`config/initializers/devise.rb`\u3092\u7de8\u96c6\u3059\u308b\u3068\u7d39\u4ecb\u3059\u308b\u30da\u30fc\u30b8\u3082\u3042\u308b\u304c\u3001\u81ea\u5206\u306e\u74b0\u5883\u3067\u306f\u3001\u305d\u3061\u3089\u306b\u8a18\u8ff0\u3059\u308b\u3068\u30ed\u30b0\u30a4\u30f3\u306f\u3067\u304d\u308b\u304c\u3001\u30ed\u30b0\u30a4\u30f3\u5f8c\u306bGoogle\u304b\u3089\u8fd4\u3063\u3066\u304f\u308bjson\u30c7\u30fc\u30bf\u306b`refresh_token`\u304c\u542b\u307e\u308c\u306a\u304b\u3063\u305f\u3002\n[^2]: Google\u304b\u3089\u5272\u308a\u5f53\u3066\u3089\u308c\u305f\u30af\u30e9\u30a4\u30a2\u30f3\u30c8ID\u306a\u3069\u3092\u76f4\u63a5`config/initializers/omniauth.rb`\u306b\u66f8\u304d\u8fbc\u3080\u3068\u3001RAILS_ENV\u74b0\u5883\u6bce\u306b\u5207\u308a\u66ff\u3048\u3089\u308c\u306a\u3044\u3002\n[^3]: \u4e8c\u6bb5\u968e\u8a8d\u8a3c\u3057\u3066\u3044\u308b\u30e6\u30fc\u30b6\u30fc\u306f`refresh_token`\u304c\u3082\u3089\u3048\u306a\u3044\u304b\u3082\u3057\u308c\u306a\u3044\u3068\u3042\u308b\u304c\u3001\u81ea\u5206\u306e\u74b0\u5883\u3067\u306f`refresh_token`\u304c\u767a\u884c\u3055\u308c\u305f\u3002\n", "tags": ["devise", "OmniAuth", "RubyOnRails"]}