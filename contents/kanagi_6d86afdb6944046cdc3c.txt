{"context": "\n\nAPI Gateway + Lambda \u3067 slack\n\u524d\u56deslack app\u3092\u767b\u9332\u3057\u305f\u7d9a\u304d\u304b\u3089\u3067\u3059\u3002\nhttp://qiita.com/kanagi/items/843f898458df34f6ae90\nslash command\u3068interactive message\u3092\u5229\u7528\u3057\u3066\u5bfe\u8a71\u7684\u306bslack\u3067\u51e6\u7406\u3092\u9032\u3081\u3066\u307f\u307e\u3059\u3002\n\nlambda\u306e\u767b\u9332\n\u307e\u305a\u306f\u52d5\u4f5c\u30c6\u30b9\u30c8\u306e\u305f\u3081\u306bapex\u306ehello\u3092\u7f6e\u3044\u3066\u3057\u307e\u3044\u307e\u3059\u3002\n\napex deploy hello\n\n\u3067\u5b9f\u884c\u3055\u308c\u308b\u3068\u30c6\u30ad\u30b9\u30c8\u3060\u3051\u51fa\u529b\u3059\u308b\u30b5\u30f3\u30d7\u30eb\u304c\u914d\u7f6e\u3055\u308c\u307e\u3059\u3002\n\nAPI Gateway\u306e\u767b\u9332\n/ \u306b\u914d\u7f6e\u3057\u3066\u3057\u307e\u3044\u307e\u3059\u3002\n\n[\u30a2\u30af\u30b7\u30e7\u30f3] -> [\u30e1\u30bd\u30c3\u30c9\u306e\u4f5c\u6210] -> POST\u3092\u9078\u3093\u3067\u30c1\u30a7\u30c3\u30af\u3092\u30af\u30ea\u30c3\u30af\n\n\n\n\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u753b\u9762\u306b\u306a\u308b\u306e\u3067\u3001\u5148\u307b\u3069\u4f5c\u6210\u3057\u305flambda\u3092\u9078\u3093\u3067[\u4fdd\u5b58]\n\n\n\n\u6a29\u9650\u8a31\u53ef\u78ba\u8a8d\u753b\u9762\u304c\u3067\u308b\u306e\u3067[OK]\n\n\n\n\u30e1\u30bd\u30c3\u30c9\u306e\u5b9f\u884c\u753b\u9762\u3067[\u7d71\u5408\u30ea\u30af\u30a8\u30b9\u30c8]\u3092\u9078\u629e\n\n\n\n[\u672c\u6587\u30de\u30c3\u30d4\u30f3\u30b0\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8]\u3092\u30af\u30ea\u30c3\u30af\u3057\u3066\u8a73\u7d30\u3092\u51fa\u3057\u3066\u304b\u3089\u3001[\u30de\u30c3\u30d4\u30f3\u30b0\u30c6\u30f3\u30d7\u30ec\u30fc\u3068\u306e\u8ffd\u52a0] -> application/x-www-form-urlencoded \u3092\u5165\u529b\u3057\u3066\u30c1\u30a7\u30c3\u30af\u3092\u30af\u30ea\u30c3\u30af\n\n\n\n\u30d1\u30b9\u30b9\u30eb\u30fc\u52d5\u4f5c\u306e\u5909\u66f4\u753b\u9762\u304c\u3067\u308b\u306e\u3067 [\u306f\u3044\u3001\u3053\u306e\u7d71\u5408\u3092\u4fdd\u8b77\u3057\u307e\u3059]\n\n\n\nPOST\u306e\u4e2d\u8eab\u3092querystring\u306b\u62bc\u3057\u8fbc\u3080\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u3092\u8a18\u8ff0\u3057\u3066[\u4fdd\u5b58]\n\n\u524d\u56de\u306f\u8a73\u7d30\u3092\u66f8\u304d\u307e\u305b\u3093\u3067\u3057\u305f\u304c\u3001\u3053\u308c\u306fvelocity\u306e\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u3067\u3059\u3002aws\u3067\u898f\u5b9a\u3055\u308c\u3066\u3044\u308b\u5909\u6570\u3092velocity\u306e\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u3092\u4f7f\u3063\u3066lambda\u306b\u6e21\u3059\u3053\u3068\u304c\u3067\u304d\u308b\u3068\u3044\u3046\u4ed5\u7d44\u307f\u3067\u3059\u3002\nPOST\u306e\u30c7\u30fc\u30bf\u3092\u5c55\u958b\u3057\u3066\u6e21\u3059\u3053\u3068\u304c\u3067\u304d\u308b\u306e\u3067\u4e0b\u8a18\u3092\u53c2\u8003\u306b\u3057\u305f\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u3092\u914d\u7f6e\u3057\u3066\u3044\u307e\u3059\u3002\u57fa\u672c\u7684\u306b\u4f7f\u3046\u306e\u306f\u3001querystring\u5185\u306b\u5c55\u958b\u3055\u308c\u308bPOST\u3067\u6e21\u3055\u308c\u305f\u30d1\u30e9\u30e1\u30fc\u30bf\u3067\u3059\u3002\nhttp://qiita.com/durosasaki/items/83af014aa85a0448770e\nhttp://dev.classmethod.jp/cloud/aws/sugano-013-api-gateway/\n\n#set($rawAPIData = $input.path('$'))\n## escape any quotes\n#set($rawAPIData = $rawAPIData.replace('\"', '\\\"'))\n\n## first we get the number of \"&\" in the string, this tells us if there is more than one key value pair\n#set($countAmpersands = $rawAPIData.length() - $rawAPIData.replace(\"&\", \"\").length())\n\n## if there are no \"&\" at all then we have only one key value pair.\n## we append an ampersand to the string so that we can tokenise it the same way as multiple kv pairs.\n## the \"empty\" kv pair to the right of the ampersand will be ignored anyway.\n#if ($countAmpersands == 0)\n #set($rawPostData = $rawAPIData + \"&\")\n#end\n\n## now we tokenise using the ampersand(s)\n#set($tokenisedAmpersand = $rawAPIData.split(\"&\"))\n\n## we set up a variable to hold the valid key value pairs\n#set($tokenisedEquals = [])\n\n## now we set up a loop to find the valid key value pairs, which must contain only one \"=\"\n#foreach( $kvPair in $tokenisedAmpersand )\n #set($countEquals = $kvPair.length() - $kvPair.replace(\"=\", \"\").length())\n #if ($countEquals == 1)\n  #set($kvTokenised = $kvPair.split(\"=\"))\n  #if ($kvTokenised[0].length() > 0)\n   ## we found a valid key value pair. add it to the list.\n   #set($devNull = $tokenisedEquals.add($kvPair))\n  #end\n #end\n#end\n\n{\n    \"headers\" : {\n#foreach( $key in $input.params().header.keySet() )\n       \"$key\" : \"$input.params().header.get($key)\"#if( $foreach.hasNext ),#end\n#end\n    },\n    \"querystring\" : {\n#foreach( $kvPair in $tokenisedEquals )\n  ## finally we output the JSON for this pair and append a comma if this isn't the last pair\n  #set($kvTokenised = $kvPair.split(\"=\"))\n  #if($kvTokenised.size() == 2 && $kvTokenised[1].length() > 0)\n    #set($kvValue = $kvTokenised[1])\n  #else\n    #set($kvValue = \"\")\n  #end\n  #if( $foreach.hasNext )\n    #set($itemDelimiter = \",\")\n  #else\n    #set($itemDelimiter = \"\")\n  #end\n \"$kvTokenised[0]\" : \"$kvValue\"$itemDelimiter\n#end\n    },\n    \"stage\" : \"$context.stage\",\n    \"sourceIp\" : \"$context.identity.sourceIp\",\n    \"userAgent\" : \"$context.identity.userAgent\"\n}\n\n\n\u30c7\u30d7\u30ed\u30a4\u3057\u306a\u3044\u3068\u53cd\u6620\u3055\u308c\u306a\u3044\u306e\u3067[\u30a2\u30af\u30b7\u30e7\u30f3] -> [API\u306e\u30c7\u30d7\u30ed\u30a4] -> API\u306e\u30c7\u30d7\u30ed\u30a4\u30a6\u30a3\u30f3\u30c9\u30a6\u304c\u3067\u308b\u306e\u3067\u3001\u30b9\u30c6\u30fc\u30b8\u540d\u3092\u524d\u56de\u4f5c\u3063\u305f\u3082\u306e\u3092\u9078\u629e\u3057\u3066[\u30c7\u30d7\u30ed\u30a4]\n\n\n\nURL\u306e\u547c\u3073\u51fa\u3057:\u3067\u793a\u3055\u308c\u308bURL\u3092\u53d6\u3063\u3066\u304a\u304d\u307e\u3059\n\n\n\nslash command\u3092\u767b\u9332\nslack app\u306e\u753b\u9762\u304b\u3089[slash commands]\u3092\u9078\u629e\u3057\u3066\u3001[Create New Command]\u3092\u9078\u3073\u307e\u3059\u3002\n\n\u3053\u306e\u6642\u70b9\u3067\u3001API gateway\u306bapplication/x-www-form-urlencoded\u3067POST\u3059\u308b\u3068\u3001helloworld\u304c\u5e30\u3063\u3066\u304f\u308b\u306f\u305a\u3067\u3059\u3002\n$ curl -XPOST -d \"test\" [API gateway\u306eURL]\n{\"hello\":\"world\"}\n\n\nslack app\u306e\u8a2d\u5b9a\n\n\u4f5c\u6210\u3057\u305fslack app\u306e[Slash Commands]\u304b\u3089[Create New Command]\n\n\n\n\u30b3\u30de\u30f3\u30c9\u3092\u767b\u9332\u3059\u308b\n\n\u767b\u9332\u3059\u308b\u30b3\u30de\u30f3\u30c9\u540d\u3092Command\u3001Request URL\u306bAPI Gateway\u3067\u63a7\u3048\u305fURL\u3001Short Description\u306b\u9069\u5f53\u306a\u8aac\u660e\u3092\u5165\u308c\u3066[Save]\n\nslack\u3067/hello\u3057\u305f\u3089\u8fd4\u4e8b\u304c\u8fd4\u3063\u3066\u6765\u308c\u3070\u6210\u529f\u3067\u3059\u3002\n\ntoken\u30c1\u30a7\u30c3\u30af\u306e\u8ffd\u52a0\n\u3053\u306e\u307e\u307e\u3067\u306fcurl\u3067\u30c6\u30b9\u30c8\u3057\u305f\u901a\u308a\u3001\u3069\u3053\u304b\u3089\u3067\u3082URL\u3092\u53e9\u3051\u3070\u7d50\u679c\u3092\u51fa\u3057\u3066\u3057\u307e\u3044\u307e\u3059\u3002\nhello\u306e\u3088\u3046\u306b\u7279\u306b\u610f\u5473\u306e\u306a\u3044\u7d50\u679c\u3092\u8fd4\u3059\u3060\u3051\u306a\u3089\u554f\u984c\u306a\u3044\u3067\u3059\u304c\u3001\u4f5c\u3063\u305fslack app\u306e\u901a\u77e5\u3060\u3068\u3044\u3046\u3053\u3068\u3092\u78ba\u8a8d\u3059\u308b\u305f\u3081\u306btoken\u3092\u30c1\u30a7\u30c3\u30af\u3059\u308b\u3088\u3046\u306b\u3057\u307e\u3059\u3002\ntoken\u306f\u4f5c\u6210\u3057\u305fslack app\u306eclient id\u3084client secret\u304c\u8a18\u8f09\u3055\u308c\u3066\u3044\u305f\u3001[Basic Infomation]\u306eVerification Token\u306b\u8a18\u8f09\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n\u3053\u308c\u304c\u3001slack\u304b\u3089POST\u3055\u308c\u305f\u6642\u306e\u30d1\u30e9\u30e1\u30fc\u30bf\nhttps://api.slack.com/slash-commands#triggering_a_command\n\u306etoken\u3068\u3057\u3066\u9001\u3089\u308c\u3066\u304f\u308b\u306e\u3067\u3001\u6587\u5b57\u5217\u304c\u4e00\u81f4\u3059\u308b\u304b\u30c1\u30a7\u30c3\u30af\u3059\u308b\u3060\u3051\u3067\u3059\u3002\n\u4ed6\u3001\u4f7f\u7528\u3059\u308b\u30e6\u30fc\u30b6\u3084\u30c1\u30e3\u30f3\u30cd\u30eb\u3092\u5236\u9650\u3057\u305f\u3044\u306a\u3089\u3001user_id\u3084channel_id\u3092\u30c1\u30a7\u30c3\u30af\u3057\u305f\u308a\u3059\u308c\u3070\u3044\u3044\u3053\u3068\u306b\u306a\u308a\u307e\u3059\u3002\n\ninteractive message\ninteractive message\u3068\u306f\u3001slack\u306e\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u306b\u4e57\u3063\u3066\u3044\u308b\u3082\u306e\u3092\u898b\u3066\u3082\u3089\u3046\u306e\u304c\u4e00\u756a\u65e9\u3044\u304b\u3068\u601d\u3044\u307e\u3059\u3002\nhttps://api.slack.com/docs/message-buttons\n\u30dc\u30bf\u30f3\u3092\u8868\u793a\u3057\u3066\u3001\u62bc\u3057\u305f\u30dc\u30bf\u30f3\u306b\u5bfe\u3057\u3066\u3055\u3089\u306b\u53cd\u5fdc\u3055\u305b\u308b\u3053\u3068\u304c\u3067\u304d\u308b\u3082\u306e\u3067\u3059\u3002\n\u3053\u308c\u3092\u5229\u7528\u3059\u308b\u3068\u3001jenkins\u3067\u3084\u3063\u3066\u3044\u305f\u3088\u3046\u306a\u30c7\u30d7\u30ed\u30a4\u306e\u5b9f\u884c\u306a\u3069\u3092slack\u3067\u5b8c\u7d50\u3055\u305b\u308b\u3053\u3068\u304c\u53ef\u80fd\u306b\u306a\u308a\u307e\u3059\u3002\n\nslack app\u306e\u8a2d\u5b9a\ninteractive message\u7528\u306b\u5225\u306elambda\u3092\u4f5c\u3063\u3066\u3082\u3044\u3044\u3067\u3059\u304c\u3001\u3053\u3053\u3067\u306f\u540c\u3058\u3082\u306e\u3092\u4f7f\u3044\u307e\u308f\u3057\u307e\u3059\u3002\n\n\u767b\u9332\u3057\u305fslack app\u306e[Interactive Messages]\u304b\u3089[Enable Interactive Messages]\n\n\n\n[Request URL]\u306bAPI Gateway\u3067\u63a7\u3048\u305fURL\u3092\u5165\u308c\u3066[Enable Interative Messages]\n\n\n\nlambda function\u306e\u5909\u66f4\nslack\u306e\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u901a\u308a\u3001\u8fd4\u5374\u3059\u308b\u30e1\u30c3\u30bb\u30fc\u30b8\u306baction\u3092\u4ed8\u3051\u52a0\u3048\u307e\u3059\u3002\nconsole.log('starting function')\nexports.handle = function(e, ctx, cb) {\n  console.log('processing event: %j', e)\n  cb(null, { text: \"button\", attachments: [{ \"callback_id\": \"test\", actions: [{name: \"test\", text: \"Test\", type: \"button\", value: \"test\"}] }] } )\n}\n\napex deploy hello\n\n\u3067\u30c7\u30d7\u30ed\u30a4\u3057\u3066\u6e96\u5099\u5b8c\u4e86\u3067\u3059\u3002\n\n\u5b9f\u884c\u3057\u3066\u307f\u308b\nslack\u3067 /hello \u3092\u5b9f\u884c\u3059\u308b\u3068\u4e0b\u8a18\u306e\u3088\u3046\u306b\u306a\u308b\u306f\u305a\u3067\u3059\u3002\n\n\u3053\u306e[Test]\u30dc\u30bf\u30f3\u304c\u62bc\u305b\u308b\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002\u62bc\u3059\u3068\u3001\u30dc\u30bf\u30f3\u306f\u6d88\u3048\u3066\u3057\u307e\u3046\u306f\u305a\u3067\u3059\u3002\n\u30dc\u30bf\u30f3\u3092\u62bc\u3057\u305f\u969b\u306b\u3001interactive messages\u3067\u767b\u9332\u3057\u305fURL\u306b\u30ea\u30af\u30a8\u30b9\u30c8\u304c\u98db\u3093\u3067\u304a\u308a\u3001\u305d\u306e\u8fd4\u7b54\u304c\u8868\u793a\u3055\u308c\u3066\u3044\u308b\u306e\u3067\u3059\u304c\u3001\u4eca\u56de\u306f\u30dc\u30bf\u30f3\u3092\u62bc\u3057\u305f\u969b\u306b\u3082\u540c\u3058callback_id\u306e\u30dc\u30bf\u30f3\u3092\u51fa\u3057\u3066\u3044\u308b\u306e\u3067\u3001\u30dc\u30bf\u30f3\u304c\u8868\u793a\u3055\u308c\u306a\u3044\u7d50\u679c\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002\n\u3042\u3068\u306f\u3001\u30dc\u30bf\u30f3\u3092\u62bc\u3057\u305f\u6642\u306b\u6e21\u3055\u308c\u308b\u30d1\u30e9\u30e1\u30fc\u30bf\nhttps://api.slack.com/docs/message-buttons#responding_to_message_actions\n\u306b\u5f93\u3063\u3066\u51e6\u7406\u3092\u9032\u3081\u3066\u3044\u3051\u3070\u5bfe\u8a71\u7684\u306bslack\u4e0a\u3067\u51e6\u7406\u3092\u7d44\u307f\u7acb\u3066\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\u6ce8\u610f\u70b9\u3068\u3057\u3066\u3001slash command\u306e\u5834\u5408\u3068\u7570\u306a\u308a\u3001payload\u30d1\u30e9\u30e1\u30fc\u30bf\u306bURL\u30a8\u30f3\u30b3\u30fc\u30c9\u3055\u308c\u305fjson\u3067\u30c7\u30fc\u30bf\u304c\u6e21\u3055\u308c\u308b\u306e\u3067\u3001slash command\u3068\u540c\u3058lambda\u3092\u4f7f\u3046\u5834\u5408\u306f\u3001payload\u30d1\u30e9\u30e1\u30fc\u30bf\u306e\u6709\u7121\u3067\u51e6\u7406\u3092\u5206\u3051\u308b\u3068\u3044\u3044\u3067\u3057\u3087\u3046\u3002\n\nTIPS\n\n3\u79d2\u4ee5\u4e0a\u304b\u304b\u308b\u51e6\u7406\nslash commands\u306e\u6700\u521d\u306e\u5fdc\u7b54\u306f3\u79d2\u4ee5\u5185\u3067\u306f\u306a\u3044\u3068\u30a8\u30e9\u30fc\u306b\u306a\u308b\u4ed5\u69d8\u3067\u3059\u3002\u305d\u306e\u5834\u5408\u3001\u975e\u540c\u671f\u3067\u5225\u306elambda\u3092\u547c\u3073\u3060\u3057\u3066\u3042\u3052\u305f\u308a\u3059\u308b\u3053\u3068\u3067\u56de\u907f\u3057\u307e\u3059\u3002\n\u547c\u3073\u51fa\u3055\u308c\u305flambda\u3067\u306f\u3001response_url\u30d1\u30e9\u30e1\u30fc\u30bf\u306b\u8a18\u8f09\u3055\u308c\u3066\u3044\u308bURL\u306b\u5bfe\u3057\u3066\u3001\u30e1\u30c3\u30bb\u30fc\u30b8\u3092POST\u3057\u307e\u3059\u3002\u305d\u3046\u3059\u308c\u3070\u30e1\u30c3\u30bb\u30fc\u30b8\u304c\u8868\u793a\u3055\u308c\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002response_url\u306f30\u5206\u4ee5\u5185\u3067\uff15\u56de\u307e\u3067\u3057\u304b\u5229\u7528\u3067\u304d\u307e\u305b\u3093\u3002\n\n\u30e1\u30c3\u30bb\u30fc\u30b8\u306e\u306e\u8868\u793a\u975e\u8868\u793a\n\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3057\u305f\u3068\u304d\u306b\u3001\u672c\u4eba\u306b\u3057\u304b\u898b\u3048\u306a\u3044\u30e1\u30c3\u30bb\u30fc\u30b8\u304b\u3069\u3046\u304b\u306f response_type\u304cin_channel\u304bephemeral\u304b\u3067\u6c7a\u307e\u308a\u307e\u3059\u3002\u30c7\u30d5\u30a9\u30eb\u30c8\u306fephemeral\u306a\u306e\u3067\u672c\u4eba\u306b\u3057\u304b\u8868\u793a\u3055\u308c\u307e\u305b\u3093\u3002\nresponse_url\u3092\u4f7f\u3063\u3066\u8907\u6570\u56de\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u9001\u308b\u3068\u3001\u30c7\u30d5\u30a9\u30eb\u30c8\u3067\u306f\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u66f8\u304d\u5909\u3048\u307e\u3059\u304c\u3001\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u66f8\u304d\u5909\u3048\u305a\u306b\u65b0\u3057\u304f\u9014\u4e2d\u304b\u3089\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u8868\u793a\u3059\u308b\u3088\u3046\u306b\u3057\u305f\u308a\u3068\u3044\u3063\u305f\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n# API Gateway + Lambda \u3067 slack\n\n\u524d\u56deslack app\u3092\u767b\u9332\u3057\u305f\u7d9a\u304d\u304b\u3089\u3067\u3059\u3002\n\nhttp://qiita.com/kanagi/items/843f898458df34f6ae90\n\n\nslash command\u3068interactive message\u3092\u5229\u7528\u3057\u3066\u5bfe\u8a71\u7684\u306bslack\u3067\u51e6\u7406\u3092\u9032\u3081\u3066\u307f\u307e\u3059\u3002\n\n## lambda\u306e\u767b\u9332\n\n\u307e\u305a\u306f\u52d5\u4f5c\u30c6\u30b9\u30c8\u306e\u305f\u3081\u306bapex\u306ehello\u3092\u7f6e\u3044\u3066\u3057\u307e\u3044\u307e\u3059\u3002\n```\napex deploy hello\n```\n\u3067\u5b9f\u884c\u3055\u308c\u308b\u3068\u30c6\u30ad\u30b9\u30c8\u3060\u3051\u51fa\u529b\u3059\u308b\u30b5\u30f3\u30d7\u30eb\u304c\u914d\u7f6e\u3055\u308c\u307e\u3059\u3002\n\n## API Gateway\u306e\u767b\u9332\n\n`/` \u306b\u914d\u7f6e\u3057\u3066\u3057\u307e\u3044\u307e\u3059\u3002\n\n* [\u30a2\u30af\u30b7\u30e7\u30f3] -> [\u30e1\u30bd\u30c3\u30c9\u306e\u4f5c\u6210] -> POST\u3092\u9078\u3093\u3067\u30c1\u30a7\u30c3\u30af\u3092\u30af\u30ea\u30c3\u30af\n\n![API_Gateway.png](https://qiita-image-store.s3.amazonaws.com/0/63168/823357d9-d88e-750a-8807-859707156024.png)\n\n* \u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u753b\u9762\u306b\u306a\u308b\u306e\u3067\u3001\u5148\u307b\u3069\u4f5c\u6210\u3057\u305flambda\u3092\u9078\u3093\u3067[\u4fdd\u5b58]\n\n![API_Gateway2.png](https://qiita-image-store.s3.amazonaws.com/0/63168/629bab13-5ecd-f74f-fd96-d438195ab66b.png)\n\n* \u6a29\u9650\u8a31\u53ef\u78ba\u8a8d\u753b\u9762\u304c\u3067\u308b\u306e\u3067[OK]\n\n![API_Gateway3.png](https://qiita-image-store.s3.amazonaws.com/0/63168/22fefedf-6d0f-972e-2e17-3a551b5e0c81.png)\n\n* \u30e1\u30bd\u30c3\u30c9\u306e\u5b9f\u884c\u753b\u9762\u3067[\u7d71\u5408\u30ea\u30af\u30a8\u30b9\u30c8]\u3092\u9078\u629e\n\n![API_Gateway4.png](https://qiita-image-store.s3.amazonaws.com/0/63168/c2c6d218-ad8d-4be3-3c9d-be9d8bb953a4.png)\n\n* [\u672c\u6587\u30de\u30c3\u30d4\u30f3\u30b0\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8]\u3092\u30af\u30ea\u30c3\u30af\u3057\u3066\u8a73\u7d30\u3092\u51fa\u3057\u3066\u304b\u3089\u3001[\u30de\u30c3\u30d4\u30f3\u30b0\u30c6\u30f3\u30d7\u30ec\u30fc\u3068\u306e\u8ffd\u52a0] -> application/x-www-form-urlencoded \u3092\u5165\u529b\u3057\u3066\u30c1\u30a7\u30c3\u30af\u3092\u30af\u30ea\u30c3\u30af\n\n![API_Gateway5.png](https://qiita-image-store.s3.amazonaws.com/0/63168/ae7c4869-ec10-fff2-e819-e2dca50619f1.png)\n\n\n* \u30d1\u30b9\u30b9\u30eb\u30fc\u52d5\u4f5c\u306e\u5909\u66f4\u753b\u9762\u304c\u3067\u308b\u306e\u3067 [\u306f\u3044\u3001\u3053\u306e\u7d71\u5408\u3092\u4fdd\u8b77\u3057\u307e\u3059]\n\n![API_Gateway6.png](https://qiita-image-store.s3.amazonaws.com/0/63168/7dd2a649-6393-1ff6-98e1-7c7c89424db4.png)\n\n* POST\u306e\u4e2d\u8eab\u3092querystring\u306b\u62bc\u3057\u8fbc\u3080\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u3092\u8a18\u8ff0\u3057\u3066[\u4fdd\u5b58]\n\n\u524d\u56de\u306f\u8a73\u7d30\u3092\u66f8\u304d\u307e\u305b\u3093\u3067\u3057\u305f\u304c\u3001\u3053\u308c\u306fvelocity\u306e\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u3067\u3059\u3002aws\u3067\u898f\u5b9a\u3055\u308c\u3066\u3044\u308b\u5909\u6570\u3092velocity\u306e\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u3092\u4f7f\u3063\u3066lambda\u306b\u6e21\u3059\u3053\u3068\u304c\u3067\u304d\u308b\u3068\u3044\u3046\u4ed5\u7d44\u307f\u3067\u3059\u3002\n\nPOST\u306e\u30c7\u30fc\u30bf\u3092\u5c55\u958b\u3057\u3066\u6e21\u3059\u3053\u3068\u304c\u3067\u304d\u308b\u306e\u3067\u4e0b\u8a18\u3092\u53c2\u8003\u306b\u3057\u305f\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u3092\u914d\u7f6e\u3057\u3066\u3044\u307e\u3059\u3002\u57fa\u672c\u7684\u306b\u4f7f\u3046\u306e\u306f\u3001querystring\u5185\u306b\u5c55\u958b\u3055\u308c\u308bPOST\u3067\u6e21\u3055\u308c\u305f\u30d1\u30e9\u30e1\u30fc\u30bf\u3067\u3059\u3002\n\nhttp://qiita.com/durosasaki/items/83af014aa85a0448770e\nhttp://dev.classmethod.jp/cloud/aws/sugano-013-api-gateway/\n\n![API_Gateway7.png](https://qiita-image-store.s3.amazonaws.com/0/63168/952599fa-3ac0-adfb-a1a7-8daa7351037f.png)\n\n```\n#set($rawAPIData = $input.path('$'))\n## escape any quotes\n#set($rawAPIData = $rawAPIData.replace('\"', '\\\"'))\n\n## first we get the number of \"&\" in the string, this tells us if there is more than one key value pair\n#set($countAmpersands = $rawAPIData.length() - $rawAPIData.replace(\"&\", \"\").length())\n\n## if there are no \"&\" at all then we have only one key value pair.\n## we append an ampersand to the string so that we can tokenise it the same way as multiple kv pairs.\n## the \"empty\" kv pair to the right of the ampersand will be ignored anyway.\n#if ($countAmpersands == 0)\n #set($rawPostData = $rawAPIData + \"&\")\n#end\n\n## now we tokenise using the ampersand(s)\n#set($tokenisedAmpersand = $rawAPIData.split(\"&\"))\n\n## we set up a variable to hold the valid key value pairs\n#set($tokenisedEquals = [])\n\n## now we set up a loop to find the valid key value pairs, which must contain only one \"=\"\n#foreach( $kvPair in $tokenisedAmpersand )\n #set($countEquals = $kvPair.length() - $kvPair.replace(\"=\", \"\").length())\n #if ($countEquals == 1)\n  #set($kvTokenised = $kvPair.split(\"=\"))\n  #if ($kvTokenised[0].length() > 0)\n   ## we found a valid key value pair. add it to the list.\n   #set($devNull = $tokenisedEquals.add($kvPair))\n  #end\n #end\n#end\n\n{\n    \"headers\" : {\n#foreach( $key in $input.params().header.keySet() )\n       \"$key\" : \"$input.params().header.get($key)\"#if( $foreach.hasNext ),#end\n#end\n    },\n    \"querystring\" : {\n#foreach( $kvPair in $tokenisedEquals )\n  ## finally we output the JSON for this pair and append a comma if this isn't the last pair\n  #set($kvTokenised = $kvPair.split(\"=\"))\n  #if($kvTokenised.size() == 2 && $kvTokenised[1].length() > 0)\n    #set($kvValue = $kvTokenised[1])\n  #else\n    #set($kvValue = \"\")\n  #end\n  #if( $foreach.hasNext )\n    #set($itemDelimiter = \",\")\n  #else\n    #set($itemDelimiter = \"\")\n  #end\n \"$kvTokenised[0]\" : \"$kvValue\"$itemDelimiter\n#end\n    },\n    \"stage\" : \"$context.stage\",\n    \"sourceIp\" : \"$context.identity.sourceIp\",\n    \"userAgent\" : \"$context.identity.userAgent\"\n}\n```\n\n* \u30c7\u30d7\u30ed\u30a4\u3057\u306a\u3044\u3068\u53cd\u6620\u3055\u308c\u306a\u3044\u306e\u3067[\u30a2\u30af\u30b7\u30e7\u30f3] -> [API\u306e\u30c7\u30d7\u30ed\u30a4] -> API\u306e\u30c7\u30d7\u30ed\u30a4\u30a6\u30a3\u30f3\u30c9\u30a6\u304c\u3067\u308b\u306e\u3067\u3001\u30b9\u30c6\u30fc\u30b8\u540d\u3092\u524d\u56de\u4f5c\u3063\u305f\u3082\u306e\u3092\u9078\u629e\u3057\u3066[\u30c7\u30d7\u30ed\u30a4]\n\n![API_Gateway8.png](https://qiita-image-store.s3.amazonaws.com/0/63168/cd6f01cf-cb70-a2d7-b170-9ce2f17a045b.png)\n\n* URL\u306e\u547c\u3073\u51fa\u3057:\u3067\u793a\u3055\u308c\u308bURL\u3092\u53d6\u3063\u3066\u304a\u304d\u307e\u3059\n\n![API_Gateway9.png](https://qiita-image-store.s3.amazonaws.com/0/63168/249b7c75-e699-acbe-0667-bc6831317a92.png)\n\n\n# slash command\u3092\u767b\u9332\n\nslack app\u306e\u753b\u9762\u304b\u3089[slash commands]\u3092\u9078\u629e\u3057\u3066\u3001[Create New Command]\u3092\u9078\u3073\u307e\u3059\u3002\n\n![Slack_API__Applications___wacul_Slack.png](https://qiita-image-store.s3.amazonaws.com/0/63168/0c47f769-c018-56ff-8108-bf64931add11.png)\n\n\u3053\u306e\u6642\u70b9\u3067\u3001API gateway\u306b`application/x-www-form-urlencoded`\u3067POST\u3059\u308b\u3068\u3001helloworld\u304c\u5e30\u3063\u3066\u304f\u308b\u306f\u305a\u3067\u3059\u3002\n\n```bash:\n$ curl -XPOST -d \"test\" [API gateway\u306eURL]\n{\"hello\":\"world\"}\n```\n\n## slack app\u306e\u8a2d\u5b9a\n\n* \u4f5c\u6210\u3057\u305fslack app\u306e[Slash Commands]\u304b\u3089[Create New Command]\n\n![Slack_API__Applications___wacul_Slack.png](https://qiita-image-store.s3.amazonaws.com/0/63168/fc030878-8933-7514-d79a-7ea501a5b75b.png)\n\n* \u30b3\u30de\u30f3\u30c9\u3092\u767b\u9332\u3059\u308b\n\n\u767b\u9332\u3059\u308b\u30b3\u30de\u30f3\u30c9\u540d\u3092`Command`\u3001`Request URL`\u306bAPI Gateway\u3067\u63a7\u3048\u305fURL\u3001`Short Description`\u306b\u9069\u5f53\u306a\u8aac\u660e\u3092\u5165\u308c\u3066[Save]\n\n\n![Slack_API__Applications___wacul_Slack3.png](https://qiita-image-store.s3.amazonaws.com/0/63168/6c5938c2-e4e7-5878-4df7-2d86ffaf50d5.png)\n\n\nslack\u3067`/hello`\u3057\u305f\u3089\u8fd4\u4e8b\u304c\u8fd4\u3063\u3066\u6765\u308c\u3070\u6210\u529f\u3067\u3059\u3002\n\n## token\u30c1\u30a7\u30c3\u30af\u306e\u8ffd\u52a0\n\n\u3053\u306e\u307e\u307e\u3067\u306f`curl`\u3067\u30c6\u30b9\u30c8\u3057\u305f\u901a\u308a\u3001\u3069\u3053\u304b\u3089\u3067\u3082URL\u3092\u53e9\u3051\u3070\u7d50\u679c\u3092\u51fa\u3057\u3066\u3057\u307e\u3044\u307e\u3059\u3002\n`hello`\u306e\u3088\u3046\u306b\u7279\u306b\u610f\u5473\u306e\u306a\u3044\u7d50\u679c\u3092\u8fd4\u3059\u3060\u3051\u306a\u3089\u554f\u984c\u306a\u3044\u3067\u3059\u304c\u3001\u4f5c\u3063\u305fslack app\u306e\u901a\u77e5\u3060\u3068\u3044\u3046\u3053\u3068\u3092\u78ba\u8a8d\u3059\u308b\u305f\u3081\u306btoken\u3092\u30c1\u30a7\u30c3\u30af\u3059\u308b\u3088\u3046\u306b\u3057\u307e\u3059\u3002\n\ntoken\u306f\u4f5c\u6210\u3057\u305fslack app\u306e`client id`\u3084`client secret`\u304c\u8a18\u8f09\u3055\u308c\u3066\u3044\u305f\u3001[Basic Infomation]\u306e`Verification Token`\u306b\u8a18\u8f09\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n\n\u3053\u308c\u304c\u3001slack\u304b\u3089POST\u3055\u308c\u305f\u6642\u306e\u30d1\u30e9\u30e1\u30fc\u30bf\n\nhttps://api.slack.com/slash-commands#triggering_a_command\n\n\u306etoken\u3068\u3057\u3066\u9001\u3089\u308c\u3066\u304f\u308b\u306e\u3067\u3001\u6587\u5b57\u5217\u304c\u4e00\u81f4\u3059\u308b\u304b\u30c1\u30a7\u30c3\u30af\u3059\u308b\u3060\u3051\u3067\u3059\u3002\n\n\u4ed6\u3001\u4f7f\u7528\u3059\u308b\u30e6\u30fc\u30b6\u3084\u30c1\u30e3\u30f3\u30cd\u30eb\u3092\u5236\u9650\u3057\u305f\u3044\u306a\u3089\u3001`user_id`\u3084`channel_id`\u3092\u30c1\u30a7\u30c3\u30af\u3057\u305f\u308a\u3059\u308c\u3070\u3044\u3044\u3053\u3068\u306b\u306a\u308a\u307e\u3059\u3002\n\n# interactive message\n\ninteractive message\u3068\u306f\u3001slack\u306e\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u306b\u4e57\u3063\u3066\u3044\u308b\u3082\u306e\u3092\u898b\u3066\u3082\u3089\u3046\u306e\u304c\u4e00\u756a\u65e9\u3044\u304b\u3068\u601d\u3044\u307e\u3059\u3002\n\nhttps://api.slack.com/docs/message-buttons\n\n\u30dc\u30bf\u30f3\u3092\u8868\u793a\u3057\u3066\u3001\u62bc\u3057\u305f\u30dc\u30bf\u30f3\u306b\u5bfe\u3057\u3066\u3055\u3089\u306b\u53cd\u5fdc\u3055\u305b\u308b\u3053\u3068\u304c\u3067\u304d\u308b\u3082\u306e\u3067\u3059\u3002\n\u3053\u308c\u3092\u5229\u7528\u3059\u308b\u3068\u3001jenkins\u3067\u3084\u3063\u3066\u3044\u305f\u3088\u3046\u306a\u30c7\u30d7\u30ed\u30a4\u306e\u5b9f\u884c\u306a\u3069\u3092slack\u3067\u5b8c\u7d50\u3055\u305b\u308b\u3053\u3068\u304c\u53ef\u80fd\u306b\u306a\u308a\u307e\u3059\u3002\n\n## slack app\u306e\u8a2d\u5b9a\n\ninteractive message\u7528\u306b\u5225\u306elambda\u3092\u4f5c\u3063\u3066\u3082\u3044\u3044\u3067\u3059\u304c\u3001\u3053\u3053\u3067\u306f\u540c\u3058\u3082\u306e\u3092\u4f7f\u3044\u307e\u308f\u3057\u307e\u3059\u3002\n\n* \u767b\u9332\u3057\u305fslack app\u306e[Interactive Messages]\u304b\u3089[Enable Interactive Messages]\n\n![Slack_API__Applications___wacul_Slack.png](https://qiita-image-store.s3.amazonaws.com/0/63168/49261497-9f7c-cef9-6ef2-422b653fbdf4.png)\n\n* [Request URL]\u306bAPI Gateway\u3067\u63a7\u3048\u305fURL\u3092\u5165\u308c\u3066[Enable Interative Messages]\n\n![Slack_API__Applications___wacul_Slack2.png](https://qiita-image-store.s3.amazonaws.com/0/63168/c93dc90c-1db8-be6d-0cd5-c6553cb006ba.png)\n\n## lambda function\u306e\u5909\u66f4\n\nslack\u306e\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u901a\u308a\u3001\u8fd4\u5374\u3059\u308b\u30e1\u30c3\u30bb\u30fc\u30b8\u306baction\u3092\u4ed8\u3051\u52a0\u3048\u307e\u3059\u3002\n\n```\nconsole.log('starting function')\nexports.handle = function(e, ctx, cb) {\n  console.log('processing event: %j', e)\n  cb(null, { text: \"button\", attachments: [{ \"callback_id\": \"test\", actions: [{name: \"test\", text: \"Test\", type: \"button\", value: \"test\"}] }] } )\n}\n```\n\n```\napex deploy hello\n```\n\n\u3067\u30c7\u30d7\u30ed\u30a4\u3057\u3066\u6e96\u5099\u5b8c\u4e86\u3067\u3059\u3002\n\n## \u5b9f\u884c\u3057\u3066\u307f\u308b\n\nslack\u3067 `/hello` \u3092\u5b9f\u884c\u3059\u308b\u3068\u4e0b\u8a18\u306e\u3088\u3046\u306b\u306a\u308b\u306f\u305a\u3067\u3059\u3002\n\n![Slack_-_wacul.png](https://qiita-image-store.s3.amazonaws.com/0/63168/d3732fcd-f457-da06-1905-0d1c1bcb92f0.png)\n\n\u3053\u306e[Test]\u30dc\u30bf\u30f3\u304c\u62bc\u305b\u308b\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002\u62bc\u3059\u3068\u3001\u30dc\u30bf\u30f3\u306f\u6d88\u3048\u3066\u3057\u307e\u3046\u306f\u305a\u3067\u3059\u3002\n\n\u30dc\u30bf\u30f3\u3092\u62bc\u3057\u305f\u969b\u306b\u3001interactive messages\u3067\u767b\u9332\u3057\u305fURL\u306b\u30ea\u30af\u30a8\u30b9\u30c8\u304c\u98db\u3093\u3067\u304a\u308a\u3001\u305d\u306e\u8fd4\u7b54\u304c\u8868\u793a\u3055\u308c\u3066\u3044\u308b\u306e\u3067\u3059\u304c\u3001\u4eca\u56de\u306f\u30dc\u30bf\u30f3\u3092\u62bc\u3057\u305f\u969b\u306b\u3082\u540c\u3058`callback_id`\u306e\u30dc\u30bf\u30f3\u3092\u51fa\u3057\u3066\u3044\u308b\u306e\u3067\u3001\u30dc\u30bf\u30f3\u304c\u8868\u793a\u3055\u308c\u306a\u3044\u7d50\u679c\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002\n\n\n\u3042\u3068\u306f\u3001\u30dc\u30bf\u30f3\u3092\u62bc\u3057\u305f\u6642\u306b\u6e21\u3055\u308c\u308b\u30d1\u30e9\u30e1\u30fc\u30bf\n\nhttps://api.slack.com/docs/message-buttons#responding_to_message_actions\n\n\u306b\u5f93\u3063\u3066\u51e6\u7406\u3092\u9032\u3081\u3066\u3044\u3051\u3070\u5bfe\u8a71\u7684\u306bslack\u4e0a\u3067\u51e6\u7406\u3092\u7d44\u307f\u7acb\u3066\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\n\u6ce8\u610f\u70b9\u3068\u3057\u3066\u3001slash command\u306e\u5834\u5408\u3068\u7570\u306a\u308a\u3001payload\u30d1\u30e9\u30e1\u30fc\u30bf\u306bURL\u30a8\u30f3\u30b3\u30fc\u30c9\u3055\u308c\u305fjson\u3067\u30c7\u30fc\u30bf\u304c\u6e21\u3055\u308c\u308b\u306e\u3067\u3001slash command\u3068\u540c\u3058lambda\u3092\u4f7f\u3046\u5834\u5408\u306f\u3001payload\u30d1\u30e9\u30e1\u30fc\u30bf\u306e\u6709\u7121\u3067\u51e6\u7406\u3092\u5206\u3051\u308b\u3068\u3044\u3044\u3067\u3057\u3087\u3046\u3002\n\n# TIPS\n\n## 3\u79d2\u4ee5\u4e0a\u304b\u304b\u308b\u51e6\u7406\n\nslash commands\u306e\u6700\u521d\u306e\u5fdc\u7b54\u306f3\u79d2\u4ee5\u5185\u3067\u306f\u306a\u3044\u3068\u30a8\u30e9\u30fc\u306b\u306a\u308b\u4ed5\u69d8\u3067\u3059\u3002\u305d\u306e\u5834\u5408\u3001\u975e\u540c\u671f\u3067\u5225\u306elambda\u3092\u547c\u3073\u3060\u3057\u3066\u3042\u3052\u305f\u308a\u3059\u308b\u3053\u3068\u3067\u56de\u907f\u3057\u307e\u3059\u3002\n\n\u547c\u3073\u51fa\u3055\u308c\u305flambda\u3067\u306f\u3001response_url\u30d1\u30e9\u30e1\u30fc\u30bf\u306b\u8a18\u8f09\u3055\u308c\u3066\u3044\u308bURL\u306b\u5bfe\u3057\u3066\u3001\u30e1\u30c3\u30bb\u30fc\u30b8\u3092POST\u3057\u307e\u3059\u3002\u305d\u3046\u3059\u308c\u3070\u30e1\u30c3\u30bb\u30fc\u30b8\u304c\u8868\u793a\u3055\u308c\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002response_url\u306f30\u5206\u4ee5\u5185\u3067\uff15\u56de\u307e\u3067\u3057\u304b\u5229\u7528\u3067\u304d\u307e\u305b\u3093\u3002\n\n## \u30e1\u30c3\u30bb\u30fc\u30b8\u306e\u306e\u8868\u793a\u975e\u8868\u793a\n\n\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3057\u305f\u3068\u304d\u306b\u3001\u672c\u4eba\u306b\u3057\u304b\u898b\u3048\u306a\u3044\u30e1\u30c3\u30bb\u30fc\u30b8\u304b\u3069\u3046\u304b\u306f `response_type`\u304c`in_channel`\u304b`ephemeral`\u304b\u3067\u6c7a\u307e\u308a\u307e\u3059\u3002\u30c7\u30d5\u30a9\u30eb\u30c8\u306f`ephemeral`\u306a\u306e\u3067\u672c\u4eba\u306b\u3057\u304b\u8868\u793a\u3055\u308c\u307e\u305b\u3093\u3002\n\n`response_url`\u3092\u4f7f\u3063\u3066\u8907\u6570\u56de\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u9001\u308b\u3068\u3001\u30c7\u30d5\u30a9\u30eb\u30c8\u3067\u306f\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u66f8\u304d\u5909\u3048\u307e\u3059\u304c\u3001\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u66f8\u304d\u5909\u3048\u305a\u306b\u65b0\u3057\u304f\u9014\u4e2d\u304b\u3089\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u8868\u793a\u3059\u308b\u3088\u3046\u306b\u3057\u305f\u308a\u3068\u3044\u3063\u305f\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\n", "tags": ["AWS", "AWSLambda", "Slack", "APIGateway"]}