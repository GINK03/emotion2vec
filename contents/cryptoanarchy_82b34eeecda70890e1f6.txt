{"tags": ["OpenVPN", "WiFi", "iptables"], "context": "\u516c\u8846\u7121\u7ddaLAN\u306f53/UDP\u3092\u958b\u3051\u3066\u308b\u3053\u3068\u304c\u304a\u304a\u304f\u3001\u3053\u308c\u3092\u629c\u3051\u3066\u81ea\u524d\u306eOpenVPN\u306b\u63a5\u7d9a\u3059\u308b\u3053\u3068\u3067\u30bf\u30c0\u30ce\u30ea\u3067\u304d\u308b\u3002\n\nopenvpn\u306e\u8a2d\u5b9a\u3092\u5909\u3048\u308b\u5834\u5408\nport 53\nproto udp\n\n\u4ee5\u4e0a\u3002\n\n\u30dd\u30fc\u30c8\u30d5\u30a9\u30ef\u30fc\u30c9\u3092\u3059\u308b\u5834\u5408\n\u540c\u3058\u30b5\u30fc\u30d0\u30fc\u3067DNS\u30ad\u30e3\u30c3\u30b7\u30e5\u30b5\u30fc\u30d0\u30fc\u3068\u304b\u3092\u52d5\u304b\u3057\u3066\u3044\u308b\u5834\u5408\u306f\u300153\u306f\u30c0\u30d6\u3063\u3066\u4f7f\u3048\u306a\u3044\u3002\u305d\u306e\u5834\u5408\u306f\u30dd\u30fc\u30c8\u30d5\u30a9\u30ef\u30fc\u30c9\u3067\u89e3\u6c7a\u3002\nOpenVPN\u306e\u8a2d\u5b9a\u306f\u4ee5\u4e0b\u3092\u4eee\u5b9a\u3002\n\nport 1194\nproto udp\n\n\niptables\niptables -t nat -A PREROUTING -p udp -i ens3 -d 45.32.21.100 --dport 53 -j REDIRECT --to-port 443\n\n\u6c38\u7d9a\u5316\niptables\u306f\u4e00\u6642\u7684\u306a\u3082\u306e\u306a\u306e\u3067\u30d5\u30a1\u30a4\u30eb\u306b\u66f8\u304d\u8fbc\u3093\u3067\u304a\u304f\u3002\u3053\u3053\u3067\u306fufw\u3092\u4f7f\u3063\u3066\u3044\u308b\u3068\u4eee\u5b9a\u3059\u308b\u3002\n/etc/ufw/before.rules \u306a\u3089\u3070\u3001nat\u30c6\u30fc\u30d6\u30eb\u306bPREROUTING\u30c1\u30a7\u30a4\u30f3\u306753\u21921194\u306b\u8ee2\u9001\u3002\n*nat\n:POSTROUTING ACCEPT [0:0]\n# Allow traffic from OpenVPN client to eth0\n-A POSTROUTING -s 10.8.0.0/24 -o eth0 -j MASQUERADE\n#-A POSTROUTING -s 10.8.0.0/24 -o tun0 -j MASQUERADE # \u4ed6\u306eVPN\u306b\u3064\u306a\u3044\u3067\u308btun\u3068\u304b\n\n# 53 -> 443\n-A PREROUTING -p udp -i ens3 -d 45.32.21.100 --dport 53 -j REDIRECT --to-port 1194\nCOMMIT\n\n\u516c\u8846\u7121\u7ddaLAN\u306f53/UDP\u3092\u958b\u3051\u3066\u308b\u3053\u3068\u304c\u304a\u304a\u304f\u3001\u3053\u308c\u3092\u629c\u3051\u3066\u81ea\u524d\u306eOpenVPN\u306b\u63a5\u7d9a\u3059\u308b\u3053\u3068\u3067\u30bf\u30c0\u30ce\u30ea\u3067\u304d\u308b\u3002\n\n# openvpn\u306e\u8a2d\u5b9a\u3092\u5909\u3048\u308b\u5834\u5408\n```\nport 53\nproto udp\n```\n\n\u4ee5\u4e0a\u3002\n\n# \u30dd\u30fc\u30c8\u30d5\u30a9\u30ef\u30fc\u30c9\u3092\u3059\u308b\u5834\u5408\n\u540c\u3058\u30b5\u30fc\u30d0\u30fc\u3067DNS\u30ad\u30e3\u30c3\u30b7\u30e5\u30b5\u30fc\u30d0\u30fc\u3068\u304b\u3092\u52d5\u304b\u3057\u3066\u3044\u308b\u5834\u5408\u306f\u300153\u306f\u30c0\u30d6\u3063\u3066\u4f7f\u3048\u306a\u3044\u3002\u305d\u306e\u5834\u5408\u306f\u30dd\u30fc\u30c8\u30d5\u30a9\u30ef\u30fc\u30c9\u3067\u89e3\u6c7a\u3002\n\nOpenVPN\u306e\u8a2d\u5b9a\u306f\u4ee5\u4e0b\u3092\u4eee\u5b9a\u3002\n```\nport 1194\nproto udp\n```\n\n\n## iptables\niptables -t nat -A PREROUTING -p udp -i ens3 -d 45.32.21.100 --dport 53 -j REDIRECT --to-port 443\n\n\n## \u6c38\u7d9a\u5316\niptables\u306f\u4e00\u6642\u7684\u306a\u3082\u306e\u306a\u306e\u3067\u30d5\u30a1\u30a4\u30eb\u306b\u66f8\u304d\u8fbc\u3093\u3067\u304a\u304f\u3002\u3053\u3053\u3067\u306fufw\u3092\u4f7f\u3063\u3066\u3044\u308b\u3068\u4eee\u5b9a\u3059\u308b\u3002\n/etc/ufw/before.rules \u306a\u3089\u3070\u3001nat\u30c6\u30fc\u30d6\u30eb\u306bPREROUTING\u30c1\u30a7\u30a4\u30f3\u306753\u21921194\u306b\u8ee2\u9001\u3002\n\n```\n*nat\n:POSTROUTING ACCEPT [0:0]\n# Allow traffic from OpenVPN client to eth0\n-A POSTROUTING -s 10.8.0.0/24 -o eth0 -j MASQUERADE\n#-A POSTROUTING -s 10.8.0.0/24 -o tun0 -j MASQUERADE # \u4ed6\u306eVPN\u306b\u3064\u306a\u3044\u3067\u308btun\u3068\u304b\n\n# 53 -> 443\n-A PREROUTING -p udp -i ens3 -d 45.32.21.100 --dport 53 -j REDIRECT --to-port 1194\nCOMMIT\n```\n"}