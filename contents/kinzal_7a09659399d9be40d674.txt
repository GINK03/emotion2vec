{"context": "\u3053\u306e\u6295\u7a3f\u306fServerless(2)\u30a2\u30c9\u30d9\u30f3\u30c8\u30ab\u30ec\u30f3\u30c0\u30fc\u306e8\u65e5\u76ee\u306e\u8a18\u4e8b\u3067\u3059\u3002\n\u53bb\u5e74\u306b AWS Lambda\u306e\u30c7\u30d7\u30ed\u30a4\u30d5\u30ed\u30fc\u7ba1\u7406 \u3068\u3044\u3046\u8a18\u4e8b\u3092\u66f8\u304d\u307e\u3057\u305f\u304c\u3001\u3042\u308c\u304b\u3089\u306e\u4e00\u5e74\u3067AWS Lambda\u306e\u72b6\u6cc1\u304c\u3044\u308d\u3044\u308d\u5909\u308f\u308a\u307e\u3057\u305f\u3002\n\u5f85\u671b\u306e\u74b0\u5883\u5909\u6570\u5bfe\u5fdc\u3084\u3001Step Function\u306b\u3088\u308bAWS Lambda\u306e\u30d0\u30c3\u30c1\u5316\u3001Serverless Application Model\u3068\u3044\u3046AWS\u516c\u5f0f\u306e\u30c7\u30d7\u30ed\u30a4\u30c4\u30fc\u30eb\u3001Serverless\u3084Apex\u3001Lamvery\u306a\u3069\u306eLambda\u95a2\u9023\u306e\u30d5\u30ec\u30fc\u30e0\u30ef\u30fc\u30af\u306e\u5145\u5b9f\u306a\u3069\u3001\u4e00\u5e74\u524d\u306b\u6bd4\u3079AWS Lambda\u304c\u4fbf\u5229\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002\n\u305d\u3093\u306a\u72b6\u6cc1\u306e\u4e2d\u30011\u5e74\u524d\u306e\u8a18\u4e8b\u306e\u30d3\u30e5\u30fc\u3001\u30b9\u30c8\u30c3\u30af\u6570\u304c\u5897\u3048\u3066\u884c\u304f\u306e\u306f\u7533\u3057\u8a33\u306a\u3044\u3002\u3068\u3044\u3046\u3053\u3068\u30672016\u5e74\u7248\u3068\u3044\u3046\u5f62\u3067\u3001\u65b0\u3057\u3044\u958b\u767a\u30d5\u30ed\u30fc\u306e\u8a71\u3092\u3057\u3088\u3046\u3068\u601d\u3044\u307e\u3059\u3002\n\nServerless Application Model\nSAM\u306fAWS\u304c\u65b0\u3057\u304f\u51fa\u3057\u305fAWS Lambda\u306e\u30c7\u30d7\u30ed\u30a4\u30c4\u30fc\u30eb\u3067\u3059\u3002\n\nhttps://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md\n\n\u6a5f\u80fd\u3068\u3057\u3066\u306fCloudFormation\u306e\u30e9\u30c3\u30d1\u30fc\u3067\u3001\u30ed\u30fc\u30ab\u30eb\u2192S3\u306b\u30b3\u30fc\u30c9\u3092\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u3057\u3001CloudFormation\u3067Lambda Function\u3084\u4ed6\u30ea\u30bd\u30fc\u30b9\u306e\u4f5c\u6210\u3092\u884c\u3046\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\nAWSTemplateFormatVersion: '2010-09-09'\nTransform: 'AWS::Serverless-2016-10-31'\nDescription: A starter AWS Lambda function.\nParameters:\n  LambdaExectionRoleArn:\n    Type: String\n    Description: Role Arn of Lambda execution\nResources:\n  MyFunction:\n    Type: 'AWS::Serverless::Function'\n    Properties:\n      Handler: src/index.handler\n      Runtime: nodejs4.3\n      CodeUri: .\n      Description: A starter AWS Lambda function.\n      MemorySize: 1536\n      Timeout: 10\n      Role:\n        Ref: LambdaExectionRoleArn\n\n$ aws cloudformation package --template-file template.yml --output-template-file .dist/template.yml --s3-bucket bucket_name\n$ aws cloudformation deploy --template-file .dist/template.yml --stack-name stack1 --capabilities CAPABILITY_IAM\n\n\u7af6\u5408\u30c4\u30fc\u30eb\u3068\u3057\u3066\u306f\u3068\u3057\u3066\u306fServerless\u3001Apex\u3001Lamvery\u306a\u3069\u304c\u3042\u308a\u307e\u3059\u3002\n\u79c1\u898b\u3067\u3059\u304c\u7528\u9014\u3068\u3057\u3066\u306f\n\nAPI\u3092\u4f5c\u308a\u305f\u3044 \u2192 Serveless\n\u8907\u6570\u306eAWS Lambda\u3092\u7ba1\u7406\u3057\u305f\u3044 \u2192 Apex\n\u5358\u72ec\u306eAWS Lambda\u3092\u7ba1\u7406\u3057\u305f\u3044 \u2192 Lamvery\n\n\u3068\u3044\u3046\u3088\u3046\u306b\u30c4\u30fc\u30eb\u306b\u3088\u3063\u3066\u3069\u3046\u3044\u3063\u305f\u6642\u306b\u4f7f\u3046\u3068\u826f\u3044\u306e\u304b\u6700\u9069\u89e3\u304c\u5909\u308f\u3063\u3066\u3044\u308b\u5370\u8c61\u3067\u3059\u3002\nSAM\u3067\u306f\u3069\u306e\u7af6\u5408\u30c4\u30fc\u30eb\u3068\u3082\u540c\u69d8\u306e\u7528\u9014\u306e\u3053\u3068\u3092\u3067\u304d\u307e\u3059\u304c\u3001\u7279\u5316\u3057\u3066\u3044\u306a\u3044\u5206\u82e5\u5e72\u6a5f\u80fd\u304c\u8db3\u308a\u306a\u3044\u3068\u3053\u308d\u306f\u3042\u308a\u307e\u3059\u3002\n\u305d\u308c\u3067\u306fSAM\u3092\u9078\u3076\u30e1\u30ea\u30c3\u30c8\u306f\uff1f \u3068\u3044\u3046\u3068\n\nAWS\u306e\u516c\u5f0f\u30c4\u30fc\u30eb\u3067\u3042\u308b\u3053\u3068\nCloudFormation\u3068\u5909\u308f\u3089\u306a\u3044\u306e\u3067\u5b66\u7fd2\u30b3\u30b9\u30c8\u304c\u4f4e\u3044\n\u3069\u306e\u30e9\u30f3\u30bf\u30a4\u30e0\u3001\u3069\u306e\u7528\u9014\u3067\u3082\u540c\u3058\u3088\u3046\u306b\u6271\u3048\u308b\n\n\u3068\u3044\u3046\u3068\u3053\u308d\u3067\u3057\u3087\u3046\u304b\u3002\n\u9006\u306b\u30c7\u30e1\u30ea\u30c3\u30c8\u3092\u4e0a\u3052\u308b\u306a\u3089CloudFormation\u3068\u3044\u3046\u3053\u3068\u3067\u4e2d\u301c\u5927\u898f\u6a21\u306b\u306a\u308b\u3068\u8f9b\u307f\u3057\u304b\u611f\u3058\u306a\u304f\u306a\u308a\u307e\u3059\u3002\u305d\u3053\u3060\u3051\u306f\u6ce8\u610f\u304c\u5fc5\u8981\u3067\u3059\u3002\n\uff08\u3082\u3057\u3001CloudFormation\u3092\u89aa\u306e\u4ec7\u306e\u3088\u3046\u306b\u618e\u3093\u3067\u308b\u4eba\u304c\u3044\u305f\u3089\u6b62\u3081\u305f\u65b9\u304c\u826f\u3044\u3067\u3059\uff09\n\nSAM\u3092\u4f7f\u3063\u305f\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u30c7\u30d7\u30ed\u30a4\u30d5\u30ed\u30fc\nSAM\u3067\u30c7\u30d7\u30ed\u30a4\u30d5\u30ed\u30fc\u3092\u4f5c\u308b\u3042\u305f\u3063\u3066\u6ce8\u610f\u3059\u3079\u304d\u70b9\u304c2\u70b9\u3042\u308a\u307e\u3059\u3002\n\nAWS Lambda\u306e\u30c7\u30d7\u30ed\u30a4\u306b\u5fc5\u8981\u306a\u30ea\u30bd\u30fc\u30b9\u306e\u4f5c\u6210\u3001AWS Lambda\u306e\u30c7\u30d7\u30ed\u30a4\u306e2\u56de\u5b9f\u884c\u304c\u5fc5\u8981\n\u30ed\u30fc\u30ab\u30eb\u5b9f\u884c\u304c\u3067\u304d\u306a\u3044\uff08\u7279\u306bSAM\u90e8\u5206\u306e\u30c6\u30b9\u30c8\u306f\u3067\u304d\u306a\u3044\uff09\u306e\u3067\u958b\u767a/\u672c\u756a\u306e2\u3064\u306e\u74b0\u5883\u3078\u30c7\u30d7\u30ed\u30a4\u3059\u308b\u4ed5\u7d44\u307f\u304c\u5fc5\u8981\n\n\u305d\u308c\u305e\u308c\u306b\u3064\u3044\u3066\u89e3\u8aac\u3057\u3066\u3044\u304d\u307e\u3059\u3002\n\n1. AWS Lambda\u306e\u30c7\u30d7\u30ed\u30a4\u306b\u5fc5\u8981\u306a\u30ea\u30bd\u30fc\u30b9\u306e\u4f5c\u6210\u3001AWS Lambda\u306e\u30c7\u30d7\u30ed\u30a4\u306e2\u56de\u306e\u30c7\u30d7\u30ed\u30a4\u304c\u5fc5\u8981\nSAM\u3067AWS Lambda\u306e\u30c7\u30d7\u30ed\u30a4\u3092\u884c\u3046\u5834\u5408\u3001\u4e8b\u524d\u306b\u3044\u304f\u3064\u304b\u30ea\u30bd\u30fc\u30b9\u3092\u4f5c\u3063\u3066\u304a\u304f\u3079\u304d\u3082\u306e\u304c\u3042\u308a\u307e\u3059\u3002\n\nS3\u30d0\u30b1\u30c3\u30c8\n\n\nZIP\u5727\u7e2e\u3057\u305fAWS Lambda\u306e\u30b3\u30fc\u30c9\u3092\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u3059\u308b\u305f\u3081\u306b\u5fc5\u8981\n\n\nKMS Key\n\n\n\u74b0\u5883\u5909\u6570\u306b\u6697\u53f7\u5316\u3057\u305f\u30ad\u30fc\u3092\u8a2d\u5b9a\u3059\u308b\u305f\u3081\u306b\u5fc5\u8981\uff08\u5fc5\u9808\u3067\u306f\u306a\u3044\uff09\n\n\nIAM Role\n\n\nAWS Lambda\u306eExecution Role\n\u4f5c\u6210\u30bf\u30a4\u30df\u30f3\u30b0\u3068\u3057\u3066\u306fAWS Lambda\u306e\u30c7\u30d7\u30ed\u30a4\u30bf\u30a4\u30df\u30f3\u30b0\u3067\u3082\u826f\u3044\u304c\u3001KMS Key\u3067\u8a31\u53ef\u304c\u5fc5\u8981\u306a\u306e\u3067KMS Key\u3068\u4e00\u7dd2\u306b\u4f5c\u308b\u5fc5\u8981\u304c\u3042\u308b\n\n\n\n\u4eca\u56de\u306fSAM\u306b\u5408\u308f\u305b\u3066CloudFormation\u3067\u5b9f\u884c\u3067\u304d\u308b\u3088\u3046\u306b\u30ea\u30bd\u30fc\u30b9\u3092\u5b9a\u7fa9\u3057\u307e\u3059\u3002\n\nresources.yml\nAWSTemplateFormatVersion: \"2010-09-09\"\nParameters:\n  BucketName:\n    Type: String\n    Description: Bucket for uploading Lambda code\nResources:\n  Bucket:\n    Type: \"AWS::S3::Bucket\"\n    Properties:\n      BucketName:\n        Ref: BucketName\n    DeletionPolicy: \"Delete\"\n  LambdaExectionRole:\n    Type: \"AWS::IAM::Role\"\n    Properties:\n      AssumeRolePolicyDocument:\n        Version: \"2012-10-17\"\n        Statement:\n          -\n            Effect: \"Allow\"\n            Principal:\n              Service:\n                - \"lambda.amazonaws.com\"\n            Action:\n              - \"sts:AssumeRole\"\n      Path: \"/\"\n      Policies:\n        -\n          PolicyName: \"root\"\n          PolicyDocument:\n            Version: \"2012-10-17\"\n            Statement:\n              -\n                Effect: \"Allow\"\n                Action:\n                  - \"logs:CreateLogGroup\"\n                  - \"logs:CreateLogStream\"\n                  - \"logs:PutLogEvents\"\n                Resource: \"arn:aws:logs:*:*:*\"\n              -\n                Effect: \"Allow\"\n                Action:\n                  - \"kms:Decrypt\"\n                Resource: \"*\"\n  LambdaExectionInstanceProfile:\n    Type: \"AWS::IAM::InstanceProfile\"\n    Properties:\n      Path: \"/\"\n      Roles:\n        -\n          Ref: \"LambdaExectionRole\"\n  Key:\n    Type: \"AWS::KMS::Key\"\n    Properties:\n      Description: \"Key used for Lambda environment variables\"\n      KeyPolicy:\n        Version: \"2012-10-17\"\n        Statement:\n          -\n            Sid: \"Allow administration of the key\"\n            Effect: \"Allow\"\n            Principal:\n              AWS:\n                \"Fn::Join\": [ \":\", [ \"arn:aws:sts:\", {\"Ref\" : \"AWS::AccountId\"}, \"root\" ] ]\n            Action:\n              - \"kms:*\"\n            Resource: \"*\"\n          -\n            Effect: \"Allow\"\n            Principal:\n              AWS:\n                - !GetAtt LambdaExectionRole.Arn\n            Action:\n              - \"kms:Decrypt\"\n            Resource: \"*\"\nOutputs:\n  KeyId:\n    Value: !Ref Key\n  LambdaExectionRoleArn:\n    Value: !GetAtt LambdaExectionRole.Arn\n\n\n$ aws  cloudformation create-stack --stack-name stack01-prepare --template-body file://resources.yml --parameters ParameterKey=BucketName,ParameterValue=bucket_name --capabilities CAPABILITY_IAM\n\n\u3053\u3046\u3059\u308b\u3053\u3068\u3067\u3001\u4e8b\u524d\u306b\u5fc5\u8981\u306a\u30ea\u30bd\u30fc\u30b9\u3092\u4f5c\u6210\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\u3082\u3057\u3001\u4e8b\u524d\u306b\u4f5c\u6210\u6e08\u307f\u3067\u3042\u308c\u3070\u3053\u306e\u51e6\u7406\u306f\u5fc5\u8981\u3042\u308a\u307e\u305b\u3093\u3002\n\u3057\u304b\u3057\u3001\u958b\u767a\u8005\u304c\u958b\u767a\u4e2d\u306b\u30ea\u30bd\u30fc\u30b9\u3092\u5171\u6709\u3059\u308b\u3053\u3068\u306f\u30c7\u30e1\u30ea\u30c3\u30c8\u3082\u3042\u308b\u306e\u3067\u3001\u958b\u767a\u8005\u304c\u81ea\u7531\u306b\u30ea\u30bd\u30fc\u30b9\u306e\u4f5c\u6210/\u7834\u68c4\u3092\u884c\u3048\u308b\u3088\u3046\u306b\u5b9a\u7fa9\u3057\u3066\u304a\u304f\u3068\u4fbf\u5229\u3067\u3059\u3002\n\u307e\u305f\u3001Parameter\u3001Outputs\u306e\u5b9a\u7fa9\u306f\u6b21\u306e\u8a71\u306e\u517c\u306d\u5408\u3044\u5165\u51fa\u529b\u3092\u3067\u304d\u308b\u3088\u3046\u306b\u5b9a\u7fa9\u3057\u3066\u3042\u308a\u307e\u3059\u3002\n\n2. \u30ed\u30fc\u30ab\u30eb\u5b9f\u884c\u304c\u3067\u304d\u306a\u3044\u306e\u3067\u958b\u767a/\u672c\u756a\u306e2\u3064\u306e\u74b0\u5883\u3078\u30c7\u30d7\u30ed\u30a4\u3092\u3067\u304d\u308b\u4ed5\u7d44\u307f\u304c\u5fc5\u8981\nSAM\u3067\u306fServerless\u306e\u3088\u3046\u306b\u30ed\u30fc\u30ab\u30eb\u3067\u5b9f\u884c\u3059\u308b\u3053\u3068\u306f\u3067\u304d\u307e\u305b\u3093\u3002\nAWS Lambda\u306e\u30b3\u30fc\u30c9\u90e8\u5206\u306a\u3089lambda-handler\u306a\u3069\u3092\u4f7f\u3048\u3070\u691c\u8a3c\u306f\u53ef\u80fd\u3067\u3059\u304c\u3001SAM\u90e8\u5206\u306e\u5b9a\u7fa9\u3084\u3001SAM\u3067\u4f5c\u6210\u3057\u305f\u30ea\u30bd\u30fc\u30b9\u3068\u306e\u7d61\u307f\u306e\u90e8\u5206\u3067\u306f\u30ed\u30fc\u30ab\u30eb\u3067\u78ba\u8a8d\u3059\u308b\u8853\u306f\u3042\u308a\u307e\u305b\u3093\uff08\u305b\u3044\u305c\u3044\u6587\u6cd5\u30c1\u30a7\u30c3\u30af\u3050\u3089\u3044\uff09\u3002\n\u305d\u3053\u3067\u3001\u958b\u767a\u7528\u3068\u672c\u756a\u7528\u3067\u540c\u3058\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092\u4f7f\u3044\u3064\u3064\u3001\u8907\u6570\u56de\u30c7\u30d7\u30ed\u30a4\u3067\u304d\u308b\u3088\u3046\u306b\u3057\u307e\u3059\u3002\n\u4eca\u56de\u306f\u3053\u306e\u4ed5\u7d44\u307f\u3092Node\u306enpm config\u3092\u4f7f\u3063\u3066\u5b9f\u73fe\u3057\u3066\u3044\u307e\u3059\u3002\nnpm config\u3067\u306fpackage.json\u306econfig\u306b\u5024\u3092\u66f8\u304f\u3068$npm_package_config_[keyname]\u3067\u53d6\u308a\u51fa\u3057\u304c\u53ef\u80fd\u306b\u306a\u308a\u3001npm config set [package name]:[keyname]\u3067config\u306e\u5024\u3092\u4e0a\u66f8\u304d\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\u305d\u306e\u7279\u6027\u3092\u4f7f\u3063\u3066package.json\u306econfig\u306b\u672c\u756a\u7528\u306e\u8a2d\u5b9a\u3092\u66f8\u304d\u3001\u672c\u756a\u74b0\u5883\u3078\u306e\u30c7\u30d7\u30ed\u30a4\u306f\u305d\u306e\u5024\u3092\u5229\u7528\u3057\u307e\u3059\u3002\n\u958b\u767a\u74b0\u5883\u3078\u306e\u30c7\u30d7\u30ed\u30a4\u306fnpm config set [package name]:[keyname]\u3067\u5024\u3092\u8a2d\u5b9a\u3059\u308b\u4ed5\u7d44\u307f\u3092\u4f5c\u3063\u3066\u3001\u672c\u756a\u7528\u306e\u30c7\u30d7\u30ed\u30a4\u8a2d\u5b9a\u3092\u4e0a\u66f8\u304d\u3057\u307e\u3059\u3002\n\npackage.json\n{\n  \"name\": \"EBA7CE416DD416B0E91442E9D5C72EF70B0111E365DF861D9A4B89BA7DAD1E3C\",\n  \"version\": \"0.0.0\",\n  \"private\": true,\n  \"author\": \"k-kinzal\",\n  \"description\": \"Example for AWS Lambda + SAM.\",\n  \"licenses\": \"MIT\",\n  \"engines\": {\n    \"node\": \"4.3.2\"\n  },\n  \"config\": {\n    \"resource_prefix\": \"\",\n    \"s3_bucket\": \"xxx\",\n    \"stack_name\": \"xxx\",\n    \"key_id\": \"xxxx-xxxx-xxxx-xxxx\",\n    \"iam_role_arn\": \"aws:arn:iam:xxx:role/xxx\"\n  },\n  \"scripts\": {\n    \"init:mkdir\": \"mkdirp .dist\",\n    \"init:prefix\": \"read -p \\\"Please input prefix of resources[]:\\\" p; npm config set ${npm_package_name}:resource_prefix \\\"${p}\\\"\",\n    \"init:bucket\": \"p=$(npm config get ${npm_package_name}:resource_prefix);read -p \\\"Please input bucket name[${p}eba7ce4]:\\\" s; npm config set ${npm_package_name}:s3_bucket \\\"${p}${s:-eba7ce4}\\\"\",\n    \"init:stack\": \"p=$(npm config get ${npm_package_name}:resource_prefix);read -p \\\"Please input stack name[${p}eba7ce4]:\\\" s; npm config set ${npm_package_name}:stack_name \\\"${p}${s:-eba7ce4}\\\"\",\n    \"init\": \"npm run init:mkdir && npm run init:prefix && npm run init:bucket && npm run init:stack\",\n    \"prepare:stack\": \"aws ${npm_config_profile:+--profile $npm_config_profile} ${npm_config_region:+--region $npm_config_region} cloudformation create-stack --stack-name ${npm_package_config_stack_name}-prepare --template-body file://resources.yml --parameters ParameterKey=BucketName,ParameterValue=${npm_package_config_s3_bucket} --capabilities CAPABILITY_IAM\",\n    \"prepare:wait\": \"aws ${npm_config_profile:+--profile $npm_config_profile} ${npm_config_region:+--region $npm_config_region} cloudformation wait stack-create-complete --stack-name ${npm_package_config_stack_name}-prepare\",\n    \"prepare:config:key-id\": \"npm config set ${npm_package_name}:key_id <<<EOS `aws ${npm_config_profile:+--profile $npm_config_profile} ${npm_config_region:+--region $npm_config_region} cloudformation describe-stacks --stack-name ${npm_package_config_stack_name}-prepare | jq -r '.Stacks[].Outputs | map(select(.OutputKey == \\\"KeyId\\\")) | .[].OutputValue'` EOS\",\n    \"prepare:config:iam-role-arn\": \"npm config set ${npm_package_name}:iam_role_arn <<<EOS `aws ${npm_config_profile:+--profile $npm_config_profile} ${npm_config_region:+--region $npm_config_region} cloudformation describe-stacks --stack-name ${npm_package_config_stack_name}-prepare | jq -r '.Stacks[].Outputs | map(select(.OutputKey == \\\"LambdaExectionRoleArn\\\")) | .[].OutputValue'` EOS\",\n    \"prepare\": \"npm run prepare:stack --profile=$npm_config_profile --region=$npm_config_region && npm run prepare:wait --profile=$npm_config_profile --region=$npm_config_region && npm run prepare:config:key-id --profile=$npm_config_profile --region=$npm_config_region && npm run prepare:config:iam-role-arn --profile=$npm_config_profile --region=$npm_config_region\",\n    \"encrypt\": \"aws ${npm_config_profile:+--profile $npm_config_profile} ${npm_config_region:+--region $npm_config_region} kms encrypt --key-id ${npm_package_config_key_id} --output text --query CiphertextBlob --plaintext\",\n    \"deploy:archive\": \"bestzip .dist/src.zip src/*\",\n    \"deploy:package\": \"aws ${npm_config_profile:+--profile $npm_config_profile} ${npm_config_region:+--region $npm_config_region} cloudformation package --template-file template.yml --output-template-file .dist/template.yml --s3-bucket ${npm_package_config_s3_bucket}\",\n    \"deploy:lambda\": \"aws ${npm_config_profile:+--profile $npm_config_profile} ${npm_config_region:+--region $npm_config_region} cloudformation deploy --template-file .dist/template.yml --stack-name ${npm_package_config_stack_name} --capabilities CAPABILITY_IAM --parameter-overrides LambdaExectionRoleArn=${npm_package_config_iam_role_arn}\",\n    \"deploy\": \"npm run deploy:archive && npm run deploy:package --profile=$npm_config_profile --region=$npm_config_region && npm run deploy:lambda --profile=$npm_config_profile --region=$npm_config_region\",\n    \"destroy\": \"aws ${npm_config_profile:+--profile $npm_config_profile} ${npm_config_region:+--region $npm_config_region} cloudformation delete-stack --stack-name ${npm_package_config_stack_name}\",\n    \"prepare-destroy:s3-objects\": \"aws s3 ${npm_config_profile:+--profile $npm_config_profile} ${npm_config_region:+--region $npm_config_region} rm s3://${npm_package_config_s3_bucket} --recursive\",\n    \"prepare-destroy:stack\": \"aws ${npm_config_profile:+--profile $npm_config_profile} ${npm_config_region:+--region $npm_config_region} cloudformation delete-stack --stack-name ${npm_package_config_stack_name}-prepare\",\n    \"prepare-destroy:config:iam-role-arn\": \"npm config delete ${npm_package_name}:iam_role_arn\",\n    \"prepare-destroy:config:key-id\": \"npm config delete ${npm_package_name}:key_id\",\n    \"prepare-destroy\": \"npm run prepare-destroy:s3-objects --profile=$npm_config_profile --region=$npm_config_region && npm run prepare-destroy:stack --profile=$npm_config_profile --region=$npm_config_region && npm run prepare-destroy:config:iam-role-arn && npm run prepare-destroy:config:key-id\",\n    \"clean:stack\": \"npm config delete ${npm_package_name}:resource_prefix\",\n    \"clean:bucket\": \"npm config delete ${npm_package_name}:s3_bucket\",\n    \"clean:prefix\": \"npm config delete ${npm_package_name}:stack_name\",\n    \"clean:dir\": \"rimraf .dist\",\n    \"clean\": \"npm run clean:stack && npm run clean:bucket && npm run clean:prefix && npm run clean:dir\"\n  },\n  \"dependencies\": {},\n  \"devDependencies\": {\n    \"bestzip\": \"^1.1.3\",\n    \"mkdirp\": \"^0.5.1\",\n    \"rimraf\": \"^2.5.4\"\n  }\n}\n\n\n\u305d\u3046\u3057\u3066\u51fa\u6765\u305fpackage.json\u306f\u3053\u3061\u3089\u3067\u3059\uff08\u4eba\u9593\u306e\u8aad\u3080\u3082\u306e\u3058\u3083\u306a\u3044\u30fb\u30fb\u30fb\uff09\u3002\n\u7c21\u5358\u306b\u8aac\u660e\u3059\u308b\u3068\n\n\nnpm run init\uff08\u958b\u767a\u7528\uff09\n\n\ninit\u3092\u4f7f\u3063\u3066S3\u30d0\u30b1\u30c3\u30c8\u540d\u3084\u4f5c\u6210\u3059\u308b\u30b9\u30bf\u30c3\u30af\u540d\u3092config\u306b\u8a2d\u5b9a\u3057\u307e\u3059\n\n\n\nnpm run prepare\uff08\u958b\u767a\u7528\uff09\n\n\nprepare\u3092\u4f7f\u3063\u3066\u4e8b\u524d\u306b\u4f5c\u6210\u3059\u308b\u5fc5\u8981\u306e\u3042\u308b\u30ea\u30bd\u30fc\u30b9\u3092\u4f5c\u6210\u3057\u3001\u305d\u306eID\u3084ARN\u3092config\u306b\u8a2d\u5b9a\u3057\u307e\u3059\n\n\n\nnpm run deploy\uff08\u958b\u767a/\u672c\u756a\u7528\uff09\n\n\n\npackage.json\u306econfig\u3084init\u3001prepare\u3067\u8a2d\u5b9a\u3057\u305f\u5024\u3092\u4f7f\u3063\u3066Lambda\u3092\u30c7\u30d7\u30ed\u30a4\u3057\u307e\u3059\n\n\n\nclean\u3001prepare-destroy\u3001destroy\u306f\u305d\u308c\u305e\u308c\u306e\u524a\u9664\u7528\u306e\u30bf\u30b9\u30af\u3067\u3059\u3002\nencrypt\u306fnpm run encrypt 'secret key'\u3068\u3059\u308b\u3053\u3068\u3067\u6697\u53f7\u5316\u3055\u308c\u305f\u6587\u5b57\u5217\u3092\u53d6\u5f97\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\nSAM\u3092\u4f7f\u3063\u305f\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u958b\u767a\u30d5\u30ed\u30fc\n\u30c7\u30d7\u30ed\u30a4\u30d5\u30ed\u30fc\u3092\u4f5c\u3063\u305f\u3053\u3068\u3067\u958b\u767a\u4e2d\u3067\u3082\u30c7\u30d7\u30ed\u30a4\u3057\u3066\u691c\u8a3c\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3057\u305f\u3002\n\u3057\u304b\u3057\u3001\u30c7\u30d7\u30ed\u30a4\u3059\u308b\u306e\u306b\u305d\u3053\u305d\u3053\u306e\u6642\u9593\u304c\u304b\u304b\u308b\u305f\u3081\u3001\u3042\u307e\u308a\u9ad8\u901f\u306b\u691c\u8a3c\u306e\u30b5\u30a4\u30af\u30eb\u3092\u56de\u3059\u3053\u3068\u304c\u3067\u304d\u307e\u305b\u3093\u3002\n\u305d\u3053\u3067\u3001\u30ed\u30fc\u30ab\u30eb\u3067\u9ad8\u901f\u306b\u691c\u8a3c\u30b5\u30a4\u30af\u30eb\u3092\u56de\u3057\u3001\u30b3\u30fc\u30c9\u30ec\u30d9\u30eb\u3067\u306e\u30df\u30b9\u306f\u30c7\u30d7\u30ed\u30a4\u524d\u306b\u767a\u898b\u3067\u304d\u308b\u3088\u3046\u306b\u3057\u307e\u3059\u3002\n\nESLint\u3067\u6587\u6cd5\u30c1\u30a7\u30c3\u30af\nAWS Lambda\u3067\u306f2016/12\u73fe\u5728\u3067\u306fv4.3.2\u304c\u52d5\u3044\u3066\u3044\u307e\u3059\u3002\n\u3057\u304b\u3057\u3001Node\u306e\u6700\u65b0\u306fv6.9.1\u3067\u30014\u7cfb\u3067\u306f\u4f7f\u3048\u306a\u3044\u69cb\u6587\u304c\u3044\u304f\u3064\u3082\u5b58\u5728\u3057\u307e\u3059\u3002\n\u57fa\u672c\u7684\u306b\u306f\u30ed\u30fc\u30ab\u30eb\u306eNode\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u3082n\u306a\u3069\u3092\u4f7f\u3063\u30664\u7cfb\u3067\u63c3\u3048\u308b\u3079\u304d\u3067\u3059\u304c\u3001\u4ed6\u306bNode\u306e\u958b\u767a\u3092\u884c\u3063\u3066\u3044\u308b\u3068\u3046\u3063\u304b\u308a6\u7cfb\u306e\u307e\u307e\u30c6\u30b9\u30c8\u304c\u52d5\u3044\u3066\u3057\u307e\u3046\u3068\u3044\u3046\u3053\u3068\u304c\u3042\u308a\u307e\u3059\u3002\n\u305d\u3053\u3067\u3001eslint\u3068eslint-plugin-node\u3092\u4f7f\u3063\u30664\u7cfb\u306e\u69cb\u6587\u306e\u307f\u3092\u4f7f\u3048\u308b\u3088\u3046\u306b\u3057\u307e\u3059\u3002\n$ npm install --save-dev eslint eslint-plugin-node\n\n\neslintrc.yml\nenv:\n  node: true\nplugins:\n  - node\nextends:\n  - eslint:recommended\n  - plugin:node/recommended\nrules:\n  node/no-unsupported-features: [error, {version: 4}]\n  no-console: 0\n\n\n\npackage.json\n{\n\n  ...\n\n  \"engines\": {\n    \"node\": \"4.3.2\"\n  },\n  \"scripts\": {\n\n    ...\n\n    \"lint\": \"eslint src/\"\n  }\n\n  ...\n\n}\n\n\n\u3053\u3046\u3059\u308b\u3053\u3068\u3067npm run lint\u3092\u5b9f\u884c\u3059\u308b\u3068v6\u7cfb\u306e\u69cb\u6587\u3092\u4f7f\u3063\u305f\u5834\u5408\u306b\u30a8\u30e9\u30fc\u3092\u51fa\u3059\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\nmodule.exports = (a = 1) => {\n  console.log(a);\n}\n\n$ npm run lint\n\n> EBA7CE416DD416B0E91442E9D5C72EF70B0111E365DF861D9A4B89BA7DAD1E3C@0.0.0 lint /Users/Kinzal/Dropbox/Projects/EBA7CE416DD416B0E91442E9D5C72EF70B0111E365DF861D9A4B89BA7DAD1E3C.xyz\n> eslint src/\n\n\n/Users/Kinzal/Dropbox/Projects/EBA7CE416DD416B0E91442E9D5C72EF70B0111E365DF861D9A4B89BA7DAD1E3C.xyz/src/index.js\n  3:19  error  Default Parameters are not supported yet on Node v4  node/no-unsupported-features\n\n\u2716 1 problem (1 error, 0 warnings)\n\n\nFlowtype\u3067\u578b\u30c1\u30a7\u30c3\u30af\n\u5148\u306b\u3082\u66f8\u3044\u305f\u901a\u308aSAM\u3067\u306f\u30ed\u30fc\u30ab\u30eb\u3067\u5b9f\u884c\u304c\u3067\u304d\u306a\u3044\u305f\u3081\u3001\u3044\u304b\u306b\u30ed\u30fc\u30ab\u30eb\u3067\u66f8\u3044\u305f\u30b3\u30fc\u30c9\u3092\u30c1\u30a7\u30c3\u30af\u3059\u308b\u304b\u304c\u809d\u306b\u306a\u3063\u3066\u304d\u307e\u3059\u3002\n\u305d\u3053\u3067\u3001\u578b\u306e\u529b\u3092\u501f\u308a\u3066\u30b3\u30fc\u30c9\u3092\u9759\u7684\u578b\u30c1\u30a7\u30c3\u30af\u3059\u308b\u305f\u3081\u306bFlow\u3092\u4f7f\u3044\u307e\u3059\u3002\nNode\u3067\u306f\u578b\u3092\u4f7f\u3046\u306e\u306b\u4ed6\u306b\u3082AltJS\u3067TypeScript\u3084\u3001Scala.js\u304c\u3042\u308a\u307e\u3059\u304c\u3001\u306a\u305cFlow\u3092\u63a1\u7528\u3059\u308b\u304b\u3068\u3044\u3046\u3068Flow Comment\u3068\u3044\u3046\u30c8\u30e9\u30f3\u30b9\u30d1\u30a4\u30eb\u305b\u305a\u306b\u9759\u7684\u578b\u30c1\u30a7\u30c3\u30af\u3092\u884c\u3046\u6a5f\u80fd\u304c\u3042\u308b\u304b\u3089\u3067\u3059\u3002\n\u30c8\u30e9\u30f3\u30b9\u30d1\u30a4\u30eb\u3057\u306a\u3044\u3053\u3068\u306b\u3088\u3063\u3066\u3001\u30c7\u30d7\u30ed\u30a4\u3057\u305f\u30b3\u30fc\u30c9\u3092AWS\u306e\u30de\u30cd\u30b8\u30e1\u30f3\u30c8\u30b3\u30f3\u30bd\u30fc\u30eb\u4e0a\u304b\u3089\u4fee\u6b63\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\u305d\u3057\u3066\u3001\u305d\u306e\u4fee\u6b63\u3057\u305f\u30b3\u30fc\u30c9\u3092\u30ed\u30fc\u30ab\u30eb\u306b\u30b3\u30d4\u30fc&\u30da\u30fc\u30b9\u30c8\u3067\u6301\u3063\u3066\u304f\u308b\u3053\u3068\u3067\u3001\u30c7\u30d7\u30ed\u30a4\u983b\u5ea6\u3092\u4e0b\u3052\u30c7\u30d0\u30c3\u30b0\u3092\u5bb9\u6613\u306b\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\u3082\u3061\u308d\u3093\u30de\u30cd\u30b8\u30e1\u30f3\u30c8\u30b3\u30f3\u30bd\u30fc\u30eb\u3067\u4fee\u6b63\u3067\u304d\u308b\u3068\u3044\u3046\u3053\u3068\u306f\u30ed\u30fc\u30ab\u30eb\u3068\u5dee\u5206\u304c\u767a\u751f\u3057\u3084\u3059\u304f\u306a\u308b\u3068\u3044\u3046\u3053\u3068\u306a\u306e\u3067\u6ce8\u610f\u306f\u5fc5\u8981\u3067\u3059\u3002\n$ npm install --save-dev flow-bin eslint-plugin-flowtype\n\n\npackage.json\n{\n\n  ...\n\n  \"scripts\": {\n\n    ...\n\n    \"check\": \"flow check\"\n  }\n\n  ...\n\n}\n\n\n\u3053\u3046\u3059\u308b\u3053\u3068\u3067npm run check\u3068\u3059\u308b\u3068\u9759\u7684\u578b\u30c1\u30a7\u30c3\u30af\u3092\u884c\u3048\u307e\u3059\u3002\n/* @flow */\n'use strict';\n\n/*::\ntype LambdaEvent = {\n  key1?: ?string;\n  key2?: ?string;\n  key3?: ?string;\n};\ntype LambdaContext = {\n\n};\ntype LambdaCallback = (error: ?Error, result: ?Object) => void;\n*/\n\nexports.handler = (event/*: LambdaEvent */, context/*: LambdaContext */, callback/*: LambdaCallback */) => {\n  callback(null, 'success'); //-> Error\n};\n\n\u904e\u53bb\u306b\u66f8\u3044\u305f\u8a18\u4e8b\u3067\u3059\u304c Flowtype+Atom+Nuclide\u3067\u5b89\u5168\u306bEvent\u3092\u6271\u3046 \u306b\u3042\u308b\u3088\u3046\u306bAtom\u4e0a\u3067\u30b3\u30fc\u30c9\u88dc\u5b8c\u3084\u3001\u30a8\u30e9\u30fc\u30c1\u30a7\u30c3\u30af\u3092\u884c\u3046\u65b9\u6cd5\u3082\u3042\u308a\u307e\u3059\u3002\n\u958b\u767a\u4e2d\u306fAtom\u3092\u4f7f\u3063\u3066\u30c1\u30a7\u30c3\u30af\u3057\u3001CI\u4e0a\u3067\u306fnpm run check\u3092\u4f7f\u3063\u3066\u30c1\u30a7\u30c3\u30af\u3059\u308b\u3088\u3046\u306b\u4f7f\u3044\u5206\u3051\u308b\u3068\u958b\u767a\u3092\u9ad8\u901f\u5316\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\n\u30e6\u30cb\u30c3\u30c8\u30c6\u30b9\u30c8\u3067\u30ed\u30b8\u30c3\u30af\u30c1\u30a7\u30c3\u30af\nlint\u3068\u9759\u7684\u578b\u30c1\u30a7\u30c3\u30af\u3067\u3042\u308b\u7a0b\u5ea6\u30b3\u30fc\u30c9\u306e\u54c1\u8cea\u3092\u62c5\u4fdd\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u304c\u3001\u3084\u306f\u308a\u632f\u308b\u821e\u3044\u3092\u4e00\u5ea6\u898b\u3066\u304a\u304d\u305f\u3044\u3068\u3053\u308d\u3067\u3059\u3002\n\u3068\u3001\u8a00\u3044\u305f\u3044\u306e\u3067\u3059\u304c\u3001SAM\u3067\u5b9a\u7fa9\u3057\u305fKMS\u3067\u6697\u53f7\u5316\u6e08\u307f\u306e\u74b0\u5883\u5909\u6570\u3092\u3069\u3046\u3059\u308b\u304b\u3068\u3044\u3046\u60a9\u307e\u3057\u3044\u554f\u984c\u304c\u3042\u308a\u307e\u3059\u3002\nAWS Lambda\u306eEnvironment Variable\u3067\u8868\u793a\u3055\u308c\u308bSnippet\u3067\u306f\nconst AWS = require('aws-sdk');\n\nconst encrypted = process.env['TEST'];\nlet decrypted;\n\n\nfunction processEvent(event, context, callback) {\n    // TODO handle the event here\n}\n\nexports.handler = (event, context, callback) => {\n    if (decrypted) {\n        processEvent(event, context, callback);\n    } else {\n        // Decrypt code should run once and variables stored outside of the function\n        // handler so that these are decrypted once per container\n        const kms = new AWS.KMS();\n        kms.decrypt({ CiphertextBlob: new Buffer(encrypted, 'base64') }, (err, data) => {\n            if (err) {\n                console.log('Decrypt error:', err);\n                return callback(err);\n            }\n            decrypted = data.Plaintext.toString('ascii');\n            processEvent(event, context, callback);\n        });\n    }\n};\n\n\u3068\u3044\u3046\u5f62\u3067\u3001handler\u306e\u5b9f\u884c\u56de\u6570\u306b\u3088\u3063\u3066\u6319\u52d5\u304c\u5909\u308f\u308a\u307e\u3059\u3002\n\u6697\u53f7\u5316\u3057\u305f\u74b0\u5883\u5909\u6570\u304c\u4e00\u3064\u306a\u3089\u307e\u3060\u306a\u3093\u3068\u304b\u30c6\u30b9\u30c8\u3092\u66f8\u3051\u306a\u304f\u306f\u306a\u3044\u3067\u3059\u304c\u3001\u4e8c\u3064\u3001\u4e09\u3064\u3068\u5897\u3048\u3066\u3044\u304f\u306b\u5f93\u3044\u8907\u96d1\u306b\u306a\u308b\u305f\u3081\u3001\u30c6\u30b9\u30c8\u3092\u66f8\u304f\u306e\u304c\u9762\u5012\u306b\u306a\u3063\u3066\u304d\u307e\u3059\u3002\n\u306a\u3093\u3067\u5b9f\u884c\u6642\u306b\u5fa9\u53f7\u3057\u3066\u304f\u308c\u306a\u304b\u3063\u305f\u3093\u3060\u2026\u3068\u3044\u3046\u611f\u3058\u3067\u3059\u306d\u3002\n\u3082\u3057\u3001\u6697\u53f7\u5316\u3055\u308c\u305f\u74b0\u5883\u5909\u6570\u3092\u4f7f\u3063\u3066\u3044\u306a\u3044\u5834\u5408\u306f\u3001\u30c6\u30b9\u30c8\u306e\u3055\u3044\u306bSAM\u306eYAML\u3092\u8aad\u307f\u8fbc\u3093\u3067process.env\u306b\u5dee\u3057\u8fbc\u3081\u3070\u4e0a\u624b\u304f\u30c6\u30b9\u30c8\u304c\u3067\u304d\u307e\u3059\u3002\n\u307e\u305f\u3001\u30c6\u30b9\u30c8\u306e\u3055\u3044\u306bhandler\u306e\u547c\u3073\u51fa\u3059\u306b\u306flambda-handler\u3092\u3001AWS SDK\u306e\u51e6\u7406\u3092\u30e2\u30c3\u30af\u5316\u3057\u305f\u3044\u306a\u3089fakemock\u3092\u4f7f\u3048\u3070\u7c21\u5358\u306b\u30e6\u30cb\u30c3\u30c8\u30c6\u30b9\u30c8\u3092\u4f5c\u308c\u308b\u307e\u3059\u3002\n\uff08\u6700\u8fd1\u3001lambda-handler\u3068fakemock\u3092\u66f4\u65b0\u3057\u3066\u306a\u3044\u306e\u3067\u65b0\u3057\u3044API\u306f\u52d5\u304b\u306a\u3044\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u3002PR\u304a\u5f85\u3061\u3057\u3066\u304a\u308a\u307e\u3059\uff09\n\u3053\u306e\u3042\u305f\u308a\u306e\u30e6\u30cb\u30c3\u30c8\u30c6\u30b9\u30c8\u90e8\u5206\u306f\u3001\u307e\u3060\u3044\u308d\u3044\u308d\u3068\u691c\u8a0e\u6bb5\u968e\u306a\u3068\u3053\u308d\u304c\u3042\u308b\u306e\u3067\u3082\u3046\u5c11\u3057\u716e\u8a70\u3081\u305f\u3089\u65b0\u3057\u304f\u8a18\u4e8b\u3092\u66f8\u3053\u3046\u3068\u601d\u3044\u307e\u3059\u3002\n\n\u304a\u308f\u308a\u306b\n\u3044\u304b\u304c\u3067\u3057\u305f\u3067\u3057\u3087\u3046\u304b\u3002Node\u5bc4\u308a\u306e\u69cb\u6210\u306e\u8a71\u306b\u306f\u306a\u3063\u3066\u3057\u307e\u3044\u307e\u3057\u305f\u304c\u3001\u8981\u70b9\u3055\u3048\u62bc\u3055\u3048\u308c\u3070\u4ed6\u8a00\u8a9e\u3067\u3082\u540c\u69d8\u306b\u958b\u767a\u30b5\u30a4\u30af\u30eb\u3092\u56de\u305b\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\n\u4eca\u56de\u3001\u4f7f\u7528\u3057\u305f\u30b3\u30fc\u30c9\u306f\u3053\u3061\u3089\u306b\u306a\u308a\u307e\u3059\u306e\u3067\u3001AWS Lambda\u306e\u958b\u767a\u306e\u8db3\u3057\u306b\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\nhttps://github.com/k-kinzal/EBA7CE416DD416B0E91442E9D5C72EF70B0111E365DF861D9A4B89BA7DAD1E3C\n\n\u3061\u3087\u3046\u3069\u3053\u306e\u30ea\u30dd\u30b8\u30c8\u30ea\u3067AWS Lambda\u3092\u4f7f\u3063\u305f\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3092\u69cb\u7bc9\u4e2d\u306a\u306e\u3067\u3001\u6700\u7d42\u7684\u306b\u3069\u306e\u3088\u3046\u306a\u69cb\u6210\u306b\u306a\u308b\u304b\u306f\u9069\u5f53\u306b\u30a6\u30a9\u30c3\u30c1\u3057\u3066\u3044\u305f\u3060\u304f\u3068\u826f\u3044\u3067\u3059\u3002\n\u4eca\u56de\u306e\u8a18\u4e8b\u3067\u306f\u716e\u8a70\u3081\u304d\u308c\u306a\u304b\u3063\u305f\u3068\u3053\u308d\u3092\u8a70\u3081\u3066\u3044\u304f\u306e\u3067\u4f55\u304b\u3057\u3089\u53c2\u8003\u306b\u306a\u308b\u3082\u306e\u306b\u306a\u308b\u3068\u601d\u3044\u307e\u3059\u3002\n\u3053\u306e\u6295\u7a3f\u306f[Serverless(2)\u30a2\u30c9\u30d9\u30f3\u30c8\u30ab\u30ec\u30f3\u30c0\u30fc](http://qiita.com/advent-calendar/2016/serverless2)\u306e8\u65e5\u76ee\u306e\u8a18\u4e8b\u3067\u3059\u3002\n\n\u53bb\u5e74\u306b [AWS Lambda\u306e\u30c7\u30d7\u30ed\u30a4\u30d5\u30ed\u30fc\u7ba1\u7406](http://qiita.com/kinzal/items/046a848a9f0829f87670) \u3068\u3044\u3046\u8a18\u4e8b\u3092\u66f8\u304d\u307e\u3057\u305f\u304c\u3001\u3042\u308c\u304b\u3089\u306e\u4e00\u5e74\u3067AWS Lambda\u306e\u72b6\u6cc1\u304c\u3044\u308d\u3044\u308d\u5909\u308f\u308a\u307e\u3057\u305f\u3002\n\u5f85\u671b\u306e\u74b0\u5883\u5909\u6570\u5bfe\u5fdc\u3084\u3001Step Function\u306b\u3088\u308bAWS Lambda\u306e\u30d0\u30c3\u30c1\u5316\u3001Serverless Application Model\u3068\u3044\u3046AWS\u516c\u5f0f\u306e\u30c7\u30d7\u30ed\u30a4\u30c4\u30fc\u30eb\u3001Serverless\u3084Apex\u3001Lamvery\u306a\u3069\u306eLambda\u95a2\u9023\u306e\u30d5\u30ec\u30fc\u30e0\u30ef\u30fc\u30af\u306e\u5145\u5b9f\u306a\u3069\u3001\u4e00\u5e74\u524d\u306b\u6bd4\u3079AWS Lambda\u304c\u4fbf\u5229\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002\n\n\u305d\u3093\u306a\u72b6\u6cc1\u306e\u4e2d\u30011\u5e74\u524d\u306e\u8a18\u4e8b\u306e\u30d3\u30e5\u30fc\u3001\u30b9\u30c8\u30c3\u30af\u6570\u304c\u5897\u3048\u3066\u884c\u304f\u306e\u306f\u7533\u3057\u8a33\u306a\u3044\u3002\u3068\u3044\u3046\u3053\u3068\u30672016\u5e74\u7248\u3068\u3044\u3046\u5f62\u3067\u3001\u65b0\u3057\u3044\u958b\u767a\u30d5\u30ed\u30fc\u306e\u8a71\u3092\u3057\u3088\u3046\u3068\u601d\u3044\u307e\u3059\u3002\n\n# Serverless Application Model\n\nSAM\u306fAWS\u304c\u65b0\u3057\u304f\u51fa\u3057\u305fAWS Lambda\u306e\u30c7\u30d7\u30ed\u30a4\u30c4\u30fc\u30eb\u3067\u3059\u3002\n\n* https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md\n\n\u6a5f\u80fd\u3068\u3057\u3066\u306fCloudFormation\u306e\u30e9\u30c3\u30d1\u30fc\u3067\u3001\u30ed\u30fc\u30ab\u30eb\u2192S3\u306b\u30b3\u30fc\u30c9\u3092\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u3057\u3001CloudFormation\u3067Lambda Function\u3084\u4ed6\u30ea\u30bd\u30fc\u30b9\u306e\u4f5c\u6210\u3092\u884c\u3046\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\n```\nAWSTemplateFormatVersion: '2010-09-09'\nTransform: 'AWS::Serverless-2016-10-31'\nDescription: A starter AWS Lambda function.\nParameters:\n  LambdaExectionRoleArn:\n    Type: String\n    Description: Role Arn of Lambda execution\nResources:\n  MyFunction:\n    Type: 'AWS::Serverless::Function'\n    Properties:\n      Handler: src/index.handler\n      Runtime: nodejs4.3\n      CodeUri: .\n      Description: A starter AWS Lambda function.\n      MemorySize: 1536\n      Timeout: 10\n      Role:\n        Ref: LambdaExectionRoleArn\n```\n\n```\n$ aws cloudformation package --template-file template.yml --output-template-file .dist/template.yml --s3-bucket bucket_name\n$ aws cloudformation deploy --template-file .dist/template.yml --stack-name stack1 --capabilities CAPABILITY_IAM\n```\n\n\u7af6\u5408\u30c4\u30fc\u30eb\u3068\u3057\u3066\u306f\u3068\u3057\u3066\u306fServerless\u3001Apex\u3001Lamvery\u306a\u3069\u304c\u3042\u308a\u307e\u3059\u3002\n\u79c1\u898b\u3067\u3059\u304c\u7528\u9014\u3068\u3057\u3066\u306f\n\n* API\u3092\u4f5c\u308a\u305f\u3044 \u2192 Serveless\n* \u8907\u6570\u306eAWS Lambda\u3092\u7ba1\u7406\u3057\u305f\u3044 \u2192 Apex\n* \u5358\u72ec\u306eAWS Lambda\u3092\u7ba1\u7406\u3057\u305f\u3044 \u2192 Lamvery\n\n\u3068\u3044\u3046\u3088\u3046\u306b\u30c4\u30fc\u30eb\u306b\u3088\u3063\u3066\u3069\u3046\u3044\u3063\u305f\u6642\u306b\u4f7f\u3046\u3068\u826f\u3044\u306e\u304b\u6700\u9069\u89e3\u304c\u5909\u308f\u3063\u3066\u3044\u308b\u5370\u8c61\u3067\u3059\u3002\n\nSAM\u3067\u306f\u3069\u306e\u7af6\u5408\u30c4\u30fc\u30eb\u3068\u3082\u540c\u69d8\u306e\u7528\u9014\u306e\u3053\u3068\u3092\u3067\u304d\u307e\u3059\u304c\u3001\u7279\u5316\u3057\u3066\u3044\u306a\u3044\u5206\u82e5\u5e72\u6a5f\u80fd\u304c\u8db3\u308a\u306a\u3044\u3068\u3053\u308d\u306f\u3042\u308a\u307e\u3059\u3002\n\u305d\u308c\u3067\u306fSAM\u3092\u9078\u3076\u30e1\u30ea\u30c3\u30c8\u306f\uff1f \u3068\u3044\u3046\u3068\n\n* AWS\u306e\u516c\u5f0f\u30c4\u30fc\u30eb\u3067\u3042\u308b\u3053\u3068\n* CloudFormation\u3068\u5909\u308f\u3089\u306a\u3044\u306e\u3067\u5b66\u7fd2\u30b3\u30b9\u30c8\u304c\u4f4e\u3044\n* \u3069\u306e\u30e9\u30f3\u30bf\u30a4\u30e0\u3001\u3069\u306e\u7528\u9014\u3067\u3082\u540c\u3058\u3088\u3046\u306b\u6271\u3048\u308b\n\n\u3068\u3044\u3046\u3068\u3053\u308d\u3067\u3057\u3087\u3046\u304b\u3002\n\u9006\u306b\u30c7\u30e1\u30ea\u30c3\u30c8\u3092\u4e0a\u3052\u308b\u306a\u3089CloudFormation\u3068\u3044\u3046\u3053\u3068\u3067\u4e2d\u301c\u5927\u898f\u6a21\u306b\u306a\u308b\u3068\u8f9b\u307f\u3057\u304b\u611f\u3058\u306a\u304f\u306a\u308a\u307e\u3059\u3002\u305d\u3053\u3060\u3051\u306f\u6ce8\u610f\u304c\u5fc5\u8981\u3067\u3059\u3002\n\uff08\u3082\u3057\u3001CloudFormation\u3092\u89aa\u306e\u4ec7\u306e\u3088\u3046\u306b\u618e\u3093\u3067\u308b\u4eba\u304c\u3044\u305f\u3089\u6b62\u3081\u305f\u65b9\u304c\u826f\u3044\u3067\u3059\uff09\n\n# SAM\u3092\u4f7f\u3063\u305f\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u30c7\u30d7\u30ed\u30a4\u30d5\u30ed\u30fc\n\nSAM\u3067\u30c7\u30d7\u30ed\u30a4\u30d5\u30ed\u30fc\u3092\u4f5c\u308b\u3042\u305f\u3063\u3066\u6ce8\u610f\u3059\u3079\u304d\u70b9\u304c2\u70b9\u3042\u308a\u307e\u3059\u3002\n\n1. AWS Lambda\u306e\u30c7\u30d7\u30ed\u30a4\u306b\u5fc5\u8981\u306a\u30ea\u30bd\u30fc\u30b9\u306e\u4f5c\u6210\u3001AWS Lambda\u306e\u30c7\u30d7\u30ed\u30a4\u306e2\u56de\u5b9f\u884c\u304c\u5fc5\u8981\n2. \u30ed\u30fc\u30ab\u30eb\u5b9f\u884c\u304c\u3067\u304d\u306a\u3044\uff08\u7279\u306bSAM\u90e8\u5206\u306e\u30c6\u30b9\u30c8\u306f\u3067\u304d\u306a\u3044\uff09\u306e\u3067\u958b\u767a/\u672c\u756a\u306e2\u3064\u306e\u74b0\u5883\u3078\u30c7\u30d7\u30ed\u30a4\u3059\u308b\u4ed5\u7d44\u307f\u304c\u5fc5\u8981\n\n\u305d\u308c\u305e\u308c\u306b\u3064\u3044\u3066\u89e3\u8aac\u3057\u3066\u3044\u304d\u307e\u3059\u3002\n\n## 1. AWS Lambda\u306e\u30c7\u30d7\u30ed\u30a4\u306b\u5fc5\u8981\u306a\u30ea\u30bd\u30fc\u30b9\u306e\u4f5c\u6210\u3001AWS Lambda\u306e\u30c7\u30d7\u30ed\u30a4\u306e2\u56de\u306e\u30c7\u30d7\u30ed\u30a4\u304c\u5fc5\u8981\n\nSAM\u3067AWS Lambda\u306e\u30c7\u30d7\u30ed\u30a4\u3092\u884c\u3046\u5834\u5408\u3001\u4e8b\u524d\u306b\u3044\u304f\u3064\u304b\u30ea\u30bd\u30fc\u30b9\u3092\u4f5c\u3063\u3066\u304a\u304f\u3079\u304d\u3082\u306e\u304c\u3042\u308a\u307e\u3059\u3002\n\n* S3\u30d0\u30b1\u30c3\u30c8\n    * ZIP\u5727\u7e2e\u3057\u305fAWS Lambda\u306e\u30b3\u30fc\u30c9\u3092\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u3059\u308b\u305f\u3081\u306b\u5fc5\u8981\n* KMS Key\n    * \u74b0\u5883\u5909\u6570\u306b\u6697\u53f7\u5316\u3057\u305f\u30ad\u30fc\u3092\u8a2d\u5b9a\u3059\u308b\u305f\u3081\u306b\u5fc5\u8981\uff08\u5fc5\u9808\u3067\u306f\u306a\u3044\uff09\n* IAM Role\n    * AWS Lambda\u306eExecution Role\n    * \u4f5c\u6210\u30bf\u30a4\u30df\u30f3\u30b0\u3068\u3057\u3066\u306fAWS Lambda\u306e\u30c7\u30d7\u30ed\u30a4\u30bf\u30a4\u30df\u30f3\u30b0\u3067\u3082\u826f\u3044\u304c\u3001KMS Key\u3067\u8a31\u53ef\u304c\u5fc5\u8981\u306a\u306e\u3067KMS Key\u3068\u4e00\u7dd2\u306b\u4f5c\u308b\u5fc5\u8981\u304c\u3042\u308b\n\n\u4eca\u56de\u306fSAM\u306b\u5408\u308f\u305b\u3066CloudFormation\u3067\u5b9f\u884c\u3067\u304d\u308b\u3088\u3046\u306b\u30ea\u30bd\u30fc\u30b9\u3092\u5b9a\u7fa9\u3057\u307e\u3059\u3002\n\n```yaml:resources.yml\nAWSTemplateFormatVersion: \"2010-09-09\"\nParameters:\n  BucketName:\n    Type: String\n    Description: Bucket for uploading Lambda code\nResources:\n  Bucket:\n    Type: \"AWS::S3::Bucket\"\n    Properties:\n      BucketName:\n        Ref: BucketName\n    DeletionPolicy: \"Delete\"\n  LambdaExectionRole:\n    Type: \"AWS::IAM::Role\"\n    Properties:\n      AssumeRolePolicyDocument:\n        Version: \"2012-10-17\"\n        Statement:\n          -\n            Effect: \"Allow\"\n            Principal:\n              Service:\n                - \"lambda.amazonaws.com\"\n            Action:\n              - \"sts:AssumeRole\"\n      Path: \"/\"\n      Policies:\n        -\n          PolicyName: \"root\"\n          PolicyDocument:\n            Version: \"2012-10-17\"\n            Statement:\n              -\n                Effect: \"Allow\"\n                Action:\n                  - \"logs:CreateLogGroup\"\n                  - \"logs:CreateLogStream\"\n                  - \"logs:PutLogEvents\"\n                Resource: \"arn:aws:logs:*:*:*\"\n              -\n                Effect: \"Allow\"\n                Action:\n                  - \"kms:Decrypt\"\n                Resource: \"*\"\n  LambdaExectionInstanceProfile:\n    Type: \"AWS::IAM::InstanceProfile\"\n    Properties:\n      Path: \"/\"\n      Roles:\n        -\n          Ref: \"LambdaExectionRole\"\n  Key:\n    Type: \"AWS::KMS::Key\"\n    Properties:\n      Description: \"Key used for Lambda environment variables\"\n      KeyPolicy:\n        Version: \"2012-10-17\"\n        Statement:\n          -\n            Sid: \"Allow administration of the key\"\n            Effect: \"Allow\"\n            Principal:\n              AWS:\n                \"Fn::Join\": [ \":\", [ \"arn:aws:sts:\", {\"Ref\" : \"AWS::AccountId\"}, \"root\" ] ]\n            Action:\n              - \"kms:*\"\n            Resource: \"*\"\n          -\n            Effect: \"Allow\"\n            Principal:\n              AWS:\n                - !GetAtt LambdaExectionRole.Arn\n            Action:\n              - \"kms:Decrypt\"\n            Resource: \"*\"\nOutputs:\n  KeyId:\n    Value: !Ref Key\n  LambdaExectionRoleArn:\n    Value: !GetAtt LambdaExectionRole.Arn\n```\n\n```\n$ aws  cloudformation create-stack --stack-name stack01-prepare --template-body file://resources.yml --parameters ParameterKey=BucketName,ParameterValue=bucket_name --capabilities CAPABILITY_IAM\n```\n\n\u3053\u3046\u3059\u308b\u3053\u3068\u3067\u3001\u4e8b\u524d\u306b\u5fc5\u8981\u306a\u30ea\u30bd\u30fc\u30b9\u3092\u4f5c\u6210\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\n\u3082\u3057\u3001\u4e8b\u524d\u306b\u4f5c\u6210\u6e08\u307f\u3067\u3042\u308c\u3070\u3053\u306e\u51e6\u7406\u306f\u5fc5\u8981\u3042\u308a\u307e\u305b\u3093\u3002\n\u3057\u304b\u3057\u3001\u958b\u767a\u8005\u304c\u958b\u767a\u4e2d\u306b\u30ea\u30bd\u30fc\u30b9\u3092\u5171\u6709\u3059\u308b\u3053\u3068\u306f\u30c7\u30e1\u30ea\u30c3\u30c8\u3082\u3042\u308b\u306e\u3067\u3001\u958b\u767a\u8005\u304c\u81ea\u7531\u306b\u30ea\u30bd\u30fc\u30b9\u306e\u4f5c\u6210/\u7834\u68c4\u3092\u884c\u3048\u308b\u3088\u3046\u306b\u5b9a\u7fa9\u3057\u3066\u304a\u304f\u3068\u4fbf\u5229\u3067\u3059\u3002\n\n\u307e\u305f\u3001`Parameter`\u3001`Outputs`\u306e\u5b9a\u7fa9\u306f\u6b21\u306e\u8a71\u306e\u517c\u306d\u5408\u3044\u5165\u51fa\u529b\u3092\u3067\u304d\u308b\u3088\u3046\u306b\u5b9a\u7fa9\u3057\u3066\u3042\u308a\u307e\u3059\u3002\n\n## 2. \u30ed\u30fc\u30ab\u30eb\u5b9f\u884c\u304c\u3067\u304d\u306a\u3044\u306e\u3067\u958b\u767a/\u672c\u756a\u306e2\u3064\u306e\u74b0\u5883\u3078\u30c7\u30d7\u30ed\u30a4\u3092\u3067\u304d\u308b\u4ed5\u7d44\u307f\u304c\u5fc5\u8981\n\nSAM\u3067\u306fServerless\u306e\u3088\u3046\u306b\u30ed\u30fc\u30ab\u30eb\u3067\u5b9f\u884c\u3059\u308b\u3053\u3068\u306f\u3067\u304d\u307e\u305b\u3093\u3002\nAWS Lambda\u306e\u30b3\u30fc\u30c9\u90e8\u5206\u306a\u3089[lambda-handler](https://github.com/k-kinzal/lambda-handler)\u306a\u3069\u3092\u4f7f\u3048\u3070\u691c\u8a3c\u306f\u53ef\u80fd\u3067\u3059\u304c\u3001SAM\u90e8\u5206\u306e\u5b9a\u7fa9\u3084\u3001SAM\u3067\u4f5c\u6210\u3057\u305f\u30ea\u30bd\u30fc\u30b9\u3068\u306e\u7d61\u307f\u306e\u90e8\u5206\u3067\u306f\u30ed\u30fc\u30ab\u30eb\u3067\u78ba\u8a8d\u3059\u308b\u8853\u306f\u3042\u308a\u307e\u305b\u3093\uff08\u305b\u3044\u305c\u3044\u6587\u6cd5\u30c1\u30a7\u30c3\u30af\u3050\u3089\u3044\uff09\u3002\n\u305d\u3053\u3067\u3001\u958b\u767a\u7528\u3068\u672c\u756a\u7528\u3067\u540c\u3058\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092\u4f7f\u3044\u3064\u3064\u3001\u8907\u6570\u56de\u30c7\u30d7\u30ed\u30a4\u3067\u304d\u308b\u3088\u3046\u306b\u3057\u307e\u3059\u3002\n\n\u4eca\u56de\u306f\u3053\u306e\u4ed5\u7d44\u307f\u3092Node\u306e[npm config](https://docs.npmjs.com/cli/config)\u3092\u4f7f\u3063\u3066\u5b9f\u73fe\u3057\u3066\u3044\u307e\u3059\u3002\n`npm config`\u3067\u306f`package.json`\u306e`config`\u306b\u5024\u3092\u66f8\u304f\u3068`$npm_package_config_[keyname]`\u3067\u53d6\u308a\u51fa\u3057\u304c\u53ef\u80fd\u306b\u306a\u308a\u3001`npm config set [package name]:[keyname]`\u3067`config`\u306e\u5024\u3092\u4e0a\u66f8\u304d\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\n\u305d\u306e\u7279\u6027\u3092\u4f7f\u3063\u3066`package.json`\u306e`config`\u306b\u672c\u756a\u7528\u306e\u8a2d\u5b9a\u3092\u66f8\u304d\u3001\u672c\u756a\u74b0\u5883\u3078\u306e\u30c7\u30d7\u30ed\u30a4\u306f\u305d\u306e\u5024\u3092\u5229\u7528\u3057\u307e\u3059\u3002\n\u958b\u767a\u74b0\u5883\u3078\u306e\u30c7\u30d7\u30ed\u30a4\u306f`npm config set [package name]:[keyname]`\u3067\u5024\u3092\u8a2d\u5b9a\u3059\u308b\u4ed5\u7d44\u307f\u3092\u4f5c\u3063\u3066\u3001\u672c\u756a\u7528\u306e\u30c7\u30d7\u30ed\u30a4\u8a2d\u5b9a\u3092\u4e0a\u66f8\u304d\u3057\u307e\u3059\u3002\n\n```json:package.json\n{\n  \"name\": \"EBA7CE416DD416B0E91442E9D5C72EF70B0111E365DF861D9A4B89BA7DAD1E3C\",\n  \"version\": \"0.0.0\",\n  \"private\": true,\n  \"author\": \"k-kinzal\",\n  \"description\": \"Example for AWS Lambda + SAM.\",\n  \"licenses\": \"MIT\",\n  \"engines\": {\n    \"node\": \"4.3.2\"\n  },\n  \"config\": {\n    \"resource_prefix\": \"\",\n    \"s3_bucket\": \"xxx\",\n    \"stack_name\": \"xxx\",\n    \"key_id\": \"xxxx-xxxx-xxxx-xxxx\",\n    \"iam_role_arn\": \"aws:arn:iam:xxx:role/xxx\"\n  },\n  \"scripts\": {\n    \"init:mkdir\": \"mkdirp .dist\",\n    \"init:prefix\": \"read -p \\\"Please input prefix of resources[]:\\\" p; npm config set ${npm_package_name}:resource_prefix \\\"${p}\\\"\",\n    \"init:bucket\": \"p=$(npm config get ${npm_package_name}:resource_prefix);read -p \\\"Please input bucket name[${p}eba7ce4]:\\\" s; npm config set ${npm_package_name}:s3_bucket \\\"${p}${s:-eba7ce4}\\\"\",\n    \"init:stack\": \"p=$(npm config get ${npm_package_name}:resource_prefix);read -p \\\"Please input stack name[${p}eba7ce4]:\\\" s; npm config set ${npm_package_name}:stack_name \\\"${p}${s:-eba7ce4}\\\"\",\n    \"init\": \"npm run init:mkdir && npm run init:prefix && npm run init:bucket && npm run init:stack\",\n    \"prepare:stack\": \"aws ${npm_config_profile:+--profile $npm_config_profile} ${npm_config_region:+--region $npm_config_region} cloudformation create-stack --stack-name ${npm_package_config_stack_name}-prepare --template-body file://resources.yml --parameters ParameterKey=BucketName,ParameterValue=${npm_package_config_s3_bucket} --capabilities CAPABILITY_IAM\",\n    \"prepare:wait\": \"aws ${npm_config_profile:+--profile $npm_config_profile} ${npm_config_region:+--region $npm_config_region} cloudformation wait stack-create-complete --stack-name ${npm_package_config_stack_name}-prepare\",\n    \"prepare:config:key-id\": \"npm config set ${npm_package_name}:key_id <<<EOS `aws ${npm_config_profile:+--profile $npm_config_profile} ${npm_config_region:+--region $npm_config_region} cloudformation describe-stacks --stack-name ${npm_package_config_stack_name}-prepare | jq -r '.Stacks[].Outputs | map(select(.OutputKey == \\\"KeyId\\\")) | .[].OutputValue'` EOS\",\n    \"prepare:config:iam-role-arn\": \"npm config set ${npm_package_name}:iam_role_arn <<<EOS `aws ${npm_config_profile:+--profile $npm_config_profile} ${npm_config_region:+--region $npm_config_region} cloudformation describe-stacks --stack-name ${npm_package_config_stack_name}-prepare | jq -r '.Stacks[].Outputs | map(select(.OutputKey == \\\"LambdaExectionRoleArn\\\")) | .[].OutputValue'` EOS\",\n    \"prepare\": \"npm run prepare:stack --profile=$npm_config_profile --region=$npm_config_region && npm run prepare:wait --profile=$npm_config_profile --region=$npm_config_region && npm run prepare:config:key-id --profile=$npm_config_profile --region=$npm_config_region && npm run prepare:config:iam-role-arn --profile=$npm_config_profile --region=$npm_config_region\",\n    \"encrypt\": \"aws ${npm_config_profile:+--profile $npm_config_profile} ${npm_config_region:+--region $npm_config_region} kms encrypt --key-id ${npm_package_config_key_id} --output text --query CiphertextBlob --plaintext\",\n    \"deploy:archive\": \"bestzip .dist/src.zip src/*\",\n    \"deploy:package\": \"aws ${npm_config_profile:+--profile $npm_config_profile} ${npm_config_region:+--region $npm_config_region} cloudformation package --template-file template.yml --output-template-file .dist/template.yml --s3-bucket ${npm_package_config_s3_bucket}\",\n    \"deploy:lambda\": \"aws ${npm_config_profile:+--profile $npm_config_profile} ${npm_config_region:+--region $npm_config_region} cloudformation deploy --template-file .dist/template.yml --stack-name ${npm_package_config_stack_name} --capabilities CAPABILITY_IAM --parameter-overrides LambdaExectionRoleArn=${npm_package_config_iam_role_arn}\",\n    \"deploy\": \"npm run deploy:archive && npm run deploy:package --profile=$npm_config_profile --region=$npm_config_region && npm run deploy:lambda --profile=$npm_config_profile --region=$npm_config_region\",\n    \"destroy\": \"aws ${npm_config_profile:+--profile $npm_config_profile} ${npm_config_region:+--region $npm_config_region} cloudformation delete-stack --stack-name ${npm_package_config_stack_name}\",\n    \"prepare-destroy:s3-objects\": \"aws s3 ${npm_config_profile:+--profile $npm_config_profile} ${npm_config_region:+--region $npm_config_region} rm s3://${npm_package_config_s3_bucket} --recursive\",\n    \"prepare-destroy:stack\": \"aws ${npm_config_profile:+--profile $npm_config_profile} ${npm_config_region:+--region $npm_config_region} cloudformation delete-stack --stack-name ${npm_package_config_stack_name}-prepare\",\n    \"prepare-destroy:config:iam-role-arn\": \"npm config delete ${npm_package_name}:iam_role_arn\",\n    \"prepare-destroy:config:key-id\": \"npm config delete ${npm_package_name}:key_id\",\n    \"prepare-destroy\": \"npm run prepare-destroy:s3-objects --profile=$npm_config_profile --region=$npm_config_region && npm run prepare-destroy:stack --profile=$npm_config_profile --region=$npm_config_region && npm run prepare-destroy:config:iam-role-arn && npm run prepare-destroy:config:key-id\",\n    \"clean:stack\": \"npm config delete ${npm_package_name}:resource_prefix\",\n    \"clean:bucket\": \"npm config delete ${npm_package_name}:s3_bucket\",\n    \"clean:prefix\": \"npm config delete ${npm_package_name}:stack_name\",\n    \"clean:dir\": \"rimraf .dist\",\n    \"clean\": \"npm run clean:stack && npm run clean:bucket && npm run clean:prefix && npm run clean:dir\"\n  },\n  \"dependencies\": {},\n  \"devDependencies\": {\n    \"bestzip\": \"^1.1.3\",\n    \"mkdirp\": \"^0.5.1\",\n    \"rimraf\": \"^2.5.4\"\n  }\n}\n```\n\n\u305d\u3046\u3057\u3066\u51fa\u6765\u305f`package.json`\u306f\u3053\u3061\u3089\u3067\u3059\uff08\u4eba\u9593\u306e\u8aad\u3080\u3082\u306e\u3058\u3083\u306a\u3044\u30fb\u30fb\u30fb\uff09\u3002\n\u7c21\u5358\u306b\u8aac\u660e\u3059\u308b\u3068\n\n* `npm run init`\uff08\u958b\u767a\u7528\uff09\n    * init\u3092\u4f7f\u3063\u3066S3\u30d0\u30b1\u30c3\u30c8\u540d\u3084\u4f5c\u6210\u3059\u308b\u30b9\u30bf\u30c3\u30af\u540d\u3092config\u306b\u8a2d\u5b9a\u3057\u307e\u3059\n* `npm run prepare`\uff08\u958b\u767a\u7528\uff09\n    * prepare\u3092\u4f7f\u3063\u3066\u4e8b\u524d\u306b\u4f5c\u6210\u3059\u308b\u5fc5\u8981\u306e\u3042\u308b\u30ea\u30bd\u30fc\u30b9\u3092\u4f5c\u6210\u3057\u3001\u305d\u306eID\u3084ARN\u3092config\u306b\u8a2d\u5b9a\u3057\u307e\u3059\n* `npm run deploy`\uff08\u958b\u767a/\u672c\u756a\u7528\uff09\n    * `package.json`\u306e`config`\u3084init\u3001prepare\u3067\u8a2d\u5b9a\u3057\u305f\u5024\u3092\u4f7f\u3063\u3066Lambda\u3092\u30c7\u30d7\u30ed\u30a4\u3057\u307e\u3059\n\n`clean`\u3001`prepare-destroy`\u3001`destroy`\u306f\u305d\u308c\u305e\u308c\u306e\u524a\u9664\u7528\u306e\u30bf\u30b9\u30af\u3067\u3059\u3002\n`encrypt`\u306f`npm run encrypt 'secret key'`\u3068\u3059\u308b\u3053\u3068\u3067\u6697\u53f7\u5316\u3055\u308c\u305f\u6587\u5b57\u5217\u3092\u53d6\u5f97\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\n# SAM\u3092\u4f7f\u3063\u305f\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u958b\u767a\u30d5\u30ed\u30fc\n\n\u30c7\u30d7\u30ed\u30a4\u30d5\u30ed\u30fc\u3092\u4f5c\u3063\u305f\u3053\u3068\u3067\u958b\u767a\u4e2d\u3067\u3082\u30c7\u30d7\u30ed\u30a4\u3057\u3066\u691c\u8a3c\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3057\u305f\u3002\n\u3057\u304b\u3057\u3001\u30c7\u30d7\u30ed\u30a4\u3059\u308b\u306e\u306b\u305d\u3053\u305d\u3053\u306e\u6642\u9593\u304c\u304b\u304b\u308b\u305f\u3081\u3001\u3042\u307e\u308a\u9ad8\u901f\u306b\u691c\u8a3c\u306e\u30b5\u30a4\u30af\u30eb\u3092\u56de\u3059\u3053\u3068\u304c\u3067\u304d\u307e\u305b\u3093\u3002\n\u305d\u3053\u3067\u3001\u30ed\u30fc\u30ab\u30eb\u3067\u9ad8\u901f\u306b\u691c\u8a3c\u30b5\u30a4\u30af\u30eb\u3092\u56de\u3057\u3001\u30b3\u30fc\u30c9\u30ec\u30d9\u30eb\u3067\u306e\u30df\u30b9\u306f\u30c7\u30d7\u30ed\u30a4\u524d\u306b\u767a\u898b\u3067\u304d\u308b\u3088\u3046\u306b\u3057\u307e\u3059\u3002\n\n## ESLint\u3067\u6587\u6cd5\u30c1\u30a7\u30c3\u30af\n\nAWS Lambda\u3067\u306f2016/12\u73fe\u5728\u3067\u306fv4.3.2\u304c\u52d5\u3044\u3066\u3044\u307e\u3059\u3002\n\u3057\u304b\u3057\u3001Node\u306e\u6700\u65b0\u306fv6.9.1\u3067\u30014\u7cfb\u3067\u306f\u4f7f\u3048\u306a\u3044\u69cb\u6587\u304c\u3044\u304f\u3064\u3082\u5b58\u5728\u3057\u307e\u3059\u3002\n\u57fa\u672c\u7684\u306b\u306f\u30ed\u30fc\u30ab\u30eb\u306eNode\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u3082[n](https://github.com/tj/n)\u306a\u3069\u3092\u4f7f\u3063\u30664\u7cfb\u3067\u63c3\u3048\u308b\u3079\u304d\u3067\u3059\u304c\u3001\u4ed6\u306bNode\u306e\u958b\u767a\u3092\u884c\u3063\u3066\u3044\u308b\u3068\u3046\u3063\u304b\u308a6\u7cfb\u306e\u307e\u307e\u30c6\u30b9\u30c8\u304c\u52d5\u3044\u3066\u3057\u307e\u3046\u3068\u3044\u3046\u3053\u3068\u304c\u3042\u308a\u307e\u3059\u3002\n\u305d\u3053\u3067\u3001[eslint](https://github.com/eslint/eslint)\u3068[eslint-plugin-node](https://github.com/mysticatea/eslint-plugin-node)\u3092\u4f7f\u3063\u30664\u7cfb\u306e\u69cb\u6587\u306e\u307f\u3092\u4f7f\u3048\u308b\u3088\u3046\u306b\u3057\u307e\u3059\u3002\n\n```\n$ npm install --save-dev eslint eslint-plugin-node\n```\n\n```yaml:eslintrc.yml\nenv:\n  node: true\nplugins:\n  - node\nextends:\n  - eslint:recommended\n  - plugin:node/recommended\nrules:\n  node/no-unsupported-features: [error, {version: 4}]\n  no-console: 0\n```\n\n```json:package.json\n{\n\n  ...\n\n  \"engines\": {\n    \"node\": \"4.3.2\"\n  },\n  \"scripts\": {\n\n    ...\n\n    \"lint\": \"eslint src/\"\n  }\n\n  ...\n\n}\n```\n\n\u3053\u3046\u3059\u308b\u3053\u3068\u3067`npm run lint`\u3092\u5b9f\u884c\u3059\u308b\u3068v6\u7cfb\u306e\u69cb\u6587\u3092\u4f7f\u3063\u305f\u5834\u5408\u306b\u30a8\u30e9\u30fc\u3092\u51fa\u3059\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\n```js\nmodule.exports = (a = 1) => {\n  console.log(a);\n}\n```\n\n```\n$ npm run lint\n\n> EBA7CE416DD416B0E91442E9D5C72EF70B0111E365DF861D9A4B89BA7DAD1E3C@0.0.0 lint /Users/Kinzal/Dropbox/Projects/EBA7CE416DD416B0E91442E9D5C72EF70B0111E365DF861D9A4B89BA7DAD1E3C.xyz\n> eslint src/\n\n\n/Users/Kinzal/Dropbox/Projects/EBA7CE416DD416B0E91442E9D5C72EF70B0111E365DF861D9A4B89BA7DAD1E3C.xyz/src/index.js\n  3:19  error  Default Parameters are not supported yet on Node v4  node/no-unsupported-features\n\n\u2716 1 problem (1 error, 0 warnings)\n```\n\n## Flowtype\u3067\u578b\u30c1\u30a7\u30c3\u30af\n\n\u5148\u306b\u3082\u66f8\u3044\u305f\u901a\u308aSAM\u3067\u306f\u30ed\u30fc\u30ab\u30eb\u3067\u5b9f\u884c\u304c\u3067\u304d\u306a\u3044\u305f\u3081\u3001\u3044\u304b\u306b\u30ed\u30fc\u30ab\u30eb\u3067\u66f8\u3044\u305f\u30b3\u30fc\u30c9\u3092\u30c1\u30a7\u30c3\u30af\u3059\u308b\u304b\u304c\u809d\u306b\u306a\u3063\u3066\u304d\u307e\u3059\u3002\n\u305d\u3053\u3067\u3001\u578b\u306e\u529b\u3092\u501f\u308a\u3066\u30b3\u30fc\u30c9\u3092\u9759\u7684\u578b\u30c1\u30a7\u30c3\u30af\u3059\u308b\u305f\u3081\u306b[Flow](https://flowtype.org/)\u3092\u4f7f\u3044\u307e\u3059\u3002\n\nNode\u3067\u306f\u578b\u3092\u4f7f\u3046\u306e\u306b\u4ed6\u306b\u3082AltJS\u3067TypeScript\u3084\u3001Scala.js\u304c\u3042\u308a\u307e\u3059\u304c\u3001\u306a\u305cFlow\u3092\u63a1\u7528\u3059\u308b\u304b\u3068\u3044\u3046\u3068[Flow Comment](https://flowtype.org/blog/2015/02/20/Flow-Comments.html)\u3068\u3044\u3046\u30c8\u30e9\u30f3\u30b9\u30d1\u30a4\u30eb\u305b\u305a\u306b\u9759\u7684\u578b\u30c1\u30a7\u30c3\u30af\u3092\u884c\u3046\u6a5f\u80fd\u304c\u3042\u308b\u304b\u3089\u3067\u3059\u3002\n\n\u30c8\u30e9\u30f3\u30b9\u30d1\u30a4\u30eb\u3057\u306a\u3044\u3053\u3068\u306b\u3088\u3063\u3066\u3001\u30c7\u30d7\u30ed\u30a4\u3057\u305f\u30b3\u30fc\u30c9\u3092AWS\u306e\u30de\u30cd\u30b8\u30e1\u30f3\u30c8\u30b3\u30f3\u30bd\u30fc\u30eb\u4e0a\u304b\u3089\u4fee\u6b63\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\u305d\u3057\u3066\u3001\u305d\u306e\u4fee\u6b63\u3057\u305f\u30b3\u30fc\u30c9\u3092\u30ed\u30fc\u30ab\u30eb\u306b\u30b3\u30d4\u30fc&\u30da\u30fc\u30b9\u30c8\u3067\u6301\u3063\u3066\u304f\u308b\u3053\u3068\u3067\u3001\u30c7\u30d7\u30ed\u30a4\u983b\u5ea6\u3092\u4e0b\u3052\u30c7\u30d0\u30c3\u30b0\u3092\u5bb9\u6613\u306b\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\u3082\u3061\u308d\u3093\u30de\u30cd\u30b8\u30e1\u30f3\u30c8\u30b3\u30f3\u30bd\u30fc\u30eb\u3067\u4fee\u6b63\u3067\u304d\u308b\u3068\u3044\u3046\u3053\u3068\u306f\u30ed\u30fc\u30ab\u30eb\u3068\u5dee\u5206\u304c\u767a\u751f\u3057\u3084\u3059\u304f\u306a\u308b\u3068\u3044\u3046\u3053\u3068\u306a\u306e\u3067\u6ce8\u610f\u306f\u5fc5\u8981\u3067\u3059\u3002\n\n```\n$ npm install --save-dev flow-bin eslint-plugin-flowtype\n```\n\n```json:package.json\n{\n\n  ...\n\n  \"scripts\": {\n\n    ...\n\n    \"check\": \"flow check\"\n  }\n\n  ...\n\n}\n```\n\n\u3053\u3046\u3059\u308b\u3053\u3068\u3067`npm run check`\u3068\u3059\u308b\u3068\u9759\u7684\u578b\u30c1\u30a7\u30c3\u30af\u3092\u884c\u3048\u307e\u3059\u3002\n\n```js\n/* @flow */\n'use strict';\n\n/*::\ntype LambdaEvent = {\n  key1?: ?string;\n  key2?: ?string;\n  key3?: ?string;\n};\ntype LambdaContext = {\n\n};\ntype LambdaCallback = (error: ?Error, result: ?Object) => void;\n*/\n\nexports.handler = (event/*: LambdaEvent */, context/*: LambdaContext */, callback/*: LambdaCallback */) => {\n  callback(null, 'success'); //-> Error\n};\n```\n\n\u904e\u53bb\u306b\u66f8\u3044\u305f\u8a18\u4e8b\u3067\u3059\u304c [Flowtype+Atom+Nuclide\u3067\u5b89\u5168\u306bEvent\u3092\u6271\u3046](http://qiita.com/kinzal/items/b652aaa18a1c012ad102) \u306b\u3042\u308b\u3088\u3046\u306bAtom\u4e0a\u3067\u30b3\u30fc\u30c9\u88dc\u5b8c\u3084\u3001\u30a8\u30e9\u30fc\u30c1\u30a7\u30c3\u30af\u3092\u884c\u3046\u65b9\u6cd5\u3082\u3042\u308a\u307e\u3059\u3002\n\u958b\u767a\u4e2d\u306fAtom\u3092\u4f7f\u3063\u3066\u30c1\u30a7\u30c3\u30af\u3057\u3001CI\u4e0a\u3067\u306f`npm run check`\u3092\u4f7f\u3063\u3066\u30c1\u30a7\u30c3\u30af\u3059\u308b\u3088\u3046\u306b\u4f7f\u3044\u5206\u3051\u308b\u3068\u958b\u767a\u3092\u9ad8\u901f\u5316\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\n## \u30e6\u30cb\u30c3\u30c8\u30c6\u30b9\u30c8\u3067\u30ed\u30b8\u30c3\u30af\u30c1\u30a7\u30c3\u30af\n\nlint\u3068\u9759\u7684\u578b\u30c1\u30a7\u30c3\u30af\u3067\u3042\u308b\u7a0b\u5ea6\u30b3\u30fc\u30c9\u306e\u54c1\u8cea\u3092\u62c5\u4fdd\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u304c\u3001\u3084\u306f\u308a\u632f\u308b\u821e\u3044\u3092\u4e00\u5ea6\u898b\u3066\u304a\u304d\u305f\u3044\u3068\u3053\u308d\u3067\u3059\u3002\n\u3068\u3001\u8a00\u3044\u305f\u3044\u306e\u3067\u3059\u304c\u3001SAM\u3067\u5b9a\u7fa9\u3057\u305fKMS\u3067\u6697\u53f7\u5316\u6e08\u307f\u306e\u74b0\u5883\u5909\u6570\u3092\u3069\u3046\u3059\u308b\u304b\u3068\u3044\u3046\u60a9\u307e\u3057\u3044\u554f\u984c\u304c\u3042\u308a\u307e\u3059\u3002\nAWS Lambda\u306eEnvironment Variable\u3067\u8868\u793a\u3055\u308c\u308bSnippet\u3067\u306f\n\n```js\nconst AWS = require('aws-sdk');\n\nconst encrypted = process.env['TEST'];\nlet decrypted;\n\n\nfunction processEvent(event, context, callback) {\n    // TODO handle the event here\n}\n\nexports.handler = (event, context, callback) => {\n    if (decrypted) {\n        processEvent(event, context, callback);\n    } else {\n        // Decrypt code should run once and variables stored outside of the function\n        // handler so that these are decrypted once per container\n        const kms = new AWS.KMS();\n        kms.decrypt({ CiphertextBlob: new Buffer(encrypted, 'base64') }, (err, data) => {\n            if (err) {\n                console.log('Decrypt error:', err);\n                return callback(err);\n            }\n            decrypted = data.Plaintext.toString('ascii');\n            processEvent(event, context, callback);\n        });\n    }\n};\n```\n\n\u3068\u3044\u3046\u5f62\u3067\u3001`handler`\u306e\u5b9f\u884c\u56de\u6570\u306b\u3088\u3063\u3066\u6319\u52d5\u304c\u5909\u308f\u308a\u307e\u3059\u3002\n\u6697\u53f7\u5316\u3057\u305f\u74b0\u5883\u5909\u6570\u304c\u4e00\u3064\u306a\u3089\u307e\u3060\u306a\u3093\u3068\u304b\u30c6\u30b9\u30c8\u3092\u66f8\u3051\u306a\u304f\u306f\u306a\u3044\u3067\u3059\u304c\u3001\u4e8c\u3064\u3001\u4e09\u3064\u3068\u5897\u3048\u3066\u3044\u304f\u306b\u5f93\u3044\u8907\u96d1\u306b\u306a\u308b\u305f\u3081\u3001\u30c6\u30b9\u30c8\u3092\u66f8\u304f\u306e\u304c\u9762\u5012\u306b\u306a\u3063\u3066\u304d\u307e\u3059\u3002\n\n\u306a\u3093\u3067\u5b9f\u884c\u6642\u306b\u5fa9\u53f7\u3057\u3066\u304f\u308c\u306a\u304b\u3063\u305f\u3093\u3060\u2026\u3068\u3044\u3046\u611f\u3058\u3067\u3059\u306d\u3002\n\n\u3082\u3057\u3001\u6697\u53f7\u5316\u3055\u308c\u305f\u74b0\u5883\u5909\u6570\u3092\u4f7f\u3063\u3066\u3044\u306a\u3044\u5834\u5408\u306f\u3001\u30c6\u30b9\u30c8\u306e\u3055\u3044\u306bSAM\u306eYAML\u3092\u8aad\u307f\u8fbc\u3093\u3067`process.env`\u306b\u5dee\u3057\u8fbc\u3081\u3070\u4e0a\u624b\u304f\u30c6\u30b9\u30c8\u304c\u3067\u304d\u307e\u3059\u3002\n\u307e\u305f\u3001\u30c6\u30b9\u30c8\u306e\u3055\u3044\u306bhandler\u306e\u547c\u3073\u51fa\u3059\u306b\u306f[lambda-handler](https://github.com/k-kinzal/lambda-handler)\u3092\u3001AWS SDK\u306e\u51e6\u7406\u3092\u30e2\u30c3\u30af\u5316\u3057\u305f\u3044\u306a\u3089[fakemock](https://github.com/k-kinzal/fakemock)\u3092\u4f7f\u3048\u3070\u7c21\u5358\u306b\u30e6\u30cb\u30c3\u30c8\u30c6\u30b9\u30c8\u3092\u4f5c\u308c\u308b\u307e\u3059\u3002\n\uff08\u6700\u8fd1\u3001lambda-handler\u3068fakemock\u3092\u66f4\u65b0\u3057\u3066\u306a\u3044\u306e\u3067\u65b0\u3057\u3044API\u306f\u52d5\u304b\u306a\u3044\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u3002PR\u304a\u5f85\u3061\u3057\u3066\u304a\u308a\u307e\u3059\uff09\n\n\u3053\u306e\u3042\u305f\u308a\u306e\u30e6\u30cb\u30c3\u30c8\u30c6\u30b9\u30c8\u90e8\u5206\u306f\u3001\u307e\u3060\u3044\u308d\u3044\u308d\u3068\u691c\u8a0e\u6bb5\u968e\u306a\u3068\u3053\u308d\u304c\u3042\u308b\u306e\u3067\u3082\u3046\u5c11\u3057\u716e\u8a70\u3081\u305f\u3089\u65b0\u3057\u304f\u8a18\u4e8b\u3092\u66f8\u3053\u3046\u3068\u601d\u3044\u307e\u3059\u3002\n\n# \u304a\u308f\u308a\u306b\n\n\u3044\u304b\u304c\u3067\u3057\u305f\u3067\u3057\u3087\u3046\u304b\u3002Node\u5bc4\u308a\u306e\u69cb\u6210\u306e\u8a71\u306b\u306f\u306a\u3063\u3066\u3057\u307e\u3044\u307e\u3057\u305f\u304c\u3001\u8981\u70b9\u3055\u3048\u62bc\u3055\u3048\u308c\u3070\u4ed6\u8a00\u8a9e\u3067\u3082\u540c\u69d8\u306b\u958b\u767a\u30b5\u30a4\u30af\u30eb\u3092\u56de\u305b\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\n\u4eca\u56de\u3001\u4f7f\u7528\u3057\u305f\u30b3\u30fc\u30c9\u306f\u3053\u3061\u3089\u306b\u306a\u308a\u307e\u3059\u306e\u3067\u3001AWS Lambda\u306e\u958b\u767a\u306e\u8db3\u3057\u306b\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n* https://github.com/k-kinzal/EBA7CE416DD416B0E91442E9D5C72EF70B0111E365DF861D9A4B89BA7DAD1E3C\n\n\u3061\u3087\u3046\u3069\u3053\u306e\u30ea\u30dd\u30b8\u30c8\u30ea\u3067AWS Lambda\u3092\u4f7f\u3063\u305f\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3092\u69cb\u7bc9\u4e2d\u306a\u306e\u3067\u3001\u6700\u7d42\u7684\u306b\u3069\u306e\u3088\u3046\u306a\u69cb\u6210\u306b\u306a\u308b\u304b\u306f\u9069\u5f53\u306b\u30a6\u30a9\u30c3\u30c1\u3057\u3066\u3044\u305f\u3060\u304f\u3068\u826f\u3044\u3067\u3059\u3002\n\u4eca\u56de\u306e\u8a18\u4e8b\u3067\u306f\u716e\u8a70\u3081\u304d\u308c\u306a\u304b\u3063\u305f\u3068\u3053\u308d\u3092\u8a70\u3081\u3066\u3044\u304f\u306e\u3067\u4f55\u304b\u3057\u3089\u53c2\u8003\u306b\u306a\u308b\u3082\u306e\u306b\u306a\u308b\u3068\u601d\u3044\u307e\u3059\u3002\n", "tags": ["AWS", "lambda", "flowtype"]}