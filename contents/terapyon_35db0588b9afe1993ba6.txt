{"tags": ["bitbucket", "Sphinx", "CI"], "context": "\n\n\u69cb\u6210\u8981\u7d20\n\nBitbucket \u30ec\u30dd\u30b8\u30c8\u30ea (git or hg)\nSphinx\u306e\u30c9\u30ad\u30e5\u30e1\u30f3\u30c6\u30fc\u30b7\u30e7\u30f3\nAWS S3 \u30d0\u30b1\u30c3\u30c8 (\u30c7\u30fc\u30bf\u4fdd\u5b58\u7528)\nWeb\u30b5\u30fc\u30d0(nginx) (Basic\u8a8d\u8a3c\u3092\u884c\u3046)\nBitbucket Pipelines (\u30ec\u30dd\u30b8\u30c8\u30ea\u306ePush\u3092\u30ad\u30fc\u306bSphinx build & S3\u306bPush)\nDocker\u30b3\u30f3\u30c6\u30ca Pipeline\u3067\u4f7f\u7528\u3059\u308b\u30b3\u30f3\u30c6\u30ca\n\n\n\u88dc\u8db3\n\nWeb\u9759\u7684\u30db\u30b9\u30c8\u30fb\u8a8d\u8a3c\nAWS S3 \u306b\u306f\u3001\u9759\u7684Web\u30db\u30b9\u30c6\u30a3\u30f3\u30b0\u306e\u4ed5\u7d44\u307f\u304c\u3042\u308a\u307e\u3059\u304c\u3001Basic\u8a8d\u8a3c\u304c\u639b\u3051\u3089\u308c\u306a\u3044\u305f\u3081\u3001\u5225\u9014Web\u30b5\u30fc\u30d0\u3092\u6e96\u5099\u3057\u3001S3\u306e\u9759\u7684\u30db\u30b9\u30c6\u30a3\u30f3\u30b0\u306b\u30ea\u30d0\u30fc\u30b9\u30d7\u30ed\u30ad\u30b7\u3059\u308b\u3002\nS3\u306e\u95b2\u89a7\u6a29\u9650\u3092IP\u30a2\u30c9\u30ec\u30b9\u3067\u5236\u9650\u3059\u308b\u3002\n\u3064\u307e\u308a\u3001IP\u5236\u9650\u306e\u307f\u306a\u3089Web\u30b5\u30fc\u30d0\u3092\u5225\u9014\u6e96\u5099\u3059\u308b\u5fc5\u8981\u306f\u306a\u3044\u3002\n\nPipelines \u3068 Docker\u30b3\u30f3\u30c6\u30ca\nBitbucket Pipelines\u306f\u3001\u6700\u8fd1\u6b63\u5f0f\u306b\u30b5\u30fc\u30d3\u30b9\u304c\u59cb\u307e\u3063\u305f\u3001Bitbucket\u5185\u306eCI(\u7d99\u7d9a\u30a4\u30f3\u30c6\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u30b5\u30fc\u30d3\u30b9)\u3067\u3059\u3002\nPipelines\u3067\u306f\u3001Docker\u30b3\u30f3\u30c6\u30ca\u3092\u6307\u5b9a\u3057\u3066\u3001\u30c6\u30b9\u30c8\u3084\u30c7\u30a3\u30d7\u30ed\u30a4\u306a\u3069\u3092\u884c\u3044\u307e\u3059\u3002\nSphinx\u306eHTML\u30d3\u30eb\u30c9\u3092\u5b9f\u884c\u3057\u3001S3\u306b\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u3092\u884c\u3046\u90fd\u5408\u306e\u826f\u3044Docker\u30b3\u30f3\u30c6\u30ca\u304c\u898b\u3064\u304b\u3089\u306a\u304b\u3063\u305f\u306e\u3067\u4f5c\u6210\u3057\u307e\u3057\u305f\u3002\nterapyon/sphinx-s3\n\n\u8a2d\u5b9a\u624b\u9806\n\nAWS\u8a2d\u5b9a\n\nIAM\u3067\u65b0\u898f\u30e6\u30fc\u30b6\u4f5c\u6210(\u30a2\u30af\u30bb\u30b9\u30ad\u30fc\u306a\u3069\u3092\u53d6\u5f97)\nS3\u30d0\u30b1\u30c3\u30c8\u3092\u4f5c\u308b\n\u4e0a\u8a18\u30d0\u30b1\u30c3\u30c8\u306b\u9759\u7684\u30db\u30b9\u30c6\u30a3\u30f3\u30b0\u3092\u6709\u52b9\u306b\u3059\u308b\n\u4e0a\u8a18\u30d0\u30b1\u30c3\u30c8\u306e\u30a2\u30af\u30bb\u30b9\u6a29\u9650(IAM\u30e6\u30fc\u30b6\u306e\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u8a31\u53ef\u53ca\u3073\u6307\u5b9aIP\u304b\u3089\u306e\u9759\u7684\u30db\u30b9\u30c6\u30a3\u30f3\u30b0\u95b2\u89a7\u8a31\u53ef) *1\n\n*1: \u30d0\u30b1\u30c3\u30c8\u306e\u30a2\u30af\u30bb\u30b9\u6a29\u9650()\n{\n    \"Version\": \"2012-10-17\",\n    \"Id\": \"S3PolicyId1\",\n    \"Statement\": [\n        {\n            \"Sid\": \"IPAllow\",\n            \"Effect\": \"Allow\",\n            \"Principal\": \"*\",\n            \"Action\": \"s3:*\",\n            \"Resource\": \"arn:aws:s3:::BUCKET-NAME/*\", # <- BUCKET-NAME\u5909\u66f4\n            \"Condition\": {\n                \"IpAddress\": {\n                    \"aws:SourceIp\": \"0.0.0.0/32\" # <- Web\u30b5\u30fc\u30d0\u306eIP\u30a2\u30c9\u30ec\u30b9\n                }\n            }\n        },\n        {\n            \"Sid\": \"statement1\",\n            \"Effect\": \"Allow\",\n            \"Principal\": {\n                \"AWS\": \"arn:aws:iam::5260xxxxxxxxx:user/IAM-USER\" # <- IAM-USER\u5909\u66f4\n            },\n            \"Action\": [\n                \"s3:GetBucketLocation\",\n                \"s3:ListBucket\"\n            ],\n            \"Resource\": \"arn:aws:s3:::BUCKET-NAME\" # <- BUCKET-NAME\u5909\u66f4\n        },\n        {\n            \"Sid\": \"statement2\",\n            \"Effect\": \"Allow\",\n            \"Principal\": {\n                \"AWS\": \"arn:aws:iam::5260xxxxxxxxx:user/IAM-USER\" # <- IAM-USER\u5909\u66f4\n            },\n            \"Action\": \"s3:*\",\n            \"Resource\": \"arn:aws:s3:::BUCKET-NAME/*\" # <- BUCKET-NAME\u5909\u66f4\n        }\n    ]\n}\n\n\nWeb\u30b5\u30fc\u30d0\n\nnginx\u3067\u30d7\u30ed\u30ad\u30b7\u30fc\u30d1\u30b9\u306e\u8a2d\u5b9a\nBasic\u8a8d\u8a3c\u306e\u8a2d\u5b9a\n\nnginx\u8a2d\u5b9a\nserver {\n    listen 80;\n    server_name SERVER-NAME; # <- SERVER-NAME\u5909\u66f4\n\n    charset utf-8;\n    access_log /var/log/nginx/access.log;\n    error_log /var/log/nginx/error.log;\n\n    index index.html index.htm;\n\n    location / {\n        #Basic auth\n        auth_basic  \"Restricted Area.\";\n        auth_basic_user_file \"/etc/nginx/.htpasswd\";\n        proxy_pass http://BUCKET-NAME.s3-website-ap-northeast-1.amazonaws.com/doc/; # <- BUCKET-NAME\u5909\u66f4\n    }\n}\n\n\nBitbucket\n\n\u30ec\u30dd\u30b8\u30c8\u30ea\u306e\u8a2d\u5b9a\u3067 Pipelines \u3092\u6709\u52b9\u306b\u3059\u308b\n\nbitbucket-pipelines.yml \u3092\u30ec\u30dd\u30b8\u30c8\u30earoot\u306b\u8a2d\u7f6e\n\ns3_website.yml \u3092\u30ec\u30dd\u30b8\u30c8\u30earoot\u306b\u8a2d\u7f6e\u3002\u3053\u308c\u306f\u4eca\u56de\u306e\u4ed5\u7d44\u307f\u4e0a\u5fc5\u8981\u306a\u8a2d\u5b9a\u3092\u5165\u308c\u308b\u3082\u306e\u3067\u3001Pipelines\u306b\u5fc5\u9808\u306e\u3082\u306e\u3067\u306f\u3042\u308a\u307e\u305b\u3093\u3002\nPipelines \u306e Environment variables \u306b S3_ID \u3068 S3_SECRET \u3092\u4fdd\u5b58\u3002(S3\u306b\u30a2\u30af\u30bb\u3059\u308b\u305f\u3081\u306e\u7269)\n\nPipelines \u3092\u6709\u52b9\u5316\n\nbitbucket-pipelines.yml\nimage: terapyon/sphinx-s3\n\npipelines:\n  branches:\n    master:\n      - step:\n          script:\n            - pip install -r requirements.txt\n            - make html\n            - s3_website push\n\ns3_website.yml\ns3_id: <%= ENV['S3_ID'] %>\ns3_secret: <%= ENV['S3_SECRET'] %>\ns3_bucket: BUCKET-NAME # <- S3\u30d0\u30b1\u30c3\u30c8\u540d\u3092\u6307\u5b9a\n\ns3_endpoint: ap-northeast-1\ns3_key_prefix: doc # <- S3\u30d5\u30a9\u30eb\u30c0\u540d\u3092\u6307\u5b9a\nsite: build/html # <- \u30ec\u30dd\u30b8\u30c8\u30ea\u4e0a or \u30d3\u30eb\u30c9\u5f8c\u306e\u8ee2\u9001\u5bfe\u8c61\u306e\u30d5\u30a9\u30eb\u30c0\u3092\u6307\u5b9a \n\nEnvironment variables\n\n\n\u81ea\u52d5\u30c7\u30a3\u30d7\u30ed\u30a4\n\u8a2d\u5b9a\u304c\u5b8c\u4e86\u3059\u308b\u3068\u3001push\u6642\u306b\u81ea\u52d5\u7684\u306bS3\u306bHTML\u304c\u8ee2\u9001\u3055\u308c\u3001Web\u30b5\u30fc\u30d0\u3067\u95b2\u89a7\u53ef\u80fd\n\n\u6700\u5f8c\u306b\n\u3053\u306e\u30a8\u30f3\u30c8\u30ea\u30fc\u306f\u3001Bitbucket\u306e\u81ea\u52d5\u30c7\u30a3\u30d7\u30ed\u30a4\u65b9\u6cd5\u3092\u89e3\u8aac\u3092\u3057\u307e\u3057\u305f\u3002\n\u90e8\u5206\u7684\u306b\u8a18\u8f09\u30df\u30b9\u304c\u6b8b\u3063\u3066\u3044\u308b\u53ef\u80fd\u6027\u304c\u3042\u308a\u307e\u3059\u3002\u30df\u30b9\u306b\u3064\u3044\u3066\u306f\u3054\u6307\u6458\u3044\u305f\u3060\u3051\u305f\u3089\u5e78\u3044\u3067\u3059\u3002\n\u8457\u8005\u95a2\u9023Blog\u8a18\u4e8b\u3068\u3042\u308f\u305b\u3066\u304a\u8aad\u307f\u304f\u3060\u3055\u3044\u3002\nBitbucket Pipeline \u3067 Sphinx\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u81ea\u52d5\u66f4\u65b0\n\n\n# \u69cb\u6210\u8981\u7d20\n\n- Bitbucket \u30ec\u30dd\u30b8\u30c8\u30ea (git or hg)\n- Sphinx\u306e\u30c9\u30ad\u30e5\u30e1\u30f3\u30c6\u30fc\u30b7\u30e7\u30f3\n- AWS S3 \u30d0\u30b1\u30c3\u30c8 (\u30c7\u30fc\u30bf\u4fdd\u5b58\u7528)\n- Web\u30b5\u30fc\u30d0(nginx) (Basic\u8a8d\u8a3c\u3092\u884c\u3046)\n- Bitbucket Pipelines (\u30ec\u30dd\u30b8\u30c8\u30ea\u306ePush\u3092\u30ad\u30fc\u306bSphinx build & S3\u306bPush)\n- Docker\u30b3\u30f3\u30c6\u30ca Pipeline\u3067\u4f7f\u7528\u3059\u308b\u30b3\u30f3\u30c6\u30ca\n\n# \u88dc\u8db3\n\n## Web\u9759\u7684\u30db\u30b9\u30c8\u30fb\u8a8d\u8a3c\n\nAWS S3 \u306b\u306f\u3001\u9759\u7684Web\u30db\u30b9\u30c6\u30a3\u30f3\u30b0\u306e\u4ed5\u7d44\u307f\u304c\u3042\u308a\u307e\u3059\u304c\u3001Basic\u8a8d\u8a3c\u304c\u639b\u3051\u3089\u308c\u306a\u3044\u305f\u3081\u3001\u5225\u9014Web\u30b5\u30fc\u30d0\u3092\u6e96\u5099\u3057\u3001S3\u306e\u9759\u7684\u30db\u30b9\u30c6\u30a3\u30f3\u30b0\u306b\u30ea\u30d0\u30fc\u30b9\u30d7\u30ed\u30ad\u30b7\u3059\u308b\u3002\n\nS3\u306e\u95b2\u89a7\u6a29\u9650\u3092IP\u30a2\u30c9\u30ec\u30b9\u3067\u5236\u9650\u3059\u308b\u3002\n\n\u3064\u307e\u308a\u3001IP\u5236\u9650\u306e\u307f\u306a\u3089Web\u30b5\u30fc\u30d0\u3092\u5225\u9014\u6e96\u5099\u3059\u308b\u5fc5\u8981\u306f\u306a\u3044\u3002\n\n## Pipelines \u3068 Docker\u30b3\u30f3\u30c6\u30ca\n\nBitbucket Pipelines\u306f\u3001\u6700\u8fd1\u6b63\u5f0f\u306b\u30b5\u30fc\u30d3\u30b9\u304c\u59cb\u307e\u3063\u305f\u3001Bitbucket\u5185\u306eCI(\u7d99\u7d9a\u30a4\u30f3\u30c6\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u30b5\u30fc\u30d3\u30b9)\u3067\u3059\u3002\n\nPipelines\u3067\u306f\u3001Docker\u30b3\u30f3\u30c6\u30ca\u3092\u6307\u5b9a\u3057\u3066\u3001\u30c6\u30b9\u30c8\u3084\u30c7\u30a3\u30d7\u30ed\u30a4\u306a\u3069\u3092\u884c\u3044\u307e\u3059\u3002\n\nSphinx\u306eHTML\u30d3\u30eb\u30c9\u3092\u5b9f\u884c\u3057\u3001S3\u306b\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u3092\u884c\u3046\u90fd\u5408\u306e\u826f\u3044Docker\u30b3\u30f3\u30c6\u30ca\u304c\u898b\u3064\u304b\u3089\u306a\u304b\u3063\u305f\u306e\u3067\u4f5c\u6210\u3057\u307e\u3057\u305f\u3002\n[terapyon/sphinx-s3](https://hub.docker.com/r/terapyon/sphinx-s3/)\n\n# \u8a2d\u5b9a\u624b\u9806\n\n## AWS\u8a2d\u5b9a\n\n- IAM\u3067\u65b0\u898f\u30e6\u30fc\u30b6\u4f5c\u6210(\u30a2\u30af\u30bb\u30b9\u30ad\u30fc\u306a\u3069\u3092\u53d6\u5f97)\n- S3\u30d0\u30b1\u30c3\u30c8\u3092\u4f5c\u308b\n- \u4e0a\u8a18\u30d0\u30b1\u30c3\u30c8\u306b\u9759\u7684\u30db\u30b9\u30c6\u30a3\u30f3\u30b0\u3092\u6709\u52b9\u306b\u3059\u308b\n- \u4e0a\u8a18\u30d0\u30b1\u30c3\u30c8\u306e\u30a2\u30af\u30bb\u30b9\u6a29\u9650(IAM\u30e6\u30fc\u30b6\u306e\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u8a31\u53ef\u53ca\u3073\u6307\u5b9aIP\u304b\u3089\u306e\u9759\u7684\u30db\u30b9\u30c6\u30a3\u30f3\u30b0\u95b2\u89a7\u8a31\u53ef) *1\n\n*1: \u30d0\u30b1\u30c3\u30c8\u306e\u30a2\u30af\u30bb\u30b9\u6a29\u9650()\n\n```\n{\n\t\"Version\": \"2012-10-17\",\n\t\"Id\": \"S3PolicyId1\",\n\t\"Statement\": [\n\t\t{\n\t\t\t\"Sid\": \"IPAllow\",\n\t\t\t\"Effect\": \"Allow\",\n\t\t\t\"Principal\": \"*\",\n\t\t\t\"Action\": \"s3:*\",\n\t\t\t\"Resource\": \"arn:aws:s3:::BUCKET-NAME/*\", # <- BUCKET-NAME\u5909\u66f4\n\t\t\t\"Condition\": {\n\t\t\t\t\"IpAddress\": {\n\t\t\t\t\t\"aws:SourceIp\": \"0.0.0.0/32\" # <- Web\u30b5\u30fc\u30d0\u306eIP\u30a2\u30c9\u30ec\u30b9\n\t\t\t\t}\n\t\t\t}\n\t\t},\n\t\t{\n\t\t\t\"Sid\": \"statement1\",\n\t\t\t\"Effect\": \"Allow\",\n\t\t\t\"Principal\": {\n\t\t\t\t\"AWS\": \"arn:aws:iam::5260xxxxxxxxx:user/IAM-USER\" # <- IAM-USER\u5909\u66f4\n\t\t\t},\n\t\t\t\"Action\": [\n\t\t\t\t\"s3:GetBucketLocation\",\n\t\t\t\t\"s3:ListBucket\"\n\t\t\t],\n\t\t\t\"Resource\": \"arn:aws:s3:::BUCKET-NAME\" # <- BUCKET-NAME\u5909\u66f4\n\t\t},\n\t\t{\n\t\t\t\"Sid\": \"statement2\",\n\t\t\t\"Effect\": \"Allow\",\n\t\t\t\"Principal\": {\n\t\t\t\t\"AWS\": \"arn:aws:iam::5260xxxxxxxxx:user/IAM-USER\" # <- IAM-USER\u5909\u66f4\n\t\t\t},\n\t\t\t\"Action\": \"s3:*\",\n\t\t\t\"Resource\": \"arn:aws:s3:::BUCKET-NAME/*\" # <- BUCKET-NAME\u5909\u66f4\n\t\t}\n\t]\n}\n```\n\n## Web\u30b5\u30fc\u30d0\n\n- nginx\u3067\u30d7\u30ed\u30ad\u30b7\u30fc\u30d1\u30b9\u306e\u8a2d\u5b9a\n- Basic\u8a8d\u8a3c\u306e\u8a2d\u5b9a\n\nnginx\u8a2d\u5b9a\n\n```\nserver {\n    listen 80;\n    server_name SERVER-NAME; # <- SERVER-NAME\u5909\u66f4\n\n    charset utf-8;\n    access_log /var/log/nginx/access.log;\n    error_log /var/log/nginx/error.log;\n\n    index index.html index.htm;\n\n    location / {\n        #Basic auth\n        auth_basic  \"Restricted Area.\";\n        auth_basic_user_file \"/etc/nginx/.htpasswd\";\n        proxy_pass http://BUCKET-NAME.s3-website-ap-northeast-1.amazonaws.com/doc/; # <- BUCKET-NAME\u5909\u66f4\n    }\n}\n```\n\n\n## Bitbucket\n\n- \u30ec\u30dd\u30b8\u30c8\u30ea\u306e\u8a2d\u5b9a\u3067 `Pipelines` \u3092\u6709\u52b9\u306b\u3059\u308b\n- `bitbucket-pipelines.yml` \u3092\u30ec\u30dd\u30b8\u30c8\u30earoot\u306b\u8a2d\u7f6e\n- `s3_website.yml` \u3092\u30ec\u30dd\u30b8\u30c8\u30earoot\u306b\u8a2d\u7f6e\u3002\u3053\u308c\u306f\u4eca\u56de\u306e\u4ed5\u7d44\u307f\u4e0a\u5fc5\u8981\u306a\u8a2d\u5b9a\u3092\u5165\u308c\u308b\u3082\u306e\u3067\u3001Pipelines\u306b\u5fc5\u9808\u306e\u3082\u306e\u3067\u306f\u3042\u308a\u307e\u305b\u3093\u3002\n- Pipelines \u306e `Environment variables` \u306b `S3_ID` \u3068 `S3_SECRET` \u3092\u4fdd\u5b58\u3002(S3\u306b\u30a2\u30af\u30bb\u3059\u308b\u305f\u3081\u306e\u7269)\n\nPipelines \u3092\u6709\u52b9\u5316\n\n![Pipelines\u3092\u6709\u52b9\u5316.png](https://qiita-image-store.s3.amazonaws.com/0/47908/0f107cb0-893e-4cdb-b8f5-5954aef8e9e9.png \"Pipelines\u3092\u6709\u52b9\u5316.png\")\n\n\n\nbitbucket-pipelines.yml\n\n```\nimage: terapyon/sphinx-s3\n\npipelines:\n  branches:\n    master:\n      - step:\n          script:\n            - pip install -r requirements.txt\n            - make html\n            - s3_website push\n```\n\ns3_website.yml\n\n```\ns3_id: <%= ENV['S3_ID'] %>\ns3_secret: <%= ENV['S3_SECRET'] %>\ns3_bucket: BUCKET-NAME # <- S3\u30d0\u30b1\u30c3\u30c8\u540d\u3092\u6307\u5b9a\n\ns3_endpoint: ap-northeast-1\ns3_key_prefix: doc # <- S3\u30d5\u30a9\u30eb\u30c0\u540d\u3092\u6307\u5b9a\nsite: build/html # <- \u30ec\u30dd\u30b8\u30c8\u30ea\u4e0a or \u30d3\u30eb\u30c9\u5f8c\u306e\u8ee2\u9001\u5bfe\u8c61\u306e\u30d5\u30a9\u30eb\u30c0\u3092\u6307\u5b9a \n```\n\nEnvironment variables\n\n![Environment_variables.png](https://qiita-image-store.s3.amazonaws.com/0/47908/06e9277d-752c-a98a-6a0d-20cab527bd43.png \"Environment_variables.png\")\n\n\n\n# \u81ea\u52d5\u30c7\u30a3\u30d7\u30ed\u30a4\n\n\u8a2d\u5b9a\u304c\u5b8c\u4e86\u3059\u308b\u3068\u3001push\u6642\u306b\u81ea\u52d5\u7684\u306bS3\u306bHTML\u304c\u8ee2\u9001\u3055\u308c\u3001Web\u30b5\u30fc\u30d0\u3067\u95b2\u89a7\u53ef\u80fd\n\n\n# \u6700\u5f8c\u306b\n\n\u3053\u306e\u30a8\u30f3\u30c8\u30ea\u30fc\u306f\u3001Bitbucket\u306e\u81ea\u52d5\u30c7\u30a3\u30d7\u30ed\u30a4\u65b9\u6cd5\u3092\u89e3\u8aac\u3092\u3057\u307e\u3057\u305f\u3002\n\n\u90e8\u5206\u7684\u306b\u8a18\u8f09\u30df\u30b9\u304c\u6b8b\u3063\u3066\u3044\u308b\u53ef\u80fd\u6027\u304c\u3042\u308a\u307e\u3059\u3002\u30df\u30b9\u306b\u3064\u3044\u3066\u306f\u3054\u6307\u6458\u3044\u305f\u3060\u3051\u305f\u3089\u5e78\u3044\u3067\u3059\u3002\n\n\u8457\u8005\u95a2\u9023Blog\u8a18\u4e8b\u3068\u3042\u308f\u305b\u3066\u304a\u8aad\u307f\u304f\u3060\u3055\u3044\u3002\n\n[Bitbucket Pipeline \u3067 Sphinx\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u81ea\u52d5\u66f4\u65b0](https://www.cmscom.jp/blog/vtlfhk)\n\n\n"}