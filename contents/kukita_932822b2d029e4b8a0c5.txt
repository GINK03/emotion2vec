{"context": " More than 1 year has passed since last update.Chef Zero(chef-zero) \u3092 Chef Client \u306e\u30ed\u30fc\u30ab\u30eb\u30e2\u30fc\u30c9\u3067\u306f\u306a\u304f\u3001\u8efd\u91cf\u30a4\u30f3\u30e1\u30e2\u30ea\u30fc Chef Server \u3068\u3057\u3066\u4f7f\u3044\u3001\u30db\u30b9\u30c8 OS \u304b\u3089 Docker \u30b3\u30f3\u30c6\u30ca\u30fc\u3092 Chef \u3067\u7ba1\u7406\u3059\u308b\u624b\u9806\u3092\u81ea\u5206\u7528\u306e\u30e1\u30e2\u3068\u3057\u3066\u307e\u3068\u3081\u307e\u3057\u305f\u3002\nVagrant \u4e0a\u306b\u4f5c\u6210\u3057\u305f CentOS 7 \u74b0\u5883\u3092 Docker \u306e\u30db\u30b9\u30c8 OS \u3068\u3057\u3066\u4f7f\u7528\u3057\u307e\u3059\u3002\nVagrant \u306e Box \u306f http://www.vagrantbox.es/ \u306b\u516c\u958b\u3055\u308c\u3066\u3044\u308b\u4ee5\u4e0b\u3092\u5229\u7528\u3057\u307e\u3057\u305f\u3002\n\nCentOS7.0 x86_64 minimal (VirtualBoxGuestAddtions 4.3.14)\n\n\n1: \u30b7\u30b9\u30c6\u30e0\u306e\u30a2\u30c3\u30d7\u30c7\u30fc\u30c8\u3068 SELinux \u306e\u7121\u52b9\u5316\n\u307e\u305a\u3001Docker \u3092\u4f7f\u7528\u3059\u308b\u305f\u3081\u306b\u30d1\u30c3\u30b1\u30fc\u30b8\u306e\u30a2\u30c3\u30d7\u30c7\u30fc\u30c8\u3068 SELinux \u306e\u7121\u52b9\u5316\u3092\u884c\u3044\u307e\u3059\u3002\n\n\u624b\u9806 1-1: Yum \u3092\u4f7f\u3063\u3066\u30d1\u30c3\u30b1\u30fc\u30b8\u3092\u30a2\u30c3\u30d7\u30c7\u30fc\u30c8\u3057\u307e\u3059\n[vagrant@localhost ~]$ sudo yum -y update\n\n\n\u624b\u9806 1-2: SELinux \u3092\u7121\u52b9\u5316\u3057\u307e\u3059\n[vagrant@localhost ~]$ sudo sed -i \"s/^SELINUX=enforcing/SELINUX=disabled/g\" /etc/selinux/config\n[vagrant@localhost ~]$ grep \"disabled\" /etc/selinux/config\n\n#     disabled - No SELinux policy is loaded.\nSELINUX=disabled\n\n\u2192 \u5024\u304c disabled \u306b\u306a\u3063\u3066\u3044\u308b\u3053\u3068\u3092\u78ba\u304b\u3081\u307e\u3059\u3002\n\n\u624b\u9806 1-3: OS \u3092\u518d\u8d77\u52d5\u3057\u307e\u3059\n[vagrant@localhost ~]$ sudo systemctl reboot\n\n\n\u624b\u9806 1-4: SELinux \u304c\u7121\u52b9\u5316\u3055\u308c\u305f\u3053\u3068\u3092\u78ba\u304b\u3081\u307e\u3059\n[vagrant@localhost ~]$ sudo /usr/sbin/sestatus\n\nSELinux status:                 disabled\n\n\u2192 disabled \u3068\u8868\u793a\u3055\u308c\u308b\u3053\u3068\u3092\u78ba\u304b\u3081\u307e\u3059\u3002\n\n2: Docker \u306e\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\nDocker \u3092\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u3057\u307e\u3059\u3002\n\n\u624b\u9806 2-1: Yum \u3092\u4f7f\u3063\u3066 Docker \u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u307e\u3059\n[vagrant@localhost ~]$ sudo yum -y install \"docker\"\n[vagrant@localhost ~]$ rpm -qa | grep \"docker\"\n\ndocker-0.11.1-22.el7.centos.x86_64\n\n\n\u624b\u9806 2-2: Docker \u306e\u30b5\u30fc\u30d3\u30b9\u3092\u8d77\u52d5\u3057\u307e\u3059\n[vagrant@localhost ~]$ sudo systemctl start \"docker.service\"\n[vagrant@localhost ~]$ sudo systemctl enable \"docker.service\"\n[vagrant@localhost ~]$ systemctl list-units | grep \"docker.service\"\n\nsys-devices-virtual-net-docker0.device\n          loaded active plugged   /sys/devices/virtual/net/docker0\nsys-subsystem-net-devices-docker0.device\n          loaded active plugged   /sys/subsystem/net/devices/docker0\nvar-lib-docker.mount\n          loaded active mounted   /var/lib/docker\ndocker.service\n          loaded active running   Docker Application Container Engine\n\n\u2192 \u4e0a\u8a18\u306e\u3088\u3046\u306b\u8868\u793a\u3055\u308c\u308c\u3070\u6210\u529f\u3067\u3059\u3002\n\n\u624b\u9806 2-3: Docker \u304c\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u3055\u308c\u305f\u3053\u3068\u3092\u78ba\u8a8d\u3057\u307e\u3059\n[vagrant@localhost ~]$ sudo docker version\n\nClient version: 0.11.1-dev\nClient API version: 1.12\nGo version (client): go1.2\nGit commit (client): 02d20af/0.11.1\nServer version: 0.11.1-dev\nServer API version: 1.12\nGo version (server): go1.2\nGit commit (server): 02d20af/0.11.1\n\n\u2192 \u4e0a\u8a18\u306e\u3088\u3046\u306b\u8868\u793a\u3055\u308c\u308c\u3070\u6210\u529f\u3067\u3059\u3002\n\n3: Chef Zero \u306e\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\n\u7d9a\u3044\u3066\u3001Chef Zero \u3092\u8efd\u91cf\u30a4\u30f3\u30e1\u30e2\u30ea\u30fc Chef Server \u3068\u3057\u3066\u4f7f\u3048\u308b\u3088\u3046\u306b\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u3057\u307e\u3059\u3002\n\n\u624b\u9806 3-1: Yum \u3092\u4f7f\u3063\u3066 Git \u3068 ChefDK \u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u307e\u3059\n[vagrant@localhost ~]$ sudo yum -y install \"git\" \"https://packagecloud.io/chef/stable/download?distro=6&filename=chefdk-0.2.2-1.x86_64.rpm\"\n[vagrant@localhost ~]$ rpm -qa | egrep \"git-|chefdk\"\n\ngit-1.8.3.1-4.el7.x86_64\nchefdk-0.2.2-1.x86_64\n\n\n\u624b\u9806 3-2: Git \u3092\u4f7f\u3063\u3066 chef-repo \uff08\u30ed\u30fc\u30ab\u30eb\u30ea\u30dd\u30b8\u30c8\u30ea\u306e\u3072\u306a\u5f62\uff09\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u307e\u3059\n[vagrant@localhost ~]$ cd ~\n[vagrant@localhost ~]$ git clone \"git://github.com/opscode/chef-repo.git\"\n\n\n\u624b\u9806 3-3: chef-repo \u4e0b\u306b .chef \u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u4f5c\u6210\u3057\u307e\u3059\n[vagrant@localhost ~]$ mkdir -p ~/chef-repo/.chef\n[vagrant@localhost ~]$ ls -ld ~/chef-repo/.chef/\n\ndrwxrwxr-x 2 vagrant vagrant 6 Xxx XX XX:XX /home/vagrant/chef-repo/.chef/\n\n\n\u624b\u9806 3-4: \u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u30a4\u30f3\u30bf\u30fc\u30d5\u30a7\u30fc\u30b9 docker0 \u306b\u5272\u308a\u5f53\u3066\u3089\u308c\u305f IP \u30a2\u30c9\u30ec\u30b9\u3092\u78ba\u8a8d\u3057\u307e\u3059\n[vagrant@localhost ~]$ ip address show \"docker0\"\n\n4: docker0: <NO-CARRIER,BROADCAST,MULTICAST,UP> mtu 1500 qdisc noqueue state DOWN\n    link/ether 56:84:7a:fe:97:99 brd ff:ff:ff:ff:ff:ff\n    inet 172.17.42.1/16 scope global docker0\n       valid_lft forever preferred_lft forever\n\n\u2192 172.17.42.1 \u304c\u5272\u308a\u5f53\u3066\u3089\u308c\u3066\u3044\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n\u624b\u9806 3-5: Knife \u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb knife.rb \u3092\u4f5c\u6210\u3057\u307e\u3059\n[vagrant@localhost ~]$ cat << EOF | tee ~/chef-repo/.chef/knife.rb\ncurrent_dir = File.dirname(__FILE__)\nchef_server_url \"http://172.17.42.1:8889\"\nnode_name \"$(nmcli general hostname)\"\nclient_key \"#{current_dir}/dummy.pem\"\ncookbook_path \"#{current_dir}/../cookbooks\"\nEOF\n\n\n\u624b\u9806 3-6: Chef Zero \u3092 Systemd \u306e\u30e6\u30cb\u30c3\u30c8\u3068\u3057\u3066\u767b\u9332\u3057\u307e\u3059\n[vagrant@localhost ~]$ sudo sh -c \"cat << EOF | tee /etc/systemd/system/chef-zero.service\n[Unit]\nDescription=chef-zero\n\n[Service]\nType=simple\nUser=daemon\nEnvironment=PATH=/opt/chefdk/embedded/bin\nExecStart=/opt/chefdk/embedded/bin/chef-zero -H 172.17.42.1 -p 8889\nRestart=always\n\n[Install]\nWantedBy=multi-user.target\nEOF\"\n\n\n\u624b\u9806 3-7: /etc/services \u3092\u7de8\u96c6\u3057\u307e\u3059\n[vagrant@localhost ~]$ sudo vi /etc/services\n\n\u2192 \u6b21\u306e 1 \u884c\u3092\u9069\u5207\u306a\u7b87\u6240\u306b\u8ffd\u8a18\u3057\u307e\u3059\u3002\nchef-zero       8889/tcp                        # Chef Zero\n\n\n\u624b\u9806 3-8: RSA \u79d8\u5bc6\u9375\uff08pem \u30d5\u30a1\u30a4\u30eb\uff09\u3092\u4f5c\u6210\u3057\u307e\u3059\n[vagrant@localhost ~]$ ssh-keygen -t rsa -N \"\" -f ~/chef-repo/.chef/dummy.pem\n[vagrant@localhost ~]$ ls -l ~/chef-repo/.chef/dummy.pem\n\n-rw------- 1 vagrant vagrant XXXX Xxx XX XX:XX /home/vagrant/chef-repo/.chef/dummy.pem\n\n\u2192 \u30c0\u30df\u30fc\u306e\u30d5\u30a1\u30a4\u30eb\u3067\u3059\u304c\u3001\u4e2d\u8eab\u306f RSA \u79d8\u5bc6\u9375\u306e\u5f62\u5f0f\u3067\u3042\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\n\u624b\u9806 3-9: /etc/chef \u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u4f5c\u6210\u3057\u307e\u3059\n[vagrant@localhost ~]$ sudo mkdir -p /etc/chef\n[vagrant@localhost ~]$ ls -ld /etc/chef/\n\ndrwxr-xr-x 2 root root 6 Xxx XX XX:XX /etc/chef/\n\n\n\u624b\u9806 3-10: RSA \u79d8\u5bc6\u9375\uff08pem \u30d5\u30a1\u30a4\u30eb\uff09\u306e\u30b7\u30f3\u30dc\u30ea\u30c3\u30af\u30ea\u30f3\u30af\u3092\u4f5c\u6210\u3057\u307e\u3059\n[vagrant@localhost ~]$ sudo ln -sf ~/chef-repo/.chef/dummy.pem /etc/chef/validation.pem\n[vagrant@localhost ~]$ ls -l /etc/chef/validation.pem\n\nlrwxrwxrwx 1 root root 39 Xxx XX XX:XX /etc/chef/validation.pem -> /home/vagrant/chef-repo/.chef/dummy.pem\n\n\n\u624b\u9806 3-11: Systemd \u3092\u4f7f\u3063\u3066 Chef Zero \u306e\u30b5\u30fc\u30d3\u30b9\u3092\u8d77\u52d5\u3057\u307e\u3059\u3002\n[vagrant@localhost ~]$ sudo systemctl start \"chef-zero.service\"\n[vagrant@localhost ~]$ sudo systemctl enable \"chef-zero.service\"\n[vagrant@localhost ~]$ systemctl list-units | grep \"chef-zero.service\"\n\nchef-zero.service\n          loaded active running   chef-zero\n\n\n\u624b\u9806 3-12: \u30ea\u30b9\u30cb\u30f3\u30b0\u30dd\u30fc\u30c8\u306e\u72b6\u614b\u3092\u78ba\u8a8d\u3057\u307e\u3059\n[vagrant@localhost ~]$ sudo ss -lp | grep \"chef-zero\"\n\ntcp    LISTEN     0      128        172.17.42.1:chef-zero               *:*        users:((\"ruby\",XXXX,7))\n\n\n\u624b\u9806 3-13: Knife \u3092\u4f7f\u3063\u3066 Chef Zero \u3068\u306e\u63a5\u7d9a\u3092\u78ba\u8a8d\u3057\u307e\u3059\n[vagrant@localhost ~]$ cd ~/chef-repo/\n[vagrant@localhost ~]$ knife client list\n\nchef-validator\nchef-webui\n\n\u2192 \u4e0a\u8a18\u306e\u3088\u3046\u306b\u8868\u793a\u3055\u308c\u308c\u3070\u6210\u529f\u3067\u3059\u3002\n\n\u624b\u9806 3-11: FirewallD \u30b5\u30fc\u30d3\u30b9\u3092\u505c\u6b62\u3057\u307e\u3059\u3002\n[vagrant@localhost ~]$ sudo systemctl stop \"firewalld.service\"\n[vagrant@localhost ~]$ sudo systemctl disable \"firewalld.service\"\n[vagrant@localhost ~]$ systemctl list-units | grep \"firewalld.service\"\n\n\u2192 \u4f55\u3082\u8868\u793a\u3055\u308c\u306a\u3044\u4e8b\u3092\u78ba\u304b\u3081\u307e\u3059\u3002\n\u672c\u6765\u3067\u3042\u308c\u3070\u3001FirewallD \u3082\u6b63\u3057\u304f\u8a2d\u5b9a\u3059\u3079\u304d\u3067\u3059\u304c\u3001\u3053\u3053\u3067\u306f\u624b\u9806\u7c21\u7565\u5316\u306e\u305f\u3081\u306b\u30b5\u30fc\u30d3\u30b9\u3054\u3068\u505c\u6b62\u3057\u3066\u3057\u307e\u3044\u307e\u3059\u3002\n\n4: Docker \u30b3\u30f3\u30c6\u30ca\u30fc\u306b\u9069\u7528\u3059\u308b\u30af\u30c3\u30af\u30d6\u30c3\u30af\u306e\u4f5c\u6210\n\u3053\u3053\u3067\u306f\u3001\u30b3\u30df\u30e5\u30cb\u30c6\u30a3\u306b\u516c\u958b\u3055\u308c\u3066\u3044\u308b\u30af\u30c3\u30af\u30d6\u30c3\u30af Apache2 \u3092\u30e9\u30c3\u30d7\u3059\u308b\u3060\u3051\u306e\u7c21\u5358\u306a\u30af\u30c3\u30af\u30d6\u30c3\u30af\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n\u624b\u9806 4-1: Cookbook \u306e\u7f6e\u304d\u5834\u3092\u4f5c\u6210\u3057\u307e\u3059\n[vagrant@localhost ~]$ mkdir -p ~/chef-repo/site-cookbooks\n[vagrant@localhost ~]$ ls -ld ~/chef-repo/site-cookbooks/\n\ndrwxrwxr-x 2 vagrant vagrant 6 Xxx XX XX:XX /home/vagrant/chef-repo/site-cookbooks/\n\n\n\u624b\u9806 4-2: berks \u30b3\u30de\u30f3\u30c9\u3092\u4f7f\u3063\u3066 HTTP_server \u3068\u3044\u3046\u540d\u524d\u306e\u30af\u30c3\u30af\u30d6\u30c3\u30af\u3092\u4f5c\u6210\u3057\u307e\u3059\n[vagrant@localhost ~]$ cd ~/chef-repo/site-cookbooks/\n[vagrant@localhost ~]$ chef exec berks cookbook \"HTTP_server\" --skip-vagrant --skip-test-kitchen  --license=\"reserved\" --maintainer=\"YOUR_NAME\" --maintainer-email=\"YOUR_EMAIL\"\n[vagrant@localhost ~]$ ls -ld ~/chef-repo/site-cookbooks/HTTP_server/\n\ndrwxrwxr-x 10 vagrant vagrant 4096 Xxx XX XX:XX /home/vagrant/chef-repo/site-cookbooks/HTTP_server/\n\n\n\u624b\u9806 4-3: Cookbook \u306e\u30e1\u30bf\u30c7\u30fc\u30bf\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb metadata.rb \u3092\u7de8\u96c6\u3057\u307e\u3059\n[vagrant@localhost ~]$ echo \"depends 'apache2'\" | tee -a HTTP_server/metadata.rb\n\n\nmetadata.rb\nname             'HTTP_server'\nmaintainer       'YOUR_NAME'\nmaintainer_email 'YOUR_EMAIL'\nlicense          'All rights reserved'\ndescription      'Installs/Configures HTTP_server'\nlong_description 'Installs/Configures HTTP_server'\nversion          '0.1.0'\ndepends 'apache2'\n\n\n\n\u624b\u9806 4-4: Cookbook \u306e\u30c7\u30d5\u30a9\u30eb\u30c8\u30ec\u30b7\u30d4\u30d5\u30a1\u30a4\u30eb default.rb \u3092\u7de8\u96c6\u3057\u307e\u3059\n[vagrant@localhost ~]$ echo \"include_recipe 'apache2::default'\" | tee -a HTTP_server/recipes/default.rb\n\n\ndefault.rb\n#\n# Cookbook Name:: HTTP_server\n# Recipe:: default\n#\n# Copyright (C) 2014 YOUR_NAME\n#\n# All rights reserved - Do Not Redistribute\n#\ninclude_recipe 'apache2::default'\n\n\n\n\u624b\u9806 4-5: Berkshelf \u3092\u4f7f\u3063\u3066\u4f9d\u5b58\u95a2\u4fc2\u306e\u3042\u308b\u30af\u30c3\u30af\u30d6\u30c3\u30af\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u307e\u3059\n[vagrant@localhost ~]$ cd ~/chef-repo/site-cookbooks/HTTP_server/\n[vagrant@localhost ~]$ chef exec berks vendor\n[vagrant@localhost ~]$ ls -l berks-cookbooks/\n\ntotal 16\ndrwxrwxr-x 7 vagrant vagrant  138 Xxx XX XX:XX apache2\n-rw------- 1 vagrant vagrant  256 Xxx XX XX:XX Berksfile.lock\ndrwxrwxr-x 9 vagrant vagrant 4096 Xxx XX XX:XX HTTP_server\ndrwxrwxr-x 6 vagrant vagrant  126 Xxx XX XX:XX iptables\ndrwxrwxr-x 7 vagrant vagrant 4096 Xxx XX XX:XX logrotate\ndrwxrwxr-x 6 vagrant vagrant 4096 Xxx XX XX:XX pacman\n\n\n\u624b\u9806 4-6: \u4f5c\u6210\u3057\u305f\u30af\u30c3\u30af\u30d6\u30c3\u30af\u3092 Chef Zero \u306b\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u3057\u307e\u3059\n[vagrant@localhost ~]$ chef exec berks upload\n[vagrant@localhost ~]$ knife cookbook list\n\nHTTP_server   0.1.0\napache2       2.0.0\niptables      0.14.0\nlogrotate     1.7.0\npacman        1.1.1\n\n\u2192 \u4e0a\u8a18\u306e\u3088\u3046\u306b\u8868\u793a\u3055\u308c\u308c\u3070\u6210\u529f\u3067\u3059\u3002\n\n5: Docker \u30b3\u30f3\u30c6\u30ca\u30fc\u30a4\u30e1\u30fc\u30b8\u306e\u4f5c\u6210\n\n\u624b\u9806 5-1: Dockerfile \u3092\u4f5c\u6210\u3057\u307e\u3059\n[vagrant@localhost ~]$ cat << EOF | tee ~/chef-repo/.chef/Dockerfile\nFROM centos:centos6\nRUN yum -y update\nRUN curl https://www.getchef.com/chef/install.sh | bash\nRUN knife configure client -s 'http://172.17.42.1:8889' '/etc/chef/'\nADD dummy.pem /etc/chef/validation.pem\nEOF\n\n\n\u624b\u9806 5-2: \u4f5c\u6210\u3057\u305f Dockerfile \u3092\u4f7f\u3063\u3066\u30b3\u30f3\u30c6\u30ca\u30fc\u30a4\u30e1\u30fc\u30b8\u3092\u30d3\u30eb\u30c9\u3057\u307e\u3059\n[vagrant@localhost ~]$ cd ~/chef-repo/.chef/\n[vagrant@localhost ~]$ sudo docker build -t chef-node:centos6 .\n[vagrant@localhost ~]$ sudo docker images\n\n\nREPOSITORY          TAG                 IMAGE ID            CREATED             VIRTUAL SIZE\nchef-node           centos6             fa91934382b6        53 seconds ago      409.8 MB\ncentos              centos6             68eb857ffb51        2 weeks ago         212.7 MB\n\n\u2192 \u4e0a\u8a18\u306e\u3088\u3046\u306b\u8868\u793a\u3055\u308c\u308c\u3070\u6210\u529f\u3067\u3059\u3002\n\n6: Docker \u30b3\u30f3\u30c6\u30ca\u30fc\u306e\u4f5c\u6210\u3068\u30af\u30c3\u30af\u30d6\u30c3\u30af\u306e\u9069\u7528\n\n\u624b\u9806 6-1: \u5ff5\u306e\u305f\u3081\u8d77\u52d5\u3057\u3066\u3044\u308b\u5168\u3066\u306e Docker \u30b3\u30f3\u30c6\u30ca\u30fc\u3092\u524a\u9664\u3057\u307e\u3059\n[vagrant@localhost ~]$ sudo docker stop $(sudo docker ps -q)\n[vagrant@localhost ~]$ sudo docker rm $(sudo docker ps -a -q)\n[vagrant@localhost ~]$ sudo docker ps -a\n\nCONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS\n        NAMES\n\n\n\u624b\u9806 6-2: \u8a66\u3057\u306b 2 \u53f0\u306e\u30b3\u30f3\u30c6\u30ca\u30fc\u3092\u8d77\u52d5\u3057\u307e\u3059\n[vagrant@localhost ~]$ sudo docker run -d -p 8001:80 chef-node:centos6 chef-client -i 600 -s 60 -N \"node_01\"\n[vagrant@localhost ~]$ sudo docker run -d -p 8002:80 chef-node:centos6 chef-client -i 600 -s 60 -N \"node_02\"\n[vagrant@localhost ~]$ sudo docker ps\n\nCONTAINER ID        IMAGE               COMMAND                CREATED             STATUS              PORTS\n              NAMES\nxxxxxxxxx        chef-node:latest    chef-client -i 60 -s   XX seconds ago      Up XX seconds       0.0.0.0:8002->80/tcp   xxxxxxxxx\nxxxxxxxxx        chef-node:latest    chef-client -i 60 -s   XX seconds ago      Up XX seconds       0.0.0.0:8001->80/tcp   xxxxxxxxx\n\n\n\u624b\u9806 6-2: Knife \u3092\u4f7f\u3063\u3066\u8d77\u52d5\u3057\u305f\u30b3\u30f3\u30c6\u30ca\u30fc\u304c Chef \u306e Node \u3068\u3057\u3066\u767b\u9332\u3055\u308c\u305f\u3053\u3068\u3092\u78ba\u304b\u3081\u307e\u3059\n[vagrant@localhost ~]$ knife node list\n\nnode_01\nnode_02\n\n\n\u624b\u9806 6-2: \u30b3\u30f3\u30c6\u30ca\u30fc\u306b \u30af\u30c3\u30af\u30d6\u30c3\u30af HTTP_server \u306e\u30ec\u30b7\u30d4\u3092\u9069\u7528\u3057\u307e\u3059\n[vagrant@localhost ~]$ knife node run_list add \"node_01\" \"HTTP_server\"\n\nnode_01:\n  run_list: recipe[HTTP_server]\n\n[vagrant@localhost ~]$ knife node run_list add \"node_02\" \"HTTP_server\"\n\nnode_02:\n  run_list: recipe[HTTP_server]\n\n\n\u624b\u9806 6-3: \u3057\u3070\u3089\u304f\u3059\u308b\u3068 httpd \u30c7\u30fc\u30e2\u30f3\u30d7\u30ed\u30bb\u30b9\u304c\u7acb\u3061\u4e0a\u304c\u3063\u3066\u304d\u307e\u3059\n[vagrant@localhost ~]$ watch \"ps aux | grep httpd\"\n\nEvery 2.0s: ps aux | grep httpd                                                         Xxx Xxx XX XX:XX:XX XXXX\nroot     29179  0.0  0.0      0     0 ?        Zs   21:06   0:00 [httpd] <defunct>\n48       29473  0.0  0.0 107204  2108 ?        S    21:06   0:00 /usr/sbin/httpd\n48       29474  0.0  0.0 107204  2108 ?        S    21:06   0:00 /usr/sbin/httpd\n48       29476  0.0  0.0 107204  2108 ?        S    21:06   0:00 /usr/sbin/httpd\n48       29478  0.0  0.0 107204  2108 ?        S    21:06   0:00 /usr/sbin/httpd\n48       29479  0.0  0.0 107204  2108 ?        S    21:06   0:00 /usr/sbin/httpd\nroot     31033  0.0  0.0      0     0 ?        Zs   21:16   0:00 [httpd] <defunct>\n48       31485  0.0  0.0 107204  2112 ?        S    21:17   0:00 /usr/sbin/httpd\n48       31486  0.0  0.0 107204  2112 ?        S    21:17   0:00 /usr/sbin/httpd\n48       31487  0.0  0.0 107204  2112 ?        S    21:17   0:00 /usr/sbin/httpd\n48       31488  0.0  0.0 107204  2112 ?        S    21:17   0:00 /usr/sbin/httpd\n48       31489  0.0  0.0 107204  2112 ?        S    21:17   0:00 /usr/sbin/httpd\nvagrant  31810  0.2  0.0 116928  1616 pts/0    S+   21:19   0:00 watch ps aux | grep httpd\nvagrant  31819  0.0  0.0 116924   444 pts/0    S+   21:20   0:00 watch ps aux | grep httpd\nvagrant  31820  0.0  0.0 113116  1360 pts/0    S+   21:20   0:00 sh -c ps aux | grep httpd\nvagrant  31822  0.0  0.0 112640   944 pts/0    S+   21:20   0:00 grep httpd\n\n\n\u3061\u3087\u3063\u3068\u8a66\u3057\u65b9\u304c\u601d\u3044\u3064\u304b\u306a\u304b\u3063\u305f\u306e\u3067\u3059\u304c\u3001\u3053\u308c\u3067\u30b3\u30f3\u30c6\u30ca\u30fc\u4e0a\u306e httpd \u30b5\u30fc\u30d3\u30b9\u304c\u505c\u6b62\u3057\u3066\u3082 Chef Client \u304c\u691c\u77e5\u3057\u30b5\u30fc\u30d3\u30b9\u304c\u518d\u8d77\u52d5\u3057\u307e\u3059\u3002\n\u4ee5\u4e0a\u304c Chef Zero \u3092\u4f7f\u3044\u3001\u30db\u30b9\u30c8 OS \u304b\u3089 Docker \u306e\u30b3\u30f3\u30c6\u30ca\u30fc\u3092 Chef \u3067\u7ba1\u7406\u3059\u308b\u624b\u9806\u3067\u3057\u305f\u3002\nChef Zero(chef-zero) \u3092 Chef Client \u306e\u30ed\u30fc\u30ab\u30eb\u30e2\u30fc\u30c9\u3067\u306f\u306a\u304f\u3001\u8efd\u91cf\u30a4\u30f3\u30e1\u30e2\u30ea\u30fc Chef Server \u3068\u3057\u3066\u4f7f\u3044\u3001\u30db\u30b9\u30c8 OS \u304b\u3089 Docker \u30b3\u30f3\u30c6\u30ca\u30fc\u3092 Chef \u3067\u7ba1\u7406\u3059\u308b\u624b\u9806\u3092\u81ea\u5206\u7528\u306e\u30e1\u30e2\u3068\u3057\u3066\u307e\u3068\u3081\u307e\u3057\u305f\u3002\n\nVagrant \u4e0a\u306b\u4f5c\u6210\u3057\u305f CentOS 7 \u74b0\u5883\u3092 Docker \u306e\u30db\u30b9\u30c8 OS \u3068\u3057\u3066\u4f7f\u7528\u3057\u307e\u3059\u3002\n\nVagrant \u306e Box \u306f http://www.vagrantbox.es/ \u306b\u516c\u958b\u3055\u308c\u3066\u3044\u308b\u4ee5\u4e0b\u3092\u5229\u7528\u3057\u307e\u3057\u305f\u3002\n\n- [CentOS7.0 x86_64 minimal (VirtualBoxGuestAddtions 4.3.14)](https://f0fff3908f081cb6461b407be80daf97f07ac418.googledrive.com/host/0BwtuV7VyVTSkUG1PM3pCeDJ4dVE/centos7.box)\n\n## 1: \u30b7\u30b9\u30c6\u30e0\u306e\u30a2\u30c3\u30d7\u30c7\u30fc\u30c8\u3068 SELinux \u306e\u7121\u52b9\u5316\n\n\u307e\u305a\u3001Docker \u3092\u4f7f\u7528\u3059\u308b\u305f\u3081\u306b\u30d1\u30c3\u30b1\u30fc\u30b8\u306e\u30a2\u30c3\u30d7\u30c7\u30fc\u30c8\u3068 SELinux \u306e\u7121\u52b9\u5316\u3092\u884c\u3044\u307e\u3059\u3002\n\n### \u624b\u9806 1-1: Yum \u3092\u4f7f\u3063\u3066\u30d1\u30c3\u30b1\u30fc\u30b8\u3092\u30a2\u30c3\u30d7\u30c7\u30fc\u30c8\u3057\u307e\u3059\n\n```bash\n[vagrant@localhost ~]$ sudo yum -y update\n```\n\n### \u624b\u9806 1-2: SELinux \u3092\u7121\u52b9\u5316\u3057\u307e\u3059\n\n```bash\n[vagrant@localhost ~]$ sudo sed -i \"s/^SELINUX=enforcing/SELINUX=disabled/g\" /etc/selinux/config\n[vagrant@localhost ~]$ grep \"disabled\" /etc/selinux/config\n\n#     disabled - No SELinux policy is loaded.\nSELINUX=disabled\n```\n\n\u2192 \u5024\u304c `disabled` \u306b\u306a\u3063\u3066\u3044\u308b\u3053\u3068\u3092\u78ba\u304b\u3081\u307e\u3059\u3002\n\n### \u624b\u9806 1-3: OS \u3092\u518d\u8d77\u52d5\u3057\u307e\u3059\n\n```bash\n[vagrant@localhost ~]$ sudo systemctl reboot\n```\n\n### \u624b\u9806 1-4: SELinux \u304c\u7121\u52b9\u5316\u3055\u308c\u305f\u3053\u3068\u3092\u78ba\u304b\u3081\u307e\u3059\n\n```bash\n[vagrant@localhost ~]$ sudo /usr/sbin/sestatus\n\nSELinux status:                 disabled\n```\n\n\u2192 `disabled` \u3068\u8868\u793a\u3055\u308c\u308b\u3053\u3068\u3092\u78ba\u304b\u3081\u307e\u3059\u3002\n\n## 2: Docker \u306e\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\n\nDocker \u3092\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u3057\u307e\u3059\u3002\n\n### \u624b\u9806 2-1: Yum \u3092\u4f7f\u3063\u3066 Docker \u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u307e\u3059\n\n```bash\n[vagrant@localhost ~]$ sudo yum -y install \"docker\"\n[vagrant@localhost ~]$ rpm -qa | grep \"docker\"\n\ndocker-0.11.1-22.el7.centos.x86_64\n```\n\n### \u624b\u9806 2-2: Docker \u306e\u30b5\u30fc\u30d3\u30b9\u3092\u8d77\u52d5\u3057\u307e\u3059\n\n```bash\n[vagrant@localhost ~]$ sudo systemctl start \"docker.service\"\n[vagrant@localhost ~]$ sudo systemctl enable \"docker.service\"\n[vagrant@localhost ~]$ systemctl list-units | grep \"docker.service\"\n\nsys-devices-virtual-net-docker0.device\n          loaded active plugged   /sys/devices/virtual/net/docker0\nsys-subsystem-net-devices-docker0.device\n          loaded active plugged   /sys/subsystem/net/devices/docker0\nvar-lib-docker.mount\n          loaded active mounted   /var/lib/docker\ndocker.service\n          loaded active running   Docker Application Container Engine\n```\n\n\u2192 \u4e0a\u8a18\u306e\u3088\u3046\u306b\u8868\u793a\u3055\u308c\u308c\u3070\u6210\u529f\u3067\u3059\u3002\n\n### \u624b\u9806 2-3: Docker \u304c\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u3055\u308c\u305f\u3053\u3068\u3092\u78ba\u8a8d\u3057\u307e\u3059\n\n```bash\n[vagrant@localhost ~]$ sudo docker version\n\nClient version: 0.11.1-dev\nClient API version: 1.12\nGo version (client): go1.2\nGit commit (client): 02d20af/0.11.1\nServer version: 0.11.1-dev\nServer API version: 1.12\nGo version (server): go1.2\nGit commit (server): 02d20af/0.11.1\n```\n\n\u2192 \u4e0a\u8a18\u306e\u3088\u3046\u306b\u8868\u793a\u3055\u308c\u308c\u3070\u6210\u529f\u3067\u3059\u3002\n\n## 3: Chef Zero \u306e\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\n\n\u7d9a\u3044\u3066\u3001Chef Zero \u3092\u8efd\u91cf\u30a4\u30f3\u30e1\u30e2\u30ea\u30fc Chef Server \u3068\u3057\u3066\u4f7f\u3048\u308b\u3088\u3046\u306b\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u3057\u307e\u3059\u3002\n\n### \u624b\u9806 3-1: Yum \u3092\u4f7f\u3063\u3066 Git \u3068 ChefDK \u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u307e\u3059\n\n```bash\n[vagrant@localhost ~]$ sudo yum -y install \"git\" \"https://packagecloud.io/chef/stable/download?distro=6&filename=chefdk-0.2.2-1.x86_64.rpm\"\n[vagrant@localhost ~]$ rpm -qa | egrep \"git-|chefdk\"\n\ngit-1.8.3.1-4.el7.x86_64\nchefdk-0.2.2-1.x86_64\n```\n\n### \u624b\u9806 3-2: Git \u3092\u4f7f\u3063\u3066 `chef-repo` \uff08\u30ed\u30fc\u30ab\u30eb\u30ea\u30dd\u30b8\u30c8\u30ea\u306e\u3072\u306a\u5f62\uff09\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u307e\u3059\n\n```bash\n[vagrant@localhost ~]$ cd ~\n[vagrant@localhost ~]$ git clone \"git://github.com/opscode/chef-repo.git\"\n```\n\n### \u624b\u9806 3-3: `chef-repo` \u4e0b\u306b `.chef` \u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u4f5c\u6210\u3057\u307e\u3059\n\n```bash\n[vagrant@localhost ~]$ mkdir -p ~/chef-repo/.chef\n[vagrant@localhost ~]$ ls -ld ~/chef-repo/.chef/\n\ndrwxrwxr-x 2 vagrant vagrant 6 Xxx XX XX:XX /home/vagrant/chef-repo/.chef/\n```\n\n### \u624b\u9806 3-4: \u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u30a4\u30f3\u30bf\u30fc\u30d5\u30a7\u30fc\u30b9 `docker0` \u306b\u5272\u308a\u5f53\u3066\u3089\u308c\u305f IP \u30a2\u30c9\u30ec\u30b9\u3092\u78ba\u8a8d\u3057\u307e\u3059\n\n```bash\n[vagrant@localhost ~]$ ip address show \"docker0\"\n\n4: docker0: <NO-CARRIER,BROADCAST,MULTICAST,UP> mtu 1500 qdisc noqueue state DOWN\n    link/ether 56:84:7a:fe:97:99 brd ff:ff:ff:ff:ff:ff\n    inet 172.17.42.1/16 scope global docker0\n       valid_lft forever preferred_lft forever\n```\n\n\u2192 `172.17.42.1` \u304c\u5272\u308a\u5f53\u3066\u3089\u308c\u3066\u3044\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n### \u624b\u9806 3-5: Knife \u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb `knife.rb` \u3092\u4f5c\u6210\u3057\u307e\u3059\n\n```bash\n[vagrant@localhost ~]$ cat << EOF | tee ~/chef-repo/.chef/knife.rb\ncurrent_dir = File.dirname(__FILE__)\nchef_server_url \"http://172.17.42.1:8889\"\nnode_name \"$(nmcli general hostname)\"\nclient_key \"#{current_dir}/dummy.pem\"\ncookbook_path \"#{current_dir}/../cookbooks\"\nEOF\n```\n\n### \u624b\u9806 3-6: Chef Zero \u3092 Systemd \u306e\u30e6\u30cb\u30c3\u30c8\u3068\u3057\u3066\u767b\u9332\u3057\u307e\u3059\n\n```bash\n[vagrant@localhost ~]$ sudo sh -c \"cat << EOF | tee /etc/systemd/system/chef-zero.service\n[Unit]\nDescription=chef-zero\n\n[Service]\nType=simple\nUser=daemon\nEnvironment=PATH=/opt/chefdk/embedded/bin\nExecStart=/opt/chefdk/embedded/bin/chef-zero -H 172.17.42.1 -p 8889\nRestart=always\n\n[Install]\nWantedBy=multi-user.target\nEOF\"\n```\n\n### \u624b\u9806 3-7: `/etc/services` \u3092\u7de8\u96c6\u3057\u307e\u3059\n\n```bash\n[vagrant@localhost ~]$ sudo vi /etc/services\n```\n\n\u2192 \u6b21\u306e 1 \u884c\u3092\u9069\u5207\u306a\u7b87\u6240\u306b\u8ffd\u8a18\u3057\u307e\u3059\u3002\n\n```\nchef-zero       8889/tcp                        # Chef Zero\n```\n\n### \u624b\u9806 3-8: RSA \u79d8\u5bc6\u9375\uff08pem \u30d5\u30a1\u30a4\u30eb\uff09\u3092\u4f5c\u6210\u3057\u307e\u3059\n\n```bash\n[vagrant@localhost ~]$ ssh-keygen -t rsa -N \"\" -f ~/chef-repo/.chef/dummy.pem\n[vagrant@localhost ~]$ ls -l ~/chef-repo/.chef/dummy.pem\n\n-rw------- 1 vagrant vagrant XXXX Xxx XX XX:XX /home/vagrant/chef-repo/.chef/dummy.pem\n```\n\n\u2192 \u30c0\u30df\u30fc\u306e\u30d5\u30a1\u30a4\u30eb\u3067\u3059\u304c\u3001\u4e2d\u8eab\u306f RSA \u79d8\u5bc6\u9375\u306e\u5f62\u5f0f\u3067\u3042\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\n### \u624b\u9806 3-9: `/etc/chef` \u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u4f5c\u6210\u3057\u307e\u3059\n\n```bash\n[vagrant@localhost ~]$ sudo mkdir -p /etc/chef\n[vagrant@localhost ~]$ ls -ld /etc/chef/\n\ndrwxr-xr-x 2 root root 6 Xxx XX XX:XX /etc/chef/\n```\n\n### \u624b\u9806 3-10: RSA \u79d8\u5bc6\u9375\uff08pem \u30d5\u30a1\u30a4\u30eb\uff09\u306e\u30b7\u30f3\u30dc\u30ea\u30c3\u30af\u30ea\u30f3\u30af\u3092\u4f5c\u6210\u3057\u307e\u3059\n\n```bash\n[vagrant@localhost ~]$ sudo ln -sf ~/chef-repo/.chef/dummy.pem /etc/chef/validation.pem\n[vagrant@localhost ~]$ ls -l /etc/chef/validation.pem\n\nlrwxrwxrwx 1 root root 39 Xxx XX XX:XX /etc/chef/validation.pem -> /home/vagrant/chef-repo/.chef/dummy.pem\n```\n\n### \u624b\u9806 3-11: Systemd \u3092\u4f7f\u3063\u3066 Chef Zero \u306e\u30b5\u30fc\u30d3\u30b9\u3092\u8d77\u52d5\u3057\u307e\u3059\u3002\n\n```bash\n[vagrant@localhost ~]$ sudo systemctl start \"chef-zero.service\"\n[vagrant@localhost ~]$ sudo systemctl enable \"chef-zero.service\"\n[vagrant@localhost ~]$ systemctl list-units | grep \"chef-zero.service\"\n\nchef-zero.service\n          loaded active running   chef-zero\n```\n\n### \u624b\u9806 3-12: \u30ea\u30b9\u30cb\u30f3\u30b0\u30dd\u30fc\u30c8\u306e\u72b6\u614b\u3092\u78ba\u8a8d\u3057\u307e\u3059 \n\n```bash\n[vagrant@localhost ~]$ sudo ss -lp | grep \"chef-zero\"\n\ntcp    LISTEN     0      128        172.17.42.1:chef-zero               *:*        users:((\"ruby\",XXXX,7))\n```\n\n### \u624b\u9806 3-13: Knife \u3092\u4f7f\u3063\u3066 Chef Zero \u3068\u306e\u63a5\u7d9a\u3092\u78ba\u8a8d\u3057\u307e\u3059\n\n```bash\n[vagrant@localhost ~]$ cd ~/chef-repo/\n[vagrant@localhost ~]$ knife client list\n\nchef-validator\nchef-webui\n```\n\n\u2192 \u4e0a\u8a18\u306e\u3088\u3046\u306b\u8868\u793a\u3055\u308c\u308c\u3070\u6210\u529f\u3067\u3059\u3002\n\n### \u624b\u9806 3-11: FirewallD \u30b5\u30fc\u30d3\u30b9\u3092\u505c\u6b62\u3057\u307e\u3059\u3002\n\n```bash\n[vagrant@localhost ~]$ sudo systemctl stop \"firewalld.service\"\n[vagrant@localhost ~]$ sudo systemctl disable \"firewalld.service\"\n[vagrant@localhost ~]$ systemctl list-units | grep \"firewalld.service\"\n```\n\n\u2192 \u4f55\u3082\u8868\u793a\u3055\u308c\u306a\u3044\u4e8b\u3092\u78ba\u304b\u3081\u307e\u3059\u3002\n\n\u672c\u6765\u3067\u3042\u308c\u3070\u3001FirewallD \u3082\u6b63\u3057\u304f\u8a2d\u5b9a\u3059\u3079\u304d\u3067\u3059\u304c\u3001\u3053\u3053\u3067\u306f\u624b\u9806\u7c21\u7565\u5316\u306e\u305f\u3081\u306b\u30b5\u30fc\u30d3\u30b9\u3054\u3068\u505c\u6b62\u3057\u3066\u3057\u307e\u3044\u307e\u3059\u3002\n\n## 4: Docker \u30b3\u30f3\u30c6\u30ca\u30fc\u306b\u9069\u7528\u3059\u308b\u30af\u30c3\u30af\u30d6\u30c3\u30af\u306e\u4f5c\u6210\n\n\u3053\u3053\u3067\u306f\u3001\u30b3\u30df\u30e5\u30cb\u30c6\u30a3\u306b\u516c\u958b\u3055\u308c\u3066\u3044\u308b\u30af\u30c3\u30af\u30d6\u30c3\u30af `Apache2` \u3092\u30e9\u30c3\u30d7\u3059\u308b\u3060\u3051\u306e\u7c21\u5358\u306a\u30af\u30c3\u30af\u30d6\u30c3\u30af\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n### \u624b\u9806 4-1: Cookbook \u306e\u7f6e\u304d\u5834\u3092\u4f5c\u6210\u3057\u307e\u3059\n\n```bash\n[vagrant@localhost ~]$ mkdir -p ~/chef-repo/site-cookbooks\n[vagrant@localhost ~]$ ls -ld ~/chef-repo/site-cookbooks/\n\ndrwxrwxr-x 2 vagrant vagrant 6 Xxx XX XX:XX /home/vagrant/chef-repo/site-cookbooks/\n```\n\n### \u624b\u9806 4-2: berks \u30b3\u30de\u30f3\u30c9\u3092\u4f7f\u3063\u3066 `HTTP_server` \u3068\u3044\u3046\u540d\u524d\u306e\u30af\u30c3\u30af\u30d6\u30c3\u30af\u3092\u4f5c\u6210\u3057\u307e\u3059\n\n```bash\n[vagrant@localhost ~]$ cd ~/chef-repo/site-cookbooks/\n[vagrant@localhost ~]$ chef exec berks cookbook \"HTTP_server\" --skip-vagrant --skip-test-kitchen  --license=\"reserved\" --maintainer=\"YOUR_NAME\" --maintainer-email=\"YOUR_EMAIL\"\n[vagrant@localhost ~]$ ls -ld ~/chef-repo/site-cookbooks/HTTP_server/\n\ndrwxrwxr-x 10 vagrant vagrant 4096 Xxx XX XX:XX /home/vagrant/chef-repo/site-cookbooks/HTTP_server/\n```\n\n### \u624b\u9806 4-3: Cookbook \u306e\u30e1\u30bf\u30c7\u30fc\u30bf\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb `metadata.rb` \u3092\u7de8\u96c6\u3057\u307e\u3059\n\n```bash\n[vagrant@localhost ~]$ echo \"depends 'apache2'\" | tee -a HTTP_server/metadata.rb\n```\n\n```rb:metadata.rb\nname             'HTTP_server'\nmaintainer       'YOUR_NAME'\nmaintainer_email 'YOUR_EMAIL'\nlicense          'All rights reserved'\ndescription      'Installs/Configures HTTP_server'\nlong_description 'Installs/Configures HTTP_server'\nversion          '0.1.0'\ndepends 'apache2'\n```\n\n### \u624b\u9806 4-4: Cookbook \u306e\u30c7\u30d5\u30a9\u30eb\u30c8\u30ec\u30b7\u30d4\u30d5\u30a1\u30a4\u30eb `default.rb` \u3092\u7de8\u96c6\u3057\u307e\u3059\n\n```bash\n[vagrant@localhost ~]$ echo \"include_recipe 'apache2::default'\" | tee -a HTTP_server/recipes/default.rb\n```\n\n```rb:default.rb\n#\n# Cookbook Name:: HTTP_server\n# Recipe:: default\n#\n# Copyright (C) 2014 YOUR_NAME\n#\n# All rights reserved - Do Not Redistribute\n#\ninclude_recipe 'apache2::default'\n```\n\n### \u624b\u9806 4-5: Berkshelf \u3092\u4f7f\u3063\u3066\u4f9d\u5b58\u95a2\u4fc2\u306e\u3042\u308b\u30af\u30c3\u30af\u30d6\u30c3\u30af\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u307e\u3059\n\n```bash\n[vagrant@localhost ~]$ cd ~/chef-repo/site-cookbooks/HTTP_server/\n[vagrant@localhost ~]$ chef exec berks vendor\n[vagrant@localhost ~]$ ls -l berks-cookbooks/\n\ntotal 16\ndrwxrwxr-x 7 vagrant vagrant  138 Xxx XX XX:XX apache2\n-rw------- 1 vagrant vagrant  256 Xxx XX XX:XX Berksfile.lock\ndrwxrwxr-x 9 vagrant vagrant 4096 Xxx XX XX:XX HTTP_server\ndrwxrwxr-x 6 vagrant vagrant  126 Xxx XX XX:XX iptables\ndrwxrwxr-x 7 vagrant vagrant 4096 Xxx XX XX:XX logrotate\ndrwxrwxr-x 6 vagrant vagrant 4096 Xxx XX XX:XX pacman\n```\n\n### \u624b\u9806 4-6: \u4f5c\u6210\u3057\u305f\u30af\u30c3\u30af\u30d6\u30c3\u30af\u3092 Chef Zero \u306b\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u3057\u307e\u3059\n\n```bash\n[vagrant@localhost ~]$ chef exec berks upload\n[vagrant@localhost ~]$ knife cookbook list\n\nHTTP_server   0.1.0\napache2       2.0.0\niptables      0.14.0\nlogrotate     1.7.0\npacman        1.1.1\n```\n\n\u2192 \u4e0a\u8a18\u306e\u3088\u3046\u306b\u8868\u793a\u3055\u308c\u308c\u3070\u6210\u529f\u3067\u3059\u3002\n\n## 5: Docker \u30b3\u30f3\u30c6\u30ca\u30fc\u30a4\u30e1\u30fc\u30b8\u306e\u4f5c\u6210\n\n### \u624b\u9806 5-1: `Dockerfile` \u3092\u4f5c\u6210\u3057\u307e\u3059\n\n```bash\n[vagrant@localhost ~]$ cat << EOF | tee ~/chef-repo/.chef/Dockerfile\nFROM centos:centos6\nRUN yum -y update\nRUN curl https://www.getchef.com/chef/install.sh | bash\nRUN knife configure client -s 'http://172.17.42.1:8889' '/etc/chef/'\nADD dummy.pem /etc/chef/validation.pem\nEOF\n```\n\n### \u624b\u9806 5-2: \u4f5c\u6210\u3057\u305f `Dockerfile` \u3092\u4f7f\u3063\u3066\u30b3\u30f3\u30c6\u30ca\u30fc\u30a4\u30e1\u30fc\u30b8\u3092\u30d3\u30eb\u30c9\u3057\u307e\u3059\n\n```bash\n[vagrant@localhost ~]$ cd ~/chef-repo/.chef/\n[vagrant@localhost ~]$ sudo docker build -t chef-node:centos6 .\n[vagrant@localhost ~]$ sudo docker images\n\n\nREPOSITORY          TAG                 IMAGE ID            CREATED             VIRTUAL SIZE\nchef-node           centos6             fa91934382b6        53 seconds ago      409.8 MB\ncentos              centos6             68eb857ffb51        2 weeks ago         212.7 MB\n```\n\n\u2192 \u4e0a\u8a18\u306e\u3088\u3046\u306b\u8868\u793a\u3055\u308c\u308c\u3070\u6210\u529f\u3067\u3059\u3002\n\n## 6: Docker \u30b3\u30f3\u30c6\u30ca\u30fc\u306e\u4f5c\u6210\u3068\u30af\u30c3\u30af\u30d6\u30c3\u30af\u306e\u9069\u7528\n\n### \u624b\u9806 6-1: \u5ff5\u306e\u305f\u3081\u8d77\u52d5\u3057\u3066\u3044\u308b\u5168\u3066\u306e Docker \u30b3\u30f3\u30c6\u30ca\u30fc\u3092\u524a\u9664\u3057\u307e\u3059\n\n```bash\n[vagrant@localhost ~]$ sudo docker stop $(sudo docker ps -q)\n[vagrant@localhost ~]$ sudo docker rm $(sudo docker ps -a -q)\n[vagrant@localhost ~]$ sudo docker ps -a\n\nCONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS\n        NAMES\n```\n\n### \u624b\u9806 6-2: \u8a66\u3057\u306b 2 \u53f0\u306e\u30b3\u30f3\u30c6\u30ca\u30fc\u3092\u8d77\u52d5\u3057\u307e\u3059\n\n```bash\n[vagrant@localhost ~]$ sudo docker run -d -p 8001:80 chef-node:centos6 chef-client -i 600 -s 60 -N \"node_01\"\n[vagrant@localhost ~]$ sudo docker run -d -p 8002:80 chef-node:centos6 chef-client -i 600 -s 60 -N \"node_02\"\n[vagrant@localhost ~]$ sudo docker ps\n\nCONTAINER ID        IMAGE               COMMAND                CREATED             STATUS              PORTS\n              NAMES\nxxxxxxxxx        chef-node:latest    chef-client -i 60 -s   XX seconds ago      Up XX seconds       0.0.0.0:8002->80/tcp   xxxxxxxxx\nxxxxxxxxx        chef-node:latest    chef-client -i 60 -s   XX seconds ago      Up XX seconds       0.0.0.0:8001->80/tcp   xxxxxxxxx\n```\n\n### \u624b\u9806 6-2: Knife \u3092\u4f7f\u3063\u3066\u8d77\u52d5\u3057\u305f\u30b3\u30f3\u30c6\u30ca\u30fc\u304c Chef \u306e Node \u3068\u3057\u3066\u767b\u9332\u3055\u308c\u305f\u3053\u3068\u3092\u78ba\u304b\u3081\u307e\u3059\n\n```bash\n[vagrant@localhost ~]$ knife node list\n\nnode_01\nnode_02\n```\n\n### \u624b\u9806 6-2: \u30b3\u30f3\u30c6\u30ca\u30fc\u306b \u30af\u30c3\u30af\u30d6\u30c3\u30af `HTTP_server` \u306e\u30ec\u30b7\u30d4\u3092\u9069\u7528\u3057\u307e\u3059\n\n```bash\n[vagrant@localhost ~]$ knife node run_list add \"node_01\" \"HTTP_server\"\n\nnode_01:\n  run_list: recipe[HTTP_server]\n```\n```bash\n[vagrant@localhost ~]$ knife node run_list add \"node_02\" \"HTTP_server\"\n\nnode_02:\n  run_list: recipe[HTTP_server]\n```\n\n### \u624b\u9806 6-3: \u3057\u3070\u3089\u304f\u3059\u308b\u3068 `httpd` \u30c7\u30fc\u30e2\u30f3\u30d7\u30ed\u30bb\u30b9\u304c\u7acb\u3061\u4e0a\u304c\u3063\u3066\u304d\u307e\u3059\n\n```bash\n[vagrant@localhost ~]$ watch \"ps aux | grep httpd\"\n\nEvery 2.0s: ps aux | grep httpd                                                         Xxx Xxx XX XX:XX:XX XXXX\nroot     29179  0.0  0.0      0     0 ?        Zs   21:06   0:00 [httpd] <defunct>\n48       29473  0.0  0.0 107204  2108 ?        S    21:06   0:00 /usr/sbin/httpd\n48       29474  0.0  0.0 107204  2108 ?        S    21:06   0:00 /usr/sbin/httpd\n48       29476  0.0  0.0 107204  2108 ?        S    21:06   0:00 /usr/sbin/httpd\n48       29478  0.0  0.0 107204  2108 ?        S    21:06   0:00 /usr/sbin/httpd\n48       29479  0.0  0.0 107204  2108 ?        S    21:06   0:00 /usr/sbin/httpd\nroot     31033  0.0  0.0      0     0 ?        Zs   21:16   0:00 [httpd] <defunct>\n48       31485  0.0  0.0 107204  2112 ?        S    21:17   0:00 /usr/sbin/httpd\n48       31486  0.0  0.0 107204  2112 ?        S    21:17   0:00 /usr/sbin/httpd\n48       31487  0.0  0.0 107204  2112 ?        S    21:17   0:00 /usr/sbin/httpd\n48       31488  0.0  0.0 107204  2112 ?        S    21:17   0:00 /usr/sbin/httpd\n48       31489  0.0  0.0 107204  2112 ?        S    21:17   0:00 /usr/sbin/httpd\nvagrant  31810  0.2  0.0 116928  1616 pts/0    S+   21:19   0:00 watch ps aux | grep httpd\nvagrant  31819  0.0  0.0 116924   444 pts/0    S+   21:20   0:00 watch ps aux | grep httpd\nvagrant  31820  0.0  0.0 113116  1360 pts/0    S+   21:20   0:00 sh -c ps aux | grep httpd\nvagrant  31822  0.0  0.0 112640   944 pts/0    S+   21:20   0:00 grep httpd\n```\n\n---\n\n\u3061\u3087\u3063\u3068\u8a66\u3057\u65b9\u304c\u601d\u3044\u3064\u304b\u306a\u304b\u3063\u305f\u306e\u3067\u3059\u304c\u3001\u3053\u308c\u3067\u30b3\u30f3\u30c6\u30ca\u30fc\u4e0a\u306e `httpd` \u30b5\u30fc\u30d3\u30b9\u304c\u505c\u6b62\u3057\u3066\u3082 Chef Client \u304c\u691c\u77e5\u3057\u30b5\u30fc\u30d3\u30b9\u304c\u518d\u8d77\u52d5\u3057\u307e\u3059\u3002\n\n\u4ee5\u4e0a\u304c Chef Zero \u3092\u4f7f\u3044\u3001\u30db\u30b9\u30c8 OS \u304b\u3089 Docker \u306e\u30b3\u30f3\u30c6\u30ca\u30fc\u3092 Chef \u3067\u7ba1\u7406\u3059\u308b\u624b\u9806\u3067\u3057\u305f\u3002\n", "tags": ["docker", "chef", "chef-zero", "centos7"]}