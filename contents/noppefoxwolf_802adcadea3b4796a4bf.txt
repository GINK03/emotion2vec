{"context": "\n\n\u69cb\u6210\nruby 2.3.1\nrails5\nunicorn\ncapistrano\nnginx\n\n\u76ee\u6b21\n\n\u624b\u9806\n\nVPS\u306e\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\nhttp://vps.sakura.ad.jp/specification/\n\u304b\u3089\u597d\u304d\u306a\u69cb\u6210\u3092\u9078\u3093\u3067\u7533\u3057\u8fbc\u307f\u3002\n\u4eca\u56de\u306f\u4e00\u756a\u5c0f\u3055\u3044\u30d7\u30e9\u30f3512\u306b\u3057\u307e\u3057\u305f\u3002\n\u7533\u3057\u8fbc\u307f\u3092\u3057\u305f\u3089\nhttps://secure.sakura.ad.jp/vps/#/servers/\n\u306b\u30ed\u30b0\u30a4\u30f3\u3057\u3066\u6a19\u6e96OS\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u307e\u3059\u3002\n\nroot\u306e\u30d1\u30b9\u30ef\u30fc\u30c9\u3082\u3053\u3053\u3067\u8a2d\u5b9a\u3057\u307e\u3059\u3002\u5fd8\u308c\u306a\u3044\u3088\u3046\u306b\u30e1\u30e2\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\n\u30b9\u30c6\u30fc\u30bf\u30b9\u304c\u7a3c\u50cd\u4e2d\u306b\u306a\u308b\u307e\u3067\u3057\u3070\u3089\u304f\u5f85\u3061\u307e\u3059\n\n\u307e\u305f\u3053\u306e\u30da\u30fc\u30b8\u306b\u8868\u793a\u3055\u308c\u3066\u3044\u308bIPv4\u30a2\u30c9\u30ec\u30b9\u304c\u5951\u7d04\u3057\u305fIP\u30a2\u30c9\u30ec\u30b9\u306b\u306a\u308a\u307e\u3059\u3002\n\n\u7a3c\u50cd\u4e2d\u30b9\u30c6\u30fc\u30bf\u30b9\u306b\u306a\u3063\u305f\u3089VNC\u30b3\u30f3\u30bd\u30fc\u30eb\u3092\u958b\u3044\u3066\u773a\u3081\u307e\u3059\u3002\n\n\u7d50\u69cb\u304b\u304b\u308b\u306e\u3067\u7d50\u69cb\u5f85\u3061\u307e\u3059\u3002\uff0820\u5206\u304f\u3089\u3044\u304b\u306a\n\u3061\u306a\u307f\u306bUpdating RPMS on system:\u3068\u51fa\u3066\u3044\u3066\u56fa\u307e\u3063\u3066\u3044\u3066\u3082\u5927\u4e08\u592b\u3067\u3059\u3002\nhttps://blog.fudi55.net/archives/454.html\ntk1_xxx_xxxx login: _\u3068\u8868\u793a\u3055\u308c\u305f\u8868\u793a\u306b\u306a\u3063\u305f\u3089\u6b21\u306e\u30b9\u30c6\u30c3\u30d7\u306b\u9032\u307f\u307e\u3059\u3002\n\nSSH\u3067\u30ed\u30b0\u30a4\u30f3\n\u3055\u304f\u3089\u306e\u30b5\u30fc\u30d0\u30fc\u306b\u30ed\u30b0\u30a4\u30f3\u3057\u307e\u3059\u3002terminal.app\u3092\u958b\u3044\u3066\n\nlocal\nssh root@xxx.xxx.xx.xx (xxx.xxx.xx.xx\u306f\u30b5\u30fc\u30d0\u306eIP\u30a2\u30c9\u30ec\u30b9\uff09\n\n\n\u3067\u30ed\u30b0\u30a4\u30f3\u3057\u307e\u3059\u3002\u8cea\u554f\u306b\u306fyes\u3001OS\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u6642\u306b\u6c7a\u3081\u305f\u30d1\u30b9\u30ef\u30fc\u30c9\u3092\u5165\u529b\u3057\u307e\u3059\u3002\n\n\u3053\u3053\u3067WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED!\u304c\u51fa\u308b\u5834\u5408\u306f\nssh-keygen -R xxx.xxx.xx.xx\n\u3067\u30db\u30b9\u30c8\u304b\u3089\u8a2d\u5b9a\u3092\u6d88\u305b\u3070\u5148\u306b\u9032\u3081\u308b\u306f\u305a\u3067\u3059\u3002\n\n\n\u30e6\u30fc\u30b6\u30fc\u306e\u4f5c\u6210\n\u30c7\u30d7\u30ed\u30a4\u7528\u306e\u30e6\u30fc\u30b6\u30fc\u3092\u4f5c\u3063\u3066\u304a\u304d\u307e\u3059\u3002\n\nvps\n~]# useradd deploy\n~]# passwd deploy\nNew password: \u30d1\u30b9\u30ef\u30fc\u30c9\u5165\u529b\n\n\nvisudo\u3057\u3066\u30e6\u30fc\u30b6\u30fc\u6a29\u9650\u3092\u5e83\u3052\u3066\u304a\u304f\n\ndeploy  ALL=(ALL)       ALL\n\ndeploy\u30e6\u30fc\u30b6\u30fc\u3092wheel\u306b\u5165\u308c\u3066\u304a\u304f\n\nusermod -G wheel deploy\n\n\nnginx\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\nvps\n~]# rpm -ivh http://nginx.org/packages/centos/6/noarch/RPMS/nginx-release-centos-6-0.el6.ngx.noarch.rpm\n~]# yum -y install nginx\n\n\ncd /etc/nginx/conf.d/\nmv default.conf default.conf.bak\nvim sample.conf\n```:sample.conf\nupstream staging {\n  server unix:/tmp/unicorn.staging.sock;\n}\nserver {\n  listen 80 default_server;\n  server_name xxx.xxx.xx.xx;\naccess_log /var/log/nginx/access.log;\n  error_log /var/log/nginx/error.log;\nroot /home/deploy/staging/current/;\n  location / {\n    location ^~ /staging {\n      proxy_pass http://staging;\n    }\n  }\n}\n~\n```\n\nMySQL\nyum install http://dev.mysql.com/get/mysql-community-release-el6-5.noarch.rpm\nyum install mysql mysql-devel mysql-server mysql-utilities\n\nyum install sqlite-devel\nyum install nodejs --enablerepo=epel\n\n\nrbenv\u3068ruby\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\u4e0b\u6e96\u5099\n\nbash.vps\nyum install gcc-c++ glibc-headers openssl-devel readline libyaml-devel readline-devel zlib zlib-devel\n\n\nrbenv\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3068\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\n\nvps\n~]# git clone https://github.com/sstephenson/rbenv.git /usr/local/rbenv\n~]# git clone git://github.com/sstephenson/ruby-build.git /usr/local/rbenv/plugins/ruby-build\nchgrp -R wheel /usr/local/rbenv/\nchmod -R g+rwxXs /usr/local/rbenv/\nchmod -R g-s /path/to/rbenv\n\n\nbash_profile\u306b\u8ffd\u8a18(deploy\u30e6\u30fc\u30b6\u30fc\u3082\u3084\u3063\u3066\u304a\u304f\uff09\n\nexport RBENV_ROOT=\"/usr/local/rbenv\"\nexport PATH=\"${RBENV_ROOT}/bin:${PATH}\"\neval \"$(rbenv init --no-rehash -)\"\n\nruby2.3.1\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\nvps\n~]# rbenv install 2.3.1\n//~~~\u5f85\u3064\nrbenv global 2.3.1\nrbenv rehash\n\n\nyum install rubygems\n\ngem install sqlite3 -v '1.3.12'\n\n\ndeploy\u30e6\u30fc\u30b6\u30fc\u306e\u516c\u958b\u9375\u306e\u4f5c\u6210\n\u4e00\u5ea6vps\u304b\u3089\u30ed\u30b0\u30a2\u30a6\u30c8\u3057\u3066deploy\u30e6\u30fc\u30b6\u30fc\u3067\u30ed\u30b0\u30a4\u30f3\u3057\u306a\u304a\u3057\u307e\u3059\u3002\nexit\nssh deploy@xxx.xxx.xx.xx\n\nssh-keygen\n//enter\n\nless ~/.ssh/id_rsa.pub\n\n\u30b3\u30d4\u30da\u3057\u3066q\u3067\u51fa\u308b\n\ndeploy\u30e6\u30fc\u30b6\u30fc\u306e\u516c\u958b\u9375\u306e\u767b\u9332\ngithub\u306a\u3089\nPersonal settings > personal > SSH and GPG keys\nbitbucket\u306a\u3089\nSSHKey\u306e\u767b\u9332\u304b\u3089\n\n\u3064\u3044\u3067\u306b\u30ea\u30dd\u30b8\u30c8\u30ea\u3092\u4f5c\u308b\n\n\n\n\u30c7\u30d7\u30ed\u30a4\u3059\u308b\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3092\u4f5c\u308b\nrails new sample\ncd sample\n\ngit init\ngibo rails >> .gitignore\n\nconfig/secrets.yml\u3092.gitignore\u306b\u8ffd\u8a18\u3059\u308b\ngit add .\ngit commit -am \"first init\"\ngit remote add origin git@github.com:noppefoxwolf/sample-server.git\ngit push -u origin master\n\nbundle exec rails generate controller Welcome index\nbundle exec rails s\n\nhttp://localhost:3000/welcome/index\n\u306b\u30a2\u30af\u30bb\u30b9\u3057\u3066\u307f\u308b\n\n\u3053\u308c\u304c\u3067\u308c\u3070OK\nCtrl+C\u3067\u30b5\u30fc\u30d0\u6b62\u3081\u308b\nGemfile\u306b\u4ee5\u4e0b\u3092\u8ffd\u8a18\ngroup :development do\n  gem \"capistrano\"\n  gem 'capistrano-rails'\n  gem \"capistrano-rbenv\"\n  gem 'capistrano-bundler'\n  gem 'capistrano3-unicorn', :git => 'git@github.com:noppefoxwolf/capistrano3-unicorn.git'\nend\n\ngroup :production, :staging do\n  gem 'unicorn'\nend\n\nbundle update\nbundle exec cap install\n\u8cea\u554f\u306fno\u3092\u9078\u3076\uff08ci\u74b0\u5883\u306e\u8a98\u5c0e\u307f\u305f\u3044\u306a\u3084\u3064\u306a\u306e\u3067\uff09\n\nCapfile\nrequire \"capistrano/setup\"\nrequire \"capistrano/deploy\"\n\nrequire 'capistrano/rbenv'\nrequire 'capistrano/rails'\nrequire 'capistrano3/unicorn'\n\nset :linked_files, %w{config/secrets.yml}\n# Load custom tasks from `lib/capistrano/tasks` if you have any defined\nDir.glob(\"lib/capistrano/tasks/*.rake\").each { |r| import r }\n\n\n\nconfig/deploy/staging.rb\nset :pty, true\nserver 'xxx.xxx.xx.xx', user: 'deploy', roles: %w{app db web}\n\nset :linked_dirs, %w{bin log tmp/backup tmp/pids tmp/sockets vendor/bundle}\n\nshared_path = \"/home/deploy/staging/shared\"\nset :unicorn_pid, \"#{shared_path}/tmp/pids/unicorn.pid\"\nset :unicorn_options, -> { \"--path /staging\" }\nset :unicorn_exec, -> { \"unicorn_rails\" }\n\n\n\nconfig/deploy.rb\nlock '3.6.1'\n\nset :application, 'sample'\nset :repo_url, 'git@github.com:noppefoxwolf/sample-server.git'\nset :deploy_to, '/home/deploy/staging'\nset :pty, true\nset :scm, :git\nset :rbenv_ruby, '2.3.1'\nset :rbenv_type, :system\n\nafter 'deploy:publishing', 'deploy:restart'\nnamespace :deploy do\n  desc 'Restart application'\n  task :restart do\n    invoke 'unicorn:restart'\n  end\nend\n\n\nmkdir config/unicorn\ntouch config/unicorn/staging.rb\n\nconfig/unicorn/staging.rb\nbase = \"/home/deploy/staging\"\ncurrent_path = \"#{base}/current\"\nshared_path = \"#{base}/shared\"\nworking_directory current_path\n\nworker_processes 2\npreload_app true\ntimeout 30\n\nstderr_path \"#{current_path}/log/unicorn.stderr.log\"\nstdout_path \"#{current_path}/log/unicorn.stdout.log\"\nlisten \"/tmp/unicorn.staging.sock\"\npid \"#{shared_path}/tmp/pids/unicorn.pid\"\n\n#\u30c0\u30a6\u30f3\u30bf\u30a4\u30e0\u7121\u3057\npreload_app true\n\nbefore_fork do |server, worker|\n  ENV['BUNDLE_GEMFILE'] = File.expand_path('Gemfile', current_path)\n  old_pid = \"#{server.config[:pid]}.oldbin\"\n  if File.exists?(old_pid) && server.pid != old_pid\n    begin\n      sig = (worker.nr + 1) >= server.worker_processes ? :QUIT : :TTOU\n      Process.kill(sig, File.read(old_pid).to_i)\n    rescue Errno::ENOENT, Errno::ESRCH\n      # someone else did our job for us\n    end\n  end\nend\n\nafter_fork do |server, worker|\n  defined?(ActiveRecord::Base) and ActiveRecord::Base.establish_connection\nend\n\n\ngit add .\ngit commit -am \"setup capistrano\"\ngit push -u origin master\n\ndb\u8a2d\u5b9a\n\ndatabase.yml\nstaging:\n  <<: *default\n  database: db/staging.sqlite3\n\n\ngit commit -am \"setup database\"\ngit push -u origin master\n\nMac\u2192VPS\u306e\u63a5\u7d9a\u306b\u5fc5\u8981\u306a\u9375\nhttp://www.tooyama.org/ssh-key.html\n\u3092\u53c2\u7167\u3057\u3064\u3064\n//local\nbrew install ssh-copy-id\nssh-copy-id -i ~/.ssh/id_rsa.pub deploy@xxx.xxx.xx.xx\n\u3067\u9001\u308b\n\n\u30b5\u30d6\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u5bfe\u5fdc\n\nconfig.ru\nrequire_relative 'config/environment'\n\n#run Rails.application\nif ENV['RAILS_RELATIVE_URL_ROOT']\n  map ENV['RAILS_RELATIVE_URL_ROOT'] do\n    run Rails.application\n  end\nelse\n  run Rails.application\nend\n\n\n\n\u79d8\u5bc6\u60c5\u5831\u5165\u308c\u308b\n.gitignore\u304b\u3089\u5916\u3057\u305fsecrets.yml\u306fshare\u306b\u7f6e\u304f\nvim staging/shared/config/secrets.yml\n\nstaging:\n  secret_key_base: xxxxxxxx\n\nrake secret\u3067\u4f5c\u308b\u306e\u304c\u3044\u3044\n\nnginx\u306e\u30e6\u30fc\u30b6\u30fc\u5909\u3048\u308b\n\n\u6a29\u9650\u5468\u308a\n13 permission error\u306b\u306a\u308b\u306e\u3067\nchmod 700 /home/deploy/\nchmod 700 /home/\n\u3068\u304b\u3067home\u3068deploy\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306b\u6a29\u9650\u4e0e\u3048\u3066\u304a\u304f(700\u3067\u3044\u3044\u304b\u306f\u77e5\u3089\u306a\u3044\n\n\u30c7\u30d7\u30ed\u30a4\nbundle exec cap staging deploy\n\n\u304a\u307e\u3051\n\n\u3088\u304f\u4f7f\u3046\u30b3\u30de\u30f3\u30c9\nless -r \u30d5\u30a1\u30a4\u30eb\u540d\n\u3067\u958b\u3044\u3066Shift+F\u3067\u66f4\u65b0\u5f85\u3061\u306b\u51fa\u6765\u308b\u3002\n\u30ed\u30b0\u30d5\u30a1\u30a4\u30eb\u3067\u3053\u308c\u3092\u3084\u3063\u3066\u304a\u3044\u3066\u30d6\u30e9\u30a6\u30b6\u3067\u66f4\u65b0\u304b\u3051\u305f\u308a\u3059\u308b\u3068\u3044\u3044\u611f\u3058\u306b\u30ed\u30b0\u304c\u62fe\u3048\u308b\nps -ef --forest | grep unicorn\n\u52d5\u3044\u3066\u308bunicorn\u30d7\u30ed\u30bb\u30b9\u3092\u51fa\u3059\nkill -9 1958\nps\u30b3\u30de\u30f3\u30c9\u3067\u53d6\u5f97\u3057\u305fID\u6307\u5b9a\u3059\u308c\u3070\u6bba\u305b\u308b\n\n\u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u5468\u308a\nhttps://dogmap.jp/2011/05/12/vps-security/\n\u306f\u6700\u4f4e\u9650\u3084\u3063\u3066\u304a\u3051\u3070\u5927\u4f53OK\n\n\u3042\u3068\u3067\n\u7dba\u9e97\u306b\u307e\u3068\u3081\u305f\u3044\n#\u69cb\u6210\nruby 2.3.1\nrails5\nunicorn\ncapistrano\nnginx\n\n\n\n#\u76ee\u6b21\n\n#\u624b\u9806\n\n##VPS\u306e\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\n\nhttp://vps.sakura.ad.jp/specification/\n\u304b\u3089\u597d\u304d\u306a\u69cb\u6210\u3092\u9078\u3093\u3067\u7533\u3057\u8fbc\u307f\u3002\n\n\u4eca\u56de\u306f\u4e00\u756a\u5c0f\u3055\u3044\u30d7\u30e9\u30f3512\u306b\u3057\u307e\u3057\u305f\u3002\n\n\u7533\u3057\u8fbc\u307f\u3092\u3057\u305f\u3089\n\nhttps://secure.sakura.ad.jp/vps/#/servers/\n\u306b\u30ed\u30b0\u30a4\u30f3\u3057\u3066\u6a19\u6e96OS\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u307e\u3059\u3002\n\n<img width=\"437\" alt=\"\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2016-10-23 2.29.01.png\" src=\"https://qiita-image-store.s3.amazonaws.com/0/24979/c21be551-96f7-ebe5-7d40-488043cb6b7e.png\">\n\nroot\u306e\u30d1\u30b9\u30ef\u30fc\u30c9\u3082\u3053\u3053\u3067\u8a2d\u5b9a\u3057\u307e\u3059\u3002\u5fd8\u308c\u306a\u3044\u3088\u3046\u306b\u30e1\u30e2\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\n<img width=\"639\" alt=\"\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2016-10-23 2.29.09.png\" src=\"https://qiita-image-store.s3.amazonaws.com/0/24979/c9234906-3834-55eb-2a66-0c97cd1525a9.png\">\n\n\n\u30b9\u30c6\u30fc\u30bf\u30b9\u304c\u7a3c\u50cd\u4e2d\u306b\u306a\u308b\u307e\u3067\u3057\u3070\u3089\u304f\u5f85\u3061\u307e\u3059\n\n<img width=\"190\" alt=\"\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2016-10-23 2.34.49.png\" src=\"https://qiita-image-store.s3.amazonaws.com/0/24979/8465b982-5000-2900-6982-cf9d2ba269c8.png\">\n\n\u307e\u305f\u3053\u306e\u30da\u30fc\u30b8\u306b\u8868\u793a\u3055\u308c\u3066\u3044\u308bIPv4\u30a2\u30c9\u30ec\u30b9\u304c\u5951\u7d04\u3057\u305fIP\u30a2\u30c9\u30ec\u30b9\u306b\u306a\u308a\u307e\u3059\u3002\n<img width=\"424\" alt=\"\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8_2016-10-23_2_36_57.png\" src=\"https://qiita-image-store.s3.amazonaws.com/0/24979/be8301a3-3bb8-cad6-1f05-a2d717fae2a0.png\">\n\n\u7a3c\u50cd\u4e2d\u30b9\u30c6\u30fc\u30bf\u30b9\u306b\u306a\u3063\u305f\u3089VNC\u30b3\u30f3\u30bd\u30fc\u30eb\u3092\u958b\u3044\u3066\u773a\u3081\u307e\u3059\u3002\n\n<img width=\"657\" alt=\"\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2016-10-23 3.08.15.png\" src=\"https://qiita-image-store.s3.amazonaws.com/0/24979/e8feaf4a-34b5-e0f6-1035-570041ab7295.png\">\n\n\u7d50\u69cb\u304b\u304b\u308b\u306e\u3067\u7d50\u69cb\u5f85\u3061\u307e\u3059\u3002\uff0820\u5206\u304f\u3089\u3044\u304b\u306a\n\u3061\u306a\u307f\u306b`Updating RPMS on system:`\u3068\u51fa\u3066\u3044\u3066\u56fa\u307e\u3063\u3066\u3044\u3066\u3082\u5927\u4e08\u592b\u3067\u3059\u3002\nhttps://blog.fudi55.net/archives/454.html\n\n`tk1_xxx_xxxx login: _`\u3068\u8868\u793a\u3055\u308c\u305f\u8868\u793a\u306b\u306a\u3063\u305f\u3089\u6b21\u306e\u30b9\u30c6\u30c3\u30d7\u306b\u9032\u307f\u307e\u3059\u3002\n\n\n##SSH\u3067\u30ed\u30b0\u30a4\u30f3\n\n\u3055\u304f\u3089\u306e\u30b5\u30fc\u30d0\u30fc\u306b\u30ed\u30b0\u30a4\u30f3\u3057\u307e\u3059\u3002terminal.app\u3092\u958b\u3044\u3066\n\n```bash:local\nssh root@xxx.xxx.xx.xx (xxx.xxx.xx.xx\u306f\u30b5\u30fc\u30d0\u306eIP\u30a2\u30c9\u30ec\u30b9\uff09\n```\n\n\u3067\u30ed\u30b0\u30a4\u30f3\u3057\u307e\u3059\u3002\u8cea\u554f\u306b\u306fyes\u3001OS\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u6642\u306b\u6c7a\u3081\u305f\u30d1\u30b9\u30ef\u30fc\u30c9\u3092\u5165\u529b\u3057\u307e\u3059\u3002\n\n> \u3053\u3053\u3067`WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED!`\u304c\u51fa\u308b\u5834\u5408\u306f\n> `ssh-keygen -R xxx.xxx.xx.xx`\n> \u3067\u30db\u30b9\u30c8\u304b\u3089\u8a2d\u5b9a\u3092\u6d88\u305b\u3070\u5148\u306b\u9032\u3081\u308b\u306f\u305a\u3067\u3059\u3002\n\n##\u30e6\u30fc\u30b6\u30fc\u306e\u4f5c\u6210\n\n\u30c7\u30d7\u30ed\u30a4\u7528\u306e\u30e6\u30fc\u30b6\u30fc\u3092\u4f5c\u3063\u3066\u304a\u304d\u307e\u3059\u3002\n\n```bash:vps\n~]# useradd deploy\n~]# passwd deploy\nNew password: \u30d1\u30b9\u30ef\u30fc\u30c9\u5165\u529b\n```\n\nvisudo\u3057\u3066\u30e6\u30fc\u30b6\u30fc\u6a29\u9650\u3092\u5e83\u3052\u3066\u304a\u304f\n```\ndeploy  ALL=(ALL)       ALL\n```\n\ndeploy\u30e6\u30fc\u30b6\u30fc\u3092wheel\u306b\u5165\u308c\u3066\u304a\u304f\n```\nusermod -G wheel deploy\n```\n\n\n##nginx\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n```bash:vps\n~]# rpm -ivh http://nginx.org/packages/centos/6/noarch/RPMS/nginx-release-centos-6-0.el6.ngx.noarch.rpm\n~]# yum -y install nginx\n```\n\ncd /etc/nginx/conf.d/\nmv default.conf default.conf.bak\n\nvim sample.conf\n```:sample.conf\nupstream staging {\n  server unix:/tmp/unicorn.staging.sock;\n}\n\nserver {\n  listen 80 default_server;\n  server_name xxx.xxx.xx.xx;\n\n  access_log /var/log/nginx/access.log;\n  error_log /var/log/nginx/error.log;\n\n  root /home/deploy/staging/current/;\n  location / {\n    location ^~ /staging {\n      proxy_pass http://staging;\n    }\n  }\n}\n~\n```\n\n##MySQL\n\n```\nyum install http://dev.mysql.com/get/mysql-community-release-el6-5.noarch.rpm\nyum install mysql mysql-devel mysql-server mysql-utilities\n```\n\n```\nyum install sqlite-devel\nyum install nodejs --enablerepo=epel\n```\n\n##rbenv\u3068ruby\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n\u4e0b\u6e96\u5099\n\n```bash.vps\nyum install gcc-c++ glibc-headers openssl-devel readline libyaml-devel readline-devel zlib zlib-devel\n```\n\nrbenv\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3068\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\n\n```bash:vps\n~]# git clone https://github.com/sstephenson/rbenv.git /usr/local/rbenv\n~]# git clone git://github.com/sstephenson/ruby-build.git /usr/local/rbenv/plugins/ruby-build\nchgrp -R wheel /usr/local/rbenv/\nchmod -R g+rwxXs /usr/local/rbenv/\nchmod -R g-s /path/to/rbenv\n```\n\nbash_profile\u306b\u8ffd\u8a18(deploy\u30e6\u30fc\u30b6\u30fc\u3082\u3084\u3063\u3066\u304a\u304f\uff09\n```\nexport RBENV_ROOT=\"/usr/local/rbenv\"\nexport PATH=\"${RBENV_ROOT}/bin:${PATH}\"\neval \"$(rbenv init --no-rehash -)\"\n```\n\nruby2.3.1\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n```bash:vps\n~]# rbenv install 2.3.1\n//~~~\u5f85\u3064\nrbenv global 2.3.1\nrbenv rehash\n```\n\n```\nyum install rubygems\n```\n\n```\ngem install sqlite3 -v '1.3.12'\n```\n\n##deploy\u30e6\u30fc\u30b6\u30fc\u306e\u516c\u958b\u9375\u306e\u4f5c\u6210\n\n\u4e00\u5ea6vps\u304b\u3089\u30ed\u30b0\u30a2\u30a6\u30c8\u3057\u3066deploy\u30e6\u30fc\u30b6\u30fc\u3067\u30ed\u30b0\u30a4\u30f3\u3057\u306a\u304a\u3057\u307e\u3059\u3002\n\n```\nexit\nssh deploy@xxx.xxx.xx.xx\n```\n\n```\nssh-keygen\n//enter\n```\n\n```\nless ~/.ssh/id_rsa.pub\n```\n\u30b3\u30d4\u30da\u3057\u3066q\u3067\u51fa\u308b\n\n##deploy\u30e6\u30fc\u30b6\u30fc\u306e\u516c\u958b\u9375\u306e\u767b\u9332\n\ngithub\u306a\u3089\nPersonal settings > personal > SSH and GPG keys\n\nbitbucket\u306a\u3089\nSSHKey\u306e\u767b\u9332\u304b\u3089\n\n##\u3064\u3044\u3067\u306b\u30ea\u30dd\u30b8\u30c8\u30ea\u3092\u4f5c\u308b\n\n<img width=\"779\" alt=\"\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2016-10-23 4.15.40.png\" src=\"https://qiita-image-store.s3.amazonaws.com/0/24979/d603530e-d286-52d0-8b4f-1f51133c47a6.png\">\n\n\n<img width=\"1006\" alt=\"\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2016-10-23 4.15.47.png\" src=\"https://qiita-image-store.s3.amazonaws.com/0/24979/e48047ef-f2f1-1a46-3cf2-69966ee81ce6.png\">\n\n\n##\u30c7\u30d7\u30ed\u30a4\u3059\u308b\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3092\u4f5c\u308b\n\n```\nrails new sample\ncd sample\n\ngit init\ngibo rails >> .gitignore\n```\n\nconfig/secrets.yml\u3092.gitignore\u306b\u8ffd\u8a18\u3059\u308b\n\n```\ngit add .\ngit commit -am \"first init\"\ngit remote add origin git@github.com:noppefoxwolf/sample-server.git\ngit push -u origin master\n\nbundle exec rails generate controller Welcome index\nbundle exec rails s\n```\n\nhttp://localhost:3000/welcome/index\n\u306b\u30a2\u30af\u30bb\u30b9\u3057\u3066\u307f\u308b\n\n<img width=\"352\" alt=\"\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2016-10-23 4.20.47.png\" src=\"https://qiita-image-store.s3.amazonaws.com/0/24979/bc5ee937-e6fc-3698-a4e7-56af5b8ff440.png\">\n\n\u3053\u308c\u304c\u3067\u308c\u3070OK\nCtrl+C\u3067\u30b5\u30fc\u30d0\u6b62\u3081\u308b\n\nGemfile\u306b\u4ee5\u4e0b\u3092\u8ffd\u8a18\n\n```\ngroup :development do\n  gem \"capistrano\"\n  gem 'capistrano-rails'\n  gem \"capistrano-rbenv\"\n  gem 'capistrano-bundler'\n  gem 'capistrano3-unicorn', :git => 'git@github.com:noppefoxwolf/capistrano3-unicorn.git'\nend\n\ngroup :production, :staging do\n  gem 'unicorn'\nend\n```\n\n`bundle update`\n\n`bundle exec cap install`\n\u8cea\u554f\u306fno\u3092\u9078\u3076\uff08ci\u74b0\u5883\u306e\u8a98\u5c0e\u307f\u305f\u3044\u306a\u3084\u3064\u306a\u306e\u3067\uff09\n\n\n```ruby:Capfile\nrequire \"capistrano/setup\"\nrequire \"capistrano/deploy\"\n\nrequire 'capistrano/rbenv'\nrequire 'capistrano/rails'\nrequire 'capistrano3/unicorn'\n\nset :linked_files, %w{config/secrets.yml}\n# Load custom tasks from `lib/capistrano/tasks` if you have any defined\nDir.glob(\"lib/capistrano/tasks/*.rake\").each { |r| import r }\n```\n\n```ruby:config/deploy/staging.rb\nset :pty, true\nserver 'xxx.xxx.xx.xx', user: 'deploy', roles: %w{app db web}\n\nset :linked_dirs, %w{bin log tmp/backup tmp/pids tmp/sockets vendor/bundle}\n\nshared_path = \"/home/deploy/staging/shared\"\nset :unicorn_pid, \"#{shared_path}/tmp/pids/unicorn.pid\"\nset :unicorn_options, -> { \"--path /staging\" }\nset :unicorn_exec, -> { \"unicorn_rails\" }\n```\n\n```ruby:config/deploy.rb\nlock '3.6.1'\n\nset :application, 'sample'\nset :repo_url, 'git@github.com:noppefoxwolf/sample-server.git'\nset :deploy_to, '/home/deploy/staging'\nset :pty, true\nset :scm, :git\nset :rbenv_ruby, '2.3.1'\nset :rbenv_type, :system\n\nafter 'deploy:publishing', 'deploy:restart'\nnamespace :deploy do\n  desc 'Restart application'\n  task :restart do\n    invoke 'unicorn:restart'\n  end\nend\n```\n\nmkdir config/unicorn\ntouch config/unicorn/staging.rb\n\n```ruby:config/unicorn/staging.rb\nbase = \"/home/deploy/staging\"\ncurrent_path = \"#{base}/current\"\nshared_path = \"#{base}/shared\"\nworking_directory current_path\n\nworker_processes 2\npreload_app true\ntimeout 30\n\nstderr_path \"#{current_path}/log/unicorn.stderr.log\"\nstdout_path \"#{current_path}/log/unicorn.stdout.log\"\nlisten \"/tmp/unicorn.staging.sock\"\npid \"#{shared_path}/tmp/pids/unicorn.pid\"\n\n#\u30c0\u30a6\u30f3\u30bf\u30a4\u30e0\u7121\u3057\npreload_app true\n\nbefore_fork do |server, worker|\n  ENV['BUNDLE_GEMFILE'] = File.expand_path('Gemfile', current_path)\n  old_pid = \"#{server.config[:pid]}.oldbin\"\n  if File.exists?(old_pid) && server.pid != old_pid\n    begin\n      sig = (worker.nr + 1) >= server.worker_processes ? :QUIT : :TTOU\n      Process.kill(sig, File.read(old_pid).to_i)\n    rescue Errno::ENOENT, Errno::ESRCH\n      # someone else did our job for us\n    end\n  end\nend\n\nafter_fork do |server, worker|\n  defined?(ActiveRecord::Base) and ActiveRecord::Base.establish_connection\nend\n```\n\ngit add .\ngit commit -am \"setup capistrano\"\ngit push -u origin master\n\n##db\u8a2d\u5b9a\n\n```database.yml\nstaging:\n  <<: *default\n  database: db/staging.sqlite3\n```\n\ngit commit -am \"setup database\"\ngit push -u origin master\n\n#Mac\u2192VPS\u306e\u63a5\u7d9a\u306b\u5fc5\u8981\u306a\u9375\nhttp://www.tooyama.org/ssh-key.html\n\u3092\u53c2\u7167\u3057\u3064\u3064\n\n//local\nbrew install ssh-copy-id\n\n`ssh-copy-id -i ~/.ssh/id_rsa.pub deploy@xxx.xxx.xx.xx`\n\n\u3067\u9001\u308b\n\n#\u30b5\u30d6\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u5bfe\u5fdc\n```:config.ru\nrequire_relative 'config/environment'\n\n#run Rails.application\nif ENV['RAILS_RELATIVE_URL_ROOT']\n  map ENV['RAILS_RELATIVE_URL_ROOT'] do\n    run Rails.application\n  end\nelse\n  run Rails.application\nend\n```\n\n#\u79d8\u5bc6\u60c5\u5831\u5165\u308c\u308b\n.gitignore\u304b\u3089\u5916\u3057\u305fsecrets.yml\u306fshare\u306b\u7f6e\u304f\n\n```\nvim staging/shared/config/secrets.yml\n```\n\n```\nstaging:\n  secret_key_base: xxxxxxxx\n```\n\nrake secret\u3067\u4f5c\u308b\u306e\u304c\u3044\u3044\n\n#nginx\u306e\u30e6\u30fc\u30b6\u30fc\u5909\u3048\u308b\n\n#\u6a29\u9650\u5468\u308a\n13 permission error\u306b\u306a\u308b\u306e\u3067\nchmod 700 /home/deploy/\nchmod 700 /home/\n\u3068\u304b\u3067home\u3068deploy\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306b\u6a29\u9650\u4e0e\u3048\u3066\u304a\u304f(700\u3067\u3044\u3044\u304b\u306f\u77e5\u3089\u306a\u3044\n\n#\u30c7\u30d7\u30ed\u30a4\n\n`bundle exec cap staging deploy`\n\n#\u304a\u307e\u3051\n\n##\u3088\u304f\u4f7f\u3046\u30b3\u30de\u30f3\u30c9\n\n`less -r \u30d5\u30a1\u30a4\u30eb\u540d`\n\u3067\u958b\u3044\u3066Shift+F\u3067\u66f4\u65b0\u5f85\u3061\u306b\u51fa\u6765\u308b\u3002\n\u30ed\u30b0\u30d5\u30a1\u30a4\u30eb\u3067\u3053\u308c\u3092\u3084\u3063\u3066\u304a\u3044\u3066\u30d6\u30e9\u30a6\u30b6\u3067\u66f4\u65b0\u304b\u3051\u305f\u308a\u3059\u308b\u3068\u3044\u3044\u611f\u3058\u306b\u30ed\u30b0\u304c\u62fe\u3048\u308b\n\n`ps -ef --forest | grep unicorn`\n\u52d5\u3044\u3066\u308bunicorn\u30d7\u30ed\u30bb\u30b9\u3092\u51fa\u3059\n\n`kill -9 1958`\nps\u30b3\u30de\u30f3\u30c9\u3067\u53d6\u5f97\u3057\u305fID\u6307\u5b9a\u3059\u308c\u3070\u6bba\u305b\u308b\n\n\n\n\n#\u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u5468\u308a\n\nhttps://dogmap.jp/2011/05/12/vps-security/\n\u306f\u6700\u4f4e\u9650\u3084\u3063\u3066\u304a\u3051\u3070\u5927\u4f53OK\n\n\n#\u3042\u3068\u3067\n\u7dba\u9e97\u306b\u307e\u3068\u3081\u305f\u3044\n", "tags": ["\u3055\u304f\u3089VPS", "unicorn", "capistrano", "nginx", "Rails"]}