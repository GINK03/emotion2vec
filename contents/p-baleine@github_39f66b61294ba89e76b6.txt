{"context": " More than 1 year has passed since last update.Backbone\u30d9\u30fc\u30b9\u306eORM Bokshelf\u306epolymorphic association\u3067\u3059\u3002\n$ mkdir bookshelf-polymorphic-association\n$ cd  bookshelf-polymorphic-association\n$ vi package.json\n\npackage.json:\n{\n  \"name\": \"bookshelf-polymorphic-association\",\n  \"version\": \"0.0.0\",\n  \"main\": \"index.js\",\n  \"dependencies\": {\n    \"bookshelf\": \"~0.6.1\",\n    \"knex\": \"git+https://github.com/tgriesser/knex.git\",\n    \"sqlite3\": \"~2.1.19\"\n  }\n}\n\n\u30e2\u30b8\u30e5\u30fc\u30eb\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb:\n$ npm install\n\n\n\u30c6\u30fc\u30d6\u30eb\u306e\u4f5c\u6210\nBookshelf\u304c\u5229\u7528\u3057\u3066\u3044\u308bknex\u304c\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u3092\u30b5\u30dd\u30fc\u30c8\u3057\u3066\u3044\u308b\u306e\u3067\u3053\u308c\u3092\u4f7f\u3044\u307e\u3059\u3002\n\n\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u306e\u4f5c\u6210\n$ mkdir db\n$ vi db/config.js\n\ndb/config.js:\nmodule.exports = {\n  directory: './db/migrations',\n  database: {\n    client: 'sqlite3',\n    connection: {\n      filename: './db/bookshelf-polymorphic-association.db'\n    }\n  }\n};\n\n\n\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u4f5c\u6210\n$ ./node_modules/.bin/knex migrate:make create -c ./db/config.js \n$ vi 20131130140239_create.js\n\n20131130140239_create.js:\nexports.up = function(knex, Promise) {\n  return Promise.all([\n    knex.schema.createTable('employees', function(t) {\n      t.increments('id').primary();\n      t.string('name');\n    }),\n\n    knex.schema.createTable('products', function(t) {\n      t.increments('id').primary();\n      t.string('name');\n    }),\n\n    knex.schema.createTable('pictures', function(t) {\n      t.increments('id').primary();\n      t.string('name');\n      t.integer('imageable_id').notNull();\n      t.string('imageable_type').notNull();\n    })\n  ]);\n};\n\nexports.down = function(knex, Promise) {\n  return Promise.all([\n    knex.schema.dropTable('employees'),\n\n    knex.schema.dropTable('products'),\n\n    knex.schema.dropTable('pictures')\n  ]);\n};\n\n\n\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u5b9f\u884c\n$ ./node_modules/.bin/knex migrate:latest -c ./db/config.js\n\n\n\u672c\u984c\nindex.js:\nvar config = require('./db/config').database,\n    Bookshelf = require('bookshelf').initialize(config);\n\nvar Employee = Bookshelf.Model.extend({\n  tableName: 'employees',\n  pictures: function() {\n    return this.morphMany(Picture, 'imageable');\n  }\n});\n\nvar Product = Bookshelf.Model.extend({\n  tableName: 'products',\n  pictures: function() {\n    return this.morphMany(Picture, 'imageable');\n  }\n});\n\nvar Picture = Bookshelf.Model.extend({\n  tableName: 'pictures',\n  imageable: function() {\n    return this.morphTo('imageable', Employee, Product);\n  }\n});\n\n// Employee\u3092\u4f5c\u6210\nnew Employee({ name: 'hoge' }).save()\n\n  // employee\u306ePicture\u3092\u4f5c\u6210\n  .then(function(employee) {\n    var picture = new Picture({\n      name: 'employee\\'s picture',\n      imageable_id: employee.id,\n      imageable_type: 'employees'\n    });\n\n    return [picture.save(), employee];\n  })\n\n  // employee\u3092Picture\u6bce\u30d5\u30a7\u30c3\u30c1\u3057\u3066\u307f\u308b\n  .spread(function(picture, employee) {\n    return employee.fetch({ withRelated: ['pictures'] });\n  })\n  .tap(function(employee) {\n    console.log(employee.toJSON());\n  })\n\n  // \u4eca\u5ea6\u306fProduct\u3092\u4f5c\u6210\n  .then(function() {\n    return new Product({ name: 'piyo' }).save();\n  })\n\n  // product\u306ePicture\u3092\u4f5c\u6210\n  .then(function(product) {\n    var picture = new Picture({\n      name: 'product\\'s picture',\n      imageable_id: product.id,\n      imageable_type: 'products'\n    });\n\n    return [picture.save(), product];\n  })\n\n  // product\u3092Picture\u6bce\u30d5\u30a7\u30c3\u30c1\u3057\u3066\u307f\u308b\n  .spread(function(picture, product) {\n    return product.fetch({ withRelated: ['pictures'] });\n  })\n  .tap(function(employee) {\n    console.log(employee.toJSON());\n  })\n\n  .then(function() {\n    process.exit();\n  });\n\n\n\u5b9f\u884c\n$ node index.js\n\nBackbone\u30d9\u30fc\u30b9\u306eORM [Bokshelf](http://bookshelfjs.org/)\u306e[polymorphic association](http://en.wikipedia.org/wiki/Polymorphic_association)\u3067\u3059\u3002\n\n```bash\n$ mkdir bookshelf-polymorphic-association\n$ cd  bookshelf-polymorphic-association\n$ vi package.json\n```\n\npackage.json:\n\n```json\n{\n  \"name\": \"bookshelf-polymorphic-association\",\n  \"version\": \"0.0.0\",\n  \"main\": \"index.js\",\n  \"dependencies\": {\n    \"bookshelf\": \"~0.6.1\",\n    \"knex\": \"git+https://github.com/tgriesser/knex.git\",\n    \"sqlite3\": \"~2.1.19\"\n  }\n}\n```\n\n\u30e2\u30b8\u30e5\u30fc\u30eb\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb:\n\n```bash\n$ npm install\n```\n\n## \u30c6\u30fc\u30d6\u30eb\u306e\u4f5c\u6210\n\nBookshelf\u304c\u5229\u7528\u3057\u3066\u3044\u308b[knex](http://knexjs.org/)\u304c\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u3092\u30b5\u30dd\u30fc\u30c8\u3057\u3066\u3044\u308b\u306e\u3067\u3053\u308c\u3092\u4f7f\u3044\u307e\u3059\u3002\n\n### \u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u306e\u4f5c\u6210\n\n```bash\n$ mkdir db\n$ vi db/config.js\n```\n\ndb/config.js:\n\n\n```js\nmodule.exports = {\n  directory: './db/migrations',\n  database: {\n    client: 'sqlite3',\n    connection: {\n      filename: './db/bookshelf-polymorphic-association.db'\n    }\n  }\n};\n```\n\n### \u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u4f5c\u6210\n\n```bash\n$ ./node_modules/.bin/knex migrate:make create -c ./db/config.js \n$ vi 20131130140239_create.js\n```\n\n20131130140239_create.js:\n\n\n```js\nexports.up = function(knex, Promise) {\n  return Promise.all([\n    knex.schema.createTable('employees', function(t) {\n      t.increments('id').primary();\n      t.string('name');\n    }),\n\n    knex.schema.createTable('products', function(t) {\n      t.increments('id').primary();\n      t.string('name');\n    }),\n\n    knex.schema.createTable('pictures', function(t) {\n      t.increments('id').primary();\n      t.string('name');\n      t.integer('imageable_id').notNull();\n      t.string('imageable_type').notNull();\n    })\n  ]);\n};\n\nexports.down = function(knex, Promise) {\n  return Promise.all([\n    knex.schema.dropTable('employees'),\n\n    knex.schema.dropTable('products'),\n\n    knex.schema.dropTable('pictures')\n  ]);\n};\n```\n\n### \u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u5b9f\u884c\n\n```bash\n$ ./node_modules/.bin/knex migrate:latest -c ./db/config.js\n```\n\n## \u672c\u984c\n\nindex.js:\n\n```js\nvar config = require('./db/config').database,\n    Bookshelf = require('bookshelf').initialize(config);\n\nvar Employee = Bookshelf.Model.extend({\n  tableName: 'employees',\n  pictures: function() {\n    return this.morphMany(Picture, 'imageable');\n  }\n});\n\nvar Product = Bookshelf.Model.extend({\n  tableName: 'products',\n  pictures: function() {\n    return this.morphMany(Picture, 'imageable');\n  }\n});\n\nvar Picture = Bookshelf.Model.extend({\n  tableName: 'pictures',\n  imageable: function() {\n    return this.morphTo('imageable', Employee, Product);\n  }\n});\n\n// Employee\u3092\u4f5c\u6210\nnew Employee({ name: 'hoge' }).save()\n\n  // employee\u306ePicture\u3092\u4f5c\u6210\n  .then(function(employee) {\n    var picture = new Picture({\n      name: 'employee\\'s picture',\n      imageable_id: employee.id,\n      imageable_type: 'employees'\n    });\n\n    return [picture.save(), employee];\n  })\n\n  // employee\u3092Picture\u6bce\u30d5\u30a7\u30c3\u30c1\u3057\u3066\u307f\u308b\n  .spread(function(picture, employee) {\n    return employee.fetch({ withRelated: ['pictures'] });\n  })\n  .tap(function(employee) {\n    console.log(employee.toJSON());\n  })\n\n  // \u4eca\u5ea6\u306fProduct\u3092\u4f5c\u6210\n  .then(function() {\n    return new Product({ name: 'piyo' }).save();\n  })\n\n  // product\u306ePicture\u3092\u4f5c\u6210\n  .then(function(product) {\n    var picture = new Picture({\n      name: 'product\\'s picture',\n      imageable_id: product.id,\n      imageable_type: 'products'\n    });\n\n    return [picture.save(), product];\n  })\n\n  // product\u3092Picture\u6bce\u30d5\u30a7\u30c3\u30c1\u3057\u3066\u307f\u308b\n  .spread(function(picture, product) {\n    return product.fetch({ withRelated: ['pictures'] });\n  })\n  .tap(function(employee) {\n    console.log(employee.toJSON());\n  })\n\n  .then(function() {\n    process.exit();\n  });\n```\n\n### \u5b9f\u884c\n\n```bash\n$ node index.js\n```", "tags": ["JavaScript", "knex", "ORM", "Node.js", "Bookshelf"]}