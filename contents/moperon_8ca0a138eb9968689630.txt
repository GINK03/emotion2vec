{"context": "2017/3/12\u8ffd\u8a18 : \u7d9a\u304d\u306e\u304a\u8a71\u3092\u3053\u3061\u3089\u306b\u66f8\u304d\u307e\u3057\u305f\u3002\nhttp://qiita.com/moperon/items/02ee2eef17e2ed2d769f\n\nTL;DR\n\u30a2\u30bd\u30b7\u30a8\u30fc\u30b7\u30e7\u30f3\u306e\u7247\u65b9\u3060\u3051readonly\u3068\u3057\u305f\u5834\u5408\u306e\u3001Rails 4\u30685\u3067\u306e\u52d5\u4f5c\u306e\u9055\u3044 \u3068\u5168\u304f\u540c\u3058\u30b7\u30c1\u30e5\u30a8\u30fc\u30b7\u30e7\u30f3\u306b\u79c1\u3082\u30cf\u30de\u3063\u3066\u3057\u307e\u3063\u305f\u306e\u3067\u3001Rails4.2\u304b\u3089Rails5\u3078\u306e\u30a2\u30c3\u30d7\u30b0\u30ec\u30fc\u30c9\u3092\u8ae6\u3081\u307e\u3057\u305f\u3002\n\n\u518d\u73fe\u624b\u9806\n\nRails\u30a2\u30d7\u30ea\u4f5c\u6210\n\u53c2\u8003 : \u30b7\u30b9\u30c6\u30e0\u306egem\u306brails\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u305b\u305arails new\u3059\u308b\n\u4f8b\u306b\u3088\u3063\u3066\u30a2\u30d7\u30ea\u4f5c\u308a\u307e\u3059\u3002\n$ mkdir has_many_through_readonly\n$ cd has_many_through_readonly\n$ echo 'source \"https://rubygems.org\"' > Gemfile\n$ echo 'gem \"rails\", \"4.2.6\"' >> Gemfile\n$ bundle install --path vendor/bundle\n$ bundle exec rails new .\n\n\u7d9a\u3044\u3066\u3001\u30e2\u30c7\u30eb\u3092\u4f5c\u308b\u3002User\u3068Role\u304c\u591a\u5bfe\u591a\u306e\u95a2\u4fc2\u306b\u3042\u308a\u3001Role\u306freadonly\u3067\u3042\u308b\u3068\u3044\u3046\u72b6\u614b\u3002\n$ bin/rails g model user\n$ bin/rails g model role\n$ bin/rails g model role_user user:references role:references\n\n\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u30e2\u30c7\u30eb\u3092\u4fee\u6b63\u3059\u308b\u3002\n\napp/models/user.rb\nclass User < ActiveRecord::Base\n  has_many :role_users\n  has_many :roles, through: :role_users\nend\n\n\n\napp/models/role_user.rb\nclass RoleUser < ActiveRecord::Base\n  belongs_to :user\n  belongs_to :role\nend\n\n\n\napp/models/role.rb\nclass Role < ActiveRecord::Base\n  has_many :role_users\n  has_many :roles, through: :role_users\n  def readonly?\n    true\n  end\nend\n\n\nrole.rb \u306ereadonly?\u304ctrue\u306a\u3068\u3053\u308d\u304c\u30dd\u30a4\u30f3\u30c8\u3002\n\u305d\u3057\u3066\u3001readonly\u306aRole\u306b\u3072\u3068\u3064\u30ec\u30b3\u30fc\u30c9\u3092\u8ffd\u52a0\u3057\u3066\u304a\u304f\u3002\n$ bin/rake db:migrate\n$ bin/rails dbconsole\nsqlite> insert into roles values(1, datetime('now'), datetime('now'));\nsqlite> .q\n\n\nRails4\u306e\u6319\u52d5\nRails4\u3067\u306f\u3053\u306e\u3088\u3046\u306a\u30a2\u30bd\u30b7\u30a8\u30fc\u30b7\u30e7\u30f3\u3067\u3042\u3063\u3066\u3082User\u3092\u8ffd\u52a0\u3059\u308b\u3053\u3068\u304c\u53ef\u80fd\u3067\u3057\u305f\u3002\nirb(main):001:0> role = Role.first\n  Role Load (0.6ms)  SELECT  \"roles\".* FROM \"roles\"  ORDER BY \"roles\".\"id\" ASC LIMIT 1\n=> #<Role id: 1, created_at: \"2017-02-17 23:21:22\", updated_at: \"2017-02-17 23:21:22\">\nirb(main):002:0> user = User.create(roles: [role])\n   (0.1ms)  begin transaction\n  SQL (0.9ms)  INSERT INTO \"users\" (\"created_at\", \"updated_at\") VALUES (?, ?)  [[\"created_at\", \"2017-02-17 23:22:23.717950\"], [\"updated_at\", \"2017-02-17 23:22:23.717950\"]]\n  SQL (0.7ms)  INSERT INTO \"role_users\" (\"role_id\", \"user_id\", \"created_at\", \"updated_at\") VALUES (?, ?, ?, ?)  [[\"role_id\", 1], [\"user_id\", 1], [\"created_at\", \"2017-02-17 23:22:23.724668\"], [\"updated_at\", \"2017-02-17 23:22:23.724668\"]]\n   (1.0ms)  commit transaction\n=> #<User id: 1, created_at: \"2017-02-17 23:22:23\", updated_at: \"2017-02-17 23:22:23\">\nirb(main):003:0>\n\n\nRails5\u3078\u30a2\u30c3\u30d7\u30b0\u30ec\u30fc\u30c9\n\u53c2\u8003 : Rails 5\u3078\u306e\u30a2\u30c3\u30d7\u30b0\u30ec\u30fc\u30c9\u624b\u9806\u30e1\u30e2(Rails 4.2.6 => 5.0.0)\n\nGemfile\ngem 'rails', '~> 5.0'\n\n\n$ bundle update rails\n$ bin/rails app:update\n\n\u30e2\u30c7\u30eb\u30af\u30e9\u30b9\u306e\u7d99\u627f\u95a2\u4fc2\u3092\u5909\u66f4\u3059\u308b\u3002\n\napp/models/application_record.rb\nclass ApplicationRecord < ActiveRecord::Base\n  self.abstract_class = true\nend\n\n\n\napp/models/user.rb\nclass User < ApplicationRecord\n...snip...\n\n\n\napp/models/role_user.rb\nclass RoleUser < ApplicationRecord\n...snip...\n\n\n\napp/models/role.rb\nclass Role < ApplicationRecord\n...snip...\n\n\n\nRails5\u3067\u306e\u6319\u52d5\nirb(main):001:0> role = Role.first\n  Role Load (0.7ms)  SELECT  \"roles\".* FROM \"roles\" ORDER BY \"roles\".\"id\" ASC LIMIT ?  [[\"LIMIT\", 1]]\n=> #<Role id: 1, created_at: \"2017-02-17 23:21:22\", updated_at: \"2017-02-17 23:21:22\">\nirb(main):002:0> user = User.create(roles: [role])\n   (0.1ms)  begin transaction\n  SQL (1.0ms)  INSERT INTO \"users\" (\"created_at\", \"updated_at\") VALUES (?, ?)  [[\"created_at\", 2017-02-18 00:17:01 UTC], [\"updated_at\", 2017-02-18 00:17:01 UTC]]\n  SQL (0.9ms)  INSERT INTO \"role_users\" (\"user_id\", \"role_id\", \"created_at\", \"updated_at\") VALUES (?, ?, ?, ?)  [[\"user_id\", 3], [\"role_id\", 1], [\"created_at\", 2017-02-18 00:17:01 UTC], [\"updated_at\", 2017-02-18 00:17:01 UTC]]\n   (0.4ms)  rollback transaction\nActiveRecord::ReadOnlyRecord: Role is marked as readonly\n...snip...\n\npry\u3067backtrace\u3068\u3063\u3066\u307f\u305f\u7d50\u679c\u306f\u3053\u3061\u3089\u3002\n[1] pry(main)> role = Role.first\n  Role Load (0.3ms)  SELECT  \"roles\".* FROM \"roles\" ORDER BY \"roles\".\"id\" ASC LIMIT ?  [[\"LIMIT\", 1]]\n=> #<Role:0x007f95acea3258 id: 1, created_at: Fri, 17 Feb 2017 23:21:22 UTC +00:00, updated_at: Fri, 17 Feb 2017 23:21:22 UTC +00:00>\n[2] pry(main)> user = User.create(roles: [role])\n   (0.1ms)  begin transaction\n  SQL (0.5ms)  INSERT INTO \"users\" (\"created_at\", \"updated_at\") VALUES (?, ?)  [[\"created_at\", 2017-02-18 00:29:14 UTC], [\"updated_at\", 2017-02-18 00:29:14 UTC]]\n  SQL (0.3ms)  INSERT INTO \"role_users\" (\"user_id\", \"role_id\", \"created_at\", \"updated_at\") VALUES (?, ?, ?, ?)  [[\"user_id\", 5], [\"role_id\", 1], [\"created_at\", 2017-02-18 00:29:14 UTC], [\"updated_at\", 2017-02-18 00:29:14 UTC]]\n   (0.5ms)  rollback transaction\nActiveRecord::ReadOnlyRecord: Role is marked as readonly\nfrom /Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activerecord-5.0.1/lib/active_record/persistence.rb:539:in `create_or_update'\n[3] pry(main)> puts _ex_.backtrace\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activerecord-5.0.1/lib/active_record/persistence.rb:539:in `create_or_update'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activerecord-5.0.1/lib/active_record/callbacks.rb:298:in `block in create_or_update'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activesupport-5.0.1/lib/active_support/callbacks.rb:126:in `call'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activesupport-5.0.1/lib/active_support/callbacks.rb:506:in `block (2 levels) in compile'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activesupport-5.0.1/lib/active_support/callbacks.rb:455:in `call'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activesupport-5.0.1/lib/active_support/callbacks.rb:101:in `__run_callbacks__'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activesupport-5.0.1/lib/active_support/callbacks.rb:750:in `_run_save_callbacks'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activerecord-5.0.1/lib/active_record/callbacks.rb:298:in `create_or_update'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activerecord-5.0.1/lib/active_record/persistence.rb:125:in `save'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activerecord-5.0.1/lib/active_record/validations.rb:44:in `save'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activerecord-5.0.1/lib/active_record/attribute_methods/dirty.rb:22:in `save'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activerecord-5.0.1/lib/active_record/transactions.rb:319:in `block (2 levels) in save'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activerecord-5.0.1/lib/active_record/transactions.rb:395:in `block in with_transaction_returning_status'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activerecord-5.0.1/lib/active_record/connection_adapters/abstract/database_statements.rb:230:in `transaction'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activerecord-5.0.1/lib/active_record/transactions.rb:211:in `transaction'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activerecord-5.0.1/lib/active_record/transactions.rb:392:in `with_transaction_returning_status'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activerecord-5.0.1/lib/active_record/transactions.rb:319:in `block in save'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activerecord-5.0.1/lib/active_record/transactions.rb:334:in `rollback_active_record_state!'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activerecord-5.0.1/lib/active_record/transactions.rb:318:in `save'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activerecord-5.0.1/lib/active_record/suppressor.rb:41:in `save'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activerecord-5.0.1/lib/active_record/associations/has_many_through_association.rb:44:in `insert_record'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activerecord-5.0.1/lib/active_record/autosave_association.rb:402:in `block in save_collection_association'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activerecord-5.0.1/lib/active_record/autosave_association.rb:393:in `each'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activerecord-5.0.1/lib/active_record/autosave_association.rb:393:in `save_collection_association'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activerecord-5.0.1/lib/active_record/autosave_association.rb:185:in `block in add_autosave_association_callbacks'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activerecord-5.0.1/lib/active_record/autosave_association.rb:158:in `instance_eval'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activerecord-5.0.1/lib/active_record/autosave_association.rb:158:in `block in define_non_cyclic_method'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activesupport-5.0.1/lib/active_support/callbacks.rb:382:in `block in make_lambda'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activesupport-5.0.1/lib/active_support/callbacks.rb:207:in `block in halting_and_conditional'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activesupport-5.0.1/lib/active_support/callbacks.rb:456:in `block in call'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activesupport-5.0.1/lib/active_support/callbacks.rb:456:in `each'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activesupport-5.0.1/lib/active_support/callbacks.rb:456:in `call'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activesupport-5.0.1/lib/active_support/callbacks.rb:101:in `__run_callbacks__'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activesupport-5.0.1/lib/active_support/callbacks.rb:750:in `_run_create_callbacks'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activerecord-5.0.1/lib/active_record/callbacks.rb:302:in `_create_record'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activerecord-5.0.1/lib/active_record/timestamp.rb:68:in `_create_record'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activerecord-5.0.1/lib/active_record/persistence.rb:540:in `create_or_update'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activerecord-5.0.1/lib/active_record/callbacks.rb:298:in `block in create_or_update'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activesupport-5.0.1/lib/active_support/callbacks.rb:126:in `call'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activesupport-5.0.1/lib/active_support/callbacks.rb:506:in `block (2 levels) in compile'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activesupport-5.0.1/lib/active_support/callbacks.rb:455:in `call'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activesupport-5.0.1/lib/active_support/callbacks.rb:101:in `__run_callbacks__'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activesupport-5.0.1/lib/active_support/callbacks.rb:750:in `_run_save_callbacks'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activerecord-5.0.1/lib/active_record/callbacks.rb:298:in `create_or_update'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activerecord-5.0.1/lib/active_record/persistence.rb:125:in `save'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activerecord-5.0.1/lib/active_record/validations.rb:44:in `save'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activerecord-5.0.1/lib/active_record/attribute_methods/dirty.rb:22:in `save'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activerecord-5.0.1/lib/active_record/transactions.rb:319:in `block (2 levels) in save'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activerecord-5.0.1/lib/active_record/transactions.rb:395:in `block in with_transaction_returning_status'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activerecord-5.0.1/lib/active_record/connection_adapters/abstract/database_statements.rb:232:in `block in transaction'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activerecord-5.0.1/lib/active_record/connection_adapters/abstract/transaction.rb:189:in `within_new_transaction'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activerecord-5.0.1/lib/active_record/connection_adapters/abstract/database_statements.rb:232:in `transaction'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activerecord-5.0.1/lib/active_record/transactions.rb:211:in `transaction'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activerecord-5.0.1/lib/active_record/transactions.rb:392:in `with_transaction_returning_status'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activerecord-5.0.1/lib/active_record/transactions.rb:319:in `block in save'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activerecord-5.0.1/lib/active_record/transactions.rb:334:in `rollback_active_record_state!'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activerecord-5.0.1/lib/active_record/transactions.rb:318:in `save'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activerecord-5.0.1/lib/active_record/suppressor.rb:41:in `save'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activerecord-5.0.1/lib/active_record/persistence.rb:34:in `create'\n(pry):2:in `<main>'\n...snip...\n\n\u3068\u3044\u3046\u308f\u3051\u3067\u3001Rails4\u3067\u52d5\u3044\u3066\u3044\u305f\u30b3\u30fc\u30c9\u304cRails5\u3067\u306f\u52d5\u304b\u306a\u304f\u306a\u308a\u307e\u3057\u305f\u3002\nusers\u3068role_users\u306bINSERT\u3057\u305f\u5f8c\u3067\u3001\u306a\u305crole\u3092create_or_update\u3057\u3088\u3046\u3068\u3057\u3066\u3044\u308b\u306e\u304b\u8b0e\u3067\u3059\u3002\n\u539f\u56e0\u3092\u8ffd\u3044\u304b\u3051\u3066\u307f\u305f\u306e\u3067\u3059\u304c\u3001\u8ffd\u3044\u304d\u308c\u305a\u3002\u5fc3\u6298\u308c\u305f\u306e\u3067\u8a66\u5408\u7d42\u4e86\u3067\u3059\u3002\n\u3057\u3070\u3089\u304f\u5bdd\u304b\u305b\u3066\u304b\u3089\u307e\u305f\u8abf\u3079\u307e\u3059\u3002\n\u304a\u75b2\u308c\u69d8\u3067\u3057\u305f\u3002\n\n2017/3/12\u8ffd\u8a18 : \u7d9a\u304d\u306e\u304a\u8a71\u3092\u3053\u3061\u3089\u306b\u66f8\u304d\u307e\u3057\u305f\u3002\nhttp://qiita.com/moperon/items/02ee2eef17e2ed2d769f\n\n# TL;DR\n\n[\u30a2\u30bd\u30b7\u30a8\u30fc\u30b7\u30e7\u30f3\u306e\u7247\u65b9\u3060\u3051readonly\u3068\u3057\u305f\u5834\u5408\u306e\u3001Rails 4\u30685\u3067\u306e\u52d5\u4f5c\u306e\u9055\u3044](https://teratail.com/questions/52290) \u3068\u5168\u304f\u540c\u3058\u30b7\u30c1\u30e5\u30a8\u30fc\u30b7\u30e7\u30f3\u306b\u79c1\u3082\u30cf\u30de\u3063\u3066\u3057\u307e\u3063\u305f\u306e\u3067\u3001Rails4.2\u304b\u3089Rails5\u3078\u306e\u30a2\u30c3\u30d7\u30b0\u30ec\u30fc\u30c9\u3092\u8ae6\u3081\u307e\u3057\u305f\u3002\n\n# \u518d\u73fe\u624b\u9806\n## Rails\u30a2\u30d7\u30ea\u4f5c\u6210\n\u53c2\u8003 : [\u30b7\u30b9\u30c6\u30e0\u306egem\u306brails\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u305b\u305arails new\u3059\u308b](http://qiita.com/youcune/items/222777415f00d19cccb4)\n\n\u4f8b\u306b\u3088\u3063\u3066\u30a2\u30d7\u30ea\u4f5c\u308a\u307e\u3059\u3002\n\n```\n$ mkdir has_many_through_readonly\n$ cd has_many_through_readonly\n$ echo 'source \"https://rubygems.org\"' > Gemfile\n$ echo 'gem \"rails\", \"4.2.6\"' >> Gemfile\n$ bundle install --path vendor/bundle\n$ bundle exec rails new .\n```\n\n\u7d9a\u3044\u3066\u3001\u30e2\u30c7\u30eb\u3092\u4f5c\u308b\u3002User\u3068Role\u304c\u591a\u5bfe\u591a\u306e\u95a2\u4fc2\u306b\u3042\u308a\u3001Role\u306freadonly\u3067\u3042\u308b\u3068\u3044\u3046\u72b6\u614b\u3002\n\n```\n$ bin/rails g model user\n$ bin/rails g model role\n$ bin/rails g model role_user user:references role:references\n```\n\n\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u30e2\u30c7\u30eb\u3092\u4fee\u6b63\u3059\u308b\u3002\n\n```rb:app/models/user.rb\nclass User < ActiveRecord::Base\n  has_many :role_users\n  has_many :roles, through: :role_users\nend\n```\n\n```rb:app/models/role_user.rb\nclass RoleUser < ActiveRecord::Base\n  belongs_to :user\n  belongs_to :role\nend\n```\n\n```rb:app/models/role.rb\nclass Role < ActiveRecord::Base\n  has_many :role_users\n  has_many :roles, through: :role_users\n  def readonly?\n    true\n  end\nend\n```\n\n```role.rb``` \u306ereadonly?\u304ctrue\u306a\u3068\u3053\u308d\u304c\u30dd\u30a4\u30f3\u30c8\u3002\n\n\u305d\u3057\u3066\u3001readonly\u306aRole\u306b\u3072\u3068\u3064\u30ec\u30b3\u30fc\u30c9\u3092\u8ffd\u52a0\u3057\u3066\u304a\u304f\u3002\n\n```\n$ bin/rake db:migrate\n$ bin/rails dbconsole\nsqlite> insert into roles values(1, datetime('now'), datetime('now'));\nsqlite> .q\n```\n\n## Rails4\u306e\u6319\u52d5\nRails4\u3067\u306f\u3053\u306e\u3088\u3046\u306a\u30a2\u30bd\u30b7\u30a8\u30fc\u30b7\u30e7\u30f3\u3067\u3042\u3063\u3066\u3082User\u3092\u8ffd\u52a0\u3059\u308b\u3053\u3068\u304c\u53ef\u80fd\u3067\u3057\u305f\u3002\n\n```irb\nirb(main):001:0> role = Role.first\n  Role Load (0.6ms)  SELECT  \"roles\".* FROM \"roles\"  ORDER BY \"roles\".\"id\" ASC LIMIT 1\n=> #<Role id: 1, created_at: \"2017-02-17 23:21:22\", updated_at: \"2017-02-17 23:21:22\">\nirb(main):002:0> user = User.create(roles: [role])\n   (0.1ms)  begin transaction\n  SQL (0.9ms)  INSERT INTO \"users\" (\"created_at\", \"updated_at\") VALUES (?, ?)  [[\"created_at\", \"2017-02-17 23:22:23.717950\"], [\"updated_at\", \"2017-02-17 23:22:23.717950\"]]\n  SQL (0.7ms)  INSERT INTO \"role_users\" (\"role_id\", \"user_id\", \"created_at\", \"updated_at\") VALUES (?, ?, ?, ?)  [[\"role_id\", 1], [\"user_id\", 1], [\"created_at\", \"2017-02-17 23:22:23.724668\"], [\"updated_at\", \"2017-02-17 23:22:23.724668\"]]\n   (1.0ms)  commit transaction\n=> #<User id: 1, created_at: \"2017-02-17 23:22:23\", updated_at: \"2017-02-17 23:22:23\">\nirb(main):003:0>\n```\n\n## Rails5\u3078\u30a2\u30c3\u30d7\u30b0\u30ec\u30fc\u30c9\n\u53c2\u8003 : [Rails 5\u3078\u306e\u30a2\u30c3\u30d7\u30b0\u30ec\u30fc\u30c9\u624b\u9806\u30e1\u30e2(Rails 4.2.6 => 5.0.0)](http://qiita.com/ryo511/items/2a387df126268fec8c78)\n\n```rb:Gemfile\ngem 'rails', '~> 5.0'\n```\n\n```\n$ bundle update rails\n$ bin/rails app:update\n```\n\n\u30e2\u30c7\u30eb\u30af\u30e9\u30b9\u306e\u7d99\u627f\u95a2\u4fc2\u3092\u5909\u66f4\u3059\u308b\u3002\n\n```rb:app/models/application_record.rb\nclass ApplicationRecord < ActiveRecord::Base\n  self.abstract_class = true\nend\n```\n```rb:app/models/user.rb\nclass User < ApplicationRecord\n...snip...\n```\n```rb:app/models/role_user.rb\nclass RoleUser < ApplicationRecord\n...snip...\n```\n```rb:app/models/role.rb\nclass Role < ApplicationRecord\n...snip...\n```\n\n## Rails5\u3067\u306e\u6319\u52d5\n```irb\nirb(main):001:0> role = Role.first\n  Role Load (0.7ms)  SELECT  \"roles\".* FROM \"roles\" ORDER BY \"roles\".\"id\" ASC LIMIT ?  [[\"LIMIT\", 1]]\n=> #<Role id: 1, created_at: \"2017-02-17 23:21:22\", updated_at: \"2017-02-17 23:21:22\">\nirb(main):002:0> user = User.create(roles: [role])\n   (0.1ms)  begin transaction\n  SQL (1.0ms)  INSERT INTO \"users\" (\"created_at\", \"updated_at\") VALUES (?, ?)  [[\"created_at\", 2017-02-18 00:17:01 UTC], [\"updated_at\", 2017-02-18 00:17:01 UTC]]\n  SQL (0.9ms)  INSERT INTO \"role_users\" (\"user_id\", \"role_id\", \"created_at\", \"updated_at\") VALUES (?, ?, ?, ?)  [[\"user_id\", 3], [\"role_id\", 1], [\"created_at\", 2017-02-18 00:17:01 UTC], [\"updated_at\", 2017-02-18 00:17:01 UTC]]\n   (0.4ms)  rollback transaction\nActiveRecord::ReadOnlyRecord: Role is marked as readonly\n...snip...\n```\n\npry\u3067backtrace\u3068\u3063\u3066\u307f\u305f\u7d50\u679c\u306f\u3053\u3061\u3089\u3002\n\n```\n[1] pry(main)> role = Role.first\n  Role Load (0.3ms)  SELECT  \"roles\".* FROM \"roles\" ORDER BY \"roles\".\"id\" ASC LIMIT ?  [[\"LIMIT\", 1]]\n=> #<Role:0x007f95acea3258 id: 1, created_at: Fri, 17 Feb 2017 23:21:22 UTC +00:00, updated_at: Fri, 17 Feb 2017 23:21:22 UTC +00:00>\n[2] pry(main)> user = User.create(roles: [role])\n   (0.1ms)  begin transaction\n  SQL (0.5ms)  INSERT INTO \"users\" (\"created_at\", \"updated_at\") VALUES (?, ?)  [[\"created_at\", 2017-02-18 00:29:14 UTC], [\"updated_at\", 2017-02-18 00:29:14 UTC]]\n  SQL (0.3ms)  INSERT INTO \"role_users\" (\"user_id\", \"role_id\", \"created_at\", \"updated_at\") VALUES (?, ?, ?, ?)  [[\"user_id\", 5], [\"role_id\", 1], [\"created_at\", 2017-02-18 00:29:14 UTC], [\"updated_at\", 2017-02-18 00:29:14 UTC]]\n   (0.5ms)  rollback transaction\nActiveRecord::ReadOnlyRecord: Role is marked as readonly\nfrom /Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activerecord-5.0.1/lib/active_record/persistence.rb:539:in `create_or_update'\n[3] pry(main)> puts _ex_.backtrace\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activerecord-5.0.1/lib/active_record/persistence.rb:539:in `create_or_update'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activerecord-5.0.1/lib/active_record/callbacks.rb:298:in `block in create_or_update'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activesupport-5.0.1/lib/active_support/callbacks.rb:126:in `call'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activesupport-5.0.1/lib/active_support/callbacks.rb:506:in `block (2 levels) in compile'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activesupport-5.0.1/lib/active_support/callbacks.rb:455:in `call'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activesupport-5.0.1/lib/active_support/callbacks.rb:101:in `__run_callbacks__'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activesupport-5.0.1/lib/active_support/callbacks.rb:750:in `_run_save_callbacks'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activerecord-5.0.1/lib/active_record/callbacks.rb:298:in `create_or_update'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activerecord-5.0.1/lib/active_record/persistence.rb:125:in `save'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activerecord-5.0.1/lib/active_record/validations.rb:44:in `save'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activerecord-5.0.1/lib/active_record/attribute_methods/dirty.rb:22:in `save'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activerecord-5.0.1/lib/active_record/transactions.rb:319:in `block (2 levels) in save'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activerecord-5.0.1/lib/active_record/transactions.rb:395:in `block in with_transaction_returning_status'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activerecord-5.0.1/lib/active_record/connection_adapters/abstract/database_statements.rb:230:in `transaction'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activerecord-5.0.1/lib/active_record/transactions.rb:211:in `transaction'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activerecord-5.0.1/lib/active_record/transactions.rb:392:in `with_transaction_returning_status'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activerecord-5.0.1/lib/active_record/transactions.rb:319:in `block in save'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activerecord-5.0.1/lib/active_record/transactions.rb:334:in `rollback_active_record_state!'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activerecord-5.0.1/lib/active_record/transactions.rb:318:in `save'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activerecord-5.0.1/lib/active_record/suppressor.rb:41:in `save'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activerecord-5.0.1/lib/active_record/associations/has_many_through_association.rb:44:in `insert_record'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activerecord-5.0.1/lib/active_record/autosave_association.rb:402:in `block in save_collection_association'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activerecord-5.0.1/lib/active_record/autosave_association.rb:393:in `each'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activerecord-5.0.1/lib/active_record/autosave_association.rb:393:in `save_collection_association'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activerecord-5.0.1/lib/active_record/autosave_association.rb:185:in `block in add_autosave_association_callbacks'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activerecord-5.0.1/lib/active_record/autosave_association.rb:158:in `instance_eval'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activerecord-5.0.1/lib/active_record/autosave_association.rb:158:in `block in define_non_cyclic_method'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activesupport-5.0.1/lib/active_support/callbacks.rb:382:in `block in make_lambda'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activesupport-5.0.1/lib/active_support/callbacks.rb:207:in `block in halting_and_conditional'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activesupport-5.0.1/lib/active_support/callbacks.rb:456:in `block in call'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activesupport-5.0.1/lib/active_support/callbacks.rb:456:in `each'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activesupport-5.0.1/lib/active_support/callbacks.rb:456:in `call'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activesupport-5.0.1/lib/active_support/callbacks.rb:101:in `__run_callbacks__'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activesupport-5.0.1/lib/active_support/callbacks.rb:750:in `_run_create_callbacks'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activerecord-5.0.1/lib/active_record/callbacks.rb:302:in `_create_record'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activerecord-5.0.1/lib/active_record/timestamp.rb:68:in `_create_record'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activerecord-5.0.1/lib/active_record/persistence.rb:540:in `create_or_update'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activerecord-5.0.1/lib/active_record/callbacks.rb:298:in `block in create_or_update'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activesupport-5.0.1/lib/active_support/callbacks.rb:126:in `call'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activesupport-5.0.1/lib/active_support/callbacks.rb:506:in `block (2 levels) in compile'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activesupport-5.0.1/lib/active_support/callbacks.rb:455:in `call'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activesupport-5.0.1/lib/active_support/callbacks.rb:101:in `__run_callbacks__'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activesupport-5.0.1/lib/active_support/callbacks.rb:750:in `_run_save_callbacks'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activerecord-5.0.1/lib/active_record/callbacks.rb:298:in `create_or_update'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activerecord-5.0.1/lib/active_record/persistence.rb:125:in `save'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activerecord-5.0.1/lib/active_record/validations.rb:44:in `save'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activerecord-5.0.1/lib/active_record/attribute_methods/dirty.rb:22:in `save'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activerecord-5.0.1/lib/active_record/transactions.rb:319:in `block (2 levels) in save'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activerecord-5.0.1/lib/active_record/transactions.rb:395:in `block in with_transaction_returning_status'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activerecord-5.0.1/lib/active_record/connection_adapters/abstract/database_statements.rb:232:in `block in transaction'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activerecord-5.0.1/lib/active_record/connection_adapters/abstract/transaction.rb:189:in `within_new_transaction'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activerecord-5.0.1/lib/active_record/connection_adapters/abstract/database_statements.rb:232:in `transaction'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activerecord-5.0.1/lib/active_record/transactions.rb:211:in `transaction'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activerecord-5.0.1/lib/active_record/transactions.rb:392:in `with_transaction_returning_status'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activerecord-5.0.1/lib/active_record/transactions.rb:319:in `block in save'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activerecord-5.0.1/lib/active_record/transactions.rb:334:in `rollback_active_record_state!'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activerecord-5.0.1/lib/active_record/transactions.rb:318:in `save'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activerecord-5.0.1/lib/active_record/suppressor.rb:41:in `save'\n/Users/moperon/has_many_through_readonly/vendor/bundle/ruby/2.3.0/gems/activerecord-5.0.1/lib/active_record/persistence.rb:34:in `create'\n(pry):2:in `<main>'\n...snip...\n```\n\n\u3068\u3044\u3046\u308f\u3051\u3067\u3001Rails4\u3067\u52d5\u3044\u3066\u3044\u305f\u30b3\u30fc\u30c9\u304cRails5\u3067\u306f\u52d5\u304b\u306a\u304f\u306a\u308a\u307e\u3057\u305f\u3002\n```users```\u3068```role_users```\u306bINSERT\u3057\u305f\u5f8c\u3067\u3001\u306a\u305c```role```\u3092```create_or_update```\u3057\u3088\u3046\u3068\u3057\u3066\u3044\u308b\u306e\u304b\u8b0e\u3067\u3059\u3002\n\n\u539f\u56e0\u3092\u8ffd\u3044\u304b\u3051\u3066\u307f\u305f\u306e\u3067\u3059\u304c\u3001\u8ffd\u3044\u304d\u308c\u305a\u3002\u5fc3\u6298\u308c\u305f\u306e\u3067\u8a66\u5408\u7d42\u4e86\u3067\u3059\u3002\n\u3057\u3070\u3089\u304f\u5bdd\u304b\u305b\u3066\u304b\u3089\u307e\u305f\u8abf\u3079\u307e\u3059\u3002\n\n\u304a\u75b2\u308c\u69d8\u3067\u3057\u305f\u3002\n", "tags": ["Rails5", "Rails", "ActiveRecord"]}