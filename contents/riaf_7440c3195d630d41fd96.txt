{"context": " More than 1 year has passed since last update.Qiita \u304c\u9811\u5f35\u3063\u3066\u3044\u308b\u306e\u3067\u50d5\u3082\u9811\u5f35\u308d\u3046\u3068\u304a\u3082\u3044\u307e\u3057\u305f\u3002\n\u307e\u305a\u306f log.sqlite \u3068\u304b\u306b DB \u3064\u304f\u308a\u307e\u3059\u3088\u3002\n\ninstall.sql\nCREATE TABLE IF NOT EXISTS log (\n  current TEXT,\n  push TEXT,\n  created_at DATETIME\n);\n\n\n\u3067\u3001\u3053\u3093\u306a\u30b9\u30af\u30ea\u30d7\u30c8\u3092 cron \u3068\u304b\u3067\u52d5\u304b\u3057\u307e\u3059\u3088\u3002\n\u52e2\u3044\u3067\u66f8\u3044\u305f\u304b\u3089\u7f8e\u3057\u304f\u306a\u3044\u3051\u3069\u3001\u8a31\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\nfbhealth.php\n<?php\nrequire_once 'Net/Socket/Tiarra.php';\n\n$api_uri       = 'http://www.facebook.com/feeds/api_status.php';\n$db            = __DIR__ . '/log.sqlite';\n$pdo           = new PDO(\"sqlite:$db\");\n$tiarra_socket = 'riaf';\n$irc_channel   = '#nequal@freenode';\n\n$last_row = $pdo->query('SELECT * FROM log ORDER BY created_at DESC')->fetch(PDO::FETCH_ASSOC);\n\nif ($last_row) {\n    $last = array(\n        'current'    => json_decode($last_row['current'], true),\n        'push'       => json_decode($last_row['push'], true),\n        'created_at' => new DateTime($last_row['created_at']),\n    );\n} else {\n    $last = null;\n}\n\n$now = new DateTime;\n$response = json_decode(file_get_contents($api_uri), true);\n\ntry {\n    if (!isset($response['current'])) {\n        throw new Exception('`current` is not found');\n    }\n\n    if (!isset($response['push'])) {\n        throw new Exception('`push` is not found');\n    }\n\n    if ($last) {\n        if ($last['current']['health'] != $response['current']['health']) {\n            $tiarra = new Net_Socket_Tiarra($tiarra_socket);\n            $tiarra->message($irc_channel, sprintf('10Facebook Status: %s (%s)', $response['current']['subject'], $response['current']['health']));\n        }\n    }\n\n    if (is_null($last) || $last['current']['health'] != $response['current']['health'] || $last['push']['id'] != $response['push']['id']) {\n        $insert = $pdo->prepare('INSERT INTO `log` (current, push, created_at) VALUES (:current, :push, :created_at);');\n        $insert->execute(array(\n            'current'    => json_encode($response['current']),\n            'push'       => json_encode($response['push']),\n            'created_at' => $now->format('Y-m-d H:i:s'),\n        ));\n    }\n} catch (Exception $e) {\n    echo $e->getMessage(), PHP_EOL;\n}\n\n\nNet_Socket_Tiarra \u304c\u5fc5\u8981\u306a\u306e\u3067\u3001\u5165\u3063\u3066\u306a\u3044\u4eba\u306f\npear channel-discover openpear.org\npear install Net_Socket_Tiarra \n\n\u3068\u304b\u3067\u5165\u308b\u3068\u601d\u3046\u3088\uff01\nQiita \u304c\u9811\u5f35\u3063\u3066\u3044\u308b\u306e\u3067\u50d5\u3082\u9811\u5f35\u308d\u3046\u3068\u304a\u3082\u3044\u307e\u3057\u305f\u3002\n\n\n\u307e\u305a\u306f `log.sqlite` \u3068\u304b\u306b DB \u3064\u304f\u308a\u307e\u3059\u3088\u3002\n\n```sql:install.sql\nCREATE TABLE IF NOT EXISTS log (\n  current TEXT,\n  push TEXT,\n  created_at DATETIME\n);\n```\n\n\n\u3067\u3001\u3053\u3093\u306a\u30b9\u30af\u30ea\u30d7\u30c8\u3092 cron \u3068\u304b\u3067\u52d5\u304b\u3057\u307e\u3059\u3088\u3002\n\u52e2\u3044\u3067\u66f8\u3044\u305f\u304b\u3089\u7f8e\u3057\u304f\u306a\u3044\u3051\u3069\u3001\u8a31\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n```php:fbhealth.php\n<?php\nrequire_once 'Net/Socket/Tiarra.php';\n\n$api_uri       = 'http://www.facebook.com/feeds/api_status.php';\n$db            = __DIR__ . '/log.sqlite';\n$pdo           = new PDO(\"sqlite:$db\");\n$tiarra_socket = 'riaf';\n$irc_channel   = '#nequal@freenode';\n\n$last_row = $pdo->query('SELECT * FROM log ORDER BY created_at DESC')->fetch(PDO::FETCH_ASSOC);\n\nif ($last_row) {\n    $last = array(\n        'current'    => json_decode($last_row['current'], true),\n        'push'       => json_decode($last_row['push'], true),\n        'created_at' => new DateTime($last_row['created_at']),\n    );\n} else {\n    $last = null;\n}\n\n$now = new DateTime;\n$response = json_decode(file_get_contents($api_uri), true);\n\ntry {\n    if (!isset($response['current'])) {\n        throw new Exception('`current` is not found');\n    }\n\n    if (!isset($response['push'])) {\n        throw new Exception('`push` is not found');\n    }\n\n    if ($last) {\n        if ($last['current']['health'] != $response['current']['health']) {\n            $tiarra = new Net_Socket_Tiarra($tiarra_socket);\n            $tiarra->message($irc_channel, sprintf('10Facebook Status: %s (%s)', $response['current']['subject'], $response['current']['health']));\n        }\n    }\n\n    if (is_null($last) || $last['current']['health'] != $response['current']['health'] || $last['push']['id'] != $response['push']['id']) {\n        $insert = $pdo->prepare('INSERT INTO `log` (current, push, created_at) VALUES (:current, :push, :created_at);');\n        $insert->execute(array(\n            'current'    => json_encode($response['current']),\n            'push'       => json_encode($response['push']),\n            'created_at' => $now->format('Y-m-d H:i:s'),\n        ));\n    }\n} catch (Exception $e) {\n    echo $e->getMessage(), PHP_EOL;\n}\n```\n\n`Net_Socket_Tiarra` \u304c\u5fc5\u8981\u306a\u306e\u3067\u3001\u5165\u3063\u3066\u306a\u3044\u4eba\u306f\n\n```sh\npear channel-discover openpear.org\npear install Net_Socket_Tiarra \n```\n\n\u3068\u304b\u3067\u5165\u308b\u3068\u601d\u3046\u3088\uff01", "tags": ["PHP", "Facebook", "IRC"]}