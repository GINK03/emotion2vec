{"tags": ["AWS", "aws-cli", "IAM"], "context": " More than 1 year has passed since last update.AWS CLI\u3092\u5229\u7528\u3057\u3066\u3001S3 put\u7528\u306eIAM\u30ed\u30fc\u30eb\u306e\u4f5c\u6210\u3092\u3057\u3066\u307f\u307e\u3059\u3002\n\n\u524d\u63d0\u6761\u4ef6\n\nCognito (Identity)\u3078\u306e\u6a29\u9650\n\nCognito (Identity)\u306b\u5bfe\u3057\u3066\u30d5\u30eb\u6a29\u9650\u304c\u3042\u308b\u3053\u3068\u3002\n\n\nAWS CLI\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\n\n\n\u4ee5\u4e0b\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u3067\u52d5\u4f5c\u78ba\u8a8d\u6e08\n\nAWS CLI 1.8.3\n\n\n\n\n\u30b3\u30de\u30f3\u30c9\naws --version\n\n\n\n\u7d50\u679c(\u4f8b)\n      aws-cli/1.8.3 Python/2.7.5 Darwin/13.4.0\n\n\n\n0. \u6e96\u5099\n\n0.1. \u5909\u6570\u306e\u78ba\u8a8d\n\u30d7\u30ed\u30d5\u30a1\u30a4\u30eb\u304c\u60f3\u5b9a\u306e\u3082\u306e\u306b\u306a\u3063\u3066\u3044\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n\u5909\u6570\u306e\u78ba\u8a8d\naws configure list\n\n\n\n\u7d50\u679c(\u4f8b)\n\n            Name                    Value             Type    Location\n            ----                    -----             ----    --------\n         profile       iamFull-prjZ-mbp13iamFull-prjZ-mbp13              env    AWS_DEFAULT_PROFILE\n      access_key     ****************XXXX shared-credentials-file\n      secret_key     ****************XXXX shared-credentials-file\n          region                eu-west-1              env    AWS_DEFAULT_REGION\n\n\n\n0.2. Cognito ID Pool ID\u306e\u6307\u5b9a\n\n\u5909\u6570\u306e\u8a2d\u5b9a(\u4f8b)\nCOGNITO_IDPOOL_ID='ap-northeast-1:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx'\n\n\n\n0.3. S3\u30d0\u30b1\u30c3\u30c8\u540d\u306e\u6307\u5b9a\n\n\u5909\u6570\u306e\u8a2d\u5b9a(\u4f8b)\nS3_BUCKET_NAME=<\u30d0\u30b1\u30c3\u30c8\u540d>\n\n\n\n1. \u4e8b\u524d\u4f5c\u696d\n\n1.1. IAM\u30ed\u30fc\u30eb\u540d\u306e\u6c7a\u5b9a\n\n\u5909\u6570\u306e\u8a2d\u5b9a\nIAM_ROLE_NAME='Cognito_s3putUnauth_Role'\n\n\n\u540c\u3058\u540d\u524d\u306eIAM\u30ed\u30fc\u30eb\u304c\u5b58\u5728\u3057\u306a\u3044\u3053\u3068\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n\u30b3\u30de\u30f3\u30c9\naws iam get-role \\\n         --role-name ${IAM_ROLE_NAME}\n\n\n\n\u7d50\u679c(\u4f8b)\n      A client error (NoSuchEntity) occurred when calling the GetRole operation: The role with name ecsInstanceRole cannot be found.\n\n\n\n1.2. assume\u30ed\u30fc\u30eb\u30dd\u30ea\u30b7\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u306e\u4f5c\u6210\n\n\u5909\u6570\u306e\u8a2d\u5b9a\nFILE_ROLE_DOC=\"${IAM_ROLE_NAME}.json\" \\\n        && echo ${FILE_ROLE_DOC}\n\n\n\n\u30b3\u30de\u30f3\u30c9\ncat << EOF >> ${FILE_ROLE_DOC}\n{\n        \"Version\": \"2008-10-17\",\n        \"Statement\": [\n          {\n            \"Action\": \"sts:AssumeRoleWithWebIdentity\",\n            \"Principal\": {\n              \"Federated\": \"cognito-identity.amazonaws.com\"\n            },\n            \"Effect\": \"Allow\",\n            \"Condition\": {\n              \"StringEquals\": {\n                \"cognito-identity.amazonaws.com:aud\": \"${COGNITO_IDPOOL_ID}\"\n              },\n              \"ForAnyValue:StringLike\": {\n                \"cognito-identity.amazonaws.com:amr\": \"unauthenticated\"\n              }\n            },\n            \"Sid\": \"\"\n          }\n        ]\n}\nEOF\n\ncat ${FILE_ROLE_DOC}\n\n\nJSON\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3057\u305f\u3089\u3001\u30d5\u30a9\u30fc\u30de\u30c3\u30c8\u304c\u58ca\u308c\u3066\u306a\u3044\u304b\u5fc5\u305a\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n\u30b3\u30de\u30f3\u30c9\njsonlint -q ${FILE_ROLE_DOC}\n\n\n\n2. IAM\u30ed\u30fc\u30eb\u306e\u4f5c\u6210\n\n2.1. IAM\u30ed\u30fc\u30eb\u306e\u4f5c\u6210\n\n\u5909\u6570\u306e\u78ba\u8a8d\ncat << ETX\n\n        IAM_ROLE_NAME: ${IAM_ROLE_NAME}\n        FILE_ROLE_DOC: ${FILE_ROLE_DOC}\n\nETX\n\n\n\n\u30b3\u30de\u30f3\u30c9\naws iam create-role \\\n        --role-name ${IAM_ROLE_NAME} \\\n        --assume-role-policy-document file://${FILE_ROLE_DOC}\n\n\n\n\u7d50\u679c(\u4f8b)\n\n      {\n        \"Role\": {\n          \"AssumeRolePolicyDocument\": {\n              \"Version\": \"2008-10-17\",\n              \"Statement\": [\n                  {\n                      \"Action\": \"sts:AssumeRoleWithWebIdentity\",\n                      \"Sid\": \"\",\n                      \"Effect\": \"Allow\",\n                      \"Condition\": {\n                          \"StringEquals\": {\n                              \"cognito-identity.amazonaws.com:aud\": \"ap-northeast-1:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx\"\n                          },\n                          \"ForAnyValue:StringLike\": {\n                              \"cognito-identity.amazonaws.com:amr\": \"unauthenticated\"\n                          }\n                      },\n                      \"Principal\": {\n                          \"Federated\": \"cognito-identity.amazonaws.com\"\n                      }\n                  }\n              ]\n          },\n          \"RoleId\": \"AROAXXXXXXXXXXXXXXXXX\",\n          \"CreateDate\": \"2015-09-28T08:12:38.002Z\",\n          \"RoleName\": \"Cognito_s3putUnauth_Role\",\n          \"Path\": \"/\",\n          \"Arn\": \"arn:aws:iam::XXXXXXXXXXXX:role/Cognito_s3putUnauth_Role\"\n        }\n      }\n\n\n\n2.2. IAM\u30ed\u30fc\u30eb\u306e\u78ba\u8a8d\n\n\u30b3\u30de\u30f3\u30c9\naws iam get-role \\\n         --role-name ${IAM_ROLE_NAME}\n\n\n\n3. \u30ed\u30fc\u30eb\u30dd\u30ea\u30b7 (cognito-sync)\n\n3.1. IAM\u30ed\u30fc\u30eb\u30dd\u30ea\u30b7\u30fc\u306e\u4f5c\u6210\n\n\u5909\u6570\u306e\u8a2d\u5b9a\nIAM_ROLE_POLICY_NAME='oneClick_Cognito_s3putUnauth_Role'\nFILE_ROLE_POLICY_DOC=\"${IAM_ROLE_POLICY_NAME}.json\" \\\n        && echo ${FILE_ROLE_POLICY_DOC}\n\n\n\n\u30b3\u30de\u30f3\u30c9\ncat << EOF > ${FILE_ROLE_POLICY_DOC}\n{\n        \"Version\": \"2012-10-17\",\n        \"Statement\": [\n          {\n            \"Effect\": \"Allow\",\n            \"Action\": [\n              \"mobileanalytics:PutEvents\",\n              \"cognito-sync:*\"\n            ],\n            \"Resource\": [\n              \"*\"\n            ]\n          }\n        ]\n}\nEOF\n\ncat ${FILE_ROLE_POLICY_DOC}\n\n\nJSON\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3057\u305f\u3089\u3001\u30d5\u30a9\u30fc\u30de\u30c3\u30c8\u304c\u58ca\u308c\u3066\u306a\u3044\u304b\u5fc5\u305a\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n\u30b3\u30de\u30f3\u30c9\njsonlint -q ${FILE_ROLE_POLICY_DOC}\n\n\n\n3.2. \u30ed\u30fc\u30eb\u30dd\u30ea\u30b7\u30fc\u306e\u9069\u7528\n\u30ed\u30fc\u30eb\u30dd\u30ea\u30b7\u30fc\u3092IAM\u30ed\u30fc\u30eb\u306b\u9069\u7528\u3057\u307e\u3059\u3002\n\n\u5909\u6570\u306e\u78ba\u8a8d\ncat << ETX\n\n        IAM_ROLE_NAME:        ${IAM_ROLE_NAME}\n        IAM_ROLE_POLICY_NAME: ${IAM_ROLE_POLICY_NAME}\n        FILE_ROLE_POLICY_DOC: ${FILE_ROLE_POLICY_DOC}\n\nETX\n\n\n\n\u5909\u6570\u306e\u78ba\u8a8d\naws iam put-role-policy \\\n        --role-name ${IAM_ROLE_NAME} \\\n        --policy-name ${IAM_ROLE_POLICY_NAME} \\\n        --policy-document file://${FILE_ROLE_POLICY_DOC}\n\n\n\n4. \u30ed\u30fc\u30eb\u30dd\u30ea\u30b7 (s3put)\n\n4.1. IAM\u30ed\u30fc\u30eb\u30dd\u30ea\u30b7\u30fc\u306e\u4f5c\u6210\n\n\u5909\u6570\u306e\u8a2d\u5b9a\nIAM_ROLE_POLICY_NAME='s3put'\nFILE_ROLE_POLICY_DOC=\"${IAM_ROLE_POLICY_NAME}.json\" \\\n        && echo ${FILE_ROLE_POLICY_DOC}\n\n\n\n\u30b3\u30de\u30f3\u30c9\ncat << EOF > ${FILE_ROLE_POLICY_DOC}\n{\n        \"Version\": \"2012-10-17\",\n        \"Statement\": [\n          {\n              \"Sid\": \"\",\n              \"Action\": [\n                  \"s3:PutObject\",\n                  \"s3:PutObjectAcl\"\n              ],\n              \"Effect\": \"Allow\",\n              \"Resource\": \"arn:aws:s3:::${S3_BUCKET_NAME}/*\"\n          }\n        ]\n}\nEOF\n\ncat ${FILE_ROLE_POLICY_DOC}\n\n\nJSON\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3057\u305f\u3089\u3001\u30d5\u30a9\u30fc\u30de\u30c3\u30c8\u304c\u58ca\u308c\u3066\u306a\u3044\u304b\u5fc5\u305a\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n\u30b3\u30de\u30f3\u30c9\njsonlint -q ${FILE_ROLE_POLICY_DOC}\n\n\n\n4.2. \u30ed\u30fc\u30eb\u30dd\u30ea\u30b7\u30fc\u306e\u9069\u7528\n\u30ed\u30fc\u30eb\u30dd\u30ea\u30b7\u30fc\u3092IAM\u30ed\u30fc\u30eb\u306b\u9069\u7528\u3057\u307e\u3059\u3002\n\n\u5909\u6570\u306e\u78ba\u8a8d\ncat << ETX\n\n        IAM_ROLE_NAME:        ${IAM_ROLE_NAME}\n        IAM_ROLE_POLICY_NAME: ${IAM_ROLE_POLICY_NAME}\n        FILE_ROLE_POLICY_DOC: ${FILE_ROLE_POLICY_DOC}\n\nETX\n\n\n\n\u5909\u6570\u306e\u78ba\u8a8d\naws iam put-role-policy \\\n        --role-name ${IAM_ROLE_NAME} \\\n        --policy-name ${IAM_ROLE_POLICY_NAME} \\\n        --policy-document file://${FILE_ROLE_POLICY_DOC}\n\n\n\n5. \u4e8b\u5f8c\u4f5c\u696d\n\n5.1. IAM\u30ed\u30fc\u30eb\u306e\u78ba\u8a8d\n\n\u30b3\u30de\u30f3\u30c9\naws iam get-role \\\n         --role-name ${IAM_ROLE_NAME}\n\n\n\n\u7d50\u679c(\u4f8b)\n      {\n              \"AssumeRolePolicyDocument\": {\n                  \"Version\": \"2012-10-17\",\n                  \"Statement\": [\n                      {\n                          \"Action\": \"sts:AssumeRoleWithWebIdentity\",\n                          \"Principal\": {\n                              \"Federated\": \"cognito-identity.amazonaws.com\"\n                          },\n                          \"Effect\": \"Allow\",\n                          \"Condition\": {\n                              \"StringEquals\": {\n                                  \"cognito-identity.amazonaws.com:aud\": \"us-east-1:48b8f559-9c64-40e3-b38f-9860fc0240df\"\n                              },\n                              \"ForAnyValue:StringLike\": {\n                                  \"cognito-identity.amazonaws.com:amr\": \"unauthenticated\"\n                              }\n                          },\n                          \"Sid\": \"\"\n                      }\n                  ]\n              },\n              \"RoleId\": \"AROAI24WZFOE4TPB4D46A\",\n              \"CreateDate\": \"2015-09-14T21:57:57Z\",\n              \"RoleName\": \"Cognito_s3putUnauth_Role\",\n              \"Path\": \"/\",\n              \"Arn\": \"arn:aws:iam::XXXXXXXXXXXX:role/Cognito_s3putUnauth_Role\"\n      }\n\n\n\n5.2. \u30ed\u30fc\u30eb\u30dd\u30ea\u30b7\u306e\u78ba\u8a8d\n\n\u30b3\u30de\u30f3\u30c9\naws iam list-role-policies   --role-name ${IAM_ROLE_NAME}\n\n\n\n\u7d50\u679c\n      {\n        \"PolicyNames\": [\n          \"oneClick_Cognito_s3putUnauth_Role\",\n          \"s3put\"\n        ]\n      }\n\n\n\n\u30b3\u30de\u30f3\u30c9\nIAM_ROLE_POLICY_NAME='oneClick_Cognito_s3putUnauth_Role'\n\n\n\n\u30b3\u30de\u30f3\u30c9\naws iam get-role-policy \\\n        --role-name ${IAM_ROLE_NAME} \\\n        --policy-name ${IAM_ROLE_POLICY_NAME}\n\n\n\n\u7d50\u679c(\u4f8b)\n      aws iam get-role-policy \\\n      {\n        \"RoleName\": \"Cognito_s3putUnauth_Role\",\n        \"PolicyDocument\": {\n          \"Version\": \"2012-10-17\",\n          \"Statement\": [\n              {\n                  \"Action\": [\n                      \"mobileanalytics:PutEvents\",\n                      \"cognito-sync:*\"\n                  ],\n                  \"Resource\": [\n                      \"*\"\n                  ],\n                  \"Effect\": \"Allow\"\n              }\n          ]\n        },\n        \"PolicyName\": \"oneClick_Cognito_s3putUnauth_Role\"\n      }\n\n\n\n\u30b3\u30de\u30f3\u30c9\nIAM_ROLE_POLICY_NAME='s3put'\n\n\n\n\u30b3\u30de\u30f3\u30c9\naws iam get-role-policy \\\n        --role-name ${IAM_ROLE_NAME} \\\n        --policy-name ${IAM_ROLE_POLICY_NAME}\n\n\n\n\u7d50\u679c(\u4f8b)\n      {\n        \"RoleName\": \"Cognito_s3putUnauth_Role\",\n        \"PolicyDocument\": {\n          \"Version\": \"2012-10-17\",\n          \"Statement\": [\n              {\n                  \"Action\": [\n                      \"s3:PutObject\",\n                      \"s3:PutObjectAcl\"\n                  ],\n                  \"Resource\": \"arn:aws:s3:::example/*\",\n                  \"Effect\": \"Allow\",\n                  \"Sid\": \"\"\n              }\n          ]\n        },\n        \"PolicyName\": \"s3put\"\n      }\n\n\n\u30de\u30cd\u30b8\u30e1\u30f3\u30c8\u30b3\u30f3\u30bd\u30fc\u30eb\u4e0a\u306f\u3001\"\u4fe1\u983c\u95a2\u4fc2\"\u306b cognito-identity.amazonaws.com \u304c\u8868\u793a\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n\n5.3. IAM\u30ed\u30fc\u30eb\u306eARN\n\n\u30b3\u30de\u30f3\u30c9\nIAM_ROLE_ARN=$( \\\n  aws iam get-role \\\n    --role-name ${IAM_ROLE_NAME} \\\n    --query 'Role.Arn' \\\n    --output text \\\n) \\\n  && echo ${IAM_ROLE_ARN}\n\n\n\n5.4.\n\n\u30b3\u30de\u30f3\u30c9\naws cognito-identity set-identity-pool-roles \\\n  --identity-pool-id ${COGNITO_IDPOOL_ID} \\\n  --roles unauthenticated=${IAM_ROLE_ARN}\n\n\n\n\u30b3\u30de\u30f3\u30c9\naws cognito-identity get-identity-pool-roles \\\n  --identity-pool-id ${COGNITO_IDPOOL_ID} \n\n\n\n\u7d50\u679c(\u4f8b)\n{\n    \"IdentityPoolId\": \"ap-northeast-1:f08b5f56-4132-4762-ab95-4188346e4b8b\", \n    \"Roles\": {\n        \"unauthenticated\": \"arn:aws:iam::XXXXXXXXXXXX:role/Cognito_s3putUnauth_Role\"\n    }\n}\n\n\n\n\u5b8c\u4e86\n\nAWS CLI\u3092\u5229\u7528\u3057\u3066\u3001S3 put\u7528\u306eIAM\u30ed\u30fc\u30eb\u306e\u4f5c\u6210\u3092\u3057\u3066\u307f\u307e\u3059\u3002\n\n\n\u524d\u63d0\u6761\u4ef6\n========\n\n\nCognito (Identity)\u3078\u306e\u6a29\u9650\n-------------------\n\n* Cognito (Identity)\u306b\u5bfe\u3057\u3066\u30d5\u30eb\u6a29\u9650\u304c\u3042\u308b\u3053\u3068\u3002\n\n\nAWS CLI\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\n-------------------\n\n* \u4ee5\u4e0b\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u3067\u52d5\u4f5c\u78ba\u8a8d\u6e08\n\n  * AWS CLI 1.8.3\n\n```bash:\u30b3\u30de\u30f3\u30c9:\naws --version\n```\n\n```text:\u7d50\u679c(\u4f8b):\n      aws-cli/1.8.3 Python/2.7.5 Darwin/13.4.0\n```\n\n\n0. \u6e96\u5099\n=======\n\n\n0.1. \u5909\u6570\u306e\u78ba\u8a8d\n---------------\n\n\u30d7\u30ed\u30d5\u30a1\u30a4\u30eb\u304c\u60f3\u5b9a\u306e\u3082\u306e\u306b\u306a\u3063\u3066\u3044\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n```bash:\u5909\u6570\u306e\u78ba\u8a8d:\naws configure list\n```\n\n```text:\u7d50\u679c(\u4f8b):\n\n            Name                    Value             Type    Location\n            ----                    -----             ----    --------\n         profile       iamFull-prjZ-mbp13iamFull-prjZ-mbp13              env    AWS_DEFAULT_PROFILE\n      access_key     ****************XXXX shared-credentials-file\n      secret_key     ****************XXXX shared-credentials-file\n          region                eu-west-1              env    AWS_DEFAULT_REGION\n```\n\n\n0.2. Cognito ID Pool ID\u306e\u6307\u5b9a\n-----------------------------\n\n```bash:\u5909\u6570\u306e\u8a2d\u5b9a(\u4f8b):\nCOGNITO_IDPOOL_ID='ap-northeast-1:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx'\n```\n\n\n0.3. S3\u30d0\u30b1\u30c3\u30c8\u540d\u306e\u6307\u5b9a\n-----------------------\n\n```bash:\u5909\u6570\u306e\u8a2d\u5b9a(\u4f8b):\nS3_BUCKET_NAME=<\u30d0\u30b1\u30c3\u30c8\u540d>\n```\n\n\n1. \u4e8b\u524d\u4f5c\u696d\n===========\n\n\n1.1. IAM\u30ed\u30fc\u30eb\u540d\u306e\u6c7a\u5b9a\n----------------------\n\n```bash:\u5909\u6570\u306e\u8a2d\u5b9a:\nIAM_ROLE_NAME='Cognito_s3putUnauth_Role'\n```\n\n\u540c\u3058\u540d\u524d\u306eIAM\u30ed\u30fc\u30eb\u304c\u5b58\u5728\u3057\u306a\u3044\u3053\u3068\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n```bash:\u30b3\u30de\u30f3\u30c9:\naws iam get-role \\\n         --role-name ${IAM_ROLE_NAME}\n```\n\n```text:\u7d50\u679c(\u4f8b):\n      A client error (NoSuchEntity) occurred when calling the GetRole operation: The role with name ecsInstanceRole cannot be found.\n```\n\n\n1.2. assume\u30ed\u30fc\u30eb\u30dd\u30ea\u30b7\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u306e\u4f5c\u6210\n-----------------------------------------\n\n```bash:\u5909\u6570\u306e\u8a2d\u5b9a:\nFILE_ROLE_DOC=\"${IAM_ROLE_NAME}.json\" \\\n        && echo ${FILE_ROLE_DOC}\n```\n\n```bash:\u30b3\u30de\u30f3\u30c9:\ncat << EOF >> ${FILE_ROLE_DOC}\n{\n        \"Version\": \"2008-10-17\",\n        \"Statement\": [\n          {\n            \"Action\": \"sts:AssumeRoleWithWebIdentity\",\n            \"Principal\": {\n              \"Federated\": \"cognito-identity.amazonaws.com\"\n            },\n            \"Effect\": \"Allow\",\n            \"Condition\": {\n              \"StringEquals\": {\n                \"cognito-identity.amazonaws.com:aud\": \"${COGNITO_IDPOOL_ID}\"\n              },\n              \"ForAnyValue:StringLike\": {\n                \"cognito-identity.amazonaws.com:amr\": \"unauthenticated\"\n              }\n            },\n            \"Sid\": \"\"\n          }\n        ]\n}\nEOF\n\ncat ${FILE_ROLE_DOC}\n```\n\nJSON\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3057\u305f\u3089\u3001\u30d5\u30a9\u30fc\u30de\u30c3\u30c8\u304c\u58ca\u308c\u3066\u306a\u3044\u304b\u5fc5\u305a\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n```bash:\u30b3\u30de\u30f3\u30c9:\njsonlint -q ${FILE_ROLE_DOC}\n```\n\n\n2. IAM\u30ed\u30fc\u30eb\u306e\u4f5c\u6210\n==================\n\n\n2.1. IAM\u30ed\u30fc\u30eb\u306e\u4f5c\u6210\n--------------------\n\n```bash:\u5909\u6570\u306e\u78ba\u8a8d:\ncat << ETX\n\n        IAM_ROLE_NAME: ${IAM_ROLE_NAME}\n        FILE_ROLE_DOC: ${FILE_ROLE_DOC}\n\nETX\n```\n\n```bash:\u30b3\u30de\u30f3\u30c9:\naws iam create-role \\\n        --role-name ${IAM_ROLE_NAME} \\\n        --assume-role-policy-document file://${FILE_ROLE_DOC}\n```\n\n```json:\u7d50\u679c(\u4f8b):\n\n      {\n        \"Role\": {\n          \"AssumeRolePolicyDocument\": {\n              \"Version\": \"2008-10-17\",\n              \"Statement\": [\n                  {\n                      \"Action\": \"sts:AssumeRoleWithWebIdentity\",\n                      \"Sid\": \"\",\n                      \"Effect\": \"Allow\",\n                      \"Condition\": {\n                          \"StringEquals\": {\n                              \"cognito-identity.amazonaws.com:aud\": \"ap-northeast-1:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx\"\n                          },\n                          \"ForAnyValue:StringLike\": {\n                              \"cognito-identity.amazonaws.com:amr\": \"unauthenticated\"\n                          }\n                      },\n                      \"Principal\": {\n                          \"Federated\": \"cognito-identity.amazonaws.com\"\n                      }\n                  }\n              ]\n          },\n          \"RoleId\": \"AROAXXXXXXXXXXXXXXXXX\",\n          \"CreateDate\": \"2015-09-28T08:12:38.002Z\",\n          \"RoleName\": \"Cognito_s3putUnauth_Role\",\n          \"Path\": \"/\",\n          \"Arn\": \"arn:aws:iam::XXXXXXXXXXXX:role/Cognito_s3putUnauth_Role\"\n        }\n      }\n```\n\n\n2.2. IAM\u30ed\u30fc\u30eb\u306e\u78ba\u8a8d\n--------------------\n\n```bash:\u30b3\u30de\u30f3\u30c9:\naws iam get-role \\\n         --role-name ${IAM_ROLE_NAME}\n```\n\n\n3. \u30ed\u30fc\u30eb\u30dd\u30ea\u30b7 (cognito-sync)\n==============================\n\n\n3.1. IAM\u30ed\u30fc\u30eb\u30dd\u30ea\u30b7\u30fc\u306e\u4f5c\u6210\n----------------------------\n\n```bash:\u5909\u6570\u306e\u8a2d\u5b9a:\nIAM_ROLE_POLICY_NAME='oneClick_Cognito_s3putUnauth_Role'\nFILE_ROLE_POLICY_DOC=\"${IAM_ROLE_POLICY_NAME}.json\" \\\n        && echo ${FILE_ROLE_POLICY_DOC}\n```\n\n```bash:\u30b3\u30de\u30f3\u30c9:\ncat << EOF > ${FILE_ROLE_POLICY_DOC}\n{\n        \"Version\": \"2012-10-17\",\n        \"Statement\": [\n          {\n            \"Effect\": \"Allow\",\n            \"Action\": [\n              \"mobileanalytics:PutEvents\",\n              \"cognito-sync:*\"\n            ],\n            \"Resource\": [\n              \"*\"\n            ]\n          }\n        ]\n}\nEOF\n\ncat ${FILE_ROLE_POLICY_DOC}\n```\n\nJSON\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3057\u305f\u3089\u3001\u30d5\u30a9\u30fc\u30de\u30c3\u30c8\u304c\u58ca\u308c\u3066\u306a\u3044\u304b\u5fc5\u305a\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n```bash:\u30b3\u30de\u30f3\u30c9:\njsonlint -q ${FILE_ROLE_POLICY_DOC}\n```\n\n\n3.2. \u30ed\u30fc\u30eb\u30dd\u30ea\u30b7\u30fc\u306e\u9069\u7528\n-------------------------\n\n\u30ed\u30fc\u30eb\u30dd\u30ea\u30b7\u30fc\u3092IAM\u30ed\u30fc\u30eb\u306b\u9069\u7528\u3057\u307e\u3059\u3002\n\n```bash:\u5909\u6570\u306e\u78ba\u8a8d:\ncat << ETX\n\n        IAM_ROLE_NAME:        ${IAM_ROLE_NAME}\n        IAM_ROLE_POLICY_NAME: ${IAM_ROLE_POLICY_NAME}\n        FILE_ROLE_POLICY_DOC: ${FILE_ROLE_POLICY_DOC}\n\nETX\n```\n\n```bash:\u5909\u6570\u306e\u78ba\u8a8d:\naws iam put-role-policy \\\n        --role-name ${IAM_ROLE_NAME} \\\n        --policy-name ${IAM_ROLE_POLICY_NAME} \\\n        --policy-document file://${FILE_ROLE_POLICY_DOC}\n```\n\n\n4. \u30ed\u30fc\u30eb\u30dd\u30ea\u30b7 (s3put)\n=======================\n\n\n4.1. IAM\u30ed\u30fc\u30eb\u30dd\u30ea\u30b7\u30fc\u306e\u4f5c\u6210\n----------------------------\n\n```bash:\u5909\u6570\u306e\u8a2d\u5b9a:\nIAM_ROLE_POLICY_NAME='s3put'\nFILE_ROLE_POLICY_DOC=\"${IAM_ROLE_POLICY_NAME}.json\" \\\n        && echo ${FILE_ROLE_POLICY_DOC}\n```\n\n```bash:\u30b3\u30de\u30f3\u30c9:\ncat << EOF > ${FILE_ROLE_POLICY_DOC}\n{\n        \"Version\": \"2012-10-17\",\n        \"Statement\": [\n          {\n              \"Sid\": \"\",\n              \"Action\": [\n                  \"s3:PutObject\",\n                  \"s3:PutObjectAcl\"\n              ],\n              \"Effect\": \"Allow\",\n              \"Resource\": \"arn:aws:s3:::${S3_BUCKET_NAME}/*\"\n          }\n        ]\n}\nEOF\n\ncat ${FILE_ROLE_POLICY_DOC}\n```\n\nJSON\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3057\u305f\u3089\u3001\u30d5\u30a9\u30fc\u30de\u30c3\u30c8\u304c\u58ca\u308c\u3066\u306a\u3044\u304b\u5fc5\u305a\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n```bash:\u30b3\u30de\u30f3\u30c9:\njsonlint -q ${FILE_ROLE_POLICY_DOC}\n```\n\n\n4.2. \u30ed\u30fc\u30eb\u30dd\u30ea\u30b7\u30fc\u306e\u9069\u7528\n-------------------------\n\n\u30ed\u30fc\u30eb\u30dd\u30ea\u30b7\u30fc\u3092IAM\u30ed\u30fc\u30eb\u306b\u9069\u7528\u3057\u307e\u3059\u3002\n\n```bash:\u5909\u6570\u306e\u78ba\u8a8d:\ncat << ETX\n\n        IAM_ROLE_NAME:        ${IAM_ROLE_NAME}\n        IAM_ROLE_POLICY_NAME: ${IAM_ROLE_POLICY_NAME}\n        FILE_ROLE_POLICY_DOC: ${FILE_ROLE_POLICY_DOC}\n\nETX\n```\n\n```bash:\u5909\u6570\u306e\u78ba\u8a8d:\naws iam put-role-policy \\\n        --role-name ${IAM_ROLE_NAME} \\\n        --policy-name ${IAM_ROLE_POLICY_NAME} \\\n        --policy-document file://${FILE_ROLE_POLICY_DOC}\n```\n\n\n5. \u4e8b\u5f8c\u4f5c\u696d\n===========\n\n\n5.1. IAM\u30ed\u30fc\u30eb\u306e\u78ba\u8a8d\n--------------------\n\n```bash:\u30b3\u30de\u30f3\u30c9:\naws iam get-role \\\n         --role-name ${IAM_ROLE_NAME}\n```\n\n```json:\u7d50\u679c(\u4f8b):\n      {\n              \"AssumeRolePolicyDocument\": {\n                  \"Version\": \"2012-10-17\",\n                  \"Statement\": [\n                      {\n                          \"Action\": \"sts:AssumeRoleWithWebIdentity\",\n                          \"Principal\": {\n                              \"Federated\": \"cognito-identity.amazonaws.com\"\n                          },\n                          \"Effect\": \"Allow\",\n                          \"Condition\": {\n                              \"StringEquals\": {\n                                  \"cognito-identity.amazonaws.com:aud\": \"us-east-1:48b8f559-9c64-40e3-b38f-9860fc0240df\"\n                              },\n                              \"ForAnyValue:StringLike\": {\n                                  \"cognito-identity.amazonaws.com:amr\": \"unauthenticated\"\n                              }\n                          },\n                          \"Sid\": \"\"\n                      }\n                  ]\n              },\n              \"RoleId\": \"AROAI24WZFOE4TPB4D46A\",\n              \"CreateDate\": \"2015-09-14T21:57:57Z\",\n              \"RoleName\": \"Cognito_s3putUnauth_Role\",\n              \"Path\": \"/\",\n              \"Arn\": \"arn:aws:iam::XXXXXXXXXXXX:role/Cognito_s3putUnauth_Role\"\n      }\n```\n\n\n5.2. \u30ed\u30fc\u30eb\u30dd\u30ea\u30b7\u306e\u78ba\u8a8d\n-----------------------\n\n```bash:\u30b3\u30de\u30f3\u30c9:\naws iam list-role-policies   --role-name ${IAM_ROLE_NAME}\n```\n\n```json:\u7d50\u679c:\n      {\n        \"PolicyNames\": [\n          \"oneClick_Cognito_s3putUnauth_Role\",\n          \"s3put\"\n        ]\n      }\n```\n\n```bash:\u30b3\u30de\u30f3\u30c9:\nIAM_ROLE_POLICY_NAME='oneClick_Cognito_s3putUnauth_Role'\n```\n\n```bash:\u30b3\u30de\u30f3\u30c9:\naws iam get-role-policy \\\n        --role-name ${IAM_ROLE_NAME} \\\n        --policy-name ${IAM_ROLE_POLICY_NAME}\n```\n\n```json:\u7d50\u679c(\u4f8b):\n      aws iam get-role-policy \\\n      {\n        \"RoleName\": \"Cognito_s3putUnauth_Role\",\n        \"PolicyDocument\": {\n          \"Version\": \"2012-10-17\",\n          \"Statement\": [\n              {\n                  \"Action\": [\n                      \"mobileanalytics:PutEvents\",\n                      \"cognito-sync:*\"\n                  ],\n                  \"Resource\": [\n                      \"*\"\n                  ],\n                  \"Effect\": \"Allow\"\n              }\n          ]\n        },\n        \"PolicyName\": \"oneClick_Cognito_s3putUnauth_Role\"\n      }\n```\n\n```bash:\u30b3\u30de\u30f3\u30c9:\nIAM_ROLE_POLICY_NAME='s3put'\n```\n\n```bash:\u30b3\u30de\u30f3\u30c9:\naws iam get-role-policy \\\n        --role-name ${IAM_ROLE_NAME} \\\n        --policy-name ${IAM_ROLE_POLICY_NAME}\n```\n\n```json:\u7d50\u679c(\u4f8b):\n      {\n        \"RoleName\": \"Cognito_s3putUnauth_Role\",\n        \"PolicyDocument\": {\n          \"Version\": \"2012-10-17\",\n          \"Statement\": [\n              {\n                  \"Action\": [\n                      \"s3:PutObject\",\n                      \"s3:PutObjectAcl\"\n                  ],\n                  \"Resource\": \"arn:aws:s3:::example/*\",\n                  \"Effect\": \"Allow\",\n                  \"Sid\": \"\"\n              }\n          ]\n        },\n        \"PolicyName\": \"s3put\"\n      }\n```\n\n\u30de\u30cd\u30b8\u30e1\u30f3\u30c8\u30b3\u30f3\u30bd\u30fc\u30eb\u4e0a\u306f\u3001\"\u4fe1\u983c\u95a2\u4fc2\"\u306b cognito-identity.amazonaws.com \u304c\u8868\u793a\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n\n\n## 5.3. IAM\u30ed\u30fc\u30eb\u306eARN\n\n```bash:\u30b3\u30de\u30f3\u30c9:\nIAM_ROLE_ARN=$( \\\n  aws iam get-role \\\n    --role-name ${IAM_ROLE_NAME} \\\n    --query 'Role.Arn' \\\n    --output text \\\n) \\\n  && echo ${IAM_ROLE_ARN}\n```\n\n\n## 5.4. \n\n```bash:\u30b3\u30de\u30f3\u30c9:\naws cognito-identity set-identity-pool-roles \\\n  --identity-pool-id ${COGNITO_IDPOOL_ID} \\\n  --roles unauthenticated=${IAM_ROLE_ARN}\n```\n\n\n```bash:\u30b3\u30de\u30f3\u30c9:\naws cognito-identity get-identity-pool-roles \\\n  --identity-pool-id ${COGNITO_IDPOOL_ID} \n```\n\n```json:\u7d50\u679c(\u4f8b):\n{\n    \"IdentityPoolId\": \"ap-northeast-1:f08b5f56-4132-4762-ab95-4188346e4b8b\", \n    \"Roles\": {\n        \"unauthenticated\": \"arn:aws:iam::XXXXXXXXXXXX:role/Cognito_s3putUnauth_Role\"\n    }\n}\n```\n\n\n\u5b8c\u4e86\n====\n"}