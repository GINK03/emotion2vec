{"context": "Omnibus\u7248\u306eGitLab\u3092VPS\u4e0a\u3067\u904b\u7528\u3057\u3066\u3044\u308b\u3051\u3069\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u53d6\u3063\u3066\u3044\u306a\u3044\u306a\u2026\u3068\u601d\u3044\u7acb\u3063\u305f\u306e\u3067AWS\u306eS3\u306b\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u3092\u53d6\u308b\u3088\u3046\u306b\u8a2d\u5b9a\u3002\nGitLab\u306e\u30de\u30cb\u30e5\u30a2\u30eb\u3092\u898b\u308b\u3068\u4f5c\u696d\u3067\u304d\u308b\u3051\u3069\u3001\u6574\u7406\u3082\u517c\u306d\u3066\u3002\n\u57fa\u672c\u7684\u306b\u306f\u3001\u3053\u3053 Upload backups to remote (cloud) storage \u3084 Backup restore \u306b\u66f8\u304b\u308c\u3066\u3044\u308b\u8a2d\u5b9a\u3092 /etc/gitlab/gitlab.rb \u306b\u8a18\u8ff0\u3057\u3066\n# gitlab-ctl reconfigure\n\n\u3067GitLab\u306e\u8a2d\u5b9a\u306f\u5b8c\u4e86\u3059\u308b\u3002\n\n\u3084\u308b\u3053\u3068\n\u4e00\u901a\u308a\u8a2d\u5b9a\u5b8c\u4e86\u306b\u306a\u308b\u307e\u3067\u306e\u6d41\u308c\u306f\n\n[AWS] AWS\u306b\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u30c7\u30fc\u30bf\u3092\u4fdd\u5b58\u3059\u308bS3\u30d0\u30b1\u30c3\u30c8\u3092\u4f5c\u308b\n[AWS] IAM\u3067\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u7528\u306eS3\u30d0\u30b1\u30c3\u30c8\u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u30e6\u30fc\u30b6\u30fc\u3092\u4f5c\u308b\n[GitLab] /etc/gitlab/gitlab.rb \u306b\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u306e\u8a2d\u5b9a\u3092\u66f8\u304f\n[GitLab] \u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u3092\u5b9f\u884c\u3059\u308b\n[GitLab] cron\u306b\u8a2d\u5b9a\u3059\u308b\n\n\u3053\u3093\u306a\u3068\u3053\u308d\u3002\n\nAWS\u306b\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u30c7\u30fc\u30bf\u3092\u4fdd\u5b58\u3059\u308bS3\u30d0\u30b1\u30c3\u30c8\u3092\u4f5c\u308b\nAWS\u306e\u30b3\u30f3\u30bd\u30fc\u30eb\u304b\u3089\u306a\u308a\u3001\u30b3\u30de\u30f3\u30c9\u304b\u3089\u306a\u308aS3\u4e0a\u306b\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u3092\u5165\u308c\u308b\u305f\u3081\u306e\u30d0\u30b1\u30c3\u30c8\u3092\u4f5c\u308a\u307e\u3059\u3002\n\u30d0\u30b1\u30c3\u30c8\u540d\u306b\u306a\u3093\u3068\u306a\u304f\u300c.\u300d(\u30c9\u30c3\u30c8)\u3092\u5165\u308c\u3066\u3057\u307e\u3046\u3068\u3001\n\nUploading backup archive to remote storage host.backet-gitlab ... [fog][WARNING] fog: the specified s3 bucket name(chost.backet-gitlab) contains a '.' so is not accessible over https as a virtual hosted bucket, which will negatively impact performance.  For details see: http://docs.amazonwebservices.com/AmazonS3/latest/dev/BucketRestrictions.html\n\n\u3068\u8b66\u544a\u3055\u308c\u307e\u3059\u3002\n\u3053\u3053\u3067\u306f\u4eee\u306b\u300cgitlab-backup\u300d\u3068\u3044\u3046\u30d0\u30b1\u30c3\u30c8\u540d\u306b\u3057\u307e\u3059\u3002\n(\u5b9f\u969b\u306b\u306f\u3001\u4e16\u754c\u4e2d\u3067\u4e00\u610f\u306b\u306a\u308b\u3088\u3046\u306b\u3057\u306a\u304d\u3083\u3044\u3051\u306a\u3044\u3051\u3069\u2026)\nAWS\u5185\u306e\u30b5\u30fc\u30d0\u304b\u3089\u306e\u5834\u5408\u3001\u305d\u306e\u30b5\u30fc\u30d0\u304c\u3042\u308b\u30ea\u30fc\u30b8\u30e7\u30f3\u306b\u3059\u308b\u3068\u8ee2\u9001\u6599\u3092\u6c17\u306b\u3057\u306a\u304f\u3066\u3082\u826f\u304f\u306a\u308b\u3002\n\u305d\u308c\u4ee5\u5916\u306a\u3089\u3001\u304a\u597d\u304d\u306a\u30ea\u30fc\u30b8\u30e7\u30f3\u3067\u3002\n\u4f5c\u3063\u305f\u30d0\u30b1\u30c3\u30c8\u306eLifecycle\u3092\u4ee5\u4e0b\u306b\u8a2d\u5b9a\u3057\u307e\u3057\u305f\u3002\nAction on Objects\n  Archive to the Glacier Storage Class 1 days after the object's creation date.\n  Permanently Delete 91 days after the object's creation date\n\n\n\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u304b\u30891\u65e5\u5f8c\u306bGlacier\n\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u304b\u308991\u65e5\u5f8c\u306b\u5b8c\u5168\u524a\u9664\n\n\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u306a\u306e\u30671\u65e5\u524d\u304c\u3042\u308c\u3070\u5927\u4e08\u592b\u3068\u601d\u3044\u3064\u3064\u3001Glacier\u3057\u3066\u307f\u305f\u304b\u3063\u305f\u306e\u3067(^^;\n\nIAM\u3067\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u7528\u306eS3\u30d0\u30b1\u30c3\u30c8\u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u30e6\u30fc\u30b6\u30fc\u3092\u4f5c\u308b\nUpload backups to remote (cloud) storage\n\u3053\u306e\u30da\u30fc\u30b8\u306b\u66f8\u304b\u308c\u3066\u3044\u308b\u30dd\u30ea\u30b7\u30fc\u3092\u6301\u3064\u30e6\u30fc\u30b6\u30fc\u3092\u4f5c\u308a\u307e\u3059\u3002\n\u4ee5\u4e0b\u306e\u5f62\u3067\u4f5c\u308a\u307e\u3057\u305f\u3002\n\nUser Name: gitlab-backup\nPolicy Name: AllowS3-gitlab-backup\n\n\u307e\u305a\u30dd\u30ea\u30b7\u30fc\u3002\n\u30dd\u30ea\u30b7\u30fc\u306e\u5b9a\u7fa9\u306f\u4ee5\u4e0b(\"Resource\"\u306b\u66f8\u3044\u3066\u3044\u308bS3\u306eARN\u4ee5\u5916\u306f\u3001\u307e\u3093\u307eGitLab\u306e\u30da\u30fc\u30b8\u306b\u3042\u308b\u3082\u306e)\n{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Sid\": \"Stmt1412062044000\",\n      \"Effect\": \"Allow\",\n      \"Action\": [\n        \"s3:AbortMultipartUpload\",\n        \"s3:GetBucketAcl\",\n        \"s3:GetBucketLocation\",\n        \"s3:GetObject\",\n        \"s3:GetObjectAcl\",\n        \"s3:ListBucketMultipartUploads\",\n        \"s3:PutObject\",\n        \"s3:PutObjectAcl\"\n      ],\n      \"Resource\": [\n        \"arn:aws:s3:::gitlab-backup/*\"\n      ]\n    },\n    {\n      \"Sid\": \"Stmt1412062097000\",\n      \"Effect\": \"Allow\",\n      \"Action\": [\n        \"s3:GetBucketLocation\",\n        \"s3:ListAllMyBuckets\"\n      ],\n      \"Resource\": [\n        \"*\"\n      ]\n    },\n    {\n      \"Sid\": \"Stmt1412062128000\",\n      \"Effect\": \"Allow\",\n      \"Action\": [\n        \"s3:ListBucket\"\n      ],\n      \"Resource\": [\n        \"arn:aws:s3:::gitlab-backup\"\n      ]\n    }\n  ]\n}\n\n\u3067\u3001\u6b21\u306b\u30e6\u30fc\u30b6\u30fc\u3092\u4f5c\u6210\u3002\n\u4f5c\u6210\u3057\u305f\u30e6\u30fc\u30b6\u30fc\u306b\u3001\u4e0a\u3067\u4f5c\u3063\u305f\u30dd\u30ea\u30b7\u30fc\u3092\u5272\u308a\u5f53\u3066\u307e\u3059\u3002\n\u3053\u306e\u6642\u306b\u751f\u6210\u3055\u308c\u305f Access Key ID \u3068 Secret Access Key \u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u306a\u308a\u30b3\u30d4\u30da\u306a\u308a\u3067\u78ba\u4fdd\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\n/etc/gitlab/gitlab.rb \u306b\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u306e\u8a2d\u5b9a\u3092\u66f8\u304f\n/etc/gitlab/gitlab.rb \u3092\u7de8\u96c6\u3057\u307e\u3059\u3002\n\u4ee5\u4e0b\u306e\u5185\u5bb9\u304c\u30b3\u30e1\u30f3\u30c8\u30a2\u30a6\u30c8\u3055\u308c\u305f\u72b6\u614b\u306b\u3042\u308b\u306e\u3067\u3001\u30b3\u30e1\u30f3\u30c8\u30a2\u30a6\u30c8\u3092\u89e3\u9664\u3057\u3066\u8a2d\u5b9a\u3092\u8a18\u8ff0\u3057\u307e\u3059\u3002\n\ngitlab.rb\ngitlab_rails['backup_upload_connection'] = {\n 'provider' => 'AWS',\n 'region' => 'us-west-2', # \u30ea\u30fc\u30b8\u30e7\u30f3\u3092\u6307\u5b9a\n 'aws_access_key_id' => 'AKIxxxxxxxxxx', # IAM\u3067\u30e6\u30fc\u30b6\u30fc\u3092\u4f5c\u3063\u305f\u6642\u306e\u30a2\u30af\u30bb\u30b9\u30ad\u30fcID\n 'aws_secret_access_key' => 'xxxxxxxxxxxxxxxxxxxxxxxxxxxx' # IAM\u3067\u30e6\u30fc\u30b6\u30fc\u3092\u4f5c\u3063\u305f\u6642\u306e\u30b7\u30fc\u30af\u30ec\u30c3\u30c8\u30a2\u30af\u30bb\u30b9\u30ad\u30fc\n}\ngitlab_rails['backup_upload_remote_directory'] = 'gitlab-backup'\n\n\n\u8a18\u8ff0\u304c\u5b8c\u4e86\u3057\u305f\u3089\n# gitlab-ctl reconfigure\n\n\u3067\u8a2d\u5b9a\u3092\u53cd\u6620\u3002\n\n\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u3092\u5b9f\u884c\u3059\u308b\n# gitlab-rake gitlab:backup:create\nDumping database ...\nDumping PostgreSQL database gitlabhq_production ... [DONE]\ndone\nDumping repositories ...\n * repository ... [DONE]\ndone\nDumping uploads ...\ndone\nDumping builds ...\ndone\nDumping artifacts ...\ndone\nDumping lfs objects ...\ndone\nCreating backup archive: 1458963192_gitlab_backup.tar ... done\nUploading backup archive to remote storage gitlab-backup ... done\nDeleting tmp directories ... done\ndone\ndone\ndone\ndone\ndone\ndone\nDeleting old backups ... skipping\n\nUploading backup archive to remote storage gitlab-backup ... done \u304c\u3042\u308c\u3070\u3001\u6b63\u5e38\u306bS3\u306b\u5bfe\u3057\u3066\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u304c\u5b8c\u4e86\u3002\nS3\u306e\u30b3\u30f3\u30bd\u30fc\u30eb\u3067\u78ba\u8a8d\u3059\u308b\u3068\u30d5\u30a1\u30a4\u30eb\u304c\u4f5c\u3089\u308c\u3066\u3044\u308b\u3002\n\ncron\u306b\u8a2d\u5b9a\u3059\u308b\n\ncron\n0 6 * * * /opt/gitlab/bin/gitlab-rake gitlab:backup:create CRON=1\n\n\nCRON=1\u3092\u8a2d\u5b9a\u3059\u308b\u3053\u3068\u306b\u3088\u3063\u3066\u30a8\u30e9\u30fc\u4ee5\u5916\u306e\u51fa\u529b\u304c\u6291\u3048\u3089\u308c\u308b\u305d\u3046\u3067\u3059\u3002\nGitLab\u306e\u30da\u30fc\u30b8\u3067\u306fAM4:00\u306b\u5b9f\u884c\u3059\u308b\u3088\u3046\u306b\u306a\u3063\u3066\u307e\u3057\u305f\u304c\u3001AM4:00\u3060\u3068\u4ed6\u306e\u30d0\u30c3\u30c1\u3082\u52d5\u3044\u3066\u3044\u308b\u306e\u3068\u591c\u9045\u304f\u307e\u3067\u4f5c\u696d\u3057\u3066\u3044\u308b\u3068\u3001\u305f\u307e\u306bAM4\u3068\u304b\u306a\u308a\u305d\u3046\u306a\u306e\u3067\u3001\u305d\u3093\u306a\u3068\u304d\u306b\u5bdd\u3066\u308b\u3067\u3042\u308d\u3046AM6\u306b\u8a2d\u5b9a(^^;\n\u3053\u306e\u72b6\u614b\u3067\u3001\u660e\u65e5\u4ee5\u964d\n* S3\u306b\u4e0a\u3052\u305f\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u304cGlacier\u306b\u306a\u308b\u304b\uff1f\n* AM6:00\u306b\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u51e6\u7406\u304c\u5b9f\u884c\u3055\u308c\u30d5\u30a1\u30a4\u30eb\u304cS3\u306b\u4e0a\u304c\u308b\u304b\uff1f\n\u3092\u78ba\u8a8d\u3057\u3066\u3001OK\u3067\u3042\u308c\u3070\u5b8c\u4e86\u3067\u3059\u3002\nOmnibus\u7248\u306eGitLab\u3092VPS\u4e0a\u3067\u904b\u7528\u3057\u3066\u3044\u308b\u3051\u3069\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u53d6\u3063\u3066\u3044\u306a\u3044\u306a\u2026\u3068\u601d\u3044\u7acb\u3063\u305f\u306e\u3067AWS\u306eS3\u306b\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u3092\u53d6\u308b\u3088\u3046\u306b\u8a2d\u5b9a\u3002\nGitLab\u306e\u30de\u30cb\u30e5\u30a2\u30eb\u3092\u898b\u308b\u3068\u4f5c\u696d\u3067\u304d\u308b\u3051\u3069\u3001\u6574\u7406\u3082\u517c\u306d\u3066\u3002\n\n\u57fa\u672c\u7684\u306b\u306f\u3001\u3053\u3053 [Upload backups to remote (cloud) storage](http://doc.gitlab.com/omnibus/settings/backups.html#upload-backups-to-remote-cloud-storage) \u3084 [Backup restore](https://gitlab.com/gitlab-org/gitlab-ce/blob/master/doc/raketasks/backup_restore.md) \u306b\u66f8\u304b\u308c\u3066\u3044\u308b\u8a2d\u5b9a\u3092 /etc/gitlab/gitlab.rb \u306b\u8a18\u8ff0\u3057\u3066\n\n```sh\n# gitlab-ctl reconfigure\n```\n\u3067GitLab\u306e\u8a2d\u5b9a\u306f\u5b8c\u4e86\u3059\u308b\u3002\n\n## \u3084\u308b\u3053\u3068\n\n\u4e00\u901a\u308a\u8a2d\u5b9a\u5b8c\u4e86\u306b\u306a\u308b\u307e\u3067\u306e\u6d41\u308c\u306f\n\n1. [AWS] AWS\u306b\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u30c7\u30fc\u30bf\u3092\u4fdd\u5b58\u3059\u308bS3\u30d0\u30b1\u30c3\u30c8\u3092\u4f5c\u308b\n1. [AWS] IAM\u3067\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u7528\u306eS3\u30d0\u30b1\u30c3\u30c8\u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u30e6\u30fc\u30b6\u30fc\u3092\u4f5c\u308b\n1. [GitLab] /etc/gitlab/gitlab.rb \u306b\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u306e\u8a2d\u5b9a\u3092\u66f8\u304f\n1. [GitLab] \u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u3092\u5b9f\u884c\u3059\u308b\n1. [GitLab] cron\u306b\u8a2d\u5b9a\u3059\u308b\n\n\u3053\u3093\u306a\u3068\u3053\u308d\u3002\n\n## AWS\u306b\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u30c7\u30fc\u30bf\u3092\u4fdd\u5b58\u3059\u308bS3\u30d0\u30b1\u30c3\u30c8\u3092\u4f5c\u308b\n\nAWS\u306e\u30b3\u30f3\u30bd\u30fc\u30eb\u304b\u3089\u306a\u308a\u3001\u30b3\u30de\u30f3\u30c9\u304b\u3089\u306a\u308aS3\u4e0a\u306b\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u3092\u5165\u308c\u308b\u305f\u3081\u306e\u30d0\u30b1\u30c3\u30c8\u3092\u4f5c\u308a\u307e\u3059\u3002\n\u30d0\u30b1\u30c3\u30c8\u540d\u306b\u306a\u3093\u3068\u306a\u304f\u300c.\u300d(\u30c9\u30c3\u30c8)\u3092\u5165\u308c\u3066\u3057\u307e\u3046\u3068\u3001\n\n> Uploading backup archive to remote storage host.backet-gitlab ... [fog][WARNING] fog: the specified s3 bucket name(chost.backet-gitlab) contains a '.' so is not accessible over https as a virtual hosted bucket, which will negatively impact performance.  For details see: http://docs.amazonwebservices.com/AmazonS3/latest/dev/BucketRestrictions.html\n\n\u3068\u8b66\u544a\u3055\u308c\u307e\u3059\u3002\n\n\u3053\u3053\u3067\u306f\u4eee\u306b\u300cgitlab-backup\u300d\u3068\u3044\u3046\u30d0\u30b1\u30c3\u30c8\u540d\u306b\u3057\u307e\u3059\u3002\n(\u5b9f\u969b\u306b\u306f\u3001\u4e16\u754c\u4e2d\u3067\u4e00\u610f\u306b\u306a\u308b\u3088\u3046\u306b\u3057\u306a\u304d\u3083\u3044\u3051\u306a\u3044\u3051\u3069\u2026)\n\nAWS\u5185\u306e\u30b5\u30fc\u30d0\u304b\u3089\u306e\u5834\u5408\u3001\u305d\u306e\u30b5\u30fc\u30d0\u304c\u3042\u308b\u30ea\u30fc\u30b8\u30e7\u30f3\u306b\u3059\u308b\u3068\u8ee2\u9001\u6599\u3092\u6c17\u306b\u3057\u306a\u304f\u3066\u3082\u826f\u304f\u306a\u308b\u3002\n\u305d\u308c\u4ee5\u5916\u306a\u3089\u3001\u304a\u597d\u304d\u306a\u30ea\u30fc\u30b8\u30e7\u30f3\u3067\u3002\n\n\u4f5c\u3063\u305f\u30d0\u30b1\u30c3\u30c8\u306eLifecycle\u3092\u4ee5\u4e0b\u306b\u8a2d\u5b9a\u3057\u307e\u3057\u305f\u3002\n\n```\nAction on Objects\n  Archive to the Glacier Storage Class 1 days after the object's creation date.\n  Permanently Delete 91 days after the object's creation date\n```\n\n* \u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u304b\u30891\u65e5\u5f8c\u306bGlacier\n* \u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u304b\u308991\u65e5\u5f8c\u306b\u5b8c\u5168\u524a\u9664\n\n\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u306a\u306e\u30671\u65e5\u524d\u304c\u3042\u308c\u3070\u5927\u4e08\u592b\u3068\u601d\u3044\u3064\u3064\u3001Glacier\u3057\u3066\u307f\u305f\u304b\u3063\u305f\u306e\u3067(^^;\n\n\n## IAM\u3067\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u7528\u306eS3\u30d0\u30b1\u30c3\u30c8\u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u30e6\u30fc\u30b6\u30fc\u3092\u4f5c\u308b\n\n[Upload backups to remote (cloud) storage](http://doc.gitlab.com/omnibus/settings/backups.html#upload-backups-to-remote-cloud-storage)\n\n\u3053\u306e\u30da\u30fc\u30b8\u306b\u66f8\u304b\u308c\u3066\u3044\u308b\u30dd\u30ea\u30b7\u30fc\u3092\u6301\u3064\u30e6\u30fc\u30b6\u30fc\u3092\u4f5c\u308a\u307e\u3059\u3002\n\n\u4ee5\u4e0b\u306e\u5f62\u3067\u4f5c\u308a\u307e\u3057\u305f\u3002\n\n* User Name: gitlab-backup\n* Policy Name: AllowS3-gitlab-backup\n\n\u307e\u305a\u30dd\u30ea\u30b7\u30fc\u3002\n\u30dd\u30ea\u30b7\u30fc\u306e\u5b9a\u7fa9\u306f\u4ee5\u4e0b(\"Resource\"\u306b\u66f8\u3044\u3066\u3044\u308bS3\u306eARN\u4ee5\u5916\u306f\u3001\u307e\u3093\u307eGitLab\u306e\u30da\u30fc\u30b8\u306b\u3042\u308b\u3082\u306e)\n\n```json\n{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Sid\": \"Stmt1412062044000\",\n      \"Effect\": \"Allow\",\n      \"Action\": [\n        \"s3:AbortMultipartUpload\",\n        \"s3:GetBucketAcl\",\n        \"s3:GetBucketLocation\",\n        \"s3:GetObject\",\n        \"s3:GetObjectAcl\",\n        \"s3:ListBucketMultipartUploads\",\n        \"s3:PutObject\",\n        \"s3:PutObjectAcl\"\n      ],\n      \"Resource\": [\n        \"arn:aws:s3:::gitlab-backup/*\"\n      ]\n    },\n    {\n      \"Sid\": \"Stmt1412062097000\",\n      \"Effect\": \"Allow\",\n      \"Action\": [\n        \"s3:GetBucketLocation\",\n        \"s3:ListAllMyBuckets\"\n      ],\n      \"Resource\": [\n        \"*\"\n      ]\n    },\n    {\n      \"Sid\": \"Stmt1412062128000\",\n      \"Effect\": \"Allow\",\n      \"Action\": [\n        \"s3:ListBucket\"\n      ],\n      \"Resource\": [\n        \"arn:aws:s3:::gitlab-backup\"\n      ]\n    }\n  ]\n}\n```\n\n\u3067\u3001\u6b21\u306b\u30e6\u30fc\u30b6\u30fc\u3092\u4f5c\u6210\u3002\n\n\u4f5c\u6210\u3057\u305f\u30e6\u30fc\u30b6\u30fc\u306b\u3001\u4e0a\u3067\u4f5c\u3063\u305f\u30dd\u30ea\u30b7\u30fc\u3092\u5272\u308a\u5f53\u3066\u307e\u3059\u3002\n\n\u3053\u306e\u6642\u306b\u751f\u6210\u3055\u308c\u305f *Access Key ID* \u3068 *Secret Access Key* \u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u306a\u308a\u30b3\u30d4\u30da\u306a\u308a\u3067\u78ba\u4fdd\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\n## /etc/gitlab/gitlab.rb \u306b\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u306e\u8a2d\u5b9a\u3092\u66f8\u304f\n\n/etc/gitlab/gitlab.rb \u3092\u7de8\u96c6\u3057\u307e\u3059\u3002\n\n\u4ee5\u4e0b\u306e\u5185\u5bb9\u304c\u30b3\u30e1\u30f3\u30c8\u30a2\u30a6\u30c8\u3055\u308c\u305f\u72b6\u614b\u306b\u3042\u308b\u306e\u3067\u3001\u30b3\u30e1\u30f3\u30c8\u30a2\u30a6\u30c8\u3092\u89e3\u9664\u3057\u3066\u8a2d\u5b9a\u3092\u8a18\u8ff0\u3057\u307e\u3059\u3002\n\n```rb:gitlab.rb\ngitlab_rails['backup_upload_connection'] = {\n 'provider' => 'AWS',\n 'region' => 'us-west-2', # \u30ea\u30fc\u30b8\u30e7\u30f3\u3092\u6307\u5b9a\n 'aws_access_key_id' => 'AKIxxxxxxxxxx', # IAM\u3067\u30e6\u30fc\u30b6\u30fc\u3092\u4f5c\u3063\u305f\u6642\u306e\u30a2\u30af\u30bb\u30b9\u30ad\u30fcID\n 'aws_secret_access_key' => 'xxxxxxxxxxxxxxxxxxxxxxxxxxxx' # IAM\u3067\u30e6\u30fc\u30b6\u30fc\u3092\u4f5c\u3063\u305f\u6642\u306e\u30b7\u30fc\u30af\u30ec\u30c3\u30c8\u30a2\u30af\u30bb\u30b9\u30ad\u30fc\n}\ngitlab_rails['backup_upload_remote_directory'] = 'gitlab-backup'\n```\n\n\u8a18\u8ff0\u304c\u5b8c\u4e86\u3057\u305f\u3089\n\n```sh\n# gitlab-ctl reconfigure\n```\n\n\u3067\u8a2d\u5b9a\u3092\u53cd\u6620\u3002\n\n\n## \u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u3092\u5b9f\u884c\u3059\u308b\n\n```sh\n# gitlab-rake gitlab:backup:create\nDumping database ...\nDumping PostgreSQL database gitlabhq_production ... [DONE]\ndone\nDumping repositories ...\n * repository ... [DONE]\ndone\nDumping uploads ...\ndone\nDumping builds ...\ndone\nDumping artifacts ...\ndone\nDumping lfs objects ...\ndone\nCreating backup archive: 1458963192_gitlab_backup.tar ... done\nUploading backup archive to remote storage gitlab-backup ... done\nDeleting tmp directories ... done\ndone\ndone\ndone\ndone\ndone\ndone\nDeleting old backups ... skipping\n```\n\n*Uploading backup archive to remote storage gitlab-backup ... done* \u304c\u3042\u308c\u3070\u3001\u6b63\u5e38\u306bS3\u306b\u5bfe\u3057\u3066\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u304c\u5b8c\u4e86\u3002\n\nS3\u306e\u30b3\u30f3\u30bd\u30fc\u30eb\u3067\u78ba\u8a8d\u3059\u308b\u3068\u30d5\u30a1\u30a4\u30eb\u304c\u4f5c\u3089\u308c\u3066\u3044\u308b\u3002\n\n\n## cron\u306b\u8a2d\u5b9a\u3059\u308b\n\n```crontab:cron\n0 6 * * * /opt/gitlab/bin/gitlab-rake gitlab:backup:create CRON=1\n```\n\nCRON=1\u3092\u8a2d\u5b9a\u3059\u308b\u3053\u3068\u306b\u3088\u3063\u3066\u30a8\u30e9\u30fc\u4ee5\u5916\u306e\u51fa\u529b\u304c\u6291\u3048\u3089\u308c\u308b\u305d\u3046\u3067\u3059\u3002\nGitLab\u306e\u30da\u30fc\u30b8\u3067\u306fAM4:00\u306b\u5b9f\u884c\u3059\u308b\u3088\u3046\u306b\u306a\u3063\u3066\u307e\u3057\u305f\u304c\u3001AM4:00\u3060\u3068\u4ed6\u306e\u30d0\u30c3\u30c1\u3082\u52d5\u3044\u3066\u3044\u308b\u306e\u3068\u591c\u9045\u304f\u307e\u3067\u4f5c\u696d\u3057\u3066\u3044\u308b\u3068\u3001\u305f\u307e\u306bAM4\u3068\u304b\u306a\u308a\u305d\u3046\u306a\u306e\u3067\u3001\u305d\u3093\u306a\u3068\u304d\u306b\u5bdd\u3066\u308b\u3067\u3042\u308d\u3046AM6\u306b\u8a2d\u5b9a(^^;\n\n\u3053\u306e\u72b6\u614b\u3067\u3001\u660e\u65e5\u4ee5\u964d\n* S3\u306b\u4e0a\u3052\u305f\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u304cGlacier\u306b\u306a\u308b\u304b\uff1f\n* AM6:00\u306b\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u51e6\u7406\u304c\u5b9f\u884c\u3055\u308c\u30d5\u30a1\u30a4\u30eb\u304cS3\u306b\u4e0a\u304c\u308b\u304b\uff1f\n\n\u3092\u78ba\u8a8d\u3057\u3066\u3001OK\u3067\u3042\u308c\u3070\u5b8c\u4e86\u3067\u3059\u3002\n", "tags": ["GitLab", "S3", "AWS"]}