{"tags": ["packer", "Ansible", "AWS"], "context": " More than 1 year has passed since last update.\u30b5\u30fc\u30d0\u306e\u30ed\u30fc\u30eb\u3054\u3068\u306b playbook \u3092\u4f5c\u6210\u3057\u3066\u3001\u672c\u756a\u7528\u9014\u3068\u958b\u767a\u7528\u9014\u3067 playbook \u3092\u5206\u3051\u3066 web-app.prd.yml \u3068 web-app.dev.yml \u306e\u3088\u3046\u306b\u3057\u3066\u4f5c\u6210\u3059\u308bAMI\u306e\u5bfe\u8c61\u3092\u5909\u6570\u3067\u5207\u308a\u66ff\u3048\u3089\u308c\u308b\u3088\u3046\u306b\u3057\u3066\u3044\u308b\u3002\nPacker\u306eAnsible\u3067\u306f role_paths \u306b\u4e00\u3064\u4e00\u3064\u30ed\u30fc\u30eb\u3092\u8a2d\u5b9a\u3057\u306a\u3044\u3068 role \u304c\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u3055\u308c\u306a\u3044\u304c\u3001provisioners \u3067 roles \u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3054\u3068\u307e\u308b\u3063\u3068\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u3059\u308b\u3088\u3046\u306b\u4ed5\u8fbc\u3093\u3067\u3001\u3044\u3061\u3044\u3061\u6307\u5b9a\u3057\u306a\u304f\u3066\u3082\u826f\u3044\u3088\u3046\u306b\u3057\u3066\u3044\u308b\u3002\n{\n  \"variables\": {\n    \"role\":    \"\",\n    \"env\": \"\",\n    \"volume_size\": \"8\",\n    \"ansible_staging_directory\": \"/tmp/packer-provisioner-ansible-local\"\n  },\n  \"builders\": [{\n    \"type\": \"amazon-ebs\",\n    \"access_key\": \"<your access_key>\",\n    \"secret_key\": \"<your secret_key>\",\n    \"region\": \"ap-northeast-1\",\n    \"source_ami\": \"ami-4985b048\",\n    \"instance_type\": \"c3.large\",\n    \"ssh_username\": \"ec2-user\",\n    \"ssh_timeout\": \"5m\",\n    \"ami_name\": \"{{user `role`}}-{{isotime \\\"20060102-150405 MST\\\"}}\",\n    \"user_data_file\": \"combined-userdata.txt\",\n    \"ami_block_device_mappings\": [\n      { \"device_name\": \"/dev/xvda\", \"volume_type\": \"gp2\", \"volume_size\": \"{{user `volume_size`}}\", \"delete_on_termination\": true },\n      { \"device_name\": \"/dev/sdb\", \"virtual_name\": \"ephemeral0\" },\n      { \"device_name\": \"/dev/sdc\", \"virtual_name\": \"ephemeral1\" }\n    ],\n    \"tags\": {\n      \"Name\": \"{{user `role`}}\",\n      \"Environment\": \"{{user `env`}}\"\n    }\n  }],\n  \"provisioners\": [\n    { \"type\": \"shell\", \"script\": \"pre-process.sh\" },\n    {\n      \"type\": \"shell\",\n      \"inline\": [\n        \"mkdir -p {{ user `ansible_staging_directory` }}\"\n      ]\n    },\n    {\n      \"type\": \"file\",\n      \"source\": \"roles\",\n      \"destination\": \"{{ user `ansible_staging_directory` }}\"\n    },\n    {\n       \"type\": \"ansible-local\",\n       \"playbook_file\": \"{{user `role`}}.{{user `env`}}.yml\"\n    }\n  ]\n}\n\n$ packer build -var 'role=web-app' -var 'env=prd' packer.json\n\n\u30b5\u30fc\u30d0\u306e\u30ed\u30fc\u30eb\u3054\u3068\u306b playbook \u3092\u4f5c\u6210\u3057\u3066\u3001\u672c\u756a\u7528\u9014\u3068\u958b\u767a\u7528\u9014\u3067 playbook \u3092\u5206\u3051\u3066 web-app.prd.yml \u3068 web-app.dev.yml \u306e\u3088\u3046\u306b\u3057\u3066\u4f5c\u6210\u3059\u308bAMI\u306e\u5bfe\u8c61\u3092\u5909\u6570\u3067\u5207\u308a\u66ff\u3048\u3089\u308c\u308b\u3088\u3046\u306b\u3057\u3066\u3044\u308b\u3002\n\nPacker\u306eAnsible\u3067\u306f role_paths \u306b\u4e00\u3064\u4e00\u3064\u30ed\u30fc\u30eb\u3092\u8a2d\u5b9a\u3057\u306a\u3044\u3068 role \u304c\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u3055\u308c\u306a\u3044\u304c\u3001provisioners \u3067 roles \u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3054\u3068\u307e\u308b\u3063\u3068\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u3059\u308b\u3088\u3046\u306b\u4ed5\u8fbc\u3093\u3067\u3001\u3044\u3061\u3044\u3061\u6307\u5b9a\u3057\u306a\u304f\u3066\u3082\u826f\u3044\u3088\u3046\u306b\u3057\u3066\u3044\u308b\u3002\n\n```json\n{\n  \"variables\": {\n    \"role\":    \"\",\n    \"env\": \"\",\n    \"volume_size\": \"8\",\n    \"ansible_staging_directory\": \"/tmp/packer-provisioner-ansible-local\"\n  },\n  \"builders\": [{\n    \"type\": \"amazon-ebs\",\n    \"access_key\": \"<your access_key>\",\n    \"secret_key\": \"<your secret_key>\",\n    \"region\": \"ap-northeast-1\",\n    \"source_ami\": \"ami-4985b048\",\n    \"instance_type\": \"c3.large\",\n    \"ssh_username\": \"ec2-user\",\n    \"ssh_timeout\": \"5m\",\n    \"ami_name\": \"{{user `role`}}-{{isotime \\\"20060102-150405 MST\\\"}}\",\n    \"user_data_file\": \"combined-userdata.txt\",\n    \"ami_block_device_mappings\": [\n      { \"device_name\": \"/dev/xvda\", \"volume_type\": \"gp2\", \"volume_size\": \"{{user `volume_size`}}\", \"delete_on_termination\": true },\n      { \"device_name\": \"/dev/sdb\", \"virtual_name\": \"ephemeral0\" },\n      { \"device_name\": \"/dev/sdc\", \"virtual_name\": \"ephemeral1\" }\n    ],\n    \"tags\": {\n      \"Name\": \"{{user `role`}}\",\n      \"Environment\": \"{{user `env`}}\"\n    }\n  }],\n  \"provisioners\": [\n    { \"type\": \"shell\", \"script\": \"pre-process.sh\" },\n    {\n      \"type\": \"shell\",\n      \"inline\": [\n        \"mkdir -p {{ user `ansible_staging_directory` }}\"\n      ]\n    },\n    {\n      \"type\": \"file\",\n      \"source\": \"roles\",\n      \"destination\": \"{{ user `ansible_staging_directory` }}\"\n    },\n    {\n       \"type\": \"ansible-local\",\n       \"playbook_file\": \"{{user `role`}}.{{user `env`}}.yml\"\n    }\n  ]\n}\n```\n\n```bash\n$ packer build -var 'role=web-app' -var 'env=prd' packer.json\n```\n"}