{"context": " More than 1 year has passed since last update.\n\nGoal\n* RDBMS\u5074\u3067\u8907\u5408\u30e6\u30cb\u30fc\u30af\u30ad\u30fc\u3092\u8a2d\u5b9a\u3057\u3066\u3044\u308b\u524d\u63d0\n* Rails\u306e\u30d0\u30ea\u30c7\u30fc\u30b7\u30e7\u30f3\u306b\u3088\u3063\u3066\u3001Insert SQL\u3092\u6295\u3052\u308b\u524d\u306b\u91cd\u8907\u3092\u30c1\u30a7\u30c3\u30af\u3059\u308b\n\n\nPreparation\n$> uname -a\nLinux *** 2.6.32-358.el6.i686 #1 SMP Thu Feb 21 21:50:49 UTC 2013 i686 i686 i386 GNU/Linux\n$> cat /etc/issue\nCentOS release 6.4 (Final)\nKernel \\r on an \\m\n$> ruby -v\nruby 2.1.0p0 (2013-12-25 revision 44422) [i686-linux]\n$> rails -v\nRails 4.0.2\n\n\nExample\n* \u30e6\u30fc\u30b6\u304c\u5404\u8ab2\u984c\u306b\u5bfe\u3057\u30661\u65e51\u3064\u65e5\u5831\u3092\u51fa\u3059\u3068\u3044\u3046\u8a2d\u5b9a.\n* user(\u30e6\u30fc\u30b6)/date\uff08\u65e5\u306b\u3061\uff09/subject\uff08\u8ab2\u984c\uff09\u3067\u30e6\u30cb\u30fc\u30af\u306b\u306a\u308b\u3088\u3046\u306bRDBMS\u8a2d\u5b9a\u3057\u3066\u3044\u308b.\n* validates_with\u30d8\u30eb\u30d1\u3067\u30ab\u30b9\u30bf\u30e0\u30d0\u30ea\u30c7\u30fc\u30bf\u3092\u3088\u3073\u3060\u3059\n* \u30ab\u30b9\u30bf\u30e0\u30d0\u30ea\u30c7\u30fc\u30bf\u306fapp/validators\u4ee5\u4e0b\u306b\u5b9a\u7fa9\u3057\u3066\u3001record\u5909\u6570\u3067\u6e21\u3063\u3066\u304f\u308b\u30d0\u30ea\u30c7\u30fc\u30b7\u30e7\u30f3\u5bfe\u8c61\u3067DB select\u3092\u5b9f\u884c\u3059\u308b\n\n\napp/model/daily_report.rb\nclass DailyReport < ActiveRecord::Base\n  belongs_to :user\n  validates_with DailyReportComplexUniqueValidator\nend\n\n\n\napp/validators/daily_report_complex_validator.rb\nclass DailyReportComplexUniqueValidator < ActiveModel::Validator\n  def validate(record)\n    daily_report = DailyReport.find_by(\n      user_id: record[:user_id],\n      date: record[:date],\n      subject: record[:subject]\n    )\n    if !daily_report.nil?\n      record.errors[:base] << 'user_id, date, subject\u306e\u30c7\u30fc\u30bf\u304c\u3059\u3067\u306b\u5b58\u5728\u3057\u3066\u3044\u307e\u3059\u3002'\n    end\n  end\nend\n\n\n\nReferences\n\nhttp://edgeguides.rubyonrails.org/active_record_validations.html#performing-custom-validations\n\n\n# Goal\n\n```\n* RDBMS\u5074\u3067\u8907\u5408\u30e6\u30cb\u30fc\u30af\u30ad\u30fc\u3092\u8a2d\u5b9a\u3057\u3066\u3044\u308b\u524d\u63d0\n* Rails\u306e\u30d0\u30ea\u30c7\u30fc\u30b7\u30e7\u30f3\u306b\u3088\u3063\u3066\u3001Insert SQL\u3092\u6295\u3052\u308b\u524d\u306b\u91cd\u8907\u3092\u30c1\u30a7\u30c3\u30af\u3059\u308b\n```\n\n# Preparation\n\n```shell-session\n$> uname -a\nLinux *** 2.6.32-358.el6.i686 #1 SMP Thu Feb 21 21:50:49 UTC 2013 i686 i686 i386 GNU/Linux\n$> cat /etc/issue\nCentOS release 6.4 (Final)\nKernel \\r on an \\m\n$> ruby -v\nruby 2.1.0p0 (2013-12-25 revision 44422) [i686-linux]\n$> rails -v\nRails 4.0.2\n```\n\n# Example\n\n```\n* \u30e6\u30fc\u30b6\u304c\u5404\u8ab2\u984c\u306b\u5bfe\u3057\u30661\u65e51\u3064\u65e5\u5831\u3092\u51fa\u3059\u3068\u3044\u3046\u8a2d\u5b9a.\n* user(\u30e6\u30fc\u30b6)/date\uff08\u65e5\u306b\u3061\uff09/subject\uff08\u8ab2\u984c\uff09\u3067\u30e6\u30cb\u30fc\u30af\u306b\u306a\u308b\u3088\u3046\u306bRDBMS\u8a2d\u5b9a\u3057\u3066\u3044\u308b.\n* validates_with\u30d8\u30eb\u30d1\u3067\u30ab\u30b9\u30bf\u30e0\u30d0\u30ea\u30c7\u30fc\u30bf\u3092\u3088\u3073\u3060\u3059\n* \u30ab\u30b9\u30bf\u30e0\u30d0\u30ea\u30c7\u30fc\u30bf\u306fapp/validators\u4ee5\u4e0b\u306b\u5b9a\u7fa9\u3057\u3066\u3001record\u5909\u6570\u3067\u6e21\u3063\u3066\u304f\u308b\u30d0\u30ea\u30c7\u30fc\u30b7\u30e7\u30f3\u5bfe\u8c61\u3067DB select\u3092\u5b9f\u884c\u3059\u308b\n```\n\n```rb:app/model/daily_report.rb\nclass DailyReport < ActiveRecord::Base\n  belongs_to :user\n  validates_with DailyReportComplexUniqueValidator\nend\n```\n\n```rb:app/validators/daily_report_complex_validator.rb\nclass DailyReportComplexUniqueValidator < ActiveModel::Validator\n  def validate(record)\n    daily_report = DailyReport.find_by(\n      user_id: record[:user_id],\n      date: record[:date],\n      subject: record[:subject]\n    )\n    if !daily_report.nil?\n      record.errors[:base] << 'user_id, date, subject\u306e\u30c7\u30fc\u30bf\u304c\u3059\u3067\u306b\u5b58\u5728\u3057\u3066\u3044\u307e\u3059\u3002'\n    end\n  end\nend\n```\n\n# References\n\n* http://edgeguides.rubyonrails.org/active_record_validations.html#performing-custom-validations", "tags": ["Rails4.0.2", "ActiveRecord", "ActiveModel"]}