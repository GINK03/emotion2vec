{"context": " More than 1 year has passed since last update.\u3053\u3046\u3044\u3046\u306e\u304clogwatch\u3067\u767a\u898b\u3057\u305f\u306e\u3067\u5bfe\u51e6\u3002\n\n\u4ee5\u524dfail2ban\u3092\u5165\u308c\u305f\u304c\u3001(\u305d\u308c\u304c\u539f\u56e0\u304b\u308f\u304b\u3089\u306a\u3044\u304c)\u30cf\u30f3\u30b0\u30a2\u30c3\u30d7\u3057\u305f\u306e\u3067\u3084\u3081\u305f\u3002\niptables\u306b\u3064\u3044\u3066\u306f\u30b3\u30d4\u30da\u304b\u3089\u8131\u51fa\uff01iptables\u306e\u4ed5\u7d44\u307f\u3092\u7406\u89e3\u3057\u3066\u74b0\u5883\u306b\u5408\u308f\u305b\u305f\u8a2d\u5b9a\u3092\u3057\u3088\u3046 | OXY NOTES\u304c\u8a73\u3057\u3044\u3002\n\nupdate_iptables.sh\ndownload\nAnsible\u3068\u7d44\u307f\u5408\u308f\u305b\u3066(\uff9f\u0434\uff9f)\uff73\uff8f\uff70\n\nupdate_iptables.sh\n#!/bin/sh\nset -eu\n\nDROPLIST=\"droplist.txt\"\n\nhead() {\n  echo \"*mangle\"\n  echo \":PREROUTING ACCEPT\"\n  echo \":INPUT ACCEPT\"\n  echo \":FORWARD ACCEPT\"\n  echo \":OUTPUT ACCEPT\"\n  echo \":POSTROUTING ACCEPT\"\n  echo \"COMMIT\"\n  echo \"\"\n  echo \"*nat\"\n  echo \":PREROUTING ACCEPT\"\n  echo \":POSTROUTING ACCEPT\"\n  echo \":OUTPUT ACCEPT\"\n  echo \"COMMIT\"\n  echo \"\"\n  echo \"*filter\"\n  echo \":INPUT ACCEPT\"\n  echo \":FORWARD ACCEPT\"\n  echo \":OUTPUT ACCEPT\"\n}\nbody() {\n  cat ${DROPLIST} | while read line\n  do\n    STRCHECK=$(echo ${line} | cut -c 1)\n    if [ $STRCHECK != \"#\" ];then\n      echo \"-A INPUT -s ${line} -j DROP\"\n    fi\n  done\n}\nfoot() {\n  echo \"-A INPUT -j ACCEPT\"\n  echo \"COMMIT\"\n}\n\n\nhead > rule\nbody >> rule\nfoot >> rule\n\nfor target in mangle nat filter\ndo\n  iptables -F -t $target\ndone\n\niptables-restore < rule\n\nfor target in mangle nat filter\ndo\n  echo\n  echo \"## $target\"\n  iptables -nL -t $target\ndone\n\n\n\n\u5b9f\u884c\nsudo sh update_iptables.sh\n\n\u6b21\u56de\u8d77\u52d5\u6642\u306b\u3082\u9069\u7528\u3059\u308b\u306b\u306f /etc/rc.local \u3067 update_iptables.sh \u3092\u5b9f\u884c\u3055\u305b\u308c\u3070\u3088\u3044\n\n\u4ed5\u69d8\nupdate_iptables.sh\u3092\u5b9f\u884c\u3059\u308b\u3068droplist.txt\u3092\u4e00\u884c\u3065\u3064\u8aad\u307f\u8fbc\u307fdrop\u6307\u5b9a\u3002\n\ndroplist.txt\u306f\u4ee5\u4e0b\u306e\u69d8\u306a\u66f8\u5f0f\n\n\ndroplist.txt\n# \u306a\u308a\u3059\u307e\u3057\u30e1\u30fc\u30eb\u9001\u4fe1\u8005\n23.239.20.57\n198.58.96.176\n72.14.182.114\n173.230.157.247\n# LOGIN FAILED\n202.70.136.74\n190.241.183.123\n# \u30e1\u30fc\u30eb\u8a8d\u8a3c\u306b\u5931\u6557\n111.73.45.149\n118.193.155.18\n12.133.41.130\n177.19.151.139\n50.57.66.229\n61.136.153.176\n79.59.139.45\n91.98.108.45\n\n\n\niptables-restore\u306b\u6e21\u3059\u5185\u5bb9\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u308b\u3002\n\n\nrule\n*mangle\n:PREROUTING ACCEPT\n:INPUT ACCEPT\n:FORWARD ACCEPT\n:OUTPUT ACCEPT\n:POSTROUTING ACCEPT\nCOMMIT\n\n*nat\n:PREROUTING ACCEPT\n:POSTROUTING ACCEPT\n:OUTPUT ACCEPT\nCOMMIT\n\n*filter\n:INPUT ACCEPT\n:FORWARD ACCEPT\n:OUTPUT ACCEPT\n-A INPUT -s 23.239.20.57 -j DROP\n-A INPUT -s 198.58.96.176 -j DROP\n-A INPUT -s 72.14.182.114 -j DROP\n-A INPUT -s 173.230.157.247 -j DROP\n-A INPUT -s 202.70.136.74 -j DROP\n-A INPUT -s 190.241.183.123 -j DROP\n-A INPUT -s 111.73.45.149 -j DROP\n-A INPUT -s 118.193.155.18 -j DROP\n-A INPUT -s 12.133.41.130 -j DROP\n-A INPUT -s 177.19.151.139 -j DROP\n-A INPUT -s 50.57.66.229 -j DROP\n-A INPUT -s 61.136.153.176 -j DROP\n-A INPUT -s 79.59.139.45 -j DROP\n-A INPUT -s 91.98.108.45 -j DROP\n-A INPUT -j ACCEPT\nCOMMIT\n\n\n\niptables\u306e\u7d50\u679c\n## mangle\nChain PREROUTING (policy ACCEPT)\ntarget     prot opt source               destination\n\nChain INPUT (policy ACCEPT)\ntarget     prot opt source               destination\n\nChain FORWARD (policy ACCEPT)\ntarget     prot opt source               destination\n\nChain OUTPUT (policy ACCEPT)\ntarget     prot opt source               destination\n\nChain POSTROUTING (policy ACCEPT)\ntarget     prot opt source               destination\n\n## nat\nChain PREROUTING (policy ACCEPT)\ntarget     prot opt source               destination\n\nChain POSTROUTING (policy ACCEPT)\ntarget     prot opt source               destination\n\nChain OUTPUT (policy ACCEPT)\ntarget     prot opt source               destination\n\n## filter\nChain INPUT (policy ACCEPT)\ntarget     prot opt source               destination\nDROP       0    --  23.239.20.57         0.0.0.0/0\nDROP       0    --  198.58.96.176        0.0.0.0/0\nDROP       0    --  72.14.182.114        0.0.0.0/0\nDROP       0    --  173.230.157.247      0.0.0.0/0\nDROP       0    --  202.70.136.74        0.0.0.0/0\nDROP       0    --  190.241.183.123      0.0.0.0/0\nDROP       0    --  111.73.45.149        0.0.0.0/0\nDROP       0    --  118.193.155.18       0.0.0.0/0\nDROP       0    --  12.133.41.130        0.0.0.0/0\nDROP       0    --  177.19.151.139       0.0.0.0/0\nDROP       0    --  50.57.66.229         0.0.0.0/0\nDROP       0    --  61.136.153.176       0.0.0.0/0\nDROP       0    --  79.59.139.45         0.0.0.0/0\nDROP       0    --  91.98.108.45         0.0.0.0/0\nACCEPT     0    --  0.0.0.0/0            0.0.0.0/0\n\nChain FORWARD (policy ACCEPT)\ntarget     prot opt source               destination\n\nChain OUTPUT (policy ACCEPT)\ntarget     prot opt source               destination\n\n\n\u3053\u3046\u3044\u3046\u306e\u304clogwatch\u3067\u767a\u898b\u3057\u305f\u306e\u3067\u5bfe\u51e6\u3002\n\n![\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2014-08-27 8.15.39.png](https://qiita-image-store.s3.amazonaws.com/0/25728/94c9de74-f4a7-8cde-dcb0-4e092f12518e.png)\n\n[\u4ee5\u524dfail2ban\u3092\u5165\u308c\u305f](http://qiita.com/tukiyo3/items/fc69e84ac2b9aae7d16c)\u304c\u3001(\u305d\u308c\u304c\u539f\u56e0\u304b\u308f\u304b\u3089\u306a\u3044\u304c)\u30cf\u30f3\u30b0\u30a2\u30c3\u30d7\u3057\u305f\u306e\u3067\u3084\u3081\u305f\u3002\n\niptables\u306b\u3064\u3044\u3066\u306f[\u30b3\u30d4\u30da\u304b\u3089\u8131\u51fa\uff01iptables\u306e\u4ed5\u7d44\u307f\u3092\u7406\u89e3\u3057\u3066\u74b0\u5883\u306b\u5408\u308f\u305b\u305f\u8a2d\u5b9a\u3092\u3057\u3088\u3046 | OXY NOTES](http://oxynotes.com/?p=6361)\u304c\u8a73\u3057\u3044\u3002\n\n# update_iptables.sh\n\n[download](https://github.com/tukiyo/iptables_filter_list.sh)\nAnsible\u3068\u7d44\u307f\u5408\u308f\u305b\u3066(\uff9f\u0434\uff9f)\uff73\uff8f\uff70\n\n```bash:update_iptables.sh\n#!/bin/sh\nset -eu\n\nDROPLIST=\"droplist.txt\"\n\nhead() {\n  echo \"*mangle\"\n  echo \":PREROUTING ACCEPT\"\n  echo \":INPUT ACCEPT\"\n  echo \":FORWARD ACCEPT\"\n  echo \":OUTPUT ACCEPT\"\n  echo \":POSTROUTING ACCEPT\"\n  echo \"COMMIT\"\n  echo \"\"\n  echo \"*nat\"\n  echo \":PREROUTING ACCEPT\"\n  echo \":POSTROUTING ACCEPT\"\n  echo \":OUTPUT ACCEPT\"\n  echo \"COMMIT\"\n  echo \"\"\n  echo \"*filter\"\n  echo \":INPUT ACCEPT\"\n  echo \":FORWARD ACCEPT\"\n  echo \":OUTPUT ACCEPT\"\n}\nbody() {\n  cat ${DROPLIST} | while read line\n  do\n    STRCHECK=$(echo ${line} | cut -c 1)\n    if [ $STRCHECK != \"#\" ];then\n      echo \"-A INPUT -s ${line} -j DROP\"\n    fi\n  done\n}\nfoot() {\n  echo \"-A INPUT -j ACCEPT\"\n  echo \"COMMIT\"\n}\n\n\nhead > rule\nbody >> rule\nfoot >> rule\n\nfor target in mangle nat filter\ndo\n  iptables -F -t $target\ndone\n\niptables-restore < rule\n\nfor target in mangle nat filter\ndo\n  echo\n  echo \"## $target\"\n  iptables -nL -t $target\ndone\n```\n\n# \u5b9f\u884c\n\n```bash:\nsudo sh update_iptables.sh\n```\n\n\u6b21\u56de\u8d77\u52d5\u6642\u306b\u3082\u9069\u7528\u3059\u308b\u306b\u306f /etc/rc.local \u3067 update_iptables.sh \u3092\u5b9f\u884c\u3055\u305b\u308c\u3070\u3088\u3044\n\n\n# \u4ed5\u69d8\n\n`update_iptables.sh`\u3092\u5b9f\u884c\u3059\u308b\u3068`droplist.txt`\u3092\u4e00\u884c\u3065\u3064\u8aad\u307f\u8fbc\u307fdrop\u6307\u5b9a\u3002\n\n* droplist.txt\u306f\u4ee5\u4e0b\u306e\u69d8\u306a\u66f8\u5f0f\n\n```bash:droplist.txt\n# \u306a\u308a\u3059\u307e\u3057\u30e1\u30fc\u30eb\u9001\u4fe1\u8005\n23.239.20.57\n198.58.96.176\n72.14.182.114\n173.230.157.247\n# LOGIN FAILED\n202.70.136.74\n190.241.183.123\n# \u30e1\u30fc\u30eb\u8a8d\u8a3c\u306b\u5931\u6557\n111.73.45.149\n118.193.155.18\n12.133.41.130\n177.19.151.139\n50.57.66.229\n61.136.153.176\n79.59.139.45\n91.98.108.45\n```\n\n* iptables-restore\u306b\u6e21\u3059\u5185\u5bb9\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u308b\u3002\n\n```bash:rule\n*mangle\n:PREROUTING ACCEPT\n:INPUT ACCEPT\n:FORWARD ACCEPT\n:OUTPUT ACCEPT\n:POSTROUTING ACCEPT\nCOMMIT\n\n*nat\n:PREROUTING ACCEPT\n:POSTROUTING ACCEPT\n:OUTPUT ACCEPT\nCOMMIT\n\n*filter\n:INPUT ACCEPT\n:FORWARD ACCEPT\n:OUTPUT ACCEPT\n-A INPUT -s 23.239.20.57 -j DROP\n-A INPUT -s 198.58.96.176 -j DROP\n-A INPUT -s 72.14.182.114 -j DROP\n-A INPUT -s 173.230.157.247 -j DROP\n-A INPUT -s 202.70.136.74 -j DROP\n-A INPUT -s 190.241.183.123 -j DROP\n-A INPUT -s 111.73.45.149 -j DROP\n-A INPUT -s 118.193.155.18 -j DROP\n-A INPUT -s 12.133.41.130 -j DROP\n-A INPUT -s 177.19.151.139 -j DROP\n-A INPUT -s 50.57.66.229 -j DROP\n-A INPUT -s 61.136.153.176 -j DROP\n-A INPUT -s 79.59.139.45 -j DROP\n-A INPUT -s 91.98.108.45 -j DROP\n-A INPUT -j ACCEPT\nCOMMIT\n```\n\n```bash:iptables\u306e\u7d50\u679c\n## mangle\nChain PREROUTING (policy ACCEPT)\ntarget     prot opt source               destination\n\nChain INPUT (policy ACCEPT)\ntarget     prot opt source               destination\n\nChain FORWARD (policy ACCEPT)\ntarget     prot opt source               destination\n\nChain OUTPUT (policy ACCEPT)\ntarget     prot opt source               destination\n\nChain POSTROUTING (policy ACCEPT)\ntarget     prot opt source               destination\n\n## nat\nChain PREROUTING (policy ACCEPT)\ntarget     prot opt source               destination\n\nChain POSTROUTING (policy ACCEPT)\ntarget     prot opt source               destination\n\nChain OUTPUT (policy ACCEPT)\ntarget     prot opt source               destination\n\n## filter\nChain INPUT (policy ACCEPT)\ntarget     prot opt source               destination\nDROP       0    --  23.239.20.57         0.0.0.0/0\nDROP       0    --  198.58.96.176        0.0.0.0/0\nDROP       0    --  72.14.182.114        0.0.0.0/0\nDROP       0    --  173.230.157.247      0.0.0.0/0\nDROP       0    --  202.70.136.74        0.0.0.0/0\nDROP       0    --  190.241.183.123      0.0.0.0/0\nDROP       0    --  111.73.45.149        0.0.0.0/0\nDROP       0    --  118.193.155.18       0.0.0.0/0\nDROP       0    --  12.133.41.130        0.0.0.0/0\nDROP       0    --  177.19.151.139       0.0.0.0/0\nDROP       0    --  50.57.66.229         0.0.0.0/0\nDROP       0    --  61.136.153.176       0.0.0.0/0\nDROP       0    --  79.59.139.45         0.0.0.0/0\nDROP       0    --  91.98.108.45         0.0.0.0/0\nACCEPT     0    --  0.0.0.0/0            0.0.0.0/0\n\nChain FORWARD (policy ACCEPT)\ntarget     prot opt source               destination\n\nChain OUTPUT (policy ACCEPT)\ntarget     prot opt source               destination\n```\n", "tags": ["iptables", "ShellScript"]}