{"tags": ["\u30b2\u30fc\u30e0"], "context": "\n\n\u3053\u306e\u8a18\u4e8b\u306f\n\u3068\u3042\u308b\u30ab\u30fc\u30c9\u30b2\u30fc\u30e0\u304c\u975e\u5e38\u306b\u9762\u767d\u304f\u3001\n\u305d\u306e\u30b2\u30fc\u30e0\u306e\u898b\u305f\u76ee\u30af\u30ed\u30fc\u30f3\u3092\u4f5c\u308d\u3046\u3068\u4e00\u4eba\u306e\u30d7\u30ed\u30b0\u30e9\u30de\u30fc\u304c\u596e\u95d8\u3057\u3066\u3044\u304f\u30d6\u30ed\u30b0\u306e\u3088\u3046\u306a\u8a18\u4e8b\u3067\u3059\u3002\n\u305d\u306e\uff18\u304b\u3089\u306e\u7d9a\u304d\n\uff08\u305d\u306e\uff19\u306f\u539f\u56e0\u4e0d\u660e\u306e\u30a8\u30e9\u30fc\u306b\u60a9\u307e\u3055\u308c\u305f\u8a18\u61b6\u3067\u3059\u3002\n\u3000\u3000\u307e\u3060\u89e3\u6c7a\u3057\u3066\u3044\u306a\u3044\u306e\u3067\u3001\u89e3\u6c7a\u3057\u3066\u304b\u3089\u8f09\u305b\u307e\u3059\u3002\n\u3000\u3000\u3088\u3051\u308c\u3070teratail\u306b\u3042\u3052\u3066\u3044\u307e\u3059\u306e\u3067\u3001\n\u3000\u3000\u304a\u30d2\u30de\u304c\u3042\u308c\u3070\u56de\u7b54\u304f\u3060\u3055\u308b\u3068\u4e21\u624b\u3092\u4e0a\u3052\u3066\u559c\u3073\u307e\u3059\u3002\uff09\n\u3053\u3053\u3067\u306f\u3001\u524d\u56de\u4f5c\u3063\u305f\u30d7\u30ed\u30b0\u30e9\u30e0\u306e\u30ea\u30d5\u30a1\u30af\u30bf\u30ea\u30f3\u30b0\u3092\u3057\u307e\u3059\u3002\n\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u30fc\u304c\u5206\u539a\u3044\u306e\u3067\u4ed6\u306b\u79fb\u3057\u307e\u3059\u3002\n\nConcern\u306b\u79fb\u3059\n\u307e\u305a\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u304c\u8584\u304f\u306a\u3063\u305f\u7d50\u679c\u3092\n\napp/controllers/battles_controller.rb\nhallucigeniaAir:CambrianServer TakuAndo$ cat app/controllers/battles_controller.rb\n# encoding: utf-8\n#  \u6226\u95d8\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\n#  Author:: Kuroko Sin\n#  Date::   2016/2/1\n\nclass BattlesController < ApplicationController\n  include Battle::BattleTimeline\n  before_action :set_battle, only: [:show, :update, :destroy]\n\n  #  \u6226\u95d8API \u30e1\u30a4\u30f3\u30a2\u30af\u30b7\u30e7\u30f3\n  #  Param::  BType, UId, BTarget, V\n  #  Return:: Result\n  def index\n    # @battles = Battle.all\n    #\n    # render json: @battles\n    # render json: [\"hoge\", params[:BType],\n    #                       params[:UId], params[:BTarget], params[:V] ]\n    _BType = params[:BType]\n    _UId   = params[:UId]\n    _BTargetId = params[:BTarget]\n    _V = params[:V]\n\n    #binding.pry\n    # myDeck \u53d6\u5f97\n    _UDeck = DeckInfo.find_by(UserId: _UId)\n    # targetDeck \u53d6\u5f97\n    _BTarget = DeckInfo.find_by(UserId: _BTargetId)\n\n    # binding.pry\n    Rails.root.join(\"app/models/concern/battle/battle_timeline.rb\")\n    _result = lets_battle( _UDeck, _BTarget )\n\n    render json:  _result\n  end\n\n  # GET /battles/1\n  # GET /battles/1.json\n  def show\n    render json: @battle\n  end\n\n  # POST /battles\n  # POST /battles.json\n  def create\n    @battle = Battle.new(battle_params)\n\n    if @battle.save\n      render json: @battle, status: :created, location: @battle\n    else\n      render json: @battle.errors, status: :unprocessable_entity\n    end\n  end\n\n  # PATCH/PUT /battles/1\n  # PATCH/PUT /battles/1.json\n  def update\n    @battle = Battle.find(params[:id])\n\n    if @battle.update(battle_params)\n      head :no_content\n    else\n      render json: @battle.errors, status: :unprocessable_entity\n    end\n  end\n\n  # DELETE /battles/1\n  # DELETE /battles/1.json\n  def destroy\n    @battle.destroy\n\n    head :no_content\n  end\n\n  private\n\n    def set_battle\n      @battle = Battle.find(params[:id])\n    end\n\n    def battle_params\n      params.require(:battle).permit(:ID, :Btype, :BTarget, :V, :UA)\n    end\nend\n\n\n\u79fb\u3057\u305f\u5148\u306e\u30b3\u30fc\u30c9\u3002Concern\u306b\u79fb\u52d5\u3055\u305b\u307e\u3057\u305f\u3002\n\napp/models/concerns/battle/battle_timeline.rb\nmodule Battle::BattleTimeline extend ActiveSupport::Concern\n  def set_field( ur, en )\n    return ur\n  end\n\n  def set_bonus( deck )\n    return deck\n  end\n\n  def lets_battle( first_attacker, post_attacker )\n    _f = first_attacker\n    _p = post_attacker\n    _Result = 0\n    begin\n      case _f.UserId\n      when \"Kingdom\"\n        case _p.UserId\n        when \"Kingdom\"\n          _BWinner = 0\n        when \"Spiritual\"\n          _BWinner = 0\n        when \"Tribal\"\n          _BWinner = -1\n        when \"Pluto\"\n          _BWinner = 1\n        else\n          _Result = 9\n        end\n      when \"Spiritual\"\n        case _p.UserId\n        when \"Kingdom\"\n          _BWinner = 0\n        when \"Spiritual\"\n          _BWinner = 0\n        when \"Tribal\"\n          _BWinner = 1\n        when \"Pluto\"\n          _BWinner = -1\n        else\n          _Result = 9\n        end\n       when \"Tribal\"\n         case _p.UserId\n         when \"Kingdom\"\n           _BWinner = 1\n         when \"Spiritual\"\n           _BWinner = -1\n         when \"Tribal\"\n           _BWinner = 0\n         when \"Pluto\"\n           _BWinner = 0\n         else\n           _Result = 9\n         end\n       when \"Pluto\"\n         case _p.UserId\n         when \"Kingdom\"\n           _BWinner = -1\n         when \"Spiritual\"\n           _BWinner = 1\n         when \"Tribal\"\n           _BWinner = 0\n         when \"Pluto\"\n           _BWinner = 0\n         else\n           _Result = 9\n         end\n       else\n         _Result = 9\n       end\n\n    rescue => ex\n      _Result = 9\n      _BProcess = {}\n    end\n\n    _ret = {'Result' => _Result, 'BWinner' => _BWinner, 'BProcess' => _BProcess }\n    return _ret\n  end\nend\n\n\n\u3001\u3001\u3001\u306f\u3044\u3002\u672c\u5f53\u306b\u79fb\u3057\u305f\u3060\u3051\u3067\u3059\u3002\n\u3067\u3001\u30c6\u30b9\u30c8\u3092\u3084\u3063\u3066\u3046\u307e\u304f\u8a00\u3063\u3066\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3057\u307e\u3057\u305f\n$ rake test\nRun options: --seed 42501\n\n# Running:\n\n......................\n\nFinished in 0.299227s, 73.5227 runs/s, 193.8327 assertions/s.\n\n22 runs, 58 assertions, 0 failures, 0 errors, 0 skips\n\n\n\u3044\u304f\u3064\u304b\u8a00\u3044\u8a33\n\n\u4e0d\u5b9a\u671f\u9023\u8f09\u3067\u3059\u3002\n\u591a\u5206\u9014\u4e2d\u3067\u632b\u6298\u3057\u307e\u3059\u3002\n\u7b46\u8005\u306e\u30e1\u30e2\u3082\u517c\u306d\u3066\u3044\u308b\u305f\u3081\u904e\u53bb\u306e\u8a18\u4e8b\u3082\u9060\u616e\u306a\u304f\u968f\u6642\u7de8\u96c6\u3044\u305f\u3057\u307e\u3059\u3002\n\u30d7\u30ed\u30b0\u30e9\u30df\u30f3\u30b0\u306e\u958b\u767a\u7d4c\u9a13\u306f\u3042\u3063\u3066\u3082\u30b2\u30fc\u30e0\u306e\u958b\u767a\u7d4c\u9a13\u306f\u3053\u308c\u304c\u521d\u3081\u3066\u3067\u3059\u3002\n\n\u7b49\u8272\u3005\u3042\u308a\u307e\u3059\u304c\u3001\u751f\u6696\u304b\u3044\u76ee\u3067\u5fdc\u63f4\u3057\u3066\u304f\u3060\u3055\u308b\u3068\u5149\u6804\u3067\u3059\u3002\n\n##\u3053\u306e\u8a18\u4e8b\u306f\n\u3068\u3042\u308b[\u30ab\u30fc\u30c9\u30b2\u30fc\u30e0](http://arcana.vector.co.jp)\u304c\u975e\u5e38\u306b\u9762\u767d\u304f\u3001\n\u305d\u306e\u30b2\u30fc\u30e0\u306e\u898b\u305f\u76ee\u30af\u30ed\u30fc\u30f3\u3092\u4f5c\u308d\u3046\u3068\u4e00\u4eba\u306e\u30d7\u30ed\u30b0\u30e9\u30de\u30fc\u304c\u596e\u95d8\u3057\u3066\u3044\u304f\u30d6\u30ed\u30b0\u306e\u3088\u3046\u306a\u8a18\u4e8b\u3067\u3059\u3002\n\n\u305d\u306e\uff18\u304b\u3089\u306e\u7d9a\u304d\n\uff08\u305d\u306e\uff19\u306f\u539f\u56e0\u4e0d\u660e\u306e\u30a8\u30e9\u30fc\u306b\u60a9\u307e\u3055\u308c\u305f\u8a18\u61b6\u3067\u3059\u3002\n\u3000\u3000\u307e\u3060\u89e3\u6c7a\u3057\u3066\u3044\u306a\u3044\u306e\u3067\u3001\u89e3\u6c7a\u3057\u3066\u304b\u3089\u8f09\u305b\u307e\u3059\u3002\n\u3000\u3000\u3088\u3051\u308c\u3070[teratail](https://teratail.com/questions/33335)\u306b\u3042\u3052\u3066\u3044\u307e\u3059\u306e\u3067\u3001\n\u3000\u3000\u304a\u30d2\u30de\u304c\u3042\u308c\u3070\u56de\u7b54\u304f\u3060\u3055\u308b\u3068\u4e21\u624b\u3092\u4e0a\u3052\u3066\u559c\u3073\u307e\u3059\u3002\uff09\n\n\u3053\u3053\u3067\u306f\u3001\u524d\u56de\u4f5c\u3063\u305f\u30d7\u30ed\u30b0\u30e9\u30e0\u306e\u30ea\u30d5\u30a1\u30af\u30bf\u30ea\u30f3\u30b0\u3092\u3057\u307e\u3059\u3002\n\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u30fc\u304c\u5206\u539a\u3044\u306e\u3067\u4ed6\u306b\u79fb\u3057\u307e\u3059\u3002\n\n## Concern\u306b\u79fb\u3059\n\u307e\u305a\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u304c\u8584\u304f\u306a\u3063\u305f\u7d50\u679c\u3092\n\n```ruby:app/controllers/battles_controller.rb\nhallucigeniaAir:CambrianServer TakuAndo$ cat app/controllers/battles_controller.rb\n# encoding: utf-8\n#  \u6226\u95d8\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\n#  Author:: Kuroko Sin\n#  Date::   2016/2/1\n\nclass BattlesController < ApplicationController\n  include Battle::BattleTimeline\n  before_action :set_battle, only: [:show, :update, :destroy]\n\n  #  \u6226\u95d8API \u30e1\u30a4\u30f3\u30a2\u30af\u30b7\u30e7\u30f3\n  #  Param::  BType, UId, BTarget, V\n  #  Return:: Result\n  def index\n    # @battles = Battle.all\n    #\n    # render json: @battles\n    # render json: [\"hoge\", params[:BType],\n    #                       params[:UId], params[:BTarget], params[:V] ]\n    _BType = params[:BType]\n    _UId   = params[:UId]\n    _BTargetId = params[:BTarget]\n    _V = params[:V]\n\n    #binding.pry\n    # myDeck \u53d6\u5f97\n    _UDeck = DeckInfo.find_by(UserId: _UId)\n    # targetDeck \u53d6\u5f97\n    _BTarget = DeckInfo.find_by(UserId: _BTargetId)\n\n    # binding.pry\n    Rails.root.join(\"app/models/concern/battle/battle_timeline.rb\")\n    _result = lets_battle( _UDeck, _BTarget )\n\n    render json:  _result\n  end\n\n  # GET /battles/1\n  # GET /battles/1.json\n  def show\n    render json: @battle\n  end\n\n  # POST /battles\n  # POST /battles.json\n  def create\n    @battle = Battle.new(battle_params)\n\n    if @battle.save\n      render json: @battle, status: :created, location: @battle\n    else\n      render json: @battle.errors, status: :unprocessable_entity\n    end\n  end\n\n  # PATCH/PUT /battles/1\n  # PATCH/PUT /battles/1.json\n  def update\n    @battle = Battle.find(params[:id])\n\n    if @battle.update(battle_params)\n      head :no_content\n    else\n      render json: @battle.errors, status: :unprocessable_entity\n    end\n  end\n\n  # DELETE /battles/1\n  # DELETE /battles/1.json\n  def destroy\n    @battle.destroy\n\n    head :no_content\n  end\n\n  private\n\n    def set_battle\n      @battle = Battle.find(params[:id])\n    end\n\n    def battle_params\n      params.require(:battle).permit(:ID, :Btype, :BTarget, :V, :UA)\n    end\nend\n```\n\n\u79fb\u3057\u305f\u5148\u306e\u30b3\u30fc\u30c9\u3002Concern\u306b\u79fb\u52d5\u3055\u305b\u307e\u3057\u305f\u3002\n\n```ruby:app/models/concerns/battle/battle_timeline.rb\nmodule Battle::BattleTimeline extend ActiveSupport::Concern\n  def set_field( ur, en )\n    return ur\n  end\n\n  def set_bonus( deck )\n    return deck\n  end\n\n  def lets_battle( first_attacker, post_attacker )\n    _f = first_attacker\n    _p = post_attacker\n    _Result = 0\n    begin\n      case _f.UserId\n      when \"Kingdom\"\n        case _p.UserId\n        when \"Kingdom\"\n          _BWinner = 0\n        when \"Spiritual\"\n          _BWinner = 0\n        when \"Tribal\"\n          _BWinner = -1\n        when \"Pluto\"\n          _BWinner = 1\n        else\n          _Result = 9\n        end\n      when \"Spiritual\"\n        case _p.UserId\n        when \"Kingdom\"\n          _BWinner = 0\n        when \"Spiritual\"\n          _BWinner = 0\n        when \"Tribal\"\n          _BWinner = 1\n        when \"Pluto\"\n          _BWinner = -1\n        else\n          _Result = 9\n        end\n       when \"Tribal\"\n         case _p.UserId\n         when \"Kingdom\"\n           _BWinner = 1\n         when \"Spiritual\"\n           _BWinner = -1\n         when \"Tribal\"\n           _BWinner = 0\n         when \"Pluto\"\n           _BWinner = 0\n         else\n           _Result = 9\n         end\n       when \"Pluto\"\n         case _p.UserId\n         when \"Kingdom\"\n           _BWinner = -1\n         when \"Spiritual\"\n           _BWinner = 1\n         when \"Tribal\"\n           _BWinner = 0\n         when \"Pluto\"\n           _BWinner = 0\n         else\n           _Result = 9\n         end\n       else\n         _Result = 9\n       end\n\n    rescue => ex\n      _Result = 9\n      _BProcess = {}\n    end\n\n    _ret = {'Result' => _Result, 'BWinner' => _BWinner, 'BProcess' => _BProcess }\n    return _ret\n  end\nend\n```\n\n\u3001\u3001\u3001\u306f\u3044\u3002\u672c\u5f53\u306b\u79fb\u3057\u305f\u3060\u3051\u3067\u3059\u3002\n\u3067\u3001\u30c6\u30b9\u30c8\u3092\u3084\u3063\u3066\u3046\u307e\u304f\u8a00\u3063\u3066\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3057\u307e\u3057\u305f\n\n```\n$ rake test\nRun options: --seed 42501\n\n# Running:\n\n......................\n\nFinished in 0.299227s, 73.5227 runs/s, 193.8327 assertions/s.\n\n22 runs, 58 assertions, 0 failures, 0 errors, 0 skips\n```\n\n\n-----\n\u3044\u304f\u3064\u304b\u8a00\u3044\u8a33\n\n* \u4e0d\u5b9a\u671f\u9023\u8f09\u3067\u3059\u3002\n* \u591a\u5206\u9014\u4e2d\u3067\u632b\u6298\u3057\u307e\u3059\u3002\n* \u7b46\u8005\u306e\u30e1\u30e2\u3082\u517c\u306d\u3066\u3044\u308b\u305f\u3081\u904e\u53bb\u306e\u8a18\u4e8b\u3082\u9060\u616e\u306a\u304f\u968f\u6642\u7de8\u96c6\u3044\u305f\u3057\u307e\u3059\u3002\n* \u30d7\u30ed\u30b0\u30e9\u30df\u30f3\u30b0\u306e\u958b\u767a\u7d4c\u9a13\u306f\u3042\u3063\u3066\u3082\u30b2\u30fc\u30e0\u306e\u958b\u767a\u7d4c\u9a13\u306f\u3053\u308c\u304c\u521d\u3081\u3066\u3067\u3059\u3002\n\n\u7b49\u8272\u3005\u3042\u308a\u307e\u3059\u304c\u3001\u751f\u6696\u304b\u3044\u76ee\u3067\u5fdc\u63f4\u3057\u3066\u304f\u3060\u3055\u308b\u3068\u5149\u6804\u3067\u3059\u3002\n"}