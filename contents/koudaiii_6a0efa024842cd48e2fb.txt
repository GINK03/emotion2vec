{"context": " More than 1 year has passed since last update.Varnish\u5165\u9580\u3068\u4ed5\u7d44\u307f\n\nAgenda\n\nVarnish\u3068\u306f\n\u4ed5\u7d44\u307f\n\u5165\u9580\n\u30d9\u30f3\u30c1\u30de\u30fc\u30af\nReference\n\n\nVarnish\u3068\u306f\n\n2005\u5e74\u306b\u4f5c\u6210\n\u30e9\u30a4\u30bb\u30f3\u30b9 BSD\ncache\u6a5f\u80fd\u3092\u6301\u3064\u30ea\u30d0\u30fc\u30b9\u30d7\u30ed\u30ad\u30b7\u3068\u3057\u3066\u77e5\u3089\u308c\u308bOSS\u306eHTTP\u30a2\u30af\u30bb\u30e9\u30ec\u30fc\u30bf\u306e\u4e00\u3064(Squid cache\u7b49)\n\n\n\u30d7\u30ed\u30ad\u30b7\u306b\u3064\u3044\u3066\n\n\u30d5\u30a9\u30ef\u30fc\u30c9\u30d7\u30ed\u30ad\u30b7\n\n\nClient\u306e\u524d\u6bb5\u306b\u914d\u7f6e\u3057\u3066\u4e0d\u7279\u5b9a\u591a\u6570\u306e\u30b5\u30a4\u30c8\u306b\u4ee3\u7406\u3067\u30a2\u30af\u30bb\u30b9\u3057\u306b\u3044\u304f\u3053\u3068\n\n\n\n\u30ea\u30d0\u30fc\u30b9\u30d7\u30ed\u30ad\u30b7\n\nServer\u306e\u524d\u6bb5\u306b\u914d\u7f6e\u3057\u3066\u4e0d\u7279\u5b9a\u591a\u6570\u306e\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u304b\u3089\u30a2\u30af\u30bb\u30b9\u3057\u3066\u304d\u305f\u306e\u3092\u4ee3\u7406\u30ec\u30b9\u30dd\u30f3\u30b9\u8fd4\u3059\n\n\n\nWHY \u30d7\u30ed\u30ad\u30b7?\n\n\u8ca0\u8377\u5206\u6563\n\u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u5411\u4e0a\n\u30b3\u30f3\u30c6\u30f3\u30c4\u30ad\u30e3\u30c3\u30b7\u30e5\u306b\u3088\u308b\u5fdc\u7b54\u306e\u9ad8\u901f\u5316\n\n\n\n\n\u3069\u3053\u3067\u4f7f\u308f\u308c\u3066\u308b?\n\nFastly\n\nhttps://www.fastly.com/blog/benefits-of-using-varnish\n\nCookpad\n\nhttps://speakerdeck.com/mirakui/high-performance-rails-long-edition?slide=19\n\nHatena\n\n\u5927\u898f\u6a21\u30b5\u30fc\u30d3\u30b9\u6280\u8853\u5165\u9580\u3088\u308a\n\n\u67d0\u30a2\u30a4\u30c9\u30eb\u306e\u6295\u7968\n\n\u904e\u8ca0\u8377\u306b\u8010\u3048\u308bWeb\u306e\u4f5c\u308a\u65b9\u3088\u308a\n\n\u4ed5\u7d44\u307f\n\nVarnish\u306e\u30ad\u30e3\u30c3\u30b7\u30e5\u306b\u3064\u3044\u3066\n\nVarnish\u306f\u30ad\u30e3\u30c3\u30b7\u30e5\u30b5\u30fc\u30d0\u3067\u3042\u308a\u3001OS\u306e\u6027\u80fd\u3092\u91cd\u8907\u306a\u304f\u4f7f\u3046\u3088\u3046\u306b\u8a2d\u8a08\u3055\u308c\u3066\u3044\u308b\u3002\n\u30d5\u30ed\u30f3\u30c8\u30a8\u30f3\u30c9\u306bVarnish\u3092\u5c0e\u5165\u3057\u3066\u9759\u7684\u306a\u3082\u306e\u3092\u30ad\u30e3\u30c3\u30b7\u30e5\u5316\u3001\u52d5\u7684\u306a\u51e6\u7406\u304c\u5fc5\u8981\u306b\u306a\u308b\u8981\u6c42\u306fNginx\u3092\u901a\u3058\u3066\u30d0\u30c3\u30af\u30a8\u30f3\u30c9\u306e\u30d7\u30ed\u30b0\u30e9\u30e0\u306b\u6295\u3052\u3089\u308c\u308b\u3068\u3044\u3063\u305f\u4f7f\u3044\u65b9\u304c\u591a\u3044\u3002\nhttp\u3067\u306e\u30ea\u30af\u30a8\u30b9\u30c8\u304c\u524d\u63d0\u306e\u305f\u3081\u3001\u30d0\u30c3\u30af\u30a8\u30f3\u30c9\u5074\u3067\u5229\u7528\u3055\u308c\u308b\u3053\u3068\u3082\u3042\u308b\u3002\nnginx proxy_cache\u3067\u540c\u4e00 URL\u3078\u591a\u6570\u306e\u30ea\u30af\u30a8\u30b9\u30c8\u304c\u6765\u3066\u3044\u308b\u72b6\u6cc1\u3067\u30ad\u30e3\u30c3\u30b7\u30e5\u306e\u30e9\u30a4\u30d5\u30bf\u30a4\u30e0\u304c\u5207\u308c\u308b\u3068\u3001\u30d0\u30c3\u30af\u30a8\u30f3\u30c9\u3078\u540c\u3058 URL \u306b\u5bfe\u3057\u3066\u8907\u6570\u306e\u30ea\u30af\u30a8\u30b9\u30c8\u304c\u98db\u3093\u3067\u3057\u307e\u3044\u3001\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u5074\u306b\u8ca0\u8377\u304c\u304b\u304b\u308b\u3068\u3044\u3046\u73fe\u8c61\u306e\u5bfe\u7b56\n\n(https)- Nginx -(http)- Varnish Cache - Application - DB\n\n\nVarnish\u306e\u30b7\u30f3\u30d7\u30eb\u3055\n\n\u30bd\u30d5\u30c8\u30a6\u30a7\u30a2\u306e\u52d5\u4f5c\u304c\u91cd\u304f\u306a\u308b\u539f\u56e0\u306e\u4e00\u3064\u306b\u3001\u30ab\u30fc\u30cd\u30eb\u304c\u5b9f\u88c5\u3057\u3066\u3044\u308b\u6a5f\u80fd\u3092\u30bd\u30d5\u30c8\u30a6\u30a7\u30a2\u304c\u3055\u3089\u306b\u5b9f\u88c5\u3059\u308b\u3068\u3044\u3046\u3082\u306e\u304c\u3042\u308b\u3002\u4f8b\u3048\u3070\u30c7\u30a3\u30b9\u30af\u30ad\u30e3\u30c3\u30b7\u30e5\u3084\u30e1\u30e2\u30ea\u30ad\u30e3\u30c3\u30b7\u30e5\u306f\u30ab\u30fc\u30cd\u30eb\u304c\u6a5f\u80fd\u3092\u5b9f\u88c5\u3057\u3066\u3044\u308b\u3002\n\u901a\u5e38\u306f\u4e00\u822c\u306e\u30bd\u30d5\u30c8\u30a6\u30a7\u30a2\u304c\u305d\u3046\u3044\u3063\u305f\u6a5f\u80fd\u3092\u5b9f\u88c5\u3059\u308b\u306e\u306f\u91cd\u8907\u306b\u306a\u308b\u3002\nVarnish\u306f\u3001\u3053\u3046\u3044\u3063\u305f\u91cd\u8907\u304c\u306a\u304f\u30ab\u30fc\u30cd\u30eb\u30c7\u30a3\u30d9\u30ed\u30c3\u30d1\u30fc\u306e\u77e5\u8b58\u3092\u6d3b\u7528\u3057\u305f\u5b9f\u88c5\u3068\u306a\u3063\u3066\u3044\u308b\u3002\n\u305d\u306e\u305f\u3081\u3001\u30c7\u30a3\u30b9\u30af\u3078\u306e\u30c7\u30fc\u30bf\u306e\u66f8\u304d\u8fbc\u307f\u3092\u30c7\u30d5\u30a9\u30eb\u30c8\u3067\u306f\u5b9f\u65bd\u3057\u306a\u3044\u3002\n\u518d\u8d77\u52d5\u3057\u305f\u30bf\u30a4\u30df\u30f3\u30b0\u3067Cache\u306f\u30af\u30ea\u30a2\u3055\u308c\u308b\u3002\n\n\n\u5165\u9580\n\nVarnish\u306e\u7279\u5fb4\n\n\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u306f\u3001\uff08\u30c7\u30d5\u30a9\u30eb\u30c8\u3067\u306f\uff09mmap \u306b\u3088\u308b\u30c7\u30a3\u30b9\u30af\u4e0a\u306e\u30d5\u30a1\u30a4\u30eb\u306b\u4fdd\u5b58\u3055\u308c\u308b\u3002\u307e\u305f\u3001\u30d7\u30ed\u30bb\u30b9\u306e\u518d\u8d77\u52d5\u3067\u30ad\u30e3\u30c3\u30b7\u30e5\u306f\u3059\u3079\u3066\u5931\u308f\u308c\u308b\n\u57fa\u672c\u7684\u306a\u8a2d\u5b9a\uff08Listen\u3059\u308b\u30dd\u30fc\u30c8\u756a\u53f7\u306a\u3069\uff09\u306f\u30b3\u30de\u30f3\u30c9\u30e9\u30a4\u30f3\u30aa\u30d7\u30b7\u30e7\u30f3\u3067\u4e0e\u3048\u3001\u30d7\u30ed\u30ad\u30b7\u3068\u3057\u3066\u306e\u30eb\u30fc\u30eb\u306f\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\uff08VCL\uff09\u306b\u8a18\u8ff0\u3059\u308b\n\u5358\u4f53\u3067\u306f\u30ed\u30b0\u3092\u30d5\u30a1\u30a4\u30eb\u306b\u66f8\u304d\u51fa\u3059\u6a5f\u80fd\u3092\u5099\u3048\u3066\u304a\u3089\u305a\u3001\u5171\u6709\u30e1\u30e2\u30ea\u4e0a\u306b\u66f8\u304d\u51fa\u3059\n\n\ndoc\nhttps://www.varnish-cache.org/docs/4.1/\n\nCLI\n$ brew install varnish\n\n\nvarnishd\n\n\n\u30ea\u30d0\u30fc\u30b9\u30d7\u30ed\u30ad\u30b7\u672c\u4f53\n\n\nvarnishadm\n\n\n\u7ba1\u7406\u30c4\u30fc\u30eb\n\n\nvarnishlog\n\n\n\u30ed\u30ae\u30f3\u30b0\n\n\nvarnishncsa\n\n\n\u30ed\u30ae\u30f3\u30b0\n\n\nvarnishstat\n\n\n\u7d71\u8a08\u60c5\u5831\u3092\u8868\u793a\n\n\nvarnishtop\n\n\nreal-time\u60c5\u5831\u3092\u8868\u793a\n\n\n\n\nvarnishlog\nVarnish\u306f\u3001\u30de\u30cd\u30fc\u30b8\u30e1\u30f3\u30c8\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3068\u3001\u30c1\u30e3\u30a4\u30eb\u30c9\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u304b\u3089\u51fa\u6765\u3066\u3044\u308b\u3002varnishadmin\u306fvarnish\u3092\u64cd\u4f5c\u53ef\u80fd\u306b\u306a\u308b\u3002(Ban\u306e\u767a\u884c\u3082\u53ef\u80fd) varnishlog\u306f\u73fe\u5728\u306e\u30ea\u30af\u30a8\u30b9\u30c8\u306e\u72b6\u614b\u3092\u898b\u308b\u4e8b\u304c\u3067\u304d\u308b\u3002\u3069\u306e\u30ea\u30af\u30a8\u30b9\u30c8\u3067\u30d0\u30c3\u30af\u30a8\u30f3\u30c9\u306b\u884c\u3063\u305f\u304b\u3092\u898b\u308b\u4e8b\u304c\u3067\u304d\u308b\n\nvarnishlog\u306e\u4f8b\n\n$ varnishlog -b -o -i TxURL\n   14 BackendOpen  b default 127.0.0.1 60939 127.0.0.1 80\n   14 TxURL        b /index.html\n   14 BackendReuse b default\n   14 TxURL        b /test.html\n   14 BackendReuse b default\n\n\nvarnishstat\nvarnish\u306e\u30d8\u30eb\u30b9\u30c1\u30a7\u30c3\u30af\u304c\u3067\u304d\u308bvarnishstat\u306f\u4e0b\u8a18\u306e\u901a\u308a\u3002\u8a73\u7d30\u306e\u898b\u65b9\u306fGettingStared\u306e\u8a18\u4e8b\u3092\u53c2\u7167\u3002\n$ varnishstat\n\nHitrate ratio:        6        6        6\nHitrate avg:     0.7500   0.7500   0.7500\n\n          36         0.00         0.01 client_conn - Client connections accepted\n          36         0.00         0.01 client_req - Client requests received\n          24         0.00         0.00 cache_hit - Cache hits\n          12         0.00         0.00 cache_miss - Cache misses\n           3         0.00         0.00 backend_conn - Backend conn. success\n           9         0.00         0.00 backend_reuse - Backend conn. reuses\n           2         0.00         0.00 backend_toolate - Backend conn. was closed\n          12         0.00         0.00 backend_recycle - Backend conn. recycles\n          12         0.00         0.00 fetch_length - Fetch with Length\n          10          .            .   n_sess_mem - N struct sess_mem\n           4          .            .   n_object - N struct object\n           6          .            .   n_objectcore - N struct objectcore\n           6          .            .   n_objecthead - N struct objecthead\n\n\n\nVarnish\u8d77\u52d5\n$ varnished -f /etc/varnish/default.vcl -s malloc,1G -T 127.0.0.1:6082 -a 0.0.0.0:80\n\n\n-f \u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\n-s \u30ad\u30e3\u30c3\u30b7\u30e5\u306e\u30b9\u30c8\u30ec\u30fc\u30b8\u30bf\u30a4\u30d7\n-T \u7ba1\u7406\u30a4\u30f3\u30bf\u30fc\u30d5\u30a7\u30fc\u30b9(\u5916\u304b\u3089\u3067\u3082\u30a2\u30af\u30bb\u30b9\u51fa\u6765\u308b\u3088\u3046\u306b\u306a\u308b)\n-a \u53d7\u4ed8\u6307\u5b9a\n\n# /etc/default/varnish\n# service varnish restart\n\nDAEMON_OPTS=\"-a :80 \\\n             -T localhost:6082 \\\n             -f /etc/varnish/default.vcl \\\n             -S /etc/varnish/secret \\\n             -s malloc,256m\"\n\n\nVarnish\u306e\u30ea\u30af\u30a8\u30b9\u30c8\u51e6\u7406\u30d5\u30ed\u30fc\n\n\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u304b\u3089Varnish\u306bHTTP\u30ea\u30af\u30a8\u30b9\u30c8\u304c\u6765\u308b\n\u30ea\u30af\u30a8\u30b9\u30c8\u306e\u5185\u5bb9\u304b\u3089\u5224\u65ad\u3057\u3066\u3069\u3046\u3044\u3063\u305f\u632f\u308a\u5206\u3051\u3092\u3059\u308b\u304b\u521d\u671f\u51e6\u7406\u3092\u3059\u308b(vcl_recv)\n\u30ad\u30e3\u30c3\u30b7\u30e5\u306e\u6709\u7121\u3092\u78ba\u8a8d\u3059\u308b(vcl_hash)\n\u30ad\u30e3\u30c3\u30b7\u30e5\u304c\u306a\u3044\u5834\u5408\u306b\u30d0\u30c3\u30af\u30a8\u30f3\u30c9\u306b\u554f\u3044\u5408\u308f\u305b\u3066\u5fdc\u7b54\u3092\u5f85\u3064(vcl_miss)\n\n\n\u30d0\u30c3\u30af\u30a8\u30f3\u30c9\u304b\u3089\u306e\u5fdc\u7b54\u304c\u8fd4\u3063\u3066\u304d\u305f\u969b\u306b\u3001\u305d\u306e\u30b3\u30f3\u30c6\u30f3\u30c4\u3092\u30ad\u30e3\u30c3\u30b7\u30e5\u3057\u3066\u3088\u3044\u304b\u3069\u3046\u304b\u3092\u5224\u65ad\u3059\u308b(vcl_fetch)\n\n\n\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u306b\u30b3\u30f3\u30c6\u30f3\u30c4\u3092\u8fd4\u3059(vcl_deliver)\n\n\n\u3056\u3063\u304f\u308a\u3068\u3057\u305f\u51e6\u7406\u30d5\u30ed\u30fc\n\n\nVCL(Varnish Configuration Language)\nVarnish\u306e\u8a2d\u5b9a\u306fVCL\u3068\u3044\u3046\u72ec\u81ea\u8a00\u8a9e\u3067\u8a18\u8ff0\u3059\u308b\nVCL Reference\n\n\u6b21\u306e\u30d5\u30ed\u30fc(VCL request flow)\u3092\u53c2\u8003\u306b\u3059\u308b\u3068\u3088\u3044\n\nVCL Basics - The Varnish Book\n\nBackend\u3068\u306a\u308bApplication\u306e\u8a2d\u5b9a\n\n/etc/varnish/default.vcl\n\nvcl 4.0;\n\nbackend default {\n    .host = \"www.varnish-cache.org\";\n    .port = \"80\";\n}\n\n\nVarnish\u306f\u30c7\u30d5\u30a9\u30eb\u30c8\u306e\u8a2d\u5b9a\u3067\u306f\u30af\u30c3\u30ad\u30fc\u304c\u8a2d\u5b9a\u3055\u308c\u3066\u3044\u308b\u30b3\u30f3\u30c6\u30f3\u30c4\u306b\u95a2\u3057\u3066\u306fcache\u3057\u306a\u3044\u3002\n\u660e\u793a\u7684\u306bcache\u3059\u308bPath\u3092\u8a18\u8f09\u3059\u308b\u3068cache\u306e\u5bfe\u8c61\u306b\u306a\u308b\n\nsub vcl_recv {\n    if (req.url ~ \"^/\u30d1\u30bf\u30fc\u30f3\") {\n        unset req.http.Cookie;\n    }\n}\n\n\n\u5168\u90e8Cache\u3055\u305b\u3066\u660e\u793a\u7684\u306bApplication\u5074\u3067HTTP_HEADER \"X-VAENISH-CACHE: PASS\"\u3092\u5165\u308c\u308b\u3053\u3068\u3067\u52d5\u7684\u30b3\u30f3\u30c6\u30f3\u30c4\u306e\u307fCache\u3057\u306a\u3044\u3088\u3046\u306b\u3059\u308b\u3053\u3068\u3082\u51fa\u6765\u308b\n\nsub vcl_fetch {\n    if (beresp.ttl <= 0s || beresp.http.Set-Cookie || beresp.http.Vary == \"*\"){\n        set beresp.ttl = 120 s;\n        return (hit_for_pass);\n    }\n    if (beresp.http.X-VARNISH-CACHE == \"PASS\") {\n        set beresp.ttl = 0 s;\n        remove beresp.http.X-VERNISH-CACHE;\n        return (hit_for_pass);\n    }\n    return (deliver);\n}\n\n\n\u305d\u306e\u4ed6\u306b\u3082HTTP\u306eMethod\u3067if\u3092\u4f7f\u3046\u3053\u3068\u3082\u51fa\u6765\u308b\nreturn\u3067\u8fd4\u5374\u3057\u3066\u3044\u308b\u306e\u304c\u3001\u6b21\u306e\u72b6\u614b(pipe/pass/lookup)\u3067\u3042\u308b\u3002\nreturn\u3067\u8fd4\u3059\u306e\u306f-1\u7b49\u306e\u5024\u3067\u306f\u306a\u304f\u3001\u6b21\u306e\u72b6\u614b\u3078\u306e\u72b6\u614b\u9077\u79fb\u3092\u8a18\u8ff0\u3059\u308b\u3002\n\u30eb\u30fc\u30d7\u306f\u66f8\u3051\u306a\u3044\nif\u6587\u3092\u66f8\u304f\u4e8b\u304c\u3067\u304d\u308b\u3002\nif\u306e\u4e2d\u8eab\u306f\u3001\u6b21\u306e\u3088\u3046\u306a\u6bd4\u8f03\u3084\u6b63\u898f\u8868\u73fe\u3082\u30b5\u30dd\u30fc\u30c8\u3055\u308c\u3066\u3044\u308b\n\n\n\u3053\u306eif\u6587\u306e\u5206\u5c90\u306b\u3088\u3063\u3066\u3001\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u304b\u3089\u9001\u3089\u308c\u3066\u304d\u305fHTTP\u30d8\u30c3\u30c0\u3001\u30c7\u30d0\u30a4\u30b9\u7a2e\u985e\u3001Method\u3092\u7528\u3044\u3067\u5206\u5c90\u3057\u3001\u30ad\u30e3\u30c3\u30b7\u30e5\u3092\u3055\u3051\u305f\u308a\u3001\u30ad\u30e3\u30c3\u30b7\u30e5\u306e\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u3092\u8abf\u6574\u3057\u305f\u308a\u3001BAN\u306b\u3057\u305f\u308a\u7b49\u306e\u69d8\u3005\u306e\u64cd\u4f5c\u3092\u884c\u3046\u3053\u3068\u304c\u3067\u304d\u308b\u3002\n\n\n\nsub vcl_recv {\n    if (req.restarts == 0) {\n        if (req.http.x-forwarded-for) {\n            set req.http.X-Forwarded-For =\n                req.http.X-Forwarded-For + \", \" + client.ip;\n        } else {\n            set req.http.X-Forwarded-For = client.ip;\n        }\n    }\n    if (req.request != \"GET\" &&\n      req.request != \"HEAD\" &&\n      req.request != \"PUT\" &&\n      req.request != \"POST\" &&\n      req.request != \"TRACE\" &&\n      req.request != \"OPTIONS\" &&\n      req.request != \"DELETE\") {\n        /* Non-RFC2616 or CONNECT which is weird. */\n        return (pipe);\n    }\n    if (req.request != \"GET\" && req.request != \"HEAD\") {\n        /* We only deal with GET and HEAD by default */\n        return (pass);\n    }\n    if (req.http.Authorization || req.http.Cookie) {\n        /* Not cacheable by default */\n        return (pass);\n    }\n    return (lookup);\n}\n\n\nVCL\u3067\u4f7f\u3048\u308bfunction\nVCL\u3067\u4f7f\u3048\u308bfunction\u306f\u6b21\u306e\u901a\u308a\n\nregsub(str, regex, sub)\nregsuball(str, regex, sub)\nban_url(regex)\nban(expression)\npurge;\nreturn(restart)\nreturn()\nhash_data()\n\n\nregsub/regsuball\u304cURL\u306e\u66f8\u304d\u63db\u3048\u7cfb\nban_url, ban, purge\u304c\u30ad\u30e3\u30c3\u30b7\u30e5\u306e\u30af\u30ea\u30a2\u7cfb\nreturn \u6b21\u306e\u72b6\u614b\u9077\u79fb\u306e\u70ba\u306efuntion. hash_data\u306fhash input\u306b\u6587\u5b57\u3092\u8db3\u3059\u70ba\u306e\u3082\u306e.\n\n\nVarnish\u3068\u30d7\u30ed\u30bb\u30b9\n\nVarnish\u306f\u5927\u304d\u304f\u308f\u3051\u308b\u3068\u3001Management\u30d7\u30ed\u30bb\u30b9\u3068\u3001Child/cache\u30d7\u30ed\u30bb\u30b9\u306b\u5206\u304b\u308c\u308b\u3002\nChild/cache\u30d7\u30ed\u30bb\u30b9\u304c\u30ad\u30e3\u30c3\u30b7\u30e5\u3092\u884c\u3044\u3001Management\u30d7\u30ed\u30bb\u30b9\u304c\u305d\u308c\u3092\u7ba1\u7406\u3059\u308b\n\n\nvarnishadm\u30b3\u30de\u30f3\u30c9\u3067\u7ba1\u7406\u30b3\u30de\u30f3\u30c9\u3092\u767a\u884c\u3067\u304d\u308b\u3002\n\u53cd\u6620\u306f\u3001Varnish\u3092\u518d\u8d77\u52d5\u3059\u308b\u4e8b\u7121\u304f\u884c\u3048\u308b\u3002\uff08\u5c1a\u3001varnishadm\u306f\u30ea\u30e2\u30fc\u30c8\u304b\u3089\u3067\u3082\u64cd\u4f5c\u3067\u304d\u308b\u3088\u3046\u306b\u8a2d\u5b9a\u53ef\u80fd\uff09\n\n\n\n\u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3\u306e\u56f3\u306f\u6b21\u306eURL\u306eProcess Architecture\u306e\u9805\u3092\u53c2\u8003\nTuning The Varnish Book\n\n\u30ad\u30e3\u30c3\u30b7\u30e5\u30af\u30ea\u30a2\u306e\u65b9\u6cd5\nCash Invalidation\nVarnish\u306e\u30ad\u30e3\u30c3\u30b7\u30e5\u3092\u30af\u30ea\u30a2\u3059\u308b\u65b9\u6cd5\u306f\u6b21\u306e4\u3064\u304c\u3042\u308b\n\nttl\u306e\u8a2d\u5b9a\u6642\u9650\u8a2d\u5b9a\npurge \u30aa\u30d6\u30b8\u30a7\u30af\u30c8\uff11\u3064\u306b\u5bfe\u3059\u308b\u30ad\u30e3\u30c3\u30b7\u30e5\u30af\u30ea\u30a2\nban \u6b63\u898f\u8868\u73fe\u3092\u4f7f\u3063\u305f\u30ad\u30e3\u30c3\u30b7\u30e5\u30af\u30ea\u30a2\u306e\u4e88\u7d04(SmartBan)\nset req_hash_always_miss = true \u3042\u308bURL\u306b\u5bfe\u3059\u308b\u30ad\u30e3\u30c3\u30b7\u30e5\u306e\u30af\u30ea\u30a2\npurge method(varnish v4\u304b\u3089)\n\n\n\u4e00\u62ec\u3067\u30ad\u30e3\u30c3\u30b7\u30e5\u3092\u30af\u30ea\u30a2\u3067\u304d\u308b\u306e\u306f\u3001SmartBan\u306e\u307f\n\n\n\u305d\u308c\u4ee5\u5916\u3060\u3068\u3001ttl\u306e\u6642\u9650\u8a2d\u5b9a(\u30c7\u30d5\u30a9\u30eb\u30c8\u3067\u306f\u3001\u30ad\u30e3\u30c3\u30b7\u30e5\u304c\u30af\u30ea\u30a2\u3055\u308c\u308b\u306e\u304c2\u5206\u306e\u6642\u9650\u8a2d\u5b9a)\n\n\n\n\nSmartBan\u65b9\u5f0f\nBAN\u306e\u65b9\u5f0f\u306f\u30ad\u30e3\u30c3\u30b7\u30e5\u3092\u3059\u3050\u306b\u30af\u30ea\u30a2\u3059\u308b\u306e\u3067\u306f\u306a\u304f\u3001\u5bfe\u8c61\u306e\u30ad\u30e3\u30c3\u30b7\u30e5\u3092BAN\u306b\u3057\u3066\u304a\u304d\u3001\u6b21\u306b\u305d\u306eURL\u304c\u30ea\u30af\u30a8\u30b9\u30c8\u3055\u308c\u305f\u969b\u306b\u3001\u30d0\u30c3\u30af\u30a8\u30f3\u30c9\u306e\u30b5\u30fc\u30d0\u30fc\u306b\u8aad\u307f\u306b\u3044\u304f\u3068\u3044\u3063\u305f\u6319\u52d5\u3092\u3059\u308b\u3002\n\nSmartBan\u306e\u8a2d\u5b9a\u3068\u30c6\u30b9\u30c8\nBAN\u3068\u3044\u3046Method\u306e\u30ea\u30af\u30a8\u30b9\u30c8\u304c\u9001\u3089\u308c\u3066\u304d\u305f\u6642\u306b\u3001/sub\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u4ee5\u4e0b\u306e\u5168\u3066\u306ehtml\u3068\u3001/test.html\u306e\u30ad\u30e3\u30c3\u30b7\u30e5\u3092ban\u306b\u5165\u308c\u308b\u3001\u3064\u307e\u308a\u6b21\u56de\u30a2\u30af\u30bb\u30b9\u3055\u308c\u305f\u3068\u304d\u306b\u3001\u30d0\u30c3\u30af\u30a8\u30f3\u30c9\u306b\u53d6\u5f97\u3059\u308b\u3088\u3046\u306a\u8a2d\u5b9a\u306b\u306a\u3063\u3066\u3044\u308b\u3002\nsub vcl_recv {\nif (req.request == \"BAN\") {\n  ban(\"req.url ~ ^/sub/.*.html\");\n  ban(\"req.url ~ ^/test.html\");\n  error 200 \"Banned.\";\n}\n\n\n\u30ad\u30e3\u30c3\u30b7\u30e5\u306e\u7834\u68c4\u306e\u30b3\u30de\u30f3\u30c9\n\u30ad\u30e3\u30c3\u30b7\u30e5\u306e\u5ec3\u68c4\u306fdefault.vcl\u3067\u8a2d\u5b9a\u53ef\u80fd\u3002\u4e0a\u8a18\u306e\u66f8\u304d\u65b9\u306e\u5834\u5408\u3001\u6b21\u306e\u30b3\u30de\u30f3\u30c9\u3067\u3001\u30ad\u30e3\u30c3\u30b7\u30e5\u304c\u7834\u68c4\u3055\u308c\u308b\u3002\uff08\u6ce8\uff1arefresh.html\u306f\u4f55\u3067\u3082\u826f\u3044\uff09\u5c1a\u3001ban\u306b\u95a2\u3057\u3066\u306f\u5f8c\u3067\u8ff0\u3079\u308bvarnishadm\u3067\u767a\u884c\u3059\u308b\u3053\u3068\u3082\u53ef\u80fd\n$ curl -X BAN http://127.0.0.1:6081/refresh.html\n\n\nttl\u306e\u30c7\u30d5\u30a9\u30eb\u30c8\u5024\u306e\u5909\u66f4\n\u30ad\u30e3\u30c3\u30b7\u30e5\u306e\u30c7\u30d5\u30a9\u30eb\u30c8\u5024\u306e\u5909\u66f4\u306f\u3001/etc/sysconfig/varnish\u306e\u6b21\u306e\u9805\u76ee\u3092\u8a2d\u5b9a\u3059\u308c\u3070\u5909\u66f4\u3067\u304d\u308b\n# Default TTL used when the backend does not specify one\nVARNISH_TTL=120\n\n\n\u30ad\u30e3\u30c3\u30b7\u30e5\u5bfe\u8c61\u306b\u3088\u308b\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u306e\u5909\u66f4\n\u30ad\u30e3\u30c3\u30b7\u30e5\u306e\u6642\u9593\u3092\u30b3\u30f3\u30c6\u30f3\u30c4\u306b\u3088\u3063\u3066\u5909\u5316\u3055\u305b\u305f\u3044\u5834\u5408\u306f\u3001default.vcl\u3092\u8a2d\u5b9a\u3059\u308b\u3002\nVarnish Book:VCL Basics\n\n\u6b21\u306e\u4f8b\u306fjpg\u30d5\u30a1\u30a4\u30eb\u3092\u5f37\u5236\u7684\u306b60s\u3067\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u3055\u305b\u308b\n\nsub vcl_fetch {\n        if (req.url ~ \"\\.jpg$\") {\n                set beresp.ttl = 60s;\n        }\n}\n\n\npurge method(varnish v4)\nPurging and banning\nv4\u304b\u3089 purge METHOD\u8ffd\u52a0\u3055\u308c\u3066\u305f\u3088\u3046\u3067\u3059\uff01\nacl purge {\n        \"localhost\";\n        \"192.168.55.0\"/24;\n}\n\nsub vcl_recv {\n        # allow PURGE from localhost and 192.168.55...\n\n        if (req.method == \"PURGE\") {\n                if (!client.ip ~ purge) {\n                        return(synth(405,\"Not allowed.\"));\n                }\n                return (purge);\n        }\n}\n\n\n\u30b5\u30a4\u30b8\u30f3\u30b0\n\nVarnish\u306f\u3001\u30ad\u30e3\u30c3\u30b7\u30e5\u3059\u308b\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u306b\u305d\u308c\u305e\u308c1kb\u306e\u30aa\u30fc\u30d0\u30fc\u30d8\u30c3\u30c9\u304c\u304b\u304b\u308b\u3002\n\u30b9\u30ec\u30c3\u30c9\u6570\u7b49\u306e\u4ed6\u306e\u30d1\u30e9\u30e1\u30fc\u30bf\u3082\u63b2\u8f09\u3055\u308c\u3066\u3044\u308b\u3002\n\nTuning The Varnish Book\n\n\u30ed\u30b0\u306b\u3064\u3044\u3066\n\n\u30ed\u30b0\u30d5\u30a1\u30a4\u30eb\u306f\u30c7\u30d5\u30a9\u30eb\u30c8\u3067\u306f\u66f8\u304b\u308c\u306a\u3044\u3002\n\n\u6b21\u306eURL\u306eLog data\u3092\u53c2\u7167\nGetting started - The Varnish Book\n\n\u30d9\u30f3\u30c1\u30de\u30fc\u30af\nGolang\u88fd\u306eHTTP load testing tool\nhttps://github.com/tsenart/vegeta\n\nbrew install vegeta\n\n\nlocalhost\u3078\u79d2\u9593100\u30ea\u30af\u30a8\u30b9\u30c8\u30ea\u30af\u30a8\u30b9\u30c8\u30925\u79d2\u9593\u884c\u3046\n\n$ echo \"GET http://localhost:3000/\" | ./vegeta attack -rate=100 -duration=5s | ./vegeta report\n\n\u7c21\u5358\u306b\u8a66\u305b\u307e\u3059\n\nReference\n\n\u904e\u8ca0\u8377\u306b\u8010\u3048\u308bWeb\u306e\u4f5c\u308a\u65b9\n\u30b5\u30fc\u30d0/\u30a4\u30f3\u30d5\u30e9\u3092\u652f\u3048\u308b\u6280\u8853\n\u5927\u898f\u6a21\u30b5\u30fc\u30d3\u30b9\u6280\u8853\u5165\u9580\nThe benefits of using Varnish\nHigh Performance Rails long edition\n\n\nVarnish\u672c\u756a\u904b\u7528\u306b\u5411\u3051\u3066\n\nVarnish\u306e\u591a\u6bb5\nRails and Varnish\nRails and Varnish2\nVarnish gem\n\n\n\u30ad\u30e3\u30c3\u30b7\u30e5\u306e\u7121\u52b9\u5316\u306e\u8a18\u4e8b\nVarnish Book: Cache invalidation\nPurging and banning\nBans and purges in Varnish\n\nVarnish\u306e\u5168\u4f53\u50cf\nGetting started\n\nVarnish Command Line Interface\nVarnish Book:VCL Basics\nVarnish CLI\n\nVarnish\u306e\u8a2d\u5b9a\nVarnish Book: Tuning\nSizing your cache\nvarnishd\nVarnish\u5165\u9580\u3068\u4ed5\u7d44\u307f\n\n## Agenda\n\n1. Varnish\u3068\u306f\n2. \u4ed5\u7d44\u307f\n3. \u5165\u9580\n4. \u30d9\u30f3\u30c1\u30de\u30fc\u30af\n5. Reference\n\n## Varnish\u3068\u306f\n\n* 2005\u5e74\u306b\u4f5c\u6210\n* \u30e9\u30a4\u30bb\u30f3\u30b9 BSD\n* cache\u6a5f\u80fd\u3092\u6301\u3064\u30ea\u30d0\u30fc\u30b9\u30d7\u30ed\u30ad\u30b7\u3068\u3057\u3066\u77e5\u3089\u308c\u308bOSS\u306eHTTP\u30a2\u30af\u30bb\u30e9\u30ec\u30fc\u30bf\u306e\u4e00\u3064(Squid cache\u7b49)\n\n### \u30d7\u30ed\u30ad\u30b7\u306b\u3064\u3044\u3066\n\n* \u30d5\u30a9\u30ef\u30fc\u30c9\u30d7\u30ed\u30ad\u30b7\n  * Client\u306e\u524d\u6bb5\u306b\u914d\u7f6e\u3057\u3066\u4e0d\u7279\u5b9a\u591a\u6570\u306e\u30b5\u30a4\u30c8\u306b\u4ee3\u7406\u3067\u30a2\u30af\u30bb\u30b9\u3057\u306b\u3044\u304f\u3053\u3068\n* \u30ea\u30d0\u30fc\u30b9\u30d7\u30ed\u30ad\u30b7\n  * Server\u306e\u524d\u6bb5\u306b\u914d\u7f6e\u3057\u3066\u4e0d\u7279\u5b9a\u591a\u6570\u306e\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u304b\u3089\u30a2\u30af\u30bb\u30b9\u3057\u3066\u304d\u305f\u306e\u3092\u4ee3\u7406\u30ec\u30b9\u30dd\u30f3\u30b9\u8fd4\u3059\n\n* WHY \u30d7\u30ed\u30ad\u30b7?\n\t* \u8ca0\u8377\u5206\u6563\n\t* \u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u5411\u4e0a\n\t* \u30b3\u30f3\u30c6\u30f3\u30c4\u30ad\u30e3\u30c3\u30b7\u30e5\u306b\u3088\u308b\u5fdc\u7b54\u306e\u9ad8\u901f\u5316\n\n### \u3069\u3053\u3067\u4f7f\u308f\u308c\u3066\u308b?\n\n* Fastly\n\nhttps://www.fastly.com/blog/benefits-of-using-varnish\n\n* Cookpad\n\nhttps://speakerdeck.com/mirakui/high-performance-rails-long-edition?slide=19\n\n\n* Hatena\n\n\u5927\u898f\u6a21\u30b5\u30fc\u30d3\u30b9\u6280\u8853\u5165\u9580\u3088\u308a\n\n* \u67d0\u30a2\u30a4\u30c9\u30eb\u306e\u6295\u7968\n\n\u904e\u8ca0\u8377\u306b\u8010\u3048\u308bWeb\u306e\u4f5c\u308a\u65b9\u3088\u308a\n\n## \u4ed5\u7d44\u307f\n\n### Varnish\u306e\u30ad\u30e3\u30c3\u30b7\u30e5\u306b\u3064\u3044\u3066\n\n* Varnish\u306f\u30ad\u30e3\u30c3\u30b7\u30e5\u30b5\u30fc\u30d0\u3067\u3042\u308a\u3001OS\u306e\u6027\u80fd\u3092\u91cd\u8907\u306a\u304f\u4f7f\u3046\u3088\u3046\u306b\u8a2d\u8a08\u3055\u308c\u3066\u3044\u308b\u3002\n* \u30d5\u30ed\u30f3\u30c8\u30a8\u30f3\u30c9\u306bVarnish\u3092\u5c0e\u5165\u3057\u3066\u9759\u7684\u306a\u3082\u306e\u3092\u30ad\u30e3\u30c3\u30b7\u30e5\u5316\u3001\u52d5\u7684\u306a\u51e6\u7406\u304c\u5fc5\u8981\u306b\u306a\u308b\u8981\u6c42\u306fNginx\u3092\u901a\u3058\u3066\u30d0\u30c3\u30af\u30a8\u30f3\u30c9\u306e\u30d7\u30ed\u30b0\u30e9\u30e0\u306b\u6295\u3052\u3089\u308c\u308b\u3068\u3044\u3063\u305f\u4f7f\u3044\u65b9\u304c\u591a\u3044\u3002\n* http\u3067\u306e\u30ea\u30af\u30a8\u30b9\u30c8\u304c\u524d\u63d0\u306e\u305f\u3081\u3001\u30d0\u30c3\u30af\u30a8\u30f3\u30c9\u5074\u3067\u5229\u7528\u3055\u308c\u308b\u3053\u3068\u3082\u3042\u308b\u3002\n* nginx proxy_cache\u3067\u540c\u4e00 URL\u3078\u591a\u6570\u306e\u30ea\u30af\u30a8\u30b9\u30c8\u304c\u6765\u3066\u3044\u308b\u72b6\u6cc1\u3067\u30ad\u30e3\u30c3\u30b7\u30e5\u306e\u30e9\u30a4\u30d5\u30bf\u30a4\u30e0\u304c\u5207\u308c\u308b\u3068\u3001\u30d0\u30c3\u30af\u30a8\u30f3\u30c9\u3078\u540c\u3058 URL \u306b\u5bfe\u3057\u3066\u8907\u6570\u306e\u30ea\u30af\u30a8\u30b9\u30c8\u304c\u98db\u3093\u3067\u3057\u307e\u3044\u3001\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u5074\u306b\u8ca0\u8377\u304c\u304b\u304b\u308b\u3068\u3044\u3046\u73fe\u8c61\u306e\u5bfe\u7b56\n\n```\n(https)- Nginx -(http)- Varnish Cache - Application - DB\n```\n\n### Varnish\u306e\u30b7\u30f3\u30d7\u30eb\u3055\n\n* \u30bd\u30d5\u30c8\u30a6\u30a7\u30a2\u306e\u52d5\u4f5c\u304c\u91cd\u304f\u306a\u308b\u539f\u56e0\u306e\u4e00\u3064\u306b\u3001\u30ab\u30fc\u30cd\u30eb\u304c\u5b9f\u88c5\u3057\u3066\u3044\u308b\u6a5f\u80fd\u3092\u30bd\u30d5\u30c8\u30a6\u30a7\u30a2\u304c\u3055\u3089\u306b\u5b9f\u88c5\u3059\u308b\u3068\u3044\u3046\u3082\u306e\u304c\u3042\u308b\u3002\u4f8b\u3048\u3070\u30c7\u30a3\u30b9\u30af\u30ad\u30e3\u30c3\u30b7\u30e5\u3084\u30e1\u30e2\u30ea\u30ad\u30e3\u30c3\u30b7\u30e5\u306f\u30ab\u30fc\u30cd\u30eb\u304c\u6a5f\u80fd\u3092\u5b9f\u88c5\u3057\u3066\u3044\u308b\u3002\n* \u901a\u5e38\u306f\u4e00\u822c\u306e\u30bd\u30d5\u30c8\u30a6\u30a7\u30a2\u304c\u305d\u3046\u3044\u3063\u305f\u6a5f\u80fd\u3092\u5b9f\u88c5\u3059\u308b\u306e\u306f\u91cd\u8907\u306b\u306a\u308b\u3002\n* Varnish\u306f\u3001\u3053\u3046\u3044\u3063\u305f\u91cd\u8907\u304c\u306a\u304f\u30ab\u30fc\u30cd\u30eb\u30c7\u30a3\u30d9\u30ed\u30c3\u30d1\u30fc\u306e\u77e5\u8b58\u3092\u6d3b\u7528\u3057\u305f\u5b9f\u88c5\u3068\u306a\u3063\u3066\u3044\u308b\u3002\n* \u305d\u306e\u305f\u3081\u3001\u30c7\u30a3\u30b9\u30af\u3078\u306e\u30c7\u30fc\u30bf\u306e\u66f8\u304d\u8fbc\u307f\u3092\u30c7\u30d5\u30a9\u30eb\u30c8\u3067\u306f\u5b9f\u65bd\u3057\u306a\u3044\u3002\n* \u518d\u8d77\u52d5\u3057\u305f\u30bf\u30a4\u30df\u30f3\u30b0\u3067Cache\u306f\u30af\u30ea\u30a2\u3055\u308c\u308b\u3002\n\n\n## \u5165\u9580\n\n### Varnish\u306e\u7279\u5fb4\n\n* \u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u306f\u3001\uff08\u30c7\u30d5\u30a9\u30eb\u30c8\u3067\u306f\uff09mmap \u306b\u3088\u308b\u30c7\u30a3\u30b9\u30af\u4e0a\u306e\u30d5\u30a1\u30a4\u30eb\u306b\u4fdd\u5b58\u3055\u308c\u308b\u3002\u307e\u305f\u3001\u30d7\u30ed\u30bb\u30b9\u306e\u518d\u8d77\u52d5\u3067\u30ad\u30e3\u30c3\u30b7\u30e5\u306f\u3059\u3079\u3066\u5931\u308f\u308c\u308b\n* \u57fa\u672c\u7684\u306a\u8a2d\u5b9a\uff08Listen\u3059\u308b\u30dd\u30fc\u30c8\u756a\u53f7\u306a\u3069\uff09\u306f\u30b3\u30de\u30f3\u30c9\u30e9\u30a4\u30f3\u30aa\u30d7\u30b7\u30e7\u30f3\u3067\u4e0e\u3048\u3001\u30d7\u30ed\u30ad\u30b7\u3068\u3057\u3066\u306e\u30eb\u30fc\u30eb\u306f\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\uff08VCL\uff09\u306b\u8a18\u8ff0\u3059\u308b\n* \u5358\u4f53\u3067\u306f\u30ed\u30b0\u3092\u30d5\u30a1\u30a4\u30eb\u306b\u66f8\u304d\u51fa\u3059\u6a5f\u80fd\u3092\u5099\u3048\u3066\u304a\u3089\u305a\u3001\u5171\u6709\u30e1\u30e2\u30ea\u4e0a\u306b\u66f8\u304d\u51fa\u3059\n\n### doc\n\nhttps://www.varnish-cache.org/docs/4.1/\n\n\n### CLI\n\n```\n$ brew install varnish\n```\n\n* varnishd\n\t* \u30ea\u30d0\u30fc\u30b9\u30d7\u30ed\u30ad\u30b7\u672c\u4f53\n* varnishadm\n\t* \u7ba1\u7406\u30c4\u30fc\u30eb\n* varnishlog\n\t* \u30ed\u30ae\u30f3\u30b0\n* varnishncsa\n\t* \u30ed\u30ae\u30f3\u30b0\n* varnishstat\n\t* \u7d71\u8a08\u60c5\u5831\u3092\u8868\u793a\n* varnishtop\n\t* real-time\u60c5\u5831\u3092\u8868\u793a\n\n#### varnishlog\n\nVarnish\u306f\u3001\u30de\u30cd\u30fc\u30b8\u30e1\u30f3\u30c8\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3068\u3001\u30c1\u30e3\u30a4\u30eb\u30c9\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u304b\u3089\u51fa\u6765\u3066\u3044\u308b\u3002varnishadmin\u306fvarnish\u3092\u64cd\u4f5c\u53ef\u80fd\u306b\u306a\u308b\u3002(Ban\u306e\u767a\u884c\u3082\u53ef\u80fd) varnishlog\u306f\u73fe\u5728\u306e\u30ea\u30af\u30a8\u30b9\u30c8\u306e\u72b6\u614b\u3092\u898b\u308b\u4e8b\u304c\u3067\u304d\u308b\u3002\u3069\u306e\u30ea\u30af\u30a8\u30b9\u30c8\u3067\u30d0\u30c3\u30af\u30a8\u30f3\u30c9\u306b\u884c\u3063\u305f\u304b\u3092\u898b\u308b\u4e8b\u304c\u3067\u304d\u308b\n\n* varnishlog\u306e\u4f8b\n\n```\n$ varnishlog -b -o -i TxURL\n   14 BackendOpen  b default 127.0.0.1 60939 127.0.0.1 80\n   14 TxURL        b /index.html\n   14 BackendReuse b default\n   14 TxURL        b /test.html\n   14 BackendReuse b default\n```\n\n#### varnishstat\n\nvarnish\u306e\u30d8\u30eb\u30b9\u30c1\u30a7\u30c3\u30af\u304c\u3067\u304d\u308bvarnishstat\u306f\u4e0b\u8a18\u306e\u901a\u308a\u3002\u8a73\u7d30\u306e\u898b\u65b9\u306fGettingStared\u306e\u8a18\u4e8b\u3092\u53c2\u7167\u3002\n\n```\n$ varnishstat\n\nHitrate ratio:        6        6        6\nHitrate avg:     0.7500   0.7500   0.7500\n\n          36         0.00         0.01 client_conn - Client connections accepted\n          36         0.00         0.01 client_req - Client requests received\n          24         0.00         0.00 cache_hit - Cache hits\n          12         0.00         0.00 cache_miss - Cache misses\n           3         0.00         0.00 backend_conn - Backend conn. success\n           9         0.00         0.00 backend_reuse - Backend conn. reuses\n           2         0.00         0.00 backend_toolate - Backend conn. was closed\n          12         0.00         0.00 backend_recycle - Backend conn. recycles\n          12         0.00         0.00 fetch_length - Fetch with Length\n          10          .            .   n_sess_mem - N struct sess_mem\n           4          .            .   n_object - N struct object\n           6          .            .   n_objectcore - N struct objectcore\n           6          .            .   n_objecthead - N struct objecthead\n           \n```\n\n\n\n### Varnish\u8d77\u52d5\n\n```\n$ varnished -f /etc/varnish/default.vcl -s malloc,1G -T 127.0.0.1:6082 -a 0.0.0.0:80\n```\n\n* -f \u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\n* -s \u30ad\u30e3\u30c3\u30b7\u30e5\u306e\u30b9\u30c8\u30ec\u30fc\u30b8\u30bf\u30a4\u30d7\n* -T \u7ba1\u7406\u30a4\u30f3\u30bf\u30fc\u30d5\u30a7\u30fc\u30b9(\u5916\u304b\u3089\u3067\u3082\u30a2\u30af\u30bb\u30b9\u51fa\u6765\u308b\u3088\u3046\u306b\u306a\u308b)\n* -a \u53d7\u4ed8\u6307\u5b9a\n\n```\n# /etc/default/varnish\n# service varnish restart\n\nDAEMON_OPTS=\"-a :80 \\\n             -T localhost:6082 \\\n             -f /etc/varnish/default.vcl \\\n             -S /etc/varnish/secret \\\n             -s malloc,256m\"\n```\n\n### Varnish\u306e\u30ea\u30af\u30a8\u30b9\u30c8\u51e6\u7406\u30d5\u30ed\u30fc\n\n0. \u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u304b\u3089Varnish\u306bHTTP\u30ea\u30af\u30a8\u30b9\u30c8\u304c\u6765\u308b\n1. \u30ea\u30af\u30a8\u30b9\u30c8\u306e\u5185\u5bb9\u304b\u3089\u5224\u65ad\u3057\u3066\u3069\u3046\u3044\u3063\u305f\u632f\u308a\u5206\u3051\u3092\u3059\u308b\u304b\u521d\u671f\u51e6\u7406\u3092\u3059\u308b(vcl_recv)\n2. \u30ad\u30e3\u30c3\u30b7\u30e5\u306e\u6709\u7121\u3092\u78ba\u8a8d\u3059\u308b(vcl_hash)\n3. \u30ad\u30e3\u30c3\u30b7\u30e5\u304c\u306a\u3044\u5834\u5408\u306b\u30d0\u30c3\u30af\u30a8\u30f3\u30c9\u306b\u554f\u3044\u5408\u308f\u305b\u3066\u5fdc\u7b54\u3092\u5f85\u3064(vcl_miss)\n\t4. \u30d0\u30c3\u30af\u30a8\u30f3\u30c9\u304b\u3089\u306e\u5fdc\u7b54\u304c\u8fd4\u3063\u3066\u304d\u305f\u969b\u306b\u3001\u305d\u306e\u30b3\u30f3\u30c6\u30f3\u30c4\u3092\u30ad\u30e3\u30c3\u30b7\u30e5\u3057\u3066\u3088\u3044\u304b\u3069\u3046\u304b\u3092\u5224\u65ad\u3059\u308b(vcl_fetch)\n5. \u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u306b\u30b3\u30f3\u30c6\u30f3\u30c4\u3092\u8fd4\u3059(vcl_deliver)\n\n#### \u3056\u3063\u304f\u308a\u3068\u3057\u305f\u51e6\u7406\u30d5\u30ed\u30fc\n\n![Kobito.GQ2agX.png](https://qiita-image-store.s3.amazonaws.com/0/18843/2d510cb3-aeb2-7d59-ebc1-073e09c2645b.png \"Kobito.GQ2agX.png\")\n\n\n### VCL(Varnish Configuration Language)\n\nVarnish\u306e\u8a2d\u5b9a\u306fVCL\u3068\u3044\u3046\u72ec\u81ea\u8a00\u8a9e\u3067\u8a18\u8ff0\u3059\u308b\n\n[VCL Reference](https://www.varnish-cache.org/docs/trunk/reference/vcl.html)\n\n* \u6b21\u306e\u30d5\u30ed\u30fc(VCL request flow)\u3092\u53c2\u8003\u306b\u3059\u308b\u3068\u3088\u3044\n  \n[VCL Basics - The Varnish Book](https://www.varnish-software.com/static/book/VCL_Basics.html)\n\n\n* Backend\u3068\u306a\u308bApplication\u306e\u8a2d\u5b9a\n\n```\n/etc/varnish/default.vcl\n\nvcl 4.0;\n\nbackend default {\n    .host = \"www.varnish-cache.org\";\n    .port = \"80\";\n}\n```\n\n* Varnish\u306f\u30c7\u30d5\u30a9\u30eb\u30c8\u306e\u8a2d\u5b9a\u3067\u306f\u30af\u30c3\u30ad\u30fc\u304c\u8a2d\u5b9a\u3055\u308c\u3066\u3044\u308b\u30b3\u30f3\u30c6\u30f3\u30c4\u306b\u95a2\u3057\u3066\u306fcache\u3057\u306a\u3044\u3002\n* \u660e\u793a\u7684\u306bcache\u3059\u308bPath\u3092\u8a18\u8f09\u3059\u308b\u3068cache\u306e\u5bfe\u8c61\u306b\u306a\u308b\n\n```\nsub vcl_recv {\n\tif (req.url ~ \"^/\u30d1\u30bf\u30fc\u30f3\") {\n\t\tunset req.http.Cookie;\n\t}\n}\n```\n\n* \u5168\u90e8Cache\u3055\u305b\u3066\u660e\u793a\u7684\u306bApplication\u5074\u3067`HTTP_HEADER \"X-VAENISH-CACHE: PASS\"`\u3092\u5165\u308c\u308b\u3053\u3068\u3067\u52d5\u7684\u30b3\u30f3\u30c6\u30f3\u30c4\u306e\u307fCache\u3057\u306a\u3044\u3088\u3046\u306b\u3059\u308b\u3053\u3068\u3082\u51fa\u6765\u308b\n\n```\nsub vcl_fetch {\n\tif (beresp.ttl <= 0s || beresp.http.Set-Cookie || beresp.http.Vary == \"*\"){\n\t\tset beresp.ttl = 120 s;\n\t\treturn (hit_for_pass);\n\t}\n\tif (beresp.http.X-VARNISH-CACHE == \"PASS\") {\n\t\tset beresp.ttl = 0 s;\n\t\tremove beresp.http.X-VERNISH-CACHE;\n\t\treturn (hit_for_pass);\n\t}\n\treturn (deliver);\n}\n```\n\n* \u305d\u306e\u4ed6\u306b\u3082HTTP\u306eMethod\u3067if\u3092\u4f7f\u3046\u3053\u3068\u3082\u51fa\u6765\u308b\n* return\u3067\u8fd4\u5374\u3057\u3066\u3044\u308b\u306e\u304c\u3001\u6b21\u306e\u72b6\u614b(pipe/pass/lookup)\u3067\u3042\u308b\u3002\n* return\u3067\u8fd4\u3059\u306e\u306f-1\u7b49\u306e\u5024\u3067\u306f\u306a\u304f\u3001\u6b21\u306e\u72b6\u614b\u3078\u306e\u72b6\u614b\u9077\u79fb\u3092\u8a18\u8ff0\u3059\u308b\u3002\n* \u30eb\u30fc\u30d7\u306f\u66f8\u3051\u306a\u3044\n* if\u6587\u3092\u66f8\u304f\u4e8b\u304c\u3067\u304d\u308b\u3002\n* if\u306e\u4e2d\u8eab\u306f\u3001\u6b21\u306e\u3088\u3046\u306a\u6bd4\u8f03\u3084\u6b63\u898f\u8868\u73fe\u3082\u30b5\u30dd\u30fc\u30c8\u3055\u308c\u3066\u3044\u308b\n  * \u3053\u306eif\u6587\u306e\u5206\u5c90\u306b\u3088\u3063\u3066\u3001\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u304b\u3089\u9001\u3089\u308c\u3066\u304d\u305fHTTP\u30d8\u30c3\u30c0\u3001\u30c7\u30d0\u30a4\u30b9\u7a2e\u985e\u3001Method\u3092\u7528\u3044\u3067\u5206\u5c90\u3057\u3001\u30ad\u30e3\u30c3\u30b7\u30e5\u3092\u3055\u3051\u305f\u308a\u3001\u30ad\u30e3\u30c3\u30b7\u30e5\u306e\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u3092\u8abf\u6574\u3057\u305f\u308a\u3001BAN\u306b\u3057\u305f\u308a\u7b49\u306e\u69d8\u3005\u306e\u64cd\u4f5c\u3092\u884c\u3046\u3053\u3068\u304c\u3067\u304d\u308b\u3002\n\n\n```\nsub vcl_recv {\n    if (req.restarts == 0) {\n        if (req.http.x-forwarded-for) {\n            set req.http.X-Forwarded-For =\n                req.http.X-Forwarded-For + \", \" + client.ip;\n        } else {\n            set req.http.X-Forwarded-For = client.ip;\n        }\n    }\n    if (req.request != \"GET\" &&\n      req.request != \"HEAD\" &&\n      req.request != \"PUT\" &&\n      req.request != \"POST\" &&\n      req.request != \"TRACE\" &&\n      req.request != \"OPTIONS\" &&\n      req.request != \"DELETE\") {\n        /* Non-RFC2616 or CONNECT which is weird. */\n        return (pipe);\n    }\n    if (req.request != \"GET\" && req.request != \"HEAD\") {\n        /* We only deal with GET and HEAD by default */\n        return (pass);\n    }\n    if (req.http.Authorization || req.http.Cookie) {\n        /* Not cacheable by default */\n        return (pass);\n    }\n    return (lookup);\n}\n```\n\n### VCL\u3067\u4f7f\u3048\u308bfunction \n\nVCL\u3067\u4f7f\u3048\u308bfunction\u306f\u6b21\u306e\u901a\u308a\n\n0. regsub(str, regex, sub)\n0. regsuball(str, regex, sub)\n0. ban_url(regex)\n0. ban(expression)\n0. purge;\n0. return(restart)\n0. return()\n0. hash_data()\n\n* regsub/regsuball\u304cURL\u306e\u66f8\u304d\u63db\u3048\u7cfb\n* ban_url, ban, purge\u304c\u30ad\u30e3\u30c3\u30b7\u30e5\u306e\u30af\u30ea\u30a2\u7cfb\n* return \u6b21\u306e\u72b6\u614b\u9077\u79fb\u306e\u70ba\u306efuntion. hash_data\u306fhash input\u306b\u6587\u5b57\u3092\u8db3\u3059\u70ba\u306e\u3082\u306e.\n\n## Varnish\u3068\u30d7\u30ed\u30bb\u30b9\n\n* Varnish\u306f\u5927\u304d\u304f\u308f\u3051\u308b\u3068\u3001Management\u30d7\u30ed\u30bb\u30b9\u3068\u3001Child/cache\u30d7\u30ed\u30bb\u30b9\u306b\u5206\u304b\u308c\u308b\u3002\n* Child/cache\u30d7\u30ed\u30bb\u30b9\u304c\u30ad\u30e3\u30c3\u30b7\u30e5\u3092\u884c\u3044\u3001Management\u30d7\u30ed\u30bb\u30b9\u304c\u305d\u308c\u3092\u7ba1\u7406\u3059\u308b\n  * varnishadm\u30b3\u30de\u30f3\u30c9\u3067\u7ba1\u7406\u30b3\u30de\u30f3\u30c9\u3092\u767a\u884c\u3067\u304d\u308b\u3002\n  * \u53cd\u6620\u306f\u3001Varnish\u3092\u518d\u8d77\u52d5\u3059\u308b\u4e8b\u7121\u304f\u884c\u3048\u308b\u3002\uff08\u5c1a\u3001varnishadm\u306f\u30ea\u30e2\u30fc\u30c8\u304b\u3089\u3067\u3082\u64cd\u4f5c\u3067\u304d\u308b\u3088\u3046\u306b\u8a2d\u5b9a\u53ef\u80fd\uff09\n\n\u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3\u306e\u56f3\u306f\u6b21\u306eURL\u306eProcess Architecture\u306e\u9805\u3092\u53c2\u8003\n\n[Tuning The Varnish Book](https://www.varnish-software.com/static/book/Tuning.html)\n\n\n## \u30ad\u30e3\u30c3\u30b7\u30e5\u30af\u30ea\u30a2\u306e\u65b9\u6cd5\n\n[Cash Invalidation](https://www.varnish-software.com/static/book/Cache_invalidation.html)\n\nVarnish\u306e\u30ad\u30e3\u30c3\u30b7\u30e5\u3092\u30af\u30ea\u30a2\u3059\u308b\u65b9\u6cd5\u306f\u6b21\u306e4\u3064\u304c\u3042\u308b\n\n1. ttl\u306e\u8a2d\u5b9a\u6642\u9650\u8a2d\u5b9a\n2. purge \u30aa\u30d6\u30b8\u30a7\u30af\u30c8\uff11\u3064\u306b\u5bfe\u3059\u308b\u30ad\u30e3\u30c3\u30b7\u30e5\u30af\u30ea\u30a2\n3. ban \u6b63\u898f\u8868\u73fe\u3092\u4f7f\u3063\u305f\u30ad\u30e3\u30c3\u30b7\u30e5\u30af\u30ea\u30a2\u306e\u4e88\u7d04(SmartBan)\n4. set req_hash_always_miss = true \u3042\u308bURL\u306b\u5bfe\u3059\u308b\u30ad\u30e3\u30c3\u30b7\u30e5\u306e\u30af\u30ea\u30a2\n5. purge method(varnish v4\u304b\u3089)\n\n* \u4e00\u62ec\u3067\u30ad\u30e3\u30c3\u30b7\u30e5\u3092\u30af\u30ea\u30a2\u3067\u304d\u308b\u306e\u306f\u3001SmartBan\u306e\u307f\n  * \u305d\u308c\u4ee5\u5916\u3060\u3068\u3001ttl\u306e\u6642\u9650\u8a2d\u5b9a(\u30c7\u30d5\u30a9\u30eb\u30c8\u3067\u306f\u3001\u30ad\u30e3\u30c3\u30b7\u30e5\u304c\u30af\u30ea\u30a2\u3055\u308c\u308b\u306e\u304c2\u5206\u306e\u6642\u9650\u8a2d\u5b9a)\n\n### SmartBan\u65b9\u5f0f\n\n BAN\u306e\u65b9\u5f0f\u306f\u30ad\u30e3\u30c3\u30b7\u30e5\u3092\u3059\u3050\u306b\u30af\u30ea\u30a2\u3059\u308b\u306e\u3067\u306f\u306a\u304f\u3001\u5bfe\u8c61\u306e\u30ad\u30e3\u30c3\u30b7\u30e5\u3092BAN\u306b\u3057\u3066\u304a\u304d\u3001\u6b21\u306b\u305d\u306eURL\u304c\u30ea\u30af\u30a8\u30b9\u30c8\u3055\u308c\u305f\u969b\u306b\u3001\u30d0\u30c3\u30af\u30a8\u30f3\u30c9\u306e\u30b5\u30fc\u30d0\u30fc\u306b\u8aad\u307f\u306b\u3044\u304f\u3068\u3044\u3063\u305f\u6319\u52d5\u3092\u3059\u308b\u3002\n  \n### SmartBan\u306e\u8a2d\u5b9a\u3068\u30c6\u30b9\u30c8\n\nBAN\u3068\u3044\u3046Method\u306e\u30ea\u30af\u30a8\u30b9\u30c8\u304c\u9001\u3089\u308c\u3066\u304d\u305f\u6642\u306b\u3001/sub\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u4ee5\u4e0b\u306e\u5168\u3066\u306ehtml\u3068\u3001/test.html\u306e\u30ad\u30e3\u30c3\u30b7\u30e5\u3092ban\u306b\u5165\u308c\u308b\u3001\u3064\u307e\u308a\u6b21\u56de\u30a2\u30af\u30bb\u30b9\u3055\u308c\u305f\u3068\u304d\u306b\u3001\u30d0\u30c3\u30af\u30a8\u30f3\u30c9\u306b\u53d6\u5f97\u3059\u308b\u3088\u3046\u306a\u8a2d\u5b9a\u306b\u306a\u3063\u3066\u3044\u308b\u3002\n\n```\nsub vcl_recv {\nif (req.request == \"BAN\") {\n  ban(\"req.url ~ ^/sub/.*.html\");\n  ban(\"req.url ~ ^/test.html\");\n  error 200 \"Banned.\";\n}\n```\n\n### \u30ad\u30e3\u30c3\u30b7\u30e5\u306e\u7834\u68c4\u306e\u30b3\u30de\u30f3\u30c9\n\n\u30ad\u30e3\u30c3\u30b7\u30e5\u306e\u5ec3\u68c4\u306fdefault.vcl\u3067\u8a2d\u5b9a\u53ef\u80fd\u3002\u4e0a\u8a18\u306e\u66f8\u304d\u65b9\u306e\u5834\u5408\u3001\u6b21\u306e\u30b3\u30de\u30f3\u30c9\u3067\u3001\u30ad\u30e3\u30c3\u30b7\u30e5\u304c\u7834\u68c4\u3055\u308c\u308b\u3002\uff08\u6ce8\uff1arefresh.html\u306f\u4f55\u3067\u3082\u826f\u3044\uff09\u5c1a\u3001ban\u306b\u95a2\u3057\u3066\u306f\u5f8c\u3067\u8ff0\u3079\u308bvarnishadm\u3067\u767a\u884c\u3059\u308b\u3053\u3068\u3082\u53ef\u80fd\n\n```\n$ curl -X BAN http://127.0.0.1:6081/refresh.html\n```\n\n### ttl\u306e\u30c7\u30d5\u30a9\u30eb\u30c8\u5024\u306e\u5909\u66f4\n\n\u30ad\u30e3\u30c3\u30b7\u30e5\u306e\u30c7\u30d5\u30a9\u30eb\u30c8\u5024\u306e\u5909\u66f4\u306f\u3001/etc/sysconfig/varnish\u306e\u6b21\u306e\u9805\u76ee\u3092\u8a2d\u5b9a\u3059\u308c\u3070\u5909\u66f4\u3067\u304d\u308b\n\n```\n# Default TTL used when the backend does not specify one\nVARNISH_TTL=120\n```\n\n### \u30ad\u30e3\u30c3\u30b7\u30e5\u5bfe\u8c61\u306b\u3088\u308b\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u306e\u5909\u66f4\n\n\u30ad\u30e3\u30c3\u30b7\u30e5\u306e\u6642\u9593\u3092\u30b3\u30f3\u30c6\u30f3\u30c4\u306b\u3088\u3063\u3066\u5909\u5316\u3055\u305b\u305f\u3044\u5834\u5408\u306f\u3001default.vcl\u3092\u8a2d\u5b9a\u3059\u308b\u3002\n\n[Varnish Book:VCL Basics](https://www.varnish-software.com/static/book/VCL_Basics.html)\n\n* \u6b21\u306e\u4f8b\u306fjpg\u30d5\u30a1\u30a4\u30eb\u3092\u5f37\u5236\u7684\u306b60s\u3067\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u3055\u305b\u308b\n\n```\nsub vcl_fetch {\n        if (req.url ~ \"\\.jpg$\") {\n                set beresp.ttl = 60s;\n        }\n}\n```\n\n### purge method(varnish v4)\n\n[Purging and banning](https://www.varnish-cache.org/docs/trunk/users-guide/purging.html)\n\nv4\u304b\u3089 purge METHOD\u8ffd\u52a0\u3055\u308c\u3066\u305f\u3088\u3046\u3067\u3059\uff01\n\n```\nacl purge {\n        \"localhost\";\n        \"192.168.55.0\"/24;\n}\n\nsub vcl_recv {\n        # allow PURGE from localhost and 192.168.55...\n\n        if (req.method == \"PURGE\") {\n                if (!client.ip ~ purge) {\n                        return(synth(405,\"Not allowed.\"));\n                }\n                return (purge);\n        }\n}\n```\n\n## \u30b5\u30a4\u30b8\u30f3\u30b0\n\n* Varnish\u306f\u3001\u30ad\u30e3\u30c3\u30b7\u30e5\u3059\u308b\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u306b\u305d\u308c\u305e\u308c1kb\u306e\u30aa\u30fc\u30d0\u30fc\u30d8\u30c3\u30c9\u304c\u304b\u304b\u308b\u3002\n* \u30b9\u30ec\u30c3\u30c9\u6570\u7b49\u306e\u4ed6\u306e\u30d1\u30e9\u30e1\u30fc\u30bf\u3082\u63b2\u8f09\u3055\u308c\u3066\u3044\u308b\u3002\n\n[Tuning The Varnish Book](https://www.varnish-software.com/static/book/Tuning.html)\n\n\n\n## \u30ed\u30b0\u306b\u3064\u3044\u3066\n\n* \u30ed\u30b0\u30d5\u30a1\u30a4\u30eb\u306f\u30c7\u30d5\u30a9\u30eb\u30c8\u3067\u306f\u66f8\u304b\u308c\u306a\u3044\u3002\n\n\u6b21\u306eURL\u306eLog data\u3092\u53c2\u7167\n\n[Getting started - The Varnish Book](https://www.varnish-software.com/static/book/Getting_started.html)\n\n\n\n## \u30d9\u30f3\u30c1\u30de\u30fc\u30af\n\nGolang\u88fd\u306eHTTP load testing tool\n\nhttps://github.com/tsenart/vegeta\n\n![Kobito.mtvTGg.png](https://qiita-image-store.s3.amazonaws.com/0/18843/16f78847-45a9-0770-c976-46f5246b5748.png \"Kobito.mtvTGg.png\")\n\n\n```\nbrew install vegeta\n```\n\n* localhost\u3078\u79d2\u9593100\u30ea\u30af\u30a8\u30b9\u30c8\u30ea\u30af\u30a8\u30b9\u30c8\u30925\u79d2\u9593\u884c\u3046\n\n```\n$ echo \"GET http://localhost:3000/\" | ./vegeta attack -rate=100 -duration=5s | ./vegeta report\n```\n\n\u7c21\u5358\u306b\u8a66\u305b\u307e\u3059\n\n## Reference\n\n* \u904e\u8ca0\u8377\u306b\u8010\u3048\u308bWeb\u306e\u4f5c\u308a\u65b9\n* \u30b5\u30fc\u30d0/\u30a4\u30f3\u30d5\u30e9\u3092\u652f\u3048\u308b\u6280\u8853\n* \u5927\u898f\u6a21\u30b5\u30fc\u30d3\u30b9\u6280\u8853\u5165\u9580\n* [The benefits of using Varnish](https://www.fastly.com/blog/benefits-of-using-varnish)\n* [High Performance Rails long edition](https://speakerdeck.com/mirakui/high-performance-rails-long-edition)\n\n### Varnish\u672c\u756a\u904b\u7528\u306b\u5411\u3051\u3066\n \n* [Varnish\u306e\u591a\u6bb5](http://blog.xcir.net/?p=1751)\n* [Rails and Varnish](https://www.slatestudio.com/blog/p/caching-in-rails-4-applications)\n* [Rails and Varnish2](http://ghost.thekindof.me/using-varnish-v4-as-a-reverse-proxy-cache-with-rails/)\n* [Varnish gem](https://github.com/russ/lacquer)\n\n### \u30ad\u30e3\u30c3\u30b7\u30e5\u306e\u7121\u52b9\u5316\u306e\u8a18\u4e8b\n\n[Varnish Book: Cache invalidation](https://www.varnish-software.com/static/book/Cache_invalidation.html)\n[Purging and banning](https://www.varnish-cache.org/docs/3.0/tutorial/purging.html)\n[Bans and purges in Varnish](https://www.varnish-software.com/blog/bans-and-purges-varnish-30)\n\n### Varnish\u306e\u5168\u4f53\u50cf \n\n[Getting started](https://www.varnish-software.com/static/book/Getting_started.html)\n\n### Varnish Command Line Interface\n\n[Varnish Book:VCL Basics](https://www.varnish-software.com/static/book/VCL_Basics.html)\n[Varnish CLI](https://www.varnish-cache.org/docs/trunk/reference/varnish-cli.html)\n\n### Varnish\u306e\u8a2d\u5b9a\n\n[Varnish Book: Tuning](https://www.varnish-software.com/static/book/Tuning.html)\n[Sizing your cache](https://www.varnish-cache.org/docs/3.0/tutorial/sizing_your_cache.html)\n[varnishd](https://www.varnish-cache.org/docs/3.0/reference/varnishd.html)\n", "tags": ["Varnish"]}