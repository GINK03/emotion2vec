{"context": "\u8907\u6570\u306e\u30e1\u30fc\u30eb\u30a2\u30c9\u30ec\u30b9\u3092\u6301\u3064\u30e6\u30fc\u30b6\u30fc\u30e2\u30c7\u30eb\u3092Devise\u3067\u3055\u304f\u3055\u304f\u3063\u3068\u4f5c\u308d\u3046\u3068\u601d\u3063\u3066\u305f\u3089\u601d\u3063\u305f\u3088\u308a\u624b\u9593\u53d6\u3063\u305f\u306e\u3067\u30e1\u30e2\n\nDevise\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3068User\u30e2\u30c7\u30eb\u306e\u4f5c\u6210\n\n\u30b3\u30de\u30f3\u30c9\n$ rails new demo --skip-bundle\n$ cd demo\n$ echo \"gem 'devise'\" >> Gemfile\n$ rails g devise:install\n\n\n\nconfig/environments/development.rb\nRails.application.configure do\n\n  #~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~#\n  #\u2193\u8ffd\u52a0\n\n  config.action_mailer.default_url_options = { host: 'localhost:3000' }\nend\n\n\n\nUser\u30e2\u30c7\u30eb\u306e\u4f5c\u6210\n\n\u30b3\u30de\u30f3\u30c9\n$ rails g devise User\n\n\n\nEmail\u30e2\u30c7\u30eb\u306e\u4f5c\u6210\n\n\u30b3\u30de\u30f3\u30c9\n$ rails g model Email user:belong_to address:strings\n\n\n\nUsers\u30c6\u30fc\u30d6\u30eb\u306e\u7de8\u96c6\n\ndb/migrate/20xxxxxxxxxxxx_devise_create_users.rb\nclass DeviseCreateUsers < ActiveRecord::Migration[5.0]\n  def change\n    create_table :users do |t|\n      ## Database authenticatable\n      #\u2193\u30b3\u30e1\u30f3\u30c8\u30a2\u30a6\u30c8or\u524a\u9664\n      #t.string :email,              null: false, default: \"\"\n\n      #\u2193\u8ffd\u52a0\n      t.belongs_to :main_email, null: true\n      #\u2191\u3053\u3053\u3067\u30cf\u30de\u3063\u305f\u3001email\u30ab\u30e9\u30e0\u306fDevise\u304c\u30e1\u30bd\u30c3\u30c9\u30aa\u30fc\u30d0\u30fc\u30e9\u30a4\u30c9\u3057\u3066\u308b\u3089\u3057\u304f\n      #'t.belong_to :email' \u3068\u3057\u3066\u3057\u307e\u3046\u3068\u4fdd\u5b58\u304c\u3067\u304d\u306a\u3044\n      #\u5f8c\u3001'null: false'\u306b\u3057\u3066\u3057\u307e\u3046\u3068\u30c7\u30c3\u30c9\u30ed\u30c3\u30af\u304c\u767a\u751f\u3057\u4fdd\u5b58\u3067\u304d\u306a\u3044\n      #~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~#\n    end\n    #\u2193\u30b3\u30e1\u30f3\u30c8\u30a2\u30a6\u30c8or\u524a\u9664\n    #add_index :users, :email,                unique: true\n  end\nend\n\n\n\nEmails\u30c6\u30fc\u30d6\u30eb\u306e\u7de8\u96c6\n\ndb/migrate/20xxxxxxxxxxxx_create_emails.rb\nclass CreateEmails < ActiveRecord::Migration[5.0]\n  def change\n    create_table :emails do |t|\n      #\u2193\u884c\u672b\u306b', null: false'\u3092\u8ffd\u52a0\n      t.belongs_to :user, null: false\n      t.string :address\n\n      t.timestamps\n    end\n    #\u2193\u8ffd\u52a0\n    add_index :emails, :address, unique: true\n  end\nend\n\n\n\nUser\u30e2\u30c7\u30eb\u306e\u7de8\u96c6\n\napp/model/user.rb\nclass User < ApplicationRecord\n  #~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~#\n  #\u2193\u4ee5\u4e0b\u8ffd\u52a0\n\n  belongs_to :main_email, class_name: Email, optional: true\n  accepts_nested_attributes_for :main_email\n\n  has_many :emails, dependent: :destroy, index_errors: true\n  accepts_nested_attributes_for :emails\n\n  attr_accessor :email\n\n  after_save :set_main_email\n  after_save :add_main_email_to_emails\n\n  #\u2193devise\u306bemail\u306e\u30c1\u30a7\u30c3\u30af\u3092\u3055\u305b\u306a\u3044\u3088\u3046\u306b\u3059\u308b\n  def email_required?\n    false\n  end\n\n  def email_changed?\n    false\n  end\n\n\n  protected\n  #\u2193devise\u306e\u30e6\u30fc\u30b6\u30fc\u53d6\u5f97\u30e1\u30bd\u30c3\u30c9\u3092\u30aa\u30fc\u30d0\u30fc\u30e9\u30a4\u30c9\n  def self.find_first_by_auth_conditions(warden_conditions)\n    conditions = warden_conditions.dup\n    if email = conditions.delete(:email)\n      #\u2193email\u3092emails\u306b\u6301\u3064\u30e6\u30fc\u30b6\u30fc\u3092\u8fd4\u3059\n      where(conditions).joins(:emails).find_by('emails.address': email)\n      #\u2193main_email\u3067\u3057\u304b\u30ed\u30b0\u30a4\u30f3\u3055\u305b\u305f\u304f\u306a\u3044\u5834\u5408\u306f\u3053\u308c\n      #where(conditions).joins(:main_email).find_by('main_email.address': email)\n    else\n      where(conditions).first\n    end\n  end\n\n  #\u2193main_email\u304c\u8a2d\u5b9a\u3055\u308c\u3066\u3044\u306a\u3044\u6642\u306bemails\u306e\u6700\u521d\u306e\u5024\u3092\u8a2d\u5b9a\u3059\u308b\n  def set_main_email\n    return false if self.emails.empty?\n    if self.main_email.nil?\n      self.main_email = self.emails.first\n      self.save\n    end\n  end\n\n  #\u2193main_email\u304c\u5909\u66f4\u3055\u308c\u305f\u6642\u306bemails\u306b\u8ffd\u52a0\n  #\u4eca\u56de\u306e\u5b9f\u88c5\u3067\u306f\u5fc5\u8981\u306a\u3044\u304c\u4e00\u5fdc\n  def add_main_email_to_emails\n    return false if self.main_email.nil?\n    if self.main_email.changed? && !self.emails.include?(self.main_email)\n      self.emails << self.main_email\n      self.save\n    end\n  end\nend\n\n\n\n\nEmail\u30e2\u30c7\u30eb\u306e\u7de8\u96c6\n\napp/model/email.rb\nclass Email < ApplicationRecord\n  has_one :user\n\n  belongs_to :user, optional: true\n  #\u2191Rails5\u304b\u3089belong_to\u30ab\u30e9\u30e0\u306f\u5fc5\u9808\u306b\u306a\u3063\u305f\u304c\u4fdd\u5b58\u3057\u3066\u304b\u3089\u3067\u306a\u3044\u3068\n  #ID\u304c\u5b9a\u307e\u3089\u305a\u4fdd\u5b58\u3067\u304d\u306a\u3044\u306e\u3067'optional: true'\u3092\u6307\u5b9a\nend\n\n\n\n\nApplicationController\u306e\u7de8\u96c6\n\napp/controllers/application_controller.rb\nclass ApplicationController < ActionController::Base\n  protect_from_forgery with: :exception\n\n  #\u2193\u4ee5\u4e0b\u8ffd\u52a0\n  before_action :configure_permitted_parameters, if: :devise_controller?\n\n  protected\n  def configure_permitted_parameters\n    #Devise4\u3067\u306e\u66f8\u304d\u65b9 \u53e4\u3044\u30d0\u30fc\u30b8\u30e7\u30f3\u3067\u306f\n    #'devise_parameter_sanitizer.for'\u3092\u4f7f\u3046\n    devise_parameter_sanitizer.permit(:sign_up) do |u|\n      u.permit([emails_attributes: [:address]], :password, :password_confirmation, :remember_me)\n    end\n    devise_parameter_sanitizer.permit(:sign_in) do\n      |u| u.permit([emails_attributes: [:address]], :password, :remember_me)\n    end\n    devise_parameter_sanitizer.permit(:account_update) do\n      |u| u.permit([emails_attributes: [:address]], :password, :password_confirmation, :current_password)\n    end\n  end\nend\n\n\n\n\nViews\u306e\u7de8\u96c6\n\n\u30b3\u30de\u30f3\u30c9\n$ rails g devise:views user\n\n\n\nconfig/initializers/devise.rb\n  #\u2193223\u884c\u76ee\u4ed8\u8fd1 \u30b3\u30e1\u30f3\u30c8\u30a2\u30a6\u30c8\u306e\u307e\u307e\u653e\u7f6eor\u524a\u9664\n  # config.scoped_views = false\n  config.scoped_views = true\n  #\u2191\u8ffd\u52a0\n\n\n\napp/views/users/registrations/*.html.erb\n<h2>Sign up</h2>\n\n<%= form_for(resource, as: resource_name, url: registration_path(resource_name)) do |f| %>\n  <%= devise_error_messages! %>\n\n  #\u2193\u8ffd\u52a0\n  <% @user.emails.new if @user.emails.empty? %>\n  <%= f.fields_for :emails, @user.emails || @user.emails.new do |e| %>\n  <div class=\"field\">\n    <%= e.label :email %><br />\n    <%= e.email_field :address %>\n  </div>\n  <% end %>\n\n  #\u2193\u524a\u9664\n  <div class=\"field\">\n    <%= f.label :email %><br />\n    <%= f.email_field :email, autofocus: true %>\n  </div>\n\n\n  #~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~#\n\n\n\n\u3053\u308c\u3067\u304a\u3057\u307e\u3044\u3002  \n\u8907\u6570\u306e\u30e1\u30fc\u30eb\u30a2\u30c9\u30ec\u30b9\u3092\u6301\u3064\u30e6\u30fc\u30b6\u30fc\u30e2\u30c7\u30eb\u3092Devise\u3067\u3055\u304f\u3055\u304f\u3063\u3068\u4f5c\u308d\u3046\u3068\u601d\u3063\u3066\u305f\u3089\u601d\u3063\u305f\u3088\u308a\u624b\u9593\u53d6\u3063\u305f\u306e\u3067\u30e1\u30e2\n\n##Devise\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3068User\u30e2\u30c7\u30eb\u306e\u4f5c\u6210\n\n```bash:\u30b3\u30de\u30f3\u30c9\n$ rails new demo --skip-bundle\n$ cd demo\n$ echo \"gem 'devise'\" >> Gemfile\n$ rails g devise:install\n```\n\n```ruby:config/environments/development.rb\nRails.application.configure do\n\n  #~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~#\n  #\u2193\u8ffd\u52a0\n  \n  config.action_mailer.default_url_options = { host: 'localhost:3000' }\nend\n```\n\n## User\u30e2\u30c7\u30eb\u306e\u4f5c\u6210\n```bash:\u30b3\u30de\u30f3\u30c9\n$ rails g devise User\n```\n\n##Email\u30e2\u30c7\u30eb\u306e\u4f5c\u6210\n```bash:\u30b3\u30de\u30f3\u30c9\n$ rails g model Email user:belong_to address:strings\n```\n\n##Users\u30c6\u30fc\u30d6\u30eb\u306e\u7de8\u96c6\n```ruby:db/migrate/20xxxxxxxxxxxx_devise_create_users.rb\nclass DeviseCreateUsers < ActiveRecord::Migration[5.0]\n  def change\n    create_table :users do |t|\n      ## Database authenticatable\n      #\u2193\u30b3\u30e1\u30f3\u30c8\u30a2\u30a6\u30c8or\u524a\u9664\n      #t.string :email,              null: false, default: \"\"\n      \n      #\u2193\u8ffd\u52a0\n      t.belongs_to :main_email, null: true\n      #\u2191\u3053\u3053\u3067\u30cf\u30de\u3063\u305f\u3001email\u30ab\u30e9\u30e0\u306fDevise\u304c\u30e1\u30bd\u30c3\u30c9\u30aa\u30fc\u30d0\u30fc\u30e9\u30a4\u30c9\u3057\u3066\u308b\u3089\u3057\u304f\n      #'t.belong_to :email' \u3068\u3057\u3066\u3057\u307e\u3046\u3068\u4fdd\u5b58\u304c\u3067\u304d\u306a\u3044\n      #\u5f8c\u3001'null: false'\u306b\u3057\u3066\u3057\u307e\u3046\u3068\u30c7\u30c3\u30c9\u30ed\u30c3\u30af\u304c\u767a\u751f\u3057\u4fdd\u5b58\u3067\u304d\u306a\u3044\n      #~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~#\n    end\n    #\u2193\u30b3\u30e1\u30f3\u30c8\u30a2\u30a6\u30c8or\u524a\u9664\n    #add_index :users, :email,                unique: true\n  end\nend\n```\n\n##Emails\u30c6\u30fc\u30d6\u30eb\u306e\u7de8\u96c6\n```ruby:db/migrate/20xxxxxxxxxxxx_create_emails.rb\nclass CreateEmails < ActiveRecord::Migration[5.0]\n  def change\n    create_table :emails do |t|\n      #\u2193\u884c\u672b\u306b', null: false'\u3092\u8ffd\u52a0\n      t.belongs_to :user, null: false\n      t.string :address\n\n      t.timestamps\n    end\n    #\u2193\u8ffd\u52a0\n    add_index :emails, :address, unique: true\n  end\nend\n```\n\n##User\u30e2\u30c7\u30eb\u306e\u7de8\u96c6\n```ruby:app/model/user.rb\nclass User < ApplicationRecord\n  #~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~#\n  #\u2193\u4ee5\u4e0b\u8ffd\u52a0\n\n  belongs_to :main_email, class_name: Email, optional: true\n  accepts_nested_attributes_for :main_email\n\n  has_many :emails, dependent: :destroy, index_errors: true\n  accepts_nested_attributes_for :emails\n  \n  attr_accessor :email\n  \n  after_save :set_main_email\n  after_save :add_main_email_to_emails\n\n  #\u2193devise\u306bemail\u306e\u30c1\u30a7\u30c3\u30af\u3092\u3055\u305b\u306a\u3044\u3088\u3046\u306b\u3059\u308b\n  def email_required?\n    false\n  end\n\n  def email_changed?\n    false\n  end\n  \n\n  protected\n  #\u2193devise\u306e\u30e6\u30fc\u30b6\u30fc\u53d6\u5f97\u30e1\u30bd\u30c3\u30c9\u3092\u30aa\u30fc\u30d0\u30fc\u30e9\u30a4\u30c9\n  def self.find_first_by_auth_conditions(warden_conditions)\n    conditions = warden_conditions.dup\n    if email = conditions.delete(:email)\n      #\u2193email\u3092emails\u306b\u6301\u3064\u30e6\u30fc\u30b6\u30fc\u3092\u8fd4\u3059\n      where(conditions).joins(:emails).find_by('emails.address': email)\n      #\u2193main_email\u3067\u3057\u304b\u30ed\u30b0\u30a4\u30f3\u3055\u305b\u305f\u304f\u306a\u3044\u5834\u5408\u306f\u3053\u308c\n      #where(conditions).joins(:main_email).find_by('main_email.address': email)\n    else\n      where(conditions).first\n    end\n  end\n  \n  #\u2193main_email\u304c\u8a2d\u5b9a\u3055\u308c\u3066\u3044\u306a\u3044\u6642\u306bemails\u306e\u6700\u521d\u306e\u5024\u3092\u8a2d\u5b9a\u3059\u308b\n  def set_main_email\n    return false if self.emails.empty?\n    if self.main_email.nil?\n      self.main_email = self.emails.first\n      self.save\n    end\n  end\n\n  #\u2193main_email\u304c\u5909\u66f4\u3055\u308c\u305f\u6642\u306bemails\u306b\u8ffd\u52a0\n  #\u4eca\u56de\u306e\u5b9f\u88c5\u3067\u306f\u5fc5\u8981\u306a\u3044\u304c\u4e00\u5fdc\n  def add_main_email_to_emails\n    return false if self.main_email.nil?\n    if self.main_email.changed? && !self.emails.include?(self.main_email)\n      self.emails << self.main_email\n      self.save\n    end\n  end\nend\n\n```\n\n##Email\u30e2\u30c7\u30eb\u306e\u7de8\u96c6\n```ruby:app/model/email.rb\nclass Email < ApplicationRecord\n  has_one :user\n\n  belongs_to :user, optional: true\n  #\u2191Rails5\u304b\u3089belong_to\u30ab\u30e9\u30e0\u306f\u5fc5\u9808\u306b\u306a\u3063\u305f\u304c\u4fdd\u5b58\u3057\u3066\u304b\u3089\u3067\u306a\u3044\u3068\n  #ID\u304c\u5b9a\u307e\u3089\u305a\u4fdd\u5b58\u3067\u304d\u306a\u3044\u306e\u3067'optional: true'\u3092\u6307\u5b9a\nend\n\n```\n\n##ApplicationController\u306e\u7de8\u96c6\n```ruby:app/controllers/application_controller.rb\nclass ApplicationController < ActionController::Base\n  protect_from_forgery with: :exception\n  \n  #\u2193\u4ee5\u4e0b\u8ffd\u52a0\n  before_action :configure_permitted_parameters, if: :devise_controller?\n  \n  protected\n  def configure_permitted_parameters\n    #Devise4\u3067\u306e\u66f8\u304d\u65b9 \u53e4\u3044\u30d0\u30fc\u30b8\u30e7\u30f3\u3067\u306f\n    #'devise_parameter_sanitizer.for'\u3092\u4f7f\u3046\n    devise_parameter_sanitizer.permit(:sign_up) do |u|\n      u.permit([emails_attributes: [:address]], :password, :password_confirmation, :remember_me)\n    end\n    devise_parameter_sanitizer.permit(:sign_in) do\n      |u| u.permit([emails_attributes: [:address]], :password, :remember_me)\n    end\n    devise_parameter_sanitizer.permit(:account_update) do\n      |u| u.permit([emails_attributes: [:address]], :password, :password_confirmation, :current_password)\n    end\n  end\nend\n\n```\n\n##Views\u306e\u7de8\u96c6\n\n```Bash:\u30b3\u30de\u30f3\u30c9\n$ rails g devise:views user\n```\n\n```ruby:config/initializers/devise.rb\n  #\u2193223\u884c\u76ee\u4ed8\u8fd1 \u30b3\u30e1\u30f3\u30c8\u30a2\u30a6\u30c8\u306e\u307e\u307e\u653e\u7f6eor\u524a\u9664\n  # config.scoped_views = false\n  config.scoped_views = true\n  #\u2191\u8ffd\u52a0\n```\n\n```ruby:app/views/users/registrations/*.html.erb\n<h2>Sign up</h2>\n\n<%= form_for(resource, as: resource_name, url: registration_path(resource_name)) do |f| %>\n  <%= devise_error_messages! %>\n\n  #\u2193\u8ffd\u52a0\n  <% @user.emails.new if @user.emails.empty? %>\n  <%= f.fields_for :emails, @user.emails || @user.emails.new do |e| %>\n  <div class=\"field\">\n    <%= e.label :email %><br />\n    <%= e.email_field :address %>\n  </div>\n  <% end %>\n  \n  #\u2193\u524a\u9664\n  <div class=\"field\">\n    <%= f.label :email %><br />\n    <%= f.email_field :email, autofocus: true %>\n  </div>\n\n\n  #~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~#\n  \n```\n\u3053\u308c\u3067\u304a\u3057\u307e\u3044\u3002  \n", "tags": ["Ruby", "Rails", "Rails5", "devise"]}