{"tags": ["serverspec", "WinRM"], "context": "\u4eca\u5e74\uff082016\u5e74\uff09\u306b\u306a\u3063\u3066\u304b\u3089rubygems\u306eWinRM\u3067\u30a4\u30f3\u30bf\u30fc\u30d5\u30a7\u30fc\u30b9\u5909\u66f4\u304c\u6fc0\u3057\u304f\u5468\u308a\u304c\u8ffd\u3044\u3064\u3044\u3066\u3044\u306a\u3044\u3002\n\u4f8b\u3048\u3070\u73fe\u72b6(2016/10/28)\u3001Serverspec\u3067Windows\u76f8\u624b\u306b\u30c6\u30b9\u30c8\u5b9f\u884c\u3059\u308b\u74b0\u5883\u3092\u6574\u3048\u3066rake\u5b9f\u884c\u3057\u3066\u3082\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u30a8\u30e9\u30fc\u304c\u51fa\u3066\u6b62\u307e\u3063\u3066\u3057\u307e\u3046\u308f\u3051\u3067\u3059\u304c\u3001\u305d\u308c\u3092\u56de\u907f\u3059\u308b\u305f\u3081\u306e\u30e1\u30e2\u3002\n[root@alpha-139 ~]# rake\n/usr/bin/ruby -I/usr/local/share/gems/gems/rspec-core-3.5.4/lib:/usr/local/share/gems/gems/rspec-support-3.5.0/lib /usr/local/share/gems/gems/rspec-core-3.5.4/exe/rspec --pattern spec/testw/\\*_spec.rb\n/root/spec/spec_helper.rb:10:in `<top (required)>': uninitialized constant WinRM::WinRMWebService (NameError)\n\n\uff11\uff0espec/spec_helper.rb \u3092\u4fee\u6b63\u3059\u308b\nspec/spec_helper.rb \u306f serverspec-init \u3092\u5b9f\u884c\u3059\u308b\u3068\u751f\u6210\u3055\u308c\u308b\u3082\u306e\u3067\u3001\u73fe\u72b6\uff08serverspec (2.37.2)\uff09\u3067\u306f\u4ee5\u4e0b\u306e\u69d8\u306a\u3082\u306e\u3067\u3059\u304c\u3001\u307e\u305a\u306f\u3053\u3053\u304b\u3089\u52d5\u304b\u3093\u3067\u3059\u3002\n\n(\u4fee\u6b63\u524d)spec/spec_helper.rb\nrequire 'serverspec'\nrequire 'winrm'\n\nset :backend, :winrm\n\nuser = <username>\npass = <password>\nendpoint = \"http://#{ENV['TARGET_HOST']}:5985/wsman\"\n\nwinrm = ::WinRM::WinRMWebService.new(endpoint, :ssl, :user => user, :pass => pass, :basic_auth_only => true)\nwinrm.set_timeout 300 # 5 minutes max timeout for any operation\nSpecinfra.configuration.winrm = winrm\n\n\nWinRM::WinRMWebService\u3092\u3001WinRM::Connection\u3092\u4f7f\u7528\u3059\u308b\u3088\u3046\u306b\u4fee\u6b63\u3057\u307e\u3059\u3002\n\n(\u4fee\u6b63\u5f8c)spec/spec_helper.rb\nrequire 'serverspec'\nrequire 'winrm'\n\nset :backend, :winrm\n\nopts = {\n  user: \"Administrator\",\n  password: \"password\",\n  endpoint: \"http://#{ENV['TARGET_HOST']}:5985/wsman\",\n  operation_timeout: 300,\n}\n\nwinrm = WinRM::Connection.new(opts)\nSpecinfra.configuration.winrm = winrm\n\n\n(\u53c2\u8003)github - WinRb/WinRM\nhttps://github.com/WinRb/WinRM\n\uff12\uff0ebackend/winrm.rb \u3092\u4fee\u6b63\u3059\u308b\n\u3042\u30fc\u3001\u5143\u306e\u30b3\u30fc\u30c9\u3092\u3059\u3079\u3066\u63b2\u8f09\u3059\u308b\u306e\u306f\u9762\u5012\u304f\u3055\u3044\u3053\u3068\u3067\u3042\u308b\u306e\u3067\u7701\u7565\u3057\u307e\u3059\u304c\u3001specinfra\uff08\u73fe\u6642\u70b9\u306e\u30d0\u30fc\u30b8\u30e7\u30f3 2.63.3\uff09\u306e\u4e00\u90e8\u306e\u30d5\u30a1\u30a4\u30eb\u3082\u65b0\u3057\u3044gem/winrm\u306e\u5b9f\u88c5\u306b\u8ffd\u3044\u3064\u3044\u3066\u3044\u306a\u3044\u306e\u3067\uff08powershell\u3068\u3044\u3046\u30e1\u30bd\u30c3\u30c9\u304c\u5ec3\u6b62\u3055\u308c\u3066\u3001shell(:powershell) \u306b\u306a\u3063\u3066\u3044\u308b\u306e\u306b\u5bfe\u5fdc\u3057\u3066\u3044\u306a\u3044\uff09\u3001\u305d\u3061\u3089\u3082\u4fee\u6b63\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\u3061\u306a\u307f\u306b\u4fee\u6b63\u3057\u306a\u3044\u3068\u4ee5\u4e0b\u69d8\u306a\u30a8\u30e9\u30fc\u304c\u51fa\u307e\u3059\n  1) Port \"80\" should be listening\n     On host `testw'\n     Failure/Error: it { should be_listening }\n     NoMethodError:\n       undefined method `powershell' for #<WinRM::Connection:0x00000003244ea8>\n\n     # /usr/local/share/gems/gems/specinfra-2.63.3/lib/specinfra/backend/winrm.rb:14:in `run_command'\n     # /usr/local/share/gems/gems/specinfra-2.63.3/lib/specinfra/runner.rb:27:in `run'\n     # /usr/local/share/gems/gems/specinfra-2.63.3/lib/specinfra/runner.rb:19:in `method_missing'\n\n\u3068\u308a\u3042\u3048\u305a\u3001bash\u30d7\u30ed\u30f3\u30d7\u30c8\u3067\u4ee5\u4e0b\u3092\u5b9f\u884c\u3059\u308b\u3068\u4fee\u6b63\u3055\u308c\u307e\u3059\uff08ruby\u30b3\u30fc\u30c9\u305d\u306e\u3082\u306e\u3067\u306f\u306a\u3044\u3067\u3059\uff09\u3002\n\u5ff5\u306e\u305f\u3081\u30aa\u30ea\u30b8\u30ca\u30eb\u306e winrm.rb \u3092 winrm.rb.org \u3068\u3044\u3046\u540d\u524d\u3067\u3068\u3063\u3066\u3044\u307e\u3059\u3002\npushd /usr/local/share/gems/gems/specinfra-*/lib/specinfra/backend\nif [ ! -e winrm.rb.org ] ; then cp winrm.rb winrm.rb.org ; fi\ncat > winrm.rb << 'EOF'\nmodule Specinfra\n  module Backend\n    class Winrm < Base\n      include PowerShell::ScriptHelper\n\n      def os_info\n        { :family => 'windows', :release => nil, :arch => nil }\n      end\n\n      def run_command(cmd, opts={})\n        script = create_script(cmd)\n        winrm = get_config(:winrm)\n\n        shell = winrm.shell(:powershell)\n        result = shell.run(script)\n        stdout = result.stdout\n        stderr = result.stderr\n        exit_status = result.exitcode\n        shell.close\n\n        if @example\n          @example.metadata[:command] = script\n          @example.metadata[:stdout]  = stdout + stderr\n        end\n\n        CommandResult.new :stdout => stdout, :stderr => stderr, :exit_status => exit_status\n      end\n    end\n  end\nend\nEOF\npopd\n\n\u3061\u306a\u307f\u306bspecinfra\u306egithub\u306f\u4ee5\u4e0b\u3067\u3059\u304c\u3001\u30d5\u30a3\u30fc\u30c9\u30d0\u30c3\u30af\u3059\u308b\u306e\u304c\u624b\u9593\u306a\u306e\u3067\u89aa\u5207\u306a\u65b9\u304c\u3044\u308c\u3070\u662f\u975e\u30fb\u30fb\nhttps://github.com/mizzy/specinfra\n\u3068\u306f\u3044\u3048\u30012016\u5e74\u306f\u3058\u3081\u3050\u3089\u3044\u306bgem/WinRM\u304c\u8a8d\u8a3c\u30d7\u30ed\u30c8\u30b3\u30eb\u3068\u3057\u3066:negotiate\u306b\u5bfe\u5fdc\u3057\u59cb\u3081\u305f\u306e\u3067\u3059\u304c\u3001\u3053\u306e\u304a\u304b\u3052\u3067Windows\u5074\u306bHTTPS/basic\u8a8d\u8a3c\u3092\u6709\u52b9\u306b\u3059\u308b\u3068\u304b\u306e\u624b\u9593\u304c\u8981\u3089\u306a\u304f\u306a\u3063\u3066\u304a\u308a\u3001\u3053\u308c\u304c\u305d\u308c\u306a\u308a\u306b\u3059\u3070\u3089\u3057\u3044\u3002\n\u3053\u306e\u8fba\u306fAnsible\u306e\u305f\u3081\u306bpython/winrm\u3067\u3082\u65e9\u304f\u5b9f\u88c5\u3057\u3066\u304f\u308c\u308c\u3070\u3068\u3001\n\u4eca\u5e74\uff082016\u5e74\uff09\u306b\u306a\u3063\u3066\u304b\u3089rubygems\u306eWinRM\u3067\u30a4\u30f3\u30bf\u30fc\u30d5\u30a7\u30fc\u30b9\u5909\u66f4\u304c\u6fc0\u3057\u304f\u5468\u308a\u304c\u8ffd\u3044\u3064\u3044\u3066\u3044\u306a\u3044\u3002\n\n\u4f8b\u3048\u3070\u73fe\u72b6(2016/10/28)\u3001Serverspec\u3067Windows\u76f8\u624b\u306b\u30c6\u30b9\u30c8\u5b9f\u884c\u3059\u308b\u74b0\u5883\u3092\u6574\u3048\u3066rake\u5b9f\u884c\u3057\u3066\u3082\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u30a8\u30e9\u30fc\u304c\u51fa\u3066\u6b62\u307e\u3063\u3066\u3057\u307e\u3046\u308f\u3051\u3067\u3059\u304c\u3001\u305d\u308c\u3092\u56de\u907f\u3059\u308b\u305f\u3081\u306e\u30e1\u30e2\u3002\n\n```\n[root@alpha-139 ~]# rake\n/usr/bin/ruby -I/usr/local/share/gems/gems/rspec-core-3.5.4/lib:/usr/local/share/gems/gems/rspec-support-3.5.0/lib /usr/local/share/gems/gems/rspec-core-3.5.4/exe/rspec --pattern spec/testw/\\*_spec.rb\n/root/spec/spec_helper.rb:10:in `<top (required)>': uninitialized constant WinRM::WinRMWebService (NameError)\n```\n\n\n**\uff11\uff0espec/spec_helper.rb \u3092\u4fee\u6b63\u3059\u308b**\n\nspec/spec_helper.rb \u306f serverspec-init \u3092\u5b9f\u884c\u3059\u308b\u3068\u751f\u6210\u3055\u308c\u308b\u3082\u306e\u3067\u3001\u73fe\u72b6\uff08serverspec (2.37.2)\uff09\u3067\u306f\u4ee5\u4e0b\u306e\u69d8\u306a\u3082\u306e\u3067\u3059\u304c\u3001\u307e\u305a\u306f\u3053\u3053\u304b\u3089\u52d5\u304b\u3093\u3067\u3059\u3002\n\n```ruby:(\u4fee\u6b63\u524d)spec/spec_helper.rb\nrequire 'serverspec'\nrequire 'winrm'\n\nset :backend, :winrm\n\nuser = <username>\npass = <password>\nendpoint = \"http://#{ENV['TARGET_HOST']}:5985/wsman\"\n\nwinrm = ::WinRM::WinRMWebService.new(endpoint, :ssl, :user => user, :pass => pass, :basic_auth_only => true)\nwinrm.set_timeout 300 # 5 minutes max timeout for any operation\nSpecinfra.configuration.winrm = winrm\n```\n\nWinRM::WinRMWebService\u3092\u3001WinRM::Connection\u3092\u4f7f\u7528\u3059\u308b\u3088\u3046\u306b\u4fee\u6b63\u3057\u307e\u3059\u3002\n\n```ruby:(\u4fee\u6b63\u5f8c)spec/spec_helper.rb\nrequire 'serverspec'\nrequire 'winrm'\n\nset :backend, :winrm\n\nopts = {\n  user: \"Administrator\",\n  password: \"password\",\n  endpoint: \"http://#{ENV['TARGET_HOST']}:5985/wsman\",\n  operation_timeout: 300,\n}\n\nwinrm = WinRM::Connection.new(opts)\nSpecinfra.configuration.winrm = winrm\n```\n(\u53c2\u8003)github - WinRb/WinRM\nhttps://github.com/WinRb/WinRM\n\n\n**\uff12\uff0ebackend/winrm.rb \u3092\u4fee\u6b63\u3059\u308b**\n\n\u3042\u30fc\u3001\u5143\u306e\u30b3\u30fc\u30c9\u3092\u3059\u3079\u3066\u63b2\u8f09\u3059\u308b\u306e\u306f\u9762\u5012\u304f\u3055\u3044\u3053\u3068\u3067\u3042\u308b\u306e\u3067\u7701\u7565\u3057\u307e\u3059\u304c\u3001specinfra\uff08\u73fe\u6642\u70b9\u306e\u30d0\u30fc\u30b8\u30e7\u30f3 2.63.3\uff09\u306e\u4e00\u90e8\u306e\u30d5\u30a1\u30a4\u30eb\u3082\u65b0\u3057\u3044gem/winrm\u306e\u5b9f\u88c5\u306b\u8ffd\u3044\u3064\u3044\u3066\u3044\u306a\u3044\u306e\u3067\uff08powershell\u3068\u3044\u3046\u30e1\u30bd\u30c3\u30c9\u304c\u5ec3\u6b62\u3055\u308c\u3066\u3001shell(:powershell) \u306b\u306a\u3063\u3066\u3044\u308b\u306e\u306b\u5bfe\u5fdc\u3057\u3066\u3044\u306a\u3044\uff09\u3001\u305d\u3061\u3089\u3082\u4fee\u6b63\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\u3061\u306a\u307f\u306b\u4fee\u6b63\u3057\u306a\u3044\u3068\u4ee5\u4e0b\u69d8\u306a\u30a8\u30e9\u30fc\u304c\u51fa\u307e\u3059\n\n```\n  1) Port \"80\" should be listening\n     On host `testw'\n     Failure/Error: it { should be_listening }\n     NoMethodError:\n       undefined method `powershell' for #<WinRM::Connection:0x00000003244ea8>\n\n     # /usr/local/share/gems/gems/specinfra-2.63.3/lib/specinfra/backend/winrm.rb:14:in `run_command'\n     # /usr/local/share/gems/gems/specinfra-2.63.3/lib/specinfra/runner.rb:27:in `run'\n     # /usr/local/share/gems/gems/specinfra-2.63.3/lib/specinfra/runner.rb:19:in `method_missing'\n```\n\n\u3068\u308a\u3042\u3048\u305a\u3001bash\u30d7\u30ed\u30f3\u30d7\u30c8\u3067\u4ee5\u4e0b\u3092\u5b9f\u884c\u3059\u308b\u3068\u4fee\u6b63\u3055\u308c\u307e\u3059\uff08ruby\u30b3\u30fc\u30c9\u305d\u306e\u3082\u306e\u3067\u306f\u306a\u3044\u3067\u3059\uff09\u3002\n\u5ff5\u306e\u305f\u3081\u30aa\u30ea\u30b8\u30ca\u30eb\u306e winrm.rb \u3092 winrm.rb.org \u3068\u3044\u3046\u540d\u524d\u3067\u3068\u3063\u3066\u3044\u307e\u3059\u3002\n\n```\npushd /usr/local/share/gems/gems/specinfra-*/lib/specinfra/backend\nif [ ! -e winrm.rb.org ] ; then cp winrm.rb winrm.rb.org ; fi\ncat > winrm.rb << 'EOF'\nmodule Specinfra\n  module Backend\n    class Winrm < Base\n      include PowerShell::ScriptHelper\n\n      def os_info\n        { :family => 'windows', :release => nil, :arch => nil }\n      end\n\n      def run_command(cmd, opts={})\n        script = create_script(cmd)\n        winrm = get_config(:winrm)\n\n        shell = winrm.shell(:powershell)\n        result = shell.run(script)\n        stdout = result.stdout\n        stderr = result.stderr\n        exit_status = result.exitcode\n        shell.close\n\n        if @example\n          @example.metadata[:command] = script\n          @example.metadata[:stdout]  = stdout + stderr\n        end\n\n        CommandResult.new :stdout => stdout, :stderr => stderr, :exit_status => exit_status\n      end\n    end\n  end\nend\nEOF\npopd\n```\n\n\u3061\u306a\u307f\u306bspecinfra\u306egithub\u306f\u4ee5\u4e0b\u3067\u3059\u304c\u3001\u30d5\u30a3\u30fc\u30c9\u30d0\u30c3\u30af\u3059\u308b\u306e\u304c\u624b\u9593\u306a\u306e\u3067\u89aa\u5207\u306a\u65b9\u304c\u3044\u308c\u3070\u662f\u975e\u30fb\u30fb\nhttps://github.com/mizzy/specinfra\n\n\n\u3068\u306f\u3044\u3048\u30012016\u5e74\u306f\u3058\u3081\u3050\u3089\u3044\u306bgem/WinRM\u304c\u8a8d\u8a3c\u30d7\u30ed\u30c8\u30b3\u30eb\u3068\u3057\u3066:negotiate\u306b\u5bfe\u5fdc\u3057\u59cb\u3081\u305f\u306e\u3067\u3059\u304c\u3001\u3053\u306e\u304a\u304b\u3052\u3067Windows\u5074\u306bHTTPS/basic\u8a8d\u8a3c\u3092\u6709\u52b9\u306b\u3059\u308b\u3068\u304b\u306e\u624b\u9593\u304c\u8981\u3089\u306a\u304f\u306a\u3063\u3066\u304a\u308a\u3001\u3053\u308c\u304c\u305d\u308c\u306a\u308a\u306b\u3059\u3070\u3089\u3057\u3044\u3002\n\u3053\u306e\u8fba\u306fAnsible\u306e\u305f\u3081\u306bpython/winrm\u3067\u3082\u65e9\u304f\u5b9f\u88c5\u3057\u3066\u304f\u308c\u308c\u3070\u3068\u3001\n"}