{"context": "\u30b9\u30b3\u30fc\u30d7\uff1a\u30b5\u30a4\u30c8\u306e\u30ab\u30b9\u30bf\u30e0\u30a2\u30af\u30b7\u30e7\u30f3\u3068\u3057\u3066\u767b\u9332\u3057\u307e\u3059\u3002\nvar custScriptLinkDescription = '(\u30ab\u30b9\u30bf\u30e0\u30a2\u30af\u30b7\u30e7\u30f3\u540d\u3092\u8b58\u5225\u3059\u308b\u305f\u3081\u306e\u4e00\u610f\u306e\u6587\u5b57\u5217)';\nvar custScriptLinkPath = '\u30b9\u30af\u30ea\u30d7\u30c8\u30ea\u30f3\u30af\u3067\u8aad\u307f\u8fbc\u3080\u30b9\u30af\u30ea\u30d7\u30c8\u30d5\u30a1\u30a4\u30eb\u306e\u30d1\u30b9\uff08/\u3067\u59cb\u307e\u308b\u30b5\u30a4\u30c8\u76f8\u5bfe\u30d1\u30b9\uff09';\n\n\n// \u30b3\u30f3\u30c6\u30ad\u30b9\u30c8\u53d6\u5f97\nvar custCtx = SP.ClientContext.get_current();\n\n// \u30b5\u30a4\u30c8 \u30ab\u30b9\u30bf\u30e0\u30a2\u30af\u30b7\u30e7\u30f3\u53d6\u5f97\u6307\u793a\nvar custActions = custCtx.get_web().get_userCustomActions();\n\n// \u30b5\u30a4\u30c8 \u30ab\u30b9\u30bf\u30e0\u30a2\u30af\u30b7\u30e7\u30f3\u53d6\u5f97\u4e88\u7d04\ncustCtx.load(custActions, 'Include(Description, Location)');\n\n// \u30b5\u30fc\u30d0\u30fc\u3078\u306e\u30af\u30a8\u30ea\u30fc\u5b9f\u884c\uff08\u3053\u3053\u307e\u3067\u306e\u30b3\u30f3\u30c6\u30ad\u30b9\u30c8\u306b\u542b\u307e\u308c\u308b\u6307\u793a\u4e88\u7d04\u3092\u9001\u4fe1\uff09\ncustCtx.executeQueryAsync(\n    function (sender, args) { // \u30af\u30a8\u30ea\u30fc\u5b9f\u884c\u6642\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u51e6\u7406\n\n        // \u4e00\u5ea6\u6307\u5b9a\u3055\u308c\u305f Description \u306e\u30ab\u30b9\u30bf\u30e0\u30a2\u30af\u30b7\u30e7\u30f3\u3092\u30af\u30ea\u30fc\u30f3\u30ca\u30c3\u30d7\u3059\u308b --------------------------\n\n        // \u65e2\u5b58\u306e\u30ab\u30b9\u30bf\u30e0\u30a2\u30af\u30b7\u30e7\u30f3\u6570\u3092\u53d6\u5f97\n        var cntCustomAction = custActions.get_count();\n        if (cntCustomAction > 0) {\n            // \u65e2\u5b58\u306e\u30ab\u30b9\u30bf\u30e0\u30a2\u30af\u30b7\u30e7\u30f3\u304c\u3042\u308b\u5834\u5408\n            console.log(cntCustomAction + ' custom actions exists.');\n\n            var deletingActions = []; // \u524a\u9664\u5bfe\u8c61\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u4fdd\u6301\u7528\u914d\u5217\n\n            var actionEnumerator = custActions.getEnumerator();\n            while (actionEnumerator.moveNext()) {\n                var action = actionEnumerator.get_current();\n\n                if (action.get_description() == custScriptLinkDescription) {\n                    // description \u304c\u540c\u3058\u5834\u5408\n                    console.log('Custom action \"' + action.get_description() + '\" will be deleted.');\n\n                    // \u524a\u9664\u5bfe\u8c61\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u4fdd\u6301\u7528\u914d\u5217\u306b\u8ffd\u52a0\n                    deletingActions.push(action);\n\n                } else {\n                    console.log('Custom action \"' + action.get_description() + '\" is not target.');\n                }\n            }\n            for (var delAction in deletingActions) {\n\n                // \u524a\u9664\u5bfe\u8c61\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u4fdd\u6301\u7528\u914d\u5217\u306e\u8981\u7d20\u306b\u5bfe\u3057\u3066\u3001\u524a\u9664\u5b9f\u884c\uff08Enumerator\u3067\u56de\u3057\u3066\u3044\u308b\u9593\u306f\u524a\u9664\u3067\u304d\u306a\u3044\u305f\u3081\uff09\n                deletingActions[delAction].deleteObject();\n\n            }\n        } else {\n            console.log('Any custom actions not exists.');\n        }\n\n\n        // \u30ab\u30b9\u30bf\u30e0\u30a2\u30af\u30b7\u30e7\u30f3(ScriptLink)\u8ffd\u52a0 ---------------------------------------------------------------------\n        var newAction = custActions.add();\n        newAction.set_location('ScriptLink');\n        newAction.set_description(custScriptLinkDescription);\n        newAction.set_sequence(0);\n        newAction.set_scriptBlock(\n            \"var pathCustomScript\" + custScriptLinkDescription + \" = '\" + (_spPageContextInfo.webAbsoluteUrl + custScriptLinkPath) + \"?ver=' + (new Date()).toISOString().replace(/-|:|\\./g,'');\" + \"\\r\"\n            + \"var scriptCSForAnswer = document.createElement('SCRIPT');\" + \"\\r\"\n            + \"scriptCSForAnswer.src = pathCustomScript\" + custScriptLinkDescription + \";\" + \"\\r\"\n            + \"scriptCSForAnswer.type = 'text/javascript';\" + \"\\r\"\n            + \"document.getElementsByTagName('head')[0].appendChild(scriptCSForAnswer);\" + \"\\r\"\n        );\n        newAction.update();\n        console.log('custom action will install.');\n\n        custCtx.executeQueryAsync(\n            function (sender, args) { // \u30af\u30a8\u30ea\u30fc\u5b9f\u884c\u6642\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u51e6\u7406\n                console.log('Add(delete) complete!');\n            },\n            function (sender, args) { // \u30af\u30a8\u30ea\u30fc\u5931\u6557\u6642\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u51e6\u7406\n                console.log('Add(delete) action failed. ' + args.get_message() + '\\n' + args.get_stackTrace());\n            }\n        );\n    },\n    function (sender, args) { // \u30af\u30a8\u30ea\u30fc\u5931\u6557\u6642\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u51e6\u7406\n        console.log('Get actions failed. ' + args.get_message() + '\\n' + args.get_stackTrace());\n    }\n);\n\n\u30b9\u30b3\u30fc\u30d7\uff1a\u30b5\u30a4\u30c8\u306e\u30ab\u30b9\u30bf\u30e0\u30a2\u30af\u30b7\u30e7\u30f3\u3068\u3057\u3066\u767b\u9332\u3057\u307e\u3059\u3002\n\n```javascript\nvar custScriptLinkDescription = '(\u30ab\u30b9\u30bf\u30e0\u30a2\u30af\u30b7\u30e7\u30f3\u540d\u3092\u8b58\u5225\u3059\u308b\u305f\u3081\u306e\u4e00\u610f\u306e\u6587\u5b57\u5217)';\nvar custScriptLinkPath = '\u30b9\u30af\u30ea\u30d7\u30c8\u30ea\u30f3\u30af\u3067\u8aad\u307f\u8fbc\u3080\u30b9\u30af\u30ea\u30d7\u30c8\u30d5\u30a1\u30a4\u30eb\u306e\u30d1\u30b9\uff08/\u3067\u59cb\u307e\u308b\u30b5\u30a4\u30c8\u76f8\u5bfe\u30d1\u30b9\uff09';\n\n\n// \u30b3\u30f3\u30c6\u30ad\u30b9\u30c8\u53d6\u5f97\nvar custCtx = SP.ClientContext.get_current();\n\n// \u30b5\u30a4\u30c8 \u30ab\u30b9\u30bf\u30e0\u30a2\u30af\u30b7\u30e7\u30f3\u53d6\u5f97\u6307\u793a\nvar custActions = custCtx.get_web().get_userCustomActions();\n\n// \u30b5\u30a4\u30c8 \u30ab\u30b9\u30bf\u30e0\u30a2\u30af\u30b7\u30e7\u30f3\u53d6\u5f97\u4e88\u7d04\ncustCtx.load(custActions, 'Include(Description, Location)');\n\n// \u30b5\u30fc\u30d0\u30fc\u3078\u306e\u30af\u30a8\u30ea\u30fc\u5b9f\u884c\uff08\u3053\u3053\u307e\u3067\u306e\u30b3\u30f3\u30c6\u30ad\u30b9\u30c8\u306b\u542b\u307e\u308c\u308b\u6307\u793a\u4e88\u7d04\u3092\u9001\u4fe1\uff09\ncustCtx.executeQueryAsync(\n    function (sender, args) { // \u30af\u30a8\u30ea\u30fc\u5b9f\u884c\u6642\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u51e6\u7406\n\n        // \u4e00\u5ea6\u6307\u5b9a\u3055\u308c\u305f Description \u306e\u30ab\u30b9\u30bf\u30e0\u30a2\u30af\u30b7\u30e7\u30f3\u3092\u30af\u30ea\u30fc\u30f3\u30ca\u30c3\u30d7\u3059\u308b --------------------------\n\n        // \u65e2\u5b58\u306e\u30ab\u30b9\u30bf\u30e0\u30a2\u30af\u30b7\u30e7\u30f3\u6570\u3092\u53d6\u5f97\n        var cntCustomAction = custActions.get_count();\n        if (cntCustomAction > 0) {\n            // \u65e2\u5b58\u306e\u30ab\u30b9\u30bf\u30e0\u30a2\u30af\u30b7\u30e7\u30f3\u304c\u3042\u308b\u5834\u5408\n            console.log(cntCustomAction + ' custom actions exists.');\n\n            var deletingActions = []; // \u524a\u9664\u5bfe\u8c61\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u4fdd\u6301\u7528\u914d\u5217\n\n            var actionEnumerator = custActions.getEnumerator();\n            while (actionEnumerator.moveNext()) {\n                var action = actionEnumerator.get_current();\n\n                if (action.get_description() == custScriptLinkDescription) {\n                    // description \u304c\u540c\u3058\u5834\u5408\n                    console.log('Custom action \"' + action.get_description() + '\" will be deleted.');\n\n                    // \u524a\u9664\u5bfe\u8c61\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u4fdd\u6301\u7528\u914d\u5217\u306b\u8ffd\u52a0\n                    deletingActions.push(action);\n\n                } else {\n                    console.log('Custom action \"' + action.get_description() + '\" is not target.');\n                }\n            }\n            for (var delAction in deletingActions) {\n\n                // \u524a\u9664\u5bfe\u8c61\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u4fdd\u6301\u7528\u914d\u5217\u306e\u8981\u7d20\u306b\u5bfe\u3057\u3066\u3001\u524a\u9664\u5b9f\u884c\uff08Enumerator\u3067\u56de\u3057\u3066\u3044\u308b\u9593\u306f\u524a\u9664\u3067\u304d\u306a\u3044\u305f\u3081\uff09\n                deletingActions[delAction].deleteObject();\n\n            }\n        } else {\n            console.log('Any custom actions not exists.');\n        }\n\n\n        // \u30ab\u30b9\u30bf\u30e0\u30a2\u30af\u30b7\u30e7\u30f3(ScriptLink)\u8ffd\u52a0 ---------------------------------------------------------------------\n        var newAction = custActions.add();\n        newAction.set_location('ScriptLink');\n        newAction.set_description(custScriptLinkDescription);\n        newAction.set_sequence(0);\n        newAction.set_scriptBlock(\n            \"var pathCustomScript\" + custScriptLinkDescription + \" = '\" + (_spPageContextInfo.webAbsoluteUrl + custScriptLinkPath) + \"?ver=' + (new Date()).toISOString().replace(/-|:|\\./g,'');\" + \"\\r\"\n            + \"var scriptCSForAnswer = document.createElement('SCRIPT');\" + \"\\r\"\n            + \"scriptCSForAnswer.src = pathCustomScript\" + custScriptLinkDescription + \";\" + \"\\r\"\n            + \"scriptCSForAnswer.type = 'text/javascript';\" + \"\\r\"\n            + \"document.getElementsByTagName('head')[0].appendChild(scriptCSForAnswer);\" + \"\\r\"\n        );\n        newAction.update();\n        console.log('custom action will install.');\n\n        custCtx.executeQueryAsync(\n            function (sender, args) { // \u30af\u30a8\u30ea\u30fc\u5b9f\u884c\u6642\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u51e6\u7406\n                console.log('Add(delete) complete!');\n            },\n            function (sender, args) { // \u30af\u30a8\u30ea\u30fc\u5931\u6557\u6642\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u51e6\u7406\n                console.log('Add(delete) action failed. ' + args.get_message() + '\\n' + args.get_stackTrace());\n            }\n        );\n    },\n    function (sender, args) { // \u30af\u30a8\u30ea\u30fc\u5931\u6557\u6642\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u51e6\u7406\n        console.log('Get actions failed. ' + args.get_message() + '\\n' + args.get_stackTrace());\n    }\n);\n```\n", "tags": ["SharePoint", "CSOM", "JavaScript"]}