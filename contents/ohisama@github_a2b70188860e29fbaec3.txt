{"context": " More than 1 year has passed since last update.\n\n\u6982\u8981\narduino uno\u3067\u30d5\u30a3\u30fc\u30c9\u30d0\u30c3\u30af\u5236\u5fa1\u3092\u3084\u3063\u3066\u307f\u305f\u3002\n\n\u5199\u771f\n\n\n\u52d5\u753b\nhttps://www.youtube.com/watch?v=CM772ZaE47s\n\n\u56de\u8def\u56f3\n\n\n\u30b5\u30f3\u30d7\u30eb\u30b3\u30fc\u30c9\n#include <SPI.h>\n#include <L3GD20.h>\n#include <PID_v1.h>\n\nunsigned long time;\nL3GD20 gyro(10);\nfloat dc_offsetY = 0;\nfloat rateY;\nfloat prev_rateY = 0;\nfloat angleY = 0;\nint sampleTime = 10;\ndouble Setpoint = 0;\ndouble Input = 0;\ndouble Output = 0;\nint rec[10];\nPID robo(&Input, &Output, &Setpoint, 200.0, 50.0, 30.0, REVERSE);\nvoid setup()\n{\n    int sampleNum = 1024;\n    int X, Y, Z;\n    float x, y, z;\n    Serial.begin(115200);\n    pinMode(4, OUTPUT);\n    pinMode(7, OUTPUT);\n    Setpoint = 250.0;\n    robo.SetOutputLimits(-255.0, 255.0);\n    robo.SetSampleTime(sampleTime);\n    robo.SetMode(AUTOMATIC);\n    Serial.print(\" start\\t\");\n    gyro.begin();\n    Serial.println(\" ok!\");\n    for (int n = 0; n < sampleNum; n++)\n    {\n        Y = gyro.read(L3GD20_Y_H);\n        y = (Y << 8) | gyro.read(L3GD20_Y_L);\n        dc_offsetY += y;\n    }\n    dc_offsetY = dc_offsetY / sampleNum;\n    Serial.print(\" Y: \");\n    Serial.print(dc_offsetY);\n    for (int i = 0 ; i < 10 ; i++)\n    {\n        rec[i] = 0;\n    }\n}\nvoid loop()\n{\n    int X, Y, Z;\n    float x, y, z;\n    int count;\n    int i;\n    if (millis() - time >= sampleTime)\n    {\n        time = millis();\n        Y = gyro.read(L3GD20_Y_H);\n        y = (Y << 8) | gyro.read(L3GD20_Y_L);\n        rateY = (y - dc_offsetY) / 100;\n        angleY += ((float) (prev_rateY + rateY) * sampleTime) / 2000;\n        rec[0] = rateY - prev_rateY;\n        prev_rateY = rateY;\n        if (angleY < 0)\n        {\n            angleY += 360;\n        }\n        else if (angleY >= 360)\n        {\n            angleY -= 360;\n        }\n        count = 0;\n        for (i = 0; i < 10; i++)\n        {\n            if (abs(rec[i]) < 1)\n            {\n                 count++;\n            }\n        }\n        if (count > 9)\n        {\n            Setpoint = angleY;\n            Serial.print(Setpoint);\n            Serial.println(\" setpoint\");\n        }\n        for (i = 9; i > 0; i--)\n        {\n            rec[i] = rec[i - 1];\n        }\n        Input = angleY;\n        if (robo.Compute())\n        {\n        }\n        else\n        {\n            Serial.print(\" ng \");\n        }\n        int speed = Output;\n        if (speed > 0)\n        {\n            digitalWrite(4, HIGH);\n            analogWrite(5, 256 - speed);\n            analogWrite(6, 256 - speed);\n            digitalWrite(7, HIGH);\n        }\n        else\n        {\n            digitalWrite(4, LOW);\n            analogWrite(5, -speed);\n            analogWrite(6, -speed);\n            digitalWrite(7, LOW);\n        }\n    }\n}\n\n#\u6982\u8981\narduino uno\u3067\u30d5\u30a3\u30fc\u30c9\u30d0\u30c3\u30af\u5236\u5fa1\u3092\u3084\u3063\u3066\u307f\u305f\u3002\n\n#\u5199\u771f\n![MVC-017S.JPG](https://qiita-image-store.s3.amazonaws.com/0/18104/b13f0e03-9021-6e15-c31c-6381e80b5ea1.jpeg)\n#\u52d5\u753b\nhttps://www.youtube.com/watch?v=CM772ZaE47s\n#\u56de\u8def\u56f3\n![robo3.JPG](https://qiita-image-store.s3.amazonaws.com/0/18104/74fa76e1-7f4e-68c5-3932-db1997674aec.jpeg)\n#\u30b5\u30f3\u30d7\u30eb\u30b3\u30fc\u30c9\n```\n#include <SPI.h>\n#include <L3GD20.h>\n#include <PID_v1.h>\n\nunsigned long time;\nL3GD20 gyro(10);\nfloat dc_offsetY = 0;\nfloat rateY;\nfloat prev_rateY = 0;\nfloat angleY = 0;\nint sampleTime = 10;\ndouble Setpoint = 0;\ndouble Input = 0;\ndouble Output = 0;\nint rec[10];\nPID robo(&Input, &Output, &Setpoint, 200.0, 50.0, 30.0, REVERSE);\nvoid setup()\n{\n\tint sampleNum = 1024;\n\tint X, Y, Z;\n\tfloat x, y, z;\n\tSerial.begin(115200);\n\tpinMode(4, OUTPUT);\n\tpinMode(7, OUTPUT);\n\tSetpoint = 250.0;\n\trobo.SetOutputLimits(-255.0, 255.0);\n\trobo.SetSampleTime(sampleTime);\n\trobo.SetMode(AUTOMATIC);\n\tSerial.print(\" start\\t\");\n\tgyro.begin();\n\tSerial.println(\" ok!\");\n\tfor (int n = 0; n < sampleNum; n++)\n\t{\n\t\tY = gyro.read(L3GD20_Y_H);\n\t\ty = (Y << 8) | gyro.read(L3GD20_Y_L);\n\t\tdc_offsetY += y;\n\t}\n\tdc_offsetY = dc_offsetY / sampleNum;\n\tSerial.print(\" Y: \");\n\tSerial.print(dc_offsetY);\n\tfor (int i = 0 ; i < 10 ; i++)\n\t{\n\t\trec[i] = 0;\n\t}\n}\nvoid loop()\n{\n\tint X, Y, Z;\n\tfloat x, y, z;\n\tint count;\n\tint i;\n\tif (millis() - time >= sampleTime)\n\t{\n\t\ttime = millis();\n\t\tY = gyro.read(L3GD20_Y_H);\n\t\ty = (Y << 8) | gyro.read(L3GD20_Y_L);\n\t\trateY = (y - dc_offsetY) / 100;\n\t\tangleY += ((float) (prev_rateY + rateY) * sampleTime) / 2000;\n\t\trec[0] = rateY - prev_rateY;\n\t\tprev_rateY = rateY;\n\t\tif (angleY < 0)\n\t\t{\n\t\t\tangleY += 360;\n\t\t}\n\t\telse if (angleY >= 360)\n\t\t{\n\t\t\tangleY -= 360;\n\t\t}\n\t\tcount = 0;\n\t\tfor (i = 0; i < 10; i++)\n\t\t{\n\t\t\tif (abs(rec[i]) < 1)\n\t\t\t{\n\t\t\t\t count++;\n\t\t\t}\n\t\t}\n\t\tif (count > 9)\n\t\t{\n\t\t\tSetpoint = angleY;\n\t\t\tSerial.print(Setpoint);\n\t\t\tSerial.println(\" setpoint\");\n\t\t}\n\t\tfor (i = 9; i > 0; i--)\n\t\t{\n\t\t\trec[i] = rec[i - 1];\n\t\t}\n\t\tInput = angleY;\n\t\tif (robo.Compute())\n\t\t{\n\t\t}\n\t\telse\n\t\t{\n\t\t\tSerial.print(\" ng \");\n\t\t}\n\t\tint speed = Output;\n\t\tif (speed > 0)\n\t\t{\n\t\t\tdigitalWrite(4, HIGH);\n\t\t\tanalogWrite(5, 256 - speed);\n\t\t\tanalogWrite(6, 256 - speed);\n\t\t\tdigitalWrite(7, HIGH);\n\t\t}\n\t\telse\n\t\t{\n\t\t\tdigitalWrite(4, LOW);\n\t\t\tanalogWrite(5, -speed);\n\t\t\tanalogWrite(6, -speed);\n\t\t\tdigitalWrite(7, LOW);\n\t\t}\n\t}\n}\n```\n\n", "tags": ["Arduino", "L3GD20", "SPI", "PID"]}