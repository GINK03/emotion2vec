{"context": "\nWifi\u63a5\u7d9a\u53ef\u80fd\u306aIoT\u30c7\u30d0\u30a4\u30b9\u3068\u3057\u3066\u306f\u7834\u683c\u5024\u306e\u3001Amazon Dash Button\u3002(500\u5186\u4e5f)\n\u300c\u3053\u308c\u3092\u3001\u305f\u3060\u306eIoT\u30dc\u30bf\u30f3\u3068\u3057\u3066\u4f7f\u3063\u3066\u307f\u305f\u3044\u3002\u300d\n\u3075\u3064\u3075\u3064\u3068\u8fbc\u307f\u4e0a\u3052\u308b\u601d\u3044\u3092\u5f62\u306b\u3059\u3079\u304f\u3001Web\u3067\u4e0b\u8abf\u3079\u3092\u59cb\u3081\u305f\u3068\u3053\u308d\u3001\nnode\u3084ruby\u7528\u306e\u30e9\u30a4\u30d6\u30e9\u30ea\u3092\u4f7f\u3063\u3066\u30cf\u30c3\u30af\u3055\u308c\u3066\u3044\u308b\u65b9\u304c\u3044\u308b\u3088\u3046\u3067\u3057\u305f\u3002\n[\u53c2\u7167]\nAmazon Dash Button\u306e\u4ed5\u7d44\u307f\u3068\u30cf\u30c3\u30af\nAmazon Dash Button\u3092(\u6b63\u3057\u304f\u306a\u3044\u65b9\u5411\u3067)\u4f7f\u3063\u3066\u307f\u305f\nTCP/IP - DHCP\n\u52d5\u4f5c\u539f\u7406\u3092\u898b\u308b\u9650\u308a\u3001Linux\u6a19\u6e96\u6a5f\u80fd\u3067\u5b9f\u88c5\u3067\u304d\u305d\u3046\u306a\u70ba\u3068\u308a\u3042\u3048\u305a\u3084\u3063\u3066\u307f\u307e\u3059\u3002\n[\u74b0\u5883]\nIoT\u30dc\u30bf\u30f3:\nAmazon Dash Button(Wilkinson)\n\u30d5\u30c3\u30af\u30b5\u30fc\u30d0:\n HW) Raspberry Pi 2 Model B\n OS) Raspbian GNU/Linux 8 (jessie)\n MW) rsyslog 8.4.2\n[\u52d5\u4f5c\u6982\u8981]\nAmazon\u30c0\u30c3\u30b7\u30e5\u30dc\u30bf\u30f3\u306f\u62bc\u4e0b\u3059\u308b\u4e8b\u3067Wifi\u306b\u63a5\u7d9a\u3057\u3001DHCP\u30c7\u30a3\u30b9\u30ab\u30d0\u30fc\u30ea\u30af\u30a8\u30b9\u30c8\u3092\u6295\u3052\u307e\u3059\u3002\n\u305d\u3053\u3067\u540c\u3058LAN\u5185\u306b\u3001\u3053\u306e\u30d6\u30ed\u30fc\u30c9\u30ad\u30e3\u30b9\u30c8\u30d1\u30b1\u30c3\u30c8\u3092\u53d7\u3051\u53d6\u308b\u30b5\u30fc\u30d0\u3092\u8a2d\u7f6e\u3057\n\u7279\u5b9aMAC\u30a2\u30c9\u30ec\u30b9\u304b\u3089\u306e\u30d1\u30b1\u30c3\u30c8\u53d7\u4fe1\u3092\u30c8\u30ea\u30ac\u3068\u3057\u3066\u597d\u304d\u306a\u51e6\u7406\u3092\u5b9f\u884c\u3001\n\u3068\u3044\u3046\u306e\u304c\u5927\u307e\u304b\u6d41\u308c\u3067\u3059\u3002\n\u30c0\u30c3\u30b7\u30e5\u30dc\u30bf\u30f3\u62bc\u4e0b(DHCP\u30c7\u30a3\u30b9\u30ab\u30d0\u30fc)\n\u3000 -> \u30d5\u30c3\u30af\u30b5\u30fc\u30d0/iptables -> syslog -> fifo <-> shell script\n[\u524d\u6e96\u5099]\n1.Amazon\u30c0\u30c3\u30b7\u30e5\u30dc\u30bf\u30f3\u3092\u3001Wifi\u306b\u7e4b\u3052\u308b\u3002\n(\u4e0b\u8a18URL\u3092\u53c2\u8003\u306b\u8a2d\u5b9a\u3092\u9032\u3081\u308b\u3002\u5546\u54c1\u9078\u629e\u524d\u306b\u30ad\u30e3\u30f3\u30bb\u30eb\u3059\u308b\u306e\u304c\u30dd\u30a4\u30f3\u30c8)\nAmazon Dash Button\u3092\u305f\u3060\u306eIoT\u30dc\u30bf\u30f3\u3068\u3057\u3066\u4f7f\u3046\n2.\u30c0\u30c3\u30b7\u30e5\u30dc\u30bf\u30f3\u306eMAC\u30a2\u30c9\u30ec\u30b9\u3092\u78ba\u8a8d\u3059\u308b\n# tcpdump -i wlan0 | grep BOOTP/DHCP \u203b\u3053\u3053\u3067\u30c0\u30c3\u30b7\u30e5\u30dc\u30bf\u30f3\u3092\u62bc\u4e0b\u3002\ntcpdump: verbose output suppressed, use -v or -vv for full protocol decode\nlistening on wlan0, link-type EN10MB (Ethernet), capture size 262144 bytes\n19:06:55.729394 IP 0.0.0.0.bootpc > 255.255.255.255.bootps: BOOTP/DHCP, Request from ac:63:be:98:xx:xx (oui Unknown), length 261\n^C172 packets captured\n180 packets received by filter\n0 packets dropped by kernel\n\n\u203b\u4f8b\u3067\u306f\u3001wlan0\u304c\u30c0\u30c3\u30b7\u30e5\u30dc\u30bf\u30f3\u3068\u540c\u4e00\u306eNW\u306b\u3064\u306a\u304c\u308b\u30a4\u30f3\u30bf\u30d5\u30a7\u30fc\u30b9\n\u203b\u300cac:63:be:98:xx:xx\u300d\u304c\u672c\u6a5f\u5668\u306eMac\u30a2\u30c9\u30ec\u30b9\n\n[\u8a2d\u5b9a]\n\u30fbiptables\u306e\u8a2d\u5b9a\n# iptables -I INPUT -i wlan0 -p udp --dport 67 -m mac --mac-source ac:63:be:98:xx:xx -j LOG --log-level=debug\n\n\u203biptables\u306esyslog facility\u306fkern\u56fa\u5b9a\u306a\u306e\u3067\u3001priority\u3092\u5909\u66f4\u3057\u3001kern.debug\u3068\u3057\u3066syslog\u3078\u6e21\u3059\u3002\n\n# iptables -nvL\nChain INPUT (policy ACCEPT 966 packets, 123K bytes)\n pkts bytes target     prot opt in     out     source               destination\n    1   289 LOG        udp  --  wlan0  *       0.0.0.0/0            0.0.0.0/0            udp dpt:67 MAC AC:63:BE:98:xx:xx LOG flags 0 level 7\n~\u4ee5\u4e0b\u7565~\n\n\u203b\u53cd\u6620\u78ba\u8a8d\n\n# vi /etc/rc.local\n\n\nrc.local\niptables -I INPUT -i wlan0 -p udp --dport 67 -m mac --mac-source ac:63:be:98:xx:xx -j LOG --log-level=debug\n\n\u203b\u518d\u8d77\u52d5\u3059\u308b\u3068\u6d88\u3048\u308b\u306e\u3067\u3001\u3068\u308a\u3042\u3048\u305arc.local\u306b\u66f8\u3044\u3066\u304a\u304f\u3002\n\u203bexit 0\u306e\u524d\u306b\u4e0a\u8a18iptables\u8a2d\u5b9a\u3092\u8ffd\u8a18\u3002\u30a4\u30f3\u30bf\u30d5\u30a7\u30fc\u30b9\u540d\u306f\u74b0\u5883\u306e\u5fdc\u3058\u9069\u5b9c\u5909\u66f4\u3002\n\n\n\u30fbrsyslog\u8a2d\u5b9a\n# cp -p /etc/rsyslog.conf{,.orig}\n# vi /etc/rsyslog.conf\n# diff /etc/rsyslog.conf{.orig,}\n65c65\n< kern.*                        -/var/log/kern.log\n---\n> kern.*;kern.!=debug           -/var/log/kern.log\n90c90\n<       news.none;mail.none     -/var/log/debug\n---\n>       news.none;mail.none;kern.none   -/var/log/debug\n121a122\n> kern.=debug                   |/var/log/dash.fifo\n\n\u203brsyslog.conf\u3078kern.debug\u306e\u8a2d\u5b9a\u3092\u8ffd\u52a0\u3002\n\u304a\u3088\u3073\u300ckern.debug\u300d\u3092kern.*/*.debug\u306e\u51e6\u7406\u304b\u3089\u9664\u5916\n\u203bkern.debug\u5b9b\u306e\u30ed\u30b0\u304c\u6765\u305f\u3089\u3001\u540d\u524d\u4ed8\u304d\u30d1\u30a4\u30d7/var/log/dash.fifo\u306b\u6e21\u3059\n\n\u30fb\u540d\u524d\u4ed8\u304d\u30d1\u30a4\u30d7\u306e\u4f5c\u6210\n# mkfifo -m 600 /var/log/dash.fifo\n\n\u30fb\u540d\u524d\u4ed8\u304d\u30d1\u30a4\u30d7\u76e3\u8996\u30b9\u30af\u30ea\u30d7\u30c8\u306e\u4f5c\u6210\n# mkdir -p /root/dash_button\n# vi /root/dash_button/check_fifo.sh\n\n\ncheck_fifo.sh\n#!/bin/sh\n\nPID='check_fifo.pid'\n\ntrap 'echo check_fifo process was terminated.;rm -f /var/run/$PID' INT TERM\necho $$ > /var/run/$PID\n\nwhile read log; do\n    sh -c '/root/dash_button/dash_button.sh > /dev/null 2>&1 &'\ndone < /var/log/dash.fifo\n\n\n# chmod u+x /root/sh/check_fifo.sh\n# /bin/sh -c '/root/dash_button/check_fifo.sh &'\n# vi /etc/rc.local\n\n\nrc.local\n/bin/sh -c '/root/dash_button/check_fifo.sh &'\n\u203bexit 0\u306e\u524d\u306b\u8ffd\u8a18\n\n\n\u30fb\u4efb\u610f\u306e\u51e6\u7406\u3092\u3055\u305b\u308b\u30b9\u30af\u30ea\u30d7\u30c8\u306e\u4f5c\u6210\n# vi /root/dash_button/dash_button.sh\n\n\ndash_button.sh\n#!/bin/sh\n\ntouch /tmp/hoge\n\n\n\u3053\u3053\u306b\u597d\u304d\u306a\u51e6\u7406\u3092\u66f8\u304d\u307e\u3059\u3002\n\u79c1\u306f\u30dc\u30bf\u30f3\u3092\u62bc\u3059\u3053\u3068\u3067\u3001\u8077\u5834\u306eIRC\u3078\u51fa\u52e4/\u9000\u52e4\u6328\u62f6\u3092\u66f8\u304d\u8fbc\u3080\u30b9\u30af\u30ea\u30d7\u30c8\u306b\u3057\u3066\u307e\u3059\u3002\n\u3042\u3068\u76e3\u8996\u30d7\u30ed\u30bb\u30b9\u81ea\u4f53\u306f\u3001monit\u3067\u304a\u624b\u8efd\u30d7\u30ed\u30bb\u30b9\u76e3\u8996\u4e2d\u3002\n\u4ee5\u4e0a\n![20170112210610.jpg](https://qiita-image-store.s3.amazonaws.com/0/145528/9a37d7dc-e71e-304e-7601-d9251b82b142.jpeg)\n\n\nWifi\u63a5\u7d9a\u53ef\u80fd\u306aIoT\u30c7\u30d0\u30a4\u30b9\u3068\u3057\u3066\u306f\u7834\u683c\u5024\u306e\u3001Amazon Dash Button\u3002(500\u5186\u4e5f)\n\n**\u300c\u3053\u308c\u3092\u3001\u305f\u3060\u306eIoT\u30dc\u30bf\u30f3\u3068\u3057\u3066\u4f7f\u3063\u3066\u307f\u305f\u3044\u3002\u300d**\n\n\u3075\u3064\u3075\u3064\u3068\u8fbc\u307f\u4e0a\u3052\u308b\u601d\u3044\u3092\u5f62\u306b\u3059\u3079\u304f\u3001Web\u3067\u4e0b\u8abf\u3079\u3092\u59cb\u3081\u305f\u3068\u3053\u308d\u3001\nnode\u3084ruby\u7528\u306e\u30e9\u30a4\u30d6\u30e9\u30ea\u3092\u4f7f\u3063\u3066\u30cf\u30c3\u30af\u3055\u308c\u3066\u3044\u308b\u65b9\u304c\u3044\u308b\u3088\u3046\u3067\u3057\u305f\u3002\n\n**[\u53c2\u7167]**\n[Amazon Dash Button\u306e\u4ed5\u7d44\u307f\u3068\u30cf\u30c3\u30af](http://qiita.com/dkawashi/items/e6621c4b712b509c73ec)\n[Amazon Dash Button\u3092(\u6b63\u3057\u304f\u306a\u3044\u65b9\u5411\u3067)\u4f7f\u3063\u3066\u307f\u305f](http://qiita.com/takustaqu/items/8539b33780c9675c8657)\n[TCP/IP - DHCP](http://www.infraexpert.com/study/tcpip13.html)\n\n\u52d5\u4f5c\u539f\u7406\u3092\u898b\u308b\u9650\u308a\u3001Linux\u6a19\u6e96\u6a5f\u80fd\u3067\u5b9f\u88c5\u3067\u304d\u305d\u3046\u306a\u70ba\u3068\u308a\u3042\u3048\u305a\u3084\u3063\u3066\u307f\u307e\u3059\u3002\n\n**[\u74b0\u5883]**\nIoT\u30dc\u30bf\u30f3:\n[Amazon Dash Button(Wilkinson)](https://www.amazon.co.jp/dp/B01L2WQ27O/)\n\n\u30d5\u30c3\u30af\u30b5\u30fc\u30d0:\n HW) Raspberry Pi 2 Model B\n OS) Raspbian GNU/Linux 8 (jessie)\n MW) rsyslog 8.4.2\n\n**[\u52d5\u4f5c\u6982\u8981]**\nAmazon\u30c0\u30c3\u30b7\u30e5\u30dc\u30bf\u30f3\u306f\u62bc\u4e0b\u3059\u308b\u4e8b\u3067Wifi\u306b\u63a5\u7d9a\u3057\u3001DHCP\u30c7\u30a3\u30b9\u30ab\u30d0\u30fc\u30ea\u30af\u30a8\u30b9\u30c8\u3092\u6295\u3052\u307e\u3059\u3002\n\n\u305d\u3053\u3067\u540c\u3058LAN\u5185\u306b\u3001\u3053\u306e\u30d6\u30ed\u30fc\u30c9\u30ad\u30e3\u30b9\u30c8\u30d1\u30b1\u30c3\u30c8\u3092\u53d7\u3051\u53d6\u308b\u30b5\u30fc\u30d0\u3092\u8a2d\u7f6e\u3057\n\u7279\u5b9aMAC\u30a2\u30c9\u30ec\u30b9\u304b\u3089\u306e\u30d1\u30b1\u30c3\u30c8\u53d7\u4fe1\u3092\u30c8\u30ea\u30ac\u3068\u3057\u3066\u597d\u304d\u306a\u51e6\u7406\u3092\u5b9f\u884c\u3001\n\u3068\u3044\u3046\u306e\u304c\u5927\u307e\u304b\u6d41\u308c\u3067\u3059\u3002\n\n\u30c0\u30c3\u30b7\u30e5\u30dc\u30bf\u30f3\u62bc\u4e0b(DHCP\u30c7\u30a3\u30b9\u30ab\u30d0\u30fc)\n\u3000 -> \u30d5\u30c3\u30af\u30b5\u30fc\u30d0/iptables -> syslog -> fifo <-> shell script\n\n**[\u524d\u6e96\u5099]**\n1.Amazon\u30c0\u30c3\u30b7\u30e5\u30dc\u30bf\u30f3\u3092\u3001Wifi\u306b\u7e4b\u3052\u308b\u3002\n(\u4e0b\u8a18URL\u3092\u53c2\u8003\u306b\u8a2d\u5b9a\u3092\u9032\u3081\u308b\u3002\u5546\u54c1\u9078\u629e\u524d\u306b\u30ad\u30e3\u30f3\u30bb\u30eb\u3059\u308b\u306e\u304c\u30dd\u30a4\u30f3\u30c8)\n\n[Amazon Dash Button\u3092\u305f\u3060\u306eIoT\u30dc\u30bf\u30f3\u3068\u3057\u3066\u4f7f\u3046](http://qiita.com/jsoizo/items/3b8bba4160f41aef20f4)\n\n2.\u30c0\u30c3\u30b7\u30e5\u30dc\u30bf\u30f3\u306eMAC\u30a2\u30c9\u30ec\u30b9\u3092\u78ba\u8a8d\u3059\u308b\n\n```\n# tcpdump -i wlan0 | grep BOOTP/DHCP \u203b\u3053\u3053\u3067\u30c0\u30c3\u30b7\u30e5\u30dc\u30bf\u30f3\u3092\u62bc\u4e0b\u3002\ntcpdump: verbose output suppressed, use -v or -vv for full protocol decode\nlistening on wlan0, link-type EN10MB (Ethernet), capture size 262144 bytes\n19:06:55.729394 IP 0.0.0.0.bootpc > 255.255.255.255.bootps: BOOTP/DHCP, Request from ac:63:be:98:xx:xx (oui Unknown), length 261\n^C172 packets captured\n180 packets received by filter\n0 packets dropped by kernel\n\n\u203b\u4f8b\u3067\u306f\u3001wlan0\u304c\u30c0\u30c3\u30b7\u30e5\u30dc\u30bf\u30f3\u3068\u540c\u4e00\u306eNW\u306b\u3064\u306a\u304c\u308b\u30a4\u30f3\u30bf\u30d5\u30a7\u30fc\u30b9\n\u203b\u300cac:63:be:98:xx:xx\u300d\u304c\u672c\u6a5f\u5668\u306eMac\u30a2\u30c9\u30ec\u30b9\n```\n\n**[\u8a2d\u5b9a]**\n\u30fbiptables\u306e\u8a2d\u5b9a\n\n```\n# iptables -I INPUT -i wlan0 -p udp --dport 67 -m mac --mac-source ac:63:be:98:xx:xx -j LOG --log-level=debug\n\n\u203biptables\u306esyslog facility\u306fkern\u56fa\u5b9a\u306a\u306e\u3067\u3001priority\u3092\u5909\u66f4\u3057\u3001kern.debug\u3068\u3057\u3066syslog\u3078\u6e21\u3059\u3002\n```\n\n```\n# iptables -nvL\nChain INPUT (policy ACCEPT 966 packets, 123K bytes)\n pkts bytes target     prot opt in     out     source               destination\n    1   289 LOG        udp  --  wlan0  *       0.0.0.0/0            0.0.0.0/0            udp dpt:67 MAC AC:63:BE:98:xx:xx LOG flags 0 level 7\n~\u4ee5\u4e0b\u7565~\n\n\u203b\u53cd\u6620\u78ba\u8a8d\n```\n```\n# vi /etc/rc.local\n```\n```sh:rc.local\niptables -I INPUT -i wlan0 -p udp --dport 67 -m mac --mac-source ac:63:be:98:xx:xx -j LOG --log-level=debug\n\n\u203b\u518d\u8d77\u52d5\u3059\u308b\u3068\u6d88\u3048\u308b\u306e\u3067\u3001\u3068\u308a\u3042\u3048\u305arc.local\u306b\u66f8\u3044\u3066\u304a\u304f\u3002\n\u203bexit 0\u306e\u524d\u306b\u4e0a\u8a18iptables\u8a2d\u5b9a\u3092\u8ffd\u8a18\u3002\u30a4\u30f3\u30bf\u30d5\u30a7\u30fc\u30b9\u540d\u306f\u74b0\u5883\u306e\u5fdc\u3058\u9069\u5b9c\u5909\u66f4\u3002\n```\n\n\u30fbrsyslog\u8a2d\u5b9a\n\n```\n# cp -p /etc/rsyslog.conf{,.orig}\n# vi /etc/rsyslog.conf\n# diff /etc/rsyslog.conf{.orig,}\n65c65\n< kern.*                        -/var/log/kern.log\n---\n> kern.*;kern.!=debug           -/var/log/kern.log\n90c90\n<       news.none;mail.none     -/var/log/debug\n---\n>       news.none;mail.none;kern.none   -/var/log/debug\n121a122\n> kern.=debug                   |/var/log/dash.fifo\n\n\u203brsyslog.conf\u3078kern.debug\u306e\u8a2d\u5b9a\u3092\u8ffd\u52a0\u3002\n\u304a\u3088\u3073\u300ckern.debug\u300d\u3092kern.*/*.debug\u306e\u51e6\u7406\u304b\u3089\u9664\u5916\n\u203bkern.debug\u5b9b\u306e\u30ed\u30b0\u304c\u6765\u305f\u3089\u3001\u540d\u524d\u4ed8\u304d\u30d1\u30a4\u30d7/var/log/dash.fifo\u306b\u6e21\u3059\n```\n\n\u30fb\u540d\u524d\u4ed8\u304d\u30d1\u30a4\u30d7\u306e\u4f5c\u6210\n\n```\n# mkfifo -m 600 /var/log/dash.fifo\n```\n\n\u30fb\u540d\u524d\u4ed8\u304d\u30d1\u30a4\u30d7\u76e3\u8996\u30b9\u30af\u30ea\u30d7\u30c8\u306e\u4f5c\u6210\n\n```\n# mkdir -p /root/dash_button\n# vi /root/dash_button/check_fifo.sh\n```\n```sh:check_fifo.sh\n#!/bin/sh\n\nPID='check_fifo.pid'\n\ntrap 'echo check_fifo process was terminated.;rm -f /var/run/$PID' INT TERM\necho $$ > /var/run/$PID\n\nwhile read log; do\n    sh -c '/root/dash_button/dash_button.sh > /dev/null 2>&1 &'\ndone < /var/log/dash.fifo\n```\n```\n# chmod u+x /root/sh/check_fifo.sh\n# /bin/sh -c '/root/dash_button/check_fifo.sh &'\n# vi /etc/rc.local\n```\n```sh:rc.local\n/bin/sh -c '/root/dash_button/check_fifo.sh &'\n\u203bexit 0\u306e\u524d\u306b\u8ffd\u8a18\n```\n\n\u30fb\u4efb\u610f\u306e\u51e6\u7406\u3092\u3055\u305b\u308b\u30b9\u30af\u30ea\u30d7\u30c8\u306e\u4f5c\u6210\n\n```\n# vi /root/dash_button/dash_button.sh\n```\n```sh:dash_button.sh\n#!/bin/sh\n\ntouch /tmp/hoge\n```\n\n\u3053\u3053\u306b\u597d\u304d\u306a\u51e6\u7406\u3092\u66f8\u304d\u307e\u3059\u3002\n\u79c1\u306f\u30dc\u30bf\u30f3\u3092\u62bc\u3059\u3053\u3068\u3067\u3001\u8077\u5834\u306eIRC\u3078\u51fa\u52e4/\u9000\u52e4\u6328\u62f6\u3092\u66f8\u304d\u8fbc\u3080\u30b9\u30af\u30ea\u30d7\u30c8\u306b\u3057\u3066\u307e\u3059\u3002\n\n\u3042\u3068\u76e3\u8996\u30d7\u30ed\u30bb\u30b9\u81ea\u4f53\u306f\u3001[monit](https://mmonit.com/monit/)\u3067\u304a\u624b\u8efd\u30d7\u30ed\u30bb\u30b9\u76e3\u8996\u4e2d\u3002\n\n\u4ee5\u4e0a\n", "tags": ["AmazonDashButton", "iptables", "Linux", "Bash", "RaspberryPi"]}