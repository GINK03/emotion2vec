{"tags": ["Terraform"], "context": "\n\n\u306f\u3058\u3081\u306b\nTerraform\u3067\u30a4\u30f3\u30d5\u30e9\u69cb\u6210\u7ba1\u7406\u3092\u3057\u3066\u3044\u308b\u3068\u540c\u3058tf\u30d5\u30a1\u30a4\u30eb\u3092\u4f7f\u3044\u306a\u304c\u3089\u3082\u3001\u7279\u5b9a\u306e\u74b0\u5883\u3060\u3051\u306b\u4f5c\u308a\u305f\u3044\u30ea\u30bd\u30fc\u30b9\u304c\u51fa\u3066\u304f\u308b\u3053\u3068\u304c\u3042\u308a\u307e\u3059\u3002\n\u4f8b\u3048\u3070\u958b\u767a\u74b0\u5883\u306b\u306f\u793e\u5185\u304b\u3089\u306e\u30a2\u30af\u30bb\u30b9\u306e\u307f\u8a31\u53ef\u3059\u308b\u3001\u3068\u3044\u3063\u305f\u5177\u5408\u306b\u3067\u3059\u3002\nTerraform\u306b\u306fif\u306e\u3088\u3046\u306a\u6761\u4ef6\u5206\u5c90\u304c\u306a\u3044\u3082\u306e\u306e\u3001count\u3092\u4f7f\u3046\u3053\u3068\u3067\u4e0a\u8a18\u306e\u3053\u3068\u3092\u5b9f\u73fe\u3067\u304d\u307e\u3059\u3002\n\n\u30d9\u30fc\u30b9\u3068\u306a\u308btf\u30d5\u30a1\u30a4\u30eb\n\u4ee5\u4e0b\u306e3\u3064\u306etf\u30d5\u30a1\u30a4\u30eb\u3092\u30d9\u30fc\u30b9\u306b\u3057\u3066\u8aac\u660e\u3057\u307e\u3059\u3002\u306a\u304a\u5229\u7528\u3057\u305fTerraform\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u306fv0.8.4\u3067\u3059\u3002\n\nprovider.tf\nprovider \"aws\" {}\n\n\n\nvariables.tf\nvariable \"is_dev\" {\n  default = \"0\"\n}\n\n\n\nvm.tf\ndata \"aws_ami\" \"ubuntu\" {\n  most_recent = true\n  filter {\n    name = \"name\"\n    values = [\"ubuntu/images/hvm-ssd/ubuntu-trusty-14.04-amd64-server-*\"]\n  }\n  filter {\n    name = \"virtualization-type\"\n    values = [\"hvm\"]\n  }\n  owners = [\"099720109477\"]\n}\n\nresource \"aws_security_group\" \"test-sg-for-all\" {\n  name = \"test-sg-for-all\"\n  vpc_id = \"vpc-xxxxxxxx\"\n  egress {\n    from_port = 0\n    to_port = 0\n    protocol = \"-1\"\n    cidr_blocks = [\"0.0.0.0/0\"]\n  }\n  ingress {\n    from_port = 22\n    to_port = 22\n    protocol = \"tcp\"\n    cidr_blocks = [\n      \"xxx.xxx.xxx.xxx/32\"\n    ]\n  }\n  tags {\n    Name = \"test-sg-for-all\"\n  }\n}\n\nresource \"aws_instance\" \"test-instance\" {\n  ami = \"${data.aws_ami.ubuntu.id}\"\n  instance_type = \"t2.micro\"\n  subnet_id = \"subnet-xxxxxxxx\"\n  security_groups = [\"${aws_security_group.test-sg-for-all.id}\"]\n  tags {\n    Name = \"test-instance\"\n  }\n}\n\n\nvariables.tf\u306b\u5b9a\u7fa9\u3057\u305fis_dev\u5909\u6570\u306f\u3001\u958b\u767a\u74b0\u5883\u306e\u3068\u304d\u306f1\u3067\u3001\u305d\u308c\u4ee5\u5916\u306e\u3068\u304d\u306f0\u304c\u6307\u5b9a\u3055\u308c\u3066\u3044\u308b\u3082\u306e\u3068\u3057\u307e\u3059\u3002\n\n\u958b\u767a\u74b0\u5883\u306e\u307f\u306b\u4f5c\u6210\u3059\u308b\u30ea\u30bd\u30fc\u30b9\u3092\u4f5c\u308b\nis_dev\u5909\u6570\u3092count\u306b\u6307\u5b9a(count = \"${var.is_dev}\")\u3059\u308b\u3053\u3068\u3067\u3001\u958b\u767a\u74b0\u5883\u306e\u307f\u306b\u4f5c\u6210\u3059\u308b\u30ea\u30bd\u30fc\u30b9\u3092\u4f5c\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\nsample\nresource \"aws_security_group\" \"test-sg-for-dev\" {\n  count = \"${var.is_dev}\"\n  name = \"test-sg-for-dev\"\n  vpc_id = \"vpc-xxxxxxxx\"\n  egress {\n    from_port = 0\n    to_port = 0\n    protocol = \"-1\"\n    cidr_blocks = [\"0.0.0.0/0\"]\n  }\n  ingress {\n    from_port = 22\n    to_port = 22\n    protocol = \"tcp\"\n    cidr_blocks = [\n      \"xxx.xxx.xxx.xxx/32\"\n    ]\n  }\n}\n\n\n\n\u958b\u767a\u74b0\u5883\u306e\u307f\u306b\u4f5c\u6210\u3059\u308b\u30ea\u30bd\u30fc\u30b9\u3068\u901a\u5e38\u306e\u30ea\u30bd\u30fc\u30b9\u3092\u6df7\u305c\u3066\u4ed6\u306e\u30ea\u30bd\u30fc\u30b9\u3067\u4f7f\u3046\n\u4e0a\u8a18\u3067\u4f5c\u6210\u3057\u305f\u958b\u767a\u74b0\u5883\u7528\u306etest-sg-for-dev\u3068\u5168\u74b0\u5883\u3067\u4f5c\u6210\u3055\u308c\u308btest-sg-for-all\u3092\u4f7f\u3063\u305fEC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u4f5c\u6210\u3059\u308b\u30b5\u30f3\u30d7\u30eb\u304c\u4ee5\u4e0b\u306b\u306a\u308a\u307e\u3059\u3002\n\nsample\nresource \"aws_instance\" \"test-instance\" {\n  ami = \"${data.aws_ami.ubuntu.id}\"\n  instance_type = \"t2.micro\"\n  subnet_id = \"subnet-xxxxxxxx\"\n  security_groups = [\"${\n    compact(\n      concat(\n        aws_security_group.test-sg-for-dev.*.id,\n        list(aws_security_group.test-sg-for-all.id)\n      )\n    )\n  }\"]\n  tags {\n    Name = \"test-instance\"\n  }\n}\n\n\n\u30dd\u30a4\u30f3\u30c8\u306f\u4ee5\u4e0b\u306e\u70b9\u3067\u3059\u3002\n\n\ncount\u3092\u4f7f\u3063\u3066\u4f5c\u6210\u3057\u305f\u30ea\u30bd\u30fc\u30b9\u3092aws_security_group.test-sg-for-dev.*.id\u306e\u3088\u3046\u306bList\u3067\u53d6\u5f97\u3059\u308b\u3002\n\u5168\u74b0\u5883\u7528\u306e\u30ea\u30bd\u30fc\u30b9\u306flist()\u3092\u4f7f\u3044\u3001List\u306b\u3059\u308b\u3002\n\u305d\u308c\u30892\u3064\u306eList\u3092concat\u3092\u4f7f\u3044\u7d50\u5408\u3059\u308b\u3002\n\nis_dev=0\u306e\u3068\u304daws_security_group.test-sg-for-dev.*.id\u304c\u7a7a\u6587\u5b57\u306b\u306a\u308b\u306e\u3092compact\u3067\u53d6\u308a\u9664\u304f\u3002\n\n\n\u307e\u3068\u3081\nTerraform\u306ecount\u3092\u4f7f\u3063\u3066if\u306e\u3088\u3046\u306a\u6761\u4ef6\u5206\u5c90\u3092\u5b9f\u88c5\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3057\u305f\u3002\nTerraform\u306eInterpolation Syntax\u306b\u306fList\u3092\u6271\u3046\u69d8\u3005\u306aSyntax\u304c\u7528\u610f\u3055\u308c\u3066\u3044\u308b\u306e\u3067\u3001\u3053\u308c\u3089\u3092\u5229\u7528\u3057\u3066\u3042\u308b\u7a0b\u5ea6\u306f\u6761\u4ef6\u5206\u5c90\u3092\u4f5c\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n## \u306f\u3058\u3081\u306b\n\n[Terraform](https://www.terraform.io/)\u3067\u30a4\u30f3\u30d5\u30e9\u69cb\u6210\u7ba1\u7406\u3092\u3057\u3066\u3044\u308b\u3068\u540c\u3058tf\u30d5\u30a1\u30a4\u30eb\u3092\u4f7f\u3044\u306a\u304c\u3089\u3082\u3001\u7279\u5b9a\u306e\u74b0\u5883\u3060\u3051\u306b\u4f5c\u308a\u305f\u3044\u30ea\u30bd\u30fc\u30b9\u304c\u51fa\u3066\u304f\u308b\u3053\u3068\u304c\u3042\u308a\u307e\u3059\u3002\n\n\u4f8b\u3048\u3070\u958b\u767a\u74b0\u5883\u306b\u306f\u793e\u5185\u304b\u3089\u306e\u30a2\u30af\u30bb\u30b9\u306e\u307f\u8a31\u53ef\u3059\u308b\u3001\u3068\u3044\u3063\u305f\u5177\u5408\u306b\u3067\u3059\u3002\n\nTerraform\u306b\u306f`if`\u306e\u3088\u3046\u306a\u6761\u4ef6\u5206\u5c90\u304c\u306a\u3044\u3082\u306e\u306e\u3001`count`\u3092\u4f7f\u3046\u3053\u3068\u3067\u4e0a\u8a18\u306e\u3053\u3068\u3092\u5b9f\u73fe\u3067\u304d\u307e\u3059\u3002\n\n## \u30d9\u30fc\u30b9\u3068\u306a\u308btf\u30d5\u30a1\u30a4\u30eb\n\n\u4ee5\u4e0b\u306e3\u3064\u306etf\u30d5\u30a1\u30a4\u30eb\u3092\u30d9\u30fc\u30b9\u306b\u3057\u3066\u8aac\u660e\u3057\u307e\u3059\u3002\u306a\u304a\u5229\u7528\u3057\u305fTerraform\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u306fv0.8.4\u3067\u3059\u3002\n\n```text:provider.tf\nprovider \"aws\" {}\n```\n\n```text:variables.tf\nvariable \"is_dev\" {\n  default = \"0\"\n}\n```\n\n```text:vm.tf\ndata \"aws_ami\" \"ubuntu\" {\n  most_recent = true\n  filter {\n    name = \"name\"\n    values = [\"ubuntu/images/hvm-ssd/ubuntu-trusty-14.04-amd64-server-*\"]\n  }\n  filter {\n    name = \"virtualization-type\"\n    values = [\"hvm\"]\n  }\n  owners = [\"099720109477\"]\n}\n\nresource \"aws_security_group\" \"test-sg-for-all\" {\n  name = \"test-sg-for-all\"\n  vpc_id = \"vpc-xxxxxxxx\"\n  egress {\n    from_port = 0\n    to_port = 0\n    protocol = \"-1\"\n    cidr_blocks = [\"0.0.0.0/0\"]\n  }\n  ingress {\n    from_port = 22\n    to_port = 22\n    protocol = \"tcp\"\n    cidr_blocks = [\n      \"xxx.xxx.xxx.xxx/32\"\n    ]\n  }\n  tags {\n    Name = \"test-sg-for-all\"\n  }\n}\n\nresource \"aws_instance\" \"test-instance\" {\n  ami = \"${data.aws_ami.ubuntu.id}\"\n  instance_type = \"t2.micro\"\n  subnet_id = \"subnet-xxxxxxxx\"\n  security_groups = [\"${aws_security_group.test-sg-for-all.id}\"]\n  tags {\n    Name = \"test-instance\"\n  }\n}\n```\n\n`variables.tf`\u306b\u5b9a\u7fa9\u3057\u305f`is_dev`\u5909\u6570\u306f\u3001\u958b\u767a\u74b0\u5883\u306e\u3068\u304d\u306f`1`\u3067\u3001\u305d\u308c\u4ee5\u5916\u306e\u3068\u304d\u306f`0`\u304c\u6307\u5b9a\u3055\u308c\u3066\u3044\u308b\u3082\u306e\u3068\u3057\u307e\u3059\u3002\n\n## \u958b\u767a\u74b0\u5883\u306e\u307f\u306b\u4f5c\u6210\u3059\u308b\u30ea\u30bd\u30fc\u30b9\u3092\u4f5c\u308b\n\n`is_dev`\u5909\u6570\u3092`count`\u306b\u6307\u5b9a(`count = \"${var.is_dev}\"`)\u3059\u308b\u3053\u3068\u3067\u3001\u958b\u767a\u74b0\u5883\u306e\u307f\u306b\u4f5c\u6210\u3059\u308b\u30ea\u30bd\u30fc\u30b9\u3092\u4f5c\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\n```text:sample\nresource \"aws_security_group\" \"test-sg-for-dev\" {\n  count = \"${var.is_dev}\"\n  name = \"test-sg-for-dev\"\n  vpc_id = \"vpc-xxxxxxxx\"\n  egress {\n    from_port = 0\n    to_port = 0\n    protocol = \"-1\"\n    cidr_blocks = [\"0.0.0.0/0\"]\n  }\n  ingress {\n    from_port = 22\n    to_port = 22\n    protocol = \"tcp\"\n    cidr_blocks = [\n      \"xxx.xxx.xxx.xxx/32\"\n    ]\n  }\n}\n```\n\n## \u958b\u767a\u74b0\u5883\u306e\u307f\u306b\u4f5c\u6210\u3059\u308b\u30ea\u30bd\u30fc\u30b9\u3068\u901a\u5e38\u306e\u30ea\u30bd\u30fc\u30b9\u3092\u6df7\u305c\u3066\u4ed6\u306e\u30ea\u30bd\u30fc\u30b9\u3067\u4f7f\u3046\n\n\u4e0a\u8a18\u3067\u4f5c\u6210\u3057\u305f\u958b\u767a\u74b0\u5883\u7528\u306e`test-sg-for-dev`\u3068\u5168\u74b0\u5883\u3067\u4f5c\u6210\u3055\u308c\u308b`test-sg-for-all`\u3092\u4f7f\u3063\u305fEC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u4f5c\u6210\u3059\u308b\u30b5\u30f3\u30d7\u30eb\u304c\u4ee5\u4e0b\u306b\u306a\u308a\u307e\u3059\u3002\n\n```text:sample\nresource \"aws_instance\" \"test-instance\" {\n  ami = \"${data.aws_ami.ubuntu.id}\"\n  instance_type = \"t2.micro\"\n  subnet_id = \"subnet-xxxxxxxx\"\n  security_groups = [\"${\n    compact(\n      concat(\n        aws_security_group.test-sg-for-dev.*.id,\n        list(aws_security_group.test-sg-for-all.id)\n      )\n    )\n  }\"]\n  tags {\n    Name = \"test-instance\"\n  }\n}\n```\n\n\u30dd\u30a4\u30f3\u30c8\u306f\u4ee5\u4e0b\u306e\u70b9\u3067\u3059\u3002\n\n- `count`\u3092\u4f7f\u3063\u3066\u4f5c\u6210\u3057\u305f\u30ea\u30bd\u30fc\u30b9\u3092`aws_security_group.test-sg-for-dev.*.id`\u306e\u3088\u3046\u306bList\u3067\u53d6\u5f97\u3059\u308b\u3002\n- \u5168\u74b0\u5883\u7528\u306e\u30ea\u30bd\u30fc\u30b9\u306f`list()`\u3092\u4f7f\u3044\u3001List\u306b\u3059\u308b\u3002\n- \u305d\u308c\u30892\u3064\u306eList\u3092`concat`\u3092\u4f7f\u3044\u7d50\u5408\u3059\u308b\u3002\n- `is_dev=0`\u306e\u3068\u304d`aws_security_group.test-sg-for-dev.*.id`\u304c\u7a7a\u6587\u5b57\u306b\u306a\u308b\u306e\u3092`compact`\u3067\u53d6\u308a\u9664\u304f\u3002\n\n## \u307e\u3068\u3081\n\nTerraform\u306e`count`\u3092\u4f7f\u3063\u3066`if`\u306e\u3088\u3046\u306a\u6761\u4ef6\u5206\u5c90\u3092\u5b9f\u88c5\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3057\u305f\u3002\n\nTerraform\u306e[Interpolation Syntax](https://www.terraform.io/docs/configuration/interpolation.html)\u306b\u306fList\u3092\u6271\u3046\u69d8\u3005\u306aSyntax\u304c\u7528\u610f\u3055\u308c\u3066\u3044\u308b\u306e\u3067\u3001\u3053\u308c\u3089\u3092\u5229\u7528\u3057\u3066\u3042\u308b\u7a0b\u5ea6\u306f\u6761\u4ef6\u5206\u5c90\u3092\u4f5c\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n"}