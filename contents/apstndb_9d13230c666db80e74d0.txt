{"context": "Google \u306b\u3088\u308b\u30d5\u30eb\u30de\u30cd\u30fc\u30b8\u30c9\u30b5\u30fc\u30d3\u30b9\u3067\u3042\u308b GKE \u3067\u306f Kubernetes \u306e\u30de\u30b9\u30bf\u3084\u30ce\u30fc\u30c9\u306e\u3053\u3068\u306f\u7406\u89e3\u3057\u306a\u304f\u3068\u3082 Kubernetes \u306e API \u3092\u4f7f\u3063\u3066\u5b9f\u73fe\u3057\u305f\u3044\u3053\u3068\u306b\u96c6\u4e2d\u3067\u304d\u308b\u3002\n\u3057\u304b\u3057\u3001\u672c\u756a\u904b\u7528\u3092\u306f\u3058\u3081\u3066\u304b\u3089\u300c\u306a\u305c\u52d5\u3044\u3066\u3044\u308b\u306e\u304b\u3082\u306a\u305c\u52d5\u304b\u306a\u3044\u306e\u304b\u3082\u5206\u304b\u3089\u306a\u3044\u300d\u3068\u3044\u3046\u3088\u3046\u306a\u72b6\u614b\u3067\u306f\u3044\u3056\u3068\u3044\u3046\u6642\u306b\u56f0\u308b\u3002\n\u7279\u306b Service \u304c\u3069\u306e\u3088\u3046\u306b\u30af\u30e9\u30b9\u30bf\u306e\u5916\u304b\u3089 Pod \u3078\u306e\u30a2\u30af\u30bb\u30b9\u3092\u63d0\u4f9b\u3057\u3066\u3044\u308b\u306e\u304b\u306f\u30d6\u30e9\u30c3\u30af\u30dc\u30c3\u30af\u30b9\u306b\u306a\u3063\u3066\u3044\u305f\u305f\u3081\u3001\u4eca\u56de\u306f GKE \u3067\u306e Service \u306e L3(\u301cL4) \u306e\u6319\u52d5\u306b\u3064\u3044\u3066 Kubernetes \u306e\u5185\u5916\u3092\u8abf\u67fb\u3057\u305f\u3002\n(\u5f8c\u3067\u56f3\u3084\u53c2\u7167\u60c5\u5831\u3078\u306e\u30ea\u30f3\u30af\u3092\u8ffd\u52a0\u4e88\u5b9a)\n\n\u74b0\u5883\nKubernetes ver. 1.5.2(Master & Node)\n\nGKE \u30af\u30e9\u30b9\u30bf\u306e\u521d\u671f\u8a2d\u5b9a\n\u4eca\u56de\u306f\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u3092\u4f5c\u3063\u3066\u305d\u306e\u4e2d\u3067\u4f5c\u696d\u3059\u308b\u3002\n$ gcloud compute networks create kube-sandbox\n(\u7701\u7565)\n$ gcloud compute firewall-rules create default-allow-ssh --network kube-sandbox --allow tcp:22\n(\u7701\u7565)\n\n\u4e0a\u3067\u4f5c\u3063\u305f kube-sandbox \u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u5185\u306b GKE \u30af\u30e9\u30b9\u30bf\u3092\u4f5c\u6210\u3059\u308b\u3002\u4eca\u56de\u306f\u5358\u7d14\u5316\u306e\u305f\u3081\u30ce\u30fc\u30c9\u306f1\u3068\u3059\u308b\u3002\n$ gcloud beta container clusters create --machine-type=g1-small --num-nodes=1 --network=kube-sandbox kube-sandbox\n(\u7701\u7565)\nNAME          ZONE          MASTER_VERSION  MASTER_IP       MACHINE_TYPE  NODE_VERSION  NUM_NODES  STATUS\nkube-sandbox  asia-east1-a  1.5.2           104.199.251.51  g1-small      1.5.2         1          RUNNING\n\n\u73fe\u6642\u70b9\u3067 kube-sandbox \u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u306b\u306f\u4e0b\u8a18\u306e\u30eb\u30fc\u30c8\u304c\u81ea\u52d5\u7684\u306b\u8a2d\u5b9a\u3055\u308c\u3066\u3044\u308b\u3002\u5177\u4f53\u7684\u306a\u30ce\u30fc\u30c9\u540d\u7b49\u306f\u74b0\u5883\u3054\u3068\u306b\u9055\u3046\u306e\u3067\u8aad\u307f\u66ff\u3048\u3066\u307b\u3057\u3044\u3002\n$ gcloud compute routes list --filter=network=kube-sandbox\nNAME                                                            NETWORK       DEST_RANGE     NEXT_HOP                                                            PRIORITY\ndefault-route-0febf5d565eb04b9                                  kube-sandbox  10.146.0.0/20                                                                      1000\ndefault-route-61d48fa98847c47f                                  kube-sandbox  10.138.0.0/20                                                                      1000\ndefault-route-73c1d7230a9f1444                                  kube-sandbox  10.128.0.0/20                                                                      1000\ndefault-route-7cc26e9102aa6708                                  kube-sandbox  10.142.0.0/20                                                                      1000\ndefault-route-7de16d017205e5de                                  kube-sandbox  10.132.0.0/20                                                                      1000\ndefault-route-e3201908a50d2b01                                  kube-sandbox  0.0.0.0/0      default-internet-gateway                                            1000\ndefault-route-fccedbefa32ce294                                  kube-sandbox  10.140.0.0/20                                                                      1000\ngke-kube-sandbox-5bb78bc1-3ca8c4dd-edb8-11e6-90da-42010af00188  kube-sandbox  10.76.0.0/24   asia-east1-a/instances/gke-kube-sandbox-default-pool-88bb8656-26d1  1000\n\n\u3044\u304b\u306b\u3082 GKE \u306a\u611f\u3058\u306e gke-kube-sandbox-5bb78bc1-3ca8c4dd-edb8-11e6-90da-42010af00188 \u3068\u3044\u3046\u30eb\u30fc\u30c8\u304c\u3067\u304d\u3066\u304a\u308a NEXT_HOP \u306b\u6307\u5b9a\u3055\u308c\u3066\u3044\u308b GCE \u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u304c\u4f5c\u6210\u3057\u305f GKE \u30af\u30e9\u30b9\u30bf\u306e\u30ce\u30fc\u30c9\u3067\u3042\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n\u8a72\u5f53\u3059\u308b\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u78ba\u8a8d\u3059\u308b\u3002\n(\u8868\u793a\u5185\u5bb9\u306e\u8abf\u6574\u306e\u305f\u3081 format \u5185\u3067projection \u3092\u4f7f\u3063\u3066\u3044\u308b\u3002)\n$ gcloud compute instances describe gke-kube-sandbox-default-pool-88bb8656-26d1 \\\u2028         --format='table(name,networkInterfaces[0].networkIP, networkInterfaces[0].accessConfigs[0].natIP, tags.items.map(0).join(\",\"):label=TAGS)'\nNAME                                         NETWORK_IP  NAT_IP           TAGS\ngke-kube-sandbox-default-pool-88bb8656-26d1  10.140.0.2  104.199.254.163  gke-kube-sandbox-5bb78bc1-node,goog-gke-node\n\n\u5bfe\u5fdc\u3059\u308b Kubernetes \u5074\u306e Node \u60c5\u5831\u3092\u78ba\u8a8d\u3059\u308b\u3002\n(\u30c7\u30d5\u30a9\u30eb\u30c8\u3067\u306f\u8868\u793a\u3055\u308c\u306a\u3044\u30d5\u30a3\u30fc\u30eb\u30c9\u3092\u629c\u304d\u51fa\u3059\u305f\u3081\u306b custom-columns \u306e\u4e2d\u3067 JSONPath \u3092\u4f7f\u3046\u3002)\n$ kubectl get node -o custom-columns='NAME:.metadata.name,EXTERNAL-IP:.status.addresses[?(@.type==\"ExternalIP\")].address,INTERNAL-IP:.status.addresses[?(@.type==\"InternalIP\")].address,POD-CIDR:.spec.podCIDR'\nNAME                                          EXTERNAL-IP       INTERNAL-IP   POD-CIDR\ngke-kube-sandbox-default-pool-88bb8656-26d1   104.199.254.163   10.140.0.2    10.76.0.0/24\n\nGCE \u30eb\u30fc\u30c8\u306e DEST_RANGE \u3068 Kubernetes Node \u306e POD-CIDR, GCE \u30eb\u30fc\u30c8\u306e NEXT_HOP \u3068 Kubernetes Node \u306e NAME \u304c\u5bfe\u5fdc\u3057\u3066\u3044\u308b\u3053\u3068\u304c\u78ba\u8a8d\u3067\u304d\u305f\u3002\n\u4e00\u5fdc Node \u306e\u4e2d\u306e\u8a2d\u5b9a\u3082\u898b\u3066\u307f\u308b\u3068\u3001 POD-CIDR \u306e\u30a2\u30c9\u30ec\u30b9\u7bc4\u56f2\u306f cbr0 \u30d6\u30ea\u30c3\u30b8\u306b\u5272\u308a\u5f53\u3066\u3089\u308c\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n$ gcloud compute ssh user@gke-kube-sandbox-default-pool-88bb8656-26d1 -- ip address show cbr0\n4: cbr0: <BROADCAST,MULTICAST,PROMISC,UP,LOWER_UP> mtu 1460 qdisc htb state UP group default qlen 1000\n    link/ether 0a:58:0a:4c:00:01 brd ff:ff:ff:ff:ff:ff\n    inet 10.76.0.1/24 scope global cbr0\n       valid_lft forever preferred_lft forever\n    inet6 fe80::a42a:16ff:fe06:38a5/64 scope link\n       valid_lft forever preferred_lft forever\n\n\u3053\u306e\u8a18\u4e8b\u3067\u306f L2 \u30ec\u30a4\u30e4\u306e\u30b3\u30f3\u30c6\u30ca\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u306b\u3064\u3044\u3066\u306f\u8aac\u660e\u3057\u306a\u3044\u304c\u3001\u3053\u306e\u30d6\u30ea\u30c3\u30b8\u306b\u305d\u308c\u305e\u308c\u306e Pod \u306e veth \u304c\u30a2\u30bf\u30c3\u30c1\u3055\u308c\u308b\u3002\n(/24 \u3068\u3044\u3046\u3053\u3068\u306f\u540c\u6642\u306bIP \u30a2\u30c9\u30ec\u30b9\u304c\u5272\u308a\u5f53\u3066\u3089\u308c\u308b Pod \u306f1 Node \u306b\u3064\u304d254\u500b\u3068\u3044\u3046\u3053\u3068\u3092\u610f\u5473\u3059\u308b\u3002 GKE \u306b\u9650\u3063\u3066\u8a00\u3048\u3070 nodeIpv4CidrSize \u30d5\u30a3\u30fc\u30eb\u30c9\u306f\u5909\u66f4\u4e0d\u53ef\u80fd\u306a\u3088\u3046\u3060\u304b\u3089\u3001\u4ed6\u306e\u30ea\u30bd\u30fc\u30b9\u306b\u4f59\u88d5\u304c\u3042\u3063\u3066\u3082 Pod \u306e\u6570\u306b\u5fdc\u3058\u3066 Node \u3092\u30b9\u30b1\u30fc\u30eb\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u3088\u3046\u306b\u898b\u3048\u308b\u3002)\n\u3053\u3053\u307e\u3067\u3067 Pod \u306e IP \u30a2\u30c9\u30ec\u30b9\u304b\u3089\u5bfe\u8c61\u306e GCE \u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3078\u306e\u30eb\u30fc\u30c6\u30a3\u30f3\u30b0\u304c\u884c\u308f\u308c\u3066\u3044\u308b\u3053\u3068\u304c\u5206\u304b\u308b\u3002\n\u3053\u308c\u3089\u306e\u8a2d\u5b9a\u306f\u4f55\u3092\u610f\u5473\u3059\u308b\u306e\u3060\u308d\u3046\u304b\u3002\nNetworking \u306b\u3088\u308b\u3068 Kubernetes \u306e\u30b3\u30f3\u30c6\u30ca\u9593\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u306e\u57fa\u672c\u8981\u4ef6\u306f\u4e0b\u8a18\u306e3\u3064\u304c\u3042\u308b\u3002\n\n\u5168\u3066\u306e\u30b3\u30f3\u30c6\u30ca\u306f\u5225\u306e\u5168\u3066\u306e\u30b3\u30f3\u30c6\u30ca\u3068 NAT \u306a\u3057\u3067\u901a\u4fe1\u3067\u304d\u308b\n\u5168\u3066\u306e\u30ce\u30fc\u30c9\u306f\u5168\u3066\u306e\u30b3\u30f3\u30c6\u30ca\u3068 NAT \u306a\u3057\u3067\u901a\u4fe1\u3067\u304d\u308b\n\n\n\u9006\u3082\u540c\u69d8(\u5168\u3066\u306e\u30b3\u30f3\u30c6\u30ca\u306f\u5168\u3066\u306e\u30ce\u30fc\u30c9\u3068 NAT \u306a\u3057\u3067\u901a\u4fe1\u3067\u304d\u308b)\n\n\n\u30b3\u30f3\u30c6\u30ca\u306f\u81ea\u5206\u81ea\u8eab\u306e IP \u30a2\u30c9\u30ec\u30b9\u3092\u4ed6\u306e\u30b3\u30f3\u30c6\u30ca\u304b\u3089\u898b\u3048\u308b\u306e\u3068\u540c\u3058 IP \u30a2\u30c9\u30ec\u30b9\u3068\u3057\u3066\u898b\u308b\u3053\u3068\u304c\u3067\u304d\u308b\n\nflannel \u7b49\u306e\u30aa\u30fc\u30d0\u30ec\u30a4\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u3067\u3053\u308c\u3089\u306e\u8981\u4ef6\u306b\u5bfe\u5fdc\u3057\u3066\u3044\u308b\u74b0\u5883\u3082\u3042\u308b\u304c\u3001 GCE \u3067\u306f\u30aa\u30fc\u30d0\u30ec\u30a4\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u304c\u4e0d\u8981\u3068\u3057\u3066\u3044\u308b\u306e\u306f\u3001\u3053\u306e GCE \u30eb\u30fc\u30c8\u306e\u8a2d\u5b9a\u306b\u3088\u308b\u3082\u306e\u3067\u3042\u308b\u3088\u3046\u3060\u3002\n\nKubernetes \u306e\u4e16\u754c\n\u3053\u3053\u304b\u3089\u306f Kubernetes \u306e Service \u304c\u3069\u306e\u3088\u3046\u306b\u52d5\u3044\u3066\u3044\u308b\u304b\u306b\u3064\u3044\u3066\u300cDebugging Services - Is the kube-proxy working?\u300d\u3092\u53c2\u8003\u306b\u78ba\u8a8d\u3057\u3066\u3044\u304f\u3002 \n\nkube-proxy\nService \u306f kube-proxy \u306b\u3088\u308b\u4eee\u60f3 IP \u30a2\u30c9\u30ec\u30b9\u3068 kube-dns \u306b\u3088\u308b\u540d\u524d\u89e3\u6c7a\u306b\u3088\u3063\u3066\u5b9f\u73fe\u3055\u308c\u3066\u3044\u308b\u304c\u3001\u3053\u306e\u8a18\u4e8b\u3067\u306f L3(\u301cL4) \u306b\u30d5\u30a9\u30fc\u30ab\u30b9\u3059\u308b\u305f\u3081 kube-dns \u306b\u3064\u3044\u3066\u306f\u7279\u306b\u8aac\u660e\u3057\u306a\u3044\u3002\nkube-proxy \u306f Kubernetes 1.2 \u4ee5\u964d\u306f\u52d5\u7684\u306b iptables \u306e\u30eb\u30fc\u30eb\u3092\u64cd\u4f5c (Proxy-mode: iptables) \u3059\u308b\u3053\u3068\u3067\u3001 Linux \u30ab\u30fc\u30cd\u30eb\u306e netfilter \u3092\u4f7f\u3063\u3066\u52d5\u3044\u3001\u4eee\u60f3 IP \u30a2\u30c9\u30ec\u30b9\u3078\u306e\u30a2\u30af\u30bb\u30b9\u3092\u9069\u5207\u306b Pod \u306b\u8ee2\u9001\u3059\u308b\u3002\n\u306a\u304a\u3001\u904e\u53bb\u306f\u540d\u524d\u901a\u308a\u30e6\u30fc\u30b6\u30b9\u30da\u30fc\u30b9\u306e\u30d7\u30ed\u30ad\u30b7 (Proxy-mode: userspace) \u3068\u3057\u3066\u52d5\u3044\u3066\u3044\u305f\u3089\u3057\u3044\u3002\nSSH \u7d4c\u7531\u3067 GKE \u30ce\u30fc\u30c9\u306e iptables \u306e\u30eb\u30fc\u30eb\u5168\u4f53\u3092\u53d6\u5f97\u3059\u308b\u306b\u306f\u4e0b\u8a18\u306e\u3088\u3046\u306b\u3059\u308b\u3002\n$ gcloud compute ssh user@gke-kube-sandbox-default-pool-88bb8656-26d1 -- sudo iptables-save\n\n\u64cd\u4f5c\u3054\u3068\u306b\u5dee\u5206\u306e\u307f\u793a\u3059\u3002\u306a\u304a\u8457\u8005\u306f iptables \u306b\u8a73\u3057\u304f\u306a\u3044\u306e\u3067\u3001 iptables \u81ea\u4f53\u306e\u89e3\u91c8\u306b\u3064\u3044\u3066\u306f\u4ed6\u306e\u8a18\u4e8b\u3082\u53c2\u8003\u306b\u3057\u3066\u307b\u3057\u3044\u3002\n(\u6ce8: Kubernetes \u306e\u5916\u306b\u8ee2\u9001\u3059\u308b ExternalName Service \u3068 \u8907\u6570 IP \u30a2\u30c9\u30ec\u30b9\u3092 A \u30ec\u30b3\u30fc\u30c9\u3067\u8fd4\u3059 Headless Service \u306f DNS \u30d9\u30fc\u30b9\u3067\u4eee\u60f3 IP \u30a2\u30c9\u30ec\u30b9\u3092\u6301\u305f\u306a\u3044\u306e\u3067\u3053\u306e\u8a18\u4e8b\u3067\u306f\u89e6\u308c\u306a\u3044\u3002)\n\nService \u306a\u3057\n\u307e\u305a\u306f kubectl run \u3067\u4f5c\u3063\u305f Deployment \u304b\u3089 Pod \u3092\u8d77\u52d5\u3059\u308b\u3002\n$ kubectl run hostnames --image=gcr.io/google_containers/serve_hostname \\\n                        --labels=app=hostnames \\\n                        --port=9376 \\\n                        --replicas=1\ndeployment \"hostnames\" created\n\n\u4e0b\u8a18\u306e\u3088\u3046\u306a IP \u30a2\u30c9\u30ec\u30b9\u3092\u6301\u3063\u305f Pod \u304c\u4f5c\u3089\u308c\u305f\u3002\u3053\u306e\u6642\u70b9\u3060\u3068\u7279\u306b iptables \u306b\u306f\u5909\u5316\u304c\u306a\u3044\u3002\n$ kubectl get pod -o wide -l app=hostnames\nNAME                         READY     STATUS    RESTARTS   AGE       IP          NODE\nhostnames-3799501552-jpmdq   1/1       Running   0          6m        10.76.0.9   gke-kube-sandbox-default-pool-88bb8656-26d1\n\n\nClusterIP Service\n\u5148\u7a0b\u306e Pod \u306b\u5bfe\u5fdc\u3059\u308b \u306e ClusterIP Service \u3092\u4f5c\u3063\u3066\u307f\u3088\u3046\u3002\n$ kubectl expose deployment hostnames --port=80 --target-port=9376\nservice \"hostnames\" exposed\n\n\u4f5c\u3089\u308c\u305f\u3082\u306e\u3092\u78ba\u8a8d\u3057\u3066\u307f\u308b\u3002 Service \u3060\u3051\u3067\u306a\u304f Endpoints \u304c\u3067\u304d\u3066\u3044\u308b\u3053\u3068\u304c\u5206\u304b\u308b\u3002\n$ kubectl get pod,endpoints,service -o wide -l app=hostnames\nNAME                            READY     STATUS    RESTARTS   AGE       IP          NODE\npo/hostnames-3799501552-jpmdq   1/1       Running   0          42m       10.76.0.9   gke-kube-sandbox-default-pool-88bb8656-26d1\n\nNAME           ENDPOINTS        AGE\nep/hostnames   10.76.0.9:9376   33m\n\nNAME            CLUSTER-IP    EXTERNAL-IP   PORT(S)   AGE       SELECTOR\nsvc/hostnames   10.79.255.4   <none>        80/TCP    33m       app=hostnames\n\n\u3053\u306e\u6642\u70b9\u3067 iptables \u306b\u306f\u6b21\u306e\u30eb\u30fc\u30eb\u304c\u8ffd\u52a0\u3055\u308c\u3066\u3044\u305f\u3002\n-A KUBE-SERVICES ! -s 10.76.0.0/14 -d 10.79.255.4/32 -p tcp -m comment --comment \"default/hostnames: cluster IP\" -m tcp --dport 80 -j KUBE-MARK-MASQ\n-A KUBE-SERVICES -d 10.79.255.4/32 -p tcp -m comment --comment \"default/hostnames: cluster IP\" -m tcp --dport 80 -j KUBE-SVC-NWV5X2332I4OT4T3\n-A KUBE-SVC-NWV5X2332I4OT4T3 -m comment --comment \"default/hostnames:\" -j KUBE-SEP-EV2NQKURMPKCP5UI\n-A KUBE-SEP-EV2NQKURMPKCP5UI -s 10.76.0.9/32 -m comment --comment \"default/hostnames:\" -j KUBE-MARK-MASQ\n-A KUBE-SEP-EV2NQKURMPKCP5UI -p tcp -m comment --comment \"default/hostnames:\" -m tcp -j DNAT --to-destination 10.76.0.9:9376\n\n\u90e8\u5206\u3054\u3068\u306b\u898b\u3066\u3044\u3053\u3046\u3002\n-A KUBE-SERVICES ! -s 10.76.0.0/14 -d 10.79.255.4/32 -p tcp -m comment --comment \"default/hostnames: cluster IP\" -m tcp --dport 80 -j KUBE-MARK-MASQ\n\n10.76.0.0/14 \u306e\u4e2d\u4ee5\u5916\u304b\u3089 ClusterIP \u3078\u306e\u901a\u4fe1\u306f KUBE-MARK-MASQ \u306b\u56de\u3055\u308c\u308b\u3088\u3046\u3060\u3002\u4e0a\u3067\u78ba\u8a8d\u3057\u305f cbr0 \u306e\u30a2\u30c9\u30ec\u30b9\u7a7a\u9593\u306f 10.76.0.0/24 \u3060\u304c\u3001\u7b49\u3057\u304f\u306a\u3044\u306e\u306f\u4f55\u306e\u305f\u3081\u3067\u3001\u3069\u3053\u3067\u8a2d\u5b9a\u3055\u308c\u3066\u3044\u308b\u306e\u304b\uff1f\n\u8a2d\u5b9a\u7b87\u6240\u306f kube-proxy \u306e\u8d77\u52d5\u30aa\u30d7\u30b7\u30e7\u30f3\u304c\u7b54\u3048\u3060\u3063\u305f\u3002\u30ce\u30fc\u30c9\u3054\u3068\u306e Pod \u306e\u30a2\u30c9\u30ec\u30b9\u7a7a\u9593\u306e\u4e0a\u306b\u30af\u30e9\u30b9\u30bf\u306e Pod \u306e\u30a2\u30c9\u30ec\u30b9\u7a7a\u9593\u304c\u3042\u308b\u3053\u3068\u304c\u5206\u304b\u308b\u3002\n$ gcloud compute ssh user@gke-kube-sandbox-default-pool-88bb8656-26d1 -- ps ax | grep kube-proxy\n 1625 ?        Sl     1:48 kube-proxy --master=https://104.199.251.51 --kubeconfig=/var/lib/kube-proxy/kubeconfig --cluster-cidr=10.76.0.0/14 --resource-container= --v=2\n\nKUBE-MARK-MASQ \u306f\u6b21\u306e\u3088\u3046\u306b\u5b9a\u7fa9\u3055\u308c\u3066\u3044\u308b\u4e00\u9023\u306e\u30eb\u30fc\u30eb\u3092\u8aad\u3080\u3068 POSTROUTING \u3092\u7d4c\u7531\u3057\u3066 KUBE-POSTROUTING \u304b\u3089\u30de\u30b9\u30ab\u30ec\u30fc\u30c9(NAT)\u3059\u308b\u304b\u3069\u3046\u304b\u306e\u5224\u65ad\u306e\u305f\u3081\u306e\u30d5\u30e9\u30b0\u3092\u3064\u3051\u308b\u8a2d\u5b9a\u3060\u3068\u308f\u304b\u308b\u3002\n\u3088\u3063\u3066\u3001\u30af\u30e9\u30b9\u30bf\u5883\u754c\u3092\u8de8\u3050\u901a\u4fe1\u306f NAT \u3055\u308c\u308b\u3053\u3068\u304c\u308f\u304b\u3063\u305f\u3002\n-A KUBE-MARK-MASQ -j MARK --set-xmark 0x4000/0x4000\n-A KUBE-POSTROUTING -m comment --comment \"kubernetes service traffic requiring SNAT\" -m mark --mark 0x4000/0x4000 -j MASQUERADE\n-A POSTROUTING -m comment --comment \"kubernetes postrouting rules\" -j KUBE-POSTROUTING\n\n\u6b21\u306e\u30eb\u30fc\u30eb\u3092\u898b\u3066\u307f\u3088\u3046\u3002Cluster IP \u3078\u306e\u901a\u4fe1\u306f KUBE-SVC-* \u30c1\u30a7\u30a4\u30f3\u306b\u98db\u3076\u3053\u3068\u304c\u5206\u304b\u308b\u3002\n-A KUBE-SERVICES -d 10.79.255.4/32 -p tcp -m comment --comment \"default/hostnames: cluster IP\" -m tcp --dport 80 -j KUBE-SVC-NWV5X2332I4OT4T3\n\nKUBE-SVC-* \u30c1\u30a7\u30a4\u30f3\u306f Endpoints \u306b\u5bfe\u5fdc\u3059\u308b KUBE-SEP-* \u306b\u98db\u3076\u3002\n-A KUBE-SVC-NWV5X2332I4OT4T3 -m comment --comment \"default/hostnames:\" -j KUBE-SEP-EV2NQKURMPKCP5UI\n\nKUBE-SEP-* \u306f\u5bfe\u8c61\u306e Pod \u306e ContainerPort \u306b\u5b9b\u5148\u306e IP \u30a2\u30c9\u30ec\u30b9\u3068\u30dd\u30fc\u30c8\u756a\u53f7\u3092\u8ee2\u9001\u3059\u308b\u3002\n-A KUBE-SEP-EV2NQKURMPKCP5UI -s 10.76.0.9/32 -m comment --comment \"default/hostnames:\" -j KUBE-MARK-MASQ\n-A KUBE-SEP-EV2NQKURMPKCP5UI -p tcp -m comment --comment \"default/hostnames:\" -m tcp -j DNAT --to-destination 10.76.0.9:9376\n\n\u3053\u3053\u307e\u3067\u3067\u3001 Cluster IP \u3078\u306e\u30a2\u30af\u30bb\u30b9\u304c Service \u3092\u69cb\u6210\u3059\u308b Pod \u3078\u3068\u8ee2\u9001\u3055\u308c\u308b\u3053\u3068\u304c\u308f\u304b\u3063\u305f\u3002\n\nPod \u3092\u30b9\u30b1\u30fc\u30eb\u3059\u308b\nPod \u3092\u30b9\u30b1\u30fc\u30eb\u3057\u305f\u5834\u5408\u306e\u5909\u5316\u3092\u78ba\u8a8d\u3059\u308b\u3002\n$ kubectl scale deployment hostnames --replicas 2\ndeployment \"hostnames\" scaled\n\n\u8907\u6570\u306e Pod \u306b\u5bfe\u5fdc\u3059\u308b Endpoints \u304c\u51fa\u6765\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n$ kubectl get pod,endpoints,service -o wide -l app=hostnames\nNAME                            READY     STATUS    RESTARTS   AGE       IP           NODE\npo/hostnames-3799501552-jpmdq   1/1       Running   0          39m       10.76.0.9    gke-kube-sandbox-default-pool-88bb8656-26d1\npo/hostnames-3799501552-nw2gz   1/1       Running   0          21m       10.76.0.10   gke-kube-sandbox-default-pool-88bb8656-26d1\n\nNAME           ENDPOINTS                        AGE\nep/hostnames   10.76.0.10:9376,10.76.0.9:9376   30m\n\nNAME            CLUSTER-IP    EXTERNAL-IP   PORT(S)   AGE       SELECTOR\nsvc/hostnames   10.79.255.4   <none>        80/TCP    30m       app=hostnames\n\n\u3053\u306e\u6642\u70b9\u3067\u3067\u304d\u305f\u5dee\u5206\u306f\u4e0b\u8a18\u306e\u3088\u3046\u306b\u306a\u308b\u3002\n-A KUBE-SEP-BWZ646KDVNVKXICT -s 10.76.0.10/32 -m comment --comment \"default/hostnames:\" -j KUBE-MARK-MASQ\n-A KUBE-SEP-BWZ646KDVNVKXICT -p tcp -m comment --comment \"default/hostnames:\" -m tcp -j DNAT --to-destination 10.76.0.10:9376\n-A KUBE-SVC-NWV5X2332I4OT4T3 -m comment --comment \"default/hostnames:\" -m statistic --mode random --probability 0.50000000000 -j KUBE-SEP-BWZ646KDVNVKXICT\n\nKUBE-SEP \u306b\u3064\u3044\u3066\u306f\u3001\u65b0\u3057\u304f\u8ffd\u52a0\u3055\u308c\u305f Pod \u306b\u5bfe\u3057\u3066\u3082\u540c\u69d8\u306b\u30c1\u30a7\u30a4\u30f3\u3092\u8ffd\u52a0\u3057\u3066\u3044\u308b\u3002\n-A KUBE-SEP-BWZ646KDVNVKXICT -s 10.76.0.10/32 -m comment --comment \"default/hostnames:\" -j KUBE-MARK-MASQ\n-A KUBE-SEP-BWZ646KDVNVKXICT -p tcp -m comment --comment \"default/hostnames:\" -m tcp -j DNAT --to-destination 10.76.0.10:9376\n\n\u6ce8\u76ee\u3059\u3079\u304d\u306f statistic module \u306e random \u30e2\u30fc\u30c9\u3092\u4f7f\u3063\u3066 50% \u305a\u3064\u632f\u308a\u5206\u3051\u3092\u884c\u3063\u3066\u3044\u308b\u3068\u3053\u308d\u3060\u3002\u3053\u308c\u306b\u3088\u308a ClusterIP \u306f\u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b5\u3068\u3057\u3066\u50cd\u304f\u3002\n-A KUBE-SVC-NWV5X2332I4OT4T3 -m comment --comment \"default/hostnames:\" -m statistic --mode random --probability 0.50000000000 -j KUBE-SEP-BWZ646KDVNVKXICT\n-A KUBE-SVC-NWV5X2332I4OT4T3 -m comment --comment \"default/hostnames:\" -j KUBE-SEP-EV2NQKURMPKCP5UI\n\n\u5358\u7d14\u5316\u306e\u305f\u3081\u306b\u30ec\u30d7\u30ea\u30ab\u6570\u306f1\u306b\u623b\u3057\u3066\u304a\u3053\u3046\u3002\n$ kubectl scale deployment hostnames --replicas 1\ndeployment \"hostnames\" scaled\n\n\nNodePort Service\n\u3053\u308c\u304b\u3089\u5916\u306b\u516c\u958b\u3059\u308b Service \u3092\u4f5c\u3063\u3066\u307f\u308b\u3002\u307e\u305a\u306f Node \u3067\u3042\u308b\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u30dd\u30fc\u30c8\u3092\u901a\u3057\u3066 Service \u306b\u30a2\u30af\u30bb\u30b9\u3067\u304d\u308b\u3088\u3046\u306b\u3059\u308b NodePort Service \u3060\u3002\n\u524d\u56de\u4f5c\u3063\u305f ClusterIP Service \u3092\u6d88\u3057\u3066\u304b\u3089\u4f5c\u6210\u3059\u308b\u3002\n$ kubectl delete service hostnames\nservice \"hostnames\" deleted\n$ kubectl expose deployment hostnames --port=80 --target-port=9376 --type=NodePort\nservice \"hostnames\" exposed\n\n\u4f5c\u3089\u308c\u305f\u30ea\u30bd\u30fc\u30b9\u3092\u898b\u3066\u307f\u308b\u3002 Service \u306e\u30dd\u30fc\u30c8 80 \u304c\u30ce\u30fc\u30c9\u306e\u30dd\u30fc\u30c8 31358 \u306b\u5272\u308a\u5f53\u3066\u3089\u308c\u3066\u3044\u308b\u3053\u3068\u304c\u5206\u304b\u308b\u3002\n$ kubectl get pod,endpoints,service -o wide -l app=hostnames\nNAME                            READY     STATUS    RESTARTS   AGE       IP          NODE\npo/hostnames-3799501552-jpmdq   1/1       Running   0          50m       10.76.0.9   gke-kube-sandbox-default-pool-88bb8656-26d1\n\nNAME           ENDPOINTS        AGE\nep/hostnames   10.76.0.9:9376   1m\n\nNAME            CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE       SELECTOR\nsvc/hostnames   10.79.245.174   <nodes>       80:31358/TCP   1m        app=hostnames\n\nCLUSTER-IP \u304c\u8a2d\u5b9a\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u304b\u3089\u3082\u3001 ClusterIP Service \u306e\u62e1\u5f35\u3067\u3042\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\niptables \u306b\u306f\u4e0b\u8a18\u306e\u3088\u3046\u306a\u30eb\u30fc\u30eb\u304c\u8ffd\u52a0\u3055\u308c\u305f\u3002\nKUBE-NODEPORTS \u306b\u6765\u305f\u3082\u306e\u3067 NodePort \u306b\u5272\u308a\u5f53\u3066\u3089\u308c\u305f\u30dd\u30fc\u30c8\u3042\u3066\u306e\u30d1\u30b1\u30c3\u30c8\u3092\u5bfe\u5fdc\u3059\u308b KUBE-SVC-* \u3067\u51e6\u7406\u3059\u308b\u30eb\u30fc\u30eb\u3060\u3068\u308f\u304b\u308b\u3002\n-A KUBE-NODEPORTS -p tcp -m comment --comment \"default/hostnames:\" -m tcp --dport 31358 -j KUBE-MARK-MASQ\n-A KUBE-NODEPORTS -p tcp -m comment --comment \"default/hostnames:\" -m tcp --dport 31358 -j KUBE-SVC-NWV5X2332I4OT4T3\n\nKUBE-NODEPORTS \u30c1\u30a7\u30a4\u30f3\u3068\u306f\u4f55\u304b\u3068\u3044\u3046\u3068\u3001 KUBE-SERVICES \u306b\u6765\u305f\u3082\u306e\u3067\u30ce\u30fc\u30c9\u306e\u30ed\u30fc\u30ab\u30eb\u30a2\u30c9\u30ec\u30b9\u5b9b\u3066\u306e\u30d1\u30b1\u30c3\u30c8\u3060\u3002\n-A KUBE-SERVICES -m comment --comment \"kubernetes service nodeports; NOTE: this must be the last rule in this chain\" -m addrtype --dst-type LOCAL -j KUBE-NODEPORTS\n\n\u3053\u308c\u306b\u3088\u308a\u3001\u30ce\u30fc\u30c9\u306e NodePort \u306b\u6765\u305f\u3082\u306e\u304c Service \u306e Endpoints \u3092\u69cb\u6210\u3059\u308b Pod \u306e\u9069\u5207\u306a\u30dd\u30fc\u30c8\u306b\u8ee2\u9001\u3055\u308c\u308b\u3053\u3068\u304c\u5206\u304b\u308b\u3002\n\nLoadBalancer Service (GKE \u4f9d\u5b58)\n\u6700\u5f8c\u306b LoadBalancer Service \u304c\u3069\u306e\u3088\u3046\u306b\u52d5\u304f\u306e\u304b\u3092\u898b\u308b\u3002\n$ kubectl delete service hostnames\nservice \"hostnames\" deleted\n$ kubectl\nkubectl expose deployment hostnames --port=80 --target-port=9376 --type=LoadBalancer\n\n\u4f5c\u3089\u308c\u305f\u30ea\u30bd\u30fc\u30b9\u3092\u78ba\u8a8d\u3059\u308b\u3002 EXTERNAL-IP \u304c\u8a2d\u5b9a\u3055\u308c\u305f\u3002\n% kubectl get pod,endpoints,service -o wide -l app=hostnames\nNAME                            READY     STATUS    RESTARTS   AGE       IP          NODE\npo/hostnames-3799501552-jpmdq   1/1       Running   0          55m       10.76.0.9   gke-kube-sandbox-default-pool-88bb8656-26d1\n\nNAME           ENDPOINTS        AGE\nep/hostnames   10.76.0.9:9376   1m\n\nNAME            CLUSTER-IP      EXTERNAL-IP       PORT(S)        AGE       SELECTOR\nsvc/hostnames   10.79.250.127   104.199.232.159   80:30675/TCP   1m        app=hostnames\n\nPORT \u3092\u898b\u308b\u3068\u3001 NodePort Service \u306e\u4e0a\u306b\u5b9f\u88c5\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u304c\u5206\u304b\u308b\u3002\niptables \u306b\u306f\u6b21\u306e\u3088\u3046\u306a\u30eb\u30fc\u30eb\u304c\u8ffd\u52a0\u3055\u308c\u305f\u3002\n-A KUBE-SERVICES -d 104.199.232.159/32 -p tcp -m comment --comment \"default/hostnames: loadbalancer IP\" -m tcp --dport 80 -j KUBE-FW-NWV5X2332I4OT4T3\n-A KUBE-FW-NWV5X2332I4OT4T3 -m comment --comment \"default/hostnames: loadbalancer IP\" -j KUBE-MARK-MASQ\n-A KUBE-FW-NWV5X2332I4OT4T3 -m comment --comment \"default/hostnames: loadbalancer IP\" -j KUBE-SVC-NWV5X2332I4OT4T3\n-A KUBE-FW-NWV5X2332I4OT4T3 -m comment --comment \"default/hostnames: loadbalancer IP\" -j KUBE-MARK-DROP\n\n\u307e\u305a\u3001\u4e0b\u8a18\u306e\u30eb\u30fc\u30eb\u304b\u3089\u3001EXTERNAL-IP \u306e\u5bfe\u8c61\u5b9b\u3066\u306e Service \u306e\u30dd\u30fc\u30c8\u5b9b\u3066\u306e\u30d1\u30b1\u30c3\u30c8\u306f\u5168\u3066 KUBE-FW-* \u3067\u51e6\u7406\u3055\u308c\u308b\u3053\u3068\u304c\u5206\u304b\u308b\u3002\n-A KUBE-SERVICES -d 104.199.232.159/32 -p tcp -m comment --comment \"default/hostnames: loadbalancer IP\" -m tcp --dport 80 -j KUBE-FW-NWV5X2332I4OT4T3\n\n\u6b21\u306e\u30eb\u30fc\u30eb\u304b\u3089 KUBE-FW-* \u306b\u6765\u305f\u30d1\u30b1\u30c3\u30c8\u306f\u306f\u5bfe\u5fdc\u3059\u308b KUBE-SVC-* \u3067\u51e6\u7406\u3055\u308c\u308b\u3053\u3068\u304c\u5206\u304b\u308b\u3002 KUBE-MARK-DROP \u306f\u4f55\u3089\u304b\u306e\u7406\u7531\u3067 KUBE-SVC-* \u304c\u306a\u3044\u5834\u5408\u306b\u30d1\u30b1\u30c3\u30c8\u3092\u6368\u3066\u308b\u305f\u3081\u306e\u3082\u306e\u3060\u308d\u3046\u3002\n-A KUBE-FW-NWV5X2332I4OT4T3 -m comment --comment \"default/hostnames: loadbalancer IP\" -j KUBE-MARK-MASQ\n-A KUBE-FW-NWV5X2332I4OT4T3 -m comment --comment \"default/hostnames: loadbalancer IP\" -j KUBE-SVC-NWV5X2332I4OT4T3\n-A KUBE-FW-NWV5X2332I4OT4T3 -m comment --comment \"default/hostnames: loadbalancer IP\" -j KUBE-MARK-DROP\n\nKUBE-SVC-* \u306b\u6765\u305f\u3089\u4eca\u307e\u3067\u306b\u898b\u3066\u304d\u305f Service \u3068\u540c\u69d8\u306a\u306e\u3067\u3001 EXTERNAL-IP \u306b\u6765\u305f\u30d1\u30b1\u30c3\u30c8\u306f\u7d50\u679c\u7684\u306b\u306f Pod \u306b\u8ee2\u9001\u3055\u308c\u308b\u3053\u3068\u304c\u5206\u304b\u308b\u3002\n\nLoadBalancer Service \u306e GCE \u5074\nGCE \u5074\u3082\u78ba\u8a8d\u3059\u308b\u3002\u6700\u521d\u306b\u78ba\u8a8d\u3057\u305f\u901a\u308a\u73fe\u5728\u5b58\u5728\u3059\u308b GKE \u30ce\u30fc\u30c9\u306e GCE \u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306b\u306f\u4e0b\u8a18\u306e\u3088\u3046\u306a\u30bf\u30b0\u304c\u8a2d\u5b9a\u3055\u308c\u3066\u3044\u308b\u3002\n$ gcloud compute instances list --format='table(name,tags.items.map(0).join(\",\"):label=tags)'\nNAME                                         tags\ngke-kube-sandbox-default-pool-88bb8656-26d1  gke-kube-sandbox-5bb78bc1-node,goog-gke-node\n\nGCE \u30d5\u30a1\u30a4\u30a2\u30a6\u30a9\u30fc\u30eb\u3092\u78ba\u8a8d\u3057\u3066\u307f\u308b\u3068\u30ce\u30fc\u30c9\u306e\u30bf\u30b0\u306b\u5bfe\u3057\u3066 Service \u304c export \u3057\u3066\u3044\u308b\u30dd\u30fc\u30c8\u3078\u306e\u901a\u4fe1\u304c\u8a31\u53ef\u3055\u308c\u3066\u3044\u308b\u3002\n$ gcloud compute firewall-rules list --filter=network=kube-sandbox\nNAME                                     NETWORK       SRC_RANGES         RULES                         SRC_TAGS  TARGET_TAGS\nk8s-fw-a0d5edc74edc111e690da42010af0018  kube-sandbox  0.0.0.0/0          tcp:80                                  gke-kube-sandbox-5bb78bc1-node\n\n\u66f4\u306b Service \u306e EXTERNAL-IP \u306e IP \u30a2\u30c9\u30ec\u30b9\u306b\u5bfe\u5fdc\u3059\u308b\u8ee2\u9001\u30eb\u30fc\u30eb\u304c\u4f5c\u3089\u308c\u3066\u3044\u308b\u3002\n$ gcloud compute forwarding-rules list --filter IPAddress=104.199.232.159\nNAME                              REGION      IP_ADDRESS       IP_PROTOCOL  TARGET\na0d5edc74edc111e690da42010af0018  asia-east1  104.199.232.159  TCP          asia-east1/targetPools/a0d5edc74edc111e690da42010af0018\n\n\u8ee2\u9001\u30eb\u30fc\u30eb\u306e\u8ee2\u9001\u5148\u306f\u4e0a\u3067\u78ba\u8a8d\u3057\u305f\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u542b\u3080\u30bf\u30fc\u30b2\u30c3\u30c8\u30d7\u30fc\u30eb\u306b\u5411\u3044\u3066\u3044\u308b\u3053\u3068\u304c\u78ba\u8a8d\u3067\u304d\u308b\u3002\n$ gcloud compute target-pools list a0d5edc74edc111e690da42010af0018 --format='table(name,region,instances.map().basename().join(\",\"))'\nNAME                              REGION      INSTANCES\na0d5edc74edc111e690da42010af0018  asia-east1  gke-kube-sandbox-default-pool-88bb8656-26d1\n\n\u306a\u304a\u3053\u308c\u3089\u306e\u8ee2\u9001\u30eb\u30fc\u30eb\u53ca\u3073\u30bf\u30fc\u30b2\u30c3\u30c8\u30d7\u30fc\u30eb\u306e\u751f\u6210\u306f GCE Cloud Provider Addon \u304c\u884c\u3063\u3066\u3044\u308b\u3002\n\u30bf\u30fc\u30b2\u30c3\u30c8\u30d7\u30fc\u30eb\u3092\u6307\u3059\u8ee2\u9001\u30eb\u30fc\u30eb\u306f GCE \u306e L4 \u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b5\u3067\u3042\u308b Network LoadBalancing \u3068\u3057\u3066\u6a5f\u80fd\u3059\u308b\u306e\u3067\u3001\u8ee2\u9001\u30eb\u30fc\u30eb\u306b\u8a2d\u5b9a\u3055\u308c\u305f\u5916\u90e8 IP \u30a2\u30c9\u30ec\u30b9\u3078\u306e\u30d1\u30b1\u30c3\u30c8\u304c Node \u306b\u8ee2\u9001\u3055\u308c\u308b\u3053\u3068\u304c\u5206\u304b\u308b\u3002\n\u306a\u304a\u3001GCE \u306e Network LoadBalancing \u306f Maglev \u3068\u3057\u3066\u77e5\u3089\u308c\u308b DSR \u578b\u306e\u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b5\u306a\u306e\u3067\u3001\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u304c\u9001\u4fe1\u3057\u305f\u969b\u306e\u9001\u4fe1\u5148 IP \u30a2\u30c9\u30ec\u30b9\u304c\u305d\u306e\u307e\u307e iptables \u3067\u51e6\u7406\u3055\u308c\u308b\u3002(\u53c2\u8003)\n\n\u307e\u3068\u3081\nGKE/GCE/Kubernetes \u3092\u901a\u3057\u3066\u3001\u4e0b\u8a18\u306e\u3088\u3046\u306b Service \u304b\u3089\u4f5c\u3089\u308c\u305f\u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b5\u304b\u3089\u3069\u306e\u3088\u3046\u306b Pod \u307e\u3067\u30d1\u30b1\u30c3\u30c8\u304c\u5c4a\u304f\u304b\u3092\u78ba\u8a8d\u3057\u305f\u3002\n\nGKE \u306e\u30ce\u30fc\u30c9\u9593\u306e\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u306f GCE \u306e\u30eb\u30fc\u30c8\u3067\u30eb\u30fc\u30c6\u30a3\u30f3\u30b0\u3059\u308b\u305f\u3081\u30aa\u30fc\u30d0\u30ec\u30a4\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u306f\u4e0d\u8981\nKubernetes \u306e\u30b3\u30a2\u6a5f\u80fd\u3067\u3042\u308b Service \u306e IP \u30ec\u30a4\u30e4\u306f kube-proxy \u304c\u52d5\u7684\u306b\u751f\u6210\u3057\u305f iptables \u306e\u30eb\u30fc\u30eb\u3092\u4f7f\u3063\u3066 Linux \u30ab\u30fc\u30cd\u30eb\u3067\u51e6\u7406\u3055\u308c\u308b\nGCE Network Load Balancing \u7b49\u3068\u306e\u9023\u643a\u90e8\u5206\u306b\u3064\u3044\u3066\u306f Cloud Provider Addon \u304c\u51e6\u7406\u3059\u308b\n\n\u306a\u304a\u3001 HTTP \u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b5\u306b\u5bfe\u5fdc\u3059\u308b Ingress \u306e\u5b9f\u88c5\u306f\u4eca\u56de\u8aac\u660e\u3057\u305f LoadBalancer Service \u306e\u3082\u306e\u3068\u306f\u5225\u306b\u306a\u3063\u3066\u3044\u308b\u3002\n(\u5177\u4f53\u7684\u306b\u306f\u73fe\u5728 NodePort Service \u3067\u516c\u958b\u3055\u308c\u308b\u30dd\u30fc\u30c8\u3092\u4f7f\u3063\u3066\u5b9f\u73fe\u3055\u308c\u3066\u3044\u308b\u3002GCE Ingress Controller\u306e\u5b9f\u88c5\u3092\u53c2\u7167\u3057\u3066\u307b\u3057\u3044\u3002)\n\n\u53c2\u8003\nService: https://kubernetes.io/docs/user-guide/services/\n\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u30e2\u30c7\u30eb\u5168\u822c: https://kubernetes.io/docs/admin/networking/\nkube-proxy \u306e iptables \u51e6\u7406\u90e8\u5206\u306e\u5b9f\u88c5: https://github.com/kubernetes/kubernetes/blob/v1.5.2/pkg/proxy/iptables/proxier.go\nGKE \u306b\u983c\u3089\u305a\u306b GCE \u53ca\u3073 AWS \u3067\u30af\u30e9\u30b9\u30bf\u3092\u69cb\u6210\u3059\u308b\u30c1\u30e5\u30fc\u30c8\u30ea\u30a2\u30eb: https://github.com/kelseyhightower/kubernetes-the-hard-way\nGoogle \u306b\u3088\u308b\u30d5\u30eb\u30de\u30cd\u30fc\u30b8\u30c9\u30b5\u30fc\u30d3\u30b9\u3067\u3042\u308b GKE \u3067\u306f Kubernetes \u306e\u30de\u30b9\u30bf\u3084\u30ce\u30fc\u30c9\u306e\u3053\u3068\u306f\u7406\u89e3\u3057\u306a\u304f\u3068\u3082 Kubernetes \u306e API \u3092\u4f7f\u3063\u3066\u5b9f\u73fe\u3057\u305f\u3044\u3053\u3068\u306b\u96c6\u4e2d\u3067\u304d\u308b\u3002\n\u3057\u304b\u3057\u3001\u672c\u756a\u904b\u7528\u3092\u306f\u3058\u3081\u3066\u304b\u3089\u300c\u306a\u305c\u52d5\u3044\u3066\u3044\u308b\u306e\u304b\u3082\u306a\u305c\u52d5\u304b\u306a\u3044\u306e\u304b\u3082\u5206\u304b\u3089\u306a\u3044\u300d\u3068\u3044\u3046\u3088\u3046\u306a\u72b6\u614b\u3067\u306f\u3044\u3056\u3068\u3044\u3046\u6642\u306b\u56f0\u308b\u3002\n\u7279\u306b Service \u304c\u3069\u306e\u3088\u3046\u306b\u30af\u30e9\u30b9\u30bf\u306e\u5916\u304b\u3089 Pod \u3078\u306e\u30a2\u30af\u30bb\u30b9\u3092\u63d0\u4f9b\u3057\u3066\u3044\u308b\u306e\u304b\u306f\u30d6\u30e9\u30c3\u30af\u30dc\u30c3\u30af\u30b9\u306b\u306a\u3063\u3066\u3044\u305f\u305f\u3081\u3001\u4eca\u56de\u306f GKE \u3067\u306e Service \u306e L3(\u301cL4) \u306e\u6319\u52d5\u306b\u3064\u3044\u3066 Kubernetes \u306e\u5185\u5916\u3092\u8abf\u67fb\u3057\u305f\u3002\n\n(\u5f8c\u3067\u56f3\u3084\u53c2\u7167\u60c5\u5831\u3078\u306e\u30ea\u30f3\u30af\u3092\u8ffd\u52a0\u4e88\u5b9a)\n\n## \u74b0\u5883\n\nKubernetes ver. 1.5.2(Master & Node)\n\n## GKE \u30af\u30e9\u30b9\u30bf\u306e\u521d\u671f\u8a2d\u5b9a\n\n\u4eca\u56de\u306f\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u3092\u4f5c\u3063\u3066\u305d\u306e\u4e2d\u3067\u4f5c\u696d\u3059\u308b\u3002\n\n```\n$ gcloud compute networks create kube-sandbox\n(\u7701\u7565)\n$ gcloud compute firewall-rules create default-allow-ssh --network kube-sandbox --allow tcp:22\n(\u7701\u7565)\n```\n\n\u4e0a\u3067\u4f5c\u3063\u305f `kube-sandbox` \u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u5185\u306b GKE \u30af\u30e9\u30b9\u30bf\u3092\u4f5c\u6210\u3059\u308b\u3002\u4eca\u56de\u306f\u5358\u7d14\u5316\u306e\u305f\u3081\u30ce\u30fc\u30c9\u306f1\u3068\u3059\u308b\u3002\n\n```\n$ gcloud beta container clusters create --machine-type=g1-small --num-nodes=1 --network=kube-sandbox kube-sandbox\n(\u7701\u7565)\nNAME          ZONE          MASTER_VERSION  MASTER_IP       MACHINE_TYPE  NODE_VERSION  NUM_NODES  STATUS\nkube-sandbox  asia-east1-a  1.5.2           104.199.251.51  g1-small      1.5.2         1          RUNNING\n```\n\n\u73fe\u6642\u70b9\u3067 `kube-sandbox` \u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u306b\u306f\u4e0b\u8a18\u306e\u30eb\u30fc\u30c8\u304c\u81ea\u52d5\u7684\u306b\u8a2d\u5b9a\u3055\u308c\u3066\u3044\u308b\u3002\u5177\u4f53\u7684\u306a\u30ce\u30fc\u30c9\u540d\u7b49\u306f\u74b0\u5883\u3054\u3068\u306b\u9055\u3046\u306e\u3067\u8aad\u307f\u66ff\u3048\u3066\u307b\u3057\u3044\u3002\n\n```\n$ gcloud compute routes list --filter=network=kube-sandbox\nNAME                                                            NETWORK       DEST_RANGE     NEXT_HOP                                                            PRIORITY\ndefault-route-0febf5d565eb04b9                                  kube-sandbox  10.146.0.0/20                                                                      1000\ndefault-route-61d48fa98847c47f                                  kube-sandbox  10.138.0.0/20                                                                      1000\ndefault-route-73c1d7230a9f1444                                  kube-sandbox  10.128.0.0/20                                                                      1000\ndefault-route-7cc26e9102aa6708                                  kube-sandbox  10.142.0.0/20                                                                      1000\ndefault-route-7de16d017205e5de                                  kube-sandbox  10.132.0.0/20                                                                      1000\ndefault-route-e3201908a50d2b01                                  kube-sandbox  0.0.0.0/0      default-internet-gateway                                            1000\ndefault-route-fccedbefa32ce294                                  kube-sandbox  10.140.0.0/20                                                                      1000\ngke-kube-sandbox-5bb78bc1-3ca8c4dd-edb8-11e6-90da-42010af00188  kube-sandbox  10.76.0.0/24   asia-east1-a/instances/gke-kube-sandbox-default-pool-88bb8656-26d1  1000\n```\n\n\u3044\u304b\u306b\u3082 GKE \u306a\u611f\u3058\u306e `gke-kube-sandbox-5bb78bc1-3ca8c4dd-edb8-11e6-90da-42010af00188` \u3068\u3044\u3046\u30eb\u30fc\u30c8\u304c\u3067\u304d\u3066\u304a\u308a `NEXT_HOP` \u306b\u6307\u5b9a\u3055\u308c\u3066\u3044\u308b GCE \u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u304c\u4f5c\u6210\u3057\u305f GKE \u30af\u30e9\u30b9\u30bf\u306e\u30ce\u30fc\u30c9\u3067\u3042\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n\u8a72\u5f53\u3059\u308b\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u78ba\u8a8d\u3059\u308b\u3002\n(\u8868\u793a\u5185\u5bb9\u306e\u8abf\u6574\u306e\u305f\u3081 format \u5185\u3067[projection](https://cloud.google.com/sdk/gcloud/reference/topic/projections) \u3092\u4f7f\u3063\u3066\u3044\u308b\u3002)\n\n```\n$ gcloud compute instances describe gke-kube-sandbox-default-pool-88bb8656-26d1 \\\u2028         --format='table(name,networkInterfaces[0].networkIP, networkInterfaces[0].accessConfigs[0].natIP, tags.items.map(0).join(\",\"):label=TAGS)'\nNAME                                         NETWORK_IP  NAT_IP           TAGS\ngke-kube-sandbox-default-pool-88bb8656-26d1  10.140.0.2  104.199.254.163  gke-kube-sandbox-5bb78bc1-node,goog-gke-node\n```\n\n\u5bfe\u5fdc\u3059\u308b Kubernetes \u5074\u306e Node \u60c5\u5831\u3092\u78ba\u8a8d\u3059\u308b\u3002\n(\u30c7\u30d5\u30a9\u30eb\u30c8\u3067\u306f\u8868\u793a\u3055\u308c\u306a\u3044\u30d5\u30a3\u30fc\u30eb\u30c9\u3092\u629c\u304d\u51fa\u3059\u305f\u3081\u306b `custom-columns` \u306e\u4e2d\u3067 [JSONPath](https://kubernetes.io/docs/user-guide/jsonpath/) \u3092\u4f7f\u3046\u3002)\n\n```\n$ kubectl get node -o custom-columns='NAME:.metadata.name,EXTERNAL-IP:.status.addresses[?(@.type==\"ExternalIP\")].address,INTERNAL-IP:.status.addresses[?(@.type==\"InternalIP\")].address,POD-CIDR:.spec.podCIDR'\nNAME                                          EXTERNAL-IP       INTERNAL-IP   POD-CIDR\ngke-kube-sandbox-default-pool-88bb8656-26d1   104.199.254.163   10.140.0.2    10.76.0.0/24\n```\n\nGCE \u30eb\u30fc\u30c8\u306e `DEST_RANGE` \u3068 Kubernetes Node \u306e `POD-CIDR`, GCE \u30eb\u30fc\u30c8\u306e `NEXT_HOP` \u3068 Kubernetes Node \u306e `NAME` \u304c\u5bfe\u5fdc\u3057\u3066\u3044\u308b\u3053\u3068\u304c\u78ba\u8a8d\u3067\u304d\u305f\u3002\n\u4e00\u5fdc Node \u306e\u4e2d\u306e\u8a2d\u5b9a\u3082\u898b\u3066\u307f\u308b\u3068\u3001 `POD-CIDR` \u306e\u30a2\u30c9\u30ec\u30b9\u7bc4\u56f2\u306f `cbr0` \u30d6\u30ea\u30c3\u30b8\u306b\u5272\u308a\u5f53\u3066\u3089\u308c\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n\n```\n$ gcloud compute ssh user@gke-kube-sandbox-default-pool-88bb8656-26d1 -- ip address show cbr0\n4: cbr0: <BROADCAST,MULTICAST,PROMISC,UP,LOWER_UP> mtu 1460 qdisc htb state UP group default qlen 1000\n    link/ether 0a:58:0a:4c:00:01 brd ff:ff:ff:ff:ff:ff\n    inet 10.76.0.1/24 scope global cbr0\n       valid_lft forever preferred_lft forever\n    inet6 fe80::a42a:16ff:fe06:38a5/64 scope link\n       valid_lft forever preferred_lft forever\n```\n\n\u3053\u306e\u8a18\u4e8b\u3067\u306f L2 \u30ec\u30a4\u30e4\u306e\u30b3\u30f3\u30c6\u30ca\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u306b\u3064\u3044\u3066\u306f\u8aac\u660e\u3057\u306a\u3044\u304c\u3001\u3053\u306e\u30d6\u30ea\u30c3\u30b8\u306b\u305d\u308c\u305e\u308c\u306e Pod \u306e veth \u304c\u30a2\u30bf\u30c3\u30c1\u3055\u308c\u308b\u3002\n(`/24` \u3068\u3044\u3046\u3053\u3068\u306f\u540c\u6642\u306bIP \u30a2\u30c9\u30ec\u30b9\u304c\u5272\u308a\u5f53\u3066\u3089\u308c\u308b Pod \u306f1 Node \u306b\u3064\u304d254\u500b\u3068\u3044\u3046\u3053\u3068\u3092\u610f\u5473\u3059\u308b\u3002 GKE \u306b\u9650\u3063\u3066\u8a00\u3048\u3070 [nodeIpv4CidrSize \u30d5\u30a3\u30fc\u30eb\u30c9](https://cloud.google.com/container-engine/reference/rest/v1/projects.zones.clusters#resource-cluster)\u306f\u5909\u66f4\u4e0d\u53ef\u80fd\u306a\u3088\u3046\u3060\u304b\u3089\u3001\u4ed6\u306e\u30ea\u30bd\u30fc\u30b9\u306b\u4f59\u88d5\u304c\u3042\u3063\u3066\u3082 Pod \u306e\u6570\u306b\u5fdc\u3058\u3066 Node \u3092\u30b9\u30b1\u30fc\u30eb\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u3088\u3046\u306b\u898b\u3048\u308b\u3002)\n\n\u3053\u3053\u307e\u3067\u3067 Pod \u306e IP \u30a2\u30c9\u30ec\u30b9\u304b\u3089\u5bfe\u8c61\u306e GCE \u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3078\u306e\u30eb\u30fc\u30c6\u30a3\u30f3\u30b0\u304c\u884c\u308f\u308c\u3066\u3044\u308b\u3053\u3068\u304c\u5206\u304b\u308b\u3002\n\n\u3053\u308c\u3089\u306e\u8a2d\u5b9a\u306f\u4f55\u3092\u610f\u5473\u3059\u308b\u306e\u3060\u308d\u3046\u304b\u3002\n[Networking](https://kubernetes.io/docs/admin/networking/) \u306b\u3088\u308b\u3068 Kubernetes \u306e\u30b3\u30f3\u30c6\u30ca\u9593\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u306e\u57fa\u672c\u8981\u4ef6\u306f\u4e0b\u8a18\u306e3\u3064\u304c\u3042\u308b\u3002\n\n- \u5168\u3066\u306e\u30b3\u30f3\u30c6\u30ca\u306f\u5225\u306e\u5168\u3066\u306e\u30b3\u30f3\u30c6\u30ca\u3068 NAT \u306a\u3057\u3067\u901a\u4fe1\u3067\u304d\u308b\n- \u5168\u3066\u306e\u30ce\u30fc\u30c9\u306f\u5168\u3066\u306e\u30b3\u30f3\u30c6\u30ca\u3068 NAT \u306a\u3057\u3067\u901a\u4fe1\u3067\u304d\u308b\n\t- \u9006\u3082\u540c\u69d8(\u5168\u3066\u306e\u30b3\u30f3\u30c6\u30ca\u306f\u5168\u3066\u306e\u30ce\u30fc\u30c9\u3068 NAT \u306a\u3057\u3067\u901a\u4fe1\u3067\u304d\u308b)\n- \u30b3\u30f3\u30c6\u30ca\u306f\u81ea\u5206\u81ea\u8eab\u306e IP \u30a2\u30c9\u30ec\u30b9\u3092\u4ed6\u306e\u30b3\u30f3\u30c6\u30ca\u304b\u3089\u898b\u3048\u308b\u306e\u3068\u540c\u3058 IP \u30a2\u30c9\u30ec\u30b9\u3068\u3057\u3066\u898b\u308b\u3053\u3068\u304c\u3067\u304d\u308b\n\n[flannel](https://github.com/coreos/flannel) \u7b49\u306e\u30aa\u30fc\u30d0\u30ec\u30a4\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u3067\u3053\u308c\u3089\u306e\u8981\u4ef6\u306b\u5bfe\u5fdc\u3057\u3066\u3044\u308b\u74b0\u5883\u3082\u3042\u308b\u304c\u3001 GCE \u3067\u306f\u30aa\u30fc\u30d0\u30ec\u30a4\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u304c\u4e0d\u8981\u3068\u3057\u3066\u3044\u308b\u306e\u306f\u3001\u3053\u306e GCE \u30eb\u30fc\u30c8\u306e\u8a2d\u5b9a\u306b\u3088\u308b\u3082\u306e\u3067\u3042\u308b\u3088\u3046\u3060\u3002\n\n\n## Kubernetes \u306e\u4e16\u754c\n\n\u3053\u3053\u304b\u3089\u306f Kubernetes \u306e Service \u304c\u3069\u306e\u3088\u3046\u306b\u52d5\u3044\u3066\u3044\u308b\u304b\u306b\u3064\u3044\u3066\u300c[Debugging Services - Is the kube-proxy working?](https://kubernetes.io/docs/user-guide/debugging-services/#is-the-kube-proxy-working)\u300d\u3092\u53c2\u8003\u306b\u78ba\u8a8d\u3057\u3066\u3044\u304f\u3002 \n\n### kube-proxy\n\nService \u306f [kube-proxy](https://kubernetes.io/docs/admin/kube-proxy/) \u306b\u3088\u308b\u4eee\u60f3 IP \u30a2\u30c9\u30ec\u30b9\u3068 [kube-dns](https://kubernetes.io/docs/admin/dns/) \u306b\u3088\u308b\u540d\u524d\u89e3\u6c7a\u306b\u3088\u3063\u3066\u5b9f\u73fe\u3055\u308c\u3066\u3044\u308b\u304c\u3001\u3053\u306e\u8a18\u4e8b\u3067\u306f L3(\u301cL4) \u306b\u30d5\u30a9\u30fc\u30ab\u30b9\u3059\u308b\u305f\u3081 kube-dns \u306b\u3064\u3044\u3066\u306f\u7279\u306b\u8aac\u660e\u3057\u306a\u3044\u3002\nkube-proxy \u306f Kubernetes 1.2 \u4ee5\u964d\u306f\u52d5\u7684\u306b iptables \u306e\u30eb\u30fc\u30eb\u3092\u64cd\u4f5c ([Proxy-mode: iptables](https://kubernetes.io/docs/user-guide/services/#proxy-mode-iptables)) \u3059\u308b\u3053\u3068\u3067\u3001 Linux \u30ab\u30fc\u30cd\u30eb\u306e netfilter \u3092\u4f7f\u3063\u3066\u52d5\u3044\u3001\u4eee\u60f3 IP \u30a2\u30c9\u30ec\u30b9\u3078\u306e\u30a2\u30af\u30bb\u30b9\u3092\u9069\u5207\u306b Pod \u306b\u8ee2\u9001\u3059\u308b\u3002\n\u306a\u304a\u3001\u904e\u53bb\u306f\u540d\u524d\u901a\u308a\u30e6\u30fc\u30b6\u30b9\u30da\u30fc\u30b9\u306e\u30d7\u30ed\u30ad\u30b7 ([Proxy-mode: userspace](https://kubernetes.io/docs/user-guide/services/#proxy-mode-userspace)) \u3068\u3057\u3066\u52d5\u3044\u3066\u3044\u305f\u3089\u3057\u3044\u3002\n\nSSH \u7d4c\u7531\u3067 GKE \u30ce\u30fc\u30c9\u306e iptables \u306e\u30eb\u30fc\u30eb\u5168\u4f53\u3092\u53d6\u5f97\u3059\u308b\u306b\u306f\u4e0b\u8a18\u306e\u3088\u3046\u306b\u3059\u308b\u3002\n\n```\n$ gcloud compute ssh user@gke-kube-sandbox-default-pool-88bb8656-26d1 -- sudo iptables-save\n```\n\n\u64cd\u4f5c\u3054\u3068\u306b\u5dee\u5206\u306e\u307f\u793a\u3059\u3002\u306a\u304a\u8457\u8005\u306f iptables \u306b\u8a73\u3057\u304f\u306a\u3044\u306e\u3067\u3001 iptables \u81ea\u4f53\u306e\u89e3\u91c8\u306b\u3064\u3044\u3066\u306f\u4ed6\u306e\u8a18\u4e8b\u3082\u53c2\u8003\u306b\u3057\u3066\u307b\u3057\u3044\u3002\n\n(\u6ce8: Kubernetes \u306e\u5916\u306b\u8ee2\u9001\u3059\u308b ExternalName Service \u3068 \u8907\u6570 IP \u30a2\u30c9\u30ec\u30b9\u3092 A \u30ec\u30b3\u30fc\u30c9\u3067\u8fd4\u3059 [Headless Service](https://kubernetes.io/docs/user-guide/services/#headless-services) \u306f DNS \u30d9\u30fc\u30b9\u3067\u4eee\u60f3 IP \u30a2\u30c9\u30ec\u30b9\u3092\u6301\u305f\u306a\u3044\u306e\u3067\u3053\u306e\u8a18\u4e8b\u3067\u306f\u89e6\u308c\u306a\u3044\u3002)\n\n### Service \u306a\u3057\n\n\u307e\u305a\u306f `kubectl run` \u3067\u4f5c\u3063\u305f Deployment \u304b\u3089 Pod \u3092\u8d77\u52d5\u3059\u308b\u3002\n\n```\n$ kubectl run hostnames --image=gcr.io/google_containers/serve_hostname \\\n                        --labels=app=hostnames \\\n                        --port=9376 \\\n                        --replicas=1\ndeployment \"hostnames\" created\n```\n\n\u4e0b\u8a18\u306e\u3088\u3046\u306a IP \u30a2\u30c9\u30ec\u30b9\u3092\u6301\u3063\u305f Pod \u304c\u4f5c\u3089\u308c\u305f\u3002\u3053\u306e\u6642\u70b9\u3060\u3068\u7279\u306b iptables \u306b\u306f\u5909\u5316\u304c\u306a\u3044\u3002\n\n```\n$ kubectl get pod -o wide -l app=hostnames\nNAME                         READY     STATUS    RESTARTS   AGE       IP          NODE\nhostnames-3799501552-jpmdq   1/1       Running   0          6m        10.76.0.9   gke-kube-sandbox-default-pool-88bb8656-26d1\n```\n\n### ClusterIP Service\n\n\u5148\u7a0b\u306e Pod \u306b\u5bfe\u5fdc\u3059\u308b \u306e ClusterIP Service \u3092\u4f5c\u3063\u3066\u307f\u3088\u3046\u3002\n\n```\n$ kubectl expose deployment hostnames --port=80 --target-port=9376\nservice \"hostnames\" exposed\n```\n\n\u4f5c\u3089\u308c\u305f\u3082\u306e\u3092\u78ba\u8a8d\u3057\u3066\u307f\u308b\u3002 Service \u3060\u3051\u3067\u306a\u304f Endpoints \u304c\u3067\u304d\u3066\u3044\u308b\u3053\u3068\u304c\u5206\u304b\u308b\u3002\n\n```\n$ kubectl get pod,endpoints,service -o wide -l app=hostnames\nNAME                            READY     STATUS    RESTARTS   AGE       IP          NODE\npo/hostnames-3799501552-jpmdq   1/1       Running   0          42m       10.76.0.9   gke-kube-sandbox-default-pool-88bb8656-26d1\n\nNAME           ENDPOINTS        AGE\nep/hostnames   10.76.0.9:9376   33m\n\nNAME            CLUSTER-IP    EXTERNAL-IP   PORT(S)   AGE       SELECTOR\nsvc/hostnames   10.79.255.4   <none>        80/TCP    33m       app=hostnames\n```\n\n\u3053\u306e\u6642\u70b9\u3067 iptables \u306b\u306f\u6b21\u306e\u30eb\u30fc\u30eb\u304c\u8ffd\u52a0\u3055\u308c\u3066\u3044\u305f\u3002\n\n```\n-A KUBE-SERVICES ! -s 10.76.0.0/14 -d 10.79.255.4/32 -p tcp -m comment --comment \"default/hostnames: cluster IP\" -m tcp --dport 80 -j KUBE-MARK-MASQ\n-A KUBE-SERVICES -d 10.79.255.4/32 -p tcp -m comment --comment \"default/hostnames: cluster IP\" -m tcp --dport 80 -j KUBE-SVC-NWV5X2332I4OT4T3\n-A KUBE-SVC-NWV5X2332I4OT4T3 -m comment --comment \"default/hostnames:\" -j KUBE-SEP-EV2NQKURMPKCP5UI\n-A KUBE-SEP-EV2NQKURMPKCP5UI -s 10.76.0.9/32 -m comment --comment \"default/hostnames:\" -j KUBE-MARK-MASQ\n-A KUBE-SEP-EV2NQKURMPKCP5UI -p tcp -m comment --comment \"default/hostnames:\" -m tcp -j DNAT --to-destination 10.76.0.9:9376\n```\n\n\u90e8\u5206\u3054\u3068\u306b\u898b\u3066\u3044\u3053\u3046\u3002\n\n```\n-A KUBE-SERVICES ! -s 10.76.0.0/14 -d 10.79.255.4/32 -p tcp -m comment --comment \"default/hostnames: cluster IP\" -m tcp --dport 80 -j KUBE-MARK-MASQ\n```\n\n`10.76.0.0/14` \u306e\u4e2d\u4ee5\u5916\u304b\u3089 ClusterIP \u3078\u306e\u901a\u4fe1\u306f `KUBE-MARK-MASQ` \u306b\u56de\u3055\u308c\u308b\u3088\u3046\u3060\u3002\u4e0a\u3067\u78ba\u8a8d\u3057\u305f `cbr0` \u306e\u30a2\u30c9\u30ec\u30b9\u7a7a\u9593\u306f `10.76.0.0/24` \u3060\u304c\u3001\u7b49\u3057\u304f\u306a\u3044\u306e\u306f\u4f55\u306e\u305f\u3081\u3067\u3001\u3069\u3053\u3067\u8a2d\u5b9a\u3055\u308c\u3066\u3044\u308b\u306e\u304b\uff1f\n\u8a2d\u5b9a\u7b87\u6240\u306f `kube-proxy` \u306e\u8d77\u52d5\u30aa\u30d7\u30b7\u30e7\u30f3\u304c\u7b54\u3048\u3060\u3063\u305f\u3002\u30ce\u30fc\u30c9\u3054\u3068\u306e Pod \u306e\u30a2\u30c9\u30ec\u30b9\u7a7a\u9593\u306e\u4e0a\u306b\u30af\u30e9\u30b9\u30bf\u306e Pod \u306e\u30a2\u30c9\u30ec\u30b9\u7a7a\u9593\u304c\u3042\u308b\u3053\u3068\u304c\u5206\u304b\u308b\u3002\n\n```\n$ gcloud compute ssh user@gke-kube-sandbox-default-pool-88bb8656-26d1 -- ps ax | grep kube-proxy\n 1625 ?        Sl     1:48 kube-proxy --master=https://104.199.251.51 --kubeconfig=/var/lib/kube-proxy/kubeconfig --cluster-cidr=10.76.0.0/14 --resource-container= --v=2\n```\n\n`KUBE-MARK-MASQ` \u306f\u6b21\u306e\u3088\u3046\u306b\u5b9a\u7fa9\u3055\u308c\u3066\u3044\u308b\u4e00\u9023\u306e\u30eb\u30fc\u30eb\u3092\u8aad\u3080\u3068 `POSTROUTING` \u3092\u7d4c\u7531\u3057\u3066 `KUBE-POSTROUTING` \u304b\u3089\u30de\u30b9\u30ab\u30ec\u30fc\u30c9(NAT)\u3059\u308b\u304b\u3069\u3046\u304b\u306e\u5224\u65ad\u306e\u305f\u3081\u306e\u30d5\u30e9\u30b0\u3092\u3064\u3051\u308b\u8a2d\u5b9a\u3060\u3068\u308f\u304b\u308b\u3002\n\u3088\u3063\u3066\u3001\u30af\u30e9\u30b9\u30bf\u5883\u754c\u3092\u8de8\u3050\u901a\u4fe1\u306f NAT \u3055\u308c\u308b\u3053\u3068\u304c\u308f\u304b\u3063\u305f\u3002\n\n```\n-A KUBE-MARK-MASQ -j MARK --set-xmark 0x4000/0x4000\n-A KUBE-POSTROUTING -m comment --comment \"kubernetes service traffic requiring SNAT\" -m mark --mark 0x4000/0x4000 -j MASQUERADE\n-A POSTROUTING -m comment --comment \"kubernetes postrouting rules\" -j KUBE-POSTROUTING\n```\n\n\u6b21\u306e\u30eb\u30fc\u30eb\u3092\u898b\u3066\u307f\u3088\u3046\u3002Cluster IP \u3078\u306e\u901a\u4fe1\u306f `KUBE-SVC-*` \u30c1\u30a7\u30a4\u30f3\u306b\u98db\u3076\u3053\u3068\u304c\u5206\u304b\u308b\u3002\n\n```\n-A KUBE-SERVICES -d 10.79.255.4/32 -p tcp -m comment --comment \"default/hostnames: cluster IP\" -m tcp --dport 80 -j KUBE-SVC-NWV5X2332I4OT4T3\n```\n\n`KUBE-SVC-*` \u30c1\u30a7\u30a4\u30f3\u306f Endpoints \u306b\u5bfe\u5fdc\u3059\u308b `KUBE-SEP-*` \u306b\u98db\u3076\u3002\n\n```\n-A KUBE-SVC-NWV5X2332I4OT4T3 -m comment --comment \"default/hostnames:\" -j KUBE-SEP-EV2NQKURMPKCP5UI\n```\n\n `KUBE-SEP-*` \u306f\u5bfe\u8c61\u306e Pod \u306e ContainerPort \u306b\u5b9b\u5148\u306e IP \u30a2\u30c9\u30ec\u30b9\u3068\u30dd\u30fc\u30c8\u756a\u53f7\u3092\u8ee2\u9001\u3059\u308b\u3002\n\n```\n-A KUBE-SEP-EV2NQKURMPKCP5UI -s 10.76.0.9/32 -m comment --comment \"default/hostnames:\" -j KUBE-MARK-MASQ\n-A KUBE-SEP-EV2NQKURMPKCP5UI -p tcp -m comment --comment \"default/hostnames:\" -m tcp -j DNAT --to-destination 10.76.0.9:9376\n```\n\n\u3053\u3053\u307e\u3067\u3067\u3001 Cluster IP \u3078\u306e\u30a2\u30af\u30bb\u30b9\u304c Service \u3092\u69cb\u6210\u3059\u308b Pod \u3078\u3068\u8ee2\u9001\u3055\u308c\u308b\u3053\u3068\u304c\u308f\u304b\u3063\u305f\u3002\n\n#### Pod \u3092\u30b9\u30b1\u30fc\u30eb\u3059\u308b\n\nPod \u3092\u30b9\u30b1\u30fc\u30eb\u3057\u305f\u5834\u5408\u306e\u5909\u5316\u3092\u78ba\u8a8d\u3059\u308b\u3002\n\n```\n$ kubectl scale deployment hostnames --replicas 2\ndeployment \"hostnames\" scaled\n```\n\n\u8907\u6570\u306e Pod \u306b\u5bfe\u5fdc\u3059\u308b Endpoints \u304c\u51fa\u6765\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n\n```\n$ kubectl get pod,endpoints,service -o wide -l app=hostnames\nNAME                            READY     STATUS    RESTARTS   AGE       IP           NODE\npo/hostnames-3799501552-jpmdq   1/1       Running   0          39m       10.76.0.9    gke-kube-sandbox-default-pool-88bb8656-26d1\npo/hostnames-3799501552-nw2gz   1/1       Running   0          21m       10.76.0.10   gke-kube-sandbox-default-pool-88bb8656-26d1\n\nNAME           ENDPOINTS                        AGE\nep/hostnames   10.76.0.10:9376,10.76.0.9:9376   30m\n\nNAME            CLUSTER-IP    EXTERNAL-IP   PORT(S)   AGE       SELECTOR\nsvc/hostnames   10.79.255.4   <none>        80/TCP    30m       app=hostnames\n```\n\n\u3053\u306e\u6642\u70b9\u3067\u3067\u304d\u305f\u5dee\u5206\u306f\u4e0b\u8a18\u306e\u3088\u3046\u306b\u306a\u308b\u3002\n\n```\n-A KUBE-SEP-BWZ646KDVNVKXICT -s 10.76.0.10/32 -m comment --comment \"default/hostnames:\" -j KUBE-MARK-MASQ\n-A KUBE-SEP-BWZ646KDVNVKXICT -p tcp -m comment --comment \"default/hostnames:\" -m tcp -j DNAT --to-destination 10.76.0.10:9376\n-A KUBE-SVC-NWV5X2332I4OT4T3 -m comment --comment \"default/hostnames:\" -m statistic --mode random --probability 0.50000000000 -j KUBE-SEP-BWZ646KDVNVKXICT\n```\n\n`KUBE-SEP` \u306b\u3064\u3044\u3066\u306f\u3001\u65b0\u3057\u304f\u8ffd\u52a0\u3055\u308c\u305f Pod \u306b\u5bfe\u3057\u3066\u3082\u540c\u69d8\u306b\u30c1\u30a7\u30a4\u30f3\u3092\u8ffd\u52a0\u3057\u3066\u3044\u308b\u3002\n\n```\n-A KUBE-SEP-BWZ646KDVNVKXICT -s 10.76.0.10/32 -m comment --comment \"default/hostnames:\" -j KUBE-MARK-MASQ\n-A KUBE-SEP-BWZ646KDVNVKXICT -p tcp -m comment --comment \"default/hostnames:\" -m tcp -j DNAT --to-destination 10.76.0.10:9376\n```\n\n\u6ce8\u76ee\u3059\u3079\u304d\u306f [statistic module](http://ipset.netfilter.org/iptables-extensions.man.html#lbCD) \u306e random \u30e2\u30fc\u30c9\u3092\u4f7f\u3063\u3066 50% \u305a\u3064\u632f\u308a\u5206\u3051\u3092\u884c\u3063\u3066\u3044\u308b\u3068\u3053\u308d\u3060\u3002\u3053\u308c\u306b\u3088\u308a ClusterIP \u306f\u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b5\u3068\u3057\u3066\u50cd\u304f\u3002\n\n```\n-A KUBE-SVC-NWV5X2332I4OT4T3 -m comment --comment \"default/hostnames:\" -m statistic --mode random --probability 0.50000000000 -j KUBE-SEP-BWZ646KDVNVKXICT\n-A KUBE-SVC-NWV5X2332I4OT4T3 -m comment --comment \"default/hostnames:\" -j KUBE-SEP-EV2NQKURMPKCP5UI\n```\n\n\u5358\u7d14\u5316\u306e\u305f\u3081\u306b\u30ec\u30d7\u30ea\u30ab\u6570\u306f1\u306b\u623b\u3057\u3066\u304a\u3053\u3046\u3002\n\n```\n$ kubectl scale deployment hostnames --replicas 1\ndeployment \"hostnames\" scaled\n```\n\n### NodePort Service\n\n\u3053\u308c\u304b\u3089\u5916\u306b\u516c\u958b\u3059\u308b Service \u3092\u4f5c\u3063\u3066\u307f\u308b\u3002\u307e\u305a\u306f Node \u3067\u3042\u308b\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u30dd\u30fc\u30c8\u3092\u901a\u3057\u3066 Service \u306b\u30a2\u30af\u30bb\u30b9\u3067\u304d\u308b\u3088\u3046\u306b\u3059\u308b NodePort Service \u3060\u3002\n\u524d\u56de\u4f5c\u3063\u305f ClusterIP Service \u3092\u6d88\u3057\u3066\u304b\u3089\u4f5c\u6210\u3059\u308b\u3002\n\n```\n$ kubectl delete service hostnames\nservice \"hostnames\" deleted\n$ kubectl expose deployment hostnames --port=80 --target-port=9376 --type=NodePort\nservice \"hostnames\" exposed\n```\n\n\u4f5c\u3089\u308c\u305f\u30ea\u30bd\u30fc\u30b9\u3092\u898b\u3066\u307f\u308b\u3002 Service \u306e\u30dd\u30fc\u30c8 80 \u304c\u30ce\u30fc\u30c9\u306e\u30dd\u30fc\u30c8 31358 \u306b\u5272\u308a\u5f53\u3066\u3089\u308c\u3066\u3044\u308b\u3053\u3068\u304c\u5206\u304b\u308b\u3002\n\n```\n$ kubectl get pod,endpoints,service -o wide -l app=hostnames\nNAME                            READY     STATUS    RESTARTS   AGE       IP          NODE\npo/hostnames-3799501552-jpmdq   1/1       Running   0          50m       10.76.0.9   gke-kube-sandbox-default-pool-88bb8656-26d1\n\nNAME           ENDPOINTS        AGE\nep/hostnames   10.76.0.9:9376   1m\n\nNAME            CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE       SELECTOR\nsvc/hostnames   10.79.245.174   <nodes>       80:31358/TCP   1m        app=hostnames\n```\n\n`CLUSTER-IP` \u304c\u8a2d\u5b9a\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u304b\u3089\u3082\u3001 ClusterIP Service \u306e\u62e1\u5f35\u3067\u3042\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\niptables \u306b\u306f\u4e0b\u8a18\u306e\u3088\u3046\u306a\u30eb\u30fc\u30eb\u304c\u8ffd\u52a0\u3055\u308c\u305f\u3002\n`KUBE-NODEPORTS` \u306b\u6765\u305f\u3082\u306e\u3067 NodePort \u306b\u5272\u308a\u5f53\u3066\u3089\u308c\u305f\u30dd\u30fc\u30c8\u3042\u3066\u306e\u30d1\u30b1\u30c3\u30c8\u3092\u5bfe\u5fdc\u3059\u308b `KUBE-SVC-*` \u3067\u51e6\u7406\u3059\u308b\u30eb\u30fc\u30eb\u3060\u3068\u308f\u304b\u308b\u3002\n\n```\n-A KUBE-NODEPORTS -p tcp -m comment --comment \"default/hostnames:\" -m tcp --dport 31358 -j KUBE-MARK-MASQ\n-A KUBE-NODEPORTS -p tcp -m comment --comment \"default/hostnames:\" -m tcp --dport 31358 -j KUBE-SVC-NWV5X2332I4OT4T3\n```\n\n`KUBE-NODEPORTS` \u30c1\u30a7\u30a4\u30f3\u3068\u306f\u4f55\u304b\u3068\u3044\u3046\u3068\u3001 `KUBE-SERVICES` \u306b\u6765\u305f\u3082\u306e\u3067\u30ce\u30fc\u30c9\u306e\u30ed\u30fc\u30ab\u30eb\u30a2\u30c9\u30ec\u30b9\u5b9b\u3066\u306e\u30d1\u30b1\u30c3\u30c8\u3060\u3002\n\n```\n-A KUBE-SERVICES -m comment --comment \"kubernetes service nodeports; NOTE: this must be the last rule in this chain\" -m addrtype --dst-type LOCAL -j KUBE-NODEPORTS\n```\n\n\u3053\u308c\u306b\u3088\u308a\u3001\u30ce\u30fc\u30c9\u306e NodePort \u306b\u6765\u305f\u3082\u306e\u304c Service \u306e Endpoints \u3092\u69cb\u6210\u3059\u308b Pod \u306e\u9069\u5207\u306a\u30dd\u30fc\u30c8\u306b\u8ee2\u9001\u3055\u308c\u308b\u3053\u3068\u304c\u5206\u304b\u308b\u3002\n\n### LoadBalancer Service (GKE \u4f9d\u5b58)\n\n\u6700\u5f8c\u306b [LoadBalancer Service](https://kubernetes.io/docs/user-guide/load-balancer/) \u304c\u3069\u306e\u3088\u3046\u306b\u52d5\u304f\u306e\u304b\u3092\u898b\u308b\u3002\n\n\n```\n$ kubectl delete service hostnames\nservice \"hostnames\" deleted\n$ kubectl\nkubectl expose deployment hostnames --port=80 --target-port=9376 --type=LoadBalancer\n```\n\n\u4f5c\u3089\u308c\u305f\u30ea\u30bd\u30fc\u30b9\u3092\u78ba\u8a8d\u3059\u308b\u3002 `EXTERNAL-IP` \u304c\u8a2d\u5b9a\u3055\u308c\u305f\u3002\n\n```\n% kubectl get pod,endpoints,service -o wide -l app=hostnames\nNAME                            READY     STATUS    RESTARTS   AGE       IP          NODE\npo/hostnames-3799501552-jpmdq   1/1       Running   0          55m       10.76.0.9   gke-kube-sandbox-default-pool-88bb8656-26d1\n\nNAME           ENDPOINTS        AGE\nep/hostnames   10.76.0.9:9376   1m\n\nNAME            CLUSTER-IP      EXTERNAL-IP       PORT(S)        AGE       SELECTOR\nsvc/hostnames   10.79.250.127   104.199.232.159   80:30675/TCP   1m        app=hostnames\n```\n\n`PORT` \u3092\u898b\u308b\u3068\u3001 NodePort Service \u306e\u4e0a\u306b\u5b9f\u88c5\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u304c\u5206\u304b\u308b\u3002\niptables \u306b\u306f\u6b21\u306e\u3088\u3046\u306a\u30eb\u30fc\u30eb\u304c\u8ffd\u52a0\u3055\u308c\u305f\u3002\n\n```\n-A KUBE-SERVICES -d 104.199.232.159/32 -p tcp -m comment --comment \"default/hostnames: loadbalancer IP\" -m tcp --dport 80 -j KUBE-FW-NWV5X2332I4OT4T3\n-A KUBE-FW-NWV5X2332I4OT4T3 -m comment --comment \"default/hostnames: loadbalancer IP\" -j KUBE-MARK-MASQ\n-A KUBE-FW-NWV5X2332I4OT4T3 -m comment --comment \"default/hostnames: loadbalancer IP\" -j KUBE-SVC-NWV5X2332I4OT4T3\n-A KUBE-FW-NWV5X2332I4OT4T3 -m comment --comment \"default/hostnames: loadbalancer IP\" -j KUBE-MARK-DROP\n```\n\n\u307e\u305a\u3001\u4e0b\u8a18\u306e\u30eb\u30fc\u30eb\u304b\u3089\u3001`EXTERNAL-IP` \u306e\u5bfe\u8c61\u5b9b\u3066\u306e Service \u306e\u30dd\u30fc\u30c8\u5b9b\u3066\u306e\u30d1\u30b1\u30c3\u30c8\u306f\u5168\u3066 `KUBE-FW-*` \u3067\u51e6\u7406\u3055\u308c\u308b\u3053\u3068\u304c\u5206\u304b\u308b\u3002\n\n```\n-A KUBE-SERVICES -d 104.199.232.159/32 -p tcp -m comment --comment \"default/hostnames: loadbalancer IP\" -m tcp --dport 80 -j KUBE-FW-NWV5X2332I4OT4T3\n```\n\n\u6b21\u306e\u30eb\u30fc\u30eb\u304b\u3089 `KUBE-FW-*` \u306b\u6765\u305f\u30d1\u30b1\u30c3\u30c8\u306f\u306f\u5bfe\u5fdc\u3059\u308b `KUBE-SVC-*` \u3067\u51e6\u7406\u3055\u308c\u308b\u3053\u3068\u304c\u5206\u304b\u308b\u3002 `KUBE-MARK-DROP` \u306f\u4f55\u3089\u304b\u306e\u7406\u7531\u3067 `KUBE-SVC-*` \u304c\u306a\u3044\u5834\u5408\u306b\u30d1\u30b1\u30c3\u30c8\u3092\u6368\u3066\u308b\u305f\u3081\u306e\u3082\u306e\u3060\u308d\u3046\u3002\n\n```\n-A KUBE-FW-NWV5X2332I4OT4T3 -m comment --comment \"default/hostnames: loadbalancer IP\" -j KUBE-MARK-MASQ\n-A KUBE-FW-NWV5X2332I4OT4T3 -m comment --comment \"default/hostnames: loadbalancer IP\" -j KUBE-SVC-NWV5X2332I4OT4T3\n-A KUBE-FW-NWV5X2332I4OT4T3 -m comment --comment \"default/hostnames: loadbalancer IP\" -j KUBE-MARK-DROP\n```\n\n`KUBE-SVC-*` \u306b\u6765\u305f\u3089\u4eca\u307e\u3067\u306b\u898b\u3066\u304d\u305f Service \u3068\u540c\u69d8\u306a\u306e\u3067\u3001 `EXTERNAL-IP` \u306b\u6765\u305f\u30d1\u30b1\u30c3\u30c8\u306f\u7d50\u679c\u7684\u306b\u306f Pod \u306b\u8ee2\u9001\u3055\u308c\u308b\u3053\u3068\u304c\u5206\u304b\u308b\u3002\n\n#### LoadBalancer Service \u306e GCE \u5074\n\nGCE \u5074\u3082\u78ba\u8a8d\u3059\u308b\u3002\u6700\u521d\u306b\u78ba\u8a8d\u3057\u305f\u901a\u308a\u73fe\u5728\u5b58\u5728\u3059\u308b GKE \u30ce\u30fc\u30c9\u306e GCE \u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306b\u306f\u4e0b\u8a18\u306e\u3088\u3046\u306a\u30bf\u30b0\u304c\u8a2d\u5b9a\u3055\u308c\u3066\u3044\u308b\u3002\n\n```\n$ gcloud compute instances list --format='table(name,tags.items.map(0).join(\",\"):label=tags)'\nNAME                                         tags\ngke-kube-sandbox-default-pool-88bb8656-26d1  gke-kube-sandbox-5bb78bc1-node,goog-gke-node\n```\n\nGCE \u30d5\u30a1\u30a4\u30a2\u30a6\u30a9\u30fc\u30eb\u3092\u78ba\u8a8d\u3057\u3066\u307f\u308b\u3068\u30ce\u30fc\u30c9\u306e\u30bf\u30b0\u306b\u5bfe\u3057\u3066 Service \u304c export \u3057\u3066\u3044\u308b\u30dd\u30fc\u30c8\u3078\u306e\u901a\u4fe1\u304c\u8a31\u53ef\u3055\u308c\u3066\u3044\u308b\u3002\n\n```\n$ gcloud compute firewall-rules list --filter=network=kube-sandbox\nNAME                                     NETWORK       SRC_RANGES         RULES                         SRC_TAGS  TARGET_TAGS\nk8s-fw-a0d5edc74edc111e690da42010af0018  kube-sandbox  0.0.0.0/0          tcp:80                                  gke-kube-sandbox-5bb78bc1-node\n```\n\n\u66f4\u306b Service \u306e `EXTERNAL-IP` \u306e IP \u30a2\u30c9\u30ec\u30b9\u306b\u5bfe\u5fdc\u3059\u308b\u8ee2\u9001\u30eb\u30fc\u30eb\u304c\u4f5c\u3089\u308c\u3066\u3044\u308b\u3002\n\n```\n$ gcloud compute forwarding-rules list --filter IPAddress=104.199.232.159\nNAME                              REGION      IP_ADDRESS       IP_PROTOCOL  TARGET\na0d5edc74edc111e690da42010af0018  asia-east1  104.199.232.159  TCP          asia-east1/targetPools/a0d5edc74edc111e690da42010af0018\n```\n\n\u8ee2\u9001\u30eb\u30fc\u30eb\u306e\u8ee2\u9001\u5148\u306f\u4e0a\u3067\u78ba\u8a8d\u3057\u305f\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u542b\u3080\u30bf\u30fc\u30b2\u30c3\u30c8\u30d7\u30fc\u30eb\u306b\u5411\u3044\u3066\u3044\u308b\u3053\u3068\u304c\u78ba\u8a8d\u3067\u304d\u308b\u3002\n\n```\n$ gcloud compute target-pools list a0d5edc74edc111e690da42010af0018 --format='table(name,region,instances.map().basename().join(\",\"))'\nNAME                              REGION      INSTANCES\na0d5edc74edc111e690da42010af0018  asia-east1  gke-kube-sandbox-default-pool-88bb8656-26d1\n```\n\n\u306a\u304a\u3053\u308c\u3089\u306e\u8ee2\u9001\u30eb\u30fc\u30eb\u53ca\u3073\u30bf\u30fc\u30b2\u30c3\u30c8\u30d7\u30fc\u30eb\u306e\u751f\u6210\u306f [GCE Cloud Provider Addon](https://github.com/kubernetes/kubernetes/blob/master/pkg/cloudprovider/providers/gce/gce.go) \u304c\u884c\u3063\u3066\u3044\u308b\u3002\n\n\u30bf\u30fc\u30b2\u30c3\u30c8\u30d7\u30fc\u30eb\u3092\u6307\u3059\u8ee2\u9001\u30eb\u30fc\u30eb\u306f GCE \u306e L4 \u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b5\u3067\u3042\u308b [Network LoadBalancing](https://cloud.google.com/compute/docs/load-balancing/network/) \u3068\u3057\u3066\u6a5f\u80fd\u3059\u308b\u306e\u3067\u3001\u8ee2\u9001\u30eb\u30fc\u30eb\u306b\u8a2d\u5b9a\u3055\u308c\u305f\u5916\u90e8 IP \u30a2\u30c9\u30ec\u30b9\u3078\u306e\u30d1\u30b1\u30c3\u30c8\u304c Node \u306b\u8ee2\u9001\u3055\u308c\u308b\u3053\u3068\u304c\u5206\u304b\u308b\u3002\n\n\u306a\u304a\u3001GCE \u306e Network LoadBalancing \u306f [Maglev](https://research.google.com/pubs/pub44824.html) \u3068\u3057\u3066\u77e5\u3089\u308c\u308b DSR \u578b\u306e\u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b5\u306a\u306e\u3067\u3001\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u304c\u9001\u4fe1\u3057\u305f\u969b\u306e\u9001\u4fe1\u5148 IP \u30a2\u30c9\u30ec\u30b9\u304c\u305d\u306e\u307e\u307e iptables \u3067\u51e6\u7406\u3055\u308c\u308b\u3002([\u53c2\u8003](https://www.school.ctc-g.co.jp/columns/nakai2/nakai201.html))\n\n## \u307e\u3068\u3081\n\nGKE/GCE/Kubernetes \u3092\u901a\u3057\u3066\u3001\u4e0b\u8a18\u306e\u3088\u3046\u306b Service \u304b\u3089\u4f5c\u3089\u308c\u305f\u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b5\u304b\u3089\u3069\u306e\u3088\u3046\u306b Pod \u307e\u3067\u30d1\u30b1\u30c3\u30c8\u304c\u5c4a\u304f\u304b\u3092\u78ba\u8a8d\u3057\u305f\u3002\n\n- GKE \u306e\u30ce\u30fc\u30c9\u9593\u306e\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u306f GCE \u306e\u30eb\u30fc\u30c8\u3067\u30eb\u30fc\u30c6\u30a3\u30f3\u30b0\u3059\u308b\u305f\u3081\u30aa\u30fc\u30d0\u30ec\u30a4\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u306f\u4e0d\u8981\n- Kubernetes \u306e\u30b3\u30a2\u6a5f\u80fd\u3067\u3042\u308b Service \u306e IP \u30ec\u30a4\u30e4\u306f kube-proxy \u304c\u52d5\u7684\u306b\u751f\u6210\u3057\u305f iptables \u306e\u30eb\u30fc\u30eb\u3092\u4f7f\u3063\u3066 Linux \u30ab\u30fc\u30cd\u30eb\u3067\u51e6\u7406\u3055\u308c\u308b\n- GCE Network Load Balancing \u7b49\u3068\u306e\u9023\u643a\u90e8\u5206\u306b\u3064\u3044\u3066\u306f [Cloud Provider Addon](https://github.com/kubernetes/kubernetes/blob/master/pkg/cloudprovider/providers/gce/gce.go) \u304c\u51e6\u7406\u3059\u308b\n\n\u306a\u304a\u3001 HTTP \u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b5\u306b\u5bfe\u5fdc\u3059\u308b [Ingress](https://kubernetes.io/docs/user-guide/ingress/) \u306e\u5b9f\u88c5\u306f\u4eca\u56de\u8aac\u660e\u3057\u305f LoadBalancer Service \u306e\u3082\u306e\u3068\u306f\u5225\u306b\u306a\u3063\u3066\u3044\u308b\u3002\n(\u5177\u4f53\u7684\u306b\u306f\u73fe\u5728 NodePort Service \u3067\u516c\u958b\u3055\u308c\u308b\u30dd\u30fc\u30c8\u3092\u4f7f\u3063\u3066\u5b9f\u73fe\u3055\u308c\u3066\u3044\u308b\u3002[GCE Ingress Controller](https://github.com/kubernetes/ingress/tree/master/controllers/gce)\u306e\u5b9f\u88c5\u3092\u53c2\u7167\u3057\u3066\u307b\u3057\u3044\u3002)\n\n## \u53c2\u8003\n\nService: https://kubernetes.io/docs/user-guide/services/\n\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u30e2\u30c7\u30eb\u5168\u822c: https://kubernetes.io/docs/admin/networking/\nkube-proxy \u306e iptables \u51e6\u7406\u90e8\u5206\u306e\u5b9f\u88c5: https://github.com/kubernetes/kubernetes/blob/v1.5.2/pkg/proxy/iptables/proxier.go\nGKE \u306b\u983c\u3089\u305a\u306b GCE \u53ca\u3073 AWS \u3067\u30af\u30e9\u30b9\u30bf\u3092\u69cb\u6210\u3059\u308b\u30c1\u30e5\u30fc\u30c8\u30ea\u30a2\u30eb: https://github.com/kelseyhightower/kubernetes-the-hard-way\n", "tags": ["gcp", "kubernetes", "GKE", "GoogleContainerEngine", "GoogleCloudPlatform"]}