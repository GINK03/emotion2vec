{"context": " More than 1 year has passed since last update.\n\n\u306f\u3058\u3081\u306b\nBitVisor \u306bVMMCALL\u3092\u8ffd\u52a0\u3059\u308b\u65b9\u6cd5\u3092\u8aac\u660e\u3057\u307e\u3059\uff0e\n\u672c\u65e5\u306f\u30aa\u30fc\u30b9\u30c8\u30ea\u30a2\u3088\u308aBitVisor \u60c5\u5831\u3092\u304a\u5c4a\u3051\u306a\u306e\u3067\uff0c\u30bd\u30fc\u30b9\u30b3\u30fc\u30c9\u306e\u52d5\u4f5c\u78ba\u8a8d\u306a\u3069\u3067\u304d\u3066\u307e\u305b\u3093\uff0e\n\u305d\u308c\u306a\u306e\u306b\u95a2\u6570\u540d\u3092\u624b\u3067\u76f4\u3057\u305f\u308a\u3057\u3066\u308b\u306e\u3067\uff0c\u591a\u5206\u3069\u3053\u304b\u52d5\u304b\u306a\u3044\u90e8\u5206\u304c\u3042\u308b\u3068\u601d\u3044\u307e\u3059\uff0e\n\u3067\u3082\u307e\u3041\uff0c\u3060\u3044\u305f\u3044\u306e\u611f\u3058\u306f\u3064\u304b\u3093\u3067\u3082\u3089\u3048\u308b\u304b\u3068\u601d\u3044\u307e\u3059\uff0e\n\nVMMCALL \u3063\u3066 \u4f55?\nVMMCALL \u3068\u3044\u3046\u306e\u306f\uff0c\u30b2\u30b9\u30c8OS\u304b\u3089VMM\u306b\u6a5f\u80fd\u3092\u547c\u3073\u51fa\u3059\u6a5f\u69cb\u3067\u3059\uff0e\n\u30b2\u30b9\u30c8OS\u306fvmmcall \u3068\u3044\u3046CPU\u547d\u4ee4\u3092\u767a\u884c\u3059\u308b\u3053\u3068\u3067VMM\u306e\u6a5f\u80fd\u3092\u547c\u3073\u51fa\u305b\u307e\u3059\uff0e\n\u69cb\u9020\u3068\u3057\u3066\u306f\uff0c\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30ec\u30a4\u30e4\u304b\u3089\u30b7\u30b9\u30c6\u30e0\u30b3\u30fc\u30eb\u3092\u547c\u3073\u51fa\u3059\u306e\u306b\u4f3c\u3066\u3044\u307e\u3059\uff0e\n\u30b2\u30b9\u30c8OS\u304b\u3089VMM\u5185\u306e\u60c5\u5831\u3092\u53d6\u5f97\u3057\u305f\u308a\uff0c\u4f55\u304b\u6307\u793a\u3092\u51fa\u3059\u306e\u306b\u6709\u7528\u306a\u6a5f\u80fd\u3067\u3059\uff0e\nBitVisor \u3067\u306f\uff0cdbgsh(\u30c7\u30d0\u30c3\u30b0\u7528\u306e\u30b7\u30a7\u30eb)\u306a\u3069\u304c\uff0cVMMCALL\u3092\u7528\u3044\u3066\u5b9f\u73fe\u3055\u308c\u3066\u3044\u307e\u3059\uff0e\n\nVMMCALL \u3092\u8ffd\u52a0\u3059\u308b\u65b9\u6cd5\ncore/vmmcall_hello.c \u3063\u3066\u306a\u611f\u3058\u306e\u30d5\u30a1\u30a4\u30eb\u3092\u8ffd\u52a0\u3057\u307e\u3057\u3087\u3046\uff0e\n\u4e2d\u8eab\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u611f\u3058\u3067\uff0e\n\ncore/vmmcall_hello.c\nstatic void\nhello(void)\n{\n  ulong rbx;\n  ulong ret = 10;\n\n  /*\u5f15\u6570\u306e\u53d7\u3051\u53d6\u308a*/\n  current->vmctl.read_general_reg (GENERAL_REG_RBX, &rbx);\n\n  printf(\"Hello BitVisor!, arg1 = %d\\n\", rbx);\n\n  /*\u623b\u308a\u5024\u306e\u683c\u7d0d*/\n  current->vmctl.write_general_reg (GENERAL_REG_RAX, (ulong)ret);\n}\n\n/* \u95a2\u6570\u306e\u767b\u9332 */\n\nstatic void\nvmmcall_hello_init(void)\n{\n  vmmcall_register(\"hello\", hello);\n}\nINITFUNC (\"vmmcal0\", vmmcall_hello_init);\n\n\n\nVMMCALL \u3092\u547c\u3073\u51fa\u3059\u65b9\u6cd5\uff0e\nMakefile \u3084\u3089\u306a\u3093\u3084\u3089\u5fc5\u8981\u3067\uff0c\u4e00\u304b\u3089\u5168\u90e8\u66f8\u304f\u306e\u306f\u9762\u5012\u306a\u306e\u3067\uff0cBitVisor \u5185\u3067\u3059\u3067\u306b\u5b9a\u7fa9\u3057\u3066\u3044\u308bVMMCALL\u3092\u30b3\u30d4\u30da\u3057\u3066\u4e2d\u3092\u5909\u3048\u3066\uff0c\u65b0\u3057\u3044VMMCALL\u3092\u8db3\u3057\u3066\u307f\u307e\u3057\u3087\u3046\uff0e\n\u3068\u3044\u3046\u308f\u3051\u3067\uff0cVMMCALL \u3092\u3064\u304b\u3063\u3066\u3044\u308bdbgsh\u3092\u62dd\u501f\u3057\u307e\u3057\u3087\u3046\uff0e\n\u4ee5\u4e0b\u306e\u6e96\u5099\u306f\u30b2\u30b9\u30c8OS\u4e0a\u3067\u884c\u3044\u307e\u3059\uff0e\n\u307e\u305a\uff0ctools/dbgsh \u3092\u30b3\u30d4\u30fc\ncd ~/bitvisor/tool/\ncp -r dbgsh hello\n\n\u30d5\u30a1\u30a4\u30eb\u540d\u306e\u5909\u66f4\ncd hello\nmv dbgsh.c hello.c\n\nMakefile \u306e\u5909\u66f4\nMakefile \u5185\u306edbgsh\u3092hello\u306b\u7f6e\u63db(sed\u3068\u304bM-%\u3068\u304b\u3067)\nwindows \u7528\u306e\u30d0\u30a4\u30ca\u30ea\u304c\u4e0d\u8981\u306a\u5834\u5408\u306f\u4ee5\u4e0b\u3092\u524a\u9664(\u3053\u306e\u4f5c\u696d\u306f\u8981\u3089\u306a\u3044\u304b\u3082)\n\u5148\u982d3\u884c\nall: \u884c\u306e my_vmmcall.exe\nmy_vmmcall.exe : \u306e\u884c\u3068\u305d\u306e\u6b21\u306e\u884c\u3059\u3079\u3066\n\u547c\u3073\u51fa\u3057\u5074\u306e\u30b3\u30fc\u30c9\u306e\u30d7\u30ed\u30b0\u30e9\u30e0\u3092\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u66f8\u304d\u63db\u3048\u307e\u3059\uff0e\n\ntools/hello/hello.c\nstatic void\nvmmcall_hello (int arg)\n{\ncall_vmm_function_t f; /*vmm call \u306b\u95a2\u3059\u308b\u60c5\u5831\u3092\u683c\u7d0d*/\ncall_vmm_arg_t a; /*vmm call \u306b\u6e21\u3059\u5f15\u6570\u3092\u683c\u7d0d*/\ncall_vmm_ret_t r; /*vmm call \u306e\u623b\u308a\u5024\u3092\u683c\u7d0d*/\n\nCALL_VMM_GET_FUNCTION (\"hello\", &f); /*vmm call \u306e\u540d\u524d\u304b\u3089\u95a2\u6570\u306b\u95a2\u3059\u308b\u60c5\u5831\u3092\u53d6\u5f97*/\n/*\u30a8\u30e9\u30fc\u51e6\u7406*/\nif (!call_vmm_function_callable (&f)) {\n    fprintf (stderr, \"vmmcall \\\"hello\\\" failed\\n\");\n    exit (1);\n}\na.rbx = (long)c;                     /*\u5f15\u6570\u3092\u8a2d\u5b9a*/\ncall_vmm_call_function (&f, &a, &r); /*vmm call \u547c\u3073\u51fa\u3057*/\nreturn (int)r.rax;                   /*\u623b\u308a\u5024\u306e\u53d6\u5f97*/\n\n\n\u3067\uff0c\u30d3\u30eb\u30c9\u3057\u3066\u52d5\u304b\u3057\u3066\u307f\u307e\u3057\u3087\u3046\uff0e\n$ make\n\nBitVisor \u304c\u52d5\u3044\u3066\u308b\u72b6\u614b\u3067\n$ ./hello\n\n\u3063\u3066\u3084\u308c\u3070\u52d5\u304f(\u306f\u305a(\u306f\u305a))\n\n# \u306f\u3058\u3081\u306b\nBitVisor \u306bVMMCALL\u3092\u8ffd\u52a0\u3059\u308b\u65b9\u6cd5\u3092\u8aac\u660e\u3057\u307e\u3059\uff0e\n\u672c\u65e5\u306f\u30aa\u30fc\u30b9\u30c8\u30ea\u30a2\u3088\u308aBitVisor \u60c5\u5831\u3092\u304a\u5c4a\u3051\u306a\u306e\u3067\uff0c\u30bd\u30fc\u30b9\u30b3\u30fc\u30c9\u306e\u52d5\u4f5c\u78ba\u8a8d\u306a\u3069\u3067\u304d\u3066\u307e\u305b\u3093\uff0e\n\u305d\u308c\u306a\u306e\u306b\u95a2\u6570\u540d\u3092\u624b\u3067\u76f4\u3057\u305f\u308a\u3057\u3066\u308b\u306e\u3067\uff0c\u591a\u5206\u3069\u3053\u304b\u52d5\u304b\u306a\u3044\u90e8\u5206\u304c\u3042\u308b\u3068\u601d\u3044\u307e\u3059\uff0e\n\u3067\u3082\u307e\u3041\uff0c\u3060\u3044\u305f\u3044\u306e\u611f\u3058\u306f\u3064\u304b\u3093\u3067\u3082\u3089\u3048\u308b\u304b\u3068\u601d\u3044\u307e\u3059\uff0e\n\n# VMMCALL \u3063\u3066 \u4f55?\nVMMCALL \u3068\u3044\u3046\u306e\u306f\uff0c\u30b2\u30b9\u30c8OS\u304b\u3089VMM\u306b\u6a5f\u80fd\u3092\u547c\u3073\u51fa\u3059\u6a5f\u69cb\u3067\u3059\uff0e\n\u30b2\u30b9\u30c8OS\u306f`vmmcall` \u3068\u3044\u3046CPU\u547d\u4ee4\u3092\u767a\u884c\u3059\u308b\u3053\u3068\u3067VMM\u306e\u6a5f\u80fd\u3092\u547c\u3073\u51fa\u305b\u307e\u3059\uff0e\n\u69cb\u9020\u3068\u3057\u3066\u306f\uff0c\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30ec\u30a4\u30e4\u304b\u3089\u30b7\u30b9\u30c6\u30e0\u30b3\u30fc\u30eb\u3092\u547c\u3073\u51fa\u3059\u306e\u306b\u4f3c\u3066\u3044\u307e\u3059\uff0e\n\n\u30b2\u30b9\u30c8OS\u304b\u3089VMM\u5185\u306e\u60c5\u5831\u3092\u53d6\u5f97\u3057\u305f\u308a\uff0c\u4f55\u304b\u6307\u793a\u3092\u51fa\u3059\u306e\u306b\u6709\u7528\u306a\u6a5f\u80fd\u3067\u3059\uff0e\nBitVisor \u3067\u306f\uff0cdbgsh(\u30c7\u30d0\u30c3\u30b0\u7528\u306e\u30b7\u30a7\u30eb)\u306a\u3069\u304c\uff0cVMMCALL\u3092\u7528\u3044\u3066\u5b9f\u73fe\u3055\u308c\u3066\u3044\u307e\u3059\uff0e\n\n# VMMCALL \u3092\u8ffd\u52a0\u3059\u308b\u65b9\u6cd5\n\n`core/vmmcall_hello.c` \u3063\u3066\u306a\u611f\u3058\u306e\u30d5\u30a1\u30a4\u30eb\u3092\u8ffd\u52a0\u3057\u307e\u3057\u3087\u3046\uff0e\n\u4e2d\u8eab\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u611f\u3058\u3067\uff0e\n\n``` c:core/vmmcall_hello.c\nstatic void\nhello(void)\n{\n  ulong rbx;\n  ulong ret = 10;\n\n  /*\u5f15\u6570\u306e\u53d7\u3051\u53d6\u308a*/\n  current->vmctl.read_general_reg (GENERAL_REG_RBX, &rbx);\n\n  printf(\"Hello BitVisor!, arg1 = %d\\n\", rbx);\n\n  /*\u623b\u308a\u5024\u306e\u683c\u7d0d*/\n  current->vmctl.write_general_reg (GENERAL_REG_RAX, (ulong)ret);\n}\n\n/* \u95a2\u6570\u306e\u767b\u9332 */\n\nstatic void\nvmmcall_hello_init(void)\n{\n  vmmcall_register(\"hello\", hello);\n}\nINITFUNC (\"vmmcal0\", vmmcall_hello_init);\n```\n\n\n\n\n# VMMCALL \u3092\u547c\u3073\u51fa\u3059\u65b9\u6cd5\uff0e\n\nMakefile \u3084\u3089\u306a\u3093\u3084\u3089\u5fc5\u8981\u3067\uff0c\u4e00\u304b\u3089\u5168\u90e8\u66f8\u304f\u306e\u306f\u9762\u5012\u306a\u306e\u3067\uff0cBitVisor \u5185\u3067\u3059\u3067\u306b\u5b9a\u7fa9\u3057\u3066\u3044\u308bVMMCALL\u3092\u30b3\u30d4\u30da\u3057\u3066\u4e2d\u3092\u5909\u3048\u3066\uff0c\u65b0\u3057\u3044VMMCALL\u3092\u8db3\u3057\u3066\u307f\u307e\u3057\u3087\u3046\uff0e\n\u3068\u3044\u3046\u308f\u3051\u3067\uff0cVMMCALL \u3092\u3064\u304b\u3063\u3066\u3044\u308bdbgsh\u3092\u62dd\u501f\u3057\u307e\u3057\u3087\u3046\uff0e\n\n\u4ee5\u4e0b\u306e\u6e96\u5099\u306f\u30b2\u30b9\u30c8OS\u4e0a\u3067\u884c\u3044\u307e\u3059\uff0e\n\n\u307e\u305a\uff0ctools/dbgsh \u3092\u30b3\u30d4\u30fc\n\n```\ncd ~/bitvisor/tool/\ncp -r dbgsh hello\n```\n\n\u30d5\u30a1\u30a4\u30eb\u540d\u306e\u5909\u66f4\n\n```\ncd hello\nmv dbgsh.c hello.c\n```\n\nMakefile \u306e\u5909\u66f4\nMakefile \u5185\u306edbgsh\u3092hello\u306b\u7f6e\u63db(sed\u3068\u304bM-%\u3068\u304b\u3067)\n\n\nwindows \u7528\u306e\u30d0\u30a4\u30ca\u30ea\u304c\u4e0d\u8981\u306a\u5834\u5408\u306f\u4ee5\u4e0b\u3092\u524a\u9664(\u3053\u306e\u4f5c\u696d\u306f\u8981\u3089\u306a\u3044\u304b\u3082)\n\u5148\u982d3\u884c\nall: \u884c\u306e my_vmmcall.exe\nmy_vmmcall.exe : \u306e\u884c\u3068\u305d\u306e\u6b21\u306e\u884c\u3059\u3079\u3066\n\n\n\n\u547c\u3073\u51fa\u3057\u5074\u306e\u30b3\u30fc\u30c9\u306e\u30d7\u30ed\u30b0\u30e9\u30e0\u3092\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u66f8\u304d\u63db\u3048\u307e\u3059\uff0e\n\n``` c:tools/hello/hello.c\nstatic void\nvmmcall_hello (int arg)\n{\ncall_vmm_function_t f; /*vmm call \u306b\u95a2\u3059\u308b\u60c5\u5831\u3092\u683c\u7d0d*/\ncall_vmm_arg_t a; /*vmm call \u306b\u6e21\u3059\u5f15\u6570\u3092\u683c\u7d0d*/\ncall_vmm_ret_t r; /*vmm call \u306e\u623b\u308a\u5024\u3092\u683c\u7d0d*/\n\nCALL_VMM_GET_FUNCTION (\"hello\", &f); /*vmm call \u306e\u540d\u524d\u304b\u3089\u95a2\u6570\u306b\u95a2\u3059\u308b\u60c5\u5831\u3092\u53d6\u5f97*/\n/*\u30a8\u30e9\u30fc\u51e6\u7406*/\nif (!call_vmm_function_callable (&f)) {\n\tfprintf (stderr, \"vmmcall \\\"hello\\\" failed\\n\");\n\texit (1);\n}\na.rbx = (long)c;                     /*\u5f15\u6570\u3092\u8a2d\u5b9a*/\ncall_vmm_call_function (&f, &a, &r); /*vmm call \u547c\u3073\u51fa\u3057*/\nreturn (int)r.rax;                   /*\u623b\u308a\u5024\u306e\u53d6\u5f97*/\n```\n\n\u3067\uff0c\u30d3\u30eb\u30c9\u3057\u3066\u52d5\u304b\u3057\u3066\u307f\u307e\u3057\u3087\u3046\uff0e\n\n```\n$ make\n```\n\nBitVisor \u304c\u52d5\u3044\u3066\u308b\u72b6\u614b\u3067\n\n```\n$ ./hello\n```\n\n\u3063\u3066\u3084\u308c\u3070\u52d5\u304f(\u306f\u305a(\u306f\u305a))\n", "tags": ["BitVisor"]}