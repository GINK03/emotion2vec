{"context": "\n\n\u306f\u3058\u3081\u306b\nAWS EC2 \u306eAmazon Linux\u3092\u60f3\u5b9a\u3057\u3001Postfix\u3001Dovecot\u3001amavisd\u3001Postfixadmin\u3067\u69cb\u7bc9\u3057\u305f\u3068\u304d\u306e\u30e1\u30e2\u3067\u3059\u3002\n\u30c9\u30e1\u30a4\u30f3\u306e\u767b\u9332\u3001Elastic IP\u306e\u5272\u308a\u5f53\u3066\u3001\u30dd\u30fc\u30c8 22, 25, 80, 143, 443, 465, 587, 993 \u306f\u3001\u958b\u3051\u3066\u3042\u308b\u3082\u306e\u3068\u3057\u307e\u3059\u3002\n\n\u30e1\u30fc\u30eb\u30b5\u30fc\u30d0\u30fc\u306e\u63a5\u7d9a\u69cb\u6210\n\n\n\n\u30bf\u30a4\u30d7\n\u30dd\u30fc\u30c8\u756a\u53f7\n\u6697\u53f7\u5316\u306e\u7a2e\u985e\n\n\n\n\nSMTP\n25\n--\n\n\nSMTPS\n465\nSSL/TLS\n\n\nSMTP\n587\nSTARTTLS\n\n\nIMAP\n143\nSTARTTLS\n\n\nIMAPS\n993\nSSL/TLS\n\n\n\n\n\u69cb\u7bc9\u6642\u306e\u5404\u30d0\u30fc\u30b8\u30e7\u30f3\n\n\n\n\u30a2\u30d7\u30ea\u306a\u3069\n\u30d0\u30fc\u30b8\u30e7\u30f3\n\n\n\n\nApache\n2.4.18\n\n\nPHP\n5.6.19\n\n\nMysql\n5.6.29\n\n\nPostfix\n2.6.6\n\n\nDovecot\n2.2.10\n\n\npostfixadmin\n2.93\n\n\n\n\u3000\n\u4eca\u56de\u306f\u3001\u4e0b\u8a18\u306e\u3088\u3046\u306a\u65b9\u6cd5\u3067 \u30b5\u30d6\u30c9\u30e1\u30a4\u30f3\u3067\u30a2\u30af\u30bb\u30b9\u3059\u308b\u30bf\u30a4\u30d7\u306b\u306a\u308a\u307e\u3059\u3002\nhttps://admin.\u30c9\u30e1\u30a4\u30f3\u540d/postfixadmin\n\u3000\n\u3000\n\u3000\n\u3000\n\nWEB\u30b5\u30fc\u30d0\u30fc\u306e\u69cb\u7bc9\n\u65e2\u306b\u69cb\u7bc9\u6e08\u307f\u306e\u5834\u5408\u306f\u3001\u8aad\u307f\u98db\u3070\u3057\u3066\u304b\u307e\u308f\u306a\u3044\u3067\u3059\u3002\n\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\uff06\u30b5\u30fc\u30d3\u30b9\u306e\u767b\u9332\n\nweb\u30b5\u30fc\u30d0\u30fc\n$ sudo yum install -y gcc httpd24 httpd24-devel mod24_ssl libcap-devel\n$ sudo yum install -y php56 php56-mbstring php56-mcrypt php56-opcache php56-mysqlnd php56-gd php56-devel php56-imap\n$ sudo chkconfig httpd on\n\n\n\nmod_ruid2\u306e\u4f5c\u6210\n\u30d0\u30fc\u30c1\u30e3\u30eb\u30db\u30b9\u30c8\u6bce\u306b\u3001\u6a29\u9650\u3092\u5909\u3048\u305f\u304b\u3063\u305f\u306e\u3067\u3001mod_ruid2\u3092\u4f7f\u3044\u307e\u3059\u3002\n\u307e\u305a\u306f\u3001\u4e0b\u8a18\u306e\u30b5\u30a4\u30c8\u304b\u3089DL\u3057\u89e3\u51cd\u3057\u307e\u3057\u3087\u3046\u3002\nhttps://github.com/mind04/mod-ruid2\n\nDL\u3068\u89e3\u51cd\u3068\u30d3\u30eb\u30c9\n$ wget https://github.com/mind04/mod-ruid2/archive/master.zip\n$ unzip master.zip\n$ sudo apxs -i -c -l cap mod-ruid2-master/mod_ruid2.c\n\n\n\n\u30d3\u30eb\u30c9\u5f8c\n----------------------------------------------------------------------\nLibraries have been installed in:\n   /usr/lib64/httpd/modules\n\nIf you ever happen to want to link against installed libraries\nin a given directory, LIBDIR, you must either use libtool, and\nspecify the full pathname of the library, or use the `-LLIBDIR'\nflag during linking and do at least one of the following:\n   - add LIBDIR to the `LD_LIBRARY_PATH' environment variable\n     during execution\n   - add LIBDIR to the `LD_RUN_PATH' environment variable\n     during linking\n   - use the `-Wl,-rpath -Wl,LIBDIR' linker flag\n   - have your system administrator add LIBDIR to `/etc/ld.so.conf'\n\nSee any operating system documentation about shared libraries for\nmore information, such as the ld(1) and ld.so(8) manual pages.\n----------------------------------------------------------------------\nchmod 755 /usr/lib64/httpd/modules/mod_ruid2.so\n\n\n\u30d3\u30eb\u30c9\u5f8c\u3001\u3053\u306e\u3088\u3046\u306a\u30e1\u30c3\u30bb\u30fc\u30b8\u304c\u3067\u308c\u3070\u3001\u4f7f\u7528\u53ef\u80fd\u306b\u306a\u308a\u307e\u3059\u3002\n\u901a\u5e38\u3001\u81ea\u52d5\u3067httpd.conf\u5185\u306b\u66f8\u304d\u8fbc\u307e\u308c\u307e\u3059\u304c\u3001\u7121\u3044\u5834\u5408\u3001\u4ee5\u4e0b\u306e\u7269\u3092\u66f8\u304d\u8fbc\u3093\u3067\u304f\u3060\u3055\u3044\u3002\n\n/etc/httpd/conf/httpd.conf\n# Example:\n# LoadModule foo_module modules/mod_foo.so\n#\nLoadModule ruid2_module modules/mod_ruid2.so\n\n\n\u65b0\u898f\u306bpostfixadmin\u3067\u4f7f\u7528\u3059\u308b\u30d0\u30fc\u30c1\u30e3\u30eb\u30db\u30b9\u30c8\u3092\u4f5c\u308a\u307e\u3059\u3002\n\n\u30d0\u30fc\u30c1\u30e3\u30eb\u30db\u30b9\u30c8\u306e\u4f5c\u6210\n$ sudo vim apache:/etc/httpd/conf.d/admin.conf\n\n\n\n/etc/httpd/conf.d/admin.conf\n<IfModule mod_ssl.c>\n<VirtualHost *:443>\n    ServerName admin.\u30c9\u30e1\u30a4\u30f3\u540d:443\n    DocumentRoot /home/ec2-user/www/admin\n    <Directory \"/home/ec2-user/www/admin\">\n      Options -Indexes\n      Require all granted\n      Allow from all\n      AllowOverride All\n    </Directory>\n\n    <IfModule mod_ruid2.c>\n        RMode    config\n        RUidGid  ec2-user ec2-user\n        #RGroups  apachetmp\n    </IfModule>\n\n    SSLEngine on\n\n    SSLCertificateFile    /etc/pki/tls/certs/localhost.crt\n    SSLCertificateKeyFile /etc/pki/tls/private/localhost.key\n\n    <FilesMatch \"\\.(php)$\">\n        SSLOptions +StdEnvVars\n    </FilesMatch>\n\n    BrowserMatch \".*MSIE.*\" \\\n        nokeepalive ssl-unclean-shutdown \\\n        downgrade-1.0 force-response-1.0\n\n    CustomLog logs/dmin_www_ssl_log \\\n          \"%t %h %{SSL_PROTOCOL}x %{SSL_CIPHER}x \\\"%r\\\" %b\"\n\n    ErrorLog logs/admin_www_ssl_err\n</VirtualHost>\n</IfModule>\n\n\n\u500b\u3005\u306e\u74b0\u5883\u306b\u5408\u308f\u305b\u3066\u8a2d\u5b9a\u3057\u3066\u304f\u3060\u3055\u3044\u3002\u3055\u3089\u306b\u3001BASIC\u8a8d\u8a3c\u3092\u4ed8\u3051\u52a0\u3048\u3066\u3082\u826f\u3044\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u3002\n\u3061\u306a\u307f\u306b\u3001/home/ec2-user/www/admin \u306e\u4e2d\u306b\u3001postfixadmin\u3092\u5165\u308c\u307e\u3059\u3002\n\u307b\u304b\u306b\u3082\u3001phpMyAdmin\u306a\u3069\u3001\u7ba1\u7406\u8005\u7528\u306eweb\u30a2\u30d7\u30ea\u3092\u5165\u308c\u3066\u3082\u826f\u3044\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u3002\n/home/ec2-user/www/admin \u306e\u4e2d\u306b\u3001\u4e0b\u8a18\u306e index.php \u3092\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\nindex.php\n<?php\nheader('HTTP', true, 404);\n?>\n404 (Not Found)\n\n\n\nweb\u30b5\u30fc\u30d0\u30fc\u306e\u8d77\u52d5\n$ sudo service httpd start\n\n\nhttps://admin.\u30c9\u30e1\u30a4\u30f3\u540d/\nweb\u30b5\u30fc\u30d0\u30fc\u3092\u8d77\u52d5\u5f8c\u3001404 (Not Found)\u304c\u8868\u793a\u3055\u308c\u3066\u3044\u308b\u304b\u78ba\u304b\u3081\u3066\u304f\u3060\u3055\u3044\u3002\n\u3000\n\u3000\n\u3000\n\u3000\n\nMysql\u306e\u69cb\u7bc9\n\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\uff06\u30b5\u30fc\u30d3\u30b9\u306e\u767b\u9332\n\nDB\n$ sudo yum install -y mysql56 mysql56-server\n$ sudo chkconfig mysqld on\n$ sudo service mysqld start\n\n\n\nphpMyAdmin\u306e\u3059\u3059\u3081\nhttps://www.phpmyadmin.net/ \u3088\u308a\u3001\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\uff06\u89e3\u51cd\u3057\n/home/ec2-user/www/admin \u3078phpMyAdmin\u3092\u5165\u308c\u308b\u3053\u3068\u3092\u304a\u3059\u3059\u3081\u3057\u307e\u3059\u3002\n\u5c11\u3057\u8a2d\u5b9a\u3059\u308b\u3060\u3051\u3067\u3001\u76f4\u3050\u306b\u4f7f\u7528\u3067\u304d\u307e\u3059\u3002\u8a73\u3057\u3044\u8aac\u660e\u306f\u3001\u30b0\u30b0\u3063\u3066\u304f\u3060\u3055\u3044\u3002\n\n\u30e1\u30fc\u30eb\u30b5\u30fc\u30d0\u30fc\u3067\u4f7f\u7528\u3059\u308b\u3001\u30e6\u30fc\u30b6\u30fc\u3068DB\u3092\u4f5c\u6210\n\n\u30e6\u30fc\u30b6\u30fc\u3068DB\u306e\u4f5c\u6210\nCREATE USER 'postfix'@'localhost' IDENTIFIED BY 'postfix\u306e\u30d1\u30b9\u30ef\u30fc\u30c9';\nCREATE DATABASE postfix CHARACTER SET utf8;\nGRANT ALL ON postfix.* to postfix@localhost;\n\n\n\u3000\n\u3000\n\u3000\n\u3000\n\n\u30e1\u30fc\u30eb\u30b5\u30fc\u30d0\u30fc\u306e\u69cb\u7bc9\n\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\uff06\u30b5\u30fc\u30d3\u30b9\u306e\u767b\u9332\n$ sudo yum install -y postfix\u3000dovecot dovecot-mysql\n$ sudo chkconfig postfix on\n$ sudo chkconfig dovecot on\n\n\nMTA\u306e\u5207\u308a\u5909\u3048\n$ sudo alternatives --config mta\n  \u9078\u629e       \u30b3\u30de\u30f3\u30c9\n-----------------------------------------------\n*+ 1           /usr/sbin/sendmail.sendmail\n   2           /usr/sbin/sendmail.postfix\n\nEnter \u3092\u62bc\u3057\u3066\u73fe\u5728\u306e\u9078\u629e [+] \u3092\u4fdd\u6301\u3059\u308b\u304b\u3001\u9078\u629e\u756a\u53f7\u3092\u5165\u529b\u3057\u307e\u3059:2\n\n2\u756a\u3092\u9078\u629e\u3057\u3066\u7d42\u308f\u308a\u3002\n\u3000\n\n\u30d0\u30fc\u30c1\u30e3\u30eb\u30c9\u30e1\u30a4\u30f3\u7528\u306e\u30e6\u30fc\u30b6\u3068\u30e1\u30fc\u30eb\u7528\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306e\u4f5c\u6210\n$ sudo groupadd -g 10000 vmail\n$ sudo useradd -g vmail -u 10000 vmail -d /var/mail\n$ sudo mkdir -p /var/mail/vhosts\n$ sudo mkdir -p /var/mail/bin\n$ sudo mkdir -p /var/mail/deleted-vhosts\n$ sudo chmod -R 0700 /var/mail\n$ sudo chown -R vmail:vmail /var/mail\n\n\u3000\n\nsmtpd\u7528\u306b\u6697\u53f7\u5316\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u308b\ndh2048.pem\u304a\u3088\u3073dh512.pem\u306f\u3001Postfix SMTP\u30b5\u30fc\u30d0\u304cEDH\u6697\u53f7\u3067\u4f7f\u3046DH\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u6301\u3064\u30d5\u30a1\u30a4\u30eb\u3002\ncert.pem\u306f\u3001PEM\u30d5\u30a9\u30fc\u30de\u30c3\u30c8\u306e\u3001Postfix SMTP\u30b5\u30fc\u30d0RSA\u8a3c\u660e\u66f8\u3092\u6301\u3064\u30d5\u30a1\u30a4\u30eb\u3002 \nprivkey.pem\u306f\u3001PEM\u30d5\u30a9\u30fc\u30de\u30c3\u30c8\u3067\u306e\u3001Postfix SMTP\u30b5\u30fc\u30d0RSA\u30d7\u30e9\u30a4\u30d9\u30fc\u30c8\u30ad\u30fc\u3092\u6301\u3064\u30d5\u30a1\u30a4\u30eb\u3002\nconsole:\n$ sudo mkdir -p /etc/postfix/ssl/dhparams/\n$ sudo openssl dhparam -out /etc/postfix/ssl/dhparams/dh2048.pem 2048\n$ sudo openssl dhparam -out /etc/postfix/ssl/dhparams/dh512.pem 512\n$ sudo mkdir -p /etc/postfix/ssl/selfsigned/\n$ sudo openssl req -new -newkey rsa:4096 -days 3658 -sha256 -nodes -x509 \\\n      -subj \"/C=JP/ST=Shizuoka/L=Shizuoka/O=Mailserver certificate/OU=Mail/CN=www.\u30c9\u30e1\u30a4\u30f3\u540d/emailAddress=admin@\u30c9\u30e1\u30a4\u30f3\u540d\" \\\n      -keyout /etc/postfix/ssl/selfsigned/privkey.pem \\\n      -out /etc/postfix/ssl/selfsigned/cert.pem\n$ sudo chown -R vmail:vmail /var/mail\n\n-subj \u306f\u3001\u500b\u3005\u306e\u74b0\u5883\u306b\u5408\u308f\u305b\u3066\u304f\u3060\u3055\u3044\u3002\n\npostfix\u306e\u8a2d\u5b9a\n\n\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u3078\u306e\u30a2\u30af\u30bb\u30b9\u7528\u306e\u30af\u30a8\u30ea\u4f5c\u6210\n\n\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306e\u4f5c\u6210\n$ sudo mkdir -p /etc/postfix/mysql\n\n\n\nvirtual-alias-maps.cf\n\nvirtual-alias-maps.cf\n$ sudo vim /etc/postfix/mysql/virtual-alias-maps.cf\n\n\n\n/etc/postfix/mysql/virtual-alias-maps.cf\nhosts    = localhost\nuser     = postfix\npassword = postfix\u306e\u30d1\u30b9\u30ef\u30fc\u30c9\ndbname   = postfix\n\nquery = SELECT goto FROM alias WHERE address='%s' AND active = 1\n\n\n\nvirtual-mailbox-domains.cf\n\nvirtual-mailbox-domains.cf\n$ sudo vim /etc/postfix/mysql/virtual-mailbox-domains.cf\n\n\n\n/etc/postfix/mysql/virtual-mailbox-domains.cf\nhosts    = localhost\nuser     = postfix\npassword = postfix\u306e\u30d1\u30b9\u30ef\u30fc\u30c9\ndbname   = postfix\n\nquery = SELECT domain FROM domain WHERE domain='%s' and backupmx = 0 and active = 1\n\n\n\nvirtual-mailbox-maps.cf\n\nvirtual-mailbox-maps.cf\n$ sudo vim /etc/postfix/mysql/virtual-mailbox-maps.cf\n\n\n\n/etc/postfix/mysql/virtual-mailbox-maps.cf\nhosts    = localhost\nuser     = postfix\npassword = postfix\u306e\u30d1\u30b9\u30ef\u30fc\u30c9\ndbname   = postfix\n\nquery = SELECT maildir FROM mailbox WHERE username='%s' AND active = 1\n\n\n\nvirtual-mailbox-limit-maps.cf\n\nvirtual-mailbox-limit-maps.cf\n$ sudo vim /etc/postfix/mysql/virtual-mailbox-limit-maps.cf\n\n\n\n/etc/postfix/mysql/virtual-mailbox-limit-maps.cf\nuser = postfix\npassword = postfix\u306e\u30d1\u30b9\u30ef\u30fc\u30c9\nhosts = localhost\ndbname = postfix\nquery = SELECT quota FROM mailbox WHERE username='%s' AND active = '1'\n\n\n\u3000\n\u3000\n\nmain.cf\u306e\u7de8\u96c6\n\nmain.cf\u306e\u7de8\u96c6\n$ sudo vim /etc/postfix/main.cf\n\n\n\n/etc/postfix/main.cf\nmyhostname = mail.\u30c9\u30e1\u30a4\u30f3\u540d\nmydomain = \u30c9\u30e1\u30a4\u30f3\u540d\nmyorigin = $mydomain\ninet_interfaces = all\ninet_protocols = ipv4\nmydestination = localhost localhost.$mydomain\nmynetworks = 127.0.0.0/8\nheader_checks = regexp:/etc/postfix/header_checks\nmime_header_checks = regexp:/etc/postfix/header_checks\nsmtpd_banner = $myhostname ESMTP $mail_name\nreadme_directory = no\nmailbox_command = procmail -a \"$EXTENSION\"\nrecipient_delimiter  = +\nbiff                 = no\nappend_dot_mydomain  = no\ndelay_warning_time   = 4h\ndisable_vrfy_command = yes\nmessage_size_limit   = 51200000\nmailbox_size_limit   = 102400000\n\n\n#\n# \u30dd\u30b9\u30c8\u30de\u30b9\u30bf\u30fc\u306b\u5831\u544a\u3055\u308c\u308b\u30a8\u30e9\u30fc\u30af\u30e9\u30b9\u306e\u30ea\u30b9\u30c8\n# \u983b\u7e41\u306b\u9001\u3089\u308c\u3066\u90aa\u9b54\u306a\u5834\u5408\u306f\u3001\u30b3\u30e1\u30f3\u30c8\u3057\u3066OK\n#\nnotify_classes = resource, software\nerror_notice_recipient     = admin@\u30c9\u30e1\u30a4\u30f3\u540d\n\n\n#\n# Smtp\n#\nsmtp_tls_loglevel            = 1\nsmtp_tls_security_level      = may\n#smtp_tls_CAfile              = \nsmtp_tls_protocols           = !SSLv2, !SSLv3\nsmtp_tls_mandatory_protocols = !SSLv2, !SSLv3\nsmtp_tls_mandatory_ciphers   = high\nsmtp_tls_exclude_ciphers     = aNULL, eNULL, EXPORT, DES, 3DES, RC2, RC4, MD5, PSK, SRP, DSS, AECDH, ADH\nsmtp_tls_note_starttls_offer = yes\n\n#\n# Smtpd\n#\nsmtpd_tls_loglevel            = 1\nsmtpd_tls_auth_only           = yes\nsmtpd_tls_security_level      = may\nsmtpd_tls_received_header     = yes\nsmtpd_tls_protocols           = !SSLv2, !SSLv3\nsmtpd_tls_mandatory_protocols = !SSLv2, !SSLv3\nsmtpd_tls_mandatory_ciphers   = medium\n\n#smtpd_tls_CAfile              = $smtp_tls_CAfile\nsmtpd_tls_cert_file           = /etc/postfix/ssl/selfsigned/cert.pem\nsmtpd_tls_key_file            = /etc/postfix/ssl/selfsigned/privkey.pem\nsmtpd_tls_dh1024_param_file   = /etc/postfix/ssl/dhparams/dh2048.pem\nsmtpd_tls_dh512_param_file    = /etc/postfix/ssl/dhparams/dh512.pem\n\ntls_preempt_cipherlist = yes\ntls_random_source      = dev:/dev/urandom\n\nsmtp_tls_session_cache_database  = btree:${data_directory}/smtp_scache\nsmtpd_tls_session_cache_database = btree:${data_directory}/smtpd_scache\nlmtp_tls_session_cache_database  = btree:${data_directory}/lmtp_scache\n\n\n#\n# SASL\n#\n\nsmtpd_sasl_auth_enable          = yes\nsmtpd_sasl_type                 = dovecot\nsmtpd_sasl_path                 = private/auth\nsmtpd_sasl_security_options     = noanonymous\nsmtpd_sasl_tls_security_options = $smtpd_sasl_security_options\nsmtpd_sasl_local_domain         = $mydomain\nsmtpd_sasl_authenticated_header = yes\n\nbroken_sasl_auth_clients = yes\n\n#\n# Virtual mail box\n#\n\nvirtual_uid_maps        = static:10000\nvirtual_gid_maps        = static:10000\nvirtual_minimum_uid     = 10000\nvirtual_mailbox_base    = /var/mail/vhosts\nvirtual_transport       = lmtp:unix:private/dovecot-lmtp\nvirtual_mailbox_domains = mysql:/etc/postfix/mysql/virtual-mailbox-domains.cf\nvirtual_mailbox_maps    = mysql:/etc/postfix/mysql/virtual-mailbox-maps.cf\nvirtual_alias_maps      = mysql:/etc/postfix/mysql/virtual-alias-maps.cf\n\n# \u5bb9\u91cf\u5236\u9650\nvirtual_create_maildirsize = yes\nvirtual_mailbox_extended   = yes\nvirtual_mailbox_limit      = 102400000\nvirtual_mailbox_limit_maps = mysql:/etc/postfix/mysql/virtual-mailbox-limit-maps.cf\nvirtual_mailbox_limit_override = yes\nvirtual_maildir_limit_message = Sorry, the user's maildir has overdrawn his diskspace quota, please try again later.\nvirtual_overquota_bounce = yes \n\n\n#\n# \u30a2\u30af\u30bb\u30b9\u5236\u9650\n#\n\nsmtpd_recipient_restrictions =\n     permit_mynetworks,\n     permit_sasl_authenticated,\n     reject_non_fqdn_recipient,\n     reject_unauth_destination,\n     reject_unknown_recipient_domain,\n     reject_rbl_client all.rbl.jp,\n     reject_rbl_client bl.spamcop.net,\n     reject_rbl_client zen.spamhaus.org\n\nsmtpd_helo_restrictions =\n     permit_mynetworks,\n     permit_sasl_authenticated,\n     reject_invalid_helo_hostname,\n     reject_non_fqdn_helo_hostname\n\nsmtpd_client_restrictions =\n     permit_mynetworks,\n     permit_inet_interfaces,\n     permit_sasl_authenticated\n\nsmtpd_sender_restrictions =\n     reject_non_fqdn_sender,\n     reject_unknown_sender_domain\n\n\n\nmynetworks \u306f\u3001\u500b\u3005\u306e\u74b0\u5883\u306b\u5408\u308f\u305b\u3066\u304f\u3060\u3055\u3044\u3002\n\u3000\n\u3000\n\nheader_checks\u306e\u7de8\u96c6\n\u30d8\u30c3\u30c0\u30c1\u30a7\u30c3\u30af\u30d5\u30a1\u30a4\u30eb\u306e\u8a2d\u5b9a\u3092\u3057\u307e\u3059\u3002\n\nheader_checks\n$ sudo vim /etc/postfix/header_checks\n\n\n\n/etc/postfix/header_checks\n/^Received:.*with ESMTPSA/  IGNORE\n/^X-Originating-IP:/        IGNORE\n/^X-Mailer:/                IGNORE\n/^User-Agent:/              IGNORE\n\n\n\u5fc5\u8981\u306b\u5fdc\u3058\u3066\u8ffd\u52a0\n\nheader_checks\n$ sudo postmap /etc/postfix/header_checks\n\n\n\nmaster.cf\u306e\u7de8\u96c6\n\nheader_checks\n$ sudo vim /etc/postfix/master.cf\n\n\n\n/etc/postfix/header_checks\nsubmission inet n       -       n       -       -       smtpd\n  -o syslog_name=postfix/submission\n  -o smtpd_tls_dh1024_param_file=/etc/postfix/ssl/dhparams/dh2048.pem\n  -o smtpd_tls_security_level=encrypt\n  -o smtpd_sasl_auth_enable=yes\n  -o smtpd_client_restrictions=permit_sasl_authenticated,reject\n#  -o milter_macro_daemon_name=ORIGINATING\n465       inet  n       -       n       -       -       smtpd\n  -o syslog_name=postfix/smtps\n  -o smtpd_tls_wrappermode=yes\n  -o smtpd_sasl_auth_enable=yes\n  -o smtpd_reject_unlisted_recipient=no\n  -o smtpd_client_restrictions=permit_sasl_authenticated,reject\n\n\n\u3000\n\u3000\n\u3000\n\nDovecot\u306e\u8a2d\u5b9a\n\ndovecot.conf\u306e\u7de8\u96c6\n\ndovecot.conf\u306e\u7de8\u96c6\n$ sudo vim /etc/dovecot/dovecot.conf\n\n\n\n/etc/dovecot/dovecot.conf\nprotocols = imap lmtp\nlisten = *\n#mail_debug = yes\n\n\n\u6700\u521d\u306e\u3046\u3061\u306f\u3001** mail_debug = yes** \u3067\u69d8\u5b50\u898b\u3057\u305f\u307b\u3046\u304c\u826f\u3044\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u3002\n\u3000\n\ndovecot-sql.conf.ext\u306e\u4f5c\u6210\n\ndovecot.conf\u306e\u7de8\u96c6\n$ sudo vim /etc/dovecot/dovecot-sql.conf.ext\n\n\n\n/etc/dovecot/dovecot-sql.conf.ext\ndriver   = mysql\nconnect  = host=localhost dbname=postfix user=postfix password=postfix\u30d1\u30b9\u30ef\u30fc\u30c9\ndefault_pass_scheme = SHA512-CRYPT\npassword_query = SELECT password FROM mailbox WHERE username = '%u' AND active='1'\nuser_query = SELECT CONCAT('/var/mail/vhosts/', maildir) AS mail, 10000 AS uid, 10000 AS gid, CONCAT('*:bytes=', quota) AS quota_rule FROM mailbox WHERE username = '%u' AND active='1'\n\n\n\n10-auth.conf\u306e\u7de8\u96c6\n\n10-auth.conf\u306e\u7de8\u96c6\n$ sudo vim /etc/dovecot/conf.d/10-auth.conf\n\n\n\n/etc/dovecot/conf.d/10-auth.conf\ndisable_plaintext_auth = yes\nauth_mechanisms = plain login\n#!include auth-system.conf.ext\n!include auth-sql.conf.ext\n\n\n\n10-mail.conf\u306e\u7de8\u96c6\n\n10-mail.conf\u306e\u7de8\u96c6\n$ sudo vim /etc/dovecot/conf.d/10-mail.conf\n\n\n\n/etc/dovecot/conf.d/10-mail.conf\nmail_location = maildir:/var/mail/vhosts/%d/%n/\nmaildir_stat_dirs=yes\n\nmail_uid = 10000\nmail_gid = 10000\n\nfirst_valid_uid = 10000\nlast_valid_uid = 10000\n\nmail_privileged_group = vmail\n\n\n\n10-master.conf\u306e\u7de8\u96c6\n\n10-mail.conf\u306e\u7de8\u96c6\n$ sudo vim /etc/dovecot/conf.d/10-master.conf\n\n\n\n/etc/dovecot/conf.d/10-master.conf\nservice imap-login {\n  inet_listener imap {\n    port = 143\n  }\n  inet_listener imaps {\n    port = 993\n    ssl = yes\n  }\n  service_count = 0\n}\n\nservice lmtp {\n  unix_listener /var/spool/postfix/private/dovecot-lmtp {\n    mode = 0666\n    user = postfix\n    group = postfix\n  }\n}\n\nservice auth {\n  unix_listener /var/spool/postfix/private/auth {\n    mode = 0666\n    user = postfix\n    group = postfix\n  }\n\n  unix_listener auth-userdb {\n    mode = 0600\n    user = vmail\n    group = vmail\n  }\n\n  user = dovecot\n}\n\nservice auth-worker {\n  user = vmail\n}\n\n\n\n10-ssl.conf\u306e\u7de8\u96c6\n\n10-ssl.conf\u306e\u7de8\u96c6\n$ sudo vim /etc/dovecot/conf.d/10-ssl.conf\n\n\n\n/etc/dovecot/conf.d/10-ssl.conf\nssl_cert = </etc/postfix/ssl/selfsigned/cert.pem\nssl_key = </etc/postfix/ssl/selfsigned/privkey.pem\nssl_cipher_list = EECDH+AES:EDH+AES+aRSA\nssl_prefer_server_ciphers = yes\nssl_dh_parameters_length = 2048\n\n\n\n15-mailboxes.conf\u306e\u7de8\u96c6\n\n15-mailboxes.conf\u306e\u7de8\u96c6\n$ sudo vim /etc/dovecot/conf.d/15-mailboxes.conf\n\n\n\n/etc/dovecot/conf.d/15-mailboxes.conf\nnamespace inbox {\n  mailbox Drafts {\n    special_use = \\Drafts\n    auto=subscribe\n  }\n  mailbox Junk {\n    special_use = \\Junk\n    auto=subscribe\n  }\n  mailbox Trash {\n    special_use = \\Trash\n    auto=subscribe\n  }\n  mailbox Sent {\n    special_use = \\Sent\n    auto=subscribe\n  }\n}\n\n\n\n20-lmtp.conf\u306e\u7de8\u96c6\n\n20-lmtp.conf\u306e\u7de8\u96c6\n$ sudo vim /etc/dovecot/conf.d/20-lmtp.conf\n\n\n\n/etc/dovecot/conf.d/20-lmtp.conf\nprotocol lmtp {\n  postmaster_address = postmaster@\u30c9\u30e1\u30a4\u30f3\u540d\n  mail_plugins = $mail_plugins\n}\n\n\n\nauth-sql.conf.ext\u306e\u7de8\u96c6\n\nauth-sql.conf.ext\u306e\u7de8\u96c6\n$ sudo vim /etc/dovecot/conf.d/auth-sql.conf.ext\n\n\n\n/etc/dovecot/conf.d/auth-sql.conf.ext\nuserdb {\n  driver = sql\n  args = /etc/dovecot/dovecot-sql.conf.ext\n}\n\n\n\u3000\n\nPostfix & Dovecot \u8d77\u52d5\n$ sudo service postfix start\n$ sudo service dovecot start\n\n\u3000\n\u3000\n\u3000\n\npostfixadmin\n\u3053\u3053\u3067\u306f\u30d0\u30fc\u30b8\u30e7\u30f32.93\u3067\u3059\u304c\u3001\u6700\u65b0\u7248\u3092\u6696\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n$ wget https://sourceforge.net/projects/postfixadmin/files/postfixadmin/postfixadmin-2.93/postfixadmin-2.93.tar.gz/download\n$ mv ./download postfixadmin-2.93.tar.gz\n$ tar xfvz postfixadmin-2.93.tar.gz\n$ mv ./postfixadmin-2.93 /home/ec2-user/www/admin/postfixadmin\n$ sudo mv /home/ec2-user/www/admin/postfixadmin/ADDITIONS/*.sh /var/mail/bin\n$ rm -R /home/ec2-user/www/admin/postfixadmin/ADDITIONS\n$ sudo chown -R vmail.vmail /var/mail/bin\n$ sudo chmod 0700 /var/mail/bin/postfixadmin/*.sh\n\n\n/home/ec2-user/www/admin/postfixadmin/config.inc.php\n$CONF['configured'] = true;\n$CONF['default_language'] = 'ja';\n$CONF['database_type'] = 'mysqli';\n$CONF['database_host'] = 'localhost';\n$CONF['database_user'] = 'postfix';\n$CONF['database_password'] = 'postfix\u30d1\u30b9\u30ef\u30fc\u30c9';\n$CONF['database_name'] = 'postfix';\n\n$CONF['encrypt'] = 'dovecot:SHA512-CRYPT';\n$CONF['dovecotpw'] = \"doveadm pw -s SHA512-CRYPT\";\n\n$CONF['domain_path'] = 'YES';\n$CONF['domain_in_mailbox'] = 'NO';\n\n$CONF['mailbox_postcreation_script']='sudo -u vmail /var/mail/bin/postfixadmin-mailbox-postcreation.sh';\n$CONF['mailbox_postdeletion_script']='sudo -u vmail /var/mail/bin/postfixadmin-mailbox-postdeletion.sh';\n$CONF['domain_postdeletion_script'] ='sudo -u vmail /var/mail/bin/postfixadmin-domain-postdeletion.sh';\n\n\n\u81ea\u52d5\u3067\u30c9\u30e1\u30a4\u30f3\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\uff06\u30e1\u30fc\u30eb\u30dc\u30c3\u30af\u30b9\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u304c\u4f5c\u6210\u304a\u3088\u3073\u524a\u9664\u3092\u3001\u5b58\u5728\u306e\u30b7\u30a7\u30eb\u3067\u5bfe\u5fdc\u3057\u3066\u3044\u307e\u3059\u3002\n\u3000\n\npostfixadmin-mailbox-postcreation.sh\u306e\u7de8\u96c6\n/var/mail/vhosts/\u30c9\u30e1\u30a4\u30f3\u540d/\u3001\u306e\u30e1\u30fc\u30eb\u30dc\u30c3\u30af\u30b9\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u4f5c\u6210\u3059\u308b\u30b7\u30e5\u30eb\u3002\n$ sudo vim /var/mail/bin/postfixadmin-mailbox-postcreation.sh\n\n\n/var/mail/bin/postfixadmin-mailbox-postcreation.sh\nbasedir=/var/mail/vhosts\nmkdir -p -m 0700 \"${parent}\"\n#maildirmake \"$maildir\"\nmkdir -p -m 0700 $maildir/{new,cur,tmp,.Drafts,.Junk,.Trash,.Sent}\n\n\n\u3000\n\npostfixadmin-mailbox-postdeletion.sh\u306e\u7de8\u96c6\n/var/mail/vhosts/\u30c9\u30e1\u30a4\u30f3\u540d/\u3001\u306e\u30e1\u30fc\u30eb\u30dc\u30c3\u30af\u30b9\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u524a\u9664\u3059\u308b\u30b7\u30e5\u30eb\u3002\n$ sudo vim /var/mail/bin/postfixadmin-mailbox-postdeletion.sh\n\n\n/var/mail/bin/postfixadmin-mailbox-postdeletion.sh\nbasedir=/var/mail/vhosts\ntrashbase=/var/mail/deleted-vhosts\n\n\n\u3000\n\npostfixadmin-domain-postdeletion.sh\u306e\u7de8\u96c6\n/var/mail/vhosts \u5185\u306e\u30c9\u30e1\u30a4\u30f3\u540d\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u524a\u9664\u3059\u308b\u30b7\u30e5\u30eb\u3002\n\u524a\u9664\u3055\u308c\u305f\u3001\u30c9\u30e1\u30a4\u30f3\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306f\u3001/var/mail/deleted-vhosts \u3078\u65e5\u4ed8\u4ed8\u304d\u3067\u79fb\u52d5\u3055\u308c\u307e\u3059\u3002\n$ sudo vim /var/mail/bin/postfixadmin-domain-postdeletion.sh\n\n\n/var/mail/bin/postfixadmin-domain-postdeletion.sh\nbasedir=/var/mail/vhosts\ntrashbase=/var/mail/deleted-vhosts\n\n\n\u5f8c\u306e\u8a2d\u5b9a\u3068\u69cb\u7bc9\u306f\u3001\u30b0\u30b0\u308b\u3068\u6ca2\u5c71\u51fa\u3066\u304f\u308b\u306e\u3067\u3001\u5f8c\u306f\u304a\u4efb\u305b\u3057\u307e\u3059\u3002 \n\u3000\n\u3000\n\u3000\n\n\u63a5\u7d9a\u30c6\u30b9\u30c8\n\n\u30b3\u30f3\u30bd\u30fc\u30eb\uff11\n$ sudo tail -f /var/log/maillog\n\n\n2\u753b\u9762\u3067\u30ed\u30b0\u3092\u898b\u306a\u304c\u3089\u30c6\u30b9\u30c8\u3059\u308b\u3053\u3068\u3092\u304a\u3059\u3059\u3081\u3057\u307e\u3059\u3002\u4e0b\u8a18\u306e\uff15\u3064\u306e\u30c6\u30b9\u30c8\u3067\u3001\u3068\u304f\u306b\u554f\u984c\u304c\u7121\u3051\u308c\u3070\u3001Postfix\u3068Dovecot\u306e\u8a2d\u5b9a\u306f\u7d42\u4e86\u3067\u3059\u3002\n\nSMTP port:25\n\n\u30b3\u30f3\u30bd\u30fc\u30eb2\n$ telnet \u30c9\u30e1\u30a4\u30f3\u540d 25\nTrying 52.196.8.213...\nConnected to \u30c9\u30e1\u30a4\u30f3\u540d.\nEscape character is '^]'.\n220 \u30c9\u30e1\u30a4\u30f3\u540d ESMTP Postfix\nehlo localhost\n...\u3000\u7701\u7565\nquit\n221 2.0.0 Bye\nConnection closed by foreign host.\n\n\n\nSMTP SSL/TLS port:465\n\n\u30b3\u30f3\u30bd\u30fc\u30eb2\n$ openssl s_client -connect \u30c9\u30e1\u30a4\u30f3\u540d:465 -tlsextdebug\nCONNECTED(00000003)\n...\u3000\u7701\u7565\n220 \u30c9\u30e1\u30a4\u30f3\u540d ESMTP Postfix\nquit\n221 2.0.0 Bye\nclosed\n\n\n\nSMTP STARTTLS port:587\n\n\u30b3\u30f3\u30bd\u30fc\u30eb2\n$ openssl s_client -connect \u30c9\u30e1\u30a4\u30f3\u540d:587 -starttls smtp -tlsextdebug\nCONNECTED(00000003)\n...\u3000\u7701\u7565\n250 DSN\nquit\n221 2.0.0 Bye\nclosed\n\n\n\nIMAP STARTTLS  port:143\n\n\u30b3\u30f3\u30bd\u30fc\u30eb2\n$ openssl s_client -connect \u30c9\u30e1\u30a4\u30f3\u540d:143 -starttls imap -tlsextdebug\nCONNECTED(00000003)\n...\u3000\u7701\u7565\n. OK Pre-login capabilities listed, post-login capabilities have more.\n1 logout\nclosed\n\n\n\nIMAP SSL/TLS  port:993\n\n\u30b3\u30f3\u30bd\u30fc\u30eb2\n$ openssl s_client -connect \u30c9\u30e1\u30a4\u30f3\u540d:993 -tlsextdebug\nCONNECTED(00000003)\n...\u3000\u7701\u7565\n* OK [CAPABILITY IMAP4rev1 LITERAL+ SASL-IR LOGIN-REFERRALS ID ENABLE IDLE AUTH=PLAIN AUTH=LOGIN] Dovecot ready.\n1 logout\nclosed\n\n\n\u3000\n\u3000\n\u3000\n\n\u6700\u5f8c\u306b\n\u3053\u308c\u3067\u3001\u7121\u4e8b\u30e1\u30fc\u30eb\u306e\u9001\u53d7\u4fe1\u304c\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3057\u305f\u3002\nhttps://admin.\u30c9\u30e1\u30a4\u30f3\u540d/postfixadmin\n\u3000\n\u30e1\u30fc\u30eb\u30bd\u30d5\u30c8Thunderbird\u3092\u4f7f\u7528\u3057\u305f\u3068\u3053\u308d\u3001\u81ea\u52d5\u8a2d\u5b9a\u3067\u96e3\u306a\u304f\u30e1\u30fc\u30eb\u306e\u9001\u53d7\u4fe1\u304c\u3067\u304d\u307e\u3057\u305f\u3002\n\u3000\n\u4ee5\u4e0a\u3067\u7d42\u308f\u308a\u306b\u306a\u308a\u307e\u3059\u3002\n# \u306f\u3058\u3081\u306b\n**AWS EC2** \u306e**Amazon Linux**\u3092\u60f3\u5b9a\u3057\u3001Postfix\u3001Dovecot\u3001amavisd\u3001Postfixadmin\u3067\u69cb\u7bc9\u3057\u305f\u3068\u304d\u306e\u30e1\u30e2\u3067\u3059\u3002\n\u30c9\u30e1\u30a4\u30f3\u306e\u767b\u9332\u3001Elastic IP\u306e\u5272\u308a\u5f53\u3066\u3001\u30dd\u30fc\u30c8 22, 25, 80, 143, 443, 465, 587, 993 \u306f\u3001\u958b\u3051\u3066\u3042\u308b\u3082\u306e\u3068\u3057\u307e\u3059\u3002\n\n### \u30e1\u30fc\u30eb\u30b5\u30fc\u30d0\u30fc\u306e\u63a5\u7d9a\u69cb\u6210\n| \u30bf\u30a4\u30d7  | \u30dd\u30fc\u30c8\u756a\u53f7 |\u6697\u53f7\u5316\u306e\u7a2e\u985e|\n|:------|:-------:|:--------:|\n| SMTP  | 25  |    --     |\n| SMTPS | 465 | SSL/TLS   |\n| SMTP  | 587 | STARTTLS |\n| IMAP  | 143 | STARTTLS |\n| IMAPS | 993 | SSL/TLS  |\n\n### \u69cb\u7bc9\u6642\u306e\u5404\u30d0\u30fc\u30b8\u30e7\u30f3\n\n| \u30a2\u30d7\u30ea\u306a\u3069    | \u30d0\u30fc\u30b8\u30e7\u30f3   |\n|:-------------|:-----------:|\n| Apache       |      2.4.18 |\n| PHP          |      5.6.19 |\n| Mysql        |      5.6.29 |\n| Postfix      |      2.6.6  |\n| Dovecot      |      2.2.10 |\n| postfixadmin |      2.93   |\n\u3000\n\u4eca\u56de\u306f\u3001\u4e0b\u8a18\u306e\u3088\u3046\u306a\u65b9\u6cd5\u3067 \u30b5\u30d6\u30c9\u30e1\u30a4\u30f3\u3067\u30a2\u30af\u30bb\u30b9\u3059\u308b\u30bf\u30a4\u30d7\u306b\u306a\u308a\u307e\u3059\u3002\nhttps://admin.\u30c9\u30e1\u30a4\u30f3\u540d/postfixadmin\n\u3000\n\u3000\n\u3000\n\n\u3000\n# WEB\u30b5\u30fc\u30d0\u30fc\u306e\u69cb\u7bc9\n\u65e2\u306b\u69cb\u7bc9\u6e08\u307f\u306e\u5834\u5408\u306f\u3001\u8aad\u307f\u98db\u3070\u3057\u3066\u304b\u307e\u308f\u306a\u3044\u3067\u3059\u3002\n##\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\uff06\u30b5\u30fc\u30d3\u30b9\u306e\u767b\u9332\n\n```console:web\u30b5\u30fc\u30d0\u30fc\n$ sudo yum install -y gcc httpd24 httpd24-devel mod24_ssl libcap-devel\n$ sudo yum install -y php56 php56-mbstring php56-mcrypt php56-opcache php56-mysqlnd php56-gd php56-devel php56-imap\n$ sudo chkconfig httpd on\n```\n## mod_ruid2\u306e\u4f5c\u6210\n\u30d0\u30fc\u30c1\u30e3\u30eb\u30db\u30b9\u30c8\u6bce\u306b\u3001\u6a29\u9650\u3092\u5909\u3048\u305f\u304b\u3063\u305f\u306e\u3067\u3001mod_ruid2\u3092\u4f7f\u3044\u307e\u3059\u3002\n\n\u307e\u305a\u306f\u3001\u4e0b\u8a18\u306e\u30b5\u30a4\u30c8\u304b\u3089DL\u3057\u89e3\u51cd\u3057\u307e\u3057\u3087\u3046\u3002\n\nhttps://github.com/mind04/mod-ruid2\n\n```console:DL\u3068\u89e3\u51cd\u3068\u30d3\u30eb\u30c9\n$ wget https://github.com/mind04/mod-ruid2/archive/master.zip\n$ unzip master.zip\n$ sudo apxs -i -c -l cap mod-ruid2-master/mod_ruid2.c\n```\n\n```console:\u30d3\u30eb\u30c9\u5f8c\n----------------------------------------------------------------------\nLibraries have been installed in:\n   /usr/lib64/httpd/modules\n\nIf you ever happen to want to link against installed libraries\nin a given directory, LIBDIR, you must either use libtool, and\nspecify the full pathname of the library, or use the `-LLIBDIR'\nflag during linking and do at least one of the following:\n   - add LIBDIR to the `LD_LIBRARY_PATH' environment variable\n     during execution\n   - add LIBDIR to the `LD_RUN_PATH' environment variable\n     during linking\n   - use the `-Wl,-rpath -Wl,LIBDIR' linker flag\n   - have your system administrator add LIBDIR to `/etc/ld.so.conf'\n\nSee any operating system documentation about shared libraries for\nmore information, such as the ld(1) and ld.so(8) manual pages.\n----------------------------------------------------------------------\nchmod 755 /usr/lib64/httpd/modules/mod_ruid2.so\n```\n\u30d3\u30eb\u30c9\u5f8c\u3001\u3053\u306e\u3088\u3046\u306a\u30e1\u30c3\u30bb\u30fc\u30b8\u304c\u3067\u308c\u3070\u3001\u4f7f\u7528\u53ef\u80fd\u306b\u306a\u308a\u307e\u3059\u3002\n\n\u901a\u5e38\u3001\u81ea\u52d5\u3067httpd.conf\u5185\u306b\u66f8\u304d\u8fbc\u307e\u308c\u307e\u3059\u304c\u3001\u7121\u3044\u5834\u5408\u3001\u4ee5\u4e0b\u306e\u7269\u3092\u66f8\u304d\u8fbc\u3093\u3067\u304f\u3060\u3055\u3044\u3002\n\n```apache:/etc/httpd/conf/httpd.conf\n# Example:\n# LoadModule foo_module modules/mod_foo.so\n#\nLoadModule ruid2_module modules/mod_ruid2.so\n```\n\n\u65b0\u898f\u306bpostfixadmin\u3067\u4f7f\u7528\u3059\u308b\u30d0\u30fc\u30c1\u30e3\u30eb\u30db\u30b9\u30c8\u3092\u4f5c\u308a\u307e\u3059\u3002\n\n```console:\u30d0\u30fc\u30c1\u30e3\u30eb\u30db\u30b9\u30c8\u306e\u4f5c\u6210\n$ sudo vim apache:/etc/httpd/conf.d/admin.conf\n```\n\n```apache:/etc/httpd/conf.d/admin.conf\n<IfModule mod_ssl.c>\n<VirtualHost *:443>\n    ServerName admin.\u30c9\u30e1\u30a4\u30f3\u540d:443\n    DocumentRoot /home/ec2-user/www/admin\n    <Directory \"/home/ec2-user/www/admin\">\n      Options -Indexes\n      Require all granted\n      Allow from all\n      AllowOverride All\n    </Directory>\n\n    <IfModule mod_ruid2.c>\n        RMode    config\n        RUidGid  ec2-user ec2-user\n        #RGroups  apachetmp\n    </IfModule>\n\n    SSLEngine on\n\n    SSLCertificateFile    /etc/pki/tls/certs/localhost.crt\n    SSLCertificateKeyFile /etc/pki/tls/private/localhost.key\n\n    <FilesMatch \"\\.(php)$\">\n        SSLOptions +StdEnvVars\n    </FilesMatch>\n\n    BrowserMatch \".*MSIE.*\" \\\n        nokeepalive ssl-unclean-shutdown \\\n        downgrade-1.0 force-response-1.0\n\n    CustomLog logs/dmin_www_ssl_log \\\n          \"%t %h %{SSL_PROTOCOL}x %{SSL_CIPHER}x \\\"%r\\\" %b\"\n\n    ErrorLog logs/admin_www_ssl_err\n</VirtualHost>\n</IfModule>\n```\n\n\u500b\u3005\u306e\u74b0\u5883\u306b\u5408\u308f\u305b\u3066\u8a2d\u5b9a\u3057\u3066\u304f\u3060\u3055\u3044\u3002\u3055\u3089\u306b\u3001BASIC\u8a8d\u8a3c\u3092\u4ed8\u3051\u52a0\u3048\u3066\u3082\u826f\u3044\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u3002\n\u3061\u306a\u307f\u306b\u3001/home/ec2-user/www/admin \u306e\u4e2d\u306b\u3001postfixadmin\u3092\u5165\u308c\u307e\u3059\u3002\n\u307b\u304b\u306b\u3082\u3001phpMyAdmin\u306a\u3069\u3001\u7ba1\u7406\u8005\u7528\u306eweb\u30a2\u30d7\u30ea\u3092\u5165\u308c\u3066\u3082\u826f\u3044\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u3002\n\n\n/home/ec2-user/www/admin \u306e\u4e2d\u306b\u3001\u4e0b\u8a18\u306e index.php \u3092\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n```php:index.php\n<?php\nheader('HTTP', true, 404);\n?>\n404 (Not Found)\n```\n\n```console:web\u30b5\u30fc\u30d0\u30fc\u306e\u8d77\u52d5\n$ sudo service httpd start\n```\nhttps://admin.\u30c9\u30e1\u30a4\u30f3\u540d/\n\nweb\u30b5\u30fc\u30d0\u30fc\u3092\u8d77\u52d5\u5f8c\u3001**404 (Not Found)**\u304c\u8868\u793a\u3055\u308c\u3066\u3044\u308b\u304b\u78ba\u304b\u3081\u3066\u304f\u3060\u3055\u3044\u3002\n\u3000\n\u3000\n\u3000\n\u3000\n\n# Mysql\u306e\u69cb\u7bc9\n##\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\uff06\u30b5\u30fc\u30d3\u30b9\u306e\u767b\u9332\n\n```console:DB\n$ sudo yum install -y mysql56 mysql56-server\n$ sudo chkconfig mysqld on\n$ sudo service mysqld start\n```\n\n### phpMyAdmin\u306e\u3059\u3059\u3081\n\nhttps://www.phpmyadmin.net/ \u3088\u308a\u3001\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\uff06\u89e3\u51cd\u3057\n/home/ec2-user/www/admin \u3078phpMyAdmin\u3092\u5165\u308c\u308b\u3053\u3068\u3092\u304a\u3059\u3059\u3081\u3057\u307e\u3059\u3002\n\u5c11\u3057\u8a2d\u5b9a\u3059\u308b\u3060\u3051\u3067\u3001\u76f4\u3050\u306b\u4f7f\u7528\u3067\u304d\u307e\u3059\u3002\u8a73\u3057\u3044\u8aac\u660e\u306f\u3001\u30b0\u30b0\u3063\u3066\u304f\u3060\u3055\u3044\u3002\n\n## \u30e1\u30fc\u30eb\u30b5\u30fc\u30d0\u30fc\u3067\u4f7f\u7528\u3059\u308b\u3001\u30e6\u30fc\u30b6\u30fc\u3068DB\u3092\u4f5c\u6210\n\n```sql:\u30e6\u30fc\u30b6\u30fc\u3068DB\u306e\u4f5c\u6210\nCREATE USER 'postfix'@'localhost' IDENTIFIED BY 'postfix\u306e\u30d1\u30b9\u30ef\u30fc\u30c9';\nCREATE DATABASE postfix CHARACTER SET utf8;\nGRANT ALL ON postfix.* to postfix@localhost;\n```\n\n \u3000\n\u3000\n\u3000\n\u3000\n\n# \u30e1\u30fc\u30eb\u30b5\u30fc\u30d0\u30fc\u306e\u69cb\u7bc9\n##\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\uff06\u30b5\u30fc\u30d3\u30b9\u306e\u767b\u9332\n\n```console:\n$ sudo yum install -y postfix\u3000dovecot dovecot-mysql\n$ sudo chkconfig postfix on\n$ sudo chkconfig dovecot on\n```\n\n\n##MTA\u306e\u5207\u308a\u5909\u3048\n```console:\n$ sudo alternatives --config mta\n  \u9078\u629e       \u30b3\u30de\u30f3\u30c9\n-----------------------------------------------\n*+ 1           /usr/sbin/sendmail.sendmail\n   2           /usr/sbin/sendmail.postfix\n\nEnter \u3092\u62bc\u3057\u3066\u73fe\u5728\u306e\u9078\u629e [+] \u3092\u4fdd\u6301\u3059\u308b\u304b\u3001\u9078\u629e\u756a\u53f7\u3092\u5165\u529b\u3057\u307e\u3059:2\n```\n\n2\u756a\u3092\u9078\u629e\u3057\u3066\u7d42\u308f\u308a\u3002\n\u3000\n## \u30d0\u30fc\u30c1\u30e3\u30eb\u30c9\u30e1\u30a4\u30f3\u7528\u306e\u30e6\u30fc\u30b6\u3068\u30e1\u30fc\u30eb\u7528\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306e\u4f5c\u6210\n\n```console:\n$ sudo groupadd -g 10000 vmail\n$ sudo useradd -g vmail -u 10000 vmail -d /var/mail\n$ sudo mkdir -p /var/mail/vhosts\n$ sudo mkdir -p /var/mail/bin\n$ sudo mkdir -p /var/mail/deleted-vhosts\n$ sudo chmod -R 0700 /var/mail\n$ sudo chown -R vmail:vmail /var/mail\n```\n\u3000\n\n## smtpd\u7528\u306b\u6697\u53f7\u5316\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u308b\n**dh2048.pem**\u304a\u3088\u3073**dh512.pem**\u306f\u3001Postfix SMTP\u30b5\u30fc\u30d0\u304cEDH\u6697\u53f7\u3067\u4f7f\u3046DH\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u6301\u3064\u30d5\u30a1\u30a4\u30eb\u3002\n**cert.pem**\u306f\u3001PEM\u30d5\u30a9\u30fc\u30de\u30c3\u30c8\u306e\u3001Postfix SMTP\u30b5\u30fc\u30d0RSA\u8a3c\u660e\u66f8\u3092\u6301\u3064\u30d5\u30a1\u30a4\u30eb\u3002 \n**privkey.pem**\u306f\u3001PEM\u30d5\u30a9\u30fc\u30de\u30c3\u30c8\u3067\u306e\u3001Postfix SMTP\u30b5\u30fc\u30d0RSA\u30d7\u30e9\u30a4\u30d9\u30fc\u30c8\u30ad\u30fc\u3092\u6301\u3064\u30d5\u30a1\u30a4\u30eb\u3002\n```console:\n$ sudo mkdir -p /etc/postfix/ssl/dhparams/\n$ sudo openssl dhparam -out /etc/postfix/ssl/dhparams/dh2048.pem 2048\n$ sudo openssl dhparam -out /etc/postfix/ssl/dhparams/dh512.pem 512\n$ sudo mkdir -p /etc/postfix/ssl/selfsigned/\n$ sudo openssl req -new -newkey rsa:4096 -days 3658 -sha256 -nodes -x509 \\\n      -subj \"/C=JP/ST=Shizuoka/L=Shizuoka/O=Mailserver certificate/OU=Mail/CN=www.\u30c9\u30e1\u30a4\u30f3\u540d/emailAddress=admin@\u30c9\u30e1\u30a4\u30f3\u540d\" \\\n      -keyout /etc/postfix/ssl/selfsigned/privkey.pem \\\n      -out /etc/postfix/ssl/selfsigned/cert.pem\n$ sudo chown -R vmail:vmail /var/mail\n```\n-subj \u306f\u3001\u500b\u3005\u306e\u74b0\u5883\u306b\u5408\u308f\u305b\u3066\u304f\u3060\u3055\u3044\u3002\n\n\n##postfix\u306e\u8a2d\u5b9a\n\n### \u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u3078\u306e\u30a2\u30af\u30bb\u30b9\u7528\u306e\u30af\u30a8\u30ea\u4f5c\u6210\n\n```console:\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306e\u4f5c\u6210\n$ sudo mkdir -p /etc/postfix/mysql\n```\n\n#### virtual-alias-maps.cf\n\n```console:virtual-alias-maps.cf\n$ sudo vim /etc/postfix/mysql/virtual-alias-maps.cf\n```\n\n```conf:/etc/postfix/mysql/virtual-alias-maps.cf\nhosts    = localhost\nuser     = postfix\npassword = postfix\u306e\u30d1\u30b9\u30ef\u30fc\u30c9\ndbname   = postfix\n\nquery = SELECT goto FROM alias WHERE address='%s' AND active = 1\n```\n\n#### virtual-mailbox-domains.cf\n\n```console:virtual-mailbox-domains.cf\n$ sudo vim /etc/postfix/mysql/virtual-mailbox-domains.cf\n```\n\n```conf:/etc/postfix/mysql/virtual-mailbox-domains.cf\nhosts    = localhost\nuser     = postfix\npassword = postfix\u306e\u30d1\u30b9\u30ef\u30fc\u30c9\ndbname   = postfix\n\nquery = SELECT domain FROM domain WHERE domain='%s' and backupmx = 0 and active = 1\n```\n\n#### virtual-mailbox-maps.cf\n\n```console:virtual-mailbox-maps.cf\n$ sudo vim /etc/postfix/mysql/virtual-mailbox-maps.cf\n```\n\n```conf:/etc/postfix/mysql/virtual-mailbox-maps.cf\nhosts    = localhost\nuser     = postfix\npassword = postfix\u306e\u30d1\u30b9\u30ef\u30fc\u30c9\ndbname   = postfix\n\nquery = SELECT maildir FROM mailbox WHERE username='%s' AND active = 1\n```\n\n#### virtual-mailbox-limit-maps.cf\n\n```console:virtual-mailbox-limit-maps.cf\n$ sudo vim /etc/postfix/mysql/virtual-mailbox-limit-maps.cf\n```\n\n```conf:/etc/postfix/mysql/virtual-mailbox-limit-maps.cf\nuser = postfix\npassword = postfix\u306e\u30d1\u30b9\u30ef\u30fc\u30c9\nhosts = localhost\ndbname = postfix\nquery = SELECT quota FROM mailbox WHERE username='%s' AND active = '1'\n```\n\u3000\n\u3000\n### main.cf\u306e\u7de8\u96c6\n\n```console:main.cf\u306e\u7de8\u96c6\n$ sudo vim /etc/postfix/main.cf\n```\n\n```conf:/etc/postfix/main.cf\nmyhostname = mail.\u30c9\u30e1\u30a4\u30f3\u540d\nmydomain = \u30c9\u30e1\u30a4\u30f3\u540d\nmyorigin = $mydomain\ninet_interfaces = all\ninet_protocols = ipv4\nmydestination = localhost localhost.$mydomain\nmynetworks = 127.0.0.0/8\nheader_checks = regexp:/etc/postfix/header_checks\nmime_header_checks = regexp:/etc/postfix/header_checks\nsmtpd_banner = $myhostname ESMTP $mail_name\nreadme_directory = no\nmailbox_command = procmail -a \"$EXTENSION\"\nrecipient_delimiter  = +\nbiff                 = no\nappend_dot_mydomain  = no\ndelay_warning_time   = 4h\ndisable_vrfy_command = yes\nmessage_size_limit   = 51200000\nmailbox_size_limit   = 102400000\n\n\n#\n# \u30dd\u30b9\u30c8\u30de\u30b9\u30bf\u30fc\u306b\u5831\u544a\u3055\u308c\u308b\u30a8\u30e9\u30fc\u30af\u30e9\u30b9\u306e\u30ea\u30b9\u30c8\n# \u983b\u7e41\u306b\u9001\u3089\u308c\u3066\u90aa\u9b54\u306a\u5834\u5408\u306f\u3001\u30b3\u30e1\u30f3\u30c8\u3057\u3066OK\n#\nnotify_classes = resource, software\nerror_notice_recipient     = admin@\u30c9\u30e1\u30a4\u30f3\u540d\n\n\n#\n# Smtp\n#\nsmtp_tls_loglevel            = 1\nsmtp_tls_security_level      = may\n#smtp_tls_CAfile              = \nsmtp_tls_protocols           = !SSLv2, !SSLv3\nsmtp_tls_mandatory_protocols = !SSLv2, !SSLv3\nsmtp_tls_mandatory_ciphers   = high\nsmtp_tls_exclude_ciphers     = aNULL, eNULL, EXPORT, DES, 3DES, RC2, RC4, MD5, PSK, SRP, DSS, AECDH, ADH\nsmtp_tls_note_starttls_offer = yes\n\n#\n# Smtpd\n#\nsmtpd_tls_loglevel            = 1\nsmtpd_tls_auth_only           = yes\nsmtpd_tls_security_level      = may\nsmtpd_tls_received_header     = yes\nsmtpd_tls_protocols           = !SSLv2, !SSLv3\nsmtpd_tls_mandatory_protocols = !SSLv2, !SSLv3\nsmtpd_tls_mandatory_ciphers   = medium\n\n#smtpd_tls_CAfile              = $smtp_tls_CAfile\nsmtpd_tls_cert_file           = /etc/postfix/ssl/selfsigned/cert.pem\nsmtpd_tls_key_file            = /etc/postfix/ssl/selfsigned/privkey.pem\nsmtpd_tls_dh1024_param_file   = /etc/postfix/ssl/dhparams/dh2048.pem\nsmtpd_tls_dh512_param_file    = /etc/postfix/ssl/dhparams/dh512.pem\n\ntls_preempt_cipherlist = yes\ntls_random_source      = dev:/dev/urandom\n\nsmtp_tls_session_cache_database  = btree:${data_directory}/smtp_scache\nsmtpd_tls_session_cache_database = btree:${data_directory}/smtpd_scache\nlmtp_tls_session_cache_database  = btree:${data_directory}/lmtp_scache\n\n\n#\n# SASL\n#\n\nsmtpd_sasl_auth_enable          = yes\nsmtpd_sasl_type                 = dovecot\nsmtpd_sasl_path                 = private/auth\nsmtpd_sasl_security_options     = noanonymous\nsmtpd_sasl_tls_security_options = $smtpd_sasl_security_options\nsmtpd_sasl_local_domain         = $mydomain\nsmtpd_sasl_authenticated_header = yes\n\nbroken_sasl_auth_clients = yes\n\n#\n# Virtual mail box\n#\n\nvirtual_uid_maps        = static:10000\nvirtual_gid_maps        = static:10000\nvirtual_minimum_uid     = 10000\nvirtual_mailbox_base    = /var/mail/vhosts\nvirtual_transport       = lmtp:unix:private/dovecot-lmtp\nvirtual_mailbox_domains = mysql:/etc/postfix/mysql/virtual-mailbox-domains.cf\nvirtual_mailbox_maps    = mysql:/etc/postfix/mysql/virtual-mailbox-maps.cf\nvirtual_alias_maps      = mysql:/etc/postfix/mysql/virtual-alias-maps.cf\n\n# \u5bb9\u91cf\u5236\u9650\nvirtual_create_maildirsize = yes\nvirtual_mailbox_extended   = yes\nvirtual_mailbox_limit      = 102400000\nvirtual_mailbox_limit_maps = mysql:/etc/postfix/mysql/virtual-mailbox-limit-maps.cf\nvirtual_mailbox_limit_override = yes\nvirtual_maildir_limit_message = Sorry, the user's maildir has overdrawn his diskspace quota, please try again later.\nvirtual_overquota_bounce = yes \n\n\n#\n# \u30a2\u30af\u30bb\u30b9\u5236\u9650\n#\n\nsmtpd_recipient_restrictions =\n     permit_mynetworks,\n     permit_sasl_authenticated,\n     reject_non_fqdn_recipient,\n     reject_unauth_destination,\n     reject_unknown_recipient_domain,\n     reject_rbl_client all.rbl.jp,\n     reject_rbl_client bl.spamcop.net,\n     reject_rbl_client zen.spamhaus.org\n\nsmtpd_helo_restrictions =\n     permit_mynetworks,\n     permit_sasl_authenticated,\n     reject_invalid_helo_hostname,\n     reject_non_fqdn_helo_hostname\n\nsmtpd_client_restrictions =\n     permit_mynetworks,\n     permit_inet_interfaces,\n     permit_sasl_authenticated\n\nsmtpd_sender_restrictions =\n     reject_non_fqdn_sender,\n     reject_unknown_sender_domain\n\n```\n**mynetworks** \u306f\u3001\u500b\u3005\u306e\u74b0\u5883\u306b\u5408\u308f\u305b\u3066\u304f\u3060\u3055\u3044\u3002\n\u3000\n\u3000\n### header_checks\u306e\u7de8\u96c6\n\u30d8\u30c3\u30c0\u30c1\u30a7\u30c3\u30af\u30d5\u30a1\u30a4\u30eb\u306e\u8a2d\u5b9a\u3092\u3057\u307e\u3059\u3002\n\n```console:header_checks\n$ sudo vim /etc/postfix/header_checks\n```\n\n```conf:/etc/postfix/header_checks\n/^Received:.*with ESMTPSA/  IGNORE\n/^X-Originating-IP:/        IGNORE\n/^X-Mailer:/                IGNORE\n/^User-Agent:/              IGNORE\n```\n\n\u5fc5\u8981\u306b\u5fdc\u3058\u3066\u8ffd\u52a0\n\n\n```console:header_checks\n$ sudo postmap /etc/postfix/header_checks\n```\n### master.cf\u306e\u7de8\u96c6\n\n```console:header_checks\n$ sudo vim /etc/postfix/master.cf\n```\n\n```conf:/etc/postfix/header_checks\nsubmission inet n       -       n       -       -       smtpd\n  -o syslog_name=postfix/submission\n  -o smtpd_tls_dh1024_param_file=/etc/postfix/ssl/dhparams/dh2048.pem\n  -o smtpd_tls_security_level=encrypt\n  -o smtpd_sasl_auth_enable=yes\n  -o smtpd_client_restrictions=permit_sasl_authenticated,reject\n#  -o milter_macro_daemon_name=ORIGINATING\n465       inet  n       -       n       -       -       smtpd\n  -o syslog_name=postfix/smtps\n  -o smtpd_tls_wrappermode=yes\n  -o smtpd_sasl_auth_enable=yes\n  -o smtpd_reject_unlisted_recipient=no\n  -o smtpd_client_restrictions=permit_sasl_authenticated,reject\n```\n \u3000\n\u3000\n\u3000\n## Dovecot\u306e\u8a2d\u5b9a\n### dovecot.conf\u306e\u7de8\u96c6\n\n```console:dovecot.conf\u306e\u7de8\u96c6\n$ sudo vim /etc/dovecot/dovecot.conf\n```\n\n```conf:/etc/dovecot/dovecot.conf\nprotocols = imap lmtp\nlisten = *\n#mail_debug = yes\n```\n\u6700\u521d\u306e\u3046\u3061\u306f\u3001** mail_debug = yes** \u3067\u69d8\u5b50\u898b\u3057\u305f\u307b\u3046\u304c\u826f\u3044\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u3002\n\u3000\n\n### dovecot-sql.conf.ext\u306e\u4f5c\u6210\n\n```console:dovecot.conf\u306e\u7de8\u96c6\n$ sudo vim /etc/dovecot/dovecot-sql.conf.ext\n```\n\n```conf:/etc/dovecot/dovecot-sql.conf.ext\ndriver   = mysql\nconnect  = host=localhost dbname=postfix user=postfix password=postfix\u30d1\u30b9\u30ef\u30fc\u30c9\ndefault_pass_scheme = SHA512-CRYPT\npassword_query = SELECT password FROM mailbox WHERE username = '%u' AND active='1'\nuser_query = SELECT CONCAT('/var/mail/vhosts/', maildir) AS mail, 10000 AS uid, 10000 AS gid, CONCAT('*:bytes=', quota) AS quota_rule FROM mailbox WHERE username = '%u' AND active='1'\n```\n\n### 10-auth.conf\u306e\u7de8\u96c6\n\n```console:10-auth.conf\u306e\u7de8\u96c6\n$ sudo vim /etc/dovecot/conf.d/10-auth.conf\n```\n\n```conf:/etc/dovecot/conf.d/10-auth.conf\ndisable_plaintext_auth = yes\nauth_mechanisms = plain login\n#!include auth-system.conf.ext\n!include auth-sql.conf.ext\n```\n\n### 10-mail.conf\u306e\u7de8\u96c6\n\n```console:10-mail.conf\u306e\u7de8\u96c6\n$ sudo vim /etc/dovecot/conf.d/10-mail.conf\n```\n\n```conf:/etc/dovecot/conf.d/10-mail.conf\nmail_location = maildir:/var/mail/vhosts/%d/%n/\nmaildir_stat_dirs=yes\n\nmail_uid = 10000\nmail_gid = 10000\n\nfirst_valid_uid = 10000\nlast_valid_uid = 10000\n\nmail_privileged_group = vmail\n```\n\n### 10-master.conf\u306e\u7de8\u96c6\n\n```console:10-mail.conf\u306e\u7de8\u96c6\n$ sudo vim /etc/dovecot/conf.d/10-master.conf\n```\n\n```conf:/etc/dovecot/conf.d/10-master.conf\nservice imap-login {\n  inet_listener imap {\n    port = 143\n  }\n  inet_listener imaps {\n    port = 993\n    ssl = yes\n  }\n  service_count = 0\n}\n\nservice lmtp {\n  unix_listener /var/spool/postfix/private/dovecot-lmtp {\n    mode = 0666\n    user = postfix\n    group = postfix\n  }\n}\n\nservice auth {\n  unix_listener /var/spool/postfix/private/auth {\n    mode = 0666\n    user = postfix\n    group = postfix\n  }\n\n  unix_listener auth-userdb {\n    mode = 0600\n    user = vmail\n    group = vmail\n  }\n\n  user = dovecot\n}\n\nservice auth-worker {\n  user = vmail\n}\n```\n\n### 10-ssl.conf\u306e\u7de8\u96c6\n\n```console:10-ssl.conf\u306e\u7de8\u96c6\n$ sudo vim /etc/dovecot/conf.d/10-ssl.conf\n```\n\n```conf:/etc/dovecot/conf.d/10-ssl.conf\nssl_cert = </etc/postfix/ssl/selfsigned/cert.pem\nssl_key = </etc/postfix/ssl/selfsigned/privkey.pem\nssl_cipher_list = EECDH+AES:EDH+AES+aRSA\nssl_prefer_server_ciphers = yes\nssl_dh_parameters_length = 2048\n```\n\n### 15-mailboxes.conf\u306e\u7de8\u96c6\n\n\n```15-mailboxes.conf\u306e\u7de8\u96c6\n$ sudo vim /etc/dovecot/conf.d/15-mailboxes.conf\n```\n\n```conf:/etc/dovecot/conf.d/15-mailboxes.conf\nnamespace inbox {\n  mailbox Drafts {\n    special_use = \\Drafts\n    auto=subscribe\n  }\n  mailbox Junk {\n    special_use = \\Junk\n    auto=subscribe\n  }\n  mailbox Trash {\n    special_use = \\Trash\n    auto=subscribe\n  }\n  mailbox Sent {\n    special_use = \\Sent\n    auto=subscribe\n  }\n}\n```\n\n### 20-lmtp.conf\u306e\u7de8\u96c6\n\n```console:20-lmtp.conf\u306e\u7de8\u96c6\n$ sudo vim /etc/dovecot/conf.d/20-lmtp.conf\n```\n\n```conf:/etc/dovecot/conf.d/20-lmtp.conf\nprotocol lmtp {\n  postmaster_address = postmaster@\u30c9\u30e1\u30a4\u30f3\u540d\n  mail_plugins = $mail_plugins\n}\n```\n\n### auth-sql.conf.ext\u306e\u7de8\u96c6\n\n```console:auth-sql.conf.ext\u306e\u7de8\u96c6\n$ sudo vim /etc/dovecot/conf.d/auth-sql.conf.ext\n```\n\n```conf:/etc/dovecot/conf.d/auth-sql.conf.ext\nuserdb {\n  driver = sql\n  args = /etc/dovecot/dovecot-sql.conf.ext\n}\n```\n\u3000\n## Postfix & Dovecot \u8d77\u52d5\n\n\n```console:\n$ sudo service postfix start\n$ sudo service dovecot start\n```\n\n\u3000\n\u3000\n\u3000\n#postfixadmin\n\n\u3053\u3053\u3067\u306f\u30d0\u30fc\u30b8\u30e7\u30f32.93\u3067\u3059\u304c\u3001\u6700\u65b0\u7248\u3092\u6696\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n```console:\n$ wget https://sourceforge.net/projects/postfixadmin/files/postfixadmin/postfixadmin-2.93/postfixadmin-2.93.tar.gz/download\n$ mv ./download postfixadmin-2.93.tar.gz\n$ tar xfvz postfixadmin-2.93.tar.gz\n$ mv ./postfixadmin-2.93 /home/ec2-user/www/admin/postfixadmin\n$ sudo mv /home/ec2-user/www/admin/postfixadmin/ADDITIONS/*.sh /var/mail/bin\n$ rm -R /home/ec2-user/www/admin/postfixadmin/ADDITIONS\n$ sudo chown -R vmail.vmail /var/mail/bin\n$ sudo chmod 0700 /var/mail/bin/postfixadmin/*.sh\n```\n\n```php:/home/ec2-user/www/admin/postfixadmin/config.inc.php\n$CONF['configured'] = true;\n$CONF['default_language'] = 'ja';\n$CONF['database_type'] = 'mysqli';\n$CONF['database_host'] = 'localhost';\n$CONF['database_user'] = 'postfix';\n$CONF['database_password'] = 'postfix\u30d1\u30b9\u30ef\u30fc\u30c9';\n$CONF['database_name'] = 'postfix';\n\n$CONF['encrypt'] = 'dovecot:SHA512-CRYPT';\n$CONF['dovecotpw'] = \"doveadm pw -s SHA512-CRYPT\";\n\n$CONF['domain_path'] = 'YES';\n$CONF['domain_in_mailbox'] = 'NO';\n\n$CONF['mailbox_postcreation_script']='sudo -u vmail /var/mail/bin/postfixadmin-mailbox-postcreation.sh';\n$CONF['mailbox_postdeletion_script']='sudo -u vmail /var/mail/bin/postfixadmin-mailbox-postdeletion.sh';\n$CONF['domain_postdeletion_script'] ='sudo -u vmail /var/mail/bin/postfixadmin-domain-postdeletion.sh';\n```\n\n\u81ea\u52d5\u3067\u30c9\u30e1\u30a4\u30f3\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\uff06\u30e1\u30fc\u30eb\u30dc\u30c3\u30af\u30b9\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u304c\u4f5c\u6210\u304a\u3088\u3073\u524a\u9664\u3092\u3001\u5b58\u5728\u306e\u30b7\u30a7\u30eb\u3067\u5bfe\u5fdc\u3057\u3066\u3044\u307e\u3059\u3002\n\u3000\n### postfixadmin-mailbox-postcreation.sh\u306e\u7de8\u96c6\n/var/mail/vhosts/\u30c9\u30e1\u30a4\u30f3\u540d/\u3001\u306e\u30e1\u30fc\u30eb\u30dc\u30c3\u30af\u30b9\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u4f5c\u6210\u3059\u308b\u30b7\u30e5\u30eb\u3002\n\n```console:\n$ sudo vim /var/mail/bin/postfixadmin-mailbox-postcreation.sh\n```\n\n```shell:/var/mail/bin/postfixadmin-mailbox-postcreation.sh\nbasedir=/var/mail/vhosts\nmkdir -p -m 0700 \"${parent}\"\n#maildirmake \"$maildir\"\nmkdir -p -m 0700 $maildir/{new,cur,tmp,.Drafts,.Junk,.Trash,.Sent}\n```\n\u3000\n### postfixadmin-mailbox-postdeletion.sh\u306e\u7de8\u96c6\n/var/mail/vhosts/\u30c9\u30e1\u30a4\u30f3\u540d/\u3001\u306e\u30e1\u30fc\u30eb\u30dc\u30c3\u30af\u30b9\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u524a\u9664\u3059\u308b\u30b7\u30e5\u30eb\u3002\n\n```console:\n$ sudo vim /var/mail/bin/postfixadmin-mailbox-postdeletion.sh\n```\n\n```shell:/var/mail/bin/postfixadmin-mailbox-postdeletion.sh\nbasedir=/var/mail/vhosts\ntrashbase=/var/mail/deleted-vhosts\n```\n\u3000\n\n\n### postfixadmin-domain-postdeletion.sh\u306e\u7de8\u96c6\n**/var/mail/vhosts** \u5185\u306e\u30c9\u30e1\u30a4\u30f3\u540d\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u524a\u9664\u3059\u308b\u30b7\u30e5\u30eb\u3002\n\u524a\u9664\u3055\u308c\u305f\u3001\u30c9\u30e1\u30a4\u30f3\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306f\u3001**/var/mail/deleted-vhosts** \u3078\u65e5\u4ed8\u4ed8\u304d\u3067\u79fb\u52d5\u3055\u308c\u307e\u3059\u3002\n\n```console:\n$ sudo vim /var/mail/bin/postfixadmin-domain-postdeletion.sh\n```\n\n```shell:/var/mail/bin/postfixadmin-domain-postdeletion.sh\nbasedir=/var/mail/vhosts\ntrashbase=/var/mail/deleted-vhosts\n```\n\n\n\u5f8c\u306e\u8a2d\u5b9a\u3068\u69cb\u7bc9\u306f\u3001\u30b0\u30b0\u308b\u3068\u6ca2\u5c71\u51fa\u3066\u304f\u308b\u306e\u3067\u3001\u5f8c\u306f\u304a\u4efb\u305b\u3057\u307e\u3059\u3002 \n\u3000\n\u3000\n\u3000\n## \u63a5\u7d9a\u30c6\u30b9\u30c8\n\n```console:\u30b3\u30f3\u30bd\u30fc\u30eb\uff11\n$ sudo tail -f /var/log/maillog\n```\n2\u753b\u9762\u3067\u30ed\u30b0\u3092\u898b\u306a\u304c\u3089\u30c6\u30b9\u30c8\u3059\u308b\u3053\u3068\u3092\u304a\u3059\u3059\u3081\u3057\u307e\u3059\u3002\u4e0b\u8a18\u306e\uff15\u3064\u306e\u30c6\u30b9\u30c8\u3067\u3001\u3068\u304f\u306b\u554f\u984c\u304c\u7121\u3051\u308c\u3070\u3001Postfix\u3068Dovecot\u306e\u8a2d\u5b9a\u306f\u7d42\u4e86\u3067\u3059\u3002\n\n### SMTP port:25\n```console:\u30b3\u30f3\u30bd\u30fc\u30eb2\n$ telnet \u30c9\u30e1\u30a4\u30f3\u540d 25\nTrying 52.196.8.213...\nConnected to \u30c9\u30e1\u30a4\u30f3\u540d.\nEscape character is '^]'.\n220 \u30c9\u30e1\u30a4\u30f3\u540d ESMTP Postfix\nehlo localhost\n...\u3000\u7701\u7565\nquit\n221 2.0.0 Bye\nConnection closed by foreign host.\n```\n\n### SMTP SSL/TLS port:465 \n```console:\u30b3\u30f3\u30bd\u30fc\u30eb2\n$ openssl s_client -connect \u30c9\u30e1\u30a4\u30f3\u540d:465 -tlsextdebug\nCONNECTED(00000003)\n...\u3000\u7701\u7565\n220 \u30c9\u30e1\u30a4\u30f3\u540d ESMTP Postfix\nquit\n221 2.0.0 Bye\nclosed\n```\n\n### SMTP STARTTLS port:587\n\n```console:\u30b3\u30f3\u30bd\u30fc\u30eb2\n$ openssl s_client -connect \u30c9\u30e1\u30a4\u30f3\u540d:587 -starttls smtp -tlsextdebug\nCONNECTED(00000003)\n...\u3000\u7701\u7565\n250 DSN\nquit\n221 2.0.0 Bye\nclosed\n```\n\n### IMAP STARTTLS  port:143 \n\n```console:\u30b3\u30f3\u30bd\u30fc\u30eb2\n$ openssl s_client -connect \u30c9\u30e1\u30a4\u30f3\u540d:143 -starttls imap -tlsextdebug\nCONNECTED(00000003)\n...\u3000\u7701\u7565\n. OK Pre-login capabilities listed, post-login capabilities have more.\n1 logout\nclosed\n```\n\n### IMAP SSL/TLS  port:993 \n\n```console:\u30b3\u30f3\u30bd\u30fc\u30eb2\n$ openssl s_client -connect \u30c9\u30e1\u30a4\u30f3\u540d:993 -tlsextdebug\nCONNECTED(00000003)\n...\u3000\u7701\u7565\n* OK [CAPABILITY IMAP4rev1 LITERAL+ SASL-IR LOGIN-REFERRALS ID ENABLE IDLE AUTH=PLAIN AUTH=LOGIN] Dovecot ready.\n1 logout\nclosed\n```\n\u3000\n\u3000\n\u3000\n\n\n\n# \u6700\u5f8c\u306b\n\u3053\u308c\u3067\u3001\u7121\u4e8b\u30e1\u30fc\u30eb\u306e\u9001\u53d7\u4fe1\u304c\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3057\u305f\u3002\nhttps://admin.\u30c9\u30e1\u30a4\u30f3\u540d/postfixadmin\n\u3000\n\u30e1\u30fc\u30eb\u30bd\u30d5\u30c8**Thunderbird**\u3092\u4f7f\u7528\u3057\u305f\u3068\u3053\u308d\u3001\u81ea\u52d5\u8a2d\u5b9a\u3067\u96e3\u306a\u304f\u30e1\u30fc\u30eb\u306e\u9001\u53d7\u4fe1\u304c\u3067\u304d\u307e\u3057\u305f\u3002\n\u3000\n\n\u4ee5\u4e0a\u3067\u7d42\u308f\u308a\u306b\u306a\u308a\u307e\u3059\u3002\n", "tags": ["AmazonLinux", "postfix", "dovecot", "postfixadmin"]}