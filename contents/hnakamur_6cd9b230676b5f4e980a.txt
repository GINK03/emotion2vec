{"tags": ["CentOS6.5", "ngx_mruby", "docker0.8.1", "mruby"], "context": " \u3053\u306e\u8a18\u4e8b\u306f\u6700\u7d42\u66f4\u65b0\u65e5\u304b\u30891\u5e74\u4ee5\u4e0a\u304c\u7d4c\u904e\u3057\u3066\u3044\u307e\u3059\u3002\n\n\u306f\u3058\u3081\u306b\nmatsumoto-r/ngx_mruby\u3092CentOS\u3067\u8a66\u305d\u3046\u3068\u601d\u3044\u3001\u30d3\u30eb\u30c9\u3059\u308b\u305f\u3081\u306eDockerfile\u3092\u66f8\u3044\u3066\u307f\u307e\u3057\u305f\u3002\nhnakamur/docker-ngx_mruby-centos\u306b\u7f6e\u3044\u3066\u3042\u308a\u307e\u3059\u3002MIT\u30e9\u30a4\u30bb\u30f3\u30b9\u3067\u3059\u3002\n\nngx_mruby\u306e\u30d3\u30eb\u30c9\u8a2d\u5b9a\nngx_mruby\u3067\u306f\u30c7\u30d5\u30a9\u30eb\u30c8\u3067\u4ee5\u4e0b\u306e\u30e2\u30b8\u30e5\u30fc\u30eb\u3092\u30d3\u30eb\u30c9\u3059\u308b\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002\n\nhttps\n  #\n  # Recommended for ngx_mruby\n  #\n  # comment out because of moving error.h\n  conf.gem :git => 'git://github.com/iij/mruby-io.git'\n  conf.gem :git => 'git://github.com/iij/mruby-process.git'\n  conf.gem :git => 'git://github.com/iij/mruby-pack.git'\n  conf.gem :git => 'git://github.com/iij/mruby-digest.git'\n  conf.gem :git => 'git://github.com/mattn/mruby-json.git'\n  conf.gem :git => 'git://github.com/matsumoto-r/mruby-redis.git'\n  conf.gem :git => 'git://github.com/matsumoto-r/mruby-vedis.git'\n  conf.gem :git => 'git://github.com/matsumoto-r/mruby-memcached.git'\n  conf.gem :git => 'git://github.com/matsumoto-r/mruby-sleep.git'\n  conf.gem :git => 'git://github.com/matsumoto-r/mruby-userdata.git'\n  conf.gem :git => 'git://github.com/mattn/mruby-onig-regexp.git'\n\n  # ngx_mruby extended class\n  conf.gem :git => 'git://github.com/matsumoto-r/mruby-ngx-mruby-ext.git'\n\n\n\u79c1\u306e\u66f8\u3044\u305fDockerfile\u3067\u306fbuild_config.rb\u3092\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u5909\u66f4\u3057\u3066\u3044\u307e\u3059\u3002\n\nhttps\n    sed -i.orig \"s|conf.gem :git => 'git://github.com/matsumoto-r/mruby-memcached.git'|#&|;/^  conf.gem :git => 'git:\\/\\/github.com\\/mattn\\/mruby-onig-regexp.git'/a\\\n\\  conf.gem :git => 'git://github.com/iij/mruby-env.git'\" \\\n      build_config.rb && \\\n\n\n\nmruby-memcached\u306f\u30d3\u30eb\u30c9\u5bfe\u8c61\u304b\u3089\u5916\u3059\n\n\n\nmatsumoto-r/mruby-memcached\u306flibmemcached\u306e\u30bd\u30fc\u30b9\u3092\u30d3\u30eb\u30c9\u3057\u3066\u53c2\u7167\u3059\u308b\u3088\u3046\u306b\u3057\u3066\u307f\u305f\u3093\u3067\u3059\u304c\u3001mruby-memcached\u304c\u30b3\u30f3\u30d1\u30a4\u30eb\u30a8\u30e9\u30fc\u306b\u306a\u3063\u3066\u3057\u307e\u3044\u307e\u3057\u305f\u3002\u3068\u308a\u3042\u3048\u305a\u79c1\u306f\u4f7f\u3046\u4e88\u5b9a\u304c\u306a\u304b\u3063\u305f\u306e\u3067\u5916\u3059\u3053\u3068\u306b\u3057\u307e\u3057\u305f\u3002\n\n\nmruby-env\u3092\u8ffd\u52a0\n\n\nmruby\u306e\u30b9\u30af\u30ea\u30d7\u30c8\u5185\u3067\u74b0\u5883\u5909\u6570\u3092\u53c2\u7167\u3057\u305f\u304b\u3063\u305f\u306e\u3067iij/mruby-env\u3092\u8ffd\u52a0\u3057\u307e\u3057\u305f\u3002\n\n\n\n\nnginx\u306e\u30d3\u30eb\u30c9\nmatsumoto-r/ngx_mruby\u306eBuild\u306e\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u306b\u306f3\u901a\u308a\u306e\u65b9\u6cd5\u304c\u66f8\u304b\u308c\u3066\u3044\u307e\u3059\u3002nginx\u306b\u30e2\u30b8\u30e5\u30fc\u30eb\u3092\u8ffd\u52a0\u3057\u305f\u3044\u5834\u5408\u3082\u3042\u308b\u306e\u3067\u30013\u756a\u3081\u306e\u65b9\u6cd5\u306b\u3057\u305f\u304b\u3063\u305f\u306e\u3067\u3059\u304c\u3001mruby\u304c\u30d3\u30eb\u30c9\u3055\u308c\u305a\u30a8\u30e9\u30fc\u306b\u306a\u3063\u3066\u3057\u307e\u3063\u305f\u306e\u3067\u30011\u756a\u3081\u306e\u65b9\u6cd5\u3067mruby\u3092\u30d3\u30eb\u30c9\u3057\u3066\u304a\u3044\u3066\u304b\u3089\u30013\u756a\u3081\u306e\u65b9\u6cd5\u3067\u30d3\u30eb\u30c9\u3059\u308b\u3088\u3046\u306b\u3057\u3066\u307f\u305f\u3089\u3001\u3046\u307e\u304f\u884c\u304d\u307e\u3057\u305f\u3002\nnginx\u306econfigure\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u3057\u3066\u3044\u307e\u3059\u3002\u9069\u5b9c\u5909\u66f4\u3057\u3066\u3054\u5229\u7528\u304f\u3060\u3055\u3044\u3002\n\nhttps\n    ./configure --prefix=/usr/local/nginx \\\n      --user=nginx \\\n      --group=nginx \\\n      --with-file-aio \\\n      --with-ipv6 \\\n      --with-http_ssl_module \\\n      --with-http_realip_module \\\n      --with-http_addition_module \\\n      --with-http_xslt_module \\\n      --with-http_image_filter_module \\\n      --with-http_geoip_module \\\n      --with-http_sub_module \\\n      --with-http_dav_module \\\n      --with-http_flv_module \\\n      --with-http_mp4_module \\\n      --with-http_gzip_static_module \\\n      --with-http_random_index_module \\\n      --with-http_secure_link_module \\\n      --with-http_degradation_module \\\n      --with-http_stub_status_module \\\n      --with-md5-asm \\\n      --with-sha1-asm \\\n      --with-pcre-jit --with-pcre=/usr/local/src/pcre-8.35 \\\n      --with-cc-opt='-O2 -g' \\\n      --add-module=/usr/local/src/ngx_mruby \\\n      --add-module=/usr/local/src/ngx_mruby/dependence/ngx_devel_kit && \\\n\n\n\nmruby\u3068nginx\u304c\u4f9d\u5b58\u3057\u3066\u3044\u308b\u3082\u306e\u306e\u30d3\u30eb\u30c9\u307e\u305f\u306f\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\nruby\n\n\nmruby\u306e\u30d3\u30eb\u30c9\u306b\u5fc5\u8981\u30022.1.1\u3092\u30bd\u30fc\u30b9\u304b\u3089\u30d3\u30eb\u30c9\n\n\n\nRedis\n\n\nredis/hiredis\u306e\u30d3\u30eb\u30c9\u306b\u5fc5\u8981\n\u30bd\u30fc\u30b9\u304b\u3089\u30d3\u30eb\u30c9\n\n\n\nredis/hiredis\n\n\nmatsumoto-r/mruby-redis\u304c\u4f9d\u5b58\n\u30bd\u30fc\u30b9\u304b\u3089\u30d3\u30eb\u30c9\n\n\n\nPCRE - Perl Compatible Regular Expressions\n\nJIT\u3092\u4f7f\u3044\u305f\u3044(nginx\u306econfigure\u306e--with-pcre-jit\u30aa\u30d7\u30b7\u30e7\u30f3)\u306e\u3067\u6700\u65b0\u72488.35\u3092\u30bd\u30fc\u30b9\u304b\u3089\u30d3\u30eb\u30c9\n\n\n\nGeoIP\n\n\u3053\u308c\u306f\u4f9d\u5b58\u3057\u3066\u3044\u308b\u3068\u3044\u3046\u308f\u3051\u3067\u306f\u306a\u304f\u3001nginx\u306bGeoIP\u30e2\u30b8\u30e5\u30fc\u30eb\u3092\u7d44\u307f\u8fbc\u3093\u3067(nginx\u306econfigure\u306e--with-http_geoip_module\u30aa\u30d7\u30b7\u30e7\u30f3)\u30d3\u30eb\u30c9\u3057\u305f\u304b\u3063\u305f\u306e\u3067\u5229\u7528\u3002\nepel\u304b\u3089\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\u30bd\u30fc\u30b9\u304b\u3089\u30d3\u30eb\u30c9\u3059\u308b\u5834\u5408\u306fHow to install Nginx GeoIP module\u304c\u53c2\u8003\u306b\u306a\u308a\u305d\u3046\u3067\u3059\uff08\u8a66\u3057\u3066\u306a\u3044\u3067\u3059\uff09\u3002\n\n\n\n\nDocker\u30a4\u30e1\u30fc\u30b8\u306e\u30d3\u30eb\u30c9\nDockerfile\u306e\u3042\u308b\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3067\u4ee5\u4e0b\u306e\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3057\u307e\u3059\u3002\ndocker build -t hnakamur/ngx_mruby .\n\n\n\u30b3\u30f3\u30c6\u30ca\u306e\u8d77\u52d5\nredis\u306fdocker\u3067lua-resty-redis\u306e\u30b3\u30f3\u30c6\u30ca\u304b\u3089redis\u306e\u30b3\u30f3\u30c6\u30ca\u306b\u901a\u4fe1\u3059\u308b\u30b5\u30f3\u30d7\u30eb - Qiita\u306e\u8a18\u4e8b\u3067\u4f5c\u3063\u305f\u30b3\u30f3\u30c6\u30ca\u3092\u5229\u7528\u3057\u307e\u3059\u3002\u4ee5\u4e0b\u306e\u30b3\u30de\u30f3\u30c9\u3067redis\u306e\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3057\u307e\u3059\u3002\ndocker run -d -p 6379:6379 -name redis hnakamur/redis\n\n\u4ee5\u4e0b\u306e\u30b3\u30de\u30f3\u30c9\u3067ngx_mruby\u306e\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3057\u307e\u3059\u3002\ndocker run -d -p 80:80 -link redis:redis hnakamur/ngx_mruby\n\n\nngx_mruby\u304b\u3089redis\u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u30b5\u30f3\u30d7\u30eb\n\u307e\u305aDocker\u306b\u3088\u3063\u3066\u74b0\u5883\u5909\u6570\u3092\u53c2\u7167\u3059\u308b\u305f\u3081\u306bnginx.conf\u306b\u4ee5\u4e0b\u306e\u8a2d\u5b9a\u3092\u5165\u308c\u3066\u3044\u307e\u3059\u3002\n\nhttps\nenv REDIS_PORT_6379_TCP_ADDR;\nenv REDIS_PORT_6379_TCP_PORT;\n\n\n/redis\u306elocation\u8a2d\u5b9a\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u3057\u3066\u3044\u307e\u3059\u3002\n\nhttps\n        location /redis {\n            mruby_content_handler /usr/local/nginx/conf/get_redis.rb;\n        }\n\n\n\nhttps\nhost = ENV[\"REDIS_PORT_6379_TCP_ADDR\"]\nport = ENV[\"REDIS_PORT_6379_TCP_PORT\"].to_i\ndb = Redis.new host, port\n\n# Note: a value must be String\n# > db.set \"key1\", 100\n# (mirb):1: expected String (TypeError)\n\ndb.set \"key1\", \"100\"\n\nvalue = db.get \"key1\"\n\nr = Nginx::Request.new\nr.content_type = \"text/html\"\nNginx.rputs \"host = #{host}, port = #{port}, value is #{value}\\n\"\n\n\n\u79c1\u306e\u74b0\u5883\u3067\u306fdocker\u3067lua-resty-redis\u306e\u30b3\u30f3\u30c6\u30ca\u304b\u3089redis\u306e\u30b3\u30f3\u30c6\u30ca\u306b\u901a\u4fe1\u3059\u308b\u30b5\u30f3\u30d7\u30eb - Qiita\u306b\u66f8\u3044\u305f\u3088\u3046\u306b8080\u219280\u306e\u30dd\u30fc\u30c8\u30d5\u30a9\u30ef\u30fc\u30c7\u30a3\u30f3\u30b0\u3092\u8a2d\u5b9a\u3057\u3066\u3044\u307e\u3059\u306e\u3067\u3001OSX\u3067\ncurl http://localhost:8080/redis\n\n\u3067\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3068\nhost = 172.17.0.2, port = 6379, value is 100\n\n\u3068\u3044\u3063\u305f\u51fa\u529b\u304c\u5f97\u3089\u308c\u307e\u3059\u3002\n# \u306f\u3058\u3081\u306b\n\n[matsumoto-r/ngx_mruby](https://github.com/matsumoto-r/ngx_mruby)\u3092CentOS\u3067\u8a66\u305d\u3046\u3068\u601d\u3044\u3001\u30d3\u30eb\u30c9\u3059\u308b\u305f\u3081\u306eDockerfile\u3092\u66f8\u3044\u3066\u307f\u307e\u3057\u305f\u3002\n[hnakamur/docker-ngx_mruby-centos](https://github.com/hnakamur/docker-ngx_mruby-centos)\u306b\u7f6e\u3044\u3066\u3042\u308a\u307e\u3059\u3002MIT\u30e9\u30a4\u30bb\u30f3\u30b9\u3067\u3059\u3002\n\n# ngx_mruby\u306e\u30d3\u30eb\u30c9\u8a2d\u5b9a\n\nngx_mruby\u3067\u306f\u30c7\u30d5\u30a9\u30eb\u30c8\u3067\u4ee5\u4e0b\u306e\u30e2\u30b8\u30e5\u30fc\u30eb\u3092\u30d3\u30eb\u30c9\u3059\u308b\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002\n\n```rb:https://github.com/matsumoto-r/ngx_mruby/blob/1b31fd205abede101dc44ebd042d702e3abbe84b/build_config.rb#L17-L34\n  #\n  # Recommended for ngx_mruby\n  #\n  # comment out because of moving error.h\n  conf.gem :git => 'git://github.com/iij/mruby-io.git'\n  conf.gem :git => 'git://github.com/iij/mruby-process.git'\n  conf.gem :git => 'git://github.com/iij/mruby-pack.git'\n  conf.gem :git => 'git://github.com/iij/mruby-digest.git'\n  conf.gem :git => 'git://github.com/mattn/mruby-json.git'\n  conf.gem :git => 'git://github.com/matsumoto-r/mruby-redis.git'\n  conf.gem :git => 'git://github.com/matsumoto-r/mruby-vedis.git'\n  conf.gem :git => 'git://github.com/matsumoto-r/mruby-memcached.git'\n  conf.gem :git => 'git://github.com/matsumoto-r/mruby-sleep.git'\n  conf.gem :git => 'git://github.com/matsumoto-r/mruby-userdata.git'\n  conf.gem :git => 'git://github.com/mattn/mruby-onig-regexp.git'\n\n  # ngx_mruby extended class\n  conf.gem :git => 'git://github.com/matsumoto-r/mruby-ngx-mruby-ext.git'\n```\n\n\u79c1\u306e\u66f8\u3044\u305fDockerfile\u3067\u306fbuild_config.rb\u3092\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u5909\u66f4\u3057\u3066\u3044\u307e\u3059\u3002\n\n```text:https://github.com/hnakamur/docker-ngx_mruby-centos/blob/febda057d8b6746e653012f1b3b2399f5295786a/Dockerfile#L63-L65\n    sed -i.orig \"s|conf.gem :git => 'git://github.com/matsumoto-r/mruby-memcached.git'|#&|;/^  conf.gem :git => 'git:\\/\\/github.com\\/mattn\\/mruby-onig-regexp.git'/a\\\n\\  conf.gem :git => 'git://github.com/iij/mruby-env.git'\" \\\n      build_config.rb && \\\n```\n\n* mruby-memcached\u306f\u30d3\u30eb\u30c9\u5bfe\u8c61\u304b\u3089\u5916\u3059\n    * [matsumoto-r/mruby-memcached](https://github.com/matsumoto-r/mruby-memcached)\u306flibmemcached\u306e\u30bd\u30fc\u30b9\u3092\u30d3\u30eb\u30c9\u3057\u3066\u53c2\u7167\u3059\u308b\u3088\u3046\u306b\u3057\u3066\u307f\u305f\u3093\u3067\u3059\u304c\u3001mruby-memcached\u304c\u30b3\u30f3\u30d1\u30a4\u30eb\u30a8\u30e9\u30fc\u306b\u306a\u3063\u3066\u3057\u307e\u3044\u307e\u3057\u305f\u3002\u3068\u308a\u3042\u3048\u305a\u79c1\u306f\u4f7f\u3046\u4e88\u5b9a\u304c\u306a\u304b\u3063\u305f\u306e\u3067\u5916\u3059\u3053\u3068\u306b\u3057\u307e\u3057\u305f\u3002\n* mruby-env\u3092\u8ffd\u52a0\n    * mruby\u306e\u30b9\u30af\u30ea\u30d7\u30c8\u5185\u3067\u74b0\u5883\u5909\u6570\u3092\u53c2\u7167\u3057\u305f\u304b\u3063\u305f\u306e\u3067[iij/mruby-env](https://github.com/iij/mruby-env)\u3092\u8ffd\u52a0\u3057\u307e\u3057\u305f\u3002\n\n# nginx\u306e\u30d3\u30eb\u30c9\n\n[matsumoto-r/ngx_mruby\u306eBuild\u306e\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8](https://github.com/matsumoto-r/ngx_mruby#2-build)\u306b\u306f3\u901a\u308a\u306e\u65b9\u6cd5\u304c\u66f8\u304b\u308c\u3066\u3044\u307e\u3059\u3002nginx\u306b\u30e2\u30b8\u30e5\u30fc\u30eb\u3092\u8ffd\u52a0\u3057\u305f\u3044\u5834\u5408\u3082\u3042\u308b\u306e\u3067\u30013\u756a\u3081\u306e\u65b9\u6cd5\u306b\u3057\u305f\u304b\u3063\u305f\u306e\u3067\u3059\u304c\u3001mruby\u304c\u30d3\u30eb\u30c9\u3055\u308c\u305a\u30a8\u30e9\u30fc\u306b\u306a\u3063\u3066\u3057\u307e\u3063\u305f\u306e\u3067\u30011\u756a\u3081\u306e\u65b9\u6cd5\u3067mruby\u3092\u30d3\u30eb\u30c9\u3057\u3066\u304a\u3044\u3066\u304b\u3089\u30013\u756a\u3081\u306e\u65b9\u6cd5\u3067\u30d3\u30eb\u30c9\u3059\u308b\u3088\u3046\u306b\u3057\u3066\u307f\u305f\u3089\u3001\u3046\u307e\u304f\u884c\u304d\u307e\u3057\u305f\u3002\n\nnginx\u306econfigure\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u3057\u3066\u3044\u307e\u3059\u3002\u9069\u5b9c\u5909\u66f4\u3057\u3066\u3054\u5229\u7528\u304f\u3060\u3055\u3044\u3002\n\n```text:https://github.com/hnakamur/docker-ngx_mruby-centos/blob/febda057d8b6746e653012f1b3b2399f5295786a/Dockerfile#L100-L125\n    ./configure --prefix=/usr/local/nginx \\\n      --user=nginx \\\n      --group=nginx \\\n      --with-file-aio \\\n      --with-ipv6 \\\n      --with-http_ssl_module \\\n      --with-http_realip_module \\\n      --with-http_addition_module \\\n      --with-http_xslt_module \\\n      --with-http_image_filter_module \\\n      --with-http_geoip_module \\\n      --with-http_sub_module \\\n      --with-http_dav_module \\\n      --with-http_flv_module \\\n      --with-http_mp4_module \\\n      --with-http_gzip_static_module \\\n      --with-http_random_index_module \\\n      --with-http_secure_link_module \\\n      --with-http_degradation_module \\\n      --with-http_stub_status_module \\\n      --with-md5-asm \\\n      --with-sha1-asm \\\n      --with-pcre-jit --with-pcre=/usr/local/src/pcre-8.35 \\\n      --with-cc-opt='-O2 -g' \\\n      --add-module=/usr/local/src/ngx_mruby \\\n      --add-module=/usr/local/src/ngx_mruby/dependence/ngx_devel_kit && \\\n```\n\n\n# mruby\u3068nginx\u304c\u4f9d\u5b58\u3057\u3066\u3044\u308b\u3082\u306e\u306e\u30d3\u30eb\u30c9\u307e\u305f\u306f\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n* ruby\n    * mruby\u306e\u30d3\u30eb\u30c9\u306b\u5fc5\u8981\u30022.1.1\u3092\u30bd\u30fc\u30b9\u304b\u3089\u30d3\u30eb\u30c9\n* [Redis](http://redis.io/)\n    * [redis/hiredis](https://github.com/redis/hiredis)\u306e\u30d3\u30eb\u30c9\u306b\u5fc5\u8981\n    * \u30bd\u30fc\u30b9\u304b\u3089\u30d3\u30eb\u30c9\n* [redis/hiredis](https://github.com/redis/hiredis)\n    * [matsumoto-r/mruby-redis](https://github.com/matsumoto-r/mruby-redis)\u304c\u4f9d\u5b58\n    * \u30bd\u30fc\u30b9\u304b\u3089\u30d3\u30eb\u30c9\n* [PCRE - Perl Compatible Regular Expressions](http://www.pcre.org/)\n    * JIT\u3092\u4f7f\u3044\u305f\u3044(nginx\u306econfigure\u306e--with-pcre-jit\u30aa\u30d7\u30b7\u30e7\u30f3)\u306e\u3067\u6700\u65b0\u72488.35\u3092\u30bd\u30fc\u30b9\u304b\u3089\u30d3\u30eb\u30c9\n* [GeoIP](https://www.maxmind.com/ja/geolocation_landing)\n    * \u3053\u308c\u306f\u4f9d\u5b58\u3057\u3066\u3044\u308b\u3068\u3044\u3046\u308f\u3051\u3067\u306f\u306a\u304f\u3001nginx\u306bGeoIP\u30e2\u30b8\u30e5\u30fc\u30eb\u3092\u7d44\u307f\u8fbc\u3093\u3067(nginx\u306econfigure\u306e--with-http_geoip_module\u30aa\u30d7\u30b7\u30e7\u30f3)\u30d3\u30eb\u30c9\u3057\u305f\u304b\u3063\u305f\u306e\u3067\u5229\u7528\u3002\n    * epel\u304b\u3089\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n    * \u30bd\u30fc\u30b9\u304b\u3089\u30d3\u30eb\u30c9\u3059\u308b\u5834\u5408\u306f[How to install Nginx GeoIP module](http://www.nginxtips.com/how-to-install-nginx-geoip-module/)\u304c\u53c2\u8003\u306b\u306a\u308a\u305d\u3046\u3067\u3059\uff08\u8a66\u3057\u3066\u306a\u3044\u3067\u3059\uff09\u3002\n\n# Docker\u30a4\u30e1\u30fc\u30b8\u306e\u30d3\u30eb\u30c9\n\nDockerfile\u306e\u3042\u308b\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3067\u4ee5\u4e0b\u306e\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3057\u307e\u3059\u3002\n\n```shell-session\ndocker build -t hnakamur/ngx_mruby .\n```\n\n# \u30b3\u30f3\u30c6\u30ca\u306e\u8d77\u52d5\n\nredis\u306f[docker\u3067lua-resty-redis\u306e\u30b3\u30f3\u30c6\u30ca\u304b\u3089redis\u306e\u30b3\u30f3\u30c6\u30ca\u306b\u901a\u4fe1\u3059\u308b\u30b5\u30f3\u30d7\u30eb - Qiita](http://qiita.com/hnakamur/items/1a0c401bdaef88b3f7f5)\u306e\u8a18\u4e8b\u3067\u4f5c\u3063\u305f\u30b3\u30f3\u30c6\u30ca\u3092\u5229\u7528\u3057\u307e\u3059\u3002\u4ee5\u4e0b\u306e\u30b3\u30de\u30f3\u30c9\u3067redis\u306e\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3057\u307e\u3059\u3002\n\n```shell-session\ndocker run -d -p 6379:6379 -name redis hnakamur/redis\n```\n\n\u4ee5\u4e0b\u306e\u30b3\u30de\u30f3\u30c9\u3067ngx_mruby\u306e\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3057\u307e\u3059\u3002\n\n```shell-session\ndocker run -d -p 80:80 -link redis:redis hnakamur/ngx_mruby\n```\n\n# ngx_mruby\u304b\u3089redis\u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u30b5\u30f3\u30d7\u30eb\n\n\u307e\u305aDocker\u306b\u3088\u3063\u3066\u74b0\u5883\u5909\u6570\u3092\u53c2\u7167\u3059\u308b\u305f\u3081\u306bnginx.conf\u306b\u4ee5\u4e0b\u306e\u8a2d\u5b9a\u3092\u5165\u308c\u3066\u3044\u307e\u3059\u3002\n\n```text:https://github.com/hnakamur/docker-ngx_mruby-centos/blob/febda057d8b6746e653012f1b3b2399f5295786a/conf/nginx.conf#L1-L2\nenv REDIS_PORT_6379_TCP_ADDR;\nenv REDIS_PORT_6379_TCP_PORT;\n```\n\n/redis\u306elocation\u8a2d\u5b9a\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u3057\u3066\u3044\u307e\u3059\u3002\n\n```text:https://github.com/hnakamur/docker-ngx_mruby-centos/blob/febda057d8b6746e653012f1b3b2399f5295786a/conf/nginx.conf#L26-L28\n        location /redis {\n            mruby_content_handler /usr/local/nginx/conf/get_redis.rb;\n        }\n```\n\n```rb:https://github.com/hnakamur/docker-ngx_mruby-centos/blob/febda057d8b6746e653012f1b3b2399f5295786a/conf/get_redis.rb\nhost = ENV[\"REDIS_PORT_6379_TCP_ADDR\"]\nport = ENV[\"REDIS_PORT_6379_TCP_PORT\"].to_i\ndb = Redis.new host, port\n\n# Note: a value must be String\n# > db.set \"key1\", 100\n# (mirb):1: expected String (TypeError)\n\ndb.set \"key1\", \"100\"\n\nvalue = db.get \"key1\"\n\nr = Nginx::Request.new\nr.content_type = \"text/html\"\nNginx.rputs \"host = #{host}, port = #{port}, value is #{value}\\n\"\n```\n\n\u79c1\u306e\u74b0\u5883\u3067\u306f[docker\u3067lua-resty-redis\u306e\u30b3\u30f3\u30c6\u30ca\u304b\u3089redis\u306e\u30b3\u30f3\u30c6\u30ca\u306b\u901a\u4fe1\u3059\u308b\u30b5\u30f3\u30d7\u30eb - Qiita](http://qiita.com/hnakamur/items/1a0c401bdaef88b3f7f5)\u306b\u66f8\u3044\u305f\u3088\u3046\u306b8080\u219280\u306e\u30dd\u30fc\u30c8\u30d5\u30a9\u30ef\u30fc\u30c7\u30a3\u30f3\u30b0\u3092\u8a2d\u5b9a\u3057\u3066\u3044\u307e\u3059\u306e\u3067\u3001OSX\u3067\n\n```shell-session\ncurl http://localhost:8080/redis\n```\n\n\u3067\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3068\n\n```\nhost = 172.17.0.2, port = 6379, value is 100\n```\n\n\u3068\u3044\u3063\u305f\u51fa\u529b\u304c\u5f97\u3089\u308c\u307e\u3059\u3002"}