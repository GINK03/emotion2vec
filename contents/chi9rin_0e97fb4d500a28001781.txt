{"context": "\n\n\u7d9a\u7de8\u3067\u3059\nSELinux \u3092\u4f7f\u304a\u3046\uff0e\u4f7f\u3063\u3066\u304f\u308c\uff0e \u3068\u3057\u3066 2016 \u5e74\u306e  Linux Advent Calendar 2016 \u306b\u6295\u7a3f\u3057\u305f\u3068\u3053\u308d\u8a71\u304c\u5927\u304d\u304f\u306a\u3063\u305f\u306e\u3067\uff0c\u7d9a\u7de8\u3092\u66f8\u304f\u3053\u3068\u306b\u3057\u307e\u3057\u305f\uff0e\n\n\u4eca\u56de\u306e\u304a\u984c\nSELinux \u3092\u6709\u52b9\u306b\u3057\u305f\u74b0\u5883\u3068\u7121\u52b9\u306b\u3057\u305f\u74b0\u5883\u3067\uff0cApache \u3067\u52d5\u304b\u3059 CGI \u3092\u4f7f\u3063\u3066\u30d0\u30c3\u30b0\u30c9\u30a2\u7684\u306a\u3082\u306e\u3092\u57cb\u3081\u8fbc\u3093\u3060\u6642\u306e\u6319\u52d5\u306e\u5dee\u3092\u898b\u3066\u3044\u304d\u307e\u3059\uff0e\n\n\u74b0\u5883\nOS: CentOS 7.3.1611\nSELinux: targeted mode\n\n\u4f7f\u3046 CGI\n\u624b\u9593\u3092\u5272\u304f\u305f\u3081\u306b ncat \u3092\u4f7f\u3044\u307e\u3059\uff0e\nCGI \u304c\u5b9f\u884c\u3055\u308c\u308b\u3068 0.0.0.0:9000 \u3092\u958b\u3051\u3066\u5f85\u3061\u307e\u3059\uff0e\nCentOS \u306e\u5834\u5408\u306f apache \u30e6\u30fc\u30b6\u3067 Apache \u306e\u30ef\u30fc\u30ab\u30d7\u30ed\u30bb\u30b9\u304c\u52d5\u4f5c\u3059\u308b\u305f\u3081 Well-know Ports \u306f\u958b\u3051\u306a\u3044\u306e\u3067\uff0c\u9069\u5f53\u306a\u30dd\u30fc\u30c8\u3092\u9078\u3093\u3067\u3044\u307e\u3059\uff0e\n\u307e\u305f HTTP \u7528\u306e\u30dd\u30fc\u30c8\u3068\u3057\u3066\u767b\u9332\u3055\u308c\u3066\u3044\u308b\u3082\u306e\u306b\u3057\u3066\u3044\u307e\u3059\uff0e\n\uff08\u307e\u3063\u305f\u304f\u898b\u5f53\u9055\u3044\u306e\u30dd\u30fc\u30c8\u3092\u4f7f\u3046\u3068\u5f3e\u304b\u308c\u308b\u306e\u306f\u76ee\u306b\u898b\u3048\u3066\u3044\u3066\u9762\u767d\u304f\u306a\u3044\u304b\u3089\uff09\n# semanage port -l | grep 9000\nhttp_port_t   tcp    80, 81, 443, 488, 8008, 8009, 8443, 9000\n\n#!/bin/sh\necho \"content-type: text/plain\"\necho \"\"\n\nnc 0.0.0.0 -l 9000 &\n\n\n\u3084\u3063\u3066\u307f\u3088\u3046\n\nSELinux \u3092\u7121\u52b9\u5316\u3082\u3057\u304f\u306f Permissive \u30e2\u30fc\u30c9\u306b\u3057\u3066\u3044\u308b\u5834\u5408\n\u307e\u305a\u306f CGI \u306b\u30a2\u30af\u30bb\u30b9\u3057\u307e\u3059\uff0e\u30b3\u30f3\u30c6\u30f3\u30c4\u304c\u8fd4\u3063\u3066\u3053\u306a\u3044\u306e\u3067\u30d6\u30ed\u30c3\u30af\u3057\u307e\u3059\uff0e\n\n\u30bf\u30fc\u30df\u30ca\u30eb\u305d\u306e1\n$ curl localhost/cgi-bin/nc.sh\n<<< \u3053\u3053\u3067\u30d6\u30ed\u30c3\u30af\u3059\u308b >>>\n\n\n\u3059\u308b\u3068 nc \u304c 9000/tcp \u3092\u958b\u3051\u3066\u5f85\u3063\u3066\u304f\u308c\u307e\u3059\uff0e\n\n\u30bf\u30fc\u30df\u30ca\u30eb\u305d\u306e2\n# ss -atnp\nState      Recv-Q Send-Q     Local Address:Port      Peer Address:Port\nLISTEN     0      128                    *:111                  *:*          users:((\"systemd\",pid=1,fd=40))\nLISTEN     0      5          192.168.122.1:53                   *:*          users:((\"dnsmasq\",pid=1343,fd=6))\nLISTEN     0      128                    *:22                   *:*          users:((\"sshd\",pid=1166,fd=3))\nLISTEN     0      128            127.0.0.1:631                  *:*          users:((\"cupsd\",pid=1144,fd=12))\nLISTEN     0      100            127.0.0.1:25                   *:*          users:((\"master\",pid=1291,fd=13))\nLISTEN     0      10                     *:9000                 *:*          users:((\"nc\",pid=2082,fd=3))\nESTAB      0      0          192.168.0.111:22         192.168.0.2:55270      users:((\"sshd\",pid=1953,fd=3),(\"sshd\",pid=1949,fd=3))\nESTAB      0      52         192.168.0.111:22         192.168.0.2:54375      users:((\"sshd\",pid=1452,fd=3),(\"sshd\",pid=1447,fd=3))\nLISTEN     0      128                   :::111                 :::*          users:((\"systemd\",pid=1,fd=39))\nLISTEN     0      128                   :::80                  :::*          users:((\"httpd\",pid=1902,fd=4),(\"httpd\",pid=1901,fd=4),(\"httpd\",pid=1900,fd=4),(\"httpd\",pid=1873,fd=4),(\"httpd\",pid=1870,fd=4),(\"httpd\",pid=1869,fd=4),(\"httpd\",pid=1868,fd=4),(\"httpd\",pid=1867,fd=4),(\"httpd\",pid=1866,fd=4),(\"httpd\",pid=1865,fd=4))\nLISTEN     0      128                   :::22                  :::*          users:((\"sshd\",pid=1166,fd=4))\nLISTEN     0      128                  ::1:631                 :::*          users:((\"cupsd\",pid=1144,fd=11))\nLISTEN     0      100                  ::1:25                  :::*          users:((\"master\",pid=1291,fd=14))\nESTAB      0      0                    ::1:80                 ::1:34120      users:((\"httpd\",pid=1869,fd=9))\nESTAB      0      0                    ::1:34120              ::1:80         users:((\"curl\",pid=2079,fd=3))\n\n\n\u305d\u3053\u3067\u5225\u306e\u30bf\u30fc\u30df\u30ca\u30eb\u304b\u3089\u3053\u3053\u306b\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u9001\u308a\u307e\u3059\uff0e\n\n\u30bf\u30fc\u30df\u30ca\u30eb3\n$ nc localhost 9000\nhogehoge\nfoobar\nfoobarbaz\n<<<Ctrl-D>>>\n\n\nnc \u3067\u30c6\u30ad\u30b9\u30c8\u3092\u9001\u308b\u3068\uff0c\u5148\u307b\u3069\u30d6\u30ed\u30c3\u30af\u3057\u3066\u3044\u305f\uff08curl \u3057\u305f\uff09\u30bf\u30fc\u30df\u30ca\u30eb\u306b\uff0c\u30bf\u30fc\u30df\u30ca\u30eb 3 \u3067\u9001\u4fe1\u3057\u305f\u30e1\u30c3\u30bb\u30fc\u30b8\u304c\u8868\u793a\u3055\u308c\u3066\u3044\u307e\u3059\uff0e\n\n\u30bf\u30fc\u30df\u30ca\u30eb\u305d\u306e1\n$ curl localhost/cgi-bin/nc.sh\nhogehoge\nfoobar\nfoobarbaz\n\n\n\n\u306a\u306b\u304c\u8d77\u304d\u3066\u3044\u308b\u306e\u304b\nCGI \u3092\u5b9f\u884c\u3055\u308c\u305f\u3068\u304d\u306b nc \u304c 0.0.0.0:9000 \u3092\u958b\u3044\u3066\u5f85\u3061\u307e\u3059\uff0e\n\u305d\u3053\u306b\u4ed6\u306e\u30bf\u30fc\u30df\u30ca\u30eb\u304b\u3089\u9069\u5f53\u306a\u6587\u5b57\u5217\u3092\u9001\u308b\u3068\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u5074\u306b\u6587\u5b57\u5217\u3092\u9001\u4fe1\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\uff0e\n\u4eca\u56de\u306e\u4f8b\u3067\u306f\u305f\u3060\u6587\u5b57\u5217\u3092\u9001\u308b\u3060\u3051\u3067\u3057\u305f\u304c\uff0c\u672c\u8cea\u7684\u306a\u8ab2\u984c\u306f\n\n\u4efb\u610f\u306e\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3067\u304d\u3066\u3057\u307e\u3046\n\u5834\u5408\u306b\u3088\u3063\u3066\u306f\u4efb\u610f\u306e\u30dd\u30fc\u30c8\u3092\u958b\u304f\u3053\u3068\u304c\u3067\u304d\u3066\u3057\u307e\u3046\n\n\u3068\u3044\u3046\u3053\u3068\u3067\u3059\uff0e\n\n\u3067\u306f SELinux \u3092 Enforce \u30e2\u30fc\u30c9\u306b\u3057\u3066\u307f\u307e\u3057\u3087\u3046\n\u307e\u305a\u306f CGI \u306b\u30a2\u30af\u30bb\u30b9\u3057\u307e\u3059\uff0e\n\u4eca\u56de\u306f\u30b3\u30f3\u30c6\u30f3\u30c4\u304c\u8fd4\u3063\u3066\u304d\u3082\u3057\u306a\u3044\uff0c\u30d6\u30ed\u30c3\u30af\u3082\u3057\u307e\u305b\u3093\uff0e\n\n\u30bf\u30fc\u30df\u30ca\u30eb\u305d\u306e1\n$ curl localhost/cgi-bin/nc.sh\n$ \n\n\nnc \u306f\uff1f \n\n\u30bf\u30fc\u30df\u30ca\u30eb\u305d\u306e2\n# ss -atnp\nState      Recv-Q Send-Q    Local Address:Port       Peer Address:Port\nLISTEN     0      128                   *:111                   *:*          users:((\"systemd\",pid=1,fd=40))\nLISTEN     0      5         192.168.122.1:53                    *:*          users:((\"dnsmasq\",pid=1343,fd=6))\nLISTEN     0      128                   *:22                    *:*          users:((\"sshd\",pid=1166,fd=3))\nLISTEN     0      128           127.0.0.1:631                   *:*          users:((\"cupsd\",pid=1144,fd=12))\nLISTEN     0      100           127.0.0.1:25                    *:*          users:((\"master\",pid=1291,fd=13))\nESTAB      0      0         192.168.0.111:22          192.168.0.2:55270      users:((\"sshd\",pid=1953,fd=3),(\"sshd\",pid=1949,fd=3))\nESTAB      0      0         192.168.0.111:22          192.168.0.2:54375      users:((\"sshd\",pid=1452,fd=3),(\"sshd\",pid=1447,fd=3))\nLISTEN     0      128                  :::111                  :::*          users:((\"systemd\",pid=1,fd=39))\nLISTEN     0      128                  :::80                   :::*          users:((\"httpd\",pid=1902,fd=4),(\"httpd\",pid=1901,fd=4),(\"httpd\",pid=1900,fd=4),(\"httpd\",pid=1873,fd=4),(\"httpd\",pid=1870,fd=4),(\"httpd\",pid=1869,fd=4),(\"httpd\",pid=1868,fd=4),(\"httpd\",pid=1867,fd=4),(\"httpd\",pid=1866,fd=4),(\"httpd\",pid=1865,fd=4))\nLISTEN     0      128                  :::22                   :::*          users:((\"sshd\",pid=1166,fd=4))\nLISTEN     0      128                 ::1:631                  :::*          users:((\"cupsd\",pid=1144,fd=11))\nLISTEN     0      100                 ::1:25                   :::*          users:((\"master\",pid=1291,fd=14))\n\n# ss -atnp | grep nc\n\n\n\u3044\u306a\u3044\u3093\u3067\u3059\uff0e\nApache \u306e\u30ed\u30b0\u3092\u898b\u3066\u307f\u307e\u3057\u3087\u3046\uff0e\n\n/var/log/httpd/error_log\n[Sun Jan 08 11:30:30.374900 2017] [cgi:error] [pid 1867] [client ::1:34144] AH01215: Ncat: bind to 0.0.0.0:9000: Permission denied. QUITTING.\n\n\nnc \u304c Permission denied \u98df\u3089\u3063\u3066\u3044\u307e\u3059\uff0e\n\u7d9a\u3044\u3066 audit \u30ed\u30b0\u3092\u898b\u3066\u307f\u307e\u3059\uff0e\n# ausearch -m avc\n...\uff08\u7565\uff09... \ntime->Sun Jan  8 11:30:30 2017\ntype=SYSCALL msg=audit(1483842630.373:431): arch=c000003e syscall=49 success=no exit=-13 a0=3 a1=658c60 a2=80 a3=7ffddcbf3e10 items=0 ppid=1 pid=31418 auid=4294967295 uid=48 gid=48 euid=48 suid=48 fsuid=48 egid=48 sgid=48 fsgid=48 tty=(none) ses=4294967295 comm=\"nc\" exe=\"/usr/bin/ncat\" subj=system_u:system_r:httpd_sys_script_t:s0 key=(null)\ntype=AVC msg=audit(1483842630.373:431): avc:  denied  { name_bind } for  pid=31418 comm=\"nc\" src=9000 scontext=system_u:system_r:httpd_sys_script_t:s0 tcontext=system_u:object_r:http_port_t:s0 tclass=tcp_socket\n\nsystem_u:system_r:httpd_sys_script_t:s0 \u306a\u3084\u3064\u304c nc \u3092\u5b9f\u884c\u3057\u3066 http_port_t \u306e 9000/tcp \u3092\u30d0\u30a4\u30f3\u30c9\u3057\u3088\u3046\u3068\u3057\u305f\u304b\u3089\u5374\u4e0b\u3057\u305f\u305c\uff0c\u3068 audit \u30ed\u30b0\u306b\u6b8b\u3063\u3066\u3044\u307e\u3059\uff0e\n\n\u306a\u3093\u3067\uff1f\n\u307e\u305a\u5b9f\u884c\u3057\u305f CGI \u306e\u30b3\u30f3\u30c6\u30ad\u30b9\u30c8\u3092\u307f\u3066\u307f\u307e\u3059\uff0e\nCGI \u306e\u5b9f\u884c\u306b\u306f httpd_sys_script_exec_t \u304c\u5fc5\u8981\u3067\uff0c\u5148\u306e\u3068\u304a\u308a CGI \u81ea\u4f53\u306f\u6b63\u3057\u304f\u52d5\u3044\u3066\u3044\u308b\u306e\u3067\u30d5\u30a1\u30a4\u30eb\u30b3\u30f3\u30c6\u30ad\u30b9\u30c8\u3082\u6b63\u3057\u304f\u4ed8\u3044\u3066\u3044\u307e\u3059\uff0e\naudit \u30ed\u30b0\u306b\u3082\u3053\u306e\u30b3\u30f3\u30c6\u30ad\u30b9\u30c8\u306e\u9055\u53cd\u304c\u8a18\u9332\u3055\u308c\u3066\u3044\u308b\u306e\u3067\u9593\u9055\u3044\u306f\u3042\u308a\u307e\u305b\u3093\uff0e\n# ls -Z /var/www/cgi-bin/\n-rwxr-xr-x. root root unconfined_u:object_r:httpd_sys_script_exec_t:s0 nc.sh\n\n\u3064\u3065\u3044\u3066 SELinux \u306e\u8a2d\u5b9a\u3092\u898b\u3066\u307f\u307e\u3059\uff0e\n\u30dd\u30fc\u30c8\u3092\u30d0\u30a4\u30f3\u30c9\u3057\u3066\u958b\u304f\u305f\u3081\u306b\u306f\uff0cname_bind \u304c\u8a31\u53ef\u3055\u308c\u3066\u3044\u306a\u3051\u308c\u3070\u306a\u308a\u307e\u305b\u3093\uff0e\nhttpd_sys_script_exec_t \u304c http_port_t \u3092 name_bind \u3067\u304d\u308b\u304b\u3092\u8abf\u3079\u3066\u307f\u307e\u3059\uff0e\n# sesearch --allow -s httpd_sys_script_t | grep http_port_t\n# \n\n\u7d50\u679c\u306f\u8a72\u5f53\u306a\u3057\uff0e\n\u3067\u306f\u3069\u3093\u306a\u30dd\u30fc\u30c8\u3092 name_bind \u51fa\u6765\u308b\u306e\u304b\u3068\u3044\u3046\u3068\n# sesearch --allow -s httpd_sys_script_t | grep name_bind\n   allow httpd_script_type ephemeral_port_t : udp_socket name_bind ;\n   allow nsswitch_domain port_t : udp_socket name_bind ;\n   allow httpd_script_type port_t : udp_socket name_bind ;\n   allow nsswitch_domain port_t : tcp_socket name_bind ;\n   allow nsswitch_domain ephemeral_port_t : udp_socket name_bind ;\n   allow httpd_script_type port_t : tcp_socket name_bind ;\n   allow nsswitch_domain unreserved_port_t : udp_socket name_bind ;\n   allow nsswitch_domain ephemeral_port_t : tcp_socket name_bind ;\n   allow httpd_script_type unreserved_port_t : udp_socket name_bind ;\n   allow httpd_script_type ephemeral_port_t : tcp_socket name_bind ;\n   allow nsswitch_domain unreserved_port_t : tcp_socket name_bind ;\n   allow httpd_script_type unreserved_port_t : tcp_socket name_bind ;\n\n\u305f\u3068\u3048\u3070\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u3068\u3057\u3066\u30a8\u30d5\u30a7\u30e1\u30e9\u30eb\u30dd\u30fc\u30c8\uff0832768-61000\uff09\u3092\u958b\u3044\u305f\u308a\u3068\u3044\u3046\u611f\u3058\u3067\u3059\uff0e\n\u72ec\u81ea\u306b\u30b5\u30fc\u30d3\u30b9\u7528\u30dd\u30fc\u30c8\u3092\u958b\u304f\u3053\u3068\u306f\u3067\u304d\u307e\u305b\u3093\uff0e\n\u305d\u3093\u306a\u8a33\u3067\uff0c\u6b63\u3057\u304f SELinux \u304c\u8a2d\u5b9a\u3055\u308c\u3066\u3044\u308b\u72b6\u6cc1\u4e0b\u3067\u306f\uff0c\u4e0d\u6b63\u306b\u30dd\u30fc\u30c8\u3092\u958b\u3044\u305f\u308a\u3059\u308b\u3053\u3068\u306f\u51fa\u6765\u306a\u3044\u306e\u3067\u3059\uff0e\n\u3061\u306a\u307f\u306b Apache \u306f\u3069\u3046\u3084\u3063\u3066 WKP \u306e 80/tcp \u3092\u958b\u3044\u3066\u3044\u308b\u306e\u304b\u3068\u8a00\u3046\u3068\uff0e\uff0e\uff0e\n# ps xafZ | grep httpd | grep -v grep\nsystem_u:system_r:httpd_t:s0      1865 ?        Ss     0:00 /usr/sbin/httpd -DFOREGROUND\nsystem_u:system_r:httpd_t:s0      1866 ?        S      0:00  \\_ /usr/sbin/httpd -DFOREGROUND\nsystem_u:system_r:httpd_t:s0      1867 ?        S      0:00  \\_ /usr/sbin/httpd -DFOREGROUND\nsystem_u:system_r:httpd_t:s0      1868 ?        S      0:00  \\_ /usr/sbin/httpd -DFOREGROUND\nsystem_u:system_r:httpd_t:s0      1869 ?        S      0:00  \\_ /usr/sbin/httpd -DFOREGROUND\nsystem_u:system_r:httpd_t:s0      1870 ?        S      0:00  \\_ /usr/sbin/httpd -DFOREGROUND\nsystem_u:system_r:httpd_t:s0      1873 ?        S      0:00  \\_ /usr/sbin/httpd -DFOREGROUND\nsystem_u:system_r:httpd_t:s0      1900 ?        S      0:00  \\_ /usr/sbin/httpd -DFOREGROUND\nsystem_u:system_r:httpd_t:s0      1901 ?        S      0:00  \\_ /usr/sbin/httpd -DFOREGROUND\nsystem_u:system_r:httpd_t:s0      1902 ?        S      0:00  \\_ /usr/sbin/httpd -DFOREGROUND\n\n# sesearch --allow -s httpd_t -t http_port_t\nFound 11 semantic av rules:\n   allow httpd_t port_type : tcp_socket { recv_msg send_msg } ;\n   allow httpd_t port_type : udp_socket { recv_msg send_msg } ;\n   allow httpd_t http_port_t : udp_socket name_bind ;\n   allow httpd_t http_port_t : tcp_socket name_bind ;\n   allow httpd_t port_type : tcp_socket name_connect ;\n   allow nsswitch_domain port_type : udp_socket recv_msg ;\n   allow nsswitch_domain port_type : udp_socket send_msg ;\n   allow nsswitch_domain port_type : tcp_socket { recv_msg send_msg } ;\n   allow httpd_t http_port_t : tcp_socket name_connect ;\n   allow httpd_t http_port_t : tcp_socket name_connect ;\n   allow nsswitch_domain reserved_port_type : tcp_socket name_connect ;\n\n\u4e0a\u8a18\u306e\u3068\u304a\u308a\uff0chttpd_t \u306a\u30b3\u30f3\u30c6\u30ad\u30b9\u30c8\u304b\u3089 http_port_t \u3092\u958b\u3051\u3066\u3044\u308b\u3068\u3044\u3046\u8a33\u3067\u3059\uff0e\n\n\u304a\u308f\u308a\u306b\n\u4eca\u56de\u306f\u30dd\u30ea\u30b7\u306b\u5b9a\u7fa9\u3055\u308c\u3066\u3044\u306a\u3044\u4e0d\u6b63\u306a\u6319\u52d5\u3092\u3059\u308b\u3082\u306e\u3092\u3042\u3048\u3066\u5b9f\u884c\u3057\uff0c\u7d50\u679c\u3092\u89b3\u5bdf\u3057\u3066\u3044\u304d\u307e\u3057\u305f\uff0e\n\u3082\u3061\u308d\u3093\u3053\u306e\u3088\u3046\u306a\u52d5\u4f5c\u304c\u5fc5\u8981\u306a\u5834\u5408\u306f\uff0c\u72ec\u81ea\u306b\u30dd\u30fc\u30c8\u3092\u5b9a\u7fa9\u3057 SELinux \u306b\u30dd\u30ea\u30b7\u3092\u5b9a\u7fa9\u3057\u3066\u3042\u3052\u308c\u3070\u6b63\u3057\u304f\u52d5\u304b\u3059\u3053\u3068\u304c\u53ef\u80fd\u3067\u3059\uff0e\n\u624b\u9806\u306f\u4eca\u5ea6\u66f8\u304d\u307e\u3057\u3087\u3046\u304b\uff0e\uff0e\uff0e\n# \u7d9a\u7de8\u3067\u3059\n[SELinux \u3092\u4f7f\u304a\u3046\uff0e\u4f7f\u3063\u3066\u304f\u308c\uff0e](http://qiita.com/chi9rin/items/af532d0dd9237cc65741) \u3068\u3057\u3066 2016 \u5e74\u306e  Linux Advent Calendar 2016 \u306b\u6295\u7a3f\u3057\u305f\u3068\u3053\u308d\u8a71\u304c\u5927\u304d\u304f\u306a\u3063\u305f\u306e\u3067\uff0c\u7d9a\u7de8\u3092\u66f8\u304f\u3053\u3068\u306b\u3057\u307e\u3057\u305f\uff0e\n\n# \u4eca\u56de\u306e\u304a\u984c\nSELinux \u3092\u6709\u52b9\u306b\u3057\u305f\u74b0\u5883\u3068\u7121\u52b9\u306b\u3057\u305f\u74b0\u5883\u3067\uff0cApache \u3067\u52d5\u304b\u3059 CGI \u3092\u4f7f\u3063\u3066\u30d0\u30c3\u30b0\u30c9\u30a2\u7684\u306a\u3082\u306e\u3092\u57cb\u3081\u8fbc\u3093\u3060\u6642\u306e\u6319\u52d5\u306e\u5dee\u3092\u898b\u3066\u3044\u304d\u307e\u3059\uff0e\n\n# \u74b0\u5883\nOS: CentOS 7.3.1611\nSELinux: targeted mode\n\n# \u4f7f\u3046 CGI\n\u624b\u9593\u3092\u5272\u304f\u305f\u3081\u306b ncat \u3092\u4f7f\u3044\u307e\u3059\uff0e\nCGI \u304c\u5b9f\u884c\u3055\u308c\u308b\u3068 0.0.0.0:9000 \u3092\u958b\u3051\u3066\u5f85\u3061\u307e\u3059\uff0e\nCentOS \u306e\u5834\u5408\u306f apache \u30e6\u30fc\u30b6\u3067 Apache \u306e\u30ef\u30fc\u30ab\u30d7\u30ed\u30bb\u30b9\u304c\u52d5\u4f5c\u3059\u308b\u305f\u3081 Well-know Ports \u306f\u958b\u3051\u306a\u3044\u306e\u3067\uff0c\u9069\u5f53\u306a\u30dd\u30fc\u30c8\u3092\u9078\u3093\u3067\u3044\u307e\u3059\uff0e\n\u307e\u305f HTTP \u7528\u306e\u30dd\u30fc\u30c8\u3068\u3057\u3066\u767b\u9332\u3055\u308c\u3066\u3044\u308b\u3082\u306e\u306b\u3057\u3066\u3044\u307e\u3059\uff0e\n\uff08\u307e\u3063\u305f\u304f\u898b\u5f53\u9055\u3044\u306e\u30dd\u30fc\u30c8\u3092\u4f7f\u3046\u3068\u5f3e\u304b\u308c\u308b\u306e\u306f\u76ee\u306b\u898b\u3048\u3066\u3044\u3066\u9762\u767d\u304f\u306a\u3044\u304b\u3089\uff09\n\n```\n# semanage port -l | grep 9000\nhttp_port_t   tcp    80, 81, 443, 488, 8008, 8009, 8443, 9000\n```\n\n```\n#!/bin/sh\necho \"content-type: text/plain\"\necho \"\"\n\nnc 0.0.0.0 -l 9000 &\n```\n\n# \u3084\u3063\u3066\u307f\u3088\u3046\n## SELinux \u3092\u7121\u52b9\u5316\u3082\u3057\u304f\u306f Permissive \u30e2\u30fc\u30c9\u306b\u3057\u3066\u3044\u308b\u5834\u5408\n\u307e\u305a\u306f CGI \u306b\u30a2\u30af\u30bb\u30b9\u3057\u307e\u3059\uff0e\u30b3\u30f3\u30c6\u30f3\u30c4\u304c\u8fd4\u3063\u3066\u3053\u306a\u3044\u306e\u3067\u30d6\u30ed\u30c3\u30af\u3057\u307e\u3059\uff0e\n\n```text:\u30bf\u30fc\u30df\u30ca\u30eb\u305d\u306e1\n$ curl localhost/cgi-bin/nc.sh\n<<< \u3053\u3053\u3067\u30d6\u30ed\u30c3\u30af\u3059\u308b >>>\n```\n\n\u3059\u308b\u3068 nc \u304c 9000/tcp \u3092\u958b\u3051\u3066\u5f85\u3063\u3066\u304f\u308c\u307e\u3059\uff0e\n\n```text:\u30bf\u30fc\u30df\u30ca\u30eb\u305d\u306e2\n# ss -atnp\nState      Recv-Q Send-Q     Local Address:Port      Peer Address:Port\nLISTEN     0      128                    *:111                  *:*          users:((\"systemd\",pid=1,fd=40))\nLISTEN     0      5          192.168.122.1:53                   *:*          users:((\"dnsmasq\",pid=1343,fd=6))\nLISTEN     0      128                    *:22                   *:*          users:((\"sshd\",pid=1166,fd=3))\nLISTEN     0      128            127.0.0.1:631                  *:*          users:((\"cupsd\",pid=1144,fd=12))\nLISTEN     0      100            127.0.0.1:25                   *:*          users:((\"master\",pid=1291,fd=13))\nLISTEN     0      10                     *:9000                 *:*          users:((\"nc\",pid=2082,fd=3))\nESTAB      0      0          192.168.0.111:22         192.168.0.2:55270      users:((\"sshd\",pid=1953,fd=3),(\"sshd\",pid=1949,fd=3))\nESTAB      0      52         192.168.0.111:22         192.168.0.2:54375      users:((\"sshd\",pid=1452,fd=3),(\"sshd\",pid=1447,fd=3))\nLISTEN     0      128                   :::111                 :::*          users:((\"systemd\",pid=1,fd=39))\nLISTEN     0      128                   :::80                  :::*          users:((\"httpd\",pid=1902,fd=4),(\"httpd\",pid=1901,fd=4),(\"httpd\",pid=1900,fd=4),(\"httpd\",pid=1873,fd=4),(\"httpd\",pid=1870,fd=4),(\"httpd\",pid=1869,fd=4),(\"httpd\",pid=1868,fd=4),(\"httpd\",pid=1867,fd=4),(\"httpd\",pid=1866,fd=4),(\"httpd\",pid=1865,fd=4))\nLISTEN     0      128                   :::22                  :::*          users:((\"sshd\",pid=1166,fd=4))\nLISTEN     0      128                  ::1:631                 :::*          users:((\"cupsd\",pid=1144,fd=11))\nLISTEN     0      100                  ::1:25                  :::*          users:((\"master\",pid=1291,fd=14))\nESTAB      0      0                    ::1:80                 ::1:34120      users:((\"httpd\",pid=1869,fd=9))\nESTAB      0      0                    ::1:34120              ::1:80         users:((\"curl\",pid=2079,fd=3))\n```\n\n\u305d\u3053\u3067\u5225\u306e\u30bf\u30fc\u30df\u30ca\u30eb\u304b\u3089\u3053\u3053\u306b\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u9001\u308a\u307e\u3059\uff0e\n\n```text:\u30bf\u30fc\u30df\u30ca\u30eb3\n$ nc localhost 9000\nhogehoge\nfoobar\nfoobarbaz\n<<<Ctrl-D>>>\n```\n\nnc \u3067\u30c6\u30ad\u30b9\u30c8\u3092\u9001\u308b\u3068\uff0c\u5148\u307b\u3069\u30d6\u30ed\u30c3\u30af\u3057\u3066\u3044\u305f\uff08curl \u3057\u305f\uff09\u30bf\u30fc\u30df\u30ca\u30eb\u306b\uff0c\u30bf\u30fc\u30df\u30ca\u30eb 3 \u3067\u9001\u4fe1\u3057\u305f\u30e1\u30c3\u30bb\u30fc\u30b8\u304c\u8868\u793a\u3055\u308c\u3066\u3044\u307e\u3059\uff0e\n\n```text:\u30bf\u30fc\u30df\u30ca\u30eb\u305d\u306e1\n$ curl localhost/cgi-bin/nc.sh\nhogehoge\nfoobar\nfoobarbaz\n```\n\n## \u306a\u306b\u304c\u8d77\u304d\u3066\u3044\u308b\u306e\u304b\nCGI \u3092\u5b9f\u884c\u3055\u308c\u305f\u3068\u304d\u306b nc \u304c 0.0.0.0:9000 \u3092\u958b\u3044\u3066\u5f85\u3061\u307e\u3059\uff0e\n\u305d\u3053\u306b\u4ed6\u306e\u30bf\u30fc\u30df\u30ca\u30eb\u304b\u3089\u9069\u5f53\u306a\u6587\u5b57\u5217\u3092\u9001\u308b\u3068\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u5074\u306b\u6587\u5b57\u5217\u3092\u9001\u4fe1\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\uff0e\n\n\u4eca\u56de\u306e\u4f8b\u3067\u306f\u305f\u3060\u6587\u5b57\u5217\u3092\u9001\u308b\u3060\u3051\u3067\u3057\u305f\u304c\uff0c\u672c\u8cea\u7684\u306a\u8ab2\u984c\u306f\n\n * \u4efb\u610f\u306e\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3067\u304d\u3066\u3057\u307e\u3046\n * \u5834\u5408\u306b\u3088\u3063\u3066\u306f\u4efb\u610f\u306e\u30dd\u30fc\u30c8\u3092\u958b\u304f\u3053\u3068\u304c\u3067\u304d\u3066\u3057\u307e\u3046\n\n\u3068\u3044\u3046\u3053\u3068\u3067\u3059\uff0e\n\n## \u3067\u306f SELinux \u3092 Enforce \u30e2\u30fc\u30c9\u306b\u3057\u3066\u307f\u307e\u3057\u3087\u3046\n\u307e\u305a\u306f CGI \u306b\u30a2\u30af\u30bb\u30b9\u3057\u307e\u3059\uff0e\n\u4eca\u56de\u306f\u30b3\u30f3\u30c6\u30f3\u30c4\u304c\u8fd4\u3063\u3066\u304d\u3082\u3057\u306a\u3044\uff0c\u30d6\u30ed\u30c3\u30af\u3082\u3057\u307e\u305b\u3093\uff0e\n\n```text:\u30bf\u30fc\u30df\u30ca\u30eb\u305d\u306e1\n$ curl localhost/cgi-bin/nc.sh\n$ \n```\n\nnc \u306f\uff1f \n\n```text:\u30bf\u30fc\u30df\u30ca\u30eb\u305d\u306e2\n# ss -atnp\nState      Recv-Q Send-Q    Local Address:Port       Peer Address:Port\nLISTEN     0      128                   *:111                   *:*          users:((\"systemd\",pid=1,fd=40))\nLISTEN     0      5         192.168.122.1:53                    *:*          users:((\"dnsmasq\",pid=1343,fd=6))\nLISTEN     0      128                   *:22                    *:*          users:((\"sshd\",pid=1166,fd=3))\nLISTEN     0      128           127.0.0.1:631                   *:*          users:((\"cupsd\",pid=1144,fd=12))\nLISTEN     0      100           127.0.0.1:25                    *:*          users:((\"master\",pid=1291,fd=13))\nESTAB      0      0         192.168.0.111:22          192.168.0.2:55270      users:((\"sshd\",pid=1953,fd=3),(\"sshd\",pid=1949,fd=3))\nESTAB      0      0         192.168.0.111:22          192.168.0.2:54375      users:((\"sshd\",pid=1452,fd=3),(\"sshd\",pid=1447,fd=3))\nLISTEN     0      128                  :::111                  :::*          users:((\"systemd\",pid=1,fd=39))\nLISTEN     0      128                  :::80                   :::*          users:((\"httpd\",pid=1902,fd=4),(\"httpd\",pid=1901,fd=4),(\"httpd\",pid=1900,fd=4),(\"httpd\",pid=1873,fd=4),(\"httpd\",pid=1870,fd=4),(\"httpd\",pid=1869,fd=4),(\"httpd\",pid=1868,fd=4),(\"httpd\",pid=1867,fd=4),(\"httpd\",pid=1866,fd=4),(\"httpd\",pid=1865,fd=4))\nLISTEN     0      128                  :::22                   :::*          users:((\"sshd\",pid=1166,fd=4))\nLISTEN     0      128                 ::1:631                  :::*          users:((\"cupsd\",pid=1144,fd=11))\nLISTEN     0      100                 ::1:25                   :::*          users:((\"master\",pid=1291,fd=14))\n\n# ss -atnp | grep nc\n```\n\n\u3044\u306a\u3044\u3093\u3067\u3059\uff0e\n\nApache \u306e\u30ed\u30b0\u3092\u898b\u3066\u307f\u307e\u3057\u3087\u3046\uff0e\n\n```text:/var/log/httpd/error_log\n[Sun Jan 08 11:30:30.374900 2017] [cgi:error] [pid 1867] [client ::1:34144] AH01215: Ncat: bind to 0.0.0.0:9000: Permission denied. QUITTING.\n```\nnc \u304c Permission denied \u98df\u3089\u3063\u3066\u3044\u307e\u3059\uff0e\n\u7d9a\u3044\u3066 audit \u30ed\u30b0\u3092\u898b\u3066\u307f\u307e\u3059\uff0e\n\n```text:\n# ausearch -m avc\n...\uff08\u7565\uff09... \ntime->Sun Jan  8 11:30:30 2017\ntype=SYSCALL msg=audit(1483842630.373:431): arch=c000003e syscall=49 success=no exit=-13 a0=3 a1=658c60 a2=80 a3=7ffddcbf3e10 items=0 ppid=1 pid=31418 auid=4294967295 uid=48 gid=48 euid=48 suid=48 fsuid=48 egid=48 sgid=48 fsgid=48 tty=(none) ses=4294967295 comm=\"nc\" exe=\"/usr/bin/ncat\" subj=system_u:system_r:httpd_sys_script_t:s0 key=(null)\ntype=AVC msg=audit(1483842630.373:431): avc:  denied  { name_bind } for  pid=31418 comm=\"nc\" src=9000 scontext=system_u:system_r:httpd_sys_script_t:s0 tcontext=system_u:object_r:http_port_t:s0 tclass=tcp_socket\n```\n\nsystem_u:system_r:httpd_sys_script_t:s0 \u306a\u3084\u3064\u304c nc \u3092\u5b9f\u884c\u3057\u3066 http_port_t \u306e 9000/tcp \u3092\u30d0\u30a4\u30f3\u30c9\u3057\u3088\u3046\u3068\u3057\u305f\u304b\u3089\u5374\u4e0b\u3057\u305f\u305c\uff0c\u3068 audit \u30ed\u30b0\u306b\u6b8b\u3063\u3066\u3044\u307e\u3059\uff0e\n\n# \u306a\u3093\u3067\uff1f\n\u307e\u305a\u5b9f\u884c\u3057\u305f CGI \u306e\u30b3\u30f3\u30c6\u30ad\u30b9\u30c8\u3092\u307f\u3066\u307f\u307e\u3059\uff0e\nCGI \u306e\u5b9f\u884c\u306b\u306f httpd_sys_script_exec_t \u304c\u5fc5\u8981\u3067\uff0c\u5148\u306e\u3068\u304a\u308a CGI \u81ea\u4f53\u306f\u6b63\u3057\u304f\u52d5\u3044\u3066\u3044\u308b\u306e\u3067\u30d5\u30a1\u30a4\u30eb\u30b3\u30f3\u30c6\u30ad\u30b9\u30c8\u3082\u6b63\u3057\u304f\u4ed8\u3044\u3066\u3044\u307e\u3059\uff0e\naudit \u30ed\u30b0\u306b\u3082\u3053\u306e\u30b3\u30f3\u30c6\u30ad\u30b9\u30c8\u306e\u9055\u53cd\u304c\u8a18\u9332\u3055\u308c\u3066\u3044\u308b\u306e\u3067\u9593\u9055\u3044\u306f\u3042\u308a\u307e\u305b\u3093\uff0e\n\n```\n# ls -Z /var/www/cgi-bin/\n-rwxr-xr-x. root root unconfined_u:object_r:httpd_sys_script_exec_t:s0 nc.sh\n```\n\n\u3064\u3065\u3044\u3066 SELinux \u306e\u8a2d\u5b9a\u3092\u898b\u3066\u307f\u307e\u3059\uff0e\n\u30dd\u30fc\u30c8\u3092\u30d0\u30a4\u30f3\u30c9\u3057\u3066\u958b\u304f\u305f\u3081\u306b\u306f\uff0cname_bind \u304c\u8a31\u53ef\u3055\u308c\u3066\u3044\u306a\u3051\u308c\u3070\u306a\u308a\u307e\u305b\u3093\uff0e\n\nhttpd_sys_script_exec_t \u304c http_port_t \u3092 name_bind \u3067\u304d\u308b\u304b\u3092\u8abf\u3079\u3066\u307f\u307e\u3059\uff0e\n\n```\n# sesearch --allow -s httpd_sys_script_t | grep http_port_t\n# \n```\n\n\u7d50\u679c\u306f\u8a72\u5f53\u306a\u3057\uff0e\n\u3067\u306f\u3069\u3093\u306a\u30dd\u30fc\u30c8\u3092 name_bind \u51fa\u6765\u308b\u306e\u304b\u3068\u3044\u3046\u3068\n\n```\n# sesearch --allow -s httpd_sys_script_t | grep name_bind\n   allow httpd_script_type ephemeral_port_t : udp_socket name_bind ;\n   allow nsswitch_domain port_t : udp_socket name_bind ;\n   allow httpd_script_type port_t : udp_socket name_bind ;\n   allow nsswitch_domain port_t : tcp_socket name_bind ;\n   allow nsswitch_domain ephemeral_port_t : udp_socket name_bind ;\n   allow httpd_script_type port_t : tcp_socket name_bind ;\n   allow nsswitch_domain unreserved_port_t : udp_socket name_bind ;\n   allow nsswitch_domain ephemeral_port_t : tcp_socket name_bind ;\n   allow httpd_script_type unreserved_port_t : udp_socket name_bind ;\n   allow httpd_script_type ephemeral_port_t : tcp_socket name_bind ;\n   allow nsswitch_domain unreserved_port_t : tcp_socket name_bind ;\n   allow httpd_script_type unreserved_port_t : tcp_socket name_bind ;\n```\n\n\u305f\u3068\u3048\u3070\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u3068\u3057\u3066\u30a8\u30d5\u30a7\u30e1\u30e9\u30eb\u30dd\u30fc\u30c8\uff0832768-61000\uff09\u3092\u958b\u3044\u305f\u308a\u3068\u3044\u3046\u611f\u3058\u3067\u3059\uff0e\n\u72ec\u81ea\u306b\u30b5\u30fc\u30d3\u30b9\u7528\u30dd\u30fc\u30c8\u3092\u958b\u304f\u3053\u3068\u306f\u3067\u304d\u307e\u305b\u3093\uff0e\n\n\u305d\u3093\u306a\u8a33\u3067\uff0c\u6b63\u3057\u304f SELinux \u304c\u8a2d\u5b9a\u3055\u308c\u3066\u3044\u308b\u72b6\u6cc1\u4e0b\u3067\u306f\uff0c\u4e0d\u6b63\u306b\u30dd\u30fc\u30c8\u3092\u958b\u3044\u305f\u308a\u3059\u308b\u3053\u3068\u306f\u51fa\u6765\u306a\u3044\u306e\u3067\u3059\uff0e\n\n\n\u3061\u306a\u307f\u306b Apache \u306f\u3069\u3046\u3084\u3063\u3066 WKP \u306e 80/tcp \u3092\u958b\u3044\u3066\u3044\u308b\u306e\u304b\u3068\u8a00\u3046\u3068\uff0e\uff0e\uff0e\n\n```\n# ps xafZ | grep httpd | grep -v grep\nsystem_u:system_r:httpd_t:s0      1865 ?        Ss     0:00 /usr/sbin/httpd -DFOREGROUND\nsystem_u:system_r:httpd_t:s0      1866 ?        S      0:00  \\_ /usr/sbin/httpd -DFOREGROUND\nsystem_u:system_r:httpd_t:s0      1867 ?        S      0:00  \\_ /usr/sbin/httpd -DFOREGROUND\nsystem_u:system_r:httpd_t:s0      1868 ?        S      0:00  \\_ /usr/sbin/httpd -DFOREGROUND\nsystem_u:system_r:httpd_t:s0      1869 ?        S      0:00  \\_ /usr/sbin/httpd -DFOREGROUND\nsystem_u:system_r:httpd_t:s0      1870 ?        S      0:00  \\_ /usr/sbin/httpd -DFOREGROUND\nsystem_u:system_r:httpd_t:s0      1873 ?        S      0:00  \\_ /usr/sbin/httpd -DFOREGROUND\nsystem_u:system_r:httpd_t:s0      1900 ?        S      0:00  \\_ /usr/sbin/httpd -DFOREGROUND\nsystem_u:system_r:httpd_t:s0      1901 ?        S      0:00  \\_ /usr/sbin/httpd -DFOREGROUND\nsystem_u:system_r:httpd_t:s0      1902 ?        S      0:00  \\_ /usr/sbin/httpd -DFOREGROUND\n\n# sesearch --allow -s httpd_t -t http_port_t\nFound 11 semantic av rules:\n   allow httpd_t port_type : tcp_socket { recv_msg send_msg } ;\n   allow httpd_t port_type : udp_socket { recv_msg send_msg } ;\n   allow httpd_t http_port_t : udp_socket name_bind ;\n   allow httpd_t http_port_t : tcp_socket name_bind ;\n   allow httpd_t port_type : tcp_socket name_connect ;\n   allow nsswitch_domain port_type : udp_socket recv_msg ;\n   allow nsswitch_domain port_type : udp_socket send_msg ;\n   allow nsswitch_domain port_type : tcp_socket { recv_msg send_msg } ;\n   allow httpd_t http_port_t : tcp_socket name_connect ;\n   allow httpd_t http_port_t : tcp_socket name_connect ;\n   allow nsswitch_domain reserved_port_type : tcp_socket name_connect ;\n```\n\n\u4e0a\u8a18\u306e\u3068\u304a\u308a\uff0chttpd_t \u306a\u30b3\u30f3\u30c6\u30ad\u30b9\u30c8\u304b\u3089 http_port_t \u3092\u958b\u3051\u3066\u3044\u308b\u3068\u3044\u3046\u8a33\u3067\u3059\uff0e\n\n# \u304a\u308f\u308a\u306b\n\u4eca\u56de\u306f\u30dd\u30ea\u30b7\u306b\u5b9a\u7fa9\u3055\u308c\u3066\u3044\u306a\u3044\u4e0d\u6b63\u306a\u6319\u52d5\u3092\u3059\u308b\u3082\u306e\u3092\u3042\u3048\u3066\u5b9f\u884c\u3057\uff0c\u7d50\u679c\u3092\u89b3\u5bdf\u3057\u3066\u3044\u304d\u307e\u3057\u305f\uff0e\n\u3082\u3061\u308d\u3093\u3053\u306e\u3088\u3046\u306a\u52d5\u4f5c\u304c\u5fc5\u8981\u306a\u5834\u5408\u306f\uff0c\u72ec\u81ea\u306b\u30dd\u30fc\u30c8\u3092\u5b9a\u7fa9\u3057 SELinux \u306b\u30dd\u30ea\u30b7\u3092\u5b9a\u7fa9\u3057\u3066\u3042\u3052\u308c\u3070\u6b63\u3057\u304f\u52d5\u304b\u3059\u3053\u3068\u304c\u53ef\u80fd\u3067\u3059\uff0e\n\n\u624b\u9806\u306f\u4eca\u5ea6\u66f8\u304d\u307e\u3057\u3087\u3046\u304b\uff0e\uff0e\uff0e\n\n", "tags": ["SELinux"]}