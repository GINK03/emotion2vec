{"context": "\u4f55\u5ea6\u3082\u624b\u3067digdag log\u3092\u6253\u3064\u306e\u306f\u9762\u5012\ndigdag log\u306f\u6642\u3005\u300cerror: Attempted read on closed stream. (io)\u300d\u30a8\u30e9\u30fc\u306b\u306a\u308b(0.9.4\u306b\u3066)\ndigdag UI\u306f\u30ed\u30b0\u306e\u53d6\u308a\u3053\u307c\u3057\u304c\u3042\u308b(0.9.4\u306b\u3066)\n\ndigdag_log.rb\nrequire 'open3'\n\nSTDOUT.sync = true\n\nattempt_id = ARGV[0]\n\nlog_line_no_max = 0\nattempt_stdout = nil\n\nloop do\n  # digdag attempt\u5b9f\u884c (\u30a8\u30e9\u30fc\u306a\u3089\u5373\u7d42\u4e86)\n  status = nil\n  attempt_stdout = []\n  Open3.popen3(\"digdag attempt \" + attempt_id) do |stdin, stdout, stderr, wait_thr|\n    stdout.each do |line|\n      tmp = line.match(/  status: (.+)/)\n      status = tmp[1] unless tmp.nil?\n      attempt_stdout << line\n    end\n    unless wait_thr.value.success?\n      stdout.each do |line|        puts line end\n      stderr.each do |line| STDERR.puts line end\n      abort\n    end\n  end\n\n  # digdag log\u5b9f\u884c (\u6b63\u5e38\u7d42\u4e86\u3059\u308b\u307e\u3067\u7e70\u308a\u8fd4\u3059)\n  loop do\n    log_line_no = 0\n    log_success = false\n    Open3.popen3(\"digdag log \" + attempt_id) do |stdin, stdout, stderr, wait_thr|\n      stdout.each do |line|\n        log_line_no += 1\n        # \u524d\u56de\u51fa\u529b\u884c\u4ee5\u964d\u3092\u51fa\u529b\n        if (log_line_no > log_line_no_max)\n          puts line\n          log_line_no_max = log_line_no\n        end\n      end\n      log_success = wait_thr.value.success?\n    end\n    if log_success\n      break\n    end\n  end\n\n  # attempt\u304c\u7d42\u4e86\u3057\u3066\u3044\u308b\u304b\n  if status == \"error\" || status == \"success\"\n    break\n  end\n\n  # \u6b21\u306e\u5b9f\u884c\u307e\u3067\u30b9\u30ea\u30fc\u30d7\n  sleep 10\nend\n\nputs\nputs \"this attempt ended with following status\"\nputs\nputs attempt_stdout\n\n\nruby digdag_log.rb 6\n\n\u4f55\u5ea6\u3082\u624b\u3067digdag log\u3092\u6253\u3064\u306e\u306f\u9762\u5012\ndigdag log\u306f\u6642\u3005\u300cerror: Attempted read on closed stream. (io)\u300d\u30a8\u30e9\u30fc\u306b\u306a\u308b(0.9.4\u306b\u3066)\ndigdag UI\u306f\u30ed\u30b0\u306e\u53d6\u308a\u3053\u307c\u3057\u304c\u3042\u308b(0.9.4\u306b\u3066)\n\n```digdag_log.rb\nrequire 'open3'\n\nSTDOUT.sync = true\n\nattempt_id = ARGV[0]\n\nlog_line_no_max = 0\nattempt_stdout = nil\n\nloop do\n  # digdag attempt\u5b9f\u884c (\u30a8\u30e9\u30fc\u306a\u3089\u5373\u7d42\u4e86)\n  status = nil\n  attempt_stdout = []\n  Open3.popen3(\"digdag attempt \" + attempt_id) do |stdin, stdout, stderr, wait_thr|\n    stdout.each do |line|\n      tmp = line.match(/  status: (.+)/)\n      status = tmp[1] unless tmp.nil?\n      attempt_stdout << line\n    end\n    unless wait_thr.value.success?\n      stdout.each do |line|        puts line end\n      stderr.each do |line| STDERR.puts line end\n      abort\n    end\n  end\n\n  # digdag log\u5b9f\u884c (\u6b63\u5e38\u7d42\u4e86\u3059\u308b\u307e\u3067\u7e70\u308a\u8fd4\u3059)\n  loop do\n    log_line_no = 0\n    log_success = false\n    Open3.popen3(\"digdag log \" + attempt_id) do |stdin, stdout, stderr, wait_thr|\n      stdout.each do |line|\n        log_line_no += 1\n        # \u524d\u56de\u51fa\u529b\u884c\u4ee5\u964d\u3092\u51fa\u529b\n        if (log_line_no > log_line_no_max)\n          puts line\n          log_line_no_max = log_line_no\n        end\n      end\n      log_success = wait_thr.value.success?\n    end\n    if log_success\n      break\n    end\n  end\n\n  # attempt\u304c\u7d42\u4e86\u3057\u3066\u3044\u308b\u304b\n  if status == \"error\" || status == \"success\"\n    break\n  end\n\n  # \u6b21\u306e\u5b9f\u884c\u307e\u3067\u30b9\u30ea\u30fc\u30d7\n  sleep 10\nend\n\nputs\nputs \"this attempt ended with following status\"\nputs\nputs attempt_stdout\n```\n```shell-session\nruby digdag_log.rb 6\n```\n", "tags": ["digdag"]}