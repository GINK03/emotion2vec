{"context": "\n\n\u524d\u63d0\u6761\u4ef6\n\nLambda\u3078\u306e\u6a29\u9650\nLambda\u306b\u5bfe\u3057\u3066\u30d5\u30eb\u6a29\u9650\u304c\u3042\u308b\u3053\u3068\u3002\n\nAWS CLI\n\u4ee5\u4e0b\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u3067\u52d5\u4f5c\u78ba\u8a8d\u6e08\n\nAWS CLI 1.11.8\n\n\n\u30b3\u30de\u30f3\u30c9\naws --version\n\n\n\n\u7d50\u679c(\u4f8b)\n      aws-cli/1.11.7 Python/2.7.11 Darwin/15.6.0 botocore/1.4.64\n\n\n\u30d0\u30fc\u30b8\u30e7\u30f3\u304c\u53e4\u3044\u5834\u5408\u306f\u6700\u65b0\u7248\u306b\u66f4\u65b0\u3057\u307e\u3057\u3087\u3046\u3002\n\n\u30b3\u30de\u30f3\u30c9\nsudo -H pip install -U awscli\n\n\n\nIAM Role\n'lambdaVpnConnMonitorExecution'\u30ed\u30fc\u30eb\u304c\u5b58\u5728\u3059\u308b\u3053\u3068\u3002\n\n\u5909\u6570\u306e\u8a2d\u5b9a\nIAM_ROLE_NAME='lambdaVpnConnMonitorExecution'\n\n\n\n\u30b3\u30de\u30f3\u30c9\naws iam get-role \\\n         --role-name ${IAM_ROLE_NAME}\n\n\n\n\u7d50\u679c(\u4f8b)\n      {\n          \"Role\": {\n            \"AssumeRolePolicyDocument\": {\n                \"Version\": \"2012-10-17\",\n                \"Statement\": [\n                    {\n                        \"Action\": \"sts:AssumeRole\",\n                        \"Principal\": {\n                            \"Service\": \"lambda.amazonaws.com\"\n                        },\n                        \"Effect\": \"Allow\",\n                        \"Sid\": \"\"\n                    }\n                ]\n            },\n            \"RoleId\": \"AROAXXXXXXXXXXXXXXXXX\",\n            \"CreateDate\": \"2016-10-22T01:23:45Z\",\n            \"RoleName\": \"lambdaVpnConnMonitorExecution\",\n            \"Path\": \"/\",\n            \"Arn\": \"arn:aws:iam::XXXXXXXXXXXX:role/lambdaVpnConnMonitorExecution\"\n          }\n      }\n\n\n\n0. \u6e96\u5099\n\n0.1. \u30ea\u30fc\u30b8\u30e7\u30f3\u306e\u6c7a\u5b9a\n\n\u5909\u6570\u306e\u8a2d\u5b9a\nexport AWS_DEFAULT_REGION='ap-northeast-1'\n\n\n\n0.2. \u5909\u6570\u306e\u78ba\u8a8d\n\u30d7\u30ed\u30d5\u30a1\u30a4\u30eb\u304c\u60f3\u5b9a\u306e\u3082\u306e\u306b\u306a\u3063\u3066\u3044\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n\u5909\u6570\u306e\u78ba\u8a8d\naws configure list\n\n\n\n\u7d50\u679c(\u4f8b)\n            Name                    Value             Type    Location\n            ----                    -----             ----    --------\n         profile       lambdaFull-prjz-mbp13        env    AWS_DEFAULT_PROFILE\n      access_key     ****************XXXX shared-credentials-file\n      secret_key     ****************XXXX shared-credentials-file\n          region        ap-northeast-1        env    AWS_DEFAULT_REGION\n\n\n\n0.3. IAM Role\u306eARN\u53d6\u5f97\n\n\u5909\u6570\u306e\u8a2d\u5b9a\nIAM_ROLE_NAME='lambdaVpnConnMonitorExecution'\n\n\n\n\u30b3\u30de\u30f3\u30c9\nIAM_ROLE_ARN=$( \\\n        aws iam get-role \\\n          --role-name ${IAM_ROLE_NAME} \\\n          --query 'Role.Arn' \\\n          --output text \\\n) \\\n        && echo ${IAM_ROLE_ARN}\n\n\n\n\u7d50\u679c(\u4f8b)\n      arn:aws:iam::XXXXXXXXXXXX:role/lambdaVpnConnMonitorExecution\n\n\n\n1. \u4e8b\u524d\u4f5c\u696d\n\n1.1. Lambda\u95a2\u6570\u540d\u306e\u6c7a\u5b9a\n\n\u5909\u6570\u306e\u8a2d\u5b9a\nLAMBDA_FUNC_NAME=\"vpn-conn-monitor-$( date '+%Y%m%d' )\" \\\n   &&     echo ${LAMBDA_FUNC_NAME}\n\n\n\u540c\u540d\u306eLambda\u95a2\u6570\u306e\u4e0d\u5b58\u5728\u78ba\u8a8d\n\n\u30b3\u30de\u30f3\u30c9\naws lambda get-function \\\n        --function-name ${LAMBDA_FUNC_NAME}\n\n\n\n\u7d50\u679c(\u4f8b)\n      A client error (ResourceNotFoundException) occurred when calling the GetFunction operation: Function not found: arn:aws:lambda:ap-northeast-1:XXXXXXXXXXXX:function:vpn-conn-monitor-20161024\n\n\n\n1.2. Lambda\u95a2\u6570\n\n\u5909\u6570\u306e\u8a2d\u5b9a\nFILE_LAMBDA_FUNC=\"${LAMBDA_FUNC_NAME}.py\"\nPY_FUNC_NAME='lambda_handler'\n\n\n\n\u5909\u6570\u306e\u78ba\u8a8d\ncat << ETX\n\n          FILE_LAMBDA_FUNC: ${FILE_LAMBDA_FUNC}\n          PY_FUNC_NAME:     ${PY_FUNC_NAME}\n\nETX\n\n\n\n\u30b3\u30de\u30f3\u30c9\ncat << EOF > ${FILE_LAMBDA_FUNC}\nfrom __future__ import print_function\n\nimport boto3\n\nprint('Loading function')\ncw = boto3.client('cloudwatch')\n\n\ndef put_cloudwatch_metric(metric_name, value, vgw, cgw, region):\n    cw.put_metric_data(\n        Namespace='VPNStatus',\n        MetricData=[{\n            'MetricName': metric_name,\n            'Value': value,\n            'Unit': 'Count',\n            'Dimensions': [\n                {\n                    'Name': 'VGW',\n                    'Value': vgw\n                },\n                {\n                    'Name': 'CGW',\n                    'Value': cgw\n                },\n                {\n                    'Name': 'Region',\n                    'Value': region\n                }\n            ]\n        }]\n    )\n\n\ndef lambda_handler(event, context):\n    ec2 = boto3.client('ec2')\n    aws_regions = ec2.describe_regions()['Regions']\n    num_connections = 0\n    for region in aws_regions:\n        try:\n            ec2 = boto3.client('ec2', region_name=region['RegionName'])\n            vpns = ec2.describe_vpn_connections()['VpnConnections']\n            for vpn in vpns:\n                if vpn['State'] == 'available':\n                    num_connections += 1\n                    active_tunnels = 0\n                    if vpn['VgwTelemetry'][0]['Status'] == 'UP':\n                        active_tunnels += 1\n                    if vpn['VgwTelemetry'][1]['Status'] == 'UP':\n                        active_tunnels += 1\n                    put_cloudwatch_metric(vpn['VpnConnectionId'],\n                                        active_tunnels,\n                                        vpn['VpnGatewayId'],\n                                        vpn['CustomerGatewayId'],\n                                        region['RegionName'])\n        except Exception as e:\n            print(\"Exception: \" + str(e))\n            continue\n    return num_connections\nEOF\n\ncat ${FILE_LAMBDA_FUNC}\n\n\n\n\u30b3\u30de\u30f3\u30c9\nzip ${LAMBDA_FUNC_NAME}.zip ${FILE_LAMBDA_FUNC}\n\n\n\n\u7d50\u679c(\u4f8b)\n      adding: vpn-conn-monitor-20161024.py (deflated 43%)\n\n\n\n2. Lambda\u95a2\u6570\u306e\u4f5c\u6210\n\n2.1. Lambda\u95a2\u6570\u306e\u4f5c\u6210\n\n\u5909\u6570\u306e\u8a2d\u5b9a\nLAMBDA_FUNC_DESC='Monitors VPN connection status of an account in all regions.'\nLAMBDA_RUNTIME='python2.7'\nLAMBDA_HANDLER=\"${LAMBDA_FUNC_NAME}.${PY_FUNC_NAME}\"\nFILE_LAMBDA_ZIP=\"${LAMBDA_FUNC_NAME}.zip\"\n\n\n\n\u5909\u6570\u306e\u78ba\u8a8d\ncat << ETX\n\n        LAMBDA_FUNC_NAME:  ${LAMBDA_FUNC_NAME}\n        LAMBDA_FUNC_DESC: \"${LAMBDA_FUNC_DESC}\"\n        LAMBDA_RUNTIME:    ${LAMBDA_RUNTIME}\n        FILE_LAMBDA_ZIP    ${FILE_LAMBDA_ZIP}\n        IAM_ROLE_ARN:      ${IAM_ROLE_ARN}\n        LAMBDA_HANDLER:    ${LAMBDA_HANDLER}\n\nETX\n\n\n\n\u30b3\u30de\u30f3\u30c9\naws lambda create-function \\\n        --function-name ${LAMBDA_FUNC_NAME} \\\n        --description \"${LAMBDA_FUNC_DESC}\" \\\n        --zip-file fileb://${FILE_LAMBDA_ZIP} \\\n        --runtime ${LAMBDA_RUNTIME} \\\n        --role ${IAM_ROLE_ARN} \\\n        --handler ${LAMBDA_HANDLER}\n\n\n\n\u7d50\u679c(\u4f8b)\n      {\n        \"CodeSha256\": \"c++vSFRfioI+KDLOGt3N97oJ+xroodc2SDy5wXWYlF8=\",\n        \"FunctionName\": \"vpn-conn-monitor-20161024\",\n        \"CodeSize\": 781,\n        \"MemorySize\": 128,\n        \"FunctionArn\": \"arn:aws:lambda:ap-northeast-1:XXXXXXXXXXXX:function:vpn-conn-monitor-20161024\",\n        \"Version\": \"$LATEST\",\n        \"Role\": \"arn:aws:iam::XXXXXXXXXXXX:role/lambdaVpnConnMonitorExecution\",\n        \"Timeout\": 3,\n        \"LastModified\": \"2016-10-22T01:23:45.678+0000\",\n        \"Handler\": \"vpn-conn-monitor-20161024.lambda_handler\",\n        \"Runtime\": \"python2.7\",\n        \"Description\": \"Monitors VPN connection status of an account in all regions.\"\n      }\n\n\n\n\u30b3\u30de\u30f3\u30c9\naws lambda get-function \\\n        --function-name ${LAMBDA_FUNC_NAME}\n\n\n\n\u7d50\u679c(\u4f8b)\n      {\n        \"Code\": {\n          \"RepositoryType\": \"S3\",\n          \"Location\": \"https://awslambda-ap-ne-1-tasks.s3-ap-northeast-1.amazonaws.com/snapshots/XXXXXXXXXXXX/HelloWorld-2979ba79-b08f-495d-9ee6-46397c95ba13?x-amz-security-token=AQoDYXdzEDoa8AMR6t8h66eOXhN3%2Fx7XpuRxvf7pVn7IuWV4cEmwx0CtZT6yxCJ1%2BWmigYXqGoyQHuBYOWnxbhmwEcTg839qMuhSu1fk0fXpXf0oJOLkhKMudNqhdElyFQpzyT6Q8GDfhAsfbX9wvwCDTty4imxz7MczF%2FQl6tgvTYdip08ap5fAyrknZGV1%2B1Ggnp5w6JOjydYxuUsWwhoxoEWzi7SoVTmpRQQA91c4VW9lNotOAHACFxo6klzDPM8mxR9RJl66WxFugL0wQJyLUpmtjS9XoArD86sEWWiIccMpV2BQipTPQlzL%2F1Hoy%2BDF6QUxyPUihlDjPBoJTISTP8W1wxmzW%2BLbilAfFQRPY7CFjzR0k%2FA%2FIX5x9iyz52Pu1Q0ASTw1l%2Fq%2Fo3pRbvzWR79QS%2BpxXrwbYzoQHKiK62DSTsQo5tqKPsiDCYzrPxbq8lm7pNBPG%2FsxjePRWBVJeRl08WxEjSjoRRwBOPX5mz1BCUoUBPGG5tEENp87A%2FCdDgibFWM5DdYhwtaYPY7FTmi8DvqjQHL9jOmP8YuVteBTBcv8nFW6UbErPjwwn79FKG1u5M9HoTWUqUMBByz6D4tTRSEw6iJU7XdCujFnhnHe5V8imZ1KGI7fDWpciJhrhml0wnKPCK%2Fe9lK1P2kO7ldSWc7zn5hcIOD2tbEF&AWSAccessKeyId=ASIAJFVALOKV5SJVYPPA&Expires=1445825978&Signature=bvwu1Ny34LgTmZeOO3q4sn7x3Fg%3D\"\n        },\n        \"Configuration\": {\n          \"Version\": \"$LATEST\",\n          \"CodeSha256\": \"c++vSFRfioI+KDLOGt3N97oJ+xroodc2SDy5wXWYlF8=\",\n          \"FunctionName\": \"vpn-conn-monitor-20161024\",\n          \"MemorySize\": 128,\n          \"CodeSize\": 350,\n          \"FunctionArn\": \"arn:aws:lambda:ap-northeast-1:XXXXXXXXXXXX:function:vpn-conn-monitor-20161024\",\n          \"Handler\": \"vpn-conn-monitor-20161024.lambda_handler\",\n          \"Role\": \"arn:aws:iam::XXXXXXXXXXXX:role/lambdaVpnConnMonitorExecution\",\n          \"Timeout\": 3,\n          \"LastModified\": \"2016-10-22T01:23:45.678+0000\",\n          \"Runtime\": \"python2.7\",\n          \"Description\": \"Monitors VPN connection status of an account in all regions.\"\n        }\n      }\n\n\n\n\u30b3\u30de\u30f3\u30c9\naws lambda get-function-configuration \\\n        --function-name ${LAMBDA_FUNC_NAME}\n\n\n\n\u7d50\u679c(\u4f8b)\n      {\n        \"CodeSha256\": \"c++vSFRfioI+KDLOGt3N97oJ+xroodc2SDy5wXWYlF8=\",\n        \"FunctionName\": \"vpn-conn-monitor-20161024\",\n        \"CodeSize\": 781,\n        \"MemorySize\": 128,\n        \"FunctionArn\": \"arn:aws:lambda:ap-northeast-1:XXXXXXXXXXXX:function:vpn-conn-monitor-20161024\",\n        \"Version\": \"$LATEST\",\n        \"Role\": \"arn:aws:iam::XXXXXXXXXXXX:role/lambdaVpnConnMonitorExecution\",\n        \"Timeout\": 3,\n        \"LastModified\": \"2016-10-22T01:23:45.678+0000\",\n        \"Handler\": \"vpn-conn-monitor-20161024.handler\",\n        \"Runtime\": \"python2.7\",\n        \"Description\": \"Monitors VPN connection status of an account in all regions.\"\n      }\n\n\n\n2.2. Lambda\u95a2\u6570\u306e\u66f4\u65b0\n\u30c7\u30d5\u30a9\u30eb\u30c8\u306e3\u79d2\u3067\u306f\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u3059\u308b\u53ef\u80fd\u6027\u304c\u9ad8\u3044\u306e\u3067\u3001\u3053\u3053\u3067\u306f30\u79d2\u306b\u5909\u66f4\u3057\u307e\u3059\u3002\n\n\u5909\u6570\u306e\u8a2d\u5b9a\nLAMBDA_TIMEOUT='30'\n\n\n\n\u5909\u6570\u306e\u78ba\u8a8d\ncat << ETX\n\n        LAMBDA_FUNC_NAME: ${LAMBDA_FUNC_NAME}\n        LAMBDA_TIMEOUT:   ${LAMBDA_TIMEOUT}\n\nETX\n\n\n\n\u30b3\u30de\u30f3\u30c9\naws lambda update-function-configuration \\\n        --function-name ${LAMBDA_FUNC_NAME} \\\n        --timeout \"${LAMBDA_TIMEOUT}\"\n\n\n\n\u7d50\u679c(\u4f8b)\n      {\n        \"CodeSha256\": \"c++vSFRfioI+KDLOGt3N97oJ+xroodc2SDy5wXWYlF8=\",\n        \"FunctionName\": \"vpn-conn-monitor-20161024\",\n        \"VpcConfig\": {\n            \"SubnetIds\": [],\n            \"SecurityGroupIds\": []\n        },\n        \"CodeSize\": 781,\n        \"MemorySize\": 128,\n        \"FunctionArn\": \"arn:aws:lambda:ap-northeast-1:XXXXXXXXXXXX:function:vpn-conn-monitor-20161024\",\n        \"Version\": \"$LATEST\",\n        \"Role\": \"arn:aws:iam::XXXXXXXXXXXX:role/lambdaVpnConnMonitorExecution\",\n        \"Timeout\": 30,\n        \"LastModified\": \"2016-10-22T01:23:45.678+0000\",\n        \"Handler\": \"vpn-conn-monitor-20161024.handler\",\n        \"Runtime\": \"python2.7\",\n        \"Description\": \"Monitors VPN connection status of an account in all regions.\"\n      }\n\n\n\n3. Lambda\u95a2\u6570\u306e\u52d5\u4f5c\u78ba\u8a8d\n\n3.1. \u30b5\u30f3\u30d7\u30eb\u30c7\u30fc\u30bf\u306e\u4f5c\u6210\n\n\u5909\u6570\u306e\u8a2d\u5b9a\nFILE_INPUT=\"${LAMBDA_FUNC_NAME}-data.json\" \\\n          && echo ${FILE_INPUT}\n\n\n\n\u30b5\u30f3\u30d7\u30eb\u30c7\u30fc\u30bf\n\ncat << EOF > ${FILE_INPUT}\n{\n        \"account\": \"123456789012\",\n        \"region\": \"${AWS_DEFAULT_REGION}\",\n        \"detail\": {},\n        \"detail-type\": \"Scheduled Event\",\n        \"source\": \"aws.events\",\n        \"time\": \"1970-01-01T00:00:00Z\",\n        \"id\": \"cdc73f9d-aea9-11e3-9d5a-835b769c0d9c\",\n        \"resources\": [\n          \"arn:aws:events:${AWS_DEFAULT_REGION}:123456789012:rule/my-schedule\"\n        ]\n}\nEOF\n\ncat ${FILE_INPUT}\n\n\nJSON\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3057\u305f\u3089\u3001\u30d5\u30a9\u30fc\u30de\u30c3\u30c8\u304c\u58ca\u308c\u3066\u306a\u3044\u304b\u5fc5\u305a\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n\u30b3\u30de\u30f3\u30c9\njsonlint -q ${FILE_INPUT}\n\n\n\u30a8\u30e9\u30fc\u304c\u51fa\u529b\u3055\u308c\u306a\u3051\u308c\u3070OK\u3067\u3059\u3002\n\n3.2. lambda\u95a2\u6570\u306e\u624b\u52d5\u5b9f\u884c\n\n\u5909\u6570\u306e\u8a2d\u5b9a\nFILE_OUTPUT_LAMBDA=\"${LAMBDA_FUNC_NAME}-out.txt\"\nFILE_LOG_LAMBDA=\"${LAMBDA_FUNC_NAME}-$(date +%Y%m%d%H%M%S).log\"\n\n\n\n\u5909\u6570\u306e\u78ba\u8a8d\ncat << ETX\n\n        LAMBDA_FUNC_NAME:   ${LAMBDA_FUNC_NAME}\n        FILE_INPUT:         ${FILE_INPUT}\n        FILE_OUTPUT_LAMBDA: ${FILE_OUTPUT_LAMBDA}\n        FILE_LOG_LAMBDA:    ${FILE_LOG_LAMBDA}\n\nETX\n\n\n\n\u30b3\u30de\u30f3\u30c9\naws lambda invoke \\\n        --function-name ${LAMBDA_FUNC_NAME} \\\n        --log-type Tail \\\n        --payload file://${FILE_INPUT} \\\n        ${FILE_OUTPUT_LAMBDA} \\\n        > ${FILE_LOG_LAMBDA}\n\n\n\n\u30b3\u30de\u30f3\u30c9\ncat ${FILE_LOG_LAMBDA} \\\n        | jp.py 'StatusCode'\n\n\n\n\u7d50\u679c(\u4f8b)\n      200\n\n\n\n3.3. lambda\u95a2\u6570\u306e\u5b9f\u884c\u7d50\u679c\u306e\u78ba\u8a8d\n\n\u30b3\u30de\u30f3\u30c9\ncat ${FILE_OUTPUT_LAMBDA}\n\n\n\n\u7d50\u679c(\u4f8b)\n      1\n\n\n\n3.4. lambda\u95a2\u6570\u306e\u30ed\u30b0\u306e\u78ba\u8a8d\n\n\u30b3\u30de\u30f3\u30c9\ncat ${FILE_LOG_LAMBDA} \\\n        | jp.py 'LogResult' \\\n        | sed 's/\"//' \\\n        | base64 --decode\n\n\n\n\u7d50\u679c(\u4f8b)\n      START RequestId: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx Version: $LATEST\n      END RequestId: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx\n      REPORT RequestId: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx      Duration: 12870.41 ms   Billed Duration: 12900 ms       Memory Size: 128 MB     Max Memory Used: 33 MB\n\n\n\n\u5b8c\u4e86\n\u524d\u63d0\u6761\u4ef6\n========\n\n\nLambda\u3078\u306e\u6a29\u9650\n--------------\n\nLambda\u306b\u5bfe\u3057\u3066\u30d5\u30eb\u6a29\u9650\u304c\u3042\u308b\u3053\u3068\u3002\n\n\nAWS CLI\n-------\n\n\u4ee5\u4e0b\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u3067\u52d5\u4f5c\u78ba\u8a8d\u6e08\n\n- AWS CLI 1.11.8\n\n```bash:\u30b3\u30de\u30f3\u30c9:\naws --version\n```\n\n```text:\u7d50\u679c(\u4f8b):\n      aws-cli/1.11.7 Python/2.7.11 Darwin/15.6.0 botocore/1.4.64\n```\n\n\u30d0\u30fc\u30b8\u30e7\u30f3\u304c\u53e4\u3044\u5834\u5408\u306f\u6700\u65b0\u7248\u306b\u66f4\u65b0\u3057\u307e\u3057\u3087\u3046\u3002\n\n```bash:\u30b3\u30de\u30f3\u30c9:\nsudo -H pip install -U awscli\n```\n\n\nIAM Role\n--------\n\n'lambdaVpnConnMonitorExecution'\u30ed\u30fc\u30eb\u304c\u5b58\u5728\u3059\u308b\u3053\u3068\u3002\n\n```bash:\u5909\u6570\u306e\u8a2d\u5b9a:\nIAM_ROLE_NAME='lambdaVpnConnMonitorExecution'\n```\n\n```bash:\u30b3\u30de\u30f3\u30c9:\naws iam get-role \\\n         --role-name ${IAM_ROLE_NAME}\n```\n\n```json:\u7d50\u679c(\u4f8b):\n      {\n          \"Role\": {\n            \"AssumeRolePolicyDocument\": {\n                \"Version\": \"2012-10-17\",\n                \"Statement\": [\n                    {\n                        \"Action\": \"sts:AssumeRole\",\n                        \"Principal\": {\n                            \"Service\": \"lambda.amazonaws.com\"\n                        },\n                        \"Effect\": \"Allow\",\n                        \"Sid\": \"\"\n                    }\n                ]\n            },\n            \"RoleId\": \"AROAXXXXXXXXXXXXXXXXX\",\n            \"CreateDate\": \"2016-10-22T01:23:45Z\",\n            \"RoleName\": \"lambdaVpnConnMonitorExecution\",\n            \"Path\": \"/\",\n            \"Arn\": \"arn:aws:iam::XXXXXXXXXXXX:role/lambdaVpnConnMonitorExecution\"\n          }\n      }\n```\n\n\n0. \u6e96\u5099\n=======\n\n\n0.1. \u30ea\u30fc\u30b8\u30e7\u30f3\u306e\u6c7a\u5b9a\n---------------------\n\n```bash:\u5909\u6570\u306e\u8a2d\u5b9a\nexport AWS_DEFAULT_REGION='ap-northeast-1'\n```\n\n\n0.2. \u5909\u6570\u306e\u78ba\u8a8d\n---------------\n\n\u30d7\u30ed\u30d5\u30a1\u30a4\u30eb\u304c\u60f3\u5b9a\u306e\u3082\u306e\u306b\u306a\u3063\u3066\u3044\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n```bash:\u5909\u6570\u306e\u78ba\u8a8d:\naws configure list\n```\n\n```text:\u7d50\u679c(\u4f8b):\n            Name                    Value             Type    Location\n            ----                    -----             ----    --------\n         profile       lambdaFull-prjz-mbp13        env    AWS_DEFAULT_PROFILE\n      access_key     ****************XXXX shared-credentials-file\n      secret_key     ****************XXXX shared-credentials-file\n          region        ap-northeast-1        env    AWS_DEFAULT_REGION\n```\n\n\n0.3. IAM Role\u306eARN\u53d6\u5f97\n----------------------\n\n```bash:\u5909\u6570\u306e\u8a2d\u5b9a:\nIAM_ROLE_NAME='lambdaVpnConnMonitorExecution'\n```\n\n```bash:\u30b3\u30de\u30f3\u30c9:\nIAM_ROLE_ARN=$( \\\n        aws iam get-role \\\n          --role-name ${IAM_ROLE_NAME} \\\n          --query 'Role.Arn' \\\n          --output text \\\n) \\\n        && echo ${IAM_ROLE_ARN}\n```\n\n```text:\u7d50\u679c(\u4f8b):\n      arn:aws:iam::XXXXXXXXXXXX:role/lambdaVpnConnMonitorExecution\n```\n\n\n1. \u4e8b\u524d\u4f5c\u696d\n===========\n\n\n1.1. Lambda\u95a2\u6570\u540d\u306e\u6c7a\u5b9a\n-----------------------\n\n```bash:\u5909\u6570\u306e\u8a2d\u5b9a:\nLAMBDA_FUNC_NAME=\"vpn-conn-monitor-$( date '+%Y%m%d' )\" \\\n   &&     echo ${LAMBDA_FUNC_NAME}\n```\n\n\u540c\u540d\u306eLambda\u95a2\u6570\u306e\u4e0d\u5b58\u5728\u78ba\u8a8d\n\n```bash:\u30b3\u30de\u30f3\u30c9:\naws lambda get-function \\\n        --function-name ${LAMBDA_FUNC_NAME}\n```\n\n```text:\u7d50\u679c(\u4f8b):\n      A client error (ResourceNotFoundException) occurred when calling the GetFunction operation: Function not found: arn:aws:lambda:ap-northeast-1:XXXXXXXXXXXX:function:vpn-conn-monitor-20161024\n```\n\n\n1.2. Lambda\u95a2\u6570\n---------------\n\n```bash:\u5909\u6570\u306e\u8a2d\u5b9a:\nFILE_LAMBDA_FUNC=\"${LAMBDA_FUNC_NAME}.py\"\nPY_FUNC_NAME='lambda_handler'\n```\n\n```bash:\u5909\u6570\u306e\u78ba\u8a8d:\ncat << ETX\n\n          FILE_LAMBDA_FUNC: ${FILE_LAMBDA_FUNC}\n          PY_FUNC_NAME:     ${PY_FUNC_NAME}\n\nETX\n```\n\n```bash:\u30b3\u30de\u30f3\u30c9:\ncat << EOF > ${FILE_LAMBDA_FUNC}\nfrom __future__ import print_function\n\nimport boto3\n\nprint('Loading function')\ncw = boto3.client('cloudwatch')\n\n\ndef put_cloudwatch_metric(metric_name, value, vgw, cgw, region):\n    cw.put_metric_data(\n        Namespace='VPNStatus',\n        MetricData=[{\n            'MetricName': metric_name,\n            'Value': value,\n            'Unit': 'Count',\n            'Dimensions': [\n                {\n                    'Name': 'VGW',\n                    'Value': vgw\n                },\n                {\n                    'Name': 'CGW',\n                    'Value': cgw\n                },\n                {\n                    'Name': 'Region',\n                    'Value': region\n                }\n            ]\n        }]\n    )\n\n\ndef lambda_handler(event, context):\n    ec2 = boto3.client('ec2')\n    aws_regions = ec2.describe_regions()['Regions']\n    num_connections = 0\n    for region in aws_regions:\n        try:\n            ec2 = boto3.client('ec2', region_name=region['RegionName'])\n            vpns = ec2.describe_vpn_connections()['VpnConnections']\n            for vpn in vpns:\n                if vpn['State'] == 'available':\n                    num_connections += 1\n                    active_tunnels = 0\n                    if vpn['VgwTelemetry'][0]['Status'] == 'UP':\n                        active_tunnels += 1\n                    if vpn['VgwTelemetry'][1]['Status'] == 'UP':\n                        active_tunnels += 1\n                    put_cloudwatch_metric(vpn['VpnConnectionId'],\n                                        active_tunnels,\n                                        vpn['VpnGatewayId'],\n                                        vpn['CustomerGatewayId'],\n                                        region['RegionName'])\n        except Exception as e:\n            print(\"Exception: \" + str(e))\n            continue\n    return num_connections\nEOF\n\ncat ${FILE_LAMBDA_FUNC}\n```\n\n```bash:\u30b3\u30de\u30f3\u30c9:\nzip ${LAMBDA_FUNC_NAME}.zip ${FILE_LAMBDA_FUNC}\n```\n\n```text:\u7d50\u679c(\u4f8b):\n      adding: vpn-conn-monitor-20161024.py (deflated 43%)\n```\n\n\n2. Lambda\u95a2\u6570\u306e\u4f5c\u6210\n===================\n\n\n2.1. Lambda\u95a2\u6570\u306e\u4f5c\u6210\n---------------------\n\n```bash:\u5909\u6570\u306e\u8a2d\u5b9a:\nLAMBDA_FUNC_DESC='Monitors VPN connection status of an account in all regions.'\nLAMBDA_RUNTIME='python2.7'\nLAMBDA_HANDLER=\"${LAMBDA_FUNC_NAME}.${PY_FUNC_NAME}\"\nFILE_LAMBDA_ZIP=\"${LAMBDA_FUNC_NAME}.zip\"\n```\n\n```bash:\u5909\u6570\u306e\u78ba\u8a8d:\ncat << ETX\n\n        LAMBDA_FUNC_NAME:  ${LAMBDA_FUNC_NAME}\n        LAMBDA_FUNC_DESC: \"${LAMBDA_FUNC_DESC}\"\n        LAMBDA_RUNTIME:    ${LAMBDA_RUNTIME}\n        FILE_LAMBDA_ZIP    ${FILE_LAMBDA_ZIP}\n        IAM_ROLE_ARN:      ${IAM_ROLE_ARN}\n        LAMBDA_HANDLER:    ${LAMBDA_HANDLER}\n\nETX\n```\n\n```bash:\u30b3\u30de\u30f3\u30c9:\naws lambda create-function \\\n        --function-name ${LAMBDA_FUNC_NAME} \\\n        --description \"${LAMBDA_FUNC_DESC}\" \\\n        --zip-file fileb://${FILE_LAMBDA_ZIP} \\\n        --runtime ${LAMBDA_RUNTIME} \\\n        --role ${IAM_ROLE_ARN} \\\n        --handler ${LAMBDA_HANDLER}\n```\n\n```json:\u7d50\u679c(\u4f8b):\n      {\n        \"CodeSha256\": \"c++vSFRfioI+KDLOGt3N97oJ+xroodc2SDy5wXWYlF8=\",\n        \"FunctionName\": \"vpn-conn-monitor-20161024\",\n        \"CodeSize\": 781,\n        \"MemorySize\": 128,\n        \"FunctionArn\": \"arn:aws:lambda:ap-northeast-1:XXXXXXXXXXXX:function:vpn-conn-monitor-20161024\",\n        \"Version\": \"$LATEST\",\n        \"Role\": \"arn:aws:iam::XXXXXXXXXXXX:role/lambdaVpnConnMonitorExecution\",\n        \"Timeout\": 3,\n        \"LastModified\": \"2016-10-22T01:23:45.678+0000\",\n        \"Handler\": \"vpn-conn-monitor-20161024.lambda_handler\",\n        \"Runtime\": \"python2.7\",\n        \"Description\": \"Monitors VPN connection status of an account in all regions.\"\n      }\n```\n\n```bash:\u30b3\u30de\u30f3\u30c9:\naws lambda get-function \\\n        --function-name ${LAMBDA_FUNC_NAME}\n```\n\n```json:\u7d50\u679c(\u4f8b):\n      {\n        \"Code\": {\n          \"RepositoryType\": \"S3\",\n          \"Location\": \"https://awslambda-ap-ne-1-tasks.s3-ap-northeast-1.amazonaws.com/snapshots/XXXXXXXXXXXX/HelloWorld-2979ba79-b08f-495d-9ee6-46397c95ba13?x-amz-security-token=AQoDYXdzEDoa8AMR6t8h66eOXhN3%2Fx7XpuRxvf7pVn7IuWV4cEmwx0CtZT6yxCJ1%2BWmigYXqGoyQHuBYOWnxbhmwEcTg839qMuhSu1fk0fXpXf0oJOLkhKMudNqhdElyFQpzyT6Q8GDfhAsfbX9wvwCDTty4imxz7MczF%2FQl6tgvTYdip08ap5fAyrknZGV1%2B1Ggnp5w6JOjydYxuUsWwhoxoEWzi7SoVTmpRQQA91c4VW9lNotOAHACFxo6klzDPM8mxR9RJl66WxFugL0wQJyLUpmtjS9XoArD86sEWWiIccMpV2BQipTPQlzL%2F1Hoy%2BDF6QUxyPUihlDjPBoJTISTP8W1wxmzW%2BLbilAfFQRPY7CFjzR0k%2FA%2FIX5x9iyz52Pu1Q0ASTw1l%2Fq%2Fo3pRbvzWR79QS%2BpxXrwbYzoQHKiK62DSTsQo5tqKPsiDCYzrPxbq8lm7pNBPG%2FsxjePRWBVJeRl08WxEjSjoRRwBOPX5mz1BCUoUBPGG5tEENp87A%2FCdDgibFWM5DdYhwtaYPY7FTmi8DvqjQHL9jOmP8YuVteBTBcv8nFW6UbErPjwwn79FKG1u5M9HoTWUqUMBByz6D4tTRSEw6iJU7XdCujFnhnHe5V8imZ1KGI7fDWpciJhrhml0wnKPCK%2Fe9lK1P2kO7ldSWc7zn5hcIOD2tbEF&AWSAccessKeyId=ASIAJFVALOKV5SJVYPPA&Expires=1445825978&Signature=bvwu1Ny34LgTmZeOO3q4sn7x3Fg%3D\"\n        },\n        \"Configuration\": {\n          \"Version\": \"$LATEST\",\n          \"CodeSha256\": \"c++vSFRfioI+KDLOGt3N97oJ+xroodc2SDy5wXWYlF8=\",\n          \"FunctionName\": \"vpn-conn-monitor-20161024\",\n          \"MemorySize\": 128,\n          \"CodeSize\": 350,\n          \"FunctionArn\": \"arn:aws:lambda:ap-northeast-1:XXXXXXXXXXXX:function:vpn-conn-monitor-20161024\",\n          \"Handler\": \"vpn-conn-monitor-20161024.lambda_handler\",\n          \"Role\": \"arn:aws:iam::XXXXXXXXXXXX:role/lambdaVpnConnMonitorExecution\",\n          \"Timeout\": 3,\n          \"LastModified\": \"2016-10-22T01:23:45.678+0000\",\n          \"Runtime\": \"python2.7\",\n          \"Description\": \"Monitors VPN connection status of an account in all regions.\"\n        }\n      }\n```\n\n```bash:\u30b3\u30de\u30f3\u30c9:\naws lambda get-function-configuration \\\n        --function-name ${LAMBDA_FUNC_NAME}\n```\n\n```json:\u7d50\u679c(\u4f8b):\n      {\n        \"CodeSha256\": \"c++vSFRfioI+KDLOGt3N97oJ+xroodc2SDy5wXWYlF8=\",\n        \"FunctionName\": \"vpn-conn-monitor-20161024\",\n        \"CodeSize\": 781,\n        \"MemorySize\": 128,\n        \"FunctionArn\": \"arn:aws:lambda:ap-northeast-1:XXXXXXXXXXXX:function:vpn-conn-monitor-20161024\",\n        \"Version\": \"$LATEST\",\n        \"Role\": \"arn:aws:iam::XXXXXXXXXXXX:role/lambdaVpnConnMonitorExecution\",\n        \"Timeout\": 3,\n        \"LastModified\": \"2016-10-22T01:23:45.678+0000\",\n        \"Handler\": \"vpn-conn-monitor-20161024.handler\",\n        \"Runtime\": \"python2.7\",\n        \"Description\": \"Monitors VPN connection status of an account in all regions.\"\n      }\n```\n\n\n2.2. Lambda\u95a2\u6570\u306e\u66f4\u65b0\n---------------------\n\n\u30c7\u30d5\u30a9\u30eb\u30c8\u306e3\u79d2\u3067\u306f\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u3059\u308b\u53ef\u80fd\u6027\u304c\u9ad8\u3044\u306e\u3067\u3001\u3053\u3053\u3067\u306f30\u79d2\u306b\u5909\u66f4\u3057\u307e\u3059\u3002\n\n```bash:\u5909\u6570\u306e\u8a2d\u5b9a:\nLAMBDA_TIMEOUT='30'\n```\n\n```bash:\u5909\u6570\u306e\u78ba\u8a8d:\ncat << ETX\n\n        LAMBDA_FUNC_NAME: ${LAMBDA_FUNC_NAME}\n        LAMBDA_TIMEOUT:   ${LAMBDA_TIMEOUT}\n\nETX\n```\n\n```bash:\u30b3\u30de\u30f3\u30c9:\naws lambda update-function-configuration \\\n        --function-name ${LAMBDA_FUNC_NAME} \\\n        --timeout \"${LAMBDA_TIMEOUT}\"\n```\n\n```json:\u7d50\u679c(\u4f8b):\n      {\n        \"CodeSha256\": \"c++vSFRfioI+KDLOGt3N97oJ+xroodc2SDy5wXWYlF8=\",\n        \"FunctionName\": \"vpn-conn-monitor-20161024\",\n        \"VpcConfig\": {\n            \"SubnetIds\": [],\n            \"SecurityGroupIds\": []\n        },\n        \"CodeSize\": 781,\n        \"MemorySize\": 128,\n        \"FunctionArn\": \"arn:aws:lambda:ap-northeast-1:XXXXXXXXXXXX:function:vpn-conn-monitor-20161024\",\n        \"Version\": \"$LATEST\",\n        \"Role\": \"arn:aws:iam::XXXXXXXXXXXX:role/lambdaVpnConnMonitorExecution\",\n        \"Timeout\": 30,\n        \"LastModified\": \"2016-10-22T01:23:45.678+0000\",\n        \"Handler\": \"vpn-conn-monitor-20161024.handler\",\n        \"Runtime\": \"python2.7\",\n        \"Description\": \"Monitors VPN connection status of an account in all regions.\"\n      }\n```\n\n\n3. Lambda\u95a2\u6570\u306e\u52d5\u4f5c\u78ba\u8a8d\n=======================\n\n\n3.1. \u30b5\u30f3\u30d7\u30eb\u30c7\u30fc\u30bf\u306e\u4f5c\u6210\n-------------------------\n\n```bash:\u5909\u6570\u306e\u8a2d\u5b9a:\nFILE_INPUT=\"${LAMBDA_FUNC_NAME}-data.json\" \\\n          && echo ${FILE_INPUT}\n```\n\n```bash:\u30b5\u30f3\u30d7\u30eb\u30c7\u30fc\u30bf:\n\ncat << EOF > ${FILE_INPUT}\n{\n        \"account\": \"123456789012\",\n        \"region\": \"${AWS_DEFAULT_REGION}\",\n        \"detail\": {},\n        \"detail-type\": \"Scheduled Event\",\n        \"source\": \"aws.events\",\n        \"time\": \"1970-01-01T00:00:00Z\",\n        \"id\": \"cdc73f9d-aea9-11e3-9d5a-835b769c0d9c\",\n        \"resources\": [\n          \"arn:aws:events:${AWS_DEFAULT_REGION}:123456789012:rule/my-schedule\"\n        ]\n}\nEOF\n\ncat ${FILE_INPUT}\n```\n\nJSON\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3057\u305f\u3089\u3001\u30d5\u30a9\u30fc\u30de\u30c3\u30c8\u304c\u58ca\u308c\u3066\u306a\u3044\u304b\u5fc5\u305a\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n```bash:\u30b3\u30de\u30f3\u30c9:\njsonlint -q ${FILE_INPUT}\n```\n\n\u30a8\u30e9\u30fc\u304c\u51fa\u529b\u3055\u308c\u306a\u3051\u308c\u3070OK\u3067\u3059\u3002\n\n\n3.2. lambda\u95a2\u6570\u306e\u624b\u52d5\u5b9f\u884c\n-------------------------\n\n```bash:\u5909\u6570\u306e\u8a2d\u5b9a:\nFILE_OUTPUT_LAMBDA=\"${LAMBDA_FUNC_NAME}-out.txt\"\nFILE_LOG_LAMBDA=\"${LAMBDA_FUNC_NAME}-$(date +%Y%m%d%H%M%S).log\"\n```\n\n```bash:\u5909\u6570\u306e\u78ba\u8a8d:\ncat << ETX\n\n        LAMBDA_FUNC_NAME:   ${LAMBDA_FUNC_NAME}\n        FILE_INPUT:         ${FILE_INPUT}\n        FILE_OUTPUT_LAMBDA: ${FILE_OUTPUT_LAMBDA}\n        FILE_LOG_LAMBDA:    ${FILE_LOG_LAMBDA}\n\nETX\n```\n\n```bash:\u30b3\u30de\u30f3\u30c9:\naws lambda invoke \\\n        --function-name ${LAMBDA_FUNC_NAME} \\\n        --log-type Tail \\\n        --payload file://${FILE_INPUT} \\\n        ${FILE_OUTPUT_LAMBDA} \\\n        > ${FILE_LOG_LAMBDA}\n```\n\n```bash:\u30b3\u30de\u30f3\u30c9:\ncat ${FILE_LOG_LAMBDA} \\\n        | jp.py 'StatusCode'\n```\n\n```text:\u7d50\u679c(\u4f8b):\n      200\n```\n\n\n3.3. lambda\u95a2\u6570\u306e\u5b9f\u884c\u7d50\u679c\u306e\u78ba\u8a8d\n-------------------------------\n\n```bash:\u30b3\u30de\u30f3\u30c9:\ncat ${FILE_OUTPUT_LAMBDA}\n```\n\n```text:\u7d50\u679c(\u4f8b):\n      1\n```\n\n\n3.4. lambda\u95a2\u6570\u306e\u30ed\u30b0\u306e\u78ba\u8a8d\n---------------------------\n\n```bash:\u30b3\u30de\u30f3\u30c9:\ncat ${FILE_LOG_LAMBDA} \\\n        | jp.py 'LogResult' \\\n        | sed 's/\"//' \\\n        | base64 --decode\n```\n\n```text:\u7d50\u679c(\u4f8b):\n      START RequestId: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx Version: $LATEST\n      END RequestId: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx\n      REPORT RequestId: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx      Duration: 12870.41 ms   Billed Duration: 12900 ms       Memory Size: 128 MB     Max Memory Used: 33 MB\n```\n\n\n\u5b8c\u4e86\n====\n", "tags": ["AWS", "aws-cli", "lambda", "CloudWatch"]}