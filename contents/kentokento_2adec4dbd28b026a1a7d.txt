{"context": " More than 1 year has passed since last update.\n\n\nversion\n\n\n\n\nansible 1.9.2\n\n\n\n\n\u6761\u4ef6\n\u30fb\u30a4\u30df\u30e5\u30fc\u30bf\u30d6\u30eb\u30a4\u30f3\u30d5\u30e9\u30b9\u30c8\u30e9\u30af\u30c1\u30e3\u30fc\u306e\u5b9f\u73fe\n\u30fb\u30c0\u30a6\u30f3\u30bf\u30a4\u30e00\u3067\u30ed\u30b0\u30ed\u30b9\u30c8\u3082\u3057\u306a\u3044\u3088\u3046\u306a\u5b89\u5168\u306a\u30c7\u30d7\u30ed\u30a4\n\u30fb\u6700\u5c0f\u306e\u30b3\u30b9\u30c8\u3067\u6700\u5927\u9650\u306e\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u3092\u51fa\u305b\u308bAutoScaling\u3092\u6d3b\u7528\u3059\u308b\n\n\u6e96\u5099\n\nAutoscalingGroup\u4f5c\u6210\u3057\u3066\u7a3c\u50cd\u3055\u305b\u3066\u304a\u304f\uff08\u53c2\u8003\uff1aAuto Scaling \u306e\u4f7f\u7528\u958b\u59cb\n \uff09\nAutoScaling-LifeCycleHook\u306eSNS\u3068IAM\u306e\u8a2d\u5b9a\u3092\u3057\u3066\u304a\u304f\uff08\u53c2\u8003\uff1a\u3010\u65b0\u6a5f\u80fd\u3011Auto Scaling\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u8d77\u52d5/\u7834\u68c4\u6642\u306b\u521d\u671f\u51e6\u7406/\u7d42\u4e86\u51e6\u7406\u3092\u8ffd\u52a0 \u2013 LifeCycleHook\u6a5f\u80fd\u306e\u3054\u7d39\u4ecb\uff09\n\n\n\u30c7\u30d7\u30ed\u30a4\u306e\u6d41\u308c\n\ninstance_id\u3092\u53d7\u3051\u53d6\u308aAMI\u3092\u4f5c\u6210\u3059\u308b\n\u4f5c\u6210\u3057\u305fAMI\u304b\u3089LaunchConfigration\u3092\u4f5c\u6210\u3059\u308b\nAutoScalingGroup\u306e\u8a2d\u5b9a\u3092\u5909\u66f4\u3059\u308b\nELB\u306b\u65b0\u3057\u3044\u30d0\u30fc\u30b8\u30e7\u30f3\u306e\u30b5\u30fc\u30d0\u3092ServiceIn\u3055\u305b\u308b\u3002\uff08\u53e4\u3044\u30d0\u30fc\u30b8\u30e7\u30f3\u306e\u3082\u306e\u3068\u540c\u6570\uff09\n\u65b0\u3057\u3044\u30d0\u30fc\u30b8\u30e7\u30f3\u306e\u30b5\u30fc\u30d0\u306eServiceIn\u76f4\u5f8c\u306b\u53e4\u3044\u30d0\u30fc\u30b8\u30e7\u30f3\u306e\u3082\u306e\u3092ELB\u304b\u3089ServiceOut\u3055\u305b\u308b\n\u53e4\u3044\u30d0\u30fc\u30b8\u30e7\u30f3\u306e\u3082\u306e\u306f\u30ed\u30b0\u3092\u9001\u308a\u304d\u3063\u3066\u304b\u3089terminate\u3055\u305b\u308b\n\n\n\u4e0a\u8a18\u306e\u6d41\u308c\u3067Blue-Green\u30c7\u30d7\u30ed\u30a4\u3092\u884c\u3046playbook\n\nblue-green-deploy.yml\n- hosts: localhost\n  connection: local\n  gather_facts: no\n  vars:\n    - aws:\n        access_key: AAAAAAAAAA\n        secret_key: BBBBBBBBBB\n    - ec2:\n        instance_type: t2.medium\n        security_group_id: sg-xxxxxxx\n        vpc_subnet_id_1a: subnet-aaaaaaaa\n        vpc_subnet_id_1c: subnet-cccccccc\n        availability_zone_1a: ap-northeast-1a\n        availability_zone_1c: ap-northeast-1c\n        region: ap-northeast-1\n        associate_elb: elb-sample\n    - heartbeat_timeout: 300\n    - lifecycle_notify: arn:aws:sns:ap-northeast-1:xxxxx:hogehoge\n    - lifecycle_role: arn:aws:iam::xxxxxxx:role/sample-asg-lifecycle\n    - auto_scaling_group_name: asg_sample\n  tasks:\n    - name: AMI\u3092\u4f5c\u6210\n      ec2_ami:\n        aws_access_key: \"{{ aws.access_key }}\"\n        aws_secret_key: \"{{ aws.secret_key }}\"\n        region: \"{{ ec2.region }}\"\n        instance_id: \"{{ ec2_instance_id }}\"\n        no_reboot: no\n        wait: yes\n      register: ami_result\n\n    - name: LaunchConfigration\u3092\u4f5c\u6210\n      ec2_lc:\n        name: \"lc_{{ ec2_instance_id }}\"\n        image_id: \"{{ ami_result.image_id }}\"\n        region: \"{{ ec2.region }}\"\n        security_groups: \"{{ ec2.security_group_id }}\"\n        instance_type: \"{{ ec2.instance_type }}\"\n\n    - name: \u73fe\u5728\u306eauto-scaling-group\u306e\u60c5\u5831\u3092\u53d6\u3063\u3066\u304f\u308b\n      shell: |\n        aws autoscaling describe-auto-scaling-groups \\\n          --auto-scaling-group-names {{ auto_scaling_group_name }} \\\n        | jq .AutoScalingGroups[] \\\n        | jq \\\"{MinSize:.MinSize,MaxSize:.MaxSize,DesiredCapacity:.DesiredCapacity,Instances:[.Instances[]]}\\\"\n      register: auto_scaling_group_desc\n\n    - name: \u73fe\u5728\u306eauto-scaling-group\u306e\u60c5\u5831\u3092\u5909\u6570\u306bSET\u3059\u308b\n      set_fact:\n        asg_desc: \"{{ auto_scaling_group_desc.stdout|from_json }}\"\n      register: result\n    - set_fact:\n        asg_min_size: \"{{ asg_desc.MinSize|int }}\"\n        asg_max_size: \"{{ asg_desc.MaxSize|int }}\"\n        asg_desired_capacity: \"{{ asg_desc.DesiredCapacity|int }}\"\n        asg_instances: \"{{ asg_desc.Instances }}\"\n\n    - name: terminate\u3055\u305b\u308b\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u5b89\u5168\u306b\u843d\u3068\u3059\u305f\u3081\u306e\u8a2d\u5b9a\u3092\u3059\u308b\n      shell: |\n        aws autoscaling put-lifecycle-hook \\\n          --lifecycle-hook-name {{ auto_scaling_group_name }}-terminate \\\n          --auto-scaling-group-name {{ auto_scaling_group_name }} \\\n          --lifecycle-transition autoscaling:EC2_INSTANCE_TERMINATING \\\n          --notification-target-arn {{ lifecycle_notify }} \\\n          --role-arn {{ lifecycle_role }} \\\n          --heartbeat-timeout {{ heartbeat_timeout }}\n\n    - name: auto-scaling-group\u306e\u8a2d\u5b9a\u3092UPDATE\u3059\u308b\n      ec2_asg:\n        name: \"{{ auto_scaling_group_name }}\"\n        health_check_period: 300\n        load_balancers: [ \"{{ ec2.associate_elb }}\" ]\n        health_check_type: ELB\n        availability_zones: [ \"{{ ec2.availability_zone_1a }}\", \"{{ ec2.availability_zone_1c }}\" ]\n        launch_config_name: \"{{ launch_config_name }}\"\n        min_size: \"{{ asg_min_size }}\"\n        max_size: \"{{ asg_max_size|int * 2 }}\"\n        desired_capacity: \"{{ asg_desired_capacity|int * 2 }}\"\n        region: \"{{ ec2.region }}\"\n        vpc_zone_identifier: [ \"{{ ec2.vpc_subnet_id_1a }}\", \"{{ ec2.vpc_subnet_id_1c }}\" ]\n        state: present\n\n    - name: termination-policies\u3092\u5909\u66f4\u3059\u308b\uff08\u53e4\u3044\u3082\u306e\u304b\u3089\u843d\u3068\u3055\u308c\u308b\u3088\u3046\u306b\uff09\n      shell: |\n        aws autoscaling update-auto-scaling-group \\\n          --auto-scaling-group-name {{ auto_scaling_group_name }} \\\n          --termination-policies \\\"OldestInstance\\\" \\\"OldestLaunchConfiguration\\\"\n\n    - name: \u3059\u3079\u3066\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u304c\u5165\u308c\u66ff\u308f\u308b\u307e\u3067\u5f85\u3064\n      shell: |\n        aws elb describe-instance-health \\\n          --load-balancer-name {{ ec2.associate_elb }} \\\n        | jq 'map(.[]|select(.State == \\\"InService\\\"))|length'\n      register: res_elb\n      until: res_elb.stdout|int >= (asg_desired_capacity|int * 2)\n      retries: 300\n      delay: 5\n\n    - name: \u65b0\u3057\u3044LaunchConfiguration\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u53f0\u6570\u3092\u53d6\u5f97\u3059\u308b\n      shell: |\n        aws autoscaling describe-auto-scaling-groups \\\n          --auto-scaling-group-names {{ auto_scaling_group_name }} \\\n        | jq .AutoScalingGroups[].Instances \\\n        | jq 'map(select(.LaunchConfigurationName == \\\"{{ launch_config_name }}\\\"))|length'\n      register: new_instance_count\n\n    - name: \u3059\u3079\u3066\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u304c\u5165\u308c\u66ff\u308f\u3063\u305f\u304b\u78ba\u8a8d\u3059\u308b\uff08\u3046\u307e\u304f\u3044\u3063\u3066\u3044\u306a\u3051\u308c\u3070\u51e6\u7406\u3092\u6b62\u3081\u308b\uff09\n      action: exit 1\n      when: res_elb.attempts >= 300 or asg_desired_capacity|int > new_instance_count.stdout|int\n\n    - name: \u53e4\u3044\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092terminate\u3059\u308b\n      shell: |\n        aws autoscaling terminate-instance-in-auto-scaling-group \\\n          --instance-id {{ item.InstanceId }} \\\n          --should-decrement-desired-capacity\n      when: \"{{ item.LifecycleState == 'InService' }}\"\n      with_items: \"{{ asg_instances }}\"\n\n    - name: AutoScaling\u306e\u8a2d\u5b9a\u3092\u5143\u306b\u623b\u3059\n      shell: |\n        aws autoscaling update-auto-scaling-group \\\n          --auto-scaling-group-name {{ auto_scaling_group_name }} \\\n          --max-size {{ asg_max_size }}\n\n\n\n\uff3f\u4eba\u4eba\u4eba\u4eba\u4eba\u4eba\u4eba\u4eba\u4eba\u4eba\uff3f\n\uff1e\u3000\u307b\u307cshell...orz\u3000\uff1c\n\uffe3\uff39\uff39\uff39\uff39\uff39\uff39\uff39\uff39\uff39\uff39\uffe3\n\u3059\u307f\u307e\u305b\u3093\u307b\u307cshell\u3067\u3059\u306d...\n\u7c97\u96d1\u3067\u3059\u304c\u3042\u308b\u7a0b\u5ea6\u52d5\u3044\u3066\u3044\u308b\u306e\u3067\u52d8\u5f01\u3057\u3066\u304f\u3060\u3055\u3044\n\uff08\u5b9f\u969b\u306b\u52d5\u304b\u3057\u305f\u3082\u306e\u3068\u306f\u9055\u3044\u307e\u3059\u304c\u3001\u52d5\u304f\u306f\u305a...\uff01\uff09\n\n\u3044\u3056\u5b9f\u884c\u3057\u3066\u307f\u308b\n\n\u5b9f\u884c\u30b3\u30de\u30f3\u30c9\n# instance_id\u3092\u6e21\u3059\u3060\u3051\nansible-playbook blue-green-deploy.yml --extra-vars=\"ec2_instance_id=i-hogehoge\"\n\n\n\n\u89e3\u8aac\n\n\u30c7\u30d7\u30ed\u30a4\u6642\u306e\u6d41\u308c\u3092\u8a73\u3057\u304f\u8aac\u660e\u3057\u307e\u3059\n\n1\uff09\u73fe\u5728\u306eAutoscaling\u306e\u8a2d\u5b9a\u3092\u53d6\u3063\u3066\u304f\u308b\n\n2\uff09\u73fe\u5728\u306eAutoscaling\u306e\u30b5\u30fc\u30d0\u30b9\u30b1\u30fc\u30eb\uff08desired\uff09\u3068\u73fe\u5728SeviceIn\u3057\u3066\u3044\u308b\u30b5\u30fc\u30d0\u306eInstanceId\u3092\u30e1\u30e2\u3057\u3066\u304a\u304f\n\n3\uff09Autoscaling\u306e\u8a2d\u5b9a\u3092\u5909\u66f4\u3059\u308b\n\u5909\u66f4\u5185\u5bb9\uff1a\n\u3000\u30fblaunch_config\u3092\u65b0\u3057\u3044\u30d0\u30fc\u30b8\u30e7\u30f3\u306e\u3082\u306e\u306b\u3059\u308b\uff08\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u8d77\u52d5\u8a2d\u5b9a\u3092\u6700\u65b0\u7248\u306e\u3082\u306e\u306b\u3059\u308b\uff09\n\u3000\u30fbdesired\u3092\u73fe\u5728\u306e\u3061\u3087\u3046\u30692\u500d\u306e\u5024\u306b\u3059\u308b\u3002min\u3068max\u306f\u5909\u66f4\u3057\u306a\u3044\n\n\n4\uff09\u53e4\u3044\u30d0\u30fc\u30b8\u30e7\u30f3\u306e\u3082\u306e\u3068\u65b0\u3057\u3044\u30d0\u30fc\u30b8\u30e7\u30f3\u306e\u3082\u306e\u304c\u3059\u3079\u3066ELB\u304b\u3089\u898b\u3066\u30b5\u30fc\u30d3\u30b9\u30a4\u30f3\u3057\u3066\u3044\u308b\u72b6\u614b\u306b\u306a\u308b\u307e\u3067\u5f85\u3064\n\nELB\u306b\u306e\u30d8\u30eb\u30b9\u30c1\u30a7\u30c3\u30af\u304c\u901a\u3063\u3066\u5b89\u5168\u306a\u72b6\u614b\u306b\u306a\u308b\u307e\u3067\u5f85\u3064\n- name: \u3059\u3079\u3066\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u304c\u5165\u308c\u66ff\u308f\u308b\u307e\u3067\u5f85\u3064\n  shell: |\n    aws elb describe-instance-health \\\n      --load-balancer-name {{ ec2.associate_elb }} \\\n    | jq 'map(.[]|select(.State == \\\"InService\\\"))|length'\n  register: res_elb\n  until: res_elb.stdout|int >= (asg_desired_capacity|int * 2)\n  retries: 300\n  delay: 5\n\n\naws cli\u3092\u5229\u7528\u3057\u3066elb\u306bInService\u3068\u306a\u3063\u3066\u3044\u308b\u30b5\u30fc\u30d0\u304c\u53d6\u5f97\u3057\u305f\u73fe\u5728\u306edesired capacity\u306e\u500d\u306e\u6570\u306b\u306a\u308b\u307e\u3067\u30ea\u30af\u30a8\u30b9\u30c85\u79d2\u304a\u304d\u306b300\u56de\u307e\u3067\u7e70\u308a\u8fd4\u3057\u307e\u3059\n\n5\uff09\u5ff5\u306e\u305f\u3081\u30b5\u30fc\u30d3\u30b9\u30a4\u30f3\u3057\u3066\u3044\u308b\u30b5\u30fc\u30d0\u306e\u3046\u3061\u3001\u65b0\u3057\u3044\u30d0\u30fc\u30b8\u30e7\u30f3\u306e\u3082\u306e\u304c\u3044\u304f\u3064\u3042\u308b\u304b\u78ba\u8a8d\u3059\u308b\u305f\u3081\u306b\u60c5\u5831\u3092\u53d6\u3063\u3066\u304f\u308b\n\n\u65b0\u3057\u3044\u30d0\u30fc\u30b8\u30e7\u30f3\u306e\u30b5\u30fc\u30d0\u53f0\u6570\u53d6\u5f97\n- name: \u65b0\u3057\u3044LaunchConfiguration\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u53f0\u6570\u3092\u53d6\u5f97\u3059\u308b\n  shell: |\n    aws autoscaling describe-auto-scaling-groups \\\n      --auto-scaling-group-names {{ auto_scaling_group_name }} \\\n    | jq .AutoScalingGroups[].Instances \\\n    | jq 'map(select(.LaunchConfigurationName == \\\"{{ launch_config_name }}\\\"))|length'\n  register: new_instance_count\n\n\n6 - \u5b89\u5168\u306b\u30c7\u30d7\u30ed\u30a4\u3067\u304d\u3066\u3044\u308b\u304b\u306e\u78ba\u8a8d\uff08\u3067\u304d\u3066\u3044\u306a\u3044\u5834\u5408\u306f\u51e6\u7406\u3092\u4e2d\u65ad\uff09\n\n\u5b89\u5168\u306b\u30c7\u30d7\u30ed\u30a4\u304c\u3067\u304d\u305f\u304b\u78ba\u8a8d\n- name: \u3059\u3079\u3066\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u304c\u5165\u308c\u66ff\u308f\u3063\u305f\u304b\u78ba\u8a8d\u3059\u308b\uff08\u3046\u307e\u304f\u3044\u3063\u3066\u3044\u306a\u3051\u308c\u3070\u51e6\u7406\u3092\u6b62\u3081\u308b\uff09\n  action: exit 1\n  when: res_elb.attempts >= 300 or asg_desired_capacity|int > new_instance_count.stdout|int\n\n\n=> \u4e0b\u8a182\u70b9\u306e\u5834\u5408\u306f\u51e6\u7406\u3092\u4e2d\u65ad\u3055\u305b\u308b\u3002\uff08\u30c0\u30a6\u30f3\u30bf\u30a4\u30e0\u3092\u4f5c\u3089\u306a\u3044\u3088\u3046\u306b\u3059\u308b\u305f\u3081\uff09\n \u3000\u30fbELB\u306b\u30b5\u30fc\u30d3\u30b9\u30a4\u30f3\u3057\u3066\u3044\u308b\u30b5\u30fc\u30d0\u306e\u53f0\u6570\u3092\u78ba\u8a8d\u3059\u308b\u51e6\u7406\u304c\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u3057\u3066\u3044\u305f\u5834\u5408\n \u3000\u30fb\u65b0\u3057\u3044\u30d0\u30fc\u30b8\u30e7\u30f3\u306e\u30b5\u30fc\u30d0\u53f0\u6570\u53d6\u5f97\u304c\u5143\u306e\u30b5\u30fc\u30d0\u53f0\u6570\u3088\u308a\u5c11\u306a\u3044\u5834\u5408\n7 - 6\u3067\u3061\u3083\u3093\u3068\u78ba\u8a8d\u304c\u3067\u304d\u305f\u3089\u30012\u3067\u30e1\u30e2\u3057\u3066\u304a\u3044\u305fInstanceId\u3092terminating\u306e\u72b6\u614b\u306b\u79fb\u3059\n\n\u53e4\u3044\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092terminate\u3059\u308b\n- name: \u53e4\u3044\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092terminate\u3059\u308b\n  shell: |\n    aws autoscaling terminate-instance-in-auto-scaling-group \\\n      --instance-id {{ item.InstanceId }} \\\n      --should-decrement-desired-capacity\n  when: \"{{ item.LifecycleState == 'InService' }}\"\n  with_items: \"{{ asg_instances }}\"\n\n\n8 - \u30c7\u30d7\u30ed\u30a4\u5b8c\u4e86\u3067\u3059\n\n\u53e4\u3044\u30d0\u30fc\u30b8\u30e7\u30f3\u306e\u3082\u306e\u306f\u3059\u3050\u306bterminate\u3055\u308c\u306a\u3044\u3088\u3046\u306b\u3057\u3066\u3044\u308b\nlifecyclehook\u306eterminating:wait\u306e\u8a2d\u5b9a\u3060\u3051\u3057\u3068\u3044\u3066\u3042\u3052\u308c\u3070\u3001\u3068\u308a\u3042\u3048\u305a\u5b9f\u969b\u306bterminate\u3055\u308c\u308b\u307e\u3067\u7336\u4e88\u3092\u4e0e\u3048\u308b\u3053\u3068\u304c\u3067\u304d\u308b\u3002\uff08\u305d\u306e\u6642\u9593\u3067fluentd\u7b49\u304c\u30ed\u30b0\u3092\u3059\u3079\u3066\u9001\u308a\u5207\u308b\u3088\u3046\u306b\u3059\u308b\uff09\n\nlifecyclehook\u767b\u9332\naws autoscaling put-lifecycle-hook \\\n  --lifecycle-hook-name {{ auto_scaling_group_name }}-terminate \\\n  --auto-scaling-group-name {{ auto_scaling_group_name }} \\\n  --lifecycle-transition autoscaling:EC2_INSTANCE_TERMINATING \\\n  --notification-target-arn {{ lifecycle_notify }} \\\n  --role-arn {{ lifecycle_role }} \\\n  --heartbeat-timeout {{ heartbeat_timeout }}\n\n\n\nAnsible\u306eec2_asg:replace_instances\u306b\u3064\u3044\u3066\nAnsible\u306eautoscaling\u30e2\u30b8\u30e5\u30fc\u30eb\u306b\u30c7\u30d7\u30ed\u30a4\u6642\u306b\u30ed\u30fc\u30ea\u30f3\u30b0\u30a2\u30c3\u30d7\u30c7\u30fc\u30c8\u3067\u81ea\u52d5\u3067\u3086\u3063\u304f\u308a\u30b5\u30fc\u30d0\u3092\u5207\u308a\u66ff\u3048\u3066\u304f\u308c\u308b\u3082\u306e\u304c\u3042\u308a\u307e\u3059\u3002\nec2_asg:\n  replace_instances: yes\n\n\u3057\u304b\u3057\u3053\u308c\u3060\u3068\u9045\u3044&terminateing:wait\u3068\u306e\u76f8\u6027\u304c\u826f\u304f\u3042\u308a\u307e\u305b\u3093\nterminateing:wait\u306e\u72b6\u614b\u3092\u5f85\u3063\u3066\u3057\u307e\u3046\n\uff08\u4f8b\uff1aterminating:wait\u304c5\u5206\u306e\u5834\u5408\u4e00\u3064instance\u3092terminating\u3057\u3066\u3044\u3066\u3001\u6b21\u306einstance\u3092terminate\u3059\u308b\u306e\u306f5\u5206\u5f8c\u3002\u305d\u306e\u9593\u53e4\u3044\u30d0\u30fc\u30b8\u30e7\u30f3\u306e\u3082\u306e\u304cELB\u306b\u3076\u3089\u4e0b\u304c\u308a\u7d9a\u3051\u3066\u3057\u307e\u3046\u3002\uff09\n\n\u30c6\u30b9\u30c8\n\u7c21\u6613\u306a\u30c6\u30b9\u30c8\u3067\u3059\u304c\u3001\u4e0b\u8a18\u30b9\u30af\u30ea\u30d7\u30c8\u3067\u672c\u5f53\u306b\u30c0\u30a6\u30f3\u30bf\u30a4\u30e0\u304c0\u304b\u78ba\u8a8d\u3057\u307e\u3057\u305f\u3002\n\n\u30c6\u30b9\u30c8\u30b9\u30af\u30ea\u30d7\u30c8\nwatch -n 1 \"curl -s https://sample.io/http_status -o /dev/null -w '%{http_code}\\n'\"\n\n\nELB\u306b\u6b63\u5e38\u306b\u30b5\u30fc\u30d0\u304c\u3076\u3089\u4e0b\u304c\u3063\u3066\u3044\u306a\u3044\u3068503\u304c\u767a\u751f\u3057\u307e\u3059\u3002\nreplace_instances\u3092\u4f7f\u3046\u3068\u82e5\u5e72503\u304c\u767a\u751f\u3057\u3066\u3057\u307e\u3044\u307e\u3057\u305f\u304c\u3001\u4e0a\u8a18\u306eplaybook\u306a\u3089\u3059\u3079\u3066200\u3092\u78ba\u8a8d\u3067\u304d\u307e\u3057\u305f\u3002\n|version|\n|---:|\n|ansible 1.9.2|\n\n# \u6761\u4ef6\n\u30fb\u30a4\u30df\u30e5\u30fc\u30bf\u30d6\u30eb\u30a4\u30f3\u30d5\u30e9\u30b9\u30c8\u30e9\u30af\u30c1\u30e3\u30fc\u306e\u5b9f\u73fe\n\u30fb\u30c0\u30a6\u30f3\u30bf\u30a4\u30e00\u3067\u30ed\u30b0\u30ed\u30b9\u30c8\u3082\u3057\u306a\u3044\u3088\u3046\u306a\u5b89\u5168\u306a\u30c7\u30d7\u30ed\u30a4\n\u30fb\u6700\u5c0f\u306e\u30b3\u30b9\u30c8\u3067\u6700\u5927\u9650\u306e\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u3092\u51fa\u305b\u308bAutoScaling\u3092\u6d3b\u7528\u3059\u308b\n\n# \u6e96\u5099\n- AutoscalingGroup\u4f5c\u6210\u3057\u3066\u7a3c\u50cd\u3055\u305b\u3066\u304a\u304f\uff08\u53c2\u8003\uff1a[Auto Scaling \u306e\u4f7f\u7528\u958b\u59cb\n](https://docs.aws.amazon.com/ja_jp/AutoScaling/latest/DeveloperGuide/GettingStartedTutorial.html) \uff09\n- AutoScaling-LifeCycleHook\u306eSNS\u3068IAM\u306e\u8a2d\u5b9a\u3092\u3057\u3066\u304a\u304f\uff08\u53c2\u8003\uff1a[\u3010\u65b0\u6a5f\u80fd\u3011Auto Scaling\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u8d77\u52d5/\u7834\u68c4\u6642\u306b\u521d\u671f\u51e6\u7406/\u7d42\u4e86\u51e6\u7406\u3092\u8ffd\u52a0 \u2013 LifeCycleHook\u6a5f\u80fd\u306e\u3054\u7d39\u4ecb](http://dev.classmethod.jp/cloud/aws/autoscaling-lifecyclehook/)\uff09\n\n# \u30c7\u30d7\u30ed\u30a4\u306e\u6d41\u308c\n\n1. instance_id\u3092\u53d7\u3051\u53d6\u308aAMI\u3092\u4f5c\u6210\u3059\u308b\n2. \u4f5c\u6210\u3057\u305fAMI\u304b\u3089LaunchConfigration\u3092\u4f5c\u6210\u3059\u308b\n3. AutoScalingGroup\u306e\u8a2d\u5b9a\u3092\u5909\u66f4\u3059\u308b\n4. ELB\u306b\u65b0\u3057\u3044\u30d0\u30fc\u30b8\u30e7\u30f3\u306e\u30b5\u30fc\u30d0\u3092ServiceIn\u3055\u305b\u308b\u3002\uff08\u53e4\u3044\u30d0\u30fc\u30b8\u30e7\u30f3\u306e\u3082\u306e\u3068\u540c\u6570\uff09\n5. \u65b0\u3057\u3044\u30d0\u30fc\u30b8\u30e7\u30f3\u306e\u30b5\u30fc\u30d0\u306eServiceIn\u76f4\u5f8c\u306b\u53e4\u3044\u30d0\u30fc\u30b8\u30e7\u30f3\u306e\u3082\u306e\u3092ELB\u304b\u3089ServiceOut\u3055\u305b\u308b\n6. \u53e4\u3044\u30d0\u30fc\u30b8\u30e7\u30f3\u306e\u3082\u306e\u306f\u30ed\u30b0\u3092\u9001\u308a\u304d\u3063\u3066\u304b\u3089terminate\u3055\u305b\u308b\n\n# \u4e0a\u8a18\u306e\u6d41\u308c\u3067Blue-Green\u30c7\u30d7\u30ed\u30a4\u3092\u884c\u3046playbook\n\n```yaml:blue-green-deploy.yml\n- hosts: localhost\n  connection: local\n  gather_facts: no\n  vars:\n    - aws:\n        access_key: AAAAAAAAAA\n        secret_key: BBBBBBBBBB\n    - ec2:\n        instance_type: t2.medium\n        security_group_id: sg-xxxxxxx\n        vpc_subnet_id_1a: subnet-aaaaaaaa\n        vpc_subnet_id_1c: subnet-cccccccc\n        availability_zone_1a: ap-northeast-1a\n        availability_zone_1c: ap-northeast-1c\n        region: ap-northeast-1\n        associate_elb: elb-sample\n    - heartbeat_timeout: 300\n    - lifecycle_notify: arn:aws:sns:ap-northeast-1:xxxxx:hogehoge\n    - lifecycle_role: arn:aws:iam::xxxxxxx:role/sample-asg-lifecycle\n    - auto_scaling_group_name: asg_sample\n  tasks:\n    - name: AMI\u3092\u4f5c\u6210\n      ec2_ami:\n        aws_access_key: \"{{ aws.access_key }}\"\n        aws_secret_key: \"{{ aws.secret_key }}\"\n        region: \"{{ ec2.region }}\"\n        instance_id: \"{{ ec2_instance_id }}\"\n        no_reboot: no\n        wait: yes\n      register: ami_result\n\n    - name: LaunchConfigration\u3092\u4f5c\u6210\n      ec2_lc:\n        name: \"lc_{{ ec2_instance_id }}\"\n        image_id: \"{{ ami_result.image_id }}\"\n        region: \"{{ ec2.region }}\"\n        security_groups: \"{{ ec2.security_group_id }}\"\n        instance_type: \"{{ ec2.instance_type }}\"\n\n    - name: \u73fe\u5728\u306eauto-scaling-group\u306e\u60c5\u5831\u3092\u53d6\u3063\u3066\u304f\u308b\n      shell: |\n        aws autoscaling describe-auto-scaling-groups \\\n          --auto-scaling-group-names {{ auto_scaling_group_name }} \\\n        | jq .AutoScalingGroups[] \\\n        | jq \\\"{MinSize:.MinSize,MaxSize:.MaxSize,DesiredCapacity:.DesiredCapacity,Instances:[.Instances[]]}\\\"\n      register: auto_scaling_group_desc\n\n    - name: \u73fe\u5728\u306eauto-scaling-group\u306e\u60c5\u5831\u3092\u5909\u6570\u306bSET\u3059\u308b\n      set_fact:\n        asg_desc: \"{{ auto_scaling_group_desc.stdout|from_json }}\"\n      register: result\n    - set_fact:\n        asg_min_size: \"{{ asg_desc.MinSize|int }}\"\n        asg_max_size: \"{{ asg_desc.MaxSize|int }}\"\n        asg_desired_capacity: \"{{ asg_desc.DesiredCapacity|int }}\"\n        asg_instances: \"{{ asg_desc.Instances }}\"\n\n    - name: terminate\u3055\u305b\u308b\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u5b89\u5168\u306b\u843d\u3068\u3059\u305f\u3081\u306e\u8a2d\u5b9a\u3092\u3059\u308b\n      shell: |\n        aws autoscaling put-lifecycle-hook \\\n          --lifecycle-hook-name {{ auto_scaling_group_name }}-terminate \\\n          --auto-scaling-group-name {{ auto_scaling_group_name }} \\\n          --lifecycle-transition autoscaling:EC2_INSTANCE_TERMINATING \\\n          --notification-target-arn {{ lifecycle_notify }} \\\n          --role-arn {{ lifecycle_role }} \\\n          --heartbeat-timeout {{ heartbeat_timeout }}\n\n    - name: auto-scaling-group\u306e\u8a2d\u5b9a\u3092UPDATE\u3059\u308b\n      ec2_asg:\n        name: \"{{ auto_scaling_group_name }}\"\n        health_check_period: 300\n        load_balancers: [ \"{{ ec2.associate_elb }}\" ]\n        health_check_type: ELB\n        availability_zones: [ \"{{ ec2.availability_zone_1a }}\", \"{{ ec2.availability_zone_1c }}\" ]\n        launch_config_name: \"{{ launch_config_name }}\"\n        min_size: \"{{ asg_min_size }}\"\n        max_size: \"{{ asg_max_size|int * 2 }}\"\n        desired_capacity: \"{{ asg_desired_capacity|int * 2 }}\"\n        region: \"{{ ec2.region }}\"\n        vpc_zone_identifier: [ \"{{ ec2.vpc_subnet_id_1a }}\", \"{{ ec2.vpc_subnet_id_1c }}\" ]\n        state: present\n\n    - name: termination-policies\u3092\u5909\u66f4\u3059\u308b\uff08\u53e4\u3044\u3082\u306e\u304b\u3089\u843d\u3068\u3055\u308c\u308b\u3088\u3046\u306b\uff09\n      shell: |\n        aws autoscaling update-auto-scaling-group \\\n          --auto-scaling-group-name {{ auto_scaling_group_name }} \\\n          --termination-policies \\\"OldestInstance\\\" \\\"OldestLaunchConfiguration\\\"\n\n    - name: \u3059\u3079\u3066\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u304c\u5165\u308c\u66ff\u308f\u308b\u307e\u3067\u5f85\u3064\n      shell: |\n        aws elb describe-instance-health \\\n          --load-balancer-name {{ ec2.associate_elb }} \\\n        | jq 'map(.[]|select(.State == \\\"InService\\\"))|length'\n      register: res_elb\n      until: res_elb.stdout|int >= (asg_desired_capacity|int * 2)\n      retries: 300\n      delay: 5\n\n    - name: \u65b0\u3057\u3044LaunchConfiguration\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u53f0\u6570\u3092\u53d6\u5f97\u3059\u308b\n      shell: |\n        aws autoscaling describe-auto-scaling-groups \\\n          --auto-scaling-group-names {{ auto_scaling_group_name }} \\\n        | jq .AutoScalingGroups[].Instances \\\n        | jq 'map(select(.LaunchConfigurationName == \\\"{{ launch_config_name }}\\\"))|length'\n      register: new_instance_count\n\n    - name: \u3059\u3079\u3066\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u304c\u5165\u308c\u66ff\u308f\u3063\u305f\u304b\u78ba\u8a8d\u3059\u308b\uff08\u3046\u307e\u304f\u3044\u3063\u3066\u3044\u306a\u3051\u308c\u3070\u51e6\u7406\u3092\u6b62\u3081\u308b\uff09\n      action: exit 1\n      when: res_elb.attempts >= 300 or asg_desired_capacity|int > new_instance_count.stdout|int\n\n    - name: \u53e4\u3044\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092terminate\u3059\u308b\n      shell: |\n        aws autoscaling terminate-instance-in-auto-scaling-group \\\n          --instance-id {{ item.InstanceId }} \\\n          --should-decrement-desired-capacity\n      when: \"{{ item.LifecycleState == 'InService' }}\"\n      with_items: \"{{ asg_instances }}\"\n\n    - name: AutoScaling\u306e\u8a2d\u5b9a\u3092\u5143\u306b\u623b\u3059\n      shell: |\n        aws autoscaling update-auto-scaling-group \\\n          --auto-scaling-group-name {{ auto_scaling_group_name }} \\\n          --max-size {{ asg_max_size }}\n\n```\n\n\uff3f\u4eba\u4eba\u4eba\u4eba\u4eba\u4eba\u4eba\u4eba\u4eba\u4eba\uff3f\n\uff1e\u3000\u307b\u307cshell...orz\u3000\uff1c\n\uffe3\uff39\uff39\uff39\uff39\uff39\uff39\uff39\uff39\uff39\uff39\uffe3\n\n\u3059\u307f\u307e\u305b\u3093\u307b\u307cshell\u3067\u3059\u306d...\n\u7c97\u96d1\u3067\u3059\u304c\u3042\u308b\u7a0b\u5ea6\u52d5\u3044\u3066\u3044\u308b\u306e\u3067\u52d8\u5f01\u3057\u3066\u304f\u3060\u3055\u3044\n\uff08\u5b9f\u969b\u306b\u52d5\u304b\u3057\u305f\u3082\u306e\u3068\u306f\u9055\u3044\u307e\u3059\u304c\u3001\u52d5\u304f\u306f\u305a...\uff01\uff09\n\n# \u3044\u3056\u5b9f\u884c\u3057\u3066\u307f\u308b\n\n```bash:\u5b9f\u884c\u30b3\u30de\u30f3\u30c9\n# instance_id\u3092\u6e21\u3059\u3060\u3051\nansible-playbook blue-green-deploy.yml --extra-vars=\"ec2_instance_id=i-hogehoge\"\n```\n\n# \u89e3\u8aac\n\n## \u30c7\u30d7\u30ed\u30a4\u6642\u306e\u6d41\u308c\u3092\u8a73\u3057\u304f\u8aac\u660e\u3057\u307e\u3059\n\n#### 1\uff09\u73fe\u5728\u306eAutoscaling\u306e\u8a2d\u5b9a\u3092\u53d6\u3063\u3066\u304f\u308b\n#### 2\uff09\u73fe\u5728\u306eAutoscaling\u306e\u30b5\u30fc\u30d0\u30b9\u30b1\u30fc\u30eb\uff08desired\uff09\u3068\u73fe\u5728SeviceIn\u3057\u3066\u3044\u308b\u30b5\u30fc\u30d0\u306eInstanceId\u3092\u30e1\u30e2\u3057\u3066\u304a\u304f\n#### 3\uff09Autoscaling\u306e\u8a2d\u5b9a\u3092\u5909\u66f4\u3059\u308b\n\n```\n\u5909\u66f4\u5185\u5bb9\uff1a\n\u3000\u30fblaunch_config\u3092\u65b0\u3057\u3044\u30d0\u30fc\u30b8\u30e7\u30f3\u306e\u3082\u306e\u306b\u3059\u308b\uff08\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u8d77\u52d5\u8a2d\u5b9a\u3092\u6700\u65b0\u7248\u306e\u3082\u306e\u306b\u3059\u308b\uff09\n\u3000\u30fbdesired\u3092\u73fe\u5728\u306e\u3061\u3087\u3046\u30692\u500d\u306e\u5024\u306b\u3059\u308b\u3002min\u3068max\u306f\u5909\u66f4\u3057\u306a\u3044\n```\n\n#### 4\uff09\u53e4\u3044\u30d0\u30fc\u30b8\u30e7\u30f3\u306e\u3082\u306e\u3068\u65b0\u3057\u3044\u30d0\u30fc\u30b8\u30e7\u30f3\u306e\u3082\u306e\u304c\u3059\u3079\u3066ELB\u304b\u3089\u898b\u3066\u30b5\u30fc\u30d3\u30b9\u30a4\u30f3\u3057\u3066\u3044\u308b\u72b6\u614b\u306b\u306a\u308b\u307e\u3067\u5f85\u3064\n\n```yaml:ELB\u306b\u306e\u30d8\u30eb\u30b9\u30c1\u30a7\u30c3\u30af\u304c\u901a\u3063\u3066\u5b89\u5168\u306a\u72b6\u614b\u306b\u306a\u308b\u307e\u3067\u5f85\u3064\n- name: \u3059\u3079\u3066\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u304c\u5165\u308c\u66ff\u308f\u308b\u307e\u3067\u5f85\u3064\n  shell: |\n    aws elb describe-instance-health \\\n      --load-balancer-name {{ ec2.associate_elb }} \\\n    | jq 'map(.[]|select(.State == \\\"InService\\\"))|length'\n  register: res_elb\n  until: res_elb.stdout|int >= (asg_desired_capacity|int * 2)\n  retries: 300\n  delay: 5\n```\n\naws cli\u3092\u5229\u7528\u3057\u3066elb\u306bInService\u3068\u306a\u3063\u3066\u3044\u308b\u30b5\u30fc\u30d0\u304c\u53d6\u5f97\u3057\u305f\u73fe\u5728\u306edesired capacity\u306e\u500d\u306e\u6570\u306b\u306a\u308b\u307e\u3067\u30ea\u30af\u30a8\u30b9\u30c85\u79d2\u304a\u304d\u306b300\u56de\u307e\u3067\u7e70\u308a\u8fd4\u3057\u307e\u3059\n\n#### 5\uff09\u5ff5\u306e\u305f\u3081\u30b5\u30fc\u30d3\u30b9\u30a4\u30f3\u3057\u3066\u3044\u308b\u30b5\u30fc\u30d0\u306e\u3046\u3061\u3001\u65b0\u3057\u3044\u30d0\u30fc\u30b8\u30e7\u30f3\u306e\u3082\u306e\u304c\u3044\u304f\u3064\u3042\u308b\u304b\u78ba\u8a8d\u3059\u308b\u305f\u3081\u306b\u60c5\u5831\u3092\u53d6\u3063\u3066\u304f\u308b\n\n```yaml:\u65b0\u3057\u3044\u30d0\u30fc\u30b8\u30e7\u30f3\u306e\u30b5\u30fc\u30d0\u53f0\u6570\u53d6\u5f97\n- name: \u65b0\u3057\u3044LaunchConfiguration\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u53f0\u6570\u3092\u53d6\u5f97\u3059\u308b\n  shell: |\n    aws autoscaling describe-auto-scaling-groups \\\n      --auto-scaling-group-names {{ auto_scaling_group_name }} \\\n    | jq .AutoScalingGroups[].Instances \\\n    | jq 'map(select(.LaunchConfigurationName == \\\"{{ launch_config_name }}\\\"))|length'\n  register: new_instance_count\n```\n\n6 - \u5b89\u5168\u306b\u30c7\u30d7\u30ed\u30a4\u3067\u304d\u3066\u3044\u308b\u304b\u306e\u78ba\u8a8d\uff08\u3067\u304d\u3066\u3044\u306a\u3044\u5834\u5408\u306f\u51e6\u7406\u3092\u4e2d\u65ad\uff09\n\n```yaml:\u5b89\u5168\u306b\u30c7\u30d7\u30ed\u30a4\u304c\u3067\u304d\u305f\u304b\u78ba\u8a8d\n- name: \u3059\u3079\u3066\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u304c\u5165\u308c\u66ff\u308f\u3063\u305f\u304b\u78ba\u8a8d\u3059\u308b\uff08\u3046\u307e\u304f\u3044\u3063\u3066\u3044\u306a\u3051\u308c\u3070\u51e6\u7406\u3092\u6b62\u3081\u308b\uff09\n  action: exit 1\n  when: res_elb.attempts >= 300 or asg_desired_capacity|int > new_instance_count.stdout|int\n```\n\n => \u4e0b\u8a182\u70b9\u306e\u5834\u5408\u306f\u51e6\u7406\u3092\u4e2d\u65ad\u3055\u305b\u308b\u3002\uff08\u30c0\u30a6\u30f3\u30bf\u30a4\u30e0\u3092\u4f5c\u3089\u306a\u3044\u3088\u3046\u306b\u3059\u308b\u305f\u3081\uff09\n \u3000\u30fbELB\u306b\u30b5\u30fc\u30d3\u30b9\u30a4\u30f3\u3057\u3066\u3044\u308b\u30b5\u30fc\u30d0\u306e\u53f0\u6570\u3092\u78ba\u8a8d\u3059\u308b\u51e6\u7406\u304c\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u3057\u3066\u3044\u305f\u5834\u5408\n \u3000\u30fb\u65b0\u3057\u3044\u30d0\u30fc\u30b8\u30e7\u30f3\u306e\u30b5\u30fc\u30d0\u53f0\u6570\u53d6\u5f97\u304c\u5143\u306e\u30b5\u30fc\u30d0\u53f0\u6570\u3088\u308a\u5c11\u306a\u3044\u5834\u5408\n\n7 - 6\u3067\u3061\u3083\u3093\u3068\u78ba\u8a8d\u304c\u3067\u304d\u305f\u3089\u30012\u3067\u30e1\u30e2\u3057\u3066\u304a\u3044\u305fInstanceId\u3092terminating\u306e\u72b6\u614b\u306b\u79fb\u3059\n\n```yaml:\u53e4\u3044\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092terminate\u3059\u308b\n- name: \u53e4\u3044\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092terminate\u3059\u308b\n  shell: |\n    aws autoscaling terminate-instance-in-auto-scaling-group \\\n      --instance-id {{ item.InstanceId }} \\\n      --should-decrement-desired-capacity\n  when: \"{{ item.LifecycleState == 'InService' }}\"\n  with_items: \"{{ asg_instances }}\"\n```\n\n8 - \u30c7\u30d7\u30ed\u30a4\u5b8c\u4e86\u3067\u3059\n\n\n## \u53e4\u3044\u30d0\u30fc\u30b8\u30e7\u30f3\u306e\u3082\u306e\u306f\u3059\u3050\u306bterminate\u3055\u308c\u306a\u3044\u3088\u3046\u306b\u3057\u3066\u3044\u308b\n\nlifecyclehook\u306eterminating:wait\u306e\u8a2d\u5b9a\u3060\u3051\u3057\u3068\u3044\u3066\u3042\u3052\u308c\u3070\u3001\u3068\u308a\u3042\u3048\u305a\u5b9f\u969b\u306bterminate\u3055\u308c\u308b\u307e\u3067\u7336\u4e88\u3092\u4e0e\u3048\u308b\u3053\u3068\u304c\u3067\u304d\u308b\u3002\uff08\u305d\u306e\u6642\u9593\u3067fluentd\u7b49\u304c\u30ed\u30b0\u3092\u3059\u3079\u3066\u9001\u308a\u5207\u308b\u3088\u3046\u306b\u3059\u308b\uff09\n\n```bash:lifecyclehook\u767b\u9332\naws autoscaling put-lifecycle-hook \\\n  --lifecycle-hook-name {{ auto_scaling_group_name }}-terminate \\\n  --auto-scaling-group-name {{ auto_scaling_group_name }} \\\n  --lifecycle-transition autoscaling:EC2_INSTANCE_TERMINATING \\\n  --notification-target-arn {{ lifecycle_notify }} \\\n  --role-arn {{ lifecycle_role }} \\\n  --heartbeat-timeout {{ heartbeat_timeout }}\n```\n\n## Ansible\u306eec2_asg:replace_instances\u306b\u3064\u3044\u3066\n\nAnsible\u306eautoscaling\u30e2\u30b8\u30e5\u30fc\u30eb\u306b\u30c7\u30d7\u30ed\u30a4\u6642\u306b\u30ed\u30fc\u30ea\u30f3\u30b0\u30a2\u30c3\u30d7\u30c7\u30fc\u30c8\u3067\u81ea\u52d5\u3067\u3086\u3063\u304f\u308a\u30b5\u30fc\u30d0\u3092\u5207\u308a\u66ff\u3048\u3066\u304f\u308c\u308b\u3082\u306e\u304c\u3042\u308a\u307e\u3059\u3002\n\n```yaml\nec2_asg:\n  replace_instances: yes\n```\n\n\u3057\u304b\u3057\u3053\u308c\u3060\u3068\u9045\u3044&terminateing:wait\u3068\u306e\u76f8\u6027\u304c\u826f\u304f\u3042\u308a\u307e\u305b\u3093\n\nterminateing:wait\u306e\u72b6\u614b\u3092\u5f85\u3063\u3066\u3057\u307e\u3046\n\uff08\u4f8b\uff1aterminating:wait\u304c5\u5206\u306e\u5834\u5408\u4e00\u3064instance\u3092terminating\u3057\u3066\u3044\u3066\u3001\u6b21\u306einstance\u3092terminate\u3059\u308b\u306e\u306f5\u5206\u5f8c\u3002\u305d\u306e\u9593\u53e4\u3044\u30d0\u30fc\u30b8\u30e7\u30f3\u306e\u3082\u306e\u304cELB\u306b\u3076\u3089\u4e0b\u304c\u308a\u7d9a\u3051\u3066\u3057\u307e\u3046\u3002\uff09\n\n# \u30c6\u30b9\u30c8\n\n\u7c21\u6613\u306a\u30c6\u30b9\u30c8\u3067\u3059\u304c\u3001\u4e0b\u8a18\u30b9\u30af\u30ea\u30d7\u30c8\u3067\u672c\u5f53\u306b\u30c0\u30a6\u30f3\u30bf\u30a4\u30e0\u304c0\u304b\u78ba\u8a8d\u3057\u307e\u3057\u305f\u3002\n\n```bash:\u30c6\u30b9\u30c8\u30b9\u30af\u30ea\u30d7\u30c8\nwatch -n 1 \"curl -s https://sample.io/http_status -o /dev/null -w '%{http_code}\\n'\"\n```\n\nELB\u306b\u6b63\u5e38\u306b\u30b5\u30fc\u30d0\u304c\u3076\u3089\u4e0b\u304c\u3063\u3066\u3044\u306a\u3044\u3068503\u304c\u767a\u751f\u3057\u307e\u3059\u3002\nreplace_instances\u3092\u4f7f\u3046\u3068\u82e5\u5e72503\u304c\u767a\u751f\u3057\u3066\u3057\u307e\u3044\u307e\u3057\u305f\u304c\u3001\u4e0a\u8a18\u306eplaybook\u306a\u3089\u3059\u3079\u3066200\u3092\u78ba\u8a8d\u3067\u304d\u307e\u3057\u305f\u3002\n", "tags": ["Ansible", "AWS", "aws-cli", "blue_green_deployment", "AutoScaling"]}