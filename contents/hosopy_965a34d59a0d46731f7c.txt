{"context": " More than 1 year has passed since last update.\n\nAbout\n\u5c11\u3057\u524d\u306b\u3001\u793e\u5185\u306eGitLab\u30925.3\u304b\u30897.13\u306b\u30a2\u30c3\u30d7\u30b0\u30ec\u30fc\u30c9\u3057\u305f\u306e\u3067\u3001\u305d\u306e\u969b\u306e\u4f5c\u696d\u30ed\u30b0\u3092\u6b8b\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\u4eca\u5f8c\u3001\u540c\u3058\u3088\u3046\u306a\u4f5c\u696d(\u3068\u3044\u3046\u304b\u82e6\u884c)\u3092\u3059\u308b\u4eba\u306e\u304a\u5f79\u306b\u7acb\u3066\u308c\u3070\u3002\u3002\n\u306a\u304a\u3001\u4f5c\u696d\u6642\u70b9\u3067\u306e\u6700\u65b0\u7248\u306f7.13\u3067\u3057\u305f\u304c\u3001\u73fe\u5728\u306f8.X\u3067\u3059\u3002\u4eca\u5f8c\u4f5c\u696d\u3059\u308b\u5834\u5408\u306f\u3001\u9069\u5b9c\u8aad\u307f\u66ff\u3048\u3066\u4e0b\u3055\u3044\u3002\n\n\u30a2\u30c3\u30d7\u30b0\u30ec\u30fc\u30c9\u524d\u306e\u72b6\u6cc1\n\n3.X\u306e\u6642\u4ee3\u304b\u3089\u4f55\u5ea6\u304b\u30a2\u30c3\u30d7\u30b0\u30ec\u30fc\u30c9\u3057\u306a\u304c\u3089\u5229\u7528\u3057\u3066\u3044\u3066\u3001\u73fe\u5728\u306f5.3\u3067\u904b\u7528\u4e2d\nOS\u306fUbuntu\n\n\n\u30a2\u30c3\u30d7\u30b0\u30ec\u30fc\u30c9\u8a08\u753b\n\u65b0\u74b0\u5883\u306fOmnibus\u7248\u3067\u904b\u7528\u3057\u305f\u304b\u3063\u305f\u305f\u3081\u3001\u30a2\u30c3\u30d7\u30b0\u30ec\u30fc\u30c9\u8a08\u753b\u3092\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u7acb\u3066\u307e\u3057\u305f\u3002\n\n\u65b0\u898f\u30b5\u30fc\u30d0\u306bGitLab 7.13\u3092\u65b0\u74b0\u5883\u3068\u3057\u3066\u69cb\u7bc9\u3057\u3001\u73fe\u74b0\u5883\u306e\u30c7\u30fc\u30bf\u3092\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u3057\u3066\u30a4\u30f3\u30dd\u30fc\u30c8\u3059\u308b\u3002\n\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u306f\u3001\u65b0\u898f\u30b5\u30fc\u30d0\u306b\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u5c02\u7528\u306e\u74b0\u5883\u3092\u7528\u610f\u3057\u3001\u516c\u5f0f\u30ac\u30a4\u30c9\u306b\u5f93\u3063\u3066\u4e0b\u8a183\u30b9\u30c6\u30c3\u30d7\u3067\u884c\u3046\u3002\n\n\nMySQL\u304b\u3089PostgreSQL\u306b\u30b3\u30f3\u30d0\u30fc\u30c8\n\n\n\u6700\u65b0GitLab\u3067\u306f\u3001MySQL\u306e\u30b5\u30dd\u30fc\u30c8\u304cPro\u7248\u306e\u307forz\n\n\n 5.3 -> 5.4\n\n 5.4 -> 6.0\n\n From 6.x or 7.x to 7.13\n\n\n\n\u6700\u5f8c\u306bDNS\u3092\u65b0\u74b0\u5883\u306b\u5207\u308a\u66ff\u3048\u3066\u79fb\u884c\u3092\u884c\u3046\n\n\u3053\u306e\u6d41\u308c\u3092\u53ef\u8996\u5316\u3059\u308b\u3068\u3001\u6b21\u306e\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\n\n\n\u4f5c\u696d\u30ed\u30b0\n\n1. \u65b0\u74b0\u5883\u306e\u69cb\u7bc9\n\u65b0\u898f\u30b5\u30fc\u30d0\u306bUbuntu 14.04 LTS\u3092\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u3057\u3001\u516c\u5f0f\u30ac\u30a4\u30c9\u306b\u5f93\u3063\u3066GitLab\u306eOmnibus\u7248\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u3002\n\n@\u65b0\u74b0\u5883\n$ sudo apt-get install curl openssh-server ca-certificates\n$ curl https://packages.gitlab.com/install/repositories/gitlab/gitlab-ce/script.deb.sh | sudo bash\n$ sudo apt-get install gitlab-ce\n$ sudo gitlab-ctl reconfigure\n\n\n\n2. \u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u74b0\u5883\u306e\u69cb\u7bc9\n\u65b0\u898f\u30b5\u30fc\u30d0\u306bUbuntu 14.04 LTS\u3092\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u3057\u3001\u516c\u5f0f\u30ac\u30a4\u30c9\u306b\u5f93\u3063\u3066GitLab 5.3\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u3002\n\u4f9d\u5b58\u30d1\u30c3\u30b1\u30fc\u30b8\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u3002\n\n@\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u74b0\u5883\n# Install dependencies\n$ sudo apt-get install -y build-essential zlib1g-dev libyaml-dev libssl-dev libgdbm-dev libreadline-dev libncurses5-dev libffi-dev curl git-core openssh-server redis-server checkinstall libxml2-dev libxslt-dev libcurl4-openssl-dev libicu-dev\n$ sudo apt-get install python\n$ python --version\n\n\n\u6b21\u306bRuby\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u3002\n\n@\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u74b0\u5883\n# Ruby\n$ sudo apt-get remove ruby1.8\n$ mkdir /tmp/ruby && cd /tmp/ruby\n$ curl --progress http://ftp.ruby-lang.org/pub/ruby/1.9/ruby-1.9.3-p392.tar.gz | tar xz\n$ cd ruby-1.9.3-p392\n$ ./configure\n$ make\n$ sudo make install\n$ sudo gem install bundler\n\n\n\u6b21\u306bgitlab-shell\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u3002gitlab_url\u306eURL\u306f\u5404\u81ea\u306e\u74b0\u5883\u3067\u8aad\u307f\u66ff\u3048\u3066\u4e0b\u3055\u3044\u3002\n\n@\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u74b0\u5883\n# Install gitlab-shell\n$ sudo adduser --disabled-login --gecos 'GitLab' git\n$ sudo su git\n$ cd /home/git\n$ git clone https://github.com/gitlabhq/gitlab-shell.git\n$ cd gitlab-shell\n$ git checkout v1.4.0\n$ cp config.yml.example config.yml\n\n$ vim config.yml\n# gitlab_url\u3092\u7de8\u96c6\n# gitlab_url: \"http://git-migration.example.com/\"\n\n$ ./bin/install\n\n\n\u6b21\u306bMySQL\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u3002\n\n@\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u74b0\u5883\n# MySQL\n$ sudo apt-get install -y mysql-server mysql-client libmysqlclient-dev\n$ mysql -u root -p # password=root\nmysql> CREATE USER 'gitlab'@'localhost' IDENTIFIED BY 'gitlab';\nmysql> CREATE DATABASE IF NOT EXISTS `gitlabhq_production` DEFAULT CHARACTER SET `utf8` COLLATE `utf8_unicode_ci`;\nmysql> GRANT SELECT, LOCK TABLES, INSERT, UPDATE, DELETE, CREATE, DROP, INDEX, ALTER ON `gitlabhq_production`.* TO 'gitlab'@'localhost';\nmysql> \\q\n\n# Check connectivity\n$ sudo -u git -H mysql -u gitlab -p -D gitlabhq_production\n\n\n\u6b21\u306bGitLab\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u3002\n\n@\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u74b0\u5883\n# GitLab\n$ cd /home/git\n$ sudo -u git -H git clone https://github.com/gitlabhq/gitlabhq.git gitlab\n$ cd /home/git/gitlab\n$ sudo -u git -H git checkout 5-3-stable\n\n$ cd /home/git/gitlab\n$ sudo -u git -H cp config/gitlab.yml.example config/gitlab.yml\n$ sudo -u git -H vim config/gitlab.yml\n# host\u3092\u7de8\u96c6\n# host: git-migration.example.com\n\n$ sudo chown -R git log/\n$ sudo chown -R git tmp/\n$ sudo chmod -R u+rwX  log/\n$ sudo chmod -R u+rwX  tmp/\n\n$ sudo -u git -H mkdir /home/git/gitlab-satellites\n$ sudo -u git -H mkdir tmp/pids/\n$ sudo -u git -H mkdir tmp/sockets/\n$ sudo chmod -R u+rwX  tmp/pids/\n$ sudo chmod -R u+rwX  tmp/sockets/\n\n$ sudo -u git -H mkdir public/uploads\n$ sudo chmod -R u+rwX  public/uploads\n$ sudo -u git -H cp config/puma.rb.example config/puma.rb\n$ sudo -u git -H git config --global user.name \"GitLab\"\n$ sudo -u git -H git config --global user.email \"gitlab@localhost\"\n\n$ sudo -u git cp config/database.yml.mysql config/database.yml\n\n\n\u6b21\u306bgem\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u3002\n\n@\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u74b0\u5883\n$ cd /home/git/gitlab\n$ sudo gem install charlock_holmes --version '0.6.9.4'\n$ sudo -u git -H bundle install --deployment --without development test postgres\n\n\n\u3053\u3053\u30671\u3064\u76ee\u306e\u5730\u96f7\u3092\u8e0f\u3080\u3002Could not find modernizr-2.6.2 in any of the sources\u3068\u306a\u308a\u3001gem\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u304c\u7d42\u308f\u3089\u306a\u3044\u3002\nhttp://anton0825.hatenablog.com/entry/20140523/1408932429\n\u4e0a\u8a18\u8a18\u4e8b\u3092\u53c2\u8003\u306b\u3001Gemfile\u3068Gemfile.lock\u306emodernizr 2.6.2\u3092modernizr-rails 2.7.1\u306b\u4fee\u6b63\u3057\u3066\u518d\u30c8\u30e9\u30a4\u3002\n\n@\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u74b0\u5883\n$ sudo vim Gemfile\n  #gem \"modernizr\",        \"2.6.2\"\n  gem \"modernizr-rails\",   \"2.7.1\"\n$ sudo vim Gemfile.log\n  modernizr-rails (2.7.1)\n  modernizr-rails (= 2.7.1)\n$ sudo -u git -H bundle install --deployment --without development test postgres\n\n\n\u3068\u308a\u3042\u3048\u305a\u901a\u3063\u305f\u306e\u3067\u3001GitLab\u306e\u8a2d\u5b9a\u4f5c\u696d\u3092\u9032\u3081\u308b\u3002\n\n@\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u74b0\u5883\n$ sudo -u git -H bundle exec rake gitlab:setup RAILS_ENV=production\n\n$ sudo cp lib/support/init.d/gitlab /etc/init.d/gitlab\n$ sudo chmod +x /etc/init.d/gitlab\n$ sudo update-rc.d gitlab defaults 21\n\n$ sudo -u git -H bundle exec rake gitlab:env:info RAILS_ENV=production\n$ sudo service gitlab start\n$ sudo -u git -H bundle exec rake gitlab:check RAILS_ENV=production\n# \u4f55\u6545\u304bsidekiq\u304c\u8d77\u52d5\u3057\u3066\u3044\u306a\u3044\u3068\u6012\u3089\u308c\u305f\u306e\u3067sidekiq:start\u3057\u3066\u304a\u304f\n$ sudo -u git -H bundle exec rake sidekiq:start RAILS_ENV=production\n$ sudo -u git -H bundle exec rake gitlab:check RAILS_ENV=production\n\n\n\u6700\u5f8c\u306bNginx\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u3002\n\n@\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u74b0\u5883\n# nginx\n$ sudo apt-get install nginx\n$ sudo cp lib/support/nginx/gitlab /etc/nginx/sites-available/gitlab\n$ sudo ln -s /etc/nginx/sites-available/gitlab /etc/nginx/sites-enabled/gitlab\n$ sudo vim /etc/nginx/sites-available/gitlab\n# listen <IP\u30a2\u30c9\u30ec\u30b9>:80 default_server;\n# server_name localhost;\n$ sudo service nginx restart\n\n\n\n3. \u73fe\u74b0\u5883\u306e\u30c7\u30fc\u30bf\u3092\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u74b0\u5883\u306b\u30a4\u30f3\u30dd\u30fc\u30c8\n\u307e\u305a\u3001\u73fe\u74b0\u5883\u306e\u30c7\u30fc\u30bf\u3092\u30c0\u30f3\u30d7\u3059\u308b\u3002\n\n@\u73fe\u74b0\u5883\n# MySQL\u306e\u30c0\u30f3\u30d7\n$ mysqldump -u gitlab -p --default-character-set=utf8 gitlabhq_production > gitlabhq_production.sql\n# \u30ea\u30dd\u30b8\u30c8\u30ea\u306e\u30a2\u30fc\u30ab\u30a4\u30d6\n$ sudo zip -r /home/git/repositories_migration.zip /home/git/repositories\n\n\ngitlabhq_production.sql\u3068repositories_migration.zip\u306f\u3001\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u74b0\u5883\u306e/home/hoge\u914d\u4e0b\u306b\u8ee2\u9001\u3057\u3066\u304a\u304f\u3002\n\u6b21\u306b\u3001\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u74b0\u5883\u3067\u30c7\u30fc\u30bf\u3092\u30a4\u30f3\u30dd\u30fc\u30c8\u3059\u308b\u3002\n\n@\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u74b0\u5883\n# MySQL\u306e\u30a4\u30f3\u30dd\u30fc\u30c8\n$ mysql -u gitlab -p gitlabhq_production < /home/hoge/gitlabhq_production.sql\n# \u30ea\u30dd\u30b8\u30c8\u30ea\u306e\u5c55\u958b\n$ unzip /home/hoge/repositories_migration.zip\n$ sudo rm -rf /home/git/repositories\n$ sudo mv /home/hoge/home/git/repositories /home/git/\n$ sudo chown -R git:git /home/git/repositories\n$ sudo chmod -R 2775 /home/git/repositories\n\n\n\n4. \u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u74b0\u5883\u306eDB\u3092PostgreSQL\u306b\u30b3\u30f3\u30d0\u30fc\u30c8\nPostgreSQL\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u3002\nhttps://github.com/gitlabhq/gitlabhq/blob/5-3-stable/doc/install/databases.md\n\n@\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u74b0\u5883\n$ sudo apt-get install -y postgresql libpq-dev\n$ sudo -u postgres psql -d template1\ntemplate1=# CREATE USER git WITH PASSWORD 'git';\ntemplate1=# CREATE DATABASE gitlabhq_production OWNER git;\ntemplate1=# \\q\n$ sudo -u git -H psql -d gitlabhq_production\n\n\nMySQL\u306e\u30c7\u30fc\u30bf\u3092PostgreSQL\u306b\u30b3\u30f3\u30d0\u30fc\u30c8\u3059\u308b\u3002\nhttps://github.com/gitlabhq/mysql-postgresql-converter\n\n@\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u74b0\u5883\n$ cd\n$ mysqldump --compatible=postgresql --default-character-set=utf8 -r databasename.mysql -u gitlab gitlabhq_production -p\n$ git clone https://github.com/gitlabhq/mysql-postgresql-converter.git\n$ cp mysql-postgresql-converter/db_converter.py ./\n$ cp mysql-postgresql-converter/move_drop_indexes.ed ./\n$ python db_converter.py databasename.mysql databasename.psql\n$ ed -s databasename.psql < move_drop_indexes.ed\n$ sudo -u git -H psql -f databasename.psql -d gitlabhq_production\n\n\nGitLab\u3092PostgreSQL\u5411\u3051\u306b\u8a2d\u5b9a\u3059\u308b\u3002\n\n@\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u74b0\u5883\n$ cd /home/git/gitlab\n$ sudo -u git -H cp config/database.yml.postgresql config/database.yml\n$ sudo -u git -H vim config/database.yml\n\n$ sudo vim .bundle/config\n# without\u304b\u3089postgres\u3092\u6d88\u3059\n\n$ sudo -u git -H bundle install --deployment --without development test mysql\n$ sudo /etc/init.d/gitlab restart\n\n\n\u4ee5\u4e0a\u3067PostgreSQL\u5316\u306f\u5b8c\u4e86\u3002\n\n5. 5.3\u304b\u30895.4\u3078\u306e\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\n\u516c\u5f0f\u30ac\u30a4\u30c9\u306b\u5f93\u3063\u3066\u4f5c\u696d\u3059\u308b\u3002\n\n@\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u74b0\u5883\n$ sudo service gitlab stop\n$ cd /home/git/gitlab\n$ sudo -u git -H git checkout Gemfile Gemfile.lock\n$ sudo -u git -H git fetch\n$ sudo -u git -H git checkout 5-4-stable\n\n$ cd /home/git/gitlab-shell\n$ sudo -u git -H git fetch\n$ sudo -u git -H git checkout v1.7.9\n\n$ cd /home/git/gitlab\n\n# \u4f8b\u306b\u3088\u3063\u3066modernizr\u95a2\u9023\u3067\u6012\u3089\u308c\u308b\u306e\u3067...\n$ sudo vim Gemfile\n  #gem \"modernizr\",        \"2.6.2\"\n  gem \"modernizr-rails\",   \"2.7.1\"\n$ sudo vim Gemfile.log\n  modernizr-rails (2.7.1)\n  modernizr-rails (= 2.7.1)\n\n$ sudo -u git -H bundle install --without development test mysql --deployment\n$ sudo -u git -H bundle exec rake db:migrate RAILS_ENV=production\n$ sudo -u git -H bundle exec rake assets:precompile RAILS_ENV=production\n\n\n\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092\u65b0\u30d0\u30fc\u30b8\u30e7\u30f3\u306e\u4ed5\u69d8\u306b\u5408\u3046\u3088\u3046\u306b\u7de8\u96c6\u3057\u307e\u3059\u304c\u3001\u81ea\u5206\u306e\u74b0\u5883\u3067\u306f\u7279\u306b\u5909\u66f4\u306f\u5fc5\u8981\u3042\u308a\u307e\u305b\u3093\u3067\u3057\u305f\u3002\n\nMake /home/git/gitlab/config/gitlab.yml same as https://gitlab.com/gitlab-org/gitlab-ce/blob/5-4-stable/config/gitlab.yml.example but with your settings.\nMake /home/git/gitlab/config/puma.rb same as https://gitlab.com/gitlab-org/gitlab-ce/blob/5-4-stable/config/puma.rb.example but with your settings.\n\n\u8d77\u52d5\u30b9\u30af\u30ea\u30d7\u30c8\u306e\u8a2d\u7f6e\u3068\u3001\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u306e\u6700\u7d42\u30c1\u30a7\u30c3\u30af\u3092\u884c\u3046\u3002\n\n@\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u74b0\u5883\n$ sudo rm /etc/init.d/gitlab\n$ sudo curl -L --output /etc/init.d/gitlab https://raw.github.com/gitlabhq/gitlabhq/5-4-stable/lib/support/init.d/gitlab\n$ sudo chmod +x /etc/init.d/gitlab\n\n$ sudo service gitlab start\n$ sudo service nginx restart\n\n$ sudo -u git -H bundle exec rake gitlab:env:info RAILS_ENV=production\n$ sudo -u git -H bundle exec rake gitlab:check RAILS_ENV=production\n\n\ngitlab:check\u306b\u6012\u3089\u308c\u305f\u306e\u3067\u3001\u6307\u793a\u306b\u5f93\u3063\u3066\u4f5c\u696d\u3057\u3066\u518d\u30c1\u30a7\u30c3\u30af\u3059\u308b\u3002\n\n@\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u74b0\u5883\n$ sudo chmod -R ug+rwX,o-rwx /home/git/repositories/\n$ sudo chmod -R ug-s /home/git/repositories/\n$ find /home/git/repositories/ -type d -print0 | sudo xargs -0 chmod g+s\n$ sudo -u git -H bundle exec rake gitlab:satellites:create RAILS_ENV=production\n\n$ sudo -u git -H bundle exec rake gitlab:check RAILS_ENV=production\n\n\n\n6. 5.4\u304b\u30896.0\u3078\u306e\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\n\u516c\u5f0f\u30ac\u30a4\u30c9\u306b\u5f93\u3063\u3066\u4f5c\u696d\u3059\u308b\u3002\n\n@\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u74b0\u5883\n$ sudo service gitlab stop\n\n$ cd /home/git/gitlab\n$ sudo -u git -H git checkout Gemfile Gemfile.lock db/schema.rb\n$ sudo -u git -H git fetch\n$ sudo -u git -H git checkout 6-0-stable\n\n$ cd /home/git/gitlab-shell\n$ sudo -u git -H git fetch\n$ sudo -u git -H git checkout v1.7.9\n\n$ sudo apt-get install python-docutils\n\n$ cd /home/git/gitlab\n\n# \u4f8b\u306b\u3088\u3063\u3066modernizr\u95a2\u9023\u3067\u6012\u3089\u308c\u308b\u306e\u3067...\n$ sudo vim Gemfile\n  #gem \"modernizr\",        \"2.6.2\"\n  gem \"modernizr-rails\",   \"2.7.1\"\n$ sudo vim Gemfile.log\n  modernizr-rails (2.7.1)\n  modernizr-rails (= 2.7.1)\n\n$ sudo -u git -H bundle install --without development test mysql --deployment\n\n\nDB\u306e\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u4f5c\u696d\u3092\u958b\u59cb\u30026.0\u3067\u306fModel\u306b\u5927\u304d\u306a\u4fee\u6b63\u304c\u5165\u3063\u305f\u3068\u306e\u3053\u3068\u3067\u3001\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u306b\u306f\u8907\u6570\u306e\u30b9\u30c6\u30c3\u30d7\u304c\u5fc5\u8981\u306b\u306a\u308b\u3002\n\n@\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u74b0\u5883\n$ sudo -u git -H bundle exec rake db:migrate RAILS_ENV=production\n$ sudo -u git -H bundle exec rake migrate_groups RAILS_ENV=production\n$ sudo -u git -H bundle exec rake migrate_global_projects RAILS_ENV=production\n\n\nmigrate_global_projects\u30672\u56de\u76ee\u306e\u5730\u96f7\u3092\u8e0f\u3080\u3002\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u306e\u9032\u6357\u72b6\u6cc1\u306bF\u306e\u6587\u5b57\u304c\u8868\u793a\u3055\u308c\u3066\u3044\u308b\u306e\u3067\u3001\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u306b\u5931\u6557\u3057\u3066\u3044\u308b\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u304c\u3042\u308b\u6a21\u69d8\u3002\n\u30a8\u30e9\u30fc\u30ed\u30b0\u3068\u30c7\u30fc\u30bf\u3068\u30bd\u30fc\u30b9\u3092\u78ba\u8a8d\u3057\u305f\u3068\u3053\u308d\u3001\u5931\u6557\u306e\u539f\u56e0\u3092\u7a81\u304d\u6b62\u3081\u308b\u3002\n3.X\u6642\u4ee3\u304b\u3089\u904b\u7528\u3057\u3066\u3044\u305f\u305f\u3081\u3001\u8272\u3005\u3068\u602a\u3057\u3044\u30c7\u30fc\u30bf\u304c\u6b8b\u3063\u3066\u3044\u308b\u3088\u3046\u3060\u3002\u3002\n\n\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u540d\u306b\u7981\u6b62\u6587\u5b57/()\u304c\u4f7f\u308f\u308c\u3066\u3044\u308b\nowner\u4e0d\u5728\uff1f\u306eProject\u304c\u3042\u308a\u3001ProjectTransferService\u304c\u5931\u6557\u3059\u308b\n\n\u4ed5\u65b9\u306a\u3044\u306e\u3067\u3001lib/tasks/migrate/migrate_global_projects.rake\u3092\u4fee\u6b63\u3059\u308b\u3002\n\nlib/tasks/migrate/migrate_global_projects.rake\ndesc \"GITLAB | Migrate Global Projects to Namespaces\"\ntask migrate_global_projects: :environment do\n  found = Project.where(namespace_id: nil).count\n  if found > 0\n    puts \"Global namespace is deprecated. We found #{found} projects stored in global namespace\".yellow\n    puts \"You may abort this task and move them to group/user namespaces manually.\"\n    puts \"If you want us to move this projects under owner namespaces then continue\"\n    ask_to_continue\n  else\n    puts \"No global projects found. Proceed with update.\".green\n  end\n\n  Project.where(namespace_id: nil).find_each(batch_size: 20) do |project|\n    begin\n      # \u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u540d\u306e\u7981\u6b62\u6587\u5b57\u3092_\u306b\u7f6e\u63db\u3059\u308b\n      project.name = project.name.gsub(/(\\/|\\(|\\))/, '_')\n      # creator\u3092\u660e\u793a\u7684\u306b\u6307\u5b9a\u3059\u308b\n      project.creator = User.find(1)\n      # Transfer\u5148\u306eNamespace\u3092\u660e\u793a\u7684\u306b\u6307\u5b9a\u3059\u308b\n      ProjectTransferService.new.transfer(project, Namespace.find(1))\n      print '.'\n    rescue => ex\n      p ex\n      puts ex.message\n      print 'F'\n    end\n  end\nend\n\n\n\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u4f5c\u696d\u3092\u518d\u958b\u3002\n\n@\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u74b0\u5883\n$ sudo -u git -H bundle exec rake migrate_global_projects RAILS_ENV=production\n$ sudo -u git -H bundle exec rake migrate_keys RAILS_ENV=production\n$ sudo -u git -H bundle exec rake migrate_inline_notes RAILS_ENV=production\n$ sudo -u git -H bundle exec rake gitlab:satellites:create RAILS_ENV=production\n\n$ sudo -u git -H bundle exec rake cache:clear RAILS_ENV=production\n\n$ sudo -u git -H bundle exec rake assets:clean RAILS_ENV=production\n$ sudo -u git -H bundle exec rake assets:precompile RAILS_ENV=production\n\n\n\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092\u65b0\u30d0\u30fc\u30b8\u30e7\u30f3\u306e\u4ed5\u69d8\u306b\u5408\u3046\u3088\u3046\u306b\u7de8\u96c6\u3057\u307e\u3059\u304c\u3001\u81ea\u5206\u306e\u74b0\u5883\u3067\u306f\u7279\u306b\u5909\u66f4\u306f\u5fc5\u8981\u3042\u308a\u307e\u305b\u3093\u3067\u3057\u305f\u3002\n\nMake /home/git/gitlab/config/gitlab.yml the same as https://gitlab.com/gitlab-org/gitlab-ce/blob/master/config/gitlab.yml.example but with your settings.\nMake /home/git/gitlab/config/unicorn.rb the same as https://gitlab.com/gitlab-org/gitlab-ce/blob/master/config/unicorn.rb.example but with your settings.\n\n\n@\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u74b0\u5883\n$ sudo -u git -H cp /home/git/gitlab/config/gitlab.yml.example /home/git/gitlab/config/gitlab.yml\n$ sudo vim /home/git/gitlab/config/gitlab.yml\n\n$ sudo -u git -H cp /home/git/gitlab/config/unicorn.rb.example /home/git/gitlab/config/unicorn.rb\n\n$ sudo rm /etc/init.d/gitlab\n$ sudo cp lib/support/init.d/gitlab /etc/init.d/gitlab\n$ sudo chmod +x /etc/init.d/gitlab\n\n$ sudo service gitlab start\n$ sudo service nginx restart\n\n$ sudo -u git -H bundle exec rake gitlab:env:info RAILS_ENV=production\n$ sudo -u git -H bundle exec rake gitlab:check RAILS_ENV=production\n\n\n\n7. 6.0\u3067\u306e\u52d5\u4f5c\u78ba\u8a8d\n6.0\u3067\u306f\u5927\u304d\u306a\u5909\u66f4\u304c\u5165\u3063\u3066\u3044\u308b\u306e\u3067\u3001\u3053\u3053\u3067\u52d5\u4f5c\u78ba\u8a8d\u3092\u3057\u3066\u304a\u304f\u3002\n\n@\u81ea\u5206\u306ePC\n$ git clone git@git-migration.example.com:user/project.git\ngit@git-migration.example.com's password:\n\n\n\u30d1\u30b9\u30ef\u30fc\u30c9\u6c42\u3081\u3089\u308c\u308borz\n\u78ba\u8a8d\u3059\u308b\u3068/home/git/.ssh/authorized_keys\u304c\u7a7a\u3067\u3042\u3063\u305f\u306e\u3067\u3001\u73fe\u74b0\u5883\u304b\u3089/home/git/.ssh/authorized_keys\u3092\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u74b0\u5883\u306b\u30b3\u30d4\u30fc\u3057\u3066\u518d\u30c8\u30e9\u30a4\u3002\n\n@\u81ea\u5206\u306ePC\n$ git clone git@git-migration.example.com:user/project.git\nCloning into 'project'...\nAccess denied.\nfatal: Could not read from remote repository.\n\nPlease make sure you have the correct access rights\nand the repository exists.\n\n\ngitlab-shell\u306e\u30ed\u30b0\u3092\u898b\u3066\u307f\u308b\u3068\u3001GitLab\u306eAPI\u30a2\u30af\u30bb\u30b9\u304c404\u306b\u306a\u3063\u3066\u3044\u308b\u6a21\u69d8\u3002\n\n/home/git/gitlab-shell/gitlab-shell.log\nW, [2015-08-01T14:15:57.909114 #689]  WARN -- : gitlab-shell: Access denied for git command <git-upload-pack 'user/project.git'> by user with key key-106.\nE, [2015-08-01T14:18:22.067857 #792] ERROR -- : API call <GET http://git-migration.example.com//api/v3/internal/allowed?key_id=106&action=git-upload-pack&ref=_any&project=user/project> failed: 404 => <<html>\n<head><title>404 Not Found</title></head>\n<body bgcolor=\"white\">\n<center><h1>404 Not Found</h1></center>\n<hr><center>nginx/1.4.6 (Ubuntu)</center>\n</body>\n</html>\n>.\nW, [2015-08-01T14:18:22.067961 #792]  WARN -- : gitlab-shell: Access denied for git command <git-upload-pack 'user/project.git'> by user with key key-106.\n\n\nnginx\u306e\u30c7\u30d5\u30a9\u30eb\u30c8VirtualHost\u304c\u5fdc\u7b54\u3057\u3066\u3044\u308b\u305f\u3081\u3068\u601d\u308f\u308c\u308b\u306e\u3067\u3001nginx\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092\u4fee\u6b63\u3057\u3066nginx\u3092\u518d\u8d77\u52d5\u3002\n\n/etc/nginx/sites-available/gitlab\nserver {\n  # \u5168\u3066\u306eIP\u3067listen\n  listen 80;\n  # server_name\u3092\u6307\u5b9a\n  server_name git-migration.example.com;\n  ...\n}\n\n\n\u518d\u30c8\u30e9\u30a4\u3002\n\n\u81ea\u5206\u306ePC\n$ git clone git@git-migration.example.com:user/project.git\nCloning into 'project'...\nremote: Counting objects: 161, done.\nremote: Compressing objects: 100% (141/141), done.\nremote: Total 161 (delta 63), reused 0 (delta 0)\nReceiving objects: 100% (161/161), 125.77 KiB | 0 bytes/s, done.\nResolving deltas: 100% (63/63), done.\nChecking connectivity... done.\n\n\n\u3075\u3046\u3002\u3002\u3002\n\n8. 6.0\u304b\u30897.13\u3078\u306e\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\n\u516c\u5f0f\u30ac\u30a4\u30c9\u306b\u5f93\u3063\u3066\u4f5c\u696d\n\n@\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u74b0\u5883\n$ sudo service gitlab stop\n\n$ sudo apt-get install build-essential zlib1g-dev libyaml-dev libssl-dev libgdbm-dev libreadline-dev libncurses5-dev libffi-dev curl\n\n$ mkdir /tmp/ruby && cd /tmp/ruby\n$ curl --progress http://cache.ruby-lang.org/pub/ruby/2.1/ruby-2.1.6.tar.gz | tar xz\n$ cd ruby-2.1.6\n$ ./configure --disable-install-rdoc\n$ make\n$ sudo make install\n\n$ sudo gem install bundler --no-ri --no-rdoc\n\n$ cd /home/git/gitlab\n$ sudo -u git -H git checkout Gemfile Gemfile.lock db/schema.rb\n$ sudo -u git -H git fetch --all\n$ sudo -u git -H git checkout -- db/schema.rb\n\n$ sudo -u git -H git checkout 7-13-stable\n\n$ sudo apt-get install logrotate\n$ sudo apt-get install pkg-config cmake\n$ sudo apt-get install libkrb5-dev\n$ sudo apt-get install nodejs\n\n# Configure redis to use sockets\n$ sudo cp /etc/redis/redis.conf /etc/redis/redis.conf.orig\n# Disable Redis listening on TCP by setting 'port' to 0\n$ sed 's/^port .*/port 0/' /etc/redis/redis.conf.orig | sudo tee /etc/redis/redis.conf\n# Enable Redis socket for default Debian / Ubuntu path\n$ echo 'unixsocket /var/run/redis/redis.sock' | sudo tee -a /etc/redis/redis.conf\n# Be sure redis group can write to the socket, enable only if supported (>= redis 2.4.0).\n$ sudo sed -i '/# unixsocketperm/ s/^# unixsocketperm.*/unixsocketperm 0775/' /etc/redis/redis.conf\n# Activate the changes to redis.conf\n$ sudo service redis-server restart\n# Add git to the redis group\n$ sudo usermod -aG redis git\n\n# Configure Redis connection settings\n$ sudo -u git -H cp config/resque.yml.example config/resque.yml\n# Change the Redis socket path if you are not using the default Debian / Ubuntu configuration\n$ sudo -u git -H editor config/resque.yml\n\n# Configure gitlab-shell to use Redis sockets\n$ sudo -u git -H sed -i 's|^  # socket.*|  socket: /var/run/redis/redis.sock|' /home/git/gitlab-shell/config.yml\n\n\n$ cd /home/git/gitlab-shell\n$ sudo -u git -H git fetch\n$ sudo -u git -H git checkout v2.6.3\n\n$ cd /home/git/gitlab\n$ sudo -u git -H bundle install --without development test mysql --deployment\n$ sudo -u git -H bundle exec rake db:migrate RAILS_ENV=production\n\n\nmigration\u9014\u4e2d\u3067\u30a8\u30e9\u30fc\u767a\u751f\n== 20140416074002 AddIndexOnIid: migrating ====================================\nRemove Issue duplicates for iid:  and project_id: 340\nrake aborted!\nStandardError: An error has occurred, this and all later migrations canceled:\n\nundefined method `shift' for #<Issue::ActiveRecord_Relation:0x007f068ff444e8>/home/git/gitlab/vendor/bundle/ruby/2.1.0/gems/activerecord-4.1.11/lib/active_record/relation/delegation.rb:136:in `method_missing'\n\nhttps://github.com/gitlabhq/gitlabhq/pull/7443\n\u4e0a\u8a18\u30ea\u30f3\u30af\u3092\u53c2\u8003\u306b\u3001PR\u306e\u5185\u5bb9\u3067\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u51e6\u7406\u3092\u4fee\u6b63\u3059\u308b\u3002\n\n\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u74b0\u5883\n$ sudo vim db/migrate/20140416074002_add_index_on_iid.rb\n# if items.size > 1\nif items.is_a?(Array) && items.size > 1\n\n\n\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u3092\u518d\u958b\u3002\n\n\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u74b0\u5883\n$ sudo -u git -H bundle exec rake db:migrate RAILS_ENV=production\n$ sudo -u git -H bundle exec rake migrate_iids RAILS_ENV=production\n$ sudo -u git -H bundle exec rake assets:clean assets:precompile cache:clear RAILS_ENV=production\n$ sudo chmod u+rwx,g+rx,o-rwx /home/git/gitlab-satellites\n$ sudo cp lib/support/init.d/gitlab /etc/init.d/gitlab\n\n\n\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092\u65b0\u30d0\u30fc\u30b8\u30e7\u30f3\u306e\u4ed5\u69d8\u306b\u5408\u3046\u3088\u3046\u306b\u7de8\u96c6\u3057\u307e\u3059\u3002\n\nMake /home/git/gitlab/config/gitlab.yml the same as https://gitlab.com/gitlab-org/gitlab-ce/blob/7-13-stable/config/gitlab.yml.example but with your settings.\nMake /home/git/gitlab/config/unicorn.rb the same as https://gitlab.com/gitlab-org/gitlab-ce/blob/7-13-stable/config/unicorn.rb.example but with your settings.\nMake /home/git/gitlab-shell/config.yml the same as https://gitlab.com/gitlab-org/gitlab-shell/blob/v2.6.0/config.yml.example but with your settings.\n\npuma\u304b\u3089unicorn\u306b\u5909\u66f4\u306b\u306a\u3063\u305f\u3053\u3068\u3082\u3042\u308a\u3001\u3044\u304f\u3064\u304b\u4fee\u6b63\u304c\u5fc5\u8981\u3002\n\n\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u74b0\u5883\n$ sudo -u git -H cp config/gitlab.yml.example config/gitlab.yml\n$ sudo vim config/gitlab.yml\n# host,email_from\u7b49\u3092\u4fee\u6b63\n\n$ sudo -u git -H cp config/unicorn.rb.example config/unicorn.rb\n\n$ sudo -u git -H cp /home/git/gitlab-shell/config.yml.example /home/git/gitlab-shell/config.yml\n\n$ sudo -u git -H cp config/initializers/rack_attack.rb.example config/initializers/rack_attack.rb\n$ sudo cp lib/support/logrotate/gitlab /etc/logrotate.d/gitlab\n\n$ sudo cp lib/support/nginx/gitlab /etc/nginx/sites-available/gitlab\n$ sudo vim /etc/nginx/sites-available/gitlab\n  listen 80;\n  server_name git-migration.example.com;\n\n$ sudo service gitlab start\n$ sudo service nginx restart\n\n$ sudo -u git -H bundle exec rake gitlab:env:info RAILS_ENV=production\n$ sudo -u git -H bundle exec rake gitlab:check RAILS_ENV=production\n\n\ngitlab:check\u306b\u6012\u3089\u308c\u305f\u306e\u3067\u3001\u6307\u793a\u306b\u5f93\u3063\u3066\u4f5c\u696d\u3057\u3066\u518d\u30c1\u30a7\u30c3\u30af\u3002\n\n@\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u74b0\u5883\n$ sudo -u git -H /home/git/gitlab-shell//bin/create-hooks\n$ sudo -u git -H \"/usr/bin/git\" config --global core.autocrlf \"input\"\n\n$ sudo -u git -H bundle exec rake gitlab:check RAILS_ENV=production\n\n\n\u4ee5\u4e0a\u30677.13\u3078\u306e\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u306f\u5b8c\u4e86\u3002\n\n9. \u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u74b0\u5883\u306e\u30c7\u30fc\u30bf\u3092\u65b0\u74b0\u5883\u306b\u53d6\u308a\u8fbc\u307f\n\u516c\u5f0f\u30ac\u30a4\u30c9\u306b\u5f93\u3063\u3066\u3001\u30c7\u30fc\u30bf\u306e\u30c0\u30f3\u30d7\u3068\u53d6\u308a\u8fbc\u307f\u3092\u884c\u3046\u3002\n\u307e\u305a\u306f\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u74b0\u5883\u3067\u30c0\u30f3\u30d7\u3092\u5b9f\u884c\u3002\n\n@\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u74b0\u5883\n$ cd /home/git/gitlab\n$ sudo -u git -H bundle exec rake gitlab:backup:create RAILS_ENV=production\n\n\n\u3053\u306e\u30b3\u30de\u30f3\u30c9\u3067/home/git/gitlab/tmp/backups/XXXXXXXXXX_gitlab_backup.tar\u304c\u751f\u6210\u3055\u308c\u308b\u306e\u3067\u3001\u65b0\u74b0\u5883\u306b\u8ee2\u9001\u3059\u308b\u3002\n(XXXXXXXXXX\u306f\u30bf\u30a4\u30e0\u30b9\u30bf\u30f3\u30d7\u306a\u306e\u3067\u3001\u5404\u81ea\u306e\u74b0\u5883\u3067\u8aad\u307f\u66ff\u3048\u3066\u4e0b\u3055\u3044\u3002)\n\u65b0\u74b0\u5883\u3067\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u30d5\u30a1\u30a4\u30eb\u3092\u6307\u5b9a\u5834\u6240\u306b\u79fb\u52d5\u3057\u3001\u30ea\u30b9\u30c8\u30a2\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3059\u308b\u3002\n\n@\u65b0\u74b0\u5883\n$ sudo mv /home/hoge/XXXXXXXXXX_gitlab_backup.tar /var/opt/gitlab/backups/\n$ sudo chown git:git /var/opt/gitlab/backups/XXXXXXXXXX_gitlab_backup.tar\n$ sudo gitlab-ctl stop unicorn\n$ sudo gitlab-ctl stop sidekiq\n$ sudo gitlab-rake gitlab:backup:restore BACKUP=XXXXXXXXXX\n$ sudo gitlab-ctl stop\n$ sudo gitlab-ctl start\n\n\n\u4ee5\u4e0a\u3067\u3001\u65b0\u74b0\u5883\u3078\u306e\u30c7\u30fc\u30bf\u306e\u30a4\u30f3\u30dd\u30fc\u30c8\u306f\u5b8c\u4e86\u3067\u3059\u3002\n# About\n\n\u5c11\u3057\u524d\u306b\u3001\u793e\u5185\u306eGitLab\u30925.3\u304b\u30897.13\u306b\u30a2\u30c3\u30d7\u30b0\u30ec\u30fc\u30c9\u3057\u305f\u306e\u3067\u3001\u305d\u306e\u969b\u306e\u4f5c\u696d\u30ed\u30b0\u3092\u6b8b\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\u4eca\u5f8c\u3001\u540c\u3058\u3088\u3046\u306a\u4f5c\u696d(\u3068\u3044\u3046\u304b\u82e6\u884c)\u3092\u3059\u308b\u4eba\u306e\u304a\u5f79\u306b\u7acb\u3066\u308c\u3070\u3002\u3002\n\n\u306a\u304a\u3001\u4f5c\u696d\u6642\u70b9\u3067\u306e\u6700\u65b0\u7248\u306f7.13\u3067\u3057\u305f\u304c\u3001\u73fe\u5728\u306f8.X\u3067\u3059\u3002\u4eca\u5f8c\u4f5c\u696d\u3059\u308b\u5834\u5408\u306f\u3001\u9069\u5b9c\u8aad\u307f\u66ff\u3048\u3066\u4e0b\u3055\u3044\u3002\n\n# \u30a2\u30c3\u30d7\u30b0\u30ec\u30fc\u30c9\u524d\u306e\u72b6\u6cc1\n\n* 3.X\u306e\u6642\u4ee3\u304b\u3089\u4f55\u5ea6\u304b\u30a2\u30c3\u30d7\u30b0\u30ec\u30fc\u30c9\u3057\u306a\u304c\u3089\u5229\u7528\u3057\u3066\u3044\u3066\u3001\u73fe\u5728\u306f5.3\u3067\u904b\u7528\u4e2d\n* OS\u306fUbuntu\n\n# \u30a2\u30c3\u30d7\u30b0\u30ec\u30fc\u30c9\u8a08\u753b\n\n\u65b0\u74b0\u5883\u306fOmnibus\u7248\u3067\u904b\u7528\u3057\u305f\u304b\u3063\u305f\u305f\u3081\u3001\u30a2\u30c3\u30d7\u30b0\u30ec\u30fc\u30c9\u8a08\u753b\u3092\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u7acb\u3066\u307e\u3057\u305f\u3002\n\n* \u65b0\u898f\u30b5\u30fc\u30d0\u306bGitLab 7.13\u3092\u65b0\u74b0\u5883\u3068\u3057\u3066\u69cb\u7bc9\u3057\u3001\u73fe\u74b0\u5883\u306e\u30c7\u30fc\u30bf\u3092\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u3057\u3066\u30a4\u30f3\u30dd\u30fc\u30c8\u3059\u308b\u3002\n* \u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u306f\u3001\u65b0\u898f\u30b5\u30fc\u30d0\u306b\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u5c02\u7528\u306e\u74b0\u5883\u3092\u7528\u610f\u3057\u3001\u516c\u5f0f\u30ac\u30a4\u30c9\u306b\u5f93\u3063\u3066\u4e0b\u8a183\u30b9\u30c6\u30c3\u30d7\u3067\u884c\u3046\u3002\n   1. MySQL\u304b\u3089PostgreSQL\u306b\u30b3\u30f3\u30d0\u30fc\u30c8\n      * \u6700\u65b0GitLab\u3067\u306f\u3001MySQL\u306e\u30b5\u30dd\u30fc\u30c8\u304cPro\u7248\u306e\u307forz\n   2.  [5.3 -> 5.4](https://gitlab.com/gitlab-org/gitlab-ce/blob/master/doc/update/5.3-to-5.4.md)\n   3.  [5.4 -> 6.0](https://gitlab.com/gitlab-org/gitlab-ce/blob/master/doc/update/5.4-to-6.0.md)\n   4.  [From 6.x or 7.x to 7.13](https://gitlab.com/gitlab-org/gitlab-ce/blob/master/doc/update/6.x-or-7.x-to-7.13.md)\n* \u6700\u5f8c\u306bDNS\u3092\u65b0\u74b0\u5883\u306b\u5207\u308a\u66ff\u3048\u3066\u79fb\u884c\u3092\u884c\u3046\n\n\u3053\u306e\u6d41\u308c\u3092\u53ef\u8996\u5316\u3059\u308b\u3068\u3001\u6b21\u306e\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\n\n<img width=\"649\" alt=\"gitlab.png\" src=\"https://qiita-image-store.s3.amazonaws.com/0/1489/e639eae4-6f5b-f9f1-6e09-c81787125c34.png\">\n\n\n# \u4f5c\u696d\u30ed\u30b0\n\n## 1. \u65b0\u74b0\u5883\u306e\u69cb\u7bc9\n\n\u65b0\u898f\u30b5\u30fc\u30d0\u306bUbuntu 14.04 LTS\u3092\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u3057\u3001[\u516c\u5f0f\u30ac\u30a4\u30c9](https://about.gitlab.com/downloads/)\u306b\u5f93\u3063\u3066GitLab\u306eOmnibus\u7248\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u3002\n\n```sh:@\u65b0\u74b0\u5883\n$ sudo apt-get install curl openssh-server ca-certificates\n$ curl https://packages.gitlab.com/install/repositories/gitlab/gitlab-ce/script.deb.sh | sudo bash\n$ sudo apt-get install gitlab-ce\n$ sudo gitlab-ctl reconfigure\n```\n\n## 2. \u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u74b0\u5883\u306e\u69cb\u7bc9\n\n\u65b0\u898f\u30b5\u30fc\u30d0\u306bUbuntu 14.04 LTS\u3092\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u3057\u3001[\u516c\u5f0f\u30ac\u30a4\u30c9](https://github.com/gitlabhq/gitlabhq/blob/5-3-stable/doc/install/installation.md)\u306b\u5f93\u3063\u3066GitLab 5.3\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u3002\n\n\u4f9d\u5b58\u30d1\u30c3\u30b1\u30fc\u30b8\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u3002\n\n```sh:@\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u74b0\u5883\n# Install dependencies\n$ sudo apt-get install -y build-essential zlib1g-dev libyaml-dev libssl-dev libgdbm-dev libreadline-dev libncurses5-dev libffi-dev curl git-core openssh-server redis-server checkinstall libxml2-dev libxslt-dev libcurl4-openssl-dev libicu-dev\n$ sudo apt-get install python\n$ python --version\n```\n\n\u6b21\u306bRuby\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u3002\n\n```sh:@\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u74b0\u5883\n# Ruby\n$ sudo apt-get remove ruby1.8\n$ mkdir /tmp/ruby && cd /tmp/ruby\n$ curl --progress http://ftp.ruby-lang.org/pub/ruby/1.9/ruby-1.9.3-p392.tar.gz | tar xz\n$ cd ruby-1.9.3-p392\n$ ./configure\n$ make\n$ sudo make install\n$ sudo gem install bundler\n```\n\n\u6b21\u306bgitlab-shell\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u3002gitlab_url\u306eURL\u306f\u5404\u81ea\u306e\u74b0\u5883\u3067\u8aad\u307f\u66ff\u3048\u3066\u4e0b\u3055\u3044\u3002\n\n```sh:@\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u74b0\u5883\n# Install gitlab-shell\n$ sudo adduser --disabled-login --gecos 'GitLab' git\n$ sudo su git\n$ cd /home/git\n$ git clone https://github.com/gitlabhq/gitlab-shell.git\n$ cd gitlab-shell\n$ git checkout v1.4.0\n$ cp config.yml.example config.yml\n\n$ vim config.yml\n# gitlab_url\u3092\u7de8\u96c6\n# gitlab_url: \"http://git-migration.example.com/\"\n\n$ ./bin/install\n```\n\n\u6b21\u306bMySQL\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u3002\n\n```sh:@\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u74b0\u5883\n# MySQL\n$ sudo apt-get install -y mysql-server mysql-client libmysqlclient-dev\n$ mysql -u root -p # password=root\nmysql> CREATE USER 'gitlab'@'localhost' IDENTIFIED BY 'gitlab';\nmysql> CREATE DATABASE IF NOT EXISTS `gitlabhq_production` DEFAULT CHARACTER SET `utf8` COLLATE `utf8_unicode_ci`;\nmysql> GRANT SELECT, LOCK TABLES, INSERT, UPDATE, DELETE, CREATE, DROP, INDEX, ALTER ON `gitlabhq_production`.* TO 'gitlab'@'localhost';\nmysql> \\q\n\n# Check connectivity\n$ sudo -u git -H mysql -u gitlab -p -D gitlabhq_production\n```\n\n\u6b21\u306bGitLab\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u3002\n\n```sh:@\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u74b0\u5883\n# GitLab\n$ cd /home/git\n$ sudo -u git -H git clone https://github.com/gitlabhq/gitlabhq.git gitlab\n$ cd /home/git/gitlab\n$ sudo -u git -H git checkout 5-3-stable\n\n$ cd /home/git/gitlab\n$ sudo -u git -H cp config/gitlab.yml.example config/gitlab.yml\n$ sudo -u git -H vim config/gitlab.yml\n# host\u3092\u7de8\u96c6\n# host: git-migration.example.com\n\n$ sudo chown -R git log/\n$ sudo chown -R git tmp/\n$ sudo chmod -R u+rwX  log/\n$ sudo chmod -R u+rwX  tmp/\n\n$ sudo -u git -H mkdir /home/git/gitlab-satellites\n$ sudo -u git -H mkdir tmp/pids/\n$ sudo -u git -H mkdir tmp/sockets/\n$ sudo chmod -R u+rwX  tmp/pids/\n$ sudo chmod -R u+rwX  tmp/sockets/\n\n$ sudo -u git -H mkdir public/uploads\n$ sudo chmod -R u+rwX  public/uploads\n$ sudo -u git -H cp config/puma.rb.example config/puma.rb\n$ sudo -u git -H git config --global user.name \"GitLab\"\n$ sudo -u git -H git config --global user.email \"gitlab@localhost\"\n\n$ sudo -u git cp config/database.yml.mysql config/database.yml\n```\n\n\u6b21\u306bgem\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u3002\n\n```sh:@\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u74b0\u5883\n$ cd /home/git/gitlab\n$ sudo gem install charlock_holmes --version '0.6.9.4'\n$ sudo -u git -H bundle install --deployment --without development test postgres\n```\n\n\u3053\u3053\u30671\u3064\u76ee\u306e\u5730\u96f7\u3092\u8e0f\u3080\u3002`Could not find modernizr-2.6.2 in any of the sources`\u3068\u306a\u308a\u3001gem\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u304c\u7d42\u308f\u3089\u306a\u3044\u3002\n\nhttp://anton0825.hatenablog.com/entry/20140523/1408932429\n\n\u4e0a\u8a18\u8a18\u4e8b\u3092\u53c2\u8003\u306b\u3001Gemfile\u3068Gemfile.lock\u306emodernizr 2.6.2\u3092modernizr-rails 2.7.1\u306b\u4fee\u6b63\u3057\u3066\u518d\u30c8\u30e9\u30a4\u3002\n\n```sh:@\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u74b0\u5883\n$ sudo vim Gemfile\n  #gem \"modernizr\",        \"2.6.2\"\n  gem \"modernizr-rails\",   \"2.7.1\"\n$ sudo vim Gemfile.log\n  modernizr-rails (2.7.1)\n  modernizr-rails (= 2.7.1)\n$ sudo -u git -H bundle install --deployment --without development test postgres\n```\n\n\u3068\u308a\u3042\u3048\u305a\u901a\u3063\u305f\u306e\u3067\u3001GitLab\u306e\u8a2d\u5b9a\u4f5c\u696d\u3092\u9032\u3081\u308b\u3002\n\n```sh:@\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u74b0\u5883\n$ sudo -u git -H bundle exec rake gitlab:setup RAILS_ENV=production\n\n$ sudo cp lib/support/init.d/gitlab /etc/init.d/gitlab\n$ sudo chmod +x /etc/init.d/gitlab\n$ sudo update-rc.d gitlab defaults 21\n\n$ sudo -u git -H bundle exec rake gitlab:env:info RAILS_ENV=production\n$ sudo service gitlab start\n$ sudo -u git -H bundle exec rake gitlab:check RAILS_ENV=production\n# \u4f55\u6545\u304bsidekiq\u304c\u8d77\u52d5\u3057\u3066\u3044\u306a\u3044\u3068\u6012\u3089\u308c\u305f\u306e\u3067sidekiq:start\u3057\u3066\u304a\u304f\n$ sudo -u git -H bundle exec rake sidekiq:start RAILS_ENV=production\n$ sudo -u git -H bundle exec rake gitlab:check RAILS_ENV=production\n```\n\n\u6700\u5f8c\u306bNginx\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u3002\n\n```sh:@\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u74b0\u5883\n# nginx\n$ sudo apt-get install nginx\n$ sudo cp lib/support/nginx/gitlab /etc/nginx/sites-available/gitlab\n$ sudo ln -s /etc/nginx/sites-available/gitlab /etc/nginx/sites-enabled/gitlab\n$ sudo vim /etc/nginx/sites-available/gitlab\n# listen <IP\u30a2\u30c9\u30ec\u30b9>:80 default_server;\n# server_name localhost;\n$ sudo service nginx restart\n```\n\n## 3. \u73fe\u74b0\u5883\u306e\u30c7\u30fc\u30bf\u3092\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u74b0\u5883\u306b\u30a4\u30f3\u30dd\u30fc\u30c8\n\n\u307e\u305a\u3001\u73fe\u74b0\u5883\u306e\u30c7\u30fc\u30bf\u3092\u30c0\u30f3\u30d7\u3059\u308b\u3002\n\n```sh:@\u73fe\u74b0\u5883\n# MySQL\u306e\u30c0\u30f3\u30d7\n$ mysqldump -u gitlab -p --default-character-set=utf8 gitlabhq_production > gitlabhq_production.sql\n# \u30ea\u30dd\u30b8\u30c8\u30ea\u306e\u30a2\u30fc\u30ab\u30a4\u30d6\n$ sudo zip -r /home/git/repositories_migration.zip /home/git/repositories\n```\n\n`gitlabhq_production.sql`\u3068`repositories_migration.zip`\u306f\u3001\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u74b0\u5883\u306e`/home/hoge`\u914d\u4e0b\u306b\u8ee2\u9001\u3057\u3066\u304a\u304f\u3002\n\n\u6b21\u306b\u3001\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u74b0\u5883\u3067\u30c7\u30fc\u30bf\u3092\u30a4\u30f3\u30dd\u30fc\u30c8\u3059\u308b\u3002\n\n```sh:@\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u74b0\u5883\n# MySQL\u306e\u30a4\u30f3\u30dd\u30fc\u30c8\n$ mysql -u gitlab -p gitlabhq_production < /home/hoge/gitlabhq_production.sql\n# \u30ea\u30dd\u30b8\u30c8\u30ea\u306e\u5c55\u958b\n$ unzip /home/hoge/repositories_migration.zip\n$ sudo rm -rf /home/git/repositories\n$ sudo mv /home/hoge/home/git/repositories /home/git/\n$ sudo chown -R git:git /home/git/repositories\n$ sudo chmod -R 2775 /home/git/repositories\n```\n\n## 4. \u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u74b0\u5883\u306eDB\u3092PostgreSQL\u306b\u30b3\u30f3\u30d0\u30fc\u30c8\n\nPostgreSQL\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u3002\n\nhttps://github.com/gitlabhq/gitlabhq/blob/5-3-stable/doc/install/databases.md\n\n```sh:@\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u74b0\u5883\n$ sudo apt-get install -y postgresql libpq-dev\n$ sudo -u postgres psql -d template1\ntemplate1=# CREATE USER git WITH PASSWORD 'git';\ntemplate1=# CREATE DATABASE gitlabhq_production OWNER git;\ntemplate1=# \\q\n$ sudo -u git -H psql -d gitlabhq_production\n```\n\nMySQL\u306e\u30c7\u30fc\u30bf\u3092PostgreSQL\u306b\u30b3\u30f3\u30d0\u30fc\u30c8\u3059\u308b\u3002\n\nhttps://github.com/gitlabhq/mysql-postgresql-converter\n\n```sh:@\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u74b0\u5883\n$ cd\n$ mysqldump --compatible=postgresql --default-character-set=utf8 -r databasename.mysql -u gitlab gitlabhq_production -p\n$ git clone https://github.com/gitlabhq/mysql-postgresql-converter.git\n$ cp mysql-postgresql-converter/db_converter.py ./\n$ cp mysql-postgresql-converter/move_drop_indexes.ed ./\n$ python db_converter.py databasename.mysql databasename.psql\n$ ed -s databasename.psql < move_drop_indexes.ed\n$ sudo -u git -H psql -f databasename.psql -d gitlabhq_production\n```\n\nGitLab\u3092PostgreSQL\u5411\u3051\u306b\u8a2d\u5b9a\u3059\u308b\u3002\n\n```sh:@\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u74b0\u5883\n$ cd /home/git/gitlab\n$ sudo -u git -H cp config/database.yml.postgresql config/database.yml\n$ sudo -u git -H vim config/database.yml\n\n$ sudo vim .bundle/config\n# without\u304b\u3089postgres\u3092\u6d88\u3059\n\n$ sudo -u git -H bundle install --deployment --without development test mysql\n$ sudo /etc/init.d/gitlab restart\n```\n\n\u4ee5\u4e0a\u3067PostgreSQL\u5316\u306f\u5b8c\u4e86\u3002\n\n## 5. 5.3\u304b\u30895.4\u3078\u306e\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\n\n[\u516c\u5f0f\u30ac\u30a4\u30c9](https://gitlab.com/gitlab-org/gitlab-ce/blob/master/doc/update/5.3-to-5.4.md)\u306b\u5f93\u3063\u3066\u4f5c\u696d\u3059\u308b\u3002\n\n```sh:@\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u74b0\u5883\n$ sudo service gitlab stop\n$ cd /home/git/gitlab\n$ sudo -u git -H git checkout Gemfile Gemfile.lock\n$ sudo -u git -H git fetch\n$ sudo -u git -H git checkout 5-4-stable\n\n$ cd /home/git/gitlab-shell\n$ sudo -u git -H git fetch\n$ sudo -u git -H git checkout v1.7.9\n\n$ cd /home/git/gitlab\n\n# \u4f8b\u306b\u3088\u3063\u3066modernizr\u95a2\u9023\u3067\u6012\u3089\u308c\u308b\u306e\u3067...\n$ sudo vim Gemfile\n  #gem \"modernizr\",        \"2.6.2\"\n  gem \"modernizr-rails\",   \"2.7.1\"\n$ sudo vim Gemfile.log\n  modernizr-rails (2.7.1)\n  modernizr-rails (= 2.7.1)\n\n$ sudo -u git -H bundle install --without development test mysql --deployment\n$ sudo -u git -H bundle exec rake db:migrate RAILS_ENV=production\n$ sudo -u git -H bundle exec rake assets:precompile RAILS_ENV=production\n```\n\n\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092\u65b0\u30d0\u30fc\u30b8\u30e7\u30f3\u306e\u4ed5\u69d8\u306b\u5408\u3046\u3088\u3046\u306b\u7de8\u96c6\u3057\u307e\u3059\u304c\u3001\u81ea\u5206\u306e\u74b0\u5883\u3067\u306f\u7279\u306b\u5909\u66f4\u306f\u5fc5\u8981\u3042\u308a\u307e\u305b\u3093\u3067\u3057\u305f\u3002\n\n* Make `/home/git/gitlab/config/gitlab.yml` same as https://gitlab.com/gitlab-org/gitlab-ce/blob/5-4-stable/config/gitlab.yml.example but with your settings.\n* Make `/home/git/gitlab/config/puma.rb` same as https://gitlab.com/gitlab-org/gitlab-ce/blob/5-4-stable/config/puma.rb.example but with your settings.\n\n\u8d77\u52d5\u30b9\u30af\u30ea\u30d7\u30c8\u306e\u8a2d\u7f6e\u3068\u3001\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u306e\u6700\u7d42\u30c1\u30a7\u30c3\u30af\u3092\u884c\u3046\u3002\n\n```sh:@\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u74b0\u5883\n$ sudo rm /etc/init.d/gitlab\n$ sudo curl -L --output /etc/init.d/gitlab https://raw.github.com/gitlabhq/gitlabhq/5-4-stable/lib/support/init.d/gitlab\n$ sudo chmod +x /etc/init.d/gitlab\n\n$ sudo service gitlab start\n$ sudo service nginx restart\n\n$ sudo -u git -H bundle exec rake gitlab:env:info RAILS_ENV=production\n$ sudo -u git -H bundle exec rake gitlab:check RAILS_ENV=production\n```\n\ngitlab:check\u306b\u6012\u3089\u308c\u305f\u306e\u3067\u3001\u6307\u793a\u306b\u5f93\u3063\u3066\u4f5c\u696d\u3057\u3066\u518d\u30c1\u30a7\u30c3\u30af\u3059\u308b\u3002\n\n```sh:@\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u74b0\u5883\n$ sudo chmod -R ug+rwX,o-rwx /home/git/repositories/\n$ sudo chmod -R ug-s /home/git/repositories/\n$ find /home/git/repositories/ -type d -print0 | sudo xargs -0 chmod g+s\n$ sudo -u git -H bundle exec rake gitlab:satellites:create RAILS_ENV=production\n\n$ sudo -u git -H bundle exec rake gitlab:check RAILS_ENV=production\n```\n\n\n## 6. 5.4\u304b\u30896.0\u3078\u306e\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\n\n[\u516c\u5f0f\u30ac\u30a4\u30c9](https://gitlab.com/gitlab-org/gitlab-ce/blob/master/doc/update/5.4-to-6.0.md)\u306b\u5f93\u3063\u3066\u4f5c\u696d\u3059\u308b\u3002\n\n```sh:@\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u74b0\u5883\n$ sudo service gitlab stop\n\n$ cd /home/git/gitlab\n$ sudo -u git -H git checkout Gemfile Gemfile.lock db/schema.rb\n$ sudo -u git -H git fetch\n$ sudo -u git -H git checkout 6-0-stable\n\n$ cd /home/git/gitlab-shell\n$ sudo -u git -H git fetch\n$ sudo -u git -H git checkout v1.7.9\n\n$ sudo apt-get install python-docutils\n\n$ cd /home/git/gitlab\n\n# \u4f8b\u306b\u3088\u3063\u3066modernizr\u95a2\u9023\u3067\u6012\u3089\u308c\u308b\u306e\u3067...\n$ sudo vim Gemfile\n  #gem \"modernizr\",        \"2.6.2\"\n  gem \"modernizr-rails\",   \"2.7.1\"\n$ sudo vim Gemfile.log\n  modernizr-rails (2.7.1)\n  modernizr-rails (= 2.7.1)\n\n$ sudo -u git -H bundle install --without development test mysql --deployment\n```\n\nDB\u306e\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u4f5c\u696d\u3092\u958b\u59cb\u3002[6.0\u3067\u306fModel\u306b\u5927\u304d\u306a\u4fee\u6b63\u304c\u5165\u3063\u305f\u3068\u306e\u3053\u3068](https://gitlab.com/gitlab-org/gitlab-ce/blob/master/doc/update/5.4-to-6.0.md#deprecations)\u3067\u3001\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u306b\u306f\u8907\u6570\u306e\u30b9\u30c6\u30c3\u30d7\u304c\u5fc5\u8981\u306b\u306a\u308b\u3002\n\n```sh:@\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u74b0\u5883\n$ sudo -u git -H bundle exec rake db:migrate RAILS_ENV=production\n$ sudo -u git -H bundle exec rake migrate_groups RAILS_ENV=production\n$ sudo -u git -H bundle exec rake migrate_global_projects RAILS_ENV=production\n```\n\n`migrate_global_projects`\u30672\u56de\u76ee\u306e\u5730\u96f7\u3092\u8e0f\u3080\u3002\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u306e\u9032\u6357\u72b6\u6cc1\u306b**F**\u306e\u6587\u5b57\u304c\u8868\u793a\u3055\u308c\u3066\u3044\u308b\u306e\u3067\u3001\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u306b\u5931\u6557\u3057\u3066\u3044\u308b\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u304c\u3042\u308b\u6a21\u69d8\u3002\n\n\u30a8\u30e9\u30fc\u30ed\u30b0\u3068\u30c7\u30fc\u30bf\u3068\u30bd\u30fc\u30b9\u3092\u78ba\u8a8d\u3057\u305f\u3068\u3053\u308d\u3001\u5931\u6557\u306e\u539f\u56e0\u3092\u7a81\u304d\u6b62\u3081\u308b\u3002\n3.X\u6642\u4ee3\u304b\u3089\u904b\u7528\u3057\u3066\u3044\u305f\u305f\u3081\u3001\u8272\u3005\u3068\u602a\u3057\u3044\u30c7\u30fc\u30bf\u304c\u6b8b\u3063\u3066\u3044\u308b\u3088\u3046\u3060\u3002\u3002\n\n* \u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u540d\u306b\u7981\u6b62\u6587\u5b57`/()`\u304c\u4f7f\u308f\u308c\u3066\u3044\u308b\n* owner\u4e0d\u5728\uff1f\u306eProject\u304c\u3042\u308a\u3001ProjectTransferService\u304c\u5931\u6557\u3059\u308b\n\n\u4ed5\u65b9\u306a\u3044\u306e\u3067\u3001`lib/tasks/migrate/migrate_global_projects.rake`\u3092\u4fee\u6b63\u3059\u308b\u3002\n\n```sh:lib/tasks/migrate/migrate_global_projects.rake\ndesc \"GITLAB | Migrate Global Projects to Namespaces\"\ntask migrate_global_projects: :environment do\n  found = Project.where(namespace_id: nil).count\n  if found > 0\n    puts \"Global namespace is deprecated. We found #{found} projects stored in global namespace\".yellow\n    puts \"You may abort this task and move them to group/user namespaces manually.\"\n    puts \"If you want us to move this projects under owner namespaces then continue\"\n    ask_to_continue\n  else\n    puts \"No global projects found. Proceed with update.\".green\n  end\n\n  Project.where(namespace_id: nil).find_each(batch_size: 20) do |project|\n    begin\n      # \u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u540d\u306e\u7981\u6b62\u6587\u5b57\u3092_\u306b\u7f6e\u63db\u3059\u308b\n      project.name = project.name.gsub(/(\\/|\\(|\\))/, '_')\n      # creator\u3092\u660e\u793a\u7684\u306b\u6307\u5b9a\u3059\u308b\n      project.creator = User.find(1)\n      # Transfer\u5148\u306eNamespace\u3092\u660e\u793a\u7684\u306b\u6307\u5b9a\u3059\u308b\n      ProjectTransferService.new.transfer(project, Namespace.find(1))\n      print '.'\n    rescue => ex\n      p ex\n      puts ex.message\n      print 'F'\n    end\n  end\nend\n```\n\n\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u4f5c\u696d\u3092\u518d\u958b\u3002\n\n```sh:@\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u74b0\u5883\n$ sudo -u git -H bundle exec rake migrate_global_projects RAILS_ENV=production\n$ sudo -u git -H bundle exec rake migrate_keys RAILS_ENV=production\n$ sudo -u git -H bundle exec rake migrate_inline_notes RAILS_ENV=production\n$ sudo -u git -H bundle exec rake gitlab:satellites:create RAILS_ENV=production\n\n$ sudo -u git -H bundle exec rake cache:clear RAILS_ENV=production\n\n$ sudo -u git -H bundle exec rake assets:clean RAILS_ENV=production\n$ sudo -u git -H bundle exec rake assets:precompile RAILS_ENV=production\n```\n\n\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092\u65b0\u30d0\u30fc\u30b8\u30e7\u30f3\u306e\u4ed5\u69d8\u306b\u5408\u3046\u3088\u3046\u306b\u7de8\u96c6\u3057\u307e\u3059\u304c\u3001\u81ea\u5206\u306e\u74b0\u5883\u3067\u306f\u7279\u306b\u5909\u66f4\u306f\u5fc5\u8981\u3042\u308a\u307e\u305b\u3093\u3067\u3057\u305f\u3002\n\n* Make `/home/git/gitlab/config/gitlab.yml` the same as https://gitlab.com/gitlab-org/gitlab-ce/blob/master/config/gitlab.yml.example but with your settings.\n* Make `/home/git/gitlab/config/unicorn.rb` the same as https://gitlab.com/gitlab-org/gitlab-ce/blob/master/config/unicorn.rb.example but with your settings.\n\n```sh:@\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u74b0\u5883\n$ sudo -u git -H cp /home/git/gitlab/config/gitlab.yml.example /home/git/gitlab/config/gitlab.yml\n$ sudo vim /home/git/gitlab/config/gitlab.yml\n\n$ sudo -u git -H cp /home/git/gitlab/config/unicorn.rb.example /home/git/gitlab/config/unicorn.rb\n\n$ sudo rm /etc/init.d/gitlab\n$ sudo cp lib/support/init.d/gitlab /etc/init.d/gitlab\n$ sudo chmod +x /etc/init.d/gitlab\n\n$ sudo service gitlab start\n$ sudo service nginx restart\n\n$ sudo -u git -H bundle exec rake gitlab:env:info RAILS_ENV=production\n$ sudo -u git -H bundle exec rake gitlab:check RAILS_ENV=production\n```\n\n## 7. 6.0\u3067\u306e\u52d5\u4f5c\u78ba\u8a8d\n\n6.0\u3067\u306f\u5927\u304d\u306a\u5909\u66f4\u304c\u5165\u3063\u3066\u3044\u308b\u306e\u3067\u3001\u3053\u3053\u3067\u52d5\u4f5c\u78ba\u8a8d\u3092\u3057\u3066\u304a\u304f\u3002\n\n```:@\u81ea\u5206\u306ePC\n$ git clone git@git-migration.example.com:user/project.git\ngit@git-migration.example.com's password:\n```\n\n\u30d1\u30b9\u30ef\u30fc\u30c9\u6c42\u3081\u3089\u308c\u308borz\n\n\u78ba\u8a8d\u3059\u308b\u3068`/home/git/.ssh/authorized_keys`\u304c\u7a7a\u3067\u3042\u3063\u305f\u306e\u3067\u3001\u73fe\u74b0\u5883\u304b\u3089`/home/git/.ssh/authorized_keys`\u3092\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u74b0\u5883\u306b\u30b3\u30d4\u30fc\u3057\u3066\u518d\u30c8\u30e9\u30a4\u3002\n\n```:@\u81ea\u5206\u306ePC\n$ git clone git@git-migration.example.com:user/project.git\nCloning into 'project'...\nAccess denied.\nfatal: Could not read from remote repository.\n\nPlease make sure you have the correct access rights\nand the repository exists.\n```\n\ngitlab-shell\u306e\u30ed\u30b0\u3092\u898b\u3066\u307f\u308b\u3068\u3001GitLab\u306eAPI\u30a2\u30af\u30bb\u30b9\u304c404\u306b\u306a\u3063\u3066\u3044\u308b\u6a21\u69d8\u3002\n\n```:/home/git/gitlab-shell/gitlab-shell.log\nW, [2015-08-01T14:15:57.909114 #689]  WARN -- : gitlab-shell: Access denied for git command <git-upload-pack 'user/project.git'> by user with key key-106.\nE, [2015-08-01T14:18:22.067857 #792] ERROR -- : API call <GET http://git-migration.example.com//api/v3/internal/allowed?key_id=106&action=git-upload-pack&ref=_any&project=user/project> failed: 404 => <<html>\n<head><title>404 Not Found</title></head>\n<body bgcolor=\"white\">\n<center><h1>404 Not Found</h1></center>\n<hr><center>nginx/1.4.6 (Ubuntu)</center>\n</body>\n</html>\n>.\nW, [2015-08-01T14:18:22.067961 #792]  WARN -- : gitlab-shell: Access denied for git command <git-upload-pack 'user/project.git'> by user with key key-106.\n```\n\nnginx\u306e\u30c7\u30d5\u30a9\u30eb\u30c8VirtualHost\u304c\u5fdc\u7b54\u3057\u3066\u3044\u308b\u305f\u3081\u3068\u601d\u308f\u308c\u308b\u306e\u3067\u3001nginx\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092\u4fee\u6b63\u3057\u3066nginx\u3092\u518d\u8d77\u52d5\u3002\n\n```:/etc/nginx/sites-available/gitlab\nserver {\n  # \u5168\u3066\u306eIP\u3067listen\n  listen 80;\n  # server_name\u3092\u6307\u5b9a\n  server_name git-migration.example.com;\n  ...\n}\n```\n\n\u518d\u30c8\u30e9\u30a4\u3002\n\n\n```sh:\u81ea\u5206\u306ePC\n$ git clone git@git-migration.example.com:user/project.git\nCloning into 'project'...\nremote: Counting objects: 161, done.\nremote: Compressing objects: 100% (141/141), done.\nremote: Total 161 (delta 63), reused 0 (delta 0)\nReceiving objects: 100% (161/161), 125.77 KiB | 0 bytes/s, done.\nResolving deltas: 100% (63/63), done.\nChecking connectivity... done.\n```\n\n\u3075\u3046\u3002\u3002\u3002\n\n## 8. 6.0\u304b\u30897.13\u3078\u306e\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\n\n[\u516c\u5f0f\u30ac\u30a4\u30c9](https://gitlab.com/gitlab-org/gitlab-ce/blob/master/doc/update/6.x-or-7.x-to-7.13.md)\u306b\u5f93\u3063\u3066\u4f5c\u696d\n\n```sh:@\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u74b0\u5883\n$ sudo service gitlab stop\n\n$ sudo apt-get install build-essential zlib1g-dev libyaml-dev libssl-dev libgdbm-dev libreadline-dev libncurses5-dev libffi-dev curl\n\n$ mkdir /tmp/ruby && cd /tmp/ruby\n$ curl --progress http://cache.ruby-lang.org/pub/ruby/2.1/ruby-2.1.6.tar.gz | tar xz\n$ cd ruby-2.1.6\n$ ./configure --disable-install-rdoc\n$ make\n$ sudo make install\n\n$ sudo gem install bundler --no-ri --no-rdoc\n\n$ cd /home/git/gitlab\n$ sudo -u git -H git checkout Gemfile Gemfile.lock db/schema.rb\n$ sudo -u git -H git fetch --all\n$ sudo -u git -H git checkout -- db/schema.rb\n\n$ sudo -u git -H git checkout 7-13-stable\n\n$ sudo apt-get install logrotate\n$ sudo apt-get install pkg-config cmake\n$ sudo apt-get install libkrb5-dev\n$ sudo apt-get install nodejs\n\n# Configure redis to use sockets\n$ sudo cp /etc/redis/redis.conf /etc/redis/redis.conf.orig\n# Disable Redis listening on TCP by setting 'port' to 0\n$ sed 's/^port .*/port 0/' /etc/redis/redis.conf.orig | sudo tee /etc/redis/redis.conf\n# Enable Redis socket for default Debian / Ubuntu path\n$ echo 'unixsocket /var/run/redis/redis.sock' | sudo tee -a /etc/redis/redis.conf\n# Be sure redis group can write to the socket, enable only if supported (>= redis 2.4.0).\n$ sudo sed -i '/# unixsocketperm/ s/^# unixsocketperm.*/unixsocketperm 0775/' /etc/redis/redis.conf\n# Activate the changes to redis.conf\n$ sudo service redis-server restart\n# Add git to the redis group\n$ sudo usermod -aG redis git\n\n# Configure Redis connection settings\n$ sudo -u git -H cp config/resque.yml.example config/resque.yml\n# Change the Redis socket path if you are not using the default Debian / Ubuntu configuration\n$ sudo -u git -H editor config/resque.yml\n\n# Configure gitlab-shell to use Redis sockets\n$ sudo -u git -H sed -i 's|^  # socket.*|  socket: /var/run/redis/redis.sock|' /home/git/gitlab-shell/config.yml\n\n\n$ cd /home/git/gitlab-shell\n$ sudo -u git -H git fetch\n$ sudo -u git -H git checkout v2.6.3\n\n$ cd /home/git/gitlab\n$ sudo -u git -H bundle install --without development test mysql --deployment\n$ sudo -u git -H bundle exec rake db:migrate RAILS_ENV=production\n```\n\nmigration\u9014\u4e2d\u3067\u30a8\u30e9\u30fc\u767a\u751f\n\n```\n== 20140416074002 AddIndexOnIid: migrating ====================================\nRemove Issue duplicates for iid:  and project_id: 340\nrake aborted!\nStandardError: An error has occurred, this and all later migrations canceled:\n\nundefined method `shift' for #<Issue::ActiveRecord_Relation:0x007f068ff444e8>/home/git/gitlab/vendor/bundle/ruby/2.1.0/gems/activerecord-4.1.11/lib/active_record/relation/delegation.rb:136:in `method_missing'\n```\n\nhttps://github.com/gitlabhq/gitlabhq/pull/7443\n\n\u4e0a\u8a18\u30ea\u30f3\u30af\u3092\u53c2\u8003\u306b\u3001PR\u306e\u5185\u5bb9\u3067\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u51e6\u7406\u3092\u4fee\u6b63\u3059\u308b\u3002\n\n```sh:\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u74b0\u5883\n$ sudo vim db/migrate/20140416074002_add_index_on_iid.rb\n# if items.size > 1\nif items.is_a?(Array) && items.size > 1\n```\n\n\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u3092\u518d\u958b\u3002\n\n```sh:\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u74b0\u5883\n$ sudo -u git -H bundle exec rake db:migrate RAILS_ENV=production\n$ sudo -u git -H bundle exec rake migrate_iids RAILS_ENV=production\n$ sudo -u git -H bundle exec rake assets:clean assets:precompile cache:clear RAILS_ENV=production\n$ sudo chmod u+rwx,g+rx,o-rwx /home/git/gitlab-satellites\n$ sudo cp lib/support/init.d/gitlab /etc/init.d/gitlab\n```\n\n\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092\u65b0\u30d0\u30fc\u30b8\u30e7\u30f3\u306e\u4ed5\u69d8\u306b\u5408\u3046\u3088\u3046\u306b\u7de8\u96c6\u3057\u307e\u3059\u3002\n\n* Make `/home/git/gitlab/config/gitlab.yml` the same as https://gitlab.com/gitlab-org/gitlab-ce/blob/7-13-stable/config/gitlab.yml.example but with your settings.\n* Make `/home/git/gitlab/config/unicorn.rb` the same as https://gitlab.com/gitlab-org/gitlab-ce/blob/7-13-stable/config/unicorn.rb.example but with your settings.\n* Make `/home/git/gitlab-shell/config.yml` the same as https://gitlab.com/gitlab-org/gitlab-shell/blob/v2.6.0/config.yml.example but with your settings.\n\npuma\u304b\u3089unicorn\u306b\u5909\u66f4\u306b\u306a\u3063\u305f\u3053\u3068\u3082\u3042\u308a\u3001\u3044\u304f\u3064\u304b\u4fee\u6b63\u304c\u5fc5\u8981\u3002\n\n```sh:\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u74b0\u5883\n$ sudo -u git -H cp config/gitlab.yml.example config/gitlab.yml\n$ sudo vim config/gitlab.yml\n# host,email_from\u7b49\u3092\u4fee\u6b63\n\n$ sudo -u git -H cp config/unicorn.rb.example config/unicorn.rb\n\n$ sudo -u git -H cp /home/git/gitlab-shell/config.yml.example /home/git/gitlab-shell/config.yml\n\n$ sudo -u git -H cp config/initializers/rack_attack.rb.example config/initializers/rack_attack.rb\n$ sudo cp lib/support/logrotate/gitlab /etc/logrotate.d/gitlab\n\n$ sudo cp lib/support/nginx/gitlab /etc/nginx/sites-available/gitlab\n$ sudo vim /etc/nginx/sites-available/gitlab\n  listen 80;\n  server_name git-migration.example.com;\n\n$ sudo service gitlab start\n$ sudo service nginx restart\n\n$ sudo -u git -H bundle exec rake gitlab:env:info RAILS_ENV=production\n$ sudo -u git -H bundle exec rake gitlab:check RAILS_ENV=production\n```\n\ngitlab:check\u306b\u6012\u3089\u308c\u305f\u306e\u3067\u3001\u6307\u793a\u306b\u5f93\u3063\u3066\u4f5c\u696d\u3057\u3066\u518d\u30c1\u30a7\u30c3\u30af\u3002\n\n```sh:@\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u74b0\u5883\n$ sudo -u git -H /home/git/gitlab-shell//bin/create-hooks\n$ sudo -u git -H \"/usr/bin/git\" config --global core.autocrlf \"input\"\n\n$ sudo -u git -H bundle exec rake gitlab:check RAILS_ENV=production\n```\n\n\u4ee5\u4e0a\u30677.13\u3078\u306e\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u306f\u5b8c\u4e86\u3002\n\n## 9. \u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u74b0\u5883\u306e\u30c7\u30fc\u30bf\u3092\u65b0\u74b0\u5883\u306b\u53d6\u308a\u8fbc\u307f\n\n[\u516c\u5f0f\u30ac\u30a4\u30c9](https://gitlab.com/gitlab-org/gitlab-ce/blob/master/doc/raketasks/backup_restore.md)\u306b\u5f93\u3063\u3066\u3001\u30c7\u30fc\u30bf\u306e\u30c0\u30f3\u30d7\u3068\u53d6\u308a\u8fbc\u307f\u3092\u884c\u3046\u3002\n\n\u307e\u305a\u306f\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u74b0\u5883\u3067\u30c0\u30f3\u30d7\u3092\u5b9f\u884c\u3002\n\n```sh:@\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u74b0\u5883\n$ cd /home/git/gitlab\n$ sudo -u git -H bundle exec rake gitlab:backup:create RAILS_ENV=production\n```\n\n\u3053\u306e\u30b3\u30de\u30f3\u30c9\u3067`/home/git/gitlab/tmp/backups/XXXXXXXXXX_gitlab_backup.tar`\u304c\u751f\u6210\u3055\u308c\u308b\u306e\u3067\u3001\u65b0\u74b0\u5883\u306b\u8ee2\u9001\u3059\u308b\u3002\n(XXXXXXXXXX\u306f\u30bf\u30a4\u30e0\u30b9\u30bf\u30f3\u30d7\u306a\u306e\u3067\u3001\u5404\u81ea\u306e\u74b0\u5883\u3067\u8aad\u307f\u66ff\u3048\u3066\u4e0b\u3055\u3044\u3002)\n\n\u65b0\u74b0\u5883\u3067\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u30d5\u30a1\u30a4\u30eb\u3092\u6307\u5b9a\u5834\u6240\u306b\u79fb\u52d5\u3057\u3001\u30ea\u30b9\u30c8\u30a2\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3059\u308b\u3002\n\n```sh:@\u65b0\u74b0\u5883\n$ sudo mv /home/hoge/XXXXXXXXXX_gitlab_backup.tar /var/opt/gitlab/backups/\n$ sudo chown git:git /var/opt/gitlab/backups/XXXXXXXXXX_gitlab_backup.tar\n$ sudo gitlab-ctl stop unicorn\n$ sudo gitlab-ctl stop sidekiq\n$ sudo gitlab-rake gitlab:backup:restore BACKUP=XXXXXXXXXX\n$ sudo gitlab-ctl stop\n$ sudo gitlab-ctl start\n```\n\n\u4ee5\u4e0a\u3067\u3001\u65b0\u74b0\u5883\u3078\u306e\u30c7\u30fc\u30bf\u306e\u30a4\u30f3\u30dd\u30fc\u30c8\u306f\u5b8c\u4e86\u3067\u3059\u3002\n", "tags": ["GitLab"]}