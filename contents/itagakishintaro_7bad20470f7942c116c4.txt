{"tags": ["Rails", "docker", "Ruby", "rbenv"], "context": " More than 1 year has passed since last update.\n\nDocker\u306e\u57fa\u672c\n\u4f55\u3068\u306a\u304f\u306f\u77e5\u3063\u3066\u3044\u3066\u3001\u96e3\u3057\u3044\u3053\u3068\u306f\u3061\u3087\u3063\u3068\u3068\u3044\u3046\u4eba\u306f\u3001\u4ee5\u4e0b\u306a\u3069\u3067\u5b9f\u969b\u306b\u624b\u3092\u52d5\u304b\u3057\u3066\u307f\u308b\u3068\u3044\u3044\u3068\u601d\u3046\uff08\u81ea\u5206\u3082\u3088\u304f\u308f\u304b\u3063\u3066\u306a\u3044\uff09\u3002\nDocker \u301cWordPress\u74b0\u5883\u3092\u4f5c\u3063\u3066\u307f\u308b\u3000\u30cf\u30f3\u30ba\u30aa\u30f3\u7de8\u301c\n\nDocker\u3092\u52d5\u304b\u3059\u74b0\u5883\nWindows\u3084Mac\u306e\u5834\u5408\u3001VM\u74b0\u5883\u3092\u7528\u610f\u3059\u308b\u306e\u304c\u4e00\u756a\u7c21\u5358\u3002\n\u4ee5\u4e0b\u306f\u3001VirtualBox\u306bCentOS7\u74b0\u5883\u3092\u7528\u610f\u3059\u308b\u7c21\u5358\u306a\u624b\u9806\u3002\n\nVirtualBox\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\nVirtualBox\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u304b\u3089\u3001VirtualBox\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u3066\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\nCentOS7\u30a4\u30e1\u30fc\u30b8\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\nCentOS7\u30a4\u30e1\u30fc\u30b8\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u304b\u3089\u3001iso\u30a4\u30e1\u30fc\u30b8\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\n\nVirtualBox\u3067CentOS7\u30a4\u30e1\u30fc\u30b8\u304b\u3089\u4eee\u60f3\u30de\u30b7\u30f3\u3092\u8d77\u52d5\n\nVirtualBox => \u65b0\u898f => \u4f5c\u6210\n\u203b\u540d\u524d\u3092CentOS7\u3068\u304b\u306b\u3059\u308b\u3068\u30bf\u30a4\u30d7\u304c\u81ea\u52d5\u3067\u9078\u629e\u3055\u308c\u308b\nVirtualBox => \u8d77\u52d5 => CentOS7\u306eiso\u30a4\u30e1\u30fc\u30b8\u3092\u6307\u5b9a\n!\u30de\u30fc\u30af\u304c\u3064\u3044\u3066\u3044\u308b\u90e8\u5206\u3092\u30c7\u30d5\u30a9\u30eb\u30c8\u3067\u8a2d\u5b9a\n\u300c\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u3068\u30db\u30b9\u30c8\u540d\u300d\u3092ON\u306b\u3059\u308b\n\nVirtualBox => \u8a2d\u5b9a => \u30cd\u30c3\u30c8\u30ef\u30fc\u30af => \u30dd\u30fc\u30c8\u30d5\u30a9\u30ef\u30fc\u30c7\u30a3\u30f3\u30b0\n\n\n\n\u540d\u524d\n\u30db\u30b9\u30c8\u30dd\u30fc\u30c8\n\u30b2\u30b9\u30c8\u30dd\u30fc\u30c8\n\n\n\n\nssh\n2222\n22\n\n\nhttp\n8000\n80\n\n\n\n\nssh\u3067\u30a2\u30af\u30bb\u30b9\nssh -l root -p 2222 localhost\n\n\nDocker\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\nCentOS7\u306e\u4eee\u60f3\u30de\u30b7\u30f3\u4e0a\u3067\u3001\u4ee5\u4e0b\u3092\u5b9f\u884c\nyum -y install docker\nsystemctl enable docker.service\nsystemctl start docker.service\n\n\nDockerfile\u3092\u3064\u304f\u308b\n\nOS\nCentOS7\u306b\u306a\u308b\u3068\u3001\u305d\u306e\u307e\u307e\u3067\u306fsystemctl\u304c\u3046\u307e\u304fDockerfile\u304b\u3089\u8a2d\u5b9a\u3067\u304d\u306a\u3044\u306e\u3067\u3001\u7c21\u5358\u306aCentOS6\u3092\u5165\u308c\u308b\u3002\nFrom centos:centos6\nMAINTAINER [YOURNAME]\n\n# create user\n\nRUN yum -y install passwd\nRUN useradd [USERNAME]\nRUN passwd -f -u [USERNAME]\n\n\n\nPostgreSQL\n\n\nRUN sed -i -e \"s/#bytea_output = 'hex'/bytea_output = 'escape'/g\" /var/lib/pgsql/9.3/data/postgresql.conf\u90e8\u5206\u306fstring contains null byte\u3078\u306e\u5bfe\u5fdc\u306a\u306e\u3067\u3001\u4e0d\u8981\u306a\u3089\u6d88\u3059\u3002\n\nRUN sed -i -e \"s/local   all             all                                     peer/local   all             all                                     md5/g\" /var/lib/pgsql/9.3/data/pg_hba.conf\u306f\u5148\u306b\u5b9f\u884c\u3059\u308b\u3068\u3001createdb.sh\u304c\u52d5\u304b\u306a\u304b\u3063\u305f\u306e\u3067\uff08\u539f\u56e0\u672a\u8abf\u67fb\uff09\u3001\u3057\u304b\u305f\u306a\u304f\u6700\u5f8c\u306b\u3057\u3066\u3044\u308b\u3002\n\n# postgres\n\nRUN rpm -i http://yum.postgresql.org/9.3/redhat/rhel-6-x86_64/pgdg-redhat93-9.3-1.noarch.rpm\nRUN yum -y install postgresql93-server  postgresql93-devel postgresql93-docs postgresql93-libs; yum clean all\n\nRUN chkconfig postgresql-9.3 on\nRUN service postgresql-9.3 initdb\nRUN echo \"host    all             all             0.0.0.0/0               md5\" >> /var/lib/pgsql/9.3/data/pg_hba.conf\nRUN sed -i -e \"s/#bytea_output = 'hex'/bytea_output = 'escape'/g\" /var/lib/pgsql/9.3/data/postgresql.conf\nRUN service postgresql-9.3 start\nADD createdb.sh /createdb.sh\nRUN chmod +x /createdb.sh\nRUN /createdb.sh\nRUN sed -i -e \"s/local   all             all                                     peer/local   all             all                                     md5/g\" /var/lib/pgsql/9.3/data/pg_hba.conf\nRUN service postgresql-9.3 start\n\nEXPOSE 5432\n\n\ncreate.sh\n\n[USERNAME]\u3068[PASSWORD]\u306f\u66f8\u304d\u63db\u3048\n\u3053\u3046\u3044\u3063\u305f\u7d30\u304b\u3044\u4e00\u9023\u306e\u51e6\u7406\u306f\u30b7\u30a7\u30eb\u306b\u3057\u3066ADD & RUN\u3059\u308b\u306e\u304c\u3088\u3044\u3089\u3057\u3044\n\n\ncreate.sh\n#!/bin/bash\n\n__mod_user() {\nusermod -G wheel postgres\n}\n\n__create_db() {\nsu --login postgres --command \"/usr/pgsql-9.3/bin/postgres -D /var/lib/pgsql/9.3/data -p 5432\" &\nsleep 10\nps aux\n\nsu --login - postgres --command \"psql -c \\\"CREATE USER [USERNAME] with CREATEROLE superuser PASSWORD '[PASSWORD]';\\\"\"\nsu --login - postgres --command \"psql -c \\\"CREATE DATABASE [USERNAME] OWNER [USERNAME];\\\"\"\nsu --login - postgres --command \"psql -c \\\"\\du;\\\"\"\n}\n\n# Call functions\n__mod_user\n__create_db\n\n\n\nApache\n# httpd\n\nRUN yum -y update && yum clean all\nRUN yum -y install httpd && yum clean all\n\nRUN chkconfig httpd on\nRUN service httpd start\n\nEXPOSE 80\n\n\nrbenv & ruby\n\n\nruby\u3092\u53c2\u8003\u306b\u3057\u3066\u3044\u308b\n\n# install rbenv\n\nRUN yum -y install git make tar\n# https://github.com/sstephenson/ruby-build/wiki#suggested-build-environment\nRUN yum -y install gcc openssl-devel libyaml-devel libffi-devel readline-devel zlib-devel gdbm-devel ncurses-devel\n\nRUN git clone https://github.com/sstephenson/rbenv.git /usr/local/rbenv\nRUN echo '# rbenv setup' > /etc/profile.d/rbenv.sh\nRUN echo 'export RBENV_ROOT=/usr/local/rbenv' >> /etc/profile.d/rbenv.sh\nRUN echo 'export PATH=\"$RBENV_ROOT/bin:$PATH\"' >> /etc/profile.d/rbenv.sh\nRUN echo 'eval \"$(rbenv init -)\"' >> /etc/profile.d/rbenv.sh\nRUN chmod +x /etc/profile.d/rbenv.sh\n\n# install ruby-build\n\nRUN mkdir /usr/local/rbenv/plugins\nRUN git clone https://github.com/sstephenson/ruby-build.git /usr/local/rbenv/plugins/ruby-build\nENV RBENV_ROOT /usr/local/rbenv\nENV PATH \"$RBENV_ROOT/bin:$RBENV_ROOT/shims:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin\"\n# does not work. PATH is set to\n# $RBENV_ROOT/shims:$RBENV_ROOT/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin\n\n# install ruby\n\nRUN rbenv --version\nRUN rbenv install 2.2.0\nRUN rbenv global 2.2.0\nRUN ruby -v\nRUN rbenv rehash\n\n\nPassenger\n# passenger\n\nRUN gem install passenger --no-ri --no-rdoc -V\nRUN yum -y install libcurl-devel httpd-devel gcc-c++\nRUN exit\nRUN passenger-install-apache2-module\n\n\nhttpd.conf\u306e\u8a2d\u5b9a\n\n\u3042\u3089\u304b\u3058\u3081\u3064\u304f\u3063\u3066\u304a\u3044\u305fhttpd.conf\u3092Add & RUN\u3057\u3066\u3082\u3044\u3044\u304b\u3082\u3057\u308c\u306a\u3044\npassenger_module\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306fruby\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u306b\u3088\u3063\u3066\u5909\u308f\u308b\u306e\u3067\u6ce8\u610f\n\n[USERNAME]\u3001[YOUR_RAILS_APP_NAME]\u3001[ENVNAME]\u306f\u66f8\u304d\u63db\u3048\n\n# set httpd.conf\n\nRUN sed -i -e 's/DocumentRoot \"\\/var\\/www\\/html\"/DocumentRoot \"\\/home\\/[USERNAME]\\/[YOUR_RAILS_APP_NAME]\\/public\"/g' /etc/httpd/conf/httpd.conf\nRUN echo '<Directory \"/home/[USERNAME]/[YOUR_RAILS_APP_NAME]/public\">' >> /etc/httpd/conf/httpd.conf\nRUN echo 'Options -Indexes FollowSymLinks' >> /etc/httpd/conf/httpd.conf\nRUN echo 'AllowOverride All' >> /etc/httpd/conf/httpd.conf\nRUN echo '</Directory>' >> /etc/httpd/conf/httpd.conf\n\nRUN cp -p /etc/httpd/conf/httpd.conf /etc/httpd/conf/httpd.conf.org\nRUN sed -i -e \"s/AddDefaultCharset UTF-8/# AddDefaultCharset UTF-8/g\" /etc/httpd/conf/httpd.conf\nRUN echo 'LoadModule passenger_module /usr/local/rbenv/versions/2.2.0/lib/ruby/gems/2.2.0/gems/passenger-5.0.21/buildout/apache2/mod_passenger.so' >> /etc/httpd/conf/httpd.conf\nRUN echo '<IfModule mod_passenger.c>' >> /etc/httpd/conf/httpd.conf\nRUN echo '  PassengerRoot /usr/local/rbenv/versions/2.2.0/lib/ruby/gems/2.2.0/gems/passenger-5.0.21' >> /etc/httpd/conf/httpd.conf\nRUN echo '  PassengerDefaultRuby /usr/local/rbenv/shims/ruby' >> /etc/httpd/conf/httpd.conf\nRUN echo '</IfModule>' >> /etc/httpd/conf/httpd.conf\nRUN echo 'RailsEnv [ENVNAME]' >> /etc/httpd/conf/httpd.conf\n\n\nRAILS\u30a2\u30d7\u30ea\u3092clone\n\n\n[USERNAME]\u3001[YOUR_RAILS_APP_NAME]\u3001[ENVNAME]\u306f\u66f8\u304d\u63db\u3048\n\n# install [YOUR_RAILS_APP_NAME]\n\nRUN yum -y install libxml2-devel libxslt-devel libpq-dev postgresql-devel sqlite-devel\nRUN git clone [YOUR_RAILS_APP_GITHUB_URL] /home/[USERNAME]/[YOUR_RAILS_APP_NAME]\nRUN chown -R [USERNAME] /home/[USERNAME]/[YOUR_RAILS_APP_NAME]\nRUN chmod +x /home/[USERNAME]\nRUN gem install bundler\n\nADD ./run.sh /home/[USERNAME]/run.sh\nRUN chmod -v +x /home/[USERNAME]/run.sh\nRUN chown pr /home/[USERNAME]/run.sh\n\n\nrun.sh\n#!/bin/bash\n\ncd /home/[USERNAME]/[YOUR_RAILS_APP_NAME]\n# http://ayumu-homes.hateblo.jp/entry/2015/02/08/174838\ngem install nokogiri -- --use-system-libraries=true --with-xml2-include=/usr/include/libxml2/\nbundle install --without test development\nbundle update\nbundle exec rake db:migrate RAILS_ENV=[ENVNAME]\nbundle exec rake db:seed RAILS_ENV=[ENVNAME]\n\n\n\npostgresql\u3068apache\u306e\u30b5\u30fc\u30d3\u30b9\u8d77\u52d5\n#start service script\nRUN echo -e \"service postgresql-9.3 start\\nservice httpd start\\n/bin/bash\" > /start_service.sh\nRUN chmod o+x /start_service.sh\n\nCMD [\"/start_service.sh\"]\n\n\nDockerfile\u306e\u30d3\u30eb\u30c9\ndocker build -t [YOURNAME]/[YOUR_APP_NAME] ~/[DOCKERFILE_DIRECTORY]\n\n\nDocker\u30b3\u30f3\u30c6\u30ca\u306e\u8d77\u52d5\n\n\ndocker exec -it [YOUR_APP_NAME] /home/[USERNAME]/run.sh\u306fDockerfile\u3067\u52d5\u304b\u3059\u3068\u3046\u307e\u304f\u3044\u304b\u306a\u304b\u3063\u305f\uff08\u539f\u56e0\u4e0d\u660e\uff09\u306e\u3067\u3001\u3053\u3053\u3067\u5b9f\u884c\u3057\u3066\u3044\u308b\n\n[YOURNAME]\u3001[YOUR_APP_NAME]\u3001[DOCKERFILE_DIRECTORY]\u3001[USERNAME]\u306f\u66f8\u304d\u63db\u3048\n\ndocker build -t [YOURNAME]/[YOUR_APP_NAME] [DOCKERFILE_DIRECTORY]\ndocker run --privileged -d -p 80:80 --name [YOUR_APP_NAME] [YOURNAME]/[YOUR_APP_NAME] /sbin/init\ndocker exec -it [YOUR_APP_NAME] /home/[USERNAME]/run.sh\n\n\n\u30a2\u30af\u30bb\u30b9\n\u30d6\u30e9\u30a6\u30b6\u30fc\u304b\u3089\u30a2\u30af\u30bb\u30b9\nhttp://localhost:8000\n\n\nDocker\u30b3\u30f3\u30c6\u30ca\u30a4\u30e1\u30fc\u30b8\u306ecommit & push\n\n\u4e8b\u524d\u306bDocker Hub\u306e\u30a2\u30ab\u30a6\u30f3\u30c8\u3092\u4f5c\u6210\u3059\u308b\n\n[YOUR_APP_NAME]\u3001[DOCKER_HUB_ACCOUNT_NAME]\u306f\u66f8\u304d\u63db\u3048\n\ndocker commit [YOUR_APP_NAME] [DOCKER_HUB_ACCOUNT_NAME]/[YOUR_APP_NAME]\ndocker login\ndocker push [DOCKER_HUB_ACCOUNT_NAME]/[YOUR_APP_NAME]\n\n\n\nDcoker\u30b3\u30f3\u30c6\u30ca\u306e\u505c\u6b62\u3068\u524a\u9664\ndocker stop [YOUR_APP_NAME]\ndocker rm `docker ps -a -q`\ndocker rmi $(docker images | awk '/^<none>/ { print $3 }')\n\n\nDocker\u30b3\u30f3\u30c6\u30ca\u30a4\u30e1\u30fc\u30b8\u306epull\n\n\n[YOUR_APP_NAME]\u3001[DOCKER_HUB_ACCOUNT_NAME]\u306f\u66f8\u304d\u63db\u3048\n\ndocker pull -a [DOCKER_HUB_ACCOUNT_NAME]/[YOUR_APP_NAME]\ndocker run --privileged -d -p 80:80 --name [YOUR_APP_NAME] [YOURNAME]/[YOUR_APP_NAME] /sbin/init\n\n\n\u30b5\u30f3\u30d7\u30eb\nhttps://github.com/itagakishintaro/ProgressReport\n\n# Docker\u306e\u57fa\u672c\n\n\u4f55\u3068\u306a\u304f\u306f\u77e5\u3063\u3066\u3044\u3066\u3001\u96e3\u3057\u3044\u3053\u3068\u306f\u3061\u3087\u3063\u3068\u3068\u3044\u3046\u4eba\u306f\u3001\u4ee5\u4e0b\u306a\u3069\u3067\u5b9f\u969b\u306b\u624b\u3092\u52d5\u304b\u3057\u3066\u307f\u308b\u3068\u3044\u3044\u3068\u601d\u3046\uff08\u81ea\u5206\u3082\u3088\u304f\u308f\u304b\u3063\u3066\u306a\u3044\uff09\u3002\n\n[Docker \u301cWordPress\u74b0\u5883\u3092\u4f5c\u3063\u3066\u307f\u308b\u3000\u30cf\u30f3\u30ba\u30aa\u30f3\u7de8\u301c](http://www.slideshare.net/cyberblackvoom?utm_campaign=profiletracking&utm_medium=sssite&utm_source=ssslideview)\n\n# Docker\u3092\u52d5\u304b\u3059\u74b0\u5883\n\nWindows\u3084Mac\u306e\u5834\u5408\u3001VM\u74b0\u5883\u3092\u7528\u610f\u3059\u308b\u306e\u304c\u4e00\u756a\u7c21\u5358\u3002\n\u4ee5\u4e0b\u306f\u3001VirtualBox\u306bCentOS7\u74b0\u5883\u3092\u7528\u610f\u3059\u308b\u7c21\u5358\u306a\u624b\u9806\u3002\n\n## VirtualBox\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n[VirtualBox\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9](https://www.virtualbox.org/wiki/Downloads)\u304b\u3089\u3001VirtualBox\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u3066\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n## CentOS7\u30a4\u30e1\u30fc\u30b8\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\n\n[CentOS7\u30a4\u30e1\u30fc\u30b8\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9](http://isoredirect.centos.org/centos/7/isos/x86_64/CentOS-7-x86_64-DVD-1503-01.iso)\u304b\u3089\u3001iso\u30a4\u30e1\u30fc\u30b8\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\n\n## VirtualBox\u3067CentOS7\u30a4\u30e1\u30fc\u30b8\u304b\u3089\u4eee\u60f3\u30de\u30b7\u30f3\u3092\u8d77\u52d5\n\n1. VirtualBox => \u65b0\u898f => \u4f5c\u6210\n\u203b\u540d\u524d\u3092CentOS7\u3068\u304b\u306b\u3059\u308b\u3068\u30bf\u30a4\u30d7\u304c\u81ea\u52d5\u3067\u9078\u629e\u3055\u308c\u308b\n\n2. VirtualBox => \u8d77\u52d5 => CentOS7\u306eiso\u30a4\u30e1\u30fc\u30b8\u3092\u6307\u5b9a\n3. !\u30de\u30fc\u30af\u304c\u3064\u3044\u3066\u3044\u308b\u90e8\u5206\u3092\u30c7\u30d5\u30a9\u30eb\u30c8\u3067\u8a2d\u5b9a\n4. \u300c\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u3068\u30db\u30b9\u30c8\u540d\u300d\u3092ON\u306b\u3059\u308b\n5. VirtualBox => \u8a2d\u5b9a => \u30cd\u30c3\u30c8\u30ef\u30fc\u30af => \u30dd\u30fc\u30c8\u30d5\u30a9\u30ef\u30fc\u30c7\u30a3\u30f3\u30b0\n\n\t| \u540d\u524d | \u30db\u30b9\u30c8\u30dd\u30fc\u30c8 | \u30b2\u30b9\u30c8\u30dd\u30fc\u30c8 |\n\t| --- | --- | --- |\n\t| ssh | 2222 | 22 |\n\t| http | 8000 | 80 |\n\n6. ssh\u3067\u30a2\u30af\u30bb\u30b9\n`ssh -l root -p 2222 localhost`\n\n# Docker\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\nCentOS7\u306e\u4eee\u60f3\u30de\u30b7\u30f3\u4e0a\u3067\u3001\u4ee5\u4e0b\u3092\u5b9f\u884c\n\n```bash\nyum -y install docker\nsystemctl enable docker.service\nsystemctl start docker.service\n```\n\n# Dockerfile\u3092\u3064\u304f\u308b\n\n## OS\n\nCentOS7\u306b\u306a\u308b\u3068\u3001\u305d\u306e\u307e\u307e\u3067\u306fsystemctl\u304c\u3046\u307e\u304fDockerfile\u304b\u3089\u8a2d\u5b9a\u3067\u304d\u306a\u3044\u306e\u3067\u3001\u7c21\u5358\u306aCentOS6\u3092\u5165\u308c\u308b\u3002\n\n```Dockerfile\nFrom centos:centos6\nMAINTAINER [YOURNAME]\n\n# create user\n\nRUN yum -y install passwd\nRUN useradd [USERNAME]\nRUN passwd -f -u [USERNAME]\n\n```\n\n## PostgreSQL\n\n\n* `RUN sed -i -e \"s/#bytea_output = 'hex'/bytea_output = 'escape'/g\" /var/lib/pgsql/9.3/data/postgresql.conf`\u90e8\u5206\u306f[string contains null byte\u3078\u306e\u5bfe\u5fdc](http://tkm9.hateblo.jp/entry/2015/02/17/210353)\u306a\u306e\u3067\u3001\u4e0d\u8981\u306a\u3089\u6d88\u3059\u3002\n* `RUN sed -i -e \"s/local   all             all                                     peer/local   all             all                                     md5/g\" /var/lib/pgsql/9.3/data/pg_hba.conf`\u306f\u5148\u306b\u5b9f\u884c\u3059\u308b\u3068\u3001createdb.sh\u304c\u52d5\u304b\u306a\u304b\u3063\u305f\u306e\u3067\uff08\u539f\u56e0\u672a\u8abf\u67fb\uff09\u3001\u3057\u304b\u305f\u306a\u304f\u6700\u5f8c\u306b\u3057\u3066\u3044\u308b\u3002\n\n\n```Dockerfile\n# postgres\n\nRUN rpm -i http://yum.postgresql.org/9.3/redhat/rhel-6-x86_64/pgdg-redhat93-9.3-1.noarch.rpm\nRUN yum -y install postgresql93-server  postgresql93-devel postgresql93-docs postgresql93-libs; yum clean all\n\nRUN chkconfig postgresql-9.3 on\nRUN service postgresql-9.3 initdb\nRUN echo \"host    all             all             0.0.0.0/0               md5\" >> /var/lib/pgsql/9.3/data/pg_hba.conf\nRUN sed -i -e \"s/#bytea_output = 'hex'/bytea_output = 'escape'/g\" /var/lib/pgsql/9.3/data/postgresql.conf\nRUN service postgresql-9.3 start\nADD createdb.sh /createdb.sh\nRUN chmod +x /createdb.sh\nRUN /createdb.sh\nRUN sed -i -e \"s/local   all             all                                     peer/local   all             all                                     md5/g\" /var/lib/pgsql/9.3/data/pg_hba.conf\nRUN service postgresql-9.3 start\n\nEXPOSE 5432\n```\n\n* create.sh\n* `[USERNAME]`\u3068`[PASSWORD]`\u306f\u66f8\u304d\u63db\u3048\n* \u3053\u3046\u3044\u3063\u305f\u7d30\u304b\u3044\u4e00\u9023\u306e\u51e6\u7406\u306f\u30b7\u30a7\u30eb\u306b\u3057\u3066ADD & RUN\u3059\u308b\u306e\u304c\u3088\u3044\u3089\u3057\u3044\n\n```create.sh\n#!/bin/bash\n\n__mod_user() {\nusermod -G wheel postgres\n}\n\n__create_db() {\nsu --login postgres --command \"/usr/pgsql-9.3/bin/postgres -D /var/lib/pgsql/9.3/data -p 5432\" &\nsleep 10\nps aux\n\nsu --login - postgres --command \"psql -c \\\"CREATE USER [USERNAME] with CREATEROLE superuser PASSWORD '[PASSWORD]';\\\"\"\nsu --login - postgres --command \"psql -c \\\"CREATE DATABASE [USERNAME] OWNER [USERNAME];\\\"\"\nsu --login - postgres --command \"psql -c \\\"\\du;\\\"\"\n}\n\n# Call functions\n__mod_user\n__create_db\n```\n\n## Apache\n\n```Dockerfile\n# httpd\n\nRUN yum -y update && yum clean all\nRUN yum -y install httpd && yum clean all\n\nRUN chkconfig httpd on\nRUN service httpd start\n\nEXPOSE 80\n```\n\n## rbenv & ruby\n\n* [ruby](https://gist.github.com/deepak/5925003)\u3092\u53c2\u8003\u306b\u3057\u3066\u3044\u308b\n\n```Dockerfile\n# install rbenv\n\nRUN yum -y install git make tar\n# https://github.com/sstephenson/ruby-build/wiki#suggested-build-environment\nRUN yum -y install gcc openssl-devel libyaml-devel libffi-devel readline-devel zlib-devel gdbm-devel ncurses-devel\n\nRUN git clone https://github.com/sstephenson/rbenv.git /usr/local/rbenv\nRUN echo '# rbenv setup' > /etc/profile.d/rbenv.sh\nRUN echo 'export RBENV_ROOT=/usr/local/rbenv' >> /etc/profile.d/rbenv.sh\nRUN echo 'export PATH=\"$RBENV_ROOT/bin:$PATH\"' >> /etc/profile.d/rbenv.sh\nRUN echo 'eval \"$(rbenv init -)\"' >> /etc/profile.d/rbenv.sh\nRUN chmod +x /etc/profile.d/rbenv.sh\n\n# install ruby-build\n\nRUN mkdir /usr/local/rbenv/plugins\nRUN git clone https://github.com/sstephenson/ruby-build.git /usr/local/rbenv/plugins/ruby-build\nENV RBENV_ROOT /usr/local/rbenv\nENV PATH \"$RBENV_ROOT/bin:$RBENV_ROOT/shims:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin\"\n# does not work. PATH is set to\n# $RBENV_ROOT/shims:$RBENV_ROOT/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin\n\n# install ruby\n\nRUN rbenv --version\nRUN rbenv install 2.2.0\nRUN rbenv global 2.2.0\nRUN ruby -v\nRUN rbenv rehash\n```\n\n## Passenger\n\n```Dockerfile\n# passenger\n\nRUN gem install passenger --no-ri --no-rdoc -V\nRUN yum -y install libcurl-devel httpd-devel gcc-c++\nRUN exit\nRUN passenger-install-apache2-module\n```\n\n## httpd.conf\u306e\u8a2d\u5b9a\n\n* \u3042\u3089\u304b\u3058\u3081\u3064\u304f\u3063\u3066\u304a\u3044\u305fhttpd.conf\u3092Add & RUN\u3057\u3066\u3082\u3044\u3044\u304b\u3082\u3057\u308c\u306a\u3044\n* passenger_module\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306fruby\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u306b\u3088\u3063\u3066\u5909\u308f\u308b\u306e\u3067\u6ce8\u610f\n* `[USERNAME]`\u3001`[YOUR_RAILS_APP_NAME]`\u3001`[ENVNAME]`\u306f\u66f8\u304d\u63db\u3048\n\n```Dockerfile\n# set httpd.conf\n\nRUN sed -i -e 's/DocumentRoot \"\\/var\\/www\\/html\"/DocumentRoot \"\\/home\\/[USERNAME]\\/[YOUR_RAILS_APP_NAME]\\/public\"/g' /etc/httpd/conf/httpd.conf\nRUN echo '<Directory \"/home/[USERNAME]/[YOUR_RAILS_APP_NAME]/public\">' >> /etc/httpd/conf/httpd.conf\nRUN echo 'Options -Indexes FollowSymLinks' >> /etc/httpd/conf/httpd.conf\nRUN echo 'AllowOverride All' >> /etc/httpd/conf/httpd.conf\nRUN echo '</Directory>' >> /etc/httpd/conf/httpd.conf\n\nRUN cp -p /etc/httpd/conf/httpd.conf /etc/httpd/conf/httpd.conf.org\nRUN sed -i -e \"s/AddDefaultCharset UTF-8/# AddDefaultCharset UTF-8/g\" /etc/httpd/conf/httpd.conf\nRUN echo 'LoadModule passenger_module /usr/local/rbenv/versions/2.2.0/lib/ruby/gems/2.2.0/gems/passenger-5.0.21/buildout/apache2/mod_passenger.so' >> /etc/httpd/conf/httpd.conf\nRUN echo '<IfModule mod_passenger.c>' >> /etc/httpd/conf/httpd.conf\nRUN echo '  PassengerRoot /usr/local/rbenv/versions/2.2.0/lib/ruby/gems/2.2.0/gems/passenger-5.0.21' >> /etc/httpd/conf/httpd.conf\nRUN echo '  PassengerDefaultRuby /usr/local/rbenv/shims/ruby' >> /etc/httpd/conf/httpd.conf\nRUN echo '</IfModule>' >> /etc/httpd/conf/httpd.conf\nRUN echo 'RailsEnv [ENVNAME]' >> /etc/httpd/conf/httpd.conf\n```\n\n## RAILS\u30a2\u30d7\u30ea\u3092clone\n\n* `[USERNAME]`\u3001`[YOUR_RAILS_APP_NAME]`\u3001`[ENVNAME]`\u306f\u66f8\u304d\u63db\u3048\n\n```Dockerfile\n# install [YOUR_RAILS_APP_NAME]\n\nRUN yum -y install libxml2-devel libxslt-devel libpq-dev postgresql-devel sqlite-devel\nRUN git clone [YOUR_RAILS_APP_GITHUB_URL] /home/[USERNAME]/[YOUR_RAILS_APP_NAME]\nRUN chown -R [USERNAME] /home/[USERNAME]/[YOUR_RAILS_APP_NAME]\nRUN chmod +x /home/[USERNAME]\nRUN gem install bundler\n\nADD ./run.sh /home/[USERNAME]/run.sh\nRUN chmod -v +x /home/[USERNAME]/run.sh\nRUN chown pr /home/[USERNAME]/run.sh\n```\n\n```run.sh\n#!/bin/bash\n\ncd /home/[USERNAME]/[YOUR_RAILS_APP_NAME]\n# http://ayumu-homes.hateblo.jp/entry/2015/02/08/174838\ngem install nokogiri -- --use-system-libraries=true --with-xml2-include=/usr/include/libxml2/\nbundle install --without test development\nbundle update\nbundle exec rake db:migrate RAILS_ENV=[ENVNAME]\nbundle exec rake db:seed RAILS_ENV=[ENVNAME]\n```\n\n## postgresql\u3068apache\u306e\u30b5\u30fc\u30d3\u30b9\u8d77\u52d5\n\n```Dockerfile\n#start service script\nRUN echo -e \"service postgresql-9.3 start\\nservice httpd start\\n/bin/bash\" > /start_service.sh\nRUN chmod o+x /start_service.sh\n\nCMD [\"/start_service.sh\"]\n```\n\n# Dockerfile\u306e\u30d3\u30eb\u30c9\n\n```\ndocker build -t [YOURNAME]/[YOUR_APP_NAME] ~/[DOCKERFILE_DIRECTORY]\n```\n\n# Docker\u30b3\u30f3\u30c6\u30ca\u306e\u8d77\u52d5\n\n* `docker exec -it [YOUR_APP_NAME] /home/[USERNAME]/run.sh`\u306fDockerfile\u3067\u52d5\u304b\u3059\u3068\u3046\u307e\u304f\u3044\u304b\u306a\u304b\u3063\u305f\uff08\u539f\u56e0\u4e0d\u660e\uff09\u306e\u3067\u3001\u3053\u3053\u3067\u5b9f\u884c\u3057\u3066\u3044\u308b\n* `[YOURNAME]`\u3001`[YOUR_APP_NAME]`\u3001`[DOCKERFILE_DIRECTORY]`\u3001`[USERNAME]`\u306f\u66f8\u304d\u63db\u3048\n\n```\ndocker build -t [YOURNAME]/[YOUR_APP_NAME] [DOCKERFILE_DIRECTORY]\ndocker run --privileged -d -p 80:80 --name [YOUR_APP_NAME] [YOURNAME]/[YOUR_APP_NAME] /sbin/init\ndocker exec -it [YOUR_APP_NAME] /home/[USERNAME]/run.sh\n```\n\n# \u30a2\u30af\u30bb\u30b9\n\n\u30d6\u30e9\u30a6\u30b6\u30fc\u304b\u3089\u30a2\u30af\u30bb\u30b9\n\n```\nhttp://localhost:8000\n```\n\n# Docker\u30b3\u30f3\u30c6\u30ca\u30a4\u30e1\u30fc\u30b8\u306ecommit & push\n\n* \u4e8b\u524d\u306b[Docker Hub](https://hub.docker.com/)\u306e\u30a2\u30ab\u30a6\u30f3\u30c8\u3092\u4f5c\u6210\u3059\u308b\n* `[YOUR_APP_NAME]`\u3001`[DOCKER_HUB_ACCOUNT_NAME]`\u306f\u66f8\u304d\u63db\u3048\n\n```\ndocker commit [YOUR_APP_NAME] [DOCKER_HUB_ACCOUNT_NAME]/[YOUR_APP_NAME]\ndocker login\ndocker push [DOCKER_HUB_ACCOUNT_NAME]/[YOUR_APP_NAME]\n\n```\n\n\n# Dcoker\u30b3\u30f3\u30c6\u30ca\u306e\u505c\u6b62\u3068\u524a\u9664\n\n```\ndocker stop [YOUR_APP_NAME]\ndocker rm `docker ps -a -q`\ndocker rmi $(docker images | awk '/^<none>/ { print $3 }')\n```\n\n# Docker\u30b3\u30f3\u30c6\u30ca\u30a4\u30e1\u30fc\u30b8\u306epull\n\n* `[YOUR_APP_NAME]`\u3001`[DOCKER_HUB_ACCOUNT_NAME]`\u306f\u66f8\u304d\u63db\u3048\n\n```\ndocker pull -a [DOCKER_HUB_ACCOUNT_NAME]/[YOUR_APP_NAME]\ndocker run --privileged -d -p 80:80 --name [YOUR_APP_NAME] [YOURNAME]/[YOUR_APP_NAME] /sbin/init\n```\n\n# \u30b5\u30f3\u30d7\u30eb\n\nhttps://github.com/itagakishintaro/ProgressReport\n"}