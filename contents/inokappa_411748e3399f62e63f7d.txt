{"context": "\u3053\u3061\u3089\u3088\u308a\u8ee2\u8f09\u3002\n\n\u304d\u3083\u3074\u304d\u3083\u3074\n\u3057\u3066\u307e\u3059\u304b\u3002\nCapistrano \u306f\u30d0\u30fc\u30b8\u30e7\u30f3 2 \u306e\u6642\u4ee3\u306b\u5c11\u3057\u89e6\u3063\u305f\u3053\u3068\u304c\u3042\u3063\u305f\u3093\u3067\u3059\u304c\u3001\u6539\u3081\u3066 Capistrano 3 \u3092\u7528\u3044\u3066 EC2 Name \u30bf\u30b0\u3067\u64cd\u4f5c\u5bfe\u8c61\u3092\u7d5e\u308a\u8fbc\u3093\u3067\u30b3\u30de\u30f3\u30c9\u64cd\u4f5c\u3057\u3066\u307f\u305f\u3044\u3068\u601d\u3044\u307e\u3059\u3002\n\n\u53c2\u8003\n\nhttp://capistranorb.com/documentation/getting-started/configuration/#\nhttps://labs.gree.jp/blog/2013/12/10084/\n\n\n\u30e1\u30e2\n\n\u3084\u308a\u305f\u3044\u3053\u3068\n\nEC2 \u30bf\u30b0\u540d\u304b\u3089 IP \u30a2\u30c9\u30ec\u30b9\u3092\u53d6\u5f97\u3057\u3066\u304d\u3066\u3001\u4f55\u3089\u304b\u306e\u30b3\u30de\u30f3\u30c9\u3092\u6d41\u3057\u8fbc\u3080\n\n\n\u6e96\u5099\nbash-3.2$ cat Gemfile\n# A sample Gemfile\nsource \"https://rubygems.org\"\n\n# gem \"rails\"\n\ngem 'capistrano'\ngem 'aws-sdk'\n\nbundle install \u3057\u307e\u3057\u3087\u3046\u3002\nbundle install --path vendor/bundle\n\n\n\u30d5\u30a1\u30a4\u30eb\u9054\nbash-3.2$ tree -L 3\n.\n\u251c\u2500\u2500 Capfile\n\u251c\u2500\u2500 Gemfile\n\u251c\u2500\u2500 Gemfile.lock\n\u251c\u2500\u2500 config\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 deploy\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 dev.rb\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 production.rb\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2514\u2500\u2500 staging.rb\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 deploy.rb\n\u251c\u2500\u2500 lib\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 capistrano\n\u2502\u00a0\u00a0     \u2514\u2500\u2500 tasks\n\u251c\u2500\u2500 log\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 capistrano.log\n\u2514\u2500\u2500 vendor\n    \u2514\u2500\u2500 bundle\n        \u2514\u2500\u2500 ruby\n\n\nconfig/deploy.rb\n\u30b0\u30ed\u30fc\u30d0\u30eb\u306a\u8a2d\u5b9a\u306f config/deploy.rb \u306b\u66f8\u304d\u307e\u3057\u3087\u3046\u3002\nrequire 'aws-sdk'\n\nset :aws_region, 'ap-northeast-1'\nset :aws_profile, 'your_profile'\n\ndef ec2\n  Aws::EC2::Client.new(\n    region: fetch(:aws_region),\n    profile: fetch(:aws_profile)\n  )\nend\n\ndef get_ec2_instances(name)\n  hosts = []\n  ec2.describe_instances(\n    filters:[\n      { name: \"tag:Name\", values: [name]},\n      { name: \"instance-state-name\", values: [\"running\"]}\n    ]).reservations.each do |reservation|\n    reservation.instances.each do |instance|\n      hosts << instance.public_ip_address\n    end\n  end\n  return hosts\nend\n\n# run_locally \u3067 echo \"demo\" \u3092\u5b9f\u884c\u3059\u308b\n# :app Role \u3092\u5bfe\u8c61\u3068\u3057\u3066 pwd \u3068 uptime \u3092\u5b9f\u884c\u3059\u308b\nnamespace :demo do\n  desc 'uptime \u3092\u5b9f\u884c'\n  task :uptime do\n    run_locally do\n      execute 'echo \"demo\"'\n    end\n    on roles(:app) do\n      execute 'pwd'\n      execute 'uptime'\n    end\n  end\nend\n\nset :foo \u3067\u5b9a\u7fa9\u3057\u305f\u5024\u306f fetch :foo \u3067\u53d6\u5f97\u51fa\u6765\u308b\u3002\n\nconfig/deploy/dev.rb\n\u74b0\u5883\u6bce\u306e\u8a2d\u5b9a\u306f config/deploy/*.rb \u306b\u8a18\u8f09\u3057\u307e\u3057\u3087\u3046\u3002\n# \u30a4\u30f3\u30b9\u30bf\u30f3\u30b9 Name \u30bf\u30b0\u306b dev- \u304c\u542b\u307e\u308c\u3066\u3044\u308b\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e Public IP \u3092\u53d6\u5f97\u3059\u308b\nhosts = get_ec2_instances('dev-*')\nrole :app, hosts\n\nset :ssh_options, {\n  user: %w(user),\n  keys: %w(/Path/to/key.pem)\n}\n\n\n\u5b9f\u884c\n\n\u30bf\u30b9\u30af\u3092\u78ba\u8a8d\n\nbash-3.2$ bundle exec cap dev -T | grep demo\ncap demo:uptime                    # uptime \u3092\u5b9f\u884c\n\n\n\u30bf\u30b9\u30af\u3092\u5b9f\u884c\n\nbash-3.2$ bundle exec cap dev demo:uptime\n00:00 demo:uptime\n      01 echo \"demo\"\n      01 demo\n    \u2714 01 kawahara@localhost 0.013s\n      02 pwd\n      02 /home/ssh_user\n    \u2714 02 ssh_user@xx.xxx.xx.xx1 0.736s\n      03 uptime\n      02 /home/ssh_user\n    \u2714 02 ssh_user@xx.xxx.xx.xx2 0.775s\n      03  14:54:24 up 27 min,  0 users,  load average: 0.00, 0.00, 0.00\n    \u2714 03 ssh_user@xx.xxx.xx.xx1 0.612s\n      03  14:54:24 up 27 min,  0 users,  load average: 0.00, 0.01, 0.04\n    \u2714 03 ssh_user@xx.xxx.xx.xx2 0.688s\n\n\n\u4ee5\u4e0a\n\u30e1\u30e2\u3067\u3057\u305f\u3002\n[\u3053\u3061\u3089](http://inokara.hateblo.jp/entry/2016/11/27/150817)\u3088\u308a\u8ee2\u8f09\u3002\n\n## \u304d\u3083\u3074\u304d\u3083\u3074\n\n\u3057\u3066\u307e\u3059\u304b\u3002\n\nCapistrano \u306f\u30d0\u30fc\u30b8\u30e7\u30f3 2 \u306e\u6642\u4ee3\u306b\u5c11\u3057\u89e6\u3063\u305f\u3053\u3068\u304c\u3042\u3063\u305f\u3093\u3067\u3059\u304c\u3001\u6539\u3081\u3066 Capistrano 3 \u3092\u7528\u3044\u3066 EC2 Name \u30bf\u30b0\u3067\u64cd\u4f5c\u5bfe\u8c61\u3092\u7d5e\u308a\u8fbc\u3093\u3067\u30b3\u30de\u30f3\u30c9\u64cd\u4f5c\u3057\u3066\u307f\u305f\u3044\u3068\u601d\u3044\u307e\u3059\u3002\n\n## \u53c2\u8003\n\n- http://capistranorb.com/documentation/getting-started/configuration/#\n- https://labs.gree.jp/blog/2013/12/10084/\n\n## \u30e1\u30e2\n\n### \u3084\u308a\u305f\u3044\u3053\u3068\n\n- EC2 \u30bf\u30b0\u540d\u304b\u3089 IP \u30a2\u30c9\u30ec\u30b9\u3092\u53d6\u5f97\u3057\u3066\u304d\u3066\u3001\u4f55\u3089\u304b\u306e\u30b3\u30de\u30f3\u30c9\u3092\u6d41\u3057\u8fbc\u3080\n\n### \u6e96\u5099\n\n```sh\nbash-3.2$ cat Gemfile\n# A sample Gemfile\nsource \"https://rubygems.org\"\n\n# gem \"rails\"\n\ngem 'capistrano'\ngem 'aws-sdk'\n```\n\n`bundle install` \u3057\u307e\u3057\u3087\u3046\u3002\n\n```sh\nbundle install --path vendor/bundle\n```\n\n### \u30d5\u30a1\u30a4\u30eb\u9054\n\n```sh\nbash-3.2$ tree -L 3\n.\n\u251c\u2500\u2500 Capfile\n\u251c\u2500\u2500 Gemfile\n\u251c\u2500\u2500 Gemfile.lock\n\u251c\u2500\u2500 config\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 deploy\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 dev.rb\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 production.rb\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2514\u2500\u2500 staging.rb\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 deploy.rb\n\u251c\u2500\u2500 lib\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 capistrano\n\u2502\u00a0\u00a0     \u2514\u2500\u2500 tasks\n\u251c\u2500\u2500 log\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 capistrano.log\n\u2514\u2500\u2500 vendor\n    \u2514\u2500\u2500 bundle\n        \u2514\u2500\u2500 ruby\n```\n\n### config/deploy.rb\n\n\u30b0\u30ed\u30fc\u30d0\u30eb\u306a\u8a2d\u5b9a\u306f config/deploy.rb \u306b\u66f8\u304d\u307e\u3057\u3087\u3046\u3002\n\n```ruby\nrequire 'aws-sdk'\n\nset :aws_region, 'ap-northeast-1'\nset :aws_profile, 'your_profile'\n\ndef ec2\n  Aws::EC2::Client.new(\n    region: fetch(:aws_region),\n    profile: fetch(:aws_profile)\n  )\nend\n\ndef get_ec2_instances(name)\n  hosts = []\n  ec2.describe_instances(\n    filters:[\n      { name: \"tag:Name\", values: [name]},\n      { name: \"instance-state-name\", values: [\"running\"]}\n    ]).reservations.each do |reservation|\n    reservation.instances.each do |instance|\n      hosts << instance.public_ip_address\n    end\n  end\n  return hosts\nend\n\n# run_locally \u3067 echo \"demo\" \u3092\u5b9f\u884c\u3059\u308b\n# :app Role \u3092\u5bfe\u8c61\u3068\u3057\u3066 pwd \u3068 uptime \u3092\u5b9f\u884c\u3059\u308b\nnamespace :demo do\n  desc 'uptime \u3092\u5b9f\u884c'\n  task :uptime do\n    run_locally do\n      execute 'echo \"demo\"'\n    end\n    on roles(:app) do\n      execute 'pwd'\n      execute 'uptime'\n    end\n  end\nend\n```\n\n`set :foo` \u3067\u5b9a\u7fa9\u3057\u305f\u5024\u306f `fetch :foo` \u3067\u53d6\u5f97\u51fa\u6765\u308b\u3002\n\n### config/deploy/dev.rb\n\n\u74b0\u5883\u6bce\u306e\u8a2d\u5b9a\u306f config/deploy/*.rb \u306b\u8a18\u8f09\u3057\u307e\u3057\u3087\u3046\u3002\n\n```ruby\n# \u30a4\u30f3\u30b9\u30bf\u30f3\u30b9 Name \u30bf\u30b0\u306b dev- \u304c\u542b\u307e\u308c\u3066\u3044\u308b\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e Public IP \u3092\u53d6\u5f97\u3059\u308b\nhosts = get_ec2_instances('dev-*')\nrole :app, hosts\n\nset :ssh_options, {\n  user: %w(user),\n  keys: %w(/Path/to/key.pem)\n}\n```\n\n### \u5b9f\u884c\n\n- \u30bf\u30b9\u30af\u3092\u78ba\u8a8d\n\n```sh\nbash-3.2$ bundle exec cap dev -T | grep demo\ncap demo:uptime                    # uptime \u3092\u5b9f\u884c\n```\n\n- \u30bf\u30b9\u30af\u3092\u5b9f\u884c\n\n```sh\nbash-3.2$ bundle exec cap dev demo:uptime\n00:00 demo:uptime\n      01 echo \"demo\"\n      01 demo\n    \u2714 01 kawahara@localhost 0.013s\n      02 pwd\n      02 /home/ssh_user\n    \u2714 02 ssh_user@xx.xxx.xx.xx1 0.736s\n      03 uptime\n      02 /home/ssh_user\n    \u2714 02 ssh_user@xx.xxx.xx.xx2 0.775s\n      03  14:54:24 up 27 min,  0 users,  load average: 0.00, 0.00, 0.00\n    \u2714 03 ssh_user@xx.xxx.xx.xx1 0.612s\n      03  14:54:24 up 27 min,  0 users,  load average: 0.00, 0.01, 0.04\n    \u2714 03 ssh_user@xx.xxx.xx.xx2 0.688s\n```\n\n## \u4ee5\u4e0a\n\n\u30e1\u30e2\u3067\u3057\u305f\u3002\n", "tags": ["capistrano3", "Ruby", "AWS"]}