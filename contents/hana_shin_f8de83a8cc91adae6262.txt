{"tags": ["kubernetes", "high-available", "etcd", "\u30af\u30e9\u30b9\u30bf"], "context": "\n\n1.\u69cb\u6210\n\n2 etcd discovery\u306e\u8a2d\u5b9a\u5185\u5bb9\n\n2.1 master1\u306e\u8a2d\u5b9a\n\u3053\u3053\u3067\u5f97\u3089\u308c\u308b\u7d50\u679c\u3092master1\u3068master2\u306e-discovery\u30d1\u30e9\u30e1\u30fc\u30bf\u3068\u3057\u3066\u6307\u5b9a\u3059\u308b\u3002\n[root@master1 2way-dns]# curl https://discovery.etcd.io/new?size=2\nhttps://discovery.etcd.io/84c3b5edcc6203c46ac147d7fa6522bf[root@master1 2way-dns]#\n\n[root@master1 2way-dns]# cat start.sh\n#!/usr/bin/bash\netcd -name master1 \\\n     -initial-advertise-peer-urls http://192.168.0.10:2380 \\\n     -listen-peer-urls http://192.168.0.10:2380 \\\n     -listen-client-urls http://0.0.0.0:2379 \\\n     -advertise-client-urls http://192.168.0.10:2379 \\\n     -discovery https://discovery.etcd.io/84c3b5edcc6203c46ac147d7fa6522bf &\n\n[root@master1 2way-dns]# ls -la start.sh\n-rwxr--r--. 1 root root 328 11\u6708 13 22:13 start.sh\n\n[root@master1 2way-dns]# cat /etc/kubernetes/kubelet |grep -v ^#|grep -v '^\\s*$'\nKUBELET_ADDRESS=\"--address=0.0.0.0\"\nKUBELET_HOSTNAME=\"--hostname-override=master1\"\nKUBELET_API_SERVER=\"--api-servers=http://192.168.0.10:8080\"\nKUBELET_POD_INFRA_CONTAINER=\"--pod-infra-container-image=registry.access.redhat.com/rhel7/pod-infrastructure:latest\"\n[root@master1 2way-dns]#\n\n[root@master1 2way-dns]# cat /etc/kubernetes/config |grep -v ^#|grep -v '^\\s*$'\nKUBE_LOGTOSTDERR=\"--logtostderr=true\"\nKUBE_LOG_LEVEL=\"--v=0\"\nKUBE_ALLOW_PRIV=\"--allow-privileged=false\"\nKUBE_MASTER=\"--master=http://192.168.0.10:8080\"\n\n\n[root@master1 2way-dns]# cat /etc/kubernetes/apiserver |grep -v ^#|grep -v '^\\s*$'\nKUBE_API_ADDRESS=\"--insecure-bind-address=0.0.0.0\"\nKUBE_API_PORT=\"--insecure-port=8080\"\nKUBE_ETCD_SERVERS=\"--etcd-servers=http://192.168.0.10:2379\"\nKUBE_SERVICE_ADDRESSES=\"--service-cluster-ip-range=10.254.0.0/16\"\nKUBE_ADMISSION_CONTROL=\"--admission-control=NamespaceLifecycle,NamespaceExists,LimitRanger,SecurityContextDeny,ResourceQuota\"\nKUBE_API_ARGS=\"\"\n[root@master1 2way-dns]#\n\n\n\n2.2 master2\u306e\u8a2d\u5b9a\n\n[root@master2 2way-dns]# cat start.sh\n#!/usr/bin/bash\netcd -name master2 \\\n     -initial-advertise-peer-urls http://192.168.0.20:2380 \\\n     -listen-peer-urls http://192.168.0.20:2380 \\\n     -listen-client-urls http://0.0.0.0:2379 \\\n     -advertise-client-urls http://192.168.0.20:2379 \\\n     -discovery https://discovery.etcd.io/84c3b5edcc6203c46ac147d7fa6522bf &\n\n[root@master2 2way-dns]# ls -la start.sh\n-rwxr--r--. 1 root root 328 11\u6708 13 22:14 start.sh\n\n\n[root@master2 2way-dns]# cat /etc/kubernetes/kubelet |grep -v ^#|grep -v '^\\s*$'\nKUBELET_ADDRESS=\"--address=0.0.0.0\"\nKUBELET_HOSTNAME=\"--hostname-override=master2\"\nKUBELET_API_SERVER=\"--api-servers=http://192.168.0.20:8080\"\nKUBELET_POD_INFRA_CONTAINER=\"--pod-infra-container-image=registry.access.redhat.com/rhel7/pod-infrastructure:latest\"\n[root@master2 2way-dns]#\n\n\n[root@master2 2way-dns]# cat /etc/kubernetes/config |grep -v ^#|grep -v '^\\s*$'\nKUBE_LOGTOSTDERR=\"--logtostderr=true\"\nKUBE_LOG_LEVEL=\"--v=0\"\nKUBE_ALLOW_PRIV=\"--allow-privileged=false\"\nKUBE_MASTER=\"--master=http://192.168.0.20:8080\"\n[root@master2 2way-dns]#\n\n\n[root@master2 2way-dns]# cat /etc/kubernetes/apiserver |grep -v ^#|grep -v '^\\s*$'\nKUBE_API_ADDRESS=\"--insecure-bind-address=0.0.0.0\"\nKUBE_API_PORT=\"--insecure-port=8080\"\nKUBE_ETCD_SERVERS=\"--etcd-servers=http://192.168.0.20:2379\"\nKUBE_SERVICE_ADDRESSES=\"--service-cluster-ip-range=10.254.0.0/16\"\nKUBE_ADMISSION_CONTROL=\"--admission-control=NamespaceLifecycle,NamespaceExists,LimitRanger,SecurityContextDeny,ResourceQuota\"\nKUBE_API_ARGS=\"\"\n[root@master2 2way-dns]#\n\n\n\n3 etcd\u306e\u8d77\u52d5\n\n3.1 master1\u5074\u306eetcd\u8d77\u52d5\n\u3082\u3057\u304b\u3057\u305f\u3089\u3001etcd\u8d77\u52d5\u524d\u306b\u3001kubele\u306e\u518d\u8d77\u52d5\u304c\u5fc5\u8981\u304b\u3082\u3057\u308c\u306a\u3044\u3002\n[root@master1 2way-dns]# systemctl restart kubelet\n\netcd\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 2way-dns]# ./start.sh\n\netcd\u30c7\u30fc\u30e2\u30f3\u306e\u72b6\u614b\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 2way-dns]# ps axu|grep etcd\nroot       8882  5.6  1.7  35884 17832 pts/0    Sl   22:14   0:08 etcd -name master1 -initial-advertise-peer-urls http://192.168.0.10:2380 -listen-peer-urls http://192.168.0.10:2380 -listen-client-urls http://0.0.0.0:2379 -advertise-client-urls http://192.168.0.10:2379 -discovery https://discovery.etcd.io/84c3b5edcc6203c46ac147d7fa6522bf\nroot       9112  0.0  0.0 112656   972 pts/0    S+   22:17   0:00 grep --color=auto etcd\n[root@master1 2way-dns]#\n\n\n\u30af\u30e9\u30b9\u30bf\u306e\u72b6\u614b\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 2way-dns]# etcdctl cluster-health\nmember 35b6213ea6d07e50 is healthy: got healthy result from http://192.168.0.10:2379\nmember d7c94195a25a1ab6 is healthy: got healthy result from http://192.168.0.20:2379\ncluster is healthy\n\n\u30ea\u30fc\u30c0\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 2way-dns]# etcdctl member list\n35b6213ea6d07e50: name=master1 peerURLs=http://192.168.0.10:2380 clientURLs=http://192.168.0.10:2379 isLeader=true\nd7c94195a25a1ab6: name=master2 peerURLs=http://192.168.0.20:2380 clientURLs=http://192.168.0.20:2379 isLeader=false\n[root@master1 2way-dns]#\n\n\n\n\n3.2 master2\u5074\u306eetcd\u8d77\u52d5\n[root@master2 2way-dns]# ./start.sh\n[root@master2 2way-dns]# ps aux|grep etcd\nroot       9391  4.4  1.7  35884 17716 pts/0    Sl   22:14   0:10 etcd -name master2 -initial-advertise-peer-urls http://192.168.0.20:2380 -listen-peer-urls http://192.168.0.20:2380 -listen-client-urls http://0.0.0.0:2379 -advertise-client-urls http://192.168.0.20:2379 -discovery https://discovery.etcd.io/84c3b5edcc6203c46ac147d7fa6522bf\nroot       9698  0.0  0.0 112656   972 pts/0    S+   22:18   0:00 grep --color=auto etcd\n[root@master2 2way-dns]#\n\n\n[root@master2 2way-dns]# etcdctl cluster-health\nmember 35b6213ea6d07e50 is healthy: got healthy result from http://192.168.0.10:2379\nmember d7c94195a25a1ab6 is healthy: got healthy result from http://192.168.0.20:2379\ncluster is healthy\n[root@master2 2way-dns]# etcdctl member list\n35b6213ea6d07e50: name=master1 peerURLs=http://192.168.0.10:2380 clientURLs=http://192.168.0.10:2379 isLeader=true\nd7c94195a25a1ab6: name=master2 peerURLs=http://192.168.0.20:2380 clientURLs=http://192.168.0.20:2379 isLeader=false\n[root@master2 2way-dns]#\n\n\n\n5 \u53c2\u8003\u60c5\u5831\n[Building High-Availability Clusters]http://kubernetes.io/docs/admin/high-availability/\n[kubernetes/kubernetes.github.io]\nhttps://github.com/kubernetes/kubernetes.github.io/tree/master/docs/admin/high-availability\n[ GET STARTED ORCHESTRATING CONTAINERS WITH KUBERNETES]https://access.redhat.com/documentation/en/red-hat-enterprise-linux-atomic-host/7/paged/getting-started-with-kubernetes/chapter-1-get-started-orchestrating-containers-with-kubernetes\n#1.\u69cb\u6210\n\n\n#2 etcd discovery\u306e\u8a2d\u5b9a\u5185\u5bb9\n\n## 2.1 master1\u306e\u8a2d\u5b9a\n\n\n```\n\u3053\u3053\u3067\u5f97\u3089\u308c\u308b\u7d50\u679c\u3092master1\u3068master2\u306e-discovery\u30d1\u30e9\u30e1\u30fc\u30bf\u3068\u3057\u3066\u6307\u5b9a\u3059\u308b\u3002\n[root@master1 2way-dns]# curl https://discovery.etcd.io/new?size=2\nhttps://discovery.etcd.io/84c3b5edcc6203c46ac147d7fa6522bf[root@master1 2way-dns]#\n\n[root@master1 2way-dns]# cat start.sh\n#!/usr/bin/bash\netcd -name master1 \\\n     -initial-advertise-peer-urls http://192.168.0.10:2380 \\\n     -listen-peer-urls http://192.168.0.10:2380 \\\n     -listen-client-urls http://0.0.0.0:2379 \\\n     -advertise-client-urls http://192.168.0.10:2379 \\\n     -discovery https://discovery.etcd.io/84c3b5edcc6203c46ac147d7fa6522bf &\n\n[root@master1 2way-dns]# ls -la start.sh\n-rwxr--r--. 1 root root 328 11\u6708 13 22:13 start.sh\n\n[root@master1 2way-dns]# cat /etc/kubernetes/kubelet |grep -v ^#|grep -v '^\\s*$'\nKUBELET_ADDRESS=\"--address=0.0.0.0\"\nKUBELET_HOSTNAME=\"--hostname-override=master1\"\nKUBELET_API_SERVER=\"--api-servers=http://192.168.0.10:8080\"\nKUBELET_POD_INFRA_CONTAINER=\"--pod-infra-container-image=registry.access.redhat.com/rhel7/pod-infrastructure:latest\"\n[root@master1 2way-dns]#\n\n[root@master1 2way-dns]# cat /etc/kubernetes/config |grep -v ^#|grep -v '^\\s*$'\nKUBE_LOGTOSTDERR=\"--logtostderr=true\"\nKUBE_LOG_LEVEL=\"--v=0\"\nKUBE_ALLOW_PRIV=\"--allow-privileged=false\"\nKUBE_MASTER=\"--master=http://192.168.0.10:8080\"\n\n\n[root@master1 2way-dns]# cat /etc/kubernetes/apiserver |grep -v ^#|grep -v '^\\s*$'\nKUBE_API_ADDRESS=\"--insecure-bind-address=0.0.0.0\"\nKUBE_API_PORT=\"--insecure-port=8080\"\nKUBE_ETCD_SERVERS=\"--etcd-servers=http://192.168.0.10:2379\"\nKUBE_SERVICE_ADDRESSES=\"--service-cluster-ip-range=10.254.0.0/16\"\nKUBE_ADMISSION_CONTROL=\"--admission-control=NamespaceLifecycle,NamespaceExists,LimitRanger,SecurityContextDeny,ResourceQuota\"\nKUBE_API_ARGS=\"\"\n[root@master1 2way-dns]#\n\n```\n\n## 2.2 master2\u306e\u8a2d\u5b9a\n\n```\n\n[root@master2 2way-dns]# cat start.sh\n#!/usr/bin/bash\netcd -name master2 \\\n     -initial-advertise-peer-urls http://192.168.0.20:2380 \\\n     -listen-peer-urls http://192.168.0.20:2380 \\\n     -listen-client-urls http://0.0.0.0:2379 \\\n     -advertise-client-urls http://192.168.0.20:2379 \\\n     -discovery https://discovery.etcd.io/84c3b5edcc6203c46ac147d7fa6522bf &\n\n[root@master2 2way-dns]# ls -la start.sh\n-rwxr--r--. 1 root root 328 11\u6708 13 22:14 start.sh\n\n\n[root@master2 2way-dns]# cat /etc/kubernetes/kubelet |grep -v ^#|grep -v '^\\s*$'\nKUBELET_ADDRESS=\"--address=0.0.0.0\"\nKUBELET_HOSTNAME=\"--hostname-override=master2\"\nKUBELET_API_SERVER=\"--api-servers=http://192.168.0.20:8080\"\nKUBELET_POD_INFRA_CONTAINER=\"--pod-infra-container-image=registry.access.redhat.com/rhel7/pod-infrastructure:latest\"\n[root@master2 2way-dns]#\n\n\n[root@master2 2way-dns]# cat /etc/kubernetes/config |grep -v ^#|grep -v '^\\s*$'\nKUBE_LOGTOSTDERR=\"--logtostderr=true\"\nKUBE_LOG_LEVEL=\"--v=0\"\nKUBE_ALLOW_PRIV=\"--allow-privileged=false\"\nKUBE_MASTER=\"--master=http://192.168.0.20:8080\"\n[root@master2 2way-dns]#\n\n\n[root@master2 2way-dns]# cat /etc/kubernetes/apiserver |grep -v ^#|grep -v '^\\s*$'\nKUBE_API_ADDRESS=\"--insecure-bind-address=0.0.0.0\"\nKUBE_API_PORT=\"--insecure-port=8080\"\nKUBE_ETCD_SERVERS=\"--etcd-servers=http://192.168.0.20:2379\"\nKUBE_SERVICE_ADDRESSES=\"--service-cluster-ip-range=10.254.0.0/16\"\nKUBE_ADMISSION_CONTROL=\"--admission-control=NamespaceLifecycle,NamespaceExists,LimitRanger,SecurityContextDeny,ResourceQuota\"\nKUBE_API_ARGS=\"\"\n[root@master2 2way-dns]#\n\n```\n\n\n#3 etcd\u306e\u8d77\u52d5\n\n##3.1 master1\u5074\u306eetcd\u8d77\u52d5\n\n```\n\u3082\u3057\u304b\u3057\u305f\u3089\u3001etcd\u8d77\u52d5\u524d\u306b\u3001kubele\u306e\u518d\u8d77\u52d5\u304c\u5fc5\u8981\u304b\u3082\u3057\u308c\u306a\u3044\u3002\n[root@master1 2way-dns]# systemctl restart kubelet\n\netcd\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 2way-dns]# ./start.sh\n\netcd\u30c7\u30fc\u30e2\u30f3\u306e\u72b6\u614b\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 2way-dns]# ps axu|grep etcd\nroot       8882  5.6  1.7  35884 17832 pts/0    Sl   22:14   0:08 etcd -name master1 -initial-advertise-peer-urls http://192.168.0.10:2380 -listen-peer-urls http://192.168.0.10:2380 -listen-client-urls http://0.0.0.0:2379 -advertise-client-urls http://192.168.0.10:2379 -discovery https://discovery.etcd.io/84c3b5edcc6203c46ac147d7fa6522bf\nroot       9112  0.0  0.0 112656   972 pts/0    S+   22:17   0:00 grep --color=auto etcd\n[root@master1 2way-dns]#\n\n\n\u30af\u30e9\u30b9\u30bf\u306e\u72b6\u614b\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 2way-dns]# etcdctl cluster-health\nmember 35b6213ea6d07e50 is healthy: got healthy result from http://192.168.0.10:2379\nmember d7c94195a25a1ab6 is healthy: got healthy result from http://192.168.0.20:2379\ncluster is healthy\n\n\u30ea\u30fc\u30c0\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 2way-dns]# etcdctl member list\n35b6213ea6d07e50: name=master1 peerURLs=http://192.168.0.10:2380 clientURLs=http://192.168.0.10:2379 isLeader=true\nd7c94195a25a1ab6: name=master2 peerURLs=http://192.168.0.20:2380 clientURLs=http://192.168.0.20:2379 isLeader=false\n[root@master1 2way-dns]#\n\n\n```\n\n##3.2 master2\u5074\u306eetcd\u8d77\u52d5\n\n```\n[root@master2 2way-dns]# ./start.sh\n[root@master2 2way-dns]# ps aux|grep etcd\nroot       9391  4.4  1.7  35884 17716 pts/0    Sl   22:14   0:10 etcd -name master2 -initial-advertise-peer-urls http://192.168.0.20:2380 -listen-peer-urls http://192.168.0.20:2380 -listen-client-urls http://0.0.0.0:2379 -advertise-client-urls http://192.168.0.20:2379 -discovery https://discovery.etcd.io/84c3b5edcc6203c46ac147d7fa6522bf\nroot       9698  0.0  0.0 112656   972 pts/0    S+   22:18   0:00 grep --color=auto etcd\n[root@master2 2way-dns]#\n\n\n[root@master2 2way-dns]# etcdctl cluster-health\nmember 35b6213ea6d07e50 is healthy: got healthy result from http://192.168.0.10:2379\nmember d7c94195a25a1ab6 is healthy: got healthy result from http://192.168.0.20:2379\ncluster is healthy\n[root@master2 2way-dns]# etcdctl member list\n35b6213ea6d07e50: name=master1 peerURLs=http://192.168.0.10:2380 clientURLs=http://192.168.0.10:2379 isLeader=true\nd7c94195a25a1ab6: name=master2 peerURLs=http://192.168.0.20:2380 clientURLs=http://192.168.0.20:2379 isLeader=false\n[root@master2 2way-dns]#\n\n```\n\n\n#5 \u53c2\u8003\u60c5\u5831\n\n[Building High-Availability Clusters]http://kubernetes.io/docs/admin/high-availability/\n\n[kubernetes/kubernetes.github.io]\nhttps://github.com/kubernetes/kubernetes.github.io/tree/master/docs/admin/high-availability\n\n[ GET STARTED ORCHESTRATING CONTAINERS WITH KUBERNETES]https://access.redhat.com/documentation/en/red-hat-enterprise-linux-atomic-host/7/paged/getting-started-with-kubernetes/chapter-1-get-started-orchestrating-containers-with-kubernetes\n"}