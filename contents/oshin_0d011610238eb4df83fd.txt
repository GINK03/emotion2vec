{"tags": ["Rails", "docker", "docker-compose"], "context": " More than 1 year has passed since last update.\n\n\u5c0e\u5165\nDocker Compose\u3092\u5229\u7528\u3057\u3066\u3001\u8907\u6570\u306edocker container\u3092\u4f7f\u3063\u305f\u74b0\u5883\u306e\u8a2d\u5b9a\u4f8b\u3092\u7d39\u4ecb\u3057\u307e\u3059\u3002\u306a\u304a\u3001Docker Compose\u306fWindows\u3067\u306f\u4f7f\u3048\u307e\u305b\u3093\u3002Max OSX or 64bit Linux\u306e\u307f\u5bfe\u8c61\u3068\u306a\u3063\u3066\u3044\u307e\u3059\u3002\n\n\u6e96\u5099\nDocker Toolbox\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3067\u304d\u308c\u3070\u74b0\u5883\u306f\u3059\u3079\u3066\u6574\u3044\u307e\u3059\u3002\nhttps://www.docker.com/products/docker-toolbox\ndocker, docker-machine, docker-compose\u3068\u3044\u3063\u305f\u30c4\u30fc\u30eb\u3068VirtualBox\u304c\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3055\u308c\u308b\u306f\u305a\u3067\u3059\u3002\n\u6b21\u306bmachine\u306e\u6e96\u5099\nhttps://docs.docker.com/machine/get-started/\n$ docker-machine create --driver virtualbox default\n$ docker-machine env default\n\nexport DOCKER_TLS_VERIFY=\"1\"\nexport DOCKER_HOST=\"tcp://192.168.99.100:2376\"\nexport DOCKER_CERT_PATH=\"/Users/user/.docker/machine/machines/default\"\nexport DOCKER_MACHINE_NAME=\"default\"\n# Run this command to configure your shell: \n# eval $(docker-machine env default)\n\n$ eval $(docker-machine env default)\n\n\u3053\u308c\u3067default machine\u3092\u4f7f\u3063\u3066docker container\u3092\u8d77\u52d5\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3057\u305f\u3002\ndocker-machine ls\u3067\u78ba\u8a8d\u3067\u304d\u307e\u3059\n$ docker-machine ls\nNAME         ACTIVE   DRIVER       STATE     URL                          SWARM   DOCKER    ERRORS\ndefault      *        virtualbox   Running   tcp://192.168.99.100:2376            v1.10.1   \nprod         -        google       Running   tcp://104.155.xxx.xxx:2376           v1.9.1    \nprod2        -        google       Running   tcp://104.199.xxx.xxx:2376           v1.10.1 \n\n\nVersion\n\u4eca\u56de\u5229\u7528\u3057\u305fdocker\u30c4\u30fc\u30eb\u985e\u306eversion\u3092\u8a18\u8f09\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n$ docker-machine -v\ndocker-machine version 0.6.0, build e27fb87\n$ docker-compose -v\ndocker-compose version 1.6.0, build d99cad6\n$ docker -v        \nDocker version 1.10.1, build 9e83765\n\n\nDocker Compose 1.6\u304b\u3089\u306e\u66f8\u5f0f\u5909\u66f4\ndocker-compose\u306f1.6\u304b\u3089configuration\u306e\u66f8\u5f0f\u304c\u5909\u66f4\u306b\u306a\u3063\u3066\u3044\u308b\u306e\u3067\u3054\u6ce8\u610f\u304f\u3060\u3055\u3044\u3002\n\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u69cb\u9020\u304c\u5909\u308f\u3063\u3066\u3044\u307e\u3059\u3002\n\n1.5\u7cfb\u307e\u3067(version 1)\ndb:\n  image: postgres\nweb:\n  build: .\n  command: bundle exec rails s -p 3000 -b '0.0.0.0'\n  volumes:\n    - .:/myapp\n  ports:\n    - \"3000:3000\"\n  links:\n    - db\n\n\n1.6\u4ee5\u964d\n\u4ee5\u4e0b\u306e\u3088\u3046\u306bversion\u3092\u660e\u793a\u3057, \u5404service\u306e\u8a2d\u5b9a\u3092\u675f\u306d\u308bservices\u304c\u8ffd\u52a0\u3055\u308c\u307e\u3057\u305f\u3002\nversion: '2'\nservices:\n  db:\n    image: postgres\n  web:\n    build: .\n    command: bundle exec rails s -p 3000 -b '0.0.0.0'\n    volumes:\n      - .:/myapp\n    ports:\n      - \"3000:3000\"\n    links:\n      - db\n\n1.6\u3067\u3082version1\u306e\u66f8\u5f0f\u3092\u53d7\u3051\u4ed8\u3051\u3066\u304f\u308c\u307e\u3059\u304c\u3001\u30b5\u30dd\u30fc\u30c8\u306f1.6\u7cfb\u307e\u3067\u306e\u305f\u3081\u65b0\u898f\u306e\u3082\u306e\u306fversion 2\u3067\u8a2d\u5b9a\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\nhttps://docs.docker.com/compose/compose-file/#versioning\n\n\nDocker Compose \u8a2d\u5b9a\u4f8b\nrails new myapp\u3067\u4f5c\u6210\u3057\u3001myapp\u306f\u4ee5\u4e0b\u306e\u69cb\u6210\u3068\u306a\u3063\u3066\u3044\u308b\u3053\u3068\u3092\u524d\u63d0\u3068\u3057\u307e\u3059\u3002\n$ ls -1F \nDockerfile\nDockerfile.prod\nGemfile\nGemfile.lock\nREADME.rdoc\nRakefile\napp/\nbin/\nconfig/\nconfig.ru\ndb/\ndoc/\ndocker-compose.prod.yml\ndocker-compose.yml\nlib/\nlog/\nnginx/\npublic/\nscript/\ntest/\ntmp/\nvendor/\n\n\ndocker-compose.yml\u304ccurrent dir\u306b\u3042\u308b\u3068docker-compose up -d\u306e\u307f\u3067build\u304b\u3089container\u8d77\u52d5\u307e\u3067\u3059\u307f\u307e\u3059\u3002\ndocker-compose.prod.yml\u306e\u3088\u3046\u306bdefault\u4ee5\u5916\u306e\u540d\u524d\u3092\u3064\u3051\u305f\u5834\u5408\u3001-f\u30aa\u30d7\u30b7\u30e7\u30f3\u3067\u6307\u5b9a\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\n\n\n\u4f8b: docker-compose -f docker-compose.prod.yml up -d\n\n\n\n\n\u4ee5\u4e0b\u306e\u30da\u30fc\u30b8\u3092\u53c2\u8003\u306b\u8a2d\u5b9a\u3057\u3066\u304d\u307e\u3059\u3002\nhttps://docs.docker.com/compose/compose-file/\n\ndevelopment(docker-compose.yml)\nversion: '2'\nservices:\n  db:\n    image: mysql\n    environment:\n      MYSQL_ROOT_PASSWORD: $MYAPP_DATABASE_PASSWORD\n    volumes:\n      - db-data:/var/lib/mysql\n  redis:\n    image: redis:3.0.5\n  app:\n    build: .\n    environment:\n      MYAPP_DATABASE_USERNAME: root\n      MYAPP_DATABASE_PASSWORD: $MYAPP_DATABASE_PASSWORD\n      MYAPP_DATABASE_HOST: db\n      MYAPP_SLACK_API_TOKEN: $MYAPP_SLACK_API_TOKEN\n  web:\n    extends:\n      service: app\n    command: bundle exec rails s -p 3000 -b '0.0.0.0'\n    volumes:\n      - .:/myapp\n    ports:\n      - \"3000:3000\"\n    links:\n      - db\n      - redis\n  worker:\n    extends:\n      service: app\n    command: bundle exec sidekiq -q notification\n    volumes:\n      - .:/myapp\n    links:\n      - db\n      - redis\n\nvolumes:\n  db-data:\n    driver: local\n\n\nimage\nimage: mysql\u306fimage: mysql:latest\u7701\u7565\u3067\u3042\u308a\u30012016/02/17\u73fe\u5728\u306fimage: mysql:5.7.11\u3092\u610f\u5473\u3057\u307e\u3059\nbuild\u306e\u305f\u3073\u306b\u30d0\u30fc\u30b8\u30e7\u30f3\u304c\u3070\u3089\u3051\u3066\u3057\u307e\u3046\u3053\u3068\u306b\u306a\u308b\u306e\u3067\u3001image: mysql:5.7\u3084image: mysql:5.7.11\u3068\u3044\u3046\u3088\u3046\u306bversion\u6307\u5b9a\u3057\u305f\u307b\u3046\u304c\u3088\u3044\u3067\u3059\u3002\n\u57fa\u672c\u7684\u306a\u3082\u306e\u306f https://hub.docker.com/ \u304b\u3089\u63a2\u3059\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n- https://hub.docker.com/_/mysql/\n- https://hub.docker.com/_/redis/\n- https://hub.docker.com/_/nginx/\n\nenvironment\ncontainer\u306b\u6e21\u3059\u74b0\u5883\u5909\u6570\u306e\u8a2d\u5b9a\u3067\u3059\u304c\u3001password\u985e\u3092yaml\u306b\u66f8\u3044\u3066repository\u306b\u7a81\u3063\u8fbc\u3080\u308f\u3051\u306b\u3082\u3044\u304b\u306a\u3044\u306e\u3067\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306bshell\u306e\u74b0\u5883\u5909\u6570\u3092\u6e21\u3057\u307e\u3059\u3002\n    environment:\n      MYSQL_ROOT_PASSWORD: $MYAPP_DATABASE_PASSWORD\n\n\nvolumes\ndatabase\u306e\u3088\u3046\u306b\u6c38\u7d9a\u7684\u306a\u30b9\u30c8\u30ec\u30fc\u30b8\u304c\u6b32\u3057\u3044\u5834\u5408\u306b\u5fc5\u8981\u306a\u8a2d\u5b9a\u3067\u3059\u3002\n    volumes:\n      - db-data:/var/lib/mysql\n\nvolumes:\n  db-data:\n    driver: local\n\nhttps://docs.docker.com/compose/compose-file/#volume-configuration-reference\n\nextends\n\u4eca\u56de\u306e\u4f8b\u306e\u3088\u3046\u306bweb\u3068worker container\u304c\u3042\u308a\u3001\u8a2d\u5b9a\u304c\u5171\u901a\u3057\u3066\u3044\u308b\u5834\u5408\u306b\u306fextends\u3092\u5229\u7528\u3057\u3066\u5171\u901a\u5316\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n  app:\n    build: .\n  web:\n    extends:\n      service: app\n    command: bundle exec rails s -p 3000 -b '0.0.0.0'\n  worker:\n    extends:\n      service: app\n    command: bundle exec sidekiq -q notification\n\n\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092\u5206\u3051\u3066\u7ba1\u7406\u3059\u308b\u3053\u3068\u3082\u3067\u304d\u307e\u3059\u3002\nhttps://docs.docker.com/compose/compose-file/#extends\n\nlinks\nlinks\u3092\u8a2d\u5b9a\u3059\u308b\u3068\u3001container\u5185\u3067\u540d\u524d\u304c\u5f15\u3051\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\u4eca\u56de\u306e\u4f8b\u3067\u306fweb\u304cdb\u3068redis\u306b\u63a5\u7d9a\u3059\u308b\u305f\u3081\u3001\u8a2d\u5b9a\u3057\u3066\u3044\u307e\u3059\u3002\n    links:\n      - db\n      - redis\n\n\nproduction(docker-compose.prod.yml)\nversion: '2'\nservices:\n  app:\n    build:\n      context: .\n      dockerfile: Dockerfile.prod\n    environment:\n      RAILS_SERVE_STATIC_FILES: 'true'\n      MYAPP_SECRET_KEY_BASE: $MYAPP_SECRET_KEY_BASE\n      MYAPP_DATABASE_USERNAME: app\n      MYAPP_DATABASE_PASSWORD: $MYAPP_DATABASE_PASSWORD\n      MYAPP_DATABASE_HOST: db\n      MYAPP_SLACK_API_TOKEN: $MYAPP_SLACK_API_TOKEN\n    logging:\n      driver: syslog\n      options:\n        syslog-address: \"udp://logs3.papertrailapp.com:xxx\"\n  web:\n    extends:\n      service: app\n    command: bundle exec puma -C config/puma.rb\n    links:\n      - db\n      - redis\n  worker:\n    extends:\n      service: app\n    command: bundle exec sidekiq -q notification\n    links:\n      - db\n      - redis\n\n  nginx:\n    build: ./nginx\n    ports:\n      - '80:80'\n      - '443:443'\n    volumes:\n      - /etc/letsencrypt:/etc/letsencrypt\n    links:\n      - web\n    logging:\n      driver: syslog\n      options:\n        syslog-address: \"udp://logs3.papertrailapp.com:xxx\"\n\n  db:\n    image: mysql\n    volumes:\n      - db-data:/var/lib/mysql\n    environment:\n      MYSQL_ROOT_PASSWORD: $MYAPP_DATABASE_PASSWORD\n      MYSQL_DATABASE: myapp_production\n      MYSQL_USER: driver\n      MYSQL_PASSWORD: $MYAPP_DATABASE_PASSWORD\n    logging:\n      driver: syslog\n      options:\n        syslog-address: \"udp://logs3.papertrailapp.com:xxx\"\n\n  redis:\n    image: redis:3.0.5\n    logging:\n      driver: syslog\n      options:\n        syslog-address: \"udp://logs3.papertrailapp.com:xxx\"\n\nvolumes:\n  db-data:\n    driver: local\n\n\nbuild\nbuild: .\u3067\u3042\u308c\u3070./Dockerfile\u3092\u4f7f\u3063\u3066build\u3057\u307e\u3059\u304c\u3001\u5225\u306edirectory\u3084file\u306e\u5834\u5408\u306b\u306fcontext,dockerfile\u3067\u6307\u5b9a\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n  app:\n    build:\n      context: .\n      dockerfile: Dockerfile.prod\n\n\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u66f8\u304f\u3068\u3001./nginx/Dockerfile\u3092\u4f7f\u3063\u3066build\u3057\u307e\u3059\u3002\n  nginx:\n    build: ./nginx\n\n\nlogging\n\u7279\u306b\u8a2d\u5b9a\u3057\u306a\u3044\u5834\u5408\u306fdriver: json-file\u3068\u306a\u308a\u3001docker machine\u4e0a\u306e/var/lib/docker/containers/*/*-json.log\u306b\u30ed\u30b0\u304c\u51fa\u529b\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n\u30ed\u30b0\u3092\u4f55\u51e6\u304b\u306b\u96c6\u7d04\u3057\u305f\u3044\u5834\u5408\u306f\u3001fluentd container\u3092\u7528\u610f\u3057\u3066\u3042\u308c\u3053\u308c\u3057\u305f\u308a\u3001\u4ee5\u4e0b\u306e\u69d8\u306alogging\u8a2d\u5b9a\u3092\u3059\u308b\u65b9\u6cd5\u306a\u3069\u304c\u8003\u3048\u3089\u308c\u307e\u3059\u3002\n    logging:\n      driver: syslog\n      options:\n        syslog-address: \"udp://logs3.papertrailapp.com:xxx\"\n\nhttps://papertrailapp.com/ \u306b\u8ee2\u9001\u3059\u308b\u4f8b\u3067\u3059\u3002\u5b9f\u969b\u306b\u306fxxx\u306b\u6307\u5b9a\u3055\u308c\u305fport\u756a\u53f7\u3092\u66f8\u3044\u3066\u304a\u304f\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\nDocker\u672c\u4f53\u306b\u95a2\u308f\u308b\u3053\u3068\u3067\u3059\u304c\u3001log\u5468\u308a\u306f\u4ee5\u4e0b\u304c\u7247\u4ed8\u304f\u3068\u307e\u305f\u304b\u308f\u3063\u3066\u304f\u308b\u3068\u601d\u3044\u307e\u3059\u3002\n- Logging driver plugins\n- Proposal: New logging driver that logs to tcp, udp and unix domain sockets\n\n\u88dc\u8db3\n\nDockerfile\n$ cat Dockerfile\nFROM ruby:2.2.4\nENV LANG C.UTF-8\nRUN apt-get update -qq && apt-get install -y build-essential\nRUN mkdir /myapp\nWORKDIR /myapp\nADD Gemfile Gemfile.lock /myapp/\nRUN bundle install\nADD . /myapp\n\n\nDockerfile.prod\nFROM ruby:2.2.4\nENV LANG C.UTF-8\nRUN apt-get update -qq && apt-get install -y build-essential\nRUN mkdir /myapp\nWORKDIR /myapp\n\nADD Gemfile Gemfile.lock /myapp/\nRUN bundle install --jobs 20 --retry 5 --without development test\n\nENV RAILS_ENV production\nADD . /myapp\nRUN bundle exec rake tmp:create\nRUN bundle exec rake assets:precompile\n\n\n.dockerignore\n.dockerignore\u30d5\u30a1\u30a4\u30eb\u3092\u7528\u610f\u3059\u308b\u3053\u3068\u3067\u4f59\u8a08\u306a\u3082\u306e\u3092container\u306b\u8f09\u305b\u305a\u306b\u3059\u307f\u307e\u3059\u3002\nhttps://docs.docker.com/engine/reference/builder/#dockerignore-file\n.git\nlog\ntmp\n\n## \u5c0e\u5165\n\nDocker Compose\u3092\u5229\u7528\u3057\u3066\u3001\u8907\u6570\u306edocker container\u3092\u4f7f\u3063\u305f\u74b0\u5883\u306e\u8a2d\u5b9a\u4f8b\u3092\u7d39\u4ecb\u3057\u307e\u3059\u3002\u306a\u304a\u3001Docker Compose\u306fWindows\u3067\u306f\u4f7f\u3048\u307e\u305b\u3093\u3002Max OSX or 64bit Linux\u306e\u307f\u5bfe\u8c61\u3068\u306a\u3063\u3066\u3044\u307e\u3059\u3002\n\n### \u6e96\u5099\n\nDocker Toolbox\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3067\u304d\u308c\u3070\u74b0\u5883\u306f\u3059\u3079\u3066\u6574\u3044\u307e\u3059\u3002\nhttps://www.docker.com/products/docker-toolbox\ndocker, docker-machine, docker-compose\u3068\u3044\u3063\u305f\u30c4\u30fc\u30eb\u3068VirtualBox\u304c\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3055\u308c\u308b\u306f\u305a\u3067\u3059\u3002\n\n\u6b21\u306bmachine\u306e\u6e96\u5099\nhttps://docs.docker.com/machine/get-started/\n\n```\n$ docker-machine create --driver virtualbox default\n$ docker-machine env default\n\nexport DOCKER_TLS_VERIFY=\"1\"\nexport DOCKER_HOST=\"tcp://192.168.99.100:2376\"\nexport DOCKER_CERT_PATH=\"/Users/user/.docker/machine/machines/default\"\nexport DOCKER_MACHINE_NAME=\"default\"\n# Run this command to configure your shell: \n# eval $(docker-machine env default)\n\n$ eval $(docker-machine env default)\n```\n\n\u3053\u308c\u3067default machine\u3092\u4f7f\u3063\u3066docker container\u3092\u8d77\u52d5\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3057\u305f\u3002\n`docker-machine ls`\u3067\u78ba\u8a8d\u3067\u304d\u307e\u3059\n\n```\n$ docker-machine ls\nNAME         ACTIVE   DRIVER       STATE     URL                          SWARM   DOCKER    ERRORS\ndefault      *        virtualbox   Running   tcp://192.168.99.100:2376            v1.10.1   \nprod         -        google       Running   tcp://104.155.xxx.xxx:2376           v1.9.1    \nprod2        -        google       Running   tcp://104.199.xxx.xxx:2376           v1.10.1 \n```\n\n### Version\n\n\u4eca\u56de\u5229\u7528\u3057\u305fdocker\u30c4\u30fc\u30eb\u985e\u306eversion\u3092\u8a18\u8f09\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\n```\n$ docker-machine -v\ndocker-machine version 0.6.0, build e27fb87\n$ docker-compose -v\ndocker-compose version 1.6.0, build d99cad6\n$ docker -v        \nDocker version 1.10.1, build 9e83765\n```\n\n## Docker Compose 1.6\u304b\u3089\u306e\u66f8\u5f0f\u5909\u66f4\n\ndocker-compose\u306f1.6\u304b\u3089configuration\u306e\u66f8\u5f0f\u304c\u5909\u66f4\u306b\u306a\u3063\u3066\u3044\u308b\u306e\u3067\u3054\u6ce8\u610f\u304f\u3060\u3055\u3044\u3002\n\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u69cb\u9020\u304c\u5909\u308f\u3063\u3066\u3044\u307e\u3059\u3002\n\n### 1.5\u7cfb\u307e\u3067(version 1)\n\n```\ndb:\n  image: postgres\nweb:\n  build: .\n  command: bundle exec rails s -p 3000 -b '0.0.0.0'\n  volumes:\n    - .:/myapp\n  ports:\n    - \"3000:3000\"\n  links:\n    - db\n```\n\n### 1.6\u4ee5\u964d\n\n\u4ee5\u4e0b\u306e\u3088\u3046\u306bversion\u3092\u660e\u793a\u3057, \u5404service\u306e\u8a2d\u5b9a\u3092\u675f\u306d\u308bservices\u304c\u8ffd\u52a0\u3055\u308c\u307e\u3057\u305f\u3002\n\n```\nversion: '2'\nservices:\n  db:\n    image: postgres\n  web:\n    build: .\n    command: bundle exec rails s -p 3000 -b '0.0.0.0'\n    volumes:\n      - .:/myapp\n    ports:\n      - \"3000:3000\"\n    links:\n      - db\n```\n\n1.6\u3067\u3082version1\u306e\u66f8\u5f0f\u3092\u53d7\u3051\u4ed8\u3051\u3066\u304f\u308c\u307e\u3059\u304c\u3001\u30b5\u30dd\u30fc\u30c8\u306f1.6\u7cfb\u307e\u3067\u306e\u305f\u3081\u65b0\u898f\u306e\u3082\u306e\u306fversion 2\u3067\u8a2d\u5b9a\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n- https://docs.docker.com/compose/compose-file/#versioning\n\n# Docker Compose \u8a2d\u5b9a\u4f8b\n\n`rails new myapp`\u3067\u4f5c\u6210\u3057\u3001myapp\u306f\u4ee5\u4e0b\u306e\u69cb\u6210\u3068\u306a\u3063\u3066\u3044\u308b\u3053\u3068\u3092\u524d\u63d0\u3068\u3057\u307e\u3059\u3002\n\n```\n$ ls -1F \nDockerfile\nDockerfile.prod\nGemfile\nGemfile.lock\nREADME.rdoc\nRakefile\napp/\nbin/\nconfig/\nconfig.ru\ndb/\ndoc/\ndocker-compose.prod.yml\ndocker-compose.yml\nlib/\nlog/\nnginx/\npublic/\nscript/\ntest/\ntmp/\nvendor/\n```\n\n- docker-compose.yml\u304ccurrent dir\u306b\u3042\u308b\u3068`docker-compose up -d`\u306e\u307f\u3067build\u304b\u3089container\u8d77\u52d5\u307e\u3067\u3059\u307f\u307e\u3059\u3002\n- docker-compose.prod.yml\u306e\u3088\u3046\u306bdefault\u4ee5\u5916\u306e\u540d\u524d\u3092\u3064\u3051\u305f\u5834\u5408\u3001-f\u30aa\u30d7\u30b7\u30e7\u30f3\u3067\u6307\u5b9a\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\n  - \u4f8b: `docker-compose -f docker-compose.prod.yml up -d`\n\n\u4ee5\u4e0b\u306e\u30da\u30fc\u30b8\u3092\u53c2\u8003\u306b\u8a2d\u5b9a\u3057\u3066\u304d\u307e\u3059\u3002\nhttps://docs.docker.com/compose/compose-file/\n\n## development(docker-compose.yml)\n\n```yaml\nversion: '2'\nservices:\n  db:\n    image: mysql\n    environment:\n      MYSQL_ROOT_PASSWORD: $MYAPP_DATABASE_PASSWORD\n    volumes:\n      - db-data:/var/lib/mysql\n  redis:\n    image: redis:3.0.5\n  app:\n    build: .\n    environment:\n      MYAPP_DATABASE_USERNAME: root\n      MYAPP_DATABASE_PASSWORD: $MYAPP_DATABASE_PASSWORD\n      MYAPP_DATABASE_HOST: db\n      MYAPP_SLACK_API_TOKEN: $MYAPP_SLACK_API_TOKEN\n  web:\n    extends:\n      service: app\n    command: bundle exec rails s -p 3000 -b '0.0.0.0'\n    volumes:\n      - .:/myapp\n    ports:\n      - \"3000:3000\"\n    links:\n      - db\n      - redis\n  worker:\n    extends:\n      service: app\n    command: bundle exec sidekiq -q notification\n    volumes:\n      - .:/myapp\n    links:\n      - db\n      - redis\n\nvolumes:\n  db-data:\n    driver: local\n```\n\n### image\n\n`image: mysql`\u306f`image: mysql:latest`\u7701\u7565\u3067\u3042\u308a\u30012016/02/17\u73fe\u5728\u306f`image: mysql:5.7.11`\u3092\u610f\u5473\u3057\u307e\u3059\nbuild\u306e\u305f\u3073\u306b\u30d0\u30fc\u30b8\u30e7\u30f3\u304c\u3070\u3089\u3051\u3066\u3057\u307e\u3046\u3053\u3068\u306b\u306a\u308b\u306e\u3067\u3001`image: mysql:5.7`\u3084`image: mysql:5.7.11`\u3068\u3044\u3046\u3088\u3046\u306bversion\u6307\u5b9a\u3057\u305f\u307b\u3046\u304c\u3088\u3044\u3067\u3059\u3002\n\n\u57fa\u672c\u7684\u306a\u3082\u306e\u306f https://hub.docker.com/ \u304b\u3089\u63a2\u3059\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n- https://hub.docker.com/_/mysql/\n- https://hub.docker.com/_/redis/\n- https://hub.docker.com/_/nginx/\n\n### environment\n\ncontainer\u306b\u6e21\u3059\u74b0\u5883\u5909\u6570\u306e\u8a2d\u5b9a\u3067\u3059\u304c\u3001password\u985e\u3092yaml\u306b\u66f8\u3044\u3066repository\u306b\u7a81\u3063\u8fbc\u3080\u308f\u3051\u306b\u3082\u3044\u304b\u306a\u3044\u306e\u3067\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306bshell\u306e\u74b0\u5883\u5909\u6570\u3092\u6e21\u3057\u307e\u3059\u3002\n\n```\n    environment:\n      MYSQL_ROOT_PASSWORD: $MYAPP_DATABASE_PASSWORD\n```\n\n### volumes\n\ndatabase\u306e\u3088\u3046\u306b\u6c38\u7d9a\u7684\u306a\u30b9\u30c8\u30ec\u30fc\u30b8\u304c\u6b32\u3057\u3044\u5834\u5408\u306b\u5fc5\u8981\u306a\u8a2d\u5b9a\u3067\u3059\u3002\n\n```\n    volumes:\n      - db-data:/var/lib/mysql\n\nvolumes:\n  db-data:\n    driver: local\n```\n\nhttps://docs.docker.com/compose/compose-file/#volume-configuration-reference\n\n### extends\n\n\u4eca\u56de\u306e\u4f8b\u306e\u3088\u3046\u306bweb\u3068worker container\u304c\u3042\u308a\u3001\u8a2d\u5b9a\u304c\u5171\u901a\u3057\u3066\u3044\u308b\u5834\u5408\u306b\u306fextends\u3092\u5229\u7528\u3057\u3066\u5171\u901a\u5316\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\n```\n  app:\n    build: .\n  web:\n    extends:\n      service: app\n    command: bundle exec rails s -p 3000 -b '0.0.0.0'\n  worker:\n    extends:\n      service: app\n    command: bundle exec sidekiq -q notification\n```\n\n\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092\u5206\u3051\u3066\u7ba1\u7406\u3059\u308b\u3053\u3068\u3082\u3067\u304d\u307e\u3059\u3002\nhttps://docs.docker.com/compose/compose-file/#extends\n\n### links\n\nlinks\u3092\u8a2d\u5b9a\u3059\u308b\u3068\u3001container\u5185\u3067\u540d\u524d\u304c\u5f15\u3051\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\u4eca\u56de\u306e\u4f8b\u3067\u306fweb\u304cdb\u3068redis\u306b\u63a5\u7d9a\u3059\u308b\u305f\u3081\u3001\u8a2d\u5b9a\u3057\u3066\u3044\u307e\u3059\u3002\n\n```\n    links:\n      - db\n      - redis\n```\n\n## production(docker-compose.prod.yml)\n\n\n```yaml\nversion: '2'\nservices:\n  app:\n    build:\n      context: .\n      dockerfile: Dockerfile.prod\n    environment:\n      RAILS_SERVE_STATIC_FILES: 'true'\n      MYAPP_SECRET_KEY_BASE: $MYAPP_SECRET_KEY_BASE\n      MYAPP_DATABASE_USERNAME: app\n      MYAPP_DATABASE_PASSWORD: $MYAPP_DATABASE_PASSWORD\n      MYAPP_DATABASE_HOST: db\n      MYAPP_SLACK_API_TOKEN: $MYAPP_SLACK_API_TOKEN\n    logging:\n      driver: syslog\n      options:\n        syslog-address: \"udp://logs3.papertrailapp.com:xxx\"\n  web:\n    extends:\n      service: app\n    command: bundle exec puma -C config/puma.rb\n    links:\n      - db\n      - redis\n  worker:\n    extends:\n      service: app\n    command: bundle exec sidekiq -q notification\n    links:\n      - db\n      - redis\n\n  nginx:\n    build: ./nginx\n    ports:\n      - '80:80'\n      - '443:443'\n    volumes:\n      - /etc/letsencrypt:/etc/letsencrypt\n    links:\n      - web\n    logging:\n      driver: syslog\n      options:\n        syslog-address: \"udp://logs3.papertrailapp.com:xxx\"\n\n  db:\n    image: mysql\n    volumes:\n      - db-data:/var/lib/mysql\n    environment:\n      MYSQL_ROOT_PASSWORD: $MYAPP_DATABASE_PASSWORD\n      MYSQL_DATABASE: myapp_production\n      MYSQL_USER: driver\n      MYSQL_PASSWORD: $MYAPP_DATABASE_PASSWORD\n    logging:\n      driver: syslog\n      options:\n        syslog-address: \"udp://logs3.papertrailapp.com:xxx\"\n\n  redis:\n    image: redis:3.0.5\n    logging:\n      driver: syslog\n      options:\n        syslog-address: \"udp://logs3.papertrailapp.com:xxx\"\n\nvolumes:\n  db-data:\n    driver: local\n```\n\n### build\n\n`build: .`\u3067\u3042\u308c\u3070./Dockerfile\u3092\u4f7f\u3063\u3066build\u3057\u307e\u3059\u304c\u3001\u5225\u306edirectory\u3084file\u306e\u5834\u5408\u306b\u306fcontext,dockerfile\u3067\u6307\u5b9a\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n```\n  app:\n    build:\n      context: .\n      dockerfile: Dockerfile.prod\n```\n\n\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u66f8\u304f\u3068\u3001./nginx/Dockerfile\u3092\u4f7f\u3063\u3066build\u3057\u307e\u3059\u3002\n\n```\n  nginx:\n    build: ./nginx\n```\n\n### logging\n\n\u7279\u306b\u8a2d\u5b9a\u3057\u306a\u3044\u5834\u5408\u306f`driver: json-file`\u3068\u306a\u308a\u3001docker machine\u4e0a\u306e`/var/lib/docker/containers/*/*-json.log`\u306b\u30ed\u30b0\u304c\u51fa\u529b\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n\u30ed\u30b0\u3092\u4f55\u51e6\u304b\u306b\u96c6\u7d04\u3057\u305f\u3044\u5834\u5408\u306f\u3001fluentd container\u3092\u7528\u610f\u3057\u3066\u3042\u308c\u3053\u308c\u3057\u305f\u308a\u3001\u4ee5\u4e0b\u306e\u69d8\u306alogging\u8a2d\u5b9a\u3092\u3059\u308b\u65b9\u6cd5\u306a\u3069\u304c\u8003\u3048\u3089\u308c\u307e\u3059\u3002\n\n```\n    logging:\n      driver: syslog\n      options:\n        syslog-address: \"udp://logs3.papertrailapp.com:xxx\"\n```\nhttps://papertrailapp.com/ \u306b\u8ee2\u9001\u3059\u308b\u4f8b\u3067\u3059\u3002\u5b9f\u969b\u306b\u306fxxx\u306b\u6307\u5b9a\u3055\u308c\u305fport\u756a\u53f7\u3092\u66f8\u3044\u3066\u304a\u304f\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\nDocker\u672c\u4f53\u306b\u95a2\u308f\u308b\u3053\u3068\u3067\u3059\u304c\u3001log\u5468\u308a\u306f\u4ee5\u4e0b\u304c\u7247\u4ed8\u304f\u3068\u307e\u305f\u304b\u308f\u3063\u3066\u304f\u308b\u3068\u601d\u3044\u307e\u3059\u3002\n- [Logging driver plugins](https://github.com/docker/docker/issues/18604)\n- [Proposal: New logging driver that logs to tcp, udp and unix domain sockets](https://github.com/docker/docker/pull/18001)\n\n\n## \u88dc\u8db3\n\n### Dockerfile\n\n```\n$ cat Dockerfile\nFROM ruby:2.2.4\nENV LANG C.UTF-8\nRUN apt-get update -qq && apt-get install -y build-essential\nRUN mkdir /myapp\nWORKDIR /myapp\nADD Gemfile Gemfile.lock /myapp/\nRUN bundle install\nADD . /myapp\n```\n\n### Dockerfile.prod\n\n```\nFROM ruby:2.2.4\nENV LANG C.UTF-8\nRUN apt-get update -qq && apt-get install -y build-essential\nRUN mkdir /myapp\nWORKDIR /myapp\n\nADD Gemfile Gemfile.lock /myapp/\nRUN bundle install --jobs 20 --retry 5 --without development test\n\nENV RAILS_ENV production\nADD . /myapp\nRUN bundle exec rake tmp:create\nRUN bundle exec rake assets:precompile\n```\n\n### .dockerignore\n\n.dockerignore\u30d5\u30a1\u30a4\u30eb\u3092\u7528\u610f\u3059\u308b\u3053\u3068\u3067\u4f59\u8a08\u306a\u3082\u306e\u3092container\u306b\u8f09\u305b\u305a\u306b\u3059\u307f\u307e\u3059\u3002\nhttps://docs.docker.com/engine/reference/builder/#dockerignore-file\n\n```\n.git\nlog\ntmp\n```\n"}