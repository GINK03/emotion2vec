{"context": "PowerShell\u306e\u52c9\u5f37\u3092\u517c\u306d\u3066\u3001IIJ\u306eDNS\u30b5\u30fc\u30d3\u30b9\u3092\u64cd\u4f5c\u3059\u308b\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u4f5c\u6210\u3057\u3066\u307f\u307e\u3057\u305f\u3002\n\n\u30b5\u30f3\u30d7\u30eb\u30b3\u30fc\u30c9\n\u30b5\u30f3\u30d7\u30eb\u3067\u3059\u306e\u3067\u3001\u4e00\u90e8\u306e\u6a5f\u80fd\u3060\u3051\u3092Function\u3068\u3057\u3066\u5b9f\u88c5\u3057\u3066\u307e\u3059\u3002API\u3078\u306e\u30a2\u30af\u30bb\u30b9\u3001\u8a8d\u8a3c\u306a\u3069\u306e\u57fa\u672c\u90e8\u5206\u306f\u66f8\u3044\u3066\u3042\u308b\u306e\u3067\u3001\u3042\u3068\u306f\u5fc5\u8981\u306a\u6a5f\u80fd\u3092\u8ffd\u52a0\u3057\u3066\u3044\u3051\u3070\u4f7f\u3048\u308b\u30e2\u30ce\u306b\u306a\u308b\u3068\u601d\u3044\u307e\u3059\u3002\n##################################################################\n# iij_do_api.ps1\n# IIJ DNS\u30b5\u30fc\u30d3\u30b9REST API(DO-API)\u30a2\u30af\u30bb\u30b9\u7528\u30b5\u30f3\u30d7\u30eb\u30b9\u30af\u30ea\u30d7\u30c8\n#\n# API Reference\n# http://manual.iij.jp/dns/doapi/index.html\n##################################################################\n\n$IIJAPI_ACCESS_KEY = \"YOUR_ACCESS_KEY_HERE\"\n$IIJAPI_SECRET_KEY = \"YOUR_SECRET_KEY_HERE\"\n$ApiVersion = \"20140601\"\n$DoServiceCode = \"do1234567\"            # \u30b5\u30fc\u30d3\u30b9\u30b3\u30fc\u30c9(IIJ\u30b5\u30fc\u30d3\u30b9\u30aa\u30f3\u30e9\u30a4\u30f3\u3067\u78ba\u8a8d)\n$ExpireOffset = \"60\"                    # API\u306e\u6709\u52b9\u671f\u9650\u3092\u5206\u3067\u6307\u5b9a\u3059\u308b\n$AccessDomain = \"do.api.iij.jp\"         # \u30a2\u30af\u30bb\u30b9\u30c9\u30e1\u30a4\u30f3\n$DebugFileName = \"c:\\IIJDNS_DEBUG.txt\"  # \u30a8\u30e9\u30fc\u30ec\u30b9\u30dd\u30f3\u30b9\u306e\u51fa\u529b\u5148\u30d5\u30a1\u30a4\u30eb\n\n\n##################################################################\n# URL\u30a8\u30f3\u30b3\u30fc\u30c9\n##################################################################\nfunction Encode-URL($s){\n    ($s.ToCharArray() | foreach {\n            if ($_ -match \"[a-z]|[-,_,.,~,)]|[0-9]\") { \n                $_\n            } else {\n                \"{0}{1:X}\" -f \"%\", [System.Text.Encoding]::ASCII.GetBytes($_)[0]\n            }\n        }) -join \"\"\n}\n\n##################################################################\n# \u8a8d\u8a3c\u7528\u30b7\u30b0\u30cd\u30c1\u30e3\u751f\u6210\n##################################################################\nfunction Get-Signature($Method, $Api, $ContentMd5Value, $ContentTypeValue, $IIJApiExpire, $RequestPath) {\n\n  $TempStr = New-Object System.Text.UTF8Encoding($false)\n  $TempStr = $Method + \"`n\" `\n           + $ContentMd5Value + \"`n\" `\n           + $ContentTypeValue + \"`n\" `\n           + \"x-iijapi-expire:\" + $IIJApiExpire + \"`n\" `\n           + \"x-iijapi-signaturemethod:HmacSHA256\" + \"`n\" `\n           + \"x-iijapi-signatureversion:2\" + \"`n\" `\n           + $RequestPath\n\n  $hmac = New-Object System.Security.Cryptography.HMACSHA256\n  $hmac.Key = $IIJAPI_SECRET_KEY.ToCharArray()\n  $hash = $hmac.ComputeHash([System.Text.Encoding]::ASCII.GetBytes($TempStr))\n  $signature = [System.Convert]::ToBase64String($hash)\n\n  return $signature\n}\n\n##################################################################\n# \u30be\u30fc\u30f3\u60c5\u5831\u306e\u53d6\u5f97\n##################################################################\nfunction Get-Zones ($IIJApiExpire) {\n\n  $RequestPath = \"/r/$ApiVersion/$DOServiceCode/zones.json\"\n  $Signature = Get-Signature \"GET\" \"zones\" \"\" \"\" \"$IIJApiExpire\" \"$RequestPath\"\n  $Headers = @{  \"x-iijapi-expire\" = \"$IIJApiExpire\";\n                 \"x-iijapi-signaturemethod\" = \"HmacSHA256\";\n                 \"x-iijapi-signatureversion\" = \"2\";\n                 \"Authorization\" = \"IIJAPI ${IIJAPI_ACCESS_KEY}:${Signature}\";\n              }\n\n  try{\n    $Resp = Invoke-RestMethod -Uri \"https://${AccessDomain}${RequestPath}\" -Headers $Headers\n  }\n  catch {\n    $Resp = $_.Exception.Response.GetResponseStream()\n    $Reader = New-Object System.IO.StreamReader($Resp)\n    $ResponseBody = $Reader.ReadToEnd();\n    $ResponseBody | Out-File $DebugFileName -Append\n  }\n\n  return $Resp.Zonelist\n}\n\n##################################################################\n# \u30be\u30fc\u30f3\u8a73\u7d30\u60c5\u5831\u306e\u53d6\u5f97\n##################################################################\nfunction Get-ZoneDetail ($IIJApiExpire, $ZoneName) {\n\n  $RequestPath = \"/r/$ApiVersion/$DOServiceCode/$ZoneName/zone.json\"\n  $Signature = Get-Signature \"GET\" \"zone\" \"\" \"\" \"$IIJApiExpire\" \"$RequestPath\"\n  $Headers = @{  \"x-iijapi-expire\" = \"$IIJApiExpire\";\n                 \"x-iijapi-signaturemethod\" = \"HmacSHA256\";\n                 \"x-iijapi-signatureversion\" = \"2\";\n                 \"Authorization\" = \"IIJAPI ${IIJAPI_ACCESS_KEY}:${Signature}\";\n              }\n\n  try{\n    $Resp = Invoke-RestMethod -Uri \"https://${AccessDomain}${RequestPath}\" -Headers $Headers\n  }\n  catch {\n    $Resp = $_.Exception.Response.GetResponseStream()\n    $Reader = New-Object System.IO.StreamReader($Resp)\n    $ResponseBody = $Reader.ReadToEnd();\n    $ResponseBody | Out-File $DebugFileName -Append\n   }\n\n  return $Resp\n}\n\n##################################################################\n# \u30ec\u30b3\u30fc\u30c9\u60c5\u5831\u306e\u53d6\u5f97\n##################################################################\nfunction Get-Records ($IIJApiExpire, $Zone) {\n\n  $RequestPath = \"/r/$ApiVersion/$DOServiceCode/$Zone/records/detail.json\"\n  $Signature = Get-Signature \"GET\" \"records\" \"\" \"\" \"$IIJApiExpire\" \"$RequestPath\"\n  $Headers = @{  \"x-iijapi-expire\" = \"$IIJApiExpire\";\n                 \"x-iijapi-signaturemethod\" = \"HmacSHA256\";\n                 \"x-iijapi-signatureversion\" = \"2\";\n                 \"Authorization\" = \"IIJAPI ${IIJAPI_ACCESS_KEY}:${Signature}\";\n              }\n\n  try{\n    $Resp = Invoke-RestMethod -Uri \"https://${AccessDomain}${RequestPath}\" -Headers $Headers\n  }\n  catch {\n    $Resp = $_.Exception.Response.GetResponseStream()\n    $Reader = New-Object System.IO.StreamReader($Resp)\n    $ResponseBody = $Reader.ReadToEnd();\n    $ResponseBody | Out-File $DebugFileName -Append\n  }\n\n  return $Resp\n}\n\n##################################################################\n# Main Application Logic\n##################################################################\n\n# API\u6709\u52b9\u671f\u9593\u306e\u8a2d\u5b9a\n$TempDate = (Get-Date).AddMinutes($ExpireOffset)\n$IIJApiExpire = \"{0:s}\" -f $TempDate\n$IIJApiExpire = $IIJApiExpire + \"Z\"\n\n# \u30be\u30fc\u30f3\u60c5\u5831\u306e\u53d6\u5f97(\u914d\u5217\u3068\u3057\u3066\u53d6\u5f97\uff09\n$Zones = Get-Zones \"$IIJApiExpire\"\n\n# \u30be\u30fc\u30f3\u8a73\u7d30\u60c5\u5831\u306e\u53d6\u5f97\nfor($i=0; $i -lt $Zones.Length; $i++){\n  $ZoneDetail = Get-ZoneDetail \"$IIJApiExpire\" $Zones[$i]\n  Write-Host $ZoneDetail.RequestId\n  Write-Host $ZoneDetail.Zone  # Type; Name; TTL; Serial; Status; RecordNum; Committable\n}\n\n# \u30ec\u30b3\u30fc\u30c9\u60c5\u5831\u306e\u53d6\u5f97\n$Signature = Get-Signature \"GET\" \"records\" \"\" \"\" \"$IIJApiExpire\"\n$Records = Get-Records \"$IIJApiExpire\" $Zones[0]\nWrite-Host $Records\n\n\n\nPowerShell\u306e\u52c9\u5f37\u3092\u517c\u306d\u3066\u3001IIJ\u306eDNS\u30b5\u30fc\u30d3\u30b9\u3092\u64cd\u4f5c\u3059\u308b\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u4f5c\u6210\u3057\u3066\u307f\u307e\u3057\u305f\u3002\n\n## \u30b5\u30f3\u30d7\u30eb\u30b3\u30fc\u30c9\n\u30b5\u30f3\u30d7\u30eb\u3067\u3059\u306e\u3067\u3001\u4e00\u90e8\u306e\u6a5f\u80fd\u3060\u3051\u3092Function\u3068\u3057\u3066\u5b9f\u88c5\u3057\u3066\u307e\u3059\u3002API\u3078\u306e\u30a2\u30af\u30bb\u30b9\u3001\u8a8d\u8a3c\u306a\u3069\u306e\u57fa\u672c\u90e8\u5206\u306f\u66f8\u3044\u3066\u3042\u308b\u306e\u3067\u3001\u3042\u3068\u306f\u5fc5\u8981\u306a\u6a5f\u80fd\u3092\u8ffd\u52a0\u3057\u3066\u3044\u3051\u3070\u4f7f\u3048\u308b\u30e2\u30ce\u306b\u306a\u308b\u3068\u601d\u3044\u307e\u3059\u3002\n\n```ps1\n##################################################################\n# iij_do_api.ps1\n# IIJ DNS\u30b5\u30fc\u30d3\u30b9REST API(DO-API)\u30a2\u30af\u30bb\u30b9\u7528\u30b5\u30f3\u30d7\u30eb\u30b9\u30af\u30ea\u30d7\u30c8\n#\n# API Reference\n# http://manual.iij.jp/dns/doapi/index.html\n##################################################################\n\n$IIJAPI_ACCESS_KEY = \"YOUR_ACCESS_KEY_HERE\"\n$IIJAPI_SECRET_KEY = \"YOUR_SECRET_KEY_HERE\"\n$ApiVersion = \"20140601\"\n$DoServiceCode = \"do1234567\"            # \u30b5\u30fc\u30d3\u30b9\u30b3\u30fc\u30c9(IIJ\u30b5\u30fc\u30d3\u30b9\u30aa\u30f3\u30e9\u30a4\u30f3\u3067\u78ba\u8a8d)\n$ExpireOffset = \"60\"                    # API\u306e\u6709\u52b9\u671f\u9650\u3092\u5206\u3067\u6307\u5b9a\u3059\u308b\n$AccessDomain = \"do.api.iij.jp\"         # \u30a2\u30af\u30bb\u30b9\u30c9\u30e1\u30a4\u30f3\n$DebugFileName = \"c:\\IIJDNS_DEBUG.txt\"  # \u30a8\u30e9\u30fc\u30ec\u30b9\u30dd\u30f3\u30b9\u306e\u51fa\u529b\u5148\u30d5\u30a1\u30a4\u30eb\n\n\n##################################################################\n# URL\u30a8\u30f3\u30b3\u30fc\u30c9\n##################################################################\nfunction Encode-URL($s){\n    ($s.ToCharArray() | foreach {\n\t\t\tif ($_ -match \"[a-z]|[-,_,.,~,)]|[0-9]\") { \n\t\t\t\t$_\n\t\t\t} else {\n\t\t\t\t\"{0}{1:X}\" -f \"%\", [System.Text.Encoding]::ASCII.GetBytes($_)[0]\n\t\t\t}\n\t\t}) -join \"\"\n}\n\n##################################################################\n# \u8a8d\u8a3c\u7528\u30b7\u30b0\u30cd\u30c1\u30e3\u751f\u6210\n##################################################################\nfunction Get-Signature($Method, $Api, $ContentMd5Value, $ContentTypeValue, $IIJApiExpire, $RequestPath) {\n  \n  $TempStr = New-Object System.Text.UTF8Encoding($false)\n  $TempStr = $Method + \"`n\" `\n           + $ContentMd5Value + \"`n\" `\n           + $ContentTypeValue + \"`n\" `\n           + \"x-iijapi-expire:\" + $IIJApiExpire + \"`n\" `\n           + \"x-iijapi-signaturemethod:HmacSHA256\" + \"`n\" `\n           + \"x-iijapi-signatureversion:2\" + \"`n\" `\n           + $RequestPath\n  \n  $hmac = New-Object System.Security.Cryptography.HMACSHA256\n  $hmac.Key = $IIJAPI_SECRET_KEY.ToCharArray()\n  $hash = $hmac.ComputeHash([System.Text.Encoding]::ASCII.GetBytes($TempStr))\n  $signature = [System.Convert]::ToBase64String($hash)\n\n  return $signature\n}\n\n##################################################################\n# \u30be\u30fc\u30f3\u60c5\u5831\u306e\u53d6\u5f97\n##################################################################\nfunction Get-Zones ($IIJApiExpire) {\n\n  $RequestPath = \"/r/$ApiVersion/$DOServiceCode/zones.json\"\n  $Signature = Get-Signature \"GET\" \"zones\" \"\" \"\" \"$IIJApiExpire\" \"$RequestPath\"\n  $Headers = @{  \"x-iijapi-expire\" = \"$IIJApiExpire\";\n                 \"x-iijapi-signaturemethod\" = \"HmacSHA256\";\n                 \"x-iijapi-signatureversion\" = \"2\";\n                 \"Authorization\" = \"IIJAPI ${IIJAPI_ACCESS_KEY}:${Signature}\";\n              }\n\n  try{\n    $Resp = Invoke-RestMethod -Uri \"https://${AccessDomain}${RequestPath}\" -Headers $Headers\n  }\n  catch {\n    $Resp = $_.Exception.Response.GetResponseStream()\n    $Reader = New-Object System.IO.StreamReader($Resp)\n    $ResponseBody = $Reader.ReadToEnd();\n    $ResponseBody | Out-File $DebugFileName -Append\n  }\n\n  return $Resp.Zonelist\n}\n\n##################################################################\n# \u30be\u30fc\u30f3\u8a73\u7d30\u60c5\u5831\u306e\u53d6\u5f97\n##################################################################\nfunction Get-ZoneDetail ($IIJApiExpire, $ZoneName) {\n\n  $RequestPath = \"/r/$ApiVersion/$DOServiceCode/$ZoneName/zone.json\"\n  $Signature = Get-Signature \"GET\" \"zone\" \"\" \"\" \"$IIJApiExpire\" \"$RequestPath\"\n  $Headers = @{  \"x-iijapi-expire\" = \"$IIJApiExpire\";\n                 \"x-iijapi-signaturemethod\" = \"HmacSHA256\";\n                 \"x-iijapi-signatureversion\" = \"2\";\n                 \"Authorization\" = \"IIJAPI ${IIJAPI_ACCESS_KEY}:${Signature}\";\n              }\n\n  try{\n    $Resp = Invoke-RestMethod -Uri \"https://${AccessDomain}${RequestPath}\" -Headers $Headers\n  }\n  catch {\n    $Resp = $_.Exception.Response.GetResponseStream()\n    $Reader = New-Object System.IO.StreamReader($Resp)\n    $ResponseBody = $Reader.ReadToEnd();\n    $ResponseBody | Out-File $DebugFileName -Append\n   }\n\n  return $Resp\n}\n\n##################################################################\n# \u30ec\u30b3\u30fc\u30c9\u60c5\u5831\u306e\u53d6\u5f97\n##################################################################\nfunction Get-Records ($IIJApiExpire, $Zone) {\n\n  $RequestPath = \"/r/$ApiVersion/$DOServiceCode/$Zone/records/detail.json\"\n  $Signature = Get-Signature \"GET\" \"records\" \"\" \"\" \"$IIJApiExpire\" \"$RequestPath\"\n  $Headers = @{  \"x-iijapi-expire\" = \"$IIJApiExpire\";\n                 \"x-iijapi-signaturemethod\" = \"HmacSHA256\";\n                 \"x-iijapi-signatureversion\" = \"2\";\n                 \"Authorization\" = \"IIJAPI ${IIJAPI_ACCESS_KEY}:${Signature}\";\n              }\n\n  try{\n    $Resp = Invoke-RestMethod -Uri \"https://${AccessDomain}${RequestPath}\" -Headers $Headers\n  }\n  catch {\n    $Resp = $_.Exception.Response.GetResponseStream()\n    $Reader = New-Object System.IO.StreamReader($Resp)\n    $ResponseBody = $Reader.ReadToEnd();\n    $ResponseBody | Out-File $DebugFileName -Append\n  }\n\n  return $Resp\n}\n\n##################################################################\n# Main Application Logic\n##################################################################\n\n# API\u6709\u52b9\u671f\u9593\u306e\u8a2d\u5b9a\n$TempDate = (Get-Date).AddMinutes($ExpireOffset)\n$IIJApiExpire = \"{0:s}\" -f $TempDate\n$IIJApiExpire = $IIJApiExpire + \"Z\"\n\n# \u30be\u30fc\u30f3\u60c5\u5831\u306e\u53d6\u5f97(\u914d\u5217\u3068\u3057\u3066\u53d6\u5f97\uff09\n$Zones = Get-Zones \"$IIJApiExpire\"\n\n# \u30be\u30fc\u30f3\u8a73\u7d30\u60c5\u5831\u306e\u53d6\u5f97\nfor($i=0; $i -lt $Zones.Length; $i++){\n  $ZoneDetail = Get-ZoneDetail \"$IIJApiExpire\" $Zones[$i]\n  Write-Host $ZoneDetail.RequestId\n  Write-Host $ZoneDetail.Zone  # Type; Name; TTL; Serial; Status; RecordNum; Committable\n}\n\n# \u30ec\u30b3\u30fc\u30c9\u60c5\u5831\u306e\u53d6\u5f97\n$Signature = Get-Signature \"GET\" \"records\" \"\" \"\" \"$IIJApiExpire\"\n$Records = Get-Records \"$IIJApiExpire\" $Zones[0]\nWrite-Host $Records\n\n```\n", "tags": ["PowerShell", "rest"]}