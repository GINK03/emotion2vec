{"tags": ["PostgreSQL", "barman", "\u30d0\u30c3\u30af\u30a2\u30c3\u30d7"], "context": "\u3053\u306e\u8a18\u4e8b\u306fPostgreSQL Advent Calendar 2016\u306e7\u65e5\u76ee\u306e\u8a18\u4e8b\u3067\u3059\u3002\n\n\u306f\u3058\u3081\u306b\n\u76f4\u524d\u307e\u3067\u4f55\u66f8\u304f\u304b\u5168\u7136\u6c7a\u3081\u3066\u3044\u306a\u304b\u3063\u305f\u306e\u3067\u3059\u304c\u3001PGConf.Asia 2016(12/1\uff5e12/3)\u306b\u53c2\u52a0\u3057\u3001Magnus\u3055\u3093\u306e\u8b1b\u6f14\u3067barman\u306b\u8208\u5473\u3092\u6301\u3063\u305f\u306e\u3067\u3001\u4eca\u56de\u8abf\u3079\u3066\u307f\u308b\u3053\u3068\u306b\u3057\u307e\u3057\u305f\u3002\n\u3061\u306a\u307f\u306bbarman\u3068\u306f2ndQuadrant\u304cGithub\u3067\u516c\u958b\u3057\u3066\u3044\u308bPostgreSQL\u5c02\u7528\u306e\u30d0\u30c3\u30af\u30a2\u30c3\u30d7/\u30ea\u30ab\u30d0\u30ea\u7ba1\u7406\u30c4\u30fc\u30eb\u3067\u3059\u3002\nbarman\u306e\u57fa\u672c\u7684\u306a\u6a5f\u80fd\u7d39\u4ecb\u7b49\u306b\u3064\u3044\u3066\u306f\u3001PGECons\u306e\u5831\u544a\u66f8\u304c\u53c2\u8003\u306b\u306a\u308b\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u3002\u8208\u5473\u306e\u3042\u308b\u304b\u305f\u306f\u3054\u4e00\u8aad\u304f\u3060\u3055\u3044\u3002\n\n1.barman 2.0\u306e\u65b0\u6a5f\u80fd\n\u6700\u65b0\u7248\u306e2.0\u304c2016\u5e749\u6708\u306b\u30ea\u30ea\u30fc\u30b9\u3055\u308c\u307e\u3057\u305f\u3002\n\u3069\u3046\u3044\u3063\u305f\u6a5f\u80fd\u304c\u5b9f\u88c5\u3055\u308c\u305f\u306e\u304b\u8a73\u7d30\u306f\u30ea\u30ea\u30fc\u30b9\u30ce\u30fc\u30c8\u3092\u3054\u78ba\u8a8d\u304f\u3060\u3055\u3044\u3002\n\u591a\u304f\u306e\u66f4\u65b0\u304c\u5165\u3063\u3066\u3044\u307e\u3059\u304c\u3001\u4e3b\u306a\u65b0\u6a5f\u80fd\u3068\u3057\u3066\u306f\u4ee5\u4e0b\u306e4\u3064\u3050\u3089\u3044\u3067\u3057\u3087\u3046\u304b\u3002\n\u672c\u5f53\u306f\u5168\u90e8\u3084\u308b\u3064\u3082\u308a\u3060\u3063\u305f\u306e\u3067\u3059\u304c\u3001\u4eca\u56de\u306f\u6642\u9593\u304c\u306a\u304b\u3063\u305f\u306e\u3067\u500b\u4eba\u7684\u306b\u97ff\u3044\u305f\u9805\u756a3\u306b\u3064\u3044\u3066\u306e\u307f\u78ba\u8a8d\u3057\u3066\u307f\u307e\u3057\u305f\u3002\n\n\n\n\u9805\u756a\n\u6982\u8981\n\u5099\u8003\n\n\n\n\n1\n\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30b9\u30ed\u30c3\u30c8\u306b\u5bfe\u5fdc\nreceive-wal\u30b3\u30de\u30f3\u30c9\u3067--create-slot\u3068--drop-slot\u30b3\u30de\u30f3\u30c9\u304c\u30b5\u30dd\u30fc\u30c8\n\n\n2\nPG96\u304b\u3089\u5c0e\u5165\u3055\u308c\u305f\u65b0\u3057\u3044\u30d0\u30c3\u30af\u30a2\u30c3\u30d7API\u3092\u30b5\u30dd\u30fc\u30c8\n9.2\uff5e9.5\u307e\u3067\u306f\u30b9\u30bf\u30f3\u30d0\u30a4\u304b\u3089\u306e\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u53d6\u5f97\u306bpgespresso\u304c\u5fc5\u8981\u3060\u3063\u305f\u304c\u4eca\u5f8c\u306f\u4e0d\u8981\u3002\n\n\n3\n\u540c\u671f\u30b9\u30bf\u30f3\u30d0\u30a4\u3068\u3057\u3066\u306eWAL\u30b9\u30c8\u30ea\u30fc\u30df\u30f3\u30b0\u6a5f\u80fd\u3092\u30b5\u30dd\u30fc\u30c8\n\u3053\u306e\u6a5f\u80fd\u306b\u3088\u308aRPO=0\uff08\u3069\u306e\u6642\u70b9\u306b\u3067\u3082\u5fa9\u65e7\u53ef\u80fd\uff09\u3068\u306a\u308b\u3002\n\n\n4\nbarman-wal-restore\u30aa\u30d7\u30b7\u30e7\u30f3\u3067WAL\u30d5\u30a1\u30a4\u30eb\u306e\u30ea\u30e2\u30fc\u30c8\u30d1\u30e9\u30ec\u30eb\u30d5\u30a7\u30c3\u30c1\u3092\u30b5\u30dd\u30fc\u30c8\n\u305f\u3076\u3093\u3001\u30ea\u30b9\u30c8\u30a2\u304c\u65e9\u304f\u306a\u308b\u3068\u3044\u3046\u8a71\u3068\u601d\u308f\u308c\u308b\u3002\uff08\u8981\u78ba\u8a8d\uff09\n\n\n\n\u300c\u898b\u305b\u3066\u3082\u3089\u304a\u3046\u304b\u3001barman\u306e\u65b0\u6a5f\u80fd\u306e\u5b9f\u529b\u3068\u3084\u3089\u3092\uff01\u300d\n\n2.\u74b0\u5883\u69cb\u7bc9\n\u672c\u4f5c\u696d\u306f\u4ee5\u4e0b\u306e\u6761\u4ef6\u3067\u5b9f\u65bd\u3057\u307e\u3059\u3002\n\n\u69cb\u6210\n\n\n\u30de\u30b9\u30bf(node_yama)\uff0b\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u30b5\u30fc\u30d0(node_umi)\u306e2\u53f0\u69cb\u6210\n\n\n\u88fd\u54c1\n\n\nbarman 2.0\nPostgreSQL 9.6.1 \uff08RPM\u3067\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3055\u308c\u305f\u72b6\u614b\u3092\u524d\u63d0\u3068\u3059\u308b\u3002\uff09\n\n\n\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u30b5\u30fc\u30d0\u306b\u3082PostgreSQL\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u5fc5\u8981\u3042\u308a\u3002pg_basebackup\u3084pg_receivexlog\u3092\u4f7f\u7528\u3059\u308b\u305f\u3081\u3002\n\n\nCentOS 7.2\n\n\n\n\nPostgreSQL\u306e\u30d1\u30e9\u30e1\u30fc\u30bf\u306f\u4ee5\u4e0b\u306e\u70b9\u3092\u5909\u66f4\u3057\u307e\u3059\u3002\n\n$PGDATA/postgresql.conf\nwal_level = 'replica'\nmax_wal_senders = 3\nmax_replication_slots = 3\nsynchronous_standby_names = 'barman_receive_wal'\n\n\n\n2-1. DB\u30b5\u30fc\u30d0\u3067\u306e\u4f5c\u696d\uff08node_yama\u3067\u5b9f\u65bd\uff09\n\nbarman\u304c\u7ba1\u7406\u3067\u4f7f\u7528\u3059\u308b\u305f\u3081\u306eROLE\u3092\u4f5c\u6210\u3059\u308b\u3002\nbarman\u304b\u3089PostgreSQL\u306b\u63a5\u7d9a\u3059\u308b\u969b\u306eROLE\u3092\u4f5c\u6210\u3059\u308b\u3002\n[postgres@node_yama]$ createuser -s barman\n\n\u7d9a\u3044\u3066\u3001Streaming Replication\u3092\u7528\u3044\u305f\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u3092\u884c\u3046\u305f\u3081\u306eROLE\u3092\u4f5c\u6210\u3059\u308b\u3002\n[postgres@node_yama]$ createuser --replication streaming_barman\n\n\n2-2. \u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u30b5\u30fc\u30d0\u3067\u306e\u4f5c\u696d\uff08node_umi\u3067\u5b9f\u65bd\uff09\n\nbarman\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\nDB\u30b5\u30fc\u30d0\u3068\u306f\u5225\u306e\u30de\u30b7\u30f3\u306b\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u307e\u3059\u3002\npython\u7cfb\u306eRPM\u3068\u4f9d\u5b58\u95a2\u4fc2\u304c\u3042\u308b\u306e\u3067\u3001yum\u3067\u5165\u308c\u3066\u3057\u307e\u3046\u306e\u304c\u624b\u3063\u53d6\u308a\u65e9\u3044\u3067\u3059\u3002\n[root@node_umi]# wget https://download.postgresql.org/pub/repos/yum/9.6/redhat/rhel-7-x86_64/pgdg-centos96-9.6-3.noarch.rpm\n[root@node_umi]# rpm -ivh pgdg-centos96-9.6-3.noarch.rpm\n[root@node_umi]# yum install barman\n[root@node_umi]# su - barman\n[barman@node_umi]$ barman --version\n2.0 Barman by 2ndQuadrant (www.2ndQuadrant.com)\n\n\nbarman\u3092\u8a2d\u5b9a\u3059\u308b\n\u6c17\u306b\u3057\u306a\u3044\u3068\u3044\u3051\u306a\u3044\u306e\u306f\u3056\u3063\u304f\u308a\u3068\u4ee5\u4e0b\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3067\u3059\u3002\nbarman\u5168\u4f53\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\uff1a/etc/barman.conf \nbarman\u3067\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u3055\u308c\u308b\u5404\u30b5\u30fc\u30d0\u306e\u8a2d\u5b9a\uff1a/etc/barman.d/\uff1c\u30ce\u30fc\u30c9\u540d\uff1e.conf\n\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u30d5\u30a1\u30a4\u30eb\u304c\u3042\u308b\u306e\u3067\u3001\u305d\u308c\u3092\u53c2\u8003\u306b\u3057\u306a\u304c\u3089\u66f8\u3044\u3066\u307f\u307e\u3059\u3002\n# cd /etc/barman.d/\n# cp streaming-server.conf-template node_yama.conf  \n\n\n/etc/barman.d/node_yama.conf\n[node_yama]\ndescription =  \"Example for Advent Calendar\"\nconninfo = host=node_yama user=barman dbname=postgres\nstreaming_conninfo = host=node_yama user=streaming_barman\n\n; ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;\n; Backup settings (via pg_basebackup)\n; ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;\nbackup_method = postgres\n;streaming_backup_name = barman_streaming_backup\n\n; ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;\n; WAL streaming settings (via pg_receivexlog)\n; ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;\nstreaming_archiver = on\nslot_name = barman_slot\n;streaming_archiver_name = barman_receive_wal\n;streaming_archiver_batch_size = 50\n\n\n\n\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30b9\u30ed\u30c3\u30c8\u3092\u4f5c\u6210\u3059\u308b\nbarman\u304b\u3089\u5bfe\u8c61\u306eDB\u30b5\u30fc\u30d0\u3067\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30b9\u30ed\u30c3\u30c8\u3092\u4f5c\u6210\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n$ barman receive-wal --create-slot node_yama\nCreating physical replication slot 'barman_slot' on server 'node_yama'\nReplication slot 'barman_slot' created\n\n\nbarman\u306e\u8a2d\u5b9a\u78ba\u8a8d\n\u4ee5\u4e0b\u306e\u30b3\u30de\u30f3\u30c9\u3067\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u53d6\u5f97\u5148\u3068\u306e\u72b6\u614b\u7b49\u3092\u78ba\u8a8d\u3067\u304d\u307e\u3059\u3002\n$ barman check node_yama                                                        \nServer node_yama:\n        WAL archive: FAILED (please make sure WAL shipping is setup)\n        PostgreSQL: OK\n        superuser: OK\n        PostgreSQL streaming: OK\n        wal_level: OK\n        replication slot: FAILED (slot 'barman_slot' not initialised: is 'receive-wal' running?)\n        directories: OK\n        retention policy settings: OK\n        backup maximum age: OK (no last_backup_maximum_age provided)\n        compression settings: OK\n        failed backups: OK (there are 0 failed backups)\n        minimum redundancy requirements: OK (have 0 backups, expected at least 0)\n        pg_basebackup: OK\n        pg_basebackup compatible: OK\n        pg_basebackup supports tablespaces mapping: OK\n        pg_receivexlog: OK\n        pg_receivexlog compatible: OK\n        receive-wal running: FAILED (See the Barman log file for more details)\n        archiver errors: OK\n\nWAL archive\u3001replication slot\u3001receive-wal running\u304c\u300cFAILED\u300d\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002\n\u5f8c\u308d2\u3064\u304c\u5931\u6557\u3057\u3066\u3044\u308b\u306e\u306f\u3001\u307e\u3060pg_receivexlog\u3092\u8d77\u52d5\u3057\u3066\u3044\u306a\u3044\u306e\u3067\u3001\u3054\u3082\u3063\u3068\u3082\u3002\nWAL archive\u306e\u9805\u76ee\u3067\u3059\u304c\u3001\u4e00\u65e6\u306f\u7121\u8996\u3057\u3066OK\u3067\u3059\u3002\n\u3053\u308c\u306fbarman\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3057\u305f\u969b\u306b\u4f5c\u6210\u3055\u308c\u308bxlog.db\u30d5\u30a1\u30a4\u30eb\uff08/var/lib/barman/node_yama/wals/xlog.db\uff09\u306e\u30d5\u30a1\u30a4\u30eb\u30b5\u30a4\u30ba\u304c0\u3067\u306a\u3044\u3053\u3068\u3092\u78ba\u8a8d\u3057\u3066\u304a\u308a\u3001\u307e\u3060\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u3082\u4f55\u3082\u3057\u3066\u3044\u306a\u3044\u306e\u3067\u3001\u3053\u306e\u6bb5\u968e\u3067\u306fFAILD\u306b\u306a\u308a\u307e\u3059\u3002\n\u4ee5\u4e0a\u3067\u74b0\u5883\u69cb\u7bc9\u306f\u7d42\u308f\u308a\u3067\u3059\u3002\n\n3.barman\u306b\u3088\u308b\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u53d6\u5f97\n\nbarman\u7d4c\u7531\u3067\u306epg_receivexlog\u8d77\u52d5\n[barman@node_umi]$ barman receive-wal node_yama\nStarting receive-wal for server node_yama\nnode_yama: pg_receivexlog: starting log streaming at 0/10000000 (timeline 1)\n\n\u203b\u3061\u306a\u307f\u306b\u3053\u306e\u30d7\u30ed\u30bb\u30b9\u306f\u30d5\u30a9\u30a2\u30b0\u30e9\u30a6\u30f3\u30c9\u3067\u52d5\u304d\u307e\u3059\uff01\n\nWAL\u306e\u624b\u52d5\u5207\u308a\u66ff\u3048\n\u81ea\u5206\u306e\u74b0\u5883\u3060\u3068\u3053\u306e\u624b\u9806\u3092\u5165\u308c\u306a\u3044\u3068\u3046\u307e\u304f\u884c\u304d\u307e\u305b\u3093\u3067\u3057\u305f\u3002\n\u7406\u7531\u306f\u3088\u304f\u308f\u304b\u3089\u305a\u3002\u3002\u3002xlog.db\u3068\u95a2\u9023\u304c\u3042\u308b\u3068\u306f\u601d\u3046\u306e\u3067\u3059\u304c\u3002\u3002\u3002\n[barman@node_umi]$ barman switch-xlog node_yama\nSwitch to 000000010000000000000011 for server 'node_yama'\n\npg_receivexlog\u3067\u53d7\u4fe1\u304c\u3067\u304d\u3066\u3044\u308c\u3070\u3001\u300cnode_yama: pg_receivexlog: finished segment at 0/11000000 (timeline 1)\u300d\u304c\u65b0\u3057\u304f\u30b3\u30f3\u30bd\u30fc\u30eb\u306b\u51fa\u529b\u3055\u308c\u308b\u306f\u305a\u3067\u3059\u3002\n\n\u30d9\u30fc\u30b9\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u53d6\u5f97\n[barman@node_umi]$ barman backup node_yama\nStarting backup using postgres method for server node_yama in /var/lib/barman/node_yama/base/20161207T132607\nBackup start at xlog location: 0/11000060 (000000010000000000000011, 00000060)\nCopying files.\nCopy done.\nFinalising the backup.\nThis is the first backup for server node_yama\nWAL segments preceding the current backup have been found:\n        000000010000000000000010 from server node_yama has been removed\nBackup size: 171.6 MiB\nBackup end at xlog location: 0/13000000 (000000010000000000000012, 00000000)\nBackup completed\nProcessing xlog segments from streaming for node_yama\n        000000010000000000000011\n\n\u3053\u308c\u3067\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u306e\u53d6\u5f97\u306f\u5b8c\u4e86\u3067\u3059\u3002\n\u3061\u306a\u307f\u306b\u3053\u306e\u72b6\u614b\u3067check\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3059\u308b\u3068\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\n[barman@node_umi]$ barman check node_yama                                                        \nServer node_yama:\n        PostgreSQL: OK\n        superuser: OK\n        PostgreSQL streaming: OK\n        wal_level: OK\n        replication slot: OK\n        directories: OK\n        retention policy settings: OK\n        backup maximum age: OK (no last_backup_maximum_age provided)\n        compression settings: OK\n        failed backups: OK (there are 0 failed backups)\n        minimum redundancy requirements: OK (have 1 backups, expected at least 0)\n        pg_basebackup: OK\n        pg_basebackup compatible: OK\n        pg_basebackup supports tablespaces mapping: OK\n        pg_receivexlog: OK\n        pg_receivexlog compatible: OK\n        receive-wal running: OK\n        archiver errors: OK\n\n\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u306e\u53d6\u5f97\u72b6\u6cc1\u306b\u3064\u3044\u3066\u306f\u4ee5\u4e0b\u306e\u30b3\u30de\u30f3\u30c9\u3067\u78ba\u8a8d\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\u4f55\u5ea6\u304b\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u3092\u53d6\u5f97\u3057\u305f\u308a\u3057\u3066\u3044\u308b\u3068\u3053\u3093\u306a\u611f\u3058\u3067\u5897\u3048\u3066\u3044\u304d\u307e\u3059\u3002\n[barman@node_umi]$ barman list-backup node_yama\nnode_yama 20161207T144606 - Wed Dec  7 14:46:06 2016 - Size: 187.6 MiB - WAL Size: 0 B\nnode_yama 20161207T144354 - Wed Dec  7 14:43:54 2016 - Size: 187.6 MiB - WAL Size: 64.0 MiB\nnode_yama 20161207T140602 - Wed Dec  7 14:06:02 2016 - Size: 187.6 MiB - WAL Size: 48.0 MiB\nnode_yama 20161207T132607 - Wed Dec  7 13:26:07 2016 - Size: 187.6 MiB - WAL Size: 128.0 MiB\n\n\n4.\u65b0\u6a5f\u80fd3\u306e\u78ba\u8a8d\n\u300c\u65b0\u6a5f\u80fd3\uff1a\u540c\u671f\u30b9\u30bf\u30f3\u30d0\u30a4\u3068\u3057\u3066\u306eWAL\u30b9\u30c8\u30ea\u30fc\u30df\u30f3\u30b0\u6a5f\u80fd\u3092\u30b5\u30dd\u30fc\u30c8\u300d\u304cPostgreSQL\u4e0a\u304b\u3089\u3069\u306e\u3088\u3046\u306b\u898b\u3048\u308b\u304b\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u3001\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30b9\u30ed\u30c3\u30c8\u3092\u5229\u7528\u3057\u305fbarman\u3078\u306eWAL\u30b9\u30c8\u30ea\u30fc\u30df\u30f3\u30b0\u304c\u540c\u671f\u30e2\u30fc\u30c9\u3067\u52d5\u3044\u3066\u3044\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3067\u304d\u307e\u3057\u305f\u3002\n[postgres@node_yama]$ psql postgres -c \"select pid,usename,application_name,client_addr,state,sync_state from pg_stat_replication\"                                                                \n  pid  |     usename      |  application_name  | client_addr |   state   | sync_state \n-------+------------------+--------------------+-------------+-----------+------------\n 17770 | streaming_barman | barman_receive_wal | 192.168.1.3 | streaming | sync\n(1 row)\n\n[postgres@node_yama]$ psql postgres -c \"select slot_name,slot_type,active_pid from pg_replication_slots\"\n  slot_name  | slot_type | active_pid \n-------------+-----------+------------\n barman_slot | physical  |      17770\n(1 row)\n\n\u78ba\u8a8d\u304c\u3042\u3063\u3055\u308a\u3057\u3059\u304e\uff1f\n\n5.\u30ea\u30b9\u30c8\u30a2\n\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u3057\u305f\u3082\u306e\u306f\u30ea\u30b9\u30c8\u30a2\u3067\u304d\u306a\u304f\u3066\u306f\u610f\u5473\u304c\u306a\u3044\u3002\n\u3068\u3044\u3046\u308f\u3051\u3067\u4e0a\u8a18\u3067\u53d6\u5f97\u3057\u305f\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u3092\u30ea\u30b9\u30c8\u30a2\u3057\u3066\u307f\u307e\u3059\u3002\npg_receivexlog\u306e\u52b9\u679c\u3092\u898b\u308b\u305f\u3081\u306b\u3082\u3001\u4ee5\u4e0b\u306e\u624b\u9806\u3067\u3084\u308a\u307e\u3059\u3002\n\n\u30c7\u30fc\u30bf\u30921\u4ef6INSERT\nDB\u505c\u6b62\u3001$PGDATA\u524a\u9664\n\u30ea\u30b9\u30c8\u30a2\nDB\u8d77\u52d5\u3001\u624b\u98061\u306e\u30c7\u30fc\u30bf\u304c\u5fa9\u65e7\u3067\u304d\u305f\u304b\u78ba\u8a8d\n\n\n\u30c7\u30fc\u30bf\u30921\u4ef6INSERT\n[postgres@node_yama]$ psql postgres -c \"CREATE TABLE bar(v varchar)\"\n[postgres@node_yama]$ psql postgres -c \"INSERT INTO bar VALUES ('gakki')\"\n\n\nDB\u505c\u6b62\u3001$PGDATA\u524a\u9664\n[barman@node_yama]$ pg_ctl stop\n[barman@node_yama]$ rm -rf $PGDATA\n\n\n\u30ea\u30b9\u30c8\u30a2\n[barman@node_umi]$ mkdir ~/data\n[barman@node_umi]$ barman recover node_yama latest ~/data                                        \nStarting local restore for server node_yama using backup 20161207T153302\nDestination directory: /var/lib/barman/data\nCopying the base backup.\nCopying required WAL segments.\nGenerating archive status files\nIdentify dangerous settings in destination directory.\n\nYour PostgreSQL server has been successfully prepared for recovery!\n[barman@node_umi]$ barman get-wal node_yama --output-directory ./data/pg_xlog 0000000100000000000\n00008\n[barman@node_umi]$ cp node_yama/streaming/000000010000000000000009.partial data/pg_xlog/000000010000000000000009\n[barman@node_umi]$ scp -r data postgres@node_yama:/var/lib/pgsql/9.6\n\n\u3061\u3087\u3063\u3068\u8abf\u3079\u304d\u308c\u3066\u3044\u306a\u3044\u306e\u3067\u3059\u304c\u3001\u4e0a\u8a18\u306e\u624b\u9806\u3060\u3068streaming\u3057\u3066\u3044\u305fWAL\u306f\u5225\u9014\u624b\u4f5c\u696d\u3067barman\u304b\u3089\u53d6\u308a\u51fa\u3057\u3066\u3044\u307e\u3059\u3002\n\u672c\u5f53\u3060\u3068barman\u304c\u3053\u3053\u3089\u3078\u3093\u3082\u3088\u308d\u3057\u304f\u3084\u3063\u3066\u304f\u308c\u305d\u3046\u306a\u6c17\u304c\u3059\u308b\u3051\u3069\u30fb\u30fb\u30fb\uff08\u8981\u78ba\u8a8d\uff09\n\nDB\u8d77\u52d5\u3001\u624b\u98061\u306e\u30c7\u30fc\u30bf\u304c\u5fa9\u65e7\u3067\u304d\u305f\u304b\u78ba\u8a8d\n[postgres@node_yama]$ pg_ctl -D /var/lib/pgsql/9.6/data start                                    \nserver starting\n[postgres@node_yama]$ 2016-12-07 16:07:37.906 JST [21729] LOG:  redirecting log output to logging collector process\n2016-12-07 16:07:37.906 JST [21729] HINT:  Future log output will appear in directory \"pg_log\".\n\n[postgres@node_yama]$ psql postgres -c \"SELECT * FROM bar\"\n   v   \n-------\n gakki\n(1 row)\n\n\u7121\u4e8b\u306b\u30ea\u30b9\u30c8\u30a2\u3067\u304d\u3066\u3044\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3067\u304d\u307e\u3057\u305f\u3002\n\n\u3055\u3044\u3054\u306b\nbarman2.0\u306b\u3064\u3044\u3066\u3067\u3059\u304c\u3001\u7740\u76ee\u3059\u3079\u304d\u306f\u4ee5\u4e0b\u306e\u70b9\u3068\u8003\u3048\u307e\u3059\u3002\n\nbarman\u7ba1\u7406\u4e0b\u3067\u306e\u30ea\u30a2\u30eb\u30bf\u30a4\u30e0WAL\u30a2\u30fc\u30ab\u30a4\u30d6\u304c\u53ef\u80fd\u306b\u306a\u3063\u305f\n\n\n\u30ea\u30a2\u30eb\u30bf\u30a4\u30e0\u3067WAL\u304c\u540c\u671f\u3055\u308c\u3066\u3044\u308b\u306e\u3067PITR\u3059\u308b\u969b\u3001\u3069\u306e\u6642\u70b9\u306b\u3067\u3082\u5fa9\u65e7\u304c\u53ef\u80fd\n\n\n\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30b9\u30ed\u30c3\u30c8\u3068\u306e\u9023\u643a\u306b\u3088\u308a\u3001WAL\u306e\u30ed\u30fc\u30c6\u30fc\u30c8\u3092\u6c17\u306b\u3057\u306a\u3044\u304f\u3066\u3088\u304f\u306a\u3063\u305f\n\n\u6700\u8fd1\u3001\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u306b\u3064\u3044\u3066\u8003\u3048\u308b\u3053\u3068\u304c\u591a\u3044\u306e\u3067\u3001\u7d99\u7d9a\u3057\u3066barman\u306b\u3064\u3044\u3066\u898b\u3066\u3044\u3053\u3046\u3068\u601d\u3044\u307e\u3059\u3002\n\u306a\u3093\u304b\u3061\u3083\u3093\u3068\u9b45\u529b\u3092\u4f1d\u3048\u304d\u308c\u3066\u3044\u306a\u3044\u6c17\u304c\u3059\u308b\u3002\u3002\u3002\n\u6642\u9593\u304c\u7a7a\u3044\u305f\u30bf\u30a4\u30df\u30f3\u30b0\u3067\u9069\u5b9c\u4fee\u6b63\u3057\u3066\u3044\u304d\u307e\u3059\u3002\n\u3053\u306e\u8a18\u4e8b\u306f[PostgreSQL Advent Calendar 2016](http://qiita.com/advent-calendar/2016/postgresql)\u306e7\u65e5\u76ee\u306e\u8a18\u4e8b\u3067\u3059\u3002\n\n# \u306f\u3058\u3081\u306b\n\u76f4\u524d\u307e\u3067\u4f55\u66f8\u304f\u304b\u5168\u7136\u6c7a\u3081\u3066\u3044\u306a\u304b\u3063\u305f\u306e\u3067\u3059\u304c\u3001PGConf.Asia 2016(12/1\uff5e12/3)\u306b\u53c2\u52a0\u3057\u3001[Magnus\u3055\u3093\u306e\u8b1b\u6f14](http://www.pgconf.asia/JP/day-2/#A2)\u3067barman\u306b\u8208\u5473\u3092\u6301\u3063\u305f\u306e\u3067\u3001\u4eca\u56de\u8abf\u3079\u3066\u307f\u308b\u3053\u3068\u306b\u3057\u307e\u3057\u305f\u3002\n\u3061\u306a\u307f\u306bbarman\u3068\u306f2ndQuadrant\u304cGithub\u3067[\u516c\u958b](https://github.com/2ndquadrant-it/barman)\u3057\u3066\u3044\u308bPostgreSQL\u5c02\u7528\u306e\u30d0\u30c3\u30af\u30a2\u30c3\u30d7/\u30ea\u30ab\u30d0\u30ea\u7ba1\u7406\u30c4\u30fc\u30eb\u3067\u3059\u3002\n\nbarman\u306e\u57fa\u672c\u7684\u306a\u6a5f\u80fd\u7d39\u4ecb\u7b49\u306b\u3064\u3044\u3066\u306f\u3001PGECons\u306e[\u5831\u544a\u66f8](https://www.pgecons.org/wp-content/uploads/PGECons/2015/WG3/PGECons_2015_WG3_DBTools.pdf)\u304c\u53c2\u8003\u306b\u306a\u308b\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u3002\u8208\u5473\u306e\u3042\u308b\u304b\u305f\u306f\u3054\u4e00\u8aad\u304f\u3060\u3055\u3044\u3002\n\n# 1.barman 2.0\u306e\u65b0\u6a5f\u80fd\n\u6700\u65b0\u7248\u306e2.0\u304c2016\u5e749\u6708\u306b\u30ea\u30ea\u30fc\u30b9\u3055\u308c\u307e\u3057\u305f\u3002\n\u3069\u3046\u3044\u3063\u305f\u6a5f\u80fd\u304c\u5b9f\u88c5\u3055\u308c\u305f\u306e\u304b\u8a73\u7d30\u306f[\u30ea\u30ea\u30fc\u30b9\u30ce\u30fc\u30c8](https://github.com/2ndquadrant-it/barman/blob/master/NEWS)\u3092\u3054\u78ba\u8a8d\u304f\u3060\u3055\u3044\u3002\n\u591a\u304f\u306e\u66f4\u65b0\u304c\u5165\u3063\u3066\u3044\u307e\u3059\u304c\u3001\u4e3b\u306a\u65b0\u6a5f\u80fd\u3068\u3057\u3066\u306f\u4ee5\u4e0b\u306e4\u3064\u3050\u3089\u3044\u3067\u3057\u3087\u3046\u304b\u3002\n\u672c\u5f53\u306f\u5168\u90e8\u3084\u308b\u3064\u3082\u308a\u3060\u3063\u305f\u306e\u3067\u3059\u304c\u3001\u4eca\u56de\u306f\u6642\u9593\u304c\u306a\u304b\u3063\u305f\u306e\u3067\u500b\u4eba\u7684\u306b\u97ff\u3044\u305f\u9805\u756a3\u306b\u3064\u3044\u3066\u306e\u307f\u78ba\u8a8d\u3057\u3066\u307f\u307e\u3057\u305f\u3002\n\n|\u9805\u756a|\u6982\u8981|\u5099\u8003|\n|:--:|:--|:--|\n| 1  |\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30b9\u30ed\u30c3\u30c8\u306b\u5bfe\u5fdc|receive-wal\u30b3\u30de\u30f3\u30c9\u3067--create-slot\u3068--drop-slot\u30b3\u30de\u30f3\u30c9\u304c\u30b5\u30dd\u30fc\u30c8|\n| 2  |PG96\u304b\u3089\u5c0e\u5165\u3055\u308c\u305f\u65b0\u3057\u3044\u30d0\u30c3\u30af\u30a2\u30c3\u30d7API\u3092\u30b5\u30dd\u30fc\u30c8|9.2\uff5e9.5\u307e\u3067\u306f\u30b9\u30bf\u30f3\u30d0\u30a4\u304b\u3089\u306e\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u53d6\u5f97\u306bpgespresso\u304c\u5fc5\u8981\u3060\u3063\u305f\u304c\u4eca\u5f8c\u306f\u4e0d\u8981\u3002|\n| 3  |\u540c\u671f\u30b9\u30bf\u30f3\u30d0\u30a4\u3068\u3057\u3066\u306eWAL\u30b9\u30c8\u30ea\u30fc\u30df\u30f3\u30b0\u6a5f\u80fd\u3092\u30b5\u30dd\u30fc\u30c8|\u3053\u306e\u6a5f\u80fd\u306b\u3088\u308aRPO=0\uff08\u3069\u306e\u6642\u70b9\u306b\u3067\u3082\u5fa9\u65e7\u53ef\u80fd\uff09\u3068\u306a\u308b\u3002|\n| 4  |barman-wal-restore\u30aa\u30d7\u30b7\u30e7\u30f3\u3067WAL\u30d5\u30a1\u30a4\u30eb\u306e\u30ea\u30e2\u30fc\u30c8\u30d1\u30e9\u30ec\u30eb\u30d5\u30a7\u30c3\u30c1\u3092\u30b5\u30dd\u30fc\u30c8|\u305f\u3076\u3093\u3001\u30ea\u30b9\u30c8\u30a2\u304c\u65e9\u304f\u306a\u308b\u3068\u3044\u3046\u8a71\u3068\u601d\u308f\u308c\u308b\u3002\uff08\u8981\u78ba\u8a8d\uff09|\n\n\u300c\u898b\u305b\u3066\u3082\u3089\u304a\u3046\u304b\u3001barman\u306e\u65b0\u6a5f\u80fd\u306e\u5b9f\u529b\u3068\u3084\u3089\u3092\uff01\u300d\n\n# 2.\u74b0\u5883\u69cb\u7bc9\n\n\u672c\u4f5c\u696d\u306f\u4ee5\u4e0b\u306e\u6761\u4ef6\u3067\u5b9f\u65bd\u3057\u307e\u3059\u3002\n\n- \u69cb\u6210\n    - \u30de\u30b9\u30bf(node_yama)\uff0b\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u30b5\u30fc\u30d0(node_umi)\u306e2\u53f0\u69cb\u6210\n- \u88fd\u54c1\n    - barman 2.0\n    - PostgreSQL 9.6.1 \uff08RPM\u3067\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3055\u308c\u305f\u72b6\u614b\u3092\u524d\u63d0\u3068\u3059\u308b\u3002\uff09\n        - \u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u30b5\u30fc\u30d0\u306b\u3082PostgreSQL\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u5fc5\u8981\u3042\u308a\u3002pg_basebackup\u3084[pg_receivexlog](http://www.postgresql.jp/document/9.6/html/app-pgreceivexlog.html)\u3092\u4f7f\u7528\u3059\u308b\u305f\u3081\u3002\n    - CentOS 7.2\n\n\n![streaming_barman](https://d17oy1vhnax1f7.cloudfront.net/items/370H0l0p1p1D1Q3z2j1i/streaming_barman.PNG \"streamning_barman\")\n\nPostgreSQL\u306e\u30d1\u30e9\u30e1\u30fc\u30bf\u306f\u4ee5\u4e0b\u306e\u70b9\u3092\u5909\u66f4\u3057\u307e\u3059\u3002\n\n```$PGDATA/postgresql.conf\nwal_level = 'replica'\nmax_wal_senders = 3\nmax_replication_slots = 3\nsynchronous_standby_names = 'barman_receive_wal'\n```\n\n## 2-1. DB\u30b5\u30fc\u30d0\u3067\u306e\u4f5c\u696d\uff08node_yama\u3067\u5b9f\u65bd\uff09\n\n### barman\u304c\u7ba1\u7406\u3067\u4f7f\u7528\u3059\u308b\u305f\u3081\u306eROLE\u3092\u4f5c\u6210\u3059\u308b\u3002\n\nbarman\u304b\u3089PostgreSQL\u306b\u63a5\u7d9a\u3059\u308b\u969b\u306eROLE\u3092\u4f5c\u6210\u3059\u308b\u3002\n\n```\n[postgres@node_yama]$ createuser -s barman\n```\n\n\u7d9a\u3044\u3066\u3001Streaming Replication\u3092\u7528\u3044\u305f\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u3092\u884c\u3046\u305f\u3081\u306eROLE\u3092\u4f5c\u6210\u3059\u308b\u3002\n\n```\n[postgres@node_yama]$ createuser --replication streaming_barman\n```\n\n## 2-2. \u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u30b5\u30fc\u30d0\u3067\u306e\u4f5c\u696d\uff08node_umi\u3067\u5b9f\u65bd\uff09\n\n### barman\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\nDB\u30b5\u30fc\u30d0\u3068\u306f\u5225\u306e\u30de\u30b7\u30f3\u306b\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u307e\u3059\u3002\npython\u7cfb\u306eRPM\u3068\u4f9d\u5b58\u95a2\u4fc2\u304c\u3042\u308b\u306e\u3067\u3001yum\u3067\u5165\u308c\u3066\u3057\u307e\u3046\u306e\u304c\u624b\u3063\u53d6\u308a\u65e9\u3044\u3067\u3059\u3002\n\n```\n[root@node_umi]# wget https://download.postgresql.org/pub/repos/yum/9.6/redhat/rhel-7-x86_64/pgdg-centos96-9.6-3.noarch.rpm\n[root@node_umi]# rpm -ivh pgdg-centos96-9.6-3.noarch.rpm\n[root@node_umi]# yum install barman\n[root@node_umi]# su - barman\n[barman@node_umi]$ barman --version\n2.0 Barman by 2ndQuadrant (www.2ndQuadrant.com)\n```\n\n### barman\u3092\u8a2d\u5b9a\u3059\u308b\n\n\u6c17\u306b\u3057\u306a\u3044\u3068\u3044\u3051\u306a\u3044\u306e\u306f\u3056\u3063\u304f\u308a\u3068\u4ee5\u4e0b\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3067\u3059\u3002\n\nbarman\u5168\u4f53\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\uff1a/etc/barman.conf \nbarman\u3067\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u3055\u308c\u308b\u5404\u30b5\u30fc\u30d0\u306e\u8a2d\u5b9a\uff1a/etc/barman.d/\uff1c\u30ce\u30fc\u30c9\u540d\uff1e.conf\n\n\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u30d5\u30a1\u30a4\u30eb\u304c\u3042\u308b\u306e\u3067\u3001\u305d\u308c\u3092\u53c2\u8003\u306b\u3057\u306a\u304c\u3089\u66f8\u3044\u3066\u307f\u307e\u3059\u3002\n\n```\n# cd /etc/barman.d/\n# cp streaming-server.conf-template node_yama.conf  \n```\n\n```/etc/barman.d/node_yama.conf\n[node_yama]\ndescription =  \"Example for Advent Calendar\"\nconninfo = host=node_yama user=barman dbname=postgres\nstreaming_conninfo = host=node_yama user=streaming_barman\n\n; ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;\n; Backup settings (via pg_basebackup)\n; ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;\nbackup_method = postgres\n;streaming_backup_name = barman_streaming_backup\n\n; ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;\n; WAL streaming settings (via pg_receivexlog)\n; ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;\nstreaming_archiver = on\nslot_name = barman_slot\n;streaming_archiver_name = barman_receive_wal\n;streaming_archiver_batch_size = 50\n```\n\n### \u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30b9\u30ed\u30c3\u30c8\u3092\u4f5c\u6210\u3059\u308b\n\nbarman\u304b\u3089\u5bfe\u8c61\u306eDB\u30b5\u30fc\u30d0\u3067\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30b9\u30ed\u30c3\u30c8\u3092\u4f5c\u6210\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\n```\n$ barman receive-wal --create-slot node_yama\nCreating physical replication slot 'barman_slot' on server 'node_yama'\nReplication slot 'barman_slot' created\n```\n\n### barman\u306e\u8a2d\u5b9a\u78ba\u8a8d\n\n\u4ee5\u4e0b\u306e\u30b3\u30de\u30f3\u30c9\u3067\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u53d6\u5f97\u5148\u3068\u306e\u72b6\u614b\u7b49\u3092\u78ba\u8a8d\u3067\u304d\u307e\u3059\u3002\n\n```\n$ barman check node_yama                                                        \nServer node_yama:\n        WAL archive: FAILED (please make sure WAL shipping is setup)\n        PostgreSQL: OK\n        superuser: OK\n        PostgreSQL streaming: OK\n        wal_level: OK\n        replication slot: FAILED (slot 'barman_slot' not initialised: is 'receive-wal' running?)\n        directories: OK\n        retention policy settings: OK\n        backup maximum age: OK (no last_backup_maximum_age provided)\n        compression settings: OK\n        failed backups: OK (there are 0 failed backups)\n        minimum redundancy requirements: OK (have 0 backups, expected at least 0)\n        pg_basebackup: OK\n        pg_basebackup compatible: OK\n        pg_basebackup supports tablespaces mapping: OK\n        pg_receivexlog: OK\n        pg_receivexlog compatible: OK\n        receive-wal running: FAILED (See the Barman log file for more details)\n        archiver errors: OK\n```\n\nWAL archive\u3001replication slot\u3001receive-wal running\u304c\u300cFAILED\u300d\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002\n\u5f8c\u308d2\u3064\u304c\u5931\u6557\u3057\u3066\u3044\u308b\u306e\u306f\u3001\u307e\u3060pg_receivexlog\u3092\u8d77\u52d5\u3057\u3066\u3044\u306a\u3044\u306e\u3067\u3001\u3054\u3082\u3063\u3068\u3082\u3002\n\nWAL archive\u306e\u9805\u76ee\u3067\u3059\u304c\u3001\u4e00\u65e6\u306f\u7121\u8996\u3057\u3066OK\u3067\u3059\u3002\n\u3053\u308c\u306fbarman\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3057\u305f\u969b\u306b\u4f5c\u6210\u3055\u308c\u308bxlog.db\u30d5\u30a1\u30a4\u30eb\uff08/var/lib/barman/node_yama/wals/xlog.db\uff09\u306e\u30d5\u30a1\u30a4\u30eb\u30b5\u30a4\u30ba\u304c0\u3067\u306a\u3044\u3053\u3068\u3092\u78ba\u8a8d\u3057\u3066\u304a\u308a\u3001\u307e\u3060\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u3082\u4f55\u3082\u3057\u3066\u3044\u306a\u3044\u306e\u3067\u3001\u3053\u306e\u6bb5\u968e\u3067\u306fFAILD\u306b\u306a\u308a\u307e\u3059\u3002\n\n\u4ee5\u4e0a\u3067\u74b0\u5883\u69cb\u7bc9\u306f\u7d42\u308f\u308a\u3067\u3059\u3002\n\n\n# 3.barman\u306b\u3088\u308b\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u53d6\u5f97\n\n## barman\u7d4c\u7531\u3067\u306epg_receivexlog\u8d77\u52d5\n\n```\n[barman@node_umi]$ barman receive-wal node_yama\nStarting receive-wal for server node_yama\nnode_yama: pg_receivexlog: starting log streaming at 0/10000000 (timeline 1)\n```\n\n\u203b\u3061\u306a\u307f\u306b\u3053\u306e\u30d7\u30ed\u30bb\u30b9\u306f\u30d5\u30a9\u30a2\u30b0\u30e9\u30a6\u30f3\u30c9\u3067\u52d5\u304d\u307e\u3059\uff01\n\n## WAL\u306e\u624b\u52d5\u5207\u308a\u66ff\u3048\n\n\u81ea\u5206\u306e\u74b0\u5883\u3060\u3068\u3053\u306e\u624b\u9806\u3092\u5165\u308c\u306a\u3044\u3068\u3046\u307e\u304f\u884c\u304d\u307e\u305b\u3093\u3067\u3057\u305f\u3002\n\u7406\u7531\u306f\u3088\u304f\u308f\u304b\u3089\u305a\u3002\u3002\u3002xlog.db\u3068\u95a2\u9023\u304c\u3042\u308b\u3068\u306f\u601d\u3046\u306e\u3067\u3059\u304c\u3002\u3002\u3002\n\n```\n[barman@node_umi]$ barman switch-xlog node_yama\nSwitch to 000000010000000000000011 for server 'node_yama'\n```\n\npg_receivexlog\u3067\u53d7\u4fe1\u304c\u3067\u304d\u3066\u3044\u308c\u3070\u3001\u300cnode_yama: pg_receivexlog: finished segment at 0/11000000 (timeline 1)\u300d\u304c\u65b0\u3057\u304f\u30b3\u30f3\u30bd\u30fc\u30eb\u306b\u51fa\u529b\u3055\u308c\u308b\u306f\u305a\u3067\u3059\u3002\n\n\n## \u30d9\u30fc\u30b9\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u53d6\u5f97\n\n```\n[barman@node_umi]$ barman backup node_yama\nStarting backup using postgres method for server node_yama in /var/lib/barman/node_yama/base/20161207T132607\nBackup start at xlog location: 0/11000060 (000000010000000000000011, 00000060)\nCopying files.\nCopy done.\nFinalising the backup.\nThis is the first backup for server node_yama\nWAL segments preceding the current backup have been found:\n        000000010000000000000010 from server node_yama has been removed\nBackup size: 171.6 MiB\nBackup end at xlog location: 0/13000000 (000000010000000000000012, 00000000)\nBackup completed\nProcessing xlog segments from streaming for node_yama\n        000000010000000000000011\n```\n\n\u3053\u308c\u3067\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u306e\u53d6\u5f97\u306f\u5b8c\u4e86\u3067\u3059\u3002\n\u3061\u306a\u307f\u306b\u3053\u306e\u72b6\u614b\u3067check\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3059\u308b\u3068\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\n\n```\n[barman@node_umi]$ barman check node_yama                                                        \nServer node_yama:\n        PostgreSQL: OK\n        superuser: OK\n        PostgreSQL streaming: OK\n        wal_level: OK\n        replication slot: OK\n        directories: OK\n        retention policy settings: OK\n        backup maximum age: OK (no last_backup_maximum_age provided)\n        compression settings: OK\n        failed backups: OK (there are 0 failed backups)\n        minimum redundancy requirements: OK (have 1 backups, expected at least 0)\n        pg_basebackup: OK\n        pg_basebackup compatible: OK\n        pg_basebackup supports tablespaces mapping: OK\n        pg_receivexlog: OK\n        pg_receivexlog compatible: OK\n        receive-wal running: OK\n        archiver errors: OK\n```\n\n\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u306e\u53d6\u5f97\u72b6\u6cc1\u306b\u3064\u3044\u3066\u306f\u4ee5\u4e0b\u306e\u30b3\u30de\u30f3\u30c9\u3067\u78ba\u8a8d\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\u4f55\u5ea6\u304b\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u3092\u53d6\u5f97\u3057\u305f\u308a\u3057\u3066\u3044\u308b\u3068\u3053\u3093\u306a\u611f\u3058\u3067\u5897\u3048\u3066\u3044\u304d\u307e\u3059\u3002\n\n```\n[barman@node_umi]$ barman list-backup node_yama\nnode_yama 20161207T144606 - Wed Dec  7 14:46:06 2016 - Size: 187.6 MiB - WAL Size: 0 B\nnode_yama 20161207T144354 - Wed Dec  7 14:43:54 2016 - Size: 187.6 MiB - WAL Size: 64.0 MiB\nnode_yama 20161207T140602 - Wed Dec  7 14:06:02 2016 - Size: 187.6 MiB - WAL Size: 48.0 MiB\nnode_yama 20161207T132607 - Wed Dec  7 13:26:07 2016 - Size: 187.6 MiB - WAL Size: 128.0 MiB\n```\n\n# 4.\u65b0\u6a5f\u80fd3\u306e\u78ba\u8a8d\n\n\u300c\u65b0\u6a5f\u80fd3\uff1a\u540c\u671f\u30b9\u30bf\u30f3\u30d0\u30a4\u3068\u3057\u3066\u306eWAL\u30b9\u30c8\u30ea\u30fc\u30df\u30f3\u30b0\u6a5f\u80fd\u3092\u30b5\u30dd\u30fc\u30c8\u300d\u304cPostgreSQL\u4e0a\u304b\u3089\u3069\u306e\u3088\u3046\u306b\u898b\u3048\u308b\u304b\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u3001\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30b9\u30ed\u30c3\u30c8\u3092\u5229\u7528\u3057\u305fbarman\u3078\u306eWAL\u30b9\u30c8\u30ea\u30fc\u30df\u30f3\u30b0\u304c\u540c\u671f\u30e2\u30fc\u30c9\u3067\u52d5\u3044\u3066\u3044\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3067\u304d\u307e\u3057\u305f\u3002\n\n```\n[postgres@node_yama]$ psql postgres -c \"select pid,usename,application_name,client_addr,state,sync_state from pg_stat_replication\"                                                                \n  pid  |     usename      |  application_name  | client_addr |   state   | sync_state \n-------+------------------+--------------------+-------------+-----------+------------\n 17770 | streaming_barman | barman_receive_wal | 192.168.1.3 | streaming | sync\n(1 row)\n\n[postgres@node_yama]$ psql postgres -c \"select slot_name,slot_type,active_pid from pg_replication_slots\"\n  slot_name  | slot_type | active_pid \n-------------+-----------+------------\n barman_slot | physical  |      17770\n(1 row)\n```\n\n\u78ba\u8a8d\u304c\u3042\u3063\u3055\u308a\u3057\u3059\u304e\uff1f\n\n# 5.\u30ea\u30b9\u30c8\u30a2\n\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u3057\u305f\u3082\u306e\u306f\u30ea\u30b9\u30c8\u30a2\u3067\u304d\u306a\u304f\u3066\u306f\u610f\u5473\u304c\u306a\u3044\u3002\n\u3068\u3044\u3046\u308f\u3051\u3067\u4e0a\u8a18\u3067\u53d6\u5f97\u3057\u305f\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u3092\u30ea\u30b9\u30c8\u30a2\u3057\u3066\u307f\u307e\u3059\u3002\n\npg_receivexlog\u306e\u52b9\u679c\u3092\u898b\u308b\u305f\u3081\u306b\u3082\u3001\u4ee5\u4e0b\u306e\u624b\u9806\u3067\u3084\u308a\u307e\u3059\u3002\n\n1. \u30c7\u30fc\u30bf\u30921\u4ef6INSERT\n2. DB\u505c\u6b62\u3001$PGDATA\u524a\u9664\n3. \u30ea\u30b9\u30c8\u30a2\n4. DB\u8d77\u52d5\u3001\u624b\u98061\u306e\u30c7\u30fc\u30bf\u304c\u5fa9\u65e7\u3067\u304d\u305f\u304b\u78ba\u8a8d\n\n## \u30c7\u30fc\u30bf\u30921\u4ef6INSERT\n\n```\n[postgres@node_yama]$ psql postgres -c \"CREATE TABLE bar(v varchar)\"\n[postgres@node_yama]$ psql postgres -c \"INSERT INTO bar VALUES ('gakki')\"\n```\n\n## DB\u505c\u6b62\u3001$PGDATA\u524a\u9664\n\n```\n[barman@node_yama]$ pg_ctl stop\n[barman@node_yama]$ rm -rf $PGDATA\n```\n\n## \u30ea\u30b9\u30c8\u30a2\n\n```\n[barman@node_umi]$ mkdir ~/data\n[barman@node_umi]$ barman recover node_yama latest ~/data                                        \nStarting local restore for server node_yama using backup 20161207T153302\nDestination directory: /var/lib/barman/data\nCopying the base backup.\nCopying required WAL segments.\nGenerating archive status files\nIdentify dangerous settings in destination directory.\n\nYour PostgreSQL server has been successfully prepared for recovery!\n[barman@node_umi]$ barman get-wal node_yama --output-directory ./data/pg_xlog 0000000100000000000\n00008\n[barman@node_umi]$ cp node_yama/streaming/000000010000000000000009.partial data/pg_xlog/000000010000000000000009\n[barman@node_umi]$ scp -r data postgres@node_yama:/var/lib/pgsql/9.6\n```\n\n\u3061\u3087\u3063\u3068\u8abf\u3079\u304d\u308c\u3066\u3044\u306a\u3044\u306e\u3067\u3059\u304c\u3001\u4e0a\u8a18\u306e\u624b\u9806\u3060\u3068streaming\u3057\u3066\u3044\u305fWAL\u306f\u5225\u9014\u624b\u4f5c\u696d\u3067barman\u304b\u3089\u53d6\u308a\u51fa\u3057\u3066\u3044\u307e\u3059\u3002\n\u672c\u5f53\u3060\u3068barman\u304c\u3053\u3053\u3089\u3078\u3093\u3082\u3088\u308d\u3057\u304f\u3084\u3063\u3066\u304f\u308c\u305d\u3046\u306a\u6c17\u304c\u3059\u308b\u3051\u3069\u30fb\u30fb\u30fb\uff08\u8981\u78ba\u8a8d\uff09\n\n## DB\u8d77\u52d5\u3001\u624b\u98061\u306e\u30c7\u30fc\u30bf\u304c\u5fa9\u65e7\u3067\u304d\u305f\u304b\u78ba\u8a8d\n\n```\n[postgres@node_yama]$ pg_ctl -D /var/lib/pgsql/9.6/data start                                    \nserver starting\n[postgres@node_yama]$ 2016-12-07 16:07:37.906 JST [21729] LOG:  redirecting log output to logging collector process\n2016-12-07 16:07:37.906 JST [21729] HINT:  Future log output will appear in directory \"pg_log\".\n\n[postgres@node_yama]$ psql postgres -c \"SELECT * FROM bar\"\n   v   \n-------\n gakki\n(1 row)\n```\n\n\u7121\u4e8b\u306b\u30ea\u30b9\u30c8\u30a2\u3067\u304d\u3066\u3044\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3067\u304d\u307e\u3057\u305f\u3002\n\n\n# \u3055\u3044\u3054\u306b\nbarman2.0\u306b\u3064\u3044\u3066\u3067\u3059\u304c\u3001\u7740\u76ee\u3059\u3079\u304d\u306f\u4ee5\u4e0b\u306e\u70b9\u3068\u8003\u3048\u307e\u3059\u3002\n\n- barman\u7ba1\u7406\u4e0b\u3067\u306e\u30ea\u30a2\u30eb\u30bf\u30a4\u30e0WAL\u30a2\u30fc\u30ab\u30a4\u30d6\u304c\u53ef\u80fd\u306b\u306a\u3063\u305f\n    - \u30ea\u30a2\u30eb\u30bf\u30a4\u30e0\u3067WAL\u304c\u540c\u671f\u3055\u308c\u3066\u3044\u308b\u306e\u3067PITR\u3059\u308b\u969b\u3001\u3069\u306e\u6642\u70b9\u306b\u3067\u3082\u5fa9\u65e7\u304c\u53ef\u80fd\n- \u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30b9\u30ed\u30c3\u30c8\u3068\u306e\u9023\u643a\u306b\u3088\u308a\u3001WAL\u306e\u30ed\u30fc\u30c6\u30fc\u30c8\u3092\u6c17\u306b\u3057\u306a\u3044\u304f\u3066\u3088\u304f\u306a\u3063\u305f\n\n\u6700\u8fd1\u3001\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u306b\u3064\u3044\u3066\u8003\u3048\u308b\u3053\u3068\u304c\u591a\u3044\u306e\u3067\u3001\u7d99\u7d9a\u3057\u3066barman\u306b\u3064\u3044\u3066\u898b\u3066\u3044\u3053\u3046\u3068\u601d\u3044\u307e\u3059\u3002\n\u306a\u3093\u304b\u3061\u3083\u3093\u3068\u9b45\u529b\u3092\u4f1d\u3048\u304d\u308c\u3066\u3044\u306a\u3044\u6c17\u304c\u3059\u308b\u3002\u3002\u3002\n\u6642\u9593\u304c\u7a7a\u3044\u305f\u30bf\u30a4\u30df\u30f3\u30b0\u3067\u9069\u5b9c\u4fee\u6b63\u3057\u3066\u3044\u304d\u307e\u3059\u3002\n"}