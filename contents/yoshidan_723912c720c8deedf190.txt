{"tags": ["spring", "Redis", "spring-boot"], "context": " More than 1 year has passed since last update.\u524d\u56de\u306fSpring Boot\u3068Spring Data Redis\u3092\u5229\u7528\u3057\u3066Redis\u3092\u5229\u7528\u3059\u308b\u65b9\u6cd5\u3092\u66f8\u3044\u305f\u3002\n\u4eca\u56de\u306fSpring Data Redis\u3092Redis Sentinel\u69cb\u6210\u3067\u5229\u7528\u3059\u308b\u65b9\u6cd5\u3002\n\n\n\u5229\u7528\u65b9\u6cd5\n\napplicaion.yml\u306bSentinel\u306e\u60c5\u5831\u3092\u8a18\u8f09\u3059\u308b\u3002\n\nspring:\n    data:\n        redis:\n            Sentinel: \n                  master: cluster1\n                  nodes: localhost:26379,localhost:26380,localhost:26381\n\n\nmaster\u30d7\u30ed\u30d1\u30c6\u30a3\u306fSentinel\u306b\u8a2d\u5b9a\u3057\u305f\u30af\u30e9\u30b9\u30bf\u306e\u540d\u79f0\u3002\n\u4ee5\u4e0b\u306fSentinel\u306e\u30ed\u30b0\u3001Sentinel\u3067\u8a8d\u8b58\u3057\u3066\u3044\u308b\u30af\u30e9\u30b9\u30bf\u306e\u540d\u79f0\u3068\u540c\u3058\u306b\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u3002\n\n[1] 13 Sep 07:41:51.043 # Sentinel runid is 2510f2561aff03a249726db05e195efc8ee80920\n[1] 13 Sep 07:41:51.046 # +monitor master cluster1 192.168.59.103 6379 quorum 2\n[1] 13 Sep 07:41:52.047 * +slave slave 172.17.42.1:6380 172.17.42.1 6380 @ cluster1 192.168.59.103 6379\n\n\nnodes\u30d7\u30ed\u30d1\u30c6\u30a3\u306fSentinel\u306e\u63a5\u7d9a\u5148\u3092\u30ab\u30f3\u30de\u533a\u5207\u308a\u3067\u6307\u5b9a\u3059\u308b\u3002\nSentinel\u69cb\u6210\u3067\u306f\u7121\u3044\u6642\u306b\u6307\u5b9a\u3057\u3066\u3044\u305fhost/port\u306e\u8a2d\u5b9a\u306f\u4e0d\u8981\u3002\n\n\u4e0a\u8a18\u306e\u8a2d\u5b9a\u3060\u3051\u3067Spring Data Redis\u304cSentinel\u306e\u30d7\u30ed\u30bb\u30b9\u304b\u3089\u30de\u30b9\u30bf\u30fc\u30ce\u30fc\u30c9\u306e\u60c5\u5831\u3092\u53d6\u5f97\u3059\u308b\u305f\u3081\u3001Sentinel\u69cb\u6210\u306e\u6642\u3067\u306a\u3044\u5834\u5408\u3068\u540c\u69d8\u306bRedisTemplate\u3092\u5229\u7528\u3057\u3066Redis\u3092\u64cd\u4f5c\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u308b\u3002\n\nMaster\u306e\u5224\u5b9a\u65b9\u6cd5\u3092\u8ffd\u3063\u3066\u307f\u308b\n\u6b21\u306bSpring Data Redis\u304b\u3089\u3069\u306e\u3088\u3046\u306b\u3057\u3066Master\u306e\u60c5\u5831\u3092\u53d6\u5f97\u3057\u3066\u3044\u308b\u306e\u304b\u78ba\u8a8d\u3059\u308b\u3002\n\u524d\u63d0\u3068\u3057\u3066\u3001Spring Data Redis\u304c\u30c7\u30d5\u30a9\u30eb\u30c8\u3067\u5229\u7528\u3059\u308bRedis\u306e\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u3067\u3042\u308bJedis\u3092\u5229\u7528\u3057\u305f\u72b6\u614b\u3067\u78ba\u8a8d\u3059\u308b\u3002\n\u6d41\u308c\u3092\u7c21\u5358\u306b\u56f3\u793a\u3059\u308b\u3068\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u308b\u3002\n\n\nSentinel\u3078\u306e\u30b3\u30cd\u30af\u30b7\u30e7\u30f3\u30d7\u30fc\u30eb\u751f\u6210\nSpring Boot\u8d77\u52d5\u6642\u306a\u3069\u3001\u307e\u305aJedisConnectionFactory\u304cBean\u3068\u3057\u3066\u521d\u671f\u5316\u3055\u308c\u308b\u30bf\u30a4\u30df\u30f3\u30b0\u3067\u3001application.yml\u306bSentinel\u306e\u8a2d\u5b9a\u304c\u306a\u3055\u308c\u3066\u3044\u308c\u3070\u3001Sentine\u7528\u306e\u30b3\u30cd\u30af\u30b7\u30e7\u30f3\u30d7\u30fc\u30ebJedisSentinelPool\u3092\u4f5c\u6210\u3057\u3066\u3044\u308b\u3002\u4ee5\u4e0b\u306fJedisConnectionFactory\u306e\u30bd\u30fc\u30b9\u4e00\u90e8\u629c\u7c8b\u3002\npublic void afterPropertiesSet() {\n\n    // \u7565\n\n    if (usePool) {\n        this.pool = createPool();\n    }\n}\n\nprivate Pool<Jedis> createPool() {\n\n    if (isRedisSentinelAware()) {\n        return createRedisSentinelPool(this.SentinelConfig);\n    }\n    return createRedisPool();\n}\n\n\nMaster\u306e\u5224\u5b9a\nJedisSentinelPool\u306e\u30b3\u30f3\u30b9\u30c8\u30e9\u30af\u30bf\u3067\u4ee5\u4e0b\u306e\u51e6\u7406\u304c\u884c\u308f\u308c\u308b\u3002\n\n\nSentinel\u306b\u5bfe\u3057\u3066\u9806\u756a\u306bMaster\u304c\u898b\u3064\u304b\u308b\u307e\u3067\u4ee5\u4e0b\u306e\u30b3\u30de\u30f3\u30c9\u3092\u767a\u884c\nSENTINEL get-master-addr-by-name cluster1\n\n\n\u4e00\u3064\u4ee5\u4e0a\u306eSentinel\u304b\u3089master\u306e\u60c5\u5831\u304c\u53d6\u5f97\u3067\u304d\u306a\u3051\u308c\u3070\u4f8b\u5916\n\u305d\u306e\u305f\u3081\u3001JedisConnectionFactory\u521d\u671f\u5316\u306e\u30bf\u30a4\u30df\u30f3\u30b0\u3067\u306f\u5fc5\u305a1\u53f0\u306eSentinel\u306b\u306f\u63a5\u7d9a\u3067\u304d\u306a\u3051\u308c\u3070\u306a\u3089\u306a\u3044\u3002\n\u898b\u3064\u304b\u3063\u305fMaster\u306b\u5bfe\u3057\u3066\u30b3\u30cd\u30af\u30b7\u30e7\u30f3\u30d7\u30fc\u30eb\u3092\u751f\u6210\n\n\nSentinel\u3078\u306eSubscribe\u958b\u59cb\n\u4e0a\u8a18\u3068\u540c\u6642\u306bSentinel\u306e\u30d7\u30ed\u30bb\u30b9\u6bce\u306bMasterListener\u3068\u3044\u3046\u30b9\u30ec\u30c3\u30c9\u3092\u8d77\u52d5\u3059\u308b\u3002\nMasterLister\u3067\u305d\u308c\u305e\u308c\u304c\u62c5\u5f53\u3059\u308bSentinel\u30d7\u30ed\u30bb\u30b9\u306b\u5bfe\u3057\u3066\u30de\u30b9\u30bf\u30fc\u5909\u66f4\u3092\u30b5\u30d6\u30b9\u30af\u30e9\u30a4\u30d6\u3059\u308b\u3002\nSUBSCRIBE +switch-master\n\n\nSentinel\u306b\u3088\u308aMaster\u304c\u5909\u66f4\u3055\u308c\u305f\u6642\nMasterListener\u304c\u65b0Master\u306e\u63a5\u7d9a\u5148\u60c5\u5831\u3092\u53d7\u3051\u53d6\u308b\u3002\u305d\u306e\u5f8cJedisSentinelPool\u304c\u65b0Master\u306b\u5bfe\u3059\u308b\u30b3\u30cd\u30af\u30b7\u30e7\u30f3\u30d7\u30fc\u30eb\u3092\u4f5c\u6210\u3059\u308b\u3002\n\n\u969c\u5bb3\u6642\u306e\u632f\u308b\u821e\u3044\n\nRedis\u306e\u30de\u30b9\u30bf\u30fc\u304c\u505c\u6b62\u3057\u3066\u304b\u3089Spring Data Redis\u5074\u3067\u30b3\u30cd\u30af\u30b7\u30e7\u30f3\u30d7\u30fc\u30eb\u3092\u518d\u751f\u6210\u3059\u308b\u307e\u3067\u306fRedisTemplate\u3067\u306eRedis\u3078\u306e\u30a2\u30af\u30bb\u30b9\u306f\u30a8\u30e9\u30fc\u3068\u306a\u308b\u3002\nSentinel\u304c\u5168\u505c\u6b62\u3057\u3066\u3044\u3066\u3082Master\u304c\u505c\u6b62\u3057\u3066\u3044\u306a\u3051\u308c\u3070RedisTemplate\u3067\u30a8\u30e9\u30fc\u306b\u306a\u308b\u3053\u3068\u306f\u306a\u3044\u3002\nSentinel\u304c\u505c\u6b62\u3057\u3066\u3082MasterListener\u306f\u30c7\u30d5\u30a9\u30eb\u30c8\u30675\u79d2\u6bce\u306b\u518d\u63a5\u7d9a\u8a66\u884c\u3057\u3066\u3044\u308b\u305f\u3081\u3001Sentinel\u3092\u518d\u8d77\u52d5\u3059\u308c\u3070\u63a5\u7d9a\u304c\u5fa9\u65e7\u3059\u308b\u3002\n\n\n\u305d\u306e\u4ed6\nMaster\u306b\u5bfe\u3057\u3066\u306f\u30a2\u30af\u30bb\u30b9\u3067\u304d\u308b\u304c\u3001Slave\u3060\u3051\u30a2\u30af\u30bb\u30b9\u3059\u308b\u4ed5\u7d44\u307f\u306f\u306a\u3044\u305f\u3081\u3001Read\u51e6\u7406\u3092Slave\u304b\u3089\u5b9f\u65bd\u3057\u305f\u3044\u5834\u5408\u306b\u306f\u81ea\u4f5c\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u3002\n\n[\u524d\u56de](http://qiita.com/yoshidan/items/f7c10a43d2a40c3ce8df)\u306fSpring Boot\u3068Spring Data Redis\u3092\u5229\u7528\u3057\u3066Redis\u3092\u5229\u7528\u3059\u308b\u65b9\u6cd5\u3092\u66f8\u3044\u305f\u3002\n\u4eca\u56de\u306fSpring Data Redis\u3092Redis Sentinel\u69cb\u6210\u3067\u5229\u7528\u3059\u308b\u65b9\u6cd5\u3002\n\n![\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2015-09-13 17.24.29.png](https://qiita-image-store.s3.amazonaws.com/0/39230/a5dc384f-00cc-e63b-1141-d8adf6a3b724.png \"\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2015-09-13 17.24.29.png\")\n\n\n## \u5229\u7528\u65b9\u6cd5\n\n* applicaion.yml\u306bSentinel\u306e\u60c5\u5831\u3092\u8a18\u8f09\u3059\u308b\u3002\n\n```\nspring:\n    data:\n        redis:\n            Sentinel: \n                  master: cluster1\n                  nodes: localhost:26379,localhost:26380,localhost:26381\n```          \n\n* master\u30d7\u30ed\u30d1\u30c6\u30a3\u306fSentinel\u306b\u8a2d\u5b9a\u3057\u305f\u30af\u30e9\u30b9\u30bf\u306e\u540d\u79f0\u3002\n\u4ee5\u4e0b\u306fSentinel\u306e\u30ed\u30b0\u3001Sentinel\u3067\u8a8d\u8b58\u3057\u3066\u3044\u308b\u30af\u30e9\u30b9\u30bf\u306e\u540d\u79f0\u3068\u540c\u3058\u306b\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u3002\n\n```\n[1] 13 Sep 07:41:51.043 # Sentinel runid is 2510f2561aff03a249726db05e195efc8ee80920\n[1] 13 Sep 07:41:51.046 # +monitor master cluster1 192.168.59.103 6379 quorum 2\n[1] 13 Sep 07:41:52.047 * +slave slave 172.17.42.1:6380 172.17.42.1 6380 @ cluster1 192.168.59.103 6379\n```\n\n* nodes\u30d7\u30ed\u30d1\u30c6\u30a3\u306fSentinel\u306e\u63a5\u7d9a\u5148\u3092\u30ab\u30f3\u30de\u533a\u5207\u308a\u3067\u6307\u5b9a\u3059\u308b\u3002\n* Sentinel\u69cb\u6210\u3067\u306f\u7121\u3044\u6642\u306b\u6307\u5b9a\u3057\u3066\u3044\u305fhost/port\u306e\u8a2d\u5b9a\u306f\u4e0d\u8981\u3002\n\n\u4e0a\u8a18\u306e\u8a2d\u5b9a\u3060\u3051\u3067Spring Data Redis\u304cSentinel\u306e\u30d7\u30ed\u30bb\u30b9\u304b\u3089\u30de\u30b9\u30bf\u30fc\u30ce\u30fc\u30c9\u306e\u60c5\u5831\u3092\u53d6\u5f97\u3059\u308b\u305f\u3081\u3001Sentinel\u69cb\u6210\u306e\u6642\u3067\u306a\u3044\u5834\u5408\u3068\u540c\u69d8\u306bRedisTemplate\u3092\u5229\u7528\u3057\u3066Redis\u3092\u64cd\u4f5c\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u308b\u3002\n\n\n## Master\u306e\u5224\u5b9a\u65b9\u6cd5\u3092\u8ffd\u3063\u3066\u307f\u308b\n\n\u6b21\u306bSpring Data Redis\u304b\u3089\u3069\u306e\u3088\u3046\u306b\u3057\u3066Master\u306e\u60c5\u5831\u3092\u53d6\u5f97\u3057\u3066\u3044\u308b\u306e\u304b\u78ba\u8a8d\u3059\u308b\u3002\n\u524d\u63d0\u3068\u3057\u3066\u3001Spring Data Redis\u304c\u30c7\u30d5\u30a9\u30eb\u30c8\u3067\u5229\u7528\u3059\u308bRedis\u306e\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u3067\u3042\u308bJedis\u3092\u5229\u7528\u3057\u305f\u72b6\u614b\u3067\u78ba\u8a8d\u3059\u308b\u3002\n\u6d41\u308c\u3092\u7c21\u5358\u306b\u56f3\u793a\u3059\u308b\u3068\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u308b\u3002\n\n![\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2015-09-13 20.33.01.png](https://qiita-image-store.s3.amazonaws.com/0/39230/f4fede83-8925-0924-15a0-293d8ff56f16.png \"\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2015-09-13 20.33.01.png\")\n\n\n### Sentinel\u3078\u306e\u30b3\u30cd\u30af\u30b7\u30e7\u30f3\u30d7\u30fc\u30eb\u751f\u6210\n\nSpring Boot\u8d77\u52d5\u6642\u306a\u3069\u3001\u307e\u305aJedisConnectionFactory\u304cBean\u3068\u3057\u3066\u521d\u671f\u5316\u3055\u308c\u308b\u30bf\u30a4\u30df\u30f3\u30b0\u3067\u3001application.yml\u306bSentinel\u306e\u8a2d\u5b9a\u304c\u306a\u3055\u308c\u3066\u3044\u308c\u3070\u3001Sentine\u7528\u306e\u30b3\u30cd\u30af\u30b7\u30e7\u30f3\u30d7\u30fc\u30ebJedisSentinelPool\u3092\u4f5c\u6210\u3057\u3066\u3044\u308b\u3002\u4ee5\u4e0b\u306fJedisConnectionFactory\u306e\u30bd\u30fc\u30b9\u4e00\u90e8\u629c\u7c8b\u3002\n\n```\npublic void afterPropertiesSet() {\n\t\t\n\t// \u7565\n\t\t\n\tif (usePool) {\n\t\tthis.pool = createPool();\n\t}\n}\n\nprivate Pool<Jedis> createPool() {\n\n\tif (isRedisSentinelAware()) {\n\t\treturn createRedisSentinelPool(this.SentinelConfig);\n\t}\n\treturn createRedisPool();\n}\n```\n\n### Master\u306e\u5224\u5b9a\n\nJedisSentinelPool\u306e\u30b3\u30f3\u30b9\u30c8\u30e9\u30af\u30bf\u3067\u4ee5\u4e0b\u306e\u51e6\u7406\u304c\u884c\u308f\u308c\u308b\u3002\n\n* Sentinel\u306b\u5bfe\u3057\u3066\u9806\u756a\u306bMaster\u304c\u898b\u3064\u304b\u308b\u307e\u3067\u4ee5\u4e0b\u306e\u30b3\u30de\u30f3\u30c9\u3092\u767a\u884c\n\n\t```\n\tSENTINEL get-master-addr-by-name cluster1\n\t```\n\t\n* \u4e00\u3064\u4ee5\u4e0a\u306eSentinel\u304b\u3089master\u306e\u60c5\u5831\u304c\u53d6\u5f97\u3067\u304d\u306a\u3051\u308c\u3070\u4f8b\u5916\n\u305d\u306e\u305f\u3081\u3001JedisConnectionFactory\u521d\u671f\u5316\u306e\u30bf\u30a4\u30df\u30f3\u30b0\u3067\u306f\u5fc5\u305a1\u53f0\u306eSentinel\u306b\u306f\u63a5\u7d9a\u3067\u304d\u306a\u3051\u308c\u3070\u306a\u3089\u306a\u3044\u3002\n\n* \u898b\u3064\u304b\u3063\u305fMaster\u306b\u5bfe\u3057\u3066\u30b3\u30cd\u30af\u30b7\u30e7\u30f3\u30d7\u30fc\u30eb\u3092\u751f\u6210\n\n### Sentinel\u3078\u306eSubscribe\u958b\u59cb\n\n\u4e0a\u8a18\u3068\u540c\u6642\u306bSentinel\u306e\u30d7\u30ed\u30bb\u30b9\u6bce\u306bMasterListener\u3068\u3044\u3046\u30b9\u30ec\u30c3\u30c9\u3092\u8d77\u52d5\u3059\u308b\u3002\nMasterLister\u3067\u305d\u308c\u305e\u308c\u304c\u62c5\u5f53\u3059\u308bSentinel\u30d7\u30ed\u30bb\u30b9\u306b\u5bfe\u3057\u3066\u30de\u30b9\u30bf\u30fc\u5909\u66f4\u3092\u30b5\u30d6\u30b9\u30af\u30e9\u30a4\u30d6\u3059\u308b\u3002\n\n```\nSUBSCRIBE +switch-master\n```\t\n\n### Sentinel\u306b\u3088\u308aMaster\u304c\u5909\u66f4\u3055\u308c\u305f\u6642\n\nMasterListener\u304c\u65b0Master\u306e\u63a5\u7d9a\u5148\u60c5\u5831\u3092\u53d7\u3051\u53d6\u308b\u3002\u305d\u306e\u5f8cJedisSentinelPool\u304c\u65b0Master\u306b\u5bfe\u3059\u308b\u30b3\u30cd\u30af\u30b7\u30e7\u30f3\u30d7\u30fc\u30eb\u3092\u4f5c\u6210\u3059\u308b\u3002\n\n## \u969c\u5bb3\u6642\u306e\u632f\u308b\u821e\u3044\n\n* Redis\u306e\u30de\u30b9\u30bf\u30fc\u304c\u505c\u6b62\u3057\u3066\u304b\u3089Spring Data Redis\u5074\u3067\u30b3\u30cd\u30af\u30b7\u30e7\u30f3\u30d7\u30fc\u30eb\u3092\u518d\u751f\u6210\u3059\u308b\u307e\u3067\u306fRedisTemplate\u3067\u306eRedis\u3078\u306e\u30a2\u30af\u30bb\u30b9\u306f\u30a8\u30e9\u30fc\u3068\u306a\u308b\u3002\n\n* Sentinel\u304c\u5168\u505c\u6b62\u3057\u3066\u3044\u3066\u3082Master\u304c\u505c\u6b62\u3057\u3066\u3044\u306a\u3051\u308c\u3070RedisTemplate\u3067\u30a8\u30e9\u30fc\u306b\u306a\u308b\u3053\u3068\u306f\u306a\u3044\u3002\n\n* Sentinel\u304c\u505c\u6b62\u3057\u3066\u3082MasterListener\u306f\u30c7\u30d5\u30a9\u30eb\u30c8\u30675\u79d2\u6bce\u306b\u518d\u63a5\u7d9a\u8a66\u884c\u3057\u3066\u3044\u308b\u305f\u3081\u3001Sentinel\u3092\u518d\u8d77\u52d5\u3059\u308c\u3070\u63a5\u7d9a\u304c\u5fa9\u65e7\u3059\u308b\u3002\n \n## \u305d\u306e\u4ed6\n\nMaster\u306b\u5bfe\u3057\u3066\u306f\u30a2\u30af\u30bb\u30b9\u3067\u304d\u308b\u304c\u3001Slave\u3060\u3051\u30a2\u30af\u30bb\u30b9\u3059\u308b\u4ed5\u7d44\u307f\u306f\u306a\u3044\u305f\u3081\u3001Read\u51e6\u7406\u3092Slave\u304b\u3089\u5b9f\u65bd\u3057\u305f\u3044\u5834\u5408\u306b\u306f\u81ea\u4f5c\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u3002\n\n\n"}