{"context": "\n\u57fa\u672c\u8a2d\u8a08\u3001\u30e6\u30fc\u30b6\u30fc\u30e2\u30c7\u30eb\n\u30aa\u30fc\u30c8\u30ed\u30fc\u30c0\u30fc\n\u4f8b\u5916\u30fb\u30ed\u30b0\n\nPDO \u30b7\u30f3\u30b0\u30eb\u30c8\u30f3\u3000SQL\u30a4\u30f3\u30b8\u30a7\u30af\u30b7\u30e7\u30f3\n\n\u6c4e\u7528\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u30fb\u30af\u30e9\u30b9\u4f5c\u6210\n\n\n\u30e6\u30fc\u30b6\u30fc\u30e2\u30c7\u30eb\u306e\u4f5c\u6210\n\u30af\u30e9\u30b9\u306e\u7d99\u627f\n\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u30fb\u30af\u30e9\u30b9\u306e\u5b9f\u88c5\n\u30a2\u30ab\u30a6\u30f3\u30c8\u30ed\u30c3\u30af\u6a5f\u80fd\u306e\u5b9f\u88c5\n\u30e1\u30fc\u30eb\u9001\u4fe1\u6a5f\u80fd\u306e\u5b9f\u88c5\n\u30a2\u30ab\u30a6\u30f3\u30c8\u30ed\u30c3\u30af\u89e3\u9664\u6a5f\u80fd\u306e\u5b9f\u88c5\nCSRF\u5bfe\u7b56\n\n\u524d\u56de\u306e\u7d9a\u304d\u3067\u3059\u3002\n\n\u306f\u3058\u3081\u306b\n\u8981\u4ef6\u3092\u307e\u3068\u3081\u307e\u3059\u3002\n\n\u30a2\u30ab\u30a6\u30f3\u30c8\u304c\u30ed\u30c3\u30af\u3055\u308c\u305f\u3068\u304d\u3001\u30ed\u30c3\u30af\u3055\u308c\u305f\u30a2\u30ab\u30a6\u30f3\u30c8\u306e\u30e6\u30fc\u30b6\u30fc\u5b9b\u3066\u306b\u3001\u30e1\u30fc\u30eb\u3092\u9001\u4fe1\u3059\u308b\u3002\n\u30a2\u30ab\u30a6\u30f3\u30c8\u30ed\u30c3\u30af\u89e3\u9664\u30da\u30fc\u30b8\u306eURL\u306f\u30e1\u30fc\u30eb\u3067\u901a\u77e5\u3059\u308b\u3002\n\u30a2\u30ab\u30a6\u30f3\u30c8\u30ed\u30c3\u30af\u89e3\u9664\u30da\u30fc\u30b8\u306e\u300c\u89e3\u9664\u300d\u30dc\u30bf\u30f3\u3092\u62bc\u4e0b\u3059\u308b\u3068\u3001\u30a2\u30ab\u30a6\u30f3\u30c8\u30ed\u30c3\u30af\u3092\u89e3\u9664\u3059\u308b\u3002\n\n\u30a2\u30ab\u30a6\u30f3\u30c8\u30ed\u30c3\u30af\u306f\u3001\u5f53\u7136\u30ed\u30b0\u30a4\u30f3\u306b\u6210\u529f\u3057\u3066\u3044\u306a\u3044\u30e6\u30fc\u30b6\u30fc\u304c\u5229\u7528\u3059\u308b\u6a5f\u80fd\u3067\u3059\u306e\u3067\u3001\u30bb\u30c3\u30b7\u30e7\u30f3\u3092\u7528\u3044\u3066\u30e6\u30fc\u30b6\u30fc\u3092\u7279\u5b9a\u3059\u308b\u3053\u3068\u306f\u3067\u304d\u307e\u305b\u3093\u3002\n\u305d\u3053\u3067\u3001\u300c\u89e3\u9664\u30b3\u30fc\u30c9\u300d\u306e\u3088\u3046\u306a\u30ad\u30fc\u3092\u7528\u3044\u3066\u30e6\u30fc\u30b6\u30fc\u3092\u7279\u5b9a\u3059\u308b\u3053\u3068\u306b\u306a\u308a\u307e\u3059\u3002\n\u300c\u89e3\u9664\u30b3\u30fc\u30c9\u300d\u306f\u30a2\u30ab\u30a6\u30f3\u30c8\u304c\u30ed\u30c3\u30af\u3055\u308c\u305f\u30bf\u30a4\u30df\u30f3\u30b0\u3067\u767a\u884c\u3057\u3001DB\u306b\u4fdd\u5b58\u3057\u3066\u304a\u304f\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\nUserModel.class.php \u306b\u5b9a\u7fa9\u3055\u308c\u3066\u3044\u308b\u3001loginFailureIncrement() \u306b\u305d\u306e\u51e6\u7406\u3092\u8db3\u3057\u3066\u304a\u304d\u307e\u3057\u3087\u3046\u3002\ntbl_user\u30c6\u30fc\u30d6\u30eb\u306etoken\u306b\u305d\u306e\u5024\u3092\u66f8\u304d\u8fbc\u307f\u307e\u3059\u3002\n\nclasses/model/UserModel.class.php\n    /**\n     * \u30ed\u30b0\u30a4\u30f3\u5931\u6557\u3092\u30a4\u30f3\u30af\u30ea\u30e1\u30f3\u30c8\u3059\u308b\n     * \u6307\u5b9a\u56de\u6570\uff08self::LOCK_COUNT\uff09\u306b\u6e80\u305f\u306a\u3044\u3068\u304d\u306e\u307f\uff0b\uff11\n     * @return bool\n     */\n    public function loginFailureIncrement()\n    {\n        $count = $this->getLoginFailureCount();\n        if (self::LOCK_COUNT > $count) {\n            $now = (new \\DateTime())->format('Y-m-d H:i:s');\n            $this->setLoginFailureCount(1 + $count)\n                ->setLoginFailureDatetime($now);\n\n            // \u8ffd\u52a0\n            if (self::LOCK_COUNT === 1 + $count) {\n                $token = sha1(uniqid());\n                $this->setToken($token);\n            }\n\n            return $this->save();\n        }\n\n        //\u30ed\u30b0\u30a4\u30f3\u5931\u6557\u304c\u8a2d\u5b9a\u4ee5\u4e0a\u306e\u3068\u304d\n        return true;\n    }\n\n\n\nHTML\u306e\u4f5c\u6210\n\u6700\u521d\u306b\u3001\u30a2\u30ab\u30a6\u30f3\u30c8\u30ed\u30c3\u30af\u89e3\u9664\u30da\u30fc\u30b8\uff08unlock.php\uff09\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\nsmarty/template/unlock.tpl\n{block name='meta'}\n    <style type=\"text/css\">\n        .login-box, .register-box {\n            margin: 20px auto;\n        }\n    </style>\n{/block}\n{block name='content'}\n    <div class=\"login-box\">\n        <div class=\"login-logo\">\n            <a href=\"/\">\n                <b>Admin</b>\n                LTE\n            </a>\n        </div>\n        <!-- /.login-logo -->\n        <div class=\"login-box-body\">\n\n            <p class=\"login-box-msg\">\u30ed\u30c3\u30af\u3092\u89e3\u9664\u3059\u308b\u306b\u306f\u3001\u4e0b\u306e\u30dc\u30bf\u30f3\u3092\u62bc\u3057\u3066\u304f\u3060\u3055\u3044\u3002</p>\n\n            <form action=\"\" method=\"post\">\n                <div class=\"row\">\n                    <div class=\"col-xs-6 col-xs-offset-3\">\n                        <button type=\"submit\" class=\"btn btn-primary btn-block btn-flat\">\n                            \u30ed\u30c3\u30af\u3092\u89e3\u9664\u3059\u308b\n                        </button>\n                    </div>\n                </div>\n            </form>\n\n        </div>\n        <!-- /.login-box-body -->\n    </div>\n    <!-- /.login-box -->\n{/block}\n{block name='script'}\n{/block}\n\n\n\nPHP\n\u3053\u306e\u89e3\u9664\u30da\u30fc\u30b8\u306f\u3001\u30a2\u30ab\u30a6\u30f3\u30c8\u30ed\u30c3\u30af\u304c\u3055\u308c\u3066\u3044\u306a\u3044\u30e6\u30fc\u30b6\u30fc\u306b\u8868\u793a\u3059\u308b\u5fc5\u8981\u306f\u3042\u308a\u307e\u305b\u3093\u306e\u3067\u3001\u30c8\u30fc\u30af\u30f3\u304c\u6709\u52b9\u3067\u3042\u308b\u304b\u3069\u3046\u304b\u3092\u5224\u65ad\u3057\u3066\u3001\u5fc5\u8981\u304c\u306a\u3044\u5834\u5408\u306b\u306f\u3001\u975e\u8868\u793a\u306b\u3057\u305f\u3044\u3068\u3053\u308d\u3067\u3059\u3002\n\u305d\u3053\u3067\u3001\u3053\u306e\u30da\u30fc\u30b8\u306eURL\u306f\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u8868\u73fe\u3057\u3066\u304a\u304d\u307e\u3057\u3087\u3046\u3002\n\nURL\nhttp://www.example.com/unlock.php?token=(\u89e3\u9664\u30ad\u30fc)\n\n\n\u30c8\u30fc\u30af\u30f3\u30ad\u30fc\u304c\u4e00\u81f4\u3057\u3066\u3044\u308b\u30e6\u30fc\u30b6\u30fc\u304b\u3089\u30e2\u30c7\u30eb\u3092\u53d6\u5f97\u3059\u308c\u3070\u3001\u30e6\u30fc\u30b6\u30fc\u3092\u7279\u5b9a\u3067\u304d\u307e\u3059\u3002\u9006\u306b\u3067\u304d\u306a\u3051\u308c\u3070\u3001\u3053\u306e\u30da\u30fc\u30b8\u3092\u975e\u8868\u793a\u306b\u3057\u307e\u3059\u3002\n\u57fa\u672c\u7684\u306b\u306f\u3001Controller\u306b\u8a18\u8ff0\u3057\u307e\u3059\u3002\n\u8ffd\u52a0\n\nclasses/controller/UserController.class.php\n    /**\n     * \u30c8\u30fc\u30af\u30f3\u304b\u3089\u30e6\u30fc\u30b6\u30fc\u30e2\u30c7\u30eb\u3092\u53d6\u5f97\u3057\u3001\u30ed\u30c3\u30af\u4e2d\u304b\u3069\u3046\u304b\u3092\u5224\u5b9a\u3059\u308b\n     * @return boolean\n     */\n    public static function isAccountLock()\n    {\n        $token = filter_input(INPUT_GET, 'token');\n        $objUserModel = new UserModel();\n        $objUserModel->getModelByToken($token);\n        return $objUserModel->isAccountLock();\n    }\n\n\n\u8ffd\u52a0\n\nclasses/model/UserModel.class.php\n    /**\n     * \u30c8\u30fc\u30af\u30f3\u304b\u3089\u30e6\u30fc\u30b6\u30fc\u3092\u691c\u7d22\u3059\u308b\n     * @param string $token\n     * @return \\MyApp\\model\\UserModel\n     */\n    public function getModelByToken($token)\n    {\n        $dao = UserDao::getDaoFromToken($token);\n        return (isset($dao[0])) ? $this->setProperty(reset($dao)) : null;\n    }\n\n\n\u8ffd\u52a0\n\nclasses/dao/UserDao.class.php\n    /**\n     * \u30c8\u30fc\u30af\u30f3\u304b\u3089\u914d\u5217\u3092\u53d6\u5f97\u3059\u308b\n     * @param type $token\n     * @return array\n     */\n    public static function getDaoFromToken($token)\n    {\n        $sql = \"SELECT \";\n        $sql .= \"`userId`\";\n        $sql .= \", `password`\";\n        $sql .= \", `displayName`\";\n        $sql .= \", `email`\";\n        $sql .= \", `token`\";\n        $sql .= \", `loginFailureCount`\";\n        $sql .= \", `loginFailureDatetime`\";\n        $sql .= \", `deleteFlag` \";\n        $sql .= \"FROM `tbl_user` \";\n        $sql .= \"WHERE `token` = :token \";\n        $sql .= \"AND `deleteFlag` = 0 \";\n\n        $arr = array();\n        $arr[':token'] = $token;\n        return Db::select($sql, $arr);\n    }\n\n\n\nwebroot/unlock.php\n<?php\n\n/**\n * unlock.php\n */\n\nnamespace MyApp;\n\nuse MyApp\\controller\\LoginController;\nuse MyApp\\common\\Template;\n\ndefine('LAYOUT', 'index');\n\ntry {\n    require_once '../common.php';\n\n    // \u30a2\u30ab\u30a6\u30f3\u30c8\u30ed\u30c3\u30af\u5224\u5b9a\n    Template::assign('is_lock', LoginController::isAccountLock());\n} catch (\\Exception $e) {\n    Template::exception($e);\n} finally {\n    Template::display();\n}\n\n\nis_lock \u3092\u4f7f\u3063\u3066\u30da\u30fc\u30b8\u306e\u8868\u793a\u3092\u5207\u308a\u66ff\u3048\u307e\u3059\u3002\n\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u3092\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u5909\u66f4\u3057\u307e\u3059\u3002\n\nsmarty/template/unlock.tpl\n{block name='meta'}\n    <style type=\"text/css\">\n        .login-box, .register-box {\n            margin: 20px auto;\n        }\n    </style>\n{/block}\n{block name='content'}\n    <div class=\"login-box\">\n        <div class=\"login-logo\">\n            <a href=\"/\">\n                <b>Admin</b>\n                LTE\n            </a>\n        </div>\n        <!-- /.login-logo -->\n        <div class=\"login-box-body\">\n\n            {if $is_lock}\n                <p class=\"login-box-msg\">\u30ed\u30c3\u30af\u3092\u89e3\u9664\u3059\u308b\u306b\u306f\u3001\u4e0b\u306e\u30dc\u30bf\u30f3\u3092\u62bc\u3057\u3066\u304f\u3060\u3055\u3044\u3002</p>\n\n                <form action=\"\" method=\"post\">\n                    <div class=\"row\">\n                        <div class=\"col-xs-6 col-xs-offset-3\">\n                            <button type=\"submit\" class=\"btn btn-primary btn-block btn-flat\">\n                                \u30ed\u30c3\u30af\u3092\u89e3\u9664\u3059\u308b\n                            </button>\n                        </div>\n                    </div>\n                </form>\n            {else}\n                <p class=\"login-box-msg\">\u30a2\u30ab\u30a6\u30f3\u30c8\u306f\u30ed\u30c3\u30af\u3055\u308c\u3066\u3044\u307e\u305b\u3093\u3002</p>\n                <p class=\"login-box-msg\">\n                    <a href=\"/\">\u30ed\u30b0\u30a4\u30f3\u30da\u30fc\u30b8</a> \u3088\u308a\u30ed\u30b0\u30a4\u30f3\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n                </p>\n            {/if}\n\n        </div>\n        <!-- /.login-box-body -->\n    </div>\n    <!-- /.login-box -->\n{/block}\n{block name='script'}\n{/block}\n\n\n\n\u30ed\u30c3\u30af\u89e3\u9664\u30fb\u30e1\u30bd\u30c3\u30c9\u306e\u5b9f\u88c5\n\u3053\u308c\u3082\u5165\u308a\u53e3\u3068\u306a\u308b\u30e1\u30bd\u30c3\u30c9\u306f\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u30fc\u306b\u8a18\u8ff0\u3057\u307e\u3059\u3002\nunlock() \u3068\u3044\u3046\u540d\u524d\u306b\u3057\u3066\u304a\u304d\u307e\u3057\u3087\u3046\u3002\u3053\u306e\u95a2\u6570\u304c true \u3092\u8fd4\u3057\u305f\u3068\u304d\u306b\u3001\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u306b\u306f\u300c\u30a2\u30ab\u30a6\u30f3\u30c8\u30ed\u30c3\u30af\u3092\u89e3\u9664\u3057\u307e\u3057\u305f\u300d\u3068\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u8868\u793a\u3057\u307e\u3059\u3002\n\nclasses/controller/UserController.class.php\n    /**\n     * \u30ed\u30c3\u30af\u3092\u89e3\u9664\u3059\u308b\n     * @return boolean | null\n     */\n    public static function unlock()\n    {\n        if (null == filter_input_array(INPUT_POST)) {\n            return;\n        }\n\n        $token = filter_input(INPUT_GET, 'token');\n\n        Db::transaction();\n        $objUserModel = new UserModel();\n        $objUserModel->getModelByToken($token);\n        $objUserModel->setLoginFailureCount(0)\n            ->setLoginFailureDatetime(NULL)\n            ->setToken('')\n            ->save();\n        DB::commit();\n\n        return true;\n    }\n\n\n\nwebroot/unlock.php\n<?php\n\n/**\n * unlock.php\n */\n\nnamespace MyApp;\n\nuse MyApp\\controller\\LoginController;\nuse MyApp\\common\\Template;\n\ndefine('LAYOUT', 'index');\n\ntry {\n    require_once '../common.php';\n    Template::assign('is_lock', LoginController::isAccountLock());\n    Template::assign('success', LoginController::unlock()); // \u8ffd\u52a0\n} catch (\\Exception $e) {\n    Template::exception($e);\n} finally {\n    Template::display();\n}\n\n\n\nsmarty/template/unlock.tpl\n{block name='meta'}\n    <style type=\"text/css\">\n        .login-box, .register-box {\n            margin: 20px auto;\n        }\n    </style>\n{/block}\n{block name='content'}\n    <div class=\"login-box\">\n        <div class=\"login-logo\">\n            <a href=\"/\">\n                <b>Admin</b>\n                LTE\n            </a>\n        </div>\n        <!-- /.login-logo -->\n        <div class=\"login-box-body\">\n\n            {if $success|default:null}\n                <p class=\"login-box-msg\">\u30a2\u30ab\u30a6\u30f3\u30c8\u30ed\u30c3\u30af\u3092\u89e3\u9664\u3057\u307e\u3057\u305f\u3002</p>\n                <p class=\"login-box-msg\">\n                    <a href=\"/\">\u30ed\u30b0\u30a4\u30f3\u30da\u30fc\u30b8</a> \u3088\u308a\u30ed\u30b0\u30a4\u30f3\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n                </p>\n            {else}\n\n                {if $is_lock}\n                    <p class=\"login-box-msg\">\u30ed\u30c3\u30af\u3092\u89e3\u9664\u3059\u308b\u306b\u306f\u3001\u4e0b\u306e\u30dc\u30bf\u30f3\u3092\u62bc\u3057\u3066\u304f\u3060\u3055\u3044\u3002</p>\n\n                    <form action=\"\" method=\"post\">\n                        <div class=\"row\">\n                            <div class=\"col-xs-6 col-xs-offset-3\">\n                                <button type=\"submit\" class=\"btn btn-primary btn-block btn-flat\">\n                                    \u30ed\u30c3\u30af\u3092\u89e3\u9664\u3059\u308b\n                                </button>\n                            </div>\n                        </div>\n                    </form>\n                {else}\n                    <p class=\"login-box-msg\">\u30a2\u30ab\u30a6\u30f3\u30c8\u306f\u30ed\u30c3\u30af\u3055\u308c\u3066\u3044\u307e\u305b\u3093\u3002</p>\n                    <p class=\"login-box-msg\">\n                        <a href=\"/\">\u30ed\u30b0\u30a4\u30f3\u30da\u30fc\u30b8</a> \u3088\u308a\u30ed\u30b0\u30a4\u30f3\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n                    </p>\n                {/if}\n            {/if}\n\n        </div>\n        <!-- /.login-box-body -->\n    </div>\n    <!-- /.login-box -->\n{/block}\n{block name='script'}\n{/block}\n\n\n\u3072\u3068\u901a\u308a\u306e\u6a5f\u80fd\u3067\u4e2d\u5fc3\u7684\u306a\u90e8\u5206\u3092\u5b9f\u88c5\u3057\u305f\u3053\u3068\u306b\u306a\u308a\u307e\u3059\u304c\u3001\u3053\u308c\u3060\u3051\u3067\u306f\u4e0d\u5341\u5206\u3067\u3059\u3002\u3053\u306e\u307e\u307e\u3067\u306f\u307e\u3060\u3001CSRF\u306e\u554f\u984c\u304c\u3042\u308a\u307e\u3059\u3002\n\u3053\u308c\u3044\u3064\u3044\u3066\u306f\u3001\u307e\u3060\u7d9a\u304d\u3067\u5b9f\u88c5\u3057\u3066\u3086\u304d\u307e\u3057\u3087\u3046\u3002\n\n1. [\u57fa\u672c\u8a2d\u8a08\u3001\u30e6\u30fc\u30b6\u30fc\u30e2\u30c7\u30eb](http://qiita.com/ShibuyaKosuke/items/f114ffccf441edb2b745)\n2. [\u30aa\u30fc\u30c8\u30ed\u30fc\u30c0\u30fc](http://qiita.com/ShibuyaKosuke/items/6109810464a7293293bd)\n3. [\u4f8b\u5916\u30fb\u30ed\u30b0](http://qiita.com/ShibuyaKosuke/items/88b1305a4ff0c5f3e728)\n4. [PDO \u30b7\u30f3\u30b0\u30eb\u30c8\u30f3\u3000SQL\u30a4\u30f3\u30b8\u30a7\u30af\u30b7\u30e7\u30f3](http://qiita.com/ShibuyaKosuke/items/094df7f399912ae7df56)\n\t* [\u6c4e\u7528\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u30fb\u30af\u30e9\u30b9\u4f5c\u6210](http://qiita.com/ShibuyaKosuke/items/8502492ac024362b528d)\n\n5. [\u30e6\u30fc\u30b6\u30fc\u30e2\u30c7\u30eb\u306e\u4f5c\u6210](http://qiita.com/ShibuyaKosuke/items/81c556d836d70a29c5f3)\n6. [\u30af\u30e9\u30b9\u306e\u7d99\u627f](http://qiita.com/ShibuyaKosuke/items/490ffa6a92670cf6c644)\n7. [\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u30fb\u30af\u30e9\u30b9\u306e\u5b9f\u88c5](http://qiita.com/ShibuyaKosuke/items/803dc58a23601118942e)\n8. [\u30a2\u30ab\u30a6\u30f3\u30c8\u30ed\u30c3\u30af\u6a5f\u80fd\u306e\u5b9f\u88c5](http://qiita.com/ShibuyaKosuke/items/e890becdb8193d3def05)\n9. [\u30e1\u30fc\u30eb\u9001\u4fe1\u6a5f\u80fd\u306e\u5b9f\u88c5](http://qiita.com/ShibuyaKosuke/items/78c8673782ebbf51584b)\n10. \u30a2\u30ab\u30a6\u30f3\u30c8\u30ed\u30c3\u30af\u89e3\u9664\u6a5f\u80fd\u306e\u5b9f\u88c5\n11. [CSRF\u5bfe\u7b56](http://qiita.com/ShibuyaKosuke/items/8100e304e4447e44e98c)\n\n\u524d\u56de\u306e\u7d9a\u304d\u3067\u3059\u3002\n\n##\u306f\u3058\u3081\u306b\n\n\u8981\u4ef6\u3092\u307e\u3068\u3081\u307e\u3059\u3002\n\n1. \u30a2\u30ab\u30a6\u30f3\u30c8\u304c\u30ed\u30c3\u30af\u3055\u308c\u305f\u3068\u304d\u3001\u30ed\u30c3\u30af\u3055\u308c\u305f\u30a2\u30ab\u30a6\u30f3\u30c8\u306e\u30e6\u30fc\u30b6\u30fc\u5b9b\u3066\u306b\u3001\u30e1\u30fc\u30eb\u3092\u9001\u4fe1\u3059\u308b\u3002\n2. \u30a2\u30ab\u30a6\u30f3\u30c8\u30ed\u30c3\u30af\u89e3\u9664\u30da\u30fc\u30b8\u306eURL\u306f\u30e1\u30fc\u30eb\u3067\u901a\u77e5\u3059\u308b\u3002\n3. \u30a2\u30ab\u30a6\u30f3\u30c8\u30ed\u30c3\u30af\u89e3\u9664\u30da\u30fc\u30b8\u306e\u300c\u89e3\u9664\u300d\u30dc\u30bf\u30f3\u3092\u62bc\u4e0b\u3059\u308b\u3068\u3001\u30a2\u30ab\u30a6\u30f3\u30c8\u30ed\u30c3\u30af\u3092\u89e3\u9664\u3059\u308b\u3002\n\n\u30a2\u30ab\u30a6\u30f3\u30c8\u30ed\u30c3\u30af\u306f\u3001\u5f53\u7136\u30ed\u30b0\u30a4\u30f3\u306b\u6210\u529f\u3057\u3066\u3044\u306a\u3044\u30e6\u30fc\u30b6\u30fc\u304c\u5229\u7528\u3059\u308b\u6a5f\u80fd\u3067\u3059\u306e\u3067\u3001\u30bb\u30c3\u30b7\u30e7\u30f3\u3092\u7528\u3044\u3066\u30e6\u30fc\u30b6\u30fc\u3092\u7279\u5b9a\u3059\u308b\u3053\u3068\u306f\u3067\u304d\u307e\u305b\u3093\u3002\n\u305d\u3053\u3067\u3001\u300c\u89e3\u9664\u30b3\u30fc\u30c9\u300d\u306e\u3088\u3046\u306a\u30ad\u30fc\u3092\u7528\u3044\u3066\u30e6\u30fc\u30b6\u30fc\u3092\u7279\u5b9a\u3059\u308b\u3053\u3068\u306b\u306a\u308a\u307e\u3059\u3002\n\n\u300c\u89e3\u9664\u30b3\u30fc\u30c9\u300d\u306f\u30a2\u30ab\u30a6\u30f3\u30c8\u304c\u30ed\u30c3\u30af\u3055\u308c\u305f\u30bf\u30a4\u30df\u30f3\u30b0\u3067\u767a\u884c\u3057\u3001DB\u306b\u4fdd\u5b58\u3057\u3066\u304a\u304f\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n`UserModel.class.php` \u306b\u5b9a\u7fa9\u3055\u308c\u3066\u3044\u308b\u3001`loginFailureIncrement()` \u306b\u305d\u306e\u51e6\u7406\u3092\u8db3\u3057\u3066\u304a\u304d\u307e\u3057\u3087\u3046\u3002\n\n`tbl_user`\u30c6\u30fc\u30d6\u30eb\u306e`token`\u306b\u305d\u306e\u5024\u3092\u66f8\u304d\u8fbc\u307f\u307e\u3059\u3002\n\n```php:classes/model/UserModel.class.php\n\t/**\n\t * \u30ed\u30b0\u30a4\u30f3\u5931\u6557\u3092\u30a4\u30f3\u30af\u30ea\u30e1\u30f3\u30c8\u3059\u308b\n\t * \u6307\u5b9a\u56de\u6570\uff08self::LOCK_COUNT\uff09\u306b\u6e80\u305f\u306a\u3044\u3068\u304d\u306e\u307f\uff0b\uff11\n\t * @return bool\n\t */\n\tpublic function loginFailureIncrement()\n\t{\n\t\t$count = $this->getLoginFailureCount();\n\t\tif (self::LOCK_COUNT > $count) {\n\t\t\t$now = (new \\DateTime())->format('Y-m-d H:i:s');\n\t\t\t$this->setLoginFailureCount(1 + $count)\n\t\t\t\t->setLoginFailureDatetime($now);\n\n\t\t\t// \u8ffd\u52a0\n\t\t\tif (self::LOCK_COUNT === 1 + $count) {\n\t\t\t\t$token = sha1(uniqid());\n\t\t\t\t$this->setToken($token);\n\t\t\t}\n\n\t\t\treturn $this->save();\n\t\t}\n\n\t\t//\u30ed\u30b0\u30a4\u30f3\u5931\u6557\u304c\u8a2d\u5b9a\u4ee5\u4e0a\u306e\u3068\u304d\n\t\treturn true;\n\t}\n```\n\n\n##HTML\u306e\u4f5c\u6210\n\n\u6700\u521d\u306b\u3001\u30a2\u30ab\u30a6\u30f3\u30c8\u30ed\u30c3\u30af\u89e3\u9664\u30da\u30fc\u30b8\uff08unlock.php\uff09\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n```html:smarty/template/unlock.tpl\n{block name='meta'}\n\t<style type=\"text/css\">\n\t\t.login-box, .register-box {\n\t\t\tmargin: 20px auto;\n\t\t}\n\t</style>\n{/block}\n{block name='content'}\n\t<div class=\"login-box\">\n\t\t<div class=\"login-logo\">\n\t\t\t<a href=\"/\">\n\t\t\t\t<b>Admin</b>\n\t\t\t\tLTE\n\t\t\t</a>\n\t\t</div>\n\t\t<!-- /.login-logo -->\n\t\t<div class=\"login-box-body\">\n\n\t\t\t<p class=\"login-box-msg\">\u30ed\u30c3\u30af\u3092\u89e3\u9664\u3059\u308b\u306b\u306f\u3001\u4e0b\u306e\u30dc\u30bf\u30f3\u3092\u62bc\u3057\u3066\u304f\u3060\u3055\u3044\u3002</p>\n\n\t\t\t<form action=\"\" method=\"post\">\n\t\t\t\t<div class=\"row\">\n\t\t\t\t\t<div class=\"col-xs-6 col-xs-offset-3\">\n\t\t\t\t\t\t<button type=\"submit\" class=\"btn btn-primary btn-block btn-flat\">\n\t\t\t\t\t\t\t\u30ed\u30c3\u30af\u3092\u89e3\u9664\u3059\u308b\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</form>\n\n\t\t</div>\n\t\t<!-- /.login-box-body -->\n\t</div>\n\t<!-- /.login-box -->\n{/block}\n{block name='script'}\n{/block}\n```\n\n##PHP\n\n\u3053\u306e\u89e3\u9664\u30da\u30fc\u30b8\u306f\u3001\u30a2\u30ab\u30a6\u30f3\u30c8\u30ed\u30c3\u30af\u304c\u3055\u308c\u3066\u3044\u306a\u3044\u30e6\u30fc\u30b6\u30fc\u306b\u8868\u793a\u3059\u308b\u5fc5\u8981\u306f\u3042\u308a\u307e\u305b\u3093\u306e\u3067\u3001\u30c8\u30fc\u30af\u30f3\u304c\u6709\u52b9\u3067\u3042\u308b\u304b\u3069\u3046\u304b\u3092\u5224\u65ad\u3057\u3066\u3001\u5fc5\u8981\u304c\u306a\u3044\u5834\u5408\u306b\u306f\u3001\u975e\u8868\u793a\u306b\u3057\u305f\u3044\u3068\u3053\u308d\u3067\u3059\u3002\n\n\u305d\u3053\u3067\u3001\u3053\u306e\u30da\u30fc\u30b8\u306eURL\u306f\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u8868\u73fe\u3057\u3066\u304a\u304d\u307e\u3057\u3087\u3046\u3002\n\n```txt:URL\nhttp://www.example.com/unlock.php?token=(\u89e3\u9664\u30ad\u30fc)\n```\n\n\u30c8\u30fc\u30af\u30f3\u30ad\u30fc\u304c\u4e00\u81f4\u3057\u3066\u3044\u308b\u30e6\u30fc\u30b6\u30fc\u304b\u3089\u30e2\u30c7\u30eb\u3092\u53d6\u5f97\u3059\u308c\u3070\u3001\u30e6\u30fc\u30b6\u30fc\u3092\u7279\u5b9a\u3067\u304d\u307e\u3059\u3002\u9006\u306b\u3067\u304d\u306a\u3051\u308c\u3070\u3001\u3053\u306e\u30da\u30fc\u30b8\u3092\u975e\u8868\u793a\u306b\u3057\u307e\u3059\u3002\n\n\u57fa\u672c\u7684\u306b\u306f\u3001Controller\u306b\u8a18\u8ff0\u3057\u307e\u3059\u3002\n\n\u8ffd\u52a0\n\n```php:classes/controller/UserController.class.php\n\t/**\n\t * \u30c8\u30fc\u30af\u30f3\u304b\u3089\u30e6\u30fc\u30b6\u30fc\u30e2\u30c7\u30eb\u3092\u53d6\u5f97\u3057\u3001\u30ed\u30c3\u30af\u4e2d\u304b\u3069\u3046\u304b\u3092\u5224\u5b9a\u3059\u308b\n\t * @return boolean\n\t */\n\tpublic static function isAccountLock()\n\t{\n\t\t$token = filter_input(INPUT_GET, 'token');\n\t\t$objUserModel = new UserModel();\n\t\t$objUserModel->getModelByToken($token);\n\t\treturn $objUserModel->isAccountLock();\n\t}\n```\n\n\u8ffd\u52a0\n\n```php:classes/model/UserModel.class.php\n\t/**\n\t * \u30c8\u30fc\u30af\u30f3\u304b\u3089\u30e6\u30fc\u30b6\u30fc\u3092\u691c\u7d22\u3059\u308b\n\t * @param string $token\n\t * @return \\MyApp\\model\\UserModel\n\t */\n\tpublic function getModelByToken($token)\n\t{\n\t\t$dao = UserDao::getDaoFromToken($token);\n\t\treturn (isset($dao[0])) ? $this->setProperty(reset($dao)) : null;\n\t}\n```\n\n\u8ffd\u52a0\n\n```php:classes/dao/UserDao.class.php\n\t/**\n\t * \u30c8\u30fc\u30af\u30f3\u304b\u3089\u914d\u5217\u3092\u53d6\u5f97\u3059\u308b\n\t * @param type $token\n\t * @return array\n\t */\n\tpublic static function getDaoFromToken($token)\n\t{\n\t\t$sql = \"SELECT \";\n\t\t$sql .= \"`userId`\";\n\t\t$sql .= \", `password`\";\n\t\t$sql .= \", `displayName`\";\n\t\t$sql .= \", `email`\";\n\t\t$sql .= \", `token`\";\n\t\t$sql .= \", `loginFailureCount`\";\n\t\t$sql .= \", `loginFailureDatetime`\";\n\t\t$sql .= \", `deleteFlag` \";\n\t\t$sql .= \"FROM `tbl_user` \";\n\t\t$sql .= \"WHERE `token` = :token \";\n\t\t$sql .= \"AND `deleteFlag` = 0 \";\n\n\t\t$arr = array();\n\t\t$arr[':token'] = $token;\n\t\treturn Db::select($sql, $arr);\n\t}\n```\n\n```php:webroot/unlock.php\n<?php\n\n/**\n * unlock.php\n */\n\nnamespace MyApp;\n\nuse MyApp\\controller\\LoginController;\nuse MyApp\\common\\Template;\n\ndefine('LAYOUT', 'index');\n\ntry {\n\trequire_once '../common.php';\n\t\n\t// \u30a2\u30ab\u30a6\u30f3\u30c8\u30ed\u30c3\u30af\u5224\u5b9a\n\tTemplate::assign('is_lock', LoginController::isAccountLock());\n} catch (\\Exception $e) {\n\tTemplate::exception($e);\n} finally {\n\tTemplate::display();\n}\n```\n\n`is_lock` \u3092\u4f7f\u3063\u3066\u30da\u30fc\u30b8\u306e\u8868\u793a\u3092\u5207\u308a\u66ff\u3048\u307e\u3059\u3002\n\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u3092\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u5909\u66f4\u3057\u307e\u3059\u3002\n\n```html:smarty/template/unlock.tpl\n{block name='meta'}\n\t<style type=\"text/css\">\n\t\t.login-box, .register-box {\n\t\t\tmargin: 20px auto;\n\t\t}\n\t</style>\n{/block}\n{block name='content'}\n\t<div class=\"login-box\">\n\t\t<div class=\"login-logo\">\n\t\t\t<a href=\"/\">\n\t\t\t\t<b>Admin</b>\n\t\t\t\tLTE\n\t\t\t</a>\n\t\t</div>\n\t\t<!-- /.login-logo -->\n\t\t<div class=\"login-box-body\">\n\n\t\t\t{if $is_lock}\n\t\t\t\t<p class=\"login-box-msg\">\u30ed\u30c3\u30af\u3092\u89e3\u9664\u3059\u308b\u306b\u306f\u3001\u4e0b\u306e\u30dc\u30bf\u30f3\u3092\u62bc\u3057\u3066\u304f\u3060\u3055\u3044\u3002</p>\n\n\t\t\t\t<form action=\"\" method=\"post\">\n\t\t\t\t\t<div class=\"row\">\n\t\t\t\t\t\t<div class=\"col-xs-6 col-xs-offset-3\">\n\t\t\t\t\t\t\t<button type=\"submit\" class=\"btn btn-primary btn-block btn-flat\">\n\t\t\t\t\t\t\t\t\u30ed\u30c3\u30af\u3092\u89e3\u9664\u3059\u308b\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</form>\n\t\t\t{else}\n\t\t\t\t<p class=\"login-box-msg\">\u30a2\u30ab\u30a6\u30f3\u30c8\u306f\u30ed\u30c3\u30af\u3055\u308c\u3066\u3044\u307e\u305b\u3093\u3002</p>\n\t\t\t\t<p class=\"login-box-msg\">\n\t\t\t\t\t<a href=\"/\">\u30ed\u30b0\u30a4\u30f3\u30da\u30fc\u30b8</a> \u3088\u308a\u30ed\u30b0\u30a4\u30f3\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\t\t\t\t</p>\n\t\t\t{/if}\n\n\t\t</div>\n\t\t<!-- /.login-box-body -->\n\t</div>\n\t<!-- /.login-box -->\n{/block}\n{block name='script'}\n{/block}\n```\n\n##\u30ed\u30c3\u30af\u89e3\u9664\u30fb\u30e1\u30bd\u30c3\u30c9\u306e\u5b9f\u88c5\n\n\n\u3053\u308c\u3082\u5165\u308a\u53e3\u3068\u306a\u308b\u30e1\u30bd\u30c3\u30c9\u306f\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u30fc\u306b\u8a18\u8ff0\u3057\u307e\u3059\u3002\n\n`unlock()` \u3068\u3044\u3046\u540d\u524d\u306b\u3057\u3066\u304a\u304d\u307e\u3057\u3087\u3046\u3002\u3053\u306e\u95a2\u6570\u304c `true` \u3092\u8fd4\u3057\u305f\u3068\u304d\u306b\u3001\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u306b\u306f\u300c\u30a2\u30ab\u30a6\u30f3\u30c8\u30ed\u30c3\u30af\u3092\u89e3\u9664\u3057\u307e\u3057\u305f\u300d\u3068\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u8868\u793a\u3057\u307e\u3059\u3002\n\n```php:classes/controller/UserController.class.php\n\t/**\n\t * \u30ed\u30c3\u30af\u3092\u89e3\u9664\u3059\u308b\n\t * @return boolean | null\n\t */\n\tpublic static function unlock()\n\t{\n\t\tif (null == filter_input_array(INPUT_POST)) {\n\t\t\treturn;\n\t\t}\n\n\t\t$token = filter_input(INPUT_GET, 'token');\n\n\t\tDb::transaction();\n\t\t$objUserModel = new UserModel();\n\t\t$objUserModel->getModelByToken($token);\n\t\t$objUserModel->setLoginFailureCount(0)\n\t\t\t->setLoginFailureDatetime(NULL)\n\t\t\t->setToken('')\n\t\t\t->save();\n\t\tDB::commit();\n\n\t\treturn true;\n\t}\n```\n\n```php:webroot/unlock.php\n<?php\n\n/**\n * unlock.php\n */\n\nnamespace MyApp;\n\nuse MyApp\\controller\\LoginController;\nuse MyApp\\common\\Template;\n\ndefine('LAYOUT', 'index');\n\ntry {\n\trequire_once '../common.php';\n\tTemplate::assign('is_lock', LoginController::isAccountLock());\n\tTemplate::assign('success', LoginController::unlock()); // \u8ffd\u52a0\n} catch (\\Exception $e) {\n\tTemplate::exception($e);\n} finally {\n\tTemplate::display();\n}\n```\n\n```html:smarty/template/unlock.tpl\n{block name='meta'}\n\t<style type=\"text/css\">\n\t\t.login-box, .register-box {\n\t\t\tmargin: 20px auto;\n\t\t}\n\t</style>\n{/block}\n{block name='content'}\n\t<div class=\"login-box\">\n\t\t<div class=\"login-logo\">\n\t\t\t<a href=\"/\">\n\t\t\t\t<b>Admin</b>\n\t\t\t\tLTE\n\t\t\t</a>\n\t\t</div>\n\t\t<!-- /.login-logo -->\n\t\t<div class=\"login-box-body\">\n\n\t\t\t{if $success|default:null}\n\t\t\t\t<p class=\"login-box-msg\">\u30a2\u30ab\u30a6\u30f3\u30c8\u30ed\u30c3\u30af\u3092\u89e3\u9664\u3057\u307e\u3057\u305f\u3002</p>\n\t\t\t\t<p class=\"login-box-msg\">\n\t\t\t\t\t<a href=\"/\">\u30ed\u30b0\u30a4\u30f3\u30da\u30fc\u30b8</a> \u3088\u308a\u30ed\u30b0\u30a4\u30f3\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\t\t\t\t</p>\n\t\t\t{else}\n\n\t\t\t\t{if $is_lock}\n\t\t\t\t\t<p class=\"login-box-msg\">\u30ed\u30c3\u30af\u3092\u89e3\u9664\u3059\u308b\u306b\u306f\u3001\u4e0b\u306e\u30dc\u30bf\u30f3\u3092\u62bc\u3057\u3066\u304f\u3060\u3055\u3044\u3002</p>\n\n\t\t\t\t\t<form action=\"\" method=\"post\">\n\t\t\t\t\t\t<div class=\"row\">\n\t\t\t\t\t\t\t<div class=\"col-xs-6 col-xs-offset-3\">\n\t\t\t\t\t\t\t\t<button type=\"submit\" class=\"btn btn-primary btn-block btn-flat\">\n\t\t\t\t\t\t\t\t\t\u30ed\u30c3\u30af\u3092\u89e3\u9664\u3059\u308b\n\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</form>\n\t\t\t\t{else}\n\t\t\t\t\t<p class=\"login-box-msg\">\u30a2\u30ab\u30a6\u30f3\u30c8\u306f\u30ed\u30c3\u30af\u3055\u308c\u3066\u3044\u307e\u305b\u3093\u3002</p>\n\t\t\t\t\t<p class=\"login-box-msg\">\n\t\t\t\t\t\t<a href=\"/\">\u30ed\u30b0\u30a4\u30f3\u30da\u30fc\u30b8</a> \u3088\u308a\u30ed\u30b0\u30a4\u30f3\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\t\t\t\t\t</p>\n\t\t\t\t{/if}\n\t\t\t{/if}\n\n\t\t</div>\n\t\t<!-- /.login-box-body -->\n\t</div>\n\t<!-- /.login-box -->\n{/block}\n{block name='script'}\n{/block}\n```\n\n\u3072\u3068\u901a\u308a\u306e\u6a5f\u80fd\u3067\u4e2d\u5fc3\u7684\u306a\u90e8\u5206\u3092\u5b9f\u88c5\u3057\u305f\u3053\u3068\u306b\u306a\u308a\u307e\u3059\u304c\u3001\u3053\u308c\u3060\u3051\u3067\u306f\u4e0d\u5341\u5206\u3067\u3059\u3002\u3053\u306e\u307e\u307e\u3067\u306f\u307e\u3060\u3001`CSRF`\u306e\u554f\u984c\u304c\u3042\u308a\u307e\u3059\u3002\n\u3053\u308c\u3044\u3064\u3044\u3066\u306f\u3001\u307e\u3060\u7d9a\u304d\u3067\u5b9f\u88c5\u3057\u3066\u3086\u304d\u307e\u3057\u3087\u3046\u3002\n", "tags": ["PHP", "\u30ed\u30b0\u30a4\u30f3"]}