{"context": " More than 1 year has passed since last update.\n\nWebSocket\uff1f\n\u4ee5\u4e0b\u306e\u30b9\u30e9\u30a4\u30c9\u3067\u3069\u3046\u3044\u3046\u3082\u306e\u304b\u306f\u5b66\u3073\u307e\u3057\u305f\u3002\nhttp://www.slideshare.net/You_Kinjoh/websocket-10621887\n\nGo\u3067\u5b9f\u88c5\u3092\u8a66\u3059\n\u30b7\u30f3\u30d7\u30eb\u306becho\u30b5\u30fc\u30d0\u3092\u5b9f\u88c5\u3059\u308b\u3068\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\n\nmain.go\npackage main\n\nimport (\n    \"code.google.com/p/go.net/websocket\"\n    \"io\"\n    \"net/http\"\n)\n\nfunc echoHandler(ws *websocket.Conn) {\n    io.Copy(ws, ws)\n}\n\nfunc main() {\n\n    http.Handle(\"/echo\", websocket.Handler(echoHandler))\n    http.Handle(\"/\", http.FileServer(http.Dir(\"./\")))\n    if err := http.ListenAndServe(\":9999\", nil); err != nil {\n        panic(\"ListenAndServe: \" + err.Error())\n    }\n\n}\n\n\n\nindex.html\n\n<html>\n<head>\n    <title>websocket sample</title>\n    <script type=\"text/javascript\">\n    // var wsUri = \"ws://echo.websocket.org/\"; \n    var wsUri = \"ws://localhost:9999/echo\"; \n\n    var output;  \n    function init() { \n        output = document.getElementById(\"output\"); \n        testWebSocket(); \n    } \n\n    function testWebSocket() { \n        websocket = new WebSocket(wsUri); \n        websocket.onopen = function(evt) { \n            onOpen(evt) \n        }; \n        websocket.onclose = function(evt) { \n            onClose(evt) \n        }; \n        websocket.onmessage = function(evt) { \n            onMessage(evt) \n        }; \n        websocket.onerror = function(evt) { \n            onError(evt) \n        }; \n    }  \n\n    function onOpen(evt) { \n        writeToScreen(\"CONNECTED\"); \n        doSend(\"websocket\u306b\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u9001\u4fe1\"); \n    }  \n\n    function onClose(evt) { \n\n        writeToScreen(\"DISCONNECTED\"); \n    }  \n\n    function onMessage(evt) { \n        writeToScreen('<span style=\"color: blue;\">RESPONSE: ' + jsonData.Msg+'</span>'); \n        websocket.close(); \n    }  \n\n    function onError(evt) { \n        writeToScreen('<span style=\"color: red;\">ERROR:</span> ' + evt.data); \n    }  \n\n    function doSend(message) { \n        websocket.send(message); \n    }  \n\n    function writeToScreen(message) { \n        var pre = document.createElement(\"p\"); \n        pre.style.wordWrap = \"break-word\"; \n        pre.innerHTML = message; \n        output.appendChild(pre); \n    }  \n\n    window.addEventListener(\"load\", init, false);\n    </script>\n</head>\n<body>\n    <h2>WebSocket Test</h2>  \n    <div id=\"output\"></div>\n</body>\n</html>\n\n\n\u30c7\u30d5\u30a9\u30eb\u30c8\u3067\u306f\u30af\u30ed\u30b9\u30c9\u30e1\u30a4\u30f3\u901a\u4fe1\u306f\u8a31\u53ef\u3055\u308c\u3066\u3044\u306a\u3044\u305f\u3081\u3001index.html\u3092\u30ed\u30fc\u30ab\u30eb\u306b\u304a\u3044\u3066\u8a66\u3059\u3068\u4ee5\u4e0b\u306e\u69d8\u306a\u30a8\u30e9\u30fc\u304c\u51fa\u307e\u3059\nWebSocket connection to 'ws://localhost:9999/echo' failed: Unexpected response code: 403\n\n\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u5909\u66f4\u3059\u308c\u3070\u30af\u30ed\u30b9\u30c9\u30e1\u30a4\u30f3\u901a\u4fe1\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\n\n\u5909\u66f4\u7b87\u6240\nhttp.Handle(\"/echo\", websocket.Handler(echoHandler))\n\n\n\u2193\n\n\u5909\u66f4\u5185\u5bb9\nhttp.HandleFunc(\"/echo\",\n        func(w http.ResponseWriter, req *http.Request) {\n            s := websocket.Server{Handler: websocket.Handler(echoHandler)}\n            s.ServeHTTP(w, req)\n        })\n\n\n\nJSON\u3067\u901a\u4fe1\u3057\u305f\u3044\u5834\u5408\n\nmain.go\n\npackage main\n\nimport (\n    \"code.google.com/p/go.net/websocket\"\n    \"log\"\n    \"net/http\"\n)\n\nfunc echoHandler(ws *websocket.Conn) {\n\n    type T struct {\n        Msg   string\n        Count float64\n    }\n\n    // receive JSON type T\n    var data T\n    websocket.JSON.Receive(ws, &data)\n\n    log.Printf(\"data=%#v\\n\", data)\n\n    // send JSON type T\n    websocket.JSON.Send(ws, data)\n}\n\nfunc main() {\n\n    http.Handle(\"/\", http.FileServer(http.Dir(\"./\")))\n    http.HandleFunc(\"/echo\",\n        func(w http.ResponseWriter, req *http.Request) {\n            s := websocket.Server{Handler: websocket.Handler(echoHandler)}\n            s.ServeHTTP(w, req)\n        })\n\n    if err := http.ListenAndServe(\":9999\", nil); err != nil {\n        panic(\"ListenAndServe: \" + err.Error())\n    }\n\n}\n\n\n\n\nindex.html\n\n<html>\n<head>\n    <title>websocket sample</title>\n    <script type=\"text/javascript\">\n    // var wsUri = \"ws://echo.websocket.org/\"; \n    var wsUri = \"ws://localhost:9999/echo\"; \n\n    var output;  \n    function init() { \n        output = document.getElementById(\"output\"); \n        testWebSocket(); \n    } \n\n    function testWebSocket() { \n        websocket = new WebSocket(wsUri); \n        websocket.onopen = function(evt) { \n            onOpen(evt) \n        }; \n        websocket.onclose = function(evt) { \n            onClose(evt) \n        }; \n        websocket.onmessage = function(evt) { \n            onMessage(evt) \n        }; \n        websocket.onerror = function(evt) { \n            onError(evt) \n        }; \n    }  \n\n    function onOpen(evt) { \n        writeToScreen(\"CONNECTED\"); \n        doSend(\"websocket\u306b\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u9001\u4fe1\",Math.random()); \n    }  \n\n    function onClose(evt) { \n\n        writeToScreen(\"DISCONNECTED\"); \n    }  \n\n    function onMessage(evt) { \n\n        var jsonData=JSON.parse(evt.data)\n\n        writeToScreen('<span style=\"color: blue;\">RESPONSE: ' + jsonData.Msg+\",no:\"+jsonData.Count+'</span>'); \n        websocket.close(); \n    }  \n\n\n    function onError(evt) { \n        writeToScreen('<span style=\"color: red;\">ERROR:</span> ' + evt.data); \n    }  \n\n    function doSend(message,number) { \n\n        writeToScreen(\"SENT: \" + message+\",no: \"+number);  \n        var jsonData={\n            Msg:message,\n            Count:number\n        }\n\n        websocket.send(JSON.stringify(jsonData)); \n    }  \n\n    function writeToScreen(message) { \n        var pre = document.createElement(\"p\"); \n        pre.style.wordWrap = \"break-word\"; \n        pre.innerHTML = message; \n        output.appendChild(pre); \n    }  \n\n    window.addEventListener(\"load\", init, false);\n    </script>\n</head>\n<body>\n\n    <h2>WebSocket Test</h2>  \n    <div id=\"output\"></div>\n\n</body>\n</html>\n\n\n\n\u53c2\u8003\nhttps://github.com/golang-samples/websocket\nhttp://stackoverflow.com/questions/19708330/serving-a-websocket-in-go\n\n#WebSocket\uff1f\n\u4ee5\u4e0b\u306e\u30b9\u30e9\u30a4\u30c9\u3067\u3069\u3046\u3044\u3046\u3082\u306e\u304b\u306f\u5b66\u3073\u307e\u3057\u305f\u3002\nhttp://www.slideshare.net/You_Kinjoh/websocket-10621887\n\n\n#Go\u3067\u5b9f\u88c5\u3092\u8a66\u3059\n\n\u30b7\u30f3\u30d7\u30eb\u306becho\u30b5\u30fc\u30d0\u3092\u5b9f\u88c5\u3059\u308b\u3068\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\n\n```go:main.go\npackage main\n\nimport (\n\t\"code.google.com/p/go.net/websocket\"\n\t\"io\"\n\t\"net/http\"\n)\n\nfunc echoHandler(ws *websocket.Conn) {\n\tio.Copy(ws, ws)\n}\n\nfunc main() {\n\n\thttp.Handle(\"/echo\", websocket.Handler(echoHandler))\n\thttp.Handle(\"/\", http.FileServer(http.Dir(\"./\")))\n\tif err := http.ListenAndServe(\":9999\", nil); err != nil {\n\t\tpanic(\"ListenAndServe: \" + err.Error())\n\t}\n\n}\n```\n\n```html:index.html\n\n<html>\n<head>\n\t<title>websocket sample</title>\n\t<script type=\"text/javascript\">\n\t// var wsUri = \"ws://echo.websocket.org/\"; \n\tvar wsUri = \"ws://localhost:9999/echo\"; \n\n\tvar output;  \n\tfunction init() { \n\t\toutput = document.getElementById(\"output\"); \n\t\ttestWebSocket(); \n\t} \n\t\t \n\tfunction testWebSocket() { \n\t\twebsocket = new WebSocket(wsUri); \n\t\twebsocket.onopen = function(evt) { \n\t\t\tonOpen(evt) \n\t\t}; \n\t\twebsocket.onclose = function(evt) { \n\t\t\tonClose(evt) \n\t\t}; \n\t\twebsocket.onmessage = function(evt) { \n\t\t\tonMessage(evt) \n\t\t}; \n\t\twebsocket.onerror = function(evt) { \n\t\t\tonError(evt) \n\t\t}; \n\t}  \n\n\tfunction onOpen(evt) { \n\t\twriteToScreen(\"CONNECTED\"); \n\t\tdoSend(\"websocket\u306b\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u9001\u4fe1\"); \n\t}  \n\n\tfunction onClose(evt) { \n\n\t\twriteToScreen(\"DISCONNECTED\"); \n\t}  \n\n\tfunction onMessage(evt) { \n\t\twriteToScreen('<span style=\"color: blue;\">RESPONSE: ' + jsonData.Msg+'</span>'); \n\t\twebsocket.close(); \n\t}  \n\n\tfunction onError(evt) { \n\t\twriteToScreen('<span style=\"color: red;\">ERROR:</span> ' + evt.data); \n\t}  \n\n\tfunction doSend(message) { \n\t\twebsocket.send(message); \n\t}  \n\n\tfunction writeToScreen(message) { \n\t\tvar pre = document.createElement(\"p\"); \n\t\tpre.style.wordWrap = \"break-word\"; \n\t\tpre.innerHTML = message; \n\t\toutput.appendChild(pre); \n\t}  \n\n\twindow.addEventListener(\"load\", init, false);\n\t</script>\n</head>\n<body>\n\t<h2>WebSocket Test</h2>  \n\t<div id=\"output\"></div>\n</body>\n</html>\n```\n\n\u30c7\u30d5\u30a9\u30eb\u30c8\u3067\u306f\u30af\u30ed\u30b9\u30c9\u30e1\u30a4\u30f3\u901a\u4fe1\u306f\u8a31\u53ef\u3055\u308c\u3066\u3044\u306a\u3044\u305f\u3081\u3001index.html\u3092\u30ed\u30fc\u30ab\u30eb\u306b\u304a\u3044\u3066\u8a66\u3059\u3068\u4ee5\u4e0b\u306e\u69d8\u306a\u30a8\u30e9\u30fc\u304c\u51fa\u307e\u3059\n\n``WebSocket connection to 'ws://localhost:9999/echo' failed: Unexpected response code: 403\n``\n\n\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u5909\u66f4\u3059\u308c\u3070\u30af\u30ed\u30b9\u30c9\u30e1\u30a4\u30f3\u901a\u4fe1\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\n\n```go:\u5909\u66f4\u7b87\u6240\nhttp.Handle(\"/echo\", websocket.Handler(echoHandler))\n```\n\n\u2193\n\n```go:\u5909\u66f4\u5185\u5bb9\nhttp.HandleFunc(\"/echo\",\n        func(w http.ResponseWriter, req *http.Request) {\n            s := websocket.Server{Handler: websocket.Handler(echoHandler)}\n            s.ServeHTTP(w, req)\n        })\n```\n\n\n\n#JSON\u3067\u901a\u4fe1\u3057\u305f\u3044\u5834\u5408\n\n```golang:main.go\n\npackage main\n\nimport (\n\t\"code.google.com/p/go.net/websocket\"\n\t\"log\"\n\t\"net/http\"\n)\n\nfunc echoHandler(ws *websocket.Conn) {\n\n\ttype T struct {\n\t\tMsg   string\n\t\tCount float64\n\t}\n\n\t// receive JSON type T\n\tvar data T\n\twebsocket.JSON.Receive(ws, &data)\n\n\tlog.Printf(\"data=%#v\\n\", data)\n\n\t// send JSON type T\n\twebsocket.JSON.Send(ws, data)\n}\n\nfunc main() {\n\n\thttp.Handle(\"/\", http.FileServer(http.Dir(\"./\")))\n\thttp.HandleFunc(\"/echo\",\n\t\tfunc(w http.ResponseWriter, req *http.Request) {\n\t\t\ts := websocket.Server{Handler: websocket.Handler(echoHandler)}\n\t\t\ts.ServeHTTP(w, req)\n\t\t})\n\n\tif err := http.ListenAndServe(\":9999\", nil); err != nil {\n\t\tpanic(\"ListenAndServe: \" + err.Error())\n\t}\n\n}\n\n```\n\n```html:index.html\n\n<html>\n<head>\n\t<title>websocket sample</title>\n\t<script type=\"text/javascript\">\n\t// var wsUri = \"ws://echo.websocket.org/\"; \n\tvar wsUri = \"ws://localhost:9999/echo\"; \n\n\tvar output;  \n\tfunction init() { \n\t\toutput = document.getElementById(\"output\"); \n\t\ttestWebSocket(); \n\t} \n\t\t \n\tfunction testWebSocket() { \n\t\twebsocket = new WebSocket(wsUri); \n\t\twebsocket.onopen = function(evt) { \n\t\t\tonOpen(evt) \n\t\t}; \n\t\twebsocket.onclose = function(evt) { \n\t\t\tonClose(evt) \n\t\t}; \n\t\twebsocket.onmessage = function(evt) { \n\t\t\tonMessage(evt) \n\t\t}; \n\t\twebsocket.onerror = function(evt) { \n\t\t\tonError(evt) \n\t\t}; \n\t}  \n\n\tfunction onOpen(evt) { \n\t\twriteToScreen(\"CONNECTED\"); \n\t\tdoSend(\"websocket\u306b\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u9001\u4fe1\",Math.random()); \n\t}  \n\n\tfunction onClose(evt) { \n\n\t\twriteToScreen(\"DISCONNECTED\"); \n\t}  \n\n\tfunction onMessage(evt) { \n\n\t\tvar jsonData=JSON.parse(evt.data)\n\n\t\twriteToScreen('<span style=\"color: blue;\">RESPONSE: ' + jsonData.Msg+\",no:\"+jsonData.Count+'</span>'); \n\t\twebsocket.close(); \n\t}  \n\n\n\tfunction onError(evt) { \n\t\twriteToScreen('<span style=\"color: red;\">ERROR:</span> ' + evt.data); \n\t}  \n\n\tfunction doSend(message,number) { \n\n\t\twriteToScreen(\"SENT: \" + message+\",no: \"+number);  \n\t\tvar jsonData={\n\t\t\tMsg:message,\n\t\t\tCount:number\n\t\t}\n\n\t\twebsocket.send(JSON.stringify(jsonData)); \n\t}  \n\n\tfunction writeToScreen(message) { \n\t\tvar pre = document.createElement(\"p\"); \n\t\tpre.style.wordWrap = \"break-word\"; \n\t\tpre.innerHTML = message; \n\t\toutput.appendChild(pre); \n\t}  \n\n\twindow.addEventListener(\"load\", init, false);\n\t</script>\n</head>\n<body>\n\n\t<h2>WebSocket Test</h2>  \n\t<div id=\"output\"></div>\n\n</body>\n</html>\n```\n\n\n#\u53c2\u8003\n\nhttps://github.com/golang-samples/websocket\nhttp://stackoverflow.com/questions/19708330/serving-a-websocket-in-go\n\n\n\n\n\n\n", "tags": ["golang", "Go", "websocket"]}