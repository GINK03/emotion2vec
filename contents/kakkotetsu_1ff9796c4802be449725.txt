{"tags": ["Network", "BGP"], "context": " More than 1 year has passed since last update.\n\n\u6982\u8981\n\n\u672c\u9805\u3067\u3084\u308b\u3053\u3068\n\n\nbagpipe-bgp \u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3066\u8efd\u304f\u52d5\u4f5c\u78ba\u8a8d\u3059\u308b\u3068\u3053\u308d\u307e\u3067\u3067\u3059\n\u4e00\u822c\u7684\u306b OpenStack Neutron \u3068\u7d44\u307f\u5408\u308f\u305b\u3066\u4f7f\u3046\u3088\u3046\u3067\u3059\u304c\u3001\u3053\u3053\u3067\u306f OpenStack \u306f\u767b\u5834\u3057\u307e\u305b\u3093\nOSS \u3067\u624b\u8efd\u306b EVPN \u3092\u8a66\u305b\u305d\u3046\u3001\u3068\u3044\u3046\u306e\u304c\u30e2\u30c1\u30d9\u30fc\u30b7\u30e7\u30f3\u3067\u3059\n\n\n\u74b0\u5883\u60c5\u5831\n\n\u74b0\u5883\u60c5\u5831\n$ uname -a\nLinux as65000-l1 3.19.0-25-generic #26~14.04.1-Ubuntu SMP Fri Jul 24 21:16:20 UTC 2015 x86_64 x86_64 x86_64 GNU/Linux\n\n$ cat /etc/lsb-release\nDISTRIB_ID=Ubuntu\nDISTRIB_RELEASE=14.04\nDISTRIB_CODENAME=trusty\nDISTRIB_DESCRIPTION=\"Ubuntu 14.04.3 LTS\"\n\n\n\n\u624b\u9806\n\nPython \u5404\u7a2e\u30d1\u30c3\u30b1\u30fc\u30b8\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n\n\u5fc5\u8981\u306a\u30d1\u30c3\u30b1\u30fc\u30b8\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n\nreauirements.txt \u3092\u53c2\u7167\n\n\nOS \u30d1\u30c3\u30b1\u30fc\u30b8\u3067\u5165\u308c\u308b\u4f8b\n\n\n$ sudo apt-get install python-daemon python-bottle python-netaddr python-pip\n\n\n\nbagpipe-bgp \u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n\n\u516c\u5f0f\u306e Installation \u306b\u5f93\u3046\n\n\n$ cd\n$ git clone https://github.com/Orange-OpenSource/bagpipe-bgp.git\n$ cd bagpipe-bgp/\n$ git show\ncommit 216fee45fba40663dfd9b48bb31be74f5513f684\nAuthor: Thomas Morin <thomas.morin@orange.com>\nDate:   Fri Aug 28 17:00:53 2015 +0200\n\n    devstack plugin fix\n\n    (dumb omission of \"then\" in a bash statement...)\n\n\n$ sudo python setup.py install\n\n$ ls -al /usr/local/bin/bagpipe-*\n-rwxr-xr-x 1 root root 175 Nov  8 01:28 /usr/local/bin/bagpipe-bgp\n-rwxr-xr-x 1 root root 177 Nov  8 01:28 /usr/local/bin/bagpipe-bgp-cleanup\n-rwxr-xr-x 1 root root 157 Nov  8 01:28 /usr/local/bin/bagpipe-fakerr\n-rwxr-xr-x 1 root root 168 Nov  8 01:28 /usr/local/bin/bagpipe-looking-glass\n-rwxr-xr-x 1 root root 166 Nov  8 01:28 /usr/local/bin/bagpipe-rest-attach\n\n$ bagpipe-bgp --help\nUsage: bagpipe-bgp [options] (see --help)\n\nOptions:\n  -h, --help            show this help message and exit\n  --config-file=CONFIGFILE\n                        Set BGP component configuration file path\n  --log-file=LOGFILE    Set logging configuration file path\n  --no-daemon           Do not daemonize\n\n\nbagpipe-bgp service \u767b\u9332(\uff5e\u81ea\u52d5\u8d77\u52d5\u8a2d\u5b9a)\n\n\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u51e6\u7406\u3092\u3057\u3066\u304f\u308c\u308b\u540c\u68b1\u30b7\u30a7\u30eb\u30b9\u30af\u30ea\u30d7\u30c8(install_bagpipe_bgp.sh)\u3092\u5b9f\u884c\n\n\ndaemon \u767b\u9332\n\u8d77\u52d5\n\n\n\u8981 root \u6a29\u9650\n\n$ cd bagpipe-bgp/\n\n$ ./install_bagpipe_bgp.sh\n*** WARNING: This script must be run as root ***\n\n$ sudo ./install_bagpipe_bgp.sh\n\n$ sudo service bagpipe-bgp status\nBGP component is running.\n\n\n\u81ea\u52d5\u8d77\u52d5\u3057\u305f\u3044\u5834\u5408\u306f\u3001\u30b5\u30f3\u30d7\u30eb\u304c\u540c\u68b1\u3055\u308c\u3066\u3044\u308b\u306e\u3067\u3001\u3053\u308c\u3092\u914d\u7f6e\u3059\u308c\u3070\u3088\u304b\u308d\u3046(\u3053\u3053\u3067\u306f\u672a\u5b9f\u65bd)\n\n$ ls -al bagpipe-bgp/etc/init.d/\ntotal 16\ndrwxrwxr-x 2 kotetsu kotetsu 4096 Nov  8 01:25 .\ndrwxrwxr-x 3 kotetsu kotetsu 4096 Nov  8 01:25 ..\n-rwxrwxr-x 1 kotetsu kotetsu 2518 Nov  8 01:25 bagpipe-bgp\n-rwxrwxr-x 1 kotetsu kotetsu 1545 Nov  8 01:25 bagpipe-fakerr\n\n\nbagpipe-bgp \u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u306e\u7de8\u96c6\n\n\u30e1\u30a4\u30f3\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb (/etc/bagpipe-bgp/bgp.conf)\n\n/etc/bagpipe-bgp/bgp.conf\n\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u74b0\u5883\u306b\u5408\u308f\u305b\u3066 [BGP] \u306e\u9805\u76ee\u3092\u7de8\u96c6\n\n\niBGP \u3057\u304b\u4f7f\u3048\u306a\u3044\u3053\u3068\u306b\u6ce8\u610f\n\n\n\n$ ls -al /etc/bagpipe-bgp/\ntotal 24\ndrwxr-xr-x  2 root root 4096 Nov  8 01:57 .\ndrwxr-xr-x 83 root root 4096 Nov  8 01:57 ..\n-rw-r--r--  1 root root 3099 Nov  8 01:57 bgp.conf\n-rw-rw-r--  1 root root 3099 Nov  8 01:25 bgp.conf.template\n-rw-r--r--  1 root root 1615 Nov  8 01:57 log.conf\n-rw-rw-r--  1 root root 1615 Nov  8 01:25 log.conf.template\n\n$ cat /etc/bagpipe-bgp/bgp.conf\n[BGP]\nlocal_address=10.0.1.2\npeers=10.0.1.1\nmy_as=65000\nenable_rtc=False\n\n(\u7565)\n\n\n$ diff /etc/bagpipe-bgp/bgp.conf /etc/bagpipe-bgp/bgp.conf.template\n2,5c2,5\n< local_address=10.0.1.2\n< peers=10.0.1.1\n< my_as=65000\n< enable_rtc=False\n---\n> local_address=192.168.100.177\n> peers=192.168.0.101\n> my_as=64512\n> enable_rtc=True\n\n\n\nlog \u51fa\u529b\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb (/etc/bagpipe-bgp/log.conf)\n\n/etc/bagpipe-bgp/log.conf\n\n[logger_engine] \u3060\u3051\u51fa\u529b\u30ec\u30d9\u30eb\u3092 WARNING \u304b\u3089 DEBUG \u306b\u5909\u66f4(\u69d8\u5b50\u3092\u89b3\u5bdf\u3059\u308b\u305f\u3081)\n\u30c7\u30d5\u30a9\u30eb\u30c8\u3067\u306f /var/log/bagpipe-bgp/bagpipe-bgp.log \u306b\u51fa\u529b\u3055\u308c\u308b\n\n$ cat /etc/bagpipe-bgp/log.conf\n\n(\u7565)\n\n[logger_engine]\nlevel=DEBUG\npropagate=0\nqualname=bagpipe.bgp.engine\nhandlers=rotatingFile\nparent=bgp\n\n(\u7565)\n\n$ diff /etc/bagpipe-bgp/log.conf /etc/bagpipe-bgp/log.conf.template\n25c25\n< level=DEBUG\n---\n> level=WARNING\n\n\n\nbagpipe-bgp \u8d77\u52d5\uff5e\u72b6\u614b\u78ba\u8a8d\n\u3053\u3053\u304b\u3089\u306e\u4f8b\u3067\u306f\u8d77\u52d5\u306e\u524d\u306b\u3001\u9069\u5f53\u306a iBGP neighbor \u3092\u7528\u610f\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\n\u8d77\u52d5\n\n\nservice \u3067\u666e\u901a\u306b\u6271\u3046\u3060\u3051\n\u8981 root \u6a29\u9650\n\n$ sudo service bagpipe-bgp start\nStarting BGP component...\n\n$ sudo service bagpipe-bgp restart\nRestarting BGP component... stopping.........starting\n\n$ sudo service bagpipe-bgp status\nBGP component is running.\n\n\n\u30ed\u30b0\u78ba\u8a8d\n\n\u30c7\u30d5\u30a9\u30eb\u30c8\u306e\u30ed\u30b0\u8a2d\u5b9a\u3067\u306f\u3055\u307b\u3069\u51fa\u529b\u3055\u308c\u306a\u3044\u304c\u3001\u524d\u8ff0\u306e\u901a\u308a [logger_engine] \u306e level \u3092 DEBUG \u306b\u5909\u3048\u305f\u306e\u3067\u3001\u3084\u305f\u3089\u51fa\u3066\u3044\u308b\n\n$ more /var/log/bagpipe-bgp/bagpipe-bgp.log\n2015-11-08 12:18:41,772 BGP-10.0.1.1                   bagpipe.bgp.engine.exabgp_peer_worker.10-0-1-1 INFO     Re-initiating\n2015-11-08 12:18:41,773 BGP-10.0.1.1                   bagpipe.bgp.engine.exabgp_peer_worker.10-0-1-1 INFO     Worker BGP-10.0.1.1 BGP FSM transitioned from 'OpenSent' to 'Idle' state\n2015-11-08 12:18:41,773 BGP-10.0.1.1                   bagpipe.bgp.engine.bgp_manager DEBUG    push cleanup event for worker BGP-10.0.1.1 to RouteTableManager\n2015-11-08 12:18:41,773 RouteTableManager              bagpipe.bgp.engine.route_table_manager DEBUG    RouteTableManager received event WorkerCleanupEvent:BGP-10.0.1.1\n2015-11-08 12:18:41,774 RouteTableManager              bagpipe.bgp.engine.route_table_manager INFO     Cleanup for worker BGP-10.0.1.1\n2015-11-08 12:18:41,774 RouteTableManager              bagpipe.bgp.engine.route_table_manager INFO     (we had no trace of Worker BGP-10.0.1.1 in _source2entries)\n2015-11-08 12:18:41,774 RouteTableManager              bagpipe.bgp.engine.route_table_manager DEBUG    RouteTableManager queue size: 0\n2015-11-08 12:18:41,774 RouteTableManager              bagpipe.bgp.engine.route_table_manager DEBUG    RouteTableManager waiting on queue\n2015-11-08 12:18:51,788 BGP-10.0.1.1                   bagpipe.bgp.engine.exabgp_peer_worker.10-0-1-1 INFO     Worker BGP-10.0.1.1 BGP FSM transitioned from 'Idle' to 'Connect' state\n2015-11-08 12:18:51,788 BGP-10.0.1.1                   bagpipe.bgp.engine.exabgp_peer_worker.10-0-1-1 DEBUG    Initiate ExaBGP connection to 10.0.1.1 from 10.0.1.2\n2015-11-08 12:18:51,790 BGP-10.0.1.1                   bagpipe.bgp.engine.exabgp_peer_worker.10-0-1-1 DEBUG    Instantiate ExaBGP Protocol\n2015-11-08 12:18:51,791 BGP-10.0.1.1                   bagpipe.bgp.engine.exabgp_peer_worker.10-0-1-1 DEBUG    Send open: [OPEN version=4 asn=65000 hold_time=180 router_id=10.0.1.2 capabilities=[Multiprotocol IPv4 mpls-vpn L2VPN evpn, 4Bytes AS 65000]]\n2015-11-08 12:18:51,792 BGP-10.0.1.1                   bagpipe.bgp.engine.exabgp_peer_worker.10-0-1-1 INFO     Worker BGP-10.0.1.1 BGP FSM transitioned from 'Connect' to 'OpenSent' state\n2015-11-08 12:18:51,792 BGP-10.0.1.1                   bagpipe.bgp.engine.exabgp_peer_worker.10-0-1-1 DEBUG    Wait for open...\n2015-11-08 12:18:51,793 BGP-10.0.1.1                   bagpipe.bgp.engine.exabgp_peer_worker.10-0-1-1 DEBUG    Read message: OPEN version=4 asn=65000 hold_time=90 router_id=192.168.101.170 capabilities=[Multiprotocol L2VPN evpn, Route Refresh, 4Bytes AS 65000]\n2015-11-08 12:18:51,793 BGP-10.0.1.1                   bagpipe.bgp.engine.exabgp_peer_worker.10-0-1-1 INFO     changing thread name from BGP-10.0.1.1 to BGP-x192.168.101.170, based on the router-id advertized in Open (different from peerAddress == 10.0.1.1)\n2015-11-08 12:18:51,793 BGP-10.0.1.1/192.168.101.170   bagpipe.bgp.engine.exabgp_peer_worker.10-0-1-1 WARNING  Peer does not advertise (IPv4,mpls-vpn) capability\n2015-11-08 12:18:51,794 BGP-10.0.1.1/192.168.101.170   bagpipe.bgp.engine.exabgp_peer_worker.10-0-1-1 INFO     Family (L2VPN,evpn) successfully negotiated with peer 10.0.1.1\n2015-11-08 12:18:51,795 BGP-10.0.1.1/192.168.101.170   bagpipe.bgp.engine.exabgp_peer_worker.10-0-1-1 WARNING  Peer does not advertise (IPv4,rtc) capability\n2015-11-08 12:18:51,795 BGP-10.0.1.1/192.168.101.170   bagpipe.bgp.engine.exabgp_peer_worker.10-0-1-1 INFO     Worker BGP-10.0.1.1/192.168.101.170 BGP FSM transitioned from 'OpenSent' to 'OpenConfirm' state\n2015-11-08 12:18:51,795 BGP-10.0.1.1/192.168.101.170   bagpipe.bgp.engine.exabgp_peer_worker.10-0-1-1 DEBUG    Init sendKA timer (30s)\n2015-11-08 12:18:51,796 BGP-10.0.1.1/192.168.101.170   bagpipe.bgp.engine.exabgp_peer_worker.10-0-1-1 DEBUG    Init Keepalive reception timer (90s)\n2015-11-08 12:18:51,797 BGP-10.0.1.1/192.168.101.170   bagpipe.bgp.engine.exabgp_peer_worker.10-0-1-1 DEBUG    Sending 19 bytes on socket to peer 10.0.1.1\n2015-11-08 12:18:51,797 BGP-10.0.1.1/192.168.101.170:receiveLoop bagpipe.bgp.engine.exabgp_peer_worker.10-0-1-1 INFO     Start receive loop\n2015-11-08 12:18:51,798 BGP-10.0.1.1/192.168.101.170:receiveLoop bagpipe.bgp.engine.exabgp_peer_worker.10-0-1-1 INFO     Worker BGP-10.0.1.1/192.168.101.170 BGP FSM transitioned from 'OpenConfirm' to 'Established' state\n2015-11-08 12:18:51,798 BGP-10.0.1.1/192.168.101.170:receiveLoop bagpipe.bgp.engine.worker      INFO     Subscribe: Subscription [L2VPN/evpn,*] by BGP-10.0.1.1/192.168.101.170\n2015-11-08 12:18:51,799 BGP-10.0.1.1/192.168.101.170:receiveLoop bagpipe.bgp.engine.bgp_manager DEBUG    bagpipe.bgp.engine.bgp_manager.Manager method _routeEventSubscribe called with arguments (Subscription [L2VPN/evpn,*] by BGP-10.0.1.1/192.168.101.170,) {}\n2015-11-08 12:18:51,799 RouteTableManager              bagpipe.bgp.engine.route_table_manager DEBUG    RouteTableManager received event Subscription [L2VPN/evpn,*] by BGP-10.0.1.1/192.168.101.170\n2015-11-08 12:18:51,799 RouteTableManager              bagpipe.bgp.engine.route_table_manager INFO     workerSubscribes: Subscription [L2VPN/evpn,*] by BGP-10.0.1.1/192.168.101.170\n2015-11-08 12:18:51,800 RouteTableManager              bagpipe.bgp.engine.route_table_manager DEBUG    RouteTableManager queue size: 0\n2015-11-08 12:18:51,800 RouteTableManager              bagpipe.bgp.engine.route_table_manager DEBUG    RouteTableManager waiting on queue\n2015-11-08 12:18:51,800 BGP-10.0.1.1/192.168.101.170   bagpipe.bgp.engine.exabgp_peer_worker.10-0-1-1 DEBUG    Keepalive received\n2015-11-08 12:18:51,801 BGP-10.0.1.1/192.168.101.170   bagpipe.bgp.engine.exabgp_peer_worker.10-0-1-1 DEBUG    Init Keepalive reception timer (90s)\n2015-11-08 12:18:51,800 BGP-10.0.1.1/192.168.101.170:receiveLoop bagpipe.bgp.engine.exabgp_peer_worker.10-0-1-1 DEBUG    Received message: KEEPALIVE\n2015-11-08 12:19:21,797 BGP-10.0.1.1/192.168.101.170:sendKATimer bagpipe.bgp.engine.exabgp_peer_worker.10-0-1-1 DEBUG    Trigger send KeepAlive\n2015-11-08 12:19:21,798 BGP-10.0.1.1/192.168.101.170   bagpipe.bgp.engine.exabgp_peer_worker.10-0-1-1 DEBUG    Sending 19 bytes on socket to peer 10.0.1.1\n2015-11-08 12:19:21,798 BGP-10.0.1.1/192.168.101.170:sendKATimer bagpipe.bgp.engine.exabgp_peer_worker.10-0-1-1 DEBUG    Init sendKA timer (30s)\n2015-11-08 12:19:21,800 BGP-10.0.1.1/192.168.101.170:receiveLoop bagpipe.bgp.engine.exabgp_peer_worker.10-0-1-1 DEBUG    Received message: KEEPALIVE\n2015-11-08 12:19:21,800 BGP-10.0.1.1/192.168.101.170   bagpipe.bgp.engine.exabgp_peer_worker.10-0-1-1 DEBUG    Keepalive received\n2015-11-08 12:19:21,800 BGP-10.0.1.1/192.168.101.170   bagpipe.bgp.engine.exabgp_peer_worker.10-0-1-1 DEBUG    Init Keepalive reception timer (90s)\n\n\n\u72b6\u614b\u78ba\u8a8d(bagpipe-looking-glass)\n\n\u72b6\u614b\u78ba\u8a8d\u306f bagpipe-looking-glass \u3067\u53ef\u80fd\n\u4f7f\u3044\u65b9\n\u30b3\u30de\u30f3\u30c9\u30e9\u30a4\u30f3\u3067\u5b9f\u884c\u3057\u305f\u4f8b\n\n\n$ bagpipe-looking-glass bgp peers 10.0.1.1\nprotocol:\n  state: Established\n  hold_time: 90\n  last_transition_time: 2015-11-08 12:18:51\n  previous_state: (OpenConfirm)\nname: BGP-10.0.1.1/192.168.101.170\nrtc:\n  active: False\n  enabled: False\nas_info:\n  peer: 65000\n  local: 65000\ninternals:\n  event queue length: 0\n  subscriptions:\n    * match:L2VPN/evpn,*\npeeringAddresses:\n  peerAddress: 10.0.1.1\n  localAddress: 10.0.1.2\nroutes:  (...)\nactive_families:\n  * (L2VPN, evpn)\nlogs:  (...)\n\n\n\nbagpipe \u306f Openstack Neutron components\u3000\u3042\u305f\u308a\u3068\u306e\u9023\u643a\u3057\u3066\u4f7f\u3046\u306e\u304c\u4e00\u822c\u7684\u306e\u3088\u3046\u3067 RESTAPI \u5236\u5fa1\u3082\u53ef\u80fd\n\n\nbagpipe-bgp \u306e Typical Use\n\n\n\u9069\u5f53\u306b\u5225\u306e\u30ce\u30fc\u30c9\u304b\u3089\u7a81\u3044\u305f\u4e00\u4f8b\n\n\n$ curl -s http://192.168.101.171:8082/looking-glass/bgp/peers/10.0.1.1 | python -m json.tool\n{\n    \"active_families\": [\n        \"(L2VPN, evpn)\"\n    ],\n    \"as_info\": {\n        \"local\": 65000,\n        \"peer\": 65000\n    },\n    \"internals\": {\n        \"event queue length\": 0,\n        \"subscriptions\": [\n            \"match:L2VPN/evpn,*\"\n        ]\n    },\n    \"logs\": {\n        \"href\": \"http://192.168.101.171:8082/looking-glass/bgp/peers/10.0.1.1/logs\"\n    },\n    \"name\": \"BGP-10.0.1.1/192.168.101.170\",\n    \"peeringAddresses\": {\n        \"localAddress\": \"10.0.1.2\",\n        \"peerAddress\": \"10.0.1.1\"\n    },\n    \"protocol\": {\n        \"hold_time\": 90,\n        \"last_transition_time\": \"2015-11-08 12:18:51\",\n        \"previous_state\": \"(OpenConfirm)\",\n        \"state\": \"Established\"\n    },\n    \"routes\": {\n        \"href\": \"http://192.168.101.171:8082/looking-glass/bgp/peers/10.0.1.1/routes\"\n    },\n    \"rtc\": {\n        \"active\": false,\n        \"enabled\": false\n    }\n}\n\n\n\n\u304a\u308f\u308a\n\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u305f\u3060\u3051\u306a\u306e\u3067\u3001\u7279\u306b\u2026\n\n\n# \u6982\u8981\n\n## \u672c\u9805\u3067\u3084\u308b\u3053\u3068\n\n- [bagpipe-bgp](https://github.com/Orange-OpenSource/bagpipe-bgp) \u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3066\u8efd\u304f\u52d5\u4f5c\u78ba\u8a8d\u3059\u308b\u3068\u3053\u308d\u307e\u3067\u3067\u3059\n- \u4e00\u822c\u7684\u306b OpenStack Neutron \u3068\u7d44\u307f\u5408\u308f\u305b\u3066\u4f7f\u3046\u3088\u3046\u3067\u3059\u304c\u3001\u3053\u3053\u3067\u306f OpenStack \u306f\u767b\u5834\u3057\u307e\u305b\u3093\n- OSS \u3067\u624b\u8efd\u306b EVPN \u3092\u8a66\u305b\u305d\u3046\u3001\u3068\u3044\u3046\u306e\u304c\u30e2\u30c1\u30d9\u30fc\u30b7\u30e7\u30f3\u3067\u3059\n\n## \u74b0\u5883\u60c5\u5831\n\n```bash:\u74b0\u5883\u60c5\u5831\n$ uname -a\nLinux as65000-l1 3.19.0-25-generic #26~14.04.1-Ubuntu SMP Fri Jul 24 21:16:20 UTC 2015 x86_64 x86_64 x86_64 GNU/Linux\n\n$ cat /etc/lsb-release\nDISTRIB_ID=Ubuntu\nDISTRIB_RELEASE=14.04\nDISTRIB_CODENAME=trusty\nDISTRIB_DESCRIPTION=\"Ubuntu 14.04.3 LTS\"\n```\n\n# \u624b\u9806\n\n## Python \u5404\u7a2e\u30d1\u30c3\u30b1\u30fc\u30b8\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n- \u5fc5\u8981\u306a\u30d1\u30c3\u30b1\u30fc\u30b8\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n    - [reauirements.txt](https://github.com/Orange-OpenSource/bagpipe-bgp/blob/master/requirements.txt) \u3092\u53c2\u7167\n\n- OS \u30d1\u30c3\u30b1\u30fc\u30b8\u3067\u5165\u308c\u308b\u4f8b\n\n```bash\n\n$ sudo apt-get install python-daemon python-bottle python-netaddr python-pip\n\n```\n\n\n## bagpipe-bgp \u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n- [\u516c\u5f0f\u306e Installation](https://github.com/Orange-OpenSource/bagpipe-bgp#installation) \u306b\u5f93\u3046\n\n```bash\n\n$ cd\n$ git clone https://github.com/Orange-OpenSource/bagpipe-bgp.git\n$ cd bagpipe-bgp/\n$ git show\ncommit 216fee45fba40663dfd9b48bb31be74f5513f684\nAuthor: Thomas Morin <thomas.morin@orange.com>\nDate:   Fri Aug 28 17:00:53 2015 +0200\n\n    devstack plugin fix\n\n    (dumb omission of \"then\" in a bash statement...)\n\n\n$ sudo python setup.py install\n\n$ ls -al /usr/local/bin/bagpipe-*\n-rwxr-xr-x 1 root root 175 Nov  8 01:28 /usr/local/bin/bagpipe-bgp\n-rwxr-xr-x 1 root root 177 Nov  8 01:28 /usr/local/bin/bagpipe-bgp-cleanup\n-rwxr-xr-x 1 root root 157 Nov  8 01:28 /usr/local/bin/bagpipe-fakerr\n-rwxr-xr-x 1 root root 168 Nov  8 01:28 /usr/local/bin/bagpipe-looking-glass\n-rwxr-xr-x 1 root root 166 Nov  8 01:28 /usr/local/bin/bagpipe-rest-attach\n\n$ bagpipe-bgp --help\nUsage: bagpipe-bgp [options] (see --help)\n\nOptions:\n  -h, --help            show this help message and exit\n  --config-file=CONFIGFILE\n                        Set BGP component configuration file path\n  --log-file=LOGFILE    Set logging configuration file path\n  --no-daemon           Do not daemonize\n```\n\n\n## bagpipe-bgp service \u767b\u9332(\uff5e\u81ea\u52d5\u8d77\u52d5\u8a2d\u5b9a)\n\n- \u4ee5\u4e0b\u306e\u3088\u3046\u306a\u51e6\u7406\u3092\u3057\u3066\u304f\u308c\u308b\u540c\u68b1\u30b7\u30a7\u30eb\u30b9\u30af\u30ea\u30d7\u30c8(`install_bagpipe_bgp.sh`)\u3092\u5b9f\u884c\n    - daemon \u767b\u9332\n    - \u8d77\u52d5\n- \u8981 root \u6a29\u9650\n\n```bash\n$ cd bagpipe-bgp/\n\n$ ./install_bagpipe_bgp.sh\n*** WARNING: This script must be run as root ***\n\n$ sudo ./install_bagpipe_bgp.sh\n\n$ sudo service bagpipe-bgp status\nBGP component is running.\n```\n\n- \u81ea\u52d5\u8d77\u52d5\u3057\u305f\u3044\u5834\u5408\u306f\u3001\u30b5\u30f3\u30d7\u30eb\u304c\u540c\u68b1\u3055\u308c\u3066\u3044\u308b\u306e\u3067\u3001\u3053\u308c\u3092\u914d\u7f6e\u3059\u308c\u3070\u3088\u304b\u308d\u3046(\u3053\u3053\u3067\u306f\u672a\u5b9f\u65bd)\n\n```bash\n$ ls -al bagpipe-bgp/etc/init.d/\ntotal 16\ndrwxrwxr-x 2 kotetsu kotetsu 4096 Nov  8 01:25 .\ndrwxrwxr-x 3 kotetsu kotetsu 4096 Nov  8 01:25 ..\n-rwxrwxr-x 1 kotetsu kotetsu 2518 Nov  8 01:25 bagpipe-bgp\n-rwxrwxr-x 1 kotetsu kotetsu 1545 Nov  8 01:25 bagpipe-fakerr\n```\n\n\n##  bagpipe-bgp \u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u306e\u7de8\u96c6\n\n### \u30e1\u30a4\u30f3\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb (/etc/bagpipe-bgp/bgp.conf)\n\n- `/etc/bagpipe-bgp/bgp.conf`\n- \u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u74b0\u5883\u306b\u5408\u308f\u305b\u3066 `[BGP]` \u306e\u9805\u76ee\u3092\u7de8\u96c6\n    - iBGP \u3057\u304b\u4f7f\u3048\u306a\u3044\u3053\u3068\u306b\u6ce8\u610f\n\n```bash\n$ ls -al /etc/bagpipe-bgp/\ntotal 24\ndrwxr-xr-x  2 root root 4096 Nov  8 01:57 .\ndrwxr-xr-x 83 root root 4096 Nov  8 01:57 ..\n-rw-r--r--  1 root root 3099 Nov  8 01:57 bgp.conf\n-rw-rw-r--  1 root root 3099 Nov  8 01:25 bgp.conf.template\n-rw-r--r--  1 root root 1615 Nov  8 01:57 log.conf\n-rw-rw-r--  1 root root 1615 Nov  8 01:25 log.conf.template\n\n$ cat /etc/bagpipe-bgp/bgp.conf\n[BGP]\nlocal_address=10.0.1.2\npeers=10.0.1.1\nmy_as=65000\nenable_rtc=False\n\n(\u7565)\n\n\n$ diff /etc/bagpipe-bgp/bgp.conf /etc/bagpipe-bgp/bgp.conf.template\n2,5c2,5\n< local_address=10.0.1.2\n< peers=10.0.1.1\n< my_as=65000\n< enable_rtc=False\n---\n> local_address=192.168.100.177\n> peers=192.168.0.101\n> my_as=64512\n> enable_rtc=True\n\n```\n\n### log \u51fa\u529b\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb (/etc/bagpipe-bgp/log.conf)\n\n- `/etc/bagpipe-bgp/log.conf`\n- `[logger_engine]` \u3060\u3051\u51fa\u529b\u30ec\u30d9\u30eb\u3092 WARNING \u304b\u3089 `DEBUG` \u306b\u5909\u66f4(\u69d8\u5b50\u3092\u89b3\u5bdf\u3059\u308b\u305f\u3081)\n- \u30c7\u30d5\u30a9\u30eb\u30c8\u3067\u306f `/var/log/bagpipe-bgp/bagpipe-bgp.log` \u306b\u51fa\u529b\u3055\u308c\u308b\n\n```bash\n$ cat /etc/bagpipe-bgp/log.conf\n\n(\u7565)\n\n[logger_engine]\nlevel=DEBUG\npropagate=0\nqualname=bagpipe.bgp.engine\nhandlers=rotatingFile\nparent=bgp\n\n(\u7565)\n\n$ diff /etc/bagpipe-bgp/log.conf /etc/bagpipe-bgp/log.conf.template\n25c25\n< level=DEBUG\n---\n> level=WARNING\n\n```\n\n\n## bagpipe-bgp \u8d77\u52d5\uff5e\u72b6\u614b\u78ba\u8a8d\n\n\u3053\u3053\u304b\u3089\u306e\u4f8b\u3067\u306f\u8d77\u52d5\u306e\u524d\u306b\u3001\u9069\u5f53\u306a iBGP neighbor \u3092\u7528\u610f\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\n### \u8d77\u52d5\n\n- `service` \u3067\u666e\u901a\u306b\u6271\u3046\u3060\u3051\n- \u8981 root \u6a29\u9650\n\n```bash\n$ sudo service bagpipe-bgp start\nStarting BGP component...\n\n$ sudo service bagpipe-bgp restart\nRestarting BGP component... stopping.........starting\n\n$ sudo service bagpipe-bgp status\nBGP component is running.\n```\n\n### \u30ed\u30b0\u78ba\u8a8d\n\n- \u30c7\u30d5\u30a9\u30eb\u30c8\u306e\u30ed\u30b0\u8a2d\u5b9a\u3067\u306f\u3055\u307b\u3069\u51fa\u529b\u3055\u308c\u306a\u3044\u304c\u3001\u524d\u8ff0\u306e\u901a\u308a `[logger_engine]` \u306e level \u3092 DEBUG \u306b\u5909\u3048\u305f\u306e\u3067\u3001\u3084\u305f\u3089\u51fa\u3066\u3044\u308b\n\n```bash\n$ more /var/log/bagpipe-bgp/bagpipe-bgp.log\n2015-11-08 12:18:41,772 BGP-10.0.1.1                   bagpipe.bgp.engine.exabgp_peer_worker.10-0-1-1 INFO     Re-initiating\n2015-11-08 12:18:41,773 BGP-10.0.1.1                   bagpipe.bgp.engine.exabgp_peer_worker.10-0-1-1 INFO     Worker BGP-10.0.1.1 BGP FSM transitioned from 'OpenSent' to 'Idle' state\n2015-11-08 12:18:41,773 BGP-10.0.1.1                   bagpipe.bgp.engine.bgp_manager DEBUG    push cleanup event for worker BGP-10.0.1.1 to RouteTableManager\n2015-11-08 12:18:41,773 RouteTableManager              bagpipe.bgp.engine.route_table_manager DEBUG    RouteTableManager received event WorkerCleanupEvent:BGP-10.0.1.1\n2015-11-08 12:18:41,774 RouteTableManager              bagpipe.bgp.engine.route_table_manager INFO     Cleanup for worker BGP-10.0.1.1\n2015-11-08 12:18:41,774 RouteTableManager              bagpipe.bgp.engine.route_table_manager INFO     (we had no trace of Worker BGP-10.0.1.1 in _source2entries)\n2015-11-08 12:18:41,774 RouteTableManager              bagpipe.bgp.engine.route_table_manager DEBUG    RouteTableManager queue size: 0\n2015-11-08 12:18:41,774 RouteTableManager              bagpipe.bgp.engine.route_table_manager DEBUG    RouteTableManager waiting on queue\n2015-11-08 12:18:51,788 BGP-10.0.1.1                   bagpipe.bgp.engine.exabgp_peer_worker.10-0-1-1 INFO     Worker BGP-10.0.1.1 BGP FSM transitioned from 'Idle' to 'Connect' state\n2015-11-08 12:18:51,788 BGP-10.0.1.1                   bagpipe.bgp.engine.exabgp_peer_worker.10-0-1-1 DEBUG    Initiate ExaBGP connection to 10.0.1.1 from 10.0.1.2\n2015-11-08 12:18:51,790 BGP-10.0.1.1                   bagpipe.bgp.engine.exabgp_peer_worker.10-0-1-1 DEBUG    Instantiate ExaBGP Protocol\n2015-11-08 12:18:51,791 BGP-10.0.1.1                   bagpipe.bgp.engine.exabgp_peer_worker.10-0-1-1 DEBUG    Send open: [OPEN version=4 asn=65000 hold_time=180 router_id=10.0.1.2 capabilities=[Multiprotocol IPv4 mpls-vpn L2VPN evpn, 4Bytes AS 65000]]\n2015-11-08 12:18:51,792 BGP-10.0.1.1                   bagpipe.bgp.engine.exabgp_peer_worker.10-0-1-1 INFO     Worker BGP-10.0.1.1 BGP FSM transitioned from 'Connect' to 'OpenSent' state\n2015-11-08 12:18:51,792 BGP-10.0.1.1                   bagpipe.bgp.engine.exabgp_peer_worker.10-0-1-1 DEBUG    Wait for open...\n2015-11-08 12:18:51,793 BGP-10.0.1.1                   bagpipe.bgp.engine.exabgp_peer_worker.10-0-1-1 DEBUG    Read message: OPEN version=4 asn=65000 hold_time=90 router_id=192.168.101.170 capabilities=[Multiprotocol L2VPN evpn, Route Refresh, 4Bytes AS 65000]\n2015-11-08 12:18:51,793 BGP-10.0.1.1                   bagpipe.bgp.engine.exabgp_peer_worker.10-0-1-1 INFO     changing thread name from BGP-10.0.1.1 to BGP-x192.168.101.170, based on the router-id advertized in Open (different from peerAddress == 10.0.1.1)\n2015-11-08 12:18:51,793 BGP-10.0.1.1/192.168.101.170   bagpipe.bgp.engine.exabgp_peer_worker.10-0-1-1 WARNING  Peer does not advertise (IPv4,mpls-vpn) capability\n2015-11-08 12:18:51,794 BGP-10.0.1.1/192.168.101.170   bagpipe.bgp.engine.exabgp_peer_worker.10-0-1-1 INFO     Family (L2VPN,evpn) successfully negotiated with peer 10.0.1.1\n2015-11-08 12:18:51,795 BGP-10.0.1.1/192.168.101.170   bagpipe.bgp.engine.exabgp_peer_worker.10-0-1-1 WARNING  Peer does not advertise (IPv4,rtc) capability\n2015-11-08 12:18:51,795 BGP-10.0.1.1/192.168.101.170   bagpipe.bgp.engine.exabgp_peer_worker.10-0-1-1 INFO     Worker BGP-10.0.1.1/192.168.101.170 BGP FSM transitioned from 'OpenSent' to 'OpenConfirm' state\n2015-11-08 12:18:51,795 BGP-10.0.1.1/192.168.101.170   bagpipe.bgp.engine.exabgp_peer_worker.10-0-1-1 DEBUG    Init sendKA timer (30s)\n2015-11-08 12:18:51,796 BGP-10.0.1.1/192.168.101.170   bagpipe.bgp.engine.exabgp_peer_worker.10-0-1-1 DEBUG    Init Keepalive reception timer (90s)\n2015-11-08 12:18:51,797 BGP-10.0.1.1/192.168.101.170   bagpipe.bgp.engine.exabgp_peer_worker.10-0-1-1 DEBUG    Sending 19 bytes on socket to peer 10.0.1.1\n2015-11-08 12:18:51,797 BGP-10.0.1.1/192.168.101.170:receiveLoop bagpipe.bgp.engine.exabgp_peer_worker.10-0-1-1 INFO     Start receive loop\n2015-11-08 12:18:51,798 BGP-10.0.1.1/192.168.101.170:receiveLoop bagpipe.bgp.engine.exabgp_peer_worker.10-0-1-1 INFO     Worker BGP-10.0.1.1/192.168.101.170 BGP FSM transitioned from 'OpenConfirm' to 'Established' state\n2015-11-08 12:18:51,798 BGP-10.0.1.1/192.168.101.170:receiveLoop bagpipe.bgp.engine.worker      INFO     Subscribe: Subscription [L2VPN/evpn,*] by BGP-10.0.1.1/192.168.101.170\n2015-11-08 12:18:51,799 BGP-10.0.1.1/192.168.101.170:receiveLoop bagpipe.bgp.engine.bgp_manager DEBUG    bagpipe.bgp.engine.bgp_manager.Manager method _routeEventSubscribe called with arguments (Subscription [L2VPN/evpn,*] by BGP-10.0.1.1/192.168.101.170,) {}\n2015-11-08 12:18:51,799 RouteTableManager              bagpipe.bgp.engine.route_table_manager DEBUG    RouteTableManager received event Subscription [L2VPN/evpn,*] by BGP-10.0.1.1/192.168.101.170\n2015-11-08 12:18:51,799 RouteTableManager              bagpipe.bgp.engine.route_table_manager INFO     workerSubscribes: Subscription [L2VPN/evpn,*] by BGP-10.0.1.1/192.168.101.170\n2015-11-08 12:18:51,800 RouteTableManager              bagpipe.bgp.engine.route_table_manager DEBUG    RouteTableManager queue size: 0\n2015-11-08 12:18:51,800 RouteTableManager              bagpipe.bgp.engine.route_table_manager DEBUG    RouteTableManager waiting on queue\n2015-11-08 12:18:51,800 BGP-10.0.1.1/192.168.101.170   bagpipe.bgp.engine.exabgp_peer_worker.10-0-1-1 DEBUG    Keepalive received\n2015-11-08 12:18:51,801 BGP-10.0.1.1/192.168.101.170   bagpipe.bgp.engine.exabgp_peer_worker.10-0-1-1 DEBUG    Init Keepalive reception timer (90s)\n2015-11-08 12:18:51,800 BGP-10.0.1.1/192.168.101.170:receiveLoop bagpipe.bgp.engine.exabgp_peer_worker.10-0-1-1 DEBUG    Received message: KEEPALIVE\n2015-11-08 12:19:21,797 BGP-10.0.1.1/192.168.101.170:sendKATimer bagpipe.bgp.engine.exabgp_peer_worker.10-0-1-1 DEBUG    Trigger send KeepAlive\n2015-11-08 12:19:21,798 BGP-10.0.1.1/192.168.101.170   bagpipe.bgp.engine.exabgp_peer_worker.10-0-1-1 DEBUG    Sending 19 bytes on socket to peer 10.0.1.1\n2015-11-08 12:19:21,798 BGP-10.0.1.1/192.168.101.170:sendKATimer bagpipe.bgp.engine.exabgp_peer_worker.10-0-1-1 DEBUG    Init sendKA timer (30s)\n2015-11-08 12:19:21,800 BGP-10.0.1.1/192.168.101.170:receiveLoop bagpipe.bgp.engine.exabgp_peer_worker.10-0-1-1 DEBUG    Received message: KEEPALIVE\n2015-11-08 12:19:21,800 BGP-10.0.1.1/192.168.101.170   bagpipe.bgp.engine.exabgp_peer_worker.10-0-1-1 DEBUG    Keepalive received\n2015-11-08 12:19:21,800 BGP-10.0.1.1/192.168.101.170   bagpipe.bgp.engine.exabgp_peer_worker.10-0-1-1 DEBUG    Init Keepalive reception timer (90s)\n```\n\n\n### \u72b6\u614b\u78ba\u8a8d(bagpipe-looking-glass)\n\n- \u72b6\u614b\u78ba\u8a8d\u306f `bagpipe-looking-glass` \u3067\u53ef\u80fd\n- [\u4f7f\u3044\u65b9](https://github.com/Orange-OpenSource/bagpipe-bgp#looking-glass)\n- \u30b3\u30de\u30f3\u30c9\u30e9\u30a4\u30f3\u3067\u5b9f\u884c\u3057\u305f\u4f8b\n\n```bash\n\n$ bagpipe-looking-glass bgp peers 10.0.1.1\nprotocol:\n  state: Established\n  hold_time: 90\n  last_transition_time: 2015-11-08 12:18:51\n  previous_state: (OpenConfirm)\nname: BGP-10.0.1.1/192.168.101.170\nrtc:\n  active: False\n  enabled: False\nas_info:\n  peer: 65000\n  local: 65000\ninternals:\n  event queue length: 0\n  subscriptions:\n    * match:L2VPN/evpn,*\npeeringAddresses:\n  peerAddress: 10.0.1.1\n  localAddress: 10.0.1.2\nroutes:  (...)\nactive_families:\n  * (L2VPN, evpn)\nlogs:  (...)\n\n```\n\n- bagpipe \u306f Openstack Neutron components\u3000\u3042\u305f\u308a\u3068\u306e\u9023\u643a\u3057\u3066\u4f7f\u3046\u306e\u304c\u4e00\u822c\u7684\u306e\u3088\u3046\u3067 RESTAPI \u5236\u5fa1\u3082\u53ef\u80fd\n    - [bagpipe-bgp \u306e Typical Use](https://github.com/Orange-OpenSource/bagpipe-bgp/blob/master/README.md#typical-use)\n- \u9069\u5f53\u306b\u5225\u306e\u30ce\u30fc\u30c9\u304b\u3089\u7a81\u3044\u305f\u4e00\u4f8b\n\n```bash\n\n$ curl -s http://192.168.101.171:8082/looking-glass/bgp/peers/10.0.1.1 | python -m json.tool\n{\n    \"active_families\": [\n        \"(L2VPN, evpn)\"\n    ],\n    \"as_info\": {\n        \"local\": 65000,\n        \"peer\": 65000\n    },\n    \"internals\": {\n        \"event queue length\": 0,\n        \"subscriptions\": [\n            \"match:L2VPN/evpn,*\"\n        ]\n    },\n    \"logs\": {\n        \"href\": \"http://192.168.101.171:8082/looking-glass/bgp/peers/10.0.1.1/logs\"\n    },\n    \"name\": \"BGP-10.0.1.1/192.168.101.170\",\n    \"peeringAddresses\": {\n        \"localAddress\": \"10.0.1.2\",\n        \"peerAddress\": \"10.0.1.1\"\n    },\n    \"protocol\": {\n        \"hold_time\": 90,\n        \"last_transition_time\": \"2015-11-08 12:18:51\",\n        \"previous_state\": \"(OpenConfirm)\",\n        \"state\": \"Established\"\n    },\n    \"routes\": {\n        \"href\": \"http://192.168.101.171:8082/looking-glass/bgp/peers/10.0.1.1/routes\"\n    },\n    \"rtc\": {\n        \"active\": false,\n        \"enabled\": false\n    }\n}\n\n```\n\n# \u304a\u308f\u308a\n- \u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u305f\u3060\u3051\u306a\u306e\u3067\u3001\u7279\u306b\u2026\n"}