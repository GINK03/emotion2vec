{"tags": ["docker1.12", "Netatalk", "Ubuntu14.04", "MacOSX", "timemachine"], "context": "\n\nnetatalk \u3092 docker \u30b3\u30f3\u30c6\u30ca\u5316\u3057\u3066 TimeMachine \u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u5148\u306b\u3057\u3066\u307f\u305f\n\n\u76ee\u7684\n\nmacOS Sierra \u306b\u3057\u3066\u304b\u3089 netatalk \u3054\u3057\u306e TimeMachine \u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u304c\u53d6\u308c\u3066\u306a\u3044\u3088\u3046\u306a\u611f\u3058\u2026\n\n\n\u6b63\u78ba\u306b\u66f8\u304f\u3068\u3001\u6700\u521d\u306e FullBackup \u306f\u53d6\u308c\u308b\u304c\u3001\u305d\u306e\u5f8c\u306e \u5dee\u5206\u30d0\u30c3\u30af\u30a2\u30c3\u30d7 \u304c\u53d6\u308c\u306a\u3044\n\n\n\u73fe\u5728 Host OS \u306f Ubuntu14.04 \u3061\u3087\u3063\u3068\u53e4\u3044\u304c\u3059\u3050\u306b Host \u4e0a\u306e netatalk \u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u30a2\u30c3\u30d7\u306f\u3057\u3065\u3089\u3044\ndocker \u3067\u6700\u65b0\u30d0\u30fc\u30b8\u30e7\u30f3\u306b\u3057\u3066\u8a66\u3057\u3066\u307f\u3088\u3046(\u5207\u308a\u5206\u3051)\n\n\nnetatalk \u3068\u306f\n\n\u7c21\u5358\u306b\u8a00\u3046\u3068 Unix\u30de\u30b7\u30f3(Linux\u306a\u3069) \u3092 TimeMachine \u306e\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u5148\u3068\u3057\u3066\u5229\u7528\u3067\u304d\u308b\u3088\u3046\u306b\u3059\u308b\u30bd\u30d5\u30c8\n\n\nhttps://ja.wikipedia.org/wiki/Netatalk\nApple Talk \u6642\u4ee3\u304b\u3089\u3042\u308b\u5272\u308a\u3068\u6b74\u53f2\u306e\u3042\u308b\u30bd\u30d5\u30c8\u3067\u3059(\u304a\u3063\u3055\u3093\u4e59)\n\n\n\n\n\u5bfe\u8c61\n\nnetatalk \u3092 TimeMachine \u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u5148\u3068\u3057\u3066\u5229\u7528\u3055\u308c\u3066\u308b\u65b9\u3001\u3057\u305f\u3044\u65b9\nHost \u3068 netatalk \u90e8\u5206\u3092\u30b3\u30f3\u30c6\u30ca\u3067\u5206\u96e2\u3057\u3066\u7ba1\u7406\u3057\u305f\u3044\u65b9\n\n\n\u305f\u3076\u3093 samba \u3068\u304b\u4ed6\u306e\u30b5\u30fc\u30d3\u30b9\u306b\u3082\u5fdc\u7528\u53ef\u80fd\u3068\u601d\u308f\u308c\u308b\n\n\n\n\n\u74b0\u5883\nHostOS:\n$ cat /etc/lsb-release\nDISTRIB_ID=Ubuntu\nDISTRIB_RELEASE=14.04\nDISTRIB_CODENAME=trusty\nDISTRIB_DESCRIPTION=\"Ubuntu 14.04.3 LTS\"\n\n$ uname -r\n3.13.0-24-generic\n\n$ docker version\nClient:\n Version:      1.12.3\n API version:  1.24\n Go version:   go1.6.3\n Git commit:   6b644ec\n Built:        Wed Oct 26 21:44:32 2016\n OS/Arch:      linux/amd64\n\nServer:\n Version:      1.12.3\n API version:  1.24\n Go version:   go1.6.3\n Git commit:   6b644ec\n Built:        Wed Oct 26 21:44:32 2016\n OS/Arch:      linux/amd64\n\n$ sudo dpkg -l netatalk\n[sudo] password for hirofumi:\nDesired=Unknown/Install/Remove/Purge/Hold\n| Status=Not/Inst/Conf-files/Unpacked/halF-conf/Half-inst/trig-aWait/Trig-pend\n|/ Err?=(none)/Reinst-required (Status,Err: uppercase=bad)\n||/ Name                 Version         Architecture    Description\n+++-====================-===============-===============-==============================================\nii  netatalk             2.2.2-1ubuntu2  amd64           AppleTalk user binaries\n\n\n\u30ea\u30d5\u30a1\u30ec\u30f3\u30b9\n\nhttps://docs.docker.com/engine/reference/commandline/run/\n\nhttps://docs.docker.com/engine/installation/linux/ubuntulinux/\n\n\u5fc5\u8981\u306b\u5fdc\u3058\u3066 docker \u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u30a2\u30c3\u30d7\u3092\u5b9f\u884c\u3057\u307e\u3059\n\n\n\nhttps://docs.docker.com/engine/userguide/networking/\n\n\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u306e\u8a2d\u5b9a\u3082\u9069\u5b9c\n\u4eca\u56de\u306f Isolated Network \u3067\u8a66\u3057\u3066\u3044\u307e\u3059\n\n\nhttp://qiita.com/takeshinoda@github/items/2dec7a72930ec1f658af\nhttps://github.com/docker/docker/issues/2174\nhttps://github.com/docker/docker/issues/15306\n\n\n\u624b\u9806\n\n0. \u4e8b\u524d\u60c5\u5831\u53ce\u96c6\n\n\u30dd\u30fc\u30c8\u78ba\u8a8d\n\n$ sudo su -\nroot# cat /etc/services | grep afpovertcp\nafpovertcp      548/tcp                         # AFP over TCP\nafpovertcp      548/udp\n\nroot# lsof -iTCP -P | grep afpd\nafpd      11498            root    4u  IPv4 207626697      0t0  TCP *:548 (LISTEN)\nafpd      11502        hirofumi    4u  IPv6 207632827      0t0  TCP localhost:56018->localhost:4700 (ESTABLISHED)\nafpd      11502        hirofumi   11u  IPv4 207625023      0t0  TCP fs1:548->mba:51302 (ESTABLISHED)\n\n\nIPv6 forwarding enabled (issues/2174)\n\nroot# grep forward /etc/sysctl.conf | grep -v ^#\nnet.ipv4.ip_forward = 1\nnet.ipv6.conf.all.forwarding = 1\n\n\n\u30b3\u30f3\u30c6\u30ca\u540d\u306e\u30e6\u30cb\u30fc\u30af\u78ba\u8a8d\n\nroot# docker ps -a | grep netatalk\nroot#\n\n\n1. \u30db\u30b9\u30c8OS \u4e0a\u306e netatalk \u3092\u3044\u3063\u305f\u3093\u6b62\u3081\u307e\u3059\nroot# service netatalk stop\nStopping Netatalk Daemons: afpd cnid_metad papd timelord atalkd.\n\n\n2. \u6700\u65b0\u306e ubuntu \u30b3\u30f3\u30c6\u30ca\u3092\u7acb\u3066\u308b\n\n\u30db\u30b9\u30c8OS \u4e0a\u306e /mnt/export/Timemachine99 \u3092 \u30b3\u30f3\u30c6\u30ca \u4e0a\u306e /Timemachine99 \u306b\u30de\u30a6\u30f3\u30c8\u3057\u307e\u3059\n\nroot# mkdir /mnt/export/TimeMachine99\n\n\n\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u304b\u3089\u63a5\u7d9a\u3059\u308b\u30e6\u30fc\u30b6\u6a29\u9650\u306b\u4ed8\u3051\u66ff\u3048\u307e\u3059\n\nroot# chown hirofumi: /mnt/export/TimeMachine99\n\n\n\u30b3\u30f3\u30c6\u30ca\u306e\u4f5c\u6210\n\nroot# docker pull ubuntu:latest\n\nroot# docker images ubuntu\nREPOSITORY          TAG                 IMAGE ID            CREATED             VIRTUAL SIZE\nubuntu              latest              88f79970fa20        3 weeks ago         127.2 MB\n\nroot# container_name='netatalk01'\nroot# echo $container_name\nnetatalk01\n\nroot# docker network ls | grep isolated_nw\n23f5539f9f5e        isolated_nw         bridge              local\n\nroot# docker run -itd --name $container_name \\\n-v /mnt/export/TimeMachine99:/TimeMachine99 \\\n-p 0.0.0.0:548:548 \\\n--network=isolated_nw \\\n-t ubuntu:latest /bin/bash\n\nroot# # docker network inspect isolated_nw | jq .[].Containers | less\n{\n  \"cfa8fff637853d3ea4f7822951355a2f06a2c020d3c62377cf3a40451cf59c4f\": {\n    \"IPv6Address\": \"\",\n    \"IPv4Address\": \"172.19.0.2/16\",\n    \"MacAddress\": \"02:42:ac:13:00:02\",\n    \"EndpointID\": \"31823ae5ee8da43dfc3b8bc52c752d4589af4419099b914cfb124e055c196d3b\",\n    \"Name\": \"netatalk01\"\n  }\n}\n\nroot# ping -w 3  172.19.0.2\nPING 172.19.0.2 (172.19.0.2) 56(84) bytes of data.\n64 bytes from 172.19.0.2: icmp_seq=1 ttl=64 time=0.093 ms\n64 bytes from 172.19.0.2: icmp_seq=2 ttl=64 time=0.065 ms\n64 bytes from 172.19.0.2: icmp_seq=3 ttl=64 time=0.067 ms\n64 bytes from 172.19.0.2: icmp_seq=4 ttl=64 time=0.065 ms\n\nroot# docker attach netatalk01\n\nroot@cfa8fff63785:/# cat /etc/lsb-release\nDISTRIB_ID=Ubuntu\nDISTRIB_RELEASE=16.04\nDISTRIB_CODENAME=xenial\nDISTRIB_DESCRIPTION=\"Ubuntu 16.04.1 LTS\"\n\nroot@cfa8fff63785:/# apt-get update -y\nroot@cfa8fff63785:/# apt-get upgrade -y\n\n\n\u30b3\u30f3\u30c6\u30ca\u5185\u306b OS \u5c55\u958b\u3059\u308b\u3068\u3053\u308d\u307e\u3067\u306f\u7d42\u308f\u308a\u307e\u3057\u305f\n\n\n3. \u30b3\u30f3\u30c6\u30ca\u5185\u306b netatalk \u3092\u3044\u308c\u308b\nroot@cfa8fff63785:/# apt-get install vim -y\nroot@cfa8fff63785:/# apt-get install netatalk -y\n\n\n\u82e5\u5e72\u65b0\u3057\u304f\u306a\u308a\u307e\u3057\u305f\u306d\n\nroot@cfa8fff63785:/# dpkg -l netatalk\nDesired=Unknown/Install/Remove/Purge/Hold\n| Status=Not/Inst/Conf-files/Unpacked/halF-conf/Half-inst/trig-aWait/Trig-pend\n|/ Err?=(none)/Reinst-required (Status,Err: uppercase=bad)\n||/ Name                       Version            Architecture       Description\n+++-==========================-==================-==================-==========================================================\nii  netatalk                   2.2.5-1            amd64              AppleTalk user binaries\n\n\n\u6700\u7d42\u884c\u306b\u8db3\u3059\n\nroot@cfa8fff63785:/# vim /etc/netatalk/AppleVolumes.default\n\n/TimeMachine99  \"TM-for-MBA-on-docker\"      options:usedots,upriv,tm ea:ad allow:hirofumi volsizelimit:300000\n\n\n\u6700\u7d42\u884c\u306b\u8db3\u3059\n\nroot@cfa8fff63785:/# vim /etc/netatalk/afpd.conf\n\n- -tcp -noddp -uamlist uams_guest.so,uams_dhx.so,uams_dhx2.so -nosavepassword\n\n\n\u30de\u30a6\u30f3\u30c8\u30dd\u30a4\u30f3\u30c8/\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u4fdd\u5b58\u5148\u306e\u78ba\u8a8d\n\nroot@cfa8fff63785:/# ls -al /TimeMachine99\ntotal 8\ndrwxr-xr-x  2 1002 1002 4096 Nov  8 14:38 .\ndrwxr-xr-x 45 root root 4096 Nov  8 16:14 ..\n\n\nHost \u4e0a\u306e\u30e6\u30fc\u30b6\u306e UID GID \u306e\u78ba\u8a8d\n\nroot# grep hirofumi /etc/passwd\nhirofumi:x:1002:1002::/home/hirofumi:/bin/bash\n\nroot# grep 1002 /etc/group\nhirofumi:x:1002\n\n\nUID: 1002\nGID: 1002\n\n\n\u30b3\u30f3\u30c6\u30ca\u5185\u306b\u30e6\u30fc\u30b6\u306e\u8ffd\u52a0\n\n\n\u30db\u30b9\u30c8\u4e0a\u306e netatalk \u904b\u7528\u3068\u30e6\u30fc\u30b6\u3092\u5408\u308f\u305b\u307e\u3057\u305f\n\n\n\nroot@cfa8fff63785:/# groupadd -g 1002 hirofumi\n\nroot@cfa8fff63785:/# useradd -m -u 1002 -g hirofumi hirofumi\n\nroot@cfa8fff63785:/# passwd hirofumi\nNew password:\nRetype new password:\npasswd: password updated successfully\n\nroot@cfa8fff63785:/# ls -al /TimeMachine99\ntotal 8\ndrwxr-xr-x  2 hirofumi hirofumi 4096 Nov  8 14:38 .\ndrwxr-xr-x 46 root     root     4096 Nov  8 16:21 ..\n\n\n4. \u30b3\u30f3\u30c6\u30ca\u5185\u3067 netatalk \u30b5\u30fc\u30d3\u30b9\u306e\u958b\u59cb\nroot@cfa8fff63785:/# service netatalk start\nStarting Netatalk services (this will take a while):  cnid_metad afpd.\n\n\n5. \u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u5148\u306e\u767b\u9332 on mac\n% sudo tmutil setdestination -p afp://hirofumi@192.168.100.5/TM-for-MBA-on-docker\nPassword:\nDestination password:\n\n% tmutil destinationinfo\n====================================================\nName          : TM-for-MBA-on-docker\nKind          : Network\nURL           : afp://hirofumi@192.168.100.5/TM-for-MBA-on-docker\nID            : BDD304C8-5B3A-40F4-BF9A-45B3E1BA1357\n\n\n6. \u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u958b\u59cb\u3001\u30b9\u30c6\u30fc\u30bf\u30b9\u78ba\u8a8d\n% tmutil startbackup --auto\n% tmutil status\nBackup session status:\n{\n    BackupPhase = MountingBackupVol;\n    ClientID = \"com.apple.backupd\";\n    DateOfStateChange = \"2016-11-08 17:09:50 +0000\";\n    DestinationID = \"BDD304C8-5B3A-40F4-BF9A-45B3E1BA1357\";\n    Percent = \"-1\";\n    Running = 1;\n    Stopping = 0;\n}\n\n% tmutil status\nBackup session status:\n{\n    BackupPhase = Copying;\n    ClientID = \"com.apple.backupd\";\n    DateOfStateChange = \"2016-11-08 17:11:56 +0000\";\n    DestinationID = \"BDD304C8-5B3A-40F4-BF9A-45B3E1BA1357\";\n    DestinationMountPoint = \"/Volumes/Time Machine Backups\";\n    FirstBackup = 1;\n    Percent = \"7.019195447394897e-07\";\n    Progress =     {\n        \"_raw_totalBytes\" = 95890477056;\n        bytes = 74786;\n        files = 1;\n        totalBytes = 105479524761;\n        totalFiles = 2007952;\n    };\n    Running = 1;\n    Stopping = 0;\n    \"_raw_Percent\" = \"7.799106052660996e-07\";\n}\n\n\n\u3068\u308a\u3042\u3048\u305a\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u306f\u59cb\u307e\u308a\u307e\u3057\u305f\u3002\n\n\n7. \u30b3\u30f3\u30c6\u30ca\u304b\u3089\u30c7\u30bf\u30c3\u30c1\u3057\u3066\u30a4\u30e1\u30fc\u30b8\u3068\u3057\u3066\u4fdd\u5b58\u3059\u308b\n\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3057\u305f\u307e\u307e\u30c7\u30bf\u30c3\u30c1\u3057\u3066\u30db\u30b9\u30c8OS\u306e\u30b7\u30a7\u30eb\u306b\u623b\u308b\u306b\u306f\n\n\nctrl + p => ctrl +q\n\n\u3092\u62bc\u4e0b\u3057\u307e\u3059\n\n\u30a4\u30e1\u30fc\u30b8\u306b\u4fdd\u5b58\u3057\u3066\u304a\u304f\u3068\u5f8c\u3067\u518d\u5229\u7528\u304c\u5bb9\u6613\u306b\u306a\u308a\u307e\u3059\n\nroot# docker ps\nCONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS                  NAMES\ncfa8fff63785        ubuntu:latest       \"/bin/bash\"         49 minutes ago      Up 21 minutes       0.0.0.0:548->548/tcp   netatalk01\n\nroot# docker commit netatalk01 hirofumi/netatalk01-20161109\nsha256:df1c3ae87e9fce88bc0c74959fff2f3a8538d3177447f61ee4ee02aa61ebc92e\n\nroot# docker images | grep netatalk\nhirofumi/netatalk01-20161109   latest              df1c3ae87e9f        12 seconds ago      375.6 MB\n\n\n8. \u3044\u3063\u305f\u3093\u7d42\u4e86\n\n9. P.S.\n\nMBA \u306f\u671d\u306b\u306a\u3063\u305f\u3089\u6301\u3061\u51fa\u3059\u306e\u3067\u6700\u521d\u306e Full Backup \u3092\u53d6\u308b\u306b\u306f\u571f\u65e5\u3092\u5f85\u3064\u3057\u304b\u306a\u3044\u3093\u3067\u3057\u305f\u3002\n\u636e\u3048\u7f6e\u304d\u306e Mac Mini \u3067\u3082\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u5148\u306b\u3059\u3079\u304f\u4f5c\u3063\u305f\u30a4\u30e1\u30fc\u30b8\u3067\u5225\u30b3\u30f3\u30c6\u30ca\u3092\u7acb\u3066\u308b\u3053\u3068\u306b\u3057\u307e\u3059\u3002\n\n\n9-1. \u65e2\u5b58\u306e\u30b3\u30f3\u30c6\u30ca\u3092\u6b62\u3081\u307e\u3059\nroot# docker stop netatalk01\n\n\n9-2. \u30db\u30b9\u30c8\u4e0a\u306b\u65b0\u305f\u306a\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u5148\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u4f5c\u6210\nroot# mkdir /mnt/export/TimeMachine98\nroot# chown hirofumi: /mnt/export/TimeMachine98\n\n\n9-3. \u30a4\u30e1\u30fc\u30b8\u304b\u3089\u8ffd\u52a0\u3067 TimeMachine98 \u3092\u30de\u30a6\u30f3\u30c8\u3057\u305f\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\nroot# docker run -itd --name netatalk02 \\\n-v /mnt/export/TimeMachine99:/TimeMachine99 \\\n-v /mnt/export/TimeMachine98:/TimeMachine98 \\\n-p 0.0.0.0:548:548 \\\n--network=isolated_nw \\\n-t hirofumi/netatalk01-20161109 /bin/bash\n\nroot# docker ps\nCONTAINER ID        IMAGE                          COMMAND             CREATED             STATUS              PORTS                  NAMES\n1aec5fd3ad73        hirofumi/netatalk01-20161109   \"/bin/bash\"         5 seconds ago       Up 3 seconds        0.0.0.0:548->548/tcp   netatalk02\n\nroot# docker network inspect isolated_nw | jq .[].Containers\n{\n  \"1aec5fd3ad7307503a106a91d0670e0773f0ee582360094717819d2b5236b761\": {\n    \"IPv6Address\": \"\",\n    \"IPv4Address\": \"172.19.0.2/16\",\n    \"MacAddress\": \"02:42:ac:13:00:02\",\n    \"EndpointID\": \"6d0e555acd84965a156da02ad51026ed5923941bec9ea524fcd5b106c63d4e83\",\n    \"Name\": \"netatalk02\"\n  }\n}\n\n\n9-4. \u30a2\u30bf\u30c3\u30c1\u3057\u307e\u3059\nroot# docker attach netatalk02\n\n\n9-5. netatalk \u306e\u8a2d\u5b9a\u3092\u8ffd\u52a0\u3057\u307e\u3059\nroot@1aec5fd3ad73:/# vi /etc/netatalk/AppleVolumes.default\n\n/TimeMachine98  \"TM-for-macmini-on-docker\"      options:usedots,upriv,tm ea:ad allow:hirofumi volsizelimit:300000\n\n\n9-6. \u30b5\u30fc\u30d3\u30b9\u518d\u8d77\u52d5\nroot@1aec5fd3ad73:/# service netatalk restart\n\n\n9-7. \u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u958b\u59cb\nmacOS% sudo tmutil setdestination -p afp://hirofumi@192.168.100.5/TM-for-macmini-on-docker\n\nmacOS% tmutil destinationinfo\n====================================================\nName          : TM-for-macmini-on-docker\nKind          : Network\nURL           : afp://hirofumi@192.168.100.5/TM-for-macmini-on-docker\nID            : 234C7FCE-7C9D-4975-9226-58113E2EDCB9\n\nmacOS% tmutil startbackup --auto\n\nmacOS% tmutil status\nBackup session status:\n{\n    BackupPhase = Starting;\n    ClientID = \"com.apple.backupd\";\n    DateOfStateChange = \"2016-11-10 15:08:02 +0000\";\n    DestinationID = \"234C7FCE-7C9D-4975-9226-58113E2EDCB9\";\n    Percent = \"-1\";\n    Running = 1;\n    Stopping = 0;\n}\n\ntmutil status\nBackup session status:\n{\n    BackupPhase = Copying;\n    ClientID = \"com.apple.backupd\";\n    DateOfStateChange = \"2016-11-10 15:08:49 +0000\";\n    DestinationID = \"234C7FCE-7C9D-4975-9226-58113E2EDCB9\";\n    DestinationMountPoint = \"/Volumes/Time Machine Backups\";\n    FirstBackup = 1;\n    Percent = 0;\n    Progress =     {\n        \"_raw_totalBytes\" = 109091217408;\n        bytes = 0;\n        files = 0;\n        totalBytes = 120000339148;\n        totalFiles = 939306;\n    };\n    Running = 1;\n    Stopping = 0;\n    \"_raw_Percent\" = 0;\n}\n\n\n9-8. \u69d8\u5b50\u898b\n\n\u3053\u308c\u3067\u3060\u3081\u306a\u3089\u6700\u65b0\u306e netatalk \u3092\u30bd\u30fc\u30b9\u304b\u3089\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3067\u3059\u304b\u306d\u3002\u3002\n\n# netatalk \u3092 docker \u30b3\u30f3\u30c6\u30ca\u5316\u3057\u3066 TimeMachine \u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u5148\u306b\u3057\u3066\u307f\u305f\n\n## \u76ee\u7684\n\n- macOS Sierra \u306b\u3057\u3066\u304b\u3089 netatalk \u3054\u3057\u306e TimeMachine \u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u304c\u53d6\u308c\u3066\u306a\u3044\u3088\u3046\u306a\u611f\u3058\u2026\n    - \u6b63\u78ba\u306b\u66f8\u304f\u3068\u3001\u6700\u521d\u306e FullBackup \u306f\u53d6\u308c\u308b\u304c\u3001\u305d\u306e\u5f8c\u306e \u5dee\u5206\u30d0\u30c3\u30af\u30a2\u30c3\u30d7 \u304c\u53d6\u308c\u306a\u3044\n- \u73fe\u5728 Host OS \u306f Ubuntu14.04 \u3061\u3087\u3063\u3068\u53e4\u3044\u304c\u3059\u3050\u306b Host \u4e0a\u306e netatalk \u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u30a2\u30c3\u30d7\u306f\u3057\u3065\u3089\u3044\n- docker \u3067\u6700\u65b0\u30d0\u30fc\u30b8\u30e7\u30f3\u306b\u3057\u3066\u8a66\u3057\u3066\u307f\u3088\u3046(\u5207\u308a\u5206\u3051)\n\n## netatalk \u3068\u306f\n\n- \u7c21\u5358\u306b\u8a00\u3046\u3068 Unix\u30de\u30b7\u30f3(Linux\u306a\u3069) \u3092 TimeMachine \u306e\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u5148\u3068\u3057\u3066\u5229\u7528\u3067\u304d\u308b\u3088\u3046\u306b\u3059\u308b\u30bd\u30d5\u30c8\n  - https://ja.wikipedia.org/wiki/Netatalk\n  - Apple Talk \u6642\u4ee3\u304b\u3089\u3042\u308b\u5272\u308a\u3068\u6b74\u53f2\u306e\u3042\u308b\u30bd\u30d5\u30c8\u3067\u3059(\u304a\u3063\u3055\u3093\u4e59)\n\n## \u5bfe\u8c61\n\n- netatalk \u3092 TimeMachine \u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u5148\u3068\u3057\u3066\u5229\u7528\u3055\u308c\u3066\u308b\u65b9\u3001\u3057\u305f\u3044\u65b9\n- Host \u3068 netatalk \u90e8\u5206\u3092\u30b3\u30f3\u30c6\u30ca\u3067\u5206\u96e2\u3057\u3066\u7ba1\u7406\u3057\u305f\u3044\u65b9\n  - \u305f\u3076\u3093 samba \u3068\u304b\u4ed6\u306e\u30b5\u30fc\u30d3\u30b9\u306b\u3082\u5fdc\u7528\u53ef\u80fd\u3068\u601d\u308f\u308c\u308b\n\n## \u74b0\u5883\n\nHostOS:\n\n```shell-session\n$ cat /etc/lsb-release\nDISTRIB_ID=Ubuntu\nDISTRIB_RELEASE=14.04\nDISTRIB_CODENAME=trusty\nDISTRIB_DESCRIPTION=\"Ubuntu 14.04.3 LTS\"\n\n$ uname -r\n3.13.0-24-generic\n```\n```shell-session\n$ docker version\nClient:\n Version:      1.12.3\n API version:  1.24\n Go version:   go1.6.3\n Git commit:   6b644ec\n Built:        Wed Oct 26 21:44:32 2016\n OS/Arch:      linux/amd64\n\nServer:\n Version:      1.12.3\n API version:  1.24\n Go version:   go1.6.3\n Git commit:   6b644ec\n Built:        Wed Oct 26 21:44:32 2016\n OS/Arch:      linux/amd64\n```\n```shell-session\n$ sudo dpkg -l netatalk\n[sudo] password for hirofumi:\nDesired=Unknown/Install/Remove/Purge/Hold\n| Status=Not/Inst/Conf-files/Unpacked/halF-conf/Half-inst/trig-aWait/Trig-pend\n|/ Err?=(none)/Reinst-required (Status,Err: uppercase=bad)\n||/ Name                 Version         Architecture    Description\n+++-====================-===============-===============-==============================================\nii  netatalk             2.2.2-1ubuntu2  amd64           AppleTalk user binaries\n```\n\n## \u30ea\u30d5\u30a1\u30ec\u30f3\u30b9\n\n- https://docs.docker.com/engine/reference/commandline/run/\n- https://docs.docker.com/engine/installation/linux/ubuntulinux/\n  - \u5fc5\u8981\u306b\u5fdc\u3058\u3066 docker \u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u30a2\u30c3\u30d7\u3092\u5b9f\u884c\u3057\u307e\u3059\n- https://docs.docker.com/engine/userguide/networking/\n  - \u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u306e\u8a2d\u5b9a\u3082\u9069\u5b9c\n  - \u4eca\u56de\u306f Isolated Network \u3067\u8a66\u3057\u3066\u3044\u307e\u3059\n- http://qiita.com/takeshinoda@github/items/2dec7a72930ec1f658af\n- https://github.com/docker/docker/issues/2174\n- https://github.com/docker/docker/issues/15306\n\n## \u624b\u9806\n\n### 0. \u4e8b\u524d\u60c5\u5831\u53ce\u96c6\n\n- \u30dd\u30fc\u30c8\u78ba\u8a8d\n\n```shell-session\n$ sudo su -\nroot# cat /etc/services | grep afpovertcp\nafpovertcp      548/tcp                         # AFP over TCP\nafpovertcp      548/udp\n```\n```shell-session\nroot# lsof -iTCP -P | grep afpd\nafpd      11498            root    4u  IPv4 207626697      0t0  TCP *:548 (LISTEN)\nafpd      11502        hirofumi    4u  IPv6 207632827      0t0  TCP localhost:56018->localhost:4700 (ESTABLISHED)\nafpd      11502        hirofumi   11u  IPv4 207625023      0t0  TCP fs1:548->mba:51302 (ESTABLISHED)\n```\n\n- IPv6 forwarding enabled (issues/2174)\n\n```shell-session\nroot# grep forward /etc/sysctl.conf | grep -v ^#\nnet.ipv4.ip_forward = 1\nnet.ipv6.conf.all.forwarding = 1\n```\n\n- \u30b3\u30f3\u30c6\u30ca\u540d\u306e\u30e6\u30cb\u30fc\u30af\u78ba\u8a8d\n\n```shell-session\nroot# docker ps -a | grep netatalk\nroot#\n```\n\n### 1. \u30db\u30b9\u30c8OS \u4e0a\u306e netatalk \u3092\u3044\u3063\u305f\u3093\u6b62\u3081\u307e\u3059\n\n```shell-session\nroot# service netatalk stop\nStopping Netatalk Daemons: afpd cnid_metad papd timelord atalkd.\n```\n\n### 2. \u6700\u65b0\u306e ubuntu \u30b3\u30f3\u30c6\u30ca\u3092\u7acb\u3066\u308b\n\n- \u30db\u30b9\u30c8OS \u4e0a\u306e /mnt/export/Timemachine99 \u3092 \u30b3\u30f3\u30c6\u30ca \u4e0a\u306e /Timemachine99 \u306b\u30de\u30a6\u30f3\u30c8\u3057\u307e\u3059\n\n```shell-session\nroot# mkdir /mnt/export/TimeMachine99\n```\n- \u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u304b\u3089\u63a5\u7d9a\u3059\u308b\u30e6\u30fc\u30b6\u6a29\u9650\u306b\u4ed8\u3051\u66ff\u3048\u307e\u3059\n\n```shell-session\nroot# chown hirofumi: /mnt/export/TimeMachine99\n```\n- \u30b3\u30f3\u30c6\u30ca\u306e\u4f5c\u6210\n\n```shell-session\nroot# docker pull ubuntu:latest\n\nroot# docker images ubuntu\nREPOSITORY          TAG                 IMAGE ID            CREATED             VIRTUAL SIZE\nubuntu              latest              88f79970fa20        3 weeks ago         127.2 MB\n\nroot# container_name='netatalk01'\nroot# echo $container_name\nnetatalk01\n\nroot# docker network ls | grep isolated_nw\n23f5539f9f5e        isolated_nw         bridge              local\n\nroot# docker run -itd --name $container_name \\\n-v /mnt/export/TimeMachine99:/TimeMachine99 \\\n-p 0.0.0.0:548:548 \\\n--network=isolated_nw \\\n-t ubuntu:latest /bin/bash\n\nroot# # docker network inspect isolated_nw | jq .[].Containers | less\n{\n  \"cfa8fff637853d3ea4f7822951355a2f06a2c020d3c62377cf3a40451cf59c4f\": {\n    \"IPv6Address\": \"\",\n    \"IPv4Address\": \"172.19.0.2/16\",\n    \"MacAddress\": \"02:42:ac:13:00:02\",\n    \"EndpointID\": \"31823ae5ee8da43dfc3b8bc52c752d4589af4419099b914cfb124e055c196d3b\",\n    \"Name\": \"netatalk01\"\n  }\n}\n\nroot# ping -w 3  172.19.0.2\nPING 172.19.0.2 (172.19.0.2) 56(84) bytes of data.\n64 bytes from 172.19.0.2: icmp_seq=1 ttl=64 time=0.093 ms\n64 bytes from 172.19.0.2: icmp_seq=2 ttl=64 time=0.065 ms\n64 bytes from 172.19.0.2: icmp_seq=3 ttl=64 time=0.067 ms\n64 bytes from 172.19.0.2: icmp_seq=4 ttl=64 time=0.065 ms\n\nroot# docker attach netatalk01\n\nroot@cfa8fff63785:/# cat /etc/lsb-release\nDISTRIB_ID=Ubuntu\nDISTRIB_RELEASE=16.04\nDISTRIB_CODENAME=xenial\nDISTRIB_DESCRIPTION=\"Ubuntu 16.04.1 LTS\"\n\nroot@cfa8fff63785:/# apt-get update -y\nroot@cfa8fff63785:/# apt-get upgrade -y\n```\n\n- \u30b3\u30f3\u30c6\u30ca\u5185\u306b OS \u5c55\u958b\u3059\u308b\u3068\u3053\u308d\u307e\u3067\u306f\u7d42\u308f\u308a\u307e\u3057\u305f\n\n### 3. \u30b3\u30f3\u30c6\u30ca\u5185\u306b netatalk \u3092\u3044\u308c\u308b\n\n```shell-session\nroot@cfa8fff63785:/# apt-get install vim -y\nroot@cfa8fff63785:/# apt-get install netatalk -y\n```\n- \u82e5\u5e72\u65b0\u3057\u304f\u306a\u308a\u307e\u3057\u305f\u306d\n\n```shell-session\nroot@cfa8fff63785:/# dpkg -l netatalk\nDesired=Unknown/Install/Remove/Purge/Hold\n| Status=Not/Inst/Conf-files/Unpacked/halF-conf/Half-inst/trig-aWait/Trig-pend\n|/ Err?=(none)/Reinst-required (Status,Err: uppercase=bad)\n||/ Name                       Version            Architecture       Description\n+++-==========================-==================-==================-==========================================================\nii  netatalk                   2.2.5-1            amd64              AppleTalk user binaries\n```\n\n- \u6700\u7d42\u884c\u306b\u8db3\u3059\n\n```shell-session\nroot@cfa8fff63785:/# vim /etc/netatalk/AppleVolumes.default\n\n/TimeMachine99  \"TM-for-MBA-on-docker\"      options:usedots,upriv,tm ea:ad allow:hirofumi volsizelimit:300000\n```\n- \u6700\u7d42\u884c\u306b\u8db3\u3059\n\n```shell-session\nroot@cfa8fff63785:/# vim /etc/netatalk/afpd.conf\n\n- -tcp -noddp -uamlist uams_guest.so,uams_dhx.so,uams_dhx2.so -nosavepassword\n```\n\n- \u30de\u30a6\u30f3\u30c8\u30dd\u30a4\u30f3\u30c8/\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u4fdd\u5b58\u5148\u306e\u78ba\u8a8d\n\n```shell-session\nroot@cfa8fff63785:/# ls -al /TimeMachine99\ntotal 8\ndrwxr-xr-x  2 1002 1002 4096 Nov  8 14:38 .\ndrwxr-xr-x 45 root root 4096 Nov  8 16:14 ..\n```\n\n- Host \u4e0a\u306e\u30e6\u30fc\u30b6\u306e UID GID \u306e\u78ba\u8a8d\n\n```shell-session\nroot# grep hirofumi /etc/passwd\nhirofumi:x:1002:1002::/home/hirofumi:/bin/bash\n\nroot# grep 1002 /etc/group\nhirofumi:x:1002\n```\n> UID: 1002\n> GID: 1002\n\n- \u30b3\u30f3\u30c6\u30ca\u5185\u306b\u30e6\u30fc\u30b6\u306e\u8ffd\u52a0\n  - \u30db\u30b9\u30c8\u4e0a\u306e netatalk \u904b\u7528\u3068\u30e6\u30fc\u30b6\u3092\u5408\u308f\u305b\u307e\u3057\u305f\n\n```shell-session\nroot@cfa8fff63785:/# groupadd -g 1002 hirofumi\n\nroot@cfa8fff63785:/# useradd -m -u 1002 -g hirofumi hirofumi\n\nroot@cfa8fff63785:/# passwd hirofumi\nNew password:\nRetype new password:\npasswd: password updated successfully\n\nroot@cfa8fff63785:/# ls -al /TimeMachine99\ntotal 8\ndrwxr-xr-x  2 hirofumi hirofumi 4096 Nov  8 14:38 .\ndrwxr-xr-x 46 root     root     4096 Nov  8 16:21 ..\n```\n\n### 4. \u30b3\u30f3\u30c6\u30ca\u5185\u3067 netatalk \u30b5\u30fc\u30d3\u30b9\u306e\u958b\u59cb\n\n```shell-session\nroot@cfa8fff63785:/# service netatalk start\nStarting Netatalk services (this will take a while):  cnid_metad afpd.\n```\n\n### 5. \u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u5148\u306e\u767b\u9332 on mac\n\n```shell-session\n% sudo tmutil setdestination -p afp://hirofumi@192.168.100.5/TM-for-MBA-on-docker\nPassword:\nDestination password:\n```\n```shell-session\n% tmutil destinationinfo\n====================================================\nName          : TM-for-MBA-on-docker\nKind          : Network\nURL           : afp://hirofumi@192.168.100.5/TM-for-MBA-on-docker\nID            : BDD304C8-5B3A-40F4-BF9A-45B3E1BA1357\n```\n\n### 6. \u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u958b\u59cb\u3001\u30b9\u30c6\u30fc\u30bf\u30b9\u78ba\u8a8d\n\n```shell-session\n% tmutil startbackup --auto\n% tmutil status\nBackup session status:\n{\n    BackupPhase = MountingBackupVol;\n    ClientID = \"com.apple.backupd\";\n    DateOfStateChange = \"2016-11-08 17:09:50 +0000\";\n    DestinationID = \"BDD304C8-5B3A-40F4-BF9A-45B3E1BA1357\";\n    Percent = \"-1\";\n    Running = 1;\n    Stopping = 0;\n}\n```\n```shell-session\n% tmutil status\nBackup session status:\n{\n    BackupPhase = Copying;\n    ClientID = \"com.apple.backupd\";\n    DateOfStateChange = \"2016-11-08 17:11:56 +0000\";\n    DestinationID = \"BDD304C8-5B3A-40F4-BF9A-45B3E1BA1357\";\n    DestinationMountPoint = \"/Volumes/Time Machine Backups\";\n    FirstBackup = 1;\n    Percent = \"7.019195447394897e-07\";\n    Progress =     {\n        \"_raw_totalBytes\" = 95890477056;\n        bytes = 74786;\n        files = 1;\n        totalBytes = 105479524761;\n        totalFiles = 2007952;\n    };\n    Running = 1;\n    Stopping = 0;\n    \"_raw_Percent\" = \"7.799106052660996e-07\";\n}\n```\n\n- \u3068\u308a\u3042\u3048\u305a\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u306f\u59cb\u307e\u308a\u307e\u3057\u305f\u3002\n\n### 7. \u30b3\u30f3\u30c6\u30ca\u304b\u3089\u30c7\u30bf\u30c3\u30c1\u3057\u3066\u30a4\u30e1\u30fc\u30b8\u3068\u3057\u3066\u4fdd\u5b58\u3059\u308b\n\n- \u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3057\u305f\u307e\u307e\u30c7\u30bf\u30c3\u30c1\u3057\u3066\u30db\u30b9\u30c8OS\u306e\u30b7\u30a7\u30eb\u306b\u623b\u308b\u306b\u306f\n\n> ctrl + p => ctrl +q\n\n\u3092\u62bc\u4e0b\u3057\u307e\u3059\n\n- \u30a4\u30e1\u30fc\u30b8\u306b\u4fdd\u5b58\u3057\u3066\u304a\u304f\u3068\u5f8c\u3067\u518d\u5229\u7528\u304c\u5bb9\u6613\u306b\u306a\u308a\u307e\u3059\n\n```shell-session\nroot# docker ps\nCONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS                  NAMES\ncfa8fff63785        ubuntu:latest       \"/bin/bash\"         49 minutes ago      Up 21 minutes       0.0.0.0:548->548/tcp   netatalk01\n\nroot# docker commit netatalk01 hirofumi/netatalk01-20161109\nsha256:df1c3ae87e9fce88bc0c74959fff2f3a8538d3177447f61ee4ee02aa61ebc92e\n\nroot# docker images | grep netatalk\nhirofumi/netatalk01-20161109   latest              df1c3ae87e9f        12 seconds ago      375.6 MB\n```\n\n### 8. \u3044\u3063\u305f\u3093\u7d42\u4e86\n\n### 9. P.S.\n\n- MBA \u306f\u671d\u306b\u306a\u3063\u305f\u3089\u6301\u3061\u51fa\u3059\u306e\u3067\u6700\u521d\u306e Full Backup \u3092\u53d6\u308b\u306b\u306f\u571f\u65e5\u3092\u5f85\u3064\u3057\u304b\u306a\u3044\u3093\u3067\u3057\u305f\u3002\n- \u636e\u3048\u7f6e\u304d\u306e Mac Mini \u3067\u3082\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u5148\u306b\u3059\u3079\u304f\u4f5c\u3063\u305f\u30a4\u30e1\u30fc\u30b8\u3067\u5225\u30b3\u30f3\u30c6\u30ca\u3092\u7acb\u3066\u308b\u3053\u3068\u306b\u3057\u307e\u3059\u3002\n\n#### 9-1. \u65e2\u5b58\u306e\u30b3\u30f3\u30c6\u30ca\u3092\u6b62\u3081\u307e\u3059\n\n```shell-session\nroot# docker stop netatalk01\n```\n\n#### 9-2. \u30db\u30b9\u30c8\u4e0a\u306b\u65b0\u305f\u306a\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u5148\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u4f5c\u6210\n\n```shell-session\nroot# mkdir /mnt/export/TimeMachine98\nroot# chown hirofumi: /mnt/export/TimeMachine98\n```\n\n#### 9-3. \u30a4\u30e1\u30fc\u30b8\u304b\u3089\u8ffd\u52a0\u3067 TimeMachine98 \u3092\u30de\u30a6\u30f3\u30c8\u3057\u305f\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\n\n```shell-session\nroot# docker run -itd --name netatalk02 \\\n-v /mnt/export/TimeMachine99:/TimeMachine99 \\\n-v /mnt/export/TimeMachine98:/TimeMachine98 \\\n-p 0.0.0.0:548:548 \\\n--network=isolated_nw \\\n-t hirofumi/netatalk01-20161109 /bin/bash\n```\n```shell-session\nroot# docker ps\nCONTAINER ID        IMAGE                          COMMAND             CREATED             STATUS              PORTS                  NAMES\n1aec5fd3ad73        hirofumi/netatalk01-20161109   \"/bin/bash\"         5 seconds ago       Up 3 seconds        0.0.0.0:548->548/tcp   netatalk02\n```\n```shell-session\nroot# docker network inspect isolated_nw | jq .[].Containers\n{\n  \"1aec5fd3ad7307503a106a91d0670e0773f0ee582360094717819d2b5236b761\": {\n    \"IPv6Address\": \"\",\n    \"IPv4Address\": \"172.19.0.2/16\",\n    \"MacAddress\": \"02:42:ac:13:00:02\",\n    \"EndpointID\": \"6d0e555acd84965a156da02ad51026ed5923941bec9ea524fcd5b106c63d4e83\",\n    \"Name\": \"netatalk02\"\n  }\n}\n```\n#### 9-4. \u30a2\u30bf\u30c3\u30c1\u3057\u307e\u3059\n\n```shell-session\nroot# docker attach netatalk02\n```\n\n#### 9-5. netatalk \u306e\u8a2d\u5b9a\u3092\u8ffd\u52a0\u3057\u307e\u3059\n\n```shell-session\nroot@1aec5fd3ad73:/# vi /etc/netatalk/AppleVolumes.default\n\n/TimeMachine98  \"TM-for-macmini-on-docker\"      options:usedots,upriv,tm ea:ad allow:hirofumi volsizelimit:300000\n```\n\n#### 9-6. \u30b5\u30fc\u30d3\u30b9\u518d\u8d77\u52d5\n\n```shell-session\nroot@1aec5fd3ad73:/# service netatalk restart\n```\n\n#### 9-7. \u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u958b\u59cb\n\n```shell-session\nmacOS% sudo tmutil setdestination -p afp://hirofumi@192.168.100.5/TM-for-macmini-on-docker\n\nmacOS% tmutil destinationinfo\n====================================================\nName          : TM-for-macmini-on-docker\nKind          : Network\nURL           : afp://hirofumi@192.168.100.5/TM-for-macmini-on-docker\nID            : 234C7FCE-7C9D-4975-9226-58113E2EDCB9\n```\n```shell-session\nmacOS% tmutil startbackup --auto\n\nmacOS% tmutil status\nBackup session status:\n{\n    BackupPhase = Starting;\n    ClientID = \"com.apple.backupd\";\n    DateOfStateChange = \"2016-11-10 15:08:02 +0000\";\n    DestinationID = \"234C7FCE-7C9D-4975-9226-58113E2EDCB9\";\n    Percent = \"-1\";\n    Running = 1;\n    Stopping = 0;\n}\n```\n```shell-session\ntmutil status\nBackup session status:\n{\n    BackupPhase = Copying;\n    ClientID = \"com.apple.backupd\";\n    DateOfStateChange = \"2016-11-10 15:08:49 +0000\";\n    DestinationID = \"234C7FCE-7C9D-4975-9226-58113E2EDCB9\";\n    DestinationMountPoint = \"/Volumes/Time Machine Backups\";\n    FirstBackup = 1;\n    Percent = 0;\n    Progress =     {\n        \"_raw_totalBytes\" = 109091217408;\n        bytes = 0;\n        files = 0;\n        totalBytes = 120000339148;\n        totalFiles = 939306;\n    };\n    Running = 1;\n    Stopping = 0;\n    \"_raw_Percent\" = 0;\n}\n```\n\n#### 9-8. \u69d8\u5b50\u898b\n\n- \u3053\u308c\u3067\u3060\u3081\u306a\u3089\u6700\u65b0\u306e netatalk \u3092\u30bd\u30fc\u30b9\u304b\u3089\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3067\u3059\u304b\u306d\u3002\u3002\n"}