{"tags": ["mariadb", "MySQL"], "context": " More than 1 year has passed since last update.\u53c2\u8003: tap dev blog - MySQL5.5-MySQL5.6+KeepAlived\u3092\u4f7f\u3063\u305f\u30012\u53f0\u69cb\u6210HA\u578b\u6e96\u540c\u671f\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u4f5c\u308a\u65b9\n\n\u6e96\u5099\n\nCentOS7\u3067\u8a66\u3057\u305f\u3002\n\n\n\u30d7\u30e9\u30b0\u30a4\u30f3\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\nMariaDB\u30d7\u30ed\u30f3\u30d7\u30c8\nMariaDB [(none)]> INSTALL PLUGIN rpl_semi_sync_master SONAME 'semisync_master.so';\nMariaDB [(none)]> INSTALL PLUGIN rpl_semi_sync_slave SONAME 'semisync_slave.so';\n\n\n\nmy.cnf\n\n/etc/my.cnf.d/my_custom.cnf\n[mysqld]\ncharacter-set-server = utf8\ninnodb_file_per_table = 1\n\n# show variables like slow;\nslow_query_log=ON\nlong_query_time=1\nlog-slow-queries=/var/log/mariadb/slow.log\n\n\nlog-bin = mysql-bin\nrelay-log = relay-bin\n# \u30b5\u30fc\u30d0\u3054\u3068\u306b\u4e00\u610f\u306eID\u3092\u632f\u308b\u3053\u3068\u3002\nserver-id = 101\n# \u5fc5\u9808\u3002\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3067\u53d6\u5f97\u3057\u305f\u30ed\u30b0\u3092\u30d0\u30a4\u30ca\u30ea\u30ed\u30b0\u306b\u3082\u66f8\u304d\u8fbc\u3080\u3002\nlog_slave_updates\n# \u52dd\u624b\u306b\u30b9\u30ec\u30fc\u30d6\u8d77\u52d5\u306f\u3044\u3084\u3002\nskip-slave-start\n# \u30bb\u30df\u30b7\u30f3\u30af\u30ed(\u6e96\u540c\u671f)\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3092\u8a31\u53ef\u3002\nrpl_semi_sync_master_enabled = 1\nrpl_semi_sync_slave_enabled = 1\n\n\nsystemctl restart mariadb\n\n\u73fe\u72b6\u78ba\u8a8d\n\nMariaDB\u30d7\u30ed\u30f3\u30d7\u30c8\nMariaDB [(none)]> show status like '%semi%';\n+--------------------------------------------+-------+\n| Variable_name                              | Value |\n+--------------------------------------------+-------+\n| Rpl_semi_sync_master_clients               | 0     |\n| Rpl_semi_sync_master_net_avg_wait_time     | 0     |\n| Rpl_semi_sync_master_net_wait_time         | 0     |\n| Rpl_semi_sync_master_net_waits             | 0     |\n| Rpl_semi_sync_master_no_times              | 0     |\n| Rpl_semi_sync_master_no_tx                 | 0     |\n| Rpl_semi_sync_master_status                | ON    |\n| Rpl_semi_sync_master_timefunc_failures     | 0     |\n| Rpl_semi_sync_master_tx_avg_wait_time      | 0     |\n| Rpl_semi_sync_master_tx_wait_time          | 0     |\n| Rpl_semi_sync_master_tx_waits              | 0     |\n| Rpl_semi_sync_master_wait_pos_backtraverse | 0     |\n| Rpl_semi_sync_master_wait_sessions         | 0     |\n| Rpl_semi_sync_master_yes_tx                | 0     |\n| Rpl_semi_sync_slave_status                 | OFF   |\n+--------------------------------------------+-------+\n15 rows in set (0.00 sec)\n\n\n\n\nRpl_semi_sync_master_clients\u304c0\u3067\u3042\u308b\u3053\u3068\u3092\u899a\u3048\u3066\u304a\u304f\u3002\n\n\n\u672c\u756a\n\n\u901a\u5e38MASTER\u5074\n\n\u901a\u5e38MASTER\u5074\u306b\u3066\u5b9f\u65bd\nGRANT REPLICATION SLAVE ON *.* TO sync@'192.168.100.%' IDENTIFIED BY 'Iatho5zi';\n\n\n\nbinlog\u540d\u3068\u30dd\u30b8\u30b7\u30e7\u30f3\u3092\u78ba\u8a8d\nshow status LIKE 'Binlog_snapshot_file';\nshow status LIKE 'Binlog_snapshot_position';\n\n\n\nbinlog\u540d = mysql-bin.000002\n\u30dd\u30b8\u30b7\u30e7\u30f3 = 397\n\n\u3060\u3063\u305f\u306e\u3067\u4ee5\u4e0b\u30b3\u30de\u30f3\u30c9\u3068\u306a\u308b\u3002\n\n\u901a\u5e38BACKUP\u5074\nchange master to master_host='192.168.100.110',master_user='sync',master_password='Iatho5zi',master_log_file='mysql-bin.000002',master_log_pos=397;\n\nstart slave;\n\n\n\u78ba\u8a8d\n\nmaster\u3068backup\u4e21\u65b9\u306e\u6bd4\u8f03\u3057\u305f\u56f3\nMariaDB [(none)]> show status like '%semi%';\n+--------------------------------------------+-------+-------+\n| Variable_name                              | master| backup|\n+--------------------------------------------+-------+-------+\n| Rpl_semi_sync_master_clients               | 1     | 0     |\n| Rpl_semi_sync_master_net_avg_wait_time     | 0     | 0     |\n| Rpl_semi_sync_master_net_wait_time         | 0     | 0     |\n| Rpl_semi_sync_master_net_waits             | 0     | 0     |\n| Rpl_semi_sync_master_no_times              | 1     | 0     |\n| Rpl_semi_sync_master_no_tx                 | 1     | 0     |\n| Rpl_semi_sync_master_status                | ON    | ON    |\n| Rpl_semi_sync_master_timefunc_failures     | 0     | 0     |\n| Rpl_semi_sync_master_tx_avg_wait_time      | 0     | 0     |\n| Rpl_semi_sync_master_tx_wait_time          | 0     | 0     |\n| Rpl_semi_sync_master_tx_waits              | 0     | 0     |\n| Rpl_semi_sync_master_wait_pos_backtraverse | 0     | 0     |\n| Rpl_semi_sync_master_wait_sessions         | 0     | 0     |\n| Rpl_semi_sync_master_yes_tx                | 0     | 0     |\n| Rpl_semi_sync_slave_status                 | OFF   | ON    |\n+--------------------------------------------+-------+-------+\n15 rows in set (0.00 sec)\n\n\n\u3042\u3068\u826f\u304f\u308f\u304b\u3089\u3093\n\n\u53c2\u8003: [tap dev blog - MySQL5.5-MySQL5.6+KeepAlived\u3092\u4f7f\u3063\u305f\u30012\u53f0\u69cb\u6210HA\u578b\u6e96\u540c\u671f\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u4f5c\u308a\u65b9](http://dev.tapweb.co.jp/2011/01/325)\n\n# \u6e96\u5099\n\n* CentOS7\u3067\u8a66\u3057\u305f\u3002\n\n## \u30d7\u30e9\u30b0\u30a4\u30f3\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n```mysql:MariaDB\u30d7\u30ed\u30f3\u30d7\u30c8\nMariaDB [(none)]> INSTALL PLUGIN rpl_semi_sync_master SONAME 'semisync_master.so';\nMariaDB [(none)]> INSTALL PLUGIN rpl_semi_sync_slave SONAME 'semisync_slave.so';\n```\n\n## my.cnf\n\n```bash:/etc/my.cnf.d/my_custom.cnf\n[mysqld]\ncharacter-set-server = utf8\ninnodb_file_per_table = 1\n\n# show variables like slow;\nslow_query_log=ON\nlong_query_time=1\nlog-slow-queries=/var/log/mariadb/slow.log\n\n\nlog-bin = mysql-bin\nrelay-log = relay-bin\n# \u30b5\u30fc\u30d0\u3054\u3068\u306b\u4e00\u610f\u306eID\u3092\u632f\u308b\u3053\u3068\u3002\nserver-id = 101\n# \u5fc5\u9808\u3002\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3067\u53d6\u5f97\u3057\u305f\u30ed\u30b0\u3092\u30d0\u30a4\u30ca\u30ea\u30ed\u30b0\u306b\u3082\u66f8\u304d\u8fbc\u3080\u3002\nlog_slave_updates\n# \u52dd\u624b\u306b\u30b9\u30ec\u30fc\u30d6\u8d77\u52d5\u306f\u3044\u3084\u3002\nskip-slave-start\n# \u30bb\u30df\u30b7\u30f3\u30af\u30ed(\u6e96\u540c\u671f)\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3092\u8a31\u53ef\u3002\nrpl_semi_sync_master_enabled = 1\nrpl_semi_sync_slave_enabled = 1\n```\n\n`systemctl restart mariadb`\n\n\n## \u73fe\u72b6\u78ba\u8a8d\n\n```mysql:MariaDB\u30d7\u30ed\u30f3\u30d7\u30c8\nMariaDB [(none)]> show status like '%semi%';\n+--------------------------------------------+-------+\n| Variable_name                              | Value |\n+--------------------------------------------+-------+\n| Rpl_semi_sync_master_clients               | 0     |\n| Rpl_semi_sync_master_net_avg_wait_time     | 0     |\n| Rpl_semi_sync_master_net_wait_time         | 0     |\n| Rpl_semi_sync_master_net_waits             | 0     |\n| Rpl_semi_sync_master_no_times              | 0     |\n| Rpl_semi_sync_master_no_tx                 | 0     |\n| Rpl_semi_sync_master_status                | ON    |\n| Rpl_semi_sync_master_timefunc_failures     | 0     |\n| Rpl_semi_sync_master_tx_avg_wait_time      | 0     |\n| Rpl_semi_sync_master_tx_wait_time          | 0     |\n| Rpl_semi_sync_master_tx_waits              | 0     |\n| Rpl_semi_sync_master_wait_pos_backtraverse | 0     |\n| Rpl_semi_sync_master_wait_sessions         | 0     |\n| Rpl_semi_sync_master_yes_tx                | 0     |\n| Rpl_semi_sync_slave_status                 | OFF   |\n+--------------------------------------------+-------+\n15 rows in set (0.00 sec)\n```\n\n* `Rpl_semi_sync_master_clients`\u304c0\u3067\u3042\u308b\u3053\u3068\u3092\u899a\u3048\u3066\u304a\u304f\u3002\n\n\n# \u672c\u756a\n\n## \u901a\u5e38MASTER\u5074\n\n\n```mysql:\u901a\u5e38MASTER\u5074\u306b\u3066\u5b9f\u65bd\nGRANT REPLICATION SLAVE ON *.* TO sync@'192.168.100.%' IDENTIFIED BY 'Iatho5zi';\n```\n\n```mysql:binlog\u540d\u3068\u30dd\u30b8\u30b7\u30e7\u30f3\u3092\u78ba\u8a8d\nshow status LIKE 'Binlog_snapshot_file';\nshow status LIKE 'Binlog_snapshot_position';\n```\n\n* binlog\u540d = mysql-bin.000002\n* \u30dd\u30b8\u30b7\u30e7\u30f3 = 397\n\n\u3060\u3063\u305f\u306e\u3067\u4ee5\u4e0b\u30b3\u30de\u30f3\u30c9\u3068\u306a\u308b\u3002\n\n## \u901a\u5e38BACKUP\u5074\n\n```mysql:\nchange master to master_host='192.168.100.110',master_user='sync',master_password='Iatho5zi',master_log_file='mysql-bin.000002',master_log_pos=397;\n```\n\n```mysql:\nstart slave;\n```\n\n## \u78ba\u8a8d\n\n```mysql:master\u3068backup\u4e21\u65b9\u306e\u6bd4\u8f03\u3057\u305f\u56f3\nMariaDB [(none)]> show status like '%semi%';\n+--------------------------------------------+-------+-------+\n| Variable_name                              | master| backup|\n+--------------------------------------------+-------+-------+\n| Rpl_semi_sync_master_clients               | 1     | 0     |\n| Rpl_semi_sync_master_net_avg_wait_time     | 0     | 0     |\n| Rpl_semi_sync_master_net_wait_time         | 0     | 0     |\n| Rpl_semi_sync_master_net_waits             | 0     | 0     |\n| Rpl_semi_sync_master_no_times              | 1     | 0     |\n| Rpl_semi_sync_master_no_tx                 | 1     | 0     |\n| Rpl_semi_sync_master_status                | ON    | ON    |\n| Rpl_semi_sync_master_timefunc_failures     | 0     | 0     |\n| Rpl_semi_sync_master_tx_avg_wait_time      | 0     | 0     |\n| Rpl_semi_sync_master_tx_wait_time          | 0     | 0     |\n| Rpl_semi_sync_master_tx_waits              | 0     | 0     |\n| Rpl_semi_sync_master_wait_pos_backtraverse | 0     | 0     |\n| Rpl_semi_sync_master_wait_sessions         | 0     | 0     |\n| Rpl_semi_sync_master_yes_tx                | 0     | 0     |\n| Rpl_semi_sync_slave_status                 | OFF   | ON    |\n+--------------------------------------------+-------+-------+\n15 rows in set (0.00 sec)\n```\n\n\u3042\u3068\u826f\u304f\u308f\u304b\u3089\u3093\n"}