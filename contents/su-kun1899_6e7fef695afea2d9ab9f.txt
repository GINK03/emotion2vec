{"tags": ["AWS", "S3", "CircleCI"], "context": "\n\n\u6982\u8981\nS3\u3067\u9759\u7684\u30b3\u30f3\u30c6\u30f3\u30c4\u3092\u30db\u30b9\u30c6\u30a3\u30f3\u30b0\u3057\u3066\u3044\u308b\u5834\u5408\u306b\u3001\u305d\u306e\u30b3\u30f3\u30c6\u30f3\u30c4\u306e\u66f4\u65b0\u3092CircleCI\u3092\u4f7f\u3063\u3066\u81ea\u52d5\u5316\u3059\u308b\u65b9\u6cd5\u306b\u3064\u3044\u3066\u307e\u3068\u3081\u307e\u3059\u3002\nMaven\u7b49\u3067\u51fa\u529b\u3057\u305f\u30ec\u30dd\u30fc\u30c8\u306eHTML\u3092S3\u3067\u516c\u958b\u3001\u66f4\u65b0\u3059\u308b\u3088\u3046\u306a\u30b1\u30fc\u30b9\u3092\u60f3\u5b9a\u3057\u3066\u3044\u307e\u3059\u3002\n\n\u524d\u63d0\n\nS3\u30d0\u30b1\u30c3\u30c8\u306f\u4f5c\u6210\u6e08\u3067\u3042\u308b\n\u9759\u7684\u30a6\u30a7\u30d6\u30b5\u30a4\u30c8\u30db\u30b9\u30c6\u30a3\u30f3\u30b0\u304c\u6709\u52b9\u306b\u306a\u3063\u3066\u3044\u308b\n\n\n\u624b\u9806\n\nIAM\u30e6\u30fc\u30b6\u306e\u4f5c\u6210\n\nCircleCI\u7528\u306eIAM\u30e6\u30fc\u30b6\u3092\u4f5c\u6210\u3057\u3066\u3001Access Key Id\u3068Secret Access Key\u3092\u63a7\u3048\u308b\n\u5c02\u7528\u306e\u30e6\u30fc\u30b6\u3092\u4f5c\u6210\u3059\u308b\u3053\u3068\u3092CircleCI\u3082\u63a8\u5968\u3057\u3066\u3044\u308b\n\n\nIAM\u30dd\u30ea\u30b7\u30fc\u306e\u4f5c\u6210\n\nS3\u306e\u7279\u5b9a\u30d0\u30b1\u30c3\u30c8\u306bsync\u3067\u304d\u308b\u30dd\u30ea\u30b7\u30fc\u3092\u4f5c\u6210\u3059\u308b\n\u4f5c\u6210\u3057\u305f\u30dd\u30ea\u30b7\u30fc\u306b\u30e6\u30fc\u30b6\u3092\u7d10\u4ed8\u3051\u308b\n\nPolicy Generator\u306a\u3069\u6d3b\u7528\u3059\u308b\n\n\n\u30b5\u30f3\u30d7\u30eb\n{\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [\n        {\n            \"Sid\": \"StmtXXXXX\",\n            \"Effect\": \"Allow\",\n            \"Action\": [\n                \"s3:DeleteObject\",\n                \"s3:GetObject\",\n                \"s3:ListAllMyBuckets\",\n                \"s3:ListBucket\",\n                \"s3:PutObject\",\n                \"s3:PutObjectAcl\"\n            ],\n            \"Resource\": [\n                \"arn:aws:s3:::your.s3.backet\",\n                \"arn:aws:s3:::your.s3.backet/*\"\n            ]\n        }\n    ]\n}\n\n\u30dd\u30a4\u30f3\u30c8\u3068\u3057\u3066\u306f\u4e0b\u8a18\u3002\n\nResource\u306f\u30d0\u30b1\u30c3\u30c8\u81ea\u4f53\u3068\u30d0\u30b1\u30c3\u30c8\u914d\u4e0b\u306e\u968e\u5c64\u4e21\u65b9\u306e\u6307\u5b9a\u304c\u5fc5\u8981\nPutObjectAcl\u3092Allow\u3059\u308b\u5fc5\u8981\u304c\u308b\n\n\n\u30d0\u30b1\u30c3\u30c8\u30dd\u30ea\u30b7\u30fc\u306e\u4f5c\u6210\n\u3053\u306e\u307e\u307e\u3060\u3068\u5168\u516c\u958b\u3055\u308c\u3066\u3057\u307e\u3046\u306e\u3067\u3001\u5fc5\u8981\u306b\u5fdc\u3058\u3066IP\u5236\u9650\u3092\u304b\u3051\u308b\u3002\n\nS3\u30b3\u30f3\u30bd\u30fc\u30eb\u304b\u3089\u30d0\u30b1\u30c3\u30c8\u30dd\u30ea\u30b7\u30fc\u306e\u4f5c\u6210\u3092\u884c\u3046\nhttps://console.aws.amazon.com/s3/home\n\n\u5bfe\u8c61\u306e\u30d0\u30b1\u30c3\u30c8\u3092\u9078\u629e\u2192[\u30d7\u30ed\u30d1\u30c6\u30a3]\u2192[\u30a2\u30af\u30bb\u30b9\u5236\u9650]\u2192[\u30d0\u30b1\u30c3\u30c8\u30dd\u30ea\u30b7\u30fc\u306e\u7de8\u96c6]\n\n\n\u30b5\u30f3\u30d7\u30eb\n{\n    \"Version\": \"2012-10-17\",\n    \"Id\": \"PolicyXXXXX\",\n    \"Statement\": [\n        {\n            \"Sid\": \"StmtXXXXX\",\n            \"Effect\": \"Deny\",\n            \"Principal\": \"*\",\n            \"Action\": \"s3:GetObject\",\n            \"Resource\": \"arn:aws:s3:::your.s3.backet/*\",\n            \"Condition\": {\n                \"NotIpAddress\": {\n                    \"aws:SourceIp\": [\n                        \"XXX.XXX.XXX.XX\",\n                        \"XXX.XXX.XXX.XX\"\n                    ]\n                }\n            }\n        }\n    ]\n}\n\n\n\u8a31\u53efIP\u4ee5\u5916\u3092Deny\u3059\u308b\n\u8a31\u53efIP\u306bGetObject\u3092\u8a31\u53ef\u3059\u308b\n\u8a31\u53ef\u3068\u62d2\u5426IP\u305d\u308c\u305e\u308c\u3067\u30a2\u30af\u30bb\u30b9\u3057\u3066\u307f\u3066\u3001\u671f\u5f85\u6319\u52d5\u306b\u306a\u308b\u304b\u78ba\u8a8d\u3059\u308b\n\n\n\u8a31\u53efIP\u4ee5\u5916\u3060\u3068403\u304c\u8fd4\u308b\u306f\u305a\n\n\n\n\nCircleCI\u306e\u8a2d\u5b9a\n\nAWS Permissions\u306e\u8a2d\u5b9a\n\n\u5bfe\u8c61\u306e\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u3092\u9078\u629e\n[Project Settings]\u2192[AWS Permissions]\n\u4f5c\u6210\u3057\u305fIAM\u30e6\u30fc\u30b6\u306e\u8a8d\u8a3c\u60c5\u5831\u3092\u5165\u529b\u3059\u308b\n\n\ncircle.yml\u306e\u8a2d\u5b9a\n\naws cli \u3067\u5bfe\u8c61\u306e\u30d5\u30a1\u30a4\u30eb\u3092sync\u3059\u308b\n\n\n\u30b5\u30f3\u30d7\u30eb\nmachine:\n  java:\n    version: oraclejdk8\ndependencies:\n  override:\n    - mvn dependency:resolve\ntest:\n  override:\n    - mvn integration-test\ndeployment:\n  deploy:\n    branch: aws_deploy\n    commands:\n      - mv your_uploadcontents $CIRCLE_ARTIFACTS\n      - aws s3 sync $CIRCLE_ARTIFACTS/your_upload_contents s3://your.s3.backet/ --delete --acl public-read\n\n\u30dd\u30a4\u30f3\u30c8\u306f\u4e0b\u8a18\u306e\u901a\u308a\u3002\n- aws_deploy\u30d6\u30e9\u30f3\u30c1\u306e\u5909\u66f4\u306e\u969b\u30c7\u30d7\u30ed\u30a4\u3059\u308b\n\n\u4f5c\u6210\u3057\u305f\u30b3\u30f3\u30c6\u30f3\u30c4\u3092$CIRCLE_ARTIFACTS\u306b\u79fb\u52d5\n\n\n\u3053\u308c\u306fCircleCI\u306eArtifacts\u3092\u4f7f\u3044\u305f\u3044\u3060\u3051\u3067\u3001S3\u306b\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u3059\u308b\u306e\u3068\u76f4\u63a5\u95a2\u4fc2\u306f\u306a\u3044\n$CIRCLE_ARTIFACTS \u914d\u4e0b\u3092S3\u30d0\u30b1\u30c3\u30c8\u76f4\u4e0b\u3068\u540c\u671f\n\n--delete \u3067\u524a\u9664\u3082\u540c\u671f\n --acl public-read \u3067\u30b3\u30f3\u30c6\u30f3\u30c4\u3092\u516c\u958b\u3059\u308b\n\n\n\u3053\u308c\u3092\u3057\u306a\u3044\u3068\u3001web\u30b5\u30a4\u30c8\u3068\u3057\u3066\u30a2\u30af\u30bb\u30b9\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u3089\u306a\u3044\n\n\n\n\n\n\n\u53c2\u8003\n\ns3cmd sync \u306b\u5fc5\u8981\u306aIAM\u30dd\u30ea\u30b7\u30fc\nS3\u306e\u30a2\u30af\u30bb\u30b9\u30b3\u30f3\u30c8\u30ed\u30fc\u30eb\u307e\u3068\u3081\nAWS S3 \u3067 listObjects \u304c \"AccessDenied\" \u3092\u8fd4\u3059\u5834\u5408\nCircleCI\u304b\u3089S3\u306b\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u3059\u308b\u305f\u3081\u306e\u8a2d\u5b9a\n\nS3\u3067IP\u5236\u9650\ns3cmd sync \u306b\u5fc5\u8981\u306aIAM\u30dd\u30ea\u30b7\u30fc\n\n\n# \u6982\u8981\n\nS3\u3067\u9759\u7684\u30b3\u30f3\u30c6\u30f3\u30c4\u3092\u30db\u30b9\u30c6\u30a3\u30f3\u30b0\u3057\u3066\u3044\u308b\u5834\u5408\u306b\u3001\u305d\u306e\u30b3\u30f3\u30c6\u30f3\u30c4\u306e\u66f4\u65b0\u3092CircleCI\u3092\u4f7f\u3063\u3066\u81ea\u52d5\u5316\u3059\u308b\u65b9\u6cd5\u306b\u3064\u3044\u3066\u307e\u3068\u3081\u307e\u3059\u3002\n\nMaven\u7b49\u3067\u51fa\u529b\u3057\u305f\u30ec\u30dd\u30fc\u30c8\u306eHTML\u3092S3\u3067\u516c\u958b\u3001\u66f4\u65b0\u3059\u308b\u3088\u3046\u306a\u30b1\u30fc\u30b9\u3092\u60f3\u5b9a\u3057\u3066\u3044\u307e\u3059\u3002\n\n# \u524d\u63d0\n\n - S3\u30d0\u30b1\u30c3\u30c8\u306f\u4f5c\u6210\u6e08\u3067\u3042\u308b\n - \u9759\u7684\u30a6\u30a7\u30d6\u30b5\u30a4\u30c8\u30db\u30b9\u30c6\u30a3\u30f3\u30b0\u304c\u6709\u52b9\u306b\u306a\u3063\u3066\u3044\u308b\n\n# \u624b\u9806\n\n## IAM\u30e6\u30fc\u30b6\u306e\u4f5c\u6210\n\n- CircleCI\u7528\u306eIAM\u30e6\u30fc\u30b6\u3092\u4f5c\u6210\u3057\u3066\u3001Access Key Id\u3068Secret Access Key\u3092\u63a7\u3048\u308b\n- \u5c02\u7528\u306e\u30e6\u30fc\u30b6\u3092\u4f5c\u6210\u3059\u308b\u3053\u3068\u3092CircleCI\u3082\u63a8\u5968\u3057\u3066\u3044\u308b\n\n## IAM\u30dd\u30ea\u30b7\u30fc\u306e\u4f5c\u6210\n\n- S3\u306e\u7279\u5b9a\u30d0\u30b1\u30c3\u30c8\u306bsync\u3067\u304d\u308b\u30dd\u30ea\u30b7\u30fc\u3092\u4f5c\u6210\u3059\u308b\n- \u4f5c\u6210\u3057\u305f\u30dd\u30ea\u30b7\u30fc\u306b\u30e6\u30fc\u30b6\u3092\u7d10\u4ed8\u3051\u308b\n- [Policy Generator](http://awspolicygen.s3.amazonaws.com/policygen.html)\u306a\u3069\u6d3b\u7528\u3059\u308b\n\n### \u30b5\u30f3\u30d7\u30eb\n\n```json\n{\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [\n        {\n            \"Sid\": \"StmtXXXXX\",\n            \"Effect\": \"Allow\",\n            \"Action\": [\n                \"s3:DeleteObject\",\n                \"s3:GetObject\",\n                \"s3:ListAllMyBuckets\",\n                \"s3:ListBucket\",\n                \"s3:PutObject\",\n                \"s3:PutObjectAcl\"\n            ],\n            \"Resource\": [\n                \"arn:aws:s3:::your.s3.backet\",\n                \"arn:aws:s3:::your.s3.backet/*\"\n            ]\n        }\n    ]\n}\n```\n\n\u30dd\u30a4\u30f3\u30c8\u3068\u3057\u3066\u306f\u4e0b\u8a18\u3002\n\n - Resource\u306f\u30d0\u30b1\u30c3\u30c8\u81ea\u4f53\u3068\u30d0\u30b1\u30c3\u30c8\u914d\u4e0b\u306e\u968e\u5c64\u4e21\u65b9\u306e\u6307\u5b9a\u304c\u5fc5\u8981\n - PutObjectAcl\u3092Allow\u3059\u308b\u5fc5\u8981\u304c\u308b\n\n## \u30d0\u30b1\u30c3\u30c8\u30dd\u30ea\u30b7\u30fc\u306e\u4f5c\u6210\n\n\u3053\u306e\u307e\u307e\u3060\u3068\u5168\u516c\u958b\u3055\u308c\u3066\u3057\u307e\u3046\u306e\u3067\u3001\u5fc5\u8981\u306b\u5fdc\u3058\u3066IP\u5236\u9650\u3092\u304b\u3051\u308b\u3002\n\n - S3\u30b3\u30f3\u30bd\u30fc\u30eb\u304b\u3089\u30d0\u30b1\u30c3\u30c8\u30dd\u30ea\u30b7\u30fc\u306e\u4f5c\u6210\u3092\u884c\u3046\n https://console.aws.amazon.com/s3/home\n - \u5bfe\u8c61\u306e\u30d0\u30b1\u30c3\u30c8\u3092\u9078\u629e\u2192[\u30d7\u30ed\u30d1\u30c6\u30a3]\u2192[\u30a2\u30af\u30bb\u30b9\u5236\u9650]\u2192[\u30d0\u30b1\u30c3\u30c8\u30dd\u30ea\u30b7\u30fc\u306e\u7de8\u96c6]\n\n### \u30b5\u30f3\u30d7\u30eb\n\n```json\n{\n\t\"Version\": \"2012-10-17\",\n\t\"Id\": \"PolicyXXXXX\",\n\t\"Statement\": [\n\t\t{\n\t\t\t\"Sid\": \"StmtXXXXX\",\n\t\t\t\"Effect\": \"Deny\",\n\t\t\t\"Principal\": \"*\",\n\t\t\t\"Action\": \"s3:GetObject\",\n\t\t\t\"Resource\": \"arn:aws:s3:::your.s3.backet/*\",\n\t\t\t\"Condition\": {\n\t\t\t\t\"NotIpAddress\": {\n\t\t\t\t\t\"aws:SourceIp\": [\n\t\t\t\t\t\t\"XXX.XXX.XXX.XX\",\n\t\t\t\t\t\t\"XXX.XXX.XXX.XX\"\n\t\t\t\t\t]\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t]\n}\n```\n\n- \u8a31\u53efIP\u4ee5\u5916\u3092Deny\u3059\u308b\n- \u8a31\u53efIP\u306bGetObject\u3092\u8a31\u53ef\u3059\u308b\n- \u8a31\u53ef\u3068\u62d2\u5426IP\u305d\u308c\u305e\u308c\u3067\u30a2\u30af\u30bb\u30b9\u3057\u3066\u307f\u3066\u3001\u671f\u5f85\u6319\u52d5\u306b\u306a\u308b\u304b\u78ba\u8a8d\u3059\u308b\n   - \u8a31\u53efIP\u4ee5\u5916\u3060\u3068403\u304c\u8fd4\u308b\u306f\u305a\n\n## CircleCI\u306e\u8a2d\u5b9a\n\n### AWS Permissions\u306e\u8a2d\u5b9a\n\n- \u5bfe\u8c61\u306e\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u3092\u9078\u629e\n- [Project Settings]\u2192[AWS Permissions]\n- \u4f5c\u6210\u3057\u305fIAM\u30e6\u30fc\u30b6\u306e\u8a8d\u8a3c\u60c5\u5831\u3092\u5165\u529b\u3059\u308b\n\n### circle.yml\u306e\u8a2d\u5b9a\n\n- aws cli \u3067\u5bfe\u8c61\u306e\u30d5\u30a1\u30a4\u30eb\u3092sync\u3059\u308b\n\n#### \u30b5\u30f3\u30d7\u30eb\n\n```yml\nmachine:\n  java:\n    version: oraclejdk8\ndependencies:\n  override:\n    - mvn dependency:resolve\ntest:\n  override:\n    - mvn integration-test\ndeployment:\n  deploy:\n    branch: aws_deploy\n    commands:\n      - mv your_uploadcontents $CIRCLE_ARTIFACTS\n      - aws s3 sync $CIRCLE_ARTIFACTS/your_upload_contents s3://your.s3.backet/ --delete --acl public-read\n```\n\n\u30dd\u30a4\u30f3\u30c8\u306f\u4e0b\u8a18\u306e\u901a\u308a\u3002\n- aws_deploy\u30d6\u30e9\u30f3\u30c1\u306e\u5909\u66f4\u306e\u969b\u30c7\u30d7\u30ed\u30a4\u3059\u308b\n\n- \u4f5c\u6210\u3057\u305f\u30b3\u30f3\u30c6\u30f3\u30c4\u3092$CIRCLE_ARTIFACTS\u306b\u79fb\u52d5\n   - \u3053\u308c\u306fCircleCI\u306eArtifacts\u3092\u4f7f\u3044\u305f\u3044\u3060\u3051\u3067\u3001S3\u306b\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u3059\u308b\u306e\u3068\u76f4\u63a5\u95a2\u4fc2\u306f\u306a\u3044\n - $CIRCLE_ARTIFACTS \u914d\u4e0b\u3092S3\u30d0\u30b1\u30c3\u30c8\u76f4\u4e0b\u3068\u540c\u671f\n    - `--delete` \u3067\u524a\u9664\u3082\u540c\u671f\n    -  `--acl public-read` \u3067\u30b3\u30f3\u30c6\u30f3\u30c4\u3092\u516c\u958b\u3059\u308b\n       - \u3053\u308c\u3092\u3057\u306a\u3044\u3068\u3001web\u30b5\u30a4\u30c8\u3068\u3057\u3066\u30a2\u30af\u30bb\u30b9\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u3089\u306a\u3044\n\n# \u53c2\u8003\n\n - [s3cmd sync \u306b\u5fc5\u8981\u306aIAM\u30dd\u30ea\u30b7\u30fc](http://qiita.com/takashi0314/items/d971ee7d5e91ac6dc7e2)\n - [S3\u306e\u30a2\u30af\u30bb\u30b9\u30b3\u30f3\u30c8\u30ed\u30fc\u30eb\u307e\u3068\u3081](http://qiita.com/ryo0301/items/791c0a666feeea0a704c)\n - [AWS S3 \u3067 listObjects \u304c \"AccessDenied\" \u3092\u8fd4\u3059\u5834\u5408](http://qiita.com/macoshita/items/e3316ffc45a8eac1c9c8)\n - [CircleCI\u304b\u3089S3\u306b\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u3059\u308b\u305f\u3081\u306e\u8a2d\u5b9a\n](http://qiita.com/tjinjin/items/c03e39cd46b222d0b3a3)\n - [S3\u3067IP\u5236\u9650](http://qiita.com/you_matz/items/b3885891e576f5604323)\n - [s3cmd sync \u306b\u5fc5\u8981\u306aIAM\u30dd\u30ea\u30b7\u30fc](http://qiita.com/takashi0314/items/d971ee7d5e91ac6dc7e2)\n"}