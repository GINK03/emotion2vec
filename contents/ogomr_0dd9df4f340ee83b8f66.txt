{"context": "Rails\u306fActiveRecord\u3067\u30c7\u30fc\u30bf\u3092\u6c38\u7d9a\u5316\u3057\u307e\u3059\u3002\u305d\u306e\u30c7\u30fc\u30bf\u304c\u72b6\u614b\u3092\u4fdd\u6301\u3059\u308b\u306a\u3089\u30aa\u30fc\u30c8\u30de\u30c8\u30f3\u304c\u6709\u52b9\u3067\u3059\u3002\n\u30aa\u30fc\u30c8\u30de\u30c8\u30f3\u306e\u30e9\u30a4\u30d6\u30e9\u30ea\u306f\u3044\u304f\u3064\u304b\u3042\u308a\u307e\u3059\u304c\u3001\u30b7\u30f3\u30d7\u30eb\u306aStatefulEnum\u3092\u7d39\u4ecb\u3057\u307e\u3059\u3002\n\nenvironment\n\nRuby: 2.3.3\nRails: 5.0.1\nNode.js: 6.9.2\n\n\nfinite automaton\n\u6709\u9650\u30aa\u30fc\u30c8\u30de\u30c8\u30f3\u306f\u6709\u9650\u72b6\u614b\u6a5f\u68b0(finite state machine)\u3068\u3082\u547c\u3070\u308c\u3001\u6709\u9650\u500b\u306e \u72b6\u614b(state) \u3068 \u9077\u79fb\u306e\u898f\u5247(rule) \u3068 \u5165\u529b(input) \u3092\u7d44\u307f\u5408\u308f\u305b\u305f\u30e2\u30c7\u30eb\u3067\u3059\u3002\u72b6\u614b\u9077\u79fb\u304c\u7406\u89e3\u3057\u3084\u3059\u304f\u3001\u307e\u305f\u63a8\u6e2c\u3057\u3084\u3059\u304f\u306a\u308a\u307e\u3059\u3002\n\n\u72b6\u614b1\u3067\u6587\u5b57a\u3092\u8aad\u3080\u3068\u3001\u72b6\u614b2\u306b\u79fb\u52d5\u3059\u308b\u3002\n\u72b6\u614b2\u3067\u6587\u5b57a\u3092\u8aad\u3080\u3068\u3001\u72b6\u614b1\u306b\u79fb\u52d5\u3059\u308b\u3002\n\n\n\n\u30a2\u30f3\u30c0\u30fc\u30b9\u30bf\u30f3\u30c7\u30a3\u30f3\u30b0 \u30b3\u30f3\u30d4\u30e5\u30c6\u30fc\u30b7\u30e7\u30f3\u3088\u308a\n\n\nrails new\n\u307e\u305a\u3001Rails\u3067\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n\nrails generate model \u30b3\u30de\u30f3\u30c9\u3067 user \u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n$ rails new rails_stateful_enum\n$ cd rails_stateful_enum/\n$ rails generate model user name status:integer --no-timestamps\n\n\n\ncreate_table \u306e status \u306b default: 0 \u3092\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\n\ndb/migrate/[datetime]_create_users.rb\nclass CreateUsers < ActiveRecord::Migration[5.0]\n  def change\n    create_table :users do |t|\n      t.string :name\n      t.integer :status, default: 0\n    end\n  end\nend\n\n\n\n\nrails db:migrate \u30b3\u30de\u30f3\u30c9\u3067\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n$ rails db:migrate\n\n\nenum\n\u6b21\u306f\u3001ActiveRecord::Enum\u306e\u304a\u3055\u3089\u3044\u3067\u3059\u3002\n\nActiveRecord \u3067\u5217\u6319\u578b\u3092\u5229\u7528\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\nenum \u306b \u5c5e\u6027\u306e\u540d\u524d \u3068 \u5c5e\u6027\u306e\u5024 \u3092\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\n\napp/models/user.rb\nclass User < ApplicationRecord\n  enum status: {active: 0, inactive: 1, closed: 2}\nend\n\n\n\n\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u30e1\u30bd\u30c3\u30c9\u306b \u5c5e\u6027\u306e\u5024\u306e\u78ba\u8a8d \u3084 \u5c5e\u6027\u306e\u5024\u306e\u66f4\u65b0 \u304c\u8ffd\u52a0\u3055\u308c\u307e\u3059\u3002\n\n$ rails console\n> user = User.create\n# INSERT INTO \"users\" DEFAULT VALUES\n=> #<User id: 1, name: nil, status: \"active\">\n\n> user.status\n=> \"active\"\n\n# \u5c5e\u6027\u306e\u5024\u306e\u78ba\u8a8d\n> user.active?\n=> true\n\n# \u5c5e\u6027\u306e\u5024\u306e\u66f4\u65b0\n> user.inactive!\n# UPDATE \"users\" SET \"status\" = ? WHERE \"users\".\"id\" = ?  [[\"status\", 1], [\"id\", 1]]\n=> true\n\n> user.status\n=> \"inactive\"\n\n\n\u30af\u30e9\u30b9\u30e1\u30bd\u30c3\u30c9\u306b \u5c5e\u6027\u306e\u5024\u306e\u4e00\u89a7 \u3084 \u5c5e\u6027\u306e\u5024\u306e\u30b9\u30b3\u30fc\u30d7 \u304c\u8ffd\u52a0\u3055\u308c\u307e\u3059\u3002\n\n$ rails console\n\n# \u5c5e\u6027\u306e\u5024\u306e\u4e00\u89a7\n> User.statuses\n=> {\"active\"=>0, \"inactive\"=>1, \"closed\"=>2}\n\n# \u5c5e\u6027\u306e\u5024\u306e\u30b9\u30b3\u30fc\u30d7\n> User.active\n# SELECT \"users\".* FROM \"users\" WHERE \"users\".\"state\" = ?  [[\"state\", 0]]\n\n\nstateful enum\n\u305d\u3057\u3066\u3001StatefulEnum \u3067\u30aa\u30fc\u30c8\u30de\u30c8\u30f3\u3092\u5b9f\u88c5\u3057\u307e\u3059\u3002\n\n\nbundle \u30b3\u30de\u30f3\u30c9\u3067 stateful_enum \u3092\u8ffd\u52a0\u3057\u307e\u3059\u3002\n\n\n\ngraphviz \u306f\u56f3\u5f62\u306e\u51fa\u529b\u306b\u5229\u7528\u3057\u307e\u3059\u3002\n\n\n\n\nGemfile\ngem 'stateful_enum'\ngem 'ruby-graphviz'\n\n\n$ bundle\n\n\n\nenum \u306b\u30d6\u30ed\u30c3\u30af\u3067 \u30a4\u30d9\u30f3\u30c8(event) \u3068 \u9077\u79fb(transition) \u3092\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\n\n\n\u5c5e\u6027\u306e\u5024 \u304c\u30aa\u30fc\u30c8\u30de\u30c8\u30f3\u306e \u72b6\u614b(state)\n\n\n\u30a4\u30d9\u30f3\u30c8(event) \u304c\u30aa\u30fc\u30c8\u30de\u30c8\u30f3\u306e \u5165\u529b(input)\n\n\n\u9077\u79fb(transition) \u30aa\u30fc\u30c8\u30de\u30c8\u30f3\u306e \u898f\u5247(rule)\n\n\n\n\n\napp/models/user.rb\nclass User < ApplicationRecord\n  enum status: {active: 0, inactive: 1, closed: 2} do\n    event :disable do\n      transition :active => :inactive\n    end\n\n    event :enable do\n      transition :inactive => :active\n    end\n\n    event :close do\n      transition [:active, :inactive] => :closed\n    end\n  end\nend\n\n\n\n\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u30e1\u30bd\u30c3\u30c9\u306b \u30a4\u30d9\u30f3\u30c8\u306e \u5c5e\u6027\u306e\u5024\u306e\u66f4\u65b0 \u304c\u8ffd\u52a0\u3055\u308c\u307e\u3059\u3002\n\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u30e1\u30bd\u30c3\u30c9\u306b \u30a4\u30d9\u30f3\u30c8\u306e\u53ef\u80fd\u3092\u78ba\u8a8d \u3084 \u30a4\u30d9\u30f3\u30c8\u306e\u9077\u79fb\u5f8c\u306e\u5024 \u304c\u8ffd\u52a0\u3055\u308c\u307e\u3059\u3002\n\n$ rails console\n> user = User.create\n\n# \u5c5e\u6027\u306e\u5024\u306e\u66f4\u65b0\n> user.disable\n# UPDATE \"users\" SET \"status\" = ? WHERE \"users\".\"id\" = ?  [[\"status\", 1], [\"id\", 2]]\n=> true\n\n> user.status\n=> \"inactive\"\n\n# \u30a4\u30d9\u30f3\u30c8\u306e\u53ef\u80fd\u3092\u78ba\u8a8d\n> user.can_enable?\n=> true\n\n# \u30a4\u30d9\u30f3\u30c8\u306e\u9077\u79fb\u5f8c\u306e\u5024\n> user.enable_transition\n=> :active\n\n\ndiagram\n\n\u72b6\u614b\u9077\u79fb\u56f3\u3092\u51fa\u529b\u3057\u305f\u308a\u3001PlantUML\u306e\u30c6\u30ad\u30b9\u30c8\u3092\u51fa\u529b\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\n$ mkdir -p doc/diagrams\n$ DEST_DIR=doc/diagrams bin/rails generate stateful_enum:graph user\n$ DEST_DIR=doc/diagrams bin/rails generate stateful_enum:plantuml user\n\n\n\nstateful_enum:graph \u306f doc/diagrams/User.png \u306b\u51fa\u529b\u3055\u308c\u307e\u3059\u3002\n\n\n\n\nstateful_enum:plantuml \u306f doc/diagrams/User.puml \u306b\u51fa\u529b\u3055\u308c\u307e\u3059\u3002\n\n\ndoc/diagrams/User.puml\n[*] --> active\nactive --> inactive :disable\ninactive --> active :enable\nactive --> closed :close\ninactive --> closed :close\nclosed --> [*]\n\n\n\ngulp\n\u72b6\u614b\u9077\u79fb\u56f3\u306f gulp \u3067\u81ea\u52d5\u5316\u306b\u3059\u308b\u3068\u6357\u308a\u307e\u3059\u3002\n$ yarn init --yes\n\n\n\nscripts \u306e start \u306b gulp \u3092\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\n\npackage.json\n{\n  \"name\": \"rails_stateful_enum\",\n  \"version\": \"1.0.0\",\n  \"main\": \"index.js\",\n  \"license\": \"MIT\",\n  \"scripts\": {\n    \"start\": \"gulp\"\n  }\n}\n\n\n$ yarn add --dev gulp gulp-watch\n$ touch gulpfile.js\n\n\n\ngulp-watch \u306f\u65b0\u898f\u30d5\u30a1\u30a4\u30eb\u3082\u76e3\u8996\u5bfe\u8c61\u306a\u306e\u3067\u4fbf\u5229\u3067\u3059\u3002\n\n\ngulpfile.js\nconst gulp = require('gulp')\nconst gutil = require('gulp-util')\nconst watch = require('gulp-watch')\nconst spawn = require('child_process').spawn\n\ngulp.task('watch', () => {\n  watch('app/models/**/*.rb', (event) => {\n    gutil.log(event.path.replace(event.cwd, 'watching: '))\n    spawn('DEST_DIR=doc/diagrams bin/rails generate stateful_enum:plantuml', [event.stem], {shell:true})\n  })\n\n  watch('doc/**/*.puml', (event) => {\n    console.log(event.contents.toString())\n  })\n})\n\ngulp.task('default', ['watch'])\n\n\n\n\nyarn start \u30b3\u30de\u30f3\u30c9\u3067\u72b6\u614b\u9077\u79fb\u56f3\u304c\u81ea\u52d5\u3067\u51fa\u529b\u3055\u308c\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3057\u305f\u3002 \n\n$ yarn start\n\n\nAtom \u306f PlantUML Viewer \u3067 PlantUML \u306e\u30c6\u30ad\u30b9\u30c8\u3092\u72b6\u614b\u9077\u79fb\u56f3\u306b\u51fa\u529b\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\n\ngulp \u3068\u7d44\u307f\u5408\u308f\u305b\u3066\u3001\u30b3\u30fc\u30c9\u3092\u4fee\u6b63\u3059\u308b\u3068\u72b6\u614b\u9077\u79fb\u56f3\u304c\u5909\u66f4\u3055\u308c\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3057\u305f\u3002\n\n\n\n\n\ndraw uml\n\nRails \u3067\u3082 PlantUML Viewer \u3067 PlantUML \u3092\u8868\u793a\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002 \n\n\nGemfile\ngem 'draw_uml'\n\n\n\n\nroutes \u306b Engine \u3092\u30de\u30a6\u30f3\u30c8\u3057\u307e\u3059\u3002\n\n\nconfig/routes.rb\nRails.application.routes.draw do\n  mount DrawUml::Engine, at: '/rails/draw/uml' if Rails.env.development?\nend\n\n\n$ bundle\n$ rails server\n\n\n\nhttp://localhost:3000/rails/draw/uml/User \u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3068\u72b6\u614b\u9077\u79fb\u56f3\u304c\u8868\u793a\u3055\u308c\u307e\u3059\u3002\n\n\nbrowser sync\n\ngulp \u3067 browser-sync \u3092\u5229\u7528\u3059\u308b\u3068\u3001\u72b6\u614b\u9077\u79fb\u56f3\u304c\u81ea\u52d5\u3067\u8868\u793a\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\n$ yarn add --dev browser-sync\n\n\n\nlocalhost:3000 \u3092 proxy \u306b\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\n\ngulpfile.js\nconst gulp = require('gulp')\nconst gutil = require('gulp-util')\nconst watch = require('gulp-watch')\nconst spawn = require('child_process').spawn\nconst browserSync = require('browser-sync')\n\ngulp.task('browser-sync', () => {\n  return browserSync.init(null, {\n    proxy: 'localhost:3000',\n    reloadDelay: 1000\n  })\n})\n\ngulp.task('watch', () => {\n  watch('app/models/**/*.rb', (event) => {\n    gutil.log(event.path.replace(event.cwd, 'watching: '))\n    spawn('DEST_DIR=doc/diagrams bin/rails generate stateful_enum:plantuml', [event.stem], {shell:true})\n    browserSync.reload()\n  })\n\n  watch('doc/**/*.puml', (event) => {\n    console.log(event.contents.toString())\n  })\n})\n\ngulp.task('default', ['browser-sync', 'watch'])\n\n\n\n\nyarn start \u30b3\u30de\u30f3\u30c9\u3067\u72b6\u614b\u9077\u79fb\u56f3\u304c\u81ea\u52d5\u3067\u51fa\u529b\u3055\u308c\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3057\u305f\u3002 \n\n\nhttp://localhost:3001/rails/draw/uml/User\n\n\n\n$ yarn start\n\n\u81ea\u52d5\u5316\u306f\u697d\u3057\u304f\u3066\u697d\u3067\u3059\u306d\u3002 \n\nTips\n\ndraw smd\nDrawUML \u4ee5\u5916\u306b DrawERD \u3068 DrawSMD \u3092\u5229\u7528\u3059\u308b\u3068 Rails \u3067 ER\u56f3 \u3084 \u72b6\u614b\u9077\u79fb\u56f3 \u3092\u51fa\u529b\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\nGemfile\ngem 'draw_erd'\ngem 'draw_smd'\ngem 'state_machine'\n\n\n\n\nroutes \u306b Engine \u3092\u30de\u30a6\u30f3\u30c8\u3057\u307e\u3059\u3002\n\n\nconfig/routes.rb\nRails.application.routes.draw do\n  mount DrawUml::Engine, at: '/rails/draw/uml' if Rails.env.development?\n  mount DrawErd::Engine, at: '/rails/draw/erd' if Rails.env.development?\n  mount DrawSmd::Engine, at: '/rails/draw/smd' if Rails.env.development?\nend\n\n\n$ bundle\n$ rails server\n\n\n\nhttp://localhost:3001/rails/draw/erd \u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3068ER\u56f3\u304c\u8868\u793a\u3055\u308c\u307e\u3059\u3002\n\nhttp://localhost:3001/rails/draw/smd \u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3068\u72b6\u614b\u9077\u79fb\u56f3\u304c\u8868\u793a\u3055\u308c\u307e\u3059\u3002\n\n\nstate machine\n\n\nrails generate model \u30b3\u30de\u30f3\u30c9\u3067 group \u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n$ rails generate model group name state\n$ rails generate model member user:references group:references\n$ rails db:migrate\n\n\n\nstate_machine \u306e\u30d6\u30ed\u30c3\u30af\u306f StatefulEnum \u3068\u540c\u3058\u3067\u3059\u3002\n\n\napp/models/group.rb\nclass Group < ApplicationRecord\n  has_many :users, through: :members\n  has_many :members\n\n  state_machine :state, initial: :active do\n    event :disable do\n      transition :active => :inactive\n    end\n\n    event :enable do\n      transition :inactive => :active\n    end\n\n    event :close do\n      transition [:active, :inactive] => :closed\n    end\n  end\nend\n\n\nenjoy automaton\n\n[Rails\u306fActiveRecord](http://qiita.com/ogomr/items/1c5844b82daebd0580c2)\u3067\u30c7\u30fc\u30bf\u3092\u6c38\u7d9a\u5316\u3057\u307e\u3059\u3002\u305d\u306e\u30c7\u30fc\u30bf\u304c\u72b6\u614b\u3092\u4fdd\u6301\u3059\u308b\u306a\u3089\u30aa\u30fc\u30c8\u30de\u30c8\u30f3\u304c\u6709\u52b9\u3067\u3059\u3002\n\u30aa\u30fc\u30c8\u30de\u30c8\u30f3\u306e\u30e9\u30a4\u30d6\u30e9\u30ea\u306f\u3044\u304f\u3064\u304b\u3042\u308a\u307e\u3059\u304c\u3001\u30b7\u30f3\u30d7\u30eb\u306a[StatefulEnum](https://github.com/amatsuda/stateful_enum)\u3092\u7d39\u4ecb\u3057\u307e\u3059\u3002\n\n## environment\n\n* Ruby: 2.3.3\n* Rails: 5.0.1\n* Node.js: 6.9.2\n\n## finite automaton\n\n\u6709\u9650\u30aa\u30fc\u30c8\u30de\u30c8\u30f3\u306f\u6709\u9650\u72b6\u614b\u6a5f\u68b0(finite state machine)\u3068\u3082\u547c\u3070\u308c\u3001\u6709\u9650\u500b\u306e *\u72b6\u614b(state)* \u3068 *\u9077\u79fb\u306e\u898f\u5247(rule)* \u3068 *\u5165\u529b(input)* \u3092\u7d44\u307f\u5408\u308f\u305b\u305f\u30e2\u30c7\u30eb\u3067\u3059\u3002\u72b6\u614b\u9077\u79fb\u304c\u7406\u89e3\u3057\u3084\u3059\u304f\u3001\u307e\u305f\u63a8\u6e2c\u3057\u3084\u3059\u304f\u306a\u308a\u307e\u3059\u3002\n\n* \u72b6\u614b1\u3067\u6587\u5b57a\u3092\u8aad\u3080\u3068\u3001\u72b6\u614b2\u306b\u79fb\u52d5\u3059\u308b\u3002\n* \u72b6\u614b2\u3067\u6587\u5b57a\u3092\u8aad\u3080\u3068\u3001\u72b6\u614b1\u306b\u79fb\u52d5\u3059\u308b\u3002\n\n![](https://dl.dropboxusercontent.com/u/14690051/images/notes/lang/ruby/stateful_enum/finite_automaton.png)\n\n> [\u30a2\u30f3\u30c0\u30fc\u30b9\u30bf\u30f3\u30c7\u30a3\u30f3\u30b0 \u30b3\u30f3\u30d4\u30e5\u30c6\u30fc\u30b7\u30e7\u30f3](https://www.oreilly.co.jp/books/9784873116976/)\u3088\u308a\n\n## rails new\n\n\u307e\u305a\u3001[Rails](http://rubyonrails.org/)\u3067\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n* `rails generate model` \u30b3\u30de\u30f3\u30c9\u3067 *user* \u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n```bash\n$ rails new rails_stateful_enum\n$ cd rails_stateful_enum/\n$ rails generate model user name status:integer --no-timestamps\n```\n\n* `create_table` \u306e `status` \u306b `default: 0` \u3092\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\n```ruby:db/migrate/[datetime]_create_users.rb\nclass CreateUsers < ActiveRecord::Migration[5.0]\n  def change\n    create_table :users do |t|\n      t.string :name\n      t.integer :status, default: 0\n    end\n  end\nend\n```\n\n* `rails db:migrate` \u30b3\u30de\u30f3\u30c9\u3067\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n```bash\n$ rails db:migrate\n```\n\n## enum\n\n\u6b21\u306f\u3001[ActiveRecord::Enum](http://api.rubyonrails.org/classes/ActiveRecord/Enum.html)\u306e\u304a\u3055\u3089\u3044\u3067\u3059\u3002\n\n* ActiveRecord \u3067\u5217\u6319\u578b\u3092\u5229\u7528\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n* `enum` \u306b *\u5c5e\u6027\u306e\u540d\u524d* \u3068 *\u5c5e\u6027\u306e\u5024* \u3092\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\n```ruby:app/models/user.rb\nclass User < ApplicationRecord\n  enum status: {active: 0, inactive: 1, closed: 2}\nend\n```\n\n* \u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u30e1\u30bd\u30c3\u30c9\u306b **\u5c5e\u6027\u306e\u5024\u306e\u78ba\u8a8d** \u3084 **\u5c5e\u6027\u306e\u5024\u306e\u66f4\u65b0** \u304c\u8ffd\u52a0\u3055\u308c\u307e\u3059\u3002\n\n```bash\n$ rails console\n> user = User.create\n# INSERT INTO \"users\" DEFAULT VALUES\n=> #<User id: 1, name: nil, status: \"active\">\n\n> user.status\n=> \"active\"\n\n# \u5c5e\u6027\u306e\u5024\u306e\u78ba\u8a8d\n> user.active?\n=> true\n\n# \u5c5e\u6027\u306e\u5024\u306e\u66f4\u65b0\n> user.inactive!\n# UPDATE \"users\" SET \"status\" = ? WHERE \"users\".\"id\" = ?  [[\"status\", 1], [\"id\", 1]]\n=> true\n\n> user.status\n=> \"inactive\"\n```\n\n* \u30af\u30e9\u30b9\u30e1\u30bd\u30c3\u30c9\u306b **\u5c5e\u6027\u306e\u5024\u306e\u4e00\u89a7** \u3084 **\u5c5e\u6027\u306e\u5024\u306e\u30b9\u30b3\u30fc\u30d7** \u304c\u8ffd\u52a0\u3055\u308c\u307e\u3059\u3002\n\n```bash\n$ rails console\n\n# \u5c5e\u6027\u306e\u5024\u306e\u4e00\u89a7\n> User.statuses\n=> {\"active\"=>0, \"inactive\"=>1, \"closed\"=>2}\n\n# \u5c5e\u6027\u306e\u5024\u306e\u30b9\u30b3\u30fc\u30d7\n> User.active\n# SELECT \"users\".* FROM \"users\" WHERE \"users\".\"state\" = ?  [[\"state\", 0]]\n```\n\n## stateful enum\n\n\u305d\u3057\u3066\u3001StatefulEnum \u3067\u30aa\u30fc\u30c8\u30de\u30c8\u30f3\u3092\u5b9f\u88c5\u3057\u307e\u3059\u3002\n\n* `bundle` \u30b3\u30de\u30f3\u30c9\u3067 `stateful_enum` \u3092\u8ffd\u52a0\u3057\u307e\u3059\u3002\n\t* `graphviz` \u306f\u56f3\u5f62\u306e\u51fa\u529b\u306b\u5229\u7528\u3057\u307e\u3059\u3002\n\n```ruby:Gemfile\ngem 'stateful_enum'\ngem 'ruby-graphviz'\n```\n\n```bash\n$ bundle\n```\n\n* `enum` \u306b\u30d6\u30ed\u30c3\u30af\u3067 *\u30a4\u30d9\u30f3\u30c8(event)* \u3068 *\u9077\u79fb(transition)* \u3092\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\t* *\u5c5e\u6027\u306e\u5024* \u304c\u30aa\u30fc\u30c8\u30de\u30c8\u30f3\u306e *\u72b6\u614b(state)*\n\t* *\u30a4\u30d9\u30f3\u30c8(event)* \u304c\u30aa\u30fc\u30c8\u30de\u30c8\u30f3\u306e *\u5165\u529b(input)*\n\t* *\u9077\u79fb(transition)* \u30aa\u30fc\u30c8\u30de\u30c8\u30f3\u306e *\u898f\u5247(rule)*\n\n```ruby:app/models/user.rb\nclass User < ApplicationRecord\n  enum status: {active: 0, inactive: 1, closed: 2} do\n    event :disable do\n      transition :active => :inactive\n    end\n\n    event :enable do\n      transition :inactive => :active\n    end\n\n    event :close do\n      transition [:active, :inactive] => :closed\n    end\n  end\nend\n```\n\n* \u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u30e1\u30bd\u30c3\u30c9\u306b \u30a4\u30d9\u30f3\u30c8\u306e **\u5c5e\u6027\u306e\u5024\u306e\u66f4\u65b0** \u304c\u8ffd\u52a0\u3055\u308c\u307e\u3059\u3002\n* \u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u30e1\u30bd\u30c3\u30c9\u306b **\u30a4\u30d9\u30f3\u30c8\u306e\u53ef\u80fd\u3092\u78ba\u8a8d** \u3084 **\u30a4\u30d9\u30f3\u30c8\u306e\u9077\u79fb\u5f8c\u306e\u5024**\u0010 \u304c\u8ffd\u52a0\u3055\u308c\u307e\u3059\u3002\n\n```bash\n$ rails console\n> user = User.create\n\n# \u5c5e\u6027\u306e\u5024\u306e\u66f4\u65b0\n> user.disable\n# UPDATE \"users\" SET \"status\" = ? WHERE \"users\".\"id\" = ?  [[\"status\", 1], [\"id\", 2]]\n=> true\n\n> user.status\n=> \"inactive\"\n\n# \u30a4\u30d9\u30f3\u30c8\u306e\u53ef\u80fd\u3092\u78ba\u8a8d\n> user.can_enable?\n=> true\n\n# \u30a4\u30d9\u30f3\u30c8\u306e\u9077\u79fb\u5f8c\u306e\u5024\n> user.enable_transition\n=> :active\n```\n\n### diagram\n\n* \u72b6\u614b\u9077\u79fb\u56f3\u3092\u51fa\u529b\u3057\u305f\u308a\u3001PlantUML\u306e\u30c6\u30ad\u30b9\u30c8\u3092\u51fa\u529b\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\n```bash\n$ mkdir -p doc/diagrams\n$ DEST_DIR=doc/diagrams bin/rails generate stateful_enum:graph user\n$ DEST_DIR=doc/diagrams bin/rails generate stateful_enum:plantuml user\n```\n\n* `stateful_enum:graph` \u306f `doc/diagrams/User.png` \u306b\u51fa\u529b\u3055\u308c\u307e\u3059\u3002\n\n![graphviz.png](https://dl.dropboxusercontent.com/u/14690051/images/notes/lang/ruby/stateful_enum/graphviz.png)\n\n\n* `stateful_enum:plantuml` \u306f `doc/diagrams/User.puml` \u306b\u51fa\u529b\u3055\u308c\u307e\u3059\u3002\n\n```doc/diagrams/User.puml\n[*] --> active\nactive --> inactive :disable\ninactive --> active :enable\nactive --> closed :close\ninactive --> closed :close\nclosed --> [*]\n```\n\n### gulp\n\n\u72b6\u614b\u9077\u79fb\u56f3\u306f [gulp](http://gulpjs.com/) \u3067\u81ea\u52d5\u5316\u306b\u3059\u308b\u3068\u6357\u308a\u307e\u3059\u3002\n\n```bash\n$ yarn init --yes\n```\n\n* `scripts` \u306e `start` \u306b `gulp` \u3092\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\n```javascript:package.json\n{\n  \"name\": \"rails_stateful_enum\",\n  \"version\": \"1.0.0\",\n  \"main\": \"index.js\",\n  \"license\": \"MIT\",\n  \"scripts\": {\n    \"start\": \"gulp\"\n  }\n}\n```\n\n```bash\n$ yarn add --dev gulp gulp-watch\n$ touch gulpfile.js\n```\n\n* [gulp-watch](https://github.com/floatdrop/gulp-watch) \u306f\u65b0\u898f\u30d5\u30a1\u30a4\u30eb\u3082\u76e3\u8996\u5bfe\u8c61\u306a\u306e\u3067\u4fbf\u5229\u3067\u3059\u3002\n\n```javascript:gulpfile.js\nconst gulp = require('gulp')\nconst gutil = require('gulp-util')\nconst watch = require('gulp-watch')\nconst spawn = require('child_process').spawn\n\ngulp.task('watch', () => {\n  watch('app/models/**/*.rb', (event) => {\n    gutil.log(event.path.replace(event.cwd, 'watching: '))\n    spawn('DEST_DIR=doc/diagrams bin/rails generate stateful_enum:plantuml', [event.stem], {shell:true})\n  })\n\n  watch('doc/**/*.puml', (event) => {\n    console.log(event.contents.toString())\n  })\n})\n\ngulp.task('default', ['watch'])\n```\n\n* `yarn start` \u30b3\u30de\u30f3\u30c9\u3067\u72b6\u614b\u9077\u79fb\u56f3\u304c\u81ea\u52d5\u3067\u51fa\u529b\u3055\u308c\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3057\u305f\u3002 \n\n```bash\n$ yarn start\n```\n\n* Atom \u306f [PlantUML Viewer](https://atom.io/packages/plantuml-viewer) \u3067 PlantUML \u306e\u30c6\u30ad\u30b9\u30c8\u3092\u72b6\u614b\u9077\u79fb\u56f3\u306b\u51fa\u529b\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n  * gulp \u3068\u7d44\u307f\u5408\u308f\u305b\u3066\u3001\u30b3\u30fc\u30c9\u3092\u4fee\u6b63\u3059\u308b\u3068\u72b6\u614b\u9077\u79fb\u56f3\u304c\u5909\u66f4\u3055\u308c\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3057\u305f\u3002\n\n[![https://gyazo.com/b4114b9b70bd24e9e458ed5373bb22b7](https://i.gyazo.com/b4114b9b70bd24e9e458ed5373bb22b7.gif)](https://gyazo.com/b4114b9b70bd24e9e458ed5373bb22b7)\n\n## draw uml\n\n* Rails \u3067\u3082 [PlantUML Viewer](http://ogom.github.io/draw_uml/) \u3067 PlantUML \u3092\u8868\u793a\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002 \n\n```ruby:Gemfile\ngem 'draw_uml'\n```\n\n* `routes` \u306b `Engine` \u3092\u30de\u30a6\u30f3\u30c8\u3057\u307e\u3059\u3002\n\n```ruby:config/routes.rb\nRails.application.routes.draw do\n  mount DrawUml::Engine, at: '/rails/draw/uml' if Rails.env.development?\nend\n```\n\n```bash\n$ bundle\n$ rails server\n```\n\n* http://localhost:3000/rails/draw/uml/User \u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3068\u72b6\u614b\u9077\u79fb\u56f3\u304c\u8868\u793a\u3055\u308c\u307e\u3059\u3002\n\n###  browser sync\n\n* gulp \u3067 [browser-sync](https://browsersync.io/) \u3092\u5229\u7528\u3059\u308b\u3068\u3001\u72b6\u614b\u9077\u79fb\u56f3\u304c\u81ea\u52d5\u3067\u8868\u793a\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\n```bash\n$ yarn add --dev browser-sync\n```\n\n* `localhost:3000` \u3092 `proxy` \u306b\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\n```javascript:gulpfile.js\nconst gulp = require('gulp')\nconst gutil = require('gulp-util')\nconst watch = require('gulp-watch')\nconst spawn = require('child_process').spawn\nconst browserSync = require('browser-sync')\n\ngulp.task('browser-sync', () => {\n  return browserSync.init(null, {\n    proxy: 'localhost:3000',\n    reloadDelay: 1000\n  })\n})\n\ngulp.task('watch', () => {\n  watch('app/models/**/*.rb', (event) => {\n    gutil.log(event.path.replace(event.cwd, 'watching: '))\n    spawn('DEST_DIR=doc/diagrams bin/rails generate stateful_enum:plantuml', [event.stem], {shell:true})\n    browserSync.reload()\n  })\n\n  watch('doc/**/*.puml', (event) => {\n    console.log(event.contents.toString())\n  })\n})\n\ngulp.task('default', ['browser-sync', 'watch'])\n```\n\n* `yarn start` \u30b3\u30de\u30f3\u30c9\u3067\u72b6\u614b\u9077\u79fb\u56f3\u304c\u81ea\u52d5\u3067\u51fa\u529b\u3055\u308c\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3057\u305f\u3002 \n\t* http://localhost:3001/rails/draw/uml/User\n\t\n```bash\n$ yarn start\n```\n\n\u81ea\u52d5\u5316\u306f\u697d\u3057\u304f\u3066\u697d\u3067\u3059\u306d\u3002:blush: \n\n# Tips\n\n## draw smd\n\n[DrawUML](http://ogom.github.io/draw_uml/) \u4ee5\u5916\u306b [DrawERD](http://ogom.github.io/draw_erd/) \u3068 [DrawSMD](http://ogom.github.io/draw_smd/) \u3092\u5229\u7528\u3059\u308b\u3068 Rails \u3067 ER\u56f3 \u3084 \u72b6\u614b\u9077\u79fb\u56f3 \u3092\u51fa\u529b\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\n```ruby:Gemfile\ngem 'draw_erd'\ngem 'draw_smd'\ngem 'state_machine'\n```\n\n* `routes` \u306b `Engine` \u3092\u30de\u30a6\u30f3\u30c8\u3057\u307e\u3059\u3002\n\n```ruby:config/routes.rb\nRails.application.routes.draw do\n  mount DrawUml::Engine, at: '/rails/draw/uml' if Rails.env.development?\n  mount DrawErd::Engine, at: '/rails/draw/erd' if Rails.env.development?\n  mount DrawSmd::Engine, at: '/rails/draw/smd' if Rails.env.development?\nend\n```\n\n```bash\n$ bundle\n$ rails server\n```\n\n* http://localhost:3001/rails/draw/erd \u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3068ER\u56f3\u304c\u8868\u793a\u3055\u308c\u307e\u3059\u3002\n* http://localhost:3001/rails/draw/smd \u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3068\u72b6\u614b\u9077\u79fb\u56f3\u304c\u8868\u793a\u3055\u308c\u307e\u3059\u3002\n\n## state machine\n\n* `rails generate model` \u30b3\u30de\u30f3\u30c9\u3067 *group* \u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n```bash\n$ rails generate model group name state\n$ rails generate model member user:references group:references\n$ rails db:migrate\n```\n\n* [state_machine](https://github.com/pluginaweek/state_machine) \u306e\u30d6\u30ed\u30c3\u30af\u306f [StatefulEnum](https://github.com/amatsuda/stateful_enum) \u3068\u540c\u3058\u3067\u3059\u3002\n\n```ruby:app/models/group.rb\nclass Group < ApplicationRecord\n  has_many :users, through: :members\n  has_many :members\n\n  state_machine :state, initial: :active do\n    event :disable do\n      transition :active => :inactive\n    end\n\n    event :enable do\n      transition :inactive => :active\n    end\n\n    event :close do\n      transition [:active, :inactive] => :closed\n    end\n  end\nend\n```\n\n*enjoy automaton*\n", "tags": ["Rails", "gulp", "uml"]}