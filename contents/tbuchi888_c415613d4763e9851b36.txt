{"context": "\n\nServerspec run by ansible-playbook and it use hostvars variables of Ansible.\n\u3053\u3061\u3089\u306fAnsible Advent Calendar 2016\u306e25\u65e5\u76ee\u306e\u8a18\u4e8b\u3067\u3059\u3002\n\n0.\u306f\u3058\u3081\u306b\n\u672c\u8a18\u4e8b\u3067\u306fServerspec\u3092Ansible\u306ehostvars\u5909\u6570\u306e\u5024\u3092\u4f7f\u3063\u3066ansible-playbook \u304b\u3089\u5b9f\u884c\u3059\u308b\u65b9\u6cd5\u3092\u7d39\u4ecb\u3057\u307e\u3059\u3002\n\n\u3053\u3061\u3089\u306f\u4ee5\u524d\u66f8\u3044\u305f\u8a18\u4e8b\u3092\u5143\u306b\u30a2\u30c3\u30d7\u30c7\u30fc\u30c8\u3057\u305f\u3082\u306e\u3067\u3059\u3002\n\u30b3\u30fc\u30c9\u4e00\u5f0f\u306f https://github.com/tbuchi888/serverspec-run-by-ansible-playbook.git \u3078\u4e0a\u3052\u3066\u3044\u307e\u3059\u3002\u3059\u3050\u306b\u8a66\u3057\u305f\u3044\u5834\u5408\u306f\u4ee5\u4e0b\u624b\u9806\u3092\u53c2\u7167\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n#Step1\ngit clone https://github.com/tbuchi888/serverspec-run-by-ansible-playbook.git\ncd serverspec-run-by-ansible-playbook\n\n#Step2\n#\u30a4\u30f3\u30d9\u30f3\u30c8\u30ea\u30d5\u30a1\u30a4\u30eb\uff08hosts.yml\uff09\u3084spec/\u30ed\u30fc\u30eb\u540d/\u914d\u4e0b\u7b49\u3092\u81ea\u74b0\u5883\u3078\u5408\u308f\u305b\u3066\u4fee\u6b63\u3002\n\n#Step3\nansible-plyabook -i hosts.yml spec.yml\n\n\u305d\u306e\u4ed6\u3001\u53c2\u8003\u307e\u3067\u306bAnsible\u516c\u5f0f\u30b5\u30a4\u30c8\u304c\u63a8\u5968\u3059\u308b\u30c6\u30b9\u30c8\u65b9\u6cd5\u306b\u3064\u3044\u3066\u306f\u4ee5\u4e0b\u3092\u3054\u78ba\u8a8d\u304f\u3060\u3055\u3044\u3002\nhttp://docs.ansible.com/ansible/test_strategies.html\n\n1.\u30a4\u30f3\u30d9\u30f3\u30c8\u30ea\u30db\u30b9\u30c8\u3078\u306eServerspec\u306e\u5b9f\u884c\nAnsible\u306e\u30a4\u30f3\u30d9\u30f3\u30c8\u30ea\u30db\u30b9\u30c8\u306b\u5bfe\u3057\u3066Serverspec\u3092\u5b9f\u65bd\u3059\u308b\u5834\u5408\n\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u65b9\u6cd5\u304c\u3042\u308b\u3068\u601d\u3044\u307e\u3059\u3002\n\n\n\nNo.\n\u65b9\u6cd5\n\u7279\u5fb4\n\n\n\n\n1\nAnsible\u306ecommand\u3084shell\u30e2\u30b8\u30e5\u30fc\u30eb\u304b\u3089\u3001rake spec\u3084rake spec:hogerole\u306a\u3069Serverspec\u3092\u76f4\u63a5\u547c\u3073\u51fa\u3059\u65b9\u6cd5\nAnsible\u3068Serverspec\u3067\u5225\u3005\u306binventory\u3084hostvars\u3092\u7ba1\u7406\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u3002\n\n\n2\n\nansible_spec\u306a\u3069Ansible\u3068Serverspec\u306e\u30d1\u30fc\u30b5\u30fc\u3092\u4f7f\u3046\u65b9\u6cd5\nansible_spec\u306fGem\u3067\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u5f8c\u306b\u3001\u6307\u5b9a\u306e\u5f62\u5f0f\uff08Inventory\u30d5\u30a1\u30a4\u30eb\u3084\u30ed\u30fc\u30eb\u306a\u3069\u3001\u30d9\u30b9\u30c8\u30d7\u30e9\u30af\u30c6\u30a3\u30b9\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u69cb\u6210\u306b\u8fd1\u3044\uff09\u3092\u3068\u308c\u3070\u3001Ansible\u306e\u30d5\u30a1\u30a4\u30eb\u3092\u5229\u7528\u3057\u3066\u3001\u5bb9\u6613\u306bAnsible\u306e\u30ed\u30fc\u30eb\u5358\u4f4d\u3067\u30c6\u30b9\u30c8\u5b9f\u884c\u304c\u53ef\u80fd\u3067\u975e\u5e38\u306b\u4fbf\u5229\u3067\u3059\u3002\u305f\u3060\u3057\u3001Ansible\u5074\u3067\u30ed\u30fc\u30eb\u69cb\u6210\u304c\u5fc5\u8981\u306a\u3053\u3068\u3084\u30a4\u30f3\u30d9\u30f3\u30c8\u30ea\u30d5\u30a1\u30a4\u30eb\u5185\u306eVariables\u304c\u672a\u3060\u5bfe\u5fdc\u3057\u3066\u3044\u306a\u3044\u7b49\u306e\u5236\u7d04\u3082\u3042\u308a\u307e\u3059\u3002\n\n\n3\n\nkitchen-ansible\u306a\u3069\u3092\u5229\u7528\u3059\u308b\n\u3053\u3061\u3089\u306f\u672a\u691c\u8a3c\u3067\u3059\u3002Docker\u3084Vagrant\u306a\u3069\u3068\u9023\u643a\u3057\u3066\u3001\u30c6\u30b9\u30c8\u7528\u306e\u30b3\u30f3\u30c6\u30ca\u3084VM\u3092\u69cb\u7bc9\u3059\u308b\u30a4\u30e1\u30fc\u30b8\u3067\u3057\u3087\u3046\u304b\u3002\n\n\n\n\n2.\u4eca\u56de\u306e\u65b9\u6cd5\n\u4eca\u56de\u306f\u3001\u4e0a\u8ff0\u306eNo.1\u306b\u8fd1\u3044\u65b9\u6cd5\u3067\u3001Ansible\u306etemplate\u30e2\u30b8\u30e5\u30fc\u30eb\u3084Serverspec\u306eTips\u306a\u3069\n\u4ee5\u4e0b\u57fa\u672c\u6a5f\u80fd\u3092\u5229\u7528\u3057\u3066\u300cServerspec\u3092Ansible\u306ehostvars\u5909\u6570\u306e\u5024\u3092\u4f7f\u3063\u3066ansible-playbook\u304b\u3089\u5b9f\u884c\u3059\u308b\u65b9\u6cd5\u300d\u3092\u691c\u8a0e\u3057\u307e\u3057\u305f\u3002\n\nAnsible\n\n\nFAQ: In a template, get all the IPs of all machines in a group\n\n\nServerspec \n\n\nadvanced tips: How to use host specific properties\n\n\n\n\u5177\u4f53\u7684\u306b\u306f\u3001\u529b\u6280\u3067\u3059\u304c ansible-playbook \u3092\u5b9f\u884c\u6642\u306b\n\n\u5404\u30bf\u30fc\u30b2\u30c3\u30c8\u30db\u30b9\u30c8\u306ehostvars\u306e\u60c5\u5831\u3092Ansible\u306etemplate\u30e2\u30b8\u30e5\u30fc\u30eb\u3092\u5229\u7528\u3057\u3066YAML\u5f62\u5f0f\u306e\u30d5\u30a1\u30a4\u30eb\u3068\u3057\u3066dump\u3057\u307e\u3059\u3002\n\u7d9a\u3051\u3066Serverspec\u547c\u51fa\u3057\u6642\u306b\u5148\u307b\u3069dump\u3057\u305f\u30d5\u30a1\u30a4\u30eb\u306e\u30d1\u30b9\u3068\n\u30c6\u30b9\u30c8\u3057\u305f\u3044\u30ed\u30fc\u30eb\u540d(spec_role)\u3092\u6e21\u3057\u3066\u3042\u3052\u308b\n\n\u3053\u3068\u3067\u5b9f\u73fe\u3057\u3066\u3044\u307e\u3059\u3002\n\n\n3.\u74b0\u5883\nAnsible\u3068Serverspec\u5b9f\u884c HOST\u30de\u30b7\u30f3\n\nOSX Yosemite\n\n\nAnsible: 2.3.0 (devel 6c3de3c299) last updated 2016/12/22 \nServerspec: 2.37.2\n\n\n\n\u53c2\u8003\uff1a\u30b5\u30f3\u30d7\u30eb\u306e\u30a4\u30f3\u30d9\u30f3\u30c8\u30ea\u30db\u30b9\u30c8\uff08\u30bf\u30fc\u30b2\u30c3\u30c8\u30db\u30b9\u30c8\uff09\u30de\u30b7\u30f3\n\nWindows2012R2 * 1\u53f0\n\n\nIIS\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u6e08\n\n\nCentOS6.8 * 2\u53f0\n\n\napache\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u6e08 \n\n\n\n\u306a\u304a\u3001\u30b5\u30f3\u30d7\u30eb\u306e\u30de\u30b7\u30f3\u306f\u3053\u3061\u3089\u3092\u53c2\u8003\u306b\u4eca\u56de\u4f5c\u6210\u3057\u3066\u3044\u307e\u3059\u3002\n\u307e\u305f\u3001CentOS\u306b\u3064\u3044\u3066\u306fOSX\u30e6\u30fc\u30b6\u30fc\u306eSSH\u516c\u958b\u9375\u3092vagrant\u30e6\u30fc\u30b6\u30fc\u306b\u30b3\u30d4\u30fc\u3057\u3066\u304a\u304d\u307e\u3059\u3002 \n\u4f8b\uff09\nssh-copy-id vagrant@192.168.33.41\nssh-copy-id vagrant@192.168.33.41\n\n\n4.\u4e8b\u524d\u6e96\u5099\nDirectory\u69cb\u6210\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\n\u251c\u2500\u2500 README.md\n\u251c\u2500\u2500 Rakefile                # Sererspec\uff1a\u30ab\u30b9\u30bf\u30de\u30a4\u30ba\u3057\u305f\u3082\u306e\n\u251c\u2500\u2500 hosts.yml               # Ansible\uff1a  \u30b5\u30f3\u30d7\u30eb\u306e\u30a4\u30f3\u30d9\u30f3\u30c8\u30ea\u30d5\u30a1\u30a4\u30eb\n\u251c\u2500\u2500 spec\n\u2502   \u251c\u2500\u2500 AAA                 # Sererspec\uff1a\u30b5\u30f3\u30d7\u30eb\u306e\u30ed\u30fc\u30eb\u540d\n\u2502   \u2502   \u2514\u2500\u2500 sample_spec.rb  # Sererspec\uff1a\u30b5\u30f3\u30d7\u30eb\u306espec\u30d5\u30a1\u30a4\u30eb\n\u2502   \u251c\u2500\u2500 BBB                 # Sererspec\uff1a\u30b5\u30f3\u30d7\u30eb\u306e\u30ed\u30fc\u30eb\u540d\n\u2502   \u2502   \u2514\u2500\u2500 sample_spec.rb  # Sererspec\uff1a\u30b5\u30f3\u30d7\u30eb\u306espec\u30d5\u30a1\u30a4\u30eb\n\u2502   \u2514\u2500\u2500 spec_helper.rb      # Sererspec\uff1a\u30ab\u30b9\u30bf\u30de\u30a4\u30ba\u3057\u305f\u3082\u306e\n\u251c\u2500\u2500 spec.yml                # Ansible\uff1a  \u30ab\u30b9\u30bf\u30de\u30a4\u30ba\u3057\u305fPlaybook\n\u251c\u2500\u2500 spec_vars               # Ansible\uff1a  playbook\u5b9f\u884c\u6642\u306b\u4f5c\u6210\n\u2502   \u251c\u2500\u2500 hostvars_centos6-httpd01.yml \n\u2502   \u251c\u2500\u2500 hostvars_centos6-httpd02.yml\n\u2502   \u251c\u2500\u2500 hostvars_win2012-iis01.yml\n\u2514\u2500\u2500 templates               \n    \u2514\u2500\u2500 dump_variables.j2\u3000\u3000\u3000\u3000\u3000\u3000# Ansible\uff1a  hostvars\u3092\u30c0\u30f3\u30d7\u3059\u308bjinjya2\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\n\n\n\n4.1.Ansible\u5074\u306e\u6e96\u5099\n\n\u30a4\u30f3\u30d9\u30f3\u30c8\u30ea\u30db\u30b9\u30c8\uff08\u5b9f\u884c\u5bfe\u8c61\u30db\u30b9\u30c8\uff09\u6bce\u306ehostvars\u3092YAML\u5f62\u5f0f\u3067\u30c0\u30f3\u30d7\u3059\u308bjinjya2\u306etemplate\u30d5\u30a1\u30a4\u30eb\u3092templates/dump_variables.j2\u3068\u3057\u3066\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n\ndump_variables.j2\n{{ hostvars[inventory_hostname] | to_yaml }}\n\n\n\nAnsible\u5b9f\u884c\u30db\u30b9\u30c8\u30de\u30b7\u30f3\u306elocal\u3067\u4ee5\u4e0b\u3092\u5b9f\u65bd\u3059\u308bplaybook\u3092spec.yml\u3068\u3057\u3066\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n\ntemplate\u30e2\u30b8\u30e5\u30fc\u30eb\u3092\u5229\u7528\u3057\u3066\u3001\u30a4\u30f3\u30d9\u30f3\u30c8\u30ea\u30db\u30b9\u30c8\u306ehostvars\u306e\u60c5\u5831\u3092YAML\u5f62\u5f0f\u3067\u30ab\u30ec\u30f3\u30c8\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u4e0a\u306espec_vars/[inventory_hostname].yml\u3068\u3057\u3066\u4fdd\u5b58\u3059\u308b\nshell\u30e2\u30b8\u30e5\u30fc\u30eb\u3088\u308a\u3001\u4e0a\u8a18\u30d5\u30a1\u30a4\u30eb\u3068\u3001serverspec\u306e\u30ed\u30fc\u30eb\u540d\uff08spec_role\uff09\u3092\u5f15\u6570\u306b\u3057\u3066serverspec\u3092\u5b9f\u884c\u3059\u308b\ndebug\u30e2\u30b8\u30e5\u30fc\u30eb\u3067serverspec\u5b9f\u884c\u7d50\u679c\u3092\u8868\u793a\u3059\u308b \n\n\n\n\nspec.yml\n---\n- hosts: all\n  gather_facts: no\n  vars:\n    spec_vars_dir:  \"{{playbook_dir}}/spec_vars\"\n    host_vars_path: \"{{spec_vars_dir}}/hostvars_{{inventory_hostname}}.yml\"\n  tasks:\n   - name: create \"{{spec_vars_dir}}\" directory\n     file:\n       path: \"{{spec_vars_dir}}\"\n       state: directory \n     delegate_to: localhost\n   - name: \"dump_variables hostvars to yml\"\n     template:\n       src: templates/dump_variables.j2\n       dest: \"{{host_vars_path}}\"\n     delegate_to: localhost\n   - name: rake serverspec with hostvars\n     shell: HOST_VARS_PATH={{host_vars_path}} rake serverspec:{{spec_role}}\n     register: raw_result\n     delegate_to: localhost\n   - name: stdout of serverspec\n     debug: var=raw_result.stdout_lines\n\n\n\n\u53c2\u8003\uff1a\u4ee5\u4e0b\u306f\u30b5\u30f3\u30d7\u30eb\u306eAnsible\u306e\u30a4\u30f3\u30d9\u30f3\u30c8\u30ea\u30d5\u30a1\u30a4\u30eb\u3068\u306a\u308a\u307e\u3059\u3002\n\u81ea\u74b0\u5883\u306b\u5408\u308f\u305b\u3066\u9069\u5b9c\u5909\u66f4\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\u306a\u304a\u3001spec_role\u306b\u5408\u81f4\u3059\u308bserverspec\u3092\u5b9f\u65bd\u3057\u307e\u3059\u3002\nspec_role\u3092\u5b9a\u7fa9\u3057\u306a\u3044\u5834\u5408\u306fserverspec\u306e\u30c6\u30b9\u30c8\u5bfe\u8c61\u5916\u3068\u306a\u308a\u307e\u3059\u3002\n\n\nhosts.yml\n[win]\nwin2012-iis01 spec_role=AAA ansible_host=192.168.33.51\n\n[centos]\ncentos6-httpd01 spec_role=AAA ansible_host=192.168.33.41\ncentos6-httpd02 spec_role=BBB ansible_host=192.168.33.42\nmyansible spec_role=BBB ansible_host=localhost\n\n[win:vars]\nansible_connection=winrm\nansible_port=5985\nansible_user=vagrant\nansible_password=vagrant\nweb_service_name=\"W3SVC\"\n\n[centos:vars]\nansible_user=vagrant\nansible_private_key_file=~/.ssh/id_rsa\nweb_service_name=httpd\n\n\n\n4.2.Serverspec\u5074\u306e\u6e96\u5099\n\n\nRakefile\u3092\u4ee5\u4e0b\u306e\u901a\u308a\u30ab\u30b9\u30bf\u30de\u30a4\u30ba\u3057\u307e\u3059\u3002\n\n\nhostvars\u306eYAML\u5f62\u5f0f\u30d5\u30a1\u30a4\u30eb\u306e\u30d1\u30b9\u3092\u6307\u5b9a\u3057\u3066\u3001\u5909\u6570\u3068\u3057\u3066\u53d6\u8fbc\u307e\u3059\u3002\n\nspec_role\u540d\u3092\u30ed\u30fc\u30eb\u3068\u3057\u3066\u6307\u5b9a\u3057\u307e\u3059\u3002\n\n\n\nRakefile\nrequire 'rake'\nrequire 'rspec/core/rake_task'\nrequire 'yaml'\n\nhostvars = YAML.load_file(ENV['HOST_VARS_PATH'])\n\nnamespace :serverspec do\n  desc \"Run serverspec for #{hostvars[\"spec_role\"]}\"\n  RSpec::Core::RakeTask.new(hostvars[\"spec_role\"].to_sym) do |t|\n    t.pattern = \"spec/#{hostvars[\"spec_role\"]}/*_spec.rb\"\n  end\nend\n\n\n\nspec_helper.rb\u3092\u4ee5\u4e0b\u901a\u308a\u30ab\u30b9\u30bf\u30de\u30a4\u30ba\u3057\u307e\u3059\u3002\n\n\nhostvars\u306eYAML\u5f62\u5f0f\u30d5\u30a1\u30a4\u30eb\u306e\u30d1\u30b9\u3092\u6307\u5b9a\u3057\u3066\u3001\u5909\u6570\u3068\u3057\u3066\u53d6\u8fbc\u307e\u3059\u3002\n\u30de\u30eb\u30c1OS\uff08windows/un*x\uff09\u3001\u30de\u30eb\u30c1\u30b3\u30cd\u30af\u30b7\u30e7\u30f3(ssh/local/winrm)\u5bfe\u5fdc\u3082\u5b9f\u65bd\u3057\u307e\u3059\u3002\n\n\n\n\nspec_helper.rb\nrequire 'serverspec'\nrequire 'net/ssh'\nrequire 'winrm'\nrequire 'yaml'\n\nhostvars = YAML.load_file(ENV['HOST_VARS_PATH'])\nset_property hostvars\n\nif hostvars[\"ansible_connection\"] == 'winrm'\n#\n# OS type: Windows / Connetion type: winrm\n#\n  set :backend, :winrm\n  set :os, :family => 'windows'\n\n  host = hostvars[\"ansible_ssh_host\"]  || hostvars[\"ansible_host\"]      || hostvars[\"inventory_hostname\"]\n  user = hostvars[\"ansible_ssh_user\"]  || hostvars[\"ansible_user\"]  \n  port = hostvars[\"ansible_ssh_port\"]  || hostvars[\"ansible_port\"]    \n  pass = hostvars[\"ansible_ssh_pass\"]  || hostvars[\"ansible_password\"]   \n\n  endpoint = \"http://#{host}:#{port}/wsman\"\n\n  winrm = ::WinRM::WinRMWebService.new(endpoint, :ssl, :user => user, :pass => pass, :basic_auth_only => true)\n  winrm.set_timeout 300 # 5 minutes max timeout for any operation\n  Specinfra.configuration.winrm = winrm\n\nelsif hostvars[\"ansible_connection\"] == 'local' || hostvars[\"ansible_ssh_host\"] == 'localhost' || hostvars[\"ansible_host\"] == 'localhost' || hostvars[\"inventory_hostname\"] == 'localhost'\n#\n# OS type: UN*X / Connction type: local exec\n#\n set :backend, :exec\nelse\n#\n# OS type: UN*X / Connction type: ssh\n#\n  set :backend, :ssh\n\n  set :sudo_password, hostvars[\"ansible_ssh_pass\"] || hostvars[\"ansible_password\"]\n\n  host = hostvars[\"ansible_ssh_host\"] || hostvars[\"ansible_host\"] || hostvars[\"inventory_hostname\"]\n\n  options = Net::SSH::Config.for(host)\n\n  options[:user] ||= hostvars[\"ansible_ssh_user\"]             || hostvars[\"ansible_user\"]\n  options[:port] ||= hostvars[\"ansible_ssh_port\"]             || hostvars[\"ansible_port\"]\n  options[:keys] ||= hostvars[\"ansible_ssh_private_key_file\"] || hostvars[\"ansible_private_key_file\"]\n\n  set :host,        options[:host_name] || host\n  set :ssh_options, options\n\n  # Disable sudo\n  # set :disable_sudo, true\n\n  # Set environment variables\n  # set :env, :LANG => 'C', :LC_MESSAGES => 'C'\n\n  # Set PATH\n  # set :path, '/sbin:/usr/local/sbin:$PATH'\nend\n\n\n\n \u30c6\u30b9\u30c8\u7528\u306espec\u30d5\u30a1\u30a4\u30eb\u3092\u6e96\u5099\u3057\u307e\u3059\u3002\n\u3053\u3061\u3089\u306f\u81ea\u74b0\u5883\u306b\u5408\u308f\u305b\u3066\u9069\u5b9c\u5909\u66f4\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n\u4ee5\u4e0b\u30b5\u30f3\u30d7\u30eb\u306eServersepc\u306e\u30ed\u30fc\u30eb\u3068spec\u30d5\u30a1\u30a4\u30eb\n\nROLE:AAA\n\n\nspec/AAA/sample_spec.rb\nAnsible\u306ehostvars\u306b\u8a2d\u5b9a\u3057\u305f\u5909\u6570web_service_name\u306e\u30b5\u30fc\u30d3\u30b9\u72b6\u614b\u3092\u78ba\u8a8d\u3059\u308b\u30b5\u30f3\u30d7\u30eb\n\n\n\n\nsample_spec.rb\nrequire 'spec_helper'\n\ndescribe service( property[\"web_service_name\"] ) do\n  it { should be_enabled }\n  it { should be_running }\nend\n\n\n\nROLE:BBB\n\n\nspec/BBB/sample_spec.rb\nAnsible\u306e\u30a4\u30f3\u30d9\u30f3\u30c8\u30ea\u30d5\u30a1\u30a4\u30eb\u306einventory_hostname\u3092\u30db\u30b9\u30c8\u540d\u3068\u3057\u3066\u542b\u3093\u3067\u3044\u308b\u304b\u78ba\u8a8d\u3059\u308b\u30b5\u30f3\u30d7\u30eb\n\n\n\n\nsample_spec.rb\nrequire 'spec_helper'\n\ndescribe command('hostname') do\n  its(:stdout) { should contain( \"#{property['inventory_hostname']}\" ) }\nend\n\n\n\n5.\u53c2\u8003\uff1a\u5b9f\u884c\u7d50\u679c\n\u4ee5\u4e0b\u30b5\u30f3\u30d7\u30eb\u74b0\u5883\u3067\u306eplaybook\u5b9f\u884c\u7d50\u679c\u3067\u3059\u3002\nWindows\u30b5\u30fc\u30d0\u3068CentOS\u30b5\u30fc\u30d0\u306e\u5404\u3005\u306e\u30ed\u30fc\u30eb\u306b\u5bfe\u3057\u3066Serverspec\u304c\u5b9f\u884c\u3055\u308c\u307e\u3059\u3002\n$ ansible-playbook -i hosts.yml spec.yml\n\nPLAY [all] ******************************************************************************************************************************************************\n\nTASK [create spec_vars directory] *******************************************************************************************************************************\nchanged: [win2012-iis01 -> localhost]\nok: [centos6-httpd02 -> localhost]\nok: [centos6-httpd01 -> localhost]\n\nTASK [dump_variables hostvars to yml] ***************************************************************************************************************************\nchanged: [centos6-httpd02 -> localhost]\nchanged: [centos6-httpd01 -> localhost]\nchanged: [win2012-iis01 -> localhost]\n\nTASK [rake serverspec with hostvars] ****************************************************************************************************************************\nchanged: [centos6-httpd02 -> localhost]\nchanged: [centos6-httpd01 -> localhost]\nchanged: [win2012-iis01 -> localhost]\n\nTASK [stdout of serverspec] *************************************************************************************************************************************\nok: [centos6-httpd02] => {\n    \"raw_result.stdout_lines\": [\n        \"/System/Library/Frameworks/Ruby.framework/Versions/2.0/usr/bin/ruby -I/Library/Ruby/Gems/2.0.0/gems/rspec-support-3.5.0/lib:/Library/Ruby/Gems/2.0.0/gems/rspec-core-3.5.4/lib /Library/Ruby/Gems/2.0.0/gems/rspec-core-3.5.4/exe/rspec --pattern spec/BBB/\\\\*_spec.rb\", \n        \"\", \n        \"Command \\\"hostname\\\"\", \n        \"  stdout\", \n        \"    should contain \\\"centos6-httpd02\\\"\", \n        \"\", \n        \"Finished in 5.33 seconds (files took 2.5 seconds to load)\", \n        \"1 example, 0 failures\"\n    ]\n}\nok: [centos6-httpd01] => {\n    \"raw_result.stdout_lines\": [\n        \"/System/Library/Frameworks/Ruby.framework/Versions/2.0/usr/bin/ruby -I/Library/Ruby/Gems/2.0.0/gems/rspec-support-3.5.0/lib:/Library/Ruby/Gems/2.0.0/gems/rspec-core-3.5.4/lib /Library/Ruby/Gems/2.0.0/gems/rspec-core-3.5.4/exe/rspec --pattern spec/AAA/\\\\*_spec.rb\", \n        \"\", \n        \"Service \\\"httpd\\\"\", \n        \"  should be enabled\", \n        \"  should be running\", \n        \"\", \n        \"Finished in 5.62 seconds (files took 2.68 seconds to load)\", \n        \"2 examples, 0 failures\"\n    ]\n}\nok: [win2012-iis01] => {\n    \"raw_result.stdout_lines\": [\n        \"/System/Library/Frameworks/Ruby.framework/Versions/2.0/usr/bin/ruby -I/Library/Ruby/Gems/2.0.0/gems/rspec-support-3.5.0/lib:/Library/Ruby/Gems/2.0.0/gems/rspec-core-3.5.4/lib /Library/Ruby/Gems/2.0.0/gems/rspec-core-3.5.4/exe/rspec --pattern spec/AAA/\\\\*_spec.rb\", \n        \"\", \n        \"Service \\\"W3SVC\\\"\", \n        \" WARN  WinRM::WinRMWebService : WinRM::WinRMWebService#run_powershell_script is deprecated. Use WinRM::CommandExecutor#run_powershell_script instead\", \n        \"  should be enabled\", \n        \" WARN  WinRM::WinRMWebService : WinRM::WinRMWebService#run_powershell_script is deprecated. Use WinRM::CommandExecutor#run_powershell_script instead\", \n        \"  should be running\", \n        \"\", \n        \"Finished in 9.7 seconds (files took 2.48 seconds to load)\", \n        \"2 examples, 0 failures\"\n    ]\n}\n\nPLAY RECAP ******************************************************************************************************************************************************\ncentos6-httpd01            : ok=4    changed=2    unreachable=0    failed=0   \ncentos6-httpd02            : ok=4    changed=2    unreachable=0    failed=0   \nwin2012-iis01              : ok=4    changed=3    unreachable=0    failed=0 \n\n\n6.\u305d\u306e\u4ed6\nWindows\u30b5\u30fc\u30d0\u3078Serverspec\u3059\u308b\u969b\u306e\u30ea\u30bd\u30fc\u30b9\u30bf\u30a4\u30d7\u3084\u8a2d\u5b9a\u306a\u3069\u4ee5\u4e0b\u304c\u53c2\u8003\u306b\u306a\u308a\u307e\u3057\u305f\u3002\nhttps://github.com/mizzy/serverspec/blob/master/WINDOWS_SUPPORT.md\n# Serverspec run by ansible-playbook and it use hostvars variables of Ansible.\n\n\u3053\u3061\u3089\u306f[Ansible Advent Calendar 2016](http://qiita.com/advent-calendar/2016/ansible)\u306e25\u65e5\u76ee\u306e\u8a18\u4e8b\u3067\u3059\u3002\n\n## 0.\u306f\u3058\u3081\u306b\n\u672c\u8a18\u4e8b\u3067\u306fServerspec\u3092Ansible\u306e[hostvars\u5909\u6570\u306e\u5024](http://qiita.com/tbuchi888/items/ddb7f9d51b578d5ecfa2)\u3092\u4f7f\u3063\u3066ansible-playbook \u304b\u3089\u5b9f\u884c\u3059\u308b\u65b9\u6cd5\u3092\u7d39\u4ecb\u3057\u307e\u3059\u3002\n\n+ \u3053\u3061\u3089\u306f\u4ee5\u524d\u66f8\u3044\u305f\u8a18\u4e8b\u3092\u5143\u306b\u30a2\u30c3\u30d7\u30c7\u30fc\u30c8\u3057\u305f\u3082\u306e\u3067\u3059\u3002\n+ \u30b3\u30fc\u30c9\u4e00\u5f0f\u306f https://github.com/tbuchi888/serverspec-run-by-ansible-playbook.git \u3078\u4e0a\u3052\u3066\u3044\u307e\u3059\u3002\u3059\u3050\u306b\u8a66\u3057\u305f\u3044\u5834\u5408\u306f\u4ee5\u4e0b\u624b\u9806\u3092\u53c2\u7167\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n```\u3000\n#Step1\ngit clone https://github.com/tbuchi888/serverspec-run-by-ansible-playbook.git\ncd serverspec-run-by-ansible-playbook\n\n#Step2\n#\u30a4\u30f3\u30d9\u30f3\u30c8\u30ea\u30d5\u30a1\u30a4\u30eb\uff08hosts.yml\uff09\u3084spec/\u30ed\u30fc\u30eb\u540d/\u914d\u4e0b\u7b49\u3092\u81ea\u74b0\u5883\u3078\u5408\u308f\u305b\u3066\u4fee\u6b63\u3002\n\n#Step3\nansible-plyabook -i hosts.yml spec.yml\n```\n\n\u305d\u306e\u4ed6\u3001\u53c2\u8003\u307e\u3067\u306bAnsible\u516c\u5f0f\u30b5\u30a4\u30c8\u304c\u63a8\u5968\u3059\u308b\u30c6\u30b9\u30c8\u65b9\u6cd5\u306b\u3064\u3044\u3066\u306f\u4ee5\u4e0b\u3092\u3054\u78ba\u8a8d\u304f\u3060\u3055\u3044\u3002\nhttp://docs.ansible.com/ansible/test_strategies.html\n\n## 1.\u30a4\u30f3\u30d9\u30f3\u30c8\u30ea\u30db\u30b9\u30c8\u3078\u306eServerspec\u306e\u5b9f\u884c\nAnsible\u306e\u30a4\u30f3\u30d9\u30f3\u30c8\u30ea\u30db\u30b9\u30c8\u306b\u5bfe\u3057\u3066Serverspec\u3092\u5b9f\u65bd\u3059\u308b\u5834\u5408\n\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u65b9\u6cd5\u304c\u3042\u308b\u3068\u601d\u3044\u307e\u3059\u3002\n\n|No.|\u65b9\u6cd5|\u7279\u5fb4|\n|:-:|:-:|:-:|\n|1|Ansible\u306ecommand\u3084shell\u30e2\u30b8\u30e5\u30fc\u30eb\u304b\u3089\u3001`rake spec`\u3084`rake spec:hogerole`\u306a\u3069Serverspec\u3092\u76f4\u63a5\u547c\u3073\u51fa\u3059\u65b9\u6cd5|Ansible\u3068Serverspec\u3067\u5225\u3005\u306binventory\u3084hostvars\u3092\u7ba1\u7406\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u3002|\n|2 |[ansible_spec](https://github.com/volanja/ansible_spec)\u306a\u3069Ansible\u3068Serverspec\u306e\u30d1\u30fc\u30b5\u30fc\u3092\u4f7f\u3046\u65b9\u6cd5|ansible_spec\u306fGem\u3067\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u5f8c\u306b\u3001\u6307\u5b9a\u306e\u5f62\u5f0f\uff08Inventory\u30d5\u30a1\u30a4\u30eb\u3084\u30ed\u30fc\u30eb\u306a\u3069\u3001\u30d9\u30b9\u30c8\u30d7\u30e9\u30af\u30c6\u30a3\u30b9\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u69cb\u6210\u306b\u8fd1\u3044\uff09\u3092\u3068\u308c\u3070\u3001Ansible\u306e\u30d5\u30a1\u30a4\u30eb\u3092\u5229\u7528\u3057\u3066\u3001\u5bb9\u6613\u306bAnsible\u306e\u30ed\u30fc\u30eb\u5358\u4f4d\u3067\u30c6\u30b9\u30c8\u5b9f\u884c\u304c\u53ef\u80fd\u3067\u975e\u5e38\u306b\u4fbf\u5229\u3067\u3059\u3002\u305f\u3060\u3057\u3001Ansible\u5074\u3067\u30ed\u30fc\u30eb\u69cb\u6210\u304c\u5fc5\u8981\u306a\u3053\u3068\u3084\u30a4\u30f3\u30d9\u30f3\u30c8\u30ea\u30d5\u30a1\u30a4\u30eb\u5185\u306eVariables\u304c\u672a\u3060\u5bfe\u5fdc\u3057\u3066\u3044\u306a\u3044\u7b49\u306e\u5236\u7d04\u3082\u3042\u308a\u307e\u3059\u3002|\n|3|[kitchen-ansible](https://github.com/neillturner/kitchen-ansible)\u306a\u3069\u3092\u5229\u7528\u3059\u308b|\u3053\u3061\u3089\u306f\u672a\u691c\u8a3c\u3067\u3059\u3002Docker\u3084Vagrant\u306a\u3069\u3068\u9023\u643a\u3057\u3066\u3001\u30c6\u30b9\u30c8\u7528\u306e\u30b3\u30f3\u30c6\u30ca\u3084VM\u3092\u69cb\u7bc9\u3059\u308b\u30a4\u30e1\u30fc\u30b8\u3067\u3057\u3087\u3046\u304b\u3002|\n\n## 2.\u4eca\u56de\u306e\u65b9\u6cd5\n\u4eca\u56de\u306f\u3001\u4e0a\u8ff0\u306eNo.1\u306b\u8fd1\u3044\u65b9\u6cd5\u3067\u3001Ansible\u306e`template`\u30e2\u30b8\u30e5\u30fc\u30eb\u3084Serverspec\u306eTips\u306a\u3069\n\u4ee5\u4e0b\u57fa\u672c\u6a5f\u80fd\u3092\u5229\u7528\u3057\u3066\u300cServerspec\u3092Ansible\u306ehostvars\u5909\u6570\u306e\u5024\u3092\u4f7f\u3063\u3066ansible-playbook\u304b\u3089\u5b9f\u884c\u3059\u308b\u65b9\u6cd5\u300d\u3092\u691c\u8a0e\u3057\u307e\u3057\u305f\u3002\n\n+ Ansible\n  + [FAQ: In a template, get all the IPs of all machines in a group](https://support.ansible.com/hc/en-us/articles/201957817-In-a-template-get-all-the-IPs-of-all-machines-in-a-group)\n+ Serverspec \n  + [advanced tips: How to use host specific properties](http://serverspec.org/advanced_tips.html)\n\n\u5177\u4f53\u7684\u306b\u306f\u3001\u529b\u6280\u3067\u3059\u304c ansible-playbook \u3092\u5b9f\u884c\u6642\u306b\n\n+ \u5404\u30bf\u30fc\u30b2\u30c3\u30c8\u30db\u30b9\u30c8\u306ehostvars\u306e\u60c5\u5831\u3092Ansible\u306etemplate\u30e2\u30b8\u30e5\u30fc\u30eb\u3092\u5229\u7528\u3057\u3066YAML\u5f62\u5f0f\u306e\u30d5\u30a1\u30a4\u30eb\u3068\u3057\u3066dump\u3057\u307e\u3059\u3002\n+ \u7d9a\u3051\u3066Serverspec\u547c\u51fa\u3057\u6642\u306b\u5148\u307b\u3069dump\u3057\u305f\u30d5\u30a1\u30a4\u30eb\u306e\u30d1\u30b9\u3068\n\u30c6\u30b9\u30c8\u3057\u305f\u3044\u30ed\u30fc\u30eb\u540d(`spec_role`)\u3092\u6e21\u3057\u3066\u3042\u3052\u308b\n\n\u3053\u3068\u3067\u5b9f\u73fe\u3057\u3066\u3044\u307e\u3059\u3002\n\n![image01.png](https://qiita-image-store.s3.amazonaws.com/0/117986/ac3c31c1-e3c1-f421-71a2-bfa0509e6529.png)\n\n### 3.\u74b0\u5883\nAnsible\u3068Serverspec\u5b9f\u884c HOST\u30de\u30b7\u30f3\n\n- OSX Yosemite\n  - Ansible: 2.3.0 (devel 6c3de3c299) last updated 2016/12/22 \n  - Serverspec: 2.37.2\n\n\u53c2\u8003\uff1a\u30b5\u30f3\u30d7\u30eb\u306e\u30a4\u30f3\u30d9\u30f3\u30c8\u30ea\u30db\u30b9\u30c8\uff08\u30bf\u30fc\u30b2\u30c3\u30c8\u30db\u30b9\u30c8\uff09\u30de\u30b7\u30f3\n\n - Windows2012R2 * 1\u53f0\n   - IIS\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u6e08\n - CentOS6.8 * 2\u53f0\n   - apache\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u6e08 \n\n\u306a\u304a\u3001\u30b5\u30f3\u30d7\u30eb\u306e\u30de\u30b7\u30f3\u306f[\u3053\u3061\u3089](http://qiita.com/tbuchi888/items/c60025d68c8b49dbf6d1)\u3092\u53c2\u8003\u306b\u4eca\u56de\u4f5c\u6210\u3057\u3066\u3044\u307e\u3059\u3002\n\u307e\u305f\u3001CentOS\u306b\u3064\u3044\u3066\u306fOSX\u30e6\u30fc\u30b6\u30fc\u306eSSH\u516c\u958b\u9375\u3092vagrant\u30e6\u30fc\u30b6\u30fc\u306b\u30b3\u30d4\u30fc\u3057\u3066\u304a\u304d\u307e\u3059\u3002 \n\n\u4f8b\uff09\n\n```\nssh-copy-id vagrant@192.168.33.41\nssh-copy-id vagrant@192.168.33.41\n```\n\n### 4.\u4e8b\u524d\u6e96\u5099\nDirectory\u69cb\u6210\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\n\n```\n\u251c\u2500\u2500 README.md\n\u251c\u2500\u2500 Rakefile                # Sererspec\uff1a\u30ab\u30b9\u30bf\u30de\u30a4\u30ba\u3057\u305f\u3082\u306e\n\u251c\u2500\u2500 hosts.yml               # Ansible\uff1a  \u30b5\u30f3\u30d7\u30eb\u306e\u30a4\u30f3\u30d9\u30f3\u30c8\u30ea\u30d5\u30a1\u30a4\u30eb\n\u251c\u2500\u2500 spec\n\u2502   \u251c\u2500\u2500 AAA                 # Sererspec\uff1a\u30b5\u30f3\u30d7\u30eb\u306e\u30ed\u30fc\u30eb\u540d\n\u2502   \u2502   \u2514\u2500\u2500 sample_spec.rb  # Sererspec\uff1a\u30b5\u30f3\u30d7\u30eb\u306espec\u30d5\u30a1\u30a4\u30eb\n\u2502   \u251c\u2500\u2500 BBB                 # Sererspec\uff1a\u30b5\u30f3\u30d7\u30eb\u306e\u30ed\u30fc\u30eb\u540d\n\u2502   \u2502   \u2514\u2500\u2500 sample_spec.rb  # Sererspec\uff1a\u30b5\u30f3\u30d7\u30eb\u306espec\u30d5\u30a1\u30a4\u30eb\n\u2502   \u2514\u2500\u2500 spec_helper.rb      # Sererspec\uff1a\u30ab\u30b9\u30bf\u30de\u30a4\u30ba\u3057\u305f\u3082\u306e\n\u251c\u2500\u2500 spec.yml                # Ansible\uff1a  \u30ab\u30b9\u30bf\u30de\u30a4\u30ba\u3057\u305fPlaybook\n\u251c\u2500\u2500 spec_vars               # Ansible\uff1a  playbook\u5b9f\u884c\u6642\u306b\u4f5c\u6210\n\u2502   \u251c\u2500\u2500 hostvars_centos6-httpd01.yml \n\u2502   \u251c\u2500\u2500 hostvars_centos6-httpd02.yml\n\u2502   \u251c\u2500\u2500 hostvars_win2012-iis01.yml\n\u2514\u2500\u2500 templates               \n    \u2514\u2500\u2500 dump_variables.j2\u3000\u3000\u3000\u3000\u3000\u3000# Ansible\uff1a  hostvars\u3092\u30c0\u30f3\u30d7\u3059\u308bjinjya2\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\n\n```\n\n#### 4.1.Ansible\u5074\u306e\u6e96\u5099\n\n - \u30a4\u30f3\u30d9\u30f3\u30c8\u30ea\u30db\u30b9\u30c8\uff08\u5b9f\u884c\u5bfe\u8c61\u30db\u30b9\u30c8\uff09\u6bce\u306ehostvars\u3092YAML\u5f62\u5f0f\u3067\u30c0\u30f3\u30d7\u3059\u308bjinjya2\u306etemplate\u30d5\u30a1\u30a4\u30eb\u3092`templates/dump_variables.j2`\u3068\u3057\u3066\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n\n``` dump_variables.j2\n{{ hostvars[inventory_hostname] | to_yaml }}\n```\n\n- Ansible\u5b9f\u884c\u30db\u30b9\u30c8\u30de\u30b7\u30f3\u306elocal\u3067\u4ee5\u4e0b\u3092\u5b9f\u65bd\u3059\u308bplaybook\u3092`spec.yml`\u3068\u3057\u3066\u4f5c\u6210\u3057\u307e\u3059\u3002\n  1. template\u30e2\u30b8\u30e5\u30fc\u30eb\u3092\u5229\u7528\u3057\u3066\u3001\u30a4\u30f3\u30d9\u30f3\u30c8\u30ea\u30db\u30b9\u30c8\u306ehostvars\u306e\u60c5\u5831\u3092YAML\u5f62\u5f0f\u3067\u30ab\u30ec\u30f3\u30c8\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u4e0a\u306e`spec_vars/[inventory_hostname].yml`\u3068\u3057\u3066\u4fdd\u5b58\u3059\u308b\n  1. shell\u30e2\u30b8\u30e5\u30fc\u30eb\u3088\u308a\u3001\u4e0a\u8a18\u30d5\u30a1\u30a4\u30eb\u3068\u3001serverspec\u306e\u30ed\u30fc\u30eb\u540d\uff08`spec_role`\uff09\u3092\u5f15\u6570\u306b\u3057\u3066serverspec\u3092\u5b9f\u884c\u3059\u308b\n  1. debug\u30e2\u30b8\u30e5\u30fc\u30eb\u3067serverspec\u5b9f\u884c\u7d50\u679c\u3092\u8868\u793a\u3059\u308b \n\n``` spec.yml\n---\n- hosts: all\n  gather_facts: no\n  vars:\n    spec_vars_dir:  \"{{playbook_dir}}/spec_vars\"\n    host_vars_path: \"{{spec_vars_dir}}/hostvars_{{inventory_hostname}}.yml\"\n  tasks:\n   - name: create \"{{spec_vars_dir}}\" directory\n     file:\n       path: \"{{spec_vars_dir}}\"\n       state: directory \n     delegate_to: localhost\n   - name: \"dump_variables hostvars to yml\"\n     template:\n       src: templates/dump_variables.j2\n       dest: \"{{host_vars_path}}\"\n     delegate_to: localhost\n   - name: rake serverspec with hostvars\n     shell: HOST_VARS_PATH={{host_vars_path}} rake serverspec:{{spec_role}}\n     register: raw_result\n     delegate_to: localhost\n   - name: stdout of serverspec\n     debug: var=raw_result.stdout_lines\n```\n\n\n- \u53c2\u8003\uff1a\u4ee5\u4e0b\u306f\u30b5\u30f3\u30d7\u30eb\u306eAnsible\u306e\u30a4\u30f3\u30d9\u30f3\u30c8\u30ea\u30d5\u30a1\u30a4\u30eb\u3068\u306a\u308a\u307e\u3059\u3002\n\u81ea\u74b0\u5883\u306b\u5408\u308f\u305b\u3066\u9069\u5b9c\u5909\u66f4\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\u306a\u304a\u3001`spec_role`\u306b\u5408\u81f4\u3059\u308bserverspec\u3092\u5b9f\u65bd\u3057\u307e\u3059\u3002\n`spec_role`\u3092\u5b9a\u7fa9\u3057\u306a\u3044\u5834\u5408\u306fserverspec\u306e\u30c6\u30b9\u30c8\u5bfe\u8c61\u5916\u3068\u306a\u308a\u307e\u3059\u3002\n\n``` hosts.yml\n[win]\nwin2012-iis01 spec_role=AAA ansible_host=192.168.33.51\n\n[centos]\ncentos6-httpd01 spec_role=AAA ansible_host=192.168.33.41\ncentos6-httpd02 spec_role=BBB ansible_host=192.168.33.42\nmyansible spec_role=BBB ansible_host=localhost\n\n[win:vars]\nansible_connection=winrm\nansible_port=5985\nansible_user=vagrant\nansible_password=vagrant\nweb_service_name=\"W3SVC\"\n\n[centos:vars]\nansible_user=vagrant\nansible_private_key_file=~/.ssh/id_rsa\nweb_service_name=httpd\n```\n\n#### 4.2.Serverspec\u5074\u306e\u6e96\u5099\n\n- `Rakefile`\u3092\u4ee5\u4e0b\u306e\u901a\u308a\u30ab\u30b9\u30bf\u30de\u30a4\u30ba\u3057\u307e\u3059\u3002\n  1. hostvars\u306eYAML\u5f62\u5f0f\u30d5\u30a1\u30a4\u30eb\u306e\u30d1\u30b9\u3092\u6307\u5b9a\u3057\u3066\u3001\u5909\u6570\u3068\u3057\u3066\u53d6\u8fbc\u307e\u3059\u3002\n  2. `spec_role`\u540d\u3092\u30ed\u30fc\u30eb\u3068\u3057\u3066\u6307\u5b9a\u3057\u307e\u3059\u3002\n\nRakefile\n\n``` Rakefile\nrequire 'rake'\nrequire 'rspec/core/rake_task'\nrequire 'yaml'\n\nhostvars = YAML.load_file(ENV['HOST_VARS_PATH'])\n\nnamespace :serverspec do\n  desc \"Run serverspec for #{hostvars[\"spec_role\"]}\"\n  RSpec::Core::RakeTask.new(hostvars[\"spec_role\"].to_sym) do |t|\n    t.pattern = \"spec/#{hostvars[\"spec_role\"]}/*_spec.rb\"\n  end\nend\n```\n\n- `spec_helper.rb`\u3092\u4ee5\u4e0b\u901a\u308a\u30ab\u30b9\u30bf\u30de\u30a4\u30ba\u3057\u307e\u3059\u3002\n  1. hostvars\u306eYAML\u5f62\u5f0f\u30d5\u30a1\u30a4\u30eb\u306e\u30d1\u30b9\u3092\u6307\u5b9a\u3057\u3066\u3001\u5909\u6570\u3068\u3057\u3066\u53d6\u8fbc\u307e\u3059\u3002\n  2. \u30de\u30eb\u30c1OS\uff08windows/un*x\uff09\u3001\u30de\u30eb\u30c1\u30b3\u30cd\u30af\u30b7\u30e7\u30f3(ssh/local/winrm)\u5bfe\u5fdc\u3082\u5b9f\u65bd\u3057\u307e\u3059\u3002\n\n``` spec_helper.rb\nrequire 'serverspec'\nrequire 'net/ssh'\nrequire 'winrm'\nrequire 'yaml'\n\nhostvars = YAML.load_file(ENV['HOST_VARS_PATH'])\nset_property hostvars\n\nif hostvars[\"ansible_connection\"] == 'winrm'\n#\n# OS type: Windows / Connetion type: winrm\n#\n  set :backend, :winrm\n  set :os, :family => 'windows'\n\n  host = hostvars[\"ansible_ssh_host\"]  || hostvars[\"ansible_host\"]      || hostvars[\"inventory_hostname\"]\n  user = hostvars[\"ansible_ssh_user\"]  || hostvars[\"ansible_user\"]  \n  port = hostvars[\"ansible_ssh_port\"]  || hostvars[\"ansible_port\"]    \n  pass = hostvars[\"ansible_ssh_pass\"]  || hostvars[\"ansible_password\"]   \n\n  endpoint = \"http://#{host}:#{port}/wsman\"\n\n  winrm = ::WinRM::WinRMWebService.new(endpoint, :ssl, :user => user, :pass => pass, :basic_auth_only => true)\n  winrm.set_timeout 300 # 5 minutes max timeout for any operation\n  Specinfra.configuration.winrm = winrm\n\nelsif hostvars[\"ansible_connection\"] == 'local' || hostvars[\"ansible_ssh_host\"] == 'localhost' || hostvars[\"ansible_host\"] == 'localhost' || hostvars[\"inventory_hostname\"] == 'localhost'\n#\n# OS type: UN*X / Connction type: local exec\n#\n set :backend, :exec\nelse\n#\n# OS type: UN*X / Connction type: ssh\n#\n  set :backend, :ssh\n\n  set :sudo_password, hostvars[\"ansible_ssh_pass\"] || hostvars[\"ansible_password\"]\n\n  host = hostvars[\"ansible_ssh_host\"] || hostvars[\"ansible_host\"] || hostvars[\"inventory_hostname\"]\n\n  options = Net::SSH::Config.for(host)\n\n  options[:user] ||= hostvars[\"ansible_ssh_user\"]             || hostvars[\"ansible_user\"]\n  options[:port] ||= hostvars[\"ansible_ssh_port\"]             || hostvars[\"ansible_port\"]\n  options[:keys] ||= hostvars[\"ansible_ssh_private_key_file\"] || hostvars[\"ansible_private_key_file\"]\n\n  set :host,        options[:host_name] || host\n  set :ssh_options, options\n\n  # Disable sudo\n  # set :disable_sudo, true\n\n  # Set environment variables\n  # set :env, :LANG => 'C', :LC_MESSAGES => 'C'\n\n  # Set PATH\n  # set :path, '/sbin:/usr/local/sbin:$PATH'\nend\n```\n\n-  \u30c6\u30b9\u30c8\u7528\u306espec\u30d5\u30a1\u30a4\u30eb\u3092\u6e96\u5099\u3057\u307e\u3059\u3002\n\u3053\u3061\u3089\u306f\u81ea\u74b0\u5883\u306b\u5408\u308f\u305b\u3066\u9069\u5b9c\u5909\u66f4\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n\u4ee5\u4e0b\u30b5\u30f3\u30d7\u30eb\u306eServersepc\u306e\u30ed\u30fc\u30eb\u3068spec\u30d5\u30a1\u30a4\u30eb\n\n+ ROLE:AAA\n  + spec/AAA/sample_spec.rb\n  + Ansible\u306ehostvars\u306b\u8a2d\u5b9a\u3057\u305f\u5909\u6570`web_service_name`\u306e\u30b5\u30fc\u30d3\u30b9\u72b6\u614b\u3092\u78ba\u8a8d\u3059\u308b\u30b5\u30f3\u30d7\u30eb\n\n``` sample_spec.rb\nrequire 'spec_helper'\n\ndescribe service( property[\"web_service_name\"] ) do\n  it { should be_enabled }\n  it { should be_running }\nend\n```\n\n+ ROLE:BBB\n  + spec/BBB/sample_spec.rb\n  + Ansible\u306e\u30a4\u30f3\u30d9\u30f3\u30c8\u30ea\u30d5\u30a1\u30a4\u30eb\u306e`inventory_hostname`\u3092\u30db\u30b9\u30c8\u540d\u3068\u3057\u3066\u542b\u3093\u3067\u3044\u308b\u304b\u78ba\u8a8d\u3059\u308b\u30b5\u30f3\u30d7\u30eb\n\n``` sample_spec.rb\nrequire 'spec_helper'\n\ndescribe command('hostname') do\n  its(:stdout) { should contain( \"#{property['inventory_hostname']}\" ) }\nend\n```\n\n### 5.\u53c2\u8003\uff1a\u5b9f\u884c\u7d50\u679c\n\u4ee5\u4e0b\u30b5\u30f3\u30d7\u30eb\u74b0\u5883\u3067\u306eplaybook\u5b9f\u884c\u7d50\u679c\u3067\u3059\u3002\nWindows\u30b5\u30fc\u30d0\u3068CentOS\u30b5\u30fc\u30d0\u306e\u5404\u3005\u306e\u30ed\u30fc\u30eb\u306b\u5bfe\u3057\u3066Serverspec\u304c\u5b9f\u884c\u3055\u308c\u307e\u3059\u3002\n\n```\n$ ansible-playbook -i hosts.yml spec.yml\n\nPLAY [all] ******************************************************************************************************************************************************\n\nTASK [create spec_vars directory] *******************************************************************************************************************************\nchanged: [win2012-iis01 -> localhost]\nok: [centos6-httpd02 -> localhost]\nok: [centos6-httpd01 -> localhost]\n\nTASK [dump_variables hostvars to yml] ***************************************************************************************************************************\nchanged: [centos6-httpd02 -> localhost]\nchanged: [centos6-httpd01 -> localhost]\nchanged: [win2012-iis01 -> localhost]\n\nTASK [rake serverspec with hostvars] ****************************************************************************************************************************\nchanged: [centos6-httpd02 -> localhost]\nchanged: [centos6-httpd01 -> localhost]\nchanged: [win2012-iis01 -> localhost]\n\nTASK [stdout of serverspec] *************************************************************************************************************************************\nok: [centos6-httpd02] => {\n    \"raw_result.stdout_lines\": [\n        \"/System/Library/Frameworks/Ruby.framework/Versions/2.0/usr/bin/ruby -I/Library/Ruby/Gems/2.0.0/gems/rspec-support-3.5.0/lib:/Library/Ruby/Gems/2.0.0/gems/rspec-core-3.5.4/lib /Library/Ruby/Gems/2.0.0/gems/rspec-core-3.5.4/exe/rspec --pattern spec/BBB/\\\\*_spec.rb\", \n        \"\", \n        \"Command \\\"hostname\\\"\", \n        \"  stdout\", \n        \"    should contain \\\"centos6-httpd02\\\"\", \n        \"\", \n        \"Finished in 5.33 seconds (files took 2.5 seconds to load)\", \n        \"1 example, 0 failures\"\n    ]\n}\nok: [centos6-httpd01] => {\n    \"raw_result.stdout_lines\": [\n        \"/System/Library/Frameworks/Ruby.framework/Versions/2.0/usr/bin/ruby -I/Library/Ruby/Gems/2.0.0/gems/rspec-support-3.5.0/lib:/Library/Ruby/Gems/2.0.0/gems/rspec-core-3.5.4/lib /Library/Ruby/Gems/2.0.0/gems/rspec-core-3.5.4/exe/rspec --pattern spec/AAA/\\\\*_spec.rb\", \n        \"\", \n        \"Service \\\"httpd\\\"\", \n        \"  should be enabled\", \n        \"  should be running\", \n        \"\", \n        \"Finished in 5.62 seconds (files took 2.68 seconds to load)\", \n        \"2 examples, 0 failures\"\n    ]\n}\nok: [win2012-iis01] => {\n    \"raw_result.stdout_lines\": [\n        \"/System/Library/Frameworks/Ruby.framework/Versions/2.0/usr/bin/ruby -I/Library/Ruby/Gems/2.0.0/gems/rspec-support-3.5.0/lib:/Library/Ruby/Gems/2.0.0/gems/rspec-core-3.5.4/lib /Library/Ruby/Gems/2.0.0/gems/rspec-core-3.5.4/exe/rspec --pattern spec/AAA/\\\\*_spec.rb\", \n        \"\", \n        \"Service \\\"W3SVC\\\"\", \n        \" WARN  WinRM::WinRMWebService : WinRM::WinRMWebService#run_powershell_script is deprecated. Use WinRM::CommandExecutor#run_powershell_script instead\", \n        \"  should be enabled\", \n        \" WARN  WinRM::WinRMWebService : WinRM::WinRMWebService#run_powershell_script is deprecated. Use WinRM::CommandExecutor#run_powershell_script instead\", \n        \"  should be running\", \n        \"\", \n        \"Finished in 9.7 seconds (files took 2.48 seconds to load)\", \n        \"2 examples, 0 failures\"\n    ]\n}\n\nPLAY RECAP ******************************************************************************************************************************************************\ncentos6-httpd01            : ok=4    changed=2    unreachable=0    failed=0   \ncentos6-httpd02            : ok=4    changed=2    unreachable=0    failed=0   \nwin2012-iis01              : ok=4    changed=3    unreachable=0    failed=0 \n```\n\n## 6.\u305d\u306e\u4ed6\nWindows\u30b5\u30fc\u30d0\u3078Serverspec\u3059\u308b\u969b\u306e\u30ea\u30bd\u30fc\u30b9\u30bf\u30a4\u30d7\u3084\u8a2d\u5b9a\u306a\u3069\u4ee5\u4e0b\u304c\u53c2\u8003\u306b\u306a\u308a\u307e\u3057\u305f\u3002\nhttps://github.com/mizzy/serverspec/blob/master/WINDOWS_SUPPORT.md\n\n\n", "tags": ["Ansible", "serverspec", "AdventCalendar", "devops", "Infrastracture_as_code"]}