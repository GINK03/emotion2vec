{"context": " More than 1 year has passed since last update.\u4ee5\u524d\u306fMeteor\u3068geth, Mocha\u3092\u5229\u7528\u3057\u3066\u30012\u30a2\u30ab\u30a6\u30f3\u30c8\u9593\u306e\u9001\u91d1\u306e\u30c6\u30b9\u30c8\u3001\u30b3\u30f3\u30c8\u30e9\u30af\u30c8\u3078\u306e\u9001\u91d1\u306e\u30c6\u30b9\u30c8\u3092\u884c\u3044\u307e\u3057\u305f\u3002\n\u4eca\u56de\u306f\u5b9f\u969b\u306bMeteor\u304b\u3089\u30b3\u30f3\u30c8\u30e9\u30af\u30c8\u3078\u9001\u91d1\u3057\u3001Solidity\u3067\u8a18\u8ff0\u3057\u305f\u30b9\u30de\u30fc\u30c8\u30b3\u30f3\u30c8\u30e9\u30af\u30c8\u306e\u95a2\u6570\u3092\u52d5\u304b\u3057\u3066\u307f\u3088\u3046\u3068\u601d\u3044\u307e\u3059\u3002\nMeteor\u306e\u4f7f\u3044\u65b9\u306f Meteor\u306e\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8 \u306b\u8a73\u3057\u304f\u66f8\u304b\u308c\u3066\u3044\u307e\u3059\u3002\n\n\u3084\u308a\u305f\u3044\u3053\u3068\n\n\u30dc\u30bf\u30f3\u306eclick\u30a4\u30d9\u30f3\u30c8\u3092\u53d7\u3051\u53d6\u308a\u3001\u30b3\u30f3\u30c8\u30e9\u30af\u30c8\u3078\u9001\u91d1\u3059\u308b\n\u30c8\u30e9\u30f3\u30b6\u30af\u30b7\u30e7\u30f3\u3092Meteor\u306eCollection\u3067\u7ba1\u7406\u3059\u308b\n\u30de\u30a4\u30cb\u30f3\u30b0\u304c\u5b8c\u4e86\u3057\u305f\u3053\u3068\u3092\u691c\u77e5\u3059\u308b\n\u30b9\u30de\u30fc\u30c8\u30b3\u30f3\u30c8\u30e9\u30af\u30c8\u306e\u72b6\u614b\u3092\u78ba\u8a8d\u3059\u308b\n\n\n\u6c17\u3092\u3064\u3051\u308b\u3053\u3068: Meteor\u3068Ethereum\u3092\u5206\u96e2\u3059\u308b\n\u5b9f\u88c5\u306b\u5165\u308b\u524d\u306b\u3001Dapp using Meteor \u306b\u66f8\u304b\u308c\u3066\u3044\u305f\u30a2\u30c9\u30d0\u30a4\u30b9\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n\nput ethereum related stuff into client/lib/ethereum/somefile.js\nuse myCollection.observe({added: func, changed: func, removed: func}) to communicate to ethereum, keep ethereum logic out of your app as much as possible. This way you just write and read from your reactive collections and the observe functions will handle the rest (e.g. sendTransactions)\nFilters etc will add logs etc to your collections. So you keep all the callback mess out of your app logic.\n\n\nEthereum\u306b\u63a5\u7d9a\u3059\u308b\u90e8\u5206\u3092\u3001\u306a\u308b\u3079\u304fMeteor\u304b\u3089\u5206\u96e2\u3059\u308b\u3053\u3068\u304c\u30dd\u30a4\u30f3\u30c8\u306e\u3088\u3046\u3067\u3059\u3002\n\u3053\u308c\u3092\u8e0f\u307e\u3048\u3066\u3001\u524d\u56de\u306e\u30c6\u30b9\u30c8\u30b3\u30fc\u30c9\u304b\u3089\u6539\u5584\u3059\u308b\u65b9\u91dd\u3092\u7acb\u3066\u307e\u3059\u3002\n\n\u524d\u56de\u306e\u30b3\u30fc\u30c9\u304b\u3089\u306e\u6539\u5584\u70b9\n\n\u30b9\u30de\u30fc\u30c8\u30b3\u30f3\u30c8\u30e9\u30af\u30c8\u306e\u4e00\u9023\u306e\u6d41\u308c\u3092\u8a66\u3059\u305f\u3081\u306b\u8907\u6570\u306e\u30c8\u30e9\u30f3\u30b6\u30af\u30b7\u30e7\u30f3\u3092\u767a\u884c\u3059\u308b\u306e\u3067\u3001\u305d\u308c\u3089\u3092Collection\u306b\u5165\u308c\u3066\u7ba1\u7406\u3059\u308b\n\u30c8\u30e9\u30f3\u30b6\u30af\u30b7\u30e7\u30f3\u767a\u884c\u5f8c\u3001\u30de\u30a4\u30cb\u30f3\u30b0\u304c\u5b8c\u4e86\u3057\u305f\u3053\u3068\u306e\u691c\u77e5\u3092setInterval\u3067\u306f\u306a\u304feth.filter\u3067\u884c\u3046\u3088\u3046\u306b\u3059\u308b\nCollection\u306e\u72b6\u614b\u76e3\u8996\u3001\u30de\u30a4\u30cb\u30f3\u30b0\u5b8c\u4e86\u306e\u76e3\u8996\u3092client/lib/ethereum/observeTransactions.js\u3068\u3057\u3066\u5206\u96e2\u3059\u308b\n\n\u3053\u308c\u3089\u306b\u6c17\u3092\u3064\u3051\u306a\u304c\u3089\u5b9f\u88c5\u3092\u884c\u3063\u3066\u3044\u304d\u307e\u3059\u3002\n\n\u30c8\u30e9\u30f3\u30b6\u30af\u30b7\u30e7\u30f3\u3092Meteor\u306eCollection\u3067\u7ba1\u7406\u3059\u308b\n\u307e\u305a\u306f\u3001Blockchain\u3078\u767a\u884c\u3057\u305f\u30c8\u30e9\u30f3\u30b6\u30af\u30b7\u30e7\u30f3\u3092MongoDB\u3067\u7ba1\u7406\u3067\u304d\u308b\u3088\u3046\u306b\u3057\u307e\u3059\u3002\n\napp/client/lib/collections.js\nTransactions = new Mongo.Collection('transactions', {connection: null});\n\n\n\n\u30dc\u30bf\u30f3\u306eclick\u30a4\u30d9\u30f3\u30c8\u3092\u53d7\u3051\u53d6\u308a\u3001\u30b3\u30f3\u30c8\u30e9\u30af\u30c8\u3078\u9001\u91d1\u3059\u308b\nMeteor\u306etemplate\u306b\u30dc\u30bf\u30f3\u3092\u8a2d\u7f6e\u3057\u3001JS\u5074\u3067\u30dc\u30bf\u30f3\u306eclick\u30a4\u30d9\u30f3\u30c8\u3092\u53d7\u3051\u53d6\u308a\u307e\u3059\u3002\n\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u3067\u30c8\u30e9\u30f3\u30b6\u30af\u30b7\u30e7\u30f3\u3092\u767a\u884c\u3057\u307e\u3059\u3002\n\napp/client/app.html\n<template name=\"purchase\">\n  <button class=\"purchase\">\u51fa\u54c1\u3059\u308b</button>\n</template>\n\n\n\napp/client/app.js\nTemplate.purchase.events({\n  'click .purchase': function() {\n    var txObject = {\n      value: 20,\n      gas: 300000,\n      from: web3.eth.accounts[0]\n    };\n    var contractInstance = PurchaseContract.at(\"contractAddress\");\n    contractInstance.Purchase(null, txObject, function(err, result){\n      if (!err) {\n        var txId = Helpers.makeId('tx', result);\n        Transactions.upsert(txId, { $set: {\n          transactionHash: result\n        } });\n      }\n    });\n  },\n});\n\n\ncontractInstance.Purchase\u306e\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u3067Collection\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\nCollection\u306e\u7d4c\u904e\u306e\u76e3\u8996\u306e\u30b3\u30fc\u30c9\u3092\u3001\u30de\u30cb\u30e5\u30a2\u30eb\u306e\u901a\u308aclient/lib/ethereum/\u306b\u7f6e\u304d\u307e\u3059\u3002\nTransaction.observe({added: func, changed: func, removed: func})\u306e\u3088\u3046\u306b\u8a18\u8ff0\u3059\u308b\u3053\u3068\u3067\u3001\u30ec\u30b3\u30fc\u30c9\u304c\u4f5c\u6210\u30fb\u66f4\u65b0\u30fb\u524a\u9664\u3055\u308c\u305f\u3053\u3068\u3092\u53d7\u3051\u53d6\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\nclient/lib/ethereum/observeTransactions.js\ncollectionObservers[collectionObservers.length] = Transactions.find({}).observe({\n  added: function(newDocument) {\n    console.log(\"added\");\n    checkTransactionConfirmations(newDocument);\n  },\n  changed: function(newDocument) {\n    console.log(\"changed\");\n    checkTransactionConfirmations(newDocument);\n  },\n  removed: function(document) {\n    console.log(\"removed\");\n  }\n});\n\n\n\n\u30de\u30a4\u30cb\u30f3\u30b0\u304c\u5b8c\u4e86\u3057\u305f\u3053\u3068\u3092\u691c\u77e5\u3059\u308b\nweb3.eth.filter(\"latest\").watch\u3092\u8a2d\u5b9a\u3059\u308b\u3068\u3001\u65b0\u3057\u3044\u30d6\u30ed\u30c3\u30af\u304c\u6765\u308b\u3054\u3068\u306b\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u3092\u5b9f\u884c\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\u3053\u306e\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u306e\u4e2d\u3067\u3001\u8a72\u5f53\u306e\u30c8\u30e9\u30f3\u30b6\u30af\u30b7\u30e7\u30f3\u306e\u30de\u30a4\u30cb\u30f3\u30b0\u304c\u5b8c\u4e86\u3057\u3066\u3044\u308b\u304b\u3092\u30c1\u30a7\u30c3\u30af\u3057\u3001\u5b8c\u4e86\u3057\u3066\u3044\u305f\u5834\u5408\u306f\u30a6\u30a9\u30c3\u30c1\u3092\u505c\u6b62\u3057\u307e\u3059\u3002\n\nclient/lib/ethereum/observeTransactions.js\nvar filter = web3.eth.filter(\"latest\").watch(function(e, blockHash) {\n  web3.eth.getTransaction(tx.transactionHash, function(e, transaction) {\n    web3.eth.getTransactionReceipt(tx.transactionHash, function(e, receipt) {\n      if (e || !receipt || !transaction) return;\n\n    var txId = Helpers.makeId('tx', tx.transactionHash);\n      if (receipt) {\n        // \u30a6\u30a9\u30ec\u30c3\u30c8\u3084\u30b3\u30f3\u30c8\u30e9\u30af\u30c8\u306e\u6b8b\u9ad8\u78ba\u8a8d\u306a\u3069\u3092\u3053\u3053\u3067\u884c\u3046\n        filter.stopWatching();\n      }\n    });\n  });\n});\n\n\n\n\u30b9\u30de\u30fc\u30c8\u30b3\u30f3\u30c8\u30e9\u30af\u30c8\u306e\u72b6\u614b\u3092\u78ba\u8a8d\u3059\u308b\n\u30b9\u30de\u30fc\u30c8\u30b3\u30f3\u30c8\u30e9\u30af\u30c8\u3092\u4f5c\u6210\u3059\u308b\u969b\u306e\u30b3\u30c4\u306e\u3072\u3068\u3064\u306b\u300c\u72b6\u614b\u3092\u8a2d\u5b9a\u3057\u3066\u304a\u304f\u300d\u3068\u3044\u3046\u306e\u304c\u3042\u308a\u307e\u3059\u3002\n(Youtube\u306b\u30e9\u30a4\u30d6\u30b3\u30fc\u30c7\u30a3\u30f3\u30b0\u306e\u52d5\u753b \u304c\u3042\u308b\u306e\u3067\u305c\u3072\u898b\u3066\u307f\u3066\u304f\u3060\u3055\u3044)\n\u3053\u306e\u30b9\u30de\u30fc\u30c8\u30b3\u30f3\u30c8\u30e9\u30af\u30c8\u306e\u4f8b\u3067\u306f\u3001\u4f55\u5ea6\u304b\u30c8\u30e9\u30f3\u30b6\u30af\u30b7\u30e7\u30f3\u3092\u767a\u884c\u3057\u3066\u3044\u304f\u3053\u3068\u306b\u3088\u3063\u3066\u3001\u30b9\u30de\u30fc\u30c8\u30b3\u30f3\u30c8\u30e9\u30af\u30c8\u306e\u72b6\u614b\u304c\u5909\u5316\u3057\u3066\u3044\u304d\u307e\u3059\u3002\n\u4f8b\u3048\u3070\u5546\u54c1\u304c\u9673\u5217\u3055\u308c\u305f\u72b6\u614b\u3067\u3042\u308c\u3070\u3001\u6b21\u306e\u30a2\u30af\u30b7\u30e7\u30f3\u306f\u8cfc\u5165\u304c\u3067\u304d\u308b\u3088\u3046\u306b\u3059\u308b\u3001\u3068\u3044\u3046\u3088\u3046\u306b\u3001\u72b6\u614b\u3092\u691c\u77e5\u3057\u3066\u3001\u305d\u306e\u72b6\u614b\u3054\u3068\u306b\u30ed\u30b0\u3092\u3068\u3063\u305f\u308a\u3001\u30a2\u30d7\u30ea\u306e\u6b21\u306e\u30a2\u30af\u30b7\u30e7\u30f3\u3092\u5909\u3048\u3066\u3044\u304d\u307e\u3059\u3002\n\u72b6\u614b\u691c\u77e5\u306e\u65b9\u6cd5\u306f2\u7a2e\u985e\u3042\u308a\u307e\u3059\u3002\n- \u72b6\u614b(State)\u3092\u53d6\u5f97\n- \u30a4\u30d9\u30f3\u30c8\u3092\u691c\u77e5\nSolidity\u5074\u3067\u306e\u30a4\u30d9\u30f3\u30c8\u304a\u3088\u3073\u72b6\u614b\u306e\u8a18\u8ff0\u306f\u3053\u306e\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002\n\nclient/contracts/PurchaseContract.sol\nenum State { Created, Locked, Inactive }\nState public state;\nfunction Purchase()\n{\n    seller = msg.sender;\n    value = msg.value / 2;\n    if (2 * value != msg.value) throw;\n    state = State.Created;\n    created(); // \u30a4\u30d9\u30f3\u30c8\u767a\u884c\n}\nevent created();\n\n\n\n\u72b6\u614b\u3092\u53d6\u5f97\u3059\u308b\nState\u304cpublic\u306b\u306a\u3063\u3066\u3044\u308b\u306e\u3067\u3001call()\u30e1\u30bd\u30c3\u30c9\u3067\u53d6\u5f97\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\nenum\u578b\u3067\u8a2d\u5b9a\u3057\u3066\u3044\u307e\u3059\u304c\u3001\u623b\u308a\u5024\u306fBigNumber\u578b\u306b\u306a\u3063\u3066\u3044\u308b\u3088\u3046\u3067\u3059\u3002\ncontractInstance.state.call().toNumber(10) //0, 1, 2\u306e\u3044\u305a\u308c\u304b\u304c\u8fd4\u3063\u3066\u304f\u308b\n\n\n\u30a4\u30d9\u30f3\u30c8\u3092\u691c\u77e5\u3059\u308b\n\u30b9\u30de\u30fc\u30c8\u30b3\u30f3\u30c8\u30e9\u30af\u30c8\u5185\u3067\u767a\u884c\u3057\u305f\u30a4\u30d9\u30f3\u30c8\u3092\u30a6\u30a9\u30c3\u30c1\u3057\u3001\u691c\u77e5\u3057\u3066\u3044\u304d\u307e\u3059\u3002\n\u30a4\u30d9\u30f3\u30c8\u306e\u30a6\u30a9\u30c3\u30c1\u306f\u3001Javascript API\u306eContract Events \u3092\u53c2\u8003\u306b\u8a2d\u5b9a\u3057\u307e\u3057\u305f\u3002\n\u4eca\u56de\u306fallEvents\u3092\u4f7f\u3063\u3066\u3059\u3079\u3066\u306e\u30a4\u30d9\u30f3\u30c8\u3092\u30a6\u30a9\u30c3\u30c1\u3057\u307e\u3057\u305f\u304c\u3001\u7279\u5b9a\u306e\u30a4\u30d9\u30f3\u30c8\u306e\u307f\u3092\u53d7\u3051\u308b\u3053\u3068\u3082\u3067\u304d\u308b\u3088\u3046\u3067\u3059\u3002\n\nclient/lib/ethereum/observeTransactions.js\nvar contractInstance = PurchaseContract.at(\"contractAddress\");\nvar events = contractInstance.allEvents();\nevents.watch(function(error, event) {\n  if (!error) {\n    // (\u4eca\u56de\u306e\u4f8b\u3067\u306f\u3001Session\u306b\u72b6\u614b\u3092\u5165\u308c\u3066\u3001\u72b6\u614b\u3054\u3068\u306b\u30dc\u30bf\u30f3\u306e\u51fa\u3057\u5206\u3051\u3092\u3057\u307e\u3057\u305f)\n    Session.set(\"contractState\", event.event);\n  }\n});\n\n\n\n\u307e\u3068\u3081\nMeteor\u3001MongoDB\u3068geth\u3092\u5229\u7528\u3057\u3066\u3001\u30b9\u30de\u30fc\u30c8\u30b3\u30f3\u30c8\u30e9\u30af\u30c8\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u4f5c\u6210\u3001\u95a2\u6570\u306e\u5b9f\u884c\u3001\u72b6\u614b\u306e\u76e3\u8996\u3092\u884c\u3044\u307e\u3057\u305f\u3002\n\u4eca\u56de\u4f5c\u6210\u3057\u305f\u30b3\u30fc\u30c9\u306fGitHub\u306b\u3042\u308a\u307e\u3059\u306e\u3067\u3001\u3082\u3057\u3088\u3051\u308c\u3070\u3054\u89a7\u304f\u3060\u3055\u3044\u3002\ngeth\u3068\u306e\u63a5\u7d9a\u76e3\u8996\u306a\u3069\u3001\u3088\u308a\u9ad8\u6a5f\u80fd\u306a\u30a2\u30d7\u30ea\u3092\u4f5c\u308a\u305f\u3044\u65b9\u306f\u3001Meteor Dapp Wallet \u304c\u975e\u5e38\u306b\u53c2\u8003\u306a\u308b\u306e\u3067\u3001\u305d\u3061\u3089\u3082\u3054\u89a7\u304f\u3060\u3055\u3044\u3002\n\n\u4ee5\u524d\u306fMeteor\u3068geth, Mocha\u3092\u5229\u7528\u3057\u3066\u3001[2\u30a2\u30ab\u30a6\u30f3\u30c8\u9593\u306e\u9001\u91d1\u306e\u30c6\u30b9\u30c8](http://qiita.com/azusa-kikuchi/items/8892f97235e958906de5)\u3001[\u30b3\u30f3\u30c8\u30e9\u30af\u30c8\u3078\u306e\u9001\u91d1\u306e\u30c6\u30b9\u30c8](http://qiita.com/azusa-kikuchi/items/89b6adbeaade021c52e5)\u3092\u884c\u3044\u307e\u3057\u305f\u3002\n\u4eca\u56de\u306f\u5b9f\u969b\u306bMeteor\u304b\u3089\u30b3\u30f3\u30c8\u30e9\u30af\u30c8\u3078\u9001\u91d1\u3057\u3001Solidity\u3067\u8a18\u8ff0\u3057\u305f\u30b9\u30de\u30fc\u30c8\u30b3\u30f3\u30c8\u30e9\u30af\u30c8\u306e\u95a2\u6570\u3092\u52d5\u304b\u3057\u3066\u307f\u3088\u3046\u3068\u601d\u3044\u307e\u3059\u3002\nMeteor\u306e\u4f7f\u3044\u65b9\u306f [Meteor\u306e\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8](http://docs.meteor.com/#/full/api) \u306b\u8a73\u3057\u304f\u66f8\u304b\u308c\u3066\u3044\u307e\u3059\u3002\n\n## \u3084\u308a\u305f\u3044\u3053\u3068\n\n- \u30dc\u30bf\u30f3\u306eclick\u30a4\u30d9\u30f3\u30c8\u3092\u53d7\u3051\u53d6\u308a\u3001\u30b3\u30f3\u30c8\u30e9\u30af\u30c8\u3078\u9001\u91d1\u3059\u308b\n- \u30c8\u30e9\u30f3\u30b6\u30af\u30b7\u30e7\u30f3\u3092Meteor\u306eCollection\u3067\u7ba1\u7406\u3059\u308b\n- \u30de\u30a4\u30cb\u30f3\u30b0\u304c\u5b8c\u4e86\u3057\u305f\u3053\u3068\u3092\u691c\u77e5\u3059\u308b\n- \u30b9\u30de\u30fc\u30c8\u30b3\u30f3\u30c8\u30e9\u30af\u30c8\u306e\u72b6\u614b\u3092\u78ba\u8a8d\u3059\u308b\n\n## \u6c17\u3092\u3064\u3051\u308b\u3053\u3068: Meteor\u3068Ethereum\u3092\u5206\u96e2\u3059\u308b\n\n\u5b9f\u88c5\u306b\u5165\u308b\u524d\u306b\u3001[Dapp using Meteor](https://github.com/ethereum/wiki/wiki/Dapp-using-Meteor#%C3%90app-code-structure) \u306b\u66f8\u304b\u308c\u3066\u3044\u305f\u30a2\u30c9\u30d0\u30a4\u30b9\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n>\n- put ethereum related stuff into client/lib/ethereum/somefile.js\n- use myCollection.observe({added: func, changed: func, removed: func}) to communicate to ethereum, keep ethereum logic out of your app as much as possible. This way you just write and read from your reactive collections and the observe functions will handle the rest (e.g. sendTransactions)\n- Filters etc will add logs etc to your collections. So you keep all the callback mess out of your app logic.\n\nEthereum\u306b\u63a5\u7d9a\u3059\u308b\u90e8\u5206\u3092\u3001\u306a\u308b\u3079\u304fMeteor\u304b\u3089\u5206\u96e2\u3059\u308b\u3053\u3068\u304c\u30dd\u30a4\u30f3\u30c8\u306e\u3088\u3046\u3067\u3059\u3002\n\u3053\u308c\u3092\u8e0f\u307e\u3048\u3066\u3001\u524d\u56de\u306e\u30c6\u30b9\u30c8\u30b3\u30fc\u30c9\u304b\u3089\u6539\u5584\u3059\u308b\u65b9\u91dd\u3092\u7acb\u3066\u307e\u3059\u3002\n\n### \u524d\u56de\u306e\u30b3\u30fc\u30c9\u304b\u3089\u306e\u6539\u5584\u70b9\n\n- \u30b9\u30de\u30fc\u30c8\u30b3\u30f3\u30c8\u30e9\u30af\u30c8\u306e\u4e00\u9023\u306e\u6d41\u308c\u3092\u8a66\u3059\u305f\u3081\u306b\u8907\u6570\u306e\u30c8\u30e9\u30f3\u30b6\u30af\u30b7\u30e7\u30f3\u3092\u767a\u884c\u3059\u308b\u306e\u3067\u3001\u305d\u308c\u3089\u3092Collection\u306b\u5165\u308c\u3066\u7ba1\u7406\u3059\u308b\n- \u30c8\u30e9\u30f3\u30b6\u30af\u30b7\u30e7\u30f3\u767a\u884c\u5f8c\u3001\u30de\u30a4\u30cb\u30f3\u30b0\u304c\u5b8c\u4e86\u3057\u305f\u3053\u3068\u306e\u691c\u77e5\u3092`setInterval`\u3067\u306f\u306a\u304f`eth.filter`\u3067\u884c\u3046\u3088\u3046\u306b\u3059\u308b\n- Collection\u306e\u72b6\u614b\u76e3\u8996\u3001\u30de\u30a4\u30cb\u30f3\u30b0\u5b8c\u4e86\u306e\u76e3\u8996\u3092`client/lib/ethereum/observeTransactions.js`\u3068\u3057\u3066\u5206\u96e2\u3059\u308b\n\n\u3053\u308c\u3089\u306b\u6c17\u3092\u3064\u3051\u306a\u304c\u3089\u5b9f\u88c5\u3092\u884c\u3063\u3066\u3044\u304d\u307e\u3059\u3002\n\n## \u30c8\u30e9\u30f3\u30b6\u30af\u30b7\u30e7\u30f3\u3092Meteor\u306eCollection\u3067\u7ba1\u7406\u3059\u308b\n\n\u307e\u305a\u306f\u3001Blockchain\u3078\u767a\u884c\u3057\u305f\u30c8\u30e9\u30f3\u30b6\u30af\u30b7\u30e7\u30f3\u3092MongoDB\u3067\u7ba1\u7406\u3067\u304d\u308b\u3088\u3046\u306b\u3057\u307e\u3059\u3002\n\n```app/client/lib/collections.js\nTransactions = new Mongo.Collection('transactions', {connection: null});\n```\n\n## \u30dc\u30bf\u30f3\u306eclick\u30a4\u30d9\u30f3\u30c8\u3092\u53d7\u3051\u53d6\u308a\u3001\u30b3\u30f3\u30c8\u30e9\u30af\u30c8\u3078\u9001\u91d1\u3059\u308b\n\nMeteor\u306etemplate\u306b\u30dc\u30bf\u30f3\u3092\u8a2d\u7f6e\u3057\u3001JS\u5074\u3067\u30dc\u30bf\u30f3\u306eclick\u30a4\u30d9\u30f3\u30c8\u3092\u53d7\u3051\u53d6\u308a\u307e\u3059\u3002\n\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u3067\u30c8\u30e9\u30f3\u30b6\u30af\u30b7\u30e7\u30f3\u3092\u767a\u884c\u3057\u307e\u3059\u3002\n\n```app/client/app.html\n<template name=\"purchase\">\n  <button class=\"purchase\">\u51fa\u54c1\u3059\u308b</button>\n</template>\n```\n\n```app/client/app.js\nTemplate.purchase.events({\n  'click .purchase': function() {\n    var txObject = {\n      value: 20,\n      gas: 300000,\n      from: web3.eth.accounts[0]\n    };\n    var contractInstance = PurchaseContract.at(\"contractAddress\");\n    contractInstance.Purchase(null, txObject, function(err, result){\n      if (!err) {\n        var txId = Helpers.makeId('tx', result);\n        Transactions.upsert(txId, { $set: {\n          transactionHash: result\n        } });\n      }\n    });\n  },\n});\n```\n\n`contractInstance.Purchase`\u306e\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u3067Collection\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\nCollection\u306e\u7d4c\u904e\u306e\u76e3\u8996\u306e\u30b3\u30fc\u30c9\u3092\u3001\u30de\u30cb\u30e5\u30a2\u30eb\u306e\u901a\u308a`client/lib/ethereum/`\u306b\u7f6e\u304d\u307e\u3059\u3002\n`Transaction.observe({added: func, changed: func, removed: func})`\u306e\u3088\u3046\u306b\u8a18\u8ff0\u3059\u308b\u3053\u3068\u3067\u3001\u30ec\u30b3\u30fc\u30c9\u304c\u4f5c\u6210\u30fb\u66f4\u65b0\u30fb\u524a\u9664\u3055\u308c\u305f\u3053\u3068\u3092\u53d7\u3051\u53d6\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\n```client/lib/ethereum/observeTransactions.js\ncollectionObservers[collectionObservers.length] = Transactions.find({}).observe({\n  added: function(newDocument) {\n    console.log(\"added\");\n    checkTransactionConfirmations(newDocument);\n  },\n  changed: function(newDocument) {\n    console.log(\"changed\");\n    checkTransactionConfirmations(newDocument);\n  },\n  removed: function(document) {\n    console.log(\"removed\");\n  }\n});\n```\n\n## \u30de\u30a4\u30cb\u30f3\u30b0\u304c\u5b8c\u4e86\u3057\u305f\u3053\u3068\u3092\u691c\u77e5\u3059\u308b\n\n`web3.eth.filter(\"latest\").watch`\u3092\u8a2d\u5b9a\u3059\u308b\u3068\u3001\u65b0\u3057\u3044\u30d6\u30ed\u30c3\u30af\u304c\u6765\u308b\u3054\u3068\u306b\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u3092\u5b9f\u884c\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\u3053\u306e\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u306e\u4e2d\u3067\u3001\u8a72\u5f53\u306e\u30c8\u30e9\u30f3\u30b6\u30af\u30b7\u30e7\u30f3\u306e\u30de\u30a4\u30cb\u30f3\u30b0\u304c\u5b8c\u4e86\u3057\u3066\u3044\u308b\u304b\u3092\u30c1\u30a7\u30c3\u30af\u3057\u3001\u5b8c\u4e86\u3057\u3066\u3044\u305f\u5834\u5408\u306f\u30a6\u30a9\u30c3\u30c1\u3092\u505c\u6b62\u3057\u307e\u3059\u3002\n\n```client/lib/ethereum/observeTransactions.js\nvar filter = web3.eth.filter(\"latest\").watch(function(e, blockHash) {\n  web3.eth.getTransaction(tx.transactionHash, function(e, transaction) {\n    web3.eth.getTransactionReceipt(tx.transactionHash, function(e, receipt) {\n      if (e || !receipt || !transaction) return;\n\n    var txId = Helpers.makeId('tx', tx.transactionHash);\n      if (receipt) {\n        // \u30a6\u30a9\u30ec\u30c3\u30c8\u3084\u30b3\u30f3\u30c8\u30e9\u30af\u30c8\u306e\u6b8b\u9ad8\u78ba\u8a8d\u306a\u3069\u3092\u3053\u3053\u3067\u884c\u3046\n        filter.stopWatching();\n      }\n    });\n  });\n});\n```\n\n## \u30b9\u30de\u30fc\u30c8\u30b3\u30f3\u30c8\u30e9\u30af\u30c8\u306e\u72b6\u614b\u3092\u78ba\u8a8d\u3059\u308b\n\n\u30b9\u30de\u30fc\u30c8\u30b3\u30f3\u30c8\u30e9\u30af\u30c8\u3092\u4f5c\u6210\u3059\u308b\u969b\u306e\u30b3\u30c4\u306e\u3072\u3068\u3064\u306b\u300c\u72b6\u614b\u3092\u8a2d\u5b9a\u3057\u3066\u304a\u304f\u300d\u3068\u3044\u3046\u306e\u304c\u3042\u308a\u307e\u3059\u3002\n(Youtube\u306b[\u30e9\u30a4\u30d6\u30b3\u30fc\u30c7\u30a3\u30f3\u30b0\u306e\u52d5\u753b](https://www.youtube.com/watch?v=seU7DykOxfc) \u304c\u3042\u308b\u306e\u3067\u305c\u3072\u898b\u3066\u307f\u3066\u304f\u3060\u3055\u3044)\n\n\u3053\u306e\u30b9\u30de\u30fc\u30c8\u30b3\u30f3\u30c8\u30e9\u30af\u30c8\u306e\u4f8b\u3067\u306f\u3001\u4f55\u5ea6\u304b\u30c8\u30e9\u30f3\u30b6\u30af\u30b7\u30e7\u30f3\u3092\u767a\u884c\u3057\u3066\u3044\u304f\u3053\u3068\u306b\u3088\u3063\u3066\u3001\u30b9\u30de\u30fc\u30c8\u30b3\u30f3\u30c8\u30e9\u30af\u30c8\u306e\u72b6\u614b\u304c\u5909\u5316\u3057\u3066\u3044\u304d\u307e\u3059\u3002\n\u4f8b\u3048\u3070\u5546\u54c1\u304c\u9673\u5217\u3055\u308c\u305f\u72b6\u614b\u3067\u3042\u308c\u3070\u3001\u6b21\u306e\u30a2\u30af\u30b7\u30e7\u30f3\u306f\u8cfc\u5165\u304c\u3067\u304d\u308b\u3088\u3046\u306b\u3059\u308b\u3001\u3068\u3044\u3046\u3088\u3046\u306b\u3001\u72b6\u614b\u3092\u691c\u77e5\u3057\u3066\u3001\u305d\u306e\u72b6\u614b\u3054\u3068\u306b\u30ed\u30b0\u3092\u3068\u3063\u305f\u308a\u3001\u30a2\u30d7\u30ea\u306e\u6b21\u306e\u30a2\u30af\u30b7\u30e7\u30f3\u3092\u5909\u3048\u3066\u3044\u304d\u307e\u3059\u3002\n\n\u72b6\u614b\u691c\u77e5\u306e\u65b9\u6cd5\u306f2\u7a2e\u985e\u3042\u308a\u307e\u3059\u3002\n- \u72b6\u614b(State)\u3092\u53d6\u5f97\n- \u30a4\u30d9\u30f3\u30c8\u3092\u691c\u77e5\n\nSolidity\u5074\u3067\u306e\u30a4\u30d9\u30f3\u30c8\u304a\u3088\u3073\u72b6\u614b\u306e\u8a18\u8ff0\u306f\u3053\u306e\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002\n\n```client/contracts/PurchaseContract.sol\nenum State { Created, Locked, Inactive }\nState public state;\nfunction Purchase()\n{\n    seller = msg.sender;\n    value = msg.value / 2;\n    if (2 * value != msg.value) throw;\n    state = State.Created;\n    created(); // \u30a4\u30d9\u30f3\u30c8\u767a\u884c\n}\nevent created();\n```\n\n### \u72b6\u614b\u3092\u53d6\u5f97\u3059\u308b\n\nState\u304cpublic\u306b\u306a\u3063\u3066\u3044\u308b\u306e\u3067\u3001`call()`\u30e1\u30bd\u30c3\u30c9\u3067\u53d6\u5f97\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\nenum\u578b\u3067\u8a2d\u5b9a\u3057\u3066\u3044\u307e\u3059\u304c\u3001\u623b\u308a\u5024\u306fBigNumber\u578b\u306b\u306a\u3063\u3066\u3044\u308b\u3088\u3046\u3067\u3059\u3002\n\n```\ncontractInstance.state.call().toNumber(10) //0, 1, 2\u306e\u3044\u305a\u308c\u304b\u304c\u8fd4\u3063\u3066\u304f\u308b\n```\n\n### \u30a4\u30d9\u30f3\u30c8\u3092\u691c\u77e5\u3059\u308b\n\n\u30b9\u30de\u30fc\u30c8\u30b3\u30f3\u30c8\u30e9\u30af\u30c8\u5185\u3067\u767a\u884c\u3057\u305f\u30a4\u30d9\u30f3\u30c8\u3092\u30a6\u30a9\u30c3\u30c1\u3057\u3001\u691c\u77e5\u3057\u3066\u3044\u304d\u307e\u3059\u3002\n\n\u30a4\u30d9\u30f3\u30c8\u306e\u30a6\u30a9\u30c3\u30c1\u306f\u3001[Javascript API\u306eContract Events](https://github.com/ethereum/wiki/wiki/JavaScript-API#contract-events) \u3092\u53c2\u8003\u306b\u8a2d\u5b9a\u3057\u307e\u3057\u305f\u3002\n\u4eca\u56de\u306f`allEvents`\u3092\u4f7f\u3063\u3066\u3059\u3079\u3066\u306e\u30a4\u30d9\u30f3\u30c8\u3092\u30a6\u30a9\u30c3\u30c1\u3057\u307e\u3057\u305f\u304c\u3001\u7279\u5b9a\u306e\u30a4\u30d9\u30f3\u30c8\u306e\u307f\u3092\u53d7\u3051\u308b\u3053\u3068\u3082\u3067\u304d\u308b\u3088\u3046\u3067\u3059\u3002\n\n```client/lib/ethereum/observeTransactions.js\nvar contractInstance = PurchaseContract.at(\"contractAddress\");\nvar events = contractInstance.allEvents();\nevents.watch(function(error, event) {\n  if (!error) {\n    // (\u4eca\u56de\u306e\u4f8b\u3067\u306f\u3001Session\u306b\u72b6\u614b\u3092\u5165\u308c\u3066\u3001\u72b6\u614b\u3054\u3068\u306b\u30dc\u30bf\u30f3\u306e\u51fa\u3057\u5206\u3051\u3092\u3057\u307e\u3057\u305f)\n    Session.set(\"contractState\", event.event);\n  }\n});\n```\n\n## \u307e\u3068\u3081\n\nMeteor\u3001MongoDB\u3068geth\u3092\u5229\u7528\u3057\u3066\u3001\u30b9\u30de\u30fc\u30c8\u30b3\u30f3\u30c8\u30e9\u30af\u30c8\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u4f5c\u6210\u3001\u95a2\u6570\u306e\u5b9f\u884c\u3001\u72b6\u614b\u306e\u76e3\u8996\u3092\u884c\u3044\u307e\u3057\u305f\u3002\n\u4eca\u56de\u4f5c\u6210\u3057\u305f\u30b3\u30fc\u30c9\u306f[GitHub](https://github.com/azusa-kikuike/learningDapp)\u306b\u3042\u308a\u307e\u3059\u306e\u3067\u3001\u3082\u3057\u3088\u3051\u308c\u3070\u3054\u89a7\u304f\u3060\u3055\u3044\u3002\n\ngeth\u3068\u306e\u63a5\u7d9a\u76e3\u8996\u306a\u3069\u3001\u3088\u308a\u9ad8\u6a5f\u80fd\u306a\u30a2\u30d7\u30ea\u3092\u4f5c\u308a\u305f\u3044\u65b9\u306f\u3001[Meteor Dapp Wallet](https://github.com/ethereum/meteor-dapp-wallet) \u304c\u975e\u5e38\u306b\u53c2\u8003\u306a\u308b\u306e\u3067\u3001\u305d\u3061\u3089\u3082\u3054\u89a7\u304f\u3060\u3055\u3044\u3002\n", "tags": ["Meteor", "Ethereum", "Blockchain"]}