{"context": "\n\n\u57f7\u7b46\u6642\u70b9\u306e\u74b0\u5883\n\u3053\u3053\u3067\u306fstrongSwan, xl2tpd\u3092\u4f7f\u7528\u3057\u3066IPSec/L2TP\u306aVPN\u3092\u4f7f\u7528\u53ef\u80fd\u306b\u3057\u307e\u3059\u3002\n\nUbuntuServer 16.04.1 LTS (SELinux \u7121\u52b9\u5316)\nstrongSwan v5.3.5\nxl2tpd v1.3.6\n\n\n\u3084\u308a\u305f\u3044\u4e8b\n\u5916\u51fa\u5148\u304b\u3089\u81ea\u5b85\u306e\u30de\u30b7\u30f3\u3078\u30a2\u30af\u30bb\u30b9\u3067\u304d\u308b\u3088\u3046\u306b\u3057\u3066\u307f\u307e\u3059\u3002\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510             \u250c\u2500\u2500\u2500\u2500\u2500\u2510          \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 Android,Windows \u2502-(Internet)->\u2502 NAT \u2502--(LAN)-->\u2502 Server \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518             \u2514\u2500\u2500\u2500\u2500\u2500\u2518          \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\n\u4ee5\u4e0b\u306eOS\u3067\u63a5\u7d9a\u78ba\u8a8d\u3057\u3066\u3044\u307e\u3059\u3002\n\nWindows 10: L2TP/IPSec PSK\nAndroid 6.0.1: L2TP/IPSec PSK\n\n\n\u624b\u9806\n\n\u5fc5\u8981\u30a2\u30d7\u30ea\u306e\u5c0e\u5165\n$ sudo apt-get install -y strongswan xl2tpd\n\n\n\u5404\u7a2e\u8a2d\u5b9a\n\nstrongSwan (IPSec)\n\n/etc/ipsec.conf\n# IPSec \u63a5\u7d9a\u8a2d\u5b9a\n# \u4ee5\u4e0b\u306e\u8a18\u8ff0\u3092ipsec.conf\u3078\u8ffd\u8a18\u3059\u308b\u3002\u7d30\u304b\u3044\u8a2d\u5b9a\u9805\u76ee\u306f\u516c\u5f0f\u8cc7\u6599\u3092\u53c2\u7167\u3059\u308b\u3053\u3068\u3002\n# https://wiki.strongswan.org/projects/strongswan/wiki/IpsecConf\n\nconfig setup\n    # \u5fc5\u9808\u3002VPN\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u304cNAT\u306e\u5185\u5074\u306b\u3042\u308b\u5834\u5408\u306b\u5fc5\u8981\u3002\n    nat_traversal=yes\n# \u30c7\u30d5\u30a9\u30eb\u30c8\u8a2d\u5b9a(\u5168\u63a5\u7d9a\u306e\u5171\u901a\u8a2d\u5b9a\u304c\u8a18\u8ff0\u3055\u308c\u307e\u3059)\nconn %default\n    # \u5fc5\u9808\u3002strongSwan\u8d77\u52d5\u6642\u306b\u63a5\u7d9a\u30d7\u30ed\u30d5\u30a1\u30a4\u30eb\u3092\u53d7\u4fe1\u5f85\u6a5f\u72b6\u614b\u306b\u3059\u308b\u3002\n    auto=add\n# L2TP/IPSec\u7528\u63a5\u7d9a\u8a2d\u5b9a\nconn L2TP-NAT\n    # \u5fc5\u9808\u3002IPSec/L2TP\u3067\u306fIPSec\u306fHost to Host\u3067\u7e4b\u3050\u3002\n    type=transport\n    # \u7701\u7565\u53ef\u3002\u6307\u5b9a\u3059\u308b\u306a\u3089\u3070VPN\u30b5\u30fc\u30d0\u30fc\u306eIP\u30a2\u30c9\u30ec\u30b9\u3002\n    # (ex: 192.168.x.x)\n    #left=%any \n    # \u5fc5\u9808(default: pubkey)\u3002\u8a8d\u8a3c\u65b9\u5f0f\u3002\u4e8b\u524d\u5171\u6709\u9375\u3092\u4f7f\u7528\u3002\n    leftauth=psk\n    # \u7701\u7565\u53ef\u3002VPN\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u306eIP\u30a2\u30c9\u30ec\u30b9\n    # (ex: 192.168.y.y)\n    #right=%any\n    # \u5fc5\u9808\u3002\u8a8d\u8a3c\u65b9\u5f0f\u3002\u4e8b\u524d\u5171\u6709\u9375\u3092\u4f7f\u7528\u3002\n    rightauth=psk\n\n\n\n/etc/ipsec.secrets\n# IPSec \u8a8d\u8a3c\u7528\u60c5\u5831\n# \u4ee5\u4e0b\u306e\u8a18\u8ff0\u3092AAA\u3092\u57cb\u3081\u305f\u4e0a\u3067ipsec.secrets\u306e\u5148\u982d\u3078\u8ffd\u8a18\u3059\u308b\u3002\n# \u7d30\u304b\u3044\u8a2d\u5b9a\u9805\u76ee\u306f\u516c\u5f0f\u8cc7\u6599\u306ePSK\u306e\u7ae0\u3092\u53c2\u7167\u3059\u308b\u3053\u3068\u3002\n# https://wiki.strongswan.org/projects/strongswan/wiki/IpsecSecrets\n# (ex:\n#      : PSK \"abcd\")\n: PSK \"AAA\" #\u4e8b\u524d\u5171\u6709\u9375\n\n\n\nxl2tpd (L2TP)\n\n/etc/xl2tpd/xl2tpd.conf\n; \u4ee5\u4e0b\u306e\u8a18\u8ff0\u306ezA-zZ,XXX\u3092\u57cb\u3081\u305f\u3082\u306e\u3092\u5143\u30d5\u30a1\u30a4\u30eb\u3078\u8ffd\u8a18\u3059\u308b\u3002\n; \u7d30\u304b\u3044\u8a2d\u5b9a\u9805\u76ee\u306fman\u30b3\u30de\u30f3\u30c9\u3092\u53c2\u7167\u3059\u308b\u3053\u3068\u3002\n; man xl2tpd.conf\n\n[lns default]                               ; Our fallthrough LNS definition\n  ; VPN\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u3078\u632f\u308bIP\u30a2\u30c9\u30ec\u30b9\u7bc4\u56f2\n  ; (ex: 192.168.z.1-192.168.z.254)\n  ip range = zA-zZ                          ; * Allocate from this IP range\n  ; VPN\u30b5\u30fc\u30d0\u30fc\u306eIP\u30a2\u30c9\u30ec\u30b9\n  ; (ex: 192.168.x.x)\n  local ip = XXX                            ; * Our local IP to use\n  length bit = yes                          ; * Use length bit in payload?\n  refuse pap = yes                          ; * Refuse PAP authentication\n  refuse chap = yes                         ; * Refuse CHAP authentication\n  require authentication = yes              ; * Require peer to authenticate\n  name = l2tp                               ; * Report this as our hostname\n  pppoptfile = /etc/ppp/options.l2tpd.lns   ; * ppp options file\n\n\n\n/etc/ppp/options.l2tpd.lns\nname l2tp\nrefuse-pap\nrefuse-chap\nrefuse-mschap\nrequire-mschap-v2\nnodefaultroute\nlock\nnobsdcomp\nmtu 1280\nmru 1280\nlogfile /var/log/xl2tpd.log\n\n\n\n/etc/ppp/chap-secrets\n# \u4ee5\u4e0b\u306e\u8a18\u8ff0\u306eUserName ,Password\u3092\u57cb\u3081\u305f\u3082\u306e\u3092chap-secrets\u3078\u8ffd\u8a18\u3059\u308b\u3002\n# (ex: \"carol\" * \"abcd123\" *)\u3002\n\n# Secrets for authentication using CHAP\n# client    server  secret          IP addresses\n\"UserName\" * \"Password\" *\n\n\n\nsysctl\n\n/etc/sysctl.conf\n#\u30b5\u30fc\u30d0\u30fc\u304cVPN\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u3068\u5185\u90e8\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u3092\u7e4b\u3050\u30eb\u30fc\u30bf\u30fc\n#\u3068\u3057\u3066\u6a5f\u80fd\u3067\u304d\u308b\u3088\u3046\u4ee5\u4e0b\u306e\u8a2d\u5b9a\u3092sysctl.conf\u3078\u8ffd\u8a18\u3059\u308b\u3002\nnet.ipv4.ip_forward=1\n\n\n\n\u305d\u306e\u4ed6\u306e\u8a2d\u5b9a\n\n\nNAT\u306e\u30dd\u30fc\u30c8\u958b\u653e\nUDP 500,4500\u30dd\u30fc\u30c8\u306e\u53d7\u4fe1\u3092\u8a31\u53ef\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\n\u30eb\u30fc\u30bf\u30fc\u3092\u8a2d\u5b9a\u5909\u66f4\nVPN\u30b5\u30fc\u30d0\u30fc\u306e\u6240\u5c5e\u30cd\u30c3\u30c8\u306e\u30eb\u30fc\u30bf\u30fc\u306b\u306fVPN\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u3078\u632f\u3089\u308c\u308bIP\u30a2\u30c9\u30ec\u30b9\u306e\u7d4c\u8def\u8a2d\u5b9a\u3092\u884c\u3046\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n192.168.z.0/24 \u2192 192.168.x.x\n\n\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u306e\u8a2d\u5b9a\u5909\u66f4\nNAT\u306e\u5185\u5074\u306b\u3042\u308bVPN\u30b5\u30fc\u30d0\u30fc\u3078\u5916\u5074\u306eWindows\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u304b\u3089\u63a5\u7d9a\u3059\u308b\u5834\u5408\u3001Windows\u306f\u30ec\u30b8\u30b9\u30c8\u30ea\u304b\u3089\u8a2d\u5b9a\u5909\u66f4\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\nhttps://support.microsoft.com/ja-jp/kb/926179\n\n\n\n\u8a2d\u5b9a\u3092\u9069\u7528\nstrongSwan, xl2tpd\u3092\u518d\u8d77\u52d5\u3057\u307e\u3059\u3002VPN\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u304b\u3089\u63a5\u7d9a\u3067\u304d\u308c\u3070\u6210\u529f\u3002\n#\u30c7\u30fc\u30e2\u30f3\u3092\u518d\u8d77\u52d5\nsudo systemctl restart strongswan\nsudo systemctl restart xl2tpd\nsudo sysctl -p\n\n\n\u53c2\u8003\u8cc7\u6599\n\nIKEv1 Configuration Examples\nhttps://wiki.strongswan.org/projects/strongswan/wiki/IKEv1Examples)\nConfiguration Files\nhttps://wiki.strongswan.org/projects/strongswan/wiki/ConfigurationFiles\n\n\n# \u57f7\u7b46\u6642\u70b9\u306e\u74b0\u5883\n\u3053\u3053\u3067\u306fstrongSwan, xl2tpd\u3092\u4f7f\u7528\u3057\u3066IPSec/L2TP\u306aVPN\u3092\u4f7f\u7528\u53ef\u80fd\u306b\u3057\u307e\u3059\u3002\n\n* UbuntuServer 16.04.1 LTS (SELinux \u7121\u52b9\u5316)\n* strongSwan v5.3.5\n* xl2tpd v1.3.6\n\n# \u3084\u308a\u305f\u3044\u4e8b\n\u5916\u51fa\u5148\u304b\u3089\u81ea\u5b85\u306e\u30de\u30b7\u30f3\u3078\u30a2\u30af\u30bb\u30b9\u3067\u304d\u308b\u3088\u3046\u306b\u3057\u3066\u307f\u307e\u3059\u3002\n\n    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510             \u250c\u2500\u2500\u2500\u2500\u2500\u2510          \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n    \u2502 Android,Windows \u2502-(Internet)->\u2502 NAT \u2502--(LAN)-->\u2502 Server \u2502\n    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518             \u2514\u2500\u2500\u2500\u2500\u2500\u2518          \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\n\u4ee5\u4e0b\u306eOS\u3067\u63a5\u7d9a\u78ba\u8a8d\u3057\u3066\u3044\u307e\u3059\u3002\n\n* Windows 10: L2TP/IPSec PSK\n* Android 6.0.1: L2TP/IPSec PSK\n\n# \u624b\u9806\n## \u5fc5\u8981\u30a2\u30d7\u30ea\u306e\u5c0e\u5165\n```bash\n$ sudo apt-get install -y strongswan xl2tpd\n```\n\n## \u5404\u7a2e\u8a2d\u5b9a\n### strongSwan (IPSec)\n\n```bash:/etc/ipsec.conf\n# IPSec \u63a5\u7d9a\u8a2d\u5b9a\n# \u4ee5\u4e0b\u306e\u8a18\u8ff0\u3092ipsec.conf\u3078\u8ffd\u8a18\u3059\u308b\u3002\u7d30\u304b\u3044\u8a2d\u5b9a\u9805\u76ee\u306f\u516c\u5f0f\u8cc7\u6599\u3092\u53c2\u7167\u3059\u308b\u3053\u3068\u3002\n# https://wiki.strongswan.org/projects/strongswan/wiki/IpsecConf\n\nconfig setup\n    # \u5fc5\u9808\u3002VPN\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u304cNAT\u306e\u5185\u5074\u306b\u3042\u308b\u5834\u5408\u306b\u5fc5\u8981\u3002\n    nat_traversal=yes\n# \u30c7\u30d5\u30a9\u30eb\u30c8\u8a2d\u5b9a(\u5168\u63a5\u7d9a\u306e\u5171\u901a\u8a2d\u5b9a\u304c\u8a18\u8ff0\u3055\u308c\u307e\u3059)\nconn %default\n    # \u5fc5\u9808\u3002strongSwan\u8d77\u52d5\u6642\u306b\u63a5\u7d9a\u30d7\u30ed\u30d5\u30a1\u30a4\u30eb\u3092\u53d7\u4fe1\u5f85\u6a5f\u72b6\u614b\u306b\u3059\u308b\u3002\n    auto=add\n# L2TP/IPSec\u7528\u63a5\u7d9a\u8a2d\u5b9a\nconn L2TP-NAT\n    # \u5fc5\u9808\u3002IPSec/L2TP\u3067\u306fIPSec\u306fHost to Host\u3067\u7e4b\u3050\u3002\n    type=transport\n    # \u7701\u7565\u53ef\u3002\u6307\u5b9a\u3059\u308b\u306a\u3089\u3070VPN\u30b5\u30fc\u30d0\u30fc\u306eIP\u30a2\u30c9\u30ec\u30b9\u3002\n    # (ex: 192.168.x.x)\n    #left=%any \n    # \u5fc5\u9808(default: pubkey)\u3002\u8a8d\u8a3c\u65b9\u5f0f\u3002\u4e8b\u524d\u5171\u6709\u9375\u3092\u4f7f\u7528\u3002\n    leftauth=psk\n    # \u7701\u7565\u53ef\u3002VPN\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u306eIP\u30a2\u30c9\u30ec\u30b9\n    # (ex: 192.168.y.y)\n    #right=%any\n    # \u5fc5\u9808\u3002\u8a8d\u8a3c\u65b9\u5f0f\u3002\u4e8b\u524d\u5171\u6709\u9375\u3092\u4f7f\u7528\u3002\n    rightauth=psk\n```\n```bash:/etc/ipsec.secrets\n# IPSec \u8a8d\u8a3c\u7528\u60c5\u5831\n# \u4ee5\u4e0b\u306e\u8a18\u8ff0\u3092AAA\u3092\u57cb\u3081\u305f\u4e0a\u3067ipsec.secrets\u306e\u5148\u982d\u3078\u8ffd\u8a18\u3059\u308b\u3002\n# \u7d30\u304b\u3044\u8a2d\u5b9a\u9805\u76ee\u306f\u516c\u5f0f\u8cc7\u6599\u306ePSK\u306e\u7ae0\u3092\u53c2\u7167\u3059\u308b\u3053\u3068\u3002\n# https://wiki.strongswan.org/projects/strongswan/wiki/IpsecSecrets\n# (ex:\n#      : PSK \"abcd\")\n: PSK \"AAA\" #\u4e8b\u524d\u5171\u6709\u9375\n```\n\n### xl2tpd (L2TP)\n```bash:/etc/xl2tpd/xl2tpd.conf\n; \u4ee5\u4e0b\u306e\u8a18\u8ff0\u306ezA-zZ,XXX\u3092\u57cb\u3081\u305f\u3082\u306e\u3092\u5143\u30d5\u30a1\u30a4\u30eb\u3078\u8ffd\u8a18\u3059\u308b\u3002\n; \u7d30\u304b\u3044\u8a2d\u5b9a\u9805\u76ee\u306fman\u30b3\u30de\u30f3\u30c9\u3092\u53c2\u7167\u3059\u308b\u3053\u3068\u3002\n; man xl2tpd.conf\n\n[lns default]                               ; Our fallthrough LNS definition\n  ; VPN\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u3078\u632f\u308bIP\u30a2\u30c9\u30ec\u30b9\u7bc4\u56f2\n  ; (ex: 192.168.z.1-192.168.z.254)\n  ip range = zA-zZ                          ; * Allocate from this IP range\n  ; VPN\u30b5\u30fc\u30d0\u30fc\u306eIP\u30a2\u30c9\u30ec\u30b9\n  ; (ex: 192.168.x.x)\n  local ip = XXX                            ; * Our local IP to use\n  length bit = yes                          ; * Use length bit in payload?\n  refuse pap = yes                          ; * Refuse PAP authentication\n  refuse chap = yes                         ; * Refuse CHAP authentication\n  require authentication = yes              ; * Require peer to authenticate\n  name = l2tp                               ; * Report this as our hostname\n  pppoptfile = /etc/ppp/options.l2tpd.lns   ; * ppp options file\n```\n```bash:/etc/ppp/options.l2tpd.lns\nname l2tp\nrefuse-pap\nrefuse-chap\nrefuse-mschap\nrequire-mschap-v2\nnodefaultroute\nlock\nnobsdcomp\nmtu 1280\nmru 1280\nlogfile /var/log/xl2tpd.log\n```\n```bash:/etc/ppp/chap-secrets\n# \u4ee5\u4e0b\u306e\u8a18\u8ff0\u306eUserName ,Password\u3092\u57cb\u3081\u305f\u3082\u306e\u3092chap-secrets\u3078\u8ffd\u8a18\u3059\u308b\u3002\n# (ex: \"carol\" * \"abcd123\" *)\u3002\n\n# Secrets for authentication using CHAP\n# client\tserver\tsecret\t\t\tIP addresses\n\"UserName\" * \"Password\" *\n```\n\n### sysctl\n```bash:/etc/sysctl.conf\n#\u30b5\u30fc\u30d0\u30fc\u304cVPN\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u3068\u5185\u90e8\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u3092\u7e4b\u3050\u30eb\u30fc\u30bf\u30fc\n#\u3068\u3057\u3066\u6a5f\u80fd\u3067\u304d\u308b\u3088\u3046\u4ee5\u4e0b\u306e\u8a2d\u5b9a\u3092sysctl.conf\u3078\u8ffd\u8a18\u3059\u308b\u3002\nnet.ipv4.ip_forward=1\n```\n\n### \u305d\u306e\u4ed6\u306e\u8a2d\u5b9a\n* **NAT\u306e\u30dd\u30fc\u30c8\u958b\u653e**  \n  UDP 500,4500\u30dd\u30fc\u30c8\u306e\u53d7\u4fe1\u3092\u8a31\u53ef\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n* **\u30eb\u30fc\u30bf\u30fc\u3092\u8a2d\u5b9a\u5909\u66f4**  \n  VPN\u30b5\u30fc\u30d0\u30fc\u306e\u6240\u5c5e\u30cd\u30c3\u30c8\u306e\u30eb\u30fc\u30bf\u30fc\u306b\u306fVPN\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u3078\u632f\u3089\u308c\u308bIP\u30a2\u30c9\u30ec\u30b9\u306e\u7d4c\u8def\u8a2d\u5b9a\u3092\u884c\u3046\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002  \n  192.168.z.0/24 \u2192 192.168.x.x\n* **\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u306e\u8a2d\u5b9a\u5909\u66f4**  \n  NAT\u306e\u5185\u5074\u306b\u3042\u308bVPN\u30b5\u30fc\u30d0\u30fc\u3078\u5916\u5074\u306eWindows\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u304b\u3089\u63a5\u7d9a\u3059\u308b\u5834\u5408\u3001Windows\u306f\u30ec\u30b8\u30b9\u30c8\u30ea\u304b\u3089\u8a2d\u5b9a\u5909\u66f4\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002  \n  https://support.microsoft.com/ja-jp/kb/926179\n\n## \u8a2d\u5b9a\u3092\u9069\u7528\nstrongSwan, xl2tpd\u3092\u518d\u8d77\u52d5\u3057\u307e\u3059\u3002VPN\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u304b\u3089\u63a5\u7d9a\u3067\u304d\u308c\u3070\u6210\u529f\u3002\n\n```bash\n#\u30c7\u30fc\u30e2\u30f3\u3092\u518d\u8d77\u52d5\nsudo systemctl restart strongswan\nsudo systemctl restart xl2tpd\nsudo sysctl -p\n```\n\n# \u53c2\u8003\u8cc7\u6599\n\n* IKEv1 Configuration Examples  \n  https://wiki.strongswan.org/projects/strongswan/wiki/IKEv1Examples)\n* Configuration Files  \n  https://wiki.strongswan.org/projects/strongswan/wiki/ConfigurationFiles\n", "tags": ["VPN", "ipsec", "Ubuntu"]}