{"context": " More than 1 year has passed since last update.\n\nRoute53\u3067DNS\u5207\u308a\u66ff\u3048\u81ea\u52d5\u5316\u306e\u5b9f\u88c5\u3081\u3082\n\u74b0\u5883\u5207\u308a\u66ff\u3048\u306f\u3001\nRoute53\u306eWeighted Roud Robin(WRR)\u30ec\u30b3\u30fc\u30c9\u3067Weighted\u5024\u306e\u5909\u66f4\u3067\u5b9f\u73fe\n\u2192cli53\u3067\u7c21\u5358\u306bWRR\u30ec\u30b3\u30fc\u30c9\u66f4\u65b0\u3067\u304d\u306a\u3044\u305f\u3081\u3001dnscurl.pl\u3092\u5229\u7528\n\n\u5b9f\u884c\u74b0\u5883\nEC2(AmazonLinux)\n AWSCLI,cli53,jq,\n\n\u5b9f\u88c5\u3081\u3082\n\u2460Hosted Zone\u4f5c\u6210(\u5b58\u5728\u3057\u306a\u3044\u5834\u5408\uff09\nxxx.xxx\nHosted Zone ID:\u3081\u3082\u3057\u3066\u304a\u304f\n\u2461\uff12\u3064\u306eELB\u3092\u4f5c\u6210\nELB\u540d\u3001Endpoint\n\u2462Route53\u3067WRR\u30ec\u30b3\u30fc\u30c9\u4f5c\u6210(A\u30ec\u30b3\u30fc\u30c9\u306eAlias\uff09\nAlias Target:ELB\u306eEndpoint\nAlias Hosted Zone ID:\u3081\u3082\u3057\u3066\u304a\u304f\nSet ID:env1/env2\nWeighted:\n  ennv1 -> 255\n  ennv2 -> 0\n\n\u5207\u308a\u66ff\u3048\u30b9\u30af\u30ea\u30d7\u30c8\u306e\u6982\u8981\uff1a\n\u5f15\u6570\u3067\u53d7\u3051\u53d6\u308b\uff1a\n  HOSTED_ZONE_NAME=xxx.xxx\n  HOSTED_ZONE_ID=XXXXXXXXXXX\n  RECORD_SET=xxx.xxx.xxx\n  ALIAS_HOSTED_ZONE_ID=YYYYYYYYYY\n\n\u5207\u308a\u66ff\u3048\u524d\u306eWeight\u5024\u53d6\u5f97\n\nENV1_WEIGHT=$(aws route53 list-resource-record-sets --hosted-zone-id \"${HOSTED_ZONE_ID}\"|jq \".ResourceRecordSets[] | select(.Name == \\\"${RECORD_SET}.\\\" and .SetIdentifier == \\\"env1\\\") |.Weight\")\nENV2_WEIGHT=$(aws route53 list-resource-record-sets --hosted-zone-id \"${HOSTED_ZONE_ID}\"|jq \".ResourceRecordSets[] | select(.Name == \\\"${RECORD_SET}.\\\" and .SetIdentifier == \\\"env2\\\") |.Weight\")\n\n\nweighted\u50240/255\u3067\u65b0\u65e7\u74b0\u5883\u5224\u65ad\u3001\u5207\u308a\u66ff\u3048\u5f8c\u306eWeighted\u5024\n(0->255,255->0)\nNEW_ENV1_WEIGHT\nNEW_ENV2_WEIGHT\n\u30a8\u30e9\u30fc\u51e6\u7406\n\nDNS\u5207\u308a\u66ff\u3048\n\nsed \\\n-e \"s/%ENV1_WEIGHT%/${NEW_ENV1_WEIGHT}/g\" \\\n-e \"s/%ENV2_WEIGHT%/${NEW_ENV2_WEIGHT}/g\" \\\n-e \"s/%ELB_ENDPOINT_1%/${ELB_ENDPOINT_1}/g\" \\\n-e \"s/%ELB_ENDPOINT_2%/${ELB_ENDPOINT_2}/g\" \\\n-e \"s/%RECORD_SET%/${RECORD_SET}/g\" \\\n-e \"s/%ALIAS_HOSTED_ZONE_ID%/${ALIAS_HOSTED_ZONE_ID}/g\" \\\n/path/to/route53_template_xxxxxx.xml \\\n>/path/to/route53_work_xxxxxx.xml\n\nchange_result=$(/path/to/dnscurl.pl --keyfile /path/to/.aws_secrets --keyname=as-aws-account -- -H \"Content-Type: text/xml; charset=UTF-8\" -X POST --upload-file /path/to/route53_work_xxxxxx.xml https://route53.amazonaws.com/2013-04-01/hostedzone/${HOSTED_ZONE_ID}/rrset)\n\n\u30a8\u30e9\u30fc\u51e6\u7406\n\n\n\n\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\n/path/to/route53_template_xxxxxx.xml\n<ChangeResourceRecordSetsRequest xmlns=\"https://route53.amazonaws.com/doc/2013-04-01/\">\n   <ChangeBatch>\n      <Comment>\n      This change creates two weighted resource record sets,  each of which has one value.\n      </Comment>\n      <Changes>\n         <Change>\n            <Action>UPSERT</Action>\n            <ResourceRecordSet>\n               <Name>%RECORD_SET%.</Name>\n               <Type>A</Type>\n               <SetIdentifier>env1</SetIdentifier> \n               <Weight>%ENV1_WEIGHT%</Weight>\n               <AliasTarget>\n                   <HostedZoneId>%ALIAS_HOSTED_ZONE_ID%</HostedZoneId>\n                   <DNSName>%ELB_ENDPOINT_1%</DNSName>\n                  <EvaluateTargetHealth>false</EvaluateTargetHealth>\n               </AliasTarget>\n            </ResourceRecordSet>\n         </Change>\n         <Change>\n            <Action>UPSERT</Action>\n            <ResourceRecordSet>\n               <Name>%RECORD_SET%.</Name>\n               <Type>A</Type>\n               <SetIdentifier>env2</SetIdentifier> \n               <Weight>%ENV2_WEIGHT%</Weight>\n               <AliasTarget>\n                  <HostedZoneId>%ALIAS_HOSTED_ZONE_ID%</HostedZoneId>\n                  <DNSName>%ELB_ENDPOINT_2%</DNSName>\n                  <EvaluateTargetHealth>false</EvaluateTargetHealth>\n              </AliasTarget>\n            </ResourceRecordSet>\n         </Change>\n      </Changes>\n   </ChangeBatch>\n</ChangeResourceRecordSetsRequest>\n\n# Route53\u3067DNS\u5207\u308a\u66ff\u3048\u81ea\u52d5\u5316\u306e\u5b9f\u88c5\u3081\u3082\n\n\u74b0\u5883\u5207\u308a\u66ff\u3048\u306f\u3001\nRoute53\u306eWeighted Roud Robin(WRR)\u30ec\u30b3\u30fc\u30c9\u3067Weighted\u5024\u306e\u5909\u66f4\u3067\u5b9f\u73fe\n\n\u2192cli53\u3067\u7c21\u5358\u306bWRR\u30ec\u30b3\u30fc\u30c9\u66f4\u65b0\u3067\u304d\u306a\u3044\u305f\u3081\u3001dnscurl.pl\u3092\u5229\u7528\n\n## \u5b9f\u884c\u74b0\u5883\n EC2(AmazonLinux)\n AWSCLI,cli53,jq,\n\n## \u5b9f\u88c5\u3081\u3082\n\n\u2460Hosted Zone\u4f5c\u6210(\u5b58\u5728\u3057\u306a\u3044\u5834\u5408\uff09\nxxx.xxx\nHosted Zone ID:\u3081\u3082\u3057\u3066\u304a\u304f\n\n\u2461\uff12\u3064\u306eELB\u3092\u4f5c\u6210\nELB\u540d\u3001Endpoint\n\n\u2462Route53\u3067WRR\u30ec\u30b3\u30fc\u30c9\u4f5c\u6210(A\u30ec\u30b3\u30fc\u30c9\u306eAlias\uff09\nAlias Target:ELB\u306eEndpoint\nAlias Hosted Zone ID:\u3081\u3082\u3057\u3066\u304a\u304f\nSet ID:env1/env2\nWeighted:\n  ennv1 -> 255\n  ennv2 -> 0\n\n\n## \u5207\u308a\u66ff\u3048\u30b9\u30af\u30ea\u30d7\u30c8\u306e\u6982\u8981\uff1a\n\n\u5f15\u6570\u3067\u53d7\u3051\u53d6\u308b\uff1a\n  HOSTED_ZONE_NAME=xxx.xxx\n  HOSTED_ZONE_ID=XXXXXXXXXXX\n  RECORD_SET=xxx.xxx.xxx\n  ALIAS_HOSTED_ZONE_ID=YYYYYYYYYY\n\n### \u5207\u308a\u66ff\u3048\u524d\u306eWeight\u5024\u53d6\u5f97\n<pre><code>\nENV1_WEIGHT=$(aws route53 list-resource-record-sets --hosted-zone-id \"${HOSTED_ZONE_ID}\"|jq \".ResourceRecordSets[] | select(.Name == \\\"${RECORD_SET}.\\\" and .SetIdentifier == \\\"env1\\\") |.Weight\")\nENV2_WEIGHT=$(aws route53 list-resource-record-sets --hosted-zone-id \"${HOSTED_ZONE_ID}\"|jq \".ResourceRecordSets[] | select(.Name == \\\"${RECORD_SET}.\\\" and .SetIdentifier == \\\"env2\\\") |.Weight\")\n</code></pre>\n\n\n\n### weighted\u50240/255\u3067\u65b0\u65e7\u74b0\u5883\u5224\u65ad\u3001\u5207\u308a\u66ff\u3048\u5f8c\u306eWeighted\u5024\n(0->255,255->0)\nNEW_ENV1_WEIGHT\nNEW_ENV2_WEIGHT\n\u30a8\u30e9\u30fc\u51e6\u7406\n\n### DNS\u5207\u308a\u66ff\u3048\n<pre><code>\nsed \\\n-e \"s/%ENV1_WEIGHT%/${NEW_ENV1_WEIGHT}/g\" \\\n-e \"s/%ENV2_WEIGHT%/${NEW_ENV2_WEIGHT}/g\" \\\n-e \"s/%ELB_ENDPOINT_1%/${ELB_ENDPOINT_1}/g\" \\\n-e \"s/%ELB_ENDPOINT_2%/${ELB_ENDPOINT_2}/g\" \\\n-e \"s/%RECORD_SET%/${RECORD_SET}/g\" \\\n-e \"s/%ALIAS_HOSTED_ZONE_ID%/${ALIAS_HOSTED_ZONE_ID}/g\" \\\n/path/to/route53_template_xxxxxx.xml \\\n>/path/to/route53_work_xxxxxx.xml\n\nchange_result=$(/path/to/dnscurl.pl --keyfile /path/to/.aws_secrets --keyname=as-aws-account -- -H \"Content-Type: text/xml; charset=UTF-8\" -X POST --upload-file /path/to/route53_work_xxxxxx.xml https://route53.amazonaws.com/2013-04-01/hostedzone/${HOSTED_ZONE_ID}/rrset)\n\n\u30a8\u30e9\u30fc\u51e6\u7406\n\n</code></pre>\n\n### \u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\n/path/to/route53_template_xxxxxx.xml\n\n    <ChangeResourceRecordSetsRequest xmlns=\"https://route53.amazonaws.com/doc/2013-04-01/\">\n       <ChangeBatch>\n          <Comment>\n          This change creates two weighted resource record sets,  each of which has one value.\n          </Comment>\n          <Changes>\n             <Change>\n                <Action>UPSERT</Action>\n                <ResourceRecordSet>\n                   <Name>%RECORD_SET%.</Name>\n                   <Type>A</Type>\n                   <SetIdentifier>env1</SetIdentifier> \n                   <Weight>%ENV1_WEIGHT%</Weight>\n                   <AliasTarget>\n                       <HostedZoneId>%ALIAS_HOSTED_ZONE_ID%</HostedZoneId>\n                       <DNSName>%ELB_ENDPOINT_1%</DNSName>\n                      <EvaluateTargetHealth>false</EvaluateTargetHealth>\n                   </AliasTarget>\n                </ResourceRecordSet>\n             </Change>\n             <Change>\n                <Action>UPSERT</Action>\n                <ResourceRecordSet>\n                   <Name>%RECORD_SET%.</Name>\n                   <Type>A</Type>\n                   <SetIdentifier>env2</SetIdentifier> \n                   <Weight>%ENV2_WEIGHT%</Weight>\n                   <AliasTarget>\n                      <HostedZoneId>%ALIAS_HOSTED_ZONE_ID%</HostedZoneId>\n                      <DNSName>%ELB_ENDPOINT_2%</DNSName>\n                      <EvaluateTargetHealth>false</EvaluateTargetHealth>\n                  </AliasTarget>\n                </ResourceRecordSet>\n             </Change>\n          </Changes>\n       </ChangeBatch>\n    </ChangeResourceRecordSetsRequest>\n", "tags": ["AWS", "route53", "blue_green_deployment", "Immutable_Infrastructure"]}