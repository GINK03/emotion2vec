{"context": " More than 1 year has passed since last update.\n\n\u3053\u308c\u306f\u306a\u306b\u304b\nRDS\u306eSlowLog\u3092Slack\u306b\u901a\u77e5\u3057\u305f\u304b\u3063\u305f\u3002\nAWS\u306eAPI\u3067 download-db-log-file-portion \u304c\u3042\u3063\u305f\u304c\u901a\u77e5\u3059\u308b\u306b\u306f\u4f7f\u3044\u52dd\u624b\u304c\u60aa\u304b\u3063\u305f\u306e\u3067\nMySQL\u306e\u30c6\u30fc\u30d6\u30eb\u306bSlowLog\u3092\u4fdd\u5b58\u3057\u3066\u3001\u305d\u308c\u3092Fluentd\u304b\u3089SELECT & Clear \u3092\u3059\u308b\u3053\u3068\u306b\u3057\u305f\u3002\n\u3053\u306e\u8a18\u4e8b\u306fMysql\u306e\u8a2d\u5b9a\u306a\u306e\u3067\u3001\u4ed6\u306eDB\u306e\u5834\u5408\u306f\u3088\u3057\u306a\u306b\u5909\u66f4\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n\u4f7f\u3063\u305f\u3082\u306e\nfluent-plugin-slack : https://github.com/sowawa/fluent-plugin-slack\nfluent-plugin-rds-slowlog : https://github.com/kenjiskywalker/fluent-plugin-rds-slowlog\n\nRDS\u306e\u8a2d\u5b9a\n\n\nParameter Group\n\nslow_query_log : 1\nlong_query_time : ?\u79d2(\u3054\u81ea\u7531\u306b)\nlog_output : TABLE\n\n\n\n\u30e6\u30fc\u30b6\u30fc\u4f5c\u6210\n\nCREATE USER hoge;\nSET PASSWORD FOR 'hoge'@'%' = PASSWORD('hogehoge');\nGRANT select ON mysql.slow_log TO hoge;\nGRANT EXECUTE ON PROCEDURE mysql.rds_rotate_slow_log TO hoge;\n\n\n\n\nSlack\u306e\u8a2d\u5b9a\n\nIncomingWebHook\u3067WebhookURL\u53d6\u5f97\n\n\nFluentd\u306e\u8a2d\u5b9a\n<source>\n  type rds_slowlog\n  tag rds.slow_query\n  host ****************************.ap-northeast-1.rds.amazonaws.com\n  username hoge\n  password hogehoge\n</source>\n\n<match rds.slow_query>\n  type buffered_slack\n  webhook_url [WebhookURL]\n  channel [channel\u540d]\n  username [\u901a\u77e5\u30e6\u30fc\u30b6\u30fc\u540d]\n  color danger\n  message \"start_time:%s\\r\\nuser_host:%s\\r\\nquery_time:%s\\r\\nlock_time:%s\\r\\nrows_sent:%s\\r\\nrows_examined:%s\\r\\ndb:%s\\r\\nlast_insert_id:%s\\r\\ninsert_id:%s\\r\\nserver_id:%s\\r\\nsql_text:%s\"\n  message_keys start_time,user_host,query_time,lock_time,rows_sent,rows_examined,db,last_insert_id,insert_id,server_id,sql_text\n  flush_interval 1m\n</match>\n\n\n\u901a\u77e5\u3055\u308c\u305f\u3082\u306e\n\n\n\u6700\u5f8c\u306b\n\u305d\u306e\u307e\u307e\u4f7f\u3046\u3068\u5371\u967a\u306a\u306e\u3067\u9069\u5f53\u306b\u5909\u66f4\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n## \u3053\u308c\u306f\u306a\u306b\u304b\nRDS\u306eSlowLog\u3092Slack\u306b\u901a\u77e5\u3057\u305f\u304b\u3063\u305f\u3002\nAWS\u306eAPI\u3067 `download-db-log-file-portion` \u304c\u3042\u3063\u305f\u304c\u901a\u77e5\u3059\u308b\u306b\u306f\u4f7f\u3044\u52dd\u624b\u304c\u60aa\u304b\u3063\u305f\u306e\u3067\nMySQL\u306e\u30c6\u30fc\u30d6\u30eb\u306bSlowLog\u3092\u4fdd\u5b58\u3057\u3066\u3001\u305d\u308c\u3092Fluentd\u304b\u3089SELECT & Clear \u3092\u3059\u308b\u3053\u3068\u306b\u3057\u305f\u3002\n\u3053\u306e\u8a18\u4e8b\u306fMysql\u306e\u8a2d\u5b9a\u306a\u306e\u3067\u3001\u4ed6\u306eDB\u306e\u5834\u5408\u306f\u3088\u3057\u306a\u306b\u5909\u66f4\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n## \u4f7f\u3063\u305f\u3082\u306e\nfluent-plugin-slack : https://github.com/sowawa/fluent-plugin-slack\nfluent-plugin-rds-slowlog : https://github.com/kenjiskywalker/fluent-plugin-rds-slowlog\n\n## RDS\u306e\u8a2d\u5b9a\n- Parameter Group\n  - slow_query_log : 1\n  - long_query_time : ?\u79d2(\u3054\u81ea\u7531\u306b)\n  - log_output : TABLE\n\n- \u30e6\u30fc\u30b6\u30fc\u4f5c\u6210\n  - CREATE USER hoge;\n  - SET PASSWORD FOR 'hoge'@'%' = PASSWORD('hogehoge');\n  - GRANT select ON mysql.slow_log TO hoge;\n  - GRANT EXECUTE ON PROCEDURE mysql.rds_rotate_slow_log TO hoge;\n\n## Slack\u306e\u8a2d\u5b9a\n- IncomingWebHook\u3067WebhookURL\u53d6\u5f97\n\n## Fluentd\u306e\u8a2d\u5b9a\n\n```\n<source>\n  type rds_slowlog\n  tag rds.slow_query\n  host ****************************.ap-northeast-1.rds.amazonaws.com\n  username hoge\n  password hogehoge\n</source>\n\n<match rds.slow_query>\n  type buffered_slack\n  webhook_url [WebhookURL]\n  channel [channel\u540d]\n  username [\u901a\u77e5\u30e6\u30fc\u30b6\u30fc\u540d]\n  color danger\n  message \"start_time:%s\\r\\nuser_host:%s\\r\\nquery_time:%s\\r\\nlock_time:%s\\r\\nrows_sent:%s\\r\\nrows_examined:%s\\r\\ndb:%s\\r\\nlast_insert_id:%s\\r\\ninsert_id:%s\\r\\nserver_id:%s\\r\\nsql_text:%s\"\n  message_keys start_time,user_host,query_time,lock_time,rows_sent,rows_examined,db,last_insert_id,insert_id,server_id,sql_text\n  flush_interval 1m\n</match>\n```\n\n## \u901a\u77e5\u3055\u308c\u305f\u3082\u306e\n![\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2015-07-06 11.07.25.png](https://qiita-image-store.s3.amazonaws.com/0/53224/ee06efd6-0ce4-e6c2-80bb-963c297e8aaa.png)\n\n\n## \u6700\u5f8c\u306b\n\u305d\u306e\u307e\u307e\u4f7f\u3046\u3068\u5371\u967a\u306a\u306e\u3067\u9069\u5f53\u306b\u5909\u66f4\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n", "tags": ["AWS", "Slack", "RDS", "fluentd"]}