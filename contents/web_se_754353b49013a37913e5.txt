{"context": "Route53\u3078\u306e\u30ea\u30af\u30a8\u30b9\u30c8\u306b5\u30ea\u30af\u30a8\u30b9\u30c8/1s\u306e\u5236\u9650\u304c\u3042\u308b\u3002\nhttp://docs.aws.amazon.com/ja_jp/Route53/latest/DeveloperGuide/DNSLimitations.html\n\u5236\u9650\u3092\u8d85\u3048\u308b\u3068\u3001Bad Request\u3068\u3057\u3066\u767b\u9332\u306b\u5931\u6557\u3059\u308b\u3002\n\u4e0a\u8a18\u5236\u9650\u306f\u3001AWS\u30a2\u30ab\u30a6\u30f3\u30c8\u6bce\u306a\u306e\u3067\u3001AutoScaling\u3092\u591a\u6570\u5229\u7528\u3059\u308b\u306a\u3069Limit\u306b\u9054\u3059\u308b\u53ef\u80fd\u6027\u304c\u9ad8\u3044\u3068\u8003\u3048\u307e\u3059\u3002\n\u3064\u3044\u3066\u306f\u3001\u30ea\u30c8\u30e9\u30a4\u51e6\u7406\u304c\u5fc5\u9808\u3068\u306a\u308a\u307e\u3059\u3002\n\u4e0b\u8a18\u4f8b\u3067\u306f\u30015\u56de\u30ea\u30c8\u30e9\u30a4\u3092\u3059\u308buser-data script\u306e\u4f8b\u306b\u306a\u308a\u307e\u3059\u3002\n#!/bin/bash\nexec > >(tee /var/log/user-data.log|logger -t user-data -s 2>/dev/console) 2>&1\n\nPRIVATE_IP=`wget -q -O - http://169.254.169.254/latest/meta-data/local-ipv4`\nINSTANCE_ID=`wget -q -O - http://169.254.169.254/latest/meta-data/instance-id`\n\nHOSTED_ZONE=`aws route53 list-hosted-zones | jq --arg domain_name ${DOMAIN_NAME} -r '.HostedZones[] | select(.Name |contains($domain_name))|.Id' | sed 's/\\/hostedzone\\///' | cut -d '\"' -f 2`\n\n\ncat << _EOT_ > /var/tmp/route53.json\n{\n  \"Comment\": \"create CNAME record\",\n  \"Changes\": [\n    {\n      \"Action\": \"UPSERT\",\n      \"ResourceRecordSet\": {\n        \"Name\": \"${INSTANCE_ID}.example.com.\",\n        \"Type\": \"A\",\n        \"TTL\": 60,\n        \"ResourceRecords\": [\n          {\n            \"Value\": \"${PRIVATE_IP}\"\n          }\n        ]\n      }\n    }\n  ]\n}\n_EOT_\n\nfor i in $(seq 1 5)\ndo\n sleep 5\n STATUSCODE=$(aws route53 change-resource-record-sets --hosted-zone-id ${HOSTED_ZONE} --change-batch file:////var/tmp/route53.json)\n if [ $? -ne 0 ]; then\n   echo 'Route53 update failed.'\nelse\n   break;\n fi\n\n if [ $i -ge 5 ]; then\n  echo 'Route53 update timeout'\n  break;\n fi\n echo \"Retry $i ...\"\ndone\n\nRoute53\u3078\u306e\u30ea\u30af\u30a8\u30b9\u30c8\u306b5\u30ea\u30af\u30a8\u30b9\u30c8/1s\u306e\u5236\u9650\u304c\u3042\u308b\u3002\nhttp://docs.aws.amazon.com/ja_jp/Route53/latest/DeveloperGuide/DNSLimitations.html\n\u5236\u9650\u3092\u8d85\u3048\u308b\u3068\u3001Bad Request\u3068\u3057\u3066\u767b\u9332\u306b\u5931\u6557\u3059\u308b\u3002\n\u4e0a\u8a18\u5236\u9650\u306f\u3001AWS\u30a2\u30ab\u30a6\u30f3\u30c8\u6bce\u306a\u306e\u3067\u3001AutoScaling\u3092\u591a\u6570\u5229\u7528\u3059\u308b\u306a\u3069Limit\u306b\u9054\u3059\u308b\u53ef\u80fd\u6027\u304c\u9ad8\u3044\u3068\u8003\u3048\u307e\u3059\u3002\n\n\u3064\u3044\u3066\u306f\u3001\u30ea\u30c8\u30e9\u30a4\u51e6\u7406\u304c\u5fc5\u9808\u3068\u306a\u308a\u307e\u3059\u3002\n\u4e0b\u8a18\u4f8b\u3067\u306f\u30015\u56de\u30ea\u30c8\u30e9\u30a4\u3092\u3059\u308buser-data script\u306e\u4f8b\u306b\u306a\u308a\u307e\u3059\u3002\n\n```\n#!/bin/bash\nexec > >(tee /var/log/user-data.log|logger -t user-data -s 2>/dev/console) 2>&1\n\nPRIVATE_IP=`wget -q -O - http://169.254.169.254/latest/meta-data/local-ipv4`\nINSTANCE_ID=`wget -q -O - http://169.254.169.254/latest/meta-data/instance-id`\n\nHOSTED_ZONE=`aws route53 list-hosted-zones | jq --arg domain_name ${DOMAIN_NAME} -r '.HostedZones[] | select(.Name |contains($domain_name))|.Id' | sed 's/\\/hostedzone\\///' | cut -d '\"' -f 2`\n\n\ncat << _EOT_ > /var/tmp/route53.json\n{\n  \"Comment\": \"create CNAME record\",\n  \"Changes\": [\n    {\n      \"Action\": \"UPSERT\",\n      \"ResourceRecordSet\": {\n        \"Name\": \"${INSTANCE_ID}.example.com.\",\n        \"Type\": \"A\",\n        \"TTL\": 60,\n        \"ResourceRecords\": [\n          {\n            \"Value\": \"${PRIVATE_IP}\"\n          }\n        ]\n      }\n    }\n  ]\n}\n_EOT_\n\nfor i in $(seq 1 5)\ndo\n sleep 5\n STATUSCODE=$(aws route53 change-resource-record-sets --hosted-zone-id ${HOSTED_ZONE} --change-batch file:////var/tmp/route53.json)\n if [ $? -ne 0 ]; then\n   echo 'Route53 update failed.'\nelse\n   break;\n fi\n\n if [ $i -ge 5 ]; then\n  echo 'Route53 update timeout'\n  break;\n fi\n echo \"Retry $i ...\"\ndone\n```\n", "tags": ["route53", "aws-cli", "AWS"]}