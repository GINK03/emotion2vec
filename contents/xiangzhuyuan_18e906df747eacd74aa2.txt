{"context": "\u5982\u679c\u4f60\u4f7f\u7528Rails\u4ee5\u53ca\u5b83\u7684 active record, \u4f60\u4e5f\u8bb8\u5df2\u7ecf\u4e86\u89e3\u4e86\u901a\u8fc7\u4f7f\u7528\u65b9\u6cd5indcludes \u6765\u8fdb\u884c\u6570\u636e\u7684eager \u52a0\u8f7d. \u4f46\u662f\u4f60\u53ef\u80fd\u4f1a\u53d1\u73b0\u5bf9\u4e8e\u8fd9\u4e2a\u65b9\u6cd5\u6cd5\u80cc\u540e rails \u4ee5\u53ca activerecord \u7684\u5b9e\u73b0\u662f\u53d6\u51b3\u4e8e\u4e0d\u540c\u7684\u4e0a\u4e0b\u6587\u7684. \u6709\u65f6\u5019\u4f60\u53ef\u80fd\u4f1a\u53d1\u73b0\u62ff\u5230\u7684\u67e5\u8be2\u8bed\u53e5\u5f88\u7b80\u5355, \u800c\u6709\u65f6\u5374\u662f\u4e00\u4e2a\u76f8\u5bf9\u5f88\u5927\u7684\u67e5\u8be2\u8bed\u53e5. \u800c\u4e14\u5bf9\u4e8e\u6bcf\u4e00\u4e2a\u5b57\u6bb5\u90fd\u5df2\u7ecf\u522b\u540d\u4e86\u5462. \u800c\u4e14\u6211\u4eec\u540c\u65f6\u8fd8\u6709preload \u65b9\u6cd5\u548ceager_load \u65b9\u6cd5, \u800c\u4ed6\u4eec\u662f\u5426\u80fd\u591f\u83b7\u53d6\u5230\u7cfb\u7edf\u7684\u7ed3\u679c\u5462? \u5728 Rails4 \u4e2d\u53c8\u53d1\u751f\u4e86\u4ec0\u4e48\u53d8\u5316\u5462? \u6709\u70b9\u6a21\u7cca\u8bf4\u4e0d\u6e05\u90a3\u5c31\u6211\u4eec\u4e00\u8d77\u6765\u770b\u770b\u5230\u5e95\u4ed6\u4eec\u80cc\u540e\u6709\u4ec0\u4e48 \u7384\u5999\u4e4b\u5904 .\n\nstep 1\n\u9996\u9009, \u6211\u4eec\u6765\u4f7f\u7528Active Record \u7c7b\u8fd8\u6709\u805a\u5408\u5b9a\u4e49\u672c\u6b21\u4f7f\u7528\u5230\u7684\u573a\u666f:\nclass User < ActiveRecord::Base\n  has_many :addresses\nend\n\nclass Address < ActiveRecord::Base\n  belongs_to :user\nend\n\n\u6211\u4eec\u518d\u6765\u9020\u70b9\u6570\u636e\nrob = User.create!(name: \"Robert Pankowecki\", email: \"robert@example.org\")\nbob = User.create!(name: \"Bob Doe\", email: \"bob@example.org\")\n\nrob.addresses.create!(country: \"Poland\", city: \"Wroc\u0142aw\", postal_code: \"55-555\", street: \"Rynek\")\nrob.addresses.create!(country: \"France\", city: \"Paris\", postal_code: \"75008\", street: \"8 rue Chambiges\")\nbob.addresses.create!(country: \"Germany\", city: \"Berlin\", postal_code: \"10551\", street: \"Tiergarten\")\n\n\n\nRails3\n\u4e00\u822c\u6765\u8bf4, \u5982\u679c\u60f3\u8981\u4f7f\u7528eager loading \u7684\u529f\u80fd, \u5c31\u5e94\u8be5\u4f7f\u7528#includes\u65b9\u6cd5, \u8fd9\u4e2a\u65b9\u6cd5\u4ece Rails1? 2? \u5c31\u5f00\u59cb\u63a8\u8350\u4f7f\u7528\u4e86. \u4f60\u4f1a\u53d1\u73b0\u5176\u5b9e\u5b83\u4f1a\u67092\u4e2a query \u53d1\u51fa:\nUser.includes(:addresses)\n#  SELECT \"users\".* FROM \"users\"\n#  SELECT \"addresses\".* FROM \"addresses\" WHERE \"addresses\".\"user_id\" IN (1, 2)\n\n\u90a3\u4e48\u53e6\u5916\u4e2a\u65b9\u6cd5\u5230\u5e95\u505a\u4e86\u4ec0\u4e48\u5462? \nUser.preload(:addresses)\n#  SELECT \"users\".* FROM \"users\"\n#  SELECT \"addresses\".* FROM \"addresses\" WHERE \"addresses\".\"user_id\" IN (1, 2)\n\n\u5f88\u660e\u663epreload \u548cincludes \u65b9\u6cd5\u5f88\u76f8\u4f3c, \u63a5\u7740\u518d\u770b# eager_load:\nUser.eager_load(:addresses)\n#  SELECT\n#  \"users\".\"id\" AS t0_r0, \"users\".\"name\" AS t0_r1, \"users\".\"email\" AS t0_r2, \"users\".\"created_at\" AS t0_r3, \"users\".\"updated_at\" AS t0_r4,\n#  \"addresses\".\"id\" AS t1_r0, \"addresses\".\"user_id\" AS t1_r1, \"addresses\".\"country\" AS t1_r2, \"addresses\".\"street\" AS t1_r3, \"addresses\".\"postal_code\" AS t1_r4, \"addresses\".\"city\" AS t1_r5, \"addresses\".\"created_at\" AS t1_r6, \"addresses\".\"updated_at\" AS t1_r7\n#  FROM \"users\"\n#  LEFT OUTER JOIN \"addresses\" ON \"addresses\".\"user_id\" = \"users\".\"id\"\n\n\n\u8fd9\u4e2a\u65f6\u5019\u53d1\u73b0,\u548c\u524d\u4e24\u4e2a\u5b8c\u5168\u4e0d\u4e00\u6837. \u8fd9\u4e2a\u5c31\u662fRails \u795e\u5947\u7684\u5730\u65b9, \u5b83\u6709\u4e24\u79cd\u52a0\u8f7d\u6570\u636e\u7684\u65b9\u6cd5. \u4e00\u79cd\u5c31\u662f\u901a\u8fc7\u5355\u4e2a\u7684\u67e5\u8be2\u8bed\u53e5\u6765\u83b7\u53d6\u6240\u6709\u7684\u6570\u636e, \u7136\u540e\u518d\u805a\u5408, \u53e6\u5916\u4e00\u79cd\u5c31\u662f\u5728\u67e5\u8be2\u7684\u65f6\u5019\u5df2\u7ecf\u901a\u8fc7\u8bed\u53e5\u6765\u5b8c\u6210\u4e86\u6570\u636e\u7684\u805a\u5408.(\u5982 left join)\n\u4e5f\u5c31\u662f\u8bf4, \u5982\u679c\u4f60\u4f7f\u7528\u4e86preload \u90a3\u5c31\u662f\u610f\u5473\u7740\u4f60\u603b\u662f\u60f3\u8981\u5355\u72ec\u53bb\u5b8c\u6210\u67e5\u8be2, \u800c# eager_load \u901a\u5e38\u5c31\u662f\u4e00\u6761\u8bed\u53e5, \u7136\u540e\u66f4\u591a\u7684\u5de5\u4f5c\u662f\u5728\u6570\u636e\u5e93\u90a3\u8fb9\u5b8c\u6210. \u8bf4\u9053\u8fd9\u91cc, \u90a3\u4e48#includes \u5b83\u5230\u5e95\u4ee3\u8868\u4ec0\u4e48\u5462, \u8fd9\u4e2a\u65f6\u5019\u5c31\u8981\u53d6\u51b3\u4e8e\u4e0a\u4e0b\u6587\u7684\u5b9e\u9645\u60c5\u51b5\u4e86. \u51b3\u5b9a\u6743\u4ea4\u7ed9\u4e86Rails. \u53ef\u80fd\u76f4\u63a5\u770b\u4e0a\u53bb\u5c31\u662f\u770b\u67e5\u8be2\u7684\u6761\u4ef6\u4e86, \u4e0b\u9762\u6211\u4eec\u770b\u770b\u5177\u4f53\u4ec0\u4e48\u6837\u7684\u8bed\u53e5\u4f1a\u88ab\u59d4\u6258\u7ed9eager_load:\nUser.includes(:addresses).where(\"addresses.country = ?\", \"Poland\")\nUser.eager_load(:addresses).where(\"addresses.country = ?\", \"Poland\")\n\n# SELECT\n# \"users\".\"id\" AS t0_r0, \"users\".\"name\" AS t0_r1, \"users\".\"email\" AS t0_r2, \"users\".\"created_at\" AS t0_r3, \"users\".\"updated_at\" AS t0_r4,\n# \"addresses\".\"id\" AS t1_r0, \"addresses\".\"user_id\" AS t1_r1, \"addresses\".\"country\" AS t1_r2, \"addresses\".\"street\" AS t1_r3, \"addresses\".\"postal_code\" AS t1_r4, \"addresses\".\"city\" AS t1_r5, \"addresses\".\"created_at\" AS t1_r6, \"addresses\".\"updated_at\" AS t1_r7\n# FROM \"users\"\n# LEFT OUTER JOIN \"addresses\"\n# ON \"addresses\".\"user_id\" = \"users\".\"id\"\n# WHERE (addresses.country = 'Poland')\n\n\u5728\u4e0a\u9762\u7684\u4f8b\u5b50\u91cc Rails \u662f\u63a2\u6d4b\u5230\u5b9e\u9645\u4e0a\u5728where \u6761\u4ef6\u91cc\u4f7f\u7528\u5230\u7684\u6570\u636e\u5bf9\u8c61\u662f\u4e4b\u524dpreloaded \u4e5f\u5c31\u662f(include)\u8fdb\u6765\u7684\u6570\u636e, \u6240\u4ee5\u76f4\u63a5\u628a includes \u59d4\u6258\u7ed9eager_load, \u5176\u5b9e\u4ece\u8fd9\u91cc\u770b\u4e00\u76f4\u4f7f\u7528 eager_load \u5c31\u53ef\u4ee5\u5b9e\u73b0\u7ed3\u679c.\n\u4f46\u662f\u5982\u679c\u8fd9\u91cc\u76f4\u63a5\u4f7f\u7528preload, \u4f60\u4f1a\u53d1\u73b0\u62a5\u9519\u7684.\nUser.preload(:addresses).where(\"addresses.country = ?\", \"Poland\")\n#  SELECT \"users\".* FROM \"users\" WHERE (addresses.country = 'Poland')\n#\n#  SQLite3::SQLException: no such column: addresses.country\n\n\u8fd9\u91cc\u7684\u533a\u522b\u5c31\u662fpreload \u5e76\u4e0d\u4f1a\u76f4\u63a5\u53bb\u5173\u8054\u8868\u67e5\u8be2, \u6240\u4ee5\u4f1a\u62a5\u9519.\n\u53ef\u662f\u8fd9\u6837\u7684\u7406\u89e3\u80fd\u591f\u900f\u5f7b\u5417?\n\u6211\u4eec\u56de\u5934\u518d\u770b\u8fd9\u4e2a\u4f8b\u5b50:\nUser.includes(:addresses).where(\"addresses.country = ?\", \"Poland\")\n\n\u4f60\u53ef\u80fd\u597d\u5947, \u8fd9\u4e2a\u8bed\u53e5\u5b83\u672c\u8eab\u7684\u610f\u56fe\u662f\u4ec0\u4e48? \u5230\u5e95\u662f\u60f3\u8981\u53d6\u5230\u4ec0\u4e48\u6837\u7684\u6570\u636e\u5462?\n\n\u53d6\u5230\u6240\u6709\u6ce2\u5170\u7684\u5730\u5740, \u7136\u540e\u52a0\u8f7d\u6ce2\u5170\u7684\u5730\u5740\u6570\u636e?\n\u53d6\u5230\u6240\u6709\u7684\u6ce2\u5170\u5730\u5740, \u7136\u540e\u52a0\u8f7d\u6240\u6709\u7684\u5730\u5740\u6570\u636e?\n\u53d6\u5230\u6240\u6709\u7684\u7528\u6237\u6570\u636e\u4ee5\u53ca\u6ce2\u5170\u7684\u5730\u5740\n\n\u4f60\u80fd\u591f\u7406\u89e3\u4e0a\u9762\u7684\u4f8b\u5b50\u91cc\u6211\u4eec\u8fbe\u5230\u4e86\u4ec0\u4e48\u76ee\u7684\u5417? \u6ca1\u9519\u662f\u7b2c\u4e00\u4e2a, \u90a3\u4e48\u6211\u4eec\u80fd\u591f\u5b9e\u73b0\u7b2c\u4e8c\u4e2a\u548c\u7b2c\u4e09\u4e2a\u5417?\n\n#preload \u5230\u5e95\u597d\u4e0d\u597d\u4f7f?\n\u6211\u4eec\u5f53\u524d\u7684\u76ee\u6807\u662f: \u83b7\u53d6\u5230\u6240\u6709\u5177\u6709\u6ce2\u5170\u5730\u5740\u7684\u7528\u6237\u6570\u636e,\u4f46\u662f\u5374\u52a0\u8f7d\u4e86\u4ed6\u4eec\u7684\u6240\u6709\u5730\u5740\u6570\u636e. \u6211\u53ea\u6709\u62ff\u5230\u4e86\u6240\u6709\u7684\u6570\u636e\u4e4b\u540e\u624d\u53ef\u4ee5\u5f97\u5230\u7528\u6237\u4ed6\u4eec\u81f3\u5c11\u6709\u4e00\u4e2a\u6ce2\u5170\u7684\u5730\u5740.\n\u8fd9\u91cc, \u5f88\u660e\u663e,\u6211\u4eec\u7684\u76ee\u7684\u5c31\u662f \u53ea\u62ff\u5230\u6709\u6ce2\u5170\u5730\u5740\u7684\u7528\u6237\u6570\u636e,  \u4f46\u662f\u5b9e\u9645\u60c5\u51b5\u786e\u5b9e\u6211\u4eec\u5f97\u5148\u62ff\u5230\u6240\u6709\u7684\u5730\u5740\u6570\u636e. \u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u8fd9\u6837\u5199User.join(:addresses).where(\"addresses.country = ?\", \"Poland\"), \u8fd9\u6837\u6211\u4eec\u5c31 \u53ea\u662f\u62ff\u5230\u4e86\u90e8\u5206\u5339\u914d\u7684\u5730\u5740\u6570\u636e, \u5bf9\u5417?\nr = User.joins(:addresses).where(\"addresses.country = ?\", \"Poland\").includes(:addresses)\n\nr[0]\n#=> #<User id: 1, name: \"Robert Pankowecki\", email: \"robert@example.org\", created_at: \"2013-12-08 11:26:24\", updated_at: \"2013-12-08 11:26:24\">\n\nr[0].addresses\n# [\n#   #<Address id: 1, user_id: 1, country: \"Poland\", street: \"Rynek\", postal_code: \"55-555\", city: \"Wroc\u0142aw\", created_at: \"2013-12-08 11:26:50\", updated_at: \"2013-12-08 11:26:50\">\n# ]\n\n\n\u4f46\u662f,\u4e8b\u5b9e\u4e0a\u5e76\u6ca1\u6709\u548c\u6211\u4eec\u60f3\u8981\u7684\u7ed3\u679c\u4e00\u6837, \u6211\u4eec\u9057\u6f0f\u4e86\u7528\u6237\u7684\u7b2c\u4e8c\u6761\u6570\u636e, \u5176\u5b9e\u6211\u4eec\u8fd8\u662f\u52a0\u8f7d\u4e86\u6574\u5f20\u8868, \u867d\u7136\u6211\u4eec\u4f7f\u7528\u4e86#eager_load\u58f0\u660e. \u552f\u4e00\u4e0d\u540c\u7684\u5c31\u662f\u4e4b\u524d\u7684\u4f8b\u5b50\u4f7f\u7528\u4e86INNER JOIN \u6765\u4ee3\u66ffLEFT JOIN, \u4f46\u662f\u5bf9\u4e8e\u67e5\u8be2\u8bed\u53e5\u6765\u8bf4\u5e76\u6ca1\u6709\u4ec0\u4e48\u533a\u522b.\nSELECT\n\"users\".\"id\" AS t0_r0, \"users\".\"name\" AS t0_r1, \"users\".\"email\" AS t0_r2, \"users\".\"created_at\" AS t0_r3, \"users\".\"updated_at\" AS t0_r4,\n\"addresses\".\"id\" AS t1_r0, \"addresses\".\"user_id\" AS t1_r1, \"addresses\".\"country\" AS t1_r2, \"addresses\".\"street\" AS t1_r3, \"addresses\".\"postal_code\" AS t1_r4, \"addresses\".\"city\" AS t1_r5, \"addresses\".\"created_at\" AS t1_r6, \"addresses\".\"updated_at\" AS t1_r7\nFROM \"users\"\nINNER JOIN \"addresses\"\nON \"addresses\".\"user_id\" = \"users\".\"id\"\nWHERE (addresses.country = 'Poland')\n\n\n\u8fd9\u4e2a\u65f6\u5019\u600e\u4e48\u529e\u5462, \u6211\u4eec\u5c31\u53ef\u4ee5\u901a\u8fc7preload \u6765\u641e\u5b9a Rails.\nr = User.joins(:addresses).where(\"addresses.country = ?\", \"Poland\").preload(:addresses)\n# SELECT \"users\".* FROM \"users\"\n# INNER JOIN \"addresses\" ON \"addresses\".\"user_id\" = \"users\".\"id\"\n# WHERE (addresses.country = 'Poland')\n\n# SELECT \"addresses\".* FROM \"addresses\" WHERE \"addresses\".\"user_id\" IN (1)\n\nr[0]\n# [#<User id: 1, name: \"Robert Pankowecki\", email: \"robert@example.org\", created_at: \"2013-12-08 11:26:24\", updated_at: \"2013-12-08 11:26:24\">]\n\nr[0].addresses\n# [\n#  <Address id: 1, user_id: 1, country: \"Poland\", street: \"Rynek\", postal_code: \"55-555\", city: \"Wroc\u0142aw\", created_at: \"2013-12-08 11:26:50\", updated_at: \"2013-12-08 11:26:50\">,\n#  <Address id: 3, user_id: 1, country: \"France\", street: \"8 rue Chambiges\", postal_code: \"75008\", city: \"Paris\", created_at: \"2013-12-08 11:36:30\", updated_at: \"2013-12-08 11:36:30\">]\n# ]\n\n\u8fd9\u4e2a\u7ed3\u679c\u5c31\u662f\u6211\u4eec\u60f3\u8981\u7684.\u901a\u8fc7\u4f7f\u7528# preload \u6211\u4eec\u4e0d\u518d\u6df7\u5408\u6211\u4eec\u60f3\u8981\u7684\u7528\u6237\u6570\u636e\u548c\u6240\u6709\u7684\u6570\u636e\u4e4b\u95f4.\u76f4\u63a5\u5c31\u62ff\u51fa\u4e86\u60f3\u8981\u7684\u7528\u6237\u7684\u6570\u636e. \n\n\u9884\u52a0\u8f7d\u805a\u5408\u7684\u5b50\u96c6(preloading subset of association)\n\u8fd9\u91cc\u6211\u4eec\u7684\u76ee\u6807\u53d8\u6210\u4e86 \u62ff\u5230\u6240\u6709\u7684\u7528\u6237\u6570\u636e,\u5e76\u4e14\u8fd8\u6709\u4ed6\u4eec\u7684\u6ce2\u5170\u5730\u5740.\n\u8001\u5b9e\u8bb2, \u6211\u5e76\u4e0d\u4f1a\u60f3\u53bb\u53ea\u662f\u9884\u52a0\u8f7d\u805a\u5408\u7684\u5b50\u96c6, \u800c\u4e8b\u5b9e\u4e0a\u901a\u5e38\u7cfb\u7edf\u5728\u5176\u4ed6\u5730\u65b9\u6709\u53ef\u80fd\u4f1a\u7528\u5230\u8fd9\u4e2a\u7ed3\u679c\u96c6. \u5f53\u7136\u5982\u679c\u4f60\u53ea\u662f\u60f3\u8981\u5c55\u793a\u8fd9\u4e2a\u7ed3\u679c\u96c6\u7684\u8bdd\u90a3\u5c31\u6709\u4e9b\u9053\u7406.\n\u6211\u66f4\u52a0\u559c\u6b22\u4f7f\u7528\u53ea\u662f\u5728 \u5b9a\u4e49\u805a\u5408\u7684\u5730\u65b9\u6dfb\u52a0\u6761\u4ef6:\nclass User < ActiveRecord::Base\n  has_many :addresses\n  has_many :polish_addresses, conditions: {country: \"Poland\"}, class_name: \"Address\"\nend\n\n\u8fd9\u6837\u6211\u4eec\u5c31\u53ef\u4ee5\u5f88\u5bb9\u6613\u62ff\u5230\u7ed3\u679c:\nr = User.preload(:polish_addresses)\n\n# SELECT \"users\".* FROM \"users\"\n# SELECT \"addresses\".* FROM \"addresses\" WHERE \"addresses\".\"country\" = 'Poland' AND \"addresses\".\"user_id\" IN (1, 2)\n\nr\n\n# [\n#   <User id: 1, name: \"Robert Pankowecki\", email: \"robert@example.org\", created_at: \"2013-12-08 11:26:24\", updated_at: \"2013-12-08 11:26:24\">\n#   <User id: 2, name: \"Bob Doe\", email: \"bob@example.org\", created_at: \"2013-12-08 11:26:25\", updated_at: \"2013-12-08 11:26:25\">\n# ]\n\nr[0].polish_addresses\n\n# [\n#   #<Address id: 1, user_id: 1, country: \"Poland\", street: \"Rynek\", postal_code: \"55-555\", city: \"Wroc\u0142aw\", created_at: \"2013-12-08 11:26:50\", updated_at: \"2013-12-08 11:26:50\">\n# ]\n\nr[1].polish_addresses\n# []\n\n\u6216\u8005\nr = User.eager_load(:polish_addresses)\n\n# SELECT \"users\".\"id\" AS t0_r0, \"users\".\"name\" AS t0_r1, \"users\".\"email\" AS t0_r2, \"users\".\"created_at\" AS t0_r3, \"users\".\"updated_at\" AS t0_r4,\n#        \"addresses\".\"id\" AS t1_r0, \"addresses\".\"user_id\" AS t1_r1, \"addresses\".\"country\" AS t1_r2, \"addresses\".\"street\" AS t1_r3, \"addresses\".\"postal_code\" AS t1_r4, \"addresses\".\"city\" AS t1_r5, \"addresses\".\"created_at\" AS t1_r6, \"addresses\".\"updated_at\" AS t1_r7\n# FROM \"users\"\n# LEFT OUTER JOIN \"addresses\"\n# ON \"addresses\".\"user_id\" = \"users\".\"id\" AND \"addresses\".\"country\" = 'Poland'\n\nr\n# [\n#   #<User id: 1, name: \"Robert Pankowecki\", email: \"robert@example.org\", created_at: \"2013-12-08 11:26:24\", updated_at: \"2013-12-08 11:26:24\">,\n#   #<User id: 2, name: \"Bob Doe\", email: \"bob@example.org\", created_at: \"2013-12-08 11:26:25\", updated_at: \"2013-12-08 11:26:25\">\n# ]\n\nr[0].polish_addresses\n# [\n#   #<Address id: 1, user_id: 1, country: \"Poland\", street: \"Rynek\", postal_code: \"55-555\", city: \"Wroc\u0142aw\", created_at: \"2013-12-08 11:26:50\", updated_at: \"2013-12-08 11:26:50\">\n# ]\n\nr[1].polish_addresses\n# []\n\n\n\n\u7ec8\u6781\u95ee\u9898\n\u4f60\u53ef\u80fd\u4f1a\u95ee, \"\u8fd9\u7279\u4e48\u5f88\u96be\u5417?\" \u6211\u4e0d\u786e\u5b9a, \u4f46\u662f\u6211\u60f3\u5927\u90e8\u5206\u7684 ORM\u7cfb\u7edf\u603b\u662f\u5e0c\u671b\u80fd\u591f\u8ba9\u4f60\u6784\u5efa\u4e00\u4e2a\u67e5\u8be2, \u7136\u540e\u4ece\u4e00\u4e2a\u8868\u91cc\u52a0\u8f7d\u6570\u636e. \u901a\u8fc7eager loding \u8ba9\u4e8b\u60c5\u53d8\u5f97\u590d\u6742. \u5f53\u6211\u4eec\u60f3\u8981\u5f97\u5230\u590d\u5408\u7684\u6570\u636e\u7ed3\u679c, \u4ece\u591a\u4e2a\u8868\u91cc,\u800c\u4e14\u662f\u591a\u4e2a\u6761\u4ef6\u7684\u60c5\u51b5\u4e0b. \u5728 Rails \u91cc\u6211\u4eec\u4f7f\u7528\u94fe\u6761\u5f0f\u7684 API \u6765\u5b9e\u73b02\u4e2a\u6216\u8005\u66f4\u591a\u7684\u67e5\u8be2(\u5982\u679c\u4f7f\u7528# preload)\n\u90a3\u4e48\u6211\u559c\u6b22\u4ec0\u4e48\u6837\u7684 API \u5462, \u6211\u5728\u60f3\u8fd9\u6837:\nUser.joins(:addresses).where(\"addresses.country = ?\", \"Poland\").preload do |users|\n  users.preload(:addresses).where(\"addresses.country = ?\", \"Germany\")\n  users.preload(:lists) do |lists|\n    lists.preload(:tasks).where(\"tasks.state = ?\", \"unfinished\")\n  end\nend\n\n\n\n\u800c\u5728 Rails4\u91cc\u53d1\u751f\u4e86\u4ec0\u4e48\u53d8\u5316\u5462\nclass User < ActiveRecord::Base\n  has_many :addresses\n  has_many :polish_addresses, -> {where(country: \"Poland\")}, class_name: \"Address\"\nend\n\nRails \u9f13\u52b1\u5927\u5bb6\u4f7f\u7528\u66f4\u591a\u7684lambda \u8868\u8fbe\u5f0f\u7684\u8bed\u6cd5\u6765\u5b9a\u4e49\u805a\u5408\u7684\u6761\u4ef6. \u8fd9\u6837\u975e\u5e38\u4e0d\u9519, \u5176\u5b9e\u4e5f\u4e0d\u53ea\u662flambda \u8868\u8fbe\u5f0f, \u65b9\u6cd5\u7684\u65b9\u5f0f\u4e5f\u662f\u4e00\u6837\u7684, \u90fd\u662f\u5728 \u5b9a\u4e49\u8303\u56f4\n# Bad, Time.now would be always the time when the class was loaded\n# You might not even spot the bug in development because classes are\n# automatically reloaded for you after changes.\nscope :from_the_past, where(\"happens_at <= ?\", Time.now)\n\n# OK\nscope :from_the_past, -> { where(\"happens_at <= ?\", Time.now) }\n\n# OK\ndef self.from_the_past\n  where(\"happens_at <= ?\", Time.now)\nend\n\n\n\u867d\u7136\u5728\u6211\u4eec\u7684\u4f8b\u5b50\u91ccwhere(country: \"Poland\")\u603b\u662f\u4e00\u6837\u7684,\u4e0d\u7ba1\u662f\u52a8\u6001\u7f16\u8bd1\u8fd8\u662f\u4e00\u5f00\u59cb\u5c31\u52a0\u8f7d, \u4f46\u662f\u597d\u5728\u5c31\u662f Rails \u4f1a\u5e2e\u52a9\u6211\u4eec\u8fdc\u79bb bug, \u6211\u4eec\u770b\u770b\u5b83\u4eec\u662f\u5426\u53d1\u751f\u4e86\u53d8\u5316:\nUser.includes(:addresses)\n#  SELECT \"users\".* FROM \"users\"\n#  SELECT \"addresses\".* FROM \"addresses\" WHERE \"addresses\".\"user_id\" IN (1, 2)\n\nUser.preload(:addresses)\n#  SELECT \"users\".* FROM \"users\"\n#  SELECT \"addresses\".* FROM \"addresses\" WHERE \"addresses\".\"user_id\" IN (1, 2)\n\nUser.eager_load(:addresses)\n#  SELECT \"users\".\"id\" AS t0_r0, \"users\".\"name\" AS t0_r1, \"users\".\"email\" AS t0_r2, \"users\".\"created_at\" AS t0_r3, \"users\".\"updated_at\" AS t0_r4,\n#         \"addresses\".\"id\" AS t1_r0, \"addresses\".\"user_id\" AS t1_r1, \"addresses\".\"country\" AS t1_r2, \"addresses\".\"street\" AS t1_r3, \"addresses\".\"postal_code\" AS t1_r4, \"addresses\".\"city\" AS t1_r5, \"addresses\".\"created_at\" AS t1_r6, \"addresses\".\"updated_at\" AS t1_r7\n#  FROM \"users\"\n#  LEFT OUTER JOIN \"addresses\"\n#  ON \"addresses\".\"user_id\" = \"users\".\"id\"\n\n\u5e76\u6ca1\u6709, \u4f46\u662f\u6211\u4eec\u8bd5\u7740\u52a0\u51e0\u4e2a\u6761\u4ef6, \u4e4b\u524d\u603b\u662f\u4f1a\u62a5\u9519\u7684\u90a3\u79cd\u60c5\u51b5:\nUser.includes(:addresses).where(\"addresses.country = ?\", \"Poland\")\n\n\u8bd5\u8bd5\u8fd9\u4e2a, \u53d1\u73b0\u62a5\u9519\u4e86, \u63a5\u7740\u8bd5\u8bd5\u8fd9\u4e2a\nUser.includes(:addresses).where(\"addresses.country = ?\", \"Poland\").references(:addresses)\n\n\u6211\u5f88\u597d\u5947\u5982\u679c\u6211\u4eec\u60f3\u8981\u9884\u52a0\u8f7d\u66f4\u591a\u7684\u8868,\u800c\u53ea\u5f15\u7528\u5176\u4e2d\u4e00\u5f20\u8868\u5462?\nUser.includes(:addresses).where(\"addresses.country = ?\", \"Poland\").references(:addresses)\n\n\u6211\u8bd5\u60f3addresses \u5c06\u4f1a\u901a\u8fc7eager_load \u7684\u65b9\u5f0f\u8fd8\u6709place \u5c06\u4f1a\u901a\u8fc7preload \u7684\u65b9\u5f0f\u6765\u52a0\u8f7d. \u4f46\u662f\u7ed3\u679c\u5e76\u4e0d\u662f, \u5728 Rails4\u4e2d\u5e76\u4e0d\u4f1a\u8b66\u544a\u5982\u679c\u4f7f\u7528\u4e86reference \u800c\u540c\u65f6\u663e\u5f0f\u4f7f\u7528eager_load,\nUser.eager_load(:addresses).where(\"addresses.country = ?\", \"Poland\")\n\n\nUser.includes(:addresses).where(\"addresses.country = ?\", \"Poland\").references(:addresses)\nUser.eager_load(:addresses).where(\"addresses.country = ?\", \"Poland\")\n```\n\u800c\u5982\u679c\u4f7f\u7528 preload \u8fd8\u662f\u62a5\u540c\u6837\u7684\u9519:\nUser.preload(:addresses).where(\"addresses.country = ?\", \"Poland\")\n#  SELECT \"users\".* FROM \"users\" WHERE (addresses.country = 'Poland')\n#\n#  SQLite3::SQLException: no such column: addresses.country: SELECT \"users\".* FROM \"users\"  WHERE (addresses.country = 'Poland')\n\n\n\u603b\u7ed3\n\u5bf9\u4e8e\u8fd9\u4e09\u4e2a\u65b9\u6cd5\n\nincludes\npreload\neager_load\n\nincludes \u4f1a\u88ab rails \u5b9e\u9645\u59d4\u6258\u7ed9 preload \u6216\u8005 eager_load, \u53d6\u51b3\u4e8e\u540e\u9762\u662f\u5426\u8ddf\u4e86\u6761\u4ef6, \u800c\u6761\u4ef6\u91cc\u662f\u5426\u5305\u542b\u4e86\u9700\u8981 preload \u7684\u8868.\n#preload \u5c31\u662f\u8981\u4f7f\u7528\u5355\u72ec\u7684\u8bed\u53e5\u5148\u62ff\u5230\u5168\u90e8\u7684\u7ed3\u679c\u96c6.\n#eager_load \u901a\u8fc7\u90fd\u662f\u4f7f\u7528\u4e86LEFT JOIN \u6765eager load \u5173\u8054\u7684\u8868.\nref:\n\nhttp://blog.arkency.com/2013/12/rails4-preloading/\nhttps://www.rubyplus.com/articles/3211-Eager-Loading-in-Rails-5\nhttps://www.allerin.com/blog/eager-loading-inwith-rails\nhttp://stackoverflow.com/questions/10084355/eager-loading-and-lazy-loading-in-rails\nhttp://stackoverflow.com/questions/41654098/rails-5-how-to-form-association-between-tables-on-multiple-shared-attributes\n\n\n\u5982\u679c\u4f60\u4f7f\u7528` Rails`\u4ee5\u53ca\u5b83\u7684 `active record`, \u4f60\u4e5f\u8bb8\u5df2\u7ecf\u4e86\u89e3\u4e86\u901a\u8fc7\u4f7f\u7528\u65b9\u6cd5` indcludes` \u6765\u8fdb\u884c\u6570\u636e\u7684` eager` \u52a0\u8f7d. \u4f46\u662f\u4f60\u53ef\u80fd\u4f1a\u53d1\u73b0\u5bf9\u4e8e\u8fd9\u4e2a\u65b9\u6cd5\u6cd5\u80cc\u540e rails \u4ee5\u53ca activerecord \u7684\u5b9e\u73b0\u662f\u53d6\u51b3\u4e8e\u4e0d\u540c\u7684\u4e0a\u4e0b\u6587\u7684. \u6709\u65f6\u5019\u4f60\u53ef\u80fd\u4f1a\u53d1\u73b0\u62ff\u5230\u7684\u67e5\u8be2\u8bed\u53e5\u5f88\u7b80\u5355, \u800c\u6709\u65f6\u5374\u662f\u4e00\u4e2a\u76f8\u5bf9\u5f88\u5927\u7684\u67e5\u8be2\u8bed\u53e5. \u800c\u4e14\u5bf9\u4e8e\u6bcf\u4e00\u4e2a\u5b57\u6bb5\u90fd\u5df2\u7ecf\u522b\u540d\u4e86\u5462. \u800c\u4e14\u6211\u4eec\u540c\u65f6\u8fd8\u6709` preload` \u65b9\u6cd5\u548c` eager_load` \u65b9\u6cd5, \u800c\u4ed6\u4eec\u662f\u5426\u80fd\u591f\u83b7\u53d6\u5230\u7cfb\u7edf\u7684\u7ed3\u679c\u5462? \u5728 `Rails4` \u4e2d\u53c8\u53d1\u751f\u4e86\u4ec0\u4e48\u53d8\u5316\u5462? \u6709\u70b9\u6a21\u7cca\u8bf4\u4e0d\u6e05\u90a3\u5c31\u6211\u4eec\u4e00\u8d77\u6765\u770b\u770b\u5230\u5e95\u4ed6\u4eec\u80cc\u540e\u6709\u4ec0\u4e48 **\u7384\u5999\u4e4b\u5904** .\n\n# step 1\n\n\u9996\u9009, \u6211\u4eec\u6765\u4f7f\u7528` Active Record` \u7c7b\u8fd8\u6709\u805a\u5408\u5b9a\u4e49\u672c\u6b21\u4f7f\u7528\u5230\u7684\u573a\u666f:\n\n```\nclass User < ActiveRecord::Base\n  has_many :addresses\nend\n\nclass Address < ActiveRecord::Base\n  belongs_to :user\nend\n```\n\n\u6211\u4eec\u518d\u6765\u9020\u70b9\u6570\u636e\n\n```\nrob = User.create!(name: \"Robert Pankowecki\", email: \"robert@example.org\")\nbob = User.create!(name: \"Bob Doe\", email: \"bob@example.org\")\n\nrob.addresses.create!(country: \"Poland\", city: \"Wroc\u0142aw\", postal_code: \"55-555\", street: \"Rynek\")\nrob.addresses.create!(country: \"France\", city: \"Paris\", postal_code: \"75008\", street: \"8 rue Chambiges\")\nbob.addresses.create!(country: \"Germany\", city: \"Berlin\", postal_code: \"10551\", street: \"Tiergarten\")\n\n```\n\n## Rails3\n\n\u4e00\u822c\u6765\u8bf4, \u5982\u679c\u60f3\u8981\u4f7f\u7528` eager loading` \u7684\u529f\u80fd, \u5c31\u5e94\u8be5\u4f7f\u7528`#includes`\u65b9\u6cd5, \u8fd9\u4e2a\u65b9\u6cd5\u4ece `Rails1? 2?` \u5c31\u5f00\u59cb\u63a8\u8350\u4f7f\u7528\u4e86. \u4f60\u4f1a\u53d1\u73b0\u5176\u5b9e\u5b83\u4f1a\u67092\u4e2a query \u53d1\u51fa:\n\n```\nUser.includes(:addresses)\n#  SELECT \"users\".* FROM \"users\"\n#  SELECT \"addresses\".* FROM \"addresses\" WHERE \"addresses\".\"user_id\" IN (1, 2)\n```\n\n\u90a3\u4e48\u53e6\u5916\u4e2a\u65b9\u6cd5\u5230\u5e95\u505a\u4e86\u4ec0\u4e48\u5462? \n\n```\nUser.preload(:addresses)\n#  SELECT \"users\".* FROM \"users\"\n#  SELECT \"addresses\".* FROM \"addresses\" WHERE \"addresses\".\"user_id\" IN (1, 2)\n```\n\n\u5f88\u660e\u663e` preload` \u548c` includes` \u65b9\u6cd5\u5f88\u76f8\u4f3c, \u63a5\u7740\u518d\u770b`# eager_load`:\n\n```\nUser.eager_load(:addresses)\n#  SELECT\n#  \"users\".\"id\" AS t0_r0, \"users\".\"name\" AS t0_r1, \"users\".\"email\" AS t0_r2, \"users\".\"created_at\" AS t0_r3, \"users\".\"updated_at\" AS t0_r4,\n#  \"addresses\".\"id\" AS t1_r0, \"addresses\".\"user_id\" AS t1_r1, \"addresses\".\"country\" AS t1_r2, \"addresses\".\"street\" AS t1_r3, \"addresses\".\"postal_code\" AS t1_r4, \"addresses\".\"city\" AS t1_r5, \"addresses\".\"created_at\" AS t1_r6, \"addresses\".\"updated_at\" AS t1_r7\n#  FROM \"users\"\n#  LEFT OUTER JOIN \"addresses\" ON \"addresses\".\"user_id\" = \"users\".\"id\"\n\n```\n\n\u8fd9\u4e2a\u65f6\u5019\u53d1\u73b0,\u548c\u524d\u4e24\u4e2a\u5b8c\u5168\u4e0d\u4e00\u6837. \u8fd9\u4e2a\u5c31\u662f` Rails` \u795e\u5947\u7684\u5730\u65b9, \u5b83\u6709\u4e24\u79cd\u52a0\u8f7d\u6570\u636e\u7684\u65b9\u6cd5. \u4e00\u79cd\u5c31\u662f\u901a\u8fc7\u5355\u4e2a\u7684\u67e5\u8be2\u8bed\u53e5\u6765\u83b7\u53d6\u6240\u6709\u7684\u6570\u636e, \u7136\u540e\u518d\u805a\u5408, \u53e6\u5916\u4e00\u79cd\u5c31\u662f\u5728\u67e5\u8be2\u7684\u65f6\u5019\u5df2\u7ecf\u901a\u8fc7\u8bed\u53e5\u6765\u5b8c\u6210\u4e86\u6570\u636e\u7684`\u805a\u5408`.(\u5982 left join)\n\n\u4e5f\u5c31\u662f\u8bf4, \u5982\u679c\u4f60\u4f7f\u7528\u4e86` preload` \u90a3\u5c31\u662f\u610f\u5473\u7740\u4f60\u603b\u662f\u60f3\u8981\u5355\u72ec\u53bb\u5b8c\u6210\u67e5\u8be2, \u800c`# eager_load` \u901a\u5e38\u5c31\u662f\u4e00\u6761\u8bed\u53e5, \u7136\u540e\u66f4\u591a\u7684\u5de5\u4f5c\u662f\u5728\u6570\u636e\u5e93\u90a3\u8fb9\u5b8c\u6210. \u8bf4\u9053\u8fd9\u91cc, \u90a3\u4e48`#includes` \u5b83\u5230\u5e95\u4ee3\u8868\u4ec0\u4e48\u5462, \u8fd9\u4e2a\u65f6\u5019\u5c31\u8981\u53d6\u51b3\u4e8e\u4e0a\u4e0b\u6587\u7684\u5b9e\u9645\u60c5\u51b5\u4e86. \u51b3\u5b9a\u6743\u4ea4\u7ed9\u4e86` Rails`. \u53ef\u80fd\u76f4\u63a5\u770b\u4e0a\u53bb\u5c31\u662f\u770b\u67e5\u8be2\u7684\u6761\u4ef6\u4e86, \u4e0b\u9762\u6211\u4eec\u770b\u770b\u5177\u4f53\u4ec0\u4e48\u6837\u7684\u8bed\u53e5\u4f1a\u88ab\u59d4\u6258\u7ed9` eager_load`:\n\n\n```\nUser.includes(:addresses).where(\"addresses.country = ?\", \"Poland\")\nUser.eager_load(:addresses).where(\"addresses.country = ?\", \"Poland\")\n\n# SELECT\n# \"users\".\"id\" AS t0_r0, \"users\".\"name\" AS t0_r1, \"users\".\"email\" AS t0_r2, \"users\".\"created_at\" AS t0_r3, \"users\".\"updated_at\" AS t0_r4,\n# \"addresses\".\"id\" AS t1_r0, \"addresses\".\"user_id\" AS t1_r1, \"addresses\".\"country\" AS t1_r2, \"addresses\".\"street\" AS t1_r3, \"addresses\".\"postal_code\" AS t1_r4, \"addresses\".\"city\" AS t1_r5, \"addresses\".\"created_at\" AS t1_r6, \"addresses\".\"updated_at\" AS t1_r7\n# FROM \"users\"\n# LEFT OUTER JOIN \"addresses\"\n# ON \"addresses\".\"user_id\" = \"users\".\"id\"\n# WHERE (addresses.country = 'Poland')\n```\n\n\u5728\u4e0a\u9762\u7684\u4f8b\u5b50\u91cc Rails \u662f\u63a2\u6d4b\u5230\u5b9e\u9645\u4e0a\u5728` where` \u6761\u4ef6\u91cc\u4f7f\u7528\u5230\u7684`\u6570\u636e\u5bf9\u8c61`\u662f\u4e4b\u524d` preloaded` \u4e5f\u5c31\u662f(include)\u8fdb\u6765\u7684\u6570\u636e, \u6240\u4ee5\u76f4\u63a5\u628a includes \u59d4\u6258\u7ed9`eager_load`, \u5176\u5b9e\u4ece\u8fd9\u91cc\u770b\u4e00\u76f4\u4f7f\u7528 eager_load \u5c31\u53ef\u4ee5\u5b9e\u73b0\u7ed3\u679c.\n\n\u4f46\u662f\u5982\u679c\u8fd9\u91cc\u76f4\u63a5\u4f7f\u7528` preload`, \u4f60\u4f1a\u53d1\u73b0\u62a5\u9519\u7684.\n\n```\nUser.preload(:addresses).where(\"addresses.country = ?\", \"Poland\")\n#  SELECT \"users\".* FROM \"users\" WHERE (addresses.country = 'Poland')\n#\n#  SQLite3::SQLException: no such column: addresses.country\n```\n\n\u8fd9\u91cc\u7684\u533a\u522b\u5c31\u662f` preload` \u5e76\u4e0d\u4f1a\u76f4\u63a5\u53bb\u5173\u8054\u8868\u67e5\u8be2, \u6240\u4ee5\u4f1a\u62a5\u9519.\n\n\u53ef\u662f\u8fd9\u6837\u7684\u7406\u89e3\u80fd\u591f\u900f\u5f7b\u5417?\n\n\u6211\u4eec\u56de\u5934\u518d\u770b\u8fd9\u4e2a\u4f8b\u5b50:\n\n```\nUser.includes(:addresses).where(\"addresses.country = ?\", \"Poland\")\n```\n\n\u4f60\u53ef\u80fd\u597d\u5947, \u8fd9\u4e2a\u8bed\u53e5\u5b83\u672c\u8eab\u7684\u610f\u56fe\u662f\u4ec0\u4e48? \u5230\u5e95\u662f\u60f3\u8981\u53d6\u5230\u4ec0\u4e48\u6837\u7684\u6570\u636e\u5462?\n\n- \u53d6\u5230\u6240\u6709\u6ce2\u5170\u7684\u5730\u5740, \u7136\u540e\u52a0\u8f7d\u6ce2\u5170\u7684\u5730\u5740\u6570\u636e?\n- \u53d6\u5230\u6240\u6709\u7684\u6ce2\u5170\u5730\u5740, \u7136\u540e\u52a0\u8f7d\u6240\u6709\u7684\u5730\u5740\u6570\u636e?\n- \u53d6\u5230\u6240\u6709\u7684\u7528\u6237\u6570\u636e\u4ee5\u53ca\u6ce2\u5170\u7684\u5730\u5740\n\n\u4f60\u80fd\u591f\u7406\u89e3\u4e0a\u9762\u7684\u4f8b\u5b50\u91cc\u6211\u4eec\u8fbe\u5230\u4e86\u4ec0\u4e48\u76ee\u7684\u5417? \u6ca1\u9519\u662f\u7b2c\u4e00\u4e2a, \u90a3\u4e48\u6211\u4eec\u80fd\u591f\u5b9e\u73b0\u7b2c\u4e8c\u4e2a\u548c\u7b2c\u4e09\u4e2a\u5417?\n\n### #preload \u5230\u5e95\u597d\u4e0d\u597d\u4f7f?\n\n\u6211\u4eec\u5f53\u524d\u7684\u76ee\u6807\u662f: **\u83b7\u53d6\u5230\u6240\u6709\u5177\u6709\u6ce2\u5170\u5730\u5740\u7684\u7528\u6237\u6570\u636e,\u4f46\u662f\u5374\u52a0\u8f7d\u4e86\u4ed6\u4eec\u7684\u6240\u6709\u5730\u5740\u6570\u636e.** \u6211\u53ea\u6709\u62ff\u5230\u4e86\u6240\u6709\u7684\u6570\u636e\u4e4b\u540e\u624d\u53ef\u4ee5\u5f97\u5230\u7528\u6237\u4ed6\u4eec\u81f3\u5c11\u6709\u4e00\u4e2a\u6ce2\u5170\u7684\u5730\u5740.\n\n\u8fd9\u91cc, \u5f88\u660e\u663e,\u6211\u4eec\u7684\u76ee\u7684\u5c31\u662f **\u53ea\u62ff\u5230\u6709\u6ce2\u5170\u5730\u5740\u7684\u7528\u6237\u6570\u636e**,  \u4f46\u662f\u5b9e\u9645\u60c5\u51b5\u786e\u5b9e\u6211\u4eec\u5f97\u5148\u62ff\u5230\u6240\u6709\u7684\u5730\u5740\u6570\u636e. \u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u8fd9\u6837\u5199` User.join(:addresses).where(\"addresses.country = ?\", \"Poland\")`, \u8fd9\u6837\u6211\u4eec\u5c31 **\u53ea\u662f\u62ff\u5230\u4e86\u90e8\u5206\u5339\u914d\u7684\u5730\u5740\u6570\u636e**, \u5bf9\u5417?\n\n```\nr = User.joins(:addresses).where(\"addresses.country = ?\", \"Poland\").includes(:addresses)\n\nr[0]\n#=> #<User id: 1, name: \"Robert Pankowecki\", email: \"robert@example.org\", created_at: \"2013-12-08 11:26:24\", updated_at: \"2013-12-08 11:26:24\">\n\nr[0].addresses\n# [\n#   #<Address id: 1, user_id: 1, country: \"Poland\", street: \"Rynek\", postal_code: \"55-555\", city: \"Wroc\u0142aw\", created_at: \"2013-12-08 11:26:50\", updated_at: \"2013-12-08 11:26:50\">\n# ]\n\n```\n\n\u4f46\u662f,\u4e8b\u5b9e\u4e0a\u5e76\u6ca1\u6709\u548c\u6211\u4eec\u60f3\u8981\u7684\u7ed3\u679c\u4e00\u6837, \u6211\u4eec\u9057\u6f0f\u4e86\u7528\u6237\u7684\u7b2c\u4e8c\u6761\u6570\u636e, \u5176\u5b9e\u6211\u4eec\u8fd8\u662f\u52a0\u8f7d\u4e86\u6574\u5f20\u8868, \u867d\u7136\u6211\u4eec\u4f7f\u7528\u4e86`#eager_load`\u58f0\u660e. \u552f\u4e00\u4e0d\u540c\u7684\u5c31\u662f\u4e4b\u524d\u7684\u4f8b\u5b50\u4f7f\u7528\u4e86`INNER JOIN` \u6765\u4ee3\u66ff` LEFT JOIN`, \u4f46\u662f\u5bf9\u4e8e\u67e5\u8be2\u8bed\u53e5\u6765\u8bf4\u5e76\u6ca1\u6709\u4ec0\u4e48\u533a\u522b.\n\n```\nSELECT\n\"users\".\"id\" AS t0_r0, \"users\".\"name\" AS t0_r1, \"users\".\"email\" AS t0_r2, \"users\".\"created_at\" AS t0_r3, \"users\".\"updated_at\" AS t0_r4,\n\"addresses\".\"id\" AS t1_r0, \"addresses\".\"user_id\" AS t1_r1, \"addresses\".\"country\" AS t1_r2, \"addresses\".\"street\" AS t1_r3, \"addresses\".\"postal_code\" AS t1_r4, \"addresses\".\"city\" AS t1_r5, \"addresses\".\"created_at\" AS t1_r6, \"addresses\".\"updated_at\" AS t1_r7\nFROM \"users\"\nINNER JOIN \"addresses\"\nON \"addresses\".\"user_id\" = \"users\".\"id\"\nWHERE (addresses.country = 'Poland')\n\n```\n\n\u8fd9\u4e2a\u65f6\u5019\u600e\u4e48\u529e\u5462, \u6211\u4eec\u5c31\u53ef\u4ee5\u901a\u8fc7`preload` \u6765\u641e\u5b9a Rails.\n\n```\nr = User.joins(:addresses).where(\"addresses.country = ?\", \"Poland\").preload(:addresses)\n# SELECT \"users\".* FROM \"users\"\n# INNER JOIN \"addresses\" ON \"addresses\".\"user_id\" = \"users\".\"id\"\n# WHERE (addresses.country = 'Poland')\n\n# SELECT \"addresses\".* FROM \"addresses\" WHERE \"addresses\".\"user_id\" IN (1)\n\nr[0]\n# [#<User id: 1, name: \"Robert Pankowecki\", email: \"robert@example.org\", created_at: \"2013-12-08 11:26:24\", updated_at: \"2013-12-08 11:26:24\">]\n\nr[0].addresses\n# [\n#  <Address id: 1, user_id: 1, country: \"Poland\", street: \"Rynek\", postal_code: \"55-555\", city: \"Wroc\u0142aw\", created_at: \"2013-12-08 11:26:50\", updated_at: \"2013-12-08 11:26:50\">,\n#  <Address id: 3, user_id: 1, country: \"France\", street: \"8 rue Chambiges\", postal_code: \"75008\", city: \"Paris\", created_at: \"2013-12-08 11:36:30\", updated_at: \"2013-12-08 11:36:30\">]\n# ]\n```\n\n\u8fd9\u4e2a\u7ed3\u679c\u5c31\u662f\u6211\u4eec\u60f3\u8981\u7684.\u901a\u8fc7\u4f7f\u7528`# preload` \u6211\u4eec\u4e0d\u518d\u6df7\u5408\u6211\u4eec\u60f3\u8981\u7684\u7528\u6237\u6570\u636e\u548c\u6240\u6709\u7684\u6570\u636e\u4e4b\u95f4.\u76f4\u63a5\u5c31\u62ff\u51fa\u4e86\u60f3\u8981\u7684\u7528\u6237\u7684\u6570\u636e. \n\n## \u9884\u52a0\u8f7d\u805a\u5408\u7684\u5b50\u96c6(preloading subset of association)\n\n\u8fd9\u91cc\u6211\u4eec\u7684\u76ee\u6807\u53d8\u6210\u4e86 **\u62ff\u5230\u6240\u6709\u7684\u7528\u6237\u6570\u636e,\u5e76\u4e14\u8fd8\u6709\u4ed6\u4eec\u7684\u6ce2\u5170\u5730\u5740**.\n\n\u8001\u5b9e\u8bb2, \u6211\u5e76\u4e0d\u4f1a\u60f3\u53bb\u53ea\u662f\u9884\u52a0\u8f7d\u805a\u5408\u7684\u5b50\u96c6, \u800c\u4e8b\u5b9e\u4e0a\u901a\u5e38\u7cfb\u7edf\u5728\u5176\u4ed6\u5730\u65b9\u6709\u53ef\u80fd\u4f1a\u7528\u5230\u8fd9\u4e2a\u7ed3\u679c\u96c6. \u5f53\u7136\u5982\u679c\u4f60\u53ea\u662f\u60f3\u8981\u5c55\u793a\u8fd9\u4e2a\u7ed3\u679c\u96c6\u7684\u8bdd\u90a3\u5c31\u6709\u4e9b\u9053\u7406.\n\n\u6211\u66f4\u52a0\u559c\u6b22\u4f7f\u7528\u53ea\u662f\u5728 **\u5b9a\u4e49**\u805a\u5408\u7684\u5730\u65b9\u6dfb\u52a0\u6761\u4ef6:\n\n\n```\nclass User < ActiveRecord::Base\n  has_many :addresses\n  has_many :polish_addresses, conditions: {country: \"Poland\"}, class_name: \"Address\"\nend\n```\n\n\u8fd9\u6837\u6211\u4eec\u5c31\u53ef\u4ee5\u5f88\u5bb9\u6613\u62ff\u5230\u7ed3\u679c:\n\n```\nr = User.preload(:polish_addresses)\n\n# SELECT \"users\".* FROM \"users\"\n# SELECT \"addresses\".* FROM \"addresses\" WHERE \"addresses\".\"country\" = 'Poland' AND \"addresses\".\"user_id\" IN (1, 2)\n\nr\n\n# [\n#   <User id: 1, name: \"Robert Pankowecki\", email: \"robert@example.org\", created_at: \"2013-12-08 11:26:24\", updated_at: \"2013-12-08 11:26:24\">\n#   <User id: 2, name: \"Bob Doe\", email: \"bob@example.org\", created_at: \"2013-12-08 11:26:25\", updated_at: \"2013-12-08 11:26:25\">\n# ]\n\nr[0].polish_addresses\n\n# [\n#   #<Address id: 1, user_id: 1, country: \"Poland\", street: \"Rynek\", postal_code: \"55-555\", city: \"Wroc\u0142aw\", created_at: \"2013-12-08 11:26:50\", updated_at: \"2013-12-08 11:26:50\">\n# ]\n\nr[1].polish_addresses\n# []\n```\n\n\u6216\u8005\n\n```\nr = User.eager_load(:polish_addresses)\n\n# SELECT \"users\".\"id\" AS t0_r0, \"users\".\"name\" AS t0_r1, \"users\".\"email\" AS t0_r2, \"users\".\"created_at\" AS t0_r3, \"users\".\"updated_at\" AS t0_r4,\n#        \"addresses\".\"id\" AS t1_r0, \"addresses\".\"user_id\" AS t1_r1, \"addresses\".\"country\" AS t1_r2, \"addresses\".\"street\" AS t1_r3, \"addresses\".\"postal_code\" AS t1_r4, \"addresses\".\"city\" AS t1_r5, \"addresses\".\"created_at\" AS t1_r6, \"addresses\".\"updated_at\" AS t1_r7\n# FROM \"users\"\n# LEFT OUTER JOIN \"addresses\"\n# ON \"addresses\".\"user_id\" = \"users\".\"id\" AND \"addresses\".\"country\" = 'Poland'\n\nr\n# [\n#   #<User id: 1, name: \"Robert Pankowecki\", email: \"robert@example.org\", created_at: \"2013-12-08 11:26:24\", updated_at: \"2013-12-08 11:26:24\">,\n#   #<User id: 2, name: \"Bob Doe\", email: \"bob@example.org\", created_at: \"2013-12-08 11:26:25\", updated_at: \"2013-12-08 11:26:25\">\n# ]\n\nr[0].polish_addresses\n# [\n#   #<Address id: 1, user_id: 1, country: \"Poland\", street: \"Rynek\", postal_code: \"55-555\", city: \"Wroc\u0142aw\", created_at: \"2013-12-08 11:26:50\", updated_at: \"2013-12-08 11:26:50\">\n# ]\n\nr[1].polish_addresses\n# []\n\n```\n\n### \u7ec8\u6781\u95ee\u9898\n\n\u4f60\u53ef\u80fd\u4f1a\u95ee, \"\u8fd9\u7279\u4e48\u5f88\u96be\u5417?\" \u6211\u4e0d\u786e\u5b9a, \u4f46\u662f\u6211\u60f3\u5927\u90e8\u5206\u7684 ORM\u7cfb\u7edf\u603b\u662f\u5e0c\u671b\u80fd\u591f\u8ba9\u4f60\u6784\u5efa\u4e00\u4e2a\u67e5\u8be2, \u7136\u540e\u4ece\u4e00\u4e2a\u8868\u91cc\u52a0\u8f7d\u6570\u636e. \u901a\u8fc7`eager loding` \u8ba9\u4e8b\u60c5\u53d8\u5f97\u590d\u6742. \u5f53\u6211\u4eec\u60f3\u8981\u5f97\u5230\u590d\u5408\u7684\u6570\u636e\u7ed3\u679c, \u4ece\u591a\u4e2a\u8868\u91cc,\u800c\u4e14\u662f\u591a\u4e2a\u6761\u4ef6\u7684\u60c5\u51b5\u4e0b. \u5728 Rails \u91cc\u6211\u4eec\u4f7f\u7528\u94fe\u6761\u5f0f\u7684 API \u6765\u5b9e\u73b02\u4e2a\u6216\u8005\u66f4\u591a\u7684\u67e5\u8be2(\u5982\u679c\u4f7f\u7528`# preload`)\n\n\u90a3\u4e48\u6211\u559c\u6b22\u4ec0\u4e48\u6837\u7684 API \u5462, \u6211\u5728\u60f3\u8fd9\u6837:\n\n```\nUser.joins(:addresses).where(\"addresses.country = ?\", \"Poland\").preload do |users|\n  users.preload(:addresses).where(\"addresses.country = ?\", \"Germany\")\n  users.preload(:lists) do |lists|\n    lists.preload(:tasks).where(\"tasks.state = ?\", \"unfinished\")\n  end\nend\n\n```\n\n## \u800c\u5728 Rails4\u91cc\u53d1\u751f\u4e86\u4ec0\u4e48\u53d8\u5316\u5462\n\n```\nclass User < ActiveRecord::Base\n  has_many :addresses\n  has_many :polish_addresses, -> {where(country: \"Poland\")}, class_name: \"Address\"\nend\n```\n\n\nRails \u9f13\u52b1\u5927\u5bb6\u4f7f\u7528\u66f4\u591a\u7684` lambda` \u8868\u8fbe\u5f0f\u7684\u8bed\u6cd5\u6765\u5b9a\u4e49\u805a\u5408\u7684\u6761\u4ef6. \u8fd9\u6837\u975e\u5e38\u4e0d\u9519, \u5176\u5b9e\u4e5f\u4e0d\u53ea\u662f` lambda` \u8868\u8fbe\u5f0f, \u65b9\u6cd5\u7684\u65b9\u5f0f\u4e5f\u662f\u4e00\u6837\u7684, \u90fd\u662f\u5728 **\u5b9a\u4e49\u8303\u56f4**\n\n\n```\n# Bad, Time.now would be always the time when the class was loaded\n# You might not even spot the bug in development because classes are\n# automatically reloaded for you after changes.\nscope :from_the_past, where(\"happens_at <= ?\", Time.now)\n\n# OK\nscope :from_the_past, -> { where(\"happens_at <= ?\", Time.now) }\n\n# OK\ndef self.from_the_past\n  where(\"happens_at <= ?\", Time.now)\nend\n\n```\n\n\n\u867d\u7136\u5728\u6211\u4eec\u7684\u4f8b\u5b50\u91cc` where(country: \"Poland\")`\u603b\u662f\u4e00\u6837\u7684,\u4e0d\u7ba1\u662f\u52a8\u6001\u7f16\u8bd1\u8fd8\u662f\u4e00\u5f00\u59cb\u5c31\u52a0\u8f7d, \u4f46\u662f\u597d\u5728\u5c31\u662f Rails \u4f1a\u5e2e\u52a9\u6211\u4eec\u8fdc\u79bb bug, \u6211\u4eec\u770b\u770b\u5b83\u4eec\u662f\u5426\u53d1\u751f\u4e86\u53d8\u5316:\n\n```\nUser.includes(:addresses)\n#  SELECT \"users\".* FROM \"users\"\n#  SELECT \"addresses\".* FROM \"addresses\" WHERE \"addresses\".\"user_id\" IN (1, 2)\n\nUser.preload(:addresses)\n#  SELECT \"users\".* FROM \"users\"\n#  SELECT \"addresses\".* FROM \"addresses\" WHERE \"addresses\".\"user_id\" IN (1, 2)\n\nUser.eager_load(:addresses)\n#  SELECT \"users\".\"id\" AS t0_r0, \"users\".\"name\" AS t0_r1, \"users\".\"email\" AS t0_r2, \"users\".\"created_at\" AS t0_r3, \"users\".\"updated_at\" AS t0_r4,\n#         \"addresses\".\"id\" AS t1_r0, \"addresses\".\"user_id\" AS t1_r1, \"addresses\".\"country\" AS t1_r2, \"addresses\".\"street\" AS t1_r3, \"addresses\".\"postal_code\" AS t1_r4, \"addresses\".\"city\" AS t1_r5, \"addresses\".\"created_at\" AS t1_r6, \"addresses\".\"updated_at\" AS t1_r7\n#  FROM \"users\"\n#  LEFT OUTER JOIN \"addresses\"\n#  ON \"addresses\".\"user_id\" = \"users\".\"id\"\n```\n\u5e76\u6ca1\u6709, \u4f46\u662f\u6211\u4eec\u8bd5\u7740\u52a0\u51e0\u4e2a\u6761\u4ef6, \u4e4b\u524d\u603b\u662f\u4f1a\u62a5\u9519\u7684\u90a3\u79cd\u60c5\u51b5:\n\n```\nUser.includes(:addresses).where(\"addresses.country = ?\", \"Poland\")\n```\n\n\u8bd5\u8bd5\u8fd9\u4e2a, \u53d1\u73b0\u62a5\u9519\u4e86, \u63a5\u7740\u8bd5\u8bd5\u8fd9\u4e2a\n\n```\nUser.includes(:addresses).where(\"addresses.country = ?\", \"Poland\").references(:addresses)\n```\n\n\u6211\u5f88\u597d\u5947\u5982\u679c\u6211\u4eec\u60f3\u8981\u9884\u52a0\u8f7d\u66f4\u591a\u7684\u8868,\u800c\u53ea\u5f15\u7528\u5176\u4e2d\u4e00\u5f20\u8868\u5462?\n\n```\nUser.includes(:addresses).where(\"addresses.country = ?\", \"Poland\").references(:addresses)\n```\n\n\u6211\u8bd5\u60f3`addresses` \u5c06\u4f1a\u901a\u8fc7` eager_load` \u7684\u65b9\u5f0f\u8fd8\u6709` place` \u5c06\u4f1a\u901a\u8fc7` preload` \u7684\u65b9\u5f0f\u6765\u52a0\u8f7d. \u4f46\u662f\u7ed3\u679c\u5e76\u4e0d\u662f, \u5728 Rails4\u4e2d\u5e76\u4e0d\u4f1a\u8b66\u544a\u5982\u679c\u4f7f\u7528\u4e86` reference` \u800c\u540c\u65f6\u663e\u5f0f\u4f7f\u7528` eager_load`,\n\n```\nUser.eager_load(:addresses).where(\"addresses.country = ?\", \"Poland\")\n\n```\n\nUser.includes(:addresses).where(\"addresses.country = ?\", \"Poland\").references(:addresses)\nUser.eager_load(:addresses).where(\"addresses.country = ?\", \"Poland\")\n```\n\n\u800c\u5982\u679c\u4f7f\u7528 preload \u8fd8\u662f\u62a5\u540c\u6837\u7684\u9519:\n\n```\nUser.preload(:addresses).where(\"addresses.country = ?\", \"Poland\")\n#  SELECT \"users\".* FROM \"users\" WHERE (addresses.country = 'Poland')\n#\n#  SQLite3::SQLException: no such column: addresses.country: SELECT \"users\".* FROM \"users\"  WHERE (addresses.country = 'Poland')\n```\n\n\n### \u603b\u7ed3\n\n\u5bf9\u4e8e\u8fd9\u4e09\u4e2a\u65b9\u6cd5\n\n- includes\n- preload\n- eager_load\n\n`includes` \u4f1a\u88ab rails \u5b9e\u9645\u59d4\u6258\u7ed9 preload \u6216\u8005 eager_load, \u53d6\u51b3\u4e8e\u540e\u9762\u662f\u5426\u8ddf\u4e86\u6761\u4ef6, \u800c\u6761\u4ef6\u91cc\u662f\u5426\u5305\u542b\u4e86\u9700\u8981 preload \u7684\u8868.\n\n`#preload` \u5c31\u662f\u8981\u4f7f\u7528\u5355\u72ec\u7684\u8bed\u53e5\u5148\u62ff\u5230\u5168\u90e8\u7684\u7ed3\u679c\u96c6.\n\n`#eager_load` \u901a\u8fc7\u90fd\u662f\u4f7f\u7528\u4e86` LEFT JOIN` \u6765` eager load` \u5173\u8054\u7684\u8868.\n\n\nref:\n\n- http://blog.arkency.com/2013/12/rails4-preloading/\n- https://www.rubyplus.com/articles/3211-Eager-Loading-in-Rails-5\n- https://www.allerin.com/blog/eager-loading-inwith-rails\n- http://stackoverflow.com/questions/10084355/eager-loading-and-lazy-loading-in-rails\n- http://stackoverflow.com/questions/41654098/rails-5-how-to-form-association-between-tables-on-multiple-shared-attributes\n", "tags": ["rails3", "ActiveRecord", "Rails4"]}