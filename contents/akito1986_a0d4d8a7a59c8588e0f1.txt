{"tags": ["Redmine", "CentOS", "unicorn", "nginx"], "context": " More than 1 year has passed since last update.\n\n\u306f\u3058\u3081\u306b\n\u305f\u307e\u306b\u7acb\u3066\u308b\u3053\u3068\u304c\u3042\u308b\u306e\u3067\u30e1\u30e2\u3057\u3066\u304a\u304f\u3002\n\u8aa4\u308a\u3042\u3063\u305f\u3089\u6307\u6458\u304a\u9858\u3044\u3057\u307e\u3059\u3002\n\u57fa\u672c\u7684\u306b\u306f\nhttp://blog.redmine.jp/articles/2_6/installation_centos/\n\u3068\u540c\u3058\u624b\u9806\u3002\n\n\u74b0\u5883\n\nOS: CentOS7\nRuby: 2.1.5\nRedmine: 2.6.1\nNginx: nginx/1.6.2\nUnicorn: 4.8.3\n\n\nRedmine\u95a2\u9023\u306ePackage\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\nRedmine\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u306b\u5fc5\u8981\u306a\u30d1\u30c3\u30b1\u30fc\u30b8\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3002\nDB\u306b\u306fMariaDB\u3092\u5229\u7528\n$ sudo yum -y groupinstall \"Development Tools\"\n$ sudo yum -y install openssl-devel readline-devel zlib-devel curl-devel libyaml-devel\n$ sudo yum -y install mariadb-server mariadb-devel\n$ sudo yum -y install ImageMagick ImageMagick-devel ipa-pgothic-fonts\n\n\nRuby\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\nrbenv\u74b0\u5883\u3067Ruby2.1.5\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u3002\n\ninstall\n$ sudo yum install gcc make openssl openssl-devel\n\n\n$ cd /usr/local/\n$ sudo git clone git://github.com/sstephenson/rbenv.git rbenv\n$ mkdir -p rbenv/shims rbenv/versions\n$ sudo groupadd /usr/local/rbenv\n$ sudo chgrp -R rbenv rbenv/\n$ sudo git clone git://github.com/sstephenson/ruby-build.git /usr/local/rbenv/ruby-build\n$ cd /usr/local/rbenv/ruby-build\n$ ./install.sh\n\n\u74b0\u5883\u5909\u6570\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u306e\u4f5c\u6210\u3002\n\n/etc/profile.d/rbenv.sh\nexport RBENV_ROOT=\"/usr/local/rbenv\"\nexport PATH=\"/usr/local/rbenv/bin:$PATH\"\neval \"$(rbenv init -)\"\n\n\n$ source /etc/profile.d/rbenv.sh\n$ sudo rbenv install -v 2.1.5\n$ rbenv versions\n* system (set by /usr/local/rbenv/version)\n  2.1.3\n$ sudo rbenv global 2.1.3\n$ rbenv versions\n  system\n* 2.1.5 (set by /usr/local/rbenv/version)\n$ ruby --version\nruby 2.1.5p273 (2014-11-13 revision 48405) [x86_64-linux]\n$\n\n\nBundler\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n$ sudo gem install bundler --no-rdoc --no-ri\n$ bundle --version\nBundler version 1.7.12\n$\n\n\nMariaDB\u8a2d\u5b9a\n\u307e\u305a\u306fMariaDB\u306e\u8a2d\u5b9a\u3002\n\n/etc/my.cnf\n[mysqld]\ndatadir=/data/mysql # Data\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3001\u4efb\u610f\nsocket=/var/lib/mysql/mysql.sock\n# Disabling symbolic-links is recommended to prevent assorted security risks\nsymbolic-links=0\n# Settings user and group are ignored when systemd is used.\n# If you need to run mysqld under a different user or group,\n# customize your systemd unit file for mariadb according to the\n# instructions in http://fedoraproject.org/wiki/Systemd\n\ncharacter-set-server=utf8\n\n[mysqld_safe]\nlog-error=/var/log/mariadb/mariadb.log\npid-file=/var/run/mariadb/mariadb.pid\n\n#\n# include all files from the config directory\n#\n!includedir /etc/my.cnf.d\n\n[mysql]\ndefault-character-set=utf8\n\n\n\u30c7\u30fc\u30bf\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u4f5c\u6210\u3068\u81ea\u52d5\u8d77\u52d5\u8a2d\u5b9a\u3002\n$ sudo mkdir -p /data/mysql # \u30c7\u30fc\u30bf\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306e\u4f5c\u6210\n$ sudo chown mysql:mysql /data/mysql\n$ sudo service mariadb start\n$ sudo systemctl enable mariadb\n\n\u521d\u671f\u8a2d\u5b9a\u3092mysql_secure_installation\u3067root\u306e\u30d1\u30b9\u30ef\u30fc\u30c9\u3092\u8a2d\u5b9a\u3002\n$ mysql_secure_installation\nNOTE: RUNNING ALL PARTS OF THIS SCRIPT IS RECOMMENDED FOR ALL MariaDB\n      SERVERS IN PRODUCTION USE!  PLEASE READ EACH STEP CAREFULLY!\n\nIn order to log into MariaDB to secure it, we'll need the current\npassword for the root user.  If you've just installed MariaDB, and\nyou haven't set the root password yet, the password will be blank,\nso you should just press enter here.\n\nEnter current password for root (enter for none): \nOK, successfully used password, moving on...\n\nSetting the root password ensures that nobody can log into the MariaDB\nroot user without the proper authorisation.\n\nSet root password? [Y/n] y\nNew password: ${root_passwd}\nRe-enter new password: ${root_passwd}\nPassword updated successfully!\nReloading privilege tables..\n ... Success!\n\n\nBy default, a MariaDB installation has an anonymous user, allowing anyone\nto log into MariaDB without having to have a user account created for\nthem.  This is intended only for testing, and to make the installation\ngo a bit smoother.  You should remove them before moving into a\nproduction environment.\n\nRemove anonymous users? [Y/n] y\n ... Success!\n\nNormally, root should only be allowed to connect from 'localhost'.  This\nensures that someone cannot guess at the root password from the network.\n\nDisallow root login remotely? [Y/n] y\n ... Success!\n\nBy default, MariaDB comes with a database named 'test' that anyone can\naccess.  This is also intended only for testing, and should be removed\nbefore moving into a production environment.\n\nRemove test database and access to it? [Y/n] y\n - Dropping test database...\n ... Success!\n - Removing privileges on test database...\n ... Success!\n\nReloading the privilege tables will ensure that all changes made so far\nwill take effect immediately.\n\nReload privilege tables now? [Y/n] y\n ... Success!\n\nCleaning up...\n\nAll done!  If you've completed all of the above steps, your MariaDB\ninstallation should now be secure.\n\nThanks for using MariaDB!\n$\n\n\u521d\u671f\u8a2d\u5b9a\u5f8c\u306fredmine\u7528\u306eDBredmine\u3068\u7ba1\u7406\u8005\u30e6\u30fc\u30b6\u30fc\u306eredmine\u3092\u4f5c\u6210\u3002\n$ mysql -uroot -p\nEnter password: ${mysql_root_password}\nWelcome to the MariaDB monitor.  Commands end with ; or \\g.\nYour MariaDB connection id is 10\nServer version: 5.5.40-MariaDB MariaDB Server\n\nCopyright (c) 2000, 2014, Oracle, Monty Program Ab and others.\n\nType 'help;' or '\\h' for help. Type '\\c' to clear the current input statement.\n\nMariaDB [(none)]> \nMariaDB [(none)]> \nMariaDB [(none)]> CREATE DATABASE redmine DEFAULT character set utf8;\nQuery OK, 1 row affected (0.00 sec)\n\nMariaDB [(none)]> grant all on redmine.* TO redmine@localhost identified by '${redmine_passwd}';\nQuery OK, 0 rows affected (0.00 sec)\n\nMariaDB [(none)]> flush privileges;\nQuery OK, 0 rows affected (0.00 sec)\n\nMariaDB [(none)]> exit;\n$\n\n\nRedmine\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\u307e\u305a\u306f\u30bd\u30fc\u30b9\u306e\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3068\u5c55\u958b\u3002\n\u305d\u306e\u5f8c\u30b7\u30f3\u30dc\u30ea\u30c3\u30af\u30ea\u30f3\u30af\u3092\u4f5c\u6210\u3002\n$ cd /usr/local/src\n$ sudo curl -O http://www.redmine.org/releases/redmine-2.6.1.tar.gz\n$ sudo tar zxvf redmine-2.6.1.tar.gz\n$ sudo ln -s ./redmine-2.6.1 /opt/redmine # /opt/redmine\u306b\u30b7\u30f3\u30dc\u30ea\u30c3\u30af\u30ea\u30f3\u30af\u3092\u4f5c\u6210\n\n\u6b21\u306bredmine\u306edatabase\u8a2d\u5b9a\u3002\n\u307e\u305a\u306fexample\u30d5\u30a1\u30a4\u30eb\u3092\u30b3\u30d4\u30fc\u3002\n$ sudo cp -p /opt/redmine/config/database.yml.example /opt/redmine/config/database.yml\n$ \n\n\u6b21\u306b\u5148\u307b\u3069MariaDB\u3067\u4f5c\u6210\u3057\u305f\u30e6\u30fc\u30b6\u30fc\u3068DB\u3092\u6307\u5b9a\u3002\n\n/opt/redmine/config/database.yml\n# Default setup is given for MySQL with ruby1.9. If you're running Redmine\n# with MySQL and ruby1.8, replace the adapter name with `mysql`.\n# Examples for PostgreSQL, SQLite3 and SQL Server can be found at the end.\n# Line indentation must be 2 spaces (no tabs).\n\nproduction:\n  adapter: mysql2\n  database: redmine\n  host: localhost\n  username: redmine\n  password: \"${redmine_passwd}\"\n  encoding: utf8\n\n\n\u4ee5\u4e0bDB\u542b\u3081\u305f\u521d\u671f\u8a2d\u5b9a\u3002\n$ cd /opt/redmine\n$ bundle install --without development test --path vendor/bundle\n$ bundle exec rake generate_secret_token\n$ RAILS_ENV=production bundle exec rake db:migrate\n\n\nUnicorn\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\u6b21\u306bNginx\u3068Redmine\u3092\u7e4b\u3050Unicorn\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3002\nGem\u30d5\u30a1\u30a4\u30eb(/opt/redmine)\u7de8\u96c6\u5f8c\u306b\u3001\n\n/opt/redmine/Gemfile\ngem 'unicorn', '4.8.3'\n\n\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u3002\n$ bundle install\n\n\u6b21\u306bredmine\u7528\u306e\u74b0\u5883\u5909\u6570\u3092\u8a2d\u5b9a\u3002\n\n/etc/profile.d/redmine.sh\nRAILS_ROOT=/opt/redmine\nexport RAILS_ROOT\n\n\n\u74b0\u5883\u5909\u6570\u306e\u53cd\u6620\u3002\n$ source /etc/profile.d/redmine.sh\n\n\u4ee5\u4e0bUnicorn\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3002\nScoket\u30d5\u30a1\u30a4\u30eb\u306b\u3064\u3044\u3066\u3067\u3059\u304c\u3001/tmp/\u914d\u4e0b\u306b\u7f6e\u304f\u3068Nginx\u3067not found\u30a8\u30e9\u30fc\u3068\u306a\u308a\u307e\u3059\u3002\nhttp://serverfault.com/questions/463993/nginx-unix-domain-socket-error/464025#464025\n\n/opt/redmine/config/unicorn.rb\n# -*- coding: utf-8 -*-\n# \u30ef\u30fc\u30ab\u30fc\u306e\u6570\nworker_processes 2\n\n# \u30bd\u30b1\u30c3\u30c8\nlisten  '/var/run/unicorn.sock'\npid     '/var/run/unicorn.pid'\n\n# \u30ed\u30b0\nlog = File.expand_path('log/unicorn.log', ENV['RAILS_ROOT'])\nstderr_path File.expand_path('log/unicorn.log', ENV['RAILS_ROOT'])\nstdout_path File.expand_path('log/unicorn.log', ENV['RAILS_ROOT'])\n\npreload_app true\nGC.respond_to?(:copy_on_write_friendly=) and GC.copy_on_write_friendly = true\n\nbefore_fork do |server, worker|\ndefined?(ActiveRecord::Base) and ActiveRecord::Base.connection.disconnect!\n\nold_pid = \"#{ server.config[:pid] }.oldbin\"\nunless old_pid == server.pid\n  begin\n   sig = (worker.nr + 1) >= server.worker_processes ? :QUIT : :TTOU\n   Process.kill :QUIT, File.read(old_pid).to_i\n   rescue Errno::ENOENT, Errno::ESRCH\n  end\nend\nend\n\nafter_fork do |server, worker|\n    defined?(ActiveRecord::Base) and ActiveRecord::Base.establish_connection\nend\n\n\n\u4ee5\u4e0b\u8d77\u52d5\u30b9\u30af\u30ea\u30d7\u30c8\u3002\n\n/opt/redmine/script/unicorn.sh\n#!/bin/bash\n\nset -e\n\nTIMEOUT=60\nAPP_ROOT=${RAILS_ROOT}\nPID=/var/run/unicorn.pid\nRAILS_ENV=production\nCMD=\"bundle exec unicorn -D -c $APP_ROOT/config/unicorn.rb -E $RAILS_ENV\"\naction=\"$1\"\nset -u\n\nold_pid=\"$PID.oldbin\"\n\ncd $APP_ROOT || exit 1\n\nsig () {\n    test -s \"$PID\" && kill -$1 `cat $PID`\n}\n\noldsig () {\n    test -s $old_pid && kill -$1 `cat $old_pid`\n}\n\ncase $action in\nstart)\n    sig 0 && echo >&2 \"Already running\" && exit 0\n    $CMD\n    ;;\nstop)\n    sig QUIT && rm -f ${PID} && exit 0\n    echo >&2 \"Not running\"\n    ;;\nforce-stop)\n    sig TERM && exit 0\n    echo >&2 \"Not running\"\n    ;;\nrestart|reload)\n    sig HUP && echo reloaded OK && exit 0\n    echo >&2 \"Couldn't reload, starting '$CMD' instead\"\n    $CMD\n    ;;\nupgrade)\n    if sig USR2 && sleep 2 && sig 0 && oldsig QUIT\n    then\n        n=$TIMEOUT\n        while test -s $old_pid && test $n -ge 0\n        do\n            printf '.' && sleep 1 && n=$(( $n - 1 ))\n        done\n        echo\n\n        if test $n -lt 0 && test -s $old_pid\n        then\n            echo >&2 \"$old_pid still exists after $TIMEOUT seconds\"\n            exit 1\n        fi\n        exit 0\n    fi\n    echo >&2 \"Couldn't upgrade, starting '$CMD' instead\"\n    $CMD\n    ;;\nreopen-logs)\n    sig USR1\n    ;;\n*)\n    echo >&2 \"Usage: $0 <start|stop|restart|upgrade|force-stop|reopen-logs>\"\n    exit 1\n    ;;\nesac\n\n\nRedmine\u3092http://localhost/redmine/\u306e\u3088\u3046\u306b\u30b5\u30d6\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3068\u3057\u3066\u53c2\u7167\u3059\u308b\u306a\u3089\u4ee5\u4e0b\u306e\u3088\u3046\u306bconfig.ru\u3092\u7de8\u96c6\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\n/opt/redmine/config.ru\n# This file is used by Rack-based servers to start the application.\nRAILS_RELATIVE_URL_ROOT=\"/redmine\"\nrequire ::File.expand_path('../config/environment',  __FILE__)\nif RAILS_RELATIVE_URL_ROOT then\n        map RAILS_RELATIVE_URL_ROOT do\n                run Rails.application\n        end\nelse\n        run Rails.application\nend\n\n\n/redmine\u306e\u90e8\u5206\u306f\u3054\u81ea\u8eab\u306e\u74b0\u5883\u3067\u7f6e\u304d\u63db\u3048\u3066\u304f\u3060\u3055\u3044\u3002\n\nNginx\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\u30d1\u30c3\u30b1\u30fc\u30b8\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3002\n$ sudo rpm -Uvh http://nginx.org/packages/centos/7/noarch/RPMS/nginx-release-centos-7-0.el7.ngx.noarch.rpm # Nginx\u306e\u30d1\u30c3\u30b1\u30fc\u30b8\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\n$ sudo yum -y install nginx\n\n\u8a2d\u5b9a\u3002\n\u672c\u6765\u306a\u3089/etc/nginx/conf.d/redmine.conf\u306e\u3088\u3046\u306b\u66f8\u304f\u3079\u304d\u306a\u306e\u3067\u3059\u304c\u3001\u4eca\u56de\u306fUbuntu\u3068\u540c\u3058\u3088\u3046\u306bsites-available, sites-enabled\u3092\u4f5c\u6210\u3057\u3066\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n$ sudo mkdir -p /etc/nginx/sites-avaliable/ /etc/nginx/sites-enabled/\n\n\u4ee5\u4e0bNginx\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3002\n\n/etc/nginx/nginx.conf\n\nuser  nginx;\nworker_processes  1;\n\nerror_log  /var/log/nginx/error.log warn;\npid        /var/run/nginx.pid;\n\n\nevents {\n    worker_connections  1024;\n}\n\n\nhttp {\n    include       /etc/nginx/mime.types;\n    default_type  application/octet-stream;\n\n    log_format  main  '$remote_addr - $remote_user [$time_local] \"$request\" '\n                      '$status $body_bytes_sent \"$http_referer\" '\n                      '\"$http_user_agent\" \"$http_x_forwarded_for\"';\n\n    access_log  /var/log/nginx/access.log  main;\n\n    sendfile        on;\n    #tcp_nopush     on;\n\n    keepalive_timeout  65;\n\n    #gzip  on;\n\n    #include /etc/nginx/conf.d/*.conf;\n    include /etc/nginx/sites-enabled/*;\n}\n\n\n\u6b21\u306bRedmine\u7528\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3002\n/redmine\u3092redmine\u306b\u5272\u308a\u5f53\u3066\u308b\u3002\n\u307e\u305fSSL\u901a\u4fe1\u3055\u305b\u305f\u3044\u306e\u3067SSL\u5bfe\u5fdc\u3057\u3066\u3044\u308b\u3002\n\n/etc/nginx/sites-available/redmine\nupstream rails-unicorn {\n    server unix:/var/run/unicorn.sock fail_timeout=0;\n}\n\nserver {\n    listen 80;\n    server_name localhost;\n    return 301 https://$host$request_uri;\n}\n\nserver {\n    listen 443;\n    server_name localhost;\n\n\n    ssl on;\n    ssl_certificate /etc/nginx/ssl/redmine.crt;\n    ssl_certificate_key /etc/nginx/ssl/redmine.key;\n\n    ssl_session_timeout 5m;\n\n    ssl_protocols SSLv3 TLSv1;\n    ssl_ciphers ALL:!ADH:!EXPORT56:RC4+RSA:+HIGH:+MEDIUM:+LOW:+SSLv3:+EXP;\n    ssl_prefer_server_ciphers on;\n\n    #listen   80; ## listen for ipv4; this line is default and implied\n    #listen   [::]:80 default ipv6only=on; ## listen for ipv6\n\n    root /usr/share/nginx/html/public;\n    index index.php index.html index.htm;\n\n    # Make site accessible from http://localhost/\n    server_name localhost;\n\n    location /redmine/ {\n        try_files $uri $uri.html $uri/index.html @rails-unicorn;\n    }\n    location ~ ^/assets/(.*) {\n        alias /opt/redmine/public/assets/$1;\n    }\n\n    location @rails-unicorn {\n               proxy_set_header X-Real-IP $remote_addr;\n               proxy_set_header X-Forwarded_For $proxy_add_x_forwarded_for;\n               proxy_set_header Host $http_host;\n               proxy_pass http://rails-unicorn;\n    }\n\n    # Only for nginx-naxsi : process denied requests\n    #location /RequestDenied {\n        # For example, return an error code\n        #return 418;\n    #}\n\n    error_page 404 /404.html;\n\n    # redirect server error pages to the static page /50x.html\n    #\n    error_page 500 502 503 504 /50x.html;\n    location = /50x.html {\n        root /usr/share/nginx/html;\n    }\n\n}\n\n\n\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u306e\u6709\u52b9\u5316\u3002\n/etc/nginx/sites-enabled/\u306b\u30b7\u30f3\u30dc\u30ea\u30c3\u30af\u30ea\u30f3\u30af\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n$ sudo ln -s /etc/nginx/sites-available/redmine /etc/nginx/sites-enabled/\n\n\u6b21\u306bRedmine\u306eHTML\u30d5\u30a1\u30a4\u30eb\u3084CSS\u306a\u3069\u304c\u683c\u7d0d\u3055\u308c\u3066\u3044\u308b/opt/redmine/public\u306e\u30b7\u30f3\u30dc\u30ea\u30c3\u30af\u30ea\u30f3\u30af\u3092\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u30eb\u30fc\u30c8\u76f4\u4e0b\u306b\u4f5c\u6210\n$ sudo ln -s /opt/redmine/public/ /usr/share/nginx/html/\n\nUnicorn\u3068Nginx\u306e\u8d77\u52d5\u3002\n$ cd /opt/redmine\n$ sudo ./script/unicorn.sh start\n$ sudo service nginx start\n\n\n\u30a2\u30af\u30bb\u30b9\n\u4ee5\u4e0b\u51fa\u308c\u3070\u304ak\u3002\n\n\u521d\u671f\u306e\u7ba1\u7406\u8005\u306eusername/password\u306f\u4ee5\u4e0b\u3002\nadmin/admin\n\n\n\u304a\u308f\u308a\u306b\nRedmine2.6\u3067\u306fWiki\u304cMarkdown\u306b\u5bfe\u5fdc\u3057\u305f\u3089\u3057\u3044\u3002\n\n\u8ffd\u8a18\n\u7d50\u69cb\u629c\u3051\u6f0f\u308c\u304c\u3042\u3063\u305f\u306e\u3067\u8ffd\u8a18(2015/02/02)\n\u3053\u306e\u8a18\u4e8b\u3092\u53c2\u8003\u306b\u3057\u3066\u74b0\u5883\u69cb\u7bc9\u3057\u305f\u4eba\u3054\u3081\u3093\u306a\u3055\u3044m(_ _)m\n\n# \u306f\u3058\u3081\u306b\n\u305f\u307e\u306b\u7acb\u3066\u308b\u3053\u3068\u304c\u3042\u308b\u306e\u3067\u30e1\u30e2\u3057\u3066\u304a\u304f\u3002\n\u8aa4\u308a\u3042\u3063\u305f\u3089\u6307\u6458\u304a\u9858\u3044\u3057\u307e\u3059\u3002\n\n\u57fa\u672c\u7684\u306b\u306f\nhttp://blog.redmine.jp/articles/2_6/installation_centos/\n\u3068\u540c\u3058\u624b\u9806\u3002\n\n\n# \u74b0\u5883\n\n* OS: CentOS7\n* Ruby: 2.1.5\n* Redmine: 2.6.1\n* Nginx: nginx/1.6.2\n* Unicorn: 4.8.3\n\n# Redmine\u95a2\u9023\u306ePackage\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\nRedmine\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u306b\u5fc5\u8981\u306a\u30d1\u30c3\u30b1\u30fc\u30b8\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3002\nDB\u306b\u306fMariaDB\u3092\u5229\u7528\n\n```\n$ sudo yum -y groupinstall \"Development Tools\"\n$ sudo yum -y install openssl-devel readline-devel zlib-devel curl-devel libyaml-devel\n$ sudo yum -y install mariadb-server mariadb-devel\n$ sudo yum -y install ImageMagick ImageMagick-devel ipa-pgothic-fonts\n```\n\n# Ruby\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\nrbenv\u74b0\u5883\u3067Ruby2.1.5\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u3002\n\n```yum:install\n$ sudo yum install gcc make openssl openssl-devel\n```\n\n```\n$ cd /usr/local/\n$ sudo git clone git://github.com/sstephenson/rbenv.git rbenv\n$ mkdir -p rbenv/shims rbenv/versions\n$ sudo groupadd /usr/local/rbenv\n$ sudo chgrp -R rbenv rbenv/\n$ sudo git clone git://github.com/sstephenson/ruby-build.git /usr/local/rbenv/ruby-build\n$ cd /usr/local/rbenv/ruby-build\n$ ./install.sh\n```\n\n\u74b0\u5883\u5909\u6570\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u306e\u4f5c\u6210\u3002\n\n```file:/etc/profile.d/rbenv.sh\nexport RBENV_ROOT=\"/usr/local/rbenv\"\nexport PATH=\"/usr/local/rbenv/bin:$PATH\"\neval \"$(rbenv init -)\"\n```\n\n```\n$ source /etc/profile.d/rbenv.sh\n$ sudo rbenv install -v 2.1.5\n$ rbenv versions\n* system (set by /usr/local/rbenv/version)\n  2.1.3\n$ sudo rbenv global 2.1.3\n$ rbenv versions\n  system\n* 2.1.5 (set by /usr/local/rbenv/version)\n$ ruby --version\nruby 2.1.5p273 (2014-11-13 revision 48405) [x86_64-linux]\n$\n```\n\n\n# Bundler\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n```\n$ sudo gem install bundler --no-rdoc --no-ri\n$ bundle --version\nBundler version 1.7.12\n$\n```\n\n# MariaDB\u8a2d\u5b9a\n\n\u307e\u305a\u306fMariaDB\u306e\u8a2d\u5b9a\u3002\n\n```file:/etc/my.cnf\n[mysqld]\ndatadir=/data/mysql # Data\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3001\u4efb\u610f\nsocket=/var/lib/mysql/mysql.sock\n# Disabling symbolic-links is recommended to prevent assorted security risks\nsymbolic-links=0\n# Settings user and group are ignored when systemd is used.\n# If you need to run mysqld under a different user or group,\n# customize your systemd unit file for mariadb according to the\n# instructions in http://fedoraproject.org/wiki/Systemd\n\ncharacter-set-server=utf8\n\n[mysqld_safe]\nlog-error=/var/log/mariadb/mariadb.log\npid-file=/var/run/mariadb/mariadb.pid\n\n#\n# include all files from the config directory\n#\n!includedir /etc/my.cnf.d\n\n[mysql]\ndefault-character-set=utf8\n```\n\n\u30c7\u30fc\u30bf\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u4f5c\u6210\u3068\u81ea\u52d5\u8d77\u52d5\u8a2d\u5b9a\u3002\n\n```\n$ sudo mkdir -p /data/mysql # \u30c7\u30fc\u30bf\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306e\u4f5c\u6210\n$ sudo chown mysql:mysql /data/mysql\n$ sudo service mariadb start\n$ sudo systemctl enable mariadb\n```\n\n\u521d\u671f\u8a2d\u5b9a\u3092`mysql_secure_installation`\u3067root\u306e\u30d1\u30b9\u30ef\u30fc\u30c9\u3092\u8a2d\u5b9a\u3002\n\n```\n$ mysql_secure_installation\nNOTE: RUNNING ALL PARTS OF THIS SCRIPT IS RECOMMENDED FOR ALL MariaDB\n      SERVERS IN PRODUCTION USE!  PLEASE READ EACH STEP CAREFULLY!\n\nIn order to log into MariaDB to secure it, we'll need the current\npassword for the root user.  If you've just installed MariaDB, and\nyou haven't set the root password yet, the password will be blank,\nso you should just press enter here.\n\nEnter current password for root (enter for none): \nOK, successfully used password, moving on...\n\nSetting the root password ensures that nobody can log into the MariaDB\nroot user without the proper authorisation.\n\nSet root password? [Y/n] y\nNew password: ${root_passwd}\nRe-enter new password: ${root_passwd}\nPassword updated successfully!\nReloading privilege tables..\n ... Success!\n\n\nBy default, a MariaDB installation has an anonymous user, allowing anyone\nto log into MariaDB without having to have a user account created for\nthem.  This is intended only for testing, and to make the installation\ngo a bit smoother.  You should remove them before moving into a\nproduction environment.\n\nRemove anonymous users? [Y/n] y\n ... Success!\n\nNormally, root should only be allowed to connect from 'localhost'.  This\nensures that someone cannot guess at the root password from the network.\n\nDisallow root login remotely? [Y/n] y\n ... Success!\n\nBy default, MariaDB comes with a database named 'test' that anyone can\naccess.  This is also intended only for testing, and should be removed\nbefore moving into a production environment.\n\nRemove test database and access to it? [Y/n] y\n - Dropping test database...\n ... Success!\n - Removing privileges on test database...\n ... Success!\n\nReloading the privilege tables will ensure that all changes made so far\nwill take effect immediately.\n\nReload privilege tables now? [Y/n] y\n ... Success!\n\nCleaning up...\n\nAll done!  If you've completed all of the above steps, your MariaDB\ninstallation should now be secure.\n\nThanks for using MariaDB!\n$\n```\n\n\u521d\u671f\u8a2d\u5b9a\u5f8c\u306fredmine\u7528\u306eDB`redmine`\u3068\u7ba1\u7406\u8005\u30e6\u30fc\u30b6\u30fc\u306e`redmine`\u3092\u4f5c\u6210\u3002\n\n```\n$ mysql -uroot -p\nEnter password: ${mysql_root_password}\nWelcome to the MariaDB monitor.  Commands end with ; or \\g.\nYour MariaDB connection id is 10\nServer version: 5.5.40-MariaDB MariaDB Server\n\nCopyright (c) 2000, 2014, Oracle, Monty Program Ab and others.\n\nType 'help;' or '\\h' for help. Type '\\c' to clear the current input statement.\n\nMariaDB [(none)]> \nMariaDB [(none)]> \nMariaDB [(none)]> CREATE DATABASE redmine DEFAULT character set utf8;\nQuery OK, 1 row affected (0.00 sec)\n\nMariaDB [(none)]> grant all on redmine.* TO redmine@localhost identified by '${redmine_passwd}';\nQuery OK, 0 rows affected (0.00 sec)\n\nMariaDB [(none)]> flush privileges;\nQuery OK, 0 rows affected (0.00 sec)\n\nMariaDB [(none)]> exit;\n$\n```\n\n# Redmine\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\u307e\u305a\u306f\u30bd\u30fc\u30b9\u306e\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3068\u5c55\u958b\u3002\n\u305d\u306e\u5f8c\u30b7\u30f3\u30dc\u30ea\u30c3\u30af\u30ea\u30f3\u30af\u3092\u4f5c\u6210\u3002\n\n```\n$ cd /usr/local/src\n$ sudo curl -O http://www.redmine.org/releases/redmine-2.6.1.tar.gz\n$ sudo tar zxvf redmine-2.6.1.tar.gz\n$ sudo ln -s ./redmine-2.6.1 /opt/redmine # /opt/redmine\u306b\u30b7\u30f3\u30dc\u30ea\u30c3\u30af\u30ea\u30f3\u30af\u3092\u4f5c\u6210\n```\n\n\u6b21\u306bredmine\u306edatabase\u8a2d\u5b9a\u3002\n\u307e\u305a\u306fexample\u30d5\u30a1\u30a4\u30eb\u3092\u30b3\u30d4\u30fc\u3002\n\n```\n$ sudo cp -p /opt/redmine/config/database.yml.example /opt/redmine/config/database.yml\n$ \n```\n\n\u6b21\u306b\u5148\u307b\u3069MariaDB\u3067\u4f5c\u6210\u3057\u305f\u30e6\u30fc\u30b6\u30fc\u3068DB\u3092\u6307\u5b9a\u3002\n\n```file:/opt/redmine/config/database.yml\n# Default setup is given for MySQL with ruby1.9. If you're running Redmine\n# with MySQL and ruby1.8, replace the adapter name with `mysql`.\n# Examples for PostgreSQL, SQLite3 and SQL Server can be found at the end.\n# Line indentation must be 2 spaces (no tabs).\n\nproduction:\n  adapter: mysql2\n  database: redmine\n  host: localhost\n  username: redmine\n  password: \"${redmine_passwd}\"\n  encoding: utf8\n```\n\n\u4ee5\u4e0bDB\u542b\u3081\u305f\u521d\u671f\u8a2d\u5b9a\u3002\n\n```\n$ cd /opt/redmine\n$ bundle install --without development test --path vendor/bundle\n$ bundle exec rake generate_secret_token\n$ RAILS_ENV=production bundle exec rake db:migrate\n```\n\n# Unicorn\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n\u6b21\u306bNginx\u3068Redmine\u3092\u7e4b\u3050Unicorn\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3002\nGem\u30d5\u30a1\u30a4\u30eb(/opt/redmine)\u7de8\u96c6\u5f8c\u306b\u3001\n\n```file:/opt/redmine/Gemfile\ngem 'unicorn', '4.8.3'\n```\n\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u3002\n\n```\n$ bundle install\n```\n\n\u6b21\u306bredmine\u7528\u306e\u74b0\u5883\u5909\u6570\u3092\u8a2d\u5b9a\u3002\n\n```file:/etc/profile.d/redmine.sh\nRAILS_ROOT=/opt/redmine\nexport RAILS_ROOT\n```\n\n\u74b0\u5883\u5909\u6570\u306e\u53cd\u6620\u3002\n\n```\n$ source /etc/profile.d/redmine.sh\n```\n\n\u4ee5\u4e0bUnicorn\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3002\n\nScoket\u30d5\u30a1\u30a4\u30eb\u306b\u3064\u3044\u3066\u3067\u3059\u304c\u3001/tmp/\u914d\u4e0b\u306b\u7f6e\u304f\u3068Nginx\u3067not found\u30a8\u30e9\u30fc\u3068\u306a\u308a\u307e\u3059\u3002\nhttp://serverfault.com/questions/463993/nginx-unix-domain-socket-error/464025#464025\n\n\n```file:/opt/redmine/config/unicorn.rb\n# -*- coding: utf-8 -*-\n# \u30ef\u30fc\u30ab\u30fc\u306e\u6570\nworker_processes 2\n\n# \u30bd\u30b1\u30c3\u30c8\nlisten  '/var/run/unicorn.sock'\npid     '/var/run/unicorn.pid'\n\n# \u30ed\u30b0\nlog = File.expand_path('log/unicorn.log', ENV['RAILS_ROOT'])\nstderr_path File.expand_path('log/unicorn.log', ENV['RAILS_ROOT'])\nstdout_path File.expand_path('log/unicorn.log', ENV['RAILS_ROOT'])\n\npreload_app true\nGC.respond_to?(:copy_on_write_friendly=) and GC.copy_on_write_friendly = true\n\nbefore_fork do |server, worker|\ndefined?(ActiveRecord::Base) and ActiveRecord::Base.connection.disconnect!\n\nold_pid = \"#{ server.config[:pid] }.oldbin\"\nunless old_pid == server.pid\n  begin\n   sig = (worker.nr + 1) >= server.worker_processes ? :QUIT : :TTOU\n   Process.kill :QUIT, File.read(old_pid).to_i\n   rescue Errno::ENOENT, Errno::ESRCH\n  end\nend\nend\n\nafter_fork do |server, worker|\n    defined?(ActiveRecord::Base) and ActiveRecord::Base.establish_connection\nend\n```\n\n\u4ee5\u4e0b\u8d77\u52d5\u30b9\u30af\u30ea\u30d7\u30c8\u3002\n\n```file:/opt/redmine/script/unicorn.sh\n#!/bin/bash\n\nset -e\n\nTIMEOUT=60\nAPP_ROOT=${RAILS_ROOT}\nPID=/var/run/unicorn.pid\nRAILS_ENV=production\nCMD=\"bundle exec unicorn -D -c $APP_ROOT/config/unicorn.rb -E $RAILS_ENV\"\naction=\"$1\"\nset -u\n\nold_pid=\"$PID.oldbin\"\n\ncd $APP_ROOT || exit 1\n\nsig () {\n    test -s \"$PID\" && kill -$1 `cat $PID`\n}\n\noldsig () {\n    test -s $old_pid && kill -$1 `cat $old_pid`\n}\n\ncase $action in\nstart)\n    sig 0 && echo >&2 \"Already running\" && exit 0\n    $CMD\n    ;;\nstop)\n    sig QUIT && rm -f ${PID} && exit 0\n    echo >&2 \"Not running\"\n    ;;\nforce-stop)\n    sig TERM && exit 0\n    echo >&2 \"Not running\"\n    ;;\nrestart|reload)\n    sig HUP && echo reloaded OK && exit 0\n    echo >&2 \"Couldn't reload, starting '$CMD' instead\"\n    $CMD\n    ;;\nupgrade)\n    if sig USR2 && sleep 2 && sig 0 && oldsig QUIT\n    then\n        n=$TIMEOUT\n        while test -s $old_pid && test $n -ge 0\n        do\n            printf '.' && sleep 1 && n=$(( $n - 1 ))\n        done\n        echo\n\n        if test $n -lt 0 && test -s $old_pid\n        then\n            echo >&2 \"$old_pid still exists after $TIMEOUT seconds\"\n            exit 1\n        fi\n        exit 0\n    fi\n    echo >&2 \"Couldn't upgrade, starting '$CMD' instead\"\n    $CMD\n    ;;\nreopen-logs)\n    sig USR1\n    ;;\n*)\n    echo >&2 \"Usage: $0 <start|stop|restart|upgrade|force-stop|reopen-logs>\"\n    exit 1\n    ;;\nesac\n```\n\nRedmine\u3092`http://localhost/redmine/`\u306e\u3088\u3046\u306b\u30b5\u30d6\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3068\u3057\u3066\u53c2\u7167\u3059\u308b\u306a\u3089\u4ee5\u4e0b\u306e\u3088\u3046\u306bconfig.ru\u3092\u7de8\u96c6\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\n```file:/opt/redmine/config.ru\n# This file is used by Rack-based servers to start the application.\nRAILS_RELATIVE_URL_ROOT=\"/redmine\"\nrequire ::File.expand_path('../config/environment',  __FILE__)\nif RAILS_RELATIVE_URL_ROOT then\n        map RAILS_RELATIVE_URL_ROOT do\n                run Rails.application\n        end\nelse\n        run Rails.application\nend\n```\n\n`/redmine`\u306e\u90e8\u5206\u306f\u3054\u81ea\u8eab\u306e\u74b0\u5883\u3067\u7f6e\u304d\u63db\u3048\u3066\u304f\u3060\u3055\u3044\u3002\n\n# Nginx\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n\u30d1\u30c3\u30b1\u30fc\u30b8\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3002\n\n```\n$ sudo rpm -Uvh http://nginx.org/packages/centos/7/noarch/RPMS/nginx-release-centos-7-0.el7.ngx.noarch.rpm # Nginx\u306e\u30d1\u30c3\u30b1\u30fc\u30b8\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\n$ sudo yum -y install nginx\n```\n\n\u8a2d\u5b9a\u3002\n\n\u672c\u6765\u306a\u3089`/etc/nginx/conf.d/redmine.conf`\u306e\u3088\u3046\u306b\u66f8\u304f\u3079\u304d\u306a\u306e\u3067\u3059\u304c\u3001\u4eca\u56de\u306fUbuntu\u3068\u540c\u3058\u3088\u3046\u306bsites-available, sites-enabled\u3092\u4f5c\u6210\u3057\u3066\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\n```\n$ sudo mkdir -p /etc/nginx/sites-avaliable/ /etc/nginx/sites-enabled/\n```\n\n\u4ee5\u4e0bNginx\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3002\n\n```file:/etc/nginx/nginx.conf\n\nuser  nginx;\nworker_processes  1;\n\nerror_log  /var/log/nginx/error.log warn;\npid        /var/run/nginx.pid;\n\n\nevents {\n    worker_connections  1024;\n}\n\n\nhttp {\n    include       /etc/nginx/mime.types;\n    default_type  application/octet-stream;\n\n    log_format  main  '$remote_addr - $remote_user [$time_local] \"$request\" '\n                      '$status $body_bytes_sent \"$http_referer\" '\n                      '\"$http_user_agent\" \"$http_x_forwarded_for\"';\n\n    access_log  /var/log/nginx/access.log  main;\n\n    sendfile        on;\n    #tcp_nopush     on;\n\n    keepalive_timeout  65;\n\n    #gzip  on;\n\n    #include /etc/nginx/conf.d/*.conf;\n    include /etc/nginx/sites-enabled/*;\n}\n```\n\n\u6b21\u306bRedmine\u7528\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3002\n`/redmine`\u3092redmine\u306b\u5272\u308a\u5f53\u3066\u308b\u3002\n\u307e\u305fSSL\u901a\u4fe1\u3055\u305b\u305f\u3044\u306e\u3067SSL\u5bfe\u5fdc\u3057\u3066\u3044\u308b\u3002\n\n\n```file:/etc/nginx/sites-available/redmine\nupstream rails-unicorn {\n    server unix:/var/run/unicorn.sock fail_timeout=0;\n}\n\nserver {\n    listen 80;\n    server_name localhost;\n    return 301 https://$host$request_uri;\n}\n\nserver {\n    listen 443;\n    server_name localhost;\n\n\n    ssl on;\n    ssl_certificate /etc/nginx/ssl/redmine.crt;\n    ssl_certificate_key /etc/nginx/ssl/redmine.key;\n\n    ssl_session_timeout 5m;\n\n    ssl_protocols SSLv3 TLSv1;\n    ssl_ciphers ALL:!ADH:!EXPORT56:RC4+RSA:+HIGH:+MEDIUM:+LOW:+SSLv3:+EXP;\n    ssl_prefer_server_ciphers on;\n\n    #listen   80; ## listen for ipv4; this line is default and implied\n    #listen   [::]:80 default ipv6only=on; ## listen for ipv6\n\n    root /usr/share/nginx/html/public;\n    index index.php index.html index.htm;\n\n    # Make site accessible from http://localhost/\n    server_name localhost;\n\n    location /redmine/ {\n        try_files $uri $uri.html $uri/index.html @rails-unicorn;\n    }\n    location ~ ^/assets/(.*) {\n        alias /opt/redmine/public/assets/$1;\n    }\n\n    location @rails-unicorn {\n               proxy_set_header X-Real-IP $remote_addr;\n               proxy_set_header X-Forwarded_For $proxy_add_x_forwarded_for;\n               proxy_set_header Host $http_host;\n               proxy_pass http://rails-unicorn;\n    }\n\n    # Only for nginx-naxsi : process denied requests\n    #location /RequestDenied {\n        # For example, return an error code\n        #return 418;\n    #}\n\n    error_page 404 /404.html;\n\n    # redirect server error pages to the static page /50x.html\n    #\n    error_page 500 502 503 504 /50x.html;\n    location = /50x.html {\n        root /usr/share/nginx/html;\n    }\n\n}\n```\n\n\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u306e\u6709\u52b9\u5316\u3002\n`/etc/nginx/sites-enabled/`\u306b\u30b7\u30f3\u30dc\u30ea\u30c3\u30af\u30ea\u30f3\u30af\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n```\n$ sudo ln -s /etc/nginx/sites-available/redmine /etc/nginx/sites-enabled/\n```\n\n\u6b21\u306bRedmine\u306eHTML\u30d5\u30a1\u30a4\u30eb\u3084CSS\u306a\u3069\u304c\u683c\u7d0d\u3055\u308c\u3066\u3044\u308b`/opt/redmine/public`\u306e\u30b7\u30f3\u30dc\u30ea\u30c3\u30af\u30ea\u30f3\u30af\u3092\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u30eb\u30fc\u30c8\u76f4\u4e0b\u306b\u4f5c\u6210\n\n```\n$ sudo ln -s /opt/redmine/public/ /usr/share/nginx/html/\n```\n\nUnicorn\u3068Nginx\u306e\u8d77\u52d5\u3002\n\n```\n$ cd /opt/redmine\n$ sudo ./script/unicorn.sh start\n$ sudo service nginx start\n```\n\n# \u30a2\u30af\u30bb\u30b9\n\u4ee5\u4e0b\u51fa\u308c\u3070\u304ak\u3002\n\n![redmine.png](https://qiita-image-store.s3.amazonaws.com/0/46472/f441a428-ef59-150e-faa6-f2d600aebffb.png \"redmine.png\")\n\n\u521d\u671f\u306e\u7ba1\u7406\u8005\u306eusername/password\u306f\u4ee5\u4e0b\u3002\n\n```\nadmin/admin\n```\n\n# \u304a\u308f\u308a\u306b\nRedmine2.6\u3067\u306fWiki\u304cMarkdown\u306b\u5bfe\u5fdc\u3057\u305f\u3089\u3057\u3044\u3002\n\n# \u8ffd\u8a18\n\u7d50\u69cb\u629c\u3051\u6f0f\u308c\u304c\u3042\u3063\u305f\u306e\u3067\u8ffd\u8a18(2015/02/02)\n\u3053\u306e\u8a18\u4e8b\u3092\u53c2\u8003\u306b\u3057\u3066\u74b0\u5883\u69cb\u7bc9\u3057\u305f\u4eba\u3054\u3081\u3093\u306a\u3055\u3044m(_ _)m\n\n\n\n"}