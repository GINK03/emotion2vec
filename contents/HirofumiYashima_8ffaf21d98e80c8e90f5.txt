{"tags": ["\u6642\u7cfb\u5217\u30c7\u30fc\u30bf", "\u6642\u7cfb\u5217\u89e3\u6790", "SQL", "\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9", "\u30c7\u30fc\u30bf\u5206\u6790"], "context": " More than 1 year has passed since last update.\n\n\u30df\u30c3\u30af\uff08\u8457\uff09\u300e\u9054\u4eba\u306b\u5b66\u3076SQL\u5fb9\u5e95\u6307\u5357\u66f8 \u521d\u7d1a\u8005\u3067\u7d42\u308f\u308a\u305f\u304f\u306a\u3044\u3042\u306a\u305f\u3078\u300f\uff08SHOEISHA) pp.104\uff5e110 \u3067\u306f\u3001\u4ee5\u4e0b\uff12\u3064\u306e\u30af\u30a8\u30ea\u304c\u7b49\u4fa1\u3067\u3042\u308b\u3053\u3068\u304c\u8aac\u660e\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n\u3010 SQL 1 \u3011\u300c\u76f8\u95a2\u30b5\u30d6\u30af\u30a8\u30ea\u300d\u3092\u7528\u3044\u305f\u30af\u30a8\u30ea\n\nSQL\nSELECT S1.year,\n       S1.sale,\n       CASE WHEN sale =\n            (SELECT sale\n             FROM Sales S2\n             WHERE S2.year = S1.year - 1) THEN '\u2192' --\u6a2a\u3070\u3044\n            WHEN sale >\n            (SELECT sale\n             FROM Sales S2\n             WHERE S2.year = S1.year - 1) THEN '\u2191' --\u6210\u9577\n            WHEN sale <\n            (SELECT sale\n             FROM Sales S2\n             WHERE S2.year = S1.year - 1) THEN '\u2193' --\u5f8c\u9000\n       ELSE '-' \n       END AS var\nFROM Sales S1\nORDER BY year\n;\n\n\n\u3010 SQL 2 \u3011\u300c\u81ea\u5df1\u7d50\u5408\u300d\u3092\u7528\u3044\u305f\u30af\u30a8\u30ea\n\nSQL\nSELECT S1.year,\n       S1.sales,\n       CASE WHEN S1.sales = S2.sale THEN '\u2192'\n            WHEN S1.sales > S2.sale THEN '\u2191'\n            WHEN S1.sales < S2.sale THEN '\u2193'\n      ELSE '-' \n      END AS var\nFROM Sales S1,\n     Sales S2\nWHERE S2.year = S1.year - 1\nORDER BY year\n;\n\n\n__(\u6ce8\uff09\u4e0a\u306e\u30af\u30a8\u30ea\u3067\u306f\u3001join\u53e5\u3092\u4f7f\u308f\u305a\u306b\u3001where\u53e5\u3067\u30c6\u30fc\u30d6\u30eb\u7d50\u5408\u5217\u3092\u6307\u5b9a\u3057\u3066\u3044\u308b_\n\n\n\u5168\u3066\u306f\u6642\u306e\u4e2d\u306b\u2026 (2007/10/17) \u300c\u3010Oracle\u3011\u8868\u7d50\u5408\u306e\u8a18\u8ff0\u65b9\u6cd5\u300d\n>\n> \u4ee5\u524d\u304b\u3089Oracle\u3092\u5229\u7528\u3057\u3066\u3044\u308b\u65b9\u304c\u4f5c\u6210\u3057\u305fSQL\u306e\u307b\u3068\u3093\u3069\u306f\u3001JOIN\u53e5\uff08INNER JOIN\u7b49\uff09\u3092\u4f7f\u308f\u305a\u306b\u8868\u7d50\u5408\u3092\u884c\u3063\u3066\u3044\u308b\u3002\n> \u305d\u306e\u65b9\u6cd5\u306f\u3001WHERE\u6761\u4ef6\u306b\u8868\u306e\u7d50\u5408\u6761\u4ef6\u3092\u8a18\u8ff0\u3059\u308b\u3053\u3068\u3067\u4ee3\u66ff\u3057\u3066\u3044\u308b\u3002\n>\uff08\u5143\u3005\u3001SQL\u306e\u6a19\u6e96\u898f\u683c\u3067\u3082\u3001WHERE\u53e5\u306b\u8868\u306e\u7d50\u5408\u6761\u4ef6\u3092\u8a18\u8ff0\u3067\u304d\u308b\u3068\u3055\u308c\u3066\u3044\u305f\u306e\u3067\u554f\u984c\u306f\u306a\u3044\u304c\u2026\uff09\n>\n> \u3053\u306e\u5834\u5408\u3001WHERE\u53e5\u306b\u6307\u5b9a\u3059\u308b\u7d50\u5408\u6761\u4ef6\u306b\u3088\u3063\u3066\u3001\u5185\u90e8\u7d50\u5408\u3068\u5916\u90e8\u7d50\u5408\u7b49\u3092\u4f7f\u3044\u5206\u3051\u3066\u3044\u308b\u3002\n\n\n\u53c2\u8003\u30c6\u30ad\u30b9\u30c8\u306b\u66f8\u304b\u308c\u305f\u4e0a\u8a18 \uff12\u3064\u306e\u30af\u30a8\u30ea\u306f\u3001\u4ee5\u4e0b\u306e\u30af\u30a8\u30ea\u3067\u3082\u540c\u3058\u7d50\u679c\u304c\u5f97\u3089\u308c\u307e\u3059\u3002\n\u3010 SQL 3 \u3011\u300cLAG()\u95a2\u6570\u300d\u3092\u7528\u3044\u305f\u30af\u30a8\u30ea\n\nSQL\nWith temp as (\n    SELECT year,\n           sales\n    FROM Sales\n), temp_2 as (\n    SELECT *, \n         LAG(sales, 1) OVER (ORDER BY year) as sales_1period_ago\n    FROM temp\n) SELECT year,\n         sales,\n         CASE WHEN sales = sales_1period_ago THEN '\u2192'\n              WHEN sales > sales_1period_ago THEN '\u2191'\n              WHEN sales < sales_1period_ago THEN '\u2193'\n         ELSE '-' END AS var\nFROM temp_2\nORDER BY year\n;\n\n\n\n\u3010 \u30af\u30a8\u30ea\u6bd4\u8f03\u8003\u5bdf \u3011\n\n\n\u81ea\u5df1\u7d50\u5408\u30af\u30a8\u30ea\u3092\u4f7f\u3046\u306e\u304c\u3001\u300c\u76f8\u95a2\u30b5\u30d6\u30af\u30a8\u30ea\u300d\u3092\u4f7f\u3046\u30af\u30a8\u30ea\u3088\u308a\u3082\u3001lag()\u95a2\u6570\u3092\u4f7f\u3046\u30af\u30a8\u30ea\u3088\u308a\u3082\u3001\u30af\u30a8\u30ea\u884c\u6570\u3082\u77ed\u304f\u3001\u53ef\u8aad\u6027\u3082\u4e00\u756a \u9ad8\u3044\n\n\n\u3010 \u53c2\u8003 \u3011\n\n\n\uff08 DB\u53c2\u7167\u5148\u306e\u30c6\u30fc\u30d6\u30eb\u304c\u65e5\u6b21\u3067\u3001\u683c\u7d0d\u6e08\u307f\u306e\u76f4\u8fd1\u30c7\u30fc\u30bf\u306f\u6628\u65e5\u306e\u65e5\u4ed8\u3067\u3001\u8907\u6570\u306e\u90e8\u7f72\u30c7\u30fc\u30bf\u304c\u683c\u7d0d\u3055\u308c\u3066\u3044\u308b\u5834\u5408 \uff09\n\n\u3010 SQL 2 \u3011\u300c\u81ea\u5df1\u7d50\u5408\u300d\u3092\u7528\u3044\u305f\u30af\u30a8\u30ea\n\nSQL\nSELECT S1.date,\n       S1.dept_id,\n       S1.sales,\n       CASE WHEN S1.sales = S2.sales THEN '\u2192'\n            WHEN S1.sales > S2.sales THEN '\u2191'\n            WHEN S1.sales < S2.sales THEN '\u2193'\n      ELSE '-' \n      END AS var\nFROM Sales AS S1, \n     Sales AS S2  \nGROUP BY S1.dept_id, S2.dept_id, S1.date, S2.date, S1.sales, S2.sales\nHAVING S1.dept_id = S2.dept_id\nAND S1.date = CURRENT_DATE + INTERVAL '-1 DAY'\nAND S2.date = CURRENT_DATE + INTERVAL '-2 DAY'\nORDER BY date, STORE_ID\n;\n\n\n\u3010 SQL 3 \u3011\u300cLAG()\u95a2\u6570\u300d\u3092\u7528\u3044\u305f\u30af\u30a8\u30ea\n\nSQL\nWith temp as (\n    SELECT date,\n           dept_id,\n           sales\n    FROM Sales\n    GROUP BY dept_id, date, sales\n), temp_2 as (\n    SELECT *, \n         LAG(sales, 1) OVER (PARTITION BY dept_id ORDER BY date) as sales_1period_ago\n    FROM temp\n) SELECT date,\n         dept_id,\n         sales,\n         CASE WHEN sales = sales_1period_ago THEN '\u2192'\n              WHEN sales > sales_1period_ago THEN '\u2191'\n              WHEN sales < sales_1period_ago THEN '\u2193'\n         ELSE '-' END AS var\nFROM temp_2\nORDER BY date, dept_id\n;\n\n\n\n\n\u3010 \u5b9f\u7528\u96c6\u8a08\u7de8 \u3011\n\n\u30c7\u30fc\u30bf\u304c\u683c\u7d0d\u3055\u308c\u3066\u3044\u308b \u524d\u65e5\u306e\u58f2\u4e0a \uff5e \u524d\u65e5\u304b\u3089\u898b\u30667\u65e5\u524d\u306e\u58f2\u308a\u4e0a\u3052 \u306e\u5404\u904e\u53bb\u65e5\u306e\u58f2\u4e0a\u3092\u3001\u90e8\u7f72\u3054\u3068\u306b\u96c6\u8a08\u3057\u3066\u3001_\n\u30c7\u30fc\u30bf\uff11\u30ec\u30b3\u30fc\u30c9\u3001\u3042\u308b\u8d77\u7b97\u65e5\u3067\u96c6\u8a08\u3057\u305f\u3042\u308b\u90e8\u7f72\u306e\u96c6\u8a08\u7d50\u679c\u3067\u3001\nvar\u5217\u306b\u306f\u3001\n\n7\u65e5\u9593 \u9023\u7d9a\u3057\u3066\u524d\u65e5\u6bd4 \u58f2\u308a\u4e0a\u3052\u5897\u306e\u90e8\u7f72\u306b\u306f\u3001var\u5217\u306b \u2191 \u3092\u3001\n7\u65e5\u9593\u9023\u7d9a \u524d\u671f\u6bd4\u6e1b\u306e\u90e8\u7f72\u306b\u306f\u2193\u3092\u3001\n7\u65e5\u9593\u3059\u3079\u3066\u540c\u3058\u3067\u6a2a\u3070\u3044\u306e\u90e8\u7f72\u306b\u306f\u3001\u2192\u3092\u3001\n\u305d\u306e\u307b\u304b\u306e\u90e8\u7f72\u306b\u306f\u3001- \u3092\n\n\u304c\u8868\u793a\u3055\u308c\u308b\u30af\u30a8\u30ea\n\nsql\nSELECT S1.DATE,\n       S1.DEPT_ID,\n       S1.SALES,       \n       S2.SALES AS sales_1_period_ago,\n       S3.SALES AS sales_2_period_ago,\n       S4.SALES AS sales_3_period_ago,\n       S5.SALES AS sales_4_period_ago,\n       S6.SALES AS sales_5_period_ago,\n       S7.SALES AS sales_6_period_ago,\n       S8.SALES AS sales_7_period_ago,\n       CASE WHEN (S1.SALES = S2.SALES) AND (S2.SALES = S3.SALES) AND (S3.SALES = S4.SALES)\n                 AND (S4.SALES = S5.SALES) AND (S5.SALES  = S6.SALES) AND (S6.SALES = S7.SALES) THEN '\u2192'\n            WHEN (S1.SALES > S2.SALES) AND (S2.SALES > S3.SALES) AND (S3.SALES > S4.SALES)\n                 AND (S4.SALES > S5.SALES) AND (S5.SALES > S6.SALES) AND (S6.SALES > S7.SALES) THEN '\u2191'\n            WHEN (S1.SALES < S2.SALES) AND (S2.SALES  < S3.SALES) AND (S3.SALES < S4.SALES)\n                 AND (S4.SALES < S5.SALES) AND (S5.SALES < S6.SALES) AND (S6.SALES < S7.SALES) THEN '\u2193'\n      ELSE '-' END AS var\nFROM SALES AS S1, \n     SALES AS S2,  \n     SALES AS S3,\n     SALES AS S4,\n     SALES AS S5,\n     SALES AS S6,\n     SALES AS S7,\n     SALES AS S8     \nGROUP BY S1.DEPT_ID, S2.DEPT_ID, S3.DEPT_ID, S4.DEPT_ID, S5.DEPT_ID, S6.DEPT_ID, S7.DEPT_ID, S8.DEPT_ID, \n         S1.DATE, S2.DATE, S3.DATE, S4.DATE, S5.DATE, S6.DATE, S7.DATE, S8.DATE,    \n         S1.SALES, S2.SALES, S3.SALES, S4.SALES, S5.SALES, S6.SALES, S7.SALES, S8.SALES\nHAVING S1.DEPT_ID = S2.DEPT_ID\nAND S1.DEPT_ID = S3.DEPT_ID\nAND S1.DEPT_ID = S4.DEPT_ID\nAND S1.DEPT_ID = S5.DEPT_ID\nAND S1.DEPT_ID = S6.DEPT_ID\nAND S1.DEPT_ID = S7.DEPT_ID\nAND S1.DEPT_ID = S8.DEPT_ID\nAND S1.DATE = CURRENT_DATE + INTERVAL '-1 DAY'\nAND S2.DATE = CURRENT_DATE + INTERVAL '-2 DAY'\nAND S3.DATE = CURRENT_DATE + INTERVAL '-3 DAY'\nAND S4.DATE = CURRENT_DATE + INTERVAL '-4 DAY'\nAND S5.DATE = CURRENT_DATE + INTERVAL '-5 DAY'\nAND S6.DATE = CURRENT_DATE + INTERVAL '-6 DAY'\nAND S7.DATE = CURRENT_DATE + INTERVAL '-7 DAY'\nAND S8.DATE = CURRENT_DATE + INTERVAL '-8 DAY'\nORDER BY var DESC\n;\n\n\n\nsql\nWith temp as (\n    SELECT DATE,\n           DEPT_ID,\n           SALES\n    FROM SALES\n    GROUP BY DEPT_ID, DATE, SALES\n), temp_2 as (\n    SELECT *, \n         LAG(SALES, 1) OVER (PARTITION BY DEPT_ID ORDER BY DATE) as sales_1_period_ago,\n         LAG(SALES, 2) OVER (PARTITION BY DEPT_ID ORDER BY DATE) as sales_2_period_ago,\n         LAG(SALES, 3) OVER (PARTITION BY DEPT_ID ORDER BY DATE) as sales_3_period_ago,\n         LAG(SALES, 4) OVER (PARTITION BY DEPT_ID ORDER BY DATE) as sales_4_period_ago,\n         LAG(SALES, 5) OVER (PARTITION BY DEPT_ID ORDER BY DATE) as sales_5_period_ago,\n         LAG(SALES, 6) OVER (PARTITION BY DEPT_ID ORDER BY DATE) as sales_6_period_ago,\n         LAG(SALES, 7) OVER (PARTITION BY DEPT_ID ORDER BY DATE) as sales_7_period_ago,\n         LAG(SALES, 8) OVER (PARTITION BY DEPT_ID ORDER BY DATE) as sales_8_period_ago       \n    FROM temp\n) SELECT *,\n         CASE WHEN (SALES = sales_1_period_ago) AND (sales_1_period_ago = sales_2_period_ago) AND (sales_2_period_ago = sales_3_period_ago) \n                 AND (sales_3_period_ago= sales_4_period_ago) AND (sales_4_period_ago = sales_5_period_ago) AND (sales_5_period_ago  = sales_6_period_ago) \n                 AND (sales_6_period_ago = sales_7_period_ago) AND (sales_7_period_ago = sales_8_period_ago) THEN '\u2192'\n              WHEN (SALES > sales_1_period_ago) AND (sales_1_period_ago > sales_2_period_ago) AND (sales_2_period_ago > sales_3_period_ago) \n                 AND (sales_3_period_ago > sales_4_period_ago) AND (sales_4_period_ago > sales_5_period_ago) AND (sales_5_period_ago  > sales_6_period_ago) \n                 AND (sales_6_period_ago > sales_7_period_ago) AND (sales_7_period_ago > sales_8_period_ago) THEN '\u2191'\n              WHEN (SALES < sales_1_period_ago) AND (sales_1_period_ago < sales_2_period_ago) AND (sales_2_period_ago < sales_3_period_ago) \n                 AND (sales_3_period_ago < sales_4_period_ago) AND (sales_4_period_ago < sales_5_period_ago) AND (sales_5_period_ago < sales_6_period_ago) \n                 AND (sales_6_period_ago < sales_7_period_ago) AND (sales_7_period_ago < sales_8_period_ago) THEN '\u2193'\n      ELSE '-' END AS var\nFROM temp_2\nWHERE DATE = CURRENT_DATE + INTERVAL '-1 DAY'\nORDER BY var desc\n;\n\n\n\n\n\u3010 \u76f4\u8fd17\u65e5\u9593\uff08\u8d77\u7b97\u65e5 SQL\u5b9f\u884c\u65e5\u306e\u524d\u65e5\uff09\u671f\u9593\u5185\u306e\u90e8\u7f72\u5225 \u58f2\u4e0a\u5897\u6e1b\u50be\u5411\u5225 \u8a72\u5f53\u90e8\u7f72\u6570 \u3092\u96c6\u8a08\u3059\u308b\u30af\u30a8\u30ea \u3011\n\n\n\uff08 \u8fd4\u308a\u5024 \uff09\n\n\nvar\u5217\uff1a\u2191 \u2192 \u2193 - \u306e\u3044\u305a\u308c\u304b\ndept_num\u5217\uff1a \u4e0a\u8a18 \u30d5\u30e9\u30b0\u5185\u5bb9\u5225 \u8a72\u5f53\u90e8\u7f72\u6570\n\n\n\nsql\nSELECT var,\n       count(distinct dept_id) as dept_num\nFROM (SELECT S1.DATE,\n             S1.DEPT_ID,\n             S1.SALES,     \n             S2.SALES AS sales_1_period_ago,\n             S3.SALES AS sales_2_period_ago,\n             S4.SALES AS sales_3_period_ago,\n             S5.SALES AS sales_4_period_ago,\n             S6.SALES AS sales_5_period_ago,\n             S7.SALES AS sales_6_period_ago,\n             S8.SALES AS sales_7_period_ago,\n             CASE WHEN (S1.SALES = S2.SALES) AND (S2.SALES = S3.SALES) AND (S3.SALES = S4.SALES)\n                       AND (S4.SALES = S5.SALES) AND (S5.SALES  = S6.SALES) AND (S6.SALES = S7.SALES) THEN '\u2192'\n                  WHEN (S1.SALES > S2.SALES) AND (S2.SALES > S3.SALES) AND (S3.SALES > S4.SALES)\n                       AND (S4.SALES > S5.SALES) AND (S5.SALES > S6.SALES) AND (S6.SALES > S7.SALES) THEN '\u2191'\n                  WHEN (S1.SALES < S2.SALES) AND (S2.SALES  < S3.SALES) AND (S3.SALES < S4.SALES)\n                       AND (S4.SALES < S5.SALES) AND (S5.SALES < S6.SALES) AND (S6.SALES < S7.SALES) THEN '\u2193'\n             ELSE '-' END AS var\n     FROM SALES AS S1, \n          SALES AS S2,  \n          SALES AS S3,\n          SALES AS S4,\n          SALES AS S5,\n          SALES AS S6,\n          SALES AS S7,\n          SALES AS S8    \n     GROUP BY S1.DEPT_ID, S2.DEPT_ID, S3.DEPT_ID, S4.DEPT_ID, S5.DEPT_ID, S6.DEPT_ID, S7.DEPT_ID, S8.DEPT_ID, \n              S1.DATE, S2.DATE, S3.DATE, S4.DATE, S5.DATE, S6.DATE, S7.DATE, S8.DATE,    \n              S1.SALES, S2.SALES, S3.SALES, S4.SALES, S5.SALES, S6.SALES, S7.SALES, S8.SALES\n     HAVING S1.DEPT_ID = S2.DEPT_ID\n            AND S1.DEPT_ID = S3.DEPT_ID\n            AND S1.DEPT_ID = S4.DEPT_ID\n            AND S1.DEPT_ID = S5.DEPT_ID\n            AND S1.DEPT_ID = S6.DEPT_ID\n            AND S1.DEPT_ID = S7.DEPT_ID\n            AND S1.DEPT_ID = S8.DEPT_ID\n            AND S1.DATE = CURRENT_DATE + INTERVAL '-1 DAY'\n            AND S2.DATE = CURRENT_DATE + INTERVAL '-2 DAY'\n            AND S3.DATE = CURRENT_DATE + INTERVAL '-3 DAY'\n            AND S4.DATE = CURRENT_DATE + INTERVAL '-4 DAY'\n            AND S5.DATE = CURRENT_DATE + INTERVAL '-5 DAY'\n            AND S6.DATE = CURRENT_DATE + INTERVAL '-6 DAY'\n            AND S7.DATE = CURRENT_DATE + INTERVAL '-7 DAY'\n            AND S8.DATE = CURRENT_DATE + INTERVAL '-8 DAY'\n            ORDER BY var DESC\n)\nGROUP BY var\n;\n\n\n\u4ee5\u4e0b\u3082\u540c\u3058\n\nsql\nWith temp AS (\nSELECT  S1.DATE,\n        S1.DEPT_ID,\n        S1.SALES,      \n        S2.SALES AS sales_1_period_ago,\n        S3.SALES AS sales_2_period_ago,\n        S4.SALES AS sales_3_period_ago,\n        S5.SALES AS sales_4_period_ago,\n        S6.SALES AS sales_5_period_ago,\n        S7.SALES AS sales_6_period_ago,\n        S8.SALES AS sales_7_period_ago,\n        CASE WHEN (S1.SALES = S2.SALES) AND (S2.SALES = S3.SALES) AND (S3.SALES = S4.SALES)\n                   AND (S4.SALES = S5.SALES) AND (S5.SALES  = S6.SALES) AND (S6.SALES = S7.SALES) THEN '\u2192'\n             WHEN (S1.SALES > S2.SALES) AND (S2.SALES > S3.SALES) AND (S3.SALES > S4.SALES)\n                   AND (S4.SALES > S5.SALES) AND (S5.SALES > S6.SALES) AND (S6.SALES > S7.SALES) THEN '\u2191'\n             WHEN (S1.SALES < S2.SALES) AND (S2.SALES  < S3.SALES) AND (S3.SALES < S4.SALES)\n                   AND (S4.SALES < S5.SALES) AND (S5.SALES < S6.SALES) AND (S6.SALES < S7.SALES) THEN '\u2193'\n         ELSE '-' END AS var\nFROM SALES AS S1, \n      SALES AS S2,  \n      SALES AS S3,\n      SALES AS S4,\n      SALES AS S5,\n      SALES AS S6,\n      SALES AS S7,\n      SALES AS S8    \nGROUP BY S1.DEPT_ID, S2.DEPT_ID, S3.DEPT_ID, S4.DEPT_ID, S5.DEPT_ID, S6.DEPT_ID, S7.DEPT_ID, S8.DEPT_ID, \n         S1.DATE, S2.DATE, S3.DATE, S4.DATE, S5.DATE, S6.DATE, S7.DATE, S8.DATE,    \n         S1.SALES, S2.SALES, S3.SALES, S4.SALES, S5.SALES, S6.SALES, S7.SALES, S8.SALES\nHAVING S1.DEPT_ID = S2.DEPT_ID\n        AND S1.DEPT_ID = S3.DEPT_ID\n        AND S1.DEPT_ID = S4.DEPT_ID\n        AND S1.DEPT_ID = S5.DEPT_ID\n        AND S1.DEPT_ID = S6.DEPT_ID\n        AND S1.DEPT_ID = S7.DEPT_ID\n        AND S1.DEPT_ID = S8.DEPT_ID\n        AND S1.DATE = CURRENT_DATE + INTERVAL '-1 DAY'\n        AND S2.DATE = CURRENT_DATE + INTERVAL '-2 DAY'\n        AND S3.DATE = CURRENT_DATE + INTERVAL '-3 DAY'\n        AND S4.DATE = CURRENT_DATE + INTERVAL '-4 DAY'\n        AND S5.DATE = CURRENT_DATE + INTERVAL '-5 DAY'\n        AND S6.DATE = CURRENT_DATE + INTERVAL '-6 DAY'\n        AND S7.DATE = CURRENT_DATE + INTERVAL '-7 DAY'\n        AND S8.DATE = CURRENT_DATE + INTERVAL '-8 DAY'\n        ORDER BY var DESC\n) SELECT var,\n         count(distinct dept_id) as dept_num\nFROM temp\nGROUP BY var\n;\n\n\n\u4ee5\u4e0b\u3082\u540c\u3058\n\nsql\nWith temp as (\n    SELECT DATE,\n           DEPT_ID,\n           SALES\n    FROM SALES\n    GROUP BY DEPT_ID, DATE, SALES\n), temp_2 as (\n    SELECT *, \n         LAG(SALES, 1) OVER (PARTITION BY DEPT_ID ORDER BY DATE) as sales_1_period_ago,\n         LAG(SALES, 2) OVER (PARTITION BY DEPT_ID ORDER BY DATE) as sales_2_period_ago,\n         LAG(SALES, 3) OVER (PARTITION BY DEPT_ID ORDER BY DATE) as sales_3_period_ago,\n         LAG(SALES, 4) OVER (PARTITION BY DEPT_ID ORDER BY DATE) as sales_4_period_ago,\n         LAG(SALES, 5) OVER (PARTITION BY DEPT_ID ORDER BY DATE) as sales_5_period_ago,\n         LAG(SALES, 6) OVER (PARTITION BY DEPT_ID ORDER BY DATE) as sales_6_period_ago,\n         LAG(SALES, 7) OVER (PARTITION BY DEPT_ID ORDER BY DATE) as sales_7_period_ago,\n         LAG(SALES, 8) OVER (PARTITION BY DEPT_ID ORDER BY DATE) as sales_8_period_ago       \n    FROM temp\n), temp_3 AS (\n SELECT *,\n         CASE WHEN (SALES = sales_1_period_ago) AND (sales_1_period_ago = sales_2_period_ago) AND (sales_2_period_ago = sales_3_period_ago) \n                 AND (sales_3_period_ago= sales_4_period_ago) AND (sales_4_period_ago = sales_5_period_ago) AND (sales_5_period_ago  = sales_6_period_ago) \n                 AND (sales_6_period_ago = sales_7_period_ago) AND (sales_7_period_ago = sales_8_period_ago) THEN '\u2192'\n              WHEN (SALES > sales_1_period_ago) AND (sales_1_period_ago > sales_2_period_ago) AND (sales_2_period_ago > sales_3_period_ago) \n                 AND (sales_3_period_ago > sales_4_period_ago) AND (sales_4_period_ago > sales_5_period_ago) AND (sales_5_period_ago  > sales_6_period_ago) \n                 AND (sales_6_period_ago > sales_7_period_ago) AND (sales_7_period_ago > sales_8_period_ago) THEN '\u2191'\n              WHEN (SALES < sales_1_period_ago) AND (sales_1_period_ago < sales_2_period_ago) AND (sales_2_period_ago < sales_3_period_ago) \n                 AND (sales_3_period_ago < sales_4_period_ago) AND (sales_4_period_ago < sales_5_period_ago) AND (sales_5_period_ago < sales_6_period_ago) \n                 AND (sales_6_period_ago < sales_7_period_ago) AND (sales_7_period_ago < sales_8_period_ago) THEN '\u2193'\n      ELSE '-' END AS var\nFROM temp_2\nWHERE DATE = CURRENT_DATE + INTERVAL '-1 DAY'\nORDER BY var desc\n) SELECT var,\n         count(distinct dept_id) as dept_num\nFROM temp_3\nGROUP BY var\n;\n\n\n\n\n### **\u30df\u30c3\u30af\uff08\u8457\uff09\u300e\u9054\u4eba\u306b\u5b66\u3076SQL\u5fb9\u5e95\u6307\u5357\u66f8 \u521d\u7d1a\u8005\u3067\u7d42\u308f\u308a\u305f\u304f\u306a\u3044\u3042\u306a\u305f\u3078\u300f\uff08SHOEISHA) _pp.104\uff5e110_** \u3067\u306f\u3001\u4ee5\u4e0b\uff12\u3064\u306e\u30af\u30a8\u30ea\u304c\u7b49\u4fa1\u3067\u3042\u308b\u3053\u3068\u304c\u8aac\u660e\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n\n\n__\u3010 SQL 1 \u3011\u300c\u76f8\u95a2\u30b5\u30d6\u30af\u30a8\u30ea\u300d\u3092\u7528\u3044\u305f\u30af\u30a8\u30ea__\n\n```{SQL:SQL}\nSELECT S1.year,\n       S1.sale,\n       CASE WHEN sale =\n            (SELECT sale\n             FROM Sales S2\n             WHERE S2.year = S1.year - 1) THEN '\u2192' --\u6a2a\u3070\u3044\n            WHEN sale >\n            (SELECT sale\n             FROM Sales S2\n             WHERE S2.year = S1.year - 1) THEN '\u2191' --\u6210\u9577\n            WHEN sale <\n            (SELECT sale\n             FROM Sales S2\n             WHERE S2.year = S1.year - 1) THEN '\u2193' --\u5f8c\u9000\n       ELSE '-' \n       END AS var\nFROM Sales S1\nORDER BY year\n;\n```\n\n__\u3010 SQL 2 \u3011\u300c\u81ea\u5df1\u7d50\u5408\u300d\u3092\u7528\u3044\u305f\u30af\u30a8\u30ea__\n\n```{SQL:SQL}\nSELECT S1.year,\n       S1.sales,\n       CASE WHEN S1.sales = S2.sale THEN '\u2192'\n            WHEN S1.sales > S2.sale THEN '\u2191'\n            WHEN S1.sales < S2.sale THEN '\u2193'\n      ELSE '-' \n      END AS var\nFROM Sales S1,\n     Sales S2\nWHERE S2.year = S1.year - 1\nORDER BY year\n;\n```\n\n___(\u6ce8\uff09\u4e0a\u306e\u30af\u30a8\u30ea\u3067\u306f\u3001join\u53e5\u3092\u4f7f\u308f\u305a\u306b\u3001where\u53e5\u3067\u30c6\u30fc\u30d6\u30eb\u7d50\u5408\u5217\u3092\u6307\u5b9a\u3057\u3066\u3044\u308b__\n\n* [\u5168\u3066\u306f\u6642\u306e\u4e2d\u306b\u2026 (2007/10/17) \u300c\u3010Oracle\u3011\u8868\u7d50\u5408\u306e\u8a18\u8ff0\u65b9\u6cd5\u300d](http://blog.livedoor.jp/akf0/archives/51132806.html)\n>\n> \u4ee5\u524d\u304b\u3089Oracle\u3092\u5229\u7528\u3057\u3066\u3044\u308b\u65b9\u304c\u4f5c\u6210\u3057\u305fSQL\u306e\u307b\u3068\u3093\u3069\u306f\u3001JOIN\u53e5\uff08INNER JOIN\u7b49\uff09\u3092\u4f7f\u308f\u305a\u306b\u8868\u7d50\u5408\u3092\u884c\u3063\u3066\u3044\u308b\u3002\n> \u305d\u306e\u65b9\u6cd5\u306f\u3001WHERE\u6761\u4ef6\u306b\u8868\u306e\u7d50\u5408\u6761\u4ef6\u3092\u8a18\u8ff0\u3059\u308b\u3053\u3068\u3067\u4ee3\u66ff\u3057\u3066\u3044\u308b\u3002\n>\uff08\u5143\u3005\u3001SQL\u306e\u6a19\u6e96\u898f\u683c\u3067\u3082\u3001WHERE\u53e5\u306b\u8868\u306e\u7d50\u5408\u6761\u4ef6\u3092\u8a18\u8ff0\u3067\u304d\u308b\u3068\u3055\u308c\u3066\u3044\u305f\u306e\u3067\u554f\u984c\u306f\u306a\u3044\u304c\u2026\uff09\n>\n> \u3053\u306e\u5834\u5408\u3001WHERE\u53e5\u306b\u6307\u5b9a\u3059\u308b\u7d50\u5408\u6761\u4ef6\u306b\u3088\u3063\u3066\u3001\u5185\u90e8\u7d50\u5408\u3068\u5916\u90e8\u7d50\u5408\u7b49\u3092\u4f7f\u3044\u5206\u3051\u3066\u3044\u308b\u3002\n\n\n#### \u53c2\u8003\u30c6\u30ad\u30b9\u30c8\u306b\u66f8\u304b\u308c\u305f\u4e0a\u8a18 \uff12\u3064\u306e\u30af\u30a8\u30ea\u306f\u3001\u4ee5\u4e0b\u306e\u30af\u30a8\u30ea\u3067\u3082\u540c\u3058\u7d50\u679c\u304c\u5f97\u3089\u308c\u307e\u3059\u3002\n\n__\u3010 SQL 3 \u3011\u300cLAG()\u95a2\u6570\u300d\u3092\u7528\u3044\u305f\u30af\u30a8\u30ea__\n\n```{SQL:SQL}\nWith temp as (\n\tSELECT year,\n\t\t   sales\n    FROM Sales\n), temp_2 as (\n\tSELECT *, \n \t\t LAG(sales, 1) OVER (ORDER BY year) as sales_1period_ago\n    FROM temp\n) SELECT year,\n\t\t sales,\n         CASE WHEN sales = sales_1period_ago THEN '\u2192'\n              WHEN sales > sales_1period_ago THEN '\u2191'\n              WHEN sales < sales_1period_ago THEN '\u2193'\n         ELSE '-' END AS var\nFROM temp_2\nORDER BY year\n;\n```\n\n## __\u3010 \u30af\u30a8\u30ea\u6bd4\u8f03\u8003\u5bdf \u3011__\n\n### \u81ea\u5df1\u7d50\u5408\u30af\u30a8\u30ea\u3092\u4f7f\u3046\u306e\u304c\u3001\u300c\u76f8\u95a2\u30b5\u30d6\u30af\u30a8\u30ea\u300d\u3092\u4f7f\u3046\u30af\u30a8\u30ea\u3088\u308a\u3082\u3001lag()\u95a2\u6570\u3092\u4f7f\u3046\u30af\u30a8\u30ea\u3088\u308a\u3082\u3001\u30af\u30a8\u30ea\u884c\u6570\u3082\u77ed\u304f\u3001\u53ef\u8aad\u6027\u3082\u4e00\u756a \u9ad8\u3044\n\n___\n\n\n## __\u3010 \u53c2\u8003 \u3011__\n\n#### __\uff08 DB\u53c2\u7167\u5148\u306e\u30c6\u30fc\u30d6\u30eb\u304c\u65e5\u6b21\u3067\u3001\u683c\u7d0d\u6e08\u307f\u306e\u76f4\u8fd1\u30c7\u30fc\u30bf\u306f\u6628\u65e5\u306e\u65e5\u4ed8\u3067\u3001\u8907\u6570\u306e\u90e8\u7f72\u30c7\u30fc\u30bf\u304c\u683c\u7d0d\u3055\u308c\u3066\u3044\u308b\u5834\u5408 \uff09__\n\n\n__\u3010 SQL 2 \u3011\u300c\u81ea\u5df1\u7d50\u5408\u300d\u3092\u7528\u3044\u305f\u30af\u30a8\u30ea__\n\n```{SQL:SQL}\nSELECT S1.date,\n       S1.dept_id,\n       S1.sales,\n       CASE WHEN S1.sales = S2.sales THEN '\u2192'\n            WHEN S1.sales > S2.sales THEN '\u2191'\n            WHEN S1.sales < S2.sales THEN '\u2193'\n      ELSE '-' \n      END AS var\nFROM Sales AS S1, \n     Sales AS S2  \nGROUP BY S1.dept_id, S2.dept_id, S1.date, S2.date, S1.sales, S2.sales\nHAVING S1.dept_id = S2.dept_id\nAND S1.date = CURRENT_DATE + INTERVAL '-1 DAY'\nAND S2.date = CURRENT_DATE + INTERVAL '-2 DAY'\nORDER BY date, STORE_ID\n;\n```\n\n__\u3010 SQL 3 \u3011\u300cLAG()\u95a2\u6570\u300d\u3092\u7528\u3044\u305f\u30af\u30a8\u30ea__\n\n\n```{SQL:SQL}\nWith temp as (\n\tSELECT date,\n    \t   dept_id,\n\t\t   sales\n    FROM Sales\n\tGROUP BY dept_id, date, sales\n), temp_2 as (\n\tSELECT *, \n \t\t LAG(sales, 1) OVER (PARTITION BY dept_id ORDER BY date) as sales_1period_ago\n    FROM temp\n) SELECT date,\n    \t dept_id,\n\t\t sales,\n         CASE WHEN sales = sales_1period_ago THEN '\u2192'\n              WHEN sales > sales_1period_ago THEN '\u2191'\n              WHEN sales < sales_1period_ago THEN '\u2193'\n         ELSE '-' END AS var\nFROM temp_2\nORDER BY date, dept_id\n;\n```\n\n___\n\n\n## __\u3010 \u5b9f\u7528\u96c6\u8a08\u7de8 \u3011__\n\n__\u30c7\u30fc\u30bf\u304c\u683c\u7d0d\u3055\u308c\u3066\u3044\u308b \u524d\u65e5\u306e\u58f2\u4e0a \uff5e \u524d\u65e5\u304b\u3089\u898b\u30667\u65e5\u524d\u306e\u58f2\u308a\u4e0a\u3052 \u306e\u5404\u904e\u53bb\u65e5\u306e\u58f2\u4e0a\u3092\u3001\u90e8\u7f72\u3054\u3068\u306b\u96c6\u8a08\u3057\u3066\u3001___\n__\u30c7\u30fc\u30bf\uff11\u30ec\u30b3\u30fc\u30c9\u3001\u3042\u308b\u8d77\u7b97\u65e5\u3067\u96c6\u8a08\u3057\u305f\u3042\u308b\u90e8\u7f72\u306e\u96c6\u8a08\u7d50\u679c\u3067\u3001__\n__var\u5217\u306b\u306f\u3001__\n\n* 7\u65e5\u9593 \u9023\u7d9a\u3057\u3066\u524d\u65e5\u6bd4 \u58f2\u308a\u4e0a\u3052\u5897\u306e\u90e8\u7f72\u306b\u306f\u3001var\u5217\u306b \u2191 \u3092\u3001\n* 7\u65e5\u9593\u9023\u7d9a \u524d\u671f\u6bd4\u6e1b\u306e\u90e8\u7f72\u306b\u306f\u2193\u3092\u3001\n* 7\u65e5\u9593\u3059\u3079\u3066\u540c\u3058\u3067\u6a2a\u3070\u3044\u306e\u90e8\u7f72\u306b\u306f\u3001\u2192\u3092\u3001\n* \u305d\u306e\u307b\u304b\u306e\u90e8\u7f72\u306b\u306f\u3001- \u3092\n\n__\u304c\u8868\u793a\u3055\u308c\u308b\u30af\u30a8\u30ea__\n\n\n```{sql:sql}\nSELECT S1.DATE,\n       S1.DEPT_ID,\n       S1.SALES,\t   \n\t   S2.SALES AS sales_1_period_ago,\n\t   S3.SALES AS sales_2_period_ago,\n\t   S4.SALES AS sales_3_period_ago,\n\t   S5.SALES AS sales_4_period_ago,\n\t   S6.SALES AS sales_5_period_ago,\n\t   S7.SALES AS sales_6_period_ago,\n\t   S8.SALES AS sales_7_period_ago,\n       CASE WHEN (S1.SALES = S2.SALES) AND (S2.SALES = S3.SALES) AND (S3.SALES = S4.SALES)\n\t             AND (S4.SALES = S5.SALES) AND (S5.SALES  = S6.SALES) AND (S6.SALES = S7.SALES) THEN '\u2192'\n            WHEN (S1.SALES > S2.SALES) AND (S2.SALES > S3.SALES) AND (S3.SALES > S4.SALES)\n\t\t\t     AND (S4.SALES > S5.SALES) AND (S5.SALES > S6.SALES) AND (S6.SALES > S7.SALES) THEN '\u2191'\n            WHEN (S1.SALES < S2.SALES) AND (S2.SALES  < S3.SALES) AND (S3.SALES < S4.SALES)\n\t\t\t     AND (S4.SALES < S5.SALES) AND (S5.SALES < S6.SALES) AND (S6.SALES < S7.SALES) THEN '\u2193'\n      ELSE '-' END AS var\nFROM SALES AS S1, \n     SALES AS S2,  \n\t SALES AS S3,\n\t SALES AS S4,\n\t SALES AS S5,\n\t SALES AS S6,\n\t SALES AS S7,\n\t SALES AS S8\t \nGROUP BY S1.DEPT_ID, S2.DEPT_ID, S3.DEPT_ID, S4.DEPT_ID, S5.DEPT_ID, S6.DEPT_ID, S7.DEPT_ID, S8.DEPT_ID, \n         S1.DATE, S2.DATE, S3.DATE, S4.DATE, S5.DATE, S6.DATE, S7.DATE, S8.DATE,    \n\t\t S1.SALES, S2.SALES, S3.SALES, S4.SALES, S5.SALES, S6.SALES, S7.SALES, S8.SALES\nHAVING S1.DEPT_ID = S2.DEPT_ID\nAND S1.DEPT_ID = S3.DEPT_ID\nAND S1.DEPT_ID = S4.DEPT_ID\nAND S1.DEPT_ID = S5.DEPT_ID\nAND S1.DEPT_ID = S6.DEPT_ID\nAND S1.DEPT_ID = S7.DEPT_ID\nAND S1.DEPT_ID = S8.DEPT_ID\nAND S1.DATE = CURRENT_DATE + INTERVAL '-1 DAY'\nAND S2.DATE = CURRENT_DATE + INTERVAL '-2 DAY'\nAND S3.DATE = CURRENT_DATE + INTERVAL '-3 DAY'\nAND S4.DATE = CURRENT_DATE + INTERVAL '-4 DAY'\nAND S5.DATE = CURRENT_DATE + INTERVAL '-5 DAY'\nAND S6.DATE = CURRENT_DATE + INTERVAL '-6 DAY'\nAND S7.DATE = CURRENT_DATE + INTERVAL '-7 DAY'\nAND S8.DATE = CURRENT_DATE + INTERVAL '-8 DAY'\nORDER BY var DESC\n;\n```\n\n```{sql:sql}\nWith temp as (\n\tSELECT DATE,\n    \t   DEPT_ID,\n\t\t   SALES\n    FROM SALES\n\tGROUP BY DEPT_ID, DATE, SALES\n), temp_2 as (\n\tSELECT *, \n \t\t LAG(SALES, 1) OVER (PARTITION BY DEPT_ID ORDER BY DATE) as sales_1_period_ago,\n\t\t LAG(SALES, 2) OVER (PARTITION BY DEPT_ID ORDER BY DATE) as sales_2_period_ago,\n\t\t LAG(SALES, 3) OVER (PARTITION BY DEPT_ID ORDER BY DATE) as sales_3_period_ago,\n\t\t LAG(SALES, 4) OVER (PARTITION BY DEPT_ID ORDER BY DATE) as sales_4_period_ago,\n\t\t LAG(SALES, 5) OVER (PARTITION BY DEPT_ID ORDER BY DATE) as sales_5_period_ago,\n\t\t LAG(SALES, 6) OVER (PARTITION BY DEPT_ID ORDER BY DATE) as sales_6_period_ago,\n\t\t LAG(SALES, 7) OVER (PARTITION BY DEPT_ID ORDER BY DATE) as sales_7_period_ago,\n\t\t LAG(SALES, 8) OVER (PARTITION BY DEPT_ID ORDER BY DATE) as sales_8_period_ago\t\t \n    FROM temp\n) SELECT *,\n         CASE WHEN (SALES = sales_1_period_ago) AND (sales_1_period_ago = sales_2_period_ago) AND (sales_2_period_ago = sales_3_period_ago) \n\t\t         AND (sales_3_period_ago= sales_4_period_ago) AND (sales_4_period_ago = sales_5_period_ago) AND (sales_5_period_ago  = sales_6_period_ago) \n\t\t\t\t AND (sales_6_period_ago = sales_7_period_ago) AND (sales_7_period_ago = sales_8_period_ago) THEN '\u2192'\n              WHEN (SALES > sales_1_period_ago) AND (sales_1_period_ago > sales_2_period_ago) AND (sales_2_period_ago > sales_3_period_ago) \n\t\t\t     AND (sales_3_period_ago > sales_4_period_ago) AND (sales_4_period_ago > sales_5_period_ago) AND (sales_5_period_ago  > sales_6_period_ago) \n\t\t\t\t AND (sales_6_period_ago > sales_7_period_ago) AND (sales_7_period_ago > sales_8_period_ago) THEN '\u2191'\n              WHEN (SALES < sales_1_period_ago) AND (sales_1_period_ago < sales_2_period_ago) AND (sales_2_period_ago < sales_3_period_ago) \n\t\t\t     AND (sales_3_period_ago < sales_4_period_ago) AND (sales_4_period_ago < sales_5_period_ago) AND (sales_5_period_ago < sales_6_period_ago) \n\t\t\t\t AND (sales_6_period_ago < sales_7_period_ago) AND (sales_7_period_ago < sales_8_period_ago) THEN '\u2193'\n      ELSE '-' END AS var\nFROM temp_2\nWHERE DATE = CURRENT_DATE + INTERVAL '-1 DAY'\nORDER BY var desc\n;\n```\n\n___\n\n#### __\u3010 \u76f4\u8fd17\u65e5\u9593\uff08\u8d77\u7b97\u65e5 SQL\u5b9f\u884c\u65e5\u306e\u524d\u65e5\uff09\u671f\u9593\u5185\u306e\u90e8\u7f72\u5225 \u58f2\u4e0a\u5897\u6e1b\u50be\u5411\u5225 \u8a72\u5f53\u90e8\u7f72\u6570 \u3092\u96c6\u8a08\u3059\u308b\u30af\u30a8\u30ea \u3011__\n\n##### __\uff08 \u8fd4\u308a\u5024 \uff09__\n\n* var\u5217\uff1a\u2191 \u2192 \u2193 - \u306e\u3044\u305a\u308c\u304b\n* dept_num\u5217\uff1a \u4e0a\u8a18 \u30d5\u30e9\u30b0\u5185\u5bb9\u5225 \u8a72\u5f53\u90e8\u7f72\u6570\n\n___\n\n\n```{sql:sql}\nSELECT var,\n       count(distinct dept_id) as dept_num\nFROM (SELECT S1.DATE,\n      \t\t S1.DEPT_ID,\n       \t\t S1.SALES,\t   \n\t   \t\t S2.SALES AS sales_1_period_ago,\n\t   \t\t S3.SALES AS sales_2_period_ago,\n\t   \t\t S4.SALES AS sales_3_period_ago,\n\t   \t\t S5.SALES AS sales_4_period_ago,\n\t   \t\t S6.SALES AS sales_5_period_ago,\n\t   \t\t S7.SALES AS sales_6_period_ago,\n\t   \t\t S8.SALES AS sales_7_period_ago,\n       \t\t CASE WHEN (S1.SALES = S2.SALES) AND (S2.SALES = S3.SALES) AND (S3.SALES = S4.SALES)\n\t         \t       AND (S4.SALES = S5.SALES) AND (S5.SALES  = S6.SALES) AND (S6.SALES = S7.SALES) THEN '\u2192'\n            \t  WHEN (S1.SALES > S2.SALES) AND (S2.SALES > S3.SALES) AND (S3.SALES > S4.SALES)\n\t\t\t     \t   AND (S4.SALES > S5.SALES) AND (S5.SALES > S6.SALES) AND (S6.SALES > S7.SALES) THEN '\u2191'\n            \t  WHEN (S1.SALES < S2.SALES) AND (S2.SALES  < S3.SALES) AND (S3.SALES < S4.SALES)\n\t\t\t           AND (S4.SALES < S5.SALES) AND (S5.SALES < S6.SALES) AND (S6.SALES < S7.SALES) THEN '\u2193'\n      \t\t ELSE '-' END AS var\n\t FROM SALES AS S1, \n     \t  SALES AS S2,  \n\t \t  SALES AS S3,\n\t \t  SALES AS S4,\n\t \t  SALES AS S5,\n\t \t  SALES AS S6,\n\t \t  SALES AS S7,\n\t \t  SALES AS S8\t \n\t GROUP BY S1.DEPT_ID, S2.DEPT_ID, S3.DEPT_ID, S4.DEPT_ID, S5.DEPT_ID, S6.DEPT_ID, S7.DEPT_ID, S8.DEPT_ID, \n              S1.DATE, S2.DATE, S3.DATE, S4.DATE, S5.DATE, S6.DATE, S7.DATE, S8.DATE,    \n\t\t      S1.SALES, S2.SALES, S3.SALES, S4.SALES, S5.SALES, S6.SALES, S7.SALES, S8.SALES\n\t HAVING S1.DEPT_ID = S2.DEPT_ID\n\t\t    AND S1.DEPT_ID = S3.DEPT_ID\n\t     \tAND S1.DEPT_ID = S4.DEPT_ID\n\t\t\tAND S1.DEPT_ID = S5.DEPT_ID\n\t\t\tAND S1.DEPT_ID = S6.DEPT_ID\n\t\t\tAND S1.DEPT_ID = S7.DEPT_ID\n\t\t\tAND S1.DEPT_ID = S8.DEPT_ID\n\t\t\tAND S1.DATE = CURRENT_DATE + INTERVAL '-1 DAY'\n\t\t\tAND S2.DATE = CURRENT_DATE + INTERVAL '-2 DAY'\n\t\t\tAND S3.DATE = CURRENT_DATE + INTERVAL '-3 DAY'\n\t\t\tAND S4.DATE = CURRENT_DATE + INTERVAL '-4 DAY'\n\t\t\tAND S5.DATE = CURRENT_DATE + INTERVAL '-5 DAY'\n\t\t\tAND S6.DATE = CURRENT_DATE + INTERVAL '-6 DAY'\n\t\t\tAND S7.DATE = CURRENT_DATE + INTERVAL '-7 DAY'\n\t\t\tAND S8.DATE = CURRENT_DATE + INTERVAL '-8 DAY'\n\t\t\tORDER BY var DESC\n)\nGROUP BY var\n;\n```\n\n__\u4ee5\u4e0b\u3082\u540c\u3058__\n\n\n```{sql:sql}\nWith temp AS (\nSELECT  S1.DATE,\n        S1.DEPT_ID,\n        S1.SALES,\t   \n\t    S2.SALES AS sales_1_period_ago,\n\t    S3.SALES AS sales_2_period_ago,\n\t    S4.SALES AS sales_3_period_ago,\n\t    S5.SALES AS sales_4_period_ago,\n\t    S6.SALES AS sales_5_period_ago,\n\t    S7.SALES AS sales_6_period_ago,\n\t    S8.SALES AS sales_7_period_ago,\n        CASE WHEN (S1.SALES = S2.SALES) AND (S2.SALES = S3.SALES) AND (S3.SALES = S4.SALES)\n\t       \t       AND (S4.SALES = S5.SALES) AND (S5.SALES  = S6.SALES) AND (S6.SALES = S7.SALES) THEN '\u2192'\n             WHEN (S1.SALES > S2.SALES) AND (S2.SALES > S3.SALES) AND (S3.SALES > S4.SALES)\n\t\t\t   \t   AND (S4.SALES > S5.SALES) AND (S5.SALES > S6.SALES) AND (S6.SALES > S7.SALES) THEN '\u2191'\n             WHEN (S1.SALES < S2.SALES) AND (S2.SALES  < S3.SALES) AND (S3.SALES < S4.SALES)\n\t\t\t       AND (S4.SALES < S5.SALES) AND (S5.SALES < S6.SALES) AND (S6.SALES < S7.SALES) THEN '\u2193'\n      \t ELSE '-' END AS var\nFROM SALES AS S1, \n   \t  SALES AS S2,  \n\t  SALES AS S3,\n \t  SALES AS S4,\n \t  SALES AS S5,\n \t  SALES AS S6,\n \t  SALES AS S7,\n \t  SALES AS S8\t \nGROUP BY S1.DEPT_ID, S2.DEPT_ID, S3.DEPT_ID, S4.DEPT_ID, S5.DEPT_ID, S6.DEPT_ID, S7.DEPT_ID, S8.DEPT_ID, \n         S1.DATE, S2.DATE, S3.DATE, S4.DATE, S5.DATE, S6.DATE, S7.DATE, S8.DATE,    \n         S1.SALES, S2.SALES, S3.SALES, S4.SALES, S5.SALES, S6.SALES, S7.SALES, S8.SALES\nHAVING S1.DEPT_ID = S2.DEPT_ID\n\t    AND S1.DEPT_ID = S3.DEPT_ID\n     \tAND S1.DEPT_ID = S4.DEPT_ID\n\t\tAND S1.DEPT_ID = S5.DEPT_ID\n\t\tAND S1.DEPT_ID = S6.DEPT_ID\n\t\tAND S1.DEPT_ID = S7.DEPT_ID\n\t\tAND S1.DEPT_ID = S8.DEPT_ID\n\t\tAND S1.DATE = CURRENT_DATE + INTERVAL '-1 DAY'\n\t\tAND S2.DATE = CURRENT_DATE + INTERVAL '-2 DAY'\n\t\tAND S3.DATE = CURRENT_DATE + INTERVAL '-3 DAY'\n\t\tAND S4.DATE = CURRENT_DATE + INTERVAL '-4 DAY'\n\t\tAND S5.DATE = CURRENT_DATE + INTERVAL '-5 DAY'\n\t\tAND S6.DATE = CURRENT_DATE + INTERVAL '-6 DAY'\n\t\tAND S7.DATE = CURRENT_DATE + INTERVAL '-7 DAY'\n\t\tAND S8.DATE = CURRENT_DATE + INTERVAL '-8 DAY'\n\t\tORDER BY var DESC\n) SELECT var,\n         count(distinct dept_id) as dept_num\nFROM temp\nGROUP BY var\n;\n```\n\n__\u4ee5\u4e0b\u3082\u540c\u3058__\n\n\n\n```{sql:sql}\nWith temp as (\n\tSELECT DATE,\n    \t   DEPT_ID,\n\t\t   SALES\n    FROM SALES\n\tGROUP BY DEPT_ID, DATE, SALES\n), temp_2 as (\n\tSELECT *, \n \t\t LAG(SALES, 1) OVER (PARTITION BY DEPT_ID ORDER BY DATE) as sales_1_period_ago,\n\t\t LAG(SALES, 2) OVER (PARTITION BY DEPT_ID ORDER BY DATE) as sales_2_period_ago,\n\t\t LAG(SALES, 3) OVER (PARTITION BY DEPT_ID ORDER BY DATE) as sales_3_period_ago,\n\t\t LAG(SALES, 4) OVER (PARTITION BY DEPT_ID ORDER BY DATE) as sales_4_period_ago,\n\t\t LAG(SALES, 5) OVER (PARTITION BY DEPT_ID ORDER BY DATE) as sales_5_period_ago,\n\t\t LAG(SALES, 6) OVER (PARTITION BY DEPT_ID ORDER BY DATE) as sales_6_period_ago,\n\t\t LAG(SALES, 7) OVER (PARTITION BY DEPT_ID ORDER BY DATE) as sales_7_period_ago,\n\t\t LAG(SALES, 8) OVER (PARTITION BY DEPT_ID ORDER BY DATE) as sales_8_period_ago\t\t \n    FROM temp\n), temp_3 AS (\n SELECT *,\n         CASE WHEN (SALES = sales_1_period_ago) AND (sales_1_period_ago = sales_2_period_ago) AND (sales_2_period_ago = sales_3_period_ago) \n\t\t         AND (sales_3_period_ago= sales_4_period_ago) AND (sales_4_period_ago = sales_5_period_ago) AND (sales_5_period_ago  = sales_6_period_ago) \n\t\t\t\t AND (sales_6_period_ago = sales_7_period_ago) AND (sales_7_period_ago = sales_8_period_ago) THEN '\u2192'\n              WHEN (SALES > sales_1_period_ago) AND (sales_1_period_ago > sales_2_period_ago) AND (sales_2_period_ago > sales_3_period_ago) \n\t\t\t     AND (sales_3_period_ago > sales_4_period_ago) AND (sales_4_period_ago > sales_5_period_ago) AND (sales_5_period_ago  > sales_6_period_ago) \n\t\t\t\t AND (sales_6_period_ago > sales_7_period_ago) AND (sales_7_period_ago > sales_8_period_ago) THEN '\u2191'\n              WHEN (SALES < sales_1_period_ago) AND (sales_1_period_ago < sales_2_period_ago) AND (sales_2_period_ago < sales_3_period_ago) \n\t\t\t     AND (sales_3_period_ago < sales_4_period_ago) AND (sales_4_period_ago < sales_5_period_ago) AND (sales_5_period_ago < sales_6_period_ago) \n\t\t\t\t AND (sales_6_period_ago < sales_7_period_ago) AND (sales_7_period_ago < sales_8_period_ago) THEN '\u2193'\n      ELSE '-' END AS var\nFROM temp_2\nWHERE DATE = CURRENT_DATE + INTERVAL '-1 DAY'\nORDER BY var desc\n) SELECT var,\n         count(distinct dept_id) as dept_num\nFROM temp_3\nGROUP BY var\n;\n```\n\n"}