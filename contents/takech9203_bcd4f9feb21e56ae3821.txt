{"tags": ["riak"], "context": " More than 1 year has passed since last update.\n\nRiak\u3068\u306f\n\nKey-Value Store\u306eNoSQL\u5206\u6563\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\nAWS\u306eDynamoDB\u8ad6\u6587\u3092\u30d9\u30fc\u30b9\u306b\u8a2d\u8a08\u3055\u308c\u305f\n\u30de\u30b9\u30bf\u30fc\u30ec\u30b9\u69cb\u6210\u3067\u53ef\u7528\u6027\u30fb\u8010\u969c\u5bb3\u6027\u304c\u975e\u5e38\u306b\u9ad8\u3044\u3002\u4e00\u8cab\u6027\u306fEventually Consistency\n\nerlang/otp\u3092\u5206\u6563\u30b7\u30b9\u30c6\u30e0\u306e\u30d9\u30fc\u30b9\u306b\u3057\u3066\u3044\u308b\n\n\u8aac\u660e\u306f\u3044\u308d\u3093\u306a\u30b5\u30a4\u30c8\u306b\u3042\u308b\u306e\u3067\u8a73\u7d30\u306f\u305d\u3061\u3089\u3092\u3002\n\nbasho/riak\nRiak\n\nRiak Compared to DynamoDB DynamoDB\u3068\u306e\u6bd4\u8f03\n\u904b\u7528\u304c\u697d\u306b\u306a\u308b\u5206\u6563\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9 Riak\n\u96f2\u306b\u306a\u3063\u305f\u30b3\u30f3\u30d4\u30e5\u30fc\u30bf: Basho\u306eRiak\u3068\u306f\u4f55\u304b\uff1f\uff0dSDS\uff17\uff0d\nRiak\u306f\u306a\u305c\u826f\u3044\u306e\u304b\n\n\n\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\nAmazon Linux\u74b0\u5883\u306b\u3001\u8a18\u8f09\u6642\u70b9\u3067\u6700\u65b0\u306eRiak 2.1.1\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u3066\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u3057\u3066\u307f\u308b Downloads\n\u4ee5\u4e0b\u30b5\u30a4\u30c8\u3092\u53c2\u8003\n\nRiak2.0.0pre\u3092\u3064\u304b\u3063\u3066\u307f\u305f - Qiita\n\n\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n$ sudo yum install http://s3.amazonaws.com/downloads.basho.com/riak/2.1/2.1.1/rhel/6/riak-2.1.1-1.el6.x86_64.rpm\n\n\n\u8a3c\u660e\u66f8\u306e\u4f5c\u6210\nWeb\u30d9\u30fc\u30b9\u306e\u7ba1\u7406\u30b3\u30f3\u30bd\u30fc\u30eb(Admin Panel)\u3092HTTPS\u3067\u4f7f\u3046\u305f\u3081\u306b\u8a3c\u660e\u66f8\u304c\u5fc5\u8981\u306a\u306e\u3067\u4f5c\u6210\u3057\u3066\u304a\u304f\u3002\n$ openssl genrsa -aes128 -out key.pem 1024 \n$ openssl req -new -key key.pem -out cert.csr\n$ mv key.pem key.pem.org\n$ openssl rsa -in key.pem.org -out key.pem   #\u3000\u79d8\u5bc6\u9375\u304b\u3089\u30d1\u30b9\u30d5\u30ec\u30fc\u30ba\u3092\u524a\u9664\n$ openssl x509 -req -days 365 -in cert.csr -signkey key.pem -out cert.pem\n$ sudo cp key.pem cert.pem /etc/riak/\n\n\n\u8a2d\u5b9a\n\nriak.conf\n\u4ee5\u4e0b\u306e\u8a2d\u5b9a\u90e8\u5206\u3092\u5909\u66f4\n\n\u30ce\u30fc\u30c9\u8a2d\u5b9a\nSSL\u8a3c\u660e\u66f8\u8a2d\u5b9a\nAdmin Panel\u306eListener\u306e\u8a2d\u5b9a\nAdmin Panel\u306e\u30e6\u30fc\u30b6\u30fc\u8a2d\u5b9a\n\n$ diff -u riak.conf.orig riak.conf\n--- riak.conf.orig  2015-06-22 05:19:16.221995000 +0000\n+++ riak.conf   2015-06-22 05:39:59.169302319 +0000\n@@ -103,7 +103,7 @@\n ##\n ## Acceptable values:\n ##   - text\n-nodename = riak@127.0.0.1\n+nodename = riak@10.1.11.211\n\n\n ## Cookie for distributed node communication.  All nodes in the\n@@ -204,14 +204,14 @@\n ##\n ## Acceptable values:\n ##   - the path to a file\n-## ssl.certfile = $(platform_etc_dir)/cert.pem\n+ssl.certfile = $(platform_etc_dir)/cert.pem\n\n ## Default key location for https can be overridden with the ssl\n ## config variable, for example:\n ##\n ## Acceptable values:\n ##   - the path to a file\n-## ssl.keyfile = $(platform_etc_dir)/key.pem\n+ssl.keyfile = $(platform_etc_dir)/key.pem\n\n ## Default signing authority location for https can be overridden\n ## with the ssl config variable, for example:\n@@ -283,7 +283,7 @@\n ##\n ## Acceptable values:\n ##   - an IP/port pair, e.g. 127.0.0.1:10011\n-listener.http.internal = 127.0.0.1:8098\n+#listener.http.internal = 127.0.0.1:8098\n\n ## listener.protobuf.<name> is an IP address and TCP port that the Riak\n ## Protocol Buffers interface will bind.\n@@ -292,7 +292,7 @@\n ##\n ## Acceptable values:\n ##   - an IP/port pair, e.g. 127.0.0.1:10011\n-listener.protobuf.internal = 127.0.0.1:8087\n+listener.protobuf.internal = 0.0.0.0:8087\n\n ## The maximum length to which the queue of pending connections\n ## may grow. If set, it must be an integer > 0. If you anticipate a\n@@ -310,7 +310,7 @@\n ##\n ## Acceptable values:\n ##   - an IP/port pair, e.g. 127.0.0.1:10011\n-## listener.https.internal = 127.0.0.1:8098\n+listener.https.internal = 0.0.0.0:8098\n\n ## How Riak will repair out-of-sync keys. Some features require\n ## this to be set to 'active', including search.\n@@ -417,7 +417,7 @@\n ##\n ## Acceptable values:\n ##   - on or off\n-riak_control = off\n+riak_control = on\n\n ## Authentication mode used for access to the admin panel.\n ##\n@@ -425,7 +425,7 @@\n ##\n ## Acceptable values:\n ##   - one of: off, userlist\n-riak_control.auth.mode = off\n+riak_control.auth.mode = userlist\n\n ## If riak control's authentication mode (riak_control.auth.mode)\n ## is set to 'userlist' then this is the list of usernames and\n@@ -437,7 +437,7 @@\n ##\n ## Acceptable values:\n ##   - text\n-## riak_control.auth.user.admin.password = pass\n+riak_control.auth.user.admin.password = passw0rd\n\n ## This parameter defines the percentage of total server memory\n ## to assign to LevelDB. LevelDB will dynamically adjust its internal\n\n\nulimit\u5909\u66f4\n\u305d\u306e\u307e\u307e\u8d77\u52d5\u3057\u3088\u3046\u3068\u3059\u308b\u3068\u8d77\u52d5\u6642\u306b\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u30a8\u30e9\u30fc\u304c\u8868\u793a\u3055\u308c\u3001open files\u306e\u4e0a\u9650\u3092\u4e0a\u3052\u308b\u3088\u3046\u306b\u8b66\u544a\u3055\u308c\u308b\u3002\n$ sudo /etc/init.d/riak restart\nStarting riak: !!!!\n!!!! WARNING: ulimit -n is 1024; 65536 is the recommended minimum.\n!!!!\n^C\nSession terminated, killing shell... ...killed.\n                                                           [FAILED]\n\nulimit\u3092\u5909\u66f4\u3057\u3066\u5bfe\u5fdc\u3002\n$ sudo vi /etc/security/limits.conf\n\nroot soft nofile 65536\nroot hard nofile 65536\n\n\u30b7\u30b9\u30c6\u30e0\u3092\u518d\u8d77\u52d5\u3057\u3066\u53cd\u6620\u3002\n# ulimit -a\ncore file size          (blocks, -c) 0\ndata seg size           (kbytes, -d) unlimited\nscheduling priority             (-e) 0\nfile size               (blocks, -f) unlimited\npending signals                 (-i) 7826\nmax locked memory       (kbytes, -l) 64\nmax memory size         (kbytes, -m) unlimited\nopen files                      (-n) 65536\npipe size            (512 bytes, -p) 8\nPOSIX message queues     (bytes, -q) 819200\nreal-time priority              (-r) 0\nstack size              (kbytes, -s) 8192\ncpu time               (seconds, -t) unlimited\nmax user processes              (-u) 7826\nvirtual memory          (kbytes, -v) unlimited\nfile locks                      (-x) unlimited\n\n\nRiak\u30b5\u30fc\u30d3\u30b9\u306e\u8d77\u52d5\n$ sudo /etc/init.d/riak restart\nStarting riak:                                             [  OK  ]\n\n\n\u52d5\u4f5c\u78ba\u8a8d\n\nping\n$ curl -ik https://127.0.0.1:8098/ping\nHTTP/1.1 200 OK\nServer: MochiWeb/1.1 WebMachine/1.10.8 (that head fake, tho)\nDate: Mon, 29 Jun 2015 09:58:23 GMT\nContent-Type: text/html\nContent-Length: 2\n\nOK\n\n\n\u7d71\u8a08\u60c5\u5831 statistics\n$ curl -sk https://127.0.0.1:8098/stats | jq .\n{\n  \"connected_nodes\": [],\n  \"consistent_get_objsize_100\": 0,\n  \"consistent_get_objsize_95\": 0,\n  \"consistent_get_objsize_99\": 0,\n  \"consistent_get_objsize_mean\": 0,\n  \"consistent_get_objsize_median\": 0,\n  \"consistent_get_time_100\": 0,\n  \"consistent_get_time_95\": 0,\n  \"consistent_get_time_99\": 0,\n  \"consistent_get_time_mean\": 0,\n  \"consistent_get_time_median\": 0,\n  \"consistent_gets\": 0,\n  \"consistent_gets_total\": 0,\n  \"consistent_put_objsize_100\": 0,\n  \"consistent_put_objsize_95\": 0,\n...\n}\n\n\nAdmin Panel \u3078\u306e\u30a2\u30af\u30bb\u30b9\nhttps://<HOSTNAME>:8098/admin\u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3068\u4ee5\u4e0b\u306e\u3088\u3046\u306aadmin panel\u304c\u8868\u793a\u3055\u308c\u308b(\u5916\u90e8\u304b\u3089\u306e\u30a2\u30af\u30bb\u30b9\u3092\u8a31\u53ef\u3057\u3066\u304a\u304f\u5fc5\u8981\u304c\u3042\u308b)\u3002\nriak.conf\u3067\u3001listener.https.internal = 0.0.0.0:8098\u306e\u3088\u3046\u306bHTTPS\u3092\u6709\u52b9\u306b\u3057\u3066\u3044\u308b\u5834\u5408\u306f\u3001https://\u3092\u660e\u793a\u7684\u306b\u6307\u5b9a\u3057\u306a\u3044\u3068\u753b\u9762\u304c\u8868\u793a\u3055\u308c\u306a\u3044\u306e\u3067\u6ce8\u610f\u3002\n\n\n\u30af\u30e9\u30b9\u30bf\u306e\u69cb\u6210\nRiak\u3067\u306f\u30b9\u30b1\u30fc\u30e9\u30d6\u30eb\u306a\u30de\u30b9\u30bf\u30fc\u30ec\u30b9\u306e\u30af\u30e9\u30b9\u30bf\u3092\u7c21\u5358\u306b\u69cb\u6210\u3067\u304d\u308b\u3002\n\n\u521d\u671f\u72b6\u614b\n\u307e\u305a\u306f\u30af\u30e9\u30b9\u30bf\u304c\u69cb\u6210\u3055\u308c\u3066\u306a\u3044\u72b6\u614b\u3067\u306e\u78ba\u8a8d\u3002\n\nring status\n\n[riak@10.1.11.211 ~]$ sudo riak-admin ring_status\n================================== Claimant ===================================\nClaimant:  'riak@10.1.11.211'\nStatus:     up\nRing Ready: true\n\n============================== Ownership Handoff ==============================\nNo pending changes.\n\n============================== Unreachable Nodes ==============================\nAll nodes are up and reachable\n\n\n\u30af\u30e9\u30b9\u30bf\u306e\u30b9\u30c6\u30fc\u30bf\u30b9\n\n[riak@10.1.11.211 ~]$ sudo riak-admin cluster status\n---- Cluster Status ----\nRing ready: true\n\n+----------------------+------+-------+-----+-------+\n|         node         |status| avail |ring |pending|\n+----------------------+------+-------+-----+-------+\n| (C) riak@10.1.11.211 |valid |  up   |100.0|  --   |\n+----------------------+------+-------+-----+-------+\n\nKey: (C) = Claimant; availability marked with '!' is unexpected\n\n\n\u30af\u30e9\u30b9\u30bf\u95a2\u9023\u306e\u7d71\u8a08\u60c5\u5831\n\n$ curl -sk https://127.0.0.1:8098/stats | jq '{vnode_gets, vnode_puts, vnode_index_reads, ring_members, connected_nodes, ring_num_partitions, ring_ownership }'\n{\n  \"vnode_gets\": 0,\n  \"vnode_puts\": 0,\n  \"vnode_index_reads\": 0,\n  \"ring_members\": [\n    \"riak@10.1.11.211\"\n  ],\n  \"connected_nodes\": [],\n  \"ring_num_partitions\": 64,\n  \"ring_ownership\": \"[{'riak@10.1.11.211',64}]\"\n}\n\n\n\u30ce\u30fc\u30c9\u306e\u8907\u88fd\nAMI\u304b\u3089\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u4f5c\u6210\u3057\u3066\u3001riak.conf\u3067nodename\u3092\u66f8\u304d\u63db\u3048\u3066\u8d77\u52d5\u3057\u305f\u3060\u3051\u3067\u306f\u3001\u4ee5\u4e0b\u306e\u69d8\u306a\u30a8\u30e9\u30fc\u304c\u3067\u3066riak\u304c\u8d77\u52d5\u3067\u304d\u306a\u3044\u3002\n2015-06-29 10:50:40.364 [error] <0.201.0> gen_server riak_core_capability terminated with reason: no function clause matching orddict:fetch('riak@10.1.11.212', []) line 72\n2015-06-29 10:50:40.365 [error] <0.201.0> CRASH REPORT Process riak_core_capability with 0 neighbours exited with reason: no function clause matching orddict:fetch('riak@10.1.11.212', []) line 72\nin gen_server:terminate/6 line 744\n2015-06-29 10:50:40.365 [error] <0.164.0> Supervisor riak_core_sup had child riak_core_capability started with riak_core_capability:start_link() at <0.201.0> exit with reason no function clause ma\ntching orddict:fetch('riak@10.1.11.212', []) line 72 in context child_terminated\n\n\u4ee5\u4e0b\u306e\u30ea\u30f3\u30af\u306b\u89e3\u6c7a\u65b9\u6cd5\u3042\u308a\u3002\u53e4\u3044ring\u60c5\u5831\u304c\u6b8b\u3063\u3066\u3044\u308b\u305f\u3081\u4e0d\u6574\u5408\u306b\u306a\u3063\u3066\u3044\u308b\u3002\n\nCommon Errors\n\n\ngen_server riak_core_capability terminated with reason: no function clause matching orddict:fetch('Node', [])\nThe Node has been changed, either through change of IP or vm.args -name without notifying the ring. Either use the riak-admin cluster replace command, or remove the corrupted ring files rm -rf /var/lib/riak/ring/* and rejoin to the cluster\n\nriak-admin cluster replace\u3092\u5b9f\u884c\u3059\u308b\u304b\u3001/var/lib/riak/ring/*\u3092\u524a\u9664\u3057\u3066\u518d\u8d77\u52d5\u3057\u3066\u89e3\u6c7a\u3002\n$ sudo /etc/init.d/riak stop\n$ sudo rm -f /var/lib/riak/ring/*\n$ sudo /etc/init.d/riak start\nStarting riak:                                             [  OK  ]\n\n\n\u30af\u30e9\u30b9\u30bf\u3078\u306e\u30ce\u30fc\u30c9\u8ffd\u52a0\n\u30af\u30e9\u30b9\u30bf\u306e\u69cb\u6210\u306f\u3001\u30b3\u30de\u30f3\u30c9\u3068Web\u306eAdmin Panel\u304b\u3089\u5b9f\u884c\u3067\u304d\u308b\u304c\u3001\u3053\u3053\u3067\u306f\u30b3\u30de\u30f3\u30c9\u3067\u8ffd\u52a0\u3057\u3066\u307f\u308b\u3002\n\u4e3b\u306b\u4f7f\u3046\u30b3\u30de\u30f3\u30c9\u306f\u4ee5\u4e0b\u306e\u3068\u304a\u308a\u3002\nriak-admin ring_status            # ring\u30b9\u30c6\u30fc\u30bf\u30b9\u3092\u78ba\u8a8d\nriak-admin cluster join <NODE>    # \u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3057\u305f\u30ce\u30fc\u30c9\u3092<NODE>\u304c\u6240\u5c5e\u3059\u308b\u30af\u30e9\u30b9\u30bf\u306b\u8ffd\u52a0\nriak-admin cluster plan           # \u5909\u66f4\u3092\u5185\u5bb9\u3092\u78ba\u8a8d\nriak-admin cluster commit         # \u5909\u66f4\u3092\u30b3\u30df\u30c3\u30c8\nriak-admin cluster status         # \u30af\u30e9\u30b9\u30bf\u306e\u30b9\u30c6\u30fc\u30bf\u30b9\u3092\u78ba\u8a8d\n\n\nAdding and Removing Nodes\nriak-admin Command Line\n\n\n\u30af\u30e9\u30b9\u30bf\u3078\u306e\u30ce\u30fc\u30c9\u8ffd\u52a0\n# riak@10.1.11.212\u306e\u30af\u30e9\u30b9\u30bf\u306b\u3001riak@10.1.11.211\u3092\u8ffd\u52a0\n[riak@10.1.11.211 ~]$ sudo riak-admin cluster join riak@10.1.11.212\nSuccess: staged join request for 'riak@10.1.11.211' to 'riak@10.1.11.212'\n\n# riak@10.1.11.211\u306f\u65e2\u306b\u30af\u30e9\u30b9\u30bf\u306b\u8ffd\u52a0\u3055\u308c\u3066\u3044\u308b\u306e\u3067\u3001riak@10.1.11.213\u3068\u30af\u30e9\u30b9\u30bf\u306b\u306f\u306a\u308c\u306a\u3044\n[riak@10.1.11.211 ~]$ sudo riak-admin cluster join riak@10.1.11.213\nFailed: This node is already a member of a cluster\n\n# \u30af\u30e9\u30b9\u30bf\u3078\u306e\u5909\u66f4\u5185\u5bb9\u3092\u78ba\u8a8d\n[riak@10.1.11.211 ~]$ sudo riak-admin cluster plan\n=============================== Staged Changes ================================\nAction         Details(s)\n-------------------------------------------------------------------------------\njoin           'riak@10.1.11.211'\n-------------------------------------------------------------------------------\n\n\nNOTE: Applying these changes will result in 1 cluster transition\n\n###############################################################################\n                         After cluster transition 1/1\n###############################################################################\n\n================================= Membership ==================================\nStatus     Ring    Pending    Node\n-------------------------------------------------------------------------------\nvalid       0.0%     50.0%    'riak@10.1.11.211'\nvalid     100.0%     50.0%    'riak@10.1.11.212'\n-------------------------------------------------------------------------------\nValid:2 / Leaving:0 / Exiting:0 / Joining:0 / Down:0\n\nWARNING: Not all replicas will be on distinct nodes\n\nTransfers resulting from cluster changes: 32\n  32 transfers from 'riak@10.1.11.212' to 'riak@10.1.11.211'\n\n# \u5909\u66f4\u3092commit\n[riak@10.1.11.211 ~]$ sudo riak-admin cluster commit\nCluster changes committed\n\nriak@10.1.11.211\u3068riak@10.1.11.211\u304c\u30af\u30e9\u30b9\u30bf\u306b\u306a\u3063\u305f\u72b6\u614b\n[riak@10.1.11.211 ~]$ sudo riak-admin ring_status\n================================== Claimant ===================================\nClaimant:  'riak@10.1.11.212'\nStatus:     up\nRing Ready: true\n\n============================== Ownership Handoff ==============================\nNo pending changes.\n\n============================== Unreachable Nodes ==============================\nAll nodes are up and reachable\n\n[riak@10.1.11.211 ~]$ sudo riak-admin cluster status\n---- Cluster Status ----\nRing ready: true\n\n+----------------------+------+-------+-----+-------+\n|         node         |status| avail |ring |pending|\n+----------------------+------+-------+-----+-------+\n|     riak@10.1.11.211 |valid |  up   | 50.0|  --   |\n| (C) riak@10.1.11.212 |valid |  up   | 50.0|  --   |\n+----------------------+------+-------+-----+-------+\n\nKey: (C) = Claimant; availability marked with '!' is unexpected\n\n\n\u5225\u306e\u30ce\u30fc\u30c9\u3092\u8ffd\u52a0\n# riak@10.1.11.213\u3092\u3001riak@10.1.11.211\u304c\u542b\u307e\u308c\u308b\u30af\u30e9\u30b9\u30bf\u306b\u8ffd\u52a0\n[riak@10.1.11.213 ~]$ sudo riak-admin cluster join riak@10.1.11.211\nSuccess: staged join request for 'riak@10.1.11.213' to 'riak@10.1.11.211'\n\n[riak@10.1.11.213 ~]$ sudo riak-admin cluster status\n---- Cluster Status ----\nRing ready: true\n\n+----------------------+-------+-------+-----+-------+\n|         node         |status | avail |ring |pending|\n+----------------------+-------+-------+-----+-------+\n|     riak@10.1.11.213 |joining|  up   |  0.0|  --   |\n|     riak@10.1.11.211 | valid |  up   | 50.0|  --   |\n| (C) riak@10.1.11.212 | valid |  up   | 50.0|  --   |\n+----------------------+-------+-------+-----+-------+\n\nKey: (C) = Claimant; availability marked with '!' is unexpected\n\n# \u5909\u66f4\u306e\u78ba\u8a8d\n[riak@10.1.11.213 ~]$ sudo riak-admin cluster plan\n=============================== Staged Changes ================================\nAction         Details(s)\n-------------------------------------------------------------------------------\njoin           'riak@10.1.11.213'\n-------------------------------------------------------------------------------\n\n\nNOTE: Applying these changes will result in 1 cluster transition\n\n###############################################################################\n                         After cluster transition 1/1\n###############################################################################\n\n================================= Membership ==================================\nStatus     Ring    Pending    Node\n-------------------------------------------------------------------------------\nvalid      50.0%     34.4%    'riak@10.1.11.211'\nvalid      50.0%     32.8%    'riak@10.1.11.212'\nvalid       0.0%     32.8%    'riak@10.1.11.213'\n-------------------------------------------------------------------------------\nValid:3 / Leaving:0 / Exiting:0 / Joining:0 / Down:0\n\nWARNING: Not all replicas will be on distinct nodes\n\nTransfers resulting from cluster changes: 21\n  10 transfers from 'riak@10.1.11.211' to 'riak@10.1.11.213'\n  11 transfers from 'riak@10.1.11.212' to 'riak@10.1.11.213'\n\n# \u5909\u66f4\u306ecommit\n[riak@10.1.11.213 ~]$ sudo riak-admin cluster commit\nCluster changes committed\n\n\n\u30af\u30e9\u30b9\u30bf\u306e\u30b9\u30c6\u30fc\u30bf\u30b9\u78ba\u8a8d\n\n\u30b3\u30de\u30f3\u30c9\u3067\u78ba\u8a8d\n$ sudo riak-admin cluster status\n---- Cluster Status ----\nRing ready: true\n\n+----------------------+------+-------+-----+-------+\n|         node         |status| avail |ring |pending|\n+----------------------+------+-------+-----+-------+\n|     riak@10.1.11.211 |valid |  up   | 34.4|  --   |\n| (C) riak@10.1.11.212 |valid |  up   | 32.8|  --   |\n|     riak@10.1.11.213 |valid |  up   | 32.8|  --   |\n+----------------------+------+-------+-----+-------+\n\nKey: (C) = Claimant; availability marked with '!' is unexpected\n\n\nREST API\u304b\u3089\u78ba\u8a8d\n[riak@10.1.11.211 ~]$ curl -sk https://127.0.0.1:8098/stats | jq '{vnode_gets, vnode_puts, vnode_index_reads, ring_members, connected_nodes, ring_num_partitions, ring_ownership }'\n{\n  \"vnode_gets\": 0,\n  \"vnode_puts\": 0,\n  \"vnode_index_reads\": 0,\n  \"ring_members\": [\n    \"riak@10.1.11.211\",\n    \"riak@10.1.11.212\",\n    \"riak@10.1.11.213\"\n  ],\n  \"connected_nodes\": [\n    \"riak@10.1.11.212\",\n    \"riak@10.1.11.213\"\n  ],\n  \"ring_num_partitions\": 64,\n  \"ring_ownership\": \"[{'riak@10.1.11.211',21},{'riak@10.1.11.212',22},{'riak@10.1.11.213',21}]\"\n}\n\n\nAdmin Panel\u304b\u3089\u78ba\u8a8d\n\n\n\u30ce\u30fc\u30c9\u969c\u5bb3\u767a\u751f\u6642\u306e\u6319\u52d5\n\n\u30ce\u30fc\u30c9\u30921\u3064\u30c0\u30a6\u30f3\u3057\u3066\u307f\u308b\n$ sudo riak-admin cluster status\n---- Cluster Status ----\nRing ready: true\n\n+----------------------+------+-------+-----+-------+\n|         node         |status| avail |ring |pending|\n+----------------------+------+-------+-----+-------+\n|     riak@10.1.11.211 |valid |  up   | 34.4|  --   |\n| (C) riak@10.1.11.212 |valid |  up   | 32.8|  --   |\n|     riak@10.1.11.213 |valid | down! | 32.8|  --   |\n+----------------------+------+-------+-----+-------+\n\nKey: (C) = Claimant; availability marked with '!' is unexpected\n[ec2-user@ip-10-1-11-211 ~]$ sudo riak-admin ring_status\n================================== Claimant ===================================\nClaimant:  'riak@10.1.11.212'\nStatus:     up\nRing Ready: true\n\n============================== Ownership Handoff ==============================\nNo pending changes.\n\n============================== Unreachable Nodes ==============================\nThe following nodes are unreachable: ['riak@10.1.11.213']\n\nWARNING: The cluster state will not converge until all nodes\nare up. Once the above nodes come back online, convergence\nwill continue. If the outages are long-term or permanent, you\ncan either mark the nodes as down (riak-admin down NODE) or\nforcibly remove the nodes from the cluster (riak-admin\nforce-remove NODE) to allow the remaining nodes to settle.\n\ndown!\u30de\u30fc\u30af\u304c\u4ed8\u3044\u3066\u3001\u30ce\u30fc\u30c9\u969c\u5bb3\u304c\u8a8d\u8b58\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\nRiak\u306f\u30c7\u30fc\u30bf\u3092\u8907\u6570\u30ce\u30fc\u30c9\u306b\u5206\u6563\u3057\u3066\u4fdd\u5b58\u3057\u3066\u3044\u308b\u305f\u3081\u3001\u3053\u306e\u72b6\u614b\u3067\u3082\u30b5\u30fc\u30d3\u30b9\u306b\u5f71\u97ff\u306f\u306a\u3044\u3002\n\u969c\u5bb3\u304c\u9577\u671f\u306b\u6e21\u308b\u5834\u5408\u306f\u3001riak-admin down <NODE>\u3067\u660e\u793a\u7684\u306b\u30c0\u30a6\u30f3\u3057\u305f\u72b6\u614b\u3068\u3057\u3066\u8a8d\u8b58\u3055\u305b\u3066\u304a\u304f\u304b\u3001riak-admin force-remove <NODE>\u3067\u30af\u30e9\u30b9\u30bf\u304b\u3089\u5916\u3059\u3002\n\nriak-admin down \n$ sudo riak-admin down riak@10.1.11.213\nSuccess: \"riak@10.1.11.213\" marked as down\n\n$ sudo riak-admin cluster status\n---- Cluster Status ----\nRing ready: true\n\n+----------------------+------+-------+-----+-------+\n|         node         |status| avail |ring |pending|\n+----------------------+------+-------+-----+-------+\n|     riak@10.1.11.213 | down | down  | 32.8|  --   |\n|     riak@10.1.11.211 |valid |  up   | 34.4|  --   |\n| (C) riak@10.1.11.212 |valid |  up   | 32.8|  --   |\n+----------------------+------+-------+-----+-------+\n\nKey: (C) = Claimant; availability marked with '!' is unexpected\n\n$ sudo riak-admin ring_status\n================================== Claimant ===================================\nClaimant:  'riak@10.1.11.212'\nStatus:     up\nRing Ready: true\n\n============================== Ownership Handoff ==============================\nNo pending changes.\n\n============================== Unreachable Nodes ==============================\nAll nodes are up and reachable\n\n\u660e\u793a\u7684\u306bdown\u306e\u72b6\u614b\u306b\u3057\u305f\u306e\u3067\u3001Unreachable Nodes\u306b\u306f\u30c0\u30a6\u30f3\u3057\u305f\u30ce\u30fc\u30c9\u304c\u8868\u793a\u3055\u308c\u306a\u304f\u306a\u3063\u305f\u3002\n\nriak-admin force-remove \n$ sudo riak-admin cluster force-remove riak@10.1.11.213\nSuccess: staged remove request for 'riak@10.1.11.213'\n\n$ sudo riak-admin cluster plan\n=============================== Staged Changes ================================\nAction         Details(s)\n-------------------------------------------------------------------------------\nforce-remove   'riak@10.1.11.213'\n-------------------------------------------------------------------------------\n\nWARNING: All of 'riak@10.1.11.213' replicas will be lost\n\nNOTE: Applying these changes will result in 1 cluster transition\n\n###############################################################################\n                         After cluster transition 1/1\n###############################################################################\n\n================================= Membership ==================================\nStatus     Ring    Pending    Node\n-------------------------------------------------------------------------------\nvalid      67.2%     50.0%    'riak@10.1.11.211'\nvalid      32.8%     50.0%    'riak@10.1.11.212'\n-------------------------------------------------------------------------------\nValid:2 / Leaving:0 / Exiting:0 / Joining:0 / Down:0\n\nWARNING: Not all replicas will be on distinct nodes\n\nPartitions reassigned from cluster changes: 21\n  21 reassigned from 'riak@10.1.11.213' to 'riak@10.1.11.211'\n\nTransfers resulting from cluster changes: 21\n  16 transfers from 'riak@10.1.11.211' to 'riak@10.1.11.212'\n  5 transfers from 'riak@10.1.11.212' to 'riak@10.1.11.211'\n\n$ sudo riak-admin cluster commit\nCluster changes committed\n\nring\u72b6\u614b\u304c\u5f90\u3005\u306b\u53ce\u675f\u3057\u3066\u5747\u7b49\u306b\u306a\u308b\u3002\n$ sudo riak-admin cluster status\n---- Cluster Status ----\nRing ready: true\n\n+----------------------+------+-------+-----+-------+\n|         node         |status| avail |ring |pending|\n+----------------------+------+-------+-----+-------+\n|     riak@10.1.11.211 |valid |  up   | 67.2|  50.0 |\n| (C) riak@10.1.11.212 |valid |  up   | 32.8|  50.0 |\n+----------------------+------+-------+-----+-------+\n\nKey: (C) = Claimant; availability marked with '!' is unexpected\n\n$ sudo riak-admin cluster status\n---- Cluster Status ----\nRing ready: true\n\n+----------------------+------+-------+-----+-------+\n|         node         |status| avail |ring |pending|\n+----------------------+------+-------+-----+-------+\n|     riak@10.1.11.211 |valid |  up   | 54.7|  50.0 |\n| (C) riak@10.1.11.212 |valid |  up   | 45.3|  50.0 |\n+----------------------+------+-------+-----+-------+\n\nKey: (C) = Claimant; availability marked with '!' is unexpected\n\n$ sudo riak-admin cluster status\n---- Cluster Status ----\nRing ready: true\n\n+----------------------+------+-------+-----+-------+\n|         node         |status| avail |ring |pending|\n+----------------------+------+-------+-----+-------+\n|     riak@10.1.11.211 |valid |  up   | 50.0|  --   |\n| (C) riak@10.1.11.212 |valid |  up   | 50.0|  --   |\n+----------------------+------+-------+-----+-------+\n\nKey: (C) = Claimant; availability marked with '!' is unexpected\n\n# Riak\u3068\u306f\n\n- Key-Value Store\u306eNoSQL\u5206\u6563\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\n- AWS\u306eDynamoDB\u8ad6\u6587\u3092\u30d9\u30fc\u30b9\u306b\u8a2d\u8a08\u3055\u308c\u305f\n- \u30de\u30b9\u30bf\u30fc\u30ec\u30b9\u69cb\u6210\u3067\u53ef\u7528\u6027\u30fb\u8010\u969c\u5bb3\u6027\u304c\u975e\u5e38\u306b\u9ad8\u3044\u3002\u4e00\u8cab\u6027\u306fEventually Consistency\n- [erlang/otp](https://github.com/erlang/otp)\u3092\u5206\u6563\u30b7\u30b9\u30c6\u30e0\u306e\u30d9\u30fc\u30b9\u306b\u3057\u3066\u3044\u308b\n\n\n\u8aac\u660e\u306f\u3044\u308d\u3093\u306a\u30b5\u30a4\u30c8\u306b\u3042\u308b\u306e\u3067\u8a73\u7d30\u306f\u305d\u3061\u3089\u3092\u3002\n\n- [basho/riak](https://github.com/basho/riak)\n- [Riak](http://docs.basho.com/riak/latest/)\n- [Riak Compared to DynamoDB](http://docs.basho.com/riak/latest/theory/comparisons/dynamodb/) DynamoDB\u3068\u306e\u6bd4\u8f03\n- [\u904b\u7528\u304c\u697d\u306b\u306a\u308b\u5206\u6563\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9 Riak](http://www.slideshare.net/takahikosato/riak-24796781)\n- [\u96f2\u306b\u306a\u3063\u305f\u30b3\u30f3\u30d4\u30e5\u30fc\u30bf: Basho\u306eRiak\u3068\u306f\u4f55\u304b\uff1f\uff0dSDS\uff17\uff0d](http://computerbecamecloud.blogspot.jp/2014/02/bashoriaksds.html)\n- [Riak\u306f\u306a\u305c\u826f\u3044\u306e\u304b](http://www.slideshare.net/scixer/riak-28885715?related=1)\n\n\n# \u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\n\nAmazon Linux\u74b0\u5883\u306b\u3001\u8a18\u8f09\u6642\u70b9\u3067\u6700\u65b0\u306eRiak 2.1.1\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u3066\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u3057\u3066\u307f\u308b [Downloads](http://docs.basho.com/riak/latest/downloads/)\n\u4ee5\u4e0b\u30b5\u30a4\u30c8\u3092\u53c2\u8003\n\n- [Riak2.0.0pre\u3092\u3064\u304b\u3063\u3066\u307f\u305f - Qiita](http://qiita.com/iyunoriue/items/6bb8ee14cc7306917c0d)\n\n## \u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n```bash\n$ sudo yum install http://s3.amazonaws.com/downloads.basho.com/riak/2.1/2.1.1/rhel/6/riak-2.1.1-1.el6.x86_64.rpm\n```\n\n## \u8a3c\u660e\u66f8\u306e\u4f5c\u6210\n\nWeb\u30d9\u30fc\u30b9\u306e\u7ba1\u7406\u30b3\u30f3\u30bd\u30fc\u30eb(Admin Panel)\u3092HTTPS\u3067\u4f7f\u3046\u305f\u3081\u306b\u8a3c\u660e\u66f8\u304c\u5fc5\u8981\u306a\u306e\u3067\u4f5c\u6210\u3057\u3066\u304a\u304f\u3002\n\n```bash\n$ openssl genrsa -aes128 -out key.pem 1024 \n$ openssl req -new -key key.pem -out cert.csr\n$ mv key.pem key.pem.org\n$ openssl rsa -in key.pem.org -out key.pem   #\u3000\u79d8\u5bc6\u9375\u304b\u3089\u30d1\u30b9\u30d5\u30ec\u30fc\u30ba\u3092\u524a\u9664\n$ openssl x509 -req -days 365 -in cert.csr -signkey key.pem -out cert.pem\n$ sudo cp key.pem cert.pem /etc/riak/\n```\n\n## \u8a2d\u5b9a\n\n### riak.conf\n\n\u4ee5\u4e0b\u306e\u8a2d\u5b9a\u90e8\u5206\u3092\u5909\u66f4\n\n- \u30ce\u30fc\u30c9\u8a2d\u5b9a\n- SSL\u8a3c\u660e\u66f8\u8a2d\u5b9a\n- Admin Panel\u306eListener\u306e\u8a2d\u5b9a\n- Admin Panel\u306e\u30e6\u30fc\u30b6\u30fc\u8a2d\u5b9a\n\n```diff\n$ diff -u riak.conf.orig riak.conf\n--- riak.conf.orig\t2015-06-22 05:19:16.221995000 +0000\n+++ riak.conf\t2015-06-22 05:39:59.169302319 +0000\n@@ -103,7 +103,7 @@\n ##\n ## Acceptable values:\n ##   - text\n-nodename = riak@127.0.0.1\n+nodename = riak@10.1.11.211\n\n\n ## Cookie for distributed node communication.  All nodes in the\n@@ -204,14 +204,14 @@\n ##\n ## Acceptable values:\n ##   - the path to a file\n-## ssl.certfile = $(platform_etc_dir)/cert.pem\n+ssl.certfile = $(platform_etc_dir)/cert.pem\n\n ## Default key location for https can be overridden with the ssl\n ## config variable, for example:\n ##\n ## Acceptable values:\n ##   - the path to a file\n-## ssl.keyfile = $(platform_etc_dir)/key.pem\n+ssl.keyfile = $(platform_etc_dir)/key.pem\n\n ## Default signing authority location for https can be overridden\n ## with the ssl config variable, for example:\n@@ -283,7 +283,7 @@\n ##\n ## Acceptable values:\n ##   - an IP/port pair, e.g. 127.0.0.1:10011\n-listener.http.internal = 127.0.0.1:8098\n+#listener.http.internal = 127.0.0.1:8098\n\n ## listener.protobuf.<name> is an IP address and TCP port that the Riak\n ## Protocol Buffers interface will bind.\n@@ -292,7 +292,7 @@\n ##\n ## Acceptable values:\n ##   - an IP/port pair, e.g. 127.0.0.1:10011\n-listener.protobuf.internal = 127.0.0.1:8087\n+listener.protobuf.internal = 0.0.0.0:8087\n\n ## The maximum length to which the queue of pending connections\n ## may grow. If set, it must be an integer > 0. If you anticipate a\n@@ -310,7 +310,7 @@\n ##\n ## Acceptable values:\n ##   - an IP/port pair, e.g. 127.0.0.1:10011\n-## listener.https.internal = 127.0.0.1:8098\n+listener.https.internal = 0.0.0.0:8098\n\n ## How Riak will repair out-of-sync keys. Some features require\n ## this to be set to 'active', including search.\n@@ -417,7 +417,7 @@\n ##\n ## Acceptable values:\n ##   - on or off\n-riak_control = off\n+riak_control = on\n\n ## Authentication mode used for access to the admin panel.\n ##\n@@ -425,7 +425,7 @@\n ##\n ## Acceptable values:\n ##   - one of: off, userlist\n-riak_control.auth.mode = off\n+riak_control.auth.mode = userlist\n\n ## If riak control's authentication mode (riak_control.auth.mode)\n ## is set to 'userlist' then this is the list of usernames and\n@@ -437,7 +437,7 @@\n ##\n ## Acceptable values:\n ##   - text\n-## riak_control.auth.user.admin.password = pass\n+riak_control.auth.user.admin.password = passw0rd\n\n ## This parameter defines the percentage of total server memory\n ## to assign to LevelDB. LevelDB will dynamically adjust its internal\n```\n\n\n### ulimit\u5909\u66f4\n\n\u305d\u306e\u307e\u307e\u8d77\u52d5\u3057\u3088\u3046\u3068\u3059\u308b\u3068\u8d77\u52d5\u6642\u306b\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u30a8\u30e9\u30fc\u304c\u8868\u793a\u3055\u308c\u3001open files\u306e\u4e0a\u9650\u3092\u4e0a\u3052\u308b\u3088\u3046\u306b\u8b66\u544a\u3055\u308c\u308b\u3002\n\n```bash\n$ sudo /etc/init.d/riak restart\nStarting riak: !!!!\n!!!! WARNING: ulimit -n is 1024; 65536 is the recommended minimum.\n!!!!\n^C\nSession terminated, killing shell... ...killed.\n                                                           [FAILED]\n```\n\nulimit\u3092\u5909\u66f4\u3057\u3066\u5bfe\u5fdc\u3002\n\n```bash\n$ sudo vi /etc/security/limits.conf\n\nroot soft nofile 65536\nroot hard nofile 65536\n```\n\n\u30b7\u30b9\u30c6\u30e0\u3092\u518d\u8d77\u52d5\u3057\u3066\u53cd\u6620\u3002\n\n```bash\n# ulimit -a\ncore file size          (blocks, -c) 0\ndata seg size           (kbytes, -d) unlimited\nscheduling priority             (-e) 0\nfile size               (blocks, -f) unlimited\npending signals                 (-i) 7826\nmax locked memory       (kbytes, -l) 64\nmax memory size         (kbytes, -m) unlimited\nopen files                      (-n) 65536\npipe size            (512 bytes, -p) 8\nPOSIX message queues     (bytes, -q) 819200\nreal-time priority              (-r) 0\nstack size              (kbytes, -s) 8192\ncpu time               (seconds, -t) unlimited\nmax user processes              (-u) 7826\nvirtual memory          (kbytes, -v) unlimited\nfile locks                      (-x) unlimited\n```\n\n\n## Riak\u30b5\u30fc\u30d3\u30b9\u306e\u8d77\u52d5\n\n```bash\n$ sudo /etc/init.d/riak restart\nStarting riak:                                             [  OK  ]\n```\n\n## \u52d5\u4f5c\u78ba\u8a8d\n\n### ping\n\n```bash\n$ curl -ik https://127.0.0.1:8098/ping\nHTTP/1.1 200 OK\nServer: MochiWeb/1.1 WebMachine/1.10.8 (that head fake, tho)\nDate: Mon, 29 Jun 2015 09:58:23 GMT\nContent-Type: text/html\nContent-Length: 2\n\nOK\n```\n\n### \u7d71\u8a08\u60c5\u5831 statistics\n\n```\n$ curl -sk https://127.0.0.1:8098/stats | jq .\n{\n  \"connected_nodes\": [],\n  \"consistent_get_objsize_100\": 0,\n  \"consistent_get_objsize_95\": 0,\n  \"consistent_get_objsize_99\": 0,\n  \"consistent_get_objsize_mean\": 0,\n  \"consistent_get_objsize_median\": 0,\n  \"consistent_get_time_100\": 0,\n  \"consistent_get_time_95\": 0,\n  \"consistent_get_time_99\": 0,\n  \"consistent_get_time_mean\": 0,\n  \"consistent_get_time_median\": 0,\n  \"consistent_gets\": 0,\n  \"consistent_gets_total\": 0,\n  \"consistent_put_objsize_100\": 0,\n  \"consistent_put_objsize_95\": 0,\n...\n}\n```\n\n### Admin Panel \u3078\u306e\u30a2\u30af\u30bb\u30b9\n\n`https://<HOSTNAME>:8098/admin`\u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3068\u4ee5\u4e0b\u306e\u3088\u3046\u306aadmin panel\u304c\u8868\u793a\u3055\u308c\u308b(\u5916\u90e8\u304b\u3089\u306e\u30a2\u30af\u30bb\u30b9\u3092\u8a31\u53ef\u3057\u3066\u304a\u304f\u5fc5\u8981\u304c\u3042\u308b)\u3002\n`riak.conf`\u3067\u3001`listener.https.internal = 0.0.0.0:8098`\u306e\u3088\u3046\u306bHTTPS\u3092\u6709\u52b9\u306b\u3057\u3066\u3044\u308b\u5834\u5408\u306f\u3001`https://`\u3092\u660e\u793a\u7684\u306b\u6307\u5b9a\u3057\u306a\u3044\u3068\u753b\u9762\u304c\u8868\u793a\u3055\u308c\u306a\u3044\u306e\u3067\u6ce8\u610f\u3002\n\n![image](https://qiita-image-store.s3.amazonaws.com/0/65167/445f7fbf-c540-1a65-626e-0e60bc1e1066.png)\n\n\n# \u30af\u30e9\u30b9\u30bf\u306e\u69cb\u6210\n\nRiak\u3067\u306f\u30b9\u30b1\u30fc\u30e9\u30d6\u30eb\u306a\u30de\u30b9\u30bf\u30fc\u30ec\u30b9\u306e\u30af\u30e9\u30b9\u30bf\u3092\u7c21\u5358\u306b\u69cb\u6210\u3067\u304d\u308b\u3002\n\n## \u521d\u671f\u72b6\u614b\n\n\u307e\u305a\u306f\u30af\u30e9\u30b9\u30bf\u304c\u69cb\u6210\u3055\u308c\u3066\u306a\u3044\u72b6\u614b\u3067\u306e\u78ba\u8a8d\u3002\n\n- ring status\n\n```bash\n[riak@10.1.11.211 ~]$ sudo riak-admin ring_status\n================================== Claimant ===================================\nClaimant:  'riak@10.1.11.211'\nStatus:     up\nRing Ready: true\n\n============================== Ownership Handoff ==============================\nNo pending changes.\n\n============================== Unreachable Nodes ==============================\nAll nodes are up and reachable\n```\n\n- \u30af\u30e9\u30b9\u30bf\u306e\u30b9\u30c6\u30fc\u30bf\u30b9\n\n```\n[riak@10.1.11.211 ~]$ sudo riak-admin cluster status\n---- Cluster Status ----\nRing ready: true\n\n+----------------------+------+-------+-----+-------+\n|         node         |status| avail |ring |pending|\n+----------------------+------+-------+-----+-------+\n| (C) riak@10.1.11.211 |valid |  up   |100.0|  --   |\n+----------------------+------+-------+-----+-------+\n\nKey: (C) = Claimant; availability marked with '!' is unexpected\n```\n\n- \u30af\u30e9\u30b9\u30bf\u95a2\u9023\u306e\u7d71\u8a08\u60c5\u5831\n\n```bash\n$ curl -sk https://127.0.0.1:8098/stats | jq '{vnode_gets, vnode_puts, vnode_index_reads, ring_members, connected_nodes, ring_num_partitions, ring_ownership }'\n{\n  \"vnode_gets\": 0,\n  \"vnode_puts\": 0,\n  \"vnode_index_reads\": 0,\n  \"ring_members\": [\n    \"riak@10.1.11.211\"\n  ],\n  \"connected_nodes\": [],\n  \"ring_num_partitions\": 64,\n  \"ring_ownership\": \"[{'riak@10.1.11.211',64}]\"\n}\n```\n\n## \u30ce\u30fc\u30c9\u306e\u8907\u88fd\n\n\nAMI\u304b\u3089\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u4f5c\u6210\u3057\u3066\u3001riak.conf\u3067nodename\u3092\u66f8\u304d\u63db\u3048\u3066\u8d77\u52d5\u3057\u305f\u3060\u3051\u3067\u306f\u3001\u4ee5\u4e0b\u306e\u69d8\u306a\u30a8\u30e9\u30fc\u304c\u3067\u3066riak\u304c\u8d77\u52d5\u3067\u304d\u306a\u3044\u3002\n\n```\n2015-06-29 10:50:40.364 [error] <0.201.0> gen_server riak_core_capability terminated with reason: no function clause matching orddict:fetch('riak@10.1.11.212', []) line 72\n2015-06-29 10:50:40.365 [error] <0.201.0> CRASH REPORT Process riak_core_capability with 0 neighbours exited with reason: no function clause matching orddict:fetch('riak@10.1.11.212', []) line 72\nin gen_server:terminate/6 line 744\n2015-06-29 10:50:40.365 [error] <0.164.0> Supervisor riak_core_sup had child riak_core_capability started with riak_core_capability:start_link() at <0.201.0> exit with reason no function clause ma\ntching orddict:fetch('riak@10.1.11.212', []) line 72 in context child_terminated\n```\n\n\u4ee5\u4e0b\u306e\u30ea\u30f3\u30af\u306b\u89e3\u6c7a\u65b9\u6cd5\u3042\u308a\u3002\u53e4\u3044ring\u60c5\u5831\u304c\u6b8b\u3063\u3066\u3044\u308b\u305f\u3081\u4e0d\u6574\u5408\u306b\u306a\u3063\u3066\u3044\u308b\u3002\n\n- [Common Errors](http://docs.basho.com/riak/1.3.0/references/Errors/#Specific-messages)\n\n> gen_server riak_core_capability terminated with reason: no function clause matching orddict:fetch('Node', [])\n> The Node has been changed, either through change of IP or vm.args -name without notifying the ring. Either use the riak-admin cluster replace command, or remove the corrupted ring files rm -rf /var/lib/riak/ring/* and rejoin to the cluster\n\n\n`riak-admin cluster replace`\u3092\u5b9f\u884c\u3059\u308b\u304b\u3001`/var/lib/riak/ring/*`\u3092\u524a\u9664\u3057\u3066\u518d\u8d77\u52d5\u3057\u3066\u89e3\u6c7a\u3002\n\n```bash\n$ sudo /etc/init.d/riak stop\n$ sudo rm -f /var/lib/riak/ring/*\n$ sudo /etc/init.d/riak start\nStarting riak:                                             [  OK  ]\n```\n\n\n## \u30af\u30e9\u30b9\u30bf\u3078\u306e\u30ce\u30fc\u30c9\u8ffd\u52a0\n\n\u30af\u30e9\u30b9\u30bf\u306e\u69cb\u6210\u306f\u3001\u30b3\u30de\u30f3\u30c9\u3068Web\u306eAdmin Panel\u304b\u3089\u5b9f\u884c\u3067\u304d\u308b\u304c\u3001\u3053\u3053\u3067\u306f\u30b3\u30de\u30f3\u30c9\u3067\u8ffd\u52a0\u3057\u3066\u307f\u308b\u3002\n\u4e3b\u306b\u4f7f\u3046\u30b3\u30de\u30f3\u30c9\u306f\u4ee5\u4e0b\u306e\u3068\u304a\u308a\u3002\n\n```\nriak-admin ring_status            # ring\u30b9\u30c6\u30fc\u30bf\u30b9\u3092\u78ba\u8a8d\nriak-admin cluster join <NODE>    # \u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3057\u305f\u30ce\u30fc\u30c9\u3092<NODE>\u304c\u6240\u5c5e\u3059\u308b\u30af\u30e9\u30b9\u30bf\u306b\u8ffd\u52a0\nriak-admin cluster plan           # \u5909\u66f4\u3092\u5185\u5bb9\u3092\u78ba\u8a8d\nriak-admin cluster commit         # \u5909\u66f4\u3092\u30b3\u30df\u30c3\u30c8\nriak-admin cluster status         # \u30af\u30e9\u30b9\u30bf\u306e\u30b9\u30c6\u30fc\u30bf\u30b9\u3092\u78ba\u8a8d\n```\n- [Adding and Removing Nodes](http://docs.basho.com/riak/latest/ops/running/nodes/adding-removing/)\n- [riak-admin Command Line](http://docs.basho.com/riak/latest/ops/running/tools/riak-admin/)\n\n\n### \u30af\u30e9\u30b9\u30bf\u3078\u306e\u30ce\u30fc\u30c9\u8ffd\u52a0\n\n```bash\n# riak@10.1.11.212\u306e\u30af\u30e9\u30b9\u30bf\u306b\u3001riak@10.1.11.211\u3092\u8ffd\u52a0\n[riak@10.1.11.211 ~]$ sudo riak-admin cluster join riak@10.1.11.212\nSuccess: staged join request for 'riak@10.1.11.211' to 'riak@10.1.11.212'\n\n# riak@10.1.11.211\u306f\u65e2\u306b\u30af\u30e9\u30b9\u30bf\u306b\u8ffd\u52a0\u3055\u308c\u3066\u3044\u308b\u306e\u3067\u3001riak@10.1.11.213\u3068\u30af\u30e9\u30b9\u30bf\u306b\u306f\u306a\u308c\u306a\u3044\n[riak@10.1.11.211 ~]$ sudo riak-admin cluster join riak@10.1.11.213\nFailed: This node is already a member of a cluster\n\n# \u30af\u30e9\u30b9\u30bf\u3078\u306e\u5909\u66f4\u5185\u5bb9\u3092\u78ba\u8a8d\n[riak@10.1.11.211 ~]$ sudo riak-admin cluster plan\n=============================== Staged Changes ================================\nAction         Details(s)\n-------------------------------------------------------------------------------\njoin           'riak@10.1.11.211'\n-------------------------------------------------------------------------------\n\n\nNOTE: Applying these changes will result in 1 cluster transition\n\n###############################################################################\n                         After cluster transition 1/1\n###############################################################################\n\n================================= Membership ==================================\nStatus     Ring    Pending    Node\n-------------------------------------------------------------------------------\nvalid       0.0%     50.0%    'riak@10.1.11.211'\nvalid     100.0%     50.0%    'riak@10.1.11.212'\n-------------------------------------------------------------------------------\nValid:2 / Leaving:0 / Exiting:0 / Joining:0 / Down:0\n\nWARNING: Not all replicas will be on distinct nodes\n\nTransfers resulting from cluster changes: 32\n  32 transfers from 'riak@10.1.11.212' to 'riak@10.1.11.211'\n\n# \u5909\u66f4\u3092commit\n[riak@10.1.11.211 ~]$ sudo riak-admin cluster commit\nCluster changes committed\n```\n\nriak@10.1.11.211\u3068riak@10.1.11.211\u304c\u30af\u30e9\u30b9\u30bf\u306b\u306a\u3063\u305f\u72b6\u614b\n\n```\n[riak@10.1.11.211 ~]$ sudo riak-admin ring_status\n================================== Claimant ===================================\nClaimant:  'riak@10.1.11.212'\nStatus:     up\nRing Ready: true\n\n============================== Ownership Handoff ==============================\nNo pending changes.\n\n============================== Unreachable Nodes ==============================\nAll nodes are up and reachable\n\n[riak@10.1.11.211 ~]$ sudo riak-admin cluster status\n---- Cluster Status ----\nRing ready: true\n\n+----------------------+------+-------+-----+-------+\n|         node         |status| avail |ring |pending|\n+----------------------+------+-------+-----+-------+\n|     riak@10.1.11.211 |valid |  up   | 50.0|  --   |\n| (C) riak@10.1.11.212 |valid |  up   | 50.0|  --   |\n+----------------------+------+-------+-----+-------+\n\nKey: (C) = Claimant; availability marked with '!' is unexpected\n```\n\n### \u5225\u306e\u30ce\u30fc\u30c9\u3092\u8ffd\u52a0\n\n```bash\n# riak@10.1.11.213\u3092\u3001riak@10.1.11.211\u304c\u542b\u307e\u308c\u308b\u30af\u30e9\u30b9\u30bf\u306b\u8ffd\u52a0\n[riak@10.1.11.213 ~]$ sudo riak-admin cluster join riak@10.1.11.211\nSuccess: staged join request for 'riak@10.1.11.213' to 'riak@10.1.11.211'\n\n[riak@10.1.11.213 ~]$ sudo riak-admin cluster status\n---- Cluster Status ----\nRing ready: true\n\n+----------------------+-------+-------+-----+-------+\n|         node         |status | avail |ring |pending|\n+----------------------+-------+-------+-----+-------+\n|     riak@10.1.11.213 |joining|  up   |  0.0|  --   |\n|     riak@10.1.11.211 | valid |  up   | 50.0|  --   |\n| (C) riak@10.1.11.212 | valid |  up   | 50.0|  --   |\n+----------------------+-------+-------+-----+-------+\n\nKey: (C) = Claimant; availability marked with '!' is unexpected\n\n# \u5909\u66f4\u306e\u78ba\u8a8d\n[riak@10.1.11.213 ~]$ sudo riak-admin cluster plan\n=============================== Staged Changes ================================\nAction         Details(s)\n-------------------------------------------------------------------------------\njoin           'riak@10.1.11.213'\n-------------------------------------------------------------------------------\n\n\nNOTE: Applying these changes will result in 1 cluster transition\n\n###############################################################################\n                         After cluster transition 1/1\n###############################################################################\n\n================================= Membership ==================================\nStatus     Ring    Pending    Node\n-------------------------------------------------------------------------------\nvalid      50.0%     34.4%    'riak@10.1.11.211'\nvalid      50.0%     32.8%    'riak@10.1.11.212'\nvalid       0.0%     32.8%    'riak@10.1.11.213'\n-------------------------------------------------------------------------------\nValid:3 / Leaving:0 / Exiting:0 / Joining:0 / Down:0\n\nWARNING: Not all replicas will be on distinct nodes\n\nTransfers resulting from cluster changes: 21\n  10 transfers from 'riak@10.1.11.211' to 'riak@10.1.11.213'\n  11 transfers from 'riak@10.1.11.212' to 'riak@10.1.11.213'\n\n# \u5909\u66f4\u306ecommit\n[riak@10.1.11.213 ~]$ sudo riak-admin cluster commit\nCluster changes committed\n```\n\n### \u30af\u30e9\u30b9\u30bf\u306e\u30b9\u30c6\u30fc\u30bf\u30b9\u78ba\u8a8d\n\n#### \u30b3\u30de\u30f3\u30c9\u3067\u78ba\u8a8d\n\n```bash\n$ sudo riak-admin cluster status\n---- Cluster Status ----\nRing ready: true\n\n+----------------------+------+-------+-----+-------+\n|         node         |status| avail |ring |pending|\n+----------------------+------+-------+-----+-------+\n|     riak@10.1.11.211 |valid |  up   | 34.4|  --   |\n| (C) riak@10.1.11.212 |valid |  up   | 32.8|  --   |\n|     riak@10.1.11.213 |valid |  up   | 32.8|  --   |\n+----------------------+------+-------+-----+-------+\n\nKey: (C) = Claimant; availability marked with '!' is unexpected\n```\n\n#### REST API\u304b\u3089\u78ba\u8a8d\n\n```bash\n[riak@10.1.11.211 ~]$ curl -sk https://127.0.0.1:8098/stats | jq '{vnode_gets, vnode_puts, vnode_index_reads, ring_members, connected_nodes, ring_num_partitions, ring_ownership }'\n{\n  \"vnode_gets\": 0,\n  \"vnode_puts\": 0,\n  \"vnode_index_reads\": 0,\n  \"ring_members\": [\n    \"riak@10.1.11.211\",\n    \"riak@10.1.11.212\",\n    \"riak@10.1.11.213\"\n  ],\n  \"connected_nodes\": [\n    \"riak@10.1.11.212\",\n    \"riak@10.1.11.213\"\n  ],\n  \"ring_num_partitions\": 64,\n  \"ring_ownership\": \"[{'riak@10.1.11.211',21},{'riak@10.1.11.212',22},{'riak@10.1.11.213',21}]\"\n}\n```\n\n#### Admin Panel\u304b\u3089\u78ba\u8a8d\n\n![image](https://qiita-image-store.s3.amazonaws.com/0/65167/0f03b852-0e93-183a-a054-ccf1354ee6f4.png)\n\n\n\n## \u30ce\u30fc\u30c9\u969c\u5bb3\u767a\u751f\u6642\u306e\u6319\u52d5\n\n\n### \u30ce\u30fc\u30c9\u30921\u3064\u30c0\u30a6\u30f3\u3057\u3066\u307f\u308b\n\n```bash\n$ sudo riak-admin cluster status\n---- Cluster Status ----\nRing ready: true\n\n+----------------------+------+-------+-----+-------+\n|         node         |status| avail |ring |pending|\n+----------------------+------+-------+-----+-------+\n|     riak@10.1.11.211 |valid |  up   | 34.4|  --   |\n| (C) riak@10.1.11.212 |valid |  up   | 32.8|  --   |\n|     riak@10.1.11.213 |valid | down! | 32.8|  --   |\n+----------------------+------+-------+-----+-------+\n\nKey: (C) = Claimant; availability marked with '!' is unexpected\n[ec2-user@ip-10-1-11-211 ~]$ sudo riak-admin ring_status\n================================== Claimant ===================================\nClaimant:  'riak@10.1.11.212'\nStatus:     up\nRing Ready: true\n\n============================== Ownership Handoff ==============================\nNo pending changes.\n\n============================== Unreachable Nodes ==============================\nThe following nodes are unreachable: ['riak@10.1.11.213']\n\nWARNING: The cluster state will not converge until all nodes\nare up. Once the above nodes come back online, convergence\nwill continue. If the outages are long-term or permanent, you\ncan either mark the nodes as down (riak-admin down NODE) or\nforcibly remove the nodes from the cluster (riak-admin\nforce-remove NODE) to allow the remaining nodes to settle.\n```\n\ndown!\u30de\u30fc\u30af\u304c\u4ed8\u3044\u3066\u3001\u30ce\u30fc\u30c9\u969c\u5bb3\u304c\u8a8d\u8b58\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\nRiak\u306f\u30c7\u30fc\u30bf\u3092\u8907\u6570\u30ce\u30fc\u30c9\u306b\u5206\u6563\u3057\u3066\u4fdd\u5b58\u3057\u3066\u3044\u308b\u305f\u3081\u3001\u3053\u306e\u72b6\u614b\u3067\u3082\u30b5\u30fc\u30d3\u30b9\u306b\u5f71\u97ff\u306f\u306a\u3044\u3002\n\n\u969c\u5bb3\u304c\u9577\u671f\u306b\u6e21\u308b\u5834\u5408\u306f\u3001`riak-admin down <NODE>`\u3067\u660e\u793a\u7684\u306b\u30c0\u30a6\u30f3\u3057\u305f\u72b6\u614b\u3068\u3057\u3066\u8a8d\u8b58\u3055\u305b\u3066\u304a\u304f\u304b\u3001`riak-admin force-remove <NODE>`\u3067\u30af\u30e9\u30b9\u30bf\u304b\u3089\u5916\u3059\u3002\n\n\n#### riak-admin down <NODE>\n\n```\n$ sudo riak-admin down riak@10.1.11.213\nSuccess: \"riak@10.1.11.213\" marked as down\n\n$ sudo riak-admin cluster status\n---- Cluster Status ----\nRing ready: true\n\n+----------------------+------+-------+-----+-------+\n|         node         |status| avail |ring |pending|\n+----------------------+------+-------+-----+-------+\n|     riak@10.1.11.213 | down | down  | 32.8|  --   |\n|     riak@10.1.11.211 |valid |  up   | 34.4|  --   |\n| (C) riak@10.1.11.212 |valid |  up   | 32.8|  --   |\n+----------------------+------+-------+-----+-------+\n\nKey: (C) = Claimant; availability marked with '!' is unexpected\n\n$ sudo riak-admin ring_status\n================================== Claimant ===================================\nClaimant:  'riak@10.1.11.212'\nStatus:     up\nRing Ready: true\n\n============================== Ownership Handoff ==============================\nNo pending changes.\n\n============================== Unreachable Nodes ==============================\nAll nodes are up and reachable\n```\n\n\u660e\u793a\u7684\u306bdown\u306e\u72b6\u614b\u306b\u3057\u305f\u306e\u3067\u3001Unreachable Nodes\u306b\u306f\u30c0\u30a6\u30f3\u3057\u305f\u30ce\u30fc\u30c9\u304c\u8868\u793a\u3055\u308c\u306a\u304f\u306a\u3063\u305f\u3002\n\n### riak-admin force-remove <NODE>\n\n```\n$ sudo riak-admin cluster force-remove riak@10.1.11.213\nSuccess: staged remove request for 'riak@10.1.11.213'\n\n$ sudo riak-admin cluster plan\n=============================== Staged Changes ================================\nAction         Details(s)\n-------------------------------------------------------------------------------\nforce-remove   'riak@10.1.11.213'\n-------------------------------------------------------------------------------\n\nWARNING: All of 'riak@10.1.11.213' replicas will be lost\n\nNOTE: Applying these changes will result in 1 cluster transition\n\n###############################################################################\n                         After cluster transition 1/1\n###############################################################################\n\n================================= Membership ==================================\nStatus     Ring    Pending    Node\n-------------------------------------------------------------------------------\nvalid      67.2%     50.0%    'riak@10.1.11.211'\nvalid      32.8%     50.0%    'riak@10.1.11.212'\n-------------------------------------------------------------------------------\nValid:2 / Leaving:0 / Exiting:0 / Joining:0 / Down:0\n\nWARNING: Not all replicas will be on distinct nodes\n\nPartitions reassigned from cluster changes: 21\n  21 reassigned from 'riak@10.1.11.213' to 'riak@10.1.11.211'\n\nTransfers resulting from cluster changes: 21\n  16 transfers from 'riak@10.1.11.211' to 'riak@10.1.11.212'\n  5 transfers from 'riak@10.1.11.212' to 'riak@10.1.11.211'\n\n$ sudo riak-admin cluster commit\nCluster changes committed\n```\n\nring\u72b6\u614b\u304c\u5f90\u3005\u306b\u53ce\u675f\u3057\u3066\u5747\u7b49\u306b\u306a\u308b\u3002\n\n```\n$ sudo riak-admin cluster status\n---- Cluster Status ----\nRing ready: true\n\n+----------------------+------+-------+-----+-------+\n|         node         |status| avail |ring |pending|\n+----------------------+------+-------+-----+-------+\n|     riak@10.1.11.211 |valid |  up   | 67.2|  50.0 |\n| (C) riak@10.1.11.212 |valid |  up   | 32.8|  50.0 |\n+----------------------+------+-------+-----+-------+\n\nKey: (C) = Claimant; availability marked with '!' is unexpected\n\n$ sudo riak-admin cluster status\n---- Cluster Status ----\nRing ready: true\n\n+----------------------+------+-------+-----+-------+\n|         node         |status| avail |ring |pending|\n+----------------------+------+-------+-----+-------+\n|     riak@10.1.11.211 |valid |  up   | 54.7|  50.0 |\n| (C) riak@10.1.11.212 |valid |  up   | 45.3|  50.0 |\n+----------------------+------+-------+-----+-------+\n\nKey: (C) = Claimant; availability marked with '!' is unexpected\n\n$ sudo riak-admin cluster status\n---- Cluster Status ----\nRing ready: true\n\n+----------------------+------+-------+-----+-------+\n|         node         |status| avail |ring |pending|\n+----------------------+------+-------+-----+-------+\n|     riak@10.1.11.211 |valid |  up   | 50.0|  --   |\n| (C) riak@10.1.11.212 |valid |  up   | 50.0|  --   |\n+----------------------+------+-------+-----+-------+\n\nKey: (C) = Claimant; availability marked with '!' is unexpected\n```\n\n\n\n\n"}