{"context": "\n\n\u74b0\u5883\n\n\n\nIP\nOS\nROLE\n\n\n\n\n172.27.100.141\nCentOS 7.2\nmanager + node + consul + registrator\n\n\n172.27.100.142\nCentOS 7.2\nnode + registrator\n\n\n172.27.100.143\nCentOS 7.2\nnode + registrator\n\n\n172.27.100.144\nCentOS 7.2\nnode + registrator\n\n\n\n\n172.27.100.* docker \u3092\u5165\u308c\u308b\nyum update\ncurl -fsSL https://get.docker.com/ | sh\n\n\n172.27.100.* docker.conf \u306e\u8a2d\u5b9a\u3092\u3059\u308b\nmkdir -p /etc/systemd/system/docker.service.d\ncat << EOT > /etc/systemd/system/docker.service.d/docker.conf\n[Service]\nExecStart=\nExecStart=/usr/bin/docker daemon --insecure-registry=172.27.100.141:5000 --cluster-store=consul://172.27.100.141:8500 --cluster-advertise=${HOST_IP}:2375 -H tcp://0.0.0.0:2375 -H unix:///var/run/docker.sock\n# 172.27.100.141 \u306e\u307f label \u3092\u8cbc\u308b(global\u3092\u8cbc\u3063\u3066\u308bhost\u304c141\u306e\u305f\u3081\nExecStart=/usr/bin/docker daemon --insecure-registry=172.27.100.141:5000 --label global=enable --cluster-store=consul://172.27.100.141:8500 --cluster-advertise=${HOST_IP}:2375 -H tcp://0.0.0.0:2375 -H unix:///var/run/docker.sock\nEOT\nsystemctl daemon-reload\nsystemctl restart docker\ndocker run hello-world\nps aux | grep docker | grep -v grep\n\n\n172.27.100.141 manager \u306e\u8a2d\u5b9a\u3092\u3059\u308b\ndocker run -d -p 8500:8500 --name=consul progrium/consul -server -bootstrap\ndocker run -d -p 4000:4000 swarm manage -H :4000 --replication --advertise 172.27.100.141:4000  consul://172.27.100.141:8500\n\n\n172.27.100.* node \u306e\u8a2d\u5b9a\u3092\u3059\u308b\ndocker run -d swarm join --advertise=${HOST_IP}:2375 consul://172.27.100.141:8500\n\n\n172.27.100.141 docker info \u3067 swarm \u3067\u304d\u3066\u3044\u308b\u304b\u78ba\u8a8d\u3059\u308b\nexport DOCKER_HOST=\"tcp://localhost:4000\"\ndocker info\n\n\u3053\u3093\u306a\u51fa\u529b\u306b\u306a\u3063\u305f\u3089\u6210\u529f\nContainers: 51\n Running: 19\n Paused: 0\n Stopped: 32\nImages: 80\nServer Version: swarm/1.1.3\nRole: primary\nStrategy: spread\nFilters: health, port, dependency, affinity, constraint\nNodes: 4\n vm-st-050: 172.27.100.141:2375\n  \u2514 Status: Healthy\n  \u2514 Containers: 19\n  \u2514 Reserved CPUs: 0 / 8\n  \u2514 Reserved Memory: 0 B / 14.22 GiB\n  \u2514 Labels: executiondriver=native-0.2, global=enable, kernelversion=3.10.0-327.10.1.el7.x86_64, operatingsystem=CentOS Linux 7 (Core), storagedriver=devicemapper\n  \u2514 Error: (none)\n  \u2514 UpdatedAt: 2016-04-19T02:37:20Z\n vm-st-051: 172.27.100.142:2375\n  \u2514 Status: Healthy\n  \u2514 Containers: 11\n  \u2514 Reserved CPUs: 0 / 8\n  \u2514 Reserved Memory: 0 B / 16.29 GiB\n  \u2514 Labels: executiondriver=native-0.2, kernelversion=3.10.0-327.13.1.el7.x86_64, operatingsystem=CentOS Linux 7 (Core), storagedriver=devicemapper\n  \u2514 Error: (none)\n  \u2514 UpdatedAt: 2016-04-19T02:37:11Z\n vm-st-052: 172.27.100.143:2375\n  \u2514 Status: Healthy\n  \u2514 Containers: 11\n  \u2514 Reserved CPUs: 0 / 8\n  \u2514 Reserved Memory: 0 B / 16.29 GiB\n  \u2514 Labels: executiondriver=native-0.2, kernelversion=3.10.0-327.13.1.el7.x86_64, operatingsystem=CentOS Linux 7 (Core), storagedriver=devicemapper\n  \u2514 Error: (none)\n  \u2514 UpdatedAt: 2016-04-19T02:37:40Z\n vm-st-053: 172.27.100.144:2375\n  \u2514 Status: Healthy\n  \u2514 Containers: 10\n  \u2514 Reserved CPUs: 0 / 8\n  \u2514 Reserved Memory: 0 B / 16.29 GiB\n  \u2514 Labels: executiondriver=native-0.2, kernelversion=3.10.0-327.13.1.el7.x86_64, operatingsystem=CentOS Linux 7 (Core), storagedriver=devicemapper\n  \u2514 Error: (none)\n  \u2514 UpdatedAt: 2016-04-19T02:37:47Z\nPlugins: \n Volume: \n Network: \nKernel Version: 3.10.0-327.10.1.el7.x86_64\nOperating System: linux\nArchitecture: amd64\nCPUs: 32\nTotal Memory: 63.09 GiB\nName: f52c9ae71a74\n\n\nregistory \u3092\u7acb\u3066\u3066\u304a\u304f\ncd ${HOME}\ndocker run -d -p 5000:5000 --name registry -e constraint:global==enable \\\n      -v `pwd`/docker-registry:/var/lib/registry \\\n      registry:2\n\n\n172.27.100.* registrator \u3092\u7acb\u3066\u308b\ndocker run -d \\\n  --name=registrator \\\n  -h ${HOST_IP} \\\n  --volume=/var/run/docker.sock:/tmp/docker.sock \\\n  gliderlabs/registrator:latest \\\n  consul://172.27.100.141:8500\n\nimage \u3092 push \u3059\u308b\u3068\u3053\u308d\u306f\u5272\u611b\n\nTODO consul \u3092\u5197\u9577\u5316\u3059\u308b\n\nTODO manager \u3092\u5197\u9577\u5316\u3059\u308b\n\ndocker-compose \u3059\u308b\n\ndocker-compose.yml\nversion: '2'\nservices:\n  bg:\n    image: hanzel/blue-green\n    container_name: bg\n    ports:\n      - \"80:80\"\n      - \"8080:8080\"\n    environment:\n      - CONSUL_URL=172.27.100.141:8500\n      - BLUE_NAME=blue\n      - GREEN_NAME=green\n      - LIVE=blue\n      - \"constraint:global==enable\"\n    depends_on:\n      - green\n      - blue\n    networks:\n      - management\n\n  blue:\n    image: 172.27.100.141:5000/api-develop:latest\n    ports:\n      - '9000'\n    environment:\n      - SERVICE_9000_NAME=blue\n    networks:\n      - management\n\n  green:\n    image: 172.27.100.141:5000/api-develop:latest\n    ports:\n      - '9000'\n    depends_on:\n      - postgres\n    environment:\n    - SERVICE_9000_NAME=green\n    networks:\n      - management\n\n  postgres:\n    container_name: 'postgres'\n    environment:\n      - POSTGRES_PASSWORD=mysecretpassword\n      - POSTGRES_DB=default\n    image: postgres\n    ports:\n      - 5432:5432\n    networks:\n      - management\n\nnetworks:\n  management:\n    driver: overlay\n\n\ndocker-compose up -d\n\n\nnginx \u306e proxy pass \u8a2d\u5b9a\u3092\u78ba\u8a8d\u3059\u308b\ndocker -H 172.27.100.141:2375 exec bg cat /etc/nginx/nginx.conf\n\n\nnginx.conf\n---- 8< ----\nhttp {\n        upstream blue {\n            least_conn;\n\n            server 172.27.100.144:32812 max_fails=3 fail_timeout=60 weight=1;\n        }\n\n        upstream green {\n            least_conn;\n\n            server 172.27.100.142:32778 max_fails=3 fail_timeout=60 weight=1;\n        }\n---- 8< ----\n\n\n\nscale \u3057\u3066 nginx.conf \u3092\u78ba\u8a8d\u3059\u308b\ndocker-compose scale green=3 blue=3\ndocker -H 172.27.100.141:2375 exec bg cat /etc/nginx/nginx.conf\n\n\nnginx.conf\n---- 8< ----\nhttp {\n        upstream blue {\n            least_conn;\n\n            server 172.27.100.142:32779 max_fails=3 fail_timeout=60 weight=1;\n            server 172.27.100.143:32773 max_fails=3 fail_timeout=60 weight=1;\n            server 172.27.100.144:32812 max_fails=3 fail_timeout=60 weight=1;\n        }\n\n        upstream green {\n            least_conn;\n\n            server 172.27.100.142:32778 max_fails=3 fail_timeout=60 weight=1;\n            server 172.27.100.143:32772 max_fails=3 fail_timeout=60 weight=1;\n            server 172.27.100.144:32813 max_fails=3 fail_timeout=60 weight=1;\n        }\n---- 8< ----\n\n\n\nblue \u3067\u52d5\u3044\u3066\u3044\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3059\u308b\ndocker -H 172.27.100.141:2375 exec bg cat /var/live\n> blue\n\n\ngreen \u306b\u5207\u308a\u66ff\u3048\u308b\ndocker -H 172.27.100.141:2375 exec bg switch green\ndocker -H 172.27.100.141:2375 exec bg cat /var/live\n> green\n\n\n## \u74b0\u5883\n\n| IP             | OS         | ROLE                                   |\n|:---------------|:-----------|:---------------------------------------|\n| 172.27.100.141 | CentOS 7.2 | manager + node + consul + registrator |\n| 172.27.100.142 | CentOS 7.2 | node + registrator                    |\n| 172.27.100.143 | CentOS 7.2 | node + registrator                    |\n| 172.27.100.144 | CentOS 7.2 | node + registrator                    |\n\n## 172.27.100.* docker \u3092\u5165\u308c\u308b\n\n```bash\nyum update\ncurl -fsSL https://get.docker.com/ | sh\n```\n\n## 172.27.100.* docker.conf \u306e\u8a2d\u5b9a\u3092\u3059\u308b\n\n```bash\nmkdir -p /etc/systemd/system/docker.service.d\ncat << EOT > /etc/systemd/system/docker.service.d/docker.conf\n[Service]\nExecStart=\nExecStart=/usr/bin/docker daemon --insecure-registry=172.27.100.141:5000 --cluster-store=consul://172.27.100.141:8500 --cluster-advertise=${HOST_IP}:2375 -H tcp://0.0.0.0:2375 -H unix:///var/run/docker.sock\n# 172.27.100.141 \u306e\u307f label \u3092\u8cbc\u308b(global\u3092\u8cbc\u3063\u3066\u308bhost\u304c141\u306e\u305f\u3081\nExecStart=/usr/bin/docker daemon --insecure-registry=172.27.100.141:5000 --label global=enable --cluster-store=consul://172.27.100.141:8500 --cluster-advertise=${HOST_IP}:2375 -H tcp://0.0.0.0:2375 -H unix:///var/run/docker.sock\nEOT\nsystemctl daemon-reload\nsystemctl restart docker\ndocker run hello-world\nps aux | grep docker | grep -v grep\n```\n\n## 172.27.100.141 manager \u306e\u8a2d\u5b9a\u3092\u3059\u308b\n\n```bash\ndocker run -d -p 8500:8500 --name=consul progrium/consul -server -bootstrap\ndocker run -d -p 4000:4000 swarm manage -H :4000 --replication --advertise 172.27.100.141:4000  consul://172.27.100.141:8500\n```\n\n## 172.27.100.* node \u306e\u8a2d\u5b9a\u3092\u3059\u308b\n\n```bash\ndocker run -d swarm join --advertise=${HOST_IP}:2375 consul://172.27.100.141:8500\n```\n\n## 172.27.100.141 docker info \u3067 swarm \u3067\u304d\u3066\u3044\u308b\u304b\u78ba\u8a8d\u3059\u308b\n\n```bash\nexport DOCKER_HOST=\"tcp://localhost:4000\"\ndocker info\n```\n\n\u3053\u3093\u306a\u51fa\u529b\u306b\u306a\u3063\u305f\u3089\u6210\u529f\n\n```bash\nContainers: 51\n Running: 19\n Paused: 0\n Stopped: 32\nImages: 80\nServer Version: swarm/1.1.3\nRole: primary\nStrategy: spread\nFilters: health, port, dependency, affinity, constraint\nNodes: 4\n vm-st-050: 172.27.100.141:2375\n  \u2514 Status: Healthy\n  \u2514 Containers: 19\n  \u2514 Reserved CPUs: 0 / 8\n  \u2514 Reserved Memory: 0 B / 14.22 GiB\n  \u2514 Labels: executiondriver=native-0.2, global=enable, kernelversion=3.10.0-327.10.1.el7.x86_64, operatingsystem=CentOS Linux 7 (Core), storagedriver=devicemapper\n  \u2514 Error: (none)\n  \u2514 UpdatedAt: 2016-04-19T02:37:20Z\n vm-st-051: 172.27.100.142:2375\n  \u2514 Status: Healthy\n  \u2514 Containers: 11\n  \u2514 Reserved CPUs: 0 / 8\n  \u2514 Reserved Memory: 0 B / 16.29 GiB\n  \u2514 Labels: executiondriver=native-0.2, kernelversion=3.10.0-327.13.1.el7.x86_64, operatingsystem=CentOS Linux 7 (Core), storagedriver=devicemapper\n  \u2514 Error: (none)\n  \u2514 UpdatedAt: 2016-04-19T02:37:11Z\n vm-st-052: 172.27.100.143:2375\n  \u2514 Status: Healthy\n  \u2514 Containers: 11\n  \u2514 Reserved CPUs: 0 / 8\n  \u2514 Reserved Memory: 0 B / 16.29 GiB\n  \u2514 Labels: executiondriver=native-0.2, kernelversion=3.10.0-327.13.1.el7.x86_64, operatingsystem=CentOS Linux 7 (Core), storagedriver=devicemapper\n  \u2514 Error: (none)\n  \u2514 UpdatedAt: 2016-04-19T02:37:40Z\n vm-st-053: 172.27.100.144:2375\n  \u2514 Status: Healthy\n  \u2514 Containers: 10\n  \u2514 Reserved CPUs: 0 / 8\n  \u2514 Reserved Memory: 0 B / 16.29 GiB\n  \u2514 Labels: executiondriver=native-0.2, kernelversion=3.10.0-327.13.1.el7.x86_64, operatingsystem=CentOS Linux 7 (Core), storagedriver=devicemapper\n  \u2514 Error: (none)\n  \u2514 UpdatedAt: 2016-04-19T02:37:47Z\nPlugins: \n Volume: \n Network: \nKernel Version: 3.10.0-327.10.1.el7.x86_64\nOperating System: linux\nArchitecture: amd64\nCPUs: 32\nTotal Memory: 63.09 GiB\nName: f52c9ae71a74\n```\n## registory \u3092\u7acb\u3066\u3066\u304a\u304f\n\n```bash\ncd ${HOME}\ndocker run -d -p 5000:5000 --name registry -e constraint:global==enable \\\n      -v `pwd`/docker-registry:/var/lib/registry \\\n      registry:2\n```\n\n## 172.27.100.* registrator \u3092\u7acb\u3066\u308b\n\n```bash\ndocker run -d \\\n  --name=registrator \\\n  -h ${HOST_IP} \\\n  --volume=/var/run/docker.sock:/tmp/docker.sock \\\n  gliderlabs/registrator:latest \\\n  consul://172.27.100.141:8500\n```\n\nimage \u3092 push \u3059\u308b\u3068\u3053\u308d\u306f\u5272\u611b\n\n## TODO consul \u3092\u5197\u9577\u5316\u3059\u308b\n\n## TODO manager \u3092\u5197\u9577\u5316\u3059\u308b\n\n## docker-compose \u3059\u308b\n\n```text:docker-compose.yml\nversion: '2'\nservices:\n  bg:\n    image: hanzel/blue-green\n    container_name: bg\n    ports:\n      - \"80:80\"\n      - \"8080:8080\"\n    environment:\n      - CONSUL_URL=172.27.100.141:8500\n      - BLUE_NAME=blue\n      - GREEN_NAME=green\n      - LIVE=blue\n      - \"constraint:global==enable\"\n    depends_on:\n      - green\n      - blue\n    networks:\n      - management\n\n  blue:\n    image: 172.27.100.141:5000/api-develop:latest\n    ports:\n      - '9000'\n    environment:\n      - SERVICE_9000_NAME=blue\n    networks:\n      - management\n\n  green:\n    image: 172.27.100.141:5000/api-develop:latest\n    ports:\n      - '9000'\n    depends_on:\n      - postgres\n    environment:\n    - SERVICE_9000_NAME=green\n    networks:\n      - management\n\n  postgres:\n    container_name: 'postgres'\n    environment:\n      - POSTGRES_PASSWORD=mysecretpassword\n      - POSTGRES_DB=default\n    image: postgres\n    ports:\n      - 5432:5432\n    networks:\n      - management\n\nnetworks:\n  management:\n    driver: overlay\n```\n\n```bash\ndocker-compose up -d\n```\n\n## nginx \u306e proxy pass \u8a2d\u5b9a\u3092\u78ba\u8a8d\u3059\u308b\n\n```bash\ndocker -H 172.27.100.141:2375 exec bg cat /etc/nginx/nginx.conf\n```\n\n```text:nginx.conf\n---- 8< ----\nhttp {\n        upstream blue {\n            least_conn;\n            \n            server 172.27.100.144:32812 max_fails=3 fail_timeout=60 weight=1;\n        }\n\n        upstream green {\n            least_conn;\n            \n            server 172.27.100.142:32778 max_fails=3 fail_timeout=60 weight=1;\n        }\n---- 8< ----\n``` \n\n## scale \u3057\u3066 nginx.conf \u3092\u78ba\u8a8d\u3059\u308b\n\n```bash\ndocker-compose scale green=3 blue=3\ndocker -H 172.27.100.141:2375 exec bg cat /etc/nginx/nginx.conf\n```\n\n```text:nginx.conf\n---- 8< ----\nhttp {\n        upstream blue {\n            least_conn;\n            \n            server 172.27.100.142:32779 max_fails=3 fail_timeout=60 weight=1;\n            server 172.27.100.143:32773 max_fails=3 fail_timeout=60 weight=1;\n            server 172.27.100.144:32812 max_fails=3 fail_timeout=60 weight=1;\n        }\n\n        upstream green {\n            least_conn;\n            \n            server 172.27.100.142:32778 max_fails=3 fail_timeout=60 weight=1;\n            server 172.27.100.143:32772 max_fails=3 fail_timeout=60 weight=1;\n            server 172.27.100.144:32813 max_fails=3 fail_timeout=60 weight=1;\n        }\n---- 8< ----\n```\n\n## blue \u3067\u52d5\u3044\u3066\u3044\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3059\u308b\n\n```bash\ndocker -H 172.27.100.141:2375 exec bg cat /var/live\n> blue\n```\n\n## green \u306b\u5207\u308a\u66ff\u3048\u308b\n\n```bash\ndocker -H 172.27.100.141:2375 exec bg switch green\ndocker -H 172.27.100.141:2375 exec bg cat /var/live\n> green\n```\n", "tags": ["docker", "docker-compose", "docker-swarm", "blue_green_deployment", "registrator"]}