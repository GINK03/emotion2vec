{"context": "\n\n\u306f\u3058\u3081\u306b\n\u3053\u306e\u8a18\u4e8b\u306fGoogle Cloud Platform(1) Advent Calendar 20167\u65e5\u76ee\u306e\u8a18\u4e8b\u3067\u3059\u3002\n\u307e\u3060\u6295\u7a3f\u304c\u306a\u304b\u3063\u305f\u306e\u3068\u3001\u3061\u3087\u3046\u3069\u793e\u5185\u306eQiitaTeam\u306bBigQuery\u3068Amazon Athena\u306e\u7c21\u5358\u306a\u6bd4\u8f03\u30cd\u30bf\u3092\u6295\u7a3f\u3057\u3066\u3044\u305f\u306e\u3067\u3001\u305d\u308c\u3092\u8f09\u305b\u307e\u3059\n\n\u3084\u3063\u305f\u3053\u3068\n\nTreasureData\u304b\u3089BigQuery\u51fa\u529b\u3057\u3066\u3044\u308b\u30c7\u30fc\u30bf\u304c\u3042\u3063\u305f\u306e\u3067\u540c\u3058\u3082\u306e\u3092S3\u306b\u51fa\u529b\nBigQuery, Athena\u306b\u30af\u30a8\u30ea\u306a\u3052\u3066\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u3092\u6bd4\u8f03\n\n\nAthena\u30c7\u30fc\u30bf\u6e96\u5099\n\n\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u4f5c\u6210\nCREATE DATABASE test;\n\n\n\u30c6\u30fc\u30d6\u30eb\u4f5c\u6210\n\u30c7\u30fc\u30bf\u306fweblog\u3092\u3061\u3087\u3063\u3068\u30b5\u30de\u30ea\u3057\u305f\u3082\u306e\u3067\u3059\u3002\nCREATE EXTERNAL TABLE IF NOT EXISTS test.weblog (\n  summarize_date string,\n  user_id string,\n  host string,\n  url string,\n  os string,\n  browser string,\n  ip_address string,\n  logs bigint \n)\nPARTITIONED BY ( dt string )\nROW FORMAT SERDE 'org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe'\nWITH SERDEPROPERTIES (\n  'serialization.format' = '    ',\n  'field.delim' = ' '\n) LOCATION 's3://path/to/weblog/';\n\n\nPARTITION\u306f\u65e5\u4ed8\u3092\u5165\u308c\u308b\u306e\u3067\u3001dt\u3068\u3044\u3046\u540d\u524d\u3067\u8a2d\u5b9a\n\n\nPARTITIONING\u3092\u8a2d\u5b9a\n11/1,11/2\u306e2\u65e5\u5206\u3092\u5165\u308c\u305f\u306e\u3067\uff12\u3064\u8a2d\u5b9a\nALTER TABLE test.weblog ADD\n  PARTITION (dt='20161101') LOCATION 's3://path/to/weblog/20161101/'\n  PARTITION (dt='20161102') LOCATION 's3://path/to/weblog/20161102/';\n\n\u78ba\u8a8d\nshow partitions test.weblog;\n\n\u7d50\u679c\u3002\u3067\u304d\u3066\u307e\u3059\u306d\u3002\ndt=20161101\ndt=20161102\n\n\n\u30af\u30a8\u30ea\u3092\u306a\u3052\u3066\u307f\u308b\n\u30ab\u30a6\u30f3\u30c8\nselect\n  count(1)\nfrom test.weblog;\n-- (Run time: 4.12 seconds, Data scanned: 121.19MB)  result: 2541225\n\n\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u304c\u52b9\u304f\u304b\u3069\u3046\u304b\u3002\n\u30ec\u30b3\u30fc\u30c9\u6570\u3082\u6e1b\u3063\u305f\u3057\u51e6\u7406\u30c7\u30fc\u30bf\u91cf\u3082\u6e1b\u3063\u305f\nselect\n  count(1)\nfrom test.weblog\nwhere dt = '20161101';\n-- (Run time: 4.33 seconds, Data scanned: 60.99MB) \u3000result: 1277304\n\n\nBigQuery\u3068AWS Athena\u3092\u6bd4\u8f03\n\n\u30db\u30b9\u30c8\u540d\u5225\u306eUU\u6570\n\n\u30af\u30a8\u30ea\n select \n  host,\n  count(distinct user_id)\n from weblog\ngroup by \n  host\nORDER BY\n  host\n\n\n\u7d50\u679c\n\nBQ: Query complete (2.8s elapsed, 107 MB processed)\n\nAthena: (Run time: 6.19 seconds, Data scanned: 121.19MB)\n\n\n\nURL\u5225\u30ed\u30b0\u6570 Top1000\nSQL\u306f\u5272\u611b\u3002\u7d50\u679c\u306f\u4ee5\u4e0b\u306e\u901a\u308a\u3067\u3057\u305f\u3002\n\nBQ: Query complete (3.9s elapsed, 152 MB processed)\n\nAthena:  (Run time: 5.86 seconds, Data scanned: 121.19MB)\n\n\n\u3059\u3054\u304f\u7c21\u5358\u306a\u691c\u8a3c\u304b\u3064\u3001\u30c7\u30fc\u30bf\u91cf\u3082\u305d\u3053\u307e\u3067\u591a\u304f\u3042\u308a\u307e\u305b\u3093\u3067\u3057\u305f\u304c\u3001BigQuery\u306e\u307b\u3046\u304c\u901f\u3044\u3068\u3044\u3046\u7d50\u679c\u306b\u306a\u308a\u307e\u3057\u305f\u3002\n\n\u6240\u611f\n\n\u30b3\u30b9\u30c8\u3092\u307e\u3058\u3081\u306b\u6bd4\u8f03\u3057\u3066\u3044\u306a\u3044\u306e\u3060\u304c\u3001\u5b9f\u969b\u306e\u3068\u3053\u308d\u3069\u3046\u306a\u3093\u3060\u308d\u3046\u304b\nUI\u304c\u304b\u306a\u308a\u9177\u4f3c\u3057\u3066\u3044\u308b\nAthena\u306e\u5834\u5408\u3001\u30af\u30a8\u30ea\u7d50\u679c\u304c\u30ad\u30e3\u30c3\u30b7\u30e5\u3055\u308c\u306a\u3044\u3001\u304b\u3064\u30af\u30a8\u30ea\u306e\u7d50\u679c\u304cS3\u306b\u51fa\u529b\u3055\u308c\u3066\u3044\u308b\u306e\u3067\u3001\u6ce8\u610f\u3057\u306a\u3044\u3068\u30af\u30e9\u30a6\u30c9\u7834\u7523\u3059\u308b\n\n# \u306f\u3058\u3081\u306b\n\n\u3053\u306e\u8a18\u4e8b\u306f[Google Cloud Platform(1) Advent Calendar 2016](http://qiita.com/advent-calendar/2016/gcp)7\u65e5\u76ee\u306e\u8a18\u4e8b\u3067\u3059\u3002\n\u307e\u3060\u6295\u7a3f\u304c\u306a\u304b\u3063\u305f\u306e\u3068\u3001\u3061\u3087\u3046\u3069\u793e\u5185\u306eQiitaTeam\u306bBigQuery\u3068Amazon Athena\u306e\u7c21\u5358\u306a\u6bd4\u8f03\u30cd\u30bf\u3092\u6295\u7a3f\u3057\u3066\u3044\u305f\u306e\u3067\u3001\u305d\u308c\u3092\u8f09\u305b\u307e\u3059\n\n# \u3084\u3063\u305f\u3053\u3068\n\n* TreasureData\u304b\u3089BigQuery\u51fa\u529b\u3057\u3066\u3044\u308b\u30c7\u30fc\u30bf\u304c\u3042\u3063\u305f\u306e\u3067\u540c\u3058\u3082\u306e\u3092S3\u306b\u51fa\u529b\n* BigQuery, Athena\u306b\u30af\u30a8\u30ea\u306a\u3052\u3066\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u3092\u6bd4\u8f03\n\n# Athena\u30c7\u30fc\u30bf\u6e96\u5099\n\n## \u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u4f5c\u6210\n\n```sql\nCREATE DATABASE test;\n```\n\n## \u30c6\u30fc\u30d6\u30eb\u4f5c\u6210\n\n\u30c7\u30fc\u30bf\u306fweblog\u3092\u3061\u3087\u3063\u3068\u30b5\u30de\u30ea\u3057\u305f\u3082\u306e\u3067\u3059\u3002\n\n```sql\nCREATE EXTERNAL TABLE IF NOT EXISTS test.weblog (\n  summarize_date string,\n  user_id string,\n  host string,\n  url string,\n  os string,\n  browser string,\n  ip_address string,\n  logs bigint \n)\nPARTITIONED BY ( dt string )\nROW FORMAT SERDE 'org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe'\nWITH SERDEPROPERTIES (\n  'serialization.format' = '\t',\n  'field.delim' = '\t'\n) LOCATION 's3://path/to/weblog/';\n```\n\n* PARTITION\u306f\u65e5\u4ed8\u3092\u5165\u308c\u308b\u306e\u3067\u3001`dt`\u3068\u3044\u3046\u540d\u524d\u3067\u8a2d\u5b9a\n\n## PARTITIONING\u3092\u8a2d\u5b9a\n\n11/1,11/2\u306e2\u65e5\u5206\u3092\u5165\u308c\u305f\u306e\u3067\uff12\u3064\u8a2d\u5b9a\n\n```sql\nALTER TABLE test.weblog ADD\n  PARTITION (dt='20161101') LOCATION 's3://path/to/weblog/20161101/'\n  PARTITION (dt='20161102') LOCATION 's3://path/to/weblog/20161102/';\n```\n\n\u78ba\u8a8d\n\n```sql\nshow partitions test.weblog;\n```\n\n\u7d50\u679c\u3002\u3067\u304d\u3066\u307e\u3059\u306d\u3002\n\n```\ndt=20161101\ndt=20161102\n```\n\n## \u30af\u30a8\u30ea\u3092\u306a\u3052\u3066\u307f\u308b\n\u30ab\u30a6\u30f3\u30c8\n\n```sql\nselect\n  count(1)\nfrom test.weblog;\n-- (Run time: 4.12 seconds, Data scanned: 121.19MB)  result: 2541225\n```\n\n\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u304c\u52b9\u304f\u304b\u3069\u3046\u304b\u3002\n\u30ec\u30b3\u30fc\u30c9\u6570\u3082\u6e1b\u3063\u305f\u3057\u51e6\u7406\u30c7\u30fc\u30bf\u91cf\u3082\u6e1b\u3063\u305f\n\n```sql\nselect\n  count(1)\nfrom test.weblog\nwhere dt = '20161101';\n-- (Run time: 4.33 seconds, Data scanned: 60.99MB) \u3000result: 1277304\n```\n\n# BigQuery\u3068AWS Athena\u3092\u6bd4\u8f03\n\n## \u30db\u30b9\u30c8\u540d\u5225\u306eUU\u6570\n\n### \u30af\u30a8\u30ea\n\n```sql\n select \n  host,\n  count(distinct user_id)\n from weblog\ngroup by \n  host\nORDER BY\n  host\n```\n\n### \u7d50\u679c\n\n* BQ: **Query complete (2.8s elapsed, 107 MB processed)**\n* Athena: **(Run time: 6.19 seconds, Data scanned: 121.19MB)**\n\n## URL\u5225\u30ed\u30b0\u6570 Top1000\n\nSQL\u306f\u5272\u611b\u3002\u7d50\u679c\u306f\u4ee5\u4e0b\u306e\u901a\u308a\u3067\u3057\u305f\u3002\n\n* BQ: **Query complete (3.9s elapsed, 152 MB processed)**\n* Athena:  **(Run time: 5.86 seconds, Data scanned: 121.19MB)**\n\n\u3059\u3054\u304f\u7c21\u5358\u306a\u691c\u8a3c\u304b\u3064\u3001\u30c7\u30fc\u30bf\u91cf\u3082\u305d\u3053\u307e\u3067\u591a\u304f\u3042\u308a\u307e\u305b\u3093\u3067\u3057\u305f\u304c\u3001BigQuery\u306e\u307b\u3046\u304c\u901f\u3044\u3068\u3044\u3046\u7d50\u679c\u306b\u306a\u308a\u307e\u3057\u305f\u3002\n\n# \u6240\u611f\n\n* \u30b3\u30b9\u30c8\u3092\u307e\u3058\u3081\u306b\u6bd4\u8f03\u3057\u3066\u3044\u306a\u3044\u306e\u3060\u304c\u3001\u5b9f\u969b\u306e\u3068\u3053\u308d\u3069\u3046\u306a\u3093\u3060\u308d\u3046\u304b\n* UI\u304c\u304b\u306a\u308a\u9177\u4f3c\u3057\u3066\u3044\u308b\n* Athena\u306e\u5834\u5408\u3001\u30af\u30a8\u30ea\u7d50\u679c\u304c\u30ad\u30e3\u30c3\u30b7\u30e5\u3055\u308c\u306a\u3044\u3001\u304b\u3064\u30af\u30a8\u30ea\u306e\u7d50\u679c\u304cS3\u306b\u51fa\u529b\u3055\u308c\u3066\u3044\u308b\u306e\u3067\u3001\u6ce8\u610f\u3057\u306a\u3044\u3068\u30af\u30e9\u30a6\u30c9\u7834\u7523\u3059\u308b\n\n\n", "tags": ["bigquery", "AWS", "Athena"]}