{"context": "\u3053\u306e\u8a18\u4e8b\u306f \u30ea\u30af\u30eb\u30fc\u30c8\u30e9\u30a4\u30d5\u30b9\u30bf\u30a4\u30eb\u30a2\u30c9\u30d9\u30f3\u30c8\u30ab\u30ec\u30f3\u30c0\u30fc2016 \u306e11\u65e5\u76ee\u3067\u3059\u3002\n\u30db\u30c3\u30c8\u30da\u30c3\u30d1\u30fc\u30d3\u30e5\u30fc\u30c6\u30a3\u30fc\u3067\u3086\u308b\u3075\u308f\u30a8\u30f3\u30b8\u30cb\u30a2\u3092\u3057\u3066\u3044\u307e\u3059\u3002\u3057\u3083\u305c\u3067\u3059\u3002\n\u5272\u308a\u3068\u6700\u8fd1\u5165\u793e\u3057\u305f\u3070\u3063\u304b\u308a\u3067\u3059\u3002\n\u3055\u3066\u3001\u4eca\u56de\u306f\u524d\u304b\u3089\u8a66\u305d\u3046\u3068\u601d\u3063\u3066\u6687\u304c\u306a\u304f\u3066\u30b5\u30dc\u3063\u3066\u3044\u305f\u3001OpenResty\u3067\u5c11\u3057\u904a\u3093\u3067\u307f\u307e\u3057\u305f\u3002\n\n\u306f\u3058\u3081\u306b\n\nOpenResty\u3068redis\u3092\u5229\u7528\u3057\u3066\u3001\u7c21\u6613\u7684\u306a\u30a2\u30af\u30bb\u30b9\u5236\u5fa1\u30b7\u30b9\u30c6\u30e0\u3092\u8a66\u4f5c\u3057\u3066\u307f\u307e\u3059\u3002\n\u540c\u3058IP\u30a2\u30c9\u30ec\u30b9\u304b\u3089\u4e00\u5b9a\u56de\u6570\u306e\u30a2\u30af\u30bb\u30b9\u304c\u5408\u3063\u305f\u5834\u5408\u306bBAN\u3059\u308b\u3068\u3044\u3046\u3082\u306e\u3067\u3059\u3002\n\n\n\u4eca\u56de\u306f\u96d1\u306b\u300130\u79d2\u4ee5\u5185\u306b10\u30a2\u30af\u30bb\u30b9\u4ee5\u4e0a\u3042\u3063\u305f\u5834\u5408\u300c\u30a2\u30af\u30bb\u30b9\u3057\u3059\u304e\u3067\u3059\u3088\u300d\u3068\u3044\u3046\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u8868\u793a\u3057\u3066\u307f\u307e\u3059\u3002\n\u304a\u4ed5\u4e8b\u306e\u5834\u5408\u3060\u3068\u3001404\u3092\u8fd4\u3059\u3068\u304b\u3001\u305d\u3046\u3044\u3046\u611f\u3058\u306b\u306a\u308b\u304b\u3068\u306f\u601d\u3044\u307e\u3059\u3002\n\n\n\u4eca\u56de\u306f\u540c\u3058EC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9(ubuntu)\u4e0a\u3067\u3001nginx\u3068redis-server\u3092\u52d5\u304b\u3057\u3066\u3044\u307e\u3059\u3002\n\n\n\u305d\u306eEC2\u306bEIP\u3092\u4ed8\u4e0e\u3057\u3066\u3001\u305d\u306e\u307e\u307e\u5916\u304b\u3089\u30a2\u30af\u30bb\u30b9\u3067\u304d\u308b\u3088\u3046\u306a\u72b6\u614b\u3067\u3059\u3002\n\n\n\n\nredis\u306e\u5c0e\u5165\u3068\u8d77\u52d5\nsudo apt-get install redis-server -y\nsudo service redis-server start\n\n\nUbuntu 16.04.1 LTS \u306b OpenResty\u306e\u5c0e\u5165\uff08nginx\u542b\u3080\uff09\nsudo apt-get install libreadline-dev libncurses5-dev libpcre3-dev libssl-dev perl make wget gcc -y\ncd /usr/local\nwget https://openresty.org/download/openresty-1.11.2.2.tar.gz\ntar xvfz openresty-1.11.2.2.tar.gz\ncd openresty-1.11.2.2\n./configure --prefix=/usr/local\nmake\nsudo make install\n\n\nnginx\u306e\u64cd\u4f5c\n\n\u8d77\u52d5\n\n\nsudo /usr/local/nginx/sbin/nginx\n\n\n\u518d\u8aad\u8fbc\n\n\nsudo /usr/local/nginx/sbin/nginx -s reload\n\n\n\u505c\u6b62\n\n\nsudo /usr/local/nginx/sbin/nginx -s stop\n\n\n\n\nnginx\u306e\u8a2d\u5b9a\n\nlocation /\u306e\u3068\u3053\u308d\u3092\u3001sample.lua\u3092\u898b\u308b\u3088\u3046\u306b\u3057\u3066\u3044\u307e\u3059\u3002\n\n/usr/local/nginx/conf/nginx.conf\nworker_processes  1;\n\nevents {\n    worker_connections  1024;\n}\n\n\nhttp {\n    include       mime.types;\n    default_type  application/octet-stream;\n    sendfile        on;\n    keepalive_timeout  65;\n    server {\n        listen       80;\n        server_name  localhost;\n\n        location / {\n                default_type 'text/html';\n                content_by_lua_file /usr/local/luafiles/sample.lua;\n        }\n\n        error_page   500 502 503 504  /50x.html;\n        location = /50x.html {\n            root   html;\n        }\n\n    }\n\n}\n\nlua\u30b9\u30af\u30ea\u30d7\u30c8\u914d\u7f6e\u7528\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u3064\u304f\u308a\u307e\u3059\u3002\nsudo mkdir /usr/local/luafiles\n\n\n\u30a2\u30af\u30bb\u30b9\u5236\u5fa1\u7528\u306elua script\u306e\u5b9f\u88c5\n\u3067\u306f\u3001\u5b9f\u969b\u306b\u3001lua script\u3092\u914d\u7f6e\u3057\u3066\u307f\u307e\u3059\u3002\n\u5b9f\u88c5\u30a4\u30e1\u30fc\u30b8\u306f\u3053\u3093\u306a\u611f\u3058\u3067\u3059\u3002\n/usr/local/luafiles/sample.lua\nlocal redis = require \"resty.redis\"\nlocal redisObject = redis:new()\nredisObject:set_timeout(3000)\n\nlocal ok, err = redisObject:connect(\"127.0.0.1\",6379)\nif not ok then\n  ngx.say(\"connection error\",err)\n  return\nend\n\nredisObject:incr(ngx.var.remote_addr)\nredisObject:expire(ngx.var.remote_addr,30)\n\nlocal counter = redisObject:get(ngx.var.remote_addr)\nif tonumber(counter) > 10 then\n  ngx.say(\"\u30a2\u30af\u30bb\u30b9\u3057\u3059\u304e\u3067\u3059\u3088\")\nelse\n  ngx.say(\"\u3088\u3046\u3053\u305d\")\nend\n\n\n\u52d5\u4f5c\nnginx\u306b\u5bfe\u3057\u3066\u3001\u540c\u4e00IP\u30a2\u30c9\u30ec\u30b9\u304b\u3089\u300130\u79d2\u4ee5\u5185\u306b10\u56de\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3068\u3001\u300c\u30a2\u30af\u30bb\u30b9\u3057\u3059\u304e\u3067\u3059\u3088\u300d\u3068\u3044\u3046\u30e1\u30c3\u30bb\u30fc\u30b8\u304c\u3067\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3057\u305f\u3002\n\n\u307e\u3068\u3081\n\n\u4eca\u56de\u306f\u624b\u629c\u304d\u3067\u30d1\u30c3\u30b1\u30fc\u30b8\u5165\u308c\u307e\u3057\u305f\u304c\u3001\u304a\u4ed5\u4e8b\u3067\u4f7f\u3046\u6642\u306f\u3001nginx\u3084\u3001redis\u306e\u6700\u65b0\u7248\u3092\u4f7f\u3046\u3088\u3046\u306b\u3057\u305f\u3044\u3067\u3059\u306d\u3002\nlua\u306e\u30a8\u30e9\u30fc\u30cf\u30f3\u30c9\u30ea\u30f3\u30b0\u306a\u3069\u306f\u96d1\u306a\u306e\u3067\u3001\u3042\u304f\u307e\u3067\u3082\u30b5\u30f3\u30d7\u30eb\u3068\u3044\u3046\u3053\u3068\u3067\u3054\u5bb9\u8d66\u3092\u3002\n\n\nredis\u306eexpire\u306e\u4ed5\u7d44\u307f\u304b\u3089\u3059\u308b\u3068\u53b3\u5bc6\u306a30s\u306b\u306a\u3063\u3066\u3044\u306a\u3044\u3068\u304b\u3044\u308d\u3044\u308d\u3042\u308a\u307e\u3059\u304c\u3002\u3002\u3002\n\n\n\u304a\u4ed5\u4e8b\u3067\u4f7f\u3046\u969b\u306f\u3044\u308d\u3044\u308d\u8981\u4ef6\u3068\u304b\u3042\u308a\u305d\u3046\u3067\u3059\u304c\u3001\u5c0e\u5165\u306e\u6577\u5c45\u306f\u4f4e\u3044\u306a\u3041\u3068\u611f\u3058\u307e\u3057\u305f\u3002\u6c17\u8efd\u306b\u6d3b\u7528\u3067\u304d\u308b\u306e\u3067\u306f\u306a\u3044\u3067\u3057\u3087\u3046\u304b\u3002\n\n\u3067\u306f\u3067\u306f\u30fc\u03b5\u2261\u2261\uff8d( \u00b4\u0414`)\uff89\n\u3053\u306e\u8a18\u4e8b\u306f [\u30ea\u30af\u30eb\u30fc\u30c8\u30e9\u30a4\u30d5\u30b9\u30bf\u30a4\u30eb\u30a2\u30c9\u30d9\u30f3\u30c8\u30ab\u30ec\u30f3\u30c0\u30fc2016](http://qiita.com/advent-calendar/2016/recruitlifestyle) \u306e11\u65e5\u76ee\u3067\u3059\u3002\n\u30db\u30c3\u30c8\u30da\u30c3\u30d1\u30fc\u30d3\u30e5\u30fc\u30c6\u30a3\u30fc\u3067\u3086\u308b\u3075\u308f\u30a8\u30f3\u30b8\u30cb\u30a2\u3092\u3057\u3066\u3044\u307e\u3059\u3002\u3057\u3083\u305c\u3067\u3059\u3002\n\u5272\u308a\u3068\u6700\u8fd1\u5165\u793e\u3057\u305f\u3070\u3063\u304b\u308a\u3067\u3059\u3002\n\n\u3055\u3066\u3001\u4eca\u56de\u306f\u524d\u304b\u3089\u8a66\u305d\u3046\u3068\u601d\u3063\u3066\u6687\u304c\u306a\u304f\u3066\u30b5\u30dc\u3063\u3066\u3044\u305f\u3001OpenResty\u3067\u5c11\u3057\u904a\u3093\u3067\u307f\u307e\u3057\u305f\u3002\n\n# \u306f\u3058\u3081\u306b\n\n* OpenResty\u3068redis\u3092\u5229\u7528\u3057\u3066\u3001\u7c21\u6613\u7684\u306a\u30a2\u30af\u30bb\u30b9\u5236\u5fa1\u30b7\u30b9\u30c6\u30e0\u3092\u8a66\u4f5c\u3057\u3066\u307f\u307e\u3059\u3002\n* \u540c\u3058IP\u30a2\u30c9\u30ec\u30b9\u304b\u3089\u4e00\u5b9a\u56de\u6570\u306e\u30a2\u30af\u30bb\u30b9\u304c\u5408\u3063\u305f\u5834\u5408\u306bBAN\u3059\u308b\u3068\u3044\u3046\u3082\u306e\u3067\u3059\u3002\n  * \u4eca\u56de\u306f\u96d1\u306b\u300130\u79d2\u4ee5\u5185\u306b10\u30a2\u30af\u30bb\u30b9\u4ee5\u4e0a\u3042\u3063\u305f\u5834\u5408\u300c\u30a2\u30af\u30bb\u30b9\u3057\u3059\u304e\u3067\u3059\u3088\u300d\u3068\u3044\u3046\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u8868\u793a\u3057\u3066\u307f\u307e\u3059\u3002\n  * \u304a\u4ed5\u4e8b\u306e\u5834\u5408\u3060\u3068\u3001404\u3092\u8fd4\u3059\u3068\u304b\u3001\u305d\u3046\u3044\u3046\u611f\u3058\u306b\u306a\u308b\u304b\u3068\u306f\u601d\u3044\u307e\u3059\u3002\n* \u4eca\u56de\u306f\u540c\u3058EC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9(ubuntu)\u4e0a\u3067\u3001nginx\u3068redis-server\u3092\u52d5\u304b\u3057\u3066\u3044\u307e\u3059\u3002\n  * \u305d\u306eEC2\u306bEIP\u3092\u4ed8\u4e0e\u3057\u3066\u3001\u305d\u306e\u307e\u307e\u5916\u304b\u3089\u30a2\u30af\u30bb\u30b9\u3067\u304d\u308b\u3088\u3046\u306a\u72b6\u614b\u3067\u3059\u3002\n\n# redis\u306e\u5c0e\u5165\u3068\u8d77\u52d5\n\n```\nsudo apt-get install redis-server -y\nsudo service redis-server start\n```\n\n# Ubuntu 16.04.1 LTS \u306b OpenResty\u306e\u5c0e\u5165\uff08nginx\u542b\u3080\uff09\n```\nsudo apt-get install libreadline-dev libncurses5-dev libpcre3-dev libssl-dev perl make wget gcc -y\ncd /usr/local\nwget https://openresty.org/download/openresty-1.11.2.2.tar.gz\ntar xvfz openresty-1.11.2.2.tar.gz\ncd openresty-1.11.2.2\n./configure --prefix=/usr/local\nmake\nsudo make install\n```\n\n# nginx\u306e\u64cd\u4f5c\n\n* \u8d77\u52d5\n  * sudo /usr/local/nginx/sbin/nginx\n* \u518d\u8aad\u8fbc\n  * sudo /usr/local/nginx/sbin/nginx -s reload\n* \u505c\u6b62\n  * sudo /usr/local/nginx/sbin/nginx -s stop\n\n# nginx\u306e\u8a2d\u5b9a\n\n* location /\u306e\u3068\u3053\u308d\u3092\u3001sample.lua\u3092\u898b\u308b\u3088\u3046\u306b\u3057\u3066\u3044\u307e\u3059\u3002\n\n/usr/local/nginx/conf/nginx.conf\n\n```\nworker_processes  1;\n\nevents {\n    worker_connections  1024;\n}\n\n\nhttp {\n    include       mime.types;\n    default_type  application/octet-stream;\n    sendfile        on;\n    keepalive_timeout  65;\n    server {\n        listen       80;\n        server_name  localhost;\n\n        location / {\n                default_type 'text/html';\n                content_by_lua_file /usr/local/luafiles/sample.lua;\n        }\n\n        error_page   500 502 503 504  /50x.html;\n        location = /50x.html {\n            root   html;\n        }\n\n    }\n\n}\n```\n\nlua\u30b9\u30af\u30ea\u30d7\u30c8\u914d\u7f6e\u7528\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u3064\u304f\u308a\u307e\u3059\u3002\n\n```\nsudo mkdir /usr/local/luafiles\n```\n\n# \u30a2\u30af\u30bb\u30b9\u5236\u5fa1\u7528\u306elua script\u306e\u5b9f\u88c5\n\n\u3067\u306f\u3001\u5b9f\u969b\u306b\u3001lua script\u3092\u914d\u7f6e\u3057\u3066\u307f\u307e\u3059\u3002\n\u5b9f\u88c5\u30a4\u30e1\u30fc\u30b8\u306f\u3053\u3093\u306a\u611f\u3058\u3067\u3059\u3002\n/usr/local/luafiles/sample.lua\n\n```\nlocal redis = require \"resty.redis\"\nlocal redisObject = redis:new()\nredisObject:set_timeout(3000)\n\nlocal ok, err = redisObject:connect(\"127.0.0.1\",6379)\nif not ok then\n  ngx.say(\"connection error\",err)\n  return\nend\n\nredisObject:incr(ngx.var.remote_addr)\nredisObject:expire(ngx.var.remote_addr,30)\n\nlocal counter = redisObject:get(ngx.var.remote_addr)\nif tonumber(counter) > 10 then\n  ngx.say(\"\u30a2\u30af\u30bb\u30b9\u3057\u3059\u304e\u3067\u3059\u3088\")\nelse\n  ngx.say(\"\u3088\u3046\u3053\u305d\")\nend\n```\n\n# \u52d5\u4f5c\n\nnginx\u306b\u5bfe\u3057\u3066\u3001\u540c\u4e00IP\u30a2\u30c9\u30ec\u30b9\u304b\u3089\u300130\u79d2\u4ee5\u5185\u306b10\u56de\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3068\u3001\u300c\u30a2\u30af\u30bb\u30b9\u3057\u3059\u304e\u3067\u3059\u3088\u300d\u3068\u3044\u3046\u30e1\u30c3\u30bb\u30fc\u30b8\u304c\u3067\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3057\u305f\u3002\n\n\n# \u307e\u3068\u3081\n\n* \u4eca\u56de\u306f\u624b\u629c\u304d\u3067\u30d1\u30c3\u30b1\u30fc\u30b8\u5165\u308c\u307e\u3057\u305f\u304c\u3001\u304a\u4ed5\u4e8b\u3067\u4f7f\u3046\u6642\u306f\u3001nginx\u3084\u3001redis\u306e\u6700\u65b0\u7248\u3092\u4f7f\u3046\u3088\u3046\u306b\u3057\u305f\u3044\u3067\u3059\u306d\u3002\n* lua\u306e\u30a8\u30e9\u30fc\u30cf\u30f3\u30c9\u30ea\u30f3\u30b0\u306a\u3069\u306f\u96d1\u306a\u306e\u3067\u3001\u3042\u304f\u307e\u3067\u3082\u30b5\u30f3\u30d7\u30eb\u3068\u3044\u3046\u3053\u3068\u3067\u3054\u5bb9\u8d66\u3092\u3002\n  * redis\u306eexpire\u306e\u4ed5\u7d44\u307f\u304b\u3089\u3059\u308b\u3068\u53b3\u5bc6\u306a30s\u306b\u306a\u3063\u3066\u3044\u306a\u3044\u3068\u304b\u3044\u308d\u3044\u308d\u3042\u308a\u307e\u3059\u304c\u3002\u3002\u3002\n* \u304a\u4ed5\u4e8b\u3067\u4f7f\u3046\u969b\u306f\u3044\u308d\u3044\u308d\u8981\u4ef6\u3068\u304b\u3042\u308a\u305d\u3046\u3067\u3059\u304c\u3001\u5c0e\u5165\u306e\u6577\u5c45\u306f\u4f4e\u3044\u306a\u3041\u3068\u611f\u3058\u307e\u3057\u305f\u3002\u6c17\u8efd\u306b\u6d3b\u7528\u3067\u304d\u308b\u306e\u3067\u306f\u306a\u3044\u3067\u3057\u3087\u3046\u304b\u3002\n\n\u3067\u306f\u3067\u306f\u30fc\u03b5\u2261\u2261\uff8d( \u00b4\u0414`)\uff89\n", "tags": ["nginx", "openresty", "Redis", "infrastructure"]}