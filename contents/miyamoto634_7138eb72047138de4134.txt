{"context": "Django\u306e\u6a19\u6e96ORM\u306f\u901f\u5ea6\u7684\u306a\u554f\u984c\u304c\u3042\u3063\u305f\u308a\u3059\u308b\u306e\u3067\u3001SQLAlchemy\u3092\u4f7f\u3044\u305f\u304f\u306a\u308b\u5834\u5408\u304c\u3042\u308a\u307e\u3059\u3002\n\u3057\u304b\u3057\u3001SQLAlchemy\u306e\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u306f\u3053\u308c\u3082\u3042\u307e\u308a\u30a4\u30b1\u3066\u306a\u3044\u306e\u3067\u3001\u304b\u308f\u308a\u306bAlembic\u3092\u4f7f\u3063\u3066\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u3092\u884c\u3044\u305f\u3044\u3068\u601d\u3044\u307e\u3059\u3002\n\u305d\u308c\u305e\u308c\u72ec\u7acb\u3057\u305f\u30e2\u30b8\u30e5\u30fc\u30eb\u306a\u306e\u3067\u5404\u3005DB\u306e\u8a2d\u5b9a\u306f\u7570\u306a\u308b\u65b9\u6cd5\u3067\u884c\u3063\u3066\u3044\u307e\u3059\u3002\u30d0\u30e9\u30d0\u30e9\u306b\u66f8\u304f\u306e\u306f\u9762\u5012\u306a\u306e\u3067SQLAlchemy\u3068Alembic\u306fDjango\u306e\u8a2d\u5b9a\u3092\u53c2\u7167\u3059\u308b\u5f62\u306b\u3057\u307e\u3057\u305f\u3002\n\n\u30d5\u30a1\u30a4\u30eb\u69cb\u6210\n\u307e\u305a\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u30d5\u30a1\u30a4\u30eb\u69cb\u6210\u3092\u60f3\u5b9a\u3057\u307e\u3059\u3002\nmyProject/ +--- manage.py\n           +--- alembic/ ---+-- env.py\n           |                +--- \u4ed6\n           +--- alembic.ini\n           +--- myProject/ -+-- settings.py\n           |                +--- \u4ed6\n           +--- myApp/ -----+-- models.py\n                            +--- \u4ed6\n\n\nDjango\u306e\u8a2d\u5b9a\n\u3053\u308c\u306f\u6a19\u6e96\u7684\u306a\u8a2d\u5b9a\u65b9\u6cd5\u3067\u305d\u306e\u307e\u307e\u306b\u3057\u307e\u3059\u3002\nmysql\u3092\u4f7f\u3046\u60f3\u5b9a\u3067\u3059\u3002\n\nsettings.py\n# Database\n\nDATABASE_ENGINE = 'mysql'\nDATABASES = {\n    'default': {\n        'ENGINE': 'django.db.backends.mysql',\n        'NAME': 'xxxx',      # \u9069\u5f53\u3067\u3059\n        'USER': 'xxxx',      # \u9069\u5f53\u3067\u3059\n        'PASSWORD': 'xxxx',  # \u9069\u5f53\u3067\u3059\n        'HOST': 'xxxx',      # \u9069\u5f53\u3067\u3059\n        'PORT': 'xxxx',      # \u9069\u5f53\u3067\u3059\n        'OPTIONS': {},       # \u5fc5\u8981\u304c\u3042\u308c\u3070\n    }\n}\n\nSQLALCHEMY_OPTIONS = {} # SQLAlchemy\u306b\u8a2d\u5b9a\u3092\u884c\u3046\u5fc5\u8981\u304c\u3042\u308c\u3070\n\n\n\nSQLAlchemy\u306e\u8a2d\u5b9a\nsqlalchemy\u306fsession\u3092\u4f5c\u308b\u969b\u306bDB\u306e\u8a2d\u5b9a\u3092\u3059\u308b\u5fc5\u8981\u306b\u306a\u308a\u307e\u3059\u3002\nmyProject/myProject \u306b db.py \u3068\u3044\u3046\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u308asession\u3092\u4f5c\u308b\u5fc5\u8981\u304c\u3042\u308b\u5834\u5408\u3053\u306e\u30d5\u30a1\u30a4\u30eb\u3092\u8aad\u307f\u8fbc\u3093\u3067session\u3092\u4f5c\u308c\u308b\u3088\u3046\u306b\u3057\u307e\u3059\u3002\n\nmyProject/myProject/db.py\n# -*- coding: utf-8 -*-\n\"\"\"db session and util.\"\"\"\n\nfrom myProject import settings\n\nimport sqlalchemy.orm\n\nfrom sqlalchemy.engine.url import URL\n\ndef db_url():\n    db_settings = settings.DATABASES['default']\n    url = URL(drivername=settings.DATABASE_ENGINE,\n        database=db_settings['NAME'],\n        username=db_settings['USER'],\n        password=db_settings['PASSWORD'],\n        host=db_settings['HOST'],\n        port=db_settings['PORT'] or None,\n        query = getattr(db_settings, 'OPTIONS', {})\n        )\n    return url\n\ndef create_engine():\n    try:\n        url = db_url()\n    except:\n        raise\n    options = getattr(settings.DATABASES['default'], 'SQLALCHEMY_OPTIONS', {})\n    engine = sqlalchemy.create_engine(url, **options)\n    return engine\n\ndef make_session():\n    Session = sqlalchemy.orm.sessionmaker(bind=create_engine())\n    session = Session()\n    return session\n\n\n\nAlembic\n\u57fa\u672c\u7684\u306balembic\u306eDB\u306e\u8a2d\u5b9a\u306falembic.ini\u304b\u3089\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\u3057\u304b\u3057\u3001\u3053\u308c\u3060\u3068\u305d\u306e\u307e\u307e\u3067\u306fsettings.py\u30d5\u30a1\u30a4\u30eb\u304b\u3089\u53c2\u7167\u3059\u308b\u5f62\u3067\u306f\u306a\u304f\u4e0d\u4fbf\u306a\u306e\u3067\u3001alembic/env.py \u3067\u52d5\u7684\u306b\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\nenv.py\n### \u4e00\u90e8\u629c\u7c8b\nimport os\nimport sys\n\nfrom alembic import context\n\n# \u3053\u306e\u30d5\u30a1\u30a4\u30eb\u304c\u3042\u308b\u4f4d\u7f6e\u7684\u306b\u305d\u306e\u307e\u307e\u3060\u3068settings\u304c\u8aad\u307f\u8fbc\u3081\u306a\u3044\u306e\u3067\u30d1\u30b9\u3092\u901a\u3059\npath = os.path.join(os.path.dirname(__file__), '../')\nsys.path.append(path)\n\nfrom user import models\nfrom myProject.db import db_url\n\nconfig = context.config\n\n# URL\u3092\u8a2d\u5b9a\nurl = str(db_url())\nconfig.set_main_option(\"sqlalchemy.url\", url)\n\n\nDjango\u306e\u6a19\u6e96ORM\u306f\u901f\u5ea6\u7684\u306a\u554f\u984c\u304c\u3042\u3063\u305f\u308a\u3059\u308b\u306e\u3067\u3001SQLAlchemy\u3092\u4f7f\u3044\u305f\u304f\u306a\u308b\u5834\u5408\u304c\u3042\u308a\u307e\u3059\u3002\n\u3057\u304b\u3057\u3001SQLAlchemy\u306e\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u306f\u3053\u308c\u3082\u3042\u307e\u308a\u30a4\u30b1\u3066\u306a\u3044\u306e\u3067\u3001\u304b\u308f\u308a\u306bAlembic\u3092\u4f7f\u3063\u3066\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u3092\u884c\u3044\u305f\u3044\u3068\u601d\u3044\u307e\u3059\u3002\n \n\u305d\u308c\u305e\u308c\u72ec\u7acb\u3057\u305f\u30e2\u30b8\u30e5\u30fc\u30eb\u306a\u306e\u3067\u5404\u3005DB\u306e\u8a2d\u5b9a\u306f\u7570\u306a\u308b\u65b9\u6cd5\u3067\u884c\u3063\u3066\u3044\u307e\u3059\u3002\u30d0\u30e9\u30d0\u30e9\u306b\u66f8\u304f\u306e\u306f\u9762\u5012\u306a\u306e\u3067SQLAlchemy\u3068Alembic\u306fDjango\u306e\u8a2d\u5b9a\u3092\u53c2\u7167\u3059\u308b\u5f62\u306b\u3057\u307e\u3057\u305f\u3002\n\n#\u30d5\u30a1\u30a4\u30eb\u69cb\u6210\n\n\u307e\u305a\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u30d5\u30a1\u30a4\u30eb\u69cb\u6210\u3092\u60f3\u5b9a\u3057\u307e\u3059\u3002\n\n```\nmyProject/ +--- manage.py\n           +--- alembic/ ---+-- env.py\n           |                +--- \u4ed6\n           +--- alembic.ini\n           +--- myProject/ -+-- settings.py\n           |                +--- \u4ed6\n           +--- myApp/ -----+-- models.py\n                            +--- \u4ed6\n```\n\n#Django\u306e\u8a2d\u5b9a\n\n\u3053\u308c\u306f\u6a19\u6e96\u7684\u306a\u8a2d\u5b9a\u65b9\u6cd5\u3067\u305d\u306e\u307e\u307e\u306b\u3057\u307e\u3059\u3002\nmysql\u3092\u4f7f\u3046\u60f3\u5b9a\u3067\u3059\u3002\n\n```python:settings.py\n# Database\n \nDATABASE_ENGINE = 'mysql'\nDATABASES = {\n    'default': {\n        'ENGINE': 'django.db.backends.mysql',\n        'NAME': 'xxxx',      # \u9069\u5f53\u3067\u3059\n        'USER': 'xxxx',      # \u9069\u5f53\u3067\u3059\n        'PASSWORD': 'xxxx',  # \u9069\u5f53\u3067\u3059\n        'HOST': 'xxxx',      # \u9069\u5f53\u3067\u3059\n        'PORT': 'xxxx',      # \u9069\u5f53\u3067\u3059\n        'OPTIONS': {},       # \u5fc5\u8981\u304c\u3042\u308c\u3070\n    }\n}\n \nSQLALCHEMY_OPTIONS = {} # SQLAlchemy\u306b\u8a2d\u5b9a\u3092\u884c\u3046\u5fc5\u8981\u304c\u3042\u308c\u3070\n```\n\n#SQLAlchemy\u306e\u8a2d\u5b9a\n\nsqlalchemy\u306fsession\u3092\u4f5c\u308b\u969b\u306bDB\u306e\u8a2d\u5b9a\u3092\u3059\u308b\u5fc5\u8981\u306b\u306a\u308a\u307e\u3059\u3002\nmyProject/myProject \u306b db.py \u3068\u3044\u3046\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u308asession\u3092\u4f5c\u308b\u5fc5\u8981\u304c\u3042\u308b\u5834\u5408\u3053\u306e\u30d5\u30a1\u30a4\u30eb\u3092\u8aad\u307f\u8fbc\u3093\u3067session\u3092\u4f5c\u308c\u308b\u3088\u3046\u306b\u3057\u307e\u3059\u3002\n\n```python:myProject/myProject/db.py\n# -*- coding: utf-8 -*-\n\"\"\"db session and util.\"\"\"\n \nfrom myProject import settings\n \nimport sqlalchemy.orm\n \nfrom sqlalchemy.engine.url import URL\n \ndef db_url():\n    db_settings = settings.DATABASES['default']\n    url = URL(drivername=settings.DATABASE_ENGINE,\n        database=db_settings['NAME'],\n        username=db_settings['USER'],\n        password=db_settings['PASSWORD'],\n        host=db_settings['HOST'],\n        port=db_settings['PORT'] or None,\n        query = getattr(db_settings, 'OPTIONS', {})\n        )\n    return url\n \ndef create_engine():\n    try:\n        url = db_url()\n    except:\n        raise\n    options = getattr(settings.DATABASES['default'], 'SQLALCHEMY_OPTIONS', {})\n    engine = sqlalchemy.create_engine(url, **options)\n    return engine\n \ndef make_session():\n    Session = sqlalchemy.orm.sessionmaker(bind=create_engine())\n    session = Session()\n    return session\n```\n\n#Alembic\n\n\u57fa\u672c\u7684\u306balembic\u306eDB\u306e\u8a2d\u5b9a\u306falembic.ini\u304b\u3089\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\u3057\u304b\u3057\u3001\u3053\u308c\u3060\u3068\u305d\u306e\u307e\u307e\u3067\u306fsettings.py\u30d5\u30a1\u30a4\u30eb\u304b\u3089\u53c2\u7167\u3059\u308b\u5f62\u3067\u306f\u306a\u304f\u4e0d\u4fbf\u306a\u306e\u3067\u3001alembic/env.py \u3067\u52d5\u7684\u306b\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\n```python:env.py\n### \u4e00\u90e8\u629c\u7c8b\nimport os\nimport sys\n  \nfrom alembic import context\n  \n# \u3053\u306e\u30d5\u30a1\u30a4\u30eb\u304c\u3042\u308b\u4f4d\u7f6e\u7684\u306b\u305d\u306e\u307e\u307e\u3060\u3068settings\u304c\u8aad\u307f\u8fbc\u3081\u306a\u3044\u306e\u3067\u30d1\u30b9\u3092\u901a\u3059\npath = os.path.join(os.path.dirname(__file__), '../')\nsys.path.append(path)\n \nfrom user import models\nfrom myProject.db import db_url\n  \nconfig = context.config\n \n# URL\u3092\u8a2d\u5b9a\nurl = str(db_url())\nconfig.set_main_option(\"sqlalchemy.url\", url)\n```\n", "tags": ["Django", "sqlalchemy", "Alembic", "Python", "python3"]}