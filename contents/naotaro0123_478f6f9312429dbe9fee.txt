{"context": " More than 1 year has passed since last update.\u9700\u8981\u304c\u3042\u308a\u305d\u3046\u306a\u306e\u3067\u3084\u308a\u65b9\u3092\u30e1\u30e2\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\n\u958b\u767a\u74b0\u5883\n\u30fbLive2D_SDK_Unity_2.1.00_1_jp\n\u30fbUnity5.2.0f3\n\u30fbjokerscript_v041\n\u30fblive2d_for_joker_plugin_031\n\n\u30de\u30a6\u30b9\u30c9\u30e9\u30c3\u30b0\u306e\u3084\u308a\u65b9\nLive2D Unity SDK\u306eDemo\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u3067\u4e00\u756a\u30b7\u30f3\u30d7\u30eb\u306a\u30de\u30a6\u30b9\u30c9\u30e9\u30c3\u30b0\u304c\u3067\u304d\u307e\u3059\u3002\n\u8981\u3059\u308b\u306b\u3053\u308c\u3092JokerScript\u306b\u7d44\u307f\u8fbc\u3081\u3070OK\u3067\u3059\u3063\uff01\nJokerScript\u306e\u65b9\u3082Live2D\u306e\u30b9\u30af\u30ea\u30d7\u30c8\u306f\u3001SimpleModel.cs\u3068\u540c\u540d\u306e\u30d5\u30a1\u30a4\u30eb\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002\n\uff11\uff09L2DTargetPoint.cs\u3092\u30a4\u30f3\u30dd\u30fc\u30c8\nJokerScript\u306e\u65b9\u306b\u30de\u30a6\u30b9\u30c9\u30e9\u30c3\u30b0\u7528\u306e\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u30a4\u30f3\u30dd\u30fc\u30c8\u3057\u307e\u3059\n\n\uff12\uff09SimpleModel.cs\u306b\u30de\u30a6\u30b9\u30c9\u30e9\u30c3\u30b0\u51e6\u7406\u3092\u8ffd\u52a0\n\nSimpleModel.cs\nusing UnityEngine;\nusing System;\nusing System.Collections;\nusing System.Collections.Generic;\nusing System.Text.RegularExpressions;\nusing live2d.framework;\nusing live2d;\n\n\npublic class SimpleModel : MonoBehaviour\n{\n    public TextAsset modelJson;                             // JSON\u30d5\u30a1\u30a4\u30eb\n    private TextAsset mocFile;                              // Moc\u30d5\u30a1\u30a4\u30eb\n    private Texture2D[] textures;                           // \u30c6\u30af\u30b9\u30c1\u30e3\u30d5\u30a1\u30a4\u30eb\n    private TextAsset[] mtnFiles;                           // \u30e2\u30fc\u30b7\u30e7\u30f3\u30d5\u30a1\u30a4\u30eb\n    private string[] mtnFilenms;                            // \u30e2\u30fc\u30b7\u30e7\u30f3\u30d5\u30a1\u30a4\u30eb\u540d\n    private int[] mtnFadeines;                              // \u30d5\u30a7\u30fc\u30c9\u30a4\u30f3\n    private int[] mtnFadeoutes;                             // \u30d5\u30a7\u30fc\u30c9\u30a2\u30a6\u30c8\n    private AudioClip[] soundFiles;                         // \u97f3\u58f0\u30d5\u30a1\u30a4\u30eb\n    private TextAsset poseFile;                             // \u30dd\u30fc\u30ba\u30d5\u30a1\u30a4\u30eb \n    private TextAsset physicsFile;                          // \u7269\u7406\u6f14\u7b97\u30d5\u30a1\u30a4\u30eb \n    private Live2DModelUnity live2DModel;\n    private Live2DMotion motion;                            // \u30e2\u30fc\u30b7\u30e7\u30f3\u30af\u30e9\u30b9\n    private MotionQueueManager motionManager;               // \u30e2\u30fc\u30b7\u30e7\u30f3\u7ba1\u7406\u30af\u30e9\u30b9\n    private L2DPose pose;                                   // \u30d1\u30fc\u30c4\u5207\u308a\u66ff\u3048\u30af\u30e9\u30b9\n    private L2DPhysics physics;                             // \u7269\u7406\u6f14\u7b97\u30af\u30e9\u30b9\n    private Matrix4x4 live2DCanvasPos;                      // \u8868\u793a\u4f4d\u7f6e\n    private int motioncnt = 0;                              // \u30d5\u30a1\u30a4\u30eb\u9805\u756a\n    private EyeBlinkMotion eyeBlink = new EyeBlinkMotion();\n    private L2DTargetPoint dragMgr = new L2DTargetPoint();\n\n\n    /// <summary>\n    /// \u521d\u671f\u5316\u51e6\u7406\n    /// </summary>\n    void Start()\n    {\n        // JSON\u3092\u8aad\u8fbc\n        Json_Read();\n        // Live2D\u521d\u671f\u5316\n        Live2D.init();\n        // \u30e2\u30fc\u30b7\u30e7\u30f3\u7ba1\u7406\u30af\u30e9\u30b9\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\n        motionManager = new MotionQueueManager();\n        // \u30e2\u30fc\u30b7\u30e7\u30f3\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\n        motion = Live2DMotion.loadMotion(mtnFiles[0].bytes);\n        // \u30e2\u30fc\u30b7\u30e7\u30f3\u306e\u518d\u751f\n        motionManager.startMotion(motion, false);\n        // \u8868\u793a\u4f4d\u7f6e\n        float modelWidth = live2DModel.getCanvasWidth();\n        live2DCanvasPos = Matrix4x4.Ortho(0, modelWidth, modelWidth, 0, -50.0f, 50.0f);\n    }\n\n\n    /// <summary>\n    /// \u66f4\u65b0\u51e6\u7406\n    /// </summary>\n    void Update()\n    {\n        // \u518d\u751f\u4e2d\u306e\u30e2\u30fc\u30b7\u30e7\u30f3\u304b\u3089\u30e2\u30c7\u30eb\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u66f4\u65b0\n        if(motionManager != null )\n        {\n            motionManager.updateParam(live2DModel);\n        }\n        // \u30dd\u30fc\u30ba\u306e\u8a2d\u5b9a\n        if (pose != null) pose.updateParam(live2DModel);\n        // \u7269\u7406\u6f14\u7b97\u306e\u8a2d\u5b9a\n        if (physics != null) physics.updateParam(live2DModel);\n\n        // \u30e2\u30fc\u30b7\u30e7\u30f3\u518d\u751f\u304c\u7d42\u4e86\u3057\u305f\u5834\u5408\n        if (motionManager != null && motionManager.isFinished())\n        {\n            // \u30e2\u30fc\u30b7\u30e7\u30f3\u3092\u30ed\u30fc\u30c9\u3059\u308b\n            motion = Live2DMotion.loadMotion(mtnFiles[motioncnt].bytes);\n            // \u30d5\u30a7\u30fc\u30c9\u30a4\u30f3\u306e\u8a2d\u5b9a\n            motion.setFadeIn(mtnFadeines[motioncnt]);\n            // \u30d5\u30a7\u30fc\u30c9\u30a2\u30a6\u30c8\u306e\u8a2d\u5b9a\n            motion.setFadeOut(mtnFadeoutes[motioncnt]);\n            // \u30e2\u30fc\u30b7\u30e7\u30f3\u518d\u751f\n            motionManager.startMotion(motion, false);\n            // \u97f3\u58f0\u518d\u751f\n            if (soundFiles[motioncnt] != null)\n            {\n                GetComponent<AudioSource>().clip = soundFiles[motioncnt];\n                GetComponent<AudioSource>().Play();\n            }\n        }\n        var pos = Input.mousePosition;\n        if (Input.GetMouseButtonDown(0))\n        {\n            //\n        }\n        else if (Input.GetMouseButton(0))\n        {\n            dragMgr.Set(pos.x / Screen.width * 2 - 1, pos.y / Screen.height * 2 - 1);\n        }\n        else if (Input.GetMouseButtonUp(0))\n        {\n            dragMgr.Set(0, 0);\n        }\n\n\n        dragMgr.update();\n        live2DModel.setParamFloat(\"PARAM_ANGLE_X\", dragMgr.getX() * 30);\n        live2DModel.setParamFloat(\"PARAM_ANGLE_Y\", dragMgr.getY() * 30);\n\n        live2DModel.setParamFloat(\"PARAM_BODY_ANGLE_X\", dragMgr.getX() * 10);\n\n        live2DModel.setParamFloat(\"PARAM_EYE_BALL_X\", -dragMgr.getX());\n        live2DModel.setParamFloat(\"PARAM_EYE_BALL_Y\", -dragMgr.getY());\n\n        double timeSec = UtSystem.getUserTimeMSec() / 1000.0;\n        double t = timeSec * 2 * Math.PI;\n        live2DModel.setParamFloat(\"PARAM_BREATH\", (float)(0.5f + 0.5f * Math.Sin(t / 3.0)));\n\n        eyeBlink.setParam(live2DModel);\n        // \u9802\u70b9\u306e\u66f4\u65b0\n        live2DModel.update();\n    }\n\n\n    /// <summary>\n    /// \u30ab\u30e1\u30e9\u304c\u30b7\u30fc\u30f3\u306b\u30ec\u30f3\u30c0\u30ea\u30f3\u30b0\u5f8c\u306b\u547c\u3070\u308c\u308b\n    /// </summary>\n    void OnRenderObject()\n    {\n        if (live2DModel == null) return;\n        live2DModel.setMatrix(transform.localToWorldMatrix * live2DCanvasPos);\n        // \u30a2\u30d7\u30ea\u304c\u7d42\u4e86\u3057\u3066\u3044\u305f\u5834\u5408\n        if (!Application.isPlaying)\n        {\n            live2DModel.draw();\n            return;\n        }\n        // \u30e2\u30c7\u30eb\u306e\u63cf\u753b\n        live2DModel.draw();\n    }\n\n\n    /// <summary>\n    /// JSON\u3092\u8aad\u307f\u8fbc\u3080\n    /// </summary>\n    void Json_Read()\n    {\n        // model.json\u3092\u8aad\u307f\u8fbc\u3080\n        char[] buf = modelJson.text.ToCharArray();\n        Value json = Json.parseFromBytes(buf);\n\n\n        // \u30e2\u30c7\u30eb\u3092\u8aad\u307f\u8fbc\u3080\n        mocFile = new TextAsset();\n        mocFile = (Resources.Load(json.get(\"model\").toString(), typeof(TextAsset)) as TextAsset);\n        live2DModel = Live2DModelUnity.loadModel(mocFile.bytes);\n\n        // \u30c6\u30af\u30b9\u30c1\u30e3\u3092\u8aad\u307f\u8fbc\u3080\n        int texture_num = json.get(\"textures\").getVector(null).Count;\n        textures = new Texture2D[texture_num];\n\n        for (int i = 0; i < texture_num; i++)\n        {\n            // \u4e0d\u8981\u306a\u62e1\u5f35\u5b50\u3092\u524a\u9664\n            string texturenm = Regex.Replace(json.get(\"textures\").get(i).toString(), \".png$\", \"\");\n            textures[i] = (Resources.Load(texturenm, typeof(Texture2D)) as Texture2D);\n            live2DModel.setTexture(i, textures[i]);\n        }\n\n        // \u30e2\u30fc\u30b7\u30e7\u30f3\u306e\u914d\u4e0b\u306e\u30ad\u30fc\u3092\u53d6\u5f97\n        Dictionary<string, Value> motion_keys = json.get(\"motions\").getMap(null);\n        int mtn_tag = 0;\n        int mtn_num = 0;\n        string[] motion_tags = new string[motion_keys.Count];\n\n        // \u8aad\u8fbc\u30e2\u30fc\u30b7\u30e7\u30f3\u30d5\u30a1\u30a4\u30eb\u6570\u30ab\u30a6\u30f3\u30c8\u7528\n        foreach (var mtnkey in motion_keys)\n        {\n            // motions\u914d\u4e0b\u306e\u30ad\u30fc\u3092\u53d6\u5f97\n            motion_tags[mtn_tag] = mtnkey.Key.ToString();\n            // \u8aad\u307f\u8fbc\u3080\u30e2\u30fc\u30b7\u30e7\u30f3\u30d5\u30a1\u30a4\u30eb\u6570\u3092\u53d6\u5f97\n            mtn_num += json.get(\"motions\").get(motion_tags[mtn_tag]).getVector(null).Count;\n            mtn_tag++;\n        }\n        // \u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u5316\n        mtnFiles = new TextAsset[mtn_num];\n        soundFiles = new AudioClip[mtn_num];\n        mtnFadeines = new int[mtn_num];\n        mtnFadeoutes = new int[mtn_num];\n\n        mtn_tag = 0;\n        mtn_num = 0;\n        // \u30e2\u30fc\u30b7\u30e7\u30f3\u30d5\u30a1\u30a4\u30eb\u6570\u5206JSON\u8aad\u8fbc\n        foreach (var mtnkey in motion_keys)\n        {\n            // \u30e2\u30fc\u30b7\u30e7\u30f3\u3068\u30b5\u30a6\u30f3\u30c9\u3092\u8aad\u307f\u8fbc\u3080(motions\u914d\u4e0b\u306e\u30bf\u30b0\u3092\u8aad\u307f\u8fbc\u3080)\n            Value motionPaths = json.get(\"motions\").get(motion_tags[mtn_tag]);\n            int motionNum = motionPaths.getVector(null).Count;\n\n            for (int m = 0; m < motionNum; m++)\n            {\n                mtnFiles[mtn_num] = (Resources.Load(motionPaths.get(m).get(\"file\").toString()) as TextAsset);\n                // \u30b5\u30a6\u30f3\u30c9\u30d5\u30a1\u30a4\u30eb\u304c\u3042\u308c\u3070\u5165\u308c\u308b\n                if (motionPaths.get(m).getMap(null).ContainsKey(\"sound\"))\n                {\n                    // \u4e0d\u8981\u306a\u62e1\u5f35\u5b50\u3092\u524a\u9664\n                    string soundnm = Regex.Replace(Regex.Replace(motionPaths.get(m).get(\"sound\").toString(), \".mp3$\", \"\"), \".wav$\", \"\");\n                    soundFiles[mtn_num] = (Resources.Load(soundnm, typeof(AudioClip)) as AudioClip);\n                }\n                //\u30d5\u30a7\u30fc\u30c9\u30a4\u30f3\n                if (motionPaths.get(m).getMap(null).ContainsKey(\"fade_in\"))\n                {\n                    mtnFadeines[mtn_num] = int.Parse(motionPaths.get(m).get(\"fade_in\").toString());\n                }\n                //\u30d5\u30a7\u30fc\u30c9\u30a2\u30a6\u30c8\n                if (motionPaths.get(m).getMap(null).ContainsKey(\"fade_out\"))\n                {\n                    mtnFadeoutes[mtn_num] = int.Parse(motionPaths.get(m).get(\"fade_out\").toString());\n                }\n                mtn_num++;\n            }\n            mtn_tag++;\n        }\n\n        // \u30dd\u30fc\u30ba\u30d5\u30a1\u30a4\u30eb\u3092\u8aad\u307f\u8fbc\u3080\n        if (json.getMap(null).ContainsKey(\"pose\"))\n        {\n            Value posepath = json.get(\"pose\");\n            poseFile = new TextAsset();\n            poseFile = (Resources.Load(posepath.toString(), typeof(TextAsset)) as TextAsset);\n            // pose.json\u3092\u8aad\u307f\u8fbc\u3080\n            char[] posebuf = poseFile.text.ToCharArray();\n            // \u30d1\u30fc\u30c4\u5207\u308a\u66ff\u3048\u30af\u30e9\u30b9\u3078\u6e21\u3059\n            pose = L2DPose.load(posebuf);\n        }\n\n        // \u7269\u7406\u6f14\u7b97\u30d5\u30a1\u30a4\u30eb\u3092\u8aad\u307f\u8fbc\u3080\n        if (json.getMap(null).ContainsKey(\"physics\"))\n        {\n            Value physicpath = json.get(\"physics\");\n            physicsFile = new TextAsset();\n            physicsFile = (Resources.Load(physicpath.toString(), typeof(TextAsset)) as TextAsset);\n            // physics.json\u3092\u8aad\u307f\u8fbc\u3080\n            char[] physicsbuf = physicsFile.text.ToCharArray();\n            // \u7269\u7406\u6f14\u7b97\u30af\u30e9\u30b9\u3078\u6e21\u3059\n            physics = L2DPhysics.load(physicsbuf);\n        }\n    }\n\n\n    /// <summary>\n    /// \u30e2\u30fc\u30b7\u30e7\u30f3\u306e\u30c1\u30a7\u30f3\u30b8\n    /// </summary>\n    /// <param name=\"storage\">\u30e2\u30fc\u30b7\u30e7\u30f3\u30d5\u30a1\u30a4\u30eb\u540d</param>\n    /// <param name=\"idle\">\u30a2\u30a4\u30c9\u30ea\u30f3\u30b0\u6709\u7121</param>\n    public void Motion_change(string storage, string idle)\n    {\n        int cnt = 0;\n        for (int m = 0; m < mtnFiles.Length; m++)\n        {\n            if (mtnFiles[m].name == storage)\n            {\n                break;\n            }\n            cnt++;\n        }\n\n        // \u30a2\u30a4\u30c9\u30eb\u30d5\u30e9\u30b0\u304cON\u306a\u3089\u3001\u6307\u5b9a\u3057\u305f\u30e2\u30fc\u30b7\u30e7\u30f3\u3092\u30a2\u30a4\u30c9\u30ea\u30f3\u30b0\u3055\u305b\u308b\n        if (idle != \"\")\n        {\n            motioncnt = cnt;\n        }\n\n        /*\n        int cnt = 0;\n        string filenm = Regex.Replace (storage, \".bytes$\",\"\");\n        // \u30e2\u30fc\u30b7\u30e7\u30f3\u30d5\u30a1\u30a4\u30eb\u540d\u3092\u691c\u7d22\n        foreach (string mtnNm in mtnFilenms)\n        {\n            if(mtnNm == filenm)\n            {\n                break;\n            }\n            cnt++;\n        }\n        */\n\n        // \u30e2\u30fc\u30b7\u30e7\u30f3\u306e\u30ed\u30fc\u30c9\u3092\u3059\u308b\n        motion = Live2DMotion.loadMotion(mtnFiles[cnt].bytes);\n        // \u30d5\u30a7\u30fc\u30c9\u30a4\u30f3\u306e\u8a2d\u5b9a\n        motion.setFadeIn(mtnFadeines[cnt]);\n        // \u30d5\u30a7\u30fc\u30c9\u30a2\u30a6\u30c8\u306e\u8a2d\u5b9a\n        motion.setFadeOut(mtnFadeoutes[cnt]);\n        // \u30e2\u30fc\u30b7\u30e7\u30f3\u518d\u751f\n        motionManager.startMotion(motion, false);\n        // \u30b5\u30a6\u30f3\u30c9\u304c\u3042\u308c\u3070\u30dc\u30a4\u30b9\u518d\u751f\n\n        if (soundFiles[cnt] != null)\n        {\n            GetComponent<AudioSource>().clip = soundFiles[cnt];\n            GetComponent<AudioSource>().Play();\n        }\n    }\n}\n\n\n\u306f\u3044\u3001\u3053\u308c\u3067\u5b8c\u6210\u3057\u307e\u3057\u305f\uff01\nJokerScript\u306b\u306fLive2D\u306e\u30bd\u30fc\u30b9\u306f\u7d50\u69cb\u308f\u304b\u308a\u3084\u3059\u3044\u5f62\u3060\u3068\u601d\u3046\u306e\u3067\u3001\u81ea\u7531\u306b\u30ab\u30b9\u30bf\u30e0\u3057\u3061\u3083\u3063\u3066\u4e0b\u3055\u3044\u3002\n\n\u9700\u8981\u304c\u3042\u308a\u305d\u3046\u306a\u306e\u3067\u3084\u308a\u65b9\u3092\u30e1\u30e2\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\n\n# \u958b\u767a\u74b0\u5883\n\n\u30fbLive2D_SDK_Unity_2.1.00_1_jp\n\u30fbUnity5.2.0f3\n\u30fbjokerscript_v041\n\u30fblive2d_for_joker_plugin_031\n\n# \u30de\u30a6\u30b9\u30c9\u30e9\u30c3\u30b0\u306e\u3084\u308a\u65b9\nLive2D Unity SDK\u306eDemo\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u3067\u4e00\u756a\u30b7\u30f3\u30d7\u30eb\u306a\u30de\u30a6\u30b9\u30c9\u30e9\u30c3\u30b0\u304c\u3067\u304d\u307e\u3059\u3002\n\u8981\u3059\u308b\u306b\u3053\u308c\u3092JokerScript\u306b\u7d44\u307f\u8fbc\u3081\u3070OK\u3067\u3059\u3063\uff01\nJokerScript\u306e\u65b9\u3082Live2D\u306e\u30b9\u30af\u30ea\u30d7\u30c8\u306f\u3001SimpleModel.cs\u3068\u540c\u540d\u306e\u30d5\u30a1\u30a4\u30eb\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002\n\n**\uff11\uff09L2DTargetPoint.cs\u3092\u30a4\u30f3\u30dd\u30fc\u30c8**\nJokerScript\u306e\u65b9\u306b\u30de\u30a6\u30b9\u30c9\u30e9\u30c3\u30b0\u7528\u306e\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u30a4\u30f3\u30dd\u30fc\u30c8\u3057\u307e\u3059\n![UnityInspector.png](https://qiita-image-store.s3.amazonaws.com/0/15028/1a69af63-f615-e132-8d7c-94ca0fab18ac.png)\n\n**\uff12\uff09SimpleModel.cs\u306b\u30de\u30a6\u30b9\u30c9\u30e9\u30c3\u30b0\u51e6\u7406\u3092\u8ffd\u52a0**\n\n```csharp:SimpleModel.cs\nusing UnityEngine;\nusing System;\nusing System.Collections;\nusing System.Collections.Generic;\nusing System.Text.RegularExpressions;\nusing live2d.framework;\nusing live2d;\n\n\npublic class SimpleModel : MonoBehaviour\n{\n    public TextAsset modelJson;\t\t\t\t\t\t\t\t// JSON\u30d5\u30a1\u30a4\u30eb\n    private TextAsset mocFile;\t\t\t\t\t\t\t\t// Moc\u30d5\u30a1\u30a4\u30eb\n    private Texture2D[] textures;\t\t\t\t\t\t\t// \u30c6\u30af\u30b9\u30c1\u30e3\u30d5\u30a1\u30a4\u30eb\n    private TextAsset[] mtnFiles;\t\t\t\t\t\t\t// \u30e2\u30fc\u30b7\u30e7\u30f3\u30d5\u30a1\u30a4\u30eb\n    private string[] mtnFilenms;\t\t\t\t\t\t\t// \u30e2\u30fc\u30b7\u30e7\u30f3\u30d5\u30a1\u30a4\u30eb\u540d\n\tprivate int[] mtnFadeines;\t\t\t\t\t\t\t\t// \u30d5\u30a7\u30fc\u30c9\u30a4\u30f3\n\tprivate int[] mtnFadeoutes;\t\t\t\t\t\t\t\t// \u30d5\u30a7\u30fc\u30c9\u30a2\u30a6\u30c8\n\tprivate AudioClip[] soundFiles;\t\t\t\t\t\t\t// \u97f3\u58f0\u30d5\u30a1\u30a4\u30eb\n\tprivate TextAsset poseFile;\t\t\t\t\t\t\t\t// \u30dd\u30fc\u30ba\u30d5\u30a1\u30a4\u30eb \n\tprivate TextAsset physicsFile;\t\t\t\t\t\t\t// \u7269\u7406\u6f14\u7b97\u30d5\u30a1\u30a4\u30eb \n\tprivate Live2DModelUnity live2DModel;\n    private Live2DMotion motion;\t\t\t\t\t\t\t// \u30e2\u30fc\u30b7\u30e7\u30f3\u30af\u30e9\u30b9\n    private MotionQueueManager motionManager;\t\t\t\t// \u30e2\u30fc\u30b7\u30e7\u30f3\u7ba1\u7406\u30af\u30e9\u30b9\n\tprivate L2DPose pose;\t\t\t\t\t\t\t\t\t// \u30d1\u30fc\u30c4\u5207\u308a\u66ff\u3048\u30af\u30e9\u30b9\n\tprivate L2DPhysics physics;\t\t\t\t\t\t\t\t// \u7269\u7406\u6f14\u7b97\u30af\u30e9\u30b9\n    private Matrix4x4 live2DCanvasPos;\t\t\t\t\t\t// \u8868\u793a\u4f4d\u7f6e\n\tprivate int motioncnt = 0;\t\t\t\t\t\t\t\t// \u30d5\u30a1\u30a4\u30eb\u9805\u756a\n\tprivate EyeBlinkMotion eyeBlink = new EyeBlinkMotion();\n\tprivate L2DTargetPoint dragMgr = new L2DTargetPoint();\n\n\t\n\t/// <summary>\n    /// \u521d\u671f\u5316\u51e6\u7406\n    /// </summary>\n    void Start()\n    {\n        // JSON\u3092\u8aad\u8fbc\n        Json_Read();\n        // Live2D\u521d\u671f\u5316\n        Live2D.init();\n        // \u30e2\u30fc\u30b7\u30e7\u30f3\u7ba1\u7406\u30af\u30e9\u30b9\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\n        motionManager = new MotionQueueManager();\n        // \u30e2\u30fc\u30b7\u30e7\u30f3\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\n        motion = Live2DMotion.loadMotion(mtnFiles[0].bytes);\n        // \u30e2\u30fc\u30b7\u30e7\u30f3\u306e\u518d\u751f\n        motionManager.startMotion(motion, false);\n        // \u8868\u793a\u4f4d\u7f6e\n        float modelWidth = live2DModel.getCanvasWidth();\n        live2DCanvasPos = Matrix4x4.Ortho(0, modelWidth, modelWidth, 0, -50.0f, 50.0f);\n    }\n\n\n    /// <summary>\n    /// \u66f4\u65b0\u51e6\u7406\n    /// </summary>\n    void Update()\n    {\n\t\t// \u518d\u751f\u4e2d\u306e\u30e2\u30fc\u30b7\u30e7\u30f3\u304b\u3089\u30e2\u30c7\u30eb\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u66f4\u65b0\n\t\tif(motionManager != null )\n\t\t{\n\t\t\tmotionManager.updateParam(live2DModel);\n\t\t}\n\t\t// \u30dd\u30fc\u30ba\u306e\u8a2d\u5b9a\n\t\tif (pose != null) pose.updateParam(live2DModel);\n\t\t// \u7269\u7406\u6f14\u7b97\u306e\u8a2d\u5b9a\n\t\tif (physics != null) physics.updateParam(live2DModel);\n\n\t\t// \u30e2\u30fc\u30b7\u30e7\u30f3\u518d\u751f\u304c\u7d42\u4e86\u3057\u305f\u5834\u5408\n\t\tif (motionManager != null && motionManager.isFinished())\n\t\t{\n\t\t\t// \u30e2\u30fc\u30b7\u30e7\u30f3\u3092\u30ed\u30fc\u30c9\u3059\u308b\n\t\t\tmotion = Live2DMotion.loadMotion(mtnFiles[motioncnt].bytes);\n\t\t\t// \u30d5\u30a7\u30fc\u30c9\u30a4\u30f3\u306e\u8a2d\u5b9a\n\t\t\tmotion.setFadeIn(mtnFadeines[motioncnt]);\n\t\t\t// \u30d5\u30a7\u30fc\u30c9\u30a2\u30a6\u30c8\u306e\u8a2d\u5b9a\n\t\t\tmotion.setFadeOut(mtnFadeoutes[motioncnt]);\n\t\t\t// \u30e2\u30fc\u30b7\u30e7\u30f3\u518d\u751f\n\t\t\tmotionManager.startMotion(motion, false);\n\t\t\t// \u97f3\u58f0\u518d\u751f\n\t\t\tif (soundFiles[motioncnt] != null)\n\t\t\t{\n\t\t\t\tGetComponent<AudioSource>().clip = soundFiles[motioncnt];\n\t\t\t\tGetComponent<AudioSource>().Play();\n\t\t\t}\n\t\t}\n\t\tvar pos = Input.mousePosition;\n\t\tif (Input.GetMouseButtonDown(0))\n\t\t{\n\t\t\t//\n\t\t}\n\t\telse if (Input.GetMouseButton(0))\n\t\t{\n\t\t\tdragMgr.Set(pos.x / Screen.width * 2 - 1, pos.y / Screen.height * 2 - 1);\n\t\t}\n\t\telse if (Input.GetMouseButtonUp(0))\n\t\t{\n\t\t\tdragMgr.Set(0, 0);\n\t\t}\n\t\t\n\t\t\n\t\tdragMgr.update();\n\t\tlive2DModel.setParamFloat(\"PARAM_ANGLE_X\", dragMgr.getX() * 30);\n\t\tlive2DModel.setParamFloat(\"PARAM_ANGLE_Y\", dragMgr.getY() * 30);\n\t\t\n\t\tlive2DModel.setParamFloat(\"PARAM_BODY_ANGLE_X\", dragMgr.getX() * 10);\n\t\t\n\t\tlive2DModel.setParamFloat(\"PARAM_EYE_BALL_X\", -dragMgr.getX());\n\t\tlive2DModel.setParamFloat(\"PARAM_EYE_BALL_Y\", -dragMgr.getY());\n\t\t\n\t\tdouble timeSec = UtSystem.getUserTimeMSec() / 1000.0;\n\t\tdouble t = timeSec * 2 * Math.PI;\n\t\tlive2DModel.setParamFloat(\"PARAM_BREATH\", (float)(0.5f + 0.5f * Math.Sin(t / 3.0)));\n\t\t\n\t\teyeBlink.setParam(live2DModel);\n\t\t// \u9802\u70b9\u306e\u66f4\u65b0\n\t\tlive2DModel.update();\n\t}\n\t\n\t\n\t/// <summary>\n\t/// \u30ab\u30e1\u30e9\u304c\u30b7\u30fc\u30f3\u306b\u30ec\u30f3\u30c0\u30ea\u30f3\u30b0\u5f8c\u306b\u547c\u3070\u308c\u308b\n\t/// </summary>\n\tvoid OnRenderObject()\n\t{\n\t\tif (live2DModel == null) return;\n\t\tlive2DModel.setMatrix(transform.localToWorldMatrix * live2DCanvasPos);\n\t\t// \u30a2\u30d7\u30ea\u304c\u7d42\u4e86\u3057\u3066\u3044\u305f\u5834\u5408\n\t\tif (!Application.isPlaying)\n\t\t{\n\t\t\tlive2DModel.draw();\n\t\t\treturn;\n\t\t}\n        // \u30e2\u30c7\u30eb\u306e\u63cf\u753b\n        live2DModel.draw();\n    }\n    \n    \n    /// <summary>\n    /// JSON\u3092\u8aad\u307f\u8fbc\u3080\n    /// </summary>\n    void Json_Read()\n    {\n\t\t// model.json\u3092\u8aad\u307f\u8fbc\u3080\n\t\tchar[] buf = modelJson.text.ToCharArray();\n\t\tValue json = Json.parseFromBytes(buf);\n\t\t\n\t\t\n\t\t// \u30e2\u30c7\u30eb\u3092\u8aad\u307f\u8fbc\u3080\n\t\tmocFile = new TextAsset();\n\t\tmocFile = (Resources.Load(json.get(\"model\").toString(), typeof(TextAsset)) as TextAsset);\n\t\tlive2DModel = Live2DModelUnity.loadModel(mocFile.bytes);\n\t\t\n\t\t// \u30c6\u30af\u30b9\u30c1\u30e3\u3092\u8aad\u307f\u8fbc\u3080\n\t\tint texture_num = json.get(\"textures\").getVector(null).Count;\n\t\ttextures = new Texture2D[texture_num];\n\t\t\n\t\tfor (int i = 0; i < texture_num; i++)\n\t\t{\n\t\t\t// \u4e0d\u8981\u306a\u62e1\u5f35\u5b50\u3092\u524a\u9664\n\t\t\tstring texturenm = Regex.Replace(json.get(\"textures\").get(i).toString(), \".png$\", \"\");\n\t\t\ttextures[i] = (Resources.Load(texturenm, typeof(Texture2D)) as Texture2D);\n\t\t\tlive2DModel.setTexture(i, textures[i]);\n\t\t}\n\n\t\t// \u30e2\u30fc\u30b7\u30e7\u30f3\u306e\u914d\u4e0b\u306e\u30ad\u30fc\u3092\u53d6\u5f97\n\t\tDictionary<string, Value> motion_keys = json.get(\"motions\").getMap(null);\n\t\tint mtn_tag = 0;\n\t\tint mtn_num = 0;\n\t\tstring[] motion_tags = new string[motion_keys.Count];\n\n\t\t// \u8aad\u8fbc\u30e2\u30fc\u30b7\u30e7\u30f3\u30d5\u30a1\u30a4\u30eb\u6570\u30ab\u30a6\u30f3\u30c8\u7528\n\t\tforeach (var mtnkey in motion_keys)\n\t\t{\n\t\t\t// motions\u914d\u4e0b\u306e\u30ad\u30fc\u3092\u53d6\u5f97\n\t\t\tmotion_tags[mtn_tag] = mtnkey.Key.ToString();\n\t\t\t// \u8aad\u307f\u8fbc\u3080\u30e2\u30fc\u30b7\u30e7\u30f3\u30d5\u30a1\u30a4\u30eb\u6570\u3092\u53d6\u5f97\n\t\t\tmtn_num += json.get(\"motions\").get(motion_tags[mtn_tag]).getVector(null).Count;\n\t\t\tmtn_tag++;\n\t\t}\n\t\t// \u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u5316\n\t\tmtnFiles = new TextAsset[mtn_num];\n\t\tsoundFiles = new AudioClip[mtn_num];\n\t\tmtnFadeines = new int[mtn_num];\n\t\tmtnFadeoutes = new int[mtn_num];\n\n\t\tmtn_tag = 0;\n\t\tmtn_num = 0;\n\t\t// \u30e2\u30fc\u30b7\u30e7\u30f3\u30d5\u30a1\u30a4\u30eb\u6570\u5206JSON\u8aad\u8fbc\n\t\tforeach (var mtnkey in motion_keys)\n\t\t{\n\t\t\t// \u30e2\u30fc\u30b7\u30e7\u30f3\u3068\u30b5\u30a6\u30f3\u30c9\u3092\u8aad\u307f\u8fbc\u3080(motions\u914d\u4e0b\u306e\u30bf\u30b0\u3092\u8aad\u307f\u8fbc\u3080)\n\t\t\tValue motionPaths = json.get(\"motions\").get(motion_tags[mtn_tag]);\n\t\t\tint motionNum = motionPaths.getVector(null).Count;\n\n\t\t\tfor (int m = 0; m < motionNum; m++)\n\t\t\t{\n\t\t\t\tmtnFiles[mtn_num] = (Resources.Load(motionPaths.get(m).get(\"file\").toString()) as TextAsset);\n\t\t\t\t// \u30b5\u30a6\u30f3\u30c9\u30d5\u30a1\u30a4\u30eb\u304c\u3042\u308c\u3070\u5165\u308c\u308b\n\t\t\t\tif (motionPaths.get(m).getMap(null).ContainsKey(\"sound\"))\n\t\t\t\t{\n\t\t\t\t\t// \u4e0d\u8981\u306a\u62e1\u5f35\u5b50\u3092\u524a\u9664\n\t\t\t\t\tstring soundnm = Regex.Replace(Regex.Replace(motionPaths.get(m).get(\"sound\").toString(), \".mp3$\", \"\"), \".wav$\", \"\");\n\t\t\t\t\tsoundFiles[mtn_num] = (Resources.Load(soundnm, typeof(AudioClip)) as AudioClip);\n\t\t\t\t}\n\t\t\t\t//\u30d5\u30a7\u30fc\u30c9\u30a4\u30f3\n\t\t\t\tif (motionPaths.get(m).getMap(null).ContainsKey(\"fade_in\"))\n\t\t\t\t{\n\t\t\t\t\tmtnFadeines[mtn_num] = int.Parse(motionPaths.get(m).get(\"fade_in\").toString());\n\t\t\t\t}\n\t\t\t\t//\u30d5\u30a7\u30fc\u30c9\u30a2\u30a6\u30c8\n\t\t\t\tif (motionPaths.get(m).getMap(null).ContainsKey(\"fade_out\"))\n\t\t\t\t{\n\t\t\t\t\tmtnFadeoutes[mtn_num] = int.Parse(motionPaths.get(m).get(\"fade_out\").toString());\n\t\t\t\t}\n\t\t\t\tmtn_num++;\n\t\t\t}\n\t\t\tmtn_tag++;\n\t\t}\n\t\t\t\t\n\t\t// \u30dd\u30fc\u30ba\u30d5\u30a1\u30a4\u30eb\u3092\u8aad\u307f\u8fbc\u3080\n\t\tif (json.getMap(null).ContainsKey(\"pose\"))\n\t\t{\n\t\t\tValue posepath = json.get(\"pose\");\n\t\t\tposeFile = new TextAsset();\n\t\t\tposeFile = (Resources.Load(posepath.toString(), typeof(TextAsset)) as TextAsset);\n            // pose.json\u3092\u8aad\u307f\u8fbc\u3080\n            char[] posebuf = poseFile.text.ToCharArray();\n            // \u30d1\u30fc\u30c4\u5207\u308a\u66ff\u3048\u30af\u30e9\u30b9\u3078\u6e21\u3059\n            pose = L2DPose.load(posebuf);\n        }\n        \n        // \u7269\u7406\u6f14\u7b97\u30d5\u30a1\u30a4\u30eb\u3092\u8aad\u307f\u8fbc\u3080\n        if (json.getMap(null).ContainsKey(\"physics\"))\n        {\n            Value physicpath = json.get(\"physics\");\n            physicsFile = new TextAsset();\n            physicsFile = (Resources.Load(physicpath.toString(), typeof(TextAsset)) as TextAsset);\n            // physics.json\u3092\u8aad\u307f\u8fbc\u3080\n            char[] physicsbuf = physicsFile.text.ToCharArray();\n            // \u7269\u7406\u6f14\u7b97\u30af\u30e9\u30b9\u3078\u6e21\u3059\n            physics = L2DPhysics.load(physicsbuf);\n        }\n    }\n    \n    \n    /// <summary>\n    /// \u30e2\u30fc\u30b7\u30e7\u30f3\u306e\u30c1\u30a7\u30f3\u30b8\n    /// </summary>\n    /// <param name=\"storage\">\u30e2\u30fc\u30b7\u30e7\u30f3\u30d5\u30a1\u30a4\u30eb\u540d</param>\n\t/// <param name=\"idle\">\u30a2\u30a4\u30c9\u30ea\u30f3\u30b0\u6709\u7121</param>\n\tpublic void Motion_change(string storage, string idle)\n    {\n\t\tint cnt = 0;\n\t\tfor (int m = 0; m < mtnFiles.Length; m++)\n\t\t{\n\t\t\tif (mtnFiles[m].name == storage)\n\t\t\t{\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcnt++;\n\t\t}\n\n\t\t// \u30a2\u30a4\u30c9\u30eb\u30d5\u30e9\u30b0\u304cON\u306a\u3089\u3001\u6307\u5b9a\u3057\u305f\u30e2\u30fc\u30b7\u30e7\u30f3\u3092\u30a2\u30a4\u30c9\u30ea\u30f3\u30b0\u3055\u305b\u308b\n\t\tif (idle != \"\")\n\t\t{\n\t\t\tmotioncnt = cnt;\n\t\t}\n\n\t\t/*\n        int cnt = 0;\n        string filenm = Regex.Replace (storage, \".bytes$\",\"\");\n        // \u30e2\u30fc\u30b7\u30e7\u30f3\u30d5\u30a1\u30a4\u30eb\u540d\u3092\u691c\u7d22\n        foreach (string mtnNm in mtnFilenms)\n        {\n\t\t\tif(mtnNm == filenm)\n            {\n                break;\n            }\n            cnt++;\n        }\n        */\n\n        // \u30e2\u30fc\u30b7\u30e7\u30f3\u306e\u30ed\u30fc\u30c9\u3092\u3059\u308b\n        motion = Live2DMotion.loadMotion(mtnFiles[cnt].bytes);\n\t\t// \u30d5\u30a7\u30fc\u30c9\u30a4\u30f3\u306e\u8a2d\u5b9a\n\t\tmotion.setFadeIn(mtnFadeines[cnt]);\n\t\t// \u30d5\u30a7\u30fc\u30c9\u30a2\u30a6\u30c8\u306e\u8a2d\u5b9a\n\t\tmotion.setFadeOut(mtnFadeoutes[cnt]);\n        // \u30e2\u30fc\u30b7\u30e7\u30f3\u518d\u751f\n        motionManager.startMotion(motion, false);\n        // \u30b5\u30a6\u30f3\u30c9\u304c\u3042\u308c\u3070\u30dc\u30a4\u30b9\u518d\u751f\n        \n\t\tif (soundFiles[cnt] != null)\n        {\n            GetComponent<AudioSource>().clip = soundFiles[cnt];\n            GetComponent<AudioSource>().Play();\n        }\n    }\n}\n```\n\n\u306f\u3044\u3001\u3053\u308c\u3067\u5b8c\u6210\u3057\u307e\u3057\u305f\uff01\nJokerScript\u306b\u306fLive2D\u306e\u30bd\u30fc\u30b9\u306f\u7d50\u69cb\u308f\u304b\u308a\u3084\u3059\u3044\u5f62\u3060\u3068\u601d\u3046\u306e\u3067\u3001\u81ea\u7531\u306b\u30ab\u30b9\u30bf\u30e0\u3057\u3061\u3083\u3063\u3066\u4e0b\u3055\u3044\u3002\n![001.gif](https://qiita-image-store.s3.amazonaws.com/0/15028/8126f650-b969-383f-2cb0-85b85b2b0bcb.gif)\n\n", "tags": ["Unity", "Live2D"]}