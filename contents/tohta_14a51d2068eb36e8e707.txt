{"context": "\n\n\u3084\u308a\u305f\u3044\u3053\u3068\n\u65e5\u672c\u4ee5\u5916\u306eIP\u30a2\u30c9\u30ec\u30b9\u306f\u5168\u90e8\u62d2\u5426\u3057\u305f\u3044\u3002\uff08\u4eca\u56de\u306f Pingdom \u3082\u8a31\u53ef\u3059\u308b\uff09\niptables \u3067 DROP \u306e\u30eb\u30fc\u30eb\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\u30eb\u30fc\u30eb\u304c\u5897\u3048\u308b\u3068\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u304c\u52a3\u5316\u3059\u308b\u3089\u3057\u3044\u306e\u3067\u3001ipset \u3092\u4f7f\u3044\u307e\u3059\u3002\n\n\u624b\u9806\n\nipset \u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3068\u521d\u671f\u5316\nyum \u3067\u5165\u308c\u308b\u3068init\u30b9\u30af\u30ea\u30d7\u30c8\u3068\u304b\u304c\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3055\u308c\u306a\u304b\u3063\u305f\u306e\u3067\u3001\u3053\u3061\u3089\u304b\u3089\u3002\nrpm -ivh ftp://fr2.rpmfind.net/linux/centos/6.7/os/x86_64/Packages/ipset-6.11-4.el6.x86_64.rpm\n\n\u521d\u671f\u5316\u3057\u307e\u3059\u3002\nipset create -exist WHITELIST hash:net\nipset create -exist PINGDOM hash:ip\n\n\nJP\u306e\u307f\u3092\u30db\u30ef\u30a4\u30c8\u30ea\u30b9\u30c8\u306b\u5165\u308c\u308b\n\u56fd\u5225\u306e\u30ea\u30b9\u30c8\u306f\u3053\u3061\u3089\u304b\u3089\u53d6\u5f97\u3067\u304d\u308b\u306e\u3067\u3042\u308a\u304c\u305f\u304f\u4f7f\u308f\u305b\u3066\u3044\u305f\u3060\u304f\u3002\nwget 'http://nami.jp/ipv4bycc/cidr.txt.gz'\ngunzip cidr.txt.gz\nsed -n 's/^JP\\t//p' cidr.txt | while read i ; do ipset add WHITELIST $i ; done\n\n\nPingdom\u306eIP\u30a2\u30c9\u30ec\u30b9\u3092\u30db\u30ef\u30a4\u30c8\u30ea\u30b9\u30c8\u306b\u5165\u308c\u308b\n\u76e3\u8996\u3067 Pingdom \u3092\u4f7f\u3063\u3066\u3044\u308b\u90fd\u5408\u3067\u3053\u3061\u3089\u3082\u30db\u30ef\u30a4\u30c8\u30ea\u30b9\u30c8\u3078\u3002\ncurl -s -o pingdom.txt 'https://my.pingdom.com/probes/ipv4'\ncat pingdom.txt | while read i ; do ipset add PINGDOM $i ; done\n\n\n\u8a2d\u5b9a\u306e\u4fdd\u5b58\nOS \u3092\u518d\u8d77\u52d5\u3059\u308b\u3068\u6d88\u3048\u3061\u3083\u3046\u306e\u3067\u4fdd\u5b58\u3002\u81ea\u52d5\u8d77\u52d5\u306e\u8a2d\u5b9a\u3002\n/etc/init.d/ipset save\n(/etc/sysconfig/ipset \u306b\u4fdd\u5b58\u3055\u308c\u308b\uff09\nchkconfig  ipset on\n\nIP\u30a2\u30c9\u30ec\u30b9\u306e\u30ea\u30b9\u30c8\u306f\u5909\u66f4\u3059\u308b\u53ef\u80fd\u6027\u304c\u3042\u308b\u306e\u3067\u3001\u30b7\u30a7\u30eb\u30b9\u30af\u30ea\u30d7\u30c8\u3068\u304b\u306b\u3057\u3066 cron \u3067\u5b9a\u671f\u7684\u306b\u5b9f\u884c\u3057\u3066\u304a\u304d\u307e\u3059\u3002\u3053\u3093\u306a\u304b\u3093\u3058\u3002\n#!/usr/bin/env sh\n\nset -ue\n\nNOW=$(date +%Y-%m-%d-%H-%m)\nMAILTO='you@example.com'\nCIDR_LIST='http://nami.jp/ipv4bycc/cidr.txt.gz'\nPINGDOM_LIST='https://my.pingdom.com/probes/ipv4'\n\nalert () {\n  echo $1\n  echo $1 | mail -s \"ERROR: ipset failed (${NOW})\" ${MAILTO}\n  exit 1\n}\n\nTEMP_DIR=/tmp/$$\nmkdir -p ${TEMP_DIR} ; cd ${TEMP_DIR}\n\n# clean if trapped or finished\ntrap \"echo Trapped ; rm -rf ${TEMP_DIR}\" 1 2 3 15\ntrap \"echo Finished; rm -rf ${TEMP_DIR}\" EXIT\n\n# update ipv4\nwget -nv -O - http://nami.jp/ipv4bycc/cidr.txt.gz | gunzip -c > cidr.txt || alert \"Download failed: CIDR\"\nipset create -exist WHITELIST hash:net\nipset flush WHITELIST\nsed -n 's/^JP\\t//p' cidr.txt | while read i ; do ipset -q add WHITELIST $i ; done\necho \"Added $(ipset list WHITELIST | grep -v : | wc -l) to WHITELIST\"\n\n# update pingdom\nwget --no-check-certificate  https://my.pingdom.com/probes/ipv4 || alert \"Download failed: Pingdom\"\nipset create -exist PINGDOM hash:ip\nipset flush PINGDOM\ncat ipv4 | while read i ; do ipset -q add PINGDOM $i ; done\necho \"Added $(ipset list PINGDOM | grep -v : | wc -l) to PINGDOM\"\n\n# save\necho \"Total $(ipset list | grep -v : | wc -l) added\"\n/etc/init.d/ipset save\n\nexit 0\n\n\niptables\u306e\u30eb\u30fc\u30eb\u3092\u8ffd\u52a0\nssh\u306e\u5834\u5408\u3002\u3053\u3093\u306a\u304b\u3093\u3058\u3002\n-A INPUT -m state \u2013state NEW -m tcp -p tcp \u2013dport 22 -m set \u2013match-set WHITELIST src -j ACCEPT\n-A INPUT -m state \u2013state NEW -m tcp -p tcp \u2013dport 22 -m set \u2013match-set PINGDOM src -j ACCEPT\n\nhashlimit\u3068\u7d44\u307f\u5408\u308f\u305b\u3066\u3082\u3044\u3044\u305e\u3002\n\u6357\u308c\u301c\u3002\n\n## \u3084\u308a\u305f\u3044\u3053\u3068\n\u65e5\u672c\u4ee5\u5916\u306eIP\u30a2\u30c9\u30ec\u30b9\u306f\u5168\u90e8\u62d2\u5426\u3057\u305f\u3044\u3002\uff08\u4eca\u56de\u306f Pingdom \u3082\u8a31\u53ef\u3059\u308b\uff09\n\n##\n\niptables \u3067 DROP \u306e\u30eb\u30fc\u30eb\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\u30eb\u30fc\u30eb\u304c\u5897\u3048\u308b\u3068\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u304c\u52a3\u5316\u3059\u308b\u3089\u3057\u3044\u306e\u3067\u3001ipset \u3092\u4f7f\u3044\u307e\u3059\u3002\n\n## \u624b\u9806\n\n### ipset \u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3068\u521d\u671f\u5316\n\nyum \u3067\u5165\u308c\u308b\u3068init\u30b9\u30af\u30ea\u30d7\u30c8\u3068\u304b\u304c\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3055\u308c\u306a\u304b\u3063\u305f\u306e\u3067\u3001\u3053\u3061\u3089\u304b\u3089\u3002\n\n```\nrpm -ivh ftp://fr2.rpmfind.net/linux/centos/6.7/os/x86_64/Packages/ipset-6.11-4.el6.x86_64.rpm\n```\n\n\u521d\u671f\u5316\u3057\u307e\u3059\u3002\n\n```\nipset create -exist WHITELIST hash:net\nipset create -exist PINGDOM hash:ip\n```\n\n\n### JP\u306e\u307f\u3092\u30db\u30ef\u30a4\u30c8\u30ea\u30b9\u30c8\u306b\u5165\u308c\u308b\n\u56fd\u5225\u306e\u30ea\u30b9\u30c8\u306f\u3053\u3061\u3089\u304b\u3089\u53d6\u5f97\u3067\u304d\u308b\u306e\u3067\u3042\u308a\u304c\u305f\u304f\u4f7f\u308f\u305b\u3066\u3044\u305f\u3060\u304f\u3002\n\n```\nwget 'http://nami.jp/ipv4bycc/cidr.txt.gz'\ngunzip cidr.txt.gz\nsed -n 's/^JP\\t//p' cidr.txt | while read i ; do ipset add WHITELIST $i ; done\n```\n\n### Pingdom\u306eIP\u30a2\u30c9\u30ec\u30b9\u3092\u30db\u30ef\u30a4\u30c8\u30ea\u30b9\u30c8\u306b\u5165\u308c\u308b\n\u76e3\u8996\u3067 Pingdom \u3092\u4f7f\u3063\u3066\u3044\u308b\u90fd\u5408\u3067\u3053\u3061\u3089\u3082\u30db\u30ef\u30a4\u30c8\u30ea\u30b9\u30c8\u3078\u3002\n\n```\ncurl -s -o pingdom.txt 'https://my.pingdom.com/probes/ipv4'\ncat pingdom.txt | while read i ; do ipset add PINGDOM $i ; done\n```\n\n### \u8a2d\u5b9a\u306e\u4fdd\u5b58\nOS \u3092\u518d\u8d77\u52d5\u3059\u308b\u3068\u6d88\u3048\u3061\u3083\u3046\u306e\u3067\u4fdd\u5b58\u3002\u81ea\u52d5\u8d77\u52d5\u306e\u8a2d\u5b9a\u3002\n\n```\n/etc/init.d/ipset save\n(/etc/sysconfig/ipset \u306b\u4fdd\u5b58\u3055\u308c\u308b\uff09\nchkconfig  ipset on\n```\n\nIP\u30a2\u30c9\u30ec\u30b9\u306e\u30ea\u30b9\u30c8\u306f\u5909\u66f4\u3059\u308b\u53ef\u80fd\u6027\u304c\u3042\u308b\u306e\u3067\u3001\u30b7\u30a7\u30eb\u30b9\u30af\u30ea\u30d7\u30c8\u3068\u304b\u306b\u3057\u3066 cron \u3067\u5b9a\u671f\u7684\u306b\u5b9f\u884c\u3057\u3066\u304a\u304d\u307e\u3059\u3002\u3053\u3093\u306a\u304b\u3093\u3058\u3002\n\n```\n#!/usr/bin/env sh\n\nset -ue\n\nNOW=$(date +%Y-%m-%d-%H-%m)\nMAILTO='you@example.com'\nCIDR_LIST='http://nami.jp/ipv4bycc/cidr.txt.gz'\nPINGDOM_LIST='https://my.pingdom.com/probes/ipv4'\n\nalert () {\n  echo $1\n  echo $1 | mail -s \"ERROR: ipset failed (${NOW})\" ${MAILTO}\n  exit 1\n}\n\nTEMP_DIR=/tmp/$$\nmkdir -p ${TEMP_DIR} ; cd ${TEMP_DIR}\n\n# clean if trapped or finished\ntrap \"echo Trapped ; rm -rf ${TEMP_DIR}\" 1 2 3 15\ntrap \"echo Finished; rm -rf ${TEMP_DIR}\" EXIT\n\n# update ipv4\nwget -nv -O - http://nami.jp/ipv4bycc/cidr.txt.gz | gunzip -c > cidr.txt || alert \"Download failed: CIDR\"\nipset create -exist WHITELIST hash:net\nipset flush WHITELIST\nsed -n 's/^JP\\t//p' cidr.txt | while read i ; do ipset -q add WHITELIST $i ; done\necho \"Added $(ipset list WHITELIST | grep -v : | wc -l) to WHITELIST\"\n\n# update pingdom\nwget --no-check-certificate  https://my.pingdom.com/probes/ipv4 || alert \"Download failed: Pingdom\"\nipset create -exist PINGDOM hash:ip\nipset flush PINGDOM\ncat ipv4 | while read i ; do ipset -q add PINGDOM $i ; done\necho \"Added $(ipset list PINGDOM | grep -v : | wc -l) to PINGDOM\"\n\n# save\necho \"Total $(ipset list | grep -v : | wc -l) added\"\n/etc/init.d/ipset save\n\nexit 0\n```\n\n## iptables\u306e\u30eb\u30fc\u30eb\u3092\u8ffd\u52a0\nssh\u306e\u5834\u5408\u3002\u3053\u3093\u306a\u304b\u3093\u3058\u3002\n\n```\n-A INPUT -m state \u2013state NEW -m tcp -p tcp \u2013dport 22 -m set \u2013match-set WHITELIST src -j ACCEPT\n-A INPUT -m state \u2013state NEW -m tcp -p tcp \u2013dport 22 -m set \u2013match-set PINGDOM src -j ACCEPT\n```\n\nhashlimit\u3068\u7d44\u307f\u5408\u308f\u305b\u3066\u3082\u3044\u3044\u305e\u3002\n\u6357\u308c\u301c\u3002\n", "tags": ["ipset", "Security", "iptables", "hashlimit"]}