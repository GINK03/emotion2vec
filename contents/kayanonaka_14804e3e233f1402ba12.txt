{"context": "\n\n\u306f\u3058\u3081\u306b\nPassport\u3068\u306f\u30ed\u30b0\u30a4\u30f3\u8a8d\u8a3c\u306b\u4fbf\u5229\u306a\u30e9\u30a4\u30d6\u30e9\u30ea\u3002\n\u305f\u3060\u5df7\u3067\u6ea2\u308c\u308b\u30b5\u30f3\u30d7\u30eb\u306f\u3060\u3044\u305f\u3044Express3.x\u3067\u66f8\u304b\u308c\u3066\u3044\u308b\u306e\u3067\u3001Express4\u7528\u306b\u30e1\u30e2\u3002\nOAuth\u3060\u3068\u304bOpenID\u3092\u4f7f\u3063\u305f\u8a8d\u8a3c\u3082\u3042\u308b\u3051\u3069\u3001\n\u4eca\u56de\u306f\u30b7\u30f3\u30d7\u30eb\u306b\u30e6\u30fc\u30b6\u30fc\u3001\u30d1\u30b9\u30ef\u30fc\u30c9\u306e\u307f\u3067\u8a8d\u8a3c\u3057\u3066\u307f\u307e\u3059\u3002\n\u8a73\u3057\u304f\u306f\u3053\u3061\u3089\u3002\u30b3\u30fc\u30c9\u304cExpress3\u3060\u3051\u3069\u3002\nPassport\uff08\u516c\u5f0f\u30da\u30fc\u30b8\uff09\n\u65e5\u672c\u8a9e\u8a33\u30da\u30fc\u30b8\n\n\u30d0\u30fc\u30b8\u30e7\u30f3\nnode.js - 0.12.7\nexpress - 4.13.1\npassport - 0.3.2\n\n\u5b9f\u88c5\n\u307e\u305a\u306f\u30e2\u30c7\u30eb\u3002\u8a8d\u8a3c\u60c5\u5831\u3092\u4fdd\u6301\u3059\u308b\u3002\n\naccount.js\n'use strict';\n\nvar mongoose = require('mongoose');\nvar Schema = mongoose.Schema;\n\nvar AccountSchema = new Schema({\n    id: { type: String, required: true },\n    password: { type: String, required: true },\n    updated_at: { type: Date },\n    created_at: { type: Date }\n});\n\nAccountSchema.pre('save', function(next) {\n    var now = new Date();\n    this.updated_at = now;\n    if (!this.created_at) {\n        this.created_at = now;\n    }\n    next();\n});\n\nmodule.exports = mongoose.model('Account', AccountSchema);\n\n\n\n\u6b21\u306bapp.js\u3002\n\napp.js\nvar express = require('express');\nvar mongoose = require('mongoose');\nvar passport = require('passport');\nvar flash = require('connect-flash');\nvar session = require('express-session');\nvar crypto = require('crypto');\nvar app = express();\n\napp.use(session({ secret: 'hoge' }));\napp.use(flash());\napp.use(passport.initialize());\napp.use(passport.session());\nvar LocalStrategy = require('passport-local').Strategy;\n\n// \u8a8d\u8a3c\npassport.use(new LocalStrategy(\n    {\n        usernameField: 'name',\n        passwordField: 'password',\n        passReqToCallback: true\n    },\n    function (req, name, password, done) {\n        process.nextTick(function () {\n            var Account = mongoose.model('Account');\n            Account.findOne({ \"id\": name }, function (err, account) {\n                if (err) return done(err);\n                if (!account) {\n                    req.flash('error', '\u30e6\u30fc\u30b6\u30fc\u304c\u898b\u3064\u304b\u308a\u307e\u305b\u3093\u3067\u3057\u305f\u3002');\n                    req.flash('input_id', name);\n                    req.flash('input_password', password);\n                    return done(null, false);\n                }\n                var hashedPassword = getHash(password);\n                if (account.password != hashedPassword\n                    && account.password != password) {\n                    req.flash('error', '\u30d1\u30b9\u30ef\u30fc\u30c9\u304c\u9593\u9055\u3063\u3066\u3044\u307e\u3059\u3002');\n                    req.flash('input_id', name);\n                    req.flash('input_password', password);\n                    return done(null, false);\n                }\n                return done(null, account);\n            });\n        })\n    }\n));\n\n// \u6697\u53f7\u5316\nvar getHash = function(value) {\n    var sha = crypto.createHmac('sha256', 'secretKey');\n    sha.update(value);\n    return sha.digest('hex');\n};\n\n// passport\npassport.serializeUser(function (account, done) {\n    done(null, account.id);\n});\npassport.deserializeUser(function (serializedAccount, done) {\n    var Account = mongoose.model('Account');\n    Account.findOne({ \"id\": serializedAccount }, function (err, account) {\n        done(err, account.id);\n    });\n});\n\n\nrouting\u3068\u304bsession\u306e\u6709\u7121\u30c1\u30a7\u30c3\u30af\u3068\u304b\u306f\u7701\u7565\u3057\u3066\u304a\u308a\u307e\u3059\u3002\n\u30dd\u30a4\u30f3\u30c8\u306fpassReqToCallback\u3092true\u306b\u3057\u3066\u30ea\u30af\u30a8\u30b9\u30c8\u3092\u53d6\u5f97\u3059\u308b\u3053\u3068\u3002\n\u3067\u3001connect-flash\u306e\u30e9\u30a4\u30d6\u30e9\u30ea\u3092\u8aad\u307f\u8fbc\u3093\u3067\u3001\u5165\u529b\u5024\u3084\u30a8\u30e9\u30fc\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u8a2d\u5b9a\u3057\u3066\u3044\u307e\u3059\u3002\nusernameField \u3068 passwordField \u306fhtml\u306e\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9'name'\u5024\u3067\u3059\u3002\n\u6b21\u306b\u30ed\u30b0\u30a4\u30f3\u51e6\u7406\u3002\n\nlogin.js\n'use strict';\n\nvar express = require('express');\nvar mongoose = require('mongoose');\nvar passport = require('passport');\nvar flash = require('connect-flash');\nvar router = express.Router();\n\n// \u30ed\u30b0\u30a4\u30f3\u753b\u9762\u8868\u793a\nrouter.get('/', function (req, res) {\n    res.render('login', {\n        error: req.flash('error'),\n        input_id: req.flash('input_id'),\n        input_password: req.flash('input_password')\n    });\n});\n\n// \u30ed\u30b0\u30a4\u30f3\u60c5\u5831\u5165\u529b\nrouter.post('/', function(req, res, next) {\n    passport.authenticate('local', {\n        successRedirect: '/',\n        failureRedirect: '/login',\n        failureFlash: true\n    })(req, res, next);\n});\n\nmodule.exports = router;\n\n\n\napp.js\u3067flash\u3057\u305f\u5024\u3092\u3053\u3053\u3067\u53d6\u5f97\u3057\u3066render\u3057\u3066\u3084\u308b\u3002\n\nlogin.ejs\n<!DOCTYPE html>\n<html lang=\"ja\">\n<body>\n    <p><%= error %</p>\n    <form action=\"/login\" method=\"POST\">\n    ID:\n    <input type=\"text\" name=\"name\" value=\"<%= input_id %>\">\n    Password:\n    <input type=\"password\" name=\"password\" value=\"<%= input_password >\">\n    <input type=\"submit\" value=\"\u30ed\u30b0\u30a4\u30f3\">\n    </form>\n</body>\n</html>\n\n\n##\u306f\u3058\u3081\u306b\nPassport\u3068\u306f\u30ed\u30b0\u30a4\u30f3\u8a8d\u8a3c\u306b\u4fbf\u5229\u306a\u30e9\u30a4\u30d6\u30e9\u30ea\u3002\n\u305f\u3060\u5df7\u3067\u6ea2\u308c\u308b\u30b5\u30f3\u30d7\u30eb\u306f\u3060\u3044\u305f\u3044Express3.x\u3067\u66f8\u304b\u308c\u3066\u3044\u308b\u306e\u3067\u3001Express4\u7528\u306b\u30e1\u30e2\u3002\nOAuth\u3060\u3068\u304bOpenID\u3092\u4f7f\u3063\u305f\u8a8d\u8a3c\u3082\u3042\u308b\u3051\u3069\u3001\n\u4eca\u56de\u306f\u30b7\u30f3\u30d7\u30eb\u306b\u30e6\u30fc\u30b6\u30fc\u3001\u30d1\u30b9\u30ef\u30fc\u30c9\u306e\u307f\u3067\u8a8d\u8a3c\u3057\u3066\u307f\u307e\u3059\u3002\n\n\u8a73\u3057\u304f\u306f\u3053\u3061\u3089\u3002\u30b3\u30fc\u30c9\u304cExpress3\u3060\u3051\u3069\u3002\n[Passport\uff08\u516c\u5f0f\u30da\u30fc\u30b8\uff09](http://passportjs.org/)\n[\u65e5\u672c\u8a9e\u8a33\u30da\u30fc\u30b8](http://knimon-software.github.io/www.passportjs.org/)\n\n##\u30d0\u30fc\u30b8\u30e7\u30f3\nnode.js - 0.12.7\nexpress - 4.13.1\npassport - 0.3.2\n\n##\u5b9f\u88c5\n\u307e\u305a\u306f\u30e2\u30c7\u30eb\u3002\u8a8d\u8a3c\u60c5\u5831\u3092\u4fdd\u6301\u3059\u308b\u3002\n\n```account.js\n'use strict';\n\nvar mongoose = require('mongoose');\nvar Schema = mongoose.Schema;\n\nvar AccountSchema = new Schema({\n    id: { type: String, required: true },\n    password: { type: String, required: true },\n    updated_at: { type: Date },\n    created_at: { type: Date }\n});\n\nAccountSchema.pre('save', function(next) {\n    var now = new Date();\n    this.updated_at = now;\n    if (!this.created_at) {\n        this.created_at = now;\n    }\n    next();\n});\n\nmodule.exports = mongoose.model('Account', AccountSchema);\n\n```\n\n\u6b21\u306bapp.js\u3002\n\n```app.js\nvar express = require('express');\nvar mongoose = require('mongoose');\nvar passport = require('passport');\nvar flash = require('connect-flash');\nvar session = require('express-session');\nvar crypto = require('crypto');\nvar app = express();\n\napp.use(session({ secret: 'hoge' }));\napp.use(flash());\napp.use(passport.initialize());\napp.use(passport.session());\nvar LocalStrategy = require('passport-local').Strategy;\n\n// \u8a8d\u8a3c\npassport.use(new LocalStrategy(\n    {\n        usernameField: 'name',\n        passwordField: 'password',\n        passReqToCallback: true\n    },\n    function (req, name, password, done) {\n        process.nextTick(function () {\n            var Account = mongoose.model('Account');\n            Account.findOne({ \"id\": name }, function (err, account) {\n                if (err) return done(err);\n                if (!account) {\n                    req.flash('error', '\u30e6\u30fc\u30b6\u30fc\u304c\u898b\u3064\u304b\u308a\u307e\u305b\u3093\u3067\u3057\u305f\u3002');\n                    req.flash('input_id', name);\n                    req.flash('input_password', password);\n                    return done(null, false);\n                }\n                var hashedPassword = getHash(password);\n                if (account.password != hashedPassword\n                    && account.password != password) {\n                    req.flash('error', '\u30d1\u30b9\u30ef\u30fc\u30c9\u304c\u9593\u9055\u3063\u3066\u3044\u307e\u3059\u3002');\n                    req.flash('input_id', name);\n                    req.flash('input_password', password);\n                    return done(null, false);\n                }\n                return done(null, account);\n            });\n        })\n    }\n));\n\n// \u6697\u53f7\u5316\nvar getHash = function(value) {\n    var sha = crypto.createHmac('sha256', 'secretKey');\n    sha.update(value);\n    return sha.digest('hex');\n};\n\n// passport\npassport.serializeUser(function (account, done) {\n    done(null, account.id);\n});\npassport.deserializeUser(function (serializedAccount, done) {\n    var Account = mongoose.model('Account');\n    Account.findOne({ \"id\": serializedAccount }, function (err, account) {\n        done(err, account.id);\n    });\n});\n```\n\nrouting\u3068\u304bsession\u306e\u6709\u7121\u30c1\u30a7\u30c3\u30af\u3068\u304b\u306f\u7701\u7565\u3057\u3066\u304a\u308a\u307e\u3059\u3002\n\u30dd\u30a4\u30f3\u30c8\u306f**passReqToCallback**\u3092*true*\u306b\u3057\u3066\u30ea\u30af\u30a8\u30b9\u30c8\u3092\u53d6\u5f97\u3059\u308b\u3053\u3068\u3002\n\u3067\u3001**connect-flash**\u306e\u30e9\u30a4\u30d6\u30e9\u30ea\u3092\u8aad\u307f\u8fbc\u3093\u3067\u3001\u5165\u529b\u5024\u3084\u30a8\u30e9\u30fc\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u8a2d\u5b9a\u3057\u3066\u3044\u307e\u3059\u3002\n`usernameField` \u3068 `passwordField` \u306fhtml\u306e\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9'name'\u5024\u3067\u3059\u3002\n\n\n\u6b21\u306b\u30ed\u30b0\u30a4\u30f3\u51e6\u7406\u3002\n\n```login.js\n'use strict';\n\nvar express = require('express');\nvar mongoose = require('mongoose');\nvar passport = require('passport');\nvar flash = require('connect-flash');\nvar router = express.Router();\n\n// \u30ed\u30b0\u30a4\u30f3\u753b\u9762\u8868\u793a\nrouter.get('/', function (req, res) {\n    res.render('login', {\n        error: req.flash('error'),\n        input_id: req.flash('input_id'),\n        input_password: req.flash('input_password')\n    });\n});\n\n// \u30ed\u30b0\u30a4\u30f3\u60c5\u5831\u5165\u529b\nrouter.post('/', function(req, res, next) {\n    passport.authenticate('local', {\n        successRedirect: '/',\n        failureRedirect: '/login',\n        failureFlash: true\n    })(req, res, next);\n});\n\nmodule.exports = router;\n\n```\n\n`app.js`\u3067`flash`\u3057\u305f\u5024\u3092\u3053\u3053\u3067\u53d6\u5f97\u3057\u3066render\u3057\u3066\u3084\u308b\u3002\n\n```login.ejs\n<!DOCTYPE html>\n<html lang=\"ja\">\n<body>\n    <p><%= error %</p>\n    <form action=\"/login\" method=\"POST\">\n    ID:\n    <input type=\"text\" name=\"name\" value=\"<%= input_id %>\">\n    Password:\n    <input type=\"password\" name=\"password\" value=\"<%= input_password >\">\n    <input type=\"submit\" value=\"\u30ed\u30b0\u30a4\u30f3\">\n    </form>\n</body>\n</html>\n```\n", "tags": ["Node.js", "npm", "Express", "Passport"]}