{"context": " More than 1 year has passed since last update.\n\n\u6700\u7d42\u66f4\u65b0\u65e5\n\n2013-12-10\n\n\n1\u884c\u6982\u8981\nSkype\u306e\u4f1a\u8a71\u5185\u5bb9\u3092\u6e96\u30ea\u30a2\u30eb\u30bf\u30a4\u30e0\uff08\u9045\u5ef610\u79d2\uff09\u3067Chatwork\u306e\u300c\u30de\u30a4\u30c1\u30e3\u30c3\u30c8\u300d\u306b\u7247\u65b9\u5411\u8ee2\u9001\u3059\u308bRuby\u306e\u30c7\u30fc\u30e2\u30f3\u30b9\u30af\u30ea\u30d7\u30c8\u3002\nChatworkAPI\u3092\u5229\u7528\u3059\u308b\u3088\u3046\u306b\u5909\u66f4\u3002\n\n\u72af\u884c\u52d5\u6a5f\n\u4f1a\u793e\u3067skype\u304b\u3089chatwork\u3078\u306e\u79fb\u884c\u3092\u3059\u3059\u3081\u308b\u306b\u3042\u305f\u3063\u3066\u3001\u305d\u306e\u9014\u4e2d\u306e\u300c\u4e21\u65b9\u4f7f\u3063\u3066\u308b\u300d\u5fae\u5999\u306a\u6bb5\u968e\u306e\u82e6\u3057\u307f\u3092\u53d6\u308a\u305e\u305e\u304f\u305f\u3081\u306b\u3002\n\n\u899a\u66f8\n\n12/10\u6642\u70b9\u3067mac\u9650\u5b9a\n\n\n\u30b3\u30fc\u30c9\n\nsk2ch.rb\n\nrequire 'fileutils'\nrequire 'sequel'\nrequire 'faraday'\n\n\n# Skype\u306e\u30a2\u30ab\u30a6\u30f3\u30c8\nSKYPE_NAME = 'skype.id'\n\n# Chatwork\u306eAPI\u30c8\u30fc\u30af\u30f3\nCHATWORK_API_TOKEN = 'xxxxxxxxxxxxxxxxxxxxxxxxxxxx'\n\n# Chatwork\u306b\u6295\u7a3f\u3059\u308b\u30b0\u30eb\u30fc\u30d7ID(\u30de\u30a4\u30c1\u30e3\u30c3\u30c8\u306a\u3069)\nCHATWORK_ROOM_ID = '12345678' # charwork my chat\n\n\nmodule LastId\n\n  DATA_PATH = File.join(File.expand_path(File.dirname(__FILE__)), 'last_id.txt')\n\n  # \u524d\u56de\u306eSkype\u306eMessageID\u3092\u53d6\u5f97\u3001\u306a\u3051\u308c\u3070SkypeDB\u304b\u3089\u6700\u65b0\u306e\u3082\u306e\u3092\u53d6\u5f97\n  def self.get\n    if File.exist?(DATA_PATH)\n      open(DATA_PATH).read\n    else\n      Skype::copy_db!\n      Skype::get_last_id\n    end\n  end\n\n  # \u30d5\u30a1\u30a4\u30eb\u306bSkype\u306eMessageID\u3092\u4fdd\u5b58\n  def self.set(last_id)\n    puts \"last_id: #{last_id}\"\n    open(DATA_PATH, 'w') { |f| f.write last_id.to_s }\n  end\n\nend\n\nmodule Skype\n\n  TMP_DB_PATH = '/tmp/skype-main.db'\n\n  # Skype\u306eDB\u3092\u30b3\u30d4\u30fc\n  def self.copy_db!\n    FileUtils.copy(\"#{ENV[\"HOME\"]}/Library/Application Support/Skype/#{SKYPE_NAME}/main.db\", TMP_DB_PATH)\n  rescue => err\n    p err\n    retry\n  end\n\n  # Skype\u306e\u6700\u5f8c\u306eMessageID\u3092\u53d6\u5f97\n  def self.get_last_id\n    connection = Sequel.connect(\"sqlite://#{TMP_DB_PATH}\")\n    dataset = connection.fetch(\"SELECT id FROM Messages ORDER BY id DESC LIMIT 1\")\n    dataset.first[:id]\n  end\n\n  # Skype\u306e\u6700\u8fd1\u306e\u66f4\u65b0\u306e\u5dee\u5206\u3092\u53d6\u5f97\n  def self.get_message\n\n    last_message_id = LastId::get\n\n    connection = Sequel.connect(\"sqlite://#{TMP_DB_PATH}\")\n\n    dataset = connection.fetch(\"SELECT Messages.id, Messages.from_dispname, Conversations.displayname, Messages.body_xml FROM Messages LEFT JOIN Conversations ON Messages.convo_id = Conversations.id WHERE Messages.id > ?\", last_message_id)\n    new_last_message_id = last_message_id\n    dataset.each do |r|\n      puts \"[#{r[:from_dispname]}] #{r[:displayname]}\\n\\t#{r[:body_xml]}\"\n      yield r\n      new_last_message_id = r[:id]\n    end\n\n    LastId::set(new_last_message_id)\n  end\n\nend\n\nmodule Chatwork\n\n  # Chatwork\u306bPOST\n  def self.post(text)\n\n    conn = Faraday::Connection.new(url: 'https://api.chatwork.com') do |builder|\n      builder.use Faraday::Request::UrlEncoded\n      builder.use Faraday::Adapter::NetHttp\n    end\n\n    response = conn.post do |request|\n      request.url \"/v1/rooms/#{CHATWORK_ROOM_ID}/messages\"\n      request.headers = {\n        'X-ChatWorkToken' => CHATWORK_API_TOKEN\n      }\n      request.params[:body] = text\n    end\n\n  end\nend\n\n\nloop {\n  Skype::copy_db!\n  Skype::get_message do |message|\n    Chatwork::post(\"#{message[:displayname]} (#{message[:from_dispname]})\\n#{message[:body_xml]}\")\n\n    sleep(1)\n  end\n  sleep(1)\n}\n\n\n\n\n\u7d30\u304b\u3044\u5185\u5bb9\n\nSkype\u306eDB\uff08sqlite\uff09\u306f\u6392\u4ed6\u5236\u5fa1\u3067\u8aad\u307f\u53d6\u308a\u3059\u3089\u51fa\u6765\u306a\u3044\u306e\u3067\u3001\u5f37\u5f15\u306b\u30b3\u30d4\u30fc\u3057SQL\u3092\u5b9f\u884c\u3057\u3066\u6700\u65b0\u306e\u60c5\u5831\u3092\u53d6\u5f97\n\n\n\u53c2\u8003\n30\u79d2\u3067Chatwork API\u3092\u4f7f\u3063\u3066\u30de\u30a4\u30c1\u30e3\u30c3\u30c8\u306b\u6295\u7a3f\u3059\u308b\u65b9\u6cd5\n\n\n![Screen Shot 2013-11-20 at 12.23.19 AM.png](https://qiita-image-store.s3.amazonaws.com/0/10272/474c4435-35b5-60ee-18ef-dd11e2bbce3c.png \"Screen Shot 2013-11-20 at 12.23.19 AM.png\")\n\n\n### \u6700\u7d42\u66f4\u65b0\u65e5\n- 2013-12-10\n\n\n# 1\u884c\u6982\u8981\nSkype\u306e\u4f1a\u8a71\u5185\u5bb9\u3092\u6e96\u30ea\u30a2\u30eb\u30bf\u30a4\u30e0\uff08\u9045\u5ef610\u79d2\uff09\u3067Chatwork\u306e\u300c\u30de\u30a4\u30c1\u30e3\u30c3\u30c8\u300d\u306b\u7247\u65b9\u5411\u8ee2\u9001\u3059\u308bRuby\u306e\u30c7\u30fc\u30e2\u30f3\u30b9\u30af\u30ea\u30d7\u30c8\u3002\nChatworkAPI\u3092\u5229\u7528\u3059\u308b\u3088\u3046\u306b\u5909\u66f4\u3002\n\n# \u72af\u884c\u52d5\u6a5f\n\u4f1a\u793e\u3067skype\u304b\u3089chatwork\u3078\u306e\u79fb\u884c\u3092\u3059\u3059\u3081\u308b\u306b\u3042\u305f\u3063\u3066\u3001\u305d\u306e\u9014\u4e2d\u306e\u300c\u4e21\u65b9\u4f7f\u3063\u3066\u308b\u300d\u5fae\u5999\u306a\u6bb5\u968e\u306e\u82e6\u3057\u307f\u3092\u53d6\u308a\u305e\u305e\u304f\u305f\u3081\u306b\u3002\n\n# \u899a\u66f8\n- 12/10\u6642\u70b9\u3067mac\u9650\u5b9a\n\n# \u30b3\u30fc\u30c9\n\n```ruby:sk2ch.rb\n\nrequire 'fileutils'\nrequire 'sequel'\nrequire 'faraday'\n\n\n# Skype\u306e\u30a2\u30ab\u30a6\u30f3\u30c8\nSKYPE_NAME = 'skype.id'\n\n# Chatwork\u306eAPI\u30c8\u30fc\u30af\u30f3\nCHATWORK_API_TOKEN = 'xxxxxxxxxxxxxxxxxxxxxxxxxxxx'\n\n# Chatwork\u306b\u6295\u7a3f\u3059\u308b\u30b0\u30eb\u30fc\u30d7ID(\u30de\u30a4\u30c1\u30e3\u30c3\u30c8\u306a\u3069)\nCHATWORK_ROOM_ID = '12345678' # charwork my chat\n\n\nmodule LastId\n\n  DATA_PATH = File.join(File.expand_path(File.dirname(__FILE__)), 'last_id.txt')\n\n  # \u524d\u56de\u306eSkype\u306eMessageID\u3092\u53d6\u5f97\u3001\u306a\u3051\u308c\u3070SkypeDB\u304b\u3089\u6700\u65b0\u306e\u3082\u306e\u3092\u53d6\u5f97\n  def self.get\n    if File.exist?(DATA_PATH)\n      open(DATA_PATH).read\n    else\n      Skype::copy_db!\n      Skype::get_last_id\n    end\n  end\n\n  # \u30d5\u30a1\u30a4\u30eb\u306bSkype\u306eMessageID\u3092\u4fdd\u5b58\n  def self.set(last_id)\n    puts \"last_id: #{last_id}\"\n    open(DATA_PATH, 'w') { |f| f.write last_id.to_s }\n  end\n\nend\n\nmodule Skype\n\n  TMP_DB_PATH = '/tmp/skype-main.db'\n\n  # Skype\u306eDB\u3092\u30b3\u30d4\u30fc\n  def self.copy_db!\n    FileUtils.copy(\"#{ENV[\"HOME\"]}/Library/Application Support/Skype/#{SKYPE_NAME}/main.db\", TMP_DB_PATH)\n  rescue => err\n    p err\n    retry\n  end\n\n  # Skype\u306e\u6700\u5f8c\u306eMessageID\u3092\u53d6\u5f97\n  def self.get_last_id\n    connection = Sequel.connect(\"sqlite://#{TMP_DB_PATH}\")\n    dataset = connection.fetch(\"SELECT id FROM Messages ORDER BY id DESC LIMIT 1\")\n    dataset.first[:id]\n  end\n\n  # Skype\u306e\u6700\u8fd1\u306e\u66f4\u65b0\u306e\u5dee\u5206\u3092\u53d6\u5f97\n  def self.get_message\n\n    last_message_id = LastId::get\n\n    connection = Sequel.connect(\"sqlite://#{TMP_DB_PATH}\")\n\n    dataset = connection.fetch(\"SELECT Messages.id, Messages.from_dispname, Conversations.displayname, Messages.body_xml FROM Messages LEFT JOIN Conversations ON Messages.convo_id = Conversations.id WHERE Messages.id > ?\", last_message_id)\n    new_last_message_id = last_message_id\n    dataset.each do |r|\n      puts \"[#{r[:from_dispname]}] #{r[:displayname]}\\n\\t#{r[:body_xml]}\"\n      yield r\n      new_last_message_id = r[:id]\n    end\n\n    LastId::set(new_last_message_id)\n  end\n\nend\n\nmodule Chatwork\n\n  # Chatwork\u306bPOST\n  def self.post(text)\n\n    conn = Faraday::Connection.new(url: 'https://api.chatwork.com') do |builder|\n      builder.use Faraday::Request::UrlEncoded\n      builder.use Faraday::Adapter::NetHttp\n    end\n\n    response = conn.post do |request|\n      request.url \"/v1/rooms/#{CHATWORK_ROOM_ID}/messages\"\n      request.headers = {\n        'X-ChatWorkToken' => CHATWORK_API_TOKEN\n      }\n      request.params[:body] = text\n    end\n\n  end\nend\n\n\nloop {\n  Skype::copy_db!\n  Skype::get_message do |message|\n    Chatwork::post(\"#{message[:displayname]} (#{message[:from_dispname]})\\n#{message[:body_xml]}\")\n\n    sleep(1)\n  end\n  sleep(1)\n}\n\n```\n\n## \u7d30\u304b\u3044\u5185\u5bb9\n- Skype\u306eDB\uff08sqlite\uff09\u306f\u6392\u4ed6\u5236\u5fa1\u3067\u8aad\u307f\u53d6\u308a\u3059\u3089\u51fa\u6765\u306a\u3044\u306e\u3067\u3001\u5f37\u5f15\u306b\u30b3\u30d4\u30fc\u3057SQL\u3092\u5b9f\u884c\u3057\u3066\u6700\u65b0\u306e\u60c5\u5831\u3092\u53d6\u5f97\n\n## \u53c2\u8003\n[30\u79d2\u3067Chatwork API\u3092\u4f7f\u3063\u3066\u30de\u30a4\u30c1\u30e3\u30c3\u30c8\u306b\u6295\u7a3f\u3059\u308b\u65b9\u6cd5](http://qiita.com/tady/items/ac6de448e228a2f631db)\n", "tags": ["skype", "Ruby", "chatwork", "api"]}