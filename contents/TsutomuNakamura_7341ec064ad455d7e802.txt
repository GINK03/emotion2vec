{"context": " More than 1 year has passed since last update.\n\nTLS \u8a8d\u8a3c\n\u524d\u56de\u306e\u8a18\u4e8b\u3067\u3001Docker Swarm \u306e\u69cb\u7bc9\u306b\u3064\u3044\u3066\u3084\u3063\u3066\u3044\u304d\u307e\u3057\u305f\u3002\nDocker Swarm \u5165\u9580\u30cf\u30f3\u30ba\u30aa\u30f3\nDocker Swarm cluster \u5185\u306e\u901a\u4fe1\u3092TLS \u3067\u884c\u3046\u3053\u3068\u304c\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u3063\u3066\u304a\u308a\u3001Docker Swarm cluster \u9593\u306eDocker \u306e\u901a\u4fe1\u306e\u6a5f\u5bc6\u6027\u3092\u9ad8\u3081\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\nTLS \u3067\u4f7f\u3046\u8a3c\u660e\u66f8\u306f\u81ea\u5206\u306e\u624b\u5143\u306e\u30b3\u30f3\u30d4\u30e5\u30fc\u30bf\u3067\u4f5c\u6210\u3057\u305fCA \u306e\u7f72\u540d\u304c\u3064\u3044\u305f\u3082\u306e\u3067\u69cb\u3044\u307e\u305b\u3093\u304c\u3001\u6761\u4ef6\u3068\u3057\u3066Docker Swarm manager\u3001Docker Swarm agent(\u5404agent \u306eDocker daemon)\u3001Docker client \u3067\u4f7f\u7528\u3059\u308b\u8a3c\u660e\u66f8\u306f\u3069\u308c\u3082\u540c\u3058CA \u304b\u3089\u7f72\u540d\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u304c\u6761\u4ef6\u3068\u306a\u3063\u3066\u3044\u307e\u3059\u3002\n\u307e\u305f\u3001Docker Swarm manager \u306e\u8a3c\u660e\u66f8\u306fopenssl \u306eextendedKeyUsage = clientAuth,serverAuth \u30aa\u30d7\u30b7\u30e7\u30f3\u3067\u3001Docker client \u306e\u8a3c\u660e\u66f8\u306fextendedKeyUsage = clientAuth \u30aa\u30d7\u30b7\u30e7\u30f3\u3067\u4f5c\u6210\u3059\u308b\u3088\u3046\u306b\u3057\u307e\u3059\u3002\n\u4eca\u56de\u306f\u691c\u8a3c\u76ee\u7684\u306a\u306e\u3067\u3001\u624b\u3063\u53d6\u308a\u65e9\u3055\u3092\u91cd\u8996\u3057\u3066\u3001Docker Swarm manager \u306eDocker \u30db\u30b9\u30c8\u4e0a\u306bCA \u3092\u4f5c\u6210\u3057\u3001Docker Swarm manager\u3001\u5404Docker Swarm agent \u306e\u30b5\u30fc\u30d0\u8a3c\u660e\u66f8\u3001Docker Swarm manager \u306eDocker \u30db\u30b9\u30c8\u304b\u3089\u30b3\u30de\u30f3\u30c9\u3092\u767a\u884c\u3059\u308b\u305f\u3081\u306e\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u8a3c\u660e\u66f8\u3092\u305d\u308c\u305e\u308c\u4f5c\u6210\u3057\u3066\u691c\u8a3c\u3057\u3066\u307f\u308b\u3053\u3068\u306b\u3057\u307e\u3059\u3002\n\n\n\u69cb\u6210\n\u4eca\u56de\u3001\u8a3c\u660e\u66f8\u3092\u4f7f\u7528\u3057\u3066\u8a8d\u8a3c\u3092\u884c\u3046\u305f\u3081\u306b\u8a3c\u660e\u66f8\u306eCN(\u30b3\u30e2\u30f3\u30cd\u30fc\u30e0) \u3068\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3068\u304d\u306b\u4f7f\u3046FQDN \u3092\u4e00\u81f4\u3055\u305b\u3066\u304a\u304f\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\u3053\u308c\u3088\u308a\u5148\u306b\u9032\u3080\u4e0a\u3067\u6df7\u4e71\u3092\u907f\u3051\u308b\u305f\u3081\u3001\u3053\u3053\u3067\u4e00\u65e6\u3001\u7528\u8a9e\u3068FQDN \u53ca\u3073\u305d\u308c\u305e\u308c\u306e\u30b3\u30f3\u30dd\u30fc\u30cd\u30f3\u30c8\u306e\u7528\u9014\u7b49\u306b\u3064\u3044\u3066\u6b21\u306e\u3088\u3046\u306b\u5b9a\u7fa9\u3057\u3066\u7f6e\u304f\u3082\u306e\u3068\u3057\u307e\u3059\u3002\n\n\u69cb\u6210\n\n\n \u540d\u524d\n IP \u30a2\u30c9\u30ec\u30b9\n FQDN\n (Host) OS\n Docker ver\n \u5099\u8003\n\n\n Docker Swarm manager \u30db\u30b9\u30c8\n 192.168.1.121\n -\n Ubuntu 15.10\n 1.9.1\n Docker Swarm manager \u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3057\u3066\u3044\u308b\u7269\u7406\u30db\u30b9\u30c8/Docker \u30db\u30b9\u30c8\u3002\u4eca\u56de\u3001\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u3068\u3057\u3066\u30b3\u30de\u30f3\u30c9\u3092\u9001\u4fe1\u3059\u308b\u4f5c\u696d\u7aef\u672b\u3068\u3057\u3066\u3082\u5229\u7528\n\n\n Docker Swarm manager 01 (swmgr01)\n 192.168.1.121\n swmgr01.example.com\n Ubuntu 15.10\n 1.9.1\n Docker Swarm manager \u30b3\u30f3\u30c6\u30ca\u3002\u3053\u306eFQDN \u306fDocker Swarm manager \u30db\u30b9\u30c8\u306e/etc/hosts \u30d5\u30a1\u30a4\u30eb\u306b\u767b\u9332\u3057\u3066\u304a\u304f\n\n\n Docker Swarm manager 01 (swagt01)\n 192.168.1.131\n swagt01.example.com\n Debian jessie\n 1.9.1\n Docker Swarm agent \u30b3\u30f3\u30c6\u30ca1 \u53f7\u6a5f\u3002\u3053\u306eFQDN \u306fDocker Swarm manager \u306e/etc/hosts(--add-host) \u306b\u767b\u9332\u3057\u3066\u304a\u304f\n\n\n Docker Swarm manager 02 (swagt02)\n 192.168.1.132\n swagt02.example.com\n Debian jessie\n 1.9.1\n Docker Swarm agent \u30b3\u30f3\u30c6\u30ca2 \u53f7\u6a5f\u3002\u3053\u306eFQDN \u306fDocker Swarm manager \u306e/etc/hosts(--add-host) \u306b\u767b\u9332\u3057\u3066\u304a\u304f\n\n\n Docker Swarm manager 03 (swagt03)\n 192.168.1.133\n swagt03.example.com\n Debian jessie\n 1.9.1\n Docker Swarm agent \u30b3\u30f3\u30c6\u30ca3 \u53f7\u6a5f\u3002\u3053\u306eFQDN \u306fDocker Swarm manager \u306e/etc/hosts(--add-host) \u306b\u767b\u9332\u3057\u3066\u304a\u304f\n\n\n\n\n\u4eca\u56de\u306f\u3053\u308c\u3089\u306eFQDN \u3092/etc/hosts \u3082\u3057\u304f\u306f--add-host \u306b\u3066\u767b\u9332\u3057\u307e\u3059\u304c\u3001\u305d\u308c\u305e\u308c\u306e\u30db\u30b9\u30c8\u53ca\u3073\u30b3\u30f3\u30c6\u30ca\u304c\u53c2\u7167\u3059\u308bDNS \u306b\u767b\u9332\u3057\u3066\u304a\u304f\u3053\u3068\u3067\u3001\u4e00\u5143\u7ba1\u7406\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\n\nCA \u306e\u79d8\u5bc6\u9375\u3068\u516c\u958b\u9375\u3001\u30b5\u30fc\u30d0\u8a3c\u660e\u66f8\u3092\u4f5c\u6210\u3059\u308b\nDocker Swarm manager \u30db\u30b9\u30c8\u4e0a\u3067openssl \u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3057\u3066CA \u306e\u79d8\u5bc6\u9375\u3068\u516c\u958b\u9375\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\u3053\u3053\u3067\u306f\u3001\u8a3c\u660e\u66f8\u306e\u4f5c\u6210\u65b9\u6cd5\u3092\u8aac\u660e\u3059\u308b\u308f\u3051\u3067\u306f\u3044\u306e\u3067\u3001\u30b3\u30de\u30f3\u30c9\u5185\u5bb9\u53ca\u3073\u6b63\u5f0f\u306a\u8a3c\u660e\u66f8\u767a\u884c\u624b\u9806\u3001\u30d5\u30a1\u30a4\u30eb\u306e\u6a29\u9650\u7b49\u306e\u8a73\u7d30\u306a\u8aac\u660e\u306f\u5272\u611b\u3057\u307e\u3059\u3002\n\nswmgr01\nswmgr01~$ sudo mkdir /etc/ssl/docker\nswmgr01~$ cd /etc/ssl/docker\nswmgr01~$\nswmgr01~$ CA_FQDN=ca.docker.example.com\nswmgr01~$ CA_CERT=${CA_FQDN}_cert.pem\nswmgr01~$ CA_KEY_ENC=${CA_FQDN}_key_enc.pem\nswmgr01~$\nswmgr01~$ echo \"01\" | sudo tee ca.srl\nswmgr01~$ sudo openssl genrsa -des3 -out $CA_KEY_ENC 2048\nswmgr01~$ sudo openssl req -new -x509 -days 365 -key $CA_KEY_ENC -out $CA_CERT \\\n                  -subj \"/C=JP/ST=Tokyo/L=Minatoku/O=Example Company/OU=Development/CN=$CA_FQDN\"\n\n\n\u4ee5\u4e0a\u3067CA \u306e\u79d8\u5bc6\u9375\u3068\u8a3c\u660e\u66f8\u306e\u4f5c\u6210\u306f\u5b8c\u4e86\u3067\u3059\u3002\n\u6b21\u306b\u30b5\u30fc\u30d0\u8a3c\u660e\u66f8\u3092\u4f5c\u6210\u3057\u3066\u3044\u304d\u307e\u3059\u3002\n1 \u70b9\u6ce8\u610f\u3059\u308b\u3053\u3068\u3068\u3057\u3066\u3001<codeswmgr01\u306e\u8a3c\u660e\u66f8\u306fextendedKeyUsage = clientAuth,serverAuth\u3092\u4ed8\u4e0e\u3057\u3066\u4f5c\u6210\u3059\u308b\u7528\u306b\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\u305d\u306e\u4ed6\u306e\u30b5\u30fc\u30d0swagt01,swagt02,swagt03`\u306b\u3064\u3044\u3066\u306f\u901a\u5e38\u306e\u30b5\u30fc\u30d0\u8a3c\u660e\u66f8\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\nswmgr01\nswmgr01~$ echo \"extendedKeyUsage = clientAuth,serverAuth\" | sudo tee server_and_client_auth.cnf\nswmgr01~$ \nswmgr01~$ SWMGR01_FQDN=swmgr01.example.com\nswmgr01~$ SWMGR01_KEY_ENC=${SWMGR01_FQDN}_key_enc.pem\nswmgr01~$ SWMGR01_KEY=${SWMGR01_FQDN}_key.pem\nswmgr01~$ SWMGR01_CSR=${SWMGR01_FQDN}.csr\nswmgr01~$ SWMGR01_CERT=${SWMGR01_FQDN}_cert.pem\nswmgr01~$ sudo openssl genrsa -des3 -out $SWMGR01_KEY_ENC 2048\nswmgr01~$ sudo openssl rsa -in $SWMGR01_KEY_ENC -out $SWMGR01_KEY\nswmgr01~$ sudo openssl req -new -key $SWMGR01_KEY -out $SWMGR01_CSR \\\n                  -subj \"/C=JP/ST=Tokyo/L=Hoge/O=Example Company/OU=Development/CN=$SWMGR01_FQDN\"\nswmgr01~$ sudo openssl x509 -extfile server_and_client_auth.cnf -req -days 365 -in $SWMGR01_CSR -CA $CA_CERT -CAkey $CA_KEY_ENC -out $SWMGR01_CERT\nswmgr01~$\nswmgr01~$ SWAGT01_FQDN=swagt01.example.com\nswmgr01~$ SWAGT01_KEY_ENC=${SWAGT01_FQDN}_key_enc.pem\nswmgr01~$ SWAGT01_KEY=${SWAGT01_FQDN}_key.pem\nswmgr01~$ SWAGT01_CSR=${SWAGT01_FQDN}.csr\nswmgr01~$ SWAGT01_CERT=${SWAGT01_FQDN}_cert.pem\nswmgr01~$ sudo openssl genrsa -des3 -out $SWAGT01_KEY_ENC 2048\nswmgr01~$ sudo openssl rsa -in $SWAGT01_KEY_ENC -out $SWAGT01_KEY\nswmgr01~$ sudo openssl req -new -key $SWAGT01_KEY -out $SWAGT01_CSR \\\n                  -subj \"/C=JP/ST=Tokyo/L=Hoge/O=Example Company/OU=Development/CN=$SWAGT01_FQDN\"\nswmgr01~$ sudo openssl x509 -req -days 365 -in $SWAGT01_CSR -CA $CA_CERT -CAkey $CA_KEY_ENC -out $SWAGT01_CERT\nswmgr01~$\nswmgr01~$ SWAGT02_FQDN=swagt02.example.com\nswmgr01~$ SWAGT02_KEY_ENC=${SWAGT02_FQDN}_key_enc.pem\nswmgr01~$ SWAGT02_KEY=${SWAGT02_FQDN}_key.pem\nswmgr01~$ SWAGT02_CSR=${SWAGT02_FQDN}.csr\nswmgr01~$ SWAGT02_CERT=${SWAGT02_FQDN}_cert.pem\nswmgr01~$ sudo openssl genrsa -des3 -out $SWAGT02_KEY_ENC 2048\nswmgr01~$ sudo openssl rsa -in $SWAGT02_KEY_ENC -out $SWAGT02_KEY\nswmgr01~$ sudo openssl req -new -key $SWAGT02_KEY -out $SWAGT02_CSR \\\n                  -subj \"/C=JP/ST=Tokyo/L=Hoge/O=Example Company/OU=Development/CN=$SWAGT02_FQDN\"\nswmgr01~$ sudo openssl x509 -req -days 365 -in $SWAGT02_CSR -CA $CA_CERT -CAkey $CA_KEY_ENC -out $SWAGT02_CERT\nswmgr01~$\nswmgr01~$ SWAGT03_FQDN=swagt03.example.com\nswmgr01~$ SWAGT03_KEY_ENC=${SWAGT03_FQDN}_key_enc.pem\nswmgr01~$ SWAGT03_KEY=${SWAGT03_FQDN}_key.pem\nswmgr01~$ SWAGT03_CSR=${SWAGT03_FQDN}.csr\nswmgr01~$ SWAGT03_CERT=${SWAGT03_FQDN}_cert.pem\nswmgr01~$ sudo openssl genrsa -des3 -out $SWAGT03_KEY_ENC 2048\nswmgr01~$ sudo openssl rsa -in $SWAGT03_KEY_ENC -out $SWAGT03_KEY\nswmgr01~$ sudo openssl req -new -key $SWAGT03_KEY -out $SWAGT03_CSR \\\n                  -subj \"/C=JP/ST=Tokyo/L=Hoge/O=Example Company/OU=Development/CN=$SWAGT03_FQDN\"\nswmgr01~$ sudo openssl x509 -req -days 365 -in $SWAGT03_CSR -CA $CA_CERT -CAkey $CA_KEY_ENC -out $SWAGT03_CERT\nswmgr01~$\nswmgr01~$ ls\nca.docker.example.com_cert.pem\nca.docker.example.com_key_enc.pem\nca.srl\nswagt01.example.com_cert.pem\nswagt01.example.com.csr\nswagt01.example.com_key_enc.pem\nswagt01.example.com_key.pem\nswagt02.example.com_cert.pem\nswagt02.example.com.csr\nswagt02.example.com_key_enc.pem\nswagt02.example.com_key.pem\nswagt03.example.com_cert.pem\nswagt03.example.com.csr\nswagt03.example.com_key_enc.pem\nswagt03.example.com_key.pem\nswmgr01.example.com_cert.pem\nswmgr01.example.com.csr\nswmgr01.example.com_key_enc.pem\nswmgr01.example.com_key.pem\n\n\n\u4ee5\u4e0a\u3067\u30b5\u30fc\u30d0\u8a3c\u660e\u66f8\u306e\u4f5c\u6210\u306f\u5b8c\u4e86\u3067\u3059\u3002\n\u3053\u308c\u3089\u306e\u30d5\u30a1\u30a4\u30eb*.example.com_cert.pem\u3001\u79d8\u5bc6\u9375\u30d5\u30a1\u30a4\u30eb*.example.com_key.pem CA \u8a3c\u660e\u66f8\u30d5\u30a1\u30a4\u30ebca.docker.example.com_cert.pem \u3092\u5404\u5bfe\u8c61\u30b5\u30fc\u30d0\u306e/etc/ssl/docker \u30c7\u30a3\u30ec\u30af\u30c8\u30ea(Docker \u30b3\u30f3\u30c6\u30caVolume \u3067\u30de\u30a6\u30f3\u30c8\u3067\u304d\u308b\u3068\u3053\u308d)\u3078\u8ee2\u9001\u3057\u3066\u304a\u3044\u3066\u304f\u3060\u3055\u3044\u3002\n\u7d9a\u3044\u3066\u3001\u5f8c\u307b\u3069\u7ba1\u7406\u7528\u7aef\u672b\u304b\u3089docker \u30b3\u30de\u30f3\u30c9\u3067Swarm cluster (Docker Swarm manager)\u306b\u30b3\u30de\u30f3\u30c9\u3092\u9001\u4fe1\u3059\u308b\u305f\u3081\u306eclient \u8a3c\u660e\u66f8\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\nclient\u8a3c\u660e\u66f8\u306e\u4f5c\u6210\nswmgr01~$ echo \"extendedKeyUsage = clientAuth\" | sudo tee client_only.cnf\nswmgr01~$\nswmgr01~$ DOCKER_CLIENT01_FQDN=client01.example.com\nswmgr01~$ DOCKER_CLIENT01_KEY_ENC=${DOCKER_CLIENT01_FQDN}_key_enc.pem\nswmgr01~$ DOCKER_CLIENT01_KEY=${DOCKER_CLIENT01_FQDN}_key.pem\nswmgr01~$ DOCKER_CLIENT01_CSR=${DOCKER_CLIENT01_FQDN}.csr\nswmgr01~$ DOCKER_CLIENT01_CERT=${DOCKER_CLIENT01_FQDN}_cert.pem\nswmgr01~$ sudo openssl genrsa -des3 -out $DOCKER_CLIENT01_KEY_ENC 2048\nswmgr01~$ sudo openssl rsa -in $DOCKER_CLIENT01_KEY_ENC -out $DOCKER_CLIENT01_KEY\nswmgr01~$ sudo openssl req -config /etc/ssl/openssl.cnf -new -key $DOCKER_CLIENT01_KEY -out $DOCKER_CLIENT01_CSR \\\n                  -subj \"/C=JP/ST=Tokyo/L=Hoge/O=Example Company/OU=Development/CN=$DOCKER_CLIENT01_FQDN\"\nswmgr01~$ sudo openssl x509 -extfile client_only.cnf -req -days 365 -in $DOCKER_CLIENT01_CSR -CA $CA_CERT -CAkey $CA_KEY_ENC -out $DOCKER_CLIENT01_CERT\n\n\n\u5404\u8a3c\u660e\u66f8\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3057\u305f\u3089\u3001\u4ee5\u4e0b\u306e\u901a\u308a\u8a3c\u660e\u66f8\u30d5\u30a1\u30a4\u30eb\u53ca\u3073\u79d8\u5bc6\u9375\u30d5\u30a1\u30a4\u30eb\u3092\u5404Docker Swarm agent swagt01-03 \u306e/etc/ssl/docker \u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306b\u8ee2\u9001\u3057\u3066\u304a\u3044\u3066\u304f\u3060\u3055\u3044\u3002\n\u8ee2\u9001\u304c\u5b8c\u4e86\u3057\u305f\u3089\u3001\u5404\u30d5\u30a1\u30a4\u30eb\u304cDocker daemon \u304b\u3089\u8aad\u307f\u53d6\u308a\u3067\u304d\u308b\u6a29\u9650\u306b\u8a2d\u5b9a\u3092\u3057\u3066\u304a\u3044\u3066\u304f\u3060\u3055\u3044\u3002\n\u8ee2\u9001\u3057\u3066\u304a\u304f\u30d5\u30a1\u30a4\u30eb\u306b\u3064\u3044\u3066\u306f\u305d\u308c\u305e\u308c\u4ee5\u4e0b\u306e\u3068\u304a\u308a\u3067\u3059\u3002\n\nswagt01\nswagt01~# ls -1 /etc/ssl/docker/\nca.docker.example.com_cert.pem      # CA \u306e\u8a3c\u660e\u66f8\nswagt01.example.com_cert.pem        # swagt01 \u7528\u30b5\u30fc\u30d0\u8a3c\u660e\u66f8\nswagt01.example.com_key.pem         # swagt01 \u7528\u30b5\u30fc\u30d0\u8a3c\u660e\u66f8\u306e\u79d8\u5bc6\u9375\n\n\n\nswagt02\nswagt02~# ls -1 /etc/ssl/docker/\nca.docker.example.com_cert.pem\nswagt02.example.com_cert.pem\nswagt02.example.com_key.pem\n\n\n\nswagt03\nswagt03~# ls -1 /etc/ssl/docker/\nca.docker.example.com_cert.pem\nswagt03.example.com_cert.pem\nswagt03.example.com_key.pem\n\n\n\nTLS \u8a8d\u8a3c\u3092\u884c\u3046\u306b\u3042\u305f\u308a\u4e8b\u524d\u6e96\u5099\n\u8a3c\u660e\u66f8\u8a8d\u8a3cON \u3067Docker Swarm agent \u3092\u8d77\u52d5\u3059\u308b\u306b\u3042\u305f\u308a\u3001\u524d\u56de\u8a18\u4e8b\u3067Docker Swarm manager 01, Docker Swarm agent 01-03 \u30b3\u30f3\u30c6\u30ca\u304c\u4f5c\u6210\u3055\u308c\u8d77\u52d5\u3057\u3066\u3044\u308b\u5834\u5408\u3001\u4e8b\u524d\u306b\u30b3\u30f3\u30c6\u30ca\u3092\u505c\u6b62\u3057\u3066\u524a\u9664\u3057\u3066\u304a\u304f\u3088\u3046\u306b\u3057\u3066\u304f\u3060\u3055\u3044(\u7406\u5c48\u7684\u306b\u306fswagt01-03 \u306e\u30b3\u30f3\u30c6\u30ca\u306f\u540c\u3058\u3082\u306e\u3092\u4f7f\u3044\u307e\u308f\u305b\u308b\u306e\u3067\u3059\u304c\u3001\u5ff5\u306e\u70ba\u2026)\u3002\n\nswmgr01\n$ docker stop swmgr01\n$ docker rm swmgr01\n\n\n\nswagt01\n$ docker stop swagt01\n$ docker rm swagt01\n\n\n\nswagt02\n$ docker stop swagt02\n$ docker rm swagt02\n\n\n\nswagt03\n$ docker stop swagt03\n$ docker rm swagt03\n\n\n\nTLS \u306b\u3088\u308b\u8a8d\u8a3c\u6a5f\u80fd\u3092ON \u306b\u3057\u3066Docker Swarm agent 01-03 \u306eDocker \u30db\u30b9\u30c8\u306eDocker daemon \u3092\u8d77\u52d5\u3059\u308b\nDocker Swarm agent 01-03 \u306eTLS \u8a8d\u8a3c\u6a5f\u80fd\u3092\u4f7f\u3046\u306b\u306f\u3001Docker Swarm agent \u306eDocker \u30db\u30b9\u30c8\u306eDocker daemon \u306eTLS \u6a5f\u80fd\u3092\u6709\u52b9\u306b\u3057\u307e\u3059\u3002\n/lib/systemd/system/docker.service \u30d5\u30a1\u30a4\u30eb\u3092\u958b\u304dExecStart \u306e\u5024\u3092\u6b21\u306e\u3088\u3046\u306b\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\n/lib/systemd/system/docker.serviceatswagt01\nExecStart=/usr/bin/docker daemon --tlsverify --tlscacert=/etc/ssl/docker/ca.docker.example.com_cert.pem --tlscert=/etc/ssl/docker/swagt01.example.com_cert.pem --tlskey=/etc/ssl/docker/swagt01.example.com_key.pem -H tcp://0.0.0.0:2376 -H unix:///var/run/docker.sock\n\n\n\n/lib/systemd/system/docker.serviceatswagt02\nExecStart=/usr/bin/docker daemon --tlsverify --tlscacert=/etc/ssl/docker/ca.docker.example.com_cert.pem --tlscert=/etc/ssl/docker/swagt02.example.com_cert.pem --tlskey=/etc/ssl/docker/swagt02.example.com_key.pem -H tcp://0.0.0.0:2376 -H unix:///var/run/docker.sock\n\n\n\n/lib/systemd/system/docker.serviceatswagt03\nExecStart=/usr/bin/docker daemon --tlsverify --tlscacert=/etc/ssl/docker/ca.docker.example.com_cert.pem --tlscert=/etc/ssl/docker/swagt03.example.com_cert.pem --tlskey=/etc/ssl/docker/swagt03.example.com_key.pem -H tcp://0.0.0.0:2376 -H unix:///var/run/docker.sock\n\n\n\u5404\u30b5\u30fc\u30d0\u306e/lib/systemd/system/docker.service \u30d5\u30a1\u30a4\u30eb\u3092\u66f8\u304d\u63db\u3048\u305f\u3089\u5404\u30b5\u30fc\u30d0\u4e0a\u3067systemctl daemon-reload \u3092\u5b9f\u884c\u3057\u3066docker \u3092\u518d\u8d77\u52d5\u3057\u307e\u3059\u3002\n\nswagt01-03\n# systemctl daemon-reload\n# systemctl restart docker\n\n\n\nDocker agent \u3092cluster \u306b\u53c2\u52a0\u3055\u305b\u308b\n\u5404Docker Swarm agent \u3067swarm join \u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3057\u3066cluster \u306b\u53c2\u52a0\u3055\u305b\u307e\u3059\u3002\n\nswagt01\n$ docker run --name swagt02 -d swarm join --addr=swagt02.example.com:2376 token://8f620653b5157592418a2da287dc722d\n\n\n\nswagt02\n$ docker run --name swagt02 -d swarm join --addr=swagt02.example.com:2376 token://8f620653b5157592418a2da287dc722d\n\n\n\nswagt03\n$ docker run --name swagt03 -d swarm join --addr=swagt03.example.com:2376 token://8f620653b5157592418a2da287dc722d\n\n\n\nswmgr01\n$ docker run --rm swarm list token://8f620653b5157592418a2da287dc722d\nswagt03.example.com:2376\nswagt02.example.com:2376\nswagt01.example.com:2376\n\n\n\nTLS \u306b\u3088\u308b\u8a8d\u8a3c\u6a5f\u80fd\u3092ON \u306b\u3057\u3066Docker Swarm manager 01 \u3092\u8d77\u52d5\u3059\u308b\nswmgr01 \u30ce\u30fc\u30c9\u3067\u6b21\u306e\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3057\u3066Docker Swarm manager 01 \u3092\u8d77\u52d5\u3057\u307e\u3059\u3002\n\u8d77\u52d5\u3059\u308b\u3068\u304d\u306b--tlsverify, --tlscacert, --tlscert, --tlskey \u30aa\u30d7\u30b7\u30e7\u30f3\u3092\u52a0\u3048\u3066TLS \u901a\u4fe1\u306b\u4f7f\u7528\u3059\u308b\u8a3c\u660e\u66f8\u30d5\u30a1\u30a4\u30eb\u53ca\u3073\u79d8\u5bc6\u9375\u3092\u6307\u5b9a\u3059\u308b\u3088\u3046\u306b\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\u307e\u305f\u3001\u4ed6\u306e\u30ce\u30fc\u30c9\u306e\u540d\u524d\u89e3\u6c7a\u304c\u3067\u304d\u308b\u3088\u3046\u306b--add-host \u30aa\u30d7\u30b7\u30e7\u30f3\u3067\u540d\u524d\u89e3\u6c7a\u306e\u5b9a\u7fa9\u3092\u8ffd\u52a0\u3057\u3001Docker \u30db\u30b9\u30c8\u306e2376 port \u306b\u30d0\u30a4\u30f3\u30c9\u3059\u308b\u3088\u3046\u306b\u6307\u5b9a\u3057\u307e\u3059\u3002\n\nswmgr01\nswmgr01~$ docker run --name swmgr01 -d -v /etc/ssl/docker:/etc/ssl/docker -p 2376:2375 \\\n              --add-host swagt01.example.com:192.168.1.131 --add-host swagt02.example.com:192.168.1.132 --add-host swagt03.example.com:192.168.1.133 \\\n              swarm manage --tlsverify \\\n              --tlscacert=/etc/ssl/docker/ca.docker.example.com_cert.pem \\\n              --tlscert=/etc/ssl/docker/swmgr01.example.com_cert.pem \\\n              --tlskey=/etc/ssl/docker/swmgr01.example.com_key.pem \\\n              token://8f620653b5157592418a2da287dc722d\n\n\n\nDocker Swarm manager 01 \u306e\u8d77\u52d5\u72b6\u614b\u3092\u78ba\u8a8d\u3059\u308b\ndocker info \u30b3\u30de\u30f3\u30c9\u3092\u4f7f\u3063\u3066Docker Swarm manager 01 \u304c\u8d77\u52d5\u3057\u3066\u3044\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\nTLS \u8a8d\u8a3c\u3092\u4f7f\u7528\u3057\u3066\u5b9f\u884c\u3059\u308b\u3053\u3068\u306b\u306a\u308b\u306e\u3067\u3001\u30b3\u30de\u30f3\u30c9\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\n\nswmgr01\n$ docker --tlsverify --tlscacert=/etc/ssl/docker/ca.docker.example.com_cert.pem --tlscert=/etc/ssl/docker/client01.example.com_cert.pem --tlskey=/etc/ssl/docker/client01.example.com_key.pem -H tcp://swmgr01.example.com:2376 info\nContainers: 0\nImages: 0\nRole: primary\nStrategy: spread\nFilters: health, port, dependency, affinity, constraint\nNodes: 0\nCPUs: 0\nTotal Memory: 0 B\nName: 5e38ce882c24\n\n\n\u307e\u305f\u3001ps -a \u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3057\u3066\u3001\u5404Docker Swarm agent \u4e0a\u3067\u8d77\u52d5\u3057\u3066\u3044\u308b\u30b3\u30f3\u30c6\u30ca\u3092\u78ba\u8a8d\u3057\u3066\u307f\u307e\u3057\u3087\u3046\u3002\n$ docker --tlsverify -H tcp://swmgr01.example.com:2376 ps -a\nCONTAINER ID        IMAGE               COMMAND                  CREATED              STATUS              PORTS               NAMES\nda4ed91cc851        swarm               \"/swarm join --addr=s\"   About a minute ago   Up About a minute   2375/tcp            swagt03/swagt03\nc55b9bb6f605        swarm               \"/swarm join --addr=s\"   2 minutes ago        Up 2 minutes        2375/tcp            swagt02/swagt02\nb5ebf34afd62        swarm               \"/swarm join --addr=s\"   2 minutes ago        Up 2 minutes        2375/tcp            swagt01/swagt01\n\n\u4e0a\u8a18\u306e\u3088\u3046\u306b\u7d50\u679c\u304c\u51fa\u529b\u3055\u308c\u308c\u3070\u6210\u529f\u3067\u3059\u3002\n\u4ee5\u4e0a\u3067Docker Swarm cluster \u3092TLS \u5316\u3059\u308b\u624b\u9806\u306f\u5b8c\u4e86\u3067\u3059\u3002\n\n\u88dc\u8db3: ps -a \u30b3\u30de\u30f3\u30c9\u3067\u5168\u3066\u306eDocker Swarm agent \u304c\u8868\u793a\u3055\u308c\u306a\u3044\u5834\u5408\n\u8a73\u3057\u3044\u539f\u56e0\u306f\u308f\u304b\u3063\u3066\u3044\u307e\u305b\u3093\u304c\u3001docker --tlsverify -H tcp://swmgr01.example.com:2376 ps -a \u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3057\u305f\u6642\u306b\u5168\u3066\u306eDocker Swarm agent \u30ce\u30fc\u30c9\u4e0a\u306e\u30b3\u30f3\u30c6\u30ca\u304c\u8868\u793a\u3055\u308c\u306a\u3044\u3053\u3068\u304c\u3042\u308a\u307e\u3059\u3002\n\u305d\u306e\u5834\u5408\u306f\u3001Docker Swarm manager 01 \u306eDocker Swarm manager \u30b3\u30f3\u30c6\u30ca\u3092\u4e00\u65e6\u524a\u9664\u3057\u3066\u304b\u3089\u3001\u518d\u5ea6Docker Swarm manager \u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3057\u3066\u307f\u3066\u304f\u3060\u3055\u3044\u3002\n\n\u88dc\u8db3: TLS \u95a2\u9023\u306e\u30aa\u30d7\u30b7\u30e7\u30f3\u3092\u7701\u7565\u3059\u308b\nTLS \u3092\u4f7f\u3063\u305f\u30b3\u30de\u30f3\u30c9\u306e\u767a\u884c\u304c\u3067\u304d\u308b\u3053\u3068\u306f\u78ba\u8a8d\u3067\u304d\u307e\u3057\u305f\u304c\u3001\u3053\u308c\u3067\u306f\u30aa\u30d7\u30b7\u30e7\u30f3\u304c\u5197\u9577\u3067\u6bce\u56de\u6307\u5b9a\u3057\u3066\u3044\u3089\u308c\u306a\u3044\u306e\u3067\u3001\u8a3c\u660e\u66f8\u53ca\u3073\u9375\u3092\u660e\u793a\u7684\u306b\u6307\u5b9a\u3057\u306a\u3044\u3067\u5b9f\u884c\u3067\u304d\u308b\u3088\u3046\u306b\u3057\u307e\u3059\u3002\n~/.docker \u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u65b0\u898f\u306b\u4f5c\u6210\u3057\u3001\u305d\u3053\u306bca.pem, cert.pem, key.pem \u3068\u3044\u3046\u30d5\u30a1\u30a4\u30eb\u540d\u3067\u305d\u308c\u305e\u308cclient \u8a3c\u660e\u66f8\u3068CA \u306e\u8a3c\u660e\u66f8\u30d5\u30a1\u30a4\u30eb\u3092\u8a2d\u7f6e\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\u4eca\u56de\u306f\u65e2\u306b/etc/ssl/docker \u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306bclient \u7528\u306e\u8a3c\u660e\u66f8\u53ca\u3073\u79d8\u5bc6\u9375\u304c\u7528\u610f\u3055\u308c\u3066\u3044\u308b\u306e\u3067\u305d\u308c\u306b\u5bfe\u3057\u3066\u30b7\u30f3\u30dc\u30ea\u30c3\u30af\u30ea\u30f3\u30af\u3092\u4f5c\u6210\u3057\u3066\u5bfe\u5fdc\u3057\u307e\u3059\u3002\n\n~/.docker\n$ cd ~\n$ mkdir ~/.docker\n$ cd .docker\n$ ln -s /etc/ssl/docker/ca.docker.example.com_cert.pem ca.pem\n$ ln -s /etc/ssl/docker/client01.example.com_cert.pem cert.pem\n$ ln -s /etc/ssl/docker/client01.example.com_key.pem key.pem\n\n\n\u30d5\u30a1\u30a4\u30eb\u306e\u6e96\u5099\u304c\u3067\u304d\u305f\u3089\u3082\u3046\u4e00\u5ea6\u6b21\u306e\u3088\u3046\u306bdocker info \u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3057\u3066\u307f\u307e\u3057\u3087\u3046\u3002\n\ndockerinfo\n$ docker --tlsverify -H tcp://swmgr01.example.com:2376 info\nContainers: 0\nImages: 0\nRole: primary\nStrategy: spread\nFilters: health, port, dependency, affinity, constraint\nNodes: 0\nCPUs: 0\nTotal Memory: 0 B\nName: 5e38ce882c24\n\n\n\u5148\u307b\u3069\u3068\u540c\u69d8\u306a\u5185\u5bb9\u304c\u51fa\u529b\u3055\u308c\u308c\u3070\u6210\u529f\u3067\u3059\u3002\n\n\u88dc\u8db3: \u66f4\u306b\u30aa\u30d7\u30b7\u30e7\u30f3\u3092\u7701\u7565\u3057\u305f\u3044\n\u66f4\u306bdocker \u30b3\u30de\u30f3\u30c9\u306e-H \u53ca\u3073--tlsverify \u30aa\u30d7\u30b7\u30e7\u30f3\u3092\u7701\u7565\u3057\u305f\u3044\u5834\u5408\u3001DOCKER_HOST, DOCKER_TLS_VERIFY \u74b0\u5883\u5909\u6570\u3092\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\nswmgr01\nexport DOCKER_HOST=tcp://swmgr01.example.com:2376\nexport DOCKER_TLS_VERIFY=1\n\n\n\u306a\u304a\u3001\u672c\u8aac\u660e\u3067\u306f\u3053\u306e\u74b0\u5883\u5909\u6570\u306f\u8a2d\u5b9a\u305b\u305a\u306b\u7d9a\u3051\u3066\u3044\u304d\u307e\u3059\u3002\n\n\u88dc\u8db3: Docker client \u306e\u8a3c\u660e\u66f8\u30d5\u30a1\u30a4\u30eb\u3092\u4fdd\u7ba1\u3059\u308b\u5834\u6240\u306b\u3064\u3044\u3066\nDocker \u30b3\u30de\u30f3\u30c9\u5b9f\u884c\u6642\u306b\u4f7f\u7528\u3059\u308b\u8a3c\u660e\u66f8\u30d5\u30a1\u30a4\u30eb\u3001\u79d8\u5bc6\u9375\u30d5\u30a1\u30a4\u30eb\u306e\u4fdd\u7ba1\u5834\u6240\u3092\u5225\u306e\u5834\u6240\u306b\u3057\u305f\u3044\u5834\u5408\u3001DOCKER_CERT_PATH \u74b0\u5883\u5909\u6570\u3092\u8a2d\u5b9a\u3057\u3066\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u6307\u5b9a\u3059\u308b\u3088\u3046\u306b\u3057\u307e\u3059\u3002\n\u4f8b\u3048\u3070~/.docker/swmgr01.example.com \u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306b\u5909\u66f4\u3057\u305f\u3044\u5834\u5408\u306f\u6b21\u306e\u3088\u3046\u306b\u3057\u307e\u3059\u3002\n\nDOCKER_CERT_PATH\n$ export DOCKER_CERT_PATH=~/.docker/swmgr01.example.com\n\n\n\u306a\u304a\u3001\u672c\u8aac\u660e\u3067\u306f\u3053\u306e\u74b0\u5883\u5909\u6570\u306f\u8a2d\u5b9a\u305b\u305a\u306b\u7d9a\u3051\u3066\u3044\u304d\u307e\u3059\u3002\n\nDocker swarm cluster \u4e0a\u306b\u30b3\u30f3\u30c6\u30ca\u3092\u4f5c\u6210\u3057\u3066\u307f\u308b\n\u8a66\u3057\u306bDocker Swarm cluster \u4e0a\u306bbusybox \u30b3\u30f3\u30c6\u30ca\u3092\u4f5c\u6210\u3057\u3066\u307f\u307e\u3057\u3087\u3046\u3002\n\u30b3\u30de\u30f3\u30c9\u306f\u6b21\u306e\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\n\nbusybox\u30b3\u30f3\u30c6\u30ca\u3092\u4f5c\u6210\u3057\u3066\u307f\u308b\n# docker -H tcp://swmgr01.example.com:2376 --tlsverify run --name test_busybox -ti busybox /bin/sh\n/ # id \nuid#0(root) gid=0(root) groups10(wheel)\n/ # hostname\n7da820ef32bf\n/ # exit\n\n\n\u4e0a\u8a18\u306e\u3088\u3046\u306bbusybox \u306e\u30d7\u30ed\u30f3\u30d7\u30c8\u304c\u8868\u793a\u3055\u308c\u308c\u3070\u30b3\u30f3\u30c6\u30ca\u306e\u8d77\u52d5\u306f\u6210\u529f\u3067\u3059\u3002\n\u6b21\u306b\u3001\u3053\u306e\u30b3\u30f3\u30c6\u30ca\u304c\u3069\u306eDocker Swarm agent \u4e0a\u306b\u4f5c\u6210\u3055\u308c\u3066\u3044\u308b\u304b\u3092\u3001docker ps -a \u30b3\u30de\u30f3\u30c9\u3092\u4f7f\u3063\u3066\u78ba\u8a8d\u3057\u3066\u307f\u307e\u3057\u3087\u3046\u3002\n\ndockerps-a\n$ docker -H tcp://swmgr01.example.com:2376 --tlsverify ps -a\nCONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS                     PORTS               NAMES\n7da820ef32bf        busybox             \"/bin/sh\"                3 minutes ago       Exited (0) 2 minutes ago                       swagt03/test_busybox\na09b115c23ac        swarm               \"/swarm join --addr=s\"   13 minutes ago      Up 13 minutes              2376/tcp            swagt03/swagt03\ne7c6ad6c04e0        swarm               \"/swarm join --addr=s\"   13 minutes ago      Up 13 minutes              2376/tcp            swagt02/swagt02\n7656721e2cb8        swarm               \"/swarm join --addr=s\"   46 hours ago        Up 23 minutes              2376/tcp            swagt01/swagt01\n\n\n\u30b3\u30de\u30f3\u30c9\u306e\u51fa\u529b\u7d50\u679c\u3092\u898b\u3066\u307f\u308b\u3068\u3001busybox \u30b3\u30f3\u30c6\u30ca\u304cswagt03 \u306b\u4f5c\u6210\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308a\u307e\u3059\u3002\n\u5b9f\u969b\u3001\u3069\u306eDocker Swarm agent \u30ce\u30fc\u30c9\u306b\u30b3\u30f3\u30c6\u30ca\u304c\u4f5c\u6210\u3055\u308c\u308b\u304b\u306f\u3001\u74b0\u5883\u306b\u3088\u3063\u3066\u7570\u306a\u308b\u53ef\u80fd\u6027\u304c\u6709\u308a\u307e\u3059\u3002\n\u7d9a\u3051\u3066\u5e7e\u3064\u304b\u306e\u30b3\u30f3\u30c6\u30ca\u3092\u4f5c\u6210\u3057\u3001\u3082\u3046\u4e00\u5ea6docker ps -a \u30b3\u30de\u30f3\u30c9\u3067\u30b3\u30f3\u30c6\u30ca\u304c\u3069\u3053\u306b\u4f5c\u6210\u3055\u308c\u308b\u304b\u3092\u78ba\u8a8d\u3057\u3066\u307f\u307e\u3057\u3087\u3046\u3002\n\ndockerps-a\n$ docker -H tcp://swmgr01.example.com:2376 --tlsverify ps -a\nCONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS                        PORTS               NAMES\ne5b10b3b5443        redis               \"/entrypoint.sh redis\"   42 seconds ago      Exited (127) 40 seconds ago                       swagt03/test_hello_redis\na640ba5f165a        mysql               \"/entrypoint.sh mysql\"   5 minutes ago       Exited (1) 5 minutes ago                          swagt01/test_mysql\n85b1655aa3f9        node                \"node\"                   10 minutes ago      Exited (0) 9 minutes ago                          swagt02/test_nodejs\n2af70f9ebbbd        debian              \"/bin/bash\"              18 minutes ago      Exited (130) 14 minutes ago                       swagt01/test_debian\n7da820ef32bf        busybox             \"/bin/sh\"                28 minutes ago      Exited (0) 27 minutes ago                         swagt03/test_busybox\na09b115c23ac        swarm               \"/swarm join --addr=s\"   38 minutes ago      Up 38 minutes                 2376/tcp            swagt03/swagt03\ne7c6ad6c04e0        swarm               \"/swarm join --addr=s\"   38 minutes ago      Up 38 minutes                 2376/tcp            swagt02/swagt02\n7656721e2cb8        swarm               \"/swarm join --addr=s\"   47 hours ago        Up 48 minutes                 2376/tcp            swagt01/swagt01\n\n\n\u4e0a\u8a18\u306e\u7528\u306bDocker Swarm cluster \u4e0a\u306e\u30ce\u30fc\u30c9\u306b\u5206\u6563\u3057\u3066\u4f5c\u6210\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308a\u307e\u3059\u3002\n\u4ee5\u4e0a\u3067Docker Swarm cluster \u3092TLS \u5316\u3057\u3066\u52d5\u4f5c\u3092\u78ba\u8a8d\u3059\u308b\u307e\u3067\u306e\u624b\u9806\u306f\u5b8c\u4e86\u3067\u3059\u3002\n\n\u304a\u307e\u3051: \u5404\u8a3c\u660e\u66f8(public key, private key pair)\u3092ECC(\u6955\u5186\u66f2\u7dda\u6697\u53f7)\u3067\u4f5c\u6210\u3059\u308b\n2016/01 \u73fe\u5728\u3001\u8a3c\u660e\u66f8\u306e\u4f5c\u6210\u624b\u9806\u306f\u591a\u304f\u306eWeb \u306b\u8ee2\u304c\u3063\u3066\u3044\u308b\u8cc7\u6599\u306b\u3088\u308b\u3068RSA \u65b9\u5f0f\u3067\u4f5c\u6210\u3055\u308c\u3066\u3044\u307e\u3059\u304c\u3001\u3053\u3053\u3067\u6b21\u4e16\u4ee3\u306e\u6697\u53f7\u65b9\u5f0f\u3068\u3057\u3066\u6ce8\u76ee\u3055\u308c\u3066\u3044\u308bECC \u3067\u5404\u8a3c\u660e\u66f8\u3092\u4f5c\u6210\u3057\u3066Docker Swarm cluster \u5185\u3067\u5229\u7528\u3057\u3066\u307f\u307e\u3057\u3087\u3046\u3002\nECC \u5f62\u5f0f\u306b\u3059\u308b\u3053\u3068\u3067\u3001RSA \u3088\u308a\u3082\u5c11\u306a\u3044\u9375\u9577\u3067\u3088\u308a\u9ad8\u3044\u6697\u53f7\u5f37\u5ea6\u3092\u5f97\u308b\u3053\u3068\u304c\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u308b\u3068\u3044\u308f\u308c\u3066\u3044\u307e\u3059\u3002\n\u3053\u3053\u3067\u306fswmgr01 \u306eDocker \u30db\u30b9\u30c8\u4e0a\u3067ECC \u3067\u8a3c\u660e\u66f8\u3092\u4f5c\u6210\u3057\u305f\u6642\u306e\u624b\u9806\u3060\u3051\u3092\u6b8b\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\u305d\u306e\u4ed6\u3001\u8a3c\u660e\u66f8\u306e\u8a2d\u7f6e\u624b\u9806\u306b\u3064\u3044\u3066\u306f\u3053\u308c\u307e\u3067\u3067\u8aac\u660e\u3057\u305f\u624b\u9806\u3068\u5909\u308f\u308a\u3042\u308a\u307e\u305b\u3093\u3002\n\nCreateCACertificatewithECC\nsudo mkdir /etc/ssl/docker\ncd /etc/ssl/docker\necho \"01\" | sudo tee ca.srl\n\nCA_FQDN=ca.docker.example.com\nCA_CERT=${CA_FQDN}_cert.pem\nCA_KEY=${CA_FQDN}_key.pem\n\nsudo openssl ecparam -out $CA_KEY -name prime256v1 -genkey\nsudo openssl req -new -x509 -days 365 -key $CA_KEY -out $CA_CERT \\\n        -subj \"/C=JP/ST=Tokyo/L=Minatoku/O=Example Company/OU=Development/CN=$CA_FQDN\"\n\n\n\nCreateswmgr01'sCertificatewithECC\necho \"extendedKeyUsage = clientAuth,serverAuth\" | sudo tee server_and_client_auth.cnf\n\nSWMGR01_FQDN=swmgr01.example.com\nSWMGR01_KEY=${SWMGR01_FQDN}_key.pem\nSWMGR01_CSR=${SWMGR01_FQDN}.csr\nSWMGR01_CERT=${SWMGR01_FQDN}_cert.pem\nsudo openssl ecparam -out $SWMGR01_KEY -name prime256v1 -genkey\nsudo openssl req -new -key $SWMGR01_KEY -sha256 -out $SWMGR01_CSR \\\n        -subj \"/C=JP/ST=Tokyo/L=Hoge/O=Example Company/OU=Development/CN=$SWMGR01_FQDN\"\nsudo openssl x509 -extfile server_and_client_auth.cnf -req -days 365 -in $SWMGR01_CSR -CA $CA_CERT -CAkey $CA_KEY -out $SWMGR01_CERT\n\n\n\nCreateswagt01'sCertificatewithECC\nSWAGT01_FQDN=swagt01.example.com\nSWAGT01_KEY=${SWAGT01_FQDN}_key.pem\nSWAGT01_CSR=${SWAGT01_FQDN}.csr\nSWAGT01_CERT=${SWAGT01_FQDN}_cert.pem\nsudo openssl ecparam -out $SWAGT01_KEY -name prime256v1 -genkey\nsudo openssl req -new -key $SWAGT01_KEY -sha256 -out $SWAGT01_CSR \\\n        -subj \"/C=JP/ST=Tokyo/L=Hoge/O=Example Company/OU=Development/CN=$SWAGT01_FQDN\"\nsudo openssl x509 -req -days 365 -in $SWAGT01_CSR -CA $CA_CERT -CAkey $CA_KEY -out $SWAGT01_CERT\n\n\n\nCreateswagt02'sCertificatewithECC\nSWAGT02_FQDN=swagt02.example.com\nSWAGT02_KEY=${SWAGT02_FQDN}_key.pem\nSWAGT02_CSR=${SWAGT02_FQDN}.csr\nSWAGT02_CERT=${SWAGT02_FQDN}_cert.pem\nsudo openssl ecparam -out $SWAGT02_KEY -name prime256v1 -genkey\nsudo openssl req -new -key $SWAGT02_KEY -sha256 -out $SWAGT02_CSR \\\n        -subj \"/C=JP/ST=Tokyo/L=Hoge/O=Example Company/OU=Development/CN=$SWAGT02_FQDN\"\nsudo openssl x509 -req -days 365 -in $SWAGT02_CSR -CA $CA_CERT -CAkey $CA_KEY -out $SWAGT02_CERT\n\n\n\nCreateswagt03'sCertificatewithECC\nSWAGT03_FQDN=swagt03.example.com\nSWAGT03_KEY=${SWAGT03_FQDN}_key.pem\nSWAGT03_CSR=${SWAGT03_FQDN}.csr\nSWAGT03_CERT=${SWAGT03_FQDN}_cert.pem\nsudo openssl ecparam -out $SWAGT03_KEY -name prime256v1 -genkey\nsudo openssl req -new -key $SWAGT03_KEY -sha256 -out $SWAGT03_CSR \\\n        -subj \"/C=JP/ST=Tokyo/L=Hoge/O=Example Company/OU=Development/CN=$SWAGT03_FQDN\"\nsudo openssl x509 -req -days 365 -in $SWAGT03_CSR -CA $CA_CERT -CAkey $CA_KEY -out $SWAGT03_CERT\n\n\n\nCreateswagt03'sCertificatewithECC\nDOCKER_CLIENT01_FQDN=client01.example.com\nDOCKER_CLIENT01_KEY=${DOCKER_CLIENT01_FQDN}_key.pem\nDOCKER_CLIENT01_CSR=${DOCKER_CLIENT01_FQDN}.csr\nDOCKER_CLIENT01_CERT=${DOCKER_CLIENT01_FQDN}_cert.pem\nsudo openssl ecparam -out $DOCKER_CLIENT01_KEY -name prime256v1 -genkey\nsudo openssl req -config /etc/ssl/openssl.cnf -new -key $DOCKER_CLIENT01_KEY -sha256 -out $DOCKER_CLIENT01_CSR \\\n        -subj \"/C=JP/ST=Tokyo/L=Hoge/O=Example Company/OU=Development/CN=$DOCKER_CLIENT01_FQDN\"\nsudo openssl x509 -extfile client_only.cnf -req -days 365 -in $DOCKER_CLIENT01_CSR -CA $CA_CERT -CAkey $CA_KEY -out $DOCKER_CLIENT01_CERT\n\n\n\n\u53c2\u8003\n\n Docker Swarm overview\n https://docs.docker.com/swarm/\n\n\n Install and Create a Docker Swarm\n https://docs.docker.com/swarm/install-w-machine/\n\n\n Docker Tutorial : Getting Started With Docker Swarm\n http://devopscube.com/docker-tutorial-getting-started-with-docker-swarm/\n\n\n Create a swarm for development\n https://docs.docker.com/swarm/install-manual/\n\n\n DOCKER SWARM WITH TLS AUTHENTICATION\n http://www.blackfinsecurity.com/docker-swarm-with-tls-authentication/\n\n\n Protect the Docker daemon socket\n https://docs.docker.com/engine/articles/https/\n\n\n Docker Swarm\u3067\u8907\u6570Docker\u30db\u30b9\u30c8\u304b\u3089\u30af\u30e9\u30b9\u30bf\u3092\u4f5c\u308b\n http://blog.takanabe.tokyo/2015/11/23/1565/\n\n\n etcd security model\n https://coreos.com/etcd/docs/0.4.7/etcd-security/\n\n\n Intro to Docker Swarm: Part 2 - Configuration Options and Requirements\n http://www.hnwatcher.com/r/1644394/Intro-to-Docker-Swarm-Part-2-Comfiguration-Modes-and-Requirements\n\n# TLS \u8a8d\u8a3c \n\u524d\u56de\u306e\u8a18\u4e8b\u3067\u3001Docker Swarm \u306e\u69cb\u7bc9\u306b\u3064\u3044\u3066\u3084\u3063\u3066\u3044\u304d\u307e\u3057\u305f\u3002\n\n[Docker Swarm \u5165\u9580\u30cf\u30f3\u30ba\u30aa\u30f3](http://qiita.com/TsutomuNakamura/items/6124ab7d32a58bc93ac7)\n\nDocker Swarm cluster \u5185\u306e\u901a\u4fe1\u3092TLS \u3067\u884c\u3046\u3053\u3068\u304c\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u3063\u3066\u304a\u308a\u3001Docker Swarm cluster \u9593\u306eDocker \u306e\u901a\u4fe1\u306e\u6a5f\u5bc6\u6027\u3092\u9ad8\u3081\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\nTLS \u3067\u4f7f\u3046\u8a3c\u660e\u66f8\u306f\u81ea\u5206\u306e\u624b\u5143\u306e\u30b3\u30f3\u30d4\u30e5\u30fc\u30bf\u3067\u4f5c\u6210\u3057\u305fCA \u306e\u7f72\u540d\u304c\u3064\u3044\u305f\u3082\u306e\u3067\u69cb\u3044\u307e\u305b\u3093\u304c\u3001\u6761\u4ef6\u3068\u3057\u3066Docker Swarm manager\u3001Docker Swarm agent(\u5404agent \u306eDocker daemon)\u3001Docker client \u3067\u4f7f\u7528\u3059\u308b\u8a3c\u660e\u66f8\u306f\u3069\u308c\u3082\u540c\u3058CA \u304b\u3089\u7f72\u540d\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u304c\u6761\u4ef6\u3068\u306a\u3063\u3066\u3044\u307e\u3059\u3002\n\u307e\u305f\u3001Docker Swarm manager \u306e\u8a3c\u660e\u66f8\u306fopenssl \u306e`extendedKeyUsage = clientAuth,serverAuth` \u30aa\u30d7\u30b7\u30e7\u30f3\u3067\u3001Docker client \u306e\u8a3c\u660e\u66f8\u306f`extendedKeyUsage = clientAuth` \u30aa\u30d7\u30b7\u30e7\u30f3\u3067\u4f5c\u6210\u3059\u308b\u3088\u3046\u306b\u3057\u307e\u3059\u3002\n\n\u4eca\u56de\u306f\u691c\u8a3c\u76ee\u7684\u306a\u306e\u3067\u3001\u624b\u3063\u53d6\u308a\u65e9\u3055\u3092\u91cd\u8996\u3057\u3066\u3001Docker Swarm manager \u306eDocker \u30db\u30b9\u30c8\u4e0a\u306bCA \u3092\u4f5c\u6210\u3057\u3001Docker Swarm manager\u3001\u5404Docker Swarm agent \u306e\u30b5\u30fc\u30d0\u8a3c\u660e\u66f8\u3001Docker Swarm manager \u306eDocker \u30db\u30b9\u30c8\u304b\u3089\u30b3\u30de\u30f3\u30c9\u3092\u767a\u884c\u3059\u308b\u305f\u3081\u306e\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u8a3c\u660e\u66f8\u3092\u305d\u308c\u305e\u308c\u4f5c\u6210\u3057\u3066\u691c\u8a3c\u3057\u3066\u307f\u308b\u3053\u3068\u306b\u3057\u307e\u3059\u3002\n\n![Docker_SwarmOnTLS0000.png](https://qiita-image-store.s3.amazonaws.com/0/70152/2c0d18b0-38fe-76be-3fca-0e96665b1707.png)\n\n## \u69cb\u6210 \n\u4eca\u56de\u3001\u8a3c\u660e\u66f8\u3092\u4f7f\u7528\u3057\u3066\u8a8d\u8a3c\u3092\u884c\u3046\u305f\u3081\u306b\u8a3c\u660e\u66f8\u306eCN(\u30b3\u30e2\u30f3\u30cd\u30fc\u30e0) \u3068\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3068\u304d\u306b\u4f7f\u3046FQDN \u3092\u4e00\u81f4\u3055\u305b\u3066\u304a\u304f\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\u3053\u308c\u3088\u308a\u5148\u306b\u9032\u3080\u4e0a\u3067\u6df7\u4e71\u3092\u907f\u3051\u308b\u305f\u3081\u3001\u3053\u3053\u3067\u4e00\u65e6\u3001\u7528\u8a9e\u3068FQDN \u53ca\u3073\u305d\u308c\u305e\u308c\u306e\u30b3\u30f3\u30dd\u30fc\u30cd\u30f3\u30c8\u306e\u7528\u9014\u7b49\u306b\u3064\u3044\u3066\u6b21\u306e\u3088\u3046\u306b\u5b9a\u7fa9\u3057\u3066\u7f6e\u304f\u3082\u306e\u3068\u3057\u307e\u3059\u3002\n\n\n* \u69cb\u6210\n<table><tbody>\n  <tr>\n    <th> \u540d\u524d</th>\n    <th> IP \u30a2\u30c9\u30ec\u30b9</th>\n    <th> FQDN</th>\n    <th> (Host) OS</th>\n    <th> Docker ver</th>\n    <th> \u5099\u8003</th>\n  </tr>\n  <tr>\n    <td> Docker Swarm manager \u30db\u30b9\u30c8</td>\n    <td> 192.168.1.121</td>\n    <td> -</td>\n    <td> Ubuntu 15.10</td>\n    <td> 1.9.1</td>\n    <td> Docker Swarm manager \u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3057\u3066\u3044\u308b\u7269\u7406\u30db\u30b9\u30c8/Docker \u30db\u30b9\u30c8\u3002\u4eca\u56de\u3001\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u3068\u3057\u3066\u30b3\u30de\u30f3\u30c9\u3092\u9001\u4fe1\u3059\u308b\u4f5c\u696d\u7aef\u672b\u3068\u3057\u3066\u3082\u5229\u7528</td>\n  </tr>\n  <tr>\n    <td> Docker Swarm manager 01 (swmgr01)</td>\n    <td> 192.168.1.121</td>\n    <td> swmgr01.example.com</td>\n    <td> Ubuntu 15.10</td>\n    <td> 1.9.1</td>\n    <td> Docker Swarm manager \u30b3\u30f3\u30c6\u30ca\u3002\u3053\u306eFQDN \u306fDocker Swarm manager \u30db\u30b9\u30c8\u306e/etc/hosts \u30d5\u30a1\u30a4\u30eb\u306b\u767b\u9332\u3057\u3066\u304a\u304f</td>\n  </tr>\n  <tr>\n    <td> Docker Swarm manager 01 (swagt01)</td>\n    <td> 192.168.1.131</td>\n    <td> swagt01.example.com</td>\n    <td> Debian jessie</td>\n    <td> 1.9.1</td>\n    <td> Docker Swarm agent \u30b3\u30f3\u30c6\u30ca1 \u53f7\u6a5f\u3002\u3053\u306eFQDN \u306fDocker Swarm manager \u306e/etc/hosts(--add-host) \u306b\u767b\u9332\u3057\u3066\u304a\u304f</td>\n  </tr>\n  <tr>\n    <td> Docker Swarm manager 02 (swagt02)</td>\n    <td> 192.168.1.132</td>\n    <td> swagt02.example.com</td>\n    <td> Debian jessie</td>\n    <td> 1.9.1</td>\n    <td> Docker Swarm agent \u30b3\u30f3\u30c6\u30ca2 \u53f7\u6a5f\u3002\u3053\u306eFQDN \u306fDocker Swarm manager \u306e/etc/hosts(--add-host) \u306b\u767b\u9332\u3057\u3066\u304a\u304f</td>\n  </tr>\n  <tr>\n    <td> Docker Swarm manager 03 (swagt03)</td>\n    <td> 192.168.1.133</td>\n    <td> swagt03.example.com</td>\n    <td> Debian jessie</td>\n    <td> 1.9.1</td>\n    <td> Docker Swarm agent \u30b3\u30f3\u30c6\u30ca3 \u53f7\u6a5f\u3002\u3053\u306eFQDN \u306fDocker Swarm manager \u306e/etc/hosts(--add-host) \u306b\u767b\u9332\u3057\u3066\u304a\u304f</td>\n  </tr>\n</tbody></table>\n\n\u4eca\u56de\u306f\u3053\u308c\u3089\u306eFQDN \u3092`/etc/hosts` \u3082\u3057\u304f\u306f`--add-host` \u306b\u3066\u767b\u9332\u3057\u307e\u3059\u304c\u3001\u305d\u308c\u305e\u308c\u306e\u30db\u30b9\u30c8\u53ca\u3073\u30b3\u30f3\u30c6\u30ca\u304c\u53c2\u7167\u3059\u308bDNS \u306b\u767b\u9332\u3057\u3066\u304a\u304f\u3053\u3068\u3067\u3001\u4e00\u5143\u7ba1\u7406\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\n\n## CA \u306e\u79d8\u5bc6\u9375\u3068\u516c\u958b\u9375\u3001\u30b5\u30fc\u30d0\u8a3c\u660e\u66f8\u3092\u4f5c\u6210\u3059\u308b \nDocker Swarm manager \u30db\u30b9\u30c8\u4e0a\u3067openssl \u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3057\u3066CA \u306e\u79d8\u5bc6\u9375\u3068\u516c\u958b\u9375\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\u3053\u3053\u3067\u306f\u3001\u8a3c\u660e\u66f8\u306e\u4f5c\u6210\u65b9\u6cd5\u3092\u8aac\u660e\u3059\u308b\u308f\u3051\u3067\u306f\u3044\u306e\u3067\u3001\u30b3\u30de\u30f3\u30c9\u5185\u5bb9\u53ca\u3073\u6b63\u5f0f\u306a\u8a3c\u660e\u66f8\u767a\u884c\u624b\u9806\u3001\u30d5\u30a1\u30a4\u30eb\u306e\u6a29\u9650\u7b49\u306e\u8a73\u7d30\u306a\u8aac\u660e\u306f\u5272\u611b\u3057\u307e\u3059\u3002\n\n\n```text:swmgr01\nswmgr01~$ sudo mkdir /etc/ssl/docker\nswmgr01~$ cd /etc/ssl/docker\nswmgr01~$\nswmgr01~$ CA_FQDN=ca.docker.example.com\nswmgr01~$ CA_CERT=${CA_FQDN}_cert.pem\nswmgr01~$ CA_KEY_ENC=${CA_FQDN}_key_enc.pem\nswmgr01~$\nswmgr01~$ echo \"01\" | sudo tee ca.srl\nswmgr01~$ sudo openssl genrsa -des3 -out $CA_KEY_ENC 2048\nswmgr01~$ sudo openssl req -new -x509 -days 365 -key $CA_KEY_ENC -out $CA_CERT \\\n                  -subj \"/C=JP/ST=Tokyo/L=Minatoku/O=Example Company/OU=Development/CN=$CA_FQDN\"\n```\n\n\n\u4ee5\u4e0a\u3067CA \u306e\u79d8\u5bc6\u9375\u3068\u8a3c\u660e\u66f8\u306e\u4f5c\u6210\u306f\u5b8c\u4e86\u3067\u3059\u3002\n\u6b21\u306b\u30b5\u30fc\u30d0\u8a3c\u660e\u66f8\u3092\u4f5c\u6210\u3057\u3066\u3044\u304d\u307e\u3059\u3002\n1 \u70b9\u6ce8\u610f\u3059\u308b\u3053\u3068\u3068\u3057\u3066\u3001<codeswmgr01` \u306e\u8a3c\u660e\u66f8\u306f`extendedKeyUsage = clientAuth,serverAuth` \u3092\u4ed8\u4e0e\u3057\u3066\u4f5c\u6210\u3059\u308b\u7528\u306b\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\u305d\u306e\u4ed6\u306e\u30b5\u30fc\u30d0`swagt01`,  `swagt02`, `swagt03`\u306b\u3064\u3044\u3066\u306f\u901a\u5e38\u306e\u30b5\u30fc\u30d0\u8a3c\u660e\u66f8\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n\n```text:swmgr01\nswmgr01~$ echo \"extendedKeyUsage = clientAuth,serverAuth\" | sudo tee server_and_client_auth.cnf\nswmgr01~$ \nswmgr01~$ SWMGR01_FQDN=swmgr01.example.com\nswmgr01~$ SWMGR01_KEY_ENC=${SWMGR01_FQDN}_key_enc.pem\nswmgr01~$ SWMGR01_KEY=${SWMGR01_FQDN}_key.pem\nswmgr01~$ SWMGR01_CSR=${SWMGR01_FQDN}.csr\nswmgr01~$ SWMGR01_CERT=${SWMGR01_FQDN}_cert.pem\nswmgr01~$ sudo openssl genrsa -des3 -out $SWMGR01_KEY_ENC 2048\nswmgr01~$ sudo openssl rsa -in $SWMGR01_KEY_ENC -out $SWMGR01_KEY\nswmgr01~$ sudo openssl req -new -key $SWMGR01_KEY -out $SWMGR01_CSR \\\n                  -subj \"/C=JP/ST=Tokyo/L=Hoge/O=Example Company/OU=Development/CN=$SWMGR01_FQDN\"\nswmgr01~$ sudo openssl x509 -extfile server_and_client_auth.cnf -req -days 365 -in $SWMGR01_CSR -CA $CA_CERT -CAkey $CA_KEY_ENC -out $SWMGR01_CERT\nswmgr01~$\nswmgr01~$ SWAGT01_FQDN=swagt01.example.com\nswmgr01~$ SWAGT01_KEY_ENC=${SWAGT01_FQDN}_key_enc.pem\nswmgr01~$ SWAGT01_KEY=${SWAGT01_FQDN}_key.pem\nswmgr01~$ SWAGT01_CSR=${SWAGT01_FQDN}.csr\nswmgr01~$ SWAGT01_CERT=${SWAGT01_FQDN}_cert.pem\nswmgr01~$ sudo openssl genrsa -des3 -out $SWAGT01_KEY_ENC 2048\nswmgr01~$ sudo openssl rsa -in $SWAGT01_KEY_ENC -out $SWAGT01_KEY\nswmgr01~$ sudo openssl req -new -key $SWAGT01_KEY -out $SWAGT01_CSR \\\n                  -subj \"/C=JP/ST=Tokyo/L=Hoge/O=Example Company/OU=Development/CN=$SWAGT01_FQDN\"\nswmgr01~$ sudo openssl x509 -req -days 365 -in $SWAGT01_CSR -CA $CA_CERT -CAkey $CA_KEY_ENC -out $SWAGT01_CERT\nswmgr01~$\nswmgr01~$ SWAGT02_FQDN=swagt02.example.com\nswmgr01~$ SWAGT02_KEY_ENC=${SWAGT02_FQDN}_key_enc.pem\nswmgr01~$ SWAGT02_KEY=${SWAGT02_FQDN}_key.pem\nswmgr01~$ SWAGT02_CSR=${SWAGT02_FQDN}.csr\nswmgr01~$ SWAGT02_CERT=${SWAGT02_FQDN}_cert.pem\nswmgr01~$ sudo openssl genrsa -des3 -out $SWAGT02_KEY_ENC 2048\nswmgr01~$ sudo openssl rsa -in $SWAGT02_KEY_ENC -out $SWAGT02_KEY\nswmgr01~$ sudo openssl req -new -key $SWAGT02_KEY -out $SWAGT02_CSR \\\n                  -subj \"/C=JP/ST=Tokyo/L=Hoge/O=Example Company/OU=Development/CN=$SWAGT02_FQDN\"\nswmgr01~$ sudo openssl x509 -req -days 365 -in $SWAGT02_CSR -CA $CA_CERT -CAkey $CA_KEY_ENC -out $SWAGT02_CERT\nswmgr01~$\nswmgr01~$ SWAGT03_FQDN=swagt03.example.com\nswmgr01~$ SWAGT03_KEY_ENC=${SWAGT03_FQDN}_key_enc.pem\nswmgr01~$ SWAGT03_KEY=${SWAGT03_FQDN}_key.pem\nswmgr01~$ SWAGT03_CSR=${SWAGT03_FQDN}.csr\nswmgr01~$ SWAGT03_CERT=${SWAGT03_FQDN}_cert.pem\nswmgr01~$ sudo openssl genrsa -des3 -out $SWAGT03_KEY_ENC 2048\nswmgr01~$ sudo openssl rsa -in $SWAGT03_KEY_ENC -out $SWAGT03_KEY\nswmgr01~$ sudo openssl req -new -key $SWAGT03_KEY -out $SWAGT03_CSR \\\n                  -subj \"/C=JP/ST=Tokyo/L=Hoge/O=Example Company/OU=Development/CN=$SWAGT03_FQDN\"\nswmgr01~$ sudo openssl x509 -req -days 365 -in $SWAGT03_CSR -CA $CA_CERT -CAkey $CA_KEY_ENC -out $SWAGT03_CERT\nswmgr01~$\nswmgr01~$ ls\nca.docker.example.com_cert.pem\nca.docker.example.com_key_enc.pem\nca.srl\nswagt01.example.com_cert.pem\nswagt01.example.com.csr\nswagt01.example.com_key_enc.pem\nswagt01.example.com_key.pem\nswagt02.example.com_cert.pem\nswagt02.example.com.csr\nswagt02.example.com_key_enc.pem\nswagt02.example.com_key.pem\nswagt03.example.com_cert.pem\nswagt03.example.com.csr\nswagt03.example.com_key_enc.pem\nswagt03.example.com_key.pem\nswmgr01.example.com_cert.pem\nswmgr01.example.com.csr\nswmgr01.example.com_key_enc.pem\nswmgr01.example.com_key.pem\n```\n\n\n\u4ee5\u4e0a\u3067\u30b5\u30fc\u30d0\u8a3c\u660e\u66f8\u306e\u4f5c\u6210\u306f\u5b8c\u4e86\u3067\u3059\u3002\n\u3053\u308c\u3089\u306e\u30d5\u30a1\u30a4\u30eb`*.example.com_cert.pem`\u3001\u79d8\u5bc6\u9375\u30d5\u30a1\u30a4\u30eb`*.example.com_key.pem` CA \u8a3c\u660e\u66f8\u30d5\u30a1\u30a4\u30eb`ca.docker.example.com_cert.pem` \u3092\u5404\u5bfe\u8c61\u30b5\u30fc\u30d0\u306e`/etc/ssl/docker` \u30c7\u30a3\u30ec\u30af\u30c8\u30ea(Docker \u30b3\u30f3\u30c6\u30caVolume \u3067\u30de\u30a6\u30f3\u30c8\u3067\u304d\u308b\u3068\u3053\u308d)\u3078\u8ee2\u9001\u3057\u3066\u304a\u3044\u3066\u304f\u3060\u3055\u3044\u3002\n\n\u7d9a\u3044\u3066\u3001\u5f8c\u307b\u3069\u7ba1\u7406\u7528\u7aef\u672b\u304b\u3089docker \u30b3\u30de\u30f3\u30c9\u3067Swarm cluster (Docker Swarm manager)\u306b\u30b3\u30de\u30f3\u30c9\u3092\u9001\u4fe1\u3059\u308b\u305f\u3081\u306eclient \u8a3c\u660e\u66f8\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n```text:client\u8a3c\u660e\u66f8\u306e\u4f5c\u6210\nswmgr01~$ echo \"extendedKeyUsage = clientAuth\" | sudo tee client_only.cnf\nswmgr01~$\nswmgr01~$ DOCKER_CLIENT01_FQDN=client01.example.com\nswmgr01~$ DOCKER_CLIENT01_KEY_ENC=${DOCKER_CLIENT01_FQDN}_key_enc.pem\nswmgr01~$ DOCKER_CLIENT01_KEY=${DOCKER_CLIENT01_FQDN}_key.pem\nswmgr01~$ DOCKER_CLIENT01_CSR=${DOCKER_CLIENT01_FQDN}.csr\nswmgr01~$ DOCKER_CLIENT01_CERT=${DOCKER_CLIENT01_FQDN}_cert.pem\nswmgr01~$ sudo openssl genrsa -des3 -out $DOCKER_CLIENT01_KEY_ENC 2048\nswmgr01~$ sudo openssl rsa -in $DOCKER_CLIENT01_KEY_ENC -out $DOCKER_CLIENT01_KEY\nswmgr01~$ sudo openssl req -config /etc/ssl/openssl.cnf -new -key $DOCKER_CLIENT01_KEY -out $DOCKER_CLIENT01_CSR \\\n                  -subj \"/C=JP/ST=Tokyo/L=Hoge/O=Example Company/OU=Development/CN=$DOCKER_CLIENT01_FQDN\"\nswmgr01~$ sudo openssl x509 -extfile client_only.cnf -req -days 365 -in $DOCKER_CLIENT01_CSR -CA $CA_CERT -CAkey $CA_KEY_ENC -out $DOCKER_CLIENT01_CERT\n```\n\n\n\u5404\u8a3c\u660e\u66f8\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3057\u305f\u3089\u3001\u4ee5\u4e0b\u306e\u901a\u308a\u8a3c\u660e\u66f8\u30d5\u30a1\u30a4\u30eb\u53ca\u3073\u79d8\u5bc6\u9375\u30d5\u30a1\u30a4\u30eb\u3092\u5404Docker Swarm agent `swagt01-03` \u306e`/etc/ssl/docker` \u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306b\u8ee2\u9001\u3057\u3066\u304a\u3044\u3066\u304f\u3060\u3055\u3044\u3002\n\u8ee2\u9001\u304c\u5b8c\u4e86\u3057\u305f\u3089\u3001\u5404\u30d5\u30a1\u30a4\u30eb\u304cDocker daemon \u304b\u3089\u8aad\u307f\u53d6\u308a\u3067\u304d\u308b\u6a29\u9650\u306b\u8a2d\u5b9a\u3092\u3057\u3066\u304a\u3044\u3066\u304f\u3060\u3055\u3044\u3002\n\n\u8ee2\u9001\u3057\u3066\u304a\u304f\u30d5\u30a1\u30a4\u30eb\u306b\u3064\u3044\u3066\u306f\u305d\u308c\u305e\u308c\u4ee5\u4e0b\u306e\u3068\u304a\u308a\u3067\u3059\u3002\n\n```text:swagt01\nswagt01~# ls -1 /etc/ssl/docker/\nca.docker.example.com_cert.pem      # CA \u306e\u8a3c\u660e\u66f8\nswagt01.example.com_cert.pem        # swagt01 \u7528\u30b5\u30fc\u30d0\u8a3c\u660e\u66f8\nswagt01.example.com_key.pem         # swagt01 \u7528\u30b5\u30fc\u30d0\u8a3c\u660e\u66f8\u306e\u79d8\u5bc6\u9375\n```\n\n\n\n```text:swagt02\nswagt02~# ls -1 /etc/ssl/docker/\nca.docker.example.com_cert.pem\nswagt02.example.com_cert.pem\nswagt02.example.com_key.pem\n```\n\n\n\n```text:swagt03\nswagt03~# ls -1 /etc/ssl/docker/\nca.docker.example.com_cert.pem\nswagt03.example.com_cert.pem\nswagt03.example.com_key.pem\n```\n\n\n\n## TLS \u8a8d\u8a3c\u3092\u884c\u3046\u306b\u3042\u305f\u308a\u4e8b\u524d\u6e96\u5099 \n\u8a3c\u660e\u66f8\u8a8d\u8a3cON \u3067Docker Swarm agent \u3092\u8d77\u52d5\u3059\u308b\u306b\u3042\u305f\u308a\u3001\u524d\u56de\u8a18\u4e8b\u3067Docker Swarm manager 01, Docker Swarm agent 01-03 \u30b3\u30f3\u30c6\u30ca\u304c\u4f5c\u6210\u3055\u308c\u8d77\u52d5\u3057\u3066\u3044\u308b\u5834\u5408\u3001\u4e8b\u524d\u306b\u30b3\u30f3\u30c6\u30ca\u3092\u505c\u6b62\u3057\u3066\u524a\u9664\u3057\u3066\u304a\u304f\u3088\u3046\u306b\u3057\u3066\u304f\u3060\u3055\u3044(\u7406\u5c48\u7684\u306b\u306fswagt01-03 \u306e\u30b3\u30f3\u30c6\u30ca\u306f\u540c\u3058\u3082\u306e\u3092\u4f7f\u3044\u307e\u308f\u305b\u308b\u306e\u3067\u3059\u304c\u3001\u5ff5\u306e\u70ba\u2026)\u3002\n\n\n```text:swmgr01\n$ docker stop swmgr01\n$ docker rm swmgr01\n```\n\n\n\n```text:swagt01\n$ docker stop swagt01\n$ docker rm swagt01\n```\n\n\n\n```text:swagt02\n$ docker stop swagt02\n$ docker rm swagt02\n```\n\n\n\n```text:swagt03\n$ docker stop swagt03\n$ docker rm swagt03\n```\n\n\n\n## TLS \u306b\u3088\u308b\u8a8d\u8a3c\u6a5f\u80fd\u3092ON \u306b\u3057\u3066Docker Swarm agent 01-03 \u306eDocker \u30db\u30b9\u30c8\u306eDocker daemon \u3092\u8d77\u52d5\u3059\u308b \nDocker Swarm agent 01-03 \u306eTLS \u8a8d\u8a3c\u6a5f\u80fd\u3092\u4f7f\u3046\u306b\u306f\u3001Docker Swarm agent \u306eDocker \u30db\u30b9\u30c8\u306eDocker daemon \u306eTLS \u6a5f\u80fd\u3092\u6709\u52b9\u306b\u3057\u307e\u3059\u3002\n`/lib/systemd/system/docker.service` \u30d5\u30a1\u30a4\u30eb\u3092\u958b\u304d`ExecStart` \u306e\u5024\u3092\u6b21\u306e\u3088\u3046\u306b\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\n\n```text:/lib/systemd/system/docker.serviceatswagt01\nExecStart=/usr/bin/docker daemon --tlsverify --tlscacert=/etc/ssl/docker/ca.docker.example.com_cert.pem --tlscert=/etc/ssl/docker/swagt01.example.com_cert.pem --tlskey=/etc/ssl/docker/swagt01.example.com_key.pem -H tcp://0.0.0.0:2376 -H unix:///var/run/docker.sock\n```\n\n\n\n```text:/lib/systemd/system/docker.serviceatswagt02\nExecStart=/usr/bin/docker daemon --tlsverify --tlscacert=/etc/ssl/docker/ca.docker.example.com_cert.pem --tlscert=/etc/ssl/docker/swagt02.example.com_cert.pem --tlskey=/etc/ssl/docker/swagt02.example.com_key.pem -H tcp://0.0.0.0:2376 -H unix:///var/run/docker.sock\n```\n\n\n\n```text:/lib/systemd/system/docker.serviceatswagt03\nExecStart=/usr/bin/docker daemon --tlsverify --tlscacert=/etc/ssl/docker/ca.docker.example.com_cert.pem --tlscert=/etc/ssl/docker/swagt03.example.com_cert.pem --tlskey=/etc/ssl/docker/swagt03.example.com_key.pem -H tcp://0.0.0.0:2376 -H unix:///var/run/docker.sock\n```\n\n\n\u5404\u30b5\u30fc\u30d0\u306e`/lib/systemd/system/docker.service` \u30d5\u30a1\u30a4\u30eb\u3092\u66f8\u304d\u63db\u3048\u305f\u3089\u5404\u30b5\u30fc\u30d0\u4e0a\u3067`systemctl daemon-reload` \u3092\u5b9f\u884c\u3057\u3066docker \u3092\u518d\u8d77\u52d5\u3057\u307e\u3059\u3002\n\n\n```text:swagt01-03\n# systemctl daemon-reload\n# systemctl restart docker\n```\n\n\n## Docker agent \u3092cluster \u306b\u53c2\u52a0\u3055\u305b\u308b \n\u5404Docker Swarm agent \u3067`swarm join` \u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3057\u3066cluster \u306b\u53c2\u52a0\u3055\u305b\u307e\u3059\u3002\n\n\n```text:swagt01\n$ docker run --name swagt02 -d swarm join --addr=swagt02.example.com:2376 token://8f620653b5157592418a2da287dc722d\n```\n\n\n\n```text:swagt02\n$ docker run --name swagt02 -d swarm join --addr=swagt02.example.com:2376 token://8f620653b5157592418a2da287dc722d\n```\n\n\n\n```text:swagt03\n$ docker run --name swagt03 -d swarm join --addr=swagt03.example.com:2376 token://8f620653b5157592418a2da287dc722d\n```\n\n\n\n\n```text:swmgr01\n$ docker run --rm swarm list token://8f620653b5157592418a2da287dc722d\nswagt03.example.com:2376\nswagt02.example.com:2376\nswagt01.example.com:2376\n```\n\n\n\n## TLS \u306b\u3088\u308b\u8a8d\u8a3c\u6a5f\u80fd\u3092ON \u306b\u3057\u3066Docker Swarm manager 01 \u3092\u8d77\u52d5\u3059\u308b \n`swmgr01` \u30ce\u30fc\u30c9\u3067\u6b21\u306e\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3057\u3066Docker Swarm manager 01 \u3092\u8d77\u52d5\u3057\u307e\u3059\u3002\n\u8d77\u52d5\u3059\u308b\u3068\u304d\u306b`--tlsverify`, `--tlscacert`, `--tlscert`, `--tlskey` \u30aa\u30d7\u30b7\u30e7\u30f3\u3092\u52a0\u3048\u3066TLS \u901a\u4fe1\u306b\u4f7f\u7528\u3059\u308b\u8a3c\u660e\u66f8\u30d5\u30a1\u30a4\u30eb\u53ca\u3073\u79d8\u5bc6\u9375\u3092\u6307\u5b9a\u3059\u308b\u3088\u3046\u306b\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\u307e\u305f\u3001\u4ed6\u306e\u30ce\u30fc\u30c9\u306e\u540d\u524d\u89e3\u6c7a\u304c\u3067\u304d\u308b\u3088\u3046\u306b`--add-host` \u30aa\u30d7\u30b7\u30e7\u30f3\u3067\u540d\u524d\u89e3\u6c7a\u306e\u5b9a\u7fa9\u3092\u8ffd\u52a0\u3057\u3001Docker \u30db\u30b9\u30c8\u306e2376 port \u306b\u30d0\u30a4\u30f3\u30c9\u3059\u308b\u3088\u3046\u306b\u6307\u5b9a\u3057\u307e\u3059\u3002\n\n\n```text:swmgr01\nswmgr01~$ docker run --name swmgr01 -d -v /etc/ssl/docker:/etc/ssl/docker -p 2376:2375 \\\n              --add-host swagt01.example.com:192.168.1.131 --add-host swagt02.example.com:192.168.1.132 --add-host swagt03.example.com:192.168.1.133 \\\n              swarm manage --tlsverify \\\n              --tlscacert=/etc/ssl/docker/ca.docker.example.com_cert.pem \\\n              --tlscert=/etc/ssl/docker/swmgr01.example.com_cert.pem \\\n              --tlskey=/etc/ssl/docker/swmgr01.example.com_key.pem \\\n              token://8f620653b5157592418a2da287dc722d\n```\n\n\n## Docker Swarm manager 01 \u306e\u8d77\u52d5\u72b6\u614b\u3092\u78ba\u8a8d\u3059\u308b \n`docker info` \u30b3\u30de\u30f3\u30c9\u3092\u4f7f\u3063\u3066Docker Swarm manager 01 \u304c\u8d77\u52d5\u3057\u3066\u3044\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\nTLS \u8a8d\u8a3c\u3092\u4f7f\u7528\u3057\u3066\u5b9f\u884c\u3059\u308b\u3053\u3068\u306b\u306a\u308b\u306e\u3067\u3001\u30b3\u30de\u30f3\u30c9\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\n\n\n```text:swmgr01\n$ docker --tlsverify --tlscacert=/etc/ssl/docker/ca.docker.example.com_cert.pem --tlscert=/etc/ssl/docker/client01.example.com_cert.pem --tlskey=/etc/ssl/docker/client01.example.com_key.pem -H tcp://swmgr01.example.com:2376 info\nContainers: 0\nImages: 0\nRole: primary\nStrategy: spread\nFilters: health, port, dependency, affinity, constraint\nNodes: 0\nCPUs: 0\nTotal Memory: 0 B\nName: 5e38ce882c24\n```\n\n\n\u307e\u305f\u3001`ps -a` \u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3057\u3066\u3001\u5404Docker Swarm agent \u4e0a\u3067\u8d77\u52d5\u3057\u3066\u3044\u308b\u30b3\u30f3\u30c6\u30ca\u3092\u78ba\u8a8d\u3057\u3066\u307f\u307e\u3057\u3087\u3046\u3002\n\n```text\n$ docker --tlsverify -H tcp://swmgr01.example.com:2376 ps -a\nCONTAINER ID        IMAGE               COMMAND                  CREATED              STATUS              PORTS               NAMES\nda4ed91cc851        swarm               \"/swarm join --addr=s\"   About a minute ago   Up About a minute   2375/tcp            swagt03/swagt03\nc55b9bb6f605        swarm               \"/swarm join --addr=s\"   2 minutes ago        Up 2 minutes        2375/tcp            swagt02/swagt02\nb5ebf34afd62        swarm               \"/swarm join --addr=s\"   2 minutes ago        Up 2 minutes        2375/tcp            swagt01/swagt01\n```\n\n\n\u4e0a\u8a18\u306e\u3088\u3046\u306b\u7d50\u679c\u304c\u51fa\u529b\u3055\u308c\u308c\u3070\u6210\u529f\u3067\u3059\u3002\n\u4ee5\u4e0a\u3067Docker Swarm cluster \u3092TLS \u5316\u3059\u308b\u624b\u9806\u306f\u5b8c\u4e86\u3067\u3059\u3002\n\n### \u88dc\u8db3: ps -a \u30b3\u30de\u30f3\u30c9\u3067\u5168\u3066\u306eDocker Swarm agent \u304c\u8868\u793a\u3055\u308c\u306a\u3044\u5834\u5408 \n\u8a73\u3057\u3044\u539f\u56e0\u306f\u308f\u304b\u3063\u3066\u3044\u307e\u305b\u3093\u304c\u3001`docker --tlsverify -H tcp://swmgr01.example.com:2376 ps -a` \u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3057\u305f\u6642\u306b\u5168\u3066\u306eDocker Swarm agent \u30ce\u30fc\u30c9\u4e0a\u306e\u30b3\u30f3\u30c6\u30ca\u304c\u8868\u793a\u3055\u308c\u306a\u3044\u3053\u3068\u304c\u3042\u308a\u307e\u3059\u3002\n\u305d\u306e\u5834\u5408\u306f\u3001Docker Swarm manager 01 \u306eDocker Swarm manager \u30b3\u30f3\u30c6\u30ca\u3092\u4e00\u65e6\u524a\u9664\u3057\u3066\u304b\u3089\u3001\u518d\u5ea6Docker Swarm manager \u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3057\u3066\u307f\u3066\u304f\u3060\u3055\u3044\u3002\n\n### \u88dc\u8db3: TLS \u95a2\u9023\u306e\u30aa\u30d7\u30b7\u30e7\u30f3\u3092\u7701\u7565\u3059\u308b \nTLS \u3092\u4f7f\u3063\u305f\u30b3\u30de\u30f3\u30c9\u306e\u767a\u884c\u304c\u3067\u304d\u308b\u3053\u3068\u306f\u78ba\u8a8d\u3067\u304d\u307e\u3057\u305f\u304c\u3001\u3053\u308c\u3067\u306f\u30aa\u30d7\u30b7\u30e7\u30f3\u304c\u5197\u9577\u3067\u6bce\u56de\u6307\u5b9a\u3057\u3066\u3044\u3089\u308c\u306a\u3044\u306e\u3067\u3001\u8a3c\u660e\u66f8\u53ca\u3073\u9375\u3092\u660e\u793a\u7684\u306b\u6307\u5b9a\u3057\u306a\u3044\u3067\u5b9f\u884c\u3067\u304d\u308b\u3088\u3046\u306b\u3057\u307e\u3059\u3002\n`~/.docker` \u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u65b0\u898f\u306b\u4f5c\u6210\u3057\u3001\u305d\u3053\u306b`ca.pem`, `cert.pem`, `key.pem` \u3068\u3044\u3046\u30d5\u30a1\u30a4\u30eb\u540d\u3067\u305d\u308c\u305e\u308cclient \u8a3c\u660e\u66f8\u3068CA \u306e\u8a3c\u660e\u66f8\u30d5\u30a1\u30a4\u30eb\u3092\u8a2d\u7f6e\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\u4eca\u56de\u306f\u65e2\u306b`/etc/ssl/docker` \u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306bclient \u7528\u306e\u8a3c\u660e\u66f8\u53ca\u3073\u79d8\u5bc6\u9375\u304c\u7528\u610f\u3055\u308c\u3066\u3044\u308b\u306e\u3067\u305d\u308c\u306b\u5bfe\u3057\u3066\u30b7\u30f3\u30dc\u30ea\u30c3\u30af\u30ea\u30f3\u30af\u3092\u4f5c\u6210\u3057\u3066\u5bfe\u5fdc\u3057\u307e\u3059\u3002\n\n\n```text:~/.docker\n$ cd ~\n$ mkdir ~/.docker\n$ cd .docker\n$ ln -s /etc/ssl/docker/ca.docker.example.com_cert.pem ca.pem\n$ ln -s /etc/ssl/docker/client01.example.com_cert.pem cert.pem\n$ ln -s /etc/ssl/docker/client01.example.com_key.pem key.pem\n```\n\n\n\u30d5\u30a1\u30a4\u30eb\u306e\u6e96\u5099\u304c\u3067\u304d\u305f\u3089\u3082\u3046\u4e00\u5ea6\u6b21\u306e\u3088\u3046\u306b`docker info` \u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3057\u3066\u307f\u307e\u3057\u3087\u3046\u3002\n\n\n```text:dockerinfo\n$ docker --tlsverify -H tcp://swmgr01.example.com:2376 info\nContainers: 0\nImages: 0\nRole: primary\nStrategy: spread\nFilters: health, port, dependency, affinity, constraint\nNodes: 0\nCPUs: 0\nTotal Memory: 0 B\nName: 5e38ce882c24\n```\n\n\n\u5148\u307b\u3069\u3068\u540c\u69d8\u306a\u5185\u5bb9\u304c\u51fa\u529b\u3055\u308c\u308c\u3070\u6210\u529f\u3067\u3059\u3002\n\n### \u88dc\u8db3: \u66f4\u306b\u30aa\u30d7\u30b7\u30e7\u30f3\u3092\u7701\u7565\u3057\u305f\u3044 \n\u66f4\u306b`docker` \u30b3\u30de\u30f3\u30c9\u306e`-H` \u53ca\u3073`--tlsverify` \u30aa\u30d7\u30b7\u30e7\u30f3\u3092\u7701\u7565\u3057\u305f\u3044\u5834\u5408\u3001`DOCKER_HOST`, `DOCKER_TLS_VERIFY` \u74b0\u5883\u5909\u6570\u3092\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\n\n```text:swmgr01\nexport DOCKER_HOST=tcp://swmgr01.example.com:2376\nexport DOCKER_TLS_VERIFY=1\n```\n\n\n\u306a\u304a\u3001\u672c\u8aac\u660e\u3067\u306f\u3053\u306e\u74b0\u5883\u5909\u6570\u306f\u8a2d\u5b9a\u305b\u305a\u306b\u7d9a\u3051\u3066\u3044\u304d\u307e\u3059\u3002\n\n### \u88dc\u8db3: Docker client \u306e\u8a3c\u660e\u66f8\u30d5\u30a1\u30a4\u30eb\u3092\u4fdd\u7ba1\u3059\u308b\u5834\u6240\u306b\u3064\u3044\u3066 \nDocker \u30b3\u30de\u30f3\u30c9\u5b9f\u884c\u6642\u306b\u4f7f\u7528\u3059\u308b\u8a3c\u660e\u66f8\u30d5\u30a1\u30a4\u30eb\u3001\u79d8\u5bc6\u9375\u30d5\u30a1\u30a4\u30eb\u306e\u4fdd\u7ba1\u5834\u6240\u3092\u5225\u306e\u5834\u6240\u306b\u3057\u305f\u3044\u5834\u5408\u3001`DOCKER_CERT_PATH` \u74b0\u5883\u5909\u6570\u3092\u8a2d\u5b9a\u3057\u3066\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u6307\u5b9a\u3059\u308b\u3088\u3046\u306b\u3057\u307e\u3059\u3002\n\u4f8b\u3048\u3070`~/.docker/swmgr01.example.com` \u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306b\u5909\u66f4\u3057\u305f\u3044\u5834\u5408\u306f\u6b21\u306e\u3088\u3046\u306b\u3057\u307e\u3059\u3002\n\n\n```text:DOCKER_CERT_PATH\n$ export DOCKER_CERT_PATH=~/.docker/swmgr01.example.com\n```\n\n\n\u306a\u304a\u3001\u672c\u8aac\u660e\u3067\u306f\u3053\u306e\u74b0\u5883\u5909\u6570\u306f\u8a2d\u5b9a\u305b\u305a\u306b\u7d9a\u3051\u3066\u3044\u304d\u307e\u3059\u3002\n\n## Docker swarm cluster \u4e0a\u306b\u30b3\u30f3\u30c6\u30ca\u3092\u4f5c\u6210\u3057\u3066\u307f\u308b \n\u8a66\u3057\u306bDocker Swarm cluster \u4e0a\u306bbusybox \u30b3\u30f3\u30c6\u30ca\u3092\u4f5c\u6210\u3057\u3066\u307f\u307e\u3057\u3087\u3046\u3002\n\u30b3\u30de\u30f3\u30c9\u306f\u6b21\u306e\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\n\n\n```text:busybox\u30b3\u30f3\u30c6\u30ca\u3092\u4f5c\u6210\u3057\u3066\u307f\u308b\n# docker -H tcp://swmgr01.example.com:2376 --tlsverify run --name test_busybox -ti busybox /bin/sh\n/ # id \nuid#0(root) gid=0(root) groups10(wheel)\n/ # hostname\n7da820ef32bf\n/ # exit\n```\n\n\n\u4e0a\u8a18\u306e\u3088\u3046\u306bbusybox \u306e\u30d7\u30ed\u30f3\u30d7\u30c8\u304c\u8868\u793a\u3055\u308c\u308c\u3070\u30b3\u30f3\u30c6\u30ca\u306e\u8d77\u52d5\u306f\u6210\u529f\u3067\u3059\u3002\n\u6b21\u306b\u3001\u3053\u306e\u30b3\u30f3\u30c6\u30ca\u304c\u3069\u306eDocker Swarm agent \u4e0a\u306b\u4f5c\u6210\u3055\u308c\u3066\u3044\u308b\u304b\u3092\u3001`docker ps -a` \u30b3\u30de\u30f3\u30c9\u3092\u4f7f\u3063\u3066\u78ba\u8a8d\u3057\u3066\u307f\u307e\u3057\u3087\u3046\u3002\n\n\n```text:dockerps-a\n$ docker -H tcp://swmgr01.example.com:2376 --tlsverify ps -a\nCONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS                     PORTS               NAMES\n7da820ef32bf        busybox             \"/bin/sh\"                3 minutes ago       Exited (0) 2 minutes ago                       swagt03/test_busybox\na09b115c23ac        swarm               \"/swarm join --addr=s\"   13 minutes ago      Up 13 minutes              2376/tcp            swagt03/swagt03\ne7c6ad6c04e0        swarm               \"/swarm join --addr=s\"   13 minutes ago      Up 13 minutes              2376/tcp            swagt02/swagt02\n7656721e2cb8        swarm               \"/swarm join --addr=s\"   46 hours ago        Up 23 minutes              2376/tcp            swagt01/swagt01\n```\n\n\n\u30b3\u30de\u30f3\u30c9\u306e\u51fa\u529b\u7d50\u679c\u3092\u898b\u3066\u307f\u308b\u3068\u3001busybox \u30b3\u30f3\u30c6\u30ca\u304cswagt03 \u306b\u4f5c\u6210\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308a\u307e\u3059\u3002\n\u5b9f\u969b\u3001\u3069\u306eDocker Swarm agent \u30ce\u30fc\u30c9\u306b\u30b3\u30f3\u30c6\u30ca\u304c\u4f5c\u6210\u3055\u308c\u308b\u304b\u306f\u3001\u74b0\u5883\u306b\u3088\u3063\u3066\u7570\u306a\u308b\u53ef\u80fd\u6027\u304c\u6709\u308a\u307e\u3059\u3002\n\n\u7d9a\u3051\u3066\u5e7e\u3064\u304b\u306e\u30b3\u30f3\u30c6\u30ca\u3092\u4f5c\u6210\u3057\u3001\u3082\u3046\u4e00\u5ea6`docker ps -a` \u30b3\u30de\u30f3\u30c9\u3067\u30b3\u30f3\u30c6\u30ca\u304c\u3069\u3053\u306b\u4f5c\u6210\u3055\u308c\u308b\u304b\u3092\u78ba\u8a8d\u3057\u3066\u307f\u307e\u3057\u3087\u3046\u3002\n\n\n```text:dockerps-a\n$ docker -H tcp://swmgr01.example.com:2376 --tlsverify ps -a\nCONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS                        PORTS               NAMES\ne5b10b3b5443        redis               \"/entrypoint.sh redis\"   42 seconds ago      Exited (127) 40 seconds ago                       swagt03/test_hello_redis\na640ba5f165a        mysql               \"/entrypoint.sh mysql\"   5 minutes ago       Exited (1) 5 minutes ago                          swagt01/test_mysql\n85b1655aa3f9        node                \"node\"                   10 minutes ago      Exited (0) 9 minutes ago                          swagt02/test_nodejs\n2af70f9ebbbd        debian              \"/bin/bash\"              18 minutes ago      Exited (130) 14 minutes ago                       swagt01/test_debian\n7da820ef32bf        busybox             \"/bin/sh\"                28 minutes ago      Exited (0) 27 minutes ago                         swagt03/test_busybox\na09b115c23ac        swarm               \"/swarm join --addr=s\"   38 minutes ago      Up 38 minutes                 2376/tcp            swagt03/swagt03\ne7c6ad6c04e0        swarm               \"/swarm join --addr=s\"   38 minutes ago      Up 38 minutes                 2376/tcp            swagt02/swagt02\n7656721e2cb8        swarm               \"/swarm join --addr=s\"   47 hours ago        Up 48 minutes                 2376/tcp            swagt01/swagt01\n```\n\n\n\u4e0a\u8a18\u306e\u7528\u306bDocker Swarm cluster \u4e0a\u306e\u30ce\u30fc\u30c9\u306b\u5206\u6563\u3057\u3066\u4f5c\u6210\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308a\u307e\u3059\u3002\n\u4ee5\u4e0a\u3067Docker Swarm cluster \u3092TLS \u5316\u3057\u3066\u52d5\u4f5c\u3092\u78ba\u8a8d\u3059\u308b\u307e\u3067\u306e\u624b\u9806\u306f\u5b8c\u4e86\u3067\u3059\u3002\n\n\n## \u304a\u307e\u3051: \u5404\u8a3c\u660e\u66f8(public key, private key pair)\u3092ECC(\u6955\u5186\u66f2\u7dda\u6697\u53f7)\u3067\u4f5c\u6210\u3059\u308b \n2016/01 \u73fe\u5728\u3001\u8a3c\u660e\u66f8\u306e\u4f5c\u6210\u624b\u9806\u306f\u591a\u304f\u306eWeb \u306b\u8ee2\u304c\u3063\u3066\u3044\u308b\u8cc7\u6599\u306b\u3088\u308b\u3068RSA \u65b9\u5f0f\u3067\u4f5c\u6210\u3055\u308c\u3066\u3044\u307e\u3059\u304c\u3001\u3053\u3053\u3067\u6b21\u4e16\u4ee3\u306e\u6697\u53f7\u65b9\u5f0f\u3068\u3057\u3066\u6ce8\u76ee\u3055\u308c\u3066\u3044\u308bECC \u3067\u5404\u8a3c\u660e\u66f8\u3092\u4f5c\u6210\u3057\u3066Docker Swarm cluster \u5185\u3067\u5229\u7528\u3057\u3066\u307f\u307e\u3057\u3087\u3046\u3002\nECC \u5f62\u5f0f\u306b\u3059\u308b\u3053\u3068\u3067\u3001RSA \u3088\u308a\u3082\u5c11\u306a\u3044\u9375\u9577\u3067\u3088\u308a\u9ad8\u3044\u6697\u53f7\u5f37\u5ea6\u3092\u5f97\u308b\u3053\u3068\u304c\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u308b\u3068\u3044\u308f\u308c\u3066\u3044\u307e\u3059\u3002\n\n\u3053\u3053\u3067\u306fswmgr01 \u306eDocker \u30db\u30b9\u30c8\u4e0a\u3067ECC \u3067\u8a3c\u660e\u66f8\u3092\u4f5c\u6210\u3057\u305f\u6642\u306e\u624b\u9806\u3060\u3051\u3092\u6b8b\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\u305d\u306e\u4ed6\u3001\u8a3c\u660e\u66f8\u306e\u8a2d\u7f6e\u624b\u9806\u306b\u3064\u3044\u3066\u306f\u3053\u308c\u307e\u3067\u3067\u8aac\u660e\u3057\u305f\u624b\u9806\u3068\u5909\u308f\u308a\u3042\u308a\u307e\u305b\u3093\u3002\n\n\n```text:CreateCACertificatewithECC\nsudo mkdir /etc/ssl/docker\ncd /etc/ssl/docker\necho \"01\" | sudo tee ca.srl\n\nCA_FQDN=ca.docker.example.com\nCA_CERT=${CA_FQDN}_cert.pem\nCA_KEY=${CA_FQDN}_key.pem\n\nsudo openssl ecparam -out $CA_KEY -name prime256v1 -genkey\nsudo openssl req -new -x509 -days 365 -key $CA_KEY -out $CA_CERT \\\n        -subj \"/C=JP/ST=Tokyo/L=Minatoku/O=Example Company/OU=Development/CN=$CA_FQDN\"\n```\n\n\n\n```text:Createswmgr01'sCertificatewithECC\necho \"extendedKeyUsage = clientAuth,serverAuth\" | sudo tee server_and_client_auth.cnf\n\nSWMGR01_FQDN=swmgr01.example.com\nSWMGR01_KEY=${SWMGR01_FQDN}_key.pem\nSWMGR01_CSR=${SWMGR01_FQDN}.csr\nSWMGR01_CERT=${SWMGR01_FQDN}_cert.pem\nsudo openssl ecparam -out $SWMGR01_KEY -name prime256v1 -genkey\nsudo openssl req -new -key $SWMGR01_KEY -sha256 -out $SWMGR01_CSR \\\n        -subj \"/C=JP/ST=Tokyo/L=Hoge/O=Example Company/OU=Development/CN=$SWMGR01_FQDN\"\nsudo openssl x509 -extfile server_and_client_auth.cnf -req -days 365 -in $SWMGR01_CSR -CA $CA_CERT -CAkey $CA_KEY -out $SWMGR01_CERT\n```\n\n\n\n```text:Createswagt01'sCertificatewithECC\nSWAGT01_FQDN=swagt01.example.com\nSWAGT01_KEY=${SWAGT01_FQDN}_key.pem\nSWAGT01_CSR=${SWAGT01_FQDN}.csr\nSWAGT01_CERT=${SWAGT01_FQDN}_cert.pem\nsudo openssl ecparam -out $SWAGT01_KEY -name prime256v1 -genkey\nsudo openssl req -new -key $SWAGT01_KEY -sha256 -out $SWAGT01_CSR \\\n        -subj \"/C=JP/ST=Tokyo/L=Hoge/O=Example Company/OU=Development/CN=$SWAGT01_FQDN\"\nsudo openssl x509 -req -days 365 -in $SWAGT01_CSR -CA $CA_CERT -CAkey $CA_KEY -out $SWAGT01_CERT\n```\n\n\n\n```text:Createswagt02'sCertificatewithECC\nSWAGT02_FQDN=swagt02.example.com\nSWAGT02_KEY=${SWAGT02_FQDN}_key.pem\nSWAGT02_CSR=${SWAGT02_FQDN}.csr\nSWAGT02_CERT=${SWAGT02_FQDN}_cert.pem\nsudo openssl ecparam -out $SWAGT02_KEY -name prime256v1 -genkey\nsudo openssl req -new -key $SWAGT02_KEY -sha256 -out $SWAGT02_CSR \\\n        -subj \"/C=JP/ST=Tokyo/L=Hoge/O=Example Company/OU=Development/CN=$SWAGT02_FQDN\"\nsudo openssl x509 -req -days 365 -in $SWAGT02_CSR -CA $CA_CERT -CAkey $CA_KEY -out $SWAGT02_CERT\n```\n\n\n\n```text:Createswagt03'sCertificatewithECC\nSWAGT03_FQDN=swagt03.example.com\nSWAGT03_KEY=${SWAGT03_FQDN}_key.pem\nSWAGT03_CSR=${SWAGT03_FQDN}.csr\nSWAGT03_CERT=${SWAGT03_FQDN}_cert.pem\nsudo openssl ecparam -out $SWAGT03_KEY -name prime256v1 -genkey\nsudo openssl req -new -key $SWAGT03_KEY -sha256 -out $SWAGT03_CSR \\\n        -subj \"/C=JP/ST=Tokyo/L=Hoge/O=Example Company/OU=Development/CN=$SWAGT03_FQDN\"\nsudo openssl x509 -req -days 365 -in $SWAGT03_CSR -CA $CA_CERT -CAkey $CA_KEY -out $SWAGT03_CERT\n```\n\n\n\n```text:Createswagt03'sCertificatewithECC\nDOCKER_CLIENT01_FQDN=client01.example.com\nDOCKER_CLIENT01_KEY=${DOCKER_CLIENT01_FQDN}_key.pem\nDOCKER_CLIENT01_CSR=${DOCKER_CLIENT01_FQDN}.csr\nDOCKER_CLIENT01_CERT=${DOCKER_CLIENT01_FQDN}_cert.pem\nsudo openssl ecparam -out $DOCKER_CLIENT01_KEY -name prime256v1 -genkey\nsudo openssl req -config /etc/ssl/openssl.cnf -new -key $DOCKER_CLIENT01_KEY -sha256 -out $DOCKER_CLIENT01_CSR \\\n        -subj \"/C=JP/ST=Tokyo/L=Hoge/O=Example Company/OU=Development/CN=$DOCKER_CLIENT01_FQDN\"\nsudo openssl x509 -extfile client_only.cnf -req -days 365 -in $DOCKER_CLIENT01_CSR -CA $CA_CERT -CAkey $CA_KEY -out $DOCKER_CLIENT01_CERT\n```\n\n\n# \u53c2\u8003 \n<dl>\n  <dt> Docker Swarm overview</dt>\n  <dd> https://docs.docker.com/swarm/</dd>\n</dl>\n\n<dl>\n  <dt> Install and Create a Docker Swarm</dt>\n  <dd> https://docs.docker.com/swarm/install-w-machine/</dd>\n</dl>\n\n<dl>\n  <dt> Docker Tutorial : Getting Started With Docker Swarm</dt>\n  <dd> http://devopscube.com/docker-tutorial-getting-started-with-docker-swarm/</dd>\n</dl>\n\n<dl>\n  <dt> Create a swarm for development</dt>\n  <dd> https://docs.docker.com/swarm/install-manual/</dd>\n</dl>\n\n<dl>\n  <dt> DOCKER SWARM WITH TLS AUTHENTICATION</dt>\n  <dd> http://www.blackfinsecurity.com/docker-swarm-with-tls-authentication/</dd>\n</dl>\n\n<dl>\n  <dt> Protect the Docker daemon socket</dt>\n  <dd> https://docs.docker.com/engine/articles/https/</dd>\n</dl>\n\n<dl>\n  <dt> Docker Swarm\u3067\u8907\u6570Docker\u30db\u30b9\u30c8\u304b\u3089\u30af\u30e9\u30b9\u30bf\u3092\u4f5c\u308b</dt>\n  <dd> http://blog.takanabe.tokyo/2015/11/23/1565/</dd>\n</dl>\n\n<dl>\n  <dt> etcd security model</dt>\n  <dd> https://coreos.com/etcd/docs/0.4.7/etcd-security/</dd>\n</dl>\n\n<dl>\n  <dt> Intro to Docker Swarm: Part 2 - Configuration Options and Requirements</dt>\n  <dd> http://www.hnwatcher.com/r/1644394/Intro-to-Docker-Swarm-Part-2-Comfiguration-Modes-and-Requirements</dd>\n</dl>\n", "tags": ["docker", "DockerSwarm", "Linux", "Ubuntu", "Debian"]}