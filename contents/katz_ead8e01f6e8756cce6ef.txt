{"context": "\n\n\u6982\u8981\n\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306e\u30ec\u30b3\u30fc\u30c9\u306bCreatedAt\uff08\u4f5c\u6210\u65e5\uff09\u3084UpdatedAt\uff08\u66f4\u65b0\u65e5\uff09\u306a\u3069\u306e\u30d5\u30a3\u30fc\u30eb\u30c9\u3092\u6301\u305f\u305b\u308b\u3053\u3068\u304c\u3042\u308b\u304b\u3068\u601d\u3044\u307e\u3059\u3002\nNHibernate\u306b\u306f\u30ec\u30b3\u30fc\u30c9\u306e\u633f\u5165\u3084\u66f4\u65b0\u306a\u3069\u306e\u30a4\u30d9\u30f3\u30c8\u767a\u751f\u6642\u306b\u6307\u5b9a\u3057\u305f\u51e6\u7406\u3092\u3055\u305b\u308b\u6a5f\u69cb\u304c\u3042\u308b\u306e\u3067\u3001\u305d\u308c\u3092\u6d3b\u7528\u3059\u308b\u3053\u3068\u3067CreatedAt\u3084UpdatedAt\u306a\u3069\u306e\u30d5\u30a3\u30fc\u30eb\u30c9\u3092\u81ea\u52d5\u7684\u306b\u66f4\u65b0\u3055\u305b\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\n\u5b9f\u88c5\u65b9\u91dd\n\u633f\u5165\u30fb\u66f4\u65b0\u306a\u3069\u306e\u30a4\u30d9\u30f3\u30c8\u30cf\u30f3\u30c9\u30e9\u306f\u3001IPreInsertEventListener\u3084IPreUpdateEventListener\u3092\u7d99\u627f\u3057\u305f\u30af\u30e9\u30b9\u5185\u306b\u8a18\u8ff0\u3057\u307e\u3059\u3002\n\u305d\u306e\u30a4\u30d9\u30f3\u30c8\u30cf\u30f3\u30c9\u30e9\u30af\u30e9\u30b9\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092NHibernateConfiguration.EventListeners\u306e\nPreInsertEventListeners\u3084PreUpdateEventListeners\u306b\u767b\u9332\u3059\u308b\u3053\u3068\u3067\u3001\u30a4\u30d9\u30f3\u30c8\u30cf\u30f3\u30c9\u30e9\u304c\u547c\u3070\u308c\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\n\u4f5c\u6210\u65e5\u3084\u66f4\u65b0\u65e5\u3092\u4fdd\u5b58\u3059\u308b\u306e\u306b\u5229\u7528\u3059\u308b\u30d7\u30ed\u30d1\u30c6\u30a3\u306f\u72ec\u81ea\u306eCustom Attribute\u3092\u8a2d\u5b9a\u3059\u308b\u3053\u3068\u3067\u6307\u5b9a\u3057\u307e\u3059\u3002\n\n\u5b9f\u969b\u306e\u30b3\u30fc\u30c9\n\nCustom Attribute\n\u633f\u5165\u30fb\u66f4\u65b0\u6642\u306b\u81ea\u52d5\u7684\u306b\u5024\u3092\u8a2d\u5b9a\u3059\u308b\u30d5\u30a3\u30fc\u30eb\u30c9\u3092\u30de\u30fc\u30af\u30a2\u30c3\u30d7\u3059\u308b\u306e\u306b\u5229\u7528\u3059\u308bCustom Attribute\u3067\u3059\u3002\n[AttributeUsage(AttributeTargets.Field | AttributeTargets.Property, AllowMultiple = false)]\npublic class AutofillCurrentDateTimeOnInsertAttribute : Attribute\n{\n}\n\n[AttributeUsage(AttributeTargets.Field | AttributeTargets.Property, AllowMultiple = false)]\npublic class AutofillCurrentDateTimeOnUpdateAttribute : Attribute\n{\n}\n\n\n\u30a4\u30d9\u30f3\u30c8\u30cf\u30f3\u30c9\u30e9\n\u4e0a\u3067\u5b9a\u7fa9\u3057\u305fAutofillCurrentDateTimeOnInsertAttribute AutofillCurrentDateTimeOnUpdateAttribute\u304c\u8a2d\u5b9a\u3055\u308c\u3066\u3044\u308b\u30d7\u30ed\u30d1\u30c6\u30a3\u3067\u3001\u304b\u3064\u3001DateTimeOffset\u578b\u306e\u30d7\u30ed\u30d1\u30c6\u30a3\u3060\u3063\u305f\u3068\u304d\u3001\u305d\u308c\u3089\u306e\u30d7\u30ed\u30d1\u30c6\u30a3\u306e\u5024\u3092\u81ea\u52d5\u7684\u306b\u8a2d\u5b9a\u3059\u308b\u3088\u3046\u306b\u8a18\u8ff0\u3057\u3066\u3044\u307e\u3059\u3002\npublic class AutofillCurrentDateTimeEventListener : IPreUpdateEventListener, IPreInsertEventListener\n{\n    public void Register(Configuration configuration)\n    {\n        configuration.SetListener(ListenerType.PreInsert, this);\n        configuration.SetListener(ListenerType.PreUpdate, this);\n    }\n\n    public bool OnPreInsert(PreInsertEvent @event)\n    {\n        var now = DateTimeOffset.Now;\n\n        @event.Entity.GetType().GetProperties()\n            .Where(_ => Attribute.IsDefined(_, typeof(AutofillCurrentDateTimeOnInsertAttribute)) && _.PropertyType == typeof(DateTimeOffset))\n            .ToList()\n            .ForEach(prop => {\n                Set(@event.Persister, @event.State, prop.Name, now);\n                prop.SetValue(@event.Entity, now);\n            });\n\n\n        return false;\n    }\n\n    public bool OnPreUpdate(PreUpdateEvent @event)\n    {\n        var now = DateTimeOffset.Now;\n\n        @event.Entity.GetType().GetProperties()\n            .Where(_ => Attribute.IsDefined(_, typeof(AutofillCurrentDateTimeOnUpdateAttribute)) && _.PropertyType == typeof(DateTimeOffset))\n            .ToList()\n            .ForEach(prop => {\n                Set(@event.Persister, @event.State, prop.Name, now);\n                prop.SetValue(@event.Entity, now);\n            });\n\n        return false;\n    }\n\n    //ref: http://stackoverflow.com/a/24908880\n    private void Set(IEntityPersister persister, object[] state, string propertyName, object value)\n    {\n        var index = Array.IndexOf(persister.PropertyNames, propertyName);\n        if (index == -1)\n            return;\n        state[index] = value;\n    }\n}\n\n\n\u30a4\u30d9\u30f3\u30c8\u30cf\u30f3\u30c9\u30e9\u306e\u767b\u9332\nFluent NHibernate\u306e\u5834\u5408\u3001\u6b21\u306e\u3088\u3046\u306a\u5f62\u3067\u767b\u9332\u3059\u308b\u3053\u3068\u306b\u306a\u308b\u3068\u601d\u3044\u307e\u3059\u3002\n\nsessionFactory = Fluently.Configure()\n    .Database(\n        SQLiteConfiguration.Standard\n            .InMemory()\n            .ShowSql()\n        )\n    .Mappings(m =>\n    {\n        m.FluentMappings.AddFromAssembly(Assembly.GetExecutingAssembly());\n    })\n    .ExposeConfiguration(cfg => {\n        cfg.EventListeners.PreInsertEventListeners = new IPreInsertEventListener[] {\n            new AuditEventListener()\n        };\n        cfg.EventListeners.PreUpdateEventListeners = new IPreUpdateEventListener[] {\n            new AuditEventListener()\n        };\n        configuration = cfg;\n    })\n    .BuildSessionFactory();\n\n\n\u30e2\u30c7\u30eb\u5074\u3067\u81ea\u52d5\u8a2d\u5b9a\u5bfe\u8c61\u3068\u306a\u308b\u30d7\u30ed\u30d1\u30c6\u30a3\u306bAttribute\u3067\u30de\u30fc\u30af\u30a2\u30c3\u30d7\u3059\u308b\n\u30e2\u30c7\u30eb\u5074\u3067\u306f\u4e0a\u3067\u5b9a\u7fa9\u3057\u305fAttribute\u3092\u4ed8\u4e0e\u3059\u308b\u3060\u3051\u3067\u3059\u3002\n\u4f8b\u3048\u3070\u3001\u4ee5\u4e0b\u306e\u4f8b\u3067\u306f\u3001CreatedAt\u306f\u30ec\u30b3\u30fc\u30c9\u304c\u4f5c\u6210\u3055\u308c\u305f\u3068\u304d\u3001UpdatedAt\u306f\u30ec\u30b3\u30fc\u30c9\u4f5c\u6210\u3068\u66f4\u65b0\u304c\u3042\u3063\u305f\u3068\u304d\u306bNHibernate\u306b\u3088\u3063\u3066\u81ea\u52d5\u7684\u306b\u73fe\u5728\u6642\u523b\u304c\u8a2d\u5b9a\u3055\u308c\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\npublic class User\n{\n    public virtual UserId UserId { get; protected internal set; }\n\n    [AutofillCurrentDateTimeOnInsert]\n    public virtual DateTimeOffset CreatedAt { get; protected internal set; }\n\n    [AutofillCurrentDateTimeOnInsert, AutofillCurrentDateTimeOnUpdate]\n    public virtual DateTimeOffset UpdatedAt { get; protected internal set; }\n}\n\n\n\u5099\u8003\n\u4eca\u56de\u306fCustom Attribute\u3067\u30de\u30fc\u30af\u30a2\u30c3\u30d7\u3059\u308b\u3053\u3068\u3067\u5bfe\u8c61\u306e\u30d7\u30ed\u30d1\u30c6\u30a3\u3092\u7279\u5b9a\u3057\u3066\u3044\u307e\u3057\u305f\u304c\u3001\u300eITimestampable\u306a\u3069\u72ec\u81ea\u30a4\u30f3\u30bf\u30fc\u30d5\u30a7\u30a4\u30b9\u3092\u5b9f\u88c5\u3057\u3066\u3044\u308b\u30af\u30e9\u30b9\u3060\u3051\u5bfe\u8c61\u306b\u3059\u308b\u300f\u300eCreatedAt\u3068\u3044\u3046\u540d\u524d\u306e\u30d7\u30ed\u30d1\u30c6\u30a3\u3092\u5bfe\u8c61\u306b\u3059\u308b\u300f\u3068\u3044\u3046\u3088\u3046\u306a\u5b9f\u88c5\u3082\u53ef\u80fd\u3067\u3059\u3002\n\n# \u6982\u8981\n\n\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306e\u30ec\u30b3\u30fc\u30c9\u306bCreatedAt\uff08\u4f5c\u6210\u65e5\uff09\u3084UpdatedAt\uff08\u66f4\u65b0\u65e5\uff09\u306a\u3069\u306e\u30d5\u30a3\u30fc\u30eb\u30c9\u3092\u6301\u305f\u305b\u308b\u3053\u3068\u304c\u3042\u308b\u304b\u3068\u601d\u3044\u307e\u3059\u3002\n\n[NHibernate](http://nhibernate.info/)\u306b\u306f\u30ec\u30b3\u30fc\u30c9\u306e\u633f\u5165\u3084\u66f4\u65b0\u306a\u3069\u306e\u30a4\u30d9\u30f3\u30c8\u767a\u751f\u6642\u306b\u6307\u5b9a\u3057\u305f\u51e6\u7406\u3092\u3055\u305b\u308b\u6a5f\u69cb\u304c\u3042\u308b\u306e\u3067\u3001\u305d\u308c\u3092\u6d3b\u7528\u3059\u308b\u3053\u3068\u3067CreatedAt\u3084UpdatedAt\u306a\u3069\u306e\u30d5\u30a3\u30fc\u30eb\u30c9\u3092\u81ea\u52d5\u7684\u306b\u66f4\u65b0\u3055\u305b\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\n# \u5b9f\u88c5\u65b9\u91dd\n\n\u633f\u5165\u30fb\u66f4\u65b0\u306a\u3069\u306e\u30a4\u30d9\u30f3\u30c8\u30cf\u30f3\u30c9\u30e9\u306f\u3001`IPreInsertEventListener`\u3084`IPreUpdateEventListener`\u3092\u7d99\u627f\u3057\u305f\u30af\u30e9\u30b9\u5185\u306b\u8a18\u8ff0\u3057\u307e\u3059\u3002\n\u305d\u306e\u30a4\u30d9\u30f3\u30c8\u30cf\u30f3\u30c9\u30e9\u30af\u30e9\u30b9\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092NHibernate`Configuration.EventListeners`\u306e\n`PreInsertEventListeners`\u3084`PreUpdateEventListeners`\u306b\u767b\u9332\u3059\u308b\u3053\u3068\u3067\u3001\u30a4\u30d9\u30f3\u30c8\u30cf\u30f3\u30c9\u30e9\u304c\u547c\u3070\u308c\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\n\n\u4f5c\u6210\u65e5\u3084\u66f4\u65b0\u65e5\u3092\u4fdd\u5b58\u3059\u308b\u306e\u306b\u5229\u7528\u3059\u308b\u30d7\u30ed\u30d1\u30c6\u30a3\u306f\u72ec\u81ea\u306eCustom Attribute\u3092\u8a2d\u5b9a\u3059\u308b\u3053\u3068\u3067\u6307\u5b9a\u3057\u307e\u3059\u3002\n\n\n# \u5b9f\u969b\u306e\u30b3\u30fc\u30c9\n\n## Custom Attribute\n\n\u633f\u5165\u30fb\u66f4\u65b0\u6642\u306b\u81ea\u52d5\u7684\u306b\u5024\u3092\u8a2d\u5b9a\u3059\u308b\u30d5\u30a3\u30fc\u30eb\u30c9\u3092\u30de\u30fc\u30af\u30a2\u30c3\u30d7\u3059\u308b\u306e\u306b\u5229\u7528\u3059\u308bCustom Attribute\u3067\u3059\u3002\n\n```csharp\n[AttributeUsage(AttributeTargets.Field | AttributeTargets.Property, AllowMultiple = false)]\npublic class AutofillCurrentDateTimeOnInsertAttribute : Attribute\n{\n}\n\n[AttributeUsage(AttributeTargets.Field | AttributeTargets.Property, AllowMultiple = false)]\npublic class AutofillCurrentDateTimeOnUpdateAttribute : Attribute\n{\n}\n```\n\n## \u30a4\u30d9\u30f3\u30c8\u30cf\u30f3\u30c9\u30e9\n\n\u4e0a\u3067\u5b9a\u7fa9\u3057\u305f`AutofillCurrentDateTimeOnInsertAttribute` `AutofillCurrentDateTimeOnUpdateAttribute`\u304c\u8a2d\u5b9a\u3055\u308c\u3066\u3044\u308b\u30d7\u30ed\u30d1\u30c6\u30a3\u3067\u3001\u304b\u3064\u3001DateTimeOffset\u578b\u306e\u30d7\u30ed\u30d1\u30c6\u30a3\u3060\u3063\u305f\u3068\u304d\u3001\u305d\u308c\u3089\u306e\u30d7\u30ed\u30d1\u30c6\u30a3\u306e\u5024\u3092\u81ea\u52d5\u7684\u306b\u8a2d\u5b9a\u3059\u308b\u3088\u3046\u306b\u8a18\u8ff0\u3057\u3066\u3044\u307e\u3059\u3002\n\n```csharp\npublic class AutofillCurrentDateTimeEventListener : IPreUpdateEventListener, IPreInsertEventListener\n{\n\tpublic void Register(Configuration configuration)\n\t{\n\t    configuration.SetListener(ListenerType.PreInsert, this);\n\t    configuration.SetListener(ListenerType.PreUpdate, this);\n\t}\n\n\tpublic bool OnPreInsert(PreInsertEvent @event)\n\t{\n\t    var now = DateTimeOffset.Now;\n\n\t    @event.Entity.GetType().GetProperties()\n\t        .Where(_ => Attribute.IsDefined(_, typeof(AutofillCurrentDateTimeOnInsertAttribute)) && _.PropertyType == typeof(DateTimeOffset))\n\t        .ToList()\n\t        .ForEach(prop => {\n\t            Set(@event.Persister, @event.State, prop.Name, now);\n\t            prop.SetValue(@event.Entity, now);\n\t        });\n\t    \n\n\t    return false;\n\t}\n\n\tpublic bool OnPreUpdate(PreUpdateEvent @event)\n\t{\n\t    var now = DateTimeOffset.Now;\n\n\t    @event.Entity.GetType().GetProperties()\n\t        .Where(_ => Attribute.IsDefined(_, typeof(AutofillCurrentDateTimeOnUpdateAttribute)) && _.PropertyType == typeof(DateTimeOffset))\n\t        .ToList()\n\t        .ForEach(prop => {\n\t            Set(@event.Persister, @event.State, prop.Name, now);\n\t            prop.SetValue(@event.Entity, now);\n\t        });\n\n\t    return false;\n\t}\n\n\t//ref: http://stackoverflow.com/a/24908880\n\tprivate void Set(IEntityPersister persister, object[] state, string propertyName, object value)\n\t{\n\t    var index = Array.IndexOf(persister.PropertyNames, propertyName);\n\t    if (index == -1)\n\t        return;\n\t    state[index] = value;\n\t}\n}\n```\n\n## \u30a4\u30d9\u30f3\u30c8\u30cf\u30f3\u30c9\u30e9\u306e\u767b\u9332\n\nFluent NHibernate\u306e\u5834\u5408\u3001\u6b21\u306e\u3088\u3046\u306a\u5f62\u3067\u767b\u9332\u3059\u308b\u3053\u3068\u306b\u306a\u308b\u3068\u601d\u3044\u307e\u3059\u3002\n\n```csharp\n\nsessionFactory = Fluently.Configure()\n\t.Database(\n\t    SQLiteConfiguration.Standard\n\t        .InMemory()\n\t        .ShowSql()\n\t    )\n\t.Mappings(m =>\n\t{\n\t    m.FluentMappings.AddFromAssembly(Assembly.GetExecutingAssembly());\n\t})\n\t.ExposeConfiguration(cfg => {\n\t    cfg.EventListeners.PreInsertEventListeners = new IPreInsertEventListener[] {\n\t        new AuditEventListener()\n\t    };\n\t    cfg.EventListeners.PreUpdateEventListeners = new IPreUpdateEventListener[] {\n\t        new AuditEventListener()\n\t    };\n\t    configuration = cfg;\n\t})\n\t.BuildSessionFactory();\n```\n\n## \u30e2\u30c7\u30eb\u5074\u3067\u81ea\u52d5\u8a2d\u5b9a\u5bfe\u8c61\u3068\u306a\u308b\u30d7\u30ed\u30d1\u30c6\u30a3\u306bAttribute\u3067\u30de\u30fc\u30af\u30a2\u30c3\u30d7\u3059\u308b\n\n\u30e2\u30c7\u30eb\u5074\u3067\u306f\u4e0a\u3067\u5b9a\u7fa9\u3057\u305fAttribute\u3092\u4ed8\u4e0e\u3059\u308b\u3060\u3051\u3067\u3059\u3002\n\u4f8b\u3048\u3070\u3001\u4ee5\u4e0b\u306e\u4f8b\u3067\u306f\u3001`CreatedAt`\u306f\u30ec\u30b3\u30fc\u30c9\u304c\u4f5c\u6210\u3055\u308c\u305f\u3068\u304d\u3001`UpdatedAt`\u306f\u30ec\u30b3\u30fc\u30c9\u4f5c\u6210\u3068\u66f4\u65b0\u304c\u3042\u3063\u305f\u3068\u304d\u306bNHibernate\u306b\u3088\u3063\u3066\u81ea\u52d5\u7684\u306b\u73fe\u5728\u6642\u523b\u304c\u8a2d\u5b9a\u3055\u308c\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\n\n```csharp\npublic class User\n{\n\tpublic virtual UserId UserId { get; protected internal set; }\n\n\t[AutofillCurrentDateTimeOnInsert]\n\tpublic virtual DateTimeOffset CreatedAt { get; protected internal set; }\n\n\t[AutofillCurrentDateTimeOnInsert, AutofillCurrentDateTimeOnUpdate]\n\tpublic virtual DateTimeOffset UpdatedAt { get; protected internal set; }\n}\n```\n\n\n# \u5099\u8003\n\n\u4eca\u56de\u306fCustom Attribute\u3067\u30de\u30fc\u30af\u30a2\u30c3\u30d7\u3059\u308b\u3053\u3068\u3067\u5bfe\u8c61\u306e\u30d7\u30ed\u30d1\u30c6\u30a3\u3092\u7279\u5b9a\u3057\u3066\u3044\u307e\u3057\u305f\u304c\u3001\u300eITimestampable\u306a\u3069\u72ec\u81ea\u30a4\u30f3\u30bf\u30fc\u30d5\u30a7\u30a4\u30b9\u3092\u5b9f\u88c5\u3057\u3066\u3044\u308b\u30af\u30e9\u30b9\u3060\u3051\u5bfe\u8c61\u306b\u3059\u308b\u300f\u300eCreatedAt\u3068\u3044\u3046\u540d\u524d\u306e\u30d7\u30ed\u30d1\u30c6\u30a3\u3092\u5bfe\u8c61\u306b\u3059\u308b\u300f\u3068\u3044\u3046\u3088\u3046\u306a\u5b9f\u88c5\u3082\u53ef\u80fd\u3067\u3059\u3002\n", "tags": ["C#", "NHibernate", "ORM", "\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9"]}