{"context": " More than 1 year has passed since last update.\n\n\u7d50\u679c\nPostgreSQL\u306e3\u3064\u306eUPSERT\u65b9\u5f0f\u306e\u7c21\u6613\u6027\u80fd\u691c\u8a3c\u306e\u7d50\u679c\u306f\u4ee5\u4e0b\u306e\u3068\u304a\u308a\u3002\n\n\n\n\u65b9\u5f0f\n100\u4e07\u4ef6\u306eUPSERT\u6642\u9593\n\u8aac\u660e\n\n\n\n\nINSERT\u5931\u6557\u6642UPDATE\n43.6 \u79d2\nINSERT\u3092\u8a66\u307f\u3001\u30e6\u30cb\u30fc\u30af\u5236\u7d04\u9055\u53cd\u3067\u5931\u6557\u6642\u306b\u306fUPDATE\u3092\u5b9f\u884c\u3059\u308b\u95a2\u6570\u3092\u4f7f\u3063\u305fUPSERT\n\n\nUPDATE\u5931\u6557\u6642INSERT\n26.7 \u79d2\nUPDATE\u3092\u8a66\u307f\u3001\u66f4\u65b0\u4ef6\u6570\u304c0\u4ef6\u306e\u3068\u304d\u306b\u306fINSERT\u3092\u5b9f\u884c\u3059\u308b\u95a2\u6570\u3092\u4f7f\u3063\u305fUPSERT\n\n\nINSERT ON CONFLICT\n8.1 \u79d2\n9.5 \u304b\u3089\u30b5\u30dd\u30fc\u30c8\u3055\u308c\u308bINSERT ON CONFLICT\u69cb\u6587\u306b\u3088\u308bUPSERT\n\n\n\n\n\u691c\u8a3c\u65b9\u6cd5\n\n\u7aef\u672b\u4e0a\u3067\u4ee5\u4e0b\u3092\u5b9f\u884c\n\n# UPSERT\u5bfe\u8c61\u30c6\u30fc\u30d6\u30eb\u306e\u30d9\u30fc\u30b9\u306b\u306a\u308b100\u4e07\u4ef6\u306epgbench_accounts\u30c6\u30fc\u30d6\u30eb\u3092\u4f5c\u6210\n$ pgbench -i -s 10 --unlogged-table\n\n\npsql\u3067\u4ee5\u4e0b\u3092\u5b9f\u884c\n\n-- psql\u306e\u6642\u9593\u8a08\u6e2c\u6a5f\u80fd\u3092\u6709\u52b9\u5316\n\\timing on\n\n-- 100\u4e07\u4ef6\u306epgbench_acounts\u30c6\u30fc\u30d6\u30eb\u304b\u308950%\u306e\u30c7\u30fc\u30bf\u3092\u30e9\u30f3\u30c0\u30e0\u306b\u524a\u9664\nDELETE FROM pgbench_accounts WHERE aid IN\n  (SELECT aid FROM pgbench_accounts TABLESAMPLE BERNOULLI(50));\nVACUUM ANALYZE pgbench_accounts;\n\n-- INSERT\u5931\u6557\u6642\u306bUPDATE\u3092\u5b9f\u884c\u3059\u308bUPSERT\u95a2\u6570\u3092\u5b9a\u7fa9\nCREATE OR REPLACE FUNCTION upd_if_ins_fails\n  (myaid INT, mybid INT, myabalance INT, myfiller CHAR(84))\n  RETURNS void AS $$\nBEGIN\n  INSERT INTO hoge\n    VALUES (myaid, mybid, myabalance, myfiller);\nEXCEPTION WHEN unique_violation THEN\n  UPDATE hoge\n    SET bid = mybid, abalance = myabalance, filler = myfiller\n    WHERE aid = myaid;\nEND;\n$$ LANGUAGE plpgsql;\n\n-- 0\u4ef6UPDATE\u6642\u306bINSERT\u3092\u5b9f\u884c\u3059\u308bUPSERT\u95a2\u6570\u3092\u5b9a\u7fa9\nCREATE OR REPLACE FUNCTION ins_if_no_upd\n  (myaid INT, mybid INT, myabalance INT, myfiller CHAR(84))\n  RETURNS void AS $$\nBEGIN\n  UPDATE hoge\n    SET bid = mybid, abalance = myabalance, filler = myfiller\n    WHERE aid = myaid;\n  IF FOUND THEN\n    RETURN;\n  END IF;\n  INSERT INTO hoge\n    VALUES (myaid, mybid, myabalance, myfiller);\nEND;\n$$ LANGUAGE plpgsql;\n\n-- UPSERT\u5bfe\u8c61\u306e\u30c6\u30fc\u30d6\u30ebhoge\u3092pgbench_accounts\u304b\u3089\u30b3\u30d4\u30fc\u4f5c\u6210\nDROP TABLE hoge;\nCREATE UNLOGGED TABLE hoge AS SELECT * FROM pgbench_accounts;\nALTER TABLE hoge ADD PRIMARY KEY (aid);\n\n-- UPSERT\u691c\u8a3c\u3092autovacuum\u3084CHECKPOINT\u304c\u90aa\u9b54\u3057\u306a\u3044\u3088\u3046\u306b\u3059\u308b\nVACUUM ANALYZE hoge;\nCHECKPOINT;\n\n-- 100\u4e07\u4ef6UPSERT\u306e\u6642\u9593\u8a08\u6e2c\u305d\u306e1\nSELECT upd_if_ins_fails (num, 9, 99, 'UPSERT') FROM generate_series(1, 1000000) num;\n\n-- 100\u4e07\u4ef6UPSERT\u3055\u308c\u305f\u3053\u3068\u3092\u78ba\u8a8d\nSELECT count(*) FROM hoge WHERE bid = 9;\n\n-- UPSERT\u5bfe\u8c61\u306e\u30c6\u30fc\u30d6\u30ebhoge\u3092pgbench_accounts\u304b\u3089\u30b3\u30d4\u30fc\u4f5c\u6210\nDROP TABLE hoge;\nCREATE UNLOGGED TABLE hoge AS SELECT * FROM pgbench_accounts;\nALTER TABLE hoge ADD PRIMARY KEY (aid);\n\n-- UPSERT\u691c\u8a3c\u3092autovacuum\u3084CHECKPOINT\u304c\u90aa\u9b54\u3057\u306a\u3044\u3088\u3046\u306b\u3059\u308b\nVACUUM ANALYZE hoge;\nCHECKPOINT;\n\n-- 100\u4e07\u4ef6UPSERT\u306e\u6642\u9593\u8a08\u6e2c\u305d\u306e2\nSELECT ins_if_no_upd (num, 9, 99, 'UPSERT') FROM generate_series(1, 1000000) num;\n\n-- 100\u4e07\u4ef6UPSERT\u3055\u308c\u305f\u3053\u3068\u3092\u78ba\u8a8d\nSELECT count(*) FROM hoge WHERE bid = 9;\n\n-- UPSERT\u5bfe\u8c61\u306e\u30c6\u30fc\u30d6\u30ebhoge\u3092pgbench_accounts\u304b\u3089\u30b3\u30d4\u30fc\u4f5c\u6210\nDROP TABLE hoge;\nCREATE UNLOGGED TABLE hoge AS SELECT * FROM pgbench_accounts;\nALTER TABLE hoge ADD PRIMARY KEY (aid);\n\n-- UPSERT\u691c\u8a3c\u3092autovacuum\u3084CHECKPOINT\u304c\u90aa\u9b54\u3057\u306a\u3044\u3088\u3046\u306b\u3059\u308b\nVACUUM ANALYZE hoge;\nCHECKPOINT;\n\n-- 100\u4e07\u4ef6UPSERT\u306e\u6642\u9593\u8a08\u6e2c\u305d\u306e3\nINSERT INTO hoge SELECT num, 9, 99, 'UPSERT'\n  FROM generate_series(1, 1000000) num\n  ON CONFLICT (aid) DO UPDATE\n  SET bid = EXCLUDED.bid,\n          abalance = EXCLUDED.abalance,\n          filler = EXCLUDED.filler;\n\n-- 100\u4e07\u4ef6UPSERT\u3055\u308c\u305f\u3053\u3068\u3092\u78ba\u8a8d\nSELECT count(*) FROM hoge WHERE bid = 9;\n\n# \u7d50\u679c\nPostgreSQL\u306e3\u3064\u306eUPSERT\u65b9\u5f0f\u306e\u7c21\u6613\u6027\u80fd\u691c\u8a3c\u306e\u7d50\u679c\u306f\u4ee5\u4e0b\u306e\u3068\u304a\u308a\u3002\n\n| \u65b9\u5f0f | 100\u4e07\u4ef6\u306eUPSERT\u6642\u9593 | \u8aac\u660e |\n|-----|-------------------:|-----|\n| INSERT\u5931\u6557\u6642UPDATE | 43.6 \u79d2 | INSERT\u3092\u8a66\u307f\u3001\u30e6\u30cb\u30fc\u30af\u5236\u7d04\u9055\u53cd\u3067\u5931\u6557\u6642\u306b\u306fUPDATE\u3092\u5b9f\u884c\u3059\u308b\u95a2\u6570\u3092\u4f7f\u3063\u305fUPSERT |\n| UPDATE\u5931\u6557\u6642INSERT | 26.7 \u79d2 | UPDATE\u3092\u8a66\u307f\u3001\u66f4\u65b0\u4ef6\u6570\u304c0\u4ef6\u306e\u3068\u304d\u306b\u306fINSERT\u3092\u5b9f\u884c\u3059\u308b\u95a2\u6570\u3092\u4f7f\u3063\u305fUPSERT |\n| INSERT ON CONFLICT | 8.1 \u79d2 | 9.5 \u304b\u3089\u30b5\u30dd\u30fc\u30c8\u3055\u308c\u308bINSERT ON CONFLICT\u69cb\u6587\u306b\u3088\u308bUPSERT |\n\n# \u691c\u8a3c\u65b9\u6cd5\n* \u7aef\u672b\u4e0a\u3067\u4ee5\u4e0b\u3092\u5b9f\u884c\n\n```bash\n# UPSERT\u5bfe\u8c61\u30c6\u30fc\u30d6\u30eb\u306e\u30d9\u30fc\u30b9\u306b\u306a\u308b100\u4e07\u4ef6\u306epgbench_accounts\u30c6\u30fc\u30d6\u30eb\u3092\u4f5c\u6210\n$ pgbench -i -s 10 --unlogged-table\n```\n\n* psql\u3067\u4ee5\u4e0b\u3092\u5b9f\u884c\n\n```plpgsql\n-- psql\u306e\u6642\u9593\u8a08\u6e2c\u6a5f\u80fd\u3092\u6709\u52b9\u5316\n\\timing on\n\n-- 100\u4e07\u4ef6\u306epgbench_acounts\u30c6\u30fc\u30d6\u30eb\u304b\u308950%\u306e\u30c7\u30fc\u30bf\u3092\u30e9\u30f3\u30c0\u30e0\u306b\u524a\u9664\nDELETE FROM pgbench_accounts WHERE aid IN\n  (SELECT aid FROM pgbench_accounts TABLESAMPLE BERNOULLI(50));\nVACUUM ANALYZE pgbench_accounts;\n\n-- INSERT\u5931\u6557\u6642\u306bUPDATE\u3092\u5b9f\u884c\u3059\u308bUPSERT\u95a2\u6570\u3092\u5b9a\u7fa9\nCREATE OR REPLACE FUNCTION upd_if_ins_fails\n  (myaid INT, mybid INT, myabalance INT, myfiller CHAR(84))\n  RETURNS void AS $$\nBEGIN\n  INSERT INTO hoge\n    VALUES (myaid, mybid, myabalance, myfiller);\nEXCEPTION WHEN unique_violation THEN\n  UPDATE hoge\n    SET bid = mybid, abalance = myabalance, filler = myfiller\n    WHERE aid = myaid;\nEND;\n$$ LANGUAGE plpgsql;\n\n-- 0\u4ef6UPDATE\u6642\u306bINSERT\u3092\u5b9f\u884c\u3059\u308bUPSERT\u95a2\u6570\u3092\u5b9a\u7fa9\nCREATE OR REPLACE FUNCTION ins_if_no_upd\n  (myaid INT, mybid INT, myabalance INT, myfiller CHAR(84))\n  RETURNS void AS $$\nBEGIN\n  UPDATE hoge\n    SET bid = mybid, abalance = myabalance, filler = myfiller\n    WHERE aid = myaid;\n  IF FOUND THEN\n    RETURN;\n  END IF;\n  INSERT INTO hoge\n    VALUES (myaid, mybid, myabalance, myfiller);\nEND;\n$$ LANGUAGE plpgsql;\n\n-- UPSERT\u5bfe\u8c61\u306e\u30c6\u30fc\u30d6\u30ebhoge\u3092pgbench_accounts\u304b\u3089\u30b3\u30d4\u30fc\u4f5c\u6210\nDROP TABLE hoge;\nCREATE UNLOGGED TABLE hoge AS SELECT * FROM pgbench_accounts;\nALTER TABLE hoge ADD PRIMARY KEY (aid);\n\n-- UPSERT\u691c\u8a3c\u3092autovacuum\u3084CHECKPOINT\u304c\u90aa\u9b54\u3057\u306a\u3044\u3088\u3046\u306b\u3059\u308b\nVACUUM ANALYZE hoge;\nCHECKPOINT;\n\n-- 100\u4e07\u4ef6UPSERT\u306e\u6642\u9593\u8a08\u6e2c\u305d\u306e1\nSELECT upd_if_ins_fails (num, 9, 99, 'UPSERT') FROM generate_series(1, 1000000) num;\n\n-- 100\u4e07\u4ef6UPSERT\u3055\u308c\u305f\u3053\u3068\u3092\u78ba\u8a8d\nSELECT count(*) FROM hoge WHERE bid = 9;\n\n-- UPSERT\u5bfe\u8c61\u306e\u30c6\u30fc\u30d6\u30ebhoge\u3092pgbench_accounts\u304b\u3089\u30b3\u30d4\u30fc\u4f5c\u6210\nDROP TABLE hoge;\nCREATE UNLOGGED TABLE hoge AS SELECT * FROM pgbench_accounts;\nALTER TABLE hoge ADD PRIMARY KEY (aid);\n\n-- UPSERT\u691c\u8a3c\u3092autovacuum\u3084CHECKPOINT\u304c\u90aa\u9b54\u3057\u306a\u3044\u3088\u3046\u306b\u3059\u308b\nVACUUM ANALYZE hoge;\nCHECKPOINT;\n\n-- 100\u4e07\u4ef6UPSERT\u306e\u6642\u9593\u8a08\u6e2c\u305d\u306e2\nSELECT ins_if_no_upd (num, 9, 99, 'UPSERT') FROM generate_series(1, 1000000) num;\n\n-- 100\u4e07\u4ef6UPSERT\u3055\u308c\u305f\u3053\u3068\u3092\u78ba\u8a8d\nSELECT count(*) FROM hoge WHERE bid = 9;\n\n-- UPSERT\u5bfe\u8c61\u306e\u30c6\u30fc\u30d6\u30ebhoge\u3092pgbench_accounts\u304b\u3089\u30b3\u30d4\u30fc\u4f5c\u6210\nDROP TABLE hoge;\nCREATE UNLOGGED TABLE hoge AS SELECT * FROM pgbench_accounts;\nALTER TABLE hoge ADD PRIMARY KEY (aid);\n\n-- UPSERT\u691c\u8a3c\u3092autovacuum\u3084CHECKPOINT\u304c\u90aa\u9b54\u3057\u306a\u3044\u3088\u3046\u306b\u3059\u308b\nVACUUM ANALYZE hoge;\nCHECKPOINT;\n\n-- 100\u4e07\u4ef6UPSERT\u306e\u6642\u9593\u8a08\u6e2c\u305d\u306e3\nINSERT INTO hoge SELECT num, 9, 99, 'UPSERT'\n  FROM generate_series(1, 1000000) num\n  ON CONFLICT (aid) DO UPDATE\n  SET bid = EXCLUDED.bid,\n          abalance = EXCLUDED.abalance,\n          filler = EXCLUDED.filler;\n\n-- 100\u4e07\u4ef6UPSERT\u3055\u308c\u305f\u3053\u3068\u3092\u78ba\u8a8d\nSELECT count(*) FROM hoge WHERE bid = 9;\n```\n", "tags": ["PostgreSQL", "UPSERT", "performance", "PLpgSQL"]}