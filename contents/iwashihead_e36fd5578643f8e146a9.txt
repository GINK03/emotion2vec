{"context": "\u30e9\u30f3\u30bf\u30a4\u30e0\u6642\u306b\u3001\u30a2\u30d0\u30bf\u30fc\u306a\u3069\u306e\u8907\u6570\u306eTexture\u3092\n\uff11\u679a\u306b\u307e\u3068\u3081\u3066SetPass\u3092\u6e1b\u3089\u3059.\nAtlas\u5316\u3059\u308bTexture\u3068Mesh\u306f\u305d\u308c\u305e\u308c\nRead/Write Enable\u3000\u30d5\u30e9\u30b0\u3092On\u306b\u3057\u3066\u304a\u304f\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\n\nusing UnityEngine;\nusing System.Collections;\nusing System.Collections.Generic;\nusing System.Diagnostics;\n\npublic class RuntimeCharacterAtlasTest : MonoBehaviour\n{\n    public Texture2D BodyTex;\n    public Texture2D HairTex;\n    public Texture2D EyeTex;\n\n    public Texture2D AtlasTex;\n    public Material AtlasMaterial;\n\n    public SkinnedMeshRenderer[] BodyMeshs;\n    public SkinnedMeshRenderer[] HairMeshs;\n    public SkinnedMeshRenderer[] EyeMeshs;\n\n    public Rect[] Rects;\n\n    public IEnumerator Start()\n    {\n        // AtlasTexture\u306e\u751f\u6210.\n        AtlasTex = new Texture2D(2048, 2048);\n\n        // Unity\u8d77\u52d5\u76f4\u5f8c\u306f\u6b63\u78ba\u306b\u8a08\u6e2c\u3067\u304d\u306a\u3044\u306e\u3067\u3057\u3070\u3089\u304f\u5f85\u3064.\n        yield return new WaitForSeconds(3f);\n\n        // ~~~~~\u8a08\u6e2c\u958b\u59cb~~~~~\n        Stopwatch sw = new Stopwatch();\n        sw.Start();\n\n        // Texture\u306eAtlas\u5316\u3092\u884c\u3046.\n        // Rects \u306b\u5404Texture\u306e\u9818\u57df\u60c5\u5831\u304c\u8fd4\u3063\u3066\u304f\u308b\u3001\u9806\u756a\u306f\u5f15\u6570\u306eTexture\u914d\u5217\u3068\u540c\u3058.\n        Rects = AtlasTex.PackTextures(new [] {BodyTex, HairTex, EyeTex}, 2);\n\n        // Atlas\u7528\u306eMaterial\u306bAtlasTexture\u3092\u5272\u308a\u5f53\u3066\u308b\n        AtlasMaterial.mainTexture = AtlasTex;\n\n        // PackTexture\u306b\u6e21\u3057\u305f\u9806\u756a\u3067UV\u3092\u66f4\u65b0\n        ApplyUVAndMaterial(BodyMeshs, Rects[0], AtlasMaterial);\n        ApplyUVAndMaterial(HairMeshs, Rects[1], AtlasMaterial);\n        ApplyUVAndMaterial(EyeMeshs, Rects[2], AtlasMaterial);\n\n        // ~~~~~\u8a08\u6e2c\u7d42\u4e86~~~~~\n        sw.Stop();\n        //UnityEngine.Debug.Log(\"total atlas create time = \" + sw.ElapsedTicks + \" ticks\");\n    }\n\n    // UV\u3092\u66f4\u65b0\u3057\u3066\u3001AtlasMaterial\u3092\u5272\u308a\u5f53\u3066\u308b\n    public void ApplyUVAndMaterial(SkinnedMeshRenderer[] meshs, Rect rect, Material atlasMaterial)\n    {\n        foreach (var mesh in meshs)\n        {\n            var uvs = new List<Vector2>();\n            // \u5143\u306eMesh\u60c5\u5831\u3092\u4e0a\u66f8\u304d\u3057\u306a\u3044\u3088\u3046\u306b\u3001Instanctiate\u3057\u3066\u30e1\u30c3\u30b7\u30e5\u3092\u30b3\u30d4\u30fc\n            mesh.sharedMesh = Instantiate(mesh.sharedMesh);\n            // \u5143\u3005\u306eUV\u60c5\u5831\u3092\u53d6\u5f97\n            mesh.sharedMesh.GetUVs(0, uvs);\n            // Atlas\u30de\u30c6\u30ea\u30a2\u30eb\u3092\u5272\u308a\u5f53\u3066\n            mesh.material = atlasMaterial;\n\n            for (int i = 0; i < uvs.Count; ++i)\n            {\n                // Atlas\u5316\u3057\u3066\u305a\u308c\u305fUV\u3092\u66f4\u65b0\u3059\u308b.\n                uvs[i] = new Vector2(uvs[i].x * rect.width + rect.x, uvs[i].y * rect.height + rect.y);\n                // \u65b0\u3057\u3044UV\u3092\u5272\u308a\u5f53\u3066\n                mesh.sharedMesh.SetUVs(0, uvs);\n            }\n        }\n    }\n}\n\n\u30e9\u30f3\u30bf\u30a4\u30e0\u6642\u306b\u3001\u30a2\u30d0\u30bf\u30fc\u306a\u3069\u306e\u8907\u6570\u306eTexture\u3092\n\uff11\u679a\u306b\u307e\u3068\u3081\u3066SetPass\u3092\u6e1b\u3089\u3059.\nAtlas\u5316\u3059\u308bTexture\u3068Mesh\u306f\u305d\u308c\u305e\u308c\nRead/Write Enable\u3000\u30d5\u30e9\u30b0\u3092On\u306b\u3057\u3066\u304a\u304f\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\n\n![screenshot_2016_9_16.png](https://qiita-image-store.s3.amazonaws.com/0/67497/2176086a-86a0-a56b-29df-41a196dfbce1.png)\n\n```csharp\nusing UnityEngine;\nusing System.Collections;\nusing System.Collections.Generic;\nusing System.Diagnostics;\n\npublic class RuntimeCharacterAtlasTest : MonoBehaviour\n{\n    public Texture2D BodyTex;\n    public Texture2D HairTex;\n    public Texture2D EyeTex;\n\n    public Texture2D AtlasTex;\n    public Material AtlasMaterial;\n\n    public SkinnedMeshRenderer[] BodyMeshs;\n    public SkinnedMeshRenderer[] HairMeshs;\n    public SkinnedMeshRenderer[] EyeMeshs;\n\n    public Rect[] Rects;\n\n    public IEnumerator Start()\n    {\n        // AtlasTexture\u306e\u751f\u6210.\n        AtlasTex = new Texture2D(2048, 2048);\n\n        // Unity\u8d77\u52d5\u76f4\u5f8c\u306f\u6b63\u78ba\u306b\u8a08\u6e2c\u3067\u304d\u306a\u3044\u306e\u3067\u3057\u3070\u3089\u304f\u5f85\u3064.\n        yield return new WaitForSeconds(3f);\n\n        // ~~~~~\u8a08\u6e2c\u958b\u59cb~~~~~\n        Stopwatch sw = new Stopwatch();\n        sw.Start();\n\n        // Texture\u306eAtlas\u5316\u3092\u884c\u3046.\n        // Rects \u306b\u5404Texture\u306e\u9818\u57df\u60c5\u5831\u304c\u8fd4\u3063\u3066\u304f\u308b\u3001\u9806\u756a\u306f\u5f15\u6570\u306eTexture\u914d\u5217\u3068\u540c\u3058.\n        Rects = AtlasTex.PackTextures(new [] {BodyTex, HairTex, EyeTex}, 2);\n\n        // Atlas\u7528\u306eMaterial\u306bAtlasTexture\u3092\u5272\u308a\u5f53\u3066\u308b\n        AtlasMaterial.mainTexture = AtlasTex;\n\n        // PackTexture\u306b\u6e21\u3057\u305f\u9806\u756a\u3067UV\u3092\u66f4\u65b0\n        ApplyUVAndMaterial(BodyMeshs, Rects[0], AtlasMaterial);\n        ApplyUVAndMaterial(HairMeshs, Rects[1], AtlasMaterial);\n        ApplyUVAndMaterial(EyeMeshs, Rects[2], AtlasMaterial);\n\n        // ~~~~~\u8a08\u6e2c\u7d42\u4e86~~~~~\n        sw.Stop();\n        //UnityEngine.Debug.Log(\"total atlas create time = \" + sw.ElapsedTicks + \" ticks\");\n    }\n\n    // UV\u3092\u66f4\u65b0\u3057\u3066\u3001AtlasMaterial\u3092\u5272\u308a\u5f53\u3066\u308b\n    public void ApplyUVAndMaterial(SkinnedMeshRenderer[] meshs, Rect rect, Material atlasMaterial)\n    {\n        foreach (var mesh in meshs)\n        {\n            var uvs = new List<Vector2>();\n            // \u5143\u306eMesh\u60c5\u5831\u3092\u4e0a\u66f8\u304d\u3057\u306a\u3044\u3088\u3046\u306b\u3001Instanctiate\u3057\u3066\u30e1\u30c3\u30b7\u30e5\u3092\u30b3\u30d4\u30fc\n            mesh.sharedMesh = Instantiate(mesh.sharedMesh);\n            // \u5143\u3005\u306eUV\u60c5\u5831\u3092\u53d6\u5f97\n            mesh.sharedMesh.GetUVs(0, uvs);\n            // Atlas\u30de\u30c6\u30ea\u30a2\u30eb\u3092\u5272\u308a\u5f53\u3066\n            mesh.material = atlasMaterial;\n\n            for (int i = 0; i < uvs.Count; ++i)\n            {\n                // Atlas\u5316\u3057\u3066\u305a\u308c\u305fUV\u3092\u66f4\u65b0\u3059\u308b.\n                uvs[i] = new Vector2(uvs[i].x * rect.width + rect.x, uvs[i].y * rect.height + rect.y);\n                // \u65b0\u3057\u3044UV\u3092\u5272\u308a\u5f53\u3066\n                mesh.sharedMesh.SetUVs(0, uvs);\n            }\n        }\n    }\n}\n```\n", "tags": ["Unity3D", "Unity", "C#"]}