{"context": "\n\nTL;DR\n\u3053\u3053\u8aad\u3093\u3067\u9069\u5207\u306agem\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u306a\u308a\u3001locale\u30d5\u30a1\u30a4\u30eb\u3092\u8a2d\u7f6e\u305b\u3088\u3002\nhttps://github.com/svenfuchs/rails-i18n\n\n\u518d\u73fe\u65b9\u6cd5\n\u53c2\u8003 : \u30b7\u30b9\u30c6\u30e0\u306egem\u306brails\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u305b\u305arails new\u3059\u308b\n\u307e\u305a\u306f\u3001\u30a2\u30d7\u30ea\u3092\u4f5c\u308b\u3002\n$ mkdir i18ntest\n$ cd i18ntest\n$ echo 'source \"https://rubygems.org\"' > Gemfile\n$ echo 'gem \"rails\", \"~> 4.2\"' >> Gemfile\n$ bundle install --path vendor/bundle\n$ bundle exec rails new .\n\n\u7d9a\u3044\u3066\u30e2\u30c7\u30eb\u3092\u4f5c\u308b\u3002parent\u3068\u3044\u3046\u30e2\u30c7\u30eb\u304c\u305f\u304f\u3055\u3093\u306echild\u3092\u6301\u3063\u3066\u3044\u308b\u3068\u3044\u3046\u95a2\u4fc2\u3002\n$ bin/rails g model parent \n$ bin/rails g model child parent:references\n$ bin/rake db:migrate\n\n\u30d7\u30ed\u30bb\u30b9\u7ba1\u7406\u3067\u306f\u3088\u304f\u3042\u308b\u300c\u89aa\u304c\u5b50\u3092\u6b8b\u3057\u3066\u6b7b\u306c\u3053\u3068\u306f\u8a31\u3055\u308c\u306a\u3044\u300d\n\nruby\u3067\u30d7\u30ed\u30bb\u30b9\u7ba1\u7406\u306e\u8a71\u306b\u306a\u308a\u300c\u3042\u30fc\u3001\u3053\u308c\u6bba\u305b\u3066\u306a\u3044\u306d\u300d\u300c\u89aa\u5b50\u4f9b\u306f\u7686\u6bba\u3057\u3057\u306a\u304d\u3083\uff01\u300d\u3068\u3044\u3046\u7269\u9a12\u306a\u8a71\u306b\u82b1\u3092\u54b2\u304b\u305b\u3066\u305f\u3002\u305f\u306e\u3057\u3044\u3002\u2014 \u3048\u306b\u3050\u307e (@enigma63) 2016\u5e745\u670817\u65e5\n\n\u3068\u3044\u3046\u95a2\u4fc2\u306b\u3059\u308b\u3002\n\napp/models/parent.rb\nclass Child < ActiveRecord::Base\n  has_many :child, dependent: :restrict_with_error\nend\n\n\n\u30c7\u30d5\u30a9\u30eb\u30c8\u30ed\u30b1\u30fc\u30eb\u3092\u65e5\u672c\u8a9e\u306b\u3059\u308b\u3002\n\nconfig/application.rb\n    #...snip...\n    config.i18n.default_locale = :ja\n    #...snip...\n\n\n\u518d\u73fe\u306b\u5fc5\u8981\u306a\u6700\u5c0f\u9650\u306elocale\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3002\n\nconfig/locales/ja.yml\nja:\n  hello: \u3053\u3093\u306b\u3061\u306f\n\n\n\u518d\u73fe\u8a66\u9a13\u3002\n$ bin/rails c\nirb(main):001:0> p = Parent.create\nirb(main):002:0> c = Child.create(parent: p)\nirb(main):003:0> p.destroy\n=> false\nirb(main):004:0> p.errors.messages\n=> {:base=>[\"translation missing: ja.activerecord.errors.models.parent.attributes.base.restrict_dependent_destroy.many\"]}\nirb(main):005:0>\n\n\u3053\u308c\u3002\u3053\u306e\u30e1\u30c3\u30bb\u30fc\u30b8\u3067\u30c9\u30c4\u30dc\u3002\ntranslation missing: ja.activerecord.errors.models.parent.attributes.base.restrict_dependent_destroy.many\n\n\u3053\u306e\u30e1\u30c3\u30bb\u30fc\u30b8\u306e\u901a\u308a\u306a\u3089\u3001\u3053\u3093\u306a\u611f\u3058\u306e\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3057\u306a\u3051\u308c\u3070\u306a\u3089\u306a\u3044\u3002\n\nconfig/locales/ja.yml\nja:\n  activerecord:\n    errors:\n      models:\n        parent:\n          attributes:\n            base:\n              restrict_dependent_destroy:\n                many: \"%{record}\u304c\u5b58\u5728\u3057\u3066\u3044\u308b\u306e\u3067\u524a\u9664\u3067\u304d\u307e\u305b\u3093\"\n\n\n\u4e00\u5fdc\u3053\u308c\u3067\u3082\u52d5\u304f\u3051\u3069\u3001\u4ed6\u306bdependent: :restrict_with_error\u306aother\u30e2\u30c7\u30eb\u304c\u8ffd\u52a0\u3055\u308c\u308b\u3068\u3053\u3046\u306a\u308b\u3002\n\nconfig/locales/ja.yml\nja:\n  activerecord:\n    errors:\n      models:\n        parent:\n          attributes:\n            base:\n              restrict_dependent_destroy:\n                many: \"%{record}\u304c\u5b58\u5728\u3057\u3066\u3044\u308b\u306e\u3067\u524a\u9664\u3067\u304d\u307e\u305b\u3093\"\n        other:\n          attributes:\n            base:\n              restrict_dependent_destroy:\n                many: \"%{record}\u304c\u5b58\u5728\u3057\u3066\u3044\u308b\u306e\u3067\u524a\u9664\u3067\u304d\u307e\u305b\u3093\"\n\n\n\u3059\u3054\u304fDRY\u3058\u3083\u7121\u304f\u3066\u3001\u534a\u7aef\u306a\u3044\u30c4\u30e9\u307f\u3002\n\n\u5bfe\u7b56\n\u6b63\u3057\u304f\u306f\u3053\u3046\u3002\n\nconfig/locales/ja.yml\nja:\n  errors:\n    messages:\n      restrict_dependent_destroy:\n        many: \"%{record}\u304c\u5b58\u5728\u3057\u3066\u3044\u308b\u306e\u3067\u524a\u9664\u3067\u304d\u307e\u305b\u3093\"\n\n\n\u3068\u3044\u3046\u304b\u3001\u3053\u3046\u3044\u3046locale\u30d5\u30a1\u30a4\u30eb\u304c\u914d\u5e03\u3055\u308c\u3066\u3044\u308b\u306e\u3067\u3001\u305d\u308c\u4f7f\u3048\u3063\u3066\u8a71\u3002\n\n\u3069\u3046\u3057\u3066\u3042\u3093\u306a\u3064\u3089\u3044\u30e1\u30c3\u30bb\u30fc\u30b8\u304c\u683c\u7d0d\u3055\u308c\u305f\u304b\u3002\n\u6c17\u306b\u306a\u3063\u305f\u306e\u3067\u30bd\u30fc\u30b9\u3092\u8ffd\u3044\u304b\u3051\u3066\u307f\u308b\u3002\n\u3053\u306e\u30e1\u30c3\u30bb\u30fc\u30b8\u306f\u3053\u3053\u304c\u767a\u7aef\u3067\u3042\u308b\u3002\n\nactiverecord/lib/active_record/associations/has_many_association.rb#L16\n        when :restrict_with_error\n          unless empty?\n            record = klass.human_attribute_name(reflection.name).downcase\n            owner.errors.add(:base, :\"restrict_dependent_destroy.many\", record: record)\n            false\n          end\n\n\nerrors#add \u306f\u3053\u3061\u3089\u3002\n\nactivemodel/lib/active_model/errors.rb#L299\n    def add(attribute, message = :invalid, options = {})\n      message = normalize_message(attribute, message, options)\n      if exception = options[:strict]\n        exception = ActiveModel::StrictValidationFailed if exception == true\n        raise exception, full_message(attribute, message)\n      end\n\n      self[attribute] << message\n    end\n\n\nnormalize_message \u3092\u7d4c\u7531\u3057\u3066\u3001\n\nactiverecord/lib/active_record/associations/has_many_association.rb#L16\n    def normalize_message(attribute, message, options)\n      case message\n      when Symbol\n        generate_message(attribute, message, options.except(*CALLBACKS_OPTIONS))\n      when Proc\n        message.call\n      else\n        message\n      end\n    end\n\n\ngenerate_message\u306b\u305f\u3069\u308a\u7740\u304f\u3002\n\nactivemodel/lib/active_model/errors.rb#L412\n    def generate_message(attribute, type = :invalid, options = {})\n      type = options.delete(:message) if options[:message].is_a?(Symbol)\n\n      if @base.class.respond_to?(:i18n_scope)\n        defaults = @base.class.lookup_ancestors.map do |klass|\n          [ :\"#{@base.class.i18n_scope}.errors.models.#{klass.model_name.i18n_key}.attributes.#{attribute}.#{type}\",\n            :\"#{@base.class.i18n_scope}.errors.models.#{klass.model_name.i18n_key}.#{type}\" ]\n        end\n      else\n        defaults = []\n      end\n\n      defaults << options.delete(:message)\n      defaults << :\"#{@base.class.i18n_scope}.errors.messages.#{type}\" if @base.class.respond_to?(:i18n_scope)\n      defaults << :\"errors.attributes.#{attribute}.#{type}\"\n      defaults << :\"errors.messages.#{type}\"\n\n      defaults.compact!\n      defaults.flatten!\n\n      key = defaults.shift\n      value = (attribute != :base ? @base.send(:read_attribute_for_validation, attribute) : nil)\n\n      options = {\n        default: defaults,\n        model: @base.model_name.human,\n        attribute: @base.class.human_attribute_name(attribute),\n        value: value\n      }.merge!(options)\n\n      I18n.translate(key, options)\n    end\n\n\ndefaults\u306b\u30e1\u30c3\u30bb\u30fc\u30b8\u306e\u30d1\u30b9\u306e\u5019\u88dc\u3092\u8272\u3005\u3068\u7a4d\u307f\u4e0a\u3052\u3066\u3001I18n.translate\u306b\u6e21\u3057\u3066\u3044\u308b\u3002defaults\u306e\u5024\u306f\u3069\u3046\u306a\u3063\u3066\u3044\u308b\u304b\u3068\u3044\u3046\u3068\u3001\u4e0a\u8a18\u306e\u4f8b\u3067\u306f\u3001@base\u306b\u306fParent\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u304c\u5165\u3063\u3066\u3044\u3066\u3001attribute\u306b\u306f:base\u3001type\u306f\"restrict_dependent_destroy.many\"\u304c\u5165\u3063\u3066\u3044\u308b\u306e\u3067\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u308b\u3002\n\ndefaults\u306e\u5024\n[\n  :\"activerecord.errors.models.parent.attributes.base.restrict_dependent_destroy.many\",\n  :\"activerecord.errors.models.parent.attributes.restrict_dependent_destroy.many\",\n  :\"activerecord.errors.messages.restrict_dependent_destroy.many\",\n  :\"errors.attributes.base.restrict_dependent_destroy.many\",\n  :\"errors.messages.restrict_dependent_destroy.many\"\n]\n\n\n\u305d\u3057\u3066\u6211\u3005\u3092\u60d1\u308f\u3059\u30e1\u30c3\u30bb\u30fc\u30b8\u306f\u3053\u3053\u3067\u4f5c\u3089\u308c\u3066\u3044\u308b\u3002\n\nactivemodel/lib/active_model/errors.rb#L432\n      key = defaults.shift\n\n\nArray#shift\u306f\u914d\u5217\u306e\u5148\u982d\u3092\u8fd4\u5374\u3057\u3066\u3001\u914d\u5217\u304b\u3089\u524a\u9664\u3059\u308b\u30e1\u30bd\u30c3\u30c9\u3067\u3042\u308b\u3002\u305d\u306e\u305f\u3081\u3001\u3053\u306e\u64cd\u4f5c\u306e\u5f8c\u3001key\u3068defaults\u306f\u3053\u306e\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u308b\u3002\n\nkey\u306e\u5024\n:\"activerecord.errors.models.parent.attributes.base.restrict_dependent_destroy.many\"\n\n\n\ndefaults\u306e\u5024\n[\n  :\"activerecord.errors.models.parent.attributes.restrict_dependent_destroy.many\",\n  :\"activerecord.errors.messages.restrict_dependent_destroy.many\",\n  :\"errors.attributes.base.restrict_dependent_destroy.many\",\n  :\"errors.messages.restrict_dependent_destroy.many\"\n]\n\n\nI18n.translate\u306f\u3053\u3061\u3089(\u3060\u3068\u601d\u3046)\n\ni18n.rb#L144\n    def translate(*args)\n      options  = args.last.is_a?(Hash) ? args.pop.dup : {}\n      key      = args.shift\n      backend  = config.backend\n      locale   = options.delete(:locale) || config.locale\n      handling = options.delete(:throw) && :throw || options.delete(:raise) && :raise # TODO deprecate :raise\n\n      enforce_available_locales!(locale)\n      raise I18n::ArgumentError if key.is_a?(String) && key.empty?\n\n      result = catch(:exception) do\n        if key.is_a?(Array)\n          key.map { |k| backend.translate(locale, k, options) }\n        else\n          backend.translate(locale, key, options)\n        end\n      end\n      result.is_a?(MissingTranslation) ? handle_exception(handling, result, locale, key, options) : result\n    end\n    alias :t :translate\n\n\nkey\u306fsymbol\u306a\u306e\u3067\u3001 backend.translate(:ja, :\"activerecord.errors.models.parent.attributes.base.restrict_dependent_destroy.many\", options) \u304c\u547c\u3073\u51fa\u3055\u308c\u307e\u3059\u3002\nbackend.translate\u306f\u3053\u3061\u3089(\u3060\u3088\u306d?)\n\nlib/i18n/backend/base.rb#L24\n      def translate(locale, key, options = {})\n        raise InvalidLocale.new(locale) unless locale\n        entry = key && lookup(locale, key, options[:scope], options)\n\n        if entry.nil? && options.key?(:default)\n          entry = default(locale, key, options[:default], options)\n        else\n          entry = resolve(locale, key, entry, options)\n        end\n\n        if entry.nil?\n          if (options.key?(:default) && !options[:default].nil?) || !options.key?(:default)\n            throw(:exception, I18n::MissingTranslation.new(locale, key, options))\n          end\n        end\n#...snip\n\n\n\u3068\u3044\u3046\u308f\u3051\u3067\u3001\u3053\u3053\u3067I18n::MissingTranslation\u304cthrow\u3055\u308c\u3066\u3001\u3064\u3089\u3044\u30e1\u30c3\u30bb\u30fc\u30b8\u304c\u8868\u793a\u3055\u308c\u305f\u306e\u3067\u3059\u306d(\u3053\u308c\u4ee5\u4e0a\u8ffd\u3044\u304b\u3051\u308b\u306e\u3092\u8ae6\u3081\u305f\u306e\u3067\u8a66\u5408\u7d42\u4e86\u3067\u3059)\u3002\n\u3081\u3067\u305f\u3057\u3081\u3067\u305f\u3057\u3002\n# TL;DR\n\n\u3053\u3053\u8aad\u3093\u3067\u9069\u5207\u306agem\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u306a\u308a\u3001locale\u30d5\u30a1\u30a4\u30eb\u3092\u8a2d\u7f6e\u305b\u3088\u3002\nhttps://github.com/svenfuchs/rails-i18n\n\n# \u518d\u73fe\u65b9\u6cd5\n\u53c2\u8003 : [\u30b7\u30b9\u30c6\u30e0\u306egem\u306brails\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u305b\u305arails new\u3059\u308b](http://qiita.com/youcune/items/222777415f00d19cccb4)\n\n\u307e\u305a\u306f\u3001\u30a2\u30d7\u30ea\u3092\u4f5c\u308b\u3002\n\n```bash\n$ mkdir i18ntest\n$ cd i18ntest\n$ echo 'source \"https://rubygems.org\"' > Gemfile\n$ echo 'gem \"rails\", \"~> 4.2\"' >> Gemfile\n$ bundle install --path vendor/bundle\n$ bundle exec rails new .\n```\n\n\u7d9a\u3044\u3066\u30e2\u30c7\u30eb\u3092\u4f5c\u308b\u3002parent\u3068\u3044\u3046\u30e2\u30c7\u30eb\u304c\u305f\u304f\u3055\u3093\u306echild\u3092\u6301\u3063\u3066\u3044\u308b\u3068\u3044\u3046\u95a2\u4fc2\u3002\n\n```bash\n$ bin/rails g model parent \n$ bin/rails g model child parent:references\n$ bin/rake db:migrate\n```\n\n\u30d7\u30ed\u30bb\u30b9\u7ba1\u7406\u3067\u306f\u3088\u304f\u3042\u308b\u300c\u89aa\u304c\u5b50\u3092\u6b8b\u3057\u3066\u6b7b\u306c\u3053\u3068\u306f\u8a31\u3055\u308c\u306a\u3044\u300d\n\n<blockquote class=\"twitter-tweet\" data-lang=\"ja\"><p lang=\"ja\" dir=\"ltr\">ruby\u3067\u30d7\u30ed\u30bb\u30b9\u7ba1\u7406\u306e\u8a71\u306b\u306a\u308a\u300c\u3042\u30fc\u3001\u3053\u308c\u6bba\u305b\u3066\u306a\u3044\u306d\u300d\u300c\u89aa\u5b50\u4f9b\u306f\u7686\u6bba\u3057\u3057\u306a\u304d\u3083\uff01\u300d\u3068\u3044\u3046\u7269\u9a12\u306a\u8a71\u306b\u82b1\u3092\u54b2\u304b\u305b\u3066\u305f\u3002\u305f\u306e\u3057\u3044\u3002</p>&mdash; \u3048\u306b\u3050\u307e (@enigma63) <a href=\"https://twitter.com/enigma63/status/732526218247954432\">2016\u5e745\u670817\u65e5</a></blockquote>\n\n\u3068\u3044\u3046\u95a2\u4fc2\u306b\u3059\u308b\u3002\n\n```app/models/parent.rb\nclass Child < ActiveRecord::Base\n  has_many :child, dependent: :restrict_with_error\nend\n```\n\n\u30c7\u30d5\u30a9\u30eb\u30c8\u30ed\u30b1\u30fc\u30eb\u3092\u65e5\u672c\u8a9e\u306b\u3059\u308b\u3002\n\n```config/application.rb\n    #...snip...\n    config.i18n.default_locale = :ja\n    #...snip...\n```\n\n\u518d\u73fe\u306b\u5fc5\u8981\u306a\u6700\u5c0f\u9650\u306elocale\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3002\n\n```config/locales/ja.yml\nja:\n  hello: \u3053\u3093\u306b\u3061\u306f\n```\n\n\u518d\u73fe\u8a66\u9a13\u3002\n\n```irb\n$ bin/rails c\nirb(main):001:0> p = Parent.create\nirb(main):002:0> c = Child.create(parent: p)\nirb(main):003:0> p.destroy\n=> false\nirb(main):004:0> p.errors.messages\n=> {:base=>[\"translation missing: ja.activerecord.errors.models.parent.attributes.base.restrict_dependent_destroy.many\"]}\nirb(main):005:0>\n```\n\n\u3053\u308c\u3002\u3053\u306e\u30e1\u30c3\u30bb\u30fc\u30b8\u3067\u30c9\u30c4\u30dc\u3002\n\n```\ntranslation missing: ja.activerecord.errors.models.parent.attributes.base.restrict_dependent_destroy.many\n```\n\n\u3053\u306e\u30e1\u30c3\u30bb\u30fc\u30b8\u306e\u901a\u308a\u306a\u3089\u3001\u3053\u3093\u306a\u611f\u3058\u306e\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3057\u306a\u3051\u308c\u3070\u306a\u3089\u306a\u3044\u3002\n\n```config/locales/ja.yml\nja:\n  activerecord:\n    errors:\n      models:\n        parent:\n          attributes:\n            base:\n              restrict_dependent_destroy:\n                many: \"%{record}\u304c\u5b58\u5728\u3057\u3066\u3044\u308b\u306e\u3067\u524a\u9664\u3067\u304d\u307e\u305b\u3093\"\n```\n\n\u4e00\u5fdc\u3053\u308c\u3067\u3082\u52d5\u304f\u3051\u3069\u3001\u4ed6\u306b`dependent: :restrict_with_error`\u306aother\u30e2\u30c7\u30eb\u304c\u8ffd\u52a0\u3055\u308c\u308b\u3068\u3053\u3046\u306a\u308b\u3002\n\n```config/locales/ja.yml\nja:\n  activerecord:\n    errors:\n      models:\n        parent:\n          attributes:\n            base:\n              restrict_dependent_destroy:\n                many: \"%{record}\u304c\u5b58\u5728\u3057\u3066\u3044\u308b\u306e\u3067\u524a\u9664\u3067\u304d\u307e\u305b\u3093\"\n        other:\n          attributes:\n            base:\n              restrict_dependent_destroy:\n                many: \"%{record}\u304c\u5b58\u5728\u3057\u3066\u3044\u308b\u306e\u3067\u524a\u9664\u3067\u304d\u307e\u305b\u3093\"\n```\n\n\u3059\u3054\u304fDRY\u3058\u3083\u7121\u304f\u3066\u3001\u534a\u7aef\u306a\u3044\u30c4\u30e9\u307f\u3002\n\n\n# \u5bfe\u7b56\n\n\u6b63\u3057\u304f\u306f\u3053\u3046\u3002\n\n```config/locales/ja.yml\nja:\n  errors:\n    messages:\n      restrict_dependent_destroy:\n        many: \"%{record}\u304c\u5b58\u5728\u3057\u3066\u3044\u308b\u306e\u3067\u524a\u9664\u3067\u304d\u307e\u305b\u3093\"\n```\n\n\u3068\u3044\u3046\u304b\u3001\u3053\u3046\u3044\u3046locale\u30d5\u30a1\u30a4\u30eb\u304c[\u914d\u5e03](https://github.com/svenfuchs/rails-i18n)\u3055\u308c\u3066\u3044\u308b\u306e\u3067\u3001\u305d\u308c\u4f7f\u3048\u3063\u3066\u8a71\u3002\n\n# \u3069\u3046\u3057\u3066\u3042\u3093\u306a\u3064\u3089\u3044\u30e1\u30c3\u30bb\u30fc\u30b8\u304c\u683c\u7d0d\u3055\u308c\u305f\u304b\u3002\n\u6c17\u306b\u306a\u3063\u305f\u306e\u3067\u30bd\u30fc\u30b9\u3092\u8ffd\u3044\u304b\u3051\u3066\u307f\u308b\u3002\n\n\u3053\u306e\u30e1\u30c3\u30bb\u30fc\u30b8\u306f[\u3053\u3053](https://github.com/rails/rails/blob/4-2-stable/activerecord/lib/active_record/associations/has_many_association.rb#L16)\u304c\u767a\u7aef\u3067\u3042\u308b\u3002\n\n```ruby:activerecord/lib/active_record/associations/has_many_association.rb#L16\n        when :restrict_with_error\n          unless empty?\n            record = klass.human_attribute_name(reflection.name).downcase\n            owner.errors.add(:base, :\"restrict_dependent_destroy.many\", record: record)\n            false\n          end\n```\n\nerrors#add \u306f[\u3053\u3061\u3089](https://github.com/rails/rails/blob/4-2-stable/activemodel/lib/active_model/errors.rb#L299)\u3002\n\n```ruby:activemodel/lib/active_model/errors.rb#L299\n    def add(attribute, message = :invalid, options = {})\n      message = normalize_message(attribute, message, options)\n      if exception = options[:strict]\n        exception = ActiveModel::StrictValidationFailed if exception == true\n        raise exception, full_message(attribute, message)\n      end\n\n      self[attribute] << message\n    end\n```\n\n[normalize_message](https://github.com/rails/rails/blob/4-2-stable/activerecord/lib/active_record/associations/has_many_association.rb#L16) \u3092\u7d4c\u7531\u3057\u3066\u3001\n\n```ruby:activerecord/lib/active_record/associations/has_many_association.rb#L16\n    def normalize_message(attribute, message, options)\n      case message\n      when Symbol\n        generate_message(attribute, message, options.except(*CALLBACKS_OPTIONS))\n      when Proc\n        message.call\n      else\n        message\n      end\n    end\n```\n\n[generate_message](https://github.com/rails/rails/blob/4-2-stable/activemodel/lib/active_model/errors.rb#L412)\u306b\u305f\u3069\u308a\u7740\u304f\u3002\n\n```ruby:activemodel/lib/active_model/errors.rb#L412\n    def generate_message(attribute, type = :invalid, options = {})\n      type = options.delete(:message) if options[:message].is_a?(Symbol)\n\n      if @base.class.respond_to?(:i18n_scope)\n        defaults = @base.class.lookup_ancestors.map do |klass|\n          [ :\"#{@base.class.i18n_scope}.errors.models.#{klass.model_name.i18n_key}.attributes.#{attribute}.#{type}\",\n            :\"#{@base.class.i18n_scope}.errors.models.#{klass.model_name.i18n_key}.#{type}\" ]\n        end\n      else\n        defaults = []\n      end\n\n      defaults << options.delete(:message)\n      defaults << :\"#{@base.class.i18n_scope}.errors.messages.#{type}\" if @base.class.respond_to?(:i18n_scope)\n      defaults << :\"errors.attributes.#{attribute}.#{type}\"\n      defaults << :\"errors.messages.#{type}\"\n\n      defaults.compact!\n      defaults.flatten!\n\n      key = defaults.shift\n      value = (attribute != :base ? @base.send(:read_attribute_for_validation, attribute) : nil)\n\n      options = {\n        default: defaults,\n        model: @base.model_name.human,\n        attribute: @base.class.human_attribute_name(attribute),\n        value: value\n      }.merge!(options)\n\n      I18n.translate(key, options)\n    end\n```\n\n`defaults`\u306b\u30e1\u30c3\u30bb\u30fc\u30b8\u306e\u30d1\u30b9\u306e\u5019\u88dc\u3092\u8272\u3005\u3068\u7a4d\u307f\u4e0a\u3052\u3066\u3001`I18n.translate`\u306b\u6e21\u3057\u3066\u3044\u308b\u3002`defaults`\u306e\u5024\u306f\u3069\u3046\u306a\u3063\u3066\u3044\u308b\u304b\u3068\u3044\u3046\u3068\u3001\u4e0a\u8a18\u306e\u4f8b\u3067\u306f\u3001@base\u306b\u306fParent\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u304c\u5165\u3063\u3066\u3044\u3066\u3001attribute\u306b\u306f`:base`\u3001type\u306f`\"restrict_dependent_destroy.many\"`\u304c\u5165\u3063\u3066\u3044\u308b\u306e\u3067\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u308b\u3002\n\n```ruby:defaults\u306e\u5024\n[\n  :\"activerecord.errors.models.parent.attributes.base.restrict_dependent_destroy.many\",\n  :\"activerecord.errors.models.parent.attributes.restrict_dependent_destroy.many\",\n  :\"activerecord.errors.messages.restrict_dependent_destroy.many\",\n  :\"errors.attributes.base.restrict_dependent_destroy.many\",\n  :\"errors.messages.restrict_dependent_destroy.many\"\n]\n```\n\n\u305d\u3057\u3066\u6211\u3005\u3092\u60d1\u308f\u3059\u30e1\u30c3\u30bb\u30fc\u30b8\u306f[\u3053\u3053](https://github.com/rails/rails/blob/4-2-stable/activemodel/lib/active_model/errors.rb#L432)\u3067\u4f5c\u3089\u308c\u3066\u3044\u308b\u3002\n\n```activemodel/lib/active_model/errors.rb#L432\n      key = defaults.shift\n```\n\nArray#shift\u306f\u914d\u5217\u306e\u5148\u982d\u3092\u8fd4\u5374\u3057\u3066\u3001\u914d\u5217\u304b\u3089\u524a\u9664\u3059\u308b\u30e1\u30bd\u30c3\u30c9\u3067\u3042\u308b\u3002\u305d\u306e\u305f\u3081\u3001\u3053\u306e\u64cd\u4f5c\u306e\u5f8c\u3001key\u3068defaults\u306f\u3053\u306e\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u308b\u3002\n\n```ruby:key\u306e\u5024\n:\"activerecord.errors.models.parent.attributes.base.restrict_dependent_destroy.many\"\n```\n\n```ruby:defaults\u306e\u5024\n[\n  :\"activerecord.errors.models.parent.attributes.restrict_dependent_destroy.many\",\n  :\"activerecord.errors.messages.restrict_dependent_destroy.many\",\n  :\"errors.attributes.base.restrict_dependent_destroy.many\",\n  :\"errors.messages.restrict_dependent_destroy.many\"\n]\n```\n\nI18n.translate\u306f[\u3053\u3061\u3089](https://github.com/svenfuchs/i18n/blob/master/lib/i18n.rb#L144)(\u3060\u3068\u601d\u3046)\n\n```ruby:i18n.rb#L144\n    def translate(*args)\n      options  = args.last.is_a?(Hash) ? args.pop.dup : {}\n      key      = args.shift\n      backend  = config.backend\n      locale   = options.delete(:locale) || config.locale\n      handling = options.delete(:throw) && :throw || options.delete(:raise) && :raise # TODO deprecate :raise\n\n      enforce_available_locales!(locale)\n      raise I18n::ArgumentError if key.is_a?(String) && key.empty?\n\n      result = catch(:exception) do\n        if key.is_a?(Array)\n          key.map { |k| backend.translate(locale, k, options) }\n        else\n          backend.translate(locale, key, options)\n        end\n      end\n      result.is_a?(MissingTranslation) ? handle_exception(handling, result, locale, key, options) : result\n    end\n    alias :t :translate\n```\n\nkey\u306fsymbol\u306a\u306e\u3067\u3001 `backend.translate(:ja, :\"activerecord.errors.models.parent.attributes.base.restrict_dependent_destroy.many\", options)` \u304c\u547c\u3073\u51fa\u3055\u308c\u307e\u3059\u3002\n\n\nbackend.translate\u306f[\u3053\u3061\u3089](https://github.com/svenfuchs/i18n/blob/master/lib/i18n/backend/base.rb#L24)(\u3060\u3088\u306d?)\n\n```ruby:lib/i18n/backend/base.rb#L24\n      def translate(locale, key, options = {})\n        raise InvalidLocale.new(locale) unless locale\n        entry = key && lookup(locale, key, options[:scope], options)\n\n        if entry.nil? && options.key?(:default)\n          entry = default(locale, key, options[:default], options)\n        else\n          entry = resolve(locale, key, entry, options)\n        end\n\n        if entry.nil?\n          if (options.key?(:default) && !options[:default].nil?) || !options.key?(:default)\n            throw(:exception, I18n::MissingTranslation.new(locale, key, options))\n          end\n        end\n#...snip\n```\n\n\u3068\u3044\u3046\u308f\u3051\u3067\u3001\u3053\u3053\u3067`I18n::MissingTranslation`\u304cthrow\u3055\u308c\u3066\u3001\u3064\u3089\u3044\u30e1\u30c3\u30bb\u30fc\u30b8\u304c\u8868\u793a\u3055\u308c\u305f\u306e\u3067\u3059\u306d(\u3053\u308c\u4ee5\u4e0a\u8ffd\u3044\u304b\u3051\u308b\u306e\u3092\u8ae6\u3081\u305f\u306e\u3067\u8a66\u5408\u7d42\u4e86\u3067\u3059)\u3002\n\n\u3081\u3067\u305f\u3057\u3081\u3067\u305f\u3057\u3002\n", "tags": ["Rails", "Rails4", "I18n"]}