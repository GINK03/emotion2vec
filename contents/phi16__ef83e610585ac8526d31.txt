{"context": "\u3053\u3093\u306b\u3061\u306fphi16\u3067\u3059\u3002\u3053\u306e\u8a18\u4e8b\u306fHaskell Advent Calendar 2016 \u306e8\u65e5\u76ee\u306e\u8a18\u4e8b\u3067\u3059\u3002\nHaskell(GHC)\u3067\u8272\u3005\u30d7\u30ed\u30b0\u30e9\u30e0\u3092\u66f8\u3044\u3066\u3044\u308b\u3068\u3001\u305f\u307e\u306b\u30d0\u30b0\u3063\u3066\u6b21\u306e\u3088\u3046\u306a\u30a8\u30e9\u30fc\u3092\u898b\u308b\u3053\u3068\u304c\u3042\u308b\u3068\u304a\u3082\u3044\u307e\u3059\u3002\nmain: <<loop>>\n\n\u3053\u308c\u306fGHC\u304c\u5f0f\u3092\u8a55\u4fa1\u3057\u3066\u3044\u305f\u3089\u7121\u9650\u30eb\u30fc\u30d7\u3092\u767a\u751f\u3055\u305b\u3066\u3057\u307e\u3046\u3053\u3068\u3092\u691c\u51fa\u3057\u3066\u6295\u3052\u308b\u4f8b\u5916\u306a\u306e\u3067\u3059\u304c\u3001\u52ff\u8ad6\u5168\u3066\u306e\u7121\u9650\u30eb\u30fc\u30d7\u3092\u691c\u51fa\u3059\u308b\u3053\u3068\u306f\u3067\u304d\u307e\u305b\u3093\u3002\n\u307e\u305fHaskell\u3067\u306f\u6b21\u306e\u3088\u3046\u306a\u300c\u7121\u9650\u30eb\u30fc\u30d7\u300d\u306f\"\u5408\u6cd5\"\u3067\u3059 :\na = 1 : a\n\n\u3068\u3044\u3046\u308f\u3051\u3067\u3001\u3069\u3093\u306a\u7121\u9650\u30eb\u30fc\u30d7\u306a\u3089\u300c\u5408\u6cd5\u306a\u306e\u304b\u300d\u300c\u691c\u51fa\u3067\u304d\u308b\u306e\u304b\u300d\u3001\u307e\u305f\u300c\u3069\u3046\u3044\u3046\u6a5f\u69cb\u3067\u3053\u308c\u3092\u5b9f\u73fe\u3057\u3066\u3044\u308b\u306e\u304b\u300d\u3068\u3044\u3046\u8a71\u3092\u3001GHC\u306e\u5b9f\u969b\u306e\u8a55\u4fa1\u6a5f\u69cb\u3092JavaScript\u30671\u4f5c\u308a\u306a\u304c\u3089\u9069\u5f53\u306b\u307e\u3068\u3081\u3066\u307f\u3088\u3046\u3068\u304a\u3082\u3044\u307e\u3059\u3002\u534a\u5206\u304f\u3089\u3044\u306f\u81ea\u5206\u7528\u30e1\u30e2\u304b\u3082\u3057\u308c\u306a\u3044\u3067\u3059\u3002\n\u60c5\u5831\u6e90\u3068\u3057\u3066\u306fSTG\u8ad6\u6587\u304c\u4e3b\u3067\u3001\u305d\u308c\u3092\u66f4\u306b\u5358\u7d14\u5316\u3057\u305f\u30e2\u30c7\u30eb\u3092\u8003\u3048\u3066\u3044\u308b\u305f\u3081\u73fe\u884c\u306eGHC\u3068\u306f\u304b\u306a\u308a\u7570\u306a\u308b\u51e6\u7406\u3092\u3057\u3066\u3044\u307e\u3059\u3002\u3054\u4e86\u627f\u304f\u3060\u3055\u3044\u3002\n\u3053\u308c\u3092\u8aad\u3080\u3053\u3068\u3067Haskell\u30b3\u30fc\u30c9\u304b\u3089CPU\u306e\u6b53\u58f0\u304c\u805e\u3053\u3048\u308b\u3088\u3046\u306b\u306a\u308b\u3068\u3044\u3044\u306a\u3068\u304a\u3082\u3044\u307e\u3059\u3002\n\n\u5024\u306e\u8868\u73fe\nHaskell\u306f\u9045\u5ef6\u8a55\u4fa1\u3092\u884c\u3046\u305f\u3081\u3001\u300c\u5024\u300d\u305d\u306e\u3082\u306e\u306e\u8868\u73fe\u304c\u81ea\u660e\u306a\u5f62\u3067\u306f\u5b9a\u307e\u308a\u307e\u305b\u3093\u3002\u9045\u5ef6\u8a55\u4fa1\u3068\u3044\u3046\u306e\u306f\u300c\u5b9f\u884c(\u8a55\u4fa1)\u3059\u308b\u3053\u3068\u3067\u5024\u304c\u521d\u3081\u3066\u5f97\u3089\u308c\u308b\u3088\u3046\u306a\u4ed5\u7d44\u307f\u300d\u306a\u306e\u3067\u3001\u3053\u308c\u304c\u8868\u73fe\u3067\u304d\u308c\u3070\u826f\u3055\u305d\u3046\u3067\u3059\u3002\n\u4eca\u56de\u8003\u3048\u308b\u51e6\u7406\u7cfb\u3067\u306f\u3001\u5024\u4e00\u822c\u306e\u3053\u3068\u3092\u300c\u5b9f\u884c\u30b3\u30fc\u30c9code\u3092\u30e1\u30f3\u30d0\u306b\u6301\u3064\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u300d\u3068\u307f\u306a\u3059\u3053\u3068\u306b\u3057\u307e\u3057\u3087\u3046\u3002\u5168\u3066\u306e\u57fa\u790e\u3068\u306a\u308b\u8a55\u4fa1\u95a2\u6570\u306f\u6b21\u306e\u3088\u3046\u306b\u5b9f\u88c5\u3055\u308c\u307e\u3059 :\nfunction Eval(x,env){\n  x.code(x,env);\n};\n\n\u3053\u306e\u3088\u3046\u306b\u5b9f\u884c\u95a2\u6570x.code\u306b\u306f\u305d\u306e\u5024\u81ea\u8eabx\u3068\u74b0\u5883env\u304c\u6e21\u3055\u308c\u3066\u304d\u307e\u3059\u3002\u3053\u306e\u3088\u3046\u306a\u51e6\u7406\u3092\u60f3\u5b9a\u3057\u305f\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u306e\u3053\u3068\u3092\u300c\u30af\u30ed\u30fc\u30b8\u30e3\u300d\u3068\u547c\u3076\u3053\u3068\u306b\u3057\u307e\u3059\u3002\n\u305d\u306e\u540d\u306e\u901a\u308a\u3068\u3044\u3048\u3070\u4f55\u3067\u3059\u304c\u3001\u5b9f\u969b\u3053\u308c\u306f\u30af\u30ed\u30fc\u30b8\u30e3\u3092\u8868\u73fe\u3057\u3066\u304f\u308c\u307e\u3059\u3002\u95a2\u6570\u306b\u5fc5\u8981\u306a\u306e\u306f\u300c\u5f15\u6570\u540d\u300d\u300c\u95a2\u6570\u672c\u4f53\u300d\u3068\u8a00\u3063\u305f\u3068\u3053\u308d\u3067\u3059\u304c\u3001\u305d\u308c\u306b\u52a0\u3048\u3066\u300c\u81ea\u7531\u5909\u6570\u540d\u300d\u300c\u81ea\u7531\u5909\u6570\u306e\u53c2\u7167\u5148\u300d\u3082\u7ba1\u7406\u3059\u308b\u3053\u3068\u306b\u306a\u308a\u307e\u3059\u3002\nvar Closure = function(free,args,code,ref){ // ([String],[String],(X,Env) \u2192 (),[Closure])\n  return {free:free,args:args,code:code,ref:ref};\n};\n\n\u5f15\u6570\u306a\u3069\u306f\u95a2\u6570\u9069\u7528\u306e\u3068\u304d\u306bargs\u306b\u5bfe\u5fdc\u3059\u308b\u540d\u524d\u3067\u74b0\u5883env\u306b\u81ea\u52d5\u3067\u767b\u9332\u3055\u308c\u308b\u3082\u306e\u3068\u3057\u307e\u3057\u3087\u3046\u3002\u3068\u3059\u308b\u3068\u4f8b\u3048\u3070const\u95a2\u6570\u306f\u6b21\u306e\u3088\u3046\u306b\u5b9f\u88c5\u3067\u304d\u305d\u3046\u3067\u3059 :\n// this doesn't work\nvar Const = Closure([],[\"x\"],function(x,env){\n  return Closure([\"x\"],[\"y\"],function(x,env){\n    return env[\"x\"];\n  },[env[\"x\"]]);\n},[]);\n\n\u5f8c\u3067\u6b63\u3057\u304f\u66f8\u304d\u76f4\u3059\u3053\u3068\u306b\u306a\u308a\u307e\u3059\u304c\u3001\u96f0\u56f2\u6c17\u306f\u4f1d\u308f\u308b\u3067\u3057\u3087\u3046\u304b\u3002Haskell\u3067\u66f8\u3044\u305fconst\u95a2\u6570 : \\x \u2192 \\y \u2192 x\u306b\u306f\u81ea\u7531\u5909\u6570\u306e\u60c5\u5831\u306f\u542b\u307e\u308c\u3066\u3044\u307e\u305b\u3093\u304c\u3001\u69cb\u6587\u89e3\u6790\u306e\u6bb5\u968e\u3067\u3082\u305d\u306e\u60c5\u5831\u3092\u52a0\u3048\u308b\u3053\u3068\u306f\u3067\u304d\u308b\u3067\u3057\u3087\u3046\u3002\u4eca\u56de\u306f\u81ea\u5206\u3067\u660e\u793a\u3057\u3066\u3044\u304f\u3053\u3068\u306b\u306a\u308a\u307e\u3059\u3002\n\u306a\u304a\u30af\u30ed\u30fc\u30b8\u30e3\u306e\u4e00\u7a2e(\u5f15\u6570\u304c\u7121\u3044\u3082\u306e)\u3068\u3057\u3066\u30b5\u30f3\u30af(\u672a\u8a55\u4fa1\u306e\u5024)\u3068\u3044\u3046\u6982\u5ff5\u304c\u3042\u308a\u307e\u3059\u3002\u3053\u308c\u3053\u305d\u304c\u9045\u5ef6\u8a55\u4fa1\u306e\u7279\u5fb4\u3068\u306a\u3063\u3066\u304a\u308a\u3001\u5f8c\u3067\u7d30\u304b\u304f\u307f\u308b\u3053\u3068\u306b\u306a\u308a\u307e\u3059\u3002\nHaskell\u306e\u5024\u3068\u3044\u3048\u3070\u30c7\u30fc\u30bf\u30b3\u30f3\u30b9\u30c8\u30e9\u30af\u30bf\u304c\u3042\u308a\u307e\u3059\u304c\u3001\u3053\u308c\u3082\u4e00\u7a2e\u306e\u30af\u30ed\u30fc\u30b8\u30e3\u3068\u3057\u3066\u69cb\u6210\u3057\u307e\u3059\u3002List a = Nil | Cons a (List a)\u3068\u3057\u305f\u6642\u3001Nil\u3068Cons\u306f\u6b21\u306e\u3088\u3046\u306b\u8868\u73fe\u3055\u308c\u307e\u3059 :\nvar Nil = Closure([],[],function(x,env){\n  ReturnCon(0)();\n},[]);\nvar Cons = Closure([],[\"x\",\"y\"],function(x,env){\n  ReturnCon(1)(env[\"x\"],env[\"y\"]);\n},[]);\n\n\u5b9f\u306f\u30c7\u30fc\u30bf\u30b3\u30f3\u30b9\u30c8\u30e9\u30af\u30bf\u3092\u8a55\u4fa1\u3059\u308b\u306e\u306fcase\u5f0f\u306e\u4e2d\u3060\u3051\u3060\u3068\u6c7a\u307e\u3063\u3066\u3044\u308b\u306e\u30672\u3001Nil/Cons\u3092\u5b9f\u884c\u3059\u308b\u3053\u3068\u306b\u306a\u308b\u3068\u304d\u306f\u3053\u306e\u30b3\u30fc\u30c9\u306f\u5fc5\u305a\u30d1\u30bf\u30fc\u30f3\u30de\u30c3\u30c1\u306b\u4f7f\u308f\u308c\u308b\u306f\u305a\u3067\u3059\u3002ReturnCon(n)\u3067\u300cn\u756a\u76ee\u306e\u30b3\u30f3\u30b9\u30c8\u30e9\u30af\u30bf\u306e\u30de\u30c3\u30c1\u30f3\u30b0\u306b\u5bfe\u5fdc\u3059\u308b\u7d99\u7d9a\u3092\u62fe\u3063\u3066\u304f\u308b\u300d\u3068\u3044\u3046\u3053\u3068\u304c\u3067\u304d\u3001\u5b9f\u969b\u306b\u30c7\u30fc\u30bf\u30b3\u30f3\u30b9\u30c8\u30e9\u30af\u30bf\u306b\u5bfe\u5fdc\u3059\u308b\u5206\u5c90\u304c\u5b9f\u884c\u3055\u308c\u308b\u3053\u3068\u3068\u306a\u308a\u307e\u3059\u3002\u30bf\u30b0\u4ed8\u3051\u3066\u5024\u3092\u8fd4\u3057\u3066\u5206\u5c90\u3092\u9078\u3076\u3088\u308a\u3082\u52b9\u7387\u7684\u306a\u308f\u3051\u3067\u3059\u3002\n\u307e\u305f\u3001Int\u306a\u3069\u306e\u751f\u5024\u3092\u3053\u306e\u5b9f\u884c\u5f62\u5f0f\u3067\u306f\u305d\u306e\u307e\u307e\u6271\u3046\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\u6b63\u78ba\u306b\u306f\u5168\u3066\u306e\u751f\u5024\u3092\u5358\u4e00\u306e\u30c7\u30fc\u30bf\u30b3\u30f3\u30b9\u30c8\u30e9\u30af\u30bf\u3067\u5305\u3080\u3053\u3068\u3067\u9045\u5ef6\u8a55\u4fa1\u3092\u3057\u3064\u3064\u751f\u30ec\u30d9\u30eb\u306e\u51e6\u7406\u3092\u5b9f\u884c\u3067\u304d\u308b\u3068\u3044\u3046\u3082\u306e\u3067\u3059\u3002\nvar Raw = function(n){\n  var cl = Closure([],[],function(x,env){\n    ReturnRaw(x.value);\n  },[]);\n  cl.value = n;\n  return cl;\n};\n\n\u4eca\u56de\u306f\u3053\u306eRaw\u95a2\u6570\u306b\u3088\u3063\u3066\u751f\u5024\u3092\u5305\u307f\u3001\u305d\u306e\u5024\u3078\u306ecase\u5f0f\u304c\u767a\u751f\u3057\u305f\u3068\u304d\u306bReturnRaw\u95a2\u6570\u306b\u751f\u5024\u3092\u6e21\u3057\u3066\u3042\u3052\u308b\u3001\u3068\u3044\u3046\u3053\u3068\u306b\u3057\u307e\u3059\u3002ReturnRaw\u306fReturnCon\u3068\u5927\u5dee\u306a\u3044\u3067\u3059\u3002JavaScript\u306e\u4efb\u610f\u306e\u5024\u306fRaw\u3067\u5305\u3080\u3053\u3068\u3067\u3053\u306e\u67a0\u7d44\u3067\u6271\u3048\u308b\u3088\u3046\u306b\u306a\u308b\u308f\u3051\u3067\u3059\u304c3\u3001\u3068\u308a\u3042\u3048\u305a\u306f\u6574\u6570\u5024\u3092\u5165\u308c\u308b\u3053\u3068\u3092\u8003\u3048\u3066\u3044\u307e\u3059\u3002\n\u30fb\u30fb\u30fb\u3068\u307e\u3041\u3001\u3060\u3044\u3076\u4e00\u822c\u7684\u306a\u8a00\u8a9e\u51e6\u7406\u7cfb\u3068\u306f\u7570\u306a\u308b\u5024\u306e\u6271\u3044\u30fb\u51e6\u7406\u3092\u3057\u3066\u3044\u308b\u3088\u3046\u3067\u3059\u3002\u5024\u306b\u610f\u5473\u304c\u4ed8\u968f\u3059\u308b\u3068\u3044\u3046\u306e\u304c\u3061\u3087\u3063\u3068\u304a\u3082\u3057\u308d\u3044\u70b9\u3067\u3057\u3087\u3046\u304b\uff1fcase\u306e\u30de\u30c3\u30c1\u30f3\u30b0\u306e\u4ed5\u7d44\u307f\u304c\u306a\u3093\u3068\u3082\u5408\u7406\u7684\u306a\u611f\u3058\u3067\u500b\u4eba\u7684\u306b\u597d\u304d\u3067\u3059\u3002\n\u672a\u3060\u306b\u300c\u52d5\u4f5c\u300d\u306f\u3055\u305b\u3066\u3044\u306a\u3044\u306e\u3067\u5206\u304b\u3089\u306a\u3044\u70b9\u306f\u591a\u3044\u3068\u601d\u3044\u307e\u3059\u3002\u5b9f\u969b\u306e\u52d5\u4f5c\u4f8b\u3092\u898b\u308b\u3053\u3068\u3067\u7406\u89e3\u3067\u304d\u308b\u3053\u3068\u3082\u3042\u308b\u3068\u304a\u3082\u3046\u306e\u3067\u3068\u308a\u3042\u3048\u305a\u8aad\u3093\u3067\u3044\u304f\u3068\u826f\u3044\u6c17\u304c\u3057\u307e\u3059\u3002\n\n\u95a2\u6570\u9069\u7528\n\u9045\u5ef6\u8a55\u4fa1\u3067\u306a\u3051\u308c\u3070\u300c\u5f15\u6570\u3092\u8a55\u4fa1\u3057\u300d\u300c\u305d\u308c\u3092\u95a2\u6570\u306b\u6e21\u3059\u300d\u306e\u304c\u57fa\u672c\u3067\u3059\u304c\u3001\u4eca\u56de\u306f\u300c\u5f15\u6570\u306e\u30af\u30ed\u30fc\u30b8\u30e3\u3092\u81ea\u7531\u5909\u6570\u306b\u7d50\u3073\u3064\u3051\u300d\u300c\u95a2\u6570\u3092\u5b9f\u884c\u3059\u308b\u300d\u3068\u3044\u3046\u6d41\u308c\u306b\u306a\u308a\u307e\u3059\u3002\u3053\u306e\u8a55\u4fa1\u6a5f\u69cb\u306f\u8907\u6570\u5f15\u6570\u3092\u540c\u6642\u306b\u9069\u7528\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u308b\u306e\u3067\u3059\u304c\u3001\u904e\u5270\u5f15\u6570(const id 1 2\u306a\u3069)\u3092\u9069\u5207\u306b\u6271\u3046\u305f\u3081\u306b\u4e00\u5ea6\u300c\u5f15\u6570\u30b9\u30bf\u30c3\u30afargs\u300d\u306b\u9000\u907f\u3057\u3066\u304b\u3089env\u306b\u66f8\u304d\u8fbc\u307f\u3092\u3059\u308b\u3053\u3068\u306b\u306a\u308a\u307e\u3059\u3002\nvar args = [];\nfunction exec(code,def){\n  def.code = code;\n  return def;\n}\nfunction retrive(env,x){\n  if(typeof env[x] === \"undefined\")return x;\n  else return env[x];\n}\nvar Apply = function(x,env){\n  for(var i=x.arg.length-1;i>-1;i--){\n    args.push(retrive(env,x.arg[i]));\n  }\n  Enter(x.func);\n};\nfunction app(f,xs){\n  return exec(Apply,{func:f,arg:xs});\n}\n\n\u5148\u306b\u8a00\u3063\u305f\u3088\u3046\u306b\u3001\u57fa\u672c\u7684\u306b\u5024\u306f\u300c\u610f\u5473\u3092\u8868\u3059\u30b3\u30fc\u30c9\u300d\u3068\u300c\u30c7\u30fc\u30bf\u3092\u8868\u3059\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u81ea\u8eab\u300d\u3067\u8868\u73fe\u3057\u307e\u3059\u3002exec\u95a2\u6570\u306f\u305d\u308c\u3089\u3092\u5408\u6210\u3057\u3066\u5024\u3092\u69cb\u6210\u3059\u308b\u4fbf\u5229\u95a2\u6570\u3067\u3059\u3002\u307e\u305fapp\u306fApply\u3092\u30b3\u30fc\u30c9\u3068\u3057\u3066\u6301\u3064\u3088\u3046\u306a\u5024\u3092\u4f5c\u308b\u305f\u3081\u306e\u4fbf\u5229\u95a2\u6570\u3067\u3059\u3002\nApply\u3092\u5b9f\u884c\u3059\u308b(\u3064\u307e\u308a\u95a2\u6570\u9069\u7528\u3092Eval\u3059\u308b)\u3068\u304d\u3001\u305d\u306e\u5f15\u6570\u3092\u30b9\u30bf\u30c3\u30af\u306b\u7a4d\u3093\u3067Enter\u306b\u3088\u3063\u3066\u300c\u95a2\u6570\u3092\u5b9f\u884c\u300d\u3057\u307e\u3059\u3002\nEnter\u3055\u308c\u305f\u95a2\u6570\u306f\u81ea\u7531\u5909\u6570\u3068\u5f15\u6570\u306e\u60c5\u5831\u3092\u62fe\u3044\u96c6\u3081\u3001\u95a2\u6570\u672c\u4f53\u3092\u8a55\u4fa1\u3057\u306b\u3044\u304d\u307e\u3059 :\nfunction Enter(f){\n  var env = {};\n  for(var i=0;i<f.free.length;i++){\n    env[f.free[i]] = f.ref[i];\n  }\n  f.args.forEach(function(name){\n    env[name] = args.pop();\n  });\n  Eval(f,env);\n}\n\n\u3053\u308c\u3067\u5148\u7a0b\u66f8\u3044\u305f\u300c\u81ea\u52d5\u3067env\u306b\u767b\u9332\u3059\u308b\u300d\u3092\u9054\u6210\u3057\u307e\u3059\u306d\u3002\u3055\u3066\u3001\u3053\u306eApply\u306b\u3088\u3063\u3066\u300c\u3061\u3083\u3093\u3068\u52d5\u304f\u300did\u95a2\u6570\u3092\u4f5c\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059 :\nvar Id = Closure([],[\"x\"],function(x,env){\n  Eval(app(env[\"x\"],[]),env);\n},[]);\n\nenv[\"x\"]\u3092Eval\u3059\u308b\u306e\u3067\u306f\u306a\u304fapp(env[\"x\"],[])\u3092Eval\u3057\u3066\u3044\u308b\u306e\u306f\u3061\u3083\u3093\u3068\u300c(\u30b5\u30f3\u30af\u3068\u3057\u3066\u306e)\u30af\u30ed\u30fc\u30b8\u30e3\u3092\u5b9f\u884c\u3059\u308b\u300d\u3068\u3044\u3046\u51e6\u7406(Enter)\u3092\u8d70\u3089\u305b\u308b\u305f\u3081\u3067\u30594\u3002\n\u3061\u306a\u307f\u306bconst\u306f\u5f15\u6570\u3092\u3082\u3046\u4e00\u3064\u53d6\u308c\u3070\u3044\u3044\u3060\u3051\u3067\u3059\u306d\u3002\nvar Const = Closure([],[\"x\",\"y\"],function(x,env){\n  Eval(app(env[\"x\"],[]),env);\n},[]);\n\n\n\u30ea\u30bf\u30fc\u30f3\u30b9\u30bf\u30c3\u30af\n\u57fa\u790e\u306f\u5927\u4f53\u3067\u304d\u3042\u304c\u3063\u305f\u306e\u3067\u3001\u6b21\u306b\u751f\u5024\u3092\u30ea\u30bf\u30fc\u30f3\u3059\u308b\u90e8\u5206\u3092\u3064\u304f\u308a\u307e\u3059\u3002\nvar returns = [];\nfunction ReturnRaw(n){\n  var ret = returns.pop();\n  ret(ret.env)[0](n);\n};\nfunction evaluate(expr){\n  returns.push(function(env){return [function(n){\n    console.log(n);\n  }];});\n  Eval(expr,{});\n}\n\n\u5f0f\u306e\u8a55\u4fa1\u306fcase\u5f0f\u3067\u306e\u307f\u767a\u751f\u3059\u308b\u3068\u8a00\u3044\u307e\u3057\u305f\u3002\u3053\u308c\u306fcase\u5f0f\u3067\u306e\u307f\u30ea\u30bf\u30fc\u30f3\u30b9\u30bf\u30c3\u30af\u306b\u7a4d\u3080\u51e6\u7406\u304c\u767a\u751f\u3059\u308b\u3068\u3044\u3046\u3053\u3068\u3067\u3059\u3002ReturnRaw\u95a2\u6570\u3067\u306f\u78ba\u304b\u306b\u305d\u306e\u30ea\u30bf\u30fc\u30f3\u5148\u3092\u53d6\u308a\u51fa\u3057\u3066\u5f15\u6570\u306b\u6e21\u3057\u3066\u5b9f\u884c\u3001\u3092\u884c\u3063\u3066\u3044\u307e\u3059\u306d\u3002\n\u307e\u305f\u3001evaluate\u95a2\u6570\u3067\u306f\u3068\u308a\u3042\u3048\u305a\u6700\u521d\u306b\u300c\u5024\u3092\u8868\u793a\u3059\u308b\u305f\u3081\u306e\u8b0e\u306e\u7d99\u7d9a\u300d\u3092\u7a4d\u3093\u3067\u304a\u304f\u3053\u3068\u3067\u8a55\u4fa1\u3092\u6a21\u5023\u3057\u3066\u3044\u307e\u3059\u3002\u5b9f\u969bEval\u3057\u305f\u7d50\u679c\u306f\u81ea\u52d5\u7684\u306b\u30ea\u30bf\u30fc\u30f3\u30b9\u30bf\u30c3\u30af\u4e0a\u306e\u95a2\u6570\u3092\u547c\u3076\u306e\u3067\u3001\u3053\u308c\u3067console.log(n);\u306f\u5b9f\u884c\u3055\u308c\u308b\u306f\u305a\u3067\u30595\u3002\n\u3068\u3044\u3046\u308f\u3051\u3067\u3001\u65e9\u901f\u5b9f\u884c\u3057\u3066\u307f\u307e\u3057\u3087\u3046\u3002\u3068\u8a00\u3063\u3066\u3082id/const\u304f\u3089\u3044\u3057\u304b\u306a\u3044\u3067\u3059\u3051\u3069\u3002\nevaluate(app(Id,[Raw(1)])); // => 1\nevaluate(app(Const,[Raw(2),Raw(3)])); // => 2\nevaluate(app(Const,[Id,Raw(4),Raw(5)])); // => 5\n\n\u3061\u306a\u307f\u306b\u3001\u3053\u3053\u3067\u95a2\u6570\u306e\u5f15\u6570\u3068\u3057\u3066\u6e21\u305b\u308b\u3082\u306e\u306f\u304b\u306a\u308a\u9650\u3089\u308c\u3066\u3044\u307e\u3059\u3002\u5143\u3005\u30af\u30ed\u30fc\u30b8\u30e3\u304f\u3089\u3044\u3057\u304b\u60f3\u5b9a\u3057\u3066\u3044\u306a\u3044\u306e\u3067\u3059\u3002\u3053\u308c\u3067\u306f\u95a2\u6570\u9069\u7528\u306e\u30cd\u30b9\u30c8\u3059\u3089\u3067\u304d\u306a\u3044\u306e\u3067\u3001\u3053\u308c\u3092\u56de\u907f\u3059\u308b\u305f\u3081\u306blet-in\u5f0f\u3092\u4f5c\u308b\u3053\u3068\u306b\u306a\u308a\u307e\u3059\u3002\n\nlet-in\u5f0f\u3001case\u5f0f\n\u3082\u3046\u8a55\u4fa1\u6a5f\u69cb\u81ea\u4f53\u306f\u6b86\u3069\u51fa\u6765\u3066\u3044\u308b\u306e\u3067\u8907\u96d1\u306a\u3053\u3068\u306f\u3042\u3093\u307e\u308a\u306a\u3044\u3067\u3059\u3002\nvar Let = function(x,env){\n  for(var i=0;i<x.defines.length;i+=2){\n    var name = x.defines[i];\n    var value = x.defines[i+1];\n    env[name] = value;\n  }\n  for(var i=0;i<x.defines.length;i+=2){\n    var name = x.defines[i];\n    env[name].ref = [];\n    env[name].free.forEach(function(n){\n      env[name].ref.push(env[n]);\n    });\n  }\n  Eval(x.expr,env);\n};\nfunction letIn(xs,e){ // ([String,Closure],Closure)\n  return exec(Let,{defines:xs,expr:e});\n}\n\nletIn\u306b\u3064\u3044\u3066\u306f\u7d30\u304b\u304f\u89e3\u8aac\u3057\u307e\u305b\u3093\u3002\nfunction ReturnCon(n){\n  var ret = returns.pop();\n  return ret(ret.env)[n];\n};\nvar Case = function(x,env){\n  x.cases.env = env;\n  returns.push(x.cases);\n  Eval(x.expr,env);\n};\nfunction caseOf(expr,cases){ // (Closure,Env -> [Argument -> Closure])\n  return exec(Case,{expr:expr,cases:cases});\n};\n\nReturnCon\u3067\u306fReturnRaw\u3068\u540c\u69d8\u306b\u9069\u5207\u306a\u7d99\u7d9a(\u4eca\u56de\u306fn\u756a\u76ee\u306e\u30b3\u30f3\u30b9\u30c8\u30e9\u30af\u30bf\u306b\u5bfe\u5fdc\u3059\u308b\u7d99\u7d9a)\u3092\u62fe\u3063\u3066\u304d\u307e\u3059\u3002Case\u306f\u30ea\u30bf\u30fc\u30f3\u30b9\u30bf\u30c3\u30af\u306b\u7a4d\u3080\u3060\u3051\u3067\u3059\u306d6\u3002\n\n\u3044\u308d\u3044\u308d\u5b9f\u884c\u3057\u3066\u307f\u3088\u3046\ncase\u5f0f\u304c\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u3063\u305f\u304a\u304b\u3052\u3067\u3060\u3044\u3076\u5e45\u304c\u5e83\u307e\u308a\u307e\u3057\u305f\u3002\u7279\u306bRaw\u306e\u4e2d\u8eab\u3092\u53d6\u308a\u51fa\u3059\u3053\u3068\u304c\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3057\u305f\u3002\u3068\u3044\u3046\u3053\u3068\u3067 :\nvar Add = Closure([],[\"x\",\"y\"],function(x,env){\n  Eval(caseOf(app(env[\"x\"],[]),function(env){return [function(x){\n    env[\"#x\"] = x;\n    Eval(caseOf(app(env[\"y\"],[]),function(env){return [function(y){\n      env[\"#y\"] = y;\n      Eval(Raw(env[\"#x\"] + env[\"#y\"]),env);\n    }];}),env);\n  }];}),env);\n},[]);\nevaluate(app(Add,[Raw(6),Raw(7)])); // => 13\n\n\u751f\u5024\u306e\u52a0\u7b97\u304c\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3057\u305f7\uff01\n\u3064\u3044\u3067\u306b\u8abf\u5b50\u306b\u4e57\u3063\u3066\u307f\u307e\u3059\u3002\nvar Length = Closure([],[\"xs\"],function(x,env){\n  Eval(caseOf(app(env[\"xs\"],[]),function(env){return [function(){\n    Eval(Raw(0),env);\n  },function(a,as){\n    Eval(letIn([\n      \"n\",Closure([],[],function(x,env){Eval(app(Length,[as]),env);},[])\n    ],Closure([\"n\"],[],function(x,env){Eval(app(Add,[Raw(1),env[\"n\"]]),env)},[])),env);\n  }]}),env);\n},[]);\nevaluate(letIn([\n  \"a\",Closure([],[],function(x,env){Eval(app(Nil,[]),env);},[]),\n  \"b\",Closure([\"a\"],[],function(x,env){Eval(app(Cons,[Raw(10),env[\"a\"]]),env);},[]),\n  \"c\",Closure([\"b\"],[],function(x,env){Eval(app(Cons,[Raw(9),env[\"b\"]]),env);},[]),\n  \"d\",Closure([\"c\"],[],function(x,env){Eval(app(Cons,[Raw(8),env[\"c\"]]),env);},[])\n],Closure([\"d\"],[],function(x,env){Eval(app(Length,[env[\"d\"]]),env);},[]))); // => 3\n\n\u8aad\u307f\u306b\u304f\u3044\u3067\u3059\u3051\u3069let {a = Nil; b = Cons 10 a; c = Cons 9 b; d = Cons 8 c} in length d\u3001\u8981\u306flength (Cons 8 (Cons 9 (Cons 10 Nil)))\u3067\u3059\u3002\u3046\u307e\u304f\u3046\u3054\u3044\u3066\u304f\u308c\u308b\u306f\u305a\u3067\u3059\u3002\n\u6298\u89d2\u306a\u306e\u3067\u8a55\u4fa1\u7d4c\u904e\u3092\u3086\u3063\u304f\u308a\u898b\u3066\u307f\u3088\u3046\u304b\u3068\u601d\u3044\u307e\u3059\u3002\u91cd\u8981\u306a\u306e\u306fEval/Enter/ReturnCon/ReturnRaw\u306a\u306e\u3067\u3001\u305d\u308c\u3089\u306e\u547c\u3073\u51fa\u3057\u3092\u78ba\u8a8d\u3057\u3066\u307f\u307e\u3059\u3002\u9069\u5f53\u306b\u624b\u52d5\u3067\u898b\u3084\u3059\u304f\u3057\u3066\u3044\u307e\u30598(\u3042\u3068\u7121\u99c4\u306a\u90e8\u5206\u3092\u6d88\u3057\u305f\u308a\u3057\u3066\u307e\u3059)\u3002\n\"Eval\"      let {a=Nil[], b=Cons[10,a], c=Cons[9,b], d=Cons[8,c]} in Length[d]\n\n\"Eval\"      Length[Cons[8,Cons[9,Cons[10,Nil[]]]]]    {}\n\"Enter\"     Length                                    {}\n\"Eval\"      Length                                    {xs -> Cons[8,Cons[9,Cons[10,Nil[]]]]}\n\"Eval\"      case xs of {Nil -> ..., Cons a as -> ...} {xs -> ...} [+Return]\n\"Eval\"      Cons[8,Cons[9,Cons[10,Nil[]]]]            {xs -> ...}\n\"Enter\"     Cons                                      {xs -> ...}\n\"Eval\"      Cons                                      {xs -> ..., x -> 8, y -> Cons[9,Cons[10,Nil]]}\n\"ReturnCon\" 1 (Cons)                                  [-Return]\n\"Eval\"      Add[1,Length[y]]                          {xs -> ..., x -> 8, y -> ...}\n\"Enter\"     Add                                       {xs -> ..., x -> 8, y -> ...}\n\"Eval\"      Add                                       {xs -> ..., x -> 1, y -> Length[Cons[9,Cons[10,Nil[]]]]}\n\"Eval\"      case x of {x -> ...}                      {xs -> ..., x -> 1, y -> Length[Cons[9,Cons[10,Nil[]]]]} [+Return]\n\"Eval\"      1                                         {xs -> ..., x -> 1, y -> Length[Cons[9,Cons[10,Nil[]]]]}\n\"ReturnRaw\" 1                                         [-Return]\n\"Eval\"      case y of {y -> ...}                      {xs -> ..., x -> 1, y -> Length[Cons[9,Cons[10,Nil[]]]]} [+Return]\n\"Eval\"      Length[Cons[9,Cons[10,Nil[]]]]            {xs -> ..., x -> 1, y -> Length[Cons[9,Cons[10,Nil[]]]]}\n\"Enter\"     Length                                    {xs -> ..., x -> 1, y -> Length[Cons[9,Cons[10,Nil[]]]]}\n\"Eval\"      Length                                    {xs -> Cons[9,Cons[10,Nil]]}\n...\n\"Eval\"      Length                                    {xs -> Nil[]}\n\"Eval\"      case xs of {Nil -> ..., Cons a as -> ...} {xs -> Nil[]} [+Return]\n\"Eval\"      Nil[]                                     {xs -> Nil[]}\n\"Enter\"     Nil                                       {xs -> Nil[]}\n\"Eval\"      Nil                                       {}\n\"ReturnCon\" 0 (Nil)                                   [-Return]\n\"Eval\"      0                                         {xs -> Nil[]}\n\"ReturnRaw\" 0                                         [-Return]\n\"Eval\"      1                                         {x -> 1, y -> Length[Nil[]]}\n\"ReturnRaw\" 1                                         [-Return]\n\"Eval\"      2                                         {x -> 1, y -> Length[Cons[10,Nil[]]]}\n\"ReturnRaw\" 2                                         [-Return]\n\"Eval\"      3                                         {x -> 1, y -> Length[Cons[9,Cons[10,Nil[]]]]}\n\"ReturnRaw\" 3                                         [-Return]\n// => 3\n\n\u518d\u5e30\u547c\u3073\u51fa\u3057\u306b\u3088\u3063\u3066\u30ea\u30bf\u30fc\u30f3\u304c\u7a4d\u307e\u308c\u3066\u3044\u304d\u3001\u6700\u5f8c\u306b\u4e00\u6c17\u306b\u623b\u3063\u3066\u3044\u304f\u306e\u304c\u308f\u304b\u308b\u3068\u304a\u3082\u3044\u307e\u3059\u3002\n\n\u30b0\u30e9\u30d5\u7c21\u7d04\n\u4eca\u306e\u3068\u3053\u308d\u9045\u5ef6\u8a55\u4fa1\u3068\u3057\u3066\u306f\u3046\u307e\u304f\u52d5\u4f5c\u3059\u308b\u306e\u3067\u3059\u304c\u30b0\u30e9\u30d5\u7c21\u7d04\u306f\u3057\u3066\u304f\u308c\u306a\u3044\u3067\u3059\u3002\n\u4f8b\u3048\u3070 :\nevaluate(letIn([\n  \"a\",Closure([],[],function(x,env){Eval(app(Add,[Raw(1),Raw(1)]),env);},[]),\n  \"b\",Closure([\"a\"],[],function(x,env){Eval(app(Add,[env[\"a\"],env[\"a\"]]),env);},[]),\n  \"c\",Closure([\"b\"],[],function(x,env){Eval(app(Add,[env[\"b\"],env[\"b\"]]),env);},[])\n],Closure([\"c\"],[],function(x,env){Eval(app(env[\"c\"],[]),env);})));\n\n\u8981\u306flet {a = 1 + 1; b = a + a; c = b + b} in c\u30678\u306a\u306e\u3067\u3059\u304c\u3001\u3053\u306e\u9593a\u306f4\u56de\u8a55\u4fa1\u3055\u308c\u3066\u3057\u307e\u3044\u307e\u30599\u3002\u3053\u308c\u3067\u306f\u30b0\u30e9\u30d5\u7c21\u7d04\u306b\u306a\u3063\u3066\u306a\u3044\u306e\u3067\u3001\u8272\u3005\u4fee\u6b63\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u306e\u3067\u3059\u3002\n\u5b9f\u969b\u306b\u5fc5\u8981\u306a\u4ed5\u7d44\u307f\u306f\u300c\u30af\u30ed\u30fc\u30b8\u30e3\u306e\u66f4\u65b0\u300d\u3067\u3059\u3002a\u3092\u8a55\u4fa1\u3057\u305f\u7d50\u679cReturnRaw 2\u304c\u767a\u751f\u3059\u308b\u306f\u305a\u3067\u3059\u304c\u3001\u3053\u308c\u3092\u5bdf\u77e5\u3057\u3066a\u306e\u6307\u3059\u30af\u30ed\u30fc\u30b8\u30e3\u3092Raw(2)\u305d\u306e\u3082\u306e\u306b\u3059\u308a\u66ff\u3048\u3066\u3057\u307e\u3046\u3001\u3068\u3044\u3046\u3053\u3068\u3092\u884c\u3046\u306e\u3067\u3059\u3002\u66f4\u65b0\u3067\u304d\u308b\u30af\u30ed\u30fc\u30b8\u30e3\u3068\u66f4\u65b0\u3067\u304d\u306a\u3044\u30af\u30ed\u30fc\u30b8\u30e3(id\u3068\u304b)\u304c\u3042\u308a\u307e\u3059\u304c\u3001\u3053\u308c\u306f\u660e\u793a\u7684\u306b\u30bd\u30fc\u30b9\u306b\u8a18\u8ff0\u3059\u308b\u3053\u3068\u306b\u3057\u307e\u305910\u3002\nfunction updatable(closure){\n  closure.updatable = true;\n  return closure;\n}\nvar updates = [];\nfunction Enter(f){\n  var env = {};\n  for(var i=0;i<f.free.length;i++){\n    env[f.free[i]] = f.ref[i];\n  }\n  f.args.forEach(function(name){\n    env[name] = args.pop();\n  });\n  if(f.updatable){\n    // f.args.length should be 0\n    updates.push({args:args,returns:returns,target:f});\n    args = [], returns = [];\n  }\n  Eval(f,env);\n}\n\nupdatable\u306a\u30af\u30ed\u30fc\u30b8\u30e3\u3078\u306eEnter\u304c\u767a\u751f\u3057\u305f\u3068\u304d\u3001\u5f15\u6570\u30b9\u30bf\u30c3\u30af\u3068\u30ea\u30bf\u30fc\u30f3\u30b9\u30bf\u30c3\u30af\u3092\u3059\u3079\u3066\u9000\u907f\u3057\u3066\u3057\u307e\u3044\u307e\u3059\u3002\u305d\u3046\u3059\u308b\u3068\u3001\u3053\u306e\u30af\u30ed\u30fc\u30b8\u30e3\u304c\u6700\u5f8c\u306b\u30ea\u30bf\u30fc\u30f3\u3059\u308b\u3068\u304d\u306b\u3061\u3087\u3046\u3069\u30b9\u30bf\u30c3\u30af\u304c\u7a7a\u306b\u306a\u3063\u3066\u3044\u308b\u306f\u305a\u3067\u3059\u3002\u3068\u3044\u3046\u308f\u3051\u3067ReturnRaw\u3001ReturnCon\u3092\u5bfe\u5fdc\u3055\u305b\u307e\u3059\u3002\nfunction ReturnRaw(n){\n  if(returns.length==0){\n    var u = updates.pop();\n    args = u.args, returns = u.returns;\n    var repl = Raw(n);\n    u.target.free = repl.free;\n    u.target.args = repl.args;\n    u.target.code = repl.code;\n    u.target.ref = repl.ref;\n    u.target.value = repl.value;\n    delete u.target.updatable;\n  }\n  var ret = returns.pop();\n  ret(ret.env)[0](n);\n}\nfunction ReturnCon(n){\n  if(returns.length==0){\n    var u = updates.pop();\n    args = u.args, returns = u.returns;\n    return function(){\n      var args = [];\n      for(var i=0;i<arguments.length;i++)args.push(arguments[i]);\n      var names = [];\n      for(var i=0;i<args.length;i++){\n        names.push(\"Var\"+i);\n      }\n      var repl = Closure(names,[],function(x,env){\n        var vars = names.map((n)=>env[n]);\n        ReturnCon(n).apply(null,vars);\n      },args);\n      u.target.free = repl.free;\n      u.target.args = repl.args;\n      u.target.code = repl.code;\n      u.target.ref = repl.ref;\n      delete u.target.updatable;\n      var ret = returns.pop();\n      ret(ret.env)[n].apply(null,args);\n    }\n  }else{\n    var ret = returns.pop();\n    return ret(ret.env)[n];\n  }\n}\n\n\u66f4\u65b0\u3059\u308b\u5bfe\u8c61\u306fupdates[0]\u306b\u4fdd\u6301\u3055\u308c\u3066\u304a\u308a\u3001\u307e\u305f\u305d\u308c\u3092\u4f55\u306b\u66f4\u65b0\u3059\u308b\u304b\u3068\u3044\u3046\u306e\u3082ReturnRaw\u3067\u306f\u5f15\u6570\u306en\u304c\u6301\u3063\u3066\u3044\u307e\u3059\u3002\u3068\u3044\u3046\u308f\u3051\u3067\u5b9f\u969b\u306bRaw(n)\u306e\u51e6\u7406\u5185\u5bb9\u3092\u30b3\u30d4\u30fc\u305711\u3001\u6700\u5f8c\u306bupdatable\u306e\u30d5\u30e9\u30b0\u3092\u6d88\u305b\u3070\u66f4\u65b0\u5b8c\u4e86\u306a\u306e\u3067\u3059\u3002ReturnCon\u3067\u3082\u5927\u4f53\u540c\u3058\u3067\u305912\u3002\n\u3068\u3044\u3046\u308f\u3051\u3067\u6b21\u306e\u30b3\u30fc\u30c9\u306f\u5b9f\u969b\u306ba\u30921\u5ea6\u3057\u304b\u8a55\u4fa1\u3057\u306a\u3044\u3088\u3046\u306b\u306a\u3063\u3066\u304f\u308c\u307e\u3059\u3002\u3084\u3063\u305f\u306d\uff01\nevaluate(letIn([\n  \"a\",updatable(Closure([   ],[],function(x,env){Eval(app(Add,[Raw(1),Raw(1)]),env);},[])),\n  \"b\",updatable(Closure([\"a\"],[],function(x,env){Eval(app(Add,[env[\"a\"],env[\"a\"]]),env);},[])),\n  \"c\",updatable(Closure([\"b\"],[],function(x,env){Eval(app(Add,[env[\"b\"],env[\"b\"]]),env);},[]))\n],Closure([],[],function(x,env){Eval(app(env[\"c\"],[]),env);})));\n\n\n\u672c\u984c\n\u3068\u308a\u3042\u3048\u305a\u4eca\u307e\u3067\u8a55\u4fa1\u6a5f\u69cb\u3092\u4f5c\u3063\u3066\u304d\u305f\u308f\u3051\u3067\u3059\u304c\u3001\u5143\u3005\u306e\u8003\u3048\u305f\u3044\u5185\u5bb9\u306f\u300c\u7121\u9650\u518d\u5e30\u505c\u6b62\u6a5f\u69cb\u300d\u306e\u306f\u306a\u3057\u3067\u3057\u305f\u3002\n\u7121\u9650\u518d\u5e30\u691c\u51fa\u306e\u4ed5\u7d44\u307f\u306f\u5b9f\u306f\u975e\u5e38\u306b\u7c21\u5358\u3067\u3059 : \u30af\u30ed\u30fc\u30b8\u30e3\u3092\u66f4\u65b0\u3057\u3066\u3044\u308b\u9593\u306b\u305d\u306e\u30af\u30ed\u30fc\u30b8\u30e3\u3092\u8a55\u4fa1\u3057\u305f\u3089\u7121\u9650\u518d\u5e30\u3002\n\u4f55\u6545\u306a\u3089\u66f4\u65b0\u53ef\u80fd\u306a\u30af\u30ed\u30fc\u30b8\u30e3\u306f\u5f15\u6570\u3092\u53d6\u308c\u306a\u3044\u3053\u3068\u306b\u306a\u3063\u3066\u3044\u308b\u70baenv\u306e\u5185\u5bb9\u306f\u5168\u304f\u5909\u5316\u305b\u305a13\u3001\u7d50\u679c\u305d\u306e\u30af\u30ed\u30fc\u30b8\u30e3\u3078\u306e\u8a55\u4fa1\u306f\u307e\u305f\u5fc5\u305a\u66f4\u65b0\u3092\u751f\u3080\u306e\u3067\u3001\u307e\u305f\u3055\u3089\u306a\u308b\u30af\u30ed\u30fc\u30b8\u30e3\u306e\u8a55\u4fa1\u3092\u751f\u3080\u304b\u3089\u3067\u3059\u306d\u3002\u53c2\u7167\u900f\u660e\u6027\u304b\u3089\u3053\u308c\u306f\u7121\u9650\u518d\u5e30\u306b\u3057\u304b\u306a\u3089\u306a\u3044\u3053\u3068\u304c\u308f\u304b\u308a\u307e\u3059\u3002\n\u300c\u73fe\u5728\u30af\u30ed\u30fc\u30b8\u30e3\u306e\u8a55\u4fa1\u4e2d\u3067\u3042\u308b\u3053\u3068\u300d\u306f\u4e00\u822c\u306e\u30af\u30ed\u30fc\u30b8\u30e3\u3067\u306f\u53d6\u5f97\u3067\u304d\u307e\u305b\u3093\u304c\u3001\u66f4\u65b0\u4e2d\u306a\u3089\u660e\u3089\u304b\u3067\u3059\u3002(\u66f4\u65b0\u958b\u59cb\u3057\u305f\u3089\u66f4\u65b0\u7d42\u4e86\u3059\u308b\u306f\u305a\u3067\u3059\u3002)\n\u3055\u3089\u306b\u8a00\u3048\u3070\u30af\u30ed\u30fc\u30b8\u30e3\u3092\u66f4\u65b0\u3059\u308b\u969b\u306b\u306f\u5b8c\u5168\u306b\u524d\u306e\u30af\u30ed\u30fc\u30b8\u30e3\u306e\u60c5\u5831\u3092\u6d88\u3057\u3066\u3057\u307e\u3046\u308f\u3051\u3067\u3001\u300c\u30af\u30ed\u30fc\u30b8\u30e3\u306e\u66f4\u65b0\u3092\u958b\u59cb\u3057\u305f\u3089\u305d\u306e\u30af\u30ed\u30fc\u30b8\u30e3\u306b\u5bfe\u3057\u3066\u4f55\u3092\u3057\u3066\u3082\u826f\u3044\u300d\u3068\u3044\u3046\u3053\u3068\u304c\u5f93\u3044\u307e\u3059\u3002\u3082\u3057\u3082\u305d\u308c\u3067\u554f\u984c\u3068\u306a\u308b\u30b1\u30fc\u30b9\u304c\u3042\u308c\u3070\u7121\u9650\u518d\u5e30\u306e\u307f\u3060\u304b\u3089\u3067\u305914\u3002\u305d\u3057\u3066\u3053\u306e\u6a5f\u69cb\u306f\"Black hole\"\u3068\u547c\u3070\u308c\u3066\u3044\u308b\u3088\u3046\u3067\u3059\u3002\nfunction updatable(closure){\n  closure.updatable = true;\n  var code = closure.code;\n  closure.code = function(x,env){\n    // make a black hole!\n    x.code = function(x,env){\n      throw new Error(\"<<loop>>\");\n    };\n    code(x,env);\n  };\n  return closure;\n}\n\nupdatable\u306b\u3059\u308b\u969b\u306b\u30af\u30ed\u30fc\u30b8\u30e3\u306e\u5185\u90e8\u30b3\u30fc\u30c9\u306b\u3061\u3087\u3063\u3068\u624b\u3092\u52a0\u3048\u307e\u3059\u3002\u3053\u308c\u3067\u8a55\u4fa1\u304c\u767a\u751f\u3057\u305f\u3068\u304d\u306b\u300c\u81ea\u8eab\u306e\u5b9f\u884c\u30b3\u30fc\u30c9\u3092\u4f8b\u5916\u3092\u6295\u3052\u308b\u95a2\u6570\u306b\u5909\u3048\u3066\u304b\u3089\u300d\u4eca\u307e\u3067\u901a\u308a\u306e\u8a55\u4fa1\u3092\u3059\u308b\u3001\u3068\u3044\u3046\u3053\u3068\u304c\u5b9f\u73fe\u3067\u304d\u307e\u3059\u3002\nvar A = updatable(Closure([],[],function(x,env){\n  Eval(app(Add,[Raw(1),A]),env);\n},[]));\nevaluate(A); // => Uncaught Error: <<loop>>\n\na = 1 + a\u3068\u3057\u3066a\u3092\u8a55\u4fa1\u3059\u308b\u3068\u3001\u78ba\u304b\u306b\u4f8b\u5916\u3092\u5410\u3044\u3066\u304f\u308c\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3057\u305f\uff01\n\u3067\u3082\u3001\u52ff\u8ad6b = 1 : b\u306f\u7279\u306b\u554f\u984c\u306f\u8d77\u304d\u306a\u3044\u3067\u3059\u306d\uff01 (\u4e0b\u306e\u30b3\u30fc\u30c9\u306flength (take 10 b)\u3067\u3059) (Take\u306e\u5b9a\u7fa9\u3067\u30ba\u30eb\u3092\u3057\u3066\u3044\u307e\u3059\u3051\u3069\u8a31\u3057\u3066\u304f\u3060\u3055\u3044)\nvar Take = Closure([],[\"n\",\"xs\"],function(x,env){\n  Eval(caseOf(app(env[\"n\"],[]),function(env){return [function(n){\n    if(n==0){\n      Eval(app(Nil,[]),env);\n    }else{\n      Eval(caseOf(app(env[\"xs\"],[]),function(env){return [function(){\n        Eval(app(Nil,[]),env);\n      },function(a,as){\n        Eval(letIn([\n          \"ys\",Closure([],[],function(x,env){Eval(app(Take,[Raw(n-1),as]),env);},[])\n        ],Closure([\"ys\"],[],function(x,env){Eval(app(Cons,[a,env[\"ys\"]]),env);},[])),env);\n      }];}),env);\n    }\n  }];}),env);\n},[]);\nvar B = updatable(Closure([],[],function(x,env){\n  Eval(app(Cons,[Raw(1),B]),env);\n},[]));\nevaluate(letIn([\n  \"b\",updatable(Closure([],[],function(x,env){Eval(app(Take,[Raw(10),B]),env);},[])),\n  \"c\",updatable(Closure([\"b\"],[],function(x,env){Eval(app(Length,[env[\"b\"]]),env);},[]))\n],Closure([\"c\"],[],function(x,env){Eval(app(env[\"c\"],[]),env);},[]))); // => 10\n\n\u3053\u306e\u5dee\u304c\u3069\u3053\u304b\u3089\u6765\u308b\u304b\u3068\u3044\u3046\u3068\u3001a = 1 + a\u306b\u3064\u3044\u3066\u306fa\u3092\u66f4\u65b0\u3059\u308b\u969b\u306b\u306f1\u306e\u8a55\u4fa1\u306e\u3042\u3068a\u3092\u8a55\u4fa1\u3057\u306a\u3044\u3068\u66f4\u65b0\u304c\u5b8c\u4e86\u3057\u306a\u3044(Add\u306e\u4e2d\u3067case\u5f0f\u3092\u547c\u3093\u3067\u3057\u307e\u3046)\u3001\u3068\u3044\u3046\u3053\u3068\u3068b = 1 : b\u3067\u306fb\u306e\u66f4\u65b0\u306f\u6700\u521d\u306eCons\u304c\u6765\u305f\u6642\u70b9\u3067\u3082\u3046\u5b8c\u4e86\u3059\u308b(ReturnCon)\u3001\u3068\u3044\u3046\u90e8\u5206\u3067\u3059\u306d\u3002\n\u3068\u3044\u3046\u308f\u3051\u3067\u3001\u7121\u9650\u518d\u5e30\u505c\u6b62\u6a5f\u69cb\u306b\u3064\u3044\u30661\u304b\u3089\u4f5c\u308a\u4e0a\u3052\u3066\u518d\u73fe\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3057\u305f\uff01\u304a\u3081\u3067\u3068\u3046\u3054\u3056\u3044\u307e\u3059\uff01\n\n\u307e\u3068\u3081\n\u6700\u521d\u306e\u8cea\u554f\u306b\u5bfe\u3059\u308b\u7b54\u3048\u3068\u3057\u3066\u306f :\n\n\u30af\u30ed\u30fc\u30b8\u30e3\u306e\u8a55\u4fa1\u4e2d\u306b\u305d\u306e\u30af\u30ed\u30fc\u30b8\u30e3\u81ea\u8eab\u3092\u5dfb\u304d\u8fbc\u3080\u3088\u3046\u306a\u3053\u3068\u304c\u306a\u3051\u308c\u3070\u5408\u6cd5\u3067\n\u5408\u6cd5\u3067\u306a\u3044\u3082\u306e\u306f\u5168\u3066\u691c\u51fa\u3067\u304d\u308b\n\u305d\u306e\u691c\u51fa\u6a5f\u69cb\u306f\"Black hole\"\u3067\u5b9f\u73fe\u3055\u308c\u3066\u3044\u308b\n\n\u3068\u3044\u3046\u3053\u3068\u306b\u306a\u308a\u307e\u3059\u3002\n\u3053\u308c\u3067f x = 1 + f x\u3067\u306f\u691c\u51fa\u3067\u304d\u306a\u3044\u3053\u3068\u3084\u3001a = seq a 1\u3067\u306f\u691c\u51fa\u3055\u308c\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3068\u304a\u3082\u3044\u307e\u305915\u3002\n\u9577\u304b\u3063\u305f\u30fb\u30fb\u30fb\n\n\u611f\u60f3\nHaskell AdC\u306a\u306e\u306bHaskell\u30b3\u30fc\u30c9\u306f\u304a\u308d\u304b\u578b\u306e\u8a7116\u3059\u3089\u66f8\u3044\u3066\u306a\u3044\u306e\u3067\u66f8\u3044\u3066\u3066\u7533\u3057\u8a33\u306a\u3044\u611f\u3058\u3067\u3057\u305f\u304c\u3001\u3042\u307e\u308a\u8868\u306b\u51fa\u3066\u3053\u306a\u3044\u5185\u90e8\u6a5f\u69cb\u306b\u3064\u3044\u3066\u3061\u3087\u3063\u3068\u7d30\u304b\u304f\u304b\u3051\u305f\u304b\u306a\u30fc\u3068\u601d\u3044\u307e\u3059\u3002\n\u3053\u306eSTG\u6a5f\u68b0\u306f\u52ff\u8ad6\u95a2\u6570\u578b\u8a00\u8a9e\u306e\u5b9f\u88c5\u306b\u53c2\u8003\u306b\u306a\u308b\u70b9\u304c\u591a\u3044\u3068\u304a\u3082\u3044\u307e\u3059\u304c\u3001\u666e\u901a\u306b\u8aad\u3093\u3067\u3044\u3066\u3082\u697d\u3057\u3044\u3057Haskell\u306e\u5185\u90e8\u306b\u8a73\u3057\u304f\u306a\u3063\u305f\u6c17\u306b\u306a\u308c\u308b\u306e\u3067\u6687\u304c\u3042\u308c\u3070\u8997\u3044\u3066\u307f\u308b\u3068\u826f\u3044\u3068\u304a\u3082\u3044\u307e\u3059(\u305d\u306e\u306a\u304b\u3067Black hole\u304c\u304a\u3082\u3057\u308d\u304b\u3063\u305f\u306e\u3067\u3053\u306e\u8a18\u4e8b\u3092\u66f8\u3044\u305f)\u3002\n\u5c1a\u4eca\u56de\u306fJS\u3067\u5b9f\u88c5\u3057\u307e\u3057\u305f\u304c\u3001\u3067\u304d\u308b\u3060\u3051\u30af\u30ed\u30fc\u30b8\u30e3\u3092\u4f7f\u308f\u306a\u3044\u3088\u3046\u306b\u3057\u3066\u3044\u308b\u306e\u3067C\u8a00\u8a9e\u306a\u3069\u306b\u843d\u3068\u3059\u306e\u3082\u305d\u3093\u306a\u306b\u96e3\u3057\u304f\u306a\u3044\u306f\u305a\u3067\u3059(env\u306f\u3053\u306e\u307e\u307e\u3060\u3068\u56f0\u308a\u305d\u3046)(\u5143\u8ad6\u6587\u306b\u306f\u3053\u306e\u5148\u306e\u30a2\u30bb\u30f3\u30d6\u30ea\u30ec\u30d9\u30eb\u306e\u8a71\u3082\u8f09\u3063\u3066\u3044\u307e\u3059\u306e\u3067\u305d\u3061\u3089\u3092\u53c2\u7167)\u3002\u3044\u3064\u304bGHC\u306e\u5410\u304f\u30d0\u30a4\u30ca\u30ea\u3092\u8aad\u3081\u308b\u3088\u3046\u306b\u306a\u3063\u3066\u307f\u305f\u3044\u3067\u3059\u306d\u3002\n\u304a\u308f\u308a\u3067\u3059\u3002\u660e\u65e5\u306f@todays-mitsui\u3055\u3093\u306e\u8a18\u4e8b\u3067\u3059\u3002\n\n\n\n\n\nGC\u304c\u3042\u308a\u3001\u578b\u304c\u7121\u304f\u3001\u5024\u306e\u66f4\u65b0\u304c\u3067\u304d\u308b\u3068\u3044\u3046\u305d\u3053\u305d\u3053\u5b9f\u969b\u306e\u8a55\u4fa1\u74b0\u5883\u306b\u8fd1\u3044\u8a00\u8a9e\u306a\u306e\u3067 (\u3042\u3068\u500b\u4eba\u7684\u306a\u8da3\u5473)\u00a0\u21a9\n\n\nSTG\u8a00\u8a9e\u306e\u4e2d\u3067\u306f\u3002Haskell\u3067\u3082\u5168\u3066\u306e\u57fa\u672c\u7684\u306a\u8a55\u4fa1\u306fcase\u5f0f\u306b\u7f6e\u304d\u63db\u3048\u3089\u308c\u307e\u3059\u3051\u3069\u3002\u00a0\u21a9\n\n\n\u3068\u8003\u3048\u308b\u3068IO Monad\u306e\u4e2d\u3067\u306f\u3044\u304f\u3089\u3067\u3082\u81ea\u7531\u306a\u3053\u3068\u304c\u3067\u304d\u308b\u3001\u3068\u3044\u3046\u306e\u306f\u307e\u3041\u81ea\u660e\u306a\u3093\u3067\u3059\u306d\u3002\u4e0d\u601d\u8b70\u3055\u304c\u3061\u3087\u3063\u3068\u6e1b\u3063\u305f\u3067\u3057\u3087\u3046\u304b\u3002\u00a0\u21a9\n\n\nSTG\u8a00\u8a9e\u3067\u306f\u300c\u30af\u30ed\u30fc\u30b8\u30e3\u3092\u76f4\u63a5\u8fd4\u3059\u300d\u3053\u3068\u306f\u3067\u304d\u305a\u3001\u5fc5\u305a\u9069\u7528\u6f14\u7b97\u304c\u631f\u307e\u308b\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002\u4eca\u56de\u306f0\u5f15\u6570\u3068\u3044\u3046\u3053\u3068\u3067\u3059\u3002\u00a0\u21a9\n\n\n\u3053\u306e\u6319\u52d5\u3092\u898b\u308b\u3068\u308f\u304b\u308b\u3068\u304a\u3082\u3044\u307e\u3059\u304c\u3001\u3053\u306e\u8a55\u4fa1\u5668\u306f\u5168\u3066\u3092\u672b\u5c3e\u547c\u3073\u51fa\u3057\u30fb\u7d99\u7d9a\u6e21\u3057\u30b9\u30bf\u30a4\u30eb\u3067\u5b9f\u884c\u3057\u3066\u3044\u307e\u3059\u3002\u30a2\u30bb\u30f3\u30d6\u30ea\u306b\u3082\u843d\u3068\u3057\u3084\u3059\u305d\u3046\u3002\u00a0\u21a9\n\n\n\u3068\u3053\u308d\u3067STG\u8ad6\u6587\u306e\u65b9\u306f\u7d20\u76f4\u306bcase xs of\u3068\u304b\u66f8\u3044\u3066\u3044\u305f\u3093\u3067\u3059\u3051\u3069\u69cb\u6587\u7684\u306b\u30c0\u30e1\u3058\u3083\u306a\u3044\u3067\u3059\u304b\u306d\u30fb\u30fb\u30fb\uff1f(case xs {} of\uff1f)\u00a0\u21a9\n\n\n\u3053\u3053\u3067\u306f\u3055\u3089\u3063\u3068env\u306b\u751f\u5024\u3092\u7a81\u3063\u8fbc\u3093\u3067\u3044\u307e\u3059\u304c\u3001\u5b9f\u969b\u306b\u306f\u3053\u308c\u304c\u751f\u5024\u306a\u306e\u304b\u30af\u30ed\u30fc\u30b8\u30e3\u306a\u306e\u304b\u306e\u533a\u5225\u3092\u793a\u3059\u30bf\u30b0\u3092\u3044\u308c\u308b\u3088\u3046\u3067\u3059\u00a0\u21a9\n\n\n\u3068\u8a00\u3063\u3066\u3082\u666e\u901a\u306b\u51fa\u529b\u3057\u305f\u3089\u8b0e\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3057\u304b\u5410\u3044\u3066\u304f\u308c\u306a\u3044\u306e\u3067\u81ea\u5206\u3067\u4e2d\u8eab\u3092\u60f3\u50cf\u3057\u3066\u66f8\u3044\u3066\u308b\u3093\u3067\u3059\u3051\u3069\u30fb\u30fb\u30fb\u00a0\u21a9\n\n\nfunction(x,env){}\u306e\u4e2d\u3067console.log\u3068\u304b\u3059\u308c\u3070\u308f\u304b\u308b\u3068\u304a\u3082\u3044\u307e\u3059\u00a0\u21a9\n\n\nSTG\u8a00\u8a9e\u3067\u306f\u30af\u30ed\u30fc\u30b8\u30e3\u306e\u8868\u8a18\u306b\\u(updatable)\u3068\\n(not updatable)\u3092\u7528\u610f\u3057\u3066\u3044\u307e\u3059\u3002\u3069\u3063\u3061\u306b\u3059\u308b\u3079\u304d\u304b\u306e\u89e3\u6790\u306f\u7d50\u69cb\u5927\u5909\u3089\u3057\u3044\u3067\u3059\u306d\u3002\u00a0\u21a9\n\n\nJS\u306a\u306e\u3067\u76f4\u63a5u.target = repl;\u3057\u3066\u3082\u30c0\u30e1\u306a\u3093\u3067\u3059\u3088\u306d\u00a0\u21a9\n\n\nSTG\u8ad6\u6587\u5185\u306b\u66f8\u3044\u3066\u3042\u3063\u305fStandard Constructor\u304c\u3053\u306erepl\u306b\u306a\u308b\u3093\u3067\u3059\u304b\u306d\u3002\u6700\u5f8c\u306erefs\u3092\u5165\u308c\u66ff\u3048\u305f\u3089\u78ba\u304b\u306b\u4ed6\u306e\u30b3\u30f3\u30b9\u30c8\u30e9\u30af\u30bf\u306b\u3082\u4f7f\u3048\u305d\u3046\u3067\u3059\u3002\u00a0\u21a9\n\n\n\u3053\u308c\u304c\u3042\u308b\u304b\u3089\u95a2\u6570\u306e\u5834\u5408\u306b\u306f\u9069\u7528\u3067\u304d\u306a\u3044(\u51fa\u6765\u305f\u3089\u56f0\u308b)\u3002\u00a0\u21a9\n\n\n\u7121\u9650\u518d\u5e30\u306f\u7d50\u5c40\u5024\u306e\u610f\u5473\u3068\u3057\u3066\u306fundefined\u306a\u306e\u3067\u4f55\u3057\u3066\u3082\u826f\u3044\u307f\u305f\u3044\u306a\u3068\u3053\u308d\u304c\u3042\u308b\u00a0\u21a9\n\n\n\u5de6\u8fba\u306ef x\u3068\u53f3\u8fba\u306ef x\u306f\u9055\u3046\u30af\u30ed\u30fc\u30b8\u30e3\u3092\u6307\u3059\u304b\u3089\u3001\u307e\u305fa\u306e\u66f4\u65b0\u4e2d\u306ba\u3092\u8a55\u4fa1\u3059\u308b\u3053\u3068\u306b\u306a\u308b\u304b\u3089\u3002\u00a0\u21a9\n\n\n\u307e\u3041\u5b9f\u884c\u6642\u306e\u8a71\u3067\u578b\u306a\u3093\u3066\u51fa\u3057\u3066\u3082\u975e\u52b9\u7387\u7684\u3063\u3066\u611f\u3058\u3060\u3057\u610f\u5473\u308f\u304b\u3093\u306a\u3044\u3067\u3059\u3088\u306d\uff5e\uff5e\uff5e\uff5e\u00a0\u21a9\n\n\n\n\u3053\u3093\u306b\u3061\u306fphi16\u3067\u3059\u3002\u3053\u306e\u8a18\u4e8b\u306f[Haskell Advent Calendar 2016](http://qiita.com/advent-calendar/2016/haskell) \u306e8\u65e5\u76ee\u306e\u8a18\u4e8b\u3067\u3059\u3002\n\nHaskell(GHC)\u3067\u8272\u3005\u30d7\u30ed\u30b0\u30e9\u30e0\u3092\u66f8\u3044\u3066\u3044\u308b\u3068\u3001\u305f\u307e\u306b\u30d0\u30b0\u3063\u3066\u6b21\u306e\u3088\u3046\u306a\u30a8\u30e9\u30fc\u3092\u898b\u308b\u3053\u3068\u304c\u3042\u308b\u3068\u304a\u3082\u3044\u307e\u3059\u3002\n\n```\nmain: <<loop>>\n```\n\u3053\u308c\u306fGHC\u304c\u5f0f\u3092\u8a55\u4fa1\u3057\u3066\u3044\u305f\u3089\u7121\u9650\u30eb\u30fc\u30d7\u3092\u767a\u751f\u3055\u305b\u3066\u3057\u307e\u3046\u3053\u3068\u3092\u691c\u51fa\u3057\u3066\u6295\u3052\u308b\u4f8b\u5916\u306a\u306e\u3067\u3059\u304c\u3001\u52ff\u8ad6\u5168\u3066\u306e\u7121\u9650\u30eb\u30fc\u30d7\u3092\u691c\u51fa\u3059\u308b\u3053\u3068\u306f\u3067\u304d\u307e\u305b\u3093\u3002\n\u307e\u305fHaskell\u3067\u306f\u6b21\u306e\u3088\u3046\u306a\u300c\u7121\u9650\u30eb\u30fc\u30d7\u300d\u306f\"\u5408\u6cd5\"\u3067\u3059 :\n\n```haskell\na = 1 : a\n```\n\n\u3068\u3044\u3046\u308f\u3051\u3067\u3001\u3069\u3093\u306a\u7121\u9650\u30eb\u30fc\u30d7\u306a\u3089\u300c\u5408\u6cd5\u306a\u306e\u304b\u300d\u300c\u691c\u51fa\u3067\u304d\u308b\u306e\u304b\u300d\u3001\u307e\u305f\u300c\u3069\u3046\u3044\u3046\u6a5f\u69cb\u3067\u3053\u308c\u3092\u5b9f\u73fe\u3057\u3066\u3044\u308b\u306e\u304b\u300d\u3068\u3044\u3046\u8a71\u3092\u3001GHC\u306e\u5b9f\u969b\u306e\u8a55\u4fa1\u6a5f\u69cb\u3092**JavaScript\u3067[^js]**\u4f5c\u308a\u306a\u304c\u3089\u9069\u5f53\u306b\u307e\u3068\u3081\u3066\u307f\u3088\u3046\u3068\u304a\u3082\u3044\u307e\u3059\u3002\u534a\u5206\u304f\u3089\u3044\u306f\u81ea\u5206\u7528\u30e1\u30e2\u304b\u3082\u3057\u308c\u306a\u3044\u3067\u3059\u3002\n\u60c5\u5831\u6e90\u3068\u3057\u3066\u306f[STG\u8ad6\u6587](https://www.microsoft.com/en-us/research/publication/implementing-lazy-functional-languages-on-stock-hardware-the-spineless-tagless-g-machine/)\u304c\u4e3b\u3067\u3001\u305d\u308c\u3092\u66f4\u306b\u5358\u7d14\u5316\u3057\u305f\u30e2\u30c7\u30eb\u3092\u8003\u3048\u3066\u3044\u308b\u305f\u3081\u73fe\u884c\u306eGHC\u3068\u306f\u304b\u306a\u308a\u7570\u306a\u308b\u51e6\u7406\u3092\u3057\u3066\u3044\u307e\u3059\u3002\u3054\u4e86\u627f\u304f\u3060\u3055\u3044\u3002\n\n[^js]: GC\u304c\u3042\u308a\u3001\u578b\u304c\u7121\u304f\u3001\u5024\u306e\u66f4\u65b0\u304c\u3067\u304d\u308b\u3068\u3044\u3046\u305d\u3053\u305d\u3053\u5b9f\u969b\u306e\u8a55\u4fa1\u74b0\u5883\u306b\u8fd1\u3044\u8a00\u8a9e\u306a\u306e\u3067 (\u3042\u3068\u500b\u4eba\u7684\u306a\u8da3\u5473)\n\n\u3053\u308c\u3092\u8aad\u3080\u3053\u3068\u3067Haskell\u30b3\u30fc\u30c9\u304b\u3089CPU\u306e\u6b53\u58f0\u304c\u805e\u3053\u3048\u308b\u3088\u3046\u306b\u306a\u308b\u3068\u3044\u3044\u306a\u3068\u304a\u3082\u3044\u307e\u3059\u3002\n\n# \u5024\u306e\u8868\u73fe\nHaskell\u306f\u9045\u5ef6\u8a55\u4fa1\u3092\u884c\u3046\u305f\u3081\u3001\u300c\u5024\u300d\u305d\u306e\u3082\u306e\u306e\u8868\u73fe\u304c\u81ea\u660e\u306a\u5f62\u3067\u306f\u5b9a\u307e\u308a\u307e\u305b\u3093\u3002\u9045\u5ef6\u8a55\u4fa1\u3068\u3044\u3046\u306e\u306f\u300c\u5b9f\u884c(\u8a55\u4fa1)\u3059\u308b\u3053\u3068\u3067\u5024\u304c\u521d\u3081\u3066\u5f97\u3089\u308c\u308b\u3088\u3046\u306a\u4ed5\u7d44\u307f\u300d\u306a\u306e\u3067\u3001\u3053\u308c\u304c\u8868\u73fe\u3067\u304d\u308c\u3070\u826f\u3055\u305d\u3046\u3067\u3059\u3002\n\u4eca\u56de\u8003\u3048\u308b\u51e6\u7406\u7cfb\u3067\u306f\u3001\u5024\u4e00\u822c\u306e\u3053\u3068\u3092\u300c\u5b9f\u884c\u30b3\u30fc\u30c9`code`\u3092\u30e1\u30f3\u30d0\u306b\u6301\u3064\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u300d\u3068\u307f\u306a\u3059\u3053\u3068\u306b\u3057\u307e\u3057\u3087\u3046\u3002\u5168\u3066\u306e\u57fa\u790e\u3068\u306a\u308b\u8a55\u4fa1\u95a2\u6570\u306f\u6b21\u306e\u3088\u3046\u306b\u5b9f\u88c5\u3055\u308c\u307e\u3059 :\n\n```javascript\nfunction Eval(x,env){\n  x.code(x,env);\n};\n```\n\n\u3053\u306e\u3088\u3046\u306b\u5b9f\u884c\u95a2\u6570`x.code`\u306b\u306f\u305d\u306e\u5024\u81ea\u8eab`x`\u3068\u74b0\u5883`env`\u304c\u6e21\u3055\u308c\u3066\u304d\u307e\u3059\u3002\u3053\u306e\u3088\u3046\u306a\u51e6\u7406\u3092\u60f3\u5b9a\u3057\u305f\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u306e\u3053\u3068\u3092\u300c\u30af\u30ed\u30fc\u30b8\u30e3\u300d\u3068\u547c\u3076\u3053\u3068\u306b\u3057\u307e\u3059\u3002\n\n\u305d\u306e\u540d\u306e\u901a\u308a\u3068\u3044\u3048\u3070\u4f55\u3067\u3059\u304c\u3001\u5b9f\u969b\u3053\u308c\u306f\u30af\u30ed\u30fc\u30b8\u30e3\u3092\u8868\u73fe\u3057\u3066\u304f\u308c\u307e\u3059\u3002\u95a2\u6570\u306b\u5fc5\u8981\u306a\u306e\u306f\u300c\u5f15\u6570\u540d\u300d\u300c\u95a2\u6570\u672c\u4f53\u300d\u3068\u8a00\u3063\u305f\u3068\u3053\u308d\u3067\u3059\u304c\u3001\u305d\u308c\u306b\u52a0\u3048\u3066\u300c\u81ea\u7531\u5909\u6570\u540d\u300d\u300c\u81ea\u7531\u5909\u6570\u306e\u53c2\u7167\u5148\u300d\u3082\u7ba1\u7406\u3059\u308b\u3053\u3068\u306b\u306a\u308a\u307e\u3059\u3002\n\n```javascript\nvar Closure = function(free,args,code,ref){ // ([String],[String],(X,Env) \u2192 (),[Closure])\n  return {free:free,args:args,code:code,ref:ref};\n};\n```\n\n\u5f15\u6570\u306a\u3069\u306f\u95a2\u6570\u9069\u7528\u306e\u3068\u304d\u306b`args`\u306b\u5bfe\u5fdc\u3059\u308b\u540d\u524d\u3067\u74b0\u5883`env`\u306b\u81ea\u52d5\u3067\u767b\u9332\u3055\u308c\u308b\u3082\u306e\u3068\u3057\u307e\u3057\u3087\u3046\u3002\u3068\u3059\u308b\u3068\u4f8b\u3048\u3070`const`\u95a2\u6570\u306f\u6b21\u306e\u3088\u3046\u306b\u5b9f\u88c5\u3067\u304d\u305d\u3046\u3067\u3059 :\n\n```javascript\n// this doesn't work\nvar Const = Closure([],[\"x\"],function(x,env){\n  return Closure([\"x\"],[\"y\"],function(x,env){\n    return env[\"x\"];\n  },[env[\"x\"]]);\n},[]);\n```\n\n\u5f8c\u3067\u6b63\u3057\u304f\u66f8\u304d\u76f4\u3059\u3053\u3068\u306b\u306a\u308a\u307e\u3059\u304c\u3001\u96f0\u56f2\u6c17\u306f\u4f1d\u308f\u308b\u3067\u3057\u3087\u3046\u304b\u3002Haskell\u3067\u66f8\u3044\u305f`const`\u95a2\u6570 : `\\x \u2192 \\y \u2192 x`\u306b\u306f\u81ea\u7531\u5909\u6570\u306e\u60c5\u5831\u306f\u542b\u307e\u308c\u3066\u3044\u307e\u305b\u3093\u304c\u3001\u69cb\u6587\u89e3\u6790\u306e\u6bb5\u968e\u3067\u3082\u305d\u306e\u60c5\u5831\u3092\u52a0\u3048\u308b\u3053\u3068\u306f\u3067\u304d\u308b\u3067\u3057\u3087\u3046\u3002\u4eca\u56de\u306f\u81ea\u5206\u3067\u660e\u793a\u3057\u3066\u3044\u304f\u3053\u3068\u306b\u306a\u308a\u307e\u3059\u3002\n\u306a\u304a\u30af\u30ed\u30fc\u30b8\u30e3\u306e\u4e00\u7a2e(\u5f15\u6570\u304c\u7121\u3044\u3082\u306e)\u3068\u3057\u3066\u30b5\u30f3\u30af(\u672a\u8a55\u4fa1\u306e\u5024)\u3068\u3044\u3046\u6982\u5ff5\u304c\u3042\u308a\u307e\u3059\u3002\u3053\u308c\u3053\u305d\u304c\u9045\u5ef6\u8a55\u4fa1\u306e\u7279\u5fb4\u3068\u306a\u3063\u3066\u304a\u308a\u3001\u5f8c\u3067\u7d30\u304b\u304f\u307f\u308b\u3053\u3068\u306b\u306a\u308a\u307e\u3059\u3002\n\nHaskell\u306e\u5024\u3068\u3044\u3048\u3070\u30c7\u30fc\u30bf\u30b3\u30f3\u30b9\u30c8\u30e9\u30af\u30bf\u304c\u3042\u308a\u307e\u3059\u304c\u3001\u3053\u308c\u3082\u4e00\u7a2e\u306e\u30af\u30ed\u30fc\u30b8\u30e3\u3068\u3057\u3066\u69cb\u6210\u3057\u307e\u3059\u3002`List a = Nil | Cons a (List a)`\u3068\u3057\u305f\u6642\u3001`Nil`\u3068`Cons`\u306f\u6b21\u306e\u3088\u3046\u306b\u8868\u73fe\u3055\u308c\u307e\u3059 :\n\n```javascript\nvar Nil = Closure([],[],function(x,env){\n  ReturnCon(0)();\n},[]);\nvar Cons = Closure([],[\"x\",\"y\"],function(x,env){\n  ReturnCon(1)(env[\"x\"],env[\"y\"]);\n},[]);\n```\n\n\u5b9f\u306f\u30c7\u30fc\u30bf\u30b3\u30f3\u30b9\u30c8\u30e9\u30af\u30bf\u3092\u8a55\u4fa1\u3059\u308b\u306e\u306fcase\u5f0f\u306e\u4e2d\u3060\u3051\u3060\u3068\u6c7a\u307e\u3063\u3066\u3044\u308b\u306e\u3067[^stg]\u3001Nil/Cons\u3092\u5b9f\u884c\u3059\u308b\u3053\u3068\u306b\u306a\u308b\u3068\u304d\u306f\u3053\u306e\u30b3\u30fc\u30c9\u306f\u5fc5\u305a\u30d1\u30bf\u30fc\u30f3\u30de\u30c3\u30c1\u306b\u4f7f\u308f\u308c\u308b\u306f\u305a\u3067\u3059\u3002`ReturnCon(n)`\u3067\u300c`n`\u756a\u76ee\u306e\u30b3\u30f3\u30b9\u30c8\u30e9\u30af\u30bf\u306e\u30de\u30c3\u30c1\u30f3\u30b0\u306b\u5bfe\u5fdc\u3059\u308b\u7d99\u7d9a\u3092\u62fe\u3063\u3066\u304f\u308b\u300d\u3068\u3044\u3046\u3053\u3068\u304c\u3067\u304d\u3001\u5b9f\u969b\u306b\u30c7\u30fc\u30bf\u30b3\u30f3\u30b9\u30c8\u30e9\u30af\u30bf\u306b\u5bfe\u5fdc\u3059\u308b\u5206\u5c90\u304c\u5b9f\u884c\u3055\u308c\u308b\u3053\u3068\u3068\u306a\u308a\u307e\u3059\u3002\u30bf\u30b0\u4ed8\u3051\u3066\u5024\u3092\u8fd4\u3057\u3066\u5206\u5c90\u3092\u9078\u3076\u3088\u308a\u3082\u52b9\u7387\u7684\u306a\u308f\u3051\u3067\u3059\u3002\n\n[^stg]: STG\u8a00\u8a9e\u306e\u4e2d\u3067\u306f\u3002Haskell\u3067\u3082\u5168\u3066\u306e\u57fa\u672c\u7684\u306a\u8a55\u4fa1\u306fcase\u5f0f\u306b\u7f6e\u304d\u63db\u3048\u3089\u308c\u307e\u3059\u3051\u3069\u3002\n\n\u307e\u305f\u3001`Int`\u306a\u3069\u306e\u751f\u5024\u3092\u3053\u306e\u5b9f\u884c\u5f62\u5f0f\u3067\u306f\u305d\u306e\u307e\u307e\u6271\u3046\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\u6b63\u78ba\u306b\u306f\u5168\u3066\u306e\u751f\u5024\u3092\u5358\u4e00\u306e\u30c7\u30fc\u30bf\u30b3\u30f3\u30b9\u30c8\u30e9\u30af\u30bf\u3067\u5305\u3080\u3053\u3068\u3067\u9045\u5ef6\u8a55\u4fa1\u3092\u3057\u3064\u3064\u751f\u30ec\u30d9\u30eb\u306e\u51e6\u7406\u3092\u5b9f\u884c\u3067\u304d\u308b\u3068\u3044\u3046\u3082\u306e\u3067\u3059\u3002\n\n```javascript\nvar Raw = function(n){\n  var cl = Closure([],[],function(x,env){\n    ReturnRaw(x.value);\n  },[]);\n  cl.value = n;\n  return cl;\n};\n```\n\n\u4eca\u56de\u306f\u3053\u306e`Raw`\u95a2\u6570\u306b\u3088\u3063\u3066\u751f\u5024\u3092\u5305\u307f\u3001\u305d\u306e\u5024\u3078\u306ecase\u5f0f\u304c\u767a\u751f\u3057\u305f\u3068\u304d\u306b`ReturnRaw`\u95a2\u6570\u306b\u751f\u5024\u3092\u6e21\u3057\u3066\u3042\u3052\u308b\u3001\u3068\u3044\u3046\u3053\u3068\u306b\u3057\u307e\u3059\u3002`ReturnRaw`\u306f`ReturnCon`\u3068\u5927\u5dee\u306a\u3044\u3067\u3059\u3002JavaScript\u306e\u4efb\u610f\u306e\u5024\u306f`Raw`\u3067\u5305\u3080\u3053\u3068\u3067\u3053\u306e\u67a0\u7d44\u3067\u6271\u3048\u308b\u3088\u3046\u306b\u306a\u308b\u308f\u3051\u3067\u3059\u304c[^io]\u3001\u3068\u308a\u3042\u3048\u305a\u306f\u6574\u6570\u5024\u3092\u5165\u308c\u308b\u3053\u3068\u3092\u8003\u3048\u3066\u3044\u307e\u3059\u3002\n\n[^io]: \u3068\u8003\u3048\u308b\u3068IO Monad\u306e\u4e2d\u3067\u306f\u3044\u304f\u3089\u3067\u3082\u81ea\u7531\u306a\u3053\u3068\u304c\u3067\u304d\u308b\u3001\u3068\u3044\u3046\u306e\u306f\u307e\u3041\u81ea\u660e\u306a\u3093\u3067\u3059\u306d\u3002\u4e0d\u601d\u8b70\u3055\u304c\u3061\u3087\u3063\u3068\u6e1b\u3063\u305f\u3067\u3057\u3087\u3046\u304b\u3002\n\n\n\u30fb\u30fb\u30fb\u3068\u307e\u3041\u3001\u3060\u3044\u3076\u4e00\u822c\u7684\u306a\u8a00\u8a9e\u51e6\u7406\u7cfb\u3068\u306f\u7570\u306a\u308b\u5024\u306e\u6271\u3044\u30fb\u51e6\u7406\u3092\u3057\u3066\u3044\u308b\u3088\u3046\u3067\u3059\u3002\u5024\u306b\u610f\u5473\u304c\u4ed8\u968f\u3059\u308b\u3068\u3044\u3046\u306e\u304c\u3061\u3087\u3063\u3068\u304a\u3082\u3057\u308d\u3044\u70b9\u3067\u3057\u3087\u3046\u304b\uff1fcase\u306e\u30de\u30c3\u30c1\u30f3\u30b0\u306e\u4ed5\u7d44\u307f\u304c\u306a\u3093\u3068\u3082\u5408\u7406\u7684\u306a\u611f\u3058\u3067\u500b\u4eba\u7684\u306b\u597d\u304d\u3067\u3059\u3002\n\u672a\u3060\u306b\u300c\u52d5\u4f5c\u300d\u306f\u3055\u305b\u3066\u3044\u306a\u3044\u306e\u3067\u5206\u304b\u3089\u306a\u3044\u70b9\u306f\u591a\u3044\u3068\u601d\u3044\u307e\u3059\u3002\u5b9f\u969b\u306e\u52d5\u4f5c\u4f8b\u3092\u898b\u308b\u3053\u3068\u3067\u7406\u89e3\u3067\u304d\u308b\u3053\u3068\u3082\u3042\u308b\u3068\u304a\u3082\u3046\u306e\u3067\u3068\u308a\u3042\u3048\u305a\u8aad\u3093\u3067\u3044\u304f\u3068\u826f\u3044\u6c17\u304c\u3057\u307e\u3059\u3002\n\n# \u95a2\u6570\u9069\u7528\n\u9045\u5ef6\u8a55\u4fa1\u3067\u306a\u3051\u308c\u3070\u300c\u5f15\u6570\u3092\u8a55\u4fa1\u3057\u300d\u300c\u305d\u308c\u3092\u95a2\u6570\u306b\u6e21\u3059\u300d\u306e\u304c\u57fa\u672c\u3067\u3059\u304c\u3001\u4eca\u56de\u306f\u300c\u5f15\u6570\u306e\u30af\u30ed\u30fc\u30b8\u30e3\u3092\u81ea\u7531\u5909\u6570\u306b\u7d50\u3073\u3064\u3051\u300d\u300c\u95a2\u6570\u3092\u5b9f\u884c\u3059\u308b\u300d\u3068\u3044\u3046\u6d41\u308c\u306b\u306a\u308a\u307e\u3059\u3002\u3053\u306e\u8a55\u4fa1\u6a5f\u69cb\u306f\u8907\u6570\u5f15\u6570\u3092\u540c\u6642\u306b\u9069\u7528\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u308b\u306e\u3067\u3059\u304c\u3001\u904e\u5270\u5f15\u6570(`const id 1 2`\u306a\u3069)\u3092\u9069\u5207\u306b\u6271\u3046\u305f\u3081\u306b\u4e00\u5ea6\u300c\u5f15\u6570\u30b9\u30bf\u30c3\u30af`args`\u300d\u306b\u9000\u907f\u3057\u3066\u304b\u3089`env`\u306b\u66f8\u304d\u8fbc\u307f\u3092\u3059\u308b\u3053\u3068\u306b\u306a\u308a\u307e\u3059\u3002\n\n```javascript\nvar args = [];\nfunction exec(code,def){\n  def.code = code;\n  return def;\n}\nfunction retrive(env,x){\n  if(typeof env[x] === \"undefined\")return x;\n  else return env[x];\n}\nvar Apply = function(x,env){\n  for(var i=x.arg.length-1;i>-1;i--){\n    args.push(retrive(env,x.arg[i]));\n  }\n  Enter(x.func);\n};\nfunction app(f,xs){\n  return exec(Apply,{func:f,arg:xs});\n}\n```\n\n\u5148\u306b\u8a00\u3063\u305f\u3088\u3046\u306b\u3001\u57fa\u672c\u7684\u306b\u5024\u306f\u300c\u610f\u5473\u3092\u8868\u3059\u30b3\u30fc\u30c9\u300d\u3068\u300c\u30c7\u30fc\u30bf\u3092\u8868\u3059\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u81ea\u8eab\u300d\u3067\u8868\u73fe\u3057\u307e\u3059\u3002`exec`\u95a2\u6570\u306f\u305d\u308c\u3089\u3092\u5408\u6210\u3057\u3066\u5024\u3092\u69cb\u6210\u3059\u308b\u4fbf\u5229\u95a2\u6570\u3067\u3059\u3002\u307e\u305f`app`\u306f`Apply`\u3092\u30b3\u30fc\u30c9\u3068\u3057\u3066\u6301\u3064\u3088\u3046\u306a\u5024\u3092\u4f5c\u308b\u305f\u3081\u306e\u4fbf\u5229\u95a2\u6570\u3067\u3059\u3002\n\n`Apply`\u3092\u5b9f\u884c\u3059\u308b(\u3064\u307e\u308a\u95a2\u6570\u9069\u7528\u3092`Eval`\u3059\u308b)\u3068\u304d\u3001\u305d\u306e\u5f15\u6570\u3092\u30b9\u30bf\u30c3\u30af\u306b\u7a4d\u3093\u3067`Enter`\u306b\u3088\u3063\u3066\u300c\u95a2\u6570\u3092\u5b9f\u884c\u300d\u3057\u307e\u3059\u3002\n\n`Enter`\u3055\u308c\u305f\u95a2\u6570\u306f\u81ea\u7531\u5909\u6570\u3068\u5f15\u6570\u306e\u60c5\u5831\u3092\u62fe\u3044\u96c6\u3081\u3001\u95a2\u6570\u672c\u4f53\u3092\u8a55\u4fa1\u3057\u306b\u3044\u304d\u307e\u3059 :\n\n```javascript\nfunction Enter(f){\n  var env = {};\n  for(var i=0;i<f.free.length;i++){\n    env[f.free[i]] = f.ref[i];\n  }\n  f.args.forEach(function(name){\n    env[name] = args.pop();\n  });\n  Eval(f,env);\n}\n```\n\n\u3053\u308c\u3067\u5148\u7a0b\u66f8\u3044\u305f\u300c\u81ea\u52d5\u3067`env`\u306b\u767b\u9332\u3059\u308b\u300d\u3092\u9054\u6210\u3057\u307e\u3059\u306d\u3002\u3055\u3066\u3001\u3053\u306eApply\u306b\u3088\u3063\u3066\u300c\u3061\u3083\u3093\u3068\u52d5\u304f\u300d`id`\u95a2\u6570\u3092\u4f5c\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059 :\n\n```javascript\nvar Id = Closure([],[\"x\"],function(x,env){\n  Eval(app(env[\"x\"],[]),env);\n},[]);\n```\n\n`env[\"x\"]`\u3092`Eval`\u3059\u308b\u306e\u3067\u306f\u306a\u304f`app(env[\"x\"],[])`\u3092`Eval`\u3057\u3066\u3044\u308b\u306e\u306f\u3061\u3083\u3093\u3068\u300c(\u30b5\u30f3\u30af\u3068\u3057\u3066\u306e)\u30af\u30ed\u30fc\u30b8\u30e3\u3092\u5b9f\u884c\u3059\u308b\u300d\u3068\u3044\u3046\u51e6\u7406(`Enter`)\u3092\u8d70\u3089\u305b\u308b\u305f\u3081\u3067\u3059[^enter]\u3002\n\n[^enter]: STG\u8a00\u8a9e\u3067\u306f\u300c\u30af\u30ed\u30fc\u30b8\u30e3\u3092\u76f4\u63a5\u8fd4\u3059\u300d\u3053\u3068\u306f\u3067\u304d\u305a\u3001\u5fc5\u305a\u9069\u7528\u6f14\u7b97\u304c\u631f\u307e\u308b\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002\u4eca\u56de\u306f0\u5f15\u6570\u3068\u3044\u3046\u3053\u3068\u3067\u3059\u3002\n\n\u3061\u306a\u307f\u306b`const`\u306f\u5f15\u6570\u3092\u3082\u3046\u4e00\u3064\u53d6\u308c\u3070\u3044\u3044\u3060\u3051\u3067\u3059\u306d\u3002\n\n```javascript\nvar Const = Closure([],[\"x\",\"y\"],function(x,env){\n  Eval(app(env[\"x\"],[]),env);\n},[]);\n```\n\n# \u30ea\u30bf\u30fc\u30f3\u30b9\u30bf\u30c3\u30af\n\u57fa\u790e\u306f\u5927\u4f53\u3067\u304d\u3042\u304c\u3063\u305f\u306e\u3067\u3001\u6b21\u306b\u751f\u5024\u3092\u30ea\u30bf\u30fc\u30f3\u3059\u308b\u90e8\u5206\u3092\u3064\u304f\u308a\u307e\u3059\u3002\n\n```javascript\nvar returns = [];\nfunction ReturnRaw(n){\n  var ret = returns.pop();\n  ret(ret.env)[0](n);\n};\nfunction evaluate(expr){\n  returns.push(function(env){return [function(n){\n    console.log(n);\n  }];});\n  Eval(expr,{});\n}\n```\n\u5f0f\u306e\u8a55\u4fa1\u306fcase\u5f0f\u3067\u306e\u307f\u767a\u751f\u3059\u308b\u3068\u8a00\u3044\u307e\u3057\u305f\u3002\u3053\u308c\u306fcase\u5f0f\u3067\u306e\u307f\u30ea\u30bf\u30fc\u30f3\u30b9\u30bf\u30c3\u30af\u306b\u7a4d\u3080\u51e6\u7406\u304c\u767a\u751f\u3059\u308b\u3068\u3044\u3046\u3053\u3068\u3067\u3059\u3002`ReturnRaw`\u95a2\u6570\u3067\u306f\u78ba\u304b\u306b\u305d\u306e\u30ea\u30bf\u30fc\u30f3\u5148\u3092\u53d6\u308a\u51fa\u3057\u3066\u5f15\u6570\u306b\u6e21\u3057\u3066\u5b9f\u884c\u3001\u3092\u884c\u3063\u3066\u3044\u307e\u3059\u306d\u3002\n\u307e\u305f\u3001`evaluate`\u95a2\u6570\u3067\u306f\u3068\u308a\u3042\u3048\u305a\u6700\u521d\u306b\u300c\u5024\u3092\u8868\u793a\u3059\u308b\u305f\u3081\u306e\u8b0e\u306e\u7d99\u7d9a\u300d\u3092\u7a4d\u3093\u3067\u304a\u304f\u3053\u3068\u3067\u8a55\u4fa1\u3092\u6a21\u5023\u3057\u3066\u3044\u307e\u3059\u3002\u5b9f\u969b`Eval`\u3057\u305f\u7d50\u679c\u306f\u81ea\u52d5\u7684\u306b\u30ea\u30bf\u30fc\u30f3\u30b9\u30bf\u30c3\u30af\u4e0a\u306e\u95a2\u6570\u3092\u547c\u3076\u306e\u3067\u3001\u3053\u308c\u3067`console.log(n);`\u306f\u5b9f\u884c\u3055\u308c\u308b\u306f\u305a\u3067\u3059[^cps]\u3002\n[^cps]: \u3053\u306e\u6319\u52d5\u3092\u898b\u308b\u3068\u308f\u304b\u308b\u3068\u304a\u3082\u3044\u307e\u3059\u304c\u3001\u3053\u306e\u8a55\u4fa1\u5668\u306f\u5168\u3066\u3092\u672b\u5c3e\u547c\u3073\u51fa\u3057\u30fb\u7d99\u7d9a\u6e21\u3057\u30b9\u30bf\u30a4\u30eb\u3067\u5b9f\u884c\u3057\u3066\u3044\u307e\u3059\u3002\u30a2\u30bb\u30f3\u30d6\u30ea\u306b\u3082\u843d\u3068\u3057\u3084\u3059\u305d\u3046\u3002\n\n\u3068\u3044\u3046\u308f\u3051\u3067\u3001\u65e9\u901f\u5b9f\u884c\u3057\u3066\u307f\u307e\u3057\u3087\u3046\u3002\u3068\u8a00\u3063\u3066\u3082`id`/`const`\u304f\u3089\u3044\u3057\u304b\u306a\u3044\u3067\u3059\u3051\u3069\u3002\n\n```javascript\nevaluate(app(Id,[Raw(1)])); // => 1\nevaluate(app(Const,[Raw(2),Raw(3)])); // => 2\nevaluate(app(Const,[Id,Raw(4),Raw(5)])); // => 5\n```\n\n\u3061\u306a\u307f\u306b\u3001\u3053\u3053\u3067\u95a2\u6570\u306e\u5f15\u6570\u3068\u3057\u3066\u6e21\u305b\u308b\u3082\u306e\u306f\u304b\u306a\u308a\u9650\u3089\u308c\u3066\u3044\u307e\u3059\u3002\u5143\u3005\u30af\u30ed\u30fc\u30b8\u30e3\u304f\u3089\u3044\u3057\u304b\u60f3\u5b9a\u3057\u3066\u3044\u306a\u3044\u306e\u3067\u3059\u3002\u3053\u308c\u3067\u306f\u95a2\u6570\u9069\u7528\u306e\u30cd\u30b9\u30c8\u3059\u3089\u3067\u304d\u306a\u3044\u306e\u3067\u3001\u3053\u308c\u3092\u56de\u907f\u3059\u308b\u305f\u3081\u306blet-in\u5f0f\u3092\u4f5c\u308b\u3053\u3068\u306b\u306a\u308a\u307e\u3059\u3002\n\n# let-in\u5f0f\u3001case\u5f0f\n\u3082\u3046\u8a55\u4fa1\u6a5f\u69cb\u81ea\u4f53\u306f\u6b86\u3069\u51fa\u6765\u3066\u3044\u308b\u306e\u3067\u8907\u96d1\u306a\u3053\u3068\u306f\u3042\u3093\u307e\u308a\u306a\u3044\u3067\u3059\u3002\n\n```javascript\nvar Let = function(x,env){\n  for(var i=0;i<x.defines.length;i+=2){\n    var name = x.defines[i];\n    var value = x.defines[i+1];\n    env[name] = value;\n  }\n  for(var i=0;i<x.defines.length;i+=2){\n    var name = x.defines[i];\n    env[name].ref = [];\n    env[name].free.forEach(function(n){\n      env[name].ref.push(env[n]);\n    });\n  }\n  Eval(x.expr,env);\n};\nfunction letIn(xs,e){ // ([String,Closure],Closure)\n  return exec(Let,{defines:xs,expr:e});\n}\n```\n\n`letIn`\u306b\u3064\u3044\u3066\u306f\u7d30\u304b\u304f\u89e3\u8aac\u3057\u307e\u305b\u3093\u3002\n\n```javascript\nfunction ReturnCon(n){\n  var ret = returns.pop();\n  return ret(ret.env)[n];\n};\nvar Case = function(x,env){\n  x.cases.env = env;\n  returns.push(x.cases);\n  Eval(x.expr,env);\n};\nfunction caseOf(expr,cases){ // (Closure,Env -> [Argument -> Closure])\n  return exec(Case,{expr:expr,cases:cases});\n};\n```\n\n`ReturnCon`\u3067\u306f`ReturnRaw`\u3068\u540c\u69d8\u306b\u9069\u5207\u306a\u7d99\u7d9a(\u4eca\u56de\u306f`n`\u756a\u76ee\u306e\u30b3\u30f3\u30b9\u30c8\u30e9\u30af\u30bf\u306b\u5bfe\u5fdc\u3059\u308b\u7d99\u7d9a)\u3092\u62fe\u3063\u3066\u304d\u307e\u3059\u3002`Case`\u306f\u30ea\u30bf\u30fc\u30f3\u30b9\u30bf\u30c3\u30af\u306b\u7a4d\u3080\u3060\u3051\u3067\u3059\u306d[^bug]\u3002\n[^bug]: \u3068\u3053\u308d\u3067STG\u8ad6\u6587\u306e\u65b9\u306f\u7d20\u76f4\u306b`case xs of`\u3068\u304b\u66f8\u3044\u3066\u3044\u305f\u3093\u3067\u3059\u3051\u3069\u69cb\u6587\u7684\u306b\u30c0\u30e1\u3058\u3083\u306a\u3044\u3067\u3059\u304b\u306d\u30fb\u30fb\u30fb\uff1f(`case xs {} of`\uff1f)\n\n# \u3044\u308d\u3044\u308d\u5b9f\u884c\u3057\u3066\u307f\u3088\u3046\n\ncase\u5f0f\u304c\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u3063\u305f\u304a\u304b\u3052\u3067\u3060\u3044\u3076\u5e45\u304c\u5e83\u307e\u308a\u307e\u3057\u305f\u3002\u7279\u306b`Raw`\u306e\u4e2d\u8eab\u3092\u53d6\u308a\u51fa\u3059\u3053\u3068\u304c\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3057\u305f\u3002\u3068\u3044\u3046\u3053\u3068\u3067 :\n\n```javascript\nvar Add = Closure([],[\"x\",\"y\"],function(x,env){\n  Eval(caseOf(app(env[\"x\"],[]),function(env){return [function(x){\n    env[\"#x\"] = x;\n    Eval(caseOf(app(env[\"y\"],[]),function(env){return [function(y){\n      env[\"#y\"] = y;\n      Eval(Raw(env[\"#x\"] + env[\"#y\"]),env);\n    }];}),env);\n  }];}),env);\n},[]);\nevaluate(app(Add,[Raw(6),Raw(7)])); // => 13\n```\n\n\u751f\u5024\u306e\u52a0\u7b97\u304c\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3057\u305f[^real]\uff01\n[^real]: \u3053\u3053\u3067\u306f\u3055\u3089\u3063\u3068`env`\u306b\u751f\u5024\u3092\u7a81\u3063\u8fbc\u3093\u3067\u3044\u307e\u3059\u304c\u3001\u5b9f\u969b\u306b\u306f\u3053\u308c\u304c\u751f\u5024\u306a\u306e\u304b\u30af\u30ed\u30fc\u30b8\u30e3\u306a\u306e\u304b\u306e\u533a\u5225\u3092\u793a\u3059\u30bf\u30b0\u3092\u3044\u308c\u308b\u3088\u3046\u3067\u3059\n\n\u3064\u3044\u3067\u306b\u8abf\u5b50\u306b\u4e57\u3063\u3066\u307f\u307e\u3059\u3002\n\n```javascript\nvar Length = Closure([],[\"xs\"],function(x,env){\n  Eval(caseOf(app(env[\"xs\"],[]),function(env){return [function(){\n    Eval(Raw(0),env);\n  },function(a,as){\n    Eval(letIn([\n      \"n\",Closure([],[],function(x,env){Eval(app(Length,[as]),env);},[])\n    ],Closure([\"n\"],[],function(x,env){Eval(app(Add,[Raw(1),env[\"n\"]]),env)},[])),env);\n  }]}),env);\n},[]);\nevaluate(letIn([\n  \"a\",Closure([],[],function(x,env){Eval(app(Nil,[]),env);},[]),\n  \"b\",Closure([\"a\"],[],function(x,env){Eval(app(Cons,[Raw(10),env[\"a\"]]),env);},[]),\n  \"c\",Closure([\"b\"],[],function(x,env){Eval(app(Cons,[Raw(9),env[\"b\"]]),env);},[]),\n  \"d\",Closure([\"c\"],[],function(x,env){Eval(app(Cons,[Raw(8),env[\"c\"]]),env);},[])\n],Closure([\"d\"],[],function(x,env){Eval(app(Length,[env[\"d\"]]),env);},[]))); // => 3\n```\n\n\u8aad\u307f\u306b\u304f\u3044\u3067\u3059\u3051\u3069`let {a = Nil; b = Cons 10 a; c = Cons 9 b; d = Cons 8 c} in length d`\u3001\u8981\u306f`length (Cons 8 (Cons 9 (Cons 10 Nil)))`\u3067\u3059\u3002\u3046\u307e\u304f\u3046\u3054\u3044\u3066\u304f\u308c\u308b\u306f\u305a\u3067\u3059\u3002\n\n\u6298\u89d2\u306a\u306e\u3067\u8a55\u4fa1\u7d4c\u904e\u3092\u3086\u3063\u304f\u308a\u898b\u3066\u307f\u3088\u3046\u304b\u3068\u601d\u3044\u307e\u3059\u3002\u91cd\u8981\u306a\u306e\u306f`Eval`/`Enter`/`ReturnCon`/`ReturnRaw`\u306a\u306e\u3067\u3001\u305d\u308c\u3089\u306e\u547c\u3073\u51fa\u3057\u3092\u78ba\u8a8d\u3057\u3066\u307f\u307e\u3059\u3002\u9069\u5f53\u306b\u624b\u52d5\u3067\u898b\u3084\u3059\u304f\u3057\u3066\u3044\u307e\u3059[^visu](\u3042\u3068\u7121\u99c4\u306a\u90e8\u5206\u3092\u6d88\u3057\u305f\u308a\u3057\u3066\u307e\u3059)\u3002\n\n```javascript\n\"Eval\"      let {a=Nil[], b=Cons[10,a], c=Cons[9,b], d=Cons[8,c]} in Length[d]\n\n\"Eval\"      Length[Cons[8,Cons[9,Cons[10,Nil[]]]]]    {}\n\"Enter\"     Length                                    {}\n\"Eval\"      Length                                    {xs -> Cons[8,Cons[9,Cons[10,Nil[]]]]}\n\"Eval\"      case xs of {Nil -> ..., Cons a as -> ...} {xs -> ...} [+Return]\n\"Eval\"      Cons[8,Cons[9,Cons[10,Nil[]]]]            {xs -> ...}\n\"Enter\"     Cons                                      {xs -> ...}\n\"Eval\"      Cons                                      {xs -> ..., x -> 8, y -> Cons[9,Cons[10,Nil]]}\n\"ReturnCon\" 1 (Cons)                                  [-Return]\n\"Eval\"      Add[1,Length[y]]                          {xs -> ..., x -> 8, y -> ...}\n\"Enter\"     Add                                       {xs -> ..., x -> 8, y -> ...}\n\"Eval\"      Add                                       {xs -> ..., x -> 1, y -> Length[Cons[9,Cons[10,Nil[]]]]}\n\"Eval\"      case x of {x -> ...}                      {xs -> ..., x -> 1, y -> Length[Cons[9,Cons[10,Nil[]]]]} [+Return]\n\"Eval\"      1                                         {xs -> ..., x -> 1, y -> Length[Cons[9,Cons[10,Nil[]]]]}\n\"ReturnRaw\" 1                                         [-Return]\n\"Eval\"      case y of {y -> ...}                      {xs -> ..., x -> 1, y -> Length[Cons[9,Cons[10,Nil[]]]]} [+Return]\n\"Eval\"      Length[Cons[9,Cons[10,Nil[]]]]            {xs -> ..., x -> 1, y -> Length[Cons[9,Cons[10,Nil[]]]]}\n\"Enter\"     Length                                    {xs -> ..., x -> 1, y -> Length[Cons[9,Cons[10,Nil[]]]]}\n\"Eval\"      Length                                    {xs -> Cons[9,Cons[10,Nil]]}\n...\n\"Eval\"      Length                                    {xs -> Nil[]}\n\"Eval\"      case xs of {Nil -> ..., Cons a as -> ...} {xs -> Nil[]} [+Return]\n\"Eval\"      Nil[]                                     {xs -> Nil[]}\n\"Enter\"     Nil                                       {xs -> Nil[]}\n\"Eval\"      Nil                                       {}\n\"ReturnCon\" 0 (Nil)                                   [-Return]\n\"Eval\"      0                                         {xs -> Nil[]}\n\"ReturnRaw\" 0                                         [-Return]\n\"Eval\"      1                                         {x -> 1, y -> Length[Nil[]]}\n\"ReturnRaw\" 1                                         [-Return]\n\"Eval\"      2                                         {x -> 1, y -> Length[Cons[10,Nil[]]]}\n\"ReturnRaw\" 2                                         [-Return]\n\"Eval\"      3                                         {x -> 1, y -> Length[Cons[9,Cons[10,Nil[]]]]}\n\"ReturnRaw\" 3                                         [-Return]\n// => 3\n```\n\n[^visu]: \u3068\u8a00\u3063\u3066\u3082\u666e\u901a\u306b\u51fa\u529b\u3057\u305f\u3089\u8b0e\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3057\u304b\u5410\u3044\u3066\u304f\u308c\u306a\u3044\u306e\u3067\u81ea\u5206\u3067\u4e2d\u8eab\u3092\u60f3\u50cf\u3057\u3066\u66f8\u3044\u3066\u308b\u3093\u3067\u3059\u3051\u3069\u30fb\u30fb\u30fb\n\u518d\u5e30\u547c\u3073\u51fa\u3057\u306b\u3088\u3063\u3066\u30ea\u30bf\u30fc\u30f3\u304c\u7a4d\u307e\u308c\u3066\u3044\u304d\u3001\u6700\u5f8c\u306b\u4e00\u6c17\u306b\u623b\u3063\u3066\u3044\u304f\u306e\u304c\u308f\u304b\u308b\u3068\u304a\u3082\u3044\u307e\u3059\u3002\n\n# \u30b0\u30e9\u30d5\u7c21\u7d04\n\n\u4eca\u306e\u3068\u3053\u308d\u9045\u5ef6\u8a55\u4fa1\u3068\u3057\u3066\u306f\u3046\u307e\u304f\u52d5\u4f5c\u3059\u308b\u306e\u3067\u3059\u304c\u30b0\u30e9\u30d5\u7c21\u7d04\u306f\u3057\u3066\u304f\u308c\u306a\u3044\u3067\u3059\u3002\n\u4f8b\u3048\u3070 :\n\n```javascript\nevaluate(letIn([\n  \"a\",Closure([],[],function(x,env){Eval(app(Add,[Raw(1),Raw(1)]),env);},[]),\n  \"b\",Closure([\"a\"],[],function(x,env){Eval(app(Add,[env[\"a\"],env[\"a\"]]),env);},[]),\n  \"c\",Closure([\"b\"],[],function(x,env){Eval(app(Add,[env[\"b\"],env[\"b\"]]),env);},[])\n],Closure([\"c\"],[],function(x,env){Eval(app(env[\"c\"],[]),env);})));\n```\n\n\u8981\u306f`let {a = 1 + 1; b = a + a; c = b + b} in c`\u3067`8`\u306a\u306e\u3067\u3059\u304c\u3001\u3053\u306e\u9593`a`\u306f4\u56de\u8a55\u4fa1\u3055\u308c\u3066\u3057\u307e\u3044\u307e\u3059[^cons]\u3002\u3053\u308c\u3067\u306f\u30b0\u30e9\u30d5\u7c21\u7d04\u306b\u306a\u3063\u3066\u306a\u3044\u306e\u3067\u3001\u8272\u3005\u4fee\u6b63\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u306e\u3067\u3059\u3002\n\n[^cons]: `function(x,env){}`\u306e\u4e2d\u3067`console.log`\u3068\u304b\u3059\u308c\u3070\u308f\u304b\u308b\u3068\u304a\u3082\u3044\u307e\u3059\n\n\u5b9f\u969b\u306b\u5fc5\u8981\u306a\u4ed5\u7d44\u307f\u306f\u300c\u30af\u30ed\u30fc\u30b8\u30e3\u306e\u66f4\u65b0\u300d\u3067\u3059\u3002`a`\u3092\u8a55\u4fa1\u3057\u305f\u7d50\u679c`ReturnRaw 2`\u304c\u767a\u751f\u3059\u308b\u306f\u305a\u3067\u3059\u304c\u3001\u3053\u308c\u3092\u5bdf\u77e5\u3057\u3066`a`\u306e\u6307\u3059\u30af\u30ed\u30fc\u30b8\u30e3\u3092`Raw(2)`\u305d\u306e\u3082\u306e\u306b\u3059\u308a\u66ff\u3048\u3066\u3057\u307e\u3046\u3001\u3068\u3044\u3046\u3053\u3068\u3092\u884c\u3046\u306e\u3067\u3059\u3002\u66f4\u65b0\u3067\u304d\u308b\u30af\u30ed\u30fc\u30b8\u30e3\u3068\u66f4\u65b0\u3067\u304d\u306a\u3044\u30af\u30ed\u30fc\u30b8\u30e3(`id`\u3068\u304b)\u304c\u3042\u308a\u307e\u3059\u304c\u3001\u3053\u308c\u306f\u660e\u793a\u7684\u306b\u30bd\u30fc\u30b9\u306b\u8a18\u8ff0\u3059\u308b\u3053\u3068\u306b\u3057\u307e\u3059[^update]\u3002\n\n```javascript\nfunction updatable(closure){\n  closure.updatable = true;\n  return closure;\n}\nvar updates = [];\nfunction Enter(f){\n  var env = {};\n  for(var i=0;i<f.free.length;i++){\n    env[f.free[i]] = f.ref[i];\n  }\n  f.args.forEach(function(name){\n    env[name] = args.pop();\n  });\n  if(f.updatable){\n    // f.args.length should be 0\n    updates.push({args:args,returns:returns,target:f});\n    args = [], returns = [];\n  }\n  Eval(f,env);\n}\n```\n\nupdatable\u306a\u30af\u30ed\u30fc\u30b8\u30e3\u3078\u306e`Enter`\u304c\u767a\u751f\u3057\u305f\u3068\u304d\u3001\u5f15\u6570\u30b9\u30bf\u30c3\u30af\u3068\u30ea\u30bf\u30fc\u30f3\u30b9\u30bf\u30c3\u30af\u3092\u3059\u3079\u3066\u9000\u907f\u3057\u3066\u3057\u307e\u3044\u307e\u3059\u3002\u305d\u3046\u3059\u308b\u3068\u3001\u3053\u306e\u30af\u30ed\u30fc\u30b8\u30e3\u304c\u6700\u5f8c\u306b\u30ea\u30bf\u30fc\u30f3\u3059\u308b\u3068\u304d\u306b\u3061\u3087\u3046\u3069\u30b9\u30bf\u30c3\u30af\u304c\u7a7a\u306b\u306a\u3063\u3066\u3044\u308b\u306f\u305a\u3067\u3059\u3002\u3068\u3044\u3046\u308f\u3051\u3067`ReturnRaw`\u3001`ReturnCon`\u3092\u5bfe\u5fdc\u3055\u305b\u307e\u3059\u3002\n\n```javascript\nfunction ReturnRaw(n){\n  if(returns.length==0){\n    var u = updates.pop();\n    args = u.args, returns = u.returns;\n    var repl = Raw(n);\n    u.target.free = repl.free;\n    u.target.args = repl.args;\n    u.target.code = repl.code;\n    u.target.ref = repl.ref;\n    u.target.value = repl.value;\n    delete u.target.updatable;\n  }\n  var ret = returns.pop();\n  ret(ret.env)[0](n);\n}\nfunction ReturnCon(n){\n  if(returns.length==0){\n    var u = updates.pop();\n    args = u.args, returns = u.returns;\n    return function(){\n      var args = [];\n      for(var i=0;i<arguments.length;i++)args.push(arguments[i]);\n      var names = [];\n      for(var i=0;i<args.length;i++){\n        names.push(\"Var\"+i);\n      }\n      var repl = Closure(names,[],function(x,env){\n        var vars = names.map((n)=>env[n]);\n        ReturnCon(n).apply(null,vars);\n      },args);\n      u.target.free = repl.free;\n      u.target.args = repl.args;\n      u.target.code = repl.code;\n      u.target.ref = repl.ref;\n      delete u.target.updatable;\n      var ret = returns.pop();\n      ret(ret.env)[n].apply(null,args);\n    }\n  }else{\n    var ret = returns.pop();\n    return ret(ret.env)[n];\n  }\n}\n```\n\n\u66f4\u65b0\u3059\u308b\u5bfe\u8c61\u306f`updates[0]`\u306b\u4fdd\u6301\u3055\u308c\u3066\u304a\u308a\u3001\u307e\u305f\u305d\u308c\u3092\u4f55\u306b\u66f4\u65b0\u3059\u308b\u304b\u3068\u3044\u3046\u306e\u3082`ReturnRaw`\u3067\u306f\u5f15\u6570\u306e`n`\u304c\u6301\u3063\u3066\u3044\u307e\u3059\u3002\u3068\u3044\u3046\u308f\u3051\u3067\u5b9f\u969b\u306b`Raw(n)`\u306e\u51e6\u7406\u5185\u5bb9\u3092\u30b3\u30d4\u30fc\u3057[^copy]\u3001\u6700\u5f8c\u306b`updatable`\u306e\u30d5\u30e9\u30b0\u3092\u6d88\u305b\u3070\u66f4\u65b0\u5b8c\u4e86\u306a\u306e\u3067\u3059\u3002`ReturnCon`\u3067\u3082\u5927\u4f53\u540c\u3058\u3067\u3059[^stcon]\u3002\n\n[^update]: STG\u8a00\u8a9e\u3067\u306f\u30af\u30ed\u30fc\u30b8\u30e3\u306e\u8868\u8a18\u306b`\\u`(updatable)\u3068`\\n`(not updatable)\u3092\u7528\u610f\u3057\u3066\u3044\u307e\u3059\u3002\u3069\u3063\u3061\u306b\u3059\u308b\u3079\u304d\u304b\u306e\u89e3\u6790\u306f\u7d50\u69cb\u5927\u5909\u3089\u3057\u3044\u3067\u3059\u306d\u3002\n[^copy]: JS\u306a\u306e\u3067\u76f4\u63a5`u.target = repl;`\u3057\u3066\u3082\u30c0\u30e1\u306a\u3093\u3067\u3059\u3088\u306d\n[^stcon]: STG\u8ad6\u6587\u5185\u306b\u66f8\u3044\u3066\u3042\u3063\u305fStandard Constructor\u304c\u3053\u306e`repl`\u306b\u306a\u308b\u3093\u3067\u3059\u304b\u306d\u3002\u6700\u5f8c\u306e`refs`\u3092\u5165\u308c\u66ff\u3048\u305f\u3089\u78ba\u304b\u306b\u4ed6\u306e\u30b3\u30f3\u30b9\u30c8\u30e9\u30af\u30bf\u306b\u3082\u4f7f\u3048\u305d\u3046\u3067\u3059\u3002\n\n\u3068\u3044\u3046\u308f\u3051\u3067\u6b21\u306e\u30b3\u30fc\u30c9\u306f\u5b9f\u969b\u306b`a`\u30921\u5ea6\u3057\u304b\u8a55\u4fa1\u3057\u306a\u3044\u3088\u3046\u306b\u306a\u3063\u3066\u304f\u308c\u307e\u3059\u3002\u3084\u3063\u305f\u306d\uff01\n\n```javascript\nevaluate(letIn([\n  \"a\",updatable(Closure([   ],[],function(x,env){Eval(app(Add,[Raw(1),Raw(1)]),env);},[])),\n  \"b\",updatable(Closure([\"a\"],[],function(x,env){Eval(app(Add,[env[\"a\"],env[\"a\"]]),env);},[])),\n  \"c\",updatable(Closure([\"b\"],[],function(x,env){Eval(app(Add,[env[\"b\"],env[\"b\"]]),env);},[]))\n],Closure([],[],function(x,env){Eval(app(env[\"c\"],[]),env);})));\n```\n\n# \u672c\u984c\n\n\u3068\u308a\u3042\u3048\u305a\u4eca\u307e\u3067\u8a55\u4fa1\u6a5f\u69cb\u3092\u4f5c\u3063\u3066\u304d\u305f\u308f\u3051\u3067\u3059\u304c\u3001\u5143\u3005\u306e\u8003\u3048\u305f\u3044\u5185\u5bb9\u306f\u300c\u7121\u9650\u518d\u5e30\u505c\u6b62\u6a5f\u69cb\u300d\u306e\u306f\u306a\u3057\u3067\u3057\u305f\u3002\n\u7121\u9650\u518d\u5e30\u691c\u51fa\u306e\u4ed5\u7d44\u307f\u306f\u5b9f\u306f\u975e\u5e38\u306b\u7c21\u5358\u3067\u3059 : **\u30af\u30ed\u30fc\u30b8\u30e3\u3092\u66f4\u65b0\u3057\u3066\u3044\u308b\u9593\u306b\u305d\u306e\u30af\u30ed\u30fc\u30b8\u30e3\u3092\u8a55\u4fa1\u3057\u305f\u3089\u7121\u9650\u518d\u5e30**\u3002\n\u4f55\u6545\u306a\u3089\u66f4\u65b0\u53ef\u80fd\u306a\u30af\u30ed\u30fc\u30b8\u30e3\u306f\u5f15\u6570\u3092\u53d6\u308c\u306a\u3044\u3053\u3068\u306b\u306a\u3063\u3066\u3044\u308b\u70ba`env`\u306e\u5185\u5bb9\u306f\u5168\u304f\u5909\u5316\u305b\u305a[^func]\u3001\u7d50\u679c\u305d\u306e\u30af\u30ed\u30fc\u30b8\u30e3\u3078\u306e\u8a55\u4fa1\u306f\u307e\u305f\u5fc5\u305a\u66f4\u65b0\u3092\u751f\u3080\u306e\u3067\u3001\u307e\u305f\u3055\u3089\u306a\u308b\u30af\u30ed\u30fc\u30b8\u30e3\u306e\u8a55\u4fa1\u3092\u751f\u3080\u304b\u3089\u3067\u3059\u306d\u3002\u53c2\u7167\u900f\u660e\u6027\u304b\u3089\u3053\u308c\u306f\u7121\u9650\u518d\u5e30\u306b\u3057\u304b\u306a\u3089\u306a\u3044\u3053\u3068\u304c\u308f\u304b\u308a\u307e\u3059\u3002\n\u300c\u73fe\u5728\u30af\u30ed\u30fc\u30b8\u30e3\u306e\u8a55\u4fa1\u4e2d\u3067\u3042\u308b\u3053\u3068\u300d\u306f\u4e00\u822c\u306e\u30af\u30ed\u30fc\u30b8\u30e3\u3067\u306f\u53d6\u5f97\u3067\u304d\u307e\u305b\u3093\u304c\u3001\u66f4\u65b0\u4e2d\u306a\u3089\u660e\u3089\u304b\u3067\u3059\u3002(\u66f4\u65b0\u958b\u59cb\u3057\u305f\u3089\u66f4\u65b0\u7d42\u4e86\u3059\u308b\u306f\u305a\u3067\u3059\u3002)\n\u3055\u3089\u306b\u8a00\u3048\u3070\u30af\u30ed\u30fc\u30b8\u30e3\u3092\u66f4\u65b0\u3059\u308b\u969b\u306b\u306f\u5b8c\u5168\u306b\u524d\u306e\u30af\u30ed\u30fc\u30b8\u30e3\u306e\u60c5\u5831\u3092\u6d88\u3057\u3066\u3057\u307e\u3046\u308f\u3051\u3067\u3001\u300c\u30af\u30ed\u30fc\u30b8\u30e3\u306e\u66f4\u65b0\u3092\u958b\u59cb\u3057\u305f\u3089\u305d\u306e\u30af\u30ed\u30fc\u30b8\u30e3\u306b\u5bfe\u3057\u3066\u4f55\u3092\u3057\u3066\u3082\u826f\u3044\u300d\u3068\u3044\u3046\u3053\u3068\u304c\u5f93\u3044\u307e\u3059\u3002\u3082\u3057\u3082\u305d\u308c\u3067\u554f\u984c\u3068\u306a\u308b\u30b1\u30fc\u30b9\u304c\u3042\u308c\u3070\u7121\u9650\u518d\u5e30\u306e\u307f\u3060\u304b\u3089\u3067\u3059[^bot]\u3002\u305d\u3057\u3066\u3053\u306e\u6a5f\u69cb\u306f**\"Black hole\"**\u3068\u547c\u3070\u308c\u3066\u3044\u308b\u3088\u3046\u3067\u3059\u3002\n\n[^func]: \u3053\u308c\u304c\u3042\u308b\u304b\u3089\u95a2\u6570\u306e\u5834\u5408\u306b\u306f\u9069\u7528\u3067\u304d\u306a\u3044(\u51fa\u6765\u305f\u3089\u56f0\u308b)\u3002\n[^bot]: \u7121\u9650\u518d\u5e30\u306f\u7d50\u5c40\u5024\u306e\u610f\u5473\u3068\u3057\u3066\u306f`undefined`\u306a\u306e\u3067\u4f55\u3057\u3066\u3082\u826f\u3044\u307f\u305f\u3044\u306a\u3068\u3053\u308d\u304c\u3042\u308b\n\n```javascript\nfunction updatable(closure){\n  closure.updatable = true;\n  var code = closure.code;\n  closure.code = function(x,env){\n    // make a black hole!\n    x.code = function(x,env){\n      throw new Error(\"<<loop>>\");\n    };\n    code(x,env);\n  };\n  return closure;\n}\n```\n\nupdatable\u306b\u3059\u308b\u969b\u306b\u30af\u30ed\u30fc\u30b8\u30e3\u306e\u5185\u90e8\u30b3\u30fc\u30c9\u306b\u3061\u3087\u3063\u3068\u624b\u3092\u52a0\u3048\u307e\u3059\u3002\u3053\u308c\u3067\u8a55\u4fa1\u304c\u767a\u751f\u3057\u305f\u3068\u304d\u306b\u300c\u81ea\u8eab\u306e\u5b9f\u884c\u30b3\u30fc\u30c9\u3092\u4f8b\u5916\u3092\u6295\u3052\u308b\u95a2\u6570\u306b\u5909\u3048\u3066\u304b\u3089\u300d\u4eca\u307e\u3067\u901a\u308a\u306e\u8a55\u4fa1\u3092\u3059\u308b\u3001\u3068\u3044\u3046\u3053\u3068\u304c\u5b9f\u73fe\u3067\u304d\u307e\u3059\u3002\n\n```javascript\nvar A = updatable(Closure([],[],function(x,env){\n  Eval(app(Add,[Raw(1),A]),env);\n},[]));\nevaluate(A); // => Uncaught Error: <<loop>>\n```\n\n`a = 1 + a`\u3068\u3057\u3066`a`\u3092\u8a55\u4fa1\u3059\u308b\u3068\u3001\u78ba\u304b\u306b\u4f8b\u5916\u3092\u5410\u3044\u3066\u304f\u308c\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3057\u305f\uff01\n\n\u3067\u3082\u3001\u52ff\u8ad6`b = 1 : b`\u306f\u7279\u306b\u554f\u984c\u306f\u8d77\u304d\u306a\u3044\u3067\u3059\u306d\uff01 (\u4e0b\u306e\u30b3\u30fc\u30c9\u306f`length (take 10 b)`\u3067\u3059) (`Take`\u306e\u5b9a\u7fa9\u3067\u30ba\u30eb\u3092\u3057\u3066\u3044\u307e\u3059\u3051\u3069\u8a31\u3057\u3066\u304f\u3060\u3055\u3044)\n\n```javascript\nvar Take = Closure([],[\"n\",\"xs\"],function(x,env){\n  Eval(caseOf(app(env[\"n\"],[]),function(env){return [function(n){\n    if(n==0){\n      Eval(app(Nil,[]),env);\n    }else{\n      Eval(caseOf(app(env[\"xs\"],[]),function(env){return [function(){\n        Eval(app(Nil,[]),env);\n      },function(a,as){\n        Eval(letIn([\n          \"ys\",Closure([],[],function(x,env){Eval(app(Take,[Raw(n-1),as]),env);},[])\n        ],Closure([\"ys\"],[],function(x,env){Eval(app(Cons,[a,env[\"ys\"]]),env);},[])),env);\n      }];}),env);\n    }\n  }];}),env);\n},[]);\nvar B = updatable(Closure([],[],function(x,env){\n  Eval(app(Cons,[Raw(1),B]),env);\n},[]));\nevaluate(letIn([\n  \"b\",updatable(Closure([],[],function(x,env){Eval(app(Take,[Raw(10),B]),env);},[])),\n  \"c\",updatable(Closure([\"b\"],[],function(x,env){Eval(app(Length,[env[\"b\"]]),env);},[]))\n],Closure([\"c\"],[],function(x,env){Eval(app(env[\"c\"],[]),env);},[]))); // => 10\n```\n\n\u3053\u306e\u5dee\u304c\u3069\u3053\u304b\u3089\u6765\u308b\u304b\u3068\u3044\u3046\u3068\u3001`a = 1 + a`\u306b\u3064\u3044\u3066\u306f`a`\u3092\u66f4\u65b0\u3059\u308b\u969b\u306b\u306f`1`\u306e\u8a55\u4fa1\u306e\u3042\u3068`a`\u3092\u8a55\u4fa1\u3057\u306a\u3044\u3068\u66f4\u65b0\u304c\u5b8c\u4e86\u3057\u306a\u3044(`Add`\u306e\u4e2d\u3067case\u5f0f\u3092\u547c\u3093\u3067\u3057\u307e\u3046)\u3001\u3068\u3044\u3046\u3053\u3068\u3068`b = 1 : b`\u3067\u306f`b`\u306e\u66f4\u65b0\u306f\u6700\u521d\u306e`Cons`\u304c\u6765\u305f\u6642\u70b9\u3067\u3082\u3046\u5b8c\u4e86\u3059\u308b(`ReturnCon`)\u3001\u3068\u3044\u3046\u90e8\u5206\u3067\u3059\u306d\u3002\n\n\u3068\u3044\u3046\u308f\u3051\u3067\u3001\u7121\u9650\u518d\u5e30\u505c\u6b62\u6a5f\u69cb\u306b\u3064\u3044\u30661\u304b\u3089\u4f5c\u308a\u4e0a\u3052\u3066\u518d\u73fe\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3057\u305f\uff01\u304a\u3081\u3067\u3068\u3046\u3054\u3056\u3044\u307e\u3059\uff01\n\n# \u307e\u3068\u3081\n\n\u6700\u521d\u306e\u8cea\u554f\u306b\u5bfe\u3059\u308b\u7b54\u3048\u3068\u3057\u3066\u306f :\n\n  - \u30af\u30ed\u30fc\u30b8\u30e3\u306e\u8a55\u4fa1\u4e2d\u306b\u305d\u306e\u30af\u30ed\u30fc\u30b8\u30e3\u81ea\u8eab\u3092\u5dfb\u304d\u8fbc\u3080\u3088\u3046\u306a\u3053\u3068\u304c\u306a\u3051\u308c\u3070\u5408\u6cd5\u3067\n  - \u5408\u6cd5\u3067\u306a\u3044\u3082\u306e\u306f\u5168\u3066\u691c\u51fa\u3067\u304d\u308b\n  - \u305d\u306e\u691c\u51fa\u6a5f\u69cb\u306f\"Black hole\"\u3067\u5b9f\u73fe\u3055\u308c\u3066\u3044\u308b\n\n\u3068\u3044\u3046\u3053\u3068\u306b\u306a\u308a\u307e\u3059\u3002\n\u3053\u308c\u3067`f x = 1 + f x`\u3067\u306f\u691c\u51fa\u3067\u304d\u306a\u3044\u3053\u3068\u3084\u3001`a = seq a 1`\u3067\u306f\u691c\u51fa\u3055\u308c\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3068\u304a\u3082\u3044\u307e\u3059[^ans]\u3002\n\u9577\u304b\u3063\u305f\u30fb\u30fb\u30fb\n\n[^ans]: \u5de6\u8fba\u306e`f x`\u3068\u53f3\u8fba\u306e`f x`\u306f\u9055\u3046\u30af\u30ed\u30fc\u30b8\u30e3\u3092\u6307\u3059\u304b\u3089\u3001\u307e\u305f`a`\u306e\u66f4\u65b0\u4e2d\u306b`a`\u3092\u8a55\u4fa1\u3059\u308b\u3053\u3068\u306b\u306a\u308b\u304b\u3089\u3002\n\n# \u611f\u60f3\n\nHaskell AdC\u306a\u306e\u306bHaskell\u30b3\u30fc\u30c9\u306f\u304a\u308d\u304b\u578b\u306e\u8a71[^type]\u3059\u3089\u66f8\u3044\u3066\u306a\u3044\u306e\u3067\u66f8\u3044\u3066\u3066\u7533\u3057\u8a33\u306a\u3044\u611f\u3058\u3067\u3057\u305f\u304c\u3001\u3042\u307e\u308a\u8868\u306b\u51fa\u3066\u3053\u306a\u3044\u5185\u90e8\u6a5f\u69cb\u306b\u3064\u3044\u3066\u3061\u3087\u3063\u3068\u7d30\u304b\u304f\u304b\u3051\u305f\u304b\u306a\u30fc\u3068\u601d\u3044\u307e\u3059\u3002\n\n[^type]: \u307e\u3041\u5b9f\u884c\u6642\u306e\u8a71\u3067\u578b\u306a\u3093\u3066\u51fa\u3057\u3066\u3082\u975e\u52b9\u7387\u7684\u3063\u3066\u611f\u3058\u3060\u3057\u610f\u5473\u308f\u304b\u3093\u306a\u3044\u3067\u3059\u3088\u306d\uff5e\uff5e\uff5e\uff5e\n\n\u3053\u306eSTG\u6a5f\u68b0\u306f\u52ff\u8ad6\u95a2\u6570\u578b\u8a00\u8a9e\u306e\u5b9f\u88c5\u306b\u53c2\u8003\u306b\u306a\u308b\u70b9\u304c\u591a\u3044\u3068\u304a\u3082\u3044\u307e\u3059\u304c\u3001\u666e\u901a\u306b\u8aad\u3093\u3067\u3044\u3066\u3082\u697d\u3057\u3044\u3057Haskell\u306e\u5185\u90e8\u306b\u8a73\u3057\u304f\u306a\u3063\u305f\u6c17\u306b\u306a\u308c\u308b\u306e\u3067\u6687\u304c\u3042\u308c\u3070\u8997\u3044\u3066\u307f\u308b\u3068\u826f\u3044\u3068\u304a\u3082\u3044\u307e\u3059(\u305d\u306e\u306a\u304b\u3067Black hole\u304c\u304a\u3082\u3057\u308d\u304b\u3063\u305f\u306e\u3067\u3053\u306e\u8a18\u4e8b\u3092\u66f8\u3044\u305f)\u3002\n\u5c1a\u4eca\u56de\u306fJS\u3067\u5b9f\u88c5\u3057\u307e\u3057\u305f\u304c\u3001\u3067\u304d\u308b\u3060\u3051\u30af\u30ed\u30fc\u30b8\u30e3\u3092\u4f7f\u308f\u306a\u3044\u3088\u3046\u306b\u3057\u3066\u3044\u308b\u306e\u3067C\u8a00\u8a9e\u306a\u3069\u306b\u843d\u3068\u3059\u306e\u3082\u305d\u3093\u306a\u306b\u96e3\u3057\u304f\u306a\u3044\u306f\u305a\u3067\u3059(`env`\u306f\u3053\u306e\u307e\u307e\u3060\u3068\u56f0\u308a\u305d\u3046)(\u5143\u8ad6\u6587\u306b\u306f\u3053\u306e\u5148\u306e\u30a2\u30bb\u30f3\u30d6\u30ea\u30ec\u30d9\u30eb\u306e\u8a71\u3082\u8f09\u3063\u3066\u3044\u307e\u3059\u306e\u3067\u305d\u3061\u3089\u3092\u53c2\u7167)\u3002\u3044\u3064\u304bGHC\u306e\u5410\u304f\u30d0\u30a4\u30ca\u30ea\u3092\u8aad\u3081\u308b\u3088\u3046\u306b\u306a\u3063\u3066\u307f\u305f\u3044\u3067\u3059\u306d\u3002\n\n\u304a\u308f\u308a\u3067\u3059\u3002\u660e\u65e5\u306f@todays-mitsui\u3055\u3093\u306e\u8a18\u4e8b\u3067\u3059\u3002\n\n---\n", "tags": ["ghc", "Haskell"]}