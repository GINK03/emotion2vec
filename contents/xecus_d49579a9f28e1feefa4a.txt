{"tags": ["docker", "chef", "swarm"], "context": "\n\n\u306a\u306b\u3053\u308c\nChefSolo\u3067Docker\u30db\u30b9\u30c8\u3092\u30ac\u30f3\u30ac\u30f3\u7acb\u3066\u3066\u3001DockerSwarm\u3067\u30af\u30e9\u30b9\u30bf\u30ea\u30f3\u30b0\u3057\u3066\n\u4e00\u3064\u306e\u30ea\u30bd\u30fc\u30b9\u30d7\u30fc\u30eb\u306b\u3059\u308b\u304a\u8a71\u3057\u3002\u8da3\u5473\u3067\u4f7f\u3046\u6570\u5024\u8a08\u7b97\u306e\u5206\u6563\u57fa\u76e4\u306b\u4f7f\u3046\u4e88\u5b9a\u3002\n\u203bchef-solo\u3092\u4f7f\u3063\u3066\u3044\u307e\u3059\u304c\u3001\u4eca\u306e\u3054\u6642\u4e16\u3001chef-localmode\u3092\u4f7f\u3046\u3053\u3068\u3092\u63a8\u5968\u3057\u307e\u3059\u3002\n\u53c2\u8003\uff1a https://blog.isao.co.jp/graduated_from_chef-solo/\n\u203bDocker\u304c\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u3067\u304d\u308c\u3070\u3001Ansible\u3067\u3082\u306a\u3093\u3067\u3082\u5927\u4e08\u592b\u3067\u3059\u3002\n\n\u6ce8\u610f\n\n\u6c7a\u3057\u3066Production\u74b0\u5883\u7b49\u3067\u306f\u4f7f\u308f\u306a\u3044\u3067\u304f\u3060\u3055\u3044(\u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u5bfe\u7b56\u7121\u3057\u3067\u3059)\n\n\n\u524d\u63d0\u6761\u4ef6\n\n\u308f\u308a\u3068\u771f\u3063\u767d\u306a\u3068\u3053\u308d\u304b\u3089\u3002\n1\u53f01\u53f0\u624b\u5869\u3092\u304b\u3051\u3066\u30d7\u30ed\u30d3\u30b8\u30e7\u30cb\u30f3\u30b0\u3057\u305f\u304f\u306a\u3044\u306e\u3067chef solo\u3092\u5229\u7528\u3059\u308b\u3002\nDockerSwarm\u306b\u3088\u308b\u30b3\u30f3\u30c6\u30ca\u30aa\u30fc\u30b1\u30b9\u30c8\u30ec\u30fc\u30b7\u30e7\u30f3\u3092\u5b9f\u65bd\n\u30aa\u30fc\u30b1\u30b9\u30c8\u30ec\u30fc\u30b7\u30e7\u30f3\u90e8\u5206\u306f\u624b\u52d5\u3067\u884c\u3046\uff08\u5f8c\u65e5\u3001\u30ec\u30b7\u30d4\u8ffd\u52a0\u3067\u3053\u308c\u3082\u81ea\u52d5\u5316\u4e88\u5b9a)\n\n\n\u7b46\u8005\u306e\u30db\u30b9\u30c8\u74b0\u5883\n\n\u4f5c\u696d\u7528 (192.168.33.10) ubuntu 14.04 Cpus:2 RAM:2GB\nmaster (192.168.33.11) ubuntu 14.04 Cpus:2 RAM:2GB\nsub-1 (192.168.33.12) ubuntu 14.04 Cpus:2 RAM:2GB\nsub-2 (192.168.33.13) ubuntu 14.04 Cpus:2 RAM:2GB\nsub-3 (192.168.33.14) ubuntu 14.04 Cpus:2 RAM:2GB\n\n\n\u624b\u9806\n\n\u30db\u30b9\u30c8\u7fa4\u3078\u306eDocker\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\u3053\u306e\u7ae0\u3067\u306e\u4f5c\u696d\u306f\u3001\u4f5c\u696d\u7528\u30de\u30b7\u30f3\u3067\u304a\u9858\u3044\u3057\u307e\u3059\u3002\n\n\u6e96\u5099\n\n# git\u3044\u308c\u308b\u3002rbenv\u306e\u305f\u3081\u306b\n$ sudo apt-get install -y git\n$ sudo apt-get install -y libssl-dev libreadline-dev zlib1g-dev\n\n# \u65b0\u3057\u3081\u306eruby\u3044\u308c\u3068\u304f\n$ git clone https://github.com/sstephenson/rbenv.git ~/.rbenv\n$ git clone https://github.com/sstephenson/ruby-build.git ~/.rbenv/plugins/ruby-build\n$ echo 'export PATH=\"$HOME/.rbenv/bin:$PATH\"' >> ~/.bash_profile\n$ echo 'eval \"$(rbenv init -)\"' >> ~/.bash_profile\n$ source ~/.bash_profile\n$ rbenv install 2.3.3\n$ rbenv global 2.3.3\n$ rbenv rehash\n\n# knife-solo\u3092\u3044\u308c\u308b\n$ curl -L https://www.opscode.com/chef/install.sh | sudo bash\n$ gem install knife-solo\n$ gem i berkshelf --no-ri --no-rdoc\n\n# \u4f5c\u696d\u7528chef\u30ea\u30dd\u4f5c\u6210\n$ knife solo init chef-repo\n$ cd chef-repo\n\n\n\u30ec\u30b7\u30d4\u3092\u843d\u3068\u3057\u3066\u304f\u308b\nDocker\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u305f\u3081\u306e\u30ec\u30b7\u30d4\u3092\u30cd\u30c3\u30c8\u304b\u3089\u843d\u3068\u3057\u3066\u304d\u307e\u3059\u3002\n$ vi Berksfile\nsite :opscode\ncookbook 'docker', '~> 2.13.0'\n$ berks vendor cookbooks\n\n\nDocker\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u30ec\u30b7\u30d4\u3092\u66f8\u304f\n\u203b\u30dc\u30ad\u30e3\u8ca7\u3059\u304e\u3066hello\u306b\u3057\u3066\u3057\u307e\u3044\u307e\u3057\u305f\u304c\u3001\u304a\u597d\u304d\u306a\u540d\u524d\u3092\u3069\u3046\u305e\n$ mkdir -p site-cookbooks/hello\n$ mkdir -p site-cookbooks/hello/recipes\n$ vi site-cookbooks/hello/README.md\n\u3053\u308c\u306fDocker\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u305f\u3081\u306e\u30ec\u30b7\u30d4\u3067\u3059\u3002\n\n$ vi site-cookbooks/hello/metadata.rb\nname             'hello'\nmaintainer       'YOUR_COMPANY_NAME'\nmaintainer_email 'YOUR_EMAIL'\nlicense          'All rights reserved'\ndescription      'Setup Docker'\nlong_description IO.read(File.join(File.dirname(__FILE__), 'README.md'))\nversion          '0.1.0'\ndepends          'docker', '~> 2.0'\n\n$ vi site-cookbooks/hello/recipes/default.rb\nexecute \"apt-get-update\" do\n  command \"apt-get update --fix-missing\"\n  ignore_failure true\nend\ndocker_service 'default' do\n  # 0.0.0.0:2376\u3067DockerAPI\u3092EXPOSE\u3057\u3061\u3083\u3046\n  host [\"tcp://0.0.0.0:2376\", 'unix:///var/run/docker.sock']\n  action [:create, :start]\nend\n# \u30e6\u30fc\u30b6\u30fc\u540d\u306b\u5408\u308f\u305b\u3066\u7de8\u96c6\u3057\u3066\u304f\u3060\u3055\u3044\u3002\nexecute \"set user permission\" do\n  command \"usermod -aG docker vagrant\"\nend\n\n\n\n\u5bfe\u8c61\u30db\u30b9\u30c8\u9054\u306bBootstrap\u3092\u4ed5\u8fbc\u3080\nSSH\u306e\u516c\u958b\u9375\u306e\u8a2d\u5b9a\u306f\u3054\u81ea\u8eab\u306e\u74b0\u5883\u306b\u5408\u308f\u305b\u3066\u304f\u3060\u3055\u3044\u3002\u3084\u3063\u3066\u3044\u308b\u4e8b\u3068\u3057\u3066\u306f\u3001\u4ee5\u4e0b\u306e2\u70b9\u3067\u3059\u3002\n\n\u516c\u958b\u9375\u3092\u5bfe\u8c61\u30db\u30b9\u30c8\u7fa4\u3078\u30b3\u30d4\u30fc\u3057\u3066\u3001\u9375\u3067\u30ed\u30b0\u30a4\u30f3\u3067\u304d\u308b\u3088\u3046\u306b\u3057\u3066\u304a\u304f\nchef-solo\u3092\u5bfe\u8c61\u30db\u30b9\u30c8\u306b\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n$ ssh-copy-id -i ~/.ssh/id_rsa.pub vagrant@192.168.33.11\n$ ssh-copy-id -i ~/.ssh/id_rsa.pub vagrant@192.168.33.12\n$ ssh-copy-id -i ~/.ssh/id_rsa.pub vagrant@192.168.33.13\n$ ssh-copy-id -i ~/.ssh/id_rsa.pub vagrant@192.168.33.14\n\n$ knife solo prepare -i ~/.ssh/id_rsa vagrant@192.168.33.11\n$ knife solo prepare -i ~/.ssh/id_rsa vagrant@192.168.33.12\n$ knife solo prepare -i ~/.ssh/id_rsa vagrant@192.168.33.13\n$ knife solo prepare -i ~/.ssh/id_rsa vagrant@192.168.33.14\n\n\n\u5bfe\u8c61\u30db\u30b9\u30c8\u7fa4\u306erun_list\u306b\u30ec\u30b7\u30d4\u8ffd\u52a0\n\u3064\u304f\u3063\u305f\u30ec\u30b7\u30d4\u304c\u5b9f\u884c\u3055\u308c\u308b\u3088\u3046\u306b\u5168\u30db\u30b9\u30c8\u306erun_list\u306b\u30ec\u30b7\u30d4\u3092\u8ffd\u52a0\u3057\u3066\u304f\u3060\u3055\u3044\n\u5b9f\u306f\u3001knife\u30b3\u30de\u30f3\u30c9\u3067\u3046\u307e\u304f\u3084\u308c\u308b\u304c\u3053\u3053\u3067\u306f\u4eba\u529b\u3067\u3002\n$ vi nodes/192.168.33.11.json\n{\n  \"run_list\": [\n    \"recipe[hello]\"\n  ],\n  \"automatic\": {\n    \"ipaddress\": \"192.168.33.11\"\n  }\n}\n\n\n\u5bfe\u8c61\u30db\u30b9\u30c8\u7fa4\u306bDocker\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u5b9f\u65bd\n\u305f\u307e\u306b\u30b3\u30b1\u308b\u3053\u3068\u304c\u3042\u308b\u306e\u3067\u3001\u305d\u306e\u3068\u304d\u306f\u30ea\u30c8\u30e9\u30a4\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n$ knife solo cook -i ~/.ssh/id_rsa vagrant@192.168.33.11\n$ knife solo cook -i ~/.ssh/id_rsa vagrant@192.168.33.12\n$ knife solo cook -i ~/.ssh/id_rsa vagrant@192.168.33.13\n$ knife solo cook -i ~/.ssh/id_rsa vagrant@192.168.33.14\n\n\n\u30aa\u30fc\u30b1\u30b9\u30c8\u30ec\u30fc\u30b7\u30e7\u30f3\u8a2d\u5b9a\u3068\u78ba\u8a8d\n\u4eca\u56de\u69cb\u7bc9\u3057\u305fDocker\u30db\u30b9\u30c8\u306f\u3001DockerAPI\u7528\u306e\u30dd\u30fc\u30c8\u3092\u5916\u90e8\u306bEXPOSE\u3057\u3066\u3044\u308b\u70ba\u3001\n\u57fa\u672c\u7684\u306b\u306f\u5916\u90e8\u304b\u3089\u4f5c\u696d\u304c\u53ef\u80fd\u3067\u3059\u3002\n(\u305f\u3060\u3001\u4f5c\u696d\u30de\u30b7\u30f3\u306b\u306fDocker\u304c\u5165\u3063\u3066\u3044\u3066\u3001\u5bfe\u8c61\u30db\u30b9\u30c8\u7fa4\u3068\u540c\u3058\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u4e0a\u306b\u3042\u308b\u5fc5\u8981\u6027\u304c\u3042\u308a\u307e\u3059)\n\nToken\u751f\u6210\n\u3053\u3053\u3067\u751f\u6210\u3057\u305f\u30c8\u30fc\u30af\u30f3\u306f\u3001\u4eca\u5f8c\u4f7f\u3046\u306e\u3067\u30e1\u30e2\u3063\u3066\u304a\u3044\u3066\u304f\u3060\u3055\u3044\u3002\n\nvagrant@master:~$ docker -H 192.168.33.11:2376 run --rm swarm create                      \nUnable to find image 'swarm:latest' locally latest: Pulling from library/swarm                     \n220609e0bc51: Pull complete                     \nb54bf338fe2f: Pull complete                     \nd53aac5750d5: Pull completeDigest: sha256:c9e1b4d4e399946c0542accf30f9a73500d6b0b075e152ed1c792214d3509d70                 \nStatus: Downloaded newer image for swarm:latest\nd3c063f108135XXXXXXXXXXXXXXXXXXX\n\n\n\n\u30b9\u30ec\u30fc\u30d6\u306eJOIN\nvagrant@master:~$ docker -H 192.168.33.12:2376 run -d swarm join --addr=192.168.33.12:2376 token://d3c063f108135XXXXXXXXXXXXXXXXXXX\nvagrant@master:~$ docker -H 192.168.33.13:2376 run -d swarm join --addr=192.168.33.13:2376 token://d3c063f108135XXXXXXXXXXXXXXXXXXX\nvagrant@master:~$ docker -H 192.168.33.14:2376 run -d swarm join --addr=192.168.33.14:2376 token://d3c063f108135XXXXXXXXXXXXXXXXXXX\n\n\n\u30de\u30cd\u30fc\u30b8\u30e3\u30fc\u3092\u7acb\u3061\u4e0a\u3052\u308b\nvagrant@master:~$ docker -H 192.168.33.11:2376 run -d -p 12375:2375 swarm manage token://d3c063f108135XXXXXXXXXXXXXXXXXXX\n\n\n\u30db\u30b9\u30c8\u4e00\u89a7\u306e\u78ba\u8a8d\nJOIN\u3057\u305f\u30db\u30b9\u30c8\u306eIP\u3068\u30dd\u30fc\u30c8\u756a\u53f7\u304c\u5217\u6319\u3055\u308c\u3066\u3044\u308c\u3070\u554f\u984c\u3042\u308a\u307e\u305b\u3093\u3002\nvagrant@master:~$ docker -H 192.168.33.11:2376 run --rm swarm list token://d3c063f108135XXXXXXXXXXXXXXXXXXX\n192.168.33.14:2375\n192.168.33.13:2375\n192.168.33.12:2375\n\n\n\u5404Docker\u30db\u30b9\u30c8\u306e\u72b6\u614b\n\u5404\u30db\u30b9\u30c8\u306bps\u30b3\u30de\u30f3\u30c9\u6295\u3052\u305f\u611f\u3058\u3002\n\u3053\u308c\u3089\u306eSwarm\u7ba1\u7406\u7528\u306e\u30b3\u30f3\u30c6\u30ca\u306f\u524a\u9664\u3057\u306a\u3044\u3088\u3046\u306b\u3057\u3066\u304f\u3060\u3055\u3044\u3002\u304f\u308c\u3050\u308c\u3082\n\nvagrant@master:~$ docker -H 192.168.33.11:2376 ps\nCONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                     NAMES\n588ddd969e5a        swarm               \"/swarm manage token:\"   40 minutes ago      Up 40 minutes       0.0.0.0:12375->2375/tcp   nauseous_hawking\nvagrant@master:~$ docker -H 192.168.33.12:2376 ps\nCONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS               NAMES\nf53fd4fc19e3        swarm               \"/swarm join --addr=1\"   44 minutes ago      Up 44 minutes       2375/tcp            pensive_golick\nvagrant@master:~$ docker -H 192.168.33.13:2376 ps\nCONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS               NAMES\ndfae3a02e6a2        swarm               \"/swarm join --addr=1\"   43 minutes ago      Up 43 minutes       2375/tcp            nostalgic_spence\nvagrant@master:~$ docker -H 192.168.33.14:2376 ps\nCONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS               NAMES\nd511dd6b6d17        swarm               \"/swarm join --addr=1\"   42 minutes ago      Up 42 minutes       2375/tcp            cocky_wozniak\n\n\nSwarm Maneger\u306b\u3064\u306a\u3044\u3067\u307f\u308b\n\u3061\u3083\u3093\u3068\u30af\u30e9\u30b9\u30bf\u3068\u3057\u3066\u8a8d\u8b58\u3055\u308c\u3066\u3044\u308b\u3068\u601d\u3044\u307e\u3059\u3002\nCPU2\u30b3\u30a2\u3000RAM2GM\u306e\u30de\u30b7\u30f3\u30923\u53f0\u675f\u306d\u3066\u3044\u308b\u306e\u3067\u3001\u5408\u8a086CPU RAM6GB\u306b\n\u306a\u3063\u3066\u3044\u308b\u3053\u3068\u3082\u78ba\u8a8d\u3067\u304d\u307e\u3059\u3002\u3044\u3063\u305f\u3093\u3001\u3053\u3053\u307e\u3067\u3067\u30b4\u30fc\u30eb\u3002\n\nvagrant@master:~$ docker -H 192.168.33.11:12375 info                                                                                                                                               \nContainers: 3                                                                                                                                                                                      \n Running: 3                                                                                                                                                                                        \n Paused: 0                                                                                                                                                                                         \n Stopped: 0                                                                                                                                                                                        \nImages: 3                                                                                                                                                                                          \nServer Version: swarm/1.2.5                                                                                                                                                                        \nRole: primary                                                                                                                                                                                      \nStrategy: spread                                                                                                                                                                                   \nFilters: health, port, containerslots, dependency, affinity, constraint                                                                                                                            \nNodes: 3                                                                                                                                                                                           \n slave-1: 192.168.33.12:2376                                                                                                                                                                       \n  \u2514 ID: EEZI:UKFK:G2F2:SNWF:C3R6:2NWN:PBJV:XO5R:XB34:I5TL:MMNE:ETXN                                                                                                                               \n  \u2514 Status: Healthy                                                                                                                                                                               \n  \u2514 Containers: 1 (1 Running, 0 Paused, 0 Stopped)                                                                                                                                                \n  \u2514 Reserved CPUs: 0 / 2                                                                                                                                                                          \n  \u2514 Reserved Memory: 0 B / 2.053 GiB                                                                                                                                                              \n  \u2514 Labels: kernelversion=3.13.0-103-generic, operatingsystem=Ubuntu 14.04.5 LTS, storagedriver=aufs                                                                                              \n  \u2514 UpdatedAt: 2016-12-06T15:13:17Z                                                                                                                                                               \n  \u2514 ServerVersion: 1.12.3                                                                                                                                                                         \n slave-2: 192.168.33.13:2376                                                                                                                                                                       \n  \u2514 ID: O53J:5CP5:D2SL:JR3G:B7KG:E2B6:OWEF:WY36:NWPQ:25FZ:6PVT:DQOW                                                                                                                               \n  \u2514 Status: Healthy                                                                                                                                                                               \n  \u2514 Containers: 1 (1 Running, 0 Paused, 0 Stopped)                                                                                                                                                \n  \u2514 Reserved CPUs: 0 / 2                                                                                                                                                                          \n  \u2514 Reserved Memory: 0 B / 2.053 GiB                                                                                                                                                              \n  \u2514 Labels: kernelversion=3.13.0-103-generic, operatingsystem=Ubuntu 14.04.5 LTS, storagedriver=aufs                                                                                              \n  \u2514 UpdatedAt: 2016-12-06T15:13:18Z                                                                                                                                                               \n  \u2514 ServerVersion: 1.12.3                                                                                                                                                                         \n slave-3: 192.168.33.14:2376                                                                                                                                                                       \n  \u2514 ID: IB4U:UUJB:RCTB:R7NZ:LBYR:3ZB2:WOR6:2IPA:MLYM:IAMA:T45L:FKGZ                                                                                                                               \n  \u2514 Status: Healthy                                                                                                                                                                               \n  \u2514 Containers: 1 (1 Running, 0 Paused, 0 Stopped)                                                                                                                                                \n  \u2514 Reserved CPUs: 0 / 2                                                                                                                                                                          \n  \u2514 Reserved Memory: 0 B / 2.053 GiB                                                                                                                                                              \n  \u2514 Labels: kernelversion=3.13.0-103-generic, operatingsystem=Ubuntu 14.04.5 LTS, storagedriver=aufs                                                                                              \n  \u2514 UpdatedAt: 2016-12-06T15:14:01Z                                                                                                                                                               \n  \u2514 ServerVersion: 1.12.3\nPlugins:                                                                                                                                                                                           \n Volume:                                                                                                                                                                                           \n Network:                                                                                                                                                                                          \nSwarm:                                                                                                                                                                                             \n NodeID:                                                                                                                                                                                           \n Is Manager: false                                                                                                                                                                                 \n Node Address:                                                                                                                                                                                     \nSecurity Options:                                                                                                                                                                                  \nKernel Version: 3.13.0-103-generic                                                                                                                                                                 \nOperating System: linux                                                                                                                                                                            \nArchitecture: amd64                                                                                                                                                                                \nCPUs: 6                                                                                                                                                                                            \nTotal Memory: 6.158 GiB                                                                                                                                                                            \nName: f8e6c11a239c                                                                                                                                                                                 \nDocker Root Dir:                                                                                                                                                                                   \nDebug Mode (client): false                                                                                                                                                                         \nDebug Mode (server): false                                                                                                                                                                         \nWARNING: No kernel memory limit support\n\n# \u306a\u306b\u3053\u308c\nChefSolo\u3067Docker\u30db\u30b9\u30c8\u3092\u30ac\u30f3\u30ac\u30f3\u7acb\u3066\u3066\u3001DockerSwarm\u3067\u30af\u30e9\u30b9\u30bf\u30ea\u30f3\u30b0\u3057\u3066\n\u4e00\u3064\u306e\u30ea\u30bd\u30fc\u30b9\u30d7\u30fc\u30eb\u306b\u3059\u308b\u304a\u8a71\u3057\u3002\u8da3\u5473\u3067\u4f7f\u3046\u6570\u5024\u8a08\u7b97\u306e\u5206\u6563\u57fa\u76e4\u306b\u4f7f\u3046\u4e88\u5b9a\u3002\n\u203bchef-solo\u3092\u4f7f\u3063\u3066\u3044\u307e\u3059\u304c\u3001\u4eca\u306e\u3054\u6642\u4e16\u3001chef-localmode\u3092\u4f7f\u3046\u3053\u3068\u3092\u63a8\u5968\u3057\u307e\u3059\u3002\n\u53c2\u8003\uff1a https://blog.isao.co.jp/graduated_from_chef-solo/\n\n\u203bDocker\u304c\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u3067\u304d\u308c\u3070\u3001Ansible\u3067\u3082\u306a\u3093\u3067\u3082\u5927\u4e08\u592b\u3067\u3059\u3002\n\n# \u6ce8\u610f\n- \u6c7a\u3057\u3066Production\u74b0\u5883\u7b49\u3067\u306f\u4f7f\u308f\u306a\u3044\u3067\u304f\u3060\u3055\u3044(\u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u5bfe\u7b56\u7121\u3057\u3067\u3059)\n\n# \u524d\u63d0\u6761\u4ef6\n- \u308f\u308a\u3068\u771f\u3063\u767d\u306a\u3068\u3053\u308d\u304b\u3089\u3002\n- 1\u53f01\u53f0\u624b\u5869\u3092\u304b\u3051\u3066\u30d7\u30ed\u30d3\u30b8\u30e7\u30cb\u30f3\u30b0\u3057\u305f\u304f\u306a\u3044\u306e\u3067chef solo\u3092\u5229\u7528\u3059\u308b\u3002\n- DockerSwarm\u306b\u3088\u308b\u30b3\u30f3\u30c6\u30ca\u30aa\u30fc\u30b1\u30b9\u30c8\u30ec\u30fc\u30b7\u30e7\u30f3\u3092\u5b9f\u65bd\n- \u30aa\u30fc\u30b1\u30b9\u30c8\u30ec\u30fc\u30b7\u30e7\u30f3\u90e8\u5206\u306f\u624b\u52d5\u3067\u884c\u3046\uff08\u5f8c\u65e5\u3001\u30ec\u30b7\u30d4\u8ffd\u52a0\u3067\u3053\u308c\u3082\u81ea\u52d5\u5316\u4e88\u5b9a)\n\n# \u7b46\u8005\u306e\u30db\u30b9\u30c8\u74b0\u5883\n- \u4f5c\u696d\u7528 (192.168.33.10) ubuntu 14.04 Cpus:2 RAM:2GB\n- master (192.168.33.11) ubuntu 14.04 Cpus:2 RAM:2GB\n- sub-1 (192.168.33.12) ubuntu 14.04 Cpus:2 RAM:2GB\n- sub-2 (192.168.33.13) ubuntu 14.04 Cpus:2 RAM:2GB\n- sub-3 (192.168.33.14) ubuntu 14.04 Cpus:2 RAM:2GB\n\n# \u624b\u9806\n\n## \u30db\u30b9\u30c8\u7fa4\u3078\u306eDocker\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\u3053\u306e\u7ae0\u3067\u306e\u4f5c\u696d\u306f\u3001\u4f5c\u696d\u7528\u30de\u30b7\u30f3\u3067\u304a\u9858\u3044\u3057\u307e\u3059\u3002\n\n### \u6e96\u5099\n```bash\n\n# git\u3044\u308c\u308b\u3002rbenv\u306e\u305f\u3081\u306b\n$ sudo apt-get install -y git\n$ sudo apt-get install -y libssl-dev libreadline-dev zlib1g-dev\n\n# \u65b0\u3057\u3081\u306eruby\u3044\u308c\u3068\u304f\n$ git clone https://github.com/sstephenson/rbenv.git ~/.rbenv\n$ git clone https://github.com/sstephenson/ruby-build.git ~/.rbenv/plugins/ruby-build\n$ echo 'export PATH=\"$HOME/.rbenv/bin:$PATH\"' >> ~/.bash_profile\n$ echo 'eval \"$(rbenv init -)\"' >> ~/.bash_profile\n$ source ~/.bash_profile\n$ rbenv install 2.3.3\n$ rbenv global 2.3.3\n$ rbenv rehash\n\n# knife-solo\u3092\u3044\u308c\u308b\n$ curl -L https://www.opscode.com/chef/install.sh | sudo bash\n$ gem install knife-solo\n$ gem i berkshelf --no-ri --no-rdoc\n\n# \u4f5c\u696d\u7528chef\u30ea\u30dd\u4f5c\u6210\n$ knife solo init chef-repo\n$ cd chef-repo\n```\n\n### \u30ec\u30b7\u30d4\u3092\u843d\u3068\u3057\u3066\u304f\u308b\nDocker\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u305f\u3081\u306e\u30ec\u30b7\u30d4\u3092\u30cd\u30c3\u30c8\u304b\u3089\u843d\u3068\u3057\u3066\u304d\u307e\u3059\u3002\n\n```bash\n$ vi Berksfile\nsite :opscode\ncookbook 'docker', '~> 2.13.0'\n$ berks vendor cookbooks\n```\n\n### Docker\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u30ec\u30b7\u30d4\u3092\u66f8\u304f\n\u203b\u30dc\u30ad\u30e3\u8ca7\u3059\u304e\u3066hello\u306b\u3057\u3066\u3057\u307e\u3044\u307e\u3057\u305f\u304c\u3001\u304a\u597d\u304d\u306a\u540d\u524d\u3092\u3069\u3046\u305e\n\n```bash\n$ mkdir -p site-cookbooks/hello\n$ mkdir -p site-cookbooks/hello/recipes\n$ vi site-cookbooks/hello/README.md\n\u3053\u308c\u306fDocker\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u305f\u3081\u306e\u30ec\u30b7\u30d4\u3067\u3059\u3002\n```\n\n```bash\n$ vi site-cookbooks/hello/metadata.rb\nname             'hello'\nmaintainer       'YOUR_COMPANY_NAME'\nmaintainer_email 'YOUR_EMAIL'\nlicense          'All rights reserved'\ndescription      'Setup Docker'\nlong_description IO.read(File.join(File.dirname(__FILE__), 'README.md'))\nversion          '0.1.0'\ndepends          'docker', '~> 2.0'\n```\n\n```bash\n$ vi site-cookbooks/hello/recipes/default.rb\nexecute \"apt-get-update\" do\n  command \"apt-get update --fix-missing\"\n  ignore_failure true\nend\ndocker_service 'default' do\n  # 0.0.0.0:2376\u3067DockerAPI\u3092EXPOSE\u3057\u3061\u3083\u3046\n  host [\"tcp://0.0.0.0:2376\", 'unix:///var/run/docker.sock']\n  action [:create, :start]\nend\n# \u30e6\u30fc\u30b6\u30fc\u540d\u306b\u5408\u308f\u305b\u3066\u7de8\u96c6\u3057\u3066\u304f\u3060\u3055\u3044\u3002\nexecute \"set user permission\" do\n  command \"usermod -aG docker vagrant\"\nend\n\n```\n\n### \u5bfe\u8c61\u30db\u30b9\u30c8\u9054\u306bBootstrap\u3092\u4ed5\u8fbc\u3080\nSSH\u306e\u516c\u958b\u9375\u306e\u8a2d\u5b9a\u306f\u3054\u81ea\u8eab\u306e\u74b0\u5883\u306b\u5408\u308f\u305b\u3066\u304f\u3060\u3055\u3044\u3002\u3084\u3063\u3066\u3044\u308b\u4e8b\u3068\u3057\u3066\u306f\u3001\u4ee5\u4e0b\u306e2\u70b9\u3067\u3059\u3002\n\n- \u516c\u958b\u9375\u3092\u5bfe\u8c61\u30db\u30b9\u30c8\u7fa4\u3078\u30b3\u30d4\u30fc\u3057\u3066\u3001\u9375\u3067\u30ed\u30b0\u30a4\u30f3\u3067\u304d\u308b\u3088\u3046\u306b\u3057\u3066\u304a\u304f\n- chef-solo\u3092\u5bfe\u8c61\u30db\u30b9\u30c8\u306b\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n```\n$ ssh-copy-id -i ~/.ssh/id_rsa.pub vagrant@192.168.33.11\n$ ssh-copy-id -i ~/.ssh/id_rsa.pub vagrant@192.168.33.12\n$ ssh-copy-id -i ~/.ssh/id_rsa.pub vagrant@192.168.33.13\n$ ssh-copy-id -i ~/.ssh/id_rsa.pub vagrant@192.168.33.14\n\n$ knife solo prepare -i ~/.ssh/id_rsa vagrant@192.168.33.11\n$ knife solo prepare -i ~/.ssh/id_rsa vagrant@192.168.33.12\n$ knife solo prepare -i ~/.ssh/id_rsa vagrant@192.168.33.13\n$ knife solo prepare -i ~/.ssh/id_rsa vagrant@192.168.33.14\n```\n\n### \u5bfe\u8c61\u30db\u30b9\u30c8\u7fa4\u306erun_list\u306b\u30ec\u30b7\u30d4\u8ffd\u52a0\n\u3064\u304f\u3063\u305f\u30ec\u30b7\u30d4\u304c\u5b9f\u884c\u3055\u308c\u308b\u3088\u3046\u306b\u5168\u30db\u30b9\u30c8\u306erun_list\u306b\u30ec\u30b7\u30d4\u3092\u8ffd\u52a0\u3057\u3066\u304f\u3060\u3055\u3044\n\u5b9f\u306f\u3001knife\u30b3\u30de\u30f3\u30c9\u3067\u3046\u307e\u304f\u3084\u308c\u308b\u304c\u3053\u3053\u3067\u306f\u4eba\u529b\u3067\u3002\n\n```bash\n$ vi nodes/192.168.33.11.json\n{\n  \"run_list\": [\n    \"recipe[hello]\"\n  ],\n  \"automatic\": {\n    \"ipaddress\": \"192.168.33.11\"\n  }\n}\n```\n\n### \u5bfe\u8c61\u30db\u30b9\u30c8\u7fa4\u306bDocker\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u5b9f\u65bd\n\u305f\u307e\u306b\u30b3\u30b1\u308b\u3053\u3068\u304c\u3042\u308b\u306e\u3067\u3001\u305d\u306e\u3068\u304d\u306f\u30ea\u30c8\u30e9\u30a4\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n```bash\n$ knife solo cook -i ~/.ssh/id_rsa vagrant@192.168.33.11\n$ knife solo cook -i ~/.ssh/id_rsa vagrant@192.168.33.12\n$ knife solo cook -i ~/.ssh/id_rsa vagrant@192.168.33.13\n$ knife solo cook -i ~/.ssh/id_rsa vagrant@192.168.33.14\n```\n\n### \n\n## \u30aa\u30fc\u30b1\u30b9\u30c8\u30ec\u30fc\u30b7\u30e7\u30f3\u8a2d\u5b9a\u3068\u78ba\u8a8d\n\u4eca\u56de\u69cb\u7bc9\u3057\u305fDocker\u30db\u30b9\u30c8\u306f\u3001DockerAPI\u7528\u306e\u30dd\u30fc\u30c8\u3092\u5916\u90e8\u306bEXPOSE\u3057\u3066\u3044\u308b\u70ba\u3001\n\u57fa\u672c\u7684\u306b\u306f\u5916\u90e8\u304b\u3089\u4f5c\u696d\u304c\u53ef\u80fd\u3067\u3059\u3002\n(\u305f\u3060\u3001\u4f5c\u696d\u30de\u30b7\u30f3\u306b\u306fDocker\u304c\u5165\u3063\u3066\u3044\u3066\u3001\u5bfe\u8c61\u30db\u30b9\u30c8\u7fa4\u3068\u540c\u3058\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u4e0a\u306b\u3042\u308b\u5fc5\u8981\u6027\u304c\u3042\u308a\u307e\u3059)\n\n### Token\u751f\u6210\n\u3053\u3053\u3067\u751f\u6210\u3057\u305f\u30c8\u30fc\u30af\u30f3\u306f\u3001\u4eca\u5f8c\u4f7f\u3046\u306e\u3067\u30e1\u30e2\u3063\u3066\u304a\u3044\u3066\u304f\u3060\u3055\u3044\u3002\n\n```bash\n\nvagrant@master:~$ docker -H 192.168.33.11:2376 run --rm swarm create                      \nUnable to find image 'swarm:latest' locally latest: Pulling from library/swarm                     \n220609e0bc51: Pull complete                     \nb54bf338fe2f: Pull complete                     \nd53aac5750d5: Pull completeDigest: sha256:c9e1b4d4e399946c0542accf30f9a73500d6b0b075e152ed1c792214d3509d70                 \nStatus: Downloaded newer image for swarm:latest\nd3c063f108135XXXXXXXXXXXXXXXXXXX\n\n```\n### \u30b9\u30ec\u30fc\u30d6\u306eJOIN\n\n```bash\nvagrant@master:~$ docker -H 192.168.33.12:2376 run -d swarm join --addr=192.168.33.12:2376 token://d3c063f108135XXXXXXXXXXXXXXXXXXX\nvagrant@master:~$ docker -H 192.168.33.13:2376 run -d swarm join --addr=192.168.33.13:2376 token://d3c063f108135XXXXXXXXXXXXXXXXXXX\nvagrant@master:~$ docker -H 192.168.33.14:2376 run -d swarm join --addr=192.168.33.14:2376 token://d3c063f108135XXXXXXXXXXXXXXXXXXX\n```\n\n### \u30de\u30cd\u30fc\u30b8\u30e3\u30fc\u3092\u7acb\u3061\u4e0a\u3052\u308b\n\n```bash\nvagrant@master:~$ docker -H 192.168.33.11:2376 run -d -p 12375:2375 swarm manage token://d3c063f108135XXXXXXXXXXXXXXXXXXX\n```\n\n### \u30db\u30b9\u30c8\u4e00\u89a7\u306e\u78ba\u8a8d\nJOIN\u3057\u305f\u30db\u30b9\u30c8\u306eIP\u3068\u30dd\u30fc\u30c8\u756a\u53f7\u304c\u5217\u6319\u3055\u308c\u3066\u3044\u308c\u3070\u554f\u984c\u3042\u308a\u307e\u305b\u3093\u3002\n\n```bash\nvagrant@master:~$ docker -H 192.168.33.11:2376 run --rm swarm list token://d3c063f108135XXXXXXXXXXXXXXXXXXX\n192.168.33.14:2375\n192.168.33.13:2375\n192.168.33.12:2375\n```\n\n### \u5404Docker\u30db\u30b9\u30c8\u306e\u72b6\u614b\n\u5404\u30db\u30b9\u30c8\u306bps\u30b3\u30de\u30f3\u30c9\u6295\u3052\u305f\u611f\u3058\u3002\n\u3053\u308c\u3089\u306eSwarm\u7ba1\u7406\u7528\u306e\u30b3\u30f3\u30c6\u30ca\u306f\u524a\u9664\u3057\u306a\u3044\u3088\u3046\u306b\u3057\u3066\u304f\u3060\u3055\u3044\u3002\u304f\u308c\u3050\u308c\u3082\n\n```bash\n\nvagrant@master:~$ docker -H 192.168.33.11:2376 ps\nCONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                     NAMES\n588ddd969e5a        swarm               \"/swarm manage token:\"   40 minutes ago      Up 40 minutes       0.0.0.0:12375->2375/tcp   nauseous_hawking\nvagrant@master:~$ docker -H 192.168.33.12:2376 ps\nCONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS               NAMES\nf53fd4fc19e3        swarm               \"/swarm join --addr=1\"   44 minutes ago      Up 44 minutes       2375/tcp            pensive_golick\nvagrant@master:~$ docker -H 192.168.33.13:2376 ps\nCONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS               NAMES\ndfae3a02e6a2        swarm               \"/swarm join --addr=1\"   43 minutes ago      Up 43 minutes       2375/tcp            nostalgic_spence\nvagrant@master:~$ docker -H 192.168.33.14:2376 ps\nCONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS               NAMES\nd511dd6b6d17        swarm               \"/swarm join --addr=1\"   42 minutes ago      Up 42 minutes       2375/tcp            cocky_wozniak\n```\n\n### Swarm Maneger\u306b\u3064\u306a\u3044\u3067\u307f\u308b\n\u3061\u3083\u3093\u3068\u30af\u30e9\u30b9\u30bf\u3068\u3057\u3066\u8a8d\u8b58\u3055\u308c\u3066\u3044\u308b\u3068\u601d\u3044\u307e\u3059\u3002\nCPU2\u30b3\u30a2\u3000RAM2GM\u306e\u30de\u30b7\u30f3\u30923\u53f0\u675f\u306d\u3066\u3044\u308b\u306e\u3067\u3001\u5408\u8a086CPU RAM6GB\u306b\n\u306a\u3063\u3066\u3044\u308b\u3053\u3068\u3082\u78ba\u8a8d\u3067\u304d\u307e\u3059\u3002\u3044\u3063\u305f\u3093\u3001\u3053\u3053\u307e\u3067\u3067\u30b4\u30fc\u30eb\u3002\n\n```bash\n\nvagrant@master:~$ docker -H 192.168.33.11:12375 info                                                                                                                                               \nContainers: 3                                                                                                                                                                                      \n Running: 3                                                                                                                                                                                        \n Paused: 0                                                                                                                                                                                         \n Stopped: 0                                                                                                                                                                                        \nImages: 3                                                                                                                                                                                          \nServer Version: swarm/1.2.5                                                                                                                                                                        \nRole: primary                                                                                                                                                                                      \nStrategy: spread                                                                                                                                                                                   \nFilters: health, port, containerslots, dependency, affinity, constraint                                                                                                                            \nNodes: 3                                                                                                                                                                                           \n slave-1: 192.168.33.12:2376                                                                                                                                                                       \n  \u2514 ID: EEZI:UKFK:G2F2:SNWF:C3R6:2NWN:PBJV:XO5R:XB34:I5TL:MMNE:ETXN                                                                                                                               \n  \u2514 Status: Healthy                                                                                                                                                                               \n  \u2514 Containers: 1 (1 Running, 0 Paused, 0 Stopped)                                                                                                                                                \n  \u2514 Reserved CPUs: 0 / 2                                                                                                                                                                          \n  \u2514 Reserved Memory: 0 B / 2.053 GiB                                                                                                                                                              \n  \u2514 Labels: kernelversion=3.13.0-103-generic, operatingsystem=Ubuntu 14.04.5 LTS, storagedriver=aufs                                                                                              \n  \u2514 UpdatedAt: 2016-12-06T15:13:17Z                                                                                                                                                               \n  \u2514 ServerVersion: 1.12.3                                                                                                                                                                         \n slave-2: 192.168.33.13:2376                                                                                                                                                                       \n  \u2514 ID: O53J:5CP5:D2SL:JR3G:B7KG:E2B6:OWEF:WY36:NWPQ:25FZ:6PVT:DQOW                                                                                                                               \n  \u2514 Status: Healthy                                                                                                                                                                               \n  \u2514 Containers: 1 (1 Running, 0 Paused, 0 Stopped)                                                                                                                                                \n  \u2514 Reserved CPUs: 0 / 2                                                                                                                                                                          \n  \u2514 Reserved Memory: 0 B / 2.053 GiB                                                                                                                                                              \n  \u2514 Labels: kernelversion=3.13.0-103-generic, operatingsystem=Ubuntu 14.04.5 LTS, storagedriver=aufs                                                                                              \n  \u2514 UpdatedAt: 2016-12-06T15:13:18Z                                                                                                                                                               \n  \u2514 ServerVersion: 1.12.3                                                                                                                                                                         \n slave-3: 192.168.33.14:2376                                                                                                                                                                       \n  \u2514 ID: IB4U:UUJB:RCTB:R7NZ:LBYR:3ZB2:WOR6:2IPA:MLYM:IAMA:T45L:FKGZ                                                                                                                               \n  \u2514 Status: Healthy                                                                                                                                                                               \n  \u2514 Containers: 1 (1 Running, 0 Paused, 0 Stopped)                                                                                                                                                \n  \u2514 Reserved CPUs: 0 / 2                                                                                                                                                                          \n  \u2514 Reserved Memory: 0 B / 2.053 GiB                                                                                                                                                              \n  \u2514 Labels: kernelversion=3.13.0-103-generic, operatingsystem=Ubuntu 14.04.5 LTS, storagedriver=aufs                                                                                              \n  \u2514 UpdatedAt: 2016-12-06T15:14:01Z                                                                                                                                                               \n  \u2514 ServerVersion: 1.12.3\nPlugins:                                                                                                                                                                                           \n Volume:                                                                                                                                                                                           \n Network:                                                                                                                                                                                          \nSwarm:                                                                                                                                                                                             \n NodeID:                                                                                                                                                                                           \n Is Manager: false                                                                                                                                                                                 \n Node Address:                                                                                                                                                                                     \nSecurity Options:                                                                                                                                                                                  \nKernel Version: 3.13.0-103-generic                                                                                                                                                                 \nOperating System: linux                                                                                                                                                                            \nArchitecture: amd64                                                                                                                                                                                \nCPUs: 6                                                                                                                                                                                            \nTotal Memory: 6.158 GiB                                                                                                                                                                            \nName: f8e6c11a239c                                                                                                                                                                                 \nDocker Root Dir:                                                                                                                                                                                   \nDebug Mode (client): false                                                                                                                                                                         \nDebug Mode (server): false                                                                                                                                                                         \nWARNING: No kernel memory limit support\n```\n"}