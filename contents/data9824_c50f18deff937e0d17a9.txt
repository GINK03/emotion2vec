{"tags": ["R", "PRML"], "context": " More than 1 year has passed since last update.PRML 9.1\u306b\u8a18\u8f09\u306e\u901a\u308a\u3001K-means\u30af\u30e9\u30b9\u30bf\u30ea\u30f3\u30b0\u304c\u884c\u308f\u308c\u308b\u904e\u7a0b\u3068\u3001\u30b3\u30b9\u30c8\u95a2\u6570\u306e\u53ce\u675f\u306e\u69d8\u5b50\u3092\u793a\u3057\u307e\u3059\u3002\n\nlibrary(MASS)\nframe()\nset.seed(0)\npar(mfrow=c(4, 4))\npar(mar=c(2.5, 2.5, 1, 0.1))\npar(mgp=c(1.3, 0.5, 0))\nxrange <- c(-2, 2)\nyrange <- c(-2, 2)\nD <- 2\nK <- 2\ndata(faithful)\nx <- as.matrix(faithful)\nN <- nrow(x)\n#N <- 100\n#x <- mvrnorm(N / 2, c(-1, -1), matrix(c(.4, 0, 0, .4), D))\n#x <- rbind(x, mvrnorm(N / 2, c(1, 1), matrix(c(.4, 0, 0, .4), D)))\nx <- t((t(x) - apply(x, 2, mean)) / apply(x, 2, sd))  # normalize\nmu <- matrix(c(-1, 1, 1, -1), K, byrow=T)\nr <- matrix(NA, nrow=N, ncol=K)\nj <- numeric()\n\ncost <- function() {\n    sum(sapply(1:N, function(n)\n        sum(r[n, ] * rowSums(t(x[n, ] - t(mu)) ^ 2))\n        ))\n}\n\niteration <- 0\nrepeat {\n    iteration <- iteration + 1\n\n    # E step\n    for (n in 1:N) {\n        diff <- numeric(K)\n        for (k in 1:K) {\n            diff[k] <- sum((x[n, ] - mu[k, ]) ^ 2)\n        }\n        minK <- which.min(diff)\n        r[n, minK] <- 1\n        r[n, -minK] <- 0\n    }\n    j <- c(j, cost())\n    plot(x, xlim=xrange, ylim=yrange, col=hsv(0.4 * apply(r, 1, function(r) which(r == 1) - 1)), pch=16)\n    par(new=T)\n    plot(mu, xlim=xrange, ylim=yrange, xlab=\"\", ylab=\"\", col=hsv((1:K - 1) * 0.4, 1, 0.8), pch=0, cex=2)\n    title(paste0(\"E step#\", iteration))\n\n    # M step\n    for (k in 1:K) {\n        mu[k, ] <- colSums(x * r[, k]) / sum(r[, k])\n    }\n    j <- c(j, cost())\n    plot(x, xlim=xrange, ylim=yrange, col=hsv(0.4 * apply(r, 1, function(r) which(r == 1) - 1)), pch=1)\n    par(new=T)\n    plot(mu, xlim=xrange, ylim=yrange, xlab=\"\", ylab=\"\", col=hsv((1:K - 1) * 0.4, 1, 0.8), pch=15, cex=2)\n    title(paste0(\"M step#\", iteration))\n\n    if (length(j) > 2 && j[length(j)] == j[length(j) - 2]) {\n        break\n    }\n}\n\nnames(j) <- paste0(rep(1:(length(j) / 2), each=2), c(\"E\", \"M\"))\nplot(j, type=\"o\", axes=F, xlab=\"iteration\")\naxis(1, at=1:length(j), labels=names(j))\naxis(2)\ntitle(\"cost\")\n\nPRML 9.1\u306b\u8a18\u8f09\u306e\u901a\u308a\u3001K-means\u30af\u30e9\u30b9\u30bf\u30ea\u30f3\u30b0\u304c\u884c\u308f\u308c\u308b\u904e\u7a0b\u3068\u3001\u30b3\u30b9\u30c8\u95a2\u6570\u306e\u53ce\u675f\u306e\u69d8\u5b50\u3092\u793a\u3057\u307e\u3059\u3002\n\n![](https://dl.dropbox.com/sh/cwfemibvr7gk4cy/sQPmUsfoT1/21.KMeansClustering.png)\n\n```r\nlibrary(MASS)\nframe()\nset.seed(0)\npar(mfrow=c(4, 4))\npar(mar=c(2.5, 2.5, 1, 0.1))\npar(mgp=c(1.3, 0.5, 0))\nxrange <- c(-2, 2)\nyrange <- c(-2, 2)\nD <- 2\nK <- 2\ndata(faithful)\nx <- as.matrix(faithful)\nN <- nrow(x)\n#N <- 100\n#x <- mvrnorm(N / 2, c(-1, -1), matrix(c(.4, 0, 0, .4), D))\n#x <- rbind(x, mvrnorm(N / 2, c(1, 1), matrix(c(.4, 0, 0, .4), D)))\nx <- t((t(x) - apply(x, 2, mean)) / apply(x, 2, sd))  # normalize\nmu <- matrix(c(-1, 1, 1, -1), K, byrow=T)\nr <- matrix(NA, nrow=N, ncol=K)\nj <- numeric()\n\ncost <- function() {\n\tsum(sapply(1:N, function(n)\n\t\tsum(r[n, ] * rowSums(t(x[n, ] - t(mu)) ^ 2))\n\t\t))\n}\n\niteration <- 0\nrepeat {\n\titeration <- iteration + 1\n\t\n\t# E step\n\tfor (n in 1:N) {\n\t\tdiff <- numeric(K)\n\t\tfor (k in 1:K) {\n\t\t\tdiff[k] <- sum((x[n, ] - mu[k, ]) ^ 2)\n\t\t}\n\t\tminK <- which.min(diff)\n\t\tr[n, minK] <- 1\n\t\tr[n, -minK] <- 0\n\t}\n\tj <- c(j, cost())\n\tplot(x, xlim=xrange, ylim=yrange, col=hsv(0.4 * apply(r, 1, function(r) which(r == 1) - 1)), pch=16)\n\tpar(new=T)\n\tplot(mu, xlim=xrange, ylim=yrange, xlab=\"\", ylab=\"\", col=hsv((1:K - 1) * 0.4, 1, 0.8), pch=0, cex=2)\n\ttitle(paste0(\"E step#\", iteration))\n\t\n\t# M step\n\tfor (k in 1:K) {\n\t\tmu[k, ] <- colSums(x * r[, k]) / sum(r[, k])\n\t}\n\tj <- c(j, cost())\n\tplot(x, xlim=xrange, ylim=yrange, col=hsv(0.4 * apply(r, 1, function(r) which(r == 1) - 1)), pch=1)\n\tpar(new=T)\n\tplot(mu, xlim=xrange, ylim=yrange, xlab=\"\", ylab=\"\", col=hsv((1:K - 1) * 0.4, 1, 0.8), pch=15, cex=2)\n\ttitle(paste0(\"M step#\", iteration))\n\t\n\tif (length(j) > 2 && j[length(j)] == j[length(j) - 2]) {\n\t\tbreak\n\t}\n}\n\nnames(j) <- paste0(rep(1:(length(j) / 2), each=2), c(\"E\", \"M\"))\nplot(j, type=\"o\", axes=F, xlab=\"iteration\")\naxis(1, at=1:length(j), labels=names(j))\naxis(2)\ntitle(\"cost\")\n```\n"}