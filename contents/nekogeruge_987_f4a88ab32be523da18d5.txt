{"context": " More than 1 year has passed since last update.\n\n\u3084\u3063\u3066\u308b\u3053\u3068\n\nec2\u306eip\u3092\u52d5\u7684\u306b\u53d6\u5f97\n\u53d6\u5f97\u3057\u305fip\u306b\u5bfe\u3057\u3001Serverspec\u3092\u5b9f\u884c\u3059\u308btask\u3092\u52d5\u7684\u306b\u5b9a\u7fa9\n\u4e0a\u8a18\u306etask\u3092\u5168\u3066\u5b9f\u884c\u3059\u308btask\u3092\u5b9a\u7fa9\naws\u306eaccess key\u60c5\u5831\u304c\u74b0\u5883\u5909\u6570\u3067\u6307\u5b9a\u3055\u308c\u3066\u306a\u3044\u5834\u5408\u3001ec2\u306e\u60c5\u5831\u3092\u53d6\u5f97\u3057\u306a\u3044\n\n\n\u524d\u63d0\u53ca\u3073\u7b46\u8005\u306e\u74b0\u5883\n\naws-sdk\u306fv1\u3092\u4f7f\u7528\n\nvagrant\u3068\u3044\u3046\u30db\u30b9\u30c8\u306b\u5bfe\u3057\u3066\u5b9f\u884c\u3059\u308bspec\u304c\u4e88\u3081\u5b58\u5728\u3057\u3066\u3044\u308b\n\n$ ls -la spec\n\n-rw-r--r--  1 nekogeruge staff 640  2 16 14:34 spec_helper.rb\ndrwxr-xr-x  4 nekogeruge staff 136  1 13 17:42 vagrant\n\n\nec2\u306b\u5b9f\u884c\u3059\u308bspec\u306fvagrant\u3068\u540c\u3058\u3082\u306e\u3092\u4f7f\u7528\u3059\u308b\nServerspec\u3092\u5b9f\u884c\u3057\u305f\u3044\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306b\u306f\u3001\u8e0f\u307f\u53f0\u30b5\u30fc\u30d0\u3092\u4ecb\u3057\u305f\u591a\u6bb5ssh\u3092\u4f7f\u7528\u3057\u3066\u63a5\u7d9a\u3057\u3066\u304a\u308a\u3001\u4e0b\u8a18\u306e\u3088\u3046\u306a.ssh/config\u304c\u66f8\u3044\u3066\u3042\u308b\n\nHost bastion\n  HostName 99.999.99.999\n  Port 22\n  User ec2-user\n  IdentityFile ~/.ssh/bastion.pem\n  TCPKeepAlive yes\n  PasswordAuthentication no\nHost 10.0.1.*\n  Port 22\n  User ec2-user\n  IdentityFile ~/.ssh/internal.pem\n  ProxyCommand ssh bastion -W %h:%p\n\n\nRakefile\nrequire 'rake'\nrequire 'rspec/core/rake_task'\nrequire 'aws-sdk-v1'\n\n#\n# AWS\u306eaccess key\u60c5\u5831\u304c\u74b0\u5883\u5909\u6570\u306b\u542b\u307e\u308c\u3066\u3044\u308b\u6642\u306e\u307f\n# ec2\u306eip\u3092\u53d6\u5f97\u3059\u308b\n#\nif ENV['AWS_ACCESS_KEY_ID'] && ENV['AWS_SECRET_ACCESS_KEY']\n  AWS.config(\n    {\n      access_key_id: ENV['AWS_ACCESS_KEY_ID'],\n      secret_access_key: ENV['AWS_SECRET_ACCESS_KEY'],\n      region: 'ap-northeast-1'\n    }\n  )\n\n  ec2_hosts = AWS.ec2.instances.select { |i| i.status == :running }.map(&:private_ip_address)\nend\n\ntask :spec    => 'spec:all'\ntask :default => :spec\n\nnamespace :spec do\n  targets = []\n\n  Dir.glob('./spec/*').each do |dir|\n    next unless File.directory?(dir)\n    targets << File.basename(dir)\n  end\n\n  task :all     => targets\n  task :default => :all\n\n  #\n  # \u53d6\u5f97\u3057\u305fec2\u306eip\u306etask\u3092\u4f5c\u6210\n  #\n  if ec2_hosts\n    ec2_hosts.each do |host|\n      desc \"Run serverspec tests to ec2 {host}\"\n      RSpec::Core::RakeTask.new(host.to_sym) do |t|\n        ENV['TARGET_HOST'] = host\n        t.pattern = \"spec/vagrant/*_spec.rb\"\n      end\n    end\n\n    #\n    # \u4e0a\u3067\u4f5c\u6210\u3057\u305ftask\u3092\u5168\u3066\u5b9f\u884c\u3059\u308b\n    # spec:ec2\u3068\u3044\u3046task\u3092\u4f5c\u6210\n    #\n    desc \"Run serverspec tests to all ec2 host\"\n    task :ec2 => ec2_hosts.map { |host| \"spec:#{host}\" }\n  end\n\n  targets.each do |target|\n    desc \"Run serverspec tests to #{target}\"\n    RSpec::Core::RakeTask.new(target.to_sym) do |t|\n      ENV['TARGET_HOST'] = target\n      t.pattern = \"spec/#{target}/*_spec.rb\"\n    end\n  end\nend\n\n\n\u5b9f\u884c\n\naws\u95a2\u9023\u306e\u74b0\u5883\u5909\u6570\u7121\u3057\n\n$ rake -T\n\nrake spec:vagrant  # Run serverspec tests to vagrant\n\n\n\u6709\u308a\n\n\n\nenvchain\u4f7f\u7528\n\u4f8b\u3068\u3057\u3066aws_staging\u3068\u3044\u3046namespace\u3092\u4f7f\u7528\u3057\u3066\u3044\u307e\u3059\n\n\n\n$ envchain aws_staging rake -T\n\nrake spec:10.0.1.100    # Run serverspec tests to ec2 10.0.1.100\nrake spec:10.0.1.101    # Run serverspec tests to ec2 10.0.1.101\nrake spec:10.0.1.102    # Run serverspec tests to ec2 10.0.1.102\nrake spec:ec2           # Run serverspec tests to all ec2 host\nrake spec:vagrant       # Run serverspec tests to vagrant\n\n\n\nrake spec:ec2\u3092\u5b9f\u884c\u3059\u308b\u3068\u300110.0.1.100\u300110.0.1.100\u300110.0.1.102\u306b\u5bfe\u3057\u3066Serverspec\u3092\u5b9f\u884c\u3059\u308btask\u304c\u9806\u756a\u306b\u5b9f\u884c\u3055\u308c\u308b\n\n$ envchain aws_staging rake spec:ec2\n\n...\n\n\n\u554f\u984c\u70b9\u3068\u89e3\u6c7a\u7b56\n\u5b9f\u884c\u3057\u3066\u307f\u308b\u3068\u3001spec\u306e\u7d50\u679c\u306bip\u304c\u8868\u793a\u3055\u308c\u306a\u3044\u3002\nspec_helper.rb\u306b\u4e0b\u8a18\u3092\u8ffd\u8a18\u3059\u308b\u3053\u3068\u306b\u3088\u308a\u3001\u7d50\u679c\u306b\u30db\u30b9\u30c8\u540d\u53ca\u3073ip\u304c\u8868\u793a\u3055\u308c\u308b\u3088\u3046\u306b\u306a\u308b\n\nspec_helper.rb\nputs \"\\nHost: #{ENV['TARGET_HOST']}\"\n\n\n$ envchain aws_staging rake spec:ec2\n\nHost: 10.0.1.100\n...\n\nHost: 10.0.1.101\n...\n\nHost: 10.0.1.102\n...\n\n\n\u53c2\u8003\n\nIP\u304c\u5909\u308f\u308a\u3086\u304fAWS EC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306bServerspec\u6d41\u3059\u5834\u5408\u306b\u3064\u3044\u3066\u672c\u6c17\u51fa\u3057\u3066\u8003\u3048\u3066\u307f\u305f\nHow to share Serverspec tests among hosts\n\n# \u3084\u3063\u3066\u308b\u3053\u3068\n\n- ec2\u306eip\u3092\u52d5\u7684\u306b\u53d6\u5f97\n- \u53d6\u5f97\u3057\u305fip\u306b\u5bfe\u3057\u3001Serverspec\u3092\u5b9f\u884c\u3059\u308btask\u3092\u52d5\u7684\u306b\u5b9a\u7fa9\n- \u4e0a\u8a18\u306etask\u3092\u5168\u3066\u5b9f\u884c\u3059\u308btask\u3092\u5b9a\u7fa9\n- aws\u306eaccess key\u60c5\u5831\u304c\u74b0\u5883\u5909\u6570\u3067\u6307\u5b9a\u3055\u308c\u3066\u306a\u3044\u5834\u5408\u3001ec2\u306e\u60c5\u5831\u3092\u53d6\u5f97\u3057\u306a\u3044\n\n# \u524d\u63d0\u53ca\u3073\u7b46\u8005\u306e\u74b0\u5883\n\n- aws-sdk\u306fv1\u3092\u4f7f\u7528\n- `vagrant`\u3068\u3044\u3046\u30db\u30b9\u30c8\u306b\u5bfe\u3057\u3066\u5b9f\u884c\u3059\u308bspec\u304c\u4e88\u3081\u5b58\u5728\u3057\u3066\u3044\u308b\n\n```console\n$ ls -la spec\n\n-rw-r--r--  1 nekogeruge staff 640  2 16 14:34 spec_helper.rb\ndrwxr-xr-x  4 nekogeruge staff 136  1 13 17:42 vagrant\n```\n- ec2\u306b\u5b9f\u884c\u3059\u308bspec\u306f`vagrant`\u3068\u540c\u3058\u3082\u306e\u3092\u4f7f\u7528\u3059\u308b\n- Serverspec\u3092\u5b9f\u884c\u3057\u305f\u3044\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306b\u306f\u3001\u8e0f\u307f\u53f0\u30b5\u30fc\u30d0\u3092\u4ecb\u3057\u305f\u591a\u6bb5ssh\u3092\u4f7f\u7528\u3057\u3066\u63a5\u7d9a\u3057\u3066\u304a\u308a\u3001\u4e0b\u8a18\u306e\u3088\u3046\u306a`.ssh/config`\u304c\u66f8\u3044\u3066\u3042\u308b\n\n```\nHost bastion\n  HostName 99.999.99.999\n  Port 22\n  User ec2-user\n  IdentityFile ~/.ssh/bastion.pem\n  TCPKeepAlive yes\n  PasswordAuthentication no\nHost 10.0.1.*\n  Port 22\n  User ec2-user\n  IdentityFile ~/.ssh/internal.pem\n  ProxyCommand ssh bastion -W %h:%p\n```\n\n# Rakefile\n\n```rb\nrequire 'rake'\nrequire 'rspec/core/rake_task'\nrequire 'aws-sdk-v1'\n\n#\n# AWS\u306eaccess key\u60c5\u5831\u304c\u74b0\u5883\u5909\u6570\u306b\u542b\u307e\u308c\u3066\u3044\u308b\u6642\u306e\u307f\n# ec2\u306eip\u3092\u53d6\u5f97\u3059\u308b\n#\nif ENV['AWS_ACCESS_KEY_ID'] && ENV['AWS_SECRET_ACCESS_KEY']\n  AWS.config(\n    {\n      access_key_id: ENV['AWS_ACCESS_KEY_ID'],\n      secret_access_key: ENV['AWS_SECRET_ACCESS_KEY'],\n      region: 'ap-northeast-1'\n    }\n  )\n\n  ec2_hosts = AWS.ec2.instances.select { |i| i.status == :running }.map(&:private_ip_address)\nend\n\ntask :spec    => 'spec:all'\ntask :default => :spec\n\nnamespace :spec do\n  targets = []\n\n  Dir.glob('./spec/*').each do |dir|\n    next unless File.directory?(dir)\n    targets << File.basename(dir)\n  end\n\n  task :all     => targets\n  task :default => :all\n\n  #\n  # \u53d6\u5f97\u3057\u305fec2\u306eip\u306etask\u3092\u4f5c\u6210\n  #\n  if ec2_hosts\n    ec2_hosts.each do |host|\n      desc \"Run serverspec tests to ec2 {host}\"\n      RSpec::Core::RakeTask.new(host.to_sym) do |t|\n        ENV['TARGET_HOST'] = host\n        t.pattern = \"spec/vagrant/*_spec.rb\"\n      end\n    end\n\n    #\n    # \u4e0a\u3067\u4f5c\u6210\u3057\u305ftask\u3092\u5168\u3066\u5b9f\u884c\u3059\u308b\n    # spec:ec2\u3068\u3044\u3046task\u3092\u4f5c\u6210\n    #\n    desc \"Run serverspec tests to all ec2 host\"\n    task :ec2 => ec2_hosts.map { |host| \"spec:#{host}\" }\n  end\n\n  targets.each do |target|\n    desc \"Run serverspec tests to #{target}\"\n    RSpec::Core::RakeTask.new(target.to_sym) do |t|\n      ENV['TARGET_HOST'] = target\n      t.pattern = \"spec/#{target}/*_spec.rb\"\n    end\n  end\nend\n```\n\n# \u5b9f\u884c\n\n- aws\u95a2\u9023\u306e\u74b0\u5883\u5909\u6570\u7121\u3057\n\n```console\n$ rake -T\n\nrake spec:vagrant  # Run serverspec tests to vagrant\n```\n\n- \u6709\u308a\n  - [envchain](https://github.com/sorah/envchain)\u4f7f\u7528\n    - \u4f8b\u3068\u3057\u3066`aws_staging`\u3068\u3044\u3046namespace\u3092\u4f7f\u7528\u3057\u3066\u3044\u307e\u3059\n\n```console\n$ envchain aws_staging rake -T\n\nrake spec:10.0.1.100    # Run serverspec tests to ec2 10.0.1.100\nrake spec:10.0.1.101    # Run serverspec tests to ec2 10.0.1.101\nrake spec:10.0.1.102    # Run serverspec tests to ec2 10.0.1.102\nrake spec:ec2           # Run serverspec tests to all ec2 host\nrake spec:vagrant       # Run serverspec tests to vagrant\n```\n\n- `rake spec:ec2`\u3092\u5b9f\u884c\u3059\u308b\u3068\u3001`10.0.1.100`\u3001`10.0.1.100`\u3001`10.0.1.102`\u306b\u5bfe\u3057\u3066Serverspec\u3092\u5b9f\u884c\u3059\u308btask\u304c\u9806\u756a\u306b\u5b9f\u884c\u3055\u308c\u308b\n\n```console\n$ envchain aws_staging rake spec:ec2\n\n...\n```\n\n# \u554f\u984c\u70b9\u3068\u89e3\u6c7a\u7b56\n\n\u5b9f\u884c\u3057\u3066\u307f\u308b\u3068\u3001spec\u306e\u7d50\u679c\u306bip\u304c\u8868\u793a\u3055\u308c\u306a\u3044\u3002\n`spec_helper.rb`\u306b\u4e0b\u8a18\u3092\u8ffd\u8a18\u3059\u308b\u3053\u3068\u306b\u3088\u308a\u3001\u7d50\u679c\u306b\u30db\u30b9\u30c8\u540d\u53ca\u3073ip\u304c\u8868\u793a\u3055\u308c\u308b\u3088\u3046\u306b\u306a\u308b\n\n```spec_helper.rb\nputs \"\\nHost: #{ENV['TARGET_HOST']}\"\n```\n\n```console\n$ envchain aws_staging rake spec:ec2\n\nHost: 10.0.1.100\n...\n\nHost: 10.0.1.101\n...\n\nHost: 10.0.1.102\n...\n```\n\n# \u53c2\u8003\n\n- [IP\u304c\u5909\u308f\u308a\u3086\u304fAWS EC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306bServerspec\u6d41\u3059\u5834\u5408\u306b\u3064\u3044\u3066\u672c\u6c17\u51fa\u3057\u3066\u8003\u3048\u3066\u307f\u305f](http://ksss9.hatenablog.com/entry/2015/02/14/203935)\n- [How to share Serverspec tests among hosts](http://serverspec.org/advanced_tips.html)\n", "tags": ["serverspec", "AWS", "Ruby"]}