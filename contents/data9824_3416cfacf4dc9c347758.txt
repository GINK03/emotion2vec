{"tags": ["R", "PRML"], "context": " \u3053\u306e\u8a18\u4e8b\u306f\u6700\u7d42\u66f4\u65b0\u65e5\u304b\u30891\u5e74\u4ee5\u4e0a\u304c\u7d4c\u904e\u3057\u3066\u3044\u307e\u3059\u3002PRML\u56f36.3\u3068\u540c\u69d8\u306b\u3001Nadaraya-Watson\u30e2\u30c7\u30eb\uff08\u30ab\u30fc\u30cd\u30eb\u56de\u5e30\uff09\u306b\u3088\u308a\u3001\u4ee5\u4e0b\u3092\u56f3\u793a\u3057\u307e\u3059\u3002\n\n\u56de\u5e30\u95a2\u6570\uff08\u6761\u4ef6\u4ed8\u304d\u671f\u5f85\u5024\uff09 E[t|x]=\u2211Nn=1k(x,xn)tnE[t|x]=\u2211n=1Nk(x,xn)tnE[t|x]=\\sum_{n=1}^Nk(x,x_n)t_n\n\u6761\u4ef6\u4ed8\u304d\u78ba\u7387\u5bc6\u5ea6 p(t|x)=1(2\u03c0\u03c32)1/2\u2211Nn=1exp(\u2212(t\u2212tn)22\u03c32)k(x,xn)p(t|x)=1(2\u03c0\u03c32)1/2\u2211n=1Nexp\u2061(\u2212(t\u2212tn)22\u03c32)k(x,xn)p(t|x)=\\frac{1}{(2\\pi\\sigma^2)^{1/2}}\\sum_{n=1}^{N}\\exp(-\\frac{(t-t_n)^2}{2\\sigma^2})k(x,x_n)\n\u6761\u4ef6\u4ed8\u304d\u5206\u6563 Var(t|x)=\u2211Nn=1(\u03c32+t2n)k(x,xn)\u2212E[t|x]2Var(t|x)=\u2211n=1N(\u03c32+tn2)k(x,xn)\u2212E[t|x]2Var(t|x)=\\sum_{n=1}^N(\\sigma^2+t_n^2)k(x,x_n)-E[t|x]^2\n\n\u307e\u305f\u3001\u5404\u89b3\u6e2c\u70b9\u306b\u95a2\u9023\u4ed8\u3051\u3089\u308c\u305f\u30ab\u30fc\u30cd\u30eb\u95a2\u6570 k(x,xn)k(x,xn)k(x,x_n) \u3082\u56f3\u793a\u3057\u307e\u3059\u3002\n\u306a\u304a\u3001\u6761\u4ef6\u4ed8\u304d\u78ba\u7387\u5bc6\u5ea6\u3001\u6761\u4ef6\u4ed8\u304d\u5206\u6563\u306f\u3001\u6f14\u7fd26.18\u3068\u540c\u3058\u304f\u3001\u5206\u6563\u3092\u03c32\u03c32\\sigma^2\u3068\u3059\u308b\u7b49\u65b9\u7684\u30ac\u30a6\u30b9\u5206\u5e03 f(x,t)f(x,t)f(x,t) \u306b\u3088\u308b\u30ab\u30fc\u30cd\u30eb k(x,xn)k(x,xn)k(x,x_n) \u3092\u7528\u3044\u3066\u6c42\u3081\u3066\u3044\u307e\u3059\u3002\nf(x,t)=N((x,t)T|0,\u03c32I)=12\u03c0\u03c32exp(\u2212x2+t22\u03c32)g(x)=\u222bf(x,t)dtk(x,xn)=g(x\u2212xn)\u2211mg(x\u2212xm)f(x,t)=N((x,t)T|0,\u03c32I)=12\u03c0\u03c32exp\u2061(\u2212x2+t22\u03c32)g(x)=\u222bf(x,t)dtk(x,xn)=g(x\u2212xn)\u2211mg(x\u2212xm){f(x,t)=N((x,t)^T|\\mathbf{0},\\sigma^2\\mathbf{I})=\\frac{1}{2\\pi\\sigma^2}\\exp(-\\frac{x^2+t^2}{2\\sigma^2}) \\\\\ng(x)=\\int f(x,t) dt \\\\\nk(x,x_n)=\\frac{g(x-x_n)}{\\sum_m g(x-x_m)}\n}\n\nframe()\nset.seed(0)\npar(mfrow=c(3, 2))\npar(mar=c(2, 2, 1, 0.1))\npar(mgp=c(1, 0.2, 0))\nxrange <- c(-0.1, 1.1)\nyrange <- c(-1.5, 1.5)\nxcell <- seq(xrange[1], xrange[2], .01)\nycell <- seq(yrange[1], yrange[2], .01)\ncolors <- rainbow(450)[256:1]\nN <- 10\nx <- seq(0, 1, 1 / (N - 1))\n#y <- rnorm(length(x), sin(2 * pi * x), 0.2)\ny <- c(0.4, 0.8, 1.1, 1.0, 0, 0.1, -1, -0.5, -0.6, 0.3)  \n\ndoplot <- function(sigma) {\n\n    # g(x)\n    g <- function(x) {\n        1 / sqrt(2 * pi * sigma ^ 2) * exp(-x ^ 2 / (2 * sigma ^ 2))\n    }\n\n    # k(x, x_n)\n    kernel <- Vectorize(function(xx, xn) {\n        g(xx - xn) / sum(g(xx - x))\n    })\n\n    # E[t|x]\n    estimate <- Vectorize(function(xx) {\n        sum(kernel(xx, x) * y)\n    })\n\n    # p(t|x)\n    p <- Vectorize(function(xx, yy) {\n        1 / sqrt(2 * pi * sigma ^ 2) * sum(exp(-(yy - y) ^ 2 / (2 * sigma ^ 2)) * kernel(xx, x))\n    })\n\n    # Var(t|x)\n    variance <- Vectorize(function(xx) {\n        sum((sigma ^ 2 + y ^ 2) * kernel(xx, x)) - estimate(xx) ^ 2\n    })\n\n    # k(x, xn)\u306e\u63cf\u753b\n    for (n in 1:N) {\n        if (n > 1) {\n            par(new=T)\n        }\n        xn <- x[n]\n        curve(kernel(x, xn), xlim=c(-0.1, 1.1), ylim=c(-0.1, 1.1), \n            xlab=ifelse(n == 1, \"x\", \"\"), ylab=\"\", axes=(n == 1), col=n)\n    }\n    title(bquote(paste(k(x, x[n]), ~ sigma, \"=\", .(sigma))))\n\n    # p(t|x)\u306e\u63cf\u753b\n    plot(x, y, xlim=xrange, ylim=yrange, xlab=\"x\", ylab=\"t\")\n    image(xcell, ycell, outer(xcell, ycell, p), xlim=xrange, ylim=yrange, col=colors, axes=F, add=T)\n\n    # \u89b3\u6e2c\u70b9\u306e\u63cf\u753b\n    par(new=T)\n    plot(x, y, xlim=xrange, ylim=yrange, xlab=\"\", ylab=\"\", axes=F)\n\n    # E[t|x], Var(t|x)\u306e\u63cf\u753b\n    par(new=T)\n    curve(estimate, xlim=xrange, ylim=yrange, xlab=\"\", ylab=\"\", axes=F, col=2)\n    hi <- function(xx){ estimate(xx) + sqrt(variance(xx)) * 2 }\n    lo <- function(xx){ estimate(xx) - sqrt(variance(xx)) * 2 }\n    par(new=T)\n    curve(hi, xlim=xrange, ylim=yrange, xlab=\"\", ylab=\"\", axes=F, col=7)\n    par(new=T)\n    curve(lo, xlim=xrange, ylim=yrange, xlab=\"\", ylab=\"\", axes=F, col=7)\n\n    legend(\"bottomleft\", c(\n        expression(\"E[t|x]\"), \n        expression(\"E[t|x]\" %+-% 2 * sqrt(\"Var[t|x]\"))\n        ), col=c(2, 7), lty=1, bg=\"gray\")\n    title(bquote(paste(\"p(t|x)\", ~ sigma, \"=\", .(sigma))))\n\n    # p(t|x)\u306et\u306b\u95a2\u3059\u308b\u7a4d\u5206\u304c1\u3067\u3042\u308b\u3053\u3068\u3092\u3001\u3044\u304f\u3064\u304b\u306ex\u3067\u78ba\u8a8d\n    for (xx in seq(0, 1, 0.1)) {\n        cat(paste0(\n            \"integral(p(t|x=\", xx ,\")dt)=\", \n            sum(sapply(seq(-10, 10, 0.01), function(yy) { p(xx, yy) * 0.01 })),\n            \"\\n\"\n            ))\n    }\n}\n\ndoplot(0.02)\ndoplot(0.06)\ndoplot(0.1)\n\nPRML\u56f36.3\u3068\u540c\u69d8\u306b\u3001Nadaraya-Watson\u30e2\u30c7\u30eb\uff08\u30ab\u30fc\u30cd\u30eb\u56de\u5e30\uff09\u306b\u3088\u308a\u3001\u4ee5\u4e0b\u3092\u56f3\u793a\u3057\u307e\u3059\u3002\n\n- \u56de\u5e30\u95a2\u6570\uff08\u6761\u4ef6\u4ed8\u304d\u671f\u5f85\u5024\uff09 $E[t|x]=\\sum_{n=1}^Nk(x,x_n)t_n$\n- \u6761\u4ef6\u4ed8\u304d\u78ba\u7387\u5bc6\u5ea6 $p(t|x)=\\frac{1}{(2\\pi\\sigma^2)^{1/2}}\\sum_{n=1}^{N}\\exp(-\\frac{(t-t_n)^2}{2\\sigma^2})k(x,x_n)$\n- \u6761\u4ef6\u4ed8\u304d\u5206\u6563 $Var(t|x)=\\sum_{n=1}^N(\\sigma^2+t_n^2)k(x,x_n)-E[t|x]^2$\n\n\u307e\u305f\u3001\u5404\u89b3\u6e2c\u70b9\u306b\u95a2\u9023\u4ed8\u3051\u3089\u308c\u305f\u30ab\u30fc\u30cd\u30eb\u95a2\u6570 $k(x,x_n)$ \u3082\u56f3\u793a\u3057\u307e\u3059\u3002\n\n\u306a\u304a\u3001\u6761\u4ef6\u4ed8\u304d\u78ba\u7387\u5bc6\u5ea6\u3001\u6761\u4ef6\u4ed8\u304d\u5206\u6563\u306f\u3001\u6f14\u7fd26.18\u3068\u540c\u3058\u304f\u3001\u5206\u6563\u3092$\\sigma^2$\u3068\u3059\u308b\u7b49\u65b9\u7684\u30ac\u30a6\u30b9\u5206\u5e03 $f(x,t)$ \u306b\u3088\u308b\u30ab\u30fc\u30cd\u30eb $k(x,x_n)$ \u3092\u7528\u3044\u3066\u6c42\u3081\u3066\u3044\u307e\u3059\u3002\n\n```math\nf(x,t)=N((x,t)^T|\\mathbf{0},\\sigma^2\\mathbf{I})=\\frac{1}{2\\pi\\sigma^2}\\exp(-\\frac{x^2+t^2}{2\\sigma^2}) \\\\\ng(x)=\\int f(x,t) dt \\\\\nk(x,x_n)=\\frac{g(x-x_n)}{\\sum_m g(x-x_m)}\n```\n\n![26.NadarayaWatson.png](https://qiita-image-store.s3.amazonaws.com/0/12670/7aebd549-8035-f0a3-b049-3abdb3037340.png)\n\n\n```r\nframe()\nset.seed(0)\npar(mfrow=c(3, 2))\npar(mar=c(2, 2, 1, 0.1))\npar(mgp=c(1, 0.2, 0))\nxrange <- c(-0.1, 1.1)\nyrange <- c(-1.5, 1.5)\nxcell <- seq(xrange[1], xrange[2], .01)\nycell <- seq(yrange[1], yrange[2], .01)\ncolors <- rainbow(450)[256:1]\nN <- 10\nx <- seq(0, 1, 1 / (N - 1))\n#y <- rnorm(length(x), sin(2 * pi * x), 0.2)\ny <- c(0.4, 0.8, 1.1, 1.0, 0, 0.1, -1, -0.5, -0.6, 0.3)  \n\ndoplot <- function(sigma) {\n\t\n\t# g(x)\n\tg <- function(x) {\n\t\t1 / sqrt(2 * pi * sigma ^ 2) * exp(-x ^ 2 / (2 * sigma ^ 2))\n\t}\n\t\n\t# k(x, x_n)\n\tkernel <- Vectorize(function(xx, xn) {\n\t\tg(xx - xn) / sum(g(xx - x))\n\t})\n\t\n\t# E[t|x]\n\testimate <- Vectorize(function(xx) {\n\t\tsum(kernel(xx, x) * y)\n\t})\n\t\n\t# p(t|x)\n\tp <- Vectorize(function(xx, yy) {\n\t\t1 / sqrt(2 * pi * sigma ^ 2) * sum(exp(-(yy - y) ^ 2 / (2 * sigma ^ 2)) * kernel(xx, x))\n\t})\n\t\n\t# Var(t|x)\n\tvariance <- Vectorize(function(xx) {\n\t\tsum((sigma ^ 2 + y ^ 2) * kernel(xx, x)) - estimate(xx) ^ 2\n\t})\n\n\t# k(x, xn)\u306e\u63cf\u753b\n\tfor (n in 1:N) {\n\t\tif (n > 1) {\n\t\t\tpar(new=T)\n\t\t}\n\t\txn <- x[n]\n\t\tcurve(kernel(x, xn), xlim=c(-0.1, 1.1), ylim=c(-0.1, 1.1), \n\t\t\txlab=ifelse(n == 1, \"x\", \"\"), ylab=\"\", axes=(n == 1), col=n)\n\t}\n\ttitle(bquote(paste(k(x, x[n]), ~ sigma, \"=\", .(sigma))))\n\n\t# p(t|x)\u306e\u63cf\u753b\n\tplot(x, y, xlim=xrange, ylim=yrange, xlab=\"x\", ylab=\"t\")\n\timage(xcell, ycell, outer(xcell, ycell, p), xlim=xrange, ylim=yrange, col=colors, axes=F, add=T)\n\t\n\t# \u89b3\u6e2c\u70b9\u306e\u63cf\u753b\n\tpar(new=T)\n\tplot(x, y, xlim=xrange, ylim=yrange, xlab=\"\", ylab=\"\", axes=F)\n\t\n\t# E[t|x], Var(t|x)\u306e\u63cf\u753b\n\tpar(new=T)\n\tcurve(estimate, xlim=xrange, ylim=yrange, xlab=\"\", ylab=\"\", axes=F, col=2)\n\thi <- function(xx){ estimate(xx) + sqrt(variance(xx)) * 2 }\n\tlo <- function(xx){ estimate(xx) - sqrt(variance(xx)) * 2 }\n\tpar(new=T)\n\tcurve(hi, xlim=xrange, ylim=yrange, xlab=\"\", ylab=\"\", axes=F, col=7)\n\tpar(new=T)\n\tcurve(lo, xlim=xrange, ylim=yrange, xlab=\"\", ylab=\"\", axes=F, col=7)\n\n\tlegend(\"bottomleft\", c(\n\t\texpression(\"E[t|x]\"), \n\t\texpression(\"E[t|x]\" %+-% 2 * sqrt(\"Var[t|x]\"))\n\t\t), col=c(2, 7), lty=1, bg=\"gray\")\n\ttitle(bquote(paste(\"p(t|x)\", ~ sigma, \"=\", .(sigma))))\n\n\t# p(t|x)\u306et\u306b\u95a2\u3059\u308b\u7a4d\u5206\u304c1\u3067\u3042\u308b\u3053\u3068\u3092\u3001\u3044\u304f\u3064\u304b\u306ex\u3067\u78ba\u8a8d\n\tfor (xx in seq(0, 1, 0.1)) {\n\t\tcat(paste0(\n\t\t\t\"integral(p(t|x=\", xx ,\")dt)=\", \n\t\t\tsum(sapply(seq(-10, 10, 0.01), function(yy) { p(xx, yy) * 0.01 })),\n\t\t\t\"\\n\"\n\t\t\t))\n\t}\n}\n\ndoplot(0.02)\ndoplot(0.06)\ndoplot(0.1)\n```\n"}