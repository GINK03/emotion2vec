{"context": "\n\nwindows + docker-compose + rails\u74b0\u5883\ndocker-compose\u306a\u3069\u5165\u3063\u3066\u308b\u524d\u63d0\u3067\u3059\u3002\n\n1 \u6700\u4f4e\u9650\u6e96\u5099\u3059\u308b\u30d5\u30a1\u30a4\u30eb\n\nDockerfile\ndocker-compose.yml\nGemfile\nGemfile.lock(\u7a7a)\n\n\n2 \u305d\u308c\u305e\u308c\u306e\u30d5\u30a1\u30a4\u30eb\u306e\u5185\u5bb9\n\n\nDockerfile (docker-hub\u306e\u516c\u5f0frails\u306b\u3042\u308b onbuild\u3092\u6539\u826f)\n\u203b \u516c\u5f0f\u306e\u7269\u306b\u95a2\u3057\u3066\u306f ONBUILD \u3067 bundler\u3092\u5229\u7528\u3057\u3066\u3044\u308b\u70ba\u3001docker-compose\u306b\u3042\u308b\u30c1\u30e5\u30fc\u30c8\u30ea\u30a2\u30eb\u306e\u3088\u3046\u306a\n\u5f62\u3067rails new \u306a\u3069\u3092\u884c\u304a\u3046\u3068\u3059\u308b\u3068 bundle in bundle \u56fa\u6709\u306e\u30a8\u30e9\u30fc\u304c\u304a\u3053\u308b\u3002\u203b\u53c2\u7167\n\n\n# FROM rails:onbuild\n\nFROM ruby:2.3\n\n# throw errors if Gemfile has been modified since Gemfile.lock\n# RUN bundle config --global frozen 1\n\n# ------- add\nRUN apt-get update -qq && apt-get install -y build-essential libpq-dev postgresql-client\n\n# ------ add and modify\nWORKDIR /tmp\nCOPY Gemfile Gemfile\nCOPY Gemfile.lock Gemfile.lock\nRUN bundle install\n\nRUN mkdir -p /usr/src/app\nADD . /usr/src/app\nWORKDIR /usr/src/app\n\n# ONBUILD COPY Gemfile /usr/src/app/\n# ONBUILD COPY Gemfile.lock /usr/src/app/\n# ONBUILD RUN bundle install\n\n\n# COPY . /usr/src/app\n\nRUN apt-get update && apt-get install -y nodejs --no-install-recommends && rm -rf /var/lib/apt/lists/*\n\n# pos\n# RUN apt-get update && apt-get install -y mysql-client sqlite3 --no-install-recommends && rm -rf /var/lib/apt/lists/*\n\n# EXPOSE 3000\n# CMD [\"rails\", \"server\", \"-b\", \"0.0.0.0\"]\n\n\u3044\u304f\u3064\u304b\u3001\u30b4\u30df\u3063\u307d\u3044\u306a\u3068\u601d\u3046\u30d5\u30a1\u30a4\u30eb\u3068\u304b\u6b8b\u3063\u3066\u307e\u3059\u304c\u3001\u3068\u308a\u3042\u3048\u305a\u306f\u3053\u306e\u72b6\u614b\u3067\u52d5\u4f5c\u3059\u308b\u306e\u3067\u826f\u3057\u3068\u3057\u307e\u3059\u3002\n\n\n\ndocker-compose.yml\nonbuild\u306e\u4e2d\u306b\u3042\u3063\u305frails\u306e\u30d3\u30eb\u30c8\u30a4\u30f3\u30b5\u30fc\u30d0\u30fc\u3092\u3053\u3061\u3089\u306b\u8a18\u8ff0\u3057\u3066\u3044\u307e\u3059\u3002\n\u307e\u305f\u3001postgres\u30b3\u30f3\u30c6\u30ca\u3068\u306e\u30ea\u30f3\u30af\u3092\u8a18\u8ff0\u3057\u3066\u3042\u308a\u307e\u3059\u3002\n\n\nversion: '2'\nservices:\n  db:\n    image: postgres\n    expose:\n      - \"5432\"\n    environment:\n      POSTGRES_PASSWORD: password\n  web:\n    build: .\n    command: bundle exec rails s -p 3000 -b '0.0.0.0'\n    volumes:\n      - .:/usr/src/app\n    ports:\n      - \"3000:3000\"\n    depends_on:\n      - db\n\n\n\u3053\u306e\u8a2d\u5b9a\u3067rails new \u307e\u3067\u884c\u3048\u305f\u5834\u5408\u306frails\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u5185\u306b\u3042\u308b\nconfig/database.yml\u306e development\u306b\n\nusername: postgres\npassword: password\nhost: \u751f\u6210\u3057\u305fdb\u30b3\u30f3\u30c6\u30ca\u306e\u540d\u524d\n\n\u306e\u8a2d\u5b9a\u304c\u5fc5\u8981\u306b\u306a\u308a\u307e\u3059\u3002\n\n\nGemfile\n\nsource 'https://rubygems.org'\ngem 'rails', '4.2.6'\n\n\u3068\u304b\u30025.0.0\u4ee5\u964d\u306e\u5834\u5408\u306f gem 'rails', '>= 5.0.0.beta3', '< 5.1' \u3068\u304b\n\n\nGemfile.lock(\u7a7a)\n\n\n3 \u30b3\u30f3\u30c6\u30ca\u4f5c\u6210\u304b\u3089\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u4f5c\u6210\u307e\u3067\u306e\u6d41\u308c\n\n3-1 \u30b3\u30f3\u30c6\u30ca\u30a4\u30e1\u30fc\u30b8\u306e\u4f5c\u6210\ndocker-compose build\n\n\n\n3-2 rails new . / rails\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u306e\u4f5c\u6210\n\u203b\u3053\u308c\u3067\u30a8\u30e9\u30fc\u304c\u51fa\u308b\u5834\u5408\ndocker-compose run -d web rails new . --force --database=postgresql --skip-bundle\n\u2193\n\u203b\u3053\u3061\u3089\u3067\u5bfe\u51e6\ndocker-compose run -d web bundle exec rails new . --force --database=postgresql --skip-bundle\n\n\n\n3-3 rails new \u3057\u305f\u3042\u3068\u3067\u3001\u518d\u5ea6 docker-compose build\u3057\u76f4\u3059\n\u3053\u306e\u307e\u307e\u3060\u3068 gem\u304c\u8272\u3005\u7121\u3044\u3088\u3068\u8a00\u308f\u308c\u308b\u306e\u3067\u3002\n\n3-4 /config/database.yml\u306e\u4fee\u6b63\nconfig/database.yml\u306e development\u306b\n\nusername: postgres\npassword: password\nhost: \u751f\u6210\u3057\u305fdb\u30b3\u30f3\u30c6\u30ca\u306e\u540d\u524d\n\n\u30b3\u30f3\u30c6\u30ca\u540d\u306e\u30d1\u30bf\u30fc\u30f3\u306f\u3001 \u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u30d5\u30a9\u30eb\u30c0\u306e\u540d\u524d\u306b\u4f9d\u5b58\u3057\u3066\u307e\u3059\u3002\nrailstest \u30d5\u30a9\u30eb\u30c0\u306a\u3089\u3000-> railstest_db_1\n\n3-5 docker-compose up\ndocker-compose up\n\n\u3053\u308c\u3067\u4e00\u5ea6\u30b3\u30f3\u30c6\u30ca\u3092\u7acb\u3061\u4e0a\u3052\u308b\u3002\u307e\u3060database\u306ecreate\u3068migrate\u3092\u5b9f\u884c\u3057\u3066\u306a\u3044\u306e\u3067\u3082\u3061\u308d\u3093\n\u30a8\u30e9\u30fc\u306b\u306f\u306a\u308b\u304c\u3002\ndocker-compose run -d web bundle exec rake db:setup\n\n3-6 finish!\n# windows + docker-compose + rails\u74b0\u5883\n\ndocker-compose\u306a\u3069\u5165\u3063\u3066\u308b\u524d\u63d0\u3067\u3059\u3002\n\n## 1 \u6700\u4f4e\u9650\u6e96\u5099\u3059\u308b\u30d5\u30a1\u30a4\u30eb\n\n- Dockerfile\n- docker-compose.yml\n- Gemfile\n- Gemfile.lock(\u7a7a)\n\n## 2 \u305d\u308c\u305e\u308c\u306e\u30d5\u30a1\u30a4\u30eb\u306e\u5185\u5bb9\n\n- Dockerfile (docker-hub\u306e\u516c\u5f0frails\u306b\u3042\u308b [onbuild](https://github.com/docker-library/rails/blob/9df9b5e6b1519faf22e1565c2caaebf7cc1c665b/onbuild/Dockerfile)\u3092\u6539\u826f)\n\n\t\u203b \u516c\u5f0f\u306e\u7269\u306b\u95a2\u3057\u3066\u306f ONBUILD \u3067 bundler\u3092\u5229\u7528\u3057\u3066\u3044\u308b\u70ba\u3001docker-compose\u306b\u3042\u308b\u30c1\u30e5\u30fc\u30c8\u30ea\u30a2\u30eb\u306e\u3088\u3046\u306a\n\t\u5f62\u3067rails new \u306a\u3069\u3092\u884c\u304a\u3046\u3068\u3059\u308b\u3068 bundle in bundle \u56fa\u6709\u306e\u30a8\u30e9\u30fc\u304c\u304a\u3053\u308b\u3002[\u203b\u53c2\u7167](http://ota42y.com/blog/2015/01/28/bundle-in-bundle/)\n\n```\n# FROM rails:onbuild\n\nFROM ruby:2.3\n\n# throw errors if Gemfile has been modified since Gemfile.lock\n# RUN bundle config --global frozen 1\n\n# ------- add\nRUN apt-get update -qq && apt-get install -y build-essential libpq-dev postgresql-client\n\n# ------ add and modify\nWORKDIR /tmp\nCOPY Gemfile Gemfile\nCOPY Gemfile.lock Gemfile.lock\nRUN bundle install\n\nRUN mkdir -p /usr/src/app\nADD . /usr/src/app\nWORKDIR /usr/src/app\n\n# ONBUILD COPY Gemfile /usr/src/app/\n# ONBUILD COPY Gemfile.lock /usr/src/app/\n# ONBUILD RUN bundle install\n\n\n# COPY . /usr/src/app\n\nRUN apt-get update && apt-get install -y nodejs --no-install-recommends && rm -rf /var/lib/apt/lists/*\n\n# pos\n# RUN apt-get update && apt-get install -y mysql-client sqlite3 --no-install-recommends && rm -rf /var/lib/apt/lists/*\n\n# EXPOSE 3000\n# CMD [\"rails\", \"server\", \"-b\", \"0.0.0.0\"]\n```\n\n\t\u3044\u304f\u3064\u304b\u3001\u30b4\u30df\u3063\u307d\u3044\u306a\u3068\u601d\u3046\u30d5\u30a1\u30a4\u30eb\u3068\u304b\u6b8b\u3063\u3066\u307e\u3059\u304c\u3001\u3068\u308a\u3042\u3048\u305a\u306f\u3053\u306e\u72b6\u614b\u3067\u52d5\u4f5c\u3059\u308b\u306e\u3067\u826f\u3057\u3068\u3057\u307e\u3059\u3002\n\n\n\n- docker-compose.yml\n\n\tonbuild\u306e\u4e2d\u306b\u3042\u3063\u305frails\u306e\u30d3\u30eb\u30c8\u30a4\u30f3\u30b5\u30fc\u30d0\u30fc\u3092\u3053\u3061\u3089\u306b\u8a18\u8ff0\u3057\u3066\u3044\u307e\u3059\u3002\n\t\u307e\u305f\u3001postgres\u30b3\u30f3\u30c6\u30ca\u3068\u306e\u30ea\u30f3\u30af\u3092\u8a18\u8ff0\u3057\u3066\u3042\u308a\u307e\u3059\u3002\n\n```\nversion: '2'\nservices:\n  db:\n    image: postgres\n    expose:\n      - \"5432\"\n    environment:\n      POSTGRES_PASSWORD: password\n  web:\n    build: .\n    command: bundle exec rails s -p 3000 -b '0.0.0.0'\n    volumes:\n      - .:/usr/src/app\n    ports:\n      - \"3000:3000\"\n    depends_on:\n      - db\n\n```\n\n\t\u3053\u306e\u8a2d\u5b9a\u3067rails new \u307e\u3067\u884c\u3048\u305f\u5834\u5408\u306frails\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u5185\u306b\u3042\u308b\n\tconfig/database.yml\u306e development\u306b\n\n\tusername: postgres\n\tpassword: password\n\thost: \u751f\u6210\u3057\u305fdb\u30b3\u30f3\u30c6\u30ca\u306e\u540d\u524d\n\n\t\u306e\u8a2d\u5b9a\u304c\u5fc5\u8981\u306b\u306a\u308a\u307e\u3059\u3002\n\n\n- Gemfile\n\n\n```\nsource 'https://rubygems.org'\ngem 'rails', '4.2.6'\n```\n\t\n\t\u3068\u304b\u30025.0.0\u4ee5\u964d\u306e\u5834\u5408\u306f gem 'rails', '>= 5.0.0.beta3', '< 5.1' \u3068\u304b\n\n\n- Gemfile.lock(\u7a7a)\n\n\n\n\n## 3 \u30b3\u30f3\u30c6\u30ca\u4f5c\u6210\u304b\u3089\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u4f5c\u6210\u307e\u3067\u306e\u6d41\u308c\n\n### 3-1 \u30b3\u30f3\u30c6\u30ca\u30a4\u30e1\u30fc\u30b8\u306e\u4f5c\u6210\n\n```\ndocker-compose build\n\n```\n\n### 3-2 rails new . / rails\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u306e\u4f5c\u6210\n\n```\n\u203b\u3053\u308c\u3067\u30a8\u30e9\u30fc\u304c\u51fa\u308b\u5834\u5408\ndocker-compose run -d web rails new . --force --database=postgresql --skip-bundle\n\u2193\n\u203b\u3053\u3061\u3089\u3067\u5bfe\u51e6\ndocker-compose run -d web bundle exec rails new . --force --database=postgresql --skip-bundle\n\n```\n\n\n### 3-3 rails new \u3057\u305f\u3042\u3068\u3067\u3001\u518d\u5ea6 docker-compose build\u3057\u76f4\u3059\n\n\u3053\u306e\u307e\u307e\u3060\u3068 gem\u304c\u8272\u3005\u7121\u3044\u3088\u3068\u8a00\u308f\u308c\u308b\u306e\u3067\u3002\n\n\n\n### 3-4 /config/database.yml\u306e\u4fee\u6b63\n\n\tconfig/database.yml\u306e development\u306b\n\n\tusername: postgres\n\tpassword: password\n\thost: \u751f\u6210\u3057\u305fdb\u30b3\u30f3\u30c6\u30ca\u306e\u540d\u524d\n\n\n\u30b3\u30f3\u30c6\u30ca\u540d\u306e\u30d1\u30bf\u30fc\u30f3\u306f\u3001 \u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u30d5\u30a9\u30eb\u30c0\u306e\u540d\u524d\u306b\u4f9d\u5b58\u3057\u3066\u307e\u3059\u3002\nrailstest \u30d5\u30a9\u30eb\u30c0\u306a\u3089\u3000-> railstest_db_1\n\n\n\n### 3-5 docker-compose up\n\n```\ndocker-compose up\n```\n\n\u3053\u308c\u3067\u4e00\u5ea6\u30b3\u30f3\u30c6\u30ca\u3092\u7acb\u3061\u4e0a\u3052\u308b\u3002\u307e\u3060database\u306ecreate\u3068migrate\u3092\u5b9f\u884c\u3057\u3066\u306a\u3044\u306e\u3067\u3082\u3061\u308d\u3093\n\u30a8\u30e9\u30fc\u306b\u306f\u306a\u308b\u304c\u3002\n\ndocker-compose run -d web bundle exec rake db:setup\n\n\n\n### 3-6 finish!\n\n\n\n\n", "tags": ["docker-compose", "Rails"]}