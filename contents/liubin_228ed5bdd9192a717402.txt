{"context": "\u4e00\u3064\u306eVM\u306b\u3001GlusterFS\u306eQuota\u3068Snapshot\u6a5f\u80fd\u3092\u8a66\u3057\u307e\u3057\u305f\u3001\u305d\u306e\u8a18\u9332\u3092\u6b8b\u3057\u3066\u304a\u304d\u305f\u3044\u3068\u601d\u3063\u3066\u3044\u307e\u3059\u3002\n\u5b9f\u9a13\u74b0\u5883:\n\nVagrant 1.8.1\nVirtualBox 5.0.20r106931\nGlusterFS 3.7\n\n\nVagrantfile\n\u307e\u305a\u306f\u65b0\u3057\u3044\u30cf\u30fc\u30c9\u30c7\u30a3\u30b9\u30af\u3092\u4f5c\u3063\u3066\u304a\u304d\u307e\u3059\uff1a\n  config.vm.provider :virtualbox do |vb|\n    file_to_disk = \"#{ENV[\"HOME\"]}/glusterfs.vdi\"\n    unless File.exist?(file_to_disk)\n      vb.customize ['createmedium', 'disk', '--filename', file_to_disk, '--format', 'VDI', '--size', 10 * 1024]\n      vb.customize ['storageattach', :id,\n        '--storagectl', 'IDE Controller',\n        '--port', 1,\n        '--device', 0,\n        '--type', 'hdd',\n        '--medium', file_to_disk]\n    end\n  end\n\n\n\u4e0a\u8a18\u306e\u8a2d\u5b9a\u306f\u74b0\u5883\u306b\u4f9d\u5b58\u3059\u308b\u305f\u3081\u3001\u81ea\u5206\u306e\u74b0\u5883\u306b\u5408\u308f\u305b\u3066\u4f5c\u3063\u3066\u304f\u3060\u3055\u3044\u3002\n\u8a73\u3057\u3044\u306e\u306f Vagrant\u306eVM\u306b\u8907\u6570\u306e\u30c7\u30a3\u30b9\u30af\u3092\u8ffd\u52a0\u3059\u308b\u65b9\u6cd5 \u3092\u3054\u53c2\u7167\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\nInstall Glusterfs\n\u30a6\u30a7\u30d6\u4e0a\u306b\u60c5\u5831\u304c\u591a\u3044\u3067\u3059\u306e\u3067\u3001\u3053\u3053\u3067\u7701\u7565\u3002\n\nCreate LVM Volume\n/dev/sdb \u304c\u3042\u308b\u306e\u3092\u78ba\u8a8d\uff1a\n[vagrant@g1 ~]$ ls /dev/sd\nsda   sda1  sda2  sda3  sdb   \n\nparted \u3067\u65b0\u3057\u3044\u30d1\u30c6\u30a3\u30b7\u30e7\u30f3\u3092\u4f5c\u308d\u3046\u3002\u611f\u3058\u3093\u306e\u306f lvm on \u3067\u3001Snapshot \u6a5f\u80fd\u3092\u4f7f\u3046\u305f\u3081\u306b\u5fc5\u9808\u3002\n[vagrant@g1 ~]$ sudo parted -s -a optimal /dev/sdb mklabel msdos -- mkpart primary 1 -1 set 1 lvm on\n\n/dev/sdb1 \u3092\u78ba\u8a8d\uff1a\n[vagrant@g1 ~]$ ls /dev/sd\nsda   sda1  sda2  sda3  sdb   sdb1  \n\n\u7269\u7406\u30dc\u30ea\u30e5\u30fc\u30e0\uff08pv\uff09\u3068\u30dc\u30ea\u30e5\u30fc\u30e0\u30b0\u30eb\u30fc\u30d7\uff08vg\uff09\u3092\u4f5c\u6210\uff1a\n[vagrant@g1 ~]$ sudo pvcreate /dev/sdb1\n  Physical volume \"/dev/sdb1\" successfully created\n\n[vagrant@g1 ~]$ sudo vgcreate vg0 /dev/sdb1\n  Volume group \"vg0\" successfully created\n\nthinpool \u3092\u4f5c\u6210\uff08\u540d\u524d\u306f thinp \uff09\uff1a\n[vagrant@g1 ~]$ sudo lvcreate --thin -L 1G vg0/thinp\n  Logical volume \"thinp\" created.\n\nthinp \u306b\u57fa\u3065\u3044\u3066\u30dc\u30ea\u30e5\u30fc\u30e0 data \u3092\u4f5c\u6210\u3057\u3066\u3001 mkfs.xfs \u3067\u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0\u3092\u4f5c\u308a\u307e\u3059\uff1a\n[vagrant@g1 ~]$ sudo lvcreate --thin -V 1G -n data vg0/thinp\n  Logical volume \"data\" created.\n\n\n[vagrant@g1 ~]$ sudo mkfs.xfs /dev/vg0/data \nmeta-data=/dev/vg0/data          isize=256    agcount=8, agsize=32752 blks\n         =                       sectsz=512   attr=2, projid32bit=1\n         =                       crc=0        finobt=0\ndata     =                       bsize=4096   blocks=262016, imaxpct=25\n         =                       sunit=16     swidth=16 blks\nnaming   =version 2              bsize=4096   ascii-ci=0 ftype=0\nlog      =internal log           bsize=4096   blocks=768, version=2\n         =                       sectsz=512   sunit=16 blks, lazy-count=1\nrealtime =none                   extsz=4096   blocks=0, rtextents=0\n\nLVM volume /dev/vg0/data \u3092\u30ed\u30ab\u30fc\u30eb\u306bmount\u3057\u307e\u3059\uff1a\n[vagrant@g1 ~]$ sudo mkdir -p /gfs/data\n[vagrant@g1 ~]$ sudo mount /dev/vg0/data /gfs/data\n\n\u3053\u308c\u3067\u3001 LVM \u306e Thinpool Volume \u3092\u30ed\u30ab\u30fc\u30eb\u30db\u30b9\u30c8\u306b\u30a2\u30af\u30bb\u30b9\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3057\u305f\u3002\n\nCreate Glusterfs Volume\n\u3053\u308c\u304b\u3089Glusterfs\u306e Volume \u3092\u4f5c\u6210\u3057\u3001\u30ed\u30ab\u30fc\u30eb\u306b mount \u3057\u307e\u3059\uff1a\n[vagrant@g1 ~]$ sudo gluster volume create vol-liubin g1:/gfs/data/vol-liubin\nvolume create: vol-liubin: success: please start the volume to access data\n[vagrant@g1 ~]$ sudo gluster volume start vol-liubin\nvolume start: vol-liubin: success\n\n[vagrant@g1 ~]$ sudo mkdir -p /gfs-client/vol-liubin\n[vagrant@g1 ~]$ sudo mount -t glusterfs g1:/vol-liubin /gfs-client/vol-liubin\n\n\n\u30ed\u30ab\u30fc\u30eb\u306b mount \u3057\u305f\u30d5\u30a9\u30eb\u30c0\u306b\u3001\u3044\u304f\u3064\u306e\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n[vagrant@g1 ~]$ sudo mkdir /gfs-client/vol-liubin/some\n\n[vagrant@g1 ~]$ cd /gfs-client/vol-liubin/\n\n[vagrant@g1 vol-liubin]$ sudo touch aa.txt\n[vagrant@g1 vol-liubin]$ sudo touch bbb.txt\n[vagrant@g1 vol-liubin]$ ls\naa.txt  bbb.txt  some\n\n\nCreate Snapshot and Restore Snapshot\nSnapshot \u3092\u4f5c\u6210\u3057\u307e\u3059\u3002no-timestamp \u30aa\u30d7\u30b7\u30e7\u30f3\u3092\u3064\u3051\u306a\u3044\u3068\u3001 Snapshot \u540d\u306b\u30bf\u30a4\u30e0\u30b9\u30bf\u30f3\u30d7\u304c\u81ea\u52d5\u306b\u8ffd\u52a0\u3055\u308c\u307e\u3059\u3002\n[vagrant@g1 vol-liubin]$ sudo gluster snapshot create ss-1 vol-liubin\nsnapshot create: success: Snap ss-1_GMT-2016.07.13-06.52.44 created successfully\n\n\n[vagrant@g1 vol-liubin]$ sudo gluster snapshot list\nss-1_GMT-2016.07.13-06.52.44\n\n[vagrant@g1 vol-liubin]$ sudo gluster snapshot create ss-2 vol-liubin no-timestamp\nsnapshot create: success: Snap ss-2 created successfully\n\n\nSnapshot \u306e\u8a73\u7d30\u3082\u898b\u3089\u308c\u307e\u3059\uff1a\n[vagrant@g1 vol-liubin]$ sudo gluster snapshot info ss-2\nSnapshot                  : ss-2\nSnap UUID                 : 2424720e-e80c-49f9-94d6-4730f1fef5a3\nCreated                   : 2016-07-13 06:54:23\nSnap Volumes:\n\n    Snap Volume Name          : 22b9a1f21bbb40eeabb34665f110cf98\n    Origin Volume name        : vol-liubin\n    Snaps taken for vol-liubin      : 2\n    Snaps available for vol-liubin  : 254\n    Status                    : Stopped\n\n\nSnapshot ss-2 \u3092\u3068\u3063\u305f\u5f8c\u3001\u65b0\u3057\u3044\u30d5\u30a1\u30a4\u30eb ccc.txt \u3092\u4f5c\u6210\u3057\u3001Volume \u3092 umount \u3057\u3066\u304b\u3089\u3001\u505c\u6b62\u3057\u307e\u3059\uff1a\n# create a new file\n[vagrant@g1 vol-liubin]$ sudo touch ccc.txt\n\n# umount\n\n[vagrant@g1 vol-liubin]$ cd\n[vagrant@g1 ~]$ sudo umount g1:/vol-liubin\n\n\n\n# stop volume\n\n[vagrant@g1 ~]$ sudo gluster volume stop vol-liubin\nStopping volume will make its data inaccessible. Do you want to continue? (y/n) y\nvolume stop: vol-liubin: success\n\n\nss-2 \u3092Volume vol-liubin \u306b Restore \u3057\u307e\u3059\uff1a\n[vagrant@g1 ~]$ sudo gluster snapshot restore ss-2\nRestore operation will replace the original volume with the snapshotted volume. Do you still want to continue? (y/n) y\nSnapshot restore: ss-2: Snap restored successfully\n\n\u518d\u3073 vol-liubin \u3092\u958b\u59cb\u3057mount\u3057\u307e\u3059\uff1a\n[vagrant@g1 ~]$ sudo gluster volume start vol-liubin\nvolume start: vol-liubin: success\n\n[vagrant@g1 ~]$ sudo mount -t glusterfs g1:/vol-liubin /gfs-client/vol-liubin\n\nss-2 \u306f\u53e4\u3044Snapshot\u306e\u305f\u3081\u3001 ccc.txt \u304c\u306a\u3044\u3053\u3068\u3092\u78ba\u8a8d\u3067\u304d\u308b\u306f\u305a\u3067\u3059\u3002\n[vagrant@g1 ~]$ ls /gfs-client/vol-liubin/\naa.txt  bbb.txt  some\n\n\n\u6ce8\u610f\uff1aSnapshot \u6a5f\u80fd\u3092\u5229\u7528\u3059\u308b\u306b\u306f\u3001THIN \u306e LVM \u3092\u4f7f\u3046\u306e\u304c\u524d\u63d0\u3067\u3059\uff1a\n$ sudo gluster snapshot create ss-4 vol-3\nsnapshot create: failed: Snapshot is supported only for thin provisioned LV. Ensure that all bricks of vol-3 are thinly provisioned LV.\nSnapshot command failed\n\n\u30aa\u30d5\u30a3\u30b7\u30e3\u30eb\u306e\u30de\u30cb\u30e5\u30a2\u30eb\u306b\u3088\u308b\u3068:\n\nGlusterFS volume snapshot feature is based on thinly provisioned LVM snapshot. To make use of snapshot feature GlusterFS volume should fulfill following pre-requisites:\nEach brick should be on an independent thin provisioned LVM.\nBrick LVM should not contain any other data other than brick.\nNone of the brick should be on a thick LVM.\ngluster version should be 3.6 and above.\n\n\nGlusterfs Volume Quota\n\u6b21\u306f Quota \u6a5f\u80fd\u3092\u8a66\u3057\u307e\u3059\u3002\n\u307e\u305a\u306f\u3001Volume \u5225\u306b quota \u6a5f\u80fd\u3092\u6709\u52b9\u306b\u3057\u306a\u3051\u308c\u3070\u306a\u308a\u307e\u305c\u3093\u3002\n[vagrant@g1 vol-liubin]$ sudo gluster volume quota vol-liubin enable\nvolume quota : success\n\n\u6b21\u3001\u5bb9\u91cf\u306f 10MB \u306b\u5236\u9650\u3057\u307e\u3059\u3002list \u30b3\u30de\u30f3\u30c9\u306fVolume\u306e\u5236\u9650\u30ea\u30b9\u30c8\u3092\u8868\u793a\u3057\u307e\u3059\uff1a\n[vagrant@g1 vol-liubin]$ sudo gluster volume quota vol-liubin limit-usage / 10MB\nvolume quota : success\n\n[vagrant@g1 vol-liubin]$ sudo gluster volume quota vol-liubin list\n                  Path                   Hard-limit  Soft-limit      Used  Available  Soft-limit exceeded? Hard-limit exceeded?\n-------------------------------------------------------------------------------------------------------------------------------\n/                                         10.0MB     80%(8.0MB)    1.0KB  10.0MB              No                   No\n\n\n\u30c6\u30b9\u30c8\u7528\u306e\u30d5\u30a1\u30a4\u30eb\uff08gs.rmp\u30011.45MB\uff09\u3044\u304f\u3064\u3092 vol-liubin \u306b\u30b3\u30fc\u30d4\u30fc\u3057\u307e\u3059\uff1a\n\n[vagrant@g1 vol-liubin]$ cd \n[vagrant@g1 ~]$ sudo cp gs.rmp /gfs-client/vol-liubin/some/\n[vagrant@g1 ~]$ sudo gluster volume quota vol-liubin list\n                  Path                   Hard-limit  Soft-limit      Used  Available  Soft-limit exceeded? Hard-limit exceeded?\n-------------------------------------------------------------------------------------------------------------------------------\n/                                         10.0MB     80%(8.0MB)    1.4MB   8.6MB              No                   No\n[vagrant@g1 ~]$ sudo cp gs.rmp /gfs-client/vol-liubin/some/1\n[vagrant@g1 ~]$ sudo cp gs.rmp /gfs-client/vol-liubin/some/2\n[vagrant@g1 ~]$ sudo gluster volume quota vol-liubin list\n                  Path                   Hard-limit  Soft-limit      Used  Available  Soft-limit exceeded? Hard-limit exceeded?\n-------------------------------------------------------------------------------------------------------------------------------\n/                                         10.0MB     80%(8.0MB)    4.2MB   5.8MB              No                   No\n[vagrant@g1 ~]$ sudo cp gs.rmp /gfs-client/vol-liubin/some/3\n[vagrant@g1 ~]$ sudo cp gs.rmp /gfs-client/vol-liubin/some/4\n[vagrant@g1 ~]$ sudo cp gs.rmp /gfs-client/vol-liubin/some/5\n[vagrant@g1 ~]$ sudo cp gs.rmp /gfs-client/vol-liubin/some/6\n[vagrant@g1 ~]$ sudo cp gs.rmp /gfs-client/vol-liubin/some/7\n[vagrant@g1 ~]$ sudo gluster volume quota vol-liubin list\n                  Path                   Hard-limit  Soft-limit      Used  Available  Soft-limit exceeded? Hard-limit exceeded?\n-------------------------------------------------------------------------------------------------------------------------------\n/                                         10.0MB     80%(8.0MB)   11.1MB  0Bytes             Yes                  Yes\n\n\n\n[vagrant@g1 ~]$ sudo cp gs.rmp /gfs-client/vol-liubin/some/8\n[vagrant@g1 ~]$ sudo gluster volume quota vol-liubin list\n                  Path                   Hard-limit  Soft-limit      Used  Available  Soft-limit exceeded? Hard-limit exceeded?\n-------------------------------------------------------------------------------------------------------------------------------\n/                                         10.0MB     80%(8.0MB)   12.5MB  0Bytes             Yes                  Yes\n\n\n7 \u756a\u76ee\u306e\u30d5\u30a1\u30a4\u30eb\u3092\u30b3\u30fc\u30d4\u30fc\u3057\u305f\u6642\u70b9\u3067\u3059\u3067\u306b\u5bb9\u91cf\u5236\u9650\u3092\u8d85\u3048\u307e\u3057\u305f\u304c\u30018 \u756a\u76ee\u306e\u30d5\u30a1\u30a4\u30eb\u3082\u30b3\u30fc\u30d4\u30fc\u3057\u6210\u529f\u3057\u307e\u3057\u305f\u3002\n\u539f\u56e0\u306f\u308f\u304b\u308a\u307e\u305b\u3093\u3002\n\u7d9a\u3051\u3066\u30d5\u30a1\u30a4\u30eb\u3092\u30b3\u30fc\u30d4\u30fc\u3057\u307e\u3059\u3002\u4eca\u56de\u306f\u30a8\u30e9\u30fc\u306b\u306a\u308a\u307e\u3057\u305f\u3002\n\n[vagrant@g1 ~]$ sudo cp gs.rmp /gfs-client/vol-liubin/some/9\ncp: cannot create regular file '/gfs-client/vol-liubin/some/9': Disk quota exceeded\n[vagrant@g1 ~]$ \n\n\n\n\u53c2\u8003\n\nGlusterFS \u306e\u30b9\u30ca\u30c3\u30d7\u30b7\u30e7\u30c3\u30c8\u3092\u4f7f\u3046\n\n\n\u4e00\u3064\u306eVM\u306b\u3001GlusterFS\u306eQuota\u3068Snapshot\u6a5f\u80fd\u3092\u8a66\u3057\u307e\u3057\u305f\u3001\u305d\u306e\u8a18\u9332\u3092\u6b8b\u3057\u3066\u304a\u304d\u305f\u3044\u3068\u601d\u3063\u3066\u3044\u307e\u3059\u3002\n\n\n\u5b9f\u9a13\u74b0\u5883:\n\n- Vagrant 1.8.1\n- VirtualBox 5.0.20r106931\n- GlusterFS 3.7\n\n## Vagrantfile\n\n\n\u307e\u305a\u306f\u65b0\u3057\u3044\u30cf\u30fc\u30c9\u30c7\u30a3\u30b9\u30af\u3092\u4f5c\u3063\u3066\u304a\u304d\u307e\u3059\uff1a\n\n\n```\n  config.vm.provider :virtualbox do |vb|\n    file_to_disk = \"#{ENV[\"HOME\"]}/glusterfs.vdi\"\n    unless File.exist?(file_to_disk)\n      vb.customize ['createmedium', 'disk', '--filename', file_to_disk, '--format', 'VDI', '--size', 10 * 1024]\n      vb.customize ['storageattach', :id,\n        '--storagectl', 'IDE Controller',\n        '--port', 1,\n        '--device', 0,\n        '--type', 'hdd',\n        '--medium', file_to_disk]\n    end\n  end\n\n```\n\n\u4e0a\u8a18\u306e\u8a2d\u5b9a\u306f\u74b0\u5883\u306b\u4f9d\u5b58\u3059\u308b\u305f\u3081\u3001\u81ea\u5206\u306e\u74b0\u5883\u306b\u5408\u308f\u305b\u3066\u4f5c\u3063\u3066\u304f\u3060\u3055\u3044\u3002\n\n\u8a73\u3057\u3044\u306e\u306f [Vagrant\u306eVM\u306b\u8907\u6570\u306e\u30c7\u30a3\u30b9\u30af\u3092\u8ffd\u52a0\u3059\u308b\u65b9\u6cd5](http://qiita.com/kjtanaka/items/8f3e92e029e46f826754) \u3092\u3054\u53c2\u7167\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n## Install Glusterfs\n\n\u30a6\u30a7\u30d6\u4e0a\u306b\u60c5\u5831\u304c\u591a\u3044\u3067\u3059\u306e\u3067\u3001\u3053\u3053\u3067\u7701\u7565\u3002\n\n## Create LVM Volume\n\n`/dev/sdb` \u304c\u3042\u308b\u306e\u3092\u78ba\u8a8d\uff1a\n\n```\n[vagrant@g1 ~]$ ls /dev/sd\nsda   sda1  sda2  sda3  sdb   \n```\n\n`parted` \u3067\u65b0\u3057\u3044\u30d1\u30c6\u30a3\u30b7\u30e7\u30f3\u3092\u4f5c\u308d\u3046\u3002\u611f\u3058\u3093\u306e\u306f `lvm on` \u3067\u3001Snapshot \u6a5f\u80fd\u3092\u4f7f\u3046\u305f\u3081\u306b\u5fc5\u9808\u3002\n\n```\n[vagrant@g1 ~]$ sudo parted -s -a optimal /dev/sdb mklabel msdos -- mkpart primary 1 -1 set 1 lvm on\n```\n\n`/dev/sdb1` \u3092\u78ba\u8a8d\uff1a\n\n```\n[vagrant@g1 ~]$ ls /dev/sd\nsda   sda1  sda2  sda3  sdb   sdb1  \n```\n\n\u7269\u7406\u30dc\u30ea\u30e5\u30fc\u30e0\uff08pv\uff09\u3068\u30dc\u30ea\u30e5\u30fc\u30e0\u30b0\u30eb\u30fc\u30d7\uff08vg\uff09\u3092\u4f5c\u6210\uff1a\n\n```\n[vagrant@g1 ~]$ sudo pvcreate /dev/sdb1\n  Physical volume \"/dev/sdb1\" successfully created\n\n[vagrant@g1 ~]$ sudo vgcreate vg0 /dev/sdb1\n  Volume group \"vg0\" successfully created\n```\n\n\n`thinpool` \u3092\u4f5c\u6210\uff08\u540d\u524d\u306f `thinp` \uff09\uff1a\n\n```\n[vagrant@g1 ~]$ sudo lvcreate --thin -L 1G vg0/thinp\n  Logical volume \"thinp\" created.\n```\n\n\n`thinp` \u306b\u57fa\u3065\u3044\u3066\u30dc\u30ea\u30e5\u30fc\u30e0 `data` \u3092\u4f5c\u6210\u3057\u3066\u3001 `mkfs.xfs` \u3067\u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0\u3092\u4f5c\u308a\u307e\u3059\uff1a\n\n```\n[vagrant@g1 ~]$ sudo lvcreate --thin -V 1G -n data vg0/thinp\n  Logical volume \"data\" created.\n\n\n[vagrant@g1 ~]$ sudo mkfs.xfs /dev/vg0/data \nmeta-data=/dev/vg0/data          isize=256    agcount=8, agsize=32752 blks\n         =                       sectsz=512   attr=2, projid32bit=1\n         =                       crc=0        finobt=0\ndata     =                       bsize=4096   blocks=262016, imaxpct=25\n         =                       sunit=16     swidth=16 blks\nnaming   =version 2              bsize=4096   ascii-ci=0 ftype=0\nlog      =internal log           bsize=4096   blocks=768, version=2\n         =                       sectsz=512   sunit=16 blks, lazy-count=1\nrealtime =none                   extsz=4096   blocks=0, rtextents=0\n```\n\nLVM volume `/dev/vg0/data` \u3092\u30ed\u30ab\u30fc\u30eb\u306bmount\u3057\u307e\u3059\uff1a\n\n```\n[vagrant@g1 ~]$ sudo mkdir -p /gfs/data\n[vagrant@g1 ~]$ sudo mount /dev/vg0/data /gfs/data\n```\n\n\u3053\u308c\u3067\u3001 LVM \u306e Thinpool Volume \u3092\u30ed\u30ab\u30fc\u30eb\u30db\u30b9\u30c8\u306b\u30a2\u30af\u30bb\u30b9\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3057\u305f\u3002\n\n## Create Glusterfs Volume\n\n\n\u3053\u308c\u304b\u3089Glusterfs\u306e Volume \u3092\u4f5c\u6210\u3057\u3001\u30ed\u30ab\u30fc\u30eb\u306b mount \u3057\u307e\u3059\uff1a\n\n```\n[vagrant@g1 ~]$ sudo gluster volume create vol-liubin g1:/gfs/data/vol-liubin\nvolume create: vol-liubin: success: please start the volume to access data\n[vagrant@g1 ~]$ sudo gluster volume start vol-liubin\nvolume start: vol-liubin: success\n\n[vagrant@g1 ~]$ sudo mkdir -p /gfs-client/vol-liubin\n[vagrant@g1 ~]$ sudo mount -t glusterfs g1:/vol-liubin /gfs-client/vol-liubin\n\n```\n\n\n\u30ed\u30ab\u30fc\u30eb\u306b mount \u3057\u305f\u30d5\u30a9\u30eb\u30c0\u306b\u3001\u3044\u304f\u3064\u306e\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n\n```\n[vagrant@g1 ~]$ sudo mkdir /gfs-client/vol-liubin/some\n\n[vagrant@g1 ~]$ cd /gfs-client/vol-liubin/\n\n[vagrant@g1 vol-liubin]$ sudo touch aa.txt\n[vagrant@g1 vol-liubin]$ sudo touch bbb.txt\n[vagrant@g1 vol-liubin]$ ls\naa.txt  bbb.txt  some\n```\n\n## Create Snapshot and Restore Snapshot\n\n\nSnapshot \u3092\u4f5c\u6210\u3057\u307e\u3059\u3002`no-timestamp` \u30aa\u30d7\u30b7\u30e7\u30f3\u3092\u3064\u3051\u306a\u3044\u3068\u3001 Snapshot \u540d\u306b\u30bf\u30a4\u30e0\u30b9\u30bf\u30f3\u30d7\u304c\u81ea\u52d5\u306b\u8ffd\u52a0\u3055\u308c\u307e\u3059\u3002\n\n\n```\n[vagrant@g1 vol-liubin]$ sudo gluster snapshot create ss-1 vol-liubin\nsnapshot create: success: Snap ss-1_GMT-2016.07.13-06.52.44 created successfully\n\n\n[vagrant@g1 vol-liubin]$ sudo gluster snapshot list\nss-1_GMT-2016.07.13-06.52.44\n\n[vagrant@g1 vol-liubin]$ sudo gluster snapshot create ss-2 vol-liubin no-timestamp\nsnapshot create: success: Snap ss-2 created successfully\n\n```\n\nSnapshot \u306e\u8a73\u7d30\u3082\u898b\u3089\u308c\u307e\u3059\uff1a\n\n```\n[vagrant@g1 vol-liubin]$ sudo gluster snapshot info ss-2\nSnapshot                  : ss-2\nSnap UUID                 : 2424720e-e80c-49f9-94d6-4730f1fef5a3\nCreated                   : 2016-07-13 06:54:23\nSnap Volumes:\n\n\tSnap Volume Name          : 22b9a1f21bbb40eeabb34665f110cf98\n\tOrigin Volume name        : vol-liubin\n\tSnaps taken for vol-liubin      : 2\n\tSnaps available for vol-liubin  : 254\n\tStatus                    : Stopped\n \n```\n\nSnapshot `ss-2` \u3092\u3068\u3063\u305f\u5f8c\u3001\u65b0\u3057\u3044\u30d5\u30a1\u30a4\u30eb `ccc.txt` \u3092\u4f5c\u6210\u3057\u3001Volume \u3092 umount \u3057\u3066\u304b\u3089\u3001\u505c\u6b62\u3057\u307e\u3059\uff1a\n\n```\n# create a new file\n[vagrant@g1 vol-liubin]$ sudo touch ccc.txt\n\n# umount\n\n[vagrant@g1 vol-liubin]$ cd\n[vagrant@g1 ~]$ sudo umount g1:/vol-liubin\n\n\n\n# stop volume\n\n[vagrant@g1 ~]$ sudo gluster volume stop vol-liubin\nStopping volume will make its data inaccessible. Do you want to continue? (y/n) y\nvolume stop: vol-liubin: success\n\n```\n\n\n`ss-2` \u3092Volume `vol-liubin` \u306b Restore \u3057\u307e\u3059\uff1a\n\n```\n[vagrant@g1 ~]$ sudo gluster snapshot restore ss-2\nRestore operation will replace the original volume with the snapshotted volume. Do you still want to continue? (y/n) y\nSnapshot restore: ss-2: Snap restored successfully\n```\n\n\u518d\u3073 `vol-liubin` \u3092\u958b\u59cb\u3057mount\u3057\u307e\u3059\uff1a\n\n```\n[vagrant@g1 ~]$ sudo gluster volume start vol-liubin\nvolume start: vol-liubin: success\n\n[vagrant@g1 ~]$ sudo mount -t glusterfs g1:/vol-liubin /gfs-client/vol-liubin\n```\n\n`ss-2` \u306f\u53e4\u3044Snapshot\u306e\u305f\u3081\u3001 `ccc.txt` \u304c\u306a\u3044\u3053\u3068\u3092\u78ba\u8a8d\u3067\u304d\u308b\u306f\u305a\u3067\u3059\u3002\n\n```\n[vagrant@g1 ~]$ ls /gfs-client/vol-liubin/\naa.txt  bbb.txt  some\n\n```\n\n\u6ce8\u610f\uff1aSnapshot \u6a5f\u80fd\u3092\u5229\u7528\u3059\u308b\u306b\u306f\u3001THIN \u306e LVM \u3092\u4f7f\u3046\u306e\u304c\u524d\u63d0\u3067\u3059\uff1a\n\n```\n$ sudo gluster snapshot create ss-4 vol-3\nsnapshot create: failed: Snapshot is supported only for thin provisioned LV. Ensure that all bricks of vol-3 are thinly provisioned LV.\nSnapshot command failed\n```\n\n\u30aa\u30d5\u30a3\u30b7\u30e3\u30eb\u306e\u30de\u30cb\u30e5\u30a2\u30eb\u306b\u3088\u308b\u3068:\n\n>GlusterFS volume snapshot feature is based on thinly provisioned LVM snapshot. To make use of snapshot feature GlusterFS volume should fulfill following pre-requisites:\n\n> Each brick should be on an independent thin provisioned LVM.\nBrick LVM should not contain any other data other than brick.\nNone of the brick should be on a thick LVM.\ngluster version should be 3.6 and above.\n\n\n## Glusterfs Volume Quota\n\n\u6b21\u306f Quota \u6a5f\u80fd\u3092\u8a66\u3057\u307e\u3059\u3002\n\n\n\u307e\u305a\u306f\u3001Volume \u5225\u306b quota \u6a5f\u80fd\u3092\u6709\u52b9\u306b\u3057\u306a\u3051\u308c\u3070\u306a\u308a\u307e\u305c\u3093\u3002\n\n```\n[vagrant@g1 vol-liubin]$ sudo gluster volume quota vol-liubin enable\nvolume quota : success\n```\n\n\u6b21\u3001\u5bb9\u91cf\u306f 10MB \u306b\u5236\u9650\u3057\u307e\u3059\u3002`list` \u30b3\u30de\u30f3\u30c9\u306fVolume\u306e\u5236\u9650\u30ea\u30b9\u30c8\u3092\u8868\u793a\u3057\u307e\u3059\uff1a\n\n```\n[vagrant@g1 vol-liubin]$ sudo gluster volume quota vol-liubin limit-usage / 10MB\nvolume quota : success\n\n[vagrant@g1 vol-liubin]$ sudo gluster volume quota vol-liubin list\n                  Path                   Hard-limit  Soft-limit      Used  Available  Soft-limit exceeded? Hard-limit exceeded?\n-------------------------------------------------------------------------------------------------------------------------------\n/                                         10.0MB     80%(8.0MB)    1.0KB  10.0MB              No                   No\n\n```\n\n\n\u30c6\u30b9\u30c8\u7528\u306e\u30d5\u30a1\u30a4\u30eb\uff08gs.rmp\u30011.45MB\uff09\u3044\u304f\u3064\u3092 `vol-liubin` \u306b\u30b3\u30fc\u30d4\u30fc\u3057\u307e\u3059\uff1a\n\n```\n\n[vagrant@g1 vol-liubin]$ cd \n[vagrant@g1 ~]$ sudo cp gs.rmp /gfs-client/vol-liubin/some/\n[vagrant@g1 ~]$ sudo gluster volume quota vol-liubin list\n                  Path                   Hard-limit  Soft-limit      Used  Available  Soft-limit exceeded? Hard-limit exceeded?\n-------------------------------------------------------------------------------------------------------------------------------\n/                                         10.0MB     80%(8.0MB)    1.4MB   8.6MB              No                   No\n[vagrant@g1 ~]$ sudo cp gs.rmp /gfs-client/vol-liubin/some/1\n[vagrant@g1 ~]$ sudo cp gs.rmp /gfs-client/vol-liubin/some/2\n[vagrant@g1 ~]$ sudo gluster volume quota vol-liubin list\n                  Path                   Hard-limit  Soft-limit      Used  Available  Soft-limit exceeded? Hard-limit exceeded?\n-------------------------------------------------------------------------------------------------------------------------------\n/                                         10.0MB     80%(8.0MB)    4.2MB   5.8MB              No                   No\n[vagrant@g1 ~]$ sudo cp gs.rmp /gfs-client/vol-liubin/some/3\n[vagrant@g1 ~]$ sudo cp gs.rmp /gfs-client/vol-liubin/some/4\n[vagrant@g1 ~]$ sudo cp gs.rmp /gfs-client/vol-liubin/some/5\n[vagrant@g1 ~]$ sudo cp gs.rmp /gfs-client/vol-liubin/some/6\n[vagrant@g1 ~]$ sudo cp gs.rmp /gfs-client/vol-liubin/some/7\n[vagrant@g1 ~]$ sudo gluster volume quota vol-liubin list\n                  Path                   Hard-limit  Soft-limit      Used  Available  Soft-limit exceeded? Hard-limit exceeded?\n-------------------------------------------------------------------------------------------------------------------------------\n/                                         10.0MB     80%(8.0MB)   11.1MB  0Bytes             Yes                  Yes\n\n\n\n[vagrant@g1 ~]$ sudo cp gs.rmp /gfs-client/vol-liubin/some/8\n[vagrant@g1 ~]$ sudo gluster volume quota vol-liubin list\n                  Path                   Hard-limit  Soft-limit      Used  Available  Soft-limit exceeded? Hard-limit exceeded?\n-------------------------------------------------------------------------------------------------------------------------------\n/                                         10.0MB     80%(8.0MB)   12.5MB  0Bytes             Yes                  Yes\n\n```\n\n`7` \u756a\u76ee\u306e\u30d5\u30a1\u30a4\u30eb\u3092\u30b3\u30fc\u30d4\u30fc\u3057\u305f\u6642\u70b9\u3067\u3059\u3067\u306b\u5bb9\u91cf\u5236\u9650\u3092\u8d85\u3048\u307e\u3057\u305f\u304c\u3001`8` \u756a\u76ee\u306e\u30d5\u30a1\u30a4\u30eb\u3082\u30b3\u30fc\u30d4\u30fc\u3057\u6210\u529f\u3057\u307e\u3057\u305f\u3002\n\n**\u539f\u56e0\u306f\u308f\u304b\u308a\u307e\u305b\u3093\u3002**\n\n\u7d9a\u3051\u3066\u30d5\u30a1\u30a4\u30eb\u3092\u30b3\u30fc\u30d4\u30fc\u3057\u307e\u3059\u3002\u4eca\u56de\u306f\u30a8\u30e9\u30fc\u306b\u306a\u308a\u307e\u3057\u305f\u3002\n\n```\n\n[vagrant@g1 ~]$ sudo cp gs.rmp /gfs-client/vol-liubin/some/9\ncp: cannot create regular file '/gfs-client/vol-liubin/some/9': Disk quota exceeded\n[vagrant@g1 ~]$ \n\n```\n\n## \u53c2\u8003\n\n- [GlusterFS \u306e\u30b9\u30ca\u30c3\u30d7\u30b7\u30e7\u30c3\u30c8\u3092\u4f7f\u3046](http://qiita.com/ngyuki/items/389d106fa372d3e4e8f6)\n", "tags": ["GlusterFS", "vagrant", "VirtualBox"]}