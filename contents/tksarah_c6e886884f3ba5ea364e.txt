{"tags": ["drbd9", "openstack", "drbd", "Cinder"], "context": " More than 1 year has passed since last update.DRBD \u306f DRBD9 \u304b\u3089\u642d\u8f09\u3055\u308c\u305f drbdmanage \u3092\u6d3b\u7528\u3057\u3001OpenStack Cinder \u3068\u9023\u643a\u3059\u308b\u3053\u3068\u304c\u53ef\u80fd\u3067\u3042\u308b\u3002Cinder Volume Driver \u306f OpenStack LIBERTY Release \u304b\u3089\u6a19\u6e96\u642d\u8f09\u3055\u308c\u3066\u3044\u308b\u3002\nhttp://drbd.linbit.com/users-guide-9.0/s-openstack-install.html#s-openstack-addtl-conf\n\u3053\u3053\u3067\u306f\u30011\u30ce\u30fc\u30c9 \u3067\u3072\u3068\u307e\u305a\u3053\u306e DRBD9 \u7528\u306e Cinder Volume Driver\uff08drbdmanagedrv.py\uff09 \u306e\u52d5\u4f5c\u3092\u78ba\u8a8d\u3059\u308b\u624b\u9806\u3092\u5217\u6319\u3059\u308b\u3002\u306a\u304a\u3001\u57fa\u672c\u7684\u306a\u3068\u3053\u308d\u306f\u5272\u611b\u3057\u3066\u3044\u308b\u3002\n\u6982\u7565\u56f3\n\n\n\u30de\u30b7\u30f3\u306e\u6e96\u5099\n\u7269\u7406\u3067\u3082\u4eee\u60f3\u3067\u3082\u826f\u3044\u304c\u3001\u4ee5\u4e0b\u306e\u30b9\u30da\u30c3\u30af\u304c\u3042\u308b\u3068\u3044\u3044\u3002\n\nCPU x2\n\u30e1\u30e2\u30ea4GB\u4ee5\u4e0a\nNIC\u306f1\u3064\u3067\u3082\nDISK\u306f30GB\u4ee5\u4e0a\nLinux\u30c7\u30a3\u30b9\u30c8\u30ea\u30d3\u30e5\u30fc\u30b7\u30e7\u30f3\u306f\u3053\u3053\u3067\u306f CentOS 7\n\n\nRDO Allinone \u306e\u6e96\u5099\nCentOS 7 x86_64 \u4ee5\u964d\u3078 RDO \u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u666e\u901a\u306b OpenStack \u306e\u5404 Core \u30b5\u30fc\u30d3\u30b9\u304c\u52d5\u304f\u3068\u3053\u308d\u307e\u3067\u6e96\u5099\u3059\u308b\u3002Nova \u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306f1\u3064 cirros \u3067\u3088\u3044\u306e\u3067\u4f5c\u3063\u3066\u304a\u304f\u3002\n\nDRBD9 \u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\u4eca\u56de\u306f\u30d1\u30c3\u30b1\u30fc\u30b8\u7248\u3092\u4f7f\u3063\u3066\u3044\u308b\u304c\u3001\u30bd\u30fc\u30b9\u304b\u3089\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u305f\u3082\u306e\u3092\u4f7f\u3063\u3066\u3082\u826f\u3044\u3002\n# cat /etc/redhat-release\nDerived from Red Hat Enterprise Linux 7.1 (Source)\n\n# cat /etc/yum.repos.d/linbit.repo\n[drbd-9.0]\nname=LINBIT Packages for drbd-9.0 - $basearch\nbaseurl=http://packages.linbit.com/<\u30b5\u30dd\u30fc\u30c8\u8a3c\u66f8\u306b\u3042\u308b\u30cf\u30c3\u30b7\u30e5>/yum/rhel7.1/drbd-9.0/$basearch\nenabled=1\ngpgcheck=0\n\n# yum install kmod-drbd drbd drbdmanage\n\n\n\u30d1\u30c3\u30b1\u30fc\u30b8\u629c\u7c8b\n\ndrbd-8.9.4-1.el7.x86_64\ndrbdmanage-0.50-1.noarch\nkmod-drbd-9.0.0_3.10.0_229.7.2-3.el7.x86_64\n\n\nloopback \u3067 DRBD\u7528\u306e\u30c7\u30d0\u30a4\u30b9\u3092\u4f5c\u308b\n\u5916\u90e8\u30d6\u30ed\u30c3\u30af\u30c7\u30d0\u30a4\u30b9\u3092\u8ffd\u52a0\u3067\u304d\u308b\u306e\u3067\u3042\u308c\u3070\u305d\u306e\u30c7\u30d0\u30a4\u30b9\u3092\u4f7f\u3063\u3066\u3082\u826f\u3044\u304c\u30b3\u30b3\u3067\u306f\u624b\u3063\u53d6\u308a\u65e9\u304f\u4eee\u60f3\u7684\u306b\u3064\u304f\u308b\u3002\n\nAllinone \u306e\u5834\u5408 loop0 , loop1 \u306f Swift , cinder \u3067\u4f7f\u308f\u308c\u3066\u3044\u308b\u306e\u3067\u6ce8\u610f\n\n# dd if=/dev/zero of=disk01 bs=1M count=10000\n# dd if=/dev/zero of=disk02 bs=1M count=10000\n# losetup /dev/loop2 /root/disk01\n# losetup /dev/loop3 /root/disk02\n# vgcreate drbdpool /dev/loop2 /dev/loop3\n\n\n\u78ba\u8a8d\uff1alosetup\n\u306f\u305a\u3059\u306b\u306f losetup -d \uff1cloopdev\uff1e\n\n\nDRBD \u30a4\u30cb\u30b7\u30e3\u30e9\u30a4\u30ba\n# drbdmanage init <IP Address>\n\n\n\u78ba\u8a8d\uff1adrbdmanage list-nodes\n\n[root@akira ~]# drbdmanage list-nodes\n+------------------------------------------------------------------------------------------------------------+\n| Name         | Pool Size | Pool Free | Site |                                                      | State |\n+------------------------------------------------------------------------------------------------------------+\n| akira.tk.net |      9992 |      9984 |  N/A |                                                      |    ok |\n+------------------------------------------------------------------------------------------------------------+\n\n\ndrbdmanage driver \u8a2d\u5b9a\n\ncinder.conf\n[DEFAULT]\nenabled_backends=lvm,drbdmanage\n\n\uff08\u7565\uff09\n\n[drbdmanage]\niscsi_helper=lioadm\nhttp://docs.openstack.org/admin-guide-cloud/blockstorage-lio-iscsi-support.html\nrestart cinder-volume\n\n\niscsi_helper=lioadm \u306b\u3057\u3066\u3044\u308b\u306e\u306f\u30c7\u30d5\u30a9\u30eb\u30c8\u306e tgtadm \u306f\u5165\u3063\u3066\u3044\u306a\u3044\u305f\u3081\nLinux IO Target\u30fb\u30fb\u30fbhttp://linux-iscsi.org/wiki/LIO\n\n\n\u30dc\u30ea\u30e5\u30fc\u30e0\u30bf\u30a4\u30d7\u4f5c\u6210\n[root ~ root] source adminrc\n[root ~(keystone_admin)] cinder type-create drbdmanage\n[root ~(keystone_admin)] cinder type-key drbdmanage set volume_backend_name=drbdmanage\n\n\n\u78ba\u8a8d\uff1acinder type-list\n\u78ba\u8a8d\uff1acinder extra-specs-list\n\n[root@akira ~(keystone_admin)]# cinder type-list\n+--------------------------------------+------------+-------------+-----------+\n|                  ID                  |    Name    | Description | Is_Public |\n+--------------------------------------+------------+-------------+-----------+\n| 0caf8530-7853-4fea-84dd-59d41ebc9510 |   iscsi    |      -      |    True   |\n| c5b09398-fb34-4398-b3b2-3e29a2859ee2 | drbdmanage |      -      |    True   |\n+--------------------------------------+------------+-------------+-----------+\n[root@akira ~(keystone_admin)]# cinder extra-specs-list\n+--------------------------------------+------------+-----------------------------------------+\n|                  ID                  |    Name    |               extra_specs               |\n+--------------------------------------+------------+-----------------------------------------+\n| 0caf8530-7853-4fea-84dd-59d41ebc9510 |   iscsi    |     {u'volume_backend_name': u'lvm'}    |\n| c5b09398-fb34-4398-b3b2-3e29a2859ee2 | drbdmanage | {u'volume_backend_name': u'drbdmanage'} |\n+--------------------------------------+------------+-----------------------------------------+\n\n\ndbus \u3078\u306e\u30a2\u30af\u30bb\u30b9\u8a31\u53ef\n/etc/dbus-1/system.d/org.drbd.drbdmanaged.conf \u3092\u7de8\u96c6\u3059\u308b\u3002\n# cat /etc/dbus-1/system.d/org.drbd.drbdmanaged.conf\n<!DOCTYPE busconfig PUBLIC\n\"-//freedesktop//DTD D-BUS Bus Configuration 1.0//EN\"\n\"http://www.freedesktop.org/standards/dbus/1.0/busconfig.dtd\">\n<busconfig>\n  <policy user=\"0\">\n      <allow own=\"org.drbd.drbdmanaged\"/>\n      <allow send_interface=\"org.drbd.drbdmanaged\"/>\n      <allow send_destination=\"org.drbd.drbdmanaged\"/>\n  </policy>\n  <policy user=\"cinder\">                               # \u30b3\u30b3\u8ffd\u52a0\n      <allow own=\"org.drbd.drbdmanaged\"/>              # \u30b3\u30b3\u8ffd\u52a0\n      <allow send_interface=\"org.drbd.drbdmanaged\"/>   # \u30b3\u30b3\u8ffd\u52a0\n      <allow send_destination=\"org.drbd.drbdmanaged\"/> # \u30b3\u30b3\u8ffd\u52a0\n  </policy>                                            # \u30b3\u30b3\u8ffd\u52a0\n</busconfig>\n\n\nuser \u306e\u5024\u306f cinder-volume \u304c\u8d77\u52d5\u3055\u308c\u3066\u3044\u308b\u30e6\u30fc\u30b6\u3092\u5165\u308c\u308b\n\n\ncinder-volume \u518d\u8d77\u52d5\n# systemctl restart openstack-cinder-volume\n\n\n\u78ba\u8a8d\uff1acinder service-list (admin \u6a29\u9650\u3001up \u3068\u306a\u308b\u307e\u3067\u5c11\u3057\u6642\u9593\u304c\u304b\u304b\u308b\u5834\u5408\u3042\u308a)\n\u30a8\u30e9\u30fc\u304c\u306a\u3044\u304b\u78ba\u8a8d\uff1a/var/log/cinder/volume.log\n\n[root@akira ~(keystone_admin)]# cinder service-list\n+------------------+-------------------------+------+---------+-------+----------------------------+-----------------+\n|      Binary      |           Host          | Zone |  Status | State |         Updated_at         | Disabled Reason |\n+------------------+-------------------------+------+---------+-------+----------------------------+-----------------+\n|  cinder-backup   |       akira.tk.net      | nova | enabled |   up  | 2015-12-02T14:18:13.000000 |        -        |\n| cinder-scheduler |       akira.tk.net      | nova | enabled |   up  | 2015-12-02T14:18:11.000000 |        -        |\n|  cinder-volume   | akira.tk.net@drbdmanage | nova | enabled |   up  | 2015-12-02T14:18:06.000000 |        -        |\n|  cinder-volume   |     akira.tk.net@lvm    | nova | enabled |   up  | 2015-12-02T14:18:06.000000 |        -        |\n+------------------+-------------------------+------+---------+-------+----------------------------+-----------------+\n\n\n\u8a66\u884c\n\n\u30d6\u30ed\u30c3\u30af\u30c7\u30d0\u30a4\u30b9\u4f5c\u6210\uff08Cinder Volume\uff09\n[root ~] source demorc\n[root ~(keystone_demo)] cinder create --display-name=hoge --volume-type drbdmanage 1\n\n\n\u78ba\u8a8d\uff1acinder list\n\u30a8\u30e9\u30fc\u304c\u306a\u3044\u304b\u78ba\u8a8d\uff1a/var/log/cinder/volume.log\ndrbdmanage \u3067\u3082\u78ba\u8a8d\u3067\u304d\u308b\uff1adrbdmanage list-volumes\n\u30dc\u30ea\u30e5\u30fc\u30e0\u306e\u72b6\u614b\u78ba\u8a8d\uff1adrbdsetup status\nlvdisplay \uff08Cinder Volume Driver \u7d4c\u7531\u3001drbdmanage \u306b\u3088\u308a LV \u304c\u4f5c\u3089\u308c\u3066\u3044\u308b\uff09\n\u524a\u9664\uff1acinder delete\n\n[root@akira ~(keystone_demo)]# cinder list\n+--------------------------------------+-----------+------+------+-------------+----------+-------------+-------------+\n|                  ID                  |   Status  | Name | Size | Volume Type | Bootable | Multiattach | Attached to |\n+--------------------------------------+-----------+------+------+-------------+----------+-------------+-------------+\n| 7e794c92-9027-4cb0-a9ab-ba8036e9bbf7 | available | hoge |  1   |  drbdmanage |  false   |    False    |             |\n+--------------------------------------+-----------+------+------+-------------+----------+-------------+-------------+\n\n[root@akira ~(keystone_demo)]# drbdmanage list-volumes\n+------------------------------------------------------------------------------------------------------------+\n| Name                                    | Vol ID | Size | Minor |                                  | State |\n+------------------------------------------------------------------------------------------------------------+\n| CV_7e794c92-9027-4cb0-a9ab-ba8036e9bbf7 |      0 | 1024 |   100 |                                  |    ok |\n+------------------------------------------------------------------------------------------------------------+\n\n[root@akira ~(keystone_demo)]# drbdsetup status\n.drbdctrl role:Secondary\n  volume:0 disk:UpToDate\n  volume:1 disk:UpToDate\n\nCV_7e794c92-9027-4cb0-a9ab-ba8036e9bbf7 role:Secondary\n  disk:Inconsistent\n\n[root@akira ~(keystone_demo)]# lvdisplay\n\uff08\u7565\uff09\n  --- Logical volume ---\n  LV Path                /dev/drbdpool/CV_7e794c92-9027-4cb0-a9ab-ba8036e9bbf7_00\n  LV Name                CV_7e794c92-9027-4cb0-a9ab-ba8036e9bbf7_00\n  VG Name                drbdpool\n  LV UUID                DVl32e-vG6p-9228-spkF-HIEn-J55Z-0rpSAQ\n  LV Write Access        read/write\n  LV Creation host, time akira.tk.net, 2015-12-02 23:20:45 +0900\n  LV Status              available\n  # open                 2\n  LV Size                1.00 GiB\n  Current LE             257\n  Segments               1\n  Allocation             inherit\n  Read ahead sectors     auto\n  - currently set to     8192\n  Block device           253:5\n\n\n\u30a4\u30ec\u30ae\u30e5\u30e9\u30fcTips\n\u4eca\u56de\u306e\u69cb\u6210\u3067\u306f\u30011\u30ce\u30fc\u30c9\u3067\u5168\u90e8\u5165\u308c\u8fbc\u3093\u3067\u3057\u307e\u3063\u3066\u304a\u308a\u3001DRBD \u3092\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3057\u306a\u3044\u72b6\u614b\u3067\u7247\u80ba\u30dc\u30ea\u30e5\u30fc\u30e0\u3068\u3057\u3066\u5229\u7528\u3059\u308b\u305f\u3081\u3053\u306eTips\u304c\u5fc5\u8981\u3002\n\n\u901a\u5e38\u306f DRBD \u5074\u306f\u30df\u30e9\u30fc\u30dc\u30ea\u30e5\u30fc\u30e0\u3068\u306a\u308b\u306e\u3067\u672c\u64cd\u4f5c\u306f\u5fc5\u8981\u306a\u3044\u3002\n\ndrbdsetup status \u3067\u78ba\u8a8d\u3057\u305f\u3068\u304d\u3001\u8a72\u5f53\u3059\u308b\u30dc\u30ea\u30e5\u30fc\u30e0\u306e disk:Inconsistent \u304c disk:UpToDate \u3067\u306a\u3044\u3068 Nova \u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306b\u30a2\u30bf\u30c3\u30c1\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u306a\u3044\u3002\u3088\u3063\u3066\u5f37\u5236\u7684\u306b\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u5909\u66f4\u3059\u308b\u3002\n[root@akira ~(keystone_demo)]# drbdsetup primary CV_7e794c92-9027-4cb0-a9ab-ba8036e9bbf7 --force=yes\n[root@akira ~(keystone_demo)]# drbdsetup secondary CV_7e794c92-9027-4cb0-a9ab-ba8036e9bbf7\n[root@akira ~(keystone_demo)]# drbdsetup status\n.drbdctrl role:Secondary\n  volume:0 disk:UpToDate\n  volume:1 disk:UpToDate\n\nCV_7e794c92-9027-4cb0-a9ab-ba8036e9bbf7 role:Secondary\n  disk:UpToDate\n\n\nNova \u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3078\u30a2\u30bf\u30c3\u30c1\n\u30a2\u30bf\u30c3\u30c1\u3059\u308b Cinder Volume \u306e ID \u306f cinder list \u7b49\u3067\u78ba\u8a8d\u3057\u3068\u304f\u3002\n[root@akira ~(keystone_demo)]# nova volume-attach demo-fedora23  7e794c92-9027-4cb0-a9ab-ba8036e9bbf7  auto\n+----------+--------------------------------------+\n| Property | Value                                |\n+----------+--------------------------------------+\n| device   | /dev/vdb                             |\n| id       | 7e794c92-9027-4cb0-a9ab-ba8036e9bbf7 |\n| serverId | c747b0d4-bb0a-4f3c-a377-0f1a8752b0c6 |\n| volumeId | 7e794c92-9027-4cb0-a9ab-ba8036e9bbf7 |\n+----------+--------------------------------------+\n\n\n\u30a8\u30e9\u30fc\u304c\u306a\u3044\u304b\u78ba\u8a8d\uff1a/var/log/cinder/volume.log\n\u30a8\u30e9\u30fc\u304c\u306a\u3044\u304b\u78ba\u8a8d\uff1a/var/log/nova/nova-comupte.log\n\u78ba\u8a8d\uff1acinder list\n\u78ba\u8a8d\uff1anova show\n\n[root@akira ~(keystone_demo)]# cinder list\n+--------------------------------------+--------+------+------+-------------+----------+-------------+--------------------------------------+\n|                  ID                  | Status | Name | Size | Volume Type | Bootable | Multiattach |             Attached to              |\n+--------------------------------------+--------+------+------+-------------+----------+-------------+--------------------------------------+\n| 7e794c92-9027-4cb0-a9ab-ba8036e9bbf7 | in-use | hoge |  1   |  drbdmanage |  false   |    False    | c747b0d4-bb0a-4f3c-a377-0f1a8752b0c6 |\n+--------------------------------------+--------+------+------+-------------+----------+-------------+--------------------------------------+\n\n\n\u6b63\u5e38\u6027\u78ba\u8a8d\n\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3078\u30ed\u30b0\u30a4\u30f3\u3057\u3066\u30d6\u30ed\u30c3\u30af\u30c7\u30d0\u30a4\u30b9\u304c\u8a8d\u8b58\u3067\u304d\u3066\u3044\u308b\u304b\u3001Read/Write \u3067\u304d\u308b\u304b\u78ba\u8a8d\u3002\n\u4ee5\u4e0b\u306f ip \u30b3\u30de\u30f3\u30c9\u3067\u30cd\u30fc\u30e0\u30b9\u30da\u30fc\u30b9\uff08qrouter-xxxxx-xxxx \uff09\u6307\u5b9a\u3067\u30ed\u30b0\u30a4\u30f3\u3057\u3066\u308b\u4f8b\u3002\n# ip netns exec qrouter-xxxxx-xxxx ssh -i cloud.key root@10.10.10.1\nLast login: Wed Dec  2 14:43:12 2015 from 192.168.0.70\n[fedora@demo-fedora23 ~]$\n\n\n\u78ba\u8a8d\uff1alsblk , blockdev --report , mkfs. , mount  , dd \u306a\u3069\n\u30c7\u30bf\u30c3\u30c1\uff1anova volume-detach \uff1cinstance\uff1e \uff1cvolume id\uff1e\n\n[fedora@demo-fedora23 ~]$ lsblk\nNAME   MAJ:MIN RM SIZE RO TYPE MOUNTPOINT\nvda    252:0    0  20G  0 disk\n`-vda1 252:1    0  20G  0 part /\nvdb    252:16   0   1G  0 disk\n\n[fedora@demo-fedora23 ~]$ sudo blockdev --report\nRO    RA   SSZ   BSZ   StartSec            Size   Device\nrw   256   512  4096          0     21474836480   /dev/vda\nrw   256   512  4096       2048     21473787904   /dev/vda1\nrw   256   512  4096          0      1073741824   /dev/vdb\n\n\n\u307e\u3068\u3081\n\u3053\u3053\u3067\u306f\u3001\u30c9\u30e9\u30a4\u30d0\u306e\u52d5\u4f5c\u306b\u3064\u3044\u3066\u4e2d\u5fc3\u306b\u78ba\u8a8d\u3057\u3066\u307f\u307e\u3057\u305f\u3002\u671f\u5f85\u3055\u308c\u305f\u52d5\u4f5c\u306f\u884c\u308f\u308c\u3066\u3044\u308b\u6a21\u69d8\u3002\u5b9f\u969b\u306e\u904b\u7528\u3067\u4f7f\u3046\u5834\u5408\u306f DRBD \u306f\u5f53\u7136\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u69cb\u6210\u306b\u306a\u308b\u3002\u307e\u305f\u3001Cinder \u5074\u306e HA \u306b\u3082\u8003\u616e\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u3001DRBD9 \u3067\u5229\u7528\u53ef\u80fd\u306a DRBD Client \u3082\u5408\u308f\u305b\u3066\u6d3b\u7528\u3057\u30d9\u30b9\u30c8\u30d7\u30e9\u30af\u30c6\u30a3\u30b9\u306a\u69cb\u6210\u3092\u6a21\u7d22\u3057\u3066\u307f\u308b\u3002\n\n\u53c2\u8003\n\nhttps://www.rdoproject.org/\nhttp://drbd.linbit.com/users-guide-9.0/s-openstack-install.html#s-openstack-addtl-conf\nhttp://docs.openstack.org/ja/user-guide/cli_cheat_sheet.html\nhttp://docs.openstack.org/ja/openstack-ops/content/attach_block_storage.html\n\n\n\u6b21\u56de\u306e\u8a18\u4e8b\nSheile \u3055\u3093\u306b\u306e\u6295\u7a3f\u3067\u3059\u3002\u300c\u30aa\u30ec\u30aa\u30ecSSL\u8a3c\u660e\u66f8\u300d\u306b\u3064\u3044\u3066\u3068\u3044\u3046\u3053\u3068\u3067\u697d\u3057\u307f\u3067\u3042\u308a\u307e\u3059\u3002\u3057\u3044\u305f\u3051\u304c\u5acc\u3044\u306a\u306e\u304b\u306a\uff1f\u81ea\u5206\u306f\u7389\u306d\u304e\u304c\u5acc\u3044\u3067\u3059\u3002\nDRBD \u306f DRBD9 \u304b\u3089\u642d\u8f09\u3055\u308c\u305f drbdmanage \u3092\u6d3b\u7528\u3057\u3001OpenStack Cinder \u3068\u9023\u643a\u3059\u308b\u3053\u3068\u304c\u53ef\u80fd\u3067\u3042\u308b\u3002Cinder Volume Driver \u306f OpenStack LIBERTY Release \u304b\u3089\u6a19\u6e96\u642d\u8f09\u3055\u308c\u3066\u3044\u308b\u3002\n\nhttp://drbd.linbit.com/users-guide-9.0/s-openstack-install.html#s-openstack-addtl-conf\n\n\u3053\u3053\u3067\u306f\u3001**1\u30ce\u30fc\u30c9** \u3067\u3072\u3068\u307e\u305a\u3053\u306e DRBD9 \u7528\u306e Cinder Volume Driver\uff08drbdmanagedrv.py\uff09 \u306e\u52d5\u4f5c\u3092\u78ba\u8a8d\u3059\u308b\u624b\u9806\u3092\u5217\u6319\u3059\u308b\u3002\u306a\u304a\u3001\u57fa\u672c\u7684\u306a\u3068\u3053\u308d\u306f\u5272\u611b\u3057\u3066\u3044\u308b\u3002\n\n\u6982\u7565\u56f3\n![2015-12-01 15-46-43.jpg](https://qiita-image-store.s3.amazonaws.com/0/75458/1f8d1f66-4520-e8a3-d8fd-25ca9c876529.jpeg)\n\n# \u30de\u30b7\u30f3\u306e\u6e96\u5099\n\n\u7269\u7406\u3067\u3082\u4eee\u60f3\u3067\u3082\u826f\u3044\u304c\u3001\u4ee5\u4e0b\u306e\u30b9\u30da\u30c3\u30af\u304c\u3042\u308b\u3068\u3044\u3044\u3002\n\n* CPU x2\n* **\u30e1\u30e2\u30ea4GB\u4ee5\u4e0a**\n* NIC\u306f1\u3064\u3067\u3082\n* **DISK\u306f30GB\u4ee5\u4e0a**\n* Linux\u30c7\u30a3\u30b9\u30c8\u30ea\u30d3\u30e5\u30fc\u30b7\u30e7\u30f3\u306f\u3053\u3053\u3067\u306f CentOS 7\n\n# RDO Allinone \u306e\u6e96\u5099\n\nCentOS 7 x86_64 \u4ee5\u964d\u3078 RDO \u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u666e\u901a\u306b OpenStack \u306e\u5404 Core \u30b5\u30fc\u30d3\u30b9\u304c\u52d5\u304f\u3068\u3053\u308d\u307e\u3067\u6e96\u5099\u3059\u308b\u3002Nova \u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306f1\u3064 cirros \u3067\u3088\u3044\u306e\u3067\u4f5c\u3063\u3066\u304a\u304f\u3002\n\n\n\n# DRBD9 \u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n\u4eca\u56de\u306f\u30d1\u30c3\u30b1\u30fc\u30b8\u7248\u3092\u4f7f\u3063\u3066\u3044\u308b\u304c\u3001\u30bd\u30fc\u30b9\u304b\u3089\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u305f\u3082\u306e\u3092\u4f7f\u3063\u3066\u3082\u826f\u3044\u3002\n\n```shell-session\n# cat /etc/redhat-release\nDerived from Red Hat Enterprise Linux 7.1 (Source)\n\n# cat /etc/yum.repos.d/linbit.repo\n[drbd-9.0]\nname=LINBIT Packages for drbd-9.0 - $basearch\nbaseurl=http://packages.linbit.com/<\u30b5\u30dd\u30fc\u30c8\u8a3c\u66f8\u306b\u3042\u308b\u30cf\u30c3\u30b7\u30e5>/yum/rhel7.1/drbd-9.0/$basearch\nenabled=1\ngpgcheck=0\n\n# yum install kmod-drbd drbd drbdmanage\n```\n\n## \u30d1\u30c3\u30b1\u30fc\u30b8\u629c\u7c8b\n\n* drbd-8.9.4-1.el7.x86_64\n* drbdmanage-0.50-1.noarch\n* kmod-drbd-9.0.0_3.10.0_229.7.2-3.el7.x86_64\n\n# loopback \u3067 DRBD\u7528\u306e\u30c7\u30d0\u30a4\u30b9\u3092\u4f5c\u308b\n\u5916\u90e8\u30d6\u30ed\u30c3\u30af\u30c7\u30d0\u30a4\u30b9\u3092\u8ffd\u52a0\u3067\u304d\u308b\u306e\u3067\u3042\u308c\u3070\u305d\u306e\u30c7\u30d0\u30a4\u30b9\u3092\u4f7f\u3063\u3066\u3082\u826f\u3044\u304c\u30b3\u30b3\u3067\u306f\u624b\u3063\u53d6\u308a\u65e9\u304f\u4eee\u60f3\u7684\u306b\u3064\u304f\u308b\u3002\n\n* Allinone \u306e\u5834\u5408 loop0 , loop1 \u306f Swift , cinder \u3067\u4f7f\u308f\u308c\u3066\u3044\u308b\u306e\u3067\u6ce8\u610f\n\n```shell-session\n# dd if=/dev/zero of=disk01 bs=1M count=10000\n# dd if=/dev/zero of=disk02 bs=1M count=10000\n# losetup /dev/loop2 /root/disk01\n# losetup /dev/loop3 /root/disk02\n# vgcreate drbdpool /dev/loop2 /dev/loop3\n```\n\n* \u78ba\u8a8d\uff1alosetup\n* \u306f\u305a\u3059\u306b\u306f losetup -d \uff1cloopdev\uff1e\n\n# DRBD \u30a4\u30cb\u30b7\u30e3\u30e9\u30a4\u30ba\n\n```shell-session\n# drbdmanage init <IP Address>\n```\n\n* \u78ba\u8a8d\uff1adrbdmanage list-nodes\n\n```shell-session\n[root@akira ~]# drbdmanage list-nodes\n+------------------------------------------------------------------------------------------------------------+\n| Name         | Pool Size | Pool Free | Site |                                                      | State |\n+------------------------------------------------------------------------------------------------------------+\n| akira.tk.net |      9992 |      9984 |  N/A |                                                      |    ok |\n+------------------------------------------------------------------------------------------------------------+\n```\n\n# drbdmanage driver \u8a2d\u5b9a\n\n## cinder.conf\n\n```shell-session\n[DEFAULT]\nenabled_backends=lvm,drbdmanage\n\n\uff08\u7565\uff09\n\n[drbdmanage]\niscsi_helper=lioadm\nhttp://docs.openstack.org/admin-guide-cloud/blockstorage-lio-iscsi-support.html\nrestart cinder-volume\n```\n\n> iscsi_helper=lioadm \u306b\u3057\u3066\u3044\u308b\u306e\u306f\u30c7\u30d5\u30a9\u30eb\u30c8\u306e tgtadm \u306f\u5165\u3063\u3066\u3044\u306a\u3044\u305f\u3081\n> Linux IO Target\u30fb\u30fb\u30fbhttp://linux-iscsi.org/wiki/LIO\n\n## \u30dc\u30ea\u30e5\u30fc\u30e0\u30bf\u30a4\u30d7\u4f5c\u6210\n\n```shell-session\n[root ~ root] source adminrc\n[root ~(keystone_admin)] cinder type-create drbdmanage\n[root ~(keystone_admin)] cinder type-key drbdmanage set volume_backend_name=drbdmanage\n```\n\n* \u78ba\u8a8d\uff1acinder type-list\n* \u78ba\u8a8d\uff1acinder extra-specs-list\n\n```shell-session\n[root@akira ~(keystone_admin)]# cinder type-list\n+--------------------------------------+------------+-------------+-----------+\n|                  ID                  |    Name    | Description | Is_Public |\n+--------------------------------------+------------+-------------+-----------+\n| 0caf8530-7853-4fea-84dd-59d41ebc9510 |   iscsi    |      -      |    True   |\n| c5b09398-fb34-4398-b3b2-3e29a2859ee2 | drbdmanage |      -      |    True   |\n+--------------------------------------+------------+-------------+-----------+\n[root@akira ~(keystone_admin)]# cinder extra-specs-list\n+--------------------------------------+------------+-----------------------------------------+\n|                  ID                  |    Name    |               extra_specs               |\n+--------------------------------------+------------+-----------------------------------------+\n| 0caf8530-7853-4fea-84dd-59d41ebc9510 |   iscsi    |     {u'volume_backend_name': u'lvm'}    |\n| c5b09398-fb34-4398-b3b2-3e29a2859ee2 | drbdmanage | {u'volume_backend_name': u'drbdmanage'} |\n+--------------------------------------+------------+-----------------------------------------+\n```\n\n## dbus \u3078\u306e\u30a2\u30af\u30bb\u30b9\u8a31\u53ef\n\n/etc/dbus-1/system.d/org.drbd.drbdmanaged.conf \u3092\u7de8\u96c6\u3059\u308b\u3002\n\n```shell-session\n# cat /etc/dbus-1/system.d/org.drbd.drbdmanaged.conf\n<!DOCTYPE busconfig PUBLIC\n\"-//freedesktop//DTD D-BUS Bus Configuration 1.0//EN\"\n\"http://www.freedesktop.org/standards/dbus/1.0/busconfig.dtd\">\n<busconfig>\n  <policy user=\"0\">\n      <allow own=\"org.drbd.drbdmanaged\"/>\n      <allow send_interface=\"org.drbd.drbdmanaged\"/>\n      <allow send_destination=\"org.drbd.drbdmanaged\"/>\n  </policy>\n  <policy user=\"cinder\">                               # \u30b3\u30b3\u8ffd\u52a0\n      <allow own=\"org.drbd.drbdmanaged\"/>              # \u30b3\u30b3\u8ffd\u52a0\n      <allow send_interface=\"org.drbd.drbdmanaged\"/>   # \u30b3\u30b3\u8ffd\u52a0\n      <allow send_destination=\"org.drbd.drbdmanaged\"/> # \u30b3\u30b3\u8ffd\u52a0\n  </policy>                                            # \u30b3\u30b3\u8ffd\u52a0\n</busconfig>\n```\n> user \u306e\u5024\u306f cinder-volume \u304c\u8d77\u52d5\u3055\u308c\u3066\u3044\u308b\u30e6\u30fc\u30b6\u3092\u5165\u308c\u308b\n\n## cinder-volume \u518d\u8d77\u52d5\n\n```shell-session\n# systemctl restart openstack-cinder-volume\n```\n* \u78ba\u8a8d\uff1acinder service-list (admin \u6a29\u9650\u3001**up** \u3068\u306a\u308b\u307e\u3067\u5c11\u3057\u6642\u9593\u304c\u304b\u304b\u308b\u5834\u5408\u3042\u308a)\n* \u30a8\u30e9\u30fc\u304c\u306a\u3044\u304b\u78ba\u8a8d\uff1a/var/log/cinder/volume.log\n\n```shell-session\n[root@akira ~(keystone_admin)]# cinder service-list\n+------------------+-------------------------+------+---------+-------+----------------------------+-----------------+\n|      Binary      |           Host          | Zone |  Status | State |         Updated_at         | Disabled Reason |\n+------------------+-------------------------+------+---------+-------+----------------------------+-----------------+\n|  cinder-backup   |       akira.tk.net      | nova | enabled |   up  | 2015-12-02T14:18:13.000000 |        -        |\n| cinder-scheduler |       akira.tk.net      | nova | enabled |   up  | 2015-12-02T14:18:11.000000 |        -        |\n|  cinder-volume   | akira.tk.net@drbdmanage | nova | enabled |   up  | 2015-12-02T14:18:06.000000 |        -        |\n|  cinder-volume   |     akira.tk.net@lvm    | nova | enabled |   up  | 2015-12-02T14:18:06.000000 |        -        |\n+------------------+-------------------------+------+---------+-------+----------------------------+-----------------+\n```\n\n# \u8a66\u884c\n## \u30d6\u30ed\u30c3\u30af\u30c7\u30d0\u30a4\u30b9\u4f5c\u6210\uff08Cinder Volume\uff09\n\n```shell-session\n[root ~] source demorc\n[root ~(keystone_demo)] cinder create --display-name=hoge --volume-type drbdmanage 1\n```\n\n* \u78ba\u8a8d\uff1acinder list\n* \u30a8\u30e9\u30fc\u304c\u306a\u3044\u304b\u78ba\u8a8d\uff1a/var/log/cinder/volume.log\n* drbdmanage \u3067\u3082\u78ba\u8a8d\u3067\u304d\u308b\uff1adrbdmanage list-volumes\n* \u30dc\u30ea\u30e5\u30fc\u30e0\u306e\u72b6\u614b\u78ba\u8a8d\uff1adrbdsetup status\n* lvdisplay \uff08Cinder Volume Driver \u7d4c\u7531\u3001drbdmanage \u306b\u3088\u308a LV \u304c\u4f5c\u3089\u308c\u3066\u3044\u308b\uff09\n* \u524a\u9664\uff1acinder delete\n\n```shell-session\n[root@akira ~(keystone_demo)]# cinder list\n+--------------------------------------+-----------+------+------+-------------+----------+-------------+-------------+\n|                  ID                  |   Status  | Name | Size | Volume Type | Bootable | Multiattach | Attached to |\n+--------------------------------------+-----------+------+------+-------------+----------+-------------+-------------+\n| 7e794c92-9027-4cb0-a9ab-ba8036e9bbf7 | available | hoge |  1   |  drbdmanage |  false   |    False    |             |\n+--------------------------------------+-----------+------+------+-------------+----------+-------------+-------------+\n\n[root@akira ~(keystone_demo)]# drbdmanage list-volumes\n+------------------------------------------------------------------------------------------------------------+\n| Name                                    | Vol ID | Size | Minor |                                  | State |\n+------------------------------------------------------------------------------------------------------------+\n| CV_7e794c92-9027-4cb0-a9ab-ba8036e9bbf7 |      0 | 1024 |   100 |                                  |    ok |\n+------------------------------------------------------------------------------------------------------------+\n\n[root@akira ~(keystone_demo)]# drbdsetup status\n.drbdctrl role:Secondary\n  volume:0 disk:UpToDate\n  volume:1 disk:UpToDate\n\nCV_7e794c92-9027-4cb0-a9ab-ba8036e9bbf7 role:Secondary\n  disk:Inconsistent\n\n[root@akira ~(keystone_demo)]# lvdisplay\n\uff08\u7565\uff09\n  --- Logical volume ---\n  LV Path                /dev/drbdpool/CV_7e794c92-9027-4cb0-a9ab-ba8036e9bbf7_00\n  LV Name                CV_7e794c92-9027-4cb0-a9ab-ba8036e9bbf7_00\n  VG Name                drbdpool\n  LV UUID                DVl32e-vG6p-9228-spkF-HIEn-J55Z-0rpSAQ\n  LV Write Access        read/write\n  LV Creation host, time akira.tk.net, 2015-12-02 23:20:45 +0900\n  LV Status              available\n  # open                 2\n  LV Size                1.00 GiB\n  Current LE             257\n  Segments               1\n  Allocation             inherit\n  Read ahead sectors     auto\n  - currently set to     8192\n  Block device           253:5\n```\n\n## \u30a4\u30ec\u30ae\u30e5\u30e9\u30fcTips\n\n\u4eca\u56de\u306e\u69cb\u6210\u3067\u306f\u30011\u30ce\u30fc\u30c9\u3067\u5168\u90e8\u5165\u308c\u8fbc\u3093\u3067\u3057\u307e\u3063\u3066\u304a\u308a\u3001DRBD \u3092\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3057\u306a\u3044\u72b6\u614b\u3067\u7247\u80ba\u30dc\u30ea\u30e5\u30fc\u30e0\u3068\u3057\u3066\u5229\u7528\u3059\u308b\u305f\u3081\u3053\u306eTips\u304c\u5fc5\u8981\u3002\n\n> \u901a\u5e38\u306f DRBD \u5074\u306f\u30df\u30e9\u30fc\u30dc\u30ea\u30e5\u30fc\u30e0\u3068\u306a\u308b\u306e\u3067\u672c\u64cd\u4f5c\u306f\u5fc5\u8981\u306a\u3044\u3002\n\n```drbdsetup status``` \u3067\u78ba\u8a8d\u3057\u305f\u3068\u304d\u3001\u8a72\u5f53\u3059\u308b\u30dc\u30ea\u30e5\u30fc\u30e0\u306e ```disk:Inconsistent``` \u304c **disk:UpToDate** \u3067\u306a\u3044\u3068 Nova \u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306b\u30a2\u30bf\u30c3\u30c1\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u306a\u3044\u3002\u3088\u3063\u3066\u5f37\u5236\u7684\u306b\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u5909\u66f4\u3059\u308b\u3002\n\n```shell-session\n[root@akira ~(keystone_demo)]# drbdsetup primary CV_7e794c92-9027-4cb0-a9ab-ba8036e9bbf7 --force=yes\n[root@akira ~(keystone_demo)]# drbdsetup secondary CV_7e794c92-9027-4cb0-a9ab-ba8036e9bbf7\n[root@akira ~(keystone_demo)]# drbdsetup status\n.drbdctrl role:Secondary\n  volume:0 disk:UpToDate\n  volume:1 disk:UpToDate\n\nCV_7e794c92-9027-4cb0-a9ab-ba8036e9bbf7 role:Secondary\n  disk:UpToDate\n```\n\n## Nova \u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3078\u30a2\u30bf\u30c3\u30c1\n\u30a2\u30bf\u30c3\u30c1\u3059\u308b Cinder Volume \u306e ID \u306f ```cinder list``` \u7b49\u3067\u78ba\u8a8d\u3057\u3068\u304f\u3002\n\n```shell-session\n[root@akira ~(keystone_demo)]# nova volume-attach demo-fedora23  7e794c92-9027-4cb0-a9ab-ba8036e9bbf7  auto\n+----------+--------------------------------------+\n| Property | Value                                |\n+----------+--------------------------------------+\n| device   | /dev/vdb                             |\n| id       | 7e794c92-9027-4cb0-a9ab-ba8036e9bbf7 |\n| serverId | c747b0d4-bb0a-4f3c-a377-0f1a8752b0c6 |\n| volumeId | 7e794c92-9027-4cb0-a9ab-ba8036e9bbf7 |\n+----------+--------------------------------------+\n```\n\n* \u30a8\u30e9\u30fc\u304c\u306a\u3044\u304b\u78ba\u8a8d\uff1a/var/log/cinder/volume.log\n* \u30a8\u30e9\u30fc\u304c\u306a\u3044\u304b\u78ba\u8a8d\uff1a/var/log/nova/nova-comupte.log\n* \u78ba\u8a8d\uff1acinder list\n* \u78ba\u8a8d\uff1anova show\n\n```shell-session\n[root@akira ~(keystone_demo)]# cinder list\n+--------------------------------------+--------+------+------+-------------+----------+-------------+--------------------------------------+\n|                  ID                  | Status | Name | Size | Volume Type | Bootable | Multiattach |             Attached to              |\n+--------------------------------------+--------+------+------+-------------+----------+-------------+--------------------------------------+\n| 7e794c92-9027-4cb0-a9ab-ba8036e9bbf7 | in-use | hoge |  1   |  drbdmanage |  false   |    False    | c747b0d4-bb0a-4f3c-a377-0f1a8752b0c6 |\n+--------------------------------------+--------+------+------+-------------+----------+-------------+--------------------------------------+\n```\n\n## \u6b63\u5e38\u6027\u78ba\u8a8d\n\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3078\u30ed\u30b0\u30a4\u30f3\u3057\u3066\u30d6\u30ed\u30c3\u30af\u30c7\u30d0\u30a4\u30b9\u304c\u8a8d\u8b58\u3067\u304d\u3066\u3044\u308b\u304b\u3001Read/Write \u3067\u304d\u308b\u304b\u78ba\u8a8d\u3002\n\u4ee5\u4e0b\u306f ip \u30b3\u30de\u30f3\u30c9\u3067\u30cd\u30fc\u30e0\u30b9\u30da\u30fc\u30b9\uff08qrouter-xxxxx-xxxx \uff09\u6307\u5b9a\u3067\u30ed\u30b0\u30a4\u30f3\u3057\u3066\u308b\u4f8b\u3002\n\n```shell-session\n# ip netns exec qrouter-xxxxx-xxxx ssh -i cloud.key root@10.10.10.1\nLast login: Wed Dec  2 14:43:12 2015 from 192.168.0.70\n[fedora@demo-fedora23 ~]$\n```\n\n* \u78ba\u8a8d\uff1alsblk , blockdev --report , mkfs.<filesystem> , mount  , dd \u306a\u3069\n* \u30c7\u30bf\u30c3\u30c1\uff1anova volume-detach \uff1cinstance\uff1e \uff1cvolume id\uff1e\n\n```shell-session\n[fedora@demo-fedora23 ~]$ lsblk\nNAME   MAJ:MIN RM SIZE RO TYPE MOUNTPOINT\nvda    252:0    0  20G  0 disk\n`-vda1 252:1    0  20G  0 part /\nvdb    252:16   0   1G  0 disk\n\n[fedora@demo-fedora23 ~]$ sudo blockdev --report\nRO    RA   SSZ   BSZ   StartSec            Size   Device\nrw   256   512  4096          0     21474836480   /dev/vda\nrw   256   512  4096       2048     21473787904   /dev/vda1\nrw   256   512  4096          0      1073741824   /dev/vdb\n```\n\n# \u307e\u3068\u3081\n\u3053\u3053\u3067\u306f\u3001\u30c9\u30e9\u30a4\u30d0\u306e\u52d5\u4f5c\u306b\u3064\u3044\u3066\u4e2d\u5fc3\u306b\u78ba\u8a8d\u3057\u3066\u307f\u307e\u3057\u305f\u3002\u671f\u5f85\u3055\u308c\u305f\u52d5\u4f5c\u306f\u884c\u308f\u308c\u3066\u3044\u308b\u6a21\u69d8\u3002\u5b9f\u969b\u306e\u904b\u7528\u3067\u4f7f\u3046\u5834\u5408\u306f DRBD \u306f\u5f53\u7136\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u69cb\u6210\u306b\u306a\u308b\u3002\u307e\u305f\u3001Cinder \u5074\u306e HA \u306b\u3082\u8003\u616e\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u3001DRBD9 \u3067\u5229\u7528\u53ef\u80fd\u306a DRBD Client \u3082\u5408\u308f\u305b\u3066\u6d3b\u7528\u3057\u30d9\u30b9\u30c8\u30d7\u30e9\u30af\u30c6\u30a3\u30b9\u306a\u69cb\u6210\u3092\u6a21\u7d22\u3057\u3066\u307f\u308b\u3002\n\n# \u53c2\u8003\n\n* https://www.rdoproject.org/\n* http://drbd.linbit.com/users-guide-9.0/s-openstack-install.html#s-openstack-addtl-conf\n* http://docs.openstack.org/ja/user-guide/cli_cheat_sheet.html\n* http://docs.openstack.org/ja/openstack-ops/content/attach_block_storage.html\n\n# \u6b21\u56de\u306e\u8a18\u4e8b\n[Sheile](http://qiita.com/Sheile) \u3055\u3093\u306b\u306e\u6295\u7a3f\u3067\u3059\u3002\u300c\u30aa\u30ec\u30aa\u30ecSSL\u8a3c\u660e\u66f8\u300d\u306b\u3064\u3044\u3066\u3068\u3044\u3046\u3053\u3068\u3067\u697d\u3057\u307f\u3067\u3042\u308a\u307e\u3059\u3002\u3057\u3044\u305f\u3051\u304c\u5acc\u3044\u306a\u306e\u304b\u306a\uff1f\u81ea\u5206\u306f\u7389\u306d\u304e\u304c\u5acc\u3044\u3067\u3059\u3002\n"}