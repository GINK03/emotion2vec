{"context": " More than 1 year has passed since last update.mochalog\u304b\u3089\u306e\u8ee2\u8f09\u3067\u3059\u3002\nASP.NET MVC\u3067\u306e\u96c6\u7d04\u4f8b\u5916\u51e6\u7406\u306e\u5b9f\u88c5\u4f8b\u3067\u3059\u3002\n\u30ed\u30b0\u306e\u51fa\u529b\u51e6\u7406\u3068Ajax\u30ea\u30af\u30a8\u30b9\u30c8\u51e6\u7406\u6642\u306e\u632f\u308b\u821e\u3044\u306e\u5909\u66f4\u3092\u3057\u307e\u3059\u3002\n\nHandleErrorAttribute.OnException\nController\u5185\u3067\u8d77\u304d\u305f\u4f8b\u5916\u3092\u51e6\u7406\u3059\u308b\u96c6\u7d04\u4f8b\u5916\u30cf\u30f3\u30c9\u30e9\u3092\u5b9f\u88c5\u3057\u307e\u3059\u3002\nAjax\u30ea\u30af\u30a8\u30b9\u30c8\u306e\u5834\u5408\u306f\u30c7\u30d5\u30a9\u30eb\u30c8\u306e\u4f8b\u5916\u51e6\u7406\u306f\u4f55\u3082\u305b\u305a\u3001\n\u30b9\u30c6\u30fc\u30bf\u30b9\u30b3\u30fc\u30c9\u3092500\u3001\u5fdc\u7b54\u672c\u6587\u3092\u4f8b\u5916\u60c5\u5831\u3092\u542b\u3093\u3060JSON\u306b\u3057\u3066\u3001\n$.ajax().fail()\u3067\u4f8b\u5916\u51e6\u7406\u3092\u3057\u3084\u3059\u304f\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\u306a\u304aLogUtil.LogControllerError()\u3068\u3044\u3046\u30e1\u30bd\u30c3\u30c9\u306f\u5225\u9014\u5b9a\u7fa9\u3055\u308c\u3066\u3044\u308b\u3082\u306e\u3068\u3057\u307e\u3059\u3002\npublic class GlobalHandleErrorAttribute: HandleErrorAttribute\n{\n    public override void OnException(ExceptionContext filterContext)\n    {\n        if (filterContext == null)\n        {\n            throw new ArgumentNullException(\"filterContext\");\n        }\n\n        /// \u4f8b\u5916\u767a\u751f\u6642\u306f\u5e38\u306b\u30ed\u30b0\u3092\u53d6\u3063\u3066\u304a\u304f\n        LogUtil.LogControllerError(filterContext);\n\n        if (filterContext.HttpContext.Request.IsAjaxRequest())\n        {\n            /// Application_Error\u306f\u547c\u3070\u308c\u306a\u3044\n            HandleAjaxRequestException(filterContext);\n        }\n        else\n        {\n            /// custom error\u304c\u6709\u52b9\u3067\u306a\u3051\u308c\u3070\n            /// base.OnException()\u3067ExceptionHandled\u304ctrue\u306b\u306a\u3089\u306a\u3044\u306e\u3067\n            /// Application_Error\u3082\u547c\u3070\u308c\u308b\n            base.OnException(filterContext);\n        }\n    }\n\n    private void HandleAjaxRequestException(ExceptionContext filterContext)\n    {\n        if (filterContext.ExceptionHandled)\n        {\n            return;\n        }\n\n        filterContext.Result = new JsonResult\n        {\n            Data = new {\n                Message = ex.ToString(),\n            };\n            JsonRequestBehavior = JsonRequestBehavior.AllowGet\n        };\n        filterContext.ExceptionHandled = true;\n        filterContext.HttpContext.Response.Clear();\n        filterContext.HttpContext.Response.StatusCode =\n            (int)HttpStatusCode.InternalServerError;\n        filterContext.HttpContext.Response.TrySkipIisCustomErrors = true;\n    }\n}\n\nFilterConfig.cs\u306eRegisterGlobalFilters()\u3092\u7de8\u96c6\u3057\u307e\u3059\u3002\n\u3082\u3068\u3082\u3068\u3042\u308bfilters.Add(new HandleErrorAttribute());\u3092\u30b3\u30e1\u30f3\u30c8\u30a2\u30a6\u30c8\u3057\u3066\u3001\n\u4ee3\u308f\u308a\u306bGlobalHandleErrorAttribute\u3092\u767b\u9332\u3057\u307e\u3059\u3002\npublic static void RegisterGlobalFilters(GlobalFilterCollection filters)\n{\n    //filters.Add(new HandleErrorAttribute());\n    filters.Add(new GlobalHandleErrorAttribute());\n}\n\n\nApplication_Error\nController\u5916\u3067\u8d77\u304d\u305f\u4f8b\u5916\u3092\u88dc\u8db3\u3059\u308b\u306b\u306fApplication_Error()\u3092\u5b9a\u7fa9\u3057\u307e\u3059\u3002\n\u306a\u304aLogUtil.LogError()\u3068LogUtil.LogErrorSimple()\u3068\u3044\u3046\u30e1\u30bd\u30c3\u30c9\u306f\u5225\u9014\u5b9a\u7fa9\u3055\u308c\u3066\u3044\u308b\u3082\u306e\u3068\u3057\u307e\u3059\u3002\nprotected void Application_Error(object sender, EventArgs e)\n{\n    if (Server != null)\n    {\n        var ex = Server.GetLastError();\n        if (ex != null)\n        {\n            if (ex is HttpException &&\n                ((HttpException)ex).GetHttpCode() == (int)HttpStatusCode.NotFound)\n            {\n                /// NotFound\u3092\u76f8\u624b\u306b\u3059\u308b\u3068\u30ed\u30b0\u304c\u5927\u5909\u306b\u306a\u308b\u306e\u3067\u7121\u8996\n                return;\n            }\n\n            /// CustomError\u304c\u7121\u52b9\u306a\u5834\u5408\u306f\n            /// Controller\u5185\u3067\u304a\u304d\u305f\u4f8b\u5916\u304c\u4e8c\u91cd\u306b\u30ed\u30b0\u51fa\u529b\u3055\u308c\u3066\u3057\u307e\u3046\u3053\u3068\u306b\u6ce8\u610f\u3002\n            /// CustomError\u304c\u6709\u52b9\u306a\u5834\u5408\u306f\n            /// Controller\u5916\u3067\u304a\u304d\u305f\u4f8b\u5916\u306e\u307f\u3053\u3053\u3067\u30ed\u30b0\u51fa\u529b\u3055\u308c\u308b\u3002\n            try\n            {\n                LogUtil.LogError(ex, HttpContext.Current);\n            }\n            catch (Exception)\n            {\n                LogUtil.LogErrorSimple(ex);\n            }\n        }\n    }\n}\n\n[mochalog](http://blog.mochaware.jp/20140206/378.html)\u304b\u3089\u306e\u8ee2\u8f09\u3067\u3059\u3002\n\nASP.NET MVC\u3067\u306e\u96c6\u7d04\u4f8b\u5916\u51e6\u7406\u306e\u5b9f\u88c5\u4f8b\u3067\u3059\u3002\n\u30ed\u30b0\u306e\u51fa\u529b\u51e6\u7406\u3068Ajax\u30ea\u30af\u30a8\u30b9\u30c8\u51e6\u7406\u6642\u306e\u632f\u308b\u821e\u3044\u306e\u5909\u66f4\u3092\u3057\u307e\u3059\u3002\n\n## HandleErrorAttribute.OnException\n\nController\u5185\u3067\u8d77\u304d\u305f\u4f8b\u5916\u3092\u51e6\u7406\u3059\u308b\u96c6\u7d04\u4f8b\u5916\u30cf\u30f3\u30c9\u30e9\u3092\u5b9f\u88c5\u3057\u307e\u3059\u3002\n\nAjax\u30ea\u30af\u30a8\u30b9\u30c8\u306e\u5834\u5408\u306f\u30c7\u30d5\u30a9\u30eb\u30c8\u306e\u4f8b\u5916\u51e6\u7406\u306f\u4f55\u3082\u305b\u305a\u3001\n\u30b9\u30c6\u30fc\u30bf\u30b9\u30b3\u30fc\u30c9\u3092500\u3001\u5fdc\u7b54\u672c\u6587\u3092\u4f8b\u5916\u60c5\u5831\u3092\u542b\u3093\u3060JSON\u306b\u3057\u3066\u3001\n$.ajax().fail()\u3067\u4f8b\u5916\u51e6\u7406\u3092\u3057\u3084\u3059\u304f\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\n\u306a\u304a`LogUtil.LogControllerError()`\u3068\u3044\u3046\u30e1\u30bd\u30c3\u30c9\u306f\u5225\u9014\u5b9a\u7fa9\u3055\u308c\u3066\u3044\u308b\u3082\u306e\u3068\u3057\u307e\u3059\u3002\n\n```csharp\npublic class GlobalHandleErrorAttribute: HandleErrorAttribute\n{\n    public override void OnException(ExceptionContext filterContext)\n    {\n        if (filterContext == null)\n        {\n            throw new ArgumentNullException(\"filterContext\");\n        }\n\n        /// \u4f8b\u5916\u767a\u751f\u6642\u306f\u5e38\u306b\u30ed\u30b0\u3092\u53d6\u3063\u3066\u304a\u304f\n        LogUtil.LogControllerError(filterContext);\n\n        if (filterContext.HttpContext.Request.IsAjaxRequest())\n        {\n            /// Application_Error\u306f\u547c\u3070\u308c\u306a\u3044\n            HandleAjaxRequestException(filterContext);\n        }\n        else\n        {\n            /// custom error\u304c\u6709\u52b9\u3067\u306a\u3051\u308c\u3070\n            /// base.OnException()\u3067ExceptionHandled\u304ctrue\u306b\u306a\u3089\u306a\u3044\u306e\u3067\n            /// Application_Error\u3082\u547c\u3070\u308c\u308b\n            base.OnException(filterContext);\n        }\n    }\n\n    private void HandleAjaxRequestException(ExceptionContext filterContext)\n    {\n        if (filterContext.ExceptionHandled)\n        {\n            return;\n        }\n\n        filterContext.Result = new JsonResult\n        {\n            Data = new {\n                Message = ex.ToString(),\n            };\n            JsonRequestBehavior = JsonRequestBehavior.AllowGet\n        };\n        filterContext.ExceptionHandled = true;\n        filterContext.HttpContext.Response.Clear();\n        filterContext.HttpContext.Response.StatusCode =\n            (int)HttpStatusCode.InternalServerError;\n        filterContext.HttpContext.Response.TrySkipIisCustomErrors = true;\n    }\n}\n```\n\nFilterConfig.cs\u306eRegisterGlobalFilters()\u3092\u7de8\u96c6\u3057\u307e\u3059\u3002\n\u3082\u3068\u3082\u3068\u3042\u308b`filters.Add(new HandleErrorAttribute());`\u3092\u30b3\u30e1\u30f3\u30c8\u30a2\u30a6\u30c8\u3057\u3066\u3001\n\u4ee3\u308f\u308a\u306bGlobalHandleErrorAttribute\u3092\u767b\u9332\u3057\u307e\u3059\u3002\n\n```csharp\npublic static void RegisterGlobalFilters(GlobalFilterCollection filters)\n{\n    //filters.Add(new HandleErrorAttribute());\n    filters.Add(new GlobalHandleErrorAttribute());\n}\n```\n\n## Application_Error\n\nController\u5916\u3067\u8d77\u304d\u305f\u4f8b\u5916\u3092\u88dc\u8db3\u3059\u308b\u306b\u306fApplication_Error()\u3092\u5b9a\u7fa9\u3057\u307e\u3059\u3002\n\n\u306a\u304a`LogUtil.LogError()`\u3068`LogUtil.LogErrorSimple()`\u3068\u3044\u3046\u30e1\u30bd\u30c3\u30c9\u306f\u5225\u9014\u5b9a\u7fa9\u3055\u308c\u3066\u3044\u308b\u3082\u306e\u3068\u3057\u307e\u3059\u3002\n\n```csharp\nprotected void Application_Error(object sender, EventArgs e)\n{\n    if (Server != null)\n    {\n        var ex = Server.GetLastError();\n        if (ex != null)\n        {\n            if (ex is HttpException &&\n                ((HttpException)ex).GetHttpCode() == (int)HttpStatusCode.NotFound)\n            {\n                /// NotFound\u3092\u76f8\u624b\u306b\u3059\u308b\u3068\u30ed\u30b0\u304c\u5927\u5909\u306b\u306a\u308b\u306e\u3067\u7121\u8996\n                return;\n            }\n            \n            /// CustomError\u304c\u7121\u52b9\u306a\u5834\u5408\u306f\n            /// Controller\u5185\u3067\u304a\u304d\u305f\u4f8b\u5916\u304c\u4e8c\u91cd\u306b\u30ed\u30b0\u51fa\u529b\u3055\u308c\u3066\u3057\u307e\u3046\u3053\u3068\u306b\u6ce8\u610f\u3002\n            /// CustomError\u304c\u6709\u52b9\u306a\u5834\u5408\u306f\n            /// Controller\u5916\u3067\u304a\u304d\u305f\u4f8b\u5916\u306e\u307f\u3053\u3053\u3067\u30ed\u30b0\u51fa\u529b\u3055\u308c\u308b\u3002\n            try\n            {\n                LogUtil.LogError(ex, HttpContext.Current);\n            }\n            catch (Exception)\n            {\n                LogUtil.LogErrorSimple(ex);\n            }\n        }\n    }\n}\n```\n", "tags": ["C#", "ASP.NET"]}