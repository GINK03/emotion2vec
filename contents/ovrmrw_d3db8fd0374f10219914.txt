{"context": "When\n2016/11/04\nAt\n#10 \u5e02\u30f6\u8c37Geek\u2605Night\u300c\u578b\u306e\u3042\u308b\u30d5\u30ed\u30f3\u30c8\u30a8\u30f3\u30c9\u306e\u4e16\u754c\u301c\u30d5\u30ed\u30f3\u30c8\u30a8\u30f3\u30c9\u30fb\u30d5\u30ed\u30f3\u30c6\u30a3\u30a2\u301c\u300d\n\n\n\u4eca\u56de\u306eGitHub\u30ea\u30dd\u30b8\u30c8\u30ea\novrmrw/graphql-server-dataloader\n\u30ea\u30dd\u30b8\u30c8\u30ea\u306b\u30c7\u30e2\u30b5\u30a4\u30c8\u3078\u306e\u30ea\u30f3\u30af\u304c\u3042\u308a\u307e\u3059\u3002\n===\n\u8a71\u3059\u5185\u5bb9\n\nGraphQL\u304c\u578b\u3092\u6301\u3063\u3066\u3044\u308b\u3053\u3068\u3067\u4f55\u304c\u5b09\u3057\u3044\u304b\u3002\nDataLoader\u306e\u5a01\u529b\u3002\n\n\n\n\u81ea\u5df1\u7d39\u4ecb\n\u3061\u304d\u3055\u3093\n(Tomohiro Noguchi)\ntwitter: @ovrmrw\n\u305f\u3060\u306eSIer\u3002\nAngular Japan User Group (ng-japan)\u30b9\u30bf\u30c3\u30d5\u3002\n\n\n\nAngular\u3068\u3066\u3082\u7c21\u5358\u3067\u3059\u3002\u307f\u3093\u306a\u4f7f\u3044\u307e\u3057\u3087\u3046\u3002\n\n\nGraphQL is what?\n\n\"A query language for your API\"\n\nFacebook\u304c\u4f5c\u3063\u305f\u30e9\u30a4\u30d6\u30e9\u30ea\u3002\nNetflix\u306eFalcor\u306b\u4f3c\u3066\u3044\u308b\u3051\u3069\u3082\u3063\u3068\u9ad8\u6a5f\u80fd\u3002\nFalcor\u306f\u30e1\u30f3\u30c6\u3055\u308c\u3066\u3044\u308b\u304b\u602a\u3057\u3044\u304c\u3053\u3061\u3089\u306f\u6d3b\u767a\u3002\n\u8981\u6c42\u3057\u305f\u5f62\u306eJSON\u3092\u8fd4\u3057\u3066\u304f\u308c\u308b\u3002\n\u30af\u30e9\u30a4\u30a2\u30f3\u30c8(\u30b9\u30de\u30db\u7b49)\u306f\u30ea\u30af\u30a8\u30b9\u30c8\u30921\u56de\u9001\u308b\u3060\u3051\u3067\u5b8c\u6210\u7248\u306eJSON\u3092\u53d7\u3051\u53d6\u308c\u308b\u3002\n\u30c7\u30fc\u30bf\u306e\u96c6\u7d04\u4f5c\u696d\u306fGraphQL\u30b5\u30fc\u30d0\u30fc\u304c\u62c5\u5f53\u3059\u308b\u3002\n\nGraphQL\u516c\u5f0f http://graphql.org/\n\n\n\u30ea\u30af\u30a8\u30b9\u30c8 \u2192 \u2192 \n(id 1\u756a\u306euser\u3061\u3087\u3046\u3060\u3044)\n{\n  user (id: \"1\") {\n    id\n    name\n    age\n  }\n}\n\n\u2192 \u2192 \u30ec\u30b9\u30dd\u30f3\u30b9\n{\n  \"user\" {\n    \"id\": \"1\",\n    \"name\": \"Tarou\",\n    \"age\": 20\n  }\n}\n\n\n\u3059\u3054\u3044\u30ea\u30af\u30a8\u30b9\u30c8 \u2192 \u2192 \n(id 1\u756a\u306euser\u306e\u53cb\u9054\u306e\u53cb\u9054\u306e\u53cb\u9054\u306e\u53cb\u9054\u306e\u2026)\n{\n  user(id:\"1\") {\n    id\n    name\n    age\n    address {\n      zip\n      street\n    }\n    hobby {\n      name\n    }\n    follow {\n      id\n      name\n      age\n      address {\n        zip\n        street\n      }\n      hobby {\n        name\n      }\n      follow {\n        id\n        name\n        hobby {\n          name\n        }\n        follow {\n          id\n          name\n          hobby {\n            name\n          }\n          follow {\n            id\n            name\n            hobby {\n              name\n            }\n          }\n        }\n      }\n    }\n  }\n}\n\n\n\u2192 \u2192 \u3059\u3054\u3044\u30ec\u30b9\u30dd\u30f3\u30b9\n\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u306f1\u56de\u306e\u30ea\u30af\u30a8\u30b9\u30c8\u3092\u9001\u308b\u3060\u3051\u3002\n{\n  \"data\": {\n    \"user\": {\n      \"id\": \"1\",\n      \"name\": \"Tarou\u25cf\",\n      \"age\": 20,\n      \"address\": {\n        \"zip\": \"111\",\n        \"street\": \"Shibuya\"\n      },\n      \"hobby\": [\n        {\n          \"name\": \"movie\"\n        },\n        {\n          \"name\": \"swimming\"\n        },\n        {\n          \"name\": \"hiking\"\n        }\n      ],\n      \"follow\": [\n        {\n          \"id\": \"2\",\n          \"name\": \"Hanako\u25a0\",\n          \"age\": 30,\n          \"address\": {\n            \"zip\": \"222\",\n            \"street\": \"Marunouchi\"\n          },\n          \"hobby\": [\n            {\n              \"name\": \"movie\"\n            },\n            {\n              \"name\": \"swimming\"\n            }\n          ],\n          \"follow\": [\n            {\n              \"id\": \"3\",\n              \"name\": \"John\u25b2\",\n              \"hobby\": null,\n              \"follow\": [\n                {\n                  \"id\": \"1\",\n                  \"name\": \"Tarou\u25cf\",\n                  \"hobby\": [\n                    {\n                      \"name\": \"movie\"\n                    },\n                    {\n                      \"name\": \"swimming\"\n                    },\n                    {\n                      \"name\": \"hiking\"\n                    }\n                  ],\n                  \"follow\": [\n                    {\n                      \"id\": \"2\",\n                      \"name\": \"Hanako\u25a0\",\n                      \"hobby\": [\n                        {\n                          \"name\": \"movie\"\n                        },\n                        {\n                          \"name\": \"swimming\"\n                        }\n                      ]\n                    },\n                    {\n                      \"id\": \"3\",\n                      \"name\": \"John\u25b2\",\n                      \"hobby\": null\n                    }\n                  ]\n                }\n              ]\n            }\n          ]\n        },\n        {\n          \"id\": \"3\",\n          \"name\": \"John\u25b2\",\n          \"age\": 40,\n          \"address\": {\n            \"zip\": \"333\",\n            \"street\": \"Sugamo\"\n          },\n          \"hobby\": null,\n          \"follow\": [\n            {\n              \"id\": \"1\",\n              \"name\": \"Tarou\u25cf\",\n              \"hobby\": [\n                {\n                  \"name\": \"movie\"\n                },\n                {\n                  \"name\": \"swimming\"\n                },\n                {\n                  \"name\": \"hiking\"\n                }\n              ],\n              \"follow\": [\n                {\n                  \"id\": \"2\",\n                  \"name\": \"Hanako\u25a0\",\n                  \"hobby\": [\n                    {\n                      \"name\": \"movie\"\n                    },\n                    {\n                      \"name\": \"swimming\"\n                    }\n                  ],\n                  \"follow\": [\n                    {\n                      \"id\": \"3\",\n                      \"name\": \"John\u25b2\",\n                      \"hobby\": null\n                    }\n                  ]\n                },\n                {\n                  \"id\": \"3\",\n                  \"name\": \"John\u25b2\",\n                  \"hobby\": null,\n                  \"follow\": [\n                    {\n                      \"id\": \"1\",\n                      \"name\": \"Tarou\u25cf\",\n                      \"hobby\": [\n                        {\n                          \"name\": \"movie\"\n                        },\n                        {\n                          \"name\": \"swimming\"\n                        },\n                        {\n                          \"name\": \"hiking\"\n                        }\n                      ]\n                    }\n                  ]\n                }\n              ]\n            }\n          ]\n        }\n      ]\n    }\n  }\n}\n\n\n\nApollo is what?\n\n\"Tools & products for GraphQL\"\n\n\u672c\u5bb6Facebook\u3082GraphQL\u7528\u306e\u30c4\u30fc\u30eb\u3092\u4f5c\u3063\u3066\u3044\u308b\u304c\u3001\u3053\u308c\u306f\u30b5\u30fc\u30c9\u30d1\u30fc\u30c6\u30a3\u30fc\u306e\u30e9\u30a4\u30d6\u30e9\u30ea\u3002\u30b5\u30fc\u30d0\u30fc\u30b5\u30a4\u30c9\u5411\u3051\u3068\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u5411\u3051\u4e21\u65b9\u3042\u308b\u3002\n\u672c\u5bb6\u306fReact\u3068\u9023\u643a\u3059\u308bRelay\u3068\u3044\u3046\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u30e9\u30a4\u30d6\u30e9\u30ea\u3092\u63d0\u4f9b\u3057\u3066\u3044\u308b\u304c\u3001\u3053\u3061\u3089\u306fAngular, iOS, Android\u5411\u3051\u304c\u3042\u308b\u3002\n\u50d5\u306fAngular\u6d3e\u306a\u306e\u3067\u73fe\u72b6\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u306fApollo\u3092\u4f7f\u3046\u3057\u304b\u306a\u3044\u3002\n\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u3067Apollo\u3092\u4f7f\u3046\u306e\u3067\u306a\u3093\u3068\u306a\u304f\u30b5\u30fc\u30d0\u30fc\u30b5\u30a4\u30c9\u3082Apollo\u3092\u4f7f\u3063\u3066\u3044\u308b\u3002\n\u66f4\u65b0\u901f\u3044\u3057\u6d3b\u767a(?)\u306a\u306e\u3067\u500b\u4eba\u7684\u306b\u306f\u597d\u304d\u3002\n\nApollo\u516c\u5f0f http://www.apollodata.com/\n\n\n\n\u5b9f\u306fApollo\u306f\u516c\u5f0f\u30b5\u30a4\u30c8\u3088\u308aMedium\u306eApollo\u30d6\u30ed\u30b0\u306e\u65b9\u304c\u60c5\u5831\u304c\u5145\u5b9f\u3057\u3066\u3044\u308b\u3002\n\u3067\u3082\u516c\u5f0f\u30b5\u30a4\u30c8\u3082\u3044\u3064\u306e\u9593\u306b\u304b\u66f4\u65b0\u3055\u308c\u3066\u3044\u308b\u306e\u3067\u305f\u307e\u306b\u76ee\u3092\u901a\u3059\u3068\u826f\u3044\u3002\n\u3042\u308b\u3068\u304d\u6025\u306b\u30ac\u30e9\u30c3\u3068\u5909\u308f\u3063\u3066\u3044\u305f\u308a\u3059\u308b\u306e\u3067\u697d\u3057\u3044\u3002\n\"apollo-server\"\u3060\u3063\u305f\u30e9\u30a4\u30d6\u30e9\u30ea\u304c\"graphql-server\"\u306b\u5909\u308f\u3063\u305f\u308a\u3057\u305f\u3002\n\u4eca\u671d\u3082\"apollo-client\"\u304c\u307e\u3042\u307e\u3042\u5909\u308f\u3063\u3066\u305f\u3002\n\n\n\nApollo\u306b\u306f\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u5411\u3051\u30e9\u30a4\u30d6\u30e9\u30ea\u3082\u3042\u308b\u3051\u3069\u3001\u4eca\u65e5\u306f\u30b5\u30fc\u30d0\u30fc\u30b5\u30a4\u30c9\u30e9\u30a4\u30d6\u30e9\u30ea\u306e\u8a71\u3092\u3057\u307e\u3059\u3002\n\nApollo\u30b5\u30fc\u30d0\u30fc\u30b5\u30a4\u30c9\u30e9\u30a4\u30d6\u30e9\u30ea\u306e\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\n\ngraphql-tools\n\n\u516c\u5f0f\u306eGraphQL.js\u3088\u308a\u3082GraphQL\u3092\u66f8\u304d\u3084\u3059\u304f\u8aad\u307f\u3084\u3059\u304f\u66f8\u304f\u3053\u3068\u3092\u76ee\u6307\u3057\u305f\u3082\u306e\u3001\u3060\u3068\u601d\u3046\u3002\n\u306a\u3093\u3060\u304b\u8272\u3005\u6a5f\u80fd\u3042\u308b\u3002\n\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u8aad\u3093\u3067\u2026\n\n\ngraphql-server-{express,hapi,koa}\n\nGraphQL\u304c\u52d5\u304f\u30b5\u30fc\u30d0\u30fc\u3092\u4f5c\u308b\u3002\n\n===\nGitHub\u30ea\u30dd\u30b8\u30c8\u30ea\u306e\u30bd\u30fc\u30b9\u30b3\u30fc\u30c9\u3092\u3056\u3063\u3068\u773a\u3081\u3066\u3082\u3089\u3046\u3068\u306a\u3093\u3068\u306a\u304f\u308f\u304b\u308b\u304b\u3068\u601d\u3044\u307e\u3059\u3002 \n\nGraphQL\u30b5\u30fc\u30d0\u30fc\u306f\u3053\u308c\u3060\u3051\u3002\u666e\u901a\u306b\u305f\u3060\u306e\u30b5\u30fc\u30d0\u30fc\u30b5\u30a4\u30c9\u30a2\u30d7\u30ea(hapi.js)\u3002\nTypeScript\u3067\u66f8\u304f\u3068\u578b\u306e\u6069\u6075\u3092\u53d7\u3051\u3089\u308c\u308b\u3002\n\nserver.ts\nconst server = new Hapi.Server();\n\nconst HOST = '0.0.0.0';\nconst PORT = process.env.PORT || 3000;\n\nserver.connection({\n  host: HOST,\n  port: PORT,\n});\n\nserver.register({\n  register: graphqlHapi,\n  options: {\n    path: '/graphql',\n    graphqlOptions: (request: Hapi.Request) => {\n      console.log('='.repeat(80));\n      const context: Context = Object.assign(request, { loaders: createLoaders() });\n      return {\n        schema: executableSchema,\n        context\n      }\n    },\n    route: {\n      cors: true\n    }\n  },\n});\n\nserver.register({\n  register: graphiqlHapi,\n  options: {\n    path: '/graphiql',\n    graphiqlOptions: {\n      endpointURL: '/graphql',\n    },\n  },\n});\n\nserver.start((err) => {\n  if (err) {\n    throw err;\n  }\n  console.log(`Server running at: ${server.info.uri}`);\n});\n\n\n\n\nTypeScript\u3059\u3054\u304f\u3044\u3044\u3067\u3059\u3002\u307f\u3093\u306a\u4f7f\u3044\u307e\u3057\u3087\u3046\u3002\n\n\nGraphQL\u30b5\u30fc\u30d0\u30fc\u3092\u66f8\u304f\n\nschema\u3092\u66f8\u304f\u3002\nschema\u306b\u5bfe\u5fdc\u3059\u308bTypeScript\u306einterface\u3092\u66f8\u304f\u3002\nresolver\u3092\u66f8\u304f\u3002\ndataLoader\u3092\u66f8\u304f\u3002\nconnector\u3092\u66f8\u304f\u3002(\u5404DB\u5411\u3051\u306efetch\u30b3\u30fc\u30c9)\n\n\n\nschema\u3092\u66f8\u304f\nGraphQL\u6d41\u306e\u578b\u4ed8\u304d\u8a00\u8a9e\u307f\u305f\u3044\u306a\u611f\u3058\u3002\n\nschema.ts\nexport const schema = [`\n\n# type definition of User \ntype User {\n  id: ID!\n  name: String!\n  age: Int\n  address: Address\n  # other users who current user follows.\n  follow: [User]\n  # current user's hobbies.\n  hobby: [Hobby]\n}\n\ntype Address {\n  zip: String\n  street: String\n}\n\ntype Hobby {\n  id: ID!\n  name: String!\n}\n\ntype RootQuery {\n  users: [User]\n  user(id: ID!): User\n}\n\nschema {\n  query: RootQuery\n}\n\n`];\n\n\n\n\nschema\u306b\u5bfe\u5fdc\u3059\u308bTypeScript\u306einterface\u3092\u66f8\u304f\n\nschema.ts\nexport interface User {\n  id: ID;\n  name: string;\n  age?: number;\n  address?: Address;\n  follow?: ID[];\n  hobby?: ID[];\n}\n\nexport interface Address {\n  zip?: string;\n  street?: string;\n}\n\nexport interface Hobby {\n  id: ID;\n  name: string;\n}\n\ntype ID = string;\n\n\n\n\n\u3010schema\u306e\u89e3\u8aac\u3011\n\u307e\u305aschema\u3068\u3044\u3046\u3082\u306e\u3092\u5b9a\u7fa9\u3059\u308b\u3002\nquery\u306e\u578b\u306fRootQuery\u3067\u3042\u308b\u3002\u5b9f\u969b\u306b\u306f\u4ed6\u306bmutation\u3068\u304b\u8272\u3005\u3042\u308b\u3002\nschema {\n  query: RootQuery\n}\n\n\u6b21\u306bRootQuery\u3068\u3044\u3046\u578b\u306e\u4e2d\u8eab\u3092\u5b9a\u7fa9\u3059\u308b\u3002\nusers\u306fUser\u578b\u306e\u914d\u5217\u3092\u8fd4\u3059\u30ea\u30be\u30eb\u30d0\u30fc\u3002\u914d\u5217\u306f[]\u3067\u8868\u3059\u3002\nuser\u306fid\u3092\u5f15\u6570\u306b\u53d6\u3063\u3066User\u578b\u3092\u8fd4\u3059\u30ea\u30be\u30eb\u30d0\u30fc\u3002!\u306f\u7701\u7565\u4e0d\u53ef\u306e\u610f\u5473\u3002\ntype RootQuery {\n  users: [User]\n  user(id: ID!): User\n}\n\n\u4eca\u5ea6\u306fUser\u3068\u3044\u3046\u578b\u3092\u5b9a\u7fa9\u3059\u308b\u3002\nAddress,Hobby\u306f\u3044\u305a\u308c\u3082\u72ec\u81ea\u306e\u578b\u3067\u3042\u308b\u3002\ntype User {\n  id: ID!\n  name: String!\n  age: Int\n  address: Address\n  follow: [User]\n  hobby: [Hobby]\n}\n\nAddress\u578b\u3092\u5b9a\u7fa9\u3059\u308b\u3002\ntype Address {\n  zip: String\n  street: String\n}\n\nHobby\u578b\u3082\u5b9a\u7fa9\u3059\u308b\u3002\ntype Hobby {\n  id: ID!\n  name: String!\n}\n\n\n\u3053\u306e\u3088\u3046\u306b\u30af\u30a8\u30ea\u306b\u5fc5\u8981\u3068\u306a\u308b\u578b\u3092\u5168\u3066\u5b9a\u7fa9\u3057\u3066\u3044\u304f\u3002\u305f\u3060\u3057\u6587\u5b57\u5217\u3068\u3057\u3066\u3002\nTypeScript\u306e\u578b\u306f\u5225\u9014\u66f8\u304b\u306a\u3051\u308c\u3070\u306a\u3089\u306a\u3044\u3002\n\u3053\u306e\u8fba\u306a\u3093\u3068\u304b\u306a\u3063\u305f\u3089\u307f\u3093\u306a\u5e78\u305b\u306b\u306a\u308c\u305d\u3046\u3002\n===\nschema\u304c\u3042\u308b\u3068\u4f55\u304c\u5b09\u3057\u3044\u3063\u3066\u3001GraphiQL\u3067\u5165\u529b\u88dc\u5b8c\u304c\u5229\u304f\u3002\nGraphiQL\u30b5\u30f3\u30d7\u30eb\n\n\nresolver\u3092\u66f8\u304f\nschema\u3067\u5b9a\u7fa9\u3057\u305f\u901a\u308a\u306e\u7d50\u679c\u304c\u8fd4\u308b\u3088\u3046\u306a\u95a2\u6570\u3092\u66f8\u304f\u3002\nresolver\u306e\u57fa\u672c\u5f62\nfieldName: (root, args, context, info) => result\ncontext\u306frequest\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3060\u3068\u601d\u3063\u3066\u304a\u3051\u3070OK\u3002\n\nresolvers.ts\nexport const resolverMap = {\n\n  RootQuery: {\n    users(root: any, args: {}): Promise<User[]> {\n      return getUserIds().then(ids => userLoader.loadMany(ids));\n    },\n\n    user(root: any, args: { id: string }): Promise<User[]> {\n      return userLoader.load(args.id);\n    },\n  },\n\n  User: {\n    follow(user: User, args: {}): Promise<User[]> | null {\n      return user.follow ? userLoader.loadMany(user.follow) : null;\n    },\n\n    hobby(user: User, args: {}): Promise<Hobby[]> | null {\n      return user.hobby ? hobbyLoader.loadMany(user.hobby) : null;\n    }\n  }\n\n};\n\n\n\n\u3010schema\u3068resolver\u306e\u5bfe\u5fdc\u306e\u89e3\u8aac\u3011(1/2)\n\u3053\u3046\u3044\u3046schema\u304c\u3042\u3063\u305f\u3089\u2026\ntype RootQuery {\n  users: [User]\n  user(id: ID!): User\n}\n\n\u3053\u3046\u3044\u3046resolver\u3092\u66f8\u304f\u3002\n  RootQuery: {\n    users(root: any, args: {}): Promise<User[]> {\n      return getUserIds().then(ids => userLoader.loadMany(ids));\n    },\n\n    user(root: any, args: { id: string }): Promise<User[]> {\n      return userLoader.load(args.id);\n    },\n  },\n\nRootQuery\u3068users,user\u306e\u968e\u5c64\u69cb\u9020\u304c\u4e00\u81f4\u3057\u3066\u3044\u308b\uff01\n\u95a2\u6570\u306e\u7b2c\u4e00\u5f15\u6570root\u306f\u89aa\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u6307\u3059\u3002\u3053\u306e\u5834\u5408\u306froot\u306a\u306e\u3067undefined\u3068\u306a\u308b\u3002\n\n\u3010schema\u3068resolver\u306e\u5bfe\u5fdc\u306e\u89e3\u8aac\u3011(2/2)\n\u3053\u3046\u3044\u3046schema\u304c\u3042\u3063\u305f\u3089\u2026\ntype User {\n  (\u7701\u7565)\n  follow: [User]\n  hobby: [Hobby]\n}\n\n\u3053\u3046\u3044\u3046resolver\u3092\u66f8\u304f\u3002\n  User: {\n    follow(user: User, args: {}): Promise<User[]> | null {\n      return user.follow ? userLoader.loadMany(user.follow) : null;\n    },\n\n    hobby(user: User, args: {}): Promise<Hobby[]> | null {\n      return user.hobby ? hobbyLoader.loadMany(user.hobby) : null;\n    }\n  }\n\nUser\u3068follow,hobby\u306e\u968e\u5c64\u69cb\u9020\u304c\u4e00\u81f4\u3057\u3066\u3044\u308b\uff01\n\u95a2\u6570\u306e\u7b2c\u4e00\u5f15\u6570user\u306f\u89aa\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u6307\u3059\u3002\u3053\u306e\u5834\u5408\u306fUser\u578b\u306e\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3068\u306a\u308b\u3002\n\n\n\u5b9f\u969b\u306b\u30af\u30a8\u30ea\u3092\u30ea\u30af\u30a8\u30b9\u30c8\u3068\u304d\u306eGraphQL\u30b5\u30fc\u30d0\u30fc\u306e\u30ed\u30b0\u3092\u898b\u3066\u307f\u308b\u3002\n(DataLoader\u306b\u3088\u308bBatching, Caching\u7121\u3057)\n\n\u30ea\u30af\u30a8\u30b9\u30c8 \u2192 \u2192\n{\n  user(id:\"1\") {\n    ...userFragment\n    follow {\n      ...userFragment\n      follow {\n        ...userFragment\n        follow {\n          ...userFragment\n          follow {\n            ...userFragment\n          }\n        }\n      }\n    }\n  }\n}\n\nfragment userFragment on User {\n  id\n  name\n  address {\n    zip\n    street\n  }\n  hobby {\n    name\n  }  \n}\n\n\u3053\u308c\u306ffragment\u3068\u3044\u3046\u6a5f\u80fd\u3092\u4f7f\u3063\u305f\u30af\u30a8\u30ea\u306e\u66f8\u304d\u65b9\u3002\n\nGraphQL\u30b5\u30fc\u30d0\u30fc\u306e\u30ed\u30b0\nuserLoader fetch: { id: '1', name: 'Tarou\u25cf' }\nhobbyLoader fetch: { id: '1', name: 'movie' }\nhobbyLoader fetch: { id: '2', name: 'swimming' }\nhobbyLoader fetch: { id: '3', name: 'hiking' }\nuserLoader fetch: { id: '2', name: 'Hanako\u25a0' }\nuserLoader fetch: { id: '3', name: 'John\u25b2' }\nhobbyLoader fetch: { id: '1', name: 'movie' }\nhobbyLoader fetch: { id: '2', name: 'swimming' }\nuserLoader fetch: { id: '3', name: 'John\u25b2' }\nuserLoader fetch: { id: '1', name: 'Tarou\u25cf' }\nuserLoader fetch: { id: '1', name: 'Tarou\u25cf' }\nuserLoader fetch: { id: '2', name: 'Hanako\u25a0' }\nuserLoader fetch: { id: '3', name: 'John\u25b2' }\nhobbyLoader fetch: { id: '1', name: 'movie' }\nhobbyLoader fetch: { id: '1', name: 'movie' }\nhobbyLoader fetch: { id: '1', name: 'movie' }\nhobbyLoader fetch: { id: '2', name: 'swimming' }\nhobbyLoader fetch: { id: '2', name: 'swimming' }\nhobbyLoader fetch: { id: '2', name: 'swimming' }\nhobbyLoader fetch: { id: '3', name: 'hiking' }\nhobbyLoader fetch: { id: '3', name: 'hiking' }\nuserLoader fetch: { id: '2', name: 'Hanako\u25a0' }\nuserLoader fetch: { id: '3', name: 'John\u25b2' }\nuserLoader fetch: { id: '3', name: 'John\u25b2' }\nuserLoader fetch: { id: '1', name: 'Tarou\u25cf' }\nhobbyLoader fetch: { id: '1', name: 'movie' }\nhobbyLoader fetch: { id: '1', name: 'movie' }\nhobbyLoader fetch: { id: '2', name: 'swimming' }\nhobbyLoader fetch: { id: '2', name: 'swimming' }\nhobbyLoader fetch: { id: '3', name: 'hiking' }\n\n\n\n\u3053\u308c\u306f\u2026\uff01\uff01\uff01\n\n\nwhere DataLoader comes into play\n\n\ndataLoader\u3092\u66f8\u304f\nnew DataLoader(callback) \u306b\u767b\u9332\u3059\u308b\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u306e\u57fa\u672c\u5f62\n(keys: T[]) => Promise<R[]>\n\"(\u4f8b\u3048\u3070) string\u306e\u914d\u5217\u3092\u53d7\u3051\u53d6\u3063\u3066\u3001User\u306e\u914d\u5217\u3092Promise\u3067\u8fd4\u3059\u95a2\u6570\"\n\u8a73\u7d30\u306f\u3053\u308c\u8aad\u3093\u3067 \u2192 facebook/dataloader\n\nloaders.ts\nexport function createLoaders(cache: boolean = true, batch: boolean = true): Loaders {\n  const options = { cache, batch };\n  return {\n    userLoader: new DataLoader(userLoaderCallback, options),\n    hobbyLoader: new DataLoader(hobbyLoaderCallback, options),\n  }\n}\n\nfunction userLoaderCallback(keys: string[]): Promise<User[]> {\n  return getUsersConnector(keys);\n}\n\nfunction hobbyLoaderCallback(keys: string[]): Promise<Hobby[]> {\n  return getHobbiesConnector(keys);\n}\n\n\n\nfirebase-connectors.ts\nexport async function getUserIdsConnector(): Promise<string[]> {\n  const snapshot = await firebase.database().ref('users').once('value') as Snapshot;\n  const users: User[] = lodash.toArray<User>(snapshot.val()).filter(obj => !!obj);\n  users.forEach(user => assert(lodash.isObject(user) && 'id' in user));\n  const ids: string[] = users.map(user => user.id);\n  return ids;\n}\n\nexport async function getUsersConnector(keys: string[]): Promise<User[]> {\n  const snapshotPromises = keys.map(key => firebase.database().ref('users/' + key).once('value') as Promise<Snapshot>);\n  const snapshots = await Promise.all(snapshotPromises);\n  const users: User[] = snapshots.map(snapshot => snapshot.val());\n  users.forEach(user => assert(lodash.isObject(user) && 'id' in user));\n  console.log('userLoader fetch:', ...users.map(user => ({ id: user.id, name: user.name })));\n  return users;\n}\n\nexport async function getHobbiesConnector(keys: string[]): Promise<Hobby[]> {\n  const snapshotPromises = keys.map(key => firebase.database().ref('hobby/' + key).once('value') as Promise<Snapshot>);\n  const snapshots = await Promise.all(snapshotPromises);\n  const hobbies: Hobby[] = snapshots.map(snapshot => snapshot.val());\n  hobbies.forEach(hobby => assert(lodash.isObject(hobby) && 'id' in hobby));\n  console.log('hobbyLoader fetch:', ...hobbies.map(hobby => ({ id: hobby.id, name: hobby.name })));\n  return hobbies;\n}\n\n\n\nDataLoader\u3092\u4f7f\u3046\u3068\u3055\u3063\u304d\u306e\u30a2\u30ec\u304c\u3053\u3046\uff01\nuserLoader fetch: { id: '1', name: 'Tarou\u25cf' }\nhobbyLoader fetch: { id: '1', name: 'movie' } { id: '2', name: 'swimming' } { id: '3', name: 'hiking' }\nuserLoader fetch: { id: '2', name: 'Hanako\u25a0' } { id: '3', name: 'John\u25b2' }\n\n30\u56de\u306efetch\u304c6\u56de\u306b\uff01\n\u901a\u4fe1\u30b3\u30b9\u30c8\u306e\u5927\u5e45\u524a\u6e1b\uff01\n\u3061\u306a\u307f\u306b\u3053\u308c\u306f\u300c\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u2190\u2192GraphQL\u30b5\u30fc\u30d0\u30fc\u300d\u306e\u30ed\u30b0\u3067\u306f\u306a\u304f\u3001\u300cGraphQL\u30b5\u30fc\u30d0\u30fc\u2190\u2192DB\u30b5\u30fc\u30d0\u30fc\u300d\u306e\u30ed\u30b0\u3067\u3059\u3002\n\n\nDataLoader\u3092\u4f75\u7528\u3059\u308b\u3053\u3068\u3067GraphQL\u306f\u5a01\u529b\u3092\u767a\u63ee\u3059\u308b\n\n\nGraphQL\u304b\u306a\u308a\u3044\u3044\u3067\u3059\u3002\u307f\u3093\u306a\u4f7f\u3044\u307e\u3057\u3087\u3046\u3002\n\n\u4eca\u56de\u306e\u30bd\u30fc\u30b9\u30b3\u30fc\u30c9\u306f\u5168\u3066\u4e0b\u8a18\u306e\u30ea\u30dd\u30b8\u30c8\u30ea\u304b\u3089\u306e\u5f15\u7528\u3067\u3059\u3002\novrmrw/graphql-server-dataloader\n\n\nThanks!\nWhen\n\n2016/11/04\n\nAt\n\n[\\#10 \u5e02\u30f6\u8c37Geek\u2605Night\u300c\u578b\u306e\u3042\u308b\u30d5\u30ed\u30f3\u30c8\u30a8\u30f3\u30c9\u306e\u4e16\u754c\u301c\u30d5\u30ed\u30f3\u30c8\u30a8\u30f3\u30c9\u30fb\u30d5\u30ed\u30f3\u30c6\u30a3\u30a2\u301c\u300d](http://ichigayageek.connpass.com/event/43149/)\n\n---\n\n# \u4eca\u56de\u306eGitHub\u30ea\u30dd\u30b8\u30c8\u30ea\n\n[ovrmrw/graphql-server-dataloader](https://github.com/ovrmrw/graphql-server-dataloader)\n\n\u30ea\u30dd\u30b8\u30c8\u30ea\u306b\u30c7\u30e2\u30b5\u30a4\u30c8\u3078\u306e\u30ea\u30f3\u30af\u304c\u3042\u308a\u307e\u3059\u3002\n\n===\n\n\u8a71\u3059\u5185\u5bb9\n\n- GraphQL\u304c\u578b\u3092\u6301\u3063\u3066\u3044\u308b\u3053\u3068\u3067\u4f55\u304c\u5b09\u3057\u3044\u304b\u3002\n- DataLoader\u306e\u5a01\u529b\u3002\n\n---\n\n## \u81ea\u5df1\u7d39\u4ecb\n\n\u3061\u304d\u3055\u3093\n(Tomohiro Noguchi)\n\ntwitter: [@ovrmrw](https://twitter.com/ovrmrw)\n\n\u305f\u3060\u306eSIer\u3002\n\nAngular Japan User Group (ng-japan)\u30b9\u30bf\u30c3\u30d5\u3002\n\n![3a2512bb-aa72-4515-af42-1f1721252f39.jpg](https://qiita-image-store.s3.amazonaws.com/0/74793/c753b39c-1581-ea1d-87d1-181f37bda60d.jpeg)\n\n---\n\n### Angular\u3068\u3066\u3082\u7c21\u5358\u3067\u3059\u3002\u307f\u3093\u306a\u4f7f\u3044\u307e\u3057\u3087\u3046\u3002\n\n---\n\n# GraphQL is what?\n\n## \"A query language for your API\"\n\n- Facebook\u304c\u4f5c\u3063\u305f\u30e9\u30a4\u30d6\u30e9\u30ea\u3002\n- Netflix\u306eFalcor\u306b\u4f3c\u3066\u3044\u308b\u3051\u3069\u3082\u3063\u3068\u9ad8\u6a5f\u80fd\u3002\n- Falcor\u306f\u30e1\u30f3\u30c6\u3055\u308c\u3066\u3044\u308b\u304b\u602a\u3057\u3044\u304c\u3053\u3061\u3089\u306f\u6d3b\u767a\u3002\n- \u8981\u6c42\u3057\u305f\u5f62\u306eJSON\u3092\u8fd4\u3057\u3066\u304f\u308c\u308b\u3002\n- \u30af\u30e9\u30a4\u30a2\u30f3\u30c8(\u30b9\u30de\u30db\u7b49)\u306f**\u30ea\u30af\u30a8\u30b9\u30c8\u30921\u56de\u9001\u308b\u3060\u3051**\u3067\u5b8c\u6210\u7248\u306eJSON\u3092\u53d7\u3051\u53d6\u308c\u308b\u3002\n- \u30c7\u30fc\u30bf\u306e\u96c6\u7d04\u4f5c\u696d\u306fGraphQL\u30b5\u30fc\u30d0\u30fc\u304c\u62c5\u5f53\u3059\u308b\u3002\n\n[GraphQL\u516c\u5f0f http://graphql.org/](http://graphql.org/)\n\n![12972006.png](https://qiita-image-store.s3.amazonaws.com/0/74793/e09bfec4-75f9-d349-abc1-453d476d1d13.png)\n\n---\n\n\u30ea\u30af\u30a8\u30b9\u30c8 \u2192 \u2192 \n(id 1\u756a\u306euser\u3061\u3087\u3046\u3060\u3044)\n\n```txt\n{\n  user (id: \"1\") {\n    id\n    name\n    age\n  }\n}\n```\n\n\u2192 \u2192 \u30ec\u30b9\u30dd\u30f3\u30b9\n\n```json\n{\n  \"user\" {\n    \"id\": \"1\",\n    \"name\": \"Tarou\",\n    \"age\": 20\n  }\n}\n```\n\n---\n\n\u3059\u3054\u3044\u30ea\u30af\u30a8\u30b9\u30c8 \u2192 \u2192 \n(id 1\u756a\u306euser\u306e\u53cb\u9054\u306e\u53cb\u9054\u306e\u53cb\u9054\u306e\u53cb\u9054\u306e\u2026)\n\n```txt\n{\n  user(id:\"1\") {\n    id\n    name\n    age\n    address {\n      zip\n      street\n    }\n    hobby {\n      name\n    }\n    follow {\n      id\n      name\n      age\n      address {\n        zip\n        street\n      }\n      hobby {\n        name\n      }\n      follow {\n    \tid\n        name\n        hobby {\n          name\n        }\n        follow {\n          id\n          name\n          hobby {\n            name\n          }\n          follow {\n            id\n            name\n            hobby {\n              name\n            }\n          }\n        }\n      }\n    }\n  }\n}\n```\n\n---\n\n\u2192 \u2192 \u3059\u3054\u3044\u30ec\u30b9\u30dd\u30f3\u30b9\n\n**\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u306f1\u56de\u306e\u30ea\u30af\u30a8\u30b9\u30c8\u3092\u9001\u308b\u3060\u3051\u3002**\n\n```json\n{\n  \"data\": {\n    \"user\": {\n      \"id\": \"1\",\n      \"name\": \"Tarou\u25cf\",\n      \"age\": 20,\n      \"address\": {\n        \"zip\": \"111\",\n        \"street\": \"Shibuya\"\n      },\n      \"hobby\": [\n        {\n          \"name\": \"movie\"\n        },\n        {\n          \"name\": \"swimming\"\n        },\n        {\n          \"name\": \"hiking\"\n        }\n      ],\n      \"follow\": [\n        {\n          \"id\": \"2\",\n          \"name\": \"Hanako\u25a0\",\n          \"age\": 30,\n          \"address\": {\n            \"zip\": \"222\",\n            \"street\": \"Marunouchi\"\n          },\n          \"hobby\": [\n            {\n              \"name\": \"movie\"\n            },\n            {\n              \"name\": \"swimming\"\n            }\n          ],\n          \"follow\": [\n            {\n              \"id\": \"3\",\n              \"name\": \"John\u25b2\",\n              \"hobby\": null,\n              \"follow\": [\n                {\n                  \"id\": \"1\",\n                  \"name\": \"Tarou\u25cf\",\n                  \"hobby\": [\n                    {\n                      \"name\": \"movie\"\n                    },\n                    {\n                      \"name\": \"swimming\"\n                    },\n                    {\n                      \"name\": \"hiking\"\n                    }\n                  ],\n                  \"follow\": [\n                    {\n                      \"id\": \"2\",\n                      \"name\": \"Hanako\u25a0\",\n                      \"hobby\": [\n                        {\n                          \"name\": \"movie\"\n                        },\n                        {\n                          \"name\": \"swimming\"\n                        }\n                      ]\n                    },\n                    {\n                      \"id\": \"3\",\n                      \"name\": \"John\u25b2\",\n                      \"hobby\": null\n                    }\n                  ]\n                }\n              ]\n            }\n          ]\n        },\n        {\n          \"id\": \"3\",\n          \"name\": \"John\u25b2\",\n          \"age\": 40,\n          \"address\": {\n            \"zip\": \"333\",\n            \"street\": \"Sugamo\"\n          },\n          \"hobby\": null,\n          \"follow\": [\n            {\n              \"id\": \"1\",\n              \"name\": \"Tarou\u25cf\",\n              \"hobby\": [\n                {\n                  \"name\": \"movie\"\n                },\n                {\n                  \"name\": \"swimming\"\n                },\n                {\n                  \"name\": \"hiking\"\n                }\n              ],\n              \"follow\": [\n                {\n                  \"id\": \"2\",\n                  \"name\": \"Hanako\u25a0\",\n                  \"hobby\": [\n                    {\n                      \"name\": \"movie\"\n                    },\n                    {\n                      \"name\": \"swimming\"\n                    }\n                  ],\n                  \"follow\": [\n                    {\n                      \"id\": \"3\",\n                      \"name\": \"John\u25b2\",\n                      \"hobby\": null\n                    }\n                  ]\n                },\n                {\n                  \"id\": \"3\",\n                  \"name\": \"John\u25b2\",\n                  \"hobby\": null,\n                  \"follow\": [\n                    {\n                      \"id\": \"1\",\n                      \"name\": \"Tarou\u25cf\",\n                      \"hobby\": [\n                        {\n                          \"name\": \"movie\"\n                        },\n                        {\n                          \"name\": \"swimming\"\n                        },\n                        {\n                          \"name\": \"hiking\"\n                        }\n                      ]\n                    }\n                  ]\n                }\n              ]\n            }\n          ]\n        }\n      ]\n    }\n  }\n}\n```\n\n---\n\n# Apollo is what?\n\n## \"Tools & products for GraphQL\"\n\n- \u672c\u5bb6Facebook\u3082GraphQL\u7528\u306e\u30c4\u30fc\u30eb\u3092\u4f5c\u3063\u3066\u3044\u308b\u304c\u3001\u3053\u308c\u306f\u30b5\u30fc\u30c9\u30d1\u30fc\u30c6\u30a3\u30fc\u306e\u30e9\u30a4\u30d6\u30e9\u30ea\u3002\u30b5\u30fc\u30d0\u30fc\u30b5\u30a4\u30c9\u5411\u3051\u3068\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u5411\u3051\u4e21\u65b9\u3042\u308b\u3002\n- \u672c\u5bb6\u306fReact\u3068\u9023\u643a\u3059\u308bRelay\u3068\u3044\u3046\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u30e9\u30a4\u30d6\u30e9\u30ea\u3092\u63d0\u4f9b\u3057\u3066\u3044\u308b\u304c\u3001\u3053\u3061\u3089\u306fAngular, iOS, Android\u5411\u3051\u304c\u3042\u308b\u3002\n- \u50d5\u306fAngular\u6d3e\u306a\u306e\u3067\u73fe\u72b6\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u306fApollo\u3092\u4f7f\u3046\u3057\u304b\u306a\u3044\u3002\n- \u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u3067Apollo\u3092\u4f7f\u3046\u306e\u3067\u306a\u3093\u3068\u306a\u304f\u30b5\u30fc\u30d0\u30fc\u30b5\u30a4\u30c9\u3082Apollo\u3092\u4f7f\u3063\u3066\u3044\u308b\u3002\n- \u66f4\u65b0\u901f\u3044\u3057\u6d3b\u767a(?)\u306a\u306e\u3067\u500b\u4eba\u7684\u306b\u306f\u597d\u304d\u3002\n\n[Apollo\u516c\u5f0f http://www.apollodata.com/](http://www.apollodata.com/)\n\n![apollo-logo.png](https://qiita-image-store.s3.amazonaws.com/0/74793/31c9c15b-1403-423c-10d7-041a743e2032.png)\n\n---\n\n- \u5b9f\u306fApollo\u306f\u516c\u5f0f\u30b5\u30a4\u30c8\u3088\u308a[Medium\u306eApollo\u30d6\u30ed\u30b0](https://dev-blog.apollodata.com/)\u306e\u65b9\u304c\u60c5\u5831\u304c\u5145\u5b9f\u3057\u3066\u3044\u308b\u3002\n\n- \u3067\u3082\u516c\u5f0f\u30b5\u30a4\u30c8\u3082\u3044\u3064\u306e\u9593\u306b\u304b\u66f4\u65b0\u3055\u308c\u3066\u3044\u308b\u306e\u3067\u305f\u307e\u306b\u76ee\u3092\u901a\u3059\u3068\u826f\u3044\u3002\n\n- \u3042\u308b\u3068\u304d\u6025\u306b\u30ac\u30e9\u30c3\u3068\u5909\u308f\u3063\u3066\u3044\u305f\u308a\u3059\u308b\u306e\u3067\u697d\u3057\u3044\u3002\n\n- \"apollo-server\"\u3060\u3063\u305f\u30e9\u30a4\u30d6\u30e9\u30ea\u304c\"graphql-server\"\u306b\u5909\u308f\u3063\u305f\u308a\u3057\u305f\u3002\n\n- \u4eca\u671d\u3082\"apollo-client\"\u304c\u307e\u3042\u307e\u3042\u5909\u308f\u3063\u3066\u305f\u3002\n\n---\n\n### Apollo\u306b\u306f\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u5411\u3051\u30e9\u30a4\u30d6\u30e9\u30ea\u3082\u3042\u308b\u3051\u3069\u3001\u4eca\u65e5\u306f\u30b5\u30fc\u30d0\u30fc\u30b5\u30a4\u30c9\u30e9\u30a4\u30d6\u30e9\u30ea\u306e\u8a71\u3092\u3057\u307e\u3059\u3002\n\n---\n\n[Apollo\u30b5\u30fc\u30d0\u30fc\u30b5\u30a4\u30c9\u30e9\u30a4\u30d6\u30e9\u30ea\u306e\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8](http://dev.apollodata.com/tools/)\n\n## graphql-tools\n\n- \u516c\u5f0f\u306eGraphQL.js\u3088\u308a\u3082GraphQL\u3092\u66f8\u304d\u3084\u3059\u304f\u8aad\u307f\u3084\u3059\u304f\u66f8\u304f\u3053\u3068\u3092\u76ee\u6307\u3057\u305f\u3082\u306e\u3001\u3060\u3068\u601d\u3046\u3002\n- \u306a\u3093\u3060\u304b\u8272\u3005\u6a5f\u80fd\u3042\u308b\u3002\n- \u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u8aad\u3093\u3067\u2026\n\n## graphql-server-{express,hapi,koa}\n\n- GraphQL\u304c\u52d5\u304f\u30b5\u30fc\u30d0\u30fc\u3092\u4f5c\u308b\u3002\n\n===\n\nGitHub\u30ea\u30dd\u30b8\u30c8\u30ea\u306e\u30bd\u30fc\u30b9\u30b3\u30fc\u30c9\u3092\u3056\u3063\u3068\u773a\u3081\u3066\u3082\u3089\u3046\u3068\u306a\u3093\u3068\u306a\u304f\u308f\u304b\u308b\u304b\u3068\u601d\u3044\u307e\u3059\u3002 \n \n---\n\nGraphQL\u30b5\u30fc\u30d0\u30fc\u306f\u3053\u308c\u3060\u3051\u3002\u666e\u901a\u306b\u305f\u3060\u306e\u30b5\u30fc\u30d0\u30fc\u30b5\u30a4\u30c9\u30a2\u30d7\u30ea(hapi.js)\u3002\nTypeScript\u3067\u66f8\u304f\u3068\u578b\u306e\u6069\u6075\u3092\u53d7\u3051\u3089\u308c\u308b\u3002\n\n```ts:server.ts\nconst server = new Hapi.Server();\n\nconst HOST = '0.0.0.0';\nconst PORT = process.env.PORT || 3000;\n\nserver.connection({\n  host: HOST,\n  port: PORT,\n});\n\nserver.register({\n  register: graphqlHapi,\n  options: {\n    path: '/graphql',\n    graphqlOptions: (request: Hapi.Request) => {\n      console.log('='.repeat(80));\n      const context: Context = Object.assign(request, { loaders: createLoaders() });\n      return {\n        schema: executableSchema,\n        context\n      }\n    },\n    route: {\n      cors: true\n    }\n  },\n});\n\nserver.register({\n  register: graphiqlHapi,\n  options: {\n    path: '/graphiql',\n    graphiqlOptions: {\n      endpointURL: '/graphql',\n    },\n  },\n});\n\nserver.start((err) => {\n  if (err) {\n    throw err;\n  }\n  console.log(`Server running at: ${server.info.uri}`);\n});\n```\n\n---\n\n### TypeScript\u3059\u3054\u304f\u3044\u3044\u3067\u3059\u3002\u307f\u3093\u306a\u4f7f\u3044\u307e\u3057\u3087\u3046\u3002\n\n---\n\n# GraphQL\u30b5\u30fc\u30d0\u30fc\u3092\u66f8\u304f\n\n- schema\u3092\u66f8\u304f\u3002\n- schema\u306b\u5bfe\u5fdc\u3059\u308bTypeScript\u306einterface\u3092\u66f8\u304f\u3002\n- resolver\u3092\u66f8\u304f\u3002\n- dataLoader\u3092\u66f8\u304f\u3002\n- connector\u3092\u66f8\u304f\u3002(\u5404DB\u5411\u3051\u306efetch\u30b3\u30fc\u30c9)\n\n---\n\n## schema\u3092\u66f8\u304f\nGraphQL\u6d41\u306e\u578b\u4ed8\u304d\u8a00\u8a9e\u307f\u305f\u3044\u306a\u611f\u3058\u3002\n\n```ts:schema.ts\nexport const schema = [`\n\n# type definition of User \ntype User {\n  id: ID!\n  name: String!\n  age: Int\n  address: Address\n  # other users who current user follows.\n  follow: [User]\n  # current user's hobbies.\n  hobby: [Hobby]\n}\n\ntype Address {\n  zip: String\n  street: String\n}\n\ntype Hobby {\n  id: ID!\n  name: String!\n}\n\ntype RootQuery {\n  users: [User]\n  user(id: ID!): User\n}\n\nschema {\n  query: RootQuery\n}\n\n`];\n```\n\n---\n\n## schema\u306b\u5bfe\u5fdc\u3059\u308bTypeScript\u306einterface\u3092\u66f8\u304f\n\n```ts:schema.ts\nexport interface User {\n  id: ID;\n  name: string;\n  age?: number;\n  address?: Address;\n  follow?: ID[];\n  hobby?: ID[];\n}\n\nexport interface Address {\n  zip?: string;\n  street?: string;\n}\n\nexport interface Hobby {\n  id: ID;\n  name: string;\n}\n\ntype ID = string;\n```\n\n---\n\n## \u3010schema\u306e\u89e3\u8aac\u3011\n\n\u307e\u305aschema\u3068\u3044\u3046\u3082\u306e\u3092\u5b9a\u7fa9\u3059\u308b\u3002\nquery\u306e\u578b\u306f`RootQuery`\u3067\u3042\u308b\u3002\u5b9f\u969b\u306b\u306f\u4ed6\u306bmutation\u3068\u304b\u8272\u3005\u3042\u308b\u3002\n\n```txt\nschema {\n  query: RootQuery\n}\n```\n\n\u6b21\u306b`RootQuery`\u3068\u3044\u3046\u578b\u306e\u4e2d\u8eab\u3092\u5b9a\u7fa9\u3059\u308b\u3002\nusers\u306f`User`\u578b\u306e\u914d\u5217\u3092\u8fd4\u3059\u30ea\u30be\u30eb\u30d0\u30fc\u3002\u914d\u5217\u306f`[]`\u3067\u8868\u3059\u3002\nuser\u306fid\u3092\u5f15\u6570\u306b\u53d6\u3063\u3066`User`\u578b\u3092\u8fd4\u3059\u30ea\u30be\u30eb\u30d0\u30fc\u3002`!`\u306f\u7701\u7565\u4e0d\u53ef\u306e\u610f\u5473\u3002\n\n```txt\ntype RootQuery {\n  users: [User]\n  user(id: ID!): User\n}\n```\n\n\u4eca\u5ea6\u306f`User`\u3068\u3044\u3046\u578b\u3092\u5b9a\u7fa9\u3059\u308b\u3002\n`Address`,`Hobby`\u306f\u3044\u305a\u308c\u3082\u72ec\u81ea\u306e\u578b\u3067\u3042\u308b\u3002\n\n```txt\ntype User {\n  id: ID!\n  name: String!\n  age: Int\n  address: Address\n  follow: [User]\n  hobby: [Hobby]\n}\n```\n\n`Address`\u578b\u3092\u5b9a\u7fa9\u3059\u308b\u3002\n\n```txt\ntype Address {\n  zip: String\n  street: String\n}\n```\n\n`Hobby`\u578b\u3082\u5b9a\u7fa9\u3059\u308b\u3002\n\n```txt\ntype Hobby {\n  id: ID!\n  name: String!\n}\n```\n\n---\n\n\u3053\u306e\u3088\u3046\u306b\u30af\u30a8\u30ea\u306b\u5fc5\u8981\u3068\u306a\u308b\u578b\u3092\u5168\u3066\u5b9a\u7fa9\u3057\u3066\u3044\u304f\u3002\u305f\u3060\u3057\u6587\u5b57\u5217\u3068\u3057\u3066\u3002\n\nTypeScript\u306e\u578b\u306f\u5225\u9014\u66f8\u304b\u306a\u3051\u308c\u3070\u306a\u3089\u306a\u3044\u3002\n\n\u3053\u306e\u8fba\u306a\u3093\u3068\u304b\u306a\u3063\u305f\u3089\u307f\u3093\u306a\u5e78\u305b\u306b\u306a\u308c\u305d\u3046\u3002\n\n===\n\nschema\u304c\u3042\u308b\u3068\u4f55\u304c\u5b09\u3057\u3044\u3063\u3066\u3001GraphiQL\u3067\u5165\u529b\u88dc\u5b8c\u304c\u5229\u304f\u3002\n\n[GraphiQL\u30b5\u30f3\u30d7\u30eb](https://graphql-server-dataloader.azurewebsites.net/graphiql)\n\n---\n\n## resolver\u3092\u66f8\u304f\n\nschema\u3067\u5b9a\u7fa9\u3057\u305f\u901a\u308a\u306e\u7d50\u679c\u304c\u8fd4\u308b\u3088\u3046\u306a\u95a2\u6570\u3092\u66f8\u304f\u3002\n\nresolver\u306e\u57fa\u672c\u5f62\n`fieldName: (root, args, context, info) => result`\n\n`context`\u306frequest\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3060\u3068\u601d\u3063\u3066\u304a\u3051\u3070OK\u3002\n\n```ts:resolvers.ts\nexport const resolverMap = {\n\n  RootQuery: {\n    users(root: any, args: {}): Promise<User[]> {\n      return getUserIds().then(ids => userLoader.loadMany(ids));\n    },\n\n    user(root: any, args: { id: string }): Promise<User[]> {\n      return userLoader.load(args.id);\n    },\n  },\n\n  User: {\n    follow(user: User, args: {}): Promise<User[]> | null {\n      return user.follow ? userLoader.loadMany(user.follow) : null;\n    },\n\n    hobby(user: User, args: {}): Promise<Hobby[]> | null {\n      return user.hobby ? hobbyLoader.loadMany(user.hobby) : null;\n    }\n  }\n\n};\n```\n\n---\n\n\u3010schema\u3068resolver\u306e\u5bfe\u5fdc\u306e\u89e3\u8aac\u3011(1/2)\n\n\u3053\u3046\u3044\u3046schema\u304c\u3042\u3063\u305f\u3089\u2026\n\n```\ntype RootQuery {\n  users: [User]\n  user(id: ID!): User\n}\n```\n\n\u3053\u3046\u3044\u3046resolver\u3092\u66f8\u304f\u3002\n\n```ts\n  RootQuery: {\n    users(root: any, args: {}): Promise<User[]> {\n      return getUserIds().then(ids => userLoader.loadMany(ids));\n    },\n\n    user(root: any, args: { id: string }): Promise<User[]> {\n      return userLoader.load(args.id);\n    },\n  },\n```\n\n`RootQuery`\u3068`users`,`user`\u306e\u968e\u5c64\u69cb\u9020\u304c\u4e00\u81f4\u3057\u3066\u3044\u308b\uff01\n\n\u95a2\u6570\u306e\u7b2c\u4e00\u5f15\u6570`root`\u306f\u89aa\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u6307\u3059\u3002\u3053\u306e\u5834\u5408\u306froot\u306a\u306e\u3067`undefined`\u3068\u306a\u308b\u3002\n\n---\n\n\u3010schema\u3068resolver\u306e\u5bfe\u5fdc\u306e\u89e3\u8aac\u3011(2/2)\n\n\u3053\u3046\u3044\u3046schema\u304c\u3042\u3063\u305f\u3089\u2026\n\n```\ntype User {\n  (\u7701\u7565)\n  follow: [User]\n  hobby: [Hobby]\n}\n```\n\n\u3053\u3046\u3044\u3046resolver\u3092\u66f8\u304f\u3002\n\n```ts\n  User: {\n    follow(user: User, args: {}): Promise<User[]> | null {\n      return user.follow ? userLoader.loadMany(user.follow) : null;\n    },\n\n    hobby(user: User, args: {}): Promise<Hobby[]> | null {\n      return user.hobby ? hobbyLoader.loadMany(user.hobby) : null;\n    }\n  }\n```\n\n`User`\u3068`follow`,`hobby`\u306e\u968e\u5c64\u69cb\u9020\u304c\u4e00\u81f4\u3057\u3066\u3044\u308b\uff01\n\n\u95a2\u6570\u306e\u7b2c\u4e00\u5f15\u6570`user`\u306f\u89aa\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u6307\u3059\u3002\u3053\u306e\u5834\u5408\u306f`User`\u578b\u306e\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3068\u306a\u308b\u3002\n\n---\n\n### \u5b9f\u969b\u306b\u30af\u30a8\u30ea\u3092\u30ea\u30af\u30a8\u30b9\u30c8\u3068\u304d\u306eGraphQL\u30b5\u30fc\u30d0\u30fc\u306e\u30ed\u30b0\u3092\u898b\u3066\u307f\u308b\u3002\n\n(DataLoader\u306b\u3088\u308bBatching, Caching\u7121\u3057)\n\n---\n\n\u30ea\u30af\u30a8\u30b9\u30c8 \u2192 \u2192\n\n```\n{\n  user(id:\"1\") {\n    ...userFragment\n    follow {\n      ...userFragment\n      follow {\n        ...userFragment\n        follow {\n          ...userFragment\n          follow {\n            ...userFragment\n          }\n        }\n      }\n    }\n  }\n}\n\nfragment userFragment on User {\n  id\n  name\n  address {\n    zip\n    street\n  }\n  hobby {\n    name\n  }  \n}\n```\n\n\u3053\u308c\u306ffragment\u3068\u3044\u3046\u6a5f\u80fd\u3092\u4f7f\u3063\u305f\u30af\u30a8\u30ea\u306e\u66f8\u304d\u65b9\u3002\n\n---\n\nGraphQL\u30b5\u30fc\u30d0\u30fc\u306e\u30ed\u30b0\n\n```\nuserLoader fetch: { id: '1', name: 'Tarou\u25cf' }\nhobbyLoader fetch: { id: '1', name: 'movie' }\nhobbyLoader fetch: { id: '2', name: 'swimming' }\nhobbyLoader fetch: { id: '3', name: 'hiking' }\nuserLoader fetch: { id: '2', name: 'Hanako\u25a0' }\nuserLoader fetch: { id: '3', name: 'John\u25b2' }\nhobbyLoader fetch: { id: '1', name: 'movie' }\nhobbyLoader fetch: { id: '2', name: 'swimming' }\nuserLoader fetch: { id: '3', name: 'John\u25b2' }\nuserLoader fetch: { id: '1', name: 'Tarou\u25cf' }\nuserLoader fetch: { id: '1', name: 'Tarou\u25cf' }\nuserLoader fetch: { id: '2', name: 'Hanako\u25a0' }\nuserLoader fetch: { id: '3', name: 'John\u25b2' }\nhobbyLoader fetch: { id: '1', name: 'movie' }\nhobbyLoader fetch: { id: '1', name: 'movie' }\nhobbyLoader fetch: { id: '1', name: 'movie' }\nhobbyLoader fetch: { id: '2', name: 'swimming' }\nhobbyLoader fetch: { id: '2', name: 'swimming' }\nhobbyLoader fetch: { id: '2', name: 'swimming' }\nhobbyLoader fetch: { id: '3', name: 'hiking' }\nhobbyLoader fetch: { id: '3', name: 'hiking' }\nuserLoader fetch: { id: '2', name: 'Hanako\u25a0' }\nuserLoader fetch: { id: '3', name: 'John\u25b2' }\nuserLoader fetch: { id: '3', name: 'John\u25b2' }\nuserLoader fetch: { id: '1', name: 'Tarou\u25cf' }\nhobbyLoader fetch: { id: '1', name: 'movie' }\nhobbyLoader fetch: { id: '1', name: 'movie' }\nhobbyLoader fetch: { id: '2', name: 'swimming' }\nhobbyLoader fetch: { id: '2', name: 'swimming' }\nhobbyLoader fetch: { id: '3', name: 'hiking' }\n```\n\n---\n\n### \u3053\u308c\u306f\u2026\uff01\uff01\uff01 \n\n---\n\n# where DataLoader comes into play\n\n---\n\n## dataLoader\u3092\u66f8\u304f\n\nnew DataLoader(callback) \u306b\u767b\u9332\u3059\u308b\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u306e\u57fa\u672c\u5f62\n`(keys: T[]) => Promise<R[]>`\n\n*\"(\u4f8b\u3048\u3070) string\u306e\u914d\u5217\u3092\u53d7\u3051\u53d6\u3063\u3066\u3001User\u306e\u914d\u5217\u3092Promise\u3067\u8fd4\u3059\u95a2\u6570\"*\n\n\u8a73\u7d30\u306f\u3053\u308c\u8aad\u3093\u3067 \u2192 [facebook/dataloader](https://github.com/facebook/dataloader)\n\n```ts:loaders.ts\nexport function createLoaders(cache: boolean = true, batch: boolean = true): Loaders {\n  const options = { cache, batch };\n  return {\n    userLoader: new DataLoader(userLoaderCallback, options),\n    hobbyLoader: new DataLoader(hobbyLoaderCallback, options),\n  }\n}\n\nfunction userLoaderCallback(keys: string[]): Promise<User[]> {\n  return getUsersConnector(keys);\n}\n\nfunction hobbyLoaderCallback(keys: string[]): Promise<Hobby[]> {\n  return getHobbiesConnector(keys);\n}\n```\n\n```ts:firebase-connectors.ts\nexport async function getUserIdsConnector(): Promise<string[]> {\n  const snapshot = await firebase.database().ref('users').once('value') as Snapshot;\n  const users: User[] = lodash.toArray<User>(snapshot.val()).filter(obj => !!obj);\n  users.forEach(user => assert(lodash.isObject(user) && 'id' in user));\n  const ids: string[] = users.map(user => user.id);\n  return ids;\n}\n\nexport async function getUsersConnector(keys: string[]): Promise<User[]> {\n  const snapshotPromises = keys.map(key => firebase.database().ref('users/' + key).once('value') as Promise<Snapshot>);\n  const snapshots = await Promise.all(snapshotPromises);\n  const users: User[] = snapshots.map(snapshot => snapshot.val());\n  users.forEach(user => assert(lodash.isObject(user) && 'id' in user));\n  console.log('userLoader fetch:', ...users.map(user => ({ id: user.id, name: user.name })));\n  return users;\n}\n\nexport async function getHobbiesConnector(keys: string[]): Promise<Hobby[]> {\n  const snapshotPromises = keys.map(key => firebase.database().ref('hobby/' + key).once('value') as Promise<Snapshot>);\n  const snapshots = await Promise.all(snapshotPromises);\n  const hobbies: Hobby[] = snapshots.map(snapshot => snapshot.val());\n  hobbies.forEach(hobby => assert(lodash.isObject(hobby) && 'id' in hobby));\n  console.log('hobbyLoader fetch:', ...hobbies.map(hobby => ({ id: hobby.id, name: hobby.name })));\n  return hobbies;\n}\n```\n\n---\n\nDataLoader\u3092\u4f7f\u3046\u3068\u3055\u3063\u304d\u306e\u30a2\u30ec\u304c\u3053\u3046\uff01\n\n```\nuserLoader fetch: { id: '1', name: 'Tarou\u25cf' }\nhobbyLoader fetch: { id: '1', name: 'movie' } { id: '2', name: 'swimming' } { id: '3', name: 'hiking' }\nuserLoader fetch: { id: '2', name: 'Hanako\u25a0' } { id: '3', name: 'John\u25b2' }\n```\n\n30\u56de\u306efetch\u304c6\u56de\u306b\uff01\n\u901a\u4fe1\u30b3\u30b9\u30c8\u306e\u5927\u5e45\u524a\u6e1b\uff01\n\n\u3061\u306a\u307f\u306b\u3053\u308c\u306f\u300c\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u2190\u2192GraphQL\u30b5\u30fc\u30d0\u30fc\u300d\u306e\u30ed\u30b0\u3067\u306f\u306a\u304f\u3001\u300cGraphQL\u30b5\u30fc\u30d0\u30fc\u2190\u2192DB\u30b5\u30fc\u30d0\u30fc\u300d\u306e\u30ed\u30b0\u3067\u3059\u3002\n\n---\n\n## DataLoader\u3092\u4f75\u7528\u3059\u308b\u3053\u3068\u3067GraphQL\u306f\u5a01\u529b\u3092\u767a\u63ee\u3059\u308b\n\n---\n\n### GraphQL\u304b\u306a\u308a\u3044\u3044\u3067\u3059\u3002\u307f\u3093\u306a\u4f7f\u3044\u307e\u3057\u3087\u3046\u3002\n\n---\n\n\u4eca\u56de\u306e\u30bd\u30fc\u30b9\u30b3\u30fc\u30c9\u306f\u5168\u3066\u4e0b\u8a18\u306e\u30ea\u30dd\u30b8\u30c8\u30ea\u304b\u3089\u306e\u5f15\u7528\u3067\u3059\u3002\n\n[ovrmrw/graphql-server-dataloader](https://github.com/ovrmrw/graphql-server-dataloader)\n\n---\n\n#### Thanks!\n", "tags": ["GraphQL", "apollo"]}