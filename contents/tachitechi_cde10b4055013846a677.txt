{"context": "\n\n\u3084\u308a\u305f\u3044\u3053\u3068\n\u3053\u3093\u306a\u611f\u3058\u3067\u3001MySQL\u3067\u30dc\u30c8\u30eb\u30cd\u30c3\u30af\u306b\u306a\u308a\u305d\u3046\u306aslow\u30af\u30a8\u30ea\u3092slack\u306b\u901a\u77e5\u3055\u305b\u3066\u3001\n\u7d99\u7d9a\u7684\u306b\u3001\u30af\u30a8\u30ea\u30c1\u30e5\u30fc\u30cb\u30f3\u30b0\u3067\u304d\u308b\u3088\u3046\u306b\u3057\u305f\u3044\u3002\n\n\u306a\u306e\u3067\u3001Mysql\u3067\u51fa\u529b\u3055\u308c\u305f\u30b9\u30ed\u30fc\u30af\u30a8\u30ea\u30ed\u30b0\u3092fluentd\u3067\u53d6\u5f97\u3057\u3001\n\u305d\u306e\u30af\u30a8\u30ea\u306b\u5bfe\u3057\u3066\u3001explain\u3092\u5b9f\u884c\u3055\u305b\u3066\u3001\u30af\u30a8\u30ea\u306e\u5185\u5bb9\u3068\u4e00\u7dd2\u306b\u3001\nexplain\u306e\u7d50\u679c\u3092slack\u306b\u901a\u77e5\u3067\u304d\u308b\u3088\u3046\u306b\u3059\u308b\u3002\n\n1. \u6e96\u5099\n\nslack\u306e\u6295\u7a3f\u5148webhookURL\u3092\u7528\u610f\u3059\u308b\nIncomingWebHook\u306e\u30ad\u30fc\u767a\u884c\u306f\u4ee5\u4e0b\u304b\u3089\u53d6\u5f97\u3059\u308b\nhttps://xxx.slack.com/services/new\n\n\u53c2\u8003URL: http://qiita.com/vmmhypervisor/items/18c99624a84df8b31008\n\n\n2. \u74b0\u5883\u69cb\u7bc9\n\nfluentd\n\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\ncurl -L https://toolbelt.treasuredata.com/sh/install-redhat-td-agent2.sh | sh\n\n\n\u8d77\u52d5\u78ba\u8a8d\n\n# /etc/init.d/td-agent start\ntd-agent td-agent:                                         [  OK  ]\n# /etc/init.d/td-agent status\ntd-agent is running                                        [  OK  ]\n# /etc/init.d/td-agent stop\nStopping td-agent: td-agent                                [  OK  ]\n\n\n\u5b9f\u88c5\u3059\u308b\u306e\u306b\u3001\u5fc5\u8981\u306a\u30e2\u30b8\u30e5\u30fc\u30eb\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n# td-agent-gem install fluent-plugin-nata2\n# td-agent-gem install fluent-plugin-mysql_explain\n# td-agent-gem install fluent-plugin-sql_fingerprint\n# td-agent-gem install fluent-plugin-slack\n\n\n\u5404\u30e2\u30b8\u30e5\u30fc\u30eb\u306b\u3064\u3044\u3066\n\nfluent-plugin-mysql_explain\n\nSQL\u306b\u5bfe\u3057\u3066\u3001EXPLAIN\u3092\u5b9f\u884c\u3057\u3066\u3001\u305d\u306e\u7d50\u679c\u3092explain\u5c5e\u6027\u306b\u4fdd\u6301\u3059\u308bfilter plugin\ngithub\uff1ahttps://github.com/kikumoto/fluent-plugin-mysql_explain\n\u5f15\u7528\uff1ahttp://kikumoto.hatenablog.com/entry/2015/12/04/000152\n\nfluent-plugin-sql_fingerprint\n\nin_mysqlslowquery_ex\u3067\u53d6\u5f97\u3055\u308c\u305fJSON\u306esql\u5c5e\u6027\u306b\u4fdd\u6301\u3055\u308c\u3066\u3044\u308bSQL\u6587\u306e\u30d1\u30e9\u30e1\u30fc\u30bf\u90e8\u5206\u3092\u62bd\u8c61\u5316\u3059\u308bplugin\ngithub\uff1ahttps://github.com/kikumoto/fluent-plugin-sql_fingerprint\n\u5f15\u7528\uff1ahttp://kikumoto.hatenablog.com/entry/2015/12/04/000152\n\nfluent-plugin-nata2\n\ngithub\uff1ahttps://github.com/studio3104/fluent-plugin-nata2\n\nfluent-plugin-slack\n\nslack\u306bpost\u3059\u308b\u305f\u3081\u306b\u5229\u7528\u3057\u305fplugin\ngithub\uff1ahttps://github.com/sowawa/fluent-plugin-slack\n\n\npercona-toolkit\n\nrpm\u30d5\u30a1\u30a4\u30eb\u306e\u53d6\u5f97\n\n# wget percona.com/get/percona-toolkit.rpm\n\n\n\u53d6\u5f97\u3067\u304d\u305f\u304b\u3092\u3001\u78ba\u8a8d\n\n# ls | grep percona\npercona-toolkit.rpm\n\n\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n# yum install percona-toolkit.rpm\n\n\n3. fluentd\u306e\u8a2d\u5b9a\n\nconf\u30d5\u30a1\u30a4\u30eb\u306e\u7de8\u96c6\nvim /etc/td-agent/td-agent.conf\n\n<source>\n    type mysqlslowquery_ex\n    read_from_head\n    path \u3010\u30d1\u30b9\u3092\u6307\u5b9a\u3011/slow.log\n    pos_file /var/log/td-agent/mysql-slow.pos\n    tag mysqld.slow_query.bp\n    last_dbname_file /tmp/slowquery.log.lastdb\n</source>\n\n<filter mysqld.slow_query.**>\n    type record_transformer\n    <record>\n        hostname ${hostname}\n    </record>\n</filter>\n\n<filter mysqld.slow_query.**>\n    type     mysql_explain\n    host     127.0.0.1\n    port     3306\n    username \u3010DB\u3078\u306e\u30a2\u30af\u30bb\u30b9\u30e6\u30fc\u30b6\u540d\u3092\u6307\u5b9a\u3011\n    password \u3010DB\u3078\u306e\u30a2\u30af\u30bb\u30b9\u30d1\u30b9\u30ef\u30fc\u30c9\u3092\u6307\u5b9a\u3011\n    database \u3010DB\u540d\u3092\u6307\u5b9a\u3011\n    sql_key  sql\n    added_key explain\n</filter>\n\n<filter mysqld.slow_query.**>\n    type sql_fingerprint\n    fingerprint_tool_path /usr/bin/pt-fingerprint\n</filter>\n\n<match mysqld.slow_query.**>\n    type copy\n    <store>\n        type slack\n        webhook_url \u3010slack\u306ewebhookURL\u3092\u6307\u5b9a\u3011\n        channel \u3010slack\u306echannel\u540d\u3092\u6307\u5b9a\u3011\n        username \u3010slack\u306e\u6295\u7a3f\u30e6\u30fc\u30b6\u540d\u3092\u6307\u5b9a\u3011\n        icon_emoji :x:\n        color danger\n        message \"*[User]* %s\\r\\n *[Host]* %s\\r\\n *[Query Time]* %s\\r\\n *[Lock Time]* %s\\r\\n *[Rows sent]* %s\\r\\n *[Rows Examined]* %s\\r\\n *[SQL]* %s \\r\\n *[Explain]* \\r\\n %s \\r\\n\"\n        message_keys user,host,query_time,lock_time,rows_sent,rows_examined,fingerprint,explain\n        flush_interval 1m\n    </store>\n</match>\n\n\nfluentd\u3092\u518d\u8d77\u52d5\nservice td-agent restart\n\n\n4. \u758e\u901a\u78ba\u8a8d\n\nslow\u30af\u30a8\u30ea\u3092\u4f5c\u3063\u3066\u3001slack\u306b\u901a\u77e5\u304c\u3044\u304f\u3053\u3068\u3092\u78ba\u8a8d\u3059\u308b\n\nslow\u30af\u30a8\u30ea\u3092\u5b9f\u884c\n\nSELECT COUNT(*), sleep(10) \nFROM blog_t\n\n\u666e\u6bb5\u306f\u3042\u307e\u308a\u4f7f\u308f\u306a\u3044\u304c\u3001sleep\u306710\u79d2\u304b\u304b\u308b\u30af\u30a8\u30ea\u3092\u4f5c\u6210\u3057\u3066\u3001slack\u3067\u901a\u77e5\u3092\u78ba\u8a8d\n\n\u4e0b\u8a18\u753b\u9762\u306e\u3088\u3046\u306b\u3001\u901a\u77e5\u304c\u5c4a\u304f\u3053\u3068\u3092\u78ba\u8a8d\u3059\u308b\n\n\n\n\u3046\u307e\u304f\u3044\u304b\u306a\u304b\u3063\u305f\u5834\u5408\u306f\u3001td\u30ed\u30b0\u3092\u78ba\u8a8d\u3057\u3066\u307f\u308b\n\u30fbtd-agent.conf\u3067\u8a2d\u5b9a\u3057\u305f\u30e6\u30fc\u30b6\u306eDB\u30a2\u30af\u30bb\u30b9\u6a29\u9650\u304c\u4ed8\u4e0e\u3055\u308c\u3066\u3044\u306a\u3044\n\u30fbexplain\u306e\u5b9f\u884c\u304c\u30a8\u30e9\u30fc\u306b\u306a\u3063\u3066\u3044\u308b\n\u30fbtd-agent\u81ea\u4f53\u304c\u505c\u6b62\u3057\u3066\u308b\u3001\u30d1\u30fc\u30b9\u304c\u3046\u307e\u304f\u3044\u3063\u3066\u306a\u3044\n\u306a\u3069\u3001warn\u3084error\u304c\u51fa\u3066\u3044\u305f\u3089\u3001\u3046\u307e\u304f\u3044\u3063\u3066\u3044\u306a\u3044\u53ef\u80fd\u6027\u3042\u308a\n# \u3084\u308a\u305f\u3044\u3053\u3068\n\n\u3053\u3093\u306a\u611f\u3058\u3067\u3001MySQL\u3067\u30dc\u30c8\u30eb\u30cd\u30c3\u30af\u306b\u306a\u308a\u305d\u3046\u306aslow\u30af\u30a8\u30ea\u3092slack\u306b\u901a\u77e5\u3055\u305b\u3066\u3001\n\u7d99\u7d9a\u7684\u306b\u3001\u30af\u30a8\u30ea\u30c1\u30e5\u30fc\u30cb\u30f3\u30b0\u3067\u304d\u308b\u3088\u3046\u306b\u3057\u305f\u3044\u3002\n\n![sample.png](https://qiita-image-store.s3.amazonaws.com/0/143284/79977559-cbac-fb54-a367-953a62f70389.png)\n\n\u306a\u306e\u3067\u3001Mysql\u3067\u51fa\u529b\u3055\u308c\u305f\u30b9\u30ed\u30fc\u30af\u30a8\u30ea\u30ed\u30b0\u3092fluentd\u3067\u53d6\u5f97\u3057\u3001\n\u305d\u306e\u30af\u30a8\u30ea\u306b\u5bfe\u3057\u3066\u3001explain\u3092\u5b9f\u884c\u3055\u305b\u3066\u3001\u30af\u30a8\u30ea\u306e\u5185\u5bb9\u3068\u4e00\u7dd2\u306b\u3001\nexplain\u306e\u7d50\u679c\u3092slack\u306b\u901a\u77e5\u3067\u304d\u308b\u3088\u3046\u306b\u3059\u308b\u3002\n\n# 1. \u6e96\u5099\n\n## slack\u306e\u6295\u7a3f\u5148webhookURL\u3092\u7528\u610f\u3059\u308b\n\nIncomingWebHook\u306e\u30ad\u30fc\u767a\u884c\u306f\u4ee5\u4e0b\u304b\u3089\u53d6\u5f97\u3059\u308b\nhttps://xxx.slack.com/services/new\n\n> \u53c2\u8003URL: http://qiita.com/vmmhypervisor/items/18c99624a84df8b31008\n\n# 2. \u74b0\u5883\u69cb\u7bc9\n\n## fluentd\n\n* \u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n```\ncurl -L https://toolbelt.treasuredata.com/sh/install-redhat-td-agent2.sh | sh\n```\n\n* \u8d77\u52d5\u78ba\u8a8d\n\n```\n# /etc/init.d/td-agent start\ntd-agent td-agent:                                         [  OK  ]\n# /etc/init.d/td-agent status\ntd-agent is running                                        [  OK  ]\n# /etc/init.d/td-agent stop\nStopping td-agent: td-agent                                [  OK  ]\n```\n\n* \u5b9f\u88c5\u3059\u308b\u306e\u306b\u3001\u5fc5\u8981\u306a\u30e2\u30b8\u30e5\u30fc\u30eb\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n```\n# td-agent-gem install fluent-plugin-nata2\n# td-agent-gem install fluent-plugin-mysql_explain\n# td-agent-gem install fluent-plugin-sql_fingerprint\n# td-agent-gem install fluent-plugin-slack\n```\n\n* \u5404\u30e2\u30b8\u30e5\u30fc\u30eb\u306b\u3064\u3044\u3066\n\nfluent-plugin-mysql_explain\n\n> SQL\u306b\u5bfe\u3057\u3066\u3001EXPLAIN\u3092\u5b9f\u884c\u3057\u3066\u3001\u305d\u306e\u7d50\u679c\u3092explain\u5c5e\u6027\u306b\u4fdd\u6301\u3059\u308bfilter plugin\n\n> github\uff1ahttps://github.com/kikumoto/fluent-plugin-mysql_explain\n\n> \u5f15\u7528\uff1ahttp://kikumoto.hatenablog.com/entry/2015/12/04/000152\n\nfluent-plugin-sql_fingerprint\n\n> in_mysqlslowquery_ex\u3067\u53d6\u5f97\u3055\u308c\u305fJSON\u306esql\u5c5e\u6027\u306b\u4fdd\u6301\u3055\u308c\u3066\u3044\u308bSQL\u6587\u306e\u30d1\u30e9\u30e1\u30fc\u30bf\u90e8\u5206\u3092\u62bd\u8c61\u5316\u3059\u308bplugin\n\n> github\uff1ahttps://github.com/kikumoto/fluent-plugin-sql_fingerprint\n\n> \u5f15\u7528\uff1ahttp://kikumoto.hatenablog.com/entry/2015/12/04/000152\n\nfluent-plugin-nata2\n\n> github\uff1ahttps://github.com/studio3104/fluent-plugin-nata2\n\nfluent-plugin-slack\n\n> slack\u306bpost\u3059\u308b\u305f\u3081\u306b\u5229\u7528\u3057\u305fplugin\n\n> github\uff1ahttps://github.com/sowawa/fluent-plugin-slack\n\n## percona-toolkit\n\n* rpm\u30d5\u30a1\u30a4\u30eb\u306e\u53d6\u5f97\n\n```\n# wget percona.com/get/percona-toolkit.rpm\n```\n\n* \u53d6\u5f97\u3067\u304d\u305f\u304b\u3092\u3001\u78ba\u8a8d\n\n```\n# ls | grep percona\npercona-toolkit.rpm\n```\n\n* \u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n```\n# yum install percona-toolkit.rpm\n```\n\n# 3. fluentd\u306e\u8a2d\u5b9a\n\n## conf\u30d5\u30a1\u30a4\u30eb\u306e\u7de8\u96c6\n\n```\nvim /etc/td-agent/td-agent.conf\n```\n\n```\n<source>\n    type mysqlslowquery_ex\n    read_from_head\n    path \u3010\u30d1\u30b9\u3092\u6307\u5b9a\u3011/slow.log\n    pos_file /var/log/td-agent/mysql-slow.pos\n    tag mysqld.slow_query.bp\n    last_dbname_file /tmp/slowquery.log.lastdb\n</source>\n\n<filter mysqld.slow_query.**>\n    type record_transformer\n    <record>\n        hostname ${hostname}\n    </record>\n</filter>\n\n<filter mysqld.slow_query.**>\n    type     mysql_explain\n    host     127.0.0.1\n    port     3306\n    username \u3010DB\u3078\u306e\u30a2\u30af\u30bb\u30b9\u30e6\u30fc\u30b6\u540d\u3092\u6307\u5b9a\u3011\n    password \u3010DB\u3078\u306e\u30a2\u30af\u30bb\u30b9\u30d1\u30b9\u30ef\u30fc\u30c9\u3092\u6307\u5b9a\u3011\n    database \u3010DB\u540d\u3092\u6307\u5b9a\u3011\n    sql_key  sql\n    added_key explain\n</filter>\n\n<filter mysqld.slow_query.**>\n    type sql_fingerprint\n    fingerprint_tool_path /usr/bin/pt-fingerprint\n</filter>\n\n<match mysqld.slow_query.**>\n    type copy\n    <store>\n        type slack\n        webhook_url \u3010slack\u306ewebhookURL\u3092\u6307\u5b9a\u3011\n        channel \u3010slack\u306echannel\u540d\u3092\u6307\u5b9a\u3011\n        username \u3010slack\u306e\u6295\u7a3f\u30e6\u30fc\u30b6\u540d\u3092\u6307\u5b9a\u3011\n        icon_emoji :x:\n        color danger\n        message \"*[User]* %s\\r\\n *[Host]* %s\\r\\n *[Query Time]* %s\\r\\n *[Lock Time]* %s\\r\\n *[Rows sent]* %s\\r\\n *[Rows Examined]* %s\\r\\n *[SQL]* %s \\r\\n *[Explain]* \\r\\n %s \\r\\n\"\n        message_keys user,host,query_time,lock_time,rows_sent,rows_examined,fingerprint,explain\n        flush_interval 1m\n    </store>\n</match>\n```\n\n## fluentd\u3092\u518d\u8d77\u52d5\n\n```\nservice td-agent restart\n```\n\n# 4. \u758e\u901a\u78ba\u8a8d\n\n## slow\u30af\u30a8\u30ea\u3092\u4f5c\u3063\u3066\u3001slack\u306b\u901a\u77e5\u304c\u3044\u304f\u3053\u3068\u3092\u78ba\u8a8d\u3059\u308b\n\n* slow\u30af\u30a8\u30ea\u3092\u5b9f\u884c\n\n```\nSELECT COUNT(*), sleep(10) \nFROM blog_t\n```\n\u666e\u6bb5\u306f\u3042\u307e\u308a\u4f7f\u308f\u306a\u3044\u304c\u3001sleep\u306710\u79d2\u304b\u304b\u308b\u30af\u30a8\u30ea\u3092\u4f5c\u6210\u3057\u3066\u3001slack\u3067\u901a\u77e5\u3092\u78ba\u8a8d\n\n* \u4e0b\u8a18\u753b\u9762\u306e\u3088\u3046\u306b\u3001\u901a\u77e5\u304c\u5c4a\u304f\u3053\u3068\u3092\u78ba\u8a8d\u3059\u308b\n\n![sample.png](https://qiita-image-store.s3.amazonaws.com/0/143284/79977559-cbac-fb54-a367-953a62f70389.png)\n\n\n\n## \u3046\u307e\u304f\u3044\u304b\u306a\u304b\u3063\u305f\u5834\u5408\u306f\u3001td\u30ed\u30b0\u3092\u78ba\u8a8d\u3057\u3066\u307f\u308b\n\n\u30fbtd-agent.conf\u3067\u8a2d\u5b9a\u3057\u305f\u30e6\u30fc\u30b6\u306eDB\u30a2\u30af\u30bb\u30b9\u6a29\u9650\u304c\u4ed8\u4e0e\u3055\u308c\u3066\u3044\u306a\u3044\n\u30fbexplain\u306e\u5b9f\u884c\u304c\u30a8\u30e9\u30fc\u306b\u306a\u3063\u3066\u3044\u308b\n\u30fbtd-agent\u81ea\u4f53\u304c\u505c\u6b62\u3057\u3066\u308b\u3001\u30d1\u30fc\u30b9\u304c\u3046\u307e\u304f\u3044\u3063\u3066\u306a\u3044\n\n\u306a\u3069\u3001warn\u3084error\u304c\u51fa\u3066\u3044\u305f\u3089\u3001\u3046\u307e\u304f\u3044\u3063\u3066\u3044\u306a\u3044\u53ef\u80fd\u6027\u3042\u308a\n\n\n\n", "tags": ["MySQL", "DB", "log", "Slack", "PHP"]}