{"context": "\n\n\u524d\u66f8\u304d\n\u30c7\u30d7\u30ed\u30a4\u30c4\u30fc\u30eb\u306f Ruby \u88fd\u306e Capistrano \u3084\u3001Python \u88fd\u306e Fabric\u3001 PHP \u88fd\u306e Deployer \u306a\u3069\u69d8\u3005\u3042\u308a\u307e\u3059\u3002\n\u7b46\u8005\u306f\u69cb\u6210\u7ba1\u7406\u30c4\u30fc\u30eb\u3067 Ansible \u3092\u4f7f\u3063\u3066\u3044\u308b\u305f\u3081\u3001Ansible \u3067\u30c7\u30d7\u30ed\u30a4\u51fa\u6765\u308c\u3070\u8272\u3005\u3068\u90fd\u5408\u304c\u3044\u3044\u3067\u3059\u3002\n\u305d\u3093\u306a\u6642\u306b\u51fa\u4f1a\u3063\u305f\u306e\u304c Ansistrano \u3067\u3057\u305f\u3002\nAnsible \u3092\u3042\u308b\u7a0b\u5ea6\u4f7f\u3048\u308b\u65b9\u306a\u3089\u7c21\u5358\u306b\u30c7\u30d7\u30ed\u30a4\u51fa\u6765\u3066\u3057\u307e\u3046\u306e\u3067\u30aa\u30b9\u30b9\u30e1\u3067\u3059\u3002\n\nAnsistrano \u3068\u306f\nansistrano/deploy: Ansible role to deploy scripting applications like PHP, Python, Ruby, etc. in a capistrano style\nPHP \u3001Python \u3084 Ruby \u306a\u3069\u306e\u3088\u3046\u306a\u30b9\u30af\u30ea\u30d7\u30c8\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u30c7\u30d7\u30ed\u30a4\u30d7\u30ed\u30bb\u30b9\u3092\u7c21\u5358\u306b\u7ba1\u7406\u3059\u308b\u305f\u3081\u306e Ansible \u30ed\u30fc\u30eb\u3067\u3059\u3002Capistrano \u30b9\u30bf\u30a4\u30eb\u306e\u30c7\u30d7\u30ed\u30a4\u304c Ansible \u3067\u53ef\u80fd\u306b\u306a\u308a\u307e\u3059\u3002\u30c7\u30d7\u30ed\u30a4\u3092\u884c\u3046 ansistrano.deploy \u3068\u30c7\u30d7\u30ed\u30a4\u306e\u30ed\u30fc\u30eb\u30d0\u30c3\u30af\u3092\u884c\u3046 ansistrano.rollback \u306e 2 \u3064\u306e\u30ed\u30fc\u30eb\u3067\u69cb\u6210\u3055\u308c\u3066\u3044\u307e\u3059\u3002Ansistrano \u3068\u3044\u3046\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u540d\u306f Ansible + Capistrano \u304b\u3089\u6765\u3066\u307e\u3059\u3002\n\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\nAnsistrano \u306f\u3001Ansible Galaxy \u3092\u4f7f\u7528\u3057\u305f\u30b0\u30ed\u30fc\u30d0\u30eb\u306a\u5206\u6563\u578b Ansible \u30ed\u30fc\u30eb\u3067\u3059\u3002\u4ee5\u4e0b\u306e\u30b3\u30de\u30f3\u30c9\u3067\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u51fa\u6765\u307e\u3059\u3002\n$ ansible-galaxy install carlosbuenosvinos.ansistrano-deploy carlosbuenosvinos.ansistrano-rollback\n\n\n\u30a2\u30c3\u30d7\u30c7\u30fc\u30c8\n\u30ed\u30fc\u30eb\u3092\u66f4\u65b0\u3057\u305f\u3044\u5834\u5408\u306f\u3001\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u6642\u306b --force \u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u901a\u3059\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\u4ee5\u4e0b\u306e\u30b3\u30de\u30f3\u30c9\u3067\u30a2\u30c3\u30d7\u30c7\u30fc\u30c8\u51fa\u6765\u307e\u3059\u3002\nansible-galaxy install --force carlosbuenosvinos.ansistrano-deploy carlosbuenosvinos.ansistrano-rollback\n\n\n\u30b5\u30fc\u30d0\u5074\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u69cb\u9020\n\u30c7\u30d7\u30ed\u30a4\u304c\u5b8c\u4e86\u3059\u308b\u3068\u30b5\u30fc\u30d0\u5074\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u69cb\u9020\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\u6307\u5b9a\u3057\u305f\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u4ee5\u4e0b\u306bcurrent/releases/shared\u3068\u3044\u30463\u3064\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u304c\u3067\u304d\u3042\u304c\u308a\u307e\u3059\u3002Web\u30b5\u30fc\u30d0\u5074\u3067\u306fcurrent\u3092\u6307\u5b9a\u3057\u3066\u304a\u304f\u3053\u3068\u3067\u3001\u30c7\u30d7\u30ed\u30a4\u3055\u308c\u308b\u5ea6\u306b\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u81ea\u52d5\u3067\u5207\u308a\u66ff\u3048\u3066\u304f\u308c\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\n\ntree\n.\n\u251c\u2500\u2500 current -> ./releases/20160530055905\n\u251c\u2500\u2500 releases\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 20160530055905\n\u2502\u00a0\u00a0 \u2502   \u251c\u2500\u2500 cache -> ../../shared/cache\n\u2502\u00a0\u00a0 \u2502   \u251c\u2500\u2500 logs -> ../../shared/logs\n\u2502\u00a0\u00a0 \u2502   \u251c\u2500\u2500 tmp -> ../../shared/tmp\n\u2502\u00a0\u00a0 \u2502   ...\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 20160530055658\n\u2502\u00a0\u00a0 \u2502   ...\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 20160530050508\n\u2502\u00a0\u00a0     ...\n\u2514\u2500\u2500 shared\n    \u251c\u2500\u2500 cache\n    \u251c\u2500\u2500 logs\n    \u2514\u2500\u2500 tmp\n\n\n\ncurrent\ncurrent \u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306f\u3001\u30b7\u30f3\u30dc\u30ea\u30c3\u30af\u30ea\u30f3\u30af\u3068\u306a\u3063\u3066\u304a\u308a\u3001releases \u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u4ee5\u4e0b\u306b\u4f5c\u6210\u3055\u308c\u305f\u7279\u5b9a\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u6307\u3057\u307e\u3059\u3002\u30a6\u30a7\u30d6\u30b5\u30fc\u30d0\u3084\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30b5\u30fc\u30d0\u306e\u8a2d\u5b9a\u3067\u306f\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u30eb\u30fc\u30c8\u306b\u3053\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u6307\u3059\u3088\u3046\u306b\u3057\u307e\u3059\u3002\n\nreleases\nreleases \u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306b\u306f\u3001\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30b3\u30fc\u30c9\u3092\u683c\u7d0d\u3057\u307e\u3059\u3002\u30c7\u30d7\u30ed\u30a4\u3054\u3068\u306b\u73fe\u5728\u65e5\u6642 ( timestamp ) \u3092\u540d\u524d\u3068\u3059\u308b\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u4f5c\u6210\u3057\u3001\u305d\u306e\u4e2d\u306b\u30b3\u30fc\u30c9\u3092\u683c\u7d0d\u3057\u307e\u3059\u3002\u904e\u53bb\u306e\u30c7\u30d7\u30ed\u30a4\u306b\u3088\u308b\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u4fdd\u6301\u3057\u3066\u3044\u308b\u306e\u3067\u3001current \u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306e\u30ea\u30f3\u30af\u5148\u3092\u5909\u3048\u308b\u3053\u3068\u3067\u7570\u306a\u308b\u30d0\u30fc\u30b8\u30e7\u30f3\u306e\u30b3\u30fc\u30c9\u3092\u52d5\u304b\u3059\u3053\u3068\u304c\u51fa\u6765\u307e\u3059\u3002 ansistrano_shared_paths \u30d1\u30e9\u30e1\u30fc\u30bf\u306e\u6570\u3092\u8d85\u3048\u305f\u3082\u306e\u306f\u53e4\u3044\u3082\u306e\u304b\u3089\u524a\u9664\u3055\u308c\u3066\u3044\u304d\u307e\u3059\u3002\n\nshared\nshared \u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306b\u306f\u3001releases \u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u4ee5\u4e0b\u306b\u4f5c\u6210\u3055\u308c\u305f\u5404\u30d0\u30fc\u30b8\u30e7\u30f3\u306e\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30b3\u30fc\u30c9\u304c\u5229\u7528\u3059\u308b\u30d5\u30a1\u30a4\u30eb\u3084\u30c7\u30a3\u30ec\u30af\u30c8\u30ea ( \u30bb\u30c3\u30b7\u30e7\u30f3\u3084\u30ad\u30e3\u30c3\u30b7\u30e5\u3001\u30ed\u30b0\u306a\u3069 ) \u3092\u683c\u7d0d\u3057\u307e\u3059\u3002\u5404\u30d0\u30fc\u30b8\u30e7\u30f3\u306e\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30b3\u30fc\u30c9\u304c\u5229\u7528\u3059\u308b\u30d5\u30a1\u30a4\u30eb\u3084\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306e\u30b7\u30f3\u30dc\u30ea\u30c3\u30af\u30ea\u30f3\u30af\u304c shared \u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u4ee5\u4e0b\u306e\u30d5\u30a1\u30a4\u30eb\u3084\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u6307\u3059\u3088\u3046\u306b\u3057\u540c\u3058\u5185\u5bb9\u304c\u53c2\u7167\u3067\u304d\u308b\u3088\u3046\u306b\u3057\u3066\u3044\u307e\u3059\u3002\n\n\u30ed\u30fc\u30eb\u5909\u6570\n\nvars\n- vars:\n  ansistrano_deploy_from: \"{{ playbook_dir }}\" # Where my local project is (relative or absolute path)\n  ansistrano_deploy_to: \"/var/www/my-app\" # Base path to deploy to.\n  ansistrano_version_dir: \"releases\" # Releases folder name\n  ansistrano_current_dir: \"current\" # Softlink name. You should rarely changed it.\n  ansistrano_current_via: \"symlink\" # Deployment strategy who code should be deployed to current path. Options are symlink or rsync\n  ansistrano_shared_paths: [] # Shared paths to symlink to release dir\n  ansistrano_keep_releases: 0 # Releases to keep after a new deployment. See \"Pruning old releases\".\n  ansistrano_deploy_via: \"rsync\" # Method used to deliver the code to the server. Options are copy, rsync, git, s3 or download.\n  ansistrano_allow_anonymous_stats: yes\n\n  # Variables used in the rsync deployment strategy\n  ansistrano_rsync_extra_params: \"\" # Extra parameters to use when deploying with rsync in a single string. Although Ansible allows an array this can cause problems if we try to add multiple --include args as it was reported in https://github.com/ansistrano/deploy/commit/e98942dc969d4e620313f00f003a7ea2eab67e86\n  ansistrano_rsync_set_remote_user: yes # See [ansible synchronize module](http://docs.ansible.com/ansible/synchronize_module.html). Options are yes, no.\n\n  # Variables used in the Git deployment strategy\n  ansistrano_git_repo: git@github.com:USERNAME/REPO.git # Location of the git repository\n  ansistrano_git_branch: master # What version of the repository to check out. This can be the full 40-character SHA-1 hash, the literal string HEAD, a branch name, or a tag name\n  ansistrano_git_identity_key_path: \"\" # If specified this file is copied over and used as the identity key for the git commands, path is relative to the playbook in which it is used\n\n  # Variables used in the download deployment strategy\n  ansistrano_get_url: https://github.com/someproject/somearchive.tar.gz\n\n  # Variables used in the S3 deployment strategy\n  ansistrano_s3_bucket: s3bucket\n  ansistrano_s3_object: s3object.tgz # Add the _unarchive suffix to the ansistrano_deploy_via if your object is a package (ie: s3_unarchive)\n  ansistrano_s3_region: eu-west-1\n  # Optional variables, omitted by default\n  ansistrano_s3_aws_access_key: YOUR_AWS_ACCESS_KEY\n  ansistrano_s3_aws_secret_key: YOUR_AWS_SECRET_KEY\n\n  # Hooks: custom tasks if you need them\n  ansistrano_before_setup_tasks_file: \"{{ playbook_dir }}/<your-deployment-config>/my-before-setup-tasks.yml\"\n  ansistrano_after_setup_tasks_file: \"{{ playbook_dir }}/<your-deployment-config>/my-after-setup-tasks.yml\"\n  ansistrano_before_update_code_tasks_file: \"{{ playbook_dir }}/<your-deployment-config>/my-before-update-code-tasks.yml\"\n  ansistrano_after_update_code_tasks_file: \"{{ playbook_dir }}/<your-deployment-config>/my-after-update-code-tasks.yml\"\n  ansistrano_before_symlink_shared_tasks_file: \"{{ playbook_dir }}/<your-deployment-config>/my-before-symlink-shared-tasks.yml\"\n  ansistrano_after_symlink_shared_tasks_file: \"{{ playbook_dir }}/<your-deployment-config>/my-after-symlink-shared-tasks.yml\"\n  ansistrano_before_symlink_tasks_file: \"{{ playbook_dir }}/<your-deployment-config>/my-before-symlink-tasks.yml\"\n  ansistrano_after_symlink_tasks_file: \"{{ playbook_dir }}/<your-deployment-config>/my-after-symlink-tasks.yml\"\n  ansistrano_before_cleanup_tasks_file: \"{{ playbook_dir }}/<your-deployment-config>/my-before-cleanup-tasks.yml\"\n  ansistrano_after_cleanup_tasks_file: \"{{ playbook_dir }}/<your-deployment-config>/my-after-cleanup-tasks.yml\"\n\n\n\n\n\n\u5909\u6570\n\u610f\u5473\n\n\n\n\nansistrano_deploy_from\nansistrano_deploy_via \u304c copy \u307e\u305f\u306f rsync \u306e\u5834\u5408\u306e\u3001\u30ed\u30fc\u30ab\u30eb\u4e0a\u306e\u30c7\u30d7\u30ed\u30a4\u5143\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30b3\u30fc\u30c9\u306e\u30d1\u30b9\u3002\n\n\nansistrano_deploy_to\n\u30ea\u30e2\u30fc\u30c8\u30b5\u30fc\u30d0\u4e0a\u306e\u30c7\u30d7\u30ed\u30a4\u5148\u306e\u30d1\u30b9\u3002\n\n\nansistrano_shared_paths\nreleases \u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u4ee5\u4e0b\u306b\u4fdd\u6301\u3059\u308b\u4e16\u4ee3\u6570\u3002\n\n\nansistrano_deploy_via\n\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30b3\u30fc\u30c9\u306e\u30c7\u30d7\u30ed\u30a4\u65b9\u6cd5\u3002copy, rsync, git, s3, s3_unarchive, unarchive \u304b\u3089\u6307\u5b9a\u3002\n\n\nansistrano_allow_anonymous_stats\nAnsistrano \u306e\u30b5\u30a4\u30c8\u306b\u5229\u7528\u72b6\u6cc1\u3092\u9001\u4fe1\u3059\u308b\u304b\u5426\u304b\u3002\n\n\nansistrano_git_repo\n\u30b3\u30fc\u30c9\u3092\u53d6\u5f97\u3059\u308bGit\u30ea\u30dd\u30b8\u30c8\u30ea\u3002\n\n\nansistrano_git_branch\n\u30b3\u30fc\u30c9\u3092\u53d6\u5f97\u3059\u308b\u30d6\u30e9\u30f3\u30c1\u3002\n\n\nansistrano_git_identity_key_path\n\u30ea\u30e2\u30fc\u30c8\u30b5\u30fc\u30d0\u30fc\u4e0a\u306b\u3042\u308b Git \u30ea\u30dd\u30b8\u30c8\u30ea\u3078\u306e ssh \u63a5\u7d9a\u306b\u5229\u7528\u3059\u308b\u79d8\u5bc6\u9375\u306e\u30d1\u30b9\u3002\n\n\n\n\n\u30e1\u30a4\u30f3\u30ef\u30fc\u30af\u30d5\u30ed\u30fc\nAnsistrano \u306f\u30c7\u30d7\u30ed\u30a4\u306b\u304a\u3044\u3066 Capistrano \u306e\u30d5\u30ed\u30fc\u3092\u30d5\u30a9\u30ed\u30fc\u3057\u3066\u3044\u307e\u3059\u3002\n\u4ee5\u4e0b\u30c0\u30a4\u30a2\u30b0\u30e9\u30e0\u306e\u7070\u8272\u7b87\u6240\u304c\u30e1\u30a4\u30f3\u30ef\u30fc\u30af\u30d5\u30ed\u30fc\u306e\u5404\u30b9\u30c6\u30c3\u30d7\u3067\u3001\u9ec4\u8272\u7b87\u6240\u304c\u5404\u30b9\u30c6\u30c3\u30d7\u306e\u524d\u5f8c\u306b\u5b9f\u884c\u3055\u308c\u308b\u30ab\u30b9\u30bf\u30e0\u30bf\u30b9\u30af\u306e\u30d5\u30c3\u30af\u30dd\u30a4\u30f3\u30c8\u3067\u3059\u3002\n\n\n\u30b9\u30c6\u30c3\u30d7\n\u30e1\u30a4\u30f3\u30ef\u30fc\u30af\u30d5\u30ed\u30fc\u306e\u30d5\u30a7\u30fc\u30ba\u306f\u4ee5\u4e0b\u306e 5 \u30b9\u30c6\u30c3\u30d7\u3067\u69cb\u6210\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n\n\n\n\u30b9\u30c6\u30c3\u30d7\n\u610f\u5473\n\n\n\n\nSetup\n\nreleases \u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u4ee5\u4e0b\u306b\u73fe\u5728\u65e5\u6642 ( timestamp ) \u3092\u540d\u524d\u3068\u3059\u308b\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n\nUpdate Code\n\nSetup \u30b9\u30c6\u30c3\u30d7 \u3067\u4f5c\u6210\u3057\u305f\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306b\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30b3\u30fc\u30c9\u3092\u8a2d\u7f6e\u3057\u307e\u3059\u3002\n\n\nSymlink Shared\n\nansistrano_shared_paths \u30d1\u30e9\u30e1\u30fc\u30bf\u306b\u57fa\u3065\u3044\u3066\u3001\u30b7\u30f3\u30dc\u30ea\u30c3\u30af\u30ea\u30f3\u30af\u304c shared \u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u4ee5\u4e0b\u306e\u30d5\u30a1\u30a4\u30eb\u3084\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u6307\u3059\u3088\u3046\u306b\u3057\u307e\u3059\u3002\n\n\nSymlink\n\ncurrent \u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306e\u30b7\u30f3\u30dc\u30ea\u30c3\u30af\u30ea\u30f3\u30af\u304c Setup \u30b9\u30c6\u30c3\u30d7 \u3067\u4f5c\u6210\u3057\u305f\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u6307\u3059\u3088\u3046\u306b\u5909\u66f4\u3057\u307e\u3059\u3002\n\n\nCleanup\n\nansistrano_keep_releases \u30d1\u30e9\u30e1\u30fc\u30bf\u306b\u57fa\u3065\u3044\u3066\u3001\u4efb\u610f\u306e\u53e4\u3044\u30d0\u30fc\u30b8\u30e7\u30f3\u3092\u524a\u9664\u3057\u307e\u3059\u3002\n\n\n\n\n\u30ab\u30b9\u30bf\u30e0\u30bf\u30b9\u30af\u306e\u30d5\u30c3\u30af\nansistrano_before_*_tasks_file \u3068 ansistrano_after_*_tasks_file \u30d1\u30e9\u30e1\u30fc\u30bf\u306b\u3001\u5404\u30b9\u30c6\u30c3\u30d7\u306e\u524d\u5f8c\u306b\u30ab\u30b9\u30bf\u30e0\u30bf\u30b9\u30af\u30d5\u30a1\u30a4\u30eb\u3092\u6307\u5b9a\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\u4efb\u610f\u306e\u30d5\u30c3\u30af\u30dd\u30a4\u30f3\u30c8\u3067\u4efb\u610f\u306e\u30bf\u30b9\u30af\u3092\u5b9f\u884c\u3059\u308b\u3053\u3068\u304c\u53ef\u80fd\u3067\u3059\u3002\n\nvars\n# Hooks: custom tasks if you need them\nansistrano_before_setup_tasks_file: \"{{ playbook_dir }}/<your-deployment-config>/my-before-setup-tasks.yml\"\nansistrano_after_setup_tasks_file: \"{{ playbook_dir }}/<your-deployment-config>/my-after-setup-tasks.yml\"\nansistrano_before_update_code_tasks_file: \"{{ playbook_dir }}/<your-deployment-config>/my-before-update-code-tasks.yml\"\nansistrano_after_update_code_tasks_file: \"{{ playbook_dir }}/<your-deployment-config>/my-after-update-code-tasks.yml\"\nansistrano_before_symlink_shared_tasks_file: \"{{ playbook_dir }}/<your-deployment-config>/my-before-symlink-shared-tasks.yml\"\nansistrano_after_symlink_shared_tasks_file: \"{{ playbook_dir }}/<your-deployment-config>/my-after-symlink-shared-tasks.yml\"\nansistrano_before_symlink_tasks_file: \"{{ playbook_dir }}/<your-deployment-config>/my-before-symlink-tasks.yml\"\nansistrano_after_symlink_tasks_file: \"{{ playbook_dir }}/<your-deployment-config>/my-after-symlink-tasks.yml\"\nansistrano_before_cleanup_tasks_file: \"{{ playbook_dir }}/<your-deployment-config>/my-before-cleanup-tasks.yml\"\nansistrano_after_cleanup_tasks_file: \"{{ playbook_dir }}/<your-deployment-config>/my-after-cleanup-tasks.yml\"\n\n\n\nAnsistrano \u306e\u4f7f\u3044\u65b9\n\n\u30c7\u30d7\u30ed\u30a4\n\nplaybook \u306e\u6e96\u5099\n\u30c7\u30d7\u30ed\u30a4\u3059\u308b\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306f PHP \u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3092\u60f3\u5b9a\u3057\u3066\u3044\u307e\u3059\u3002\n\nplaybook\n.\n\u251c\u2500\u2500 deploy.yml\n\u251c\u2500\u2500 group_vars\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 all.yml\n\u251c\u2500\u2500 hosts\n\u2514\u2500\u2500 roles\n    \u2514\u2500\u2500 hooks\n        \u2514\u2500\u2500 tasks\n            \u251c\u2500\u2500 after_update_code.yml\n            \u251c\u2500\u2500 before_symlink_shared.yml\n            \u2514\u2500\u2500 after_symlink.yml\n\n\n\nhosts \u30d5\u30a1\u30a4\u30eb\n\nhosts\nwww.example.com\n\n\n\nvars \u30d5\u30a1\u30a4\u30eb\ngroup_vars \u3067\u5909\u6570\u3092\u5b9a\u7fa9\u3057\u3066\u3044\u307e\u3059\u304c\u3001\u5225\u306e\u5834\u6240\u3067\u5b9a\u7fa9\u3057\u3066\u3082\u554f\u984c\u3042\u308a\u307e\u305b\u3093\u3002\n\ngroup_vars/all.yml\n---\nansistrano_deploy_to: /var/www/app\nansistrano_shared_paths:\n  - cache\n  - logs\n  - tmp\nansistrano_allow_anonymous_stats: no\nansistrano_keep_releases: 5\nansistrano_deploy_via: git\nansistrano_git_repo: git@github.com:USERNAME/REPO.git\nansistrano_git_branch: master\nansistrano_after_update_code_tasks_file: \"{{ playbook_dir }}/roles/hooks/task/after_update_code.yml\"\nansistrano_after_update_code_tasks_file: \"{{ playbook_dir }}/roles/hooks/tasks/before_symlink_shared.yml\"\nansistrano_after_symlink_tasks_file: \"{{ playbook_dir }}/roles/hooks/task/after_symlink.yml\"\n\n\n\nplaybook\nAnsistrano\u3067node.js\u306e\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b - Qiita\n\nansistrano_deploy_via \u306b\u3064\u3044\u3066\u306f Ansistrano \u306e\u4e2d\u3067 include \u3092\u4f7f\u3063\u305f\u30c8\u30ea\u30c3\u30af\u304c\u4f7f\u308f\u308c\u3066\u3044\u308b\u306e\u3067vars_files\u3067\u306f\u3046\u307e\u304f\u884c\u304d\u307e\u305b\u3093\u3067\u3057\u305f\u3002\n\n\u306e\u901a\u308a\u3001 vars_files \u3084 group_vars \u3067 ansistrano_deploy_via \u3092\u5b9a\u7fa9\u3059\u308b\u3068\u3001\u30d1\u30e9\u30e1\u30fc\u30bf\u95a2\u4fc2\u306a\u3057\u306b rsync \u3067\u5b9f\u884c\u3055\u308c\u3066\u3057\u307e\u3044\u307e\u3059\u3002\u305d\u306e\u305f\u3081\u30c8\u30c3\u30d7\u30ec\u30d9\u30eb YAML \u306e vars \u3067\u5b9a\u7fa9\u3057\u3066\u3044\u307e\u3059\u3002\n\ndeploy.yml\n---\n- hosts: all\n  become: yes\n  become_user: www-data\n  vars:\n    ansistrano_deploy_via: git\n  roles:\n    - carlosbuenosvinos.ansistrano-deploy\n\n\n\n\u30d5\u30c3\u30af\u3067\u5b9f\u884c\u3055\u308c\u308b\u30ab\u30b9\u30bf\u30e0\u30bf\u30b9\u30af\nUpdate Code \u30b9\u30c6\u30c3\u30d7\u306e\u5f8c\u3067\u5b9f\u884c\u3055\u308c\u308b\u30ab\u30b9\u30bf\u30e0\u30bf\u30b9\u30af\u3002\n\nroles/hooks/tasks/after_update_code.yml\n---\n- name: ANSISTRANO | HOOKS | Whether or not the composer is present\n  stat: path=/usr/bin/composer\n  register: is_composer\n\n- name: ANSISTRANO | HOOKS | Install composer\n  shell: curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/bin --filename=composer creates=/usr/bin/composer\n  become_user: root\n  when: not is_composer.stat.exists\n\n- name: ANSISTRANO | HOOKS | Update composer\n  become: yes\n  become_user: root\n  composer:\n    command=install\n    working_dir={{ ansistrano_release_path.stdout }}\n\n\nSymlink \u30b9\u30c6\u30c3\u30d7\u306e\u524d\u3067\u5b9f\u884c\u3055\u308c\u308b\u30ab\u30b9\u30bf\u30e0\u30bf\u30b9\u30af\u3002\n\nroles/hooks/tasks/before_symlink_shared\n---\n- name: ANSISTRANO | HOOKS | Create shared paths\n  file: state=directory path={{ ansistrano_deploy_to }}/shared/{{ item }} mode=0777\n  with_items: ansistrano_shared_paths\n\n\nSymlink \u30b9\u30c6\u30c3\u30d7\u306e\u5f8c\u3067\u5b9f\u884c\u3055\u308c\u308b\u30ab\u30b9\u30bf\u30e0\u30bf\u30b9\u30af\u3002\n\nroles/hooks/tasks/after_symlink.yml\n---\n- name: ANSISTRANO | HOOKS | Restart nginx\n  service: name=nginx state=restarted\n  become: yes\n  become_user: root\n\n\n\u30ab\u30b9\u30bf\u30e0\u30bf\u30b9\u30af\u306e\u30d5\u30a1\u30a4\u30eb\u3092\u8a18\u8ff0\u3059\u308b\u5834\u5408\u306f\u3001\u5fc5\u8981\u3068\u3055\u308c\u308b\u3044\u304f\u3064\u304b\u306e\u5909\u6570\u3092\u4f7f\u3046\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\n\n\n\u5909\u6570\n\u610f\u5473\n\n\n\n\n{{ ansistrano_release_path.stdout }}\n\ncurrent \u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306e\u30ea\u30f3\u30af\u5148\u306e\u30d1\u30b9\n\n\n{{ ansistrano_releases_path.stdout }}\n\nreleases \u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3078\u306e\u30d1\u30b9\n\n\n{{ ansistrano_shared_path.stdout }}\n\nshared \u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3078\u306e\u30d1\u30b9\n\n\n{{ ansistrano_release_version }}\n\ncurrent \u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306e\u30ea\u30f3\u30af\u5148\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u540d ( timestamp )\n\n\n\n\n\u5b9f\u884c\nansible-playbook -i hosts deploy.yml\n\n\u5168\u3066\u304c\u6b63\u3057\u304f\u8a2d\u5b9a\u3055\u308c\u3066\u3044\u308b\u5834\u5408\u3001\u3053\u306e\u30b3\u30de\u30f3\u30c9\u306f\u3001\u30b5\u30fc\u30d0\u30fc\u5074\u3067\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u69cb\u9020\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n/var/www/app\n.\n\u251c\u2500\u2500 current -> ./releases/20160530055905\n\u251c\u2500\u2500 releases\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 20160530055905\n\u2502\u00a0\u00a0 \u2502   \u251c\u2500\u2500 cache -> ../../shared/cache\n\u2502\u00a0\u00a0 \u2502   \u251c\u2500\u2500 logs -> ../../shared/logs\n\u2502\u00a0\u00a0 \u2502   \u251c\u2500\u2500 tmp -> ../../shared/tmp\n\u2502\u00a0\u00a0 \u2502   ...\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 20160530055658\n\u2502\u00a0\u00a0 \u2502   ...\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 20160530050508\n\u2502\u00a0\u00a0     ...\n\u2514\u2500\u2500 shared\n    \u251c\u2500\u2500 cache\n    \u251c\u2500\u2500 logs\n    \u2514\u2500\u2500 tmp\n\n\n\n\u8907\u6570\u306e\u30b5\u30fc\u30d0\u30fc\u306b\u30c7\u30d7\u30ed\u30a4\n\u5404\u30b5\u30fc\u30d0\u30fc\u306e releases \u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u4ee5\u4e0b\u306b\u7570\u306a\u308b timestamp \u3067\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u304c\u4f5c\u6210\u3055\u308c\u308b\u3053\u3068\u3092\u9632\u6b62\u3059\u308b\u305f\u3081\u306b serial \u30aa\u30d7\u30b7\u30e7\u30f3\u3092\u4f7f\u7528\u3057\u307e\u3059\u3002 serial \u30aa\u30d7\u30b7\u30e7\u30f3\u306b\u306f ansistrano_release_version \u3092\u8a2d\u5b9a\u3057\u5b9f\u884c\u3057\u307e\u3059\u3002\n$ ansible-playbook -i hosts -e \"ansistrano_release_version=`date -u +%Y%m%d%H%M%S`\" deploy.yml\n\n\n\u591a\u6bb5\u74b0\u5883\u306e\u30c7\u30d7\u30ed\u30a4\ndevelopment \u3001staging \u3084 production \u306a\u3069\u306e\u3088\u3046\u306a\u69d8\u3005\u306a\u74b0\u5883\u306b\u30c7\u30d7\u30ed\u30a4\u3059\u308b\u5834\u5408\u306f\u3001\u7570\u306a\u308b\u30a4\u30f3\u30d9\u30f3\u30c8\u30ea\u30fc\u30d5\u30a1\u30a4\u30eb\u3068\u5909\u6570\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\u4f5c\u6210\u3057\u305f\u3089\u3001 \u30c7\u30d7\u30ed\u30a4\u3057\u305f\u3044\u74b0\u5883\u306e\u30a4\u30f3\u30d9\u30c8\u30ea\u30fc\u30d5\u30a1\u30a4\u30eb\u3092 -i \u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u4f7f\u3063\u3066\u6307\u5b9a\u3057\u5b9f\u884c\u3057\u307e\u3059\u3002\u3000\n\nplaybook \u306e\u6e96\u5099\nstaging \u3068 production \u74b0\u5883\u306e\u5834\u5408\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\n\nplaybook\n.\n\u251c\u2500\u2500 production         # inventory file for production servers\n\u251c\u2500\u2500 staging            # inventory file for staging environment\n\u251c\u2500\u2500 group_vars\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 all.yml\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 production.yml # variables file for production groups\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 staging.yml    # variables file for staging groups\n\u251c\u2500\u2500 deploy.yml\n\u2514\u2500\u2500 roles\n \u00a0\u00a0 \u2514\u2500\u2500 hooks\n \u00a0\u00a0     \u2514\u2500\u2500 tasks\n \u00a0\u00a0         \u251c\u2500\u2500 after_symlink.yml\n \u00a0\u00a0         \u251c\u2500\u2500 after_update_code.yml\n \u00a0\u00a0         \u2514\u2500\u2500 before_symlink_shared.yml\n\n\n\nhosts \u30d5\u30a1\u30a4\u30eb\n\nproduction\n[production]\nprod.example.com\n\n\n\nstaging\n[staging]\nstg.example.com\n\n\n\nvars \u30d5\u30a1\u30a4\u30eb\ngroup_vars/production.yml \u3068 group_vars/staging.yml \u3092\u4f5c\u6210\u3057\u3001\u305d\u308c\u305e\u308c\u74b0\u5883\u3054\u3068\u306b Ansistrano \u306e\u30ed\u30fc\u30eb\u5909\u6570\u3084\u30e6\u30fc\u30b6\u30fc\u3084\u30d1\u30b9\u30ef\u30fc\u30c9\u7b49\u306e\u5909\u6570\u3092\u5b9a\u7fa9\u3057\u307e\u3059\u3002\n\n\u5b9f\u884c\nansible-playbook -i production deploy.yml\n\nansible-playbook -i staging deploy.yml\n\n\n\u30ed\u30fc\u30eb\u30d0\u30c3\u30af\n\n\u30ed\u30fc\u30eb\u5909\u6570\n\u30c7\u30d7\u30ed\u30a4\u306e\u30ed\u30fc\u30eb\u5909\u6570\u306b\u6bd4\u3079\u3066\u30ed\u30fc\u30eb\u30d0\u30c3\u30af\u306e\u30ed\u30fc\u30eb\u5909\u6570\u306f\u5c11\u306a\u3044\u3067\u3059\u3002\n\nvars\n- vars:\n  ansistrano_deploy_to: \"/var/www/my-app\" # Base path to deploy to.\n  ansistrano_version_dir: \"releases\" # Releases folder name\n  ansistrano_current_dir: \"current\" # Softlink name. You should rarely changed it.\n  ansistrano_remove_rolled_back: yes # Remove rolled back release?\n  ansistrano_allow_anonymous_stats: yes\n\n  # Hooks: custom tasks if you need them\n  ansistrano_before_symlink_tasks_file: \"{{ playbook_dir }}/<your-deployment-config>/my-before-symlink-tasks.yml\"\n  ansistrano_after_symlink_tasks_file: \"{{ playbook_dir }}/<your-deployment-config>/my-after-symlink-tasks.yml\"\n  ansistrano_before_cleanup_tasks_file: \"{{ playbook_dir }}/<your-deployment-config>/my-before-cleanup-tasks.yml\"\n  ansistrano_after_cleanup_tasks_file: \"{{ playbook_dir }}/<your-deployment-config>/my-after-cleanup-tasks.yml\"\n\n\n\n\u5b9f\u884c\nansible-playbook -i hosts rollback.yml\n\n\u203b releases \u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u4ee5\u4e0b\u306b\u4f5c\u6210\u3055\u308c\u305f\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30b3\u30fc\u30c9\u304c 0 \u307e\u305f\u306f 1 \u3064\u3060\u3063\u305f\u5834\u5408\u3001\u30ed\u30fc\u30eb\u30d0\u30c3\u30af\u3057\u3088\u3046\u3068\u3059\u308b\u3068\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3057\u5b9f\u884c\u3055\u308c\u307e\u305b\u3093\u3002\n\n\u6ce8\u610f\u70b9\n\nOPcache \u304c\u6709\u52b9\u3067\u4e14\u3064 PHP-FPM \u3092\u4f7f\u7528\u3057\u305f \u30a6\u30a7\u30d6\u30b5\u30fc\u30d0\u3067\u3001Symlink \u30d9\u30fc\u30b9\u306e\u30c7\u30d7\u30ed\u30a4\u3059\u308b\u3068\u30b3\u30fc\u30c9\u304c\u53cd\u6620\u3055\u308c\u306a\u3044 - Qiita\n\n\n\u53c2\u8003\u6587\u732e\n\nansistrano/deploy: Ansible role to deploy scripting applications like PHP, Python, Ruby, etc. in a capistrano style\nAnsistrano\u3067node.js\u306e\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b - Qiita\n\n\n## \u524d\u66f8\u304d\n\n\u30c7\u30d7\u30ed\u30a4\u30c4\u30fc\u30eb\u306f Ruby \u88fd\u306e Capistrano \u3084\u3001Python \u88fd\u306e Fabric\u3001 PHP \u88fd\u306e Deployer \u306a\u3069\u69d8\u3005\u3042\u308a\u307e\u3059\u3002\n\u7b46\u8005\u306f\u69cb\u6210\u7ba1\u7406\u30c4\u30fc\u30eb\u3067 Ansible \u3092\u4f7f\u3063\u3066\u3044\u308b\u305f\u3081\u3001Ansible \u3067\u30c7\u30d7\u30ed\u30a4\u51fa\u6765\u308c\u3070\u8272\u3005\u3068\u90fd\u5408\u304c\u3044\u3044\u3067\u3059\u3002\n\u305d\u3093\u306a\u6642\u306b\u51fa\u4f1a\u3063\u305f\u306e\u304c Ansistrano \u3067\u3057\u305f\u3002\nAnsible \u3092\u3042\u308b\u7a0b\u5ea6\u4f7f\u3048\u308b\u65b9\u306a\u3089\u7c21\u5358\u306b\u30c7\u30d7\u30ed\u30a4\u51fa\u6765\u3066\u3057\u307e\u3046\u306e\u3067\u30aa\u30b9\u30b9\u30e1\u3067\u3059\u3002\n\n## Ansistrano \u3068\u306f\n\n[ansistrano/deploy: Ansible role to deploy scripting applications like PHP, Python, Ruby, etc. in a capistrano style](https://github.com/ansistrano/deploy \"ansistrano/deploy: Ansible role to deploy scripting applications like PHP, Python, Ruby, etc. in a capistrano style\")\n\nPHP \u3001Python \u3084 Ruby \u306a\u3069\u306e\u3088\u3046\u306a\u30b9\u30af\u30ea\u30d7\u30c8\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u30c7\u30d7\u30ed\u30a4\u30d7\u30ed\u30bb\u30b9\u3092\u7c21\u5358\u306b\u7ba1\u7406\u3059\u308b\u305f\u3081\u306e Ansible \u30ed\u30fc\u30eb\u3067\u3059\u3002Capistrano \u30b9\u30bf\u30a4\u30eb\u306e\u30c7\u30d7\u30ed\u30a4\u304c Ansible \u3067\u53ef\u80fd\u306b\u306a\u308a\u307e\u3059\u3002\u30c7\u30d7\u30ed\u30a4\u3092\u884c\u3046 `ansistrano.deploy` \u3068\u30c7\u30d7\u30ed\u30a4\u306e\u30ed\u30fc\u30eb\u30d0\u30c3\u30af\u3092\u884c\u3046 `ansistrano.rollback` \u306e 2 \u3064\u306e\u30ed\u30fc\u30eb\u3067\u69cb\u6210\u3055\u308c\u3066\u3044\u307e\u3059\u3002Ansistrano \u3068\u3044\u3046\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u540d\u306f Ansible + Capistrano \u304b\u3089\u6765\u3066\u307e\u3059\u3002\n\n## \u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\nAnsistrano \u306f\u3001Ansible Galaxy \u3092\u4f7f\u7528\u3057\u305f\u30b0\u30ed\u30fc\u30d0\u30eb\u306a\u5206\u6563\u578b Ansible \u30ed\u30fc\u30eb\u3067\u3059\u3002\u4ee5\u4e0b\u306e\u30b3\u30de\u30f3\u30c9\u3067\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u51fa\u6765\u307e\u3059\u3002\n\n```\n$ ansible-galaxy install carlosbuenosvinos.ansistrano-deploy carlosbuenosvinos.ansistrano-rollback\n```\n\n## \u30a2\u30c3\u30d7\u30c7\u30fc\u30c8\n\n\u30ed\u30fc\u30eb\u3092\u66f4\u65b0\u3057\u305f\u3044\u5834\u5408\u306f\u3001\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u6642\u306b `--force` \u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u901a\u3059\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\u4ee5\u4e0b\u306e\u30b3\u30de\u30f3\u30c9\u3067\u30a2\u30c3\u30d7\u30c7\u30fc\u30c8\u51fa\u6765\u307e\u3059\u3002\n\n```\nansible-galaxy install --force carlosbuenosvinos.ansistrano-deploy carlosbuenosvinos.ansistrano-rollback\n```\n\n## \u30b5\u30fc\u30d0\u5074\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u69cb\u9020\n\n\u30c7\u30d7\u30ed\u30a4\u304c\u5b8c\u4e86\u3059\u308b\u3068\u30b5\u30fc\u30d0\u5074\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u69cb\u9020\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\u6307\u5b9a\u3057\u305f\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u4ee5\u4e0b\u306bcurrent/releases/shared\u3068\u3044\u30463\u3064\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u304c\u3067\u304d\u3042\u304c\u308a\u307e\u3059\u3002Web\u30b5\u30fc\u30d0\u5074\u3067\u306fcurrent\u3092\u6307\u5b9a\u3057\u3066\u304a\u304f\u3053\u3068\u3067\u3001\u30c7\u30d7\u30ed\u30a4\u3055\u308c\u308b\u5ea6\u306b\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u81ea\u52d5\u3067\u5207\u308a\u66ff\u3048\u3066\u304f\u308c\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\n\n```tree:tree\n.\n\u251c\u2500\u2500 current -> ./releases/20160530055905\n\u251c\u2500\u2500 releases\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 20160530055905\n\u2502\u00a0\u00a0 \u2502   \u251c\u2500\u2500 cache -> ../../shared/cache\n\u2502\u00a0\u00a0 \u2502   \u251c\u2500\u2500 logs -> ../../shared/logs\n\u2502\u00a0\u00a0 \u2502   \u251c\u2500\u2500 tmp -> ../../shared/tmp\n\u2502\u00a0\u00a0 \u2502   ...\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 20160530055658\n\u2502\u00a0\u00a0 \u2502   ...\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 20160530050508\n\u2502\u00a0\u00a0     ...\n\u2514\u2500\u2500 shared\n    \u251c\u2500\u2500 cache\n    \u251c\u2500\u2500 logs\n    \u2514\u2500\u2500 tmp\n```\n\n### current\n\n`current` \u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306f\u3001\u30b7\u30f3\u30dc\u30ea\u30c3\u30af\u30ea\u30f3\u30af\u3068\u306a\u3063\u3066\u304a\u308a\u3001`releases` \u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u4ee5\u4e0b\u306b\u4f5c\u6210\u3055\u308c\u305f\u7279\u5b9a\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u6307\u3057\u307e\u3059\u3002\u30a6\u30a7\u30d6\u30b5\u30fc\u30d0\u3084\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30b5\u30fc\u30d0\u306e\u8a2d\u5b9a\u3067\u306f\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u30eb\u30fc\u30c8\u306b\u3053\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u6307\u3059\u3088\u3046\u306b\u3057\u307e\u3059\u3002\n\n### releases\n\n`releases` \u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306b\u306f\u3001\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30b3\u30fc\u30c9\u3092\u683c\u7d0d\u3057\u307e\u3059\u3002\u30c7\u30d7\u30ed\u30a4\u3054\u3068\u306b\u73fe\u5728\u65e5\u6642 ( timestamp ) \u3092\u540d\u524d\u3068\u3059\u308b\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u4f5c\u6210\u3057\u3001\u305d\u306e\u4e2d\u306b\u30b3\u30fc\u30c9\u3092\u683c\u7d0d\u3057\u307e\u3059\u3002\u904e\u53bb\u306e\u30c7\u30d7\u30ed\u30a4\u306b\u3088\u308b\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u4fdd\u6301\u3057\u3066\u3044\u308b\u306e\u3067\u3001`current` \u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306e\u30ea\u30f3\u30af\u5148\u3092\u5909\u3048\u308b\u3053\u3068\u3067\u7570\u306a\u308b\u30d0\u30fc\u30b8\u30e7\u30f3\u306e\u30b3\u30fc\u30c9\u3092\u52d5\u304b\u3059\u3053\u3068\u304c\u51fa\u6765\u307e\u3059\u3002 `ansistrano_shared_paths` \u30d1\u30e9\u30e1\u30fc\u30bf\u306e\u6570\u3092\u8d85\u3048\u305f\u3082\u306e\u306f\u53e4\u3044\u3082\u306e\u304b\u3089\u524a\u9664\u3055\u308c\u3066\u3044\u304d\u307e\u3059\u3002\n\n### shared\n\n`shared` \u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306b\u306f\u3001`releases` \u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u4ee5\u4e0b\u306b\u4f5c\u6210\u3055\u308c\u305f\u5404\u30d0\u30fc\u30b8\u30e7\u30f3\u306e\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30b3\u30fc\u30c9\u304c\u5229\u7528\u3059\u308b\u30d5\u30a1\u30a4\u30eb\u3084\u30c7\u30a3\u30ec\u30af\u30c8\u30ea ( \u30bb\u30c3\u30b7\u30e7\u30f3\u3084\u30ad\u30e3\u30c3\u30b7\u30e5\u3001\u30ed\u30b0\u306a\u3069 ) \u3092\u683c\u7d0d\u3057\u307e\u3059\u3002\u5404\u30d0\u30fc\u30b8\u30e7\u30f3\u306e\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30b3\u30fc\u30c9\u304c\u5229\u7528\u3059\u308b\u30d5\u30a1\u30a4\u30eb\u3084\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306e\u30b7\u30f3\u30dc\u30ea\u30c3\u30af\u30ea\u30f3\u30af\u304c `shared` \u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u4ee5\u4e0b\u306e\u30d5\u30a1\u30a4\u30eb\u3084\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u6307\u3059\u3088\u3046\u306b\u3057\u540c\u3058\u5185\u5bb9\u304c\u53c2\u7167\u3067\u304d\u308b\u3088\u3046\u306b\u3057\u3066\u3044\u307e\u3059\u3002\n\n## \u30ed\u30fc\u30eb\u5909\u6570\n\n```yaml:vars\n- vars:\n  ansistrano_deploy_from: \"{{ playbook_dir }}\" # Where my local project is (relative or absolute path)\n  ansistrano_deploy_to: \"/var/www/my-app\" # Base path to deploy to.\n  ansistrano_version_dir: \"releases\" # Releases folder name\n  ansistrano_current_dir: \"current\" # Softlink name. You should rarely changed it.\n  ansistrano_current_via: \"symlink\" # Deployment strategy who code should be deployed to current path. Options are symlink or rsync\n  ansistrano_shared_paths: [] # Shared paths to symlink to release dir\n  ansistrano_keep_releases: 0 # Releases to keep after a new deployment. See \"Pruning old releases\".\n  ansistrano_deploy_via: \"rsync\" # Method used to deliver the code to the server. Options are copy, rsync, git, s3 or download.\n  ansistrano_allow_anonymous_stats: yes\n\n  # Variables used in the rsync deployment strategy\n  ansistrano_rsync_extra_params: \"\" # Extra parameters to use when deploying with rsync in a single string. Although Ansible allows an array this can cause problems if we try to add multiple --include args as it was reported in https://github.com/ansistrano/deploy/commit/e98942dc969d4e620313f00f003a7ea2eab67e86\n  ansistrano_rsync_set_remote_user: yes # See [ansible synchronize module](http://docs.ansible.com/ansible/synchronize_module.html). Options are yes, no.\n\n  # Variables used in the Git deployment strategy\n  ansistrano_git_repo: git@github.com:USERNAME/REPO.git # Location of the git repository\n  ansistrano_git_branch: master # What version of the repository to check out. This can be the full 40-character SHA-1 hash, the literal string HEAD, a branch name, or a tag name\n  ansistrano_git_identity_key_path: \"\" # If specified this file is copied over and used as the identity key for the git commands, path is relative to the playbook in which it is used\n\n  # Variables used in the download deployment strategy\n  ansistrano_get_url: https://github.com/someproject/somearchive.tar.gz\n\n  # Variables used in the S3 deployment strategy\n  ansistrano_s3_bucket: s3bucket\n  ansistrano_s3_object: s3object.tgz # Add the _unarchive suffix to the ansistrano_deploy_via if your object is a package (ie: s3_unarchive)\n  ansistrano_s3_region: eu-west-1\n  # Optional variables, omitted by default\n  ansistrano_s3_aws_access_key: YOUR_AWS_ACCESS_KEY\n  ansistrano_s3_aws_secret_key: YOUR_AWS_SECRET_KEY\n\n  # Hooks: custom tasks if you need them\n  ansistrano_before_setup_tasks_file: \"{{ playbook_dir }}/<your-deployment-config>/my-before-setup-tasks.yml\"\n  ansistrano_after_setup_tasks_file: \"{{ playbook_dir }}/<your-deployment-config>/my-after-setup-tasks.yml\"\n  ansistrano_before_update_code_tasks_file: \"{{ playbook_dir }}/<your-deployment-config>/my-before-update-code-tasks.yml\"\n  ansistrano_after_update_code_tasks_file: \"{{ playbook_dir }}/<your-deployment-config>/my-after-update-code-tasks.yml\"\n  ansistrano_before_symlink_shared_tasks_file: \"{{ playbook_dir }}/<your-deployment-config>/my-before-symlink-shared-tasks.yml\"\n  ansistrano_after_symlink_shared_tasks_file: \"{{ playbook_dir }}/<your-deployment-config>/my-after-symlink-shared-tasks.yml\"\n  ansistrano_before_symlink_tasks_file: \"{{ playbook_dir }}/<your-deployment-config>/my-before-symlink-tasks.yml\"\n  ansistrano_after_symlink_tasks_file: \"{{ playbook_dir }}/<your-deployment-config>/my-after-symlink-tasks.yml\"\n  ansistrano_before_cleanup_tasks_file: \"{{ playbook_dir }}/<your-deployment-config>/my-before-cleanup-tasks.yml\"\n  ansistrano_after_cleanup_tasks_file: \"{{ playbook_dir }}/<your-deployment-config>/my-after-cleanup-tasks.yml\"\n```\n\n| \u5909\u6570                                    | \u610f\u5473                                                                |\n|:----------------------------------------|:--------------------------------------------------------------------|\n| `ansistrano_deploy_from`  | ansistrano_deploy_via \u304c copy \u307e\u305f\u306f rsync \u306e\u5834\u5408\u306e\u3001\u30ed\u30fc\u30ab\u30eb\u4e0a\u306e\u30c7\u30d7\u30ed\u30a4\u5143\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30b3\u30fc\u30c9\u306e\u30d1\u30b9\u3002 |\n| `ansistrano_deploy_to` | \u30ea\u30e2\u30fc\u30c8\u30b5\u30fc\u30d0\u4e0a\u306e\u30c7\u30d7\u30ed\u30a4\u5148\u306e\u30d1\u30b9\u3002 |\n| `ansistrano_shared_paths`   | releases \u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u4ee5\u4e0b\u306b\u4fdd\u6301\u3059\u308b\u4e16\u4ee3\u6570\u3002 |\n| `ansistrano_deploy_via`      | \u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30b3\u30fc\u30c9\u306e\u30c7\u30d7\u30ed\u30a4\u65b9\u6cd5\u3002copy, rsync, git, s3, s3_unarchive, unarchive \u304b\u3089\u6307\u5b9a\u3002 |\n| `ansistrano_allow_anonymous_stats` | Ansistrano \u306e\u30b5\u30a4\u30c8\u306b\u5229\u7528\u72b6\u6cc1\u3092\u9001\u4fe1\u3059\u308b\u304b\u5426\u304b\u3002 |\n| `ansistrano_git_repo`      | \u30b3\u30fc\u30c9\u3092\u53d6\u5f97\u3059\u308bGit\u30ea\u30dd\u30b8\u30c8\u30ea\u3002 |\n| `ansistrano_git_branch`      | \u30b3\u30fc\u30c9\u3092\u53d6\u5f97\u3059\u308b\u30d6\u30e9\u30f3\u30c1\u3002 |\n| `ansistrano_git_identity_key_path` | \u30ea\u30e2\u30fc\u30c8\u30b5\u30fc\u30d0\u30fc\u4e0a\u306b\u3042\u308b Git \u30ea\u30dd\u30b8\u30c8\u30ea\u3078\u306e ssh \u63a5\u7d9a\u306b\u5229\u7528\u3059\u308b\u79d8\u5bc6\u9375\u306e\u30d1\u30b9\u3002 |\n\n## \u30e1\u30a4\u30f3\u30ef\u30fc\u30af\u30d5\u30ed\u30fc\n\nAnsistrano \u306f\u30c7\u30d7\u30ed\u30a4\u306b\u304a\u3044\u3066 Capistrano \u306e\u30d5\u30ed\u30fc\u3092\u30d5\u30a9\u30ed\u30fc\u3057\u3066\u3044\u307e\u3059\u3002  \n\u4ee5\u4e0b\u30c0\u30a4\u30a2\u30b0\u30e9\u30e0\u306e\u7070\u8272\u7b87\u6240\u304c\u30e1\u30a4\u30f3\u30ef\u30fc\u30af\u30d5\u30ed\u30fc\u306e\u5404\u30b9\u30c6\u30c3\u30d7\u3067\u3001\u9ec4\u8272\u7b87\u6240\u304c\u5404\u30b9\u30c6\u30c3\u30d7\u306e\u524d\u5f8c\u306b\u5b9f\u884c\u3055\u308c\u308b\u30ab\u30b9\u30bf\u30e0\u30bf\u30b9\u30af\u306e\u30d5\u30c3\u30af\u30dd\u30a4\u30f3\u30c8\u3067\u3059\u3002\n\n![Ansistrano \u30d5\u30ed\u30fc](https://raw.githubusercontent.com/ansistrano/deploy/master/docs/ansistrano-flow.png \"Ansistrano \u30d5\u30ed\u30fc\")\n\n### \u30b9\u30c6\u30c3\u30d7\n\n\u30e1\u30a4\u30f3\u30ef\u30fc\u30af\u30d5\u30ed\u30fc\u306e\u30d5\u30a7\u30fc\u30ba\u306f\u4ee5\u4e0b\u306e 5 \u30b9\u30c6\u30c3\u30d7\u3067\u69cb\u6210\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n\n| \u30b9\u30c6\u30c3\u30d7       | \u610f\u5473                                                                                           |\n|:--------------|:-----------------------------------------------------------------------------------------------|\n| `Setup`       | `releases` \u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u4ee5\u4e0b\u306b\u73fe\u5728\u65e5\u6642 ( timestamp ) \u3092\u540d\u524d\u3068\u3059\u308b\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002              |\n| `Update Code` | `Setup` \u30b9\u30c6\u30c3\u30d7 \u3067\u4f5c\u6210\u3057\u305f\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306b\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30b3\u30fc\u30c9\u3092\u8a2d\u7f6e\u3057\u307e\u3059\u3002    |\n| `Symlink Shared` | `ansistrano_shared_paths` \u30d1\u30e9\u30e1\u30fc\u30bf\u306b\u57fa\u3065\u3044\u3066\u3001\u30b7\u30f3\u30dc\u30ea\u30c3\u30af\u30ea\u30f3\u30af\u304c `shared` \u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u4ee5\u4e0b\u306e\u30d5\u30a1\u30a4\u30eb\u3084\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u6307\u3059\u3088\u3046\u306b\u3057\u307e\u3059\u3002 |\n| `Symlink`     | `current` \u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306e\u30b7\u30f3\u30dc\u30ea\u30c3\u30af\u30ea\u30f3\u30af\u304c `Setup` \u30b9\u30c6\u30c3\u30d7 \u3067\u4f5c\u6210\u3057\u305f\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u6307\u3059\u3088\u3046\u306b\u5909\u66f4\u3057\u307e\u3059\u3002 |\n| `Cleanup`     | `ansistrano_keep_releases` \u30d1\u30e9\u30e1\u30fc\u30bf\u306b\u57fa\u3065\u3044\u3066\u3001\u4efb\u610f\u306e\u53e4\u3044\u30d0\u30fc\u30b8\u30e7\u30f3\u3092\u524a\u9664\u3057\u307e\u3059\u3002                    |\n\n### \u30ab\u30b9\u30bf\u30e0\u30bf\u30b9\u30af\u306e\u30d5\u30c3\u30af\n\n`ansistrano_before_*_tasks_file` \u3068 `ansistrano_after_*_tasks_file` \u30d1\u30e9\u30e1\u30fc\u30bf\u306b\u3001\u5404\u30b9\u30c6\u30c3\u30d7\u306e\u524d\u5f8c\u306b\u30ab\u30b9\u30bf\u30e0\u30bf\u30b9\u30af\u30d5\u30a1\u30a4\u30eb\u3092\u6307\u5b9a\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002  \n\u4efb\u610f\u306e\u30d5\u30c3\u30af\u30dd\u30a4\u30f3\u30c8\u3067\u4efb\u610f\u306e\u30bf\u30b9\u30af\u3092\u5b9f\u884c\u3059\u308b\u3053\u3068\u304c\u53ef\u80fd\u3067\u3059\u3002\n\n```yaml:vars\n# Hooks: custom tasks if you need them\nansistrano_before_setup_tasks_file: \"{{ playbook_dir }}/<your-deployment-config>/my-before-setup-tasks.yml\"\nansistrano_after_setup_tasks_file: \"{{ playbook_dir }}/<your-deployment-config>/my-after-setup-tasks.yml\"\nansistrano_before_update_code_tasks_file: \"{{ playbook_dir }}/<your-deployment-config>/my-before-update-code-tasks.yml\"\nansistrano_after_update_code_tasks_file: \"{{ playbook_dir }}/<your-deployment-config>/my-after-update-code-tasks.yml\"\nansistrano_before_symlink_shared_tasks_file: \"{{ playbook_dir }}/<your-deployment-config>/my-before-symlink-shared-tasks.yml\"\nansistrano_after_symlink_shared_tasks_file: \"{{ playbook_dir }}/<your-deployment-config>/my-after-symlink-shared-tasks.yml\"\nansistrano_before_symlink_tasks_file: \"{{ playbook_dir }}/<your-deployment-config>/my-before-symlink-tasks.yml\"\nansistrano_after_symlink_tasks_file: \"{{ playbook_dir }}/<your-deployment-config>/my-after-symlink-tasks.yml\"\nansistrano_before_cleanup_tasks_file: \"{{ playbook_dir }}/<your-deployment-config>/my-before-cleanup-tasks.yml\"\nansistrano_after_cleanup_tasks_file: \"{{ playbook_dir }}/<your-deployment-config>/my-after-cleanup-tasks.yml\"\n```\n\n## Ansistrano \u306e\u4f7f\u3044\u65b9\n\n### \u30c7\u30d7\u30ed\u30a4\n\n#### playbook \u306e\u6e96\u5099\n\n\u30c7\u30d7\u30ed\u30a4\u3059\u308b\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306f PHP \u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3092\u60f3\u5b9a\u3057\u3066\u3044\u307e\u3059\u3002\n\n```tree:playbook\n.\n\u251c\u2500\u2500 deploy.yml\n\u251c\u2500\u2500 group_vars\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 all.yml\n\u251c\u2500\u2500 hosts\n\u2514\u2500\u2500 roles\n    \u2514\u2500\u2500 hooks\n        \u2514\u2500\u2500 tasks\n            \u251c\u2500\u2500 after_update_code.yml\n            \u251c\u2500\u2500 before_symlink_shared.yml\n            \u2514\u2500\u2500 after_symlink.yml\n```\n\n##### hosts \u30d5\u30a1\u30a4\u30eb\n\n```file:hosts\nwww.example.com\n```\n\n##### vars \u30d5\u30a1\u30a4\u30eb\n\n`group_vars` \u3067\u5909\u6570\u3092\u5b9a\u7fa9\u3057\u3066\u3044\u307e\u3059\u304c\u3001\u5225\u306e\u5834\u6240\u3067\u5b9a\u7fa9\u3057\u3066\u3082\u554f\u984c\u3042\u308a\u307e\u305b\u3093\u3002\n\n```yaml:group_vars/all.yml\n---\nansistrano_deploy_to: /var/www/app\nansistrano_shared_paths:\n  - cache\n  - logs\n  - tmp\nansistrano_allow_anonymous_stats: no\nansistrano_keep_releases: 5\nansistrano_deploy_via: git\nansistrano_git_repo: git@github.com:USERNAME/REPO.git\nansistrano_git_branch: master\nansistrano_after_update_code_tasks_file: \"{{ playbook_dir }}/roles/hooks/task/after_update_code.yml\"\nansistrano_after_update_code_tasks_file: \"{{ playbook_dir }}/roles/hooks/tasks/before_symlink_shared.yml\"\nansistrano_after_symlink_tasks_file: \"{{ playbook_dir }}/roles/hooks/task/after_symlink.yml\"\n```\n\n##### playbook\n\n[Ansistrano\u3067node.js\u306e\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b - Qiita](http://qiita.com/NewGyu/items/4ad49976ffc5f6f60f5d \"Ansistrano\u3067node.js\u306e\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b - Qiita\")\n\n> `ansistrano_deploy_via` \u306b\u3064\u3044\u3066\u306f Ansistrano \u306e\u4e2d\u3067 include \u3092\u4f7f\u3063\u305f\u30c8\u30ea\u30c3\u30af\u304c\u4f7f\u308f\u308c\u3066\u3044\u308b\u306e\u3067vars_files\u3067\u306f\u3046\u307e\u304f\u884c\u304d\u307e\u305b\u3093\u3067\u3057\u305f\u3002\n\n\u306e\u901a\u308a\u3001 vars_files \u3084 group_vars \u3067 `ansistrano_deploy_via` \u3092\u5b9a\u7fa9\u3059\u308b\u3068\u3001\u30d1\u30e9\u30e1\u30fc\u30bf\u95a2\u4fc2\u306a\u3057\u306b rsync \u3067\u5b9f\u884c\u3055\u308c\u3066\u3057\u307e\u3044\u307e\u3059\u3002\u305d\u306e\u305f\u3081\u30c8\u30c3\u30d7\u30ec\u30d9\u30eb YAML \u306e vars \u3067\u5b9a\u7fa9\u3057\u3066\u3044\u307e\u3059\u3002\n\n```yaml:deploy.yml\n---\n- hosts: all\n  become: yes\n  become_user: www-data\n  vars:\n    ansistrano_deploy_via: git\n  roles:\n    - carlosbuenosvinos.ansistrano-deploy\n```\n\n##### \u30d5\u30c3\u30af\u3067\u5b9f\u884c\u3055\u308c\u308b\u30ab\u30b9\u30bf\u30e0\u30bf\u30b9\u30af\n\n`Update Code` \u30b9\u30c6\u30c3\u30d7\u306e\u5f8c\u3067\u5b9f\u884c\u3055\u308c\u308b\u30ab\u30b9\u30bf\u30e0\u30bf\u30b9\u30af\u3002\n\n```yaml:roles/hooks/tasks/after_update_code.yml\n---\n- name: ANSISTRANO | HOOKS | Whether or not the composer is present\n  stat: path=/usr/bin/composer\n  register: is_composer\n\n- name: ANSISTRANO | HOOKS | Install composer\n  shell: curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/bin --filename=composer creates=/usr/bin/composer\n  become_user: root\n  when: not is_composer.stat.exists\n\n- name: ANSISTRANO | HOOKS | Update composer\n  become: yes\n  become_user: root\n  composer:\n    command=install\n    working_dir={{ ansistrano_release_path.stdout }}\n```\n\n`Symlink` \u30b9\u30c6\u30c3\u30d7\u306e\u524d\u3067\u5b9f\u884c\u3055\u308c\u308b\u30ab\u30b9\u30bf\u30e0\u30bf\u30b9\u30af\u3002\n\n```yaml:roles/hooks/tasks/before_symlink_shared\n---\n- name: ANSISTRANO | HOOKS | Create shared paths\n  file: state=directory path={{ ansistrano_deploy_to }}/shared/{{ item }} mode=0777\n  with_items: ansistrano_shared_paths\n```\n\n`Symlink` \u30b9\u30c6\u30c3\u30d7\u306e\u5f8c\u3067\u5b9f\u884c\u3055\u308c\u308b\u30ab\u30b9\u30bf\u30e0\u30bf\u30b9\u30af\u3002\n\n```yaml:roles/hooks/tasks/after_symlink.yml\n---\n- name: ANSISTRANO | HOOKS | Restart nginx\n  service: name=nginx state=restarted\n  become: yes\n  become_user: root\n```\n\n\u30ab\u30b9\u30bf\u30e0\u30bf\u30b9\u30af\u306e\u30d5\u30a1\u30a4\u30eb\u3092\u8a18\u8ff0\u3059\u308b\u5834\u5408\u306f\u3001\u5fc5\u8981\u3068\u3055\u308c\u308b\u3044\u304f\u3064\u304b\u306e\u5909\u6570\u3092\u4f7f\u3046\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\n| \u5909\u6570                                    | \u610f\u5473                                                                |\n|:----------------------------------------|:--------------------------------------------------------------------|\n| `{{ ansistrano_release_path.stdout }}`  | `current` \u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306e\u30ea\u30f3\u30af\u5148\u306e\u30d1\u30b9 |\n| `{{ ansistrano_releases_path.stdout }}` | `releases` \u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3078\u306e\u30d1\u30b9                                     |\n| `{{ ansistrano_shared_path.stdout }}`   | `shared` \u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3078\u306e\u30d1\u30b9                                       |\n| `{{ ansistrano_release_version }}`      | `current` \u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306e\u30ea\u30f3\u30af\u5148\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u540d ( timestamp ) |\n\n#### \u5b9f\u884c\n\n```\nansible-playbook -i hosts deploy.yml\n```\n\n\u5168\u3066\u304c\u6b63\u3057\u304f\u8a2d\u5b9a\u3055\u308c\u3066\u3044\u308b\u5834\u5408\u3001\u3053\u306e\u30b3\u30de\u30f3\u30c9\u306f\u3001\u30b5\u30fc\u30d0\u30fc\u5074\u3067\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u69cb\u9020\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n```tree:/var/www/app\n.\n\u251c\u2500\u2500 current -> ./releases/20160530055905\n\u251c\u2500\u2500 releases\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 20160530055905\n\u2502\u00a0\u00a0 \u2502   \u251c\u2500\u2500 cache -> ../../shared/cache\n\u2502\u00a0\u00a0 \u2502   \u251c\u2500\u2500 logs -> ../../shared/logs\n\u2502\u00a0\u00a0 \u2502   \u251c\u2500\u2500 tmp -> ../../shared/tmp\n\u2502\u00a0\u00a0 \u2502   ...\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 20160530055658\n\u2502\u00a0\u00a0 \u2502   ...\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 20160530050508\n\u2502\u00a0\u00a0     ...\n\u2514\u2500\u2500 shared\n    \u251c\u2500\u2500 cache\n    \u251c\u2500\u2500 logs\n    \u2514\u2500\u2500 tmp\n```\n\n### \u8907\u6570\u306e\u30b5\u30fc\u30d0\u30fc\u306b\u30c7\u30d7\u30ed\u30a4\n\n\u5404\u30b5\u30fc\u30d0\u30fc\u306e `releases` \u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u4ee5\u4e0b\u306b\u7570\u306a\u308b timestamp \u3067\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u304c\u4f5c\u6210\u3055\u308c\u308b\u3053\u3068\u3092\u9632\u6b62\u3059\u308b\u305f\u3081\u306b `serial` \u30aa\u30d7\u30b7\u30e7\u30f3\u3092\u4f7f\u7528\u3057\u307e\u3059\u3002 `serial` \u30aa\u30d7\u30b7\u30e7\u30f3\u306b\u306f `ansistrano_release_version` \u3092\u8a2d\u5b9a\u3057\u5b9f\u884c\u3057\u307e\u3059\u3002\n\n```\n$ ansible-playbook -i hosts -e \"ansistrano_release_version=`date -u +%Y%m%d%H%M%S`\" deploy.yml\n```\n\n\n### \u591a\u6bb5\u74b0\u5883\u306e\u30c7\u30d7\u30ed\u30a4\n\ndevelopment \u3001staging \u3084 production \u306a\u3069\u306e\u3088\u3046\u306a\u69d8\u3005\u306a\u74b0\u5883\u306b\u30c7\u30d7\u30ed\u30a4\u3059\u308b\u5834\u5408\u306f\u3001\u7570\u306a\u308b\u30a4\u30f3\u30d9\u30f3\u30c8\u30ea\u30fc\u30d5\u30a1\u30a4\u30eb\u3068\u5909\u6570\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\u4f5c\u6210\u3057\u305f\u3089\u3001 \u30c7\u30d7\u30ed\u30a4\u3057\u305f\u3044\u74b0\u5883\u306e\u30a4\u30f3\u30d9\u30c8\u30ea\u30fc\u30d5\u30a1\u30a4\u30eb\u3092 `-i` \u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u4f7f\u3063\u3066\u6307\u5b9a\u3057\u5b9f\u884c\u3057\u307e\u3059\u3002\u3000\n\n#### playbook \u306e\u6e96\u5099\n\nstaging \u3068 production \u74b0\u5883\u306e\u5834\u5408\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\n\n```tree:playbook\n.\n\u251c\u2500\u2500 production         # inventory file for production servers\n\u251c\u2500\u2500 staging            # inventory file for staging environment\n\u251c\u2500\u2500 group_vars\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 all.yml\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 production.yml # variables file for production groups\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 staging.yml    # variables file for staging groups\n\u251c\u2500\u2500 deploy.yml\n\u2514\u2500\u2500 roles\n \u00a0\u00a0 \u2514\u2500\u2500 hooks\n \u00a0\u00a0     \u2514\u2500\u2500 tasks\n \u00a0\u00a0         \u251c\u2500\u2500 after_symlink.yml\n \u00a0\u00a0         \u251c\u2500\u2500 after_update_code.yml\n \u00a0\u00a0         \u2514\u2500\u2500 before_symlink_shared.yml\n```\n\n##### hosts \u30d5\u30a1\u30a4\u30eb\n\n```file:production\n[production]\nprod.example.com\n```\n\n```file:staging\n[staging]\nstg.example.com\n```\n\n##### vars \u30d5\u30a1\u30a4\u30eb\n\n`group_vars/production.yml` \u3068 `group_vars/staging.yml` \u3092\u4f5c\u6210\u3057\u3001\u305d\u308c\u305e\u308c\u74b0\u5883\u3054\u3068\u306b Ansistrano \u306e\u30ed\u30fc\u30eb\u5909\u6570\u3084\u30e6\u30fc\u30b6\u30fc\u3084\u30d1\u30b9\u30ef\u30fc\u30c9\u7b49\u306e\u5909\u6570\u3092\u5b9a\u7fa9\u3057\u307e\u3059\u3002\n\n#### \u5b9f\u884c\n\n```production\nansible-playbook -i production deploy.yml\n```\n\n```staging\nansible-playbook -i staging deploy.yml\n```\n\n### \u30ed\u30fc\u30eb\u30d0\u30c3\u30af\n\n#### \u30ed\u30fc\u30eb\u5909\u6570\n\n\u30c7\u30d7\u30ed\u30a4\u306e\u30ed\u30fc\u30eb\u5909\u6570\u306b\u6bd4\u3079\u3066\u30ed\u30fc\u30eb\u30d0\u30c3\u30af\u306e\u30ed\u30fc\u30eb\u5909\u6570\u306f\u5c11\u306a\u3044\u3067\u3059\u3002\n\n```yaml:vars\n- vars:\n  ansistrano_deploy_to: \"/var/www/my-app\" # Base path to deploy to.\n  ansistrano_version_dir: \"releases\" # Releases folder name\n  ansistrano_current_dir: \"current\" # Softlink name. You should rarely changed it.\n  ansistrano_remove_rolled_back: yes # Remove rolled back release?\n  ansistrano_allow_anonymous_stats: yes\n\n  # Hooks: custom tasks if you need them\n  ansistrano_before_symlink_tasks_file: \"{{ playbook_dir }}/<your-deployment-config>/my-before-symlink-tasks.yml\"\n  ansistrano_after_symlink_tasks_file: \"{{ playbook_dir }}/<your-deployment-config>/my-after-symlink-tasks.yml\"\n  ansistrano_before_cleanup_tasks_file: \"{{ playbook_dir }}/<your-deployment-config>/my-before-cleanup-tasks.yml\"\n  ansistrano_after_cleanup_tasks_file: \"{{ playbook_dir }}/<your-deployment-config>/my-after-cleanup-tasks.yml\"\n```\n\n#### \u5b9f\u884c\n\n```\nansible-playbook -i hosts rollback.yml\n```\n\n\u203b `releases` \u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u4ee5\u4e0b\u306b\u4f5c\u6210\u3055\u308c\u305f\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30b3\u30fc\u30c9\u304c 0 \u307e\u305f\u306f 1 \u3064\u3060\u3063\u305f\u5834\u5408\u3001\u30ed\u30fc\u30eb\u30d0\u30c3\u30af\u3057\u3088\u3046\u3068\u3059\u308b\u3068\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3057\u5b9f\u884c\u3055\u308c\u307e\u305b\u3093\u3002\n\n## \u6ce8\u610f\u70b9\n\n* [OPcache \u304c\u6709\u52b9\u3067\u4e14\u3064 PHP-FPM \u3092\u4f7f\u7528\u3057\u305f \u30a6\u30a7\u30d6\u30b5\u30fc\u30d0\u3067\u3001Symlink \u30d9\u30fc\u30b9\u306e\u30c7\u30d7\u30ed\u30a4\u3059\u308b\u3068\u30b3\u30fc\u30c9\u304c\u53cd\u6620\u3055\u308c\u306a\u3044 - Qiita](http://qiita.com/kotarella1110/items/726004497d3605441fb6 \"OPcache \u304c\u6709\u52b9\u3067\u4e14\u3064 PHP-FPM \u3092\u4f7f\u7528\u3057\u305f \u30a6\u30a7\u30d6\u30b5\u30fc\u30d0\u3067\u3001Symlink \u30d9\u30fc\u30b9\u306e\u30c7\u30d7\u30ed\u30a4\u3059\u308b\u3068\u30b3\u30fc\u30c9\u304c\u53cd\u6620\u3055\u308c\u306a\u3044 - Qiita\")\n\n## \u53c2\u8003\u6587\u732e\n\n* [ansistrano/deploy: Ansible role to deploy scripting applications like PHP, Python, Ruby, etc. in a capistrano style](https://github.com/ansistrano/deploy \"ansistrano/deploy: Ansible role to deploy scripting applications like PHP, Python, Ruby, etc. in a capistrano style\")\n* [Ansistrano\u3067node.js\u306e\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b - Qiita](http://qiita.com/NewGyu/items/4ad49976ffc5f6f60f5d \"Ansistrano\u3067node.js\u306e\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b - Qiita\")\n", "tags": ["Ansistrano", "Ansible", "capistrano", "\u30c7\u30d7\u30ed\u30a4"]}