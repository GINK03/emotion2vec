{"context": " More than 1 year has passed since last update.\n\n\u74b0\u5883\nCentos6.7\nVarnish 4\n\ninstall\nwget http://dl.fedoraproject.org/pub/epel/6/x86_64/jemalloc-3.6.0-1.el6.x86_64.rpm\nrpm -ivh jemalloc-3.6.0-1.el6.x86_64.rpm\nrpm --nosignature -i https://repo.varnish-cache.org/redhat/varnish-4.0.el6.rpm\nyum install varnish\n\n\n\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\n\n/etc/varnish/default.vcl\n\u30ad\u30e3\u30c3\u30b7\u30e5\u306e\u30eb\u30fc\u30eb\u3092\u8a18\u8ff0\u5f97\u3059\u308b\u30d5\u30a1\u30a4\u30eb\n\ncat /etc/sysconfig/varnish\nVarnish\u3092\u8d77\u52d5\u3059\u308bport\u3068\u304b\u8a18\u8ff0\u3059\u308b\u30d5\u30a1\u30a4\u30eb\n\n\u30ad\u30e3\u30c3\u30b7\u30e5\u30eb\u30fc\u30eb\u306e\u30b5\u30f3\u30d7\u30eb\n\n/etc/varnish/default.vcl\n\nvcl 4.0;\n\n# \u30ad\u30e3\u30c3\u30b7\u30e5\u30af\u30ea\u30a2\u7528\u306e\u30ea\u30af\u30a8\u30b9\u30c8\u3092\u53d7\u3051\u4ed8\u3051\u308bip\u3092\u5217\u6319\n# *\u306e\u3068\u3053\u308d\u3092\u9069\u5f53\u306b\u74b0\u5883\u306b\u5408\u308f\u305b\u3066\nacl purge {\n \"localhost\";\n \"*.*.*.*\"/*;\n}\n\n# \u30d7\u30ed\u30ad\u30b7\u3059\u308b\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u30db\u30b9\u30c8\u3068\u30dd\u30fc\u30c8\nbackend default {\n    .host = \"127.0.0.1\";\n    .port = \"3000\";\n}\n\n# BAN\u30e1\u30bd\u30c3\u30c9\u3067\u30ea\u30af\u30a8\u30b9\u30c8\u3057\u305f\u969b\u306b\u3001URL\u3092\u6b63\u898f\u8868\u73fe\u306b\u30ad\u30e3\u30c3\u30b7\u30e5\u3092BAN\u30ea\u30b9\u30c8\u306b\u767b\u9332\u3059\u308b\u3053\u3068\u3067\u30ad\u30e3\u30c3\u30b7\u30e5\u30af\u30ea\u30a2\u3067\u304d\u308b\u3088\u3046\u306b\u3059\u308b\nsub vcl_recv {\n if (req.method == \"BAN\") {\n   if (!client.ip ~ purge) {\n     return(synth(405,\"Not allowed.\"));\n   }\n   ban(\"req.http.host == \" + req.http.host + \" && req.url ~ \" + req.url);\n   return(synth(200, \"Ban added\"));\n }\n}\n\n# \u30ea\u30af\u30a8\u30b9\u30c8\u3092\u30ad\u30e3\u30c3\u30b7\u30e5\u3059\u308b\u969b\u306e\u30cf\u30c3\u30b7\u30e5\u3092\u751f\u6210\u3059\u308b\u3002\n# \u4eca\u56de\u306fURL\u3068HTTP\u30ea\u30af\u30a8\u30b9\u30c8\u30d8\u30c3\u30c0\u30fc\u300eX-Cache-Key\u300f\u3092\u3082\u3068\u306b\u30ad\u30e3\u30c3\u30b7\u30e5\u30ad\u30fc\u3092\u767a\u884c\u3059\u308b\nsub vcl_hash {\n  hash_data(req.url);\n  hash_data(req.http.X-Cache-Key);\n}\n\n# \u30ad\u30e3\u30c3\u30b7\u30e5\u306ettl\u3092\u9069\u5f53\u306a\u6642\u9593\u3067\u8a2d\u5b9a\u3059\u308b\n# \u30ec\u30b9\u30dd\u30f3\u30b9\u30d8\u30c3\u30c0\u30fc\u300eX-No-Cache\u300f\u304c\u8a2d\u5b9a\u3055\u308c\u3066\u3044\u308b\u5834\u5408\u306f\u30ad\u30e3\u30c3\u30b7\u30e5\u3055\u305b\u306a\u3044\u3088\u3046\u306b\u3059\u308b\nsub vcl_backend_response {\n    set beresp.ttl = 3600s;\n    if (beresp.http.X-No-Cache) {\n        set beresp.uncacheable = true;\n        return (deliver);\n    }\n}\n\n# \u30ad\u30e3\u30c3\u30b7\u30e5\u306b\u30d2\u30c3\u30c8\u3057\u305f\u304b\u5426\u304b\u3092\u30ec\u30b9\u30dd\u30f3\u30b9\u30d8\u30c3\u30c0\u30fc\u306b\u542b\u3081\u308b\u3088\u3046\u306b\u3059\u308b\nsub vcl_deliver {\n if (obj.hits > 0) {\n  set resp.http.X-Cache = \"HIT\";\n } else {\n  set resp.http.X-Cache = \"MISS\";\n }\n}\n\n\n\n\n\u30b5\u30fc\u30d3\u30b9\u306e\u8d77\u52d5\u30fb\u505c\u6b62\u30fb\u518d\u8d77\u52d5\n/etc/init.d/varnish start\n/etc/init.d/varnish stop\n/etc/init.d/varnish restart\n\n\n\u52d5\u4f5c\u78ba\u8a8d\u30d7\u30ed\u30b0\u30e9\u30e0\n\n\u30b5\u30fc\u30d0\u30fc\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\n\nindex.js\nvar express = require('express');\nvar app = express();\n\napp.get('/', function (req, res) {\n  console.log('Hello World!');\n  res.send('Hello World!');\n});\napp.get('/a', function (req, res) {\n  console.log('Hello World!');\n  res.send('Hello World!');\n});\napp.get('/b', function (req, res) {\n  console.log('Hello World!');\n  res.send('Hello World!');\n});\napp.post('/', function (req, res) {\n  console.log('Hello World!');\n  res.send('Hello World!');\n});\napp.get('/no', function (req, res) {\n  console.log('Hello World!');\n  res.set({'X-No-Cache': 'true'});\n  res.send('Hello World!');\n});\n\napp.listen(3000, function () {\n  console.log('Example app listening on port 3000!');\n})\n\n\n\n\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\n# 2\u56de\u76ee\u4ee5\u964d\u306e\u30ea\u30af\u30a8\u30b9\u30c8\u306f\u30ad\u30e3\u30c3\u30b7\u30e5\u306b\u30d2\u30c3\u30c8\u3059\u308b\ncurl -H \"X-Cache-Key: hoge\" http://localhost -i\ncurl -H \"X-Cache-Key: hoge\" http://localhost -i\ncurl -H \"X-Cache-Key: hoge\" http://localhost -i\n\n# X-Cache-Key\u3092\u5225\u3005\u306b\u3057\u3066\u3044\u308b\u306e\u3067\u305d\u308c\u305e\u308c\u9055\u3046\u30ad\u30e3\u30c3\u30b7\u30e5\u30ad\u30fc\u3068\u3057\u3066\u6271\u308f\u308c\u308b\ncurl -H \"X-Cache-Key: hoge\" http://localhost -i\ncurl -H \"X-Cache-Key: fuga\" http://localhost -i\ncurl -H \"X-Cache-Key: piyo\" http://localhost -i\n\n# POST\u306f\u30ad\u30e3\u30c3\u30b7\u30e5\u3055\u308c\u306a\u3044\ncurl -X POST http://localhost -i\ncurl -X POST http://localhost -i\ncurl -X POST http://localhost -i\n\n# GET /no\u306f\u30ad\u30e3\u30c3\u30b7\u30e5\u3055\u308c\u306a\u3044\u3088\u3046\u306b\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u5074\u3067\u5236\u5fa1\u3055\u308c\u3066\u3044\u308b\ncurl http://localhost/no -i\ncurl http://localhost/no -i\ncurl http://localhost/no -i\n\n# BAN /* \u3067\u3059\u3079\u3066\u306e\u30ad\u30e3\u30c3\u30b7\u30e5\u3092\u524a\u9664\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u308b\ncurl        http://localhost/a -i\ncurl        http://localhost/b -i\ncurl -X BAN http://localhost/*\ncurl        http://localhost/a -i\ncurl        http://localhost/b -i\n\n\n# \u74b0\u5883\nCentos6.7\nVarnish 4\n\n# install\n\n```sh\nwget http://dl.fedoraproject.org/pub/epel/6/x86_64/jemalloc-3.6.0-1.el6.x86_64.rpm\nrpm -ivh jemalloc-3.6.0-1.el6.x86_64.rpm\nrpm --nosignature -i https://repo.varnish-cache.org/redhat/varnish-4.0.el6.rpm\nyum install varnish\n```\n\n# \u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\n\n## /etc/varnish/default.vcl\n\n\u30ad\u30e3\u30c3\u30b7\u30e5\u306e\u30eb\u30fc\u30eb\u3092\u8a18\u8ff0\u5f97\u3059\u308b\u30d5\u30a1\u30a4\u30eb\n\n## cat /etc/sysconfig/varnish\n\nVarnish\u3092\u8d77\u52d5\u3059\u308bport\u3068\u304b\u8a18\u8ff0\u3059\u308b\u30d5\u30a1\u30a4\u30eb\n\n## \u30ad\u30e3\u30c3\u30b7\u30e5\u30eb\u30fc\u30eb\u306e\u30b5\u30f3\u30d7\u30eb\n\n```vcl:/etc/varnish/default.vcl\n\nvcl 4.0;\n\n# \u30ad\u30e3\u30c3\u30b7\u30e5\u30af\u30ea\u30a2\u7528\u306e\u30ea\u30af\u30a8\u30b9\u30c8\u3092\u53d7\u3051\u4ed8\u3051\u308bip\u3092\u5217\u6319\n# *\u306e\u3068\u3053\u308d\u3092\u9069\u5f53\u306b\u74b0\u5883\u306b\u5408\u308f\u305b\u3066\nacl purge {\n \"localhost\";\n \"*.*.*.*\"/*;\n}\n\n# \u30d7\u30ed\u30ad\u30b7\u3059\u308b\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u30db\u30b9\u30c8\u3068\u30dd\u30fc\u30c8\nbackend default {\n    .host = \"127.0.0.1\";\n    .port = \"3000\";\n}\n\n# BAN\u30e1\u30bd\u30c3\u30c9\u3067\u30ea\u30af\u30a8\u30b9\u30c8\u3057\u305f\u969b\u306b\u3001URL\u3092\u6b63\u898f\u8868\u73fe\u306b\u30ad\u30e3\u30c3\u30b7\u30e5\u3092BAN\u30ea\u30b9\u30c8\u306b\u767b\u9332\u3059\u308b\u3053\u3068\u3067\u30ad\u30e3\u30c3\u30b7\u30e5\u30af\u30ea\u30a2\u3067\u304d\u308b\u3088\u3046\u306b\u3059\u308b\nsub vcl_recv {\n if (req.method == \"BAN\") {\n   if (!client.ip ~ purge) {\n     return(synth(405,\"Not allowed.\"));\n   }\n   ban(\"req.http.host == \" + req.http.host + \" && req.url ~ \" + req.url);\n   return(synth(200, \"Ban added\"));\n }\n}\n\n# \u30ea\u30af\u30a8\u30b9\u30c8\u3092\u30ad\u30e3\u30c3\u30b7\u30e5\u3059\u308b\u969b\u306e\u30cf\u30c3\u30b7\u30e5\u3092\u751f\u6210\u3059\u308b\u3002\n# \u4eca\u56de\u306fURL\u3068HTTP\u30ea\u30af\u30a8\u30b9\u30c8\u30d8\u30c3\u30c0\u30fc\u300eX-Cache-Key\u300f\u3092\u3082\u3068\u306b\u30ad\u30e3\u30c3\u30b7\u30e5\u30ad\u30fc\u3092\u767a\u884c\u3059\u308b\nsub vcl_hash {\n  hash_data(req.url);\n  hash_data(req.http.X-Cache-Key);\n}\n\n# \u30ad\u30e3\u30c3\u30b7\u30e5\u306ettl\u3092\u9069\u5f53\u306a\u6642\u9593\u3067\u8a2d\u5b9a\u3059\u308b\n# \u30ec\u30b9\u30dd\u30f3\u30b9\u30d8\u30c3\u30c0\u30fc\u300eX-No-Cache\u300f\u304c\u8a2d\u5b9a\u3055\u308c\u3066\u3044\u308b\u5834\u5408\u306f\u30ad\u30e3\u30c3\u30b7\u30e5\u3055\u305b\u306a\u3044\u3088\u3046\u306b\u3059\u308b\nsub vcl_backend_response {\n    set beresp.ttl = 3600s;\n    if (beresp.http.X-No-Cache) {\n        set beresp.uncacheable = true;\n        return (deliver);\n    }\n}\n\n# \u30ad\u30e3\u30c3\u30b7\u30e5\u306b\u30d2\u30c3\u30c8\u3057\u305f\u304b\u5426\u304b\u3092\u30ec\u30b9\u30dd\u30f3\u30b9\u30d8\u30c3\u30c0\u30fc\u306b\u542b\u3081\u308b\u3088\u3046\u306b\u3059\u308b\nsub vcl_deliver {\n if (obj.hits > 0) {\n  set resp.http.X-Cache = \"HIT\";\n } else {\n  set resp.http.X-Cache = \"MISS\";\n }\n}\n\n```\n\n# \u30b5\u30fc\u30d3\u30b9\u306e\u8d77\u52d5\u30fb\u505c\u6b62\u30fb\u518d\u8d77\u52d5\n\n```\n/etc/init.d/varnish start\n/etc/init.d/varnish stop\n/etc/init.d/varnish restart\n```\n\n# \u52d5\u4f5c\u78ba\u8a8d\u30d7\u30ed\u30b0\u30e9\u30e0\n\n## \u30b5\u30fc\u30d0\u30fc\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\n\n```js:index.js\nvar express = require('express');\nvar app = express();\n\napp.get('/', function (req, res) {\n  console.log('Hello World!');\n  res.send('Hello World!');\n});\napp.get('/a', function (req, res) {\n  console.log('Hello World!');\n  res.send('Hello World!');\n});\napp.get('/b', function (req, res) {\n  console.log('Hello World!');\n  res.send('Hello World!');\n});\napp.post('/', function (req, res) {\n  console.log('Hello World!');\n  res.send('Hello World!');\n});\napp.get('/no', function (req, res) {\n  console.log('Hello World!');\n  res.set({'X-No-Cache': 'true'});\n  res.send('Hello World!');\n});\n\napp.listen(3000, function () {\n  console.log('Example app listening on port 3000!');\n})\n```\n\n## \u30af\u30e9\u30a4\u30a2\u30f3\u30c8\n\n```sh\n# 2\u56de\u76ee\u4ee5\u964d\u306e\u30ea\u30af\u30a8\u30b9\u30c8\u306f\u30ad\u30e3\u30c3\u30b7\u30e5\u306b\u30d2\u30c3\u30c8\u3059\u308b\ncurl -H \"X-Cache-Key: hoge\" http://localhost -i\ncurl -H \"X-Cache-Key: hoge\" http://localhost -i\ncurl -H \"X-Cache-Key: hoge\" http://localhost -i\n```\n\n```sh\n# X-Cache-Key\u3092\u5225\u3005\u306b\u3057\u3066\u3044\u308b\u306e\u3067\u305d\u308c\u305e\u308c\u9055\u3046\u30ad\u30e3\u30c3\u30b7\u30e5\u30ad\u30fc\u3068\u3057\u3066\u6271\u308f\u308c\u308b\ncurl -H \"X-Cache-Key: hoge\" http://localhost -i\ncurl -H \"X-Cache-Key: fuga\" http://localhost -i\ncurl -H \"X-Cache-Key: piyo\" http://localhost -i\n```\n\n```sh\n# POST\u306f\u30ad\u30e3\u30c3\u30b7\u30e5\u3055\u308c\u306a\u3044\ncurl -X POST http://localhost -i\ncurl -X POST http://localhost -i\ncurl -X POST http://localhost -i\n```\n\n```sh\n# GET /no\u306f\u30ad\u30e3\u30c3\u30b7\u30e5\u3055\u308c\u306a\u3044\u3088\u3046\u306b\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u5074\u3067\u5236\u5fa1\u3055\u308c\u3066\u3044\u308b\ncurl http://localhost/no -i\ncurl http://localhost/no -i\ncurl http://localhost/no -i\n```\n\n```sh\n# BAN /* \u3067\u3059\u3079\u3066\u306e\u30ad\u30e3\u30c3\u30b7\u30e5\u3092\u524a\u9664\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u308b\ncurl        http://localhost/a -i\ncurl        http://localhost/b -i\ncurl -X BAN http://localhost/*\ncurl        http://localhost/a -i\ncurl        http://localhost/b -i\n```\n", "tags": ["Varnish"]}