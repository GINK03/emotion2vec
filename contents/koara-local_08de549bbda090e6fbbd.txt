{"tags": ["Linux", "GCC"], "context": "\n\nTL;DR\nLD_PRELOAD\u3067printf\u3092\u5f8c\u304b\u3089\u5dee\u3057\u66ff\u3048\u308b - Qiita\n\u4e0a\u306e\u8a18\u4e8b\u306e\u691c\u8a3c\u306e\u969b\u306b\u3001 printf \u304c __printf_chk \u306b\u4ee3\u308f\u308b\u30b1\u30fc\u30b9\u304c\u6709\u3063\u305f\u306e\u3067\u6761\u4ef6\u3092\u8abf\u67fb\u3057\u305f\u3002\n\u7d50\u8ad6\u304b\u3089\u3059\u308b\u3068\u3001 -D_FORTIFY_SOURCE=2 \u304c\u6307\u5b9a\u3055\u308c\u3066\u3044\u308b\u969b\u306b\u5dee\u3057\u66ff\u308f\u308b\u3053\u3068\u304c\u308f\u304b\u3063\u305f\u3002\n_FORTIFY_SOURCE \u306b\u3064\u3044\u3066\u306f\u4ee5\u4e0b\u306a\u3069\u3092\u53c2\u7167\u3057\u3066\u304f\u3060\u3055\u3044\u3002\nMan page of FEATURE_TEST_MACROS\n\n\u8abf\u67fb\u5185\u5bb9\n-D_FORTIFY_SOURCE=2 \u306e\u3042\u308b\u5834\u5408\u3068\u306a\u3044\u5834\u5408\u3092\u78ba\u8a8d\u3059\u308b\u3002\n\n\u30aa\u30d7\u30b7\u30e7\u30f3\u306a\u3057\n$ gcc -O1 print.c \n$ nm ./a.out \n0000000000600820 d _DYNAMIC\n00000000006009f8 d _GLOBAL_OFFSET_TABLE_\n0000000000400700 R _IO_stdin_used\n                 w _ITM_deregisterTMCloneTable\n                 w _ITM_registerTMCloneTable\n                 w _Jv_RegisterClasses\n0000000000400800 r __FRAME_END__\n0000000000600818 d __JCR_END__\n0000000000600818 d __JCR_LIST__\n0000000000600a40 A __TMC_END__\n0000000000600a3c A __bss_start\n0000000000600a38 D __data_start\n00000000004005b0 t __do_global_dtors_aux\n0000000000600810 t __do_global_dtors_aux_fini_array_entry\n0000000000400708 R __dso_handle\n0000000000600808 t __frame_dummy_init_array_entry\n                 w __gmon_start__\n0000000000600810 t __init_array_end\n0000000000600808 t __init_array_start\n00000000004006f0 T __libc_csu_fini\n0000000000400660 T __libc_csu_init\n                 U __libc_start_main@@GLIBC_2.2.5\n0000000000600a3c A _edata\n0000000000600a50 A _end\n00000000004006f4 T _fini\n0000000000400478 T _init\n00000000004004f0 T _start\n000000000040051c t call_gmon_start\n0000000000600a48 b completed.6108\n0000000000600a38 W data_start\n0000000000400540 t deregister_tm_clones\n                 U fprintf@@GLIBC_2.2.5          # \u5909\u5316\u306a\u3057\n00000000004005d0 t frame_dummy\n                 U fwrite@@GLIBC_2.2.5\n00000000004005fc T main\n                 U printf@@GLIBC_2.2.5           # \u5909\u5316\u306a\u3057 \n                 U puts@@GLIBC_2.2.5\n0000000000400570 t register_tm_clones\n0000000000600a40 B stdout@@GLIBC_2.2.5\n\n\n\n_FORTIFY_SOURCE=2\n$ gcc -D_FORTIFY_SOURCE=2 -O1 print.c \n$ nm ./a.out \n0000000000600860 d _DYNAMIC\n0000000000600a38 d _GLOBAL_OFFSET_TABLE_\n0000000000400740 R _IO_stdin_used\n                 w _ITM_deregisterTMCloneTable\n                 w _ITM_registerTMCloneTable\n                 w _Jv_RegisterClasses\n0000000000400840 r __FRAME_END__\n0000000000600858 d __JCR_END__\n0000000000600858 d __JCR_LIST__\n0000000000600a80 A __TMC_END__\n0000000000600a7c A __bss_start\n0000000000600a78 D __data_start\n00000000004005e0 t __do_global_dtors_aux\n0000000000600850 t __do_global_dtors_aux_fini_array_entry\n0000000000400748 R __dso_handle\n                 U __fprintf_chk@@GLIBC_2.3.4                #__fprintf_chk\u306b\u5909\u5316\n0000000000600848 t __frame_dummy_init_array_entry\n                 w __gmon_start__\n0000000000600850 t __init_array_end\n0000000000600848 t __init_array_start\n0000000000400730 T __libc_csu_fini\n00000000004006a0 T __libc_csu_init\n                 U __libc_start_main@@GLIBC_2.2.5\n                 U __printf_chk@@GLIBC_2.3.4                 #__printf_chk\u306b\u5909\u5316\n0000000000600a7c A _edata\n0000000000600a90 A _end\n0000000000400734 T _fini\n00000000004004a8 T _init\n0000000000400520 T _start\n000000000040054c t call_gmon_start\n0000000000600a88 b completed.6108\n0000000000600a78 W data_start\n0000000000400570 t deregister_tm_clones\n0000000000400600 t frame_dummy\n                 U fwrite@@GLIBC_2.2.5\n000000000040062c T main\n                 U puts@@GLIBC_2.2.5\n00000000004005a0 t register_tm_clones\n0000000000600a80 B stdout@@GLIBC_2.2.5\n\n\nprintf, fprintf \u304c\u305d\u308c\u305e\u308c __printf_chk, __fprintf_chk \u306b\u5dee\u3057\u66ff\u308f\u3063\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n\u5dee\u3057\u66ff\u3048\u306e\u5b9f\u88c5\u306f <bits/stdio2.h> \u306b\u5b58\u5728\u3057\u3066\u3044\u308b\u3002\n\n/usr/include/bits/stdio2.h\u629c\u7c8b\n#if __USE_FORTIFY_LEVEL > 1\n\nextern int __fprintf_chk (FILE *__restrict __stream, int __flag,\n              __const char *__restrict __format, ...);\nextern int __printf_chk (int __flag, __const char *__restrict __format, ...);\nextern int __vfprintf_chk (FILE *__restrict __stream, int __flag,\n               __const char *__restrict __format, _G_va_list __ap);\nextern int __vprintf_chk (int __flag, __const char *__restrict __format,\n              _G_va_list __ap);\n\n# ifdef __va_arg_pack\n__extern_always_inline int\nfprintf (FILE *__restrict __stream, __const char *__restrict __fmt, ...)\n{\n  return __fprintf_chk (__stream, __USE_FORTIFY_LEVEL - 1, __fmt,\n            __va_arg_pack ());\n}\n\n__extern_always_inline int\nprintf (__const char *__restrict __fmt, ...)\n{\n  return __printf_chk (__USE_FORTIFY_LEVEL - 1, __fmt, __va_arg_pack ());\n}\n# elif !defined __cplusplus\n#  define printf(...) \\\n  __printf_chk (__USE_FORTIFY_LEVEL - 1, __VA_ARGS__)\n#  define fprintf(stream, ...) \\\n  __fprintf_chk (stream, __USE_FORTIFY_LEVEL - 1, __VA_ARGS__)\n# endif\n\n\n\u5358\u7d14\u306b\u30de\u30af\u30ed\u3067\u7f6e\u304d\u63db\u3048\u3092\u884c\u3063\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u3063\u305f\u3002\n\n\u53c2\u8003\nMan page of FEATURE_TEST_MACROS\nsecurity - difference between gcc -D_FORTIFY_SOURCE=1 and -D_FORTIFY_SOURCE=2 - Stack Overflow\n# TL;DR\n[LD_PRELOAD\u3067printf\u3092\u5f8c\u304b\u3089\u5dee\u3057\u66ff\u3048\u308b - Qiita](http://qiita.com/koara-local/items/d5205f94decade3ffbf1)\n\u4e0a\u306e\u8a18\u4e8b\u306e\u691c\u8a3c\u306e\u969b\u306b\u3001 `printf` \u304c `__printf_chk` \u306b\u4ee3\u308f\u308b\u30b1\u30fc\u30b9\u304c\u6709\u3063\u305f\u306e\u3067\u6761\u4ef6\u3092\u8abf\u67fb\u3057\u305f\u3002\n\n\u7d50\u8ad6\u304b\u3089\u3059\u308b\u3068\u3001 `-D_FORTIFY_SOURCE=2` \u304c\u6307\u5b9a\u3055\u308c\u3066\u3044\u308b\u969b\u306b\u5dee\u3057\u66ff\u308f\u308b\u3053\u3068\u304c\u308f\u304b\u3063\u305f\u3002\n`_FORTIFY_SOURCE` \u306b\u3064\u3044\u3066\u306f\u4ee5\u4e0b\u306a\u3069\u3092\u53c2\u7167\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n[Man page of FEATURE_TEST_MACROS](https://linuxjm.osdn.jp/html/LDP_man-pages/man7/feature_test_macros.7.html)\n\n# \u8abf\u67fb\u5185\u5bb9\n`-D_FORTIFY_SOURCE=2` \u306e\u3042\u308b\u5834\u5408\u3068\u306a\u3044\u5834\u5408\u3092\u78ba\u8a8d\u3059\u308b\u3002\n\n```shell-session:\u30aa\u30d7\u30b7\u30e7\u30f3\u306a\u3057\n$ gcc -O1 print.c \n$ nm ./a.out \n0000000000600820 d _DYNAMIC\n00000000006009f8 d _GLOBAL_OFFSET_TABLE_\n0000000000400700 R _IO_stdin_used\n                 w _ITM_deregisterTMCloneTable\n                 w _ITM_registerTMCloneTable\n                 w _Jv_RegisterClasses\n0000000000400800 r __FRAME_END__\n0000000000600818 d __JCR_END__\n0000000000600818 d __JCR_LIST__\n0000000000600a40 A __TMC_END__\n0000000000600a3c A __bss_start\n0000000000600a38 D __data_start\n00000000004005b0 t __do_global_dtors_aux\n0000000000600810 t __do_global_dtors_aux_fini_array_entry\n0000000000400708 R __dso_handle\n0000000000600808 t __frame_dummy_init_array_entry\n                 w __gmon_start__\n0000000000600810 t __init_array_end\n0000000000600808 t __init_array_start\n00000000004006f0 T __libc_csu_fini\n0000000000400660 T __libc_csu_init\n                 U __libc_start_main@@GLIBC_2.2.5\n0000000000600a3c A _edata\n0000000000600a50 A _end\n00000000004006f4 T _fini\n0000000000400478 T _init\n00000000004004f0 T _start\n000000000040051c t call_gmon_start\n0000000000600a48 b completed.6108\n0000000000600a38 W data_start\n0000000000400540 t deregister_tm_clones\n                 U fprintf@@GLIBC_2.2.5          # \u5909\u5316\u306a\u3057\n00000000004005d0 t frame_dummy\n                 U fwrite@@GLIBC_2.2.5\n00000000004005fc T main\n                 U printf@@GLIBC_2.2.5           # \u5909\u5316\u306a\u3057 \n                 U puts@@GLIBC_2.2.5\n0000000000400570 t register_tm_clones\n0000000000600a40 B stdout@@GLIBC_2.2.5\n```\n\n```shell-session:_FORTIFY_SOURCE=2\n$ gcc -D_FORTIFY_SOURCE=2 -O1 print.c \n$ nm ./a.out \n0000000000600860 d _DYNAMIC\n0000000000600a38 d _GLOBAL_OFFSET_TABLE_\n0000000000400740 R _IO_stdin_used\n                 w _ITM_deregisterTMCloneTable\n                 w _ITM_registerTMCloneTable\n                 w _Jv_RegisterClasses\n0000000000400840 r __FRAME_END__\n0000000000600858 d __JCR_END__\n0000000000600858 d __JCR_LIST__\n0000000000600a80 A __TMC_END__\n0000000000600a7c A __bss_start\n0000000000600a78 D __data_start\n00000000004005e0 t __do_global_dtors_aux\n0000000000600850 t __do_global_dtors_aux_fini_array_entry\n0000000000400748 R __dso_handle\n                 U __fprintf_chk@@GLIBC_2.3.4                #__fprintf_chk\u306b\u5909\u5316\n0000000000600848 t __frame_dummy_init_array_entry\n                 w __gmon_start__\n0000000000600850 t __init_array_end\n0000000000600848 t __init_array_start\n0000000000400730 T __libc_csu_fini\n00000000004006a0 T __libc_csu_init\n                 U __libc_start_main@@GLIBC_2.2.5\n                 U __printf_chk@@GLIBC_2.3.4                 #__printf_chk\u306b\u5909\u5316\n0000000000600a7c A _edata\n0000000000600a90 A _end\n0000000000400734 T _fini\n00000000004004a8 T _init\n0000000000400520 T _start\n000000000040054c t call_gmon_start\n0000000000600a88 b completed.6108\n0000000000600a78 W data_start\n0000000000400570 t deregister_tm_clones\n0000000000400600 t frame_dummy\n                 U fwrite@@GLIBC_2.2.5\n000000000040062c T main\n                 U puts@@GLIBC_2.2.5\n00000000004005a0 t register_tm_clones\n0000000000600a80 B stdout@@GLIBC_2.2.5\n```\n\n`printf`, `fprintf` \u304c\u305d\u308c\u305e\u308c `__printf_chk`, `__fprintf_chk` \u306b\u5dee\u3057\u66ff\u308f\u3063\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n\u5dee\u3057\u66ff\u3048\u306e\u5b9f\u88c5\u306f `<bits/stdio2.h>` \u306b\u5b58\u5728\u3057\u3066\u3044\u308b\u3002\n\n```c:/usr/include/bits/stdio2.h\u629c\u7c8b\n#if __USE_FORTIFY_LEVEL > 1\n\nextern int __fprintf_chk (FILE *__restrict __stream, int __flag,\n\t\t\t  __const char *__restrict __format, ...);\nextern int __printf_chk (int __flag, __const char *__restrict __format, ...);\nextern int __vfprintf_chk (FILE *__restrict __stream, int __flag,\n\t\t\t   __const char *__restrict __format, _G_va_list __ap);\nextern int __vprintf_chk (int __flag, __const char *__restrict __format,\n\t\t\t  _G_va_list __ap);\n\n# ifdef __va_arg_pack\n__extern_always_inline int\nfprintf (FILE *__restrict __stream, __const char *__restrict __fmt, ...)\n{\n  return __fprintf_chk (__stream, __USE_FORTIFY_LEVEL - 1, __fmt,\n\t\t\t__va_arg_pack ());\n}\n\n__extern_always_inline int\nprintf (__const char *__restrict __fmt, ...)\n{\n  return __printf_chk (__USE_FORTIFY_LEVEL - 1, __fmt, __va_arg_pack ());\n}\n# elif !defined __cplusplus\n#  define printf(...) \\\n  __printf_chk (__USE_FORTIFY_LEVEL - 1, __VA_ARGS__)\n#  define fprintf(stream, ...) \\\n  __fprintf_chk (stream, __USE_FORTIFY_LEVEL - 1, __VA_ARGS__)\n# endif\n```\n\n\u5358\u7d14\u306b\u30de\u30af\u30ed\u3067\u7f6e\u304d\u63db\u3048\u3092\u884c\u3063\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u3063\u305f\u3002\n\n# \u53c2\u8003\n[Man page of FEATURE_TEST_MACROS](https://linuxjm.osdn.jp/html/LDP_man-pages/man7/feature_test_macros.7.html)\n[security - difference between gcc -D_FORTIFY_SOURCE=1 and -D_FORTIFY_SOURCE=2 - Stack Overflow](http://stackoverflow.com/questions/13517526/difference-between-gcc-d-fortify-source-1-and-d-fortify-source-2)\n"}