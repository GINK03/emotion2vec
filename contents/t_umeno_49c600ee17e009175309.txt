{"context": " More than 1 year has passed since last update.\n\nOpenWRT site2site IPsec (2)\nOpenWRT site2site IPsec (1) \u304b\u3089\u306e\u7d9a\u304d\nOpenWRT 15.05 R1(192.168.2.11)\u3068OpenWRT 15.05 R2(192.168.2.12)\u306e\u9593\u3067\n192.168.101.0/24\u3068192.168.102.0/24\u3092IPsec\u30c8\u30f3\u30cd\u30eb\u3067\u63a5\u7d9a\u3059\u308b\u3002\n\nOpenWRT 15.05 R1,  OpenWRT 15.05 R2 \u3044\u305a\u308c\u3082strongswan-full\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\n\u306a\u304a\u3001\u518d\u8d77\u52d5\u306e\u305f\u3073\u306b\u30d1\u30c3\u30b1\u30fc\u30b8\u306e\u30ea\u30b9\u30c8\u304c\u5931\u308f\u308c\u308b\u306e\u3067\u3001\u307e\u305a\u306fopkg update\u3092\u5b9f\u884c\u3059\u308b\u3053\u3068\u3002\n# opkg update\n# opkg install strongswan-full\n\n\n/etc/init.d/ipsec\n[IPsec Basics]https://wiki.openwrt.org/doc/howto/vpn.ipsec.basics\n\u304b\u3089\n#/etc/init.d/ipsec\n\u3092\u30b3\u30d4\u30da\u3057\u3066\u5b9f\u884c\u3059\u308b\u3068\u4e0b\u8a18\u306e\u8868\u793a\u3092\u51fa\u3057\u3066\u30a8\u30e9\u30fc\u306b\u306a\u308b\u3002\n# /etc/init.d/ipsec start\nkmod-crypto-aes missing\necho install with  \"opkg install kmod-crypto-aes --nodeps\"\n\n# opkg install kmod-crypto-aes --nodeps\n\n\u3092\u5b9f\u884c\u3057\u3066\u3082kmod-crypt-aes \u304c\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3055\u308c\u306a\u3044\u3002\n[Changeset 46483]https://dev.openwrt.org/changeset/46483\n\u306b\u3088\u308b\u3068aes\u306f\u30e2\u30b8\u30e5\u30fc\u30eb\u3067\u306f\u306a\u304f\u3001kernel\u5185\u90e8\u306b\u7d71\u5408\u3055\u308c\u305f\u306e\u3067\u3001\n/etc/init.d/ipsec \u306f\u4e0b\u8a18\u4fee\u6b63\u3059\u308b\u3053\u3068\u3067\u52d5\u4f5c\u3059\u308b\u3088\u3046\u306b\u306a\u3063\u305f\u3002\n\u203b\u8981\u306faes\u306e\u30e2\u30b8\u30e5\u30fc\u30eb\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u6709\u7121\u3092\u8abf\u3079\u306a\u3044\u3088\u3046\u306b\u3057\u305f\u3002\n--- ipsec.old   2015-12-06 22:44:58.777630000 +0900\n+++ ipsec   2015-12-06 22:43:32.149651000 +0900\n@@ -194,7 +194,7 @@\n     exit\n   fi\n\n-  for f in aes authenc cbc hmac md5 sha1; do\n+  for f in authenc cbc hmac md5 sha1; do\n     if [ `opkg list kmod-crypto-$f | wc -l` -eq 0 ]; then\n       echo kmod-crypto-$f missing\n       echo install with  \\\"opkg install kmod-crypto-$f --nodeps\\\"\n\n\n\u7de8\u96c6\u5f8c\u306e /etc/init.d/ipsec\n#!/bin/sh /etc/rc.common\n#/etc/init.d/ipsec - version 5 - 2015/02/19\n\nNAME=ipsec\nSTART=60\nSTOP=60\n\n. $IPKG_INSTROOT/lib/functions.sh\n. $IPKG_INSTROOT/lib/functions/service.sh\n\nFileSecrets=/var/ipsec/ipsec.secrets\nFileConn=/var/ipsec/ipsec.conf\nFileCommon=/var/ipsec/strongswan.conf\n\nFolderCerts=/var/ipsec/ipsec.d\n\nConfigUser()\n{\n  local enabled\n  local xauth\n  local name\n  local password\n  local crt_subject\n\n  config_get_bool enabled $1 enabled 0\n  [[ \"$enabled\" == \"0\" ]] && return\n\n  config_get_bool xauth       $1 xauth       0\n  config_get      name        $1 name        \"\"\n  config_get      password    $1 password    \"\"\n\n  if [ $xauth -eq 1 -a \"$name\" != \"\" -a \"$password\" != \"\" ]; then\n    echo \"$name : XAUTH \\\"$password\\\"\" >> $FileSecrets\n  fi\n}\n\n\nConfigPhase1() {\n  local encryption_algorithm\n  local hash_algorithm\n  local dh_group\n\n  config_get encryption_algorithm  \"$1\" encryption_algorithm\n  config_get hash_algorithm        \"$1\" hash_algorithm\n  config_get dh_group              \"$1\" dh_group\n\n  Phase1Proposal=${Phase1Proposal}\",\"${encryption_algorithm}-${hash_algorithm}-${dh_group}\n}\n\nConfigTunnel() {\n  local local_subnet\n  local local_nat\n  local remote_subnet\n  local p2_proposal\n  local pfs_group\n  local encryption_algorithm\n  local authentication_algorithm\n\n  config_get local_subnet             \"$1\"           local_subnet\n  config_get local_nat                \"$1\"           local_nat \"\"\n  config_get remote_subnet            \"$1\"           remote_subnet\n  config_get p2_proposal              \"$1\"           p2_proposal\n  config_get pfs_group                \"$p2_proposal\" pfs_group\n  config_get encryption_algorithm     \"$p2_proposal\" encryption_algorithm\n  config_get authentication_algorithm \"$p2_proposal\" authentication_algorithm\n\n  [[ \"$local_nat\" != \"\" ]] && local_subnet=$local_nat\n\n  p2_proposal=\"${encryption_algorithm}-${authentication_algorithm}-${pfs_group}\"\n\n  echo \"conn $ConfigName-$1\" >> $FileConn\n  echo \"  keyexchange=ikev1\" >> $FileConn\n  echo \"  left=$LocalGateway\" >> $FileConn\n  echo \"  right=$RemoteGateway\" >> $FileConn\n  echo \"  leftsubnet=$local_subnet\" >> $FileConn\n  if [ \"$AuthenticationMethod\" = \"psk\" ]; then\n    echo \"  leftauth=psk\" >> $FileConn\n    echo \"  rightauth=psk\" >> $FileConn\n    echo \"  rightsubnet=$remote_subnet\" >> $FileConn\n# should be auto=route when going to 5.0.1\n    echo \"  auto=start\" >> $FileConn\n  elif [ \"$AuthenticationMethod\" = \"xauth_psk_server\" ]; then\n    echo \"  authby=xauthpsk\" >> $FileConn\n    echo \"  xauth=server\" >> $FileConn\n    echo \"  modeconfig=pull\" >> $FileConn\n    echo \"  rightsourceip=$remote_subnet\" >> $FileConn\n    echo \"  auto=add\" >> $FileConn\n  fi\n  if [ \"$LocalIdentifier\" != \"\" ]; then\n    echo \"  leftid=$LocalIdentifier\" >> $FileConn\n  fi\n  if [ \"$RemoteIdentifier\" != \"\" ]; then\n    echo \"  rightid=$RemoteIdentifier\" >> $FileConn\n  fi\n\n#  echo \"  auth=esp\" >> $FileConn\n  echo \"  esp=$p2_proposal\" >> $FileConn\n  echo \"  ike=$Phase1Proposal\" >> $FileConn\n  echo \"  type=tunnel\" >> $FileConn\n}\n\nConfigRemote() {\n  local enabled\n  local gateway\n  local pre_shared_key\n  local authentication_method\n  local local_identifier\n  local remote_identifier\n\n  ConfigName=$1\n\n  config_get_bool enabled \"$1\" enabled 0\n  [[ \"$enabled\" == \"0\" ]] && return\n\n  config_get gateway               \"$1\" gateway\n  config_get pre_shared_key        \"$1\" pre_shared_key\n  config_get authentication_method \"$1\" authentication_method\n  config_get local_identifier      \"$1\" local_identifier\n  config_get remote_identifier     \"$1\" remote_identifier\n\n  AuthenticationMethod=$authentication_method\n  LocalIdentifier=$local_identifier\n  RemoteIdentifier=$remote_identifier\n\n  RemoteGateway=$gateway\n  if [ \"$RemoteGateway\" = \"any\" ]; then\n    RemoteGateway=\"%any\"\n    LocalGateway=`ip route get 1.1.1.1 | awk -F\"src\" '/src/{gsub(/ /,\"\");print $2}'`\n  else\n    LocalGateway=`ip route get $RemoteGateway | awk -F\"src\" '/src/{gsub(/ /,\"\");print $2}'`\n  fi\n  echo \"$LocalGateway $RemoteGateway : PSK \\\"$pre_shared_key\\\"\" >> $FileSecrets\n\n  Phase1Proposal=\"\"\n  config_list_foreach \"$1\" p1_proposal ConfigPhase1\n  Phase1Proposal=`echo $Phase1Proposal | cut -b 2-`\n\n  config_list_foreach \"$1\" tunnel ConfigTunnel\n}\n\nPrepareEnvironment() {\n  local debug\n\n  for d in cacerts aacerts ocspcerts crls acerts; do\n    mkdir -p $FolderCerts/$d 2>/dev/null\n  done\n\n  if [ ! -L /etc/ipsec.d ]; then\n    rm -rf /etc/ipsec.d 2>/dev/null\n    ln -s $FolderCerts /etc/ipsec.d\n  fi\n\n  if [ ! -L /etc/ipsec.secrets ]; then\n    rm /etc/ipsec.secrets 2>/dev/null\n    ln -s $FileSecrets /etc/ipsec.secrets\n  fi\n\n  if [ ! -L /etc/strongswan.conf ]; then\n    rm /etc/strongswan.conf 2>/dev/null\n    ln -s $FileCommon /etc/strongswan.conf\n  fi\n\n  if [ ! -L /etc/ipsec.conf ]; then\n    rm /etc/ipsec.conf 2>/dev/null\n    ln -s $FileConn /etc/ipsec.conf\n  fi\n\n  echo \"# generated by /etc/init.d/ipsec\" > $FileConn\n  echo \"version 2\" > $FileConn\n  echo \"# generated by /etc/init.d/ipsec\" > $FileSecrets\n\n  config_get debug \"$1\" debug 0\n\n  echo \"# generated by /etc/init.d/ipsec\" > $FileCommon\n  echo \"charon {\" >> $FileCommon\n  echo \"  load = aes des sha1 sha2 md5 gmp random nonce hmac stroke kernel-netlink socket-default updown\" >> $FileCommon\n  echo \"  filelog {\" >> $FileCommon\n  echo \"    /var/log/charon.log {\" >> $FileCommon\n  echo \"      time_format = %b %e %T\" >> $FileCommon\n  echo \"      ike_name = yes\" >> $FileCommon\n  echo \"      append = no\" >> $FileCommon\n  echo \"      default = \" $debug >> $FileCommon\n  echo \"      flush_line = yes\" >> $FileCommon\n  echo \"    }\" >> $FileCommon\n  echo \"  }\" >> $FileCommon\n  echo \"}\" >> $FileCommon\n\n}\n\nCheckInstallation() {\n  if [ ! -x /usr/sbin/ip ]; then\n    echo /usr/sbin/ip missing\n    echo install with \\\"opkg install ip\\\"\n    exit\n  fi\n\n  for f in authenc cbc hmac md5 sha1; do\n    if [ `opkg list kmod-crypto-$f | wc -l` -eq 0 ]; then\n      echo kmod-crypto-$f missing\n      echo install with  \\\"opkg install kmod-crypto-$f --nodeps\\\"\n      exit\n    fi\n  done\n\n  for f in aes gmp hmac kernel-netlink md5 random sha1 updown attr resolve; do\n    if [ ! -f /usr/lib/ipsec/plugins/libstrongswan-${f}.so ]; then\n      echo /usr/lib/ipsec/plugins/$f missing\n      echo install with \\\"opkg install strongswan-mod-$f --nodeps\\\"\n      exit\n    fi\n  done\n}\n\nstart() {\n  CheckInstallation\n\n  config_load ipsec\n  config_foreach PrepareEnvironment ipsec\n  config_foreach ConfigRemote remote\n\n  config_load users\n  config_foreach ConfigUser user\n\n  /usr/sbin/ipsec start\n}\n\nstop() {\n  /usr/sbin/ipsec stop\n}\n\n\u3053\u306e/etc/init.d/ipsec \u3092 OpenWRT 15.05 R1 \u3068 OpenWRT 15.05 R2 \u3067\u4f7f\u7528\u3059\u308b\n\n/etc/config/ipsec\n[Strongswan IPsec Configuration]https://wiki.openwrt.org/doc/uci/ipsec\n\u306e\nExample 1 taken from the IPSec site to site howto. \u306b\u306f\u3001\nconfig 'ipsec'\n  option 'zone' 'vpn'\n\nconfig 'remote' 'acme'\n  option 'enabled' '1'\n  option 'gateway' '7.7.7.7'\n  option 'authentication_method' 'psk'\n  option 'pre_shared_key' 'yourpasswordhere'\n  list   'p1_proposal' 'pre_g2_aes_sha1'\n  list   'sainfo' 'acme_dmz'\n  list   'sainfo' 'acme_lan'\n\nconfig 'p1_proposal' 'pre_g2_aes_sha1'\n  option 'encryption_algorithm' 'aes128'\n  option 'hash_algorithm' 'sha1'\n  option 'dh_group' 'modp1024'\n\nconfig 'tunnel' 'acme_lan'\n  option 'local_subnet' '192.168.2.64/26'\n  option 'remote_subnet' '10.1.2.0/24'\n  option 'p2_proposal' 'g2_aes_sha1'\n\nconfig 'p2_proposal' 'g2_aes_sha1'\n  option 'pfs_group' 'modp1024'\n  option 'encryption_algorithm' 'aes 128'\n  option 'authentication_algorithm' 'sha1'\n\n\n\u306e\u8a18\u8f09\u304c\u3042\u308b\u304c\u3001\n  list   'sainfo' 'acme_dmz'\n  list   'sainfo' 'acme_lan'\n\n\u306e\u8a18\u8f09\u306f\u8aa4\u308a\n  list   'tunnel' 'acme_dmz'\n  list   'tunnel' 'acme_lan'\n\n\u306e\u69d8\u306b'sainfo'\u3067\u306f\u306a\u304f'tunnel'\u3092\u8a18\u8f09\u3059\u308b\u3053\u3068\u3002\nOpenWRT 15.05 R1 \u8a2d\u5b9a\u5909\u66f4\u5f8c\u306e /etc/config/ipsec\nconfig 'ipsec'\n  option 'zone' 'vpn'\n\nconfig 'remote' 'r2'\n  option 'enabled' '1'\n  option 'gateway' '192.168.2.12'\n  option 'authentication_method' 'psk'\n  option 'pre_shared_key' 'yourpasswordhere'\n  list   'p1_proposal' 'pre_g2_aes_sha1'\n  list   'tunnel' 'r2_lan'\n\nconfig 'p1_proposal' 'pre_g2_aes_sha1'\n  option 'encryption_algorithm' 'aes128'\n  option 'hash_algorithm' 'sha1'\n  option 'dh_group' 'modp1024'\n\nconfig 'tunnel' 'r2_lan'\n  option 'local_subnet' '192.168.101.0/24'\n  option 'remote_subnet' '192.168.102.0/24'\n  option 'p2_proposal' 'g2_aes_sha1'\n\nconfig 'p2_proposal' 'g2_aes_sha1'\n  option 'pfs_group' 'modp1024'\n  option 'encryption_algorithm' 'aes 128'\n  option 'authentication_algorithm' 'sha1'\n\nOpenWRT 15.05 R2 \u8a2d\u5b9a\u5909\u66f4\u5f8c\u306e /etc/config/ipsec\nconfig 'ipsec'\n  option 'zone' 'vpn'\n\nconfig 'remote' 'r1'\n  option 'enabled' '1'\n  option 'gateway' '192.168.2.11'\n  option 'authentication_method' 'psk'\n  option 'pre_shared_key' 'yourpasswordhere'\n  list   'p1_proposal' 'pre_g2_aes_sha1'\n  list   'tunnel' 'r1_lan'\n\nconfig 'p1_proposal' 'pre_g2_aes_sha1'\n  option 'encryption_algorithm' 'aes128'\n  option 'hash_algorithm' 'sha1'\n  option 'dh_group' 'modp1024'\n\nconfig 'tunnel' 'r1_lan'\n  option 'local_subnet' '192.168.102.0/24'\n  option 'remote_subnet' '192.168.101.0/24'\n  option 'p2_proposal' 'g2_aes_sha1'\n\nconfig 'p2_proposal' 'g2_aes_sha1'\n  option 'pfs_group' 'modp1024'\n  option 'encryption_algorithm' 'aes 128'\n  option 'authentication_algorithm' 'sha1'\n\n\nIPsec \u306e\u72b6\u614b\u78ba\u8a8d\nOpenWRT 15.05 R1 \u3084 OpenWRT 15.05 R2 \u3067 ipsec status \u3084 ipsec statusall \u3092\u5b9f\u884c\u3059\u308b\u4e8b\u3067\u52d5\u4f5c\u78ba\u8a8d\u3067\u304d\u308b\u3002\n192.168.101.0/24 \u3068 192.168.102.0/24 \u9593\u3067\u6b63\u5e38\u306bIPsec\u306e\u30c8\u30f3\u30cd\u30eb\u304c\u4f5c\u6210\u3055\u308c\u3066\u3044\u308b\u72b6\u614b\u3067\nOpenWRT 15.05 R1 \u3067 ipsec status \u3084 ipsec statusall \u306e\u5b9f\u884c\u7d50\u679c\u3092\u4e0b\u8a18\u306b\u793a\u3059\u3002\nroot@OpenWrt:~# ipsec status\nSecurity Associations (1 up, 0 connecting):\n   r2-r2_lan[21]: ESTABLISHED 2 hours ago, 192.168.2.11[192.168.2.11]...192.168.2.12[192.168.2.12]\n   r2-r2_lan{72}:  INSTALLED, TUNNEL, reqid 1, ESP SPIs: c5b15128_i c18bf6e2_o\n   r2-r2_lan{72}:   192.168.101.0/24 === 192.168.102.0/24 \nroot@OpenWrt:~# ipsec statusall\nStatus of IKE charon daemon (strongSwan 5.3.3, Linux 3.18.20, i686):\n  uptime: 2 days, since Dec 13 11:09:32 2015\n  malloc: sbrk 102400, mmap 0, used 88688, free 13712\n  worker threads: 11 of 16 idle, 5/0/0/0 working, job queue: 0/0/0/0, scheduled: 2\n  loaded plugins: charon aes des sha1 sha2 md5 gmp random nonce hmac stroke kernel-netlink socket-default updown\nListening IP addresses:\n  192.168.2.11\n  192.168.101.1\nConnections:\n   r2-r2_lan:  192.168.2.11...192.168.2.12  IKEv1\n   r2-r2_lan:   local:  [192.168.2.11] uses pre-shared key authentication\n   r2-r2_lan:   remote: [192.168.2.12] uses pre-shared key authentication\n   r2-r2_lan:   child:  192.168.101.0/24 === 192.168.102.0/24 TUNNEL\nSecurity Associations (1 up, 0 connecting):\n   r2-r2_lan[21]: ESTABLISHED 2 hours ago, 192.168.2.11[192.168.2.11]...192.168.2.12[192.168.2.12]\n   r2-r2_lan[21]: IKEv1 SPIs: a3604b19de23fefa_i f893a59906be6ba0_r*, pre-shared key reauthentication in 39 minutes\n   r2-r2_lan[21]: IKE proposal: AES_CBC_128/HMAC_SHA1_96/PRF_HMAC_SHA1/MODP_1024\n   r2-r2_lan{72}:  INSTALLED, TUNNEL, reqid 1, ESP SPIs: c5b15128_i c18bf6e2_o\n   r2-r2_lan{72}:  AES_CBC_128/HMAC_SHA1_96, 0 bytes_i, 0 bytes_o, rekeying in 18 minutes\n   r2-r2_lan{72}:   192.168.101.0/24 === 192.168.102.0/24 \nroot@OpenWrt:~# \n\n\n\u307e\u305f\u3001PC1(192.168.101.102/24) \u304b\u3089 PC2 (192.168.102.247/24)\u306bping\u304c\u5230\u9054\u3057\u3001\u304b\u3064\u3001192.168.2.0\u306e\u30bb\u30b0\u30e1\u30f3\u30c8\u3067ICMP\u30d1\u30b1\u30c3\u30c8\u304c\u898b\u5f53\u305f\u3089\u306a\u3044\u4e8b\u3092\u78ba\u8a8d\u3059\u308b\u4e8b\u3067IPsec\u30c8\u30f3\u30cd\u30eb\u304c\u6b63\u5e38\u306b\u52d5\u4f5c\u3057\u3066\u3044\u308b\u4e8b\u3092\u78ba\u8a8d\u3067\u304d\u308b\u3002\n\n\u88dc\u8db3\n\nluci (web\u8a2d\u5b9a)\nOpenWRT\u306eweb server\u306b\u63a5\u7d9a\u3057\u305f\u969b\u306b\u30d6\u30e9\u30a6\u30b6\u306b\u4e0b\u8a18\u304c\u8868\u793a\u3055\u308c\u308b\u4e8b\u304c\u3042\u308b\n/usr/lib/lua/luci/dispatcher.lua:255: No valid theme found\nstack traceback:\n    [C]: in function 'assert'\n    /usr/lib/lua/luci/dispatcher.lua:255: in function 'dispatch'\n    /usr/lib/lua/luci/dispatcher.lua:168: in function </usr/lib/lua/luci/dispatcher.lua:167>\n\n[ #16775 closed defect (fixed) ]https://dev.openwrt.org/ticket/16775\n\u306b\u5f93\u3063\u3066\n# opkg remove luci\n# opkg remove luci-theme-bootstrap\n# opkg install luci\n\n\u3092\u5b9f\u884c\u3057\u305f\u3089\u6b63\u5e38\u306bWeb\u30d6\u30e9\u30a6\u30b6\u8868\u793a\u3055\u308c\u308b\u3088\u3046\u306b\u306a\u3063\u305f\u3002\n# OpenWRT site2site IPsec (2)\n\n[OpenWRT site2site IPsec (1)](http://qiita.com/t_umeno/items/4de97d1d005054cf7afd) \u304b\u3089\u306e\u7d9a\u304d\n\nOpenWRT 15.05 R1(192.168.2.11)\u3068OpenWRT 15.05 R2(192.168.2.12)\u306e\u9593\u3067\n192.168.101.0/24\u3068192.168.102.0/24\u3092IPsec\u30c8\u30f3\u30cd\u30eb\u3067\u63a5\u7d9a\u3059\u308b\u3002\n\n![OpenWRT_network3.jpg](https://qiita-image-store.s3.amazonaws.com/0/102457/afbdf714-c507-fe16-4d5e-7c5e87fa7225.jpeg)\n\n\nOpenWRT 15.05 R1,  OpenWRT 15.05 R2 \u3044\u305a\u308c\u3082strongswan-full\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\n\u306a\u304a\u3001\u518d\u8d77\u52d5\u306e\u305f\u3073\u306b\u30d1\u30c3\u30b1\u30fc\u30b8\u306e\u30ea\u30b9\u30c8\u304c\u5931\u308f\u308c\u308b\u306e\u3067\u3001\u307e\u305a\u306fopkg update\u3092\u5b9f\u884c\u3059\u308b\u3053\u3068\u3002\n\n```\n# opkg update\n# opkg install strongswan-full\n```\n# /etc/init.d/ipsec\n\n[IPsec Basics]https://wiki.openwrt.org/doc/howto/vpn.ipsec.basics\n\u304b\u3089\n\\#/etc/init.d/ipsec\n\u3092\u30b3\u30d4\u30da\u3057\u3066\u5b9f\u884c\u3059\u308b\u3068\u4e0b\u8a18\u306e\u8868\u793a\u3092\u51fa\u3057\u3066\u30a8\u30e9\u30fc\u306b\u306a\u308b\u3002\n\n```\n# /etc/init.d/ipsec start\nkmod-crypto-aes missing\necho install with  \"opkg install kmod-crypto-aes --nodeps\"\n```\n\n```\n# opkg install kmod-crypto-aes --nodeps\n```\n\u3092\u5b9f\u884c\u3057\u3066\u3082kmod-crypt-aes \u304c\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3055\u308c\u306a\u3044\u3002\n\n[Changeset 46483]https://dev.openwrt.org/changeset/46483\n\u306b\u3088\u308b\u3068aes\u306f\u30e2\u30b8\u30e5\u30fc\u30eb\u3067\u306f\u306a\u304f\u3001kernel\u5185\u90e8\u306b\u7d71\u5408\u3055\u308c\u305f\u306e\u3067\u3001\n/etc/init.d/ipsec \u306f\u4e0b\u8a18\u4fee\u6b63\u3059\u308b\u3053\u3068\u3067\u52d5\u4f5c\u3059\u308b\u3088\u3046\u306b\u306a\u3063\u305f\u3002\n\u203b\u8981\u306faes\u306e\u30e2\u30b8\u30e5\u30fc\u30eb\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u6709\u7121\u3092\u8abf\u3079\u306a\u3044\u3088\u3046\u306b\u3057\u305f\u3002\n\n```\n--- ipsec.old\t2015-12-06 22:44:58.777630000 +0900\n+++ ipsec\t2015-12-06 22:43:32.149651000 +0900\n@@ -194,7 +194,7 @@\n     exit\n   fi\n  \n-  for f in aes authenc cbc hmac md5 sha1; do\n+  for f in authenc cbc hmac md5 sha1; do\n     if [ `opkg list kmod-crypto-$f | wc -l` -eq 0 ]; then\n       echo kmod-crypto-$f missing\n       echo install with  \\\"opkg install kmod-crypto-$f --nodeps\\\"\n\n```\n\n\u7de8\u96c6\u5f8c\u306e /etc/init.d/ipsec\n\n```\n#!/bin/sh /etc/rc.common\n#/etc/init.d/ipsec - version 5 - 2015/02/19\n \nNAME=ipsec\nSTART=60\nSTOP=60\n \n. $IPKG_INSTROOT/lib/functions.sh\n. $IPKG_INSTROOT/lib/functions/service.sh\n \nFileSecrets=/var/ipsec/ipsec.secrets\nFileConn=/var/ipsec/ipsec.conf\nFileCommon=/var/ipsec/strongswan.conf\n \nFolderCerts=/var/ipsec/ipsec.d\n \nConfigUser()\n{\n  local enabled\n  local xauth\n  local name\n  local password\n  local crt_subject\n \n  config_get_bool enabled $1 enabled 0\n  [[ \"$enabled\" == \"0\" ]] && return\n \n  config_get_bool xauth       $1 xauth       0\n  config_get      name        $1 name        \"\"\n  config_get      password    $1 password    \"\"\n \n  if [ $xauth -eq 1 -a \"$name\" != \"\" -a \"$password\" != \"\" ]; then\n    echo \"$name : XAUTH \\\"$password\\\"\" >> $FileSecrets\n  fi\n}\n \n \nConfigPhase1() {\n  local encryption_algorithm\n  local hash_algorithm\n  local dh_group\n \n  config_get encryption_algorithm  \"$1\" encryption_algorithm\n  config_get hash_algorithm        \"$1\" hash_algorithm\n  config_get dh_group              \"$1\" dh_group\n \n  Phase1Proposal=${Phase1Proposal}\",\"${encryption_algorithm}-${hash_algorithm}-${dh_group}\n}\n \nConfigTunnel() {\n  local local_subnet\n  local local_nat\n  local remote_subnet\n  local p2_proposal\n  local pfs_group\n  local encryption_algorithm\n  local authentication_algorithm\n \n  config_get local_subnet             \"$1\"           local_subnet\n  config_get local_nat                \"$1\"           local_nat \"\"\n  config_get remote_subnet            \"$1\"           remote_subnet\n  config_get p2_proposal              \"$1\"           p2_proposal\n  config_get pfs_group                \"$p2_proposal\" pfs_group\n  config_get encryption_algorithm     \"$p2_proposal\" encryption_algorithm\n  config_get authentication_algorithm \"$p2_proposal\" authentication_algorithm\n \n  [[ \"$local_nat\" != \"\" ]] && local_subnet=$local_nat\n \n  p2_proposal=\"${encryption_algorithm}-${authentication_algorithm}-${pfs_group}\"\n \n  echo \"conn $ConfigName-$1\" >> $FileConn\n  echo \"  keyexchange=ikev1\" >> $FileConn\n  echo \"  left=$LocalGateway\" >> $FileConn\n  echo \"  right=$RemoteGateway\" >> $FileConn\n  echo \"  leftsubnet=$local_subnet\" >> $FileConn\n  if [ \"$AuthenticationMethod\" = \"psk\" ]; then\n    echo \"  leftauth=psk\" >> $FileConn\n    echo \"  rightauth=psk\" >> $FileConn\n    echo \"  rightsubnet=$remote_subnet\" >> $FileConn\n# should be auto=route when going to 5.0.1\n    echo \"  auto=start\" >> $FileConn\n  elif [ \"$AuthenticationMethod\" = \"xauth_psk_server\" ]; then\n    echo \"  authby=xauthpsk\" >> $FileConn\n    echo \"  xauth=server\" >> $FileConn\n    echo \"  modeconfig=pull\" >> $FileConn\n    echo \"  rightsourceip=$remote_subnet\" >> $FileConn\n    echo \"  auto=add\" >> $FileConn\n  fi\n  if [ \"$LocalIdentifier\" != \"\" ]; then\n    echo \"  leftid=$LocalIdentifier\" >> $FileConn\n  fi\n  if [ \"$RemoteIdentifier\" != \"\" ]; then\n    echo \"  rightid=$RemoteIdentifier\" >> $FileConn\n  fi\n \n#  echo \"  auth=esp\" >> $FileConn\n  echo \"  esp=$p2_proposal\" >> $FileConn\n  echo \"  ike=$Phase1Proposal\" >> $FileConn\n  echo \"  type=tunnel\" >> $FileConn\n}\n \nConfigRemote() {\n  local enabled\n  local gateway\n  local pre_shared_key\n  local authentication_method\n  local local_identifier\n  local remote_identifier\n \n  ConfigName=$1\n \n  config_get_bool enabled \"$1\" enabled 0\n  [[ \"$enabled\" == \"0\" ]] && return\n \n  config_get gateway               \"$1\" gateway\n  config_get pre_shared_key        \"$1\" pre_shared_key\n  config_get authentication_method \"$1\" authentication_method\n  config_get local_identifier      \"$1\" local_identifier\n  config_get remote_identifier     \"$1\" remote_identifier\n \n  AuthenticationMethod=$authentication_method\n  LocalIdentifier=$local_identifier\n  RemoteIdentifier=$remote_identifier\n \n  RemoteGateway=$gateway\n  if [ \"$RemoteGateway\" = \"any\" ]; then\n    RemoteGateway=\"%any\"\n    LocalGateway=`ip route get 1.1.1.1 | awk -F\"src\" '/src/{gsub(/ /,\"\");print $2}'`\n  else\n    LocalGateway=`ip route get $RemoteGateway | awk -F\"src\" '/src/{gsub(/ /,\"\");print $2}'`\n  fi\n  echo \"$LocalGateway $RemoteGateway : PSK \\\"$pre_shared_key\\\"\" >> $FileSecrets\n \n  Phase1Proposal=\"\"\n  config_list_foreach \"$1\" p1_proposal ConfigPhase1\n  Phase1Proposal=`echo $Phase1Proposal | cut -b 2-`\n \n  config_list_foreach \"$1\" tunnel ConfigTunnel\n}\n \nPrepareEnvironment() {\n  local debug\n \n  for d in cacerts aacerts ocspcerts crls acerts; do\n    mkdir -p $FolderCerts/$d 2>/dev/null\n  done\n \n  if [ ! -L /etc/ipsec.d ]; then\n    rm -rf /etc/ipsec.d 2>/dev/null\n    ln -s $FolderCerts /etc/ipsec.d\n  fi\n \n  if [ ! -L /etc/ipsec.secrets ]; then\n    rm /etc/ipsec.secrets 2>/dev/null\n    ln -s $FileSecrets /etc/ipsec.secrets\n  fi\n \n  if [ ! -L /etc/strongswan.conf ]; then\n    rm /etc/strongswan.conf 2>/dev/null\n    ln -s $FileCommon /etc/strongswan.conf\n  fi\n \n  if [ ! -L /etc/ipsec.conf ]; then\n    rm /etc/ipsec.conf 2>/dev/null\n    ln -s $FileConn /etc/ipsec.conf\n  fi\n \n  echo \"# generated by /etc/init.d/ipsec\" > $FileConn\n  echo \"version 2\" > $FileConn\n  echo \"# generated by /etc/init.d/ipsec\" > $FileSecrets\n \n  config_get debug \"$1\" debug 0\n \n  echo \"# generated by /etc/init.d/ipsec\" > $FileCommon\n  echo \"charon {\" >> $FileCommon\n  echo \"  load = aes des sha1 sha2 md5 gmp random nonce hmac stroke kernel-netlink socket-default updown\" >> $FileCommon\n  echo \"  filelog {\" >> $FileCommon\n  echo \"    /var/log/charon.log {\" >> $FileCommon\n  echo \"      time_format = %b %e %T\" >> $FileCommon\n  echo \"      ike_name = yes\" >> $FileCommon\n  echo \"      append = no\" >> $FileCommon\n  echo \"      default = \" $debug >> $FileCommon\n  echo \"      flush_line = yes\" >> $FileCommon\n  echo \"    }\" >> $FileCommon\n  echo \"  }\" >> $FileCommon\n  echo \"}\" >> $FileCommon\n \n}\n \nCheckInstallation() {\n  if [ ! -x /usr/sbin/ip ]; then\n    echo /usr/sbin/ip missing\n    echo install with \\\"opkg install ip\\\"\n    exit\n  fi\n \n  for f in authenc cbc hmac md5 sha1; do\n    if [ `opkg list kmod-crypto-$f | wc -l` -eq 0 ]; then\n      echo kmod-crypto-$f missing\n      echo install with  \\\"opkg install kmod-crypto-$f --nodeps\\\"\n      exit\n    fi\n  done\n \n  for f in aes gmp hmac kernel-netlink md5 random sha1 updown attr resolve; do\n    if [ ! -f /usr/lib/ipsec/plugins/libstrongswan-${f}.so ]; then\n      echo /usr/lib/ipsec/plugins/$f missing\n      echo install with \\\"opkg install strongswan-mod-$f --nodeps\\\"\n      exit\n    fi\n  done\n}\n \nstart() {\n  CheckInstallation\n \n  config_load ipsec\n  config_foreach PrepareEnvironment ipsec\n  config_foreach ConfigRemote remote\n \n  config_load users\n  config_foreach ConfigUser user\n \n  /usr/sbin/ipsec start\n}\n \nstop() {\n  /usr/sbin/ipsec stop\n}\n```\n\n\u3053\u306e/etc/init.d/ipsec \u3092 OpenWRT 15.05 R1 \u3068 OpenWRT 15.05 R2 \u3067\u4f7f\u7528\u3059\u308b\n\n#/etc/config/ipsec\n\n[Strongswan IPsec Configuration]https://wiki.openwrt.org/doc/uci/ipsec\n\u306e\nExample 1 taken from the IPSec site to site howto. \u306b\u306f\u3001\n\n```\nconfig 'ipsec'\n  option 'zone' 'vpn'\n\nconfig 'remote' 'acme'\n  option 'enabled' '1'\n  option 'gateway' '7.7.7.7'\n  option 'authentication_method' 'psk'\n  option 'pre_shared_key' 'yourpasswordhere'\n  list   'p1_proposal' 'pre_g2_aes_sha1'\n  list   'sainfo' 'acme_dmz'\n  list   'sainfo' 'acme_lan'\n\nconfig 'p1_proposal' 'pre_g2_aes_sha1'\n  option 'encryption_algorithm' 'aes128'\n  option 'hash_algorithm' 'sha1'\n  option 'dh_group' 'modp1024'\n\nconfig 'tunnel' 'acme_lan'\n  option 'local_subnet' '192.168.2.64/26'\n  option 'remote_subnet' '10.1.2.0/24'\n  option 'p2_proposal' 'g2_aes_sha1'\n\nconfig 'p2_proposal' 'g2_aes_sha1'\n  option 'pfs_group' 'modp1024'\n  option 'encryption_algorithm' 'aes 128'\n  option 'authentication_algorithm' 'sha1'\n\n```\n\n\u306e\u8a18\u8f09\u304c\u3042\u308b\u304c\u3001\n\n```\n  list   'sainfo' 'acme_dmz'\n  list   'sainfo' 'acme_lan'\n```\n\n\u306e\u8a18\u8f09\u306f\u8aa4\u308a\n\n```\n  list   'tunnel' 'acme_dmz'\n  list   'tunnel' 'acme_lan'\n```\n\u306e\u69d8\u306b'sainfo'\u3067\u306f\u306a\u304f'tunnel'\u3092\u8a18\u8f09\u3059\u308b\u3053\u3068\u3002\n\nOpenWRT 15.05 R1 \u8a2d\u5b9a\u5909\u66f4\u5f8c\u306e /etc/config/ipsec\n\n```\nconfig 'ipsec'\n  option 'zone' 'vpn'\n\nconfig 'remote' 'r2'\n  option 'enabled' '1'\n  option 'gateway' '192.168.2.12'\n  option 'authentication_method' 'psk'\n  option 'pre_shared_key' 'yourpasswordhere'\n  list   'p1_proposal' 'pre_g2_aes_sha1'\n  list   'tunnel' 'r2_lan'\n\nconfig 'p1_proposal' 'pre_g2_aes_sha1'\n  option 'encryption_algorithm' 'aes128'\n  option 'hash_algorithm' 'sha1'\n  option 'dh_group' 'modp1024'\n\nconfig 'tunnel' 'r2_lan'\n  option 'local_subnet' '192.168.101.0/24'\n  option 'remote_subnet' '192.168.102.0/24'\n  option 'p2_proposal' 'g2_aes_sha1'\n\nconfig 'p2_proposal' 'g2_aes_sha1'\n  option 'pfs_group' 'modp1024'\n  option 'encryption_algorithm' 'aes 128'\n  option 'authentication_algorithm' 'sha1'\n```\n\nOpenWRT 15.05 R2 \u8a2d\u5b9a\u5909\u66f4\u5f8c\u306e /etc/config/ipsec\n\n```\nconfig 'ipsec'\n  option 'zone' 'vpn'\n\nconfig 'remote' 'r1'\n  option 'enabled' '1'\n  option 'gateway' '192.168.2.11'\n  option 'authentication_method' 'psk'\n  option 'pre_shared_key' 'yourpasswordhere'\n  list   'p1_proposal' 'pre_g2_aes_sha1'\n  list   'tunnel' 'r1_lan'\n\nconfig 'p1_proposal' 'pre_g2_aes_sha1'\n  option 'encryption_algorithm' 'aes128'\n  option 'hash_algorithm' 'sha1'\n  option 'dh_group' 'modp1024'\n\nconfig 'tunnel' 'r1_lan'\n  option 'local_subnet' '192.168.102.0/24'\n  option 'remote_subnet' '192.168.101.0/24'\n  option 'p2_proposal' 'g2_aes_sha1'\n\nconfig 'p2_proposal' 'g2_aes_sha1'\n  option 'pfs_group' 'modp1024'\n  option 'encryption_algorithm' 'aes 128'\n  option 'authentication_algorithm' 'sha1'\n```\n\n#IPsec \u306e\u72b6\u614b\u78ba\u8a8d\n\nOpenWRT 15.05 R1 \u3084 OpenWRT 15.05 R2 \u3067 ipsec status \u3084 ipsec statusall \u3092\u5b9f\u884c\u3059\u308b\u4e8b\u3067\u52d5\u4f5c\u78ba\u8a8d\u3067\u304d\u308b\u3002\n192.168.101.0/24 \u3068 192.168.102.0/24 \u9593\u3067\u6b63\u5e38\u306bIPsec\u306e\u30c8\u30f3\u30cd\u30eb\u304c\u4f5c\u6210\u3055\u308c\u3066\u3044\u308b\u72b6\u614b\u3067\nOpenWRT 15.05 R1 \u3067 ipsec status \u3084 ipsec statusall \u306e\u5b9f\u884c\u7d50\u679c\u3092\u4e0b\u8a18\u306b\u793a\u3059\u3002\n\n```\nroot@OpenWrt:~# ipsec status\nSecurity Associations (1 up, 0 connecting):\n   r2-r2_lan[21]: ESTABLISHED 2 hours ago, 192.168.2.11[192.168.2.11]...192.168.2.12[192.168.2.12]\n   r2-r2_lan{72}:  INSTALLED, TUNNEL, reqid 1, ESP SPIs: c5b15128_i c18bf6e2_o\n   r2-r2_lan{72}:   192.168.101.0/24 === 192.168.102.0/24 \nroot@OpenWrt:~# ipsec statusall\nStatus of IKE charon daemon (strongSwan 5.3.3, Linux 3.18.20, i686):\n  uptime: 2 days, since Dec 13 11:09:32 2015\n  malloc: sbrk 102400, mmap 0, used 88688, free 13712\n  worker threads: 11 of 16 idle, 5/0/0/0 working, job queue: 0/0/0/0, scheduled: 2\n  loaded plugins: charon aes des sha1 sha2 md5 gmp random nonce hmac stroke kernel-netlink socket-default updown\nListening IP addresses:\n  192.168.2.11\n  192.168.101.1\nConnections:\n   r2-r2_lan:  192.168.2.11...192.168.2.12  IKEv1\n   r2-r2_lan:   local:  [192.168.2.11] uses pre-shared key authentication\n   r2-r2_lan:   remote: [192.168.2.12] uses pre-shared key authentication\n   r2-r2_lan:   child:  192.168.101.0/24 === 192.168.102.0/24 TUNNEL\nSecurity Associations (1 up, 0 connecting):\n   r2-r2_lan[21]: ESTABLISHED 2 hours ago, 192.168.2.11[192.168.2.11]...192.168.2.12[192.168.2.12]\n   r2-r2_lan[21]: IKEv1 SPIs: a3604b19de23fefa_i f893a59906be6ba0_r*, pre-shared key reauthentication in 39 minutes\n   r2-r2_lan[21]: IKE proposal: AES_CBC_128/HMAC_SHA1_96/PRF_HMAC_SHA1/MODP_1024\n   r2-r2_lan{72}:  INSTALLED, TUNNEL, reqid 1, ESP SPIs: c5b15128_i c18bf6e2_o\n   r2-r2_lan{72}:  AES_CBC_128/HMAC_SHA1_96, 0 bytes_i, 0 bytes_o, rekeying in 18 minutes\n   r2-r2_lan{72}:   192.168.101.0/24 === 192.168.102.0/24 \nroot@OpenWrt:~# \n\n```\n\u307e\u305f\u3001PC1(192.168.101.102/24) \u304b\u3089 PC2 (192.168.102.247/24)\u306bping\u304c\u5230\u9054\u3057\u3001\u304b\u3064\u3001192.168.2.0\u306e\u30bb\u30b0\u30e1\u30f3\u30c8\u3067ICMP\u30d1\u30b1\u30c3\u30c8\u304c\u898b\u5f53\u305f\u3089\u306a\u3044\u4e8b\u3092\u78ba\u8a8d\u3059\u308b\u4e8b\u3067IPsec\u30c8\u30f3\u30cd\u30eb\u304c\u6b63\u5e38\u306b\u52d5\u4f5c\u3057\u3066\u3044\u308b\u4e8b\u3092\u78ba\u8a8d\u3067\u304d\u308b\u3002\n\n#\u88dc\u8db3 \n##luci (web\u8a2d\u5b9a)\nOpenWRT\u306eweb server\u306b\u63a5\u7d9a\u3057\u305f\u969b\u306b\u30d6\u30e9\u30a6\u30b6\u306b\u4e0b\u8a18\u304c\u8868\u793a\u3055\u308c\u308b\u4e8b\u304c\u3042\u308b\n\n```\n/usr/lib/lua/luci/dispatcher.lua:255: No valid theme found\nstack traceback:\n\t[C]: in function 'assert'\n\t/usr/lib/lua/luci/dispatcher.lua:255: in function 'dispatch'\n\t/usr/lib/lua/luci/dispatcher.lua:168: in function </usr/lib/lua/luci/dispatcher.lua:167>\n```\n\n[ #16775 closed defect (fixed) ]https://dev.openwrt.org/ticket/16775\n\u306b\u5f93\u3063\u3066\n\n```\n# opkg remove luci\n# opkg remove luci-theme-bootstrap\n# opkg install luci\n```\n\n\u3092\u5b9f\u884c\u3057\u305f\u3089\u6b63\u5e38\u306bWeb\u30d6\u30e9\u30a6\u30b6\u8868\u793a\u3055\u308c\u308b\u3088\u3046\u306b\u306a\u3063\u305f\u3002\n\n", "tags": ["openwrt"]}