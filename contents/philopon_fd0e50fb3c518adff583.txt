{"context": " More than 1 year has passed since last update.\n\n\u306f\u3058\u3081\u306b\nHaskell advent calendar\u306e\u30cd\u30bf\u3092\u63a2\u3057\u3066\u3044\u305f\u3089GHC.Prim\u306e\u4e2d\u306bSIMD Vectors\u306a\u308b\u9762\u767d\u305d\u3046\u306a\u95a2\u6570\u90e1\u3092\u898b\u4ed8\u3051\u305f\u306e\u3067\u3001\u9069\u5f53\u306b\u30b5\u30f3\u30d7\u30eb\u3092\u66f8\u3044\u3066\u30b3\u30f3\u30d1\u30a4\u30eb\u3057\u3088\u3046\u3068\u3059\u308b\u3068\u3001\n\nsample.hs\n{-# LANGUAGE UnboxedTuples #-}\n{-# LANGUAGE MagicHash #-}\n\nimport GHC.Exts\nimport GHC.Prim\n\nplus2 :: Int64X4# -> Int64X4#\nplus2 = plusInt64X4# (broadcastInt64X4# 2#)\n\nmain :: IO ()\nmain = do\n    let st = packInt64X4# (# 243#, 12#, 46#, 1258# #)\n        p2 = plus2 st\n        (# a,b,c,d #) = unpackInt64X4# p2\n    print $ I# a\n\n\n$ ghc -O2 simd.hs\n[1 of 1] Compiling Main             ( simd.hs, simd.o )\nghc: sorry! (unimplemented feature or known bug)\n  (GHC version 7.8.3 for x86_64-apple-darwin):\n    SIMD vector instructions require the LLVM back-end.\nPlease use -fllvm.\n\n$ ghc -O2 -fllvm simd.hs\n[1 of 1] Compiling Main             ( simd.hs, simd.o )\n\n<no location info>:\n    Warning: Couldn't figure out LLVM version!\n             Make sure you have installed LLVM\nghc: sorry! (unimplemented feature or known bug)\n  (GHC version 7.8.3 for x86_64-apple-darwin):\n    256-bit wide integer SIMD vector instructions require at least -mavx2.\n\n$ ghc -O2 -fllvm -mavx2 simd.hs\n[1 of 1] Compiling Main             ( simd.hs, simd.o )\n\n<no location info>:\n    Warning: Couldn't figure out LLVM version!\n             Make sure you have installed LLVM\nghc: could not execute: opt\n\n\u3068\u6012\u3089\u308c\u305f\u306e\u3067llvm\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u305f\u30e1\u30e2\u3067\u3059\u3002\n\nhomebrew\u3067llvm-3.4\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\nghc-7.8\u306fllvm-3.4\u4ee5\u964d\u306b\u5bfe\u5fdc\u3057\u3066\u3044\u306a\u3044\u306e\u3067\u3001\u660e\u793a\u7684\u306bllvm-3.4\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u307e\u3059\u3002\n$ brew tap homebrew/versions\nCloning into '/usr/local/Library/Taps/homebrew/homebrew-versions'...\nremote: Counting objects: 2535, done.\nremote: Compressing objects: 100% (3/3), done.\nremote: Total 2535 (delta 0), reused 0 (delta 0)\nReceiving objects: 100% (2535/2535), 835.36 KiB | 449.00 KiB/s, done.\nResolving deltas: 100% (1457/1457), done.\nChecking connectivity... done.\nTapped 165 formulae\n$ brew search llvm\nllvm         llvm31   llvm33       llvm35\nllvm-gcc28   llvm32   llvm34\n$ brew install llvm34\n==> Installing llvm34 from homebrew/homebrew-versions\n==> Downloading http://llvm.org/releases/3.4.2/llvm-3.4.2.src.tar.gz\nAlready downloaded: /Library/Caches/Homebrew/llvm34-3.4.2.tar.gz\n==> Downloading http://llvm.org/releases/3.4/polly-3.4.src.tar.gz\nAlready downloaded: /Library/Caches/Homebrew/llvm34--polly-3.4.tar.gz\n==> ./configure --prefix=/usr/local/Cellar/llvm34/3.4.2/lib/llvm-3.4 --enable-opti\n==> make VERBOSE=1\n==> make VERBOSE=1 install\n?  /usr/local/Cellar/llvm34/3.4.2: 689 files, 65M, built in 12.2 minutes\n\n\nghc\u306esettings\u3092\u66f8\u304d\u63db\u3048\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u305fllvm\u306e\u30b3\u30de\u30f3\u30c9\u90e1\u306b\u306f-3.4\u306esuffix\u304c\u4ed8\u3044\u3066\u3044\u308b\u306e\u3067\u3001\u305d\u306e\u307e\u307e\u3067\u306fghc\u306b\u8a8d\u8b58\u3055\u308c\u307e\u305b\u3093\u3002ghc\u306esettings\u30d5\u30a1\u30a4\u30eb\u3092\u7de8\u96c6\u3057\u3066opt\u3068llvm\u306e\u540d\u524d\u3092\u6559\u3048\u307e\u3057\u3087\u3046\u3002\n$ sudo vi $GHCPATH/lib/ghc-7.8.3/settings\n\n- (\"LLVM llc command\", \"llc\"),\n- (\"LLVM opt command\", \"opt\")\n+ (\"LLVM llc command\", \"llc-3.4\"),\n+ (\"LLVM opt command\", \"opt-3.4\")\n\n\n\u518d\u5ea6\u30b3\u30f3\u30d1\u30a4\u30eb\n\u3055\u3066\u3001\u3053\u308c\u3067llvm\u30d0\u30c3\u30af\u30a8\u30f3\u30c9\u3092\u7528\u3044\u3066\u30b3\u30f3\u30d1\u30a4\u30eb\u3059\u308b\u6e96\u5099\u304c\u51fa\u6765\u305f\u306e\u3067\u3001\u3082\u3046\u4e00\u5ea6\u30b3\u30f3\u30d1\u30a4\u30eb\u3057\u3066\u307f\u307e\u3057\u3087\u3046\u3002\n$ ghc -O2 -fllvm -mavx2 simd.hs\n[1 of 1] Compiling Main             ( simd.hs, simd.o )\nLinking simd ...\n\n$ ./simd\n245\n\n\u30b3\u30f3\u30d1\u30a4\u30eb\uff06\u5b9f\u884c\u51fa\u6765\u307e\u3057\u305f\uff01\u3084\u3063\u305f\u306d\uff01\u3061\u306a\u307f\u306b\u4ee5\u4e0b\u306e\u30aa\u30d7\u30b7\u30e7\u30f3\u3092\u4e0e\u3048\u3066\u3042\u3052\u308b\u3068llvm\u306e\u30b3\u30fc\u30c9\u3082\u51fa\u529b\u51fa\u6765\u307e\u3059\u3088\u3002\n# -fforce-recomp\u306f\u5f37\u5236\u7684\u306b\u518d\u30b3\u30f3\u30d1\u30a4\u30eb\u3057\u3066\u3082\u3089\u3046\u70ba\n$ ghc -O2 -fllvm -mavx2 -fforce-recomp -ddump-llvm simd.hs\n[1 of 1] Compiling Main             ( simd.hs, simd.o )\n\n==================== LLVM Code ====================\ntarget datalayout = \"e-p:64:64:64-i1:8:8-i8:8:8-i16:16:16-i32:32:32-i64:64:64-f32:32:32-f64:64:64-v64:64:64-v128:128:128-a0:0:64-s0:64:64-f80:128:128-n8:16:32:64\"\ntarget triple = \"x86_64-apple-darwin10.0.0\"\n\n\n\n==================== LLVM Code ====================\ndeclare ccc i8* @memcpy(i8*, i8*, i64)\n# \u4ee5\u4e0b\u5ef6\u3005\u51fa\u529b\n\n\u306f\u3058\u3081\u306b\n===\nHaskell advent calendar\u306e\u30cd\u30bf\u3092\u63a2\u3057\u3066\u3044\u305f\u3089GHC.Prim\u306e\u4e2d\u306b[SIMD Vectors](https://hackage.haskell.org/package/ghc-prim-0.3.1.0/docs/GHC-Prim.html#g:27)\u306a\u308b\u9762\u767d\u305d\u3046\u306a\u95a2\u6570\u90e1\u3092\u898b\u4ed8\u3051\u305f\u306e\u3067\u3001\u9069\u5f53\u306b\u30b5\u30f3\u30d7\u30eb\u3092\u66f8\u3044\u3066\u30b3\u30f3\u30d1\u30a4\u30eb\u3057\u3088\u3046\u3068\u3059\u308b\u3068\u3001\n\n```sample.hs\n{-# LANGUAGE UnboxedTuples #-}\n{-# LANGUAGE MagicHash #-}\n\nimport GHC.Exts\nimport GHC.Prim\n\nplus2 :: Int64X4# -> Int64X4#\nplus2 = plusInt64X4# (broadcastInt64X4# 2#)\n\nmain :: IO ()\nmain = do\n    let st = packInt64X4# (# 243#, 12#, 46#, 1258# #)\n        p2 = plus2 st\n        (# a,b,c,d #) = unpackInt64X4# p2\n    print $ I# a\n```\n\n```.sh\n$ ghc -O2 simd.hs\n[1 of 1] Compiling Main             ( simd.hs, simd.o )\nghc: sorry! (unimplemented feature or known bug)\n  (GHC version 7.8.3 for x86_64-apple-darwin):\n\tSIMD vector instructions require the LLVM back-end.\nPlease use -fllvm.\n\n$ ghc -O2 -fllvm simd.hs\n[1 of 1] Compiling Main             ( simd.hs, simd.o )\n\n<no location info>:\n    Warning: Couldn't figure out LLVM version!\n             Make sure you have installed LLVM\nghc: sorry! (unimplemented feature or known bug)\n  (GHC version 7.8.3 for x86_64-apple-darwin):\n\t256-bit wide integer SIMD vector instructions require at least -mavx2.\n\n$ ghc -O2 -fllvm -mavx2 simd.hs\n[1 of 1] Compiling Main             ( simd.hs, simd.o )\n\n<no location info>:\n    Warning: Couldn't figure out LLVM version!\n             Make sure you have installed LLVM\nghc: could not execute: opt\n```\n\n\u3068\u6012\u3089\u308c\u305f\u306e\u3067llvm\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u305f\u30e1\u30e2\u3067\u3059\u3002\n\nhomebrew\u3067llvm-3.4\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n===\nghc-7.8\u306fllvm-3.4\u4ee5\u964d\u306b\u5bfe\u5fdc\u3057\u3066\u3044\u306a\u3044\u306e\u3067\u3001\u660e\u793a\u7684\u306bllvm-3.4\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u307e\u3059\u3002\n\n```.sh\n$ brew tap homebrew/versions\nCloning into '/usr/local/Library/Taps/homebrew/homebrew-versions'...\nremote: Counting objects: 2535, done.\nremote: Compressing objects: 100% (3/3), done.\nremote: Total 2535 (delta 0), reused 0 (delta 0)\nReceiving objects: 100% (2535/2535), 835.36 KiB | 449.00 KiB/s, done.\nResolving deltas: 100% (1457/1457), done.\nChecking connectivity... done.\nTapped 165 formulae\n$ brew search llvm\nllvm\t     llvm31\t  llvm33       llvm35\nllvm-gcc28   llvm32\t  llvm34\n$ brew install llvm34\n==> Installing llvm34 from homebrew/homebrew-versions\n==> Downloading http://llvm.org/releases/3.4.2/llvm-3.4.2.src.tar.gz\nAlready downloaded: /Library/Caches/Homebrew/llvm34-3.4.2.tar.gz\n==> Downloading http://llvm.org/releases/3.4/polly-3.4.src.tar.gz\nAlready downloaded: /Library/Caches/Homebrew/llvm34--polly-3.4.tar.gz\n==> ./configure --prefix=/usr/local/Cellar/llvm34/3.4.2/lib/llvm-3.4 --enable-opti\n==> make VERBOSE=1\n==> make VERBOSE=1 install\n?  /usr/local/Cellar/llvm34/3.4.2: 689 files, 65M, built in 12.2 minutes\n```\n\nghc\u306esettings\u3092\u66f8\u304d\u63db\u3048\n===\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u305fllvm\u306e\u30b3\u30de\u30f3\u30c9\u90e1\u306b\u306f-3.4\u306esuffix\u304c\u4ed8\u3044\u3066\u3044\u308b\u306e\u3067\u3001\u305d\u306e\u307e\u307e\u3067\u306fghc\u306b\u8a8d\u8b58\u3055\u308c\u307e\u305b\u3093\u3002ghc\u306esettings\u30d5\u30a1\u30a4\u30eb\u3092\u7de8\u96c6\u3057\u3066opt\u3068llvm\u306e\u540d\u524d\u3092\u6559\u3048\u307e\u3057\u3087\u3046\u3002\n\n```.sh\n$ sudo vi $GHCPATH/lib/ghc-7.8.3/settings\n```\n\n```.diff\n- (\"LLVM llc command\", \"llc\"),\n- (\"LLVM opt command\", \"opt\")\n+ (\"LLVM llc command\", \"llc-3.4\"),\n+ (\"LLVM opt command\", \"opt-3.4\")\n```\n\n\u518d\u5ea6\u30b3\u30f3\u30d1\u30a4\u30eb\n===\n\u3055\u3066\u3001\u3053\u308c\u3067llvm\u30d0\u30c3\u30af\u30a8\u30f3\u30c9\u3092\u7528\u3044\u3066\u30b3\u30f3\u30d1\u30a4\u30eb\u3059\u308b\u6e96\u5099\u304c\u51fa\u6765\u305f\u306e\u3067\u3001\u3082\u3046\u4e00\u5ea6\u30b3\u30f3\u30d1\u30a4\u30eb\u3057\u3066\u307f\u307e\u3057\u3087\u3046\u3002\n\n```.sh\n$ ghc -O2 -fllvm -mavx2 simd.hs\n[1 of 1] Compiling Main             ( simd.hs, simd.o )\nLinking simd ...\n\n$ ./simd\n245\n```\n\n\u30b3\u30f3\u30d1\u30a4\u30eb\uff06\u5b9f\u884c\u51fa\u6765\u307e\u3057\u305f\uff01\u3084\u3063\u305f\u306d\uff01\u3061\u306a\u307f\u306b\u4ee5\u4e0b\u306e\u30aa\u30d7\u30b7\u30e7\u30f3\u3092\u4e0e\u3048\u3066\u3042\u3052\u308b\u3068llvm\u306e\u30b3\u30fc\u30c9\u3082\u51fa\u529b\u51fa\u6765\u307e\u3059\u3088\u3002\n\n```.sh\n# -fforce-recomp\u306f\u5f37\u5236\u7684\u306b\u518d\u30b3\u30f3\u30d1\u30a4\u30eb\u3057\u3066\u3082\u3089\u3046\u70ba\n$ ghc -O2 -fllvm -mavx2 -fforce-recomp -ddump-llvm simd.hs\n[1 of 1] Compiling Main             ( simd.hs, simd.o )\n\n==================== LLVM Code ====================\ntarget datalayout = \"e-p:64:64:64-i1:8:8-i8:8:8-i16:16:16-i32:32:32-i64:64:64-f32:32:32-f64:64:64-v64:64:64-v128:128:128-a0:0:64-s0:64:64-f80:128:128-n8:16:32:64\"\ntarget triple = \"x86_64-apple-darwin10.0.0\"\n\n\n\n==================== LLVM Code ====================\ndeclare ccc i8* @memcpy(i8*, i8*, i64)\n# \u4ee5\u4e0b\u5ef6\u3005\u51fa\u529b\n```\n", "tags": ["ghc7.8.3", "LLVM3.4", "Haskell", "Mac"]}