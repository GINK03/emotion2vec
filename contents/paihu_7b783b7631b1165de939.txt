{"context": "\n\n\u306f\u3058\u3081\u306b\nSNMP\u3092\u5229\u7528\u3057\u305f\u30e2\u30cb\u30bf\u30ea\u30f3\u30b0\u306f\u6614\u304b\u3089\u884c\u308f\u308c\u3066\u3044\u3066\nMRTG Munin Cacti Zabbix \u306a\u3069\u306a\u3069\u3001\u3044\u304f\u3089\u3067\u3082\u30c4\u30fc\u30eb\u304c\u3042\u308a\u307e\u3059\u3088\u306d\u3002\n\u3067\u3082\u306a\u3093\u304b\u6700\u8fd1\u306f\u3084\u308a\u306eOSS\u306a\u30e2\u30cb\u30bf\u30ea\u30f3\u30b0\u30c4\u30fc\u30eb\u3067\u6c17\u8efd\u306b\u62fe\u3044\u305f\u3044\uff01\u3068\u304b\u601d\u3063\u305f\u306e\u3067\u8a66\u3057\u3066\u307f\u3088\u3046\u3068\u601d\u3063\u305f\u6b21\u7b2c\u3067\u3059\u3002\n\u5177\u4f53\u7684\u306b\u306f collectd, fluentd, prometheus \u3092\u6bd4\u3079\u3066\u307f\u307e\u3057\u305f\u3002\ncollectd, fluentd \u306f\u30c7\u30fc\u30bf\u3092\u30eb\u30fc\u30c6\u30a3\u30f3\u30b0\u3059\u308b\u3082\u306e\u306a\u306e\u3067\u3001\u30c7\u30fc\u30bf\u30b9\u30c8\u30a2\u3068\u3057\u3066graphite, influxdb\u306a\u3069\u3092\u5229\u7528\u3059\u308b\u3053\u3068\u3092\u60f3\u5b9a\u3057\u3066\u3044\u307e\u3059\u3002\n\u304c\u305d\u306e\u8a2d\u5b9a\u306f\u3068\u308a\u3042\u3048\u305a\u3053\u3053\u3067\u306f\u95a2\u4fc2\u304c\u306a\u3044\u306e\u3067\u8a18\u8f09\u3057\u3066\u3044\u307e\u305b\u3093\u3002\n\ncollectd\nPlugin\u3067\u5bfe\u5fdc\u53ef\u80fd\u3067\u3059\u3002\n\u8a2d\u5b9a\u306f\nLoadPlugin snmp\n<Plugin snmp>\n  <Data \"dataname\">\n    Type \"tipename\"\n    Table true\n    Instance \"IF-MIB::ifDescr\"\n    Values \"IF-MIB::ifInOctets\" \"IF-MIB::ifOutOctets\"\n  </Data>\n  <Data \"dataname\">\n    Type \"users\" \n    Table false\n    Instance \"\"\n    Shift -1\n    Values \"HOST-RESOURCES-MIB::hrSystemNumUsers.0\"\n  </Data>\n  <Host \"Hostname\">\n    Address \"192.168.1.1\"\n    Version 2\n    Interval 60\n    Community \"another_string\"\n    Collect \"dataname\" \"dataname\" \"dataname\"\n  </Host>\n</Plugin>\n\nPlugin\u306e\u8aad\u307f\u8fbc\u307f\u3001\n\u30c7\u30fc\u30bf\u306e\u5b9a\u7fa9\u3001(index\u3082\u306e\u306a\u3089Table true)Instance\u3067\u6307\u5b9a\u3057\u305f\u3082\u306e\u304cindex\u540d\u3068\u3057\u3066\u4f7f\u7528\u3055\u308c\u308b\n\u30db\u30b9\u30c8\u306e\u5b9a\u7fa9 (\u53ce\u96c6\u3059\u308b\u30c7\u30fc\u30bf\u306e\u6307\u5b9a)\n\u307f\u305f\u3044\u306a\u5f62\u3067\u3059\u3002\n\u30c7\u30fc\u30bf\u5b9a\u7fa9\u3068\u30db\u30b9\u30c8\u306e\u5b9a\u7fa9\u304c\u5206\u304b\u308c\u3066\u3044\u308b\u306e\u3067\u3001\u8a2d\u5b9a\u306f\u305d\u3053\u307e\u3067\u591a\u304f\u5897\u3048\u307e\u305b\u3093\u3002\n\u305f\u3060\u3001\u30c7\u30fc\u30bf\u5b9a\u7fa9\u3092\u30b0\u30eb\u30fc\u30d4\u30f3\u30b0\u3057\u305f\u308a\u3067\u304d\u306a\u3044(?)\u306e\u3067\u3001\n\u30db\u30b9\u30c8\u306e Collect \u304c\u3059\u3054\u304f\u3001\u9577\u304f\u306a\u308b\u53ef\u80fd\u6027\u306f\u3042\u308a\u307e\u3059\u3002\n\nfluentd\nPlugin\u3067\u5bfe\u5fdc\u53ef\u80fd\u3067\u3059\u3002\n\u8a2d\u5b9a\u306f\n<source>\n  type snmp\n  tag snmp.hostname\n  host \"192.168.1.1\"\n  Community \"another_string\"\n  mib ifDescr, ifInOctets, ifOutOctets\n  method_type walk\n  polling_time 1\n  out_executor \"/path/of/exec.rb\"\n</source>\n<source>\n  type snmp\n  tag snmp.hostname\n  host \"192.168.1.1\"\n  Community \"another_string\"\n  mib \"hrSystemNumUsers.0\"\n  method_type get\n</source>\n\n\u30db\u30b9\u30c8\u540d\u3068\u30c7\u30fc\u30bf\u306e\u5b9a\u7fa9 \u3092\u30bb\u30c3\u30c8\u3067\u884c\u3046\u306e\u3067\u3001\n\u53ce\u96c6\u3057\u305f\u3044\u30c7\u30fc\u30bf\u3068\u30db\u30b9\u30c8\u304c\u591a\u304f\u306a\u308b\u3068\u3001source\u5b9a\u7fa9\u304c\u3069\u3093\u3069\u3093\u5897\u3048\u3066\u3044\u304d\u307e\u3059\u3002\n\u3064\u3089\u3044\u3002\n\u4f55\u3082\u3057\u306a\u3044\u3068\u53ce\u96c6\u3057\u305f\u30c7\u30fc\u30bf\u306fValue={Name=hoge,Value=fuga} \u306e\u3088\u3046\u306a\u5f62\u3067\u5c4a\u304f\u306e\u3067\nexec.rb \u3092\u7528\u610f\u3057\u3066\u52a0\u5de5\u3057\u306a\u3044\u3068\u3064\u3089\u3044\u304b\u3082\u3002\ninterface\u306f ifDescr.ifInOctets=value, ifDescr.ifOutOctets=value\u306e\u3088\u3046\u306b\u52a0\u5de5\u3057\u3066\u5410\u304d\u51fa\u3059\u3088\u3046\u306b\u3057\u3066\u307f\u307e\u3057\u305f\u3002\u4e0b\u8a18\nmodule Fluent\n  class SnmpInput\n    def out_exec manager, opts={}\n      manager.walk(opts[:mib]) do |row|\n        time = Time.now.to_i\n        time = time - time  % 5\n        record = {}\n        data = {}\n        row.each do |vb|\n          data[\"name\"] = vb.value.to_s if vb.name.to_s =~ /Descr/\n          data[\"InOctets\"] = vb.value.to_s if vb.name.to_s =~ /InOctets/\n          data[\"OutOctets\"] = vb.value.to_s if vb.name.to_s =~ /OutOctets/\n        end\n        if data.has_key?(\"name\")\n          record[\"#{data['name']}.InOctets\"] = data[\"InOctets\"] if data.has_key?(\"InOctets\")\n          record[\"#{data['name']}.OutOctets\"] = data[\"OutOctets\"] if data.has_key?(\"OutOctets\")\n        end\n        if record\n          router.emit opts[:tag], time, record\n        end\n      end\n    end\n  end\nend\n\n\u307e\u305f\u53ce\u96c6\u30c7\u30fc\u30bf\u30bf\u30a4\u30d7\u304c\u30ab\u30a6\u30f3\u30bf\u3060\u3068\u304b\u305d\u3046\u3044\u3046\u306e\u3092\u6c17\u306b\u305b\u305a\u5024\u3060\u3051\u62fe\u3046\u306e\u3067\u3001\u5dee\u5206\u8a08\u7b97\u306a\u3069\u306f\n\u5225\u9014fluentd\u306e\u30d5\u30a3\u30eb\u30bf\u306a\u3069\u3082\u3057\u304f\u306f\u30c7\u30fc\u30bf\u30b9\u30c8\u30a2\u5074\u304c\u51e6\u7406\u3067\u304d\u308c\u3070\u30ab\u30a6\u30f3\u30bf\u5024\u3068\u3057\u3066\u653e\u308a\u8fbc\u3080\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\nPrometheus\nExporter\u3067\u5bfe\u5fdc\u53ef\u80fd\u3067\u3059\u3002\n\u8a2d\u5b9a\u306f\nsnmp_exporter\u3068Prometheus\u3067\u305d\u308c\u305e\u308c\u884c\u3044\u307e\u3059\u3002\n\u30c7\u30fc\u30bf\u5b9a\u7fa9\u306fsnmp_exporter\u3001\u30dd\u30fc\u30ea\u30f3\u30b0\u8a2d\u5b9a\u306fPrometheus\u3067\u3059\u3002\nspecialnode:\n   version: 2\n   auth:\n      community: \"another_string\"\n   walk:\n      - 1.3.6.1.2.1.2\n      - 1.3.6.1.2.1.25.1.5\n   metrics:\n      - name: ifInOctets\n        oid: 1.3.6.1.2.1.2.2.1.10 \n        indexes:\n          - labelname: ifDescr\n            type: Integer32\n        lookups:\n          - labelname: ifDescr\n            oid: 1.3.6.1.2.1.2.2.1.2\n      - name: ifOutOctets\n        oid: 1.3.6.1.2.1.2.2.1.16 \n        indexes:\n          - labelname: ifDescr\n            type: Integer32\n        lookups:\n          - labelname: ifDescr\n            oid: 1.3.6.1.2.1.2.2.1.2\n      - name: hrSystemNumUsers\n        oid: 1.3.6.1.2.1.25.1.5 \n\n\u4ee5\u4e0a\u304csnmp_exporter\u5074\u306e\u30c7\u30fc\u30bf\u5b9a\u7fa9\u3002\n\u3053\u3053\u3067\u306fspecialnode \u3068\u3044\u3046\u540d\u524d\u30671\u3064\u5b9a\u7fa9\u3057\u3066\u3044\u307e\u3059\u3002\n\u3053\u306e\u72b6\u614b\u3067\u3001snmp_exporter\u3092\u52d5\u304b\u3057\u3066\ncurl \"http://snmp_exporterhost:9116/snmp?targer=hostname&module=specialnode\"\n\u3068\u3084\u308b\u3068\u3001\u30c7\u30fc\u30bf\u304c\u62fe\u3048\u308b\u306e\u304c\u308f\u304b\u308a\u307e\u3059\u3002\nscrape_configs:\n  - job_name: 'snmp'\n    scrape_interval: 60s\n    target_groups:\n      - targets:\n        - 192.168.1.1\n    metrics_path: /snmp\n    params:\n      module: [specialnode]\n    relabel_configs:\n      - source_labels: [__address__]\n        target_label: __param_target\n      - source_labels: [__param_target]\n        target_label: instance\n      - target_label: __address__\n        replacement: 127.0.0.1:9116\n\nPrometheus\u5074\u3067\u306fjob\u3068\u3057\u3066\u767b\u9332\u3057\u3001Prometheus\u304b\u3089snmp_exporter\u306b\u5b9a\u671f\u7684\u306b\u30c7\u30fc\u30bf\u53ce\u96c6\u3057\u306b\u884c\u304d\u307e\u3059\u3002\nPrometheus\u3082fluentd\u3068\u540c\u69d8\u3001Counter\u30c7\u30fc\u30bf\u306b\u3064\u3044\u3066\u3001\u305d\u306e\u307e\u307e\u3060\u3068\u5dee\u5206\u8a08\u7b97\u306a\u3069\u3092\u884c\u3063\u3066\u304f\u308c\u306a\u3044\u305f\u3081\u3001\u52a0\u5de5\u3092\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\u304c\u3001\u305d\u306e\u3042\u305f\u308a\u306f\u307e\u3060\u8abf\u3079\u3066\u3044\u306a\u3044\u306e\u3067\u3069\u306e\u304f\u3089\u3044\u9762\u5012\u306a\u306e\u304b\u306f\u308f\u304b\u308a\u307e\u305b\u3093\u3002\n\nPrometheus\u3067\u306e\u5dee\u5206\u8a08\u7b97\nPrometheus\u3067\u306e\u5dee\u5206\u8a08\u7b97\u65b9\u6cd5\u3068\u3057\u3066\u306f\u3001rate\u3068\u3044\u3046\u96c6\u8a08\u95a2\u6570\u304c\u7528\u610f\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n\u4e0a\u8a18\u8a2d\u5b9a\u306b\u3066\u53ce\u96c6\u3059\u308b\u3068\u300160\u79d2\u3054\u3068\u306eifInOctets\u306a\u3069\u304c\u53ce\u96c6\u3055\u308c\u3066\u3044\u307e\u3059\u306e\u3067\u3001\nrate(IfInOctets[5m]) \u3068Graph\u306eExpression\u306b\u8a18\u8f09\u3059\u308b\u3068\u30015min\u3067\u306e\u5dee\u5206\u304c\u8868\u793a\u3055\u308c\u307e\u3059\n\u307e\u305f\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u306b\nrule_files:\n  - prometheus.rule\n\n\u3068\u53ce\u96c6\u30eb\u30fc\u30eb\u3092\u8a18\u8f09\u3059\u308b\u30d5\u30a1\u30a4\u30eb\u3092\u8a18\u8f09\u3057\u3001\u305d\u306e\u30d5\u30a1\u30a4\u30eb(prometheus.rule)\u306b\nifInOctets_5min_rate = rate(ifInOctets[5m])\n\n\u3068\u8a18\u8f09\u3059\u308b\u3068\u3001ifInOctets_5min_rate \u3068\u3044\u3046\u540d\u79f0\u30675\u5206\u306e\u5dee\u5206\u5024\u304c\u4fdd\u5b58\u3055\u308c\u307e\u3059\u3002\nrate\u306e\u8a08\u7b97\u306b\u306f2\u500b\u306e\u30c7\u30fc\u30bf\u304c\u5fc5\u8981\u306b\u306a\u308a\u307e\u3059\u306e\u3067\u30011min\u306e\u5dee\u5206\u5024\u3092\u8a08\u7b97\u3057\u3088\u3046\u3068\u601d\u3046\u3068\u3001scrape_interval = 30s\u3068\u3059\u308b\u306a\u3069\u3001\u4f55\u3089\u304b\u306e\u624b\u5f53\u3066\u304c\u5fc5\u8981\u3067\u3059\u3002\nifInbps_5min_average = rate(ifInOctets[5m])*8/300\n\n\u3053\u306e\u3088\u3046\u306bbps\u8a08\u7b97\u3055\u305b\u308b\u3053\u3068\u3082\u3067\u304d\u307e\u3059\u3002\n\n\u304a\u308f\u308a\u306b\nSNMP\u3092\u5229\u7528\u3057\u305f\u30e2\u30cb\u30bf\u30ea\u30f3\u30b0\u306b\u5fc5\u8981\u306a\u8a2d\u5b9a\u306e\u5dee\u3092\u78ba\u8a8d\u3057\u307e\u3057\u305f\u3002\n\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u306e\u8a18\u8ff0\u306e\u9762\u5012\u304f\u3055\u3055\u3068\u3044\u3046\u610f\u5473\u3067\u306ffluentd\u5358\u4f53\u3067\u306f\u3053\u306e\u7528\u9014\u306b\u4f7f\u3046\u306e\u306f\u306a\u3093\u3060\u304b\u306a\u3041\uff1f\u3068\u3044\u3046\u611f\u3058\u304c\u3057\u307e\u3057\u305f\u3002\n\u3069\u306e\u307f\u3061\u305d\u3093\u306a\u306e\u30b8\u30a7\u30cd\u30ec\u30fc\u30bf\u4f5c\u308b\u304b\u3089\u4e00\u7dd2\u3067\u3057\u3087\uff1f\u3068\u8a00\u308f\u308c\u308c\u3070\u305d\u308c\u307e\u3067\u3067\u3059\u304c\u3002\n# \u306f\u3058\u3081\u306b\nSNMP\u3092\u5229\u7528\u3057\u305f\u30e2\u30cb\u30bf\u30ea\u30f3\u30b0\u306f\u6614\u304b\u3089\u884c\u308f\u308c\u3066\u3044\u3066\nMRTG Munin Cacti Zabbix \u306a\u3069\u306a\u3069\u3001\u3044\u304f\u3089\u3067\u3082\u30c4\u30fc\u30eb\u304c\u3042\u308a\u307e\u3059\u3088\u306d\u3002\n\u3067\u3082\u306a\u3093\u304b\u6700\u8fd1\u306f\u3084\u308a\u306eOSS\u306a\u30e2\u30cb\u30bf\u30ea\u30f3\u30b0\u30c4\u30fc\u30eb\u3067\u6c17\u8efd\u306b\u62fe\u3044\u305f\u3044\uff01\u3068\u304b\u601d\u3063\u305f\u306e\u3067\u8a66\u3057\u3066\u307f\u3088\u3046\u3068\u601d\u3063\u305f\u6b21\u7b2c\u3067\u3059\u3002\n\n\u5177\u4f53\u7684\u306b\u306f collectd, fluentd, prometheus \u3092\u6bd4\u3079\u3066\u307f\u307e\u3057\u305f\u3002\n\ncollectd, fluentd \u306f\u30c7\u30fc\u30bf\u3092\u30eb\u30fc\u30c6\u30a3\u30f3\u30b0\u3059\u308b\u3082\u306e\u306a\u306e\u3067\u3001\u30c7\u30fc\u30bf\u30b9\u30c8\u30a2\u3068\u3057\u3066graphite, influxdb\u306a\u3069\u3092\u5229\u7528\u3059\u308b\u3053\u3068\u3092\u60f3\u5b9a\u3057\u3066\u3044\u307e\u3059\u3002\n\u304c\u305d\u306e\u8a2d\u5b9a\u306f\u3068\u308a\u3042\u3048\u305a\u3053\u3053\u3067\u306f\u95a2\u4fc2\u304c\u306a\u3044\u306e\u3067\u8a18\u8f09\u3057\u3066\u3044\u307e\u305b\u3093\u3002\n\n## collectd\n\n[Plugin](https://collectd.org/wiki/index.php/Plugin:SNMP)\u3067\u5bfe\u5fdc\u53ef\u80fd\u3067\u3059\u3002\n\u8a2d\u5b9a\u306f\n\n```\nLoadPlugin snmp\n<Plugin snmp>\n  <Data \"dataname\">\n    Type \"tipename\"\n    Table true\n    Instance \"IF-MIB::ifDescr\"\n    Values \"IF-MIB::ifInOctets\" \"IF-MIB::ifOutOctets\"\n  </Data>\n  <Data \"dataname\">\n    Type \"users\" \n    Table false\n    Instance \"\"\n    Shift -1\n    Values \"HOST-RESOURCES-MIB::hrSystemNumUsers.0\"\n  </Data>\n  <Host \"Hostname\">\n    Address \"192.168.1.1\"\n    Version 2\n    Interval 60\n    Community \"another_string\"\n    Collect \"dataname\" \"dataname\" \"dataname\"\n  </Host>\n</Plugin>\n```\nPlugin\u306e\u8aad\u307f\u8fbc\u307f\u3001\n\u30c7\u30fc\u30bf\u306e\u5b9a\u7fa9\u3001(index\u3082\u306e\u306a\u3089Table true)Instance\u3067\u6307\u5b9a\u3057\u305f\u3082\u306e\u304cindex\u540d\u3068\u3057\u3066\u4f7f\u7528\u3055\u308c\u308b\n\u30db\u30b9\u30c8\u306e\u5b9a\u7fa9 (\u53ce\u96c6\u3059\u308b\u30c7\u30fc\u30bf\u306e\u6307\u5b9a)\n\u307f\u305f\u3044\u306a\u5f62\u3067\u3059\u3002\n\u30c7\u30fc\u30bf\u5b9a\u7fa9\u3068\u30db\u30b9\u30c8\u306e\u5b9a\u7fa9\u304c\u5206\u304b\u308c\u3066\u3044\u308b\u306e\u3067\u3001\u8a2d\u5b9a\u306f\u305d\u3053\u307e\u3067\u591a\u304f\u5897\u3048\u307e\u305b\u3093\u3002\n\u305f\u3060\u3001\u30c7\u30fc\u30bf\u5b9a\u7fa9\u3092\u30b0\u30eb\u30fc\u30d4\u30f3\u30b0\u3057\u305f\u308a\u3067\u304d\u306a\u3044(?)\u306e\u3067\u3001\n\u30db\u30b9\u30c8\u306e Collect \u304c\u3059\u3054\u304f\u3001\u9577\u304f\u306a\u308b\u53ef\u80fd\u6027\u306f\u3042\u308a\u307e\u3059\u3002\n\n\n## fluentd\n[Plugin](https://rubygems.org/gems/fluent-plugin-snmp/)\u3067\u5bfe\u5fdc\u53ef\u80fd\u3067\u3059\u3002\n\u8a2d\u5b9a\u306f\n\n```\n<source>\n  type snmp\n  tag snmp.hostname\n  host \"192.168.1.1\"\n  Community \"another_string\"\n  mib ifDescr, ifInOctets, ifOutOctets\n  method_type walk\n  polling_time 1\n  out_executor \"/path/of/exec.rb\"\n</source>\n<source>\n  type snmp\n  tag snmp.hostname\n  host \"192.168.1.1\"\n  Community \"another_string\"\n  mib \"hrSystemNumUsers.0\"\n  method_type get\n</source>\n```\n\u30db\u30b9\u30c8\u540d\u3068\u30c7\u30fc\u30bf\u306e\u5b9a\u7fa9 \u3092\u30bb\u30c3\u30c8\u3067\u884c\u3046\u306e\u3067\u3001\n\u53ce\u96c6\u3057\u305f\u3044\u30c7\u30fc\u30bf\u3068\u30db\u30b9\u30c8\u304c\u591a\u304f\u306a\u308b\u3068\u3001source\u5b9a\u7fa9\u304c\u3069\u3093\u3069\u3093\u5897\u3048\u3066\u3044\u304d\u307e\u3059\u3002\n\u3064\u3089\u3044\u3002\n\u4f55\u3082\u3057\u306a\u3044\u3068\u53ce\u96c6\u3057\u305f\u30c7\u30fc\u30bf\u306fValue={Name=hoge,Value=fuga} \u306e\u3088\u3046\u306a\u5f62\u3067\u5c4a\u304f\u306e\u3067\nexec.rb \u3092\u7528\u610f\u3057\u3066\u52a0\u5de5\u3057\u306a\u3044\u3068\u3064\u3089\u3044\u304b\u3082\u3002\n\ninterface\u306f ifDescr.ifInOctets=value, ifDescr.ifOutOctets=value\u306e\u3088\u3046\u306b\u52a0\u5de5\u3057\u3066\u5410\u304d\u51fa\u3059\u3088\u3046\u306b\u3057\u3066\u307f\u307e\u3057\u305f\u3002\u4e0b\u8a18\n\n```\nmodule Fluent\n  class SnmpInput\n    def out_exec manager, opts={}\n      manager.walk(opts[:mib]) do |row|\n        time = Time.now.to_i\n        time = time - time  % 5\n        record = {}\n        data = {}\n        row.each do |vb|\n          data[\"name\"] = vb.value.to_s if vb.name.to_s =~ /Descr/\n          data[\"InOctets\"] = vb.value.to_s if vb.name.to_s =~ /InOctets/\n          data[\"OutOctets\"] = vb.value.to_s if vb.name.to_s =~ /OutOctets/\n        end\n        if data.has_key?(\"name\")\n          record[\"#{data['name']}.InOctets\"] = data[\"InOctets\"] if data.has_key?(\"InOctets\")\n          record[\"#{data['name']}.OutOctets\"] = data[\"OutOctets\"] if data.has_key?(\"OutOctets\")\n        end\n        if record\n          router.emit opts[:tag], time, record\n        end\n      end\n    end\n  end\nend\n```\n\u307e\u305f\u53ce\u96c6\u30c7\u30fc\u30bf\u30bf\u30a4\u30d7\u304c\u30ab\u30a6\u30f3\u30bf\u3060\u3068\u304b\u305d\u3046\u3044\u3046\u306e\u3092\u6c17\u306b\u305b\u305a\u5024\u3060\u3051\u62fe\u3046\u306e\u3067\u3001\u5dee\u5206\u8a08\u7b97\u306a\u3069\u306f\n\u5225\u9014fluentd\u306e\u30d5\u30a3\u30eb\u30bf\u306a\u3069\u3082\u3057\u304f\u306f\u30c7\u30fc\u30bf\u30b9\u30c8\u30a2\u5074\u304c\u51e6\u7406\u3067\u304d\u308c\u3070\u30ab\u30a6\u30f3\u30bf\u5024\u3068\u3057\u3066\u653e\u308a\u8fbc\u3080\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\n## Prometheus\n[Exporter](https://github.com/prometheus/snmp_exporter)\u3067\u5bfe\u5fdc\u53ef\u80fd\u3067\u3059\u3002\n\u8a2d\u5b9a\u306f\nsnmp_exporter\u3068Prometheus\u3067\u305d\u308c\u305e\u308c\u884c\u3044\u307e\u3059\u3002\n\u30c7\u30fc\u30bf\u5b9a\u7fa9\u306fsnmp_exporter\u3001\u30dd\u30fc\u30ea\u30f3\u30b0\u8a2d\u5b9a\u306fPrometheus\u3067\u3059\u3002\n\n```\nspecialnode:\n   version: 2\n   auth:\n      community: \"another_string\"\n   walk:\n      - 1.3.6.1.2.1.2\n      - 1.3.6.1.2.1.25.1.5\n   metrics:\n      - name: ifInOctets\n        oid: 1.3.6.1.2.1.2.2.1.10 \n        indexes:\n          - labelname: ifDescr\n            type: Integer32\n        lookups:\n          - labelname: ifDescr\n            oid: 1.3.6.1.2.1.2.2.1.2\n      - name: ifOutOctets\n        oid: 1.3.6.1.2.1.2.2.1.16 \n        indexes:\n          - labelname: ifDescr\n            type: Integer32\n        lookups:\n          - labelname: ifDescr\n            oid: 1.3.6.1.2.1.2.2.1.2\n      - name: hrSystemNumUsers\n        oid: 1.3.6.1.2.1.25.1.5 \n```\n\u4ee5\u4e0a\u304csnmp_exporter\u5074\u306e\u30c7\u30fc\u30bf\u5b9a\u7fa9\u3002\n\u3053\u3053\u3067\u306fspecialnode \u3068\u3044\u3046\u540d\u524d\u30671\u3064\u5b9a\u7fa9\u3057\u3066\u3044\u307e\u3059\u3002\n\n\u3053\u306e\u72b6\u614b\u3067\u3001snmp_exporter\u3092\u52d5\u304b\u3057\u3066\ncurl \"http://snmp_exporterhost:9116/snmp?targer=hostname&module=specialnode\"\n\u3068\u3084\u308b\u3068\u3001\u30c7\u30fc\u30bf\u304c\u62fe\u3048\u308b\u306e\u304c\u308f\u304b\u308a\u307e\u3059\u3002\n\n```\nscrape_configs:\n  - job_name: 'snmp'\n    scrape_interval: 60s\n    target_groups:\n      - targets:\n        - 192.168.1.1\n    metrics_path: /snmp\n    params:\n      module: [specialnode]\n    relabel_configs:\n      - source_labels: [__address__]\n        target_label: __param_target\n      - source_labels: [__param_target]\n        target_label: instance\n      - target_label: __address__\n        replacement: 127.0.0.1:9116\n```\n\nPrometheus\u5074\u3067\u306fjob\u3068\u3057\u3066\u767b\u9332\u3057\u3001Prometheus\u304b\u3089snmp_exporter\u306b\u5b9a\u671f\u7684\u306b\u30c7\u30fc\u30bf\u53ce\u96c6\u3057\u306b\u884c\u304d\u307e\u3059\u3002\nPrometheus\u3082fluentd\u3068\u540c\u69d8\u3001Counter\u30c7\u30fc\u30bf\u306b\u3064\u3044\u3066\u3001\u305d\u306e\u307e\u307e\u3060\u3068\u5dee\u5206\u8a08\u7b97\u306a\u3069\u3092\u884c\u3063\u3066\u304f\u308c\u306a\u3044\u305f\u3081\u3001\u52a0\u5de5\u3092\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\u304c\u3001\u305d\u306e\u3042\u305f\u308a\u306f\u307e\u3060\u8abf\u3079\u3066\u3044\u306a\u3044\u306e\u3067\u3069\u306e\u304f\u3089\u3044\u9762\u5012\u306a\u306e\u304b\u306f\u308f\u304b\u308a\u307e\u305b\u3093\u3002\n\n### Prometheus\u3067\u306e\u5dee\u5206\u8a08\u7b97\nPrometheus\u3067\u306e\u5dee\u5206\u8a08\u7b97\u65b9\u6cd5\u3068\u3057\u3066\u306f\u3001rate\u3068\u3044\u3046\u96c6\u8a08\u95a2\u6570\u304c\u7528\u610f\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n\u4e0a\u8a18\u8a2d\u5b9a\u306b\u3066\u53ce\u96c6\u3059\u308b\u3068\u300160\u79d2\u3054\u3068\u306eifInOctets\u306a\u3069\u304c\u53ce\u96c6\u3055\u308c\u3066\u3044\u307e\u3059\u306e\u3067\u3001\nrate(IfInOctets[5m]) \u3068Graph\u306eExpression\u306b\u8a18\u8f09\u3059\u308b\u3068\u30015min\u3067\u306e\u5dee\u5206\u304c\u8868\u793a\u3055\u308c\u307e\u3059\n\u307e\u305f\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u306b\n\n```\nrule_files:\n  - prometheus.rule\n```\n\u3068\u53ce\u96c6\u30eb\u30fc\u30eb\u3092\u8a18\u8f09\u3059\u308b\u30d5\u30a1\u30a4\u30eb\u3092\u8a18\u8f09\u3057\u3001\u305d\u306e\u30d5\u30a1\u30a4\u30eb(prometheus.rule)\u306b\n\n```\nifInOctets_5min_rate = rate(ifInOctets[5m])\n```\n\u3068\u8a18\u8f09\u3059\u308b\u3068\u3001`ifInOctets_5min_rate` \u3068\u3044\u3046\u540d\u79f0\u30675\u5206\u306e\u5dee\u5206\u5024\u304c\u4fdd\u5b58\u3055\u308c\u307e\u3059\u3002\nrate\u306e\u8a08\u7b97\u306b\u306f2\u500b\u306e\u30c7\u30fc\u30bf\u304c\u5fc5\u8981\u306b\u306a\u308a\u307e\u3059\u306e\u3067\u30011min\u306e\u5dee\u5206\u5024\u3092\u8a08\u7b97\u3057\u3088\u3046\u3068\u601d\u3046\u3068\u3001`scrape_interval = 30s`\u3068\u3059\u308b\u306a\u3069\u3001\u4f55\u3089\u304b\u306e\u624b\u5f53\u3066\u304c\u5fc5\u8981\u3067\u3059\u3002\n\n```\nifInbps_5min_average = rate(ifInOctets[5m])*8/300\n```\n\u3053\u306e\u3088\u3046\u306bbps\u8a08\u7b97\u3055\u305b\u308b\u3053\u3068\u3082\u3067\u304d\u307e\u3059\u3002\n\n# \u304a\u308f\u308a\u306b\nSNMP\u3092\u5229\u7528\u3057\u305f\u30e2\u30cb\u30bf\u30ea\u30f3\u30b0\u306b\u5fc5\u8981\u306a\u8a2d\u5b9a\u306e\u5dee\u3092\u78ba\u8a8d\u3057\u307e\u3057\u305f\u3002\n\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u306e\u8a18\u8ff0\u306e\u9762\u5012\u304f\u3055\u3055\u3068\u3044\u3046\u610f\u5473\u3067\u306ffluentd\u5358\u4f53\u3067\u306f\u3053\u306e\u7528\u9014\u306b\u4f7f\u3046\u306e\u306f\u306a\u3093\u3060\u304b\u306a\u3041\uff1f\u3068\u3044\u3046\u611f\u3058\u304c\u3057\u307e\u3057\u305f\u3002\n\u3069\u306e\u307f\u3061\u305d\u3093\u306a\u306e\u30b8\u30a7\u30cd\u30ec\u30fc\u30bf\u4f5c\u308b\u304b\u3089\u4e00\u7dd2\u3067\u3057\u3087\uff1f\u3068\u8a00\u308f\u308c\u308c\u3070\u305d\u308c\u307e\u3067\u3067\u3059\u304c\u3002\n\n", "tags": ["snmp", "collectd", "fluentd", "prometheus"]}