{"tags": ["cognito", "Ruby", "STS"], "context": " More than 1 year has passed since last update.\n\nCognito\u3068\u306f\n\u3053\u306e\u8a18\u4e8b\u304c\u4e00\u756a\u308f\u304b\u308a\u3084\u3059\u304b\u3063\u305f\u3002\nhttp://qiita.com/imaifactory/items/b66cdf91118e3be6fe17\n\n\u524d\u63d0\n\n\ntest.png \u304c\u304a\u3044\u3066\u3042\u308b\nARN\uff08arn:aws:iam::00000000000:role/Cognito_photo1Auth_DefaultRole\uff09\u306bS3\u306e\u64cd\u4f5c\u6a29\u9650\u3092\u8a2d\u5b9a\u3057\u3066\u3042\u308b\n\n\nARN\n{\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [{\n        \"Action\": [\n            \"mobileanalytics:PutEvents\",\n            \"cognito-sync:*\",\n            \"s3:*\"\n        ],\n        \"Effect\": \"Allow\",\n        \"Resource\": [\n            \"*\"\n        ]\n    }]\n}\n\n\n\n\u5b9f\u88c5\n\ncognito.rb\nrequire 'aws-sdk'\n\n# Cognito\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u3092\u4f5c\u6210\u3059\u308b\ncognito_identity = Aws::CognitoIdentity::Client.new(\n    region: 'us-east-1',\n    access_key_id: 'ACCESS KEY',\n    secret_access_key: 'SECRET ACCESS KEY'\n  )\n\n# developer identity\u3067\u30ed\u30b0\u30a4\u30f3\u51e6\u7406\u3092\u884c\u3046\nresp = cognito_identity.get_open_id_token_for_developer_identity(\n    identity_pool_id: 'us-east-1:00000000-0000-0000-0000-000000000000',\n    logins: { 'com.yujiroarai.provider' => 'abcde' }\n  )\n\nputs \"Identity ID: #{resp.identity_id}\"\nputs \"Access Token: #{resp.token}\"\n\n# STS\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u3092\u4f5c\u6210\u3059\u308b\nsts = Aws::STS::Client.new(\n    region: 'ap-northeast-1',\n    access_key_id: 'ACCESS KEY',\n    secret_access_key: 'SECRET ACCESS KEY'\n  )\n\n# STS\u3092\u4f7f\u3063\u3066\u3001\u53d6\u5f97\u3059\u308b\u30a2\u30af\u30bb\u30b9\u6a29\u3092\u5b9a\u7fa9\n# user1\u4ee5\u4e0b\u306e\u64cd\u4f5c\u3092\u8a31\u3059\npolicy = JSON.generate(\n      'Version' => '2012-10-17',\n      'Statement' => [{\n        'Effect' => 'Allow',\n        'Action' =>  '*',\n        'Resource' => 'arn:aws:s3:::s3upload-sample/user1/*'\n      }]\n    )\n\n# Cognito\u3067\u53d6\u5f97\u3057\u305f\u30a2\u30af\u30bb\u30b9\u30c8\u30fc\u30af\u30f3\u3092\u4f7f\u3063\u3066\u3001STS\u3067\u30a2\u30af\u30bb\u30b9\u6a29\u3092\u53d6\u5f97\u3059\u308b\nr = sts.assume_role_with_web_identity(\n    role_arn: 'arn:aws:iam::00000000000:role/Cognito_photo1Auth_DefaultRole',\n    web_identity_token: resp.token,\n    role_session_name: 'session_name',\n    policy: policy\n  )\n\n# STS\u3067\u53d6\u5f97\u3057\u305f\u30af\u30ec\u30c7\u30f3\u30b7\u30e3\u30eb\u60c5\u5831\u3092\u4f7f\u3063\u3066\u3001S3\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u3092\u4f5c\u6210\u3059\u308b\ns3 = Aws::S3::Client.new(\n  region: 'ap-northeast-1',\n  credentials: r.credentials,\n  http_wire_trace: true\n)\n\n# \u30d5\u30a1\u30a4\u30eb\u3092\u8aad\u307f\u8fbc\u307f\nfile_open = File.open('test.png')\n\n# \u30d5\u30a1\u30a4\u30eb\u3092\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u3059\u308b\ns3.put_object(\n    bucket: 's3upload-sample',\n    body: file_open,\n    key: 'user1/test.png'\n)\n\n\n\n## Cognito\u3068\u306f\n\n\u3053\u306e\u8a18\u4e8b\u304c\u4e00\u756a\u308f\u304b\u308a\u3084\u3059\u304b\u3063\u305f\u3002\nhttp://qiita.com/imaifactory/items/b66cdf91118e3be6fe17\n\n## \u524d\u63d0\n\n- ````test.png```` \u304c\u304a\u3044\u3066\u3042\u308b\n- ARN\uff08arn:aws:iam::00000000000:role/Cognito_photo1Auth_DefaultRole\uff09\u306bS3\u306e\u64cd\u4f5c\u6a29\u9650\u3092\u8a2d\u5b9a\u3057\u3066\u3042\u308b\n\n````json:ARN\n{\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [{\n        \"Action\": [\n            \"mobileanalytics:PutEvents\",\n            \"cognito-sync:*\",\n            \"s3:*\"\n        ],\n        \"Effect\": \"Allow\",\n        \"Resource\": [\n            \"*\"\n        ]\n    }]\n}\n````\n\n## \u5b9f\u88c5\n\n````ruby:cognito.rb\nrequire 'aws-sdk'\n\n# Cognito\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u3092\u4f5c\u6210\u3059\u308b\ncognito_identity = Aws::CognitoIdentity::Client.new(\n    region: 'us-east-1',\n    access_key_id: 'ACCESS KEY',\n    secret_access_key: 'SECRET ACCESS KEY'\n  )\n\n# developer identity\u3067\u30ed\u30b0\u30a4\u30f3\u51e6\u7406\u3092\u884c\u3046\nresp = cognito_identity.get_open_id_token_for_developer_identity(\n    identity_pool_id: 'us-east-1:00000000-0000-0000-0000-000000000000',\n    logins: { 'com.yujiroarai.provider' => 'abcde' }\n  )\n\nputs \"Identity ID: #{resp.identity_id}\"\nputs \"Access Token: #{resp.token}\"\n\n# STS\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u3092\u4f5c\u6210\u3059\u308b\nsts = Aws::STS::Client.new(\n    region: 'ap-northeast-1',\n    access_key_id: 'ACCESS KEY',\n    secret_access_key: 'SECRET ACCESS KEY'\n  )\n\n# STS\u3092\u4f7f\u3063\u3066\u3001\u53d6\u5f97\u3059\u308b\u30a2\u30af\u30bb\u30b9\u6a29\u3092\u5b9a\u7fa9\n# user1\u4ee5\u4e0b\u306e\u64cd\u4f5c\u3092\u8a31\u3059\npolicy = JSON.generate(\n      'Version' => '2012-10-17',\n      'Statement' => [{\n        'Effect' => 'Allow',\n        'Action' =>  '*',\n        'Resource' => 'arn:aws:s3:::s3upload-sample/user1/*'\n      }]\n    )\n\n# Cognito\u3067\u53d6\u5f97\u3057\u305f\u30a2\u30af\u30bb\u30b9\u30c8\u30fc\u30af\u30f3\u3092\u4f7f\u3063\u3066\u3001STS\u3067\u30a2\u30af\u30bb\u30b9\u6a29\u3092\u53d6\u5f97\u3059\u308b\nr = sts.assume_role_with_web_identity(\n    role_arn: 'arn:aws:iam::00000000000:role/Cognito_photo1Auth_DefaultRole',\n    web_identity_token: resp.token,\n    role_session_name: 'session_name',\n    policy: policy\n  )\n\n# STS\u3067\u53d6\u5f97\u3057\u305f\u30af\u30ec\u30c7\u30f3\u30b7\u30e3\u30eb\u60c5\u5831\u3092\u4f7f\u3063\u3066\u3001S3\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u3092\u4f5c\u6210\u3059\u308b\ns3 = Aws::S3::Client.new(\n  region: 'ap-northeast-1',\n  credentials: r.credentials,\n  http_wire_trace: true\n)\n\n# \u30d5\u30a1\u30a4\u30eb\u3092\u8aad\u307f\u8fbc\u307f\nfile_open = File.open('test.png')\n\n# \u30d5\u30a1\u30a4\u30eb\u3092\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u3059\u308b\ns3.put_object(\n    bucket: 's3upload-sample',\n    body: file_open,\n    key: 'user1/test.png'\n)\n````\n"}