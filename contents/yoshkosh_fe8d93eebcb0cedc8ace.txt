{"context": " More than 1 year has passed since last update.\n\n\u306f\u3058\u3081\u306b\ncrash \u30b3\u30de\u30f3\u30c9\u3092\u4f7f\u3063\u305f Linux kernel \u306e vmcore \u306e\u89e3\u6790\u65b9\u6cd5\u306b\u3064\u3044\u3066\u307e\u3068\u3081\u3066\u898b\u307e\u3057\u305f\u3002\n\u691c\u8a3c\u306b\u4f7f\u3063\u305f OS \u306f\u3001CentOS 6 \u3067\u3059\u3002\n\ncrash \u30b3\u30de\u30f3\u30c9\u3068\u306f\nvmcore \u306e\u89e3\u6790\u306b\u4f7f\u3046\u30c7\u30d0\u30c3\u30b0\u7528\u306e\u30c4\u30fc\u30eb\u3067\u3059\u3002gdb \u306e\u30b3\u30de\u30f3\u30c9\u304c\uff08\u305d\u306e\u307e\u307e\u3060\u3044\u305f\u3044\uff09\u4f7f\u3048\u307e\u3059\u3002\n\u8a73\u3057\u304f\u306f\u30b0\u30b0\u3063\u3066\u304f\u3060\u3055\u3044\u3002\n\nvmcore \u306e\u53d6\u5f97\u65b9\u6cd5\nkdump \u304c\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u3057\u3066\u3042\u308c\u3070\u3001kernel \u304c\u30af\u30e9\u30c3\u30b7\u30e5\u3057\u305f\u3068\u304d\u306b\u306f\u81ea\u52d5\u3067 vmcore \u3092\u4fdd\u5b58\u3067\u304d\u307e\u3059\u3002\u4fdd\u5b58\u5148\u306f\u3001\u30ed\u30fc\u30ab\u30eb\u30c7\u30a3\u30b9\u30af\u3084 NFS\u3001SSH \u3067\u306e\u30ea\u30e2\u30fc\u30c8\u30db\u30b9\u30c8\u306a\u3069\u3044\u308d\u3044\u308d\u8a2d\u5b9a\u3067\u304d\u307e\u3059\u3002\n# chkconfig kdump on\n# service kdump restart\n\nvmcore \u53d6\u5f97\u306e\u305f\u3081\u306b\u306f\u3001OS \u3092\u30af\u30e9\u30c3\u30b7\u30e5\u3055\u305b\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002OS \u304c\u30af\u30e9\u30c3\u30b7\u30e5\u3059\u308b\u30c8\u30ea\u30ac\u30fc\u306f\u8272\u3005\u8a2d\u5b9a\u3067\u304d\u307e\u3059\u304c\u3001\u3053\u3053\u3067\u306f\u4ee5\u4e0b\u306e\u72b6\u6cc1\u3067\u30af\u30e9\u30c3\u30b7\u30e5\u3055\u305b\u308b\u3088\u3046\u306b\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\n/etc/sysctl.conf\n\n\uff08\u4ee5\u4e0b\u306e\u8a2d\u5b9a\u3092\u8ffd\u52a0\u3059\u308b\u3068\u3001hung_task \u304c\u767a\u751f\u3057\u305f\u969b\u306b\u3001OS \u3092\u30af\u30e9\u30c3\u30b7\u30e5\u3055\u305b\u307e\u3059\u3002\uff09\nkernel.hung_task_panic = 1\n\n\uff08\u4ee5\u4e0b\u306e\u8a2d\u5b9a\u3092\u8ffd\u52a0\u3059\u308b\u3068\u3001OOM \u304c\u767a\u751f\u3057\u305f\u969b\u306b\u3001OS \u3092\u30af\u30e9\u30c3\u30b7\u30e5\u3055\u305b\u307e\u3059\u3002\uff09\nvm.panic_on_oom = 1\n\n\uff08\u4ee5\u4e0b\u306e\u8a2d\u5b9a\u3092\u8ffd\u52a0\u3059\u308b\u3068\u3001softlockup \u304c\u767a\u751f\u3057\u305f\u969b\u306b\u3001OS \u3092\u30af\u30e9\u30c3\u30b7\u30e5\u3055\u305b\u307e\u3059\u3002\uff09\nkernel.softlockup_panic = 1\n\n\u4ee5\u4e0b\u306e\u30b3\u30de\u30f3\u30c9\u3067\u8a2d\u5b9a\u3092\u53cd\u6620\u3055\u305b\u307e\u3059\u3002\n# sysctl -p\n\n\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\u958b\u767a\u7cfb\u306e\u30c4\u30fc\u30eb\u4e00\u5f0f\u306f\u5165\u308c\u3066\u304a\u304d\u307e\u3059\u3002\n# yum groupinstall \"Development Tools\"\n\n\u4ee5\u4e0b\u3067\u30c6\u30b9\u30c8\u7528\u306b\u30c7\u30d0\u30a4\u30b9\u30c9\u30e9\u30a4\u30d0\u306a\u3069\u3092\u4f5c\u6210\u3059\u308b\u306e\u3067\u305d\u308c\u306b\u5fc5\u8981\u306a\u30d1\u30c3\u30b1\u30fc\u30b8\u3082\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n# yum install yum-utils kernel-devel kernel-headers\n\ncrash \u30b3\u30de\u30f3\u30c9\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u307e\u3059\u3002\n# yum install crash\n\ncrash \u30b3\u30de\u30f3\u30c9\u3067\u30b3\u30a2\u89e3\u6790\u3059\u308b\u306b\u306f\u3001kernel \u306e\u30c7\u30d0\u30c3\u30b0\u30d1\u30c3\u30b1\u30fc\u30b8\u3082\u5fc5\u8981\u306a\u306e\u3067\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n# debuginfo-install kernel\n\n\n\u30c7\u30d0\u30a4\u30b9\u30c9\u30e9\u30a4\u30d0\u306e\u4f5c\u6210\n\u30c6\u30b9\u30c8\u7528\u306b\u308f\u3056\u3068\u30cf\u30f3\u30b0\u3059\u308b\u30c7\u30d0\u30a4\u30b9\u30c9\u30e9\u30a4\u30d0\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\ndevone.c\n\n/*\n * devone.c\n *\n */\n#include <linux/init.h>\n#include <linux/module.h>\n#include <linux/types.h>\n#include <linux/kernel.h>\n#include <linux/fs.h>\n#include <linux/cdev.h>\n#include <asm/uaccess.h>\n\nMODULE_LICENSE(\"Dual BSD/GPL\");\n\nstatic int devone_devs = 1;        /* device count */\nstatic int devone_major = 0;       /* dynamic allocation */\nstatic int devone_minor = 0;       \nstatic struct cdev devone_cdev;  \n\nssize_t devone_read(struct file *filp, char __user *buf, size_t count, loff_t *f_pos)\n{\n    int i;\n    unsigned char val = 0xff;\n    int retval;\n\n    msleep(180000);         /* \u308f\u3056\u3068 180\u79d2\u30b9\u30ea\u30fc\u30d7\u3059\u308b */\n\n    for (i = 0 ; i < count ; i++) {\n        if (copy_to_user(&buf[i], &val, 1)) {\n            retval = -EFAULT;\n            goto out;\n        }\n    }\n\n    retval = count;\nout:\n    return (retval);\n}\n\nstruct file_operations devone_fops = {\n    .read = devone_read,\n};\n\nstatic int devone_init(void)\n{\n    dev_t dev = MKDEV(devone_major, 0);\n    int alloc_ret = 0;\n    int major;\n    int cdev_err = 0;\n\n    alloc_ret = alloc_chrdev_region(&dev, 0, devone_devs, \"devone\");\n    if (alloc_ret)\n        goto error;\n    devone_major = major = MAJOR(dev);\n\n    cdev_init(&devone_cdev, &devone_fops);\n    devone_cdev.owner = THIS_MODULE;\n    devone_cdev.ops = &devone_fops;\n    cdev_err = cdev_add(&devone_cdev, MKDEV(devone_major, devone_minor), 1);\n    if (cdev_err) \n        goto error;\n\n    printk(KERN_ALERT \"devone driver(major %d) installed.\\n\", major);\n\n    return 0;\n\nerror:\n    if (cdev_err == 0)\n        cdev_del(&devone_cdev);\n\n    if (alloc_ret == 0)\n        unregister_chrdev_region(dev, devone_devs);\n\n    return -1;\n}\n\nstatic void devone_exit(void)\n{\n    dev_t dev = MKDEV(devone_major, 0);\n\n    cdev_del(&devone_cdev);\n    unregister_chrdev_region(dev, devone_devs);\n\n    printk(KERN_ALERT \"devone driver removed.\\n\");\n\n}\n\nmodule_init(devone_init);\nmodule_exit(devone_exit);\n\n\nMakefile\n\nobj-m := devone.o\n\nall:\n    make -C /lib/modules/$(shell uname -r)/build M=$(PWD) modules\n\nclean:\n    make -C /lib/modules/$(shell uname -r)/build M=$(PWD) clean\n\n\u30b3\u30f3\u30d1\u30a4\u30eb\u3057\u3066\u30c7\u30d0\u30a4\u30b9\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n# make\n\uff08devone.ko \u304c\u3067\u304d\u3042\u304c\u308a\u307e\u3059\u3002\uff09\n\n# insmod devone.ko\n\uff08\u3067\u304d\u3042\u304c\u3063\u305f kernel \u30e2\u30b8\u30e5\u30fc\u30eb\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u307e\u3059\u3002\uff09\n\n# lsmod | grep devone\n\n# grep devone /proc/devices \n\uff08devone \u306e\u30e1\u30b8\u30e3\u30fc\u756a\u53f7\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\u4f8b 247 \uff09\n\n# mknod /dev/devone c 247 0\n\uff08\u30c7\u30d0\u30a4\u30b9\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\uff09\n\n# ls -l /dev/devone\n\n\u3053\u308c\u3067\u3001/dev/devone \u30d5\u30a1\u30a4\u30eb\u3092\u8aad\u307f\u8fbc\u3082\u3046\u3068\u3059\u308b\u3068 180\u79d2\u9593\u30cf\u30f3\u30b0\u3057\u307e\u3059\u3002\n\nOS \u3092\u30af\u30e9\u30c3\u30b7\u30e5\u3055\u305b\u308b\n\n\u30d7\u30ed\u30bb\u30b9\u3092\u30cf\u30f3\u30b0\u3055\u305b\u308b\n\u308f\u3056\u3068\u3001/dev/devone \u3092\u8aad\u307f\u8fbc\u3093\u3067 hung_task \u3092\u767a\u751f\u3055\u305b\u307e\u3059\u3002\n# dd if=/dev/devone of=/dev/null count=1 bs=1\n\nhung_task \u304c\u767a\u751f\u3057\u3066\u3001OS \u304c\u30af\u30e9\u30c3\u30b7\u30e5\u3057\u3066\u3001vmcore \u304c\u3067\u304d\u3042\u304c\u308a\u307e\u3057\u305f\u3002\u30c7\u30d5\u30a9\u30eb\u30c8\u306e\u8a2d\u5b9a\u306e\u307e\u307e\u3067\u3059\u306e\u3067\u3001\u300c/var/crash\u300d\u4ee5\u4e0b\u306b\u3067\u304d\u3042\u304c\u308a\u307e\u3059\u3002\n# ls -l /var/crash/\n\n\nOOM \u3092\u767a\u751f\u3055\u305b\u308b\n\u9069\u5f53\u306a perl \u30b9\u30af\u30ea\u30d7\u30c8\u306a\u3069\u3067\u30e1\u30e2\u30ea\u3092\u5f90\u3005\u306b\u304b\u3064\u5927\u91cf\u306b\u6d88\u8cbb\u3055\u305b\u307e\u3059\u3002\n\ntest.pl\n\n#!/usr/bin/perl\n\nuse strict;\n\nmy $i;\nwhile(1){\n    $i .= \"a\"x10000000;\n}\n\nOOM \u304c\u767a\u751f\u3057\u3066\u3001OS \u304c\u30af\u30e9\u30c3\u30b7\u30e5\u3057\u3066\u3001vmcore \u304c\u3067\u304d\u3042\u304c\u308a\u307e\u3057\u305f\u3002\n# ls -l /var/crash/\n\n\n\nvmcore \u89e3\u6790\n\nhung_task \u306e\u5834\u5408\n\u300ccrash \u30d0\u30a4\u30ca\u30ea vmcore\u300d\u3092\u5b9f\u884c\u3057\u3066\u3001crash \u3092\u8d77\u52d5\u3059\u308b\u3002\n# cd /var/crash/127.0.0.1-2015-12-20-17:24:43/\n# crash /usr/lib/debug/lib/modules/2.6.32-573.12.1.el6.x86_64/vmlinux  vmcore\n\nsys \u30b3\u30de\u30f3\u30c9\u3067\u3001\u30b7\u30b9\u30c6\u30e0\u95a2\u9023\u306e\u60c5\u5831\u3092\u8868\u793a\u3002panic \u306e\u30e1\u30c3\u30bb\u30fc\u30b8\u3082\u898b\u308c\u308b\u3002\ncrash> sys\n      KERNEL: /usr/lib/debug/lib/modules/2.6.32-573.12.1.el6.x86_64/vmlinux\n    DUMPFILE: vmcore  [PARTIAL DUMP]\n        CPUS: 3\n        DATE: Sun Dec 20 17:24:40 2015\n      UPTIME: 00:03:12\nLOAD AVERAGE: 0.62, 0.19, 0.06\n       TASKS: 120\n    NODENAME: centos6a.kinoshiy\n     RELEASE: 2.6.32-573.12.1.el6.x86_64\n     VERSION: #1 SMP Tue Dec 15 21:19:08 UTC 2015\n     MACHINE: x86_64  (997 Mhz)\n      MEMORY: 2 GB\n       PANIC: \"Kernel panic - not syncing: hung_task: blocked tasks\"\n\nhung_task \u304c\u539f\u56e0\u3060\u3068\u308f\u304b\u308b\u3002\nlog \u30b3\u30de\u30f3\u30c9\u3067\u3001kernel \u306e\u30e1\u30c3\u30bb\u30fc\u30b8\u30d0\u30c3\u30d5\u30a1\u30fc\u306e\u5185\u5bb9\u3092\u8868\u793a\u3059\u308b\u3002\ncrash> log\n... snip ...\nINFO: task dd:1521 blocked for more than 120 seconds.\n      Not tainted 2.6.32-573.12.1.el6.x86_64 #1\n\"echo 0 > /proc/sys/kernel/hung_task_timeout_secs\" disables this message.\ndd            D 0000000000000002     0  1521   1449 0x00000080\n ffff880078e3fdd8 0000000000000082 0000000000000000 ffff88007e560108\n ffff880078e3fd88 ffffffff8118ecf7 000000208c45c069 ffff880037434880\n ffff880037b696c0 00000000fffd8e34 ffff880037783ad8 ffff880078e3ffd8\nCall Trace:\n [<ffffffff8118ecf7>] ? __dentry_open+0x257/0x380\n [<ffffffff815397b2>] schedule_timeout+0x192/0x2e0\n [<ffffffff81089be0>] ? process_timeout+0x0/0x10\n [<ffffffff8153991e>] schedule_timeout_uninterruptible+0x1e/0x20\n [<ffffffff8108bd40>] msleep+0x20/0x30\n [<ffffffffa0312148>] devone_read+0x28/0x90 [devone]\n [<ffffffff81191abd>] ? rw_verify_area+0x5d/0xc0\n [<ffffffff81192315>] vfs_read+0xb5/0x1a0\n [<ffffffff811930c6>] ? fget_light_pos+0x16/0x50\n [<ffffffff81192661>] sys_read+0x51/0xb0\n [<ffffffff8100b0d2>] system_call_fastpath+0x16/0x1b\nKernel panic - not syncing: hung_task: blocked tasks\nPid: 58, comm: khungtaskd Not tainted 2.6.32-573.12.1.el6.x86_64 #1\nCall Trace:\n [<ffffffff81538231>] ? panic+0xa7/0x16f\n [<ffffffff810ecd34>] ? watchdog+0x254/0x290\n [<ffffffff810ecae0>] ? watchdog+0x0/0x290\n [<ffffffff810a0fce>] ? kthread+0x9e/0xc0\n [<ffffffff8100c28a>] ? child_rip+0xa/0x20\n [<ffffffff810a0f30>] ? kthread+0x0/0xc0\n [<ffffffff8100c280>] ? child_rip+0x0/0x20\n\n\nPID 1521 \u306e dd \u30b3\u30de\u30f3\u30c9\u304c\u30cf\u30f3\u30b0\u3057\u3066\u3044\u305f\u306e\u304c\u308f\u304b\u308b\u3002\ndevone \u30e2\u30b8\u30e5\u30fc\u30eb\u5185\u3067\u30cf\u30f3\u30b0\u3057\u3066\u3044\u308b\u306e\u304c\u308f\u304b\u308b\u3002\nps \u30b3\u30de\u30f3\u30c9\u3067\u30d7\u30ed\u30bb\u30b9\u306e\u72b6\u6cc1\u3092\u78ba\u8a8d\u3002 \u300cUN\u300d\uff08uninterruptible\uff09\u306e\u72b6\u614b\u3060\u3063\u305f\u3068\u308f\u304b\u308b\u3002\ncrash> ps 1521\n   PID    PPID  CPU       TASK        ST  %MEM     VSZ    RSS  COMM\n   1521   1449   2  ffff880037783520  UN   0.0  105176    720  dd\n\nset \u30b3\u30de\u30f3\u30c9\u3067\u3001\u30ab\u30ec\u30f3\u30c8\u30b3\u30f3\u30c6\u30af\u30b9\u30c8\u3092\u4efb\u610f\u306e\u30d7\u30ed\u30bb\u30b9\u306b\u5207\u308a\u66ff\u3048\u3001files \u30b3\u30de\u30f3\u30c9\u3067\u305d\u306e\u30d7\u30ed\u30bb\u30b9\u304c\u30aa\u30fc\u30d7\u30f3\u3057\u3066\u3044\u308b\u30d5\u30a1\u30a4\u30eb\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\ncrash> set 1521\n    PID: 1521\nCOMMAND: \"dd\"\n   TASK: ffff880037783520  [THREAD_INFO: ffff880078e3c000]\n    CPU: 2\n  STATE: TASK_UNINTERRUPTIBLE \ncrash> files\nPID: 1521   TASK: ffff880037783520  CPU: 2   COMMAND: \"dd\"\nROOT: /    CWD: /root/git/samples/kernel/devone-cdev_add\n FD       FILE            DENTRY           INODE       TYPE PATH\n  0 ffff8800377805c0 ffff880075d1ef00 ffff880037e8c418 CHR  /dev/devone\n  1 ffff8800377809c0 ffff88007eb435c0 ffff88007e560108 CHR  /dev/null\n  2 ffff880037493280 ffff880075ccbd80 ffff88007eb64c98 CHR  /dev/pts/0\n\n\u30cf\u30f3\u30b0\u3057\u3066\u3044\u305f\u30d7\u30ed\u30bb\u30b9\u306f\u3001/dev/devone \u3092\u30a2\u30af\u30bb\u30b9\u3057\u3066\u3044\u305f\u3068\u308f\u304b\u308b\u3002\n/dev/devone \u304c\u602a\u3057\u3044\u3002\n\nOOM \u306e\u5834\u5408\n\u300ccrash \u30d0\u30a4\u30ca\u30ea vmcore\u300d\u3092\u5b9f\u884c\u3057\u3066\u3001crash \u3092\u8d77\u52d5\u3059\u308b\u3002\n# cd /var/crash/127.0.0.1-2015-12-20-18:23:16\n# crash /usr/lib/debug/lib/modules/2.6.32-573.12.1.el6.x86_64/vmlinux  vmcore\n\ncrash> sys\n... snip ...\n       PANIC: \"Kernel panic - not syncing: Out of memory: system-wide panic_on_oom is enabled\"\n\nOOM \u304c\u539f\u56e0\u3067\u30af\u30e9\u30c3\u30b7\u30e5\u3057\u305f\u3068\u308f\u304b\u308b\u3002\ncrash> ps\n   PID    PPID  CPU       TASK        ST  %MEM     VSZ    RSS  COMM\n... snip ...\n   1581   1578   2  ffff880037720040  IN   0.0  108304    244  bash\n>  1632   1552   2  ffff8800379baab0  RU  77.8 3715784 1631992  test.pl\n   1633   1581   1  ffff88003798a040  IN   0.0   15024    328  top\n\ntest.pl \u304c\u300177.8% \u306e\u30e1\u30e2\u30ea\u3092\u6d88\u8cbb\u3057\u3066\u3044\u308b\u3002 test.pl \u304c\u602a\u3057\u3044\u3002\n\n\n\u53c2\u8003\u6587\u732e\n\nhttp://people.redhat.com/anderson/crash_whitepaper/\nLinux\u30c7\u30d0\u30a4\u30b9\u30c9\u30e9\u30a4\u30d0\u30d7\u30ed\u30b0\u30e9\u30df\u30f3\u30b0 http://www.amazon.co.jp/dp/4797346426\n\n\n# \u306f\u3058\u3081\u306b\n\n`crash` \u30b3\u30de\u30f3\u30c9\u3092\u4f7f\u3063\u305f Linux kernel \u306e vmcore \u306e\u89e3\u6790\u65b9\u6cd5\u306b\u3064\u3044\u3066\u307e\u3068\u3081\u3066\u898b\u307e\u3057\u305f\u3002\n\u691c\u8a3c\u306b\u4f7f\u3063\u305f OS \u306f\u3001CentOS 6 \u3067\u3059\u3002\n\n# `crash` \u30b3\u30de\u30f3\u30c9\u3068\u306f\nvmcore \u306e\u89e3\u6790\u306b\u4f7f\u3046\u30c7\u30d0\u30c3\u30b0\u7528\u306e\u30c4\u30fc\u30eb\u3067\u3059\u3002`gdb` \u306e\u30b3\u30de\u30f3\u30c9\u304c\uff08\u305d\u306e\u307e\u307e\u3060\u3044\u305f\u3044\uff09\u4f7f\u3048\u307e\u3059\u3002\n\u8a73\u3057\u304f\u306f\u30b0\u30b0\u3063\u3066\u304f\u3060\u3055\u3044\u3002\n\n# `vmcore` \u306e\u53d6\u5f97\u65b9\u6cd5\n`kdump` \u304c\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u3057\u3066\u3042\u308c\u3070\u3001kernel \u304c\u30af\u30e9\u30c3\u30b7\u30e5\u3057\u305f\u3068\u304d\u306b\u306f\u81ea\u52d5\u3067 vmcore \u3092\u4fdd\u5b58\u3067\u304d\u307e\u3059\u3002\u4fdd\u5b58\u5148\u306f\u3001\u30ed\u30fc\u30ab\u30eb\u30c7\u30a3\u30b9\u30af\u3084 NFS\u3001SSH \u3067\u306e\u30ea\u30e2\u30fc\u30c8\u30db\u30b9\u30c8\u306a\u3069\u3044\u308d\u3044\u308d\u8a2d\u5b9a\u3067\u304d\u307e\u3059\u3002\n\n~~~\n# chkconfig kdump on\n# service kdump restart\n~~~\n\nvmcore \u53d6\u5f97\u306e\u305f\u3081\u306b\u306f\u3001OS \u3092\u30af\u30e9\u30c3\u30b7\u30e5\u3055\u305b\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002OS \u304c\u30af\u30e9\u30c3\u30b7\u30e5\u3059\u308b\u30c8\u30ea\u30ac\u30fc\u306f\u8272\u3005\u8a2d\u5b9a\u3067\u304d\u307e\u3059\u304c\u3001\u3053\u3053\u3067\u306f\u4ee5\u4e0b\u306e\u72b6\u6cc1\u3067\u30af\u30e9\u30c3\u30b7\u30e5\u3055\u305b\u308b\u3088\u3046\u306b\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\n- /etc/sysctl.conf\n\n~~~\n\uff08\u4ee5\u4e0b\u306e\u8a2d\u5b9a\u3092\u8ffd\u52a0\u3059\u308b\u3068\u3001hung_task \u304c\u767a\u751f\u3057\u305f\u969b\u306b\u3001OS \u3092\u30af\u30e9\u30c3\u30b7\u30e5\u3055\u305b\u307e\u3059\u3002\uff09\nkernel.hung_task_panic = 1\n\n\uff08\u4ee5\u4e0b\u306e\u8a2d\u5b9a\u3092\u8ffd\u52a0\u3059\u308b\u3068\u3001OOM \u304c\u767a\u751f\u3057\u305f\u969b\u306b\u3001OS \u3092\u30af\u30e9\u30c3\u30b7\u30e5\u3055\u305b\u307e\u3059\u3002\uff09\nvm.panic_on_oom = 1\n\n\uff08\u4ee5\u4e0b\u306e\u8a2d\u5b9a\u3092\u8ffd\u52a0\u3059\u308b\u3068\u3001softlockup \u304c\u767a\u751f\u3057\u305f\u969b\u306b\u3001OS \u3092\u30af\u30e9\u30c3\u30b7\u30e5\u3055\u305b\u307e\u3059\u3002\uff09\nkernel.softlockup_panic = 1\n~~~\n\n\u4ee5\u4e0b\u306e\u30b3\u30de\u30f3\u30c9\u3067\u8a2d\u5b9a\u3092\u53cd\u6620\u3055\u305b\u307e\u3059\u3002\n\n~~~\n# sysctl -p\n~~~\n\n\n# \u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\u958b\u767a\u7cfb\u306e\u30c4\u30fc\u30eb\u4e00\u5f0f\u306f\u5165\u308c\u3066\u304a\u304d\u307e\u3059\u3002\n\n~~~\n# yum groupinstall \"Development Tools\"\n~~~\n\n\u4ee5\u4e0b\u3067\u30c6\u30b9\u30c8\u7528\u306b\u30c7\u30d0\u30a4\u30b9\u30c9\u30e9\u30a4\u30d0\u306a\u3069\u3092\u4f5c\u6210\u3059\u308b\u306e\u3067\u305d\u308c\u306b\u5fc5\u8981\u306a\u30d1\u30c3\u30b1\u30fc\u30b8\u3082\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\n~~~\n# yum install yum-utils kernel-devel kernel-headers\n~~~\n\n`crash` \u30b3\u30de\u30f3\u30c9\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u307e\u3059\u3002\n\n~~~\n# yum install crash\n~~~\n\ncrash \u30b3\u30de\u30f3\u30c9\u3067\u30b3\u30a2\u89e3\u6790\u3059\u308b\u306b\u306f\u3001kernel \u306e\u30c7\u30d0\u30c3\u30b0\u30d1\u30c3\u30b1\u30fc\u30b8\u3082\u5fc5\u8981\u306a\u306e\u3067\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\n~~~\n# debuginfo-install kernel\n~~~\n\n\n# \u30c7\u30d0\u30a4\u30b9\u30c9\u30e9\u30a4\u30d0\u306e\u4f5c\u6210\n\u30c6\u30b9\u30c8\u7528\u306b\u308f\u3056\u3068\u30cf\u30f3\u30b0\u3059\u308b\u30c7\u30d0\u30a4\u30b9\u30c9\u30e9\u30a4\u30d0\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n- devone.c\n\n~~~\n/*\n * devone.c\n *\n */\n#include <linux/init.h>\n#include <linux/module.h>\n#include <linux/types.h>\n#include <linux/kernel.h>\n#include <linux/fs.h>\n#include <linux/cdev.h>\n#include <asm/uaccess.h>\n\nMODULE_LICENSE(\"Dual BSD/GPL\");\n\nstatic int devone_devs = 1;        /* device count */\nstatic int devone_major = 0;       /* dynamic allocation */\nstatic int devone_minor = 0;       \nstatic struct cdev devone_cdev;  \n\nssize_t devone_read(struct file *filp, char __user *buf, size_t count, loff_t *f_pos)\n{\n\tint i;\n\tunsigned char val = 0xff;\n\tint retval;\n\n\tmsleep(180000);         /* \u308f\u3056\u3068 180\u79d2\u30b9\u30ea\u30fc\u30d7\u3059\u308b */\n\n\tfor (i = 0 ; i < count ; i++) {\n\t\tif (copy_to_user(&buf[i], &val, 1)) {\n\t\t\tretval = -EFAULT;\n\t\t\tgoto out;\n\t\t}\n\t}\n\n\tretval = count;\nout:\n\treturn (retval);\n}\n\nstruct file_operations devone_fops = {\n\t.read = devone_read,\n};\n\nstatic int devone_init(void)\n{\n\tdev_t dev = MKDEV(devone_major, 0);\n\tint alloc_ret = 0;\n\tint major;\n\tint cdev_err = 0;\n\n\talloc_ret = alloc_chrdev_region(&dev, 0, devone_devs, \"devone\");\n\tif (alloc_ret)\n\t\tgoto error;\n\tdevone_major = major = MAJOR(dev);\n\n\tcdev_init(&devone_cdev, &devone_fops);\n\tdevone_cdev.owner = THIS_MODULE;\n\tdevone_cdev.ops = &devone_fops;\n\tcdev_err = cdev_add(&devone_cdev, MKDEV(devone_major, devone_minor), 1);\n\tif (cdev_err) \n\t\tgoto error;\n\n\tprintk(KERN_ALERT \"devone driver(major %d) installed.\\n\", major);\n\n\treturn 0;\n\nerror:\n\tif (cdev_err == 0)\n\t\tcdev_del(&devone_cdev);\n\n\tif (alloc_ret == 0)\n\t\tunregister_chrdev_region(dev, devone_devs);\n\n\treturn -1;\n}\n\nstatic void devone_exit(void)\n{\n\tdev_t dev = MKDEV(devone_major, 0);\n\n\tcdev_del(&devone_cdev);\n\tunregister_chrdev_region(dev, devone_devs);\n\n\tprintk(KERN_ALERT \"devone driver removed.\\n\");\n\n}\n\nmodule_init(devone_init);\nmodule_exit(devone_exit);\n~~~\n\n- Makefile\n\n~~~\nobj-m := devone.o\n\nall:\n\tmake -C /lib/modules/$(shell uname -r)/build M=$(PWD) modules\n\nclean:\n\tmake -C /lib/modules/$(shell uname -r)/build M=$(PWD) clean\n~~~\n\n\u30b3\u30f3\u30d1\u30a4\u30eb\u3057\u3066\u30c7\u30d0\u30a4\u30b9\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n~~~\n# make\n\uff08devone.ko \u304c\u3067\u304d\u3042\u304c\u308a\u307e\u3059\u3002\uff09\n\n# insmod devone.ko\n\uff08\u3067\u304d\u3042\u304c\u3063\u305f kernel \u30e2\u30b8\u30e5\u30fc\u30eb\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u307e\u3059\u3002\uff09\n\n# lsmod | grep devone\n\n# grep devone /proc/devices \n\uff08devone \u306e\u30e1\u30b8\u30e3\u30fc\u756a\u53f7\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\u4f8b 247 \uff09\n\n# mknod /dev/devone c 247 0\n\uff08\u30c7\u30d0\u30a4\u30b9\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\uff09\n\n# ls -l /dev/devone\n~~~\n\n\u3053\u308c\u3067\u3001/dev/devone \u30d5\u30a1\u30a4\u30eb\u3092\u8aad\u307f\u8fbc\u3082\u3046\u3068\u3059\u308b\u3068 180\u79d2\u9593\u30cf\u30f3\u30b0\u3057\u307e\u3059\u3002\n\n\n\n# OS \u3092\u30af\u30e9\u30c3\u30b7\u30e5\u3055\u305b\u308b\n\n## \u30d7\u30ed\u30bb\u30b9\u3092\u30cf\u30f3\u30b0\u3055\u305b\u308b\n\u308f\u3056\u3068\u3001/dev/devone \u3092\u8aad\u307f\u8fbc\u3093\u3067 hung_task \u3092\u767a\u751f\u3055\u305b\u307e\u3059\u3002\n\n~~~\n# dd if=/dev/devone of=/dev/null count=1 bs=1\n~~~\n\nhung_task \u304c\u767a\u751f\u3057\u3066\u3001OS \u304c\u30af\u30e9\u30c3\u30b7\u30e5\u3057\u3066\u3001vmcore \u304c\u3067\u304d\u3042\u304c\u308a\u307e\u3057\u305f\u3002\u30c7\u30d5\u30a9\u30eb\u30c8\u306e\u8a2d\u5b9a\u306e\u307e\u307e\u3067\u3059\u306e\u3067\u3001\u300c/var/crash\u300d\u4ee5\u4e0b\u306b\u3067\u304d\u3042\u304c\u308a\u307e\u3059\u3002\n\n~~~\n# ls -l /var/crash/\n~~~\n\n\n## OOM \u3092\u767a\u751f\u3055\u305b\u308b\n\u9069\u5f53\u306a perl \u30b9\u30af\u30ea\u30d7\u30c8\u306a\u3069\u3067\u30e1\u30e2\u30ea\u3092\u5f90\u3005\u306b\u304b\u3064\u5927\u91cf\u306b\u6d88\u8cbb\u3055\u305b\u307e\u3059\u3002\n\n- test.pl\n\n~~~\n#!/usr/bin/perl\n\nuse strict;\n\nmy $i;\nwhile(1){\n\t$i .= \"a\"x10000000;\n}\n~~~\n\nOOM \u304c\u767a\u751f\u3057\u3066\u3001OS \u304c\u30af\u30e9\u30c3\u30b7\u30e5\u3057\u3066\u3001vmcore \u304c\u3067\u304d\u3042\u304c\u308a\u307e\u3057\u305f\u3002\n\n~~~\n# ls -l /var/crash/\n~~~\n\n---\n\n# vmcore \u89e3\u6790\n\n## hung_task \u306e\u5834\u5408\n\u300ccrash \u30d0\u30a4\u30ca\u30ea vmcore\u300d\u3092\u5b9f\u884c\u3057\u3066\u3001crash \u3092\u8d77\u52d5\u3059\u308b\u3002\n\n~~~\n# cd /var/crash/127.0.0.1-2015-12-20-17:24:43/\n# crash /usr/lib/debug/lib/modules/2.6.32-573.12.1.el6.x86_64/vmlinux  vmcore\n~~~\n\n`sys` \u30b3\u30de\u30f3\u30c9\u3067\u3001\u30b7\u30b9\u30c6\u30e0\u95a2\u9023\u306e\u60c5\u5831\u3092\u8868\u793a\u3002panic \u306e\u30e1\u30c3\u30bb\u30fc\u30b8\u3082\u898b\u308c\u308b\u3002\n\n~~~\ncrash> sys\n      KERNEL: /usr/lib/debug/lib/modules/2.6.32-573.12.1.el6.x86_64/vmlinux\n    DUMPFILE: vmcore  [PARTIAL DUMP]\n        CPUS: 3\n        DATE: Sun Dec 20 17:24:40 2015\n      UPTIME: 00:03:12\nLOAD AVERAGE: 0.62, 0.19, 0.06\n       TASKS: 120\n    NODENAME: centos6a.kinoshiy\n     RELEASE: 2.6.32-573.12.1.el6.x86_64\n     VERSION: #1 SMP Tue Dec 15 21:19:08 UTC 2015\n     MACHINE: x86_64  (997 Mhz)\n      MEMORY: 2 GB\n       PANIC: \"Kernel panic - not syncing: hung_task: blocked tasks\"\n~~~\n`hung_task` \u304c\u539f\u56e0\u3060\u3068\u308f\u304b\u308b\u3002\n\n`log` \u30b3\u30de\u30f3\u30c9\u3067\u3001kernel \u306e\u30e1\u30c3\u30bb\u30fc\u30b8\u30d0\u30c3\u30d5\u30a1\u30fc\u306e\u5185\u5bb9\u3092\u8868\u793a\u3059\u308b\u3002\n\n~~~\ncrash> log\n... snip ...\nINFO: task dd:1521 blocked for more than 120 seconds.\n      Not tainted 2.6.32-573.12.1.el6.x86_64 #1\n\"echo 0 > /proc/sys/kernel/hung_task_timeout_secs\" disables this message.\ndd            D 0000000000000002     0  1521   1449 0x00000080\n ffff880078e3fdd8 0000000000000082 0000000000000000 ffff88007e560108\n ffff880078e3fd88 ffffffff8118ecf7 000000208c45c069 ffff880037434880\n ffff880037b696c0 00000000fffd8e34 ffff880037783ad8 ffff880078e3ffd8\nCall Trace:\n [<ffffffff8118ecf7>] ? __dentry_open+0x257/0x380\n [<ffffffff815397b2>] schedule_timeout+0x192/0x2e0\n [<ffffffff81089be0>] ? process_timeout+0x0/0x10\n [<ffffffff8153991e>] schedule_timeout_uninterruptible+0x1e/0x20\n [<ffffffff8108bd40>] msleep+0x20/0x30\n [<ffffffffa0312148>] devone_read+0x28/0x90 [devone]\n [<ffffffff81191abd>] ? rw_verify_area+0x5d/0xc0\n [<ffffffff81192315>] vfs_read+0xb5/0x1a0\n [<ffffffff811930c6>] ? fget_light_pos+0x16/0x50\n [<ffffffff81192661>] sys_read+0x51/0xb0\n [<ffffffff8100b0d2>] system_call_fastpath+0x16/0x1b\nKernel panic - not syncing: hung_task: blocked tasks\nPid: 58, comm: khungtaskd Not tainted 2.6.32-573.12.1.el6.x86_64 #1\nCall Trace:\n [<ffffffff81538231>] ? panic+0xa7/0x16f\n [<ffffffff810ecd34>] ? watchdog+0x254/0x290\n [<ffffffff810ecae0>] ? watchdog+0x0/0x290\n [<ffffffff810a0fce>] ? kthread+0x9e/0xc0\n [<ffffffff8100c28a>] ? child_rip+0xa/0x20\n [<ffffffff810a0f30>] ? kthread+0x0/0xc0\n [<ffffffff8100c280>] ? child_rip+0x0/0x20\n\n~~~\nPID 1521 \u306e `dd` \u30b3\u30de\u30f3\u30c9\u304c\u30cf\u30f3\u30b0\u3057\u3066\u3044\u305f\u306e\u304c\u308f\u304b\u308b\u3002\n`devone` \u30e2\u30b8\u30e5\u30fc\u30eb\u5185\u3067\u30cf\u30f3\u30b0\u3057\u3066\u3044\u308b\u306e\u304c\u308f\u304b\u308b\u3002\n\n`ps` \u30b3\u30de\u30f3\u30c9\u3067\u30d7\u30ed\u30bb\u30b9\u306e\u72b6\u6cc1\u3092\u78ba\u8a8d\u3002 \u300cUN\u300d\uff08uninterruptible\uff09\u306e\u72b6\u614b\u3060\u3063\u305f\u3068\u308f\u304b\u308b\u3002\n\n~~~\ncrash> ps 1521\n   PID    PPID  CPU       TASK        ST  %MEM     VSZ    RSS  COMM\n   1521   1449   2  ffff880037783520  UN   0.0  105176    720  dd\n~~~\n\n`set` \u30b3\u30de\u30f3\u30c9\u3067\u3001\u30ab\u30ec\u30f3\u30c8\u30b3\u30f3\u30c6\u30af\u30b9\u30c8\u3092\u4efb\u610f\u306e\u30d7\u30ed\u30bb\u30b9\u306b\u5207\u308a\u66ff\u3048\u3001`files` \u30b3\u30de\u30f3\u30c9\u3067\u305d\u306e\u30d7\u30ed\u30bb\u30b9\u304c\u30aa\u30fc\u30d7\u30f3\u3057\u3066\u3044\u308b\u30d5\u30a1\u30a4\u30eb\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n~~~\ncrash> set 1521\n    PID: 1521\nCOMMAND: \"dd\"\n   TASK: ffff880037783520  [THREAD_INFO: ffff880078e3c000]\n    CPU: 2\n  STATE: TASK_UNINTERRUPTIBLE \ncrash> files\nPID: 1521   TASK: ffff880037783520  CPU: 2   COMMAND: \"dd\"\nROOT: /    CWD: /root/git/samples/kernel/devone-cdev_add\n FD       FILE            DENTRY           INODE       TYPE PATH\n  0 ffff8800377805c0 ffff880075d1ef00 ffff880037e8c418 CHR  /dev/devone\n  1 ffff8800377809c0 ffff88007eb435c0 ffff88007e560108 CHR  /dev/null\n  2 ffff880037493280 ffff880075ccbd80 ffff88007eb64c98 CHR  /dev/pts/0\n~~~\n\n\u30cf\u30f3\u30b0\u3057\u3066\u3044\u305f\u30d7\u30ed\u30bb\u30b9\u306f\u3001`/dev/devone` \u3092\u30a2\u30af\u30bb\u30b9\u3057\u3066\u3044\u305f\u3068\u308f\u304b\u308b\u3002\n\n`/dev/devone` \u304c\u602a\u3057\u3044\u3002\n\n\n\n## OOM \u306e\u5834\u5408\n\u300ccrash \u30d0\u30a4\u30ca\u30ea vmcore\u300d\u3092\u5b9f\u884c\u3057\u3066\u3001crash \u3092\u8d77\u52d5\u3059\u308b\u3002\n\n~~~\n# cd /var/crash/127.0.0.1-2015-12-20-18:23:16\n# crash /usr/lib/debug/lib/modules/2.6.32-573.12.1.el6.x86_64/vmlinux  vmcore\n~~~\n\n~~~\ncrash> sys\n... snip ...\n       PANIC: \"Kernel panic - not syncing: Out of memory: system-wide panic_on_oom is enabled\"\n~~~\n\nOOM \u304c\u539f\u56e0\u3067\u30af\u30e9\u30c3\u30b7\u30e5\u3057\u305f\u3068\u308f\u304b\u308b\u3002\n\n~~~\ncrash> ps\n   PID    PPID  CPU       TASK        ST  %MEM     VSZ    RSS  COMM\n... snip ...\n   1581   1578   2  ffff880037720040  IN   0.0  108304    244  bash\n>  1632   1552   2  ffff8800379baab0  RU  77.8 3715784 1631992  test.pl\n   1633   1581   1  ffff88003798a040  IN   0.0   15024    328  top\n~~~\n\ntest.pl \u304c\u300177.8% \u306e\u30e1\u30e2\u30ea\u3092\u6d88\u8cbb\u3057\u3066\u3044\u308b\u3002 test.pl \u304c\u602a\u3057\u3044\u3002\n\n\n---\n# \u53c2\u8003\u6587\u732e\n- http://people.redhat.com/anderson/crash_whitepaper/\n- Linux\u30c7\u30d0\u30a4\u30b9\u30c9\u30e9\u30a4\u30d0\u30d7\u30ed\u30b0\u30e9\u30df\u30f3\u30b0 http://www.amazon.co.jp/dp/4797346426\n", "tags": ["Linux", "kernel", "crash"]}