{"tags": ["Node.js", "route53", "docker", "DDNS"], "context": "\n\n\u524d\u63d0\u6761\u4ef6\n\nRoute53\u3067HostedZone\u3092\u767b\u9332\u3057\u3066\u3042\u308b\n\u305d\u306eZONE_ID\u3092\u53d6\u5f97\u3057\u3066\u3042\u308b\n\u305d\u306eHostedZone\u3092\u64cd\u4f5c\u3059\u308b\u6a29\u9650\u3092\u6301\u3064IAM\u30e6\u30fc\u30b6\u3092\u4f5c\u6210\u3057\u3066\u3042\u308b\nIAM\u30e6\u30fc\u30b6\u306e\u30a2\u30af\u30bb\u30b9\u30ad\u30fc\u3068\u30b7\u30fc\u30af\u30ec\u30c3\u30c8\u30ad\u30fc\u3092\u53d6\u5f97\u3057\u3066\u3042\u308b\n\n\u5fc5\u8981\u306a\u6a29\u9650\u306f\u4e0b\u8a18\u306e\u901a\u308a\u3067\u3059\u3002Action\u306f4\u3064\u3001Resource\u306fHostedZone\u3092\u6307\u5b9a\u3057\u307e\u3059\u3002\n{\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [\n        {\n            \"Effect\": \"Allow\",\n            \"Action\": [\n                \"route53:GetHostedZone\",\n                \"route53:ListResourceRecordSets\",\n                \"route53:ChangeResourceRecordSets\",\n                \"route53:GetChange\"\n            ],\n            \"Resource\": [\n                \"arn:aws:route53:::hostedzone/Z1XUEXAMPLEWR1\"\n            ]\n        }\n    ]\n}\n\n\nID\u3068\u30ad\u30fc\u3092\u4fdd\u5b58\u3057\u305f\u74b0\u5883\u5909\u6570\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3059\u308b\nDDNS\u3092\u5b9f\u73fe\u3059\u308b\u306b\u306f HostedZone\u306eZONE_ID\u3001IAM\u30e6\u30fc\u30b6\u306e\u30a2\u30af\u30bb\u30b9\u30ad\u30fc\u3068\u30b7\u30fc\u30af\u30ec\u30c3\u30c8\u30ad\u30fc\u3092\u30b9\u30af\u30ea\u30d7\u30c8\u5185\u3067\u53c2\u7167\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\u3053\u308c\u3089\u3092\u30cf\u30fc\u30c9\u30b3\u30fc\u30c7\u30a3\u30f3\u30b0\u3057\u305f\u304f\u306a\u3044\u306e\u3067\u3001\u74b0\u5883\u5909\u6570\u3068\u3057\u3066\u6e21\u3059\u305f\u3081\u306e\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\n.api_keys\n# DDNS \nROUTE53_ZONE_ID=Z1XUEXAMPLEWR1\nIAM_DDNS_KEY=AEXAMPLEEXAMPLEU3C7Q\nIAM_DDNS_SECRET=YxEXAMPLEEXAMPLEEXAMPLEEXAMPLEEXAMPLEYss\n\n\n\nDocker\u30b3\u30f3\u30c6\u30ca\u3092\u4f5c\u6210\u3059\u308b\nNode.js\u304c\u52d5\u3051\u3070\u306a\u3093\u3067\u3082\u3088\u3044\u306e\u3067\u3059\u304c\u3001Docker\u3067\u6e96\u5099\u3059\u308b\u306e\u304c\u697d\u306a\u306e\u3067\u305d\u306e\u3088\u3046\u306b\u3057\u307e\u3059\u3002\n\nDockerfile\nFROM node:latest\nMAINTAINER flny flny@example.com\n\nRUN npm install nice-route53 \\\n                external-ip\nCMD /bin/bash\n\n\nRoute53\u3092\u64cd\u4f5c\u3059\u308b\u305f\u3081\u306b nice-route53 \u3092\u3001\u81ea\u8eab\u306e\u30b0\u30ed\u30fc\u30d0\u30ebIP\u3092\u77e5\u308b\u305f\u3081\u306b external-ip \u3092 \u305d\u308c\u305e\u308cnpm\u3067\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3066\u3044\u307e\u3059\u3002\ndocker build \u3068 docker run\u3067Node.js\u304c\u52d5\u4f5c\u3059\u308b\u30b3\u30f3\u30c6\u30ca\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n$ docker build -t ddns <Dockerfile\u306e\u3042\u308b\u30c7\u30a3\u30ec\u30af\u30c8\u30ea>\n$ docker run -itd --env-file .api_keys --name ddns ddns\n\n\n\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u8a18\u8ff0\u3059\u308b\n\nsendDdns.js\n#!/usr/bin/env node\n\nvar ExtIP = require('external-ip'),\n    Route53 = require('nice-route53')\n;\n\nvar configMap = {\n        zoneId  : process.env.ROUTE53_ZONE_ID,\n        iam_key : process.env.IAM_DDNS_KEY,\n        iam_sec : process.env.IAM_DDNS_SECRET,\n    },\n    getIP = new ExtIP(),\n    r53 = new Route53(\n        {accessKeyId :     configMap.iam_key,\n         secretAccessKey : configMap.iam_sec}\n        ),\n    onReceiveIp, sendRecord\n;\n\n\nsendRecord = function(ip) {\n    var aRec = {\n        zoneId : configMap.zoneId,\n        name   : 'foo.example.com.',\n        type   : 'A',\n        ttl    : 3600,\n        values : [ip]\n    };\n    console.log(aRec);\n    r53.setRecord(aRec, function(err, res) {\n        if(err) throw err;\n        console.log(res);\n    });\n\n};\n\n\nonReceiveIp = function(err, ip) {\n    if(err) {\n        throw err;\n    }\n    sendRecord(ip)\n}\n\n\ngetIP(onReceiveIp);\n\n\n\ngetIP\u3067\u30b0\u30ed\u30fc\u30d0\u30ebIP\u30a2\u30c9\u30ec\u30b9\u3092\u53d6\u5f97\u3057\u3066\u3001\n\u305d\u308c\u3092\u5143\u306bA\u30ec\u30b3\u30fc\u30c9\u3092\u4f5c\u6210\u3057\u3001\nr53.setRecord\u3067A\u30ec\u30b3\u30fc\u30c9\u3092upsert\u3059\u308b\n\n\u3068\u3044\u3046\u6d41\u308c\u3067\u3059\u3002\u30d1\u30c3\u30b1\u30fc\u30b8\u306e\u304a\u304b\u3052\u3067\u697d\u3061\u3093\u3067\u3059\u306d\u3002\n\n\u52d5\u4f5c\u3092\u78ba\u8a8d\u3059\u308b\n# ./sendDdnsRec.js\n{ zoneId: 'Z1XUEXAMPLEWR1',\n  name: 'foo.example.com.',\n  type: 'A',\n  ttl: 3600,\n  values: [ '110.233.x.x' ] }\n{ changeId: 'C316EXAMPLE9ZO',\n  url: '/change/C316EXAMPLE9ZO',\n  status: 'PENDING',\n  submittedAt: Tue May 24 2016 15:47:34 GMT+0000 (UTC) }\n\n\u30b3\u30f3\u30c6\u30ca\u4e0a\u3067 \u30b9\u30af\u30ea\u30d7\u30c8\u3092\u5b9f\u884c\u3059\u308b\u3068\u3001\u3046\u307e\u304f\u3044\u3051\u3070 status: 'PENDING' \u306e\u30ec\u30b9\u30dd\u30f3\u30b9\u304c\u8fd4\u308a\u307e\u3059\u3002'PENDING'\u3068\u3044\u3046\u8a18\u8ff0\u3067\u3059\u304c A\u30ec\u30b3\u30fc\u30c9\u306f\u65e2\u306b\u767b\u9332\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n\u4ee5\u4e0a\n# \u524d\u63d0\u6761\u4ef6\n\n- Route53\u3067HostedZone\u3092\u767b\u9332\u3057\u3066\u3042\u308b\n- \u305d\u306eZONE_ID\u3092\u53d6\u5f97\u3057\u3066\u3042\u308b\n- \u305d\u306eHostedZone\u3092\u64cd\u4f5c\u3059\u308b\u6a29\u9650\u3092\u6301\u3064IAM\u30e6\u30fc\u30b6\u3092\u4f5c\u6210\u3057\u3066\u3042\u308b\n- IAM\u30e6\u30fc\u30b6\u306e\u30a2\u30af\u30bb\u30b9\u30ad\u30fc\u3068\u30b7\u30fc\u30af\u30ec\u30c3\u30c8\u30ad\u30fc\u3092\u53d6\u5f97\u3057\u3066\u3042\u308b\n\n\u5fc5\u8981\u306a\u6a29\u9650\u306f\u4e0b\u8a18\u306e\u901a\u308a\u3067\u3059\u3002Action\u306f4\u3064\u3001Resource\u306fHostedZone\u3092\u6307\u5b9a\u3057\u307e\u3059\u3002\n\n```json\n{\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [\n        {\n            \"Effect\": \"Allow\",\n            \"Action\": [\n                \"route53:GetHostedZone\",\n                \"route53:ListResourceRecordSets\",\n                \"route53:ChangeResourceRecordSets\",\n                \"route53:GetChange\"\n            ],\n            \"Resource\": [\n                \"arn:aws:route53:::hostedzone/Z1XUEXAMPLEWR1\"\n            ]\n        }\n    ]\n}\n```\n\n# ID\u3068\u30ad\u30fc\u3092\u4fdd\u5b58\u3057\u305f\u74b0\u5883\u5909\u6570\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3059\u308b\n\nDDNS\u3092\u5b9f\u73fe\u3059\u308b\u306b\u306f HostedZone\u306eZONE_ID\u3001IAM\u30e6\u30fc\u30b6\u306e\u30a2\u30af\u30bb\u30b9\u30ad\u30fc\u3068\u30b7\u30fc\u30af\u30ec\u30c3\u30c8\u30ad\u30fc\u3092\u30b9\u30af\u30ea\u30d7\u30c8\u5185\u3067\u53c2\u7167\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\u3053\u308c\u3089\u3092\u30cf\u30fc\u30c9\u30b3\u30fc\u30c7\u30a3\u30f3\u30b0\u3057\u305f\u304f\u306a\u3044\u306e\u3067\u3001\u74b0\u5883\u5909\u6570\u3068\u3057\u3066\u6e21\u3059\u305f\u3081\u306e\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\n```:.api_keys\n# DDNS \nROUTE53_ZONE_ID=Z1XUEXAMPLEWR1\nIAM_DDNS_KEY=AEXAMPLEEXAMPLEU3C7Q\nIAM_DDNS_SECRET=YxEXAMPLEEXAMPLEEXAMPLEEXAMPLEEXAMPLEYss\n```\n\n\n# Docker\u30b3\u30f3\u30c6\u30ca\u3092\u4f5c\u6210\u3059\u308b\n\nNode.js\u304c\u52d5\u3051\u3070\u306a\u3093\u3067\u3082\u3088\u3044\u306e\u3067\u3059\u304c\u3001Docker\u3067\u6e96\u5099\u3059\u308b\u306e\u304c\u697d\u306a\u306e\u3067\u305d\u306e\u3088\u3046\u306b\u3057\u307e\u3059\u3002\n\n```:Dockerfile\nFROM node:latest\nMAINTAINER flny flny@example.com\n\nRUN npm install nice-route53 \\\n                external-ip\nCMD /bin/bash\n```\n\nRoute53\u3092\u64cd\u4f5c\u3059\u308b\u305f\u3081\u306b [nice-route53](https://www.npmjs.com/package/nice-route53) \u3092\u3001\u81ea\u8eab\u306e\u30b0\u30ed\u30fc\u30d0\u30ebIP\u3092\u77e5\u308b\u305f\u3081\u306b [external-ip](https://www.npmjs.com/package/external-ip) \u3092 \u305d\u308c\u305e\u308cnpm\u3067\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3066\u3044\u307e\u3059\u3002\n\ndocker build \u3068 docker run\u3067Node.js\u304c\u52d5\u4f5c\u3059\u308b\u30b3\u30f3\u30c6\u30ca\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n```sh\n$ docker build -t ddns <Dockerfile\u306e\u3042\u308b\u30c7\u30a3\u30ec\u30af\u30c8\u30ea>\n$ docker run -itd --env-file .api_keys --name ddns ddns\n```\n\n# \u30b9\u30af\u30ea\u30d7\u30c8\u3092\u8a18\u8ff0\u3059\u308b\n\n```js:sendDdns.js\n#!/usr/bin/env node\n\nvar ExtIP = require('external-ip'),\n    Route53 = require('nice-route53')\n;\n\nvar configMap = {\n        zoneId  : process.env.ROUTE53_ZONE_ID,\n        iam_key : process.env.IAM_DDNS_KEY,\n        iam_sec : process.env.IAM_DDNS_SECRET,\n    },\n    getIP = new ExtIP(),\n    r53 = new Route53(\n        {accessKeyId :     configMap.iam_key,\n         secretAccessKey : configMap.iam_sec}\n        ),\n    onReceiveIp, sendRecord\n;\n\n\nsendRecord = function(ip) {\n    var aRec = {\n        zoneId : configMap.zoneId,\n        name   : 'foo.example.com.',\n        type   : 'A',\n        ttl    : 3600,\n        values : [ip]\n    };\n    console.log(aRec);\n    r53.setRecord(aRec, function(err, res) {\n        if(err) throw err;\n        console.log(res);\n    });\n    \n};\n\n\nonReceiveIp = function(err, ip) {\n    if(err) {\n        throw err;\n    }\n    sendRecord(ip)\n}\n\n\ngetIP(onReceiveIp);\n```\n\n1. getIP\u3067\u30b0\u30ed\u30fc\u30d0\u30ebIP\u30a2\u30c9\u30ec\u30b9\u3092\u53d6\u5f97\u3057\u3066\u3001\n2. \u305d\u308c\u3092\u5143\u306bA\u30ec\u30b3\u30fc\u30c9\u3092\u4f5c\u6210\u3057\u3001\n3. r53.setRecord\u3067A\u30ec\u30b3\u30fc\u30c9\u3092upsert\u3059\u308b\n\n\u3068\u3044\u3046\u6d41\u308c\u3067\u3059\u3002\u30d1\u30c3\u30b1\u30fc\u30b8\u306e\u304a\u304b\u3052\u3067\u697d\u3061\u3093\u3067\u3059\u306d\u3002\n\n# \u52d5\u4f5c\u3092\u78ba\u8a8d\u3059\u308b\n\n```\n# ./sendDdnsRec.js\n{ zoneId: 'Z1XUEXAMPLEWR1',\n  name: 'foo.example.com.',\n  type: 'A',\n  ttl: 3600,\n  values: [ '110.233.x.x' ] }\n{ changeId: 'C316EXAMPLE9ZO',\n  url: '/change/C316EXAMPLE9ZO',\n  status: 'PENDING',\n  submittedAt: Tue May 24 2016 15:47:34 GMT+0000 (UTC) }\n```\n\n\u30b3\u30f3\u30c6\u30ca\u4e0a\u3067 \u30b9\u30af\u30ea\u30d7\u30c8\u3092\u5b9f\u884c\u3059\u308b\u3068\u3001\u3046\u307e\u304f\u3044\u3051\u3070 status: 'PENDING' \u306e\u30ec\u30b9\u30dd\u30f3\u30b9\u304c\u8fd4\u308a\u307e\u3059\u3002'PENDING'\u3068\u3044\u3046\u8a18\u8ff0\u3067\u3059\u304c A\u30ec\u30b3\u30fc\u30c9\u306f\u65e2\u306b\u767b\u9332\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n\n\u4ee5\u4e0a\n"}