{"context": " More than 1 year has passed since last update.client ---> proxy1 ---> proxy2 ---> rails app\n\u203b proxy1/2\u306fX-Forwarded-Host\u8a2d\u5b9a\n\n\u4e0a\u8a18\u306e\u3088\u3046\u306a\u74b0\u5883\u3067\u306frails\u306bX-Forwarded-Host\u3067\"proxy1, proxy2\"\u306a\u30ea\u30af\u30a8\u30b9\u30c8\u304c\u5c4a\u304f\u3002\nrails\u3067request.host\u3059\u308b\u3068proxy2\u306e\u30db\u30b9\u30c8\u540d\u304c\u8fd4\u3055\u308c\u308b\u3002\n1.6.0.alpha\u306e\u8a72\u5f53\u30bd\u30fc\u30b9\u3067\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u3066X-Forwarded-Host\u306e\u6700\u5f8c\u3092\u3068\u3063\u3066\u304f\u308b\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u308b\u3002\n\u306a\u305c\u6700\u5f8c\u3092\u8fd4\u3057\u3066\u304f\u308b\u306e\u304b\u3001\u6700\u521d\u3067\u306f\u99c4\u76ee\u306a\u306e\u304b\u3092\u8abf\u3079\u3066\u307f\u305f\u3002\n    def host\n      # Remove port number.\n      host_with_port.to_s.sub(/:\\d+\\z/, '')\n    end\n\n    def host_with_port\n      if forwarded = @env[\"HTTP_X_FORWARDED_HOST\"]\n        forwarded.split(/,\\s?/).last\n      else\n        @env['HTTP_HOST'] || \"#{@env['SERVER_NAME'] || @env['SERVER_ADDR']}:#{@env['SERVER_PORT']}\"\n      end\n    end\n\n\n\u8abf\u3079\u305f\u7d50\u679c\n\u540c\u3058\u3088\u3046\u306a\u8cea\u554f\u304c\u3042\u3063\u305f\u306e\u3067\u8ffd\u3063\u3066\u307f\u308b\u3068\u8a72\u5f53\u7b87\u6240\u306e\u4fee\u6b63\u3092\u884c\u3063\u305f\u30c1\u30b1\u30c3\u30c8\u3092\u898b\u3064\u3051\u305f\u3002\n\n\u5909\u66f4\u306e\u30c1\u30b1\u30c3\u30c8(Archive\u30b5\u30a4\u30c8\u3088\u308a)\uff1a#3397 ([PATCH] CgiRequest returns incorrect host name in event of multiple proxies) - Rails Trac - Trac\n\n\u30c1\u30a7\u30f3\u30b8\u30bb\u30c3\u30c8(Archive\u30b5\u30a4\u30c8\u3088\u308a)\uff1aChangeset 3412 - Rails Trac - Trac\n\n\n\n\n\u30c1\u30b1\u30c3\u30c8\u306e\u5185\u5bb9\u3068\u3057\u3066\u306fActionController::Base::redirect_to\u3067X-Forwarded-Host\u304c\u8907\u6570\u3042\u308b\u3068\u3046\u307e\u304f\u3044\u304b\u306a\u3044\u306e\u3092\u6700\u5f8c\u306e\u3092\u53d6\u5f97\u3059\u308b\u3053\u3068\u3067\u5bfe\u5fdc\u3057\u305f\u3068\u3044\u3046\u3082\u306e\u307f\u305f\u3044\u3002\n\u6700\u521d\u306e\u3067\u306f\u306a\u304f\u6700\u5f8c\u306e\u3092\u53d6\u308b\u3088\u3046\u306b\u3057\u305f\u306e\u306f\u30ea\u30c0\u30a4\u30ec\u30af\u30c8\u3059\u308b\u5148\u306f\u6700\u5f8c\u306e\u30d7\u30ed\u30ad\u30b7\u306e\u30db\u30b9\u30c8\u304c\u9069\u5207\u3060\u3068\u5224\u65ad\u3057\u305f\u305f\u3081\u306e\u3088\u3046\u3002\n\u7d0d\u5f97\u3057\u305f\u3051\u3069client\u304c\u30ea\u30af\u30a8\u30b9\u30c8\u3057\u3066\u304d\u305f\u30db\u30b9\u30c8\u3092\u53d6\u308a\u305f\u3044\u5834\u5408\u306b\u306fRack::Request#host\u306f\u4f7f\u3048\u306a\u3044\u3068\u3044\u3046\u3053\u3068\u304b\u306a\u3001\u3001\u3001\n```\nclient ---> proxy1 ---> proxy2 ---> rails app\n\u203b proxy1/2\u306fX-Forwarded-Host\u8a2d\u5b9a\n```\n\u4e0a\u8a18\u306e\u3088\u3046\u306a\u74b0\u5883\u3067\u306frails\u306bX-Forwarded-Host\u3067\"proxy1, proxy2\"\u306a\u30ea\u30af\u30a8\u30b9\u30c8\u304c\u5c4a\u304f\u3002\nrails\u3067request.host\u3059\u308b\u3068proxy2\u306e\u30db\u30b9\u30c8\u540d\u304c\u8fd4\u3055\u308c\u308b\u3002\n\n[1.6.0.alpha\u306e\u8a72\u5f53\u30bd\u30fc\u30b9](https://github.com/rack/rack/blob/234d6d3ca68af2019fbd330c807d7d532ce8992a/lib/rack/request.rb#L88-L94)\u3067\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u3066X-Forwarded-Host\u306e\u6700\u5f8c\u3092\u3068\u3063\u3066\u304f\u308b\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u308b\u3002\n\u306a\u305c\u6700\u5f8c\u3092\u8fd4\u3057\u3066\u304f\u308b\u306e\u304b\u3001\u6700\u521d\u3067\u306f\u99c4\u76ee\u306a\u306e\u304b\u3092\u8abf\u3079\u3066\u307f\u305f\u3002\n\n```rb\n    def host\n      # Remove port number.\n      host_with_port.to_s.sub(/:\\d+\\z/, '')\n    end\n\n    def host_with_port\n      if forwarded = @env[\"HTTP_X_FORWARDED_HOST\"]\n        forwarded.split(/,\\s?/).last\n      else\n        @env['HTTP_HOST'] || \"#{@env['SERVER_NAME'] || @env['SERVER_ADDR']}:#{@env['SERVER_PORT']}\"\n      end\n    end\n```\n\n## \u8abf\u3079\u305f\u7d50\u679c\n[\u540c\u3058\u3088\u3046\u306a\u8cea\u554f](https://groups.google.com/forum/#!topic/rubyonrails-talk/r_W9EgHmfoY)\u304c\u3042\u3063\u305f\u306e\u3067\u8ffd\u3063\u3066\u307f\u308b\u3068\u8a72\u5f53\u7b87\u6240\u306e\u4fee\u6b63\u3092\u884c\u3063\u305f\u30c1\u30b1\u30c3\u30c8\u3092\u898b\u3064\u3051\u305f\u3002\n\n * \u5909\u66f4\u306e\u30c1\u30b1\u30c3\u30c8(Archive\u30b5\u30a4\u30c8\u3088\u308a)\uff1a[#3397 ([PATCH] CgiRequest returns incorrect host name in event of multiple proxies) - Rails Trac - Trac](https://web.archive.org/web/20100618053001/http://dev.rubyonrails.org/ticket/3397)\n  * \u30c1\u30a7\u30f3\u30b8\u30bb\u30c3\u30c8(Archive\u30b5\u30a4\u30c8\u3088\u308a)\uff1a[Changeset 3412 - Rails Trac - Trac](https://web.archive.org/web/20100616203118/http://dev.rubyonrails.org/changeset/3412)\n\n\u30c1\u30b1\u30c3\u30c8\u306e\u5185\u5bb9\u3068\u3057\u3066\u306fActionController::Base::redirect_to\u3067X-Forwarded-Host\u304c\u8907\u6570\u3042\u308b\u3068\u3046\u307e\u304f\u3044\u304b\u306a\u3044\u306e\u3092\u6700\u5f8c\u306e\u3092\u53d6\u5f97\u3059\u308b\u3053\u3068\u3067\u5bfe\u5fdc\u3057\u305f\u3068\u3044\u3046\u3082\u306e\u307f\u305f\u3044\u3002\n\u6700\u521d\u306e\u3067\u306f\u306a\u304f\u6700\u5f8c\u306e\u3092\u53d6\u308b\u3088\u3046\u306b\u3057\u305f\u306e\u306f\u30ea\u30c0\u30a4\u30ec\u30af\u30c8\u3059\u308b\u5148\u306f\u6700\u5f8c\u306e\u30d7\u30ed\u30ad\u30b7\u306e\u30db\u30b9\u30c8\u304c\u9069\u5207\u3060\u3068\u5224\u65ad\u3057\u305f\u305f\u3081\u306e\u3088\u3046\u3002\n\n\u7d0d\u5f97\u3057\u305f\u3051\u3069client\u304c\u30ea\u30af\u30a8\u30b9\u30c8\u3057\u3066\u304d\u305f\u30db\u30b9\u30c8\u3092\u53d6\u308a\u305f\u3044\u5834\u5408\u306b\u306fRack::Request#host\u306f\u4f7f\u3048\u306a\u3044\u3068\u3044\u3046\u3053\u3068\u304b\u306a\u3001\u3001\u3001", "tags": ["Ruby", "rack", "Rails"]}