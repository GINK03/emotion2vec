{"context": " More than 1 year has passed since last update.\u6700\u8fd1\u3088\u304f\u8033\u306b\u3059\u308b\u69cb\u6210\u7ba1\u7406\u30c4\u30fc\u30eb\u306eAnsible\u3067\u3059\u304c\u30b5\u30fc\u30d0\u30fc\u306e\u8a2d\u5b9a\u3060\u3051\u3067\u306a\u304fCloudStack\u306e\u5404\u7a2e\u30ea\u30bd\u30fc\u30b9\u3092\u6271\u3046\u3053\u3068\u3082\u3067\u304d\u307e\u3059\u3002\n\u4eca\u56de\u306fAnsible\u306b\u3088\u308bCloudStack\u306e\u64cd\u4f5c\u306e\u57fa\u790e\u3068\u3057\u3066\u4eee\u60f3\u30de\u30b7\u30f3\u4f5c\u6210\u3068\u7c21\u5358\u306a\u30d7\u30ed\u30d3\u30b8\u30e7\u30cb\u30f3\u30b0\u3092\u884c\u3063\u3066\u307f\u307e\u3059\u3002\nIDCF Cloud Advent Calendar 2015\u306e@snicker_jp \u3055\u3093\u306e\u8a18\u4e8b\u3068\u5185\u5bb9\u304c\u304b\u306a\u308a\u91cd\u8907\u3057\u3066\u3044\u308b\u306e\u3067\u3001\u305c\u3072\u3053\u3061\u3089\u306e\u8a18\u4e8b\u3082\u8aad\u3093\u3067\u307f\u3066\u304f\u3060\u3055\u3044\u3002\nAnsible\u3060\u3051\u3067IDCF\u30af\u30e9\u30a6\u30c9\u306e\u4eee\u60f3\u30de\u30b7\u30f3\u7acb\u3061\u4e0a\u3052\u304b\u3089\u3001HAProxy\u3092\u4f7f\u3063\u305fSSL\u30aa\u30d5\u30ed\u30fc\u30c0\u30fc\u3092\u69cb\u7bc9\u3059\u308b #idcfrontier : \u5143\u3046\u306a\u304e\u5c4b\n\u4eca\u56de\u306e\u8a18\u4e8b\u3067\u4f7f\u7528\u3057\u3066\u3044\u308b\u30d5\u30a1\u30a4\u30eb\u306f\u4e0b\u8a18\u30ec\u30dd\u30b8\u30c8\u30ea\u306b\u3042\u308a\u307e\u3059\u3002\nhttps://github.com/atsaki/ansible-cloudstack-example-nginx\n\nAnsible\u306eCloudStack\u30e2\u30b8\u30e5\u30fc\u30eb\u306b\u3064\u3044\u3066\nAnsible\u306f\u30d5\u30a1\u30a4\u30eb\u3084\u30e6\u30fc\u30b6\u30fc\u306a\u3069OS\u306e\u64cd\u4f5c\u3060\u3051\u3067\u306a\u304f\u3001\u5404\u7a2e\u30af\u30e9\u30a6\u30c9\u306e\u4eee\u60f3\u30de\u30b7\u30f3\u3084\u30dc\u30ea\u30e5\u30fc\u30e0\u306a\u3069\u306e\u30ea\u30bd\u30fc\u30b9\u3092\u6271\u3046\u3053\u3068\u3082\u3067\u304d\u307e\u3059\u3002\nCloudStack\u306e\u30e2\u30b8\u30e5\u30fc\u30eb\u304c\u958b\u767a\u304c\u9032\u3081\u3089\u308c\u3066\u304a\u308a\u3001Ansible 2.0\u304b\u3089\u6a19\u6e96\u3067\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3055\u308c\u308b\u4e88\u5b9a\u3067\u3059\u3002\n\u5c11\u3057\u3084\u3084\u3053\u3057\u3044\u306e\u3067\u3059\u304cCloudStack\u30e2\u30b8\u30e5\u30fc\u30eb\u306f\u4ee5\u4e0b\u306e2\u3064\u306e\u30ec\u30dd\u30b8\u30c8\u30ea\u3067\n\u958b\u767a\u304c\u9032\u3081\u3089\u308c\u3066\u3044\u307e\u3059\u3002\n\u540c\u3058\u958b\u767a\u8005\u304c\u4e2d\u5fc3\u3068\u306a\u3063\u3066\u958b\u767a\u3092\u9032\u3081\u3066\u304a\u308a\u4e92\u63db\u6027\u306f\u3042\u308a\u307e\u3059\u304c\u3001\u5b8c\u5168\u306b\u540c\u3058\u3068\n\u3044\u3046\u308f\u3051\u3067\u306f\u306a\u3044\u306e\u3067\u6ce8\u610f\u304c\u5fc5\u8981\u3067\u3059\u3002\n\n\nansible/ansible-modules-extras\n\nAnsible\u306e\u4e00\u90e8\u3068\u3057\u3066\u958b\u767a\u304c\u3059\u3059\u3081\u3089\u308c\u3066\u3044\u308b\u30ec\u30dd\u30b8\u30c8\u30ea\nAnsible 2.0\u306e\u30ea\u30ea\u30fc\u30b9\u6642\u306b\u306f\u3053\u3061\u3089\u304c\u7d44\u307f\u8fbc\u307e\u308c\u308b\n\n\n\nresmo/ansible-cloudstack\n\nCloudStack\u30e2\u30b8\u30e5\u30fc\u30eb\u5358\u4f53\u3067\u958b\u767a\u304c\u9032\u3081\u3089\u308c\u3066\u3044\u308b\u30ec\u30dd\u30b8\u30c8\u30ea\n\u3053\u3061\u3089\u3067\u4fee\u6b63\u3092\u884c\u3063\u3066\u304b\u3089ansible/ansible-modules-extras \u306b\u53cd\u6620\u3055\u308c\u308b\u30b1\u30fc\u30b9\u304c\u591a\u3044\n\n\n\n\u4eca\u56de\u306fresmo/ansible-cloudstack \u3092\u4f7f\u7528\u3057\u307e\u3059\u3002\n\nCloudStack\u30e2\u30b8\u30e5\u30fc\u30eb\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\u307e\u305a\u306fCloudStack\u30e2\u30b8\u30e5\u30fc\u30eb\u3092\u4f7f\u7528\u3067\u304d\u308b\u74b0\u5883\u3092\u7528\u610f\u3057\u307e\u3059\u3002\n\u3053\u3053\u3067\u306f\u3001\u4ee5\u4e0b\u306e2\u3064\u306e\u65b9\u6cd5\u3092\u7d39\u4ecb\u3057\u307e\u3059\u3002\n\nAnsible\u304c\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3055\u308c\u3066\u3044\u308b\u5834\u5408\nDocker\u3092\u4f7f\u7528\u3059\u308b\u5834\u5408\n\n\nAnsible\u304c\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3055\u308c\u3066\u3044\u308b\u5834\u5408\n\u3059\u3067\u306bAnsible\u304c\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3055\u308c\u3066\u3044\u308b\u5834\u5408\u306f\u3001playbook\u3068\u540c\u3058\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306e\nlibrary \u3068\u3044\u3046\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306bCloudStack\u30e2\u30b8\u30e5\u30fc\u30eb\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u307e\u3059\u3002\n$ git clone https://github.com/resmo/ansible-cloudstack.git library\n\nCloudStack\u30e2\u30b8\u30e5\u30fc\u30eb\u304c\u5fc5\u8981\u3068\u3059\u308bPython\u30d1\u30c3\u30b1\u30fc\u30b8\u3082\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n$ pip install cs sshpubkeys\n\n\nDocker\u3092\u4f7f\u7528\u3059\u308b\u5834\u5408\nDocker\u3092\u4f7f\u3048\u308b\u74b0\u5883\u306e\u69cb\u7bc9\u65b9\u6cd5\u306f\u591a\u304f\u306e\u8cc7\u6599\u304c\u3042\u308b\u306e\u3067\u5272\u611b\u3057\u307e\u3059\u3002\nDocker Machine\u3092\u4f7f\u7528\u3059\u308b\u306e\u304c\u7c21\u5358\u304b\u3068\u601d\u3044\u307e\u3059\u3002\nAnsible\u3068CloudStack\u30e2\u30b8\u30e5\u30fc\u30eb\u306e\u30a4\u30e1\u30fc\u30b8\u3092\u4f5c\u6210\u3059\u308b\u305f\u3081\u306eDockerfile\u3092\u7528\u610f\u3057\u307e\u3059\u3002\nPython\u30d1\u30c3\u30b1\u30fc\u30b8\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3001CloudStack\u30e2\u30b8\u30e5\u30fc\u30eb\u306e\u53d6\u5f97\u3001\u30e9\u30a4\u30d6\u30e9\u30ea\u306e\u30d1\u30b9\u3078\u306e\u8ffd\u52a0\u306a\u3069\u3092\u884c\u3063\u3066\u3044\u307e\u3059\u3002\n\nDockerfile\nFROM python:2.7\nRUN pip install cs ansible sshpubkeys\nRUN mkdir -p /usr/share/ansible && \\\n    cd /usr/share/ansible && \\\n    git clone https://github.com/resmo/ansible-cloudstack.git\nRUN mkdir -p /etc/ansible ; \\\n    echo \"[defaults]\"                                       > /etc/ansible/ansible.cfg; \\\n    echo \"host_key_checking = False\"                       >> /etc/ansible/ansible.cfg; \\\n    echo \"library = /usr/share/ansible/ansible-cloudstack\" >> /etc/ansible/ansible.cfg\n\n\nDockerfile\u304b\u3089\u30a4\u30e1\u30fc\u30b8\u3092\u30d3\u30eb\u30c9\u3057\u307e\u3059\u3002\n$ docker build -t ansible .\n\ndocker run \u3067\u4f5c\u6210\u3057\u305f\u30a4\u30e1\u30fc\u30b8\u306bAnsible\u304c\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u304c\u78ba\u8a8d\u3067\u304d\u307e\u3059\u3002\n$ docker run --rm ansible ansible --version\nansible 1.9.4\n  configured module search path = None\n\n\ncs\u306e\u8a2d\u5b9a\nCloudStack\u30e2\u30b8\u30e5\u30fc\u30eb\u304c\u4f7f\u7528\u3057\u3066\u3044\u308bcs\u304cCloudStack API\u3092\u5b9f\u884c\u3067\u304d\u308b\u3088\u3046\u306b\u30a8\u30f3\u30c9\u30dd\u30a4\u30f3\u30c8\u3001API\u30ad\u30fc\u3001\u30b7\u30fc\u30af\u30ec\u30c3\u30c8\u30ad\u30fc\u306e\u8a2d\u5b9a\u3092\u884c\u3044\u307e\u3059\u3002\n\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092\u4f7f\u7528\u3057\u3066\u8a2d\u5b9a\u3059\u308b\u3053\u3068\u3082\u3067\u304d\u307e\u3059\u304c\u3001\u4eca\u56de\u306f\u74b0\u5883\u5909\u6570\u3092\u4f7f\u3063\u3066\u8a2d\u5b9a\u3057\u3066\u307f\u307e\u3059\u3002\n\u74b0\u5883\u5909\u6570CLOUDSTACK_ENDPOINT\u3001CLOUDSTACK_KEY\u3001CLOUDSTACK_SECRET\u306b\u30a8\u30f3\u30c9\u30dd\u30a4\u30f3\u30c8\u3001API\u30ad\u30fc\u3001\u30b7\u30fc\u30af\u30ec\u30c3\u30c8\u30ad\u30fc\u3092\u30bb\u30c3\u30c8\u3057\u307e\u3059\u3002\n\u307e\u305f\u3001\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u306e\u8a2d\u5b9a\u304c\u53b3\u3057\u3081\uff08\u30c7\u30d5\u30a9\u30eb\u30c810\u79d2\uff09\u3067\u5931\u6557\u3057\u3066\u3057\u307e\u3046\u3053\u3068\u304c\u3042\u308b\u306e\u3067\u3001\n\u4f59\u88d5\u3092\u898b\u30661\u5206\u306b\u4f38\u3070\u3057\u3066\u304a\u304d\u307e\u3059\u3002\uff08CLOUDSTACK_TIMEOUT=60\uff09\n\u30ed\u30fc\u30ab\u30eb\u306eAnsible\u3092\u4f7f\u7528\u3059\u308b\u5834\u5408\u306f\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u30a8\u30af\u30b9\u30dd\u30fc\u30c8\u3057\u307e\u3059\u3002\n$ export CLOUDSTACK_ENDPOINT=<API\u306e\u30a8\u30f3\u30c9\u30dd\u30a4\u30f3\u30c8>\n$ export CLOUDSTACK_KEY=<API\u30ad\u30fc>\n$ export CLOUDSTACK_SECRET=<\u30b7\u30fc\u30af\u30ec\u30c3\u30c8\u30ad\u30fc>\n$ export CLOUDSTACK_TIMEOUT=60\n\nDocker\u3092\u4f7f\u7528\u3059\u308b\u5834\u5408\u306f\u3001\u307e\u305a.env\u3068\u3044\u3046\u30d5\u30a1\u30a4\u30eb\u3092\u4ee5\u4e0b\u306e\u5185\u5bb9\u3067\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n.env\nCLOUDSTACK_ENDPOINT=<API\u306e\u30a8\u30f3\u30c9\u30dd\u30a4\u30f3\u30c8>\nCLOUDSTACK_KEY=<API\u30ad\u30fc>\nCLOUDSTACK_SECRET=<\u30b7\u30fc\u30af\u30ec\u30c3\u30c8\u30ad\u30fc>\nCLOUDSTACK_TIMEOUT=60\n\n\ndocker run\u306e\u30aa\u30d7\u30b7\u30e7\u30f3--env-file\u306b\u3053\u306e\u30d5\u30a1\u30a4\u30eb\u3092\u6307\u5b9a\u3059\u308b\u3068\u5b9f\u884c\u6642\u306b\u74b0\u5883\u5909\u6570\u304c\u30bb\u30c3\u30c8\u3055\u308c\u307e\u3059\u3002\n\u8a2d\u5b9a\u304c\u6b63\u3057\u304f\u3067\u304d\u3066\u3044\u308c\u3070\u3001cs \u30b3\u30de\u30f3\u30c9\u3067API\u304c\u5b9f\u884c\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002\n# \u30ed\u30fc\u30ab\u30eb\u306eAnsible\u3092\u4f7f\u7528\u3059\u308b\u5834\u5408\u306f\n$ cs listZones\n# Docker\u3092\u4f7f\u7528\u3059\u308b\u5834\u5408\n$ docker run --env-file=.env --rm ansible cs listZones\n\n\nSSH\u9375\u306e\u4f5c\u6210\n\u30db\u30b9\u30c8\u3078\u63a5\u7d9a\u3059\u308b\u305f\u3081\u306b\u4f7f\u7528\u3059\u308bSSH\u9375\u3092\u4f5c\u6210\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n$ ssh-keygen -f ansible_ssh -N \"\"\n\n\nAnsible\u3067Nginx\u30b5\u30fc\u30d0\u30fc\u3092\u69cb\u7bc9\u3059\u308b\n\u6e96\u5099\u304c\u6574\u3063\u305f\u306e\u3067\u3001\u4eee\u60f3\u30de\u30b7\u30f3\u4f5c\u6210\u3068\u30d7\u30ed\u30d3\u30b8\u30e7\u30cb\u30f3\u30b0\u306eNginx\u30b5\u30fc\u30d0\u30fc\u3092\u69cb\u7bc9\u3057\u3066\u307f\u307e\u3059\u3002\n\nInventory\u30d5\u30a1\u30a4\u30eb\nInventory\u30d5\u30a1\u30a4\u30eb\u306b\u4f5c\u6210\u3059\u308b\u30db\u30b9\u30c8\u3068\u30b0\u30eb\u30fc\u30d7\u306e\u8a2d\u5b9a\u3092\u66f8\u304d\u307e\u3059\u3002\n\u4eca\u56de\u306fnginx01 \u3068\u3044\u3046\u30db\u30b9\u30c8\u3092CloudStack\u4e0a\u306b\u4f5c\u6210\u3057\u3001Nginx\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u307e\u3059\u3002\nNginx\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u30db\u30b9\u30c8\u306e\u30b0\u30eb\u30fc\u30d7\u3092nginx \u3001CloudStack\u4e0a\u306b\u4f5c\u6210\u3055\u308c\u308b\u30db\u30b9\u30c8\u3092cloudstack \u30b0\u30eb\u30fc\u30d7\u3068\u3057\u3001nginx01 \u3092\u4e21\u65b9\u306e\u30b0\u30eb\u30fc\u30d7\u306b\u6240\u5c5e\u3055\u305b\u3066\u3044\u307e\u3059\u3002\uff08nginx \u30b0\u30eb\u30fc\u30d7\u5168\u4f53\u3092cloudstack \u30b0\u30eb\u30fc\u30d7\u306b\u542b\u3081\u3066\u3044\u307e\u3059\u3002\uff09\n[all:vars] \u30bb\u30af\u30b7\u30e7\u30f3\u306b\u306f\u30ed\u30b0\u30a4\u30f3\u30e6\u30fc\u30b6\u30fc\u3084\u79d8\u5bc6\u9375\u306a\u3069\u5171\u901a\u3067\u4f7f\u7528\u3059\u308b\u8a2d\u5b9a\u3092\u66f8\u3044\u3066\u304a\u304d\u307e\u3059\u3002\n\nhosts\n[nginx]\nnginx01\n\n[cloudstack:children]\nnginx\n\n[all:vars]\nansible_ssh_user=root\nansible_ssh_private_key_file=./ansible_ssh\nansible_python_interpreter=python\ncache_dir=./cache\n\n\n\n\u5909\u6570\u306e\u8a2d\u5b9a\ngroup_vars/cloudstack \u306b\u306f\u3001\u30c7\u30d5\u30a9\u30eb\u30c8\u3067\u4f7f\u7528\u3059\u308b\u30be\u30fc\u30f3\u3084\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u306a\u3069\u306eCloudStack\u306e\u8a2d\u5b9a\u3092\u66f8\u3044\u3066\u304a\u304d\u307e\u3059\u3002\n\ngroup_vars/cloudstack\n---\n\nssh_public_key_file: \"./ansible_ssh.pub\"\nzone_name: \"joule\"\nnetwork_name: \"joule-network1\"\nservice_offering_name: \"light.S1\"\ntemplate_name: \"CentOS 7.1 64-bit\"\nfirewall_rules:\n  - { protocol: \"tcp\", start_port: 22, end_port: 22 }\nport_forwarding_rules:\n  - { protocol: \"tcp\", public_port: 22, private_port: 22 }\n\n\nnginx\u30b0\u30eb\u30fc\u30d7\u306b\u3064\u3044\u3066\u306fSSH\u306e\u30dd\u30fc\u30c8\u3060\u3051\u3067\u306a\u304fHTTP\u306e\u30dd\u30fc\u30c8\u3082\u958b\u3051\u307e\u3059\u3002\n\ngroup_vars/nginx\n---\n\nfirewall_rules:\n  - { protocol: \"tcp\", start_port: 22, end_port: 22 }\n  - { protocol: \"tcp\", start_port: 80, end_port: 80 }\nport_forwarding_rules:\n  - { protocol: \"tcp\", public_port: 22, private_port: 22 }\n  - { protocol: \"tcp\", public_port: 80, private_port: 80 }\n\n\n\nPlaybook\u306e\u4f5c\u6210\n\u4eca\u56de\u306f\u4ee5\u4e0b\u306e3\u3064\u306ePlaybook\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\ndeploy.yml\n\n\n\u4eee\u60f3\u30de\u30b7\u30f3\u306e\u30c7\u30d7\u30ed\u30a4\u3001IP\u30a2\u30c9\u30ec\u30b9\u306e\u53d6\u5f97\u3001\u30dd\u30fc\u30c8\u30d5\u30a9\u30ef\u30fc\u30c7\u30a3\u30f3\u30b0\u306e\u8a2d\u5b9a\u3092\u884c\u3046\n\n\nnginx.yml\n\n\n\u4eee\u60f3\u30de\u30b7\u30f3\u306bNginx\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\n\n\nclean.yml\n\n\n\u4f5c\u6210\u30fb\u53d6\u5f97\u3057\u305f\u30ea\u30bd\u30fc\u30b9\u3092\u524a\u9664\u30fb\u89e3\u653e\u3059\u308b\n\n\n\nPlaybook\u306fansible-blaybook \u30b3\u30de\u30f3\u30c9\u3067\u5b9f\u884c\u3067\u304d\u307e\u3059\u3002\n$ ansible-playbook -i hosts PLAYBOOK.yml\n\nDocker\u3092\u4f7f\u7528\u3057\u3066\u3044\u308b\u5834\u5408\u306b\u306f\u3001\u30ab\u30ec\u30f3\u30c8\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u30de\u30a6\u30f3\u30c8\u3057\u30b3\u30f3\u30c6\u30ca\u304b\u3089Playbook\u304c\u898b\u3048\u308b\u3088\u3046\u306b\u3057\u307e\u3059\u3002\n$ docker run --env-file=.env -v $(pwd):/data -w /data --rm ansible \u00a5\n    ansible-playbook -i hosts PLAYBOOK.yml\n\n\u4ee5\u4e0b\u305d\u308c\u305e\u308c\u306ePlaybook\u306b\u3064\u3044\u3066\u7c21\u5358\u306b\u5185\u5bb9\u3092\u8aac\u660e\u3057\u307e\u3059\u3002\n\u8a73\u7d30\u306b\u3064\u3044\u3066\u306f\u30ec\u30dd\u30b8\u30c8\u30ea\u306e\u30d5\u30a1\u30a4\u30eb\u3092\u53c2\u7167\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\ndeploy.yml\ndeploy.yml \u306f\u30db\u30b9\u30c8\u3092CloudStack\u4e0a\u306b\u4f5c\u6210\u3057\u3001\u30d5\u30a1\u30a4\u30a2\u30a6\u30a9\u30fc\u30eb\u30fb\u30dd\u30fc\u30c8\u30d5\u30a9\u30ef\u30fc\u30c7\u30a3\u30f3\u30b0\u7b49\u306e\u8a2d\u5b9a\u3092\u884c\u3044\u30db\u30b9\u30c8\u306bSSH\u63a5\u7d9a\u53ef\u80fd\u306a\u72b6\u614b\u306b\u3057\u307e\u3059\u3002\n\n\u4eee\u60f3\u30de\u30b7\u30f3\u306e\u30c7\u30d7\u30ed\u30a4\n\u4eee\u60f3\u30de\u30b7\u30f3\u306e\u7ba1\u7406\u306fcs_instance \u30e2\u30b8\u30e5\u30fc\u30eb\u3067\u884c\u3046\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\u5404\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u8a2d\u5b9a\u3059\u308b\u3060\u3051\u3067\u3001\u4eee\u60f3\u30de\u30b7\u30f3\u306e\u72b6\u614b\u3092\u6307\u5b9a\u3055\u308c\u3066\u3044\u308b\u72b6\u614b\u306b\u3057\u3066\u304f\u308c\u307e\u3059\u3002\nSSH\u63a5\u7d9a\u3059\u308b\u305f\u3081\u306b\u306f\u4eee\u60f3\u30de\u30b7\u30f3\u304c\u8d77\u52d5\u3057\u3066\u3044\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\nstate: started \u3068\u3057\u3066\u304a\u304f\u3068\u3001deploy.yml \u304c\u5b9f\u884c\u3055\u308c\u305f\u3068\u304d\u4eee\u60f3\u30de\u30b7\u30f3\u304c\u505c\u6b62\u3057\u3066\u3044\u305f\u3089\u8d77\u52d5\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\ndeploy.yml\n    - name: \"VM\u306e\u4f5c\u6210\"\n      cs_instance:\n        name: \"{{ inventory_hostname }}\"\n        zone: \"{{ zone_name }}\"\n        networks: [\"{{ network_name }}\"]\n        service_offering: \"{{ service_offering_name }}\"\n        template: \"{{ template_name }}\"\n        ssh_key: \"{{ inventory_hostname }}\"\n        state: started\n      register: vm\n\n\n\nIP\u30a2\u30c9\u30ec\u30b9\u306e\u53d6\u5f97\n\u4eee\u60f3\u30de\u30b7\u30f3\u3078\u306eSSH\u63a5\u7d9a\u3068Web\u30da\u30fc\u30b8\u3078\u306e\u63a5\u7d9a\u306e\u305f\u3081\u306bIP\u30a2\u30c9\u30ec\u30b9\u3092\u53d6\u5f97\u3057\u307e\u3059\u3002\nIP\u30a2\u30c9\u30ec\u30b9\u306e\u7ba1\u7406\u306fcs_ip_address \u30e2\u30b8\u30e5\u30fc\u30eb\u3067\u884c\u3046\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\nIP\u30a2\u30c9\u30ec\u30b9\u306e\u53d6\u5f97\u306b\u3064\u3044\u3066\u306f\u6ce8\u610f\u304c\u5fc5\u8981\u3067\u3059\u3002\nAnsible\u306f\u57fa\u672c\u7684\u306b\u524d\u56de\u5b9f\u884c\u3057\u305f\u51e6\u7406\u3092\u899a\u3048\u3066\u3044\u306a\u3044\u306e\u3067\u3001\u5358\u306bstate: present \u3067\u53d6\u5f97\u3059\u308b\u3068\u3001\u5b9f\u884c\u306e\u305f\u3073\u306bIP\u30a2\u30c9\u30ec\u30b9\u3092\u53d6\u5f97\u3057\u3066\u3057\u307e\u3044\u307e\u3059\u3002\n\u5bfe\u7b56\u306f\u8272\u3005\u3042\u308a\u307e\u3059\u304c\u3001\u4eca\u56de\u306f\u53d6\u5f97\u3057\u305fIP\u30a2\u30c9\u30ec\u30b9\u3092\u66f8\u3044\u305f\u30d5\u30a1\u30a4\u30eb\u3092\u4fdd\u5b58\u3057\u3066\u304a\u304f\u3053\u3068\u306b\u3057\u307e\u3057\u305f\u3002\u30d5\u30a1\u30a4\u30eb\u304c\u5b58\u5728\u3059\u308b\u5834\u5408\u306f\u53d6\u5f97\u6e08\u307f\u306a\u306e\u3067\u51e6\u7406\u3092\u30b9\u30ad\u30c3\u30d7\u3057\u307e\u3059\u3002\n\ndeploy.yml\n    - name: \"\u30ad\u30e3\u30c3\u30b7\u30e5\u7528\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306e\u4f5c\u6210\"\n      file:\n        path: \"{{ vm_cache_dir }}\"\n        state: \"directory\"\n        mode: \"0755\"\n\n    - name: \"\u53d6\u5f97\u6e08\u307fIP\u30a2\u30c9\u30ec\u30b9\u306e\u78ba\u8a8d\"\n      stat:\n        path: \"{{ vm_cache_dir + '/ip_address' }}\"\n      register: cache_ip_address\n\n    - name: \"\u65b0\u898fIP\u30a2\u30c9\u30ec\u30b9\u306e\u53d6\u5f97\"\n      cs_ip_address:\n        zone: \"{{ zone_name }}\"\n        network: \"{{ network_name }}\"\n      register: ip_address\n      when: not cache_ip_address.stat.exists\n\n    - name: \"\u53d6\u5f97\u3057\u305fIP\u30a2\u30c9\u30ec\u30b9\u3092\u30ad\u30e3\u30c3\u30b7\u30e5\u3078\u66f8\u304d\u8fbc\u307f\"\n      copy:\n        content: \"{{ ip_address.ip_address }}\"\n        dest: \"{{ vm_cache_dir + '/ip_address' }}\"\n      when: not cache_ip_address.stat.exists\n\n    - name: \"IP\u30a2\u30c9\u30ec\u30b9\u306e\u30ad\u30e3\u30c3\u30b7\u30e5\u8aad\u307f\u8fbc\u307f\"\n      set_fact:\n        ip_address: \"{{ lookup('file', vm_cache_dir + '/ip_address') }}\"\n\n\n\n\u30d5\u30a1\u30a4\u30a2\u30a6\u30a9\u30fc\u30eb\u30fb\u30dd\u30fc\u30c8\u30d5\u30a9\u30ef\u30fc\u30c7\u30a3\u30f3\u30b0\u30eb\u30fc\u30eb\u306e\u8a2d\u5b9a\nIP\u30a2\u30c9\u30ec\u30b9\u304c\u53d6\u5f97\u3067\u304d\u305f\u306e\u3067\u3001SSH\u3068HTTP\u306e\u30d5\u30a1\u30a4\u30a2\u30a6\u30a9\u30fc\u30eb\u3068\n\u30dd\u30fc\u30c8\u30d5\u30a9\u30ef\u30fc\u30c7\u30a3\u30f3\u30b0\u30eb\u30fc\u30eb\u3092\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\u30d5\u30a1\u30a4\u30a2\u30a6\u30a9\u30fc\u30eb\u3068\u30dd\u30fc\u30c8\u30d5\u30a9\u30ef\u30fc\u30c7\u30a3\u30f3\u30b0\u30eb\u30fc\u30eb\u306e\u7ba1\u7406\u306b\u306f\u305d\u308c\u305e\u308ccs_firewall\u3001cs_portforward \u3092\u4f7f\u7528\u3057\u307e\u3059\u3002\n\u3053\u308c\u3089\u306e\u30e2\u30b8\u30e5\u30fc\u30eb\u3092\u4f7f\u7528\u3059\u308b\u969b\u306e\u6ce8\u610f\u70b9\u306f\u3001\u5fc5\u305a\u30be\u30fc\u30f3\u3092\u6307\u5b9a\u3059\u308b\u3053\u3068\u3067\u3059\u3002\n\u30be\u30fc\u30f3\u306a\u3057\u3067\u306f\u610f\u56f3\u3057\u3066\u3044\u306a\u3044\u30be\u30fc\u30f3\u3067IP\u30a2\u30c9\u30ec\u30b9\u3092\u63a2\u3057\u3066\u30a8\u30e9\u30fc\u306b\u306a\u308b\u5834\u5408\u304c\u3042\u308a\u307e\u3059\u3002\n\ndeploy.yml\n    - name: \"\u30d5\u30a1\u30a4\u30a2\u30a6\u30a9\u30fc\u30eb\u30eb\u30fc\u30eb\u306e\u8a2d\u5b9a\"\n      cs_firewall:\n        zone: \"{{ zone_name }}\"\n        ip_address: \"{{ ip_address }}\"\n        protocol: \"{{ item.protocol }}\"\n        start_port: \"{{ item.start_port }}\"\n        end_port: \"{{ item.end_port }}\"\n        cidr: \"{{ item.cidr|default('0.0.0.0/0') }}\"\n      with_items: firewall_rules\n\n\n\nSSH\u63a5\u7d9a\u53ef\u80fd\u306b\u306a\u308b\u307e\u3067\u5f85\u6a5f\n\u6700\u5f8c\u306b\u4eee\u60f3\u30de\u30b7\u30f3\u304cSSH\u63a5\u7d9a\u53ef\u80fd\u306b\u306a\u308b\u307e\u3067\u5f85\u6a5f\u3057\u307e\u3059\u3002\n\ndeploy.yml\n    - name: \"SSH\u3067\u63a5\u7d9a\u53ef\u80fd\u306b\u306a\u308b\u307e\u3067\u5f85\u6a5f\"\n      wait_for:\n        host: \"{{ ip_address }}\"\n        port: \"{{ ansible_ssh_port|default(22) }}\"\n        search_regex: \"OpenSSH\"\n\n    - name: \"authorized_keys\u306e\u8a2d\u5b9a\u306b\u6642\u9593\u304c\u304b\u304b\u308b\u5834\u5408\u304c\u3042\u308b\u306e\u3067\u4f59\u5206\u306b\u5f85\u6a5f\"\n      pause: minutes=2\n      when: vm|changed\n\n\n\n\u4f5c\u6210\u3057\u305f\u4eee\u60f3\u30de\u30b7\u30f3\u306bSSH\u30ed\u30b0\u30a4\u30f3\n\u4f5c\u6210\u3057\u305f\u4eee\u60f3\u30de\u30b7\u30f3\u306b\u306f\u4ee5\u4e0b\u306e\u30b3\u30de\u30f3\u30c9\u3067\u30ed\u30b0\u30a4\u30f3\u3067\u304d\u307e\u3059\u3002\n$ ssh -i ansible_ssh root@$(cat cache/nginx01/ip_address)\n\n\nnginx.yml\n\nnginx.yml```\u306f\u30db\u30b9\u30c8\u306bNginx\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u307e\u3059\u3002\n\n```yaml:nginx.yml\n---\n\n- hosts: nginx\n  gather_facts: no\n  pre_tasks:\n    - include: set_ansible_ssh_host.yml\n  tasks:\n    - name: \"Nginx\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb(Ubuntu)\"\n      apt:\n        name: \"nginx\"\n        update_cache: yes\n      when: ansible_distribution == 'Ubuntu'\n\n    - name: \"EPEL\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb(CentOS)\"\n      yum:\n        name: \"epel-release\"\n      when: ansible_distribution == 'CentOS'\n\n    - name: \"Nginx\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb(CentOS)\"\n      yum:\n        name: \"nginx\"\n      when: ansible_distribution == 'CentOS'\n\n    - name: \"Nginx\u3092\u8d77\u52d5\"\n      service:\n        name: \"nginx\"\n        enabled: yes\n        state: started\n\n\nNginx\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u30bf\u30b9\u30af\u306e\u5b9f\u884c\u524d\u306b\u3001pre_tasks \u3067set_ansible_ssh_host.yml \u3092\u5b9f\u884c\u3057\u3066\u3044\u307e\u3059\u3002\nset_ansible_ssh_host.yml \u3067\u306f\u53d6\u5f97\u6e08\u307f\u306eIP\u30a2\u30c9\u30ec\u30b9\u3092\u8abf\u3079ansible_ssh_host \u306b\u3092\u30bb\u30c3\u30c8\u3057\u3001\u5bfe\u8c61\u30db\u30b9\u30c8\u306bSSH\u3067\u304d\u308b\u3088\u3046\u306b\u3057\u3066\u3044\u307e\u3059\u3002\nset_ansible_ssh_host.yml \u306f\u3001\u30db\u30b9\u30c8\u60c5\u5831\u306e\u53d6\u5f97\u3082\u884c\u3044\u307e\u3059\u3002\n\u3053\u308c\u306b\u3088\u308a\u30db\u30b9\u30c8\u306e\u60c5\u5831\u306b\u3088\u3063\u3066\u51e6\u7406\u3092\u5909\u66f4\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\nnginx.yml\u3067\u306f\u3001\u30c7\u30a3\u30b9\u30c8\u30ea\u30d3\u30e5\u30fc\u30b7\u30e7\u30f3\u306b\u3088\u3063\u3066\u4f7f\u7528\u3059\u308b\u30e2\u30b8\u30e5\u30fc\u30eb\u3092\n\u5909\u66f4\u3057CentOS\u3001Ubuntu\u306e\u4e21\u65b9\u306b\u5bfe\u5fdc\u3057\u3066\u3044\u307e\u3059\u3002\n\nset_ansible_ssh_host.yml\n---\n\n- set_fact:\n    vm_cache_dir: \"{{ cache_dir + '/' + inventory_hostname }}\"\n\n- name: \"\u53d6\u5f97\u6e08\u307fIP\u30a2\u30c9\u30ec\u30b9\u306e\u78ba\u8a8d\"\n  stat:\n    path: \"{{ vm_cache_dir + '/ip_address' }}\"\n  register: cache_ip_address\n  connection: local\n  failed_when: not cache_ip_address.stat.exists\n\n- name: \"ansible_ssh_host\u306b\u53d6\u5f97\u6e08\u307f\u306eIP\u3092\u30bb\u30c3\u30c8\"\n  set_fact:\n    ansible_ssh_host: \"{{ lookup('file', vm_cache_dir + '/ip_address') }}\"\n\n- name: \"\u4eee\u60f3\u30de\u30b7\u30f3\u306e\u30b9\u30c6\u30fc\u30bf\u30b9\u3092\u78ba\u8a8d\"\n  cs_instance:\n    name: \"{{ inventory_hostname }}\"\n    zone: \"{{ zone_name }}\"\n    state: present\n  connection: local\n  register: instance\n\n- name: \"\u30db\u30b9\u30c8\u60c5\u5831\u306e\u53d6\u5f97\"\n  setup:\n  when: instance.state == \"Running\"\n\n\n\u30d7\u30ed\u30d3\u30b8\u30e7\u30cb\u30f3\u30b0\u304c\u6b63\u5e38\u306b\u5b8c\u4e86\u3057\u3066\u3044\u308c\u3070\u3001\u30d6\u30e9\u30a6\u30b6\u3067cache/nginx01/ip_address \u306eIP\u30a2\u30c9\u30ec\u30b9\u3092\n\u958b\u304f\u3068Nginx\u306e\u753b\u9762\u304c\u8868\u793a\u3055\u308c\u307e\u3059\u3002\n\nclean.yml\nclean.yml\u306f\u4f5c\u6210\u30fb\u53d6\u5f97\u3057\u305f\u30ea\u30bd\u30fc\u30b9\u3092\u89e3\u653e\u30fb\u89e3\u9664\u3059\u308b\u305f\u3081\u306ePlaybook\u3067\u3059\u3002\n\u524a\u9664\u306e\u969b\u3082\u30be\u30fc\u30f3\u306e\u6307\u5b9a\u3092\u5fd8\u308c\u306a\u3044\u3088\u3046\u6ce8\u610f\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\u30be\u30fc\u30f3\u3092\u6307\u5b9a\u3057\u3066\u3044\u306a\u3044\u5834\u5408\u3001\u8907\u6570\u30be\u30fc\u30f3\u306b\u540c\u3058\u540d\u524d\u306e\u30ea\u30bd\u30fc\u30b9\u304c\u5b58\u5728\u3059\u308b\u3068\n\u610f\u56f3\u3057\u3066\u3044\u306a\u3044\u307b\u3046\u304c\u6d88\u3055\u308c\u308b\u5834\u5408\u304c\u3042\u308a\u307e\u3059\u3002\n\nclean.yml\n---\n\n- hosts: cloudstack\n  connection: local\n  tasks:\n    - set_fact:\n        vm_cache_dir: \"{{ cache_dir + '/' + inventory_hostname }}\"\n\n    - name: \"SSH\u516c\u958b\u9375\u306e\u524a\u9664\"\n      cs_sshkeypair:\n        name: \"{{ inventory_hostname }}\"\n        state: absent\n\n    - name: \"\u53d6\u5f97\u6e08\u307fIP\u30a2\u30c9\u30ec\u30b9\u306e\u78ba\u8a8d\"\n      stat:\n        path: \"{{ vm_cache_dir + '/ip_address' }}\"\n      register: cache_ip_address\n\n    - name: \"IP\u30a2\u30c9\u30ec\u30b9\u306e\u30ad\u30e3\u30c3\u30b7\u30e5\u8aad\u307f\u8fbc\u307f\"\n      set_fact:\n        ip_address: \"{{ lookup('file', vm_cache_dir + '/ip_address') }}\"\n      when: cache_ip_address.stat.exists\n\n    - name: \"IP\u30a2\u30c9\u30ec\u30b9\u306e\u89e3\u653e\"\n      cs_ip_address:\n        zone: \"{{ zone_name }}\"\n        network: \"{{ network_name }}\"\n        ip_address: \"{{ ip_address }}\"\n        state: absent\n      when: cache_ip_address.stat.exists\n\n    - name: \"IP\u30a2\u30c9\u30ec\u30b9\u30ad\u30e3\u30c3\u30b7\u30e5\u306e\u524a\u9664\"\n      file:\n        path: \"{{ vm_cache_dir + '/ip_address' }}\"\n        state: absent\n      when: cache_ip_address.stat.exists\n\n    - name: \"VM\u306e\u524a\u9664\"\n      cs_instance:\n        name: \"{{ inventory_hostname }}\"\n        zone: \"{{ zone_name }}\"\n        state: expunged\n\n    - name: \"\u30ad\u30e3\u30c3\u30b7\u30e5\u7528\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306e\u524a\u9664\"\n      file:\n        path: \"{{ vm_cache_dir }}\"\n        state: absent\n\n\n\n\u6700\u5f8c\u306b\n\u3053\u3053\u307e\u3067Ansible\u3067\u4eee\u60f3\u30de\u30b7\u30f3\u3092\u4f5c\u6210\u3057\u30d7\u30ed\u30d3\u30b8\u30e7\u30cb\u30f3\u30b0\u3059\u308b\u65b9\u6cd5\u3092\u307f\u3066\u304d\u307e\u3057\u305f\u304c\u3001\n\u4eca\u56de\u6271\u3063\u305f\u5185\u5bb9\u3067\u3042\u308c\u3070Vagrant\u3084Terraform\u3092\u4f7f\u7528\u3057\u305f\u65b9\u304c\u826f\u3044\u3068\u601d\u3044\u307e\u3059\u3002\n\u3053\u308c\u3089\u306e\u30c4\u30fc\u30eb\u306fID\u3067\u30ea\u30bd\u30fc\u30b9\u3092\u7ba1\u7406\u3057\u3066\u3044\u308b\u305f\u3081\u3001\u610f\u56f3\u3057\u306a\u3044\u30ea\u30bd\u30fc\u30b9\u3092\u64cd\u4f5c\n\u3057\u3066\u3057\u307e\u3046\u5371\u967a\u304c\u5c11\u306a\u304f\u5b89\u5168\u3067\u3059\u3002\u307e\u305f\u3001\u7528\u9014\u304c\u9650\u3089\u308c\u3066\u3044\u308b\u306e\u3067\u8a2d\u5b9a\u3082\u7c21\u5358\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002\nAnsible\u3067CloudStack\u3092\u64cd\u4f5c\u3059\u308b\u30e1\u30ea\u30c3\u30c8\u306f\u3001\u7d30\u304b\u3044\u51e6\u7406\u306e\u624b\u9806\u3092\u8a18\u8ff0\u3057\u3084\u3059\u3044\u3053\u3068\u3001\n\u65e2\u5b58\u306e\u30ea\u30bd\u30fc\u30b9\u3092\u7ba1\u7406\u5bfe\u8c61\u306b\u3057\u3084\u3059\u3044\u3053\u3068\u3001\u5bfe\u5fdc\u3057\u3066\u3044\u308b\u30ea\u30bd\u30fc\u30b9\u304c\u591a\u3044\u3053\u3068\u306b\u3042\u308b\u3068\u601d\u3044\u307e\u3059\u3002\n\u6b21\u56de\u306f\u3001\u5fdc\u7528\u7de8\u3068\u3057\u3066\u3053\u308c\u3089\u306e\u30e1\u30ea\u30c3\u30c8\u304c\u6d3b\u7528\u3067\u304d\u308b\u4f8b\u3068\u3057\u3066\u65e2\u5b58\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u306e\u30ab\u30b9\u30bf\u30de\u30a4\u30ba\u3092\u884c\u3044\u307e\u3059\u3002\nAnsible\u3067CloudStack\u3092\u64cd\u4f5c\u3059\u308b\uff08\u5fdc\u7528\u7de8\uff1aIDCF\u30af\u30e9\u30a6\u30c9\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u306e\u30ab\u30b9\u30bf\u30de\u30a4\u30ba\uff09 - Qiita\n\u6700\u8fd1\u3088\u304f\u8033\u306b\u3059\u308b\u69cb\u6210\u7ba1\u7406\u30c4\u30fc\u30eb\u306e[Ansible](http://www.ansible.com/)\u3067\u3059\u304c\u30b5\u30fc\u30d0\u30fc\u306e\u8a2d\u5b9a\u3060\u3051\u3067\u306a\u304fCloudStack\u306e\u5404\u7a2e\u30ea\u30bd\u30fc\u30b9\u3092\u6271\u3046\u3053\u3068\u3082\u3067\u304d\u307e\u3059\u3002\n\n\u4eca\u56de\u306fAnsible\u306b\u3088\u308bCloudStack\u306e\u64cd\u4f5c\u306e\u57fa\u790e\u3068\u3057\u3066\u4eee\u60f3\u30de\u30b7\u30f3\u4f5c\u6210\u3068\u7c21\u5358\u306a\u30d7\u30ed\u30d3\u30b8\u30e7\u30cb\u30f3\u30b0\u3092\u884c\u3063\u3066\u307f\u307e\u3059\u3002\n\n[IDCF Cloud Advent Calendar 2015](http://qiita.com/advent-calendar/2015/idcfcloud)\u306e@snicker_jp \u3055\u3093\u306e\u8a18\u4e8b\u3068\u5185\u5bb9\u304c\u304b\u306a\u308a\u91cd\u8907\u3057\u3066\u3044\u308b\u306e\u3067\u3001\u305c\u3072\u3053\u3061\u3089\u306e\u8a18\u4e8b\u3082\u8aad\u3093\u3067\u307f\u3066\u304f\u3060\u3055\u3044\u3002\n\n[Ansible\u3060\u3051\u3067IDCF\u30af\u30e9\u30a6\u30c9\u306e\u4eee\u60f3\u30de\u30b7\u30f3\u7acb\u3061\u4e0a\u3052\u304b\u3089\u3001HAProxy\u3092\u4f7f\u3063\u305fSSL\u30aa\u30d5\u30ed\u30fc\u30c0\u30fc\u3092\u69cb\u7bc9\u3059\u308b #idcfrontier : \u5143\u3046\u306a\u304e\u5c4b](http://snickerjp.blogspot.jp/2015/12/idcfcloud-ansible-launch.html)\n\n\u4eca\u56de\u306e\u8a18\u4e8b\u3067\u4f7f\u7528\u3057\u3066\u3044\u308b\u30d5\u30a1\u30a4\u30eb\u306f\u4e0b\u8a18\u30ec\u30dd\u30b8\u30c8\u30ea\u306b\u3042\u308a\u307e\u3059\u3002\n\nhttps://github.com/atsaki/ansible-cloudstack-example-nginx\n\n## Ansible\u306eCloudStack\u30e2\u30b8\u30e5\u30fc\u30eb\u306b\u3064\u3044\u3066\n\nAnsible\u306f\u30d5\u30a1\u30a4\u30eb\u3084\u30e6\u30fc\u30b6\u30fc\u306a\u3069OS\u306e\u64cd\u4f5c\u3060\u3051\u3067\u306a\u304f\u3001\u5404\u7a2e\u30af\u30e9\u30a6\u30c9\u306e\u4eee\u60f3\u30de\u30b7\u30f3\u3084\u30dc\u30ea\u30e5\u30fc\u30e0\u306a\u3069\u306e\u30ea\u30bd\u30fc\u30b9\u3092\u6271\u3046\u3053\u3068\u3082\u3067\u304d\u307e\u3059\u3002\n\nCloudStack\u306e\u30e2\u30b8\u30e5\u30fc\u30eb\u304c\u958b\u767a\u304c\u9032\u3081\u3089\u308c\u3066\u304a\u308a\u3001Ansible 2.0\u304b\u3089\u6a19\u6e96\u3067\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3055\u308c\u308b\u4e88\u5b9a\u3067\u3059\u3002\n\n\u5c11\u3057\u3084\u3084\u3053\u3057\u3044\u306e\u3067\u3059\u304cCloudStack\u30e2\u30b8\u30e5\u30fc\u30eb\u306f\u4ee5\u4e0b\u306e2\u3064\u306e\u30ec\u30dd\u30b8\u30c8\u30ea\u3067\n\u958b\u767a\u304c\u9032\u3081\u3089\u308c\u3066\u3044\u307e\u3059\u3002\n\u540c\u3058\u958b\u767a\u8005\u304c\u4e2d\u5fc3\u3068\u306a\u3063\u3066\u958b\u767a\u3092\u9032\u3081\u3066\u304a\u308a\u4e92\u63db\u6027\u306f\u3042\u308a\u307e\u3059\u304c\u3001\u5b8c\u5168\u306b\u540c\u3058\u3068\n\u3044\u3046\u308f\u3051\u3067\u306f\u306a\u3044\u306e\u3067\u6ce8\u610f\u304c\u5fc5\u8981\u3067\u3059\u3002\n\n* [ansible/ansible-modules-extras](https://github.com/ansible/ansible-modules-extras)\n    * Ansible\u306e\u4e00\u90e8\u3068\u3057\u3066\u958b\u767a\u304c\u3059\u3059\u3081\u3089\u308c\u3066\u3044\u308b\u30ec\u30dd\u30b8\u30c8\u30ea\n    * Ansible 2.0\u306e\u30ea\u30ea\u30fc\u30b9\u6642\u306b\u306f\u3053\u3061\u3089\u304c\u7d44\u307f\u8fbc\u307e\u308c\u308b\n* [resmo/ansible-cloudstack](https://github.com/resmo/ansible-cloudstack)\n    * CloudStack\u30e2\u30b8\u30e5\u30fc\u30eb\u5358\u4f53\u3067\u958b\u767a\u304c\u9032\u3081\u3089\u308c\u3066\u3044\u308b\u30ec\u30dd\u30b8\u30c8\u30ea\n    * \u3053\u3061\u3089\u3067\u4fee\u6b63\u3092\u884c\u3063\u3066\u304b\u3089```ansible/ansible-modules-extras``` \u306b\u53cd\u6620\u3055\u308c\u308b\u30b1\u30fc\u30b9\u304c\u591a\u3044\n\n\u4eca\u56de\u306f```resmo/ansible-cloudstack``` \u3092\u4f7f\u7528\u3057\u307e\u3059\u3002\n\n## CloudStack\u30e2\u30b8\u30e5\u30fc\u30eb\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n\u307e\u305a\u306fCloudStack\u30e2\u30b8\u30e5\u30fc\u30eb\u3092\u4f7f\u7528\u3067\u304d\u308b\u74b0\u5883\u3092\u7528\u610f\u3057\u307e\u3059\u3002\n\u3053\u3053\u3067\u306f\u3001\u4ee5\u4e0b\u306e2\u3064\u306e\u65b9\u6cd5\u3092\u7d39\u4ecb\u3057\u307e\u3059\u3002\n\n* [Ansible\u304c\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3055\u308c\u3066\u3044\u308b\u5834\u5408](#Ansible\u304c\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3055\u308c\u3066\u3044\u308b\u5834\u5408)\n* [Docker\u3092\u4f7f\u7528\u3059\u308b\u5834\u5408](#Docker\u3092\u4f7f\u7528\u3059\u308b\u5834\u5408)\n\n### Ansible\u304c\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3055\u308c\u3066\u3044\u308b\u5834\u5408\n\n\u3059\u3067\u306bAnsible\u304c\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3055\u308c\u3066\u3044\u308b\u5834\u5408\u306f\u3001playbook\u3068\u540c\u3058\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306e\n```library``` \u3068\u3044\u3046\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306bCloudStack\u30e2\u30b8\u30e5\u30fc\u30eb\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u307e\u3059\u3002\n\n```bash\n$ git clone https://github.com/resmo/ansible-cloudstack.git library\n```\n\nCloudStack\u30e2\u30b8\u30e5\u30fc\u30eb\u304c\u5fc5\u8981\u3068\u3059\u308bPython\u30d1\u30c3\u30b1\u30fc\u30b8\u3082\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\n```bash\n$ pip install cs sshpubkeys\n```\n\n### Docker\u3092\u4f7f\u7528\u3059\u308b\u5834\u5408\n\nDocker\u3092\u4f7f\u3048\u308b\u74b0\u5883\u306e\u69cb\u7bc9\u65b9\u6cd5\u306f\u591a\u304f\u306e\u8cc7\u6599\u304c\u3042\u308b\u306e\u3067\u5272\u611b\u3057\u307e\u3059\u3002\n[Docker Machine](https://github.com/docker/machine)\u3092\u4f7f\u7528\u3059\u308b\u306e\u304c\u7c21\u5358\u304b\u3068\u601d\u3044\u307e\u3059\u3002\n\nAnsible\u3068CloudStack\u30e2\u30b8\u30e5\u30fc\u30eb\u306e\u30a4\u30e1\u30fc\u30b8\u3092\u4f5c\u6210\u3059\u308b\u305f\u3081\u306eDockerfile\u3092\u7528\u610f\u3057\u307e\u3059\u3002\nPython\u30d1\u30c3\u30b1\u30fc\u30b8\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3001CloudStack\u30e2\u30b8\u30e5\u30fc\u30eb\u306e\u53d6\u5f97\u3001\u30e9\u30a4\u30d6\u30e9\u30ea\u306e\u30d1\u30b9\u3078\u306e\u8ffd\u52a0\u306a\u3069\u3092\u884c\u3063\u3066\u3044\u307e\u3059\u3002\n\n```Dockerfile:Dockerfile\nFROM python:2.7\nRUN pip install cs ansible sshpubkeys\nRUN mkdir -p /usr/share/ansible && \\\n    cd /usr/share/ansible && \\\n    git clone https://github.com/resmo/ansible-cloudstack.git\nRUN mkdir -p /etc/ansible ; \\\n    echo \"[defaults]\"                                       > /etc/ansible/ansible.cfg; \\\n    echo \"host_key_checking = False\"                       >> /etc/ansible/ansible.cfg; \\\n    echo \"library = /usr/share/ansible/ansible-cloudstack\" >> /etc/ansible/ansible.cfg\n```\n\nDockerfile\u304b\u3089\u30a4\u30e1\u30fc\u30b8\u3092\u30d3\u30eb\u30c9\u3057\u307e\u3059\u3002\n\n```bash\n$ docker build -t ansible .\n```\n\n```docker run``` \u3067\u4f5c\u6210\u3057\u305f\u30a4\u30e1\u30fc\u30b8\u306bAnsible\u304c\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u304c\u78ba\u8a8d\u3067\u304d\u307e\u3059\u3002\n\n```bash\n$ docker run --rm ansible ansible --version\nansible 1.9.4\n  configured module search path = None\n```\n\n### cs\u306e\u8a2d\u5b9a\n\nCloudStack\u30e2\u30b8\u30e5\u30fc\u30eb\u304c\u4f7f\u7528\u3057\u3066\u3044\u308b[cs](https://github.com/exoscale/cs)\u304cCloudStack API\u3092\u5b9f\u884c\u3067\u304d\u308b\u3088\u3046\u306b\u30a8\u30f3\u30c9\u30dd\u30a4\u30f3\u30c8\u3001API\u30ad\u30fc\u3001\u30b7\u30fc\u30af\u30ec\u30c3\u30c8\u30ad\u30fc\u306e\u8a2d\u5b9a\u3092\u884c\u3044\u307e\u3059\u3002\n\n\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092\u4f7f\u7528\u3057\u3066\u8a2d\u5b9a\u3059\u308b\u3053\u3068\u3082\u3067\u304d\u307e\u3059\u304c\u3001\u4eca\u56de\u306f\u74b0\u5883\u5909\u6570\u3092\u4f7f\u3063\u3066\u8a2d\u5b9a\u3057\u3066\u307f\u307e\u3059\u3002\n\n\u74b0\u5883\u5909\u6570`CLOUDSTACK_ENDPOINT`\u3001`CLOUDSTACK_KEY`\u3001`CLOUDSTACK_SECRET`\u306b\u30a8\u30f3\u30c9\u30dd\u30a4\u30f3\u30c8\u3001API\u30ad\u30fc\u3001\u30b7\u30fc\u30af\u30ec\u30c3\u30c8\u30ad\u30fc\u3092\u30bb\u30c3\u30c8\u3057\u307e\u3059\u3002\n\n\u307e\u305f\u3001\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u306e\u8a2d\u5b9a\u304c\u53b3\u3057\u3081\uff08\u30c7\u30d5\u30a9\u30eb\u30c810\u79d2\uff09\u3067\u5931\u6557\u3057\u3066\u3057\u307e\u3046\u3053\u3068\u304c\u3042\u308b\u306e\u3067\u3001\n\u4f59\u88d5\u3092\u898b\u30661\u5206\u306b\u4f38\u3070\u3057\u3066\u304a\u304d\u307e\u3059\u3002\uff08`CLOUDSTACK_TIMEOUT=60`\uff09\n\n\u30ed\u30fc\u30ab\u30eb\u306eAnsible\u3092\u4f7f\u7528\u3059\u308b\u5834\u5408\u306f\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u30a8\u30af\u30b9\u30dd\u30fc\u30c8\u3057\u307e\u3059\u3002\n\n```bash\n$ export CLOUDSTACK_ENDPOINT=<API\u306e\u30a8\u30f3\u30c9\u30dd\u30a4\u30f3\u30c8>\n$ export CLOUDSTACK_KEY=<API\u30ad\u30fc>\n$ export CLOUDSTACK_SECRET=<\u30b7\u30fc\u30af\u30ec\u30c3\u30c8\u30ad\u30fc>\n$ export CLOUDSTACK_TIMEOUT=60\n```\n\nDocker\u3092\u4f7f\u7528\u3059\u308b\u5834\u5408\u306f\u3001\u307e\u305a`.env`\u3068\u3044\u3046\u30d5\u30a1\u30a4\u30eb\u3092\u4ee5\u4e0b\u306e\u5185\u5bb9\u3067\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n```bash:.env\nCLOUDSTACK_ENDPOINT=<API\u306e\u30a8\u30f3\u30c9\u30dd\u30a4\u30f3\u30c8>\nCLOUDSTACK_KEY=<API\u30ad\u30fc>\nCLOUDSTACK_SECRET=<\u30b7\u30fc\u30af\u30ec\u30c3\u30c8\u30ad\u30fc>\nCLOUDSTACK_TIMEOUT=60\n```\n\n`docker run`\u306e\u30aa\u30d7\u30b7\u30e7\u30f3`--env-file`\u306b\u3053\u306e\u30d5\u30a1\u30a4\u30eb\u3092\u6307\u5b9a\u3059\u308b\u3068\u5b9f\u884c\u6642\u306b\u74b0\u5883\u5909\u6570\u304c\u30bb\u30c3\u30c8\u3055\u308c\u307e\u3059\u3002\n\n\u8a2d\u5b9a\u304c\u6b63\u3057\u304f\u3067\u304d\u3066\u3044\u308c\u3070\u3001```cs``` \u30b3\u30de\u30f3\u30c9\u3067API\u304c\u5b9f\u884c\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002\n\n```bash\n# \u30ed\u30fc\u30ab\u30eb\u306eAnsible\u3092\u4f7f\u7528\u3059\u308b\u5834\u5408\u306f\n\b$ cs listZones\n# Docker\u3092\u4f7f\u7528\u3059\u308b\u5834\u5408\n$ docker run --env-file=.env --rm ansible cs listZones\n```\n\n### SSH\u9375\u306e\u4f5c\u6210\n\n\u30db\u30b9\u30c8\u3078\u63a5\u7d9a\u3059\u308b\u305f\u3081\u306b\u4f7f\u7528\u3059\u308bSSH\u9375\u3092\u4f5c\u6210\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\n```bash\n$ ssh-keygen -f ansible_ssh -N \"\"\n```\n\n## Ansible\u3067Nginx\u30b5\u30fc\u30d0\u30fc\u3092\u69cb\u7bc9\u3059\u308b\n\n\u6e96\u5099\u304c\u6574\u3063\u305f\u306e\u3067\u3001\u4eee\u60f3\u30de\u30b7\u30f3\u4f5c\u6210\u3068\u30d7\u30ed\u30d3\u30b8\u30e7\u30cb\u30f3\u30b0\u306eNginx\u30b5\u30fc\u30d0\u30fc\u3092\u69cb\u7bc9\u3057\u3066\u307f\u307e\u3059\u3002\n\n### Inventory\u30d5\u30a1\u30a4\u30eb\n\nInventory\u30d5\u30a1\u30a4\u30eb\u306b\u4f5c\u6210\u3059\u308b\u30db\u30b9\u30c8\u3068\u30b0\u30eb\u30fc\u30d7\u306e\u8a2d\u5b9a\u3092\u66f8\u304d\u307e\u3059\u3002\n\n\u4eca\u56de\u306f```nginx01``` \u3068\u3044\u3046\u30db\u30b9\u30c8\u3092CloudStack\u4e0a\u306b\u4f5c\u6210\u3057\u3001Nginx\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u307e\u3059\u3002\n\nNginx\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u30db\u30b9\u30c8\u306e\u30b0\u30eb\u30fc\u30d7\u3092```nginx``` \u3001CloudStack\u4e0a\u306b\u4f5c\u6210\u3055\u308c\u308b\u30db\u30b9\u30c8\u3092```cloudstack``` \u30b0\u30eb\u30fc\u30d7\u3068\u3057\u3001```nginx01``` \u3092\u4e21\u65b9\u306e\u30b0\u30eb\u30fc\u30d7\u306b\u6240\u5c5e\u3055\u305b\u3066\u3044\u307e\u3059\u3002\uff08```nginx``` \u30b0\u30eb\u30fc\u30d7\u5168\u4f53\u3092```cloudstack``` \u30b0\u30eb\u30fc\u30d7\u306b\u542b\u3081\u3066\u3044\u307e\u3059\u3002\uff09\n\n```[all:vars]``` \u30bb\u30af\u30b7\u30e7\u30f3\u306b\u306f\u30ed\u30b0\u30a4\u30f3\u30e6\u30fc\u30b6\u30fc\u3084\u79d8\u5bc6\u9375\u306a\u3069\u5171\u901a\u3067\u4f7f\u7528\u3059\u308b\u8a2d\u5b9a\u3092\u66f8\u3044\u3066\u304a\u304d\u307e\u3059\u3002\n\n```ini:hosts\n[nginx]\nnginx01\n\n[cloudstack:children]\nnginx\n\n[all:vars]\nansible_ssh_user=root\nansible_ssh_private_key_file=./ansible_ssh\nansible_python_interpreter=python\ncache_dir=./cache\n```\n\n### \u5909\u6570\u306e\u8a2d\u5b9a\n\n```group_vars/cloudstack``` \u306b\u306f\u3001\u30c7\u30d5\u30a9\u30eb\u30c8\u3067\u4f7f\u7528\u3059\u308b\u30be\u30fc\u30f3\u3084\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u306a\u3069\u306eCloudStack\u306e\u8a2d\u5b9a\u3092\u66f8\u3044\u3066\u304a\u304d\u307e\u3059\u3002\n\n```yaml:group_vars/cloudstack\n---\n\nssh_public_key_file: \"./ansible_ssh.pub\"\nzone_name: \"joule\"\nnetwork_name: \"joule-network1\"\nservice_offering_name: \"light.S1\"\ntemplate_name: \"CentOS 7.1 64-bit\"\nfirewall_rules:\n  - { protocol: \"tcp\", start_port: 22, end_port: 22 }\nport_forwarding_rules:\n  - { protocol: \"tcp\", public_port: 22, private_port: 22 }\n```\n\nnginx\u30b0\u30eb\u30fc\u30d7\u306b\u3064\u3044\u3066\u306fSSH\u306e\u30dd\u30fc\u30c8\u3060\u3051\u3067\u306a\u304fHTTP\u306e\u30dd\u30fc\u30c8\u3082\u958b\u3051\u307e\u3059\u3002\n\n```yaml:group_vars/nginx\n---\n\nfirewall_rules:\n  - { protocol: \"tcp\", start_port: 22, end_port: 22 }\n  - { protocol: \"tcp\", start_port: 80, end_port: 80 }\nport_forwarding_rules:\n  - { protocol: \"tcp\", public_port: 22, private_port: 22 }\n  - { protocol: \"tcp\", public_port: 80, private_port: 80 }\n```\n\n### Playbook\u306e\u4f5c\u6210\n\n\u4eca\u56de\u306f\u4ee5\u4e0b\u306e3\u3064\u306ePlaybook\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n* deploy.yml\n    * \u4eee\u60f3\u30de\u30b7\u30f3\u306e\u30c7\u30d7\u30ed\u30a4\u3001IP\u30a2\u30c9\u30ec\u30b9\u306e\u53d6\u5f97\u3001\u30dd\u30fc\u30c8\u30d5\u30a9\u30ef\u30fc\u30c7\u30a3\u30f3\u30b0\u306e\u8a2d\u5b9a\u3092\u884c\u3046\n* nginx.yml\n    * \u4eee\u60f3\u30de\u30b7\u30f3\u306bNginx\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\n* clean.yml\n    * \u4f5c\u6210\u30fb\u53d6\u5f97\u3057\u305f\u30ea\u30bd\u30fc\u30b9\u3092\u524a\u9664\u30fb\u89e3\u653e\u3059\u308b\n\nPlaybook\u306f```ansible-blaybook``` \u30b3\u30de\u30f3\u30c9\u3067\u5b9f\u884c\u3067\u304d\u307e\u3059\u3002\n\n```bash\n$ ansible-playbook -i hosts PLAYBOOK.yml\n```\n\nDocker\u3092\u4f7f\u7528\u3057\u3066\u3044\u308b\u5834\u5408\u306b\u306f\u3001\u30ab\u30ec\u30f3\u30c8\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u30de\u30a6\u30f3\u30c8\u3057\u30b3\u30f3\u30c6\u30ca\u304b\u3089Playbook\u304c\u898b\u3048\u308b\u3088\u3046\u306b\u3057\u307e\u3059\u3002\n\n```bash\n$ docker run --env-file=.env -v $(pwd):/data -w /data --rm ansible \u00a5\n    ansible-playbook -i hosts PLAYBOOK.yml\n```\n\n\u4ee5\u4e0b\u305d\u308c\u305e\u308c\u306ePlaybook\u306b\u3064\u3044\u3066\u7c21\u5358\u306b\u5185\u5bb9\u3092\u8aac\u660e\u3057\u307e\u3059\u3002\n\u8a73\u7d30\u306b\u3064\u3044\u3066\u306f[\u30ec\u30dd\u30b8\u30c8\u30ea](https://github.com/atsaki/ansible-cloudstack-example-nginx)\u306e\u30d5\u30a1\u30a4\u30eb\u3092\u53c2\u7167\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n#### deploy.yml\n\n\n```deploy.yml``` \u306f\u30db\u30b9\u30c8\u3092CloudStack\u4e0a\u306b\u4f5c\u6210\u3057\u3001\u30d5\u30a1\u30a4\u30a2\u30a6\u30a9\u30fc\u30eb\u30fb\u30dd\u30fc\u30c8\u30d5\u30a9\u30ef\u30fc\u30c7\u30a3\u30f3\u30b0\u7b49\u306e\u8a2d\u5b9a\u3092\u884c\u3044\u30db\u30b9\u30c8\u306bSSH\u63a5\u7d9a\u53ef\u80fd\u306a\u72b6\u614b\u306b\u3057\u307e\u3059\u3002\n\n##### \u4eee\u60f3\u30de\u30b7\u30f3\u306e\u30c7\u30d7\u30ed\u30a4\n\n\u4eee\u60f3\u30de\u30b7\u30f3\u306e\u7ba1\u7406\u306f```cs_instance``` \u30e2\u30b8\u30e5\u30fc\u30eb\u3067\u884c\u3046\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\u5404\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u8a2d\u5b9a\u3059\u308b\u3060\u3051\u3067\u3001\u4eee\u60f3\u30de\u30b7\u30f3\u306e\u72b6\u614b\u3092\u6307\u5b9a\u3055\u308c\u3066\u3044\u308b\u72b6\u614b\u306b\u3057\u3066\u304f\u308c\u307e\u3059\u3002\n\nSSH\u63a5\u7d9a\u3059\u308b\u305f\u3081\u306b\u306f\u4eee\u60f3\u30de\u30b7\u30f3\u304c\u8d77\u52d5\u3057\u3066\u3044\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n```state: started``` \u3068\u3057\u3066\u304a\u304f\u3068\u3001```deploy.yml``` \u304c\u5b9f\u884c\u3055\u308c\u305f\u3068\u304d\u4eee\u60f3\u30de\u30b7\u30f3\u304c\u505c\u6b62\u3057\u3066\u3044\u305f\u3089\u8d77\u52d5\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\n``` yaml:deploy.yml\n    - name: \"VM\u306e\u4f5c\u6210\"\n      cs_instance:\n        name: \"{{ inventory_hostname }}\"\n        zone: \"{{ zone_name }}\"\n        networks: [\"{{ network_name }}\"]\n        service_offering: \"{{ service_offering_name }}\"\n        template: \"{{ template_name }}\"\n        ssh_key: \"{{ inventory_hostname }}\"\n        state: started\n      register: vm\n```\n\n##### IP\u30a2\u30c9\u30ec\u30b9\u306e\u53d6\u5f97\n\n\u4eee\u60f3\u30de\u30b7\u30f3\u3078\u306eSSH\u63a5\u7d9a\u3068Web\u30da\u30fc\u30b8\u3078\u306e\u63a5\u7d9a\u306e\u305f\u3081\u306bIP\u30a2\u30c9\u30ec\u30b9\u3092\u53d6\u5f97\u3057\u307e\u3059\u3002\n\nIP\u30a2\u30c9\u30ec\u30b9\u306e\u7ba1\u7406\u306f```cs_ip_address``` \u30e2\u30b8\u30e5\u30fc\u30eb\u3067\u884c\u3046\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\nIP\u30a2\u30c9\u30ec\u30b9\u306e\u53d6\u5f97\u306b\u3064\u3044\u3066\u306f\u6ce8\u610f\u304c\u5fc5\u8981\u3067\u3059\u3002\nAnsible\u306f\u57fa\u672c\u7684\u306b\u524d\u56de\u5b9f\u884c\u3057\u305f\u51e6\u7406\u3092\u899a\u3048\u3066\u3044\u306a\u3044\u306e\u3067\u3001\u5358\u306b```state: present``` \u3067\u53d6\u5f97\u3059\u308b\u3068\u3001\u5b9f\u884c\u306e\u305f\u3073\u306bIP\u30a2\u30c9\u30ec\u30b9\u3092\u53d6\u5f97\u3057\u3066\u3057\u307e\u3044\u307e\u3059\u3002\n\n\u5bfe\u7b56\u306f\u8272\u3005\u3042\u308a\u307e\u3059\u304c\u3001\u4eca\u56de\u306f\u53d6\u5f97\u3057\u305fIP\u30a2\u30c9\u30ec\u30b9\u3092\u66f8\u3044\u305f\u30d5\u30a1\u30a4\u30eb\u3092\u4fdd\u5b58\u3057\u3066\u304a\u304f\u3053\u3068\u306b\u3057\u307e\u3057\u305f\u3002\u30d5\u30a1\u30a4\u30eb\u304c\u5b58\u5728\u3059\u308b\u5834\u5408\u306f\u53d6\u5f97\u6e08\u307f\u306a\u306e\u3067\u51e6\u7406\u3092\u30b9\u30ad\u30c3\u30d7\u3057\u307e\u3059\u3002\n\n```yaml:deploy.yml\n    - name: \"\u30ad\u30e3\u30c3\u30b7\u30e5\u7528\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306e\u4f5c\u6210\"\n      file:\n        path: \"{{ vm_cache_dir }}\"\n        state: \"directory\"\n        mode: \"0755\"\n\n    - name: \"\u53d6\u5f97\u6e08\u307fIP\u30a2\u30c9\u30ec\u30b9\u306e\u78ba\u8a8d\"\n      stat:\n        path: \"{{ vm_cache_dir + '/ip_address' }}\"\n      register: cache_ip_address\n\n    - name: \"\u65b0\u898fIP\u30a2\u30c9\u30ec\u30b9\u306e\u53d6\u5f97\"\n      cs_ip_address:\n        zone: \"{{ zone_name }}\"\n        network: \"{{ network_name }}\"\n      register: ip_address\n      when: not cache_ip_address.stat.exists\n\n    - name: \"\u53d6\u5f97\u3057\u305fIP\u30a2\u30c9\u30ec\u30b9\u3092\u30ad\u30e3\u30c3\u30b7\u30e5\u3078\u66f8\u304d\u8fbc\u307f\"\n      copy:\n        content: \"{{ ip_address.ip_address }}\"\n        dest: \"{{ vm_cache_dir + '/ip_address' }}\"\n      when: not cache_ip_address.stat.exists\n\n    - name: \"IP\u30a2\u30c9\u30ec\u30b9\u306e\u30ad\u30e3\u30c3\u30b7\u30e5\u8aad\u307f\u8fbc\u307f\"\n      set_fact:\n        ip_address: \"{{ lookup('file', vm_cache_dir + '/ip_address') }}\"\n```\n\n##### \u30d5\u30a1\u30a4\u30a2\u30a6\u30a9\u30fc\u30eb\u30fb\u30dd\u30fc\u30c8\u30d5\u30a9\u30ef\u30fc\u30c7\u30a3\u30f3\u30b0\u30eb\u30fc\u30eb\u306e\u8a2d\u5b9a\n\nIP\u30a2\u30c9\u30ec\u30b9\u304c\u53d6\u5f97\u3067\u304d\u305f\u306e\u3067\u3001SSH\u3068HTTP\u306e\u30d5\u30a1\u30a4\u30a2\u30a6\u30a9\u30fc\u30eb\u3068\n\u30dd\u30fc\u30c8\u30d5\u30a9\u30ef\u30fc\u30c7\u30a3\u30f3\u30b0\u30eb\u30fc\u30eb\u3092\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\n\u30d5\u30a1\u30a4\u30a2\u30a6\u30a9\u30fc\u30eb\u3068\u30dd\u30fc\u30c8\u30d5\u30a9\u30ef\u30fc\u30c7\u30a3\u30f3\u30b0\u30eb\u30fc\u30eb\u306e\u7ba1\u7406\u306b\u306f\u305d\u308c\u305e\u308c```cs_firewall```\u3001```cs_portforward``` \u3092\u4f7f\u7528\u3057\u307e\u3059\u3002\n\n\u3053\u308c\u3089\u306e\u30e2\u30b8\u30e5\u30fc\u30eb\u3092\u4f7f\u7528\u3059\u308b\u969b\u306e\u6ce8\u610f\u70b9\u306f\u3001\u5fc5\u305a\u30be\u30fc\u30f3\u3092\u6307\u5b9a\u3059\u308b\u3053\u3068\u3067\u3059\u3002\n\u30be\u30fc\u30f3\u306a\u3057\u3067\u306f\u610f\u56f3\u3057\u3066\u3044\u306a\u3044\u30be\u30fc\u30f3\u3067IP\u30a2\u30c9\u30ec\u30b9\u3092\u63a2\u3057\u3066\u30a8\u30e9\u30fc\u306b\u306a\u308b\u5834\u5408\u304c\u3042\u308a\u307e\u3059\u3002\n\n```yaml:deploy.yml\n    - name: \"\u30d5\u30a1\u30a4\u30a2\u30a6\u30a9\u30fc\u30eb\u30eb\u30fc\u30eb\u306e\u8a2d\u5b9a\"\n      cs_firewall:\n        zone: \"{{ zone_name }}\"\n        ip_address: \"{{ ip_address }}\"\n        protocol: \"{{ item.protocol }}\"\n        start_port: \"{{ item.start_port }}\"\n        end_port: \"{{ item.end_port }}\"\n        cidr: \"{{ item.cidr|default('0.0.0.0/0') }}\"\n      with_items: firewall_rules\n```\n\n##### SSH\u63a5\u7d9a\u53ef\u80fd\u306b\u306a\u308b\u307e\u3067\u5f85\u6a5f\n\n\u6700\u5f8c\u306b\u4eee\u60f3\u30de\u30b7\u30f3\u304cSSH\u63a5\u7d9a\u53ef\u80fd\u306b\u306a\u308b\u307e\u3067\u5f85\u6a5f\u3057\u307e\u3059\u3002\n\n```yaml:deploy.yml\n    - name: \"SSH\u3067\u63a5\u7d9a\u53ef\u80fd\u306b\u306a\u308b\u307e\u3067\u5f85\u6a5f\"\n      wait_for:\n        host: \"{{ ip_address }}\"\n        port: \"{{ ansible_ssh_port|default(22) }}\"\n        search_regex: \"OpenSSH\"\n\n    - name: \"authorized_keys\u306e\u8a2d\u5b9a\u306b\u6642\u9593\u304c\u304b\u304b\u308b\u5834\u5408\u304c\u3042\u308b\u306e\u3067\u4f59\u5206\u306b\u5f85\u6a5f\"\n      pause: minutes=2\n      when: vm|changed\n```\n\n##### \u4f5c\u6210\u3057\u305f\u4eee\u60f3\u30de\u30b7\u30f3\u306bSSH\u30ed\u30b0\u30a4\u30f3\n\n\u4f5c\u6210\u3057\u305f\u4eee\u60f3\u30de\u30b7\u30f3\u306b\u306f\u4ee5\u4e0b\u306e\u30b3\u30de\u30f3\u30c9\u3067\u30ed\u30b0\u30a4\u30f3\u3067\u304d\u307e\u3059\u3002\n\n```bash\n$ ssh -i ansible_ssh root@$(cat cache/nginx01/ip_address)\n```\n\n#### nginx.yml\n\n```nginx.yml```\u306f\u30db\u30b9\u30c8\u306bNginx\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u307e\u3059\u3002\n\n```yaml:nginx.yml\n---\n\n- hosts: nginx\n  gather_facts: no\n  pre_tasks:\n    - include: set_ansible_ssh_host.yml\n  tasks:\n    - name: \"Nginx\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb(Ubuntu)\"\n      apt:\n        name: \"nginx\"\n        update_cache: yes\n      when: ansible_distribution == 'Ubuntu'\n\n    - name: \"EPEL\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb(CentOS)\"\n      yum:\n        name: \"epel-release\"\n      when: ansible_distribution == 'CentOS'\n\n    - name: \"Nginx\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb(CentOS)\"\n      yum:\n        name: \"nginx\"\n      when: ansible_distribution == 'CentOS'\n\n    - name: \"Nginx\u3092\u8d77\u52d5\"\n      service:\n        name: \"nginx\"\n        enabled: yes\n        state: started\n```\n\nNginx\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u30bf\u30b9\u30af\u306e\u5b9f\u884c\u524d\u306b\u3001```pre_tasks``` \u3067```set_ansible_ssh_host.yml``` \u3092\u5b9f\u884c\u3057\u3066\u3044\u307e\u3059\u3002\n```set_ansible_ssh_host.yml``` \u3067\u306f\u53d6\u5f97\u6e08\u307f\u306eIP\u30a2\u30c9\u30ec\u30b9\u3092\u8abf\u3079```ansible_ssh_host``` \u306b\u3092\u30bb\u30c3\u30c8\u3057\u3001\u5bfe\u8c61\u30db\u30b9\u30c8\u306bSSH\u3067\u304d\u308b\u3088\u3046\u306b\u3057\u3066\u3044\u307e\u3059\u3002\n\n```set_ansible_ssh_host.yml``` \u306f\u3001\u30db\u30b9\u30c8\u60c5\u5831\u306e\u53d6\u5f97\u3082\u884c\u3044\u307e\u3059\u3002\n\u3053\u308c\u306b\u3088\u308a\u30db\u30b9\u30c8\u306e\u60c5\u5831\u306b\u3088\u3063\u3066\u51e6\u7406\u3092\u5909\u66f4\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n```nginx.yml```\u3067\u306f\u3001\u30c7\u30a3\u30b9\u30c8\u30ea\u30d3\u30e5\u30fc\u30b7\u30e7\u30f3\u306b\u3088\u3063\u3066\u4f7f\u7528\u3059\u308b\u30e2\u30b8\u30e5\u30fc\u30eb\u3092\n\u5909\u66f4\u3057CentOS\u3001Ubuntu\u306e\u4e21\u65b9\u306b\u5bfe\u5fdc\u3057\u3066\u3044\u307e\u3059\u3002\n\n```yaml:set_ansible_ssh_host.yml\n---\n\n- set_fact:\n    vm_cache_dir: \"{{ cache_dir + '/' + inventory_hostname }}\"\n\n- name: \"\u53d6\u5f97\u6e08\u307fIP\u30a2\u30c9\u30ec\u30b9\u306e\u78ba\u8a8d\"\n  stat:\n    path: \"{{ vm_cache_dir + '/ip_address' }}\"\n  register: cache_ip_address\n  connection: local\n  failed_when: not cache_ip_address.stat.exists\n\n- name: \"ansible_ssh_host\u306b\u53d6\u5f97\u6e08\u307f\u306eIP\u3092\u30bb\u30c3\u30c8\"\n  set_fact:\n    ansible_ssh_host: \"{{ lookup('file', vm_cache_dir + '/ip_address') }}\"\n\n- name: \"\u4eee\u60f3\u30de\u30b7\u30f3\u306e\u30b9\u30c6\u30fc\u30bf\u30b9\u3092\u78ba\u8a8d\"\n  cs_instance:\n    name: \"{{ inventory_hostname }}\"\n    zone: \"{{ zone_name }}\"\n    state: present\n  connection: local\n  register: instance\n\n- name: \"\u30db\u30b9\u30c8\u60c5\u5831\u306e\u53d6\u5f97\"\n  setup:\n  when: instance.state == \"Running\"\n```\n\n\u30d7\u30ed\u30d3\u30b8\u30e7\u30cb\u30f3\u30b0\u304c\u6b63\u5e38\u306b\u5b8c\u4e86\u3057\u3066\u3044\u308c\u3070\u3001\u30d6\u30e9\u30a6\u30b6\u3067```cache/nginx01/ip_address``` \u306eIP\u30a2\u30c9\u30ec\u30b9\u3092\n\u958b\u304f\u3068Nginx\u306e\u753b\u9762\u304c\u8868\u793a\u3055\u308c\u307e\u3059\u3002\n\n#### clean.yml\n\nclean.yml\u306f\u4f5c\u6210\u30fb\u53d6\u5f97\u3057\u305f\u30ea\u30bd\u30fc\u30b9\u3092\u89e3\u653e\u30fb\u89e3\u9664\u3059\u308b\u305f\u3081\u306ePlaybook\u3067\u3059\u3002\n\n\u524a\u9664\u306e\u969b\u3082\u30be\u30fc\u30f3\u306e\u6307\u5b9a\u3092\u5fd8\u308c\u306a\u3044\u3088\u3046\u6ce8\u610f\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\u30be\u30fc\u30f3\u3092\u6307\u5b9a\u3057\u3066\u3044\u306a\u3044\u5834\u5408\u3001\u8907\u6570\u30be\u30fc\u30f3\u306b\u540c\u3058\u540d\u524d\u306e\u30ea\u30bd\u30fc\u30b9\u304c\u5b58\u5728\u3059\u308b\u3068\n\u610f\u56f3\u3057\u3066\u3044\u306a\u3044\u307b\u3046\u304c\u6d88\u3055\u308c\u308b\u5834\u5408\u304c\u3042\u308a\u307e\u3059\u3002\n\n```yaml:clean.yml\n---\n\n- hosts: cloudstack\n  connection: local\n  tasks:\n    - set_fact:\n        vm_cache_dir: \"{{ cache_dir + '/' + inventory_hostname }}\"\n    \n    - name: \"SSH\u516c\u958b\u9375\u306e\u524a\u9664\"\n      cs_sshkeypair:\n        name: \"{{ inventory_hostname }}\"\n        state: absent\n    \n    - name: \"\u53d6\u5f97\u6e08\u307fIP\u30a2\u30c9\u30ec\u30b9\u306e\u78ba\u8a8d\"\n      stat:\n        path: \"{{ vm_cache_dir + '/ip_address' }}\"\n      register: cache_ip_address\n    \n    - name: \"IP\u30a2\u30c9\u30ec\u30b9\u306e\u30ad\u30e3\u30c3\u30b7\u30e5\u8aad\u307f\u8fbc\u307f\"\n      set_fact:\n        ip_address: \"{{ lookup('file', vm_cache_dir + '/ip_address') }}\"\n      when: cache_ip_address.stat.exists\n    \n    - name: \"IP\u30a2\u30c9\u30ec\u30b9\u306e\u89e3\u653e\"\n      cs_ip_address:\n        zone: \"{{ zone_name }}\"\n        network: \"{{ network_name }}\"\n        ip_address: \"{{ ip_address }}\"\n        state: absent\n      when: cache_ip_address.stat.exists\n    \n    - name: \"IP\u30a2\u30c9\u30ec\u30b9\u30ad\u30e3\u30c3\u30b7\u30e5\u306e\u524a\u9664\"\n      file:\n        path: \"{{ vm_cache_dir + '/ip_address' }}\"\n        state: absent\n      when: cache_ip_address.stat.exists\n    \n    - name: \"VM\u306e\u524a\u9664\"\n      cs_instance:\n        name: \"{{ inventory_hostname }}\"\n        zone: \"{{ zone_name }}\"\n        state: expunged\n\n    - name: \"\u30ad\u30e3\u30c3\u30b7\u30e5\u7528\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306e\u524a\u9664\"\n      file:\n        path: \"{{ vm_cache_dir }}\"\n        state: absent\n```\n\n## \u6700\u5f8c\u306b\n\n\u3053\u3053\u307e\u3067Ansible\u3067\u4eee\u60f3\u30de\u30b7\u30f3\u3092\u4f5c\u6210\u3057\u30d7\u30ed\u30d3\u30b8\u30e7\u30cb\u30f3\u30b0\u3059\u308b\u65b9\u6cd5\u3092\u307f\u3066\u304d\u307e\u3057\u305f\u304c\u3001\n\u4eca\u56de\u6271\u3063\u305f\u5185\u5bb9\u3067\u3042\u308c\u3070Vagrant\u3084Terraform\u3092\u4f7f\u7528\u3057\u305f\u65b9\u304c\u826f\u3044\u3068\u601d\u3044\u307e\u3059\u3002\n\u3053\u308c\u3089\u306e\u30c4\u30fc\u30eb\u306fID\u3067\u30ea\u30bd\u30fc\u30b9\u3092\u7ba1\u7406\u3057\u3066\u3044\u308b\u305f\u3081\u3001\u610f\u56f3\u3057\u306a\u3044\u30ea\u30bd\u30fc\u30b9\u3092\u64cd\u4f5c\n\u3057\u3066\u3057\u307e\u3046\u5371\u967a\u304c\u5c11\u306a\u304f\u5b89\u5168\u3067\u3059\u3002\u307e\u305f\u3001\u7528\u9014\u304c\u9650\u3089\u308c\u3066\u3044\u308b\u306e\u3067\u8a2d\u5b9a\u3082\u7c21\u5358\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002\n\nAnsible\u3067CloudStack\u3092\u64cd\u4f5c\u3059\u308b\u30e1\u30ea\u30c3\u30c8\u306f\u3001\u7d30\u304b\u3044\u51e6\u7406\u306e\u624b\u9806\u3092\u8a18\u8ff0\u3057\u3084\u3059\u3044\u3053\u3068\u3001\n\u65e2\u5b58\u306e\u30ea\u30bd\u30fc\u30b9\u3092\u7ba1\u7406\u5bfe\u8c61\u306b\u3057\u3084\u3059\u3044\u3053\u3068\u3001\u5bfe\u5fdc\u3057\u3066\u3044\u308b\u30ea\u30bd\u30fc\u30b9\u304c\u591a\u3044\u3053\u3068\u306b\u3042\u308b\u3068\u601d\u3044\u307e\u3059\u3002\n\n\u6b21\u56de\u306f\u3001\u5fdc\u7528\u7de8\u3068\u3057\u3066\u3053\u308c\u3089\u306e\u30e1\u30ea\u30c3\u30c8\u304c\u6d3b\u7528\u3067\u304d\u308b\u4f8b\u3068\u3057\u3066\u65e2\u5b58\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u306e\u30ab\u30b9\u30bf\u30de\u30a4\u30ba\u3092\u884c\u3044\u307e\u3059\u3002\n\n[Ansible\u3067CloudStack\u3092\u64cd\u4f5c\u3059\u308b\uff08\u5fdc\u7528\u7de8\uff1aIDCF\u30af\u30e9\u30a6\u30c9\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u306e\u30ab\u30b9\u30bf\u30de\u30a4\u30ba\uff09 - Qiita](http://qiita.com/atsaki/items/bb2145bf50e6009d6e6b)\n", "tags": ["Ansible", "CloudStack", "docker", "IDCF\u30af\u30e9\u30a6\u30c9"]}