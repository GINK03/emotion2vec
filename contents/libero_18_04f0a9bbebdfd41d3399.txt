{"context": " More than 1 year has passed since last update.\n\n\u80cc\u666f\n\nWhy?\n\u30a4\u30f3\u30d5\u30e9\u306e\u69cb\u7bc9\u4f5c\u696d\u3092\u81ea\u50cd\u5316\u3057\u305f\u3044\n\nHow?\n\u30df\u30c9\u30eb\u30a6\u30a7\u30a2\u306e\u30ec\u30a4\u30e4\u30fc\u3092\u5bfe\u8c61\u3068\u3057\u3001Chef\u306a\u3069\u306e\u30c4\u30fc\u30eb\u3092\u5229\u7528\u3057\u3066\u5b9f\u88c5\u3059\u308b\n\nWhat?\n\u81ea\u52d5\u69cb\u7bc9\u3057\u305f\u74b0\u5883\u304c\u610f\u56f3\u3057\u305f\u901a\u308a\u306e\u8a2d\u5b9a\u306b\u306a\u3063\u3066\u3044\u308b\u306e\u304b\u3001\u7e70\u308a\u8fd4\u3057\u78ba\u8a8d\u3057\u305f\u3044\n\n\u4f5c\u696d\u74b0\u5883\n\n\n\nsoftware\nversion\n\n\n\n\nMac OS X\n10.8.5\n\n\nzsh\n4.3.11 (i386-apple-darwin12.0)\n\n\ngit\n1.8.4.3\n\n\nHomebrew\n0.9.5\n\n\nanyenv\n-\n\n\nrbenv\n0.4.0-67-g3300587\n\n\nruby\n2.0.0-p247\n\n\nbundler\n1.3.5\n\n\n\n\n-- \u88dc\u8db3 --\n\ngit \u306f Homebrew \u306b\u3088\u3063\u3066\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3055\u308c\u3066\u307e\u3059\nrbenv \u306f anyenv \u306b\u3088\u3063\u3066\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3055\u308c\u3066\u307e\u3059\nruby \u306f rbenv \u306b\u3088\u3063\u3066\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3055\u308c\u3066\u307e\u3059\n\n\n\u524d\u63d0\n\u57fa\u672c\u7684\u306b\u306f\u3001 serverspec \u306e\u4e26\u5217\u51e6\u7406 \u3067 @gosukenator \u3055\u3093\u304c\u66f8\u304b\u308c\u3066\u3044\u308b\u3088\u3046\u306b parallel_tests \u3092\u4f7f\u3048\u3070\u826f\u3044\u3068\u601d\u3044\u307e\u3059\n\u305f\u3060\u3057\u3001\u81ea\u5206\u306e\u3088\u3046\u306b serverspec \u3067\u30db\u30b9\u30c8\u56fa\u6709\u306e\u5c5e\u6027\u5024\u3092\u6271\u3046\u65b9\u6cd5 \u306e\u3088\u3046\u306b\u5404\u30db\u30b9\u30c8\u306e\u5c5e\u6027\u5024\u3092YAML\u3067\u53d6\u5f97\u3057\u3066Rake\u304b\u3089\u5b9f\u884c\u3059\u308b\u5834\u5408\u306b\u306f\u3001 parallel_tests \u3067\u306f\u4e0a\u624b\u304f\u884c\u304b\u306a\u304b\u3063\u305f\u306e\u3067\u3001\u305d\u308c\u3092\u8a66\u884c\u932f\u8aa4\u3057\u3066\u3067\u304d\u305f\u7d50\u679c\u304c\u3053\u306e\u30e1\u30e2\u306b\u306a\u308a\u307e\u3059\n\n1. \u30db\u30b9\u30c8\u3054\u3068\u306e\u5c5e\u6027\u5024\u3092\u5b9a\u7fa9\u3059\u308b\n\nconf/attributes.yml\nhost1:\n  :service:\n    - 'os'\n    - 'user'\n    - 'ntp'\n    - 'ssh'\n    - 'apache22'\n  :os_base_type:            'FreeBSD'\n  :os_base_version:         'xxx.xxx-RELEASE-xxx'\n  :os_base_architecture:    'amd64'\nhost2:\n  :service:\n    - 'os'\n    - 'user'\n    - 'ntp'\n    - 'ssh'\n    - 'postgresql'\n  :os_base_type:            'FreeBSD'\n  :os_base_version:         'xxx.xxx-RELEASE-xxx'\n  :os_base_architecture:    'amd64'\nhost3:\n  :service:\n\u4ee5\u4e0b\u7565\n\n\n\n2. Rake\u30bf\u30b9\u30af\u3092\u5b9a\u7fa9\u3059\u308b\n#  encoding: utf-8\nATTRIBUTES_FILE = 'conf/attributes.yml'\nRSPEC_OPTIONS = '-c -fs'\n\nPROCESSES_NUMBER = 3\nTHREAD_NUMBER = 12\n\nrequire 'rake'\nrequire 'rspec/core/rake_task'\nrequire 'yaml'\nrequire 'parallel'\n\n#  Rake task\n#  rake all\ndesc \"Parallel Runs Targets => registered all-hosts\"\ntask :all => 'serverspec:parallel_all_hosts'\n\n#  rake host\\[hostname\\]\ndesc \"Parallel Runs Targets => registered host all-services\"\ntask :host, \"hostname\"\ntask :host do |x, args| Rake::Task['serverspec:parallel_all_services'].invoke(args.hostname) end\n\n#  rake parallel\n#desc \"Serial Runs Targets => registered all-hosts\"\ntask :serial_all => 'serverspec:all_hosts'\n\n#  Load 'host list & host service list' data\nattributes = YAML.load_file(ATTRIBUTES_FILE)\n\nnamespace :serverspec do\n  task :all_hosts => attributes.keys.map {|host| 'serverspec:' + host.split('.')[0] }\n    attributes.keys.each do |host|\n      if File.exist?(\"spec/#{host}/\") then\n        desc \"Serial Runs Targets   => #{host}\"\n        RSpec::Core::RakeTask.new(host.split('.')[0].to_sym) do |t|\n          ENV['TARGET_HOST'] = host\n          t.rspec_opts = RSPEC_OPTIONS\n          t.pattern = \"spec/#{host}/{\" + attributes[host][:service].join(',') + '}/*_spec.rb'\n        end\n      end\n    end\n  attributes.keys.map {|host|\n    attributes[host][:service].each do |service|\n      task :service => ('serverspec:' + host.split('.')[0] + '_' + service.split('.')[0]).to_sym\n      if File.exist?(\"spec/#{host}/#{service}/\") then\n        desc \"Serial Runs Targets   => #{host}: #{service}\"\n        RSpec::Core::RakeTask.new((host.split('.')[0] + '_' + service.split('.')[0]).to_sym) do |t|\n          ENV['TARGET_HOST'] = host\n          t.rspec_opts = RSPEC_OPTIONS\n          t.pattern = \"spec/#{host}/#{service}/*_spec.rb\"\n        end\n      end\n    end\n  }\n  task :parallel_all_hosts do\n    Parallel.each(attributes.keys, in_processes: PROCESSES_NUMBER) do |host|\n      Parallel.each(attributes[host][:service], in_threads: THREAD_NUMBER) do |service|\n        if File.exist?(\"spec/#{host}/#{service}/\") then\n          require 'open3'\n          command = 'rake serverspec:' + host.split('.')[0] + '_' + service.split('.')[0]\n          o, e, s = Open3.capture3(command)\n          puts o #  stdout\n          puts e #  stderr\n          # puts s #  status\n        end\n      end\n    end\n  end\n  task :parallel_all_services, \"hostname\"\n  task :parallel_all_services do |x, args|\n    host = args.hostname\n    Parallel.each(attributes[host][:service], in_threads: THREAD_NUMBER) do |service|\n      if File.exist?(\"spec/#{host}/#{service}/\") then\n        require 'open3'\n        command = 'rake serverspec:' + host.split('.')[0] + '_' + service.split('.')[0]\n        o, e, s = Open3.capture3(command)\n        puts o #  stdout\n        puts e #  stderr\n        # puts s #  status\n      end\n    end\n  end\nend\n\n\n\n-- \u8ab2\u984c --\n\n\u4ed6\u306e\u4eba\u306e\u30b3\u30fc\u30c9\u3092\u53c2\u8003\u306b\u3001\u521d\u3081\u3066\u66f8\u3044\u305f\u306e\u3067\u7d30\u304b\u3044\u3053\u3068\u306f\u826f\u304f\u308f\u304b\u3063\u3066\u306a\u3044\uff57\n\u540c\u3058\u3053\u3068\u3092\u7e70\u308a\u8fd4\u3057\u66f8\u3044\u3066\u3044\u308b\u306e\u3067\u3001\u76f4\u3057\u65b9\u306f\u77e5\u3089\u306a\u3044\u3051\u3069\u30b9\u30c3\u30ad\u30ea\u3059\u308b\u3088\u3046\u306b\u4fee\u6b63\u3057\u305f\u3044\nparallel \u3067\u4e26\u5217\u51e6\u7406\u3059\u308b\u305f\u3081\u306e\u5024\u306f\u3001\u5916\u90e8\u304b\u3089\u5f15\u6570\u3067\u4e0a\u66f8\u304d\u6307\u5b9a\u304c\u3067\u304d\u308b\u3088\u3046\u306b\u3057\u305f\u3044\n\n\u3068\u304b\u8ab2\u984c\u304c\u8272\u3005\u3068\u3042\u308b\u30a4\u30f3\u30d5\u30e9\u30a8\u30f3\u30b8\u30cb\u30a2\u306e\u66f8\u3044\u305f\u3072\u3069\u3044\u30b3\u30fc\u30c9\u3067\u3059\u304c\u3001\u81ea\u5206\u304c\u3084\u308a\u305f\u304b\u3063\u305f\u76ee\u7684\u306f\u9054\u6210\u3067\u304d\u305f\u306e\u3067\u4eca\u306e\u3068\u3053\u308d\u306f\u3053\u308c\u3067\u8a31\u5bb9\u3057\u3066\u307e\u3059\n\u3068\u308a\u3042\u3048\u305a\u3001\u3053\u306e\u72b6\u614b\u3067\nrake -T \u3092\u5b9f\u884c\u3059\u308b\u3068\nrake all                          # Parallel Runs Targets => registered all-hosts\nrake host[hostname]               # Parallel Runs Targets => registered host all-services\nrake serverspec:host1             # Serial Runs Targets   => host1\nrake serverspec:host1_apache22    # Serial Runs Targets   => host1: apache22\nrake serverspec:host1_ntp         # Serial Runs Targets   => host1: ntp\nrake serverspec:host1_os          # Serial Runs Targets   => host1: os\nrake serverspec:host1_ssh         # Serial Runs Targets   => host1: ssh\nrake serverspec:host1_user        # Serial Runs Targets   => host1: user\nrake serverspec:host2             # Serial Runs Targets   => host2\nrake serverspec:host2_ntp         # Serial Runs Targets   => host2: ntp\nrake serverspec:host2_os          # Serial Runs Targets   => host2: os\nrake serverspec:host2_postgresql  # Serial Runs Targets   => host2: postgresql\nrake serverspec:host2_ssh         # Serial Runs Targets   => host2: ssh\nrake serverspec:host2_user        # Serial Runs Targets   => host2: user\nrake serverspec:host3             # Serial Runs Targets   => host3\n\u4ee5\u4e0b\u7565\n\n\u30fb\u5168\u30db\u30b9\u30c8\u3092\u5bfe\u8c61\u306b\u5b9f\u884c\n\u30fb\u6307\u5b9a\u30db\u30b9\u30c8\u3092\u5bfe\u8c61\u306b\u5b9f\u884c\n\u30fb\u6307\u5b9a\u30db\u30b9\u30c8\u306e\u6307\u5b9a\u30b5\u30fc\u30d3\u30b9\u3092\u5bfe\u8c61\u306b\u5b9f\u884c\n\u3068\u5404\u7a2e\u30bf\u30b9\u30af\u304c\u7528\u610f\u3055\u308c\u3066\u3044\u308b\u72b6\u614b\u306b\u3067\u304d\u307e\u3059\n\n3. \u5168\u30db\u30b9\u30c8\u3092\u5bfe\u8c61\u306b\u3057\u305f\u30c6\u30b9\u30c8\u3092\u5b9f\u884c\u3057\u305f\u5834\u5408\nRakefile \u306e\ntask :all_hosts => attributes.keys.map {|host| 'serverspec:' + host.split('.')[0] }\n\n\u306e\u3068\u3053\u308d\u3067\u3001\u5b9f\u969b\u306b\u884c\u308f\u308c\u3066\u3044\u308b\u51e6\u7406\u306f\ntask :all_hosts => [serverspec:host1,serverspec:host2,serverspec:host3]\n\n\u4e0a\u8a18\u306e\u3088\u3046\u306b\u4e8b\u524d\u30bf\u30b9\u30af\u3092\u5b9f\u884c\u3059\u308b\u30bf\u30b9\u30af\u3068\u3057\u3066\u5b9a\u7fa9\u3055\u308c\u3066\u3044\u307e\u3059\n\u3042\u3068\u306f\u3001\u4e26\u5217\u51e6\u7406\u3092\u5b9f\u884c\u3059\u308b\u305f\u3081\u306e\u30bf\u30b9\u30af\u3092\u4f5c\u6210\u3057\u3066\u3001\ntask :parallel_all_hosts do\n\nparallel \u3067\u5404\u30db\u30b9\u30c8\u3092 in_processes \u3067\u4e26\u5217\u5b9f\u884c\u3057\u3001\nParallel.each(attributes.keys, in_processes: PROCESSES_NUMBER) do |host|\n\n\u3055\u3089\u306b\u3001\u305d\u308c\u305e\u308c\u306e\u30db\u30b9\u30c8\u5185\u3067\u5b9a\u7fa9\u3055\u308c\u3066\u3044\u308b\u30b5\u30fc\u30d3\u30b9\u3092 in_threads \u3067\u4e26\u5217\u51e6\u7406\u3057\u3066\u3044\u307e\u3059\nParallel.each(attributes[host][:service], in_threads: THREAD_NUMBER) do |service|\n\n\n4. rake\u30bf\u30b9\u30af\u5b9f\u884c\u6642\u306b\u5185\u90e8\u51e6\u7406\u3057\u3066\u3044\u308b\u3053\u3068\n\u5b9f\u969b\u306b\u5185\u90e8\u3067\u3084\u3063\u3066\u308b\u51e6\u7406\u81ea\u4f53\u306f\u3001\n\n\n\u4e8b\u524d\u30bf\u30b9\u30af\u3092\u5b9a\u7fa9\u3057\u305f\u3001\u5168\u30db\u30b9\u30c8\u5b9f\u884c\u7528\u306e\u30bf\u30b9\u30af\u3092\u5b9a\u7fa9\u3059\u308b\n\n\u4e0a\u8a18\u30bf\u30b9\u30af\u306e\u51e6\u7406\u904e\u7a0b\u3067\u3001\u4e8b\u524d\u30bf\u30b9\u30af\u3068\u5b9a\u7fa9\u3055\u308c\u3066\u3044\u305f\u500b\u5225\u30db\u30b9\u30c8\u5b9f\u884c\u7528\u306e\u30bf\u30b9\u30af\u304c\u5b9a\u7fa9\u3055\u308c\u308b\n\n\n\u500b\u5225\u30db\u30b9\u30c8\u306e\u6307\u5b9a\u3057\u305f\u30b5\u30fc\u30d3\u30b9\u306e\u307f\u3092\u5b9f\u884c\u3067\u304d\u308b\u30bf\u30b9\u30af\u3092\u5b9a\u7fa9\u3057\u3066\u3044\u308b\n\n\u5168\u30db\u30b9\u30c8\u3092\u5bfe\u8c61\u306b\u4e26\u5217\u5b9f\u884c\u3059\u308b\u30bf\u30b9\u30af\u3092\u5b9a\u7fa9\n\n\u4e0a\u8a18\u30bf\u30b9\u30af\u304b\u3089\u3001 rake \u30b3\u30de\u30f3\u30c9\u304c\u4e26\u5217\u3067\u5b9f\u884c\u3055\u308c\u308b\n\u305d\u306e\u969b\u306b\u3001\u5b9f\u884c\u3057\u305f\u30c6\u30b9\u30c8\u30b3\u30fc\u30c9\u306e\u7d50\u679c\u8868\u793a\u304c\u6df7\u3056\u3089\u306a\u3044\u3088\u3046\u306b\u3001 open3 \u3092\u5229\u7528\u3057\u3066\u6a19\u6e96\u51fa\u529b\u3068\u30a8\u30e9\u30fc\u51fa\u529b\u3092\u5404 rake \u30b3\u30de\u30f3\u30c9\u5358\u4f4d\u3067\u753b\u9762\u51fa\u529b\u3059\u308b\u3088\u3046\u306b\u3057\u3066\u3044\u307e\u3059\n\n\n\n\u304f\u3089\u3044\u306a\u306e\u3067\u3001YAML\u3092\u5229\u7528\u3057\u306a\u3044\u5834\u5408\u306f\u3001\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306e\u30ea\u30b9\u30c8\u304b\u3089 map \u3092\u4f5c\u6210\u3057\u3066\u4e26\u5217\u51e6\u7406\u3059\u308b\u3068\u304b\u3084\u308c\u3070\u826f\u3044\u306e\u3067\u306f\u306a\u3044\u304b\u3068\u601d\u3044\u307e\u3059\n\n\n## \u80cc\u666f\n### Why?\n\u30a4\u30f3\u30d5\u30e9\u306e\u69cb\u7bc9\u4f5c\u696d\u3092\u81ea\u50cd\u5316\u3057\u305f\u3044\n### How?\n\u30df\u30c9\u30eb\u30a6\u30a7\u30a2\u306e\u30ec\u30a4\u30e4\u30fc\u3092\u5bfe\u8c61\u3068\u3057\u3001Chef\u306a\u3069\u306e\u30c4\u30fc\u30eb\u3092\u5229\u7528\u3057\u3066\u5b9f\u88c5\u3059\u308b\n### What?\n\u81ea\u52d5\u69cb\u7bc9\u3057\u305f\u74b0\u5883\u304c\u610f\u56f3\u3057\u305f\u901a\u308a\u306e\u8a2d\u5b9a\u306b\u306a\u3063\u3066\u3044\u308b\u306e\u304b\u3001\u7e70\u308a\u8fd4\u3057\u78ba\u8a8d\u3057\u305f\u3044\n\n\n## \u4f5c\u696d\u74b0\u5883\n| software | version |\n|:--|:--|\n| Mac OS X | 10.8.5 |\n| zsh | 4.3.11 (i386-apple-darwin12.0) |\n| git | 1.8.4.3 |\n| Homebrew | 0.9.5 |\n| anyenv | - |\n| rbenv | 0.4.0-67-g3300587 |\n| ruby | 2.0.0-p247 |\n| bundler | 1.3.5 |\n\n#### -- \u88dc\u8db3 --\n* git \u306f Homebrew \u306b\u3088\u3063\u3066\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3055\u308c\u3066\u307e\u3059\n* rbenv \u306f anyenv \u306b\u3088\u3063\u3066\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3055\u308c\u3066\u307e\u3059\n* ruby \u306f rbenv \u306b\u3088\u3063\u3066\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3055\u308c\u3066\u307e\u3059\n\n## \u524d\u63d0\n\u57fa\u672c\u7684\u306b\u306f\u3001 [serverspec \u306e\u4e26\u5217\u51e6\u7406](http://mizzy.org/blog/2013/06/22/1/) \u3067 @gosukenator \u3055\u3093\u304c\u66f8\u304b\u308c\u3066\u3044\u308b\u3088\u3046\u306b parallel_tests \u3092\u4f7f\u3048\u3070\u826f\u3044\u3068\u601d\u3044\u307e\u3059\n\n\u305f\u3060\u3057\u3001\u81ea\u5206\u306e\u3088\u3046\u306b [serverspec \u3067\u30db\u30b9\u30c8\u56fa\u6709\u306e\u5c5e\u6027\u5024\u3092\u6271\u3046\u65b9\u6cd5](http://mizzy.org/blog/2013/05/12/2/) \u306e\u3088\u3046\u306b\u5404\u30db\u30b9\u30c8\u306e\u5c5e\u6027\u5024\u3092YAML\u3067\u53d6\u5f97\u3057\u3066Rake\u304b\u3089\u5b9f\u884c\u3059\u308b\u5834\u5408\u306b\u306f\u3001 parallel_tests \u3067\u306f\u4e0a\u624b\u304f\u884c\u304b\u306a\u304b\u3063\u305f\u306e\u3067\u3001\u305d\u308c\u3092\u8a66\u884c\u932f\u8aa4\u3057\u3066\u3067\u304d\u305f\u7d50\u679c\u304c\u3053\u306e\u30e1\u30e2\u306b\u306a\u308a\u307e\u3059\n\n\n## 1. \u30db\u30b9\u30c8\u3054\u3068\u306e\u5c5e\u6027\u5024\u3092\u5b9a\u7fa9\u3059\u308b\n\n```conf/attributes.yml\nhost1:\n  :service:\n    - 'os'\n    - 'user'\n    - 'ntp'\n    - 'ssh'\n    - 'apache22'\n  :os_base_type:            'FreeBSD'\n  :os_base_version:         'xxx.xxx-RELEASE-xxx'\n  :os_base_architecture:    'amd64'\nhost2:\n  :service:\n    - 'os'\n    - 'user'\n    - 'ntp'\n    - 'ssh'\n    - 'postgresql'\n  :os_base_type:            'FreeBSD'\n  :os_base_version:         'xxx.xxx-RELEASE-xxx'\n  :os_base_architecture:    'amd64'\nhost3:\n  :service:\n\u4ee5\u4e0b\u7565\n```\n\n\n## 2. Rake\u30bf\u30b9\u30af\u3092\u5b9a\u7fa9\u3059\u308b\n\n```Rakefile\n#  encoding: utf-8\nATTRIBUTES_FILE = 'conf/attributes.yml'\nRSPEC_OPTIONS = '-c -fs'\n\nPROCESSES_NUMBER = 3\nTHREAD_NUMBER = 12\n\nrequire 'rake'\nrequire 'rspec/core/rake_task'\nrequire 'yaml'\nrequire 'parallel'\n\n#  Rake task\n#  rake all\ndesc \"Parallel Runs Targets => registered all-hosts\"\ntask :all => 'serverspec:parallel_all_hosts'\n\n#  rake host\\[hostname\\]\ndesc \"Parallel Runs Targets => registered host all-services\"\ntask :host, \"hostname\"\ntask :host do |x, args| Rake::Task['serverspec:parallel_all_services'].invoke(args.hostname) end\n\n#  rake parallel\n#desc \"Serial Runs Targets => registered all-hosts\"\ntask :serial_all => 'serverspec:all_hosts'\n\n#  Load 'host list & host service list' data\nattributes = YAML.load_file(ATTRIBUTES_FILE)\n\nnamespace :serverspec do\n  task :all_hosts => attributes.keys.map {|host| 'serverspec:' + host.split('.')[0] }\n    attributes.keys.each do |host|\n      if File.exist?(\"spec/#{host}/\") then\n        desc \"Serial Runs Targets   => #{host}\"\n        RSpec::Core::RakeTask.new(host.split('.')[0].to_sym) do |t|\n          ENV['TARGET_HOST'] = host\n          t.rspec_opts = RSPEC_OPTIONS\n          t.pattern = \"spec/#{host}/{\" + attributes[host][:service].join(',') + '}/*_spec.rb'\n        end\n      end\n    end\n  attributes.keys.map {|host|\n    attributes[host][:service].each do |service|\n      task :service => ('serverspec:' + host.split('.')[0] + '_' + service.split('.')[0]).to_sym\n      if File.exist?(\"spec/#{host}/#{service}/\") then\n        desc \"Serial Runs Targets   => #{host}: #{service}\"\n        RSpec::Core::RakeTask.new((host.split('.')[0] + '_' + service.split('.')[0]).to_sym) do |t|\n          ENV['TARGET_HOST'] = host\n          t.rspec_opts = RSPEC_OPTIONS\n          t.pattern = \"spec/#{host}/#{service}/*_spec.rb\"\n        end\n      end\n    end\n  }\n  task :parallel_all_hosts do\n    Parallel.each(attributes.keys, in_processes: PROCESSES_NUMBER) do |host|\n      Parallel.each(attributes[host][:service], in_threads: THREAD_NUMBER) do |service|\n        if File.exist?(\"spec/#{host}/#{service}/\") then\n          require 'open3'\n          command = 'rake serverspec:' + host.split('.')[0] + '_' + service.split('.')[0]\n          o, e, s = Open3.capture3(command)\n          puts o #  stdout\n          puts e #  stderr\n          # puts s #  status\n        end\n      end\n    end\n  end\n  task :parallel_all_services, \"hostname\"\n  task :parallel_all_services do |x, args|\n    host = args.hostname\n    Parallel.each(attributes[host][:service], in_threads: THREAD_NUMBER) do |service|\n      if File.exist?(\"spec/#{host}/#{service}/\") then\n        require 'open3'\n        command = 'rake serverspec:' + host.split('.')[0] + '_' + service.split('.')[0]\n        o, e, s = Open3.capture3(command)\n        puts o #  stdout\n        puts e #  stderr\n        # puts s #  status\n      end\n    end\n  end\nend\n\n```\n\n#### -- \u8ab2\u984c --\n* \u4ed6\u306e\u4eba\u306e\u30b3\u30fc\u30c9\u3092\u53c2\u8003\u306b\u3001\u521d\u3081\u3066\u66f8\u3044\u305f\u306e\u3067\u7d30\u304b\u3044\u3053\u3068\u306f\u826f\u304f\u308f\u304b\u3063\u3066\u306a\u3044\uff57\n* \u540c\u3058\u3053\u3068\u3092\u7e70\u308a\u8fd4\u3057\u66f8\u3044\u3066\u3044\u308b\u306e\u3067\u3001\u76f4\u3057\u65b9\u306f\u77e5\u3089\u306a\u3044\u3051\u3069\u30b9\u30c3\u30ad\u30ea\u3059\u308b\u3088\u3046\u306b\u4fee\u6b63\u3057\u305f\u3044\n* parallel \u3067\u4e26\u5217\u51e6\u7406\u3059\u308b\u305f\u3081\u306e\u5024\u306f\u3001\u5916\u90e8\u304b\u3089\u5f15\u6570\u3067\u4e0a\u66f8\u304d\u6307\u5b9a\u304c\u3067\u304d\u308b\u3088\u3046\u306b\u3057\u305f\u3044\n\n\u3068\u304b\u8ab2\u984c\u304c\u8272\u3005\u3068\u3042\u308b\u30a4\u30f3\u30d5\u30e9\u30a8\u30f3\u30b8\u30cb\u30a2\u306e\u66f8\u3044\u305f\u3072\u3069\u3044\u30b3\u30fc\u30c9\u3067\u3059\u304c\u3001\u81ea\u5206\u304c\u3084\u308a\u305f\u304b\u3063\u305f\u76ee\u7684\u306f\u9054\u6210\u3067\u304d\u305f\u306e\u3067\u4eca\u306e\u3068\u3053\u308d\u306f\u3053\u308c\u3067\u8a31\u5bb9\u3057\u3066\u307e\u3059\n\n\n\u3068\u308a\u3042\u3048\u305a\u3001\u3053\u306e\u72b6\u614b\u3067\n\nrake -T \u3092\u5b9f\u884c\u3059\u308b\u3068\n\n```\nrake all                          # Parallel Runs Targets => registered all-hosts\nrake host[hostname]               # Parallel Runs Targets => registered host all-services\nrake serverspec:host1             # Serial Runs Targets   => host1\nrake serverspec:host1_apache22    # Serial Runs Targets   => host1: apache22\nrake serverspec:host1_ntp         # Serial Runs Targets   => host1: ntp\nrake serverspec:host1_os          # Serial Runs Targets   => host1: os\nrake serverspec:host1_ssh         # Serial Runs Targets   => host1: ssh\nrake serverspec:host1_user        # Serial Runs Targets   => host1: user\nrake serverspec:host2             # Serial Runs Targets   => host2\nrake serverspec:host2_ntp         # Serial Runs Targets   => host2: ntp\nrake serverspec:host2_os          # Serial Runs Targets   => host2: os\nrake serverspec:host2_postgresql  # Serial Runs Targets   => host2: postgresql\nrake serverspec:host2_ssh         # Serial Runs Targets   => host2: ssh\nrake serverspec:host2_user        # Serial Runs Targets   => host2: user\nrake serverspec:host3             # Serial Runs Targets   => host3\n\u4ee5\u4e0b\u7565\n```\n\n\u30fb\u5168\u30db\u30b9\u30c8\u3092\u5bfe\u8c61\u306b\u5b9f\u884c\n\u30fb\u6307\u5b9a\u30db\u30b9\u30c8\u3092\u5bfe\u8c61\u306b\u5b9f\u884c\n\u30fb\u6307\u5b9a\u30db\u30b9\u30c8\u306e\u6307\u5b9a\u30b5\u30fc\u30d3\u30b9\u3092\u5bfe\u8c61\u306b\u5b9f\u884c\n\n\u3068\u5404\u7a2e\u30bf\u30b9\u30af\u304c\u7528\u610f\u3055\u308c\u3066\u3044\u308b\u72b6\u614b\u306b\u3067\u304d\u307e\u3059\n\n\n## 3. \u5168\u30db\u30b9\u30c8\u3092\u5bfe\u8c61\u306b\u3057\u305f\u30c6\u30b9\u30c8\u3092\u5b9f\u884c\u3057\u305f\u5834\u5408\n\nRakefile \u306e\n\n```\ntask :all_hosts => attributes.keys.map {|host| 'serverspec:' + host.split('.')[0] }\n```\n\n\u306e\u3068\u3053\u308d\u3067\u3001\u5b9f\u969b\u306b\u884c\u308f\u308c\u3066\u3044\u308b\u51e6\u7406\u306f\n\n```\ntask :all_hosts => [serverspec:host1,serverspec:host2,serverspec:host3]\n```\n\n\u4e0a\u8a18\u306e\u3088\u3046\u306b\u4e8b\u524d\u30bf\u30b9\u30af\u3092\u5b9f\u884c\u3059\u308b\u30bf\u30b9\u30af\u3068\u3057\u3066\u5b9a\u7fa9\u3055\u308c\u3066\u3044\u307e\u3059\n\n\n\u3042\u3068\u306f\u3001\u4e26\u5217\u51e6\u7406\u3092\u5b9f\u884c\u3059\u308b\u305f\u3081\u306e\u30bf\u30b9\u30af\u3092\u4f5c\u6210\u3057\u3066\u3001\n\n```\ntask :parallel_all_hosts do\n```\n\nparallel \u3067\u5404\u30db\u30b9\u30c8\u3092 in_processes \u3067\u4e26\u5217\u5b9f\u884c\u3057\u3001\n\n```\nParallel.each(attributes.keys, in_processes: PROCESSES_NUMBER) do |host|\n```\n\n\u3055\u3089\u306b\u3001\u305d\u308c\u305e\u308c\u306e\u30db\u30b9\u30c8\u5185\u3067\u5b9a\u7fa9\u3055\u308c\u3066\u3044\u308b\u30b5\u30fc\u30d3\u30b9\u3092 in_threads \u3067\u4e26\u5217\u51e6\u7406\u3057\u3066\u3044\u307e\u3059\n\n```\nParallel.each(attributes[host][:service], in_threads: THREAD_NUMBER) do |service|\n```\n\n\n## 4. rake\u30bf\u30b9\u30af\u5b9f\u884c\u6642\u306b\u5185\u90e8\u51e6\u7406\u3057\u3066\u3044\u308b\u3053\u3068\n\n\u5b9f\u969b\u306b\u5185\u90e8\u3067\u3084\u3063\u3066\u308b\u51e6\u7406\u81ea\u4f53\u306f\u3001\n\n* \u4e8b\u524d\u30bf\u30b9\u30af\u3092\u5b9a\u7fa9\u3057\u305f\u3001\u5168\u30db\u30b9\u30c8\u5b9f\u884c\u7528\u306e\u30bf\u30b9\u30af\u3092\u5b9a\u7fa9\u3059\u308b\n * \u4e0a\u8a18\u30bf\u30b9\u30af\u306e\u51e6\u7406\u904e\u7a0b\u3067\u3001\u4e8b\u524d\u30bf\u30b9\u30af\u3068\u5b9a\u7fa9\u3055\u308c\u3066\u3044\u305f\u500b\u5225\u30db\u30b9\u30c8\u5b9f\u884c\u7528\u306e\u30bf\u30b9\u30af\u304c\u5b9a\u7fa9\u3055\u308c\u308b\n\n* \u500b\u5225\u30db\u30b9\u30c8\u306e\u6307\u5b9a\u3057\u305f\u30b5\u30fc\u30d3\u30b9\u306e\u307f\u3092\u5b9f\u884c\u3067\u304d\u308b\u30bf\u30b9\u30af\u3092\u5b9a\u7fa9\u3057\u3066\u3044\u308b\n\n* \u5168\u30db\u30b9\u30c8\u3092\u5bfe\u8c61\u306b\u4e26\u5217\u5b9f\u884c\u3059\u308b\u30bf\u30b9\u30af\u3092\u5b9a\u7fa9\n * \u4e0a\u8a18\u30bf\u30b9\u30af\u304b\u3089\u3001 rake \u30b3\u30de\u30f3\u30c9\u304c\u4e26\u5217\u3067\u5b9f\u884c\u3055\u308c\u308b\n * \u305d\u306e\u969b\u306b\u3001\u5b9f\u884c\u3057\u305f\u30c6\u30b9\u30c8\u30b3\u30fc\u30c9\u306e\u7d50\u679c\u8868\u793a\u304c\u6df7\u3056\u3089\u306a\u3044\u3088\u3046\u306b\u3001 open3 \u3092\u5229\u7528\u3057\u3066\u6a19\u6e96\u51fa\u529b\u3068\u30a8\u30e9\u30fc\u51fa\u529b\u3092\u5404 rake \u30b3\u30de\u30f3\u30c9\u5358\u4f4d\u3067\u753b\u9762\u51fa\u529b\u3059\u308b\u3088\u3046\u306b\u3057\u3066\u3044\u307e\u3059\n\n\u304f\u3089\u3044\u306a\u306e\u3067\u3001YAML\u3092\u5229\u7528\u3057\u306a\u3044\u5834\u5408\u306f\u3001\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306e\u30ea\u30b9\u30c8\u304b\u3089 map \u3092\u4f5c\u6210\u3057\u3066\u4e26\u5217\u51e6\u7406\u3059\u308b\u3068\u304b\u3084\u308c\u3070\u826f\u3044\u306e\u3067\u306f\u306a\u3044\u304b\u3068\u601d\u3044\u307e\u3059", "tags": ["serverspec"]}