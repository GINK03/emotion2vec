{"tags": ["AWS", "lambda", "serverless", "stepfunctions", "Node.js"], "context": "\n\n\u306f\u3058\u3081\u306b\n\n\nServerless Advent Calendar 2016\u306e23\u65e5\u76ee\u3067\u3059\u3002\n\u4e3b\u306bAWS Lambda\u3092\u5229\u7528\u3057\u305f\u30b5\u30fc\u30d0\u30fc\u30ec\u30b9\u306b\u307e\u3064\u308f\u308b\u8a18\u4e8b\u3092\u66f8\u3044\u3066\u3044\u307e\u3059\u3002\n\u672c\u8a18\u4e8b\u3067\u306f\u3001EC2\u306e\u30b9\u30b1\u30b8\u30e5\u30fc\u30eb\u8d77\u52d5\u505c\u6b62\u3092Lambda\u3067\u5b9f\u73fe\u3059\u308b\u65b9\u6cd5\u3092\u8a18\u8f09\u3057\u305f\u3044\u3068\u601d\u3044\u307e\u3059\u3002\n\n\n\u8981\u4ef6\n\u7121\u99c4\u306a\u30b3\u30b9\u30c8\u3092\u7701\u304f\u305f\u3081\u306b\u3001\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u81ea\u52d5\u8d77\u52d5\u505c\u6b62\u3092\u884c\u3044\u305f\u3044\n\u5177\u4f53\u7684\u306a\u8981\u4ef6\u306f\u4ee5\u4e0b\u306e\u901a\u308a\n\n\u30b9\u30c6\u30fc\u30b8\u74b0\u5883\u306a\u3069\u3001\u65e5\u4e2d\u3060\u3051\u8d77\u52d5\u3057\u3066\u304a\u3051\u3070\u3044\u3044\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306f\u81ea\u52d5\u7684\u306b\u8d77\u52d5\u53ca\u3073\u505c\u6b62\u3055\u305b\u305f\u3044\n\u571f\u65e5\u306f\u8d77\u52d5\u3057\u306a\u3044\u306a\u3069\u306e\u8a2d\u5b9a\u3082\u3067\u304d\u305f\u3089\u5b09\u3057\u3044\n\u4e0a\u8a18\u3092\u305d\u308c\u305e\u308c\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306b\u5bfe\u3057\u3066\u67d4\u8edf\u306b\u9069\u5fdc\u3057\u305f\u3044\n\n\n\u89e3\u6c7a\u7b56\n\u5404\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3054\u3068\u306b\u67d4\u8edf\u306b\u8a2d\u5b9a\u3057\u305f\u3044\u3068\u306e\u3053\u3068\u3060\u3063\u305f\u306e\u3067\u3001\u4eca\u56de\u306f\u5404\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u30bf\u30b0\u3067\n\u5236\u5fa1\u3057\u3088\u3046\u3068\u8003\u3048\u307e\u3057\u305f\u3002\n\u5177\u4f53\u7684\u306b\u306f\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u5177\u5408\u3067\u3059\u3002\n\n\n\nTagKey\nTagValue\n\u5099\u8003\n\n\n\n\nStart\n10\n10\u6642\u306b\u8d77\u52d5\n\n\nStop\n22\n22\u6642\u306b\u505c\u6b62\n\n\nOperation\nMon-Fri\n\u6708\u66dc\u65e5\u304b\u3089\u91d1\u66dc\u65e5\u306b\u8d77\u52d5\n\n\n\n\u5404\u30bf\u30b0\u304c\u306a\u3044\u5834\u5408\u3084\u3001\u30bf\u30b0\u306eValue\u304c\u8a2d\u5b9a\u3055\u308c\u3066\u3044\u306a\u3044\u5834\u5408\u306f\u3001\u7121\u8996\u3055\u308c\u308b\u3088\u3046\u306b\u3057\u307e\u3059\u3002\n\n\u69cb\u6210\n\u4eca\u5e74\u3001AWS\u304b\u3089\u300cAWS Step Function\u300d\u3068\u3044\u3046\u30b5\u30fc\u30d3\u30b9\u304c\u30ea\u30ea\u30fc\u30b9\u3055\u308c\u307e\u3057\u305f\u3002\n\u3053\u308c\u307e\u3067\u306fLambda\u306e\u51e6\u7406\u3092\u30b7\u30fc\u30b1\u30f3\u30b7\u30e3\u30eb\u306b\u884c\u3044\u305f\u3044\u5834\u5408\u306f\u3001Lambda\u304b\u3089\u5225\u306eLambda\u3092\n\u547c\u3073\u51fa\u3057\u305f\u308a\u3001SNS\u3067\u7e4b\u3052\u305f\u308a\u3057\u306a\u3051\u308c\u3070\u306a\u308a\u307e\u305b\u3093\u3067\u3057\u305f\u304c\u3001\u3053\u306e\u30b5\u30fc\u30d3\u30b9\u3092\u5229\u7528\u3059\u308b\u3068\n\u8907\u6570\u306eLambda\u3092Step\u5b9f\u884c\u3067\u304d\u308b\u3088\u3046\u3067\u3059\u3002\nStep Function\n\u3088\u3063\u3066\u3001\u4eca\u56de\u306f\u3053\u308c\u3092\u5229\u7528\u3057\u3066\u3084\u3063\u3066\u307f\u3088\u3046\u3068\u601d\u3044\u307e\u3059\u3002\n\u4eca\u56de\u8003\u3048\u305f\u69cb\u6210\u306f\u4ee5\u4e0b\u306e\u901a\u308a\u3067\u3059\u3002\n\n\n\u307e\u305aCloudWatch Events\u306b\u30661\u6642\u9593\u304a\u304d\u306bstate machine\u3092\u5b9f\u884c\u3059\u308bLambda\u3092\u30ad\u30c3\u30af\nstate machine\u304c\u5b9f\u884c\u3055\u308c\u308b\nEC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u30bf\u30b0\u3092\u30b9\u30ad\u30e3\u30f3\u3057\u3001\u5bfe\u8c61\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u30ea\u30b9\u30c8\u5316\u3059\u308b\n\u5bfe\u8c61\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u30b9\u30bf\u30fc\u30c8\u53ca\u3073\u30b9\u30c8\u30c3\u30d7\u3059\u308b\n\n\u65e9\u901f\u4f5c\u6210\u3057\u3066\u3044\u304d\u307e\u3059\uff01\n\u4eca\u56de\u306f\u30d0\u30fc\u30b8\u30cb\u30a2\u5317\u90e8\u30ea\u30fc\u30b8\u30e7\u30f3\u306b\u3066\u5168\u3066\u4f5c\u6210\u3057\u307e\u3057\u305f\u3002\n\u203bStepFunction\u306f\u6771\u4eac\u30ea\u30fc\u30b8\u30e7\u30f3\u3067\u3082\u52d5\u304f\u306e\u3067\u6771\u4eac\u3067\u4f5c\u6210\u3057\u3066\u3082\u5927\u4e08\u592b\u3067\u3059\u3002\n\nLambda\u306e\u8a2d\u5b9a\n\u307e\u305a\u3001Lambda\u30d5\u30a1\u30f3\u30af\u30b7\u30e7\u30f3\u3092\u4f5c\u6210\u3057\u3066\u3044\u304d\u307e\u3059\n\u4eca\u56de\u4f5c\u6210\u3059\u308bLambda\u30d5\u30a1\u30f3\u30af\u30b7\u30e7\u30f3\u306f\u4ee5\u4e0b\u306e\uff14\u3064\u3067\u3059\n\n\n\n\u30d5\u30a1\u30f3\u30af\u30b7\u30e7\u30f3\u540d\n\u5f79\u5272\n\n\n\n\nstartSteps\nState Machine\u3092\u30ad\u30c3\u30af\u3059\u308b\n\n\ndescribeInstances\n\u5bfe\u8c61\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u30ea\u30b9\u30c8\u5316\u3059\u308b\n\n\nstartInstances\n\u5bfe\u8c61\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u30b9\u30bf\u30fc\u30c8\u3059\u308b\n\n\nstopInstances\n\u5bfe\u8c61\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u30b9\u30c8\u30c3\u30d7\u3059\u308b\n\n\n\n\nstartSteps\u306e\u4f5c\u6210\n\n\u8a2d\u5b9a\u5024\n\n\n\n\u9805\u76ee\n\u8a2d\u5b9a\u5024\n\n\n\n\nRuntime\nNode.js 4.3\n\n\nHandler\nindex.handler\n\n\nMemory\n128 MB\n\n\nTimeout\n10 sec\n\n\n\n\n\u6a29\u9650\n\u6a29\u9650\u306f\u4ee5\u4e0b\u3092\u4e0e\u3048\u307e\u3059\n{\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [\n        {\n            \"Sid\": \"Stmt1481002278000\",\n            \"Effect\": \"Allow\",\n            \"Action\": [\n                \"states:StartExecution\"\n            ],\n            \"Resource\": [\n                \"*\"\n            ]\n        }\n    ]\n}\n\n\n\u74b0\u5883\u5909\u6570\n\u74b0\u5883\u5909\u6570\u306b\u306f\u4ee5\u4e0b\u3092\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\n\n\n\u5909\u6570\u540d\n\u8a2d\u5b9a\u5024\n\u8aac\u660e\n\n\n\n\nSTATEMACHINE\nScheduledBoot\n\u5b9f\u884c\u3059\u308bState Machine\u540d\n\n\n\n\n\u30b3\u30fc\u30c9\n\u30b3\u30fc\u30c9\u306f\u4ee5\u4e0b\u306e\u901a\u308a\u3067\u3059\n'use strict';\n\nconst AWS = require('aws-sdk'),\n      stepfunctions = new AWS.StepFunctions();\n\nexports.handler = (event, context, callback) => {\n\n    const metaList  = context.invokedFunctionArn.split(':'),\n          params = {\n            stateMachineArn: 'arn:aws:states:' + metaList[3] + ':' + metaList[4] + ':stateMachine:' + process.env.STATEMACHINE\n          };\n\n    stepfunctions.startExecution(params, function(err, data) {\n        if (err) {\n            console.log(err, err.stack);\n        } else {\n            console.log('success');\n        }\n    });\n};\n\n\ndescribeInstances\u306e\u4f5c\u6210\n\n\u8a2d\u5b9a\u5024\n\n\n\n\u9805\u76ee\n\u8a2d\u5b9a\u5024\n\n\n\n\nRuntime\nNode.js 4.3\n\n\nHandler\nindex.handler\n\n\nMemory\n128 MB\n\n\nTimeout\n1 min\n\n\n\n\n\u6a29\u9650\n\u6a29\u9650\u306f\u4ee5\u4e0b\u3092\u4e0e\u3048\u307e\u3059\n{\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [\n        {\n            \"Sid\": \"Stmt1481002174000\",\n            \"Effect\": \"Allow\",\n            \"Action\": [\n                \"ec2:DescribeInstances\"\n            ],\n            \"Resource\": [\n                \"*\"\n            ]\n        }\n    ]\n}\n\n\n\u74b0\u5883\u5909\u6570\n\u74b0\u5883\u5909\u6570\u306b\u306f\u4ee5\u4e0b\u3092\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\n\n\n\u5909\u6570\u540d\n\u8a2d\u5b9a\u5024\n\u8aac\u660e\n\n\n\n\nSTARTTAGKEY\nStart\n\u81ea\u52d5\u8d77\u52d5\u7528\u30bf\u30b0\u306eKey\u540d\n\n\nSTOPTAGKEY\nStop\n\u81ea\u52d5\u505c\u6b62\u7528\u30bf\u30b0\u306eKey\u540d\n\n\nOPERATIONDAYTAGKEY\nOperation\n\u66dc\u65e5\u6307\u5b9a\u7528\u30bf\u30b0\u306eKey\u540d\n\n\n\n\n\u30b3\u30fc\u30c9\n\u30b3\u30fc\u30c9\u306f\u4ee5\u4e0b\u306e\u901a\u308a\u3067\u3059\u3002\n'use strict';\n\nconst AWS = require('aws-sdk'),\n      ec2 = new AWS.EC2();\n\nexports.handler = (event, context, callback) => {\n\n    const generator = (function* () {\n        try {\n            const now = new Date();\n            // UTC\u2192JST\n            now.setHours(now.getHours()+9);\n            const currentHours       = now.getHours().toString(),\n                  currentDay         = now.getDay(),\n                  weekDayList        = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'],\n                  startInstanceIds   = [],\n                  stopInstanceIds    = [],\n                  STARTTAGKEY        = process.env.STARTTAGKEY,\n                  STOPTAGKEY         = process.env.STOPTAGKEY,\n                  OPERATIONDAYTAGKEY = process.env.OPERATIONDAYTAGKEY;\n            let   startInstancesList = [],\n                  stopInstancesList  = [];\n\n            // \u73fe\u5728\u6642\u523b\u306eStart\u30bf\u30b0\u304c\u4ed8\u3044\u3066\u3044\u308b\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u30ea\u30b9\u30c8\u3092\u53d6\u5f97\n            startInstancesList = yield listTaggedInstances(currentHours, STARTTAGKEY, generator);\n\n            // \u73fe\u5728\u6642\u523b\u306eStop\u30bf\u30b0\u304c\u4ed8\u3044\u3066\u3044\u308b\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u30ea\u30b9\u30c8\u3092\u53d6\u5f97\n            stopInstancesList  = yield listTaggedInstances(currentHours,  STOPTAGKEY, generator);\n\n            // \u30b9\u30bf\u30fc\u30c8\u5bfe\u8c61\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u30ea\u30b9\u30c8\u4f5c\u6210\n            if(startInstancesList.length) {\n                for(let i = 0, len = startInstancesList.length; i < len; i++) {\n                    // \u66dc\u65e5\u306e\u6307\u5b9a\u304c\u3042\u308b\u304b\u78ba\u8a8d\n                    let dayTagPoint = arrayObjectIndexOf(startInstancesList[i].Tags, OPERATIONDAYTAGKEY, 'Key');\n\n                    if(dayTagPoint < 0) {\n                        // \u66dc\u65e5\u306e\u6307\u5b9a\u304c\u306a\u3044\u5834\u5408\u306f\u3001\u305d\u306e\u307e\u307e\u30b9\u30bf\u30fc\u30c8\u5bfe\u8c61\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u30ea\u30b9\u30c8\u306b\u8ffd\u52a0\n                        startInstanceIds.push(startInstancesList[i].InstanceId);\n                    } else {\n                        // \u66dc\u65e5\u306e\u6307\u5b9a\u304c\u3042\u308b\u5834\u5408\u3001\u73fe\u5728\u66dc\u65e5\u304c\u6307\u5b9a\u671f\u9593\u5185\u3067\u3042\u308c\u3070\u3001\u30b9\u30bf\u30fc\u30c8\u5bfe\u8c61\u30ea\u30b9\u30c8\u306b\u8ffd\u52a0\n                        let runday   = startInstancesList[i].Tags[dayTagPoint].Value,\n                            startDay = runday.split('-')[0],\n                            endDay   = runday.split('-')[1];\n\n                        if(weekDayList.indexOf(startDay) <= currentDay &&\n                           currentDay                    <= weekDayList.indexOf(endDay) ) {\n                               startInstanceIds.push(startInstancesList[i].InstanceId);\n                           }\n                    }\n                }\n            }\n\n            // \u30b9\u30c8\u30c3\u30d7\u5bfe\u8c61\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u30ea\u30b9\u30c8\u4f5c\u6210\n            if(stopInstancesList.length) {\n                // \u305d\u306e\u307e\u307e\u30b9\u30c8\u30c3\u30d7\u5bfe\u8c61\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u30ea\u30b9\u30c8\u306b\u8ffd\u52a0\n                for(let i = 0; i < stopInstancesList.length; i++) {\n                    stopInstanceIds.push(stopInstancesList[i].InstanceId);\n                }\n            }\n\n            const targetMap = {\n                \"StartInstances\" : {\n                    \"count\"            : startInstanceIds.length,\n                    \"StartInstanceIds\" : startInstanceIds\n                },\n                \"StopInstances\"  : {\n                    \"count\"            : stopInstanceIds.length,\n                    \"StopInstanceIds\"  : stopInstanceIds\n                }\n            };\n\n            callback(null, targetMap);\n\n\n        } catch (e) {\n            callback(e);\n        }\n    })();\n\n    /* \u51e6\u7406\u958b\u59cb */\n    generator.next();\n\n};\n\n// \u4efb\u610f\u306e\u5024\u3067\u30bf\u30b0\u4ed8\u3051\u3055\u308c\u3066\u3044\u308b\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u30ea\u30b9\u30c8\u3092\u4f5c\u6210\nconst listTaggedInstances = (value, tag, generator) => {\n    const params = {\n        Filters: [\n            {\n                Name : 'tag:' + tag,\n                Values: [\n                    value\n                ]\n            }\n        ]\n    };\n\n    ec2.describeInstances(params, function(err, data) {\n        if(err) {\n            console.log(err, err.stack);\n            generator.throw(new Error(err, err.stack));\n        } else {\n            if(data.Reservations[0]) {\n                generator.next(data.Reservations[0].Instances);\n            } else {\n                generator.next(data.Reservations);\n            }\n\n        }\n    });\n};\n\n// \u9023\u60f3\u914d\u5217\u3092\u8981\u7d20\u3068\u3059\u308b\u914d\u5217\u304b\u3089\u4efb\u610f\u306e\u5024\u306e\u4f4d\u7f6e\u3092\u8fd4\u5374\nconst arrayObjectIndexOf = (array, searchTerm, property) => {\n    for(let i = 0, len = array.length; i < len; i++) {\n        if(array[i][property] === searchTerm) {\n            return i;\n        }\n    }\n    return -1;\n};\n\n\nstartInstances\u306e\u4f5c\u6210\n\n\u8a2d\u5b9a\u5024\n\n\n\n\u9805\u76ee\n\u8a2d\u5b9a\u5024\n\n\n\n\nRuntime\nNode.js 4.3\n\n\nHandler\nindex.handler\n\n\nMemory\n128 MB\n\n\nTimeout\n1 min\n\n\n\n\n\u6a29\u9650\n\u6a29\u9650\u306f\u4ee5\u4e0b\u3092\u4e0e\u3048\u307e\u3059\n{\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [\n        {\n            \"Sid\": \"Stmt1481002211000\",\n            \"Effect\": \"Allow\",\n            \"Action\": [\n                \"ec2:StartInstances\"\n            ],\n            \"Resource\": [\n                \"*\"\n            ]\n        }\n    ]\n}\n\n\n\u74b0\u5883\u5909\u6570\n\u306a\u3057\n\n\u30b3\u30fc\u30c9\n\u30b3\u30fc\u30c9\u306f\u4ee5\u4e0b\u306e\u901a\u308a\u3067\u3059\u3002\n'use strict';\n\nconst AWS = require('aws-sdk'),\n      ec2 = new AWS.EC2();\n\nexports.handler = (event, context, callback) => {\n\n    const params = {\n        InstanceIds: event.StartInstanceIds\n    };\n\n    ec2.startInstances(params, function(err, data) {\n        if (err) {\n            callback(err);\n        } else {\n            callback(null, 'success');\n        }\n    });\n};\n\n\nstopInstances\u306e\u4f5c\u6210\n\n\u8a2d\u5b9a\u5024\n\n\n\n\u9805\u76ee\n\u8a2d\u5b9a\u5024\n\n\n\n\nRuntime\nNode.js 4.3\n\n\nHandler\nindex.handler\n\n\nMemory\n128 MB\n\n\nTimeout\n1 min\n\n\n\n\n\u6a29\u9650\n\u6a29\u9650\u306f\u4ee5\u4e0b\u3092\u4e0e\u3048\u307e\u3059\n{\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [\n        {\n            \"Sid\": \"Stmt1481002240000\",\n            \"Effect\": \"Allow\",\n            \"Action\": [\n                \"ec2:StopInstances\"\n            ],\n            \"Resource\": [\n                \"*\"\n            ]\n        }\n    ]\n}\n\n\n\u74b0\u5883\u5909\u6570\n\u306a\u3057\n\n\u30b3\u30fc\u30c9\n\u30b3\u30fc\u30c9\u306f\u4ee5\u4e0b\u306e\u901a\u308a\u3067\u3059\u3002\n'use strict';\n\nconst AWS = require('aws-sdk'),\n      ec2 = new AWS.EC2();\n\nexports.handler = (event, context, callback) => {\n\n    const params = {\n        InstanceIds: event.StopInstanceIds\n    };\n\n    ec2.stopInstances(params, function(err, data) {\n        if (err) {\n            callback(err);\n        } else {\n            callback(null, 'success');\n        }\n    });\n};\n\n\nStep Function\u306e\u8a2d\u5b9a\nState Machines\u306e\u4f5c\u6210\u3092\u884c\u3044\u307e\u3059\u3002\n[Create a State Machine]\u30dc\u30bf\u30f3\u3092\u30af\u30ea\u30c3\u30af\u3057\u3066\u65b0\u3057\u304f\u4f5c\u6210\u3057\u307e\u3059\u3002\n\u4ee5\u4e0b\u753b\u9762\u3067\u5024\u3092\u5165\u529b\u3057\u307e\u3059\u3002\n\u203bCode\u306e\u5404Resource\u306f\u9069\u5b9c\u4fee\u6b63\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n\n\n\n\u9805\u76ee\n\u8a2d\u5b9a\u5024\n\n\n\n\nName\nScheduledBoot\n\n\nCode\n\u4ee5\u4e0b\u3092\u5165\u529b\n\n\n\n{\n  \"Comment\": \"Scheduled Boot Instances\",\n  \"StartAt\": \"1 DescribeInstances\",\n  \"States\": {\n    \"1 DescribeInstances\": {\n      \"Type\": \"Task\",\n      \"Resource\": \"arn:aws:lambda:us-east-1:000000000000:function:describeInstances\",\n      \"Next\": \"2 Scheduled Boot\"\n    },\n\n    \"2 Scheduled Boot\": {\n      \"Type\": \"Parallel\",\n      \"End\": true,\n      \"Branches\": [\n          {\n              \"StartAt\": \"2_1_1 Starting Choices\",\n              \"States\": {\n                  \"2_1_1 Starting Choices\": {\n                      \"Type\": \"Choice\",\n                      \"Choices\": [\n                          {\n                              \"Not\": {\n                                  \"Variable\": \"$.StartInstances.count\",\n                                  \"NumericEquals\": 0\n                              },\n                              \"Next\": \"2_1_2 Start Instances\"\n                          }\n                      ],\n                      \"Default\": \"2_1_9 End of Startings\"\n                  },\n                  \"2_1_2 Start Instances\": {\n                      \"Type\": \"Task\",\n                      \"InputPath\": \"$.StartInstances\",\n                      \"Resource\": \"arn:aws:lambda:us-east-1:000000000000:function:startInstances\",\n                      \"Next\": \"2_1_9 End of Startings\"\n                  },\n                  \"2_1_9 End of Startings\": {\n                      \"Type\": \"Pass\",\n                      \"End\": true\n                  }\n              }\n          },\n          {\n              \"StartAt\": \"2_2_1 Stopping Choices\",\n              \"States\": {\n                  \"2_2_1 Stopping Choices\": {\n                      \"Type\": \"Choice\",\n                      \"Choices\": [\n                          {\n                              \"Not\": {\n                                  \"Variable\": \"$.StopInstances.count\",\n                                  \"NumericEquals\": 0\n                              },\n                              \"Next\": \"2_2_2 Stop Instances\"\n                          }\n                      ],\n                      \"Default\": \"2_2_9 End of Stoppings\"\n                  },\n                  \"2_2_2 Stop Instances\": {\n                      \"Type\": \"Task\",\n                      \"InputPath\": \"$.StopInstances\",\n                      \"Resource\": \"arn:aws:lambda:us-east-1:000000000000:function:stopInstances\",\n                      \"Next\": \"2_2_9 End of Stoppings\"\n                  },\n                  \"2_2_9 End of Stoppings\": {\n                      \"Type\": \"Pass\",\n                      \"End\": true\n                  }\n              }\n          }\n      ]\n    }\n  }\n}\n\n\n\u3053\u3053\u3067\u3001Preview\u6a2a\u306e\u30af\u30eb\u30af\u30eb\u3092\u30af\u30ea\u30c3\u30af\u3059\u308b\u3068\n\n\u3053\u306e\u3088\u3046\u306a\u30b0\u30e9\u30d5\u304c\u73fe\u308c\u308c\u3070OK\u3067\u3059\u3002\n\u305d\u306e\u307e\u307e[Create State Machine]\u3092\u30af\u30ea\u30c3\u30af\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\u4ee5\u4e0b\u753b\u9762\u3067\u306f\u898f\u5b9a\u306eRole\u3092\u9078\u629e\u3057\u3001OK\u3092\u30af\u30ea\u30c3\u30af\u3057\u307e\u3059\u3002\n\n\u3053\u308c\u3067\u4f5c\u6210\u306f\u5b8c\u4e86\u3067\u3059\u3002\n\n\nCloudWatch Events\u306e\u8a2d\u5b9a\n\n\u30eb\u30fc\u30eb\u306e\u4f5c\u6210\nCloudWatch\u3067\u30eb\u30fc\u30eb\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n[\u30eb\u30fc\u30eb\u306e\u4f5c\u6210]\u30dc\u30bf\u30f3\u3092\u30af\u30ea\u30c3\u30af\u3002\n\n\u6bce\u6642\u9593\u306e0\u5206\u3054\u3068\u306bState Machine\u3092\u5b9f\u884c\u3057\u305f\u3044\u306e\u3067\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\n\n\n\u9805\u76ee\n\u8a2d\u5b9a\u5024\n\n\n\n\n\u30a4\u30d9\u30f3\u30c8\n\u30b9\u30b1\u30b8\u30e5\u30fc\u30eb\n\n\nCron\u5f0f\n0 * * * ? *\n\n\n\u30bf\u30fc\u30b2\u30c3\u30c8\nstartSteps\n\n\n\n\n\u540d\u524d\u306f\u9069\u5f53\u306b\u6c7a\u3081\u3066\u3001\n\n\u8a2d\u5b9a\u5b8c\u4e86\u3067\u3059\uff01\n\n\n\u8a66\u3057\u3066\u307f\u308b\n\u3053\u308c\u3067\u6e96\u5099\u306f\u6574\u3063\u305f\u306e\u3067\u3001\u65e9\u901f\u8a66\u3057\u3066\u307f\u307e\u3059\u3002\n\n\u5bfe\u8c61\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3078\u306e\u30bf\u30b0\u4ed8\u3051\n\u30c6\u30b9\u30c8\u7528\u306b5\u53f0\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u4f5c\u6210\u3057\u307e\u3057\u305f\u3002\n(\u30af\u30e9\u30a6\u30c9\u3063\u3066\u4fbf\u5229\u3067\u3059\u306d\u30fc)\n\u30c6\u30b9\u30c8\u7528\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306b\u5bfe\u3057\u3066\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u30bf\u30b0\u4ed8\u3051\u3057\u307e\u3059\u3002\n\n\n\nName\nOperation\nStart\nStop\n\u671f\u5f85\u3059\u308b\u52d5\u304d\n\n\n\n\nstartstoptest01\nMon-Fri\n10\n\n\u6708\u66dc\u304b\u3089\u91d1\u66dc\u306e\u9593\u3001AM10\u6642\u306b\u8d77\u52d5\n\n\nstartstoptest02\n\n\n10\nAM10\u6642\u306b\u505c\u6b62\n\n\nstartstoptest03\nMon-Thu\n10\n\n\u6708\u66dc\u304b\u3089\u6728\u66dc\u306e\u9593\u3001AM10\u6642\u306b\u8d77\u52d5\n\n\nstartstoptest04\n\n10\n\nAM10\u6642\u306b\u8d77\u52d5\n\n\nstartstoptest05\nMon-Thu\n\n10\nAM10\u6642\u306b\u505c\u6b62\n\n\n\n\n\u73fe\u5728\u3001\u91d1\u66dc\u65e5\u3067\u73fe\u5728\u6642\u523b\u306fAM9:58\u3067\u3059\u3002\n\u3042\u3068\u30012\u5206\u3067\u5909\u5316\u304c\u73fe\u308c\u308b\u306f\u305a\u2026\nAM10:00\u306b\u306a\u308a\u307e\u3057\u305f\u3001\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u72b6\u614b\u306f\u3069\u3046\u3067\u3057\u3087\u3046\u3002\n\n\u304d\u3061\u3093\u3068\u5bfe\u8c61\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3060\u3051\u5909\u5316\u304c\u3042\u308a\u307e\u3057\u305f\uff01\n\u4eca\u65e5\u306f\u91d1\u66dc\u65e5\u306a\u306e\u3067\u3001startstoptest03\u306f\u53cd\u5fdc\u3057\u3066\u307e\u305b\u3093\u3002\n\u307e\u305f\u3001\u66dc\u65e5\u6307\u5b9a\u306f\u3042\u304f\u307e\u3067Start\u306b\u3057\u304b\u5f71\u97ff\u3057\u306a\u3044\u305f\u3081\u3001startstoptest05\u306f\u304d\u3061\u3093\u3068\u505c\u6b62\u3057\u3066\u3044\u307e\u3059\u3002\n\n\u666e\u6bb5\u306f\u30b9\u30c6\u30fc\u30b8\u74b0\u5883\u306b\u5bfe\u3057\u3066\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u611f\u3058\u3067\u6307\u5b9a\u3057\u3066\u904b\u7528\u3057\u3066\u3044\u307e\u3059\u3002\n\n\n\u6ce8\u610f\u4e8b\u9805\n\n\u66dc\u65e5\u306e\u6307\u5b9a\u306f['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat']\u3092\u7d44\u307f\u5408\u308f\u305b\u3066\u884c\u3044\u307e\u3059\u3002\n\u73fe\u5728\u3001\u66dc\u65e5\u306e\u6307\u5b9a\u3092Fri-Sun\u306e\u3088\u3046\u306b\u6307\u5b9a\u3059\u308b\u3068\u6b63\u5e38\u306b\u52d5\u304d\u307e\u305b\u3093\u3002Sun\u2192Mon\u2192\u2026\u2192Sat\u306e\u9806\u756a\u3067\u6307\u5b9a\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\nStart\u3068Stop\u306b\u540c\u3058\u6642\u9593\u3092\u5165\u308c\u308b\u3068\u6b63\u5e38\u306b\u52d5\u304b\u306a\u3044\u3068\u601d\u3044\u307e\u3059\u3002\n\u6642\u9593\u306e\u6307\u5b9a\u306f\u65e5\u672c\u6642\u9593\u306724H\u8868\u8a18\u3067\u3059\u3002\n\n\n\u7d42\u308f\u308a\u306b\n\u30a8\u30e9\u30fc\u51e6\u7406\u7b49\u307e\u3060\u6539\u826f\u306e\u4f59\u5730\u306f\u3042\u308a\u307e\u3059\u304c\u3001\u3053\u306e\u30ec\u30d9\u30eb\u3067\u3042\u308c\u3070\u6c17\u8efd\u306b\u5c0e\u5165\u3067\u304d\u308b\u306e\u3067\u3001\u7c21\u5358\u306b\u30b3\u30b9\u30c8\u524a\u6e1b\u3067\u304d\u308b\u306e\u3067\u306f\u306a\u3044\u3067\u3057\u3087\u3046\u304b\u3002\nStep Function\u306f\u4f7f\u3063\u3066\u307f\u305f\u3070\u304b\u308a\u3067\u3059\u304c\u3001\u305d\u308c\u305e\u308c\u306eLambda\u3092\u7c21\u5358\u306b\u8a18\u8ff0\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u308b\u306e\u3067\u3001\u3053\u308c\u304b\u3089\u3082\u3063\u3068\u6d3b\u7528\u306e\u5e45\u304c\u5e83\u304c\u308a\u305d\u3046\u3067\u3059\u3002\n# \u306f\u3058\u3081\u306b\n\n- [Serverless Advent Calendar 2016](http://qiita.com/advent-calendar/2016/serverless)\u306e23\u65e5\u76ee\u3067\u3059\u3002\n- \u4e3b\u306bAWS Lambda\u3092\u5229\u7528\u3057\u305f\u30b5\u30fc\u30d0\u30fc\u30ec\u30b9\u306b\u307e\u3064\u308f\u308b\u8a18\u4e8b\u3092\u66f8\u3044\u3066\u3044\u307e\u3059\u3002\n- \u672c\u8a18\u4e8b\u3067\u306f\u3001EC2\u306e\u30b9\u30b1\u30b8\u30e5\u30fc\u30eb\u8d77\u52d5\u505c\u6b62\u3092Lambda\u3067\u5b9f\u73fe\u3059\u308b\u65b9\u6cd5\u3092\u8a18\u8f09\u3057\u305f\u3044\u3068\u601d\u3044\u307e\u3059\u3002\n\n# \u8981\u4ef6\n\n\u7121\u99c4\u306a\u30b3\u30b9\u30c8\u3092\u7701\u304f\u305f\u3081\u306b\u3001\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u81ea\u52d5\u8d77\u52d5\u505c\u6b62\u3092\u884c\u3044\u305f\u3044\n\u5177\u4f53\u7684\u306a\u8981\u4ef6\u306f\u4ee5\u4e0b\u306e\u901a\u308a\n\n- \u30b9\u30c6\u30fc\u30b8\u74b0\u5883\u306a\u3069\u3001\u65e5\u4e2d\u3060\u3051\u8d77\u52d5\u3057\u3066\u304a\u3051\u3070\u3044\u3044\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306f\u81ea\u52d5\u7684\u306b\u8d77\u52d5\u53ca\u3073\u505c\u6b62\u3055\u305b\u305f\u3044\n- \u571f\u65e5\u306f\u8d77\u52d5\u3057\u306a\u3044\u306a\u3069\u306e\u8a2d\u5b9a\u3082\u3067\u304d\u305f\u3089\u5b09\u3057\u3044\n- \u4e0a\u8a18\u3092\u305d\u308c\u305e\u308c\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306b\u5bfe\u3057\u3066\u67d4\u8edf\u306b\u9069\u5fdc\u3057\u305f\u3044\n\n# \u89e3\u6c7a\u7b56\n\n\u5404\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3054\u3068\u306b\u67d4\u8edf\u306b\u8a2d\u5b9a\u3057\u305f\u3044\u3068\u306e\u3053\u3068\u3060\u3063\u305f\u306e\u3067\u3001\u4eca\u56de\u306f\u5404\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e**\u30bf\u30b0**\u3067\n\u5236\u5fa1\u3057\u3088\u3046\u3068\u8003\u3048\u307e\u3057\u305f\u3002\n\u5177\u4f53\u7684\u306b\u306f\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u5177\u5408\u3067\u3059\u3002\n\n|TagKey      |TagValue    |\u5099\u8003                |\n|------------|------------|--------------------|\n| Start      | 10         |10\u6642\u306b\u8d77\u52d5           |\n| Stop       | 22         |22\u6642\u306b\u505c\u6b62           |\n| Operation  | Mon-Fri    |\u6708\u66dc\u65e5\u304b\u3089\u91d1\u66dc\u65e5\u306b\u8d77\u52d5|\n\n\u5404\u30bf\u30b0\u304c\u306a\u3044\u5834\u5408\u3084\u3001\u30bf\u30b0\u306eValue\u304c\u8a2d\u5b9a\u3055\u308c\u3066\u3044\u306a\u3044\u5834\u5408\u306f\u3001\u7121\u8996\u3055\u308c\u308b\u3088\u3046\u306b\u3057\u307e\u3059\u3002\n\n# \u69cb\u6210\n\n\u4eca\u5e74\u3001AWS\u304b\u3089\u300cAWS Step Function\u300d\u3068\u3044\u3046\u30b5\u30fc\u30d3\u30b9\u304c\u30ea\u30ea\u30fc\u30b9\u3055\u308c\u307e\u3057\u305f\u3002\n\u3053\u308c\u307e\u3067\u306fLambda\u306e\u51e6\u7406\u3092\u30b7\u30fc\u30b1\u30f3\u30b7\u30e3\u30eb\u306b\u884c\u3044\u305f\u3044\u5834\u5408\u306f\u3001Lambda\u304b\u3089\u5225\u306eLambda\u3092\n\u547c\u3073\u51fa\u3057\u305f\u308a\u3001SNS\u3067\u7e4b\u3052\u305f\u308a\u3057\u306a\u3051\u308c\u3070\u306a\u308a\u307e\u305b\u3093\u3067\u3057\u305f\u304c\u3001\u3053\u306e\u30b5\u30fc\u30d3\u30b9\u3092\u5229\u7528\u3059\u308b\u3068\n\u8907\u6570\u306eLambda\u3092Step\u5b9f\u884c\u3067\u304d\u308b\u3088\u3046\u3067\u3059\u3002\n\n[Step Function](https://aws.amazon.com/jp/blogs/news/new-aws-step-functions-build-distributed-applications-using-visual-workflows/)\n\n\u3088\u3063\u3066\u3001\u4eca\u56de\u306f\u3053\u308c\u3092\u5229\u7528\u3057\u3066\u3084\u3063\u3066\u307f\u3088\u3046\u3068\u601d\u3044\u307e\u3059\u3002\n\n\u4eca\u56de\u8003\u3048\u305f\u69cb\u6210\u306f\u4ee5\u4e0b\u306e\u901a\u308a\u3067\u3059\u3002\n\n![\u81ea\u52d5\u8d77\u52d5\u505c\u6b62\u69cb\u6210\u56f3.png](https://qiita-image-store.s3.amazonaws.com/0/40136/2e010a46-a387-0fbf-4d8e-15135a48c6ef.png)\n\n1. \u307e\u305aCloudWatch Events\u306b\u30661\u6642\u9593\u304a\u304d\u306bstate machine\u3092\u5b9f\u884c\u3059\u308bLambda\u3092\u30ad\u30c3\u30af\n2. state machine\u304c\u5b9f\u884c\u3055\u308c\u308b\n3. EC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u30bf\u30b0\u3092\u30b9\u30ad\u30e3\u30f3\u3057\u3001\u5bfe\u8c61\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u30ea\u30b9\u30c8\u5316\u3059\u308b\n4. \u5bfe\u8c61\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u30b9\u30bf\u30fc\u30c8\u53ca\u3073\u30b9\u30c8\u30c3\u30d7\u3059\u308b\n\n\u65e9\u901f\u4f5c\u6210\u3057\u3066\u3044\u304d\u307e\u3059\uff01\n\u4eca\u56de\u306f\u30d0\u30fc\u30b8\u30cb\u30a2\u5317\u90e8\u30ea\u30fc\u30b8\u30e7\u30f3\u306b\u3066\u5168\u3066\u4f5c\u6210\u3057\u307e\u3057\u305f\u3002\n\u203bStepFunction\u306f\u6771\u4eac\u30ea\u30fc\u30b8\u30e7\u30f3\u3067\u3082\u52d5\u304f\u306e\u3067\u6771\u4eac\u3067\u4f5c\u6210\u3057\u3066\u3082\u5927\u4e08\u592b\u3067\u3059\u3002\n\n# Lambda\u306e\u8a2d\u5b9a\n\n\u307e\u305a\u3001Lambda\u30d5\u30a1\u30f3\u30af\u30b7\u30e7\u30f3\u3092\u4f5c\u6210\u3057\u3066\u3044\u304d\u307e\u3059\n\u4eca\u56de\u4f5c\u6210\u3059\u308bLambda\u30d5\u30a1\u30f3\u30af\u30b7\u30e7\u30f3\u306f\u4ee5\u4e0b\u306e\uff14\u3064\u3067\u3059\n\n|\u30d5\u30a1\u30f3\u30af\u30b7\u30e7\u30f3\u540d      |\u5f79\u5272                         |\n|---------------------|----------------------------|\n| startSteps          | State Machine\u3092\u30ad\u30c3\u30af\u3059\u308b   |\n| describeInstances   | \u5bfe\u8c61\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u30ea\u30b9\u30c8\u5316\u3059\u308b|\n| startInstances      | \u5bfe\u8c61\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u30b9\u30bf\u30fc\u30c8\u3059\u308b|\n| stopInstances       | \u5bfe\u8c61\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u30b9\u30c8\u30c3\u30d7\u3059\u308b|\n\n## startSteps\u306e\u4f5c\u6210\n\n### \u8a2d\u5b9a\u5024\n\n|\u9805\u76ee                 |\u8a2d\u5b9a\u5024                       |\n|---------------------|----------------------------|\n| Runtime             | Node.js 4.3                |\n| Handler             | index.handler              |\n| Memory              | 128 MB                     |\n| Timeout             | 10 sec                     |\n\n### \u6a29\u9650\n\n\u6a29\u9650\u306f\u4ee5\u4e0b\u3092\u4e0e\u3048\u307e\u3059\n\n```json\n{\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [\n        {\n            \"Sid\": \"Stmt1481002278000\",\n            \"Effect\": \"Allow\",\n            \"Action\": [\n                \"states:StartExecution\"\n            ],\n            \"Resource\": [\n                \"*\"\n            ]\n        }\n    ]\n}\n```\n\n### \u74b0\u5883\u5909\u6570\n\n\u74b0\u5883\u5909\u6570\u306b\u306f\u4ee5\u4e0b\u3092\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\n|\u5909\u6570\u540d               |\u8a2d\u5b9a\u5024                       |\u8aac\u660e                        |\n|---------------------|----------------------------|----------------------------|\n| STATEMACHINE        | ScheduledBoot              | \u5b9f\u884c\u3059\u308bState Machine\u540d     |\n\n### \u30b3\u30fc\u30c9\n\n\u30b3\u30fc\u30c9\u306f\u4ee5\u4e0b\u306e\u901a\u308a\u3067\u3059\n\n```js\n'use strict';\n\nconst AWS = require('aws-sdk'),\n      stepfunctions = new AWS.StepFunctions();\n\nexports.handler = (event, context, callback) => {\n\n    const metaList  = context.invokedFunctionArn.split(':'),\n          params = {\n            stateMachineArn: 'arn:aws:states:' + metaList[3] + ':' + metaList[4] + ':stateMachine:' + process.env.STATEMACHINE\n          };\n\n    stepfunctions.startExecution(params, function(err, data) {\n        if (err) {\n            console.log(err, err.stack);\n        } else {\n            console.log('success');\n        }\n    });\n};\n```\n\n\n## describeInstances\u306e\u4f5c\u6210\n\n### \u8a2d\u5b9a\u5024\n\n|\u9805\u76ee                 |\u8a2d\u5b9a\u5024                       |\n|---------------------|----------------------------|\n| Runtime             | Node.js 4.3                |\n| Handler             | index.handler              |\n| Memory              | 128 MB                     |\n| Timeout             | 1 min                      |\n\n### \u6a29\u9650\n\n\u6a29\u9650\u306f\u4ee5\u4e0b\u3092\u4e0e\u3048\u307e\u3059\n\n```json\n{\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [\n        {\n            \"Sid\": \"Stmt1481002174000\",\n            \"Effect\": \"Allow\",\n            \"Action\": [\n                \"ec2:DescribeInstances\"\n            ],\n            \"Resource\": [\n                \"*\"\n            ]\n        }\n    ]\n}\n```\n\n### \u74b0\u5883\u5909\u6570\n\n\u74b0\u5883\u5909\u6570\u306b\u306f\u4ee5\u4e0b\u3092\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\n|\u5909\u6570\u540d               |\u8a2d\u5b9a\u5024                       |\u8aac\u660e                        |\n|---------------------|----------------------------|----------------------------|\n| STARTTAGKEY         | Start                      | \u81ea\u52d5\u8d77\u52d5\u7528\u30bf\u30b0\u306eKey\u540d        |\n| STOPTAGKEY          | Stop                       | \u81ea\u52d5\u505c\u6b62\u7528\u30bf\u30b0\u306eKey\u540d        |\n| OPERATIONDAYTAGKEY  | Operation                  | \u66dc\u65e5\u6307\u5b9a\u7528\u30bf\u30b0\u306eKey\u540d        |\n\n### \u30b3\u30fc\u30c9\n\n\u30b3\u30fc\u30c9\u306f\u4ee5\u4e0b\u306e\u901a\u308a\u3067\u3059\u3002\n\n```js\n'use strict';\n\nconst AWS = require('aws-sdk'),\n      ec2 = new AWS.EC2();\n\nexports.handler = (event, context, callback) => {\n\n    const generator = (function* () {\n        try {\n            const now = new Date();\n            // UTC\u2192JST\n            now.setHours(now.getHours()+9);\n            const currentHours       = now.getHours().toString(),\n                  currentDay         = now.getDay(),\n                  weekDayList        = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'],\n                  startInstanceIds   = [],\n                  stopInstanceIds    = [],\n                  STARTTAGKEY        = process.env.STARTTAGKEY,\n                  STOPTAGKEY         = process.env.STOPTAGKEY,\n                  OPERATIONDAYTAGKEY = process.env.OPERATIONDAYTAGKEY;\n            let   startInstancesList = [],\n                  stopInstancesList  = [];\n\n            // \u73fe\u5728\u6642\u523b\u306eStart\u30bf\u30b0\u304c\u4ed8\u3044\u3066\u3044\u308b\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u30ea\u30b9\u30c8\u3092\u53d6\u5f97\n            startInstancesList = yield listTaggedInstances(currentHours, STARTTAGKEY, generator);\n\n            // \u73fe\u5728\u6642\u523b\u306eStop\u30bf\u30b0\u304c\u4ed8\u3044\u3066\u3044\u308b\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u30ea\u30b9\u30c8\u3092\u53d6\u5f97\n            stopInstancesList  = yield listTaggedInstances(currentHours,  STOPTAGKEY, generator);\n\n            // \u30b9\u30bf\u30fc\u30c8\u5bfe\u8c61\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u30ea\u30b9\u30c8\u4f5c\u6210\n            if(startInstancesList.length) {\n                for(let i = 0, len = startInstancesList.length; i < len; i++) {\n                    // \u66dc\u65e5\u306e\u6307\u5b9a\u304c\u3042\u308b\u304b\u78ba\u8a8d\n                    let dayTagPoint = arrayObjectIndexOf(startInstancesList[i].Tags, OPERATIONDAYTAGKEY, 'Key');\n\n                    if(dayTagPoint < 0) {\n                        // \u66dc\u65e5\u306e\u6307\u5b9a\u304c\u306a\u3044\u5834\u5408\u306f\u3001\u305d\u306e\u307e\u307e\u30b9\u30bf\u30fc\u30c8\u5bfe\u8c61\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u30ea\u30b9\u30c8\u306b\u8ffd\u52a0\n                        startInstanceIds.push(startInstancesList[i].InstanceId);\n                    } else {\n                        // \u66dc\u65e5\u306e\u6307\u5b9a\u304c\u3042\u308b\u5834\u5408\u3001\u73fe\u5728\u66dc\u65e5\u304c\u6307\u5b9a\u671f\u9593\u5185\u3067\u3042\u308c\u3070\u3001\u30b9\u30bf\u30fc\u30c8\u5bfe\u8c61\u30ea\u30b9\u30c8\u306b\u8ffd\u52a0\n                        let runday   = startInstancesList[i].Tags[dayTagPoint].Value,\n                            startDay = runday.split('-')[0],\n                            endDay   = runday.split('-')[1];\n\n                        if(weekDayList.indexOf(startDay) <= currentDay &&\n                           currentDay                    <= weekDayList.indexOf(endDay) ) {\n                               startInstanceIds.push(startInstancesList[i].InstanceId);\n                           }\n                    }\n                }\n            }\n\n            // \u30b9\u30c8\u30c3\u30d7\u5bfe\u8c61\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u30ea\u30b9\u30c8\u4f5c\u6210\n            if(stopInstancesList.length) {\n                // \u305d\u306e\u307e\u307e\u30b9\u30c8\u30c3\u30d7\u5bfe\u8c61\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u30ea\u30b9\u30c8\u306b\u8ffd\u52a0\n                for(let i = 0; i < stopInstancesList.length; i++) {\n                    stopInstanceIds.push(stopInstancesList[i].InstanceId);\n                }\n            }\n\n            const targetMap = {\n                \"StartInstances\" : {\n                    \"count\"            : startInstanceIds.length,\n                    \"StartInstanceIds\" : startInstanceIds\n                },\n                \"StopInstances\"  : {\n                    \"count\"            : stopInstanceIds.length,\n                    \"StopInstanceIds\"  : stopInstanceIds\n                }\n            };\n\n            callback(null, targetMap);\n\n\n        } catch (e) {\n            callback(e);\n        }\n    })();\n\n    /* \u51e6\u7406\u958b\u59cb */\n    generator.next();\n\n};\n\n// \u4efb\u610f\u306e\u5024\u3067\u30bf\u30b0\u4ed8\u3051\u3055\u308c\u3066\u3044\u308b\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u30ea\u30b9\u30c8\u3092\u4f5c\u6210\nconst listTaggedInstances = (value, tag, generator) => {\n    const params = {\n        Filters: [\n            {\n                Name : 'tag:' + tag,\n                Values: [\n                    value\n                ]\n            }\n        ]\n    };\n\n    ec2.describeInstances(params, function(err, data) {\n        if(err) {\n            console.log(err, err.stack);\n            generator.throw(new Error(err, err.stack));\n        } else {\n            if(data.Reservations[0]) {\n                generator.next(data.Reservations[0].Instances);\n            } else {\n                generator.next(data.Reservations);\n            }\n            \n        }\n    });\n};\n\n// \u9023\u60f3\u914d\u5217\u3092\u8981\u7d20\u3068\u3059\u308b\u914d\u5217\u304b\u3089\u4efb\u610f\u306e\u5024\u306e\u4f4d\u7f6e\u3092\u8fd4\u5374\nconst arrayObjectIndexOf = (array, searchTerm, property) => {\n    for(let i = 0, len = array.length; i < len; i++) {\n        if(array[i][property] === searchTerm) {\n            return i;\n        }\n    }\n    return -1;\n};\n```\n\n## startInstances\u306e\u4f5c\u6210\n\n### \u8a2d\u5b9a\u5024\n\n|\u9805\u76ee                 |\u8a2d\u5b9a\u5024                       |\n|---------------------|----------------------------|\n| Runtime             | Node.js 4.3                |\n| Handler             | index.handler              |\n| Memory              | 128 MB                     |\n| Timeout             | 1 min                      |\n\n### \u6a29\u9650\n\n\u6a29\u9650\u306f\u4ee5\u4e0b\u3092\u4e0e\u3048\u307e\u3059\n\n```json\n{\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [\n        {\n            \"Sid\": \"Stmt1481002211000\",\n            \"Effect\": \"Allow\",\n            \"Action\": [\n                \"ec2:StartInstances\"\n            ],\n            \"Resource\": [\n                \"*\"\n            ]\n        }\n    ]\n}\n```\n\n### \u74b0\u5883\u5909\u6570\n\n\u306a\u3057\n\n### \u30b3\u30fc\u30c9\n\n\u30b3\u30fc\u30c9\u306f\u4ee5\u4e0b\u306e\u901a\u308a\u3067\u3059\u3002\n\n```js\n'use strict';\n\nconst AWS = require('aws-sdk'),\n      ec2 = new AWS.EC2();\n\nexports.handler = (event, context, callback) => {\n\n    const params = {\n        InstanceIds: event.StartInstanceIds\n    };\n\n    ec2.startInstances(params, function(err, data) {\n        if (err) {\n            callback(err);\n        } else {\n            callback(null, 'success');\n        }\n    });\n};\n```\n\n## stopInstances\u306e\u4f5c\u6210\n\n### \u8a2d\u5b9a\u5024\n\n|\u9805\u76ee                 |\u8a2d\u5b9a\u5024                       |\n|---------------------|----------------------------|\n| Runtime             | Node.js 4.3                |\n| Handler             | index.handler              |\n| Memory              | 128 MB                     |\n| Timeout             | 1 min                      |\n\n### \u6a29\u9650\n\n\u6a29\u9650\u306f\u4ee5\u4e0b\u3092\u4e0e\u3048\u307e\u3059\n\n```json\n{\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [\n        {\n            \"Sid\": \"Stmt1481002240000\",\n            \"Effect\": \"Allow\",\n            \"Action\": [\n                \"ec2:StopInstances\"\n            ],\n            \"Resource\": [\n                \"*\"\n            ]\n        }\n    ]\n}\n```\n\n### \u74b0\u5883\u5909\u6570\n\n\u306a\u3057\n\n### \u30b3\u30fc\u30c9\n\n\u30b3\u30fc\u30c9\u306f\u4ee5\u4e0b\u306e\u901a\u308a\u3067\u3059\u3002\n\n```js\n'use strict';\n\nconst AWS = require('aws-sdk'),\n      ec2 = new AWS.EC2();\n\nexports.handler = (event, context, callback) => {\n\n    const params = {\n        InstanceIds: event.StopInstanceIds\n    };\n\n    ec2.stopInstances(params, function(err, data) {\n        if (err) {\n            callback(err);\n        } else {\n            callback(null, 'success');\n        }\n    });\n};\n```\n\n# Step Function\u306e\u8a2d\u5b9a\n\nState Machines\u306e\u4f5c\u6210\u3092\u884c\u3044\u307e\u3059\u3002\n\n[Create a State Machine]\u30dc\u30bf\u30f3\u3092\u30af\u30ea\u30c3\u30af\u3057\u3066\u65b0\u3057\u304f\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n\u4ee5\u4e0b\u753b\u9762\u3067\u5024\u3092\u5165\u529b\u3057\u307e\u3059\u3002\n\u203bCode\u306e\u5404Resource\u306f\u9069\u5b9c\u4fee\u6b63\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n![stepfunctions_001.PNG](https://qiita-image-store.s3.amazonaws.com/0/40136/d8a2f472-dcf1-565f-0a91-0495526f9033.png)\n\n|\u9805\u76ee              |\u8a2d\u5b9a\u5024                  |\n|------------------|-----------------------|\n| Name             | ScheduledBoot         |\n| Code             | \u4ee5\u4e0b\u3092\u5165\u529b             |\n\n```json\n{\n  \"Comment\": \"Scheduled Boot Instances\",\n  \"StartAt\": \"1 DescribeInstances\",\n  \"States\": {\n    \"1 DescribeInstances\": {\n      \"Type\": \"Task\",\n      \"Resource\": \"arn:aws:lambda:us-east-1:000000000000:function:describeInstances\",\n      \"Next\": \"2 Scheduled Boot\"\n    },\n\n    \"2 Scheduled Boot\": {\n      \"Type\": \"Parallel\",\n      \"End\": true,\n      \"Branches\": [\n          {\n              \"StartAt\": \"2_1_1 Starting Choices\",\n              \"States\": {\n                  \"2_1_1 Starting Choices\": {\n                      \"Type\": \"Choice\",\n                      \"Choices\": [\n                          {\n                              \"Not\": {\n                                  \"Variable\": \"$.StartInstances.count\",\n                                  \"NumericEquals\": 0\n                              },\n                              \"Next\": \"2_1_2 Start Instances\"\n                          }\n                      ],\n                      \"Default\": \"2_1_9 End of Startings\"\n                  },\n                  \"2_1_2 Start Instances\": {\n                      \"Type\": \"Task\",\n                      \"InputPath\": \"$.StartInstances\",\n                      \"Resource\": \"arn:aws:lambda:us-east-1:000000000000:function:startInstances\",\n                      \"Next\": \"2_1_9 End of Startings\"\n                  },\n                  \"2_1_9 End of Startings\": {\n                      \"Type\": \"Pass\",\n                      \"End\": true\n                  }\n              }\n          },\n          {\n              \"StartAt\": \"2_2_1 Stopping Choices\",\n              \"States\": {\n                  \"2_2_1 Stopping Choices\": {\n                      \"Type\": \"Choice\",\n                      \"Choices\": [\n                          {\n                              \"Not\": {\n                                  \"Variable\": \"$.StopInstances.count\",\n                                  \"NumericEquals\": 0\n                              },\n                              \"Next\": \"2_2_2 Stop Instances\"\n                          }\n                      ],\n                      \"Default\": \"2_2_9 End of Stoppings\"\n                  },\n                  \"2_2_2 Stop Instances\": {\n                      \"Type\": \"Task\",\n                      \"InputPath\": \"$.StopInstances\",\n                      \"Resource\": \"arn:aws:lambda:us-east-1:000000000000:function:stopInstances\",\n                      \"Next\": \"2_2_9 End of Stoppings\"\n                  },\n                  \"2_2_9 End of Stoppings\": {\n                      \"Type\": \"Pass\",\n                      \"End\": true\n                  }\n              }\n          }\n      ]\n    }\n  }\n}\n```\n\n![stepfunctions_008.PNG](https://qiita-image-store.s3.amazonaws.com/0/40136/ec4d4894-b8b0-06fe-aba0-b7fdce4e20d7.png)\n\n\u3053\u3053\u3067\u3001Preview\u6a2a\u306e\u30af\u30eb\u30af\u30eb\u3092\u30af\u30ea\u30c3\u30af\u3059\u308b\u3068\n\n![stepfunctions_009.PNG](https://qiita-image-store.s3.amazonaws.com/0/40136/40c5fc6c-c9f6-1dfe-2510-2b5e1a41f784.png)\n\n\u3053\u306e\u3088\u3046\u306a\u30b0\u30e9\u30d5\u304c\u73fe\u308c\u308c\u3070OK\u3067\u3059\u3002\n\u305d\u306e\u307e\u307e[Create State Machine]\u3092\u30af\u30ea\u30c3\u30af\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n\u4ee5\u4e0b\u753b\u9762\u3067\u306f\u898f\u5b9a\u306eRole\u3092\u9078\u629e\u3057\u3001OK\u3092\u30af\u30ea\u30c3\u30af\u3057\u307e\u3059\u3002\n\n![stepfunctions_006.PNG](https://qiita-image-store.s3.amazonaws.com/0/40136/eff06181-5613-3622-b68a-f6a9e1961330.png)\n\n\u3053\u308c\u3067\u4f5c\u6210\u306f\u5b8c\u4e86\u3067\u3059\u3002\n\n![stepfunctions_010.PNG](https://qiita-image-store.s3.amazonaws.com/0/40136/040df0a1-ca77-1d8c-e79f-0d07dc3af7b7.png)\n\n# CloudWatch Events\u306e\u8a2d\u5b9a\n\n## \u30eb\u30fc\u30eb\u306e\u4f5c\u6210\n\nCloudWatch\u3067\u30eb\u30fc\u30eb\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n[\u30eb\u30fc\u30eb\u306e\u4f5c\u6210]\u30dc\u30bf\u30f3\u3092\u30af\u30ea\u30c3\u30af\u3002\n\n<img width=\"1266\" alt=\"CloudWatch_Management_Console.png\" src=\"https://qiita-image-store.s3.amazonaws.com/0/40136/4cc84f66-68a0-5c5f-b6da-9cc68def7964.png\">\n\n\u6bce\u6642\u9593\u306e0\u5206\u3054\u3068\u306bState Machine\u3092\u5b9f\u884c\u3057\u305f\u3044\u306e\u3067\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\n|\u9805\u76ee              |\u8a2d\u5b9a\u5024                  |\n|------------------|-----------------------|\n| \u30a4\u30d9\u30f3\u30c8          | \u30b9\u30b1\u30b8\u30e5\u30fc\u30eb           |\n| Cron\u5f0f           | 0 * * * ? *           |\n| \u30bf\u30fc\u30b2\u30c3\u30c8        | startSteps            |\n\n<img width=\"1263\" alt=\"CloudWatch_Management_Console.png\" src=\"https://qiita-image-store.s3.amazonaws.com/0/40136/32e353f4-9cef-9f57-70a6-b2c0ddd55b61.png\">\n\n\u540d\u524d\u306f\u9069\u5f53\u306b\u6c7a\u3081\u3066\u3001\n\n<img width=\"1265\" alt=\"CloudWatch_Management_Console.png\" src=\"https://qiita-image-store.s3.amazonaws.com/0/40136/7bfc2b16-9fb0-3ce9-21b2-8ec79551477c.png\">\n\n\u8a2d\u5b9a\u5b8c\u4e86\u3067\u3059\uff01\n\n<img width=\"1266\" alt=\"CloudWatch_Management_Console.png\" src=\"https://qiita-image-store.s3.amazonaws.com/0/40136/27946db0-a4ca-27cc-1973-60db6548cd5b.png\">\n\n# \u8a66\u3057\u3066\u307f\u308b\n\n\u3053\u308c\u3067\u6e96\u5099\u306f\u6574\u3063\u305f\u306e\u3067\u3001\u65e9\u901f\u8a66\u3057\u3066\u307f\u307e\u3059\u3002\n\n## \u5bfe\u8c61\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3078\u306e\u30bf\u30b0\u4ed8\u3051\n\n\u30c6\u30b9\u30c8\u7528\u306b5\u53f0\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u4f5c\u6210\u3057\u307e\u3057\u305f\u3002\n(\u30af\u30e9\u30a6\u30c9\u3063\u3066\u4fbf\u5229\u3067\u3059\u306d\u30fc)\n\u30c6\u30b9\u30c8\u7528\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306b\u5bfe\u3057\u3066\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u30bf\u30b0\u4ed8\u3051\u3057\u307e\u3059\u3002\n\n|Name              |Operation   |Start          |Stop          |\u671f\u5f85\u3059\u308b\u52d5\u304d                 |\n|------------------|------------|---------------|--------------|----------------------------|\n| startstoptest01  | Mon-Fri    | 10            |              |\u6708\u66dc\u304b\u3089\u91d1\u66dc\u306e\u9593\u3001AM10\u6642\u306b\u8d77\u52d5|\n| startstoptest02  |            |               | 10           |AM10\u6642\u306b\u505c\u6b62                 |\n| startstoptest03  | Mon-Thu    | 10            |              |\u6708\u66dc\u304b\u3089\u6728\u66dc\u306e\u9593\u3001AM10\u6642\u306b\u8d77\u52d5|\n| startstoptest04  |            | 10            |              |AM10\u6642\u306b\u8d77\u52d5                |\n| startstoptest05  | Mon-Thu    |               | 10           |AM10\u6642\u306b\u505c\u6b62                |\n\n<img width=\"896\" alt=\"EC2_Management_Console.png\" src=\"https://qiita-image-store.s3.amazonaws.com/0/40136/544c28c1-67eb-2714-bb5e-2dd8dc675941.png\">\n\n\u73fe\u5728\u3001**\u91d1\u66dc\u65e5\u3067\u73fe\u5728\u6642\u523b\u306fAM9:58**\u3067\u3059\u3002\n\u3042\u3068\u30012\u5206\u3067\u5909\u5316\u304c\u73fe\u308c\u308b\u306f\u305a\u2026\n\nAM10:00\u306b\u306a\u308a\u307e\u3057\u305f\u3001\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u72b6\u614b\u306f\u3069\u3046\u3067\u3057\u3087\u3046\u3002\n\n<img width=\"896\" alt=\"EC2_Management_Console.png\" src=\"https://qiita-image-store.s3.amazonaws.com/0/40136/2bf3b63c-0bda-256d-0f9d-7d6cf10054d0.png\">\n\n\u304d\u3061\u3093\u3068\u5bfe\u8c61\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3060\u3051\u5909\u5316\u304c\u3042\u308a\u307e\u3057\u305f\uff01\n\n\u4eca\u65e5\u306f\u91d1\u66dc\u65e5\u306a\u306e\u3067\u3001**startstoptest03**\u306f\u53cd\u5fdc\u3057\u3066\u307e\u305b\u3093\u3002\n\u307e\u305f\u3001\u66dc\u65e5\u6307\u5b9a\u306f\u3042\u304f\u307e\u3067**Start**\u306b\u3057\u304b\u5f71\u97ff\u3057\u306a\u3044\u305f\u3081\u3001**startstoptest05**\u306f\u304d\u3061\u3093\u3068\u505c\u6b62\u3057\u3066\u3044\u307e\u3059\u3002\n\n<img width=\"896\" alt=\"EC2_Management_Console.png\" src=\"https://qiita-image-store.s3.amazonaws.com/0/40136/90321e6b-c724-d1fd-ec5c-d3202d724198.png\">\n\n\u666e\u6bb5\u306f\u30b9\u30c6\u30fc\u30b8\u74b0\u5883\u306b\u5bfe\u3057\u3066\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u611f\u3058\u3067\u6307\u5b9a\u3057\u3066\u904b\u7528\u3057\u3066\u3044\u307e\u3059\u3002\n\n<img width=\"897\" alt=\"EC2_Management_Console.png\" src=\"https://qiita-image-store.s3.amazonaws.com/0/40136/d54b9d96-b835-b8ea-9286-2acf4a56a3e5.png\">\n\n# \u6ce8\u610f\u4e8b\u9805\n\n- \u66dc\u65e5\u306e\u6307\u5b9a\u306f['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat']\u3092\u7d44\u307f\u5408\u308f\u305b\u3066\u884c\u3044\u307e\u3059\u3002\n- \u73fe\u5728\u3001\u66dc\u65e5\u306e\u6307\u5b9a\u3092**Fri-Sun**\u306e\u3088\u3046\u306b\u6307\u5b9a\u3059\u308b\u3068\u6b63\u5e38\u306b\u52d5\u304d\u307e\u305b\u3093\u3002Sun\u2192Mon\u2192\u2026\u2192Sat\u306e\u9806\u756a\u3067\u6307\u5b9a\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n- Start\u3068Stop\u306b\u540c\u3058\u6642\u9593\u3092\u5165\u308c\u308b\u3068\u6b63\u5e38\u306b\u52d5\u304b\u306a\u3044\u3068\u601d\u3044\u307e\u3059\u3002\n- \u6642\u9593\u306e\u6307\u5b9a\u306f\u65e5\u672c\u6642\u9593\u306724H\u8868\u8a18\u3067\u3059\u3002\n\n# \u7d42\u308f\u308a\u306b\n\n\u30a8\u30e9\u30fc\u51e6\u7406\u7b49\u307e\u3060\u6539\u826f\u306e\u4f59\u5730\u306f\u3042\u308a\u307e\u3059\u304c\u3001\u3053\u306e\u30ec\u30d9\u30eb\u3067\u3042\u308c\u3070\u6c17\u8efd\u306b\u5c0e\u5165\u3067\u304d\u308b\u306e\u3067\u3001\u7c21\u5358\u306b\u30b3\u30b9\u30c8\u524a\u6e1b\u3067\u304d\u308b\u306e\u3067\u306f\u306a\u3044\u3067\u3057\u3087\u3046\u304b\u3002\nStep Function\u306f\u4f7f\u3063\u3066\u307f\u305f\u3070\u304b\u308a\u3067\u3059\u304c\u3001\u305d\u308c\u305e\u308c\u306eLambda\u3092\u7c21\u5358\u306b\u8a18\u8ff0\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u308b\u306e\u3067\u3001\u3053\u308c\u304b\u3089\u3082\u3063\u3068\u6d3b\u7528\u306e\u5e45\u304c\u5e83\u304c\u308a\u305d\u3046\u3067\u3059\u3002\n"}