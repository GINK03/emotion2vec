{"context": "\n\n\u306f\u3058\u3081\u306b\n\u5148\u65e5 Stan\u3068R\u3067\u30d9\u30a4\u30ba\u7d71\u8a08\u30e2\u30c7\u30ea\u30f3\u30b0 \u3068\u3044\u3046\u672c\u3092\u8aad\u307f\u307e\u3057\u3066\u3001\u7d71\u8a08\u30e2\u30c7\u30ea\u30f3\u30b0\u3092\u3084\u3063\u3066\u307f\u305f\u3044\u6c17\u6301\u3061\u306b\u306a\u308a\u307e\u3057\u305f\u3002\u3068\u3066\u3082\u826f\u3044\u672c\u3067\u3059\u306e\u3067\u30aa\u30b9\u30b9\u30e1\u3067\u3059\u3002\nStan\u306fR\u304b\u3089\u3060\u3051\u3067\u306a\u304f\u3001Python\u30e9\u30a4\u30d6\u30e9\u30ea\u306ePyStan\u304b\u3089\u4f7f\u3046\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\u4eca\u56de\u306f\u30012016\u5e74\u306e\u30b5\u30c3\u30ab\u30fcJ1\u30ea\u30fc\u30b0\u306e\u5404\u30c1\u30fc\u30e0\u306e\u5f37\u3055(\u306e\u3088\u3046\u306a\u5024)\u3092\u8a66\u5408\u7d50\u679c\u304b\u3089\u63a8\u5b9a\u3059\u308b\u30e2\u30c7\u30eb\u3092\u4f5c\u3063\u3066\u307f\u308b\u3053\u3068\u306b\u3057\u307e\u3059\u3002\n\n\u4eca\u56de\u306e\u4e3b\u306aVersion\n\nPython 3.5.1\npystan==2.14.0.0\n\n\n\u30c7\u30fc\u30bf\u3092\u96c6\u3081\u308b\nJ\u30ea\u30fc\u30b0\u306e\u8a66\u5408\u7d50\u679c\u306f http://www.jleague.jp/stats/SFTD01.html \u306a\u3069\u304b\u3089\u8abf\u3079\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\u305d\u3053\u304b\u3089\u4f55\u3089\u304b\u306e\u65b9\u6cd5\u30672016\u5e74\u306e 1st\u30b9\u30c6\u30fc\u30b8\u306e \u5404\u30c1\u30fc\u30e0\u306e\u5bfe\u6226\u7d50\u679c\u306e\u96c6\u3081\u305f\u4ee5\u4e0b\u306e\u30c7\u30fc\u30bf\u304c\u3042\u308b\u3068\u3057\u307e\u3059\u3002\nhttps://gist.github.com/mokemokechicken/a26eb7230e51fba7018476f7706e5b0b\n\n\n\naway_score\naway_team\ndate\nhome_score\nhome_team\nscore\nvisitors\n\n\n\n\n1\n\u540d\u53e4\u5c4b\n02/27(\u571f)\n0\n\u78d0\u7530\n0-1\n14333\n\n\n1\n\u5ddd\u5d0e\uff26\n02/27(\u571f)\n0\n\u5e83\u5cf6\n0-1\n18120\n\n\n1\n\u798f\u5ca1\n02/27(\u571f)\n2\n\u9ce5\u6816\n2-1\n19762\n\n\n...\n...\n...\n...\n...\n...\n...\n\n\n\n\n\u601d\u3046\u3053\u3068\n\n\u30c1\u30fc\u30e0\u6570\u306f 18 \u3067\u3042\u308b\n1st\u30b9\u30c6\u30fc\u30b8\u306f \u5404\u30c1\u30fc\u30e0\u540c\u58eb\u304c1\u56de\u3060\u3051\u5bfe\u6226\u3059\u308b\u306e\u3067\u8a66\u5408\u6570\u306f 153(=18*17/2)\n\u30b5\u30c3\u30ab\u30fc\u3067\u306f\u30db\u30fc\u30e0\uff06\u30a2\u30a6\u30a7\u30a4\u3068\u3044\u3046\u7a0b\u3060\u3057\u3001\u5bfe\u6226\u306b\u304a\u3051\u308b\u5730\u5143\u3068\u6575\u5730\u306e\u9055\u3044\u304c\u3042\u308a\u305d\u3046\n\n\n\u8a66\u5408\u7d50\u679c\u304c\u751f\u307e\u308c\u308b\u30e1\u30ab\u30cb\u30ba\u30e0\u3092\u8003\u3048\u308b\n\u8a66\u5408\u7d50\u679c\uff08\u30b9\u30b3\u30a2\uff09\u304c\u3069\u306e\u3088\u3046\u306b\u751f\u3058\u308b\u304b\u3092\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u4eee\u5b9a\u3057\u3066\u307f\u307e\u3059\u3002\n\n\u5404\u30c1\u30fc\u30e0\u306f \u653b\u6483\u529b \u9632\u5fa1\u529b \u30db\u30fc\u30e0\u529b \u3068\u3044\u3046\u306e\u304c\u3042\u308b\u3068\u3059\u308b\u3002\n\u653b\u6483\u529b\u304c\u9ad8\u3044\u307b\u3069\u5f97\u70b9\u304c\u591a\u304f\u3001\u9632\u5fa1\u529b\u304c\u9ad8\u3044\u307b\u3069\u5931\u70b9\u304c\u5c11\u306a\u3044\n\u30db\u30fc\u30e0\u30b2\u30fc\u30e0\u306b\u304a\u3044\u3066\u306f\u3001\u653b\u6483\u529b\u3001\u9632\u5fa1\u529b\u3068\u3082\u306b\u30a2\u30c9\u30d0\u30f3\u30c6\u30fc\u30b8\u304c\u4ed8\u4e0e\u3055\u308c\u308b(\uff1d\u30db\u30fc\u30e0\u529b)\n\n\u3068\u3057\u307e\u3059\u3002\u307e\u3042\u3001\u3053\u3053\u307e\u3067\u306f\u305d\u3093\u306a\u306b\u304a\u304b\u3057\u306a\u8a71\u3067\u306f\u306a\u3055\u305d\u3046\u3067\u3059\u3002\n\u6b21\u306b\u3001\u7d71\u8a08\u306e\u4e16\u754c\u306b\u5165\u3063\u3066\u8003\u3048\u3066\u307f\u307e\u3059\u3002\n\u307e\u305a\u300c\u5f97\u70b9\u300d\u306f\u30dd\u30a2\u30bd\u30f3\u5206\u5e03\u306b\u5f93\u3046\u3068\u9069\u5f53\u306b\u4eee\u5b9a\u3057\u307e\u3059\u3002\n\u3064\u307e\u308a\u3001\n\u3042\u308b\u30c1\u30fc\u30e0\u306e\u3042\u308b\u8a66\u5408\u306e\u5f97\u70b9 ~ Poisson(\u305d\u306e\u30c1\u30fc\u30e0\u306e\u653b\u6483\u529b - \u5bfe\u6226\u30c1\u30fc\u30e0\u306e\u9632\u5fa1\u529b)\n\u3068\u3044\u3046\u611f\u3058\u3067\u3059\u3002 \uff08\u3061\u306a\u307f\u306b ~ \u306f\u300c\u5206\u5e03\u306b\u5f93\u3046\u300d\u3068\u3044\u3046\u610f\u5473\u3067\u3059\u3002\uff09\n\u305f\u3060\u3057\u3001\u30dd\u30a2\u30bd\u30f3\u5206\u5e03\u306e\u30d1\u30e9\u30e1\u30fc\u30bf\u306f\u8ca0\u306e\u5024\u3092\u53d6\u308c\u306a\u3044\u306e\u3067\u3001exp\u306b\u4fbf\u5b9c\u7684\u306b\u4e57\u3063\u3051\u3066\u3001\u3055\u3089\u306b\u30db\u30fc\u30e0\u529b\u3092\u52a0\u5473\u3059\u308b\u3068\u3001\n\u3042\u308b\u30db\u30fc\u30e0\u30c1\u30fc\u30e0\u306e\u3042\u308b\u8a66\u5408\u306e\u5f97\u70b9 ~ Poisson(exp( \n        (\u30db\u30fc\u30e0\u529b + \u305d\u306e\u30db\u30fc\u30e0\u30c1\u30fc\u30e0\u306e\u653b\u6483\u529b) - \u30a2\u30a6\u30a7\u30a4\u30c1\u30fc\u30e0\u306e\u9632\u5fa1\u529b\n    ))\n\n\u306b\u306a\u308b\u3068\u3057\u307e\u3059\u3002\n\u307e\u305f\u3001\u5bfe\u79f0\u7684\u306b\n\u3042\u308b\u30db\u30fc\u30e0\u30c1\u30fc\u30e0\u306e\u3042\u308b\u8a66\u5408\u306e\u5931\u70b9 ~ Poisson(exp( \n        \u30a2\u30a6\u30a7\u30a4\u30c1\u30fc\u30e0\u306e\u653b\u6483\u529b - (\u30db\u30fc\u30e0\u529b + \u305d\u306e\u30db\u30fc\u30e0\u30c1\u30fc\u30e0\u306e\u9632\u5fa1\u529b)\n    ))\n\n\u3068\u3057\u307e\u3059\u3002\n\n\u30e2\u30c7\u30eb\u3092Stan\u3067\u8a18\u8ff0\u3059\u308b\n\u3053\u3093\u306a\u611f\u3058\u306b\u306a\u308a\u307e\u3057\u305f\u3002\nmodel_code = \"\"\"\ndata {\n    int N;  // N Games\n    int K;  // K Teams\n    int Th[N]; // Home Team ID\n    int Ta[N]; // Away Team ID\n    int Sh[N]; // Home Team score point\n    int Sa[N]; // Away Team score point\n}\n\nparameters {\n    real atk[K];\n    real def[K];\n    real home_power[K];\n    real<lower=0> sigma;\n    real<lower=0> hp_sigma;\n}\n\nmodel {\n    for (k in 1:K) {\n        atk[k] ~ normal(0, sigma);\n        def[k] ~ normal(0, sigma);\n        home_power[k] ~ normal(0, hp_sigma);\n    }\n\n    for (n in 1:N) {\n        Sh[n] ~ poisson(exp(\n            (home_power[Th[n]] + atk[Th[n]]) - \n            (def[Ta[n]])\n        ));\n\n        Sa[n] ~ poisson(exp(\n            (atk[Ta[n]]) - \n            (def[Th[n]] + home_power[Th[n]])\n        ));\n    }\n}\n\ngenerated quantities {\n    real games[K, K, 2];\n\n    for (th in 1:K) {\n        for (ta in 1:K) {\n            games[th, ta, 1] = poisson_rng(exp((home_power[th] + atk[th]) - (def[ta])));\n            games[th, ta, 2] = poisson_rng(exp((atk[ta]) - (def[th] + home_power[th])));\n        }\n    }\n}\n\"\"\"\n\n\n\u7c21\u5358\u306a\u8aac\u660e\nStan\u306b\u3064\u3044\u3066\u306f\u3001\u5148\u306b\u7d39\u4ecb\u3057\u305f\u672c\u304c\u3068\u3066\u3082\u53c2\u8003\u306b\u306a\u308a\u307e\u3059\u304c\u3001\u3053\u3053\u3067\u3082\u7c21\u5358\u306b\u8aac\u660e\u3092\u3057\u3066\u307f\u307e\u3059\u3002\n\ndata\u30d6\u30ed\u30c3\u30af\ndata {\n    int N;  // N Games\n    int K;  // K Teams\n    int Th[N]; // Home Team ID\n    int Ta[N]; // Away Team ID\n    int Sh[N]; // Home Team score point\n    int Sa[N]; // Away Team score point\n}\n\n\u3053\u306edata\u30d6\u30ed\u30c3\u30af\u306f\u3001\u5916\u90e8\u304b\u3089\u4e0e\u3048\u3089\u308c\u308b\u30c7\u30fc\u30bf\u3092\u5ba3\u8a00\u3057\u3066\u3044\u307e\u3059\u3002\n\u5148\u7a0b\u96c6\u3081\u305f\u30c7\u30fc\u30bf\u3092\u3053\u306e\u540d\u524d\u3067\u5f8c\u7a0b\u6ce8\u5165\u3059\u308b\u3053\u3068\u306b\u306a\u308a\u307e\u3059\u3002\n\nparameters\u30d6\u30ed\u30c3\u30af\nparameters {\n    real atk[K];\n    real def[K];\n    real home_power[K];\n    real<lower=0> sigma;\n    real<lower=0> hp_sigma;\n}\n\n\u3053\u306eparameters\u30d6\u30ed\u30c3\u30af\u306f\u3001\u63a8\u5b9a\u3057\u305f\u3044\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u8a18\u8ff0\u3057\u307e\u3059\u3002\n\u4eca\u56de\u306f\u3001\u653b\u6483\u529b(atk)\u3001\u9632\u5fa1\u529b(def)\u3001\u30db\u30fc\u30e0\u529b(home_power)\u304c\u30e1\u30a4\u30f3\u3067\u3059\u3002\n<lower=0>\u3068\u3044\u3046\u306e\u306f\u3001\u30d1\u30e9\u30e1\u30fc\u30bf\u304c\u3068\u308a\u5f97\u308b\u7bc4\u56f2\u3092\u8868\u3057\u307e\u3059\u3002\n\nmodel\u30d6\u30ed\u30c3\u30af\nmodel {\n    for (k in 1:K) {\n        atk[k] ~ normal(0, sigma);\n        def[k] ~ normal(0, sigma);\n        home_power[k] ~ normal(0, hp_sigma);\n    }\n\n    for (n in 1:N) {\n        Sh[n] ~ poisson(exp(\n            (home_power[Th[n]] + atk[Th[n]]) - \n            (def[Ta[n]])\n        ));\n\n        Sa[n] ~ poisson(exp(\n            (atk[Ta[n]]) - \n            (def[Th[n]] + home_power[Th[n]])\n        ));\n    }\n}\n\n\u3053\u306emodel\u30d6\u30ed\u30c3\u30af\u306f\u3001\u5165\u529b\u30c7\u30fc\u30bf\u3068\u63a8\u5b9a\u3057\u305f\u3044\u30d1\u30e9\u30e1\u30fc\u30bf\u306e\u95a2\u4fc2\u3092\u78ba\u7387\u5206\u5e03\u3092\u4f7f\u3063\u3066\u8868\u73fe\u3057\u307e\u3059\u3002\n\u5148\u7a0b\u306e\u300c\u30e1\u30ab\u30cb\u30ba\u30e0\u300d\u3082\u3053\u3053\u3067\u8868\u73fe\u3057\u307e\u3059\u3002\n\u307e\u305f\u3001\u5404\u30c1\u30fc\u30e0\u306e\u653b\u6483\u529b\u3084\u9632\u5fa1\u529b\u306a\u3069\u306f\u300c\u5e73\u57470\u306e\u5206\u6563sigma\u306e\u6b63\u898f\u5206\u5e03\u300d\u306b\u5f93\u3046\u3068\u3044\u3046\u4eee\u5b9a\u3092\u304a\u304d\u307e\u3059\u3002\n\u3053\u306esigma\u3082(\u3064\u3044\u3067\u306b)\u63a8\u5b9a\u3059\u308b\u30d1\u30e9\u30e1\u30fc\u30bf\u306b\u306a\u308a\u307e\u3059\u3002\n\u3053\u3046\u3057\u306a\u3044\u3068\u8a08\u7b97(MCMC)\u304c\u53ce\u675f\u3057\u307e\u305b\u3093\u3067\u3057\u305f(\u5168\u5024\u304c\u3044\u308d\u3093\u306a\u7bc4\u56f2\u5024\u3067\u53ce\u675f\u3057\u3066\u3057\u307e\u3046\u306e\u3067)\u3002\u307e\u3042\u300c\u3068\u308a\u3042\u3048\u305a\u3053\u306e\u8fba\u306e\u5024\u3067\u53ce\u307e\u3063\u3066\u6b32\u3057\u3044\u300d\u3068\u3044\u3046\u5e0c\u671b\u3092\u66f8\u3044\u305f\u611f\u3058\u3067\u3057\u3087\u3046\u304b\u3002\n\u9762\u767d\u3044\u306e\u304c sigma \u3092\u56fa\u5b9a\u306e1\u3068\u66f8\u304f\u3088\u308a\u3001\u63a8\u5b9a\u3055\u305b\u305f\u307b\u3046\u304c\u8a08\u7b97\u304c\u53ce\u675f\u3057\u3084\u3059\u304b\u3063\u305f\u3053\u3068\u3067\u3059(\u53ce\u675f\u3057\u305fsigma\u306f1\u3088\u308a\u3060\u3044\u3076\u5c0f\u3055\u304b\u3063\u305f)\u30021\u3068\u30cf\u30fc\u30c9\u30b3\u30fc\u30c9\u3057\u305f\u65b9\u304c\u7bc4\u56f2\u3092\u9650\u5b9a\u3057\u305f\u6c17\u6301\u3061\u306b\u306a\u308a\u307e\u3059\u304c\u3001\u305d\u3046\u3067\u3082\u306a\u3044\u3001\u3068\u3044\u3046\u306e\u304c\u9762\u767d\u3044\u3067\u3059\u3002\n\ngenerated quantities\u30d6\u30ed\u30c3\u30af\ngenerated quantities {\n    real games[K, K, 2];\n\n    for (th in 1:K) {\n        for (ta in 1:K) {\n            games[th, ta, 1] = poisson_rng(exp((home_power[th] + atk[th]) - (def[ta])));\n            games[th, ta, 2] = poisson_rng(exp((atk[ta]) - (def[th] + home_power[th])));\n        }\n    }\n}\n\n\u3053\u306egenerated quantities\u30d6\u30ed\u30c3\u30af\u306f\u30aa\u30de\u30b1\u307f\u305f\u3044\u306a\u3082\u306e\u3067\u3059\u3002\n\u53ce\u675f\u3057\u305f\u5024\u3092\u4f7f\u3063\u3066\u3001\u5225\u9014\u9055\u3046\u8a08\u7b97\u3092\u3057\u3066\u304f\u308c\u308b\u6a5f\u80fd\u3067\u3059\u3002\n\u3053\u3053\u3067\u306f\u3001\u5404\u30c1\u30fc\u30e0\u306e\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u4f7f\u3063\u3066\u3001\u5404\u30c1\u30fc\u30e0\u304c\u5bfe\u6226\u3057\u305f\u3068\u304d\u306e\u8a66\u5408\u306e\u30b9\u30b3\u30a2\u3092\u30b5\u30f3\u30d7\u30ea\u30f3\u30b0\u3057\u3066\u3082\u3089\u3063\u3066\u3044\u307e\u3059\u3002\u5225\u9014Python\u5074\u3067\u8a08\u7b97\u3057\u3066\u3082\u3088\u3044\u306e\u3067\u3059\u304c\u3001\u8a08\u7b97\u30ed\u30b8\u30c3\u30af\u306fModel\u3068\u4e00\u81f4\u3055\u305b\u306a\u3044\u3068\u3044\u3051\u306a\u3044\u306e\u3067\u3001\u3053\u3053\u3067\u7ba1\u7406\u3057\u305f\u307b\u3046\u304c\u30e1\u30f3\u30c6\u30ca\u30f3\u30b9\u304c\u697d\u305d\u3046\u3067\u3059\u3002\n\n\u305d\u306e\u4ed6\n\u4ed6\u306b transformed parameters\u30d6\u30ed\u30c3\u30af\u3068\u3044\u3046\u306e\u304c\u3042\u3063\u3066\u3001data\u3084parameters \u306e\u5909\u6570\u3092\u4f7f\u3063\u3066\u3001\u5225\u5909\u6570\u3092\u5b9a\u7fa9\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\u4eca\u56de\u306e (home_power[th] + atk[th]) - (def[ta]) \u306a\u3069\u306e\u5f0f\u3082model\u3068generated quantities\u306b2\u56de\u51fa\u3066\u304d\u3066\u3044\u308b\u306e\u3067\u3001\u672c\u6765\u306f\u307e\u3068\u3081\u305f\u65b9\u304c\u826f\u3044\u306e\u3067\u3057\u3087\u3046\u304c\u3001\u3001\u3001\n\n\u30e2\u30c7\u30eb\u3068\u30c7\u30fc\u30bf\u3067\u8a08\u7b97\u3059\u308b\n\n\u3044\u304f\u3064\u304b\u4fbf\u5229\u95a2\u6570\u3092\u5b9a\u7fa9\u3057\u3066\u304a\u304f\nfrom hashlib import sha256\nimport pickle\nimport time\n\nimport requests\nimport pandas as pd\nfrom pystan import StanModel\n\n\ndef stan_cache(file=None, model_code=None, model_name=None, cache_dir=\".\"):\n    \"\"\"Use just as you would `stan`\"\"\"\n    # http://pystan.readthedocs.io/en/latest/avoiding_recompilation.html#automatically-reusing-models\n\n    if file:\n        if file.startswith(\"http\"):\n            model_code = requests.get(file).text\n        else:\n            with open(file) as f:\n                model_code = f.read()\n    code_hash = sha256(model_code.encode('utf8')).hexdigest()\n    if model_name is None:\n        cache_fn = '{}/cached-model-{}.pkl'.format(cache_dir, code_hash)\n    else:\n        cache_fn = '{}/cached-{}-{}.pkl'.format(cache_dir, model_name, code_hash)\n    try:\n        sm = pickle.load(open(cache_fn, 'rb'))\n    except:\n        start_time = time.time()\n        sm = StanModel(model_code=model_code)\n        print(\"compile time: %s sec\" % (time.time() - start_time))\n        with open(cache_fn, 'wb') as f:\n            pickle.dump(sm, f)\n    return sm\n\n\ndef sampling_summary_to_df(fit4model):\n    \"\"\"\n\n    :param StanFit4model fit4model:\n    :return:\n    \"\"\"\n    s = fit4model.summary()\n    return pd.DataFrame(s[\"summary\"], columns=s['summary_colnames'], index=s['summary_rownames'])\n\nstan_cache \u95a2\u6570\u306f\u3001stan\u306e\u30e2\u30c7\u30eb\u3092\u30ad\u30e3\u30c3\u30b7\u30e5\u3057\u305f\u308a\u3001\u30e2\u30c7\u30eb\u306e\u30b3\u30fc\u30c9\u3092HTTP\u7d4c\u7531\u3067\u3082\u53d6\u5f97\u3059\u308b\u3088\u3046\u306b\u3057\u305f\u3082\u306e\u3067\u3059\u3002\u4fbf\u5229\u3067\u3059\u3002\nsampling_summary_to_df\u95a2\u6570\u306f\u3001model\u3092fit\u3057\u305f\u7d50\u679c\u3092 Pandas\u306eDataFrame\u306b\u3057\u3066\u304f\u308c\u308b\u3082\u306e\u3067\u3059\u3002Jupyter\u306a\u3069\u3067\u4f5c\u696d\u3059\u308b\u6642\u306b\u898b\u3084\u3059\u304f\u306a\u308b\u30e1\u30ea\u30c3\u30c8\u304c\u3042\u308a\u307e\u3059\u3002\n\n\u5b9f\u884c\u3059\u308b\nimport numpy as np\nimport pandas as pd\n\ndf = pd.read_csv(\"https://gist.githubusercontent.com/mokemokechicken/a26eb7230e51fba7018476f7706e5b0b/raw/90e1c26e172b92d5f52d53d0591a611e0258bd2b/2016-j1league-1st.csv\")\n\nteam_list = list(sorted(set(df['away_team']) | set(df['home_team'])))\nteams = dict(zip(range(1, len(team_list)+1), team_list))\nfor k, v in list(teams.items()):\n    teams[v] = k\n\nmodel = stan_cache(model_code=model_code) \n\nstan_input = {\n    \"N\": len(df),\n    \"K\": len(team_list),\n    \"Th\": df['home_team'].apply(lambda x: teams[x]),\n    \"Ta\": df['away_team'].apply(lambda x: teams[x]),\n    \"Sh\": df['home_score'],\n    \"Sa\": df['away_score'],\n}\n\nfitted = model.sampling(data=stan_input, seed=999)\nsampling_summary_to_df(fitted).sort_values(\"Rhat\", ascending=False)\n\n\n\u7d50\u679c\n\u30d1\u30e9\u30e1\u30fc\u30bf\u306e\u63a8\u5b9a\u7d50\u679c\u306e\u30b5\u30de\u30ea\u30fc\u306f\u4f8b\u3048\u3070\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\n\u66f8\u7c4d\u3067\u306f\u3001\u300c\u3053\u306eRhat\u304c\u5168\u3066\u306e\u63a8\u5b9a\u30d1\u30e9\u30e1\u30fc\u30bf\u30671.1\u672a\u6e80\u306b\u306a\u308b\u3068\u307e\u3042\u8a08\u7b97\u304c\u53ce\u675f\u3057\u305f\u3068\u307f\u306a\u3057\u3066\u826f\u3044\u3060\u308d\u3046\u300d\u3068\u3044\u3046\u3053\u3068\u3067\u3059\u306e\u3067\u3001\u307e\u3042\u4e00\u5fdc\u53ce\u675f\u3057\u305f\u3068\u307f\u306a\u3059\u3053\u3068\u306b\u3057\u307e\u3059\u3002\n\u305f\u3060\u3001n_eff\u3068\u3044\u3046\u300c\u3061\u3083\u3093\u3068\u5024\u304c\u30b5\u30f3\u30d7\u30ea\u30f3\u30b0\u3067\u304d\u305f\u56de\u6570\u300d\u304c100\u3088\u308a\u5c0f\u3055\u3044\u306e\u306f\u3061\u3087\u3063\u3068\u5fae\u5999\u3068\u3044\u3046\u3053\u3068\uff08\u7279\u306b\u533a\u9593\u63a8\u5b9a\u3059\u308b\u3068\u304d\uff09\u306a\u306e\u3067\u3001\u5c11\u3057\u5fae\u5999\u306a\u3082\u306e\u3082\u3042\u308a\u307e\u3059\u304c\u3001\u4eca\u56de\u306f\u826f\u3057\u3068\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\n\n\n\nmean\nse_mean\nsd\n2.5%\n25%\n50%\n75%\n97.5%\nn_eff\nRhat\n\n\n\n\nlp__\n-214.114891\n1.542823\n13.712915\n-237.604900\n-223.960556\n-215.747425\n-205.033248\n-183.817981\n79.0\n1.049519\n\n\nhp_sigma\n0.094069\n0.005835\n0.063921\n0.011408\n0.044970\n0.081836\n0.132181\n0.245524\n120.0\n1.031258\n\n\natk[12]\n0.048430\n0.009507\n0.158794\n-0.318161\n-0.052664\n0.052359\n0.155878\n0.342186\n279.0\n1.018430\n\n\natk[16]\n0.225840\n0.008570\n0.158951\n-0.075769\n0.115129\n0.223274\n0.330571\n0.531899\n344.0\n1.013612\n\n\nsigma\n0.220279\n0.002456\n0.056227\n0.112035\n0.182132\n0.217550\n0.255500\n0.344382\n524.0\n1.011379\n\n\n...\n...\n...\n...\n...\n...\n...\n...\n...\n...\n...\n\n\n\n\n\u7d50\u679c\u3092\u773a\u3081\u308b\n\n\u30c1\u30fc\u30e0\u306e\u5f37\u3055\u306e\u63a8\u5b9a\u5024\n\u30c1\u30fc\u30e0\u5225\u306b\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u56de\u53ce\u3057\u307e\u3059\u3002\ntk = {}\n\nparams = fitted.extract()\natks = params['atk']\ndefs = params['def']\nhome_power = params['home_power']\ngames = params['games']\n\n\nfor k, team in enumerate(team_list):\n    tk[team] = {\n            \"atk\": np.mean(atks[:, k]),\n            \"def\": np.mean(defs[:, k]),\n            \"home_power\": np.mean(home_power[:, k]),\n    }\n\ntdf = pd.DataFrame(tk).T\n\n\u3068\u308a\u3042\u3048\u305a\u3001\u300c\u30db\u30fc\u30e0\u529b\u300d\u304c\u9ad8\u3044\u9806\u306b\u4e26\u3079\u3066\u307f\u307e\u3059\u3002\ntdf.sort_values(\"home_power\", ascending=False)\n\n\n\n\n\natk\ndef\nhome_power\n\n\n\n\n\u9e7f\u5cf6\n0.225840\n0.217699\n0.068898\n\n\n\u6d66\u548c\n0.152638\n0.063192\n0.041830\n\n\n\u795e\u6238\n0.099154\n-0.163383\n0.030443\n\n\n\u5e83\u5cf6\n0.293808\n-0.000985\n0.029861\n\n\n\u540d\u53e4\u5c4b\n0.130757\n-0.247969\n0.015849\n\n\n\u5ddd\u5d0e\uff26\n0.312593\n0.087859\n0.014728\n\n\n\u65b0\u6f5f\n0.010827\n-0.146252\n0.011885\n\n\n\u78d0\u7530\n0.048430\n-0.105230\n0.011843\n\n\n\u4ed9\u53f0\n0.037960\n-0.150151\n0.005462\n\n\nFC\u6771\u4eac\n-0.072115\n0.017485\n-0.005050\n\n\n\uff27\u5927\u962a\n0.087034\n-0.033666\n-0.005532\n\n\n\u9ce5\u6816\n-0.232595\n0.103412\n-0.006186\n\n\n\u67cf\n0.036172\n-0.053332\n-0.009568\n\n\n\u5927\u5bae\n-0.040014\n0.027842\n-0.020942\n\n\n\u6a2a\u6d5cFM\n0.059420\n-0.009322\n-0.021393\n\n\n\u798f\u5ca1\n-0.185292\n-0.130759\n-0.026643\n\n\n\u7532\u5e9c\n0.002608\n-0.268061\n-0.037079\n\n\n\u6e58\u5357\n-0.000052\n-0.184515\n-0.049440\n\n\n\n\u3068\u306a\u308a\u307e\u3057\u305f\u3002\n\u4eca\u56de\u3001\u5f37\u3055\u306e\u5e73\u5747\u304c\uff10\u306b\u306a\u3063\u3066\u3044\u308b\u306f\u305a\u306a\u306e\u3067\u30010\u3088\u308a\u9ad8\u3044\u304b\u4f4e\u3044\u304b\u3067J1\u30c1\u30fc\u30e0\u306e\u5e73\u5747\u3088\u308a\u3069\u3046\u304b\u3001\u304c\u8868\u73fe\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u306b\u306a\u308a\u307e\u3059\u3002\n\u3061\u306a\u307f\u306b\u30012nd\u30b9\u30c6\u30fc\u30b8\u306e\u30c7\u30fc\u30bf\u3067\u3084\u308b\u3068\u307e\u305f\u5168\u7136\u9055\u3046\u7d50\u679c\u306b\u306a\u308a\u307e\u3059\uff08\u9e7f\u5cf6\u304c\u3060\u3044\u3076\u60aa\u304f\u306a\u308b\uff09\u3002\n\u3042\u304f\u307e\u3067\u30011st\u30b9\u30c6\u30fc\u30b8\u306e\u30c7\u30fc\u30bf\u304b\u3089\u8a08\u7b97\u3057\u305f\u3089\u3053\u3046\u306a\u3063\u305f\u3068\u3044\u3046\u3060\u3051\u306a\u306e\u3067\u3001\u3042\u3057\u304b\u3089\u305a\u3002\n\u8003\u3048\u3066\u307f\u308c\u3070\u5f53\u305f\u308a\u524d\u306a\u306e\u3067\u3059\u304c\u30012016\u5e741st\u30b9\u30c6\u30fc\u30b8\u306e\u9806\u4f4d\u8868\u306b\u8fd1\u3044\u611f\u3058\u306b\u306a\u308a\u307e\u3059\u3002\nhttps://ja.wikipedia.org/wiki/2016%E5%B9%B4%E3%81%AEJ1%E3%83%AA%E3%83%BC%E3%82%B0#.E9.A0.86.E4.BD.8D.E8.A1.A8\n\u7279\u306b\u300c\u7dcf\u5f97\u70b9\u3001\u7dcf\u5931\u70b9\u300d\u3068\u300c\u653b\u6483\u529b\u3001\u9632\u5fa1\u529b\u300d\u306f\u6982\u306d\u76f8\u95a2\u304c\u3042\u308a\u305d\u3046\u3067\u3059\uff08\u7121\u3044\u306a\u3089\u306a\u3044\u3067\u56f0\u308a\u307e\u3059\u304c\uff09\u3002\n\n\u3055\u3044\u3054\u306b\n\u3053\u306e\u4e88\u6e2c\u30e2\u30c7\u30eb\u30672nd\u30b9\u30c6\u30fc\u30b8\u306eToto\u3092\u8cb7\u3063\u305f\u3089\u3069\u3046\u306a\u308b\u304b\u3001\u3001\u3001\u3068\u30b7\u30df\u30e5\u30ec\u30fc\u30b7\u30e7\u30f3\u3057\u3066\u307f\u3088\u3046\u3068\u601d\u3063\u305f\u306e\u3067\u3059\u304c\u3001\u306a\u3093\u304b\u3072\u3069\u3044\u7d50\u679c\u306b\u306a\u308a\u305d\u3046\u306a\u306e\u3067\u3084\u3081\u307e\u3057\u305f\uff08\u7b11\uff09\u3002\u3082\u3046\u5c11\u3057\u3001\u77ed\u671f\u9593\u3067\u5bfe\u6226\u5bc6\u5ea6\u304c\u9ad8\u3051\u308c\u3070\u826f\u3044\u4e88\u60f3\u3082\u3067\u304d\u305d\u3046\u3067\u3059\u3002\n16\u7bc0\u307e\u3067\u306e\u30c7\u30fc\u30bf\u306717\u7bc0\u3092\u4e88\u60f3\u3001\u304f\u3089\u3044\u306a\u3089\u5c11\u3057\u306f\u30de\u30b7\u306a\u306e\u304b\u306a??\n\u3053\u3046\u3044\u3046\u30e2\u30c7\u30ea\u30f3\u30b0\u304c\u7c21\u5358\u306b\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u3063\u305f\u3068\u3044\u3046\u306e\u306f\u3059\u3054\u3044\u3053\u3068\u3060\u3057\u3001\u3044\u308d\u3044\u308d\u697d\u3057\u3044\u3067\u3059\u306d\u3002\n\n\u306f\u3058\u3081\u306b\n=======\n\n\u5148\u65e5 [Stan\u3068R\u3067\u30d9\u30a4\u30ba\u7d71\u8a08\u30e2\u30c7\u30ea\u30f3\u30b0](https://www.amazon.co.jp/dp/4320112423) \u3068\u3044\u3046\u672c\u3092\u8aad\u307f\u307e\u3057\u3066\u3001\u7d71\u8a08\u30e2\u30c7\u30ea\u30f3\u30b0\u3092\u3084\u3063\u3066\u307f\u305f\u3044\u6c17\u6301\u3061\u306b\u306a\u308a\u307e\u3057\u305f\u3002\u3068\u3066\u3082\u826f\u3044\u672c\u3067\u3059\u306e\u3067\u30aa\u30b9\u30b9\u30e1\u3067\u3059\u3002\n\nStan\u306fR\u304b\u3089\u3060\u3051\u3067\u306a\u304f\u3001Python\u30e9\u30a4\u30d6\u30e9\u30ea\u306e[PyStan](https://pystan.readthedocs.io/en/latest/)\u304b\u3089\u4f7f\u3046\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\u4eca\u56de\u306f\u30012016\u5e74\u306e\u30b5\u30c3\u30ab\u30fcJ1\u30ea\u30fc\u30b0\u306e\u5404\u30c1\u30fc\u30e0\u306e\u5f37\u3055(\u306e\u3088\u3046\u306a\u5024)\u3092\u8a66\u5408\u7d50\u679c\u304b\u3089\u63a8\u5b9a\u3059\u308b\u30e2\u30c7\u30eb\u3092\u4f5c\u3063\u3066\u307f\u308b\u3053\u3068\u306b\u3057\u307e\u3059\u3002\n\n\u4eca\u56de\u306e\u4e3b\u306aVersion\n----------\n\n* Python 3.5.1\n* pystan==2.14.0.0\n\n\u30c7\u30fc\u30bf\u3092\u96c6\u3081\u308b\n===========\n\nJ\u30ea\u30fc\u30b0\u306e\u8a66\u5408\u7d50\u679c\u306f http://www.jleague.jp/stats/SFTD01.html \u306a\u3069\u304b\u3089\u8abf\u3079\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\u305d\u3053\u304b\u3089\u4f55\u3089\u304b\u306e\u65b9\u6cd5\u30672016\u5e74\u306e 1st\u30b9\u30c6\u30fc\u30b8\u306e \u5404\u30c1\u30fc\u30e0\u306e\u5bfe\u6226\u7d50\u679c\u306e\u96c6\u3081\u305f\u4ee5\u4e0b\u306e\u30c7\u30fc\u30bf\u304c\u3042\u308b\u3068\u3057\u307e\u3059\u3002\nhttps://gist.github.com/mokemokechicken/a26eb7230e51fba7018476f7706e5b0b\n\n|away_score|away_team|date|home_score|home_team|score|visitors|\n|-----|-----|-----|-----|-----|-----|-----|\n|1|\u540d\u53e4\u5c4b|02/27(\u571f)|0|\u78d0\u7530|0-1|14333|\n|1|\u5ddd\u5d0e\uff26|02/27(\u571f)|0|\u5e83\u5cf6|0-1|18120|\n|1|\u798f\u5ca1|02/27(\u571f)|2|\u9ce5\u6816|2-1|19762|\n|...|...|...|...|...|...|...|\n\n\n\u601d\u3046\u3053\u3068\n---------\n\n* \u30c1\u30fc\u30e0\u6570\u306f 18 \u3067\u3042\u308b\n* 1st\u30b9\u30c6\u30fc\u30b8\u306f \u5404\u30c1\u30fc\u30e0\u540c\u58eb\u304c1\u56de\u3060\u3051\u5bfe\u6226\u3059\u308b\u306e\u3067\u8a66\u5408\u6570\u306f **153**(`=18*17/2`)\n* \u30b5\u30c3\u30ab\u30fc\u3067\u306f\u30db\u30fc\u30e0\uff06\u30a2\u30a6\u30a7\u30a4\u3068\u3044\u3046\u7a0b\u3060\u3057\u3001\u5bfe\u6226\u306b\u304a\u3051\u308b\u5730\u5143\u3068\u6575\u5730\u306e\u9055\u3044\u304c\u3042\u308a\u305d\u3046\n\n\u8a66\u5408\u7d50\u679c\u304c\u751f\u307e\u308c\u308b\u30e1\u30ab\u30cb\u30ba\u30e0\u3092\u8003\u3048\u308b\n=========\n\n\u8a66\u5408\u7d50\u679c\uff08\u30b9\u30b3\u30a2\uff09\u304c\u3069\u306e\u3088\u3046\u306b\u751f\u3058\u308b\u304b\u3092\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u4eee\u5b9a\u3057\u3066\u307f\u307e\u3059\u3002\n\n* \u5404\u30c1\u30fc\u30e0\u306f **\u653b\u6483\u529b** **\u9632\u5fa1\u529b** **\u30db\u30fc\u30e0\u529b** \u3068\u3044\u3046\u306e\u304c\u3042\u308b\u3068\u3059\u308b\u3002\n* \u653b\u6483\u529b\u304c\u9ad8\u3044\u307b\u3069\u5f97\u70b9\u304c\u591a\u304f\u3001\u9632\u5fa1\u529b\u304c\u9ad8\u3044\u307b\u3069\u5931\u70b9\u304c\u5c11\u306a\u3044\n* \u30db\u30fc\u30e0\u30b2\u30fc\u30e0\u306b\u304a\u3044\u3066\u306f\u3001\u653b\u6483\u529b\u3001\u9632\u5fa1\u529b\u3068\u3082\u306b\u30a2\u30c9\u30d0\u30f3\u30c6\u30fc\u30b8\u304c\u4ed8\u4e0e\u3055\u308c\u308b(\uff1d\u30db\u30fc\u30e0\u529b)\n\n\u3068\u3057\u307e\u3059\u3002\u307e\u3042\u3001\u3053\u3053\u307e\u3067\u306f\u305d\u3093\u306a\u306b\u304a\u304b\u3057\u306a\u8a71\u3067\u306f\u306a\u3055\u305d\u3046\u3067\u3059\u3002\n\n\u6b21\u306b\u3001\u7d71\u8a08\u306e\u4e16\u754c\u306b\u5165\u3063\u3066\u8003\u3048\u3066\u307f\u307e\u3059\u3002\n\u307e\u305a\u300c\u5f97\u70b9\u300d\u306f\u30dd\u30a2\u30bd\u30f3\u5206\u5e03\u306b\u5f93\u3046\u3068\u9069\u5f53\u306b\u4eee\u5b9a\u3057\u307e\u3059\u3002\n\u3064\u307e\u308a\u3001\n\n`\u3042\u308b\u30c1\u30fc\u30e0\u306e\u3042\u308b\u8a66\u5408\u306e\u5f97\u70b9 ~ Poisson(\u305d\u306e\u30c1\u30fc\u30e0\u306e\u653b\u6483\u529b - \u5bfe\u6226\u30c1\u30fc\u30e0\u306e\u9632\u5fa1\u529b)`\n\n\u3068\u3044\u3046\u611f\u3058\u3067\u3059\u3002 \uff08\u3061\u306a\u307f\u306b `~` \u306f\u300c\u5206\u5e03\u306b\u5f93\u3046\u300d\u3068\u3044\u3046\u610f\u5473\u3067\u3059\u3002\uff09\n\u305f\u3060\u3057\u3001\u30dd\u30a2\u30bd\u30f3\u5206\u5e03\u306e\u30d1\u30e9\u30e1\u30fc\u30bf\u306f\u8ca0\u306e\u5024\u3092\u53d6\u308c\u306a\u3044\u306e\u3067\u3001`exp`\u306b\u4fbf\u5b9c\u7684\u306b\u4e57\u3063\u3051\u3066\u3001\u3055\u3089\u306b\u30db\u30fc\u30e0\u529b\u3092\u52a0\u5473\u3059\u308b\u3068\u3001\n\n```\n\u3042\u308b\u30db\u30fc\u30e0\u30c1\u30fc\u30e0\u306e\u3042\u308b\u8a66\u5408\u306e\u5f97\u70b9 ~ Poisson(exp( \n\t\t(\u30db\u30fc\u30e0\u529b + \u305d\u306e\u30db\u30fc\u30e0\u30c1\u30fc\u30e0\u306e\u653b\u6483\u529b) - \u30a2\u30a6\u30a7\u30a4\u30c1\u30fc\u30e0\u306e\u9632\u5fa1\u529b\n\t))\n```\n\n\u306b\u306a\u308b\u3068\u3057\u307e\u3059\u3002\n\u307e\u305f\u3001\u5bfe\u79f0\u7684\u306b\n\n```\n\u3042\u308b\u30db\u30fc\u30e0\u30c1\u30fc\u30e0\u306e\u3042\u308b\u8a66\u5408\u306e\u5931\u70b9 ~ Poisson(exp( \n\t\t\u30a2\u30a6\u30a7\u30a4\u30c1\u30fc\u30e0\u306e\u653b\u6483\u529b - (\u30db\u30fc\u30e0\u529b + \u305d\u306e\u30db\u30fc\u30e0\u30c1\u30fc\u30e0\u306e\u9632\u5fa1\u529b)\n\t))\n```\n\n\u3068\u3057\u307e\u3059\u3002\n\n\n\u30e2\u30c7\u30eb\u3092Stan\u3067\u8a18\u8ff0\u3059\u308b\n=============\n\n\u3053\u3093\u306a\u611f\u3058\u306b\u306a\u308a\u307e\u3057\u305f\u3002\n\n```python\nmodel_code = \"\"\"\ndata {\n    int N;  // N Games\n    int K;  // K Teams\n    int Th[N]; // Home Team ID\n    int Ta[N]; // Away Team ID\n    int Sh[N]; // Home Team score point\n    int Sa[N]; // Away Team score point\n}\n\nparameters {\n    real atk[K];\n    real def[K];\n    real home_power[K];\n    real<lower=0> sigma;\n    real<lower=0> hp_sigma;\n}\n\nmodel {\n    for (k in 1:K) {\n        atk[k] ~ normal(0, sigma);\n        def[k] ~ normal(0, sigma);\n        home_power[k] ~ normal(0, hp_sigma);\n    }\n\n    for (n in 1:N) {\n        Sh[n] ~ poisson(exp(\n            (home_power[Th[n]] + atk[Th[n]]) - \n            (def[Ta[n]])\n        ));\n\n        Sa[n] ~ poisson(exp(\n            (atk[Ta[n]]) - \n            (def[Th[n]] + home_power[Th[n]])\n        ));\n    }\n}\n\ngenerated quantities {\n    real games[K, K, 2];\n    \n    for (th in 1:K) {\n        for (ta in 1:K) {\n            games[th, ta, 1] = poisson_rng(exp((home_power[th] + atk[th]) - (def[ta])));\n            games[th, ta, 2] = poisson_rng(exp((atk[ta]) - (def[th] + home_power[th])));\n        }\n    }\n}\n\"\"\"\n```\n\n\u7c21\u5358\u306a\u8aac\u660e\n---------\nStan\u306b\u3064\u3044\u3066\u306f\u3001\u5148\u306b\u7d39\u4ecb\u3057\u305f\u672c\u304c\u3068\u3066\u3082\u53c2\u8003\u306b\u306a\u308a\u307e\u3059\u304c\u3001\u3053\u3053\u3067\u3082\u7c21\u5358\u306b\u8aac\u660e\u3092\u3057\u3066\u307f\u307e\u3059\u3002\n\n### data\u30d6\u30ed\u30c3\u30af\n```\ndata {\n    int N;  // N Games\n    int K;  // K Teams\n    int Th[N]; // Home Team ID\n    int Ta[N]; // Away Team ID\n    int Sh[N]; // Home Team score point\n    int Sa[N]; // Away Team score point\n}\n```\n\n\u3053\u306e`data`\u30d6\u30ed\u30c3\u30af\u306f\u3001\u5916\u90e8\u304b\u3089\u4e0e\u3048\u3089\u308c\u308b\u30c7\u30fc\u30bf\u3092\u5ba3\u8a00\u3057\u3066\u3044\u307e\u3059\u3002\n\u5148\u7a0b\u96c6\u3081\u305f\u30c7\u30fc\u30bf\u3092\u3053\u306e\u540d\u524d\u3067\u5f8c\u7a0b\u6ce8\u5165\u3059\u308b\u3053\u3068\u306b\u306a\u308a\u307e\u3059\u3002\n\n### parameters\u30d6\u30ed\u30c3\u30af\n```\nparameters {\n    real atk[K];\n    real def[K];\n    real home_power[K];\n    real<lower=0> sigma;\n    real<lower=0> hp_sigma;\n}\n```\n\u3053\u306e`parameters`\u30d6\u30ed\u30c3\u30af\u306f\u3001\u63a8\u5b9a\u3057\u305f\u3044\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u8a18\u8ff0\u3057\u307e\u3059\u3002\n\u4eca\u56de\u306f\u3001\u653b\u6483\u529b(atk)\u3001\u9632\u5fa1\u529b(def)\u3001\u30db\u30fc\u30e0\u529b(home_power)\u304c\u30e1\u30a4\u30f3\u3067\u3059\u3002\n`<lower=0>`\u3068\u3044\u3046\u306e\u306f\u3001\u30d1\u30e9\u30e1\u30fc\u30bf\u304c\u3068\u308a\u5f97\u308b\u7bc4\u56f2\u3092\u8868\u3057\u307e\u3059\u3002\n\n\n### model\u30d6\u30ed\u30c3\u30af\n```\nmodel {\n    for (k in 1:K) {\n        atk[k] ~ normal(0, sigma);\n        def[k] ~ normal(0, sigma);\n        home_power[k] ~ normal(0, hp_sigma);\n    }\n\n    for (n in 1:N) {\n        Sh[n] ~ poisson(exp(\n            (home_power[Th[n]] + atk[Th[n]]) - \n            (def[Ta[n]])\n        ));\n\n        Sa[n] ~ poisson(exp(\n            (atk[Ta[n]]) - \n            (def[Th[n]] + home_power[Th[n]])\n        ));\n    }\n}\n```\n\n\u3053\u306e`model`\u30d6\u30ed\u30c3\u30af\u306f\u3001\u5165\u529b\u30c7\u30fc\u30bf\u3068\u63a8\u5b9a\u3057\u305f\u3044\u30d1\u30e9\u30e1\u30fc\u30bf\u306e\u95a2\u4fc2\u3092\u78ba\u7387\u5206\u5e03\u3092\u4f7f\u3063\u3066\u8868\u73fe\u3057\u307e\u3059\u3002\n\u5148\u7a0b\u306e\u300c\u30e1\u30ab\u30cb\u30ba\u30e0\u300d\u3082\u3053\u3053\u3067\u8868\u73fe\u3057\u307e\u3059\u3002\n\u307e\u305f\u3001\u5404\u30c1\u30fc\u30e0\u306e\u653b\u6483\u529b\u3084\u9632\u5fa1\u529b\u306a\u3069\u306f\u300c\u5e73\u57470\u306e\u5206\u6563`sigma`\u306e\u6b63\u898f\u5206\u5e03\u300d\u306b\u5f93\u3046\u3068\u3044\u3046\u4eee\u5b9a\u3092\u304a\u304d\u307e\u3059\u3002\n\u3053\u306e`sigma`\u3082(\u3064\u3044\u3067\u306b)\u63a8\u5b9a\u3059\u308b\u30d1\u30e9\u30e1\u30fc\u30bf\u306b\u306a\u308a\u307e\u3059\u3002\n\u3053\u3046\u3057\u306a\u3044\u3068\u8a08\u7b97(MCMC)\u304c\u53ce\u675f\u3057\u307e\u305b\u3093\u3067\u3057\u305f(\u5168\u5024\u304c\u3044\u308d\u3093\u306a\u7bc4\u56f2\u5024\u3067\u53ce\u675f\u3057\u3066\u3057\u307e\u3046\u306e\u3067)\u3002\u307e\u3042\u300c\u3068\u308a\u3042\u3048\u305a\u3053\u306e\u8fba\u306e\u5024\u3067\u53ce\u307e\u3063\u3066\u6b32\u3057\u3044\u300d\u3068\u3044\u3046\u5e0c\u671b\u3092\u66f8\u3044\u305f\u611f\u3058\u3067\u3057\u3087\u3046\u304b\u3002\n\u9762\u767d\u3044\u306e\u304c `sigma` \u3092\u56fa\u5b9a\u306e`1`\u3068\u66f8\u304f\u3088\u308a\u3001\u63a8\u5b9a\u3055\u305b\u305f\u307b\u3046\u304c\u8a08\u7b97\u304c\u53ce\u675f\u3057\u3084\u3059\u304b\u3063\u305f\u3053\u3068\u3067\u3059(\u53ce\u675f\u3057\u305f`sigma`\u306f1\u3088\u308a\u3060\u3044\u3076\u5c0f\u3055\u304b\u3063\u305f)\u30021\u3068\u30cf\u30fc\u30c9\u30b3\u30fc\u30c9\u3057\u305f\u65b9\u304c\u7bc4\u56f2\u3092\u9650\u5b9a\u3057\u305f\u6c17\u6301\u3061\u306b\u306a\u308a\u307e\u3059\u304c\u3001\u305d\u3046\u3067\u3082\u306a\u3044\u3001\u3068\u3044\u3046\u306e\u304c\u9762\u767d\u3044\u3067\u3059\u3002\n\n### generated quantities\u30d6\u30ed\u30c3\u30af\n\n```\ngenerated quantities {\n    real games[K, K, 2];\n    \n    for (th in 1:K) {\n        for (ta in 1:K) {\n            games[th, ta, 1] = poisson_rng(exp((home_power[th] + atk[th]) - (def[ta])));\n            games[th, ta, 2] = poisson_rng(exp((atk[ta]) - (def[th] + home_power[th])));\n        }\n    }\n}\n```\n\n\u3053\u306e`generated quantities`\u30d6\u30ed\u30c3\u30af\u306f\u30aa\u30de\u30b1\u307f\u305f\u3044\u306a\u3082\u306e\u3067\u3059\u3002\n\u53ce\u675f\u3057\u305f\u5024\u3092\u4f7f\u3063\u3066\u3001\u5225\u9014\u9055\u3046\u8a08\u7b97\u3092\u3057\u3066\u304f\u308c\u308b\u6a5f\u80fd\u3067\u3059\u3002\n\u3053\u3053\u3067\u306f\u3001\u5404\u30c1\u30fc\u30e0\u306e\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u4f7f\u3063\u3066\u3001\u5404\u30c1\u30fc\u30e0\u304c\u5bfe\u6226\u3057\u305f\u3068\u304d\u306e\u8a66\u5408\u306e\u30b9\u30b3\u30a2\u3092\u30b5\u30f3\u30d7\u30ea\u30f3\u30b0\u3057\u3066\u3082\u3089\u3063\u3066\u3044\u307e\u3059\u3002\u5225\u9014Python\u5074\u3067\u8a08\u7b97\u3057\u3066\u3082\u3088\u3044\u306e\u3067\u3059\u304c\u3001\u8a08\u7b97\u30ed\u30b8\u30c3\u30af\u306fModel\u3068\u4e00\u81f4\u3055\u305b\u306a\u3044\u3068\u3044\u3051\u306a\u3044\u306e\u3067\u3001\u3053\u3053\u3067\u7ba1\u7406\u3057\u305f\u307b\u3046\u304c\u30e1\u30f3\u30c6\u30ca\u30f3\u30b9\u304c\u697d\u305d\u3046\u3067\u3059\u3002\n\n### \u305d\u306e\u4ed6\n\u4ed6\u306b `transformed parameters`\u30d6\u30ed\u30c3\u30af\u3068\u3044\u3046\u306e\u304c\u3042\u3063\u3066\u3001`data`\u3084`parameters` \u306e\u5909\u6570\u3092\u4f7f\u3063\u3066\u3001\u5225\u5909\u6570\u3092\u5b9a\u7fa9\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\u4eca\u56de\u306e `(home_power[th] + atk[th]) - (def[ta])` \u306a\u3069\u306e\u5f0f\u3082`model`\u3068`generated quantities`\u306b2\u56de\u51fa\u3066\u304d\u3066\u3044\u308b\u306e\u3067\u3001\u672c\u6765\u306f\u307e\u3068\u3081\u305f\u65b9\u304c\u826f\u3044\u306e\u3067\u3057\u3087\u3046\u304c\u3001\u3001\u3001\n\n\u30e2\u30c7\u30eb\u3068\u30c7\u30fc\u30bf\u3067\u8a08\u7b97\u3059\u308b\n==================\n\n\u3044\u304f\u3064\u304b\u4fbf\u5229\u95a2\u6570\u3092\u5b9a\u7fa9\u3057\u3066\u304a\u304f\n--------------\n\n```python\nfrom hashlib import sha256\nimport pickle\nimport time\n\nimport requests\nimport pandas as pd\nfrom pystan import StanModel\n\n\ndef stan_cache(file=None, model_code=None, model_name=None, cache_dir=\".\"):\n    \"\"\"Use just as you would `stan`\"\"\"\n    # http://pystan.readthedocs.io/en/latest/avoiding_recompilation.html#automatically-reusing-models\n\n    if file:\n        if file.startswith(\"http\"):\n            model_code = requests.get(file).text\n        else:\n            with open(file) as f:\n                model_code = f.read()\n    code_hash = sha256(model_code.encode('utf8')).hexdigest()\n    if model_name is None:\n        cache_fn = '{}/cached-model-{}.pkl'.format(cache_dir, code_hash)\n    else:\n        cache_fn = '{}/cached-{}-{}.pkl'.format(cache_dir, model_name, code_hash)\n    try:\n        sm = pickle.load(open(cache_fn, 'rb'))\n    except:\n        start_time = time.time()\n        sm = StanModel(model_code=model_code)\n        print(\"compile time: %s sec\" % (time.time() - start_time))\n        with open(cache_fn, 'wb') as f:\n            pickle.dump(sm, f)\n    return sm\n\n\ndef sampling_summary_to_df(fit4model):\n    \"\"\"\n\n    :param StanFit4model fit4model:\n    :return:\n    \"\"\"\n    s = fit4model.summary()\n    return pd.DataFrame(s[\"summary\"], columns=s['summary_colnames'], index=s['summary_rownames'])\n```\n\n`stan_cache` \u95a2\u6570\u306f\u3001stan\u306e\u30e2\u30c7\u30eb\u3092\u30ad\u30e3\u30c3\u30b7\u30e5\u3057\u305f\u308a\u3001\u30e2\u30c7\u30eb\u306e\u30b3\u30fc\u30c9\u3092HTTP\u7d4c\u7531\u3067\u3082\u53d6\u5f97\u3059\u308b\u3088\u3046\u306b\u3057\u305f\u3082\u306e\u3067\u3059\u3002\u4fbf\u5229\u3067\u3059\u3002\n\n`sampling_summary_to_df`\u95a2\u6570\u306f\u3001model\u3092fit\u3057\u305f\u7d50\u679c\u3092 Pandas\u306eDataFrame\u306b\u3057\u3066\u304f\u308c\u308b\u3082\u306e\u3067\u3059\u3002Jupyter\u306a\u3069\u3067\u4f5c\u696d\u3059\u308b\u6642\u306b\u898b\u3084\u3059\u304f\u306a\u308b\u30e1\u30ea\u30c3\u30c8\u304c\u3042\u308a\u307e\u3059\u3002\n\n\u5b9f\u884c\u3059\u308b\n--------\n\n```python\nimport numpy as np\nimport pandas as pd\n\ndf = pd.read_csv(\"https://gist.githubusercontent.com/mokemokechicken/a26eb7230e51fba7018476f7706e5b0b/raw/90e1c26e172b92d5f52d53d0591a611e0258bd2b/2016-j1league-1st.csv\")\n\nteam_list = list(sorted(set(df['away_team']) | set(df['home_team'])))\nteams = dict(zip(range(1, len(team_list)+1), team_list))\nfor k, v in list(teams.items()):\n    teams[v] = k\n    \nmodel = stan_cache(model_code=model_code) \n\nstan_input = {\n    \"N\": len(df),\n    \"K\": len(team_list),\n    \"Th\": df['home_team'].apply(lambda x: teams[x]),\n    \"Ta\": df['away_team'].apply(lambda x: teams[x]),\n    \"Sh\": df['home_score'],\n    \"Sa\": df['away_score'],\n}\n\nfitted = model.sampling(data=stan_input, seed=999)\nsampling_summary_to_df(fitted).sort_values(\"Rhat\", ascending=False)\n```\n\n### \u7d50\u679c\n\u30d1\u30e9\u30e1\u30fc\u30bf\u306e\u63a8\u5b9a\u7d50\u679c\u306e\u30b5\u30de\u30ea\u30fc\u306f\u4f8b\u3048\u3070\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\n\u66f8\u7c4d\u3067\u306f\u3001\u300c\u3053\u306e`Rhat`\u304c\u5168\u3066\u306e\u63a8\u5b9a\u30d1\u30e9\u30e1\u30fc\u30bf\u30671.1\u672a\u6e80\u306b\u306a\u308b\u3068\u307e\u3042\u8a08\u7b97\u304c\u53ce\u675f\u3057\u305f\u3068\u307f\u306a\u3057\u3066\u826f\u3044\u3060\u308d\u3046\u300d\u3068\u3044\u3046\u3053\u3068\u3067\u3059\u306e\u3067\u3001\u307e\u3042\u4e00\u5fdc\u53ce\u675f\u3057\u305f\u3068\u307f\u306a\u3059\u3053\u3068\u306b\u3057\u307e\u3059\u3002\n\u305f\u3060\u3001`n_eff`\u3068\u3044\u3046\u300c\u3061\u3083\u3093\u3068\u5024\u304c\u30b5\u30f3\u30d7\u30ea\u30f3\u30b0\u3067\u304d\u305f\u56de\u6570\u300d\u304c100\u3088\u308a\u5c0f\u3055\u3044\u306e\u306f\u3061\u3087\u3063\u3068\u5fae\u5999\u3068\u3044\u3046\u3053\u3068\uff08\u7279\u306b\u533a\u9593\u63a8\u5b9a\u3059\u308b\u3068\u304d\uff09\u306a\u306e\u3067\u3001\u5c11\u3057\u5fae\u5999\u306a\u3082\u306e\u3082\u3042\u308a\u307e\u3059\u304c\u3001\u4eca\u56de\u306f\u826f\u3057\u3068\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\n|     |mean|se_mean|sd|2.5%|25%|50%|75%|97.5%|n_eff|Rhat|\n|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|\n|lp__|-214.114891|1.542823|13.712915|-237.604900|-223.960556|-215.747425|-205.033248|-183.817981|79.0|1.049519|\n|hp_sigma|0.094069|0.005835|0.063921|0.011408|0.044970|0.081836|0.132181|0.245524|120.0|1.031258|\n|atk[12]|0.048430|0.009507|0.158794|-0.318161|-0.052664|0.052359|0.155878|0.342186|279.0|1.018430|\n|atk[16]|0.225840|0.008570|0.158951|-0.075769|0.115129|0.223274|0.330571|0.531899|344.0|1.013612|\n|sigma|0.220279|0.002456|0.056227|0.112035|0.182132|0.217550|0.255500|0.344382|524.0|1.011379|\n|...|...|...|...|...|...|...|...|...|...|...|\n\n\n\u7d50\u679c\u3092\u773a\u3081\u308b\n=========\n\n\u30c1\u30fc\u30e0\u306e\u5f37\u3055\u306e\u63a8\u5b9a\u5024\n----------\n\u30c1\u30fc\u30e0\u5225\u306b\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u56de\u53ce\u3057\u307e\u3059\u3002\n\n```python\ntk = {}\n\nparams = fitted.extract()\natks = params['atk']\ndefs = params['def']\nhome_power = params['home_power']\ngames = params['games']\n\n\nfor k, team in enumerate(team_list):\n    tk[team] = {\n            \"atk\": np.mean(atks[:, k]),\n            \"def\": np.mean(defs[:, k]),\n            \"home_power\": np.mean(home_power[:, k]),\n    }\n\ntdf = pd.DataFrame(tk).T\n```\n\n\u3068\u308a\u3042\u3048\u305a\u3001\u300c\u30db\u30fc\u30e0\u529b\u300d\u304c\u9ad8\u3044\u9806\u306b\u4e26\u3079\u3066\u307f\u307e\u3059\u3002\n\n```\ntdf.sort_values(\"home_power\", ascending=False)\n```\n\n|     |atk|def|home_power|\n|-----|-----|-----|-----|\n|\u9e7f\u5cf6|0.225840|0.217699|0.068898|\n|\u6d66\u548c|0.152638|0.063192|0.041830|\n|\u795e\u6238|0.099154|-0.163383|0.030443|\n|\u5e83\u5cf6|0.293808|-0.000985|0.029861|\n|\u540d\u53e4\u5c4b|0.130757|-0.247969|0.015849|\n|\u5ddd\u5d0e\uff26|0.312593|0.087859|0.014728|\n|\u65b0\u6f5f|0.010827|-0.146252|0.011885|\n|\u78d0\u7530|0.048430|-0.105230|0.011843|\n|\u4ed9\u53f0|0.037960|-0.150151|0.005462|\n|FC\u6771\u4eac|-0.072115|0.017485|-0.005050|\n|\uff27\u5927\u962a|0.087034|-0.033666|-0.005532|\n|\u9ce5\u6816|-0.232595|0.103412|-0.006186|\n|\u67cf|0.036172|-0.053332|-0.009568|\n|\u5927\u5bae|-0.040014|0.027842|-0.020942|\n|\u6a2a\u6d5cFM|0.059420|-0.009322|-0.021393|\n|\u798f\u5ca1|-0.185292|-0.130759|-0.026643|\n|\u7532\u5e9c|0.002608|-0.268061|-0.037079|\n|\u6e58\u5357|-0.000052|-0.184515|-0.049440|\n\n\u3068\u306a\u308a\u307e\u3057\u305f\u3002\n\u4eca\u56de\u3001\u5f37\u3055\u306e\u5e73\u5747\u304c\uff10\u306b\u306a\u3063\u3066\u3044\u308b\u306f\u305a\u306a\u306e\u3067\u30010\u3088\u308a\u9ad8\u3044\u304b\u4f4e\u3044\u304b\u3067J1\u30c1\u30fc\u30e0\u306e\u5e73\u5747\u3088\u308a\u3069\u3046\u304b\u3001\u304c\u8868\u73fe\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u306b\u306a\u308a\u307e\u3059\u3002\n\n\u3061\u306a\u307f\u306b\u30012nd\u30b9\u30c6\u30fc\u30b8\u306e\u30c7\u30fc\u30bf\u3067\u3084\u308b\u3068\u307e\u305f\u5168\u7136\u9055\u3046\u7d50\u679c\u306b\u306a\u308a\u307e\u3059\uff08\u9e7f\u5cf6\u304c\u3060\u3044\u3076\u60aa\u304f\u306a\u308b\uff09\u3002\n\u3042\u304f\u307e\u3067\u30011st\u30b9\u30c6\u30fc\u30b8\u306e\u30c7\u30fc\u30bf\u304b\u3089\u8a08\u7b97\u3057\u305f\u3089\u3053\u3046\u306a\u3063\u305f\u3068\u3044\u3046\u3060\u3051\u306a\u306e\u3067\u3001\u3042\u3057\u304b\u3089\u305a\u3002\n\n\u8003\u3048\u3066\u307f\u308c\u3070\u5f53\u305f\u308a\u524d\u306a\u306e\u3067\u3059\u304c\u30012016\u5e741st\u30b9\u30c6\u30fc\u30b8\u306e\u9806\u4f4d\u8868\u306b\u8fd1\u3044\u611f\u3058\u306b\u306a\u308a\u307e\u3059\u3002\nhttps://ja.wikipedia.org/wiki/2016%E5%B9%B4%E3%81%AEJ1%E3%83%AA%E3%83%BC%E3%82%B0#.E9.A0.86.E4.BD.8D.E8.A1.A8\n\u7279\u306b\u300c\u7dcf\u5f97\u70b9\u3001\u7dcf\u5931\u70b9\u300d\u3068\u300c\u653b\u6483\u529b\u3001\u9632\u5fa1\u529b\u300d\u306f\u6982\u306d\u76f8\u95a2\u304c\u3042\u308a\u305d\u3046\u3067\u3059\uff08\u7121\u3044\u306a\u3089\u306a\u3044\u3067\u56f0\u308a\u307e\u3059\u304c\uff09\u3002\n\n\u3055\u3044\u3054\u306b\n=========\n\n\u3053\u306e\u4e88\u6e2c\u30e2\u30c7\u30eb\u30672nd\u30b9\u30c6\u30fc\u30b8\u306eToto\u3092\u8cb7\u3063\u305f\u3089\u3069\u3046\u306a\u308b\u304b\u3001\u3001\u3001\u3068\u30b7\u30df\u30e5\u30ec\u30fc\u30b7\u30e7\u30f3\u3057\u3066\u307f\u3088\u3046\u3068\u601d\u3063\u305f\u306e\u3067\u3059\u304c\u3001\u306a\u3093\u304b\u3072\u3069\u3044\u7d50\u679c\u306b\u306a\u308a\u305d\u3046\u306a\u306e\u3067\u3084\u3081\u307e\u3057\u305f\uff08\u7b11\uff09\u3002\u3082\u3046\u5c11\u3057\u3001\u77ed\u671f\u9593\u3067\u5bfe\u6226\u5bc6\u5ea6\u304c\u9ad8\u3051\u308c\u3070\u826f\u3044\u4e88\u60f3\u3082\u3067\u304d\u305d\u3046\u3067\u3059\u3002\n16\u7bc0\u307e\u3067\u306e\u30c7\u30fc\u30bf\u306717\u7bc0\u3092\u4e88\u60f3\u3001\u304f\u3089\u3044\u306a\u3089\u5c11\u3057\u306f\u30de\u30b7\u306a\u306e\u304b\u306a??\n\n\u3053\u3046\u3044\u3046\u30e2\u30c7\u30ea\u30f3\u30b0\u304c\u7c21\u5358\u306b\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u3063\u305f\u3068\u3044\u3046\u306e\u306f\u3059\u3054\u3044\u3053\u3068\u3060\u3057\u3001\u3044\u308d\u3044\u308d\u697d\u3057\u3044\u3067\u3059\u306d\u3002\n\n\n\n\n\n\n", "tags": ["Stan", "Python", "PyStan"]}