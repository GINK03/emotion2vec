{"context": "session_start()\u3092\u4f7f\u308f\u305a\u306b\u3001FacebookSDK\u3092\u4f7f\u3063\u305f\u30ed\u30b0\u30a4\u30f3\u3092\u51e6\u7406\u3057\u307e\u3059\u3002\n\n\u74b0\u5883\n\nPHP 7.0.9\nCakePHP 3.3.2\nfacebook/php-sdk-v4 5.2.0\n\n\n\u554f\u984c\nCakePHP\u3067Facebook SDK for PHP\u306e\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u901a\u308a\u306b\u5b9f\u88c5\u3059\u308b\u3068\u3001callback\u51e6\u7406\u306e\u6642\u306bCross-site request forgery validation failed. Required param \u201cstate\u201d missing\u3068\u3044\u3046\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3057\u3066\u30ed\u30b0\u30a4\u30f3\u51e6\u7406\u3067\u304d\u307e\u305b\u3093\u3002\n\u3053\u308c\u306f\u3001loginUrl\u751f\u6210\u6642\u306bstate\u3068\u3044\u3046\u5024\u304c\u30bb\u30c3\u30b7\u30e7\u30f3\u306b\u8a2d\u5b9a\u3055\u308c\u3066\u3044\u306a\u304b\u3063\u305f\u305f\u3081\u306b\u767a\u751f\u3057\u3066\u3044\u307e\u3057\u305f\u3002\n\u3053\u308c\u3092\u89e3\u6c7a\u3059\u308b\u305f\u3081\u306b\u8abf\u3079\u3066\u307f\u308b\u3068\u3001\u307b\u3068\u3093\u3069\u306e\u5834\u5408\u306fsession_start()\u3092\u5b9f\u884c\u3057\u3066\u304b\u3089loginUrl\u751f\u6210\u2192callback\u95a2\u6570\u3068\u3059\u308c\u3070\u30a4\u30b1\u308b\u3088\uff01\u3068\u66f8\u3044\u3066\u3042\u308a\u307e\u3057\u305f\u304c\u3001\u3053\u308c\u3060\u3068\u90fd\u5ea6session_start()\u3057\u306a\u3044\u3068\u3044\u3051\u307e\u305b\u3093\u3002\u4f55\u3060\u304b\u306a\u3041\u3068\u601d\u3063\u3066\u3044\u305f\u3089\u30af\u30e9\u30b9\u3092\u4f5c\u3063\u3066\u3082\u5bfe\u5fdc\u3067\u304d\u308b\u3068\u306e\u3053\u3068\u306a\u306e\u3067\u3001\u305d\u306e\u6642\u306e\u65b9\u6cd5\u3092\u30e1\u30e2\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\n\u5bfe\u5fdc\u65b9\u6cd5\nnew Facebook\u3092\u3059\u308b\u6642\u306b\u3001persistent_data_handler\u3092\u6307\u5b9a\u3059\u308b\u3053\u3068\u3067\u3001session_start()\u3092\u3059\u308b\u3053\u3068\u306a\u304fCakePHP\u306eSession\u3092\u4f7f\u7528\u3057\u306a\u304c\u3089Facebook\u30ed\u30b0\u30a4\u30f3\u3067\u304d\u307e\u3057\u305f\u3002\n\u4f8b\u3048\u3070\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306asrc/Handler/MyFbPersistentDataHandler\u3092\u5b9f\u88c5\u3057\u307e\u3057\u305f\u3002\n\n\u5b9f\u88c5\u4f8b\n\nMyFbPersistentDataHandler.php\n<?php\n\nnamespace App\\Handler;\n\nuse Facebook\\PersistentData\\PersistentDataInterface;\n\n\nclass MyFbPersistentDataHandler implements PersistentDataInterface\n{\n    private $_session = null;\n\n    public function __construct($session)\n    {\n        $this->_session = $session;\n    }\n\n\n    public function get($key)\n    {\n        return $this->_session->read($key);\n    }\n\n    public function set($key, $value)\n    {\n        $this->_session->write($key, $value);\n    }\n}\n\n\n\n\u4f7f\u3044\u65b9\n\u3042\u3068\u306f\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u901a\u308a\u306b\u30ed\u30b0\u30a4\u30f3\u753b\u9762\u306e\u751f\u6210\u3068\u3001callback\u95a2\u6570\u306e\u51e6\u7406\u3092\u8a18\u8ff0\u3057\u307e\u3059\u3002\n\nUsersController.php\n\nuse App\\Handler\\MyFbPersistentDataHandler;\n\n...\n\n\npublic function createFbUrl(){\n    ...\n\n    $fb = new Facebook([\n        'app_id' => FACEBOOK_API_ID,\n        'app_secret' => FACEBOOK_APP_SECRET,\n        'default_graph_version' => DEFAULT_GRAPH_VERSION,\n        'persistent_data_handler' => new MyFbPersistentDataHandler($this->request->session())\n    ]);\n    $helper = $fb->getRedirectLoginHelper();\n\n    ...\n}\n\n\npublic function fbLoginCallback(){\n    ...\n\n    $fb = new Facebook([\n        'app_id' => FACEBOOK_API_ID,\n        'app_secret' => FACEBOOK_APP_SECRET,\n        'default_graph_version' => DEFAULT_GRAPH_VERSION,\n        'persistent_data_handler' => new MyFbPersistentDataHandler($this->request->session())\n    ]);\n    $helper = $fb->getRedirectLoginHelper();\n\n    ...\n}\n\n\n\u3053\u308c\u3067Facebook\u30ed\u30b0\u30a4\u30f3\u3067\u304d\u307e\u3057\u305f\u3002\n\n\u53c2\u8003\n\n\nFuelPHP\u3067Facebook SDK for PHP v5\u3092\u4f7f\u3046 \nThe persistent data handler interface for the Facebook SDK for PHP\nFacebook\u30ed\u30b0\u30a4\u30f3\u306e\u4f8b\n\u30b0\u30e9\u30d5API\u3092\u4f7f\u3063\u305f\u30e6\u30fc\u30b6\u30fc\u30d7\u30ed\u30d5\u30a3\u30fc\u30eb\u306e\u53d6\u5f97\n\n\n`session_start()`\u3092\u4f7f\u308f\u305a\u306b\u3001FacebookSDK\u3092\u4f7f\u3063\u305f\u30ed\u30b0\u30a4\u30f3\u3092\u51e6\u7406\u3057\u307e\u3059\u3002\n\n# \u74b0\u5883\n- PHP 7.0.9\n- \bCakePHP 3.3.2\n- facebook/php-sdk-v4 5.2.0\n\n# \u554f\u984c\nCakePHP\u3067Facebook SDK for PHP\u306e\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u901a\u308a\u306b\u5b9f\u88c5\u3059\u308b\u3068\u3001callback\u51e6\u7406\u306e\u6642\u306b`Cross-site request forgery validation failed. Required param \u201cstate\u201d missing`\u3068\u3044\u3046\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3057\u3066\u30ed\u30b0\u30a4\u30f3\u51e6\u7406\u3067\u304d\u307e\u305b\u3093\u3002\n\n\u3053\u308c\u306f\u3001loginUrl\u751f\u6210\u6642\u306b`state`\u3068\u3044\u3046\u5024\u304c\u30bb\u30c3\u30b7\u30e7\u30f3\u306b\u8a2d\u5b9a\u3055\u308c\u3066\u3044\u306a\u304b\u3063\u305f\u305f\u3081\u306b\u767a\u751f\u3057\u3066\u3044\u307e\u3057\u305f\u3002\n\n\u3053\u308c\u3092\u89e3\u6c7a\u3059\u308b\u305f\u3081\u306b\u8abf\u3079\u3066\u307f\u308b\u3068\u3001\u307b\u3068\u3093\u3069\u306e\u5834\u5408\u306f`session_start()`\u3092\u5b9f\u884c\u3057\u3066\u304b\u3089loginUrl\u751f\u6210\u2192callback\u95a2\u6570\u3068\u3059\u308c\u3070\u30a4\u30b1\u308b\u3088\uff01\u3068\u66f8\u3044\u3066\u3042\u308a\u307e\u3057\u305f\u304c\u3001\u3053\u308c\u3060\u3068\u90fd\u5ea6`session_start()`\u3057\u306a\u3044\u3068\u3044\u3051\u307e\u305b\u3093\u3002\u4f55\u3060\u304b\u306a\u3041\u3068\u601d\u3063\u3066\u3044\u305f\u3089\u30af\u30e9\u30b9\u3092\u4f5c\u3063\u3066\u3082\u5bfe\u5fdc\u3067\u304d\u308b\u3068\u306e\u3053\u3068\u306a\u306e\u3067\u3001\u305d\u306e\u6642\u306e\u65b9\u6cd5\u3092\u30e1\u30e2\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\n# \u5bfe\u5fdc\u65b9\u6cd5\n`new Facebook`\u3092\u3059\u308b\u6642\u306b\u3001`persistent_data_handler`\u3092\u6307\u5b9a\u3059\u308b\u3053\u3068\u3067\u3001`session_start()`\u3092\u3059\u308b\u3053\u3068\u306a\u304fCakePHP\u306eSession\u3092\u4f7f\u7528\u3057\u306a\u304c\u3089Facebook\u30ed\u30b0\u30a4\u30f3\u3067\u304d\u307e\u3057\u305f\u3002\n\n\u4f8b\u3048\u3070\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306a`src/Handler/MyFbPersistentDataHandler`\u3092\u5b9f\u88c5\u3057\u307e\u3057\u305f\u3002\n\n## \u5b9f\u88c5\u4f8b\n```php:MyFbPersistentDataHandler.php\n<?php\n\nnamespace App\\Handler;\n\nuse Facebook\\PersistentData\\PersistentDataInterface;\n\n\nclass MyFbPersistentDataHandler implements PersistentDataInterface\n{\n    private $_session = null;\n\n    public function __construct($session)\n    {\n        $this->_session = $session;\n    }\n\n\n    public function get($key)\n    {\n        return $this->_session->read($key);\n    }\n\n    public function set($key, $value)\n    {\n        $this->_session->write($key, $value);\n    }\n}\n```\n\n\n## \u4f7f\u3044\u65b9\n\u3042\u3068\u306f\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u901a\u308a\u306b\u30ed\u30b0\u30a4\u30f3\u753b\u9762\u306e\u751f\u6210\u3068\u3001callback\u95a2\u6570\u306e\u51e6\u7406\u3092\u8a18\u8ff0\u3057\u307e\u3059\u3002\n\n```php:UsersController.php\n\nuse App\\Handler\\MyFbPersistentDataHandler;\n\n...\n\n\npublic function createFbUrl(){\n    ...\n    \n    $fb = new Facebook([\n        'app_id' => FACEBOOK_API_ID,\n        'app_secret' => FACEBOOK_APP_SECRET,\n        'default_graph_version' => DEFAULT_GRAPH_VERSION,\n        'persistent_data_handler' => new MyFbPersistentDataHandler($this->request->session())\n    ]);\n    $helper = $fb->getRedirectLoginHelper();\n    \n    ...\n}\n\n\npublic function fbLoginCallback(){\n    ...\n    \n    $fb = new Facebook([\n        'app_id' => FACEBOOK_API_ID,\n        'app_secret' => FACEBOOK_APP_SECRET,\n        'default_graph_version' => DEFAULT_GRAPH_VERSION,\n        'persistent_data_handler' => new MyFbPersistentDataHandler($this->request->session())\n    ]);\n    $helper = $fb->getRedirectLoginHelper();\n    \n    ...\n}\n```\n\n\u3053\u308c\u3067Facebook\u30ed\u30b0\u30a4\u30f3\u3067\u304d\u307e\u3057\u305f\u3002\n\n# \u53c2\u8003\n- [FuelPHP\u3067Facebook SDK for PHP v5\u3092\u4f7f\u3046](http://case-k.com/blog/2015/08/04/fuelphp%E3%81%A7facebook-sdk-for-php-v5%E3%82%92%E4%BD%BF%E3%81%86/) \n- [The persistent data handler interface for the Facebook SDK for PHP](https://developers.facebook.com/docs/php/PersistentDataInterface/5.0.0)\n- [Facebook\u30ed\u30b0\u30a4\u30f3\u306e\u4f8b](https://developers.facebook.com/docs/php/howto/example_facebook_login)\n- [\u30b0\u30e9\u30d5API\u3092\u4f7f\u3063\u305f\u30e6\u30fc\u30b6\u30fc\u30d7\u30ed\u30d5\u30a3\u30fc\u30eb\u306e\u53d6\u5f97](https://developers.facebook.com/docs/php/howto/example_retrieve_user_profile)\n", "tags": ["cakephp3", "Facebook", "PHP"]}