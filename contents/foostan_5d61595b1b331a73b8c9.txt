{"context": " More than 1 year has passed since last update.\n\n\u306f\u3058\u3081\u306b\n\u6700\u8fd1Serf\u306b\u95a2\u3059\u308b\u8a71\u984c\u304c\u76db\u308a\u4e0a\u304c\u3063\u3066\u304d\u3066\u3044\u3066\u3001Serf\u3092\u7d39\u4ecb\u3057\u305f\u8cc7\u6599\u304c\u30d6\u30af\u30de\u6570\u3092\u305d\u308c\u306a\u308a\u306b\u7a3c\u3044\u3067\u3044\u307e\u3059\u3002\n\nSerf\u304c\u9762\u767d\u3044\u3068\u4ffa\u306e\u4e2d\u3067\u8a71\u984c\u306bwwwwww \u3010\u6539\u8a02\u7248\u3011\nSerf \u3068\u3044\u3046 Orchestration \u30c4\u30fc\u30eb #immutableinfra\n\n\u305d\u3053\u3067\u672c\u30a8\u30f3\u30c8\u30ea\u30fc\u3067\u306f\u3001\n\nSerf\u3063\u3066\u4f55\uff1f\nSerf\u3063\u3066\u3069\u3046\u3084\u3063\u3066\u4f7f\u3046\u306e\uff1f\nSerf\u3063\u3066\u4f55\u304c\u51fa\u6765\u308b\u306e\uff1f\n\n\u306a\u3069\u3068\u601d\u3063\u3066\u3044\u308b\u65b9\u3092\u5bfe\u8c61\u3068\u3057\u3066\u3001Serf\u306e\u4f7f\u3044\u65b9\u3092\u7d39\u4ecb\u3057\u305f\u3044\u3068\u601d\u3044\u307e\u3059\u3002\n\nSerf\u3068\u306f\nSerf ( http://www.serfdom.io/ )\u3068\u306f\u3001\u30b5\u30fc\u30d0\u30d7\u30ed\u30d3\u30b8\u30e7\u30cb\u30f3\u30b0\u306b\u304a\u3051\u308b\u3001\u30aa\u30fc\u30b1\u30b9\u30c8\u30ec\u30fc\u30b7\u30e7\u30f3\u30ec\u30a4\u30e4\u30fc\u3067\u5229\u7528\u3059\u308b\u305f\u3081\u306e\u30c4\u30fc\u30eb\u3067\u3059\u3002\n\u30aa\u30fc\u30b1\u30b9\u30c8\u30ec\u30fc\u30b7\u30e7\u30f3\u30ec\u30a4\u30e4\u30fc\u3067\u306f\n\n\u30b5\u30fc\u30d0\u3092\u5197\u9577\u5316\u3055\u305b\u305f\u308a\n\u969c\u5bb3\u3092\u691c\u77e5\u3057\u305f\u3089\u30b5\u30fc\u30d0\u3092\u629c\u304d\u5dee\u3057\u3057\u305f\u308a\n\n\u306a\u3069\u306e\u64cd\u4f5c\u3092\u884c\u3044\u307e\u3059\u3002\nSerf\u306f\u30af\u30e9\u30b9\u30bf\u5185\u306e\u30b5\u30fc\u30d0\u306e\u72b6\u614b\u3092\u76e3\u8996\u3057\u3001\u3053\u308c\u3089\u306e\u64cd\u4f5c\u3092\u767a\u706b\u3055\u305b\u308b\u305f\u3081\u306e\u30c4\u30fc\u30eb\u3067\u3059\u3002\n\u767a\u706b\u306e\u30bf\u30a4\u30df\u30f3\u30b0\u306f\n\n\u30af\u30e9\u30b9\u30bf\u306b\u65b0\u305f\u306a\u30b5\u30fc\u30d0\u304c\u52a0\u308f\u308b\n\u30af\u30e9\u30b9\u30bf\u5185\u306e\u30b5\u30fc\u30d0\u304c\u30c0\u30a6\u30f3\u3059\u308b\n\n\u306a\u3069\u69d8\u3005\u3067\u3059(\u8a73\u3057\u304f\u306f\u5f8c\u3067\u8aac\u660e\u3057\u307e\u3059)\u3002\n\u306a\u304a\u30d7\u30ed\u30d3\u30b8\u30e7\u30cb\u30f3\u30b0\u306b\u3064\u3044\u3066\u306f\u4e0b\u8a18\u8cc7\u6599\u304c\u53c2\u8003\u306b\u306a\u308a\u307e\u3059\u3002\n\nDevelopers Summit 2014 \u3067\u300c\u30b5\u30fc\u30d0\u30d7\u30ed\u30d3\u30b8\u30e7\u30cb\u30f3\u30b0\u306e\u3053\u308c\u307e\u3067\u3068\u3053\u308c\u304b\u3089\u300d\u3068\u3044\u3046\u767a\u8868\u3092\u884c\u3044\u307e\u3057\u305f\n\n\nSerf\u306e\u5b9f\u884c\u74b0\u5883\u3092\u6574\u3048\u308b\nSerf\u3092\u691c\u8a3c\u3059\u308b\u305f\u3081\u306b\u306f\u8907\u6570\u53f0\u306e\u30de\u30b7\u30f3\u304c\u5fc5\u8981\u306b\u306a\u308a\u307e\u3059\u3002\n\u6700\u4f4e2\u53f0\u3042\u308c\u3070\u691c\u8a3c\u306f\u53ef\u80fd\u3067\u3059\u304c\u300110\u6570\u53f0\u3042\u3063\u305f\u307b\u3046\u304c\u90fd\u5408\u304c\u3088\u304f\u3001\u305d\u308c\u3089\u3092\u52b9\u7387\u3088\u304f\u7528\u610f\u3059\u308b\u306b\u306fDocker\u304c\u6700\u9069\u3067\u3059\u3002\n\u307e\u305f\u3001Docker\u3092\u52d5\u304b\u3059\u74b0\u5883\u306fVagrantBox\u3067\u516c\u958b( https://vagrantcloud.com/3scale/docker )\u3055\u308c\u3066\u3044\u308b\u306e\u3067\u3001\u305d\u306eBox\u3092\u5229\u7528\u3057\u3066\u30b5\u30af\u30c3\u3068\u7528\u610f\u3057\u307e\u3059(Docker\u304c\u52d5\u3051\u3070\u3069\u3093\u306a\u74b0\u5883\u3067\u3082\u5927\u4e08\u592b\u3067\u3059)\u3002\n\nDocker\u306e\u52d5\u4f5c\u74b0\u5883\u306e\u6574\u5099\nVagrantfile\u3092\u7528\u610f\u3057\u305f\u306e\u3067 git clone \u3057\u3066 vagrant up \u3059\u308b\u3060\u3051\u3067\u6574\u3044\u307e\u3059\u3002\n$ git clone git@github.com:foostan/vagrant-docker.git\n$ cd vagrant-docker\n$ vagrant up\n\n\u305f\u3060\u3001\u4eca\u56de\u5229\u7528\u3057\u305fBox 3scale/docker \u306e\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u306b\u7d50\u69cb\u6642\u9593\u304c\u304b\u304b\u308b\u306e\u3067\u3001\u624b\u6301\u3061\u306eBox\u3092\u5229\u7528\u3057\u3066https://www.docker.io/gettingstarted/ \u3092\u53c2\u8003\u306b\u3057\u3066Docker\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u305f\u65b9\u304c\u65e9\u3044\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u3002\n\nSerf\u30a4\u30e1\u30fc\u30b8\u306e\u4f5c\u6210\nDocker\u3067Serf\u7528\u306e\u30a4\u30e1\u30fc\u30b8\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\nSerf\u7528\u306eDockerfile\u3092\u7528\u610f\u3057\u305f\u306e\u3067\u4e0b\u8a18\u306e\u3088\u3046\u306b\u5b9f\u884c\u3059\u308b\u3060\u3051\u3067\u30b3\u30f3\u30c6\u30ca\u304c\u51fa\u6765\u4e0a\u304c\u308a\u307e\u3059(\u30b3\u30f3\u30c6\u30ca\u306e\u540d\u524d\u306f\u9069\u5b9c\u8a2d\u5b9a\u3057\u3066\u304f\u3060\u3055\u3044)\u3002\n$ vagrant ssh\nvagrant@ubuntu-12:~$ cd /vagrant/serf\nvagrant@ubuntu-12:/vagrant/serf$ docker build -t foostan/serf .\n\n\nSerf\u30b3\u30f3\u30c6\u30ca\u306e\u8d77\u52d5\n\u30b3\u30f3\u30c6\u30ca\u306e\u8d77\u52d5\u6642\u306bSerf\u3092\u8d77\u52d5\u3059\u308b\u3088\u3046\u306b\u3057\u3066\u3082\u3044\u3044\u306e\u3067\u3059\u304c\u3001Serf\u306e\u691c\u8a3c\u3092\u3057\u305f\u3044\u306e\u3067\u3001\u4eca\u56de\u306f\u3042\u3048\u3066 /bin/bash \u3067\u30b3\u30f3\u30bd\u30fc\u30eb\u306b\u5165\u308a\u307e\u3059(Dockerfile\u3067\u3082\u3042\u3048\u3066ENTRYPOINT\u3092\u8a2d\u5b9a\u3057\u3066\u3044\u306a\u3044)\u3002\nvagrant@ubuntu-12:/vagrant/serf$ docker run -i -t foostan/serf /bin/bash\n\n\nSerf\u306e\u4f7f\u3044\u65b9\n\n\u6e96\u5099\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3057\u3001\u30b3\u30f3\u30bd\u30fc\u30eb\u306b\u5165\u308b\u3068Serf\u30b3\u30de\u30f3\u30c9\u304c\u4f7f\u3048\u308b\u72b6\u614b\u306b\u306a\u3063\u3066\u3044\u308b\u3068\u601d\u3044\u307e\u3059\u3002\nroot@node1:/# serf\nusage: app [--version] [--help] <command> [<args>]\n\nAvailable commands are:\n    agent           Runs a Serf agent\n    event           Send a custom event through the Serf cluster\n    force-leave     Forces a member of the cluster to enter the \"left\" state\n    join            Tell Serf agent to join cluster\n    keygen          Generates a new encryption key\n    leave           Gracefully leaves the Serf cluster and shuts down\n    members         Lists the members of a Serf cluster\n    monitor         Stream logs from a Serf agent\n    query           Send a query to the Serf cluster\n    reachability    Test network reachability\n    tags            Modify tags of a running Serf agent\n    version         Prints the Serf version\n\n\u3053\u3053\u304b\u3089\u306f\u8907\u6570\u306eSerf\u3092\u5229\u7528\u3057\u3066\u691c\u8a3c\u3057\u305f\u3044\u305f\u3081\u3001\u65b0\u3057\u3044\u30a6\u30a4\u30f3\u30c9\u30a6\u3067\u3082\u3046\u4e00\u53f0Serf\u306e\u30b3\u30f3\u30c6\u30ca\u3092\u7acb\u3061\u4e0a\u3052\u3066\u30b3\u30f3\u30bd\u30fc\u30eb\u306b\u5165\u3063\u3066\u4e0b\u3055\u3044\u3002\n$ vagrant ssh\nvagrant@ubuntu-12:~$ docker run -i -t foostan/serf /bin/bash\nroot@node2:/#\n\n\u3053\u3053\u3067\u306f\u308f\u304b\u308a\u3084\u3059\u3044\u3088\u3046\u306b\u3001\n- root@node1\n- root@node2\n\u3068\u8868\u8a18\u3057\u3066\u3042\u308a\u307e\u3059\u3002\n\nserf agent \u3067\u30af\u30e9\u30b9\u30bf\u3092\u5f62\u6210\u3059\u308b\nnode1\u304a\u3088\u3073node2\u3067\nserf agent -discover=cluster1 &\n\n\u3092\u5b9f\u884c\u3057\u3066\u4e0b\u3055\u3044\u3002\n\u4ee5\u524d\u306f1\u53f0\u76ee\u3092 serf agent \u3067\u8d77\u52d5\u3057\u30012\u53f0\u76ee\u4ee5\u964d\u306f\u8d77\u52d5\u4e2d\u306e\u30de\u30b7\u30f3\u306b\u5bfe\u3057\u3066 serf join -join \u63a5\u7d9a\u5148\u306eIP\u30a2\u30c9\u30ec\u30b9 \u3067\u30af\u30e9\u30b9\u30bf\u3092\u5f62\u6210\u3059\u308b\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u307e\u3057\u305f\u304c(SPOF\u3068\u306a\u3063\u3066\u3044\u305f\u304c)\u30010.4.5 \u304b\u3089 -discover \u30aa\u30d7\u30b7\u30e7\u30f3\u3092\u5229\u7528\u3059\u308b\u3053\u3068\u30672\u53f0\u76ee\u4ee5\u964d\u3082\u540c\u3058\u30b3\u30de\u30f3\u30c9\u3067\u30af\u30e9\u30b9\u30bf\u3092\u5f62\u6210\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3057\u305f\u3002\n\u3061\u306a\u307f\u306b\u3001serf agent \u30b3\u30de\u30f3\u30c9\u306f\u30d5\u30a9\u30a2\u30b0\u30e9\u30a6\u30f3\u30c9\u3067\u5b9f\u884c\u3055\u308c\u3066\u30b3\u30f3\u30bd\u30fc\u30eb\u304c\u596a\u308f\u308c\u3061\u3083\u3046\u306e\u3067 & \u3092\u3064\u3051\u3066\u3042\u308a\u307e\u3059\u3002\n\u4ee5\u4e0b\u3001\u5b9f\u884c\u7d50\u679c\u3067\u3059\u3002\nroot@node1:/# serf agent -discover=cluster1 &\n[1] 77\n==> Starting Serf agent...\n==> Starting Serf agent RPC...\n==> Serf agent running!\n         Node name: 'node1'\n         Bind addr: '0.0.0.0:7946'\n          RPC addr: '127.0.0.1:7373'\n         Encrypted: false\n          Snapshot: false\n           Profile: lan\n      mDNS cluster: cluster1\n\n==> Log data will now stream in as it occurs:\n\n    2014/04/07 16:52:43 [INFO] agent: Serf agent starting\n    2014/04/07 16:52:43 [INFO] serf: EventMemberJoin: node1 172.17.0.2\n    2014/04/07 16:52:43 [INFO] agent: joining: [172.17.0.2:7946] replay: false\n    2014/04/07 16:52:43 [INFO] agent: joined: 1 Err: <nil>\n    2014/04/07 16:52:43 [INFO] agent.mdns: Joined 1 hosts\n    2014/04/07 16:52:44 [INFO] agent: Received event: member-join\n\nroot@node2:/# serf agent -discover=cluster1 &\n[1] 17\n==> Starting Serf agent...\n==> Starting Serf agent RPC...\n==> Serf agent running!\n         Node name: 'node2'\n         Bind addr: '0.0.0.0:7946'\n          RPC addr: '127.0.0.1:7373'\n         Encrypted: false\n          Snapshot: false\n           Profile: lan\n      mDNS cluster: cluster1\n\n==> Log data will now stream in as it occurs:\n\n    2014/04/07 16:54:10 [INFO] agent: Serf agent starting\n    2014/04/07 16:54:10 [INFO] serf: EventMemberJoin: node2 172.17.0.3\n    2014/04/07 16:54:11 [INFO] agent: joining: [172.17.0.2:7946 172.17.0.3:7946] replay: false\n    2014/04/07 16:54:11 [INFO] serf: EventMemberJoin: node2 172.17.0.2\n    2014/04/07 16:54:11 [INFO] agent: joined: 2 Err: <nil>\n    2014/04/07 16:54:11 [INFO] agent.mdns: Joined 2 hosts\n    2014/04/07 16:54:12 [INFO] agent: Received event: member-join\n\nserf members \u3067\u78ba\u8a8d\u3057\u3066\u307f\u307e\u3059\u3002\nroot@node1:/# serf members\n    2014/04/07 17:06:24 [INFO] agent.ipc: Accepted client: 127.0.0.1:42530\nnode1  172.17.0.2:7946  alive\nnode2  172.17.0.3:7946  alive\n\n\u7121\u4e8b\u306b\u30af\u30e9\u30b9\u30bf\u304c\u5f62\u6210\u3055\u308c\u305f\u3053\u3068\u304c\u78ba\u8a8d\u3067\u304d\u307e\u3057\u305f\u3002\n\nserf leave \u3067\u30af\u30e9\u30b9\u30bf\u304b\u3089\u629c\u3051\u308b\nserf learve \u30b3\u30de\u30f3\u30c9\u3067\u6240\u5c5e\u3057\u3066\u3044\u308b\u30af\u30e9\u30b9\u30bf\u304b\u3089\u629c\u3051\u307e\u3059\u3002\nroot@node1:/# serf leave\n    2014/04/07 17:10:30 [INFO] agent.ipc: Accepted client: 127.0.0.1:42549\n    2014/04/07 17:10:30 [INFO] agent.ipc: Graceful leave triggered\n    2014/04/07 17:10:30 [INFO] agent: requesting graceful leave from Serf\n    2014/04/07 17:10:31 [INFO] serf: EventMemberLeave: node1 172.17.0.2\nGraceful leave complete\n    2014/04/07 17:10:32 [INFO] agent: requesting serf shutdown\n    2014/04/07 17:10:32 [INFO] agent: shutdown complete\n\nnode2\u5074\u3067 serf members \u3067node1\u304c\u629c\u3051\u305f\u3053\u3068\u3092\u78ba\u8a8d\u3057\u3066\u307f\u307e\u3059\u3002\nroot@node2:/# serf members\n    2014/04/07 17:11:10 [INFO] agent.ipc: Accepted client: 127.0.0.1:42550\nnode2  172.17.0.3:7946  alive\nnode1  172.17.0.2:7946  left\n\n\n\u30a4\u30d9\u30f3\u30c8\u30cf\u30f3\u30c9\u30e9\u306b\u3064\u3044\u3066\nSerf\u3067\u306f\u4ee5\u4e0b\u306e\u30a4\u30d9\u30f3\u30c8\u30cf\u30f3\u30c9\u30e9\u304c\u7528\u610f\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n\nmember-join: \u30e1\u30f3\u30d0\u30fc\u304c\u52a0\u308f\u3063\u305f\u3068\u304d\nmember-leave: \u30e1\u30f3\u30d0\u30fc\u304c\u629c\u3051\u305f\u3068\u304d\nmember-failed: \u30e1\u30f3\u30d0\u30fc\u3092\u898b\u5931\u3063\u305f\u3068\u304d(\u758e\u901a\u78ba\u8a8d\u306b\u5931\u6557\u305f\u3068\u304d)\nmember-update: \u30e1\u30f3\u30d0\u30fc\u306e\u60c5\u5831\u304c\u66f4\u65b0\u3055\u308c\u305f\u3068\u304d\nmember-reap: \u30e1\u30f3\u30d0\u30fc\u3092\u30ea\u30b9\u30c8\u304b\u3089\u524a\u9664\u3057\u305f\u3068\u304d(member-leave \u307e\u305f\u306fmember-failed \u304b\u3089\u4e00\u5b9a\u6642\u9593\u7d4c\u904e\u3057\u305f\u3068\u304d)\nuser: \u4efb\u610f\u306e\u30e6\u30fc\u30b6\u30a4\u30d9\u30f3\u30c8\u304c\u767a\u884c\u3055\u308c\u305f\u3068\u304d\nquery: \u4efb\u610f\u306e\u30af\u30a8\u30ea\u304c\u767a\u884c\u3055\u308c\u305f\u3068\u304d\n\nmember-join \u3084 member-leave \u306b\u3064\u3044\u3066\u306f\u524d\u306e\u7bc0\u3067\u65e2\u306b\u51fa\u3066\u304d\u3066\u3044\u3066\u3001\n2014/04/07 17:10:32 [INFO] agent: Received event: member-leave\n\n\u3084\n2014/04/07 16:55:12 [INFO] agent: Received event: member-join\n\n\u304c\u3001\u30a4\u30d9\u30f3\u30c8\u30cf\u30f3\u30c9\u30e9\u304c\u547c\u3070\u308c\u305f\u30bf\u30a4\u30df\u30f3\u30b0\u3068\u306a\u308a\u307e\u3059\u3002\n\n\u30a4\u30d9\u30f3\u30c8\u30cf\u30f3\u30c9\u30e9\u3067\u4efb\u610f\u306e\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u5b9f\u884c\u3059\u308b\nSerf\u3067\u306f\u4e0b\u8a18\u306e\u3088\u3046\u306b\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u6307\u5b9a\u3059\u308b\u3053\u3068\u3067\u3001\u30a4\u30d9\u30f3\u30c8\u30cf\u30f3\u30c9\u30e9\u306e\u767a\u706b\u6642\u306b\u30b9\u30af\u30ea\u30d7\u30c8\u304c\u5b9f\u884c\u3055\u308c\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\n\u203b \u30a4\u30d9\u30f3\u30c8\u30cf\u30f3\u30c9\u30e9\u306e\u6a19\u6e96\u51fa\u529b\u306f\u3001-log-level=debug \u3067\u306a\u3044\u3068\u8868\u793a\u3055\u308c\u306a\u3044\u305f\u3081\u3001-log-level \u3092\u6307\u5b9a\u3057\u3066\u3044\u307e\u3059\u3002\nserf agent -discover=cluster1  -log-level=debug\u3000-event-handler=./handle.sh\n\nhandle.sh\u306e\u5185\u5bb9\u306f\u4ee5\u4e0b\u306e\u3068\u304a\u308a\u3067\u3059\u3002\n#!/bin/bash\n\necho\necho \"SERF_EVENT:       ${SERF_EVENT}\"\necho \"SERF_SELF_NAME:   ${SERF_SELF_NAME}\"\necho \"SERF_SELF_ROLE:   ${SERF_SELF_ROLE}\"\necho \"SERF_SELF_TAG:    ${SERF_SELF_TAG}\"\necho \"SERF_TAG_ROLE:    ${SERF_TAG_ROLE}\"\necho \"SERF_USER_EVENT:  ${SERF_USER_EVENT}\"\necho \"SERF_USER_LTIME:  ${SERF_USER_LTIME}\"\necho \"SERF_QUERY_NAME:  ${SERF_QUERY_NAME}\"\necho \"SERF_QUERY_LTIME: ${SERF_QUERY_LTIME}\"\nwhile read line; do\n  echo \"event data:       ${line}\"\ndone\n\n\u30a4\u30d9\u30f3\u30c8\u30cf\u30f3\u30c9\u30e9\u306b\u3088\u3063\u3066\u547c\u3070\u308c\u308b\u30b9\u30af\u30ea\u30d7\u30c8\u5185\u3067\u306f\u3001\u4e0a\u8a18\u306e\u3088\u3046\u306a\u74b0\u5883\u5909\u6570\u304c\u4f7f\u7528\u3067\u304d\u307e\u3059\u3002\n\u74b0\u5883\u5909\u6570\u306e\u8a73\u7d30\u306b\u3064\u3044\u3066\u306f\u3000http://www.serfdom.io/docs/agent/event-handlers.html \u3092\u53c2\u7167\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\u4e0a\u8a18\u30b9\u30af\u30ea\u30d7\u30c8\u304c\u30a4\u30d9\u30f3\u30c8\u30cf\u30f3\u30c9\u30e9\u306b\u547c\u3070\u308c\u308b\u3068\u4e0b\u8a18\u306e\u3088\u3046\u306b\u5b9f\u884c\u3055\u308c\u307e\u3059\u3002\nmember-join \u30a4\u30d9\u30f3\u30c8\n--- \u7701\u7565 ---\n\n    2014/04/08 15:05:53 [INFO] agent: Received event: member-join\n    2014/04/08 15:05:53 [DEBUG] agent: Event 'member-join' script output:\nSERF_EVENT:       member-join\nSERF_SELF_NAME:   node1\nSERF_SELF_ROLE:\nSERF_SELF_TAG:\nSERF_TAG_ROLE:\nSERF_USER_EVENT:\nSERF_USER_LTIME:\nSERF_QUERY_NAME:\nSERF_QUERY_LTIME:\nevent data:       node2 172.17.0.3\n\nmember-leave \u30a4\u30d9\u30f3\u30c8\n--- \u7701\u7565 ---\n\n    2014/04/08 15:05:59 [INFO] serf: EventMemberLeave: node2 172.17.0.3\n    2014/04/08 15:06:00 [INFO] agent: Received event: member-leave\n    2014/04/08 15:06:00 [DEBUG] agent: Event 'member-leave' script output:\nSERF_EVENT:       member-leave\nSERF_SELF_NAME:   node1\nSERF_SELF_ROLE:\nSERF_SELF_TAG:\nSERF_TAG_ROLE:\nSERF_USER_EVENT:\nSERF_USER_LTIME:\nSERF_QUERY_NAME:\nSERF_QUERY_LTIME:\nevent data:       node2 172.17.0.3\n\nSERF_EVENT\u3084SERF_SELF_NAME\u304c\u53d6\u5f97\u3067\u304d\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308a\u307e\u3059\u3002\n\u3055\u3089\u306b\u3001\u6a19\u6e96\u5165\u529b\u3068\u3057\u3066\u30db\u30b9\u30c8\u540d\u3068IP\u30a2\u30c9\u30ec\u30b9\u304c\u5165\u529b\u3055\u308c\u308b\u3053\u3068\u304c\u78ba\u8a8d\u3067\u304d\u307e\u3059(event data: \u3068\u3057\u3066\u8868\u793a)\u3002\n\n\u30a4\u30d9\u30f3\u30c8\u30cf\u30f3\u30c9\u30e9\u6bce\u306b\u5225\u3005\u306e\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u5b9f\u884c\u3059\u308b\n\u305d\u308d\u305d\u308d\u5f15\u6570\u304c\u591a\u304f\u306a\u3063\u3066\u304d\u305f\u306e\u3067\u3001\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092\u8a18\u8ff0\u3057\u305fJson\u3092\u8aad\u307f\u8fbc\u307e\u305b\u3066serf\u3092\u5b9f\u884c\u3057\u3066\u307f\u307e\u3059\u3002\n\u4ee5\u4e0b\u306e\u69d8\u306ajson\u30d5\u30a1\u30a4\u30eb\u304c /serf.json \u3068\u3057\u3066Docker\u306e\u30b3\u30f3\u30c6\u30ca\u8d77\u52d5\u6642\u306b\u914d\u7f6e\u3057\u3066\u3042\u308a\u307e\u3059\u3002\n{\n  \"tags\": {\n    \"role\": \"web\"\n  },\n  \"discover\": \"app\",\n\n  \"encrypt_key\": \"cg8StVXbQJ0gPvMd9o7yrg==\",\n  \"log_level\": \"debug\",\n\n  \"event_handlers\": [\n    \"member-join=./member-join.sh\",\n    \"member-leave=./member-leave.sh\",\n    \"member-failed=./member-failed.sh\",\n    \"member-update=./member-update.sh\",\n    \"user:deploy=./deploy.sh\",\n    \"query:sh=sh\"\n  ]\n}\n\n\u3053\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092\u307f\u308b\u3068\u3001\u30a4\u30d9\u30f3\u30c8\u30cf\u30f3\u30c9\u30e9\u6bce\u306b\u30b9\u30af\u30ea\u30d7\u30c8\u304c\u6307\u5b9a\u3055\u308c\u3066\u3044\u308b\u306e\u304c\u308f\u304b\u308a\u307e\u3059\u3002\n\u3053\u308c\u3067\u3001\u30a4\u30d9\u30f3\u30c8\u30cf\u30f3\u30c9\u30e9\u6bce\u306b\u5225\u3005\u306e\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u5b9f\u884c\u3059\u308b\u3053\u3068\u304c\u53ef\u80fd\u3068\u306a\u308a\u307e\u3059\u3002\n\u305d\u3057\u3066\u3053\u306e\u30d5\u30a1\u30a4\u30eb\u304b\u3089Serf\u3092\u8d77\u52d5\u3059\u308b\u306b\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b -config-file \u3092\u6307\u5b9a\u3057\u3066\u3057\u307e\u3059\u3002\nroot@node1:/# serf agent -config-file=serf.json\n\nnode2\u5074\u3082\u540c\u69d8\u306b\nroot@node2:/# serf agent -config-file=serf.json\n\n\u3068\u8aad\u307f\u8fbc\u307e\u305b\u3066\u307f\u307e\u3059\u3002\n\u9069\u5f53\u306b\u3001node1\u306eSerf agent\u3092\u505c\u6b62\u3057\u3066\u307f\u305f\u308a\u3001node2\u5074\u3067 serf leave \u3057\u3066\u307f\u305f\u308a\u3059\u308b\u3068\u3001\u305d\u308c\u305e\u308c\u306e\u30a4\u30d9\u30f3\u30c8\u30cf\u30f3\u30c9\u30e9\u306b\u5fdc\u3058\u3066\u6307\u5b9a\u3057\u305f\u30b9\u30af\u30ea\u30d7\u30c8\u304c\u5b9f\u884c\u3055\u308c\u308b\u3053\u3068\u304c\u308f\u304b\u308a\u307e\u3059\u3002\n(\u4eca\u56de\u7528\u610f\u3057\u305f member-*.sh \u306f\u5358\u7d14\u306b\u30db\u30b9\u30c8\u540d\u3068IP\u30a2\u30c9\u30ec\u30b9\u3092\u8868\u793a\u3057\u3066\u3044\u308b\u3060\u3051\u306a\u306e\u3067\u9762\u767d\u307f\u306f\u306a\u3044\u3051\u3069)\n\nuser \u30a4\u30d9\u30f3\u30c8\u3068 query \u30a4\u30d9\u30f3\u30c8\nSerf\u3067\u306f member-join \u306a\u3069\u4e88\u3081\u7528\u610f\u3055\u308c\u305f\u30a4\u30d9\u30f3\u30c8\u3068\u306f\u5225\u306b\u4efb\u610f\u306e\u30a4\u30d9\u30f3\u30c8\u3092\u767a\u751f\u3055\u305b\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\u4efb\u610f\u306e\u30a4\u30d9\u30f3\u30c8\u306f user \u30a4\u30d9\u30f3\u30c8\u3068 query \u30a4\u30d9\u30f3\u30c8\u304c\u3042\u308a\u3001\u305d\u308c\u305e\u308c\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u5b9f\u884c\u3057\u307e\u3059(\u898b\u3084\u3059\u3044\u3088\u3046\u306b log_level=info \u306b\u3057\u3066\u3042\u308a\u307e\u3059)\u3002\nuser \u30a4\u30d9\u30f3\u30c8\nroot@node2:/# serf event sh hostname\n    2014/04/08 17:15:42 [INFO] agent.ipc: Accepted client: 127.0.0.1:42907\nEvent 'sh' dispatched! Coalescing enabled: true\n    2014/04/08 17:15:43 [INFO] agent: Received event: user-event: sh\n\nquery \u30a4\u30d9\u30f3\u30c8\nroot@node2:/# serf query sh hostname\n    2014/04/08 17:15:06 [INFO] agent.ipc: Accepted client: 127.0.0.1:42903\n    2014/04/08 17:15:06 [INFO] agent: Received event: query: sh\nQuery 'sh' dispatched\nAck from 'node2'\nResponse from 'node2': node2\nAck from 'node1'\nResponse from 'node1': node1\nTotal Acks: 2\nTotal Responses: 2\n\n\u3069\u3061\u3089\u3082\u30a4\u30d9\u30f3\u30c8\u767a\u884c\u6642\u306b\u6307\u5b9a\u3055\u308c\u305f\u30b9\u30af\u30ea\u30d7\u30c8or\u30b3\u30de\u30f3\u30c9(\u4eca\u56de\u306f/bin/sh)\u304c\u5b9f\u884c\u3055\u308c\u308b\u3053\u3068\u306b\u5909\u308f\u308a\u306f\u3042\u308a\u307e\u305b\u3093\u3002\n\u305f\u3060\u3057 user \u30a4\u30d9\u30f3\u30c8\u3067\u306f\u3001\u5b9f\u884c\u7d50\u679c\u304c\u53d6\u5f97\u51fa\u6765\u306a\u3044\u306e\u306b\u5bfe\u3057\u3066\u3001query \u30a4\u30d9\u30f3\u30c8\u3067\u306f\u53d6\u5f97\u3067\u304d\u307e\u3059(Response from)\u3002\n\n\u3055\u3044\u3054\u306b\n\u672c\u30a8\u30f3\u30c8\u30ea\u30fc\u3067\u306fSerf\u306e\u57fa\u672c\u7684\u306a\u4f7f\u3044\u65b9\u306b\u3064\u3044\u3066Docker\u3092\u7528\u3044\u3066\u89e3\u8aac\u3057\u307e\u3057\u305f\u3002\nSerf\u306e\u624b\u8efd\u3055\u3084\u67d4\u8edf\u6027\u306e\u9ad8\u3055\u3092\u611f\u3058\u3066\u9802\u3051\u305f\u3067\u3057\u3087\u3046\u304b\u3002\n\u3053\u308c\u3092\u304d\u3063\u304b\u3051\u306bSerf\u3092\u4f7f\u3063\u3066\u201d\u4f55\u304b\u51fa\u6765\u305d\u3046\u201d\u3001\u201d\u4f55\u304b\u3084\u3063\u3066\u307f\u3088\u3046\u201d\u306a\u3069\u3068\u8208\u5473\u3092\u6301\u3063\u3066\u9802\u3051\u308b\u3068\u5e78\u3044\u3067\u3059\u3002\n\u6700\u5f8c\u306bSerf\u306e\u5b9f\u7528\u4f8b\u3092\u6319\u3052\u3066\u304a\u304d\u307e\u3059\u3002\n\nSerf+HAProxy\u3067\u4f5c\u308bAutomatic Load Balancer\nserf-munin\u3067munin-node\u306e\u76e3\u8996\u81ea\u52d5\u8ffd\u52a0/\u524a\u9664\nAutomatic /etc/hosts management with Serf\nSynapse \u3068 Serf \u3067\u30b5\u30fc\u30d3\u30b9\u30c7\u30a3\u30b9\u30ab\u30d0\u30ea\n\n\u5de5\u592b\u6b21\u7b2c\u3067\u69d8\u3005\u306a\u3053\u3068\u306b\u6d3b\u7528\u3067\u304d\u305d\u3046\u3067\u30ef\u30af\u30ef\u30af\u3057\u307e\u3059\u306d\u3002\n\u306f\u3058\u3081\u306b\n=======\n\u6700\u8fd1Serf\u306b\u95a2\u3059\u308b\u8a71\u984c\u304c\u76db\u308a\u4e0a\u304c\u3063\u3066\u304d\u3066\u3044\u3066\u3001Serf\u3092\u7d39\u4ecb\u3057\u305f\u8cc7\u6599\u304c\u30d6\u30af\u30de\u6570\u3092\u305d\u308c\u306a\u308a\u306b\u7a3c\u3044\u3067\u3044\u307e\u3059\u3002\n\n- [Serf\u304c\u9762\u767d\u3044\u3068\u4ffa\u306e\u4e2d\u3067\u8a71\u984c\u306bwwwwww \u3010\u6539\u8a02\u7248\u3011](http://www.slideshare.net/zembutsu/serf-the-liberator-2nd)\n- [Serf \u3068\u3044\u3046 Orchestration \u30c4\u30fc\u30eb #immutableinfra](http://www.slideshare.net/sonots/serf-iiconf-20140325)\n\n\u305d\u3053\u3067\u672c\u30a8\u30f3\u30c8\u30ea\u30fc\u3067\u306f\u3001\n\n- Serf\u3063\u3066\u4f55\uff1f\n- Serf\u3063\u3066\u3069\u3046\u3084\u3063\u3066\u4f7f\u3046\u306e\uff1f\n- Serf\u3063\u3066\u4f55\u304c\u51fa\u6765\u308b\u306e\uff1f\n\n\u306a\u3069\u3068\u601d\u3063\u3066\u3044\u308b\u65b9\u3092\u5bfe\u8c61\u3068\u3057\u3066\u3001Serf\u306e\u4f7f\u3044\u65b9\u3092\u7d39\u4ecb\u3057\u305f\u3044\u3068\u601d\u3044\u307e\u3059\u3002\n\nSerf\u3068\u306f\n=======\nSerf ( http://www.serfdom.io/ )\u3068\u306f\u3001\u30b5\u30fc\u30d0\u30d7\u30ed\u30d3\u30b8\u30e7\u30cb\u30f3\u30b0\u306b\u304a\u3051\u308b\u3001\u30aa\u30fc\u30b1\u30b9\u30c8\u30ec\u30fc\u30b7\u30e7\u30f3\u30ec\u30a4\u30e4\u30fc\u3067\u5229\u7528\u3059\u308b\u305f\u3081\u306e\u30c4\u30fc\u30eb\u3067\u3059\u3002\n\n\u30aa\u30fc\u30b1\u30b9\u30c8\u30ec\u30fc\u30b7\u30e7\u30f3\u30ec\u30a4\u30e4\u30fc\u3067\u306f\n\n- \u30b5\u30fc\u30d0\u3092\u5197\u9577\u5316\u3055\u305b\u305f\u308a\n- \u969c\u5bb3\u3092\u691c\u77e5\u3057\u305f\u3089\u30b5\u30fc\u30d0\u3092\u629c\u304d\u5dee\u3057\u3057\u305f\u308a\n\n\u306a\u3069\u306e\u64cd\u4f5c\u3092\u884c\u3044\u307e\u3059\u3002\nSerf\u306f\u30af\u30e9\u30b9\u30bf\u5185\u306e\u30b5\u30fc\u30d0\u306e\u72b6\u614b\u3092\u76e3\u8996\u3057\u3001\u3053\u308c\u3089\u306e\u64cd\u4f5c\u3092\u767a\u706b\u3055\u305b\u308b\u305f\u3081\u306e\u30c4\u30fc\u30eb\u3067\u3059\u3002\n\u767a\u706b\u306e\u30bf\u30a4\u30df\u30f3\u30b0\u306f\n\n- \u30af\u30e9\u30b9\u30bf\u306b\u65b0\u305f\u306a\u30b5\u30fc\u30d0\u304c\u52a0\u308f\u308b\n- \u30af\u30e9\u30b9\u30bf\u5185\u306e\u30b5\u30fc\u30d0\u304c\u30c0\u30a6\u30f3\u3059\u308b\n\n\u306a\u3069\u69d8\u3005\u3067\u3059(\u8a73\u3057\u304f\u306f\u5f8c\u3067\u8aac\u660e\u3057\u307e\u3059)\u3002\n\n\u306a\u304a\u30d7\u30ed\u30d3\u30b8\u30e7\u30cb\u30f3\u30b0\u306b\u3064\u3044\u3066\u306f\u4e0b\u8a18\u8cc7\u6599\u304c\u53c2\u8003\u306b\u306a\u308a\u307e\u3059\u3002\n\n- [Developers Summit 2014 \u3067\u300c\u30b5\u30fc\u30d0\u30d7\u30ed\u30d3\u30b8\u30e7\u30cb\u30f3\u30b0\u306e\u3053\u308c\u307e\u3067\u3068\u3053\u308c\u304b\u3089\u300d\u3068\u3044\u3046\u767a\u8868\u3092\u884c\u3044\u307e\u3057\u305f](http://mizzy.org/blog/2014/02/14/1/)\n\n\n\nSerf\u306e\u5b9f\u884c\u74b0\u5883\u3092\u6574\u3048\u308b\n=======\nSerf\u3092\u691c\u8a3c\u3059\u308b\u305f\u3081\u306b\u306f\u8907\u6570\u53f0\u306e\u30de\u30b7\u30f3\u304c\u5fc5\u8981\u306b\u306a\u308a\u307e\u3059\u3002\n\u6700\u4f4e2\u53f0\u3042\u308c\u3070\u691c\u8a3c\u306f\u53ef\u80fd\u3067\u3059\u304c\u300110\u6570\u53f0\u3042\u3063\u305f\u307b\u3046\u304c\u90fd\u5408\u304c\u3088\u304f\u3001\u305d\u308c\u3089\u3092\u52b9\u7387\u3088\u304f\u7528\u610f\u3059\u308b\u306b\u306fDocker\u304c\u6700\u9069\u3067\u3059\u3002\n\u307e\u305f\u3001Docker\u3092\u52d5\u304b\u3059\u74b0\u5883\u306fVagrantBox\u3067\u516c\u958b( https://vagrantcloud.com/3scale/docker )\u3055\u308c\u3066\u3044\u308b\u306e\u3067\u3001\u305d\u306eBox\u3092\u5229\u7528\u3057\u3066\u30b5\u30af\u30c3\u3068\u7528\u610f\u3057\u307e\u3059(Docker\u304c\u52d5\u3051\u3070\u3069\u3093\u306a\u74b0\u5883\u3067\u3082\u5927\u4e08\u592b\u3067\u3059)\u3002\n\nDocker\u306e\u52d5\u4f5c\u74b0\u5883\u306e\u6574\u5099\n----------\nVagrantfile\u3092\u7528\u610f\u3057\u305f\u306e\u3067 git clone \u3057\u3066 vagrant up \u3059\u308b\u3060\u3051\u3067\u6574\u3044\u307e\u3059\u3002\n\n```bash\n$ git clone git@github.com:foostan/vagrant-docker.git\n$ cd vagrant-docker\n$ vagrant up\n```\n\n\u305f\u3060\u3001\u4eca\u56de\u5229\u7528\u3057\u305fBox `3scale/docker` \u306e\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u306b\u7d50\u69cb\u6642\u9593\u304c\u304b\u304b\u308b\u306e\u3067\u3001\u624b\u6301\u3061\u306eBox\u3092\u5229\u7528\u3057\u3066https://www.docker.io/gettingstarted/ \u3092\u53c2\u8003\u306b\u3057\u3066Docker\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u305f\u65b9\u304c\u65e9\u3044\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u3002\n\nSerf\u30a4\u30e1\u30fc\u30b8\u306e\u4f5c\u6210\n------------\nDocker\u3067Serf\u7528\u306e\u30a4\u30e1\u30fc\u30b8\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\nSerf\u7528\u306eDockerfile\u3092\u7528\u610f\u3057\u305f\u306e\u3067\u4e0b\u8a18\u306e\u3088\u3046\u306b\u5b9f\u884c\u3059\u308b\u3060\u3051\u3067\u30b3\u30f3\u30c6\u30ca\u304c\u51fa\u6765\u4e0a\u304c\u308a\u307e\u3059(\u30b3\u30f3\u30c6\u30ca\u306e\u540d\u524d\u306f\u9069\u5b9c\u8a2d\u5b9a\u3057\u3066\u304f\u3060\u3055\u3044)\u3002\n\n```bash\n$ vagrant ssh\nvagrant@ubuntu-12:~$ cd /vagrant/serf\nvagrant@ubuntu-12:/vagrant/serf$ docker build -t foostan/serf .\n```\n\nSerf\u30b3\u30f3\u30c6\u30ca\u306e\u8d77\u52d5\n--------------\n\u30b3\u30f3\u30c6\u30ca\u306e\u8d77\u52d5\u6642\u306bSerf\u3092\u8d77\u52d5\u3059\u308b\u3088\u3046\u306b\u3057\u3066\u3082\u3044\u3044\u306e\u3067\u3059\u304c\u3001Serf\u306e\u691c\u8a3c\u3092\u3057\u305f\u3044\u306e\u3067\u3001\u4eca\u56de\u306f\u3042\u3048\u3066 /bin/bash \u3067\u30b3\u30f3\u30bd\u30fc\u30eb\u306b\u5165\u308a\u307e\u3059(Dockerfile\u3067\u3082\u3042\u3048\u3066ENTRYPOINT\u3092\u8a2d\u5b9a\u3057\u3066\u3044\u306a\u3044)\u3002\n\n```bash\nvagrant@ubuntu-12:/vagrant/serf$ docker run -i -t foostan/serf /bin/bash\n```\n\nSerf\u306e\u4f7f\u3044\u65b9\n------------\n### \u6e96\u5099\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3057\u3001\u30b3\u30f3\u30bd\u30fc\u30eb\u306b\u5165\u308b\u3068Serf\u30b3\u30de\u30f3\u30c9\u304c\u4f7f\u3048\u308b\u72b6\u614b\u306b\u306a\u3063\u3066\u3044\u308b\u3068\u601d\u3044\u307e\u3059\u3002\n\n```bash\nroot@node1:/# serf\nusage: app [--version] [--help] <command> [<args>]\n\nAvailable commands are:\n    agent           Runs a Serf agent\n    event           Send a custom event through the Serf cluster\n    force-leave     Forces a member of the cluster to enter the \"left\" state\n    join            Tell Serf agent to join cluster\n    keygen          Generates a new encryption key\n    leave           Gracefully leaves the Serf cluster and shuts down\n    members         Lists the members of a Serf cluster\n    monitor         Stream logs from a Serf agent\n    query           Send a query to the Serf cluster\n    reachability    Test network reachability\n    tags            Modify tags of a running Serf agent\n    version         Prints the Serf version\n```\n\n\u3053\u3053\u304b\u3089\u306f\u8907\u6570\u306eSerf\u3092\u5229\u7528\u3057\u3066\u691c\u8a3c\u3057\u305f\u3044\u305f\u3081\u3001\u65b0\u3057\u3044\u30a6\u30a4\u30f3\u30c9\u30a6\u3067\u3082\u3046\u4e00\u53f0Serf\u306e\u30b3\u30f3\u30c6\u30ca\u3092\u7acb\u3061\u4e0a\u3052\u3066\u30b3\u30f3\u30bd\u30fc\u30eb\u306b\u5165\u3063\u3066\u4e0b\u3055\u3044\u3002\n\n```bash\n$ vagrant ssh\nvagrant@ubuntu-12:~$ docker run -i -t foostan/serf /bin/bash\nroot@node2:/#\n```\n\u3053\u3053\u3067\u306f\u308f\u304b\u308a\u3084\u3059\u3044\u3088\u3046\u306b\u3001\n- root@node1\n- root@node2\n\u3068\u8868\u8a18\u3057\u3066\u3042\u308a\u307e\u3059\u3002\n\n### serf agent \u3067\u30af\u30e9\u30b9\u30bf\u3092\u5f62\u6210\u3059\u308b\nnode1\u304a\u3088\u3073node2\u3067\n\n```bash\nserf agent -discover=cluster1 &\n```\n\u3092\u5b9f\u884c\u3057\u3066\u4e0b\u3055\u3044\u3002\n\u4ee5\u524d\u306f1\u53f0\u76ee\u3092 `serf agent` \u3067\u8d77\u52d5\u3057\u30012\u53f0\u76ee\u4ee5\u964d\u306f\u8d77\u52d5\u4e2d\u306e\u30de\u30b7\u30f3\u306b\u5bfe\u3057\u3066 `serf join -join \u63a5\u7d9a\u5148\u306eIP\u30a2\u30c9\u30ec\u30b9` \u3067\u30af\u30e9\u30b9\u30bf\u3092\u5f62\u6210\u3059\u308b\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u307e\u3057\u305f\u304c(SPOF\u3068\u306a\u3063\u3066\u3044\u305f\u304c)\u3001`0.4.5` \u304b\u3089 `-discover` \u30aa\u30d7\u30b7\u30e7\u30f3\u3092\u5229\u7528\u3059\u308b\u3053\u3068\u30672\u53f0\u76ee\u4ee5\u964d\u3082\u540c\u3058\u30b3\u30de\u30f3\u30c9\u3067\u30af\u30e9\u30b9\u30bf\u3092\u5f62\u6210\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3057\u305f\u3002\n\u3061\u306a\u307f\u306b\u3001`serf agent` \u30b3\u30de\u30f3\u30c9\u306f\u30d5\u30a9\u30a2\u30b0\u30e9\u30a6\u30f3\u30c9\u3067\u5b9f\u884c\u3055\u308c\u3066\u30b3\u30f3\u30bd\u30fc\u30eb\u304c\u596a\u308f\u308c\u3061\u3083\u3046\u306e\u3067 `&` \u3092\u3064\u3051\u3066\u3042\u308a\u307e\u3059\u3002\n\n\u4ee5\u4e0b\u3001\u5b9f\u884c\u7d50\u679c\u3067\u3059\u3002\n\n```bash\nroot@node1:/# serf agent -discover=cluster1 &\n[1] 77\n==> Starting Serf agent...\n==> Starting Serf agent RPC...\n==> Serf agent running!\n         Node name: 'node1'\n         Bind addr: '0.0.0.0:7946'\n          RPC addr: '127.0.0.1:7373'\n         Encrypted: false\n          Snapshot: false\n           Profile: lan\n      mDNS cluster: cluster1\n\n==> Log data will now stream in as it occurs:\n\n    2014/04/07 16:52:43 [INFO] agent: Serf agent starting\n    2014/04/07 16:52:43 [INFO] serf: EventMemberJoin: node1 172.17.0.2\n    2014/04/07 16:52:43 [INFO] agent: joining: [172.17.0.2:7946] replay: false\n    2014/04/07 16:52:43 [INFO] agent: joined: 1 Err: <nil>\n    2014/04/07 16:52:43 [INFO] agent.mdns: Joined 1 hosts\n    2014/04/07 16:52:44 [INFO] agent: Received event: member-join\n```\n\n```bash\nroot@node2:/# serf agent -discover=cluster1 &\n[1] 17\n==> Starting Serf agent...\n==> Starting Serf agent RPC...\n==> Serf agent running!\n         Node name: 'node2'\n         Bind addr: '0.0.0.0:7946'\n          RPC addr: '127.0.0.1:7373'\n         Encrypted: false\n          Snapshot: false\n           Profile: lan\n      mDNS cluster: cluster1\n\n==> Log data will now stream in as it occurs:\n\n    2014/04/07 16:54:10 [INFO] agent: Serf agent starting\n    2014/04/07 16:54:10 [INFO] serf: EventMemberJoin: node2 172.17.0.3\n    2014/04/07 16:54:11 [INFO] agent: joining: [172.17.0.2:7946 172.17.0.3:7946] replay: false\n    2014/04/07 16:54:11 [INFO] serf: EventMemberJoin: node2 172.17.0.2\n    2014/04/07 16:54:11 [INFO] agent: joined: 2 Err: <nil>\n    2014/04/07 16:54:11 [INFO] agent.mdns: Joined 2 hosts\n    2014/04/07 16:54:12 [INFO] agent: Received event: member-join\n```\n\n`serf members` \u3067\u78ba\u8a8d\u3057\u3066\u307f\u307e\u3059\u3002\n\n```bash\nroot@node1:/# serf members\n    2014/04/07 17:06:24 [INFO] agent.ipc: Accepted client: 127.0.0.1:42530\nnode1  172.17.0.2:7946  alive\nnode2  172.17.0.3:7946  alive\n```\n\u7121\u4e8b\u306b\u30af\u30e9\u30b9\u30bf\u304c\u5f62\u6210\u3055\u308c\u305f\u3053\u3068\u304c\u78ba\u8a8d\u3067\u304d\u307e\u3057\u305f\u3002\n\n### serf leave \u3067\u30af\u30e9\u30b9\u30bf\u304b\u3089\u629c\u3051\u308b\n`serf learve` \u30b3\u30de\u30f3\u30c9\u3067\u6240\u5c5e\u3057\u3066\u3044\u308b\u30af\u30e9\u30b9\u30bf\u304b\u3089\u629c\u3051\u307e\u3059\u3002\n\n```bash\nroot@node1:/# serf leave\n    2014/04/07 17:10:30 [INFO] agent.ipc: Accepted client: 127.0.0.1:42549\n    2014/04/07 17:10:30 [INFO] agent.ipc: Graceful leave triggered\n    2014/04/07 17:10:30 [INFO] agent: requesting graceful leave from Serf\n    2014/04/07 17:10:31 [INFO] serf: EventMemberLeave: node1 172.17.0.2\nGraceful leave complete\n    2014/04/07 17:10:32 [INFO] agent: requesting serf shutdown\n    2014/04/07 17:10:32 [INFO] agent: shutdown complete\n```\n\nnode2\u5074\u3067 `serf members` \u3067node1\u304c\u629c\u3051\u305f\u3053\u3068\u3092\u78ba\u8a8d\u3057\u3066\u307f\u307e\u3059\u3002\n\n```bash\nroot@node2:/# serf members\n    2014/04/07 17:11:10 [INFO] agent.ipc: Accepted client: 127.0.0.1:42550\nnode2  172.17.0.3:7946  alive\nnode1  172.17.0.2:7946  left\n```\n\n### \u30a4\u30d9\u30f3\u30c8\u30cf\u30f3\u30c9\u30e9\u306b\u3064\u3044\u3066\nSerf\u3067\u306f\u4ee5\u4e0b\u306e\u30a4\u30d9\u30f3\u30c8\u30cf\u30f3\u30c9\u30e9\u304c\u7528\u610f\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n\n- member-join: \u30e1\u30f3\u30d0\u30fc\u304c\u52a0\u308f\u3063\u305f\u3068\u304d\n- member-leave: \u30e1\u30f3\u30d0\u30fc\u304c\u629c\u3051\u305f\u3068\u304d\n- member-failed: \u30e1\u30f3\u30d0\u30fc\u3092\u898b\u5931\u3063\u305f\u3068\u304d(\u758e\u901a\u78ba\u8a8d\u306b\u5931\u6557\u305f\u3068\u304d)\n- member-update: \u30e1\u30f3\u30d0\u30fc\u306e\u60c5\u5831\u304c\u66f4\u65b0\u3055\u308c\u305f\u3068\u304d\n- member-reap: \u30e1\u30f3\u30d0\u30fc\u3092\u30ea\u30b9\u30c8\u304b\u3089\u524a\u9664\u3057\u305f\u3068\u304d(`member-leave` \u307e\u305f\u306f`member-failed` \u304b\u3089\u4e00\u5b9a\u6642\u9593\u7d4c\u904e\u3057\u305f\u3068\u304d)\n- user: \u4efb\u610f\u306e\u30e6\u30fc\u30b6\u30a4\u30d9\u30f3\u30c8\u304c\u767a\u884c\u3055\u308c\u305f\u3068\u304d\n- query: \u4efb\u610f\u306e\u30af\u30a8\u30ea\u304c\u767a\u884c\u3055\u308c\u305f\u3068\u304d\n\n`member-join` \u3084 `member-leave` \u306b\u3064\u3044\u3066\u306f\u524d\u306e\u7bc0\u3067\u65e2\u306b\u51fa\u3066\u304d\u3066\u3044\u3066\u3001\n\n```bash\n2014/04/07 17:10:32 [INFO] agent: Received event: member-leave\n```\n\u3084\n\n```bash\n2014/04/07 16:55:12 [INFO] agent: Received event: member-join\n```\n\u304c\u3001\u30a4\u30d9\u30f3\u30c8\u30cf\u30f3\u30c9\u30e9\u304c\u547c\u3070\u308c\u305f\u30bf\u30a4\u30df\u30f3\u30b0\u3068\u306a\u308a\u307e\u3059\u3002\n\n### \u30a4\u30d9\u30f3\u30c8\u30cf\u30f3\u30c9\u30e9\u3067\u4efb\u610f\u306e\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u5b9f\u884c\u3059\u308b\nSerf\u3067\u306f\u4e0b\u8a18\u306e\u3088\u3046\u306b\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u6307\u5b9a\u3059\u308b\u3053\u3068\u3067\u3001\u30a4\u30d9\u30f3\u30c8\u30cf\u30f3\u30c9\u30e9\u306e\u767a\u706b\u6642\u306b\u30b9\u30af\u30ea\u30d7\u30c8\u304c\u5b9f\u884c\u3055\u308c\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\n\u203b \u30a4\u30d9\u30f3\u30c8\u30cf\u30f3\u30c9\u30e9\u306e\u6a19\u6e96\u51fa\u529b\u306f\u3001`-log-level=debug` \u3067\u306a\u3044\u3068\u8868\u793a\u3055\u308c\u306a\u3044\u305f\u3081\u3001`-log-level` \u3092\u6307\u5b9a\u3057\u3066\u3044\u307e\u3059\u3002\n\n```bash\nserf agent -discover=cluster1  -log-level=debug\u3000-event-handler=./handle.sh\n```\n\nhandle.sh\u306e\u5185\u5bb9\u306f\u4ee5\u4e0b\u306e\u3068\u304a\u308a\u3067\u3059\u3002\n\n```bash\n#!/bin/bash\n\necho\necho \"SERF_EVENT:       ${SERF_EVENT}\"\necho \"SERF_SELF_NAME:   ${SERF_SELF_NAME}\"\necho \"SERF_SELF_ROLE:   ${SERF_SELF_ROLE}\"\necho \"SERF_SELF_TAG:    ${SERF_SELF_TAG}\"\necho \"SERF_TAG_ROLE:    ${SERF_TAG_ROLE}\"\necho \"SERF_USER_EVENT:  ${SERF_USER_EVENT}\"\necho \"SERF_USER_LTIME:  ${SERF_USER_LTIME}\"\necho \"SERF_QUERY_NAME:  ${SERF_QUERY_NAME}\"\necho \"SERF_QUERY_LTIME: ${SERF_QUERY_LTIME}\"\nwhile read line; do\n  echo \"event data:       ${line}\"\ndone\n```\n\n\u30a4\u30d9\u30f3\u30c8\u30cf\u30f3\u30c9\u30e9\u306b\u3088\u3063\u3066\u547c\u3070\u308c\u308b\u30b9\u30af\u30ea\u30d7\u30c8\u5185\u3067\u306f\u3001\u4e0a\u8a18\u306e\u3088\u3046\u306a\u74b0\u5883\u5909\u6570\u304c\u4f7f\u7528\u3067\u304d\u307e\u3059\u3002\n\u74b0\u5883\u5909\u6570\u306e\u8a73\u7d30\u306b\u3064\u3044\u3066\u306f\u3000http://www.serfdom.io/docs/agent/event-handlers.html \u3092\u53c2\u7167\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n\u4e0a\u8a18\u30b9\u30af\u30ea\u30d7\u30c8\u304c\u30a4\u30d9\u30f3\u30c8\u30cf\u30f3\u30c9\u30e9\u306b\u547c\u3070\u308c\u308b\u3068\u4e0b\u8a18\u306e\u3088\u3046\u306b\u5b9f\u884c\u3055\u308c\u307e\u3059\u3002\nmember-join \u30a4\u30d9\u30f3\u30c8\n\n```bash\n--- \u7701\u7565 ---\n\n    2014/04/08 15:05:53 [INFO] agent: Received event: member-join\n    2014/04/08 15:05:53 [DEBUG] agent: Event 'member-join' script output:\nSERF_EVENT:       member-join\nSERF_SELF_NAME:   node1\nSERF_SELF_ROLE:\nSERF_SELF_TAG:\nSERF_TAG_ROLE:\nSERF_USER_EVENT:\nSERF_USER_LTIME:\nSERF_QUERY_NAME:\nSERF_QUERY_LTIME:\nevent data:       node2\t172.17.0.3\n```\n\nmember-leave \u30a4\u30d9\u30f3\u30c8\n\n```bass\n--- \u7701\u7565 ---\n\n    2014/04/08 15:05:59 [INFO] serf: EventMemberLeave: node2 172.17.0.3\n    2014/04/08 15:06:00 [INFO] agent: Received event: member-leave\n    2014/04/08 15:06:00 [DEBUG] agent: Event 'member-leave' script output:\nSERF_EVENT:       member-leave\nSERF_SELF_NAME:   node1\nSERF_SELF_ROLE:\nSERF_SELF_TAG:\nSERF_TAG_ROLE:\nSERF_USER_EVENT:\nSERF_USER_LTIME:\nSERF_QUERY_NAME:\nSERF_QUERY_LTIME:\nevent data:       node2\t172.17.0.3\n```\n\nSERF_EVENT\u3084SERF_SELF_NAME\u304c\u53d6\u5f97\u3067\u304d\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308a\u307e\u3059\u3002\n\u3055\u3089\u306b\u3001\u6a19\u6e96\u5165\u529b\u3068\u3057\u3066\u30db\u30b9\u30c8\u540d\u3068IP\u30a2\u30c9\u30ec\u30b9\u304c\u5165\u529b\u3055\u308c\u308b\u3053\u3068\u304c\u78ba\u8a8d\u3067\u304d\u307e\u3059(event data: \u3068\u3057\u3066\u8868\u793a)\u3002\n\n### \u30a4\u30d9\u30f3\u30c8\u30cf\u30f3\u30c9\u30e9\u6bce\u306b\u5225\u3005\u306e\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u5b9f\u884c\u3059\u308b\n\u305d\u308d\u305d\u308d\u5f15\u6570\u304c\u591a\u304f\u306a\u3063\u3066\u304d\u305f\u306e\u3067\u3001\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092\u8a18\u8ff0\u3057\u305fJson\u3092\u8aad\u307f\u8fbc\u307e\u305b\u3066serf\u3092\u5b9f\u884c\u3057\u3066\u307f\u307e\u3059\u3002\n\u4ee5\u4e0b\u306e\u69d8\u306ajson\u30d5\u30a1\u30a4\u30eb\u304c `/serf.json` \u3068\u3057\u3066Docker\u306e\u30b3\u30f3\u30c6\u30ca\u8d77\u52d5\u6642\u306b\u914d\u7f6e\u3057\u3066\u3042\u308a\u307e\u3059\u3002\n\n```json\n{\n  \"tags\": {\n    \"role\": \"web\"\n  },\n  \"discover\": \"app\",\n\n  \"encrypt_key\": \"cg8StVXbQJ0gPvMd9o7yrg==\",\n  \"log_level\": \"debug\",\n\n  \"event_handlers\": [\n    \"member-join=./member-join.sh\",\n    \"member-leave=./member-leave.sh\",\n    \"member-failed=./member-failed.sh\",\n    \"member-update=./member-update.sh\",\n    \"user:deploy=./deploy.sh\",\n    \"query:sh=sh\"\n  ]\n}\n```\n\n\u3053\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092\u307f\u308b\u3068\u3001\u30a4\u30d9\u30f3\u30c8\u30cf\u30f3\u30c9\u30e9\u6bce\u306b\u30b9\u30af\u30ea\u30d7\u30c8\u304c\u6307\u5b9a\u3055\u308c\u3066\u3044\u308b\u306e\u304c\u308f\u304b\u308a\u307e\u3059\u3002\n\u3053\u308c\u3067\u3001\u30a4\u30d9\u30f3\u30c8\u30cf\u30f3\u30c9\u30e9\u6bce\u306b\u5225\u3005\u306e\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u5b9f\u884c\u3059\u308b\u3053\u3068\u304c\u53ef\u80fd\u3068\u306a\u308a\u307e\u3059\u3002\n\n\u305d\u3057\u3066\u3053\u306e\u30d5\u30a1\u30a4\u30eb\u304b\u3089Serf\u3092\u8d77\u52d5\u3059\u308b\u306b\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b `-config-file` \u3092\u6307\u5b9a\u3057\u3066\u3057\u307e\u3059\u3002\n\n```bash\nroot@node1:/# serf agent -config-file=serf.json\n```\n\nnode2\u5074\u3082\u540c\u69d8\u306b\n\n```bash\nroot@node2:/# serf agent -config-file=serf.json\n```\n\n\u3068\u8aad\u307f\u8fbc\u307e\u305b\u3066\u307f\u307e\u3059\u3002\n\u9069\u5f53\u306b\u3001node1\u306eSerf agent\u3092\u505c\u6b62\u3057\u3066\u307f\u305f\u308a\u3001node2\u5074\u3067 `serf leave` \u3057\u3066\u307f\u305f\u308a\u3059\u308b\u3068\u3001\u305d\u308c\u305e\u308c\u306e\u30a4\u30d9\u30f3\u30c8\u30cf\u30f3\u30c9\u30e9\u306b\u5fdc\u3058\u3066\u6307\u5b9a\u3057\u305f\u30b9\u30af\u30ea\u30d7\u30c8\u304c\u5b9f\u884c\u3055\u308c\u308b\u3053\u3068\u304c\u308f\u304b\u308a\u307e\u3059\u3002\n(\u4eca\u56de\u7528\u610f\u3057\u305f `member-*.sh` \u306f\u5358\u7d14\u306b\u30db\u30b9\u30c8\u540d\u3068IP\u30a2\u30c9\u30ec\u30b9\u3092\u8868\u793a\u3057\u3066\u3044\u308b\u3060\u3051\u306a\u306e\u3067\u9762\u767d\u307f\u306f\u306a\u3044\u3051\u3069)\n\n### user \u30a4\u30d9\u30f3\u30c8\u3068 query \u30a4\u30d9\u30f3\u30c8\nSerf\u3067\u306f `member-join` \u306a\u3069\u4e88\u3081\u7528\u610f\u3055\u308c\u305f\u30a4\u30d9\u30f3\u30c8\u3068\u306f\u5225\u306b\u4efb\u610f\u306e\u30a4\u30d9\u30f3\u30c8\u3092\u767a\u751f\u3055\u305b\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\u4efb\u610f\u306e\u30a4\u30d9\u30f3\u30c8\u306f user \u30a4\u30d9\u30f3\u30c8\u3068 query \u30a4\u30d9\u30f3\u30c8\u304c\u3042\u308a\u3001\u305d\u308c\u305e\u308c\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u5b9f\u884c\u3057\u307e\u3059(\u898b\u3084\u3059\u3044\u3088\u3046\u306b `log_level=info` \u306b\u3057\u3066\u3042\u308a\u307e\u3059)\u3002\n\nuser \u30a4\u30d9\u30f3\u30c8\n\n```bash\nroot@node2:/# serf event sh hostname\n    2014/04/08 17:15:42 [INFO] agent.ipc: Accepted client: 127.0.0.1:42907\nEvent 'sh' dispatched! Coalescing enabled: true\n    2014/04/08 17:15:43 [INFO] agent: Received event: user-event: sh\n```\n\nquery \u30a4\u30d9\u30f3\u30c8\n\n```bash\nroot@node2:/# serf query sh hostname\n    2014/04/08 17:15:06 [INFO] agent.ipc: Accepted client: 127.0.0.1:42903\n    2014/04/08 17:15:06 [INFO] agent: Received event: query: sh\nQuery 'sh' dispatched\nAck from 'node2'\nResponse from 'node2': node2\nAck from 'node1'\nResponse from 'node1': node1\nTotal Acks: 2\nTotal Responses: 2\n```\n\n\u3069\u3061\u3089\u3082\u30a4\u30d9\u30f3\u30c8\u767a\u884c\u6642\u306b\u6307\u5b9a\u3055\u308c\u305f\u30b9\u30af\u30ea\u30d7\u30c8or\u30b3\u30de\u30f3\u30c9(\u4eca\u56de\u306f/bin/sh)\u304c\u5b9f\u884c\u3055\u308c\u308b\u3053\u3068\u306b\u5909\u308f\u308a\u306f\u3042\u308a\u307e\u305b\u3093\u3002\n\u305f\u3060\u3057 user \u30a4\u30d9\u30f3\u30c8\u3067\u306f\u3001\u5b9f\u884c\u7d50\u679c\u304c\u53d6\u5f97\u51fa\u6765\u306a\u3044\u306e\u306b\u5bfe\u3057\u3066\u3001query \u30a4\u30d9\u30f3\u30c8\u3067\u306f\u53d6\u5f97\u3067\u304d\u307e\u3059(Response from)\u3002\n\n\u3055\u3044\u3054\u306b\n=========\n\u672c\u30a8\u30f3\u30c8\u30ea\u30fc\u3067\u306fSerf\u306e\u57fa\u672c\u7684\u306a\u4f7f\u3044\u65b9\u306b\u3064\u3044\u3066Docker\u3092\u7528\u3044\u3066\u89e3\u8aac\u3057\u307e\u3057\u305f\u3002\nSerf\u306e\u624b\u8efd\u3055\u3084\u67d4\u8edf\u6027\u306e\u9ad8\u3055\u3092\u611f\u3058\u3066\u9802\u3051\u305f\u3067\u3057\u3087\u3046\u304b\u3002\n\u3053\u308c\u3092\u304d\u3063\u304b\u3051\u306bSerf\u3092\u4f7f\u3063\u3066\u201d\u4f55\u304b\u51fa\u6765\u305d\u3046\u201d\u3001\u201d\u4f55\u304b\u3084\u3063\u3066\u307f\u3088\u3046\u201d\u306a\u3069\u3068\u8208\u5473\u3092\u6301\u3063\u3066\u9802\u3051\u308b\u3068\u5e78\u3044\u3067\u3059\u3002\n\n\u6700\u5f8c\u306bSerf\u306e\u5b9f\u7528\u4f8b\u3092\u6319\u3052\u3066\u304a\u304d\u307e\u3059\u3002\n\n- [Serf+HAProxy\u3067\u4f5c\u308bAutomatic Load Balancer](http://blog.glidenote.com/blog/2013/10/30/serf-haproxy/)\n- [serf-munin\u3067munin-node\u306e\u76e3\u8996\u81ea\u52d5\u8ffd\u52a0/\u524a\u9664](http://pocketstudio.jp/log3/2013/11/01/serf-munin-eventhander-auto-monitorin/)\n- [Automatic /etc/hosts management with Serf](https://github.com/kentaro/serf-hosts)\n- [Synapse \u3068 Serf \u3067\u30b5\u30fc\u30d3\u30b9\u30c7\u30a3\u30b9\u30ab\u30d0\u30ea](http://blog.ryotarai.info/blog/2014/04/01/service-discovery-by-syanpse-with-serf/)\n\n\u5de5\u592b\u6b21\u7b2c\u3067\u69d8\u3005\u306a\u3053\u3068\u306b\u6d3b\u7528\u3067\u304d\u305d\u3046\u3067\u30ef\u30af\u30ef\u30af\u3057\u307e\u3059\u306d\u3002", "tags": ["serf0.5.0", "docker0.9.1", "vagrant1.5.0"]}