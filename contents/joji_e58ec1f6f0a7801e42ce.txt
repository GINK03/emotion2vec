{"tags": ["capistrano"], "context": " More than 1 year has passed since last update.Host\u306e\u4e2d\nssh-keygen -t rsa\n\n\u30d1\u30b9\u30ef\u30fc\u30c9\u306fjapan\nsu - japan\n\ngit clone your url\n\ncd your project\n\nvi Gemfile\n\n\u3053\u306e\u8a2d\u5b9a\u306fdeploy\u7528\u306ebranch\u3002\nsource 'https://rubygems.org'\n\ngem 'capistrano'\ngem 'capistrano-bundler'\ngem 'capistrano-rails'\ngem 'capistrano3-unicorn'\ngem 'capistrano-maintenance'\n\nbundle install --path vendor/bundle\n\ncapistrano\u3067\u4f7f\u3048\u308b\u30b3\u30de\u30f3\u30c9\u3092\u78ba\u8a8d\nbundle exec cap -T\n\neval `ssh-agent -s`\n\nssh-add ~/.ssh/id_rsa\n\ndevelopment\u3001staging\u3001production\u306e\u5171\u901a\u8a2d\u5b9a\u3092\u3053\u3053\u306b\u8a18\u8ff0\nvi config/deploy.rb\n\n\ndeploy.rb//deploy-branch\nlock '3.2.1'\nset :user, 'japan' #\u5b9f\u884c\u30e6\u30fc\u30b6\u30fc\nset :application, 'your_project' #\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u540d\nset :repo_url, 'git@github.com:your url' #git\u306eURL\nset :scm, :git #git\u3092\u4f7f\u3046\nset :deploy_via, :remote_cache #\u3068\u308a\u3042\u3048\u305a\u3001\u3053\u308c\u3092\u8a2d\u5b9a\u3059\u308b\u3068\u65e9\u3044\u3050\u3089\u3044\u306e\u7406\u89e3\nset :keep_releases, 5 #5\u56de\u5206\u306e\u30ea\u30ea\u30fc\u30b9\u3092\u30b5\u30fc\u30d0\u30fc\u306b\u4fdd\u5b58\nset :deploy_to, \"/srv/www/#{fetch(:application)}\" #deploy\u5148\u306e\u8a2d\u5b9a\nshared_path = \"#{fetch(:deploy_to)}/shared\" #shared\u30d5\u30a1\u30a4\u30eb\u306e\u4fdd\u5b58\u5148\nrelease_path = \"#{fetch(:deploy_to)}/current\" #\u30ea\u30ea\u30fc\u30b9\u30d5\u30a1\u30a4\u30eb\u306e\u4fdd\u5b58\u5148\nset :linked_files, %w{config/database.yml config/application.yml} #shared\u30d5\u30a1\u30a4\u30eb\u3092deploy\u6642\u306brelease\u306b\u30b3\u30d4\u30fc\nset :linked_dirs, %w{bin log tmp/pids tmp/cache tmp/sockets bundle}\nset :unicorn_pid, \"#{shared_path}/tmp/pids/unicorn.pid\"\nset :unicorn_config_path, \"#{release_path}/config/unicorn.rb\"\nafter 'deploy:publishing', 'deploy:restart'\nnamespace :deploy do\n  task :restart do\n    invoke 'unicorn:restart'\n  end\nend\n\n\nvi config/deploy/production.rb\n\n\nproduction.rb//deploy-branch\nset :rails_env, 'production'\nset :branch, 'master' #\u30ea\u30ea\u30fc\u30b9\u6642\u306bbranch\u306e\u6307\u5b9a\nserver '192.168.43.62', user: 'japan', roles: %w{web app db}, :primary => true #\u5bfe\u8c61\u30b5\u30fc\u30d0\u30fc\u3001\u30e6\u30fc\u30b6\u30fc\n#\u73fe\u5728\u3001\u4f7f\u7528\u3057\u3066\u3044\u308bssh\u306ekey\u3092\u4f7f\u3063\u3066\u3001github\u304b\u3089deploy\u5148\u306b\u30bd\u30fc\u30b9\u30b3\u30fc\u30c9\u3092\u6301\u3063\u3066\u304f\u308b\nset :ssh_options, keys: %w(/home/japan/.ssh/id_rsa), forward_agent: true, auth_methods: %w(publickey) \nset :unicorn_rack_env, 'production'\n\n\nvi config/unicorn.rb\n\napp_path = \"/srv/www/your_project\"\n\nworker_processes 4\npreload_app true\ntimeout = 30\nlisten \"#{app_path}/shared/tmp/sockets/unicorn.sock\" #\u3053\u3053\u306e\u8a2d\u5b9a\u3092nginx\u306e\u8a2d\u5b9a\u3068\u5408\u308f\u305b\u308b\u5fc5\u8981\u304c\u3042\u308b\u3002\nworking_directory = \"#{app_path}/current\"\nrails_env = ENV['RACK_ENV'] || ENV['RAILS_ENV'] || 'production'\nstderr_path \"log/unicorn.log\"\nstdout_path \"log/unicorn.log\"\npid \"#{app_path}/shared/tmp/pids/unicorn.pid\"\npreload_app true\nbefore_fork do |server, worker|\n  defined?(ActiveRecord::Base) and\n    ActiveRecord::Base.connection.disconnect!\n  old_pid = \"#{server.config[:pid]}.oldbin\"\n  puts \"old_pid=#{old_pid}\"\n  if File.exists?(old_pid) && server.pid != old_pid\n    begin\n      Process.kill(\"QUIT\", File.read(old_pid).to_i)\n    rescue Errno::ENOENT, Errno::ESRCH\n    end\n  end\nend\nafter_fork do |server, worker|\n  if defined?(ActiveRecord::Base)\n    config = Rails.application.config.database_configuration[Rails.env]\n    config['reaping_frequency'] = ENV['DB_REAP_FREQ'] || 10 # seconds\n    config['pool']              = ENV['DB_POOL'] || 5\n    ActiveRecord::Base.establish_connection(config)\n  end\nend\nbefore_exec do |server|\n  ENV[\"BUNDLE_GEMFILE\"] = \"/srv/www/your_project/current/Gemfile\"\nend\n\nbundle exec cap production deploy\n\n\u521d\u56de\u306fshared/config\u306bdatabase.yml\u3092\u4f5c\u6210\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\nvi /srv/www/your_project/shared/config/database.yml\n\n\u521d\u56de\u306fshared/config\u306bapplication.yml\u3092\u4f5c\u6210\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\nvi /srv/www/your_project/shared/config/application.yml\n\nfront1\u3067nokogiri\u306e\u30a8\u30e9\u30fc\u304c\u51fa\u305f\u3089\u3001\u3053\u308c\u3092\u5b9f\u884c\nbundle config build.nokogiri --use-system-libraries\n\n\nHost\u306e\u4e2d\n\n```bash\nssh-keygen -t rsa\n```\n\n\u30d1\u30b9\u30ef\u30fc\u30c9\u306fjapan\n\n```bash\nsu - japan\n```\n\n```bash\ngit clone your url\n```\n\n\n```bash\ncd your project\n```\n\n```bash\nvi Gemfile\n```\n\n\u3053\u306e\u8a2d\u5b9a\u306fdeploy\u7528\u306ebranch\u3002\n\n```Gemfile/deploy-branch\nsource 'https://rubygems.org'\n\ngem 'capistrano'\ngem 'capistrano-bundler'\ngem 'capistrano-rails'\ngem 'capistrano3-unicorn'\ngem 'capistrano-maintenance'\n```\n\n```bash\nbundle install --path vendor/bundle\n```\n\ncapistrano\u3067\u4f7f\u3048\u308b\u30b3\u30de\u30f3\u30c9\u3092\u78ba\u8a8d\n\n```bash\nbundle exec cap -T\n```\n\n```bash\neval `ssh-agent -s`\n```\n\n```bash\nssh-add ~/.ssh/id_rsa\n```\n\ndevelopment\u3001staging\u3001production\u306e\u5171\u901a\u8a2d\u5b9a\u3092\u3053\u3053\u306b\u8a18\u8ff0\n\n```bash\nvi config/deploy.rb\n```\n\n```deploy.rb//deploy-branch\nlock '3.2.1'\nset :user, 'japan' #\u5b9f\u884c\u30e6\u30fc\u30b6\u30fc\nset :application, 'your_project' #\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u540d\nset :repo_url, 'git@github.com:your url' #git\u306eURL\nset :scm, :git #git\u3092\u4f7f\u3046\nset :deploy_via, :remote_cache #\u3068\u308a\u3042\u3048\u305a\u3001\u3053\u308c\u3092\u8a2d\u5b9a\u3059\u308b\u3068\u65e9\u3044\u3050\u3089\u3044\u306e\u7406\u89e3\nset :keep_releases, 5 #5\u56de\u5206\u306e\u30ea\u30ea\u30fc\u30b9\u3092\u30b5\u30fc\u30d0\u30fc\u306b\u4fdd\u5b58\nset :deploy_to, \"/srv/www/#{fetch(:application)}\" #deploy\u5148\u306e\u8a2d\u5b9a\nshared_path = \"#{fetch(:deploy_to)}/shared\" #shared\u30d5\u30a1\u30a4\u30eb\u306e\u4fdd\u5b58\u5148\nrelease_path = \"#{fetch(:deploy_to)}/current\" #\u30ea\u30ea\u30fc\u30b9\u30d5\u30a1\u30a4\u30eb\u306e\u4fdd\u5b58\u5148\nset :linked_files, %w{config/database.yml config/application.yml} #shared\u30d5\u30a1\u30a4\u30eb\u3092deploy\u6642\u306brelease\u306b\u30b3\u30d4\u30fc\nset :linked_dirs, %w{bin log tmp/pids tmp/cache tmp/sockets bundle}\nset :unicorn_pid, \"#{shared_path}/tmp/pids/unicorn.pid\"\nset :unicorn_config_path, \"#{release_path}/config/unicorn.rb\"\nafter 'deploy:publishing', 'deploy:restart'\nnamespace :deploy do\n  task :restart do\n    invoke 'unicorn:restart'\n  end\nend\n```\n\n```bash\nvi config/deploy/production.rb\n```\n\n```production.rb//deploy-branch\nset :rails_env, 'production'\nset :branch, 'master' #\u30ea\u30ea\u30fc\u30b9\u6642\u306bbranch\u306e\u6307\u5b9a\nserver '192.168.43.62', user: 'japan', roles: %w{web app db}, :primary => true #\u5bfe\u8c61\u30b5\u30fc\u30d0\u30fc\u3001\u30e6\u30fc\u30b6\u30fc\n#\u73fe\u5728\u3001\u4f7f\u7528\u3057\u3066\u3044\u308bssh\u306ekey\u3092\u4f7f\u3063\u3066\u3001github\u304b\u3089deploy\u5148\u306b\u30bd\u30fc\u30b9\u30b3\u30fc\u30c9\u3092\u6301\u3063\u3066\u304f\u308b\nset :ssh_options, keys: %w(/home/japan/.ssh/id_rsa), forward_agent: true, auth_methods: %w(publickey) \nset :unicorn_rack_env, 'production'\n```\n\n```bash\nvi config/unicorn.rb\n```\n\n```bash/master-branch\napp_path = \"/srv/www/your_project\"\n \nworker_processes 4\npreload_app true\ntimeout = 30\nlisten \"#{app_path}/shared/tmp/sockets/unicorn.sock\" #\u3053\u3053\u306e\u8a2d\u5b9a\u3092nginx\u306e\u8a2d\u5b9a\u3068\u5408\u308f\u305b\u308b\u5fc5\u8981\u304c\u3042\u308b\u3002\nworking_directory = \"#{app_path}/current\"\nrails_env = ENV['RACK_ENV'] || ENV['RAILS_ENV'] || 'production'\nstderr_path \"log/unicorn.log\"\nstdout_path \"log/unicorn.log\"\npid \"#{app_path}/shared/tmp/pids/unicorn.pid\"\npreload_app true\nbefore_fork do |server, worker|\n  defined?(ActiveRecord::Base) and\n    ActiveRecord::Base.connection.disconnect!\n  old_pid = \"#{server.config[:pid]}.oldbin\"\n  puts \"old_pid=#{old_pid}\"\n  if File.exists?(old_pid) && server.pid != old_pid\n    begin\n      Process.kill(\"QUIT\", File.read(old_pid).to_i)\n    rescue Errno::ENOENT, Errno::ESRCH\n    end\n  end\nend\nafter_fork do |server, worker|\n  if defined?(ActiveRecord::Base)\n    config = Rails.application.config.database_configuration[Rails.env]\n    config['reaping_frequency'] = ENV['DB_REAP_FREQ'] || 10 # seconds\n    config['pool']              = ENV['DB_POOL'] || 5\n    ActiveRecord::Base.establish_connection(config)\n  end\nend\nbefore_exec do |server|\n  ENV[\"BUNDLE_GEMFILE\"] = \"/srv/www/your_project/current/Gemfile\"\nend\n```\n\n```bash\nbundle exec cap production deploy\n```\n\n\u521d\u56de\u306fshared/config\u306bdatabase.yml\u3092\u4f5c\u6210\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\n\n```\nvi /srv/www/your_project/shared/config/database.yml\n```\n\n\u521d\u56de\u306fshared/config\u306bapplication.yml\u3092\u4f5c\u6210\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\n\n```\nvi /srv/www/your_project/shared/config/application.yml\n```\n\nfront1\u3067nokogiri\u306e\u30a8\u30e9\u30fc\u304c\u51fa\u305f\u3089\u3001\u3053\u308c\u3092\u5b9f\u884c\n\n```bash\nbundle config build.nokogiri --use-system-libraries\n```\n"}