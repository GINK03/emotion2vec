{"context": "\n\n\u6982\u8981\n\n\u30aa\u30f3\u30d7\u30ec\u306b\u3042\u3063\u305fOpenStack\u306eVM\u00d71\u53f0\u3092AWS\u4e0a\u306eEC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u00d71\u53f0\u306b\u79fb\u884c\u3059\u308b\n\u540c\u6642\u306bGitLab\u3092\u73fe\u6642\u70b9\u306e\u6700\u65b0\u7248 8.13.1 \u306b\u30d0\u30fc\u30b8\u30e7\u30f3\u30a2\u30c3\u30d7\u3059\u308b\nMySQL(\u5b9f\u969b\u306fMariaDB)\u3067\u52d5\u304b\u3057\u3066\u305f\u306e\u3067\u3001PostgreSQL\u3078\u306e\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u3082\u5fc5\u8981\n\u8a8d\u8a3c\u306fOpenLDAP\u4f7f\u3063\u3066\u305f\u306e\u3067\u3001\u305d\u308c\u3082\u79fb\u884c\u3059\u308b\n\u30bd\u30fc\u30b9\u306f\u5916\u306b\u6f0f\u3089\u3057\u305f\u304f\u306a\u3044\u306e\u3067\u3001AWS\u4e0a\u306e\u30c7\u30a3\u30b9\u30af(EBS)\u306f\u6697\u53f7\u5316\u3057\u3064\u3064\u3001\u63a5\u7d9a\u5143IP\u30a2\u30c9\u30ec\u30b9\u3082\u7d5e\u308b\nSSL\u306fELB\u3067\u7d42\u7aef\u3059\u308b\n\n\u5f53\u521d non-Omnibus 6.9.2 -> Omnibus 6.9.2 -> Omnibus 8.13.1 \u3067\u3084\u3063\u305f\u304c\u3001\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306e\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u304c\u901a\u3089\u306a\u304b\u3063\u305f\u306e\u3067\u3001\u4e00\u65e6 Omnibus 7.13.5 \u3092\u7d4c\u7531\u3059\u308b\u624b\u9806\u306b\u3057\u305f\u3002\n\n\u79fb\u884c\u5148\u74b0\u5883\u3092\u6e96\u5099\u3059\u308b\n\u5e73\u65e5\u663c\u9593\u306b\u30d4\u30fc\u30af\u304c\u60f3\u5b9a\u3055\u308c\u308b\u306e\u3067\u3001\u30d0\u30fc\u30b9\u30c8\u3067\u304d\u308bT2\u3092\u63a1\u7528\u3002\n\u30e1\u30e2\u30ea\u306f4GB\u3050\u3089\u3044\u307b\u3057\u3044\u306e\u3067\u3001t2.medium\u3067\u3002\nAmazon Linux\u3067\u3044\u304d\u307e\u3057\u3087\u3046\u3002\n\n\u30c7\u30a3\u30b9\u30af\u3092\u4f5c\u308b\n\n\u73fe\u5728\u306e\u4f7f\u3044\u65b9\u3092\u307f\u3064\u3064\u3001\u30c7\u30a3\u30b9\u30af\u30ec\u30a4\u30a2\u30a6\u30c8\u3092\u6c7a\u3081\u308b\n\u5f8c\u3067\u62e1\u5f35\u3067\u304d\u308b\u3088\u3046\u306bLVM\u306b\u3057\u3066\u304a\u304f\nOmnibus \u306b\u3059\u308b\u3068 /opt/gitlab \u306b\u672c\u4f53\u3001 /var/opt/gitlab\u306b\u8a2d\u5b9a\u3068\u304b\u30ea\u30dd\u30b8\u30c8\u30ea\u3068\u304b\u304c\u5165\u308b\n\n/opt            10GB    10GB\u306eEBS(gp2)\u3001LVM\n/var/opt        300GB  300GB\u306eEBS(gp2)\u3001LVM\n/home           20GB    20GB\u306eEBS(gp2)\u3001LVM\n\n\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u3092\u4f5c\u6210\u3002/opt\u3068/home\u306b\u306f\u65e2\u306b\u30d5\u30a1\u30a4\u30eb\u304c\u5b58\u5728\u3059\u308b\u306e\u3067\u3001\u30b3\u30d4\u30fc\u3057\u3066\u304a\u304f\u3002\n$ sudo fdisk /dev/xvdb\n$ sudo fdisk /dev/xvdc\n$ sudo fdisk /dev/xvdd\n\n$ sudo pvcreate /dev/xvdb1\n$ sudo pvcreate /dev/xvdc1\n$ sudo pvcreate /dev/xvdd1\n\n$ sudo vgcreate VG01 /dev/xvdb1\n$ sudo vgcreate VG02 /dev/xvdc1\n$ sudo vgcreate VG03 /dev/xvdd1\n\n$ sudo lvcreate -l 100%FREE -n LogVol01 VG01\n$ sudo lvcreate -l 100%FREE -n LogVol01 VG02\n$ sudo lvcreate -l 100%FREE -n LogVol01 VG03\n\n$ sudo mkfs.ext4 /dev/mapper/VG01-LogVol01\n$ sudo mkfs.ext4 /dev/mapper/VG02-LogVol01\n$ sudo mkfs.ext4 /dev/mapper/VG03-LogVol01\n\n$ sudo e2label /dev/mapper/VG01-LogVol01 /opt\n$ sudo e2label /dev/mapper/VG02-LogVol01 /var/opt\n$ sudo e2label /dev/mapper/VG03-LogVol01 /home\n\n$ sudo mount LABEL=/opt /mnt\n$ sudo cp -ax /opt/* /mnt/\n$ sudo umount /mnt\n\n$ sudo mount LABEL=/home /mnt\n$ sudo cp -ax /home/* /mnt/\n$ sudo umount /mnt\n\n$ sudo mv /opt{,_old}\n$ sudo mv /home{,_old}\n\n$ sudo mkdir /opt\n$ sudo mkdir /home\n\n$ sudo mount LABEL=/home /home\n$ sudo mount LABEL=/opt /opt\n$ sudo mount LABEL=/var/opt /var/opt\n\n$ sudo vi /etc/fstab\n\nLABEL=/home /home       ext4    defaults        1   2\nLABEL=/opt  /opt        ext4    defaults        1   2\nLABEL=/var/opt /var/opt ext4    defaults        1   2\n\nGitLab\u306e\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u304b\u3089\u306e\u30ea\u30b9\u30c8\u30a2\u6642\u306b\u4e00\u6642\u30d5\u30a1\u30a4\u30eb\u304c/tmp\u4ee5\u4e0b\u306b\u5c55\u958b\u3055\u308c\u308b\u306e\u3067\u3001\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u30d5\u30a1\u30a4\u30eb\u3068\u540c\u7a0b\u5ea6\u306e\u5bb9\u91cf\u304c/tmp\u3067\u4f7f\u7528\u3067\u304d\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3057\u3066\u304a\u304f\u3002\n$ df -lh\nFilesystem                 Size  Used Avail Use% Mounted on\ndevtmpfs                   2.0G   92K  2.0G   1% /dev\ntmpfs                      2.0G     0  2.0G   0% /dev/shm\n/dev/xvda1                 7.8G  1.1G  6.7G  14% /\n/dev/mapper/VG03-LogVol01   20G   44M   19G   1% /home\n/dev/mapper/VG01-LogVol01  9.8G   65M  9.2G   1% /opt\n/dev/mapper/VG02-LogVol01  296G   63M  281G   1% /var/opt\n\n$ sudo reboot\n\n\nOmnibus 6.9.2\u3092\u5165\u308c\u308b\n\n\u306a\u306b\u306f\u3068\u3082\u3042\u308c\u3001yum update\nGitLab\u306eYum\u30ea\u30dd\u30b8\u30c8\u30ea\u306b\u306f 6.9.2 \u304c\u306a\u3044\u306e\u3067\u3001\u624b\u52d5\u3067\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u3066 localinstall\u3059\u308b\n\n$ sudo yum update -y\n\n\u79fb\u884c\u5143\u3068\u540c\u3058\u30d0\u30fc\u30b8\u30e7\u30f3\u306eOmnibus\u30d1\u30c3\u30b1\u30fc\u30b8\u3092\u63a2\u3059\u3002\nhttps://about.gitlab.com/downloads/archives/\n6.9.2\u306f\u3053\u3061\u3089\u2193\nhttps://downloads-packages.s3.amazonaws.com/centos-6.5/gitlab-6.9.2_omnibus.2-1.el6.x86_64.rpm\n$ curl -LJO https://downloads-packages.s3.amazonaws.com/centos-6.5/gitlab-6.9.2_omnibus.2-1.el6.x86_64.rpm\n$ sudo yum localinstall gitlab-6.9.2_omnibus.2-1.el6.x86_64.rpm\n$ sudo gitlab-ctl reconfigure\n\n\n\u30aa\u30f3\u30d7\u30ec\u3067\u79fb\u884c\u3059\u308b\u30c7\u30fc\u30bf\u3092\u4f5c\u3063\u3066\u79fb\u884c\u5148\u306b\u30b3\u30d4\u30fc\u3059\u308b\n\n\u30aa\u30f3\u30d7\u30ec\u3067\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u3092\u3068\u308b\n\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u90e8\u5206\u306e\u30d5\u30a1\u30a4\u30eb\u306e\u307f MySQL -> PostgreSQL\u306b\u5909\u63db\u3057\u3066\u304b\u3089\u5dee\u3057\u66ff\u3048\u308b\nLDAP\u3082\u30c0\u30f3\u30d7\u3057\u3066\u6301\u3063\u3066\u3044\u304f\nscp\u306a\u3069\u3067\u79fb\u884c\u5148\u306b\u30b3\u30d4\u30fc\u3059\u308b\n\n\nUpdating GitLab via omnibus-gitlab\nhttps://docs.gitlab.com/omnibus/update/README.html#upgrading-from-non-omnibus-mysql-to-an-omnibus-installation-version-68\n\n\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u3068MySQL\u306e\u30c0\u30f3\u30d7\u3092PostgreSQL\u30d5\u30ec\u30f3\u30c9\u30ea\u30fc\u306a\u30aa\u30d7\u30b7\u30e7\u30f3\u3092\u3064\u3051\u3066\u3068\u3063\u3066\u304a\u304f\u3002\nGitLab\u3092\u6b62\u3081\u3066\u304b\u3089\u3001\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u3092\u4f5c\u308b\u3002\n$ sudo systemctl stop nginx gitlab\n$ cd /home/git/gitlab\n$ sudo -u git -H bundle exec rake gitlab:backup:create RAILS_ENV=production\n\nMySQL\u306e\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u30d5\u30a1\u30a4\u30eb\u3092PostgreSQL\u306b\u5909\u63db\u3057\u3066\u5dee\u3057\u66ff\u3048\u308b\u3002\n$ sudo -u git -H mkdir -p tmp/backups/postgresql\n$ sudo -u git -H mv tmp/backups/TIMESTAMP_gitlab_backup.tar tmp/backups/postgresql/\n\n\u203bTIMESTAMP\u306f\u9069\u5b9c\u8aad\u307f\u66ff\u3048\u308b\u3053\u3068\u3002\nPostgreSQL\u30b3\u30f3\u30d1\u30c1\u5f62\u5f0f\u3067MySQL\u306e\u30c0\u30f3\u30d7\u3092\u5410\u304d\u51fa\u3059\u3002\n$ cd tmp/backups/postgresql\n$ sudo -u git -H mysqldump --compatible=postgresql --default-character-set=utf8 -r gitlabhq_production.mysql -u root gitlabhq_production -p\n\n\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u30b3\u30f3\u30d0\u30fc\u30bf\u30fc\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3059\u308b\u3002\n$ sudo -u git -H git clone https://github.com/gitlabhq/mysql-postgresql-converter.git -b gitlab\n\nMySQL\u306e\u30c0\u30f3\u30d7\u3092PostgreSQL\u306b\u5909\u63db\u3059\u308b\u3002\n$ sudo -u git -H mkdir db\n$ sudo -u git -H python mysql-postgresql-converter/db_converter.py gitlabhq_production.mysql db/database.sql\n$ sudo -u git -H ed -s db/database.sql < mysql-postgresql-converter/move_drop_indexes.ed\n\n\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u30d5\u30a1\u30a4\u30eb\u306e\u4e2d\u306e\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u90e8\u5206(tar\u306e\u4e2d\u8eab)\u3092\u5dee\u3057\u66ff\u3048\u308b\u3002\n$ sudo -u git -H tar rf TIMESTAMP_gitlab_backup.tar db/database.sql\n\n\u3053\u308c\u3092\u79fb\u884c\u5148\u30b5\u30fc\u30d0\u30fc\u306b\u30b3\u30d4\u30fc\u3002\n$ scp -i .ssh/yoursshkey.pem TIMESTAMP_gitlab_backup.tar ec2-user@ec2-xx-xx-xx-xx.ap-northeast-1.compute.amazonaws.com:~\n\nLDAP\u3082\u30c0\u30f3\u30d7\u3057\u3066\u6301\u3063\u3066\u3044\u304f\u3002\n$ mkdir ldap_backup\n$ sudo slapcat -l ldap_backup/backup.ldif\n$ sudo slapcat -b cn=config -l ldap_backup/backup_config.ldif\n$ tar zcvf ldap_backup.tar.gz ldap_backup\n\nscp \u3067\u30aa\u30f3\u30d7\u30ec\u304b\u3089\u79fb\u884c\u5148\u306b\u30b3\u30d4\u30fc\u3059\u308b\u3002\n$ scp -i .ssh/yoursshkey.pem ldap_backup.tar.gz ec2-user@ec2-xx-xx-xx-xx.ap-northeast-1.compute.amazonaws.com:~\n\n\n\u79fb\u884c\u5148\u3067\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u304b\u3089\u5fa9\u5143\u3059\u308b\n\nhttps://gitlab.com/gitlab-org/omnibus-gitlab/blob/98b1bfb0d70082953d63abbc329cd6f2c628d3bc/README.md#restoring-an-application-backup\n\nOmnibus\u306eGitlab\u306e\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306b\u3001PostgreSQL\u5909\u63db\u6e08\u307f\u306e\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u30d5\u30a1\u30a4\u30eb\u3092\u7f6e\u304f\u3002\n$ sudo cp TIMESTAMP_gitlab_backup.tar /var/opt/gitlab/backups/\n\nGitlab(unicorn\u3068sidekiq)\u3092\u505c\u6b62\u3057\u3066\u3001\u30ea\u30b9\u30c8\u30a2\u30b3\u30de\u30f3\u30c9\u3092\u767a\u884c\u3059\u308b\u3002\n$ sudo gitlab-ctl stop unicorn\nok: down: unicorn: 0s, normally up\n\n$ sudo gitlab-ctl stop sidekiq\nok: down: sidekiq: 0s, normally up\n\n$ sudo gitlab-rake gitlab:backup:restore BACKUP=TIMESTAMP\n\n$ sudo gitlab-ctl start\n\n\nLDAP\u306fOpenLDAP Server\u3092\u65b0\u3057\u304f\u4f5c\u3063\u3066\u3001\u30c0\u30f3\u30d7\u3057\u305f\u30d5\u30a1\u30a4\u30eb(LDIF)\u3092\u898b\u306a\u304c\u3089\u623b\u3057\u3066\u3044\u304f\n$ sudo yum install openldap-servers openldap-clients openldap\n$ sudo cp /usr/share/openldap-servers/DB_CONFIG.example /var/lib/ldap/DB_CONFIG\n$ sudo vi /etc/rsyslog.conf\n\n\n--- /etc/rsyslog.conf.back      2014-11-11 00:28:01.000000000 +0000\n+++ /etc/rsyslog.conf   2016-10-29 10:03:11.405303294 +0000\n@@ -56,6 +56,8 @@\n # Save boot messages also to boot.log\n local7.*                                                /var/log/boot.log\n\n+# Ldap\n+local4.*                                               /var/log/slapd.log\n\n # ### begin forwarding rule ###\n # The statement between the begin ... end define a SINGLE forwarding\n\n\n$ sudo service rsyslog restart\n\n\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u30d5\u30a1\u30a4\u30eb\u3092\u3082\u3068\u306b\u3001LDAP\u3092\u69cb\u6210\u3057\u3066\u3044\u304f\u3002\n$ sudo service slapd start\n$ sudo ldapadd -Y EXTERNAL -H ldapi:// -f 1_change_RootPW.ldif\n$ sudo ldapmodify -x -D cn=config -W -f ./2_initial_config.ldif\n$ sudo ldapadd -x -D \"cn=Manager,dc=r-stack,dc=jp\" -W -f 3_add_base.ldif\n$ sudo ldapadd -x -D \"cn=Manager,dc=r-stack,dc=jp\" -W -f 4_add_users.ldif\n\n$ sudo chkconfig slapd on\n\n\u3054\u53c2\u8003\u307e\u3067\u306b\u3001\u5404\u30d5\u30a1\u30a4\u30eb\u306f\u3053\u3093\u306a\u611f\u3058\u3067\u3059\u3002\n\n1_change_RootPW.ldif \n\ndn: olcDatabase={0}config,cn=config\nchangetype: modify\nadd: olcRootPW\nolcRootPW: {SSHA}XXXXXXXXXXXXXXXXXXXXXXXXXXXXX\n\n\n2_initial_config.ldif \n\ndn: olcDatabase={1}monitor,cn=config\nchangetype: modify\nreplace: olcAccess\nolcAccess: {0}to * by dn.base=\"gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth\" read by dn.base=\"cn=Manager,dc=example,dc=com\" read by * none\n\ndn: olcDatabase={2}bdb,cn=config\nchangetype: modify\nreplace: olcSuffix\nolcSuffix: dc=example,dc=com\n\ndn: olcDatabase={2}bdb,cn=config\nchangetype: modify\nreplace: olcRootDN\nolcRootDN: cn=Manager,dc=example,dc=com\n\ndn: olcDatabase={2}bdb,cn=config\nchangetype: modify\nreplace: olcRootPW\nolcRootPW: {SSHA}XXXXXXXXXXXXXXXXXXX\n\n\n3_add_base.ldif\n\ndn: dc=example,dc=com\nobjectClass: dcObject\nobjectClass: organization\no: example.com\ndc: example\n\ndn: cn=Manager,dc=example,dc=com\nobjectClass: organizationalRole\nobjectClass: simpleSecurityObject\ncn: Manager\ndescription: LDAP Administrator\nuserPassword:: XXXXXXXXXXXXXXXXXXXXXXXX\n\ndn: ou=People,dc=example,dc=com\nobjectClass: organizationalUnit\nou: People\n\ndn: ou=Group,dc=example,dc=com\nobjectClass: organizationalUnit\nou: Group\n\n\n4_add_users.ldif\n\ndn: ou=Sales,ou=Group,dc=example,dc=com\nobjectClass: groupOfNames\nobjectClass: top\ncn: Sales\nmember: cn=user1,ou=People,dc=example,dc=com\nou: Sales\n\ndn: cn=Taro Nihon,ou=People,dc=example,dc=com\nobjectClass: inetOrgPerson\nobjectClass: organizationalPerson\nobjectClass: person\nobjectClass: top\ncn: Taro Nihon\nsn: Nihon\nuid: user1\nmail: user1@example.com\no: Example, Inc.\nou: Sales\nuserPassword:: XXXXXXXXXXXXXXXXXXXX\n\n... snip ...\n\n\n\nGitLab\u306e\u521d\u671f\u8a2d\u5b9a\n\nOmnibus\u306eGitLab\u306f\u3001/etc/gitlab/gitlab.rb \u7d4c\u7531\u3067\u8a2d\u5b9a\u3059\u308b\n\u76f4\u63a5 gitlab.yml \u3068\u304b\u3092\u3044\u3058\u3063\u3066\u3082 gitlab-ctl reconfigure \u3059\u308b\u3068\u6d88\u3048\u308b\u306e\u3067\u6ce8\u610f\n\n$ sudo vi /etc/gitlab/gitlab.rb\n$ sudo gitlab-ctl reconfigure\n$ sudo gitlab-rake gitlab:check\n\n... snip ...\n\nLDAP users with access to your GitLab server (only showing the first 100 results)\nrake aborted!\nArgumentError: host,port,method,uid or filter,base MUST be provided\n\n\u306a\u305c\u304bLDAP\u95a2\u9023\u30d1\u30e9\u30e1\u30fc\u30bf\u304cgitlab.yml\u306b\u53cd\u6620\u3055\u308c\u3066\u306a\u3044\u3002\u30d0\u30b0\u3063\u307d\u3044\u306e\u3067\u30d0\u30fc\u30b8\u30e7\u30f3\u30a2\u30c3\u30d7\u3059\u308b\u3068\u76f4\u308b\u3068\u4fe1\u3058\u3066\u3001\u3068\u308a\u3042\u3048\u305a\u624b\u52d5\u3067\u8a2d\u5b9a\u3059\u308b\u3002\n\n\u79fb\u884c\u5148\u30b5\u30fc\u30d0\u30fc\u3067\u306e Omnibus 6.9.2\u306e\u52d5\u4f5c\u78ba\u8a8d\n\n\u3053\u306e\u6642\u70b9\u3067\u30d6\u30e9\u30a6\u30b6\u3067\u63a5\u7d9a\u3057\u3066\u307f\u3066\u3001\u3061\u3083\u3093\u3068\u30c7\u30fc\u30bf\u304c\u79fb\u3063\u3066\u3044\u308b\u304b\u3001\u3061\u3083\u3093\u3068\u52d5\u304f\u304b\u3001\u306a\u3069\u78ba\u8a8d\n\u30ea\u30d0\u30d7\u30ed\u3084ELB\u306a\u3069\u3067SSL\u3092\u7d42\u7aef\u3057\u3066\u3044\u308b\u69cb\u6210\u3060\u3068\u3001\u516c\u5f0f\u624b\u9806\u3067\u3084\u3063\u3066\u305f\u3089\u30a2\u30d0\u30bf\u30fc\u306e\u753b\u50cf\u304c\u898b\u308c\u306a\u3044\n\n\nhttps://gitlab.com/gitlab-org/gitlab-ce/issues/14287\n\nStatic\u30b3\u30f3\u30c6\u30f3\u30c4\u3082Unicorn\u3067\u51e6\u7406\u3055\u305b\u3088\u3046\u3068\u3057\u3066\u3044\u308b\u306e\u3067\u3001Unicorn\u3067\u51e6\u7406\u3057\u3066\u304f\u308c\u308c\u3070\u305d\u308c\u306f\u305d\u308c\u3067\u3044\u3044\u3093\u3067\u3059\u304c\u3001URL\u751f\u6210\u3059\u308b\u969b\u306b\u5916\u90e8URL\u3067\u306f\u306a\u304f\u3066\u5185\u90e8URL(HTTP)\u3092\u3068\u3063\u3066\u304d\u3061\u3083\u3063\u3066\u307e\u3059\u3002\n\nhttps://gitlab.com/gitlab-org/gitlab-ce/blob/master/app/models/user.rb#L673\n\n\u3068\u3044\u3046\u3053\u3068\u3067\u3001\u7121\u7406\u304f\u308aNginx\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092\u76f4\u63a5\u3044\u3058\u3063\u3066\u3001/uploads\u3092Static\u30db\u30b9\u30c6\u30a3\u30f3\u30b0\u3059\u308b\u3088\u3046\u306b\u3057\u3066\u304a\u304f\u3002gitlab-ctl reconfigure\u3059\u308b\u3068\u4e0a\u66f8\u304d\u3055\u308c\u308b\u306e\u3067\u8981\u6ce8\u610f\u3002\n$ sudo vi /var/opt/gitlab/nginx/etc/gitlab-http.conf\n\n... snip ...\n\n  location /uploads {\n    root /var/opt/gitlab/gitlab-rails/uploads;\n  }\n\n\n\nGitLab\u3092\u6bb5\u968e\u30a2\u30c3\u30d7\u30c7\u30fc\u30c8\u3092\u3059\u308b\n\n\u3044\u304d\u306a\u308a\u6700\u65b0\u7248\u306e8.x\u306b\u3044\u304f\u3068\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306e\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u306b\u5931\u6557\u3059\u308b\n6.9.2 -> 7.14.3 -> 8.13.1 \u3068\u6bb5\u968e\u30a2\u30c3\u30d7\u30c7\u30fc\u30c8\u3059\u308b\n\n\u30a2\u30c3\u30d7\u30c7\u30fc\u30c8\u306e\u4ed5\u65b9\u306f\u3001\u516c\u5f0f\u30b5\u30a4\u30c8\u306e\u624b\u9806\u306e\u3068\u304a\u308a\u3002\n\nhttps://about.gitlab.com/downloads/#centos6\n\n$ sudo yum install postfix\n\n$ sudo service sendmail stop\nShutting down sm-client:                                   [  OK  ]\nShutting down sendmail:                                    [  OK  ]\n$ sudo chkconfig sendmail off\n$ sudo service postfix start\nStarting postfix:                                          [  OK  ]\n$ sudo chkconfig postfix on\n$ sudo alternatives --config mta\n\nThere are 2 programs which provide 'mta'.\n\n  Selection    Command\n-----------------------------------------------\n*+ 1           /usr/sbin/sendmail.sendmail\n   2           /usr/sbin/sendmail.postfix\n\nEnter to keep the current selection[+], or type selection number: 2\n\n... snip ...\n\n$ curl -sS https://packages.gitlab.com/install/repositories/gitlab/gitlab-ce/script.rpm.sh | sudo bash\n$ sudo yum install gitlab-ce-7.13.5\n$ sudo gitlab-ctl reconfigure\n$ sudo gitlab-rake gitlab:check\n\n...snip...\n\nCI / portal ... no\n  Try fixing it:\n  sudo -u git -H bundle exec rake gitlab:satellites:create RAILS_ENV=production\n  If necessary, remove the tmp/repo_satellites directory ...\n  ... and rerun the above command\n  For more information see:\n  doc/raketasks/maintenance.md\n  Please fix the error above and rerun the checks.\n\nsatellites\u304c\u306a\u3044\u3068\u6012\u3089\u308c\u308b\u306e\u3067\u3001\u4f5c\u3063\u3066\u304a\u304f\u3002\n$ sudo gitlab-rake gitlab:satellites:create RAILS_ENV=production\n$ sudo gitlab-rake gitlab:check\n\n7.14.3 \u3092\u5165\u308c\u308b\u3002\n$ sudo yum update gitlab-ce-7.14.3\n$ sudo gitlab-ctl reconfigure\n$ sudo gitlab-rake gitlab:check\n\n\u52d5\u4f5c\u78ba\u8a8d\u3057\u305f\u3089\u30018.13.1\u3092\u5165\u308c\u308b\u3002\n$ sudo yum update gitlab-ce-8.13.1\n$ sudo gitlab-ctl reconfigure\n$ sudo gitlab-rake gitlab:check\n\n\u5fd8\u308c\u305a\u306bNginx\u306e\u8a2d\u5b9a\u3092\u76f4\u3057\u3066\u304a\u304f\u3002\n\n$ sudo vi /var/opt/gitlab/nginx/etc/gitlab-http.conf\n\n  location /uploads {\n    root /var/opt/gitlab/gitlab-rails/uploads;\n  }\n\n$ sudo gitlab-ctl restart nginx\n\n\u304a\u3057\u307e\u3044\u3002\n## \u6982\u8981\n- \u30aa\u30f3\u30d7\u30ec\u306b\u3042\u3063\u305fOpenStack\u306eVM\u00d71\u53f0\u3092AWS\u4e0a\u306eEC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u00d71\u53f0\u306b\u79fb\u884c\u3059\u308b\n- \u540c\u6642\u306bGitLab\u3092\u73fe\u6642\u70b9\u306e\u6700\u65b0\u7248 8.13.1 \u306b\u30d0\u30fc\u30b8\u30e7\u30f3\u30a2\u30c3\u30d7\u3059\u308b\n- MySQL(\u5b9f\u969b\u306fMariaDB)\u3067\u52d5\u304b\u3057\u3066\u305f\u306e\u3067\u3001PostgreSQL\u3078\u306e\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u3082\u5fc5\u8981\n- \u8a8d\u8a3c\u306fOpenLDAP\u4f7f\u3063\u3066\u305f\u306e\u3067\u3001\u305d\u308c\u3082\u79fb\u884c\u3059\u308b\n- \u30bd\u30fc\u30b9\u306f\u5916\u306b\u6f0f\u3089\u3057\u305f\u304f\u306a\u3044\u306e\u3067\u3001AWS\u4e0a\u306e\u30c7\u30a3\u30b9\u30af(EBS)\u306f\u6697\u53f7\u5316\u3057\u3064\u3064\u3001\u63a5\u7d9a\u5143IP\u30a2\u30c9\u30ec\u30b9\u3082\u7d5e\u308b\n- SSL\u306fELB\u3067\u7d42\u7aef\u3059\u308b\n\n\u5f53\u521d non-Omnibus 6.9.2 -> Omnibus 6.9.2 -> Omnibus 8.13.1 \u3067\u3084\u3063\u305f\u304c\u3001\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306e\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u304c\u901a\u3089\u306a\u304b\u3063\u305f\u306e\u3067\u3001\u4e00\u65e6 Omnibus 7.13.5 \u3092\u7d4c\u7531\u3059\u308b\u624b\u9806\u306b\u3057\u305f\u3002\n\n## \u79fb\u884c\u5148\u74b0\u5883\u3092\u6e96\u5099\u3059\u308b\n\u5e73\u65e5\u663c\u9593\u306b\u30d4\u30fc\u30af\u304c\u60f3\u5b9a\u3055\u308c\u308b\u306e\u3067\u3001\u30d0\u30fc\u30b9\u30c8\u3067\u304d\u308bT2\u3092\u63a1\u7528\u3002\n\u30e1\u30e2\u30ea\u306f4GB\u3050\u3089\u3044\u307b\u3057\u3044\u306e\u3067\u3001t2.medium\u3067\u3002\nAmazon Linux\u3067\u3044\u304d\u307e\u3057\u3087\u3046\u3002\n\n### \u30c7\u30a3\u30b9\u30af\u3092\u4f5c\u308b\n\n - \u73fe\u5728\u306e\u4f7f\u3044\u65b9\u3092\u307f\u3064\u3064\u3001\u30c7\u30a3\u30b9\u30af\u30ec\u30a4\u30a2\u30a6\u30c8\u3092\u6c7a\u3081\u308b\n - \u5f8c\u3067\u62e1\u5f35\u3067\u304d\u308b\u3088\u3046\u306bLVM\u306b\u3057\u3066\u304a\u304f\n - Omnibus \u306b\u3059\u308b\u3068 `/opt/gitlab` \u306b\u672c\u4f53\u3001 `/var/opt/gitlab`\u306b\u8a2d\u5b9a\u3068\u304b\u30ea\u30dd\u30b8\u30c8\u30ea\u3068\u304b\u304c\u5165\u308b\n\n```\n/opt            10GB    10GB\u306eEBS(gp2)\u3001LVM\n/var/opt        300GB  300GB\u306eEBS(gp2)\u3001LVM\n/home           20GB    20GB\u306eEBS(gp2)\u3001LVM\n```\n\n\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u3092\u4f5c\u6210\u3002`/opt`\u3068`/home`\u306b\u306f\u65e2\u306b\u30d5\u30a1\u30a4\u30eb\u304c\u5b58\u5728\u3059\u308b\u306e\u3067\u3001\u30b3\u30d4\u30fc\u3057\u3066\u304a\u304f\u3002\n\n```shell-session\n$ sudo fdisk /dev/xvdb\n$ sudo fdisk /dev/xvdc\n$ sudo fdisk /dev/xvdd\n\n$ sudo pvcreate /dev/xvdb1\n$ sudo pvcreate /dev/xvdc1\n$ sudo pvcreate /dev/xvdd1\n\n$ sudo vgcreate VG01 /dev/xvdb1\n$ sudo vgcreate VG02 /dev/xvdc1\n$ sudo vgcreate VG03 /dev/xvdd1\n\n$ sudo lvcreate -l 100%FREE -n LogVol01 VG01\n$ sudo lvcreate -l 100%FREE -n LogVol01 VG02\n$ sudo lvcreate -l 100%FREE -n LogVol01 VG03\n\n$ sudo mkfs.ext4 /dev/mapper/VG01-LogVol01\n$ sudo mkfs.ext4 /dev/mapper/VG02-LogVol01\n$ sudo mkfs.ext4 /dev/mapper/VG03-LogVol01\n\n$ sudo e2label /dev/mapper/VG01-LogVol01 /opt\n$ sudo e2label /dev/mapper/VG02-LogVol01 /var/opt\n$ sudo e2label /dev/mapper/VG03-LogVol01 /home\n```\n\n```shell-session\n$ sudo mount LABEL=/opt /mnt\n$ sudo cp -ax /opt/* /mnt/\n$ sudo umount /mnt\n\n$ sudo mount LABEL=/home /mnt\n$ sudo cp -ax /home/* /mnt/\n$ sudo umount /mnt\n\n$ sudo mv /opt{,_old}\n$ sudo mv /home{,_old}\n\n$ sudo mkdir /opt\n$ sudo mkdir /home\n\n$ sudo mount LABEL=/home /home\n$ sudo mount LABEL=/opt /opt\n$ sudo mount LABEL=/var/opt /var/opt\n\n$ sudo vi /etc/fstab\n\nLABEL=/home /home       ext4    defaults        1   2\nLABEL=/opt  /opt        ext4    defaults        1   2\nLABEL=/var/opt /var/opt ext4    defaults        1   2\n```\n\nGitLab\u306e\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u304b\u3089\u306e\u30ea\u30b9\u30c8\u30a2\u6642\u306b\u4e00\u6642\u30d5\u30a1\u30a4\u30eb\u304c/tmp\u4ee5\u4e0b\u306b\u5c55\u958b\u3055\u308c\u308b\u306e\u3067\u3001\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u30d5\u30a1\u30a4\u30eb\u3068\u540c\u7a0b\u5ea6\u306e\u5bb9\u91cf\u304c/tmp\u3067\u4f7f\u7528\u3067\u304d\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3057\u3066\u304a\u304f\u3002\n\n```shell-session\n$ df -lh\nFilesystem                 Size  Used Avail Use% Mounted on\ndevtmpfs                   2.0G   92K  2.0G   1% /dev\ntmpfs                      2.0G     0  2.0G   0% /dev/shm\n/dev/xvda1                 7.8G  1.1G  6.7G  14% /\n/dev/mapper/VG03-LogVol01   20G   44M   19G   1% /home\n/dev/mapper/VG01-LogVol01  9.8G   65M  9.2G   1% /opt\n/dev/mapper/VG02-LogVol01  296G   63M  281G   1% /var/opt\n```\n\n```shell-session\n$ sudo reboot\n```\n\n## Omnibus 6.9.2\u3092\u5165\u308c\u308b\n\n - \u306a\u306b\u306f\u3068\u3082\u3042\u308c\u3001yum update\n - GitLab\u306eYum\u30ea\u30dd\u30b8\u30c8\u30ea\u306b\u306f 6.9.2 \u304c\u306a\u3044\u306e\u3067\u3001\u624b\u52d5\u3067\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u3066 localinstall\u3059\u308b\n\n```shell-session\n$ sudo yum update -y\n```\n\n\u79fb\u884c\u5143\u3068\u540c\u3058\u30d0\u30fc\u30b8\u30e7\u30f3\u306eOmnibus\u30d1\u30c3\u30b1\u30fc\u30b8\u3092\u63a2\u3059\u3002\n\nhttps://about.gitlab.com/downloads/archives/\n\n6.9.2\u306f\u3053\u3061\u3089\u2193\n\nhttps://downloads-packages.s3.amazonaws.com/centos-6.5/gitlab-6.9.2_omnibus.2-1.el6.x86_64.rpm\n\n```shell-session\n$ curl -LJO https://downloads-packages.s3.amazonaws.com/centos-6.5/gitlab-6.9.2_omnibus.2-1.el6.x86_64.rpm\n$ sudo yum localinstall gitlab-6.9.2_omnibus.2-1.el6.x86_64.rpm\n$ sudo gitlab-ctl reconfigure\n```\n\n## \u30aa\u30f3\u30d7\u30ec\u3067\u79fb\u884c\u3059\u308b\u30c7\u30fc\u30bf\u3092\u4f5c\u3063\u3066\u79fb\u884c\u5148\u306b\u30b3\u30d4\u30fc\u3059\u308b\n\n - \u30aa\u30f3\u30d7\u30ec\u3067\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u3092\u3068\u308b\n - \u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u90e8\u5206\u306e\u30d5\u30a1\u30a4\u30eb\u306e\u307f MySQL -> PostgreSQL\u306b\u5909\u63db\u3057\u3066\u304b\u3089\u5dee\u3057\u66ff\u3048\u308b\n - LDAP\u3082\u30c0\u30f3\u30d7\u3057\u3066\u6301\u3063\u3066\u3044\u304f\n - scp\u306a\u3069\u3067\u79fb\u884c\u5148\u306b\u30b3\u30d4\u30fc\u3059\u308b\n\n> Updating GitLab via omnibus-gitlab\n> https://docs.gitlab.com/omnibus/update/README.html#upgrading-from-non-omnibus-mysql-to-an-omnibus-installation-version-68\n\n\n\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u3068MySQL\u306e\u30c0\u30f3\u30d7\u3092PostgreSQL\u30d5\u30ec\u30f3\u30c9\u30ea\u30fc\u306a\u30aa\u30d7\u30b7\u30e7\u30f3\u3092\u3064\u3051\u3066\u3068\u3063\u3066\u304a\u304f\u3002\n\nGitLab\u3092\u6b62\u3081\u3066\u304b\u3089\u3001\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u3092\u4f5c\u308b\u3002\n\n```shell-session\n$ sudo systemctl stop nginx gitlab\n$ cd /home/git/gitlab\n$ sudo -u git -H bundle exec rake gitlab:backup:create RAILS_ENV=production\n```\n\nMySQL\u306e\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u30d5\u30a1\u30a4\u30eb\u3092PostgreSQL\u306b\u5909\u63db\u3057\u3066\u5dee\u3057\u66ff\u3048\u308b\u3002\n\n```shell-session\n$ sudo -u git -H mkdir -p tmp/backups/postgresql\n$ sudo -u git -H mv tmp/backups/TIMESTAMP_gitlab_backup.tar tmp/backups/postgresql/\n```\n\n\u203bTIMESTAMP\u306f\u9069\u5b9c\u8aad\u307f\u66ff\u3048\u308b\u3053\u3068\u3002\n\nPostgreSQL\u30b3\u30f3\u30d1\u30c1\u5f62\u5f0f\u3067MySQL\u306e\u30c0\u30f3\u30d7\u3092\u5410\u304d\u51fa\u3059\u3002\n\n```shell-session\n$ cd tmp/backups/postgresql\n$ sudo -u git -H mysqldump --compatible=postgresql --default-character-set=utf8 -r gitlabhq_production.mysql -u root gitlabhq_production -p\n```\n\n\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u30b3\u30f3\u30d0\u30fc\u30bf\u30fc\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3059\u308b\u3002\n\n```shell-session\n$ sudo -u git -H git clone https://github.com/gitlabhq/mysql-postgresql-converter.git -b gitlab\n```\n\nMySQL\u306e\u30c0\u30f3\u30d7\u3092PostgreSQL\u306b\u5909\u63db\u3059\u308b\u3002\n\n```shell-session\n$ sudo -u git -H mkdir db\n$ sudo -u git -H python mysql-postgresql-converter/db_converter.py gitlabhq_production.mysql db/database.sql\n$ sudo -u git -H ed -s db/database.sql < mysql-postgresql-converter/move_drop_indexes.ed\n```\n\n\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u30d5\u30a1\u30a4\u30eb\u306e\u4e2d\u306e\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u90e8\u5206(tar\u306e\u4e2d\u8eab)\u3092\u5dee\u3057\u66ff\u3048\u308b\u3002\n\n```shell-session\n$ sudo -u git -H tar rf TIMESTAMP_gitlab_backup.tar db/database.sql\n```\n\n\u3053\u308c\u3092\u79fb\u884c\u5148\u30b5\u30fc\u30d0\u30fc\u306b\u30b3\u30d4\u30fc\u3002\n\n```shell-session\n$ scp -i .ssh/yoursshkey.pem TIMESTAMP_gitlab_backup.tar ec2-user@ec2-xx-xx-xx-xx.ap-northeast-1.compute.amazonaws.com:~\n```\n\nLDAP\u3082\u30c0\u30f3\u30d7\u3057\u3066\u6301\u3063\u3066\u3044\u304f\u3002\n\n```shell-session\n$ mkdir ldap_backup\n$ sudo slapcat -l ldap_backup/backup.ldif\n$ sudo slapcat -b cn=config -l ldap_backup/backup_config.ldif\n$ tar zcvf ldap_backup.tar.gz ldap_backup\n```\n\nscp \u3067\u30aa\u30f3\u30d7\u30ec\u304b\u3089\u79fb\u884c\u5148\u306b\u30b3\u30d4\u30fc\u3059\u308b\u3002\n\n```shell-session\n$ scp -i .ssh/yoursshkey.pem ldap_backup.tar.gz ec2-user@ec2-xx-xx-xx-xx.ap-northeast-1.compute.amazonaws.com:~\n```\n\n## \u79fb\u884c\u5148\u3067\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u304b\u3089\u5fa9\u5143\u3059\u308b\n\n> https://gitlab.com/gitlab-org/omnibus-gitlab/blob/98b1bfb0d70082953d63abbc329cd6f2c628d3bc/README.md#restoring-an-application-backup\n\nOmnibus\u306eGitlab\u306e\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306b\u3001PostgreSQL\u5909\u63db\u6e08\u307f\u306e\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u30d5\u30a1\u30a4\u30eb\u3092\u7f6e\u304f\u3002\n\n```shell-session\n$ sudo cp TIMESTAMP_gitlab_backup.tar /var/opt/gitlab/backups/\n```\n\nGitlab(unicorn\u3068sidekiq)\u3092\u505c\u6b62\u3057\u3066\u3001\u30ea\u30b9\u30c8\u30a2\u30b3\u30de\u30f3\u30c9\u3092\u767a\u884c\u3059\u308b\u3002\n\n```shell-session\n$ sudo gitlab-ctl stop unicorn\nok: down: unicorn: 0s, normally up\n\n$ sudo gitlab-ctl stop sidekiq\nok: down: sidekiq: 0s, normally up\n\n$ sudo gitlab-rake gitlab:backup:restore BACKUP=TIMESTAMP\n\n$ sudo gitlab-ctl start\n```\n\n\n## LDAP\u306fOpenLDAP Server\u3092\u65b0\u3057\u304f\u4f5c\u3063\u3066\u3001\u30c0\u30f3\u30d7\u3057\u305f\u30d5\u30a1\u30a4\u30eb(LDIF)\u3092\u898b\u306a\u304c\u3089\u623b\u3057\u3066\u3044\u304f\n\n```shell-session\n$ sudo yum install openldap-servers openldap-clients openldap\n$ sudo cp /usr/share/openldap-servers/DB_CONFIG.example /var/lib/ldap/DB_CONFIG\n$ sudo vi /etc/rsyslog.conf\n\n\n--- /etc/rsyslog.conf.back      2014-11-11 00:28:01.000000000 +0000\n+++ /etc/rsyslog.conf   2016-10-29 10:03:11.405303294 +0000\n@@ -56,6 +56,8 @@\n # Save boot messages also to boot.log\n local7.*                                                /var/log/boot.log\n \n+# Ldap\n+local4.*                                               /var/log/slapd.log\n \n # ### begin forwarding rule ###\n # The statement between the begin ... end define a SINGLE forwarding\n\n\n$ sudo service rsyslog restart\n```\n\n\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u30d5\u30a1\u30a4\u30eb\u3092\u3082\u3068\u306b\u3001LDAP\u3092\u69cb\u6210\u3057\u3066\u3044\u304f\u3002\n\n```shell-session\n$ sudo service slapd start\n$ sudo ldapadd -Y EXTERNAL -H ldapi:// -f 1_change_RootPW.ldif\n$ sudo ldapmodify -x -D cn=config -W -f ./2_initial_config.ldif\n$ sudo ldapadd -x -D \"cn=Manager,dc=r-stack,dc=jp\" -W -f 3_add_base.ldif\n$ sudo ldapadd -x -D \"cn=Manager,dc=r-stack,dc=jp\" -W -f 4_add_users.ldif\n\n$ sudo chkconfig slapd on\n```\n\n\u3054\u53c2\u8003\u307e\u3067\u306b\u3001\u5404\u30d5\u30a1\u30a4\u30eb\u306f\u3053\u3093\u306a\u611f\u3058\u3067\u3059\u3002\n\n - 1_change_RootPW.ldif \n\n```shell-session\ndn: olcDatabase={0}config,cn=config\nchangetype: modify\nadd: olcRootPW\nolcRootPW: {SSHA}XXXXXXXXXXXXXXXXXXXXXXXXXXXXX\n```\n\n- 2_initial_config.ldif \n\n```shell-session\ndn: olcDatabase={1}monitor,cn=config\nchangetype: modify\nreplace: olcAccess\nolcAccess: {0}to * by dn.base=\"gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth\" read by dn.base=\"cn=Manager,dc=example,dc=com\" read by * none\n\ndn: olcDatabase={2}bdb,cn=config\nchangetype: modify\nreplace: olcSuffix\nolcSuffix: dc=example,dc=com\n\ndn: olcDatabase={2}bdb,cn=config\nchangetype: modify\nreplace: olcRootDN\nolcRootDN: cn=Manager,dc=example,dc=com\n\ndn: olcDatabase={2}bdb,cn=config\nchangetype: modify\nreplace: olcRootPW\nolcRootPW: {SSHA}XXXXXXXXXXXXXXXXXXX\n```\n\n - 3_add_base.ldif\n\n```shell-session\ndn: dc=example,dc=com\nobjectClass: dcObject\nobjectClass: organization\no: example.com\ndc: example\n\ndn: cn=Manager,dc=example,dc=com\nobjectClass: organizationalRole\nobjectClass: simpleSecurityObject\ncn: Manager\ndescription: LDAP Administrator\nuserPassword:: XXXXXXXXXXXXXXXXXXXXXXXX\n\ndn: ou=People,dc=example,dc=com\nobjectClass: organizationalUnit\nou: People\n\ndn: ou=Group,dc=example,dc=com\nobjectClass: organizationalUnit\nou: Group\n```\n\n - 4_add_users.ldif\n\n```shell-session\ndn: ou=Sales,ou=Group,dc=example,dc=com\nobjectClass: groupOfNames\nobjectClass: top\ncn: Sales\nmember: cn=user1,ou=People,dc=example,dc=com\nou: Sales\n\ndn: cn=Taro Nihon,ou=People,dc=example,dc=com\nobjectClass: inetOrgPerson\nobjectClass: organizationalPerson\nobjectClass: person\nobjectClass: top\ncn: Taro Nihon\nsn: Nihon\nuid: user1\nmail: user1@example.com\no: Example, Inc.\nou: Sales\nuserPassword:: XXXXXXXXXXXXXXXXXXXX\n\n... snip ...\n\n```\n\n## GitLab\u306e\u521d\u671f\u8a2d\u5b9a\n\n - Omnibus\u306eGitLab\u306f\u3001`/etc/gitlab/gitlab.rb` \u7d4c\u7531\u3067\u8a2d\u5b9a\u3059\u308b\n - \u76f4\u63a5 `gitlab.yml` \u3068\u304b\u3092\u3044\u3058\u3063\u3066\u3082 `gitlab-ctl reconfigure` \u3059\u308b\u3068\u6d88\u3048\u308b\u306e\u3067\u6ce8\u610f\n\n```shell-session\n$ sudo vi /etc/gitlab/gitlab.rb\n$ sudo gitlab-ctl reconfigure\n$ sudo gitlab-rake gitlab:check\n\n... snip ...\n\nLDAP users with access to your GitLab server (only showing the first 100 results)\nrake aborted!\nArgumentError: host,port,method,uid or filter,base MUST be provided\n```\n\n\u306a\u305c\u304bLDAP\u95a2\u9023\u30d1\u30e9\u30e1\u30fc\u30bf\u304c`gitlab.yml`\u306b\u53cd\u6620\u3055\u308c\u3066\u306a\u3044\u3002\u30d0\u30b0\u3063\u307d\u3044\u306e\u3067\u30d0\u30fc\u30b8\u30e7\u30f3\u30a2\u30c3\u30d7\u3059\u308b\u3068\u76f4\u308b\u3068\u4fe1\u3058\u3066\u3001\u3068\u308a\u3042\u3048\u305a\u624b\u52d5\u3067\u8a2d\u5b9a\u3059\u308b\u3002\n\n\n## \u79fb\u884c\u5148\u30b5\u30fc\u30d0\u30fc\u3067\u306e Omnibus 6.9.2\u306e\u52d5\u4f5c\u78ba\u8a8d\n\n - \u3053\u306e\u6642\u70b9\u3067\u30d6\u30e9\u30a6\u30b6\u3067\u63a5\u7d9a\u3057\u3066\u307f\u3066\u3001\u3061\u3083\u3093\u3068\u30c7\u30fc\u30bf\u304c\u79fb\u3063\u3066\u3044\u308b\u304b\u3001\u3061\u3083\u3093\u3068\u52d5\u304f\u304b\u3001\u306a\u3069\u78ba\u8a8d\n - \u30ea\u30d0\u30d7\u30ed\u3084ELB\u306a\u3069\u3067SSL\u3092\u7d42\u7aef\u3057\u3066\u3044\u308b\u69cb\u6210\u3060\u3068\u3001\u516c\u5f0f\u624b\u9806\u3067\u3084\u3063\u3066\u305f\u3089\u30a2\u30d0\u30bf\u30fc\u306e\u753b\u50cf\u304c\u898b\u308c\u306a\u3044\n\n> https://gitlab.com/gitlab-org/gitlab-ce/issues/14287\n\nStatic\u30b3\u30f3\u30c6\u30f3\u30c4\u3082Unicorn\u3067\u51e6\u7406\u3055\u305b\u3088\u3046\u3068\u3057\u3066\u3044\u308b\u306e\u3067\u3001Unicorn\u3067\u51e6\u7406\u3057\u3066\u304f\u308c\u308c\u3070\u305d\u308c\u306f\u305d\u308c\u3067\u3044\u3044\u3093\u3067\u3059\u304c\u3001URL\u751f\u6210\u3059\u308b\u969b\u306b\u5916\u90e8URL\u3067\u306f\u306a\u304f\u3066\u5185\u90e8URL(HTTP)\u3092\u3068\u3063\u3066\u304d\u3061\u3083\u3063\u3066\u307e\u3059\u3002\n\n> https://gitlab.com/gitlab-org/gitlab-ce/blob/master/app/models/user.rb#L673\n\n\u3068\u3044\u3046\u3053\u3068\u3067\u3001\u7121\u7406\u304f\u308aNginx\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092\u76f4\u63a5\u3044\u3058\u3063\u3066\u3001`/uploads`\u3092Static\u30db\u30b9\u30c6\u30a3\u30f3\u30b0\u3059\u308b\u3088\u3046\u306b\u3057\u3066\u304a\u304f\u3002`gitlab-ctl reconfigure`\u3059\u308b\u3068\u4e0a\u66f8\u304d\u3055\u308c\u308b\u306e\u3067\u8981\u6ce8\u610f\u3002\n\n```shell-session\n$ sudo vi /var/opt/gitlab/nginx/etc/gitlab-http.conf\n\n... snip ...\n\n  location /uploads {\n    root /var/opt/gitlab/gitlab-rails/uploads;\n  }\n\n```\n\n## GitLab\u3092\u6bb5\u968e\u30a2\u30c3\u30d7\u30c7\u30fc\u30c8\u3092\u3059\u308b\n\n - \u3044\u304d\u306a\u308a\u6700\u65b0\u7248\u306e8.x\u306b\u3044\u304f\u3068\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306e\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u306b\u5931\u6557\u3059\u308b\n - 6.9.2 -> 7.14.3 -> 8.13.1 \u3068\u6bb5\u968e\u30a2\u30c3\u30d7\u30c7\u30fc\u30c8\u3059\u308b\n\n\u30a2\u30c3\u30d7\u30c7\u30fc\u30c8\u306e\u4ed5\u65b9\u306f\u3001\u516c\u5f0f\u30b5\u30a4\u30c8\u306e\u624b\u9806\u306e\u3068\u304a\u308a\u3002\n\n> https://about.gitlab.com/downloads/#centos6\n\n```shell-session\n$ sudo yum install postfix\n\n$ sudo service sendmail stop\nShutting down sm-client:                                   [  OK  ]\nShutting down sendmail:                                    [  OK  ]\n$ sudo chkconfig sendmail off\n$ sudo service postfix start\nStarting postfix:                                          [  OK  ]\n$ sudo chkconfig postfix on\n$ sudo alternatives --config mta\n\nThere are 2 programs which provide 'mta'.\n\n  Selection    Command\n-----------------------------------------------\n*+ 1           /usr/sbin/sendmail.sendmail\n   2           /usr/sbin/sendmail.postfix\n\nEnter to keep the current selection[+], or type selection number: 2\n\n... snip ...\n\n$ curl -sS https://packages.gitlab.com/install/repositories/gitlab/gitlab-ce/script.rpm.sh | sudo bash\n$ sudo yum install gitlab-ce-7.13.5\n$ sudo gitlab-ctl reconfigure\n$ sudo gitlab-rake gitlab:check\n\n...snip...\n\nCI / portal ... no\n  Try fixing it:\n  sudo -u git -H bundle exec rake gitlab:satellites:create RAILS_ENV=production\n  If necessary, remove the tmp/repo_satellites directory ...\n  ... and rerun the above command\n  For more information see:\n  doc/raketasks/maintenance.md\n  Please fix the error above and rerun the checks.\n```\n\nsatellites\u304c\u306a\u3044\u3068\u6012\u3089\u308c\u308b\u306e\u3067\u3001\u4f5c\u3063\u3066\u304a\u304f\u3002\n\n```shell-session\n$ sudo gitlab-rake gitlab:satellites:create RAILS_ENV=production\n$ sudo gitlab-rake gitlab:check\n```\n\n7.14.3 \u3092\u5165\u308c\u308b\u3002\n\n```shell-session\n$ sudo yum update gitlab-ce-7.14.3\n$ sudo gitlab-ctl reconfigure\n$ sudo gitlab-rake gitlab:check\n```\n\n\u52d5\u4f5c\u78ba\u8a8d\u3057\u305f\u3089\u30018.13.1\u3092\u5165\u308c\u308b\u3002\n\n```shell-session\n$ sudo yum update gitlab-ce-8.13.1\n$ sudo gitlab-ctl reconfigure\n$ sudo gitlab-rake gitlab:check\n```\n\n\u5fd8\u308c\u305a\u306bNginx\u306e\u8a2d\u5b9a\u3092\u76f4\u3057\u3066\u304a\u304f\u3002\n\n```shell-session\n\n$ sudo vi /var/opt/gitlab/nginx/etc/gitlab-http.conf\n\n  location /uploads {\n    root /var/opt/gitlab/gitlab-rails/uploads;\n  }\n\n$ sudo gitlab-ctl restart nginx\n```\n\n\u304a\u3057\u307e\u3044\u3002\n", "tags": ["GitLab", "AWS", "LDAP", "PostgreSQL", "Linux"]}