{"tags": ["Node.js0.10.12", "Express4.2.0"], "context": "\n\n\u6e96\u5099\n\nExpress\u3067Web\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3092\u81ea\u52d5\u751f\u6210\u3059\u308b\nfeedparser\u30e2\u30b8\u30e5\u30fc\u30eb\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\n\n  npm install feedparser\n\n\nrss\u3092parse\u3059\u308b\u30d7\u30ed\u30b0\u30e9\u30e0\u30b3\u30fc\u30c9\nroutes/feed.js\n'use strict';\n\nvar express = require('express');\nvar router = express.Router();\nvar FeedParser = require('feedparser');\nvar http = require('http');\n\n\nrouter.get('/parse', function(request, response) {\n  var feedMeta;\n  var episodes = [];\n\n  // \u6307\u5b9aurl\u306bhttp\u30ea\u30af\u30a8\u30b9\u30c8\u3059\u308b\n  http.get('http://leoville.tv/podcasts/sn.xml', function(res) {\n    //\u30ec\u30b9\u30dd\u30f3\u30b9\u306b\u30d5\u30a3\u30fc\u30c9\u30d1\u30fc\u30b5\u3092\u30d1\u30a4\u30d7\u3067\u6e21\u3059\n    res.pipe(new FeedParser({}))\n      .on('error', function(error) {\n        response.status(500).json({\n          'message': 'HTTP failure while fetching feed'\n        });\n      })\n      .on('meta', function(meta) {\n        feedMeta = meta;\n      })\n      .on('readable', function() {\n        var stream = this, item;\n\n        // chunk\u30c7\u30fc\u30bf\u3092\u4fdd\u5b58\u3059\u308b\n        while (item = stream.read()) {\n          var ep = {\n            'title' : item.title,\n            'mediaUrl': item.link,\n            'publicationDate': item.pubDate\n          };\n          episodes.push(ep);\n        }\n      })\n      .on('end', function() {\n        // \u30c7\u30fc\u30bf\u4fdd\u5b58\u5b8c\u4e86\u5f8c\u3001json\u306b\u6574\u5f62\u3059\u308b\n        var result;\n        result = {\n          'feedName': feedMeta.title,\n          'feedArtist': feedMeta['itunes:author']['#'],\n          'website': feedMeta.link,\n          'albumArt': {\n            'url': feedMeta.image.url,\n            'width': parseInt(feedMeta['rss:image']['width']['#']),\n            'height': parseInt(feedMeta['rss:image']['height']['#'])\n          },\n          'episodes': episodes\n        };\n\n        // json\u5f62\u5f0f\u3067\u30ec\u30b9\u30dd\u30f3\u30b9\u3092\u884c\u3046\n        response.json(result);\n      });\n  });\n});\n\nmodule.exports = router;\n\n\n\u30ec\u30b9\u30dd\u30f3\u30b9\u3092\u78ba\u8a8d\ncurl http://localhost:3000/feed/parse\n{\n    \"albumArt\": {\n        \"height\": 144, \n        \"url\": \"http://feeds.twit.tv/coverart/sn144audio.jpg\", \n        \"width\": 144\n    }, \n    \"episodes\": [\n        {\n            \"mediaUrl\": \"http://www.podtrac.com/pts/redirect.mp3/twit.cachefly.net/audio/sn/sn0461/sn0461.mp3\", \n            \"publicationDate\": \"2014-06-25T00:47:56.000Z\", \n            \"title\": \"SN 461: Your Questions, Steve's Answers 190\"\n        }, \n        {\n            \"mediaUrl\": \"http://www.podtrac.com/pts/redirect.mp3/twit.cachefly.net/audio/sn/sn0460/sn0460.mp3\", \n            \"publicationDate\": \"2014-06-18T01:11:38.000Z\", \n            \"title\": \"SN 460: Authenticated Encryption\"\n        }, \n        {\n            \"mediaUrl\": \"http://www.podtrac.com/pts/redirect.mp3/twit.cachefly.net/audio/sn/sn0459/sn0459.mp3\", \n            \"publicationDate\": \"2014-06-11T01:10:47.000Z\", \n            \"title\": \"SN 459: Your Questions, Steve's Answers 189\"\n        }, \n        {\n            \"mediaUrl\": \"http://www.podtrac.com/pts/redirect.mp3/twit.cachefly.net/audio/sn/sn0458/sn0458.mp3\", \n            \"publicationDate\": \"2014-06-04T00:37:50.000Z\", \n            \"title\": \"SN 458: TrueCrypt: WTH?\"\n        }, \n        {\n            \"mediaUrl\": \"http://www.podtrac.com/pts/redirect.mp3/twit.cachefly.net/audio/sn/sn0457/sn0457.mp3\", \n            \"publicationDate\": \"2014-05-28T01:49:42.000Z\", \n            \"title\": \"SN 457: Your Questions, Steve's Answers 188\"\n        }, \n        {\n            \"mediaUrl\": \"http://www.podtrac.com/pts/redirect.mp3/twit.cachefly.net/audio/sn/sn0456/sn0456.mp3\", \n            \"publicationDate\": \"2014-05-21T03:05:40.000Z\", \n            \"title\": \"SN 456: Harvesting Entropy\"\n        }, \n        {\n            \"mediaUrl\": \"http://www.podtrac.com/pts/redirect.mp3/twit.cachefly.net/audio/sn/sn0455/sn0455.mp3\", \n            \"publicationDate\": \"2014-05-14T00:09:49.000Z\", \n            \"title\": \"SN 455: Your Questions, Steve's Answers 187\"\n        }, \n        {\n            \"mediaUrl\": \"http://www.podtrac.com/pts/redirect.mp3/twit.cachefly.net/audio/sn/sn0454/sn0454.mp3\", \n            \"publicationDate\": \"2014-05-07T01:02:29.000Z\", \n            \"title\": \"SN 454: Certificate Revocation, Part 2\"\n        }, \n        {\n            \"mediaUrl\": \"http://www.podtrac.com/pts/redirect.mp3/twit.cachefly.net/audio/sn/sn0453/sn0453.mp3\", \n            \"publicationDate\": \"2014-04-30T01:10:12.000Z\", \n            \"title\": \"SN 453: Certificate Revocation\"\n        }, \n        {\n            \"mediaUrl\": \"http://www.podtrac.com/pts/redirect.mp3/twit.cachefly.net/audio/sn/sn0452/sn0452.mp3\", \n            \"publicationDate\": \"2014-04-23T00:49:11.000Z\", \n            \"title\": \"SN 452: Your Questions, Steve's Answers 186\"\n        }\n    ], \n    \"feedArtist\": \"TWiT\", \n    \"feedName\": \"Security Now (MP3)\", \n    \"website\": \"http://twit.tv/sn\"\n}\n\n# \u6e96\u5099\n1. [Express\u3067Web\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3092\u81ea\u52d5\u751f\u6210\u3059\u308b](http://qiita.com/kkam0907/items/1e35a72c549e1e3dfabf)\n2. feedparser\u30e2\u30b8\u30e5\u30fc\u30eb\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\n\n  ```\n  npm install feedparser\n  ```\n\n# rss\u3092parse\u3059\u308b\u30d7\u30ed\u30b0\u30e9\u30e0\u30b3\u30fc\u30c9\n\nroutes/feed.js\n\n```js\n'use strict';\n\nvar express = require('express');\nvar router = express.Router();\nvar FeedParser = require('feedparser');\nvar http = require('http');\n\n\nrouter.get('/parse', function(request, response) {\n  var feedMeta;\n  var episodes = [];\n\n  // \u6307\u5b9aurl\u306bhttp\u30ea\u30af\u30a8\u30b9\u30c8\u3059\u308b\n  http.get('http://leoville.tv/podcasts/sn.xml', function(res) {\n    //\u30ec\u30b9\u30dd\u30f3\u30b9\u306b\u30d5\u30a3\u30fc\u30c9\u30d1\u30fc\u30b5\u3092\u30d1\u30a4\u30d7\u3067\u6e21\u3059\n    res.pipe(new FeedParser({}))\n      .on('error', function(error) {\n        response.status(500).json({\n          'message': 'HTTP failure while fetching feed'\n        });\n      })\n      .on('meta', function(meta) {\n        feedMeta = meta;\n      })\n      .on('readable', function() {\n        var stream = this, item;\n\n        // chunk\u30c7\u30fc\u30bf\u3092\u4fdd\u5b58\u3059\u308b\n        while (item = stream.read()) {\n          var ep = {\n            'title' : item.title,\n            'mediaUrl': item.link,\n            'publicationDate': item.pubDate\n          };\n          episodes.push(ep);\n        }\n      })\n      .on('end', function() {\n        // \u30c7\u30fc\u30bf\u4fdd\u5b58\u5b8c\u4e86\u5f8c\u3001json\u306b\u6574\u5f62\u3059\u308b\n        var result;\n        result = {\n          'feedName': feedMeta.title,\n          'feedArtist': feedMeta['itunes:author']['#'],\n          'website': feedMeta.link,\n          'albumArt': {\n            'url': feedMeta.image.url,\n            'width': parseInt(feedMeta['rss:image']['width']['#']),\n            'height': parseInt(feedMeta['rss:image']['height']['#'])\n          },\n          'episodes': episodes\n        };\n\n        // json\u5f62\u5f0f\u3067\u30ec\u30b9\u30dd\u30f3\u30b9\u3092\u884c\u3046\n        response.json(result);\n      });\n  });\n});\n\nmodule.exports = router;\n```\n\n# \u30ec\u30b9\u30dd\u30f3\u30b9\u3092\u78ba\u8a8d\n\ncurl http://localhost:3000/feed/parse\n\n```json\n{\n    \"albumArt\": {\n        \"height\": 144, \n        \"url\": \"http://feeds.twit.tv/coverart/sn144audio.jpg\", \n        \"width\": 144\n    }, \n    \"episodes\": [\n        {\n            \"mediaUrl\": \"http://www.podtrac.com/pts/redirect.mp3/twit.cachefly.net/audio/sn/sn0461/sn0461.mp3\", \n            \"publicationDate\": \"2014-06-25T00:47:56.000Z\", \n            \"title\": \"SN 461: Your Questions, Steve's Answers 190\"\n        }, \n        {\n            \"mediaUrl\": \"http://www.podtrac.com/pts/redirect.mp3/twit.cachefly.net/audio/sn/sn0460/sn0460.mp3\", \n            \"publicationDate\": \"2014-06-18T01:11:38.000Z\", \n            \"title\": \"SN 460: Authenticated Encryption\"\n        }, \n        {\n            \"mediaUrl\": \"http://www.podtrac.com/pts/redirect.mp3/twit.cachefly.net/audio/sn/sn0459/sn0459.mp3\", \n            \"publicationDate\": \"2014-06-11T01:10:47.000Z\", \n            \"title\": \"SN 459: Your Questions, Steve's Answers 189\"\n        }, \n        {\n            \"mediaUrl\": \"http://www.podtrac.com/pts/redirect.mp3/twit.cachefly.net/audio/sn/sn0458/sn0458.mp3\", \n            \"publicationDate\": \"2014-06-04T00:37:50.000Z\", \n            \"title\": \"SN 458: TrueCrypt: WTH?\"\n        }, \n        {\n            \"mediaUrl\": \"http://www.podtrac.com/pts/redirect.mp3/twit.cachefly.net/audio/sn/sn0457/sn0457.mp3\", \n            \"publicationDate\": \"2014-05-28T01:49:42.000Z\", \n            \"title\": \"SN 457: Your Questions, Steve's Answers 188\"\n        }, \n        {\n            \"mediaUrl\": \"http://www.podtrac.com/pts/redirect.mp3/twit.cachefly.net/audio/sn/sn0456/sn0456.mp3\", \n            \"publicationDate\": \"2014-05-21T03:05:40.000Z\", \n            \"title\": \"SN 456: Harvesting Entropy\"\n        }, \n        {\n            \"mediaUrl\": \"http://www.podtrac.com/pts/redirect.mp3/twit.cachefly.net/audio/sn/sn0455/sn0455.mp3\", \n            \"publicationDate\": \"2014-05-14T00:09:49.000Z\", \n            \"title\": \"SN 455: Your Questions, Steve's Answers 187\"\n        }, \n        {\n            \"mediaUrl\": \"http://www.podtrac.com/pts/redirect.mp3/twit.cachefly.net/audio/sn/sn0454/sn0454.mp3\", \n            \"publicationDate\": \"2014-05-07T01:02:29.000Z\", \n            \"title\": \"SN 454: Certificate Revocation, Part 2\"\n        }, \n        {\n            \"mediaUrl\": \"http://www.podtrac.com/pts/redirect.mp3/twit.cachefly.net/audio/sn/sn0453/sn0453.mp3\", \n            \"publicationDate\": \"2014-04-30T01:10:12.000Z\", \n            \"title\": \"SN 453: Certificate Revocation\"\n        }, \n        {\n            \"mediaUrl\": \"http://www.podtrac.com/pts/redirect.mp3/twit.cachefly.net/audio/sn/sn0452/sn0452.mp3\", \n            \"publicationDate\": \"2014-04-23T00:49:11.000Z\", \n            \"title\": \"SN 452: Your Questions, Steve's Answers 186\"\n        }\n    ], \n    \"feedArtist\": \"TWiT\", \n    \"feedName\": \"Security Now (MP3)\", \n    \"website\": \"http://twit.tv/sn\"\n}\n```\n"}