{"context": " More than 1 year has passed since last update.\n\n\u3053\u308c\u30fb\u30fb\u5168\u304f\u30d7\u30ed\u30b0\u30e9\u30df\u30f3\u30b0\u306b\u95a2\u4fc2\u306a\u3044\u30cd\u30bf\u306a\u3093\u3067\u3059\u304c\u3001\nQiita\u306b\u6295\u7a3f\u3057\u3066\u3044\u3044\u3093\u3067\u3057\u305f\u3063\u3051\u30fb\u30fb\u30fb\uff1f\n\u3068\u4e0d\u5b89\u306b\u306a\u308a\u3064\u3064\u3082\u3001\u5f37\u3044\u5fc3\u3067\u7b2c2\u56de\u3067\u3059\u3002 \uff20Qiita\u521d\u5fc3\u8005\n\u524d\u56de\u306fnf_conntrack\u30a4\u30f3\u30c6\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u306b\u5bfe\u5fdc\u3057\u305fOpen vSwitch\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u304b\u3089\u8d77\u52d5\u307e\u3067\u3092\u7d39\u4ecb\u3057\u307e\u3057\u305f\u3002\nOpen vSwitch\u306econntrack\u9023\u643a\u3092\u8a66\u3057\u3066\u307f\u305f(\u305d\u306e1)\n\u4eca\u56de\u306f\u3001\u6700\u3082\u7c21\u5358\u306a\u69cb\u6210\u3067\u30b9\u30c6\u30fc\u30c8\u30d5\u30eb\u30a4\u30f3\u30b9\u30da\u30af\u30b7\u30e7\u30f3\u306e\u8a2d\u5b9a\u3092\u3057\u3066\u901a\u4fe1\u78ba\u8a8d\u3092\u3057\u3066\u307f\u307e\u3059\u3002\n\n\u30c6\u30b9\u30c8\u69cb\u6210\n\u4e0b\u56f3\u306e\u3088\u3046\u306b\u3001\u7269\u7406\u30db\u30b9\u30c8\u4e0a\u306bVM\u30922\u500b\u8d77\u52d5\u3057\u3001Open vSwitch\u306b\u3066\u63a5\u7d9a\u3057\u307e\u3059\u3002\u30b2\u30b9\u30c8OS\u3068\u3057\u3066\u306fCentOS6\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u307e\u3057\u305f\u3002\n\n\u3053\u3053\u3067\u3001\n\nVM1\u304b\u3089VM2\u5411\u3051\u306b\u30a4\u30cb\u30b7\u30a8\u30fc\u30c8\u3055\u308c\u305f\u901a\u4fe1\u306e\u623b\u308a\u30d1\u30b1\u30c3\u30c8\u306f\u8a31\u53ef\u3057\u3001\u305d\u308c\u4ee5\u5916\u306f\u62d2\u5426\u3059\u308b\n\n\u3068\u3044\u3046\u30dd\u30ea\u30b7\u30fc\u3092Open vSwitch\u306e\u30d5\u30ed\u30fc\u30a8\u30f3\u30c8\u30ea\u3067\u5b9f\u88c5\u3057\u3066\u307f\u307e\u3059\u3002\n\nStep1. VM\u306e\u8d77\u52d5\nCentOS\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u305f\u30c7\u30a3\u30b9\u30af\u30a4\u30e1\u30fc\u30b8\u30922\u500b\u7528\u610f\u3057\u3001\u666e\u901a\u306bqemu\u30922\u500b\u8d77\u52d5\u3057\u307e\u3059\u3002\n\u25a0 VM1\n/usr/libexec/qemu-kvm -smp 1 -m 1024 -vnc :1 -k ja -enable-kvm -daemonize \\\n-drive file=centos6-1.qcow2,if=virtio,index=0,media=disk,cache=none,aio=native \\\n-netdev type=tap,vhost=on,vnet_hdr=off,id=tap1,ifname=tap1,script=no,downscript=no \\\n-device virtio-net-pci,netdev=tap1,mac=52:54:00:60:4d:6e \\\n-netdev type=tap,vhost=on,vnet_hdr=off,id=tap2,ifname=tap2,script=no,downscript=no \\\n-device virtio-net-pci,netdev=tap2,mac=52:54:00:60:84:ff \\\n\n\u25a0 VM2\n/usr/libexec/qemu-kvm -smp 1 -m 1024 -vnc :2 -k ja -enable-kvm -daemonize \\\n-drive file=centos6-2.qcow2,if=virtio,index=0,media=disk,cache=none,aio=native \\\n-netdev type=tap,vhost=on,vnet_hdr=off,id=tap3,ifname=tap3,script=no,downscript=no \\\n-device virtio-net-pci,netdev=tap3,mac=52:54:00:ba:61:f3 \\\n-netdev type=tap,vhost=on,vnet_hdr=off,id=tap4,ifname=tap4,script=no,downscript=no \\\n-device virtio-net-pci,netdev=tap4,mac=52:54:00:99:90:78 \\\n\n\u305d\u308c\u305e\u308c\u30012\u500b\u76ee\u306eNIC(tap2\u3068tap4)\u3092Open vSwitch\u901a\u4fe1\u30c6\u30b9\u30c8\u7528\u306b\u5229\u7528\u3057\u307e\u3059\u3002\n\u5148\u982d\u306eNIC(tap1\u3068tap3)\u306fssh\u30ed\u30b0\u30a4\u30f3\u7528\u3067\u3059\u3002\n\nStep2. \u4eee\u60f3NIC\u3092Open vSwitch\u306b\u63a5\u7d9a\nOpen vSwitch(br0)\u306btap2\u3068tap4\u3092\u666e\u901a\u306b\u63a5\u7d9a\u3057\u307e\u3059\u3002\novs-vsctl add-port br0 tap2\novs-vsctl add-port br0 tap4\n\n\u6b63\u5e38\u306b\u63a5\u7d9a\u3067\u304d\u308b\u3068\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u308b\u3068\u601d\u3044\u307e\u3059\u3002\u4eca\u56de\u7269\u7406NIC(eth2)\u306f\u4f7f\u3044\u307e\u305b\u3093\u3002\n[root@sl67-r3 ~]# ovs-ofctl show br0\nOFPT_FEATURES_REPLY (xid=0x2): dpid:000090e2ba230f70\nn_tables:254, n_buffers:256\ncapabilities: FLOW_STATS TABLE_STATS PORT_STATS QUEUE_STATS ARP_MATCH_IP\nactions: output enqueue set_vlan_vid set_vlan_pcp strip_vlan mod_dl_src mod_dl_dst mod_nw_src mod_nw_dst mod_nw_tos mod_tp_src mod_tp_dst\n 1(eth2): addr:90:e2:ba:23:0f:70\n     config:     0\n     state:      0\n     current:    10GB-FD\n     advertised: 10GB-FD FIBER\n     supported:  10GB-FD FIBER\n     speed: 10000 Mbps now, 10000 Mbps max\n 2(tap2): addr:ae:b4:ef:2b:24:6b\n     config:     0\n     state:      0\n     current:    10MB-FD COPPER\n     speed: 10 Mbps now, 0 Mbps max\n 3(tap4): addr:02:c6:fe:6c:2f:73\n     config:     0\n     state:      0\n     current:    10MB-FD COPPER\n     speed: 10 Mbps now, 0 Mbps max\n LOCAL(br0): addr:90:e2:ba:23:0f:70\n     config:     0\n     state:      0\n     speed: 0 Mbps now, 0 Mbps max\nOFPT_GET_CONFIG_REPLY (xid=0x4): frags=normal miss_send_len=0\n\ntap2(VM1)\u3068tap4(VM2)\u306f\u3001\u305d\u308c\u305e\u308cofport=2\u3068ofport=3\u304c\u5272\u308a\u5f53\u3066\u3089\u308c\u307e\u3057\u305f\u3002\u6b21\u7bc0\u306e\u30d5\u30ed\u30fc\u30a8\u30f3\u30c8\u30ea\u8a2d\u5b9a\u3067\u306f\u3001\u3053\u306eofport\u756a\u53f7\u3092\u4f7f\u7528\u3057\u307e\u3059\u3002\n\u3053\u306e\u72b6\u614b\u3067\u3001VM1\u3068VM2\u9593\u3067\u666e\u901a\u306b\u901a\u4fe1\u3067\u304d\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n[root@centos6-1 ~]# ip addr show dev eth1\n3: eth1: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP qlen 1000\n    link/ether 52:54:00:60:84:ff brd ff:ff:ff:ff:ff:ff\n    inet 192.168.0.1/24 brd 192.168.0.255 scope global eth1\n    inet6 fe80::5054:ff:fe60:84ff/64 scope link\n       valid_lft forever preferred_lft forever\n\n[root@centos6-1 ~]# ping 192.168.0.2\nPING 192.168.0.2 (192.168.0.2) 56(84) bytes of data.\n64 bytes from 192.168.0.2: icmp_seq=1 ttl=64 time=0.956 ms\n64 bytes from 192.168.0.2: icmp_seq=2 ttl=64 time=0.518 ms\n\n\u3053\u3053\u307e\u3067\u306f\u3044\u3064\u3082\u901a\u308a\u3001\u554f\u984c\u306a\u3063\u3057\u3067\u3059\u306d\u3002\n\nStep3. conntrack\u9023\u643a\u3059\u308b\u30d5\u30ed\u30fc\u30a8\u30f3\u30c8\u30ea\u3092\u8a2d\u5b9a\n\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u30d5\u30ed\u30fc\u30a8\u30f3\u30c8\u30ea\u3092ovs-ofctl\u30b3\u30de\u30f3\u30c9\u3067\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n# cat a.flow\npriority=100,ip,actions=ct(table=1)\npriority=10,arp,actions=normal\npriority=1,actions=drop\n\ntable=1,in_port=2,ct_state=+new,actions=ct(commit),normal\ntable=1,in_port=2,ct_state=+est,actions=normal\ntable=1,in_port=3,ct_state=+new,actions=drop\ntable=1,in_port=3,ct_state=+est,actions=normal\n\n# ovs-ofctl add-flows br0 a.flow\n\nct_state\u3084actions=ct(xxxx)\u3042\u305f\u308a\u304cconntrack\u30c6\u30fc\u30d6\u30eb\u306b\u767b\u9332\u3057\u305f\u308a\u3001\u53c2\u7167\u3057\u305f\u308a\u3059\u308b\u69cb\u6587\u3067\u3059\u3002\n\u6b63\u3057\u304f\u8a2d\u5b9a\u3067\u304d\u308b\u3068\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u308b\u3068\u601d\u3044\u307e\u3059\u3002\n[root@sl67-r3 ~]# ovs-ofctl dump-flows br0\nNXST_FLOW reply (xid=0x4):\n cookie=0x0, duration=46.236s, table=0, n_packets=0, n_bytes=0, idle_age=46, priority=100,ip actions=ct(table=1)\n cookie=0x0, duration=46.236s, table=0, n_packets=0, n_bytes=0, idle_age=46, priority=10,arp actions=NORMAL\n cookie=0x0, duration=46.236s, table=0, n_packets=0, n_bytes=0, idle_age=46, priority=1 actions=drop\n cookie=0x0, duration=46.236s, table=1, n_packets=0, n_bytes=0, idle_age=46, ct_state=+new,in_port=2 actions=ct(commit),NORMAL\n cookie=0x0, duration=46.235s, table=1, n_packets=0, n_bytes=0, idle_age=46, ct_state=+new,in_port=3 actions=drop\n cookie=0x0, duration=46.236s, table=1, n_packets=0, n_bytes=0, idle_age=46, ct_state=+est,in_port=2 actions=NORMAL\n cookie=0x0, duration=46.235s, table=1, n_packets=0, n_bytes=0, idle_age=46, ct_state=+est,in_port=3 actions=NORMAL\n\n\nStep4. \u901a\u4fe1\u30c6\u30b9\u30c8\n\u307e\u305aVM2\u5074\u304b\u3089VM1\u306b\u5bfe\u3057\u3066\u901a\u4fe1\u3067\u304d\u306a\u3044\u3053\u3068\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002icmp\u3084tcp\u3084udp\u30d1\u30b1\u30c3\u30c8\u3092\u98db\u3070\u3057\u3066\u307f\u307e\u3059\u3002\n[root@centos6-2 ~]# ping 192.168.0.1\n[root@centos6-2 ~]# telnet 192.168.0.1\n[root@centos6-2 ~]# dig 192.168.0.1\n\n\u30ab\u30a6\u30f3\u30bf\u3092\u78ba\u8a8d\u3059\u308b\u3068\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306bdrop\u30a8\u30f3\u30c8\u30ea\u306b\u30de\u30c3\u30c1\u3057\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308a\u307e\u3059\u3002\n[root@sl67-r3 ~]# ovs-ofctl dump-flows br0\nNXST_FLOW reply (xid=0x4):\n cookie=0x0, duration=282.937s, table=0, n_packets=8, n_bytes=736, idle_age=9, priority=100,ip actions=ct(table=1)\n cookie=0x0, duration=282.937s, table=0, n_packets=2, n_bytes=84, idle_age=13, priority=10,arp actions=NORMAL\n cookie=0x0, duration=282.937s, table=0, n_packets=0, n_bytes=0, idle_age=282, priority=1 actions=drop\n cookie=0x0, duration=282.937s, table=1, n_packets=0, n_bytes=0, idle_age=282, ct_state=+new,in_port=2 actions=ct(commit),NORMAL\n cookie=0x0, duration=282.936s, table=1, n_packets=8, n_bytes=736, idle_age=9, ct_state=+new,in_port=3 actions=drop\n cookie=0x0, duration=282.937s, table=1, n_packets=0, n_bytes=0, idle_age=282, ct_state=+est,in_port=2 actions=NORMAL\n cookie=0x0, duration=282.936s, table=1, n_packets=0, n_bytes=0, idle_age=282, ct_state=+est,in_port=3 actions=NORMAL\n\n\u7d9a\u3044\u3066\u3001VM1\u304b\u3089VM2\u306b\u5bfe\u3057\u3066\u901a\u4fe1\u3092\u884c\u3044\u3001\u6b63\u5e38\u306b\u63a5\u7d9a\u3067\u304d\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n[root@centos6-1 ~]# ping 192.168.0.2\n[root@centos6-1 ~]# telnet 192.168.0.2 22\n[root@centos6-1 ~]# dig @192.168.0.2\n\n\u30ab\u30a6\u30f3\u30bf\u3092\u78ba\u8a8d\u3059\u308b\u3068\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306bconnection tracking\u306e\u30a8\u30f3\u30c8\u30ea\u306b\u30de\u30c3\u30c1\u3057\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308a\u307e\u3059\u3002\n[root@sl67-r3 ~]# ovs-ofctl dump-flows br0\nNXST_FLOW reply (xid=0x4):\n cookie=0x0, duration=221.654s, table=0, n_packets=40, n_bytes=3154, idle_age=63, priority=100,ip actions=ct(table=1)\n cookie=0x0, duration=221.654s, table=0, n_packets=10, n_bytes=420, idle_age=63, priority=10,arp actions=NORMAL\n cookie=0x0, duration=221.653s, table=0, n_packets=0, n_bytes=0, idle_age=221, priority=1 actions=drop\n cookie=0x0, duration=221.653s, table=1, n_packets=14, n_bytes=1058, idle_age=63, ct_state=+new,in_port=2 actions=ct(commit),NORMAL\n cookie=0x0, duration=221.653s, table=1, n_packets=0, n_bytes=0, idle_age=221, ct_state=+new,in_port=3 actions=drop\n cookie=0x0, duration=221.653s, table=1, n_packets=8, n_bytes=629, idle_age=85, ct_state=+est,in_port=2 actions=NORMAL\n cookie=0x0, duration=221.653s, table=1, n_packets=12, n_bytes=945, idle_age=85, ct_state=+est,in_port=3 actions=NORMAL\n\nnf_conntrack\u306e\u30c6\u30fc\u30d6\u30eb\u306b\u3082\u767b\u9332\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n[root@sl67-r3 ~]# conntrack -L -s 192.168.0.1\nudp      17 28 src=192.168.0.1 dst=192.168.0.2 sport=38118 dport=53 [UNREPLIED] src=192.168.0.2 dst=192.168.0.1 sport=53 dport=38118 mark=0 use=1\ntcp      6 105 TIME_WAIT src=192.168.0.1 dst=192.168.0.2 sport=48265 dport=22 src=192.168.0.2 dst=192.168.0.1 sport=22 dport=48265 [ASSURED] mark=0 use=1\nicmp     1 4 src=192.168.0.1 dst=192.168.0.2 type=8 code=0 id=52997 [UNREPLIED] src=192.168.0.2 dst=192.168.0.1 type=0 code=0 id=52997 mark=0 use=1\nconntrack v0.9.13 (conntrack-tools): 3 flow entries have been shown.\n\n\u7121\u4e8b\u306b\u52d5\u3044\u3066\u307e\u3059\u306d\uff01\n\n\u8a2d\u5b9a\u306e\u610f\u5473\u3059\u308b\u3068\u3053\u308d\n\u4eca\u56de\u4ee5\u4e0b\u306e\u8a2d\u5b9a\u3092\u884c\u3044\u307e\u3057\u305f\u304c\u3001\u5b9f\u306f\u3053\u308c\u3001ovs-ofctl\u30b3\u30de\u30f3\u30c9\u306e\u30de\u30cb\u30e5\u30a2\u30eb\u306b\u8f09\u3063\u3066\u3044\u308b\u30b5\u30f3\u30d7\u30eb\u3092\u7c21\u7d20\u5316\u3057\u305f\u3082\u306e\u3067\u3059\u3002\n     1  priority=100,ip,actions=ct(table=1)\n     2  priority=10,arp,actions=normal\n     3  priority=1,actions=drop\n     4\n     5  table=1,in_port=2,ct_state=+new,actions=ct(commit),normal\n     6  table=1,in_port=2,ct_state=+est,actions=normal\n     7  table=1,in_port=3,ct_state=+new,actions=drop\n     8  table=1,in_port=3,ct_state=+est,actions=normal\n\n\n1\u884c\u76ee: IPv4\u30d1\u30b1\u30c3\u30c8\u3092conntrack\u30a4\u30f3\u30c6\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u6a5f\u80fd\u306e\u51e6\u7406\u306b\u56de\u3057\u307e\u3059\u3002\u5b9f\u969b\u30015\u884c\u76ee\u4ee5\u964d\u306etable1\u306e\u30eb\u30fc\u30eb\u304c\u8a55\u4fa1\u3055\u308c\u307e\u3059\u3002\n2\u884c\u76ee: 1\u884c\u76ee\u306b\u30de\u30c3\u30c1\u3057\u306a\u304b\u3063\u305f\u3082\u306e\u306e\u3046\u3061\u3001ARP\u30d1\u30b1\u30c3\u30c8\u306f\u305d\u3082\u305d\u3082conntrack\u3067\u304d\u307e\u305b\u3093\u306e\u3067\u3001\u3053\u3053\u3067\u7121\u6761\u4ef6\u306b\u8a31\u53ef\u3057\u3066\u3044\u307e\u3059\u3002\n3\u884c\u76ee: \u305d\u306e\u4ed6\u306e\u30d1\u30b1\u30c3\u30c8(IPv6\u3068\u304b)\u306f\u7834\u68c4\u3057\u307e\u3059\u3002\n5\u884c\u76ee: VM1\u304c\u767a\u3057\u305f\u65b0\u898f\u30bb\u30c3\u30b7\u30e7\u30f3\u3092conntrack\u306b\u767b\u9332\u3057\u3001\u30d1\u30b1\u30c3\u30c8\u8ee2\u9001\u3057\u307e\u3059\u3002\n6\u884c\u76ee: VM1\u304c\u767a\u3057\u305fconntrack\u306b\u8f09\u3063\u3066\u3044\u308b\u30bb\u30c3\u30b7\u30e7\u30f3\u306b\u30de\u30c3\u30c1\u3059\u308b\u30d1\u30b1\u30c3\u30c8\u3092\u8a31\u53ef\u3057\u307e\u3059\u3002\n7\u884c\u76ee: VM2\u304c\u767a\u3057\u305f\u65b0\u898f\u30bb\u30c3\u30b7\u30e7\u30f3\u306f\u7834\u68c4\u3057\u307e\u3059\u3002\n8\u884c\u76ee: VM2\u304c\u767a\u3057\u305fconntrack\u306b\u8f09\u3063\u3066\u3044\u308b\u30bb\u30c3\u30b7\u30e7\u30f3(5\u884c\u76ee\u3067\u767b\u9332\u3055\u308c\u305f)\u306b\u30de\u30c3\u30c1\u3059\u308b\u30d1\u30b1\u30c3\u30c8\u3092\u8a31\u53ef\u3057\u307e\u3059\u3002\n\n\n\u6b21\u56de\u3078\u7d9a\u304f\n\u4eca\u56de\u306f\u6700\u3082\u7c21\u5358\u306a\u69cb\u6210\u3067\u3001nf_conntrack\u9023\u643a\u3092\u5229\u7528\u3057\u305f\u30b9\u30c6\u30fc\u30c8\u30d5\u30eb\u30d5\u30a1\u30a4\u30a2\u30a6\u30a9\u30fc\u30eb\u3092\u5b9f\u88c5\u3057\u3066\u307f\u307e\u3057\u305f\u3002\n\u6b21\u56de\u306f\u5f0a\u793e\u30af\u30e9\u30a6\u30c9\u30b5\u30fc\u30d3\u30b9\u306b\u304a\u3051\u308b\u3001\u4eee\u60f3\u30b9\u30a4\u30c3\u30c1\u306e\u304a\u5ba2\u69d8\u30b5\u30fc\u30d0\u53ce\u5bb9\u69cb\u6210\u3092\u60f3\u5b9a\u3057\u305f\u30dd\u30ea\u30b7\u30fc\u306e\u5b9f\u88c5\u65b9\u6cd5\u3092\u691c\u8a0e\u3057\u3066\u307f\u307e\u3059\u3002\n\u2192 Open vSwitch\u306econntrack\u9023\u643a\u3092\u8a66\u3057\u3066\u307f\u305f(\u305d\u306e3)\n# \u3053\u308c\u30fb\u30fb\u5168\u304f\u30d7\u30ed\u30b0\u30e9\u30df\u30f3\u30b0\u306b\u95a2\u4fc2\u306a\u3044\u30cd\u30bf\u306a\u3093\u3067\u3059\u304c\u3001\n\nQiita\u306b\u6295\u7a3f\u3057\u3066\u3044\u3044\u3093\u3067\u3057\u305f\u3063\u3051\u30fb\u30fb\u30fb\uff1f\n\n\u3068\u4e0d\u5b89\u306b\u306a\u308a\u3064\u3064\u3082\u3001\u5f37\u3044\u5fc3\u3067\u7b2c2\u56de\u3067\u3059\u3002 \uff20Qiita\u521d\u5fc3\u8005\n\n\u524d\u56de\u306fnf_conntrack\u30a4\u30f3\u30c6\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u306b\u5bfe\u5fdc\u3057\u305fOpen vSwitch\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u304b\u3089\u8d77\u52d5\u307e\u3067\u3092\u7d39\u4ecb\u3057\u307e\u3057\u305f\u3002\n\n[Open vSwitch\u306econntrack\u9023\u643a\u3092\u8a66\u3057\u3066\u307f\u305f(\u305d\u306e1)](http://qiita.com/jh1vxw/items/0d0e370fb1b374ab0c93)\n\n\u4eca\u56de\u306f\u3001\u6700\u3082\u7c21\u5358\u306a\u69cb\u6210\u3067**\u30b9\u30c6\u30fc\u30c8\u30d5\u30eb\u30a4\u30f3\u30b9\u30da\u30af\u30b7\u30e7\u30f3**\u306e\u8a2d\u5b9a\u3092\u3057\u3066\u901a\u4fe1\u78ba\u8a8d\u3092\u3057\u3066\u307f\u307e\u3059\u3002\n\n# \u30c6\u30b9\u30c8\u69cb\u6210\n\n\u4e0b\u56f3\u306e\u3088\u3046\u306b\u3001\u7269\u7406\u30db\u30b9\u30c8\u4e0a\u306bVM\u30922\u500b\u8d77\u52d5\u3057\u3001Open vSwitch\u306b\u3066\u63a5\u7d9a\u3057\u307e\u3059\u3002\u30b2\u30b9\u30c8OS\u3068\u3057\u3066\u306fCentOS6\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u307e\u3057\u305f\u3002\n\n![a.png](https://qiita-image-store.s3.amazonaws.com/0/108990/6d9eaa2e-3dd6-d2d6-d277-764424436d5b.png)\n\n\u3053\u3053\u3067\u3001\n\n- VM1\u304b\u3089VM2\u5411\u3051\u306b\u30a4\u30cb\u30b7\u30a8\u30fc\u30c8\u3055\u308c\u305f\u901a\u4fe1\u306e\u623b\u308a\u30d1\u30b1\u30c3\u30c8\u306f\u8a31\u53ef\u3057\u3001\u305d\u308c\u4ee5\u5916\u306f\u62d2\u5426\u3059\u308b\n\n\u3068\u3044\u3046\u30dd\u30ea\u30b7\u30fc\u3092Open vSwitch\u306e\u30d5\u30ed\u30fc\u30a8\u30f3\u30c8\u30ea\u3067\u5b9f\u88c5\u3057\u3066\u307f\u307e\u3059\u3002\n\n# Step1. VM\u306e\u8d77\u52d5\n\nCentOS\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u305f\u30c7\u30a3\u30b9\u30af\u30a4\u30e1\u30fc\u30b8\u30922\u500b\u7528\u610f\u3057\u3001\u666e\u901a\u306bqemu\u30922\u500b\u8d77\u52d5\u3057\u307e\u3059\u3002\n\n\u25a0 VM1\n\n```\n/usr/libexec/qemu-kvm -smp 1 -m 1024 -vnc :1 -k ja -enable-kvm -daemonize \\\n-drive file=centos6-1.qcow2,if=virtio,index=0,media=disk,cache=none,aio=native \\\n-netdev type=tap,vhost=on,vnet_hdr=off,id=tap1,ifname=tap1,script=no,downscript=no \\\n-device virtio-net-pci,netdev=tap1,mac=52:54:00:60:4d:6e \\\n-netdev type=tap,vhost=on,vnet_hdr=off,id=tap2,ifname=tap2,script=no,downscript=no \\\n-device virtio-net-pci,netdev=tap2,mac=52:54:00:60:84:ff \\\n```\n\n\u25a0 VM2\n\n```\n/usr/libexec/qemu-kvm -smp 1 -m 1024 -vnc :2 -k ja -enable-kvm -daemonize \\\n-drive file=centos6-2.qcow2,if=virtio,index=0,media=disk,cache=none,aio=native \\\n-netdev type=tap,vhost=on,vnet_hdr=off,id=tap3,ifname=tap3,script=no,downscript=no \\\n-device virtio-net-pci,netdev=tap3,mac=52:54:00:ba:61:f3 \\\n-netdev type=tap,vhost=on,vnet_hdr=off,id=tap4,ifname=tap4,script=no,downscript=no \\\n-device virtio-net-pci,netdev=tap4,mac=52:54:00:99:90:78 \\\n```\n\n\u305d\u308c\u305e\u308c\u30012\u500b\u76ee\u306eNIC(tap2\u3068tap4)\u3092Open vSwitch\u901a\u4fe1\u30c6\u30b9\u30c8\u7528\u306b\u5229\u7528\u3057\u307e\u3059\u3002\n\u5148\u982d\u306eNIC(tap1\u3068tap3)\u306fssh\u30ed\u30b0\u30a4\u30f3\u7528\u3067\u3059\u3002\n\n# Step2. \u4eee\u60f3NIC\u3092Open vSwitch\u306b\u63a5\u7d9a\n\nOpen vSwitch(br0)\u306btap2\u3068tap4\u3092\u666e\u901a\u306b\u63a5\u7d9a\u3057\u307e\u3059\u3002\n\n```\novs-vsctl add-port br0 tap2\novs-vsctl add-port br0 tap4\n```\n\n\u6b63\u5e38\u306b\u63a5\u7d9a\u3067\u304d\u308b\u3068\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u308b\u3068\u601d\u3044\u307e\u3059\u3002\u4eca\u56de\u7269\u7406NIC(eth2)\u306f\u4f7f\u3044\u307e\u305b\u3093\u3002\n\n```\n[root@sl67-r3 ~]# ovs-ofctl show br0\nOFPT_FEATURES_REPLY (xid=0x2): dpid:000090e2ba230f70\nn_tables:254, n_buffers:256\ncapabilities: FLOW_STATS TABLE_STATS PORT_STATS QUEUE_STATS ARP_MATCH_IP\nactions: output enqueue set_vlan_vid set_vlan_pcp strip_vlan mod_dl_src mod_dl_dst mod_nw_src mod_nw_dst mod_nw_tos mod_tp_src mod_tp_dst\n 1(eth2): addr:90:e2:ba:23:0f:70\n     config:     0\n     state:      0\n     current:    10GB-FD\n     advertised: 10GB-FD FIBER\n     supported:  10GB-FD FIBER\n     speed: 10000 Mbps now, 10000 Mbps max\n 2(tap2): addr:ae:b4:ef:2b:24:6b\n     config:     0\n     state:      0\n     current:    10MB-FD COPPER\n     speed: 10 Mbps now, 0 Mbps max\n 3(tap4): addr:02:c6:fe:6c:2f:73\n     config:     0\n     state:      0\n     current:    10MB-FD COPPER\n     speed: 10 Mbps now, 0 Mbps max\n LOCAL(br0): addr:90:e2:ba:23:0f:70\n     config:     0\n     state:      0\n     speed: 0 Mbps now, 0 Mbps max\nOFPT_GET_CONFIG_REPLY (xid=0x4): frags=normal miss_send_len=0\n```\n\ntap2(VM1)\u3068tap4(VM2)\u306f\u3001\u305d\u308c\u305e\u308cofport=2\u3068ofport=3\u304c\u5272\u308a\u5f53\u3066\u3089\u308c\u307e\u3057\u305f\u3002\u6b21\u7bc0\u306e\u30d5\u30ed\u30fc\u30a8\u30f3\u30c8\u30ea\u8a2d\u5b9a\u3067\u306f\u3001\u3053\u306eofport\u756a\u53f7\u3092\u4f7f\u7528\u3057\u307e\u3059\u3002\n\n\u3053\u306e\u72b6\u614b\u3067\u3001VM1\u3068VM2\u9593\u3067\u666e\u901a\u306b\u901a\u4fe1\u3067\u304d\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\n```\n[root@centos6-1 ~]# ip addr show dev eth1\n3: eth1: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP qlen 1000\n    link/ether 52:54:00:60:84:ff brd ff:ff:ff:ff:ff:ff\n    inet 192.168.0.1/24 brd 192.168.0.255 scope global eth1\n    inet6 fe80::5054:ff:fe60:84ff/64 scope link\n       valid_lft forever preferred_lft forever\n\n[root@centos6-1 ~]# ping 192.168.0.2\nPING 192.168.0.2 (192.168.0.2) 56(84) bytes of data.\n64 bytes from 192.168.0.2: icmp_seq=1 ttl=64 time=0.956 ms\n64 bytes from 192.168.0.2: icmp_seq=2 ttl=64 time=0.518 ms\n```\n\n\u3053\u3053\u307e\u3067\u306f\u3044\u3064\u3082\u901a\u308a\u3001\u554f\u984c\u306a\u3063\u3057\u3067\u3059\u306d\u3002\n\n# Step3. conntrack\u9023\u643a\u3059\u308b\u30d5\u30ed\u30fc\u30a8\u30f3\u30c8\u30ea\u3092\u8a2d\u5b9a\n\n\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u30d5\u30ed\u30fc\u30a8\u30f3\u30c8\u30ea\u3092ovs-ofctl\u30b3\u30de\u30f3\u30c9\u3067\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\n```\n# cat a.flow\npriority=100,ip,actions=ct(table=1)\npriority=10,arp,actions=normal\npriority=1,actions=drop\n\ntable=1,in_port=2,ct_state=+new,actions=ct(commit),normal\ntable=1,in_port=2,ct_state=+est,actions=normal\ntable=1,in_port=3,ct_state=+new,actions=drop\ntable=1,in_port=3,ct_state=+est,actions=normal\n\n# ovs-ofctl add-flows br0 a.flow\n```\n\nct_state\u3084actions=ct(xxxx)\u3042\u305f\u308a\u304cconntrack\u30c6\u30fc\u30d6\u30eb\u306b\u767b\u9332\u3057\u305f\u308a\u3001\u53c2\u7167\u3057\u305f\u308a\u3059\u308b\u69cb\u6587\u3067\u3059\u3002\n\n\u6b63\u3057\u304f\u8a2d\u5b9a\u3067\u304d\u308b\u3068\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u308b\u3068\u601d\u3044\u307e\u3059\u3002\n\n```\n[root@sl67-r3 ~]# ovs-ofctl dump-flows br0\nNXST_FLOW reply (xid=0x4):\n cookie=0x0, duration=46.236s, table=0, n_packets=0, n_bytes=0, idle_age=46, priority=100,ip actions=ct(table=1)\n cookie=0x0, duration=46.236s, table=0, n_packets=0, n_bytes=0, idle_age=46, priority=10,arp actions=NORMAL\n cookie=0x0, duration=46.236s, table=0, n_packets=0, n_bytes=0, idle_age=46, priority=1 actions=drop\n cookie=0x0, duration=46.236s, table=1, n_packets=0, n_bytes=0, idle_age=46, ct_state=+new,in_port=2 actions=ct(commit),NORMAL\n cookie=0x0, duration=46.235s, table=1, n_packets=0, n_bytes=0, idle_age=46, ct_state=+new,in_port=3 actions=drop\n cookie=0x0, duration=46.236s, table=1, n_packets=0, n_bytes=0, idle_age=46, ct_state=+est,in_port=2 actions=NORMAL\n cookie=0x0, duration=46.235s, table=1, n_packets=0, n_bytes=0, idle_age=46, ct_state=+est,in_port=3 actions=NORMAL\n```\n\n# Step4. \u901a\u4fe1\u30c6\u30b9\u30c8\n\n\u307e\u305aVM2\u5074\u304b\u3089VM1\u306b\u5bfe\u3057\u3066\u901a\u4fe1**\u3067\u304d\u306a\u3044**\u3053\u3068\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002icmp\u3084tcp\u3084udp\u30d1\u30b1\u30c3\u30c8\u3092\u98db\u3070\u3057\u3066\u307f\u307e\u3059\u3002\n\n```\n[root@centos6-2 ~]# ping 192.168.0.1\n[root@centos6-2 ~]# telnet 192.168.0.1\n[root@centos6-2 ~]# dig 192.168.0.1\n```\n\n\u30ab\u30a6\u30f3\u30bf\u3092\u78ba\u8a8d\u3059\u308b\u3068\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306b**drop\u30a8\u30f3\u30c8\u30ea**\u306b\u30de\u30c3\u30c1\u3057\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308a\u307e\u3059\u3002\n\n```\n[root@sl67-r3 ~]# ovs-ofctl dump-flows br0\nNXST_FLOW reply (xid=0x4):\n cookie=0x0, duration=282.937s, table=0, n_packets=8, n_bytes=736, idle_age=9, priority=100,ip actions=ct(table=1)\n cookie=0x0, duration=282.937s, table=0, n_packets=2, n_bytes=84, idle_age=13, priority=10,arp actions=NORMAL\n cookie=0x0, duration=282.937s, table=0, n_packets=0, n_bytes=0, idle_age=282, priority=1 actions=drop\n cookie=0x0, duration=282.937s, table=1, n_packets=0, n_bytes=0, idle_age=282, ct_state=+new,in_port=2 actions=ct(commit),NORMAL\n cookie=0x0, duration=282.936s, table=1, n_packets=8, n_bytes=736, idle_age=9, ct_state=+new,in_port=3 actions=drop\n cookie=0x0, duration=282.937s, table=1, n_packets=0, n_bytes=0, idle_age=282, ct_state=+est,in_port=2 actions=NORMAL\n cookie=0x0, duration=282.936s, table=1, n_packets=0, n_bytes=0, idle_age=282, ct_state=+est,in_port=3 actions=NORMAL\n```\n\n\u7d9a\u3044\u3066\u3001VM1\u304b\u3089VM2\u306b\u5bfe\u3057\u3066\u901a\u4fe1\u3092\u884c\u3044\u3001**\u6b63\u5e38\u306b\u63a5\u7d9a\u3067\u304d\u308b**\u3053\u3068\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n```\n[root@centos6-1 ~]# ping 192.168.0.2\n[root@centos6-1 ~]# telnet 192.168.0.2 22\n[root@centos6-1 ~]# dig @192.168.0.2\n```\n\n\u30ab\u30a6\u30f3\u30bf\u3092\u78ba\u8a8d\u3059\u308b\u3068\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306bconnection tracking\u306e\u30a8\u30f3\u30c8\u30ea\u306b\u30de\u30c3\u30c1\u3057\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308a\u307e\u3059\u3002\n\n```\n[root@sl67-r3 ~]# ovs-ofctl dump-flows br0\nNXST_FLOW reply (xid=0x4):\n cookie=0x0, duration=221.654s, table=0, n_packets=40, n_bytes=3154, idle_age=63, priority=100,ip actions=ct(table=1)\n cookie=0x0, duration=221.654s, table=0, n_packets=10, n_bytes=420, idle_age=63, priority=10,arp actions=NORMAL\n cookie=0x0, duration=221.653s, table=0, n_packets=0, n_bytes=0, idle_age=221, priority=1 actions=drop\n cookie=0x0, duration=221.653s, table=1, n_packets=14, n_bytes=1058, idle_age=63, ct_state=+new,in_port=2 actions=ct(commit),NORMAL\n cookie=0x0, duration=221.653s, table=1, n_packets=0, n_bytes=0, idle_age=221, ct_state=+new,in_port=3 actions=drop\n cookie=0x0, duration=221.653s, table=1, n_packets=8, n_bytes=629, idle_age=85, ct_state=+est,in_port=2 actions=NORMAL\n cookie=0x0, duration=221.653s, table=1, n_packets=12, n_bytes=945, idle_age=85, ct_state=+est,in_port=3 actions=NORMAL\n```\n\nnf_conntrack\u306e\u30c6\u30fc\u30d6\u30eb\u306b\u3082\u767b\u9332\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n\n```\n[root@sl67-r3 ~]# conntrack -L -s 192.168.0.1\nudp      17 28 src=192.168.0.1 dst=192.168.0.2 sport=38118 dport=53 [UNREPLIED] src=192.168.0.2 dst=192.168.0.1 sport=53 dport=38118 mark=0 use=1\ntcp      6 105 TIME_WAIT src=192.168.0.1 dst=192.168.0.2 sport=48265 dport=22 src=192.168.0.2 dst=192.168.0.1 sport=22 dport=48265 [ASSURED] mark=0 use=1\nicmp     1 4 src=192.168.0.1 dst=192.168.0.2 type=8 code=0 id=52997 [UNREPLIED] src=192.168.0.2 dst=192.168.0.1 type=0 code=0 id=52997 mark=0 use=1\nconntrack v0.9.13 (conntrack-tools): 3 flow entries have been shown.\n```\n\n\u7121\u4e8b\u306b\u52d5\u3044\u3066\u307e\u3059\u306d\uff01\n\n# \u8a2d\u5b9a\u306e\u610f\u5473\u3059\u308b\u3068\u3053\u308d\n\n\u4eca\u56de\u4ee5\u4e0b\u306e\u8a2d\u5b9a\u3092\u884c\u3044\u307e\u3057\u305f\u304c\u3001\u5b9f\u306f\u3053\u308c\u3001[ovs-ofctl\u30b3\u30de\u30f3\u30c9\u306e\u30de\u30cb\u30e5\u30a2\u30eb](http://openvswitch.org/support/dist-docs/ovs-ofctl.8.txt)\u306b\u8f09\u3063\u3066\u3044\u308b\u30b5\u30f3\u30d7\u30eb\u3092\u7c21\u7d20\u5316\u3057\u305f\u3082\u306e\u3067\u3059\u3002\n\n```\n     1  priority=100,ip,actions=ct(table=1)\n     2  priority=10,arp,actions=normal\n     3  priority=1,actions=drop\n     4\n     5  table=1,in_port=2,ct_state=+new,actions=ct(commit),normal\n     6  table=1,in_port=2,ct_state=+est,actions=normal\n     7  table=1,in_port=3,ct_state=+new,actions=drop\n     8  table=1,in_port=3,ct_state=+est,actions=normal\n```\n\n- 1\u884c\u76ee: IPv4\u30d1\u30b1\u30c3\u30c8\u3092conntrack\u30a4\u30f3\u30c6\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u6a5f\u80fd\u306e\u51e6\u7406\u306b\u56de\u3057\u307e\u3059\u3002\u5b9f\u969b\u30015\u884c\u76ee\u4ee5\u964d\u306etable1\u306e\u30eb\u30fc\u30eb\u304c\u8a55\u4fa1\u3055\u308c\u307e\u3059\u3002\n- 2\u884c\u76ee: 1\u884c\u76ee\u306b\u30de\u30c3\u30c1\u3057\u306a\u304b\u3063\u305f\u3082\u306e\u306e\u3046\u3061\u3001ARP\u30d1\u30b1\u30c3\u30c8\u306f\u305d\u3082\u305d\u3082conntrack\u3067\u304d\u307e\u305b\u3093\u306e\u3067\u3001\u3053\u3053\u3067\u7121\u6761\u4ef6\u306b\u8a31\u53ef\u3057\u3066\u3044\u307e\u3059\u3002\n- 3\u884c\u76ee: \u305d\u306e\u4ed6\u306e\u30d1\u30b1\u30c3\u30c8(IPv6\u3068\u304b)\u306f\u7834\u68c4\u3057\u307e\u3059\u3002\n- 5\u884c\u76ee: VM1\u304c\u767a\u3057\u305f\u65b0\u898f\u30bb\u30c3\u30b7\u30e7\u30f3\u3092conntrack\u306b\u767b\u9332\u3057\u3001\u30d1\u30b1\u30c3\u30c8\u8ee2\u9001\u3057\u307e\u3059\u3002\n- 6\u884c\u76ee: VM1\u304c\u767a\u3057\u305fconntrack\u306b\u8f09\u3063\u3066\u3044\u308b\u30bb\u30c3\u30b7\u30e7\u30f3\u306b\u30de\u30c3\u30c1\u3059\u308b\u30d1\u30b1\u30c3\u30c8\u3092\u8a31\u53ef\u3057\u307e\u3059\u3002\n- 7\u884c\u76ee: VM2\u304c\u767a\u3057\u305f\u65b0\u898f\u30bb\u30c3\u30b7\u30e7\u30f3\u306f\u7834\u68c4\u3057\u307e\u3059\u3002\n- 8\u884c\u76ee: VM2\u304c\u767a\u3057\u305fconntrack\u306b\u8f09\u3063\u3066\u3044\u308b\u30bb\u30c3\u30b7\u30e7\u30f3(5\u884c\u76ee\u3067\u767b\u9332\u3055\u308c\u305f)\u306b\u30de\u30c3\u30c1\u3059\u308b\u30d1\u30b1\u30c3\u30c8\u3092\u8a31\u53ef\u3057\u307e\u3059\u3002\n\n# \u6b21\u56de\u3078\u7d9a\u304f\n\n\u4eca\u56de\u306f\u6700\u3082\u7c21\u5358\u306a\u69cb\u6210\u3067\u3001nf_conntrack\u9023\u643a\u3092\u5229\u7528\u3057\u305f\u30b9\u30c6\u30fc\u30c8\u30d5\u30eb\u30d5\u30a1\u30a4\u30a2\u30a6\u30a9\u30fc\u30eb\u3092\u5b9f\u88c5\u3057\u3066\u307f\u307e\u3057\u305f\u3002\n\n\u6b21\u56de\u306f[\u5f0a\u793e\u30af\u30e9\u30a6\u30c9\u30b5\u30fc\u30d3\u30b9](http://cloud.sakura.ad.jp/)\u306b\u304a\u3051\u308b\u3001\u4eee\u60f3\u30b9\u30a4\u30c3\u30c1\u306e\u304a\u5ba2\u69d8\u30b5\u30fc\u30d0\u53ce\u5bb9\u69cb\u6210\u3092\u60f3\u5b9a\u3057\u305f\u30dd\u30ea\u30b7\u30fc\u306e\u5b9f\u88c5\u65b9\u6cd5\u3092\u691c\u8a0e\u3057\u3066\u307f\u307e\u3059\u3002\n\n\u2192 [Open vSwitch\u306econntrack\u9023\u643a\u3092\u8a66\u3057\u3066\u307f\u305f(\u305d\u306e3)](http://qiita.com/jh1vxw/items/f5881978242aaca3ca35)\n", "tags": ["OpenVSwitch", "nf_conntrack"]}