{"context": "2016/4/13\u3001Facebook\u304cMessenger Bot\u3092\u767a\u8868\u3057\u307e\u3057\u305f\u3002\u56fd\u5185\u3067\u306f\u3059\u3067\u306bLine\u3082bot\u5e02\u5834(\uff1f)\u306b\u53c2\u5165\u3057\u3066\u3044\u3066\u3001\u3053\u308c\u304b\u3089bot\u3092\u30d9\u30fc\u30b9\u3068\u3057\u305f\u30b5\u30fc\u30d3\u30b9\u3082\u7d9a\u3005\u3068\u5897\u3048\u3066\u3044\u304f\u3067\u3057\u3087\u3046\u3002Facebook Messenger Bot\u3068\u306f\u4f55\u304b\u3001\u305d\u3057\u3066\u4f55\u304c\u5b9f\u73fe\u3067\u304d\u308b\u306e\u304b\u3002\u305d\u308c\u3092\u77e5\u308b\u305f\u3081\u306b\u3082\u3001AWS Lambda + Serverless\u30d5\u30ec\u30fc\u30e0\u30ef\u30fc\u30af\u3092\u4f7f\u3063\u3066bot\u3092\u69cb\u7bc9\u3057\u3066\u307f\u307e\u3057\u305f\u3002\n\n\u5df7\u306b\u306fheroku\u3067\u69cb\u7bc9\u3057\u3066\u307f\u307e\u3057\u305f\u3068\u3044\u3046\u4f8b\u304c\u591a\u3044\u3067\u3059\u304c\u3001Lambda + Serverless\u3067\u69cb\u7bc9\u3059\u308b\u3053\u3068\u3067\u6b21\u306e\u30e1\u30ea\u30c3\u30c8\u304c\u3042\u308a\u307e\u3059\n\n\u904b\u7528\u30b3\u30b9\u30c8\u304c\u307b\u307c\u30bc\u30ed(Lambda\u306f\u6bce\u6708100\u4e07\u30ea\u30af\u30a8\u30b9\u30c8\u304c\u7121\u6599)\n\u30b5\u30fc\u30d0\u30fc\u30ec\u30b9\u306a\u306e\u3067\u7ba1\u7406\u30b3\u30b9\u30c8\u304c\u307b\u307c\u30bc\u30ed\nServerless\u306f\u4e00\u7a2e\u306eInfrastructure as Code\u306a\u306e\u3067\u3001\u30e1\u30f3\u30c6\u304c\u697d\n\n\u9006\u306bServerless\u306e\u30a2\u30c3\u30d7\u30c7\u30fc\u30c8\u304c\u65e9\u3059\u304e\u3066\u5927\u5909(\u5b9f\u969b\u306b\u4eca\u56de\u8a70\u307e\u3063\u305f)\u3068\u3044\u3046\u30c7\u30e1\u30ea\u30c3\u30c8\u306f\u3042\u308a\u307e\u3059\u304c\u3001\u305d\u3053\u306f\u6c17\u5408\u3067\u30ab\u30d0\u30fc\u3057\u307e\u3057\u3087\u3046\u3002\n\n\u306f\u3058\u3081\u306b\n\u5206\u304b\u308b\u4eba\u306f\u8aad\u307f\u98db\u3070\u3057\u3066\u5927\u4e08\u592b\u3067\u3059\n\nFacebook Messenger Bot\u3068\u306f\n\u4f01\u696d\u3084\u56e3\u4f53\u304c\u516c\u958b\u3057\u3066\u3044\u308bFacebook\u30da\u30fc\u30b8\u306b\u3082\u3001Messenger\u6a5f\u80fd\u304c\u3042\u308a\u307e\u3059\u3002\u901a\u5e38\u306f\u3001\u305d\u306eFacebook\u30da\u30fc\u30b8\u306b\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u9001\u308b\u3068\u7ba1\u7406\u8005\u306b\u901a\u77e5\u304c\u3044\u304f\u306e\u3067\u3059\u304c\u3001\u3053\u308c\u3092bot\u3067\u8fd4\u4fe1\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3057\u305f\u3002\n\u30b5\u30fc\u30d0\u30fc\u30921\u53f0\u7acb\u3066\u308b\u3060\u3051\u3067\u3001\u3042\u308b\u30e1\u30c3\u30bb\u30fc\u30b8\u306b\u5bfe\u3057\u3066\u81ea\u52d5\u7684\u306b\u8fd4\u7b54\u3092\u8fd4\u3059\u3001\u3068\u3044\u3046\u3053\u3068\u304c\u7c21\u5358\u306b\u5b9f\u73fe\u3067\u304d\u307e\u3059\u3002\u306a\u3093\u3060\u304b\u30d7\u30ed\u30c8\u30bf\u30a4\u30d4\u30f3\u30b0\u3067\u30e6\u30fc\u30b6\u30fc\u30cb\u30fc\u30ba\u3092\u5438\u3044\u4e0a\u3052\u308b\u3068\u304d\u3068\u304b\u306b\u4f7f\u3048\u305d\u3046\u3067\u3059\u306d(\u3068\u4eca\u601d\u3063\u305f)\u3002\n\nAWS Lambda\u3068\u306f\n2015\u5e74\u3042\u305f\u308a\u304b\u3089\u6ce8\u76ee\u3055\u308c\u3066\u3044\u308b\u3001\u30b5\u30fc\u30d0\u30fc\u30ec\u30b9\u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3\u3092\u5b9f\u73fe\u3059\u308bAWS\u306e\u30b5\u30fc\u30d3\u30b9\u3067\u3059\u3002\u901a\u5e38\u30d0\u30c3\u30af\u30a8\u30f3\u30c9\u306e\u4ed5\u7d44\u307f\u3092\u4f5c\u308b\u3068\u304d\u306f\u3001EC2\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u7acb\u3066\u3066\u301c\u3068\u3057\u3066\u3044\u307e\u3057\u305f\u304c\u3001Lambda\u306a\u3089\u305d\u308c\u304c\u4e0d\u8981\u3067\u3059\u3002Lambda\u306f\u30ea\u30af\u30a8\u30b9\u30c8\u304c\u3042\u308b\u5ea6\u306b\u8d77\u52d5\u3055\u308c\u3001\u3042\u308b\u5358\u4e00\u306e\u95a2\u6570(Lambda Function\u3068\u304b\u547c\u3070\u308c\u308b)\u3092\u5b9f\u884c\u3057\u3001\u30ec\u30b9\u30dd\u30f3\u30b9\u3092\u8fd4\u3057\u305f\u3089\u7d42\u4e86\u3057\u307e\u3059\u3002Lambda\u306b\u3088\u3063\u3066\u3001\u4eba\u3005\u306f\u30b5\u30fc\u30d0\u30fc\u306e\u30e1\u30f3\u30c6\u30ca\u30f3\u30b9\u3068\u3044\u3046\u4ed5\u4e8b\u304b\u3089\u89e3\u653e\u3055\u308c\u307e\u3059\u3002\n\nServerless\u3068\u306f\n\u305d\u306eAWS Lambda\u3092\u7c21\u5358\u306b\u4f7f\u3048\u308b\u3088\u3046\u306b\u3057\u305f\u306e\u304c\u3001Serverless\u3068\u3044\u3046AWS\u7d14\u6b63\u306e\u30d5\u30ec\u30fc\u30e0\u30ef\u30fc\u30af\u3067\u3059\u3002Lambda Function\u3092API\u3068\u3057\u3066\u4f7f\u3044\u305f\u3044\u5834\u5408\u3001API Gateway\u3068\u63a5\u7d9a\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u306e\u3067\u3059\u304c\u3001\u3053\u308c\u3092\u7c21\u5358\u306b\u8a2d\u5b9a\u3067\u304d\u305f\u308a\u3001\u8907\u6570\u306eLambda Function\u306e\u30c7\u30d7\u30ed\u30a4\u3092\u7c21\u6613\u5316\u3059\u308b\u306e\u304cServerless\u3067\u3059\u3002\u88cf\u3067\u306fCloud Formation\u304c\u52d5\u3044\u3066\u3044\u3066\u3001\u7c21\u5358\u306a\u30b3\u30de\u30f3\u30c9\u3068\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3067\u3044\u3044\u611f\u3058\u306b\u69cb\u7bc9\u3057\u3066\u304f\u308c\u307e\u3059\u3002\n\n\u52d5\u4f5c\u74b0\u5883\n\nServerless v0.5.5\nnode.js(\u958b\u767a\u74b0\u5883) v4.4.0\nnode.js(Lambda\u4e0a) v4.3.0\n\n\n\u69cb\u7bc9\u624b\u9806\n\u305d\u308c\u3067\u306f\u65e9\u901f\u3001bot\u3092\u69cb\u7bc9\u3057\u3066\u3044\u304d\u307e\u3057\u3087\u3046\u3002\n\n1.Facebook\u30da\u30fc\u30b8\u306e\u4f5c\u6210\u30fb\u30a2\u30d7\u30ea\u306e\u767b\u9332\n\u307e\u305a\u306f\u3001\u30e1\u30c3\u30bb\u30fc\u30b8\u306e\u3084\u308a\u53d6\u308a\u3092\u3059\u308bFacebook\u30da\u30fc\u30b8\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\u81ea\u5206\u306eFacebook\u306e\u30db\u30fc\u30e0\u304b\u3089\u3001\u5de6\u306b\u3042\u308b\u300cFacebook\u30da\u30fc\u30b8\u3092\u4f5c\u6210\u300d\u3092\u9078\u629e\u3057\u307e\u3059\u3002\u3053\u3053\u306e\u6587\u7ae0\u3001\u57fa\u672c\u7684\u306b\u898b\u5207\u308c\u3066\u308b\u3093\u3060\u3051\u3069\u3001\u3053\u308c\u3067\u3044\u3044\u306e\u304bFacebook...\n\u30c6\u30b9\u30c8\u7528\u30da\u30fc\u30b8\u306a\u306e\u3067\u3001\u5165\u529b\u9805\u76ee\u306f\u9069\u5f53\u3067\u3002\u300c\u30b3\u30df\u30e5\u30cb\u30c6\u30a3\u300d\u3092\u9078\u629e\u3057\u305f\u307b\u3046\u304c\u5165\u529b\u9805\u76ee\u5c11\u306a\u305d\u3046\u3067\u697d\u3067\u3057\u305f\u3002\n\nFacebook\u30da\u30fc\u30b8\u304c\u3067\u304d\u305f\u3089\u3001\u6b21\u306fbot\u30a2\u30d7\u30ea\u306e\u767b\u9332\u3092\u3057\u307e\u3059\u3002Facebook Developer\u3078\u306e\u767b\u9332\u304c\u5fc5\u8981\u3060\u3063\u305f\u6c17\u3082\u3057\u307e\u3059\u304c\u3001\u65e2\u306b\u767b\u9332\u6e08\u307f\u3060\u3063\u305f\u305f\u3081\u624b\u9806\u306f\u5206\u304b\u3089\u305a..\u307e\u3042\u305d\u308c\u307b\u3069\u96e3\u3057\u304f\u306a\u304b\u3063\u305f\u6c17\u304c\u3057\u307e\u3059\u3002\nhttps://developers.facebook.com/apps/\n[\u65b0\u3057\u3044\u30a2\u30d7\u30ea\u3092\u8ffd\u52a0]\u3092\u9078\u629e\n\n\u30a2\u30d7\u30ea\u306e\u9078\u629e\u3067\u306f[basic setup]\u3092\u9078\u3073\u307e\u3059\u3002\n\n\u3053\u306e\u8fba\u308a\u3082\u9069\u5f53\u306b\u3002\u30cd\u30fc\u30e0\u30b9\u30da\u30fc\u30b9\u306ftest\u3068\u304b\u9069\u5f53\u306a\u3084\u3064\u3060\u3068\u304b\u3076\u3063\u3066\u4f7f\u3048\u306a\u3044\u306e\u3067\u3054\u6ce8\u610f\u3092\u3002\n\n[Product Setup]\u306e\u753b\u9762\u306b\u9077\u79fb\u3059\u308b\u306e\u3067\u3001[Messenger]\u3092\u9078\u629e => [\u30b9\u30bf\u30fc\u30c8]\u3002\n\u30c8\u30fc\u30af\u30f3\u751f\u6210\u3067\u3001\u5148\u307b\u3069\u4f5c\u6210\u3057\u305fFacebook\u30da\u30fc\u30b8\u3092\u9078\u629e\u3002\u53f3\u306b\u8868\u793a\u3055\u308c\u308b\u30a2\u30af\u30bb\u30b9\u30c8\u30fc\u30af\u30f3\u3092\u30e1\u30e2\u3057\u3066\u304a\u304d\u307e\u3057\u3087\u3046\u3002\n\n\u5ff5\u306e\u305f\u3081\u3001\u5bfe\u8c61\u306e\u30da\u30fc\u30b8\u304c\u30d5\u30a9\u30ed\u30fc\u3055\u308c\u3066\u3044\u308b\u304b(bot\u306e\u30bf\u30fc\u30b2\u30c3\u30c8\u306b\u306a\u3063\u3066\u3044\u308b\u304b)\u3092\u78ba\u8a8d\u3057\u307e\u3057\u3087\u3046\u3002\n\n\u4e00\u65e6\u3053\u3053\u307e\u3067\u3067\u4f5c\u696d\u306f\u5b8c\u4e86\u3067\u3059\u3002\u3053\u306e\u30da\u30fc\u30b8\u306f\u9589\u3058\u305a\u306b\u7f6e\u3044\u3068\u304f\u3068\u697d\u3067\u3059\u3002\n\n2.Serverless\u306e\u69cb\u7bc9\n\u6b21\u306f\u5b9f\u884c\u3055\u308c\u308bAPI\u306e\u90e8\u5206\u3092\u3001AWS\u4e0a\u306b\u69cb\u7bc9\u3057\u3066\u3044\u304d\u307e\u3057\u3087\u3046\u3002\n\n\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u306e\u4f5c\u6210\n\u4f55\u306f\u3068\u3082\u3042\u308cServerless\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u307e\u3059\u3002\u3053\u306e\u8a18\u4e8b\u3092\u66f8\u3044\u3066\u3044\u308b\u6642\u70b9\u3067\u306f\u3001v0.5.5\u3092\u4f7f\u7528\u3057\u3066\u3044\u307e\u3059\u3002Serverless\u306f\u7d50\u69cb\u5909\u5316\u304c\u65e9\u3044\u306e\u3067\u3001\u30d0\u30fc\u30b8\u30e7\u30f3\u3092\u5408\u308f\u305b\u308b\u3053\u3068\u3092\u30aa\u30b9\u30b9\u30e1\u3057\u307e\u3059\u3002\u307e\u305f\u3001\u3082\u3057v0.5.5\u4ee5\u4e0a\u3092\u4f7f\u7528\u3055\u308c\u308b\u5834\u5408\u3001\u3053\u306e\u8a18\u4e8b\u306e\u901a\u308a\u306b\u52d5\u304f\u4fdd\u8a3c\u306f\u3042\u308a\u307e\u305b\u3093...\n$ npm i serverless -g\n\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u304c\u5b8c\u4e86\u3057\u305f\u3089\u3001\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002serverless\u30b3\u30de\u30f3\u30c9\u306fsls\u3068\u3082\u6253\u3066\u308b\u306e\u3067\u3001\u77ed\u3044\u65b9\u3067\u3002\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u4f5c\u6210\u5f8c\u3001\u305d\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306b\u79fb\u52d5\u3057\u3066Lambda Function\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\u6ce8\u610f\nServerless\u3092\u6700\u521d\u306b\u4f7f\u3046\u5834\u5408\u3001IAM\u30e6\u30fc\u30b6\u306e\u767b\u9332\u3084\u30a2\u30af\u30bb\u30b9\u30ad\u30fc\u306e\u767b\u9332\u304c\u5fc5\u8981\u3060\u3063\u305f\u6c17\u304c\u3057\u307e\u3059\u3002\u7b46\u8005\u306e\u74b0\u5883\u306b\u306f\u65e2\u306bServerless\u304c\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u3055\u308c\u3066\u3044\u305f\u305f\u3081\u3001\u305d\u306e\u624b\u9806\u3092\u306a\u305e\u308b\u3053\u3068\u304c\u51fa\u6765\u305a...\n\u3053\u306e\u3042\u305f\u308a\u306e\u8a18\u4e8b\u3092\u53c2\u8003\u306b\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u3057\u3066\u304f\u3060\u3055\u3044\u3002\nAWS Lambda\u3092\u6d3b\u7528\u3057\u305fServerless Framework\u3092\u89e6\u3063\u3066\u307f\u308b\n$ sls project create\n$ cd [project_name]\n$ sls function create\n\nruntime\u306b\u306fnode.js\u306e\u6700\u65b0\u7248\u3001API Gateway\u3092\u4f7f\u3046\u306e\u3067[Create Endpoint]\u3092\u9078\u629e\u3002\n\n\nAPI\u306e\u4f5c\u6210\n\u65e9\u901fLambda Function(\u5b9f\u884c\u3055\u308c\u308bAPI)\u3092\u66f8\u3044\u3066\u3044\u304f\u306e\u3067\u3059\u304c\u3001\u305d\u306e\u524d\u306bFacebook Messenger Bot\u306e\u4ed5\u69d8\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\u516c\u5f0f\u306e\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u306b\u4e00\u5ea6\u76ee\u3092\u901a\u3057\u3066\u304a\u304f\u3068\u3044\u3044\u3067\u3057\u3087\u3046\u3002\nMessenger Platform - Getting Started\nMessenger Bot\u3092\u69cb\u7bc9\u3059\u308b\u306b\u306f\u3001\u4efb\u610f\u306e\u30b5\u30fc\u30d0\u30fc\u3067GET\u3068POST\u306e2\u3064\u306eAPI\u3092\u89e3\u653e\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002path\u306f\u306a\u3093\u3067\u3082\u826f\u3044\u306e\u3067\u3059\u304c\u3001\u3053\u3053\u3067\u306f\u4eee\u306b/facebook \u3068\u3057\u3066\u8a71\u3092\u9032\u3081\u307e\u3057\u3087\u3046\u3002\n\n\nGET /facebook\uff1a\u6b63\u3057\u3044endpoint\u304b\u3092\u8a8d\u8a3c\u3059\u308b\u305f\u3081\u306eAPI\n\nPOST /facebok\uff1a\u5b9f\u969b\u306b\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u3046\u3051\u305f\u6642\u306b\u547c\u3070\u308c\u308bAPI\u3002\u3053\u3053\u3067bot\u306e\u51e6\u7406\u3092\u884c\u3046\n\n\u30a2\u30d7\u30ea\u3092\u767b\u9332\u3059\u308b\u3046\u3048\u3067\u3001\u307e\u305a\u306fGET\u306eAPI\u306f\u5148\u306b\u4f5c\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\u3068\u3044\u3046\u8a33\u3067\u3001GET API\u306e\u4f5c\u308a\u65b9\u3092\u898b\u3066\u3044\u304d\u307e\u3057\u3087\u3046\u3002\n\nGET /facebook\nGET\u306f\u8a8d\u8a3c\u7528\u306b\u89e3\u653e\u3059\u308bAPI\u3067\u3059\u3002Facebook Messenger Bot\u306b\u8a2d\u5b9a\u3057\u305fURL\u304c\u6b63\u3057\u3044\u304b\u3001\u3053\u306eAPI\u3092\u7528\u3044\u3066\u30c1\u30a7\u30c3\u30af\u3057\u307e\u3059\u3002\u30ea\u30d5\u30a1\u30ec\u30f3\u30b9\u3092\u898b\u308b\u9650\u308a\u3001\u6b21\u306e2\u3064\u306e\u4ed5\u69d8\u3092\u6e80\u305f\u3059\u5fc5\u8981\u304c\u3042\u308b\u3088\u3046\u3067\u3059\u3002\n\nQueryString\u3067\u6e21\u3055\u308c\u305fhub.verify_token\u304c\u3001\u4e8b\u524d\u306b\u751f\u6210\u3057\u305fToken\u3068\u5408\u3063\u3066\u3044\u308b\u304b\u30c1\u30a7\u30c3\u30af\u3059\u308b\n\u6b63\u3057\u3044\u5834\u5408\u3001QueryString\u3067\u6e21\u3055\u3055\u308c\u305fhub.challenge\u3092\u305d\u306e\u307e\u307e\u30ec\u30b9\u30dd\u30f3\u30b9\u3068\u3057\u3066\u8fd4\u3059\u3001\u305d\u308c\u4ee5\u5916\u306e\u5834\u5408\u306f\u9069\u5f53\u306a\u6587\u5b57\u5217\u3092\u8fd4\u3059\n\n\u3053\u306e\u4ed5\u69d8\u3092\u6e80\u305f\u3059API\u3092Lambda\u4e0a\u306b\u69cb\u7bc9\u3057\u307e\u3057\u3087\u3046\u3002Serverless\u3067\u306f\u3001\u307e\u305aAPI\u306e\u5b9a\u7fa9(API Gateway\u5074\u306e\u8a2d\u5b9a)\u3092s-function.json\u5185\u306eendpoints\u306b\u8a18\u8ff0\u3057\u307e\u3059\u3002\u5168\u4f53\u50cf\u306f\u6700\u5f8c\u306b\u8cbc\u308a\u307e\u3059\u3002\n\u307e\u305a\u3001\u300c\u3069\u306e\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u53d7\u3051\u53d6\u308b\u304b\u300d\u3092requestParameters\u5185\u306b\u8a18\u8ff0\u3057\u307e\u3059\u3002\u4eca\u56de\u306fQueryString\u306ehub.verify_token\u3068hub.challenge\u304c\u5fc5\u8981\u306a\u306e\u3067\u3001\u3053\u306e2\u3064\u3092\u6307\u5b9a\u3057\u307e\u3059\u3002\n\nfacebook-bot/s-function.json\n  \"requestParameters\": {\n    \"integration.request.querystring.hub.verify_token\": \"method.request.querystring.hub.verify_token\",\n    \"integration.request.querystring.hub.challenge\": \"method.request.querystring.hub.challenge\"\n  }\n\n\n\u6b21\u306b\u3001\u305d\u308c\u3089\u306e\u5024\u304cLambda\u4e0a\u3067\u3069\u306e\u3088\u3046\u306a\u540d\u524d\u3067\u53d6\u308c\u308b\u306e\u304b\u3001requestTemplates\u306b\u30de\u30c3\u30d4\u30f3\u30b0\u3092\u6307\u5b9a\u3057\u307e\u3059\u3002\u3053\u3053\u3067\u306f\u5148\u7a0b\u306e2\u3064\u306b\u52a0\u3048\u3001method\u3092\u5b9a\u7fa9\u3057\u3066\u3044\u307e\u3059\u3002\u4eca\u56de\u306fGET\u3068POST\u306e\u30ea\u30af\u30a8\u30b9\u30c8\u3092\uff11\u3064\u306eLambda Function\u3067\u53d6\u308a\u6271\u3046\u305f\u3081\u3001\u305d\u306e\u5224\u5b9a\u306e\u305f\u3081\u306bHTTP Method\u3092\u6e21\u3057\u3066\u3044\u307e\u3059\u3002\n\u3053\u3053\u306e\u8a18\u8ff0\u306fVTL\u3068\u3044\u3046\u8a00\u8a9e\u3067\u66f8\u304b\u308c\u3066\u3044\u308b\u3089\u3057\u304f\u3001\u8a73\u3057\u304f\u77e5\u308a\u305f\u3044\u65b9\u306f\u30b0\u30b0\u30c3\u3066\u304f\u3060\u3055\u3044\u3002\n\u3082\u3057\u304f\u306f\u516c\u5f0f\u30ea\u30d5\u30a1\u30ec\u30f3\u30b9\u3092\nAPI Gateway \u306e\u30de\u30c3\u30d4\u30f3\u30b0\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u30ea\u30d5\u30a1\u30ec\u30f3\u30b9\n\nfacebook-bot/s-function.json\n  \"requestTemplates\": {\n    \"application/json\": {\n      \"verify_token\": \"$input.params('hub.verify_token')\",\n      \"challenge\": \"$input.params('hub.challenge')\",\n      \"method\": \"$context.httpMethod\"\n    }\n  }\n\n\n\u6b21\u306b\u3001\u30ec\u30b9\u30dd\u30f3\u30b9\u306e\u30de\u30c3\u30d4\u30f3\u30b0\u3092\u3057\u307e\u3059\u3002Facebook Messenger Bot\u306f\u30d7\u30ec\u30fc\u30f3\u30c6\u30ad\u30b9\u30c8\u3092\u8fd4\u3059\u4ed5\u69d8\u306a\u306e\u3067\u3001responseTmplates\u5185\u306e\u8a18\u8ff0\u3092\u6b21\u306e\u7528\u306b\u66f8\u304d\u304b\u3048\u307e\u3059\u3002\n\nfacebook-bot/s-function.json\n  \"responses\": {\n    // \u301c\u4e2d\u7565\n    \"statusCode\": \"200\",\n    \"responseParameters\": {},\n    \"responseModels\": {\n      \"application/json;charset=UTF-8\": \"Empty\"\n    },\n    \"responseTemplates\": {\n      \"text/plain\": \"$input.path('$')\"\n    }\n  }\n\n\n\u6700\u5f8c\u306b\u3001GET\u30e1\u30bd\u30c3\u30c9\u306e\u30ed\u30b8\u30c3\u30af\u3092\u5b9f\u88c5\u3057\u307e\u3059\u3002Lambda\u306b\u767b\u9332\u3057\u305f\u30cf\u30f3\u30c9\u30e9\u306e\u5b9f\u88c5\u306f\u3001handler.js\u5185\u306b\u3042\u308a\u307e\u3059\u3002\u3053\u3053\u3067export\u3057\u305fhanderl\u304c\u3001API\u30b3\u30fc\u30eb\u306a\u3069\u306e\u30a4\u30d9\u30f3\u30c8\u767a\u706b\u6642\u306b\u547c\u3070\u308c\u308b\u3088\u3046\u306a\u4ed5\u7d44\u307f\u3067\u3059\u3002\u30ea\u30af\u30a8\u30b9\u30c8\u30d1\u30e9\u30e1\u30fc\u30bf\u306f\u5168\u3066\u4eee\u5f15\u6570event\u5185\u306b\u683c\u7d0d\u3055\u308c\u3001\u7b2c\uff13\u5f15\u6570\u306ecb\u3092\u5b9f\u884c\u3059\u308b\u3053\u3068\u3067function\u306e\u5b9f\u884c\u7d50\u679c\u304c\u8fd4\u308b\u4ed5\u7d44\u307f\u3067\u3059\u3002\n\u30b3\u30fc\u30c9\u306f\u3001\u30e1\u30bd\u30c3\u30c9\u304cGET\u306e\u5834\u5408\u3001verify_token\u3092\u8a55\u4fa1\u3057\u3066\u6b63\u3057\u3051\u308c\u3070challenge\u3092\u8fd4\u3059\u3001\u3068\u3044\u3046\u30b7\u30f3\u30d7\u30eb\u306a\u69cb\u9020\u3067\u3059\u3002\n\nhandler.js\n'use strict';\n\nconst FB_MESSANGER_TOKEN = 'xxxxxxxxxxxx';\n\nmodule.exports.handler = function(event, context, cb) {\n  switch (event.method.toUpperCase()) {\n    case 'GET': {\n      const validRequest = event.verify_token === FB_MESSANGER_TOKEN;\n      return cb(null, validRequest ? event.challenge : 'Error, wrong validation token');\n    }\n\n    default: return cb('Error, Invalid Method');\n  }\n};\n\n\n\u3053\u308c\u3067GET API\u306e\u4f5c\u6210\u306f\u5b8c\u4e86\u3067\u3059\u3002\u30c7\u30d7\u30ed\u30a4\u3057\u307e\u3057\u3087\u3046\u3002\nServerless\u306b\u306f\u3001dash deploy\u3068\u3044\u3046CUI\u3067\u7c21\u5358\u306b\u30c7\u30d7\u30ed\u30a4\u5bfe\u8c61\u304c\u9078\u629e\u3067\u304d\u308b\u30b3\u30de\u30f3\u30c9\u304c\u7528\u610f\u3055\u308c\u3044\u3066\u308b\u306e\u3067\u3001\u3053\u308c\u3092\u4f7f\u3044\u307e\u3059\u3002\n$ sls dash deploy\n\n\n\u30c7\u30d7\u30ed\u30a4\u304c\u5b8c\u4e86\u3057\u307e\u3057\u305f!\n\u3053\u3053\u307e\u3067\u6765\u305f\u3089\u3001\u5148\u307b\u3069\u306eFacebook Developer\u306b\u623b\u308a\u3001API\u306e\u30c6\u30b9\u30c8\u3092\u3057\u307e\u3057\u3087\u3046\u3002\n[Setup Webhooks]\u3092\u9078\u629e\u3002\n\nLambda\u306eURL\u3068\u3001\u5148\u307b\u3069\u751f\u6210\u3055\u308c\u305ftoken\u3092\u5165\u529b\u3001[messages]\u306b\u30c1\u30a7\u30c3\u30af\u3092\u5165\u308c\u3066\u78ba\u8a8d\u3057\u307e\u3059\u3002\u6307\u5b9a\u3055\u308c\u305fURL\u304b\u3089\u6b63\u3057\u304fChallenge\u304c\u8fd4\u3063\u3066\u304d\u305f\u3089\u6210\u529f\u3067\u3059\u3002\n\n\u30a8\u30e9\u30fc\u304c\u51fa\u308b\u5834\u5408\n\u6b21\u306e\u9805\u76ee\u3092\u78ba\u8a8d\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\nURL\u304c\u6b63\u3057\u3044\u304b\nAPI Gateway\u306e\u30b3\u30f3\u30bd\u30fc\u30eb\u304b\u3089\u6b63\u3057\u3044URL\u3092\u78ba\u8a8d\u3057\u3066\u304f\u3060\u3055\u3044\u3002\u3053\u3053\u306b\u8868\u793a\u3055\u308c\u3066\u3044\u308bEndpoint + Serverless\u3067\u6307\u5b9a\u3057\u305fpath\u3067\u3059\u3002\n\n\nLambda\u306e\u30ed\u30b0\u3092\u78ba\u8a8d\n\u8a72\u5f53\u3059\u308bLambda Function\u306e[View logs in CloudWatch]\u304b\u3089\u3001\u30ed\u30b0\u3092\u78ba\u8a8d\u3067\u304d\u307e\u3059\u3002\n\n\u6700\u65b0\u306e\u30ed\u30b0\u3092\u78ba\u8a8d\u3057\u3066\u30c7\u30d0\u30c3\u30b0\u3057\u307e\u3057\u3087\u3046\n\n\nPOST /facebook\n\u3053\u3053\u307e\u3067\u304d\u305f\u3089\u3001\u3042\u3068\u306f\u5b9f\u969b\u306bbot\u3068\u3057\u3066\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u8fd4\u3059API\u3092\u4f5c\u308a\u307e\u3059\u3002\u4eca\u56de\u306f\u3001\u7c21\u7565\u5316\u306e\u305f\u3081\u306b\u300c\u6765\u305f\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u305d\u306e\u307e\u307e\u8fd4\u3059bot\u300d\u306b\u3057\u307e\u3057\u3087\u3046\u3002\nPOST API\u306e\u4ed5\u69d8\u306f\u3001\u6b21\u306e\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002\n* \u53d7\u3051\u305f\u30ea\u30af\u30a8\u30b9\u30c8\u306b\u5bfe\u3057\u3066\u306f\u3001\u3068\u308a\u3042\u3048\u305a200 OK\u3092\u8fd4\u3059\n* \u30d1\u30e9\u30e1\u30fc\u30bf\u3067\u6e21\u3055\u308c\u305fsender_id(\u30e6\u30fc\u30b6\u30fc)\u306b\u5bfe\u3057\u3066\u3001POST\u30ea\u30af\u30a8\u30b9\u30c8\u3092\u6295\u3052\u3066\u5fdc\u7b54\u3059\u308b\n\u30ec\u30b9\u30dd\u30f3\u30b9\u3067\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u8fd4\u3059\u308f\u3051\u3058\u3083\u306a\u3044\u3093\u3067\u3059\u306d\u3002\u306a\u308b\u307b\u3069\u3002\n\u65e9\u901f\u3053\u306e\u4ed5\u69d8\u306b\u5bfe\u5fdc\u3057\u305fAPI\u306e\u5b9a\u7fa9\u3092\u8ffd\u52a0\u3057\u307e\u3059\u3002s-function.json\u306b\u306fendpoint\u3092\u8907\u6570\u6307\u5b9a\u3067\u304d\u308b\u306e\u3067\u3001\u5148\u307b\u3069\u306e\u30d5\u30a1\u30a4\u30eb\u306b\u8ffd\u8a18\u3057\u3066\u3044\u304d\u307e\u3059\u3002POST\u30ea\u30af\u30a8\u30b9\u30c8\u306ejson\u3067\u6e21\u3055\u308c\u305f\u30d1\u30e9\u30e1\u30fc\u30bf\u304b\u3089\u3001entry\u306e\u307fLambda\u306b\u6e21\u3057\u3066\u3042\u3052\u308b\u8a2d\u5b9a\u306b\u3057\u3066\u3044\u307e\u3059\u3002\n\nfaceboo/s-function.json\n    {\n      \"path\": \"facebook\",\n      \"method\": \"POST\",\n      \"type\": \"AWS\",\n      \"authorizationType\": \"none\",\n      \"authorizerFunction\": false,\n      \"apiKeyRequired\": false,\n      \"requestParameters\": {},\n      \"requestTemplates\": {\n        \"application/json\": {\n          \"entry\": \"$input.json('entry')\",\n          \"method\": \"$context.httpMethod\"\n        }\n      },\n      \"responses\": {\n        \"400\": {\n          \"statusCode\": \"400\"\n        },\n        \"default\": {\n          \"statusCode\": \"200\",\n          \"responseParameters\": {},\n          \"responseModels\": {\n            \"application/json;charset=UTF-8\": \"Empty\"\n          },\n          \"responseTemplates\": {\n            \"text/plain\": \"$input.path('$')\"\n          }\n        }\n      }\n    }\n\n\nhandler\u306b\u30b3\u30fc\u30c9\u3092\u8ffd\u8a18\u3057\u307e\u3059\u3002\u30ea\u30af\u30a8\u30b9\u30c8\u3092\u6295\u3052\u308b\u305f\u3081\u306e\u30e2\u30b8\u30e5\u30fc\u30eb\u3092\u8ffd\u52a0\u3057\u3001\n$ npm i request -S\n\n\u30b3\u30fc\u30c9\u306f\u3053\u3046\u3044\u3046\u611f\u3058\u3067\u3059\u3002\u30d1\u30e9\u30e1\u30fc\u30bf\u4e2d\u306esender.id\u306b\u5bfe\u3057\u3066\u30ea\u30af\u30a8\u30b9\u30c8\u3092\u6295\u3052\u308b\u3060\u3051\u3002\n\nfacebook/handler.js\nconst request = require('request');\n\nconst FB_MESSANGER_TOKEN = 'xxxxx';\n\nmodule.exports.handler = function(event, context, cb) {\n  switch (event.method.toUpperCase()) {\n    case 'GET': // \u7565\n\n    case 'POST': {\n      event.entry[0].messaging.filter(m => m.message && m.message.text).forEach(m => sendTextMessage(m.sender.id, m.message.text));\n      return cb(null, 'OK');\n    }\n    // \u7565\n  }\n};\n\nfunction sendTextMessage(sender, text) {\n  request({\n    url: 'https://graph.facebook.com/v2.6/me/messages',\n    qs: { access_token: FB_MESSANGER_TOKEN },\n    method: 'POST',\n    json: {\n      recipient: { id: sender },\n      message: { text: text },\n    }\n  }, function(error, response, body) {\n    if (error) {\n      console.log('Error sending message: ', error);\n    } else if (response.body.error) {\n      console.log('Error: ', response.body.error);\n    }\n  });\n}\n\n\n\u3053\u3053\u3067\u30b3\u30fc\u30c7\u30a3\u30f3\u30b0\u81ea\u4f53\u306f\u7d42\u308f\u308a\u306a\u306e\u3067\u3059\u304c\u3001Serverless\u306f\u30c7\u30d5\u30a9\u30eb\u30c8\u3067\u306frequire\u3067\u4f9d\u5b58\u3057\u305f\u30e2\u30b8\u30e5\u30fc\u30eb\u3092\u30c7\u30d7\u30ed\u30a4\u3057\u3066\u304f\u308c\u307e\u305b\u3093\u3002\u6614\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u3060\u3068\u307e\u3068\u3081\u3066zip\u306b\u3057\u3066\u30c7\u30d7\u30ed\u30a4\u3057\u3066\u304f\u308c\u305f\u306e\u3067\u3059\u304c(\u3053\u3053\u3067\u7dba\u9e97\u306b\u30cf\u30de\u3063\u305f)\u3001Lambda\u306b\u30c7\u30d7\u30ed\u30a4\u3059\u308b\u30e2\u30fc\u30b8\u30e5\u30fc\u30eb\u304c10MB\u307e\u3067\u3068\u3044\u3046\u5236\u9650\u306b\u5bfe\u51e6\u3059\u308b\u305f\u3081\u3001v0.5.5\u3067\u306fbroserify\u3084webpack\u3067\u6700\u9069\u5316\u3055\u308c\u305f\uff11\u3064\u306ehandler.js\u3092\u30c7\u30d7\u30ed\u30a4\u3059\u308b\u3088\u3046\u306b\u5909\u66f4\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n\u305d\u308c\u3089\u306fplugin\u3068\u3044\u3046\u5f62\u3067\u63d0\u4f9b\u3055\u308c\u3066\u3044\u3066\u3001\u5c0e\u5165\u81ea\u4f53\u306f\u697d\u306a\u306e\u3067\u3059\u304c\u3001\u77e5\u3089\u306a\u3044\u3068\u3064\u3089\u3044\u3067\u3059...\n\u3068\u3044\u3046\u308f\u3051\u3067\u95a2\u9023\u30e2\u30b8\u30e5\u30fc\u30eb\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3002browserify\u3068\u304bbabel\u3068\u304b\u3088\u304f\u5206\u304b\u3089\u306a\u3044\u4eba\u306f\u3001\u3068\u308a\u3042\u3048\u305a\u30b3\u30d4\u30da\u3057\u307e\u3057\u3087\u3046(\u3067\u3082\u77e5\u3063\u3066\u304a\u3044\u305f\u65b9\u304c\u3044\u3044\u3067\u3059\u3088)\u3002\n$ npm i serverless-optimizer-plugin babelify babel-preset-es2015 -S\n\n\u30eb\u30fc\u30c8\u306es-project.json\u306b\u4f7f\u7528\u3059\u308b\u30d7\u30e9\u30b0\u30a4\u30f3\u3092\u8a18\u8ff0\u3057\u307e\u3059\u3002\n\ns-project.json\n  \"plugins\": [\n    \"serverless-optimizer-plugin\"\n  ]\n\n\n\u305d\u3057\u3066\u30d7\u30e9\u30b0\u30a4\u30f3\u306e\u8a2d\u5b9a\u306fs-function.json\u306b\u3002browserify\u3059\u308b\u3068\u304d\u306e\u8a2d\u5b9a\u3092\u8a18\u8ff0\u3059\u308b\u306e\u3067\u3059\u304c\u3001ES2015\u306e\u8a18\u6cd5\u3092\u4f7f\u3063\u3066\u3044\u308b\u5834\u5408(Arrow Function\u3068\u304b)\u306fbabelify\u3092\u901a\u3055\u306a\u3044\u3068\u6b7b\u306b\u307e\u3059\u3002\u305b\u3063\u304b\u304fLambda\u304cnode v4\u306b\u5bfe\u5fdc\u3057\u305f\u306e\u306b\u30d0\u30d9\u3089\u306a\u3044\u3068\u3044\u3051\u306a\u3044\u306a\u3093\u3066...\n\nfacebook/s-function.json\n  \"custom\": {\n    \"excludePatterns\": [],\n    \"optimize\": {\n      \"exclude\": [\"aws-sdk\"],\n      \"transforms\": [\n        {\n          \"name\": \"babelify\",\n          \"opts\": {\n            \"presets\": [\"es2015\"]\n          }\n        }\n      ]\n    }\n\n\n\u3053\u308c\u3067\u5b8c\u4e86\u3067\u3059\u3002\u307e\u305fsls dash deploy\u30b3\u30de\u30f3\u30c9\u3067\u30c7\u30d7\u30ed\u30a4\u3057\u307e\u3057\u3087\u3046\u3002\n\u52d5\u304b\u306a\u3044\u6642\n\n\u30d0\u30f3\u30c9\u30eb\u3055\u308c\u305f\u30b3\u30fc\u30c9\u3092\u78ba\u8a8d\u3059\u308b\n\u304d\u3061\u3093\u3068browserify\u304c\u52d5\u3044\u3066\u3044\u308b\u304b\u78ba\u8a8d\u3057\u307e\u3059\u3002Lambda\u306e\u30b3\u30f3\u30bd\u30fc\u30eb\u304b\u3089\u30c7\u30d7\u30ed\u30a4\u3055\u308c\u305f\u30b3\u30fc\u30c9\u304c\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3067\u304d\u308b\u306e\u3067\u3001\u3061\u3083\u3093\u3068browseify\u3055\u308c\u3066\u3044\u308b\u304b\u78ba\u8a8d\u3057\u307e\u3059\u3002\u3054\u3061\u3083\u3054\u3061\u3083\u5727\u7e2e\u3055\u308c\u305f\u30d5\u30a1\u30a4\u30eb\u304c\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3067\u304d\u305f\u3089\u305f\u3076\u3093OK\u3067\u3059\u3002\n\n\n\u52d5\u4f5c\u78ba\u8a8d\n\u4f5c\u6210\u3057\u305fFacebook\u30da\u30fc\u30b8\u304b\u3089\u3001\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u9001\u308a\u307e\u3059\u3002\n\n\u3061\u3083\u3093\u3068\u30ec\u30b9\u30dd\u30f3\u30b9\u304c\u8fd4\u3063\u3066\u304d\u307e\u3057\u305f\uff01\uff01\uff01\uff01\uff01\n\n\n\u30b3\u30fc\u30c9\n\u4eca\u56de\u4f7f\u7528\u3057\u305f\u30b3\u30fc\u30c9\u306e\u5168\u4f53\u50cf\u3067\u3059\u3002\u30b3\u30d4\u30da\u3057\u305f\u3089\u305f\u3076\u3093\u52d5\u304d\u307e\u3059\u3002\n\n\u5b9f\u884c\u3057\u305f\u30b3\u30de\u30f3\u30c9\n$ sls project create\n$ cd facebook-bot\n$ sls function create\n\n$ npm i request serverless-optimizer-plugin babelify babel-preset-es2015 -S\n$ npm install  -S\n\n$ sls dash deploy\n\n\ns-project.json\n\ns-porject.json\n{\n  \"name\": \"facebook-bot\",\n  \"custom\": {},\n  \"plugins\": [\n    \"serverless-optimizer-plugin\"\n  ]\n}\n\n\n\ns-function.json\n\ns-function.json\n{\n  \"name\": \"facebook-bot\",\n  \"runtime\": \"nodejs4.3\",\n  \"description\": \"Serverless Lambda function for project: facebook-bot\",\n  \"customName\": false,\n  \"customRole\": false,\n  \"handler\": \"handler.handler\",\n  \"timeout\": 6,\n  \"memorySize\": 1024,\n  \"authorizer\": {},\n  \"custom\": {\n    \"excludePatterns\": [],\n    \"optimize\": {\n      \"exclude\": [\"aws-sdk\"],\n      \"transforms\": [\n        {\n          \"name\": \"babelify\",\n          \"opts\": {\n            \"presets\": [\"es2015\"]\n          }\n        }\n      ]\n    }\n  },\n  \"endpoints\": [\n    {\n      \"path\": \"facebook\",\n      \"method\": \"GET\",\n      \"type\": \"AWS\",\n      \"authorizationType\": \"none\",\n      \"authorizerFunction\": false,\n      \"apiKeyRequired\": false,\n      \"requestParameters\": {\n        \"integration.request.querystring.hub.verify_token\": \"method.request.querystring.hub.verify_token\",\n        \"integration.request.querystring.hub.challenge\": \"method.request.querystring.hub.challenge\"\n      },\n      \"requestTemplates\": {\n        \"application/json\": {\n          \"verify_token\": \"$input.params('hub.verify_token')\",\n          \"challenge\": \"$input.params('hub.challenge')\",\n          \"method\": \"$context.httpMethod\"\n        }\n      },\n      \"responses\": {\n        \"400\": {\n          \"statusCode\": \"400\"\n        },\n        \"default\": {\n          \"statusCode\": \"200\",\n          \"responseParameters\": {},\n          \"responseModels\": {\n            \"application/json;charset=UTF-8\": \"Empty\"\n          },\n          \"responseTemplates\": {\n            \"text/plain\": \"$input.path('$')\"\n          }\n        }\n      }\n    },\n    {\n      \"path\": \"facebook\",\n      \"method\": \"POST\",\n      \"type\": \"AWS\",\n      \"authorizationType\": \"none\",\n      \"authorizerFunction\": false,\n      \"apiKeyRequired\": false,\n      \"requestParameters\": {},\n      \"requestTemplates\": {\n        \"application/json\": {\n          \"entry\": \"$input.json('entry')\",\n          \"method\": \"$context.httpMethod\"\n        }\n      },\n      \"responses\": {\n        \"400\": {\n          \"statusCode\": \"400\"\n        },\n        \"default\": {\n          \"statusCode\": \"200\",\n          \"responseParameters\": {},\n          \"responseModels\": {\n            \"application/json;charset=UTF-8\": \"Empty\"\n          },\n          \"responseTemplates\": {\n            \"text/plain\": \"$input.path('$')\"\n          }\n        }\n      }\n    }\n  ],\n  \"events\": [],\n  \"environment\": {\n    \"SERVERLESS_PROJECT\": \"${project}\",\n    \"SERVERLESS_STAGE\": \"${stage}\",\n    \"SERVERLESS_REGION\": \"${region}\"\n  },\n  \"vpc\": {\n    \"securityGroupIds\": [],\n    \"subnetIds\": []\n  }\n}\n\n\n\nhandler.js\n\nhandler.js\n'use strict';\n\nconst request = require('request');\n\nconst FB_MESSANGER_TOKEN = '\u3053\u3053\u306btoken\u3092\u66f8\u304f';\n\nmodule.exports.handler = function(event, context, cb) {\n\n  switch (event.method.toUpperCase()) {\n    case 'GET': {\n      const validRequest = event.verify_token === FB_MESSANGER_TOKEN;\n      return cb(null, validRequest ? event.challenge : 'Error, wrong validation token');\n    }\n\n    case 'POST': {\n      event.entry[0].messaging.filter(m => m.message && m.message.text).forEach(m => sendTextMessage(m.sender.id, m.message.text));\n      return cb(null, 'OK');\n    }\n\n    default: return cb('Error, Invalid Method');\n  }\n};\n\nfunction sendTextMessage(sender, text) {\n  const messageData = {\n    text:text\n  }\n\n  request({\n    url: 'https://graph.facebook.com/v2.6/me/messages',\n    qs: {\n      access_token: FB_MESSANGER_TOKEN\n    },\n    method: 'POST',\n    json: {\n      recipient: {\n        id: sender\n      },\n      message: messageData,\n    }\n  }, function(error, response, body) {\n\n    if (error) {\n      console.log('Error sending message: ', error);\n    } else if (response.body.error) {\n      console.log('Error: ', response.body.error);\n    }\n  });\n}\n\n\n\n\u53c2\u8003\n\nMessenger Platform - Getting Started\n\u30b8\u30e3\u30b9\u30c830\u5206\uff01FB\u30e1\u30c3\u30bb\u30f3\u30b8\u30e3\u30fcbot\u3092\u3068\u308a\u3042\u3048\u305a\u4f5c\u3063\u3066\u307f\u308b\u624b\u9806\u307e\u3068\u3081\nServerless\nserverless-optimizer-plugin\noptimizer-plugin\u3092\u4f7f\u3063\u3066\u3001es6(es2015)\u3067serverless framework\u306e\u30b3\u30fc\u30c9\u3092\u66f8\u304f\nAWS Lambda\u3092\u6d3b\u7528\u3057\u305fServerless Framework\u3092\u89e6\u3063\u3066\u307f\u308b\n\n2016/4/13\u3001[Facebook\u304cMessenger Bot\u3092\u767a\u8868\u3057\u307e\u3057\u305f](http://jp.techcrunch.com/2016/04/13/20160412agents-on-messenger/)\u3002\u56fd\u5185\u3067\u306f\u3059\u3067\u306bLine\u3082bot\u5e02\u5834(\uff1f)\u306b\u53c2\u5165\u3057\u3066\u3044\u3066\u3001\u3053\u308c\u304b\u3089bot\u3092\u30d9\u30fc\u30b9\u3068\u3057\u305f\u30b5\u30fc\u30d3\u30b9\u3082\u7d9a\u3005\u3068\u5897\u3048\u3066\u3044\u304f\u3067\u3057\u3087\u3046\u3002Facebook Messenger Bot\u3068\u306f\u4f55\u304b\u3001\u305d\u3057\u3066\u4f55\u304c\u5b9f\u73fe\u3067\u304d\u308b\u306e\u304b\u3002\u305d\u308c\u3092\u77e5\u308b\u305f\u3081\u306b\u3082\u3001AWS Lambda + Serverless\u30d5\u30ec\u30fc\u30e0\u30ef\u30fc\u30af\u3092\u4f7f\u3063\u3066bot\u3092\u69cb\u7bc9\u3057\u3066\u307f\u307e\u3057\u305f\u3002\n\n![Serverless](https://qiita-image-store.s3.amazonaws.com/0/52054/a1d20f74-2c6d-9df4-f2dc-0acd04d803a8.png)\n\n\u5df7\u306b\u306fheroku\u3067\u69cb\u7bc9\u3057\u3066\u307f\u307e\u3057\u305f\u3068\u3044\u3046\u4f8b\u304c\u591a\u3044\u3067\u3059\u304c\u3001Lambda + Serverless\u3067\u69cb\u7bc9\u3059\u308b\u3053\u3068\u3067\u6b21\u306e\u30e1\u30ea\u30c3\u30c8\u304c\u3042\u308a\u307e\u3059\n\n* \u904b\u7528\u30b3\u30b9\u30c8\u304c\u307b\u307c\u30bc\u30ed(Lambda\u306f\u6bce\u6708100\u4e07\u30ea\u30af\u30a8\u30b9\u30c8\u304c\u7121\u6599)\n* \u30b5\u30fc\u30d0\u30fc\u30ec\u30b9\u306a\u306e\u3067\u7ba1\u7406\u30b3\u30b9\u30c8\u304c\u307b\u307c\u30bc\u30ed\n* Serverless\u306f\u4e00\u7a2e\u306eInfrastructure as Code\u306a\u306e\u3067\u3001\u30e1\u30f3\u30c6\u304c\u697d\n\n\u9006\u306bServerless\u306e\u30a2\u30c3\u30d7\u30c7\u30fc\u30c8\u304c\u65e9\u3059\u304e\u3066\u5927\u5909(\u5b9f\u969b\u306b\u4eca\u56de\u8a70\u307e\u3063\u305f)\u3068\u3044\u3046\u30c7\u30e1\u30ea\u30c3\u30c8\u306f\u3042\u308a\u307e\u3059\u304c\u3001\u305d\u3053\u306f\u6c17\u5408\u3067\u30ab\u30d0\u30fc\u3057\u307e\u3057\u3087\u3046\u3002\n\n# \u306f\u3058\u3081\u306b\n\u5206\u304b\u308b\u4eba\u306f\u8aad\u307f\u98db\u3070\u3057\u3066\u5927\u4e08\u592b\u3067\u3059\n\n## Facebook Messenger Bot\u3068\u306f\n\u4f01\u696d\u3084\u56e3\u4f53\u304c\u516c\u958b\u3057\u3066\u3044\u308bFacebook\u30da\u30fc\u30b8\u306b\u3082\u3001Messenger\u6a5f\u80fd\u304c\u3042\u308a\u307e\u3059\u3002\u901a\u5e38\u306f\u3001\u305d\u306eFacebook\u30da\u30fc\u30b8\u306b\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u9001\u308b\u3068\u7ba1\u7406\u8005\u306b\u901a\u77e5\u304c\u3044\u304f\u306e\u3067\u3059\u304c\u3001\u3053\u308c\u3092bot\u3067\u8fd4\u4fe1\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3057\u305f\u3002\n\n\u30b5\u30fc\u30d0\u30fc\u30921\u53f0\u7acb\u3066\u308b\u3060\u3051\u3067\u3001\u3042\u308b\u30e1\u30c3\u30bb\u30fc\u30b8\u306b\u5bfe\u3057\u3066\u81ea\u52d5\u7684\u306b\u8fd4\u7b54\u3092\u8fd4\u3059\u3001\u3068\u3044\u3046\u3053\u3068\u304c\u7c21\u5358\u306b\u5b9f\u73fe\u3067\u304d\u307e\u3059\u3002\u306a\u3093\u3060\u304b\u30d7\u30ed\u30c8\u30bf\u30a4\u30d4\u30f3\u30b0\u3067\u30e6\u30fc\u30b6\u30fc\u30cb\u30fc\u30ba\u3092\u5438\u3044\u4e0a\u3052\u308b\u3068\u304d\u3068\u304b\u306b\u4f7f\u3048\u305d\u3046\u3067\u3059\u306d(\u3068\u4eca\u601d\u3063\u305f)\u3002\n\n## AWS Lambda\u3068\u306f\n2015\u5e74\u3042\u305f\u308a\u304b\u3089\u6ce8\u76ee\u3055\u308c\u3066\u3044\u308b\u3001\u30b5\u30fc\u30d0\u30fc\u30ec\u30b9\u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3\u3092\u5b9f\u73fe\u3059\u308bAWS\u306e\u30b5\u30fc\u30d3\u30b9\u3067\u3059\u3002\u901a\u5e38\u30d0\u30c3\u30af\u30a8\u30f3\u30c9\u306e\u4ed5\u7d44\u307f\u3092\u4f5c\u308b\u3068\u304d\u306f\u3001EC2\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u7acb\u3066\u3066\u301c\u3068\u3057\u3066\u3044\u307e\u3057\u305f\u304c\u3001Lambda\u306a\u3089\u305d\u308c\u304c\u4e0d\u8981\u3067\u3059\u3002Lambda\u306f\u30ea\u30af\u30a8\u30b9\u30c8\u304c\u3042\u308b\u5ea6\u306b\u8d77\u52d5\u3055\u308c\u3001\u3042\u308b\u5358\u4e00\u306e\u95a2\u6570(Lambda Function\u3068\u304b\u547c\u3070\u308c\u308b)\u3092\u5b9f\u884c\u3057\u3001\u30ec\u30b9\u30dd\u30f3\u30b9\u3092\u8fd4\u3057\u305f\u3089\u7d42\u4e86\u3057\u307e\u3059\u3002Lambda\u306b\u3088\u3063\u3066\u3001\u4eba\u3005\u306f\u30b5\u30fc\u30d0\u30fc\u306e\u30e1\u30f3\u30c6\u30ca\u30f3\u30b9\u3068\u3044\u3046\u4ed5\u4e8b\u304b\u3089\u89e3\u653e\u3055\u308c\u307e\u3059\u3002\n\n## Serverless\u3068\u306f\n\u305d\u306eAWS Lambda\u3092\u7c21\u5358\u306b\u4f7f\u3048\u308b\u3088\u3046\u306b\u3057\u305f\u306e\u304c\u3001Serverless\u3068\u3044\u3046AWS\u7d14\u6b63\u306e\u30d5\u30ec\u30fc\u30e0\u30ef\u30fc\u30af\u3067\u3059\u3002Lambda Function\u3092API\u3068\u3057\u3066\u4f7f\u3044\u305f\u3044\u5834\u5408\u3001API Gateway\u3068\u63a5\u7d9a\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u306e\u3067\u3059\u304c\u3001\u3053\u308c\u3092\u7c21\u5358\u306b\u8a2d\u5b9a\u3067\u304d\u305f\u308a\u3001\u8907\u6570\u306eLambda Function\u306e\u30c7\u30d7\u30ed\u30a4\u3092\u7c21\u6613\u5316\u3059\u308b\u306e\u304cServerless\u3067\u3059\u3002\u88cf\u3067\u306fCloud Formation\u304c\u52d5\u3044\u3066\u3044\u3066\u3001\u7c21\u5358\u306a\u30b3\u30de\u30f3\u30c9\u3068\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3067\u3044\u3044\u611f\u3058\u306b\u69cb\u7bc9\u3057\u3066\u304f\u308c\u307e\u3059\u3002\n\n# \u52d5\u4f5c\u74b0\u5883\n* Serverless v0.5.5\n* node.js(\u958b\u767a\u74b0\u5883) v4.4.0\n* node.js(Lambda\u4e0a) v4.3.0\n\n# \u69cb\u7bc9\u624b\u9806\n\u305d\u308c\u3067\u306f\u65e9\u901f\u3001bot\u3092\u69cb\u7bc9\u3057\u3066\u3044\u304d\u307e\u3057\u3087\u3046\u3002\n\n## 1.Facebook\u30da\u30fc\u30b8\u306e\u4f5c\u6210\u30fb\u30a2\u30d7\u30ea\u306e\u767b\u9332\n\u307e\u305a\u306f\u3001\u30e1\u30c3\u30bb\u30fc\u30b8\u306e\u3084\u308a\u53d6\u308a\u3092\u3059\u308bFacebook\u30da\u30fc\u30b8\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\u81ea\u5206\u306eFacebook\u306e\u30db\u30fc\u30e0\u304b\u3089\u3001\u5de6\u306b\u3042\u308b\u300cFacebook\u30da\u30fc\u30b8\u3092\u4f5c\u6210\u300d\u3092\u9078\u629e\u3057\u307e\u3059\u3002\u3053\u3053\u306e\u6587\u7ae0\u3001\u57fa\u672c\u7684\u306b\u898b\u5207\u308c\u3066\u308b\u3093\u3060\u3051\u3069\u3001\u3053\u308c\u3067\u3044\u3044\u306e\u304bFacebook...\n\n\u30c6\u30b9\u30c8\u7528\u30da\u30fc\u30b8\u306a\u306e\u3067\u3001\u5165\u529b\u9805\u76ee\u306f\u9069\u5f53\u3067\u3002\u300c\u30b3\u30df\u30e5\u30cb\u30c6\u30a3\u300d\u3092\u9078\u629e\u3057\u305f\u307b\u3046\u304c\u5165\u529b\u9805\u76ee\u5c11\u306a\u305d\u3046\u3067\u697d\u3067\u3057\u305f\u3002\n\n![Facebook\u30da\u30fc\u30b8\u306e\u4f5c\u6210](https://qiita-image-store.s3.amazonaws.com/0/52054/59def2c6-d670-6199-4769-513e39336e7f.png)\n\nFacebook\u30da\u30fc\u30b8\u304c\u3067\u304d\u305f\u3089\u3001\u6b21\u306fbot\u30a2\u30d7\u30ea\u306e\u767b\u9332\u3092\u3057\u307e\u3059\u3002Facebook Developer\u3078\u306e\u767b\u9332\u304c\u5fc5\u8981\u3060\u3063\u305f\u6c17\u3082\u3057\u307e\u3059\u304c\u3001\u65e2\u306b\u767b\u9332\u6e08\u307f\u3060\u3063\u305f\u305f\u3081\u624b\u9806\u306f\u5206\u304b\u3089\u305a..\u307e\u3042\u305d\u308c\u307b\u3069\u96e3\u3057\u304f\u306a\u304b\u3063\u305f\u6c17\u304c\u3057\u307e\u3059\u3002\n\nhttps://developers.facebook.com/apps/\n\n[\u65b0\u3057\u3044\u30a2\u30d7\u30ea\u3092\u8ffd\u52a0]\u3092\u9078\u629e\n\n![\u65b0\u3057\u3044\u30a2\u30d7\u30ea\u3092\u8ffd\u52a0](https://qiita-image-store.s3.amazonaws.com/0/52054/fa9909ab-5e74-45ca-6b11-e0beea2eec94.png)\n\n\u30a2\u30d7\u30ea\u306e\u9078\u629e\u3067\u306f[basic setup]\u3092\u9078\u3073\u307e\u3059\u3002\n\n![basic setup\u3092\u9078\u629e](https://qiita-image-store.s3.amazonaws.com/0/52054/1afc227f-d8cb-0048-b3ef-d70fa0d6def3.png)\n\n\u3053\u306e\u8fba\u308a\u3082\u9069\u5f53\u306b\u3002\u30cd\u30fc\u30e0\u30b9\u30da\u30fc\u30b9\u306f`test`\u3068\u304b\u9069\u5f53\u306a\u3084\u3064\u3060\u3068\u304b\u3076\u3063\u3066\u4f7f\u3048\u306a\u3044\u306e\u3067\u3054\u6ce8\u610f\u3092\u3002\n\n![\u30a2\u30d7\u30ea\u306e\u8a2d\u5b9a](https://qiita-image-store.s3.amazonaws.com/0/52054/593fc899-6787-e043-d410-e6119d5f28e7.png)\n\n[Product Setup]\u306e\u753b\u9762\u306b\u9077\u79fb\u3059\u308b\u306e\u3067\u3001[Messenger]\u3092\u9078\u629e => [\u30b9\u30bf\u30fc\u30c8]\u3002\n\n\u30c8\u30fc\u30af\u30f3\u751f\u6210\u3067\u3001\u5148\u307b\u3069\u4f5c\u6210\u3057\u305fFacebook\u30da\u30fc\u30b8\u3092\u9078\u629e\u3002\u53f3\u306b\u8868\u793a\u3055\u308c\u308b\u30a2\u30af\u30bb\u30b9\u30c8\u30fc\u30af\u30f3\u3092\u30e1\u30e2\u3057\u3066\u304a\u304d\u307e\u3057\u3087\u3046\u3002\n\n![\u30a2\u30af\u30bb\u30b9\u30c8\u30fc\u30af\u30f3\u306e\u751f\u6210](https://qiita-image-store.s3.amazonaws.com/0/52054/93a7d936-48c7-2703-b05b-6c1d1c3641cf.png)\n\n\u5ff5\u306e\u305f\u3081\u3001\u5bfe\u8c61\u306e\u30da\u30fc\u30b8\u304c\u30d5\u30a9\u30ed\u30fc\u3055\u308c\u3066\u3044\u308b\u304b(bot\u306e\u30bf\u30fc\u30b2\u30c3\u30c8\u306b\u306a\u3063\u3066\u3044\u308b\u304b)\u3092\u78ba\u8a8d\u3057\u307e\u3057\u3087\u3046\u3002\n\n![\u30d5\u30a9\u30ed\u30fc\u3059\u308b\u30da\u30fc\u30b8\u306e\u9078\u629e](https://qiita-image-store.s3.amazonaws.com/0/52054/114613c5-dff5-1f92-6a86-94cb62c9e482.png)\n\n\n\u4e00\u65e6\u3053\u3053\u307e\u3067\u3067\u4f5c\u696d\u306f\u5b8c\u4e86\u3067\u3059\u3002\u3053\u306e\u30da\u30fc\u30b8\u306f\u9589\u3058\u305a\u306b\u7f6e\u3044\u3068\u304f\u3068\u697d\u3067\u3059\u3002\n\n## 2.Serverless\u306e\u69cb\u7bc9\n\u6b21\u306f\u5b9f\u884c\u3055\u308c\u308bAPI\u306e\u90e8\u5206\u3092\u3001AWS\u4e0a\u306b\u69cb\u7bc9\u3057\u3066\u3044\u304d\u307e\u3057\u3087\u3046\u3002\n\n### \u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u306e\u4f5c\u6210\n\u4f55\u306f\u3068\u3082\u3042\u308cServerless\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u307e\u3059\u3002\u3053\u306e\u8a18\u4e8b\u3092\u66f8\u3044\u3066\u3044\u308b\u6642\u70b9\u3067\u306f\u3001`v0.5.5`\u3092\u4f7f\u7528\u3057\u3066\u3044\u307e\u3059\u3002Serverless\u306f\u7d50\u69cb\u5909\u5316\u304c\u65e9\u3044\u306e\u3067\u3001\u30d0\u30fc\u30b8\u30e7\u30f3\u3092\u5408\u308f\u305b\u308b\u3053\u3068\u3092\u30aa\u30b9\u30b9\u30e1\u3057\u307e\u3059\u3002\u307e\u305f\u3001\u3082\u3057`v0.5.5`\u4ee5\u4e0a\u3092\u4f7f\u7528\u3055\u308c\u308b\u5834\u5408\u3001\u3053\u306e\u8a18\u4e8b\u306e\u901a\u308a\u306b\u52d5\u304f\u4fdd\u8a3c\u306f\u3042\u308a\u307e\u305b\u3093...\n\n```\n$ npm i serverless -g\n```\n\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u304c\u5b8c\u4e86\u3057\u305f\u3089\u3001\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002`serverless`\u30b3\u30de\u30f3\u30c9\u306f`sls`\u3068\u3082\u6253\u3066\u308b\u306e\u3067\u3001\u77ed\u3044\u65b9\u3067\u3002\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u4f5c\u6210\u5f8c\u3001\u305d\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306b\u79fb\u52d5\u3057\u3066Lambda Function\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n**\u6ce8\u610f**\nServerless\u3092\u6700\u521d\u306b\u4f7f\u3046\u5834\u5408\u3001IAM\u30e6\u30fc\u30b6\u306e\u767b\u9332\u3084\u30a2\u30af\u30bb\u30b9\u30ad\u30fc\u306e\u767b\u9332\u304c\u5fc5\u8981\u3060\u3063\u305f\u6c17\u304c\u3057\u307e\u3059\u3002\u7b46\u8005\u306e\u74b0\u5883\u306b\u306f\u65e2\u306bServerless\u304c\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u3055\u308c\u3066\u3044\u305f\u305f\u3081\u3001\u305d\u306e\u624b\u9806\u3092\u306a\u305e\u308b\u3053\u3068\u304c\u51fa\u6765\u305a...\n\u3053\u306e\u3042\u305f\u308a\u306e\u8a18\u4e8b\u3092\u53c2\u8003\u306b\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n[AWS Lambda\u3092\u6d3b\u7528\u3057\u305fServerless Framework\u3092\u89e6\u3063\u3066\u307f\u308b](http://qiita.com/susieyy/items/1c2af0ef7b88b742c37a)\n\n```\n$ sls project create\n$ cd [project_name]\n$ sls function create\n```\n\nruntime\u306b\u306fnode.js\u306e\u6700\u65b0\u7248\u3001API Gateway\u3092\u4f7f\u3046\u306e\u3067[Create Endpoint]\u3092\u9078\u629e\u3002\n\n![Lambda Function\u306e\u751f\u6210](https://qiita-image-store.s3.amazonaws.com/0/52054/3aa6671d-10b7-3fb2-e669-56ccc3be6a7f.png)\n\n### API\u306e\u4f5c\u6210\n\n\u65e9\u901fLambda Function(\u5b9f\u884c\u3055\u308c\u308bAPI)\u3092\u66f8\u3044\u3066\u3044\u304f\u306e\u3067\u3059\u304c\u3001\u305d\u306e\u524d\u306bFacebook Messenger Bot\u306e\u4ed5\u69d8\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\u516c\u5f0f\u306e\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u306b\u4e00\u5ea6\u76ee\u3092\u901a\u3057\u3066\u304a\u304f\u3068\u3044\u3044\u3067\u3057\u3087\u3046\u3002\n[Messenger Platform - Getting Started](https://developers.facebook.com/docs/messenger-platform/quickstart)\n\nMessenger Bot\u3092\u69cb\u7bc9\u3059\u308b\u306b\u306f\u3001\u4efb\u610f\u306e\u30b5\u30fc\u30d0\u30fc\u3067`GET`\u3068`POST`\u306e2\u3064\u306eAPI\u3092\u89e3\u653e\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002path\u306f\u306a\u3093\u3067\u3082\u826f\u3044\u306e\u3067\u3059\u304c\u3001\u3053\u3053\u3067\u306f\u4eee\u306b`/facebook` \u3068\u3057\u3066\u8a71\u3092\u9032\u3081\u307e\u3057\u3087\u3046\u3002\n\n* **GET /facebook**\uff1a\u6b63\u3057\u3044endpoint\u304b\u3092\u8a8d\u8a3c\u3059\u308b\u305f\u3081\u306eAPI\n* **POST /facebok**\uff1a\u5b9f\u969b\u306b\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u3046\u3051\u305f\u6642\u306b\u547c\u3070\u308c\u308bAPI\u3002\u3053\u3053\u3067bot\u306e\u51e6\u7406\u3092\u884c\u3046\n\n\u30a2\u30d7\u30ea\u3092\u767b\u9332\u3059\u308b\u3046\u3048\u3067\u3001\u307e\u305a\u306f`GET`\u306eAPI\u306f\u5148\u306b\u4f5c\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\u3068\u3044\u3046\u8a33\u3067\u3001GET API\u306e\u4f5c\u308a\u65b9\u3092\u898b\u3066\u3044\u304d\u307e\u3057\u3087\u3046\u3002\n\n### GET /facebook\n\n`GET`\u306f\u8a8d\u8a3c\u7528\u306b\u89e3\u653e\u3059\u308bAPI\u3067\u3059\u3002Facebook Messenger Bot\u306b\u8a2d\u5b9a\u3057\u305fURL\u304c\u6b63\u3057\u3044\u304b\u3001\u3053\u306eAPI\u3092\u7528\u3044\u3066\u30c1\u30a7\u30c3\u30af\u3057\u307e\u3059\u3002\u30ea\u30d5\u30a1\u30ec\u30f3\u30b9\u3092\u898b\u308b\u9650\u308a\u3001\u6b21\u306e2\u3064\u306e\u4ed5\u69d8\u3092\u6e80\u305f\u3059\u5fc5\u8981\u304c\u3042\u308b\u3088\u3046\u3067\u3059\u3002\n\n* QueryString\u3067\u6e21\u3055\u308c\u305f`hub.verify_token`\u304c\u3001\u4e8b\u524d\u306b\u751f\u6210\u3057\u305fToken\u3068\u5408\u3063\u3066\u3044\u308b\u304b\u30c1\u30a7\u30c3\u30af\u3059\u308b\n* \u6b63\u3057\u3044\u5834\u5408\u3001QueryString\u3067\u6e21\u3055\u3055\u308c\u305f`hub.challenge`\u3092\u305d\u306e\u307e\u307e\u30ec\u30b9\u30dd\u30f3\u30b9\u3068\u3057\u3066\u8fd4\u3059\u3001\u305d\u308c\u4ee5\u5916\u306e\u5834\u5408\u306f\u9069\u5f53\u306a\u6587\u5b57\u5217\u3092\u8fd4\u3059\n\n\u3053\u306e\u4ed5\u69d8\u3092\u6e80\u305f\u3059API\u3092Lambda\u4e0a\u306b\u69cb\u7bc9\u3057\u307e\u3057\u3087\u3046\u3002Serverless\u3067\u306f\u3001\u307e\u305aAPI\u306e\u5b9a\u7fa9(API Gateway\u5074\u306e\u8a2d\u5b9a)\u3092`s-function.json`\u5185\u306e`endpoints`\u306b\u8a18\u8ff0\u3057\u307e\u3059\u3002\u5168\u4f53\u50cf\u306f\u6700\u5f8c\u306b\u8cbc\u308a\u307e\u3059\u3002\n\n\u307e\u305a\u3001\u300c\u3069\u306e\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u53d7\u3051\u53d6\u308b\u304b\u300d\u3092`requestParameters`\u5185\u306b\u8a18\u8ff0\u3057\u307e\u3059\u3002\u4eca\u56de\u306fQueryString\u306e`hub.verify_token`\u3068`hub.challenge`\u304c\u5fc5\u8981\u306a\u306e\u3067\u3001\u3053\u306e2\u3064\u3092\u6307\u5b9a\u3057\u307e\u3059\u3002\n\n```` facebook-bot/s-function.json\n  \"requestParameters\": {\n    \"integration.request.querystring.hub.verify_token\": \"method.request.querystring.hub.verify_token\",\n    \"integration.request.querystring.hub.challenge\": \"method.request.querystring.hub.challenge\"\n  }\n```\n\n\u6b21\u306b\u3001\u305d\u308c\u3089\u306e\u5024\u304cLambda\u4e0a\u3067\u3069\u306e\u3088\u3046\u306a\u540d\u524d\u3067\u53d6\u308c\u308b\u306e\u304b\u3001`requestTemplates`\u306b\u30de\u30c3\u30d4\u30f3\u30b0\u3092\u6307\u5b9a\u3057\u307e\u3059\u3002\u3053\u3053\u3067\u306f\u5148\u7a0b\u306e2\u3064\u306b\u52a0\u3048\u3001`method`\u3092\u5b9a\u7fa9\u3057\u3066\u3044\u307e\u3059\u3002\u4eca\u56de\u306f`GET`\u3068`POST`\u306e\u30ea\u30af\u30a8\u30b9\u30c8\u3092\uff11\u3064\u306eLambda Function\u3067\u53d6\u308a\u6271\u3046\u305f\u3081\u3001\u305d\u306e\u5224\u5b9a\u306e\u305f\u3081\u306bHTTP Method\u3092\u6e21\u3057\u3066\u3044\u307e\u3059\u3002\n\n\u3053\u3053\u306e\u8a18\u8ff0\u306fVTL\u3068\u3044\u3046\u8a00\u8a9e\u3067\u66f8\u304b\u308c\u3066\u3044\u308b\u3089\u3057\u304f\u3001\u8a73\u3057\u304f\u77e5\u308a\u305f\u3044\u65b9\u306f\u30b0\u30b0\u30c3\u3066\u304f\u3060\u3055\u3044\u3002\n\u3082\u3057\u304f\u306f\u516c\u5f0f\u30ea\u30d5\u30a1\u30ec\u30f3\u30b9\u3092\n[API Gateway \u306e\u30de\u30c3\u30d4\u30f3\u30b0\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u30ea\u30d5\u30a1\u30ec\u30f3\u30b9](http://docs.aws.amazon.com/ja_jp/apigateway/latest/developerguide/api-gateway-mapping-template-reference.html)\n\n```` facebook-bot/s-function.json\n  \"requestTemplates\": {\n    \"application/json\": {\n      \"verify_token\": \"$input.params('hub.verify_token')\",\n      \"challenge\": \"$input.params('hub.challenge')\",\n      \"method\": \"$context.httpMethod\"\n    }\n  }\n```\n\n\u6b21\u306b\u3001\u30ec\u30b9\u30dd\u30f3\u30b9\u306e\u30de\u30c3\u30d4\u30f3\u30b0\u3092\u3057\u307e\u3059\u3002Facebook Messenger Bot\u306f\u30d7\u30ec\u30fc\u30f3\u30c6\u30ad\u30b9\u30c8\u3092\u8fd4\u3059\u4ed5\u69d8\u306a\u306e\u3067\u3001`responseTmplates`\u5185\u306e\u8a18\u8ff0\u3092\u6b21\u306e\u7528\u306b\u66f8\u304d\u304b\u3048\u307e\u3059\u3002\n\n```` facebook-bot/s-function.json\n  \"responses\": {\n    // \u301c\u4e2d\u7565\n    \"statusCode\": \"200\",\n    \"responseParameters\": {},\n    \"responseModels\": {\n      \"application/json;charset=UTF-8\": \"Empty\"\n    },\n    \"responseTemplates\": {\n      \"text/plain\": \"$input.path('$')\"\n    }\n  }\n```\n\n\u6700\u5f8c\u306b\u3001`GET`\u30e1\u30bd\u30c3\u30c9\u306e\u30ed\u30b8\u30c3\u30af\u3092\u5b9f\u88c5\u3057\u307e\u3059\u3002Lambda\u306b\u767b\u9332\u3057\u305f\u30cf\u30f3\u30c9\u30e9\u306e\u5b9f\u88c5\u306f\u3001`handler.js`\u5185\u306b\u3042\u308a\u307e\u3059\u3002\u3053\u3053\u3067export\u3057\u305f`handerl`\u304c\u3001API\u30b3\u30fc\u30eb\u306a\u3069\u306e\u30a4\u30d9\u30f3\u30c8\u767a\u706b\u6642\u306b\u547c\u3070\u308c\u308b\u3088\u3046\u306a\u4ed5\u7d44\u307f\u3067\u3059\u3002\u30ea\u30af\u30a8\u30b9\u30c8\u30d1\u30e9\u30e1\u30fc\u30bf\u306f\u5168\u3066\u4eee\u5f15\u6570`event`\u5185\u306b\u683c\u7d0d\u3055\u308c\u3001\u7b2c\uff13\u5f15\u6570\u306e`cb`\u3092\u5b9f\u884c\u3059\u308b\u3053\u3068\u3067function\u306e\u5b9f\u884c\u7d50\u679c\u304c\u8fd4\u308b\u4ed5\u7d44\u307f\u3067\u3059\u3002\n\n\u30b3\u30fc\u30c9\u306f\u3001\u30e1\u30bd\u30c3\u30c9\u304c`GET`\u306e\u5834\u5408\u3001`verify_token`\u3092\u8a55\u4fa1\u3057\u3066\u6b63\u3057\u3051\u308c\u3070`challenge`\u3092\u8fd4\u3059\u3001\u3068\u3044\u3046\u30b7\u30f3\u30d7\u30eb\u306a\u69cb\u9020\u3067\u3059\u3002\n\n``` handler.js\n'use strict';\n\nconst FB_MESSANGER_TOKEN = 'xxxxxxxxxxxx';\n\nmodule.exports.handler = function(event, context, cb) {\n  switch (event.method.toUpperCase()) {\n    case 'GET': {\n      const validRequest = event.verify_token === FB_MESSANGER_TOKEN;\n      return cb(null, validRequest ? event.challenge : 'Error, wrong validation token');\n    }\n    \n    default: return cb('Error, Invalid Method');\n  }\n};\n```\n\n\u3053\u308c\u3067GET API\u306e\u4f5c\u6210\u306f\u5b8c\u4e86\u3067\u3059\u3002\u30c7\u30d7\u30ed\u30a4\u3057\u307e\u3057\u3087\u3046\u3002\nServerless\u306b\u306f\u3001`dash deploy`\u3068\u3044\u3046CUI\u3067\u7c21\u5358\u306b\u30c7\u30d7\u30ed\u30a4\u5bfe\u8c61\u304c\u9078\u629e\u3067\u304d\u308b\u30b3\u30de\u30f3\u30c9\u304c\u7528\u610f\u3055\u308c\u3044\u3066\u308b\u306e\u3067\u3001\u3053\u308c\u3092\u4f7f\u3044\u307e\u3059\u3002\n\n```\n$ sls dash deploy\n```\n\n![Serverless\u306e\u30c7\u30d7\u30ed\u30a4](https://qiita-image-store.s3.amazonaws.com/0/52054/35dbc0e1-d0d3-79e4-7bcb-37657813e324.png)\n\n\u30c7\u30d7\u30ed\u30a4\u304c\u5b8c\u4e86\u3057\u307e\u3057\u305f!\n\n\u3053\u3053\u307e\u3067\u6765\u305f\u3089\u3001\u5148\u307b\u3069\u306eFacebook Developer\u306b\u623b\u308a\u3001API\u306e\u30c6\u30b9\u30c8\u3092\u3057\u307e\u3057\u3087\u3046\u3002\n\n[Setup Webhooks]\u3092\u9078\u629e\u3002\n\n![Webhooks\u3092\u9078\u629e](https://qiita-image-store.s3.amazonaws.com/0/52054/da99f44c-ae63-2b6a-1958-df9fe66407a5.png)\n\nLambda\u306eURL\u3068\u3001\u5148\u307b\u3069\u751f\u6210\u3055\u308c\u305ftoken\u3092\u5165\u529b\u3001[messages]\u306b\u30c1\u30a7\u30c3\u30af\u3092\u5165\u308c\u3066\u78ba\u8a8d\u3057\u307e\u3059\u3002\u6307\u5b9a\u3055\u308c\u305fURL\u304b\u3089\u6b63\u3057\u304fChallenge\u304c\u8fd4\u3063\u3066\u304d\u305f\u3089\u6210\u529f\u3067\u3059\u3002\n\n![\u30b3\u30fc\u30eb\u30d0\u30c3\u30afURL\u3001\u30c8\u30fc\u30af\u30f3\u3092\u5165\u529b](https://qiita-image-store.s3.amazonaws.com/0/52054/58a339bd-4f41-cedf-ec8b-8ed1756459d1.png)\n\n**\u30a8\u30e9\u30fc\u304c\u51fa\u308b\u5834\u5408**\n\u6b21\u306e\u9805\u76ee\u3092\u78ba\u8a8d\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n#### URL\u304c\u6b63\u3057\u3044\u304b\nAPI Gateway\u306e\u30b3\u30f3\u30bd\u30fc\u30eb\u304b\u3089\u6b63\u3057\u3044URL\u3092\u78ba\u8a8d\u3057\u3066\u304f\u3060\u3055\u3044\u3002\u3053\u3053\u306b\u8868\u793a\u3055\u308c\u3066\u3044\u308bEndpoint + Serverless\u3067\u6307\u5b9a\u3057\u305fpath\u3067\u3059\u3002\n![API Gateway\u306eURL](https://qiita-image-store.s3.amazonaws.com/0/52054/3da35bfb-23ab-9961-5dc1-ecff4ee899f8.png)\n\n#### Lambda\u306e\u30ed\u30b0\u3092\u78ba\u8a8d\n\u8a72\u5f53\u3059\u308bLambda Function\u306e[View logs in CloudWatch]\u304b\u3089\u3001\u30ed\u30b0\u3092\u78ba\u8a8d\u3067\u304d\u307e\u3059\u3002\n\n![Lambda Function\u306e\u30ed\u30b0](https://qiita-image-store.s3.amazonaws.com/0/52054/a1bcdfa2-def3-f31a-6a4f-0a0e805c3207.png)\n\n\u6700\u65b0\u306e\u30ed\u30b0\u3092\u78ba\u8a8d\u3057\u3066\u30c7\u30d0\u30c3\u30b0\u3057\u307e\u3057\u3087\u3046\n\n![CloudWatch\u3067\u30ed\u30b0\u306e\u78ba\u8a8d](https://qiita-image-store.s3.amazonaws.com/0/52054/2f0515a5-2f82-2752-a9db-7427d8b19dcb.png)\n\n### POST /facebook\n\u3053\u3053\u307e\u3067\u304d\u305f\u3089\u3001\u3042\u3068\u306f\u5b9f\u969b\u306bbot\u3068\u3057\u3066\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u8fd4\u3059API\u3092\u4f5c\u308a\u307e\u3059\u3002\u4eca\u56de\u306f\u3001\u7c21\u7565\u5316\u306e\u305f\u3081\u306b\u300c\u6765\u305f\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u305d\u306e\u307e\u307e\u8fd4\u3059bot\u300d\u306b\u3057\u307e\u3057\u3087\u3046\u3002\n\nPOST API\u306e\u4ed5\u69d8\u306f\u3001\u6b21\u306e\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002\n* \u53d7\u3051\u305f\u30ea\u30af\u30a8\u30b9\u30c8\u306b\u5bfe\u3057\u3066\u306f\u3001**\u3068\u308a\u3042\u3048\u305a200 OK\u3092\u8fd4\u3059**\n* \u30d1\u30e9\u30e1\u30fc\u30bf\u3067\u6e21\u3055\u308c\u305f**sender_id(\u30e6\u30fc\u30b6\u30fc)**\u306b\u5bfe\u3057\u3066\u3001POST\u30ea\u30af\u30a8\u30b9\u30c8\u3092\u6295\u3052\u3066\u5fdc\u7b54\u3059\u308b\n\n\u30ec\u30b9\u30dd\u30f3\u30b9\u3067\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u8fd4\u3059\u308f\u3051\u3058\u3083\u306a\u3044\u3093\u3067\u3059\u306d\u3002\u306a\u308b\u307b\u3069\u3002\n\n\u65e9\u901f\u3053\u306e\u4ed5\u69d8\u306b\u5bfe\u5fdc\u3057\u305fAPI\u306e\u5b9a\u7fa9\u3092\u8ffd\u52a0\u3057\u307e\u3059\u3002`s-function.json`\u306b\u306fendpoint\u3092\u8907\u6570\u6307\u5b9a\u3067\u304d\u308b\u306e\u3067\u3001\u5148\u307b\u3069\u306e\u30d5\u30a1\u30a4\u30eb\u306b\u8ffd\u8a18\u3057\u3066\u3044\u304d\u307e\u3059\u3002POST\u30ea\u30af\u30a8\u30b9\u30c8\u306ejson\u3067\u6e21\u3055\u308c\u305f\u30d1\u30e9\u30e1\u30fc\u30bf\u304b\u3089\u3001`entry`\u306e\u307fLambda\u306b\u6e21\u3057\u3066\u3042\u3052\u308b\u8a2d\u5b9a\u306b\u3057\u3066\u3044\u307e\u3059\u3002\n\n```faceboo/s-function.json\n    {\n      \"path\": \"facebook\",\n      \"method\": \"POST\",\n      \"type\": \"AWS\",\n      \"authorizationType\": \"none\",\n      \"authorizerFunction\": false,\n      \"apiKeyRequired\": false,\n      \"requestParameters\": {},\n      \"requestTemplates\": {\n        \"application/json\": {\n          \"entry\": \"$input.json('entry')\",\n          \"method\": \"$context.httpMethod\"\n        }\n      },\n      \"responses\": {\n        \"400\": {\n          \"statusCode\": \"400\"\n        },\n        \"default\": {\n          \"statusCode\": \"200\",\n          \"responseParameters\": {},\n          \"responseModels\": {\n            \"application/json;charset=UTF-8\": \"Empty\"\n          },\n          \"responseTemplates\": {\n            \"text/plain\": \"$input.path('$')\"\n          }\n        }\n      }\n    }\n```\n\nhandler\u306b\u30b3\u30fc\u30c9\u3092\u8ffd\u8a18\u3057\u307e\u3059\u3002\u30ea\u30af\u30a8\u30b9\u30c8\u3092\u6295\u3052\u308b\u305f\u3081\u306e\u30e2\u30b8\u30e5\u30fc\u30eb\u3092\u8ffd\u52a0\u3057\u3001\n\n```\n$ npm i request -S\n```\n\n\u30b3\u30fc\u30c9\u306f\u3053\u3046\u3044\u3046\u611f\u3058\u3067\u3059\u3002\u30d1\u30e9\u30e1\u30fc\u30bf\u4e2d\u306e`sender.id`\u306b\u5bfe\u3057\u3066\u30ea\u30af\u30a8\u30b9\u30c8\u3092\u6295\u3052\u308b\u3060\u3051\u3002\n\n```facebook/handler.js\nconst request = require('request');\n\nconst FB_MESSANGER_TOKEN = 'xxxxx';\n\nmodule.exports.handler = function(event, context, cb) {\n  switch (event.method.toUpperCase()) {\n    case 'GET': // \u7565\n\n    case 'POST': {\n      event.entry[0].messaging.filter(m => m.message && m.message.text).forEach(m => sendTextMessage(m.sender.id, m.message.text));\n      return cb(null, 'OK');\n    }\n    // \u7565\n  }\n};\n\nfunction sendTextMessage(sender, text) {\n  request({\n    url: 'https://graph.facebook.com/v2.6/me/messages',\n    qs: { access_token: FB_MESSANGER_TOKEN },\n    method: 'POST',\n    json: {\n      recipient: { id: sender },\n      message: { text: text },\n    }\n  }, function(error, response, body) {\n    if (error) {\n      console.log('Error sending message: ', error);\n    } else if (response.body.error) {\n      console.log('Error: ', response.body.error);\n    }\n  });\n}\n```\n\n\u3053\u3053\u3067\u30b3\u30fc\u30c7\u30a3\u30f3\u30b0\u81ea\u4f53\u306f\u7d42\u308f\u308a\u306a\u306e\u3067\u3059\u304c\u3001Serverless\u306f\u30c7\u30d5\u30a9\u30eb\u30c8\u3067\u306f**require\u3067\u4f9d\u5b58\u3057\u305f\u30e2\u30b8\u30e5\u30fc\u30eb\u3092\u30c7\u30d7\u30ed\u30a4\u3057\u3066\u304f\u308c\u307e\u305b\u3093**\u3002\u6614\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u3060\u3068\u307e\u3068\u3081\u3066zip\u306b\u3057\u3066\u30c7\u30d7\u30ed\u30a4\u3057\u3066\u304f\u308c\u305f\u306e\u3067\u3059\u304c(\u3053\u3053\u3067\u7dba\u9e97\u306b\u30cf\u30de\u3063\u305f)\u3001Lambda\u306b\u30c7\u30d7\u30ed\u30a4\u3059\u308b\u30e2\u30fc\u30b8\u30e5\u30fc\u30eb\u304c10MB\u307e\u3067\u3068\u3044\u3046\u5236\u9650\u306b\u5bfe\u51e6\u3059\u308b\u305f\u3081\u3001`v0.5.5`\u3067\u306fbroserify\u3084webpack\u3067\u6700\u9069\u5316\u3055\u308c\u305f\uff11\u3064\u306ehandler.js\u3092\u30c7\u30d7\u30ed\u30a4\u3059\u308b\u3088\u3046\u306b\u5909\u66f4\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n\n\u305d\u308c\u3089\u306f`plugin`\u3068\u3044\u3046\u5f62\u3067\u63d0\u4f9b\u3055\u308c\u3066\u3044\u3066\u3001\u5c0e\u5165\u81ea\u4f53\u306f\u697d\u306a\u306e\u3067\u3059\u304c\u3001\u77e5\u3089\u306a\u3044\u3068\u3064\u3089\u3044\u3067\u3059...\n\u3068\u3044\u3046\u308f\u3051\u3067\u95a2\u9023\u30e2\u30b8\u30e5\u30fc\u30eb\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3002browserify\u3068\u304bbabel\u3068\u304b\u3088\u304f\u5206\u304b\u3089\u306a\u3044\u4eba\u306f\u3001\u3068\u308a\u3042\u3048\u305a\u30b3\u30d4\u30da\u3057\u307e\u3057\u3087\u3046(\u3067\u3082\u77e5\u3063\u3066\u304a\u3044\u305f\u65b9\u304c\u3044\u3044\u3067\u3059\u3088)\u3002\n\n```\n$ npm i serverless-optimizer-plugin babelify babel-preset-es2015 -S\n```\n\n\u30eb\u30fc\u30c8\u306e`s-project.json`\u306b\u4f7f\u7528\u3059\u308b\u30d7\u30e9\u30b0\u30a4\u30f3\u3092\u8a18\u8ff0\u3057\u307e\u3059\u3002\n\n```s-project.json\n  \"plugins\": [\n    \"serverless-optimizer-plugin\"\n  ]\n```\n\n\u305d\u3057\u3066\u30d7\u30e9\u30b0\u30a4\u30f3\u306e\u8a2d\u5b9a\u306f`s-function.json`\u306b\u3002browserify\u3059\u308b\u3068\u304d\u306e\u8a2d\u5b9a\u3092\u8a18\u8ff0\u3059\u308b\u306e\u3067\u3059\u304c\u3001ES2015\u306e\u8a18\u6cd5\u3092\u4f7f\u3063\u3066\u3044\u308b\u5834\u5408(Arrow Function\u3068\u304b)\u306f**babelify\u3092\u901a\u3055\u306a\u3044\u3068\u6b7b\u306b\u307e\u3059**\u3002\u305b\u3063\u304b\u304fLambda\u304cnode v4\u306b\u5bfe\u5fdc\u3057\u305f\u306e\u306b\u30d0\u30d9\u3089\u306a\u3044\u3068\u3044\u3051\u306a\u3044\u306a\u3093\u3066...\n\n```facebook/s-function.json\n  \"custom\": {\n    \"excludePatterns\": [],\n    \"optimize\": {\n      \"exclude\": [\"aws-sdk\"],\n      \"transforms\": [\n        {\n          \"name\": \"babelify\",\n          \"opts\": {\n            \"presets\": [\"es2015\"]\n          }\n        }\n      ]\n    }\n```\n\n\u3053\u308c\u3067\u5b8c\u4e86\u3067\u3059\u3002\u307e\u305f`sls dash deploy`\u30b3\u30de\u30f3\u30c9\u3067\u30c7\u30d7\u30ed\u30a4\u3057\u307e\u3057\u3087\u3046\u3002\n\n**\u52d5\u304b\u306a\u3044\u6642**\n\n### \u30d0\u30f3\u30c9\u30eb\u3055\u308c\u305f\u30b3\u30fc\u30c9\u3092\u78ba\u8a8d\u3059\u308b\n\u304d\u3061\u3093\u3068browserify\u304c\u52d5\u3044\u3066\u3044\u308b\u304b\u78ba\u8a8d\u3057\u307e\u3059\u3002Lambda\u306e\u30b3\u30f3\u30bd\u30fc\u30eb\u304b\u3089\u30c7\u30d7\u30ed\u30a4\u3055\u308c\u305f\u30b3\u30fc\u30c9\u304c\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3067\u304d\u308b\u306e\u3067\u3001\u3061\u3083\u3093\u3068browseify\u3055\u308c\u3066\u3044\u308b\u304b\u78ba\u8a8d\u3057\u307e\u3059\u3002\u3054\u3061\u3083\u3054\u3061\u3083\u5727\u7e2e\u3055\u308c\u305f\u30d5\u30a1\u30a4\u30eb\u304c\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3067\u304d\u305f\u3089\u305f\u3076\u3093OK\u3067\u3059\u3002\n\n![\u30b3\u30fc\u30c8\u3099\u306e\u30bf\u3099\u30a6\u30f3\u30ed\u30fc\u30c8\u3099.png](https://qiita-image-store.s3.amazonaws.com/0/52054/af558b7d-62cf-91c7-9542-1deb2c454edb.png)\n\n\n## \u52d5\u4f5c\u78ba\u8a8d\n\n\u4f5c\u6210\u3057\u305fFacebook\u30da\u30fc\u30b8\u304b\u3089\u3001\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u9001\u308a\u307e\u3059\u3002\n\n![facebook\u30d8\u309a\u30fc\u30b7\u3099\u304b\u3089\u30e1\u30c3\u30bb\u30fc\u30b7\u3099\u3092\u9001\u308b](https://qiita-image-store.s3.amazonaws.com/0/52054/5882f373-60d5-5534-acbd-a101d7921141.png)\n\n\u3061\u3083\u3093\u3068\u30ec\u30b9\u30dd\u30f3\u30b9\u304c\u8fd4\u3063\u3066\u304d\u307e\u3057\u305f\uff01\uff01\uff01\uff01\uff01\n\n![bot\u306e\u52d5\u4f5c\u78ba\u8a8d.png](https://qiita-image-store.s3.amazonaws.com/0/52054/87fd5e92-6be8-52e8-ae67-cf2ba5ee2d12.png)\n\n## \u30b3\u30fc\u30c9\n\u4eca\u56de\u4f7f\u7528\u3057\u305f\u30b3\u30fc\u30c9\u306e\u5168\u4f53\u50cf\u3067\u3059\u3002\u30b3\u30d4\u30da\u3057\u305f\u3089\u305f\u3076\u3093\u52d5\u304d\u307e\u3059\u3002\n\n### \u5b9f\u884c\u3057\u305f\u30b3\u30de\u30f3\u30c9\n\n```\n$ sls project create\n$ cd facebook-bot\n$ sls function create\n\n$ npm i request serverless-optimizer-plugin babelify babel-preset-es2015 -S\n$ npm install  -S\n\n$ sls dash deploy\n```\n\n### s-project.json\n```s-porject.json\n{\n  \"name\": \"facebook-bot\",\n  \"custom\": {},\n  \"plugins\": [\n    \"serverless-optimizer-plugin\"\n  ]\n}\n```\n\n### s-function.json\n\n```s-function.json\n{\n  \"name\": \"facebook-bot\",\n  \"runtime\": \"nodejs4.3\",\n  \"description\": \"Serverless Lambda function for project: facebook-bot\",\n  \"customName\": false,\n  \"customRole\": false,\n  \"handler\": \"handler.handler\",\n  \"timeout\": 6,\n  \"memorySize\": 1024,\n  \"authorizer\": {},\n  \"custom\": {\n    \"excludePatterns\": [],\n    \"optimize\": {\n      \"exclude\": [\"aws-sdk\"],\n      \"transforms\": [\n        {\n          \"name\": \"babelify\",\n          \"opts\": {\n            \"presets\": [\"es2015\"]\n          }\n        }\n      ]\n    }\n  },\n  \"endpoints\": [\n    {\n      \"path\": \"facebook\",\n      \"method\": \"GET\",\n      \"type\": \"AWS\",\n      \"authorizationType\": \"none\",\n      \"authorizerFunction\": false,\n      \"apiKeyRequired\": false,\n      \"requestParameters\": {\n        \"integration.request.querystring.hub.verify_token\": \"method.request.querystring.hub.verify_token\",\n        \"integration.request.querystring.hub.challenge\": \"method.request.querystring.hub.challenge\"\n      },\n      \"requestTemplates\": {\n        \"application/json\": {\n          \"verify_token\": \"$input.params('hub.verify_token')\",\n          \"challenge\": \"$input.params('hub.challenge')\",\n          \"method\": \"$context.httpMethod\"\n        }\n      },\n      \"responses\": {\n        \"400\": {\n          \"statusCode\": \"400\"\n        },\n        \"default\": {\n          \"statusCode\": \"200\",\n          \"responseParameters\": {},\n          \"responseModels\": {\n            \"application/json;charset=UTF-8\": \"Empty\"\n          },\n          \"responseTemplates\": {\n            \"text/plain\": \"$input.path('$')\"\n          }\n        }\n      }\n    },\n    {\n      \"path\": \"facebook\",\n      \"method\": \"POST\",\n      \"type\": \"AWS\",\n      \"authorizationType\": \"none\",\n      \"authorizerFunction\": false,\n      \"apiKeyRequired\": false,\n      \"requestParameters\": {},\n      \"requestTemplates\": {\n        \"application/json\": {\n          \"entry\": \"$input.json('entry')\",\n          \"method\": \"$context.httpMethod\"\n        }\n      },\n      \"responses\": {\n        \"400\": {\n          \"statusCode\": \"400\"\n        },\n        \"default\": {\n          \"statusCode\": \"200\",\n          \"responseParameters\": {},\n          \"responseModels\": {\n            \"application/json;charset=UTF-8\": \"Empty\"\n          },\n          \"responseTemplates\": {\n            \"text/plain\": \"$input.path('$')\"\n          }\n        }\n      }\n    }\n  ],\n  \"events\": [],\n  \"environment\": {\n    \"SERVERLESS_PROJECT\": \"${project}\",\n    \"SERVERLESS_STAGE\": \"${stage}\",\n    \"SERVERLESS_REGION\": \"${region}\"\n  },\n  \"vpc\": {\n    \"securityGroupIds\": [],\n    \"subnetIds\": []\n  }\n}\n```\n\n### handler.js\n\n```handler.js\n'use strict';\n\nconst request = require('request');\n\nconst FB_MESSANGER_TOKEN = '\u3053\u3053\u306btoken\u3092\u66f8\u304f';\n\nmodule.exports.handler = function(event, context, cb) {\n  \n  switch (event.method.toUpperCase()) {\n    case 'GET': {\n      const validRequest = event.verify_token === FB_MESSANGER_TOKEN;\n      return cb(null, validRequest ? event.challenge : 'Error, wrong validation token');\n    }\n    \n    case 'POST': {\n      event.entry[0].messaging.filter(m => m.message && m.message.text).forEach(m => sendTextMessage(m.sender.id, m.message.text));\n      return cb(null, 'OK');\n    }\n    \n    default: return cb('Error, Invalid Method');\n  }\n};\n\nfunction sendTextMessage(sender, text) {\n  const messageData = {\n    text:text\n  }\n\n  request({\n    url: 'https://graph.facebook.com/v2.6/me/messages',\n    qs: {\n      access_token: FB_MESSANGER_TOKEN\n    },\n    method: 'POST',\n    json: {\n      recipient: {\n        id: sender\n      },\n      message: messageData,\n    }\n  }, function(error, response, body) {\n\n    if (error) {\n      console.log('Error sending message: ', error);\n    } else if (response.body.error) {\n      console.log('Error: ', response.body.error);\n    }\n  });\n}\n```\n\n\n## \u53c2\u8003\n* [Messenger Platform - Getting Started](https://developers.facebook.com/docs/messenger-platform/quickstart)\n* [\u30b8\u30e3\u30b9\u30c830\u5206\uff01FB\u30e1\u30c3\u30bb\u30f3\u30b8\u30e3\u30fcbot\u3092\u3068\u308a\u3042\u3048\u305a\u4f5c\u3063\u3066\u307f\u308b\u624b\u9806\u307e\u3068\u3081](https://bita.jp/dml/facebookbot_exp)\n* [Serverless](https://github.com/serverless/serverless)\n* [serverless-optimizer-plugin](https://github.com/serverless/serverless-optimizer-plugin)\n* [optimizer-plugin\u3092\u4f7f\u3063\u3066\u3001es6(es2015)\u3067serverless framework\u306e\u30b3\u30fc\u30c9\u3092\u66f8\u304f](http://qiita.com/mpppk/items/a8517404361120d2b2b3)\n* [AWS Lambda\u3092\u6d3b\u7528\u3057\u305fServerless Framework\u3092\u89e6\u3063\u3066\u307f\u308b](http://qiita.com/susieyy/items/1c2af0ef7b88b742c37a)\n", "tags": ["FacebookMessengerBot", "lambda", "serverless", "bot"]}