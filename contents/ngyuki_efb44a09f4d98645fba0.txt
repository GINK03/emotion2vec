{"context": "CentOS 7 \u306e\u30ea\u30dd\u30b8\u30c8\u30ea\u304b\u3089\u30b5\u30af\u30c3\u3068\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3067\u304d\u308b\u4e0b\u8a18\u3067\u8a66\u3057\u3066\u3044\u307e\u3059\u3002\n\ncorosync-2.3.4-7.el7_2.1\npacemaker-1.1.13-10.el7_2.2\nresource-agents-3.9.5-54.el7_2.9\n\n\nPacemaker/Corosync \u306e\u69cb\u6210\n\u78ba\u8a8d\u7528\u306b\u6b21\u306e\u3088\u3046\u306a\u69cb\u6210\u3067 Pacemaker/Corosync \u306e\u74b0\u5883\u3092\u69cb\u7bc9\u3057\u3066\u3044\u307e\u3059\u3002\n\ncorosync\n\npm01\n\n\n192.168.33.11/24 (enp0s8 / ring0)\n192.168.99.11/24 (enp0s9 / ring1)\n\n\npm02\n\n\n192.168.33.12/24 (enp0s8 / ring0)\n192.168.99.12/24 (enp0s9 / ring1)\n\n\n\n\npacemaker\nsudo pcs property set stonith-enabled=\"false\"\nsudo pcs property set no-quorum-policy=\"ignore\"\n\nsudo pcs resource defaults migration-threshold=\"1\"\n\nsudo pcs resource create dummy1 ocf:pacemaker:Dummy state=/tmp/pm-dummy1\nsudo pcs resource create dummy2 ocf:pacemaker:Dummy state=/tmp/pm-dummy2\n\nsudo pcs resource group add dummys dummy1 dummy2\n\n\n/etc/hosts\n127.0.0.1       localhost localhost.localdomain localhost4 localhost4.localdomain4\n192.168.33.11   pm01\n192.168.33.12   pm02\n192.168.99.11   pm01-back\n192.168.99.12   pm02-back\n\n\nsnmptrapd\nsnmptrap \u306e\u78ba\u8a8d\u306e\u305f\u3081\u306b \u30ed\u30fc\u30ab\u30eb\u306b snmptrapd \u3092\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u3057\u307e\u3059\u3002\n\u5fc5\u8981\u306a\u3082\u308d\u3082\u308d\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u307e\u3059\u3002\nsudo yum -y install net-snmp net-snmp-utils net-snmp-perl mailx\n\nsnmptrapd \u3067\u3059\u3079\u3066\u306e\u30c8\u30e9\u30c3\u30d7\u3092\u30e1\u30fc\u30eb\u3067 root \u306b\u8ee2\u9001\u3059\u308b\u3088\u3046\u306b\u8a2d\u5b9a\u3057\u307e\u3059\u3002\nsudo tee /etc/snmp/snmptrapd.conf <<'EOS'\ndisableAuthorization yes\ntraphandle default /usr/bin/traptoemail root\nEOS\n\nroot \u3078\u306e\u30e1\u30fc\u30eb\u306f\u81ea\u5206\u306e\u30e1\u30fc\u30eb\u30a2\u30c9\u30ec\u30b9\u306b\u8ee2\u9001\u3055\u305b\u307e\u3059\u3002\necho ore@example.com | sudo tee /root/.forward\n\npacemaker \u3084 corosync \u306e mib \u3092\u8aad\u307f\u8fbc\u3080\u305f\u3081\u306b /etc/snmp/snmp.conf \u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\nsudo tee /etc/snmp/snmp.conf <<'EOS'\nmibs ALL\nEOS\n\nsnmptrapd \u3092\u958b\u59cb\u3057\u307e\u3059\u3002\nsudo systemctl start snmptrapd\nsudo systemctl enable snmptrapd\n\n\u8a66\u3057\u306b\u9069\u5f53\u306a\u30c8\u30e9\u30c3\u30d7\u3092\u9001\u4fe1\u3057\u307e\u3059\u3002\u30c8\u30e9\u30c3\u30d7\u304c\u30e1\u30fc\u30eb\u3067\u9001\u4fe1\u3055\u308c\u308c\u3070\u6b63\u3057\u304f\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u3055\u308c\u3066\u3044\u307e\u3059\u3002\nsudo snmptrap -v 1 -c hoge localhost corosync localhost 6 1 ''\nsudo snmptrap -v 1 -c hoge localhost pacemaker localhost 6 1 ''\n\n\ncorosync-notifyd\ncorosync-notifyd \u306f corosync \u306e\u91cd\u8981\u306a\u30a4\u30d9\u30f3\u30c8\u3092 dbus \u3084 snmptrap \u3067\u901a\u77e5\u3059\u308b\u30b5\u30fc\u30d3\u30b9\u3067\u3059\u3002\u30ce\u30fc\u30c9\u306e\u6545\u969c\u3084\u5fa9\u5e30\u3092\u901a\u77e5\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u304c\u30fb\u30fb\u30fb\u30ea\u30bd\u30fc\u30b9\u969c\u5bb3\u306f corosync \u306e\u7ba1\u8f44\u3058\u3083\u306a\u3044\u306e\u3067\u901a\u77e5\u3067\u304d\u307e\u305b\u3093\u3002\n/etc/sysconfig/corosync-notifyd \u3067\u30b3\u30de\u30f3\u30c9\u30e9\u30a4\u30f3\u30aa\u30d7\u30b7\u30e7\u30f3\u3092\u6307\u5b9a\u3067\u304d\u308b\u306e\u3067 127.0.0.1 \u306b\u30c8\u30e9\u30c3\u30d7\u3092\u9001\u4fe1\u3059\u308b\u3088\u3046\u306b\u8a2d\u5b9a\u3057\u307e\u3059\u3002\nsudo tee /etc/sysconfig/corosync-notifyd <<'EOS'\nOPTIONS=\"-s -l -m 127.0.0.1\"\nEOS\n\ncorosync-notifyd \u3092\u958b\u59cb\u3057\u307e\u3059\u3002\nsudo systemctl start corosync-notifyd\n\n\u958b\u59cb\u3057\u305f\u6642\u70b9\u3067\u6b21\u306e\u3088\u3046\u306a\u30c8\u30e9\u30c3\u30d7\u304c\u9001\u4fe1\u3055\u308c\u307e\u3057\u305f\u3002\n                SNMPv2-MIB::snmpTrapOID.0  COROSYNC-MIB::corosyncNoticesQuorumStatus\n    COROSYNC-MIB::corosyncObjectsNodeName  \"pm01\"\n      COROSYNC-MIB::corosyncObjectsNodeID  1\nCOROSYNC-MIB::corosyncObjectsQuorumStatus  \"quorate\"\n\n\npacemaker \u3084 corosync \u3092\u505c\u6b62\u30fb\u958b\u59cb\u3057\u305f\u3068\u304d\u306e\u901a\u77e5\n\u7247\u65b9\u306e pacemaker \u3092\u505c\u6b62\u3057\u3066\u307f\u308b\u3002\nsudo systemctl stop pacemaker\n\n\u3053\u306e\u3068\u304d\u306f\u30c8\u30e9\u30c3\u30d7\u306f\u9001\u4fe1\u3055\u308c\u307e\u305b\u3093\u3002\ncorosync \u3092\u505c\u6b62\u3057\u3066\u307f\u308b\u3002\nsudo systemctl stop corosync\n\n\u6b21\u306e\u3088\u3046\u306a\u30c8\u30e9\u30c3\u30d7\u304c\u7247\u5272\u308c\uff08pm01 \u3067 corosync \u3092\u505c\u6b62\u3057\u305f\u306e\u3067 pm02 \u304b\u3089\uff09\u304b\u3089\u9001\u4fe1\u3055\u308c\u307e\u3057\u305f\u3002\n# from pm02\n               SNMPv2-MIB::snmpTrapOID.0  COROSYNC-MIB::corosyncNoticesNodeStatus\n   COROSYNC-MIB::corosyncObjectsNodeName  \"pm01-back\"\n     COROSYNC-MIB::corosyncObjectsNodeID  1\nCOROSYNC-MIB::corosyncObjectsNodeAddress  \"192.168.99.11\"\n COROSYNC-MIB::corosyncObjectsNodeStatus  \"left\"\n\npacemaker \u3092\u958b\u59cb\u3057\u3066\u307f\u308b\uff08corosync \u3082\u4e00\u7dd2\u306b\u958b\u59cb\u3055\u308c\u307e\u3059\uff09\u3002\nsudo systemctl start pacemaker\n\n\u6b21\u306e\u3088\u3046\u306a\u30c8\u30e9\u30c3\u30d7\u304c\u9001\u4fe1\u3055\u308c\u307e\u3057\u305f\u3002\n# from pm02\n               SNMPv2-MIB::snmpTrapOID.0  COROSYNC-MIB::corosyncNoticesNodeStatus\n   COROSYNC-MIB::corosyncObjectsNodeName  \"pm01-back\"\n     COROSYNC-MIB::corosyncObjectsNodeID  1\nCOROSYNC-MIB::corosyncObjectsNodeAddress  \"192.168.99.11\"\n COROSYNC-MIB::corosyncObjectsNodeStatus  \"joined\"\n\n\n\u30ea\u30bd\u30fc\u30b9\u969c\u5bb3\n\u30ea\u30bd\u30fc\u30b9\u969c\u5bb3\u3092\u767a\u751f\u3055\u305b\u3066\u307f\u308b\u3002\nsudo rm /tmp/pm-dummy1\n\n\u304c\u3001\u30ea\u30bd\u30fc\u30b9\u969c\u5bb3\u3067\u306f\u306a\u306b\u3082\u901a\u77e5\u3055\u308c\u307e\u305b\u3093\u3067\u3057\u305f\u3002\n\n\u901a\u4fe1\u969c\u5bb3\nNIC \u306e 1 \u3064\u3092 iptables \u3067\u585e\u3044\u3067\u307f\u307e\u3059\u3002\nsudo yum -y install iptables-services\nsudo systemctl start iptables\nsudo iptables -F\nsudo iptables -A INPUT -i enp0s9 -j DROP\n\n\u6b21\u306e\u3088\u3046\u306a\u30c8\u30e9\u30c3\u30d7\u304c\u9001\u4fe1\u3055\u308c\u307e\u3057\u305f\u3002\u4e21\u65b9\u306e\u30ce\u30fc\u30c9\u304b\u3089\u901a\u77e5\u304c\u6765\u308b\u3068\u601d\u3063\u3066\u3044\u305f\u306e\u3067\u3059\u304c\u3001\u3001\u3001\u7247\u65b9\u304b\u3089\u3057\u304b\u6765\u307e\u305b\u3093\u3067\u3057\u305f\uff08corosync-cfgtool \u3067\u898b\u305f\u611f\u3058\u3001\u4e21\u65b9\u306e\u30ce\u30fc\u30c9\u3067 faulty \u306b\u306a\u3063\u3066\u307e\u3059\uff09\u3002\n# from pm02\n             SNMPv2-MIB::snmpTrapOID.0  COROSYNC-MIB::corosyncNoticesRRPStatus\n COROSYNC-MIB::corosyncObjectsNodeName  \"pm02\"\n   COROSYNC-MIB::corosyncObjectsNodeID  2\n  COROSYNC-MIB::corosyncObjectsIfaceNo  1\nCOROSYNC-MIB::corosyncObjectsRRPStatus  \"faulty\"\n\n\n\u585e\u3044\u3067\u305f\u7a74\u3092\u958b\u304d\u307e\u3059\u3002\nsudo iptables -F\n\n\u6b21\u306e\u3088\u3046\u306a\u30c8\u30e9\u30c3\u30d7\u304c\u9001\u4fe1\u3055\u308c\u307e\u3057\u305f\u3002\u3053\u308c\u3082\u7247\u65b9\u306e\u30ce\u30fc\u30c9\u304b\u3089\u3057\u304b\u9001\u4fe1\u3055\u308c\u307e\u305b\u3093\u3067\u3057\u305f\u3002\n# from pm02\n             SNMPv2-MIB::snmpTrapOID.0  COROSYNC-MIB::corosyncNoticesRRPStatus\n COROSYNC-MIB::corosyncObjectsNodeName  \"pm02\"\n   COROSYNC-MIB::corosyncObjectsNodeID  2\n  COROSYNC-MIB::corosyncObjectsIfaceNo  1\nCOROSYNC-MIB::corosyncObjectsRRPStatus  \"operational\"\n\n\n\u30ce\u30fc\u30c9\u969c\u5bb3\n\u30b5\u30fc\u30d0\u3092\u5f37\u5236\u7d42\u4e86\u3057\u3066\u307f\u307e\u3059\u3002Vagrant \u74b0\u5883\u306a\u306e\u3067\u6b21\u306e\u3088\u3046\u306b\u5f37\u5236\u7d42\u4e86\u3057\u307e\u3059\u3002\nvagrant halt --force pm01\n\n\u6b21\u306e\u3088\u3046\u306a\u30c8\u30e9\u30c3\u30d7\u304c\u9001\u4fe1\u3055\u308c\u307e\u3057\u305f\u3002\n# from pm02\n               SNMPv2-MIB::snmpTrapOID.0  COROSYNC-MIB::corosyncNoticesNodeStatus\n   COROSYNC-MIB::corosyncObjectsNodeName  \"pm01-back\"\n     COROSYNC-MIB::corosyncObjectsNodeID  1\nCOROSYNC-MIB::corosyncObjectsNodeAddress  \"192.168.99.11\"\n COROSYNC-MIB::corosyncObjectsNodeStatus  \"left\"\n\n\u30b5\u30fc\u30d0\u3092\u8d77\u52d5\u3057\u307e\u3059\u3002\nvagrant up pm01\nvagrant ssh pm01\nsudo systemctl start corosync-notifyd \nsudo systemctl start pacemaker\n\n\u6b21\u306e\u3088\u3046\u306a\u30c8\u30e9\u30c3\u30d7\u304c\u9001\u4fe1\u3055\u308c\u307e\u3057\u305f\u3002\n# from pm02\n               SNMPv2-MIB::snmpTrapOID.0  COROSYNC-MIB::corosyncNoticesNodeStatus\n   COROSYNC-MIB::corosyncObjectsNodeName  \"pm01-back\"\n     COROSYNC-MIB::corosyncObjectsNodeID  1\nCOROSYNC-MIB::corosyncObjectsNodeAddress  \"192.168.99.11\"\n COROSYNC-MIB::corosyncObjectsNodeStatus  \"joined\"\n\n# from pm01\n                SNMPv2-MIB::snmpTrapOID.0  COROSYNC-MIB::corosyncNoticesQuorumStatus\n    COROSYNC-MIB::corosyncObjectsNodeName  \"pm01\"\n      COROSYNC-MIB::corosyncObjectsNodeID  1\nCOROSYNC-MIB::corosyncObjectsQuorumStatus  \"quorate\"\n\n\n# from pm01\n             SNMPv2-MIB::snmpTrapOID.0  COROSYNC-MIB::corosyncNoticesRRPStatus\n COROSYNC-MIB::corosyncObjectsNodeName  \"pm01\"\n   COROSYNC-MIB::corosyncObjectsNodeID  1\n  COROSYNC-MIB::corosyncObjectsIfaceNo  0\nCOROSYNC-MIB::corosyncObjectsRRPStatus  \"operational\"\n\n# from pm01\n             SNMPv2-MIB::snmpTrapOID.0  COROSYNC-MIB::corosyncNoticesRRPStatus\n COROSYNC-MIB::corosyncObjectsNodeName  \"pm01\"\n   COROSYNC-MIB::corosyncObjectsNodeID  1\n  COROSYNC-MIB::corosyncObjectsIfaceNo  1\nCOROSYNC-MIB::corosyncObjectsRRPStatus  \"operational\"\n\n\ncorosync-notifyd \u3092\u8d77\u52d5\u3059\u308b\u3068 corosync \u3082\u8d77\u52d5\u3059\u308b\n\u3061\u306a\u307f\u306b corosync-notifyd \u306e systemd \u306e\u30e6\u30cb\u30c3\u30c8\u30d5\u30a1\u30a4\u30eb\u306b Wants=corosync.service \u304c\u66f8\u304b\u308c\u3066\u3044\u308b\u306e\u3067\u3001corosync-notifyd \u3092\u958b\u59cb\u3059\u308b\u3068 corosync \u3082\u4e00\u7dd2\u306b\u958b\u59cb\u3057\u307e\u3059\u3002\ncat /usr/lib/systemd/system/corosync-notifyd.service\n# [Unit]\n# Description=Corosync Dbus and snmp notifier\n# Wants=corosync.service\n# After=corosync.service\n# :\n\n\u30b5\u30fc\u30d0\u306e\u30d6\u30fc\u30c8\u6642\u306b corosync \u3092\u8d77\u52d5\u3055\u305b\u305f\u304f\u306a\u3044\u306e\u3067\u3042\u308c\u3070\u6ce8\u610f\u304c\u5fc5\u8981\u3067\u3059\u3002\n\ncrm_mon \u3067 snmp-traps \u3068\u304b\u30e1\u30fc\u30eb\u901a\u77e5\n\u305f\u3057\u304b crm_mon \u306b --snmp-traps \u3068\u304b --mail-to \u3068\u304b\u306e\u30aa\u30d7\u30b7\u30e7\u30f3\u304c\u3042\u3063\u3066\u3001\u30ea\u30bd\u30fc\u30b9\u969c\u5bb3\u3092 snmptrap \u3084\u30e1\u30fc\u30eb\u3067\u901a\u77e5\u3067\u304d\u308b\u306f\u305a\u3001\u3001\u3001\u306a\u306e\u3060\u3051\u3069 man crm_mon \u306b\u3082 crm_mon --help \u306b\u3082\u305d\u306e\u60c5\u5831\u304c\u306a\u3044\u3002\u3002\u3002\n\u3060\u3044\u3076\u524d\u306b LinuxHA Japan \u306e\u30ea\u30dd\u30b8\u30c8\u30ea\u304b\u3089\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u305f pacemaker-1.0.13-2.el6.x86_64 \u306e crm_mon 1.0.13 for OpenAIS and Heartbeat (Build: a83fae5) \u3060\u3068 --snmp-traps \u3068\u304b --mail-to \u3068\u304b\u3082\u3042\u308b\u3093\u3060\u3051\u3069\u3002\u3002\u3002\n\u3068\u308a\u3042\u3048\u305a\u30c0\u30e1\u5143\u3067\u8a66\u3057\u3066\u307f\u308b\u3002\npacemaker \u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u6642\u306b crm_mon \u306e\u305f\u3081\u306e systemd \u306e\u30e6\u30cb\u30c3\u30c8\u30d5\u30a1\u30a4\u30eb\u304c\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3055\u308c\u3066\u3044\u307e\u3059\u3002\ncat /usr/lib/systemd/system/crm_mon.service\n\n\u5185\u5bb9\u306f\u6b21\u306e\u901a\u308a\u3002\n:\n[Service]\nType=forking\nEnvironmentFile=-/etc/sysconfig/crm_mon\nExecStart=/usr/sbin/crm_mon $OPTIONS\nRestart=always\n:\n\nType=forking \u3068\u3042\u308b\u306e\u3067 crm_mon \u306f\u30c7\u30fc\u30e2\u30f3\u5316\u3059\u308b\u306e\u304c\u826f\u3055\u305d\u3046\u3002EnvironmentFile \u3067\u30d5\u30a1\u30a4\u30eb\u540d\u306e\u982d\u306b - \u304c\u3064\u3044\u3066\u3044\u308b\u306e\u306f man systemd.exec \u306b\u3088\u308b\u3068\u30d5\u30a1\u30a4\u30eb\u304c\u5b58\u5728\u3057\u306a\u3044\u3068\u304d\u306b\u306f\u7121\u8996\u3059\u308b\u3068\u3044\u3046\u610f\u5473\u3068\u306e\u3053\u3068\u3002\n\u6b21\u306e\u3088\u3046\u306b /etc/sysconfig/crm_mon \u3067\u30b3\u30de\u30f3\u30c9\u30e9\u30a4\u30f3\u5f15\u6570\u3092\u6307\u5b9a\u3057\u307e\u3059\u3002\nsudo tee /etc/sysconfig/crm_mon <<'EOS'\nOPTIONS=\"--daemonize --snmp-traps=127.0.0.1\"\nEOS\n\ncrm_mon.service \u3092\u958b\u59cb\u3057\u307e\u3059\u3002\nsudo systemctl start crm_mon.service\nsudo systemctl status crm_mon.service\n\n\u610f\u56f3\u7684\u306b\u30ea\u30bd\u30fc\u30b9\u969c\u5bb3\u3092\u767a\u751f\u3055\u305b\u3066\u307f\u308b\u30fb\u30fb\u30fb\u304c\u3001\u30c8\u30e9\u30c3\u30d7\u304c\u9001\u4fe1\u3055\u308c\u308b\u6c17\u914d\u304c\u306a\u3044\u3002\n\u305f\u3081\u3057\u306b\u4e0b\u8a18\u3067\u3082\u8a66\u3057\u3066\u307f\u308b\u3082\u30fb\u30fb\u30fb\u304c\u3001\u30e1\u30fc\u30eb\u304c\u9001\u4fe1\u3055\u308c\u308b\u6c17\u914d\u306f\u306a\u3044\u3002\nsudo tee /etc/sysconfig/crm_mon <<'EOS'\nOPTIONS=\"--daemonize --mail-to=root\"\nEOS\n\n\u3069\u3046\u3082\u3053\u308c\u3089\u306e\u6a5f\u80fd\u306f CentOS 7 \u306e\u30ea\u30dd\u30b8\u30c8\u30ea\u306e pacemaker \u3067\u306f\u7121\u52b9\u306b\u306a\u3063\u3066\u3044\u308b\u3063\u307d\u3044\u3002\n\nhttp://clusterlabs.org/doc/en-US/Pacemaker/1.1/html/Pacemaker_Explained/ch07.html#idm140617236272336\n\n\nDepending on your system settings and compilation settings, SNMP or email alerts might be unavailable. Check the output of crm_mon --help to see whether these options are available to you. In any case, executing an external agent will always be available, and you can use this agent to send emails, SNMP traps or whatever action you develop.\n\n\ncrm_mon \u306e external-agent \u3067\u30b3\u30de\u30f3\u30c9\u547c\u3073\u51fa\u3057\nman crm_mon \u306b --external-agent \u306f\u3042\u3063\u305f\u306e\u3067\u3001\u3053\u3063\u3061\u3092\u8a66\u3057\u3066\u307f\u308b\u3002\nsudo tee /etc/sysconfig/crm_mon <<'EOS'\nOPTIONS=\"--daemonize --external-agent=/vagrant/agent.sh --external-recipient=ore-recipient\"\nEOS\n\n/vagrant/agent.sh \u306f\u6b21\u306e\u3088\u3046\u306a\u5185\u5bb9\u3067\u3059\u3002\n#!/bin/bash\nenv | sort | /bin/logger -t ore-agent -i\n\ncrm_mon.service \u3092\u518d\u8d77\u52d5\u3057\u307e\u3059\u3002\nsudo systemctl restart crm_mon.service\nsudo systemctl status crm_mon.service\n\n\u610f\u56f3\u7684\u306b\u30ea\u30bd\u30fc\u30b9\u969c\u5bb3\u3092\u767a\u751f\u3055\u305b\u308b\u3068 /var/log/messages \u306b\u6b21\u306e\u3088\u3046\u306a\u30ed\u30b0\u304c\u8a18\u9332\u3055\u308c\u307e\u3057\u305f\u3002\nApr 26 07:25:30 pm01 ore-agent[4553]: CRM_notify_desc=OK\nApr 26 07:25:30 pm01 ore-agent[4553]: CRM_notify_node=pm02\nApr 26 07:25:30 pm01 ore-agent[4553]: CRM_notify_rc=0\nApr 26 07:25:30 pm01 ore-agent[4553]: CRM_notify_recipient=ore-recipient\nApr 26 07:25:30 pm01 ore-agent[4553]: CRM_notify_rsc=dummy2\nApr 26 07:25:30 pm01 ore-agent[4553]: CRM_notify_status=0\nApr 26 07:25:30 pm01 ore-agent[4553]: CRM_notify_target_rc=0\nApr 26 07:25:30 pm01 ore-agent[4553]: CRM_notify_task=monitor\n :\n\n\u3064\u307e\u308a\u3001\u6307\u5b9a\u3057\u305f\u30b3\u30de\u30f3\u30c9\u304c\u3053\u308c\u3089\u306e\u74b0\u5883\u5909\u6570\u3092\u4ed8\u3051\u3066\u5b9f\u884c\u3055\u308c\u308b\u3068\u3044\u3046\u3053\u3068\u306a\u306e\u3067\u3001\u6b21\u306e\u3088\u3046\u306b\u30e1\u30fc\u30eb\u901a\u77e5\u3092\u8a2d\u5b9a\u3057\u3066\u307f\u307e\u3059\u3002\n#!/bin/bash\nenv | grep ^CRM_notify | sort |\n  mail -s \"[$CRM_notify_node] $CRM_notify_rsc $CRM_notify_task $CRM_notify_desc\" root\n\n\u610f\u56f3\u7684\u306b\u30ea\u30bd\u30fc\u30b9\u969c\u5bb3\u3092\u767a\u751f\u3055\u305b\u308b\u3068\u3001\u30e1\u30fc\u30eb\u304c\u3060\u3060\u3060\u3063\u3068\u9001\u4fe1\u3055\u308c\u307e\u3057\u305f\u3002\n\ncrm_mon \u3092 pacemaker \u306e\u30ea\u30bd\u30fc\u30b9\u306b\u3059\u308b\n\u4e0b\u8a18\u306e\u4f8b\u306e\u3088\u3046\u306b crm_mon \u3092 systemd \u3067\u306f\u306a\u304f pacemaker \u306e\u30ea\u30bd\u30fc\u30b9\u3068\u3057\u3066\u7ba1\u7406\u3057\u3066\u3082\u826f\u3044\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u3002\n\nhttp://clusterlabs.org/doc/en-US/Pacemaker/1.1/html/Pacemaker_Explained/s-notification-external.html\n\nsystemd \u306e crm_mon.service \u3092\u505c\u6b62\u3057\u307e\u3059\u3002\nsudo systemctl stop crm_mon.service\nsudo systemctl disable crm_mon.service\nsudo systemctl status crm_mon.service\n\n\u30ea\u30bd\u30fc\u30b9\u30a8\u30fc\u30b8\u30a7\u30f3\u30c8 ocf:pacemaker:ClusterMon \u306e\u8aac\u660e\u3092\u898b\u3066\u307f\u307e\u3059\u3002\nsudo pcs resource describe ocf:pacemaker:ClusterMon\n\n\u4e0b\u8a18\u306e\u3068\u304a\u308a\u3067\u3059\u3002\nocf:pacemaker:ClusterMon - Runs crm_mon in the background, recording the cluster status to an HTML file\n\nThis is a ClusterMon Resource Agent.\nIt outputs current cluster status to the html.\n\nResource options:\n  user: The user we want to run crm_mon as\n  update: How frequently should we update the cluster status\n  extra_options: Additional options to pass to crm_mon. Eg. -n -r\n  pidfile: PID file location to ensure only one instance is running\n  htmlfile: Location to write HTML output to.\n\n\u6b21\u306e\u3088\u3046\u306b Clone \u30ea\u30bd\u30fc\u30b9\u3068\u3057\u3066\u8a2d\u5b9a\u3057\u307e\u3059\u3002\nsudo pcs resource create crm_mon ocf:pacemaker:ClusterMon \\\n  user=\"root\" extra_options=\"--external-agent=/vagrant/agent.sh\" \\\n  meta migration-threshold=\"INFINITY\" --clone\n\n\ncrm_mon \u306e external-agent \u3067\u901a\u77e5\u3092\u9593\u5f15\u304f\n\u3059\u3079\u3066\u3092\u901a\u77e5\u3059\u308b\u3068\u7d50\u69cb\u306a\u91cf\u306e\u30e1\u30fc\u30eb\u304c\u98db\u3093\u3067\u6765\u308b\u306e\u3067\u3001\u4e0b\u8a18\u306e\u3088\u3046\u306b\u9593\u5f15\u304d\u307e\u3057\u305f\u3002\n#!/bin/bash\n\nif [ \"$CRM_notify_node\" != \"$(uname -n)\" ]; then\n  # \u81ea\u30ce\u30fc\u30c9\u4ee5\u5916\u306f\u9664\u5916\n  exit 0\nfi\n\nif [ \"$CRM_notify_task\" == \"monitor\" ]; then\n  case \"$CRM_notify_desc\" in\n    OK|ok)\n      # monitor \u306e OK \u306f\u9664\u5916\n      exit 0\n      ;;\n  esac\nfi\n\nenv | grep ^CRM_notify | sort |\n  mail -s \"[$CRM_notify_node] $CRM_notify_rsc $CRM_notify_task $CRM_notify_desc\" root\n\n\u3053\u306e\u30b9\u30af\u30ea\u30d7\u30c8\u3092 --external-agent \u306b\u8a2d\u5b9a\u3059\u308c\u3070\u6982\u306d\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u3068\u304d\u3060\u3051\u901a\u77e5\u3055\u308c\u307e\u3059\u3002\n\n\u30ea\u30bd\u30fc\u30b9\u306e\u958b\u59cb/\u505c\u6b62\uff08\u5931\u6557\u3067\u3082\u6210\u529f\u3067\u3082\uff09\n\u30ea\u30bd\u30fc\u30b9\u306e\u76e3\u8996\u3067\u7570\u5e38\u3092\u691c\u51fa\n\n\u81ea\u30ce\u30fc\u30c9\u306e\u30ea\u30bd\u30fc\u30b9\u969c\u5bb3\u3057\u304b\u901a\u77e5\u3057\u306a\u3044\u305f\u3081\u3001\u30ce\u30fc\u30c9\u969c\u5bb3\u304c\u767a\u751f\u3057\u305f\u3068\u304d\u306b\u306f\u305d\u306e\u30ce\u30fc\u30c9\u3067\u7a3c\u50cd\u3057\u3066\u3044\u305f\u30ea\u30bd\u30fc\u30b9\u306e\u969c\u5bb3\u306f\u901a\u77e5\u3055\u308c\u307e\u305b\u3093\uff08\u901a\u77e5\u3059\u308b crm_mon \u304c\u6b7b\u3093\u3067\u3044\u308b\u306e\u3067\uff09\u3002\nActive/Standby \u306e\u30a2\u30af\u30c6\u30a3\u30d6\u5074\u306e\u30ce\u30fc\u30c9\u969c\u5bb3\u306a\u3089\u3001\u30b9\u30bf\u30f3\u30d0\u30a4\u5074\u306e\u30ea\u30bd\u30fc\u30b9\u304c\u958b\u59cb\u3059\u308b\u306e\u3067\u3001\u305d\u306e\u901a\u77e5\u3092\u6301\u3063\u3066\u30ce\u30fc\u30c9\u969c\u5bb3\u3092\u63a8\u6e2c\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u304c\u3001Clone \u30ea\u30bd\u30fc\u30b9\u3057\u304b\u7121\u3044\u3001\u3068\u304b\u3001Active/Standby \u306e\u30b9\u30bf\u30f3\u30d0\u30a4\u5074\u306e\u969c\u5bb3\u3001\u3068\u304b\u3060\u3068\u3001\u3053\u306e\u65b9\u6cd5\u3060\u3051\u3067\u306f\u30ce\u30fc\u30c9\u969c\u5bb3\u3092\u691c\u51fa\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u305b\u3093\u3002\n\u306e\u3067\u3001corosync-notifyd \u3068\u4f75\u7528\u3059\u308b\u306e\u304c\u826f\u3044\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u3002\n\u3042\u308b\u3044\u306f crm_mon \u3092 Clone \u30ea\u30bd\u30fc\u30b9\u3068\u3057\u3066\u8a2d\u5b9a\u3057\u3066\u3044\u308b\u306a\u3089 crm_mon \u30ea\u30bd\u30fc\u30b9\u3060\u3051\u306f\u30ce\u30fc\u30c9\u306b\u4f9d\u3089\u305a\u901a\u77e5\u3057\u3066\u307f\u308b\u3068\u304b\u3002\n#!/bin/bash\n\nif [ \"$CRM_notify_node\" != \"$(uname -n)\" ]; then\n  if [ \"$CRM_notify_rsc\" != \"crm_mon\" ]; then\n    exit 0\n  fi\nfi\n\nif [ \"$CRM_notify_task\" == \"monitor\" ]; then\n  case \"$CRM_notify_desc\" in\n    OK|ok)\n      exit 0\n      ;;\n  esac\nfi\n\nenv | grep ^CRM_notify | sort |\n  mail -s \"[$CRM_notify_node] $CRM_notify_rsc $CRM_notify_task $CRM_notify_desc\" root\n\n\u3053\u308c\u306a\u3089\u3001\u4f8b\u3048\u3070 pm01 \u306e\u30ce\u30fc\u30c9\u969c\u5bb3\u6642\u306b\u3001pm02 \u304b\u3089\u3001pm01 \u306e crm_mon \u304c\u505c\u6b62\u3057\u305f\u65e8\u306e\u901a\u77e5\u304c\u9001\u3089\u308c\u3066\u304d\u307e\u3059\u3002\u305f\u3060\u3057\u3001pm01 \u304c\u958b\u59cb\u3057\u305f\u3068\u304d\u306b\u306f pm01 \u3068 pm02 \u306e\u4e21\u65b9\u304b\u3089 pm01 \u306e crm_mon \u304c\u958b\u59cb\u3057\u305f\u65e8\u306e\u901a\u77e5\u304c\u9001\u3089\u308c\u3066\u304d\u307e\u3059\u304c\u3002\nCentOS 7 \u306e\u30ea\u30dd\u30b8\u30c8\u30ea\u304b\u3089\u30b5\u30af\u30c3\u3068\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3067\u304d\u308b\u4e0b\u8a18\u3067\u8a66\u3057\u3066\u3044\u307e\u3059\u3002\n\n- corosync-2.3.4-7.el7_2.1\n- pacemaker-1.1.13-10.el7_2.2\n- resource-agents-3.9.5-54.el7_2.9\n\n## Pacemaker/Corosync \u306e\u69cb\u6210\n\n\u78ba\u8a8d\u7528\u306b\u6b21\u306e\u3088\u3046\u306a\u69cb\u6210\u3067 Pacemaker/Corosync \u306e\u74b0\u5883\u3092\u69cb\u7bc9\u3057\u3066\u3044\u307e\u3059\u3002\n\n### corosync\n\n- pm01\n  - 192.168.33.11/24 (enp0s8 / ring0)\n  - 192.168.99.11/24 (enp0s9 / ring1)\n- pm02\n  - 192.168.33.12/24 (enp0s8 / ring0)\n  - 192.168.99.12/24 (enp0s9 / ring1)\n\n### pacemaker\n\n```sh\nsudo pcs property set stonith-enabled=\"false\"\nsudo pcs property set no-quorum-policy=\"ignore\"\n\nsudo pcs resource defaults migration-threshold=\"1\"\n\nsudo pcs resource create dummy1 ocf:pacemaker:Dummy state=/tmp/pm-dummy1\nsudo pcs resource create dummy2 ocf:pacemaker:Dummy state=/tmp/pm-dummy2\n\nsudo pcs resource group add dummys dummy1 dummy2\n```\n\n### /etc/hosts\n\n```sh\n127.0.0.1       localhost localhost.localdomain localhost4 localhost4.localdomain4\n192.168.33.11   pm01\n192.168.33.12   pm02\n192.168.99.11   pm01-back\n192.168.99.12   pm02-back\n```\n\n## snmptrapd\n\nsnmptrap \u306e\u78ba\u8a8d\u306e\u305f\u3081\u306b \u30ed\u30fc\u30ab\u30eb\u306b snmptrapd \u3092\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u3057\u307e\u3059\u3002\n\n\u5fc5\u8981\u306a\u3082\u308d\u3082\u308d\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u307e\u3059\u3002\n\n```sh\nsudo yum -y install net-snmp net-snmp-utils net-snmp-perl mailx\n```\n\nsnmptrapd \u3067\u3059\u3079\u3066\u306e\u30c8\u30e9\u30c3\u30d7\u3092\u30e1\u30fc\u30eb\u3067 root \u306b\u8ee2\u9001\u3059\u308b\u3088\u3046\u306b\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\n```sh\nsudo tee /etc/snmp/snmptrapd.conf <<'EOS'\ndisableAuthorization yes\ntraphandle default /usr/bin/traptoemail root\nEOS\n```\n\nroot \u3078\u306e\u30e1\u30fc\u30eb\u306f\u81ea\u5206\u306e\u30e1\u30fc\u30eb\u30a2\u30c9\u30ec\u30b9\u306b\u8ee2\u9001\u3055\u305b\u307e\u3059\u3002\n\n```sh\necho ore@example.com | sudo tee /root/.forward\n```\n\npacemaker \u3084 corosync \u306e mib \u3092\u8aad\u307f\u8fbc\u3080\u305f\u3081\u306b `/etc/snmp/snmp.conf` \u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n```sh\nsudo tee /etc/snmp/snmp.conf <<'EOS'\nmibs ALL\nEOS\n```\n\nsnmptrapd \u3092\u958b\u59cb\u3057\u307e\u3059\u3002\n\n```sh\nsudo systemctl start snmptrapd\nsudo systemctl enable snmptrapd\n```\n\n\u8a66\u3057\u306b\u9069\u5f53\u306a\u30c8\u30e9\u30c3\u30d7\u3092\u9001\u4fe1\u3057\u307e\u3059\u3002\u30c8\u30e9\u30c3\u30d7\u304c\u30e1\u30fc\u30eb\u3067\u9001\u4fe1\u3055\u308c\u308c\u3070\u6b63\u3057\u304f\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n\n```sh\nsudo snmptrap -v 1 -c hoge localhost corosync localhost 6 1 ''\nsudo snmptrap -v 1 -c hoge localhost pacemaker localhost 6 1 ''\n```\n\n## corosync-notifyd\n\n`corosync-notifyd` \u306f corosync \u306e\u91cd\u8981\u306a\u30a4\u30d9\u30f3\u30c8\u3092 dbus \u3084 snmptrap \u3067\u901a\u77e5\u3059\u308b\u30b5\u30fc\u30d3\u30b9\u3067\u3059\u3002\u30ce\u30fc\u30c9\u306e\u6545\u969c\u3084\u5fa9\u5e30\u3092\u901a\u77e5\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u304c\u30fb\u30fb\u30fb\u30ea\u30bd\u30fc\u30b9\u969c\u5bb3\u306f corosync \u306e\u7ba1\u8f44\u3058\u3083\u306a\u3044\u306e\u3067\u901a\u77e5\u3067\u304d\u307e\u305b\u3093\u3002\n\n`/etc/sysconfig/corosync-notifyd` \u3067\u30b3\u30de\u30f3\u30c9\u30e9\u30a4\u30f3\u30aa\u30d7\u30b7\u30e7\u30f3\u3092\u6307\u5b9a\u3067\u304d\u308b\u306e\u3067 `127.0.0.1` \u306b\u30c8\u30e9\u30c3\u30d7\u3092\u9001\u4fe1\u3059\u308b\u3088\u3046\u306b\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\n```sh\nsudo tee /etc/sysconfig/corosync-notifyd <<'EOS'\nOPTIONS=\"-s -l -m 127.0.0.1\"\nEOS\n```\n\n`corosync-notifyd` \u3092\u958b\u59cb\u3057\u307e\u3059\u3002\n\n```sh\nsudo systemctl start corosync-notifyd\n```\n\n\u958b\u59cb\u3057\u305f\u6642\u70b9\u3067\u6b21\u306e\u3088\u3046\u306a\u30c8\u30e9\u30c3\u30d7\u304c\u9001\u4fe1\u3055\u308c\u307e\u3057\u305f\u3002\n\n```sh\n                SNMPv2-MIB::snmpTrapOID.0  COROSYNC-MIB::corosyncNoticesQuorumStatus\n    COROSYNC-MIB::corosyncObjectsNodeName  \"pm01\"\n      COROSYNC-MIB::corosyncObjectsNodeID  1\nCOROSYNC-MIB::corosyncObjectsQuorumStatus  \"quorate\"\n```\n\n### pacemaker \u3084 corosync \u3092\u505c\u6b62\u30fb\u958b\u59cb\u3057\u305f\u3068\u304d\u306e\u901a\u77e5\n\n\u7247\u65b9\u306e pacemaker \u3092\u505c\u6b62\u3057\u3066\u307f\u308b\u3002\n\n```sh\nsudo systemctl stop pacemaker\n```\n\n\u3053\u306e\u3068\u304d\u306f\u30c8\u30e9\u30c3\u30d7\u306f\u9001\u4fe1\u3055\u308c\u307e\u305b\u3093\u3002\n\ncorosync \u3092\u505c\u6b62\u3057\u3066\u307f\u308b\u3002\n\n```sh\nsudo systemctl stop corosync\n```\n\n\u6b21\u306e\u3088\u3046\u306a\u30c8\u30e9\u30c3\u30d7\u304c\u7247\u5272\u308c\uff08pm01 \u3067 corosync \u3092\u505c\u6b62\u3057\u305f\u306e\u3067 pm02 \u304b\u3089\uff09\u304b\u3089\u9001\u4fe1\u3055\u308c\u307e\u3057\u305f\u3002\n\n```sh\n# from pm02\n               SNMPv2-MIB::snmpTrapOID.0  COROSYNC-MIB::corosyncNoticesNodeStatus\n   COROSYNC-MIB::corosyncObjectsNodeName  \"pm01-back\"\n     COROSYNC-MIB::corosyncObjectsNodeID  1\nCOROSYNC-MIB::corosyncObjectsNodeAddress  \"192.168.99.11\"\n COROSYNC-MIB::corosyncObjectsNodeStatus  \"left\"\n```\n\npacemaker \u3092\u958b\u59cb\u3057\u3066\u307f\u308b\uff08corosync \u3082\u4e00\u7dd2\u306b\u958b\u59cb\u3055\u308c\u307e\u3059\uff09\u3002\n\n```sh\nsudo systemctl start pacemaker\n```\n\n\u6b21\u306e\u3088\u3046\u306a\u30c8\u30e9\u30c3\u30d7\u304c\u9001\u4fe1\u3055\u308c\u307e\u3057\u305f\u3002\n\n```sh\n# from pm02\n               SNMPv2-MIB::snmpTrapOID.0  COROSYNC-MIB::corosyncNoticesNodeStatus\n   COROSYNC-MIB::corosyncObjectsNodeName  \"pm01-back\"\n     COROSYNC-MIB::corosyncObjectsNodeID  1\nCOROSYNC-MIB::corosyncObjectsNodeAddress  \"192.168.99.11\"\n COROSYNC-MIB::corosyncObjectsNodeStatus  \"joined\"\n```\n\n### \u30ea\u30bd\u30fc\u30b9\u969c\u5bb3\n\n\u30ea\u30bd\u30fc\u30b9\u969c\u5bb3\u3092\u767a\u751f\u3055\u305b\u3066\u307f\u308b\u3002\n\n```sh\nsudo rm /tmp/pm-dummy1\n```\n\n\u304c\u3001\u30ea\u30bd\u30fc\u30b9\u969c\u5bb3\u3067\u306f\u306a\u306b\u3082\u901a\u77e5\u3055\u308c\u307e\u305b\u3093\u3067\u3057\u305f\u3002\n\n### \u901a\u4fe1\u969c\u5bb3\n\nNIC \u306e 1 \u3064\u3092 iptables \u3067\u585e\u3044\u3067\u307f\u307e\u3059\u3002\n\n```sh\nsudo yum -y install iptables-services\nsudo systemctl start iptables\nsudo iptables -F\nsudo iptables -A INPUT -i enp0s9 -j DROP\n```\n\n\u6b21\u306e\u3088\u3046\u306a\u30c8\u30e9\u30c3\u30d7\u304c\u9001\u4fe1\u3055\u308c\u307e\u3057\u305f\u3002\u4e21\u65b9\u306e\u30ce\u30fc\u30c9\u304b\u3089\u901a\u77e5\u304c\u6765\u308b\u3068\u601d\u3063\u3066\u3044\u305f\u306e\u3067\u3059\u304c\u3001\u3001\u3001\u7247\u65b9\u304b\u3089\u3057\u304b\u6765\u307e\u305b\u3093\u3067\u3057\u305f\uff08`corosync-cfgtool` \u3067\u898b\u305f\u611f\u3058\u3001\u4e21\u65b9\u306e\u30ce\u30fc\u30c9\u3067 `faulty` \u306b\u306a\u3063\u3066\u307e\u3059\uff09\u3002\n\n```sh\n# from pm02\n             SNMPv2-MIB::snmpTrapOID.0  COROSYNC-MIB::corosyncNoticesRRPStatus\n COROSYNC-MIB::corosyncObjectsNodeName  \"pm02\"\n   COROSYNC-MIB::corosyncObjectsNodeID  2\n  COROSYNC-MIB::corosyncObjectsIfaceNo  1\nCOROSYNC-MIB::corosyncObjectsRRPStatus  \"faulty\"\n\n```\n\n\u585e\u3044\u3067\u305f\u7a74\u3092\u958b\u304d\u307e\u3059\u3002\n\n```sh\nsudo iptables -F\n```\n\n\u6b21\u306e\u3088\u3046\u306a\u30c8\u30e9\u30c3\u30d7\u304c\u9001\u4fe1\u3055\u308c\u307e\u3057\u305f\u3002\u3053\u308c\u3082\u7247\u65b9\u306e\u30ce\u30fc\u30c9\u304b\u3089\u3057\u304b\u9001\u4fe1\u3055\u308c\u307e\u305b\u3093\u3067\u3057\u305f\u3002\n\n```sh\n# from pm02\n             SNMPv2-MIB::snmpTrapOID.0  COROSYNC-MIB::corosyncNoticesRRPStatus\n COROSYNC-MIB::corosyncObjectsNodeName  \"pm02\"\n   COROSYNC-MIB::corosyncObjectsNodeID  2\n  COROSYNC-MIB::corosyncObjectsIfaceNo  1\nCOROSYNC-MIB::corosyncObjectsRRPStatus  \"operational\"\n```\n\n### \u30ce\u30fc\u30c9\u969c\u5bb3\n\n\u30b5\u30fc\u30d0\u3092\u5f37\u5236\u7d42\u4e86\u3057\u3066\u307f\u307e\u3059\u3002Vagrant \u74b0\u5883\u306a\u306e\u3067\u6b21\u306e\u3088\u3046\u306b\u5f37\u5236\u7d42\u4e86\u3057\u307e\u3059\u3002\n\n```sh\nvagrant halt --force pm01\n```\n\n\u6b21\u306e\u3088\u3046\u306a\u30c8\u30e9\u30c3\u30d7\u304c\u9001\u4fe1\u3055\u308c\u307e\u3057\u305f\u3002\n\n```sh\n# from pm02\n               SNMPv2-MIB::snmpTrapOID.0  COROSYNC-MIB::corosyncNoticesNodeStatus\n   COROSYNC-MIB::corosyncObjectsNodeName  \"pm01-back\"\n     COROSYNC-MIB::corosyncObjectsNodeID  1\nCOROSYNC-MIB::corosyncObjectsNodeAddress  \"192.168.99.11\"\n COROSYNC-MIB::corosyncObjectsNodeStatus  \"left\"\n```\n\n\u30b5\u30fc\u30d0\u3092\u8d77\u52d5\u3057\u307e\u3059\u3002\n\n```sh\nvagrant up pm01\nvagrant ssh pm01\nsudo systemctl start corosync-notifyd \nsudo systemctl start pacemaker\n```\n\n\u6b21\u306e\u3088\u3046\u306a\u30c8\u30e9\u30c3\u30d7\u304c\u9001\u4fe1\u3055\u308c\u307e\u3057\u305f\u3002\n\n```sh\n# from pm02\n               SNMPv2-MIB::snmpTrapOID.0  COROSYNC-MIB::corosyncNoticesNodeStatus\n   COROSYNC-MIB::corosyncObjectsNodeName  \"pm01-back\"\n     COROSYNC-MIB::corosyncObjectsNodeID  1\nCOROSYNC-MIB::corosyncObjectsNodeAddress  \"192.168.99.11\"\n COROSYNC-MIB::corosyncObjectsNodeStatus  \"joined\"\n```\n\n```sh\n# from pm01\n                SNMPv2-MIB::snmpTrapOID.0  COROSYNC-MIB::corosyncNoticesQuorumStatus\n    COROSYNC-MIB::corosyncObjectsNodeName  \"pm01\"\n      COROSYNC-MIB::corosyncObjectsNodeID  1\nCOROSYNC-MIB::corosyncObjectsQuorumStatus  \"quorate\"\n\n```\n\n```sh\n# from pm01\n             SNMPv2-MIB::snmpTrapOID.0  COROSYNC-MIB::corosyncNoticesRRPStatus\n COROSYNC-MIB::corosyncObjectsNodeName  \"pm01\"\n   COROSYNC-MIB::corosyncObjectsNodeID  1\n  COROSYNC-MIB::corosyncObjectsIfaceNo  0\nCOROSYNC-MIB::corosyncObjectsRRPStatus  \"operational\"\n```\n\n```sh\n# from pm01\n             SNMPv2-MIB::snmpTrapOID.0  COROSYNC-MIB::corosyncNoticesRRPStatus\n COROSYNC-MIB::corosyncObjectsNodeName  \"pm01\"\n   COROSYNC-MIB::corosyncObjectsNodeID  1\n  COROSYNC-MIB::corosyncObjectsIfaceNo  1\nCOROSYNC-MIB::corosyncObjectsRRPStatus  \"operational\"\n```\n\n### corosync-notifyd \u3092\u8d77\u52d5\u3059\u308b\u3068 corosync \u3082\u8d77\u52d5\u3059\u308b\n\n\u3061\u306a\u307f\u306b `corosync-notifyd` \u306e systemd \u306e\u30e6\u30cb\u30c3\u30c8\u30d5\u30a1\u30a4\u30eb\u306b `Wants=corosync.service` \u304c\u66f8\u304b\u308c\u3066\u3044\u308b\u306e\u3067\u3001`corosync-notifyd` \u3092\u958b\u59cb\u3059\u308b\u3068 `corosync` \u3082\u4e00\u7dd2\u306b\u958b\u59cb\u3057\u307e\u3059\u3002\n\n```sh\ncat /usr/lib/systemd/system/corosync-notifyd.service\n# [Unit]\n# Description=Corosync Dbus and snmp notifier\n# Wants=corosync.service\n# After=corosync.service\n# :\n```\n\n\u30b5\u30fc\u30d0\u306e\u30d6\u30fc\u30c8\u6642\u306b `corosync` \u3092\u8d77\u52d5\u3055\u305b\u305f\u304f\u306a\u3044\u306e\u3067\u3042\u308c\u3070\u6ce8\u610f\u304c\u5fc5\u8981\u3067\u3059\u3002\n\n## crm_mon \u3067 snmp-traps \u3068\u304b\u30e1\u30fc\u30eb\u901a\u77e5\n\n\u305f\u3057\u304b `crm_mon` \u306b `--snmp-traps` \u3068\u304b `--mail-to` \u3068\u304b\u306e\u30aa\u30d7\u30b7\u30e7\u30f3\u304c\u3042\u3063\u3066\u3001\u30ea\u30bd\u30fc\u30b9\u969c\u5bb3\u3092 snmptrap \u3084\u30e1\u30fc\u30eb\u3067\u901a\u77e5\u3067\u304d\u308b\u306f\u305a\u3001\u3001\u3001\u306a\u306e\u3060\u3051\u3069 `man crm_mon` \u306b\u3082 `crm_mon --help` \u306b\u3082\u305d\u306e\u60c5\u5831\u304c\u306a\u3044\u3002\u3002\u3002\n\n\u3060\u3044\u3076\u524d\u306b LinuxHA Japan \u306e\u30ea\u30dd\u30b8\u30c8\u30ea\u304b\u3089\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u305f `pacemaker-1.0.13-2.el6.x86_64` \u306e `crm_mon 1.0.13 for OpenAIS and Heartbeat (Build: a83fae5)` \u3060\u3068 `--snmp-traps` \u3068\u304b `--mail-to` \u3068\u304b\u3082\u3042\u308b\u3093\u3060\u3051\u3069\u3002\u3002\u3002\n\n\u3068\u308a\u3042\u3048\u305a\u30c0\u30e1\u5143\u3067\u8a66\u3057\u3066\u307f\u308b\u3002\n\npacemaker \u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u6642\u306b `crm_mon` \u306e\u305f\u3081\u306e systemd \u306e\u30e6\u30cb\u30c3\u30c8\u30d5\u30a1\u30a4\u30eb\u304c\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n\n```sh\ncat /usr/lib/systemd/system/crm_mon.service\n```\n\n\u5185\u5bb9\u306f\u6b21\u306e\u901a\u308a\u3002\n\n```\n:\n[Service]\nType=forking\nEnvironmentFile=-/etc/sysconfig/crm_mon\nExecStart=/usr/sbin/crm_mon $OPTIONS\nRestart=always\n:\n```\n\n`Type=forking` \u3068\u3042\u308b\u306e\u3067 `crm_mon` \u306f\u30c7\u30fc\u30e2\u30f3\u5316\u3059\u308b\u306e\u304c\u826f\u3055\u305d\u3046\u3002`EnvironmentFile` \u3067\u30d5\u30a1\u30a4\u30eb\u540d\u306e\u982d\u306b `-` \u304c\u3064\u3044\u3066\u3044\u308b\u306e\u306f `man systemd.exec` \u306b\u3088\u308b\u3068\u30d5\u30a1\u30a4\u30eb\u304c\u5b58\u5728\u3057\u306a\u3044\u3068\u304d\u306b\u306f\u7121\u8996\u3059\u308b\u3068\u3044\u3046\u610f\u5473\u3068\u306e\u3053\u3068\u3002\n\n\u6b21\u306e\u3088\u3046\u306b `/etc/sysconfig/crm_mon` \u3067\u30b3\u30de\u30f3\u30c9\u30e9\u30a4\u30f3\u5f15\u6570\u3092\u6307\u5b9a\u3057\u307e\u3059\u3002\n\n```sh\nsudo tee /etc/sysconfig/crm_mon <<'EOS'\nOPTIONS=\"--daemonize --snmp-traps=127.0.0.1\"\nEOS\n```\n\n`crm_mon.service` \u3092\u958b\u59cb\u3057\u307e\u3059\u3002\n\n```sh\nsudo systemctl start crm_mon.service\nsudo systemctl status crm_mon.service\n```\n\n\u610f\u56f3\u7684\u306b\u30ea\u30bd\u30fc\u30b9\u969c\u5bb3\u3092\u767a\u751f\u3055\u305b\u3066\u307f\u308b\u30fb\u30fb\u30fb\u304c\u3001\u30c8\u30e9\u30c3\u30d7\u304c\u9001\u4fe1\u3055\u308c\u308b\u6c17\u914d\u304c\u306a\u3044\u3002\n\n\u305f\u3081\u3057\u306b\u4e0b\u8a18\u3067\u3082\u8a66\u3057\u3066\u307f\u308b\u3082\u30fb\u30fb\u30fb\u304c\u3001\u30e1\u30fc\u30eb\u304c\u9001\u4fe1\u3055\u308c\u308b\u6c17\u914d\u306f\u306a\u3044\u3002\n\n```sh\nsudo tee /etc/sysconfig/crm_mon <<'EOS'\nOPTIONS=\"--daemonize --mail-to=root\"\nEOS\n```\n\n\u3069\u3046\u3082\u3053\u308c\u3089\u306e\u6a5f\u80fd\u306f CentOS 7 \u306e\u30ea\u30dd\u30b8\u30c8\u30ea\u306e pacemaker \u3067\u306f\u7121\u52b9\u306b\u306a\u3063\u3066\u3044\u308b\u3063\u307d\u3044\u3002\n\n- http://clusterlabs.org/doc/en-US/Pacemaker/1.1/html/Pacemaker_Explained/ch07.html#idm140617236272336\n\n> Depending on your system settings and compilation settings, SNMP or email alerts might be unavailable. Check the output of crm_mon --help to see whether these options are available to you. In any case, executing an external agent will always be available, and you can use this agent to send emails, SNMP traps or whatever action you develop.\n\n## crm_mon \u306e external-agent \u3067\u30b3\u30de\u30f3\u30c9\u547c\u3073\u51fa\u3057\n\n`man crm_mon` \u306b `--external-agent` \u306f\u3042\u3063\u305f\u306e\u3067\u3001\u3053\u3063\u3061\u3092\u8a66\u3057\u3066\u307f\u308b\u3002\n\n```sh\nsudo tee /etc/sysconfig/crm_mon <<'EOS'\nOPTIONS=\"--daemonize --external-agent=/vagrant/agent.sh --external-recipient=ore-recipient\"\nEOS\n```\n\n`/vagrant/agent.sh` \u306f\u6b21\u306e\u3088\u3046\u306a\u5185\u5bb9\u3067\u3059\u3002\n\n```sh\n#!/bin/bash\nenv | sort | /bin/logger -t ore-agent -i\n```\n\n`crm_mon.service` \u3092\u518d\u8d77\u52d5\u3057\u307e\u3059\u3002\n\n```sh\nsudo systemctl restart crm_mon.service\nsudo systemctl status crm_mon.service\n```\n\n\u610f\u56f3\u7684\u306b\u30ea\u30bd\u30fc\u30b9\u969c\u5bb3\u3092\u767a\u751f\u3055\u305b\u308b\u3068 `/var/log/messages` \u306b\u6b21\u306e\u3088\u3046\u306a\u30ed\u30b0\u304c\u8a18\u9332\u3055\u308c\u307e\u3057\u305f\u3002\n\n```\nApr 26 07:25:30 pm01 ore-agent[4553]: CRM_notify_desc=OK\nApr 26 07:25:30 pm01 ore-agent[4553]: CRM_notify_node=pm02\nApr 26 07:25:30 pm01 ore-agent[4553]: CRM_notify_rc=0\nApr 26 07:25:30 pm01 ore-agent[4553]: CRM_notify_recipient=ore-recipient\nApr 26 07:25:30 pm01 ore-agent[4553]: CRM_notify_rsc=dummy2\nApr 26 07:25:30 pm01 ore-agent[4553]: CRM_notify_status=0\nApr 26 07:25:30 pm01 ore-agent[4553]: CRM_notify_target_rc=0\nApr 26 07:25:30 pm01 ore-agent[4553]: CRM_notify_task=monitor\n :\n```\n\n\u3064\u307e\u308a\u3001\u6307\u5b9a\u3057\u305f\u30b3\u30de\u30f3\u30c9\u304c\u3053\u308c\u3089\u306e\u74b0\u5883\u5909\u6570\u3092\u4ed8\u3051\u3066\u5b9f\u884c\u3055\u308c\u308b\u3068\u3044\u3046\u3053\u3068\u306a\u306e\u3067\u3001\u6b21\u306e\u3088\u3046\u306b\u30e1\u30fc\u30eb\u901a\u77e5\u3092\u8a2d\u5b9a\u3057\u3066\u307f\u307e\u3059\u3002\n\n```sh\n#!/bin/bash\nenv | grep ^CRM_notify | sort |\n  mail -s \"[$CRM_notify_node] $CRM_notify_rsc $CRM_notify_task $CRM_notify_desc\" root\n```\n\n\u610f\u56f3\u7684\u306b\u30ea\u30bd\u30fc\u30b9\u969c\u5bb3\u3092\u767a\u751f\u3055\u305b\u308b\u3068\u3001\u30e1\u30fc\u30eb\u304c\u3060\u3060\u3060\u3063\u3068\u9001\u4fe1\u3055\u308c\u307e\u3057\u305f\u3002\n\n## crm_mon \u3092 pacemaker \u306e\u30ea\u30bd\u30fc\u30b9\u306b\u3059\u308b\n\n\u4e0b\u8a18\u306e\u4f8b\u306e\u3088\u3046\u306b `crm_mon` \u3092 systemd \u3067\u306f\u306a\u304f pacemaker \u306e\u30ea\u30bd\u30fc\u30b9\u3068\u3057\u3066\u7ba1\u7406\u3057\u3066\u3082\u826f\u3044\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u3002\n\n- http://clusterlabs.org/doc/en-US/Pacemaker/1.1/html/Pacemaker_Explained/s-notification-external.html\n\nsystemd \u306e `crm_mon.service` \u3092\u505c\u6b62\u3057\u307e\u3059\u3002\n\n```sh\nsudo systemctl stop crm_mon.service\nsudo systemctl disable crm_mon.service\nsudo systemctl status crm_mon.service\n```\n\n\u30ea\u30bd\u30fc\u30b9\u30a8\u30fc\u30b8\u30a7\u30f3\u30c8 `ocf:pacemaker:ClusterMon` \u306e\u8aac\u660e\u3092\u898b\u3066\u307f\u307e\u3059\u3002\n\n```sh\nsudo pcs resource describe ocf:pacemaker:ClusterMon\n```\n\n\u4e0b\u8a18\u306e\u3068\u304a\u308a\u3067\u3059\u3002\n\n```\nocf:pacemaker:ClusterMon - Runs crm_mon in the background, recording the cluster status to an HTML file\n\nThis is a ClusterMon Resource Agent.\nIt outputs current cluster status to the html.\n\nResource options:\n  user: The user we want to run crm_mon as\n  update: How frequently should we update the cluster status\n  extra_options: Additional options to pass to crm_mon. Eg. -n -r\n  pidfile: PID file location to ensure only one instance is running\n  htmlfile: Location to write HTML output to.\n```\n\n\u6b21\u306e\u3088\u3046\u306b Clone \u30ea\u30bd\u30fc\u30b9\u3068\u3057\u3066\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\n```sh\nsudo pcs resource create crm_mon ocf:pacemaker:ClusterMon \\\n  user=\"root\" extra_options=\"--external-agent=/vagrant/agent.sh\" \\\n  meta migration-threshold=\"INFINITY\" --clone\n```\n\n## crm_mon \u306e external-agent \u3067\u901a\u77e5\u3092\u9593\u5f15\u304f\n\n\u3059\u3079\u3066\u3092\u901a\u77e5\u3059\u308b\u3068\u7d50\u69cb\u306a\u91cf\u306e\u30e1\u30fc\u30eb\u304c\u98db\u3093\u3067\u6765\u308b\u306e\u3067\u3001\u4e0b\u8a18\u306e\u3088\u3046\u306b\u9593\u5f15\u304d\u307e\u3057\u305f\u3002\n\n```sh\n#!/bin/bash\n\nif [ \"$CRM_notify_node\" != \"$(uname -n)\" ]; then\n  # \u81ea\u30ce\u30fc\u30c9\u4ee5\u5916\u306f\u9664\u5916\n  exit 0\nfi\n\nif [ \"$CRM_notify_task\" == \"monitor\" ]; then\n  case \"$CRM_notify_desc\" in\n    OK|ok)\n      # monitor \u306e OK \u306f\u9664\u5916\n      exit 0\n      ;;\n  esac\nfi\n\nenv | grep ^CRM_notify | sort |\n  mail -s \"[$CRM_notify_node] $CRM_notify_rsc $CRM_notify_task $CRM_notify_desc\" root\n```\n\n\u3053\u306e\u30b9\u30af\u30ea\u30d7\u30c8\u3092 `--external-agent` \u306b\u8a2d\u5b9a\u3059\u308c\u3070\u6982\u306d\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u3068\u304d\u3060\u3051\u901a\u77e5\u3055\u308c\u307e\u3059\u3002\n\n- \u30ea\u30bd\u30fc\u30b9\u306e\u958b\u59cb/\u505c\u6b62\uff08\u5931\u6557\u3067\u3082\u6210\u529f\u3067\u3082\uff09\n- \u30ea\u30bd\u30fc\u30b9\u306e\u76e3\u8996\u3067\u7570\u5e38\u3092\u691c\u51fa\n\n\u81ea\u30ce\u30fc\u30c9\u306e\u30ea\u30bd\u30fc\u30b9\u969c\u5bb3\u3057\u304b\u901a\u77e5\u3057\u306a\u3044\u305f\u3081\u3001\u30ce\u30fc\u30c9\u969c\u5bb3\u304c\u767a\u751f\u3057\u305f\u3068\u304d\u306b\u306f\u305d\u306e\u30ce\u30fc\u30c9\u3067\u7a3c\u50cd\u3057\u3066\u3044\u305f\u30ea\u30bd\u30fc\u30b9\u306e\u969c\u5bb3\u306f\u901a\u77e5\u3055\u308c\u307e\u305b\u3093\uff08\u901a\u77e5\u3059\u308b `crm_mon` \u304c\u6b7b\u3093\u3067\u3044\u308b\u306e\u3067\uff09\u3002\n\nActive/Standby \u306e\u30a2\u30af\u30c6\u30a3\u30d6\u5074\u306e\u30ce\u30fc\u30c9\u969c\u5bb3\u306a\u3089\u3001\u30b9\u30bf\u30f3\u30d0\u30a4\u5074\u306e\u30ea\u30bd\u30fc\u30b9\u304c\u958b\u59cb\u3059\u308b\u306e\u3067\u3001\u305d\u306e\u901a\u77e5\u3092\u6301\u3063\u3066\u30ce\u30fc\u30c9\u969c\u5bb3\u3092\u63a8\u6e2c\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u304c\u3001Clone \u30ea\u30bd\u30fc\u30b9\u3057\u304b\u7121\u3044\u3001\u3068\u304b\u3001Active/Standby \u306e\u30b9\u30bf\u30f3\u30d0\u30a4\u5074\u306e\u969c\u5bb3\u3001\u3068\u304b\u3060\u3068\u3001\u3053\u306e\u65b9\u6cd5\u3060\u3051\u3067\u306f\u30ce\u30fc\u30c9\u969c\u5bb3\u3092\u691c\u51fa\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u305b\u3093\u3002\n\n\u306e\u3067\u3001`corosync-notifyd` \u3068\u4f75\u7528\u3059\u308b\u306e\u304c\u826f\u3044\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u3002\n\n\u3042\u308b\u3044\u306f `crm_mon` \u3092 Clone \u30ea\u30bd\u30fc\u30b9\u3068\u3057\u3066\u8a2d\u5b9a\u3057\u3066\u3044\u308b\u306a\u3089 `crm_mon` \u30ea\u30bd\u30fc\u30b9\u3060\u3051\u306f\u30ce\u30fc\u30c9\u306b\u4f9d\u3089\u305a\u901a\u77e5\u3057\u3066\u307f\u308b\u3068\u304b\u3002\n\n```sh\n#!/bin/bash\n\nif [ \"$CRM_notify_node\" != \"$(uname -n)\" ]; then\n  if [ \"$CRM_notify_rsc\" != \"crm_mon\" ]; then\n    exit 0\n  fi\nfi\n\nif [ \"$CRM_notify_task\" == \"monitor\" ]; then\n  case \"$CRM_notify_desc\" in\n    OK|ok)\n      exit 0\n      ;;\n  esac\nfi\n\nenv | grep ^CRM_notify | sort |\n  mail -s \"[$CRM_notify_node] $CRM_notify_rsc $CRM_notify_task $CRM_notify_desc\" root\n```\n\n\u3053\u308c\u306a\u3089\u3001\u4f8b\u3048\u3070 pm01 \u306e\u30ce\u30fc\u30c9\u969c\u5bb3\u6642\u306b\u3001pm02 \u304b\u3089\u3001pm01 \u306e `crm_mon` \u304c\u505c\u6b62\u3057\u305f\u65e8\u306e\u901a\u77e5\u304c\u9001\u3089\u308c\u3066\u304d\u307e\u3059\u3002\u305f\u3060\u3057\u3001pm01 \u304c\u958b\u59cb\u3057\u305f\u3068\u304d\u306b\u306f pm01 \u3068 pm02 \u306e\u4e21\u65b9\u304b\u3089 pm01 \u306e `crm_mon` \u304c\u958b\u59cb\u3057\u305f\u65e8\u306e\u901a\u77e5\u304c\u9001\u3089\u308c\u3066\u304d\u307e\u3059\u304c\u3002\n", "tags": ["pacemaker", "corosync"]}