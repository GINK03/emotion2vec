{"tags": ["lambda", "AWS", "python2.7", "EC2", "CloudWatch"], "context": " More than 1 year has passed since last update.\n\n AWS Lambda?\n\n\u30b5\u30fc\u30d0\u30ec\u30b9\u3067\u30d7\u30ed\u30b0\u30e9\u30e0\u3092\u5b9f\u884c\u3067\u304d\u308b\u3088\u3046\u306a\u3082\u306e\n1 \u304b\u6708 1,000,000 \u30ea\u30af\u30a8\u30b9\u30c8\u306f\u7121\u6599\n\n\n\u4eca\u56de\u306e\u3088\u3046\u306a\uff11\u65e5\uff11\u56de\u52d5\u304b\u3059\u7a0b\u5ea6\u306a\u3089\u7121\u6599\u3067\u305a\u3063\u3068\u4f7f\u3048\u307e\u3059\n\n\n\u8a73\u3057\u304f\u306f \u2192 https://aws.amazon.com/jp/lambda/faqs/\n\n\n\n\u3084\u308a\u305f\u3044\u3053\u3068\n\nLambda\u306e\u30b9\u30b1\u30b8\u30e5\u30fc\u30eb\u30a4\u30d9\u30f3\u30c8\u3092\u4f7f\u3063\u3066\u81ea\u52d5\u7684\u306bEBS\u306e\u30b9\u30ca\u30c3\u30d7\u30b7\u30e7\u30c3\u30c8\u3092\u4f5c\u6210\u3059\u308b\n\n\n\u4eca\u56de\u4f7f\u7528\u3059\u308b\u8a00\u8a9e\u306fPython\n\n\n\u30b9\u30ca\u30c3\u30d7\u30b7\u30e7\u30c3\u30c8\u306e\u5bfe\u8c61\u306f\u3001EC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u30bf\u30b0\u306b\u300cBackup-Generation\u300d\u304c\u4ed8\u3044\u3066\u3044\u308b\u3082\u306e\u3068\u3059\u308b\n\n\nBackup-Generation\u306e\u5024\u306b\u306f\u30010\u4ee5\u4e0a\u306e\u6570\u5b57\u3092\u6307\u5b9a\u3059\u308b\n\n\n\u30b9\u30ca\u30c3\u30d7\u30b7\u30e7\u30c3\u30c8\u306e\u4fdd\u5b58\u4ef6\u6570\u306f\u3001Backup-Generation\u306e\u5024\u3068\u3059\u308b\n\n\n0\u306e\u3068\u304d\u306f\u30b9\u30ca\u30c3\u30d7\u30b7\u30e7\u30c3\u30c8\u3092\u4f5c\u6210\u3057\u306a\u3044\n\n\n\u30b9\u30ca\u30c3\u30d7\u30b7\u30e7\u30c3\u30c8\u306e\u4fdd\u5b58\u4ef6\u6570\u3092\u8d85\u3048\u305f\u5834\u5408\u306f\u3001\u4f5c\u6210\u65e5\u4ed8\u306e\u53e4\u3044\u3082\u306e\u304b\u3089\u524a\u9664\u3059\u308b\n\n\n\n\n\u4f5c\u6210\u3057\u305f\u30b9\u30ca\u30c3\u30d7\u30b7\u30e7\u30c3\u30c8\u306eDescription\u306b\u306f\u3001\u300cEBS\u30dc\u30ea\u30e5\u30fc\u30e0ID\u300d\u3068\u300cEC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u540d\u300d\u3092\u3064\u3051\u308b\n\n\nEC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u540d\u304c\u306a\u3044\u5834\u5408\u306f\u3001\u300cEBS\u30dc\u30ea\u30e5\u30fc\u30e0ID\u300d\u306e\u307f\u3092\u3064\u3051\u308b\n\n\n\u51e6\u7406\u304c\u5931\u6557\u3057\u305f\u5834\u5408\u306f\u3001CloudWatch\u306e\u76e3\u8996\u306b\u3088\u308a\u30e1\u30fc\u30eb\uff08SNS\uff09\u3092\u9001\u308b\n\n\nEC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306b\u540d\u524d\u3068\u30bf\u30b0\u3092\u3064\u3051\u308b\n\n\u540d\u524d\u3092\u3064\u3051\u308b\n\n\nEC2\u306e\u30da\u30fc\u30b8\u306e\u30b5\u30a4\u30c9\u30e1\u30cb\u30e5\u30fc\u304b\u3089\u300cInstances\u300d\u3092\u30af\u30ea\u30c3\u30af\n\u30ab\u30fc\u30bd\u30eb\u3092Name\u306e\u5217\u306b\u5408\u308f\u305b\u308b\u3068\u925b\u7b46\u30a2\u30a4\u30b3\u30f3\u304c\u8868\u793a\u3055\u308c\u308b\u306e\u3067\u30af\u30ea\u30c3\u30af\n\u540d\u524d\u3092\u5165\u529b\n\n\n\u30bf\u30b0\u3092\u3064\u3051\u308b\n\n\n\u5bfe\u8c61\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306b\u30c1\u30a7\u30c3\u30af\u3092\u3064\u3051\u308b\n\u300cTags\u300d\u30dc\u30bf\u30f3\u3092\u30af\u30ea\u30c3\u30af\n\u300cAdd/Edit Tags\u300d\u30dc\u30bf\u30f3\u3092\u30af\u30ea\u30c3\u30af\n\n\n\n\u300cCreate Tag\u300d\u30dc\u30bf\u30f3\u3092\u30af\u30ea\u30c3\u30af\nKey\u306b\u300cBackup-Generation\u300d\u3001Value\u306b\u4fdd\u5b58\u4ef6\u6570\u3092\u5165\u529b\n\u300cSave\u300d\u30dc\u30bf\u30f3\u3092\u30af\u30ea\u30c3\u30af\n\n\nLambda\u306e\u4f5c\u6210\n\nSelect blueprint\n\n\nLambda\u306e\u30da\u30fc\u30b8\u306e\u4f5c\u6210\u30dc\u30bf\u30f3\u3092\u30af\u30ea\u30c3\u30af\n\u300cPython2.7\u300d\u3092\u9078\u629e\n\u300chello-world-python\u300d\u3092\u30af\u30ea\u30c3\u30af\uff08\u52d5\u4f5c\u78ba\u8a8d\u5f8c\u306b\u30b9\u30b1\u30b8\u30e5\u30fc\u30eb\u30a4\u30d9\u30f3\u30c8\u3092\u8a2d\u5b9a\u3057\u305f\u3044\u305f\u3081\uff09\n\n\n\u203b\u300clambda-canary\u300d\u306f\u3044\u304d\u306a\u308a\u30b9\u30b1\u30b8\u30e5\u30fc\u30eb\u8a2d\u5b9a\u753b\u9762\u304b\u3089\u59cb\u307e\u308b\n\n\n\n\nConfigure function\n\n\nName\u3092\u5165\u529b\nDescription\u306f\u7a7a\u3067\u3082OK\n\n\nLambda function code\n\n\n\u4e0b\u8a18\u306e\u30b3\u30fc\u30c9\u3092\u8cbc\u308a\u4ed8\u3051\u308b\n\n\npython\nimport boto3\nimport collections\nimport time\nfrom botocore.client import ClientError\nec2 = boto3.client('ec2')\n\ndef lambda_handler(event, context):\n    descriptions = create_snapshots()\n    delete_old_snapshots(descriptions)\n\ndef create_snapshots():\n    instances = get_instances(['Backup-Generation'])\n\n    descriptions = {}\n\n    for i in instances:\n        tags = { t['Key']: t['Value'] for t in i['Tags'] }\n        generation = int( tags.get('Backup-Generation', 0) )\n\n        if generation < 1:\n            continue\n\n        for b in i['BlockDeviceMappings']:\n            if b.get('Ebs') is None:\n                continue\n\n            volume_id = b['Ebs']['VolumeId']\n            description = volume_id if tags.get('Name') is '' else '%s(%s)' % (volume_id, tags['Name'])\n            description = 'Auto Snapshot ' + description\n\n            snapshot = _create_snapshot(volume_id, description)\n            print 'create snapshot %s(%s)' % (snapshot['SnapshotId'], description)\n\n            descriptions[description] = generation\n\n    return descriptions\n\ndef get_instances(tag_names):\n    reservations = ec2.describe_instances(\n        Filters=[\n            {\n                'Name': 'tag-key',\n                'Values': tag_names\n            }\n        ]\n    )['Reservations']\n\n    return sum([\n        [i for i in r['Instances']]\n        for r in reservations\n    ], [])\n\ndef delete_old_snapshots(descriptions):\n    snapshots_descriptions = get_snapshots_descriptions(descriptions.keys())\n\n    for description, snapshots in snapshots_descriptions.items():\n        delete_count = len(snapshots) - descriptions[description]\n\n        if delete_count <= 0:\n            continue\n\n        snapshots.sort(key=lambda x:x['StartTime'])\n\n        old_snapshots = snapshots[0:delete_count]\n\n        for s in old_snapshots:\n            _delete_snapshot(s['SnapshotId'])\n            print 'delete snapshot %s(%s)' % (s['SnapshotId'], s['Description']) \n\ndef get_snapshots_descriptions(descriptions):\n    snapshots = ec2.describe_snapshots(\n        Filters=[\n            {\n                'Name': 'description',\n                'Values': descriptions,\n            }\n        ]\n    )['Snapshots']\n\n    groups = collections.defaultdict(lambda: [])\n    { groups[ s['Description'] ].append(s) for s in snapshots }\n\n    return groups\n\ndef _create_snapshot(id, description):\n    for i in range(1, 3):\n        try:\n            return ec2.create_snapshot(VolumeId=id,Description=description)\n        except ClientError as e:\n            print str(e)\n        time.sleep(1)\n    raise Exception('cannot create snapshot ' + description)\n\ndef _delete_snapshot(id):\n    for i in range(1, 3):\n        try:\n            return ec2.delete_snapshot(SnapshotId=id)\n        except ClientError as e:\n            print str(e)\n        time.sleep(1)\n    raise Exception('cannot delete snapshot ' + id)\n\n\n\nLambda function handler and role\n\n\n\u300cRole\u300d\u304b\u3089\u300cBasic execution role\u300d\u3092\u9078\u629e\n\n\nIAM Role\u306e\u4f5c\u6210\n\n\n\u300cRole Name\u300d\u3092\u5165\u529b\n\u300cView Policy Document\u300d\u3092\u30af\u30ea\u30c3\u30af\u3057\u30b3\u30fc\u30c9\u3092\u8868\u793a\u3055\u305b\u308b\n\u300cEdit\u300d\u3092\u30af\u30ea\u30c3\u30af\n\n\n\n\u300cOK\u300d\u30dc\u30bf\u30f3\u3092\u30af\u30ea\u30c3\u30af\n\u4e0b\u8a18\u306e\u30b3\u30fc\u30c9\u3092\u8cbc\u308a\u4ed8\u3051\n\u300cAllow\u300d\u30dc\u30bf\u30f3\u3092\u30af\u30ea\u30c3\u30af\n\n\niam.json\n{\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [\n        {\n            \"Effect\": \"Allow\",\n            \"Action\": [\n                \"logs:CreateLogGroup\",\n                \"logs:CreateLogStream\",\n                \"logs:PutLogEvents\"\n            ],\n            \"Resource\": [\n                \"arn:aws:logs:*:*:*\"\n            ]\n        },\n        {\n            \"Effect\": \"Allow\",\n            \"Action\": [\n                \"ec2:DescribeInstances\",\n                \"ec2:DescribeSnapshots\",\n                \"ec2:CreateSnapshot\",\n                \"ec2:DeleteSnapshot\"\n            ],\n            \"Resource\": [\n                \"*\"\n            ]\n        }\n    ]\n}\n\n\n\nAdvanced settings\n\n\nTimeout\u3092\u300c10 sec\u300d\u306b\u5909\u66f4\uff08\u203b\u52d5\u4f5c\u78ba\u8a8d\u306e\u300cDuration\u300d\u306e\u5024\u3092\u898b\u3066\u9069\u5b9c\u5909\u66f4\uff09\n\u300cNext\u300d\u30dc\u30bf\u30f3\u3092\u30af\u30ea\u30c3\u30af\n\u300cCreate function\u300d\u30dc\u30bf\u30f3\u3092\u30af\u30ea\u30c3\u30af\n\n\nLambda\u306e\u52d5\u4f5c\u78ba\u8a8d\n\n\n\u5de6\u4e0a\u306e\u300cTest\u300d\u30dc\u30bf\u30f3\u3092\u30af\u30ea\u30c3\u30af\nInput\u30c7\u30fc\u30bf\u306f\u4f7f\u308f\u306a\u3044\u306e\u3067\u305d\u306e\u307e\u307e\u300cSave and test\u300d\u3092\u30af\u30ea\u30c3\u30af\n\n\n\n\u52d5\u4f5c\u7d50\u679c\u306f\u30da\u30fc\u30b8\u6700\u4e0b\u90e8\u306b\u8868\u793a\u3055\u308c\u308b\n\n\nSummary\n\n\nDuration \u2026 \u5b9f\u884c\u6642\u9593\nBilled duration \u2026 \u8ab2\u91d1\u5bfe\u8c61\u6642\u9593\nMax memory used \u2026 \u30e1\u30e2\u30ea\u4f7f\u7528\u91cf\n\n\n\n\n\n\n\nLog output\u306e\u300cClick here\u300d\u3092\u30af\u30ea\u30c3\u30af\u3059\u308b\u3068CloudWatch\u30ed\u30b0\u306e\u753b\u9762\u304c\u8868\u793a\u3055\u308c\u308b\n\n\nLambda\u306e\u30b9\u30b1\u30b8\u30e5\u30fc\u30eb\u30a4\u30d9\u30f3\u30c8\u306e\u4f5c\u6210\n\n\u30b9\u30b1\u30b8\u30e5\u30fc\u30eb\u30a4\u30d9\u30f3\u30c8\u306e\u8ffd\u52a0\n\n\n\u300cEvent sources\u300d\u3092\u30af\u30ea\u30c3\u30af\n\u300cAdd event source\u300d\u3092\u30af\u30ea\u30c3\u30af\n\n\nAdd event source\n\n\nEvent source type\u304b\u3089\u300cScheduled Event\u300d\u3092\u9078\u629e\nName\u3092\u5165\u529b\nDescription\u306f\u7a7a\u3067\u3082OK\nschedule expression\u3092\u5165\u529b\u3000\u203b\u6642\u9593\u306fUTC\n\n\n\u53c2\u8003\u30b5\u30a4\u30c8\uff1a\u66f8\u304d\u65b9\u3001\u6642\u5dee\u8a08\u7b97\n\n\u4f8b\uff1e\u6bce\u65e5 03:10 (\u65e5\u672c\u6642\u9593\u306e\u6df1\u591c) \u306b\u8d77\u52d5\u3055\u305b\u305f\u3044\u5834\u5408\n\n\ncron(10 18 * * ? *)\n\n\n\n\n\u300cSubmit\u300d\u30dc\u30bf\u30f3\u3092\u30af\u30ea\u30c3\u30af\n\n\n\u51e6\u7406\u306e\u5931\u6557\u3092CloudWatch\u3067\u76e3\u8996\u3057\u3066SNS\u3067\u30e1\u30fc\u30eb\u3092\u9001\u308b\n\nCreate Alarm\n\n\nCloudWatch\u306e\u30da\u30fc\u30b8\u306e\u30b5\u30a4\u30c9\u30e1\u30cb\u30e5\u30fc\u304b\u3089\u300cAlarms\u300d\u3092\u30af\u30ea\u30c3\u30af\n\u300cCreate Alarm\u300d\u30dc\u30bf\u30f3\u3092\u30af\u30ea\u30c3\u30af\n\n\nSelect Metric-1\n\n\nLambda Metrics\u306e\u4e0b\u306e\u300cBy Function Name\u300d\u3092\u30af\u30ea\u30c3\u30af\n\n\nSelect Metric-2\n\n\nMetric Name\u304c\u300cErrors\u300d\u306b\u30c1\u30a7\u30c3\u30af\n\u300cNext\u300d\u30dc\u30bf\u30f3\u3092\u30af\u30ea\u30c3\u30af\n\n\nDefine Alarm\n\n\nAlarm Threshold\n\nName\u3092\u5165\u529b\nWhenever\u306eis\u3092\u300c>\u300d\u3092\u9078\u629e\n\n\nAlarm Preview\n\nPeriod\u3092\u300c1 Day\u300d\u3092\u9078\u629e\uff08\u203bLambda\u306e\u30b9\u30b1\u30b8\u30e5\u30fc\u30eb\u30a4\u30d9\u30f3\u30c8\u306e\u8a2d\u5b9a\u306b\u5408\u308f\u305b\u3066\u9069\u5b9c\u5909\u66f4\uff09\nStatistic\u3092\u300cSum\u300d\u3092\u9078\u629e\n\n\nActions\n\nSend notification to\u306e\u300cNew list\u300d\u3092\u30af\u30ea\u30c3\u30af\uff08\u203b\u65e2\u5b58\u306e\u901a\u77e5\u7528\u306eSNS\u304c\u3042\u308b\u5834\u5408\u306f\u305d\u308c\u3092\u9078\u629e\uff09\ntopic name\u3092\u5165\u529b\nEmail list\u306b\u901a\u77e5\u3059\u308b\u30e1\u30fc\u30eb\u30a2\u30c9\u30ec\u30b9\u3092\u5165\u529b\n\u300cCreate Alarm\u300d\u30dc\u30bf\u30f3\u3092\u30af\u30ea\u30c3\u30af\n\u627f\u8a8d\u30e1\u30fc\u30eb\u304c\u9001\u4fe1\u3055\u308c\u308b\u306e\u3067\u30e1\u30fc\u30eb\u672c\u6587\u306e\u300cConfirm subscription\u300d\u3092\u30af\u30ea\u30c3\u30af\n\n\n\u53c2\u8003\u30b5\u30a4\u30c8\n\nAWS Lambda \u306e\u30b9\u30b1\u30b8\u30e5\u30fc\u30eb\u30a4\u30d9\u30f3\u30c8\u3067\u5b9a\u671f\u7684\u306b RDS \u306e Snapshot \u3092\u4f5c\u6210\u3059\u308b\nScheduling EBS Snapshots\nBboto3 Docs EC2\n\n![Compute_Lambda.png](https://qiita-image-store.s3.amazonaws.com/0/69627/edc6afc8-201d-cfbb-cfe6-ef9d35df63be.png) AWS Lambda?\n----\n- \u30b5\u30fc\u30d0\u30ec\u30b9\u3067\u30d7\u30ed\u30b0\u30e9\u30e0\u3092\u5b9f\u884c\u3067\u304d\u308b\u3088\u3046\u306a\u3082\u306e\n- 1 \u304b\u6708 1,000,000 \u30ea\u30af\u30a8\u30b9\u30c8\u306f\u7121\u6599\n    - \u4eca\u56de\u306e\u3088\u3046\u306a\uff11\u65e5\uff11\u56de\u52d5\u304b\u3059\u7a0b\u5ea6\u306a\u3089\u7121\u6599\u3067\u305a\u3063\u3068\u4f7f\u3048\u307e\u3059\n- \u8a73\u3057\u304f\u306f \u2192 https://aws.amazon.com/jp/lambda/faqs/\n\n\n\u3084\u308a\u305f\u3044\u3053\u3068\n-----\n- Lambda\u306e\u30b9\u30b1\u30b8\u30e5\u30fc\u30eb\u30a4\u30d9\u30f3\u30c8\u3092\u4f7f\u3063\u3066\u81ea\u52d5\u7684\u306bEBS\u306e\u30b9\u30ca\u30c3\u30d7\u30b7\u30e7\u30c3\u30c8\u3092\u4f5c\u6210\u3059\u308b\n    - \u4eca\u56de\u4f7f\u7528\u3059\u308b\u8a00\u8a9e\u306fPython\n- \u30b9\u30ca\u30c3\u30d7\u30b7\u30e7\u30c3\u30c8\u306e\u5bfe\u8c61\u306f\u3001EC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u30bf\u30b0\u306b\u300cBackup-Generation\u300d\u304c\u4ed8\u3044\u3066\u3044\u308b\u3082\u306e\u3068\u3059\u308b\n    - Backup-Generation\u306e\u5024\u306b\u306f\u30010\u4ee5\u4e0a\u306e\u6570\u5b57\u3092\u6307\u5b9a\u3059\u308b\n        - \u30b9\u30ca\u30c3\u30d7\u30b7\u30e7\u30c3\u30c8\u306e\u4fdd\u5b58\u4ef6\u6570\u306f\u3001Backup-Generation\u306e\u5024\u3068\u3059\u308b\n            - 0\u306e\u3068\u304d\u306f\u30b9\u30ca\u30c3\u30d7\u30b7\u30e7\u30c3\u30c8\u3092\u4f5c\u6210\u3057\u306a\u3044\n        - \u30b9\u30ca\u30c3\u30d7\u30b7\u30e7\u30c3\u30c8\u306e\u4fdd\u5b58\u4ef6\u6570\u3092\u8d85\u3048\u305f\u5834\u5408\u306f\u3001\u4f5c\u6210\u65e5\u4ed8\u306e\u53e4\u3044\u3082\u306e\u304b\u3089\u524a\u9664\u3059\u308b\n- \u4f5c\u6210\u3057\u305f\u30b9\u30ca\u30c3\u30d7\u30b7\u30e7\u30c3\u30c8\u306eDescription\u306b\u306f\u3001\u300cEBS\u30dc\u30ea\u30e5\u30fc\u30e0ID\u300d\u3068\u300cEC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u540d\u300d\u3092\u3064\u3051\u308b\n    - EC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u540d\u304c\u306a\u3044\u5834\u5408\u306f\u3001\u300cEBS\u30dc\u30ea\u30e5\u30fc\u30e0ID\u300d\u306e\u307f\u3092\u3064\u3051\u308b\n- \u51e6\u7406\u304c\u5931\u6557\u3057\u305f\u5834\u5408\u306f\u3001CloudWatch\u306e\u76e3\u8996\u306b\u3088\u308a\u30e1\u30fc\u30eb\uff08SNS\uff09\u3092\u9001\u308b\n\nEC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306b\u540d\u524d\u3068\u30bf\u30b0\u3092\u3064\u3051\u308b\n-----------------\n\n### \u540d\u524d\u3092\u3064\u3051\u308b\n\n![\u540d\u524d\u3092\u3064\u3051\u308b](https://qiita-image-store.s3.amazonaws.com/0/69627/313727ed-d653-8059-c0b0-c2ab6ad52c72.png)\n\n1. EC2\u306e\u30da\u30fc\u30b8\u306e\u30b5\u30a4\u30c9\u30e1\u30cb\u30e5\u30fc\u304b\u3089\u300cInstances\u300d\u3092\u30af\u30ea\u30c3\u30af\n2. \u30ab\u30fc\u30bd\u30eb\u3092Name\u306e\u5217\u306b\u5408\u308f\u305b\u308b\u3068\u925b\u7b46\u30a2\u30a4\u30b3\u30f3\u304c\u8868\u793a\u3055\u308c\u308b\u306e\u3067\u30af\u30ea\u30c3\u30af\n3. \u540d\u524d\u3092\u5165\u529b\n\n### \u30bf\u30b0\u3092\u3064\u3051\u308b\n\n![\u30bf\u30b0\u3092\u8ffd\u52a0](https://qiita-image-store.s3.amazonaws.com/0/69627/a584af20-59a8-55f4-ac10-3ebcba69420b.png)\n\n1. \u5bfe\u8c61\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306b\u30c1\u30a7\u30c3\u30af\u3092\u3064\u3051\u308b\n2. \u300cTags\u300d\u30dc\u30bf\u30f3\u3092\u30af\u30ea\u30c3\u30af\n3. \u300cAdd/Edit Tags\u300d\u30dc\u30bf\u30f3\u3092\u30af\u30ea\u30c3\u30af\n\n![\u30bf\u30b0\u3092\u8ffd\u52a0](https://qiita-image-store.s3.amazonaws.com/0/69627/154e75d2-3779-1c90-2f56-769f603ab610.png)\n\n1. \u300cCreate Tag\u300d\u30dc\u30bf\u30f3\u3092\u30af\u30ea\u30c3\u30af\n2. Key\u306b\u300cBackup-Generation\u300d\u3001Value\u306b\u4fdd\u5b58\u4ef6\u6570\u3092\u5165\u529b\n3. \u300cSave\u300d\u30dc\u30bf\u30f3\u3092\u30af\u30ea\u30c3\u30af\n\nLambda\u306e\u4f5c\u6210\n----------\n### Select blueprint\n\n![Select blueprint](https://qiita-image-store.s3.amazonaws.com/0/69627/66033598-8929-46b4-bbf4-f548374c3400.png)\n\n1. Lambda\u306e\u30da\u30fc\u30b8\u306e\u4f5c\u6210\u30dc\u30bf\u30f3\u3092\u30af\u30ea\u30c3\u30af\n2. \u300cPython2.7\u300d\u3092\u9078\u629e\n3. \u300chello-world-python\u300d\u3092\u30af\u30ea\u30c3\u30af\uff08\u52d5\u4f5c\u78ba\u8a8d\u5f8c\u306b\u30b9\u30b1\u30b8\u30e5\u30fc\u30eb\u30a4\u30d9\u30f3\u30c8\u3092\u8a2d\u5b9a\u3057\u305f\u3044\u305f\u3081\uff09\n    - \u203b\u300clambda-canary\u300d\u306f\u3044\u304d\u306a\u308a\u30b9\u30b1\u30b8\u30e5\u30fc\u30eb\u8a2d\u5b9a\u753b\u9762\u304b\u3089\u59cb\u307e\u308b\n\n### Configure function\n\n![Configure function](https://qiita-image-store.s3.amazonaws.com/0/69627/116cfcf7-8fae-4690-6909-056a3e088e86.png)\n\n1. Name\u3092\u5165\u529b\n2. Description\u306f\u7a7a\u3067\u3082OK\n\n### Lambda function code\n\n![Lambda function code](https://qiita-image-store.s3.amazonaws.com/0/69627/92fbb5f1-5a9a-1faa-f513-eb9a8952e6cb.png)\n\n1. \u4e0b\u8a18\u306e\u30b3\u30fc\u30c9\u3092\u8cbc\u308a\u4ed8\u3051\u308b\n\n```py:python \nimport boto3\nimport collections\nimport time\nfrom botocore.client import ClientError\nec2 = boto3.client('ec2')\n\ndef lambda_handler(event, context):\n    descriptions = create_snapshots()\n    delete_old_snapshots(descriptions)\n\ndef create_snapshots():\n    instances = get_instances(['Backup-Generation'])\n\n    descriptions = {}\n\n    for i in instances:\n        tags = { t['Key']: t['Value'] for t in i['Tags'] }\n        generation = int( tags.get('Backup-Generation', 0) )\n\n        if generation < 1:\n            continue\n\n        for b in i['BlockDeviceMappings']:\n            if b.get('Ebs') is None:\n                continue\n\n            volume_id = b['Ebs']['VolumeId']\n            description = volume_id if tags.get('Name') is '' else '%s(%s)' % (volume_id, tags['Name'])\n            description = 'Auto Snapshot ' + description\n\n            snapshot = _create_snapshot(volume_id, description)\n            print 'create snapshot %s(%s)' % (snapshot['SnapshotId'], description)\n\n            descriptions[description] = generation\n\n    return descriptions\n\ndef get_instances(tag_names):\n    reservations = ec2.describe_instances(\n        Filters=[\n            {\n                'Name': 'tag-key',\n                'Values': tag_names\n            }\n        ]\n    )['Reservations']\n\n    return sum([\n        [i for i in r['Instances']]\n        for r in reservations\n    ], [])\n\ndef delete_old_snapshots(descriptions):\n    snapshots_descriptions = get_snapshots_descriptions(descriptions.keys())\n\n    for description, snapshots in snapshots_descriptions.items():\n        delete_count = len(snapshots) - descriptions[description]\n\n        if delete_count <= 0:\n            continue\n\n        snapshots.sort(key=lambda x:x['StartTime'])\n\n        old_snapshots = snapshots[0:delete_count]\n\n        for s in old_snapshots:\n            _delete_snapshot(s['SnapshotId'])\n            print 'delete snapshot %s(%s)' % (s['SnapshotId'], s['Description']) \n\ndef get_snapshots_descriptions(descriptions):\n    snapshots = ec2.describe_snapshots(\n        Filters=[\n            {\n                'Name': 'description',\n                'Values': descriptions,\n            }\n        ]\n    )['Snapshots']\n\n    groups = collections.defaultdict(lambda: [])\n    { groups[ s['Description'] ].append(s) for s in snapshots }\n\n    return groups\n\ndef _create_snapshot(id, description):\n    for i in range(1, 3):\n        try:\n            return ec2.create_snapshot(VolumeId=id,Description=description)\n        except ClientError as e:\n            print str(e)\n        time.sleep(1)\n    raise Exception('cannot create snapshot ' + description)\n\ndef _delete_snapshot(id):\n    for i in range(1, 3):\n        try:\n            return ec2.delete_snapshot(SnapshotId=id)\n        except ClientError as e:\n            print str(e)\n        time.sleep(1)\n    raise Exception('cannot delete snapshot ' + id)\n```\n\n### Lambda function handler and role\n\n![Lambda function handler and role](https://qiita-image-store.s3.amazonaws.com/0/69627/138683b6-d3fa-c4f9-25c2-ea137d579935.png)\n\n1. \u300cRole\u300d\u304b\u3089\u300cBasic execution role\u300d\u3092\u9078\u629e\n\n### IAM Role\u306e\u4f5c\u6210\n\n![IAM Role\u306e\u4f5c\u6210](https://qiita-image-store.s3.amazonaws.com/0/69627/c42bc0bf-28b5-8486-5e48-48a36135abc4.png)\n\n1. \u300cRole Name\u300d\u3092\u5165\u529b\n2. \u300cView Policy Document\u300d\u3092\u30af\u30ea\u30c3\u30af\u3057\u30b3\u30fc\u30c9\u3092\u8868\u793a\u3055\u305b\u308b\n3. \u300cEdit\u300d\u3092\u30af\u30ea\u30c3\u30af\n\n![confirm](https://qiita-image-store.s3.amazonaws.com/0/69627/8a248aaa-c523-e546-31bd-70bdde11de5f.png)\n\n4. \u300cOK\u300d\u30dc\u30bf\u30f3\u3092\u30af\u30ea\u30c3\u30af\n5. \u4e0b\u8a18\u306e\u30b3\u30fc\u30c9\u3092\u8cbc\u308a\u4ed8\u3051\n6. \u300cAllow\u300d\u30dc\u30bf\u30f3\u3092\u30af\u30ea\u30c3\u30af\n\n```json:iam.json\n{\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [\n        {\n            \"Effect\": \"Allow\",\n            \"Action\": [\n                \"logs:CreateLogGroup\",\n                \"logs:CreateLogStream\",\n                \"logs:PutLogEvents\"\n            ],\n            \"Resource\": [\n                \"arn:aws:logs:*:*:*\"\n            ]\n        },\n        {\n            \"Effect\": \"Allow\",\n            \"Action\": [\n                \"ec2:DescribeInstances\",\n                \"ec2:DescribeSnapshots\",\n                \"ec2:CreateSnapshot\",\n                \"ec2:DeleteSnapshot\"\n            ],\n            \"Resource\": [\n                \"*\"\n            ]\n        }\n    ]\n}\n```\n\n\n### Advanced settings\n\n![Advanced settings](https://qiita-image-store.s3.amazonaws.com/0/69627/ebfe8c35-5fde-5e29-591f-fe50912c5958.png)\n\n1. Timeout\u3092\u300c10 sec\u300d\u306b\u5909\u66f4\uff08\u203b\u52d5\u4f5c\u78ba\u8a8d\u306e\u300cDuration\u300d\u306e\u5024\u3092\u898b\u3066\u9069\u5b9c\u5909\u66f4\uff09\n2. \u300cNext\u300d\u30dc\u30bf\u30f3\u3092\u30af\u30ea\u30c3\u30af\n3. \u300cCreate function\u300d\u30dc\u30bf\u30f3\u3092\u30af\u30ea\u30c3\u30af\n\nLambda\u306e\u52d5\u4f5c\u78ba\u8a8d\n-----------\n![Test](https://qiita-image-store.s3.amazonaws.com/0/69627/e2db4dc7-ba11-3ecf-48cd-b58f64f6d817.png)\n\n1. \u5de6\u4e0a\u306e\u300cTest\u300d\u30dc\u30bf\u30f3\u3092\u30af\u30ea\u30c3\u30af\n2. Input\u30c7\u30fc\u30bf\u306f\u4f7f\u308f\u306a\u3044\u306e\u3067\u305d\u306e\u307e\u307e\u300cSave and test\u300d\u3092\u30af\u30ea\u30c3\u30af\n\n![result](https://qiita-image-store.s3.amazonaws.com/0/69627/dc6150be-b70f-21d9-30dd-35d84e550438.png)\n\n2. \u52d5\u4f5c\u7d50\u679c\u306f\u30da\u30fc\u30b8\u6700\u4e0b\u90e8\u306b\u8868\u793a\u3055\u308c\u308b\n    - Summary\n        - Duration \u2026 \u5b9f\u884c\u6642\u9593\n        - Billed duration \u2026 \u8ab2\u91d1\u5bfe\u8c61\u6642\u9593\n        - Max memory used \u2026 \u30e1\u30e2\u30ea\u4f7f\u7528\u91cf\n\n![CloudWatch](https://qiita-image-store.s3.amazonaws.com/0/69627/7fed4ee0-2273-f2e3-7b7b-ffc69e4ada0b.png)\n\n\n3. Log output\u306e\u300cClick here\u300d\u3092\u30af\u30ea\u30c3\u30af\u3059\u308b\u3068CloudWatch\u30ed\u30b0\u306e\u753b\u9762\u304c\u8868\u793a\u3055\u308c\u308b\n\nLambda\u306e\u30b9\u30b1\u30b8\u30e5\u30fc\u30eb\u30a4\u30d9\u30f3\u30c8\u306e\u4f5c\u6210\n-----------------------------\n### \u30b9\u30b1\u30b8\u30e5\u30fc\u30eb\u30a4\u30d9\u30f3\u30c8\u306e\u8ffd\u52a0\n\n![\u30b9\u30b1\u30b8\u30e5\u30fc\u30eb\u30a4\u30d9\u30f3\u30c8\u306e\u8ffd\u52a0](https://qiita-image-store.s3.amazonaws.com/0/69627/e7a67410-1c64-286a-0652-3cd9d00788c8.png)\n\n1. \u300cEvent sources\u300d\u3092\u30af\u30ea\u30c3\u30af\n2. \u300cAdd event source\u300d\u3092\u30af\u30ea\u30c3\u30af\n\n### Add event source\n\n![Add event source](https://qiita-image-store.s3.amazonaws.com/0/69627/3f55baf7-dbda-db98-6b81-85018a2dd5fe.png)\n\n1. Event source type\u304b\u3089\u300cScheduled Event\u300d\u3092\u9078\u629e\n2. Name\u3092\u5165\u529b\n3. Description\u306f\u7a7a\u3067\u3082OK\n4. schedule expression\u3092\u5165\u529b\u3000\u203b\u6642\u9593\u306fUTC\n    - \u53c2\u8003\u30b5\u30a4\u30c8\uff1a[\u66f8\u304d\u65b9](https://docs.aws.amazon.com/ja_jp/lambda/latest/dg/getting-started-scheduled-events.html)\u3001[\u6642\u5dee\u8a08\u7b97](http://www.jisakeisan.info/)\n    - \u4f8b\uff1e\u6bce\u65e5 03:10 (\u65e5\u672c\u6642\u9593\u306e\u6df1\u591c) \u306b\u8d77\u52d5\u3055\u305b\u305f\u3044\u5834\u5408\n        - cron(10 18 * * ? *)\n5. \u300cSubmit\u300d\u30dc\u30bf\u30f3\u3092\u30af\u30ea\u30c3\u30af\n\n\u51e6\u7406\u306e\u5931\u6557\u3092CloudWatch\u3067\u76e3\u8996\u3057\u3066SNS\u3067\u30e1\u30fc\u30eb\u3092\u9001\u308b\n-----------------------------\n### Create Alarm\n\n![Create Alarm](https://qiita-image-store.s3.amazonaws.com/0/69627/210b7da7-d5ea-a5c5-0806-ea05045c0273.png)\n\n1. CloudWatch\u306e\u30da\u30fc\u30b8\u306e\u30b5\u30a4\u30c9\u30e1\u30cb\u30e5\u30fc\u304b\u3089\u300cAlarms\u300d\u3092\u30af\u30ea\u30c3\u30af\n2. \u300cCreate Alarm\u300d\u30dc\u30bf\u30f3\u3092\u30af\u30ea\u30c3\u30af\n\n### Select Metric-1\n\n![Select Metric-1](https://qiita-image-store.s3.amazonaws.com/0/69627/3d7f53aa-fc30-8e8c-b84e-6caeeabff96f.png)\n\n1. Lambda Metrics\u306e\u4e0b\u306e\u300cBy Function Name\u300d\u3092\u30af\u30ea\u30c3\u30af\n\n### Select Metric-2\n\n![Select Metric-2](https://qiita-image-store.s3.amazonaws.com/0/69627/85800e94-9b4b-3b6d-ca52-17493ad22359.png)\n\n1. Metric Name\u304c\u300cErrors\u300d\u306b\u30c1\u30a7\u30c3\u30af\n2. \u300cNext\u300d\u30dc\u30bf\u30f3\u3092\u30af\u30ea\u30c3\u30af\n\n### Define Alarm\n\n![Define Alarm](https://qiita-image-store.s3.amazonaws.com/0/69627/ce0063a2-c381-edf6-0769-26032ba5128d.png)\n\n#### Alarm Threshold\n1. Name\u3092\u5165\u529b\n2. Whenever\u306eis\u3092\u300c>\u300d\u3092\u9078\u629e\n\n#### Alarm Preview\n1. Period\u3092\u300c1 Day\u300d\u3092\u9078\u629e\uff08\u203bLambda\u306e\u30b9\u30b1\u30b8\u30e5\u30fc\u30eb\u30a4\u30d9\u30f3\u30c8\u306e\u8a2d\u5b9a\u306b\u5408\u308f\u305b\u3066\u9069\u5b9c\u5909\u66f4\uff09\n2. Statistic\u3092\u300cSum\u300d\u3092\u9078\u629e\n\n#### Actions\n1. Send notification to\u306e\u300cNew list\u300d\u3092\u30af\u30ea\u30c3\u30af\uff08\u203b\u65e2\u5b58\u306e\u901a\u77e5\u7528\u306eSNS\u304c\u3042\u308b\u5834\u5408\u306f\u305d\u308c\u3092\u9078\u629e\uff09\n2. topic name\u3092\u5165\u529b\n3. Email list\u306b\u901a\u77e5\u3059\u308b\u30e1\u30fc\u30eb\u30a2\u30c9\u30ec\u30b9\u3092\u5165\u529b\n4. \u300cCreate Alarm\u300d\u30dc\u30bf\u30f3\u3092\u30af\u30ea\u30c3\u30af\n5. \u627f\u8a8d\u30e1\u30fc\u30eb\u304c\u9001\u4fe1\u3055\u308c\u308b\u306e\u3067\u30e1\u30fc\u30eb\u672c\u6587\u306e\u300cConfirm subscription\u300d\u3092\u30af\u30ea\u30c3\u30af\n\n\u53c2\u8003\u30b5\u30a4\u30c8\n---------\n- [AWS Lambda \u306e\u30b9\u30b1\u30b8\u30e5\u30fc\u30eb\u30a4\u30d9\u30f3\u30c8\u3067\u5b9a\u671f\u7684\u306b RDS \u306e Snapshot \u3092\u4f5c\u6210\u3059\u308b](http://tkuchiki.hatenablog.com/entry/2015/11/06/124113)\n- [Scheduling EBS Snapshots](https://serverlesscode.com/post/lambda-schedule-ebs-snapshot-backups/)\n- [Bboto3 Docs EC2](http://boto3.readthedocs.org/en/latest/reference/services/ec2.html)\n"}