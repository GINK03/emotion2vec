{"context": "\n\n\u4e8b\u524d\u6e96\u5099\n\nMattermost\u306b\u3066webhooks-incoming\u3092\u751f\u6210\n\u304a\u5929\u6c17\u60c5\u5831\u3054\u63d0\u4f9b\u30b5\u30a4\u30c8\u69d8\u304b\u3089\u5bfe\u5fdc\u3059\u308b\u90fd\u9053\u5e9c\u770c\u306eURL\uff08XML\uff09\u3092\u53d6\u5f97\n\n\n\u30b3\u30fc\u30c9\n\nweather_post_to_mattemost.php\n<?php\ndefine('IN_WEB_HOOK_URL', '\u2460');//\u4e8b\u524d\u6e96\u5099\u306ewebhooks-incoming\u3092\u6307\u5b9a\ndefine('WEATHER_INF_URL', '\u2461');//\u4e8b\u524d\u6e96\u5099\u306e\u304a\u5929\u6c17URL(XML)\u3092\u6307\u5b9a\n\n$body = create_wether_markdown();\npost_to_mattermost($body);\n\n$body = \"1\u9031\u9593\u306e\u304a\u5929\u6c17\u60c5\u5831\u3067\u3059\u3002\u672c\u65e5\u3082\uff11\u65e5\u9811\u5f35\u308a\u307e\u3057\u3087\u3046 :smile:\";\npost_to_mattermost($body);\n\n/**\n * \u5929\u6c17api\u3092\u53e9\u304d markdown \u3092\u69cb\u7bc9\u3059\u308b\n */\nfunction create_wether_markdown()\n{\n    $weather_xml = simplexml_load_file(WEATHER_INF_URL);\n\n    $body  = \"|\u65e5\u4ed8|\u5929\u6c17|\u6c17\u6e29\uff08\u6700\u9ad8-\u6700\u4f4e\uff09|\u964d\u6c34\u78ba\u7387\uff080\u6642-6\u6642-12\u6642-18\u6642\uff09|\\n\";\n    $body .= \"|:--|\\n\";\n\n    //$weather_xml->pref->area[n] \u30a8\u30ea\u30a2\u304c\u8907\u6570\u3042\u308b\u5834\u5408\u306fn\u3092\u9069\u5b9c\u5909\u66f4(n=0,1,2\u30fb\u30fb\u30fb)\n    //$body .= \"| 2017/03/05\uff08\u65e5\uff09 | \u203b\u5929\u6c17\u306b\u5bfe\u5fdc\u3059\u308b\u7d75\u6587\u5b57 | 14-4 | 0-0-10-10 |\\n\";\n    foreach($weather_xml->pref->area[0]->info as $key => $value) {\n        $t_range = $value->temperature->range;\n        $period  = $value->rainfallchance->period;\n        $body .= sprintf( \"| %s | %s | %s | %s |\\n\",\n                        $value->attributes()[0] . _get_week_day($value->attributes()[0]),\n                        _convert_weather_to_emoji($value->weather),\n                        $t_range[0].\"-\".$t_range[1],\n                        $period[0].\"-\".$period[1].\"-\".$period[2].\"-\".$period[3]\n                        );\n    }\n    return $body;\n}\n\n/**\n * \u6307\u5b9a\u3055\u308c\u305f\u5e74\u6708\u65e5(yyyy/mm/dd)\u304b\u3089\u66dc\u65e5\u3092\u6c42\u3081\u3066\u8fd4\u3059\n */\nfunction _get_week_day($yyyymmdd)\n{    \n    $datetime = new DateTime($yyyymmdd);\n    $week = array(\"(\u65e5)\", \"(\u6708)\", \"(\u706b)\", \"(\u6c34)\", \"(\u6728)\", \"(\u91d1)\", \"(\u571f)\");\n    $w = (int)$datetime->format('w');\n    return $week[$w];\n}\n\n/**\n * \u5929\u6c17\u7d50\u679c\u6587\u5b57\u5217\u304b\u3089\u7d75\u6587\u5b57\u306b\u5909\u63db\u3057\u3066\u8fd4\u3059\n */\nfunction _convert_weather_to_emoji($val)\n{\n    // \u7d75\u6587\u5b57\u4e00\u89a7\n    // http://www.webpagefx.com/tools/emoji-cheat-sheet/\n    // \u96ea\uff08:snowman:\uff09\n    // \u96e8\uff08:umbrella:\uff09\n    // \u66c7\u308a\uff08:cloud:\uff09\n    // \u6674\u308c\uff08:sunny:\uff09\n    if(strpos($val,'\u96ea') !== false){\n        //'\u96ea'\u304c\u542b\u307e\u308c\u3066\u3044\u308b\u5834\u5408\n        return \":snowman:\";\n    }\n    if(strpos($val,'\u96e8') !== false){\n        //'\u96e8'\u304c\u542b\u307e\u308c\u3066\u3044\u308b\u5834\u5408\n        return \":umbrella:\";\n    }\n    if(strpos($val,'\u304f\u3082\u308a') !== false){\n        //'\u304f\u3082\u308a'\u304c\u542b\u307e\u308c\u3066\u3044\u308b\u5834\u5408\n        return \":cloud:\";\n    }\n    return \":sunny:\"; //\u305d\u308c\u4ee5\u5916\u306f\u6674\u308c\u306b\u3057\u3068\u304f\n}\n\n/**\n * Mattermost\u3078\u30ea\u30af\u30a8\u30b9\u30c8\n */\nfunction post_to_mattermost($body)\n{\n    $payload = 'payload={\"text\": \"';\n    $payload .= str_replace('\"', '\\\"', $body);\n    $payload .= '\"}';\n\n    $ch = curl_init();\n    curl_setopt($ch, CURLOPT_URL, IN_WEB_HOOK_URL);\n    curl_setopt($ch, CURLOPT_POST, 1);\n    curl_setopt($ch, CURLOPT_POSTFIELDS, $payload);\n    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);\n    $server_output = curl_exec ($ch);\n    curl_close($ch);\n}\n?>\n\n\n\n\u53c2\u8003\u30b5\u30a4\u30c8URL\nhttps://docs.mattermost.com/developer/webhooks-incoming.html\nhttp://www.drk7.jp/weather/\n#\u4e8b\u524d\u6e96\u5099\n- Mattermost\u306b\u3066webhooks-incoming\u3092\u751f\u6210\n- \u304a\u5929\u6c17\u60c5\u5831\u3054\u63d0\u4f9b\u30b5\u30a4\u30c8\u69d8\u304b\u3089\u5bfe\u5fdc\u3059\u308b\u90fd\u9053\u5e9c\u770c\u306eURL\uff08XML\uff09\u3092\u53d6\u5f97\n\n#\u30b3\u30fc\u30c9\n```php:weather_post_to_mattemost.php\n<?php\ndefine('IN_WEB_HOOK_URL', '\u2460');//\u4e8b\u524d\u6e96\u5099\u306ewebhooks-incoming\u3092\u6307\u5b9a\ndefine('WEATHER_INF_URL', '\u2461');//\u4e8b\u524d\u6e96\u5099\u306e\u304a\u5929\u6c17URL(XML)\u3092\u6307\u5b9a\n\n$body = create_wether_markdown();\npost_to_mattermost($body);\n\n$body = \"1\u9031\u9593\u306e\u304a\u5929\u6c17\u60c5\u5831\u3067\u3059\u3002\u672c\u65e5\u3082\uff11\u65e5\u9811\u5f35\u308a\u307e\u3057\u3087\u3046 :smile:\";\npost_to_mattermost($body);\n\n/**\n * \u5929\u6c17api\u3092\u53e9\u304d markdown \u3092\u69cb\u7bc9\u3059\u308b\n */\nfunction create_wether_markdown()\n{\n    $weather_xml = simplexml_load_file(WEATHER_INF_URL);\n\n    $body  = \"|\u65e5\u4ed8|\u5929\u6c17|\u6c17\u6e29\uff08\u6700\u9ad8-\u6700\u4f4e\uff09|\u964d\u6c34\u78ba\u7387\uff080\u6642-6\u6642-12\u6642-18\u6642\uff09|\\n\";\n    $body .= \"|:--|\\n\";\n    \n    //$weather_xml->pref->area[n] \u30a8\u30ea\u30a2\u304c\u8907\u6570\u3042\u308b\u5834\u5408\u306fn\u3092\u9069\u5b9c\u5909\u66f4(n=0,1,2\u30fb\u30fb\u30fb)\n    //$body .= \"| 2017/03/05\uff08\u65e5\uff09 | \u203b\u5929\u6c17\u306b\u5bfe\u5fdc\u3059\u308b\u7d75\u6587\u5b57 | 14-4 | 0-0-10-10 |\\n\";\n    foreach($weather_xml->pref->area[0]->info as $key => $value) {\n        $t_range = $value->temperature->range;\n        $period  = $value->rainfallchance->period;\n        $body .= sprintf( \"| %s | %s | %s | %s |\\n\",\n                        $value->attributes()[0] . _get_week_day($value->attributes()[0]),\n                        _convert_weather_to_emoji($value->weather),\n                        $t_range[0].\"-\".$t_range[1],\n                        $period[0].\"-\".$period[1].\"-\".$period[2].\"-\".$period[3]\n                        );\n    }\n    return $body;\n}\n\n/**\n * \u6307\u5b9a\u3055\u308c\u305f\u5e74\u6708\u65e5(yyyy/mm/dd)\u304b\u3089\u66dc\u65e5\u3092\u6c42\u3081\u3066\u8fd4\u3059\n */\nfunction _get_week_day($yyyymmdd)\n{    \n    $datetime = new DateTime($yyyymmdd);\n    $week = array(\"(\u65e5)\", \"(\u6708)\", \"(\u706b)\", \"(\u6c34)\", \"(\u6728)\", \"(\u91d1)\", \"(\u571f)\");\n    $w = (int)$datetime->format('w');\n    return $week[$w];\n}\n\n/**\n * \u5929\u6c17\u7d50\u679c\u6587\u5b57\u5217\u304b\u3089\u7d75\u6587\u5b57\u306b\u5909\u63db\u3057\u3066\u8fd4\u3059\n */\nfunction _convert_weather_to_emoji($val)\n{\n    // \u7d75\u6587\u5b57\u4e00\u89a7\n    // http://www.webpagefx.com/tools/emoji-cheat-sheet/\n    // \u96ea\uff08:snowman:\uff09\n    // \u96e8\uff08:umbrella:\uff09\n    // \u66c7\u308a\uff08:cloud:\uff09\n    // \u6674\u308c\uff08:sunny:\uff09\n    if(strpos($val,'\u96ea') !== false){\n        //'\u96ea'\u304c\u542b\u307e\u308c\u3066\u3044\u308b\u5834\u5408\n        return \":snowman:\";\n    }\n    if(strpos($val,'\u96e8') !== false){\n        //'\u96e8'\u304c\u542b\u307e\u308c\u3066\u3044\u308b\u5834\u5408\n        return \":umbrella:\";\n    }\n    if(strpos($val,'\u304f\u3082\u308a') !== false){\n        //'\u304f\u3082\u308a'\u304c\u542b\u307e\u308c\u3066\u3044\u308b\u5834\u5408\n        return \":cloud:\";\n    }\n    return \":sunny:\"; //\u305d\u308c\u4ee5\u5916\u306f\u6674\u308c\u306b\u3057\u3068\u304f\n}\n\n/**\n * Mattermost\u3078\u30ea\u30af\u30a8\u30b9\u30c8\n */\nfunction post_to_mattermost($body)\n{\n    $payload = 'payload={\"text\": \"';\n    $payload .= str_replace('\"', '\\\"', $body);\n    $payload .= '\"}';\n\n    $ch = curl_init();\n    curl_setopt($ch, CURLOPT_URL, IN_WEB_HOOK_URL);\n    curl_setopt($ch, CURLOPT_POST, 1);\n    curl_setopt($ch, CURLOPT_POSTFIELDS, $payload);\n    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);\n    $server_output = curl_exec ($ch);\n    curl_close($ch);\n}\n?>\n```\n\n#\u53c2\u8003\u30b5\u30a4\u30c8URL\nhttps://docs.mattermost.com/developer/webhooks-incoming.html\nhttp://www.drk7.jp/weather/\n", "tags": ["Mattermost", "PHP"]}