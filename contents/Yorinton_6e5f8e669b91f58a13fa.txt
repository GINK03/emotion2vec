{"context": "\u4ee5\u4e0b\u306e\u8a18\u4e8b\u3092\u53c2\u7167\u3057\u3066\u51fa\u6765\u305f\nhttp://chaika.hatenablog.com/entry/2014/04/12/001012\n\nmanage.php\n$('#upload').click(function(){\n\n    //\u30d5\u30a9\u30fc\u30e0\u306e\u30c7\u30fc\u30bf\u3092\u5909\u6570form\u306b\u683c\u7d0d\n    var form = $('#listing_image_form').get()[0];\n\n    //FormData \u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u4f5c\u6210\n    var formData = new FormData( form );\n\n    $.ajax({//\u9001\u308b\u30c7\u30fc\u30bf\n        url:'listing_manage_save.php',\n        method:'post',\n        dataType:'json',\n        //data\u306bFormData\u3092\u6307\u5b9a\n        data:formData,\n        // Ajax\u304cdata\u3092\u6574\u5f62\u3057\u306a\u3044\u6307\u5b9a\n        processData:false,\n        // contentType\u3082false\u306b\u6307\u5b9a\n        contentType:false\n    }).done(function(data){//\u6210\u529f\u3057\u305f\u6642\u306e\u51e6\u7406\n\n        console.log( 'SUCCESS', data );\n\n        //data\u5185\u306e\u6539\u884c\u30b3\u30fc\u30c9\u3092\u6d88\u3059\n        var img_file_path = data.replace(/\\r?\\n/g,\"\");\n\n\n        //\u30ec\u30a4\u30a2\u30a6\u30c8\u3092\u6574\u3048\u308b\u305f\u3081\u306ep\u8981\u7d20\u3092\u4f5c\u6210\n        var pn = $('<p></p>').attr({\n            style: \"float:left; margin:10px 10px;\"\n        });\n\n        //\u8ffd\u52a0\u3059\u308bimg\u8981\u7d20\u3092\u4f5c\u6210\n        var img_src = $('<img>').attr({\n            src: img_file_path,\n            style: \"width:200px; height:150px;\"\n        });\n\n        //p\u8981\u7d20\u306e\u4e2d\u306bimg\u8981\u7d20\u3092\u5165\u308c\u308b->\u3053\u308c\u304c\u5b9f\u969b\u306b\u633f\u5165\u3055\u308c\u308b\u8981\u7d20\u306b\u306a\u308b\n        var imgInP = pn.html(img_src);\n\n        //\u4f5c\u6210\u3057\u305f\u8981\u7d20\u3092\u753b\u50cf\u3092\u56f2\u3046\u89aa\u8981\u7d20\u306e\u6700\u5f8c\u306b\u8ffd\u52a0\u3059\u308b\n        $('div.photoImage').append(imgInP);\n        //\u5931\u6557\u3057\u305f\u6642\u306e\u51e6\u7406\n    }).fail(function( jqXHR, textStatus, errorThrown ){\n\n        console.log( 'ERROR', jqXHR, textStatus, errorThrown );\n    });\n\n    return false;\n});\n\n\n\u4ee5\u4e0b\u304c\u53d7\u3051\u53d6\u308bphp\u30d5\u30a1\u30a4\u30eb\najax\u3067json\u5f62\u5f0f\u3092\u6307\u5b9a\u3057\u305f\u305f\u3081\u3001\n\u8fd4\u3059\u5024\u3082json\u5f62\u5f0f\u3067\u306a\u3051\u308c\u3070\u306a\u3089\u306a\u3044\n```php:upload.php\ndate_default_timezone_set('Asia/Tokyo');\n    if($FILES[\"upfile\"][\"tmp_name\"] && $FILES[\"upfile\"][\"size\"] > 0){\n    //$_FILES\u306e\u5404\u8981\u7d20\u3092\u5909\u6570\u306b\u4ee3\u5165\u3059\u308b.getimagesize\u306f\u753b\u50cf\u60c5\u5831\u3092\u53d6\u5f97\u3059\u308b\n    list($w,$h,$type,$attr) = getimagesize($_FILES[\"upfile\"][\"tmp_name\"]);\n\n    //\u753b\u50cf\u306e\u30bf\u30a4\u30d7\u306b\u5fdc\u3058\u3066\u62e1\u5f35\u5b50\u3092\u3064\u3051\u308b\n    switch ($type) {\n        case IMAGETYPE_JPEG:\n            $extention = '.jpg';\n            break;\n        case IMAGETYPE_PNG:\n            $extention = '.png';\n            break;\n        case IMAGETYPE_GIF:\n            $extention = '.gif';\n            break;\n    }\n\n    //\u62e1\u5f35\u5b50\u304c\u3064\u3044\u305f\u5834\u5408\u3001\u753b\u50cf\u306e\u30d5\u30a1\u30a4\u30eb\u540d\u3092\u3064\u3051\u3001\u753b\u50cf\u3092\u79fb\u52d5\u3055\u305b\u308b\u305f\u3081\u306e\u30d5\u30a1\u30a4\u30eb\u30d1\u30b9\u3092\u6307\u5b9a\u3059\u308b\n    if($extention){\n        $file_name = date(\"YmdHis\").$extention;\n        $img_file_path = \"image/listing_photos/$file_name\";\n\n\n    //\u753b\u50cf\u30d5\u30a1\u30a4\u30eb\u3092\u6307\u5b9a\u30d5\u30a9\u30eb\u30c0\u306b\u79fb\u52d5\u3055\u305b\u308b\n        move_uploaded_file($_FILES[\"upfile\"][\"tmp_name\"],\"$img_file_path\");\n    }else{\n\n    //\u62e1\u5f35\u5b50\u304c\u3064\u304b\u306a\u304b\u3063\u305f\u5834\u5408\u3001\u30a8\u30e9\u30fc\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u51fa\u3059\n        header('Content-Type: application/json; charset=utf-8');\n        echo json_encode(\"\u6307\u5b9a\u3057\u305f\u30d5\u30a1\u30a4\u30eb\u306f\u753b\u50cf\u30d5\u30a1\u30a4\u30eb\u3067\u306f\u3042\u308a\u307e\u305b\u3093\");\n        exit;\n    }\n\n\n    //\u30b5\u30fc\u30d0\u30fc\u306b\u4fdd\u5b58\u3057\u305f\u753b\u50cf\u30d5\u30a1\u30a4\u30eb\u306e\u30d1\u30b9\u3092DB\u306b\u3082\u4fdd\u5b58\u3059\u308b(\u5f8c\u3067\u8868\u793a\u51fa\u6765\u308b\u3088\u3046\u306b)\n    $sql = \"insert into listing_image_info (list_id,img_file_path) values(?,?)\";//preare\u306e\u6642\u306fbind\u3092\u4f7f\u3046\uff01\uff01\n    $stmt = $dbh->prepare($sql);\n    $stmt->execute(array($list_id,$img_file_path));\n\n    $sql = \"select * from listing_image_info where list_id = ?;\";\n    $stmt = $dbh->prepare($sql);\n    $stmt->execute(array($list_id));\n    $result_img = $stmt->fetchAll(PDO::FETCH_ASSOC);\n\n    //ajax\u3067jason\u5f62\u5f0f\u3092\u6307\u5b9a\u3057\u305f\u3089\u8fd4\u3059\u5024\u3082json\u306b\u3059\u308b\uff01\uff01\n    header('Content-Type: application/json; charset=utf-8');\n    echo json_encode($img_file_path);\n\n\n}\n\n\n\u4ee5\u4e0b\u306e\u8a18\u4e8b\u3092\u53c2\u7167\u3057\u3066\u51fa\u6765\u305f\nhttp://chaika.hatenablog.com/entry/2014/04/12/001012\n\n```javascript:manage.php\n$('#upload').click(function(){\n\n\t//\u30d5\u30a9\u30fc\u30e0\u306e\u30c7\u30fc\u30bf\u3092\u5909\u6570form\u306b\u683c\u7d0d\n\tvar form = $('#listing_image_form').get()[0];\n\n\t//FormData \u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u4f5c\u6210\n\tvar formData = new FormData( form );\n\n\t$.ajax({//\u9001\u308b\u30c7\u30fc\u30bf\n\t\turl:'listing_manage_save.php',\n\t\tmethod:'post',\n\t\tdataType:'json',\n\t\t//data\u306bFormData\u3092\u6307\u5b9a\n\t\tdata:formData,\n\t\t// Ajax\u304cdata\u3092\u6574\u5f62\u3057\u306a\u3044\u6307\u5b9a\n\t\tprocessData:false,\n\t\t// contentType\u3082false\u306b\u6307\u5b9a\n\t\tcontentType:false\n\t}).done(function(data){//\u6210\u529f\u3057\u305f\u6642\u306e\u51e6\u7406\n\n\t\tconsole.log( 'SUCCESS', data );\n\t\t\n\t\t//data\u5185\u306e\u6539\u884c\u30b3\u30fc\u30c9\u3092\u6d88\u3059\n\t\tvar img_file_path = data.replace(/\\r?\\n/g,\"\");\n\n\t\t\n\t\t//\u30ec\u30a4\u30a2\u30a6\u30c8\u3092\u6574\u3048\u308b\u305f\u3081\u306ep\u8981\u7d20\u3092\u4f5c\u6210\n\t\tvar pn = $('<p></p>').attr({\n    \t\tstyle: \"float:left; margin:10px 10px;\"\n\t\t});\n\n\t\t//\u8ffd\u52a0\u3059\u308bimg\u8981\u7d20\u3092\u4f5c\u6210\n    \tvar img_src = $('<img>').attr({\n    \t\tsrc: img_file_path,\n    \t\tstyle: \"width:200px; height:150px;\"\n\t\t});\n\n    \t//p\u8981\u7d20\u306e\u4e2d\u306bimg\u8981\u7d20\u3092\u5165\u308c\u308b->\u3053\u308c\u304c\u5b9f\u969b\u306b\u633f\u5165\u3055\u308c\u308b\u8981\u7d20\u306b\u306a\u308b\n\t\tvar imgInP = pn.html(img_src);\n\n\t\t//\u4f5c\u6210\u3057\u305f\u8981\u7d20\u3092\u753b\u50cf\u3092\u56f2\u3046\u89aa\u8981\u7d20\u306e\u6700\u5f8c\u306b\u8ffd\u52a0\u3059\u308b\n    \t$('div.photoImage').append(imgInP);\n\t\t//\u5931\u6557\u3057\u305f\u6642\u306e\u51e6\u7406\n\t}).fail(function( jqXHR, textStatus, errorThrown ){\n\n\t\tconsole.log( 'ERROR', jqXHR, textStatus, errorThrown );\n\t});\n\n\treturn false;\n});\n```\n\n\n\u4ee5\u4e0b\u304c\u53d7\u3051\u53d6\u308bphp\u30d5\u30a1\u30a4\u30eb\n**ajax\u3067json\u5f62\u5f0f\u3092\u6307\u5b9a\u3057\u305f\u305f\u3081\u3001\n\u8fd4\u3059\u5024\u3082json\u5f62\u5f0f\u3067\u306a\u3051\u308c\u3070\u306a\u3089\u306a\u3044**\n```php:upload.php\ndate_default_timezone_set('Asia/Tokyo');\n\tif($_FILES[\"upfile\"][\"tmp_name\"] && $_FILES[\"upfile\"][\"size\"] > 0){\n\n\n\t\t//$_FILES\u306e\u5404\u8981\u7d20\u3092\u5909\u6570\u306b\u4ee3\u5165\u3059\u308b.getimagesize\u306f\u753b\u50cf\u60c5\u5831\u3092\u53d6\u5f97\u3059\u308b\n\t\tlist($w,$h,$type,$attr) = getimagesize($_FILES[\"upfile\"][\"tmp_name\"]);\n\n\t\t//\u753b\u50cf\u306e\u30bf\u30a4\u30d7\u306b\u5fdc\u3058\u3066\u62e1\u5f35\u5b50\u3092\u3064\u3051\u308b\n\t\tswitch ($type) {\n\t\t\tcase IMAGETYPE_JPEG:\n\t\t\t\t$extention = '.jpg';\n\t\t\t\tbreak;\n\t\t\tcase IMAGETYPE_PNG:\n\t\t\t\t$extention = '.png';\n\t\t\t\tbreak;\n\t\t\tcase IMAGETYPE_GIF:\n\t\t\t\t$extention = '.gif';\n\t\t\t\tbreak;\n\t\t}\n\n\t\t//\u62e1\u5f35\u5b50\u304c\u3064\u3044\u305f\u5834\u5408\u3001\u753b\u50cf\u306e\u30d5\u30a1\u30a4\u30eb\u540d\u3092\u3064\u3051\u3001\u753b\u50cf\u3092\u79fb\u52d5\u3055\u305b\u308b\u305f\u3081\u306e\u30d5\u30a1\u30a4\u30eb\u30d1\u30b9\u3092\u6307\u5b9a\u3059\u308b\n\t\tif($extention){\n\t\t\t$file_name = date(\"YmdHis\").$extention;\n\t\t\t$img_file_path = \"image/listing_photos/$file_name\";\n\t\n\t\t\t\n\t\t//\u753b\u50cf\u30d5\u30a1\u30a4\u30eb\u3092\u6307\u5b9a\u30d5\u30a9\u30eb\u30c0\u306b\u79fb\u52d5\u3055\u305b\u308b\n\t\t\tmove_uploaded_file($_FILES[\"upfile\"][\"tmp_name\"],\"$img_file_path\");\n\t\t}else{\n\t\t\n\t\t//\u62e1\u5f35\u5b50\u304c\u3064\u304b\u306a\u304b\u3063\u305f\u5834\u5408\u3001\u30a8\u30e9\u30fc\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u51fa\u3059\n\t\t\theader('Content-Type: application/json; charset=utf-8');\n\t\t\techo json_encode(\"\u6307\u5b9a\u3057\u305f\u30d5\u30a1\u30a4\u30eb\u306f\u753b\u50cf\u30d5\u30a1\u30a4\u30eb\u3067\u306f\u3042\u308a\u307e\u305b\u3093\");\n\t\t\texit;\n\t\t}\n\n\n\t\t//\u30b5\u30fc\u30d0\u30fc\u306b\u4fdd\u5b58\u3057\u305f\u753b\u50cf\u30d5\u30a1\u30a4\u30eb\u306e\u30d1\u30b9\u3092DB\u306b\u3082\u4fdd\u5b58\u3059\u308b(\u5f8c\u3067\u8868\u793a\u51fa\u6765\u308b\u3088\u3046\u306b)\n\t\t$sql = \"insert into listing_image_info (list_id,img_file_path) values(?,?)\";//preare\u306e\u6642\u306fbind\u3092\u4f7f\u3046\uff01\uff01\n\t\t$stmt = $dbh->prepare($sql);\n\t\t$stmt->execute(array($list_id,$img_file_path));\n\n\t\t$sql = \"select * from listing_image_info where list_id = ?;\";\n\t\t$stmt = $dbh->prepare($sql);\n\t\t$stmt->execute(array($list_id));\n\t\t$result_img = $stmt->fetchAll(PDO::FETCH_ASSOC);\n\n\t\t//ajax\u3067jason\u5f62\u5f0f\u3092\u6307\u5b9a\u3057\u305f\u3089\u8fd4\u3059\u5024\u3082json\u306b\u3059\u308b\uff01\uff01\n\t\theader('Content-Type: application/json; charset=utf-8');\n\t\techo json_encode($img_file_path);\n\n\n\t}\n\n```\n", "tags": ["Ajax", "jQuery"]}