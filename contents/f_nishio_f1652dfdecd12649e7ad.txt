{"context": " More than 1 year has passed since last update.\u524d\u56de\u307e\u3067\u306f\u3001python\u7248\u306epaho-mqtt\u30e9\u30a4\u30d6\u30e9\u30ea\u3092\u4f7f\u3063\u3066\u304d\u305f\u304c\u3001paho\u306b\u306fAndroid\u7248\u3082\u3042\u308b\u306e\u3067\u3001Android\u306e\u30bb\u30f3\u30b5\u5024\u3092\u30e2\u30cb\u30bf\u3059\u308b\u30d7\u30ed\u30c8\u30bf\u30a4\u30d7\u3092\u4f5c\u3063\u3066\u307f\u308b\u3002\n\u30d7\u30ed\u30c8\u30bf\u30a4\u30d7\u306e\u30b3\u30fc\u30c9\u306f github fnishio/mqtt-sample\u306eSensorSample\u3092\u53c2\u7167\u3002\n\nAndroid\u30bb\u30f3\u30b5\u5024\u306e\u30e2\u30cb\u30bf\n\nAndroid\u5074\n\n\nLight\u30bb\u30f3\u30b5\u30fc\u306e\u5024\u3092MQTT event\u3068\u3057\u3066\u5b9a\u671f\u7684\u306bpublish\u3059\u308b\u3002\n\n\n\u30b5\u30fc\u30d3\u30b9\u5074\n\n\n\u30bb\u30f3\u30b5\u30fc\u5024\u306eevent\u3092WebSocket\u306b\u51fa\u529b\u3059\u308b\u3002\n\u30d6\u30e9\u30a6\u30b6\u304b\u3089WebSocket\u306b\u63a5\u7d9a\u3057\u3066\u30bb\u30f3\u30b5\u30fc\u5024\u3092\u30e2\u30cb\u30bf\u30ea\u30f3\u30b0\u3059\u308b\u3002\n\n\n\n\nAndroid\u5074\n\nMQTT Broker\u306b\u3064\u306a\u3050\nAndroid\u7248\u306epaho\u30e9\u30a4\u30d6\u30e9\u30ea\u3092\u4f7f\u3063\u3066MQTT Broker\u306b\u63a5\u7d9a\u3059\u308b\u3002\n\nMyMqttClient.java\nMyMqttClient(Context context) {\n    mClient = new MqttAndroidClient(context, MyMqttConfig.ENDPOINT_URL, MyMqttConfig.CLIENT_ID);\n}\n\npublic void connect() {\n    MqttConnectOptions options = new MqttConnectOptions();\n    options.setUserName(MyMqttConfig.USER);\n    options.setPassword(MyMqttConfig.PASSWORD.toCharArray());\n    try {\n        mClient.connect(options, null, new IMqttActionListener() {\n            @Override\n            public void onSuccess(IMqttToken mqttToken) {\n              // ...\n            }\n\n            @Override\n            public void onFailure(IMqttToken arg0, Throwable arg1) {\n              // ...\n            }\n        });\n    } catch (MqttSecurityException e) {\n        // do nothing.\n    } catch (MqttException e) {\n        // do nothing.\n    }\n}\n\n\n\nEvent Publish\nSensorEventListener\u306eonSensorChanged()\u3067\u30bb\u30f3\u30b5\u30fc\u5024\u3092\u76e3\u8996\u3057\u3066\u30c8\u30d4\u30c3\u30afiot-2/evt/sensor/fmt/json\u306bpublish\u3059\u308b\u3002\n\nSensorActivity.java\n@Override\npublic final void onSensorChanged(SensorEvent event) {\n    float value = event.values[0];\n    mClient.publish(\"sensor\", \"light\", value);\n}\n\n\n\n\u30b5\u30fc\u30d3\u30b9\u5074\n\u30b5\u30fc\u30d3\u30b9\u5074\u306f\u30012\u3064\u306e\u30d5\u30ed\u30fc\u3092\u5b9f\u88c5\u3059\u308b\u3002\n(1) \u30bb\u30f3\u30b5\u30fc\u5024\u306e\u30a4\u30d9\u30f3\u30c8\u3092WebSocket\u306b\u9001\u4fe1\u3059\u308b\u30d5\u30ed\u30fc\n\n(2) WebSocket\u306e\u5024\u3092\u76e3\u8996\u3059\u308bWeb\u30da\u30fc\u30b8\u3092\u30d6\u30e9\u30a6\u30b6\u306b\u9001\u308b\u30d5\u30ed\u30fc\n\n\nEvent Subscirbe\nMQTT Device\u304b\u3089\u9001\u4fe1\u3055\u308c\u308b\u30c8\u30d4\u30c3\u30afiot-2/evt/sensor/fmt/json\u306e\n\u30bb\u30f3\u30b5\u30fc\u5024\u30a4\u30d9\u30f3\u30c8\u3092\n\u53d7\u3051\u53d6\u3063\u3066\u3001WebSocket \u306b\u9001\u4fe1\u3059\u308b\u30c7\u30fc\u30bf\u306b\u6574\u5f62\u3059\u308b\u3002\n\nWebSocket /ws/sensor\u306b\u30c7\u30fc\u30bf\u3092\u9001\u308b\u3002\n\n\nMonitoring\n/sensor\u306bHTTP GET\u3055\u308c\u305f\u3089\u4ee5\u4e0b\u306ehtml\u3092\u30d6\u30e9\u30a6\u30b6\u306b\u8fd4\u3059\u3002html\u306e\u51e6\u7406\u5185\u5bb9\u306f\u3001WebSocket /ws/sensor\u306b\u3064\u306a\u3044\u3067\u30bb\u30f3\u30b5\u5024\u3092\u53d6\u5f97\u3057\u3001\u30d6\u30e9\u30a6\u30b6\u4e0a\u306e\u30bb\u30f3\u30b5\u30fc\u5024\u8868\u793a\u3092\u66f4\u65b0\u3059\u308b\u3002\n\u3053\u306e\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u3092Node-RED\u306eSensor Value\u30ce\u30fc\u30c9\u306b\u8a2d\u5b9a\u3059\u308b\u3002\n\nmonitor_template.html\n<head>\n  <title>Sensor</title>\n  <script type=\"text/javascript\">\n  var wsUri = \"ws://{{req.headers.host}}/ws/sensor\";\n  var ws = new WebSocket(wsUri);\n\n  ws.onmessage = function(ev) {\n    var payload = JSON.parse(ev.data);\n    var device = document.getElementById('device');\n    device.textContent = payload.deviceId;\n    var sensor = document.getElementById('sensor');\n    sensor.textContent = payload.light;\n  }\n  </script>\n</head>\n\n<body>\n    <div>Sensor Monitor:</div>\n    <div>\n      Id: <span id=\"device\">xxx</span>\n      Value:<span id=\"sensor\">00</span>\n    </div>\n</body>\n\n\n\n\u5b9f\u884c\nAndroid\u4e0a\u3067\u30a2\u30d7\u30ea\u3092\u5b9f\u884c\u3059\u308b\u3068Light\u30bb\u30f3\u30b5\u30fc\u306e\u5024\u3092\u5b9a\u671f\u7684\u306bpublish\u3059\u308b\u3002\n\u30d6\u30e9\u30a6\u30b6\u304b\u3089http://[server address]/sensor\u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3068\u3001publish\u3055\u308c\u3066\u3044\u308b\u30bb\u30f3\u30b5\u5024\u3092\u30e2\u30cb\u30bf\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u308b\u3002\n\n[\u524d\u56de](http://qiita.com/f_nishio/items/33b4922ccf705d74b002)\u307e\u3067\u306f\u3001python\u7248\u306epaho-mqtt\u30e9\u30a4\u30d6\u30e9\u30ea\u3092\u4f7f\u3063\u3066\u304d\u305f\u304c\u3001[paho](http://www.eclipse.org/paho/)\u306b\u306fAndroid\u7248\u3082\u3042\u308b\u306e\u3067\u3001Android\u306e\u30bb\u30f3\u30b5\u5024\u3092\u30e2\u30cb\u30bf\u3059\u308b\u30d7\u30ed\u30c8\u30bf\u30a4\u30d7\u3092\u4f5c\u3063\u3066\u307f\u308b\u3002\n\u30d7\u30ed\u30c8\u30bf\u30a4\u30d7\u306e\u30b3\u30fc\u30c9\u306f github [fnishio/mqtt-sample](https://github.com/fnishio/mqtt-sample)\u306eSensorSample\u3092\u53c2\u7167\u3002\n\nAndroid\u30bb\u30f3\u30b5\u5024\u306e\u30e2\u30cb\u30bf\n========================\n\n- Android\u5074\n    - Light\u30bb\u30f3\u30b5\u30fc\u306e\u5024\u3092MQTT event\u3068\u3057\u3066\u5b9a\u671f\u7684\u306bpublish\u3059\u308b\u3002\n- \u30b5\u30fc\u30d3\u30b9\u5074\n    - \u30bb\u30f3\u30b5\u30fc\u5024\u306eevent\u3092WebSocket\u306b\u51fa\u529b\u3059\u308b\u3002\n    - \u30d6\u30e9\u30a6\u30b6\u304b\u3089WebSocket\u306b\u63a5\u7d9a\u3057\u3066\u30bb\u30f3\u30b5\u30fc\u5024\u3092\u30e2\u30cb\u30bf\u30ea\u30f3\u30b0\u3059\u308b\u3002\n\n\nAndroid\u5074\n--------------\n\n### MQTT Broker\u306b\u3064\u306a\u3050\nAndroid\u7248\u306epaho\u30e9\u30a4\u30d6\u30e9\u30ea\u3092\u4f7f\u3063\u3066MQTT Broker\u306b\u63a5\u7d9a\u3059\u308b\u3002\n\n```java:MyMqttClient.java\nMyMqttClient(Context context) {\n    mClient = new MqttAndroidClient(context, MyMqttConfig.ENDPOINT_URL, MyMqttConfig.CLIENT_ID);\n}\n\npublic void connect() {\n    MqttConnectOptions options = new MqttConnectOptions();\n    options.setUserName(MyMqttConfig.USER);\n    options.setPassword(MyMqttConfig.PASSWORD.toCharArray());\n    try {\n        mClient.connect(options, null, new IMqttActionListener() {\n            @Override\n            public void onSuccess(IMqttToken mqttToken) {\n              // ...\n            }\n\n            @Override\n            public void onFailure(IMqttToken arg0, Throwable arg1) {\n              // ...\n            }\n        });\n    } catch (MqttSecurityException e) {\n        // do nothing.\n    } catch (MqttException e) {\n        // do nothing.\n    }\n}\n```\n\n### Event Publish\nSensorEventListener\u306eonSensorChanged()\u3067\u30bb\u30f3\u30b5\u30fc\u5024\u3092\u76e3\u8996\u3057\u3066\u30c8\u30d4\u30c3\u30af`iot-2/evt/sensor/fmt/json`\u306bpublish\u3059\u308b\u3002\n\n```java:SensorActivity.java\n@Override\npublic final void onSensorChanged(SensorEvent event) {\n    float value = event.values[0];\n    mClient.publish(\"sensor\", \"light\", value);\n}\n```\n\n\u30b5\u30fc\u30d3\u30b9\u5074\n------------\n\u30b5\u30fc\u30d3\u30b9\u5074\u306f\u30012\u3064\u306e\u30d5\u30ed\u30fc\u3092\u5b9f\u88c5\u3059\u308b\u3002\n\n(1) \u30bb\u30f3\u30b5\u30fc\u5024\u306e\u30a4\u30d9\u30f3\u30c8\u3092WebSocket\u306b\u9001\u4fe1\u3059\u308b\u30d5\u30ed\u30fc\n![websocket.png](https://qiita-image-store.s3.amazonaws.com/0/88598/56dcb948-ae38-3462-f872-20598f7f75de.png)\n\n(2) WebSocket\u306e\u5024\u3092\u76e3\u8996\u3059\u308bWeb\u30da\u30fc\u30b8\u3092\u30d6\u30e9\u30a6\u30b6\u306b\u9001\u308b\u30d5\u30ed\u30fc\n![monitor_page.png](https://qiita-image-store.s3.amazonaws.com/0/88598/bc0ab625-c013-f21e-cfed-6d308b97d1f5.png)\n\n### Event Subscirbe\nMQTT Device\u304b\u3089\u9001\u4fe1\u3055\u308c\u308b\u30c8\u30d4\u30c3\u30af`iot-2/evt/sensor/fmt/json`\u306e\n\u30bb\u30f3\u30b5\u30fc\u5024\u30a4\u30d9\u30f3\u30c8\u3092\n\u53d7\u3051\u53d6\u3063\u3066\u3001WebSocket \u306b\u9001\u4fe1\u3059\u308b\u30c7\u30fc\u30bf\u306b\u6574\u5f62\u3059\u308b\u3002\n\n![ws_format.png](https://qiita-image-store.s3.amazonaws.com/0/88598/db38e23e-8b99-8b85-1fb7-34c8dfb502cb.png)\n\nWebSocket `/ws/sensor`\u306b\u30c7\u30fc\u30bf\u3092\u9001\u308b\u3002\n![ws_out.png](https://qiita-image-store.s3.amazonaws.com/0/88598/40627b34-cbc6-2293-2d71-6dc9b5c5fffb.png)\n\n### Monitoring\n`/sensor`\u306bHTTP GET\u3055\u308c\u305f\u3089\u4ee5\u4e0b\u306ehtml\u3092\u30d6\u30e9\u30a6\u30b6\u306b\u8fd4\u3059\u3002html\u306e\u51e6\u7406\u5185\u5bb9\u306f\u3001WebSocket `/ws/sensor`\u306b\u3064\u306a\u3044\u3067\u30bb\u30f3\u30b5\u5024\u3092\u53d6\u5f97\u3057\u3001\u30d6\u30e9\u30a6\u30b6\u4e0a\u306e\u30bb\u30f3\u30b5\u30fc\u5024\u8868\u793a\u3092\u66f4\u65b0\u3059\u308b\u3002\n\u3053\u306e\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u3092Node-RED\u306eSensor Value\u30ce\u30fc\u30c9\u306b\u8a2d\u5b9a\u3059\u308b\u3002\n\n```html:monitor_template.html\n<head>\n  <title>Sensor</title>\n  <script type=\"text/javascript\">\n  var wsUri = \"ws://{{req.headers.host}}/ws/sensor\";\n  var ws = new WebSocket(wsUri);\n\n  ws.onmessage = function(ev) {\n    var payload = JSON.parse(ev.data);\n    var device = document.getElementById('device');\n    device.textContent = payload.deviceId;\n    var sensor = document.getElementById('sensor');\n    sensor.textContent = payload.light;\n  }\n  </script>\n</head>\n\n<body>\n    <div>Sensor Monitor:</div>\n    <div>\n      Id: <span id=\"device\">xxx</span>\n      Value:<span id=\"sensor\">00</span>\n    </div>\n</body>\n```\n\n\u5b9f\u884c\n----\nAndroid\u4e0a\u3067\u30a2\u30d7\u30ea\u3092\u5b9f\u884c\u3059\u308b\u3068Light\u30bb\u30f3\u30b5\u30fc\u306e\u5024\u3092\u5b9a\u671f\u7684\u306bpublish\u3059\u308b\u3002\n\u30d6\u30e9\u30a6\u30b6\u304b\u3089``http://[server address]/sensor``\u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3068\u3001publish\u3055\u308c\u3066\u3044\u308b\u30bb\u30f3\u30b5\u5024\u3092\u30e2\u30cb\u30bf\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u308b\u3002\n![monitor_html.png](https://qiita-image-store.s3.amazonaws.com/0/88598/148f2452-a27d-6611-ae88-305135ee4893.png)\n", "tags": ["IoT", "IoTFoundation", "Bluemix", "node-red", "Android"]}