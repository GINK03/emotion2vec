{"tags": ["AWS", "aws-cli", "S3"], "context": " More than 1 year has passed since last update.AWS CLI\u3092\u5229\u7528\u3057\u3066\u3001S3\u4e0a\u306bPOST\u53ef\u80fd\u306aWeb\u30b5\u30a4\u30c8\u3092\u4f5c\u6210\u3057\u3066\u307f\u307e\u3059\u3002\n\n\u524d\u63d0\u6761\u4ef6\n\nS3\u3078\u306e\u6a29\u9650\n\nS3\u306b\u5bfe\u3057\u3066\u30d5\u30eb\u6a29\u9650\u304c\u3042\u308b\u3053\u3068\u3002\n\n\nAWS CLI\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\n\n\n\u4ee5\u4e0b\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u3067\u52d5\u4f5c\u78ba\u8a8d\u6e08\n\nAWS CLI 1.8.3\n\n\n\n\n\u30b3\u30de\u30f3\u30c9\naws --version\n\n\n\n\u7d50\u679c(\u4f8b)\n      aws-cli/1.8.3 Python/2.7.5 Darwin/13.4.0\n\n\n\n0. \u6e96\u5099\n\n0.1. \u30ea\u30fc\u30b8\u30e7\u30f3\u306e\u6c7a\u5b9a\nWeb\u30b5\u30a4\u30c8\u3092\u69cb\u7bc9\u3059\u308b\u30ea\u30fc\u30b8\u30e7\u30f3\u3092\u6c7a\u3081\u307e\u3059\u3002\n(\u30ab\u30ec\u30f3\u30c8\u30e6\u30fc\u30b6\u304c\u5229\u7528\u3059\u308b\u30ab\u30ec\u30f3\u30c8\u30ea\u30fc\u30b8\u30e7\u30f3\u3082\u5207\u308a\u5909\u308f\u308a\u307e\u3059\u3002)\n\n\u30b3\u30de\u30f3\u30c9(\u6771\u4eac\u30ea\u30fc\u30b8\u30e7\u30f3\u306e\u5834\u5408)\nexport AWS_DEFAULT_REGION='ap-northeast-1'\n\n\n\n0.2. \u5909\u6570\u306e\u78ba\u8a8d\n\u30d7\u30ed\u30d5\u30a1\u30a4\u30eb\u3068\u30ea\u30fc\u30b8\u30e7\u30f3\u304c\u60f3\u5b9a\u306e\u3082\u306e\u306b\u306a\u3063\u3066\u3044\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n\u5909\u6570\u306e\u78ba\u8a8d\naws configure list\n\n\n\n\u7d50\u679c(\u4f8b)\n\n            Name                    Value             Type    Location\n            ----                    -----             ----    --------\n         profile        s3Full-prjZ-mbp13              env    AWS_DEFAULT_PROFILE\n      access_key     ****************LOAQ shared-credentials-file\n      secret_key     ****************I1O1 shared-credentials-file\n          region           ap-northeast-1              env    AWS_DEFAULT_REGION\n\n\n\n1. \u4e8b\u524d\u4f5c\u696d\n\n1.1. \u30b5\u30a4\u30c8\u540d\u306e\u6c7a\u5b9a\n\u7d44\u7e54\u540d-handson-\u4eca\u65e5\u306e\u65e5\u4ed8\u3068\u3057\u307e\u3059\u3002\n\n\u5909\u6570\u306e\u8a2d\u5b9a\nORG=<\u7d44\u7e54\u540d>\nHOSTNAME_WEBSITE=\"${ORG}-handson-`date +%Y%m%d`\"\n\necho ${HOSTNAME_WEBSITE}\n\n\n\n1.2. \u30b3\u30f3\u30c6\u30f3\u30c4\u7528\u30d0\u30b1\u30c3\u30c8\u540d\u306e\u6c7a\u5b9a\n\n\u5909\u6570\u306e\u8a2d\u5b9a\nS3_BUCKET_SITE=\"${HOSTNAME_WEBSITE}\" \\\n        && echo ${S3_BUCKET_SITE}\n\n\n\u540c\u540d\u306e\u30d0\u30b1\u30c3\u30c8\u304c\u5b58\u5728\u3057\u306a\u3044\u3053\u3068\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n\u30b3\u30de\u30f3\u30c9\naws s3 ls s3://${S3_BUCKET_SITE}\n\n\n\n\u7d50\u679c(\u4f8b)\n      A client error (NoSuchBucket) occurred when calling the ListObjects operation: The specified bucket does not exist\n\n\n\n1.3. \u30ed\u30b0\u7528\u30d0\u30b1\u30c3\u30c8\u540d\u306e\u6c7a\u5b9a\n\n\u5909\u6570\u306e\u8a2d\u5b9a\nS3_BUCKET_LOG=\"${S3_BUCKET_SITE}-log\" \\\n        && echo ${S3_BUCKET_LOG}\n\n\n\u540c\u540d\u306e\u30d0\u30b1\u30c3\u30c8\u304c\u5b58\u5728\u3057\u306a\u3044\u3053\u3068\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n\u30b3\u30de\u30f3\u30c9\naws s3 ls s3://${S3_BUCKET_LOG}\n\n\n\n\u7d50\u679c(\u4f8b)\n      A client error (NoSuchBucket) occurred when calling the ListObjects operation: The specified bucket does not exist\n\n\n\n1.4. \u30ed\u30fc\u30ab\u30eb\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u4f5c\u6210\n\n\u5909\u6570\u306e\u8a2d\u5b9a\nDIR_LOCAL_CONTENTS=\"$(pwd)/file-bucket\" \\\n        && echo ${DIR_LOCAL_CONTENTS}\n\n\n\n\u30b3\u30de\u30f3\u30c9\nmkdir -p ${DIR_LOCAL_CONTENTS} \\\n        && cd ${DIR_LOCAL_CONTENTS}\n\n\n\n1.5. index.html, error.html\u4f5c\u6210\n\n\u30b3\u30de\u30f3\u30c9\ncd ${DIR_LOCAL_CONTENTS}\n\n\n\n\u30b3\u30de\u30f3\u30c9\ncat << EOF > index.html\n      <!DOCTYPE html>\n      <html lang=\"ja\">\n      <head>\n        <meta charset=\"utf-8\">\n        <title>Title</title>\n      </head>\n\n      <body>\n\n      <h1>Hello!</h1>\n      <!-- comment -->\n\n      </body>\n      </html>\nEOF\n\ncat index.html\n\n\n\n\u30b3\u30de\u30f3\u30c9\ncat << EOF > error.html\n      <!DOCTYPE html>\n      <html lang=\"ja\">\n\n      <head>\n        <meta charset=\"UTF-8\">\n      </head>\n\n      <body>\n        <h1>404 File Not Found</h1>\n        <p>\u304a\u63a2\u3057\u306e\u30da\u30fc\u30b8\u306f\u898b\u3064\u304b\u308a\u307e\u305b\u3093\u3002</p>\n      </body>\n      </html>\nEOF\n\ncat error.html\n\n\n\n2. \u30b3\u30f3\u30c6\u30f3\u30c4\u7528\u30d0\u30b1\u30c3\u30c8\u306e\u4f5c\u6210\n\n\u5909\u6570\u306e\u8a2d\u5b9a\nS3_BUCKET_NAME=\"${S3_BUCKET_SITE}\" \\\n        && echo ${S3_BUCKET_NAME}\n\n\n\n\u5909\u6570\u306e\u78ba\u8a8d\ncat << ETX\n\n          S3_BUCKET_NAME: ${S3_BUCKET_NAME}\n\nETX\n\n\n\n\u30b3\u30de\u30f3\u30c9\naws s3 mb s3://${S3_BUCKET_NAME}\n\n\n\n\u7d50\u679c(\u4f8b)\n      make_bucket: s3://www.example.jp/\n\n\n\n\u30b3\u30de\u30f3\u30c9\naws s3api get-bucket-location --bucket ${S3_BUCKET_NAME}\n\n\n\n\u7d50\u679c(\u4f8b)\n      {\n        \"LocationConstraint\": \"ap-northeast-1\"\n      }\n\n\n\n3. \u30ed\u30b0\u7528\u30d0\u30b1\u30c3\u30c8\u306e\u4f5c\u6210/\u8a2d\u5b9a\n\n3.1.  \u30ed\u30b0\u7528\u30d0\u30b1\u30c3\u30c8\u306e\u4f5c\u6210\n\n\u5909\u6570\u306e\u8a2d\u5b9a\nS3_BUCKET_NAME=\"${S3_BUCKET_LOG}\" \\\n        && echo ${S3_BUCKET_NAME}\n\n\n\n\u5909\u6570\u306e\u78ba\u8a8d\ncat << ETX\n\n          S3_BUCKET_NAME: ${S3_BUCKET_NAME}\n\nETX\n\n\n\n\u30b3\u30de\u30f3\u30c9\naws s3 mb s3://${S3_BUCKET_NAME}\n\n\n\n\u7d50\u679c(\u4f8b)\n      make_bucket: s3://www.example.jp-log/\n\n\n\n\u30b3\u30de\u30f3\u30c9\naws s3api get-bucket-location --bucket ${S3_BUCKET_NAME}\n\n\n\n\u7d50\u679c(\u4f8b)\n      {\n        \"LocationConstraint\": \"ap-northeast-1\"\n      }\n\n\n\n3.2. \u30d0\u30b1\u30c3\u30c8ACL\u306e\u78ba\u8a8d\n\n\u30b3\u30de\u30f3\u30c9\naws s3api get-bucket-acl \\\n        --bucket ${S3_BUCKET_NAME}\n\n\n\n\u7d50\u679c(\u4f8b)\n      {\n        \"Owner\": {\n          \"DisplayName\": \"prjz\",\n          \"ID\": \"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\"\n        },\n        \"Grants\": [\n          {\n              \"Grantee\": {\n                  \"DisplayName\": \"prjz\",\n                  \"ID\": \"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\"\n              },\n              \"Permission\": \"FULL_CONTROL\"\n          }\n        ]\n      }\n\n\n\n3.3. \u30d0\u30b1\u30c3\u30c8ACL\u306e\u5909\u66f4\n\n\u5909\u6570\u306e\u78ba\u8a8d\ncat << ETX\n\n          S3_BUCKET_NAME: ${S3_BUCKET_NAME}\n\nETX\n\n\n\n\u30b3\u30de\u30f3\u30c9\naws s3api put-bucket-acl \\\n        --bucket ${S3_BUCKET_NAME} \\\n        --grant-write 'URI=\"http://acs.amazonaws.com/groups/s3/LogDelivery\"' \\\n        --grant-read-acp 'URI=\"http://acs.amazonaws.com/groups/s3/LogDelivery\"'\n\n\n\n\u7d50\u679c(\u4f8b)\n      (\u623b\u308a\u5024\u306a\u3057)\n\n\n\u6ce8\u91c8: \u30d5\u30eb\u30b3\u30f3\u30c8\u30ed\u30fc\u30eb\u306e\u8a2d\u5b9a\u304c\u6d88\u3048\u308b\u305f\u3081\u3001\u30aa\u30fc\u30ca\u306f\u30ed\u30b0\u306e\u524a\u9664\u304c\u3067\u304d\u306a\u304f\u306a\u308a\u307e\u3059\u3002 (\u5fc5\u8981\u304c\u3042\u308b\u5834\u5408\u306f\u3001grant-full-control\u3067\u6307\u5b9a\u3059\u308b\u3002)\n\n3.4. \u30d0\u30b1\u30c3\u30c8ACL\u306e\u78ba\u8a8d\n\n\u30b3\u30de\u30f3\u30c9\naws s3api get-bucket-acl \\\n        --bucket ${S3_BUCKET_NAME}\n\n\n\n\u7d50\u679c(\u4f8b)\n      {\n        \"Owner\": {\n          \"DisplayName\": \"prjz\",\n          \"ID\": \"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\"\n        },\n        \"Grants\": [\n          {\n              \"Grantee\": {\n                  \"URI\": \"http://acs.amazonaws.com/groups/s3/LogDelivery\"\n              },\n              \"Permission\": \"WRITE\"\n          },\n          {\n              \"Grantee\": {\n                  \"URI\": \"http://acs.amazonaws.com/groups/s3/LogDelivery\"\n              },\n              \"Permission\": \"READ_ACP\"\n          }\n        ]\n      }\n\n\n\n4. \u30ed\u30b0\u7528\u30d0\u30b1\u30c3\u30c8\u306e\u8a2d\u5b9a (\u30ed\u30b0\u30ed\u30fc\u30c6\u30fc\u30b7\u30e7\u30f3\u306e\u8a2d\u5b9a)\n\n4.1. \u8a2d\u5b9a\u306e\u78ba\u8a8d\n\n\u5909\u6570\u306e\u78ba\u8a8d\ncat << ETX\n\n        S3_BUCKET_NAME:    ${S3_BUCKET_NAME}\n\nETX\n\n\n\n\u30b3\u30de\u30f3\u30c9\naws s3api get-bucket-lifecycle \\\n        --bucket ${S3_BUCKET_NAME}\n\n\n\n\u7d50\u679c(\u4f8b)\n      A client error (NoSuchLifecycleConfiguration) occurred when calling the GetBucketLifecycle operation: The lifecycle configuration does not exist\n\n\n\n4.2. \u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u306e\u4f5c\u6210\n\n\u5909\u6570\u306e\u8a2d\u5b9a\nFILE_S3_LIFECYCLE='s3-lifecycle.json'\nS3_LIFECYCLE_EXPIRE_DAYS='60'\nS3_LIFECYCLE_TRANS_DAYS='30'\nS3_LIFECYCLE_ID=\"${S3_BUCKET_NAME}-Archive\"\n\n\nS3_LIFECYCLE_ID\u306f\u3001Lifecycle Rules\u306eRule Name\u306b\u306a\u308a\u307e\u3059\u3002(\u30de\u30cd\u30b8\u30e1\u30f3\u30c8\u30b3\u30f3\u30bd\u30fc\u30eb\u4e0a\u3067\u306f\u30aa\u30d7\u30b7\u30e7\u30f3\u6271\u3044)\n\n\u30b3\u30de\u30f3\u30c9\ncat << EOF > ${FILE_S3_LIFECYCLE}\n{\n        \"Rules\": [\n          {\n            \"Expiration\": {\n              \"Days\": ${S3_LIFECYCLE_EXPIRE_DAYS}\n            },\n            \"ID\": \"${S3_LIFECYCLE_ID}\",\n            \"Prefix\": \"Logs/\",\n            \"Status\": \"Enabled\",\n            \"Transition\": {\n              \"Days\": ${S3_LIFECYCLE_TRANS_DAYS},\n              \"StorageClass\": \"GLACIER\"\n            }\n          }\n        ]\n}\nEOF\n\n\nJSON\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3057\u305f\u3089\u3001\u30d5\u30a9\u30fc\u30de\u30c3\u30c8\u304c\u58ca\u308c\u3066\u306a\u3044\u304b\u5fc5\u305a\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n\u30b3\u30de\u30f3\u30c9\njsonlint -q ${FILE_S3_LIFECYCLE}\n\n\n\n\u7d50\u679c\n      (\u623b\u308a\u5024\u306a\u3057)\n\n\n\n4.3. \u8a2d\u5b9a\n\n\u5909\u6570\u306e\u78ba\u8a8d\ncat << ETX\n\n        S3_BUCKET_NAME:    ${S3_BUCKET_NAME}\n        FILE_S3_LIFECYCLE: ${FILE_S3_LIFECYCLE}\n\nETX\n\n\n\n\u30b3\u30de\u30f3\u30c9\naws s3api put-bucket-lifecycle \\\n        --bucket ${S3_BUCKET_NAME} \\\n        --lifecycle-configuration file://${FILE_S3_LIFECYCLE}\n\n\n\n\u7d50\u679c\n      (\u623b\u308a\u5024\u306a\u3057)\n\n\n\n4.4. \u8a2d\u5b9a\u306e\u78ba\u8a8d\n\n\u30b3\u30de\u30f3\u30c9\naws s3api get-bucket-lifecycle \\\n        --bucket ${S3_BUCKET_NAME}\n\n\n\n\u7d50\u679c\n      {\n        \"Rules\": [\n          {\n              \"Status\": \"Enabled\",\n              \"Prefix\": \"/Logs\",\n              \"Transition\": {\n                  \"Days\": 1,\n                  \"StorageClass\": \"GLACIER\"\n              },\n              \"Expiration\": {\n                  \"Days\": 2\n              },\n              \"ID\": \"www.example.jp-log-Archive\"\n          }\n        ]\n      }\n\n\n\n5. \u30b3\u30f3\u30c6\u30f3\u30c4\u7528\u30d0\u30b1\u30c3\u30c8\u306e\u8a2d\u5b9a (\u30ed\u30b0\u4fdd\u5b58)\n\n\u5909\u6570\u306e\u8a2d\u5b9a\nS3_BUCKET_NAME=\"${S3_BUCKET_SITE}\" \\\n        && echo ${S3_BUCKET_NAME}\n\n\n\n5.1. \u30ed\u30b0\u4fdd\u5b58\u8a2d\u5b9a\u306e\u78ba\u8a8d\n\n\u30b3\u30de\u30f3\u30c9\naws s3api get-bucket-logging \\\n        --bucket ${S3_BUCKET_NAME}\n\n\n\n\u7d50\u679c\n      (\u623b\u308a\u5024\u306a\u3057)\n\n\n\n5.2. \u30ed\u30b0\u4fdd\u5b58\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u306e\u4f5c\u6210\n\n\u5909\u6570\u306e\u8a2d\u5b9a\nFILE_S3_LOGGING='s3-logging.json'\n\n\n\n\u30b3\u30de\u30f3\u30c9\ncat << EOF > ${FILE_S3_LOGGING}\n{\n        \"LoggingEnabled\": {\n          \"TargetBucket\": \"${S3_BUCKET_LOG}\",\n          \"TargetPrefix\": \"/Logs\"\n        }\n}\nEOF\n\n\nJSON\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3057\u305f\u3089\u3001\u30d5\u30a9\u30fc\u30de\u30c3\u30c8\u304c\u58ca\u308c\u3066\u306a\u3044\u304b\u5fc5\u305a\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n\u30b3\u30de\u30f3\u30c9\njsonlint -q ${FILE_S3_LOGGING}\n\n\n\n\u7d50\u679c\n      (\u623b\u308a\u5024\u306a\u3057)\n\n\n\n5.3. \u30ed\u30b0\u4fdd\u5b58\u306e\u8a2d\u5b9a\n\n\u5909\u6570\u306e\u78ba\u8a8d\ncat << ETX\n\n        S3_BUCKET_NAME:  ${S3_BUCKET_NAME}\n        FILE_S3_LOGGING: ${FILE_S3_LOGGING}\n\nETX\n\n\n\n\u30b3\u30de\u30f3\u30c9\naws s3api put-bucket-logging \\\n        --bucket ${S3_BUCKET_NAME} \\\n        --bucket-logging-status file://${FILE_S3_LOGGING}\n\n\n\n\u7d50\u679c\n      (\u623b\u308a\u5024\u306a\u3057)\n\n\n\n5.4. \u30ed\u30b0\u4fdd\u5b58\u8a2d\u5b9a\u306e\u78ba\u8a8d\n\n\u30b3\u30de\u30f3\u30c9\naws s3api get-bucket-logging \\\n        --bucket ${S3_BUCKET_NAME}\n\n\n\n\u7d50\u679c(\u4f8b)\n      {\n        \"LoggingEnabled\": {\n          \"TargetPrefix\": \"/Logs\",\n          \"TargetBucket\": \"www.example.jp-log\"\n        }\n      }\n\n\n\n6. \u30b3\u30f3\u30c6\u30f3\u30c4\u7528\u30d0\u30b1\u30c3\u30c8\u306e\u8a2d\u5b9a (\u30d0\u30b1\u30c3\u30c8\u30dd\u30ea\u30b7)\n\n6.1. \u8a2d\u5b9a\u306e\u78ba\u8a8d\n\n\u5909\u6570\u306e\u78ba\u8a8d\ncat << ETX\n\n        S3_BUCKET_NAME:  ${S3_BUCKET_NAME}\n\nETX\n\n\n\n\u30b3\u30de\u30f3\u30c9\naws s3api get-bucket-policy \\\n        --bucket ${S3_BUCKET_NAME} |\\\n        sed 's/\\\\//g' |\\\n        sed 's/\"{/{/' |\\\n        sed 's/}\"/}/' |\\\n        jq .\n\n\n\n\u7d50\u679c(\u4f8b)\n      A client error (NoSuchBucketPolicy) occurred when calling the GetBucketPolicy operation: The bucket policy does not exist\n\n\n\n6.2. \u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u306e\u4f5c\u6210\n\n\u5909\u6570\u306e\u8a2d\u5b9a\nFILE_POLICY='s3-policy-readonly.json'\n\n\n\n\u5909\u6570\u306e\u78ba\u8a8d\ncat << EOF > ${FILE_POLICY}\n{\n        \"Version\":\"2012-10-17\",\n        \"Statement\":[{\n            \"Sid\":\"AddPerm\",\n            \"Effect\":\"Allow\",\n              \"Principal\": \"*\",\n            \"Action\":[\"s3:GetObject\"],\n            \"Resource\":[\"arn:aws:s3:::${S3_BUCKET_NAME}/*\"]\n          }\n        ]\n}\nEOF\n\n\nJSON\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3057\u305f\u3089\u3001\u30d5\u30a9\u30fc\u30de\u30c3\u30c8\u304c\u58ca\u308c\u3066\u306a\u3044\u304b\u5fc5\u305a\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n\u30b3\u30de\u30f3\u30c9\njsonlint -q ${FILE_POLICY}\n\n\n\n\u7d50\u679c\n      (\u623b\u308a\u5024\u306a\u3057)\n\n\n\n6.3. \u8a2d\u5b9a\n\n\u5909\u6570\u306e\u78ba\u8a8d\ncat << ETX\n\n        S3_BUCKET_NAME ${S3_BUCKET_NAME}\n        FILE_POLICY:   ${FILE_POLICY}\n\nETX\n\n\n\n\u30b3\u30de\u30f3\u30c9\naws s3api put-bucket-policy \\\n        --bucket ${S3_BUCKET_NAME} \\\n        --policy file://${FILE_POLICY}\n\n\n\n\u7d50\u679c\n      (\u623b\u308a\u5024\u306a\u3057)\n\n\n\n6.4. \u8a2d\u5b9a\u306e\u78ba\u8a8d\n\n\u30b3\u30de\u30f3\u30c9\naws s3api get-bucket-policy \\\n        --bucket ${S3_BUCKET_NAME} |\\\n        sed 's/\\\\//g' |\\\n        sed 's/\"{/{/' |\\\n        sed 's/}\"/}/' |\\\n        jq .\n\n\n\n\u7d50\u679c\n      {\n        \"Policy\": {\n          \"Version\": \"2012-10-17\",\n          \"Statement\": [\n            {\n              \"Sid\": \"AddPerm\",\n              \"Effect\": \"Allow\",\n              \"Principal\": \"*\",\n              \"Action\": \"s3:GetObject\",\n              \"Resource\": \"arn:aws:s3:::www.example.jp/*\"\n            }\n          ]\n        }\n      }\n\n\n\n7. \u30b3\u30f3\u30c6\u30f3\u30c4\u7528\u30d0\u30b1\u30c3\u30c8\u306e\u8a2d\u5b9a (Website\u8a2d\u5b9a)\n\n7.1. \u8a2d\u5b9a\u306e\u78ba\u8a8d\n\n\u30b3\u30de\u30f3\u30c9\naws s3api get-bucket-website \\\n        --bucket ${S3_BUCKET_NAME}\n\n\n\n\u7d50\u679c(\u4f8b)\n      A client error (NoSuchWebsiteConfiguration) occurred when calling the GetBucketWebsite operation: The specified bucket does not have a website configuration\n\n\n\n7.2. \u8a2d\u5b9a\n\n\u5909\u6570\u306e\u78ba\u8a8d\ncat << ETX\n\n          S3_BUCKET_NAME: ${S3_BUCKET_NAME}\n\nETX\n\n\n\n\u30b3\u30de\u30f3\u30c9\naws s3 website \"s3://${S3_BUCKET_NAME}\" \\\n        --index-document index.html \\\n        --error-document error.html\n\n\n\n\u7d50\u679c\n      (\u623b\u308a\u5024\u306a\u3057)\n\n\n\n7.4. \u8a2d\u5b9a\u306e\u78ba\u8a8d\n\n\u30b3\u30de\u30f3\u30c9\naws s3api get-bucket-website \\\n        --bucket ${S3_BUCKET_NAME}\n\n\n\n\u7d50\u679c\n      {\n          \"IndexDocument\": {\n              \"Suffix\": \"index.html\"\n          },\n          \"ErrorDocument\": {\n              \"Key\": \"error.html\"\n          }\n      }\n\n\n\n8. \u30b3\u30f3\u30c6\u30f3\u30c4\u8ee2\u9001\n\n\u30b3\u30de\u30f3\u30c9\ncd ${DIR_LOCAL_CONTENTS}\n\n\n\n\u30b3\u30de\u30f3\u30c9\naws s3 sync . \"s3://${S3_BUCKET_NAME}/\" \\\n        --exclude \".git*\" \\\n        --exclude \".hg*\"\n\n\n\n9. \u30a2\u30af\u30bb\u30b9\u78ba\u8a8d\n\u30d0\u30b1\u30c3\u30c8\u306eURL\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n\u30b3\u30de\u30f3\u30c9\nS3_BUCKET_ENDPOINT=\"${S3_BUCKET_NAME}.s3-website-`aws s3api get-bucket-location --bucket ${S3_BUCKET_NAME} --output text`.amazonaws.com\" \\\n        && echo ${S3_BUCKET_ENDPOINT}\n\n\n\n\u7d50\u679c(\u4f8b)\n      www.example.jp.s3-website-ap-northeast-1.amazonaws.com\n\n\n\u30d6\u30e9\u30a6\u30b6\u3067\u30a2\u30af\u30bb\u30b9\u3067\u304d\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3057\u307e\u3057\u3087\u3046\u3002\n\n10. CORS\u306e\u8a2d\u5b9a\n\n10.1. \u8a2d\u5b9a\u306e\u78ba\u8a8d\n\n\u30b3\u30de\u30f3\u30c9\naws s3api get-bucket-cors \\\n        --bucket ${S3_BUCKET_NAME}\n\n\n\n\u7d50\u679c(\u4f8b)\n      A client error (NoSuchCORSConfiguration) occurred when calling the GetBucketCors operation: The CORS configuration does not exist\n\n\n\n10.2. \u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u306e\u4f5c\u6210\n\n\u5909\u6570\u306e\u8a2d\u5b9a\nFILE_CORS_RULE=\"${S3_BUCKET_NAME}-cors.json\"\n\n\n\n\u30b3\u30de\u30f3\u30c9\ncat << EOF > ${FILE_CORS_RULE}\n{\n        \"CORSRules\": [\n          {\n            \"AllowedHeaders\": [\n              \"*\"\n            ],\n            \"MaxAgeSeconds\": 3000,\n            \"AllowedMethods\": [\n              \"PUT\"\n            ],\n            \"AllowedOrigins\": [\n              \"http://${S3_BUCKET_ENDPOINT}\"\n            ]\n          }\n        ]\n}\nEOF\n\ncat ${FILE_CORS_RULE}\n\n\nJSON\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3057\u305f\u3089\u3001\u30d5\u30a9\u30fc\u30de\u30c3\u30c8\u304c\u58ca\u308c\u3066\u306a\u3044\u304b\u5fc5\u305a\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n\u30b3\u30de\u30f3\u30c9\njsonlint -q ${FILE_CORS_RULE}\n\n\n\n\u7d50\u679c\n      (\u623b\u308a\u5024\u306a\u3057)\n\n\n\n10.3. \u8a2d\u5b9a\n\n\u30b3\u30de\u30f3\u30c9\naws s3api put-bucket-cors \\\n        --bucket ${S3_BUCKET_NAME} \\\n        --cors-configuration file://${FILE_CORS_RULE}\n\n\n\n\u7d50\u679c\n      (\u623b\u308a\u5024\u306a\u3057)\n\n\n\n10.4. \u8a2d\u5b9a\u306e\u78ba\u8a8d\n\n\u30b3\u30de\u30f3\u30c9\naws s3api get-bucket-cors \\\n        --bucket ${S3_BUCKET_NAME}\n\n\n\n\u7d50\u679c(\u4f8b)\n      {\n        \"CORSRules\": [\n          {\n              \"AllowedHeaders\": [\n                  \"*\"\n              ],\n              \"MaxAgeSeconds\": 3000,\n              \"AllowedMethods\": [\n                  \"PUT\"\n              ],\n              \"AllowedOrigins\": [\n                  \"http://example-handson-20150928.s3-website-ap-northeast-1.amazonaws.com\"\n              ]\n          }\n        ]\n      }\n\n\n\n\u5b8c\u4e86\nCognito\u3067\u8b58\u5225\u5b50\u30d7\u30fc\u30eb\u3092\u4f5c\u6210\u3057\u3001\u30b3\u30f3\u30c6\u30f3\u30c4\u3092\u7f6e\u304d\u307e\u3059\u3002\n\n\u8b58\u5225\u5b50\u30d7\u30fc\u30eb\u306e\u4f5c\u6210: http://qiita.com/tcsh/items/be3c65d7c66f19169b2b\n\n\u30b3\u30f3\u30c6\u30f3\u30c4\u306e\u4f5c\u6210: http://qiita.com/tcsh/items/61727b244e95368d8c16\n\nIAM\u30ed\u30fc\u30eb\u306e\u4f5c\u6210: http://qiita.com/tcsh/items/ce884d7b285999f858b7\n\n\nAWS CLI\u3092\u5229\u7528\u3057\u3066\u3001S3\u4e0a\u306bPOST\u53ef\u80fd\u306aWeb\u30b5\u30a4\u30c8\u3092\u4f5c\u6210\u3057\u3066\u307f\u307e\u3059\u3002\n\n\n\u524d\u63d0\u6761\u4ef6\n========\n\n\nS3\u3078\u306e\u6a29\u9650\n----------\n\n* S3\u306b\u5bfe\u3057\u3066\u30d5\u30eb\u6a29\u9650\u304c\u3042\u308b\u3053\u3068\u3002\n\n\nAWS CLI\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\n-------------------\n\n* \u4ee5\u4e0b\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u3067\u52d5\u4f5c\u78ba\u8a8d\u6e08\n\n  * AWS CLI 1.8.3\n\n```bash:\u30b3\u30de\u30f3\u30c9:\naws --version\n```\n\n```text:\u7d50\u679c(\u4f8b):\n      aws-cli/1.8.3 Python/2.7.5 Darwin/13.4.0\n```\n\n\n0. \u6e96\u5099\n=======\n\n\n0.1. \u30ea\u30fc\u30b8\u30e7\u30f3\u306e\u6c7a\u5b9a\n---------------------\n\nWeb\u30b5\u30a4\u30c8\u3092\u69cb\u7bc9\u3059\u308b\u30ea\u30fc\u30b8\u30e7\u30f3\u3092\u6c7a\u3081\u307e\u3059\u3002\n\n(\u30ab\u30ec\u30f3\u30c8\u30e6\u30fc\u30b6\u304c\u5229\u7528\u3059\u308b\u30ab\u30ec\u30f3\u30c8\u30ea\u30fc\u30b8\u30e7\u30f3\u3082\u5207\u308a\u5909\u308f\u308a\u307e\u3059\u3002)\n\n```bash:\u30b3\u30de\u30f3\u30c9(\u6771\u4eac\u30ea\u30fc\u30b8\u30e7\u30f3\u306e\u5834\u5408):\nexport AWS_DEFAULT_REGION='ap-northeast-1'\n```\n\n0.2. \u5909\u6570\u306e\u78ba\u8a8d\n---------------\n\n\u30d7\u30ed\u30d5\u30a1\u30a4\u30eb\u3068\u30ea\u30fc\u30b8\u30e7\u30f3\u304c\u60f3\u5b9a\u306e\u3082\u306e\u306b\u306a\u3063\u3066\u3044\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n```bash:\u5909\u6570\u306e\u78ba\u8a8d:\naws configure list\n```\n\n```text:\u7d50\u679c(\u4f8b):\n\n            Name                    Value             Type    Location\n            ----                    -----             ----    --------\n         profile        s3Full-prjZ-mbp13              env    AWS_DEFAULT_PROFILE\n      access_key     ****************LOAQ shared-credentials-file\n      secret_key     ****************I1O1 shared-credentials-file\n          region           ap-northeast-1              env    AWS_DEFAULT_REGION\n```\n\n\n1. \u4e8b\u524d\u4f5c\u696d\n===========\n\n\n1.1. \u30b5\u30a4\u30c8\u540d\u306e\u6c7a\u5b9a\n-------------------\n\n\u7d44\u7e54\u540d-handson-\u4eca\u65e5\u306e\u65e5\u4ed8\u3068\u3057\u307e\u3059\u3002\n\n```bash:\u5909\u6570\u306e\u8a2d\u5b9a:\nORG=<\u7d44\u7e54\u540d>\nHOSTNAME_WEBSITE=\"${ORG}-handson-`date +%Y%m%d`\"\n\necho ${HOSTNAME_WEBSITE}\n```\n\n\n1.2. \u30b3\u30f3\u30c6\u30f3\u30c4\u7528\u30d0\u30b1\u30c3\u30c8\u540d\u306e\u6c7a\u5b9a\n---------------------------------\n\n```bash:\u5909\u6570\u306e\u8a2d\u5b9a:\nS3_BUCKET_SITE=\"${HOSTNAME_WEBSITE}\" \\\n        && echo ${S3_BUCKET_SITE}\n```\n\n\u540c\u540d\u306e\u30d0\u30b1\u30c3\u30c8\u304c\u5b58\u5728\u3057\u306a\u3044\u3053\u3068\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n```bash:\u30b3\u30de\u30f3\u30c9:\naws s3 ls s3://${S3_BUCKET_SITE}\n```\n\n```text:\u7d50\u679c(\u4f8b):\n      A client error (NoSuchBucket) occurred when calling the ListObjects operation: The specified bucket does not exist\n```\n\n\n1.3. \u30ed\u30b0\u7528\u30d0\u30b1\u30c3\u30c8\u540d\u306e\u6c7a\u5b9a\n---------------------------\n\n```bash:\u5909\u6570\u306e\u8a2d\u5b9a:\nS3_BUCKET_LOG=\"${S3_BUCKET_SITE}-log\" \\\n        && echo ${S3_BUCKET_LOG}\n```\n\n\u540c\u540d\u306e\u30d0\u30b1\u30c3\u30c8\u304c\u5b58\u5728\u3057\u306a\u3044\u3053\u3068\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n```bash:\u30b3\u30de\u30f3\u30c9:\naws s3 ls s3://${S3_BUCKET_LOG}\n```\n\n```text:\u7d50\u679c(\u4f8b)\n      A client error (NoSuchBucket) occurred when calling the ListObjects operation: The specified bucket does not exist\n```\n\n\n1.4. \u30ed\u30fc\u30ab\u30eb\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u4f5c\u6210\n-----------------------------\n\n```bash:\u5909\u6570\u306e\u8a2d\u5b9a:\nDIR_LOCAL_CONTENTS=\"$(pwd)/file-bucket\" \\\n        && echo ${DIR_LOCAL_CONTENTS}\n```\n\n```bash:\u30b3\u30de\u30f3\u30c9:\nmkdir -p ${DIR_LOCAL_CONTENTS} \\\n        && cd ${DIR_LOCAL_CONTENTS}\n```\n\n\n1.5. index.html, error.html\u4f5c\u6210\n-------------------------------\n\n```bash:\u30b3\u30de\u30f3\u30c9:\ncd ${DIR_LOCAL_CONTENTS}\n```\n\n```bash:\u30b3\u30de\u30f3\u30c9:\ncat << EOF > index.html\n      <!DOCTYPE html>\n      <html lang=\"ja\">\n      <head>\n        <meta charset=\"utf-8\">\n        <title>Title</title>\n      </head>\n\n      <body>\n\n      <h1>Hello!</h1>\n      <!-- comment -->\n\n      </body>\n      </html>\nEOF\n\ncat index.html\n```\n\n```bash:\u30b3\u30de\u30f3\u30c9:\ncat << EOF > error.html\n      <!DOCTYPE html>\n      <html lang=\"ja\">\n\n      <head>\n        <meta charset=\"UTF-8\">\n      </head>\n\n      <body>\n        <h1>404 File Not Found</h1>\n        <p>\u304a\u63a2\u3057\u306e\u30da\u30fc\u30b8\u306f\u898b\u3064\u304b\u308a\u307e\u305b\u3093\u3002</p>\n      </body>\n      </html>\nEOF\n\ncat error.html\n```\n\n\n2. \u30b3\u30f3\u30c6\u30f3\u30c4\u7528\u30d0\u30b1\u30c3\u30c8\u306e\u4f5c\u6210\n=============================\n\n```bash:\u5909\u6570\u306e\u8a2d\u5b9a:\nS3_BUCKET_NAME=\"${S3_BUCKET_SITE}\" \\\n        && echo ${S3_BUCKET_NAME}\n```\n\n```bash:\u5909\u6570\u306e\u78ba\u8a8d:\ncat << ETX\n\n          S3_BUCKET_NAME: ${S3_BUCKET_NAME}\n\nETX\n```\n\n```bash:\u30b3\u30de\u30f3\u30c9:\naws s3 mb s3://${S3_BUCKET_NAME}\n```\n\n\n```text:\u7d50\u679c(\u4f8b):\n      make_bucket: s3://www.example.jp/\n```\n\n```bash:\u30b3\u30de\u30f3\u30c9:\naws s3api get-bucket-location --bucket ${S3_BUCKET_NAME}\n```\n\n```json:\u7d50\u679c(\u4f8b):\n      {\n        \"LocationConstraint\": \"ap-northeast-1\"\n      }\n```\n\n\n3. \u30ed\u30b0\u7528\u30d0\u30b1\u30c3\u30c8\u306e\u4f5c\u6210/\u8a2d\u5b9a\n============================\n\n\n3.1.  \u30ed\u30b0\u7528\u30d0\u30b1\u30c3\u30c8\u306e\u4f5c\u6210\n--------------------------\n\n```bash:\u5909\u6570\u306e\u8a2d\u5b9a:\nS3_BUCKET_NAME=\"${S3_BUCKET_LOG}\" \\\n        && echo ${S3_BUCKET_NAME}\n```\n\n```bash:\u5909\u6570\u306e\u78ba\u8a8d:\ncat << ETX\n\n          S3_BUCKET_NAME: ${S3_BUCKET_NAME}\n\nETX\n```\n\n```bash:\u30b3\u30de\u30f3\u30c9:\naws s3 mb s3://${S3_BUCKET_NAME}\n```\n\n\n```text:\u7d50\u679c(\u4f8b):\n      make_bucket: s3://www.example.jp-log/\n```\n\n```bash:\u30b3\u30de\u30f3\u30c9:\naws s3api get-bucket-location --bucket ${S3_BUCKET_NAME}\n```\n\n```json:\u7d50\u679c(\u4f8b):\n      {\n        \"LocationConstraint\": \"ap-northeast-1\"\n      }\n```\n\n\n3.2. \u30d0\u30b1\u30c3\u30c8ACL\u306e\u78ba\u8a8d\n----------------------\n\n```bash:\u30b3\u30de\u30f3\u30c9:\naws s3api get-bucket-acl \\\n        --bucket ${S3_BUCKET_NAME}\n```\n\n```json:\u7d50\u679c(\u4f8b):\n      {\n        \"Owner\": {\n          \"DisplayName\": \"prjz\",\n          \"ID\": \"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\"\n        },\n        \"Grants\": [\n          {\n              \"Grantee\": {\n                  \"DisplayName\": \"prjz\",\n                  \"ID\": \"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\"\n              },\n              \"Permission\": \"FULL_CONTROL\"\n          }\n        ]\n      }\n```\n\n\n3.3. \u30d0\u30b1\u30c3\u30c8ACL\u306e\u5909\u66f4\n----------------------\n\n```bash:\u5909\u6570\u306e\u78ba\u8a8d:\ncat << ETX\n\n          S3_BUCKET_NAME: ${S3_BUCKET_NAME}\n\nETX\n```\n\n\n```bash:\u30b3\u30de\u30f3\u30c9:\naws s3api put-bucket-acl \\\n        --bucket ${S3_BUCKET_NAME} \\\n        --grant-write 'URI=\"http://acs.amazonaws.com/groups/s3/LogDelivery\"' \\\n        --grant-read-acp 'URI=\"http://acs.amazonaws.com/groups/s3/LogDelivery\"'\n```\n\n```text:\u7d50\u679c(\u4f8b):\n      (\u623b\u308a\u5024\u306a\u3057)\n```\n\n\u6ce8\u91c8: \u30d5\u30eb\u30b3\u30f3\u30c8\u30ed\u30fc\u30eb\u306e\u8a2d\u5b9a\u304c\u6d88\u3048\u308b\u305f\u3081\u3001\u30aa\u30fc\u30ca\u306f\u30ed\u30b0\u306e\u524a\u9664\u304c\u3067\u304d\u306a\u304f\u306a\u308a\u307e\u3059\u3002 (\u5fc5\u8981\u304c\u3042\u308b\u5834\u5408\u306f\u3001grant-full-control\u3067\u6307\u5b9a\u3059\u308b\u3002)\n\n\n3.4. \u30d0\u30b1\u30c3\u30c8ACL\u306e\u78ba\u8a8d\n----------------------\n\n```bash:\u30b3\u30de\u30f3\u30c9:\naws s3api get-bucket-acl \\\n        --bucket ${S3_BUCKET_NAME}\n```\n\n```json:\u7d50\u679c(\u4f8b):\n      {\n        \"Owner\": {\n          \"DisplayName\": \"prjz\",\n          \"ID\": \"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\"\n        },\n        \"Grants\": [\n          {\n              \"Grantee\": {\n                  \"URI\": \"http://acs.amazonaws.com/groups/s3/LogDelivery\"\n              },\n              \"Permission\": \"WRITE\"\n          },\n          {\n              \"Grantee\": {\n                  \"URI\": \"http://acs.amazonaws.com/groups/s3/LogDelivery\"\n              },\n              \"Permission\": \"READ_ACP\"\n          }\n        ]\n      }\n```\n\n\n4. \u30ed\u30b0\u7528\u30d0\u30b1\u30c3\u30c8\u306e\u8a2d\u5b9a (\u30ed\u30b0\u30ed\u30fc\u30c6\u30fc\u30b7\u30e7\u30f3\u306e\u8a2d\u5b9a)\n==================================================\n\n\n4.1. \u8a2d\u5b9a\u306e\u78ba\u8a8d\n---------------\n\n```bash:\u5909\u6570\u306e\u78ba\u8a8d:\ncat << ETX\n\n        S3_BUCKET_NAME:    ${S3_BUCKET_NAME}\n\nETX\n```\n\n```bash:\u30b3\u30de\u30f3\u30c9:\naws s3api get-bucket-lifecycle \\\n        --bucket ${S3_BUCKET_NAME}\n```\n\n```text:\u7d50\u679c(\u4f8b):\n      A client error (NoSuchLifecycleConfiguration) occurred when calling the GetBucketLifecycle operation: The lifecycle configuration does not exist\n```\n\n\n4.2. \u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u306e\u4f5c\u6210\n-----------------------\n\n```bash:\u5909\u6570\u306e\u8a2d\u5b9a:\nFILE_S3_LIFECYCLE='s3-lifecycle.json'\nS3_LIFECYCLE_EXPIRE_DAYS='60'\nS3_LIFECYCLE_TRANS_DAYS='30'\nS3_LIFECYCLE_ID=\"${S3_BUCKET_NAME}-Archive\"\n```\n\nS3_LIFECYCLE_ID\u306f\u3001Lifecycle Rules\u306eRule Name\u306b\u306a\u308a\u307e\u3059\u3002(\u30de\u30cd\u30b8\u30e1\u30f3\u30c8\u30b3\u30f3\u30bd\u30fc\u30eb\u4e0a\u3067\u306f\u30aa\u30d7\u30b7\u30e7\u30f3\u6271\u3044)\n\n```bash:\u30b3\u30de\u30f3\u30c9:\ncat << EOF > ${FILE_S3_LIFECYCLE}\n{\n        \"Rules\": [\n          {\n            \"Expiration\": {\n              \"Days\": ${S3_LIFECYCLE_EXPIRE_DAYS}\n            },\n            \"ID\": \"${S3_LIFECYCLE_ID}\",\n            \"Prefix\": \"Logs/\",\n            \"Status\": \"Enabled\",\n            \"Transition\": {\n              \"Days\": ${S3_LIFECYCLE_TRANS_DAYS},\n              \"StorageClass\": \"GLACIER\"\n            }\n          }\n        ]\n}\nEOF\n```\n\nJSON\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3057\u305f\u3089\u3001\u30d5\u30a9\u30fc\u30de\u30c3\u30c8\u304c\u58ca\u308c\u3066\u306a\u3044\u304b\u5fc5\u305a\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n```bash:\u30b3\u30de\u30f3\u30c9:\njsonlint -q ${FILE_S3_LIFECYCLE}\n```\n\n```text:\u7d50\u679c:\n      (\u623b\u308a\u5024\u306a\u3057)\n```\n\n\n4.3. \u8a2d\u5b9a\n---------\n\n```bash:\u5909\u6570\u306e\u78ba\u8a8d:\ncat << ETX\n\n        S3_BUCKET_NAME:    ${S3_BUCKET_NAME}\n        FILE_S3_LIFECYCLE: ${FILE_S3_LIFECYCLE}\n\nETX\n```\n\n```bash:\u30b3\u30de\u30f3\u30c9:\naws s3api put-bucket-lifecycle \\\n        --bucket ${S3_BUCKET_NAME} \\\n        --lifecycle-configuration file://${FILE_S3_LIFECYCLE}\n```\n\n```text:\u7d50\u679c:\n      (\u623b\u308a\u5024\u306a\u3057)\n```\n\n\n4.4. \u8a2d\u5b9a\u306e\u78ba\u8a8d\n---------------\n\n```bash:\u30b3\u30de\u30f3\u30c9:\naws s3api get-bucket-lifecycle \\\n        --bucket ${S3_BUCKET_NAME}\n```\n\n```json:\u7d50\u679c:\n      {\n        \"Rules\": [\n          {\n              \"Status\": \"Enabled\",\n              \"Prefix\": \"/Logs\",\n              \"Transition\": {\n                  \"Days\": 1,\n                  \"StorageClass\": \"GLACIER\"\n              },\n              \"Expiration\": {\n                  \"Days\": 2\n              },\n              \"ID\": \"www.example.jp-log-Archive\"\n          }\n        ]\n      }\n```\n\n\n5. \u30b3\u30f3\u30c6\u30f3\u30c4\u7528\u30d0\u30b1\u30c3\u30c8\u306e\u8a2d\u5b9a (\u30ed\u30b0\u4fdd\u5b58)\n========================================\n\n```bash:\u5909\u6570\u306e\u8a2d\u5b9a:\nS3_BUCKET_NAME=\"${S3_BUCKET_SITE}\" \\\n        && echo ${S3_BUCKET_NAME}\n```\n\n\n5.1. \u30ed\u30b0\u4fdd\u5b58\u8a2d\u5b9a\u306e\u78ba\u8a8d\n-----------------------\n\n```bash:\u30b3\u30de\u30f3\u30c9:\naws s3api get-bucket-logging \\\n        --bucket ${S3_BUCKET_NAME}\n```\n\n```text:\u7d50\u679c:\n      (\u623b\u308a\u5024\u306a\u3057)\n```\n\n\n5.2. \u30ed\u30b0\u4fdd\u5b58\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u306e\u4f5c\u6210\n-------------------------------\n\n```bash:\u5909\u6570\u306e\u8a2d\u5b9a:\nFILE_S3_LOGGING='s3-logging.json'\n```\n\n```bash:\u30b3\u30de\u30f3\u30c9:\ncat << EOF > ${FILE_S3_LOGGING}\n{\n        \"LoggingEnabled\": {\n          \"TargetBucket\": \"${S3_BUCKET_LOG}\",\n          \"TargetPrefix\": \"/Logs\"\n        }\n}\nEOF\n```\n\nJSON\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3057\u305f\u3089\u3001\u30d5\u30a9\u30fc\u30de\u30c3\u30c8\u304c\u58ca\u308c\u3066\u306a\u3044\u304b\u5fc5\u305a\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n```bash:\u30b3\u30de\u30f3\u30c9:\njsonlint -q ${FILE_S3_LOGGING}\n```\n\n```text:\u7d50\u679c:\n      (\u623b\u308a\u5024\u306a\u3057)\n```\n\n\n5.3. \u30ed\u30b0\u4fdd\u5b58\u306e\u8a2d\u5b9a\n-------------------\n\n```bash:\u5909\u6570\u306e\u78ba\u8a8d:\ncat << ETX\n\n        S3_BUCKET_NAME:  ${S3_BUCKET_NAME}\n        FILE_S3_LOGGING: ${FILE_S3_LOGGING}\n\nETX\n```\n\n```bash:\u30b3\u30de\u30f3\u30c9:\naws s3api put-bucket-logging \\\n        --bucket ${S3_BUCKET_NAME} \\\n        --bucket-logging-status file://${FILE_S3_LOGGING}\n```\n\n```text:\u7d50\u679c:\n      (\u623b\u308a\u5024\u306a\u3057)\n```\n\n\n5.4. \u30ed\u30b0\u4fdd\u5b58\u8a2d\u5b9a\u306e\u78ba\u8a8d\n-----------------------\n\n```bash:\u30b3\u30de\u30f3\u30c9:\naws s3api get-bucket-logging \\\n        --bucket ${S3_BUCKET_NAME}\n```\n\n```json:\u7d50\u679c(\u4f8b):\n      {\n        \"LoggingEnabled\": {\n          \"TargetPrefix\": \"/Logs\",\n          \"TargetBucket\": \"www.example.jp-log\"\n        }\n      }\n```\n\n\n6. \u30b3\u30f3\u30c6\u30f3\u30c4\u7528\u30d0\u30b1\u30c3\u30c8\u306e\u8a2d\u5b9a (\u30d0\u30b1\u30c3\u30c8\u30dd\u30ea\u30b7)\n==============================================\n\n\n6.1. \u8a2d\u5b9a\u306e\u78ba\u8a8d\n---------------\n\n```bash:\u5909\u6570\u306e\u78ba\u8a8d:\ncat << ETX\n\n        S3_BUCKET_NAME:  ${S3_BUCKET_NAME}\n\nETX\n```\n\n```bash:\u30b3\u30de\u30f3\u30c9:\naws s3api get-bucket-policy \\\n        --bucket ${S3_BUCKET_NAME} |\\\n        sed 's/\\\\//g' |\\\n        sed 's/\"{/{/' |\\\n        sed 's/}\"/}/' |\\\n        jq .\n```\n\n```text:\u7d50\u679c(\u4f8b):\n      A client error (NoSuchBucketPolicy) occurred when calling the GetBucketPolicy operation: The bucket policy does not exist\n```\n\n\n6.2. \u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u306e\u4f5c\u6210\n-----------------------\n\n```bash:\u5909\u6570\u306e\u8a2d\u5b9a:\nFILE_POLICY='s3-policy-readonly.json'\n```\n\n```bash:\u5909\u6570\u306e\u78ba\u8a8d:\ncat << EOF > ${FILE_POLICY}\n{\n        \"Version\":\"2012-10-17\",\n        \"Statement\":[{\n            \"Sid\":\"AddPerm\",\n            \"Effect\":\"Allow\",\n              \"Principal\": \"*\",\n            \"Action\":[\"s3:GetObject\"],\n            \"Resource\":[\"arn:aws:s3:::${S3_BUCKET_NAME}/*\"]\n          }\n        ]\n}\nEOF\n```\n\nJSON\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3057\u305f\u3089\u3001\u30d5\u30a9\u30fc\u30de\u30c3\u30c8\u304c\u58ca\u308c\u3066\u306a\u3044\u304b\u5fc5\u305a\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n```bash:\u30b3\u30de\u30f3\u30c9:\njsonlint -q ${FILE_POLICY}\n```\n\n```text:\u7d50\u679c:\n      (\u623b\u308a\u5024\u306a\u3057)\n```\n\n\n6.3. \u8a2d\u5b9a\n---------\n\n```bash:\u5909\u6570\u306e\u78ba\u8a8d:\ncat << ETX\n\n        S3_BUCKET_NAME ${S3_BUCKET_NAME}\n        FILE_POLICY:   ${FILE_POLICY}\n\nETX\n```\n\n```bash:\u30b3\u30de\u30f3\u30c9:\naws s3api put-bucket-policy \\\n        --bucket ${S3_BUCKET_NAME} \\\n        --policy file://${FILE_POLICY}\n```\n\n```text:\u7d50\u679c:\n      (\u623b\u308a\u5024\u306a\u3057)\n```\n\n\n6.4. \u8a2d\u5b9a\u306e\u78ba\u8a8d\n---------------\n\n```bash:\u30b3\u30de\u30f3\u30c9:\naws s3api get-bucket-policy \\\n        --bucket ${S3_BUCKET_NAME} |\\\n        sed 's/\\\\//g' |\\\n        sed 's/\"{/{/' |\\\n        sed 's/}\"/}/' |\\\n        jq .\n```\n\n```json:\u7d50\u679c:\n      {\n        \"Policy\": {\n          \"Version\": \"2012-10-17\",\n          \"Statement\": [\n            {\n              \"Sid\": \"AddPerm\",\n              \"Effect\": \"Allow\",\n              \"Principal\": \"*\",\n              \"Action\": \"s3:GetObject\",\n              \"Resource\": \"arn:aws:s3:::www.example.jp/*\"\n            }\n          ]\n        }\n      }\n```\n\n\n7. \u30b3\u30f3\u30c6\u30f3\u30c4\u7528\u30d0\u30b1\u30c3\u30c8\u306e\u8a2d\u5b9a (Website\u8a2d\u5b9a)\n===========================================\n\n\n7.1. \u8a2d\u5b9a\u306e\u78ba\u8a8d\n---------------\n\n```bash:\u30b3\u30de\u30f3\u30c9:\naws s3api get-bucket-website \\\n        --bucket ${S3_BUCKET_NAME}\n```\n\n```text:\u7d50\u679c(\u4f8b):\n      A client error (NoSuchWebsiteConfiguration) occurred when calling the GetBucketWebsite operation: The specified bucket does not have a website configuration\n```\n\n\n7.2. \u8a2d\u5b9a\n---------\n\n```bash:\u5909\u6570\u306e\u78ba\u8a8d:\ncat << ETX\n\n          S3_BUCKET_NAME: ${S3_BUCKET_NAME}\n\nETX\n```\n\n```bash:\u30b3\u30de\u30f3\u30c9:\naws s3 website \"s3://${S3_BUCKET_NAME}\" \\\n        --index-document index.html \\\n        --error-document error.html\n```\n\n```text:\u7d50\u679c:\n      (\u623b\u308a\u5024\u306a\u3057)\n```\n\n\n7.4. \u8a2d\u5b9a\u306e\u78ba\u8a8d\n---------------\n\n```bash:\u30b3\u30de\u30f3\u30c9:\naws s3api get-bucket-website \\\n        --bucket ${S3_BUCKET_NAME}\n```\n\n```json:\u7d50\u679c:\n      {\n          \"IndexDocument\": {\n              \"Suffix\": \"index.html\"\n          },\n          \"ErrorDocument\": {\n              \"Key\": \"error.html\"\n          }\n      }\n```\n\n\n8. \u30b3\u30f3\u30c6\u30f3\u30c4\u8ee2\u9001\n=================\n\n```bash:\u30b3\u30de\u30f3\u30c9:\ncd ${DIR_LOCAL_CONTENTS}\n```\n\n```bash:\u30b3\u30de\u30f3\u30c9:\naws s3 sync . \"s3://${S3_BUCKET_NAME}/\" \\\n        --exclude \".git*\" \\\n        --exclude \".hg*\"\n```\n\n\n9. \u30a2\u30af\u30bb\u30b9\u78ba\u8a8d\n===============\n\n\u30d0\u30b1\u30c3\u30c8\u306eURL\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n```bash:\u30b3\u30de\u30f3\u30c9:\nS3_BUCKET_ENDPOINT=\"${S3_BUCKET_NAME}.s3-website-`aws s3api get-bucket-location --bucket ${S3_BUCKET_NAME} --output text`.amazonaws.com\" \\\n        && echo ${S3_BUCKET_ENDPOINT}\n```\n\n```text:\u7d50\u679c(\u4f8b):\n      www.example.jp.s3-website-ap-northeast-1.amazonaws.com\n```\n\n\u30d6\u30e9\u30a6\u30b6\u3067\u30a2\u30af\u30bb\u30b9\u3067\u304d\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3057\u307e\u3057\u3087\u3046\u3002\n\n\n10. CORS\u306e\u8a2d\u5b9a\n==============\n\n\n10.1. \u8a2d\u5b9a\u306e\u78ba\u8a8d\n----------------\n\n```bash:\u30b3\u30de\u30f3\u30c9:\naws s3api get-bucket-cors \\\n        --bucket ${S3_BUCKET_NAME}\n```\n\n```text:\u7d50\u679c(\u4f8b)\n      A client error (NoSuchCORSConfiguration) occurred when calling the GetBucketCors operation: The CORS configuration does not exist\n```\n\n\n10.2. \u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u306e\u4f5c\u6210\n------------------------\n\n```bash:\u5909\u6570\u306e\u8a2d\u5b9a:\nFILE_CORS_RULE=\"${S3_BUCKET_NAME}-cors.json\"\n```\n\n```bash:\u30b3\u30de\u30f3\u30c9:\ncat << EOF > ${FILE_CORS_RULE}\n{\n        \"CORSRules\": [\n          {\n            \"AllowedHeaders\": [\n              \"*\"\n            ],\n            \"MaxAgeSeconds\": 3000,\n            \"AllowedMethods\": [\n              \"PUT\"\n            ],\n            \"AllowedOrigins\": [\n              \"http://${S3_BUCKET_ENDPOINT}\"\n            ]\n          }\n        ]\n}\nEOF\n\ncat ${FILE_CORS_RULE}\n```\n\nJSON\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3057\u305f\u3089\u3001\u30d5\u30a9\u30fc\u30de\u30c3\u30c8\u304c\u58ca\u308c\u3066\u306a\u3044\u304b\u5fc5\u305a\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n```bash:\u30b3\u30de\u30f3\u30c9:\njsonlint -q ${FILE_CORS_RULE}\n```\n\n```text:\u7d50\u679c:\n      (\u623b\u308a\u5024\u306a\u3057)\n```\n\n\n10.3. \u8a2d\u5b9a\n----------\n\n```bash:\u30b3\u30de\u30f3\u30c9:\naws s3api put-bucket-cors \\\n        --bucket ${S3_BUCKET_NAME} \\\n        --cors-configuration file://${FILE_CORS_RULE}\n```\n\n```text:\u7d50\u679c:\n      (\u623b\u308a\u5024\u306a\u3057)\n```\n\n\n10.4. \u8a2d\u5b9a\u306e\u78ba\u8a8d\n----------------\n\n```bash:\u30b3\u30de\u30f3\u30c9:\naws s3api get-bucket-cors \\\n        --bucket ${S3_BUCKET_NAME}\n```\n\n```json:\u7d50\u679c(\u4f8b)\n      {\n        \"CORSRules\": [\n          {\n              \"AllowedHeaders\": [\n                  \"*\"\n              ],\n              \"MaxAgeSeconds\": 3000,\n              \"AllowedMethods\": [\n                  \"PUT\"\n              ],\n              \"AllowedOrigins\": [\n                  \"http://example-handson-20150928.s3-website-ap-northeast-1.amazonaws.com\"\n              ]\n          }\n        ]\n      }\n```\n\n\n\u5b8c\u4e86\n====\n\nCognito\u3067\u8b58\u5225\u5b50\u30d7\u30fc\u30eb\u3092\u4f5c\u6210\u3057\u3001\u30b3\u30f3\u30c6\u30f3\u30c4\u3092\u7f6e\u304d\u307e\u3059\u3002\n\n- \u8b58\u5225\u5b50\u30d7\u30fc\u30eb\u306e\u4f5c\u6210: http://qiita.com/tcsh/items/be3c65d7c66f19169b2b\n- \u30b3\u30f3\u30c6\u30f3\u30c4\u306e\u4f5c\u6210: http://qiita.com/tcsh/items/61727b244e95368d8c16\n- IAM\u30ed\u30fc\u30eb\u306e\u4f5c\u6210: http://qiita.com/tcsh/items/ce884d7b285999f858b7\n"}