{"tags": ["openstack", "nova"], "context": " More than 1 year has passed since last update.\n\nWhat's this?\nNova instance \u304c\u7a3c\u50cd\u3057\u3066\u3044\u308b compute node \u304c\u969c\u5bb3\u505c\u6b62\u3057\u305f\u969b\u306b\u3001\u5168\u3066\u306e Nova instance \u3092\u5225\u306e AZ \u306e compute node \u4e0a\u306b\u5fa9\u65e7(=\u9000\u907f)\n\nNova instance \u3092\u505c\u6b62\u305b\u305a\u30ea\u30a2\u30eb\u30bf\u30a4\u30e0\u306b\u5225\u306e compute node \u306b\u79fb\u52d5\u3059\u308b\u6a5f\u80fd\u3067\u306f\u306a\u3044\n\u3042\u304f\u307e\u3067 shared storage \u4e0a\u306e\u30c7\u30fc\u30bf\u3092\u4f7f\u7528\u3057\u3066\u3001\u5225\u306e compute node \u3067\u8d77\u52d5\u3057\u76f4\u3059\u6a5f\u80fd\n\n[\u6761\u4ef6]\n\nShared storage \u3042\u308a\nNova instance \u306e\u5168\u30c7\u30fc\u30bf\u306f Shared storage \u306b\u3042\u308b\n\u8ffd\u52a0 Volume \u3068\u3057\u3066\u306e Cinder \u672a\u4f7f\u7528\nHypervisor \u306f KVM\n\n\nInitial state\n\nCompute node\n# nova service-list | egrep \"Host|nova-compute\"\n| Binary           | Host    | Zone     | Status  | State | Updated_at                 | Disabled Reason |\n| nova-compute     | node-27 | nova     | enabled | up    | 2015-03-23T03:06:42.000000 | -               |\n| nova-compute     | node-28 | nova     | enabled | up    | 2015-03-23T03:06:51.000000 | -               |\n| nova-compute     | node-31 | nova2    | enabled | up    | 2015-03-23T03:06:45.000000 | -               |\n\n\nAZ\n# nova availability-zone-list | egrep -A 10 \"^\\| nova\"\n| nova                     | available                              |\n| |- node-27               |                                        |\n| | |- nova-compute        | enabled :-) 2015-03-23T03:07:02.000000 |\n| |- node-28               |                                        |\n| | |- nova-compute        | enabled :-) 2015-03-23T03:07:01.000000 |\n| nova2                    | available                              |\n| |- node-31               |                                        |\n| | |- nova-compute        | enabled :-) 2015-03-23T03:06:55.000000 |\n+--------------------------+----------------------------------------+\n\n\nTwo Nova instances are running on node-31 of AZ:nova2\n# nova list --field name,status,OS-EXT-STS:vm_state,OS-EXT-AZ:availability_zone,OS-EXT-SRV-ATTR:hypervisor_hostname\n+--------------------------------------+------------+--------+----------------------+------------------------------+--------------------------------------+\n| ID                                   | Name       | Status | OS-EXT-STS: Vm State | OS-EXT-AZ: Availability Zone | OS-EXT-SRV-ATTR: Hypervisor Hostname |\n+--------------------------------------+------------+--------+----------------------+------------------------------+--------------------------------------+\n| fecc412e-529f-43ad-b6b5-db2afdb4d0b6 | admin_vm11 | ACTIVE | active               | nova2                        | node-31                              |\n| cb20a4e6-8c4e-4760-94a5-d4f4f1ca618e | admin_vm12 | ACTIVE | active               | nova2                        | node-31                              |\n+--------------------------------------+------------+--------+----------------------+------------------------------+--------------------------------------+\n\n\nStop nova-compute service of node-31\n\nStop nova-compute service\n# service openstack-nova-compute stop\n\n# nova service-list | egrep \"Host|nova-compute\"\n| Binary           | Host    | Zone     | Status  | State | Updated_at                 | Disabled Reason |\n| nova-compute     | node-27 | nova     | enabled | up    | 2015-03-23T04:29:43.000000 | -               |\n| nova-compute     | node-28 | nova     | enabled | up    | 2015-03-23T04:29:44.000000 | -               |\n| nova-compute     | node-31 | nova2    | enabled | down  | 2015-03-23T04:28:45.000000 | -               |\n\n\nAZ\n# nova availability-zone-list | egrep -A 10 \"^\\| nova\"\n| nova                     | available                              |\n| |- node-27               |                                        |\n| | |- nova-compute        | enabled :-) 2015-03-23T04:29:53.000000 |\n| |- node-28               |                                        |\n| | |- nova-compute        | enabled :-) 2015-03-23T04:29:54.000000 |\n| nova2                    | available                              |\n| |- node-31               |                                        |\n| | |- nova-compute        | enabled XXX 2015-03-23T04:28:45.000000 |\n+--------------------------+----------------------------------------+\n\n\nEvacuate\n\nExecute host-evacuate\nEvacuate all Nova instances from node-31(inactive) of AZ:nova2 to node-28(active) of AZ:nova\n# nova --debug host-evacuate  --target_host node-28 --on-shared-storage node-31\n+--------------------------------------+-------------------+---------------+\n| Server UUID                          | Evacuate Accepted | Error Message |\n+--------------------------------------+-------------------+---------------+\n| fecc412e-529f-43ad-b6b5-db2afdb4d0b6 | True              |               |\n| cb20a4e6-8c4e-4760-94a5-d4f4f1ca618e | True              |               |\n+--------------------------------------+-------------------+---------------+\n\n\nCheck the evacuate result\nTwo Nova instances are running on node-28 by using the previous data stored in shared storage\n# nova list --field name,status,OS-EXT-STS:vm_state,OS-EXT-AZ:availability_zone,OS-EXT-SRV-ATTR:hypervisor_hostname\n+--------------------------------------+------------+--------+----------------------+------------------------------+--------------------------------------+\n| ID                                   | Name       | Status | OS-EXT-STS: Vm State | OS-EXT-AZ: Availability Zone | OS-EXT-SRV-ATTR: Hypervisor Hostname |\n+--------------------------------------+------------+--------+----------------------+------------------------------+--------------------------------------+\n| fecc412e-529f-43ad-b6b5-db2afdb4d0b6 | admin_vm11 | ACTIVE | active               | nova                         | node-28                              |\n| cb20a4e6-8c4e-4760-94a5-d4f4f1ca618e | admin_vm12 | ACTIVE | active               | nova                         | node-28                              |\n+--------------------------------------+------------+--------+----------------------+------------------------------+--------------------------------------+\n\n\nEnvironment\n\nOpenstack : Juno\nCeph : Firefly\n\n\nReference\nOpenstack - Nova Evacuate with Shared Storage\nOpenstack - Nova Evacuate with Shared Storage with Cinder\nOpenstack - Nova Evacuate with Shared Storage with Cinder between AZ\nOpenstack - Nova Evacuate without Shared Storage\nOpenstack - Nova Host-Evacuate with Shared Storage\nOpenstack - Nova Host-Evacuate with Shared Storage between AZ\n## What's this?\n\nNova instance \u304c\u7a3c\u50cd\u3057\u3066\u3044\u308b compute node \u304c\u969c\u5bb3\u505c\u6b62\u3057\u305f\u969b\u306b\u3001**\u5168\u3066\u306e** Nova instance \u3092**\u5225\u306e AZ** \u306e compute node \u4e0a\u306b\u5fa9\u65e7(=\u9000\u907f)\n\n* Nova instance \u3092\u505c\u6b62\u305b\u305a\u30ea\u30a2\u30eb\u30bf\u30a4\u30e0\u306b\u5225\u306e compute node \u306b\u79fb\u52d5\u3059\u308b\u6a5f\u80fd\u3067\u306f\u306a\u3044\n* \u3042\u304f\u307e\u3067 shared storage \u4e0a\u306e\u30c7\u30fc\u30bf\u3092\u4f7f\u7528\u3057\u3066\u3001\u5225\u306e compute node \u3067\u8d77\u52d5\u3057\u76f4\u3059\u6a5f\u80fd\n\n[\u6761\u4ef6]\n\n* Shared storage \u3042\u308a\n* Nova instance \u306e\u5168\u30c7\u30fc\u30bf\u306f Shared storage \u306b\u3042\u308b\n* \u8ffd\u52a0 Volume \u3068\u3057\u3066\u306e Cinder \u672a\u4f7f\u7528\n* Hypervisor \u306f KVM\n\n### Initial state\n\n#### Compute node\n\n    # nova service-list | egrep \"Host|nova-compute\"\n    | Binary           | Host    | Zone     | Status  | State | Updated_at                 | Disabled Reason |\n    | nova-compute     | node-27 | nova     | enabled | up    | 2015-03-23T03:06:42.000000 | -               |\n    | nova-compute     | node-28 | nova     | enabled | up    | 2015-03-23T03:06:51.000000 | -               |\n    | nova-compute     | node-31 | nova2    | enabled | up    | 2015-03-23T03:06:45.000000 | -               |\n\n#### AZ\n\n    # nova availability-zone-list | egrep -A 10 \"^\\| nova\"\n    | nova                     | available                              |\n    | |- node-27               |                                        |\n    | | |- nova-compute        | enabled :-) 2015-03-23T03:07:02.000000 |\n    | |- node-28               |                                        |\n    | | |- nova-compute        | enabled :-) 2015-03-23T03:07:01.000000 |\n    | nova2                    | available                              |\n    | |- node-31               |                                        |\n    | | |- nova-compute        | enabled :-) 2015-03-23T03:06:55.000000 |\n    +--------------------------+----------------------------------------+\n\n#### Two Nova instances are running on node-31 of AZ:nova2\n\n    # nova list --field name,status,OS-EXT-STS:vm_state,OS-EXT-AZ:availability_zone,OS-EXT-SRV-ATTR:hypervisor_hostname\n    +--------------------------------------+------------+--------+----------------------+------------------------------+--------------------------------------+\n    | ID                                   | Name       | Status | OS-EXT-STS: Vm State | OS-EXT-AZ: Availability Zone | OS-EXT-SRV-ATTR: Hypervisor Hostname |\n    +--------------------------------------+------------+--------+----------------------+------------------------------+--------------------------------------+\n    | fecc412e-529f-43ad-b6b5-db2afdb4d0b6 | admin_vm11 | ACTIVE | active               | nova2                        | node-31                              |\n    | cb20a4e6-8c4e-4760-94a5-d4f4f1ca618e | admin_vm12 | ACTIVE | active               | nova2                        | node-31                              |\n    +--------------------------------------+------------+--------+----------------------+------------------------------+--------------------------------------+\n\n## Stop nova-compute service of node-31\n\n#### Stop nova-compute service\n\n    # service openstack-nova-compute stop\n\n    # nova service-list | egrep \"Host|nova-compute\"\n    | Binary           | Host    | Zone     | Status  | State | Updated_at                 | Disabled Reason |\n    | nova-compute     | node-27 | nova     | enabled | up    | 2015-03-23T04:29:43.000000 | -               |\n    | nova-compute     | node-28 | nova     | enabled | up    | 2015-03-23T04:29:44.000000 | -               |\n    | nova-compute     | node-31 | nova2    | enabled | down  | 2015-03-23T04:28:45.000000 | -               |\n\n#### AZ\n\n    # nova availability-zone-list | egrep -A 10 \"^\\| nova\"\n    | nova                     | available                              |\n    | |- node-27               |                                        |\n    | | |- nova-compute        | enabled :-) 2015-03-23T04:29:53.000000 |\n    | |- node-28               |                                        |\n    | | |- nova-compute        | enabled :-) 2015-03-23T04:29:54.000000 |\n    | nova2                    | available                              |\n    | |- node-31               |                                        |\n    | | |- nova-compute        | enabled XXX 2015-03-23T04:28:45.000000 |\n    +--------------------------+----------------------------------------+\n\n## Evacuate\n\n#### Execute host-evacuate\n\nEvacuate all Nova instances from node-31(inactive) of AZ:nova2 to node-28(active) of AZ:nova\n\n    # nova --debug host-evacuate  --target_host node-28 --on-shared-storage node-31\n    +--------------------------------------+-------------------+---------------+\n    | Server UUID                          | Evacuate Accepted | Error Message |\n    +--------------------------------------+-------------------+---------------+\n    | fecc412e-529f-43ad-b6b5-db2afdb4d0b6 | True              |               |\n    | cb20a4e6-8c4e-4760-94a5-d4f4f1ca618e | True              |               |\n    +--------------------------------------+-------------------+---------------+\n\n#### Check the evacuate result\n\nTwo Nova instances are running on node-28 by using the previous data stored in shared storage\n\n    # nova list --field name,status,OS-EXT-STS:vm_state,OS-EXT-AZ:availability_zone,OS-EXT-SRV-ATTR:hypervisor_hostname\n    +--------------------------------------+------------+--------+----------------------+------------------------------+--------------------------------------+\n    | ID                                   | Name       | Status | OS-EXT-STS: Vm State | OS-EXT-AZ: Availability Zone | OS-EXT-SRV-ATTR: Hypervisor Hostname |\n    +--------------------------------------+------------+--------+----------------------+------------------------------+--------------------------------------+\n    | fecc412e-529f-43ad-b6b5-db2afdb4d0b6 | admin_vm11 | ACTIVE | active               | nova                         | node-28                              |\n    | cb20a4e6-8c4e-4760-94a5-d4f4f1ca618e | admin_vm12 | ACTIVE | active               | nova                         | node-28                              |\n    +--------------------------------------+------------+--------+----------------------+------------------------------+--------------------------------------+\n\n## Environment\n\n* Openstack : Juno\n* Ceph : Firefly\n\n## Reference\n\n[Openstack - Nova Evacuate with Shared Storage][link-01]\n[Openstack - Nova Evacuate with Shared Storage with Cinder][link-02]\n[Openstack - Nova Evacuate with Shared Storage with Cinder between AZ][link-03]\n[Openstack - Nova Evacuate without Shared Storage][link-04]\n[Openstack - Nova Host-Evacuate with Shared Storage][link-05]\n[Openstack - Nova Host-Evacuate with Shared Storage between AZ][link-06]\n\n[link-01]:http://qiita.com/idzzy/items/3f398ff8eaa3b786fc89\n[link-02]:http://qiita.com/idzzy/items/2f1add9d1a03e1a4fdea\n[link-03]:http://qiita.com/idzzy/items/8dd2b417f8c5f8efa7c9\n[link-04]:http://qiita.com/idzzy/items/860cb6c60ab7433eb817\n[link-05]:http://qiita.com/idzzy/items/9f057becb592c4c89137\n[link-06]:http://qiita.com/idzzy/items/71287b09de1370c68118\n"}