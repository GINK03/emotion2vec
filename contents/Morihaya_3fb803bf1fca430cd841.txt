{"context": "\u4eca\u5e74\u306b\u5165\u3063\u3066docker\u306eVersion1.13\u304c\u30ea\u30ea\u30fc\u30b9\u3055\u308c\u305f\u3053\u3068\u3092\u5c0f\u8033\u306b\u631f\u3093\u3060\u306e\u3067\u3001\n\u666e\u6bb5\u306f\u30c8\u30e9\u30c7\u30a3\u30b7\u30e7\u30ca\u30eb\u306a\u30aa\u30f3\u30d7\u30ec\u74b0\u5883\u3057\u304b\u89e6\u3063\u3066\u306a\u3044Ops\u304c\u3001\u52c9\u5f37\u304c\u3066\u3089\u8a66\u3057\u3066\u307f\u305f\u30e1\u30e2\u3067\u3059\u3002\n\n\u76ee\u7684\n\u4ee5\u4e0b\u306e\u304b\u3063\u3053\u3044\u3044\u6280\u8853\u3092\u89e6\u3063\u3066\u307f\u308b\uff08\u666e\u6bb5\u30aa\u30f3\u30d7\u30ecCentOS5\u89e6\u3063\u3066\u307e\u3059\u304c\u4f55\u304b\uff09\n\nGCP\nterraform\ndocker\n\n\u69cb\u6210\u3068\u3057\u3066\u306f\u3053\u3093\u306a\u611f\u3058\u3092\u76ee\u6307\u3057\u307e\u3059\n\n\u69cb\u6210\u306e\u30dd\u30a4\u30f3\u30c8\u3068\u3057\u3066\u306f\n+ GKE(Google Container Engine)\u3058\u3083\u306a\u304f\u3066\u6562\u3048\u3066GCE(Google Compute Engine)\u3067CentOS7\u30b5\u30fc\u30d0\u3092\u69cb\u7bc9\u3059\u308b(\u30aa\u30f3\u30d7\u30ec\u3092\u30a4\u30e1\u30fc\u30b8)\n+ docker\u306f\u3082\u3061\u308d\u3093swarm\u30e2\u30fc\u30c9\u3067\u30af\u30e9\u30b9\u30bf\u3092\u69cb\u6210\u3059\u308b\n+ CentOS7\u30b5\u30fc\u30d0\u306e\u69cb\u7bc9\u306a\u3069\u3001GCP\u306e\u64cd\u4f5c\u306fterraform\u3067\"Infrastructure as code\"\u3063\u307d\u304f\u69cb\u7bc9\u3059\u308b\n\n\u624b\u9806\n\n\u524d\u63d0\u6761\u4ef6\n\nGCP\u306e\u30a2\u30ab\u30a6\u30f3\u30c8\u767b\u9332\u306f\u5b8c\u4e86\u3057\u3066\u3044\u308b\u3053\u3068\nterraform\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u304c\u5b8c\u4e86\u3057\u3066\u3044\u308b\u3053\u3068\n\n\n\u624b\u9806\u6982\u8981\n\nterraform\u30d5\u30a1\u30a4\u30eb\u3092\u6e96\u5099\u3059\u308b\nterraform\u3067CentOS7\u30b5\u30fc\u30d01\u53f0\u3092GCE\u306b\u69cb\u7bc9\ndocker\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\nterraform\u30672\u53f0\u76ee\u30013\u53f0\u76ee\u306eCentOS7\u30b5\u30fc\u30d0\u3092\u3067GCE\u306b\u69cb\u7bc9(docker\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3082terraform\u3067\u6307\u793a)\ndocker\u3067swarm mode\u3092\u69cb\u7bc9(\u3053\u3053\u307e\u3067\u306fv1.12\u306e\u6a5f\u80fd)\ndocker\u3067\"stack deploy\"\u3092\u8a66\u3059(v.1.13\u65b0\u6a5f\u80fd)\nterraform\u3067GCP\u306eFireWall\u3092\u8a2d\u5b9a\u3059\u308b\n\"stack deploy\"\u3067\u30c7\u30d7\u30ed\u30a4\u3057\u305f\u30c7\u30e2\u7528\u30a2\u30d7\u30ea\u306e\u52d5\u4f5c\u78ba\u8a8d\nterraform\u3067\u4e00\u62ec\u304a\u7247\u4ed8\u3051\n\n\n\u624b\u9806\u8a73\u7d30\n\n1.terraform\u30d5\u30a1\u30a4\u30eb\u3092\u6e96\u5099\u3059\u308b\n\u4efb\u610f\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306bterraform\u516c\u5f0f\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u306e\"Google Provider\"\u3092\u53c2\u8003\u306b\u4ee5\u4e0b\u306e3\u30d5\u30a1\u30a4\u30eb\u3092\u6e96\u5099\u3057\u307e\u3059\u3002\n\n\u8a8d\u8a3c\u7528\u306eJSON\u30d5\u30a1\u30a4\u30eb(GCP\u304b\u3089\u53d6\u5f97)\n\u30af\u30ec\u30c7\u30f3\u30b7\u30e3\u30eb\u3001\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u540d\u3001\u30ea\u30fc\u30b8\u30e7\u30f3\u3092\u8a18\u8f09\u3059\u308b \"google_cloud_provider.tf\"\n\n\u69cb\u7bc9\u3059\u308b\u30b5\u30fc\u30d0\u69cb\u6210\u3092\u8a18\u8f09\u3059\u308b \"google_cloud_instanc1.tf\"\n\n\n\u203bterraform\u306f\u5b9f\u884c\u3057\u305f\u30d1\u30b9\u306e\"*.tf\"\u30d5\u30a1\u30a4\u30eb\u3092\u3059\u3079\u3066\u8aad\u307f\u8fbc\u3093\u3067\u51e6\u7406\u3092\u3057\u3066\u304f\u308c\u308b\u305f\u3081\u3001\u30d5\u30a1\u30a4\u30eb\u540d\u306f\u4efb\u610f\u3067\u3001\u304b\u3064\u5206\u5272\u3059\u308b\u5fc5\u8981\u306f\u3042\u308a\u307e\u305b\u3093\u304c\u3001\u308f\u304b\u308a\u3084\u3059\u3044\u306e\u3067\u2191\u306b\u3057\u3066\u3044\u307e\u3059\n\n1.1 \u8a8d\u8a3c\u7528\u306eJSON\u30d5\u30a1\u30a4\u30eb\u306e\u53d6\u5f97\n\u8a8d\u8a3c\u7528\u306eJSON\u30d5\u30a1\u30a4\u30eb\u306fGoogle Developers Console\u304b\u3089\u7c21\u5358\u306b\u53d6\u5f97\u3067\u304d\u307e\u3059\u3002\n\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u300c\u8a8d\u8a3c\u60c5\u5831\u300d\u2192\u300c\u30b5\u30fc\u30d3\u30b9\u30a2\u30ab\u30a6\u30f3\u30c8\u30ad\u30fc\u300d\u3092\u30af\u30ea\u30c3\u30af\u3057\u307e\u3059\u3002\n\n\u6b21\u306e\u753b\u9762\u3067\u306f\u30c7\u30d5\u30a9\u30eb\u30c8\u306e\u30b5\u30fc\u30d3\u30b9\u30a2\u30ab\u30a6\u30f3\u30c8\u3092\u30ea\u30b9\u30c8\u304b\u3089\u9078\u3073\u3001\u51fa\u529b\u5f62\u5f0f\u304cJSON\u3068\u306a\u3063\u3066\u3044\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3057\u3066\u300c\u4f5c\u6210\u300d\u3092\u30af\u30ea\u30c3\u30af\u3057\u307e\u3059\u3002\n\n\u3053\u308c\u3067\u8a8d\u8a3c\u7528\u306eJSON\u30d5\u30a1\u30a4\u30eb\u304c\u53d6\u5f97\u3067\u304d\u307e\u3057\u305f\u3002\n\n1.2 \u30af\u30ec\u30c7\u30f3\u30b7\u30e3\u30eb\u3001\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u540d\u3001\u30ea\u30fc\u30b8\u30e7\u30f3\u3092\u8a18\u8f09\u3059\u308b \"google_cloud_provider.tf\" \u306e\u4f5c\u6210\nterraform\u306e\u30b5\u30f3\u30d7\u30eb\u3092\u305d\u306e\u307e\u307e\u6d41\u7528\u3057\u3066\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u8a18\u8f09\u3057\u307e\u3059\u3002\n// Configure the Google Cloud provider\nprovider \"google\" {\n  credentials = \"${file(\"morihayatest-hogehoge.json\")}\"\n  project     = \"morihayatest\"\n  region      = \"us-central1\"\n}\n\n\u203b\"json\u306e\u30d5\u30a1\u30a4\u30eb\u540d\"\u3001\"\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u540d\"\u306f\u74b0\u5883\u3054\u3068\u306b\u5909\u66f4\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n1.3 \u69cb\u7bc9\u3059\u308b\u30b5\u30fc\u30d0\u69cb\u6210\u3092\u8a18\u8f09\u3059\u308b \"google_cloud_instanc1.tf\"\u306e\u4f5c\u6210\n\u3053\u3053\u3067\u3082terraform\u306e\u30b5\u30f3\u30d7\u30eb\u3092\u6d41\u7528\u3057\u3066\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u8a18\u8f09\u3057\u307e\u3059\u3002\nresource \"google_compute_instance\" \"centos7-01\" {\n  name         = \"centos7-01\"\n  machine_type = \"n1-standard-1\"\n  zone         = \"us-central1-a\"\n\n  tags = [\"terraform\",\"test\"]\n\n  disk {\n    image = \"centos-cloud/centos-7\"\n  }\n\n  // Local SSD disk\n  disk {\n    type    = \"local-ssd\"\n    scratch = true\n  }\n\n  network_interface {\n    network = \"default\"\n    access_config {\n      // Ephemeral IP\n    }\n  }\n\n  metadata {\n    foo = \"bar\"\n  }\n\n  metadata_startup_script = \"echo hi > /test.txt\"\n\n  service_account {\n    scopes = [\"userinfo-email\", \"compute-ro\", \"storage-ro\"]\n  }\n}\n\n\nterraform doc\u306e\u30b5\u30f3\u30d7\u30eb\u304b\u3089\u5909\u66f4\u3057\u305f\u306e\u306f\u4ee5\u4e0b\u306e\u70b9\n\nresource\u306e2\u500b\u3081\u306e\u5f15\u6570\u3092\"default\"\u304b\u3089\"centos7-01\"\u3078\uff08\u4ed6\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3068\u91cd\u8907\u3059\u308b\u3068\u30a8\u30e9\u30fc\u306b\u306a\u308b\uff09\nname\u3092\"test\"\u304b\u3089\"centos7-01\"\u3078(\u3053\u308c\u304c\u30db\u30b9\u30c8\u540d\u306b\u306a\u308b)\nimage\u3092\u201ddebian-8\"\u304b\u3089\"centos-7\"\u3078(\u666e\u6bb5CentOS\u4f7f\u3063\u3066\u308b\u304b\u3089...)\n\n\u203b\u4e0d\u5fc5\u8981\u306a\u8a18\u8ff0\u304c\u3044\u304f\u3064\u304b\u3042\u308a\u307e\u3059\u304c\u3001\u3068\u308a\u3042\u3048\u305a\u52d5\u304b\u3059\u306e\u304c\u76ee\u7684\u306e\u305f\u3081\u30b9\u30eb\u30fc\n\n2. terraform\u3067CentOS7\u30b5\u30fc\u30d01\u53f0\u3092GCE\u306b\u69cb\u7bc9\n\n2.1 terrform plan\u3067\u5b9a\u7fa9\u306e\u30c1\u30a7\u30c3\u30af\n1\u3067\u4f5c\u6210\u3057\u305f3\u30d5\u30a1\u30a4\u30eb\u306e\u3042\u308b\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3078\u30bf\u30fc\u30df\u30ca\u30eb\u3067\u79fb\u52d5\u3057\u3001\u4ee5\u4e0b\u3092\u5b9f\u884c\u3057\u307e\u3059\nterraform plan\n\n\u30a8\u30e9\u30fc\u304c\u306a\u3051\u308c\u3070\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u51fa\u529b\u306b\u306a\u308a\u307e\u3059\u3002\u6700\u5f8c\u306e\"Plan: 1 to add, 0 to change, 0 to destroy.\"\u3092\u78ba\u8a8d\u3067\u304d\u308c\u3070OK\u3067\u3059\u3002\n$ terraform plan\nRefreshing Terraform state in-memory prior to plan...\nThe refreshed state will be used to calculate this plan, but\nwill not be persisted to local or remote state storage.\n\n\nThe Terraform execution plan has been generated and is shown below.\nResources are shown in alphabetical order for quick scanning. Green resources\nwill be created (or destroyed and then created if an existing resource\nexists), yellow resources are being changed in-place, and red resources\nwill be destroyed. Cyan entries are data sources to be read.\n\nNote: You didn't specify an \"-out\" parameter to save this plan, so when\n\"apply\" is called, Terraform can't guarantee this is what will execute.\n\n+ google_compute_instance.default\n    can_ip_forward:                                      \"false\"\n    disk.#:                                              \"2\"\n    disk.0.auto_delete:                                  \"true\"\n    disk.0.image:                                        \"centos-cloud/centos-7\"\n    disk.1.auto_delete:                                  \"true\"\n    disk.1.scratch:                                      \"true\"\n    disk.1.type:                                         \"local-ssd\"\n    machine_type:                                        \"n1-standard-1\"\n    metadata.%:                                          \"1\"\n    metadata.foo:                                        \"bar\"\n    metadata_fingerprint:                                \"<computed>\"\n    name:                                                \"centos7-01\"\n    network_interface.#:                                 \"1\"\n    network_interface.0.access_config.#:                 \"1\"\n    network_interface.0.access_config.0.assigned_nat_ip: \"<computed>\"\n    network_interface.0.address:                         \"<computed>\"\n    network_interface.0.name:                            \"<computed>\"\n    network_interface.0.network:                         \"default\"\n    self_link:                                           \"<computed>\"\n    service_account.#:                                   \"1\"\n    service_account.0.email:                             \"<computed>\"\n    service_account.0.scopes.#:                          \"3\"\n    service_account.0.scopes.1632638332:                 \"https://www.googleapis.com/auth/devstorage.read_only\"\n    service_account.0.scopes.2428168921:                 \"https://www.googleapis.com/auth/userinfo.email\"\n    service_account.0.scopes.2862113455:                 \"https://www.googleapis.com/auth/compute.readonly\"\n    tags.#:                                              \"2\"\n    tags.3632233996:                                     \"test\"\n    tags.969816526:                                      \"terraform\"\n    tags_fingerprint:                                    \"<computed>\"\n    zone:                                                \"us-central1-a\"\n\n\nPlan: 1 to add, 0 to change, 0 to destroy.\n\n\n2.2 terrform apply\u3067\u30b5\u30fc\u30d0\u30c7\u30d7\u30ed\u30a4\n\u5b9f\u969b\u306bGCE\u4e0a\u306b\u30b5\u30fc\u30d0\u3092\u69cb\u7bc9\u3057\u307e\u3059\u3002\nterraform apply\n\nterraform plan\u5b9f\u884c\u6642\u3068\u307b\u3068\u3093\u3069\u540c\u3058\u3088\u3046\u306a\u30ed\u30b0\u304c\u51fa\u529b\u3055\u308c\u307e\u3059\u3002\n$ terraform apply\ngoogle_compute_instance.default: Creating...\n  can_ip_forward:                                      \"\" => \"false\"\n  disk.#:                                              \"\" => \"2\"\n  disk.0.auto_delete:                                  \"\" => \"true\"\n  disk.0.image:                                        \"\" => \"centos-cloud/centos-7\"\n\n~~~~\u7701\u7565~~~\n\ngoogle_compute_instance.default: Still creating... (10s elapsed)\ngoogle_compute_instance.default: Still creating... (20s elapsed)\ngoogle_compute_instance.default: Creation complete\n\nApply complete! Resources: 1 added, 0 changed, 0 destroyed.\n\nThe state of your infrastructure has been saved to the path\nbelow. This state is required to modify and destroy your\ninfrastructure, so keep it safe. To inspect the complete state\nuse the `terraform show` command.\n\nState path: terraform.tfstate\n\nGCP\u306e\u30b3\u30f3\u30bd\u30fc\u30eb\u306b\u30ed\u30b0\u30a4\u30f3\u3057\u3001\u5de6\u4e0a\u306e\u30cf\u30f3\u30d0\u30fc\u30ac\u30e1\u30cb\u30e5\u30fc('\u4e09'\u307f\u305f\u3044\u306a\u30dc\u30bf\u30f3)\u304b\u3089\u300cCompute Engine\u300d\u3092\u9078\u629e\u3057\u307e\u3059\u3002\n\u554f\u984c\u304c\u306a\u3051\u308c\u3070\u30b5\u30fc\u30d0\u30fc\u304c1\u53f0\u8d77\u52d5\u3057\u3066\u3044\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3067\u304d\u307e\u3059\u3002\n\n\n3. docker\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\u8d77\u52d5\u3057\u305f\u30b5\u30fc\u30d0\u3078docker\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u307e\u3059\u3002\n\n3.1 \u30b5\u30fc\u30d0\u3078\u30ed\u30b0\u30a4\u30f3\nGCP\u30b3\u30f3\u30bd\u30fc\u30eb\u306e\"SSH\"\u30dc\u30bf\u30f3\u3092\u30af\u30ea\u30c3\u30af\u3059\u308b\u3053\u3068\u3067\u3001\u30b5\u30fc\u30d0\u3078\u30ed\u30b0\u30a4\u30f3\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\uff08\u3053\u306e\u30ed\u30b0\u30a4\u30f3\u306e\u7c21\u5358\u3055\u306b\u611f\u52d5\u3057\u307e\u3057\u305f\uff09\n\n3.2 \u30ec\u30dd\u30b8\u30c8\u30ea\u767b\u9332\n\u3053\u3053\u304b\u3089\u306fdocker\u516c\u5f0f\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u306b\u5f93\u3063\u3066\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3092\u3057\u3066\u304d\u307e\u3059\u3002\n\u5404\u30c7\u30a3\u30b9\u30c8\u30ea\u30d3\u30e5\u30fc\u30b7\u30e7\u30f3\u7528\u306b\u3001\u4e01\u5be7\u306b\u624b\u9806\u304c\u8a18\u8f09\u3055\u308c\u3066\u3044\u307e\u3059\u304c\u3001\u3053\u3053\u3067\u306f\u6700\u4f4e\u9650\u5fc5\u8981\u306a\u30b3\u30de\u30f3\u30c9\u3060\u3051\u629c\u7c8b\u3057\u307e\u3059\u3002\n# \u30ec\u30dd\u30b8\u30c8\u30ea\u767b\u9332\u306e\u305f\u3081\u306e\"yum-utils\"\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\nsudo yum install -y yum-utils\n\n# \u30ec\u30dd\u30b8\u30c8\u30ea\u767b\u9332\nsudo yum-config-manager \\\n    --add-repo \\\n    https://docs.docker.com/engine/installation/linux/repo_files/centos/docker.repo\n\n\n\n3.3 docker\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\nyum\u3067\u3042\u3063\u3055\u308a\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3067\u304d\u307e\u3059\u3002\nsudo yum -y install docker-engine\n\n\n3.4 docker\u8d77\u52d5\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u5f8c\u306f\u505c\u6b62\u3057\u3066\u3044\u308b\u305f\u3081\u3001\u8d77\u52d5\u3057\u307e\u3059\u3002\nsudo systemctl start docker\n\n\n3.5 docker\u8d77\u52d5\u78ba\u8a8d\n\u57fa\u672c\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u78ba\u8a8d\u3068\u3001\"hello world\"\u3092\u5b9f\u884c\u3057\u307e\u3059\u3002\n# \u30d0\u30fc\u30b8\u30e7\u30f3\u78ba\u8a8d\nsudo docker --version\n\u2192\"Docker version 1.13.1, build 092cba3\"\n\n# hello world\nsudo docker run hello-world\n\u2192\"Unable to find image 'hello-world:latest' locally\"\u3068\u51fa\u3066\u3001docker HUB\u304b\u3089\u30a4\u30e1\u30fc\u30b8\u3092\u53d6\u5f97\u3057\u307e\u3059\u3002\n\n\u3053\u3053\u307e\u3067\u3067\u4ee5\u4e0b\u306e\u69cb\u6210\u306b\u306a\u308a\u307e\u3057\u305f\u3002(hello-world\u304capp\u306a\u306e\u304b\u3068\u3044\u3046\u30c4\u30c3\u30b3\u30df\u306f\u7121\u3057\u3067...)\n\n\n4. terraform\u30672\u53f0\u76ee\u30013\u53f0\u76ee\u306eCentOS7\u30b5\u30fc\u30d0\u3092\u3067GCE\u306b\u69cb\u7bc9(docker\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3082terraform\u3067\u6307\u793a)\n\n4.1 terraform\u30d5\u30a1\u30a4\u30eb\u306e\u6e96\u5099\n\u5f15\u304d\u7d9a\u304d2\u53f0\u76ee\u30013\u53f0\u76ee\u306e\u30b5\u30fc\u30d0\u3092\u69cb\u7bc9\u3057\u3066\u3044\u304d\u307e\u3059\u304c\u3001docker\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3092\u90fd\u5ea6\u3084\u308b\u306e\u306f\u9762\u5012\u3067\u3059\u3002\n\u305d\u3053\u3067\u4e00\u5de5\u592b\u3068\u3057\u3066\"metadata_startup_script\"\u3092\u6d3b\u7528\u3057\u307e\u3059\u3002\n\"metadata_startup_script\"\u306b\u6307\u5b9a\u3055\u308c\u305f\u30b3\u30de\u30f3\u30c9\u306f\u30b5\u30fc\u30d0\u8d77\u52d5\u6642\u306b\u5b9f\u884c\u3055\u308c\u308b\u305f\u3081\u3001docker\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u306e\u305f\u3081\u306e\u4e00\u9023\u306e\u30b3\u30de\u30f3\u30c9\u3092\u8a18\u8f09\u3057\u3066\u304a\u304f\u3053\u3068\u3067\u3001\u69cb\u7bc9\u306e\u81ea\u52d5\u5316\u3092\u56f3\u308a\u307e\u3059\u3002\n\u307e\u305f\u30012\u53f0\u76ee\u30013\u53f0\u76ee\u306e\u56fa\u6709\u5024\u3067\u3042\u308b\u30db\u30b9\u30c8\u540d\u306a\u3069\u306e\u90e8\u5206\u3092\u5909\u66f4\u3057\u307e\u3059\u3002\nresource \"google_compute_instance\" \"centos7-02\" {\n  name         = \"centos7-02\"\n\n~~~\u7701\u7565~~~\n\n  metadata_startup_script = \"yum install -y yum-utils ; yum-config-manager --add-repo https://docs.docker.com/engine/installation/linux/repo_files/centos/docker.repo ; yum -y install docker-engine ; systemctl start docker\"\n\n~~~\u7701\u7565~~~\n\n\n\u203b\u304a\u305d\u3089\u304f\u3001metadata_startup_script\u306f\u4f7f\u3044\u65b9\u6b21\u7b2c\u3067\u7121\u9650\u306e\u53ef\u80fd\u6027\u304c\u3042\u308a\u305d\u3046\u3067\u3059\u3002GCS\u304b\u3089\u30b9\u30af\u30ea\u30d7\u30c8\u53d6\u3063\u3066\u304d\u3066\u69cb\u7bc9\u81ea\u52d5\u5316\u3068\u304b\u3057\u305f\u3089\u30b9\u30c6\u30ad\n\u4e0a\u8a18\u306e\u5909\u66f4\u3092\u3057\u305fterraform\u30d5\u30a1\u30a4\u30eb\u3092\u65e2\u5b58\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3078\u914d\u7f6e\u3057\u307e\u3059\u3002\n\ngoogle_cloud_provider.tf\ngoogle_cloud_instanc1.tf\ngoogle_cloud_instanc2.tf \u2190\u2605NEW\ngoogle_cloud_instanc3.tf \u2190\u2605NEW\n\n\n4.2 terraform\u3067\u30c7\u30d7\u30ed\u30a4\n1\u53f0\u76ee\u3092\u4f5c\u6210\u3057\u305f\u6642\u3068\u540c\u3058\u624b\u9806\u3067\u30b5\u30fc\u30d0\u3092\u69cb\u7bc9\u3057\u3066\u3044\u304d\u307e\u3059\u3002\nterraform plan\n\u2192\"Plan: 2 to add, 0 to change, 0 to destroy.\"\u3092\u78ba\u8a8d\n\nterraform apply\n\u2192\"Apply complete! Resources: 2 added, 0 changed, 0 destroyed.\"\u3092\u78ba\u8a8d\n\n\n4.3 docker\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3092\u78ba\u8a8d\n2\u53f0\u76ee\u30013\u53f0\u76ee\u306e\u30b5\u30fc\u30d0\u306bssh\u30ed\u30b0\u30a4\u30f3\u3057\u3001docker\u304c\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3055\u308c\u3066\u3044\u308b\u304b\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\nsudo docker --version\n\u2192\u554f\u984c\u306a\u304f\u30d0\u30fc\u30b8\u30e7\u30f3\u304c\u8868\u793a\u3055\u308c\u308b\u3053\u3068\u3092\u78ba\u8a8d\n\n\u3053\u3053\u307e\u3067\u3067\u4ee5\u4e0b\u306e\u72b6\u614b\u306b\u306a\u308a\u307e\u3057\u305f\u3002\n\n\n5. docker\u3067swarm mode\u3092\u69cb\u7bc9(\u3053\u3053\u307e\u3067\u306fv1.12\u306e\u6a5f\u80fd)\n\u3044\u3088\u3044\u3088docker swarm mode\u3067\u30af\u30e9\u30b9\u30bf\u3092\u69cb\u7bc9\u3057\u3066\u3044\u304d\u307e\u3059\u3002\n\u3053\u3053\u3067\u3082docker\u516c\u5f0f\u306e\u30c1\u30e5\u30fc\u30c8\u30ea\u30a2\u30eb\u306b\u5f93\u3044\u307e\u3059\u304c\u3001\u3055\u3059\u304c\u30ef\u30fc\u30eb\u30c9\u30ef\u30a4\u30c9\u306a\u30d7\u30ed\u30c0\u30af\u30c8\u306f\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u304c\u3057\u3063\u304b\u308a\u3057\u3066\u3044\u308b\u3068\u611f\u5fc3\u3057\u307e\u3059\u3002\n\n5.1 swarm manager\u30b5\u30fc\u30d0\u3067swam mode\u958b\u59cb\nswarm mode\u3092\u958b\u59cb\u3059\u308b\u305f\u3081\u306b\u30011\u53f0\u306e\u30b5\u30fc\u30d0\u3092\u30de\u30cd\u30fc\u30b8\u30e3\u3068\u3057\u3066\u521d\u671f\u5316\u3057\u307e\u3059\u3002\n\u30de\u30cd\u30fc\u30b8\u30e3\u4f5c\u6210\u6642\u306b\u305d\u306e\u4ed6\u306e\u30ef\u30fc\u30ab\u30fc\u30b5\u30fc\u30d0\u3068\u901a\u4fe1\u3059\u308b\u305f\u3081\u306eIP\u3092\u6307\u5b9a\u3057\u307e\u3059\u3002\n# ip\u78ba\u8a8d\nip a\n\u2192\u4ed6\u30b5\u30fc\u30d0\u3068\u901a\u4fe1\u53ef\u80fd\u306aIP\u3092\u78ba\u8a8d \"10.128.xxx.xxx/32\"\n\n# swam manager\u306e\u958b\u59cb\nsudo docker swarm init --advertise-addr 10.128.xxx.xxx\n\n\u30b3\u30de\u30f3\u30c9\u304c\u6210\u529f\u3059\u308b\u3068\u3001\u4ed6\u306e\u30ef\u30fc\u30ab\u30fc\u30b5\u30fc\u30d0\u3067\u5b9f\u884c\u3059\u308b\u305f\u3081\u306e\u30b3\u30de\u30f3\u30c9\u304c\u51fa\u529b\u3055\u308c\u307e\u3059\u3002\n$ sudo docker swarm init --advertise-addr 10.128.0.2\nSwarm initialized: current node (hogehoge) is now a manager.\n\nTo add a worker to this swarm, run the following command:\n\n    docker swarm join \\\n    --token hogehoge-fugafuga \\\n    10.128.xxx.xxx:2377\n\nTo add a manager to this swarm, run 'docker swarm join-token manager' and follow the instructions.\n\n5.2 swarm woker\u30b5\u30fc\u30d0\u3092swarm\u3078\u53c2\u52a0\nswarm\u306b\u30ef\u30fc\u30ab\u30fc\u30b5\u30fc\u30d0\u3092\u53c2\u52a0\u3055\u305b\u307e\u3059\u304c\u3001\u6298\u89d2\u306a\u306e\u3067\u30de\u30cd\u30fc\u30b8\u30e3\u30b5\u30fc\u30d0\u3067\u30e2\u30cb\u30bf\u3057\u307e\u3059\u3002\nsudo watch -n 1 docker node ls\n\nID                           HOSTNAME    STATUS  AVAILABILITY  MANAGER STATUS\nhogehogehogehogehogehogeh *  centos7-01  Ready   Active        Leader\n\u2192\"swarm init\"\u76f4\u5f8c\u306f\u30de\u30cd\u30fc\u30b8\u30e3\u306e1\u53f0\u306e\u307f\n\nswarm init\u6642\u306b\u51fa\u529b\u3055\u308c\u305f\u30b3\u30de\u30f3\u30c9\u3092\u3001\u4ed6\u306e\u30b5\u30fc\u30d0\u3067\u5b9f\u884c\u3057\u307e\u3059\u3002\n\u203bsudo\u3092\u4ed8\u3051\u308b\u306e\u3092\u304a\u5fd8\u308c\u306a\u304f\nsudo docker swarm join \\\n--token hogehoge-fugafuga \\\n10.128.xxx.xxx:2377\n\u2192\"This node joined a swarm as a worker.\"\n\njoin\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3059\u308b\u3073\u306b\u30b5\u30fc\u30d0\u304c\u5897\u3048\u3066\u884c\u304d\u307e\u3059\nID                           HOSTNAME    STATUS  AVAILABILITY  MANAGER STATUS\nhogehogehogehogehogehogeh *  centos7-01  Ready   Active        Leader\nfugafugafugafugafugafugaf    centos7-02  Ready   Active\nmogemogemogemogemogemogem    centos7-03  Ready   Active\n\n\n5.3 swarm\u3078\u30b5\u30fc\u30d3\u30b9\u3092\u30c7\u30d7\u30ed\u30a4\n\u3044\u3088\u3044\u3088swarm\u3078\u30b5\u30fc\u30d3\u30b9\u3092\u30c7\u30d7\u30ed\u30a4\u3057\u307e\u3059\u3002\nswarm\u306b\u3088\u308b\u30b5\u30fc\u30d3\u30b9\u306e\u62e1\u7e2e\u3092\u30e2\u30cb\u30bf\u3059\u308b\u305f\u3081\u306b\u3001\u30de\u30cd\u30fc\u30b8\u30e3\u30b5\u30fc\u30d0\u3067\u4ee5\u4e0b\u3092\u5b9f\u884c\u3057\u307e\u3059\u3002\nsudo watch -n 1 docker service ps helloworld \n\u2192\u30c7\u30d7\u30ed\u30a4\u524d\u306e\u305f\u3081\"Error: No such service: helloworld\"\u3068\u51fa\u307e\u3059\n\n\u3044\u3088\u3044\u3088\u30c7\u30d7\u30ed\u30a4\u3067\u3059\nsudo docker service create --replicas 1 --name helloworld alpine ping docker.com\n\n\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u51fa\u529b\u3055\u308c\u307e\u3059\nID            NAME          IMAGE          NODE        DESIRED STATE  CURRENT STATE          ERROR  PORTS  \nhogehogehoge  helloworld.1  alpine:latest  centos7-01  Running        Running 9 seconds ago\n\n\u30b9\u30b1\u30fc\u30eb\u30a2\u30c3\u30d7\u3057\u3066\u307f\u307e\u3057\u3087\u3046\nsudo docker service scale helloworld=5\n\n1\u79d2\u3082\u3057\u306a\u3044\u3067\u30b9\u30b1\u30fc\u30eb\u30a2\u30c3\u30d7\u3057\u307e\u3059\u3002\nID            NAME          IMAGE          NODE        DESIRED STATE  CURRENT STATE          ERROR  PORTS   \nhogehogehoge  helloworld.1  alpine:latest  centos7-01  Running        Running 5 minutes ago\nfugafugafuga  helloworld.2  alpine:latest  centos7-02  Running        Running 7 seconds ago\nmogemogemoge  helloworld.3  alpine:latest  centos7-01  Running        Running 8 seconds ago\nnuganuganuga  helloworld.4  alpine:latest  centos7-03  Running        Running 7 seconds ago\nmoemoemoemoe  helloworld.5  alpine:latest  centos7-02  Running        Running 8 seconds ago\n\n\u7d9a\u3044\u3066\u30b9\u30b1\u30fc\u30eb\u30c0\u30a6\u30f3\u3057\u3066\u307f\u307e\u3057\u3087\u3046\nsudo docker service scale helloworld=2\n\n\u3042\u3063\u3055\u308a\u30b9\u30b1\u30fc\u30eb\u30c0\u30a6\u30f3\u3057\u307e\u3059\nID            NAME          IMAGE          NODE        DESIRED STATE  CURRENT STATE          ERROR  PORTS  \nfugafugafuga  helloworld.2  alpine:latest  centos7-02  Running        Running 5 minutes ago\nmogemogemoge  helloworld.3  alpine:latest  centos7-01  Running        Running 5 minutes ago\n\n\n5.3 swarm\u304b\u3089\u30b5\u30fc\u30d3\u30b9\u3092\u524a\u9664\n\u516c\u5f0f\u30c1\u30e5\u30fc\u30c8\u30ea\u30a2\u30eb\u3067\u306f\u30db\u30b9\u30c8\u30e1\u30f3\u30c6\u30ca\u30f3\u30b9\u3084\u3001\u30ed\u30fc\u30ea\u30f3\u30b0\u30a2\u30c3\u30d7\u30c7\u30fc\u30c8\u306e\u624b\u9806\u3082\u3042\u308a\u307e\u3059\u304c\u3001\u4e00\u65e6\u306f\u6e80\u8db3\u3057\u305f\u306e\u3067\u30b5\u30fc\u30d3\u30b9\u3092\u505c\u6b62\u3057\u307e\u3059\u3002\nsudo docker service rm helloworld\n\n\u3053\u3053\u307e\u3067\u3067\u3001\u3064\u3044\u306b\u76ee\u6307\u3057\u305f\u69cb\u6210\u304c\u51fa\u6765\u4e0a\u304c\u308a\u307e\u3057\u305f\u3002\n\n\n6. docker\u3067\"stack deploy\"\u3092\u8a66\u3059(v.1.13\u65b0\u6a5f\u80fd)\n\u3044\u3088\u3044\u3088docker v1.13\u306e\u65b0\u6a5f\u80fd\"stack deploy\"\u3092\u8a66\u3057\u307e\u3059\u3002\nv1.13\u306e\u65b0\u6a5f\u80fd\u306f\"stack deploy\"\u3060\u3051\u3067\u306f\u306a\u3044\u3067\u3059\u304c\u3001\u76ee\u7389\u3067\u3042\u308b\u3053\u3068\u306f\u9593\u9055\u3044\u7121\u3044\u3067\u3057\u3087\u3046\u3002\n\"stack deploy\"\u30b3\u30de\u30f3\u30c9\u3067\u306f\u3001compose file\u3092\u4f7f\u7528\u3057\u3066swarm mode\u3078\u30b5\u30fc\u30d3\u30b9\u3092\u30c7\u30d7\u30ed\u30a4\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\n6.1 \u30c7\u30e2\u7528\u30a2\u30d7\u30ea\u306e\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\ndocker\u306e\u5b9a\u756a(?)\u306e\u30c7\u30e2\u7528\u30a2\u30d7\u30ea\u304cGitHub\u3067\u516c\u958b\u3055\u308c\u3066\u3044\u308b\u305f\u3081\u3001\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u307e\u3059\u3002\n# git\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\nsudo yum install -y git\n\n# \u30c7\u30e2\u7528\u30a2\u30d7\u30ea\u306e\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\ngit clone https://github.com/docker/example-voting-app.git\n\n\u3053\u306e\u30a2\u30d7\u30ea\u306f\u4ee5\u4e0b\u306e\u69cb\u6210\u3068\u306a\u3063\u3066\u3044\u308b\u305d\u3046\u3067\u3059\u3002\n+ TCP5000\u756a\u3067\u6295\u7968\u753b\u9762(voting-app)\n+ TCP5001\u756a\u3067\u7d50\u679c\u753b\u9762(result-app)\n\n\u6298\u89d2\u306a\u306e\u3067compose file\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n# \u30c7\u30d7\u30ed\u30a4\u7528\u306e\u30d5\u30a1\u30a4\u30eb\u3092\u78ba\u8a8d\ncd example-voting-app/\ncat docker-stack.yml\n\nexample-voting-app\u30ea\u30dd\u30b8\u30c8\u30ea\u306b\u306f\u5f93\u6765\u306ecompse file\u3082\u683c\u7d0d\u3055\u308c\u3066\u3044\u308b\u305f\u3081\u3001stack\u7528\u306ecompose file\u3068\u898b\u6bd4\u3079\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\u3069\u3046\u3084\u3089stack\u7528\u306ecompose file\u306b\u306f\u4ee5\u4e0b\u306e\u30d1\u30e9\u30e1\u30bf\u304c\u8ffd\u52a0\u3055\u308c\u3066\u3044\u308b\u3088\u3046\u3067\u3059\u3002\n\nreplicas\nparallelism\n\n\n6.2 \u30c7\u30e2\u7528\u30a2\u30d7\u30ea\u306e\u30c7\u30d7\u30ed\u30a4\n\u30c7\u30d7\u30ed\u30a4\u306e\u52d5\u304d\u3092\u78ba\u8a8d\u3059\u308b\u305f\u3081\u306b\u3001\u30de\u30cd\u30fc\u30b8\u30e3\u30b5\u30fc\u30d0\u3067\u4ee5\u4e0b\u3092\u5b9f\u884c\u3057\u3066\u304a\u304d\u307e\u3059\u3002\nsudo watch -n 1 docker service ls\nsudo watch -n 1 docker stack ps vote\n\nv1.13\u65b0\u6a5f\u80fd\u3001\u300cstack deploy\u300d\u30b3\u30de\u30f3\u30c9\u3067\u3001\u30de\u30cd\u30fc\u30b8\u30e3\u30b5\u30fc\u30d0\u304b\u3089\u30c7\u30d7\u30ed\u30a4\u3092\u5b9f\u884c\u3057\u307e\u3059\u3002\nsudo docker stack deploy --compose-file docker-stack.yml vote\n\n\u3082\u308a\u3082\u308a\u3068\u30b5\u30fc\u30d3\u30b9\u304c\u8d77\u52d5\u3057\u3066\u3044\u304f\u3053\u3068\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n# docker service ls\u306e\u7d50\u679c\nID            NAME             MODE        REPLICAS  IMAGE\nhogehogehoge  vote_redis       replicated  2/2       redis:alpine\nfugafugafuga  vote_vote        replicated  2/2       dockersamples/examplevotingapp_vote:before\nnuganuganuga  vote_worker      replicated  1/1       dockersamples/examplevotingapp_worker:latest\nmogemogemoge  vote_db          replicated  1/1       postgres:9.4\nmoemoemoemoe  vote_visualizer  replicated  1/1       dockersamples/visualizer:stable\nhobihobihobi  vote_result      replicated  1/1       dockersamples/examplevotingapp_result:before\n\n# docker stack ps vote\u306e\u7d50\u679c\nID            NAME               IMAGE                                         NODE        DESIRED STATE  CURRENT STATE          ERROR  PORTS\nhoehoehoehoe  vote_worker.1      dockersamples/examplevotingapp_worker:latest  centos7-01  Running        Running about a minute ago\nfuefuefuefue  vote_result.1      dockersamples/examplevotingapp_result:before  centos7-01  Running        Running about a minute ago\nmuomuomuomuo  vote_vote.1        dockersamples/examplevotingapp_vote:before    centos7-03  Running        Running 2 minutes ago\njojojojojojo  vote_db.1          postgres:9.4                                  centos7-01  Running        Running about a minute ago\ngogogogogogo  vote_redis.1       redis:alpine                                  centos7-03  Running        Running 2 minutes\n\n\n7. terraform\u3067GCP\u306eFireWall\u3092\u8a2d\u5b9a\u3059\u308b\n\u30a2\u30d7\u30ea\u304c\u7acb\u3061\u4e0a\u304c\u3063\u305f\u3068\u3053\u308d\u3067\u3001\u65e9\u901f\u63a5\u7d9a\u78ba\u8a8d\u3092\u3057\u305f\u304f\u306a\u308a\u307e\u3059\u304c\u3001\u3053\u306e\u307e\u307e\u3067\u306f\u63a5\u7d9a\u3067\u304d\u307e\u305b\u3093\u3002\nGCP\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306f\u3001\u57fa\u672c\u7684\u306b\u5916\u90e8\u304b\u3089\u306e\u30a2\u30af\u30bb\u30b9\u3092\u8a31\u53ef\u3057\u3066\u3044\u306a\u3044\u305f\u3081\u3001FireWall(\u4ee5\u5f8cFW)\u306e\u8a2d\u5b9a\u304c\u5fc5\u8981\u3067\u3059\u3002\n\n7.1 FW\u7528terraform\u30d5\u30a1\u30a4\u30eb\u306e\u6e96\u5099\n\u3053\u3053\u3067\u3082terraform\u3092\u4f7f\u3063\u3066FW\u306e\u8a2d\u5b9a\u3092\u884c\u3044\u307e\u3059\u3002(GUI\u3092\u4f7f\u3063\u305f\u3089Infrastructure as code\u3058\u3083\u306a\u3044\u304b\u3089\u3067\u3059)\n\u30b5\u30f3\u30d7\u30eb\u306b\u5f93\u3063\u3066google_compute_firewall.tf\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\nresource \"google_compute_firewall\" \"default\" {\n  name    = \"example-voting-app\"\n  network = \"default\"\n\n  allow {\n    protocol = \"icmp\"\n  }\n\n  allow {\n    protocol = \"tcp\"\n    ports    = [\"5000-5001\"]\n  }\n\n  source_ranges = [\"0.0.0.0/0\"]\n  target_tags = [\"terraform\"]\n}\n\n\u30b5\u30f3\u30d7\u30eb\u304b\u3089\u306e\u5909\u66f4\u30dd\u30a4\u30f3\u30c8\u3068\u3057\u3066\u306f\u4ee5\u4e0b\u306e\u901a\u308a\u3067\u3059\u3002\n\nname\u3092\u308f\u304b\u308a\u3084\u3059\u304f\nnetwork\u306f\"default\"\u306b\nports\u306f\u30a2\u30d7\u30ea\u304c\u4f7f\u30465000\u306850001\nsource_ranges\u3067any(0.0,0.0/0)\u3092\u6307\u5b9a\n\n\n7.2 FW\u306e\u8a2d\u5b9a\u3092\u30c7\u30d7\u30ed\u30a4\n\u9069\u7528\u624b\u9806\u306f\u30b5\u30fc\u30d0\u69cb\u7bc9\u6642\u3068\u540c\u3058\u3067\u3059\u3002\nterraform plan\n\u2192\"Plan: 1 to add, 0 to change, 0 to destroy.\"\u3092\u78ba\u8a8d\n\nterraform apply\n\u2192\"Apply complete! Resources: 1 added, 0 changed, 0 destroyed.\"\u3092\u78ba\u8a8d\n\n\n7.3 FW\u306e\u8a2d\u5b9a\u3092GCP\u30b3\u30f3\u30bd\u30fc\u30eb\u3067\u78ba\u8a8d\n\u30cf\u30f3\u30d0\u30fc\u30ac\u30e1\u30cb\u30e5\u30fc\u304b\u3089\u300c\u30cd\u30c3\u30c8\u30ef\u30fc\u30ad\u30f3\u30b0\u300d\u2192\u300c\u30d5\u30a1\u30a4\u30a2\u30a6\u30a9\u30fc\u30eb\u30eb\u30fc\u30eb\u300d\u3092\u9078\u629e\u3057\u3001\"example-voting-app\"\u30eb\u30fc\u30eb\u304c\u4f5c\u6210\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n\n8. \"stack deploy\"\u3067\u30c7\u30d7\u30ed\u30a4\u3057\u305f\u30c7\u30e2\u7528\u30a2\u30d7\u30ea\u306e\u52d5\u4f5c\u78ba\u8a8d\n\u3044\u3088\u3044\u3088\u30a2\u30d7\u30ea\u306b\u63a5\u7d9a\u3057\u307e\u3059\u3002\n\n8.1 GIP\u306e\u78ba\u8a8d\n\u30cf\u30f3\u30d0\u30fc\u30ac\u30e1\u30cb\u30e5\u30fc\u304b\u3089\u300cCompute Engine\u300d\u304b\u3089\u3001\u5404\u30b5\u30fc\u30d0\u306eGIP\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n\n8.2 \u63a5\u7d9a\uff01\u305d\u3057\u3066\u6295\u7968\uff01\n\u304a\u624b\u6301\u3061\u306e\u30d6\u30e9\u30a6\u30b6\u3067\"GIP:5000\"\u3078\u63a5\u7d9a\u3057\u307e\u3059\u3002\n\u4ee5\u4e0b\u3092\u78ba\u8a8d\u3057\u307e\u3057\u3087\u3046\u3002\n+ \u30b5\u30fc\u30d03\u53f0\u306e\u3069\u306eGIP\u304b\u3089\u3067\u3082\u63a5\u7d9a\u3067\u304d\u308b\u3000\u2190\u3053\u308c\u91cd\u8981\n+ \u30ea\u30ed\u30fc\u30c9\u3067\u30b3\u30f3\u30c6\u30ca\u306eID\u304c\u5909\u308f\u308b\u3000\u2190\u3053\u308c\u3082\u91cd\u8981\n\n\n8.3 \u7d50\u679c\u78ba\u8a8d\n\u3064\u3065\u3044\u30665001\u756a\u3078\u63a5\u7d9a\u3057\u3066\u6295\u7968\u7d50\u679c\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\uff08\u30d6\u30e9\u30a6\u30b6\u306e\u30ad\u30e3\u30c3\u30b7\u30e5\u30af\u30ea\u30a2\u3092\u3057\u3066\u8907\u6570\u56de\u6295\u7968\u3057\u306a\u3044\u3068\u3001\u7d50\u679c\u3068\u3057\u3066\u306f\u9762\u767d\u304f\u306a\u3044\u304b\u3082\u3057\u308c\u307e\u305b\u3093\uff09\n\n\n8.4 docker swarm mode\u306eIngress overlay network\u3092\u4f53\u611f\u3059\u308b\n3\u53f0\u5168\u3066\u306eGIP\u3078\u306e\u63a5\u7d9a\u3067\u3001\u6295\u7968\u753b\u9762\u3082\u7d50\u679c\u753b\u9762\u3092\u78ba\u8a8d\u3057\u305f\u5f8c\u306f\u3001\"docker service ls\"\u306e\u8868\u793a\u3092\u843d\u3061\u7740\u3044\u3066\u898b\u307e\u3059\u3002\n\u300cvote\u306f2\u3064\u3001result\u306f1\u3064\u3057\u304b\u306a\u3044\u300d\u2192\u300c\u3057\u304b\u3057\u3001\u5168\u3066\u306eGIP\u304b\u3089\u30a2\u30af\u30bb\u30b9\u304c\u53ef\u80fd\u3060\u3063\u305f\u300d\n\nDocker 1.12: swarm \u30e2\u30fc\u30c9\u3068 Ingress Load Balancing \u6982\u8981\u304b\u3089\u4ee5\u4e0b\u306e\u56f3\u3092\u5f15\u7528\u3057\u307e\u3059\u3002\n\n\u3069\u3046\u3084\u3089docker\u304c\u4e0a\u624b\u3044\u3053\u3068\u3092\u3084\u3063\u3066\u304f\u308c\u3066\u3044\u308b\u3088\u3046\u3067\u3059\u3002\uff08\u5c0f\u4e26\u611f\uff09\n\u8a73\u7d30\u306f\u5f15\u7528\u5143\u306ePocketstudio Technology Log\u306e\u8a18\u4e8b\u3092\u5fa1\u89a7\u304f\u3060\u3055\u3044\u3002\n\u4ed6\u306b\u3082\u7d20\u6674\u3089\u3057\u3044\u6280\u8853\u8a18\u4e8b\u304c\u63b2\u8f09\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n\n9. terraform\u3067\u4e00\u62ec\u304a\u7247\u4ed8\u3051\n\u4e00\u901a\u308a\u306e\u691c\u8a3c\u304c\u7d42\u308f\u3063\u305f\u306e\u3067\u3001\u7acb\u3061\u4e0a\u3052\u305f\u30b5\u30fc\u30d0\u7fa4\u3092\u505c\u6b62\u3057\u307e\u3059\u3002\nsudo docker stack rm vote\u3092\u5b9f\u884c\u3057\u3066docker\u306e\u30b5\u30fc\u30d3\u30b9\u3092\u505c\u6b62\u3057\u3001GCP\u30b3\u30f3\u30bd\u30fc\u30eb\u304b\u3089\u30dd\u30c1\u30dd\u30c1\u30b5\u30fc\u30d0\u3092\u524a\u9664\u3059\u308b\u3001\u306a\u3093\u3066\u9762\u5012\u306a\u3053\u3068\u306f\u3057\u307e\u305b\u3093\u3002\nterraform\u304b\u3089\u4ee5\u4e0b\u306e\u30b3\u30de\u30f3\u30c9\u3092\u6295\u5165\u3059\u308b\u3060\u3051\u3067\u3001\u304a\u7247\u4ed8\u3051\u304c\u5b8c\u4e86\u3057\u307e\u3059\u3002\nterraform destroy\n\n\u78ba\u8a8d\u306e\u305f\u3081\u306e\u30d7\u30ed\u30f3\u30d7\u30c8\u304c\u8868\u793a\u3055\u308c\u308b\u305f\u3081\u3001\"yes\"\u3068\u5165\u529b\u3057\u307e\u3059\u3002\n\nDestroy complete! Resources: 4 destroyed.\u3068\u8868\u793a\u3055\u308c\u305f\u3053\u3068\u3092\u78ba\u8a8d\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\u4e07\u304c\u4e00\u6d88\u3057\u5fd8\u308c\u304c\u3042\u3063\u3066\u306f\u304a\u8ca1\u5e03\u7684\u306b\u5371\u967a\u3067\u3059\u306e\u3067\u3001GCP\u306e\u30b3\u30f3\u30bd\u30fc\u30eb\u304b\u3089\u3082\u524a\u9664\u3055\u308c\u3066\u3044\u306a\u3044\u30b5\u30fc\u30d0\u304c\u7121\u3044\u3053\u3068\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\u30cf\u30f3\u30d0\u30fc\u30ac\u30e1\u30cb\u30e5\u30fc\u304b\u3089\u300cCompute Engine\u300d\u3092\u9078\u629e\u3057\u3001\u521d\u671f\u753b\u9762\u3067\u3042\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3059\u308c\u3070\u3001\u4f5c\u696d\u306f\u5b8c\u4e86\u3068\u306a\u308a\u307e\u3059\u3002\n\n\n\u53c2\u8003\n\n\u524d\u4f5b\u3055\u3093\u306e\u30d7\u30ec\u30bc\u30f3\uff08Docker\u306e\u9762\u767d\u3055\u3092\u6559\u3048\u3066\u304f\u308c\u305f\uff09\n\nhttps://www.slideshare.net/zembutsu/ \u306edocker\u7cfb\u30b9\u30e9\u30a4\u30c9\uff08\u524d\u4f5b\u3055\u3093\u8cc7\u6599\u306e\u4f5c\u308a\u8fbc\u307f\u306f\u672c\u5f53\u306b\u3059\u3054\u3044\uff09\n\nhttps://pocketstudio.net/2016/06/23/docker-1-12-swarm-mode-and-ingress-load-balancing/ (\u3053\u3053\u3082\u524d\u4f5b\u3055\u3093...)\nhttps://www.terraform.io/docs/providers/google/index.html\nhttps://www.terraform.io/docs/providers/google/r/compute_instance.html\nhttps://www.terraform.io/docs/providers/google/r/compute_firewall.html\nhttps://docs.docker.com/engine/installation/linux/centos/\nhttps://docs.docker.com/engine/swarm/swarm-tutorial/\nhttps://blog.docker.com/2017/01/whats-new-in-docker-1-13/\nhttps://github.com/docker/example-voting-app.git\nhttps://cloudplatform-jp.googleblog.com/\n\n\u4eca\u5e74\u306b\u5165\u3063\u3066docker\u306eVersion1.13\u304c\u30ea\u30ea\u30fc\u30b9\u3055\u308c\u305f\u3053\u3068\u3092\u5c0f\u8033\u306b\u631f\u3093\u3060\u306e\u3067\u3001\n\u666e\u6bb5\u306f\u30c8\u30e9\u30c7\u30a3\u30b7\u30e7\u30ca\u30eb\u306a\u30aa\u30f3\u30d7\u30ec\u74b0\u5883\u3057\u304b\u89e6\u3063\u3066\u306a\u3044Ops\u304c\u3001\u52c9\u5f37\u304c\u3066\u3089\u8a66\u3057\u3066\u307f\u305f\u30e1\u30e2\u3067\u3059\u3002\n\n# \u76ee\u7684\n\u4ee5\u4e0b\u306e\u304b\u3063\u3053\u3044\u3044\u6280\u8853\u3092\u89e6\u3063\u3066\u307f\u308b\uff08\u666e\u6bb5\u30aa\u30f3\u30d7\u30ecCentOS5\u89e6\u3063\u3066\u307e\u3059\u304c\u4f55\u304b\uff09\n\n+ GCP\n+ terraform\n+ docker\n\n\u69cb\u6210\u3068\u3057\u3066\u306f\u3053\u3093\u306a\u611f\u3058\u3092\u76ee\u6307\u3057\u307e\u3059\n![image](https://qiita-image-store.s3.amazonaws.com/0/120707/f50f32bf-7bb8-7744-0f54-b572c324e42f.png)\n\n\n\u69cb\u6210\u306e\u30dd\u30a4\u30f3\u30c8\u3068\u3057\u3066\u306f\n+ GKE(Google Container Engine)\u3058\u3083\u306a\u304f\u3066\u6562\u3048\u3066GCE(Google Compute Engine)\u3067CentOS7\u30b5\u30fc\u30d0\u3092\u69cb\u7bc9\u3059\u308b(\u30aa\u30f3\u30d7\u30ec\u3092\u30a4\u30e1\u30fc\u30b8)\n+ docker\u306f\u3082\u3061\u308d\u3093swarm\u30e2\u30fc\u30c9\u3067\u30af\u30e9\u30b9\u30bf\u3092\u69cb\u6210\u3059\u308b\n+ CentOS7\u30b5\u30fc\u30d0\u306e\u69cb\u7bc9\u306a\u3069\u3001GCP\u306e\u64cd\u4f5c\u306fterraform\u3067\"Infrastructure as code\"\u3063\u307d\u304f\u69cb\u7bc9\u3059\u308b\n\n\n# \u624b\u9806\n## \u524d\u63d0\u6761\u4ef6\n+ GCP\u306e\u30a2\u30ab\u30a6\u30f3\u30c8\u767b\u9332\u306f\u5b8c\u4e86\u3057\u3066\u3044\u308b\u3053\u3068\n+ terraform\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u304c\u5b8c\u4e86\u3057\u3066\u3044\u308b\u3053\u3068\n\n## \u624b\u9806\u6982\u8981\n1. terraform\u30d5\u30a1\u30a4\u30eb\u3092\u6e96\u5099\u3059\u308b\n1. terraform\u3067CentOS7\u30b5\u30fc\u30d01\u53f0\u3092GCE\u306b\u69cb\u7bc9\n1. docker\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n1. terraform\u30672\u53f0\u76ee\u30013\u53f0\u76ee\u306eCentOS7\u30b5\u30fc\u30d0\u3092\u3067GCE\u306b\u69cb\u7bc9(docker\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3082terraform\u3067\u6307\u793a)\n1. docker\u3067swarm mode\u3092\u69cb\u7bc9(\u3053\u3053\u307e\u3067\u306fv1.12\u306e\u6a5f\u80fd)\n1. docker\u3067\"stack deploy\"\u3092\u8a66\u3059(v.1.13\u65b0\u6a5f\u80fd)\n1. terraform\u3067GCP\u306eFireWall\u3092\u8a2d\u5b9a\u3059\u308b\n1. \"stack deploy\"\u3067\u30c7\u30d7\u30ed\u30a4\u3057\u305f\u30c7\u30e2\u7528\u30a2\u30d7\u30ea\u306e\u52d5\u4f5c\u78ba\u8a8d\n1. terraform\u3067\u4e00\u62ec\u304a\u7247\u4ed8\u3051\n\n## \u624b\u9806\u8a73\u7d30\n### 1.terraform\u30d5\u30a1\u30a4\u30eb\u3092\u6e96\u5099\u3059\u308b\n\u4efb\u610f\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306b[terraform\u516c\u5f0f\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u306e\"Google Provider\"](https://www.terraform.io/docs/providers/google/index.html)\u3092\u53c2\u8003\u306b\u4ee5\u4e0b\u306e3\u30d5\u30a1\u30a4\u30eb\u3092\u6e96\u5099\u3057\u307e\u3059\u3002\n\n+ \u8a8d\u8a3c\u7528\u306eJSON\u30d5\u30a1\u30a4\u30eb(GCP\u304b\u3089\u53d6\u5f97)\n+ \u30af\u30ec\u30c7\u30f3\u30b7\u30e3\u30eb\u3001\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u540d\u3001\u30ea\u30fc\u30b8\u30e7\u30f3\u3092\u8a18\u8f09\u3059\u308b ***\"google_cloud_provider.tf\"***\n+ \u69cb\u7bc9\u3059\u308b\u30b5\u30fc\u30d0\u69cb\u6210\u3092\u8a18\u8f09\u3059\u308b ***\"google_cloud_instanc1.tf\"***\n\n\u203bterraform\u306f\u5b9f\u884c\u3057\u305f\u30d1\u30b9\u306e\"*.tf\"\u30d5\u30a1\u30a4\u30eb\u3092\u3059\u3079\u3066\u8aad\u307f\u8fbc\u3093\u3067\u51e6\u7406\u3092\u3057\u3066\u304f\u308c\u308b\u305f\u3081\u3001\u30d5\u30a1\u30a4\u30eb\u540d\u306f\u4efb\u610f\u3067\u3001\u304b\u3064\u5206\u5272\u3059\u308b\u5fc5\u8981\u306f\u3042\u308a\u307e\u305b\u3093\u304c\u3001\u308f\u304b\u308a\u3084\u3059\u3044\u306e\u3067\u2191\u306b\u3057\u3066\u3044\u307e\u3059\n\n#### 1.1 \u8a8d\u8a3c\u7528\u306eJSON\u30d5\u30a1\u30a4\u30eb\u306e\u53d6\u5f97\n\u8a8d\u8a3c\u7528\u306eJSON\u30d5\u30a1\u30a4\u30eb\u306f[Google Developers Console](https://console.developers.google.com/)\u304b\u3089\u7c21\u5358\u306b\u53d6\u5f97\u3067\u304d\u307e\u3059\u3002\n\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u300c\u8a8d\u8a3c\u60c5\u5831\u300d\u2192\u300c\u30b5\u30fc\u30d3\u30b9\u30a2\u30ab\u30a6\u30f3\u30c8\u30ad\u30fc\u300d\u3092\u30af\u30ea\u30c3\u30af\u3057\u307e\u3059\u3002\n![image](https://qiita-image-store.s3.amazonaws.com/0/120707/19d6868d-3b54-63f9-4011-b0e0d9ce156f.png)\n\n\u6b21\u306e\u753b\u9762\u3067\u306f\u30c7\u30d5\u30a9\u30eb\u30c8\u306e\u30b5\u30fc\u30d3\u30b9\u30a2\u30ab\u30a6\u30f3\u30c8\u3092\u30ea\u30b9\u30c8\u304b\u3089\u9078\u3073\u3001\u51fa\u529b\u5f62\u5f0f\u304cJSON\u3068\u306a\u3063\u3066\u3044\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3057\u3066\u300c\u4f5c\u6210\u300d\u3092\u30af\u30ea\u30c3\u30af\u3057\u307e\u3059\u3002\n![image](https://qiita-image-store.s3.amazonaws.com/0/120707/819a1f3a-1e92-cb90-20ff-8792956a24f9.png)\n\n\u3053\u308c\u3067\u8a8d\u8a3c\u7528\u306eJSON\u30d5\u30a1\u30a4\u30eb\u304c\u53d6\u5f97\u3067\u304d\u307e\u3057\u305f\u3002\n\n#### 1.2 \u30af\u30ec\u30c7\u30f3\u30b7\u30e3\u30eb\u3001\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u540d\u3001\u30ea\u30fc\u30b8\u30e7\u30f3\u3092\u8a18\u8f09\u3059\u308b ***\"google_cloud_provider.tf\"*** \u306e\u4f5c\u6210\n\nterraform\u306e[\u30b5\u30f3\u30d7\u30eb](https://www.terraform.io/docs/providers/google/index.html)\u3092\u305d\u306e\u307e\u307e\u6d41\u7528\u3057\u3066\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u8a18\u8f09\u3057\u307e\u3059\u3002\n\n```\n// Configure the Google Cloud provider\nprovider \"google\" {\n  credentials = \"${file(\"morihayatest-hogehoge.json\")}\"\n  project     = \"morihayatest\"\n  region      = \"us-central1\"\n}\n```\n\u203b\"json\u306e\u30d5\u30a1\u30a4\u30eb\u540d\"\u3001\"\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u540d\"\u306f\u74b0\u5883\u3054\u3068\u306b\u5909\u66f4\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n#### 1.3 \u69cb\u7bc9\u3059\u308b\u30b5\u30fc\u30d0\u69cb\u6210\u3092\u8a18\u8f09\u3059\u308b ***\"google_cloud_instanc1.tf\"***\u306e\u4f5c\u6210\n\u3053\u3053\u3067\u3082terraform\u306e[\u30b5\u30f3\u30d7\u30eb](https://www.terraform.io/docs/providers/google/r/compute_instance.html)\u3092\u6d41\u7528\u3057\u3066\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u8a18\u8f09\u3057\u307e\u3059\u3002\n\n```\nresource \"google_compute_instance\" \"centos7-01\" {\n  name         = \"centos7-01\"\n  machine_type = \"n1-standard-1\"\n  zone         = \"us-central1-a\"\n\n  tags = [\"terraform\",\"test\"]\n\n  disk {\n    image = \"centos-cloud/centos-7\"\n  }\n\n  // Local SSD disk\n  disk {\n    type    = \"local-ssd\"\n    scratch = true\n  }\n\n  network_interface {\n    network = \"default\"\n    access_config {\n      // Ephemeral IP\n    }\n  }\n\n  metadata {\n    foo = \"bar\"\n  }\n\n  metadata_startup_script = \"echo hi > /test.txt\"\n\n  service_account {\n    scopes = [\"userinfo-email\", \"compute-ro\", \"storage-ro\"]\n  }\n}\n\n```\n\nterraform doc\u306e\u30b5\u30f3\u30d7\u30eb\u304b\u3089\u5909\u66f4\u3057\u305f\u306e\u306f\u4ee5\u4e0b\u306e\u70b9\n\n+ resource\u306e2\u500b\u3081\u306e\u5f15\u6570\u3092\"default\"\u304b\u3089\"centos7-01\"\u3078\uff08\u4ed6\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3068\u91cd\u8907\u3059\u308b\u3068\u30a8\u30e9\u30fc\u306b\u306a\u308b\uff09\n+ name\u3092\"test\"\u304b\u3089\"centos7-01\"\u3078(\u3053\u308c\u304c\u30db\u30b9\u30c8\u540d\u306b\u306a\u308b)\n+ image\u3092\u201ddebian-8\"\u304b\u3089\"centos-7\"\u3078(\u666e\u6bb5CentOS\u4f7f\u3063\u3066\u308b\u304b\u3089...)\n\n\u203b\u4e0d\u5fc5\u8981\u306a\u8a18\u8ff0\u304c\u3044\u304f\u3064\u304b\u3042\u308a\u307e\u3059\u304c\u3001\u3068\u308a\u3042\u3048\u305a\u52d5\u304b\u3059\u306e\u304c\u76ee\u7684\u306e\u305f\u3081\u30b9\u30eb\u30fc\n\n### 2. terraform\u3067CentOS7\u30b5\u30fc\u30d01\u53f0\u3092GCE\u306b\u69cb\u7bc9\n#### 2.1 terrform plan\u3067\u5b9a\u7fa9\u306e\u30c1\u30a7\u30c3\u30af\n1\u3067\u4f5c\u6210\u3057\u305f3\u30d5\u30a1\u30a4\u30eb\u306e\u3042\u308b\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3078\u30bf\u30fc\u30df\u30ca\u30eb\u3067\u79fb\u52d5\u3057\u3001\u4ee5\u4e0b\u3092\u5b9f\u884c\u3057\u307e\u3059\n\n```\nterraform plan\n```\n\u30a8\u30e9\u30fc\u304c\u306a\u3051\u308c\u3070\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u51fa\u529b\u306b\u306a\u308a\u307e\u3059\u3002\u6700\u5f8c\u306e`\"Plan: 1 to add, 0 to change, 0 to destroy.\"`\u3092\u78ba\u8a8d\u3067\u304d\u308c\u3070OK\u3067\u3059\u3002\n\n```\n$ terraform plan\nRefreshing Terraform state in-memory prior to plan...\nThe refreshed state will be used to calculate this plan, but\nwill not be persisted to local or remote state storage.\n\n\nThe Terraform execution plan has been generated and is shown below.\nResources are shown in alphabetical order for quick scanning. Green resources\nwill be created (or destroyed and then created if an existing resource\nexists), yellow resources are being changed in-place, and red resources\nwill be destroyed. Cyan entries are data sources to be read.\n\nNote: You didn't specify an \"-out\" parameter to save this plan, so when\n\"apply\" is called, Terraform can't guarantee this is what will execute.\n\n+ google_compute_instance.default\n    can_ip_forward:                                      \"false\"\n    disk.#:                                              \"2\"\n    disk.0.auto_delete:                                  \"true\"\n    disk.0.image:                                        \"centos-cloud/centos-7\"\n    disk.1.auto_delete:                                  \"true\"\n    disk.1.scratch:                                      \"true\"\n    disk.1.type:                                         \"local-ssd\"\n    machine_type:                                        \"n1-standard-1\"\n    metadata.%:                                          \"1\"\n    metadata.foo:                                        \"bar\"\n    metadata_fingerprint:                                \"<computed>\"\n    name:                                                \"centos7-01\"\n    network_interface.#:                                 \"1\"\n    network_interface.0.access_config.#:                 \"1\"\n    network_interface.0.access_config.0.assigned_nat_ip: \"<computed>\"\n    network_interface.0.address:                         \"<computed>\"\n    network_interface.0.name:                            \"<computed>\"\n    network_interface.0.network:                         \"default\"\n    self_link:                                           \"<computed>\"\n    service_account.#:                                   \"1\"\n    service_account.0.email:                             \"<computed>\"\n    service_account.0.scopes.#:                          \"3\"\n    service_account.0.scopes.1632638332:                 \"https://www.googleapis.com/auth/devstorage.read_only\"\n    service_account.0.scopes.2428168921:                 \"https://www.googleapis.com/auth/userinfo.email\"\n    service_account.0.scopes.2862113455:                 \"https://www.googleapis.com/auth/compute.readonly\"\n    tags.#:                                              \"2\"\n    tags.3632233996:                                     \"test\"\n    tags.969816526:                                      \"terraform\"\n    tags_fingerprint:                                    \"<computed>\"\n    zone:                                                \"us-central1-a\"\n\n\nPlan: 1 to add, 0 to change, 0 to destroy.\n```\n\n#### 2.2 terrform apply\u3067\u30b5\u30fc\u30d0\u30c7\u30d7\u30ed\u30a4\n\n\u5b9f\u969b\u306bGCE\u4e0a\u306b\u30b5\u30fc\u30d0\u3092\u69cb\u7bc9\u3057\u307e\u3059\u3002\n\n```\nterraform apply\n```\n\nterraform plan\u5b9f\u884c\u6642\u3068\u307b\u3068\u3093\u3069\u540c\u3058\u3088\u3046\u306a\u30ed\u30b0\u304c\u51fa\u529b\u3055\u308c\u307e\u3059\u3002\n\n```\n$ terraform apply\ngoogle_compute_instance.default: Creating...\n  can_ip_forward:                                      \"\" => \"false\"\n  disk.#:                                              \"\" => \"2\"\n  disk.0.auto_delete:                                  \"\" => \"true\"\n  disk.0.image:                                        \"\" => \"centos-cloud/centos-7\"\n\n~~~~\u7701\u7565~~~\n\ngoogle_compute_instance.default: Still creating... (10s elapsed)\ngoogle_compute_instance.default: Still creating... (20s elapsed)\ngoogle_compute_instance.default: Creation complete\n\nApply complete! Resources: 1 added, 0 changed, 0 destroyed.\n\nThe state of your infrastructure has been saved to the path\nbelow. This state is required to modify and destroy your\ninfrastructure, so keep it safe. To inspect the complete state\nuse the `terraform show` command.\n\nState path: terraform.tfstate\n```\n\nGCP\u306e\u30b3\u30f3\u30bd\u30fc\u30eb\u306b\u30ed\u30b0\u30a4\u30f3\u3057\u3001\u5de6\u4e0a\u306e\u30cf\u30f3\u30d0\u30fc\u30ac\u30e1\u30cb\u30e5\u30fc('\u4e09'\u307f\u305f\u3044\u306a\u30dc\u30bf\u30f3)\u304b\u3089\u300cCompute Engine\u300d\u3092\u9078\u629e\u3057\u307e\u3059\u3002\n\u554f\u984c\u304c\u306a\u3051\u308c\u3070\u30b5\u30fc\u30d0\u30fc\u304c1\u53f0\u8d77\u52d5\u3057\u3066\u3044\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3067\u304d\u307e\u3059\u3002\n![image](https://qiita-image-store.s3.amazonaws.com/0/120707/3d98850e-425a-b35f-9a07-90bba5a98c89.png)\n\n\n### 3. docker\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\u8d77\u52d5\u3057\u305f\u30b5\u30fc\u30d0\u3078docker\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u307e\u3059\u3002\n\n#### 3.1 \u30b5\u30fc\u30d0\u3078\u30ed\u30b0\u30a4\u30f3\nGCP\u30b3\u30f3\u30bd\u30fc\u30eb\u306e\"SSH\"\u30dc\u30bf\u30f3\u3092\u30af\u30ea\u30c3\u30af\u3059\u308b\u3053\u3068\u3067\u3001\u30b5\u30fc\u30d0\u3078\u30ed\u30b0\u30a4\u30f3\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\uff08\u3053\u306e\u30ed\u30b0\u30a4\u30f3\u306e\u7c21\u5358\u3055\u306b\u611f\u52d5\u3057\u307e\u3057\u305f\uff09\n\n#### 3.2 \u30ec\u30dd\u30b8\u30c8\u30ea\u767b\u9332\n\u3053\u3053\u304b\u3089\u306f[docker\u516c\u5f0f\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8](https://docs.docker.com/engine/installation/linux/centos/)\u306b\u5f93\u3063\u3066\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3092\u3057\u3066\u304d\u307e\u3059\u3002\n\u5404\u30c7\u30a3\u30b9\u30c8\u30ea\u30d3\u30e5\u30fc\u30b7\u30e7\u30f3\u7528\u306b\u3001\u4e01\u5be7\u306b\u624b\u9806\u304c\u8a18\u8f09\u3055\u308c\u3066\u3044\u307e\u3059\u304c\u3001\u3053\u3053\u3067\u306f\u6700\u4f4e\u9650\u5fc5\u8981\u306a\u30b3\u30de\u30f3\u30c9\u3060\u3051\u629c\u7c8b\u3057\u307e\u3059\u3002\n\n```\n# \u30ec\u30dd\u30b8\u30c8\u30ea\u767b\u9332\u306e\u305f\u3081\u306e\"yum-utils\"\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\nsudo yum install -y yum-utils\n\n# \u30ec\u30dd\u30b8\u30c8\u30ea\u767b\u9332\nsudo yum-config-manager \\\n    --add-repo \\\n    https://docs.docker.com/engine/installation/linux/repo_files/centos/docker.repo\n\n```\n\n#### 3.3 docker\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\nyum\u3067\u3042\u3063\u3055\u308a\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3067\u304d\u307e\u3059\u3002\n\n```\nsudo yum -y install docker-engine\n```\n\n#### 3.4 docker\u8d77\u52d5\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u5f8c\u306f\u505c\u6b62\u3057\u3066\u3044\u308b\u305f\u3081\u3001\u8d77\u52d5\u3057\u307e\u3059\u3002\n\n```\nsudo systemctl start docker\n```\n\n\n#### 3.5 docker\u8d77\u52d5\u78ba\u8a8d\n\u57fa\u672c\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u78ba\u8a8d\u3068\u3001\"hello world\"\u3092\u5b9f\u884c\u3057\u307e\u3059\u3002\n\n```\n# \u30d0\u30fc\u30b8\u30e7\u30f3\u78ba\u8a8d\nsudo docker --version\n\u2192\"Docker version 1.13.1, build 092cba3\"\n\n# hello world\nsudo docker run hello-world\n\u2192\"Unable to find image 'hello-world:latest' locally\"\u3068\u51fa\u3066\u3001docker HUB\u304b\u3089\u30a4\u30e1\u30fc\u30b8\u3092\u53d6\u5f97\u3057\u307e\u3059\u3002\n```\n\n\u3053\u3053\u307e\u3067\u3067\u4ee5\u4e0b\u306e\u69cb\u6210\u306b\u306a\u308a\u307e\u3057\u305f\u3002(hello-world\u304capp\u306a\u306e\u304b\u3068\u3044\u3046\u30c4\u30c3\u30b3\u30df\u306f\u7121\u3057\u3067...)\n![image](https://qiita-image-store.s3.amazonaws.com/0/120707/5228ba0a-2731-7734-944e-7576c01ee9c5.png)\n\n### 4. terraform\u30672\u53f0\u76ee\u30013\u53f0\u76ee\u306eCentOS7\u30b5\u30fc\u30d0\u3092\u3067GCE\u306b\u69cb\u7bc9(docker\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3082terraform\u3067\u6307\u793a)\n\n#### 4.1 terraform\u30d5\u30a1\u30a4\u30eb\u306e\u6e96\u5099\n\u5f15\u304d\u7d9a\u304d2\u53f0\u76ee\u30013\u53f0\u76ee\u306e\u30b5\u30fc\u30d0\u3092\u69cb\u7bc9\u3057\u3066\u3044\u304d\u307e\u3059\u304c\u3001docker\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3092\u90fd\u5ea6\u3084\u308b\u306e\u306f\u9762\u5012\u3067\u3059\u3002\n\u305d\u3053\u3067\u4e00\u5de5\u592b\u3068\u3057\u3066\"metadata_startup_script\"\u3092\u6d3b\u7528\u3057\u307e\u3059\u3002\n\"metadata_startup_script\"\u306b\u6307\u5b9a\u3055\u308c\u305f\u30b3\u30de\u30f3\u30c9\u306f\u30b5\u30fc\u30d0\u8d77\u52d5\u6642\u306b\u5b9f\u884c\u3055\u308c\u308b\u305f\u3081\u3001docker\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u306e\u305f\u3081\u306e\u4e00\u9023\u306e\u30b3\u30de\u30f3\u30c9\u3092\u8a18\u8f09\u3057\u3066\u304a\u304f\u3053\u3068\u3067\u3001\u69cb\u7bc9\u306e\u81ea\u52d5\u5316\u3092\u56f3\u308a\u307e\u3059\u3002\n\u307e\u305f\u30012\u53f0\u76ee\u30013\u53f0\u76ee\u306e\u56fa\u6709\u5024\u3067\u3042\u308b\u30db\u30b9\u30c8\u540d\u306a\u3069\u306e\u90e8\u5206\u3092\u5909\u66f4\u3057\u307e\u3059\u3002\n\n```\nresource \"google_compute_instance\" \"centos7-02\" {\n  name         = \"centos7-02\"\n\n~~~\u7701\u7565~~~\n\n  metadata_startup_script = \"yum install -y yum-utils ; yum-config-manager --add-repo https://docs.docker.com/engine/installation/linux/repo_files/centos/docker.repo ; yum -y install docker-engine ; systemctl start docker\"\n\n~~~\u7701\u7565~~~\n\n```\n\n\u203b\u304a\u305d\u3089\u304f\u3001metadata_startup_script\u306f\u4f7f\u3044\u65b9\u6b21\u7b2c\u3067\u7121\u9650\u306e\u53ef\u80fd\u6027\u304c\u3042\u308a\u305d\u3046\u3067\u3059\u3002GCS\u304b\u3089\u30b9\u30af\u30ea\u30d7\u30c8\u53d6\u3063\u3066\u304d\u3066\u69cb\u7bc9\u81ea\u52d5\u5316\u3068\u304b\u3057\u305f\u3089\u30b9\u30c6\u30ad\n\n\u4e0a\u8a18\u306e\u5909\u66f4\u3092\u3057\u305fterraform\u30d5\u30a1\u30a4\u30eb\u3092\u65e2\u5b58\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3078\u914d\u7f6e\u3057\u307e\u3059\u3002\n\n+ google_cloud_provider.tf\n+ google_cloud_instanc1.tf\n+ google_cloud_instanc2.tf \u2190\u2605NEW\n+ google_cloud_instanc3.tf \u2190\u2605NEW\n\n\n#### 4.2 terraform\u3067\u30c7\u30d7\u30ed\u30a4\n1\u53f0\u76ee\u3092\u4f5c\u6210\u3057\u305f\u6642\u3068\u540c\u3058\u624b\u9806\u3067\u30b5\u30fc\u30d0\u3092\u69cb\u7bc9\u3057\u3066\u3044\u304d\u307e\u3059\u3002\n\n```\nterraform plan\n\u2192\"Plan: 2 to add, 0 to change, 0 to destroy.\"\u3092\u78ba\u8a8d\n\nterraform apply\n\u2192\"Apply complete! Resources: 2 added, 0 changed, 0 destroyed.\"\u3092\u78ba\u8a8d\n```\n\n#### 4.3 docker\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3092\u78ba\u8a8d\n2\u53f0\u76ee\u30013\u53f0\u76ee\u306e\u30b5\u30fc\u30d0\u306bssh\u30ed\u30b0\u30a4\u30f3\u3057\u3001docker\u304c\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3055\u308c\u3066\u3044\u308b\u304b\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n```\nsudo docker --version\n\u2192\u554f\u984c\u306a\u304f\u30d0\u30fc\u30b8\u30e7\u30f3\u304c\u8868\u793a\u3055\u308c\u308b\u3053\u3068\u3092\u78ba\u8a8d\n```\n\n\u3053\u3053\u307e\u3067\u3067\u4ee5\u4e0b\u306e\u72b6\u614b\u306b\u306a\u308a\u307e\u3057\u305f\u3002\n![image](https://qiita-image-store.s3.amazonaws.com/0/120707/af86fd3e-7356-4a67-29b5-93b4ed1785b0.png)\n\n### 5. docker\u3067swarm mode\u3092\u69cb\u7bc9(\u3053\u3053\u307e\u3067\u306fv1.12\u306e\u6a5f\u80fd)\n\u3044\u3088\u3044\u3088docker swarm mode\u3067\u30af\u30e9\u30b9\u30bf\u3092\u69cb\u7bc9\u3057\u3066\u3044\u304d\u307e\u3059\u3002\n\u3053\u3053\u3067\u3082[docker\u516c\u5f0f\u306e\u30c1\u30e5\u30fc\u30c8\u30ea\u30a2\u30eb](https://docs.docker.com/engine/swarm/swarm-tutorial/)\u306b\u5f93\u3044\u307e\u3059\u304c\u3001\u3055\u3059\u304c\u30ef\u30fc\u30eb\u30c9\u30ef\u30a4\u30c9\u306a\u30d7\u30ed\u30c0\u30af\u30c8\u306f\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u304c\u3057\u3063\u304b\u308a\u3057\u3066\u3044\u308b\u3068\u611f\u5fc3\u3057\u307e\u3059\u3002\n\n#### 5.1 swarm manager\u30b5\u30fc\u30d0\u3067swam mode\u958b\u59cb\nswarm mode\u3092\u958b\u59cb\u3059\u308b\u305f\u3081\u306b\u30011\u53f0\u306e\u30b5\u30fc\u30d0\u3092\u30de\u30cd\u30fc\u30b8\u30e3\u3068\u3057\u3066\u521d\u671f\u5316\u3057\u307e\u3059\u3002\n\u30de\u30cd\u30fc\u30b8\u30e3\u4f5c\u6210\u6642\u306b\u305d\u306e\u4ed6\u306e\u30ef\u30fc\u30ab\u30fc\u30b5\u30fc\u30d0\u3068\u901a\u4fe1\u3059\u308b\u305f\u3081\u306eIP\u3092\u6307\u5b9a\u3057\u307e\u3059\u3002\n\n```\n# ip\u78ba\u8a8d\nip a\n\u2192\u4ed6\u30b5\u30fc\u30d0\u3068\u901a\u4fe1\u53ef\u80fd\u306aIP\u3092\u78ba\u8a8d \"10.128.xxx.xxx/32\"\n\n# swam manager\u306e\u958b\u59cb\nsudo docker swarm init --advertise-addr 10.128.xxx.xxx\n```\n\n\u30b3\u30de\u30f3\u30c9\u304c\u6210\u529f\u3059\u308b\u3068\u3001\u4ed6\u306e\u30ef\u30fc\u30ab\u30fc\u30b5\u30fc\u30d0\u3067\u5b9f\u884c\u3059\u308b\u305f\u3081\u306e\u30b3\u30de\u30f3\u30c9\u304c\u51fa\u529b\u3055\u308c\u307e\u3059\u3002\n\n```\n$ sudo docker swarm init --advertise-addr 10.128.0.2\nSwarm initialized: current node (hogehoge) is now a manager.\n\nTo add a worker to this swarm, run the following command:\n\n    docker swarm join \\\n    --token hogehoge-fugafuga \\\n    10.128.xxx.xxx:2377\n\nTo add a manager to this swarm, run 'docker swarm join-token manager' and follow the instructions.\n```\n\n5.2 swarm woker\u30b5\u30fc\u30d0\u3092swarm\u3078\u53c2\u52a0\n\nswarm\u306b\u30ef\u30fc\u30ab\u30fc\u30b5\u30fc\u30d0\u3092\u53c2\u52a0\u3055\u305b\u307e\u3059\u304c\u3001\u6298\u89d2\u306a\u306e\u3067\u30de\u30cd\u30fc\u30b8\u30e3\u30b5\u30fc\u30d0\u3067\u30e2\u30cb\u30bf\u3057\u307e\u3059\u3002\n\n```\nsudo watch -n 1 docker node ls\n```\n\n```\nID                           HOSTNAME    STATUS  AVAILABILITY  MANAGER STATUS\nhogehogehogehogehogehogeh *  centos7-01  Ready   Active        Leader\n\u2192\"swarm init\"\u76f4\u5f8c\u306f\u30de\u30cd\u30fc\u30b8\u30e3\u306e1\u53f0\u306e\u307f\n```\n\nswarm init\u6642\u306b\u51fa\u529b\u3055\u308c\u305f\u30b3\u30de\u30f3\u30c9\u3092\u3001\u4ed6\u306e\u30b5\u30fc\u30d0\u3067\u5b9f\u884c\u3057\u307e\u3059\u3002\n\u203bsudo\u3092\u4ed8\u3051\u308b\u306e\u3092\u304a\u5fd8\u308c\u306a\u304f\n\n```\nsudo docker swarm join \\\n--token hogehoge-fugafuga \\\n10.128.xxx.xxx:2377\n\u2192\"This node joined a swarm as a worker.\"\n```\n\n```\njoin\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3059\u308b\u3073\u306b\u30b5\u30fc\u30d0\u304c\u5897\u3048\u3066\u884c\u304d\u307e\u3059\nID                           HOSTNAME    STATUS  AVAILABILITY  MANAGER STATUS\nhogehogehogehogehogehogeh *  centos7-01  Ready   Active        Leader\nfugafugafugafugafugafugaf    centos7-02  Ready   Active\nmogemogemogemogemogemogem    centos7-03  Ready   Active\n```\n\n#### 5.3 swarm\u3078\u30b5\u30fc\u30d3\u30b9\u3092\u30c7\u30d7\u30ed\u30a4\n\u3044\u3088\u3044\u3088swarm\u3078\u30b5\u30fc\u30d3\u30b9\u3092\u30c7\u30d7\u30ed\u30a4\u3057\u307e\u3059\u3002\n\nswarm\u306b\u3088\u308b\u30b5\u30fc\u30d3\u30b9\u306e\u62e1\u7e2e\u3092\u30e2\u30cb\u30bf\u3059\u308b\u305f\u3081\u306b\u3001\u30de\u30cd\u30fc\u30b8\u30e3\u30b5\u30fc\u30d0\u3067\u4ee5\u4e0b\u3092\u5b9f\u884c\u3057\u307e\u3059\u3002\n\n```\nsudo watch -n 1 docker service ps helloworld \n\u2192\u30c7\u30d7\u30ed\u30a4\u524d\u306e\u305f\u3081\"Error: No such service: helloworld\"\u3068\u51fa\u307e\u3059\n```\n\n\u3044\u3088\u3044\u3088\u30c7\u30d7\u30ed\u30a4\u3067\u3059\n\n```\nsudo docker service create --replicas 1 --name helloworld alpine ping docker.com\n```\n\n```\n\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u51fa\u529b\u3055\u308c\u307e\u3059\nID            NAME          IMAGE          NODE        DESIRED STATE  CURRENT STATE          ERROR  PORTS  \nhogehogehoge  helloworld.1  alpine:latest  centos7-01  Running        Running 9 seconds ago\n```\n\n\u30b9\u30b1\u30fc\u30eb\u30a2\u30c3\u30d7\u3057\u3066\u307f\u307e\u3057\u3087\u3046\n\n```\nsudo docker service scale helloworld=5\n```\n\n```\n1\u79d2\u3082\u3057\u306a\u3044\u3067\u30b9\u30b1\u30fc\u30eb\u30a2\u30c3\u30d7\u3057\u307e\u3059\u3002\nID            NAME          IMAGE          NODE        DESIRED STATE  CURRENT STATE          ERROR  PORTS   \nhogehogehoge  helloworld.1  alpine:latest  centos7-01  Running        Running 5 minutes ago\nfugafugafuga  helloworld.2  alpine:latest  centos7-02  Running        Running 7 seconds ago\nmogemogemoge  helloworld.3  alpine:latest  centos7-01  Running        Running 8 seconds ago\nnuganuganuga  helloworld.4  alpine:latest  centos7-03  Running        Running 7 seconds ago\nmoemoemoemoe  helloworld.5  alpine:latest  centos7-02  Running        Running 8 seconds ago\n```\n\n\u7d9a\u3044\u3066\u30b9\u30b1\u30fc\u30eb\u30c0\u30a6\u30f3\u3057\u3066\u307f\u307e\u3057\u3087\u3046\n\n```\nsudo docker service scale helloworld=2\n```\n\n```\n\u3042\u3063\u3055\u308a\u30b9\u30b1\u30fc\u30eb\u30c0\u30a6\u30f3\u3057\u307e\u3059\nID            NAME          IMAGE          NODE        DESIRED STATE  CURRENT STATE          ERROR  PORTS  \nfugafugafuga  helloworld.2  alpine:latest  centos7-02  Running        Running 5 minutes ago\nmogemogemoge  helloworld.3  alpine:latest  centos7-01  Running        Running 5 minutes ago\n```\n\n\n#### 5.3 swarm\u304b\u3089\u30b5\u30fc\u30d3\u30b9\u3092\u524a\u9664\n[\u516c\u5f0f\u30c1\u30e5\u30fc\u30c8\u30ea\u30a2\u30eb](https://docs.docker.com/engine/swarm/swarm-tutorial/deploy-service/)\u3067\u306f\u30db\u30b9\u30c8\u30e1\u30f3\u30c6\u30ca\u30f3\u30b9\u3084\u3001\u30ed\u30fc\u30ea\u30f3\u30b0\u30a2\u30c3\u30d7\u30c7\u30fc\u30c8\u306e\u624b\u9806\u3082\u3042\u308a\u307e\u3059\u304c\u3001\u4e00\u65e6\u306f\u6e80\u8db3\u3057\u305f\u306e\u3067\u30b5\u30fc\u30d3\u30b9\u3092\u505c\u6b62\u3057\u307e\u3059\u3002\n\n```\nsudo docker service rm helloworld\n```\n\n\n\u3053\u3053\u307e\u3067\u3067\u3001\u3064\u3044\u306b\u76ee\u6307\u3057\u305f\u69cb\u6210\u304c\u51fa\u6765\u4e0a\u304c\u308a\u307e\u3057\u305f\u3002\n![image](https://qiita-image-store.s3.amazonaws.com/0/120707/f50f32bf-7bb8-7744-0f54-b572c324e42f.png)\n\n### 6. docker\u3067\"stack deploy\"\u3092\u8a66\u3059(v.1.13\u65b0\u6a5f\u80fd)\n\u3044\u3088\u3044\u3088docker v1.13\u306e\u65b0\u6a5f\u80fd\"stack deploy\"\u3092\u8a66\u3057\u307e\u3059\u3002\nv1.13\u306e\u65b0\u6a5f\u80fd\u306f[\"stack deploy\"\u3060\u3051\u3067\u306f\u306a\u3044](https://blog.docker.com/2017/01/whats-new-in-docker-1-13/)\u3067\u3059\u304c\u3001\u76ee\u7389\u3067\u3042\u308b\u3053\u3068\u306f\u9593\u9055\u3044\u7121\u3044\u3067\u3057\u3087\u3046\u3002\n\n\"stack deploy\"\u30b3\u30de\u30f3\u30c9\u3067\u306f\u3001compose file\u3092\u4f7f\u7528\u3057\u3066swarm mode\u3078\u30b5\u30fc\u30d3\u30b9\u3092\u30c7\u30d7\u30ed\u30a4\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\n#### 6.1 \u30c7\u30e2\u7528\u30a2\u30d7\u30ea\u306e\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\ndocker\u306e\u5b9a\u756a(?)\u306e[\u30c7\u30e2\u7528\u30a2\u30d7\u30ea](https://github.com/docker/example-voting-app.git)\u304cGitHub\u3067\u516c\u958b\u3055\u308c\u3066\u3044\u308b\u305f\u3081\u3001\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u307e\u3059\u3002\n\n\n```\n# git\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\nsudo yum install -y git\n\n# \u30c7\u30e2\u7528\u30a2\u30d7\u30ea\u306e\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\ngit clone https://github.com/docker/example-voting-app.git\n```\n\n\u3053\u306e\u30a2\u30d7\u30ea\u306f\u4ee5\u4e0b\u306e\u69cb\u6210\u3068\u306a\u3063\u3066\u3044\u308b\u305d\u3046\u3067\u3059\u3002\n+ TCP5000\u756a\u3067\u6295\u7968\u753b\u9762(voting-app)\n+ TCP5001\u756a\u3067\u7d50\u679c\u753b\u9762(result-app)\n\n![image](https://github.com/docker/example-voting-app/raw/master/architecture.png)\n\n\n\u6298\u89d2\u306a\u306e\u3067compose file\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n```\n# \u30c7\u30d7\u30ed\u30a4\u7528\u306e\u30d5\u30a1\u30a4\u30eb\u3092\u78ba\u8a8d\ncd example-voting-app/\ncat docker-stack.yml\n```\n\nexample-voting-app\u30ea\u30dd\u30b8\u30c8\u30ea\u306b\u306f\u5f93\u6765\u306ecompse file\u3082\u683c\u7d0d\u3055\u308c\u3066\u3044\u308b\u305f\u3081\u3001stack\u7528\u306ecompose file\u3068\u898b\u6bd4\u3079\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\u3069\u3046\u3084\u3089stack\u7528\u306ecompose file\u306b\u306f\u4ee5\u4e0b\u306e\u30d1\u30e9\u30e1\u30bf\u304c\u8ffd\u52a0\u3055\u308c\u3066\u3044\u308b\u3088\u3046\u3067\u3059\u3002\n\n+ replicas\n+ parallelism\n\n\n#### 6.2 \u30c7\u30e2\u7528\u30a2\u30d7\u30ea\u306e\u30c7\u30d7\u30ed\u30a4\n\u30c7\u30d7\u30ed\u30a4\u306e\u52d5\u304d\u3092\u78ba\u8a8d\u3059\u308b\u305f\u3081\u306b\u3001\u30de\u30cd\u30fc\u30b8\u30e3\u30b5\u30fc\u30d0\u3067\u4ee5\u4e0b\u3092\u5b9f\u884c\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\n```\nsudo watch -n 1 docker service ls\nsudo watch -n 1 docker stack ps vote\n```\n\nv1.13\u65b0\u6a5f\u80fd\u3001***\u300cstack deploy\u300d***\u30b3\u30de\u30f3\u30c9\u3067\u3001\u30de\u30cd\u30fc\u30b8\u30e3\u30b5\u30fc\u30d0\u304b\u3089\u30c7\u30d7\u30ed\u30a4\u3092\u5b9f\u884c\u3057\u307e\u3059\u3002\n\n```\nsudo docker stack deploy --compose-file docker-stack.yml vote\n```\n\n\u3082\u308a\u3082\u308a\u3068\u30b5\u30fc\u30d3\u30b9\u304c\u8d77\u52d5\u3057\u3066\u3044\u304f\u3053\u3068\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n```\n# docker service ls\u306e\u7d50\u679c\nID            NAME             MODE        REPLICAS  IMAGE\nhogehogehoge  vote_redis       replicated  2/2       redis:alpine\nfugafugafuga  vote_vote        replicated  2/2       dockersamples/examplevotingapp_vote:before\nnuganuganuga  vote_worker      replicated  1/1       dockersamples/examplevotingapp_worker:latest\nmogemogemoge  vote_db          replicated  1/1       postgres:9.4\nmoemoemoemoe  vote_visualizer  replicated  1/1       dockersamples/visualizer:stable\nhobihobihobi  vote_result      replicated  1/1       dockersamples/examplevotingapp_result:before\n\n# docker stack ps vote\u306e\u7d50\u679c\nID            NAME               IMAGE                                         NODE        DESIRED STATE  CURRENT STATE          ERROR  PORTS\nhoehoehoehoe  vote_worker.1      dockersamples/examplevotingapp_worker:latest  centos7-01  Running        Running about a minute ago\nfuefuefuefue  vote_result.1      dockersamples/examplevotingapp_result:before  centos7-01  Running        Running about a minute ago\nmuomuomuomuo  vote_vote.1        dockersamples/examplevotingapp_vote:before    centos7-03  Running        Running 2 minutes ago\njojojojojojo  vote_db.1          postgres:9.4                                  centos7-01  Running        Running about a minute ago\ngogogogogogo  vote_redis.1       redis:alpine                                  centos7-03  Running        Running 2 minutes\n```\n\n\n### 7. terraform\u3067GCP\u306eFireWall\u3092\u8a2d\u5b9a\u3059\u308b\n\u30a2\u30d7\u30ea\u304c\u7acb\u3061\u4e0a\u304c\u3063\u305f\u3068\u3053\u308d\u3067\u3001\u65e9\u901f\u63a5\u7d9a\u78ba\u8a8d\u3092\u3057\u305f\u304f\u306a\u308a\u307e\u3059\u304c\u3001\u3053\u306e\u307e\u307e\u3067\u306f\u63a5\u7d9a\u3067\u304d\u307e\u305b\u3093\u3002\nGCP\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306f\u3001\u57fa\u672c\u7684\u306b\u5916\u90e8\u304b\u3089\u306e\u30a2\u30af\u30bb\u30b9\u3092\u8a31\u53ef\u3057\u3066\u3044\u306a\u3044\u305f\u3081\u3001FireWall(\u4ee5\u5f8cFW)\u306e\u8a2d\u5b9a\u304c\u5fc5\u8981\u3067\u3059\u3002\n\n#### 7.1 FW\u7528terraform\u30d5\u30a1\u30a4\u30eb\u306e\u6e96\u5099\n\u3053\u3053\u3067\u3082terraform\u3092\u4f7f\u3063\u3066FW\u306e\u8a2d\u5b9a\u3092\u884c\u3044\u307e\u3059\u3002(GUI\u3092\u4f7f\u3063\u305f\u3089Infrastructure as code\u3058\u3083\u306a\u3044\u304b\u3089\u3067\u3059)\n\n[\u30b5\u30f3\u30d7\u30eb](https://www.terraform.io/docs/providers/google/r/compute_firewall.html)\u306b\u5f93\u3063\u3066***google_compute_firewall.tf***\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n```\nresource \"google_compute_firewall\" \"default\" {\n  name    = \"example-voting-app\"\n  network = \"default\"\n\n  allow {\n    protocol = \"icmp\"\n  }\n\n  allow {\n    protocol = \"tcp\"\n    ports    = [\"5000-5001\"]\n  }\n\n  source_ranges = [\"0.0.0.0/0\"]\n  target_tags = [\"terraform\"]\n}\n```\n\n\u30b5\u30f3\u30d7\u30eb\u304b\u3089\u306e\u5909\u66f4\u30dd\u30a4\u30f3\u30c8\u3068\u3057\u3066\u306f\u4ee5\u4e0b\u306e\u901a\u308a\u3067\u3059\u3002\n\n+ name\u3092\u308f\u304b\u308a\u3084\u3059\u304f\n+ network\u306f\"default\"\u306b\n+ ports\u306f\u30a2\u30d7\u30ea\u304c\u4f7f\u30465000\u306850001\n+ source_ranges\u3067any(0.0,0.0/0)\u3092\u6307\u5b9a\n\n\n#### 7.2 FW\u306e\u8a2d\u5b9a\u3092\u30c7\u30d7\u30ed\u30a4\n\u9069\u7528\u624b\u9806\u306f\u30b5\u30fc\u30d0\u69cb\u7bc9\u6642\u3068\u540c\u3058\u3067\u3059\u3002\n\n```\nterraform plan\n\u2192\"Plan: 1 to add, 0 to change, 0 to destroy.\"\u3092\u78ba\u8a8d\n\nterraform apply\n\u2192\"Apply complete! Resources: 1 added, 0 changed, 0 destroyed.\"\u3092\u78ba\u8a8d\n```\n\n\n#### 7.3 FW\u306e\u8a2d\u5b9a\u3092GCP\u30b3\u30f3\u30bd\u30fc\u30eb\u3067\u78ba\u8a8d\n\u30cf\u30f3\u30d0\u30fc\u30ac\u30e1\u30cb\u30e5\u30fc\u304b\u3089\u300c\u30cd\u30c3\u30c8\u30ef\u30fc\u30ad\u30f3\u30b0\u300d\u2192\u300c\u30d5\u30a1\u30a4\u30a2\u30a6\u30a9\u30fc\u30eb\u30eb\u30fc\u30eb\u300d\u3092\u9078\u629e\u3057\u3001\"example-voting-app\"\u30eb\u30fc\u30eb\u304c\u4f5c\u6210\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n![image](https://qiita-image-store.s3.amazonaws.com/0/120707/c41b2c3c-5228-79a0-e85f-1848fd4e28d0.png)\n\n\n### 8. \"stack deploy\"\u3067\u30c7\u30d7\u30ed\u30a4\u3057\u305f\u30c7\u30e2\u7528\u30a2\u30d7\u30ea\u306e\u52d5\u4f5c\u78ba\u8a8d\n\n\u3044\u3088\u3044\u3088\u30a2\u30d7\u30ea\u306b\u63a5\u7d9a\u3057\u307e\u3059\u3002\n\n#### 8.1 GIP\u306e\u78ba\u8a8d\n\u30cf\u30f3\u30d0\u30fc\u30ac\u30e1\u30cb\u30e5\u30fc\u304b\u3089\u300cCompute Engine\u300d\u304b\u3089\u3001\u5404\u30b5\u30fc\u30d0\u306eGIP\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n![image](https://qiita-image-store.s3.amazonaws.com/0/120707/6cfb3bc9-34b2-e346-f48b-b655496c5ccc.png)\n\n#### 8.2 \u63a5\u7d9a\uff01\u305d\u3057\u3066\u6295\u7968\uff01\n\u304a\u624b\u6301\u3061\u306e\u30d6\u30e9\u30a6\u30b6\u3067\"GIP:5000\"\u3078\u63a5\u7d9a\u3057\u307e\u3059\u3002\n\u4ee5\u4e0b\u3092\u78ba\u8a8d\u3057\u307e\u3057\u3087\u3046\u3002\n+ \u30b5\u30fc\u30d03\u53f0\u306e\u3069\u306eGIP\u304b\u3089\u3067\u3082\u63a5\u7d9a\u3067\u304d\u308b\u3000\u2190\u3053\u308c\u91cd\u8981\n+ \u30ea\u30ed\u30fc\u30c9\u3067\u30b3\u30f3\u30c6\u30ca\u306eID\u304c\u5909\u308f\u308b\u3000\u2190\u3053\u308c\u3082\u91cd\u8981\n\n\n![image](https://qiita-image-store.s3.amazonaws.com/0/120707/02d6c534-c4ec-9f2f-db7f-88df02f15975.png)\n\n\n#### 8.3 \u7d50\u679c\u78ba\u8a8d\n\u3064\u3065\u3044\u30665001\u756a\u3078\u63a5\u7d9a\u3057\u3066\u6295\u7968\u7d50\u679c\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\uff08\u30d6\u30e9\u30a6\u30b6\u306e\u30ad\u30e3\u30c3\u30b7\u30e5\u30af\u30ea\u30a2\u3092\u3057\u3066\u8907\u6570\u56de\u6295\u7968\u3057\u306a\u3044\u3068\u3001\u7d50\u679c\u3068\u3057\u3066\u306f\u9762\u767d\u304f\u306a\u3044\u304b\u3082\u3057\u308c\u307e\u305b\u3093\uff09\n![image](https://qiita-image-store.s3.amazonaws.com/0/120707/c652af98-9a69-b0bb-08e4-e69e5141cd99.png)\n\n#### 8.4 docker swarm mode\u306eIngress overlay network\u3092\u4f53\u611f\u3059\u308b\n3\u53f0\u5168\u3066\u306eGIP\u3078\u306e\u63a5\u7d9a\u3067\u3001\u6295\u7968\u753b\u9762\u3082\u7d50\u679c\u753b\u9762\u3092\u78ba\u8a8d\u3057\u305f\u5f8c\u306f\u3001\"docker service ls\"\u306e\u8868\u793a\u3092\u843d\u3061\u7740\u3044\u3066\u898b\u307e\u3059\u3002\n\u300cvote\u306f2\u3064\u3001result\u306f1\u3064\u3057\u304b\u306a\u3044\u300d\u2192\u300c\u3057\u304b\u3057\u3001\u5168\u3066\u306eGIP\u304b\u3089\u30a2\u30af\u30bb\u30b9\u304c\u53ef\u80fd\u3060\u3063\u305f\u300d\n![image](https://qiita-image-store.s3.amazonaws.com/0/120707/ef20fc7f-1210-461a-932a-78cf7b9f3344.png)\n\n\n[Docker 1.12: swarm \u30e2\u30fc\u30c9\u3068 Ingress Load Balancing \u6982\u8981](https://pocketstudio.net/2016/06/23/docker-1-12-swarm-mode-and-ingress-load-balancing/)\u304b\u3089\u4ee5\u4e0b\u306e\u56f3\u3092\u5f15\u7528\u3057\u307e\u3059\u3002\n![image](https://pocketstudio.net/images/swarm-mode-4.png)\n\u3069\u3046\u3084\u3089docker\u304c\u4e0a\u624b\u3044\u3053\u3068\u3092\u3084\u3063\u3066\u304f\u308c\u3066\u3044\u308b\u3088\u3046\u3067\u3059\u3002\uff08\u5c0f\u4e26\u611f\uff09\n\u8a73\u7d30\u306f\u5f15\u7528\u5143\u306e[Pocketstudio Technology Log](https://pocketstudio.net/)\u306e\u8a18\u4e8b\u3092\u5fa1\u89a7\u304f\u3060\u3055\u3044\u3002\n\u4ed6\u306b\u3082\u7d20\u6674\u3089\u3057\u3044\u6280\u8853\u8a18\u4e8b\u304c\u63b2\u8f09\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n\n\n### 9. terraform\u3067\u4e00\u62ec\u304a\u7247\u4ed8\u3051\n\u4e00\u901a\u308a\u306e\u691c\u8a3c\u304c\u7d42\u308f\u3063\u305f\u306e\u3067\u3001\u7acb\u3061\u4e0a\u3052\u305f\u30b5\u30fc\u30d0\u7fa4\u3092\u505c\u6b62\u3057\u307e\u3059\u3002\n`sudo docker stack rm vote`\u3092\u5b9f\u884c\u3057\u3066docker\u306e\u30b5\u30fc\u30d3\u30b9\u3092\u505c\u6b62\u3057\u3001GCP\u30b3\u30f3\u30bd\u30fc\u30eb\u304b\u3089\u30dd\u30c1\u30dd\u30c1\u30b5\u30fc\u30d0\u3092\u524a\u9664\u3059\u308b\u3001\u306a\u3093\u3066\u9762\u5012\u306a\u3053\u3068\u306f\u3057\u307e\u305b\u3093\u3002\n\nterraform\u304b\u3089\u4ee5\u4e0b\u306e\u30b3\u30de\u30f3\u30c9\u3092\u6295\u5165\u3059\u308b\u3060\u3051\u3067\u3001\u304a\u7247\u4ed8\u3051\u304c\u5b8c\u4e86\u3057\u307e\u3059\u3002\n\n```\nterraform destroy\n```\n\n\u78ba\u8a8d\u306e\u305f\u3081\u306e\u30d7\u30ed\u30f3\u30d7\u30c8\u304c\u8868\u793a\u3055\u308c\u308b\u305f\u3081\u3001\"yes\"\u3068\u5165\u529b\u3057\u307e\u3059\u3002\n![image](https://qiita-image-store.s3.amazonaws.com/0/120707/81298f38-c685-141c-5984-20e28f41d4a2.png)\n\n`Destroy complete! Resources: 4 destroyed.`\u3068\u8868\u793a\u3055\u308c\u305f\u3053\u3068\u3092\u78ba\u8a8d\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\u4e07\u304c\u4e00\u6d88\u3057\u5fd8\u308c\u304c\u3042\u3063\u3066\u306f\u304a\u8ca1\u5e03\u7684\u306b\u5371\u967a\u3067\u3059\u306e\u3067\u3001GCP\u306e\u30b3\u30f3\u30bd\u30fc\u30eb\u304b\u3089\u3082\u524a\u9664\u3055\u308c\u3066\u3044\u306a\u3044\u30b5\u30fc\u30d0\u304c\u7121\u3044\u3053\u3068\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n\u30cf\u30f3\u30d0\u30fc\u30ac\u30e1\u30cb\u30e5\u30fc\u304b\u3089\u300cCompute Engine\u300d\u3092\u9078\u629e\u3057\u3001\u521d\u671f\u753b\u9762\u3067\u3042\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3059\u308c\u3070\u3001\u4f5c\u696d\u306f\u5b8c\u4e86\u3068\u306a\u308a\u307e\u3059\u3002\n![image](https://qiita-image-store.s3.amazonaws.com/0/120707/0cfcbfcd-bc4a-1f2c-641c-149c32bbc324.png)\n\n\n# \u53c2\u8003\n+ \u524d\u4f5b\u3055\u3093\u306e\u30d7\u30ec\u30bc\u30f3\uff08Docker\u306e\u9762\u767d\u3055\u3092\u6559\u3048\u3066\u304f\u308c\u305f\uff09\n+ https://www.slideshare.net/zembutsu/ \u306edocker\u7cfb\u30b9\u30e9\u30a4\u30c9\uff08\u524d\u4f5b\u3055\u3093\u8cc7\u6599\u306e\u4f5c\u308a\u8fbc\u307f\u306f\u672c\u5f53\u306b\u3059\u3054\u3044\uff09\n+ https://pocketstudio.net/2016/06/23/docker-1-12-swarm-mode-and-ingress-load-balancing/ (\u3053\u3053\u3082\u524d\u4f5b\u3055\u3093...)\n+ https://www.terraform.io/docs/providers/google/index.html\n+ https://www.terraform.io/docs/providers/google/r/compute_instance.html\n+ https://www.terraform.io/docs/providers/google/r/compute_firewall.html\n+ https://docs.docker.com/engine/installation/linux/centos/\n+ https://docs.docker.com/engine/swarm/swarm-tutorial/\n+ https://blog.docker.com/2017/01/whats-new-in-docker-1-13/\n+ https://github.com/docker/example-voting-app.git\n+ https://cloudplatform-jp.googleblog.com/\n", "tags": ["gcp", "Terraform", "docker", "centos7"]}