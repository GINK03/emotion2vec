{"context": "2\u5e74\u524d\u306b\u30d7\u30c1\u8a71\u984c\u306b\u306a\u3063\u305f\u30a2\u30ec\u3067\u3059\n\n\nhttps://twitter.com/ccc_privacy_bot\n\u30bd\u30fc\u30b9\u30b3\u30fc\u30c9\uff1a https://github.com/sue445/ccc_privacy_crawler\n\n\n\n\u904e\u53bb\u306e\u8a18\u4e8b\n\nT\u30ab\u30fc\u30c9\u500b\u4eba\u60c5\u5831\u63d0\u4f9b\u5148\u65b0\u7740bot\u3092\u4f5c\u308a\u307e\u3057\u305f - \u304f\u308a\u306b\u3063\u304d\nccc_privacy_bot \u3092\u652f\u3048\u308b\u6280\u8853 - \u304f\u308a\u306b\u3063\u304d\n\n2\u5e74\u524d\u306b\u66f8\u3044\u305f\u6642\u304b\u3089\u82e5\u5e72\u30a2\u30c3\u30d7\u30c7\u30fc\u30c8\u304c\u3042\u308b\u306e\u3067\u305d\u308c\u306b\u3064\u3044\u3066\u3082\u66f8\u304d\u305f\u3044\u3068\u601d\u3044\u307e\u3059\u3002\n\n\u30dc\u30c3\u30c8\u3067\u3084\u3063\u3066\u3044\u308b\u3053\u3068\n\n1\u6642\u9593\u306b1\u56de\u3001\u63d0\u4f9b\u5148\u4f01\u696d\u4e00\u89a7\u306ePDF\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3067\u304d\u308b\u30da\u30fc\u30b8\u306b\u3044\u304f\n\n\nhttp://qa.tsite.jp/faq/show/2512\n\n\nPDF\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u3066\u63d0\u4f9b\u5148\u4f01\u696d\u4e00\u89a7\u3092\u53d6\u5f97\n\n\n\u30b9\u30af\u30ec\u30a4\u30d4\u30f3\u30b0\u3060\u3051\u3067\u3044\u3051\u308b\u3068\u601d\u3063\u305f\u3089PDF\u3067\u63d0\u4f9b\u3055\u308c\u3066\u3044\u305f\u306e\u3067parse\u3059\u308b\u306e\u304c\u5927\u5909\u3060\u3063\u305f\uff57\n\n\n\u65b0\u7740\u304c\u3042\u308c\u3070\u30dc\u30c3\u30c8\u3067\u3064\u3076\u3084\u304f\n\n\u3063\u3066\u3060\u3051\u3067\u3059\u3002\n\u3061\u306a\u307f\u306bPDF\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u3066\u30b9\u30af\u30ec\u30a4\u30d4\u30f3\u30b0\u3059\u308b\u30ed\u30b8\u30c3\u30af\u306f2\u5e74\u9593\u3067\u4e00\u5207\u624b\u3092\u52a0\u3048\u3066\u3044\u307e\u305b\u3093\u304c\u3001\u3060\u3044\u305f\u3044\u52d5\u3044\u3066\u3044\u308b\u3088\u3046\u3067\u3059\u3002\n\n\u4f7f\u3063\u3066\u3044\u308b\u6280\u8853\n\nruby\n\nPadrino Framework\n\n\u5168\u90e8\u5165\u308a\u306eRails \u3068 \u30b7\u30f3\u30d7\u30eb\u306a Sinatra \u306e\u4e2d\u9593\u304f\u3089\u3044\u306e\u30d5\u30ec\u30fc\u30e0\u30ef\u30fc\u30af\n\u30ea\u30ea\u30fc\u30b9\u5f53\u6642\u306f\u30b9\u30af\u30ec\u30a4\u30d4\u30f3\u30b0\u3068\u30dc\u30c3\u30c8\u306e\u307f\u3060\u3063\u305f\u306e\u3067padrino\u306f\u304a\u308d\u304bsinatra\u3059\u3089\u4e0d\u8981\u3060\u3063\u305f\u306e\u3067\u3059\u304c\u3001\u30b9\u30ad\u30fc\u30de\u306emigration\u3092\u81ea\u524d\u3067\u5b9f\u88c5\u3059\u308b\u306e\u304c\u5acc\u3060\u3063\u305f\u306e\u3067padrino\u3092\u63a1\u7528\n\u5f8c\u304b\u3089web\u3092\u8ffd\u52a0\u3057\u305f\u304f\u306a\u3063\u305f\u306e\u3067\uff08\u5f8c\u8ff0\uff09\u3001\u7d50\u679c\u7684\u306b\u306fpadrino\u4f7f\u3063\u305f\u306e\u306f\u6b63\u89e3\u3060\u3063\u305f\n\n\nHeroku\n\n\nHTML\u306e\u30b9\u30af\u30ec\u30a4\u30d4\u30f3\u30b0\nMechanize \u3092\u4f7f\u3063\u3066\u307e\u3059\u3002\n\n\u30e1\u30ea\u30c3\u30c8\n\n\n\u8efd\u3044\nRuby\u5358\u4f53\u3067\u52d5\u304f\n\n\n\u30c7\u30e1\u30ea\u30c3\u30c8\n\n\nhtml\u306ebody\u306eparse\u3057\u304b\u3057\u306a\u3044\u306e\u3067\u3001js\u3067DOM\u304c\u64cd\u4f5c\u3055\u308c\u3066\u3044\u308b\u5834\u5408\u306b\u306f\u4f7f\u3048\u306a\u3044\n\n\n\nAjax\u304c\u3075\u3093\u3060\u3093\u306b\u4f7f\u308f\u308c\u305f\u30da\u30fc\u30b8\u3092\u30b9\u30af\u30ec\u30a4\u30d4\u30f3\u30b0\u3059\u308b\u306b\u306f phantomjs + Capybara + poltergeist \u306e\u7d44\u307f\u5408\u308f\u305b\u304c\u9244\u677f\u3060\u3068\u601d\u3044\u307e\u3059\u3002\uff08\u304c\u3001phantomjs\u306f\u30c7\u30d0\u30c3\u30b0\u3057\u3065\u3089\u3044\u306e\u304c\u3002\u3002\u3002\uff09\n\u53c2\u8003\uff1a Rails4 + Capybara + PhantomJS (poltergeist) \u306a\u30c6\u30b9\u30c8\u74b0\u5883 - (\uff9f\u2200\uff9f)o\u5f61 sasata299's blog\n\u5b9f\u969b\u306e\u30bd\u30fc\u30b9\u30b3\u30fc\u30c9\u3067\u89e3\u8aac\u3057\u307e\u3059\nhttps://github.com/sue445/ccc_privacy_crawler/blob/672bc0dbe8c88f431603b4913c2d1236df6e2d99/lib/workers/pdf_crawl_worker.rb#L28-39\n\nlib/workers/pdf_crawl_worker.rb\n  def download_ccc_pdf(dest_pdf_file)\n    # mechanize\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u521d\u671f\u5316\n    agent = Mechanize.new\n\n    # http://qa.tsite.jp/faq/show/25129 \u3092\u958b\u304f\n    agent.get(\"http://qa.tsite.jp/faq/show/25129\")\n\n    # <a href=\"/attachment_file/\u301c.pdf\"> \u306e\u3088\u3046\u306a\u30ea\u30f3\u30af\u3092\u63a2\u3059\n    download_link = agent.page.link_with(href: %r(/attachment_file/.+\\.pdf))\n\n    # \u30ea\u30f3\u30af\u304c\u898b\u3064\u304b\u3089\u306a\u3051\u308c\u3070\u30a8\u30e9\u30fc\n    raise \"Not found download_link\" unless download_link\n\n    # \u30ea\u30f3\u30af\u5148\u306ePDF\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u3066\u30d5\u30a1\u30a4\u30eb\u306b\u4fdd\u5b58\u3059\u308b\n    pdf_content = agent.get_file(download_link.href)\n    File.open(dest_pdf_file, \"wb\") do |file|\n      file.write(pdf_content)\n    end\n  end\n\n\n\npdf\u306e\u30b9\u30af\u30ec\u30a4\u30d4\u30f3\u30b0\npdf-reader \u3068\u3044\u3046gem\u3092\u4f7f\u3063\u3066\u307e\u3059\u3002\npdf\u3092ruby\u304b\u3089\u8aad\u3080\u305f\u3081\u306egem\u306f\u3044\u304f\u3064\u304b\u4f7f\u3063\u3066\u307f\u305f\u306e\u3067\u3059\u304c\u3001\u4eca\u56de\u306f\u3053\u306egem\u3058\u3083\u306a\u3044\u3068\u3046\u307e\u304f\u30c6\u30ad\u30b9\u30c8\u3067\u53d6\u5f97\u51fa\u6765\u307e\u305b\u3093\u3067\u3057\u305f\u3002\uff08ccc\u306epdf\u306fExcel\u3092pdf\u306b\u5909\u63db\u3057\u3066\u308b\u307f\u305f\u3044\u306a\u306e\u3067\u3059\u304c\u3001\u4ed6\u306egem\u3060\u3068\u30bb\u30eb\u306e\u4e2d\u306e\u30c6\u30ad\u30b9\u30c8\u304c\u5217\u5358\u4f4d\u3067\u3057\u304b\u53d6\u5f97\u3067\u304d\u306a\u3044\u3002pdf-reader\u3060\u3068pdf\u3068\u3057\u3066\u30ec\u30f3\u30c0\u30ea\u30f3\u30b0\u3055\u308c\u308b\u6642\u306e\u5b9f\u969b\u306e\u5ea7\u6a19\u3082\u3042\u308b\u7a0b\u5ea6\u8003\u616e\u3057\u3066\u304f\u308c\u308b\u6a21\u69d8\uff09\n\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u305fpdf\u3092\u30c6\u30ad\u30b9\u30c8\u3067\u8aad\u307f\u8fbc\u3080\nhttps://github.com/sue445/ccc_privacy_crawler/blob/672bc0dbe8c88f431603b4913c2d1236df6e2d99/lib/workers/pdf_crawl_worker.rb#L65-74\n\nlib/workers/pdf_crawl_worker.rb\n  def read_pdf(pdf_file)\n    pdf_content = \"\"\n\n    reader = PDF::Reader.new(pdf_file)\n    reader.pages.each do |page|\n      pdf_content << page.text\n    end\n\n    pdf_content\n  end\n\n\n\u3053\u308c\u81ea\u4f53\u306f\u7279\u5225\u306a\u3053\u3068\u3092\u3057\u3066\u3044\u306a\u3044\u3093\u3067\u3059\u304c\u3001\u305d\u306e\u307e\u307e\u3060\u3068\u4e0b\u8a18\u306e\u3088\u3046\u306bpdf\u5185\u306e\u65e5\u4ed8\u304c\u3046\u307e\u304f\u53d6\u5f97\u3067\u304d\u307e\u305b\u3093\u3067\u3057\u305f\n1 TSUTAYA\u30fb\u8526\u5c4b\u66f8\u5e97                      2014/10/2\u63d0\u643a\u5148\uff1aTSUTAYA\u30d5\u30e9\u30f3\u30c1\u30e3\u30a4\u30ba\u30c1\u30a7\u30fc\u30f3\u52a0\u76df\u4f01\u696d\n2 \uff2a\uff38\u65e5\u9271\u65e5\u77f3\u30a8\u30cd\u30eb\u30ae\u30fc\u682a\u5f0f\u4f1a\u793e                   2014/10/2\u63d0\u643a\u5148\uff1aENEOS\n3 \u682a\u5f0f\u4f1a\u793e\u30a2\u30d7\u30e9\u30b9                          2014/10/2\u63d0\u643a\u30b5\u30fc\u30d3\u30b9\uff1aT\u30ab\u30fc\u30c9\u30d7\u30e9\u30b9\uff0c T\u30ab\u30fc\u30c9\u30d7\u30e9\u30b9\u03b1 \uff0cTSUTAYAW\u30ab\u30fc\u30c9\n4 \u682a\u5f0f\u4f1a\u793e\uff2d\uff49\uff53\uff55\uff4d\uff49                        2014/10/2\u63d0\u643a\u5148\uff1aBOOKSmisumi\uff0cMisumi\u30b0\u30eb\u30fc\u30d7\uff08\u30ac\u30b9\u30fb\u6c34\uff09\n5 \uff2a\uff32\u4e5d\u5dde\u30c9\u30e9\u30c3\u30b0\u30a4\u30ec\u30d6\u30f3\u682a\u5f0f\u4f1a\u793e                  2014/10/2\u63d0\u643a\u5148\uff1a\u30c9\u30e9\u30c3\u30b0\u30a4\u30ec\u30d6\u30f3\n\n\u30e2\u30f3\u30ad\u30fc\u30d1\u30c3\u30c1\u3067\u6587\u5b57\u63cf\u753b\u306e\u4f4d\u7f6e\u3092\u7121\u7406\u77e2\u7406\u5909\u3048\u3066\u5bfe\u5fdc\u3057\u3066\u307e\u3059\u3002\nhttps://github.com/sue445/ccc_privacy_crawler/blob/672bc0dbe8c88f431603b4913c2d1236df6e2d99/lib/pdf-reader.rb\n\nlib/pdf-reader.rb\nclass PDF::Reader::PageLayout\n  # fix rate: 1.05 -> 1.5\n  def col_count\n    @col_count ||= ((@page_width  / @mean_glyph_width) * 1.5).floor\n  end\nend\n\n\npdf\u3092\u6587\u5b57\u5217\u3067\u53d6\u5f97\u3067\u3057\u305f\u5f8c\u306f\u6b63\u898f\u8868\u73fe\u3067parse\u3057\u3066\u307e\u3059\nhttps://github.com/sue445/ccc_privacy_crawler/blob/672bc0dbe8c88f431603b4913c2d1236df6e2d99/lib/workers/pdf_crawl_worker.rb#L41-62\n\nlib/workers/pdf_crawl_worker.rb\n  def parse_ccc_pdf(pdf_file)\n    companies = []\n    read_pdf(pdf_file).each_line do |line|\n      line = line.strip\n\n      matched_data = %r(\n        ^(?<no>[0-9]+)\\s*\n        (?<company_name>.+)\\s*\n        (?<receipted_date>[0-9]{4}/[0-9]{1,2}/[0-9]{1,2})\n        (?<destination_name>.+)$)x.match(line)\n      next unless matched_data\n\n      companies << Company.new(\n        no:               matched_data[:no].to_i,\n        company_name:     matched_data[:company_name].strip,\n        receipted_date:   matched_data[:receipted_date].strip,\n        destination_name: matched_data[:destination_name].strip,\n      )\n    end\n\n    companies\n  end\n\n\n\u30bd\u30fc\u30b9\u30b3\u30fc\u30c9\u4e2d\u306e\u6b63\u898f\u8868\u73fe\u306e\n%r(\n^(?<no>[0-9]+)\\s*\n(?<company_name>.+)\\s*\n(?<receipted_date>[0-9]{4}/[0-9]{1,2}/[0-9]{1,2})\n(?<destination_name>.+)$)x.match(line)\n\n\u306f\n/^([0-9]+)\\s*(.+)\\s*([0-9]{4}\\/[0-9]{1,2}\\/[0-9]{1,2})(.+)$/ =~ line\n\n\u3068\u540c\u7b49\u3067\u3059\u304c\u4e0b\u8a18\u306e\u3088\u3046\u306a\u5de5\u592b\u304c\u3042\u308a\u307e\u3059\n\n\n$1 \u3084 $2 \u3060\u3068\u5206\u304b\u308a\u3065\u3089\u3044\u306e\u3067 (?<no>[0-9]+) \u3084 (?<company_name>.+) \u306e\u3088\u3046\u306b\u540d\u524d\u4ed8\u304d\u30ad\u30e3\u30d7\u30c1\u30e3\u3092\u4f7f\u3046\n\n\nhttp://docs.ruby-lang.org/ja/2.3.0/doc/spec=2fregexp.html\n\n\n\n/\u301c/ \u3060\u3068\u6b63\u898f\u8868\u73fe\u5185\u306b\u30b9\u30e9\u30c3\u30b7\u30e5\u304c\u3042\u308b\u3068\u30a8\u30b9\u30b1\u30fc\u30d7\u3057\u306a\u3044\u3068\u3044\u3051\u306a\u3044\u306e\u3067 %r(\u301c) \u3092\u4f7f\u3046\n\n\nhttp://docs.ruby-lang.org/ja/2.3.0/doc/spec=2fliteral.html#regexp\n\n\n\n\n\u30af\u30ed\u30fc\u30e9\n\u4f5c\u3063\u305f\u5f53\u521d\u306f\n\nHeroku scheduler\u306e\u7121\u6599\u67a0\u306f1\u65e51\u56de\u5b9f\u884c\u306e\u307f\u3002\uff081\u6642\u9593\u306b1\u56de\u5b9f\u884c\u306f\u6709\u6599\uff09\n\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u309224\u6642\u9593\u30d5\u30eb\u7a3c\u50cd\u3057\u3066\u3044\u3066\u3082\u7121\u6599\n\n\u3068\u3044\u3046\u3053\u3068\u3082\u3042\u308a sidekiq-cron \u306e\u30d7\u30ed\u30bb\u30b9\u3092\u5e38\u99d0\u3057\u306630\u5206\u306b1\u56de\u5b9f\u884c\u3057\u3066\u3044\u305f\u306e\u3067\u3059\u304c\u30012015\u5e744\u6708\u9803 1 \u306b\u65b0\u3057\u3044\u6599\u91d1\u4f53\u7cfb\u304c\u767a\u8868\u3055\u308c\n\n24\u6642\u9593\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u8d77\u52d5\u3057\u7d9a\u3051\u308b\u3068\u6709\u6599\u306b\u306a\u308b\n\u305d\u306e\u4ee3\u308f\u308aHeroku scheduler\u304c\u7121\u6599\u3067\u30821\u6642\u9593\u306b1\u56de\u52d5\u304b\u305b\u308b\u3088\u3046\u306b\u306a\u3063\u305f\n\n\u3068\u3044\u3046\u3053\u3068\u306b\u306a\u308a\u3001Heroku Scheduler\u30671\u6642\u9593\u306b1\u56de\u52d5\u304b\u3059\u3088\u3046\u306b\u3057\u3066\u3044\u307e\u3059\u3002\n\n\u5143\u3005worker\u3067\u5b9f\u884c\u3057\u3066\u305f\u9803\u306e\u540d\u6b8b\u3067\u3001rake task\u5185\u3067worker\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092 perform \u3057\u3066\u3044\u307e\u3059\u3002\nhttps://github.com/sue445/ccc_privacy_crawler/blob/6146b3ac985274b2c686f98143ac6cd84a2c9f5c/lib/tasks/crawl_pdf.rake\n\nlib/tasks/crawl_pdf.rake\ndesc \"crawl pdf\"\ntask :crawl_pdf => :environment do\n  PdfCrawlWorker.new.perform\nend\n\n\n\nweb\u753b\u9762\n\u7279\u306b\u3069\u3053\u306b\u3082\u30a2\u30ca\u30a6\u30f3\u30b9\u3057\u3066\u3044\u306a\u304b\u3063\u305f\u3067\u3059\u304c\u3001\u30ec\u30b3\u30fc\u30c9\u3092\u898b\u308b\u306e\u306b\u30ed\u30fc\u30ab\u30eb\u304b\u3089 padrino console \u3059\u308b\u3060\u3051\u3060\u3068\u4e0d\u4fbf\u3060\u3063\u305f\u306e\u3067web\u3067\u898b\u308c\u308b\u3088\u3046\u306b\u3057\u3066\u3044\u307e\u3059\u3002\nhttps://ccc-privacy-crawler.herokuapp.com/\n\u81ea\u5206\u304c\u898b\u308c\u308c\u3070\u3044\u3044\u611f\u3042\u3063\u305f\u306e\u3067\u753b\u9762\u306f\u96d1\u3067\u3059\n\n\n\n\n\u81ea\u5206\u304c\u5bfe\u5fdc\u3057\u305f\u65e5\u4ed8\u3088\u308a\u63a8\u6e2c https://github.com/sue445/ccc_privacy_crawler/pull/25\u00a0\u21a9\n\n\n\n2\u5e74\u524d\u306b\u30d7\u30c1\u8a71\u984c\u306b\u306a\u3063\u305f\u30a2\u30ec\u3067\u3059\n\n![image](https://qiita-image-store.s3.amazonaws.com/0/8059/dbc4bc6a-3cdd-735b-8f8f-ee335c9049c1.png)\n\n* https://twitter.com/ccc_privacy_bot\n* \u30bd\u30fc\u30b9\u30b3\u30fc\u30c9\uff1a https://github.com/sue445/ccc_privacy_crawler\n\n# \u904e\u53bb\u306e\u8a18\u4e8b\n* [T\u30ab\u30fc\u30c9\u500b\u4eba\u60c5\u5831\u63d0\u4f9b\u5148\u65b0\u7740bot\u3092\u4f5c\u308a\u307e\u3057\u305f - \u304f\u308a\u306b\u3063\u304d](http://sue445.hatenablog.com/entry/2014/11/19/000836)\n* [ccc_privacy_bot \u3092\u652f\u3048\u308b\u6280\u8853 - \u304f\u308a\u306b\u3063\u304d](http://sue445.hatenablog.com/entry/2014/12/09/000000)\n\n2\u5e74\u524d\u306b\u66f8\u3044\u305f\u6642\u304b\u3089\u82e5\u5e72\u30a2\u30c3\u30d7\u30c7\u30fc\u30c8\u304c\u3042\u308b\u306e\u3067\u305d\u308c\u306b\u3064\u3044\u3066\u3082\u66f8\u304d\u305f\u3044\u3068\u601d\u3044\u307e\u3059\u3002\n\n# \u30dc\u30c3\u30c8\u3067\u3084\u3063\u3066\u3044\u308b\u3053\u3068\n1. 1\u6642\u9593\u306b1\u56de\u3001\u63d0\u4f9b\u5148\u4f01\u696d\u4e00\u89a7\u306ePDF\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3067\u304d\u308b\u30da\u30fc\u30b8\u306b\u3044\u304f\n  * http://qa.tsite.jp/faq/show/2512\n2. PDF\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u3066\u63d0\u4f9b\u5148\u4f01\u696d\u4e00\u89a7\u3092\u53d6\u5f97\n  * \u30b9\u30af\u30ec\u30a4\u30d4\u30f3\u30b0\u3060\u3051\u3067\u3044\u3051\u308b\u3068\u601d\u3063\u305f\u3089PDF\u3067\u63d0\u4f9b\u3055\u308c\u3066\u3044\u305f\u306e\u3067parse\u3059\u308b\u306e\u304c\u5927\u5909\u3060\u3063\u305f\uff57\n3. \u65b0\u7740\u304c\u3042\u308c\u3070\u30dc\u30c3\u30c8\u3067\u3064\u3076\u3084\u304f\n\n\u3063\u3066\u3060\u3051\u3067\u3059\u3002\n\n\u3061\u306a\u307f\u306bPDF\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u3066\u30b9\u30af\u30ec\u30a4\u30d4\u30f3\u30b0\u3059\u308b\u30ed\u30b8\u30c3\u30af\u306f2\u5e74\u9593\u3067\u4e00\u5207\u624b\u3092\u52a0\u3048\u3066\u3044\u307e\u305b\u3093\u304c\u3001\u3060\u3044\u305f\u3044\u52d5\u3044\u3066\u3044\u308b\u3088\u3046\u3067\u3059\u3002\n\n# \u4f7f\u3063\u3066\u3044\u308b\u6280\u8853\n* ruby\n* [Padrino Framework](http://jp.padrinorb.com/)\n  * \u5168\u90e8\u5165\u308a\u306eRails \u3068 \u30b7\u30f3\u30d7\u30eb\u306a [Sinatra](http://www.sinatrarb.com/) \u306e\u4e2d\u9593\u304f\u3089\u3044\u306e\u30d5\u30ec\u30fc\u30e0\u30ef\u30fc\u30af\n  * \u30ea\u30ea\u30fc\u30b9\u5f53\u6642\u306f\u30b9\u30af\u30ec\u30a4\u30d4\u30f3\u30b0\u3068\u30dc\u30c3\u30c8\u306e\u307f\u3060\u3063\u305f\u306e\u3067padrino\u306f\u304a\u308d\u304bsinatra\u3059\u3089\u4e0d\u8981\u3060\u3063\u305f\u306e\u3067\u3059\u304c\u3001\u30b9\u30ad\u30fc\u30de\u306emigration\u3092\u81ea\u524d\u3067\u5b9f\u88c5\u3059\u308b\u306e\u304c\u5acc\u3060\u3063\u305f\u306e\u3067padrino\u3092\u63a1\u7528\n  * \u5f8c\u304b\u3089web\u3092\u8ffd\u52a0\u3057\u305f\u304f\u306a\u3063\u305f\u306e\u3067\uff08\u5f8c\u8ff0\uff09\u3001\u7d50\u679c\u7684\u306b\u306fpadrino\u4f7f\u3063\u305f\u306e\u306f\u6b63\u89e3\u3060\u3063\u305f\n* Heroku\n\n# HTML\u306e\u30b9\u30af\u30ec\u30a4\u30d4\u30f3\u30b0\n[Mechanize](https://github.com/sparklemotion/mechanize) \u3092\u4f7f\u3063\u3066\u307e\u3059\u3002\n\n* \u30e1\u30ea\u30c3\u30c8\n  * \u8efd\u3044\n  * Ruby\u5358\u4f53\u3067\u52d5\u304f\n* \u30c7\u30e1\u30ea\u30c3\u30c8\n  * html\u306ebody\u306eparse\u3057\u304b\u3057\u306a\u3044\u306e\u3067\u3001js\u3067DOM\u304c\u64cd\u4f5c\u3055\u308c\u3066\u3044\u308b\u5834\u5408\u306b\u306f\u4f7f\u3048\u306a\u3044\n\nAjax\u304c\u3075\u3093\u3060\u3093\u306b\u4f7f\u308f\u308c\u305f\u30da\u30fc\u30b8\u3092\u30b9\u30af\u30ec\u30a4\u30d4\u30f3\u30b0\u3059\u308b\u306b\u306f [phantomjs](https://github.com/ariya/phantomjs/wiki/Headless-Testing) + [Capybara](https://github.com/jnicklas/capybara) + [poltergeist](https://github.com/jonleighton/poltergeist) \u306e\u7d44\u307f\u5408\u308f\u305b\u304c\u9244\u677f\u3060\u3068\u601d\u3044\u307e\u3059\u3002\uff08\u304c\u3001phantomjs\u306f\u30c7\u30d0\u30c3\u30b0\u3057\u3065\u3089\u3044\u306e\u304c\u3002\u3002\u3002\uff09\n\n\u53c2\u8003\uff1a [Rails4 + Capybara + PhantomJS (poltergeist) \u306a\u30c6\u30b9\u30c8\u74b0\u5883 - (\uff9f\u2200\uff9f)o\u5f61 sasata299's blog](http://blog.livedoor.jp/sasata299/archives/51924944.html)\n\n\u5b9f\u969b\u306e\u30bd\u30fc\u30b9\u30b3\u30fc\u30c9\u3067\u89e3\u8aac\u3057\u307e\u3059\n\nhttps://github.com/sue445/ccc_privacy_crawler/blob/672bc0dbe8c88f431603b4913c2d1236df6e2d99/lib/workers/pdf_crawl_worker.rb#L28-39\n\n```ruby:lib/workers/pdf_crawl_worker.rb\n  def download_ccc_pdf(dest_pdf_file)\n    # mechanize\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u521d\u671f\u5316\n    agent = Mechanize.new\n\n    # http://qa.tsite.jp/faq/show/25129 \u3092\u958b\u304f\n    agent.get(\"http://qa.tsite.jp/faq/show/25129\")\n\n    # <a href=\"/attachment_file/\u301c.pdf\"> \u306e\u3088\u3046\u306a\u30ea\u30f3\u30af\u3092\u63a2\u3059\n    download_link = agent.page.link_with(href: %r(/attachment_file/.+\\.pdf))\n\n    # \u30ea\u30f3\u30af\u304c\u898b\u3064\u304b\u3089\u306a\u3051\u308c\u3070\u30a8\u30e9\u30fc\n    raise \"Not found download_link\" unless download_link\n\n    # \u30ea\u30f3\u30af\u5148\u306ePDF\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u3066\u30d5\u30a1\u30a4\u30eb\u306b\u4fdd\u5b58\u3059\u308b\n    pdf_content = agent.get_file(download_link.href)\n    File.open(dest_pdf_file, \"wb\") do |file|\n      file.write(pdf_content)\n    end\n  end\n```\n\n# pdf\u306e\u30b9\u30af\u30ec\u30a4\u30d4\u30f3\u30b0\n[pdf-reader](https://github.com/yob/pdf-reader) \u3068\u3044\u3046gem\u3092\u4f7f\u3063\u3066\u307e\u3059\u3002\n\npdf\u3092ruby\u304b\u3089\u8aad\u3080\u305f\u3081\u306egem\u306f\u3044\u304f\u3064\u304b\u4f7f\u3063\u3066\u307f\u305f\u306e\u3067\u3059\u304c\u3001\u4eca\u56de\u306f\u3053\u306egem\u3058\u3083\u306a\u3044\u3068\u3046\u307e\u304f\u30c6\u30ad\u30b9\u30c8\u3067\u53d6\u5f97\u51fa\u6765\u307e\u305b\u3093\u3067\u3057\u305f\u3002\uff08ccc\u306epdf\u306fExcel\u3092pdf\u306b\u5909\u63db\u3057\u3066\u308b\u307f\u305f\u3044\u306a\u306e\u3067\u3059\u304c\u3001\u4ed6\u306egem\u3060\u3068\u30bb\u30eb\u306e\u4e2d\u306e\u30c6\u30ad\u30b9\u30c8\u304c\u5217\u5358\u4f4d\u3067\u3057\u304b\u53d6\u5f97\u3067\u304d\u306a\u3044\u3002pdf-reader\u3060\u3068pdf\u3068\u3057\u3066\u30ec\u30f3\u30c0\u30ea\u30f3\u30b0\u3055\u308c\u308b\u6642\u306e\u5b9f\u969b\u306e\u5ea7\u6a19\u3082\u3042\u308b\u7a0b\u5ea6\u8003\u616e\u3057\u3066\u304f\u308c\u308b\u6a21\u69d8\uff09\n\n\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u305fpdf\u3092\u30c6\u30ad\u30b9\u30c8\u3067\u8aad\u307f\u8fbc\u3080\n\nhttps://github.com/sue445/ccc_privacy_crawler/blob/672bc0dbe8c88f431603b4913c2d1236df6e2d99/lib/workers/pdf_crawl_worker.rb#L65-74\n\n```ruby:lib/workers/pdf_crawl_worker.rb\n  def read_pdf(pdf_file)\n    pdf_content = \"\"\n\n    reader = PDF::Reader.new(pdf_file)\n    reader.pages.each do |page|\n      pdf_content << page.text\n    end\n\n    pdf_content\n  end\n```\n\n\u3053\u308c\u81ea\u4f53\u306f\u7279\u5225\u306a\u3053\u3068\u3092\u3057\u3066\u3044\u306a\u3044\u3093\u3067\u3059\u304c\u3001\u305d\u306e\u307e\u307e\u3060\u3068\u4e0b\u8a18\u306e\u3088\u3046\u306bpdf\u5185\u306e\u65e5\u4ed8\u304c\u3046\u307e\u304f\u53d6\u5f97\u3067\u304d\u307e\u305b\u3093\u3067\u3057\u305f\n\n```\n1 TSUTAYA\u30fb\u8526\u5c4b\u66f8\u5e97                      2014/10/2\u63d0\u643a\u5148\uff1aTSUTAYA\u30d5\u30e9\u30f3\u30c1\u30e3\u30a4\u30ba\u30c1\u30a7\u30fc\u30f3\u52a0\u76df\u4f01\u696d\n2 \uff2a\uff38\u65e5\u9271\u65e5\u77f3\u30a8\u30cd\u30eb\u30ae\u30fc\u682a\u5f0f\u4f1a\u793e                   2014/10/2\u63d0\u643a\u5148\uff1aENEOS\n3 \u682a\u5f0f\u4f1a\u793e\u30a2\u30d7\u30e9\u30b9                          2014/10/2\u63d0\u643a\u30b5\u30fc\u30d3\u30b9\uff1aT\u30ab\u30fc\u30c9\u30d7\u30e9\u30b9\uff0c T\u30ab\u30fc\u30c9\u30d7\u30e9\u30b9\u03b1 \uff0cTSUTAYAW\u30ab\u30fc\u30c9\n4 \u682a\u5f0f\u4f1a\u793e\uff2d\uff49\uff53\uff55\uff4d\uff49                        2014/10/2\u63d0\u643a\u5148\uff1aBOOKSmisumi\uff0cMisumi\u30b0\u30eb\u30fc\u30d7\uff08\u30ac\u30b9\u30fb\u6c34\uff09\n5 \uff2a\uff32\u4e5d\u5dde\u30c9\u30e9\u30c3\u30b0\u30a4\u30ec\u30d6\u30f3\u682a\u5f0f\u4f1a\u793e                  2014/10/2\u63d0\u643a\u5148\uff1a\u30c9\u30e9\u30c3\u30b0\u30a4\u30ec\u30d6\u30f3\n```\n\n\u30e2\u30f3\u30ad\u30fc\u30d1\u30c3\u30c1\u3067\u6587\u5b57\u63cf\u753b\u306e\u4f4d\u7f6e\u3092\u7121\u7406\u77e2\u7406\u5909\u3048\u3066\u5bfe\u5fdc\u3057\u3066\u307e\u3059\u3002\n\nhttps://github.com/sue445/ccc_privacy_crawler/blob/672bc0dbe8c88f431603b4913c2d1236df6e2d99/lib/pdf-reader.rb\n\n```ruby:lib/pdf-reader.rb\nclass PDF::Reader::PageLayout\n  # fix rate: 1.05 -> 1.5\n  def col_count\n    @col_count ||= ((@page_width  / @mean_glyph_width) * 1.5).floor\n  end\nend\n```\n\npdf\u3092\u6587\u5b57\u5217\u3067\u53d6\u5f97\u3067\u3057\u305f\u5f8c\u306f\u6b63\u898f\u8868\u73fe\u3067parse\u3057\u3066\u307e\u3059\n\nhttps://github.com/sue445/ccc_privacy_crawler/blob/672bc0dbe8c88f431603b4913c2d1236df6e2d99/lib/workers/pdf_crawl_worker.rb#L41-62\n\n```ruby:lib/workers/pdf_crawl_worker.rb\n  def parse_ccc_pdf(pdf_file)\n    companies = []\n    read_pdf(pdf_file).each_line do |line|\n      line = line.strip\n\n      matched_data = %r(\n        ^(?<no>[0-9]+)\\s*\n        (?<company_name>.+)\\s*\n        (?<receipted_date>[0-9]{4}/[0-9]{1,2}/[0-9]{1,2})\n        (?<destination_name>.+)$)x.match(line)\n      next unless matched_data\n\n      companies << Company.new(\n        no:               matched_data[:no].to_i,\n        company_name:     matched_data[:company_name].strip,\n        receipted_date:   matched_data[:receipted_date].strip,\n        destination_name: matched_data[:destination_name].strip,\n      )\n    end\n\n    companies\n  end\n```\n\n\u30bd\u30fc\u30b9\u30b3\u30fc\u30c9\u4e2d\u306e\u6b63\u898f\u8868\u73fe\u306e\n\n```ruby\n%r(\n^(?<no>[0-9]+)\\s*\n(?<company_name>.+)\\s*\n(?<receipted_date>[0-9]{4}/[0-9]{1,2}/[0-9]{1,2})\n(?<destination_name>.+)$)x.match(line)\n```\n\n\u306f\n\n```ruby\n/^([0-9]+)\\s*(.+)\\s*([0-9]{4}\\/[0-9]{1,2}\\/[0-9]{1,2})(.+)$/ =~ line\n```\n\n\u3068\u540c\u7b49\u3067\u3059\u304c\u4e0b\u8a18\u306e\u3088\u3046\u306a\u5de5\u592b\u304c\u3042\u308a\u307e\u3059\n\n* `$1` \u3084 `$2` \u3060\u3068\u5206\u304b\u308a\u3065\u3089\u3044\u306e\u3067 `(?<no>[0-9]+)` \u3084 `(?<company_name>.+)` \u306e\u3088\u3046\u306b\u540d\u524d\u4ed8\u304d\u30ad\u30e3\u30d7\u30c1\u30e3\u3092\u4f7f\u3046\n  * http://docs.ruby-lang.org/ja/2.3.0/doc/spec=2fregexp.html\n* `/\u301c/` \u3060\u3068\u6b63\u898f\u8868\u73fe\u5185\u306b\u30b9\u30e9\u30c3\u30b7\u30e5\u304c\u3042\u308b\u3068\u30a8\u30b9\u30b1\u30fc\u30d7\u3057\u306a\u3044\u3068\u3044\u3051\u306a\u3044\u306e\u3067 `%r(\u301c)` \u3092\u4f7f\u3046\n  * http://docs.ruby-lang.org/ja/2.3.0/doc/spec=2fliteral.html#regexp\n\n# \u30af\u30ed\u30fc\u30e9\n\u4f5c\u3063\u305f\u5f53\u521d\u306f\n\n* Heroku scheduler\u306e\u7121\u6599\u67a0\u306f1\u65e51\u56de\u5b9f\u884c\u306e\u307f\u3002\uff081\u6642\u9593\u306b1\u56de\u5b9f\u884c\u306f\u6709\u6599\uff09\n* \u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u309224\u6642\u9593\u30d5\u30eb\u7a3c\u50cd\u3057\u3066\u3044\u3066\u3082\u7121\u6599\n\n\u3068\u3044\u3046\u3053\u3068\u3082\u3042\u308a [sidekiq-cron](https://github.com/mperham/sidekiq) \u306e\u30d7\u30ed\u30bb\u30b9\u3092\u5e38\u99d0\u3057\u306630\u5206\u306b1\u56de\u5b9f\u884c\u3057\u3066\u3044\u305f\u306e\u3067\u3059\u304c\u30012015\u5e744\u6708\u9803 [^heroku-plan] \u306b\u65b0\u3057\u3044\u6599\u91d1\u4f53\u7cfb\u304c\u767a\u8868\u3055\u308c\n\n[^heroku-plan]: \u81ea\u5206\u304c\u5bfe\u5fdc\u3057\u305f\u65e5\u4ed8\u3088\u308a\u63a8\u6e2c https://github.com/sue445/ccc_privacy_crawler/pull/25\n\n* 24\u6642\u9593\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u8d77\u52d5\u3057\u7d9a\u3051\u308b\u3068\u6709\u6599\u306b\u306a\u308b\n* \u305d\u306e\u4ee3\u308f\u308aHeroku scheduler\u304c\u7121\u6599\u3067\u30821\u6642\u9593\u306b1\u56de\u52d5\u304b\u305b\u308b\u3088\u3046\u306b\u306a\u3063\u305f\n\n\u3068\u3044\u3046\u3053\u3068\u306b\u306a\u308a\u3001Heroku Scheduler\u30671\u6642\u9593\u306b1\u56de\u52d5\u304b\u3059\u3088\u3046\u306b\u3057\u3066\u3044\u307e\u3059\u3002\n\n![heroku_scheduler.png](https://qiita-image-store.s3.amazonaws.com/0/8059/1e5983ac-0507-1411-4ace-f55bcc364387.png)\n\n\u5143\u3005worker\u3067\u5b9f\u884c\u3057\u3066\u305f\u9803\u306e\u540d\u6b8b\u3067\u3001rake task\u5185\u3067worker\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092 `perform` \u3057\u3066\u3044\u307e\u3059\u3002\n\nhttps://github.com/sue445/ccc_privacy_crawler/blob/6146b3ac985274b2c686f98143ac6cd84a2c9f5c/lib/tasks/crawl_pdf.rake\n\n```ruby:lib/tasks/crawl_pdf.rake\ndesc \"crawl pdf\"\ntask :crawl_pdf => :environment do\n  PdfCrawlWorker.new.perform\nend\n```\n\n# web\u753b\u9762\n\u7279\u306b\u3069\u3053\u306b\u3082\u30a2\u30ca\u30a6\u30f3\u30b9\u3057\u3066\u3044\u306a\u304b\u3063\u305f\u3067\u3059\u304c\u3001\u30ec\u30b3\u30fc\u30c9\u3092\u898b\u308b\u306e\u306b\u30ed\u30fc\u30ab\u30eb\u304b\u3089 `padrino console` \u3059\u308b\u3060\u3051\u3060\u3068\u4e0d\u4fbf\u3060\u3063\u305f\u306e\u3067web\u3067\u898b\u308c\u308b\u3088\u3046\u306b\u3057\u3066\u3044\u307e\u3059\u3002\n\nhttps://ccc-privacy-crawler.herokuapp.com/\n\n\u81ea\u5206\u304c\u898b\u308c\u308c\u3070\u3044\u3044\u611f\u3042\u3063\u305f\u306e\u3067\u753b\u9762\u306f\u96d1\u3067\u3059\n", "tags": ["Ruby", "Padrino", "\u30b9\u30af\u30ec\u30a4\u30d4\u30f3\u30b0"]}