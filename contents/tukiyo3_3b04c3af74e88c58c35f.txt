{"context": " More than 1 year has passed since last update.\n\n\u53c2\u8003\n\n\nStorage: ZFS - Proxmox VE\n\nKVM\u3092\u4f7f\u3046\uff08\u30c7\u30a3\u30b9\u30af\u6027\u80fd\u7de8\u305d\u306e2\uff09 \u00ab \u3055\u304f\u3089\u30a4\u30f3\u30bf\u30fc\u30cd\u30c3\u30c8\u7814\u7a76\u6240\nEtsukata blog: qemu cache mode \u307e\u3068\u3081\n\n\n\u30b9\u30c8\u30ec\u30fc\u30b8\uff08ZFS\uff09 - JUSTPLAYER\u30a4\u30f3\u30bf\u30fc\u30cd\u30c3\u30c8\u30b5\u30fc\u30d3\u30b9\n\n\nzfs\u304c\u8d85\u9045\u3044\u5834\u5408\n\nPoor performance with ZFS\n\n\nsync=disabled\u306b\u3059\u308b\u306810\u500d\u304f\u3089\u3044\u65e9\u304f\u306a\u308b\nzfs set sync=disabled rpool\n\n\n\nsync=enabled(\u521d\u671f\u5024)\n# pveperf\nCPU BOGOMIPS:      22347.96\nREGEX/SECOND:      1314685\nHD SIZE:           440.39 GB (rpool/ROOT/pve-1)\nFSYNCS/SECOND:     42.32\nDNS EXT:           146.05 ms\nDNS INT:           13.54 ms\n\n\n\nsync=disabled(\u5909\u66f4\u5f8c)\n# pveperf\nCPU BOGOMIPS:      22347.96\nREGEX/SECOND:      1381188\nHD SIZE:           440.39 GB (rpool/ROOT/pve-1)\nFSYNCS/SECOND:     18952.28\nDNS EXT:           14.35 ms\nDNS INT:           2.19 ms\n\n\n\n/\u3092zfs\u306b\u3057\u305f\u5834\u5408\u3001compression\u304c\u6709\u52b9\u306b\u306a\u3063\u3066\u3044\u308b\n\ncompression\u306e\u78ba\u8a8d\n# zfs get compression\nNAME                      PROPERTY     VALUE     SOURCE\nrpool                     compression  lz4       local\nrpool/ROOT                compression  lz4       inherited from rpool\nrpool/ROOT/pve-1          compression  lz4       inherited from rpool\nrpool/swap                compression  lz4       inherited from rpool\ntank1a                    compression  off       default\n\n\n\ndedup\u306e\u78ba\u8a8d(\u5ff5\u306e\u70ba)\n# zfs get dedup\nNAME                      PROPERTY  VALUE          SOURCE\nrpool                     dedup     off            default\nrpool/ROOT                dedup     off            default\nrpool/ROOT/pve-1          dedup     off            default\nrpool/swap                dedup     off            default\ntank1a                    dedup     off            default\n\n\n\ncompression\u306e\u7121\u52b9\u5316\nzfs set compression=off rpool\n\n\n\n\u78ba\u8a8d\n# zfs get compression\nNAME                      PROPERTY     VALUE     SOURCE\nrpool                     compression  off       local\nrpool/ROOT                compression  off       inherited from rpool\nrpool/ROOT/pve-1          compression  off       inherited from rpool\nrpool/swap                compression  off       inherited from rpool\ntank1a                    compression  off       default\n\n\n\nVM\u306eDISK Cache\u3092\u5909\u66f4\u3059\u308b\u3053\u3068\n\nVM\u4f5c\u6210\u3057\u305f\u76f4\u5f8c\u3060\u3051\u306a\u305c\u304bVM\u8d77\u52d5\u5931\u6557\u3059\u308b\u304c\u30012\u56de\u76ee\u304b\u3089\u306f\u8d77\u52d5\u3059\u308b(\u4e0d\u601d\u8b70)\n\nDefault(No Cache)\u3060\u3068VM\u304c\u8d77\u52d5\u3057\u306a\u3044\n\n\n\nWrite Back\u304bWrite Through\u306b\u8a2d\u5b9a\u3059\u308b\u3053\u3068\u3002QEMU tuning\n\n\n\n\n\nKVM\n\nkvm\u306fcache=writeback \u304b writethrough\u306b\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u3002\n\n\nLVM\u306ePV\u3092\u7e2e\u5c0f\u3057\u305f\u3044\u5834\u5408\n\nproxmox - LVM\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u3092\u7e2e\u5c0f - Qiita\n\n\nZFS\u306e\u30ad\u30e3\u30c3\u30b7\u30e5\u3092SSD\u306b\u3057\u305f\u3044\n\n\n/home\u3092zfs\u5229\u7528(RAID1+SSD\u3092rw\u306e\u30ad\u30e3\u30c3\u30b7\u30e5\u306b\u4f7f\u3046)L2ARC - Qiita\u3092\u53c2\u8003\u306b /dev/sdc4, sdc5 \u3092log, chache \u306b\u5272\u308a\u5f53\u3066\u3066\u5229\u7528\u3067\u304d\u305f\u3002\n\n\nZFS\u30d7\u30fc\u30eb\u306e\u8a8d\u8b58\u306b\u5931\u6557\u3059\u308b\u5834\u5408\nzpool create rpool mirror /dev/sda1 /dev/sdb1\n\n\u3092\u3057\u3066OS\u518d\u8d77\u52d5\u3059\u308b\u3068\u3001rpool\u304c\u898b\u5f53\u305f\u3089\u306a\u3044\u3068\u8a00\u308f\u308c\u305f\u3002\nzpool status -v\n\n\n\u89e3\u6c7a\u65b9\u6cd5\nzpool create \u301c\u3057\u305f\u5f8c\u3001Proxmox\u306eWebUI\u304b\u3089ZFS\u30b9\u30c8\u30ec\u30fc\u30b8\u306e\u5272\u308a\u5f53\u3066\u3092\u3059\u308c\u3070\nOS\u518d\u8d77\u52d5\u5f8c\u3082\u8a8d\u8b58\u3057\u3066\u304f\u308c\u308b\u3002\n\nZFS\u30dc\u30ea\u30e5\u30fc\u30e0\u306e\u4f5c\u6210\n\n/home\u3092zfs\u5229\u7528(RAID1+SSD\u3092rw\u306e\u30ad\u30e3\u30c3\u30b7\u30e5\u306b\u4f7f\u3046)L2ARC - Qiita\n\n/dev/sdc\u304c119.2GB\u4f59\u3063\u3066\u3044\u305f\u305f\u3081\n\nlog 1GB\ncache 29G \u5272\u308a\u5f53\u3066\u305f\u3002\n\n\n\n\npool\u306e\u4f5c\u6210\nzpool create tank1a /dev/sda -f\nzpool create tank1b /dev/sdb -f\nzpool create tank2t /dev/sde -f\n\n\nzpool add rpool log /dev/sdc1\nzpool add rpool cache /dev/sdc5\nzpool add tank1a log /dev/sdc2\nzpool add tank1a cache /dev/sdc6\nzpool add tank1b log /dev/sdc3\nzpool add tank1b cache /dev/sdc7\nzpool add tank2t log /dev/sdc4\nzpool add tank2t cache /dev/sdc8\n\n\n\u78ba\u8a8d\nzpool iostat -v\n\n\nzfs\u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0\u306e\u524a\u9664\n\n\u30ea\u30ab\u30d0\u30ea\u3092\u9014\u4e2d\u3067\u3084\u3081\u305f\u5834\u5408\u30b4\u30df\u304c\u6b8b\u308b\u306e\u3067\u524a\u9664\u3057\u305f\u3044\u3002\n\n# zfs list\nNAME                       USED  AVAIL  REFER  MOUNTPOINT\ntank1b/subvol-100-disk-1    22K  8.00G    22K  /tank1b/subvol-100-disk-1\ntank1b/vm-365-disk-1      82.5G   668G  4.00G  -\ntank1b/vm-365-disk-2      82.5G   645G  27.3G  -\n\n\n\u524a\u9664\nzfs destroy tank1b/subvol-100-disk-1\nzfs destroy tank1b/vm-365-disk-1\nzfs destroy tank1b/vm-365-disk-2\n\n\n# \u53c2\u8003\n\n* [Storage: ZFS - Proxmox VE](https://pve.proxmox.com/wiki/Storage:_ZFS)\n    * [KVM\u3092\u4f7f\u3046\uff08\u30c7\u30a3\u30b9\u30af\u6027\u80fd\u7de8\u305d\u306e2\uff09 \u00ab \u3055\u304f\u3089\u30a4\u30f3\u30bf\u30fc\u30cd\u30c3\u30c8\u7814\u7a76\u6240](http://research.sakura.ad.jp/2010/04/21/kvm-diskperf2/)\n    * [Etsukata blog: qemu cache mode \u307e\u3068\u3081](http://blog.etsukata.com/2013/02/qemu-cache-mode.html)\n* [\u30b9\u30c8\u30ec\u30fc\u30b8\uff08ZFS\uff09 - JUSTPLAYER\u30a4\u30f3\u30bf\u30fc\u30cd\u30c3\u30c8\u30b5\u30fc\u30d3\u30b9](http://www.justplayer.ne.jp/manual_vps_solaris11_zfs.html)\n\n## zfs\u304c\u8d85\u9045\u3044\u5834\u5408\n\n* [Poor performance with ZFS](http://forum.proxmox.com/threads/21568-Poor-performance-with-ZFS)\n\n```bash:sync=disabled\u306b\u3059\u308b\u306810\u500d\u304f\u3089\u3044\u65e9\u304f\u306a\u308b\nzfs set sync=disabled rpool\n```\n\n```bash:sync=enabled(\u521d\u671f\u5024)\n# pveperf\nCPU BOGOMIPS:      22347.96\nREGEX/SECOND:      1314685\nHD SIZE:           440.39 GB (rpool/ROOT/pve-1)\nFSYNCS/SECOND:     42.32\nDNS EXT:           146.05 ms\nDNS INT:           13.54 ms\n```\n\n```bash:sync=disabled(\u5909\u66f4\u5f8c)\n# pveperf\nCPU BOGOMIPS:      22347.96\nREGEX/SECOND:      1381188\nHD SIZE:           440.39 GB (rpool/ROOT/pve-1)\nFSYNCS/SECOND:     18952.28\nDNS EXT:           14.35 ms\nDNS INT:           2.19 ms\n```\n\n\n# /\u3092zfs\u306b\u3057\u305f\u5834\u5408\u3001compression\u304c\u6709\u52b9\u306b\u306a\u3063\u3066\u3044\u308b\n\n```bash:compression\u306e\u78ba\u8a8d\n# zfs get compression\nNAME                      PROPERTY     VALUE     SOURCE\nrpool                     compression  lz4       local\nrpool/ROOT                compression  lz4       inherited from rpool\nrpool/ROOT/pve-1          compression  lz4       inherited from rpool\nrpool/swap                compression  lz4       inherited from rpool\ntank1a                    compression  off       default\n```\n\n```bash:dedup\u306e\u78ba\u8a8d(\u5ff5\u306e\u70ba)\n# zfs get dedup\nNAME                      PROPERTY  VALUE          SOURCE\nrpool                     dedup     off            default\nrpool/ROOT                dedup     off            default\nrpool/ROOT/pve-1          dedup     off            default\nrpool/swap                dedup     off            default\ntank1a                    dedup     off            default\n```\n\n```bash:compression\u306e\u7121\u52b9\u5316\nzfs set compression=off rpool\n```\n\n```bash:\u78ba\u8a8d\n# zfs get compression\nNAME                      PROPERTY     VALUE     SOURCE\nrpool                     compression  off       local\nrpool/ROOT                compression  off       inherited from rpool\nrpool/ROOT/pve-1          compression  off       inherited from rpool\nrpool/swap                compression  off       inherited from rpool\ntank1a                    compression  off       default\n```\n\n# VM\u306eDISK Cache\u3092\u5909\u66f4\u3059\u308b\u3053\u3068\n\n* VM\u4f5c\u6210\u3057\u305f\u76f4\u5f8c\u3060\u3051\u306a\u305c\u304bVM\u8d77\u52d5\u5931\u6557\u3059\u308b\u304c\u30012\u56de\u76ee\u304b\u3089\u306f\u8d77\u52d5\u3059\u308b(\u4e0d\u601d\u8b70)\n* `Default(No Cache)`\u3060\u3068VM\u304c\u8d77\u52d5\u3057\u306a\u3044\n  * `Write Back`\u304b`Write Through`\u306b\u8a2d\u5b9a\u3059\u308b\u3053\u3068\u3002[QEMU tuning](https://pve.proxmox.com/wiki/Storage:_ZFS)\n\n# KVM\n\n* kvm\u306fcache=writeback \u304b writethrough\u306b\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u3002\n\n# LVM\u306ePV\u3092\u7e2e\u5c0f\u3057\u305f\u3044\u5834\u5408\n\n* [proxmox - LVM\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u3092\u7e2e\u5c0f - Qiita](http://qiita.com/tukiyo3/items/10454c08dc351b004689)\n\n# ZFS\u306e\u30ad\u30e3\u30c3\u30b7\u30e5\u3092SSD\u306b\u3057\u305f\u3044\n\n* [/home\u3092zfs\u5229\u7528(RAID1+SSD\u3092rw\u306e\u30ad\u30e3\u30c3\u30b7\u30e5\u306b\u4f7f\u3046)L2ARC - Qiita](http://qiita.com/tukiyo3/items/8b3eaf4fc0602742422a)\u3092\u53c2\u8003\u306b /dev/sdc4, sdc5 \u3092log, chache \u306b\u5272\u308a\u5f53\u3066\u3066\u5229\u7528\u3067\u304d\u305f\u3002\n\n# ZFS\u30d7\u30fc\u30eb\u306e\u8a8d\u8b58\u306b\u5931\u6557\u3059\u308b\u5834\u5408\n\n```\nzpool create rpool mirror /dev/sda1 /dev/sdb1\n```\n\n\u3092\u3057\u3066OS\u518d\u8d77\u52d5\u3059\u308b\u3068\u3001rpool\u304c\u898b\u5f53\u305f\u3089\u306a\u3044\u3068\u8a00\u308f\u308c\u305f\u3002\n\n```bash:\nzpool status -v\n```\n\n## \u89e3\u6c7a\u65b9\u6cd5\n\n`zpool create \u301c`\u3057\u305f\u5f8c\u3001Proxmox\u306eWebUI\u304b\u3089ZFS\u30b9\u30c8\u30ec\u30fc\u30b8\u306e\u5272\u308a\u5f53\u3066\u3092\u3059\u308c\u3070\nOS\u518d\u8d77\u52d5\u5f8c\u3082\u8a8d\u8b58\u3057\u3066\u304f\u308c\u308b\u3002\n\n# ZFS\u30dc\u30ea\u30e5\u30fc\u30e0\u306e\u4f5c\u6210\n\n* [/home\u3092zfs\u5229\u7528(RAID1+SSD\u3092rw\u306e\u30ad\u30e3\u30c3\u30b7\u30e5\u306b\u4f7f\u3046)L2ARC - Qiita](http://qiita.com/tukiyo3/items/8b3eaf4fc0602742422a)\n\n* /dev/sdc\u304c119.2GB\u4f59\u3063\u3066\u3044\u305f\u305f\u3081\n  * log 1GB\n  * cache 29G \u5272\u308a\u5f53\u3066\u305f\u3002\n\n```bash:pool\u306e\u4f5c\u6210\nzpool create tank1a /dev/sda -f\nzpool create tank1b /dev/sdb -f\nzpool create tank2t /dev/sde -f\n```\n\n```bash:\nzpool add rpool log /dev/sdc1\nzpool add rpool cache /dev/sdc5\nzpool add tank1a log /dev/sdc2\nzpool add tank1a cache /dev/sdc6\nzpool add tank1b log /dev/sdc3\nzpool add tank1b cache /dev/sdc7\nzpool add tank2t log /dev/sdc4\nzpool add tank2t cache /dev/sdc8\n```\n\n## \u78ba\u8a8d\n\n```bash:\nzpool iostat -v\n```\n\n## zfs\u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0\u306e\u524a\u9664\n\n* \u30ea\u30ab\u30d0\u30ea\u3092\u9014\u4e2d\u3067\u3084\u3081\u305f\u5834\u5408\u30b4\u30df\u304c\u6b8b\u308b\u306e\u3067\u524a\u9664\u3057\u305f\u3044\u3002\n\n```bash:\n# zfs list\nNAME                       USED  AVAIL  REFER  MOUNTPOINT\ntank1b/subvol-100-disk-1    22K  8.00G    22K  /tank1b/subvol-100-disk-1\ntank1b/vm-365-disk-1      82.5G   668G  4.00G  -\ntank1b/vm-365-disk-2      82.5G   645G  27.3G  -\n```\n\n```bash:\u524a\u9664\nzfs destroy tank1b/subvol-100-disk-1\nzfs destroy tank1b/vm-365-disk-1\nzfs destroy tank1b/vm-365-disk-2\n```\n", "tags": ["proxmox4", "ZFS"]}