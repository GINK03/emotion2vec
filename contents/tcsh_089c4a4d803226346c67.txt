{"tags": ["twilio", "PHP", "nginx", "php-fpm"], "context": " More than 1 year has passed since last update.Twilio\u3067\u30e1\u30c3\u30bb\u30fc\u30b8\u9332\u97f3\u30b7\u30b9\u30c6\u30e0\u3092\u69cb\u7bc9\u3057\u3066\u307f\u307e\u3059\u3002\n\u97f3\u58f0\u30e1\u30cb\u30e5\u30fc\u306b\u5f93\u3063\u3066\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u9332\u97f3\u3057\u307e\u3059\u3002\n\n\u524d\u63d0\u6761\u4ef6\n\n\u516c\u958b\u30b5\u30fc\u30d0\u74b0\u5883\n\n(\u53c2\u8003) Amazon Linux\u74b0\u5883\u306e\u69cb\u7bc9\n\n\n\u30ad\u30fc\u30da\u30a2\u306e\u4f5c\u6210 (\u65b0\u898f): http://qiita.com/tcsh/items/59303d9506ca7d13f744\n\n\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u4f5c\u6210 (Public): http://qiita.com/tcsh/items/ae8f1f0d706237327c5a\n\n\n\n\n\nWeb\u30b5\u30fc\u30d0 + PHP\u74b0\u5883\n\nPHP (5.4\u4ee5\u4e0a\u3092\u60f3\u5b9a)\nTwilio PHP SDK\n\n(\u53c2\u8003) Twilio\u3067\u756a\u53f7\u5165\u529b\u3092\u53d7\u3051\u4ed8\u3051\u3066\u307f\u308b (AmazonLinux + nginx + php-fpm): \n\nTwilio\u306e\u30a2\u30ab\u30a6\u30f3\u30c8\n\nTwilio\u306e\u30a2\u30ab\u30a6\u30f3\u30c8\u3092\u4fdd\u6709\u3057\u3066\u3044\u308b\u3053\u3068\u3002\n\n\nTwilio\u306e\u96fb\u8a71\u756a\u53f7\nTwilio\u306e\u8a8d\u8a3c\u60c5\u5831 (ACCOUNT SID / AUTH TOKEN)\n\n\n\n\n0. \u4e8b\u524d\u6e96\u5099\n\n0.1. Twilio\u30a2\u30ab\u30a6\u30f3\u30c8\u60c5\u5831\u306e\u8a2d\u5b9a\nTwilio\u306e\u300c\u306f\u3058\u3081\u3088\u3046\u300d\u753b\u9762\u304b\u3089\u4ee5\u4e0b\u306e\u60c5\u5831\u3092\u53d6\u5f97\u3057\u3066\u5909\u6570\u306b\u683c\u7d0d\u3057\u307e\u3059\u3002\n\nACCOUNT SID\nAUTH TOKEN\n\u96fb\u8a71\u756a\u53f7\n\n\n\u5909\u6570\u306e\u8a2d\u5b9a\nTWILIO_ACCOUNT_SID='ACxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx'\nTWILIO_AUTH_TOKEN='xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx'\nTEL_TWILIO_ORIGIN=<Twilio\u3067\u53d6\u5f97\u3057\u305f\u96fb\u8a71\u756a\u53f7>\n\n\n\n0.2. \u30d5\u30a1\u30a4\u30eb\u7f6e\u304d\u5834\u306e\u4f5c\u6210\n\n\u5909\u6570\u306e\u8a2d\u5b9a\nDIR_HTML='/usr/share/nginx/html'\nDIR_TWIML=\"${DIR_HTML}/sysadm/xml\"\nDIR_PHP_SCRIPT=\"${DIR_HTML}/php\"\nURL_PHP_SCRIPT=$(echo ${DIR_PHP_SCRIPT} | sed \"s|${DIR_HTML}||\" )\n\n\n\n\u30b3\u30de\u30f3\u30c9\nsudo mkdir -p ${DIR_TWIML} ${DIR_PHP_SCRIPT} \\\n  && ls ${DIR_TWIML} ${DIR_PHP_SCRIPT}\n\n\n\n1. \u30e1\u30c3\u30bb\u30fc\u30b8\u9332\u97f3\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u4f5c\u6210\n\n1.1. \u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306e\u4f5c\u6210\n\n\u5909\u6570\u306e\u8a2d\u5b9a\nDIR_TWILIO_APP=\"${HOME}/app/twilio-record-app\" \\\n  && echo ${DIR_TWILIO_APP}\nAPP_NAME=$(echo ${DIR_TWILIO_APP} | sed 's|^.*/||') \\\n  && echo ${APP_NAME}\n\n\n\n\u30b3\u30de\u30f3\u30c9\nmkdir -p ${DIR_TWILIO_APP} \\\n  && cd ${DIR_TWILIO_APP}\n\n\n\n1.2. composer\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n\u30b3\u30de\u30f3\u30c9\ncd ${DIR_TWILIO_APP} \\\n        && mkdir bin \\\n        && curl -sS https://getcomposer.org/installer | \\\n          php -- --install-dir=bin --filename=composer\n\n\n\n\u7d50\u679c(\u4f8b)\n      #!/usr/bin/env php\n      All settings correct for using Composer\n      Downloading...\n\n      Composer successfully installed to: /Users/taro/app/twilio-php/composer.phar\n      Use it: php bin/composer\n\n\n\n1.3. Twilio PHP SDK\u306e\u5c0e\u5165\n\u53c2\u8003: https://jp.twilio.com/docs/php/install\n\n\u30b3\u30de\u30f3\u30c9\ncd ${DIR_TWILIO_APP} \\\n        && ./bin/composer require twilio/sdk\n\n\n\n\u7d50\u679c(\u4f8b)\n      Using version ^4.2 for twilio/sdk\n      ./composer.json has been created\n      Loading composer repositories with package information\n      Updating dependencies (including require-dev)\n        - Installing twilio/sdk (4.2.1)\n          Downloading: 100%\n\n      Writing lock file\n      Generating autoload files\n\n\n\n\u30b3\u30de\u30f3\u30c9\nls ${DIR_TWILIO_APP}/vendor/twilio/sdk/Services/Twilio.php > /dev/null 2>&1 \\\n  && echo $?\n\n\n\n\u7d50\u679c(\u4f8b\n0\n\n\nTwilio PHP\u30e9\u30a4\u30d6\u30e9\u30ea\u30d5\u30a1\u30a4\u30eb\u306e\u4f4d\u7f6e\u3092\u5909\u6570\u306b\u53d6\u308a\u8fbc\u307f\u307e\u3059\u3002\n\n\u5909\u6570\u306e\u8a2d\u5b9a\nFILE_LIB_TWILIO=\"vendor/twilio/sdk/Services/Twilio.php\" \\\n  && ls ${FILE_LIB_TWILIO} > /dev/null 2>&1 \\\n  && echo $?\n\n\n\n\u7d50\u679c(\u4f8b)\n0\n\n\n\n1.4. Twilio\u3067\u9332\u97f3\u53d7\u4ed8\u3092\u3059\u308b\u30b9\u30af\u30ea\u30d7\u30c8\u306e\u4f5c\u6210\n\n\u5909\u6570\u306e\u8a2d\u5b9a\nFILE_PHP_SCRIPT='announce-record.php'\n\n\n\n\u5909\u6570\u306e\u78ba\u8a8d\"\ncat << ETX\n\n  FILE_PHP_SCRIPT:    ${FILE_PHP_SCRIPT}\n\nETX\n\n\n\n\u30b3\u30de\u30f3\u30c9\ncat << EOF > ${FILE_PHP_SCRIPT}\n<?php\necho \"<?xml version=\\\"1.0\\\" encoding=\\\"UTF-8\\\"?>\\n\";\n?>\n<Response>\n<?php echo \"<Say language=\\\"ja-jp\\\">\u304a\u5ba2\u3055\u307e\u306f\u3001\" . \\$_REQUEST['Digits'] . \"\u3092\u62bc\u3055\u308c\u307e\u3057\u305f\u3002</Say>\" ?>\n<?php if (\\$_REQUEST['Digits'] == '1') { ?>\n    <Say language=\"ja-jp\">\u30d3\u30fc\u30d7\u304a\u3093\u306e\u3042\u3068\u306b\u300120\u79d2\u4ee5\u5185\u3067\u3001\u3054\u5951\u7d04\u306b\u3064\u3044\u3066\u306e\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u304a\u306d\u304c\u3044\u3057\u307e\u3059\u3002\u7d42\u4e86\u3057\u305f\u3089\u3001\u30b7\u30e3\u30fc\u30d7\u30dc\u30bf\u30f3\u3092\u62bc\u3057\u3066\u304f\u3060\u3055\u3044\u3002</Say>\n    <Record\n        method=\"GET\"\n        maxLength=\"20\"\n        finishOnKey=\"#\"\n        action=\"${URL_PHP_SCRIPT}/${APP_NAME}/thankyou.php\"\n    />\n    <Say language=\"ja-jp\">\u9332\u97f3\u3067\u304d\u307e\u305b\u3093\u3067\u3057\u305f\u3002</Say>\n\n<?php } elseif (\\$_REQUEST['Digits'] == '2') { ?>\n    <Say language=\"ja-jp\">\u30d3\u30fc\u30d7\u304a\u3093\u306e\u3042\u3068\u306b\u300120\u79d2\u4ee5\u5185\u3067\u3001\u6599\u91d1\u306b\u3064\u3044\u3066\u306e\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u304a\u306d\u304c\u3044\u3057\u307e\u3059\u3002\u7d42\u4e86\u3057\u305f\u3089\u3001\u30b7\u30e3\u30fc\u30d7\u30dc\u30bf\u30f3\u3092\u62bc\u3057\u3066\u304f\u3060\u3055\u3044\u3002</Say>\n    <Record\n        method=\"GET\"\n        maxLength=\"20\"\n        finishOnKey=\"#\"\n        action=\"${URL_PHP_SCRIPT}/${APP_NAME}/thankyou.php\"\n    />\n    <Say language=\"ja-jp\">\u308d\u304f\u304a\u3093\u3067\u304d\u307e\u305b\u3093\u3067\u3057\u305f\u3002</Say>\n\n<?php } else { ?>\n    <Say language=\"ja-jp\">\u3042\u308a\u304c\u3068\u3046\u3054\u3056\u3044\u307e\u3057\u305f\u3002</Say>\n<?php } ?>\n</Response>\nEOF\n\ncat ${FILE_PHP_SCRIPT}\n\n\n\u52d5\u4f5c\u78ba\u8a8d\u3092\u3057\u307e\u3059\u3002\n\n\u30b3\u30de\u30f3\u30c9\nphp ${FILE_PHP_SCRIPT} > announce-record.xml \\\n  && xmllint announce-record.xml --noout \\\n  && echo $? \\\n  && rm announce-record.xml\n\n\n\n\u7d50\u679c(\u4f8b)\nPHP Notice:  Undefined index: Digits in /home/ec2-user/app/twilio-record-app/thankyou.php on line 5\nPHP Notice:  Undefined index: Digits in /home/ec2-user/app/twilio-record-app/announce-record.php on line 6\nPHP Notice:  Undefined index: Digits in /home/ec2-user/app/twilio-record-app/announce-record.php on line 16\n0\n\n\n\n1.5. \u9332\u97f3\u5b8c\u4e86\u5f8c\u306b\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u4f1d\u3048\u308b\u51e6\u7406\u3059\u308b\u30b9\u30af\u30ea\u30d7\u30c8\u306e\u4f5c\u6210\n\n\u5909\u6570\u306e\u8a2d\u5b9a\nFILE_PHP_SCRIPT='thankyou.php'\nMSG_THANKYOU='\u3054\u308c\u3093\u3089\u304f\u3001\u3042\u308a\u304c\u3068\u3046\u3054\u3056\u3044\u307e\u3057\u305f\u3002'\n\n\n\n\u5909\u6570\u306e\u78ba\u8a8d\ncat << ETX\n\n  FILE_PHP_SCRIPT: ${FILE_PHP_SCRIPT}\n  MSG_THANKYOU: ${MSG_THANKYOU}\n\nETX\n\n\n\n\u30b3\u30de\u30f3\u30c9(\u65e5\u672c\u8a9e\u306e\u5834\u5408)\ncat << EOF > ${FILE_PHP_SCRIPT}\n<?php\necho \"<?xml version=\\\"1.0\\\" encoding=\\\"UTF-8\\\"?>\\n\";\n?>\n<Response><Say language=\"ja-jp\">${MSG_THANKYOU}</Say></Response>\nEOF\n\ncat ${FILE_PHP_SCRIPT}\n\n\n\u52d5\u4f5c\u78ba\u8a8d\u3092\u3057\u307e\u3059\u3002\n\n\u30b3\u30de\u30f3\u30c9\nphp ${FILE_PHP_SCRIPT} > thankyou.xml \\\n  && xmllint thankyou.xml --noout \\\n  && echo $? \\\n  && rm thankyou.xml\n\n\n\n\u7d50\u679c(\u4f8b)\n0\n\n\n\n2. Web\u30b5\u30fc\u30d0\u306e\u516c\u958b\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306b\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u914d\u7f6e\n\n\u30b3\u30de\u30f3\u30c9\nsudo cp -R ${DIR_TWILIO_APP} ${DIR_PHP_SCRIPT}/ \\\n  && cat ${DIR_PHP_SCRIPT}/${APP_NAME}/${FILE_PHP_SCRIPT}\n\n\n\n3. \u30b9\u30af\u30ea\u30d7\u30c8\u306e\u52d5\u4f5c\u78ba\u8a8d\n\u30d6\u30e9\u30a6\u30b6\u3067\u30a2\u30af\u30bb\u30b9\u3057\u3066\u307f\u307e\u3057\u3087\u3046\u3002\n\nhttp://<\u30db\u30b9\u30c8>/php/twilio-record-app/announce-record.php\nhttp://<\u30db\u30b9\u30c8>/php/twilio-record-app/thankyou.php\n\n'404 Not Found'\u304c\u8868\u793a\u3055\u308c\u306a\u3051\u308c\u3070OK\u3067\u3059\u3002\n\n4. TwiML\u30d5\u30a1\u30a4\u30eb\u306e\u4f5c\u6210\n\n4.1. TwiML\u30d5\u30a1\u30a4\u30eb\u306e\u4f5c\u6210\n\n\u5909\u6570\u306e\u8a2d\u5b9a\nFILE_TWIML=\"${APP_NAME}.xml\"\nMSG_SAY='\u3002\u3088\u3046\u3053\u305d\u3002\u3054\u3051\u3044\u3084\u304f\u306e\u578b\u306f\u30011\u756a\u3068\u30b7\u30e3\u30fc\u30d7\u3092\u3002\u6599\u91d1\u306e\u304a\u3068\u3044\u3042\u308f\u305b\u306f\u30012\u756a\u3068\u30b7\u30e3\u30fc\u30d7\u3092\u3002\u305d\u306e\u307b\u304b\u306e\u3054\u3088\u3046\u306e\u304b\u305f\u308f\u30019\u756a\u3068\u30b7\u30e3\u30fc\u30d7\u3092\u3001\u304a\u3057\u3066\u304f\u3060\u3055\u3044\u3002'\nMSG_ERROR=\"\u756a\u53f7\u304c\u308f\u304b\u308a\u307e\u305b\u3093\u3067\u3057\u305f\u3002\u3042\u308a\u304c\u3068\u3046\u3054\u3056\u3044\u307e\u3057\u305f\u3002\"\nMAX_LENGTH_RECORD='20'\n\n\n\n\u5909\u6570\u306e\u78ba\u8a8d\ncat << ETX\n\n  FILE_TWIML:        ${FILE_TWIML}\n  MSG_SAY:           ${MSG_SAY}\n  MSG_ERROR:         ${MSG_ERROR}\n  MAX_LENGTH_RECORD: ${MAX_LENGTH_RECORD}\n\nETX\n\n\n\n\u30b3\u30de\u30f3\u30c9(\u65e5\u672c\u8a9e\u7248)\ncat << EOF > ~/${FILE_TWIML}\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<Response>\n    <Gather action=\"${URL_PHP_SCRIPT}/${APP_NAME}/announce-record.php\"\nmethod=\"GET\">\n        <Say language=\"ja-jp\">${MSG_SAY}</Say>\n    </Gather>\n    <Say language=\"ja-jp\">${MSG_ERROR}</Say>\n</Response>\nEOF\n\ncat ~/${FILE_TWIML}\n\n\n\n\u30b3\u30de\u30f3\u30c9\nxmllint ~/${FILE_TWIML} -noout\n\n\n\n4.2. Web\u30b5\u30fc\u30d0\u306e\u516c\u958b\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306bTwilioML\u30d5\u30a1\u30a4\u30eb\u3092\u914d\u7f6e\nTwilioML\u3092\u914d\u7f6e\u5834\u6240\u306f\u3001GET\u3067\u53d6\u5f97\u3067\u304d\u308b\u74b0\u5883\u3067\u3042\u308c\u3070\u826f\u3044\u306e\u3067S3\u4e0a\u3067\u3082\u304b\u307e\u3044\u307e\u305b\u3093\u304c\u3001\u4eca\u56de\u306f\u4e0a\u8a18\u306e\u516c\u958bWeb\u30b5\u30fc\u30d0\u4e0a\u306b\u914d\u7f6e\u3057\u307e\u3059\u3002\n\n\u30b3\u30de\u30f3\u30c9\nsudo cp ~/${FILE_TWIML} ${DIR_TWIML}/ \\\n  && cat ${DIR_TWIML}/${FILE_TWIML}\n\n\n\n4.3. TwilioML\u30d5\u30a1\u30a4\u30eb\u3078\u306e\u30a2\u30af\u30bb\u30b9\u78ba\u8a8d\n\u30d6\u30e9\u30a6\u30b6\u3067 http://<\u30db\u30b9\u30c8>/sysadm/xml/twilio-record-app.xml \u306b\u30a2\u30af\u30bb\u30b9\u3057\u3066\u3001XML\u304c\u8868\u793a\u3055\u308c\u308c\u3070OK\u3067\u3059\u3002\n\n5. Twilio\u306e\u8a2d\u5b9a\u5909\u66f4\n\n\u30ed\u30b0\u30a4\u30f3: http://twilio.kddi-web.com\n\n\u753b\u9762: 'Voice, SMS & MMS' > '\u96fb\u8a71\u756a\u53f7: 'https://jp.twilio.com/user/account/voice-sms-mms/phone-numbers\n\n\u96fb\u8a71\u756a\u53f7\u306e\u30ea\u30f3\u30af\u3092\u30af\u30ea\u30c3\u30af\u3057\u307e\u3059\u3002\n\u30dd\u30c3\u30d7\u30a2\u30c3\u30d7\u3067\u300c\u97f3\u58f0\u901a\u8a71\u300d\u30bf\u30d6\u3092\u9078\u629e\u3057\u307e\u3059\u3002\nRequest URL\u306bTwiML(XML\u30d5\u30a1\u30a4\u30eb)\u306eURL\u3092\u8cbc\u308a\u4ed8\u3051\u307e\u3059\u3002\n\n\n\u4f8b: http://username:password@<\u30db\u30b9\u30c8\u540d>/sysadm/xml/twilio-record-app.xml\nusername:password\u306b\u306f\u3001\u30d9\u30fc\u30b7\u30c3\u30af\u8a8d\u8a3c\u306e\u30e6\u30fc\u30b6\u540d(\u4f8b:sysadm)\u3068\u30d1\u30b9\u30ef\u30fc\u30c9(\u4f8b:#userPass123)\u3092\u8a18\u8ff0\u3057\u307e\u3059\u3002\n\n\nURL\u3092\u8cbc\u308a\u4ed8\u3051\u305f\u6b04\u306e\u53f3\u306e\u30d7\u30eb\u30c0\u30a6\u30f3\u304b\u3089'HTTP GET'\u3092\u9078\u629e\u3057\u307e\u3059\u3002\n\n\n\n\n\n\u300c\u4fdd\u5b58\u300d\u30dc\u30bf\u30f3\u3092\u30af\u30ea\u30c3\u30af\u3057\u307e\u3059\u3002\n\n\n6. \u96fb\u8a71\u30a2\u30d7\u30ea\u306e\u52d5\u4f5c\u78ba\u8a8d\n\n\nTwilio\u304b\u3089\u5272\u308a\u5f53\u3066\u3089\u308c\u305f\u96fb\u8a71\u756a\u53f7\u306b\u96fb\u8a71\u3057\u307e\u3059\u3002\n\ntwilio-record-app.xml\u306b\u8a18\u8ff0\u3057\u305f\u30e1\u30c3\u30bb\u30fc\u30b8\u304c\u6d41\u308c\u307e\u3059\u3002\n\n\n\u756a\u53f7\u3092\u5165\u529b\u3057\u307e\u3059\u3002\n\n\u30a2\u30ca\u30a6\u30f3\u30b9\u306b\u5f93\u3063\u3066\u3001\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u9332\u97f3\u3057\u307e\u3059\u3002\n\n\u3057\u3070\u3089\u304f\u5f85\u3064\u3001\u3082\u3057\u304f\u306f#\u30ad\u30fc\u3092\u62bc\u3057\u307e\u3059\u3002\n\n\nthankyou.php\u306b\u8a18\u8ff0\u3057\u305f\u30e1\u30c3\u30bb\u30fc\u30b8\u304c\u6d41\u308c\u3066\u3001\u96fb\u8a71\u304c\u5207\u308c\u307e\u3059\u3002\n\n\n7. Twilio\u306e\u30ed\u30b0\u78ba\u8a8d\n\n\u30ed\u30b0\u30a4\u30f3: http://twilio.kddi-web.com\n\n\u753b\u9762: https://jp.twilio.com/user/account/log/calls\n\n\u9332\u97f3\u30c7\u30fc\u30bf\u304c\u5b58\u5728\u3059\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n\n\n\n\u5b8c\u4e86\n\nTwilio\u3067\u30e1\u30c3\u30bb\u30fc\u30b8\u9332\u97f3\u30b7\u30b9\u30c6\u30e0\u3092\u69cb\u7bc9\u3057\u3066\u307f\u307e\u3059\u3002\n\n\u97f3\u58f0\u30e1\u30cb\u30e5\u30fc\u306b\u5f93\u3063\u3066\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u9332\u97f3\u3057\u307e\u3059\u3002\n\n\n# \u524d\u63d0\u6761\u4ef6\n\n## \u516c\u958b\u30b5\u30fc\u30d0\u74b0\u5883\n\n* (\u53c2\u8003) Amazon Linux\u74b0\u5883\u306e\u69cb\u7bc9\n   * \u30ad\u30fc\u30da\u30a2\u306e\u4f5c\u6210 (\u65b0\u898f): http://qiita.com/tcsh/items/59303d9506ca7d13f744\n   * \u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u4f5c\u6210 (Public): http://qiita.com/tcsh/items/ae8f1f0d706237327c5a\n\n\n## Web\u30b5\u30fc\u30d0 + PHP\u74b0\u5883\n\n* PHP (5.4\u4ee5\u4e0a\u3092\u60f3\u5b9a)\n* Twilio PHP SDK\n\n(\u53c2\u8003) Twilio\u3067\u756a\u53f7\u5165\u529b\u3092\u53d7\u3051\u4ed8\u3051\u3066\u307f\u308b (AmazonLinux + nginx + php-fpm): \n\n\n\n## Twilio\u306e\u30a2\u30ab\u30a6\u30f3\u30c8\n\n* Twilio\u306e\u30a2\u30ab\u30a6\u30f3\u30c8\u3092\u4fdd\u6709\u3057\u3066\u3044\u308b\u3053\u3068\u3002\n  * Twilio\u306e\u96fb\u8a71\u756a\u53f7\n  * Twilio\u306e\u8a8d\u8a3c\u60c5\u5831 (ACCOUNT SID / AUTH TOKEN)\n\n\n\n# 0. \u4e8b\u524d\u6e96\u5099\n\n## 0.1. Twilio\u30a2\u30ab\u30a6\u30f3\u30c8\u60c5\u5831\u306e\u8a2d\u5b9a\n\nTwilio\u306e\u300c\u306f\u3058\u3081\u3088\u3046\u300d\u753b\u9762\u304b\u3089\u4ee5\u4e0b\u306e\u60c5\u5831\u3092\u53d6\u5f97\u3057\u3066\u5909\u6570\u306b\u683c\u7d0d\u3057\u307e\u3059\u3002\n\n* ACCOUNT SID\n\n* AUTH TOKEN\n\n* \u96fb\u8a71\u756a\u53f7\n\n```bash:\u5909\u6570\u306e\u8a2d\u5b9a:\nTWILIO_ACCOUNT_SID='ACxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx'\nTWILIO_AUTH_TOKEN='xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx'\nTEL_TWILIO_ORIGIN=<Twilio\u3067\u53d6\u5f97\u3057\u305f\u96fb\u8a71\u756a\u53f7>\n```\n\n## 0.2. \u30d5\u30a1\u30a4\u30eb\u7f6e\u304d\u5834\u306e\u4f5c\u6210\n\n```bash:\u5909\u6570\u306e\u8a2d\u5b9a\nDIR_HTML='/usr/share/nginx/html'\nDIR_TWIML=\"${DIR_HTML}/sysadm/xml\"\nDIR_PHP_SCRIPT=\"${DIR_HTML}/php\"\nURL_PHP_SCRIPT=$(echo ${DIR_PHP_SCRIPT} | sed \"s|${DIR_HTML}||\" )\n```\n\n```bash:\u30b3\u30de\u30f3\u30c9:\nsudo mkdir -p ${DIR_TWIML} ${DIR_PHP_SCRIPT} \\\n  && ls ${DIR_TWIML} ${DIR_PHP_SCRIPT}\n```\n\n\n\n# 1. \u30e1\u30c3\u30bb\u30fc\u30b8\u9332\u97f3\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u4f5c\u6210\n\n## 1.1. \u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306e\u4f5c\u6210\n\n```bash:\u5909\u6570\u306e\u8a2d\u5b9a:\nDIR_TWILIO_APP=\"${HOME}/app/twilio-record-app\" \\\n  && echo ${DIR_TWILIO_APP}\nAPP_NAME=$(echo ${DIR_TWILIO_APP} | sed 's|^.*/||') \\\n  && echo ${APP_NAME}\n```\n\n```bash:\u30b3\u30de\u30f3\u30c9\nmkdir -p ${DIR_TWILIO_APP} \\\n  && cd ${DIR_TWILIO_APP}\n```\n\n\n\n## 1.2. composer\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n```bash:\u30b3\u30de\u30f3\u30c9:\ncd ${DIR_TWILIO_APP} \\\n        && mkdir bin \\\n        && curl -sS https://getcomposer.org/installer | \\\n          php -- --install-dir=bin --filename=composer\n```\n\n```text:\u7d50\u679c(\u4f8b):\n      #!/usr/bin/env php\n      All settings correct for using Composer\n      Downloading...\n\n      Composer successfully installed to: /Users/taro/app/twilio-php/composer.phar\n      Use it: php bin/composer\n```\n\n\n## 1.3. Twilio PHP SDK\u306e\u5c0e\u5165\n\n\u53c2\u8003: https://jp.twilio.com/docs/php/install\n\n\n```bash:\u30b3\u30de\u30f3\u30c9:\ncd ${DIR_TWILIO_APP} \\\n        && ./bin/composer require twilio/sdk\n```\n\n```text:\u7d50\u679c(\u4f8b):\n      Using version ^4.2 for twilio/sdk\n      ./composer.json has been created\n      Loading composer repositories with package information\n      Updating dependencies (including require-dev)\n        - Installing twilio/sdk (4.2.1)\n          Downloading: 100%\n\n      Writing lock file\n      Generating autoload files\n```\n\n```bash:\u30b3\u30de\u30f3\u30c9\nls ${DIR_TWILIO_APP}/vendor/twilio/sdk/Services/Twilio.php > /dev/null 2>&1 \\\n  && echo $?\n```\n\n```text:\u7d50\u679c(\u4f8b:\n0\n```\n\nTwilio PHP\u30e9\u30a4\u30d6\u30e9\u30ea\u30d5\u30a1\u30a4\u30eb\u306e\u4f4d\u7f6e\u3092\u5909\u6570\u306b\u53d6\u308a\u8fbc\u307f\u307e\u3059\u3002\n\n```bash:\u5909\u6570\u306e\u8a2d\u5b9a:\nFILE_LIB_TWILIO=\"vendor/twilio/sdk/Services/Twilio.php\" \\\n  && ls ${FILE_LIB_TWILIO} > /dev/null 2>&1 \\\n  && echo $?\n```\n\n```text:\u7d50\u679c(\u4f8b):\n0\n```\n\n\n## 1.4. Twilio\u3067\u9332\u97f3\u53d7\u4ed8\u3092\u3059\u308b\u30b9\u30af\u30ea\u30d7\u30c8\u306e\u4f5c\u6210\n\n```bash:\u5909\u6570\u306e\u8a2d\u5b9a:\nFILE_PHP_SCRIPT='announce-record.php'\n```\n\n```bash:\u5909\u6570\u306e\u78ba\u8a8d\"\ncat << ETX\n\n  FILE_PHP_SCRIPT:    ${FILE_PHP_SCRIPT}\n\nETX\n```\n\n```bash:\u30b3\u30de\u30f3\u30c9:\ncat << EOF > ${FILE_PHP_SCRIPT}\n<?php\necho \"<?xml version=\\\"1.0\\\" encoding=\\\"UTF-8\\\"?>\\n\";\n?>\n<Response>\n<?php echo \"<Say language=\\\"ja-jp\\\">\u304a\u5ba2\u3055\u307e\u306f\u3001\" . \\$_REQUEST['Digits'] . \"\u3092\u62bc\u3055\u308c\u307e\u3057\u305f\u3002</Say>\" ?>\n<?php if (\\$_REQUEST['Digits'] == '1') { ?>\n    <Say language=\"ja-jp\">\u30d3\u30fc\u30d7\u304a\u3093\u306e\u3042\u3068\u306b\u300120\u79d2\u4ee5\u5185\u3067\u3001\u3054\u5951\u7d04\u306b\u3064\u3044\u3066\u306e\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u304a\u306d\u304c\u3044\u3057\u307e\u3059\u3002\u7d42\u4e86\u3057\u305f\u3089\u3001\u30b7\u30e3\u30fc\u30d7\u30dc\u30bf\u30f3\u3092\u62bc\u3057\u3066\u304f\u3060\u3055\u3044\u3002</Say>\n    <Record\n        method=\"GET\"\n        maxLength=\"20\"\n        finishOnKey=\"#\"\n        action=\"${URL_PHP_SCRIPT}/${APP_NAME}/thankyou.php\"\n    />\n    <Say language=\"ja-jp\">\u9332\u97f3\u3067\u304d\u307e\u305b\u3093\u3067\u3057\u305f\u3002</Say>\n\n<?php } elseif (\\$_REQUEST['Digits'] == '2') { ?>\n    <Say language=\"ja-jp\">\u30d3\u30fc\u30d7\u304a\u3093\u306e\u3042\u3068\u306b\u300120\u79d2\u4ee5\u5185\u3067\u3001\u6599\u91d1\u306b\u3064\u3044\u3066\u306e\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u304a\u306d\u304c\u3044\u3057\u307e\u3059\u3002\u7d42\u4e86\u3057\u305f\u3089\u3001\u30b7\u30e3\u30fc\u30d7\u30dc\u30bf\u30f3\u3092\u62bc\u3057\u3066\u304f\u3060\u3055\u3044\u3002</Say>\n    <Record\n        method=\"GET\"\n        maxLength=\"20\"\n        finishOnKey=\"#\"\n        action=\"${URL_PHP_SCRIPT}/${APP_NAME}/thankyou.php\"\n    />\n    <Say language=\"ja-jp\">\u308d\u304f\u304a\u3093\u3067\u304d\u307e\u305b\u3093\u3067\u3057\u305f\u3002</Say>\n\n<?php } else { ?>\n    <Say language=\"ja-jp\">\u3042\u308a\u304c\u3068\u3046\u3054\u3056\u3044\u307e\u3057\u305f\u3002</Say>\n<?php } ?>\n</Response>\nEOF\n\ncat ${FILE_PHP_SCRIPT}\n```\n\n\u52d5\u4f5c\u78ba\u8a8d\u3092\u3057\u307e\u3059\u3002\n\n```bash:\u30b3\u30de\u30f3\u30c9:\nphp ${FILE_PHP_SCRIPT} > announce-record.xml \\\n  && xmllint announce-record.xml --noout \\\n  && echo $? \\\n  && rm announce-record.xml\n```\n\n```text:\u7d50\u679c(\u4f8b)\nPHP Notice:  Undefined index: Digits in /home/ec2-user/app/twilio-record-app/thankyou.php on line 5\nPHP Notice:  Undefined index: Digits in /home/ec2-user/app/twilio-record-app/announce-record.php on line 6\nPHP Notice:  Undefined index: Digits in /home/ec2-user/app/twilio-record-app/announce-record.php on line 16\n0\n```\n\n\n## 1.5. \u9332\u97f3\u5b8c\u4e86\u5f8c\u306b\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u4f1d\u3048\u308b\u51e6\u7406\u3059\u308b\u30b9\u30af\u30ea\u30d7\u30c8\u306e\u4f5c\u6210\n\n```bash:\u5909\u6570\u306e\u8a2d\u5b9a\nFILE_PHP_SCRIPT='thankyou.php'\nMSG_THANKYOU='\u3054\u308c\u3093\u3089\u304f\u3001\u3042\u308a\u304c\u3068\u3046\u3054\u3056\u3044\u307e\u3057\u305f\u3002'\n```\n\n```bash:\u5909\u6570\u306e\u78ba\u8a8d\ncat << ETX\n\n  FILE_PHP_SCRIPT: ${FILE_PHP_SCRIPT}\n  MSG_THANKYOU: ${MSG_THANKYOU}\n\nETX\n```\n\n\n```bash:\u30b3\u30de\u30f3\u30c9(\u65e5\u672c\u8a9e\u306e\u5834\u5408):\ncat << EOF > ${FILE_PHP_SCRIPT}\n<?php\necho \"<?xml version=\\\"1.0\\\" encoding=\\\"UTF-8\\\"?>\\n\";\n?>\n<Response><Say language=\"ja-jp\">${MSG_THANKYOU}</Say></Response>\nEOF\n\ncat ${FILE_PHP_SCRIPT}\n```\n\n\u52d5\u4f5c\u78ba\u8a8d\u3092\u3057\u307e\u3059\u3002\n\n```bash:\u30b3\u30de\u30f3\u30c9:\nphp ${FILE_PHP_SCRIPT} > thankyou.xml \\\n  && xmllint thankyou.xml --noout \\\n  && echo $? \\\n  && rm thankyou.xml\n```\n\n```text:\u7d50\u679c(\u4f8b)\n0\n```\n\n\n\n\n# 2. Web\u30b5\u30fc\u30d0\u306e\u516c\u958b\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306b\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u914d\u7f6e\n\n```bash:\u30b3\u30de\u30f3\u30c9:\nsudo cp -R ${DIR_TWILIO_APP} ${DIR_PHP_SCRIPT}/ \\\n  && cat ${DIR_PHP_SCRIPT}/${APP_NAME}/${FILE_PHP_SCRIPT}\n```\n\n\n# 3. \u30b9\u30af\u30ea\u30d7\u30c8\u306e\u52d5\u4f5c\u78ba\u8a8d\n\n\u30d6\u30e9\u30a6\u30b6\u3067\u30a2\u30af\u30bb\u30b9\u3057\u3066\u307f\u307e\u3057\u3087\u3046\u3002\n\n- http://<\u30db\u30b9\u30c8>/php/twilio-record-app/announce-record.php\n- http://<\u30db\u30b9\u30c8>/php/twilio-record-app/thankyou.php\n\n'404 Not Found'\u304c\u8868\u793a\u3055\u308c\u306a\u3051\u308c\u3070OK\u3067\u3059\u3002\n\n\n\n# 4. TwiML\u30d5\u30a1\u30a4\u30eb\u306e\u4f5c\u6210\n\n## 4.1. TwiML\u30d5\u30a1\u30a4\u30eb\u306e\u4f5c\u6210\n\n```bash:\u5909\u6570\u306e\u8a2d\u5b9a\nFILE_TWIML=\"${APP_NAME}.xml\"\nMSG_SAY='\u3002\u3088\u3046\u3053\u305d\u3002\u3054\u3051\u3044\u3084\u304f\u306e\u578b\u306f\u30011\u756a\u3068\u30b7\u30e3\u30fc\u30d7\u3092\u3002\u6599\u91d1\u306e\u304a\u3068\u3044\u3042\u308f\u305b\u306f\u30012\u756a\u3068\u30b7\u30e3\u30fc\u30d7\u3092\u3002\u305d\u306e\u307b\u304b\u306e\u3054\u3088\u3046\u306e\u304b\u305f\u308f\u30019\u756a\u3068\u30b7\u30e3\u30fc\u30d7\u3092\u3001\u304a\u3057\u3066\u304f\u3060\u3055\u3044\u3002'\nMSG_ERROR=\"\u756a\u53f7\u304c\u308f\u304b\u308a\u307e\u305b\u3093\u3067\u3057\u305f\u3002\u3042\u308a\u304c\u3068\u3046\u3054\u3056\u3044\u307e\u3057\u305f\u3002\"\nMAX_LENGTH_RECORD='20'\n```\n\n```bash:\u5909\u6570\u306e\u78ba\u8a8d\ncat << ETX\n\n  FILE_TWIML:        ${FILE_TWIML}\n  MSG_SAY:           ${MSG_SAY}\n  MSG_ERROR:         ${MSG_ERROR}\n  MAX_LENGTH_RECORD: ${MAX_LENGTH_RECORD}\n\nETX\n```\n\n```bash:\u30b3\u30de\u30f3\u30c9(\u65e5\u672c\u8a9e\u7248):\ncat << EOF > ~/${FILE_TWIML}\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<Response>\n    <Gather action=\"${URL_PHP_SCRIPT}/${APP_NAME}/announce-record.php\"\nmethod=\"GET\">\n        <Say language=\"ja-jp\">${MSG_SAY}</Say>\n    </Gather>\n    <Say language=\"ja-jp\">${MSG_ERROR}</Say>\n</Response>\nEOF\n\ncat ~/${FILE_TWIML}\n```\n\n```bash:\u30b3\u30de\u30f3\u30c9:\nxmllint ~/${FILE_TWIML} -noout\n```\n\n## 4.2. Web\u30b5\u30fc\u30d0\u306e\u516c\u958b\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306bTwilioML\u30d5\u30a1\u30a4\u30eb\u3092\u914d\u7f6e\n\nTwilioML\u3092\u914d\u7f6e\u5834\u6240\u306f\u3001GET\u3067\u53d6\u5f97\u3067\u304d\u308b\u74b0\u5883\u3067\u3042\u308c\u3070\u826f\u3044\u306e\u3067S3\u4e0a\u3067\u3082\u304b\u307e\u3044\u307e\u305b\u3093\u304c\u3001\u4eca\u56de\u306f\u4e0a\u8a18\u306e\u516c\u958bWeb\u30b5\u30fc\u30d0\u4e0a\u306b\u914d\u7f6e\u3057\u307e\u3059\u3002\n\n```bash:\u30b3\u30de\u30f3\u30c9:\nsudo cp ~/${FILE_TWIML} ${DIR_TWIML}/ \\\n  && cat ${DIR_TWIML}/${FILE_TWIML}\n```\n\n\n\n## 4.3. TwilioML\u30d5\u30a1\u30a4\u30eb\u3078\u306e\u30a2\u30af\u30bb\u30b9\u78ba\u8a8d\n\n\u30d6\u30e9\u30a6\u30b6\u3067 http://<\u30db\u30b9\u30c8>/sysadm/xml/twilio-record-app.xml \u306b\u30a2\u30af\u30bb\u30b9\u3057\u3066\u3001XML\u304c\u8868\u793a\u3055\u308c\u308c\u3070OK\u3067\u3059\u3002\n\n\n\n# 5. Twilio\u306e\u8a2d\u5b9a\u5909\u66f4\n\n- \u30ed\u30b0\u30a4\u30f3: http://twilio.kddi-web.com\n- \u753b\u9762: 'Voice, SMS & MMS' > '\u96fb\u8a71\u756a\u53f7: 'https://jp.twilio.com/user/account/voice-sms-mms/phone-numbers\n   - \u96fb\u8a71\u756a\u53f7\u306e\u30ea\u30f3\u30af\u3092\u30af\u30ea\u30c3\u30af\u3057\u307e\u3059\u3002\n   - \u30dd\u30c3\u30d7\u30a2\u30c3\u30d7\u3067\u300c\u97f3\u58f0\u901a\u8a71\u300d\u30bf\u30d6\u3092\u9078\u629e\u3057\u307e\u3059\u3002\n   - Request URL\u306bTwiML(XML\u30d5\u30a1\u30a4\u30eb)\u306eURL\u3092\u8cbc\u308a\u4ed8\u3051\u307e\u3059\u3002\n      - \u4f8b: http://username:password@<\u30db\u30b9\u30c8\u540d>/sysadm/xml/twilio-record-app.xml\n      - username:password\u306b\u306f\u3001\u30d9\u30fc\u30b7\u30c3\u30af\u8a8d\u8a3c\u306e\u30e6\u30fc\u30b6\u540d(\u4f8b:sysadm)\u3068\u30d1\u30b9\u30ef\u30fc\u30c9(\u4f8b:#userPass123)\u3092\u8a18\u8ff0\u3057\u307e\u3059\u3002\n   - URL\u3092\u8cbc\u308a\u4ed8\u3051\u305f\u6b04\u306e\u53f3\u306e\u30d7\u30eb\u30c0\u30a6\u30f3\u304b\u3089'HTTP GET'\u3092\u9078\u629e\u3057\u307e\u3059\u3002\n\n![\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2015-10-10 9.07.33.png](https://qiita-image-store.s3.amazonaws.com/0/48158/256e0f27-d3d1-9e45-8498-2bbad919fa5e.png)\n\n- \u300c\u4fdd\u5b58\u300d\u30dc\u30bf\u30f3\u3092\u30af\u30ea\u30c3\u30af\u3057\u307e\u3059\u3002\n\n\n# 6. \u96fb\u8a71\u30a2\u30d7\u30ea\u306e\u52d5\u4f5c\u78ba\u8a8d\n\n- Twilio\u304b\u3089\u5272\u308a\u5f53\u3066\u3089\u308c\u305f\u96fb\u8a71\u756a\u53f7\u306b\u96fb\u8a71\u3057\u307e\u3059\u3002\n\n  - twilio-record-app.xml\u306b\u8a18\u8ff0\u3057\u305f\u30e1\u30c3\u30bb\u30fc\u30b8\u304c\u6d41\u308c\u307e\u3059\u3002\n\n- \u756a\u53f7\u3092\u5165\u529b\u3057\u307e\u3059\u3002\n- \u30a2\u30ca\u30a6\u30f3\u30b9\u306b\u5f93\u3063\u3066\u3001\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u9332\u97f3\u3057\u307e\u3059\u3002\n\n  - \u3057\u3070\u3089\u304f\u5f85\u3064\u3001\u3082\u3057\u304f\u306f#\u30ad\u30fc\u3092\u62bc\u3057\u307e\u3059\u3002\n\n- thankyou.php\u306b\u8a18\u8ff0\u3057\u305f\u30e1\u30c3\u30bb\u30fc\u30b8\u304c\u6d41\u308c\u3066\u3001\u96fb\u8a71\u304c\u5207\u308c\u307e\u3059\u3002\n\n\n\n# 7. Twilio\u306e\u30ed\u30b0\u78ba\u8a8d\n\n- \u30ed\u30b0\u30a4\u30f3: http://twilio.kddi-web.com\n- \u753b\u9762: https://jp.twilio.com/user/account/log/calls\n   - \u9332\u97f3\u30c7\u30fc\u30bf\u304c\u5b58\u5728\u3059\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n\n\n# \u5b8c\u4e86\n"}