{"context": " More than 1 year has passed since last update.\u3069\u3082\u3063\u3002ITBOZE\u3067\u30fc\u3059\u3002\nHaskell, Common-lisp\u306a\u3069\u3092\u30ab\u30b8\u308a\u3001\u6700\u8fd1\u306f\u3001Scala\u304c\u30de\u30a4\u30d6\u30fc\u30e0\u3067\u3059\u3002\n\u3068\u3053\u308d\u3067\u3001Capistrano\u3063\u3066\u30012.x\u7cfb\u30683.x\u7cfb\u306e\u60c5\u5831\u304cWeb\u4e0a\u3067\u5165\u308a\u6df7\u3058\u3063\u3066\u3066\u3001\u60c5\u5831\u306e\u6574\u7406\u306b\u3001\u73fe\u5728\u82e6\u52b4\u3057\u3066\u3044\u308b\u65b9\uff08\u307e\u305f\u306f\u3001\u904e\u53bb\u306b\u82e6\u52b4\u3057\u305f\u3088\u30fc\u3063\u3066\u65b9\uff09\u3001\u3044\u3089\u3063\u3057\u3083\u3044\u307e\u305b\u3093\u304b\uff1f\n\u81ea\u5206\u306f\u3001\u5f53\u521d\u3001\u56f0\u60d1\u3057\u307e\u3057\u305f\u3002\u3002\u3002\n\u305d\u3053\u3067\u3001\u3053\u308c\u304b\u3089Capi\u3063\u305f\u308b\u3067\u30fc\u3063\u3066\u65b9\u306e\u305f\u3081\u306b\u306a\u308c\u3070\u3068\u3001\u624b\u9806\u3092\u307e\u3068\u3081\u3066\u307f\u307e\u3057\u305f\u3002\n\n1. Gem\u306e\u8ffd\u52a0\n\n\nGemfile \u306b\u6b21\u306eGem\u3092\u8ffd\u52a0\n\n# \u3053\u308c\u3092\u4f7f\u7528\u3057\u306a\u3044\u3068\u3001\u30c7\u30d7\u30ed\u30a4\u6642\u306b\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3059\u308b\ngem 'therubyracer',  platforms: :ruby\n\n# cron\u3092\u4f7f\u3046\u5834\u5408\u306e\u307f\ngem 'whenever', require: false\n\ngroup :deployment, :test do\n  gem 'capistrano', '~> 3.2.1'\n  gem 'capistrano-rails'\n  gem 'capistrano-rbenv'\n  gem 'capistrano-bundler'\n  gem 'capistrano3-unicorn' # unicorn\u3092\u4f7f\u3063\u3066\u3044\u308b\u5834\u5408\u306e\u307f\nend\n\ngem 'unicorn'\n\n\nbundle install\u3092\u5b9f\u884c\n\n$ bundle install\n\n\n2. Capistrano\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092\u751f\u6210\n$ cap install\n\n\n\u4ee5\u4e0b\u306e\u30d5\u30a1\u30a4\u30eb\u304c\u4f5c\u3089\u308c\u308b\u3002\n\nmkdir -p config/deploy\ncreate config/deploy.rb\ncreate config/deploy/staging.rb\ncreate config/deploy/production.rb\nmkdir -p lib/capistrano/tasks\nCapifie\n\n\n3. Capfile\u306e\u8a2d\u5b9a\n\n\nCapfile \u3092\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u5909\u66f4\n\n# [\u5fc5\u9808] Capistrano\u306e\u8a2d\u5b9a\u3092\u8aad\u307f\u8fbc\u3080\u3002\u304a\u307e\u3058\u306a\u3044\nrequire 'capistrano/setup'\n\n# [\u5fc5\u9808] \u30c7\u30d7\u30ed\u30a4\u30d5\u30ec\u30fc\u30e0\u30ef\u30fc\u30af\u3092\u8aad\u307f\u8fbc\u307f\u3002\nrequire 'capistrano/deploy'\n\n# rbenv\u3092\u4f7f\u7528\u3057\u3066\u3044\u308b\u5834\u5408\nrequire 'capistrano/rbenv'\n\nrequire 'capistrano/rails'\nrequire 'capistrano/rails/assets'\nrequire 'capistrano/rails/migrations'\n\nrequire 'capistrano/bundler'\nrequire 'capistrano3/unicorn' # unicorn\u3092\u4f7f\u3063\u3066\u3044\u308b\u5834\u5408\u306e\u307f\nrequire 'whenever/capistrano' # whenever\u3092\u4f7f\u3063\u3066\u3044\u308b\u5834\u5408\u306e\u307f\n\n\n# [\u5fc5\u9808] `lib/capistrano/tasks' \u306b\u5b9a\u7fa9\u3055\u308c\u305f\u30bf\u30b9\u30af\u3092\u8aad\u307f\u8fbc\u3080\nDir.glob('lib/capistrano/tasks/*.rake').each { |r| import r }\n\n\n4. Capistrano \u5171\u901a\u306e\u30c7\u30d7\u30ed\u30a4\u8a2d\u5b9a\n\n\u5171\u901a\u306e\u30c7\u30d7\u30ed\u30a4\u60c5\u5831\u3092 config/deploy.rb \u306b\u8a18\u5165\n\n# config valid only for Capistrano 3.1\nlock '3.2.1'\n\n# \u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u540d\nset :application, 'first_app'\n# github\u306eurl\u3002\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u306egit\u30db\u30b9\u30c6\u30a3\u30f3\u30b0\u5148\u3092\u6307\u5b9a\u3059\u308b\nset :repo_url, 'git@github.com:YOUR_ACCOUNT/your_app.git'\n\n# Default branch is :master\n# deploy\u6642\u306b\u30d6\u30e9\u30f3\u30c1\u3092\u9078\u629e\u3057\u305f\u3044\u5834\u5408\u306f\u3001\u4ee5\u4e0b\u306e\u30b3\u30e1\u30f3\u30c8\u90e8\u5206\u3092\u5916\u3059\n# ask :branch, proc { `git rev-parse --abbrev-ref HEAD`.chomp }.call\n\n# \u30c7\u30d7\u30ed\u30a4\u5148\u306e\u30b5\u30fc\u30d0\u30fc\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3002\u30d5\u30eb\u30d1\u30b9\u3067\u6307\u5b9a\nset :deploy_to, '/path/to/dir/your_app'\n# Version\u7ba1\u7406\u306fgit\nset :scm, :git\n\n# \u30ed\u30b0\u3092\u8a73\u3057\u304f\u8868\u793a\nset :format, :pretty\nset :log_level, :debug\n\n# sudo \u306b\u5fc5\u8981\nset :pty, true\n\n# \u4f55\u4e16\u4ee3\u524d\u307e\u3067\u30ea\u30ea\u30fc\u30b9\u3092\u6b8b\u3057\u3066\u304a\u304f\u304b\nset :keep_releases, 5\n\n#rbenv\u3092\u30b7\u30b9\u30c6\u30e0\u306b\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u305f\u304b? or \u30e6\u30fc\u30b6\u30fc\u30ed\u30fc\u30ab\u30eb\u306b\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u305f\u304b?\nset :rbenv_type, :user # :system or :user\n# ruby\u306eversion\nset :rbenv_ruby, '2.1.4'\nset :rbenv_prefix, \"RBENV_ROOT=#{fetch(:rbenv_path)} RBENV_VERSION=#{fetch(:rbenv_ruby)} #{fetch(:rbenv_path)}/bin/rbenv exec\"\nset :rbenv_map_bins, %w{rake gem bundle ruby rails}\nset :rbenv_roles, :all # default value\n\n# \u30c7\u30d7\u30ed\u30a4\u5148\u306e\u30b5\u30fc\u30d0\u30fc\u306e :deploy_to/shared/config/database.yml \u306e\u30b7\u30f3\u30dc\u30ea\u30c3\u30af\u30ea\u30f3\u30af\u3092\n# :deploy_to/current/config/database.yml \u306b\u306f\u308b\u3002\n# \u305f\u3060\u3001\u6ce8\u610f\u3059\u3079\u304d\u306f\u3001\u5148\u306bshared\u4ee5\u4e0b\u306b\u30d5\u30a1\u30a4\u30eb\u3092\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u3053\u3068\n# \u4e0a\u8a18\u306e\u30d5\u30a1\u30a4\u30eb\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u51e6\u7406\u306f\u3001\u4e0b\u8a18\u306e\u300cupload\u300d\u30bf\u30b9\u30af\u3067\u884c\u3046\nset :linked_files, %w{config/database.yml}\n\n# \u540c\u3058\u304fshared\u306b\u4e0a\u8a18\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u751f\u6210\u3057\u3001current\u306b\u30b7\u30f3\u30dc\u30ea\u30c3\u30af\u30ea\u30f3\u30af\u3092\u5f35\u308b\nset :linked_dirs, %w{bin log tmp/backup tmp/pids tmp/cache tmp/sockets vendor/bundle}\n\n# bundle install\u306e\u4e26\u5217\u5b9f\u884c\u6570\nset :bundle_jobs, 4\n\n\nnamespace :deploy do\n\n  # \u4e0a\u8a18linked_files\u3067\u4f7f\u7528\u3059\u308b\u30d5\u30a1\u30a4\u30eb\u3092\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u3059\u308b\u30bf\u30b9\u30af\n  desc 'Upload database.yml'\n  task :upload do\n    on roles(:app) do |host|\n      if test \"[ ! -d #{shared_path}/config ]\"\n        execute \"mkdir -p #{shared_path}/config\"\n      end\n      upload!('config/database.yml', \"#{shared_path}/config/database.yml\")\n    end\n  end\n\n  desc 'Restart application'\n  task :restart do\n    on roles(:app) do\n      invoke 'unicorn:restart'\n    end\n  end\nend\n\n# linked_files\u3067\u4f7f\u7528\u3059\u308b\u30d5\u30a1\u30a4\u30eb\u3092\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u3059\u308b\u30bf\u30b9\u30af\u306f\u3001deploy\u304c\u884c\u308f\u308c\u308b\u524d\u306b\u5b9f\u884c\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\nbefore 'deploy:starting', 'deploy:upload'\n# Capistrano 3.1.0 \u304b\u3089\u30c7\u30d5\u30a9\u30eb\u30c8\u3067 deploy:restart \u30bf\u30b9\u30af\u304c\u547c\u3070\u308c\u306a\u304f\u306a\u3063\u305f\u306e\u3067\u3001\u3053\u3053\u306b\u4ee5\u4e0b\u306e1\u884c\u3092\u66f8\u304f\u5fc5\u8981\u304c\u3042\u308b\nafter 'deploy:publishing', 'deploy:restart'\n\n\n5. \u74b0\u5883\u5225\u306e\u30c7\u30d7\u30ed\u30a4\u8a2d\u5b9a\n\n\u74b0\u5883\u3054\u3068\u306b\u7570\u306a\u308b\u8a2d\u5b9a\u3092 config/deploy/staging.rb(production.rb) \u306b\u8a18\u8ff0\n\nset :stage, :staging\nset :rails_env, \"staging\"\nset :unicorn_rack_env, \"staging\"\n\n# \u3053\u306e\u8a2d\u5b9a\u304c\u306a\u3044\u3068\u3001\u30c7\u30d7\u30ed\u30a4\u5148\u3067db:migrate\u3055\u308c\u306a\u3044\nset :migration_role, 'db'\n\nrole :app, %w{USER_NAME@IP_ADDRESS}\nrole :web, %w{USER_NAME@IP_ADDRESS}\nrole :db,  %w{USER_NAME@IP_ADDRESS}, :primary => true\n#role :db,  %w{USER_NAME@IP_ADDRESS}\n\nserver 'IP_ADDRESS', user: 'USER_NAME', roles: %w{web app db}\n\nset :ssh_options, {\n    keys: [File.expand_path('/key/path/to/')],\n    forward_agent: true,\n    auth_methods: %w(password),\n    password: 'password'\n}\n\n\n6. Unicorn\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\n\nweb\u4e0a\u306b\u306f\u3001lib/capistrano/task \u306e\u76f4\u4e0b\u306b\u3001unicorn.rb\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3057\u3001unicorn\u306e\u8d77\u52d5\u3084\u505c\u6b62\u30b3\u30de\u30f3\u30c9\u3092\u66f8\u304f\u3082\u306e\u3082\u3042\u308b\u3002\n\u3057\u304b\u3057\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092\u8a18\u8f09\u3059\u308b\u65b9\u6cd5\u304c\u6700\u8fd1\u306e\u30c8\u30ec\u30f3\u30c9\u306e\u3088\u3046\u3067\u3059\u3002\nconfig\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306e\u76f4\u4e0b\u306b\u3001unicorn.rb\u3092\u4f5c\u6210\u3057\u3066\u3044\u305f\u5834\u5408\u306f\u3001\u524a\u9664\n\n$ cd config\n$ rm unicorn.rb\n\n\n\u74b0\u5883\u3054\u3068\u306e\u8a2d\u5b9a\u3092\u683c\u7d0d\u3059\u308b\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u4f5c\u6210\n\n$ cd config\n$ mkdir unicorn\n$ cd unicorn\n\n\n\u4ee5\u4e0b\u306e\u5185\u5bb9\u3092\u3001config/unicorn/staging.rb(production.rb) \u306b\u8a18\u8ff0\n\napp_path = '/path/to/dir/your_app'\n\nworker_processes 2\nworking_directory \"#{app_path}\" + \"/current\"\n\n# This loads the application in the master process before forking\n# worker processes\n# Read more about it here:\n# http://unicorn.bogomips.org/Unicorn/Configurator.html\npreload_app true\n\ntimeout 30\n\n# This is where we specify the socket.\n# We will point the upstream Nginx module to this socket later on\n#listen \"#{app_path}/tmp/sockets/unicorn.sock\", :backlog => 64\nlisten \"/tmp/unicorn.sock\", :backlog => 64\n\n#pid \"/tmp/unicorn.pid\"\npid \"#{app_path}/shared/tmp/pids/unicorn.pid\"\n\n# Set the path of the log files inside the log folder of the testapp\nstderr_path \"#{app_path}/current/log/unicorn.stderr.log\"\nstdout_path \"#{app_path}/current/log/unicorn.stdout.log\"\n\nbefore_fork do |server, worker|\n  ENV['BUNDLE_GEMFILE'] = File.expand_path('Gemfile', ENV['RAILS_ROOT'])\nend\n\nbefore_fork do |server, worker|\n  defined?(ActiveRecord::Base) and ActiveRecord::Base.connection.disconnect!\n\n  old_pid = \"#{server.config[:pid]}.oldbin\"\n  if old_pid != server.pid\n    begin\n      sig = (worker.nr + 1) >= server.worker_processes ? :QUIT : :TTOU\n      Process.kill(sig, File.read(old_pid).to_i)\n    rescue Errno::ENOENT, Errno::ESRCH\n    end\n  end\n\n  sleep 1\nend\n\nafter_fork do |server, worker|\n  defined?(ActiveRecord::Base) and ActiveRecord::Base.establish_connection\nend\n\n\n7. \u30c7\u30d7\u30ed\u30a4\u524d\u306e\u30c1\u30a7\u30c3\u30af\u30ea\u30b9\u30c8\u30fb\u6e96\u5099\n\n\nCapistrano\u306e\u4ee5\u4e0b\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u306b\u3064\u3044\u3066\u3001\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u3059\u3079\u3066\u8a2d\u5b9a\u3057\u305f\u304b\uff1f\n\nconfig/deploy.rb\nconfig/deploy/staging.rb\n\nconfig/deploy/production.rb \n\n\nconfig/environments/(staging.rb)production.rb \u306e config.assets.compile \u5024\u3092 true \u306b\u3057\u305f\u304b?\n\nconfig/environments/(staging.rb)production.rb \u306econfig.serve_static_assets\u306e\u5024\u3092true\u306b\u3057\u305f\u304b?\n\n\u3053\u308c\u3092true\u306b\u3057\u3066\u3044\u306a\u3044\u3068\u3001\u300cActionController::RoutingError\u300d\u304c\u767a\u751f\u3057\u3001\u753b\u9762\u304c\u8868\u793a\u3055\u308c\u306a\u3044\u5834\u5408\u304c\u3042\u308b\u3002\n\n\n\nUnicorn\u306e\u4ee5\u4e0b\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092\u6e96\u5099\u3057\u305f\u304b\uff1f\n\nconfig/unicorn/staging.rb\nconfig/unicorn/production.rb\n\n\n\u30b9\u30c6\u30fc\u30b8\u30f3\u30b0DB\u3001\u672c\u756aDB\u306e\u8a2d\u5b9a\u3092\u3001config/database.yml \u306b\u8ffd\u52a0\u3057\u3066\u3044\u308b\u304b\uff1f\n\n\u30b9\u30c6\u30fc\u30b8\u30f3\u30b0\u3001\u672c\u756a\u7528\u306e\u30b7\u30fc\u30af\u30ec\u30c3\u30c8\u30ad\u30fc\u306e\u8a2d\u5b9a\u3092 config/secret.yml \u306b\u8ffd\u52a0\u3057\u3066\u3044\u308b\u304b\uff1f\n\n\u8a2d\u5b9a\u3057\u3066\u3044\u306a\u3044\u3068\u3001\u753b\u9762\u304c\u771f\u3063\u767d\u306b\u306a\u308a\u307e\u3059\u3002\n\n\n\u30b7\u30fc\u30af\u30ec\u30c3\u30c8\u30ad\u30fc\u306e\u751f\u6210\u30b3\u30de\u30f3\u30c9\u306f \n$ bundle exec rake secret\n\n\n\n\n\u30c7\u30d7\u30ed\u30a4\u7528Git\u30ea\u30dd\u30b8\u30c8\u30ea\u306e\u30d6\u30e9\u30f3\u30c1\u304c\u6700\u65b0\u306e\u72b6\u614b\u304b\uff1f\n\n\n8. \u4e0a\u306e\u30c1\u30a7\u30c3\u30af\u304c\u5b8c\u4e86\u3057\u305f\u3089\u3001cap\u30b3\u30de\u30f3\u30c9\u3067\u8a2d\u5b9a\u3092\u78ba\u8a8d\u3002\n\n\u30d5\u30a9\u30eb\u30c0\u306e\u751f\u6210\u7b49\u3082\u884c\u3063\u3066\u304f\u308c\u307e\u3059\u3002\n\n# staging\u306e\u30c1\u30a7\u30c3\u30af\n$ cap staging deploy:check\n\n# production\u306e\u30c1\u30a7\u30c3\u30af\n$ cap production deploy:check\n\n\n9. \u30c7\u30d7\u30ed\u30a4\u3092\u5b9f\u884c\n# staging\u3078\u306e\u30c7\u30d7\u30ed\u30a4\n$ cap staging deploy\n\n# production\u3078\u306e\u30c7\u30d7\u30ed\u30a4\n$ cap production deploy\n\n\n10. \u4ee5\u4e0b\u306e\u30a8\u30e9\u30fc\u304c\u5410\u304b\u308c\u3066\u3057\u307e\u3046\u5834\u5408\u306e\u5bfe\u51e6\n\n\u30c7\u30d7\u30ed\u30a4\u5148\u306e\u30b5\u30fc\u30d0\u30fc\u3067\u3001\u4ee5\u4e0b\u306e\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\n\n$ yum install postgresql-devel\n\n\n\u30a8\u30e9\u30fc\u5185\u5bb9\n\nDEBUG [52c45f3f]    [31mAn error occurred while installing pg (0.18.1), and Bundler cannot continue.\nDEBUG [52c45f3f]    Make sure that `gem install pg -v '0.18.1'` succeeds before bundling.[0m\ncap aborted!\nSSHKit::Runner::ExecuteError: Exception while executing as root@192.168.33.12: bundle exit status: 5\nbundle stdout: An error occurred while installing pg (0.18.1), and Bundler cannot continue.\nMake sure that `gem install pg -v '0.18.1'` succeeds before bundling.\nbundle stderr: Nothing written\n\nSSHKit::Command::Failed: bundle exit status: 5\nbundle stdout: An error occurred while installing pg (0.18.1), and Bundler cannot continue.\nMake sure that `gem install pg -v '0.18.1'` succeeds before bundling.\nbundle stderr: Nothing written\n\nTasks: TOP => deploy:updated => bundler:install\n(See full trace by running task with --trace)\nThe deploy has failed with an error: #<SSHKit::Runner::ExecuteError: Exception while executing as root@192.168.33.12: bundle exit status: 5\nbundle stdout: An error occurred while installing pg (0.18.1), and Bundler cannot continue.\nMake sure that `gem install pg -v '0.18.1'` succeeds before bundling.\nbundle stderr: Nothing written\n\n\u3044\u304b\u304c\u3067\u3057\u305f\u304b\uff1f\u53c2\u8003\u306b\u306a\u308c\u3070\u5e78\u3044\u3067\u3059\u3002\n\n\u203bITBOZE\u306b\u3088\u308bIT\u6280\u8853\u306e\u5099\u5fd8\u9332\u30d6\u30ed\u30b0\n\u574a\u4e3b\u304c\u4e0a\u624b\u306bHatena\u306b\u574a\u4e3b\u306e\u30b3\u30fc\u30c9\u3092\u66f8\u3044\u305f\n\u3082\u3088\u308d\u3057\u304f\u306d!\n\n\u3069\u3082\u3063\u3002ITBOZE\u3067\u30fc\u3059\u3002\nHaskell, Common-lisp\u306a\u3069\u3092\u30ab\u30b8\u308a\u3001\u6700\u8fd1\u306f\u3001Scala\u304c\u30de\u30a4\u30d6\u30fc\u30e0\u3067\u3059\u3002\n\n\u3068\u3053\u308d\u3067\u3001Capistrano\u3063\u3066\u30012.x\u7cfb\u30683.x\u7cfb\u306e\u60c5\u5831\u304cWeb\u4e0a\u3067\u5165\u308a\u6df7\u3058\u3063\u3066\u3066\u3001\u60c5\u5831\u306e\u6574\u7406\u306b\u3001\u73fe\u5728\u82e6\u52b4\u3057\u3066\u3044\u308b\u65b9\uff08\u307e\u305f\u306f\u3001\u904e\u53bb\u306b\u82e6\u52b4\u3057\u305f\u3088\u30fc\u3063\u3066\u65b9\uff09\u3001\u3044\u3089\u3063\u3057\u3083\u3044\u307e\u305b\u3093\u304b\uff1f\n\u81ea\u5206\u306f\u3001\u5f53\u521d\u3001\u56f0\u60d1\u3057\u307e\u3057\u305f\u3002\u3002\u3002\n\n\u305d\u3053\u3067\u3001\u3053\u308c\u304b\u3089Capi\u3063\u305f\u308b\u3067\u30fc\u3063\u3066\u65b9\u306e\u305f\u3081\u306b\u306a\u308c\u3070\u3068\u3001\u624b\u9806\u3092\u307e\u3068\u3081\u3066\u307f\u307e\u3057\u305f\u3002\n\n\n### 1. Gem\u306e\u8ffd\u52a0\n\n* `Gemfile` \u306b\u6b21\u306eGem\u3092\u8ffd\u52a0\n\n``` rb\n# \u3053\u308c\u3092\u4f7f\u7528\u3057\u306a\u3044\u3068\u3001\u30c7\u30d7\u30ed\u30a4\u6642\u306b\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3059\u308b\ngem 'therubyracer',  platforms: :ruby\n\n# cron\u3092\u4f7f\u3046\u5834\u5408\u306e\u307f\ngem 'whenever', require: false\n\ngroup :deployment, :test do\n  gem 'capistrano', '~> 3.2.1'\n  gem 'capistrano-rails'\n  gem 'capistrano-rbenv'\n  gem 'capistrano-bundler'\n  gem 'capistrano3-unicorn' # unicorn\u3092\u4f7f\u3063\u3066\u3044\u308b\u5834\u5408\u306e\u307f\nend\n\ngem 'unicorn'\n```\n\n* bundle install\u3092\u5b9f\u884c\n\n```\n$ bundle install\n```\n\n\n### 2. Capistrano\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092\u751f\u6210\n\n```\n$ cap install\n```\n\n* \u4ee5\u4e0b\u306e\u30d5\u30a1\u30a4\u30eb\u304c\u4f5c\u3089\u308c\u308b\u3002\n\n```\nmkdir -p config/deploy\ncreate config/deploy.rb\ncreate config/deploy/staging.rb\ncreate config/deploy/production.rb\nmkdir -p lib/capistrano/tasks\nCapifie\n```\n\n### 3. Capfile\u306e\u8a2d\u5b9a\n\n* `Capfile` \u3092\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u5909\u66f4\n\n``` rb\n# [\u5fc5\u9808] Capistrano\u306e\u8a2d\u5b9a\u3092\u8aad\u307f\u8fbc\u3080\u3002\u304a\u307e\u3058\u306a\u3044\nrequire 'capistrano/setup'\n\n# [\u5fc5\u9808] \u30c7\u30d7\u30ed\u30a4\u30d5\u30ec\u30fc\u30e0\u30ef\u30fc\u30af\u3092\u8aad\u307f\u8fbc\u307f\u3002\nrequire 'capistrano/deploy'\n\n# rbenv\u3092\u4f7f\u7528\u3057\u3066\u3044\u308b\u5834\u5408\nrequire 'capistrano/rbenv'\n\nrequire 'capistrano/rails'\nrequire 'capistrano/rails/assets'\nrequire 'capistrano/rails/migrations'\n\nrequire 'capistrano/bundler'\nrequire 'capistrano3/unicorn' # unicorn\u3092\u4f7f\u3063\u3066\u3044\u308b\u5834\u5408\u306e\u307f\nrequire 'whenever/capistrano' # whenever\u3092\u4f7f\u3063\u3066\u3044\u308b\u5834\u5408\u306e\u307f\n\n\n# [\u5fc5\u9808] `lib/capistrano/tasks' \u306b\u5b9a\u7fa9\u3055\u308c\u305f\u30bf\u30b9\u30af\u3092\u8aad\u307f\u8fbc\u3080\nDir.glob('lib/capistrano/tasks/*.rake').each { |r| import r }\n```\n\n### 4. Capistrano \u5171\u901a\u306e\u30c7\u30d7\u30ed\u30a4\u8a2d\u5b9a\n\n* \u5171\u901a\u306e\u30c7\u30d7\u30ed\u30a4\u60c5\u5831\u3092 `config/deploy.rb` \u306b\u8a18\u5165\n\n```\n# config valid only for Capistrano 3.1\nlock '3.2.1'\n\n# \u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u540d\nset :application, 'first_app'\n# github\u306eurl\u3002\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u306egit\u30db\u30b9\u30c6\u30a3\u30f3\u30b0\u5148\u3092\u6307\u5b9a\u3059\u308b\nset :repo_url, 'git@github.com:YOUR_ACCOUNT/your_app.git'\n\n# Default branch is :master\n# deploy\u6642\u306b\u30d6\u30e9\u30f3\u30c1\u3092\u9078\u629e\u3057\u305f\u3044\u5834\u5408\u306f\u3001\u4ee5\u4e0b\u306e\u30b3\u30e1\u30f3\u30c8\u90e8\u5206\u3092\u5916\u3059\n# ask :branch, proc { `git rev-parse --abbrev-ref HEAD`.chomp }.call\n\n# \u30c7\u30d7\u30ed\u30a4\u5148\u306e\u30b5\u30fc\u30d0\u30fc\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3002\u30d5\u30eb\u30d1\u30b9\u3067\u6307\u5b9a\nset :deploy_to, '/path/to/dir/your_app'\n# Version\u7ba1\u7406\u306fgit\nset :scm, :git\n\n# \u30ed\u30b0\u3092\u8a73\u3057\u304f\u8868\u793a\nset :format, :pretty\nset :log_level, :debug\n\n# sudo \u306b\u5fc5\u8981\nset :pty, true\n\n# \u4f55\u4e16\u4ee3\u524d\u307e\u3067\u30ea\u30ea\u30fc\u30b9\u3092\u6b8b\u3057\u3066\u304a\u304f\u304b\nset :keep_releases, 5\n\n#rbenv\u3092\u30b7\u30b9\u30c6\u30e0\u306b\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u305f\u304b? or \u30e6\u30fc\u30b6\u30fc\u30ed\u30fc\u30ab\u30eb\u306b\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u305f\u304b?\nset :rbenv_type, :user # :system or :user\n# ruby\u306eversion\nset :rbenv_ruby, '2.1.4'\nset :rbenv_prefix, \"RBENV_ROOT=#{fetch(:rbenv_path)} RBENV_VERSION=#{fetch(:rbenv_ruby)} #{fetch(:rbenv_path)}/bin/rbenv exec\"\nset :rbenv_map_bins, %w{rake gem bundle ruby rails}\nset :rbenv_roles, :all # default value\n\n# \u30c7\u30d7\u30ed\u30a4\u5148\u306e\u30b5\u30fc\u30d0\u30fc\u306e :deploy_to/shared/config/database.yml \u306e\u30b7\u30f3\u30dc\u30ea\u30c3\u30af\u30ea\u30f3\u30af\u3092\n# :deploy_to/current/config/database.yml \u306b\u306f\u308b\u3002\n# \u305f\u3060\u3001\u6ce8\u610f\u3059\u3079\u304d\u306f\u3001\u5148\u306bshared\u4ee5\u4e0b\u306b\u30d5\u30a1\u30a4\u30eb\u3092\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u3053\u3068\n# \u4e0a\u8a18\u306e\u30d5\u30a1\u30a4\u30eb\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u51e6\u7406\u306f\u3001\u4e0b\u8a18\u306e\u300cupload\u300d\u30bf\u30b9\u30af\u3067\u884c\u3046\nset :linked_files, %w{config/database.yml}\n\n# \u540c\u3058\u304fshared\u306b\u4e0a\u8a18\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u751f\u6210\u3057\u3001current\u306b\u30b7\u30f3\u30dc\u30ea\u30c3\u30af\u30ea\u30f3\u30af\u3092\u5f35\u308b\nset :linked_dirs, %w{bin log tmp/backup tmp/pids tmp/cache tmp/sockets vendor/bundle}\n\n# bundle install\u306e\u4e26\u5217\u5b9f\u884c\u6570\nset :bundle_jobs, 4\n\n\nnamespace :deploy do\n\n  # \u4e0a\u8a18linked_files\u3067\u4f7f\u7528\u3059\u308b\u30d5\u30a1\u30a4\u30eb\u3092\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u3059\u308b\u30bf\u30b9\u30af\n  desc 'Upload database.yml'\n  task :upload do\n    on roles(:app) do |host|\n      if test \"[ ! -d #{shared_path}/config ]\"\n        execute \"mkdir -p #{shared_path}/config\"\n      end\n      upload!('config/database.yml', \"#{shared_path}/config/database.yml\")\n    end\n  end\n\n  desc 'Restart application'\n  task :restart do\n    on roles(:app) do\n      invoke 'unicorn:restart'\n    end\n  end\nend\n\n# linked_files\u3067\u4f7f\u7528\u3059\u308b\u30d5\u30a1\u30a4\u30eb\u3092\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u3059\u308b\u30bf\u30b9\u30af\u306f\u3001deploy\u304c\u884c\u308f\u308c\u308b\u524d\u306b\u5b9f\u884c\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\nbefore 'deploy:starting', 'deploy:upload'\n# Capistrano 3.1.0 \u304b\u3089\u30c7\u30d5\u30a9\u30eb\u30c8\u3067 deploy:restart \u30bf\u30b9\u30af\u304c\u547c\u3070\u308c\u306a\u304f\u306a\u3063\u305f\u306e\u3067\u3001\u3053\u3053\u306b\u4ee5\u4e0b\u306e1\u884c\u3092\u66f8\u304f\u5fc5\u8981\u304c\u3042\u308b\nafter 'deploy:publishing', 'deploy:restart'\n```\n\n\n### 5. \u74b0\u5883\u5225\u306e\u30c7\u30d7\u30ed\u30a4\u8a2d\u5b9a\n\n* \u74b0\u5883\u3054\u3068\u306b\u7570\u306a\u308b\u8a2d\u5b9a\u3092 `config/deploy/staging.rb(production.rb)` \u306b\u8a18\u8ff0\n\n```\nset :stage, :staging\nset :rails_env, \"staging\"\nset :unicorn_rack_env, \"staging\"\n\n# \u3053\u306e\u8a2d\u5b9a\u304c\u306a\u3044\u3068\u3001\u30c7\u30d7\u30ed\u30a4\u5148\u3067db:migrate\u3055\u308c\u306a\u3044\nset :migration_role, 'db'\n\nrole :app, %w{USER_NAME@IP_ADDRESS}\nrole :web, %w{USER_NAME@IP_ADDRESS}\nrole :db,  %w{USER_NAME@IP_ADDRESS}, :primary => true\n#role :db,  %w{USER_NAME@IP_ADDRESS}\n\nserver 'IP_ADDRESS', user: 'USER_NAME', roles: %w{web app db}\n\nset :ssh_options, {\n    keys: [File.expand_path('/key/path/to/')],\n    forward_agent: true,\n    auth_methods: %w(password),\n    password: 'password'\n}\n```\n\n### 6. Unicorn\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\n\n* web\u4e0a\u306b\u306f\u3001`lib/capistrano/task` \u306e\u76f4\u4e0b\u306b\u3001`unicorn.rb`\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3057\u3001unicorn\u306e\u8d77\u52d5\u3084\u505c\u6b62\u30b3\u30de\u30f3\u30c9\u3092\u66f8\u304f\u3082\u306e\u3082\u3042\u308b\u3002  \n\u3057\u304b\u3057\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092\u8a18\u8f09\u3059\u308b\u65b9\u6cd5\u304c\u6700\u8fd1\u306e\u30c8\u30ec\u30f3\u30c9\u306e\u3088\u3046\u3067\u3059\u3002\n\n* config\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306e\u76f4\u4e0b\u306b\u3001unicorn.rb\u3092\u4f5c\u6210\u3057\u3066\u3044\u305f\u5834\u5408\u306f\u3001\u524a\u9664\n\n```\n$ cd config\n$ rm unicorn.rb\n```\n\n* \u74b0\u5883\u3054\u3068\u306e\u8a2d\u5b9a\u3092\u683c\u7d0d\u3059\u308b\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u4f5c\u6210\n\n```\n$ cd config\n$ mkdir unicorn\n$ cd unicorn\n```\n\n* \u4ee5\u4e0b\u306e\u5185\u5bb9\u3092\u3001`config/unicorn/staging.rb(production.rb)` \u306b\u8a18\u8ff0\n\n```\napp_path = '/path/to/dir/your_app'\n\nworker_processes 2\nworking_directory \"#{app_path}\" + \"/current\"\n\n# This loads the application in the master process before forking\n# worker processes\n# Read more about it here:\n# http://unicorn.bogomips.org/Unicorn/Configurator.html\npreload_app true\n\ntimeout 30\n\n# This is where we specify the socket.\n# We will point the upstream Nginx module to this socket later on\n#listen \"#{app_path}/tmp/sockets/unicorn.sock\", :backlog => 64\nlisten \"/tmp/unicorn.sock\", :backlog => 64\n\n#pid \"/tmp/unicorn.pid\"\npid \"#{app_path}/shared/tmp/pids/unicorn.pid\"\n\n# Set the path of the log files inside the log folder of the testapp\nstderr_path \"#{app_path}/current/log/unicorn.stderr.log\"\nstdout_path \"#{app_path}/current/log/unicorn.stdout.log\"\n\nbefore_fork do |server, worker|\n  ENV['BUNDLE_GEMFILE'] = File.expand_path('Gemfile', ENV['RAILS_ROOT'])\nend\n\nbefore_fork do |server, worker|\n  defined?(ActiveRecord::Base) and ActiveRecord::Base.connection.disconnect!\n\n  old_pid = \"#{server.config[:pid]}.oldbin\"\n  if old_pid != server.pid\n    begin\n      sig = (worker.nr + 1) >= server.worker_processes ? :QUIT : :TTOU\n      Process.kill(sig, File.read(old_pid).to_i)\n    rescue Errno::ENOENT, Errno::ESRCH\n    end\n  end\n\n  sleep 1\nend\n\nafter_fork do |server, worker|\n  defined?(ActiveRecord::Base) and ActiveRecord::Base.establish_connection\nend\n```\n\n### 7. \u30c7\u30d7\u30ed\u30a4\u524d\u306e\u30c1\u30a7\u30c3\u30af\u30ea\u30b9\u30c8\u30fb\u6e96\u5099\n\n1. Capistrano\u306e\u4ee5\u4e0b\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u306b\u3064\u3044\u3066\u3001\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u3059\u3079\u3066\u8a2d\u5b9a\u3057\u305f\u304b\uff1f\n\t* `config/deploy.rb`\n\t* `config/deploy/staging.rb`\n\t* `config/deploy/production.rb` \n\n2. `config/environments/(staging.rb)production.rb` \u306e `config.assets.compile` \u5024\u3092 `true` \u306b\u3057\u305f\u304b?\n\n3. `config/environments/(staging.rb)production.rb` \u306e`config.serve_static_assets`\u306e\u5024\u3092`true`\u306b\u3057\u305f\u304b?\n\t* \u3053\u308c\u3092`true`\u306b\u3057\u3066\u3044\u306a\u3044\u3068\u3001\u300c**ActionController::RoutingError**\u300d\u304c\u767a\u751f\u3057\u3001\u753b\u9762\u304c\u8868\u793a\u3055\u308c\u306a\u3044\u5834\u5408\u304c\u3042\u308b\u3002\n\n3. Unicorn\u306e\u4ee5\u4e0b\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092\u6e96\u5099\u3057\u305f\u304b\uff1f\n\t* `config/unicorn/staging.rb`\n\t* `config/unicorn/production.rb `\n\n4. \u30b9\u30c6\u30fc\u30b8\u30f3\u30b0DB\u3001\u672c\u756aDB\u306e\u8a2d\u5b9a\u3092\u3001`config/database.yml` \u306b\u8ffd\u52a0\u3057\u3066\u3044\u308b\u304b\uff1f\n5. \u30b9\u30c6\u30fc\u30b8\u30f3\u30b0\u3001\u672c\u756a\u7528\u306e\u30b7\u30fc\u30af\u30ec\u30c3\u30c8\u30ad\u30fc\u306e\u8a2d\u5b9a\u3092 `config/secret.yml` \u306b\u8ffd\u52a0\u3057\u3066\u3044\u308b\u304b\uff1f\n\t* \u8a2d\u5b9a\u3057\u3066\u3044\u306a\u3044\u3068\u3001\u753b\u9762\u304c\u771f\u3063\u767d\u306b\u306a\u308a\u307e\u3059\u3002  \n\t* \u30b7\u30fc\u30af\u30ec\u30c3\u30c8\u30ad\u30fc\u306e\u751f\u6210\u30b3\u30de\u30f3\u30c9\u306f \n\t\n\t\t```\n\t$ bundle exec rake secret\n\t\t``` \n6. \u30c7\u30d7\u30ed\u30a4\u7528Git\u30ea\u30dd\u30b8\u30c8\u30ea\u306e\u30d6\u30e9\u30f3\u30c1\u304c\u6700\u65b0\u306e\u72b6\u614b\u304b\uff1f\n\n### 8. \u4e0a\u306e\u30c1\u30a7\u30c3\u30af\u304c\u5b8c\u4e86\u3057\u305f\u3089\u3001cap\u30b3\u30de\u30f3\u30c9\u3067\u8a2d\u5b9a\u3092\u78ba\u8a8d\u3002\n\n* \u30d5\u30a9\u30eb\u30c0\u306e\u751f\u6210\u7b49\u3082\u884c\u3063\u3066\u304f\u308c\u307e\u3059\u3002\n\n```\n# staging\u306e\u30c1\u30a7\u30c3\u30af\n$ cap staging deploy:check\n\n# production\u306e\u30c1\u30a7\u30c3\u30af\n$ cap production deploy:check\n```\n\n### 9. \u30c7\u30d7\u30ed\u30a4\u3092\u5b9f\u884c\n\n```\n# staging\u3078\u306e\u30c7\u30d7\u30ed\u30a4\n$ cap staging deploy\n\n# production\u3078\u306e\u30c7\u30d7\u30ed\u30a4\n$ cap production deploy\n```\n\n### 10. \u4ee5\u4e0b\u306e\u30a8\u30e9\u30fc\u304c\u5410\u304b\u308c\u3066\u3057\u307e\u3046\u5834\u5408\u306e\u5bfe\u51e6\n\n* \u30c7\u30d7\u30ed\u30a4\u5148\u306e\u30b5\u30fc\u30d0\u30fc\u3067\u3001\u4ee5\u4e0b\u306e\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\n\n```\n$ yum install postgresql-devel\n```\n\n* \u30a8\u30e9\u30fc\u5185\u5bb9\n\n```\nDEBUG [52c45f3f] \t[31mAn error occurred while installing pg (0.18.1), and Bundler cannot continue.\nDEBUG [52c45f3f] \tMake sure that `gem install pg -v '0.18.1'` succeeds before bundling.[0m\ncap aborted!\nSSHKit::Runner::ExecuteError: Exception while executing as root@192.168.33.12: bundle exit status: 5\nbundle stdout: An error occurred while installing pg (0.18.1), and Bundler cannot continue.\nMake sure that `gem install pg -v '0.18.1'` succeeds before bundling.\nbundle stderr: Nothing written\n\nSSHKit::Command::Failed: bundle exit status: 5\nbundle stdout: An error occurred while installing pg (0.18.1), and Bundler cannot continue.\nMake sure that `gem install pg -v '0.18.1'` succeeds before bundling.\nbundle stderr: Nothing written\n\nTasks: TOP => deploy:updated => bundler:install\n(See full trace by running task with --trace)\nThe deploy has failed with an error: #<SSHKit::Runner::ExecuteError: Exception while executing as root@192.168.33.12: bundle exit status: 5\nbundle stdout: An error occurred while installing pg (0.18.1), and Bundler cannot continue.\nMake sure that `gem install pg -v '0.18.1'` succeeds before bundling.\nbundle stderr: Nothing written\n```\n\n\u3044\u304b\u304c\u3067\u3057\u305f\u304b\uff1f\u53c2\u8003\u306b\u306a\u308c\u3070\u5e78\u3044\u3067\u3059\u3002\n\n> \u203bITBOZE\u306b\u3088\u308bIT\u6280\u8853\u306e\u5099\u5fd8\u9332\u30d6\u30ed\u30b0\n> [\u574a\u4e3b\u304c\u4e0a\u624b\u306bHatena\u306b\u574a\u4e3b\u306e\u30b3\u30fc\u30c9\u3092\u66f8\u3044\u305f](http://itboze.hatenablog.com/)\n> \u3082\u3088\u308d\u3057\u304f\u306d!\n", "tags": ["capistrano3", "capistrano"]}