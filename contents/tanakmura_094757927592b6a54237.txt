{"context": " More than 1 year has passed since last update.512bit \u5185\u306e 128bit \u306b\u542b\u307e\u308c\u308b8bit\u502416\u500b\u3092\u307e\u305c\u307e\u305c\u3057\u307e\u3059\u3002x86\u306e\u4f1d\u7d71\u306b\u5f93\u3044\u3001128bit \u5883\u754c\u306f\u8d85\u3048\u3089\u308c\u307e\u305b\u3093\u3002\nGCC 4.9 \u3067\u306f _mm512_shuffle_epi8 \u304c\u7121\u304b\u3063\u305f\u306e\u3067 asm \u66f8\u304d\u307e\u3057\u305f\u3002\ntrunk \u306b\u306f\u3042\u308b\u306e\u3067\u30015.0\u3067\u306f\u4f7f\u3048\u308b\u3068\u4e88\u60f3\u3055\u308c\u307e\u3059\u3002\nhttps://github.com/gcc-mirror/gcc/blob/master/gcc/config/i386/avx512bwintrin.h#L1598\n#include <immintrin.h>\n#include <stdio.h>\n\nunsigned char in[64];\nunsigned char table[64];\nunsigned char out[64];\n\nstatic void\ntest(int idx)\n{\n    for (int i=0; i<64; i++) {\n        in[i] = 100+i;\n        table[i] = idx;\n    }\n\n    __m512i vtable = _mm512_loadu_si512(table);\n    __m512i vin = _mm512_loadu_si512(in);\n\n    __m512i v;\n\n    __asm__ __volatile__(\"vpshufb %[src1], %[src2], %[dest]\\n\\t\"\n                         :[dest]\"=v\"(v)\n                         :[src1]\"v\"(vtable),\n                          [src2]\"v\"(vin));\n\n    _mm512_storeu_si512(out, v);\n\n    for (int i=0; i<64; i++) {\n        printf(\"idx=%2d,out[%d]=%d\\n\",\n               idx, i, out[i]);\n    }\n}\n\nint\nmain()\n{\n    test(0);\n\n    test(17);\n\n    test(8);\n}\n\n $ ./sde -- ./a.out\nidx= 0,out[0]=100\nidx= 0,out[1]=100\nidx= 0,out[2]=100\nidx= 0,out[3]=100\nidx= 0,out[4]=100\nidx= 0,out[5]=100\nidx= 0,out[6]=100\nidx= 0,out[7]=100\nidx= 0,out[8]=100\nidx= 0,out[9]=100\nidx= 0,out[10]=100\nidx= 0,out[11]=100\nidx= 0,out[12]=100\nidx= 0,out[13]=100\nidx= 0,out[14]=100\nidx= 0,out[15]=100\nidx= 0,out[16]=116\nidx= 0,out[17]=116\nidx= 0,out[18]=116\nidx= 0,out[19]=116\nidx= 0,out[20]=116\nidx= 0,out[21]=116\nidx= 0,out[22]=116\nidx= 0,out[23]=116\nidx= 0,out[24]=116\nidx= 0,out[25]=116\nidx= 0,out[26]=116\nidx= 0,out[27]=116\nidx= 0,out[28]=116\nidx= 0,out[29]=116\nidx= 0,out[30]=116\nidx= 0,out[31]=116\nidx= 0,out[32]=132\nidx= 0,out[33]=132\nidx= 0,out[34]=132\nidx= 0,out[35]=132\nidx= 0,out[36]=132\nidx= 0,out[37]=132\nidx= 0,out[38]=132\nidx= 0,out[39]=132\nidx= 0,out[40]=132\nidx= 0,out[41]=132\nidx= 0,out[42]=132\nidx= 0,out[43]=132\nidx= 0,out[44]=132\nidx= 0,out[45]=132\nidx= 0,out[46]=132\nidx= 0,out[47]=132\nidx= 0,out[48]=148\nidx= 0,out[49]=148\nidx= 0,out[50]=148\nidx= 0,out[51]=148\nidx= 0,out[52]=148\nidx= 0,out[53]=148\nidx= 0,out[54]=148\nidx= 0,out[55]=148\nidx= 0,out[56]=148\nidx= 0,out[57]=148\nidx= 0,out[58]=148\nidx= 0,out[59]=148\nidx= 0,out[60]=148\nidx= 0,out[61]=148\nidx= 0,out[62]=148\nidx= 0,out[63]=148\nidx=17,out[0]=101\nidx=17,out[1]=101\nidx=17,out[2]=101\nidx=17,out[3]=101\nidx=17,out[4]=101\nidx=17,out[5]=101\nidx=17,out[6]=101\nidx=17,out[7]=101\nidx=17,out[8]=101\nidx=17,out[9]=101\nidx=17,out[10]=101\nidx=17,out[11]=101\nidx=17,out[12]=101\nidx=17,out[13]=101\nidx=17,out[14]=101\nidx=17,out[15]=101\nidx=17,out[16]=117\nidx=17,out[17]=117\nidx=17,out[18]=117\nidx=17,out[19]=117\nidx=17,out[20]=117\nidx=17,out[21]=117\nidx=17,out[22]=117\nidx=17,out[23]=117\nidx=17,out[24]=117\nidx=17,out[25]=117\nidx=17,out[26]=117\nidx=17,out[27]=117\nidx=17,out[28]=117\nidx=17,out[29]=117\nidx=17,out[30]=117\nidx=17,out[31]=117\nidx=17,out[32]=133\nidx=17,out[33]=133\nidx=17,out[34]=133\nidx=17,out[35]=133\nidx=17,out[36]=133\nidx=17,out[37]=133\nidx=17,out[38]=133\nidx=17,out[39]=133\nidx=17,out[40]=133\nidx=17,out[41]=133\nidx=17,out[42]=133\nidx=17,out[43]=133\nidx=17,out[44]=133\nidx=17,out[45]=133\nidx=17,out[46]=133\nidx=17,out[47]=133\nidx=17,out[48]=149\nidx=17,out[49]=149\nidx=17,out[50]=149\nidx=17,out[51]=149\nidx=17,out[52]=149\nidx=17,out[53]=149\nidx=17,out[54]=149\nidx=17,out[55]=149\nidx=17,out[56]=149\nidx=17,out[57]=149\nidx=17,out[58]=149\nidx=17,out[59]=149\nidx=17,out[60]=149\nidx=17,out[61]=149\nidx=17,out[62]=149\nidx=17,out[63]=149\nidx= 8,out[0]=108\nidx= 8,out[1]=108\nidx= 8,out[2]=108\nidx= 8,out[3]=108\nidx= 8,out[4]=108\nidx= 8,out[5]=108\nidx= 8,out[6]=108\nidx= 8,out[7]=108\nidx= 8,out[8]=108\nidx= 8,out[9]=108\nidx= 8,out[10]=108\nidx= 8,out[11]=108\nidx= 8,out[12]=108\nidx= 8,out[13]=108\nidx= 8,out[14]=108\nidx= 8,out[15]=108\nidx= 8,out[16]=124\nidx= 8,out[17]=124\nidx= 8,out[18]=124\nidx= 8,out[19]=124\nidx= 8,out[20]=124\nidx= 8,out[21]=124\nidx= 8,out[22]=124\nidx= 8,out[23]=124\nidx= 8,out[24]=124\nidx= 8,out[25]=124\nidx= 8,out[26]=124\nidx= 8,out[27]=124\nidx= 8,out[28]=124\nidx= 8,out[29]=124\nidx= 8,out[30]=124\nidx= 8,out[31]=124\nidx= 8,out[32]=140\nidx= 8,out[33]=140\nidx= 8,out[34]=140\nidx= 8,out[35]=140\nidx= 8,out[36]=140\nidx= 8,out[37]=140\nidx= 8,out[38]=140\nidx= 8,out[39]=140\nidx= 8,out[40]=140\nidx= 8,out[41]=140\nidx= 8,out[42]=140\nidx= 8,out[43]=140\nidx= 8,out[44]=140\nidx= 8,out[45]=140\nidx= 8,out[46]=140\nidx= 8,out[47]=140\nidx= 8,out[48]=156\nidx= 8,out[49]=156\nidx= 8,out[50]=156\nidx= 8,out[51]=156\nidx= 8,out[52]=156\nidx= 8,out[53]=156\nidx= 8,out[54]=156\nidx= 8,out[55]=156\nidx= 8,out[56]=156\nidx= 8,out[57]=156\nidx= 8,out[58]=156\nidx= 8,out[59]=156\nidx= 8,out[60]=156\nidx= 8,out[61]=156\nidx= 8,out[62]=156\nidx= 8,out[63]=156\n\nhttps://software.intel.com/sites/landingpage/IntrinsicsGuide/ \u306b\u66f8\u3044\u3066\u3042\u308b\u7591\u4f3c\u30b3\u30fc\u30c9\u3068\u6319\u52d5\u5408\u308f\u306a\u3044\u6c17\u304c\u2026\uff1f\nFOR j := 0 to 63\n    i := j*8\n    IF b[i+7] == 1\n        dst[i+7:i] := 0\n    ELSE\n        index[3:0] := b[i+3:i]\n        dst[i+7:i] := a[index*8+7:index*8]\n    FI\nENDFOR dst[MAX:512] := 0\n\nhttps://software.intel.com/en-us/intel-isa-extensions \u306b\u66f8\u3044\u3066\u3042\u308b\u7591\u4f3c\u30b3\u30fc\u30c9\u306f\u2026\u610f\u5473\u304c\u3088\u304f\u308f\u304b\u3089\u306a\u304b\u3063\u305f\u3002\n\u305d\u308c\u306f\u3068\u3082\u304b\u304f\u3001GCC 4.9\u3067\u306f\u5bfe\u5fdc\u3055\u308c\u3066\u306a\u3044\u7406\u7531\u304c\u3001\u3053\u308c\u304cAVX512BW\u3068\u3044\u3046\u5f8c\u304b\u3089\u767a\u8868\u3055\u308c\u305f\u5225\u306e\u62e1\u5f35\u306b\u306a\u3063\u3066\u3044\u308b\u304b\u3089\u3067\u3059\u306d\u3002\n\u306a\u304a\u3001\u3053\u306eAVX512BW\u62e1\u5f35\u306fKNL(XeonPhi) \u3067\u306f\u4f7f\u3048\u307e\u305b\u3093\u3002\n $ ./sde -knl -- ./a.out \nTID 0 SDE-ERROR: Executed instruction not valid for specified chip (KNL): 0x4005e5: vpshufb zmm0, zmm1, zmm0\nImage: /home/w0/test/avx512/a.out+0x5e5\nFunction: test\nInstruction bytes are: 62 f2 75 48 00 c0 \n\n\u4e16\u754c\u306f\u60b2\u3057\u307f\u306e\u708e\u306b\u5305\u307e\u308c\u305f\u3002\n\u660e\u65e5\u306f @tanakmura \u304c vshufps \u306b\u3064\u3044\u3066\u66f8\u304d\u307e\u3059\u3002\n512bit \u5185\u306e 128bit \u306b\u542b\u307e\u308c\u308b8bit\u502416\u500b\u3092\u307e\u305c\u307e\u305c\u3057\u307e\u3059\u3002x86\u306e\u4f1d\u7d71\u306b\u5f93\u3044\u3001128bit \u5883\u754c\u306f\u8d85\u3048\u3089\u308c\u307e\u305b\u3093\u3002\n\nGCC 4.9 \u3067\u306f _mm512_shuffle_epi8 \u304c\u7121\u304b\u3063\u305f\u306e\u3067 asm \u66f8\u304d\u307e\u3057\u305f\u3002\n\ntrunk \u306b\u306f\u3042\u308b\u306e\u3067\u30015.0\u3067\u306f\u4f7f\u3048\u308b\u3068\u4e88\u60f3\u3055\u308c\u307e\u3059\u3002\nhttps://github.com/gcc-mirror/gcc/blob/master/gcc/config/i386/avx512bwintrin.h#L1598\n\n\n```cpp\n#include <immintrin.h>\n#include <stdio.h>\n\nunsigned char in[64];\nunsigned char table[64];\nunsigned char out[64];\n\nstatic void\ntest(int idx)\n{\n    for (int i=0; i<64; i++) {\n        in[i] = 100+i;\n        table[i] = idx;\n    }\n\n    __m512i vtable = _mm512_loadu_si512(table);\n    __m512i vin = _mm512_loadu_si512(in);\n\n    __m512i v;\n\n    __asm__ __volatile__(\"vpshufb %[src1], %[src2], %[dest]\\n\\t\"\n                         :[dest]\"=v\"(v)\n                         :[src1]\"v\"(vtable),\n                          [src2]\"v\"(vin));\n\n    _mm512_storeu_si512(out, v);\n\n    for (int i=0; i<64; i++) {\n        printf(\"idx=%2d,out[%d]=%d\\n\",\n               idx, i, out[i]);\n    }\n}\n\nint\nmain()\n{\n    test(0);\n\n    test(17);\n\n    test(8);\n}\n```\n\n\n```\n $ ./sde -- ./a.out\nidx= 0,out[0]=100\nidx= 0,out[1]=100\nidx= 0,out[2]=100\nidx= 0,out[3]=100\nidx= 0,out[4]=100\nidx= 0,out[5]=100\nidx= 0,out[6]=100\nidx= 0,out[7]=100\nidx= 0,out[8]=100\nidx= 0,out[9]=100\nidx= 0,out[10]=100\nidx= 0,out[11]=100\nidx= 0,out[12]=100\nidx= 0,out[13]=100\nidx= 0,out[14]=100\nidx= 0,out[15]=100\nidx= 0,out[16]=116\nidx= 0,out[17]=116\nidx= 0,out[18]=116\nidx= 0,out[19]=116\nidx= 0,out[20]=116\nidx= 0,out[21]=116\nidx= 0,out[22]=116\nidx= 0,out[23]=116\nidx= 0,out[24]=116\nidx= 0,out[25]=116\nidx= 0,out[26]=116\nidx= 0,out[27]=116\nidx= 0,out[28]=116\nidx= 0,out[29]=116\nidx= 0,out[30]=116\nidx= 0,out[31]=116\nidx= 0,out[32]=132\nidx= 0,out[33]=132\nidx= 0,out[34]=132\nidx= 0,out[35]=132\nidx= 0,out[36]=132\nidx= 0,out[37]=132\nidx= 0,out[38]=132\nidx= 0,out[39]=132\nidx= 0,out[40]=132\nidx= 0,out[41]=132\nidx= 0,out[42]=132\nidx= 0,out[43]=132\nidx= 0,out[44]=132\nidx= 0,out[45]=132\nidx= 0,out[46]=132\nidx= 0,out[47]=132\nidx= 0,out[48]=148\nidx= 0,out[49]=148\nidx= 0,out[50]=148\nidx= 0,out[51]=148\nidx= 0,out[52]=148\nidx= 0,out[53]=148\nidx= 0,out[54]=148\nidx= 0,out[55]=148\nidx= 0,out[56]=148\nidx= 0,out[57]=148\nidx= 0,out[58]=148\nidx= 0,out[59]=148\nidx= 0,out[60]=148\nidx= 0,out[61]=148\nidx= 0,out[62]=148\nidx= 0,out[63]=148\nidx=17,out[0]=101\nidx=17,out[1]=101\nidx=17,out[2]=101\nidx=17,out[3]=101\nidx=17,out[4]=101\nidx=17,out[5]=101\nidx=17,out[6]=101\nidx=17,out[7]=101\nidx=17,out[8]=101\nidx=17,out[9]=101\nidx=17,out[10]=101\nidx=17,out[11]=101\nidx=17,out[12]=101\nidx=17,out[13]=101\nidx=17,out[14]=101\nidx=17,out[15]=101\nidx=17,out[16]=117\nidx=17,out[17]=117\nidx=17,out[18]=117\nidx=17,out[19]=117\nidx=17,out[20]=117\nidx=17,out[21]=117\nidx=17,out[22]=117\nidx=17,out[23]=117\nidx=17,out[24]=117\nidx=17,out[25]=117\nidx=17,out[26]=117\nidx=17,out[27]=117\nidx=17,out[28]=117\nidx=17,out[29]=117\nidx=17,out[30]=117\nidx=17,out[31]=117\nidx=17,out[32]=133\nidx=17,out[33]=133\nidx=17,out[34]=133\nidx=17,out[35]=133\nidx=17,out[36]=133\nidx=17,out[37]=133\nidx=17,out[38]=133\nidx=17,out[39]=133\nidx=17,out[40]=133\nidx=17,out[41]=133\nidx=17,out[42]=133\nidx=17,out[43]=133\nidx=17,out[44]=133\nidx=17,out[45]=133\nidx=17,out[46]=133\nidx=17,out[47]=133\nidx=17,out[48]=149\nidx=17,out[49]=149\nidx=17,out[50]=149\nidx=17,out[51]=149\nidx=17,out[52]=149\nidx=17,out[53]=149\nidx=17,out[54]=149\nidx=17,out[55]=149\nidx=17,out[56]=149\nidx=17,out[57]=149\nidx=17,out[58]=149\nidx=17,out[59]=149\nidx=17,out[60]=149\nidx=17,out[61]=149\nidx=17,out[62]=149\nidx=17,out[63]=149\nidx= 8,out[0]=108\nidx= 8,out[1]=108\nidx= 8,out[2]=108\nidx= 8,out[3]=108\nidx= 8,out[4]=108\nidx= 8,out[5]=108\nidx= 8,out[6]=108\nidx= 8,out[7]=108\nidx= 8,out[8]=108\nidx= 8,out[9]=108\nidx= 8,out[10]=108\nidx= 8,out[11]=108\nidx= 8,out[12]=108\nidx= 8,out[13]=108\nidx= 8,out[14]=108\nidx= 8,out[15]=108\nidx= 8,out[16]=124\nidx= 8,out[17]=124\nidx= 8,out[18]=124\nidx= 8,out[19]=124\nidx= 8,out[20]=124\nidx= 8,out[21]=124\nidx= 8,out[22]=124\nidx= 8,out[23]=124\nidx= 8,out[24]=124\nidx= 8,out[25]=124\nidx= 8,out[26]=124\nidx= 8,out[27]=124\nidx= 8,out[28]=124\nidx= 8,out[29]=124\nidx= 8,out[30]=124\nidx= 8,out[31]=124\nidx= 8,out[32]=140\nidx= 8,out[33]=140\nidx= 8,out[34]=140\nidx= 8,out[35]=140\nidx= 8,out[36]=140\nidx= 8,out[37]=140\nidx= 8,out[38]=140\nidx= 8,out[39]=140\nidx= 8,out[40]=140\nidx= 8,out[41]=140\nidx= 8,out[42]=140\nidx= 8,out[43]=140\nidx= 8,out[44]=140\nidx= 8,out[45]=140\nidx= 8,out[46]=140\nidx= 8,out[47]=140\nidx= 8,out[48]=156\nidx= 8,out[49]=156\nidx= 8,out[50]=156\nidx= 8,out[51]=156\nidx= 8,out[52]=156\nidx= 8,out[53]=156\nidx= 8,out[54]=156\nidx= 8,out[55]=156\nidx= 8,out[56]=156\nidx= 8,out[57]=156\nidx= 8,out[58]=156\nidx= 8,out[59]=156\nidx= 8,out[60]=156\nidx= 8,out[61]=156\nidx= 8,out[62]=156\nidx= 8,out[63]=156\n```\n\nhttps://software.intel.com/sites/landingpage/IntrinsicsGuide/ \u306b\u66f8\u3044\u3066\u3042\u308b\u7591\u4f3c\u30b3\u30fc\u30c9\u3068\u6319\u52d5\u5408\u308f\u306a\u3044\u6c17\u304c\u2026\uff1f\n\n```\nFOR j := 0 to 63\n    i := j*8\n    IF b[i+7] == 1\n        dst[i+7:i] := 0\n    ELSE\n        index[3:0] := b[i+3:i]\n        dst[i+7:i] := a[index*8+7:index*8]\n    FI\nENDFOR dst[MAX:512] := 0\n```\n\nhttps://software.intel.com/en-us/intel-isa-extensions \u306b\u66f8\u3044\u3066\u3042\u308b\u7591\u4f3c\u30b3\u30fc\u30c9\u306f\u2026\u610f\u5473\u304c\u3088\u304f\u308f\u304b\u3089\u306a\u304b\u3063\u305f\u3002\n\n\n\n\u305d\u308c\u306f\u3068\u3082\u304b\u304f\u3001GCC 4.9\u3067\u306f\u5bfe\u5fdc\u3055\u308c\u3066\u306a\u3044\u7406\u7531\u304c\u3001\u3053\u308c\u304cAVX512BW\u3068\u3044\u3046\u5f8c\u304b\u3089\u767a\u8868\u3055\u308c\u305f\u5225\u306e\u62e1\u5f35\u306b\u306a\u3063\u3066\u3044\u308b\u304b\u3089\u3067\u3059\u306d\u3002\n\n\u306a\u304a\u3001\u3053\u306eAVX512BW\u62e1\u5f35\u306fKNL(XeonPhi) \u3067\u306f\u4f7f\u3048\u307e\u305b\u3093\u3002\n\n```\n $ ./sde -knl -- ./a.out \nTID 0 SDE-ERROR: Executed instruction not valid for specified chip (KNL): 0x4005e5: vpshufb zmm0, zmm1, zmm0\nImage: /home/w0/test/avx512/a.out+0x5e5\nFunction: test\nInstruction bytes are: 62 f2 75 48 00 c0 \n```\n\n\u4e16\u754c\u306f\u60b2\u3057\u307f\u306e\u708e\u306b\u5305\u307e\u308c\u305f\u3002\n\n\n\u660e\u65e5\u306f @tanakmura \u304c vshufps \u306b\u3064\u3044\u3066\u66f8\u304d\u307e\u3059\u3002\n", "tags": ["avx512"]}