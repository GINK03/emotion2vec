{"context": " More than 1 year has passed since last update.\n\n\u76ee\u7684\n\u524d\u56de\u4f5c\u3063\u305f\u30ed\u30b0\u304b\u3089\u30bb\u30c3\u30b7\u30e7\u30f3\u60c5\u5831\u306e\u4f5c\u6210\u3092\u7528\u3044\u3066\u3001\n\u5e83\u544a\u7528\u306e\u30bb\u30b0\u30e1\u30f3\u30c8\u3092\u4f5c\u6210\u306b\u5229\u7528\u3057\u305f\u308a\u3001\u884c\u52d5\u5206\u6790\u306e\u305f\u3081\u306e\u30bb\u30c3\u30b7\u30e7\u30f3\u8a73\u7d30\n\u30c6\u30fc\u30d6\u30eb\u3092\u4f5c\u6210\u3057\u3066\u307f\u307e\u3059\u3002\n\u524d\u56de\u4f5c\u3063\u305f\u30c6\u30fc\u30d6\u30eb\u306f\n* session_id\u3054\u3068\u30ed\u30b0\u30c6\u30fc\u30d6\u30eb\uff08\u30a2\u30af\u30bb\u30b9\u5358\u4f4d\uff09\n* session\u96c6\u8a08\u30b5\u30de\u30ea\uff08\u30bb\u30c3\u30b7\u30e7\u30f3\u3054\u3068\u306e\u30ab\u30a6\u30f3\u30c8\u306a\u3069\uff09\n\u306e\uff12\u3064\u3092\u4f5c\u6210\u3057\u307e\u3057\u305f\u3002\n\u3053\u308c\u3092\u5229\u7528\u3057\u3066\u69d8\u3005\u306a\u7d30\u304b\u3044\u8ef8\u3067\u96c6\u8a08\u3092\u4f5c\u6210\u3057\u3066\u307f\u307e\u3059\u3002\n\n\u96c6\u8a08\u30c6\u30fc\u30d6\u30eb\u6982\u8981\n\u30c6\u30fc\u30d6\u30eb\u540d\uff1asession\n\u30c6\u30fc\u30d6\u30eb\u5185\u5bb9\uff1a\u30bb\u30c3\u30b7\u30e7\u30f3ID\u306b\u5bfe\u3057\u3066\u30bb\u30c3\u30b7\u30e7\u30f3\u5185\u306e\u30a2\u30af\u30bb\u30b9\u5225\u306e\u30c7\u30fc\u30bf\u3092\u683c\u7d0d\n\n\n\n\u30ab\u30e9\u30e0\u540d\n\u610f\u5473\n\u30b5\u30f3\u30d7\u30eb\u30c7\u30fc\u30bf\n\n\n\n\ntime\n\u6642\u9593\uff08unixtime\uff09\n1434600335\n\n\nsession_id\n\u30bb\u30c3\u30b7\u30e7\u30f3\u756a\u53f7\nABAB1212-1111-AAAA-BBBB-XXXXXXXXXXXX\n\n\ntd_ip\nip\u30a2\u30c9\u30ec\u30b9\n222.111.44.55\n\n\ntd_path\nURL\u30d1\u30b9\n/JP/UnsubscribePage.html\n\n\ntd_client_id\n\u30e6\u30fc\u30b6\u756a\u53f7\n11111111-4555-4444-AAAA-cCCCCCCcccDD\n\n\ntd_title\n\u30da\u30fc\u30b8\u30bf\u30a4\u30c8\u30eb\n\u30ad\u30e3\u30f3\u30da\u30fc\u30f3\n\n\ntd_browser\n\u30d6\u30e9\u30a6\u30b6\u60c5\u5831\nChrome\n\n\ntd_color\n\u30ab\u30e9\u30fc\u6570\n32-bit\n\n\ntd_os_version\nOS\u30d0\u30fc\u30b8\u30e7\u30f3\n4.4.2\n\n\ntd_browser_version\n\u30d6\u30e9\u30a6\u30b6\u30d0\u30fc\u30b8\u30e7\u30f3\n30.0.0.0\n\n\ntd_referrer\n\u30ea\u30d5\u30a1\u30e9\nhttp://ja.wikipedia.org/wiki/%E3%83%91%E3%83%AD%E3%82%A2\n\n\ntd_screen\n\u30b9\u30af\u30ea\u30fc\u30f3\u30b5\u30a4\u30ba\n1280x1024\n\n\ntd_os\nOS\niOS\n\n\ntd_host\n\u30c9\u30e1\u30a4\u30f3\u540d\nwww.AAAAA.com\n\n\ntd_url\nURL\nhttps://www.AAAAA.com/jp/UnsubscribePage.html\n\n\ntd_language\nLang\nja-jp\n\n\n\n\u8ffd\u52a0\u4e88\u5b9a\u30ab\u30e9\u30e0\n\n\n\n\u30ab\u30e9\u30e0\u540d\n\u610f\u5473\n\u30b5\u30f3\u30d7\u30eb\u30c7\u30fc\u30bf\n\n\n\n\nsearch_word\n\u691c\u7d22\u30b5\u30a4\u30c8\u306e\u7d4c\u7531\u306e\u691c\u7d22\u30ef\u30fc\u30c9\n\u30b9\u30dd\u30fc\u30c4\n\n\nmobile_flag\nmobile\u304bPC\u304b\uff08mobile\u306e\u5834\u54081\uff09\n0 or 1\n\n\npage_id\n\u30de\u30b9\u30bf\u30da\u30fc\u30b8\u306e\u30da\u30fc\u30b8\u756a\u53f7\n21\n\n\nconversion_flag\n\u30b3\u30f3\u30d0\u30fc\u30b8\u30e7\u30f3\u30bb\u30c3\u30b7\u30e7\u30f3\u304b\u305d\u3046\u3067\u306a\u3044\u304b\uff1f\n0 or 1\n\n\nsession_data\n\u30da\u30fc\u30b8\u756a\u53f7\u3092\u30cf\u30a4\u30d5\u30f3\u3067\u4e26\u3079\u305f\u5024\n21-1-456-444\n\n\n\n\u30c6\u30fc\u30d6\u30eb\u540d\uff1asession_summary\n\u30c6\u30fc\u30d6\u30eb\u5185\u5bb9\uff1asession\u30c6\u30fc\u30d6\u30eb\u3092\u96c6\u8a08\u3057\u305f\u30c6\u30fc\u30d6\u30eb\n\n\n\n\u30ab\u30e9\u30e0\u540d\n\u610f\u5473\n\u30b5\u30f3\u30d7\u30eb\u30c7\u30fc\u30bf\n\n\n\n\ntime\n\u6642\u9593\uff08unixtime\uff09\n1434600335\n\n\nsession_id\n\u30bb\u30c3\u30b7\u30e7\u30f3\u756a\u53f7\nABAB1212-1111-AAAA-BBBB-XXXXXXXXXXXX\n\n\ntd_client_id\n\u30e6\u30fc\u30b6\u756a\u53f7\n11111111-4555-4444-AAAA-cCCCCCCcccDD\n\n\nsession_start_time\n\u30bb\u30c3\u30b7\u30e7\u30f3\u958b\u59cb\u6642\u9593\n2015-05-07 08:53:12\n\n\nsession_end_time\n\u30bb\u30c3\u30b7\u30e7\u30f3\u7d42\u4e86\u6642\u9593\n2015-05-07 09:50:02\n\n\nsession_stay_time\n\u30bb\u30c3\u30b7\u30e7\u30f3\u6ede\u5728\u6642\u9593\uff08\u79d2\uff09\n3410\n\n\nsession_cnt\n\uff11\u30bb\u30c3\u30b7\u30e7\u30f3\u5185\u306e\u30a2\u30af\u30bb\u30b9\u56de\u6570\n7\n\n\n\n\n\uff11\u65e5\u3054\u3068\u306e\u30bb\u30c3\u30b7\u30e7\u30f3\u6570\n\nSELECT\n  TD_TIME_FORMAT(TD_TIME_PARSE(session_start_time),'yyyy-MM-dd') as date\n ,count(distinct session_id) as session_cnt\nFROM\n session_summary\nGROUP BY\n TD_TIME_FORMAT(TD_TIME_PARSE(session_start_time),'yyyy-MM-dd')\nORDER BY \n TD_TIME_FORMAT(TD_TIME_PARSE(session_start_time),'yyyy-MM-dd')\n\n\n\u30da\u30fc\u30b8\u30de\u30b9\u30bf\u306e\u4f5c\u6210\u65b9\u6cd5\n\n\u904e\u53bb\u5206\u306e\u30de\u30b9\u30bf\u4f5c\u6210\u65b9\u6cd5\n\u6982\u8981\uff1a\u30da\u30fc\u30b8\u756a\u53f7\u3092row_number\u3092\u5229\u7528\u3057\u756a\u53f7\u3092\u632f\u308b\u3002\n\u4f5c\u6210\u30c6\u30fc\u30d6\u30eb\uff1apage_master\n\n-- hive or presto\nSELECT\n a.td_url as td_url\n,ROW_NUMBER() OVER ( ORDER BY a.cnt DESC ) AS rownum\nFROM\n(\nSELECT \n regexp_replace(td_url, '(http://|https://)', '') as td_url\n,count(1) as cnt\nFROM access\n-- 2\u30f6\u6708\u9593\u306e\u30de\u30b9\u30bf\u3092\u4f5c\u6210\nWHERE TD_TIME_RANGE(time, '2015-04-01', '2015-05-31', 'JST')\nGROUP BY regexp_replace(td_url, '(http://|https://)', '')\n) a\n\n\u3053\u308c\u306f\u3042\u308b\u4e00\u5b9a\u671f\u9593\u3092\uff11\u767a\u3067\u30de\u30b9\u30bf\u4f5c\u6210\u3059\u308b\u65b9\u6cd5\u306e\u305f\u3081\u3001\n\u6bce\u65e5\u306e\u904b\u7528\u3067\u306f\u5dee\u5206\u3092\u8ffd\u52a0\u3059\u308b\u3088\u3046\u306a\u4ed5\u7d44\u307f\u306b\u5909\u66f4\u3002\n\n1\u65e5\u5206\u306e\u30da\u30fc\u30b8\u30de\u30b9\u30bf\u3092\u4f5c\u6210\n\u6982\u8981\uff1atmp_page_master\u306b\uff11\u65e5\u5206\u4f5c\u6210\n\u4f5c\u6210\u30c6\u30fc\u30d6\u30eb\uff1atmp_page_master\n\n\nSELECT\n a.td_url as td_url\n,ROW_NUMBER() OVER ( ORDER BY a.cnt DESC ) AS rownum\nFROM\n(\nSELECT \n regexp_replace(td_url, '(http://|https://)', '') as td_url\n,count(1) as cnt\nFROM access\nWHERE TD_TIME_RANGE(time, '2015-06-01', TD_TIME_ADD('2015-06-01','1d'), 'JST')\nGROUP BY regexp_replace(td_url, '(http://|https://)', '')\n) a\n\n\n1\u65e5\u5206\u306e\u5dee\u5206\u3092\u4f5c\u6210\u3057\u3001\u5143\u306epage_master\u306b\u8ffd\u8a18\u3059\u308b\u65b9\u6cd5\u3002\n\u6982\u8981\uff1a\u5dee\u5206\u306brownum\u3092\u632f\u308a\u3001\u5143\u306e\u30c6\u30fc\u30d6\u30eb\u306b\u8ffd\u8a18\u3059\u308b\u3002\n\u4f5c\u6210\u30c6\u30fc\u30d6\u30eb\uff1apage_master\n\n-- hive or presto\nSELECT\n  c.td_url as td_url\n ,(d.max_rownum + c.rownum) as rownum\nFROM\n(\n select  \n  a.td_url as td_url\n ,ROW_NUMBER() OVER ( ORDER BY b.rownum DESC ) AS rownum\n from \n  tmp_page_master a\n LEFT OUTER JOIN\n  page_master b\n ON \n  a.td_url = b.td_url\n WHERE b.rownum is null\n) c\n, \n( select max(rownum) as max_rownum from page_master ) d\n\n\u3053\u306e\uff12\u3064\u3092\u6bce\u65e5\u8d70\u3089\u305b\u308b\u3053\u3068\u306b\u3088\u308a\u3001\u65b0\u898f\u30da\u30fc\u30b8\u3092\n\u30de\u30b9\u30bf\u306b\u8ffd\u8a18\u3057\u3001\u30da\u30fc\u30b8\u756a\u53f7\u3092\u632f\u308b\u3053\u3068\u304c\u53ef\u80fd\u3068\u306a\u308b\u3002\n\npage_master\u30c6\u30fc\u30d6\u30eb\u306bConversion\u30d5\u30e9\u30b0\u3092\u8ffd\u52a0\n\u6982\u8981\uff1a\u30b3\u30f3\u30d0\u30fc\u30b8\u30e7\u30f3\u30da\u30fc\u30b8\u306b1\u306e\u30d5\u30e9\u30b0\u3092\u7acb\u3066\u308b\n\u4f5c\u6210\u30c6\u30fc\u30d6\u30eb\uff1apage_master_detail\n\nSELECT\n  td_url\n, rownum as page_id\n,(CASE \n  -- \u4ee5\u4e0b\u306e\u884c\u306b\u8db3\u3057\u3066\u3044\u304f...\n  WHEN td_url like '%thank%' THEN 1\n  WHEN td_url LIKE '%THANK%' THEN 1\n  WHEN td_url LIKE '%Thank%' THEN 1\n  ELSE 0\n  END) as conversion_flag\nFROM page_master\n\n\n\u30bb\u30c3\u30b7\u30e7\u30f3\u8a73\u7d30\u30c6\u30fc\u30d6\u30eb\u306e\u4f5c\u6210\u3059\u308b\n\u6982\u8981\uff1a\u8ffd\u52a0\u4e88\u5b9a\u30ab\u30e9\u30e0\u3092session\u30c6\u30fc\u30d6\u30eb\u306b\u8ffd\u52a0\u3059\u308b\u3002\n\u3000\u3000\u3000\u8ffd\u52a0\u30ab\u30e9\u30e0\u306f\u3001\u30d5\u30e9\u30b0\uff08\u30e2\u30d0\u30a4\u30eb\u3001\u30b3\u30f3\u30d0\u30fc\u30b8\u30e7\u30f3\uff09\u3001\u30da\u30fc\u30b8\u756a\u53f7\n\u3000\u3000\u3000\u30ea\u30d5\u30a1\u30e9\u304b\u3089\u306e\u691c\u7d22\u30ef\u30fc\u30c9\u306a\u3069\u3092\u8ffd\u52a0\u3059\u308b\u3002\n\u4f5c\u6210\u30c6\u30fc\u30d6\u30eb\uff1asession_detail\n\nSELECT\n  b.session_id as session_id\n, b.time as time\n, b.td_ip as td_ip\n, b.td_path as td_path\n, b.td_client_id as td_client_id\n, b.td_title as td_title\n, b.mobile_flag as mobile_flag\n, b.td_browser as td_browser\n, b.td_color as td_color\n, b.td_os_version as td_os_version\n, b.td_browser_version as td_browser_version\n, b.td_referrer as td_referrer \n, b.search_word as search_word\n, b.td_screen as td_screen \n, b.td_os as td_os\n, b.td_host as td_host \n, b.td_url as td_url\n, (CASE WHEN c.conversion_flag = 1 THEN 1 ELSE 0 END) as conversion_flag\n, c.page_id as page_id\n, b.td_language as td_language\nFROM\n(\n SELECT \n   TD_SESSIONIZE(time, 86400, td_ip) as session_id\n , time\n , td_ip\n , td_path\n , td_client_id\n , td_title\n , td_browser\n , td_color\n , td_os_version\n , td_browser_version\n , td_referrer \n , td_screen \n , td_os\n , td_host \n , td_url\n , regexp_replace(td_url, '(http://|https://)', '') as url\n , td_language\n , (CASE \n    WHEN td_referrer like '%google%'   THEN parse_url(TD_URL_DECODE(td_referrer),'QUERY','q')\n    WHEN td_referrer like '%bing.com%' THEN parse_url(TD_URL_DECODE(td_referrer),'QUERY','q')\n    WHEN td_referrer like '%yahoo%'    THEN parse_url(TD_URL_DECODE(td_referrer),'QUERY','p')\n    ELSE parse_url(TD_URL_DECODE(td_referrer),'QUERY','p')\n    END) as search_word\n , (CASE WHEN td_os IN ('iOS','BlackBerry OS','Android','Windows Phone') THEN 1 ELSE 0 END) as mobile_flag\n FROM \n (\n   SELECT time, td_ip, td_path, td_client_id, td_title\n         ,td_browser, td_color, td_os_version\n         ,td_browser_version, td_referrer, td_screen \n         ,td_os, td_host, td_url, td_language\n   FROM access\n   distribute by td_ip\n   sort by td_ip,time\n ) a \n) b\n,page_master_detail c\nWHERE b.url = c.td_url\n\n\u3053\u3053\u304b\u3089\u306f\u4e0a\u8a18\u306esession_detail\u304b\u3089\n\u30bb\u30c3\u30b7\u30e7\u30f3\u3054\u3068\u306e\u30d1\u30b9\u3092\u4f5c\u6210\u3057\u3066\u307f\u3088\u3046\u3002\n\n\u30d1\u30b9\u5206\u6790\n\u6982\u8981\uff1a\u30bb\u30c3\u30b7\u30e7\u30f3\u756a\u53f7\u3054\u3068\u306b\u30a2\u30af\u30bb\u30b9\u3055\u308c\u305f\u9806\u306e\u30da\u30fc\u30b8\u756a\u53f7\u3092\u914d\u5217\u306b\u5165\u308c\u308b\u3002\n\u3000\u3000\u3000\u540c\u69d8\u306b\u30bb\u30c3\u30b7\u30e7\u30f3\u30ab\u30a6\u30f3\u30c8\u3082\u8868\u793a\u3059\u308b\u3002\n\u4f5c\u6210\u30c6\u30fc\u30d6\u30eb\uff1asession_path\n\u30c6\u30fc\u30d6\u30eb\u69cb\u6210\uff1a\n\n\n\n\u30ab\u30e9\u30e0\u540d\n\u610f\u5473\n\u30b5\u30f3\u30d7\u30eb\u30c7\u30fc\u30bf\n\n\n\n\ntime\n\u6642\u9593\uff08unixtime\uff09\n1434600335\n\n\nsession_id\n\u30bb\u30c3\u30b7\u30e7\u30f3\u756a\u53f7\nABAB1212-1111-AAAA-BBBB-XXXXXXXXXXXX\n\n\ntd_client_id\n\u30e6\u30fc\u30b6\u756a\u53f7\n11111111-4555-4444-AAAA-cCCCCCCcccDD\n\n\npath\n\u30d1\u30b9\uff08\u30da\u30fc\u30b8\u756a\u53f7\u3092\u30a2\u30af\u30bb\u30b9\u9806\u306b\u4e26\u3079\u308b\uff09\n[\"1\",\"14\",\"14\",\"14\",\"20\",\"20\",\"15\",\"19\",,\"27\"]\n\n\nsession_page_cnt\n\uff11\u30bb\u30c3\u30b7\u30e7\u30f3\u5185\u306e\u30a2\u30af\u30bb\u30b9\u56de\u6570\n7\n\n\n\n\nSELECT\n    session_id\n  , td_client_id\n  , collect_list(CAST(page_id as STRING)) as path\n  , count(1) as page_cnt\nFROM session_detail\nGROUP BY\n  session_id, td_client_id\n\n\nsession_path\u3078\u306e\u30a2\u30af\u30bb\u30b9\u65b9\u6cd5\n\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u7c21\u5358\u306b\u5c55\u958b\u3057\u3001\u3053\u308c\u304b\u3089\u518d\u5ea6\u96c6\u8a08\u3092\u884c\u3046\u3002\n\u540c\u69d8\u306bROW_NUMBER\u95a2\u6570\u3088\u308a\u3001\u30d1\u30b9\u5185\u306e\u9806\u756a\u3092\u793a\u3059\u3053\u3068\u3082\u53ef\u80fd\u3067\u3059\u3002\n\nSELECT \n  session_id,\n  pid\nFROM\n  session_path\nLATERAL VIEW\n  explode(PATH) pageTable AS pid\n\n\u30d1\u30b9\u5206\u6790\u306e\u8a73\u7d30\u3092\u4f5c\u6210\u3059\u308b\u3053\u3068\u3067\u5404\u30e6\u30fc\u30b6\u304c\u3069\u306e\u3088\u3046\u306a\u30a2\u30af\u30bb\u30b9\u3092\u884c\u3063\u3066\u3044\u308b\u304b\u304c\n\u3088\u308a\u660e\u78ba\u306b\u306a\u308b\u3002\n## \u76ee\u7684\n\u524d\u56de\u4f5c\u3063\u305f[\u30ed\u30b0\u304b\u3089\u30bb\u30c3\u30b7\u30e7\u30f3\u60c5\u5831\u306e\u4f5c\u6210]\n(http://qiita.com/itochu0523/items/80fcde77b4b1a8867baf)\u3092\u7528\u3044\u3066\u3001\n\u5e83\u544a\u7528\u306e\u30bb\u30b0\u30e1\u30f3\u30c8\u3092\u4f5c\u6210\u306b\u5229\u7528\u3057\u305f\u308a\u3001\u884c\u52d5\u5206\u6790\u306e\u305f\u3081\u306e\u30bb\u30c3\u30b7\u30e7\u30f3\u8a73\u7d30\n\u30c6\u30fc\u30d6\u30eb\u3092\u4f5c\u6210\u3057\u3066\u307f\u307e\u3059\u3002\n\n\u524d\u56de\u4f5c\u3063\u305f\u30c6\u30fc\u30d6\u30eb\u306f\n* session_id\u3054\u3068\u30ed\u30b0\u30c6\u30fc\u30d6\u30eb\uff08\u30a2\u30af\u30bb\u30b9\u5358\u4f4d\uff09\n* session\u96c6\u8a08\u30b5\u30de\u30ea\uff08\u30bb\u30c3\u30b7\u30e7\u30f3\u3054\u3068\u306e\u30ab\u30a6\u30f3\u30c8\u306a\u3069\uff09\n\u306e\uff12\u3064\u3092\u4f5c\u6210\u3057\u307e\u3057\u305f\u3002\n\u3053\u308c\u3092\u5229\u7528\u3057\u3066\u69d8\u3005\u306a\u7d30\u304b\u3044\u8ef8\u3067\u96c6\u8a08\u3092\u4f5c\u6210\u3057\u3066\u307f\u307e\u3059\u3002\n\n\n## \u96c6\u8a08\u30c6\u30fc\u30d6\u30eb\u6982\u8981\n\n\u30c6\u30fc\u30d6\u30eb\u540d\uff1asession\n\u30c6\u30fc\u30d6\u30eb\u5185\u5bb9\uff1a\u30bb\u30c3\u30b7\u30e7\u30f3ID\u306b\u5bfe\u3057\u3066\u30bb\u30c3\u30b7\u30e7\u30f3\u5185\u306e\u30a2\u30af\u30bb\u30b9\u5225\u306e\u30c7\u30fc\u30bf\u3092\u683c\u7d0d\n\n| \u30ab\u30e9\u30e0\u540d |\u610f\u5473 |\u30b5\u30f3\u30d7\u30eb\u30c7\u30fc\u30bf|\n|:---|:---|:---|\n|time|\u6642\u9593\uff08unixtime\uff09| 1434600335 |\n|session_id|\u30bb\u30c3\u30b7\u30e7\u30f3\u756a\u53f7|ABAB1212-1111-AAAA-BBBB-XXXXXXXXXXXX|\n|td_ip|ip\u30a2\u30c9\u30ec\u30b9|222.111.44.55|\n|td_path|URL\u30d1\u30b9|/JP/UnsubscribePage.html|\n|td_client_id|\u30e6\u30fc\u30b6\u756a\u53f7|11111111-4555-4444-AAAA-cCCCCCCcccDD|\n|td_title|\u30da\u30fc\u30b8\u30bf\u30a4\u30c8\u30eb|\u30ad\u30e3\u30f3\u30da\u30fc\u30f3|\n|td_browser|\u30d6\u30e9\u30a6\u30b6\u60c5\u5831| Chrome |\n|td_color|\u30ab\u30e9\u30fc\u6570|32-bit|\n|td_os_version|OS\u30d0\u30fc\u30b8\u30e7\u30f3|4.4.2|\n|td_browser_version|\u30d6\u30e9\u30a6\u30b6\u30d0\u30fc\u30b8\u30e7\u30f3|30.0.0.0|\n|td_referrer|\u30ea\u30d5\u30a1\u30e9|http://ja.wikipedia.org/wiki/%E3%83%91%E3%83%AD%E3%82%A2|\n|td_screen|\u30b9\u30af\u30ea\u30fc\u30f3\u30b5\u30a4\u30ba|1280x1024|\n|td_os|OS|iOS|\n|td_host|\u30c9\u30e1\u30a4\u30f3\u540d|www.AAAAA.com|\n|td_url|URL|https://www.AAAAA.com/jp/UnsubscribePage.html|\n|td_language|Lang|ja-jp|\n\n\u8ffd\u52a0\u4e88\u5b9a\u30ab\u30e9\u30e0\n\n| \u30ab\u30e9\u30e0\u540d |\u610f\u5473 |\u30b5\u30f3\u30d7\u30eb\u30c7\u30fc\u30bf|\n|:---|:---|:---|\n|search_word|\u691c\u7d22\u30b5\u30a4\u30c8\u306e\u7d4c\u7531\u306e\u691c\u7d22\u30ef\u30fc\u30c9| \u30b9\u30dd\u30fc\u30c4 |\n|mobile_flag|mobile\u304bPC\u304b\uff08mobile\u306e\u5834\u54081\uff09| 0 or 1| \n|page_id|\u30de\u30b9\u30bf\u30da\u30fc\u30b8\u306e\u30da\u30fc\u30b8\u756a\u53f7| 21 | \n|conversion_flag|\u30b3\u30f3\u30d0\u30fc\u30b8\u30e7\u30f3\u30bb\u30c3\u30b7\u30e7\u30f3\u304b\u305d\u3046\u3067\u306a\u3044\u304b\uff1f | 0 or 1 |\n| session_data|\u30da\u30fc\u30b8\u756a\u53f7\u3092\u30cf\u30a4\u30d5\u30f3\u3067\u4e26\u3079\u305f\u5024|21-1-456-444|\n\n\n\u30c6\u30fc\u30d6\u30eb\u540d\uff1asession_summary\n\u30c6\u30fc\u30d6\u30eb\u5185\u5bb9\uff1asession\u30c6\u30fc\u30d6\u30eb\u3092\u96c6\u8a08\u3057\u305f\u30c6\u30fc\u30d6\u30eb\n\n| \u30ab\u30e9\u30e0\u540d |\u610f\u5473 |\u30b5\u30f3\u30d7\u30eb\u30c7\u30fc\u30bf|\n|:---|:---|:---|\n|time|\u6642\u9593\uff08unixtime\uff09| 1434600335 |\n|session_id|\u30bb\u30c3\u30b7\u30e7\u30f3\u756a\u53f7|ABAB1212-1111-AAAA-BBBB-XXXXXXXXXXXX|\n|td_client_id|\u30e6\u30fc\u30b6\u756a\u53f7|11111111-4555-4444-AAAA-cCCCCCCcccDD|\n|session_start_time|\u30bb\u30c3\u30b7\u30e7\u30f3\u958b\u59cb\u6642\u9593|2015-05-07 08:53:12|\n|session_end_time|\u30bb\u30c3\u30b7\u30e7\u30f3\u7d42\u4e86\u6642\u9593|2015-05-07 09:50:02|\n|session_stay_time|\u30bb\u30c3\u30b7\u30e7\u30f3\u6ede\u5728\u6642\u9593\uff08\u79d2\uff09\b|3410|\n|session_cnt|\uff11\u30bb\u30c3\u30b7\u30e7\u30f3\u5185\u306e\u30a2\u30af\u30bb\u30b9\u56de\u6570|7|\n\n\n\n\n* \uff11\u65e5\u3054\u3068\u306e\u30bb\u30c3\u30b7\u30e7\u30f3\u6570\n\n```sql\nSELECT\n  TD_TIME_FORMAT(TD_TIME_PARSE(session_start_time),'yyyy-MM-dd') as date\n ,count(distinct session_id) as session_cnt\nFROM\n session_summary\nGROUP BY\n TD_TIME_FORMAT(TD_TIME_PARSE(session_start_time),'yyyy-MM-dd')\nORDER BY \n TD_TIME_FORMAT(TD_TIME_PARSE(session_start_time),'yyyy-MM-dd')\n```\n\n\n\n## \u30da\u30fc\u30b8\u30de\u30b9\u30bf\u306e\u4f5c\u6210\u65b9\u6cd5\n\n* \u904e\u53bb\u5206\u306e\u30de\u30b9\u30bf\u4f5c\u6210\u65b9\u6cd5<br>\n\u6982\u8981\uff1a\u30da\u30fc\u30b8\u756a\u53f7\u3092row_number\u3092\u5229\u7528\u3057\u756a\u53f7\u3092\u632f\u308b\u3002<br>\n\u4f5c\u6210\u30c6\u30fc\u30d6\u30eb\uff1apage_master\n\n```sql\n-- hive or presto\nSELECT\n a.td_url as td_url\n,ROW_NUMBER() OVER ( ORDER BY a.cnt DESC ) AS rownum\nFROM\n(\nSELECT \n regexp_replace(td_url, '(http://|https://)', '') as td_url\n,count(1) as cnt\nFROM access\n-- 2\u30f6\u6708\u9593\u306e\u30de\u30b9\u30bf\u3092\u4f5c\u6210\nWHERE TD_TIME_RANGE(time, '2015-04-01', '2015-05-31', 'JST')\nGROUP BY regexp_replace(td_url, '(http://|https://)', '')\n) a\n```\n\n\u3053\u308c\u306f\u3042\u308b\u4e00\u5b9a\u671f\u9593\u3092\uff11\u767a\u3067\u30de\u30b9\u30bf\u4f5c\u6210\u3059\u308b\u65b9\u6cd5\u306e\u305f\u3081\u3001\n\u6bce\u65e5\u306e\u904b\u7528\u3067\u306f\u5dee\u5206\u3092\u8ffd\u52a0\u3059\u308b\u3088\u3046\u306a\u4ed5\u7d44\u307f\u306b\u5909\u66f4\u3002\n\n* 1\u65e5\u5206\u306e\u30da\u30fc\u30b8\u30de\u30b9\u30bf\u3092\u4f5c\u6210<br>\n\u6982\u8981\uff1atmp_page_master\u306b\uff11\u65e5\u5206\u4f5c\u6210<br>\n\u4f5c\u6210\u30c6\u30fc\u30d6\u30eb\uff1atmp_page_master\n\n```sql\n\nSELECT\n a.td_url as td_url\n,ROW_NUMBER() OVER ( ORDER BY a.cnt DESC ) AS rownum\nFROM\n(\nSELECT \n regexp_replace(td_url, '(http://|https://)', '') as td_url\n,count(1) as cnt\nFROM access\nWHERE TD_TIME_RANGE(time, '2015-06-01', TD_TIME_ADD('2015-06-01','1d'), 'JST')\nGROUP BY regexp_replace(td_url, '(http://|https://)', '')\n) a\n```\n\n* 1\u65e5\u5206\u306e\u5dee\u5206\u3092\u4f5c\u6210\u3057\u3001\u5143\u306epage_master\u306b\u8ffd\u8a18\u3059\u308b\u65b9\u6cd5\u3002<br>\n\u6982\u8981\uff1a\u5dee\u5206\u306brownum\u3092\u632f\u308a\u3001\u5143\u306e\u30c6\u30fc\u30d6\u30eb\u306b\u8ffd\u8a18\u3059\u308b\u3002<br>\n\u4f5c\u6210\u30c6\u30fc\u30d6\u30eb\uff1apage_master\n\n```sql\n-- hive or presto\nSELECT\n  c.td_url as td_url\n ,(d.max_rownum + c.rownum) as rownum\nFROM\n(\n select  \n  a.td_url as td_url\n ,ROW_NUMBER() OVER ( ORDER BY b.rownum DESC ) AS rownum\n from \n  tmp_page_master a\n LEFT OUTER JOIN\n  page_master b\n ON \n  a.td_url = b.td_url\n WHERE b.rownum is null\n) c\n, \n( select max(rownum) as max_rownum from page_master ) d\n```\n\n\u3053\u306e\uff12\u3064\u3092\u6bce\u65e5\u8d70\u3089\u305b\u308b\u3053\u3068\u306b\u3088\u308a\u3001\u65b0\u898f\u30da\u30fc\u30b8\u3092\n\u30de\u30b9\u30bf\u306b\u8ffd\u8a18\u3057\u3001\u30da\u30fc\u30b8\u756a\u53f7\u3092\u632f\u308b\u3053\u3068\u304c\u53ef\u80fd\u3068\u306a\u308b\u3002\n\n* page_master\u30c6\u30fc\u30d6\u30eb\u306bConversion\u30d5\u30e9\u30b0\u3092\u8ffd\u52a0<br>\n\u6982\u8981\uff1a\u30b3\u30f3\u30d0\u30fc\u30b8\u30e7\u30f3\u30da\u30fc\u30b8\u306b1\u306e\u30d5\u30e9\u30b0\u3092\u7acb\u3066\u308b<br>\n\u4f5c\u6210\u30c6\u30fc\u30d6\u30eb\uff1apage_master_detail\n\n```sql\nSELECT\n  td_url\n, rownum as page_id\n,(CASE \n  -- \u4ee5\u4e0b\u306e\u884c\u306b\u8db3\u3057\u3066\u3044\u304f...\n  WHEN td_url like '%thank%' THEN 1\n  WHEN td_url LIKE '%THANK%' THEN 1\n  WHEN td_url LIKE '%Thank%' THEN 1\n  ELSE 0\n  END) as conversion_flag\nFROM page_master\n```\n\n## \u30bb\u30c3\u30b7\u30e7\u30f3\u8a73\u7d30\u30c6\u30fc\u30d6\u30eb\u306e\u4f5c\u6210\u3059\u308b\n\n\u6982\u8981\uff1a\u8ffd\u52a0\u4e88\u5b9a\u30ab\u30e9\u30e0\u3092session\u30c6\u30fc\u30d6\u30eb\u306b\u8ffd\u52a0\u3059\u308b\u3002\n\u3000\u3000\u3000\u8ffd\u52a0\u30ab\u30e9\u30e0\u306f\u3001\u30d5\u30e9\u30b0\uff08\u30e2\u30d0\u30a4\u30eb\u3001\u30b3\u30f3\u30d0\u30fc\u30b8\u30e7\u30f3\uff09\u3001\u30da\u30fc\u30b8\u756a\u53f7\n\u3000\u3000\u3000\u30ea\u30d5\u30a1\u30e9\u304b\u3089\u306e\u691c\u7d22\u30ef\u30fc\u30c9\u306a\u3069\u3092\u8ffd\u52a0\u3059\u308b\u3002\n\u4f5c\u6210\u30c6\u30fc\u30d6\u30eb\uff1asession_detail\n\n```sql\n\nSELECT\n  b.session_id as session_id\n, b.time as time\n, b.td_ip as td_ip\n, b.td_path as td_path\n, b.td_client_id as td_client_id\n, b.td_title as td_title\n, b.mobile_flag as mobile_flag\n, b.td_browser as td_browser\n, b.td_color as td_color\n, b.td_os_version as td_os_version\n, b.td_browser_version as td_browser_version\n, b.td_referrer as td_referrer \n, b.search_word as search_word\n, b.td_screen as td_screen \n, b.td_os as td_os\n, b.td_host as td_host \n, b.td_url as td_url\n, (CASE WHEN c.conversion_flag = 1 THEN 1 ELSE 0 END) as conversion_flag\n, c.page_id as page_id\n, b.td_language as td_language\nFROM\n(\n SELECT \n   TD_SESSIONIZE(time, 86400, td_ip) as session_id\n , time\n , td_ip\n , td_path\n , td_client_id\n , td_title\n , td_browser\n , td_color\n , td_os_version\n , td_browser_version\n , td_referrer \n , td_screen \n , td_os\n , td_host \n , td_url\n , regexp_replace(td_url, '(http://|https://)', '') as url\n , td_language\n , (CASE \n    WHEN td_referrer like '%google%'   THEN parse_url(TD_URL_DECODE(td_referrer),'QUERY','q')\n    WHEN td_referrer like '%bing.com%' THEN parse_url(TD_URL_DECODE(td_referrer),'QUERY','q')\n    WHEN td_referrer like '%yahoo%'    THEN parse_url(TD_URL_DECODE(td_referrer),'QUERY','p')\n    ELSE parse_url(TD_URL_DECODE(td_referrer),'QUERY','p')\n    END) as search_word\n , (CASE WHEN td_os IN ('iOS','BlackBerry OS','Android','Windows Phone') THEN 1 ELSE 0 END) as mobile_flag\n FROM \n (\n   SELECT time, td_ip, td_path, td_client_id, td_title\n         ,td_browser, td_color, td_os_version\n         ,td_browser_version, td_referrer, td_screen \n         ,td_os, td_host, td_url, td_language\n   FROM access\n   distribute by td_ip\n   sort by td_ip,time\n ) a \n) b\n,page_master_detail c\nWHERE b.url = c.td_url\n```\n\n\u3053\u3053\u304b\u3089\u306f\u4e0a\u8a18\u306esession_detail\u304b\u3089\n\u30bb\u30c3\u30b7\u30e7\u30f3\u3054\u3068\u306e\u30d1\u30b9\u3092\u4f5c\u6210\u3057\u3066\u307f\u3088\u3046\u3002\n\n\n## \u30d1\u30b9\u5206\u6790\n\n\u6982\u8981\uff1a\u30bb\u30c3\u30b7\u30e7\u30f3\u756a\u53f7\u3054\u3068\u306b\u30a2\u30af\u30bb\u30b9\u3055\u308c\u305f\u9806\u306e\u30da\u30fc\u30b8\u756a\u53f7\u3092\u914d\u5217\u306b\u5165\u308c\u308b\u3002\n\u3000\u3000\u3000\u540c\u69d8\u306b\u30bb\u30c3\u30b7\u30e7\u30f3\u30ab\u30a6\u30f3\u30c8\u3082\u8868\u793a\u3059\u308b\u3002\n\u4f5c\u6210\u30c6\u30fc\u30d6\u30eb\uff1asession_path\n\u30c6\u30fc\u30d6\u30eb\u69cb\u6210\uff1a\n\n| \u30ab\u30e9\u30e0\u540d |\u610f\u5473 |\u30b5\u30f3\u30d7\u30eb\u30c7\u30fc\u30bf|\n|:---|:---|:---|\n|time|\u6642\u9593\uff08unixtime\uff09| 1434600335 |\n|session_id|\u30bb\u30c3\u30b7\u30e7\u30f3\u756a\u53f7|ABAB1212-1111-AAAA-BBBB-XXXXXXXXXXXX|\n|td_client_id|\u30e6\u30fc\u30b6\u756a\u53f7|11111111-4555-4444-AAAA-cCCCCCCcccDD|\n|path|\u30d1\u30b9\uff08\u30da\u30fc\u30b8\u756a\u53f7\u3092\u30a2\u30af\u30bb\u30b9\u9806\u306b\u4e26\u3079\u308b\uff09\b|[\"1\",\"14\",\"14\",\"14\",\"20\",\"20\",\"15\",\"19\",,\"27\"]|\n|session_page_cnt|\uff11\u30bb\u30c3\u30b7\u30e7\u30f3\u5185\u306e\u30a2\u30af\u30bb\u30b9\u56de\u6570|7|\n\n\n```sql\n\nSELECT\n    session_id\n  , td_client_id\n  , collect_list(CAST(page_id as STRING)) as path\n  , count(1) as page_cnt\nFROM session_detail\nGROUP BY\n  session_id, td_client_id\n```\n\n\n\n## session_path\u3078\u306e\u30a2\u30af\u30bb\u30b9\u65b9\u6cd5\n\n\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u7c21\u5358\u306b\u5c55\u958b\u3057\u3001\u3053\u308c\u304b\u3089\u518d\u5ea6\u96c6\u8a08\u3092\u884c\u3046\u3002\n\u540c\u69d8\u306bROW_NUMBER\u95a2\u6570\u3088\u308a\u3001\u30d1\u30b9\u5185\u306e\u9806\u756a\u3092\u793a\u3059\u3053\u3068\u3082\u53ef\u80fd\u3067\u3059\u3002\n\n```sql\n\nSELECT \n  session_id,\n  pid\nFROM\n  session_path\nLATERAL VIEW\n  explode(PATH) pageTable AS pid\n```\n\n\u30d1\u30b9\u5206\u6790\u306e\u8a73\u7d30\u3092\u4f5c\u6210\u3059\u308b\u3053\u3068\u3067\u5404\u30e6\u30fc\u30b6\u304c\u3069\u306e\u3088\u3046\u306a\u30a2\u30af\u30bb\u30b9\u3092\u884c\u3063\u3066\u3044\u308b\u304b\u304c\n\u3088\u308a\u660e\u78ba\u306b\u306a\u308b\u3002\n\n", "tags": ["TreasureData", "\u30a2\u30af\u30bb\u30b9\u89e3\u6790"]}