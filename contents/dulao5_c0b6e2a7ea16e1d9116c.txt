{"tags": ["Node.js", "Sails.js", "Express.js"], "context": " More than 1 year has passed since last update.\n\nSails.js\u3068\u306f\n\u6700\u8fd1\u7b46\u8005\u306fNode.js\u306e\u300cSails.js\u300d\u3068\u3044\u3046\u30d5\u30ec\u30fc\u30e0\u30ef\u30fc\u30af\u3092\u5229\u7528\u3057\u3066\u65b0\u3057\u3044\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u3092\u69cb\u7bc9\u3057\u3066\u3044\u307e\u3059\u3002Sails.js\u306fExpress.js\u3092\u57fa\u3044\u3066\u3001\u66f4\u306bWebSocket\u30fbRESTFul API\u30fbMVC\u30fbORM\u306a\u3069\u69d8\u3005\u306a\u6280\u8853\u3092\u542b\u3081\u3001\u975e\u5e38\u306b\u4fbf\u5229\u306a\u306e\u3067\u3001\u3055\u3059\u304c\u300c\u73fe\u4ee3\u7684\u306a\u30d5\u30ec\u30fc\u30e0\u30ef\u30fc\u30af\u300d\u3068\u8a00\u3048\u307e\u3059\u3002\n\u4eca\u56de\u306fSession\u3092\u7121\u99c4\u9063\u3044\u3057\u3066\u3057\u307e\u3046\u8a71\u3092\u3057\u307e\u3057\u3087\u3046\u3002\n\nSession\u306e\u7121\u99c4\u306b\u4f7f\u3046\u554f\u984c\n\u666e\u901a\u306eWeb Site\u3067\u3001\u4e0b\u8a18\u306e\u3088\u3046\u306aURL Path\u304c\u3042\u308a\u307e\u3059\u3002\n\n\n\nPath\nMethod\nMemo\n\n\n\n\n/\u3001/login\u3001/my/book\nGET\nWeb\u30da\u30fc\u30b8\u6a5f\u80fd\u306b\u3088\u3063\u3066Session\u3092\u4f7f\u3046\u53ef\u80fd\u6027\u304c\u3042\u308a\u307e\u3059\u3002\n\n\n/api/item/ranking\nGET\n\u516c\u958b\u60c5\u5831Web\u3068\u30a2\u30d7\u30ea\u5411\u3051APISession\u3068\u95a2\u4fc2\u3042\u308a\u307e\u305b\u3093\u3002\n\n\n/api/user/profile/@me\n\nGET/PUT\n\u500b\u4eba\u60c5\u5831Web\u3068\u30a2\u30d7\u30ea\u5411\u3051API\u8a8d\u8a3c\u306b\u95a2\u3059\u308bSession\uff0fOAuth\u3068\u95a2\u4fc2\u3042\u308a\u307e\u3059\u3002\n\n\n\n\nWeb\u30da\u30fc\u30b8\u3068\u30d6\u30e9\u30a6\u30b6\u30fc\u306e\u5834\u5408\n\u4e0a\u8a18\u5185\u5bb9\u306b\u3088\u308b\u3068\u3001Session\u3092\u6700\u3082\u5229\u7528\u3059\u3079\u304d\u6240\u306fWeb\u30da\u30fc\u30b8\u3067\u3059\u3002\u30e6\u30fc\u30b6\u30fc\u304c\u6700\u521d\u306bWeb\u30da\u30fc\u30b8\u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3068\u3001\u65b0\u3057\u3044Session\u3092\u4f5c\u6210\u3057\u3066\u3001Session\u306e\u5185\u5bb9\u306fSession Store\u306b\u4fdd\u5b58\u3059\u308b(Memcache\u30fbRedis\u7b49)\u3002\u65b0\u3057\u3044Session ID\u306fCookie\u306e\u5f62\u3067User Agent\u306b\u767a\u884c\u3057\u3066\u3001\u4fdd\u5b58\u3055\u308c\u307e\u3059\u3002\n\u4f8b\u3048\u3070\u3001\ncurl -v http://127.0.0.1:1337/login > /dev/null\n> GET /login HTTP/1.1\n...\n< HTTP/1.1 200 OK\n< X-Powered-By: Sails <sailsjs.org>\n...\n< Set-Cookie: sails.sid=s%3AvX4jELukbYhzct43etS21uRU.apwQfFIzp1bpAgvTYaIfx%2FaheTw%2B0DoLKQV52a98uEg; Path=/; HttpOnly\n...\n\nUser Agent\u304c\u5e38\u306b\u305d\u306eCookie\u3092\u4fdd\u6709\u3057\u3066\u3044\u307e\u3059\u304b\u3089\u3001\u30b5\u30fc\u30d0\u30fc\u5074\u3068\u306e\u901a\u4fe1\u72b6\u614b\u3092\u3046\u307e\u304f\u4fdd\u6709\u3057\u307e\u3059\u3002\n\u305d\u3057\u3066\u3001\u901a\u4fe1\u671f\u9593\u5185\u306b\u4e00\u3064Cookie\u304cSession ID\u3092\u4fdd\u6709\u3057\u307e\u3002\u3064\u307e\u308a\u3001\u30b5\u30fc\u30d0\u30fc\u5074Session Store\u3082\u4e00\u3064\u3057\u304b\u306a\u3044\u304b\u3089\u3001Session\u3092\u7121\u99c4\u306b\u4f7f\u3046\u3053\u3068\u3067\u306f\u3042\u308a\u307e\u305b\u3093\u3002\n\n\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u5074\u304c\u30d6\u30e9\u30a6\u30b6\u30fc\u3067\u306f\u306a\u3044\u5834\u5408\n\u4f46\u3057\u3001\u30a2\u30d7\u30ea\u5411\u3051API\u3084\u3001\u5916\u90e8\u30d1\u30fc\u30c8\u30ca\u30fc\u5411\u3051\u516c\u958b\u60c5\u5831API\u306e\u5834\u5408\u3001\u5927\u304d\u304f\u9055\u3044\u304c\u3042\u308a\u307e\u3059\u3002\n\u4f8b\u3048\u3070\u3001\u8a8d\u8a3c\u306e\u5fc5\u8981\u304c\u3042\u308b\u4e00\u90e8\u306eAPI\u304cWeb\u306e\u5834\u5408\u3067Session\u3092\u8aad\u307f\u8fbc\u307e\u308c\u308b\u53ef\u80fd\u6027\u304c\u3042\u308a\u307e\u3059\u304c\u3001\u30a2\u30d7\u30ea\u306b\u547c\u3073\u51fa\u3055\u308b\u5834\u5408\u306fSession\u3068\u95a2\u4fc2\u3042\u308a\u307e\u305b\u3093\u3002\u4ee3\u308f\u308a\u306bOAuth\u306eAccess Token\u3067\u306e\u8a8d\u8a3c\u304c\u5fc5\u8981\u3067\u3059\u3002\u305d\u306e\u5834\u5408\u3001\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u5074\u304c\u767a\u884c\u3055\u308c\u305fSession ID\u3092\u5e38\u306b\u4fdd\u5b58\u3059\u308b\u7fa9\u52d9\u304c\u306a\u3044\u304b\u3089\u3001\u6bce\u56de\u7e70\u308a\u8fd4\u3057\u3066\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3068\u3001\u6bce\u56de\u65b0\u3057\u3044Session\u3092\u4f5c\u6210\u3053\u3068\u306b\u306a\u3063\u3066\u3057\u307e\u3044\u307e\u3057\u305f\u3002\u305d\u3046\u3059\u308b\u3068\u3001Session Store\u306b\u30b3\u30b9\u30c8\u304c\u5897\u3048\u308b\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u3002\n\u4e0b\u8a18\u306e\u4f8b\u306f\u3001\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u5074\u306eHTTP\u4f1a\u8a71\u306e\u4f8b\u306e\u4e00\u3064\u3067\u3059\u3002\n> GET /api/item/ranking HTTP/1.1\n...\n< HTTP/1.1 200 OK\n...\n< Set-Cookie: sails.sid=s%3ADw8BML5vRNwDSN8L_t2Lw40V.DOhHMvk6Z5FqkbJPjzgZesI9rtBKPBaimP0EVjB3lWU; Path=/; HttpOnly\n...\n\n> GET /api/user/profile/@me?access_token=myaccesstokenkeyxxxxxx HTTP/1.1\n...\n< HTTP/1.1 200 OK\n...\n< Set-Cookie: sails.sid=s%3ALOS8QewE8uX0tx6loLOp-vkn.zp9wsMOEBVicrenyVwnd2%2BkMCQ8c1b%2Fze%2BeVPISoNzM; Path=/; HttpOnly\n...\n\n\n> GET /api/item/ranking HTTP/1.1\n...\n< HTTP/1.1 200 OK\n...\n< Set-Cookie: sails.sid=s%3ANcNHD5g6Mig7s5VGU_wMHQzO.WJEoCBLE0BcYQaVRTH%2B3UDp6Zhz5vnK9%2BtRbH7xcOMA; Path=/; HttpOnly\n...\n\n> GET /api/user/profile/@me?access_token=myaccesstokenkeyxxxxxx HTTP/1.1\n...\n< HTTP/1.1 200 OK\n...\n< Set-Cookie: sails.sid=s%3AMroUSUAJSSuDWkpdHBNPcael.jCTQcdVjCZ%2Ff60qJat4tOTJFpNPuhcsp3TcK256XXUw; Path=/; HttpOnly\n...\n\n\n\u305d\u3053\u3067\u3001 \u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u5074\u304c\u30d6\u30e9\u30a6\u30b6\u30fc\u3067\u306f\u306a\u3044\u5834\u5408 \u306b\u3001\u6bce\u56de\u65b0\u3057\u3044Session\u306e\u4f5c\u6210\u3059\u308b\u306e\u304c\u7121\u99c4\u3060\u3068\u8a00\u3046\u554f\u984c\u3092\u6c17\u4ed8\u304d\u307e\u3057\u305f\u3002\n\n\u554f\u984c\u306e\u89e3\u6c7a\u65b9\u6cd5\n\nNode.js\u306eConnect\u30e2\u30b8\u30e5\u30fc\u30eb\u306eSession middleware\n\u8abf\u3079\u3066\u898b\u308b\u3068\u3001Session\u3092\u4f5c\u6210\u3059\u308b\u30ed\u30b8\u30c3\u30af\u306f\u3053\u3053\u3067\u3059\uff1a\nnode_modules/sails/node_modules/express/node_modules/connect/lib/middleware/session.js:246\n\n\u3064\u307e\u308a\u3001Node.js\u306eConnect\u30e2\u30b8\u30e5\u30fc\u30eb\u306eSession middleware\u3067\u3042\u308a\u307e\u3059\u3002\n    // set-cookie\n    res.on('header', function(){\n      if (!req.session) return;\n      var cookie = req.session.cookie\n        , proto = (req.headers['x-forwarded-proto'] || '').split(',')[0].toLowerCase().trim()\n        , tls = req.connection.encrypted || (trustProxy && 'https' == proto)\n        , isNew = unsignedCookie != req.sessionID;\n\n      // only send secure cookies via https\n      if (cookie.secure && !tls) return debug('not secured');\n\n      // long expires, handle expiry server-side\n      if (!isNew && cookie.hasLongExpires) return debug('already set cookie');\n\n      // browser-session length cookie\n      if (null == cookie.expires) {\n        if (!isNew) return debug('already set browser-session cookie');\n      // compare hashes and ids\n      } else if (originalHash == hash(req.session) && originalId == req.session.id) {\n        return debug('unmodified session');\n      }\n\n      var val = 's:' + signature.sign(req.sessionID, secret);\n      val = cookie.serialize(key, val);\n      debug('set-cookie %s', val);\n      res.setHeader('Set-Cookie', val);\n    });\n\n    // proxy end() to commit the session\n    var end = res.end;\n    res.end = function(data, encoding){\n      res.end = end;\n      if (!req.session) return res.end(data, encoding);\n      debug('saving');\n      req.session.resetMaxAge();\n      req.session.save(function(err){\n        if (err) console.error(err.stack);\n        debug('saved');\n        res.end(data, encoding);\n      });\n    };\n\n\n\u6ce8\u76ee\u3059\u3079\u304d\u3068\u3053\u308d\u306f\u30017\u884c\u76ee \u300cisNew\u300d \u306e\u5224\u65ad\u3067\u3059\u3002\u305d\u3057\u3066\u300137\u884c\u76ee\u306e \u300cif (!req.session)\u300d \u3082\u91cd\u8981\u3060\u3068\u601d\u3044\u307e\u3059\u3002\n\u307e\u305f\u3001\u79c1\u306eSails.js\u306e\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u306ePackage\u306f\u30ea\u30ea\u30fc\u30b9\u3059\u308b\u6642npm install\u3055\u308c\u308b\u3082\u306e\u3060\u304b\u3089\u3001\u76f4\u63a5\u306bConnect\u30e2\u30b8\u30e5\u30fc\u30eb\u306eSession middleware\u306e\u30bd\u30fc\u30b9\u30b3\u30fc\u30c9\u3092\u4fee\u6b63\u3059\u308b\u306e\u306f\u826f\u304f\u306a\u3044\u3068\u601d\u3044\u307e\u3059\u3002\n\u305d\u3057\u3066\u3001\u4e0b\u8a18\u306emiddleware\u3092\u66f8\u304d\u307e\u3057\u305f\uff1a\n\n\u554f\u984c\u3092\u89e3\u6c7a\u3059\u308b middleware\nfunction doNotCreateNewSession(pathPrefixArr) {\n  return function(req, res, next) {\n    if (isNewSession(req) && matchPathPrefixArr(req, pathPrefixArr)) {\n      // proxy end() to commit the session\n      var end = res.end;\n      res.end = function(data, encoding) {\n        res.end = end;\n        if (!req.session) {\n          return res.end(data, encoding);\n        }\n        sails.log.debug(\"res.end proxy: destory new session: \" +\n          req.sessionID);\n        req.session.destroy();\n        req.session = null;\n        res.end(data, encoding);\n      };\n    }\n    next();\n  }\n\n  function matchPathPrefixArr(req, pathPrefixArr) {\n    return pathPrefixArr.some(function(pathPrefix) {\n      return (0 == req.originalUrl.indexOf(pathPrefix))\n    })\n  }\n\n  function isNewSession(req) {\n    return req.sessionID != getSessionIdByCookie(req)\n  }\n\n  function getSessionIdByCookie(req) {\n    var secret = sails.config.session.secret,\n      key = 'sails.sid';\n\n    // grab the session cookie value and check the signature\n    var rawCookie = req.cookies[key];\n\n    // get signedCookies for backwards compat with signed cookies\n    var unsignedCookie = req.signedCookies[key];\n\n    if (!unsignedCookie && rawCookie) {\n      unsignedCookie = utils.parseSignedCookie(rawCookie, secret);\n    }\n\n    return unsignedCookie;\n  }\n\n}\n\n\nNode.js/Express.js\u306e\u4f7f\u3044\u65b9\uff1a\n      app.use(doNotCreateNewSession([\n        '/api',\n      ]));\n\nSails.js\u306e\u4f7f\u3044\u65b9\u306f\u3061\u3087\u3063\u3068\u9055\u3044\u307e\u3059\u3001customMiddleware\u306b\u3057\u307e\u3059\uff1a\n\n// config/foo.js\u3067\n/*\n * express http customMiddleware\n */\nmodule.exports = {\n  http: {\n    customMiddleware: function(app) {\n//...\n      app.use(doNotCreateNewSession([\n        '/api',\n      ]));\n//....\n\n\u4eca\u306e\u30ed\u30b8\u30c3\u30af\u306f\u3001\u6700\u521dSession middleware\u3092\u5b9f\u884c\u3057\u3066\u3001Session\u3092\u4f5c\u6210\u3057\u305f\u3051\u3069\u3001\u305d\u306edoNotCreateNewSession middleware\u3092\u5b9f\u884c\u3059\u308b\u6642\u3001\u3053\u306e\u30bf\u30a4\u30df\u30f3\u30b0\u3067session\u3092destroy\u3059\u308b\u306e\u3067\u3059\u3002\uff08Session Store\u306e\u30b3\u30b9\u30c8\u3092\u304b\u304b\u3089\u306a\u3044\u3088\u3046\u306b\u3057\u307e\u3059\uff09\n\u305d\u3046\u3059\u308b\u3068\u3001\u4e0b\u8a18\u306e\u76ee\u6a19\u3092\u9054\u6210\u3057\u307e\u3057\u305f\uff1a\n\n\n\nPath\n\u7a2e\u985e\n\u76ee\u6a19\n\n\n\n\n/\u3001/login\u3001/my/book\nWeb\u30da\u30fc\u30b8\nSession\u304c\u30a2\u30af\u30bb\u30b9\u51fa\u6765\u307e\u3059\u3002\u65b0\u3057\u3044Session\u3082\u4f5c\u6210\u51fa\u6765\u307e\u3059\u3002\n\n\n/api/item/ranking/api/user/profile/@me\n\nAPI\nSession\u304c\u30a2\u30af\u30bb\u30b9\u51fa\u6765\u307e\u3059\u3002\u4f46\u3057\u3001\u65b0\u3057\u3044Session\u304c\u4f5c\u6210\u51fa\u6765\u307e\u305b\u3093\u3002\n\n\n\n\n\u30c6\u30b9\u30c8\n# \u65b0\u3057\u3044Session\u3092\u4f5c\u6210\u3059\u308b\n\u279c   curl -v http://127.0.0.1:1337/ 2>&1 |grep Set-Cookie\n< Set-Cookie: sails.sid=s%3AQIUUfdKRxecI7Hz8ejamoQLW.9SxuJuuiltb%2BG4hz8Ks%2FNk6%2FiQ%2BubA5n0zydjTW54P8; Path=/; HttpOnly\n\n# \u65b0\u3057\u3044Session\u3092\u4f5c\u6210\u3059\u3079\u304d\u3067\u306f\u306a\u3044\n\u279c   curl -v http://127.0.0.1:1337/api/ 2>&1 |grep Set-Cookie\n\n# req.session\u3092\u5229\u7528\u3059\u308b\n\u279c   curl -v http://127.0.0.1:1337/api/ -H \"Cookie: sails.sid=s%3AQIUUfdKRxecI7Hz8ejamoQLW.9SxuJuuiltb%2BG4hz8Ks%2FNk6%2FiQ%2BubA5n0zydjTW54P8\" 2>&1 |grep Set-Cookie\n\n\n\u3053\u308c\u3067\u554f\u984c\u3092\u89e3\u6c7a\u6e08\u307f\u307e\u3057\u305f\u3002\n\n\u7d9a\u3044\u3066\n\u3082\u3063\u3068\u826f\u3044\u65b9\u6cd5\u306f\u3001Node.js\u3092Connect\u30e2\u30b8\u30e5\u30fc\u30eb\u3092Fork\u3057\u3066\u3001Session middleware\u306e\u30a4\u30f3\u30bf\u30d5\u30a7\u30fc\u30b9\u3092\u3053\u3093\u306a\u3088\u3046\u306b\u4fee\u6b63\u3057\u307e\u3059\uff1a\n  session({doNotCreateIn:[\"/api\", \"/restful\"]})\n\n\u307e\u3042\u3001\u6687\u306a\u3089\u7d9a\u3044\u3066\u9811\u5f35\u308a\u305f\u3044\u3068\u601d\u3044\u307e\u3059\u3002\nPS: \u540c\u50da\u305f\u3061\u306e\u9234\u6728\u3055\u3093\u3001\u5c71\u672c\u3055\u3093\u3001 \u65e5\u672c\u8a9e\u3092\u4e01\u5be7\u306b\u4fee\u6b63\u3057\u3066\u304f\u308c\u3066 \u3001\u3042\u308a\u304c\u3068\u3046\u3054\u3056\u3044\u307e\u3057\u305f\u3002\n\n## Sails.js\u3068\u306f\n\n\u6700\u8fd1\u7b46\u8005\u306fNode.js\u306e\u300cSails.js\u300d\u3068\u3044\u3046\u30d5\u30ec\u30fc\u30e0\u30ef\u30fc\u30af\u3092\u5229\u7528\u3057\u3066\u65b0\u3057\u3044\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u3092\u69cb\u7bc9\u3057\u3066\u3044\u307e\u3059\u3002Sails.js\u306fExpress.js\u3092\u57fa\u3044\u3066\u3001\u66f4\u306bWebSocket\u30fbRESTFul API\u30fbMVC\u30fbORM\u306a\u3069\u69d8\u3005\u306a\u6280\u8853\u3092\u542b\u3081\u3001\u975e\u5e38\u306b\u4fbf\u5229\u306a\u306e\u3067\u3001\u3055\u3059\u304c\u300c\u73fe\u4ee3\u7684\u306a\u30d5\u30ec\u30fc\u30e0\u30ef\u30fc\u30af\u300d\u3068\u8a00\u3048\u307e\u3059\u3002\n\n\u4eca\u56de\u306fSession\u3092\u7121\u99c4\u9063\u3044\u3057\u3066\u3057\u307e\u3046\u8a71\u3092\u3057\u307e\u3057\u3087\u3046\u3002\n\n## Session\u306e\u7121\u99c4\u306b\u4f7f\u3046\u554f\u984c\n\n\u666e\u901a\u306eWeb Site\u3067\u3001\u4e0b\u8a18\u306e\u3088\u3046\u306aURL Path\u304c\u3042\u308a\u307e\u3059\u3002\n\n| Path                  | Method  | Memo               \n|:----------------------|:--------|:------------------|\n| /\u3001/login\u3001/my/book    | GET     |  Web\u30da\u30fc\u30b8<br/>\u6a5f\u80fd\u306b\u3088\u3063\u3066Session\u3092\u4f7f\u3046\u53ef\u80fd\u6027\u304c\u3042\u308a\u307e\u3059\u3002\n| /api/item/ranking     | GET     |  \u516c\u958b\u60c5\u5831<br/>Web\u3068\u30a2\u30d7\u30ea\u5411\u3051API<br/>Session\u3068\u95a2\u4fc2\u3042\u308a\u307e\u305b\u3093\u3002\n| /api/user/profile/@me | GET/PUT |  \u500b\u4eba\u60c5\u5831<br/>Web\u3068\u30a2\u30d7\u30ea\u5411\u3051API<br/>\u8a8d\u8a3c\u306b\u95a2\u3059\u308bSession\uff0fOAuth\u3068\u95a2\u4fc2\u3042\u308a\u307e\u3059\u3002\n\n### Web\u30da\u30fc\u30b8\u3068\u30d6\u30e9\u30a6\u30b6\u30fc\u306e\u5834\u5408\n\n\u4e0a\u8a18\u5185\u5bb9\u306b\u3088\u308b\u3068\u3001Session\u3092\u6700\u3082\u5229\u7528\u3059\u3079\u304d\u6240\u306fWeb\u30da\u30fc\u30b8\u3067\u3059\u3002\u30e6\u30fc\u30b6\u30fc\u304c\u6700\u521d\u306bWeb\u30da\u30fc\u30b8\u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3068\u3001\u65b0\u3057\u3044Session\u3092\u4f5c\u6210\u3057\u3066\u3001Session\u306e\u5185\u5bb9\u306fSession Store\u306b\u4fdd\u5b58\u3059\u308b(Memcache\u30fbRedis\u7b49)\u3002\u65b0\u3057\u3044Session ID\u306fCookie\u306e\u5f62\u3067User Agent\u306b\u767a\u884c\u3057\u3066\u3001\u4fdd\u5b58\u3055\u308c\u307e\u3059\u3002\n\n\u4f8b\u3048\u3070\u3001\n\n```bash\ncurl -v http://127.0.0.1:1337/login > /dev/null\n> GET /login HTTP/1.1\n...\n< HTTP/1.1 200 OK\n< X-Powered-By: Sails <sailsjs.org>\n...\n< Set-Cookie: sails.sid=s%3AvX4jELukbYhzct43etS21uRU.apwQfFIzp1bpAgvTYaIfx%2FaheTw%2B0DoLKQV52a98uEg; Path=/; HttpOnly\n...\n```\nUser Agent\u304c\u5e38\u306b\u305d\u306eCookie\u3092\u4fdd\u6709\u3057\u3066\u3044\u307e\u3059\u304b\u3089\u3001\u30b5\u30fc\u30d0\u30fc\u5074\u3068\u306e\u901a\u4fe1\u72b6\u614b\u3092\u3046\u307e\u304f\u4fdd\u6709\u3057\u307e\u3059\u3002\n\u305d\u3057\u3066\u3001\u901a\u4fe1\u671f\u9593\u5185\u306b\u4e00\u3064Cookie\u304cSession ID\u3092\u4fdd\u6709\u3057\u307e\u3002\u3064\u307e\u308a\u3001\u30b5\u30fc\u30d0\u30fc\u5074Session Store\u3082\u4e00\u3064\u3057\u304b\u306a\u3044\u304b\u3089\u3001Session\u3092\u7121\u99c4\u306b\u4f7f\u3046\u3053\u3068\u3067\u306f\u3042\u308a\u307e\u305b\u3093\u3002\n\n### \u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u5074\u304c\u30d6\u30e9\u30a6\u30b6\u30fc\u3067\u306f\u306a\u3044\u5834\u5408\n\n\u4f46\u3057\u3001\u30a2\u30d7\u30ea\u5411\u3051API\u3084\u3001\u5916\u90e8\u30d1\u30fc\u30c8\u30ca\u30fc\u5411\u3051\u516c\u958b\u60c5\u5831API\u306e\u5834\u5408\u3001\u5927\u304d\u304f\u9055\u3044\u304c\u3042\u308a\u307e\u3059\u3002\n\n\u4f8b\u3048\u3070\u3001\u8a8d\u8a3c\u306e\u5fc5\u8981\u304c\u3042\u308b\u4e00\u90e8\u306eAPI\u304cWeb\u306e\u5834\u5408\u3067Session\u3092\u8aad\u307f\u8fbc\u307e\u308c\u308b\u53ef\u80fd\u6027\u304c\u3042\u308a\u307e\u3059\u304c\u3001\u30a2\u30d7\u30ea\u306b\u547c\u3073\u51fa\u3055\u308b\u5834\u5408\u306fSession\u3068\u95a2\u4fc2\u3042\u308a\u307e\u305b\u3093\u3002\u4ee3\u308f\u308a\u306bOAuth\u306eAccess Token\u3067\u306e\u8a8d\u8a3c\u304c\u5fc5\u8981\u3067\u3059\u3002\u305d\u306e\u5834\u5408\u3001\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u5074\u304c\u767a\u884c\u3055\u308c\u305fSession ID\u3092\u5e38\u306b\u4fdd\u5b58\u3059\u308b\u7fa9\u52d9\u304c\u306a\u3044\u304b\u3089\u3001\u6bce\u56de\u7e70\u308a\u8fd4\u3057\u3066\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3068\u3001\u6bce\u56de\u65b0\u3057\u3044Session\u3092\u4f5c\u6210\u3053\u3068\u306b\u306a\u3063\u3066\u3057\u307e\u3044\u307e\u3057\u305f\u3002\u305d\u3046\u3059\u308b\u3068\u3001Session Store\u306b\u30b3\u30b9\u30c8\u304c\u5897\u3048\u308b\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u3002\n\n\u4e0b\u8a18\u306e\u4f8b\u306f\u3001\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u5074\u306eHTTP\u4f1a\u8a71\u306e\u4f8b\u306e\u4e00\u3064\u3067\u3059\u3002\n\n```bash\n> GET /api/item/ranking HTTP/1.1\n...\n< HTTP/1.1 200 OK\n...\n< Set-Cookie: sails.sid=s%3ADw8BML5vRNwDSN8L_t2Lw40V.DOhHMvk6Z5FqkbJPjzgZesI9rtBKPBaimP0EVjB3lWU; Path=/; HttpOnly\n...\n\n> GET /api/user/profile/@me?access_token=myaccesstokenkeyxxxxxx HTTP/1.1\n...\n< HTTP/1.1 200 OK\n...\n< Set-Cookie: sails.sid=s%3ALOS8QewE8uX0tx6loLOp-vkn.zp9wsMOEBVicrenyVwnd2%2BkMCQ8c1b%2Fze%2BeVPISoNzM; Path=/; HttpOnly\n...\n\n\n> GET /api/item/ranking HTTP/1.1\n...\n< HTTP/1.1 200 OK\n...\n< Set-Cookie: sails.sid=s%3ANcNHD5g6Mig7s5VGU_wMHQzO.WJEoCBLE0BcYQaVRTH%2B3UDp6Zhz5vnK9%2BtRbH7xcOMA; Path=/; HttpOnly\n...\n\n> GET /api/user/profile/@me?access_token=myaccesstokenkeyxxxxxx HTTP/1.1\n...\n< HTTP/1.1 200 OK\n...\n< Set-Cookie: sails.sid=s%3AMroUSUAJSSuDWkpdHBNPcael.jCTQcdVjCZ%2Ff60qJat4tOTJFpNPuhcsp3TcK256XXUw; Path=/; HttpOnly\n...\n\n```\n\n\u305d\u3053\u3067\u3001 _\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u5074\u304c\u30d6\u30e9\u30a6\u30b6\u30fc\u3067\u306f\u306a\u3044\u5834\u5408_ \u306b\u3001\u6bce\u56de\u65b0\u3057\u3044Session\u306e\u4f5c\u6210\u3059\u308b\u306e\u304c\u7121\u99c4\u3060\u3068\u8a00\u3046\u554f\u984c\u3092\u6c17\u4ed8\u304d\u307e\u3057\u305f\u3002\n\n## \u554f\u984c\u306e\u89e3\u6c7a\u65b9\u6cd5\n\n### Node.js\u306eConnect\u30e2\u30b8\u30e5\u30fc\u30eb\u306eSession middleware\n\n\u8abf\u3079\u3066\u898b\u308b\u3068\u3001Session\u3092\u4f5c\u6210\u3059\u308b\u30ed\u30b8\u30c3\u30af\u306f\u3053\u3053\u3067\u3059\uff1a\n\n    node_modules/sails/node_modules/express/node_modules/connect/lib/middleware/session.js:246\n\n\u3064\u307e\u308a\u3001Node.js\u306eConnect\u30e2\u30b8\u30e5\u30fc\u30eb\u306eSession middleware\u3067\u3042\u308a\u307e\u3059\u3002\n\n```javascript\n    // set-cookie\n    res.on('header', function(){\n      if (!req.session) return;\n      var cookie = req.session.cookie\n        , proto = (req.headers['x-forwarded-proto'] || '').split(',')[0].toLowerCase().trim()\n        , tls = req.connection.encrypted || (trustProxy && 'https' == proto)\n        , isNew = unsignedCookie != req.sessionID;\n\n      // only send secure cookies via https\n      if (cookie.secure && !tls) return debug('not secured');\n\n      // long expires, handle expiry server-side\n      if (!isNew && cookie.hasLongExpires) return debug('already set cookie');\n\n      // browser-session length cookie\n      if (null == cookie.expires) {\n        if (!isNew) return debug('already set browser-session cookie');\n      // compare hashes and ids\n      } else if (originalHash == hash(req.session) && originalId == req.session.id) {\n        return debug('unmodified session');\n      }\n\n      var val = 's:' + signature.sign(req.sessionID, secret);\n      val = cookie.serialize(key, val);\n      debug('set-cookie %s', val);\n      res.setHeader('Set-Cookie', val);\n    });\n\n    // proxy end() to commit the session\n    var end = res.end;\n    res.end = function(data, encoding){\n      res.end = end;\n      if (!req.session) return res.end(data, encoding);\n      debug('saving');\n      req.session.resetMaxAge();\n      req.session.save(function(err){\n        if (err) console.error(err.stack);\n        debug('saved');\n        res.end(data, encoding);\n      });\n    };\n\n```\n\n\u6ce8\u76ee\u3059\u3079\u304d\u3068\u3053\u308d\u306f\u30017\u884c\u76ee *\u300cisNew\u300d* \u306e\u5224\u65ad\u3067\u3059\u3002\u305d\u3057\u3066\u300137\u884c\u76ee\u306e *\u300cif (!req.session)\u300d* \u3082\u91cd\u8981\u3060\u3068\u601d\u3044\u307e\u3059\u3002\n\n\u307e\u305f\u3001\u79c1\u306eSails.js\u306e\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u306ePackage\u306f\u30ea\u30ea\u30fc\u30b9\u3059\u308b\u6642npm install\u3055\u308c\u308b\u3082\u306e\u3060\u304b\u3089\u3001\u76f4\u63a5\u306bConnect\u30e2\u30b8\u30e5\u30fc\u30eb\u306eSession middleware\u306e\u30bd\u30fc\u30b9\u30b3\u30fc\u30c9\u3092\u4fee\u6b63\u3059\u308b\u306e\u306f\u826f\u304f\u306a\u3044\u3068\u601d\u3044\u307e\u3059\u3002\n\n\u305d\u3057\u3066\u3001\u4e0b\u8a18\u306emiddleware\u3092\u66f8\u304d\u307e\u3057\u305f\uff1a\n\n### \u554f\u984c\u3092\u89e3\u6c7a\u3059\u308b middleware\n\n```javascript\nfunction doNotCreateNewSession(pathPrefixArr) {\n  return function(req, res, next) {\n    if (isNewSession(req) && matchPathPrefixArr(req, pathPrefixArr)) {\n      // proxy end() to commit the session\n      var end = res.end;\n      res.end = function(data, encoding) {\n        res.end = end;\n        if (!req.session) {\n          return res.end(data, encoding);\n        }\n        sails.log.debug(\"res.end proxy: destory new session: \" +\n          req.sessionID);\n        req.session.destroy();\n        req.session = null;\n        res.end(data, encoding);\n      };\n    }\n    next();\n  }\n\n  function matchPathPrefixArr(req, pathPrefixArr) {\n    return pathPrefixArr.some(function(pathPrefix) {\n      return (0 == req.originalUrl.indexOf(pathPrefix))\n    })\n  }\n\n  function isNewSession(req) {\n    return req.sessionID != getSessionIdByCookie(req)\n  }\n\n  function getSessionIdByCookie(req) {\n    var secret = sails.config.session.secret,\n      key = 'sails.sid';\n\n    // grab the session cookie value and check the signature\n    var rawCookie = req.cookies[key];\n\n    // get signedCookies for backwards compat with signed cookies\n    var unsignedCookie = req.signedCookies[key];\n\n    if (!unsignedCookie && rawCookie) {\n      unsignedCookie = utils.parseSignedCookie(rawCookie, secret);\n    }\n\n    return unsignedCookie;\n  }\n\n}\n\n```\n\nNode.js/Express.js\u306e\u4f7f\u3044\u65b9\uff1a\n\n```javascript\n      app.use(doNotCreateNewSession([\n        '/api',\n      ]));\n```\n\nSails.js\u306e\u4f7f\u3044\u65b9\u306f\u3061\u3087\u3063\u3068\u9055\u3044\u307e\u3059\u3001customMiddleware\u306b\u3057\u307e\u3059\uff1a\n\n```javascript\n\n// config/foo.js\u3067\n/*\n * express http customMiddleware\n */\nmodule.exports = {\n  http: {\n    customMiddleware: function(app) {\n//...\n      app.use(doNotCreateNewSession([\n        '/api',\n      ]));\n//....\n```\n\n\u4eca\u306e\u30ed\u30b8\u30c3\u30af\u306f\u3001\u6700\u521dSession middleware\u3092\u5b9f\u884c\u3057\u3066\u3001Session\u3092\u4f5c\u6210\u3057\u305f\u3051\u3069\u3001\u305d\u306edoNotCreateNewSession middleware\u3092\u5b9f\u884c\u3059\u308b\u6642\u3001\u3053\u306e\u30bf\u30a4\u30df\u30f3\u30b0\u3067session\u3092destroy\u3059\u308b\u306e\u3067\u3059\u3002\uff08Session Store\u306e\u30b3\u30b9\u30c8\u3092\u304b\u304b\u3089\u306a\u3044\u3088\u3046\u306b\u3057\u307e\u3059\uff09\n\n\u305d\u3046\u3059\u308b\u3068\u3001\u4e0b\u8a18\u306e\u76ee\u6a19\u3092\u9054\u6210\u3057\u307e\u3057\u305f\uff1a\n\n| Path                  | \u7a2e\u985e  | \u76ee\u6a19               \n|:----------------------|:--------|:------------------|\n| /\u3001/login\u3001/my/book    | Web\u30da\u30fc\u30b8     |  Session\u304c\u30a2\u30af\u30bb\u30b9\u51fa\u6765\u307e\u3059\u3002<br/>\u65b0\u3057\u3044Session\u3082\u4f5c\u6210\u51fa\u6765\u307e\u3059\u3002\n| /api/item/ranking<br/>/api/user/profile/@me     | API     | Session\u304c<b>\u30a2\u30af\u30bb\u30b9\u51fa\u6765\u307e\u3059</b>\u3002<br/>\u4f46\u3057\u3001\u65b0\u3057\u3044Session\u304c<b>\u4f5c\u6210\u51fa\u6765\u307e\u305b\u3093</b>\u3002\n\n\n#### \u30c6\u30b9\u30c8\n```bash\n# \u65b0\u3057\u3044Session\u3092\u4f5c\u6210\u3059\u308b\n\u279c   curl -v http://127.0.0.1:1337/ 2>&1 |grep Set-Cookie\n< Set-Cookie: sails.sid=s%3AQIUUfdKRxecI7Hz8ejamoQLW.9SxuJuuiltb%2BG4hz8Ks%2FNk6%2FiQ%2BubA5n0zydjTW54P8; Path=/; HttpOnly\n\n# \u65b0\u3057\u3044Session\u3092\u4f5c\u6210\u3059\u3079\u304d\u3067\u306f\u306a\u3044\n\u279c   curl -v http://127.0.0.1:1337/api/ 2>&1 |grep Set-Cookie\n\n# req.session\u3092\u5229\u7528\u3059\u308b\n\u279c   curl -v http://127.0.0.1:1337/api/ -H \"Cookie: sails.sid=s%3AQIUUfdKRxecI7Hz8ejamoQLW.9SxuJuuiltb%2BG4hz8Ks%2FNk6%2FiQ%2BubA5n0zydjTW54P8\" 2>&1 |grep Set-Cookie\n\n```\n\n**\u3053\u308c\u3067\u554f\u984c\u3092\u89e3\u6c7a\u6e08\u307f\u307e\u3057\u305f\u3002**\n\n### \u7d9a\u3044\u3066\n\n\u3082\u3063\u3068\u826f\u3044\u65b9\u6cd5\u306f\u3001Node.js\u3092Connect\u30e2\u30b8\u30e5\u30fc\u30eb\u3092Fork\u3057\u3066\u3001Session middleware\u306e\u30a4\u30f3\u30bf\u30d5\u30a7\u30fc\u30b9\u3092\u3053\u3093\u306a\u3088\u3046\u306b\u4fee\u6b63\u3057\u307e\u3059\uff1a\n\n```javascript\n  session({doNotCreateIn:[\"/api\", \"/restful\"]})\n```\n\n\u307e\u3042\u3001\u6687\u306a\u3089\u7d9a\u3044\u3066\u9811\u5f35\u308a\u305f\u3044\u3068\u601d\u3044\u307e\u3059\u3002\n\n\nPS: \u540c\u50da\u305f\u3061\u306e\u9234\u6728\u3055\u3093\u3001\u5c71\u672c\u3055\u3093\u3001 [\u65e5\u672c\u8a9e\u3092\u4e01\u5be7\u306b\u4fee\u6b63\u3057\u3066\u304f\u308c\u3066](http://qiita.com/dulao5/items/c0b6e2a7ea16e1d9116c/revisions#revision-7) \u3001\u3042\u308a\u304c\u3068\u3046\u3054\u3056\u3044\u307e\u3057\u305f\u3002\n\n\n"}