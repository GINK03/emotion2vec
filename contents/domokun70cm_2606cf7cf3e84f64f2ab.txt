{"context": "\n\n\u3053\u306e\u30cf\u30f3\u30ba\u30aa\u30f3\u306b\u3064\u3044\u3066\n\u3053\u306e\u624b\u9806\u306f\u3001JAWS-UG CLI\u5c02\u9580\u652f\u90e8 #58 KMS\u5165\u9580\u3067\u5b9f\u65bd\u3057\u305f\u3082\u306e\u3067\u3059\u3002\n\n\u524d\u63d0\u6761\u4ef6\n\n\u5fc5\u8981\u306a\u6a29\u9650\n\u4f5c\u696d\u306b\u3042\u305f\u3063\u3066\u306f\u3001\u4ee5\u4e0b\u306e\u6a29\u9650\u3092\u6709\u3057\u305fIAM\u30e6\u30fc\u30b6\u3082\u3057\u304f\u306fIAM\u30ed\u30fc\u30eb\u3092\u5229\u7528\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\nKMS\u306b\u5bfe\u3059\u308b\u30d5\u30eb\u30b3\u30f3\u30c8\u30ed\u30fc\u30eb\u6a29\u9650\nS3\u306b\u95a2\u3059\u308b\u30d5\u30eb\u30b3\u30f3\u30c8\u30ed\u30fc\u30eb\u6a29\u9650\nSTS\u306b\u95a2\u3059\u308b\u30d5\u30eb\u30b3\u30f3\u30c8\u30ed\u30fc\u30eb\u6a29\u9650\nIAM\u306b\u95a2\u3059\u308b\u30d5\u30eb\u30b3\u30f3\u30c8\u30ed\u30fc\u30eb\u6a29\u9650\n\n\n0. \u6e96\u5099\n\n0.1. \u30ea\u30fc\u30b8\u30e7\u30f3\u3092\u6307\u5b9a\n\n\u30b3\u30de\u30f3\u30c9\nexport AWS_DEFAULT_REGION='ap-northeast-1'\n\n\n\n0.2. \u8cc7\u683c\u60c5\u5831\u3092\u78ba\u8a8d\n\n\u30b3\u30de\u30f3\u30c9\naws configure list\n\n\n\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u30d7\u30ed\u30d5\u30a1\u30a4\u30eb\u3092\u8a2d\u5b9a\u3057\u305fEC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3067\u30a2\u30af\u30bb\u30b9\u30ad\u30fc\u3092\u8a2d\u5b9a\u305b\u305a\u306b\u5b9f\u884c\u3057\u305f\u5834\u5408\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\n\n\u7d50\u679c\nName                    Value             Type    Location\n----                    -----             ----    --------\nprofile                <not set>             None    None\naccess_key     ****************RDPA         iam-role\nsecret_key     ****************9GA8         iam-role\nregion           ap-northeast-1              env    AWS_DEFAULT_REGION\n\n\n\n0.3. \u30d0\u30fc\u30b8\u30e7\u30f3\u78ba\u8a8d\n\n\u30b3\u30de\u30f3\u30c9\naws --version\n\n\n\n\u7d50\u679c\naws-cli/1.10.56 Python/2.7.10 Linux/4.4.15-25.57.amzn1.x86_64 botocore/1.4.46\n\n\n\n0.4. \u30d0\u30fc\u30b8\u30e7\u30f3\u30a2\u30c3\u30d7\uff08\u5fc5\u8981\u306b\u5fdc\u3058\u3066\uff09\n\n\u30b3\u30de\u30f3\u30c9\nsudo pip install -U awscli\n\n\n\n1. \u30ab\u30b9\u30bf\u30de\u30fc\u30de\u30b9\u30bf\u30fc\u30ad\u30fc\u306e\u4f5c\u6210\n\n1.1. \u30ad\u30fc\u306e\u4e0d\u5b58\u5728\u3092\u78ba\u8a8d\n\n\u30b3\u30de\u30f3\u30c9\naws kms list-keys\n\n\n\n\u7d50\u679c\n{\n    \"Keys\": []\n}\n\n\n\n1.2. \u30ab\u30b9\u30bf\u30de\u30fc\u30de\u30b9\u30bf\u30fc\u30ad\u30fc\u306e\u8aac\u660e\u3092\u6307\u5b9a\ndescription\u306f\u5fc5\u9808\u3067\u306f\u3042\u308a\u307e\u305b\u3093\u304c\u3001\u904b\u7528\u6642\u306b\u306f\u304d\u3061\u3093\u3068\u8a2d\u5b9a\u3057\u307e\u3057\u3087\u3046\u3002\n\n\u30b3\u30de\u30f3\u30c9\nKEY_DESCRIPTION='JAWS-UG CLI 58 KMS at Co-Edo'\n\n\n\n1.3. \u30ab\u30b9\u30bf\u30de\u30fc\u30de\u30b9\u30bf\u30fc\u30ad\u30fc\u306e\u4f5c\u6210\n\n\u5909\u6570\u306e\u78ba\u8a8d\n\n\u30b3\u30de\u30f3\u30c9\ncat << ETX\n\n    KEY_DESCRIPTION: \"${KEY_DESCRIPTION}\"\n\nETX\n\n\n\n\u7d50\u679c\n\n    KEY_DESCRIPTION: \"JAWS-UG CLI 58 KMS at Co-Edo\"\n\n\n\n\n\u30ab\u30b9\u30bf\u30de\u30fc\u30de\u30b9\u30bf\u30fc\u30ad\u30fc\u306e\u4f5c\u6210\n\n\u30b3\u30de\u30f3\u30c9\nKEY_ID=$(aws kms create-key \\\n    --description \"${KEY_DESCRIPTION}\" \\\n    --query KeyMetadata.KeyId \\\n    --output text) \\\n    && echo ${KEY_ID}\n\n\n\n\u7d50\u679c\uff08\u4f8b\uff09\n********-****-****-****-************\n\n\n\n1.4. \u30ad\u30fc\u306e\u5b58\u5728\u78ba\u8a8d\n\n\u30b3\u30de\u30f3\u30c9\naws kms list-keys \\\n    --query \"Keys[?KeyId == \\`${KEY_ID}\\`]\"\n\n\n\n\u7d50\u679c\n{\n    \"Keys\": [\n        {\n            \"KeyArn\": \"arn:aws:kms:ap-northeast-1:************:key/********-****-****-****-************\",\n            \"KeyId\": \"********-****-****-****-************\"\n        }\n    ]\n}\n\n\n\n1.5. \u30ad\u30fc\u306e\u78ba\u8a8d\n\n\u30b3\u30de\u30f3\u30c9\naws kms describe-key \\\n    --key-id ${KEY_ID}\n\n\n\n\u7d50\u679c\n{\n    \"KeyMetadata\": {\n        \"KeyId\": \"********-****-****-****-************\",\n        \"Description\": \"JAWS-UG CLI 58 KMS at Co-Edo\",\n        \"Enabled\": true,\n        \"KeyUsage\": \"ENCRYPT_DECRYPT\",\n        \"KeyState\": \"Enabled\",\n        \"CreationDate\": 1467540748.716,\n        \"Arn\": \"arn:aws:kms:ap-northeast-1:************:key/********-****-****-****-************\",\n        \"AWSAccountId\": \"************\"\n    }\n}\n\n\n\n1.6. \u30a8\u30a4\u30ea\u30a2\u30b9\u540d\u306e\u6307\u5b9a\nCMK\u3092\u8b58\u5225\u3059\u308b\u969b\u3001KeyId\u306e\u4ee5\u5916\u306bAlias\u3092\u6307\u5b9a\u3059\u308b\u3053\u3068\u304c\u53ef\u80fd\u3067\u3059\u3002\n\n\u30b3\u30de\u30f3\u30c9\nALIAS=\"alias/cli-handson0800\"\n\n\n\n1.7.  \u30a8\u30a4\u30ea\u30a2\u30b9\u306e\u4f5c\u6210\n\n\u5909\u6570\u306e\u78ba\u8a8d\n\n\u30b3\u30de\u30f3\u30c9\ncat << ETX\n\n    ALIAS: ${ALIAS}\n    KEY_ID: ${KEY_ID}\n\nETX\n\n\n\n\u7d50\u679c\n\n    ALIAS: alias/cli-handson08015\n    KEY_ID: ********-****-****-****-************\n\n\n\n\n\u30a8\u30a4\u30ea\u30a2\u30b9\u306e\u4f5c\u6210\n\n\u30b3\u30de\u30f3\u30c9\naws kms create-alias \\\n    --alias-name ${ALIAS} \\\n    --target-key-id ${KEY_ID}\n\n\n\n\u7d50\u679c\n\uff08\u8fd4\u5024\u7121\u3057\uff09\n\n\n\n1.8. \u30a8\u30a4\u30ea\u30a2\u30b9\u306e\u78ba\u8a8d\n\n\u30b3\u30de\u30f3\u30c9\naws kms list-aliases \\\n    --query \"Aliases[?TargetKeyId == \\`${KEY_ID}\\`]\"\n\n\n\n\u7d50\u679c\n{\n    \"Aliases\": [\n        {\n            \"AliasArn\": \"arn:aws:kms:ap-northeast-1:************:alias/cli-handson01\",\n            \"AliasName\": \"alias/cli-handson01\",\n            \"TargetKeyId\": \"********-****-****-****-************\"\n        }\n    ]\n}\n\n\n\n2. \u30e6\u30fc\u30b6\u306e\u4f5c\u6210\nKMS\u306b\u3088\u308b\u30e6\u30fc\u30b6\u64cd\u4f5c\u3092\u884c\u3046\u305f\u3081\u306eIAM\u30e6\u30fc\u30b6\u3092\u5b9a\u7fa9\u3057\u307e\u3059\u3002\n\u3053\u306e\u30b7\u30ca\u30ea\u30aa\u3067\u306f\u3001\u30c7\u30fc\u30bf\u30ad\u30fc\u3092\u53d6\u308a\u6271\u3046\u4e00\u822c\u30e6\u30fc\u30b6\u3068\u3001CMK\u306e\u7ba1\u7406\u3092\u884c\u3046\u7ba1\u7406\u8005\u30e6\u30fc\u30b6\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\u3053\u308c\u3089\u306e\u30e6\u30fc\u30b6\u306b\u5bfe\u3057\u3001KMS\u306b\u95a2\u3059\u308b\u6a29\u9650\u3092IAM\u3067\u306f\u4ed8\u4e0e\u305b\u305a\u3001KMS\u5074\u3067\u30b3\u30f3\u30c8\u30ed\u30fc\u30eb\u3057\u307e\u3059\u3002\n\uff08\u8a73\u7d30\u306f\u5f8c\u8ff0\u3057\u307e\u3059\u3002\uff09\n\n2.1. \u7ba1\u7406\u30e6\u30fc\u30b6\u540d\u306e\u6307\u5b9a\n\n\u30b3\u30de\u30f3\u30c9\nADMIN_NAME='jawsug-cli-admin'\n\n\n\n2.2. \u7ba1\u7406\u30e6\u30fc\u30b6\u306e\u4e0d\u5b58\u5728\u3092\u78ba\u8a8d\n\n\u30b3\u30de\u30f3\u30c9\naws iam get-user \\\n    --user-name ${ADMIN_NAME}\n\n\n\n\u7d50\u679c\nAn error occurred (NoSuchEntity) when calling the GetUser operation: The user with name jawsug-cli-admin cannot be found.\n\n\n\n2.3. \u7ba1\u7406\u30e6\u30fc\u30b6\u306e\u4f5c\u6210\n\n\u5909\u6570\u306e\u78ba\u8a8d\n\n\u30b3\u30de\u30f3\u30c9\ncat << ETX\n\n    ADMIN_NAME: ${ADMIN_NAME}\n\nETX\n\n\n\n\u7d50\u679c\n\n    ADMIN_NAME: jawsug-cli-admin\n\n\n\n\n\u7ba1\u7406\u30e6\u30fc\u30b6\u306e\u4f5c\u6210\n\n\u30b3\u30de\u30f3\u30c9\naws iam create-user \\\n    --user-name ${ADMIN_NAME}\n\n\n\n\u7d50\u679c\n{\n    \"User\": {\n        \"UserName\": \"jawsug-cli-admin\",\n        \"Path\": \"/\",\n        \"CreateDate\": \"2016-07-23T06:59:00.482Z\",\n        \"UserId\": \"A********************\",\n        \"Arn\": \"arn:aws:iam::************:user/jawsug-cli-admin\"\n    }\n}\n\n\n\n2.4. \u5b9f\u884c\u7d50\u679c\u306e\u78ba\u8a8d\n\n\u30b3\u30de\u30f3\u30c9\naws iam get-user \\\n    --user-name ${ADMIN_NAME}\n\n\n\n\u7d50\u679c\n{\n    \"User\": {\n        \"UserName\": \"jawsug-cli-admin\",\n        \"Path\": \"/\",\n        \"CreateDate\": \"2016-08-01T09:22:14Z\",\n        \"UserId\": \"A********************\",\n        \"Arn\": \"arn:aws:iam::************:user/jawsug-cli-admin\"\n    }\n}\n\n\n\n2.5. \u5229\u7528\u30e6\u30fc\u30b6\u540d\u306e\u6307\u5b9a\n\n\u30b3\u30de\u30f3\u30c9\nUSER_NAME='jawsug-cli-user'\n\n\n\n2.6. \u5229\u7528\u30e6\u30fc\u30b6\u306e\u4e0d\u5b58\u5728\u3092\u78ba\u8a8d\n\n\u30b3\u30de\u30f3\u30c9\naws iam get-user \\\n    --user-name ${USER_NAME}\n\n\n\n\u7d50\u679c\nAn error occurred (NoSuchEntity) when calling the GetUser operation: The user with name jawsug-cli-user cannot be found.\n\n\n\n2.7. \u5229\u7528\u30e6\u30fc\u30b6\u306e\u4f5c\u6210\n\n\u5909\u6570\u306e\u78ba\u8a8d\n\n\u30b3\u30de\u30f3\u30c9\ncat << ETX\n\n    USER_NAME: ${USER_NAME}\n\nETX\n\n\n\n\u7d50\u679c\n\n    USER_NAME: jawsug-cli-user\n\n\n\n\n\u5229\u7528\u30e6\u30fc\u30b6\u306e\u4f5c\u6210\n\n\u30b3\u30de\u30f3\u30c9\naws iam create-user \\\n    --user-name ${USER_NAME}\n\n\n\n\u7d50\u679c\n{\n    \"User\": {\n        \"UserName\": \"jawsug-cli-user\",\n        \"Path\": \"/\",\n        \"CreateDate\": \"2016-07-23T07:00:59.402Z\",\n        \"UserId\": \"A********************\",\n        \"Arn\": \"arn:aws:iam::************:user/jawsug-cli-user\"\n    }\n}\n\n\n\n2.8. \u5b9f\u884c\u7d50\u679c\u306e\u78ba\u8a8d\n\n\u30b3\u30de\u30f3\u30c9\naws iam get-user \\\n    --user-name ${USER_NAME}\n\n\n\n\u7d50\u679c\n{\n    \"User\": {\n        \"UserName\": \"jawsug-cli-user\",\n        \"Path\": \"/\",\n        \"CreateDate\": \"2016-08-01T09:24:40Z\",\n        \"UserId\": \"A********************\",\n        \"Arn\": \"arn:aws:iam::************:user/jawsug-cli-user\"\n    }\n}\n\n\n\n3. \u30dd\u30ea\u30b7\u30fc\u306e\u5b9a\u7fa9\nKMS\u3067\u4f5c\u6210\u3059\u308bCMK\uff08\u30ab\u30b9\u30bf\u30de\u30fc\u30de\u30b9\u30bf\u30fc\u30ad\u30fc\uff09\u306b\u5bfe\u3057\u3066\u8a2d\u5b9a\u3059\u308b\u30dd\u30ea\u30b7\u30fc\u3092\u5b9a\u7fa9\u3057\u307e\u3059\u3002\n\uff08IAM\u30e6\u30fc\u30b6\u306b\u5bfe\u3057\u3066\u3067\u306f\u306a\u304f\u3001\u30ea\u30bd\u30fc\u30b9\u3067\u3042\u308bCMS\u306b\u5bfe\u3057\u3066\u4ed8\u4e0e\u3059\u308b\u30dd\u30ea\u30b7\u30fc\u3067\u3059\u3002\uff09\n\u5148\u306b\u4f5c\u6210\u3057\u305fIAM\u30e6\u30fc\u30b6\u306b\u5bfe\u3059\u308b\u6a29\u9650\u4ed8\u4e0e\u306f\u3001\u3053\u3053\u3067\u5b9f\u65bd\u3057\u307e\u3059\u3002\n\n3.1. AWS\u30a2\u30ab\u30a6\u30f3\u30c8ID\u306e\u7279\u5b9a\n\n\u30b3\u30de\u30f3\u30c9\nAWS_ID=$(aws sts get-caller-identity \\\n    --query Account \\\n    --output text) \\\n    && echo ${AWS_ID}\n\n\n\n\u7d50\u679c\n************\n\n\n\n3.2. \u30dd\u30ea\u30b7\u30fc\u3092\u751f\u6210\u3059\u308b\u30d5\u30a1\u30a4\u30eb\u540d\u3092\u6307\u5b9a\n\n\u30b3\u30de\u30f3\u30c9\nPOLICY_FILE='policy.json'\n\n\n\n3.3. \u30dd\u30ea\u30b7\u30fc\u306e\u751f\u6210\n\n\u5909\u6570\u306e\u78ba\u8a8d\n\n\u30b3\u30de\u30f3\u30c9\ncat << ETX\n\n    POLICY_FILE: ${POLICY_FILE}\n    AWS_ID: ${AWS_ID}\n    ADMIN_NAME: ${ADMIN_NAME}\n    USER_NAME: ${USER_NAME}\n\nETX\n\n\n\n\u7d50\u679c\n\n    POLICY_FILE: policy.json\n    AWS_ID: ************\n    ADMIN_NAME: jawsug-cli-admin\n    USER_NAME: jawsug-cli-user\n\n\n\n\n\u30dd\u30ea\u30b7\u30fc\u306e\u751f\u6210\n\u3053\u3053\u3067\u306f\u4ee5\u4e0b\u306e4\u3064\u306e\u76ee\u7684\u3092\u5b9f\u73fe\u3059\u308b\u305f\u3081\u306e\u30dd\u30ea\u30b7\u30fc\u3092\u8a18\u8f09\u3057\u3066\u3044\u307e\u3059\u3002\n\nroot\u30e6\u30fc\u30b6\u306bKMS\u306b\u95a2\u3059\u308b\u5168\u3066\u306e\u6a29\u9650\u3092\u4ed8\u4e0e\n\u7ba1\u7406\u8005\u30e6\u30fc\u30b6\u306bCMK\u3092\u7ba1\u7406\u3059\u308b\u6a29\u9650\u3092\u4ed8\u4e0e\n\u4e00\u822c\u30e6\u30fc\u30b6\u306bCMK\u3092\u5229\u7528\u3059\u308b\u6a29\u9650\u3092\u4ed8\u4e0e\n\u6c38\u7d9a\u5316\u30ea\u30bd\u30fc\u30b9\u306e\u9069\u7528\u8a31\u53ef\n\n\u4ee5\u4e0b\u306e\u8a18\u4e8b\u304c\u53c2\u8003\u306b\u306a\u308a\u307e\u3059\u3002\nAWS Key Management Service\u3067\u30ad\u30fc\u306e\u201d\u7ba1\u7406\u201d\u3068\u201d\u5229\u7528\u201d\u3092\u5206\u96e2\u3059\u308b #reinvent\n\n\u30b3\u30de\u30f3\u30c9\ncat << EOF > ${POLICY_FILE}\n{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Sid\": \"Enable IAM User Permissions\",\n      \"Effect\": \"Allow\",\n      \"Principal\": {\n        \"AWS\": [\n          \"arn:aws:iam::${AWS_ID}:root\"\n        ]\n      },\n      \"Action\": \"kms:*\",\n      \"Resource\": \"*\"\n    },\n    {\n      \"Sid\": \"Allow access for Key Administrators\",\n      \"Effect\": \"Allow\",\n      \"Principal\": {\n        \"AWS\": [\n          \"arn:aws:iam::${AWS_ID}:user/${ADMIN_NAME}\"\n        ]\n      },\n      \"Action\": [\n        \"kms:Create*\",\n        \"kms:Describe*\",\n        \"kms:Enable*\",\n        \"kms:List*\",\n        \"kms:Put*\",\n        \"kms:Update*\",\n        \"kms:Revoke*\",\n        \"kms:Disable*\",\n        \"kms:Get*\",\n        \"kms:Delete*\",\n        \"kms:ScheduleKeyDeletion\",\n        \"kms:CancelKeyDeletion\"\n      ],\n      \"Resource\": \"*\"\n    },\n    {\n      \"Sid\": \"Allow use of the key\",\n      \"Effect\": \"Allow\",\n      \"Principal\": {\n        \"AWS\": [\n          \"arn:aws:iam::${AWS_ID}:user/${USER_NAME}\"\n        ]\n      },\n      \"Action\": [\n        \"kms:Encrypt\",\n        \"kms:Decrypt\",\n        \"kms:ReEncrypt*\",\n        \"kms:GenerateDataKey*\",\n        \"kms:DescribeKey\"\n      ],\n      \"Resource\": \"*\"\n    },\n    {\n      \"Sid\": \"Allow attachment of persistent resources\",\n      \"Effect\": \"Allow\",\n      \"Principal\": {\n        \"AWS\": [\n          \"arn:aws:iam::${AWS_ID}:user/${USER_NAME}\"\n        ]\n      },\n      \"Action\": [\n        \"kms:CreateGrant\",\n        \"kms:ListGrants\",\n        \"kms:RevokeGrant\"\n      ],\n      \"Resource\": \"*\",\n      \"Condition\": {\n        \"Bool\": {\n          \"kms:GrantIsForAWSResource\": true\n        }\n      }\n    }\n  ]\n}\nEOF\n\njsonlint -q ${POLICY_FILE}\n\n\n\n3.4. \u30dd\u30ea\u30b7\u30fc\u540d\u306e\u6c7a\u5b9a\ndefault\u3092\u4f7f\u7528\u3057\u306a\u3051\u308c\u3070\u306a\u3089\u306a\u3044\u3053\u3068\u304c\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u306b\u660e\u8a18\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n\n\u30b3\u30de\u30f3\u30c9\nPOLICY_NAME=\"default\"\n\n\n\n3.5. \u30dd\u30ea\u30b7\u30fc\u306e\u8a2d\u5b9a\n\n\u5909\u6570\u306e\u78ba\u8a8d\n\n\u30b3\u30de\u30f3\u30c9\ncat << ETX\n\n    KEY_ID: ${KEY_ID}\n    POLICY_NAME: ${POLICY_NAME}\n    POLICY_FILE: ${POLICY_FILE}\n\nETX\n\n\n\n\u7d50\u679c\n\n    KEY_ID: ********-****-****-****-************\n    POLICY_NAME: default\n    POLICY_FILE: policy.json\n\n\n\n\n\u30dd\u30ea\u30b7\u30fc\u306e\u8a2d\u5b9a\n\n\u30b3\u30de\u30f3\u30c9\naws kms put-key-policy \\\n    --key-id ${KEY_ID} \\\n    --policy-name ${POLICY_NAME} \\\n    --policy file://${POLICY_FILE}\n\n\n\n\u7d50\u679c\n\uff08\u623b\u308a\u5024\u306a\u3057\uff09\n\n\n\n3.6. \u30dd\u30ea\u30b7\u30fc\u306e\u78ba\u8a8d\n\n\u30b3\u30de\u30f3\u30c9\naws kms get-key-policy \\\n    --key-id ${KEY_ID} \\\n    --policy-name ${POLICY_NAME}\n\n\n\n\u7d50\u679c\n{\n    \"Policy\": \"{\\n  \\\"Version\\\" : \\\"2012-10-17\\\",\\n  \\\"Statement\\\" : [ {\\n    \\\"Sid\\\" : \\\"Enable IAM User Permissions\\\",\\n    \\\"Effect\\\" : \\\"Allow\\\",\\n    \\\"Principal\\\" : {\\n      \\\"AWS\\\" : \\\"arn:aws:iam::************:root\\\"\\n    },\\n    \\\"Action\\\" : \\\"kms:*\\\",\\n    \\\"Resource\\\" : \\\"*\\\"\\n  }, {\\n    \\\"Sid\\\" : \\\"Allow access for Key Administrators\\\",\\n    \\\"Effect\\\" : \\\"Allow\\\",\\n    \\\"Principal\\\" : {\\n      \\\"AWS\\\" : \\\"arn:aws:iam::************:user/jawsug-cli-admin\\\"\\n    },\\n    \\\"Action\\\" : [ \\\"kms:Create*\\\", \\\"kms:Describe*\\\", \\\"kms:Enable*\\\", \\\"kms:List*\\\", \\\"kms:Put*\\\", \\\"kms:Update*\\\", \\\"kms:Revoke*\\\", \\\"kms:Disable*\\\", \\\"kms:Get*\\\", \\\"kms:Delete*\\\", \\\"kms:ScheduleKeyDeletion\\\", \\\"kms:CancelKeyDeletion\\\" ],\\n    \\\"Resource\\\" : \\\"*\\\"\\n  }, {\\n    \\\"Sid\\\" : \\\"Allow use of the key\\\",\\n    \\\"Effect\\\" : \\\"Allow\\\",\\n    \\\"Principal\\\" : {\\n      \\\"AWS\\\" : \\\"arn:aws:iam::************:user/jawsug-cli-user\\\"\\n    },\\n    \\\"Action\\\" : [ \\\"kms:Encrypt\\\", \\\"kms:Decrypt\\\", \\\"kms:ReEncrypt*\\\", \\\"kms:GenerateDataKey*\\\", \\\"kms:DescribeKey\\\" ],\\n    \\\"Resource\\\" : \\\"*\\\"\\n  }, {\\n    \\\"Sid\\\" : \\\"Allow attachment of persistent resources\\\",\\n    \\\"Effect\\\" : \\\"Allow\\\",\\n    \\\"Principal\\\" : {\\n      \\\"AWS\\\" : \\\"arn:aws:iam::************:user/jawsug-cli-user\\\"\\n    },\\n    \\\"Action\\\" : [ \\\"kms:CreateGrant\\\", \\\"kms:ListGrants\\\", \\\"kms:RevokeGrant\\\" ],\\n    \\\"Resource\\\" : \\\"*\\\",\\n    \\\"Condition\\\" : {\\n      \\\"Bool\\\" : {\\n        \\\"kms:GrantIsForAWSResource\\\" : \\\"true\\\"\\n      }\\n    }\\n  } ]\\n}\"\n}\n\n\n\u4ee5\u4e0a\n# \u3053\u306e\u30cf\u30f3\u30ba\u30aa\u30f3\u306b\u3064\u3044\u3066\n\n\u3053\u306e\u624b\u9806\u306f\u3001[JAWS-UG CLI\u5c02\u9580\u652f\u90e8 #58 KMS\u5165\u9580](https://manage.doorkeeper.jp/groups/jawsug-cli/events/41911)\u3067\u5b9f\u65bd\u3057\u305f\u3082\u306e\u3067\u3059\u3002\n\n\n# \u524d\u63d0\u6761\u4ef6\n\n## \u5fc5\u8981\u306a\u6a29\u9650\n\n\u4f5c\u696d\u306b\u3042\u305f\u3063\u3066\u306f\u3001\u4ee5\u4e0b\u306e\u6a29\u9650\u3092\u6709\u3057\u305fIAM\u30e6\u30fc\u30b6\u3082\u3057\u304f\u306fIAM\u30ed\u30fc\u30eb\u3092\u5229\u7528\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n- KMS\u306b\u5bfe\u3059\u308b\u30d5\u30eb\u30b3\u30f3\u30c8\u30ed\u30fc\u30eb\u6a29\u9650\n- S3\u306b\u95a2\u3059\u308b\u30d5\u30eb\u30b3\u30f3\u30c8\u30ed\u30fc\u30eb\u6a29\u9650\n- STS\u306b\u95a2\u3059\u308b\u30d5\u30eb\u30b3\u30f3\u30c8\u30ed\u30fc\u30eb\u6a29\u9650\n- IAM\u306b\u95a2\u3059\u308b\u30d5\u30eb\u30b3\u30f3\u30c8\u30ed\u30fc\u30eb\u6a29\u9650\n\n# 0. \u6e96\u5099\n\n## 0.1. \u30ea\u30fc\u30b8\u30e7\u30f3\u3092\u6307\u5b9a\n\n```bash:\u30b3\u30de\u30f3\u30c9\nexport AWS_DEFAULT_REGION='ap-northeast-1'\n```\n\n## 0.2. \u8cc7\u683c\u60c5\u5831\u3092\u78ba\u8a8d\n\n\n```bash:\u30b3\u30de\u30f3\u30c9\naws configure list\n```\n\n\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u30d7\u30ed\u30d5\u30a1\u30a4\u30eb\u3092\u8a2d\u5b9a\u3057\u305fEC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3067\u30a2\u30af\u30bb\u30b9\u30ad\u30fc\u3092\u8a2d\u5b9a\u305b\u305a\u306b\u5b9f\u884c\u3057\u305f\u5834\u5408\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\n\n```text:\u7d50\u679c\nName                    Value             Type    Location\n----                    -----             ----    --------\nprofile                <not set>             None    None\naccess_key     ****************RDPA         iam-role\nsecret_key     ****************9GA8         iam-role\nregion           ap-northeast-1              env    AWS_DEFAULT_REGION\n```\n\n## 0.3. \u30d0\u30fc\u30b8\u30e7\u30f3\u78ba\u8a8d\n\n```bash:\u30b3\u30de\u30f3\u30c9\naws --version\n```\n\n```text:\u7d50\u679c\naws-cli/1.10.56 Python/2.7.10 Linux/4.4.15-25.57.amzn1.x86_64 botocore/1.4.46\n```\n\n## 0.4. \u30d0\u30fc\u30b8\u30e7\u30f3\u30a2\u30c3\u30d7\uff08\u5fc5\u8981\u306b\u5fdc\u3058\u3066\uff09\n\n```bash:\u30b3\u30de\u30f3\u30c9\nsudo pip install -U awscli\n```\n\n# 1. \u30ab\u30b9\u30bf\u30de\u30fc\u30de\u30b9\u30bf\u30fc\u30ad\u30fc\u306e\u4f5c\u6210\n\n## 1.1. \u30ad\u30fc\u306e\u4e0d\u5b58\u5728\u3092\u78ba\u8a8d\n\n```bash:\u30b3\u30de\u30f3\u30c9\naws kms list-keys\n```\n\n```json:\u7d50\u679c\n{\n    \"Keys\": []\n}\n```\n\n## 1.2. \u30ab\u30b9\u30bf\u30de\u30fc\u30de\u30b9\u30bf\u30fc\u30ad\u30fc\u306e\u8aac\u660e\u3092\u6307\u5b9a\n\ndescription\u306f\u5fc5\u9808\u3067\u306f\u3042\u308a\u307e\u305b\u3093\u304c\u3001\u904b\u7528\u6642\u306b\u306f\u304d\u3061\u3093\u3068\u8a2d\u5b9a\u3057\u307e\u3057\u3087\u3046\u3002\n\n```bash:\u30b3\u30de\u30f3\u30c9\nKEY_DESCRIPTION='JAWS-UG CLI 58 KMS at Co-Edo'\n```\n\n## 1.3. \u30ab\u30b9\u30bf\u30de\u30fc\u30de\u30b9\u30bf\u30fc\u30ad\u30fc\u306e\u4f5c\u6210\n\n### \u5909\u6570\u306e\u78ba\u8a8d\n\n```bash:\u30b3\u30de\u30f3\u30c9\ncat << ETX\n\n    KEY_DESCRIPTION: \"${KEY_DESCRIPTION}\"\n\nETX\n```\n\n```text:\u7d50\u679c\n\n    KEY_DESCRIPTION: \"JAWS-UG CLI 58 KMS at Co-Edo\"\n\n```\n\n### \u30ab\u30b9\u30bf\u30de\u30fc\u30de\u30b9\u30bf\u30fc\u30ad\u30fc\u306e\u4f5c\u6210\n\n```bash:\u30b3\u30de\u30f3\u30c9\nKEY_ID=$(aws kms create-key \\\n    --description \"${KEY_DESCRIPTION}\" \\\n    --query KeyMetadata.KeyId \\\n    --output text) \\\n    && echo ${KEY_ID}\n```\n\n```text:\u7d50\u679c\uff08\u4f8b\uff09\n********-****-****-****-************\n```\n\n## 1.4. \u30ad\u30fc\u306e\u5b58\u5728\u78ba\u8a8d\n\n```bash:\u30b3\u30de\u30f3\u30c9\naws kms list-keys \\\n    --query \"Keys[?KeyId == \\`${KEY_ID}\\`]\"\n```\n\n```json:\u7d50\u679c\n{\n    \"Keys\": [\n        {\n            \"KeyArn\": \"arn:aws:kms:ap-northeast-1:************:key/********-****-****-****-************\",\n            \"KeyId\": \"********-****-****-****-************\"\n        }\n    ]\n}\n```\n\n## 1.5. \u30ad\u30fc\u306e\u78ba\u8a8d\n\n```bash:\u30b3\u30de\u30f3\u30c9\naws kms describe-key \\\n    --key-id ${KEY_ID}\n```\n\n```json:\u7d50\u679c\n{\n    \"KeyMetadata\": {\n        \"KeyId\": \"********-****-****-****-************\",\n        \"Description\": \"JAWS-UG CLI 58 KMS at Co-Edo\",\n        \"Enabled\": true,\n        \"KeyUsage\": \"ENCRYPT_DECRYPT\",\n        \"KeyState\": \"Enabled\",\n        \"CreationDate\": 1467540748.716,\n        \"Arn\": \"arn:aws:kms:ap-northeast-1:************:key/********-****-****-****-************\",\n        \"AWSAccountId\": \"************\"\n    }\n}\n```\n\n## 1.6. \u30a8\u30a4\u30ea\u30a2\u30b9\u540d\u306e\u6307\u5b9a\n\nCMK\u3092\u8b58\u5225\u3059\u308b\u969b\u3001KeyId\u306e\u4ee5\u5916\u306bAlias\u3092\u6307\u5b9a\u3059\u308b\u3053\u3068\u304c\u53ef\u80fd\u3067\u3059\u3002\n\n```bash:\u30b3\u30de\u30f3\u30c9\nALIAS=\"alias/cli-handson0800\"\n```\n\n## 1.7.  \u30a8\u30a4\u30ea\u30a2\u30b9\u306e\u4f5c\u6210\n\n### \u5909\u6570\u306e\u78ba\u8a8d\n\n```bash:\u30b3\u30de\u30f3\u30c9\ncat << ETX\n\n    ALIAS: ${ALIAS}\n    KEY_ID: ${KEY_ID}\n\nETX\n```\n\n```text:\u7d50\u679c\n\n    ALIAS: alias/cli-handson08015\n    KEY_ID: ********-****-****-****-************\n\n```\n\n### \u30a8\u30a4\u30ea\u30a2\u30b9\u306e\u4f5c\u6210\n\n```bash:\u30b3\u30de\u30f3\u30c9\naws kms create-alias \\\n    --alias-name ${ALIAS} \\\n    --target-key-id ${KEY_ID}\n```\n\n```text:\u7d50\u679c\n\uff08\u8fd4\u5024\u7121\u3057\uff09\n```\n\n## 1.8. \u30a8\u30a4\u30ea\u30a2\u30b9\u306e\u78ba\u8a8d\n\n```bash:\u30b3\u30de\u30f3\u30c9\naws kms list-aliases \\\n    --query \"Aliases[?TargetKeyId == \\`${KEY_ID}\\`]\"\n```\n\n```json:\u7d50\u679c\n{\n    \"Aliases\": [\n        {\n            \"AliasArn\": \"arn:aws:kms:ap-northeast-1:************:alias/cli-handson01\",\n            \"AliasName\": \"alias/cli-handson01\",\n            \"TargetKeyId\": \"********-****-****-****-************\"\n        }\n    ]\n}\n```\n\n\n# 2. \u30e6\u30fc\u30b6\u306e\u4f5c\u6210\n\nKMS\u306b\u3088\u308b\u30e6\u30fc\u30b6\u64cd\u4f5c\u3092\u884c\u3046\u305f\u3081\u306eIAM\u30e6\u30fc\u30b6\u3092\u5b9a\u7fa9\u3057\u307e\u3059\u3002\n\n\u3053\u306e\u30b7\u30ca\u30ea\u30aa\u3067\u306f\u3001\u30c7\u30fc\u30bf\u30ad\u30fc\u3092\u53d6\u308a\u6271\u3046\u4e00\u822c\u30e6\u30fc\u30b6\u3068\u3001CMK\u306e\u7ba1\u7406\u3092\u884c\u3046\u7ba1\u7406\u8005\u30e6\u30fc\u30b6\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n\u3053\u308c\u3089\u306e\u30e6\u30fc\u30b6\u306b\u5bfe\u3057\u3001KMS\u306b\u95a2\u3059\u308b\u6a29\u9650\u3092IAM\u3067\u306f\u4ed8\u4e0e\u305b\u305a\u3001KMS\u5074\u3067\u30b3\u30f3\u30c8\u30ed\u30fc\u30eb\u3057\u307e\u3059\u3002\n\uff08\u8a73\u7d30\u306f\u5f8c\u8ff0\u3057\u307e\u3059\u3002\uff09\n\n## 2.1. \u7ba1\u7406\u30e6\u30fc\u30b6\u540d\u306e\u6307\u5b9a\n\n```bash:\u30b3\u30de\u30f3\u30c9\nADMIN_NAME='jawsug-cli-admin'\n```\n\n## 2.2. \u7ba1\u7406\u30e6\u30fc\u30b6\u306e\u4e0d\u5b58\u5728\u3092\u78ba\u8a8d\n\n```bash:\u30b3\u30de\u30f3\u30c9\naws iam get-user \\\n    --user-name ${ADMIN_NAME}\n```\n\n```text:\u7d50\u679c\nAn error occurred (NoSuchEntity) when calling the GetUser operation: The user with name jawsug-cli-admin cannot be found.\n```\n\n## 2.3. \u7ba1\u7406\u30e6\u30fc\u30b6\u306e\u4f5c\u6210\n\n### \u5909\u6570\u306e\u78ba\u8a8d\n\n```bash:\u30b3\u30de\u30f3\u30c9\ncat << ETX\n\n    ADMIN_NAME: ${ADMIN_NAME}\n\nETX\n```\n\n```text:\u7d50\u679c\n\n    ADMIN_NAME: jawsug-cli-admin\n\n```\n\n### \u7ba1\u7406\u30e6\u30fc\u30b6\u306e\u4f5c\u6210\n\n```bash:\u30b3\u30de\u30f3\u30c9\naws iam create-user \\\n    --user-name ${ADMIN_NAME}\n```\n\n```json:\u7d50\u679c\n{\n    \"User\": {\n        \"UserName\": \"jawsug-cli-admin\",\n        \"Path\": \"/\",\n        \"CreateDate\": \"2016-07-23T06:59:00.482Z\",\n        \"UserId\": \"A********************\",\n        \"Arn\": \"arn:aws:iam::************:user/jawsug-cli-admin\"\n    }\n}\n```\n\n## 2.4. \u5b9f\u884c\u7d50\u679c\u306e\u78ba\u8a8d\n\n```bash:\u30b3\u30de\u30f3\u30c9\naws iam get-user \\\n    --user-name ${ADMIN_NAME}\n```\n\n```json:\u7d50\u679c\n{\n    \"User\": {\n        \"UserName\": \"jawsug-cli-admin\",\n        \"Path\": \"/\",\n        \"CreateDate\": \"2016-08-01T09:22:14Z\",\n        \"UserId\": \"A********************\",\n        \"Arn\": \"arn:aws:iam::************:user/jawsug-cli-admin\"\n    }\n}\n```\n\n## 2.5. \u5229\u7528\u30e6\u30fc\u30b6\u540d\u306e\u6307\u5b9a\n\n```bash:\u30b3\u30de\u30f3\u30c9\nUSER_NAME='jawsug-cli-user'\n```\n\n## 2.6. \u5229\u7528\u30e6\u30fc\u30b6\u306e\u4e0d\u5b58\u5728\u3092\u78ba\u8a8d\n\n```bash:\u30b3\u30de\u30f3\u30c9\naws iam get-user \\\n    --user-name ${USER_NAME}\n```\n\n```text:\u7d50\u679c\nAn error occurred (NoSuchEntity) when calling the GetUser operation: The user with name jawsug-cli-user cannot be found.\n```\n\n## 2.7. \u5229\u7528\u30e6\u30fc\u30b6\u306e\u4f5c\u6210\n\n### \u5909\u6570\u306e\u78ba\u8a8d\n\n```bash:\u30b3\u30de\u30f3\u30c9\ncat << ETX\n\n    USER_NAME: ${USER_NAME}\n\nETX\n```\n\n```text:\u7d50\u679c\n\n    USER_NAME: jawsug-cli-user\n\n```\n\n### \u5229\u7528\u30e6\u30fc\u30b6\u306e\u4f5c\u6210\n\n```bash:\u30b3\u30de\u30f3\u30c9\naws iam create-user \\\n    --user-name ${USER_NAME}\n```\n\n```json:\u7d50\u679c\n{\n    \"User\": {\n        \"UserName\": \"jawsug-cli-user\",\n        \"Path\": \"/\",\n        \"CreateDate\": \"2016-07-23T07:00:59.402Z\",\n        \"UserId\": \"A********************\",\n        \"Arn\": \"arn:aws:iam::************:user/jawsug-cli-user\"\n    }\n}\n```\n\n## 2.8. \u5b9f\u884c\u7d50\u679c\u306e\u78ba\u8a8d\n\n```bash:\u30b3\u30de\u30f3\u30c9\naws iam get-user \\\n    --user-name ${USER_NAME}\n```\n\n```json:\u7d50\u679c\n{\n    \"User\": {\n        \"UserName\": \"jawsug-cli-user\",\n        \"Path\": \"/\",\n        \"CreateDate\": \"2016-08-01T09:24:40Z\",\n        \"UserId\": \"A********************\",\n        \"Arn\": \"arn:aws:iam::************:user/jawsug-cli-user\"\n    }\n}\n```\n\n# 3. \u30dd\u30ea\u30b7\u30fc\u306e\u5b9a\u7fa9\n\nKMS\u3067\u4f5c\u6210\u3059\u308bCMK\uff08\u30ab\u30b9\u30bf\u30de\u30fc\u30de\u30b9\u30bf\u30fc\u30ad\u30fc\uff09\u306b\u5bfe\u3057\u3066\u8a2d\u5b9a\u3059\u308b\u30dd\u30ea\u30b7\u30fc\u3092\u5b9a\u7fa9\u3057\u307e\u3059\u3002\n\uff08IAM\u30e6\u30fc\u30b6\u306b\u5bfe\u3057\u3066\u3067\u306f\u306a\u304f\u3001\u30ea\u30bd\u30fc\u30b9\u3067\u3042\u308bCMS\u306b\u5bfe\u3057\u3066\u4ed8\u4e0e\u3059\u308b\u30dd\u30ea\u30b7\u30fc\u3067\u3059\u3002\uff09\n\n\u5148\u306b\u4f5c\u6210\u3057\u305fIAM\u30e6\u30fc\u30b6\u306b\u5bfe\u3059\u308b\u6a29\u9650\u4ed8\u4e0e\u306f\u3001\u3053\u3053\u3067\u5b9f\u65bd\u3057\u307e\u3059\u3002\n\n## 3.1. AWS\u30a2\u30ab\u30a6\u30f3\u30c8ID\u306e\u7279\u5b9a\n\n```bash:\u30b3\u30de\u30f3\u30c9\nAWS_ID=$(aws sts get-caller-identity \\\n    --query Account \\\n    --output text) \\\n    && echo ${AWS_ID}\n```\n\n```text:\u7d50\u679c\n************\n```\n\n## 3.2. \u30dd\u30ea\u30b7\u30fc\u3092\u751f\u6210\u3059\u308b\u30d5\u30a1\u30a4\u30eb\u540d\u3092\u6307\u5b9a\n\n```bash:\u30b3\u30de\u30f3\u30c9\nPOLICY_FILE='policy.json'\n```\n\n## 3.3. \u30dd\u30ea\u30b7\u30fc\u306e\u751f\u6210\n\n### \u5909\u6570\u306e\u78ba\u8a8d\n\n```bash:\u30b3\u30de\u30f3\u30c9\ncat << ETX\n\n    POLICY_FILE: ${POLICY_FILE}\n    AWS_ID: ${AWS_ID}\n    ADMIN_NAME: ${ADMIN_NAME}\n    USER_NAME: ${USER_NAME}\n\nETX\n```\n\n```text:\u7d50\u679c\n\n    POLICY_FILE: policy.json\n    AWS_ID: ************\n    ADMIN_NAME: jawsug-cli-admin\n    USER_NAME: jawsug-cli-user\n\n```\n\n### \u30dd\u30ea\u30b7\u30fc\u306e\u751f\u6210\n\n\u3053\u3053\u3067\u306f\u4ee5\u4e0b\u306e4\u3064\u306e\u76ee\u7684\u3092\u5b9f\u73fe\u3059\u308b\u305f\u3081\u306e\u30dd\u30ea\u30b7\u30fc\u3092\u8a18\u8f09\u3057\u3066\u3044\u307e\u3059\u3002\n\n- root\u30e6\u30fc\u30b6\u306bKMS\u306b\u95a2\u3059\u308b\u5168\u3066\u306e\u6a29\u9650\u3092\u4ed8\u4e0e\n- \u7ba1\u7406\u8005\u30e6\u30fc\u30b6\u306bCMK\u3092\u7ba1\u7406\u3059\u308b\u6a29\u9650\u3092\u4ed8\u4e0e\n- \u4e00\u822c\u30e6\u30fc\u30b6\u306bCMK\u3092\u5229\u7528\u3059\u308b\u6a29\u9650\u3092\u4ed8\u4e0e\n- \u6c38\u7d9a\u5316\u30ea\u30bd\u30fc\u30b9\u306e\u9069\u7528\u8a31\u53ef\n\n\u4ee5\u4e0b\u306e\u8a18\u4e8b\u304c\u53c2\u8003\u306b\u306a\u308a\u307e\u3059\u3002\n\n[AWS Key Management Service\u3067\u30ad\u30fc\u306e\u201d\u7ba1\u7406\u201d\u3068\u201d\u5229\u7528\u201d\u3092\u5206\u96e2\u3059\u308b #reinvent](http://dev.classmethod.jp/cloud/aws/kms-admin-user/)\n\n```bash:\u30b3\u30de\u30f3\u30c9\ncat << EOF > ${POLICY_FILE}\n{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Sid\": \"Enable IAM User Permissions\",\n      \"Effect\": \"Allow\",\n      \"Principal\": {\n        \"AWS\": [\n          \"arn:aws:iam::${AWS_ID}:root\"\n        ]\n      },\n      \"Action\": \"kms:*\",\n      \"Resource\": \"*\"\n    },\n    {\n      \"Sid\": \"Allow access for Key Administrators\",\n      \"Effect\": \"Allow\",\n      \"Principal\": {\n        \"AWS\": [\n          \"arn:aws:iam::${AWS_ID}:user/${ADMIN_NAME}\"\n        ]\n      },\n      \"Action\": [\n        \"kms:Create*\",\n        \"kms:Describe*\",\n        \"kms:Enable*\",\n        \"kms:List*\",\n        \"kms:Put*\",\n        \"kms:Update*\",\n        \"kms:Revoke*\",\n        \"kms:Disable*\",\n        \"kms:Get*\",\n        \"kms:Delete*\",\n        \"kms:ScheduleKeyDeletion\",\n        \"kms:CancelKeyDeletion\"\n      ],\n      \"Resource\": \"*\"\n    },\n    {\n      \"Sid\": \"Allow use of the key\",\n      \"Effect\": \"Allow\",\n      \"Principal\": {\n        \"AWS\": [\n          \"arn:aws:iam::${AWS_ID}:user/${USER_NAME}\"\n        ]\n      },\n      \"Action\": [\n        \"kms:Encrypt\",\n        \"kms:Decrypt\",\n        \"kms:ReEncrypt*\",\n        \"kms:GenerateDataKey*\",\n        \"kms:DescribeKey\"\n      ],\n      \"Resource\": \"*\"\n    },\n    {\n      \"Sid\": \"Allow attachment of persistent resources\",\n      \"Effect\": \"Allow\",\n      \"Principal\": {\n        \"AWS\": [\n          \"arn:aws:iam::${AWS_ID}:user/${USER_NAME}\"\n        ]\n      },\n      \"Action\": [\n        \"kms:CreateGrant\",\n        \"kms:ListGrants\",\n        \"kms:RevokeGrant\"\n      ],\n      \"Resource\": \"*\",\n      \"Condition\": {\n        \"Bool\": {\n          \"kms:GrantIsForAWSResource\": true\n        }\n      }\n    }\n  ]\n}\nEOF\n\njsonlint -q ${POLICY_FILE}\n```\n\n\n## 3.4. \u30dd\u30ea\u30b7\u30fc\u540d\u306e\u6c7a\u5b9a\n\ndefault\u3092\u4f7f\u7528\u3057\u306a\u3051\u308c\u3070\u306a\u3089\u306a\u3044\u3053\u3068\u304c\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u306b\u660e\u8a18\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n\n```bash:\u30b3\u30de\u30f3\u30c9\nPOLICY_NAME=\"default\"\n```\n\n## 3.5. \u30dd\u30ea\u30b7\u30fc\u306e\u8a2d\u5b9a\n\n### \u5909\u6570\u306e\u78ba\u8a8d\n\n```bash:\u30b3\u30de\u30f3\u30c9\ncat << ETX\n\n    KEY_ID: ${KEY_ID}\n    POLICY_NAME: ${POLICY_NAME}\n    POLICY_FILE: ${POLICY_FILE}\n\nETX\n```\n\n```text:\u7d50\u679c\n\n    KEY_ID: ********-****-****-****-************\n    POLICY_NAME: default\n    POLICY_FILE: policy.json\n\n```\n\n### \u30dd\u30ea\u30b7\u30fc\u306e\u8a2d\u5b9a\n\n```bash:\u30b3\u30de\u30f3\u30c9\naws kms put-key-policy \\\n    --key-id ${KEY_ID} \\\n    --policy-name ${POLICY_NAME} \\\n    --policy file://${POLICY_FILE}\n```\n\n```text:\u7d50\u679c\n\uff08\u623b\u308a\u5024\u306a\u3057\uff09\n```\n\n## 3.6. \u30dd\u30ea\u30b7\u30fc\u306e\u78ba\u8a8d\n\n```bash:\u30b3\u30de\u30f3\u30c9\naws kms get-key-policy \\\n    --key-id ${KEY_ID} \\\n    --policy-name ${POLICY_NAME}\n```\n\n```json:\u7d50\u679c\n{\n    \"Policy\": \"{\\n  \\\"Version\\\" : \\\"2012-10-17\\\",\\n  \\\"Statement\\\" : [ {\\n    \\\"Sid\\\" : \\\"Enable IAM User Permissions\\\",\\n    \\\"Effect\\\" : \\\"Allow\\\",\\n    \\\"Principal\\\" : {\\n      \\\"AWS\\\" : \\\"arn:aws:iam::************:root\\\"\\n    },\\n    \\\"Action\\\" : \\\"kms:*\\\",\\n    \\\"Resource\\\" : \\\"*\\\"\\n  }, {\\n    \\\"Sid\\\" : \\\"Allow access for Key Administrators\\\",\\n    \\\"Effect\\\" : \\\"Allow\\\",\\n    \\\"Principal\\\" : {\\n      \\\"AWS\\\" : \\\"arn:aws:iam::************:user/jawsug-cli-admin\\\"\\n    },\\n    \\\"Action\\\" : [ \\\"kms:Create*\\\", \\\"kms:Describe*\\\", \\\"kms:Enable*\\\", \\\"kms:List*\\\", \\\"kms:Put*\\\", \\\"kms:Update*\\\", \\\"kms:Revoke*\\\", \\\"kms:Disable*\\\", \\\"kms:Get*\\\", \\\"kms:Delete*\\\", \\\"kms:ScheduleKeyDeletion\\\", \\\"kms:CancelKeyDeletion\\\" ],\\n    \\\"Resource\\\" : \\\"*\\\"\\n  }, {\\n    \\\"Sid\\\" : \\\"Allow use of the key\\\",\\n    \\\"Effect\\\" : \\\"Allow\\\",\\n    \\\"Principal\\\" : {\\n      \\\"AWS\\\" : \\\"arn:aws:iam::************:user/jawsug-cli-user\\\"\\n    },\\n    \\\"Action\\\" : [ \\\"kms:Encrypt\\\", \\\"kms:Decrypt\\\", \\\"kms:ReEncrypt*\\\", \\\"kms:GenerateDataKey*\\\", \\\"kms:DescribeKey\\\" ],\\n    \\\"Resource\\\" : \\\"*\\\"\\n  }, {\\n    \\\"Sid\\\" : \\\"Allow attachment of persistent resources\\\",\\n    \\\"Effect\\\" : \\\"Allow\\\",\\n    \\\"Principal\\\" : {\\n      \\\"AWS\\\" : \\\"arn:aws:iam::************:user/jawsug-cli-user\\\"\\n    },\\n    \\\"Action\\\" : [ \\\"kms:CreateGrant\\\", \\\"kms:ListGrants\\\", \\\"kms:RevokeGrant\\\" ],\\n    \\\"Resource\\\" : \\\"*\\\",\\n    \\\"Condition\\\" : {\\n      \\\"Bool\\\" : {\\n        \\\"kms:GrantIsForAWSResource\\\" : \\\"true\\\"\\n      }\\n    }\\n  } ]\\n}\"\n}\n```\n\n\n\u4ee5\u4e0a\n", "tags": ["AWS", "aws-cli", "kms"]}