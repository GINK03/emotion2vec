{"context": "\n\n\u5bfe\u8c61\nLINE BOT \u3092\u3068\u308a\u3042\u3048\u305a\u30bf\u30c0\u3067 Heroku \u3067\u52d5\u304b\u3059 \u3092\u53c2\u8003\u306b\u30bf\u30c0\u3067 Heroku \u3067\u52d5\u304b\u305b\u305f\u3072\u3068\u3002\nSSL\u8a3c\u660e\u66f8\u306f\u306a\u3044\u3051\u3069\u3001\u56fa\u5b9aIP\u306e\u5272\u308a\u5f53\u3066\u3089\u308c\u3066\u308b VPS \uff08\u306a\u3069\uff09\u3092\u6301\u3063\u3066\u308b\u3072\u3068\u3002\n\n\u306a\u3093\u3068\u304b\u3057\u305f\u3044\nFixie \u30d7\u30e9\u30b0\u30a4\u30f3\u306e\u6bce\u6708500\u30ea\u30af\u30a8\u30b9\u30c8\u3067\u5236\u9650\u304c\u304b\u304b\u3063\u3066\u3057\u307e\u3046\u306e\u3092\u306a\u3093\u3068\u304b\u3057\u305f\u3044\u3002\n\n\u5bfe\u7b56\nHeroku \u3067 LINE \u30b5\u30fc\u30d0\u304b\u3089\u30ea\u30af\u30a8\u30b9\u30c8\u3092\u53d7\u3051\u53d6\u3063\u3066\u30ad\u30e5\u30fc\u30a4\u30f3\u30b0\u3057\u3001VPS \u3067\u53d6\u308a\u51fa\u3057\u3066 LINE API \u306b\u30ea\u30af\u30a8\u30b9\u30c8\u3092\u6295\u3052\u308b\u3002\nFixie \u306b\u983c\u3089\u306a\u304f\u3066\u3088\u304f\u306a\u308b\u3002\n\u30ad\u30e5\u30fc\u30a4\u30f3\u30b0\u306e\u4ed5\u7d44\u307f\u306f\u3001heroku-redis \u3068 sidekiq \u3092\u4f7f\u3046\u3068\u7c21\u5358\u3002\n\uff08\u305f\u3060\u3057 heroku-redis \u306f\u307e\u308c\u306b\u63a5\u7d9a\u60c5\u5831\u304c\u5909\u308f\u308b\u306e\u3067\u3001VPS \u3067 redis \u306e\u904b\u7528\u3092\u3057\u305f\u65b9\u304c\u3088\u308a\u826f\u3055\u305d\u3046\uff09\n\n\u3084\u3063\u3066\u307f\u308b\n\u53c2\u8003\u6587\u732e\u306e\u30d7\u30ed\u30b0\u30e9\u30e0\u3092\u5143\u306b\u6539\u9020\u3057\u3066\u3044\u304f\u3002\n\u307e\u305a app.rb \u306b\u3042\u3063\u305f\u30aa\u30a6\u30e0\u8fd4\u3057\u51e6\u7406\u3092 echoback.rb \u306b\u5207\u308a\u51fa\u3059\u3002\uff08sidekiq \u306e\u8a2d\u5b9a\u3082\u3064\u3044\u3067\u306b\u304b\u304f\uff09\n\napp.rb\nrequire 'bundler/setup'\nrequire 'sinatra'\nrequire 'json'\nrequire './echoback'\n\npost '/linebot/callback' do\n  params = JSON.parse(request.body.read)\n\n  params['result'].each do |msg|\n    Echoback.perform_async(msg)\n  end\n\n  \"OK\"\nend\n\n\n\nechoback.rb\nrequire 'sidekiq'\nrequire 'httpclient'\n\nSidekiq.configure_client do |config|\n  config.redis = { url: ENV.fetch('REDIS_URL'), namespace: ENV.fetch('RACK_ENV') }\nend\n\nSidekiq.configure_server do |config|\n  config.redis = { url: ENV.fetch('REDIS_URL'), namespace: ENV.fetch('RACK_ENV') }\nend\n\nclass Echoback\n  include Sidekiq::Worker\n\n  def perform(msg)\n    request_content = {\n      to: [msg['content']['from']],\n      toChannel: 1383378250, # Fixed  value\n      eventType: \"138311608800106203\", # Fixed value\n      content: msg['content']\n    }\n\n    http_client = HTTPClient.new\n    endpoint_uri = 'https://trialbot-api.line.me/v1/events'\n    content_json = request_content.to_json\n    http_client.post_content(endpoint_uri, content_json,\n        'Content-Type' => 'application/json; charset=UTF-8',\n        'X-Line-ChannelID' => ENV[\"LINE_CHANNEL_ID\"],\n        'X-Line-ChannelSecret' => ENV[\"LINE_CHANNEL_SECRET\"],\n        'X-Line-Trusted-User-With-ACL' => ENV[\"LINE_CHANNEL_MID\"]\n      )\n  end\nend\n\n\n# A sample Gemfile\nsource \"https://rubygems.org\"\n\n# gem \"rails\"\ngem 'sinatra'\ngem 'httpclient'\n\n# gem\u30823\u3064\u8ffd\u52a0\ngem 'sidekiq'\ngem 'redis-namespace'\ngem 'dotenv'\n\n# Procfile\nweb: bundle exec ruby app.rb -p $PORT\n\n\u7d9a\u3044\u3066\u3001Heroku \u3068 VPS \u305d\u308c\u305e\u308c\u306e\u74b0\u5883\u3092\u6574\u3048\u308b\u3002\n\u3042\u3068 LINE \u306e Whitelist \u306b VPS \u306e IP \u3092\u767b\u9332\u3059\u308b\u3002\n\nHeroku\nheroku-redis \u3092\u3088\u3057\u306a\u306b\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3002\n\u3061\u306a\u307f\u306b heroku-redis \u306f\u30e1\u30e2\u30ea25MB\u307e\u3067\u7121\u6599\u67a0\u3002\n\nVPS\n\u30bd\u30fc\u30b9\u30b3\u30fc\u30c9\u3092\u3082\u3063\u3066\u304d\u3066 bundle \u3059\u308b\u3002\n.env \u3092\u3064\u304f\u308b\u3002\n$ git clone https://github.com/user/sample\n$ cd sample\n$ bundle\n$ vi .env\nLINE_CHANNEL_ID='XXXXXXXXXXX'\nLINE_CHANNEL_SECRET='XXXXXXXXXXX'\nLINE_CHANNEL_MID='XXXXXXXXXXX'\nREDIS_URL='XXXXXXXXXXX'\n\nREDIS_URL \u306f heroku config | grep REDIS \u3067\u78ba\u8a8d\u3067\u304d\u308b\u3002\n\u6700\u5f8c\u306b sidekiq \u3092\u52d5\u304b\u3059\u3002 heroku-redis \u306e\u6700\u5927\u30b3\u30cd\u30af\u30b7\u30e7\u30f3\u6570\u304c20\u306a\u306e\u3067\u3001\u305d\u308c\u306b\u53ce\u307e\u308b\u3088\u3046\u306b\u8abf\u6574\u3059\u308b\u3002\n$ bundle exec sidekiq ./echoback.rb -c 5\nor\n$ bundle exec sidekiq ./echoback.rb -c 5 -d -L /path/to/logfile\n\n\u4ee5\u4e0a\u3067\u3001LINE BOT \u306b\u8a71\u3057\u304b\u3051\u308b\u3068 Heroku \u3068 VPS \u304c\u9023\u643a\u3057\u3066\u30aa\u30a6\u30e0\u8fd4\u3057\u51e6\u7406\u3092\u3057\u3066\u304f\u308c\u308b\u3002\n# \u5bfe\u8c61\n\n[LINE BOT \u3092\u3068\u308a\u3042\u3048\u305a\u30bf\u30c0\u3067 Heroku \u3067\u52d5\u304b\u3059](http://qiita.com/yuya_takeyama/items/0660a59d13e2cd0b2516) \u3092\u53c2\u8003\u306b\u30bf\u30c0\u3067 Heroku \u3067\u52d5\u304b\u305b\u305f\u3072\u3068\u3002\nSSL\u8a3c\u660e\u66f8\u306f\u306a\u3044\u3051\u3069\u3001\u56fa\u5b9aIP\u306e\u5272\u308a\u5f53\u3066\u3089\u308c\u3066\u308b VPS \uff08\u306a\u3069\uff09\u3092\u6301\u3063\u3066\u308b\u3072\u3068\u3002\n\n# \u306a\u3093\u3068\u304b\u3057\u305f\u3044\n\n`Fixie` \u30d7\u30e9\u30b0\u30a4\u30f3\u306e\u6bce\u6708500\u30ea\u30af\u30a8\u30b9\u30c8\u3067\u5236\u9650\u304c\u304b\u304b\u3063\u3066\u3057\u307e\u3046\u306e\u3092\u306a\u3093\u3068\u304b\u3057\u305f\u3044\u3002\n\n# \u5bfe\u7b56\n\nHeroku \u3067 LINE \u30b5\u30fc\u30d0\u304b\u3089\u30ea\u30af\u30a8\u30b9\u30c8\u3092\u53d7\u3051\u53d6\u3063\u3066\u30ad\u30e5\u30fc\u30a4\u30f3\u30b0\u3057\u3001VPS \u3067\u53d6\u308a\u51fa\u3057\u3066 LINE API \u306b\u30ea\u30af\u30a8\u30b9\u30c8\u3092\u6295\u3052\u308b\u3002\n`Fixie` \u306b\u983c\u3089\u306a\u304f\u3066\u3088\u304f\u306a\u308b\u3002\n\u30ad\u30e5\u30fc\u30a4\u30f3\u30b0\u306e\u4ed5\u7d44\u307f\u306f\u3001[heroku-redis](https://elements.heroku.com/addons/heroku-redis) \u3068 [sidekiq](https://github.com/mperham/sidekiq) \u3092\u4f7f\u3046\u3068\u7c21\u5358\u3002\n\uff08\u305f\u3060\u3057 heroku-redis \u306f\u307e\u308c\u306b\u63a5\u7d9a\u60c5\u5831\u304c\u5909\u308f\u308b\u306e\u3067\u3001VPS \u3067 redis \u306e\u904b\u7528\u3092\u3057\u305f\u65b9\u304c\u3088\u308a\u826f\u3055\u305d\u3046\uff09\n\n# \u3084\u3063\u3066\u307f\u308b\n\n[\u53c2\u8003\u6587\u732e](http://qiita.com/yuya_takeyama/items/0660a59d13e2cd0b2516)\u306e\u30d7\u30ed\u30b0\u30e9\u30e0\u3092\u5143\u306b\u6539\u9020\u3057\u3066\u3044\u304f\u3002\n\u307e\u305a `app.rb` \u306b\u3042\u3063\u305f\u30aa\u30a6\u30e0\u8fd4\u3057\u51e6\u7406\u3092 `echoback.rb` \u306b\u5207\u308a\u51fa\u3059\u3002\uff08sidekiq \u306e\u8a2d\u5b9a\u3082\u3064\u3044\u3067\u306b\u304b\u304f\uff09\n\n```app.rb\nrequire 'bundler/setup'\nrequire 'sinatra'\nrequire 'json'\nrequire './echoback'\n\npost '/linebot/callback' do\n  params = JSON.parse(request.body.read)\n\n  params['result'].each do |msg|\n    Echoback.perform_async(msg)\n  end\n\n  \"OK\"\nend\n```\n\n```echoback.rb\nrequire 'sidekiq'\nrequire 'httpclient'\n\nSidekiq.configure_client do |config|\n  config.redis = { url: ENV.fetch('REDIS_URL'), namespace: ENV.fetch('RACK_ENV') }\nend\n\nSidekiq.configure_server do |config|\n  config.redis = { url: ENV.fetch('REDIS_URL'), namespace: ENV.fetch('RACK_ENV') }\nend\n\nclass Echoback\n  include Sidekiq::Worker\n\n  def perform(msg)\n    request_content = {\n      to: [msg['content']['from']],\n      toChannel: 1383378250, # Fixed  value\n      eventType: \"138311608800106203\", # Fixed value\n      content: msg['content']\n    }\n\n    http_client = HTTPClient.new\n    endpoint_uri = 'https://trialbot-api.line.me/v1/events'\n    content_json = request_content.to_json\n    http_client.post_content(endpoint_uri, content_json,\n        'Content-Type' => 'application/json; charset=UTF-8',\n        'X-Line-ChannelID' => ENV[\"LINE_CHANNEL_ID\"],\n        'X-Line-ChannelSecret' => ENV[\"LINE_CHANNEL_SECRET\"],\n        'X-Line-Trusted-User-With-ACL' => ENV[\"LINE_CHANNEL_MID\"]\n      )\n  end\nend\n```\n\n```rb\n# A sample Gemfile\nsource \"https://rubygems.org\"\n\n# gem \"rails\"\ngem 'sinatra'\ngem 'httpclient'\n\n# gem\u30823\u3064\u8ffd\u52a0\ngem 'sidekiq'\ngem 'redis-namespace'\ngem 'dotenv'\n```\n\n```\n# Procfile\nweb: bundle exec ruby app.rb -p $PORT\n```\n\n\u7d9a\u3044\u3066\u3001Heroku \u3068 VPS \u305d\u308c\u305e\u308c\u306e\u74b0\u5883\u3092\u6574\u3048\u308b\u3002\n\u3042\u3068 LINE \u306e Whitelist \u306b VPS \u306e IP \u3092\u767b\u9332\u3059\u308b\u3002\n\n### Heroku\n\n[heroku-redis](https://elements.heroku.com/addons/heroku-redis) \u3092\u3088\u3057\u306a\u306b\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3002\n\u3061\u306a\u307f\u306b heroku-redis \u306f\u30e1\u30e2\u30ea25MB\u307e\u3067\u7121\u6599\u67a0\u3002\n\n### VPS\n\n\u30bd\u30fc\u30b9\u30b3\u30fc\u30c9\u3092\u3082\u3063\u3066\u304d\u3066 `bundle` \u3059\u308b\u3002\n`.env` \u3092\u3064\u304f\u308b\u3002\n\n```bash\n$ git clone https://github.com/user/sample\n$ cd sample\n$ bundle\n$ vi .env\nLINE_CHANNEL_ID='XXXXXXXXXXX'\nLINE_CHANNEL_SECRET='XXXXXXXXXXX'\nLINE_CHANNEL_MID='XXXXXXXXXXX'\nREDIS_URL='XXXXXXXXXXX'\n```\n\n`REDIS_URL` \u306f `heroku config | grep REDIS` \u3067\u78ba\u8a8d\u3067\u304d\u308b\u3002\n\n\u6700\u5f8c\u306b `sidekiq` \u3092\u52d5\u304b\u3059\u3002 `heroku-redis` \u306e\u6700\u5927\u30b3\u30cd\u30af\u30b7\u30e7\u30f3\u6570\u304c20\u306a\u306e\u3067\u3001\u305d\u308c\u306b\u53ce\u307e\u308b\u3088\u3046\u306b\u8abf\u6574\u3059\u308b\u3002\n\n```bash\n$ bundle exec sidekiq ./echoback.rb -c 5\nor\n$ bundle exec sidekiq ./echoback.rb -c 5 -d -L /path/to/logfile\n```\n\n\u4ee5\u4e0a\u3067\u3001LINE BOT \u306b\u8a71\u3057\u304b\u3051\u308b\u3068 Heroku \u3068 VPS \u304c\u9023\u643a\u3057\u3066\u30aa\u30a6\u30e0\u8fd4\u3057\u51e6\u7406\u3092\u3057\u3066\u304f\u308c\u308b\u3002\n", "tags": ["Heroku", "linebot", "Ruby", "vps"]}