{"tags": ["container", "docker"], "context": "\u8a73\u7d30\u306f\u4f0f\u305b\u307e\u3059\u304cImageMagick\u3092\u4f7f\u3063\u3066\u3044\u308b\u30a6\u30a7\u30d6\u30b5\u30fc\u30d3\u30b9\u3067\u8106\u5f31\u6027\u5831\u544a\u304c\u3042\u308a\u307e\u3057\u3066\u3001ImageMagick\u306e\u30b3\u30de\u30f3\u30c9\u3092\u9694\u96e2\u3057\u305f\u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0\u3067\u52d5\u304b\u305b\u306a\u3044\u304b\u3068\u8003\u3048\u307e\u3057\u305f\u3002\n\u8003\u3048\u305f\u65b9\u6cd5\n\ndocker\n\n\n\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3092\u5b9f\u884c\u3059\u308b\u30e6\u30fc\u30b6\u30fc\u306bdocker\u6a29\u9650\u3092\u3064\u3051\u305f\u304f\u306a\u3044\n\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30b5\u30fc\u30d0\u30fc\u3067docker-daemon\u3092\u52d5\u304b\u3057\u305f\u304f\u306a\u3044\n\u305f\u3060\u3057 --net=none \u306fImageTragick\u307f\u305f\u3044\u306a\u306e\u306b\u306f\u52b9\u679c\u7684\n\n\n\ndroot, jailing\n\n\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3092\u5b9f\u884c\u3059\u308b\u30e6\u30fc\u30b6\u30fc\u3067sudo\u3057\u305f\u304f\u306a\u3044\n\uff08\u5b9f\u884c\u3067\u304d\u308b\u30b3\u30de\u30f3\u30c9\u3092\u7d5e\u308c\u3070\u3044\u3044\u306e\u304b\u3082\u3057\u308c\u306a\u3044\u304c\u2026\uff09\n\n\nsystemd-nspawn\n\n\n\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3092\u5b9f\u884c\u3059\u308b\u30e6\u30fc\u30b6\u30fc\u3067sudo\u3057\u305f\u304f\u306a\u3044\n\u307e\u3060systemd\u3058\u3083\u306a\u3044\u306e\u3067\u2026\ndocker\u306e --net=none \u76f8\u5f53\u304c\u3042\u308c\u3070\u826f\u3044\u3051\u3069\u3001\u7121\u3044\u3063\u307d\u3044\uff1f\n\n\n\nfakechroot\n\n\n\u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u3092\u5411\u4e0a\u3059\u308b\u305f\u3081\u306b\u4f7f\u3046\u3082\u306e\u3067\u306f\u306a\u3044\u3089\u3057\u3044\n\n\nrunC\n\n\nsudo\u306a\u3057\u3067\u5b9f\u884c\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u308b\u307e\u3067\u306f\u307e\u3060\u304b\u304b\u308a\u305d\u3046\nhttps://github.com/opencontainers/runc/pull/774\nhttps://www.cyphar.com/blog/post/rootless-containers-with-runc\n\n\n\nPRoot\n\n\u2192\u8a66\u3057\u3066\u307f\u305f\n\n\n\n\nPRoot\u3068\u306f\nfakechroot\u304clibc\u306e\u95a2\u6570\u3092\u7f6e\u304d\u63db\u3048\u308b\u306e\u306b\u5bfe\u3057\u3001PRoot\u306fptrace\u3068\u3044\u3046\u4ed5\u7d44\u307f\u3092\u4f7f\u3063\u3066\u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0\u95a2\u9023\u306e\u30b7\u30b9\u30c6\u30e0\u30b3\u30fc\u30eb\u3092\u4e57\u3063\u53d6\u308b\u3089\u3057\u3044\n\n\u30d3\u30eb\u30c9\u3059\u308b\n\u30de\u30cb\u30e5\u30a2\u30eb\u306b\u3088\u308b\u3068\u30d0\u30a4\u30ca\u30ea\u3082\u3042\u308b\u307f\u305f\u3044\u3060\u3051\u3069\u3001HTTP\u3060\u3057\u3001\u305d\u306e\u30b5\u30a4\u30c8\u3082\u7121\u304f\u306a\u3063\u3066\u308b\u3057\u3001\u5fae\u5999\u304b\u3068\u601d\u3063\u3066\u30d3\u30eb\u30c9\u3057\u305f\u3089\u3059\u3093\u306a\u308a\u3044\u3051\u305f\u3002\n$ sudo apt-get install libtalloc-dev\n$ git clone https://github.com/proot-me/PRoot.git\n$ cd PRoot/src\n$ make\n$ ./proot --help\n\n\n\u4f7f\u3063\u3066\u307f\u308b\n\u4f8b\u3048\u3070identify\u30b3\u30de\u30f3\u30c9\n$ mkdir -p /tmp/usr/bin\n$ cp /usr/bin/identify /tmp/usr/bin/identify\n$ proot --rootfs=/tmp --mount=/bin --mount=/lib --mount=/lib64 --mount=/usr/lib --pwd=/ identify --version\nVersion: ImageMagick 6.7.7-10 2014-03-08 Q16 http://www.imagemagick.org\nCopyright: Copyright (C) 1999-2012 ImageMagick Studio LLC\nFeatures: OpenMP\n\n\u305f\u3060\u3057\u3001\u3053\u308c\u3060\u3068\u4ed6\u306b\u30de\u30a6\u30f3\u30c8\u3057\u306a\u3044\u3068\u3044\u3051\u306a\u3044\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u304c\u3042\u308b\u304b\u3082\u3057\u308c\u306a\u3044\u3057\u3001 /usr/bin \u3068\u304b\u3092\u5168\u90e8\u898b\u305b\u3066\u3057\u307e\u3063\u3066\u3044\u308b\u306e\u304c\u6c17\u306b\u306a\u308b\u3002\n\ndocker\u3092\u4f7f\u3063\u3066rootfs\u3092\u4f5c\u308b\n$ docker run --name imagemagick alpine apk --no-cache add imagemagick\nfetch http://dl-cdn.alpinelinux.org/alpine/v3.4/main/x86_64/APKINDEX.tar.gz\nfetch http://dl-cdn.alpinelinux.org/alpine/v3.4/community/x86_64/APKINDEX.tar.gz\n(1/25) Installing expat (2.1.1-r1)\n(2/25) Installing libpng (1.6.21-r0)\n(3/25) Installing freetype (2.6.3-r0)\n(4/25) Installing fontconfig (2.12.1-r0)\n(5/25) Installing libgomp (5.3.0-r0)\n(6/25) Installing dbus-libs (1.10.8-r1)\n(7/25) Installing libintl (0.19.7-r3)\n(8/25) Installing avahi-libs (0.6.32-r0)\n(9/25) Installing libgcc (5.3.0-r0)\n(10/25) Installing gmp (6.1.0-r0)\n(11/25) Installing nettle (3.2-r0)\n(12/25) Installing libffi (3.2.1-r2)\n(13/25) Installing libtasn1 (4.8-r0)\n(14/25) Installing p11-kit (0.23.2-r0)\n(15/25) Installing gnutls (3.4.15-r0)\n(16/25) Installing libstdc++ (5.3.0-r0)\n(17/25) Installing cups-libs (2.1.3-r1)\n(18/25) Installing jbig2dec (0.12-r0)\n(19/25) Installing libjpeg-turbo (1.4.2-r0)\n(20/25) Installing lcms2 (2.7-r0)\n(21/25) Installing tiff (4.0.6-r3)\n(22/25) Installing ghostscript (9.19-r1)\n(23/25) Installing libltdl (2.4.6-r0)\n(24/25) Installing libwebp (0.5.0-r0)\n(25/25) Installing imagemagick (6.9.5.9-r1)\nExecuting busybox-1.24.2-r11.trigger\nExecuting fontconfig-2.12.1-r0.trigger\nOK: 65 MiB in 36 packages\n$ docker export imagemagick | gzip > imagemagick.tar.gz\n$ mkdir ~/imagemagick-rootfs\n$ tar xzvf imagemagick.tar.gz -C ~/imagemagick-rootfs\n.dockerenv\nbin/\nbin/ash\nbin/base64\nbin/bbconfig\nbin/busybox\nbin/cat\n...\n\n$ proot --rootfs=$HOME/imagemagick-rootfs --pwd=/ identify --version\nVersion: ImageMagick 6.9.5-9 Q16 x86_64 2016-10-21 http://www.imagemagick.org\nCopyright: Copyright (C) 1999-2016 ImageMagick Studio LLC\nLicense: http://www.imagemagick.org/script/license.php\nFeatures: Cipher Modules\nDelegates (built-in): fontconfig freetype gslib jng jpeg lcms ltdl png ps tiff webp zlib\n\n\u4f8b\u3048\u3070 /tmp/img/cat.jpg \u3092\u5909\u63db\u3057\u305f\u3044\u3068\u3059\u308b\u3068\u3001\n$ proot --rootfs=$HOME/imagemagick-rootfs --mount=/tmp/img --pwd=/ identify /tmp/img/cat.jpg\n/tmp/img/cat.jpg JPEG 200x138 200x138+0+0 8-bit sRGB 6.23KB 0.000u 0:00.000\n$ proot --rootfs=$HOME/imagemagick-rootfs --mount=/tmp/img --pwd=/tmp/img convert -resize 100x100 cat.jpg cat100.jpg\n$ proot --rootfs=$HOME/imagemagick-rootfs --mount=/tmp/img --pwd=/ identify /tmp/img/cat100.jpg\n/tmp/img/cat100.jpg JPEG 100x69 100x69+0+0 8-bit Gray 256c 2.16KB 0.010u 0:00.000\n\n\u3053\u3046\u306a\u308b\u3002\npolicy.xml\u306f\u5916\u304b\u3089\u6307\u5b9a\u3067\u304d\u305f\u307b\u3046\u304c\u3044\u3044\u3088\u306d\u3063\u3066\u3053\u3068\u3067\u3001\n$ proot --rootfs=$HOME/imagemagick-rootfs --mount=$HOME/my-policy.xml:/etc/ImageMagick-6/policy.xml --mount=/tmp/img --mount=/ --pwd=/tmp/img convert -resize 100x100 cat.jpg cat100.jpg\n\n\u3053\u3046\u306a\u308b\u3002\n\u3042\u3068 /dev /proc /sys \u3042\u305f\u308a\u306f\u30de\u30a6\u30f3\u30c8\u3057\u3066\u304a\u3044\u305f\u307b\u3046\u304c\u826f\u3055\u305d\u3046\u3002\uff08\u4f55\u304b\u306e\u5909\u63db\u3067 Error in GnuTLS initialization: Failed to acquire random data. \u304c\u51fa\u305f\u306e\u3067 /dev \u3092\u30de\u30a6\u30f3\u30c8\u3057\u305f\uff09\n\n\u8a73\u7d30\u306f\u4f0f\u305b\u307e\u3059\u304cImageMagick\u3092\u4f7f\u3063\u3066\u3044\u308b\u30a6\u30a7\u30d6\u30b5\u30fc\u30d3\u30b9\u3067\u8106\u5f31\u6027\u5831\u544a\u304c\u3042\u308a\u307e\u3057\u3066\u3001ImageMagick\u306e\u30b3\u30de\u30f3\u30c9\u3092\u9694\u96e2\u3057\u305f\u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0\u3067\u52d5\u304b\u305b\u306a\u3044\u304b\u3068\u8003\u3048\u307e\u3057\u305f\u3002\n\n\u8003\u3048\u305f\u65b9\u6cd5\n\n* docker\n\t* \u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3092\u5b9f\u884c\u3059\u308b\u30e6\u30fc\u30b6\u30fc\u306bdocker\u6a29\u9650\u3092\u3064\u3051\u305f\u304f\u306a\u3044\n\t* \u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30b5\u30fc\u30d0\u30fc\u3067docker-daemon\u3092\u52d5\u304b\u3057\u305f\u304f\u306a\u3044\n\t* \u305f\u3060\u3057 `--net=none` \u306f[ImageTragick](https://imagetragick.com/)\u307f\u305f\u3044\u306a\u306e\u306b\u306f\u52b9\u679c\u7684\n* [droot](https://github.com/yuuki/droot), [jailing](https://github.com/kazuho/jailing)\n\t* \u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3092\u5b9f\u884c\u3059\u308b\u30e6\u30fc\u30b6\u30fc\u3067sudo\u3057\u305f\u304f\u306a\u3044\n\t* \uff08\u5b9f\u884c\u3067\u304d\u308b\u30b3\u30de\u30f3\u30c9\u3092\u7d5e\u308c\u3070\u3044\u3044\u306e\u304b\u3082\u3057\u308c\u306a\u3044\u304c\u2026\uff09\n* systemd-nspawn\n\t* \u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3092\u5b9f\u884c\u3059\u308b\u30e6\u30fc\u30b6\u30fc\u3067sudo\u3057\u305f\u304f\u306a\u3044\n\t* \u307e\u3060systemd\u3058\u3083\u306a\u3044\u306e\u3067\u2026\n\t* docker\u306e `--net=none` \u76f8\u5f53\u304c\u3042\u308c\u3070\u826f\u3044\u3051\u3069\u3001\u7121\u3044\u3063\u307d\u3044\uff1f\n* [fakechroot](https://github.com/dex4er/fakechroot)\n\t* [\u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u3092\u5411\u4e0a\u3059\u308b\u305f\u3081\u306b\u4f7f\u3046\u3082\u306e\u3067\u306f\u306a\u3044](https://github.com/dex4er/fakechroot/blob/master/man/fakechroot.pod#security-aspects)\u3089\u3057\u3044\n* runC\n\t* sudo\u306a\u3057\u3067\u5b9f\u884c\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u308b\u307e\u3067\u306f\u307e\u3060\u304b\u304b\u308a\u305d\u3046\n\t* https://github.com/opencontainers/runc/pull/774\n\t* https://www.cyphar.com/blog/post/rootless-containers-with-runc\n* [PRoot](https://github.com/proot-me/PRoot)\n\t* \u2192\u8a66\u3057\u3066\u307f\u305f\n\n## PRoot\u3068\u306f\n\nfakechroot\u304clibc\u306e\u95a2\u6570\u3092\u7f6e\u304d\u63db\u3048\u308b\u306e\u306b\u5bfe\u3057\u3001PRoot\u306fptrace\u3068\u3044\u3046\u4ed5\u7d44\u307f\u3092\u4f7f\u3063\u3066\u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0\u95a2\u9023\u306e\u30b7\u30b9\u30c6\u30e0\u30b3\u30fc\u30eb\u3092\u4e57\u3063\u53d6\u308b\u3089\u3057\u3044\n\n## \u30d3\u30eb\u30c9\u3059\u308b\n\n[\u30de\u30cb\u30e5\u30a2\u30eb](https://github.com/proot-me/PRoot/blob/master/doc/proot/manual.txt)\u306b\u3088\u308b\u3068\u30d0\u30a4\u30ca\u30ea\u3082\u3042\u308b\u307f\u305f\u3044\u3060\u3051\u3069\u3001HTTP\u3060\u3057\u3001\u305d\u306e\u30b5\u30a4\u30c8\u3082\u7121\u304f\u306a\u3063\u3066\u308b\u3057\u3001\u5fae\u5999\u304b\u3068\u601d\u3063\u3066\u30d3\u30eb\u30c9\u3057\u305f\u3089\u3059\u3093\u306a\u308a\u3044\u3051\u305f\u3002\n\n```\n$ sudo apt-get install libtalloc-dev\n$ git clone https://github.com/proot-me/PRoot.git\n$ cd PRoot/src\n$ make\n$ ./proot --help\n```\n\n## \u4f7f\u3063\u3066\u307f\u308b\n\n\u4f8b\u3048\u3070identify\u30b3\u30de\u30f3\u30c9\n\n```\n$ mkdir -p /tmp/usr/bin\n$ cp /usr/bin/identify /tmp/usr/bin/identify\n$ proot --rootfs=/tmp --mount=/bin --mount=/lib --mount=/lib64 --mount=/usr/lib --pwd=/ identify --version\nVersion: ImageMagick 6.7.7-10 2014-03-08 Q16 http://www.imagemagick.org\nCopyright: Copyright (C) 1999-2012 ImageMagick Studio LLC\nFeatures: OpenMP\n```\n\n\u305f\u3060\u3057\u3001\u3053\u308c\u3060\u3068\u4ed6\u306b\u30de\u30a6\u30f3\u30c8\u3057\u306a\u3044\u3068\u3044\u3051\u306a\u3044\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u304c\u3042\u308b\u304b\u3082\u3057\u308c\u306a\u3044\u3057\u3001 `/usr/bin` \u3068\u304b\u3092\u5168\u90e8\u898b\u305b\u3066\u3057\u307e\u3063\u3066\u3044\u308b\u306e\u304c\u6c17\u306b\u306a\u308b\u3002\n\n## docker\u3092\u4f7f\u3063\u3066rootfs\u3092\u4f5c\u308b\n\n```\n$ docker run --name imagemagick alpine apk --no-cache add imagemagick\nfetch http://dl-cdn.alpinelinux.org/alpine/v3.4/main/x86_64/APKINDEX.tar.gz\nfetch http://dl-cdn.alpinelinux.org/alpine/v3.4/community/x86_64/APKINDEX.tar.gz\n(1/25) Installing expat (2.1.1-r1)\n(2/25) Installing libpng (1.6.21-r0)\n(3/25) Installing freetype (2.6.3-r0)\n(4/25) Installing fontconfig (2.12.1-r0)\n(5/25) Installing libgomp (5.3.0-r0)\n(6/25) Installing dbus-libs (1.10.8-r1)\n(7/25) Installing libintl (0.19.7-r3)\n(8/25) Installing avahi-libs (0.6.32-r0)\n(9/25) Installing libgcc (5.3.0-r0)\n(10/25) Installing gmp (6.1.0-r0)\n(11/25) Installing nettle (3.2-r0)\n(12/25) Installing libffi (3.2.1-r2)\n(13/25) Installing libtasn1 (4.8-r0)\n(14/25) Installing p11-kit (0.23.2-r0)\n(15/25) Installing gnutls (3.4.15-r0)\n(16/25) Installing libstdc++ (5.3.0-r0)\n(17/25) Installing cups-libs (2.1.3-r1)\n(18/25) Installing jbig2dec (0.12-r0)\n(19/25) Installing libjpeg-turbo (1.4.2-r0)\n(20/25) Installing lcms2 (2.7-r0)\n(21/25) Installing tiff (4.0.6-r3)\n(22/25) Installing ghostscript (9.19-r1)\n(23/25) Installing libltdl (2.4.6-r0)\n(24/25) Installing libwebp (0.5.0-r0)\n(25/25) Installing imagemagick (6.9.5.9-r1)\nExecuting busybox-1.24.2-r11.trigger\nExecuting fontconfig-2.12.1-r0.trigger\nOK: 65 MiB in 36 packages\n$ docker export imagemagick | gzip > imagemagick.tar.gz\n$ mkdir ~/imagemagick-rootfs\n$ tar xzvf imagemagick.tar.gz -C ~/imagemagick-rootfs\n.dockerenv\nbin/\nbin/ash\nbin/base64\nbin/bbconfig\nbin/busybox\nbin/cat\n...\n```\n\n```\n$ proot --rootfs=$HOME/imagemagick-rootfs --pwd=/ identify --version\nVersion: ImageMagick 6.9.5-9 Q16 x86_64 2016-10-21 http://www.imagemagick.org\nCopyright: Copyright (C) 1999-2016 ImageMagick Studio LLC\nLicense: http://www.imagemagick.org/script/license.php\nFeatures: Cipher Modules\nDelegates (built-in): fontconfig freetype gslib jng jpeg lcms ltdl png ps tiff webp zlib\n```\n\n\u4f8b\u3048\u3070 /tmp/img/cat.jpg \u3092\u5909\u63db\u3057\u305f\u3044\u3068\u3059\u308b\u3068\u3001\n\n```\n$ proot --rootfs=$HOME/imagemagick-rootfs --mount=/tmp/img --pwd=/ identify /tmp/img/cat.jpg\n/tmp/img/cat.jpg JPEG 200x138 200x138+0+0 8-bit sRGB 6.23KB 0.000u 0:00.000\n$ proot --rootfs=$HOME/imagemagick-rootfs --mount=/tmp/img --pwd=/tmp/img convert -resize 100x100 cat.jpg cat100.jpg\n$ proot --rootfs=$HOME/imagemagick-rootfs --mount=/tmp/img --pwd=/ identify /tmp/img/cat100.jpg\n/tmp/img/cat100.jpg JPEG 100x69 100x69+0+0 8-bit Gray 256c 2.16KB 0.010u 0:00.000\n```\n\n\u3053\u3046\u306a\u308b\u3002\n\npolicy.xml\u306f\u5916\u304b\u3089\u6307\u5b9a\u3067\u304d\u305f\u307b\u3046\u304c\u3044\u3044\u3088\u306d\u3063\u3066\u3053\u3068\u3067\u3001\n\n```\n$ proot --rootfs=$HOME/imagemagick-rootfs --mount=$HOME/my-policy.xml:/etc/ImageMagick-6/policy.xml --mount=/tmp/img --mount=/ --pwd=/tmp/img convert -resize 100x100 cat.jpg cat100.jpg\n```\n\n\u3053\u3046\u306a\u308b\u3002\n\n\u3042\u3068 `/dev` `/proc` `/sys` \u3042\u305f\u308a\u306f\u30de\u30a6\u30f3\u30c8\u3057\u3066\u304a\u3044\u305f\u307b\u3046\u304c\u826f\u3055\u305d\u3046\u3002\uff08\u4f55\u304b\u306e\u5909\u63db\u3067 `Error in GnuTLS initialization: Failed to acquire random data.` \u304c\u51fa\u305f\u306e\u3067 `/dev` \u3092\u30de\u30a6\u30f3\u30c8\u3057\u305f\uff09\n"}