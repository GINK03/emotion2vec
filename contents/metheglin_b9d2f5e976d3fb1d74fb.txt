{"context": "\n\nGoal\n\ns3\u3067\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u4fdd\u5b58\u3055\u308c\u3066\u3044\u308b\u30ed\u30b0\u3092\u53d6\u5f97\u3057\u305f\u3044\ninstance-id\u3054\u3068\u306b\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u304c\u5207\u3089\u308c\u3001\u30ed\u30b0\u304c\u4fdd\u5b58\u3055\u308c\u308b\ninstance\u306f\u5e38\u306b\u8d77\u52d5\u3057\u305f\u308a\u7834\u68c4\u3055\u308c\u305f\u308a\u3059\u308b\u305f\u3081instance-id\u304c\u4e0d\u660e\u306a\u306e\u3067\u3001\u591a\u91cd\u30eb\u30fc\u30d7\u3067\u30b9\u30ad\u30e3\u30f3\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\n\n- (bucket)blog\n  - app\n    - config\n    - logs\n      - instance-id-1\n        - nginx-access-log-2016-12-01.gz\n        - nginx-access-log-2016-12-02.gz\n        - nginx-access-log-2016-12-03.gz\n        - nginx-error-log-2016-12-01.gz\n        - nginx-error-log-2016-12-02.gz\n        - nginx-error-log-2016-12-03.gz\n        - php-error-log-2016-12-01.gz\n        - php-error-log-2016-12-02.gz\n      - instance-id-2\n      - instance-id-3\n      - instance-id-4\n    - tools\n    - ...\n  - api\n    - ...\n  - batch\n    - ...\n\n\nSolution\nhttp://docs.aws.amazon.com/AmazonS3/latest/dev/ListingKeysHierarchy.html\n\nlist_objects\u30e1\u30bd\u30c3\u30c9\u3067prefix\u306e\u672b\u5c3e\u3092\u30b9\u30e9\u30c3\u30b7\u30e5\u3067\u6307\u5b9a\u3059\u308b\ndelimiter\u306b\"/\"\u3092\u6307\u5b9a\u3059\u308b\ncommon_prefixes\u3067\u30b5\u30d6\u30d5\u30a9\u30eb\u30c0\u4e00\u89a7\u3092\u53d6\u5f97\u3067\u304d\u308b\n\nrequire \"aws-sdk\"\n\nclient = Aws::S3::Client.new(\n  access_key_id: \"***\",\n  secret_access_key: \"***\",\n  endpoint: \"https://s3.amazonaws.com\"\n)\n\ninstance_list = client.list_objects(\n  bucket: \"blog\",\n  prefix: \"app/logs/\",\n  delimiter: \"/\"\n)\n\ninstance_list.common_prefixes.each do |instance|\n  puts instance.prefix\n  logs = client.list_objects(bucket: \"blog\", prefix: instance.prefix)\n  logs.contents.each do |content|\n    puts content.key\n  end\nend\n\n\nEnvironment\n% ruby -v\nruby 2.3.0p0 (2015-12-25 revision 53290) [x86_64-linux]\n\n% gem list aws-sdk\n\n*** LOCAL GEMS ***\naws-sdk (2.6.41, 2.2.24)\naws-sdk-core (2.6.41, 2.2.24)\naws-sdk-resources (2.6.41, 2.2.24)\n\n\n# Goal\n\n* s3\u3067\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u4fdd\u5b58\u3055\u308c\u3066\u3044\u308b\u30ed\u30b0\u3092\u53d6\u5f97\u3057\u305f\u3044\n* instance-id\u3054\u3068\u306b\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u304c\u5207\u3089\u308c\u3001\u30ed\u30b0\u304c\u4fdd\u5b58\u3055\u308c\u308b\n* instance\u306f\u5e38\u306b\u8d77\u52d5\u3057\u305f\u308a\u7834\u68c4\u3055\u308c\u305f\u308a\u3059\u308b\u305f\u3081instance-id\u304c\u4e0d\u660e\u306a\u306e\u3067\u3001\u591a\u91cd\u30eb\u30fc\u30d7\u3067\u30b9\u30ad\u30e3\u30f3\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\n\n```\n- (bucket)blog\n  - app\n    - config\n    - logs\n      - instance-id-1\n        - nginx-access-log-2016-12-01.gz\n        - nginx-access-log-2016-12-02.gz\n        - nginx-access-log-2016-12-03.gz\n        - nginx-error-log-2016-12-01.gz\n        - nginx-error-log-2016-12-02.gz\n        - nginx-error-log-2016-12-03.gz\n        - php-error-log-2016-12-01.gz\n        - php-error-log-2016-12-02.gz\n      - instance-id-2\n      - instance-id-3\n      - instance-id-4\n    - tools\n    - ...\n  - api\n    - ...\n  - batch\n    - ...\n```\n\n# Solution\n\nhttp://docs.aws.amazon.com/AmazonS3/latest/dev/ListingKeysHierarchy.html\n\n- list_objects\u30e1\u30bd\u30c3\u30c9\u3067prefix\u306e\u672b\u5c3e\u3092\u30b9\u30e9\u30c3\u30b7\u30e5\u3067\u6307\u5b9a\u3059\u308b\n- delimiter\u306b\"/\"\u3092\u6307\u5b9a\u3059\u308b\n- common_prefixes\u3067\u30b5\u30d6\u30d5\u30a9\u30eb\u30c0\u4e00\u89a7\u3092\u53d6\u5f97\u3067\u304d\u308b\n\n```rb\nrequire \"aws-sdk\"\n\nclient = Aws::S3::Client.new(\n  access_key_id: \"***\",\n  secret_access_key: \"***\",\n  endpoint: \"https://s3.amazonaws.com\"\n)\n\ninstance_list = client.list_objects(\n  bucket: \"blog\",\n  prefix: \"app/logs/\",\n  delimiter: \"/\"\n)\n\ninstance_list.common_prefixes.each do |instance|\n  puts instance.prefix\n  logs = client.list_objects(bucket: \"blog\", prefix: instance.prefix)\n  logs.contents.each do |content|\n    puts content.key\n  end\nend\n```\n\n## Environment\n\n```\n% ruby -v\nruby 2.3.0p0 (2015-12-25 revision 53290) [x86_64-linux]\n\n% gem list aws-sdk\n\n*** LOCAL GEMS ***\naws-sdk (2.6.41, 2.2.24)\naws-sdk-core (2.6.41, 2.2.24)\naws-sdk-resources (2.6.41, 2.2.24)\n```\n", "tags": ["AWS", "S3", "Ruby"]}