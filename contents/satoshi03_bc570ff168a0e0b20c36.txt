{"tags": ["lambda", "AWS", "Python", "S3"], "context": " More than 1 year has passed since last update.AWS Lambda\u304cPython\u306b\u5bfe\u5fdc\u3057\u305f\u306e\u3067\u8a66\u3057\u306b\u4f7f\u3063\u3066\u307f\u307e\u3057\u305f\u3002\n\u4eca\u56de\u306fS3\u306e\u30d0\u30b1\u30c3\u30c8\u9593\u30d5\u30a1\u30a4\u30eb\u30b3\u30d4\u30fc\u306b\u4f7f\u3063\u305f\u306e\u3067\u3059\u304c\u3001\u8272\u3005\u3068\u306f\u307e\u308a\u3069\u3053\u308d\u304c\u3042\u3063\u305f\u306e\u3067\u5171\u6709\u3057\u305f\u3044\u3068\u601d\u3044\u307e\u3059\u3002\n\n\u3084\u308a\u305f\u3044\u3053\u3068\n\ns3\u306e\u30d0\u30b1\u30c3\u30c8\u5185\u306b\u5b58\u5728\u3059\u308b\u30d5\u30a1\u30a4\u30eb\u3092\u5225\u30d0\u30b1\u30c3\u30c8\u306b\u30b3\u30d4\u30fc\u3057\u305f\u3044\n\u30b7\u30f3\u30b0\u30eb\u30d7\u30ed\u30bb\u30b9\u3067\u30b3\u30d4\u30fc\u3059\u308b\u3068\u9045\u3044\u306e\u3067\u30de\u30eb\u30c1\u30d7\u30ed\u30bb\u30b9\u3067\u540c\u6642\u306b\u30d0\u30b1\u30c3\u30c8\u30b3\u30d4\u30fc\u3057\u305f\u3044\nAWS Lambda Python\u3092\u4f7f\u3044\u305f\u3044\n\n\u4e3b\u306b3\u756a\u76ee\u306e\u7406\u7531\u304b\u3089\u3084\u3063\u3066\u307f\u307e\u3057\u305f\u3002\n\n\u3084\u3063\u305f\u3053\u3068\nLambda function\u3092\u4f5c\u3063\u3066s3\u30d0\u30b1\u30c3\u30c8\u3092\u53d6\u5f97\u3001\u30b3\u30d4\u30fc\u3092\u4e26\u5217\u3067\u884c\u3046\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u5b9f\u88c5\u3057\u307e\u3057\u305f\u3002\n\nLambda Function\u306e\u4f5c\u6210\nLambda Function\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n\nCreate a Lambda Function\u3092\u30af\u30ea\u30c3\u30af\n\n\nSelect blue print\n\u4f7f\u7528\u3059\u308b\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u3092\u9078\u629e\u3057\u307e\u3059\u3002\n\n\nhello-world-python\u3092\u9078\u629e\n\n\nConfigure function\nLambda function\u306e\u57fa\u672c\u7684\u306a\u8a2d\u5b9a\u3092\u3057\u307e\u3059\u3002\n\nName: Lambda Function\u540d\n\n\n\u4f8b\uff1as3LogBucketCopy\n\n\nDescription: Lambda Function\u306e\u8aac\u660e\n\n\n\u4f8b\uff1acopy logs between buckets\n\n\nRuntime: \u5b9f\u884c\u74b0\u5883\n\n\nPython2.7\n\n\n\n\nLambda function code\n\u5b9f\u884c\u3055\u308c\u308b\u30d7\u30ed\u30b0\u30e9\u30e0\u30b3\u30fc\u30c9\u3092\u63d0\u4f9b\u3057\u307e\u3059\u3002\n\u4ee5\u4e0b\u306e3\u7a2e\u985e\u306e\u4e2d\u304b\u3089\u9078\u629e\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\n\u753b\u9762\u4e0a\u3067\u30b3\u30fc\u30c9\u3092\u7de8\u96c6\n\u81ea\u8eab\u306e\u30de\u30b7\u30f3\u304b\u3089\u30b3\u30fc\u30c9\u3092\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\ns3\u304b\u3089\u30b3\u30fc\u30c9\u3092\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\n\npython\u306e\u6a19\u6e96\u30e9\u30a4\u30d6\u30e9\u30ea\u3084boto3\u4ee5\u5916\u306e\u30e9\u30a4\u30d6\u30e9\u30ea\u3092\u30a4\u30f3\u30dd\u30fc\u30c8\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u5834\u5408\u306f\u30012\u307e\u305f\u306f3\u306e\u65b9\u6cd5\u3092\u9078\u629e\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\u8a73\u7d30\u306f\u3053\u3061\u3089\u306b\u307e\u3068\u307e\u3063\u3066\u3044\u307e\u3059\u306e\u3067\u3001\u8208\u5473\u306e\u3042\u308b\u65b9\u306f\u53c2\u7167\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\u3061\u306a\u307f\u306b\u4eca\u56de\u306f\u3001\u6a19\u6e96\u30e9\u30a4\u30d6\u30e9\u30ea\u3068boto3\u306e\u307f\u3092\u4f7f\u7528\u3059\u308b\u305f\u3081\u30011\u306e\u65b9\u6cd5\u3067\u5b9f\u88c5\u3057\u3066\u3044\u307e\u3059\u3002\n\u5f8c\u3067\u5b9f\u88c5\u3059\u308b\u306e\u3067\u3001\u6700\u521d\u306f\u7279\u306b\u5909\u66f4\u3057\u307e\u305b\u3093\u3002\n\nLambda function handler and role\n\nHandler: \u5b9f\u884c\u3059\u308b\u30cf\u30f3\u30c9\u30e9\u306e\u540d\u524d(module\u540d.function\u540d)\n\n\n\u4f8b\uff1alambda_function.s3_log_copy_handler\n\n\nRole: Lambda\u306e\u5b9f\u884c\u6a29\u9650\uff08s3\u306a\u3069\u306e\u30ea\u30bd\u30fc\u30b9\u3078\u306e\u30a2\u30af\u30bb\u30b9\u6a29\u9650\u306a\u3069\uff09\n\n\n\u4f8b\uff1aS3 execution Role\n\n\n\n\nAdvanced settings\n\u4f7f\u7528\u53ef\u80fd\u306a\u30e1\u30e2\u30ea\u3084\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u6642\u9593\u306e\u8a2d\u5b9a\u3092\u3057\u307e\u3059\u3002\n\nMemory(MB): \u4f7f\u7528\u53ef\u80fd\u306a\u30e1\u30e2\u30ea\n\n\n\u4f8b\uff1a128MB\n\n\nTimeout: \u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u6642\u9593\n\n\n\u4f8b\uff1a5 min\n\n\n\n\nReview\n\u8a2d\u5b9a\u306e\u78ba\u8a8d\u3092\u3057\u307e\u3059\u3002\n\u554f\u984c\u306a\u3051\u308c\u3070Create Function\u3092\u9078\u629e\u3057\u307e\u3059\n\n\u30b9\u30af\u30ea\u30d7\u30c8\u306e\u5b9f\u88c5\nmulti_process\u3067\u30b3\u30d4\u30fc\u3059\u308b\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u5b9f\u88c5\u3057\u307e\u3059\u3002\n\u4ee5\u4e0b\u3001\u7c21\u5358\u306a\u30b5\u30f3\u30d7\u30eb\u3067\u3059\u3002\n#! /user/local/bin/python\n# -*- coding:utf-8 -*-\n\nimport boto3\nfrom multiprocessing import Process\n\n\n\ndef parallel_copy_bucket(s3client, source_bucket, dest_bucket, prefix):\n    '''\n    s3\u30d0\u30b1\u30c3\u30c8\u3092\u4e26\u5217\u3067\u30b3\u30d4\u30fc\u3059\u308b\n    '''    \n    # \u30d0\u30b1\u30c3\u30c8\u3092\u30b3\u30d4\u30fc\u3059\u308b\n    def copy_bucket(s3client, dest_bucket, copy_source, key):\n        s3client.copy_object(Bucket=dest_bucket, CopySource=copy_source, Key=key)\n\n    # list_object\u3060\u30681000\u4ef6\u307e\u3067\u3057\u304b\u30c7\u30fc\u30bf\u304c\u53d6\u308c\u306a\u3044\u306e\u3067\u6ce8\u610f\n    result = s3client.list_objects(\n        Bucket=source_bucket,\n        Prefix=prefix\n    )\n    # \u30b3\u30d4\u30fc\u5143\u306ekey\u4e00\u89a7\u3092\u53d6\u5f97\u3057\u3066\u30b3\u30d4\u30fc\n    if 'Contents' in result:\n        keys = [content['Key'] for content in result['Contents']]\n        p = None\n        for key in keys:\n            copy_source = '{}/{}'.format(source_bucket, key)\n            p = Process(target=copy_bucket, args=(s3client, dest_bucket, copy_source, key))\n            p.start()\n        if p:\n            p.join()\n\n\n# \u5b9f\u884c\u6642\u306b\u547c\u3070\u308c\u308b\u30cf\u30f3\u30c9\u30e9\ndef s3_log_copy_handler(event, context):\n    source_bucket = event[\"source_bucket\"] # \u30b3\u30d4\u30fc\u5143\u30d0\u30b1\u30c3\u30c8\n    dest_bucket = event[\"dest_bucket\"]     # \u30b3\u30d4\u30fc\u5148\u30d0\u30b1\u30c3\u30c8\n    prefixes = event[\"prefixes\"]           # \u30b3\u30d4\u30fc\u5143\u306e\u30d5\u30a1\u30a4\u30eb\u540d\u306e\u6761\u4ef6\n    s3client = boto3.client('s3')\n    for prefix in prefixes:\n        print(\"Start loading {}\".format(prefix))\n        parallel_copy_bucket(s3client, source_bucket, dest_bucket, prefix)\n    print(\"Complete loading\")\n\n\n\u30c6\u30b9\u30c8\u5b9f\u884c\nActions\u30dc\u30bf\u30f3\u304b\u3089Configure Sample Event\u3092\u8a2d\u5b9a\n\u30cf\u30f3\u30c9\u30e9\u306b\u6e21\u3059\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u8a2d\u5b9a\n\u4f8b\u3048\u3070\u3001s3\u306e\u69cb\u6210\u304c\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u305f\u5834\u5408\n- samplelogs.source  # \u30b3\u30d4\u30fc\u5143\u30d0\u30b1\u30c3\u30c8\n    - /key1\n        - hogehoge.dat\n    - /key2\n        - fugafuga.dat\n- samplelogs.dest    # \u30b3\u30d4\u30fc\u5148\u30d0\u30b1\u30c3\u30c8\n\n\u4ee5\u4e0b\u306e\u3088\u3046\u306bJSON\u3092\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n{\n  \"source_bucket\": \"samplelogs.source\",\n  \"dest_bucket\": \"samplelogs.dest\",\n  \"prefixes\" : [\n    \"key1\",\n    \"key2\"\n  ]\n}\n\n\n\u30cf\u30de\u3063\u305f\u3068\u3053\u308d\n\nRole\u3067\u306es3\u30d0\u30b1\u30c3\u30c8\u3078\u306e\u51e6\u7406\u306e\u8a31\u53ef\n\u30c7\u30d5\u30a9\u30eb\u30c8\u306eS3 Execution Rule\u3067\u306f\u3001s3:GetObject\u3068s3:PutObject\u3057\u304b\u5b9a\u7fa9\u3055\u308c\u3066\u3044\u307e\u305b\u3093\u3002\n\u3053\u306e\u3068\u304d\u306b\u3001s3client.list_objects()\u3092\u547c\u3073\u51fa\u3059\u3068\u3001A client error (AccessDenied) occurred: Access Denied\u3068\u3044\u3046\u30a8\u30e9\u30fc\u304c\u3067\u3066\u3057\u307e\u3044\u307e\u3059\u3002\n\u3053\u306e\u30e1\u30bd\u30c3\u30c9\u306f\u3001S3:GetObject\u3067\u306f\u5b9f\u884c\u3067\u304d\u305a\u3001S3:ListObejct\u3068\u3044\u3046\u5225\u306e\u5b9f\u884c\u6a29\u9650\u304c\u5fc5\u8981\u306b\u306a\u308a\u307e\u3059\u3002\n\u305d\u306e\u305f\u3081\u3001Policy\u306bs3:ListObject\u3092\u8ffd\u52a0\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\nmultiprocessing.Pool\n\u30de\u30eb\u30c1\u30d7\u30ed\u30bb\u30b9\u3067\u306e\u5b9f\u884c\u6642\u306b\u3001\u30d7\u30fc\u30eb\u3092\u6307\u5b9a\u3059\u308b\u3068OSErrors - [Errno 38] Function not implemented\u3068\u3044\u3046\u30a8\u30e9\u30fc\u304c\u51fa\u3066\u3057\u307e\u3044\u307e\u3059\u3002\n\u3053\u308c\u306f\u3001pool\u3092\u4fdd\u6301\u3059\u308b\u305f\u3081\u306b\u5fc5\u8981\u306aOS\u6a29\u9650\u3092Lambda\u3067\u5b9f\u884c\u3059\u308b\u5834\u5408\u306b\u6301\u3063\u3066\u3044\u306a\u3044\u305f\u3081\u8d77\u304d\u308b\u554f\u984c\u3067\u3059\u3002\nPool\u306e\u8a2d\u5b9a\u3092\u5916\u3057\u3066\u5b9f\u884c\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\nTimeOut\u306e\u8a2d\u5b9a\nLambda\u3067\u306f\u3001\u5b9f\u884c\u6642\u9593\u304c\u6307\u5b9a\u3057\u305f\u5024\u3092\u8d85\u3048\u305f\u3068\u304d\u306b\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u3059\u308b\u3088\u3046\u306b\u8a2d\u5b9a\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u306e\u6700\u5927\u5024\u306f300sec(5min)\u3068\u306a\u3063\u3066\u3044\u308b\u305f\u3081\u3001\u305d\u308c\u4ee5\u4e0a\u5b9f\u884c\u306b\u6642\u9593\u304c\u304b\u304b\u308b\u3082\u306e\u306b\u3064\u3044\u3066\u306f\u3001\u5b9f\u884c\u3092\u5b8c\u4e86\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u305b\u3093\u3002\n\u305d\u306e\u305f\u3081\u3001\u3042\u308b\u7a0b\u5ea6\u5927\u304d\u306a\u30b5\u30a4\u30ba\u306e\u30d5\u30a1\u30a4\u30eb\u3092\u6301\u3064\u30d0\u30b1\u30c3\u30c8\u306e\u5834\u5408\u306f\u3001\u6570\u56de\u306b\u5206\u3051\u3066Lambda Function\u3092\u5b9f\u884c\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\n\u6240\u611f\n\u3084\u3063\u3071\u308a\u4f7f\u3044\u3069\u3053\u308d\u304b\u306a\u3068\u3044\u3046\u6c17\u304c\u3057\u307e\u3059\u304c\u3001\u30a2\u30e9\u30fc\u30c8\u3084\u30d7\u30c3\u30b7\u30e5\u901a\u77e5\u3001\u5c0f\u3055\u3081\u306e\u30d5\u30a1\u30a4\u30eb\u8ee2\u9001\u306a\u3069\u306e\u8efd\u3081\u306e\u51e6\u7406\u306b\u5411\u3044\u3066\u3044\u308b\u306e\u304b\u306a\u3068\u601d\u3044\u307e\u3057\u305f\u3002\n\u53cd\u5bfe\u306b\u3001\u91cd\u3044\u51e6\u7406\u3092\u66f8\u304f\u306e\u306b\u306f\u9069\u3055\u306a\u3044\u3088\u3046\u3067\u3059\u3002\n\u307e\u305f\u3001API\u30a8\u30f3\u30c9\u30dd\u30a4\u30f3\u30c8\u3092\u6301\u3066\u308b\u3088\u3046\u306b\u306a\u3063\u305f\u306e\u3067\u3001\u8d85\u8efd\u91cf\u306aAPI\u306b\u3082\u5411\u3044\u3066\u3044\u308b\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u3002\u4eca\u5ea6\u8a66\u3057\u3066\u307f\u3088\u3046\u3068\u601d\u3044\u307e\u3059\u3002\n\u3053\u3061\u3089Lambda Function\u3092\u4f7f\u3063\u3066\u5b09\u3057\u3044\u3068\u3053\u308d\u3068\u6b8b\u5ff5\u306a\u3068\u3053\u308d\u3092\u307e\u3068\u3081\u307e\u3057\u305f\u3002\n\n\u5b09\u3057\u3044\u3068\u3053\u308d\n\n\n\u7c21\u5358\u306a\u30d0\u30c3\u30c1\u51e6\u7406\u3092\u66f8\u304f\u306e\u306b\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u7acb\u3066\u308b\u5fc5\u8981\u304c\u306a\u3044\n\u6700\u4f4e\u9650\u306e\u8a2d\u5b9a\u3067\u7c21\u5358\u306b\u30d0\u30c3\u30c1\u3092\u5b9f\u88c5\u3067\u304d\u308b\naws\u5185\u306e\u30ea\u30bd\u30fc\u30b9\u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u306e\u304cIAM Role\u3067\u7ba1\u7406\u3067\u304d\u308b\u306e\u3067\u7c21\u5358\nboto3\u304c\u6a19\u6e96\u3067\u4f7f\u3048\u308b\n\n\n\u6b8b\u5ff5\u306a\u3068\u3053\u308d\n\n\nPython3\u7cfb\u306b\u672a\u5bfe\u5fdc\n\u6a19\u6e96\u30d1\u30c3\u30b1\u30fc\u30b8\u3084boto3\u4ee5\u5916\u306e\u30a4\u30f3\u30dd\u30fc\u30c8\u304c\u9762\u5012\n\u4f5c\u3063\u305f\u30b3\u30fc\u30c9\u306e\u7ba1\u7406\u304c\u96e3\u3057\u3044\n\u6700\u5927\u306e\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u6642\u9593\u304c\u77ed\u3044\n\n\n\n\n\u53c2\u8003\nhttps://boto3.readthedocs.org/en/latest/\nhttp://qiita.com/m-sakano/items/c53ba194a8574f44e78a\nhttp://www.perrygeo.com/running-python-with-compiled-code-on-aws-lambda.html\n\nAWS Lambda\u304cPython\u306b\u5bfe\u5fdc\u3057\u305f\u306e\u3067\u8a66\u3057\u306b\u4f7f\u3063\u3066\u307f\u307e\u3057\u305f\u3002\n\u4eca\u56de\u306fS3\u306e\u30d0\u30b1\u30c3\u30c8\u9593\u30d5\u30a1\u30a4\u30eb\u30b3\u30d4\u30fc\u306b\u4f7f\u3063\u305f\u306e\u3067\u3059\u304c\u3001\u8272\u3005\u3068\u306f\u307e\u308a\u3069\u3053\u308d\u304c\u3042\u3063\u305f\u306e\u3067\u5171\u6709\u3057\u305f\u3044\u3068\u601d\u3044\u307e\u3059\u3002\n\n\n# \u3084\u308a\u305f\u3044\u3053\u3068\n\n1. s3\u306e\u30d0\u30b1\u30c3\u30c8\u5185\u306b\u5b58\u5728\u3059\u308b\u30d5\u30a1\u30a4\u30eb\u3092\u5225\u30d0\u30b1\u30c3\u30c8\u306b\u30b3\u30d4\u30fc\u3057\u305f\u3044\n2. \u30b7\u30f3\u30b0\u30eb\u30d7\u30ed\u30bb\u30b9\u3067\u30b3\u30d4\u30fc\u3059\u308b\u3068\u9045\u3044\u306e\u3067\u30de\u30eb\u30c1\u30d7\u30ed\u30bb\u30b9\u3067\u540c\u6642\u306b\u30d0\u30b1\u30c3\u30c8\u30b3\u30d4\u30fc\u3057\u305f\u3044\n3. AWS Lambda Python\u3092\u4f7f\u3044\u305f\u3044\n\n\u4e3b\u306b3\u756a\u76ee\u306e\u7406\u7531\u304b\u3089\u3084\u3063\u3066\u307f\u307e\u3057\u305f\u3002\n\n# \u3084\u3063\u305f\u3053\u3068\n\nLambda function\u3092\u4f5c\u3063\u3066s3\u30d0\u30b1\u30c3\u30c8\u3092\u53d6\u5f97\u3001\u30b3\u30d4\u30fc\u3092\u4e26\u5217\u3067\u884c\u3046\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u5b9f\u88c5\u3057\u307e\u3057\u305f\u3002\n\n## Lambda Function\u306e\u4f5c\u6210\nLambda Function\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n- `Create a Lambda Function`\u3092\u30af\u30ea\u30c3\u30af\n\n## Select blue print\n\u4f7f\u7528\u3059\u308b\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u3092\u9078\u629e\u3057\u307e\u3059\u3002\n\n- `hello-world-python`\u3092\u9078\u629e\n\n## Configure function\n\nLambda function\u306e\u57fa\u672c\u7684\u306a\u8a2d\u5b9a\u3092\u3057\u307e\u3059\u3002\n\n- Name: Lambda Function\u540d\n    - \u4f8b\uff1as3LogBucketCopy\n- Description: Lambda Function\u306e\u8aac\u660e\n    - \u4f8b\uff1acopy logs between buckets\n- Runtime: \u5b9f\u884c\u74b0\u5883\n    - Python2.7\n\n## Lambda function code\n\n\u5b9f\u884c\u3055\u308c\u308b\u30d7\u30ed\u30b0\u30e9\u30e0\u30b3\u30fc\u30c9\u3092\u63d0\u4f9b\u3057\u307e\u3059\u3002\n\n\u4ee5\u4e0b\u306e3\u7a2e\u985e\u306e\u4e2d\u304b\u3089\u9078\u629e\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\n1. \u753b\u9762\u4e0a\u3067\u30b3\u30fc\u30c9\u3092\u7de8\u96c6\n2. \u81ea\u8eab\u306e\u30de\u30b7\u30f3\u304b\u3089\u30b3\u30fc\u30c9\u3092\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\n3. s3\u304b\u3089\u30b3\u30fc\u30c9\u3092\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\n\npython\u306e\u6a19\u6e96\u30e9\u30a4\u30d6\u30e9\u30ea\u3084boto3\u4ee5\u5916\u306e\u30e9\u30a4\u30d6\u30e9\u30ea\u3092\u30a4\u30f3\u30dd\u30fc\u30c8\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u5834\u5408\u306f\u30012\u307e\u305f\u306f3\u306e\u65b9\u6cd5\u3092\u9078\u629e\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\n\u8a73\u7d30\u306f[\u3053\u3061\u3089](http://qiita.com/m-sakano/items/c53ba194a8574f44e78a)\u306b\u307e\u3068\u307e\u3063\u3066\u3044\u307e\u3059\u306e\u3067\u3001\u8208\u5473\u306e\u3042\u308b\u65b9\u306f\u53c2\u7167\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n\u3061\u306a\u307f\u306b\u4eca\u56de\u306f\u3001\u6a19\u6e96\u30e9\u30a4\u30d6\u30e9\u30ea\u3068boto3\u306e\u307f\u3092\u4f7f\u7528\u3059\u308b\u305f\u3081\u30011\u306e\u65b9\u6cd5\u3067\u5b9f\u88c5\u3057\u3066\u3044\u307e\u3059\u3002\n\n\u5f8c\u3067\u5b9f\u88c5\u3059\u308b\u306e\u3067\u3001\u6700\u521d\u306f\u7279\u306b\u5909\u66f4\u3057\u307e\u305b\u3093\u3002\n\n## Lambda function handler and role\n- Handler: \u5b9f\u884c\u3059\u308b\u30cf\u30f3\u30c9\u30e9\u306e\u540d\u524d(module\u540d.function\u540d)\n    - \u4f8b\uff1alambda_function.s3_log_copy_handler\n- Role: Lambda\u306e\u5b9f\u884c\u6a29\u9650\uff08s3\u306a\u3069\u306e\u30ea\u30bd\u30fc\u30b9\u3078\u306e\u30a2\u30af\u30bb\u30b9\u6a29\u9650\u306a\u3069\uff09\n   - \u4f8b\uff1aS3 execution Role\n\n## Advanced settings\n\u4f7f\u7528\u53ef\u80fd\u306a\u30e1\u30e2\u30ea\u3084\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u6642\u9593\u306e\u8a2d\u5b9a\u3092\u3057\u307e\u3059\u3002\n\n- Memory(MB): \u4f7f\u7528\u53ef\u80fd\u306a\u30e1\u30e2\u30ea\n    - \u4f8b\uff1a128MB\n- Timeout: \u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u6642\u9593\n    - \u4f8b\uff1a5 min\n\n## Review\n\n\u8a2d\u5b9a\u306e\u78ba\u8a8d\u3092\u3057\u307e\u3059\u3002\n\u554f\u984c\u306a\u3051\u308c\u3070`Create Function`\u3092\u9078\u629e\u3057\u307e\u3059\n\n## \u30b9\u30af\u30ea\u30d7\u30c8\u306e\u5b9f\u88c5\n\nmulti_process\u3067\u30b3\u30d4\u30fc\u3059\u308b\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u5b9f\u88c5\u3057\u307e\u3059\u3002\n\n\u4ee5\u4e0b\u3001\u7c21\u5358\u306a\u30b5\u30f3\u30d7\u30eb\u3067\u3059\u3002\n\n```.py\n#! /user/local/bin/python\n# -*- coding:utf-8 -*-\n\nimport boto3\nfrom multiprocessing import Process\n\n  \n\ndef parallel_copy_bucket(s3client, source_bucket, dest_bucket, prefix):\n    '''\n    s3\u30d0\u30b1\u30c3\u30c8\u3092\u4e26\u5217\u3067\u30b3\u30d4\u30fc\u3059\u308b\n    '''    \n    # \u30d0\u30b1\u30c3\u30c8\u3092\u30b3\u30d4\u30fc\u3059\u308b\n    def copy_bucket(s3client, dest_bucket, copy_source, key):\n        s3client.copy_object(Bucket=dest_bucket, CopySource=copy_source, Key=key)\n        \n    # list_object\u3060\u30681000\u4ef6\u307e\u3067\u3057\u304b\u30c7\u30fc\u30bf\u304c\u53d6\u308c\u306a\u3044\u306e\u3067\u6ce8\u610f\n    result = s3client.list_objects(\n        Bucket=source_bucket,\n        Prefix=prefix\n    )\n    # \u30b3\u30d4\u30fc\u5143\u306ekey\u4e00\u89a7\u3092\u53d6\u5f97\u3057\u3066\u30b3\u30d4\u30fc\n    if 'Contents' in result:\n        keys = [content['Key'] for content in result['Contents']]\n        p = None\n        for key in keys:\n            copy_source = '{}/{}'.format(source_bucket, key)\n            p = Process(target=copy_bucket, args=(s3client, dest_bucket, copy_source, key))\n            p.start()\n        if p:\n            p.join()\n\n\n# \u5b9f\u884c\u6642\u306b\u547c\u3070\u308c\u308b\u30cf\u30f3\u30c9\u30e9\ndef s3_log_copy_handler(event, context):\n    source_bucket = event[\"source_bucket\"] # \u30b3\u30d4\u30fc\u5143\u30d0\u30b1\u30c3\u30c8\n    dest_bucket = event[\"dest_bucket\"]     # \u30b3\u30d4\u30fc\u5148\u30d0\u30b1\u30c3\u30c8\n    prefixes = event[\"prefixes\"]           # \u30b3\u30d4\u30fc\u5143\u306e\u30d5\u30a1\u30a4\u30eb\u540d\u306e\u6761\u4ef6\n    s3client = boto3.client('s3')\n    for prefix in prefixes:\n        print(\"Start loading {}\".format(prefix))\n        parallel_copy_bucket(s3client, source_bucket, dest_bucket, prefix)\n    print(\"Complete loading\")\n```\n\n## \u30c6\u30b9\u30c8\u5b9f\u884c\n\n`Actions`\u30dc\u30bf\u30f3\u304b\u3089`Configure Sample Event`\u3092\u8a2d\u5b9a\n\n\n\u30cf\u30f3\u30c9\u30e9\u306b\u6e21\u3059\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u8a2d\u5b9a\n\n\u4f8b\u3048\u3070\u3001s3\u306e\u69cb\u6210\u304c\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u305f\u5834\u5408\n\n```\n- samplelogs.source  # \u30b3\u30d4\u30fc\u5143\u30d0\u30b1\u30c3\u30c8\n    - /key1\n        - hogehoge.dat\n    - /key2\n        - fugafuga.dat\n- samplelogs.dest    # \u30b3\u30d4\u30fc\u5148\u30d0\u30b1\u30c3\u30c8\n```\n\n\u4ee5\u4e0b\u306e\u3088\u3046\u306bJSON\u3092\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\n```.json\n{\n  \"source_bucket\": \"samplelogs.source\",\n  \"dest_bucket\": \"samplelogs.dest\",\n  \"prefixes\" : [\n    \"key1\",\n    \"key2\"\n  ]\n}\n```\n\n# \u30cf\u30de\u3063\u305f\u3068\u3053\u308d\n\n\n\n## Role\u3067\u306es3\u30d0\u30b1\u30c3\u30c8\u3078\u306e\u51e6\u7406\u306e\u8a31\u53ef\n\n\u30c7\u30d5\u30a9\u30eb\u30c8\u306eS3 Execution Rule\u3067\u306f\u3001`s3:GetObject`\u3068`s3:PutObject`\u3057\u304b\u5b9a\u7fa9\u3055\u308c\u3066\u3044\u307e\u305b\u3093\u3002\n\u3053\u306e\u3068\u304d\u306b\u3001`s3client.list_objects()`\u3092\u547c\u3073\u51fa\u3059\u3068\u3001`A client error (AccessDenied) occurred: Access Denied`\u3068\u3044\u3046\u30a8\u30e9\u30fc\u304c\u3067\u3066\u3057\u307e\u3044\u307e\u3059\u3002\n\u3053\u306e\u30e1\u30bd\u30c3\u30c9\u306f\u3001`S3:GetObject`\u3067\u306f\u5b9f\u884c\u3067\u304d\u305a\u3001`S3:ListObejct`\u3068\u3044\u3046\u5225\u306e\u5b9f\u884c\u6a29\u9650\u304c\u5fc5\u8981\u306b\u306a\u308a\u307e\u3059\u3002\n\u305d\u306e\u305f\u3081\u3001Policy\u306b`s3:ListObject`\u3092\u8ffd\u52a0\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\n## multiprocessing.Pool\n\n\u30de\u30eb\u30c1\u30d7\u30ed\u30bb\u30b9\u3067\u306e\u5b9f\u884c\u6642\u306b\u3001\u30d7\u30fc\u30eb\u3092\u6307\u5b9a\u3059\u308b\u3068`OSErrors - [Errno 38] Function not implemented`\u3068\u3044\u3046\u30a8\u30e9\u30fc\u304c\u51fa\u3066\u3057\u307e\u3044\u307e\u3059\u3002\n\u3053\u308c\u306f\u3001pool\u3092\u4fdd\u6301\u3059\u308b\u305f\u3081\u306b\u5fc5\u8981\u306aOS\u6a29\u9650\u3092Lambda\u3067\u5b9f\u884c\u3059\u308b\u5834\u5408\u306b\u6301\u3063\u3066\u3044\u306a\u3044\u305f\u3081\u8d77\u304d\u308b\u554f\u984c\u3067\u3059\u3002\nPool\u306e\u8a2d\u5b9a\u3092\u5916\u3057\u3066\u5b9f\u884c\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\n## TimeOut\u306e\u8a2d\u5b9a\n\nLambda\u3067\u306f\u3001\u5b9f\u884c\u6642\u9593\u304c\u6307\u5b9a\u3057\u305f\u5024\u3092\u8d85\u3048\u305f\u3068\u304d\u306b\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u3059\u308b\u3088\u3046\u306b\u8a2d\u5b9a\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u306e\u6700\u5927\u5024\u306f300sec(5min)\u3068\u306a\u3063\u3066\u3044\u308b\u305f\u3081\u3001\u305d\u308c\u4ee5\u4e0a\u5b9f\u884c\u306b\u6642\u9593\u304c\u304b\u304b\u308b\u3082\u306e\u306b\u3064\u3044\u3066\u306f\u3001\u5b9f\u884c\u3092\u5b8c\u4e86\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u305b\u3093\u3002\n\u305d\u306e\u305f\u3081\u3001\u3042\u308b\u7a0b\u5ea6\u5927\u304d\u306a\u30b5\u30a4\u30ba\u306e\u30d5\u30a1\u30a4\u30eb\u3092\u6301\u3064\u30d0\u30b1\u30c3\u30c8\u306e\u5834\u5408\u306f\u3001\u6570\u56de\u306b\u5206\u3051\u3066Lambda Function\u3092\u5b9f\u884c\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\n# \u6240\u611f\n\n\u3084\u3063\u3071\u308a\u4f7f\u3044\u3069\u3053\u308d\u304b\u306a\u3068\u3044\u3046\u6c17\u304c\u3057\u307e\u3059\u304c\u3001\u30a2\u30e9\u30fc\u30c8\u3084\u30d7\u30c3\u30b7\u30e5\u901a\u77e5\u3001\u5c0f\u3055\u3081\u306e\u30d5\u30a1\u30a4\u30eb\u8ee2\u9001\u306a\u3069\u306e\u8efd\u3081\u306e\u51e6\u7406\u306b\u5411\u3044\u3066\u3044\u308b\u306e\u304b\u306a\u3068\u601d\u3044\u307e\u3057\u305f\u3002\n\u53cd\u5bfe\u306b\u3001\u91cd\u3044\u51e6\u7406\u3092\u66f8\u304f\u306e\u306b\u306f\u9069\u3055\u306a\u3044\u3088\u3046\u3067\u3059\u3002\n\u307e\u305f\u3001API\u30a8\u30f3\u30c9\u30dd\u30a4\u30f3\u30c8\u3092\u6301\u3066\u308b\u3088\u3046\u306b\u306a\u3063\u305f\u306e\u3067\u3001\u8d85\u8efd\u91cf\u306aAPI\u306b\u3082\u5411\u3044\u3066\u3044\u308b\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u3002\u4eca\u5ea6\u8a66\u3057\u3066\u307f\u3088\u3046\u3068\u601d\u3044\u307e\u3059\u3002\n\n\u3053\u3061\u3089Lambda Function\u3092\u4f7f\u3063\u3066\u5b09\u3057\u3044\u3068\u3053\u308d\u3068\u6b8b\u5ff5\u306a\u3068\u3053\u308d\u3092\u307e\u3068\u3081\u307e\u3057\u305f\u3002\n\n- \u5b09\u3057\u3044\u3068\u3053\u308d\n    - \u7c21\u5358\u306a\u30d0\u30c3\u30c1\u51e6\u7406\u3092\u66f8\u304f\u306e\u306b\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u7acb\u3066\u308b\u5fc5\u8981\u304c\u306a\u3044\n    - \u6700\u4f4e\u9650\u306e\u8a2d\u5b9a\u3067\u7c21\u5358\u306b\u30d0\u30c3\u30c1\u3092\u5b9f\u88c5\u3067\u304d\u308b\n    - aws\u5185\u306e\u30ea\u30bd\u30fc\u30b9\u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u306e\u304cIAM Role\u3067\u7ba1\u7406\u3067\u304d\u308b\u306e\u3067\u7c21\u5358\n    - boto3\u304c\u6a19\u6e96\u3067\u4f7f\u3048\u308b\n- \u6b8b\u5ff5\u306a\u3068\u3053\u308d\n    - Python3\u7cfb\u306b\u672a\u5bfe\u5fdc\n    - \u6a19\u6e96\u30d1\u30c3\u30b1\u30fc\u30b8\u3084boto3\u4ee5\u5916\u306e\u30a4\u30f3\u30dd\u30fc\u30c8\u304c\u9762\u5012\n    - \u4f5c\u3063\u305f\u30b3\u30fc\u30c9\u306e\u7ba1\u7406\u304c\u96e3\u3057\u3044\n    - \u6700\u5927\u306e\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u6642\u9593\u304c\u77ed\u3044\n\n\n# \u53c2\u8003\nhttps://boto3.readthedocs.org/en/latest/\nhttp://qiita.com/m-sakano/items/c53ba194a8574f44e78a\nhttp://www.perrygeo.com/running-python-with-compiled-code-on-aws-lambda.html\n\n"}