{"context": "\n\ndiff\n1\u884c\u8db3\u3059\u3060\u3051\u3058\u3083\uff01\n$ diff -u /usr/share/munin/plugins/nginx_request_time /usr/share/munin/plugins/nginx_request_time_withoutcache\n--- /usr/share/munin/plugins/nginx_request_time 2016-11-29 01:20:15.063783808 +0900\n+++ /usr/share/munin/plugins/nginx_request_time_withoutcache    2016-12-07 23:27:05.093202230 +0900\n@@ -123,6 +123,7 @@\n         my $hash = $p->parse_line($log_line);\n         my $time_s = $hash->{reqtime};\n         if (!defined($time_s)) { next; }\n+        if ($hash->{apptime} eq \"-\") { next; }\n         push @request_time_array, $time_s * 1000;\n     } else {\n         last;\n\n\n\u88dc\u8db3: nginx\u306e\u30ed\u30b0\u8a2d\u5b9a\nlog_format  ltsv  \"time:$time_local\"\n                  \"\\thost:$remote_addr\"\n                  \"\\tforwardedfor:$http_x_forwarded_for\"\n                  \"\\treq:$request\"\n                  \"\\tstatus:$status\"\n                  \"\\tsize:$body_bytes_sent\"\n                  \"\\treferer:$http_referer\"\n                  \"\\tua:$http_user_agent\"\n                  \"\\treqtime:$request_time\"\n                  \"\\tapptime:$upstream_response_time\"\n                  \"\\tvhost:$host\";\n\n\n$upstream_response_time\u306e\u5024\n\u516c\u5f0f\u8cc7\u6599\u304c\u898b\u5f53\u305f\u3089\u306a\u3044\u306e\u3067\u3059\u304c\u3001\u5c11\u306a\u304f\u3068\u3082\u4e0b\u8a18\u306e\u5834\u5408\u306b $upstream_response_time \u306e\u5024\u306f - \u3068\u306a\u308a\u307e\u3059\u3002\n\nnginx\u306e\u307f\u3067\u30ec\u30b9\u30dd\u30f3\u30b9\u3092\u8fd4\u5374\u3057\u305f\u3068\u304d\nproxy_cache\u3067\u30ad\u30e3\u30c3\u30b7\u30e5\u5fdc\u7b54\u3057\u305f\u3068\u304d\n\n\u305d\u3053\u3092\u5f15\u3063\u639b\u3051\u3066\u9664\u5916\u3055\u305b\u308b\u3053\u3068\u3067\u3001proxy_pass\u3067\u30ea\u30d0\u30fc\u30b9\u30d7\u30ed\u30ad\u30b7\u3057\u305f\u6642\u306e\u5fdc\u7b54\u6642\u9593\u3060\u3051\u3092\u96c6\u8a08\u3067\u304d\u307e\u3059\u3002\n\n\u30a2\u30d7\u30ea\u306e\u672c\u6765\u306e\u51e6\u7406\u6642\u9593\u306f\u3044\u304b\u307b\u3069\u2026\n\u8da3\u5473\u3067\u4f5c\u3063\u3066\u3044\u308b\u30b5\u30fc\u30d3\u30b9\u306eAPI\u30b5\u30fc\u30d0\u3092\u4f8b\u306b\u3002\n\u30ad\u30e3\u30c3\u30b7\u30e5\u5fdc\u7b54\u3082\u542b\u3081\u3066\u96c6\u8a08\u3059\u308b\u3068\u3001\u6700\u6df7\u96d1\u6642\u306b\u306f90\u30d1\u30fc\u30bb\u30f3\u30bf\u30a4\u30eb\u5024\u30820ms\u306b\u306a\u308a\u307e\u3059\u3002\u6b63\u3057\u3044\u3068\u3044\u3048\u3070\u6b63\u3057\u3044\u306e\u3067\u3059\u304c\u3002\n\n\u30ad\u30e3\u30c3\u30b7\u30e5\u5fdc\u7b54\u3092\u9664\u5916\u3055\u305b\u308b\u3068\u2026\u3000\u4e2d\u592e\u5024300ms\u5f37\u300299\u30d1\u30fc\u30bb\u30f3\u30bf\u30a4\u30eb\u5024\u306b\u4e0d\u5b89\u304c\u3042\u308a\u307e\u3059\u304c\u3001\u307e\u3042\u307e\u3042\u304b\u306a\u3002\n\n## diff\n\n1\u884c\u8db3\u3059\u3060\u3051\u3058\u3083\uff01\n\n```\n$ diff -u /usr/share/munin/plugins/nginx_request_time /usr/share/munin/plugins/nginx_request_time_withoutcache\n--- /usr/share/munin/plugins/nginx_request_time 2016-11-29 01:20:15.063783808 +0900\n+++ /usr/share/munin/plugins/nginx_request_time_withoutcache    2016-12-07 23:27:05.093202230 +0900\n@@ -123,6 +123,7 @@\n         my $hash = $p->parse_line($log_line);\n         my $time_s = $hash->{reqtime};\n         if (!defined($time_s)) { next; }\n+        if ($hash->{apptime} eq \"-\") { next; }\n         push @request_time_array, $time_s * 1000;\n     } else {\n         last;\n```\n\n### \u88dc\u8db3: nginx\u306e\u30ed\u30b0\u8a2d\u5b9a\n\n```\nlog_format  ltsv  \"time:$time_local\"\n                  \"\\thost:$remote_addr\"\n                  \"\\tforwardedfor:$http_x_forwarded_for\"\n                  \"\\treq:$request\"\n                  \"\\tstatus:$status\"\n                  \"\\tsize:$body_bytes_sent\"\n                  \"\\treferer:$http_referer\"\n                  \"\\tua:$http_user_agent\"\n                  \"\\treqtime:$request_time\"\n                  \"\\tapptime:$upstream_response_time\"\n                  \"\\tvhost:$host\";\n```\n\n## $upstream_response_time\u306e\u5024\n\n\u516c\u5f0f\u8cc7\u6599\u304c\u898b\u5f53\u305f\u3089\u306a\u3044\u306e\u3067\u3059\u304c\u3001\u5c11\u306a\u304f\u3068\u3082\u4e0b\u8a18\u306e\u5834\u5408\u306b $upstream_response_time \u306e\u5024\u306f - \u3068\u306a\u308a\u307e\u3059\u3002\n\n* nginx\u306e\u307f\u3067\u30ec\u30b9\u30dd\u30f3\u30b9\u3092\u8fd4\u5374\u3057\u305f\u3068\u304d\n* proxy_cache\u3067\u30ad\u30e3\u30c3\u30b7\u30e5\u5fdc\u7b54\u3057\u305f\u3068\u304d\n\n\u305d\u3053\u3092\u5f15\u3063\u639b\u3051\u3066\u9664\u5916\u3055\u305b\u308b\u3053\u3068\u3067\u3001proxy_pass\u3067\u30ea\u30d0\u30fc\u30b9\u30d7\u30ed\u30ad\u30b7\u3057\u305f\u6642\u306e\u5fdc\u7b54\u6642\u9593\u3060\u3051\u3092\u96c6\u8a08\u3067\u304d\u307e\u3059\u3002\n\n## \u30a2\u30d7\u30ea\u306e\u672c\u6765\u306e\u51e6\u7406\u6642\u9593\u306f\u3044\u304b\u307b\u3069\u2026\n\n\u8da3\u5473\u3067\u4f5c\u3063\u3066\u3044\u308b\u30b5\u30fc\u30d3\u30b9\u306eAPI\u30b5\u30fc\u30d0\u3092\u4f8b\u306b\u3002\n\u30ad\u30e3\u30c3\u30b7\u30e5\u5fdc\u7b54\u3082\u542b\u3081\u3066\u96c6\u8a08\u3059\u308b\u3068\u3001\u6700\u6df7\u96d1\u6642\u306b\u306f90\u30d1\u30fc\u30bb\u30f3\u30bf\u30a4\u30eb\u5024\u30820ms\u306b\u306a\u308a\u307e\u3059\u3002\u6b63\u3057\u3044\u3068\u3044\u3048\u3070\u6b63\u3057\u3044\u306e\u3067\u3059\u304c\u3002\n\n![nginx_response_time](https://qiita-image-store.s3.amazonaws.com/0/152552/3040063f-fc99-8fcf-bdfd-018bdb2481c9.png)\n\n\u30ad\u30e3\u30c3\u30b7\u30e5\u5fdc\u7b54\u3092\u9664\u5916\u3055\u305b\u308b\u3068\u2026\u3000\u4e2d\u592e\u5024300ms\u5f37\u300299\u30d1\u30fc\u30bb\u30f3\u30bf\u30a4\u30eb\u5024\u306b\u4e0d\u5b89\u304c\u3042\u308a\u307e\u3059\u304c\u3001\u307e\u3042\u307e\u3042\u304b\u306a\u3002\n\n![nginx_response_time_without_cache](https://qiita-image-store.s3.amazonaws.com/0/152552/00362105-75e2-8b62-bf3e-f0f88670f852.png)\n", "tags": ["nginx", "Munin"]}