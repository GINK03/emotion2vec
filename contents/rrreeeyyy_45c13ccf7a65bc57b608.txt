{"context": " More than 1 year has passed since last update.\u3053\u306e\u8a18\u4e8b\u306f Kubernetes Advent Calendar \u306e 20 \u65e5\u76ee\u306e\u8a18\u4e8b\u3067\u3059\u3002\n\n\u6982\u8981\nCircleCI \u306b\u306f\u5b9f\u306f\u30c6\u30b9\u30c8\u304c\u901a\u3063\u305f\u5f8c\u306b Kubernetes \u306b\u30c7\u30d7\u30ed\u30a4\u3059\u308b\u6a5f\u80fd\u304c\u5b58\u5728\u3057\u307e\u3059\u3002\n\u3053\u3053\u3067\u306f\u3001GCE \u306b Kubernetes \u74b0\u5883\u3092\u69cb\u7bc9\u3057\u3001\u305d\u3053\u306b Private Dokcer Repository \u3092\u4f5c\u6210\u3057\u3001\nCircleCI \u3067\u30c6\u30b9\u30c8\u304c\u901a\u3063\u305f\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3092 Kubernetes \u4e0a\u306b\u30c7\u30d7\u30ed\u30a4\u3059\u308b\u65b9\u6cd5\u306b\u3064\u3044\u3066\u8aac\u660e\u3057\u307e\u3059\u3002\n\nKubernetes \u74b0\u5883\u3092\u624b\u306b\u5165\u308c\u308b\n\u3053\u3053\u306f\u3055\u304f\u3055\u304f\u884c\u304d\u307e\u3059\u3001\u524d\u8ff0\u306e\u3068\u304a\u308a GCE \u3092\u4f7f\u3044\u307e\u3059\u3002\n\u3053\u306e\u8fba\u308a\u306f\u4eca\u307e\u3067\u306e AdventCalendar \u3084 Qiita \u306e\u8a18\u4e8b\u3092\u8aad\u307f\u307e\u3057\u3087\u3046\u3002\n\u4e8b\u524d\u306b gcloud \u306e components \u3092 update \u3057\u3066\u304a\u304d\u307e\u3057\u3087\u3046\u3002(\u5fd8\u308c\u3066\u3066\u3061\u3083\u3093\u3068\u52d5\u304b\u306a\u304b\u3063\u305f)\n$ gcloud components update\n\nKubernetes \u3092 git \u304b\u3089 clone \u3057\u3066\u304d\u3066\u3001\u4ee5\u4e0b\u306e\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3057\u307e\u3059\u3002\n$ make release\n\n\u3082\u3057\u304b\u3057\u305f\u3089 boot2docker \u7b49\u306e docker \u74b0\u5883\u3092\u8981\u6c42\u3055\u308c\u308b\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u3002\u7528\u610f\u3057\u3066\u304a\u304d\u307e\u3057\u3087\u3046\u3002\n\u6b21\u306e\u624b\u9806\u3067\u306f\u3001minion \u304b\u3089 GCS \u3092\u4f7f\u3046\u305f\u3081\u306b\u3001cluster/gce/config-default.sh \u3092\u7de8\u96c6\u3057\u3001\nminion \u306e scopes \u3092 storage-full \u306b\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n--- a/cluster/gce/config-default.sh\n+++ b/cluster/gce/config-default.sh\n@@ -17,10 +17,10 @@\n # TODO(jbeda): Provide a way to override project\n # gcloud multiplexing for shared GCE/GKE tests.\n GCLOUD=gcloud\n ZONE=us-central1-b\n MASTER_SIZE=n1-standard-1\n MINION_SIZE=n1-standard-1\n NUM_MINIONS=4\n # TODO(dchen1107): Filed an internal issue to create an alias\n # for containervm image, so that gcloud will expand this\n # to the latest supported image.\n@@ -34,7 +34,7 @@ MINION_TAG=\"${INSTANCE_PREFIX}-minion\"\n MINION_NAMES=($(eval echo ${INSTANCE_PREFIX}-minion-{1..${NUM_MINIONS}}))\n CLUSTER_IP_RANGE=\"10.244.0.0/16\"\n MINION_IP_RANGES=($(eval echo \"10.244.{1..${NUM_MINIONS}}.0/24\"))\n-MINION_SCOPES=(\"storage-ro\" \"compute-rw\")\n+MINION_SCOPES=(\"storage-full\" \"compute-rw\")\n # Increase the sleep interval value if concerned about API rate limits. 3, in seconds, is the default.\n POLL_SLEEP_INTERVAL=3\n PORTAL_NET=\"10.0.0.0/16\"\n(END)\n\n\u4e0a\u8a18\u306e\u8a2d\u5b9a\u304c\u5b8c\u4e86\u3057\u305f\u3089\u3001Kubernetes \u74b0\u5883\u3092 GCE \u4e0a\u306b\u8d77\u52d5\u3057\u307e\u3059\u3002\ncluster/kube-up.sh\n\nkube-up.sh \u306f \u6614\u66f8\u3044\u305f\u6642\u3088\u308a\u8272\u3005\u9032\u5316\u3057\u3066\u3066\u611f\u52d5\u3057\u307e\u3057\u305f\u3002\n\u3084\u3063\u3066\u3044\u308b\u3053\u3068\u3084\u4f5c\u3089\u308c\u308b VM/\u30b9\u30c8\u30ec\u30fc\u30b8\u306f\u540c\u3058\u3067\u3059\u306e\u3067\u3001\n\u5185\u90e8\u3067\u4f55\u304c\u8d77\u304d\u3066\u3044\u308b\u304b\u6c17\u306b\u306a\u308b\u65b9\u306f\u6614\u66f8\u3044\u305f\u8a18\u4e8b\u3092\u3054\u89a7\u304f\u3060\u3055\u3044\u3002\n\u8a8d\u8a3c\u60c5\u5831\u306f\u6a19\u6e96\u51fa\u529b\u3067\u306a\u304f ~/.kunernetes-auth \u306b\u51fa\u529b\u3055\u308c\u308b\u3088\u3046\u306b\u306a\u3063\u305f\u6a21\u69d8\u3067\u3059\u3002\n\nKubernetes \u4e0a\u306e Private Docker Repository \u3092\u624b\u306b\u5165\u308c\u308b\n\ngoogle/docker-registry \u3092\u4f7f\u3046\nCircleCI \u3068\u306e\u9023\u643a\u306e\u305f\u3081\u306b docker \u3092\u304c\u3063\u3064\u308a\u4f7f\u3046\u306e\u3067\u3001\nprivate docker repository \u3092\u7528\u610f\u3057\u307e\u3057\u3087\u3046\u3002\ngoogle/docker-registry \u3092\u4f7f\u3044\u307e\u3059\u3002\ngoogle/docker-registry \u306f GCS \u4e0a\u306b private docker repository \u3092\u6301\u3064\u305f\u3081\u306e\u7269\u3067\u3059\u3002\n\u305b\u3063\u304b\u304f\u306a\u306e\u3067\u3001\u3053\u308c\u3082 Kubernetes \u4e0a\u306b\u4e57\u305b\u3066\u3057\u307e\u3046\u3053\u3068\u306b\u3057\u307e\u3059\u3002\n\u4e8b\u524d\u306b GCS \u306b bucket \u3092\u4f5c\u3063\u3066\u304a\u304d\u307e\u3059\u3002bucket \u306e\u540d\u524d\u306f\u5f8c\u3067\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u5185\u3067\u4f7f\u3046\u4e8b\u306b\u306a\u308b\u306e\u3067\u8a18\u9332\u3057\u3066\u304a\u304d\u307e\u3057\u3087\u3046\u3002\n$ gsutil mb -l ASIA gs://rrreeeyyy_docker_registry_bucket\n\nKubernetes \u306b\u4e57\u305b\u308b\u305f\u3081\u306b\u3001google/docker-registry \u306e\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\n\ndocker-registry-controller.json\n{\n  \"id\": \"dockerRegistryController\",\n  \"kind\": \"ReplicationController\",\n  \"apiVersion\": \"v1beta1\",\n  \"desiredState\": {\n    \"replicas\": 2,\n    \"replicaSelector\": {\"name\": \"dockerregistry\"},\n    \"podTemplate\": {\n      \"desiredState\": {\n         \"manifest\": {\n           \"version\": \"v1beta1\",\n           \"id\": \"dockerregistry\",\n           \"containers\": [{\n             \"name\": \"dockerregistry\",\n             \"image\": \"google/docker-registry\",\n             \"cpu\": 200,\n             \"ports\": [{\"containerPort\": 5000, \"hostPort\": 5000}],\n             \"env\": [{\"name\": \"GCS_BUCKET\", \"value\": \"rrreeeyyy_docker_registry_bucket\"}]\n           }]\n         }\n      },\n      \"labels\": {\n        \"name\": \"dockerregistry\",\n      }\n    }\n  },\n  \"labels\": {\"name\": \"dockerregistry\"}\n}\n\n\n\u30dd\u30a4\u30f3\u30c8\u306f\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306b GCS_BUCKET \u306b\u5148\u307b\u3069\u4f5c\u3063\u305f bucket \u306e\u540d\u524d\u3092\u767b\u9332\u3057\u3066\u304a\u304f\u3053\u3068\u3067\u3059\u3002\n\"env\": [{\"name\": \"GCS_BUCKET\", \"value\": \"rrreeeyyy_docker_registry_bucket\"}] \n\u4ee5\u4e0b\u306e\u30b3\u30de\u30f3\u30c9\u3067\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n$ cluster/kubectl.sh create -f docker-registry-controller.json\n\n\u6b21\u306b\u3001\u3069\u306e minion \u306b\u914d\u7f6e\u3055\u308c\u3066\u3082\u53c2\u7167\u3067\u304d\u308b\u3088\u3046\u306b\u3001\u30b5\u30fc\u30d3\u30b9\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\n\ndocker-registry-service.json\n{\n  \"id\": \"dockerregistry\",\n  \"kind\": \"Service\",\n  \"apiVersion\": \"v1beta1\",\n  \"port\": 5000,\n  \"containerPort\": 5000,\n  \"labels\": {\n    \"name\": \"dockerregistry\"\n  },\n  \"selector\": {\n    \"name\": \"dockerregistry\"\n  }\n}\n\n\n\u30b5\u30fc\u30d3\u30b9\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n$ cluster/kubectl.sh create -f docker-registry-service.json\n\nminion \u306b\u5bfe\u3057\u3066 5000 \u756a\u3092\u958b\u653e\u3059\u308b GCE \u306e\u30d5\u30a1\u30a4\u30a2\u30a6\u30a9\u30fc\u30eb\u30eb\u30fc\u30eb\u3092\u8ffd\u52a0\u3057\u307e\u3059\u3002\n$ gcloud compute firewall-rules create --allow=tcp:5000 --target-tags=kubernetes-minion kubernetes-minion-5000\n\n\u3053\u3053\u307e\u3067\u6765\u305f\u3089\u3001Pod \u304c\u5b9f\u969b\u306b\u4f5c\u6210\u3055\u308c\u3066\u3044\u308b\u304b\u78ba\u8a8d\u3057\u3066\u307f\u307e\u3057\u3087\u3046\u3002\n$ cluster/kubectl.sh get pods\nNAME                                   IMAGE(S)                       HOST                                                              LABELS                STATUS\n04f4c9f8-8771-11e4-b820-42010af08e38   google/docker-registry         kubernetes-minion-1.c.xxxx-xxxx-123.internal/xxx.xxx.xxx.xxx    name=dockerregistry   Running\n04f629c1-8771-11e4-b820-42010af08e38   google/docker-registry         kubernetes-minion-2.c.xxxx-xxxx-123.internal/xxx.xxx.xxx.xxx   name=dockerregistry   Running\n\n\u3069\u3061\u3089\u304b\u306e minion \u306e :5000 \u306b\u5bfe\u3057\u3066 curl \u3092\u6253\u3063\u3066\u307f\u307e\u3057\u3087\u3046\u3002\n$ curl xxx.xxx.xxx.xxx:5000\n\"docker-registry server (prod) (v0.8.1)\"\n\n\u3053\u306e\u3088\u3046\u306b\u8868\u793a\u3055\u308c\u308c\u3070 docker-registy \u304c\u3061\u3083\u3093\u3068 Kubernetes \u4e0a\u3067\u52d5\u3044\u3066\u3044\u305d\u3046\u3067\u3059\u3002\n(\u203b\u5b9f\u969b\u306b\u4f7f\u7528\u3059\u308b\u6642\u306f\u30a2\u30af\u30bb\u30b9\u5236\u9650\u3084 basic \u8a8d\u8a3c\u3092\u3061\u3083\u3093\u3068\u6295\u5165\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u305d\u3046\u3067\u3059\u3002)\n\nCircleCI \u3068\u9023\u643a\u3059\u308b\n\u3053\u308c\u3067 Private Docker Repository \u3092\u624b\u306b\u5165\u308c\u308b\u3053\u3068\u304c\u51fa\u6765\u307e\u3057\u305f\u3002\n\u3055\u3066\u3001CircleCI \u3068\u9023\u643a\u3057\u3066\u307f\u307e\u3057\u3087\u3046\u3002\nCircleCI \u304c\u516c\u958b\u3057\u3066\u3044\u308b\u3001\u30c6\u30b9\u30c8\u7528\u306e Rails \u30a2\u30d7\u30ea\u3092\u4f7f\u3063\u3066\u307f\u307e\u3057\u3087\u3046\u3002\n(circleci/docker-hello-google)\ncircle.yml \u3092\u898b\u308b\u3068\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002\n\nmachine:\n  services:\n    - docker\n\ndependencies:\n  cache_directories:\n    - ~/kubernetes\n  pre:\n    - ./ensure-kubernetes-installed.sh\n    - docker build -t $EXTERNAL_REGISTRY_ENDPOINT/hello:$CIRCLE_SHA1 .\n\ntest:\n  post:\n    - docker run -d -p 3000:3000 -e \"SECRET_KEY_BASE=abcd1234\" $EXTERNAL_REGISTRY_ENDPOINT/hello:$CIRCLE_SHA1; sleep 10\n    - curl --retry 10 --retry-delay 5 -v http://localhost:3000\n\ndeployment:\n  prod:\n    branch: master\n    commands:\n      - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS $EXTERNAL_REGISTRY_ENDPOINT\n      - envsubst < .kubernetes_auth.template > ~/.kubernetes_auth\n      - ./deploy.sh\n\n\u30dd\u30a4\u30f3\u30c8\u306f\u3001dependencies \u3067 Kubernetes \u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3066\u3044\u308b\u6240\u3068\u3001\ndeployment \u306e\u6240\u3067 ./deploy.sh \u3092\u5b9f\u884c\u3057\u3066\u3044\u308b\u6240\u3067\u3059\u3002\nensure-kubernetes-installed.sh \u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002\n#!/bin/bash\n\n# Exit on any error\nset -e\n\nKUBERNETES_VERSION=41eb15bcff4f114e95788f1e3a5ad3645c4e53fd\n\n# Exit if already installed\nif [[ -d ~/kubernetes ]]; then\n  echo \"Kubernetes already installed\"\n  exit 0\nelse\n  echo \"Installing Kubernetes...\"\nfi\n\n# Clone repo\n(cd ~ && git clone https://github.com/GoogleCloudPlatform/kubernetes.git)\n(cd ~/kubernetes && git reset --hard $KUBERNETES_VERSION)\n\n# Build go source\n(cd ~/kubernetes && hack/build-go.sh)\n\n\n\u3069\u3046\u3084\u3089\u666e\u901a\u306b Kubernetes \u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3066\u3044\u308b\u3060\u3051\u307f\u305f\u3044\u3067\u3059\u3002\n\u4e8c\u56de\u76ee\u4ee5\u964d\u306f\u30ad\u30e3\u30c3\u30b7\u30e5\u3059\u308b\u306e\u3067\u3001Kubernetes already installed \u3068\u8868\u793a\u3055\u308c\u3066\u30b9\u30ad\u30c3\u30d7\u3055\u308c\u3066\u3044\u307e\u3057\u305f\u3002\ndeployment \u306e\u90e8\u5206\u3067\u3059\u304c\u3001deploy.sh \u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002\n#!/bin/bash\n\n# Exit on any error\nset -e\n\nKUBE_CMD=${KUBERNETES_ROOT:-~/kubernetes}/cluster/kubecfg.sh\n\n# Deploy image to private GCS-backed registry\ndocker push $EXTERNAL_REGISTRY_ENDPOINT/hello:$CIRCLE_SHA1\n\n# Update Kubernetes replicationController\nenvsubst < kubernetes/rails-controller.json.template > rails-controller.json\n$KUBE_CMD -c rails-controller.json \\\n    update replicationControllers/railscontroller\n\n# Roll over Kubernetes pods\n$KUBE_CMD rollingupdate railscontroller\n\n\u3053\u3061\u3089\u306f\u3001$EXTERNAL_REGISTRY_ENDPOINT \u306b\u5bfe\u3057\u3066 Docker image \u3092 push\u3057\u3001\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u3092\u767b\u9332\u3057\u305f\u4e0a\u3067\u3001rollingupdate \u3092\u639b\u3051\u3066\u3044\u307e\u3059\u3002\nrollingupdate \u306f update-demo \u306b\u89e3\u8aac\u304c\u3042\u308a\u307e\u3059\u304c\u3001pod \u3092 1 \u53f0\u305a\u3064\u30a2\u30c3\u30d7\u30c7\u30fc\u30c8\u3059\u308b\u547d\u4ee4\u306e\u3088\u3046\u3067\u3059\u3002\n\u3068\u3044\u3046\u308f\u3051\u3067\u3001\u65e9\u901f\u3053\u306e\u30ea\u30dd\u30b8\u30c8\u30ea\u3092 fork \u3057\u3066\u3001CircleCI \u306b\u639b\u3051\u3066\u307f\u307e\u3057\u305f\u3002\nCircleCI \u306b\u639b\u3051\u308b\u969b\u306f\u3001\u4ee5\u4e0b\u306e\u74b0\u5883\u5909\u6570\u3092\u30bb\u30c3\u30c8\u3057\u306a\u3044\u3068\u3001deployment \u304c\u9014\u4e2d\u3067\u6b62\u307e\u3063\u3066\u3057\u307e\u3046\u306e\u3067\u6ce8\u610f\u3057\u3066\u4e0b\u3055\u3044\u3002\n\nKUBE_MASTER_IP\nKUBERNETES_PASS\nKUBERNETES_USER\nDOCKER_USER\nDOCKER_EMAIL\nDOCKER_PASS\nRAILS_SECRET\nINTERNAL_REGISTRY_ENDPOINT\nEXTERNAL_REGISTRY_ENDPOINT\n\nKubernetes \u306f\u3001\u4e0a\u8a18\u306e\u74b0\u5883\u5909\u6570\u304c\u30bb\u30c3\u30c8\u3055\u308c\u3066\u3044\u306a\u3044\u5834\u5408\u306b\u306f\u3001\u30d7\u30e9\u30c3\u30c8\u30d5\u30a9\u30fc\u30e0\u306b\u5fdc\u3058\u305f\u30b3\u30de\u30f3\u30c9\u3067\u81ea\u52d5\u7684\u306b\u4e0a\u8a18\u306e\u5024\u3092\u691c\u51fa\u3057\u3088\u3046\u3068\u3057\u307e\u3059\u3002\n\u4f8b\u3048\u3070\u3001KUBE_MASTER_IP \u304c\u30bb\u30c3\u30c8\u3055\u308c\u3066\u3044\u306a\u3044\u3088\u3046\u306a\u5834\u5408\u306b\u306f\u3001gcutil \u7b49\u306e\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3059\u308b\u3088\u3046\u3067\u3059\u3002\nCI \u74b0\u5883\u306b\u306f gcutil \u306e\u3088\u3046\u306a\u30b3\u30de\u30f3\u30c9\u306f\u5165\u3063\u3066\u3044\u306a\u3044\u305f\u3081\u3001\u305d\u3053\u3067 deployment \u304c\u6b62\u307e\u3063\u3066\u3057\u307e\u3044\u307e\u3059\u3002\n\u307e\u305f\u3001\u30b3\u30f3\u30c6\u30ca\u5185\u3067\u6700\u65b0\u306e kubernetes \u3092\u4f7f\u3044\u305f\u3044\u5834\u5408\u306f\u4ee5\u4e0b\u3092\u8a2d\u5b9a\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u305d\u3046\u3067\u3059\u3002\n(ensure-kubernetes-installed.sh \u306e\u30cf\u30c3\u30b7\u30e5\u5024\u3092\u66f8\u304d\u63db\u3048\u308b\u3053\u3068\u3067\u4f7f\u3046 Kubernetes \u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u3092\u5909\u3048\u3089\u308c\u307e\u3059)\n\nPROJECT\n\n\u3055\u3066\u3001\u6b63\u3057\u304f\u74b0\u5883\u5909\u6570\u3092\u30bb\u30c3\u30c8\u3057\u3066\u30ea\u30dd\u30b8\u30c8\u30ea\u3092 push \u3059\u308b\u3068\u3001CI \u306e\u6700\u5f8c\u306b\u4ee5\u4e0b\u306e\u3088\u3046\u306b deploy.sh \u3092\u5b9f\u884c\u3057\u3066\u3044\u307e\u3059\u3002\n\ndeploy.sh \u304c\u5b9f\u884c\u3055\u308c\u305f\u3089\u3001\u624b\u5143\u306e kubectl.sh \u3067 pods \u306e\u72b6\u6cc1\u3092\u78ba\u8a8d\u3057\u3066\u307f\u307e\u3057\u3087\u3046\u3002\n\u279c  git:(master) \u2717 ./cluster/kubectl.sh get pods\na59fdaf0-8792-11e4-b820-42010af08e38   xxx.xxx.xxx.xxx:5000/hello:latest   kubernetes-minion-1.c.xxxxx-xxxxx-xxx.internal/xxx.xxx.xxx.xxx    name=rails            Running\na5a05c0a-8792-11e4-b820-42010af08e38   xxx.xxx.xxx.xxx:5000/hello:latest   kubernetes-minion-2.c.xxxxx-xxxxx-xxx.internal/xxx.xxx.xxx.xxx   name=rails            Running\n\n\u3057\u3070\u3089\u304f\u3057\u3066\u304b\u3089 minion \u306e :3000 \u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3068\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u8868\u793a\u3055\u308c\u307e\u3059\u3002\n(GCE \u5074\u3067 :3000 \u3092 minion \u306b\u5bfe\u3057\u3066\u8a31\u53ef\u3059\u308b firewall-rule \u3092\u8ffd\u52a0\u3057\u3066\u304a\u304d\u307e\u3057\u3087\u3046)\n\n\n\u611f\u60f3\n\u4e00\u6614\u524d(9\u6708\u9803)\u306b\u89e6\u3063\u305f\u6642\u306b\u6bd4\u3079\u3001\u304b\u306a\u308a\u306e\u6a5f\u80fd\u304c\u5145\u5b9f\u3057\u3066\u304d\u307e\u3057\u305f\u3002\n\u4eca\u56de\u306e\u3088\u3046\u306b\u3001CI \u74b0\u5883\u3068\u9023\u643a\u3057\u3066\u3001\u30c6\u30b9\u30c8\u304c\u901a\u3063\u305f\u3089 Kubernetes \u74b0\u5883\u3078\u30c7\u30d7\u30ed\u30a4\u3001\u306e\u3088\u3046\u306a\u3053\u3068\u3082\u51fa\u6765\u308b\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u307e\u3057\u305f\u3002\n\u6b8b\u308b\u8ab2\u984c\u306f Kubernetes \u4e0a\u306b\u30c7\u30d7\u30ed\u30a4\u3057\u305f\u30a2\u30d7\u30ea\u306e\u30b9\u30c8\u30ec\u30fc\u30b8\u6c38\u7d9a\u5316\u3067\u3059\u3002\n\u73fe\u5728\u3001GCE \u3092\u4f7f\u7528\u3057\u305f\u5834\u5408\u306b\u306f GCS \u3092\u30b3\u30f3\u30c6\u30ca\u304c\u30de\u30a6\u30f3\u30c8\u3059\u308b\u3053\u3068\u304c\u51fa\u6765\u308b\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002\n(\u53c2\u8003: kubernetes/volumes )\n\u3082\u3057\u304f\u306f\u3001minion \u306e\u7279\u5b9a\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u30b3\u30f3\u30c6\u30ca\u304c\u30de\u30a6\u30f3\u30c8\u3059\u308b\u3053\u3068\u3082\u51fa\u6765\u307e\u3059\u3002\n\u305d\u306e\u305f\u3081\u3001\u5206\u6563\u30b9\u30c8\u30ec\u30fc\u30b8\u7b49\u3092 minion \u306b\u7528\u610f\u3059\u308c\u3070\u30b9\u30c8\u30ec\u30fc\u30b8\u3092\u6c38\u7d9a\u5316\u51fa\u6765\u308b\u3067\u3057\u3087\u3046\u3002\n\u3068\u3044\u3046\u74b0\u5883\u3092\u3057\u3063\u304b\u308a\u3068\u7528\u610f\u3059\u308c\u3070\u3001\n\u4f8b\u3048\u3070\u793e\u5185\u306e Docker \u7528 PaaS \u74b0\u5883\u3068\u3057\u3066 Kubernetes \u306f\u3046\u3063\u3066\u3064\u3051\u3067\u306f\u306a\u3044\u3067\u3057\u3087\u3046\u304b\u3002\n\u307e\u3060\u5b9f\u30b5\u30fc\u30d3\u30b9\u306b\u6295\u5165\u3059\u308b\u306b\u306f\u3084\u3084\u6016\u3044\u3067\u3059\u304c\u3001\u672c\u8a18\u4e8b\u306e\u3088\u3046\u306b\u30c6\u30b9\u30c8\u3057\u305f\u30b3\u30f3\u30c6\u30ca\u3092\u9069\u5f53\u306b\u5206\u6563\u3057\u3066\u3001\n\u518d\u8d77\u52d5\u7b49\u306e\u7ba1\u7406\u3082\u3088\u3057\u306a\u306b\u3084\u3063\u3066\u304f\u308c\u308b\u306e\u3067\u3001\u4fbf\u5229\u306a\u3088\u3046\u306b\u601d\u3048\u307e\u3059\u3002\n\u5f15\u304d\u7d9a\u304d\u76ee\u304c\u96e2\u305b\u306a\u3044\u30d7\u30ed\u30c0\u30af\u30c8\u306e 1 \u3064\u3067\u3042\u308b\u3068\u611f\u3058\u307e\u3057\u305f\u3002\n\n\u307e\u3068\u3081\n\nGCE+Kubenetes \u3067 Docker Private Repository \u3092\u4f5c\u6210\nKubernetes + CircleCI \u3067\u30c6\u30b9\u30c8\u304c\u901a\u3063\u305f\u30b3\u30f3\u30c6\u30ca\u3092\u30c7\u30d7\u30ed\u30a4\n\u793e\u5185 PaaS \u3068\u304b\u3067\u4f7f\u3048\u305d\u3046\u3002\n\n\n\u3053\u306e\u8a18\u4e8b\u306f [Kubernetes Advent Calendar](http://qiita.com/advent-calendar/2014/kubernetes) \u306e 20 \u65e5\u76ee\u306e\u8a18\u4e8b\u3067\u3059\u3002\n\n# \u6982\u8981\n\nCircleCI \u306b\u306f\u5b9f\u306f\u30c6\u30b9\u30c8\u304c\u901a\u3063\u305f\u5f8c\u306b Kubernetes \u306b\u30c7\u30d7\u30ed\u30a4\u3059\u308b\u6a5f\u80fd\u304c\u5b58\u5728\u3057\u307e\u3059\u3002\n\u3053\u3053\u3067\u306f\u3001GCE \u306b Kubernetes \u74b0\u5883\u3092\u69cb\u7bc9\u3057\u3001\u305d\u3053\u306b Private Dokcer Repository \u3092\u4f5c\u6210\u3057\u3001\nCircleCI \u3067\u30c6\u30b9\u30c8\u304c\u901a\u3063\u305f\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3092 Kubernetes \u4e0a\u306b\u30c7\u30d7\u30ed\u30a4\u3059\u308b\u65b9\u6cd5\u306b\u3064\u3044\u3066\u8aac\u660e\u3057\u307e\u3059\u3002\n\n# Kubernetes \u74b0\u5883\u3092\u624b\u306b\u5165\u308c\u308b\n\n\u3053\u3053\u306f\u3055\u304f\u3055\u304f\u884c\u304d\u307e\u3059\u3001\u524d\u8ff0\u306e\u3068\u304a\u308a GCE \u3092\u4f7f\u3044\u307e\u3059\u3002\n\u3053\u306e\u8fba\u308a\u306f\u4eca\u307e\u3067\u306e AdventCalendar \u3084 Qiita \u306e\u8a18\u4e8b\u3092\u8aad\u307f\u307e\u3057\u3087\u3046\u3002\n\n\u4e8b\u524d\u306b gcloud \u306e components \u3092 update \u3057\u3066\u304a\u304d\u307e\u3057\u3087\u3046\u3002(\u5fd8\u308c\u3066\u3066\u3061\u3083\u3093\u3068\u52d5\u304b\u306a\u304b\u3063\u305f)\n\n```\n$ gcloud components update\n```\n\nKubernetes \u3092 git \u304b\u3089 clone \u3057\u3066\u304d\u3066\u3001\u4ee5\u4e0b\u306e\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3057\u307e\u3059\u3002\n\n```\n$ make release\n```\n\n\u3082\u3057\u304b\u3057\u305f\u3089 boot2docker \u7b49\u306e docker \u74b0\u5883\u3092\u8981\u6c42\u3055\u308c\u308b\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u3002\u7528\u610f\u3057\u3066\u304a\u304d\u307e\u3057\u3087\u3046\u3002\n\n\u6b21\u306e\u624b\u9806\u3067\u306f\u3001minion \u304b\u3089 GCS \u3092\u4f7f\u3046\u305f\u3081\u306b\u3001```cluster/gce/config-default.sh``` \u3092\u7de8\u96c6\u3057\u3001\nminion \u306e scopes \u3092 ```storage-full``` \u306b\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\n```diff\n--- a/cluster/gce/config-default.sh\n+++ b/cluster/gce/config-default.sh\n@@ -17,10 +17,10 @@\n # TODO(jbeda): Provide a way to override project\n # gcloud multiplexing for shared GCE/GKE tests.\n GCLOUD=gcloud\n ZONE=us-central1-b\n MASTER_SIZE=n1-standard-1\n MINION_SIZE=n1-standard-1\n NUM_MINIONS=4\n # TODO(dchen1107): Filed an internal issue to create an alias\n # for containervm image, so that gcloud will expand this\n # to the latest supported image.\n@@ -34,7 +34,7 @@ MINION_TAG=\"${INSTANCE_PREFIX}-minion\"\n MINION_NAMES=($(eval echo ${INSTANCE_PREFIX}-minion-{1..${NUM_MINIONS}}))\n CLUSTER_IP_RANGE=\"10.244.0.0/16\"\n MINION_IP_RANGES=($(eval echo \"10.244.{1..${NUM_MINIONS}}.0/24\"))\n-MINION_SCOPES=(\"storage-ro\" \"compute-rw\")\n+MINION_SCOPES=(\"storage-full\" \"compute-rw\")\n # Increase the sleep interval value if concerned about API rate limits. 3, in seconds, is the default.\n POLL_SLEEP_INTERVAL=3\n PORTAL_NET=\"10.0.0.0/16\"\n(END)\n```\n\n\u4e0a\u8a18\u306e\u8a2d\u5b9a\u304c\u5b8c\u4e86\u3057\u305f\u3089\u3001Kubernetes \u74b0\u5883\u3092 GCE \u4e0a\u306b\u8d77\u52d5\u3057\u307e\u3059\u3002\n\n```\ncluster/kube-up.sh\n```\n\n```kube-up.sh``` \u306f [\u6614\u66f8\u3044\u305f\u6642](http://qiita.com/rrreeeyyy/items/da5931ec0d2d858583cf)\u3088\u308a\u8272\u3005\u9032\u5316\u3057\u3066\u3066\u611f\u52d5\u3057\u307e\u3057\u305f\u3002\n\u3084\u3063\u3066\u3044\u308b\u3053\u3068\u3084\u4f5c\u3089\u308c\u308b VM/\u30b9\u30c8\u30ec\u30fc\u30b8\u306f\u540c\u3058\u3067\u3059\u306e\u3067\u3001\n\u5185\u90e8\u3067\u4f55\u304c\u8d77\u304d\u3066\u3044\u308b\u304b\u6c17\u306b\u306a\u308b\u65b9\u306f\u6614\u66f8\u3044\u305f\u8a18\u4e8b\u3092\u3054\u89a7\u304f\u3060\u3055\u3044\u3002\n\n\u8a8d\u8a3c\u60c5\u5831\u306f\u6a19\u6e96\u51fa\u529b\u3067\u306a\u304f ```~/.kunernetes-auth``` \u306b\u51fa\u529b\u3055\u308c\u308b\u3088\u3046\u306b\u306a\u3063\u305f\u6a21\u69d8\u3067\u3059\u3002\n\n# Kubernetes \u4e0a\u306e Private Docker Repository \u3092\u624b\u306b\u5165\u308c\u308b\n\n## google/docker-registry \u3092\u4f7f\u3046\n\nCircleCI \u3068\u306e\u9023\u643a\u306e\u305f\u3081\u306b docker \u3092\u304c\u3063\u3064\u308a\u4f7f\u3046\u306e\u3067\u3001\nprivate docker repository \u3092\u7528\u610f\u3057\u307e\u3057\u3087\u3046\u3002\n\n[google/docker-registry](https://registry.hub.docker.com/u/google/docker-registry/) \u3092\u4f7f\u3044\u307e\u3059\u3002\n```google/docker-registry``` \u306f GCS \u4e0a\u306b private docker repository \u3092\u6301\u3064\u305f\u3081\u306e\u7269\u3067\u3059\u3002\n\u305b\u3063\u304b\u304f\u306a\u306e\u3067\u3001\u3053\u308c\u3082 Kubernetes \u4e0a\u306b\u4e57\u305b\u3066\u3057\u307e\u3046\u3053\u3068\u306b\u3057\u307e\u3059\u3002\n\n\u4e8b\u524d\u306b GCS \u306b bucket \u3092\u4f5c\u3063\u3066\u304a\u304d\u307e\u3059\u3002bucket \u306e\u540d\u524d\u306f\u5f8c\u3067\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u5185\u3067\u4f7f\u3046\u4e8b\u306b\u306a\u308b\u306e\u3067\u8a18\u9332\u3057\u3066\u304a\u304d\u307e\u3057\u3087\u3046\u3002\n\n```\n$ gsutil mb -l ASIA gs://rrreeeyyy_docker_registry_bucket\n```\n\nKubernetes \u306b\u4e57\u305b\u308b\u305f\u3081\u306b\u3001```google/docker-registry``` \u306e\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\n\n```docker-registry-controller.json\n{\n  \"id\": \"dockerRegistryController\",\n  \"kind\": \"ReplicationController\",\n  \"apiVersion\": \"v1beta1\",\n  \"desiredState\": {\n    \"replicas\": 2,\n    \"replicaSelector\": {\"name\": \"dockerregistry\"},\n    \"podTemplate\": {\n      \"desiredState\": {\n         \"manifest\": {\n           \"version\": \"v1beta1\",\n           \"id\": \"dockerregistry\",\n           \"containers\": [{\n             \"name\": \"dockerregistry\",\n             \"image\": \"google/docker-registry\",\n             \"cpu\": 200,\n             \"ports\": [{\"containerPort\": 5000, \"hostPort\": 5000}],\n             \"env\": [{\"name\": \"GCS_BUCKET\", \"value\": \"rrreeeyyy_docker_registry_bucket\"}]\n           }]\n         }\n      },\n      \"labels\": {\n        \"name\": \"dockerregistry\",\n      }\n    }\n  },\n  \"labels\": {\"name\": \"dockerregistry\"}\n}\n```\n\n\u30dd\u30a4\u30f3\u30c8\u306f\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306b ```GCS_BUCKET``` \u306b\u5148\u307b\u3069\u4f5c\u3063\u305f bucket \u306e\u540d\u524d\u3092\u767b\u9332\u3057\u3066\u304a\u304f\u3053\u3068\u3067\u3059\u3002\n\n```\"env\": [{\"name\": \"GCS_BUCKET\", \"value\": \"rrreeeyyy_docker_registry_bucket\"}]``` \n\n\n\u4ee5\u4e0b\u306e\u30b3\u30de\u30f3\u30c9\u3067\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n```bash\n$ cluster/kubectl.sh create -f docker-registry-controller.json\n```\n\n\u6b21\u306b\u3001\u3069\u306e minion \u306b\u914d\u7f6e\u3055\u308c\u3066\u3082\u53c2\u7167\u3067\u304d\u308b\u3088\u3046\u306b\u3001\u30b5\u30fc\u30d3\u30b9\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\n\n```docker-registry-service.json\n{\n  \"id\": \"dockerregistry\",\n  \"kind\": \"Service\",\n  \"apiVersion\": \"v1beta1\",\n  \"port\": 5000,\n  \"containerPort\": 5000,\n  \"labels\": {\n    \"name\": \"dockerregistry\"\n  },\n  \"selector\": {\n    \"name\": \"dockerregistry\"\n  }\n}\n```\n\n\u30b5\u30fc\u30d3\u30b9\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n```bash\n$ cluster/kubectl.sh create -f docker-registry-service.json\n```\n\nminion \u306b\u5bfe\u3057\u3066 5000 \u756a\u3092\u958b\u653e\u3059\u308b GCE \u306e\u30d5\u30a1\u30a4\u30a2\u30a6\u30a9\u30fc\u30eb\u30eb\u30fc\u30eb\u3092\u8ffd\u52a0\u3057\u307e\u3059\u3002\n\n```bash\n$ gcloud compute firewall-rules create --allow=tcp:5000 --target-tags=kubernetes-minion kubernetes-minion-5000\n```\n\n\u3053\u3053\u307e\u3067\u6765\u305f\u3089\u3001Pod \u304c\u5b9f\u969b\u306b\u4f5c\u6210\u3055\u308c\u3066\u3044\u308b\u304b\u78ba\u8a8d\u3057\u3066\u307f\u307e\u3057\u3087\u3046\u3002\n\n```bash\n$ cluster/kubectl.sh get pods\nNAME                                   IMAGE(S)                       HOST                                                              LABELS                STATUS\n04f4c9f8-8771-11e4-b820-42010af08e38   google/docker-registry         kubernetes-minion-1.c.xxxx-xxxx-123.internal/xxx.xxx.xxx.xxx    name=dockerregistry   Running\n04f629c1-8771-11e4-b820-42010af08e38   google/docker-registry         kubernetes-minion-2.c.xxxx-xxxx-123.internal/xxx.xxx.xxx.xxx   name=dockerregistry   Running\n```\n\n\u3069\u3061\u3089\u304b\u306e minion \u306e ```:5000``` \u306b\u5bfe\u3057\u3066 curl \u3092\u6253\u3063\u3066\u307f\u307e\u3057\u3087\u3046\u3002\n\n```bash\n$ curl xxx.xxx.xxx.xxx:5000\n\"docker-registry server (prod) (v0.8.1)\"\n```\n\n\u3053\u306e\u3088\u3046\u306b\u8868\u793a\u3055\u308c\u308c\u3070 docker-registy \u304c\u3061\u3083\u3093\u3068 Kubernetes \u4e0a\u3067\u52d5\u3044\u3066\u3044\u305d\u3046\u3067\u3059\u3002\n\n(\u203b\u5b9f\u969b\u306b\u4f7f\u7528\u3059\u308b\u6642\u306f\u30a2\u30af\u30bb\u30b9\u5236\u9650\u3084 basic \u8a8d\u8a3c\u3092\u3061\u3083\u3093\u3068\u6295\u5165\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u305d\u3046\u3067\u3059\u3002)\n\n# CircleCI \u3068\u9023\u643a\u3059\u308b\n\n\u3053\u308c\u3067 Private Docker Repository \u3092\u624b\u306b\u5165\u308c\u308b\u3053\u3068\u304c\u51fa\u6765\u307e\u3057\u305f\u3002\n\u3055\u3066\u3001CircleCI \u3068\u9023\u643a\u3057\u3066\u307f\u307e\u3057\u3087\u3046\u3002\n\nCircleCI \u304c\u516c\u958b\u3057\u3066\u3044\u308b\u3001\u30c6\u30b9\u30c8\u7528\u306e Rails \u30a2\u30d7\u30ea\u3092\u4f7f\u3063\u3066\u307f\u307e\u3057\u3087\u3046\u3002\n([circleci/docker-hello-google](https://github.com/circleci/docker-hello-google))\n\n```circle.yml``` \u3092\u898b\u308b\u3068\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002\n\n```yaml\n\nmachine:\n  services:\n    - docker\n    \ndependencies:\n  cache_directories:\n    - ~/kubernetes\n  pre:\n    - ./ensure-kubernetes-installed.sh\n    - docker build -t $EXTERNAL_REGISTRY_ENDPOINT/hello:$CIRCLE_SHA1 .\n\ntest:\n  post:\n    - docker run -d -p 3000:3000 -e \"SECRET_KEY_BASE=abcd1234\" $EXTERNAL_REGISTRY_ENDPOINT/hello:$CIRCLE_SHA1; sleep 10\n    - curl --retry 10 --retry-delay 5 -v http://localhost:3000\n\ndeployment:\n  prod:\n    branch: master\n    commands:\n      - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS $EXTERNAL_REGISTRY_ENDPOINT\n      - envsubst < .kubernetes_auth.template > ~/.kubernetes_auth\n      - ./deploy.sh\n```\n\n\u30dd\u30a4\u30f3\u30c8\u306f\u3001dependencies \u3067 Kubernetes \u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3066\u3044\u308b\u6240\u3068\u3001\ndeployment \u306e\u6240\u3067 ```./deploy.sh``` \u3092\u5b9f\u884c\u3057\u3066\u3044\u308b\u6240\u3067\u3059\u3002\n\n```ensure-kubernetes-installed.sh``` \u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002\n\n```bash\n#!/bin/bash\n\n# Exit on any error\nset -e\n\nKUBERNETES_VERSION=41eb15bcff4f114e95788f1e3a5ad3645c4e53fd\n\n# Exit if already installed\nif [[ -d ~/kubernetes ]]; then\n  echo \"Kubernetes already installed\"\n  exit 0\nelse\n  echo \"Installing Kubernetes...\"\nfi\n\n# Clone repo\n(cd ~ && git clone https://github.com/GoogleCloudPlatform/kubernetes.git)\n(cd ~/kubernetes && git reset --hard $KUBERNETES_VERSION)\n\n# Build go source\n(cd ~/kubernetes && hack/build-go.sh)\n\n```\n\n\u3069\u3046\u3084\u3089\u666e\u901a\u306b Kubernetes \u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3066\u3044\u308b\u3060\u3051\u307f\u305f\u3044\u3067\u3059\u3002\n\u4e8c\u56de\u76ee\u4ee5\u964d\u306f\u30ad\u30e3\u30c3\u30b7\u30e5\u3059\u308b\u306e\u3067\u3001```Kubernetes already installed``` \u3068\u8868\u793a\u3055\u308c\u3066\u30b9\u30ad\u30c3\u30d7\u3055\u308c\u3066\u3044\u307e\u3057\u305f\u3002\n\ndeployment \u306e\u90e8\u5206\u3067\u3059\u304c\u3001```deploy.sh``` \u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002\n\n```bash\n#!/bin/bash\n\n# Exit on any error\nset -e\n\nKUBE_CMD=${KUBERNETES_ROOT:-~/kubernetes}/cluster/kubecfg.sh\n\n# Deploy image to private GCS-backed registry\ndocker push $EXTERNAL_REGISTRY_ENDPOINT/hello:$CIRCLE_SHA1\n\n# Update Kubernetes replicationController\nenvsubst < kubernetes/rails-controller.json.template > rails-controller.json\n$KUBE_CMD -c rails-controller.json \\\n    update replicationControllers/railscontroller\n\n# Roll over Kubernetes pods\n$KUBE_CMD rollingupdate railscontroller\n```\n\n\u3053\u3061\u3089\u306f\u3001```$EXTERNAL_REGISTRY_ENDPOINT``` \u306b\u5bfe\u3057\u3066 Docker image \u3092 push\u3057\u3001\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u3092\u767b\u9332\u3057\u305f\u4e0a\u3067\u3001rollingupdate \u3092\u639b\u3051\u3066\u3044\u307e\u3059\u3002\n\nrollingupdate \u306f [update-demo](https://github.com/GoogleCloudPlatform/kubernetes/blob/master/examples/update-demo/README.md#step-four-update-the-docker-image) \u306b\u89e3\u8aac\u304c\u3042\u308a\u307e\u3059\u304c\u3001pod \u3092 1 \u53f0\u305a\u3064\u30a2\u30c3\u30d7\u30c7\u30fc\u30c8\u3059\u308b\u547d\u4ee4\u306e\u3088\u3046\u3067\u3059\u3002\n\n\u3068\u3044\u3046\u308f\u3051\u3067\u3001\u65e9\u901f\u3053\u306e\u30ea\u30dd\u30b8\u30c8\u30ea\u3092 fork \u3057\u3066\u3001CircleCI \u306b\u639b\u3051\u3066\u307f\u307e\u3057\u305f\u3002\nCircleCI \u306b\u639b\u3051\u308b\u969b\u306f\u3001\u4ee5\u4e0b\u306e\u74b0\u5883\u5909\u6570\u3092\u30bb\u30c3\u30c8\u3057\u306a\u3044\u3068\u3001deployment \u304c\u9014\u4e2d\u3067\u6b62\u307e\u3063\u3066\u3057\u307e\u3046\u306e\u3067\u6ce8\u610f\u3057\u3066\u4e0b\u3055\u3044\u3002\n\n\n- KUBE_MASTER_IP\n- KUBERNETES_PASS\n- KUBERNETES_USER\n- DOCKER_USER\n- DOCKER_EMAIL\n- DOCKER_PASS\n- RAILS_SECRET\n- INTERNAL_REGISTRY_ENDPOINT\n- EXTERNAL_REGISTRY_ENDPOINT\n\nKubernetes \u306f\u3001\u4e0a\u8a18\u306e\u74b0\u5883\u5909\u6570\u304c\u30bb\u30c3\u30c8\u3055\u308c\u3066\u3044\u306a\u3044\u5834\u5408\u306b\u306f\u3001\u30d7\u30e9\u30c3\u30c8\u30d5\u30a9\u30fc\u30e0\u306b\u5fdc\u3058\u305f\u30b3\u30de\u30f3\u30c9\u3067\u81ea\u52d5\u7684\u306b\u4e0a\u8a18\u306e\u5024\u3092\u691c\u51fa\u3057\u3088\u3046\u3068\u3057\u307e\u3059\u3002\n\u4f8b\u3048\u3070\u3001```KUBE_MASTER_IP``` \u304c\u30bb\u30c3\u30c8\u3055\u308c\u3066\u3044\u306a\u3044\u3088\u3046\u306a\u5834\u5408\u306b\u306f\u3001```gcutil``` \u7b49\u306e\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3059\u308b\u3088\u3046\u3067\u3059\u3002\nCI \u74b0\u5883\u306b\u306f ```gcutil``` \u306e\u3088\u3046\u306a\u30b3\u30de\u30f3\u30c9\u306f\u5165\u3063\u3066\u3044\u306a\u3044\u305f\u3081\u3001\u305d\u3053\u3067 deployment \u304c\u6b62\u307e\u3063\u3066\u3057\u307e\u3044\u307e\u3059\u3002\n\n\u307e\u305f\u3001\u30b3\u30f3\u30c6\u30ca\u5185\u3067\u6700\u65b0\u306e kubernetes \u3092\u4f7f\u3044\u305f\u3044\u5834\u5408\u306f\u4ee5\u4e0b\u3092\u8a2d\u5b9a\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u305d\u3046\u3067\u3059\u3002\n(```ensure-kubernetes-installed.sh``` \u306e\u30cf\u30c3\u30b7\u30e5\u5024\u3092\u66f8\u304d\u63db\u3048\u308b\u3053\u3068\u3067\u4f7f\u3046 Kubernetes \u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u3092\u5909\u3048\u3089\u308c\u307e\u3059)\n\n- PROJECT\n\n\u3055\u3066\u3001\u6b63\u3057\u304f\u74b0\u5883\u5909\u6570\u3092\u30bb\u30c3\u30c8\u3057\u3066\u30ea\u30dd\u30b8\u30c8\u30ea\u3092 push \u3059\u308b\u3068\u3001CI \u306e\u6700\u5f8c\u306b\u4ee5\u4e0b\u306e\u3088\u3046\u306b deploy.sh \u3092\u5b9f\u884c\u3057\u3066\u3044\u307e\u3059\u3002\n\n![deploy.sh](https://qiita-image-store.s3.amazonaws.com/0/48761/a2198971-5de1-84a2-c21b-6a897a8cd9df.png \"deploy.sh\")\n\ndeploy.sh \u304c\u5b9f\u884c\u3055\u308c\u305f\u3089\u3001\u624b\u5143\u306e kubectl.sh \u3067 pods \u306e\u72b6\u6cc1\u3092\u78ba\u8a8d\u3057\u3066\u307f\u307e\u3057\u3087\u3046\u3002\n\n```zsh\n\u279c  git:(master) \u2717 ./cluster/kubectl.sh get pods\na59fdaf0-8792-11e4-b820-42010af08e38   xxx.xxx.xxx.xxx:5000/hello:latest   kubernetes-minion-1.c.xxxxx-xxxxx-xxx.internal/xxx.xxx.xxx.xxx    name=rails            Running\na5a05c0a-8792-11e4-b820-42010af08e38   xxx.xxx.xxx.xxx:5000/hello:latest   kubernetes-minion-2.c.xxxxx-xxxxx-xxx.internal/xxx.xxx.xxx.xxx   name=rails            Running\n```\n\n\u3057\u3070\u3089\u304f\u3057\u3066\u304b\u3089 minion \u306e :3000 \u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3068\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u8868\u793a\u3055\u308c\u307e\u3059\u3002\n(GCE \u5074\u3067 :3000 \u3092 minion \u306b\u5bfe\u3057\u3066\u8a31\u53ef\u3059\u308b firewall-rule \u3092\u8ffd\u52a0\u3057\u3066\u304a\u304d\u307e\u3057\u3087\u3046)\n\n![circleci-k8s.png](https://qiita-image-store.s3.amazonaws.com/0/48761/2f33e843-976d-f67c-b29f-ab43403d8f3d.png \"circleci-k8s.png\")\n\n\n# \u611f\u60f3\n\n\u4e00\u6614\u524d(9\u6708\u9803)\u306b\u89e6\u3063\u305f\u6642\u306b\u6bd4\u3079\u3001\u304b\u306a\u308a\u306e\u6a5f\u80fd\u304c\u5145\u5b9f\u3057\u3066\u304d\u307e\u3057\u305f\u3002\n\u4eca\u56de\u306e\u3088\u3046\u306b\u3001CI \u74b0\u5883\u3068\u9023\u643a\u3057\u3066\u3001\u30c6\u30b9\u30c8\u304c\u901a\u3063\u305f\u3089 Kubernetes \u74b0\u5883\u3078\u30c7\u30d7\u30ed\u30a4\u3001\u306e\u3088\u3046\u306a\u3053\u3068\u3082\u51fa\u6765\u308b\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u307e\u3057\u305f\u3002\n\n\u6b8b\u308b\u8ab2\u984c\u306f Kubernetes \u4e0a\u306b\u30c7\u30d7\u30ed\u30a4\u3057\u305f\u30a2\u30d7\u30ea\u306e\u30b9\u30c8\u30ec\u30fc\u30b8\u6c38\u7d9a\u5316\u3067\u3059\u3002\n\n\u73fe\u5728\u3001GCE \u3092\u4f7f\u7528\u3057\u305f\u5834\u5408\u306b\u306f GCS \u3092\u30b3\u30f3\u30c6\u30ca\u304c\u30de\u30a6\u30f3\u30c8\u3059\u308b\u3053\u3068\u304c\u51fa\u6765\u308b\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002\n(\u53c2\u8003: [kubernetes/volumes](https://github.com/GoogleCloudPlatform/kubernetes/blob/master/docs/volumes.md) )\n\n\u3082\u3057\u304f\u306f\u3001minion \u306e\u7279\u5b9a\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u30b3\u30f3\u30c6\u30ca\u304c\u30de\u30a6\u30f3\u30c8\u3059\u308b\u3053\u3068\u3082\u51fa\u6765\u307e\u3059\u3002\n\u305d\u306e\u305f\u3081\u3001\u5206\u6563\u30b9\u30c8\u30ec\u30fc\u30b8\u7b49\u3092 minion \u306b\u7528\u610f\u3059\u308c\u3070\u30b9\u30c8\u30ec\u30fc\u30b8\u3092\u6c38\u7d9a\u5316\u51fa\u6765\u308b\u3067\u3057\u3087\u3046\u3002\n\n\u3068\u3044\u3046\u74b0\u5883\u3092\u3057\u3063\u304b\u308a\u3068\u7528\u610f\u3059\u308c\u3070\u3001\n\u4f8b\u3048\u3070\u793e\u5185\u306e Docker \u7528 PaaS \u74b0\u5883\u3068\u3057\u3066 Kubernetes \u306f\u3046\u3063\u3066\u3064\u3051\u3067\u306f\u306a\u3044\u3067\u3057\u3087\u3046\u304b\u3002\n\u307e\u3060\u5b9f\u30b5\u30fc\u30d3\u30b9\u306b\u6295\u5165\u3059\u308b\u306b\u306f\u3084\u3084\u6016\u3044\u3067\u3059\u304c\u3001\u672c\u8a18\u4e8b\u306e\u3088\u3046\u306b\u30c6\u30b9\u30c8\u3057\u305f\u30b3\u30f3\u30c6\u30ca\u3092\u9069\u5f53\u306b\u5206\u6563\u3057\u3066\u3001\n\u518d\u8d77\u52d5\u7b49\u306e\u7ba1\u7406\u3082\u3088\u3057\u306a\u306b\u3084\u3063\u3066\u304f\u308c\u308b\u306e\u3067\u3001\u4fbf\u5229\u306a\u3088\u3046\u306b\u601d\u3048\u307e\u3059\u3002\n\u5f15\u304d\u7d9a\u304d\u76ee\u304c\u96e2\u305b\u306a\u3044\u30d7\u30ed\u30c0\u30af\u30c8\u306e 1 \u3064\u3067\u3042\u308b\u3068\u611f\u3058\u307e\u3057\u305f\u3002\n\n# \u307e\u3068\u3081\n\n- GCE+Kubenetes \u3067 Docker Private Repository \u3092\u4f5c\u6210\n- Kubernetes + CircleCI \u3067\u30c6\u30b9\u30c8\u304c\u901a\u3063\u305f\u30b3\u30f3\u30c6\u30ca\u3092\u30c7\u30d7\u30ed\u30a4\n- \u793e\u5185 PaaS \u3068\u304b\u3067\u4f7f\u3048\u305d\u3046\u3002\n", "tags": ["kubernetes", "CircleCI", "gcp"]}