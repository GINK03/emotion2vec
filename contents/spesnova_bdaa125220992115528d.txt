{"context": " More than 1 year has passed since last update.\n\n\u6982\u8981\nCoreOS \u4e0a\u3067\u306e\u30b5\u30fc\u30d3\u30b9\u30c7\u30a3\u30b9\u30ab\u30d0\u30ea\u306b SkyDNS2 \u3092\u5229\u7528\u3059\u308b\u3068\u3044\u3046\u8a71\u3002SkyDNS2 \u306f Docker \u30b3\u30f3\u30c6\u30ca\u3068\u3057\u3066\u52d5\u304b\u3059\u3002\n\nSkyDNS2 \u3068\u306f\nDNS \u30b5\u30fc\u30d0\u306e\u4e00\u3064\u3002\u30c7\u30fc\u30bf\u306e\u4fdd\u5b58\u5148\u306b etcd \u3092\u4f7f\u3046\u3053\u3068\u3067\u5206\u6563 DNS \u30b5\u30fc\u30d0\u3092\u5b9f\u73fe\u3057\u3066\u308b\u3002\u4f8b\u3048\u3070\u3001 5 \u53f0\u306e CoreOS \u30de\u30b7\u30f3\u304b\u3089\u306a\u308b\u30af\u30e9\u30b9\u30bf\u304c\u3042\u308b\u3068\u304d\u3001\u5404\u30de\u30b7\u30f3\u3067 SkyDNS2 \u3092\u8d77\u52d5\u3055\u305b\u3066\u304a\u304f\u3002etcd \u306b\u30c7\u30fc\u30bf\u3092\u7f6e\u3044\u3066\u3044\u308b\u306e\u3067\u3001\u3069\u306e\u30de\u30b7\u30f3\u306e SkyDNS2 \u3092\u5229\u7528\u3057\u3066\u3082\u540c\u3058\u7d50\u679c\u306b\u306a\u308b\u3002\n\u305d\u3057\u3066\u3001\u5f8c\u8ff0\u3059\u308b SRV \u30ec\u30b3\u30fc\u30c9\u3092\u8fd4\u3059\u3053\u3068\u3067\u5358\u306a\u308b DNS \u30b5\u30fc\u30d0\u3068\u3044\u3046\u3088\u308a\u306f\u30b5\u30fc\u30d3\u30b9\u30c7\u30a3\u30b9\u30ab\u30d0\u30ea\u30fc\u3092\u5b9f\u73fe\u3059\u308b\u305f\u3081\u306e\u30b5\u30fc\u30d3\u30b9\u3068\u3044\u3046\u4f4d\u7f6e\u3065\u3051\u306b\u306a\u3063\u3066\u3044\u308b\u3002\n\n\u30b5\u30fc\u30d3\u30b9\u30c7\u30a3\u30b9\u30ab\u30d0\u30ea\u30fc\u306b SRV \u30ec\u30b3\u30fc\u30c9\u3092\u4f7f\u3046\nSRV \u30ec\u30b3\u30fc\u30c9\u306e\u30dd\u30a4\u30f3\u30c8\u306f\n\n\u30dd\u30fc\u30c8\u60c5\u5831\u307e\u3067\u6301\u3063\u3066\u308b\u3053\u3068\n\u8ca0\u8377\u5206\u6563\u3067\u304d\u308b\u3053\u3068\n\n\n\u30dd\u30fc\u30c8\u60c5\u5831\u307e\u3067\u6301\u3063\u3066\u3044\u308b\u3053\u3068\nDNS \u306f\u901a\u5e38\u540d\u524d <---> IP \u306e\u89e3\u6c7a\u3092\u3059\u308b\u3060\u3051\u306a\u306e\u3067\u3001\u3042\u308b\u30b5\u30fc\u30d3\u30b9\u4f7f\u3044\u305f\u3044\u5834\u5408\u3001\u300c\u3069\u306e IP \u306e\u3069\u3053\u306e\u30dd\u30fc\u30c8\u306b\u7e4b\u3052\u3070\u826f\u3044\uff1f\u300d\u307f\u305f\u3044\u306a\u5834\u5408\u306b\u5229\u7528\u51fa\u6765\u306a\u3044\u3002\u304c SRV \u30ec\u30b3\u30fc\u30c9 \u3092\u4f7f\u3046\u3068\u3001IP+\u30dd\u30fc\u30c8\u60c5\u5831\u307e\u3067\u6301\u305f\u305b\u3089\u308c\u308b\u306e\u3067\u30b5\u30fc\u30d3\u30b9\u30c7\u30a3\u30b9\u30ab\u30d0\u30ea\u30fc\u306b\u5229\u7528\u51fa\u6765\u308b\u3002\n# \u4f8b\n$ dig SRV 1.rails.skydns.local\n\n;; ANSWER SECTION:\n1.rails.skydns.local. 3600  IN  SRV 10 100 8080 1.rails.skydns.local.\n\n# ANSWER SECTION \u306f\u4ee5\u4e0b\u306e\u5185\u5bb9\u304c\u66f8\u304b\u308c\u3066\u3044\u308b\n# service name, environment, TTL, priority, weight, service port, host name\n\n\u3055\u3089\u306b\u3001 SRV \u30ec\u30b3\u30fc\u30c9\u306f\u8ca0\u8377\u5206\u6563\u306b\u3082\u5229\u7528\u3067\u304d\u308b\u3002\n\n\u8ca0\u8377\u5206\u6563\u3067\u304d\u308b\u3053\u3068\nSRV \u30ec\u30b3\u30fc\u30c9\u306f\u3001\n\nPriority\nWeight\n\n\u3068\u3044\u3046\u60c5\u5831\u3082\u6301\u305f\u305b\u3089\u308c\u308b\u3002 Priority \u306e\u5024\u306e\u5c0f\u3055\u3044\u65b9\u304b\u3089\u512a\u5148\u7684\u306b\u901a\u4fe1\u3055\u308c\u308b\u3002 Weight \u306f\u540c\u3058\u512a\u5148\u9806\u4f4d\u306e\u30db\u30b9\u30c8\u90e1\u3067\u306e\u632f\u308a\u5206\u3051\u5177\u5408\u3092\u6c7a\u3081\u3089\u308c\u308b\u3002\n\nSkyDNS2 \u3092\u4f7f\u3063\u305f\u30b5\u30fc\u30d3\u30b9\u30c7\u30a3\u30b9\u30ab\u30d0\u30ea\n\nSkyDNS2 \u306e Docker \u30a4\u30e1\u30fc\u30b8\u4f5c\u6210\n# on CoreOS machine\ncore@core-01 ~ $ git clone https://github.com/skynetservices/skydns.git\ncore@core-01 ~ $ cd skydns\n\n\u540c\u68b1\u3055\u308c\u3066\u3044\u308b Dockerfile \u306f language stack \u3092\u4f7f\u3063\u3066\u3044\u306a\u3044\u3002\u306a\u308b\u3060\u3051 language stack \u30d9\u30fc\u30b9\u306e\u30a4\u30e1\u30fc\u30b8\u3092\u4f7f\u3044\u305f\u3044\u306e\u3067\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u7de8\u96c6\u3057\u3066\u30d3\u30eb\u30c9\u3057\u305f\u3002\n# Dockerfile\nFROM golang:1.3.3\nMAINTAINER Miek Gieben <miek@miek.nl> (@miekg)\n\nADD . /go/src/github.com/skynetservices/skydns\nRUN go get github.com/skynetservices/skydns\n\nEXPOSE 53\nENTRYPOINT [\"skydns\"]\n\ncore@core-01 ~ $ docker build -t skydns2 .\n\n\nSkyDNS \u306e\u30c7\u30d5\u30a9\u30eb\u30c8\u8a2d\u5b9a\u3092 etcd \u306b\u30bb\u30c3\u30c8\ncore@core-01 ~ $ curl -L -XPUT http://172.17.8.101:4001/v2/keys/skydns/config -d value='{\"nameservers\": [\"8.8.8.8:53\",\"8.8.4.4:53\"]}'\n\n\nSkyDNS2 \u30b3\u30f3\u30c6\u30ca\u8d77\u52d5\n# SkyDNS2 \u306e UDP 53 \u30dd\u30fc\u30c8\u3092\u30db\u30b9\u30c8\u306e Private IP\u306e 53 \u30dd\u30fc\u30c8\u306b bind \ncore@core-01 ~/skydns $ docker run \\\n  -d \\\n  --name skydns2 \\\n  -p 172.17.8.101:53:53/udp \\\n  -e ETCD_MACHINES='172.17.8.101:4001,172.17.8.102:4001,172.17.8.103:4001' \\\n  skydns2:latest \\\n  -addr=0.0.0.0:53\n\ncore@core-01 ~ $ docker logs skydns2\n[skydns] Oct 14 03:26:33.702 INFO      | ready for queries on skydns.local. for tcp://0.0.0.0:53 [rcache 0]\n[skydns] Oct 14 03:26:33.702 INFO      | ready for queries on skydns.local. for udp://0.0.0.0:53 [rcache 0]\n[skydns] Oct 14 03:27:51.679 INFO      | no nameservers defined or name too short, can not forward\n[skydns] Oct 14 03:27:51.679 INFO      | no nameservers defined or name too short, can not forward\n\n\u3053\u308c\u3067 Core-01 \u306e Private IP (172.17.8.101) \u3092 DNS nameserver \u3068\u3057\u3066\u5229\u7528\u51fa\u6765\u308b\u306b\u306a\u308b\n\netcd \u306b\u30b5\u30fc\u30d3\u30b9\u60c5\u5831\u3092\u30bb\u30c3\u30c8\nCore-01 \u4e0a\u306b\u8d77\u52d5\u3057\u3066\u3044\u308b logspout \u3092 logspout.1 \u306e\u3088\u3046\u306b\u30013 \u53f0\u767b\u9332\u3059\u308b\u3053\u3068\u306b\u3059\u308b\nlogspout.1.json\n{\n  \"host\":\"172.17.8.101\",\n  \"port\":8080\n}\n\nlogspout.2.json\n{\n  \"host\":\"172.17.8.102\",\n  \"port\":8080\n}\n\nlogspout.3.json\n{\n  \"host\":\"172.17.8.103\",\n  \"port\":8080\n}\n\netcd \u306b\u30bb\u30c3\u30c8\ncore@core-01 ~ $ curl -L -XPUT http://172.17.8.101:4001/v2/keys/skydns/local/skydns/logspout/1 --data-urlencode value@logspout.1.json\n{\"action\":\"set\",\"node\":{\"key\":\"/skydns/local/skydns/logspout/1\",\"value\":\"{\\n  \\\"host\\\":\\\"172.17.8.101\\\",\\n  \\\"port\\\":8000\\n}\\n\",\"modifiedIndex\":9000,\"createdIndex\":9000},\"prevNode\":{\"key\":\"/skydns/local/skydns/logspout/1\",\"value\":\"\",\"modifiedIndex\":8995,\"createdIndex\":8995}}\n\ncore@core-01 ~ $ curl -L -XPUT http://172.17.8.101:4001/v2/keys/skydns/local/skydns/logspout/2 --data-urlencode value@logspout.2.json\n{\"action\":\"set\",\"node\":{\"key\":\"/skydns/local/skydns/logspout/2\",\"value\":\"{\\n  \\\"host\\\":\\\"172.17.8.102\\\",\\n  \\\"port\\\":8000\\n}\\n\",\"modifiedIndex\":8887,\"createdIndex\":8887}}\n\ncore@core-01 ~ $ curl -L -XPUT http://172.17.8.101:4001/v2/keys/skydns/local/skydns/logspout/3 --data-urlencode value@logspout.3.json\n{\"action\":\"set\",\"node\":{\"key\":\"/skydns/local/skydns/logspout/3\",\"value\":\"{\\n  \\\"host\\\":\\\"172.17.8.103\\\",\\n  \\\"port\\\":8000\\n}\\n\",\"modifiedIndex\":9022,\"createdIndex\":9022}}\n\n\nCoreOS \u30de\u30b7\u30f3\u4e0a\u306e\u30d7\u30e9\u30a4\u30de\u30ea DNS \u30b5\u30fc\u30d0\u3092 SkyDNS2 \u306b\u5909\u66f4\u3059\u308b\nSkyDNS2 \u3067\u306e\u8a2d\u5b9a\u306e\u3068\u304a\u308a\u3001\u30c9\u30e1\u30a4\u30f3\u306e\u6a29\u5a01\u304c\u7121\u3044\u554f\u3044\u5408\u308f\u305b\u304c\u5c4a\u3044\u305f\u6642\u306f 8.8.8.8:53 \u3068 8.8.4.4:53 \u306b\u8ee2\u9001\u3059\u308b\u306e\u3067\u3001SkyDNS2 \u30d7\u30e9\u30a4\u30de\u30ea DNS \u30b5\u30fc\u30d0\u3068\u3057\u3066\u6271\u3048\u308b\u3002\ncore@core-01 ~ $ cat /etc/resolv.conf\n# This file is managed by systemd-resolved(8). Do not edit.\n#\n# Third party programs must not access this file directly, but\n# only through the symlink at /etc/resolv.conf. To manage\n# resolv.conf(5) in a different way, replace the symlink by a\n# static file or a different symlink.\n\n#nameserver 10.0.2.3\nnameserver 172.17.8.101 # -> \u66f8\u304d\u63db\u3048\n\n\uff08\u76f4\u306b\u66f8\u304d\u63db\u3048\u308b\u306e\u306f\u826f\u304f\u306f\u306a\u3044\uff09\n\nCoreOS \u30de\u30b7\u30f3\uff08\u30b3\u30f3\u30c6\u30ca\u30db\u30b9\u30c8\uff09\u304b\u3089 ping \u3057\u3066\u307f\u308b\nping \u3067\u304d\u308b\u304b\u78ba\u8a8d\u3057\u3066\u307f\u308b\n\uff08CoreOS \u306b\u306f\u3001dig \u304c\u5165\u3063\u3066\u306a\u3044\u3002\uff09\ncore@core-01 ~ $ ping 1.logspout.skydns.local\nPING 1.logspout.skydns.local (172.17.8.101) 56(84) bytes of data.\n64 bytes from 172.17.8.101: icmp_seq=1 ttl=64 time=0.113 ms\n64 bytes from 172.17.8.101: icmp_seq=2 ttl=64 time=0.031 ms\n64 bytes from 172.17.8.101: icmp_seq=3 ttl=64 time=0.039 ms\n64 bytes from 172.17.8.101: icmp_seq=4 ttl=64 time=0.032 ms\n64 bytes from 172.17.8.101: icmp_seq=5 ttl=64 time=0.048 ms\n\n# Core-02 \u306e logspout \u306b\u632f\u308a\u5206\u3051\u3055\u308c\u305f\ncore@core-01 ~ $ ping logspout.skydns.local\nPING logspout.skydns.local (172.17.8.102) 56(84) bytes of data.\n64 bytes from 172.17.8.102: icmp_seq=1 ttl=64 time=0.369 ms\n64 bytes from 172.17.8.102: icmp_seq=2 ttl=64 time=0.437 ms\n64 bytes from 172.17.8.102: icmp_seq=3 ttl=64 time=0.409 ms\n64 bytes from 172.17.8.102: icmp_seq=4 ttl=64 time=0.429 ms\n\n# \u4eca\u5f8c\u306f Core-03 \u306b\u632f\u308a\u5206\u3051\u3055\u308c\u305f\u3002\n# \u63a5\u7d9a\u3059\u308b\u3054\u3068\u306b\u63a5\u7d9a\u5148\u30db\u30b9\u30c8\u304c\u5909\u308f\u308b = \u8ca0\u8377\u5206\u6563\u3055\u308c\u3066\u308b\u3053\u3068\u304c\u308f\u304b\u308b\ncore@core-01 ~ $ ping logspout.skydns.local\nPING logspout.skydns.local (172.17.8.103) 56(84) bytes of data.\n64 bytes from 172.17.8.103: icmp_seq=1 ttl=64 time=0.290 ms\n64 bytes from 172.17.8.103: icmp_seq=2 ttl=64 time=0.417 ms\n64 bytes from 172.17.8.103: icmp_seq=3 ttl=64 time=0.477 ms\n\n\nruby \u30b3\u30f3\u30c6\u30ca\u304b\u3089 SRV \u30ec\u30b3\u30fc\u30c9\u3092\u53d6\u5f97\u3057\u3066\u307f\u308b\n#!/usr/local/bin/ruby\n# get_srv.rb\n\nrequire 'resolv'\nrequire 'pp'\n\nresolver = Resolv::DNS.new(:nameserver => ['172.17.8.101'], :search => ['skydns.local'], :ndots => 1)\nhosts = resolver.getresources('logspout.skydns.local', Resolv::DNS::Resource::IN::SRV)\npp hosts\nputs \"\"\npp hosts.map{|h| (h.target.to_s + \":\" + h.port.to_s) }\n\n$ ruby get_srv.rb\n\n[#<Resolv::DNS::Resource::IN::SRV:0x007f47882f6620\n  @port=8000,\n  @priority=10,\n  @target=#<Resolv::DNS::Name: 1.logspout.skydns.local.>,\n  @ttl=3600,\n  @weight=33>,\n #<Resolv::DNS::Resource::IN::SRV:0x007f47882f5518\n  @port=8080,\n  @priority=10,\n  @target=#<Resolv::DNS::Name: 2.logspout.skydns.local.>,\n  @ttl=3600,\n  @weight=33>,\n #<Resolv::DNS::Resource::IN::SRV:0x007f47882f45c8\n  @port=8080,\n  @priority=10,\n  @target=#<Resolv::DNS::Name: 3.logspout.skydns.local.>,\n  @ttl=3600,\n  @weight=33>]\n\n[\"1.logspout.skydns.local:8000\",\n \"2.logspout.skydns.local:8080\",\n \"3.logspout.skydns.local:8080\"]\n\n\nubuntu:14.04 \u30b3\u30f3\u30c6\u30ca\u304b\u3089 ping \u3057\u3066\u307f\u308b\n# on CoreOS\ncore@core-01 ~ $ docker run -it --rm --dns=172.17.8.101 ubuntu:14.04 /bin/bash\n\n# \u30b3\u30f3\u30c6\u30ca\u5185\u304b\u3089 ping \u3057\u3066\u307f\u308b\nroot@91fcca071b27:/$ ping 1.logspout.skydns.local\nPING 1.logspout.skydns.local (172.17.8.101) 56(84) bytes of data.\n64 bytes from 172.17.8.101: icmp_seq=1 ttl=64 time=0.029 ms\n64 bytes from 172.17.8.101: icmp_seq=2 ttl=64 time=0.038 ms\n64 bytes from 172.17.8.101: icmp_seq=3 ttl=64 time=0.063 ms\n64 bytes from 172.17.8.101: icmp_seq=4 ttl=64 time=0.053 ms\n\n\nubuntu:14.04 \u30b3\u30f3\u30c6\u30ca\u304b\u3089 dig \u3057\u3066\u307f\u308b\nimage ubuntu:14.04 \u3067\u306f dig \u304c\u5165\u3063\u3066\u306a\u3044\u306e\u3067\u5165\u308c\u308b\n# in ubuntu:14.04, install dig\nroot@952708774c41:/$ sudo apt-get update && sudp apt-get install dnsutils\n\nskydns.local \u306e\u30c9\u30e1\u30a4\u30f3\u60c5\u5831\u53d6\u5f97\nroot@41ea3b47bc69:/$ dig skydns.local\n\n; <<>> DiG 9.9.5-3-Ubuntu <<>> skydns.local\n;; global options: +cmd\n;; Got answer:\n;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 29922\n;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 0\n\n;; QUESTION SECTION:\n;skydns.local.          IN  A\n\n;; ANSWER SECTION:\nskydns.local.       3600    IN  A   172.17.8.101\n\n;; Query time: 17 msec\n;; SERVER: 172.17.8.101#53(172.17.8.101)\n;; WHEN: Tue Oct 14 09:44:11 UTC 2014\n;; MSG SIZE  rcvd: 46\n\n1.logspout.skydns.local \u306e SRV \u60c5\u5831\u3092\u53d6\u5f97\u3002\u5148\u307b\u3069 etcd \u306b\u30bb\u30c3\u30c8\u3057\u305f /skydns/local/logspout/1 \u306e\u60c5\u5831\u304c\u8fd4\u3063\u3066\u304f\u308b\u3002\nroot@41ea3b47bc69:/# dig SRV 1.logspout.skydns.local\n\n; <<>> DiG 9.9.5-3-Ubuntu <<>> SRV 1.logspout.skydns.local\n;; global options: +cmd\n;; Got answer:\n;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 51547\n;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1\n\n;; QUESTION SECTION:\n;1.logspout.skydns.local.   IN  SRV\n\n;; ANSWER SECTION:\n1.logspout.skydns.local. 3600   IN  SRV 10 100 8000 1.logspout.skydns.local.\n\n;; ADDITIONAL SECTION:\n1.logspout.skydns.local. 3600   IN  A   172.17.8.101\n\n;; Query time: 13 msec\n;; SERVER: 172.17.8.101#53(172.17.8.101)\n;; WHEN: Tue Oct 14 10:33:28 UTC 2014\n;; MSG SIZE  rcvd: 100\n\nwildcard \u3082\u5229\u7528\u3067\u304d\u308b\u3002\n*.logspout.skydns.local \u306e SRV \u60c5\u5831\u3092\u53d6\u5f97\u3002\u5148\u307b\u3069 etcd \u306b\u30bb\u30c3\u30c8\u3057\u305f /skydns/local/logspout/* \u306e\u60c5\u5831\u304c\u8fd4\u3063\u3066\u304f\u308b\u3002\nroot@41ea3b47bc69:/$ dig SRV *.logspout.skydns.local\n\n; <<>> DiG 9.9.5-3-Ubuntu <<>> SRV *.logspout.skydns.local\n;; global options: +cmd\n;; Got answer:\n;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 2579\n;; flags: qr aa rd ra; QUERY: 1, ANSWER: 3, AUTHORITY: 0, ADDITIONAL: 3\n\n;; QUESTION SECTION:\n;*.logspout.skydns.local.   IN  SRV\n\n;; ANSWER SECTION:\n*.logspout.skydns.local. 3600   IN  SRV 10 33 8000 1.logspout.skydns.local.\n*.logspout.skydns.local. 3600   IN  SRV 10 33 8080 2.logspout.skydns.local.\n*.logspout.skydns.local. 3600   IN  SRV 10 33 8080 3.logspout.skydns.local.\n\n;; ADDITIONAL SECTION:\n1.logspout.skydns.local. 3600   IN  A   172.17.8.101\n2.logspout.skydns.local. 3600   IN  A   172.17.8.102\n3.logspout.skydns.local. 3600   IN  A   172.17.8.103\n\n;; Query time: 12 msec\n;; SERVER: 172.17.8.101#53(172.17.8.101)\n;; WHEN: Tue Oct 14 10:28:25 UTC 2014\n;; MSG SIZE  rcvd: 224\n\nroot@41ea3b47bc69:/$ dig SRV logspout.skydns.local\n\n; <<>> DiG 9.9.5-3-Ubuntu <<>> SRV logspout.skydns.local\n;; global options: +cmd\n;; Got answer:\n;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 44941\n;; flags: qr aa rd ra; QUERY: 1, ANSWER: 3, AUTHORITY: 0, ADDITIONAL: 3\n\n;; QUESTION SECTION:\n;logspout.skydns.local.     IN  SRV\n\n;; ANSWER SECTION:\nlogspout.skydns.local.  3600    IN  SRV 10 33 8000 1.logspout.skydns.local.\nlogspout.skydns.local.  3600    IN  SRV 10 33 8080 2.logspout.skydns.local.\nlogspout.skydns.local.  3600    IN  SRV 10 33 8080 3.logspout.skydns.local.\n\n;; ADDITIONAL SECTION:\n1.logspout.skydns.local. 3600   IN  A   172.17.8.101\n2.logspout.skydns.local. 3600   IN  A   172.17.8.102\n3.logspout.skydns.local. 3600   IN  A   172.17.8.103\n\n;; Query time: 13 msec\n;; SERVER: 172.17.8.101#53(172.17.8.101)\n;; WHEN: Tue Oct 14 10:28:59 UTC 2014\n;; MSG SIZE  rcvd: 222\n\n\n\u30b5\u30fc\u30d3\u30b9\u60c5\u5831\u306e\u81ea\u52d5\u767b\u9332\nCoreOS \u4e0a\u306e Docker \u30b3\u30f3\u30c6\u30ca\u306e\u30b5\u30fc\u30d3\u30b9\u60c5\u5831\u3092 registrator \u3092\u4f7f\u3063\u3066 SkyDNS2 \u306b\u81ea\u52d5\u767b\u9332\u3059\u308b \u3092\u53c2\u7167\n\n\u30e1\u30e2\n\n\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u5074\u3067 SRV \u30ec\u30b3\u30fc\u30c9\u3092\u4f7f\u3046\u3088\u3046\u306b\u3057\u306a\u3044\u3068\u3044\u3051\u306a\u3044\nSkyDNS2 \u3067\u300c\u3042\u308b\u30b5\u30fc\u30d3\u30b9\u304c\u3001\u3053\u306e\u30db\u30b9\u30c8\u90e1\u306e\u3053\u306e\u30dd\u30fc\u30c8\u3067\u8d77\u52d5\u3057\u3066\u308b\u3088\u300d\u3068\u3044\u3046\u306e\u306f\u53d6\u5f97\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u3063\u305f\u304c\u3001\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u5074\u3067\u3001 SRV \u30ec\u30b3\u30fc\u30c9\u3092\u5229\u7528\u3057\u3066\u63a5\u7d9a\u3059\u308b\u3088\u3046\u306b\u3057\u306a\u3044\u3068\u3044\u3051\u306a\u3044\u3002\n\n\u8ca0\u8377\u5206\u6563\u3067\u304d\u308b\u306e\u4fbf\u5229\n\u6700\u521d\u306f\u30011.rails.skydns.local \u3067\u30b5\u30fc\u30d3\u30b9\u60c5\u5831\u304c\u3068\u308c\u3066\u3082\u3001\u5b9f\u969b\u306b\u306f\u3001rails \u30b3\u30f3\u30c6\u30ca\u306f\u305d\u306e\u6642\u305d\u306e\u6642\u3067\u4f55\u53f0\u3042\u308b\u304b\u308f\u304b\u3089\u306a\u3044\u72b6\u614b\u3002\u756a\u53f7\u307e\u3067\u6307\u5b9a\u3057\u3066\u60c5\u5831\u3092\u53d6\u5f97\u3059\u308b\u306e\u306f\u5927\u5909\u3060\u306a\u3068\u601d\u3063\u3066\u3044\u305f\u304c\u3001*.rails.skydns.local \u3068\u3044\u3046\u611f\u3058\u3067\u30b5\u30fc\u30d3\u30b9\u60c5\u5831\u90e1\u3092\u53d6\u5f97\u3067\u304d\u3001\u3055\u3089\u306b\u8ca0\u8377\u5206\u6563\u307e\u3067\u3067\u304d\u308b\u3002\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u5074\u3067 SRV \u30ec\u30b3\u30fc\u30c9\u3092\u4f7f\u3046\u3088\u3046\u306b\u3057\u3055\u3048\u3059\u308c\u3070\u975e\u5e38\u306b\u4fbf\u5229\u3060\u3068\u601d\u3063\u305f\u3002\n\nREF\n\nskynetservices/skydns\nSKYDNS VERSION 2\nDocker container won't connect to etcd in another container on same host #42\nSkyDNS2\u306e\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u65b9\u6cd5\n\netcd API\n\nSetting a key from a file\n\n\nSome application clients use SRV lookups, a few (to their embarrassment) do not.\nRFC2782\u306e\u65e5\u672c\u8a9e\u8a33\uff08\u548c\u8a33\uff09\nSRV record lookups returning more than 4 results are not queryable by Ruby DNS resolver\n\n\n## \u6982\u8981\nCoreOS \u4e0a\u3067\u306e\u30b5\u30fc\u30d3\u30b9\u30c7\u30a3\u30b9\u30ab\u30d0\u30ea\u306b SkyDNS2 \u3092\u5229\u7528\u3059\u308b\u3068\u3044\u3046\u8a71\u3002SkyDNS2 \u306f Docker \u30b3\u30f3\u30c6\u30ca\u3068\u3057\u3066\u52d5\u304b\u3059\u3002\n\n### SkyDNS2 \u3068\u306f\nDNS \u30b5\u30fc\u30d0\u306e\u4e00\u3064\u3002\u30c7\u30fc\u30bf\u306e\u4fdd\u5b58\u5148\u306b etcd \u3092\u4f7f\u3046\u3053\u3068\u3067\u5206\u6563 DNS \u30b5\u30fc\u30d0\u3092\u5b9f\u73fe\u3057\u3066\u308b\u3002\u4f8b\u3048\u3070\u3001 5 \u53f0\u306e CoreOS \u30de\u30b7\u30f3\u304b\u3089\u306a\u308b\u30af\u30e9\u30b9\u30bf\u304c\u3042\u308b\u3068\u304d\u3001\u5404\u30de\u30b7\u30f3\u3067 SkyDNS2 \u3092\u8d77\u52d5\u3055\u305b\u3066\u304a\u304f\u3002etcd \u306b\u30c7\u30fc\u30bf\u3092\u7f6e\u3044\u3066\u3044\u308b\u306e\u3067\u3001\u3069\u306e\u30de\u30b7\u30f3\u306e SkyDNS2 \u3092\u5229\u7528\u3057\u3066\u3082\u540c\u3058\u7d50\u679c\u306b\u306a\u308b\u3002\n\n\u305d\u3057\u3066\u3001\u5f8c\u8ff0\u3059\u308b SRV \u30ec\u30b3\u30fc\u30c9\u3092\u8fd4\u3059\u3053\u3068\u3067\u5358\u306a\u308b DNS \u30b5\u30fc\u30d0\u3068\u3044\u3046\u3088\u308a\u306f\u30b5\u30fc\u30d3\u30b9\u30c7\u30a3\u30b9\u30ab\u30d0\u30ea\u30fc\u3092\u5b9f\u73fe\u3059\u308b\u305f\u3081\u306e\u30b5\u30fc\u30d3\u30b9\u3068\u3044\u3046\u4f4d\u7f6e\u3065\u3051\u306b\u306a\u3063\u3066\u3044\u308b\u3002\n\n## \u30b5\u30fc\u30d3\u30b9\u30c7\u30a3\u30b9\u30ab\u30d0\u30ea\u30fc\u306b SRV \u30ec\u30b3\u30fc\u30c9\u3092\u4f7f\u3046\nSRV \u30ec\u30b3\u30fc\u30c9\u306e\u30dd\u30a4\u30f3\u30c8\u306f\n\n* \u30dd\u30fc\u30c8\u60c5\u5831\u307e\u3067\u6301\u3063\u3066\u308b\u3053\u3068\n* \u8ca0\u8377\u5206\u6563\u3067\u304d\u308b\u3053\u3068\n\n### \u30dd\u30fc\u30c8\u60c5\u5831\u307e\u3067\u6301\u3063\u3066\u3044\u308b\u3053\u3068\nDNS \u306f\u901a\u5e38\u540d\u524d <---> IP \u306e\u89e3\u6c7a\u3092\u3059\u308b\u3060\u3051\u306a\u306e\u3067\u3001\u3042\u308b\u30b5\u30fc\u30d3\u30b9\u4f7f\u3044\u305f\u3044\u5834\u5408\u3001\u300c\u3069\u306e IP \u306e\u3069\u3053\u306e\u30dd\u30fc\u30c8\u306b\u7e4b\u3052\u3070\u826f\u3044\uff1f\u300d\u307f\u305f\u3044\u306a\u5834\u5408\u306b\u5229\u7528\u51fa\u6765\u306a\u3044\u3002\u304c `SRV` \u30ec\u30b3\u30fc\u30c9 \u3092\u4f7f\u3046\u3068\u3001IP+\u30dd\u30fc\u30c8\u60c5\u5831\u307e\u3067\u6301\u305f\u305b\u3089\u308c\u308b\u306e\u3067\u30b5\u30fc\u30d3\u30b9\u30c7\u30a3\u30b9\u30ab\u30d0\u30ea\u30fc\u306b\u5229\u7528\u51fa\u6765\u308b\u3002\n\n```\n# \u4f8b\n$ dig SRV 1.rails.skydns.local\n\n;; ANSWER SECTION:\n1.rails.skydns.local. 3600\tIN\tSRV\t10 100 8080 1.rails.skydns.local.\n\n# ANSWER SECTION \u306f\u4ee5\u4e0b\u306e\u5185\u5bb9\u304c\u66f8\u304b\u308c\u3066\u3044\u308b\n# service name, environment, TTL, priority, weight, service port, host name\n```\n\n\u3055\u3089\u306b\u3001 SRV \u30ec\u30b3\u30fc\u30c9\u306f\u8ca0\u8377\u5206\u6563\u306b\u3082\u5229\u7528\u3067\u304d\u308b\u3002\n\n### \u8ca0\u8377\u5206\u6563\u3067\u304d\u308b\u3053\u3068\nSRV \u30ec\u30b3\u30fc\u30c9\u306f\u3001\n\n* Priority\n* Weight\n\n\u3068\u3044\u3046\u60c5\u5831\u3082\u6301\u305f\u305b\u3089\u308c\u308b\u3002 Priority \u306e\u5024\u306e\u5c0f\u3055\u3044\u65b9\u304b\u3089\u512a\u5148\u7684\u306b\u901a\u4fe1\u3055\u308c\u308b\u3002 Weight \u306f\u540c\u3058\u512a\u5148\u9806\u4f4d\u306e\u30db\u30b9\u30c8\u90e1\u3067\u306e\u632f\u308a\u5206\u3051\u5177\u5408\u3092\u6c7a\u3081\u3089\u308c\u308b\u3002\n\n## SkyDNS2 \u3092\u4f7f\u3063\u305f\u30b5\u30fc\u30d3\u30b9\u30c7\u30a3\u30b9\u30ab\u30d0\u30ea\n### SkyDNS2 \u306e Docker \u30a4\u30e1\u30fc\u30b8\u4f5c\u6210\n\n```bash\n# on CoreOS machine\ncore@core-01 ~ $ git clone https://github.com/skynetservices/skydns.git\ncore@core-01 ~ $ cd skydns\n```\n\n\u540c\u68b1\u3055\u308c\u3066\u3044\u308b `Dockerfile` \u306f language stack \u3092\u4f7f\u3063\u3066\u3044\u306a\u3044\u3002\u306a\u308b\u3060\u3051 language stack \u30d9\u30fc\u30b9\u306e\u30a4\u30e1\u30fc\u30b8\u3092\u4f7f\u3044\u305f\u3044\u306e\u3067\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u7de8\u96c6\u3057\u3066\u30d3\u30eb\u30c9\u3057\u305f\u3002\n\n```\n# Dockerfile\nFROM golang:1.3.3\nMAINTAINER Miek Gieben <miek@miek.nl> (@miekg)\n\nADD . /go/src/github.com/skynetservices/skydns\nRUN go get github.com/skynetservices/skydns\n\nEXPOSE 53\nENTRYPOINT [\"skydns\"]\n```\n\n```bash\ncore@core-01 ~ $ docker build -t skydns2 .\n```\n\n### SkyDNS \u306e\u30c7\u30d5\u30a9\u30eb\u30c8\u8a2d\u5b9a\u3092 etcd \u306b\u30bb\u30c3\u30c8\n\n```bash\ncore@core-01 ~ $ curl -L -XPUT http://172.17.8.101:4001/v2/keys/skydns/config -d value='{\"nameservers\": [\"8.8.8.8:53\",\"8.8.4.4:53\"]}'\n```\n\n### SkyDNS2 \u30b3\u30f3\u30c6\u30ca\u8d77\u52d5\n\n```bash\n# SkyDNS2 \u306e UDP 53 \u30dd\u30fc\u30c8\u3092\u30db\u30b9\u30c8\u306e Private IP\u306e 53 \u30dd\u30fc\u30c8\u306b bind \ncore@core-01 ~/skydns $ docker run \\\n  -d \\\n  --name skydns2 \\\n  -p 172.17.8.101:53:53/udp \\\n  -e ETCD_MACHINES='172.17.8.101:4001,172.17.8.102:4001,172.17.8.103:4001' \\\n  skydns2:latest \\\n  -addr=0.0.0.0:53\n\ncore@core-01 ~ $ docker logs skydns2\n[skydns] Oct 14 03:26:33.702 INFO      | ready for queries on skydns.local. for tcp://0.0.0.0:53 [rcache 0]\n[skydns] Oct 14 03:26:33.702 INFO      | ready for queries on skydns.local. for udp://0.0.0.0:53 [rcache 0]\n[skydns] Oct 14 03:27:51.679 INFO      | no nameservers defined or name too short, can not forward\n[skydns] Oct 14 03:27:51.679 INFO      | no nameservers defined or name too short, can not forward\n```\n\n\u3053\u308c\u3067 Core-01 \u306e Private IP (172.17.8.101) \u3092 DNS nameserver \u3068\u3057\u3066\u5229\u7528\u51fa\u6765\u308b\u306b\u306a\u308b\n\n### etcd \u306b\u30b5\u30fc\u30d3\u30b9\u60c5\u5831\u3092\u30bb\u30c3\u30c8\nCore-01 \u4e0a\u306b\u8d77\u52d5\u3057\u3066\u3044\u308b logspout \u3092 `logspout.1` \u306e\u3088\u3046\u306b\u30013 \u53f0\u767b\u9332\u3059\u308b\u3053\u3068\u306b\u3059\u308b\n\n`logspout.1.json`\n\n```json\n{\n  \"host\":\"172.17.8.101\",\n  \"port\":8080\n}\n```\n\n`logspout.2.json`\n\n```json\n{\n  \"host\":\"172.17.8.102\",\n  \"port\":8080\n}\n```\n\n`logspout.3.json`\n\n```json\n{\n  \"host\":\"172.17.8.103\",\n  \"port\":8080\n}\n```\n\netcd \u306b\u30bb\u30c3\u30c8\n\n```bash\ncore@core-01 ~ $ curl -L -XPUT http://172.17.8.101:4001/v2/keys/skydns/local/skydns/logspout/1 --data-urlencode value@logspout.1.json\n{\"action\":\"set\",\"node\":{\"key\":\"/skydns/local/skydns/logspout/1\",\"value\":\"{\\n  \\\"host\\\":\\\"172.17.8.101\\\",\\n  \\\"port\\\":8000\\n}\\n\",\"modifiedIndex\":9000,\"createdIndex\":9000},\"prevNode\":{\"key\":\"/skydns/local/skydns/logspout/1\",\"value\":\"\",\"modifiedIndex\":8995,\"createdIndex\":8995}}\n\ncore@core-01 ~ $ curl -L -XPUT http://172.17.8.101:4001/v2/keys/skydns/local/skydns/logspout/2 --data-urlencode value@logspout.2.json\n{\"action\":\"set\",\"node\":{\"key\":\"/skydns/local/skydns/logspout/2\",\"value\":\"{\\n  \\\"host\\\":\\\"172.17.8.102\\\",\\n  \\\"port\\\":8000\\n}\\n\",\"modifiedIndex\":8887,\"createdIndex\":8887}}\n\ncore@core-01 ~ $ curl -L -XPUT http://172.17.8.101:4001/v2/keys/skydns/local/skydns/logspout/3 --data-urlencode value@logspout.3.json\n{\"action\":\"set\",\"node\":{\"key\":\"/skydns/local/skydns/logspout/3\",\"value\":\"{\\n  \\\"host\\\":\\\"172.17.8.103\\\",\\n  \\\"port\\\":8000\\n}\\n\",\"modifiedIndex\":9022,\"createdIndex\":9022}}\n```\n\n### CoreOS \u30de\u30b7\u30f3\u4e0a\u306e\u30d7\u30e9\u30a4\u30de\u30ea DNS \u30b5\u30fc\u30d0\u3092 SkyDNS2 \u306b\u5909\u66f4\u3059\u308b\nSkyDNS2 \u3067\u306e\u8a2d\u5b9a\u306e\u3068\u304a\u308a\u3001\u30c9\u30e1\u30a4\u30f3\u306e\u6a29\u5a01\u304c\u7121\u3044\u554f\u3044\u5408\u308f\u305b\u304c\u5c4a\u3044\u305f\u6642\u306f 8.8.8.8:53 \u3068 8.8.4.4:53 \u306b\u8ee2\u9001\u3059\u308b\u306e\u3067\u3001SkyDNS2 \u30d7\u30e9\u30a4\u30de\u30ea DNS \u30b5\u30fc\u30d0\u3068\u3057\u3066\u6271\u3048\u308b\u3002\n\n```\ncore@core-01 ~ $ cat /etc/resolv.conf\n# This file is managed by systemd-resolved(8). Do not edit.\n#\n# Third party programs must not access this file directly, but\n# only through the symlink at /etc/resolv.conf. To manage\n# resolv.conf(5) in a different way, replace the symlink by a\n# static file or a different symlink.\n\n#nameserver 10.0.2.3\nnameserver 172.17.8.101 # -> \u66f8\u304d\u63db\u3048\n```\n\n\uff08\u76f4\u306b\u66f8\u304d\u63db\u3048\u308b\u306e\u306f\u826f\u304f\u306f\u306a\u3044\uff09\n\n### CoreOS \u30de\u30b7\u30f3\uff08\u30b3\u30f3\u30c6\u30ca\u30db\u30b9\u30c8\uff09\u304b\u3089 ping \u3057\u3066\u307f\u308b\nping \u3067\u304d\u308b\u304b\u78ba\u8a8d\u3057\u3066\u307f\u308b\n\uff08CoreOS \u306b\u306f\u3001dig \u304c\u5165\u3063\u3066\u306a\u3044\u3002\uff09\n\n```bash\ncore@core-01 ~ $ ping 1.logspout.skydns.local\nPING 1.logspout.skydns.local (172.17.8.101) 56(84) bytes of data.\n64 bytes from 172.17.8.101: icmp_seq=1 ttl=64 time=0.113 ms\n64 bytes from 172.17.8.101: icmp_seq=2 ttl=64 time=0.031 ms\n64 bytes from 172.17.8.101: icmp_seq=3 ttl=64 time=0.039 ms\n64 bytes from 172.17.8.101: icmp_seq=4 ttl=64 time=0.032 ms\n64 bytes from 172.17.8.101: icmp_seq=5 ttl=64 time=0.048 ms\n```\n\n```bash\n# Core-02 \u306e logspout \u306b\u632f\u308a\u5206\u3051\u3055\u308c\u305f\ncore@core-01 ~ $ ping logspout.skydns.local\nPING logspout.skydns.local (172.17.8.102) 56(84) bytes of data.\n64 bytes from 172.17.8.102: icmp_seq=1 ttl=64 time=0.369 ms\n64 bytes from 172.17.8.102: icmp_seq=2 ttl=64 time=0.437 ms\n64 bytes from 172.17.8.102: icmp_seq=3 ttl=64 time=0.409 ms\n64 bytes from 172.17.8.102: icmp_seq=4 ttl=64 time=0.429 ms\n\n# \u4eca\u5f8c\u306f Core-03 \u306b\u632f\u308a\u5206\u3051\u3055\u308c\u305f\u3002\n# \u63a5\u7d9a\u3059\u308b\u3054\u3068\u306b\u63a5\u7d9a\u5148\u30db\u30b9\u30c8\u304c\u5909\u308f\u308b = \u8ca0\u8377\u5206\u6563\u3055\u308c\u3066\u308b\u3053\u3068\u304c\u308f\u304b\u308b\ncore@core-01 ~ $ ping logspout.skydns.local\nPING logspout.skydns.local (172.17.8.103) 56(84) bytes of data.\n64 bytes from 172.17.8.103: icmp_seq=1 ttl=64 time=0.290 ms\n64 bytes from 172.17.8.103: icmp_seq=2 ttl=64 time=0.417 ms\n64 bytes from 172.17.8.103: icmp_seq=3 ttl=64 time=0.477 ms\n```\n\n### ruby \u30b3\u30f3\u30c6\u30ca\u304b\u3089 SRV \u30ec\u30b3\u30fc\u30c9\u3092\u53d6\u5f97\u3057\u3066\u307f\u308b\n\n```ruby\n#!/usr/local/bin/ruby\n# get_srv.rb\n\nrequire 'resolv'\nrequire 'pp'\n\nresolver = Resolv::DNS.new(:nameserver => ['172.17.8.101'], :search => ['skydns.local'], :ndots => 1)\nhosts = resolver.getresources('logspout.skydns.local', Resolv::DNS::Resource::IN::SRV)\npp hosts\nputs \"\"\npp hosts.map{|h| (h.target.to_s + \":\" + h.port.to_s) }\n```\n\n```bash\n$ ruby get_srv.rb\n```\n\n```ruby\n[#<Resolv::DNS::Resource::IN::SRV:0x007f47882f6620\n  @port=8000,\n  @priority=10,\n  @target=#<Resolv::DNS::Name: 1.logspout.skydns.local.>,\n  @ttl=3600,\n  @weight=33>,\n #<Resolv::DNS::Resource::IN::SRV:0x007f47882f5518\n  @port=8080,\n  @priority=10,\n  @target=#<Resolv::DNS::Name: 2.logspout.skydns.local.>,\n  @ttl=3600,\n  @weight=33>,\n #<Resolv::DNS::Resource::IN::SRV:0x007f47882f45c8\n  @port=8080,\n  @priority=10,\n  @target=#<Resolv::DNS::Name: 3.logspout.skydns.local.>,\n  @ttl=3600,\n  @weight=33>]\n\n[\"1.logspout.skydns.local:8000\",\n \"2.logspout.skydns.local:8080\",\n \"3.logspout.skydns.local:8080\"]\n```\n\n### ubuntu:14.04 \u30b3\u30f3\u30c6\u30ca\u304b\u3089 ping \u3057\u3066\u307f\u308b\n\n```bash\n# on CoreOS\ncore@core-01 ~ $ docker run -it --rm --dns=172.17.8.101 ubuntu:14.04 /bin/bash\n```\n\n```bash\n# \u30b3\u30f3\u30c6\u30ca\u5185\u304b\u3089 ping \u3057\u3066\u307f\u308b\nroot@91fcca071b27:/$ ping 1.logspout.skydns.local\nPING 1.logspout.skydns.local (172.17.8.101) 56(84) bytes of data.\n64 bytes from 172.17.8.101: icmp_seq=1 ttl=64 time=0.029 ms\n64 bytes from 172.17.8.101: icmp_seq=2 ttl=64 time=0.038 ms\n64 bytes from 172.17.8.101: icmp_seq=3 ttl=64 time=0.063 ms\n64 bytes from 172.17.8.101: icmp_seq=4 ttl=64 time=0.053 ms\n```\n\n### ubuntu:14.04 \u30b3\u30f3\u30c6\u30ca\u304b\u3089 dig \u3057\u3066\u307f\u308b\n\nimage ubuntu:14.04 \u3067\u306f dig \u304c\u5165\u3063\u3066\u306a\u3044\u306e\u3067\u5165\u308c\u308b\n\n```bash\n# in ubuntu:14.04, install dig\nroot@952708774c41:/$ sudo apt-get update && sudp apt-get install dnsutils\n```\n\n`skydns.local` \u306e\u30c9\u30e1\u30a4\u30f3\u60c5\u5831\u53d6\u5f97\n\n```bash\nroot@41ea3b47bc69:/$ dig skydns.local\n\n; <<>> DiG 9.9.5-3-Ubuntu <<>> skydns.local\n;; global options: +cmd\n;; Got answer:\n;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 29922\n;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 0\n\n;; QUESTION SECTION:\n;skydns.local.\t\t\tIN\tA\n\n;; ANSWER SECTION:\nskydns.local.\t\t3600\tIN\tA\t172.17.8.101\n\n;; Query time: 17 msec\n;; SERVER: 172.17.8.101#53(172.17.8.101)\n;; WHEN: Tue Oct 14 09:44:11 UTC 2014\n;; MSG SIZE  rcvd: 46\n```\n\n`1.logspout.skydns.local` \u306e SRV \u60c5\u5831\u3092\u53d6\u5f97\u3002\u5148\u307b\u3069 etcd \u306b\u30bb\u30c3\u30c8\u3057\u305f `/skydns/local/logspout/1` \u306e\u60c5\u5831\u304c\u8fd4\u3063\u3066\u304f\u308b\u3002\n\n\n```bash\nroot@41ea3b47bc69:/# dig SRV 1.logspout.skydns.local\n\n; <<>> DiG 9.9.5-3-Ubuntu <<>> SRV 1.logspout.skydns.local\n;; global options: +cmd\n;; Got answer:\n;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 51547\n;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1\n\n;; QUESTION SECTION:\n;1.logspout.skydns.local.\tIN\tSRV\n\n;; ANSWER SECTION:\n1.logspout.skydns.local. 3600\tIN\tSRV\t10 100 8000 1.logspout.skydns.local.\n\n;; ADDITIONAL SECTION:\n1.logspout.skydns.local. 3600\tIN\tA\t172.17.8.101\n\n;; Query time: 13 msec\n;; SERVER: 172.17.8.101#53(172.17.8.101)\n;; WHEN: Tue Oct 14 10:33:28 UTC 2014\n;; MSG SIZE  rcvd: 100\n```\n\n\nwildcard \u3082\u5229\u7528\u3067\u304d\u308b\u3002\n`*.logspout.skydns.local` \u306e SRV \u60c5\u5831\u3092\u53d6\u5f97\u3002\u5148\u307b\u3069 etcd \u306b\u30bb\u30c3\u30c8\u3057\u305f `/skydns/local/logspout/*` \u306e\u60c5\u5831\u304c\u8fd4\u3063\u3066\u304f\u308b\u3002\n\n```bash\nroot@41ea3b47bc69:/$ dig SRV *.logspout.skydns.local\n\n; <<>> DiG 9.9.5-3-Ubuntu <<>> SRV *.logspout.skydns.local\n;; global options: +cmd\n;; Got answer:\n;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 2579\n;; flags: qr aa rd ra; QUERY: 1, ANSWER: 3, AUTHORITY: 0, ADDITIONAL: 3\n\n;; QUESTION SECTION:\n;*.logspout.skydns.local.\tIN\tSRV\n\n;; ANSWER SECTION:\n*.logspout.skydns.local. 3600\tIN\tSRV\t10 33 8000 1.logspout.skydns.local.\n*.logspout.skydns.local. 3600\tIN\tSRV\t10 33 8080 2.logspout.skydns.local.\n*.logspout.skydns.local. 3600\tIN\tSRV\t10 33 8080 3.logspout.skydns.local.\n\n;; ADDITIONAL SECTION:\n1.logspout.skydns.local. 3600\tIN\tA\t172.17.8.101\n2.logspout.skydns.local. 3600\tIN\tA\t172.17.8.102\n3.logspout.skydns.local. 3600\tIN\tA\t172.17.8.103\n\n;; Query time: 12 msec\n;; SERVER: 172.17.8.101#53(172.17.8.101)\n;; WHEN: Tue Oct 14 10:28:25 UTC 2014\n;; MSG SIZE  rcvd: 224\n```\n\n```bash\nroot@41ea3b47bc69:/$ dig SRV logspout.skydns.local\n\n; <<>> DiG 9.9.5-3-Ubuntu <<>> SRV logspout.skydns.local\n;; global options: +cmd\n;; Got answer:\n;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 44941\n;; flags: qr aa rd ra; QUERY: 1, ANSWER: 3, AUTHORITY: 0, ADDITIONAL: 3\n\n;; QUESTION SECTION:\n;logspout.skydns.local.\t\tIN\tSRV\n\n;; ANSWER SECTION:\nlogspout.skydns.local.\t3600\tIN\tSRV\t10 33 8000 1.logspout.skydns.local.\nlogspout.skydns.local.\t3600\tIN\tSRV\t10 33 8080 2.logspout.skydns.local.\nlogspout.skydns.local.\t3600\tIN\tSRV\t10 33 8080 3.logspout.skydns.local.\n\n;; ADDITIONAL SECTION:\n1.logspout.skydns.local. 3600\tIN\tA\t172.17.8.101\n2.logspout.skydns.local. 3600\tIN\tA\t172.17.8.102\n3.logspout.skydns.local. 3600\tIN\tA\t172.17.8.103\n\n;; Query time: 13 msec\n;; SERVER: 172.17.8.101#53(172.17.8.101)\n;; WHEN: Tue Oct 14 10:28:59 UTC 2014\n;; MSG SIZE  rcvd: 222\n```\n\n## \u30b5\u30fc\u30d3\u30b9\u60c5\u5831\u306e\u81ea\u52d5\u767b\u9332\n[CoreOS \u4e0a\u306e Docker \u30b3\u30f3\u30c6\u30ca\u306e\u30b5\u30fc\u30d3\u30b9\u60c5\u5831\u3092 registrator \u3092\u4f7f\u3063\u3066 SkyDNS2 \u306b\u81ea\u52d5\u767b\u9332\u3059\u308b](http://qiita.com/spesnova/items/1d384f80a76d8fa5c23f) \u3092\u53c2\u7167\n\n\n## \u30e1\u30e2\n### \u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u5074\u3067 SRV \u30ec\u30b3\u30fc\u30c9\u3092\u4f7f\u3046\u3088\u3046\u306b\u3057\u306a\u3044\u3068\u3044\u3051\u306a\u3044\nSkyDNS2 \u3067\u300c\u3042\u308b\u30b5\u30fc\u30d3\u30b9\u304c\u3001\u3053\u306e\u30db\u30b9\u30c8\u90e1\u306e\u3053\u306e\u30dd\u30fc\u30c8\u3067\u8d77\u52d5\u3057\u3066\u308b\u3088\u300d\u3068\u3044\u3046\u306e\u306f\u53d6\u5f97\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u3063\u305f\u304c\u3001\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u5074\u3067\u3001 SRV \u30ec\u30b3\u30fc\u30c9\u3092\u5229\u7528\u3057\u3066\u63a5\u7d9a\u3059\u308b\u3088\u3046\u306b\u3057\u306a\u3044\u3068\u3044\u3051\u306a\u3044\u3002\n\n### \u8ca0\u8377\u5206\u6563\u3067\u304d\u308b\u306e\u4fbf\u5229\n\u6700\u521d\u306f\u3001`1.rails.skydns.local` \u3067\u30b5\u30fc\u30d3\u30b9\u60c5\u5831\u304c\u3068\u308c\u3066\u3082\u3001\u5b9f\u969b\u306b\u306f\u3001rails \u30b3\u30f3\u30c6\u30ca\u306f\u305d\u306e\u6642\u305d\u306e\u6642\u3067\u4f55\u53f0\u3042\u308b\u304b\u308f\u304b\u3089\u306a\u3044\u72b6\u614b\u3002\u756a\u53f7\u307e\u3067\u6307\u5b9a\u3057\u3066\u60c5\u5831\u3092\u53d6\u5f97\u3059\u308b\u306e\u306f\u5927\u5909\u3060\u306a\u3068\u601d\u3063\u3066\u3044\u305f\u304c\u3001`*.rails.skydns.local` \u3068\u3044\u3046\u611f\u3058\u3067\u30b5\u30fc\u30d3\u30b9\u60c5\u5831\u90e1\u3092\u53d6\u5f97\u3067\u304d\u3001\u3055\u3089\u306b\u8ca0\u8377\u5206\u6563\u307e\u3067\u3067\u304d\u308b\u3002\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u5074\u3067 SRV \u30ec\u30b3\u30fc\u30c9\u3092\u4f7f\u3046\u3088\u3046\u306b\u3057\u3055\u3048\u3059\u308c\u3070\u975e\u5e38\u306b\u4fbf\u5229\u3060\u3068\u601d\u3063\u305f\u3002\n\n## REF\n\n* [skynetservices/skydns](https://github.com/skynetservices/skydns)\n* [SKYDNS VERSION 2](http://miek.nl/posts/2014/Jun/08/announcing%20SkyDNS%20version%202/)\n* [Docker container won't connect to etcd in another container on same host #42](https://github.com/skynetservices/skydns/issues/42)\n* [SkyDNS2\u306e\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u65b9\u6cd5](http://qiita.com/zembutsu/items/626c55cc702d54f7fa65)\n* [etcd API](https://coreos.com/docs/distributed-configuration/etcd-api/)\n * Setting a key from a file\n* [Some application clients use SRV lookups, a few (to their embarrassment) do not.](http://homepage.ntlworld.com/jonathan.deboynepollard/FGA/dns-srv-record-use-by-clients.html)\n* [RFC2782\u306e\u65e5\u672c\u8a9e\u8a33\uff08\u548c\u8a33\uff09](http://www5d.biglobe.ne.jp/~stssk/rfc/rfc2782j.html)\n* [SRV record lookups returning more than 4 results are not queryable by Ruby DNS resolver](https://github.com/skynetservices/skydns/issues/69)\n", "tags": ["SkyDNS", "docker", "CoreOS", "etcd"]}