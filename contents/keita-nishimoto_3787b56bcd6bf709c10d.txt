{"context": "\n\n\u6982\u8981\nAmazon API Gateway \u3068AWS Lambda \u3092\u5229\u7528\u3057\u3066Custom Authorizer\u3092\u5229\u7528\u3057\u307e\u3059\u3002\n\nAPI Gateway\u3092\u5229\u7528\u3059\u308b\u70ba\u306bIAM\u30e6\u30fc\u30b6\u30fc\u3092\u4f5c\u6210\u3059\u308b\nAWS \u30eb\u30fc\u30c8\u30a2\u30ab\u30a6\u30f3\u30c8\u306b\u3088\u308b\u4f5c\u696d\u306f\u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u4e0a\u3088\u308d\u3057\u304f\u306a\u3044\u306e\u3067\u3001\u5c02\u7528\u306eIAM\u30e6\u30fc\u30b6\u30fc\u3092\u4f5c\u6210\u3057\u5fc5\u8981\u306a\u6a29\u9650\u306e\u307f\u3092\u4e0e\u3048\u307e\u3059\u3002\nIdentity and Access Management\u3088\u308a\u300c\u500b\u3005\u306e IAM \u30e6\u30fc\u30b6\u30fc\u306e\u4f5c\u6210\u300d\u3092\u9078\u629e\u3001\u4ee5\u4e0b\u306e\u6a29\u9650\u3092\u4ed8\u4e0e\u3057\u307e\u3059\u3002\n\nAmazonAPIGatewayAdministrator\nAWSLambdaFullAccess\nAWSLambdaDynamoDBExecutionRole\nAmazonDynamoDBFullAccesswithDataPipeline\n\n\u2193\u3053\u3093\u306a\u611f\u3058\u3001\u30b0\u30eb\u30fc\u30d7\u540d\u7b49\u306f\u5206\u304b\u308a\u3084\u3059\u3044\u540d\u524d\u3067\u3042\u308c\u3070\u4f55\u3067\u3082\u826f\u3044\u3067\u3059\u3002\n\u203b\u300c\u30d7\u30ed\u30b0\u30e9\u30e0\u306b\u3088\u308b\u30a2\u30af\u30bb\u30b9\u300d\u3068\u300cAWS \u30de\u30cd\u30b8\u30e1\u30f3\u30c8\u30b3\u30f3\u30bd\u30fc\u30eb\u3078\u306e\u30a2\u30af\u30bb\u30b9\u300d\u306b\u306f\u4e21\u65b9\u30c1\u30a7\u30c3\u30af\u3092\u3064\u3051\u3066\u304a\u304f\u306e\u3092\u5fd8\u308c\u306a\u3044\u3088\u3046\u306b\u3057\u307e\u3057\u3087\u3046\u3002\n\n\n\u5fc5\u8981\u306aLambda\u95a2\u6570\u3092\u5b9a\u7fa9\u3059\u308b\n\u4eca\u56de\u306f\u30b5\u30f3\u30d7\u30eb\u3068\u3057\u3066\u4ee5\u4e0b\u306eAPI\u3092\u7528\u610f\u3057\u307e\u3059\u3002\n\n\n/users/{userId} - GET # \u30e6\u30fc\u30b6\u30fc\u30921\u4ef6\u53d6\u5f97\u3059\u308b\n\n\u3053\u308c\u3089\u306e\u95a2\u6570\u304b\u3089\u30a2\u30af\u30bb\u30b9\u3059\u308b\u70ba\u306e\u30c6\u30fc\u30d6\u30eb\u30922\u3064\u7528\u610f\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\u305d\u306e\u4ed6\u306e\u9805\u76ee\u306f\u30b5\u30f3\u30d7\u30eb\u306a\u306e\u3067\u9069\u5f53\u3067OK\u3067\u3059\u3002\n\nusers\n\n\nid (String) \u203bprimary\u3001UUID\u3092\u751f\u6210\u3057\u3066\u5165\u308c\u308b\nemail\uff08String\uff09\n\n\naccess_tokens\n\n\naccess_token (String) \u203bprimary\u3001UUID\u3092\u751f\u6210\u3057\u3066\u5165\u308c\u308b\n\n\n\n\u203b\u4f59\u8ac7\u3067\u3059\u304c\u3001\u547d\u540d\u30eb\u30fc\u30eb\u304a\u3088\u3073\u30c7\u30fc\u30bf\u578b\u3092\u898b\u308b\u3068\u3001\u5229\u7528\u51fa\u6765\u308b\u6587\u5b57\u5217\u3084\u4e88\u7d04\u8a9e\u7b49\u306e\u78ba\u8a8d\u304c\u51fa\u6765\u307e\u3059\u3002\n\u4e00\u5fdc\u3001\u4e00\u90e8\u8a18\u53f7\u304c\u4f7f\u3048\u307e\u3059\u304cAWS\u306e\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u4f8b\u3060\u3068\u30d1\u30b9\u30ab\u30eb\u30b1\u30fc\u30b9\u306e\u8907\u6570\u5f62\u3067\u547d\u540d\u3057\u3066\u3044\u308b\u4f8b\u304c\u591a\u3044\u306e\u3067\u3001\u898f\u7d04\u7b49\u306f\u305d\u308c\u306b\u5408\u308f\u305b\u308b\u306e\u304c\u826f\u3044\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u3002\n\uff08\u4eca\u56de\u306e\u30b5\u30f3\u30d7\u30eb\u3067\u306faccess_tokens\u3068\u304b\u3057\u3061\u3083\u3044\u307e\u3057\u305f\u304c\u30fb\u30fb\u30fb\uff09\n\n/users/{userId}GET\n'use strict';\n\nconst AWS = require('aws-sdk');\nconst dynamo = new AWS.DynamoDB.DocumentClient();\n\nexports.handler = (event, context, callback) => {\n\n  const params = {\n    TableName: 'users',\n    FilterExpression : 'id = :val',\n    ExpressionAttributeValues : {':val': event['userId']}\n  };\n\n  dynamo.scan(params, (error, data) => {\n    if (error) {\n      callback(\n        Error('Fail. err:' + error)\n      );\n    } else {\n      callback(null, data);\n    }\n  });\n};\n\n\n\u203b\u30b5\u30f3\u30d7\u30eb\u306a\u306e\u3067\u30b3\u30fc\u30c9\u304c\u96d1\u306a\u306e\u306f\u3054\u4e86\u627f\u4e0b\u3055\u3044\u3002\n\nAPI Gateway\u304b\u3089Lambda\u95a2\u6570\u3092\u547c\u3073\u51fa\u3059\u8a2d\u5b9a\u3092\u884c\u3046\n\u8a73\u7d30\u306a\u624b\u9806\u306f\u7701\u7565\u3057\u307e\u3059\u3002\n\u57fa\u672c\u7684\u306bLambda \u95a2\u6570\u3092\u516c\u958b\u3059\u308b\u305f\u3081\u306e API \u3092\u4f5c\u6210\u3059\u308b \u3092\u53c2\u8003\u306b\u3057\u3066\u9802\u3051\u308c\u3070\u305d\u308c\u307b\u3069\u96e3\u3057\u304f\u306f\u3042\u308a\u307e\u305b\u3093\u3067\u3057\u305f\u3002\nLambda \u30d7\u30ed\u30ad\u30b7\u3068\u3057\u3066 API \u3092\u69cb\u7bc9\u3059\u308b\u3092\u898b\u306a\u304c\u3089\u4e00\u901a\u308a\u306e\u57fa\u672c\u64cd\u4f5c\u3092\u3084\u3063\u3066\u304a\u304f\u4e8b\u3082\u30aa\u30b9\u30b9\u30e1\u3057\u307e\u3059\u3002\n\u6700\u7d42\u7684\u306bAPI Gateway\u306e\u7ba1\u7406\u753b\u9762\u3092\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u72b6\u614b\u306b\u3057\u307e\u3059\u3002\n\n\nCustom Authorizer\u306e\u6982\u8981\n\u4e0b\u8a18\u306e\u56f3\u306f\u516c\u5f0f\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u306b\u8a18\u8f09\u3055\u308c\u3066\u3044\u308b\u7269\u3067\u3059\u3002\n\n\u51e6\u7406\u306e\u6d41\u308c\u306f\u4e0b\u8a18\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\n\n\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u306fAPI\u306b\u30ea\u30af\u30a8\u30b9\u30c8\u3092\u884c\u3044\u307e\u3059\u3002\uff08\u3053\u306e\u6642\u306bAuthorization\u30d8\u30c3\u30c0\u306b\u30a2\u30af\u30bb\u30b9\u30c8\u30fc\u30af\u30f3\u7b49\u306e\u30c8\u30fc\u30af\u30f3\u3092\u6307\u5b9a\u3057\u307e\u3059\uff09\nAPI Gateway\u306fLambda Auth Function\u3092\u547c\u3073\u51fa\u3057\u307e\u3059\u3002\nLambda Auth Function\u306fAPI Gateway \u306bIAM\u30dd\u30ea\u30b7\u30fc\u3092\u8fd4\u3057\u307e\u3059\u3002\nIAM\u30dd\u30ea\u30b7\u30fc\u306b\u5f93\u3063\u3066\u3001API Gateway\u304c\u8a8d\u53ef\u3092\u5b9f\u65bd\u3057\u307e\u3059\u3002\n\n\u3061\u306a\u307f\u306b\u4e00\u5ea6\u8a8d\u53ef\u51e6\u7406\u3092\u884c\u3063\u305fIAM\u30dd\u30ea\u30b7\u30fc\u306f\u30ad\u30e3\u30c3\u30b7\u30e5\u3055\u308c\u307e\u3059\u3002\uff08\u73fe\u5728\u306e\u3068\u3053\u308d\u30c7\u30d5\u30a9\u30eb\u30c8\u30675\u5206\u3001\u6700\u59271\u6642\u9593\u307e\u3067\u306e\u9593\u3067\u30ad\u30e3\u30c3\u30b7\u30e5\u306e\u8a2d\u5b9a\u3092\u884c\u3048\u308b\uff09\n\u30ad\u30e3\u30c3\u30b7\u30e5\u306e\u8a2d\u5b9a\u306f\u7121\u52b9\u306b\u3059\u308b\u4e8b\u3082\u53ef\u80fd\u3067\u3059\u3002\n\nCustom Authorizer\u7528\u306eLambda \u95a2\u6570\u3092\u5b9a\u7fa9\u3059\u308b\n\u4ee5\u4e0b\u306e\u30b3\u30fc\u30c9\u3092\u5b9a\u7fa9\u3057\u307e\u3059\u3002\n\u4eca\u56de\u306fAuthorization\u306e\u30a2\u30af\u30bb\u30b9\u30c8\u30fc\u30af\u30f3\u3092access_tokens\u30c6\u30fc\u30d6\u30eb\u304b\u3089\u53d6\u5f97\u3057\u3001\u53d6\u5f97\u51fa\u6765\u305f\u3089\u3001\u5bfe\u8c61\u306eAPI\u3092\u5229\u7528\u3059\u308b\u6a29\u9650\u3092\u4e0e\u3048\u307e\u3059\u3002\n\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306bAuthorization\u30d8\u30c3\u30c0\u306b\u30a2\u30af\u30bb\u30b9\u30c8\u30fc\u30af\u30f3\u3092\u8a2d\u5b9a\u3057\u3066\u30ea\u30af\u30a8\u30b9\u30c8\u3092\u884c\u3044\u307e\u3059\u3002\n\n\u30ea\u30af\u30a8\u30b9\u30c8\u4f8b\ncurl -kv \\\n-H \"Authorization: 6d8c4c95-d884-4735-858d-c1fd3b8d870d\" \\\nhttps://my-api-id.execute-api.region-id.amazonaws.com/stage/users/{userId}\n\n\n\u3061\u306a\u307f\u306bAPI Gateway\u306eURL\u306e\u69cb\u6210\u3067\u3059\u304c\u3001\u4e0b\u8a18\u306e\u3088\u3046\u306a\u5f62\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002\nhttps://my-api-id.execute-api.region-id.amazonaws.com/stage\n\nmy-api-id\nAPI\u306b\u5272\u308a\u5f53\u3066\u3089\u308c\u308b\u8b58\u5225\u5b50\u3067\u3059\u3002\nAPI Gateway\u3067API\u3092\u4f5c\u6210\u3057\u305f\u30bf\u30a4\u30df\u30f3\u30b0\uff08\u3082\u3057\u304f\u306f\u30c7\u30d7\u30ed\u30a4\u3057\u305f\u30bf\u30a4\u30df\u30f3\u30b0\u3060\u3063\u305f\u304b\u3082\uff09\u3067\u4f5c\u6210\u3055\u308c\u307e\u3059\u3002\n\nregion-id\n\u5bfe\u8c61\u306eAPI\u304c\u5b58\u5728\u3059\u308b\u30ea\u30fc\u30b8\u30e7\u30f3\u3092\u8868\u3057\u307e\u3059\u3002\n\nstage\ndevelop,staging\u3001production\u7b49\u306e\u74b0\u5883\u3092\u8868\u3059\u5024\u3067\u3059\u3002\nstage\u540d\u306b\u95a2\u3057\u3066\u306f\u5229\u7528\u8005\u304c\u4efb\u610f\u3067\u4ed8\u3051\u308b\u4e8b\u304c\u51fa\u6765\u307e\u3059\u3002\n\u30c7\u30d7\u30ed\u30a4\u306e\u969b\u306f\u5229\u7528\u8005\u304c\u3069\u3053\u306estage\u306b\u5bfe\u3057\u3066\u30c7\u30d7\u30ed\u30a4\u3092\u884c\u3046\u304b\u3092\u9078\u629e\u3057\u307e\u3059\u3002\n\u305d\u308c\u305e\u308c\u306e\u30d1\u30e9\u30e1\u30fc\u30bf\u304c\u4e0b\u8a18\u306e\u3088\u3046\u306a\u5024\u3060\u3063\u305f\u5834\u5408\u306eURL\u306f\n\nmy-api-id\n\n\n77abcdef84\n\n\nregion-id\n\n\nus-east-1\n\n\nstage\n\n\ntest\n\n\nuserId\n\n\nabcd1234\n\n\n\nhttps://77abcdef84.execute-api.us-east-1.amazonaws.com/test/users/abcd1234\n\u3068\u306a\u308a\u307e\u3059\u3002\n\ncustomAuthorize\n'use strict';\n\nconst AWS = require('aws-sdk');\nconst dynamo = new AWS.DynamoDB.DocumentClient();\n\nexports.handler = (event, context, callback) => {\n\n  const accessToken = event.authorizationToken;\n\n  const params = {\n    TableName: 'access_tokens',\n    FilterExpression : 'access_token = :val',\n    ExpressionAttributeValues : {':val': accessToken}\n  };\n\n  dynamo.scan(params, (error, data) => {\n\n    if (accessToken === 'unauthorized') {\n      callback(\n        new Error('Unauthorized')\n      )\n    }\n\n    if (error) {\n      callback(\n        new Error('Fail. err:' + error)\n      );\n    } else {\n      if (data['Items'].length === 0) {\n        callback(\n          null,\n          generatePolicy('user', 'Deny', event.methodArn)\n        );\n      } else {\n        callback(\n          null,\n          generatePolicy('user', 'Allow', event.methodArn)\n        );\n      }\n    }\n  });\n};\n\n/**\n * \u30dd\u30ea\u30b7\u30fc\u3092\u751f\u6210\u3059\u308b\n *\n * @param principalId\n * @param effect\n * @param resource\n * @returns {{}}\n */\nconst generatePolicy = function(principalId, effect, resource) {\n  const authResponse = {};\n  authResponse.principalId = principalId;\n  if (effect && resource) {\n    const policyDocument = {};\n    policyDocument.Version = '2012-10-17'; // default version\n    policyDocument.Statement = [];\n    const statementOne = {};\n    statementOne.Action = 'execute-api:Invoke'; // default action\n    statementOne.Effect = effect;\n    statementOne.Resource = resource;\n    policyDocument.Statement[0] = statementOne;\n    authResponse.policyDocument = policyDocument;\n  }\n  return authResponse;\n};\n\n\n\ncustomAuthorize\u306e\u89e3\u8aac\n\nevent.authorizationToken\n\u3053\u308c\u3067Authorization\u30d8\u30c3\u30c0\u306e\u4e2d\u8eab\u3092\u53d6\u5f97\u53ef\u80fd\u3067\u3059\u3002\n\ngeneratePolicy\nAWS\u306eIAM\u30dd\u30ea\u30b7\u30fc\u3092\u4f5c\u6210\u3059\u308b\u30e1\u30bd\u30c3\u30c9\u3067\u3059\u3002\nAPI Gateway\u306f\u3053\u306eIAM\u30dd\u30ea\u30b7\u30fc\u3092\u5143\u306b\u8a8d\u53ef\u3092\u5b9f\u884c\u3059\u308b\u306e\u3067\u3053\u3053\u3067\u3069\u306e\u3088\u3046\u306a\u5024\u3092\u8fd4\u5374\u3059\u308b\u304b\u3067\u3001\u30ea\u30af\u30a8\u30b9\u30c8\u3092\u884c\u3063\u3066\u304d\u305f\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u306b\u3069\u306e\u3088\u3046\u306a\u6a29\u9650\u3092\u4e0e\u3048\u308b\u304b\u3092\u5b9a\u7fa9\u3057\u307e\u3059\u3002\nIAM\u306e\u30dd\u30ea\u30b7\u30fc\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8 (policyDocument)\u306f\u4e0b\u8a18\u306e\u3088\u3046\u306a\u5f62\u5f0f\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002\n\n\u30dd\u30ea\u30b7\u30fc\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u306e\u4f8b\n{\n  \"principalId\": \"yyyyyyyy\", // The principal user identification associated with the token sent by the client.\n  \"policyDocument\": {\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [\n      {\n        \"Action\": \"execute-api:Invoke\",\n        \"Effect\": \"Allow|Deny\",\n        \"Resource\": \"arn:aws:execute-api:<regionId>:<accountId>:<appId>/<stage>/<httpVerb>/[<resource>/<httpVerb>/[...]]\"\n      }\n    ]\n  },\n  \"context\": {\n    \"key\": \"value\",\n    \"numKey\": 1,\n    \"boolKey\": true\n  }\n}\n\n\n\nprincipalId\n\u516c\u5f0f\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8 \u306e\u8a18\u8f09\u304b\u3089\u8aad\u307f\u53d6\u308b\u3068\u3001\u30a2\u30af\u30bb\u30b9\u30c8\u30fc\u30af\u30f3\u306b\u7d10\u3065\u304f\u30e6\u30fc\u30b6\u30fc\u306e\u8b58\u5225\u5b50\u3092\u5165\u308c\u308c\u3070\u826f\u3044\u306e\u3067\u306f\u3068\u601d\u3044\u307e\u3059\u3002\n\u30b5\u30f3\u30d7\u30eb\u3067\u306f\u624b\u629c\u304d\u3057\u3066\"user\"\u3068\u3044\u3046\u56fa\u5b9a\u5024\u3092\u5165\u308c\u3066\u3044\u307e\u3059\u3002\n\n2016-12-19 \u8ffd\u8a18\nAWS\u306e\u4e2d\u306e\u4eba\u306b\u5ff5\u306e\u70ba\u78ba\u8a8d\u3057\u307e\u3057\u305f\u304c\u3001principalId\u306b\u5165\u308c\u308b\u3079\u304d\u5024\u306b\u95a2\u3057\u3066\u306f\u30c8\u30fc\u30af\u30f3\u306b\u7d10\u4ed8\u3044\u305f\u30e6\u30fc\u30b6\u30fc\u3092\u8b58\u5225\u51fa\u6765\u308b\u5024\u3067\u3042\u308c\u3070\u4f55\u3067\u3082\u826f\u3044\u305d\u3046\u3067\u3059\u3002\n\nEffect\n\"Allow\"\u307e\u305f\u306f\"Deny\"\u3092\u6307\u5b9a\u3057\u307e\u3059\u3002\n\u610f\u5473\u306f\u82f1\u5358\u8a9e\u306e\u901a\u308a\u3067\u8a31\u53ef\u3059\u308b\u5834\u5408\u306fAllow\u3092\u8a31\u53ef\u3057\u306a\u3044\u5834\u5408\u306fDeny\u3092\u6307\u5b9a\u3057\u307e\u3059\u3002\n\nResource\n\u3053\u3053\u3067\u30a2\u30af\u30bb\u30b9\u53ef\u80fd\u3068\u3059\u308b\u3001ARN\uff08\u5bfe\u8c61\u30ea\u30bd\u30fc\u30b9\u3092\u8b58\u5225\u3059\u308b\u70ba\u306e\u8b58\u5225\u5b50\uff09\u3092\u5b9a\u7fa9\u3057\u307e\u3059\u3002\nARN\u306fAPIGateway\u306e\u7ba1\u7406\u753b\u9762\u304b\u3089\u78ba\u8a8d\u304c\u51fa\u6765\u307e\u3059\u3002\uff08arn:aws:execute-api\u2026\u307f\u305f\u3044\u306a\u5024\u3067\u3059\uff09\n\u30b5\u30f3\u30d7\u30eb\u3067\u306fevent.methodArn\u306e\u5024\u3092\u30a2\u30af\u30bb\u30b9\u53ef\u80fd\u306a\u30ea\u30bd\u30fc\u30b9\u3068\u3057\u3066\u767b\u9332\u3057\u3066\u3044\u307e\u3059\u3002\n\u203bevent.methodArn\u306f\u5bfe\u8c61\u30ea\u30bd\u30fc\u30b9\u306eARN\u3092\u53d6\u5f97\u3057\u307e\u3059\u3002\n\u203b\u53b3\u5bc6\u306b\u306f\u3069\u3046\u304b\u5206\u304b\u308a\u307e\u305b\u3093\u304cARN\u306fURN\u306e\u4e8b\u3060\u3068\u79c1\u306f\u89e3\u91c8\u3057\u3066\u3044\u307e\u3059\u3002\n\u3064\u307e\u308a\u3053\u306e\u5834\u5408\u306f\u3001\u4e0b\u8a18\u306eAPI\u3092\u5229\u7528\u3059\u308b\u70ba\u306e\u6a29\u9650\u3092\u30ea\u30af\u30a8\u30b9\u30c8\u3057\u3066\u304d\u305f\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u306b\u5bfe\u3057\u3066\u4ed8\u4e0e\u3057\u307e\u3059\u3002\nhttps://my-api-id.execute-api.region-id.amazonaws.com/stage/users/{userId}\n\u203b\u3082\u3057\u3082\u8907\u6570\u306e\u30ea\u30bd\u30fc\u30b9\u306b\u5bfe\u3057\u3066\u6a29\u9650\u3092\u4ed8\u4e0e\u3059\u308b\u5834\u5408\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306bgeneratePolicy()\u306e\u7b2c3\u5f15\u6570\u306b\u914d\u5217\u3067\u8907\u6570\u306eARN\u3092\u6e21\u3057\u3066\u3042\u3052\u308c\u3070OK\u3067\u3059\u3002\n\n\u8907\u6570\u306eARN\u3092\u8a31\u53ef\u3059\u308b\u4f8b\ngeneratePolicy(\n  'user',\n  'Allow',\n  [\n    'arn:aws:execute-api:region-id:666655555555:77abcdef84/*/GET/users/*',\n    'arn:aws:execute-api:region-id:666655555555:77abcdef84/*/PUT/users/*'\n  ]\n);\n\n\n\u3053\u306e\u3042\u305f\u308a\u306e\u8a18\u8f09\u4f8b\u306b\u95a2\u3057\u3066\u306fAPI \u5b9f\u884c\u30a2\u30af\u30bb\u30b9\u6a29\u9650\u306e IAM \u30dd\u30ea\u30b7\u30fc\u306e\u4f8b\u3092\u53c2\u7167\u3059\u308b\u3068\u826f\u3044\u3067\u3057\u3087\u3046\u3002\n\u3061\u306a\u307f\u306b\u7ba1\u7406\u753b\u9762\u306e\u300c\u30aa\u30fc\u30bd\u30e9\u30a4\u30b6\u30fc\u300d\u304b\u3089\u7c21\u5358\u306b\u30c6\u30b9\u30c8\u304c\u53ef\u80fd\u3067\u3059\u3002\nID\u30c8\u30fc\u30af\u30f3\u306e\u90e8\u5206\u306bDynamoDB\u306b\u5b58\u5728\u3059\u308b\u30a2\u30af\u30bb\u30b9\u30c8\u30fc\u30af\u30f3\u3092\u30bb\u30c3\u30c8\u3057\u3066\u30c6\u30b9\u30c8\u3092\u62bc\u4e0b\u3059\u308b\u3068\u3001\n\n\u4e0b\u8a18\u306e\u3088\u3046\u306a\u30dd\u30ea\u30b7\u30fc\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u306e\u4e2d\u8eab\u304c\u78ba\u8a8d\u51fa\u6765\u307e\u3059\u3002\n\n\u30c6\u30b9\u30c8\u3067\u8fd4\u5374\u3055\u308c\u305f\u30dd\u30ea\u30b7\u30fc\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u306e\u4e2d\u8eab\n{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Action\": \"execute-api:Invoke\",\n      \"Effect\": \"Allow\",\n      \"Resource\": [\n        \"arn:aws:execute-api:us-east-1:200000000000:77abcdef84/*/POST/users\",\n        \"arn:aws:execute-api:us-east-1:200000000000:77abcdef84/*/GET/users/*\",\n        \"arn:aws:execute-api:us-east-1:200000000000:77abcdef84/*/PUT/users/*\"\n      ]\n    }\n  ]\n}\n\n\n\n\u63a5\u7d9a\u78ba\u8a8d\u3092\u884c\u3046\n\u30a2\u30af\u30bb\u30b9\u30c8\u30fc\u30af\u30f3 : e4459aca-f01e-4a27-add0-05181ddc4122\n\u30e6\u30fc\u30b6\u30fcID : e649ddc9-f1d3-464b-aed3-2b88b5e55f01\n\u3053\u308c\u3089\u306e\u5024\u306fDynamoDB\u306b\u5b58\u5728\u3057\u3066\u3044\u307e\u3059\u3002\n\u3088\u3063\u3066\u671f\u5f85\u5024\u3068\u3057\u3066\u306f\u3001\u6b63\u5e38\u306b\u8a8d\u53ef\u304c\u884c\u308f\u308cAPI\u304c\u5229\u7528\u51fa\u6765\u308b\u30cf\u30ba\u3067\u3059\u3002\n\n\u30c6\u30b9\u30c8\u30b1\u30fc\u30b9\uff08/users/{userId}GET\u304c\u6b63\u5e38\u7d42\u4e86\u3059\u308b\uff09\ncurl -kv \\\n-H \"Authorization: e4459aca-f01e-4a27-add0-05181ddc4122\" \\\nhttps://77abcdef84.execute-api.us-east-1.amazonaws.com/test/users/e649ddc9-f1d3-464b-aed3-2b88b5e55f01\n\n\n\n\u30ec\u30b9\u30dd\u30f3\u30b9\uff08/users/{userId}GET\u304c\u6b63\u5e38\u7d42\u4e86\u3059\u308b\uff09\nHTTP/1.1 200 OK\nContent-Type: application/json\nContent-Length: 114\nConnection: keep-alive\nDate: Thu, 15 Dec 2016 15:56:01 GMT\nx-amzn-RequestId: fa342be3-c2de-11e6-a907-03c47bdf205f\n\n{\n  \"Items\":[\n    {\n      \"id\":\"e649ddc9-f1d3-464b-aed3-2b88b5e55f01\",\n      \"email\":\"keitahoge@gmail.com\"\n    }\n  ],\n  \"Count\":1,\n  \"ScannedCount\":7\n}\n\n\n\u610f\u56f3\u3057\u305f\u901a\u308a\u306e\u30ec\u30b9\u30dd\u30f3\u30b9\u306b\u306a\u308a\u307e\u3057\u305f\u3002\n\u8a66\u3057\u306b\u5148\u7a0b\u3068\u540c\u3058\u30a2\u30af\u30bb\u30b9\u30c8\u30fc\u30af\u30f3\u3092\u5229\u7528\u3057\u3066\u30e6\u30fc\u30b6\u30fcID\u306e\u90e8\u5206\u3092\u4ed6\u306e\u30e6\u30fc\u30b6\u30fcID\u306b\u5909\u66f4\u3057\u3066\u30ea\u30af\u30a8\u30b9\u30c8\u3057\u307e\u3059\u3002\n\u8a8d\u53ef\u30ed\u30b8\u30c3\u30af\u7684\u306b\u306f\u30e6\u30fc\u30b6\u30fcID\uff08e649ddc9-f1d3-464b-aed3-2b88b5e55f01\uff09\u4ee5\u5916\u306b\u306f\u30a2\u30af\u30bb\u30b9\u304c\u51fa\u6765\u306a\u3044\u306e\u3067403\u30a8\u30e9\u30fc\u304c\u8fd4\u5374\u3055\u308c\u308b\u30cf\u30ba\u3067\u3059\u3002\n\n\u30c6\u30b9\u30c8\u30b1\u30fc\u30b9\uff08/users/{userId}GET\u306b\u5bfe\u3057\u3066\u5148\u7a0b\u3068\u306f\u9055\u3046\u30e6\u30fc\u30b6\u30fcID\u3092\u6307\u5b9a\uff09\ncurl -kv \\\n-H \"Authorization: e4459aca-f01e-4a27-add0-05181ddc4122\" \\\nhttps://77abcdef84.execute-api.us-east-1.amazonaws.com/test/users/1e7727c8-4fe2-4a59-af26-8ca2e6816a71\n\n\n\n\u30ec\u30b9\u30dd\u30f3\u30b9\uff08/users/{userId}GET\u306b\u5bfe\u3057\u3066\u5148\u7a0b\u3068\u306f\u9055\u3046\u30e6\u30fc\u30b6\u30fcID\u3092\u6307\u5b9a\uff09\nHTTP/1.1 403 Forbidden\nContent-Type: application/json\nContent-Length: 60\nConnection: keep-alive\nDate: Thu, 15 Dec 2016 16:07:32 GMT\nx-amzn-ErrorType: AccessDeniedException\nx-amzn-RequestId: 95d4c1e0-c2e0-11e6-99ec-77ceb77f871b\n\n{\"Message\":\"User is not authorized to access this resource\"}\n\n\n\u610f\u56f3\u3057\u305f\u901a\u308a\u306e\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3057\u307e\u3057\u305f\u3002\n\u5148\u7a0b\u306e\u30a2\u30af\u30bb\u30b9\u30c8\u30fc\u30af\u30f3\u306b\u306f\u30e6\u30fc\u30b6\u30fcID\uff08e649ddc9-f1d3-464b-aed3-2b88b5e55f01\uff09\u4ee5\u5916\u306e\u30ea\u30bd\u30fc\u30b9\u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u6a29\u9650\u304c\u306a\u3044\u4e8b\u304c\u78ba\u8a8d\u51fa\u6765\u307e\u3057\u305f\u3002\n\n\u611f\u60f3\n\u4eca\u56de\u5229\u7528\u3057\u305f\u30b5\u30f3\u30d7\u30eb\u30b3\u30fc\u30c9\u306f\u7c21\u6613\u7684\u306a\u7269\u3067\u3059\u304c\u3001OAuth2\u3084OpenIDConnect\u306b\u6e96\u62e0\u3057\u305f\u672c\u683c\u7684\u306a\u8a8d\u53ef\u57fa\u76e4\u3092\u958b\u767a\u3059\u308b\u4e8b\u3082\u53ef\u80fd\u3060\u3068\u601d\u3044\u307e\u3059\u3002\uff08\u5b8c\u5168\u306b\u6e96\u62e0\u3059\u308b\u3068\u306a\u308b\u3068\u304b\u306a\u308a\u5927\u5909\u3060\u3068\u601d\u3044\u307e\u3059\u3002\uff09\n\u203b\u30b5\u30f3\u30d7\u30eb\u30b3\u30fc\u30c9\u306f\u4e00\u5fdc\u3001github\u306b\u4e0a\u3052\u3066\u304a\u304d\u307e\u3057\u305f\u3002\n## \u6982\u8981\n[Amazon API Gateway](https://ap-northeast-1.console.aws.amazon.com/apigateway/home) \u3068[AWS Lambda](http://docs.aws.amazon.com/ja_jp/lambda/latest/dg/welcome.html) \u3092\u5229\u7528\u3057\u3066Custom Authorizer\u3092\u5229\u7528\u3057\u307e\u3059\u3002\n\n## API Gateway\u3092\u5229\u7528\u3059\u308b\u70ba\u306bIAM\u30e6\u30fc\u30b6\u30fc\u3092\u4f5c\u6210\u3059\u308b\n\nAWS \u30eb\u30fc\u30c8\u30a2\u30ab\u30a6\u30f3\u30c8\u306b\u3088\u308b\u4f5c\u696d\u306f\u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u4e0a\u3088\u308d\u3057\u304f\u306a\u3044\u306e\u3067\u3001\u5c02\u7528\u306eIAM\u30e6\u30fc\u30b6\u30fc\u3092\u4f5c\u6210\u3057\u5fc5\u8981\u306a\u6a29\u9650\u306e\u307f\u3092\u4e0e\u3048\u307e\u3059\u3002\n\n[Identity and Access Management](https://console.aws.amazon.com/iam/home#/home)\u3088\u308a\u300c\u500b\u3005\u306e IAM \u30e6\u30fc\u30b6\u30fc\u306e\u4f5c\u6210\u300d\u3092\u9078\u629e\u3001\u4ee5\u4e0b\u306e\u6a29\u9650\u3092\u4ed8\u4e0e\u3057\u307e\u3059\u3002\n\n- AmazonAPIGatewayAdministrator\n- AWSLambdaFullAccess\n- AWSLambdaDynamoDBExecutionRole\n- AmazonDynamoDBFullAccesswithDataPipeline\n\n\u2193\u3053\u3093\u306a\u611f\u3058\u3001\u30b0\u30eb\u30fc\u30d7\u540d\u7b49\u306f\u5206\u304b\u308a\u3084\u3059\u3044\u540d\u524d\u3067\u3042\u308c\u3070\u4f55\u3067\u3082\u826f\u3044\u3067\u3059\u3002\n\u203b\u300c\u30d7\u30ed\u30b0\u30e9\u30e0\u306b\u3088\u308b\u30a2\u30af\u30bb\u30b9\u300d\u3068\u300cAWS \u30de\u30cd\u30b8\u30e1\u30f3\u30c8\u30b3\u30f3\u30bd\u30fc\u30eb\u3078\u306e\u30a2\u30af\u30bb\u30b9\u300d\u306b\u306f\u4e21\u65b9\u30c1\u30a7\u30c3\u30af\u3092\u3064\u3051\u3066\u304a\u304f\u306e\u3092\u5fd8\u308c\u306a\u3044\u3088\u3046\u306b\u3057\u307e\u3057\u3087\u3046\u3002\n\n<img width=\"1007\" alt=\"add_user.png\" src=\"https://qiita-image-store.s3.amazonaws.com/0/71899/65826b16-1892-94cd-f9da-c7e21ebfa90a.png\">\n\n## \u5fc5\u8981\u306aLambda\u95a2\u6570\u3092\u5b9a\u7fa9\u3059\u308b\n\n\u4eca\u56de\u306f\u30b5\u30f3\u30d7\u30eb\u3068\u3057\u3066\u4ee5\u4e0b\u306eAPI\u3092\u7528\u610f\u3057\u307e\u3059\u3002\n\n- ```/users/{userId} - GET``` # \u30e6\u30fc\u30b6\u30fc\u30921\u4ef6\u53d6\u5f97\u3059\u308b\n\n\u3053\u308c\u3089\u306e\u95a2\u6570\u304b\u3089\u30a2\u30af\u30bb\u30b9\u3059\u308b\u70ba\u306e\u30c6\u30fc\u30d6\u30eb\u30922\u3064\u7528\u610f\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\u305d\u306e\u4ed6\u306e\u9805\u76ee\u306f\u30b5\u30f3\u30d7\u30eb\u306a\u306e\u3067\u9069\u5f53\u3067OK\u3067\u3059\u3002\n\n- users\n    - id (String) \u203bprimary\u3001UUID\u3092\u751f\u6210\u3057\u3066\u5165\u308c\u308b\n    - email\uff08String\uff09\n- access_tokens\n    - access_token (String) \u203bprimary\u3001UUID\u3092\u751f\u6210\u3057\u3066\u5165\u308c\u308b\n\n\u203b\u4f59\u8ac7\u3067\u3059\u304c\u3001[\u547d\u540d\u30eb\u30fc\u30eb\u304a\u3088\u3073\u30c7\u30fc\u30bf\u578b](http://docs.aws.amazon.com/ja_jp/amazondynamodb/latest/developerguide/HowItWorks.NamingRulesDataTypes.html)\u3092\u898b\u308b\u3068\u3001\u5229\u7528\u51fa\u6765\u308b\u6587\u5b57\u5217\u3084\u4e88\u7d04\u8a9e\u7b49\u306e\u78ba\u8a8d\u304c\u51fa\u6765\u307e\u3059\u3002\n\n\u4e00\u5fdc\u3001\u4e00\u90e8\u8a18\u53f7\u304c\u4f7f\u3048\u307e\u3059\u304cAWS\u306e\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u4f8b\u3060\u3068\u30d1\u30b9\u30ab\u30eb\u30b1\u30fc\u30b9\u306e\u8907\u6570\u5f62\u3067\u547d\u540d\u3057\u3066\u3044\u308b\u4f8b\u304c\u591a\u3044\u306e\u3067\u3001\u898f\u7d04\u7b49\u306f\u305d\u308c\u306b\u5408\u308f\u305b\u308b\u306e\u304c\u826f\u3044\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u3002\n\uff08\u4eca\u56de\u306e\u30b5\u30f3\u30d7\u30eb\u3067\u306faccess_tokens\u3068\u304b\u3057\u3061\u3083\u3044\u307e\u3057\u305f\u304c\u30fb\u30fb\u30fb\uff09\n\n```js:/users/{userId}GET\n'use strict';\n\nconst AWS = require('aws-sdk');\nconst dynamo = new AWS.DynamoDB.DocumentClient();\n\nexports.handler = (event, context, callback) => {\n\n  const params = {\n    TableName: 'users',\n    FilterExpression : 'id = :val',\n    ExpressionAttributeValues : {':val': event['userId']}\n  };\n\n  dynamo.scan(params, (error, data) => {\n    if (error) {\n      callback(\n        Error('Fail. err:' + error)\n      );\n    } else {\n      callback(null, data);\n    }\n  });\n};\n```\n\n\u203b\u30b5\u30f3\u30d7\u30eb\u306a\u306e\u3067\u30b3\u30fc\u30c9\u304c\u96d1\u306a\u306e\u306f\u3054\u4e86\u627f\u4e0b\u3055\u3044\u3002\n\n## API Gateway\u304b\u3089Lambda\u95a2\u6570\u3092\u547c\u3073\u51fa\u3059\u8a2d\u5b9a\u3092\u884c\u3046\n\n\u8a73\u7d30\u306a\u624b\u9806\u306f\u7701\u7565\u3057\u307e\u3059\u3002\n\u57fa\u672c\u7684\u306b[Lambda \u95a2\u6570\u3092\u516c\u958b\u3059\u308b\u305f\u3081\u306e API \u3092\u4f5c\u6210\u3059\u308b](http://docs.aws.amazon.com/ja_jp/apigateway/latest/developerguide/api-gateway-create-api-from-example.html) \u3092\u53c2\u8003\u306b\u3057\u3066\u9802\u3051\u308c\u3070\u305d\u308c\u307b\u3069\u96e3\u3057\u304f\u306f\u3042\u308a\u307e\u305b\u3093\u3067\u3057\u305f\u3002\n\n[Lambda \u30d7\u30ed\u30ad\u30b7\u3068\u3057\u3066 API \u3092\u69cb\u7bc9\u3059\u308b](https://docs.aws.amazon.com/ja_jp/apigateway/latest/developerguide/getting-started.html)\u3092\u898b\u306a\u304c\u3089\u4e00\u901a\u308a\u306e\u57fa\u672c\u64cd\u4f5c\u3092\u3084\u3063\u3066\u304a\u304f\u4e8b\u3082\u30aa\u30b9\u30b9\u30e1\u3057\u307e\u3059\u3002\n\n\u6700\u7d42\u7684\u306bAPI Gateway\u306e\u7ba1\u7406\u753b\u9762\u3092\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u72b6\u614b\u306b\u3057\u307e\u3059\u3002\n\n<img width=\"199\" alt=\"gateway1.png\" src=\"https://qiita-image-store.s3.amazonaws.com/0/71899/ef5e1cac-8c50-a57d-30b6-6f349486f956.png\">\n\n## Custom Authorizer\u306e\u6982\u8981\n\n\u4e0b\u8a18\u306e\u56f3\u306f\u516c\u5f0f\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u306b\u8a18\u8f09\u3055\u308c\u3066\u3044\u308b\u7269\u3067\u3059\u3002\n\n![custom-auth-workflow.png](https://qiita-image-store.s3.amazonaws.com/0/71899/792cc588-ad92-2dd2-b3e1-0287d248968f.png)\n\n\u51e6\u7406\u306e\u6d41\u308c\u306f\u4e0b\u8a18\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\n\n1. \u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u306fAPI\u306b\u30ea\u30af\u30a8\u30b9\u30c8\u3092\u884c\u3044\u307e\u3059\u3002\uff08\u3053\u306e\u6642\u306bAuthorization\u30d8\u30c3\u30c0\u306b\u30a2\u30af\u30bb\u30b9\u30c8\u30fc\u30af\u30f3\u7b49\u306e\u30c8\u30fc\u30af\u30f3\u3092\u6307\u5b9a\u3057\u307e\u3059\uff09\n1. API Gateway\u306fLambda Auth Function\u3092\u547c\u3073\u51fa\u3057\u307e\u3059\u3002\n1. Lambda Auth Function\u306fAPI Gateway \u306bIAM\u30dd\u30ea\u30b7\u30fc\u3092\u8fd4\u3057\u307e\u3059\u3002\n1. IAM\u30dd\u30ea\u30b7\u30fc\u306b\u5f93\u3063\u3066\u3001API Gateway\u304c\u8a8d\u53ef\u3092\u5b9f\u65bd\u3057\u307e\u3059\u3002\n\n\u3061\u306a\u307f\u306b\u4e00\u5ea6\u8a8d\u53ef\u51e6\u7406\u3092\u884c\u3063\u305fIAM\u30dd\u30ea\u30b7\u30fc\u306f\u30ad\u30e3\u30c3\u30b7\u30e5\u3055\u308c\u307e\u3059\u3002\uff08\u73fe\u5728\u306e\u3068\u3053\u308d\u30c7\u30d5\u30a9\u30eb\u30c8\u30675\u5206\u3001\u6700\u59271\u6642\u9593\u307e\u3067\u306e\u9593\u3067\u30ad\u30e3\u30c3\u30b7\u30e5\u306e\u8a2d\u5b9a\u3092\u884c\u3048\u308b\uff09\n\u30ad\u30e3\u30c3\u30b7\u30e5\u306e\u8a2d\u5b9a\u306f\u7121\u52b9\u306b\u3059\u308b\u4e8b\u3082\u53ef\u80fd\u3067\u3059\u3002\n\n## Custom Authorizer\u7528\u306eLambda \u95a2\u6570\u3092\u5b9a\u7fa9\u3059\u308b\n\n\u4ee5\u4e0b\u306e\u30b3\u30fc\u30c9\u3092\u5b9a\u7fa9\u3057\u307e\u3059\u3002\n\u4eca\u56de\u306fAuthorization\u306e\u30a2\u30af\u30bb\u30b9\u30c8\u30fc\u30af\u30f3\u3092access_tokens\u30c6\u30fc\u30d6\u30eb\u304b\u3089\u53d6\u5f97\u3057\u3001\u53d6\u5f97\u51fa\u6765\u305f\u3089\u3001\u5bfe\u8c61\u306eAPI\u3092\u5229\u7528\u3059\u308b\u6a29\u9650\u3092\u4e0e\u3048\u307e\u3059\u3002\n\n\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306bAuthorization\u30d8\u30c3\u30c0\u306b\u30a2\u30af\u30bb\u30b9\u30c8\u30fc\u30af\u30f3\u3092\u8a2d\u5b9a\u3057\u3066\u30ea\u30af\u30a8\u30b9\u30c8\u3092\u884c\u3044\u307e\u3059\u3002\n\n```bash:\u30ea\u30af\u30a8\u30b9\u30c8\u4f8b\ncurl -kv \\\n-H \"Authorization: 6d8c4c95-d884-4735-858d-c1fd3b8d870d\" \\\nhttps://my-api-id.execute-api.region-id.amazonaws.com/stage/users/{userId}\n```\n\n\u3061\u306a\u307f\u306bAPI Gateway\u306eURL\u306e\u69cb\u6210\u3067\u3059\u304c\u3001\u4e0b\u8a18\u306e\u3088\u3046\u306a\u5f62\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002\n\nhttps://**my-api-id**.execute-api.**region-id**.amazonaws.com/**stage**\n\n#### my-api-id\nAPI\u306b\u5272\u308a\u5f53\u3066\u3089\u308c\u308b\u8b58\u5225\u5b50\u3067\u3059\u3002\nAPI Gateway\u3067API\u3092\u4f5c\u6210\u3057\u305f\u30bf\u30a4\u30df\u30f3\u30b0\uff08\u3082\u3057\u304f\u306f\u30c7\u30d7\u30ed\u30a4\u3057\u305f\u30bf\u30a4\u30df\u30f3\u30b0\u3060\u3063\u305f\u304b\u3082\uff09\u3067\u4f5c\u6210\u3055\u308c\u307e\u3059\u3002\n\n#### region-id\n\u5bfe\u8c61\u306eAPI\u304c\u5b58\u5728\u3059\u308b\u30ea\u30fc\u30b8\u30e7\u30f3\u3092\u8868\u3057\u307e\u3059\u3002\n\n#### stage\ndevelop,staging\u3001production\u7b49\u306e\u74b0\u5883\u3092\u8868\u3059\u5024\u3067\u3059\u3002\nstage\u540d\u306b\u95a2\u3057\u3066\u306f\u5229\u7528\u8005\u304c\u4efb\u610f\u3067\u4ed8\u3051\u308b\u4e8b\u304c\u51fa\u6765\u307e\u3059\u3002\n\u30c7\u30d7\u30ed\u30a4\u306e\u969b\u306f\u5229\u7528\u8005\u304c\u3069\u3053\u306estage\u306b\u5bfe\u3057\u3066\u30c7\u30d7\u30ed\u30a4\u3092\u884c\u3046\u304b\u3092\u9078\u629e\u3057\u307e\u3059\u3002\n\n\u305d\u308c\u305e\u308c\u306e\u30d1\u30e9\u30e1\u30fc\u30bf\u304c\u4e0b\u8a18\u306e\u3088\u3046\u306a\u5024\u3060\u3063\u305f\u5834\u5408\u306eURL\u306f\n\n- my-api-id\n    - 77abcdef84\n- region-id\n    - us-east-1\n- stage\n    - test\n- userId\n    - abcd1234\n\nhttps://77abcdef84.execute-api.us-east-1.amazonaws.com/test/users/abcd1234\n\u3068\u306a\u308a\u307e\u3059\u3002\n\n```js:customAuthorize\n'use strict';\n\nconst AWS = require('aws-sdk');\nconst dynamo = new AWS.DynamoDB.DocumentClient();\n\nexports.handler = (event, context, callback) => {\n\n  const accessToken = event.authorizationToken;\n\n  const params = {\n    TableName: 'access_tokens',\n    FilterExpression : 'access_token = :val',\n    ExpressionAttributeValues : {':val': accessToken}\n  };\n\n  dynamo.scan(params, (error, data) => {\n\n    if (accessToken === 'unauthorized') {\n      callback(\n        new Error('Unauthorized')\n      )\n    }\n\n    if (error) {\n      callback(\n        new Error('Fail. err:' + error)\n      );\n    } else {\n      if (data['Items'].length === 0) {\n        callback(\n          null,\n          generatePolicy('user', 'Deny', event.methodArn)\n        );\n      } else {\n        callback(\n          null,\n          generatePolicy('user', 'Allow', event.methodArn)\n        );\n      }\n    }\n  });\n};\n\n/**\n * \u30dd\u30ea\u30b7\u30fc\u3092\u751f\u6210\u3059\u308b\n *\n * @param principalId\n * @param effect\n * @param resource\n * @returns {{}}\n */\nconst generatePolicy = function(principalId, effect, resource) {\n  const authResponse = {};\n  authResponse.principalId = principalId;\n  if (effect && resource) {\n    const policyDocument = {};\n    policyDocument.Version = '2012-10-17'; // default version\n    policyDocument.Statement = [];\n    const statementOne = {};\n    statementOne.Action = 'execute-api:Invoke'; // default action\n    statementOne.Effect = effect;\n    statementOne.Resource = resource;\n    policyDocument.Statement[0] = statementOne;\n    authResponse.policyDocument = policyDocument;\n  }\n  return authResponse;\n};\n```\n\n### customAuthorize\u306e\u89e3\u8aac\n\n#### event.authorizationToken\n\u3053\u308c\u3067Authorization\u30d8\u30c3\u30c0\u306e\u4e2d\u8eab\u3092\u53d6\u5f97\u53ef\u80fd\u3067\u3059\u3002\n\n#### generatePolicy\nAWS\u306eIAM\u30dd\u30ea\u30b7\u30fc\u3092\u4f5c\u6210\u3059\u308b\u30e1\u30bd\u30c3\u30c9\u3067\u3059\u3002\nAPI Gateway\u306f\u3053\u306eIAM\u30dd\u30ea\u30b7\u30fc\u3092\u5143\u306b\u8a8d\u53ef\u3092\u5b9f\u884c\u3059\u308b\u306e\u3067\u3053\u3053\u3067\u3069\u306e\u3088\u3046\u306a\u5024\u3092\u8fd4\u5374\u3059\u308b\u304b\u3067\u3001\u30ea\u30af\u30a8\u30b9\u30c8\u3092\u884c\u3063\u3066\u304d\u305f\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u306b\u3069\u306e\u3088\u3046\u306a\u6a29\u9650\u3092\u4e0e\u3048\u308b\u304b\u3092\u5b9a\u7fa9\u3057\u307e\u3059\u3002\n\nIAM\u306e\u30dd\u30ea\u30b7\u30fc\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8 (policyDocument)\u306f\u4e0b\u8a18\u306e\u3088\u3046\u306a\u5f62\u5f0f\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002\n\n```json:\u30dd\u30ea\u30b7\u30fc\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u306e\u4f8b\n{\n  \"principalId\": \"yyyyyyyy\", // The principal user identification associated with the token sent by the client.\n  \"policyDocument\": {\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [\n      {\n        \"Action\": \"execute-api:Invoke\",\n        \"Effect\": \"Allow|Deny\",\n        \"Resource\": \"arn:aws:execute-api:<regionId>:<accountId>:<appId>/<stage>/<httpVerb>/[<resource>/<httpVerb>/[...]]\"\n      }\n    ]\n  },\n  \"context\": {\n    \"key\": \"value\",\n    \"numKey\": 1,\n    \"boolKey\": true\n  }\n}\n```\n\n#### principalId\n[\u516c\u5f0f\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8](http://docs.aws.amazon.com/ja_jp/apigateway/latest/developerguide/use-custom-authorizer.html) \u306e\u8a18\u8f09\u304b\u3089\u8aad\u307f\u53d6\u308b\u3068\u3001\u30a2\u30af\u30bb\u30b9\u30c8\u30fc\u30af\u30f3\u306b\u7d10\u3065\u304f\u30e6\u30fc\u30b6\u30fc\u306e\u8b58\u5225\u5b50\u3092\u5165\u308c\u308c\u3070\u826f\u3044\u306e\u3067\u306f\u3068\u601d\u3044\u307e\u3059\u3002\n\u30b5\u30f3\u30d7\u30eb\u3067\u306f\u624b\u629c\u304d\u3057\u3066\"user\"\u3068\u3044\u3046\u56fa\u5b9a\u5024\u3092\u5165\u308c\u3066\u3044\u307e\u3059\u3002\n\n##### 2016-12-19 \u8ffd\u8a18\nAWS\u306e\u4e2d\u306e\u4eba\u306b\u5ff5\u306e\u70ba\u78ba\u8a8d\u3057\u307e\u3057\u305f\u304c\u3001principalId\u306b\u5165\u308c\u308b\u3079\u304d\u5024\u306b\u95a2\u3057\u3066\u306f\u30c8\u30fc\u30af\u30f3\u306b\u7d10\u4ed8\u3044\u305f\u30e6\u30fc\u30b6\u30fc\u3092\u8b58\u5225\u51fa\u6765\u308b\u5024\u3067\u3042\u308c\u3070\u4f55\u3067\u3082\u826f\u3044\u305d\u3046\u3067\u3059\u3002\n\n#### Effect\n\"Allow\"\u307e\u305f\u306f\"Deny\"\u3092\u6307\u5b9a\u3057\u307e\u3059\u3002\n\u610f\u5473\u306f\u82f1\u5358\u8a9e\u306e\u901a\u308a\u3067\u8a31\u53ef\u3059\u308b\u5834\u5408\u306fAllow\u3092\u8a31\u53ef\u3057\u306a\u3044\u5834\u5408\u306fDeny\u3092\u6307\u5b9a\u3057\u307e\u3059\u3002\n\n#### Resource\n\u3053\u3053\u3067\u30a2\u30af\u30bb\u30b9\u53ef\u80fd\u3068\u3059\u308b\u3001ARN\uff08\u5bfe\u8c61\u30ea\u30bd\u30fc\u30b9\u3092\u8b58\u5225\u3059\u308b\u70ba\u306e\u8b58\u5225\u5b50\uff09\u3092\u5b9a\u7fa9\u3057\u307e\u3059\u3002\nARN\u306fAPIGateway\u306e\u7ba1\u7406\u753b\u9762\u304b\u3089\u78ba\u8a8d\u304c\u51fa\u6765\u307e\u3059\u3002\uff08arn:aws:execute-api\u2026\u307f\u305f\u3044\u306a\u5024\u3067\u3059\uff09\n\n\u30b5\u30f3\u30d7\u30eb\u3067\u306fevent.methodArn\u306e\u5024\u3092\u30a2\u30af\u30bb\u30b9\u53ef\u80fd\u306a\u30ea\u30bd\u30fc\u30b9\u3068\u3057\u3066\u767b\u9332\u3057\u3066\u3044\u307e\u3059\u3002\n\u203bevent.methodArn\u306f\u5bfe\u8c61\u30ea\u30bd\u30fc\u30b9\u306eARN\u3092\u53d6\u5f97\u3057\u307e\u3059\u3002\n\u203b\u53b3\u5bc6\u306b\u306f\u3069\u3046\u304b\u5206\u304b\u308a\u307e\u305b\u3093\u304cARN\u306f[URN](https://ja.wikipedia.org/wiki/Uniform_Resource_Name)\u306e\u4e8b\u3060\u3068\u79c1\u306f\u89e3\u91c8\u3057\u3066\u3044\u307e\u3059\u3002\n\n\u3064\u307e\u308a\u3053\u306e\u5834\u5408\u306f\u3001\u4e0b\u8a18\u306eAPI\u3092\u5229\u7528\u3059\u308b\u70ba\u306e\u6a29\u9650\u3092\u30ea\u30af\u30a8\u30b9\u30c8\u3057\u3066\u304d\u305f\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u306b\u5bfe\u3057\u3066\u4ed8\u4e0e\u3057\u307e\u3059\u3002\nhttps://my-api-id.execute-api.region-id.amazonaws.com/stage/users/{userId}\n\n\u203b\u3082\u3057\u3082\u8907\u6570\u306e\u30ea\u30bd\u30fc\u30b9\u306b\u5bfe\u3057\u3066\u6a29\u9650\u3092\u4ed8\u4e0e\u3059\u308b\u5834\u5408\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306bgeneratePolicy()\u306e\u7b2c3\u5f15\u6570\u306b\u914d\u5217\u3067\u8907\u6570\u306eARN\u3092\u6e21\u3057\u3066\u3042\u3052\u308c\u3070OK\u3067\u3059\u3002\n\n```js:\u8907\u6570\u306eARN\u3092\u8a31\u53ef\u3059\u308b\u4f8b\ngeneratePolicy(\n  'user',\n  'Allow',\n  [\n    'arn:aws:execute-api:region-id:666655555555:77abcdef84/*/GET/users/*',\n    'arn:aws:execute-api:region-id:666655555555:77abcdef84/*/PUT/users/*'\n  ]\n);\n```\n\n\u3053\u306e\u3042\u305f\u308a\u306e\u8a18\u8f09\u4f8b\u306b\u95a2\u3057\u3066\u306f[API \u5b9f\u884c\u30a2\u30af\u30bb\u30b9\u6a29\u9650\u306e IAM \u30dd\u30ea\u30b7\u30fc\u306e\u4f8b](http://docs.aws.amazon.com/ja_jp/apigateway/latest/developerguide/api-gateway-iam-policy-examples-for-api-execution.html)\u3092\u53c2\u7167\u3059\u308b\u3068\u826f\u3044\u3067\u3057\u3087\u3046\u3002\n\n\u3061\u306a\u307f\u306b\u7ba1\u7406\u753b\u9762\u306e\u300c\u30aa\u30fc\u30bd\u30e9\u30a4\u30b6\u30fc\u300d\u304b\u3089\u7c21\u5358\u306b\u30c6\u30b9\u30c8\u304c\u53ef\u80fd\u3067\u3059\u3002\nID\u30c8\u30fc\u30af\u30f3\u306e\u90e8\u5206\u306bDynamoDB\u306b\u5b58\u5728\u3059\u308b\u30a2\u30af\u30bb\u30b9\u30c8\u30fc\u30af\u30f3\u3092\u30bb\u30c3\u30c8\u3057\u3066\u30c6\u30b9\u30c8\u3092\u62bc\u4e0b\u3059\u308b\u3068\u3001\n\n<img width=\"991\" alt=\"apigateway1.png\" src=\"https://qiita-image-store.s3.amazonaws.com/0/71899/ee689228-9fff-e048-f9cf-eddfe42dfc75.png\">\n\n\u4e0b\u8a18\u306e\u3088\u3046\u306a\u30dd\u30ea\u30b7\u30fc\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u306e\u4e2d\u8eab\u304c\u78ba\u8a8d\u51fa\u6765\u307e\u3059\u3002\n\n```json:\u30c6\u30b9\u30c8\u3067\u8fd4\u5374\u3055\u308c\u305f\u30dd\u30ea\u30b7\u30fc\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u306e\u4e2d\u8eab\n{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Action\": \"execute-api:Invoke\",\n      \"Effect\": \"Allow\",\n      \"Resource\": [\n        \"arn:aws:execute-api:us-east-1:200000000000:77abcdef84/*/POST/users\",\n        \"arn:aws:execute-api:us-east-1:200000000000:77abcdef84/*/GET/users/*\",\n        \"arn:aws:execute-api:us-east-1:200000000000:77abcdef84/*/PUT/users/*\"\n      ]\n    }\n  ]\n}\n```\n\n## \u63a5\u7d9a\u78ba\u8a8d\u3092\u884c\u3046\n\n\u30a2\u30af\u30bb\u30b9\u30c8\u30fc\u30af\u30f3 : e4459aca-f01e-4a27-add0-05181ddc4122\n\u30e6\u30fc\u30b6\u30fcID : e649ddc9-f1d3-464b-aed3-2b88b5e55f01\n\n\u3053\u308c\u3089\u306e\u5024\u306fDynamoDB\u306b\u5b58\u5728\u3057\u3066\u3044\u307e\u3059\u3002\n\u3088\u3063\u3066\u671f\u5f85\u5024\u3068\u3057\u3066\u306f\u3001\u6b63\u5e38\u306b\u8a8d\u53ef\u304c\u884c\u308f\u308cAPI\u304c\u5229\u7528\u51fa\u6765\u308b\u30cf\u30ba\u3067\u3059\u3002\n\n```bash:\u30c6\u30b9\u30c8\u30b1\u30fc\u30b9\uff08/users/{userId}GET\u304c\u6b63\u5e38\u7d42\u4e86\u3059\u308b\uff09\ncurl -kv \\\n-H \"Authorization: e4459aca-f01e-4a27-add0-05181ddc4122\" \\\nhttps://77abcdef84.execute-api.us-east-1.amazonaws.com/test/users/e649ddc9-f1d3-464b-aed3-2b88b5e55f01\n```\n\n```http:\u30ec\u30b9\u30dd\u30f3\u30b9\uff08/users/{userId}GET\u304c\u6b63\u5e38\u7d42\u4e86\u3059\u308b\uff09\nHTTP/1.1 200 OK\nContent-Type: application/json\nContent-Length: 114\nConnection: keep-alive\nDate: Thu, 15 Dec 2016 15:56:01 GMT\nx-amzn-RequestId: fa342be3-c2de-11e6-a907-03c47bdf205f\n\n{\n  \"Items\":[\n    {\n      \"id\":\"e649ddc9-f1d3-464b-aed3-2b88b5e55f01\",\n      \"email\":\"keitahoge@gmail.com\"\n    }\n  ],\n  \"Count\":1,\n  \"ScannedCount\":7\n}\n```\n\n\u610f\u56f3\u3057\u305f\u901a\u308a\u306e\u30ec\u30b9\u30dd\u30f3\u30b9\u306b\u306a\u308a\u307e\u3057\u305f\u3002\n\u8a66\u3057\u306b\u5148\u7a0b\u3068\u540c\u3058\u30a2\u30af\u30bb\u30b9\u30c8\u30fc\u30af\u30f3\u3092\u5229\u7528\u3057\u3066\u30e6\u30fc\u30b6\u30fcID\u306e\u90e8\u5206\u3092\u4ed6\u306e\u30e6\u30fc\u30b6\u30fcID\u306b\u5909\u66f4\u3057\u3066\u30ea\u30af\u30a8\u30b9\u30c8\u3057\u307e\u3059\u3002\n\u8a8d\u53ef\u30ed\u30b8\u30c3\u30af\u7684\u306b\u306f\u30e6\u30fc\u30b6\u30fcID\uff08e649ddc9-f1d3-464b-aed3-2b88b5e55f01\uff09\u4ee5\u5916\u306b\u306f\u30a2\u30af\u30bb\u30b9\u304c\u51fa\u6765\u306a\u3044\u306e\u3067403\u30a8\u30e9\u30fc\u304c\u8fd4\u5374\u3055\u308c\u308b\u30cf\u30ba\u3067\u3059\u3002\n\n```bash:\u30c6\u30b9\u30c8\u30b1\u30fc\u30b9\uff08/users/{userId}GET\u306b\u5bfe\u3057\u3066\u5148\u7a0b\u3068\u306f\u9055\u3046\u30e6\u30fc\u30b6\u30fcID\u3092\u6307\u5b9a\uff09\ncurl -kv \\\n-H \"Authorization: e4459aca-f01e-4a27-add0-05181ddc4122\" \\\nhttps://77abcdef84.execute-api.us-east-1.amazonaws.com/test/users/1e7727c8-4fe2-4a59-af26-8ca2e6816a71\n```\n\n```http:\u30ec\u30b9\u30dd\u30f3\u30b9\uff08/users/{userId}GET\u306b\u5bfe\u3057\u3066\u5148\u7a0b\u3068\u306f\u9055\u3046\u30e6\u30fc\u30b6\u30fcID\u3092\u6307\u5b9a\uff09\nHTTP/1.1 403 Forbidden\nContent-Type: application/json\nContent-Length: 60\nConnection: keep-alive\nDate: Thu, 15 Dec 2016 16:07:32 GMT\nx-amzn-ErrorType: AccessDeniedException\nx-amzn-RequestId: 95d4c1e0-c2e0-11e6-99ec-77ceb77f871b\n\n{\"Message\":\"User is not authorized to access this resource\"}\n```\n\n\u610f\u56f3\u3057\u305f\u901a\u308a\u306e\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3057\u307e\u3057\u305f\u3002\n\u5148\u7a0b\u306e\u30a2\u30af\u30bb\u30b9\u30c8\u30fc\u30af\u30f3\u306b\u306f\u30e6\u30fc\u30b6\u30fcID\uff08e649ddc9-f1d3-464b-aed3-2b88b5e55f01\uff09\u4ee5\u5916\u306e\u30ea\u30bd\u30fc\u30b9\u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u6a29\u9650\u304c\u306a\u3044\u4e8b\u304c\u78ba\u8a8d\u51fa\u6765\u307e\u3057\u305f\u3002\n\n## \u611f\u60f3\n\n\u4eca\u56de\u5229\u7528\u3057\u305f\u30b5\u30f3\u30d7\u30eb\u30b3\u30fc\u30c9\u306f\u7c21\u6613\u7684\u306a\u7269\u3067\u3059\u304c\u3001[OAuth2](https://tools.ietf.org/html/rfc6749)\u3084[OpenIDConnect](http://openid-foundation-japan.github.io/openid-connect-core-1_0.ja.html)\u306b\u6e96\u62e0\u3057\u305f\u672c\u683c\u7684\u306a\u8a8d\u53ef\u57fa\u76e4\u3092\u958b\u767a\u3059\u308b\u4e8b\u3082\u53ef\u80fd\u3060\u3068\u601d\u3044\u307e\u3059\u3002\uff08\u5b8c\u5168\u306b\u6e96\u62e0\u3059\u308b\u3068\u306a\u308b\u3068\u304b\u306a\u308a\u5927\u5909\u3060\u3068\u601d\u3044\u307e\u3059\u3002\uff09\n\n\u203b\u30b5\u30f3\u30d7\u30eb\u30b3\u30fc\u30c9\u306f\u4e00\u5fdc\u3001[github](https://github.com/keita-nishimoto/aws-lambda-sample/blob/master/custom-authorize.js)\u306b\u4e0a\u3052\u3066\u304a\u304d\u307e\u3057\u305f\u3002\n\n\n\n\n\n\n\n", "tags": ["AWS", "APIGateway", "lambda", "Node.js"]}