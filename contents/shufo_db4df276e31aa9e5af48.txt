{"context": " More than 1 year has passed since last update.\n\nRequirements\n\nOpenDJ\nOpenAM\nHAProxy\nkeepalived\n\n\nOverview\n\n\u30b5\u30fc\u30d02\u53f0\n\u305d\u308c\u305e\u308cOpenDJ\u3001OpenAM\u3001HAProxy\u3001keepalived\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\nHAProxy\u306fkeepalived\u3067\u30a2\u30af\u30c6\u30a3\u30d6-\u30b9\u30bf\u30f3\u30d0\u30a4\u306b\u3057\u5197\u9577\u5316\nOpenAM\u3001OpenDJ\u306fHAProxy\u3067\u30d0\u30e9\u30f3\u30b7\u30f3\u30b0\u3057\u5197\u9577\u5316\n\n\nInstall\n\nHAProxy\n\nhaproxy\u3092yum\u3067\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\nyum install haproxy\n\nSSL\u5bfe\u5fdc\u3055\u305b\u308b\u5834\u5408\u306f\u958b\u767a\u7248\u3092\u5165\u308c\u308b\u3002\nhttps://gist.github.com/ChrisMcKee/9cdb1bf9c5314f320ec5\n\nhaproxy-install.sh\n#!/bin/bash\n\n### VARIABLES ###\nPRE_PACK=\"openssl-devel pcre-devel make gcc\"\nVER=\"1.5.1\"\n\n\n# Setup Colours\nblack='\\E[30;40m'\nred='\\E[31;40m'\ngreen='\\E[32;40m'\nyellow='\\E[33;40m'\nblue='\\E[34;40m'\nmagenta='\\E[35;40m'\ncyan='\\E[36;40m'\nwhite='\\E[37;40m'\n\nboldblack='\\E[1;30;40m'\nboldred='\\E[1;31;40m'\nboldgreen='\\E[1;32;40m'\nboldyellow='\\E[1;33;40m'\nboldblue='\\E[1;34;40m'\nboldmagenta='\\E[1;35;40m'\nboldcyan='\\E[1;36;40m'\nboldwhite='\\E[1;37;40m'\n\nReset=\"tput sgr0\"      #  Reset text attributes to normal\n                       #+ without clearing screen.\n\ncecho ()                     # Coloured-echo.\n                             # Argument $1 = message\n                             # Argument $2 = color\n{\nmessage=$1\ncolor=$2\necho -e \"$color$message\" ; $Reset\nreturn\n}\n\nclear\n\ncecho \"Installing/upgrading your web server...\" $boldgreen\n\nyum -y -q install $PRE_PACK > /dev/null\n\n\nmkdir -p /src\ncd /src\n\nwget -q http://www.haproxy.org/download/1.5/src/haproxy-$VER.tar.gz\ntar xzf haproxy-$VER.tar.gz && rm -f haproxy*.tar.gz;\ncd haproxy-$VER\n\ncecho \"Configuring and Making HAPROXY\" $boldgreen\n\nmake TARGET=linux2628 CPU=x86_64 USE_OPENSSL=1 USE_ZLIB=1 USE_PCRE=1     # compiles it with compression and ssl support; use CPU=x86_64 for CentOS x64 or i686 where approriate\n\ncecho \"Installing HAPROXY\" $boldgreen\nmake install\n\n\ncecho \"Adding HAProxy User\" $boldyellow\nid -u haproxy &>/dev/null || useradd -s /usr/sbin/nologin -r haproxy\n\n\ncecho \"Creating config and Adding Daemon\" $boldgreen\n\ncp /usr/local/sbin/haproxy* /usr/sbin/     # copy binaries to /usr/sbin\ncp /src/haproxy-$VER/examples/haproxy.init /etc/init.d/haproxy     # copy init script in /etc/init.d\nchmod +x /etc/init.d/haproxy     # setting permission on init script\nmkdir -p /etc/haproxy     # creating directory where the config file must reside\ncp /src/haproxy-$VER/examples/examples.cfg /etc/haproxy/haproxy.cfg     # copy example config file\nmkdir -p /var/lib/haproxy     # create directory for stats file\ntouch /var/lib/haproxy/stats     # creating stats file\n\n\ncecho \"checking config and starting service\" $boldyellow\nservice haproxy check     # checking configuration file is valid\nservice haproxy start     # starting haproxy to verify it is working\nchkconfig haproxy on     # setting haproxy to start with VM\n\nexit 0\n\n\n\nsocket\u30d5\u30a1\u30a4\u30eb\u7528\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u4f5c\u6210\n\nmkdir /var/run/haproxy\n\n\n\u8a3c\u660e\u66f8\n\n# \u9375\u3068\u8a3c\u660e\u66f8\u304b\u3089pem\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\ncat server.key server.crt > /etc/ssl/certs/server.pem\n\n\nhaproxy.cfg\u3092\u7de8\u96c6\u3059\u308b\n\n\n/etc/haproxy/haproxy.cfg\nglobal\n    daemon\n    maxconn 50000\n    stats socket /var/run/haproxy/haproxy.sock mode 0600 level admin\ndefaults\n    timeout connect 5000ms\n    timeout client 50000ms\n    timeout server 50000ms\n\nfrontend sso_in\n    # SSL\u5bfe\u5fdc\n    #bind 192.168.34.100:443 ssl crt /etc/ssl/certs/example.com.pem\n    bind 192.168.34.100:80\n    maxconn 30000\n    default_backend ju_sso\n\nbackend ju_sso\n    mode http   \n    # \u5f37\u5236https\n    #redirect scheme https if !{ ssl_fc }\n    # \u5f37\u5236\u7684\u306b/openam\u4ee5\u4e0b\u306b\u30ea\u30c0\u30a4\u30ec\u30af\u30c8\n    # acl has_openam_uri path_beg -i /openam                                                                                                                                                                                                   \n    # redirect location https://am-proxy.example.com/openam if !has_openam_uri\n    cookie SERVERID insert nocache\n    balance roundrobin\n    server s1 192.168.34.10:8080 maxconn 30000 cookie 01 id 1001 check inter 2000 rise 2 fall 5\n    server s2 192.168.34.11:8080 maxconn 30000 cookie 02 id 1002 check inter 2000 rise 2 fall 5\n    option forwardfor\n\nfrontend ldap_in\n    bind 192.168.34.100:3389\n    maxconn 10000\n    default_backend ju_ldap\n\nbackend ju_ldap\n    mode tcp\n    balance roundrobin\n    server s1 192.168.34.10:389 maxconn 10000 check\n    server s2 192.168.34.11:389 maxconn 10000 check\n\nlisten stats :8181        \n   mode http\n   stats enable\n   stats realm Haproxy\\ Statistics\n   stats uri /\n   stats auth haproxy:ju\n\n\n\n\u30d0\u30c3\u30af\u30a8\u30f3\u30c9\u306e\u30dd\u30fc\u30c8\u3068\u53d7\u3051\u4ed8\u3051\u308b\u30dd\u30fc\u30c8\u304c\u540c\u3058\u3060\u3068already listen\u306b\u306a\u308b\u306e\u3067\u5225\u30dd\u30fc\u30c8\u306b\u3059\u308b\u3002\n\nserver s1 192.168.34.10:8080 maxconn 30000 cookie 01 id 1001 check inter 2000 rise 2 fall 5\n\nstickysession\u306e\u8a2d\u5b9a\u3002\u540c\u4e00cookie\u306f\u540c\u3058\u30d0\u30c3\u30af\u30a8\u30f3\u30c9\u306b\u5272\u308a\u632f\u308b\u3002\nstandby\u5074\u306fnon_local_ip\u306b\u3082bind\u51fa\u6765\u308b\u3088\u3046\u306b\u30ab\u30fc\u30cd\u30eb\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u5909\u3048\u3066\u5bfe\u5fdc\u3002master\u5074\u3082\u3084\u3063\u3066\u304a\u304f\u3002\nsysctl -w net.ipv4.ip_nonlocal_bind=1\n\n\n\u7ba1\u7406\u30c4\u30fc\u30eb\u306ehatop\u3092\u5165\u308c\u3066\u304a\u304f\n\nwget http://hatop.googlecode.com/files/hatop-0.7.7.tar.gz\ntar xvf hatop-0.7.7.tar.gz\ncd hatop-0.7.7\ninstall -m 755 bin/hatop /usr/local/bin\ninstall -m 644 man/hatop.1 /usr/local/share/man/man1\n\n\n\u30c6\u30b9\u30c8\n\nhatop -s /var/run/haproxy/haproxy.sock\n\n\nkeepalived\n\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\nyum install keepalived\n\n\nkeepalived.conf\u306e\u8a2d\u5b9a\n\n\n/etc/keepalived/keepalived.conf\n! Configuration File for keepalived\n\nglobal_defs {\n   notification_email {\n     acassen@firewall.loc\n     failover@firewall.loc\n     sysadmin@firewall.loc\n   }\n   notification_email_from Alexandre.Cassen@firewall.loc\n   smtp_server 192.168.200.1\n   smtp_connect_timeout 30\n   router_id LVS_DEVEL\n}\n\nvrrp_script chk_haproxy {\n   script \"killall -0 haproxy\"   # verify the pid existance\n   interval 2                    # check every 2 seconds\n   weight 2                      # add 2 points of prio if OK\n}\n\nvrrp_instance VI_1 {\n   interface eth1                # interface to monitor\n   state MASTER\n   virtual_router_id 51          # Assign one ID for this route\n   priority 100                  # 101 on master, 100 on backup\n   virtual_ipaddress {\n       192.168.34.100            # the virtual IP\n   }\n   track_script {\n       chk_haproxy\n   }\n}\n\n\n\npriority\u306f\u30a2\u30af\u30c6\u30a3\u30d6\u5074\u3092101\u3001\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u5074\u3092100\u3068\u3059\u308b\u3002\n\nOpenstack\u4e0a\u306b\u69cb\u7bc9\u3059\u308b\u5834\u5408\nsysctl -w net.ipv4.ip_nonlocal_bind=1\n\n\u3092\u5b9f\u884c\u3057\u30ab\u30fc\u30cd\u30eb\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u5909\u3048\u308b\u3002\u3053\u308c\u3092\u3084\u3089\u306a\u3044\u3068\u540c\u6642\u306b\u540c\u3058IP\u304c\u8907\u6570\u7acb\u3061\u4e0a\u304c\u308b\u3002\n\nOpenDJ\n\nAnsible\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\nyum install --enablerepo=epel ansible\n\n\nOpenDJ\u7528role\u306e\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\n\nansible-galaxy install warren.strange.opendj\n\n\nplaybook\u4f5c\u6210\n\n\nopendj.yaml\n- hosts: localhost\n  connection: local\n  roles:\n    - warren.strange.opendj\n\n\n\nplaybook\u5b9f\u884c\n\nansible-playbook opendj.yaml\n\n\n\n\u30db\u30b9\u30c8\u540d\u8a2d\u5b9a\n\n1\u53f0\u76ee\n\nhostname openam.example.com\nsed -i -e \"s/^HOSTNAME=.*/HOSTNAME=openam.example.com/g\" /etc/sysconfig/network\necho \"192.168.34.10 openam.example.com\" >> /etc/hosts\necho \"192.168.34.11 openam2.example.com\" >> /etc/hosts\necho \"192.168.34.100 openam-proxy.example.com\" >> /etc/hosts\n\n\n2\u53f0\u76ee\n\nhostname openam2.example.com\nsed -i -e \"s/^HOSTNAME=.*/HOSTNAME=openam2.example.com/g\" /etc/sysconfig/network\necho \"192.168.34.10 openam.example.com\" >> /etc/hosts\necho \"192.168.34.11 openam2.example.com\" >> /etc/hosts\necho \"192.168.34.100 openam-proxy.example.com\" >> /etc/hosts\n\n\n\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u8a2d\u5b9a\n\n/opt/opendj/bin/dsreplication \n\u3069\u306e\u51e6\u7406\u3092\u5b9f\u884c\u3057\u307e\u3059\u304b?\n\n    1)  \u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3092\u6709\u52b9\u306b\u3059\u308b\n    2)  \u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3092\u7121\u52b9\u306b\u3059\u308b\n    3)  1 \u53f0\u306e\u30b5\u30fc\u30d0\u30fc\u3067\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3092\u521d\u671f\u5316\n    4)  \u3059\u3079\u3066\u306e\u30b5\u30fc\u30d0\u30fc\u3092\u521d\u671f\u5316\n    5)  \u5916\u90e8\u521d\u671f\u5316\u524d\n    6)  \u5916\u90e8\u521d\u671f\u5316\u5f8c\n    7)  \u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u72b6\u614b\u3092\u8868\u793a\n    8)  Purge Historical\n\n    c)  \u53d6\u6d88\u3057\n\n\u9078\u629e\u80a2: 1\n\n>>>> \u6700\u521d\u306e\u30b5\u30fc\u30d0\u30fc\u306e\u30b5\u30fc\u30d0\u30fc\u7ba1\u7406\u63a5\u7d9a\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u6307\u5b9a\u3057\u307e\u3059\n\n\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u30b5\u30fc\u30d0\u30fc\u306e\u30db\u30b9\u30c8\u540d\u307e\u305f\u306f IP \u30a2\u30c9\u30ec\u30b9 [openam.example.com]: [Enter]\n\n\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u30b5\u30fc\u30d0\u30fc\u306e\u7ba1\u7406\u30dd\u30fc\u30c8\u756a\u53f7 [4444]: [Enter]\n\n\u30b0\u30ed\u30fc\u30d0\u30eb\u7ba1\u7406\u8005\u306e\u30e6\u30fc\u30b6\u30fc ID\u3001\u307e\u305f\u306f\u30b0\u30ed\u30fc\u30d0\u30eb\u7ba1\u7406\u8005\u304c\u5b9a\u7fa9\u3055\u308c\u3066\u3044\u306a\u3044\u5834\u5408\u306f\u30d0\u30a4\u30f3\u30c9 DN [admin]: cn=Directory Manager\n\n\u30e6\u30fc\u30b6\u30fc 'cn=Directory Manager' \u306e\u30d1\u30b9\u30ef\u30fc\u30c9: [password]\n\u6700\u521d\u306e\u30b5\u30fc\u30d0\u30fc\u306e\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30dd\u30fc\u30c8 (\u672a\u4f7f\u7528\u306e\u30dd\u30fc\u30c8) [8989]: [Enter] \n\n\u6700\u521d\u306e\u30b5\u30fc\u30d0\u30fc\u306e\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30dd\u30fc\u30c8 8989 \u3078\u306e\u63a5\u7d9a\u6642\u306b\u3001\u6697\u53f7\u5316\u3055\u308c\u305f\u901a\u4fe1\u3092\u4f7f\u3063\u3066\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3057\u307e\u3059\u304b ? (yes / no) [no]: [Enter]\n\n\n\n>>>> 2 \u756a\u76ee\u306e\u30b5\u30fc\u30d0\u30fc\u306e\u30b5\u30fc\u30d0\u30fc\u7ba1\u7406\u63a5\u7d9a\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u6307\u5b9a\u3057\u307e\u3059\n\n\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u30b5\u30fc\u30d0\u30fc\u306e\u30db\u30b9\u30c8\u540d\u307e\u305f\u306f IP \u30a2\u30c9\u30ec\u30b9 [openam.example.com]: openam2.example.com\n\n\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u30b5\u30fc\u30d0\u30fc\u306e\u7ba1\u7406\u30dd\u30fc\u30c8\u756a\u53f7 [4444]: [Enter]\n\n\u30b0\u30ed\u30fc\u30d0\u30eb\u7ba1\u7406\u8005\u306e\u30e6\u30fc\u30b6\u30fc ID\u3001\u307e\u305f\u306f\u30b0\u30ed\u30fc\u30d0\u30eb\u7ba1\u7406\u8005\u304c\u5b9a\u7fa9\u3055\u308c\u3066\u3044\u306a\u3044\u5834\u5408\u306f\u30d0\u30a4\u30f3\u30c9 DN [admin]: cn=Directory Manager\n\n\u30e6\u30fc\u30b6\u30fc 'cn=Directory Manager' \u306e\u30d1\u30b9\u30ef\u30fc\u30c9: [password]\n\n\u30b5\u30fc\u30d0\u30fc\u8a3c\u660e\u66f8:\n\n\u30e6\u30fc\u30b6\u30fc DN: CN=localhost, O=Administration Connector Self-Signed Certificate\n\u6709\u52b9\u671f\u9593: 'Fri Oct 03 05:18:27 UTC 2014' \u304b\u3089\n             'Thu Sep 28 05:18:27 UTC 2034' \u307e\u3067\n\u767a\u884c\u8005: CN=localhost, O=Administration Connector Self-Signed Certificate\n\n\n\u3053\u306e\u30b5\u30fc\u30d0\u30fc\u8a3c\u660e\u66f8\u3092\u4fe1\u983c\u3057\u307e\u3059\u304b ?\n\n    1)  \u3044\u3044\u3048\n    2)  \u306f\u3044\u3001\u3053\u306e\u30bb\u30c3\u30b7\u30e7\u30f3\u3067\u306e\u307f\u4fe1\u983c\u3057\u307e\u3059\n    3)  \u306f\u3044\u3001\u30c8\u30e9\u30b9\u30c8\u30b9\u30c8\u30a2\u306b\u3082\u8ffd\u52a0\u3057\u307e\u3059\n    4)  \u8a3c\u660e\u66f8\u306e\u8a73\u7d30\u3092\u8868\u793a\u3057\u307e\u3059\n\n\u9078\u629e\u80a2 [2]: 2\n2 \u756a\u76ee\u306e\u30b5\u30fc\u30d0\u30fc\u306e\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30dd\u30fc\u30c8 (\u672a\u4f7f\u7528\u306e\u30dd\u30fc\u30c8) [8989]: [Enter]\n\n2 \u756a\u76ee\u306e\u30b5\u30fc\u30d0\u30fc\u306e\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30dd\u30fc\u30c8 8989 \u3078\u306e\u63a5\u7d9a\u6642\u306b\u3001\u6697\u53f7\u5316\u3055\u308c\u305f\u901a\u4fe1\u3092\u4f7f\u3063\u3066\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3057\u307e\u3059\u304b ? (yes / no) [no]: [Enter]\n\n\u30b0\u30ed\u30fc\u30d0\u30eb\u7ba1\u7406\u8005\u3092\u4f5c\u6210\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\u30ec\u30d7\u30ea\u30b1\u30fc\u30c8\u4e2d\u306e\u30b5\u30fc\u30d0\u30fc\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u7ba1\u7406\u7528\u306b\u4f5c\u6210\u3059\u308b\u30b0\u30ed\u30fc\u30d0\u30eb\u7ba1\u7406\u8005\u306e\u8cc7\u683c\u3092\u6307\u5b9a\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\u30b0\u30ed\u30fc\u30d0\u30eb\u7ba1\u7406\u8005\u306e\u30e6\u30fc\u30b6\u30fc ID [admin]: [Enter]\n\n\u30b0\u30ed\u30fc\u30d0\u30eb\u7ba1\u7406\u8005\u306e\u30d1\u30b9\u30ef\u30fc\u30c9: [password]\n\n\u30d1\u30b9\u30ef\u30fc\u30c9\u306e\u78ba\u8a8d: [password]\n\n\n\u30ec\u30d7\u30ea\u30b1\u30fc\u30c8\u3059\u308b\u30d9\u30fc\u30b9 DN \u3092 1 \u3064\u4ee5\u4e0a\u9078\u629e\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\u30d9\u30fc\u30b9 DN dc=example,dc=com \u3092\u30ec\u30d7\u30ea\u30b1\u30fc\u30c8\u3057\u307e\u3059\u304b ? (yes / no) [yes]: [Enter]\n\u30d9\u30fc\u30b9 DN dc=openam,dc=forgerock,dc=org \u3092\u30ec\u30d7\u30ea\u30b1\u30fc\u30c8\u3057\u307e\u3059\u304b ? (yes / no) [yes]: [Enter] \n\n\u63a5\u7d9a\u3092\u78ba\u7acb\u3057\u3066\u3044\u307e\u3059 ..... \u5b8c\u4e86\u3002\n\u767b\u9332\u60c5\u5831\u3092\u78ba\u8a8d\u3057\u3066\u3044\u307e\u3059 ..... \u5b8c\u4e86\u3002\n\u30b5\u30fc\u30d0\u30fc openam.example.com:4444 \u4e0a\u306e\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30dd\u30fc\u30c8\u3092\u69cb\u6210\u3057\u3066\u3044\u307e\u3059 ..... \u5b8c\u4e86\u3002\n\u30b5\u30fc\u30d0\u30fc openam2.example.com:4444 \u4e0a\u306e\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30dd\u30fc\u30c8\u3092\u69cb\u6210\u3057\u3066\u3044\u307e\u3059 ..... \u5b8c\u4e86\u3002\n\u30b5\u30fc\u30d0\u30fc openam.example.com:4444 \u4e0a\u306e\u30d9\u30fc\u30b9 DN dc=example,dc=com \u306e\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u69cb\u6210\u3092\u66f4\u65b0\u3057\u3066\u3044\u307e\u3059 ..... \u5b8c\u4e86\u3002\n\u30b5\u30fc\u30d0\u30fc openam2.example.com:4444 \u4e0a\u306e\u30d9\u30fc\u30b9 DN dc=example,dc=com \u306e\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u69cb\u6210\u3092\u66f4\u65b0\u3057\u3066\u3044\u307e\u3059 ..... \u5b8c\u4e86\u3002\n\u30b5\u30fc\u30d0\u30fc openam.example.com:4444 \u4e0a\u306e\u30d9\u30fc\u30b9 DN dc=openam,dc=forgerock,dc=org \u306e\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u69cb\u6210\u3092\u66f4\u65b0\u3057\u3066\u3044\u307e\u3059 ..... \u5b8c\u4e86\u3002\n\u30b5\u30fc\u30d0\u30fc openam2.example.com:4444 \u4e0a\u306e\u30d9\u30fc\u30b9 DN dc=openam,dc=forgerock,dc=org \u306e\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u69cb\u6210\u3092\u66f4\u65b0\u3057\u3066\u3044\u307e\u3059 ..... \u5b8c\u4e86\u3002\n\u30b5\u30fc\u30d0\u30fc openam.example.com:4444 \u4e0a\u306e\u767b\u9332\u69cb\u6210\u3092\u66f4\u65b0\u3057\u3066\u3044\u307e\u3059 ..... \u5b8c\u4e86\u3002\n\u30b5\u30fc\u30d0\u30fc openam2.example.com:4444 \u4e0a\u306e\u767b\u9332\u69cb\u6210\u3092\u66f4\u65b0\u3057\u3066\u3044\u307e\u3059 ..... \u5b8c\u4e86\u3002\n\u30b5\u30fc\u30d0\u30fc openam.example.com:4444 \u4e0a\u306e\u30d9\u30fc\u30b9 DN cn=schema \u306e\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u69cb\u6210\u3092\u66f4\u65b0\u3057\u3066\u3044\u307e\u3059 ..... \u5b8c\u4e86\u3002\n\u30b5\u30fc\u30d0\u30fc openam2.example.com:4444 \u4e0a\u306e\u30d9\u30fc\u30b9 DN cn=schema \u306e\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u69cb\u6210\u3092\u66f4\u65b0\u3057\u3066\u3044\u307e\u3059 ..... \u5b8c\u4e86\u3002\n\u30b5\u30fc\u30d0\u30fc openam2.example.com:4444 \u4e0a\u306e\u767b\u9332\u60c5\u5831\u3092\u3001\u30b5\u30fc\u30d0\u30fc openam.example.com:4444 \u306e\u30b3\u30f3\u30c6\u30f3\u30c4\u3067\u521d\u671f\u5316\u3057\u3066\u3044\u307e\u3059 ..... \u5b8c\u4e86\u3002\n\u30b5\u30fc\u30d0\u30fc openam2.example.com:4444 \u4e0a\u306e\u30b9\u30ad\u30fc\u30de\u3092\u3001\u30b5\u30fc\u30d0\u30fc openam.example.com:4444 \u306e\u30b3\u30f3\u30c6\u30f3\u30c4\u3067\u521d\u671f\u5316\u3057\u3066\u3044\u307e\u3059 ..... \u5b8c\u4e86\u3002\n\n\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u304c\u6b63\u5e38\u306b\u6709\u52b9\u306b\u306a\u308a\u307e\u3057\u305f\u3002  \u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u304c\u6a5f\u80fd\u3059\u308b\u306b\u306f\u3001\u30ec\u30d7\u30ea\u30b1\u30fc\u30c8\u3059\u308b\u30d9\u30fc\u30b9 DN \u306e\u30b3\u30f3\u30c6\u30f3\u30c4\u3092\u521d\u671f\u5316\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059 (dsreplication initialize \u3092\u4f7f\u7528\u3057\u3066\u521d\u671f\u5316)\u3002\n\n\u3053\u306e\u64cd\u4f5c\u306e\u8a73\u7d30\u306a\u30ed\u30b0\u306b\u3064\u3044\u3066\u306f /tmp/opendj-replication-4237327164984323237.log \u3092\u53c2\u7167\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n\nOpenAM\n1\u53f0\u76ee\u30682\u53f0\u76ee\u3067\u5fae\u5999\u306b\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u6642\u306e\u624b\u9806\u304c\u7570\u306a\u308b\u306e\u3067\u6ce8\u610f\u3002\n\n1\u53f0\u76ee\n\n\u516c\u5f0f\u30b5\u30a4\u30c8\u3088\u308aOpenAM\u306ewar\u30d5\u30a1\u30a4\u30eb\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3002\n\u4f9d\u5b58\u30d1\u30c3\u30b1\u30fc\u30b8\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\nyum install java-1.6.0-openjdk\nyum install tomcat6 tomcat6-webapps tomcat6-admin-webapps\n\ntomcat7\u306e\u5834\u5408\u306fmanager\u306e\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u5bb9\u91cf\u5236\u9650\u304c\u3042\u308b\u306e\u3067web\u304b\u3089\u4e0a\u3052\u308b\u5834\u5408\u306f\u5236\u9650\u3092\u3086\u308b\u304f\u3059\u308b\nvi /usr/share/tomcat/webapps/manager/WEB-INF/web.xml\n<max-file-size>52428800</max-file-size> \n<max-request-size>52428800</max-request-size>       \n\n\nhostname\u306e\u8a2d\u5b9a\n\n\u203b\u3053\u3053\u3068\u5f8c\u8ff0\u306eOpenAM\u8a2d\u5b9a\u306ehostname\u304c\u4e00\u81f4\u3057\u3066\u3044\u306a\u3044\u3068\u30a8\u30e9\u30fc\u3067\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u51fa\u6765\u306a\u3044\u306e\u3067\u6ce8\u610f\u3002\n$ cat /etc/sysconfig/networkk\n\nopenam-test.example.com\n\n\nSELinux\u3092Disabled\n\ncat /etc/sysconfig/selinux\nSELINUX=disabled\n\n\ntomcat\u306emanager\u30e6\u30fc\u30b6\u8ffd\u52a0\n\nvim /etc/tomcat6/tomcat-users.xml\n\n# \u4ee5\u4e0b\u3092\u8ffd\u52a0\n<role rolename=\"manager\"/>\n  <user username=\"admin\" password=\"password\" roles=\"manager\"/>\n\n\n\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u306e\u66f8\u304d\u8fbc\u307f\u304c\u51fa\u6765\u308b\u3088\u3046\u306b\u3059\u308b\u3002\n\nchown -R root:tomcat /usr/share/tomcat6\n\n\nexample.com:8080\u306b\u30a2\u30af\u30bb\u30b9\u3002\n\u30ab\u30b9\u30bf\u30e0\u8a2d\u5b9a\u304b\u3089\u8a2d\u5b9a\u3092\u3057\u3066\u3044\u304f\n\u30c7\u30d5\u30a9\u30eb\u30c8\u30e6\u30fc\u30b6\npass: password\n\u30dd\u30ea\u30b7\u30fc\u30a8\u30fc\u30b8\u30a7\u30f3\u30c8\npass: agentpassword\n\n\u8a2d\u5b9a\u30b9\u30c8\u30a2\u306e\u8a73\u7d30 \u7de8\u96c6...\nSSL \u304c\u6709\u52b9 \n\u30db\u30b9\u30c8\u540d \n\u5f85\u6a5f\u30dd\u30fc\u30c8 \n\u30eb\u30fc\u30c8\u30b5\u30d5\u30a3\u30c3\u30af\u30b9 \n\u30e6\u30fc\u30b6\u30fc\u540d \n\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u540d   \u3044\u3044\u3048 \nlocalhost \n50389 \ndc=example,dc=com \ncn=Directory Manager\n/usr/share/tomcat6/OpenAM-11.0.0\n\u30e6\u30fc\u30b6\u30fc\u30b9\u30c8\u30a2\u306e\u8a73\u7d30 \u7de8\u96c6...\nSSL \u304c\u6709\u52b9\n\u30db\u30b9\u30c8\u540d\nopenam-proxy.example.com\n\u5f85\u6a5f\u30dd\u30fc\u30c8\n3389\n\u30eb\u30fc\u30c8\u30b5\u30d5\u30a3\u30c3\u30af\u30b9\ndc=example,dc=com\n\u30e6\u30fc\u30b6\u30fc\u540d\ncn=Directory Manager\n\u30e6\u30fc\u30b6\u30fc\u30c7\u30fc\u30bf\u30b9\u30c8\u30a2\u30bf\u30a4\u30d7 \u3044\u3044\u3048\n172.16.42.120\n\u30dd\u30fc\u30c8\n389\ndc=example,dc=com\ncn=Directory Manager\nOpenDJ\n\u30b5\u30a4\u30c8\u8a2d\u5b9a\u306e\u8a73\u7d30 \u7de8\u96c6...\n\u3053\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306f\u3001\u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b5\u306e\u80cc\u5f8c\u306b\u306f\u8a2d\u5b9a\u3055\u308c\u307e\u305b\u3093\u3002\n\n\n\u8a2d\u5b9a\u30b9\u30c8\u30a2\u306fOpenAM\u3067\u30e6\u30fc\u30b6\u30c7\u30fc\u30bf\u30b9\u30c8\u30a2\u306fOpenDJ\u306b\u3059\u308b\u3002OpenDJ\u306e\u30db\u30b9\u30c8\u3068\u30dd\u30fc\u30c8\u306f\u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b5\u306e\u30db\u30b9\u30c8\u3068\u30dd\u30fc\u30c8\u306b\u3059\u308b\u3002\n\u30a8\u30e9\u30fc\u304c\u51fa\u305f\u3089\u8a2d\u5b9a\u7528\u306e\u30d5\u30a9\u30eb\u30c0\u304c\u65e2\u306b\u51fa\u6765\u3066\u3044\u308b\u306e\u3067\u4e00\u5ea6\u524a\u9664\u3057\u3066\u304b\u3089\u518d\u5ea6\u5165\u308c\u306a\u304a\u3059\n\n2\u53f0\u76ee\n1\u53f0\u76ee\u3068\u9014\u4e2d\u307e\u3067\u306f\u540c\u3058\u3067\u300c\u65e2\u5b58\u306e\u914d\u5099\u306b\u8ffd\u52a0\u3059\u308b\u300d\u3092\u9078\u629e\u3059\u308b\u3002\n\u65e2\u5b58\u306e\u914d\u5099\u306b\u8ffd\u52a0\u3067\u65e2\u306b\u5b58\u5728\u3059\u308bOpenAM\u306eURL\u3092\u5165\u529b\u3059\u308b\u3002\n\u30b5\u30a4\u30c8\u540d: test\n\u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b5\u306eURL: http://openam-proxy.example.com:80/openam\n\n\u81ea\u52d5\u7684\u306b\u8a2d\u5b9a\u304c\u57cb\u307e\u308b\u306e\u3067\u300c\u6b21\u3078\u300d\u3092\u62bc\u3059\u3002\n\u30b5\u30a4\u30c8\u540d\u3001\u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b5\u306eURL\u3092\u5165\u529b\u3057\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3092\u9032\u3081\u308b\u3002\u3053\u3053\u3067\u5931\u6557\u304c\u9593\u9055\u3063\u3066\u3044\u3066\u3082\u30ed\u30b0\u30a4\u30f3\u5f8c\u300c\u8a2d\u5b9a\u300d\u2192\u300c\u30b5\u30fc\u30d0\u30fc\u304a\u3088\u3073\u30b5\u30a4\u30c8\u300d\u3088\u308a\u8a2d\u5b9a\u3092\u76f4\u305b\u308b\u306e\u3067\u554f\u984c\u306a\u3044\u3002\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u304c\u7d42\u4e86\u3057\u305f\u3089\u5404\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3078\u30ed\u30b0\u30a4\u30f3\u3057\u300c\u8a2d\u5b9a\u300d\u2192\u300c\u30b5\u30fc\u30d0\u30fc\u304a\u3088\u3073\u30b5\u30a4\u30c8\u300d\u3088\u308a\u89aa\u30b5\u30a4\u30c8\u306e\u7b87\u6240\u304c\u7a7a\u6b04\u306b\u306a\u3063\u3066\u3044\u308b\u30db\u30b9\u30c8\u306e\u89aa\u30db\u30b9\u30c8\u3092\u8a2d\u5b9a\u3057\u305f\u30b5\u30a4\u30c8\u306b\u5909\u66f4\u3059\u308b\u3002\n\n\u691c\u8a3c\n\nHAProxy\u304c\u843d\u3061\u305f\u5834\u5408\n\n# \u843d\u3068\u3059\u524d\u306eip\nopenam1 $ ip -f inet a\n3: eth1: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP qlen 1000\n    inet 192.168.34.10/24 brd 192.168.34.255 scope global eth1\n    inet 192.168.34.100/32 scope global eth1\n\n# HAProxy\u3092\u843d\u3068\u3057\u3066\u307f\u308b\nopenam1 $ service haproxy stop\n\n# VIP\u304cfailover\u3055\u308c\u3066\u3044\u308b\u306e\u304c\u5206\u304b\u308b\nopenam1 $ ip -f inet a\n3: eth1: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP qlen 1000\n    inet 192.168.34.10/24 brd 192.168.34.255 scope global eth1\n\nopenam2 $ ip -f inet a\n3: eth1: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP qlen 1000\n    inet 192.168.34.11/24 brd 192.168.34.255 scope global eth1\n    inet 192.168.34.100/32 scope global eth1\n\n\nVIP\u306f\u30b9\u30bf\u30f3\u30d0\u30a4\u5074\u306b\u5f15\u304d\u7d99\u304c\u308c\u308b\u3002\n# \u518d\u5ea6HAProxy\u3092\u8d77\u52d5\u3055\u305b\u308b\u3068\u5143\u306b\u623b\u308b\u3002\nopenam1 $ service haproxy start\nopenam1 $ ip -f inet a \n3: eth1: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP qlen 1000\n    inet 192.168.34.10/24 brd 192.168.34.255 scope global eth1\n    inet 192.168.34.100/32 scope global eth1\n\n\n\nOpenDJ\u304c\u843d\u3061\u305f\u5834\u5408\n# \u624b\u52d5\u3067\u505c\u6b62\nservice opendj stop\n\n\nOpenAM\u306b\u30a2\u30af\u30bb\u30b9\u3002\u30fc\uff1e\u554f\u984c\u306a\u3057\u3002 \nOpenAM\u3067\u30e6\u30fc\u30b6\u60c5\u5831\u306b\u5909\u66f4\u3092\u52a0\u3048\u308b\u30fc\uff1e\u554f\u984c\u306a\u3057\u3002\n\u30e6\u30fc\u30b6\u60c5\u5831\u5909\u66f4\u5f8c\u843d\u3061\u3066\u3044\u305f\u65b9\u306eOpenDJ\u3092\u8d77\u52d5\u3002\n\n# \u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u72b6\u614b\u78ba\u8a8d\n$ /opt/opendj/bin/dsreplication status -h localhost -p 4444 -I admin -w password -X\nSuffix DN                     : Server                   : Entries : Replication enabled : DS ID : RS ID : RS Port (1) : M.C. (2) : A.O.M.C. (3) : Security (4)\n------------------------------:--------------------------:---------:---------------------:-------:-------:-------------:----------:--------------:-------------\ndc=example,dc=com             : openam.example.com:4444  : 26      : true                : 29535 : 29036 : 8989        : 0        :              : false\ndc=example,dc=com             : openam2.example.com:4444 : 22      : true                : 4242  : 16196 : 8989        : 1        :              : false\ndc=openam,dc=forgerock,dc=org : openam.example.com:4444  : 0       : true                : 10822 : 29036 : 8989        : 0        :              : false\ndc=openam,dc=forgerock,dc=org : openam2.example.com:4444 : 0       : true                : 24071 : 16196 : 8989        : 0        :              : false\n\n[1] The port used to communicate between the servers whose contents are being replicated.\n[2] The number of changes that are still missing on this server (and that have been applied to at least one of the other servers).\n[3] Age of oldest missing change: the date on which the oldest change that has not arrived on this server was generated.\n[4] Whether the replication communication through the replication port is encrypted or not.\n\n\n\u843d\u3061\u3066\u3044\u305f\u65b9\u304cM.C(Missed Change)\u304c\u6e9c\u307e\u3063\u3066\u3044\u308b\u306e\u304c\u5206\u304b\u308b\u3002\n\n\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306f\u52dd\u624b\u306b\u306f\u59cb\u307e\u3089\u306a\u3044\u3002\n\u8d77\u52d5\u76f4\u5f8c\u306f\u5dee\u5206\u304c\u767a\u751f\u3057\u3066\u3044\u308b\u3002\u30fc\uff1e OpenAM\u304b\u3089\u30e6\u30fc\u30b6\u4e00\u89a7\u3092\u898b\u308b\u3068\u66f4\u65b0\u5f8c\u306e\u5024\u304c\u5e38\u306b\u8868\u793a\u3055\u308c\u308b\u3002\n\u66f4\u65b0\u30ed\u30b0\u304c\u9032\u3093\u3067\u3044\u308b\u65b9\u306eLDAP\u306b\u5e38\u306b\u30af\u30a8\u30ea\uff08\u66f4\u65b0\u3082\u53c2\u7167\u3082\uff09\u304c\u884c\u304f\u3088\u3046\u306b\u306a\u308b\u3002\ndsreplication\u3067\u9045\u308c\u3066\u3044\u308b\u65b9\u3092\u9032\u3093\u3067\u3044\u308b\u30b5\u30fc\u30d0\u3067\u521d\u671f\u5316\n\n /opt/opendj/bin/dsreplication initialize -h openam.example.com -p 4444 -O openam2.example.com --portDestination 4444 -X -I admin -w password\n\n\n\u30ed\u30b0\u304c\u8ffd\u3044\u3064\u3044\u305f\u3002\n\u518d\u5ea6OpenAM\u4e0a\u304b\u3089\u30e6\u30fc\u30b6\u60c5\u5831\u66f4\u65b0 \u30fc\uff1e \u540c\u671f\u3055\u308c\u3066\u3044\u308b\u306e\u3067\u30de\u30eb\u30c1\u30de\u30b9\u30bf\u72b6\u614b\u3067\u3069\u3061\u3089\u3092\u66f4\u65b0\u3057\u3066\u3082\u540c\u671f\u3055\u308c\u308b\u3002\n\u7d50\u8ad6: OpenDJ\u304c\u843d\u3061\u305f\u3089\u9032\u3093\u3067\u308b\u65b9\u306e\u30c7\u30fc\u30bf\u3067\u521d\u671f\u5316\u3055\u305b\u308b\n\n\nOpenAM\u304c\u843d\u3061\u305f\u5834\u5408\n# \u624b\u52d5\u3067\u843d\u3068\u3059\nservice tomcat6 stop\n\n\n\u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b5\u306b\u30a2\u30af\u30bb\u30b9 -> \u554f\u984c\u306a\u3057\u3002\n\n# \u518d\u8d77\u52d5\nservice tomcat6 start\n\n\n\u30d0\u30e9\u30f3\u30b7\u30f3\u30b0\u78ba\u8a8d -> \u554f\u984c\u306a\u3057\u3002\n\u505c\u6b62\u4e2d\u306b\u7247\u5074\u3067\u8a2d\u5b9a\u5909\u66f4\u3057\u305f\u5834\u5408dsreplication\u306e\u521d\u671f\u5316\u304c\u5fc5\u8981\u306a\u6c17\u304c\u3059\u308b\u3002\n\n\n\u30db\u30b9\u30c8\u304c\u843d\u3061\u305f\u5834\u5408\n\n\u30ea\u30af\u30a8\u30b9\u30c8\u304c\u5168\u3066\u7247\u5074\u306b\u5bc4\u308b\n\u30db\u30b9\u30c8\u518d\u8d77\u52d5\u5f8c\u5168\u3066\u306e\u30b5\u30fc\u30d3\u30b9\u3092\u8d77\u52d5\u3067\u554f\u984c\u306a\u3057\n\n\nSession Failover\u3055\u305b\u308b\n\n\u8a2d\u5b9a\n\u300c\u8a2d\u5b9a\u300d-> \u300c\u30b0\u30ed\u30fc\u30d0\u30eb\u300d -> \u300c\u30bb\u30c3\u30b7\u30e7\u30f3\u300d\u3088\u308a\u4f5c\u6210\u6e08\u307f\u306e\u30b5\u30a4\u30c8\u306b\u5bfe\u3057\u3066Session Failover\u3092\u8a2d\u5b9a\u3059\u308b\u3002\n\nSession Failover\u624b\u9806\n\n\u30d0\u30e9\u30f3\u30b5\u304b\u3089\u5916\u3059\nSession Failover\u304c\u6709\u52b9\u306b\u306a\u3063\u3066\u3044\u308c\u3070\u540c\u671f\u3055\u308c\u3066\u3044\u308bCTS\u3092\u53c2\u7167\u3057\u3066Session\u304cFailover\u3055\u308c\u308b\n\n\u30c8\u30fc\u30af\u30f3\u306fOpenAM\u5185\u8535\u306e\u30b3\u30f3\u30d5\u30a3\u30b0\u7528\u306eOpenDJ\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306eRoot DN\u306eou=tokens\u4ee5\u4e0b\u306b\u683c\u7d0d\u3055\u308c\u3066\u3044\u308b\u3002\n\n## Requirements\n\n- OpenDJ\n- OpenAM\n- HAProxy\n- keepalived\n\n## Overview\n\n- \u30b5\u30fc\u30d02\u53f0\n- \u305d\u308c\u305e\u308cOpenDJ\u3001OpenAM\u3001HAProxy\u3001keepalived\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n- HAProxy\u306fkeepalived\u3067\u30a2\u30af\u30c6\u30a3\u30d6-\u30b9\u30bf\u30f3\u30d0\u30a4\u306b\u3057\u5197\u9577\u5316\n- OpenAM\u3001OpenDJ\u306fHAProxy\u3067\u30d0\u30e9\u30f3\u30b7\u30f3\u30b0\u3057\u5197\u9577\u5316\n\n## Install\n\n### HAProxy\n\n- haproxy\u3092yum\u3067\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n```\nyum install haproxy\n```\n\nSSL\u5bfe\u5fdc\u3055\u305b\u308b\u5834\u5408\u306f\u958b\u767a\u7248\u3092\u5165\u308c\u308b\u3002\n\nhttps://gist.github.com/ChrisMcKee/9cdb1bf9c5314f320ec5\n\n```haproxy-install.sh\n#!/bin/bash\n \n### VARIABLES ###\nPRE_PACK=\"openssl-devel pcre-devel make gcc\"\nVER=\"1.5.1\"\n \n \n# Setup Colours\nblack='\\E[30;40m'\nred='\\E[31;40m'\ngreen='\\E[32;40m'\nyellow='\\E[33;40m'\nblue='\\E[34;40m'\nmagenta='\\E[35;40m'\ncyan='\\E[36;40m'\nwhite='\\E[37;40m'\n \nboldblack='\\E[1;30;40m'\nboldred='\\E[1;31;40m'\nboldgreen='\\E[1;32;40m'\nboldyellow='\\E[1;33;40m'\nboldblue='\\E[1;34;40m'\nboldmagenta='\\E[1;35;40m'\nboldcyan='\\E[1;36;40m'\nboldwhite='\\E[1;37;40m'\n \nReset=\"tput sgr0\"      #  Reset text attributes to normal\n                       #+ without clearing screen.\n \ncecho ()                     # Coloured-echo.\n                             # Argument $1 = message\n                             # Argument $2 = color\n{\nmessage=$1\ncolor=$2\necho -e \"$color$message\" ; $Reset\nreturn\n}\n \nclear\n \ncecho \"Installing/upgrading your web server...\" $boldgreen\n \nyum -y -q install $PRE_PACK > /dev/null\n \n \nmkdir -p /src\ncd /src\n \nwget -q http://www.haproxy.org/download/1.5/src/haproxy-$VER.tar.gz\ntar xzf haproxy-$VER.tar.gz && rm -f haproxy*.tar.gz;\ncd haproxy-$VER\n \ncecho \"Configuring and Making HAPROXY\" $boldgreen\n \nmake TARGET=linux2628 CPU=x86_64 USE_OPENSSL=1 USE_ZLIB=1 USE_PCRE=1     # compiles it with compression and ssl support; use CPU=x86_64 for CentOS x64 or i686 where approriate\n \ncecho \"Installing HAPROXY\" $boldgreen\nmake install\n \n \ncecho \"Adding HAProxy User\" $boldyellow\nid -u haproxy &>/dev/null || useradd -s /usr/sbin/nologin -r haproxy\n \n \ncecho \"Creating config and Adding Daemon\" $boldgreen\n \ncp /usr/local/sbin/haproxy* /usr/sbin/     # copy binaries to /usr/sbin\ncp /src/haproxy-$VER/examples/haproxy.init /etc/init.d/haproxy     # copy init script in /etc/init.d\nchmod +x /etc/init.d/haproxy     # setting permission on init script\nmkdir -p /etc/haproxy     # creating directory where the config file must reside\ncp /src/haproxy-$VER/examples/examples.cfg /etc/haproxy/haproxy.cfg     # copy example config file\nmkdir -p /var/lib/haproxy     # create directory for stats file\ntouch /var/lib/haproxy/stats     # creating stats file\n \n \ncecho \"checking config and starting service\" $boldyellow\nservice haproxy check     # checking configuration file is valid\nservice haproxy start     # starting haproxy to verify it is working\nchkconfig haproxy on     # setting haproxy to start with VM\n \nexit 0\n```\n\n- socket\u30d5\u30a1\u30a4\u30eb\u7528\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u4f5c\u6210\n\n```\nmkdir /var/run/haproxy\n```\n\n- \u8a3c\u660e\u66f8\n\n```bash\n# \u9375\u3068\u8a3c\u660e\u66f8\u304b\u3089pem\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\ncat server.key server.crt > /etc/ssl/certs/server.pem\n```\n\n- haproxy.cfg\u3092\u7de8\u96c6\u3059\u308b\n\n```/etc/haproxy/haproxy.cfg\nglobal\n    daemon\n    maxconn 50000\n    stats socket /var/run/haproxy/haproxy.sock mode 0600 level admin\ndefaults\n    timeout connect 5000ms\n    timeout client 50000ms\n    timeout server 50000ms\n\nfrontend sso_in\n    # SSL\u5bfe\u5fdc\n    #bind 192.168.34.100:443 ssl crt /etc/ssl/certs/example.com.pem\n    bind 192.168.34.100:80\n    maxconn 30000\n    default_backend ju_sso\n\nbackend ju_sso\n    mode http   \n    # \u5f37\u5236https\n    #redirect scheme https if !{ ssl_fc }\n    # \u5f37\u5236\u7684\u306b/openam\u4ee5\u4e0b\u306b\u30ea\u30c0\u30a4\u30ec\u30af\u30c8\n    # acl has_openam_uri path_beg -i /openam                                                                                                                                                                                                   \n    # redirect location https://am-proxy.example.com/openam if !has_openam_uri\n    cookie SERVERID insert nocache\n    balance roundrobin\n    server s1 192.168.34.10:8080 maxconn 30000 cookie 01 id 1001 check inter 2000 rise 2 fall 5\n    server s2 192.168.34.11:8080 maxconn 30000 cookie 02 id 1002 check inter 2000 rise 2 fall 5\n    option forwardfor\n\nfrontend ldap_in\n    bind 192.168.34.100:3389\n    maxconn 10000\n    default_backend ju_ldap\n\nbackend ju_ldap\n    mode tcp\n    balance roundrobin\n    server s1 192.168.34.10:389 maxconn 10000 check\n    server s2 192.168.34.11:389 maxconn 10000 check\n\nlisten stats :8181        \n   mode http\n   stats enable\n   stats realm Haproxy\\ Statistics\n   stats uri /\n   stats auth haproxy:ju\n\n```\n\n\u30d0\u30c3\u30af\u30a8\u30f3\u30c9\u306e\u30dd\u30fc\u30c8\u3068\u53d7\u3051\u4ed8\u3051\u308b\u30dd\u30fc\u30c8\u304c\u540c\u3058\u3060\u3068already listen\u306b\u306a\u308b\u306e\u3067\u5225\u30dd\u30fc\u30c8\u306b\u3059\u308b\u3002\n\n- `server s1 192.168.34.10:8080 maxconn 30000 cookie 01 id 1001 check inter 2000 rise 2 fall 5`\n\nstickysession\u306e\u8a2d\u5b9a\u3002\u540c\u4e00cookie\u306f\u540c\u3058\u30d0\u30c3\u30af\u30a8\u30f3\u30c9\u306b\u5272\u308a\u632f\u308b\u3002\n\nstandby\u5074\u306fnon_local_ip\u306b\u3082bind\u51fa\u6765\u308b\u3088\u3046\u306b\u30ab\u30fc\u30cd\u30eb\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u5909\u3048\u3066\u5bfe\u5fdc\u3002master\u5074\u3082\u3084\u3063\u3066\u304a\u304f\u3002\n\n```bash\nsysctl -w net.ipv4.ip_nonlocal_bind=1\n```\n\n\n- \u7ba1\u7406\u30c4\u30fc\u30eb\u306ehatop\u3092\u5165\u308c\u3066\u304a\u304f\n\n```\nwget http://hatop.googlecode.com/files/hatop-0.7.7.tar.gz\ntar xvf hatop-0.7.7.tar.gz\ncd hatop-0.7.7\ninstall -m 755 bin/hatop /usr/local/bin\ninstall -m 644 man/hatop.1 /usr/local/share/man/man1\n```\n\n- \u30c6\u30b9\u30c8\n\n```\nhatop -s /var/run/haproxy/haproxy.sock\n```\n\n\n### keepalived\n\n- \u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n```\nyum install keepalived\n```\n\n- keepalived.conf\u306e\u8a2d\u5b9a\n\n```/etc/keepalived/keepalived.conf \n! Configuration File for keepalived\n\nglobal_defs {\n   notification_email {\n     acassen@firewall.loc\n     failover@firewall.loc\n     sysadmin@firewall.loc\n   }\n   notification_email_from Alexandre.Cassen@firewall.loc\n   smtp_server 192.168.200.1\n   smtp_connect_timeout 30\n   router_id LVS_DEVEL\n}\n\nvrrp_script chk_haproxy {\n   script \"killall -0 haproxy\"   # verify the pid existance\n   interval 2                    # check every 2 seconds\n   weight 2                      # add 2 points of prio if OK\n}\n \nvrrp_instance VI_1 {\n   interface eth1                # interface to monitor\n   state MASTER\n   virtual_router_id 51          # Assign one ID for this route\n   priority 100                  # 101 on master, 100 on backup\n   virtual_ipaddress {\n       192.168.34.100            # the virtual IP\n   }\n   track_script {\n       chk_haproxy\n   }\n}\n\n```\n\n`priority`\u306f\u30a2\u30af\u30c6\u30a3\u30d6\u5074\u3092101\u3001\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u5074\u3092100\u3068\u3059\u308b\u3002\n\n#### Openstack\u4e0a\u306b\u69cb\u7bc9\u3059\u308b\u5834\u5408\n\n```bash\nsysctl -w net.ipv4.ip_nonlocal_bind=1\n```\n\n\u3092\u5b9f\u884c\u3057\u30ab\u30fc\u30cd\u30eb\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u5909\u3048\u308b\u3002\u3053\u308c\u3092\u3084\u3089\u306a\u3044\u3068\u540c\u6642\u306b\u540c\u3058IP\u304c\u8907\u6570\u7acb\u3061\u4e0a\u304c\u308b\u3002\n\n### OpenDJ\n\n- Ansible\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n```bash\nyum install --enablerepo=epel ansible\n```\n\n- OpenDJ\u7528role\u306e\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\n\n```\nansible-galaxy install warren.strange.opendj\n```\n\n- playbook\u4f5c\u6210\n\n```opendj.yaml \n- hosts: localhost\n  connection: local\n  roles:\n    - warren.strange.opendj\n```\n\n- playbook\u5b9f\u884c\n\n```\nansible-playbook opendj.yaml\n```\n\n- \u30db\u30b9\u30c8\u540d\u8a2d\u5b9a\n\n  - **1\u53f0\u76ee**\n\n    ```bash\n    hostname openam.example.com\n    sed -i -e \"s/^HOSTNAME=.*/HOSTNAME=openam.example.com/g\" /etc/sysconfig/network\n    echo \"192.168.34.10 openam.example.com\" >> /etc/hosts\n    echo \"192.168.34.11 openam2.example.com\" >> /etc/hosts\n    echo \"192.168.34.100 openam-proxy.example.com\" >> /etc/hosts\n    ```\n\n  - **2\u53f0\u76ee**\n\n    ```bash\n    hostname openam2.example.com\n    sed -i -e \"s/^HOSTNAME=.*/HOSTNAME=openam2.example.com/g\" /etc/sysconfig/network\n    echo \"192.168.34.10 openam.example.com\" >> /etc/hosts\n    echo \"192.168.34.11 openam2.example.com\" >> /etc/hosts\n    echo \"192.168.34.100 openam-proxy.example.com\" >> /etc/hosts\n    ```\n\n\n- \u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u8a2d\u5b9a\n\n```bash\n/opt/opendj/bin/dsreplication \n\u3069\u306e\u51e6\u7406\u3092\u5b9f\u884c\u3057\u307e\u3059\u304b?\n\n    1)  \u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3092\u6709\u52b9\u306b\u3059\u308b\n    2)  \u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3092\u7121\u52b9\u306b\u3059\u308b\n    3)  1 \u53f0\u306e\u30b5\u30fc\u30d0\u30fc\u3067\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3092\u521d\u671f\u5316\n    4)  \u3059\u3079\u3066\u306e\u30b5\u30fc\u30d0\u30fc\u3092\u521d\u671f\u5316\n    5)  \u5916\u90e8\u521d\u671f\u5316\u524d\n    6)  \u5916\u90e8\u521d\u671f\u5316\u5f8c\n    7)  \u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u72b6\u614b\u3092\u8868\u793a\n    8)  Purge Historical\n\n    c)  \u53d6\u6d88\u3057\n\n\u9078\u629e\u80a2: 1\n\n>>>> \u6700\u521d\u306e\u30b5\u30fc\u30d0\u30fc\u306e\u30b5\u30fc\u30d0\u30fc\u7ba1\u7406\u63a5\u7d9a\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u6307\u5b9a\u3057\u307e\u3059\n\n\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u30b5\u30fc\u30d0\u30fc\u306e\u30db\u30b9\u30c8\u540d\u307e\u305f\u306f IP \u30a2\u30c9\u30ec\u30b9 [openam.example.com]: [Enter]\n\n\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u30b5\u30fc\u30d0\u30fc\u306e\u7ba1\u7406\u30dd\u30fc\u30c8\u756a\u53f7 [4444]: [Enter]\n\n\u30b0\u30ed\u30fc\u30d0\u30eb\u7ba1\u7406\u8005\u306e\u30e6\u30fc\u30b6\u30fc ID\u3001\u307e\u305f\u306f\u30b0\u30ed\u30fc\u30d0\u30eb\u7ba1\u7406\u8005\u304c\u5b9a\u7fa9\u3055\u308c\u3066\u3044\u306a\u3044\u5834\u5408\u306f\u30d0\u30a4\u30f3\u30c9 DN [admin]: cn=Directory Manager\n\n\u30e6\u30fc\u30b6\u30fc 'cn=Directory Manager' \u306e\u30d1\u30b9\u30ef\u30fc\u30c9: [password]\n\u6700\u521d\u306e\u30b5\u30fc\u30d0\u30fc\u306e\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30dd\u30fc\u30c8 (\u672a\u4f7f\u7528\u306e\u30dd\u30fc\u30c8) [8989]: [Enter] \n\n\u6700\u521d\u306e\u30b5\u30fc\u30d0\u30fc\u306e\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30dd\u30fc\u30c8 8989 \u3078\u306e\u63a5\u7d9a\u6642\u306b\u3001\u6697\u53f7\u5316\u3055\u308c\u305f\u901a\u4fe1\u3092\u4f7f\u3063\u3066\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3057\u307e\u3059\u304b ? (yes / no) [no]: [Enter]\n\n\n\n>>>> 2 \u756a\u76ee\u306e\u30b5\u30fc\u30d0\u30fc\u306e\u30b5\u30fc\u30d0\u30fc\u7ba1\u7406\u63a5\u7d9a\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u6307\u5b9a\u3057\u307e\u3059\n\n\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u30b5\u30fc\u30d0\u30fc\u306e\u30db\u30b9\u30c8\u540d\u307e\u305f\u306f IP \u30a2\u30c9\u30ec\u30b9 [openam.example.com]: openam2.example.com\n\n\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u30b5\u30fc\u30d0\u30fc\u306e\u7ba1\u7406\u30dd\u30fc\u30c8\u756a\u53f7 [4444]: [Enter]\n\n\u30b0\u30ed\u30fc\u30d0\u30eb\u7ba1\u7406\u8005\u306e\u30e6\u30fc\u30b6\u30fc ID\u3001\u307e\u305f\u306f\u30b0\u30ed\u30fc\u30d0\u30eb\u7ba1\u7406\u8005\u304c\u5b9a\u7fa9\u3055\u308c\u3066\u3044\u306a\u3044\u5834\u5408\u306f\u30d0\u30a4\u30f3\u30c9 DN [admin]: cn=Directory Manager\n\n\u30e6\u30fc\u30b6\u30fc 'cn=Directory Manager' \u306e\u30d1\u30b9\u30ef\u30fc\u30c9: [password]\n\n\u30b5\u30fc\u30d0\u30fc\u8a3c\u660e\u66f8:\n\n\u30e6\u30fc\u30b6\u30fc DN: CN=localhost, O=Administration Connector Self-Signed Certificate\n\u6709\u52b9\u671f\u9593: 'Fri Oct 03 05:18:27 UTC 2014' \u304b\u3089\n             'Thu Sep 28 05:18:27 UTC 2034' \u307e\u3067\n\u767a\u884c\u8005: CN=localhost, O=Administration Connector Self-Signed Certificate\n\n\n\u3053\u306e\u30b5\u30fc\u30d0\u30fc\u8a3c\u660e\u66f8\u3092\u4fe1\u983c\u3057\u307e\u3059\u304b ?\n\n    1)  \u3044\u3044\u3048\n    2)  \u306f\u3044\u3001\u3053\u306e\u30bb\u30c3\u30b7\u30e7\u30f3\u3067\u306e\u307f\u4fe1\u983c\u3057\u307e\u3059\n    3)  \u306f\u3044\u3001\u30c8\u30e9\u30b9\u30c8\u30b9\u30c8\u30a2\u306b\u3082\u8ffd\u52a0\u3057\u307e\u3059\n    4)  \u8a3c\u660e\u66f8\u306e\u8a73\u7d30\u3092\u8868\u793a\u3057\u307e\u3059\n\n\u9078\u629e\u80a2 [2]: 2\n2 \u756a\u76ee\u306e\u30b5\u30fc\u30d0\u30fc\u306e\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30dd\u30fc\u30c8 (\u672a\u4f7f\u7528\u306e\u30dd\u30fc\u30c8) [8989]: [Enter]\n\n2 \u756a\u76ee\u306e\u30b5\u30fc\u30d0\u30fc\u306e\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30dd\u30fc\u30c8 8989 \u3078\u306e\u63a5\u7d9a\u6642\u306b\u3001\u6697\u53f7\u5316\u3055\u308c\u305f\u901a\u4fe1\u3092\u4f7f\u3063\u3066\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3057\u307e\u3059\u304b ? (yes / no) [no]: [Enter]\n\n\u30b0\u30ed\u30fc\u30d0\u30eb\u7ba1\u7406\u8005\u3092\u4f5c\u6210\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\u30ec\u30d7\u30ea\u30b1\u30fc\u30c8\u4e2d\u306e\u30b5\u30fc\u30d0\u30fc\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u7ba1\u7406\u7528\u306b\u4f5c\u6210\u3059\u308b\u30b0\u30ed\u30fc\u30d0\u30eb\u7ba1\u7406\u8005\u306e\u8cc7\u683c\u3092\u6307\u5b9a\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\u30b0\u30ed\u30fc\u30d0\u30eb\u7ba1\u7406\u8005\u306e\u30e6\u30fc\u30b6\u30fc ID [admin]: [Enter]\n\n\u30b0\u30ed\u30fc\u30d0\u30eb\u7ba1\u7406\u8005\u306e\u30d1\u30b9\u30ef\u30fc\u30c9: [password]\n\n\u30d1\u30b9\u30ef\u30fc\u30c9\u306e\u78ba\u8a8d: [password]\n\n\n\u30ec\u30d7\u30ea\u30b1\u30fc\u30c8\u3059\u308b\u30d9\u30fc\u30b9 DN \u3092 1 \u3064\u4ee5\u4e0a\u9078\u629e\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\u30d9\u30fc\u30b9 DN dc=example,dc=com \u3092\u30ec\u30d7\u30ea\u30b1\u30fc\u30c8\u3057\u307e\u3059\u304b ? (yes / no) [yes]: [Enter]\n\u30d9\u30fc\u30b9 DN dc=openam,dc=forgerock,dc=org \u3092\u30ec\u30d7\u30ea\u30b1\u30fc\u30c8\u3057\u307e\u3059\u304b ? (yes / no) [yes]: [Enter] \n\n\u63a5\u7d9a\u3092\u78ba\u7acb\u3057\u3066\u3044\u307e\u3059 ..... \u5b8c\u4e86\u3002\n\u767b\u9332\u60c5\u5831\u3092\u78ba\u8a8d\u3057\u3066\u3044\u307e\u3059 ..... \u5b8c\u4e86\u3002\n\u30b5\u30fc\u30d0\u30fc openam.example.com:4444 \u4e0a\u306e\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30dd\u30fc\u30c8\u3092\u69cb\u6210\u3057\u3066\u3044\u307e\u3059 ..... \u5b8c\u4e86\u3002\n\u30b5\u30fc\u30d0\u30fc openam2.example.com:4444 \u4e0a\u306e\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30dd\u30fc\u30c8\u3092\u69cb\u6210\u3057\u3066\u3044\u307e\u3059 ..... \u5b8c\u4e86\u3002\n\u30b5\u30fc\u30d0\u30fc openam.example.com:4444 \u4e0a\u306e\u30d9\u30fc\u30b9 DN dc=example,dc=com \u306e\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u69cb\u6210\u3092\u66f4\u65b0\u3057\u3066\u3044\u307e\u3059 ..... \u5b8c\u4e86\u3002\n\u30b5\u30fc\u30d0\u30fc openam2.example.com:4444 \u4e0a\u306e\u30d9\u30fc\u30b9 DN dc=example,dc=com \u306e\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u69cb\u6210\u3092\u66f4\u65b0\u3057\u3066\u3044\u307e\u3059 ..... \u5b8c\u4e86\u3002\n\u30b5\u30fc\u30d0\u30fc openam.example.com:4444 \u4e0a\u306e\u30d9\u30fc\u30b9 DN dc=openam,dc=forgerock,dc=org \u306e\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u69cb\u6210\u3092\u66f4\u65b0\u3057\u3066\u3044\u307e\u3059 ..... \u5b8c\u4e86\u3002\n\u30b5\u30fc\u30d0\u30fc openam2.example.com:4444 \u4e0a\u306e\u30d9\u30fc\u30b9 DN dc=openam,dc=forgerock,dc=org \u306e\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u69cb\u6210\u3092\u66f4\u65b0\u3057\u3066\u3044\u307e\u3059 ..... \u5b8c\u4e86\u3002\n\u30b5\u30fc\u30d0\u30fc openam.example.com:4444 \u4e0a\u306e\u767b\u9332\u69cb\u6210\u3092\u66f4\u65b0\u3057\u3066\u3044\u307e\u3059 ..... \u5b8c\u4e86\u3002\n\u30b5\u30fc\u30d0\u30fc openam2.example.com:4444 \u4e0a\u306e\u767b\u9332\u69cb\u6210\u3092\u66f4\u65b0\u3057\u3066\u3044\u307e\u3059 ..... \u5b8c\u4e86\u3002\n\u30b5\u30fc\u30d0\u30fc openam.example.com:4444 \u4e0a\u306e\u30d9\u30fc\u30b9 DN cn=schema \u306e\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u69cb\u6210\u3092\u66f4\u65b0\u3057\u3066\u3044\u307e\u3059 ..... \u5b8c\u4e86\u3002\n\u30b5\u30fc\u30d0\u30fc openam2.example.com:4444 \u4e0a\u306e\u30d9\u30fc\u30b9 DN cn=schema \u306e\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u69cb\u6210\u3092\u66f4\u65b0\u3057\u3066\u3044\u307e\u3059 ..... \u5b8c\u4e86\u3002\n\u30b5\u30fc\u30d0\u30fc openam2.example.com:4444 \u4e0a\u306e\u767b\u9332\u60c5\u5831\u3092\u3001\u30b5\u30fc\u30d0\u30fc openam.example.com:4444 \u306e\u30b3\u30f3\u30c6\u30f3\u30c4\u3067\u521d\u671f\u5316\u3057\u3066\u3044\u307e\u3059 ..... \u5b8c\u4e86\u3002\n\u30b5\u30fc\u30d0\u30fc openam2.example.com:4444 \u4e0a\u306e\u30b9\u30ad\u30fc\u30de\u3092\u3001\u30b5\u30fc\u30d0\u30fc openam.example.com:4444 \u306e\u30b3\u30f3\u30c6\u30f3\u30c4\u3067\u521d\u671f\u5316\u3057\u3066\u3044\u307e\u3059 ..... \u5b8c\u4e86\u3002\n\n\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u304c\u6b63\u5e38\u306b\u6709\u52b9\u306b\u306a\u308a\u307e\u3057\u305f\u3002  \u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u304c\u6a5f\u80fd\u3059\u308b\u306b\u306f\u3001\u30ec\u30d7\u30ea\u30b1\u30fc\u30c8\u3059\u308b\u30d9\u30fc\u30b9 DN \u306e\u30b3\u30f3\u30c6\u30f3\u30c4\u3092\u521d\u671f\u5316\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059 (dsreplication initialize \u3092\u4f7f\u7528\u3057\u3066\u521d\u671f\u5316)\u3002\n\n\u3053\u306e\u64cd\u4f5c\u306e\u8a73\u7d30\u306a\u30ed\u30b0\u306b\u3064\u3044\u3066\u306f /tmp/opendj-replication-4237327164984323237.log \u3092\u53c2\u7167\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n```\n\n\n### OpenAM\n\n1\u53f0\u76ee\u30682\u53f0\u76ee\u3067\u5fae\u5999\u306b\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u6642\u306e\u624b\u9806\u304c\u7570\u306a\u308b\u306e\u3067\u6ce8\u610f\u3002\n\n#### 1\u53f0\u76ee\n\n- [\u516c\u5f0f\u30b5\u30a4\u30c8](https://backstage.forgerock.com/#!/downloads)\u3088\u308aOpenAM\u306ewar\u30d5\u30a1\u30a4\u30eb\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3002\n\n- \u4f9d\u5b58\u30d1\u30c3\u30b1\u30fc\u30b8\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n```\nyum install java-1.6.0-openjdk\nyum install tomcat6 tomcat6-webapps tomcat6-admin-webapps\n```\n\ntomcat7\u306e\u5834\u5408\u306fmanager\u306e\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u5bb9\u91cf\u5236\u9650\u304c\u3042\u308b\u306e\u3067web\u304b\u3089\u4e0a\u3052\u308b\u5834\u5408\u306f\u5236\u9650\u3092\u3086\u308b\u304f\u3059\u308b\n\n```bash\nvi /usr/share/tomcat/webapps/manager/WEB-INF/web.xml\n<max-file-size>52428800</max-file-size> \n<max-request-size>52428800</max-request-size>       \n```\n\n- hostname\u306e\u8a2d\u5b9a\n\n\u203b\u3053\u3053\u3068\u5f8c\u8ff0\u306eOpenAM\u8a2d\u5b9a\u306ehostname\u304c\u4e00\u81f4\u3057\u3066\u3044\u306a\u3044\u3068\u30a8\u30e9\u30fc\u3067\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u51fa\u6765\u306a\u3044\u306e\u3067\u6ce8\u610f\u3002\n\n```bash\n$ cat /etc/sysconfig/networkk\n\nopenam-test.example.com\n```\n\n- SELinux\u3092Disabled\n\n```\ncat /etc/sysconfig/selinux\nSELINUX=disabled\n```\n\n- tomcat\u306emanager\u30e6\u30fc\u30b6\u8ffd\u52a0\n\n```\nvim /etc/tomcat6/tomcat-users.xml\n\n# \u4ee5\u4e0b\u3092\u8ffd\u52a0\n<role rolename=\"manager\"/>\n  <user username=\"admin\" password=\"password\" roles=\"manager\"/>\n```\n\n- \u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u306e\u66f8\u304d\u8fbc\u307f\u304c\u51fa\u6765\u308b\u3088\u3046\u306b\u3059\u308b\u3002\n\n```\nchown -R root:tomcat /usr/share/tomcat6\n```\n\n- example.com:8080\u306b\u30a2\u30af\u30bb\u30b9\u3002\n\n- \u30ab\u30b9\u30bf\u30e0\u8a2d\u5b9a\u304b\u3089\u8a2d\u5b9a\u3092\u3057\u3066\u3044\u304f\n\n- \u30c7\u30d5\u30a9\u30eb\u30c8\u30e6\u30fc\u30b6\npass: password\n\n- \u30dd\u30ea\u30b7\u30fc\u30a8\u30fc\u30b8\u30a7\u30f3\u30c8\npass: agentpassword\n\n```\n\u8a2d\u5b9a\u30b9\u30c8\u30a2\u306e\u8a73\u7d30 \u7de8\u96c6...\nSSL \u304c\u6709\u52b9 \n\u30db\u30b9\u30c8\u540d \n\u5f85\u6a5f\u30dd\u30fc\u30c8 \n\u30eb\u30fc\u30c8\u30b5\u30d5\u30a3\u30c3\u30af\u30b9 \n\u30e6\u30fc\u30b6\u30fc\u540d \n\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u540d\t\u3044\u3044\u3048 \nlocalhost \n50389 \ndc=example,dc=com \ncn=Directory Manager\n/usr/share/tomcat6/OpenAM-11.0.0\n\u30e6\u30fc\u30b6\u30fc\u30b9\u30c8\u30a2\u306e\u8a73\u7d30 \u7de8\u96c6...\nSSL \u304c\u6709\u52b9\n\u30db\u30b9\u30c8\u540d\nopenam-proxy.example.com\n\u5f85\u6a5f\u30dd\u30fc\u30c8\n3389\n\u30eb\u30fc\u30c8\u30b5\u30d5\u30a3\u30c3\u30af\u30b9\ndc=example,dc=com\n\u30e6\u30fc\u30b6\u30fc\u540d\ncn=Directory Manager\n\u30e6\u30fc\u30b6\u30fc\u30c7\u30fc\u30bf\u30b9\u30c8\u30a2\u30bf\u30a4\u30d7\t\u3044\u3044\u3048\n172.16.42.120\n\u30dd\u30fc\u30c8\n389\ndc=example,dc=com\ncn=Directory Manager\nOpenDJ\n\u30b5\u30a4\u30c8\u8a2d\u5b9a\u306e\u8a73\u7d30 \u7de8\u96c6...\n\u3053\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306f\u3001\u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b5\u306e\u80cc\u5f8c\u306b\u306f\u8a2d\u5b9a\u3055\u308c\u307e\u305b\u3093\u3002\n\n```\n\n\u8a2d\u5b9a\u30b9\u30c8\u30a2\u306fOpenAM\u3067\u30e6\u30fc\u30b6\u30c7\u30fc\u30bf\u30b9\u30c8\u30a2\u306fOpenDJ\u306b\u3059\u308b\u3002OpenDJ\u306e\u30db\u30b9\u30c8\u3068\u30dd\u30fc\u30c8\u306f\u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b5\u306e\u30db\u30b9\u30c8\u3068\u30dd\u30fc\u30c8\u306b\u3059\u308b\u3002\n\n\u30a8\u30e9\u30fc\u304c\u51fa\u305f\u3089\u8a2d\u5b9a\u7528\u306e\u30d5\u30a9\u30eb\u30c0\u304c\u65e2\u306b\u51fa\u6765\u3066\u3044\u308b\u306e\u3067\u4e00\u5ea6\u524a\u9664\u3057\u3066\u304b\u3089\u518d\u5ea6\u5165\u308c\u306a\u304a\u3059\n\n#### 2\u53f0\u76ee\n\n1\u53f0\u76ee\u3068\u9014\u4e2d\u307e\u3067\u306f\u540c\u3058\u3067\u300c\u65e2\u5b58\u306e\u914d\u5099\u306b\u8ffd\u52a0\u3059\u308b\u300d\u3092\u9078\u629e\u3059\u308b\u3002\n\u65e2\u5b58\u306e\u914d\u5099\u306b\u8ffd\u52a0\u3067\u65e2\u306b\u5b58\u5728\u3059\u308bOpenAM\u306eURL\u3092\u5165\u529b\u3059\u308b\u3002\n\n```\n\u30b5\u30a4\u30c8\u540d: test\n\u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b5\u306eURL: http://openam-proxy.example.com:80/openam\n```\n\n\n\u81ea\u52d5\u7684\u306b\u8a2d\u5b9a\u304c\u57cb\u307e\u308b\u306e\u3067\u300c\u6b21\u3078\u300d\u3092\u62bc\u3059\u3002\n\u30b5\u30a4\u30c8\u540d\u3001\u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b5\u306eURL\u3092\u5165\u529b\u3057\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3092\u9032\u3081\u308b\u3002\u3053\u3053\u3067\u5931\u6557\u304c\u9593\u9055\u3063\u3066\u3044\u3066\u3082\u30ed\u30b0\u30a4\u30f3\u5f8c\u300c\u8a2d\u5b9a\u300d\u2192\u300c\u30b5\u30fc\u30d0\u30fc\u304a\u3088\u3073\u30b5\u30a4\u30c8\u300d\u3088\u308a\u8a2d\u5b9a\u3092\u76f4\u305b\u308b\u306e\u3067\u554f\u984c\u306a\u3044\u3002\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u304c\u7d42\u4e86\u3057\u305f\u3089\u5404\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3078\u30ed\u30b0\u30a4\u30f3\u3057\u300c\u8a2d\u5b9a\u300d\u2192\u300c\u30b5\u30fc\u30d0\u30fc\u304a\u3088\u3073\u30b5\u30a4\u30c8\u300d\u3088\u308a\u89aa\u30b5\u30a4\u30c8\u306e\u7b87\u6240\u304c\u7a7a\u6b04\u306b\u306a\u3063\u3066\u3044\u308b\u30db\u30b9\u30c8\u306e\u89aa\u30db\u30b9\u30c8\u3092\u8a2d\u5b9a\u3057\u305f\u30b5\u30a4\u30c8\u306b\u5909\u66f4\u3059\u308b\u3002\n\n## \u691c\u8a3c\n\n### HAProxy\u304c\u843d\u3061\u305f\u5834\u5408\n\n```bash\n\n# \u843d\u3068\u3059\u524d\u306eip\nopenam1 $ ip -f inet a\n3: eth1: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP qlen 1000\n    inet 192.168.34.10/24 brd 192.168.34.255 scope global eth1\n    inet 192.168.34.100/32 scope global eth1\n\n# HAProxy\u3092\u843d\u3068\u3057\u3066\u307f\u308b\nopenam1 $ service haproxy stop\n\n# VIP\u304cfailover\u3055\u308c\u3066\u3044\u308b\u306e\u304c\u5206\u304b\u308b\nopenam1 $ ip -f inet a\n3: eth1: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP qlen 1000\n    inet 192.168.34.10/24 brd 192.168.34.255 scope global eth1\n\nopenam2 $ ip -f inet a\n3: eth1: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP qlen 1000\n    inet 192.168.34.11/24 brd 192.168.34.255 scope global eth1\n    inet 192.168.34.100/32 scope global eth1\n\n```\n\nVIP\u306f\u30b9\u30bf\u30f3\u30d0\u30a4\u5074\u306b\u5f15\u304d\u7d99\u304c\u308c\u308b\u3002\n\n```\n# \u518d\u5ea6HAProxy\u3092\u8d77\u52d5\u3055\u305b\u308b\u3068\u5143\u306b\u623b\u308b\u3002\nopenam1 $ service haproxy start\nopenam1 $ ip -f inet a \n3: eth1: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP qlen 1000\n    inet 192.168.34.10/24 brd 192.168.34.255 scope global eth1\n    inet 192.168.34.100/32 scope global eth1\n\n```\n\n### OpenDJ\u304c\u843d\u3061\u305f\u5834\u5408\n\n```\n# \u624b\u52d5\u3067\u505c\u6b62\nservice opendj stop\n```\n\n- OpenAM\u306b\u30a2\u30af\u30bb\u30b9\u3002\u30fc\uff1e\u554f\u984c\u306a\u3057\u3002 \n- OpenAM\u3067\u30e6\u30fc\u30b6\u60c5\u5831\u306b\u5909\u66f4\u3092\u52a0\u3048\u308b\u30fc\uff1e\u554f\u984c\u306a\u3057\u3002\n- \u30e6\u30fc\u30b6\u60c5\u5831\u5909\u66f4\u5f8c\u843d\u3061\u3066\u3044\u305f\u65b9\u306eOpenDJ\u3092\u8d77\u52d5\u3002\n\n```bash\n# \u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u72b6\u614b\u78ba\u8a8d\n$ /opt/opendj/bin/dsreplication status -h localhost -p 4444 -I admin -w password -X\nSuffix DN                     : Server                   : Entries : Replication enabled : DS ID : RS ID : RS Port (1) : M.C. (2) : A.O.M.C. (3) : Security (4)\n------------------------------:--------------------------:---------:---------------------:-------:-------:-------------:----------:--------------:-------------\ndc=example,dc=com             : openam.example.com:4444  : 26      : true                : 29535 : 29036 : 8989        : 0        :              : false\ndc=example,dc=com             : openam2.example.com:4444 : 22      : true                : 4242  : 16196 : 8989        : 1        :              : false\ndc=openam,dc=forgerock,dc=org : openam.example.com:4444  : 0       : true                : 10822 : 29036 : 8989        : 0        :              : false\ndc=openam,dc=forgerock,dc=org : openam2.example.com:4444 : 0       : true                : 24071 : 16196 : 8989        : 0        :              : false\n\n[1] The port used to communicate between the servers whose contents are being replicated.\n[2] The number of changes that are still missing on this server (and that have been applied to at least one of the other servers).\n[3] Age of oldest missing change: the date on which the oldest change that has not arrived on this server was generated.\n[4] Whether the replication communication through the replication port is encrypted or not.\n\n```\n\n\u843d\u3061\u3066\u3044\u305f\u65b9\u304cM.C(Missed Change)\u304c\u6e9c\u307e\u3063\u3066\u3044\u308b\u306e\u304c\u5206\u304b\u308b\u3002\n\n- \u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306f\u52dd\u624b\u306b\u306f\u59cb\u307e\u3089\u306a\u3044\u3002\n\n- \u8d77\u52d5\u76f4\u5f8c\u306f\u5dee\u5206\u304c\u767a\u751f\u3057\u3066\u3044\u308b\u3002\u30fc\uff1e OpenAM\u304b\u3089\u30e6\u30fc\u30b6\u4e00\u89a7\u3092\u898b\u308b\u3068\u66f4\u65b0\u5f8c\u306e\u5024\u304c\u5e38\u306b\u8868\u793a\u3055\u308c\u308b\u3002\n- \u66f4\u65b0\u30ed\u30b0\u304c\u9032\u3093\u3067\u3044\u308b\u65b9\u306eLDAP\u306b\u5e38\u306b\u30af\u30a8\u30ea\uff08\u66f4\u65b0\u3082\u53c2\u7167\u3082\uff09\u304c\u884c\u304f\u3088\u3046\u306b\u306a\u308b\u3002\n- dsreplication\u3067\u9045\u308c\u3066\u3044\u308b\u65b9\u3092\u9032\u3093\u3067\u3044\u308b\u30b5\u30fc\u30d0\u3067\u521d\u671f\u5316\n\n```bash\n /opt/opendj/bin/dsreplication initialize -h openam.example.com -p 4444 -O openam2.example.com --portDestination 4444 -X -I admin -w password\n```\n\n- \u30ed\u30b0\u304c\u8ffd\u3044\u3064\u3044\u305f\u3002\n- \u518d\u5ea6OpenAM\u4e0a\u304b\u3089\u30e6\u30fc\u30b6\u60c5\u5831\u66f4\u65b0 \u30fc\uff1e \u540c\u671f\u3055\u308c\u3066\u3044\u308b\u306e\u3067\u30de\u30eb\u30c1\u30de\u30b9\u30bf\u72b6\u614b\u3067\u3069\u3061\u3089\u3092\u66f4\u65b0\u3057\u3066\u3082\u540c\u671f\u3055\u308c\u308b\u3002\n\n- **\u7d50\u8ad6**: **OpenDJ\u304c\u843d\u3061\u305f\u3089\u9032\u3093\u3067\u308b\u65b9\u306e\u30c7\u30fc\u30bf\u3067\u521d\u671f\u5316\u3055\u305b\u308b**\n\n\n### OpenAM\u304c\u843d\u3061\u305f\u5834\u5408\n\n```\n# \u624b\u52d5\u3067\u843d\u3068\u3059\nservice tomcat6 stop\n```\n\n- \u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b5\u306b\u30a2\u30af\u30bb\u30b9 -> \u554f\u984c\u306a\u3057\u3002\n\n```\n# \u518d\u8d77\u52d5\nservice tomcat6 start\n```\n\n- \u30d0\u30e9\u30f3\u30b7\u30f3\u30b0\u78ba\u8a8d -> \u554f\u984c\u306a\u3057\u3002\n\n- \u505c\u6b62\u4e2d\u306b\u7247\u5074\u3067\u8a2d\u5b9a\u5909\u66f4\u3057\u305f\u5834\u5408dsreplication\u306e\u521d\u671f\u5316\u304c\u5fc5\u8981\u306a\u6c17\u304c\u3059\u308b\u3002\n\n### \u30db\u30b9\u30c8\u304c\u843d\u3061\u305f\u5834\u5408\n\n- \u30ea\u30af\u30a8\u30b9\u30c8\u304c\u5168\u3066\u7247\u5074\u306b\u5bc4\u308b\n- \u30db\u30b9\u30c8\u518d\u8d77\u52d5\u5f8c\u5168\u3066\u306e\u30b5\u30fc\u30d3\u30b9\u3092\u8d77\u52d5\u3067\u554f\u984c\u306a\u3057\n\n### Session Failover\u3055\u305b\u308b\n\n#### \u8a2d\u5b9a\n\n\u300c\u8a2d\u5b9a\u300d-> \u300c\u30b0\u30ed\u30fc\u30d0\u30eb\u300d -> \u300c\u30bb\u30c3\u30b7\u30e7\u30f3\u300d\u3088\u308a\u4f5c\u6210\u6e08\u307f\u306e\u30b5\u30a4\u30c8\u306b\u5bfe\u3057\u3066Session Failover\u3092\u8a2d\u5b9a\u3059\u308b\u3002\n\n#### Session Failover\u624b\u9806\n\n1. \u30d0\u30e9\u30f3\u30b5\u304b\u3089\u5916\u3059\n2. Session Failover\u304c\u6709\u52b9\u306b\u306a\u3063\u3066\u3044\u308c\u3070\u540c\u671f\u3055\u308c\u3066\u3044\u308bCTS\u3092\u53c2\u7167\u3057\u3066Session\u304cFailover\u3055\u308c\u308b\n\n\u30c8\u30fc\u30af\u30f3\u306fOpenAM\u5185\u8535\u306e\u30b3\u30f3\u30d5\u30a3\u30b0\u7528\u306eOpenDJ\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306eRoot DN\u306e`ou=tokens`\u4ee5\u4e0b\u306b\u683c\u7d0d\u3055\u308c\u3066\u3044\u308b\u3002\n", "tags": ["OpenDJ", "OpenAM", "haproxy", "keepalived"]}