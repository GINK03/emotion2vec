{"tags": ["Ruby2.0.0-p0", "Rails3.2.13", "rake"], "context": " More than 1 year has passed since last update.\n\n\u53c2\u8003\n\nRake\u30bf\u30b9\u30af\u3092\u3064\u304f\u308b #Rails - Qiita\nChange to Rake tasks and argument structure in Rails 3.2? - Stack Overflow\n\n\n\n\u30bf\u30b9\u30af\u4f5c\u6210\nrails g task send_mail\n----------\n      create  lib/tasks/send_mail.rake\n----------\n\n\nlib/tasks/send_mail.rake\n\nnamespace :send_mail do\n  desc \"\u30e1\u30fc\u30eb\u9001\u4fe1\"\n\n  task :mail_magazine, [:target, :id] => :environment do |task, args|\n    target = args[:target]\n    id     = args[:id]\n\n    mail_maga = MailMagazine.where( id: id ).first\n    raise \"MailMagazine Not Found\" if mail_maga.blank?\n\n    if target == \"all\"\n      users = User.all\n\n      users.each_with_index(1) { |user, i|\n        begin\n          UserMailer.mail_magazine( user.email, mail_maga ).deliver\n          puts \"[ #{i} : #{user.email} ]\"\n        rescue Exception => e\n          puts \"[ ---------- Exception ---------- ]\" ; e.tapp ;\n        end\n      }\n\n      mail_maga.update_attributes!( target: target, last_sent_at: Time.now )\n    else\n      begin\n        UserMailer.mail_magazine( target, mail_maga ).deliver\n        result = mail_maga.update_attributes!( target: target, last_sent_at: Time.now )\n        puts \"[ ---------- result ---------- ]\" ; result.tapp ;\n      rescue Exception => e\n        puts \"[ ---------- Exception ---------- ]\" ; e.tapp ;\n      end\n    end\n  end\nend\n\n\n\u30bf\u30b9\u30af\u78ba\u8a8d\n\nrake -T | grep send_mail:mail_magazine\n----------\nrake send_mail:mail_magazine[target,id]  # \u30e1\u30fc\u30eb\u9001\u4fe1\n----------\n\n\n\u30ed\u30fc\u30ab\u30eb\u5b9f\u884c\n\nrake send_mail:mail_magazine[\"aaa@gmail.com\",1]\n\n\u203b\u30ab\u30f3\u30de\u306e\u5f8c\u306b\u30b9\u30da\u30fc\u30b9\u3092\u5165\u308c\u308b\u3068\u30a8\u30e9\u30fc\nrake send_mail:mail_magazine[\"aaa@gmail.com\",1]   # => OK\nrake send_mail:mail_magazine['aaa@gmail.com',1]   # => OK\nrake send_mail:mail_magazine['aaa@gmail.com', 1]  # => NG\nrake send_mail:mail_magazine[\"aaa@gmail.com\", 1]  # => NG\n\n\nHeroku\n\nHeroku\u7528\u8a2d\u5b9a\n\n\u203b\u3053\u306e\u8a2d\u5b9a\u304c\u7121\u3044\u3068\u30e2\u30c7\u30eb\u304c\u8aad\u307f\u8fbc\u3081\u306a\u3044\u300cuninitialized constant MailMagazine\u300d\u30a8\u30e9\u30fc\nconfig/environments/production.rb\n  # Enable threaded mode => For Heroku\n  config.threadsafe!\n  config.dependency_loading = true if $rails_rake_task\n\n\nHeroku\u5b9f\u884c\n\nheroku run rake send_mail:mail_magazine[\"aaa@gmail.com\",1]\n\n## \u53c2\u8003\n\n* [Rake\u30bf\u30b9\u30af\u3092\u3064\u304f\u308b #Rails - Qiita](http://qiita.com/items/9a9b0703ac4c76ebfd4e)\n* [Change to Rake tasks and argument structure in Rails 3.2? - Stack Overflow](http://stackoverflow.com/questions/9909064/change-to-rake-tasks-and-argument-structure-in-rails-3-2)\n\n----\n\n## \u30bf\u30b9\u30af\u4f5c\u6210\n\n```\nrails g task send_mail\n----------\n      create  lib/tasks/send_mail.rake\n----------\n```\n\n* lib/tasks/send_mail.rake\n\n```rb\nnamespace :send_mail do\n  desc \"\u30e1\u30fc\u30eb\u9001\u4fe1\"\n\n  task :mail_magazine, [:target, :id] => :environment do |task, args|\n    target = args[:target]\n    id     = args[:id]\n\n    mail_maga = MailMagazine.where( id: id ).first\n    raise \"MailMagazine Not Found\" if mail_maga.blank?\n\n    if target == \"all\"\n      users = User.all\n\n      users.each_with_index(1) { |user, i|\n        begin\n          UserMailer.mail_magazine( user.email, mail_maga ).deliver\n          puts \"[ #{i} : #{user.email} ]\"\n        rescue Exception => e\n          puts \"[ ---------- Exception ---------- ]\" ; e.tapp ;\n        end\n      }\n\n      mail_maga.update_attributes!( target: target, last_sent_at: Time.now )\n    else\n      begin\n        UserMailer.mail_magazine( target, mail_maga ).deliver\n        result = mail_maga.update_attributes!( target: target, last_sent_at: Time.now )\n        puts \"[ ---------- result ---------- ]\" ; result.tapp ;\n      rescue Exception => e\n        puts \"[ ---------- Exception ---------- ]\" ; e.tapp ;\n      end\n    end\n  end\nend\n```\n\n* \u30bf\u30b9\u30af\u78ba\u8a8d\n\n```\nrake -T | grep send_mail:mail_magazine\n----------\nrake send_mail:mail_magazine[target,id]  # \u30e1\u30fc\u30eb\u9001\u4fe1\n----------\n```\n\n* \u30ed\u30fc\u30ab\u30eb\u5b9f\u884c\n\n```\nrake send_mail:mail_magazine[\"aaa@gmail.com\",1]\n```\n\n\u203b\u30ab\u30f3\u30de\u306e\u5f8c\u306b\u30b9\u30da\u30fc\u30b9\u3092\u5165\u308c\u308b\u3068\u30a8\u30e9\u30fc\n\n```\nrake send_mail:mail_magazine[\"aaa@gmail.com\",1]   # => OK\nrake send_mail:mail_magazine['aaa@gmail.com',1]   # => OK\nrake send_mail:mail_magazine['aaa@gmail.com', 1]  # => NG\nrake send_mail:mail_magazine[\"aaa@gmail.com\", 1]  # => NG\n```\n\n## Heroku\n\n* Heroku\u7528\u8a2d\u5b9a\n\n\u203b\u3053\u306e\u8a2d\u5b9a\u304c\u7121\u3044\u3068\u30e2\u30c7\u30eb\u304c\u8aad\u307f\u8fbc\u3081\u306a\u3044\u300cuninitialized constant MailMagazine\u300d\u30a8\u30e9\u30fc\n\nconfig/environments/production.rb\n\n```rb\n  # Enable threaded mode => For Heroku\n  config.threadsafe!\n  config.dependency_loading = true if $rails_rake_task\n```\n\n* Heroku\u5b9f\u884c\n\n```\nheroku run rake send_mail:mail_magazine[\"aaa@gmail.com\",1]\n```\n"}