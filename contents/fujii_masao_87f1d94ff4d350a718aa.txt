{"context": " More than 1 year has passed since last update.PostgreSQL\u306e\u5168\u6587\u691c\u7d22\u30e2\u30b8\u30e5\u30fc\u30ebpg_bigm\u306e\u6700\u65b0\u30d0\u30fc\u30b8\u30e7\u30f31.1\u304c\u30ea\u30ea\u30fc\u30b9\u3055\u308c\u307e\u3057\u305f\u3002\n\u4eca\u56de\u306f\u3001\u3053\u306e\u6700\u65b0\u30d0\u30fc\u30b8\u30e7\u30f3\u3092\u4f7f\u3063\u3066\u3001PostgreSQL\u306b\u683c\u7d0d\u3057\u305f\u69d8\u3005\u306a\u65e5\u672c\u8a9e\u30c7\u30fc\u30bf\u3092\u9ad8\u901f\u306b\u65e5\u672c\u8a9e\u691c\u7d22\u3057\u3066\u307f\u307e\u3059\uff01\n(PostgreSQL Advent Calendar 2013 5\u65e5\u76ee\u306e\u8a18\u4e8b\u3068\u5185\u5bb9\u304b\u3076\u3063\u3066\u7533\u3057\u8a33\u306a\u3044\u3067\u3059\u3002\u3002)\n\n\u691c\u7d22\u5bfe\u8c61\u30c7\u30fc\u30bf\n\u4eca\u56de\u306f\u3001\u4ee5\u4e0b\u306e\u65e5\u672c\u8a9e\u30c7\u30fc\u30bf\u3067\u5168\u6587\u691c\u7d22\u3092\u8a66\u3057\u307e\u3057\u305f\u3002\n\n\u9752\u7a7a\u6587\u5eab\u306e\u66f8\u7c4d\u4e00\u89a7\u30c7\u30fc\u30bf\n\u4f4f\u6240\u30c7\u30fc\u30bf\n\u65e5\u672c\u7248Wikipedia\u306e\u30bf\u30a4\u30c8\u30eb\u4e00\u89a7\u30c7\u30fc\u30bf\n\n\npg_bigm\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\u3053\u3053\u304b\u3089pg_bigm 1.1\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u3066\u3001\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u307e\u3059\u3002\n$ tar zxf pg_bigm-1.1-20131122.tar.gz\n$ cd pg_bigm-1.1-20131122\n$ make USE_PGXS=1 PG_CONFIG=$HOME/pgsql-9.3.2/bin/pg_config\n$ make USE_PGXS=1 PG_CONFIG=$HOME/pgsql-9.3.2/bin/pg_config install\n\n\u203b\u4e0a\u8a18\u306f\u3001PostgreSQL\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u5148\u304c$HOME/pgsql-9.3.2\u306e\u524d\u63d0\u3067\u3059\u3002\n\npsql\u3067PostgreSQL\u306b\u30ed\u30b0\u30a4\u30f3\u3057\u3066\u3001pg_bigm\u3092\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306b\u767b\u9332\u3057\u307e\u3059\u3002\nCREATE EXTENSION pg_bigm;\n\n\n\u9752\u7a7a\u6587\u5eab\u306e\u66f8\u7c4d\u4e00\u89a7\u30c7\u30fc\u30bf\u306e\u691c\u7d22\n\u9752\u7a7a\u6587\u5eab\u306e\u66f8\u7c4d\u4e00\u89a7\u30c7\u30fc\u30bf(aozora_word_list_utf8.csv.gz)\u3092\u3053\u3053\u304b\u3089\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u307e\u3059\u3002\n$ cd /tmp\n$ wget http://49.212.141.170/aozora/aozora_word_list_utf8.csv.gz\n$ gunzip -d aozora_word_list_utf8.csv.gz\n\n\u66f8\u7c4d\u4e00\u89a7\u3092\u683c\u7d0d\u3059\u308b\u305f\u3081\u306e\u30c6\u30fc\u30d6\u30eb\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\nCREATE TABLE aozora (\n    \"\u4f5c\u54c1id\" text,\n    \"\u4f5c\u54c1\u540d\" text,\n    \"\u4f5c\u54c1\u540d\u8aad\u307f\" text,\n    \"\u30bd\u30fc\u30c8\u7528\u8aad\u307f\" text,\n    \"\u526f\u984c\" text,\n    \"\u526f\u984c\u8aad\u307f\" text,\n    \"\u539f\u984c\" text,\n    \"\u521d\u51fa\" text,\n    \"\u5206\u985e\u756a\u53f7\" text,\n    \"\u6587\u5b57\u9063\u3044\u7a2e\u5225\" text,\n    \"\u4f5c\u54c1\u8457\u4f5c\u6a29\u30d5\u30e9\u30b0\" text,\n    \"\u516c\u958b\u65e5\" text,\n    \"\u6700\u7d42\u66f4\u65b0\u65e5\" text,\n    \"\u56f3\u66f8\u30ab\u30fc\u30c9url\" text,\n    \"\u4eba\u7269id\" text,\n    \"\u59d3\" text,\n    \"\u540d\" text,\n    \"\u59d3\u8aad\u307f\" text,\n    \"\u540d\u8aad\u307f\" text,\n    \"\u59d3\u8aad\u307f\u30bd\u30fc\u30c8\u7528\" text,\n    \"\u540d\u8aad\u307f\u30bd\u30fc\u30c8\u7528\" text,\n    \"\u59d3\u30ed\u30fc\u30de\u5b57\" text,\n    \"\u540d\u30ed\u30fc\u30de\u5b57\" text,\n    \"\u5f79\u5272\u30d5\u30e9\u30b0\" text,\n    \"\u751f\u5e74\u6708\u65e5\" text,\n    \"\u6ca1\u5e74\u6708\u65e5\" text,\n    \"\u4eba\u7269\u8457\u4f5c\u6a29\u30d5\u30e9\u30b0\" text,\n    \"\u5e95\u672c\u540d1\" text,\n    \"\u5e95\u672c\u51fa\u7248\u793e\u540d1\" text,\n    \"\u5e95\u672c\u521d\u7248\u767a\u884c\u5e741\" text,\n    \"\u5165\u529b\u306b\u4f7f\u7528\u3057\u305f\u72481\" text,\n    \"\u6821\u6b63\u306b\u4f7f\u7528\u3057\u305f\u72481\" text,\n    \"\u5e95\u672c\u306e\u89aa\u672c\u540d1\" text,\n    \"\u5e95\u672c\u306e\u89aa\u672c\u51fa\u7248\u793e\u540d1\" text,\n    \"\u5e95\u672c\u306e\u89aa\u672c\u521d\u7248\u767a\u884c\u5e741\" text,\n    \"\u5e95\u672c\u540d2\" text,\n    \"\u5e95\u672c\u51fa\u7248\u793e\u540d2\" text,\n    \"\u5e95\u672c\u521d\u7248\u767a\u884c\u5e742\" text,\n    \"\u5165\u529b\u306b\u4f7f\u7528\u3057\u305f\u72482\" text,\n    \"\u6821\u6b63\u306b\u4f7f\u7528\u3057\u305f\u72482\" text,\n    \"\u5e95\u672c\u306e\u89aa\u672c\u540d2\" text,\n    \"\u5e95\u672c\u306e\u89aa\u672c\u51fa\u7248\u793e\u540d2\" text,\n    \"\u5e95\u672c\u306e\u89aa\u672c\u521d\u7248\u767a\u884c\u5e742\" text,\n    \"\u5165\u529b\u8005\" text,\n    \"\u6821\u6b63\u8005\" text,\n    \"\u30c6\u30ad\u30b9\u30c8\u30d5\u30a1\u30a4\u30eburl\" text,\n    \"\u30c6\u30ad\u30b9\u30c8\u30d5\u30a1\u30a4\u30eb\u6700\u7d42\u66f4\u65b0\u65e5\" text,\n    \"\u30c6\u30ad\u30b9\u30c8\u30d5\u30a1\u30a4\u30eb\u7b26\u53f7\u5316\u65b9\u5f0f\" text,\n    \"\u30c6\u30ad\u30b9\u30c8\u30d5\u30a1\u30a4\u30eb\u6587\u5b57\u96c6\u5408\" text,\n    \"\u30c6\u30ad\u30b9\u30c8\u30d5\u30a1\u30a4\u30eb\u4fee\u6b63\u56de\u6570\" text,\n    \"XHTML/HTML\u30d5\u30a1\u30a4\u30ebURL\" text,\n    \"XHTML/HTML\u30d5\u30a1\u30a4\u30eb\u6700\u7d42\u66f4\u65b0\u65e5\" text,\n    \"XHTML/HTML\u30d5\u30a1\u30a4\u30eb\u7b26\u53f7\u5316\u65b9\u5f0f\" text,\n    \"XHTML/HTML\u30d5\u30a1\u30a4\u30eb\u6587\u5b57\u96c6\u5408\" text,\n    \"XHTML/HTML\u30d5\u30a1\u30a4\u30eb\u4fee\u6b63\u56de\u6570\" text,\n    \"file\" text);\n\n\u66f8\u7c4d\u4e00\u89a7\u3092PostgreSQL\u306b\u53d6\u308a\u8fbc\u3093\u3067\u3001\u4f5c\u54c1\u540d\u306b\u5bfe\u3057\u3066pg_bigm\u306e\u5168\u6587\u691c\u7d22\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\u66f8\u7c4d\u4e00\u89a7\u306f\u3001CSV\u5f62\u5f0f\u3067\u5148\u982d\u884c\u304c\u30d8\u30c3\u30c0\u60c5\u5831\u306a\u306e\u3067\u3001\\copy\u3067\u30c7\u30fc\u30bf\u3092\u53d6\u308a\u8fbc\u3080\u969b\u306b\u306fcsv\u3068header\u30aa\u30d7\u30b7\u30e7\u30f3\u3092\u6307\u5b9a\u3057\u307e\u3059\u3002\n\\copy aozora from /tmp/aozora_word_list_utf8.csv with csv header\nCREATE INDEX aozora_title ON aozora USING gin (\"\u4f5c\u54c1\u540d\" gin_bigm_ops);\n\n\u66f8\u7c4d\u4e00\u89a7\u30c7\u30fc\u30bf\u306b\u306f\u300111,818\u4ef6\u306e\u30c7\u30fc\u30bf\u304c\u542b\u307e\u308c\u3066\u3044\u307e\u3059\u3002\nSELECT count(*) FROM aozora ;\n count \n-------\n 11818\n(1 row)\n\n\u4f5c\u54c1\u540d\u306b\u300c\u305e\u3046\u300d\u304c\u542b\u307e\u308c\u3066\u3044\u308b\u66f8\u7c4d\u306b\u3064\u3044\u3066\u4f5c\u54c1\u540d\u3001\u8457\u8005\u306e\u59d3\u3068\u540d\u3092\u691c\u7d22\u3057\u307e\u3059\u3002\u3069\u3046\u3084\u3089\u3001\u305d\u3093\u306a\u66f8\u7c4d\u304c2\u4ef6\u3042\u308b\u3088\u3046\u3067\u3059\u3002\nSELECT \"\u4f5c\u54c1\u540d\", \"\u59d3\", \"\u540d\" FROM aozora WHERE \"\u4f5c\u54c1\u540d\" LIKE likequery('\u305e\u3046');\n         \u4f5c\u54c1\u540d         |  \u59d3  |  \u540d  \n------------------------+------+------\n \u3053\u305e\u3046\u3055\u3093\u306e\u3000\u304a\u304d\u3087\u3046 | \u65b0\u7f8e | \u5357\u5409\n \u304a\u6708\u3055\u307e\u3068\u3000\u305e\u3046       | \u5c0f\u5ddd | \u672a\u660e\n(2 rows)\n\n\u5168\u6587\u691c\u7d22\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u3092\u4f7f\u3063\u305f\u691c\u7d22\u3068\u30b7\u30fc\u30b1\u30f3\u30b7\u30e3\u30eb\u306a\u691c\u7d22\u306e\u6027\u80fd\u5dee\u3092\u78ba\u8a8d\u3057\u3066\u307f\u307e\u3059\u3002\n\u307e\u305a\u306f\u5168\u6587\u691c\u7d22\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u3092\u4f7f\u3063\u305f\u5834\u5408\u3067\u3059\u300211,818\u4ef6\u304b\u30892\u4ef6\u691c\u7d22\u3059\u308b\u306e\u306b0.074 ms\u304b\u304b\u3063\u3066\u307e\u3059\u3002\nEXPLAIN ANALYZE SELECT \"\u4f5c\u54c1\u540d\", \"\u59d3\", \"\u540d\" FROM aozora WHERE \"\u4f5c\u54c1\u540d\" LIKE likequery('\u305e\u3046');\n                                                      QUERY PLAN                                                      \n----------------------------------------------------------------------------------------------------------------------\n Bitmap Heap Scan on aozora  (cost=12.01..16.02 rows=1 width=33) (actual time=0.033..0.037 rows=2 loops=1)\n   Recheck Cond: (\"\u4f5c\u54c1\u540d\" ~~ '%\u305e\u3046%'::text)\n   ->  Bitmap Index Scan on aozora_title  (cost=0.00..12.01 rows=1 width=0) (actual time=0.023..0.023 rows=2 loops=1)\n         Index Cond: (\"\u4f5c\u54c1\u540d\" ~~ '%\u305e\u3046%'::text)\n Total runtime: 0.074 ms\n(5 rows)\n\n\u6b21\u306b\u3001\u30b7\u30fc\u30b1\u30f3\u30b7\u30e3\u30eb\u30b9\u30ad\u30e3\u30f3\u3067\u691c\u7d22\u3057\u305f\u5834\u5408\u3067\u30016.673 ms\u304b\u304b\u3063\u3066\u307e\u3059\u3002\nSET enable_bitmapscan TO off;\nEXPLAIN ANALYZE SELECT \"\u4f5c\u54c1\u540d\", \"\u59d3\", \"\u540d\" FROM aozora WHERE \"\u4f5c\u54c1\u540d\" LIKE likequery('\u305e\u3046');\n                                             QUERY PLAN                                             \n----------------------------------------------------------------------------------------------------\n Seq Scan on aozora  (cost=0.00..1361.72 rows=1 width=33) (actual time=2.287..6.646 rows=2 loops=1)\n   Filter: (\"\u4f5c\u54c1\u540d\" ~~ '%\u305e\u3046%'::text)\n   Rows Removed by Filter: 11816\n Total runtime: 6.673 ms\n(4 rows)\n\nSET enable_bitmapscan TO on;\n\n\u3068\u3044\u3046\u308f\u3051\u3067\u3001pg_bigm\u306e\u5168\u6587\u691c\u7d22\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u3092\u4f7f\u3046\u3053\u3068\u3067\u3001\u5927\u5e45\u306b\u691c\u7d22\u30ec\u30b9\u30dd\u30f3\u30b9\u304c\u9ad8\u304f\u306a\u308b\u3053\u3068\u304c\u78ba\u8a8d\u3067\u304d\u307e\u3057\u305f\uff01\n\n\u4f4f\u6240\u30c7\u30fc\u30bf\u306e\u691c\u7d22\n\u65e5\u672c\u5168\u56fd\u306e\u4f4f\u6240\u30c7\u30fc\u30bf(csv_zenkoku.zip)\u3092\u3053\u3053\u304b\u3089\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u307e\u3059\u3002\n$ cd /tmp\n$ wget http://jusyo.jp/downloads/new/csv/csv_zenkoku.zip\n$ unzip csv_zenkoku.zip\n\n\u4f4f\u6240\u30c7\u30fc\u30bf\u3092\u683c\u7d0d\u3059\u308b\u305f\u3081\u306e\u30c6\u30fc\u30d6\u30eb\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\nCREATE TABLE zenkoku (\n    \"\u4f4f\u6240CD\" text,\n    \"\u90fd\u9053\u5e9c\u770cCD\" text,\n    \"\u5e02\u533a\u753a\u6751CD\" text,\n    \"\u753a\u57dfCD\" text,\n    \"\u90f5\u4fbf\u756a\u53f7\" text,\n    \"\u4e8b\u696d\u6240\u30d5\u30e9\u30b0\" text,\n    \"\u5ec3\u6b62\u30d5\u30e9\u30b0\" text,\n    \"\u90fd\u9053\u5e9c\u770c\" text,\n    \"\u90fd\u9053\u5e9c\u770c\u30ab\u30ca\" text,\n    \"\u5e02\u533a\u753a\u6751\" text,\n    \"\u5e02\u533a\u753a\u6751\u30ab\u30ca\" text,\n    \"\u753a\u57df\" text,\n    \"\u753a\u57df\u30ab\u30ca\" text,\n    \"\u753a\u57df\u88dc\u8db3\" text,\n    \"\u4eac\u90fd\u901a\u308a\u540d\" text,\n    \"\u5b57\u4e01\u76ee\" text,\n    \"\u5b57\u4e01\u76ee\u30ab\u30ca\" text,\n    \"\u88dc\u8db3\" text,\n    \"\u4e8b\u696d\u6240\u540d\" text,\n    \"\u4e8b\u696d\u6240\u540d\u30ab\u30ca\" text,\n    \"\u4e8b\u696d\u6240\u4f4f\u6240\" text,\n    \"\u65b0\u4f4f\u6240CD\" text);\n\n\u4f4f\u6240\u30c7\u30fc\u30bf\u3092PostgreSQL\u306b\u53d6\u308a\u8fbc\u3093\u3067\u3001\u5e02\u533a\u753a\u6751\u3068\u753a\u57df\u306b\u5bfe\u3057\u3066pg_bigm\u306e\u5168\u6587\u691c\u7d22\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\u4f4f\u6240\u30c7\u30fc\u30bf\u306f\u3001CSV\u5f62\u5f0f\u3067\u5148\u982d\u884c\u304c\u30d8\u30c3\u30c0\u60c5\u5831\u306a\u306e\u3067\u3001\\copy\u3067\u30c7\u30fc\u30bf\u3092\u53d6\u308a\u8fbc\u3080\u969b\u306b\u306fcsv\u3068header\u30aa\u30d7\u30b7\u30e7\u30f3\u3092\u6307\u5b9a\u3057\u307e\u3059\u3002\u307e\u305f\u3001\u4f4f\u6240\u30c7\u30fc\u30bf\u306e\u30a8\u30f3\u30b3\u30fc\u30c7\u30a3\u30f3\u30b0\u306fSJIS\u306a\u306e\u3067\u3001encoding 'sjis'\u306e\u30aa\u30d7\u30b7\u30e7\u30f3\u3082\u6307\u5b9a\u304c\u5fc5\u8981\u3067\u3059\u3002\n\\copy zenkoku from /tmp/zenkoku.csv with csv header encoding 'sjis'\nCREATE INDEX zenkoku_idx ON zenkoku USING gin (\"\u5e02\u533a\u753a\u6751\" gin_bigm_ops, \"\u753a\u57df\" gin_bigm_ops);\n\n\u4f4f\u6240\u30c7\u30fc\u30bf\u306b\u306f\u3001147,769\u4ef6\u306e\u30c7\u30fc\u30bf\u304c\u542b\u307e\u308c\u3066\u3044\u307e\u3059\u3002\nSELECT count(*) FROM zenkoku ;\n count  \n--------\n 147769\n(1 row)\n\n\u5e02\u533a\u753a\u6751\u306b\u300c\u9752\u300d\u3001\u753a\u57df\u306b\u300c\u8d64\u300d\u304c\u542b\u307e\u308c\u3066\u3044\u308b\u4f4f\u6240\u3092\u691c\u7d22\u3057\u307e\u3059\u3002\u3069\u3046\u3084\u3089\u3001\u305d\u3093\u306a\u4f4f\u6240\u304c2\u4ef6\u3042\u308b\u3088\u3046\u3067\u3059\u3002\nSELECT \"\u90fd\u9053\u5e9c\u770c\" || \"\u5e02\u533a\u753a\u6751\" || \"\u753a\u57df\" \u4f4f\u6240 from zenkoku where \"\u5e02\u533a\u753a\u6751\" like '%\u9752%' AND \"\u753a\u57df\" like '%\u8d64%';\n          \u4f4f\u6240          \n------------------------\n \u9752\u68ee\u770c\u9752\u68ee\u5e02\u8d64\u5742\n \u5bae\u57ce\u770c\u4ed9\u53f0\u5e02\u9752\u8449\u533a\u8d64\u5742\n(2 rows)\n\n\u5168\u6587\u691c\u7d22\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u3092\u4f7f\u3063\u305f\u691c\u7d22\u3068\u30b7\u30fc\u30b1\u30f3\u30b7\u30e3\u30eb\u306a\u691c\u7d22\u306e\u6027\u80fd\u5dee\u3092\u78ba\u8a8d\u3057\u3066\u307f\u307e\u3059\u3002\n\u307e\u305a\u306f\u5168\u6587\u691c\u7d22\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u3092\u4f7f\u3063\u305f\u5834\u5408\u3067\u3059\u3002147,769\u4ef6\u304b\u30892\u4ef6\u691c\u7d22\u3059\u308b\u306e\u306b0.863 ms\u304b\u304b\u3063\u3066\u307e\u3059\u3002\nEXPLAIN ANALYZE SELECT \"\u90fd\u9053\u5e9c\u770c\" || \"\u5e02\u533a\u753a\u6751\" || \"\u753a\u57df\" \u4f4f\u6240 from zenkoku where \"\u5e02\u533a\u753a\u6751\" like '%\u9752%' AND \"\u753a\u57df\" like '%\u8d64%';\n                                                     QUERY PLAN                                                      \n---------------------------------------------------------------------------------------------------------------------\n Bitmap Heap Scan on zenkoku  (cost=60.01..64.03 rows=1 width=34) (actual time=0.807..0.812 rows=2 loops=1)\n   Recheck Cond: ((\"\u5e02\u533a\u753a\u6751\" ~~ '%\u9752%'::text) AND (\"\u753a\u57df\" ~~ '%\u8d64%'::text))\n   ->  Bitmap Index Scan on zenkoku_idx  (cost=0.00..60.01 rows=1 width=0) (actual time=0.791..0.791 rows=2 loops=1)\n         Index Cond: ((\"\u5e02\u533a\u753a\u6751\" ~~ '%\u9752%'::text) AND (\"\u753a\u57df\" ~~ '%\u8d64%'::text))\n Total runtime: 0.863 ms\n(5 rows)\n\n\u6b21\u306b\u3001\u30b7\u30fc\u30b1\u30f3\u30b7\u30e3\u30eb\u30b9\u30ad\u30e3\u30f3\u3067\u691c\u7d22\u3057\u305f\u5834\u5408\u3067\u300170.684 ms\u304b\u304b\u3063\u3066\u307e\u3059\u3002\nSET enable_bitmapscan TO off;\nEXPLAIN ANALYZE SELECT \"\u90fd\u9053\u5e9c\u770c\" || \"\u5e02\u533a\u753a\u6751\" || \"\u753a\u57df\" \u4f4f\u6240 from zenkoku where \"\u5e02\u533a\u753a\u6751\" like '%\u9752%' AND \"\u753a\u57df\" like '%\u8d64%';\n                                              QUERY PLAN                                              \n------------------------------------------------------------------------------------------------------\n Seq Scan on zenkoku  (cost=0.00..5765.54 rows=1 width=34) (actual time=5.155..70.649 rows=2 loops=1)\n   Filter: ((\"\u5e02\u533a\u753a\u6751\" ~~ '%\u9752%'::text) AND (\"\u753a\u57df\" ~~ '%\u8d64%'::text))\n   Rows Removed by Filter: 147767\n Total runtime: 70.684 ms\n(4 rows)\n\nSET enable_bitmapscan TO on;\n\n\u3068\u3044\u3046\u308f\u3051\u3067\u3001\u4f4f\u6240\u30c7\u30fc\u30bf\u306b\u3064\u3044\u3066\u3082\u3001pg_bigm\u3067\u306e\u9ad8\u901f\u306a\u65e5\u672c\u8a9e\u691c\u7d22\u304c\u78ba\u8a8d\u3067\u304d\u307e\u3057\u305f\uff01\n\n\u65e5\u672c\u7248Wikipedia\u306e\u30bf\u30a4\u30c8\u30eb\u4e00\u89a7\u30c7\u30fc\u30bf\u306e\u691c\u7d22\n\u65e5\u672c\u7248Wikipedia\u306e\u30bf\u30a4\u30c8\u30eb\u4e00\u89a7\u30c7\u30fc\u30bf(jawiki-latest-all-titles.gz)\u3092\u3053\u3053\u304b\u3089\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u307e\u3059\u3002\n$ cd /tmp\n$ wget http://dumps.wikimedia.org/jawiki/latest/jawiki-latest-all-titles.gz\n$ gunzip -d jawiki-latest-all-titles.gz\n\n\u30bf\u30a4\u30c8\u30eb\u4e00\u89a7\u3092\u683c\u7d0d\u3059\u308b\u305f\u3081\u306e\u30c6\u30fc\u30d6\u30eb\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\nCREATE TABLE wikipedia_title (title text);\n\n\u30bf\u30a4\u30c8\u30eb\u4e00\u89a7\u3092PostgreSQL\u306b\u53d6\u308a\u8fbc\u3081\u308b\u3088\u3046\u306b\u3001\u30bf\u30a4\u30c8\u30eb\u6587\u5b57\u5217\u5185\u306e\u30c0\u30d6\u30eb\u30af\u30a9\u30fc\u30c8\u6587\u5b57\u3092\u30c0\u30d6\u30eb\u30af\u30a9\u30fc\u30c8\u6587\u5b57\u3067\u30a8\u30f3\u30b3\u30fc\u30c7\u30a3\u30f3\u30b0\u3057\u3001\u307e\u305f\u30bf\u30a4\u30c8\u30eb\u6587\u5b57\u5217\u306e\u5148\u982d\u3068\u672b\u5c3e\u306b\u30c0\u30d6\u30eb\u30af\u30a9\u30fc\u30c8\u6587\u5b57\u3092\u8ffd\u52a0\u3057\u307e\u3059\u3002\n$ sed s/\\\"/\\\"\\\"/g jawiki-latest-all-titles | sed s/^/\\\"/g | sed s/$/\\\"/g > jawiki-latest-all-titles.tmp\n\n\u30bf\u30a4\u30c8\u30eb\u4e00\u89a7\u3092PostgreSQL\u306b\u53d6\u308a\u8fbc\u3093\u3067\u3001title\u306b\u5bfe\u3057\u3066pg_bigm\u306e\u5168\u6587\u691c\u7d22\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\u30bf\u30a4\u30c8\u30eb\u4e00\u89a7\u306f\u3001CSV\u5f62\u5f0f\u3067\u5148\u982d\u884c\u304c\u30d8\u30c3\u30c0\u60c5\u5831\u306a\u306e\u3067\u3001\\copy\u3067\u30c7\u30fc\u30bf\u3092\u53d6\u308a\u8fbc\u3080\u969b\u306b\u306fcsv\u3068header\u30aa\u30d7\u30b7\u30e7\u30f3\u3092\u6307\u5b9a\u3057\u307e\u3059\u3002\n\\copy wikipedia_title from /tmp/jawiki-latest-all-titles.tmp csv header\nCREATE INDEX wikipedia_title_idx ON wikipedia_title USING gin (title gin_bigm_ops);\n\n\u30bf\u30a4\u30c8\u30eb\u4e00\u89a7\u306b\u306f\u30012,461,588\u4ef6\u306e\u30c7\u30fc\u30bf\u304c\u542b\u307e\u308c\u3066\u3044\u307e\u3059\u3002\nSELECT count(*) FROM wikipedia_title;\n  count  \n---------\n 2461588\n(1 row)\n\ntitle\u306b\u300c\u5168\u6587\u691c\u7d22\u300d\u304c\u542b\u307e\u308c\u3066\u3044\u308b\u30bf\u30a4\u30c8\u30eb\u3092\u691c\u7d22\u3057\u307e\u3059\u3002\u305d\u3093\u306a\u30bf\u30a4\u30c8\u30eb\u304c3\u4ef6\u3042\u308b\u3088\u3046\u3067\u3001\u540c\u3058\u30bf\u30a4\u30c8\u30eb\u304c2\u56de\u51fa\u3066\u304d\u3066\u3044\u307e\u3059\u304c\u3001\u3069\u3046\u3084\u3089\u65e5\u672c\u8a9eWikipedia\u306e\u30bf\u30a4\u30c8\u30eb\u4e00\u89a7\u306b\u306f\u540c\u3058\u30bf\u30a4\u30c8\u30eb\u3067\u8907\u6570\u56de\u73fe\u308c\u308b\u3082\u306e\u304c\u3042\u308b\u3088\u3046\u3067\u3059\u3002\nSELECT title FROM wikipedia_title WHERE title LIKE likequery('\u5168\u6587\u691c\u7d22');\n      title       \n------------------\n \u5168\u6587\u691c\u7d22\n \u5168\u6587\u691c\u7d22\u30a8\u30f3\u30b8\u30f3\n \u5168\u6587\u691c\u7d22\n(3 rows)\n\n\u5168\u6587\u691c\u7d22\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u3092\u4f7f\u3063\u305f\u691c\u7d22\u3068\u30b7\u30fc\u30b1\u30f3\u30b7\u30e3\u30eb\u306a\u691c\u7d22\u306e\u6027\u80fd\u5dee\u3092\u78ba\u8a8d\u3057\u3066\u307f\u307e\u3059\u3002\n\u307e\u305a\u306f\u5168\u6587\u691c\u7d22\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u3092\u4f7f\u3063\u305f\u5834\u5408\u3067\u3059\u30022,461,588\u4ef6\u304b\u30893\u4ef6\u691c\u7d22\u3059\u308b\u306e\u306b0.150 ms\u304b\u304b\u3063\u3066\u307e\u3059\u3002\nEXPLAIN ANALYZE SELECT title FROM wikipedia_title WHERE title LIKE likequery('\u5168\u6587\u691c\u7d22');\n                                                          QUERY PLAN                                                           \n-------------------------------------------------------------------------------------------------------------------------------\n Bitmap Heap Scan on wikipedia_title  (cost=53.90..942.57 rows=245 width=21) (actual time=0.109..0.114 rows=3 loops=1)\n   Recheck Cond: (title ~~ '%\u5168\u6587\u691c\u7d22%'::text)\n   ->  Bitmap Index Scan on wikipedia_title_idx  (cost=0.00..53.84 rows=245 width=0) (actual time=0.097..0.097 rows=3 loops=1)\n         Index Cond: (title ~~ '%\u5168\u6587\u691c\u7d22%'::text)\n Total runtime: 0.150 ms\n(5 rows)\n\n\u6b21\u306b\u3001\u30b7\u30fc\u30b1\u30f3\u30b7\u30e3\u30eb\u30b9\u30ad\u30e3\u30f3\u3067\u691c\u7d22\u3057\u305f\u5834\u5408\u3067\u3001943.450 ms\u304b\u304b\u3063\u3066\u307e\u3059\u3002\nSET enable_bitmapscan TO off;\nEXPLAIN ANALYZE SELECT title FROM wikipedia_title WHERE title LIKE likequery('\u5168\u6587\u691c\u7d22');\n                                                     QUERY PLAN                                                     \n--------------------------------------------------------------------------------------------------------------------\n Seq Scan on wikipedia_title  (cost=0.00..46768.85 rows=245 width=21) (actual time=302.481..943.421 rows=3 loops=1)\n   Filter: (title ~~ '%\u5168\u6587\u691c\u7d22%'::text)\n   Rows Removed by Filter: 2461585\n Total runtime: 943.450 ms\n(4 rows)\n\nSET enable_bitmapscan TO on;\n\n\u3068\u3044\u3046\u308f\u3051\u3067\u3001200\u4e07\u4ef6\u8d85\u306e\u30c7\u30fc\u30bf\u306b\u3064\u3044\u3066\u3082\u3001pg_bigm\u3067\u306e\u9ad8\u901f\u306a\u65e5\u672c\u8a9e\u691c\u7d22\u304c\u78ba\u8a8d\u3067\u304d\u307e\u3057\u305f\uff01\n\n\u3055\u3044\u3054\u306b\npg_bigm\u3092\u4f7f\u3046\u3053\u3068\u3067\u3001PostgreSQL\u306b\u683c\u7d0d\u3057\u305f\u6587\u66f8\u30c7\u30fc\u30bf\u3092\u9ad8\u901f\u306b\u691c\u7d22\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3059\uff01\u7c21\u5358\u306b\u5c0e\u5165\u3067\u304d\u308b\u30e2\u30b8\u30e5\u30fc\u30eb\u306a\u306e\u3067\u3001\u305c\u3072\u3001\u3044\u308d\u3093\u306a\u30c7\u30fc\u30bf\u3067\u304a\u8a66\u3057\u304f\u3060\u3055\u3044\uff01\nPostgreSQL\u306e\u5168\u6587\u691c\u7d22\u30e2\u30b8\u30e5\u30fc\u30eb[pg_bigm](http://pgbigm.sourceforge.jp/)\u306e\u6700\u65b0\u30d0\u30fc\u30b8\u30e7\u30f31.1\u304c\u30ea\u30ea\u30fc\u30b9\u3055\u308c\u307e\u3057\u305f\u3002\n\u4eca\u56de\u306f\u3001\u3053\u306e\u6700\u65b0\u30d0\u30fc\u30b8\u30e7\u30f3\u3092\u4f7f\u3063\u3066\u3001PostgreSQL\u306b\u683c\u7d0d\u3057\u305f\u69d8\u3005\u306a\u65e5\u672c\u8a9e\u30c7\u30fc\u30bf\u3092\u9ad8\u901f\u306b\u65e5\u672c\u8a9e\u691c\u7d22\u3057\u3066\u307f\u307e\u3059\uff01\n(PostgreSQL Advent Calendar 2013 [5\u65e5\u76ee\u306e\u8a18\u4e8b](http://qiita.com/adatchey/items/e41cce858e79eab1e6c4)\u3068\u5185\u5bb9\u304b\u3076\u3063\u3066\u7533\u3057\u8a33\u306a\u3044\u3067\u3059\u3002\u3002)\n\n## \u691c\u7d22\u5bfe\u8c61\u30c7\u30fc\u30bf\n\u4eca\u56de\u306f\u3001\u4ee5\u4e0b\u306e\u65e5\u672c\u8a9e\u30c7\u30fc\u30bf\u3067\u5168\u6587\u691c\u7d22\u3092\u8a66\u3057\u307e\u3057\u305f\u3002\n\n* \u9752\u7a7a\u6587\u5eab\u306e\u66f8\u7c4d\u4e00\u89a7\u30c7\u30fc\u30bf\n* \u4f4f\u6240\u30c7\u30fc\u30bf\n* \u65e5\u672c\u7248Wikipedia\u306e\u30bf\u30a4\u30c8\u30eb\u4e00\u89a7\u30c7\u30fc\u30bf\n\n## pg_bigm\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n[\u3053\u3053](http://sourceforge.jp/projects/pgbigm/downloads/59914/pg_bigm-1.1-20131122.tar.gz/)\u304b\u3089pg_bigm 1.1\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u3066\u3001\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u307e\u3059\u3002\n\n```\n$ tar zxf pg_bigm-1.1-20131122.tar.gz\n$ cd pg_bigm-1.1-20131122\n$ make USE_PGXS=1 PG_CONFIG=$HOME/pgsql-9.3.2/bin/pg_config\n$ make USE_PGXS=1 PG_CONFIG=$HOME/pgsql-9.3.2/bin/pg_config install\n\n\u203b\u4e0a\u8a18\u306f\u3001PostgreSQL\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u5148\u304c$HOME/pgsql-9.3.2\u306e\u524d\u63d0\u3067\u3059\u3002\n```\n\npsql\u3067PostgreSQL\u306b\u30ed\u30b0\u30a4\u30f3\u3057\u3066\u3001pg_bigm\u3092\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306b\u767b\u9332\u3057\u307e\u3059\u3002\n\n```\nCREATE EXTENSION pg_bigm;\n```\n\n## \u9752\u7a7a\u6587\u5eab\u306e\u66f8\u7c4d\u4e00\u89a7\u30c7\u30fc\u30bf\u306e\u691c\u7d22\n\u9752\u7a7a\u6587\u5eab\u306e\u66f8\u7c4d\u4e00\u89a7\u30c7\u30fc\u30bf(aozora_word_list_utf8.csv.gz)\u3092[\u3053\u3053](http://aozora-word.digiweb.jp/download.html)\u304b\u3089\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u307e\u3059\u3002\n\n```\n$ cd /tmp\n$ wget http://49.212.141.170/aozora/aozora_word_list_utf8.csv.gz\n$ gunzip -d aozora_word_list_utf8.csv.gz\n```\n\n\u66f8\u7c4d\u4e00\u89a7\u3092\u683c\u7d0d\u3059\u308b\u305f\u3081\u306e\u30c6\u30fc\u30d6\u30eb\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n```\nCREATE TABLE aozora (\n\t\"\u4f5c\u54c1id\" text,\n\t\"\u4f5c\u54c1\u540d\" text,\n\t\"\u4f5c\u54c1\u540d\u8aad\u307f\" text,\n\t\"\u30bd\u30fc\u30c8\u7528\u8aad\u307f\" text,\n\t\"\u526f\u984c\" text,\n\t\"\u526f\u984c\u8aad\u307f\" text,\n\t\"\u539f\u984c\" text,\n\t\"\u521d\u51fa\" text,\n\t\"\u5206\u985e\u756a\u53f7\" text,\n\t\"\u6587\u5b57\u9063\u3044\u7a2e\u5225\" text,\n\t\"\u4f5c\u54c1\u8457\u4f5c\u6a29\u30d5\u30e9\u30b0\" text,\n\t\"\u516c\u958b\u65e5\" text,\n\t\"\u6700\u7d42\u66f4\u65b0\u65e5\" text,\n\t\"\u56f3\u66f8\u30ab\u30fc\u30c9url\" text,\n\t\"\u4eba\u7269id\" text,\n\t\"\u59d3\" text,\n\t\"\u540d\" text,\n\t\"\u59d3\u8aad\u307f\" text,\n\t\"\u540d\u8aad\u307f\" text,\n\t\"\u59d3\u8aad\u307f\u30bd\u30fc\u30c8\u7528\" text,\n\t\"\u540d\u8aad\u307f\u30bd\u30fc\u30c8\u7528\" text,\n\t\"\u59d3\u30ed\u30fc\u30de\u5b57\" text,\n\t\"\u540d\u30ed\u30fc\u30de\u5b57\" text,\n\t\"\u5f79\u5272\u30d5\u30e9\u30b0\" text,\n\t\"\u751f\u5e74\u6708\u65e5\" text,\n\t\"\u6ca1\u5e74\u6708\u65e5\" text,\n\t\"\u4eba\u7269\u8457\u4f5c\u6a29\u30d5\u30e9\u30b0\" text,\n\t\"\u5e95\u672c\u540d1\" text,\n\t\"\u5e95\u672c\u51fa\u7248\u793e\u540d1\" text,\n\t\"\u5e95\u672c\u521d\u7248\u767a\u884c\u5e741\" text,\n\t\"\u5165\u529b\u306b\u4f7f\u7528\u3057\u305f\u72481\" text,\n\t\"\u6821\u6b63\u306b\u4f7f\u7528\u3057\u305f\u72481\" text,\n\t\"\u5e95\u672c\u306e\u89aa\u672c\u540d1\" text,\n\t\"\u5e95\u672c\u306e\u89aa\u672c\u51fa\u7248\u793e\u540d1\" text,\n\t\"\u5e95\u672c\u306e\u89aa\u672c\u521d\u7248\u767a\u884c\u5e741\" text,\n\t\"\u5e95\u672c\u540d2\" text,\n\t\"\u5e95\u672c\u51fa\u7248\u793e\u540d2\" text,\n\t\"\u5e95\u672c\u521d\u7248\u767a\u884c\u5e742\" text,\n\t\"\u5165\u529b\u306b\u4f7f\u7528\u3057\u305f\u72482\" text,\n\t\"\u6821\u6b63\u306b\u4f7f\u7528\u3057\u305f\u72482\" text,\n\t\"\u5e95\u672c\u306e\u89aa\u672c\u540d2\" text,\n\t\"\u5e95\u672c\u306e\u89aa\u672c\u51fa\u7248\u793e\u540d2\" text,\n\t\"\u5e95\u672c\u306e\u89aa\u672c\u521d\u7248\u767a\u884c\u5e742\" text,\n\t\"\u5165\u529b\u8005\" text,\n\t\"\u6821\u6b63\u8005\" text,\n\t\"\u30c6\u30ad\u30b9\u30c8\u30d5\u30a1\u30a4\u30eburl\" text,\n\t\"\u30c6\u30ad\u30b9\u30c8\u30d5\u30a1\u30a4\u30eb\u6700\u7d42\u66f4\u65b0\u65e5\" text,\n\t\"\u30c6\u30ad\u30b9\u30c8\u30d5\u30a1\u30a4\u30eb\u7b26\u53f7\u5316\u65b9\u5f0f\" text,\n\t\"\u30c6\u30ad\u30b9\u30c8\u30d5\u30a1\u30a4\u30eb\u6587\u5b57\u96c6\u5408\" text,\n\t\"\u30c6\u30ad\u30b9\u30c8\u30d5\u30a1\u30a4\u30eb\u4fee\u6b63\u56de\u6570\" text,\n\t\"XHTML/HTML\u30d5\u30a1\u30a4\u30ebURL\" text,\n\t\"XHTML/HTML\u30d5\u30a1\u30a4\u30eb\u6700\u7d42\u66f4\u65b0\u65e5\" text,\n\t\"XHTML/HTML\u30d5\u30a1\u30a4\u30eb\u7b26\u53f7\u5316\u65b9\u5f0f\" text,\n\t\"XHTML/HTML\u30d5\u30a1\u30a4\u30eb\u6587\u5b57\u96c6\u5408\" text,\n\t\"XHTML/HTML\u30d5\u30a1\u30a4\u30eb\u4fee\u6b63\u56de\u6570\" text,\n\t\"file\" text);\n```\n\n\u66f8\u7c4d\u4e00\u89a7\u3092PostgreSQL\u306b\u53d6\u308a\u8fbc\u3093\u3067\u3001``\u4f5c\u54c1\u540d``\u306b\u5bfe\u3057\u3066pg_bigm\u306e\u5168\u6587\u691c\u7d22\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\u66f8\u7c4d\u4e00\u89a7\u306f\u3001CSV\u5f62\u5f0f\u3067\u5148\u982d\u884c\u304c\u30d8\u30c3\u30c0\u60c5\u5831\u306a\u306e\u3067\u3001\\copy\u3067\u30c7\u30fc\u30bf\u3092\u53d6\u308a\u8fbc\u3080\u969b\u306b\u306fcsv\u3068header\u30aa\u30d7\u30b7\u30e7\u30f3\u3092\u6307\u5b9a\u3057\u307e\u3059\u3002\n\n```\n\\copy aozora from /tmp/aozora_word_list_utf8.csv with csv header\nCREATE INDEX aozora_title ON aozora USING gin (\"\u4f5c\u54c1\u540d\" gin_bigm_ops);\n```\n\n\u66f8\u7c4d\u4e00\u89a7\u30c7\u30fc\u30bf\u306b\u306f\u300111,818\u4ef6\u306e\u30c7\u30fc\u30bf\u304c\u542b\u307e\u308c\u3066\u3044\u307e\u3059\u3002\n\n```\nSELECT count(*) FROM aozora ;\n count \n-------\n 11818\n(1 row)\n```\n\n``\u4f5c\u54c1\u540d``\u306b\u300c\u305e\u3046\u300d\u304c\u542b\u307e\u308c\u3066\u3044\u308b\u66f8\u7c4d\u306b\u3064\u3044\u3066``\u4f5c\u54c1\u540d``\u3001\u8457\u8005\u306e``\u59d3``\u3068``\u540d``\u3092\u691c\u7d22\u3057\u307e\u3059\u3002\u3069\u3046\u3084\u3089\u3001\u305d\u3093\u306a\u66f8\u7c4d\u304c2\u4ef6\u3042\u308b\u3088\u3046\u3067\u3059\u3002\n\n```\nSELECT \"\u4f5c\u54c1\u540d\", \"\u59d3\", \"\u540d\" FROM aozora WHERE \"\u4f5c\u54c1\u540d\" LIKE likequery('\u305e\u3046');\n         \u4f5c\u54c1\u540d         |  \u59d3  |  \u540d  \n------------------------+------+------\n \u3053\u305e\u3046\u3055\u3093\u306e\u3000\u304a\u304d\u3087\u3046 | \u65b0\u7f8e | \u5357\u5409\n \u304a\u6708\u3055\u307e\u3068\u3000\u305e\u3046       | \u5c0f\u5ddd | \u672a\u660e\n(2 rows)\n```\n\n\u5168\u6587\u691c\u7d22\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u3092\u4f7f\u3063\u305f\u691c\u7d22\u3068\u30b7\u30fc\u30b1\u30f3\u30b7\u30e3\u30eb\u306a\u691c\u7d22\u306e\u6027\u80fd\u5dee\u3092\u78ba\u8a8d\u3057\u3066\u307f\u307e\u3059\u3002\n\n\u307e\u305a\u306f\u5168\u6587\u691c\u7d22\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u3092\u4f7f\u3063\u305f\u5834\u5408\u3067\u3059\u300211,818\u4ef6\u304b\u30892\u4ef6\u691c\u7d22\u3059\u308b\u306e\u306b0.074 ms\u304b\u304b\u3063\u3066\u307e\u3059\u3002\n\n```\nEXPLAIN ANALYZE SELECT \"\u4f5c\u54c1\u540d\", \"\u59d3\", \"\u540d\" FROM aozora WHERE \"\u4f5c\u54c1\u540d\" LIKE likequery('\u305e\u3046');\n                                                      QUERY PLAN                                                      \n----------------------------------------------------------------------------------------------------------------------\n Bitmap Heap Scan on aozora  (cost=12.01..16.02 rows=1 width=33) (actual time=0.033..0.037 rows=2 loops=1)\n   Recheck Cond: (\"\u4f5c\u54c1\u540d\" ~~ '%\u305e\u3046%'::text)\n   ->  Bitmap Index Scan on aozora_title  (cost=0.00..12.01 rows=1 width=0) (actual time=0.023..0.023 rows=2 loops=1)\n         Index Cond: (\"\u4f5c\u54c1\u540d\" ~~ '%\u305e\u3046%'::text)\n Total runtime: 0.074 ms\n(5 rows)\n```\n\n\u6b21\u306b\u3001\u30b7\u30fc\u30b1\u30f3\u30b7\u30e3\u30eb\u30b9\u30ad\u30e3\u30f3\u3067\u691c\u7d22\u3057\u305f\u5834\u5408\u3067\u30016.673 ms\u304b\u304b\u3063\u3066\u307e\u3059\u3002\n\n```\nSET enable_bitmapscan TO off;\nEXPLAIN ANALYZE SELECT \"\u4f5c\u54c1\u540d\", \"\u59d3\", \"\u540d\" FROM aozora WHERE \"\u4f5c\u54c1\u540d\" LIKE likequery('\u305e\u3046');\n                                             QUERY PLAN                                             \n----------------------------------------------------------------------------------------------------\n Seq Scan on aozora  (cost=0.00..1361.72 rows=1 width=33) (actual time=2.287..6.646 rows=2 loops=1)\n   Filter: (\"\u4f5c\u54c1\u540d\" ~~ '%\u305e\u3046%'::text)\n   Rows Removed by Filter: 11816\n Total runtime: 6.673 ms\n(4 rows)\n\nSET enable_bitmapscan TO on;\n```\n\n\u3068\u3044\u3046\u308f\u3051\u3067\u3001pg_bigm\u306e\u5168\u6587\u691c\u7d22\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u3092\u4f7f\u3046\u3053\u3068\u3067\u3001\u5927\u5e45\u306b\u691c\u7d22\u30ec\u30b9\u30dd\u30f3\u30b9\u304c\u9ad8\u304f\u306a\u308b\u3053\u3068\u304c\u78ba\u8a8d\u3067\u304d\u307e\u3057\u305f\uff01\n\n## \u4f4f\u6240\u30c7\u30fc\u30bf\u306e\u691c\u7d22\n\u65e5\u672c\u5168\u56fd\u306e\u4f4f\u6240\u30c7\u30fc\u30bf(csv_zenkoku.zip)\u3092[\u3053\u3053](jusyo.jp/csv/new.php)\u304b\u3089\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u307e\u3059\u3002\n\n```\n$ cd /tmp\n$ wget http://jusyo.jp/downloads/new/csv/csv_zenkoku.zip\n$ unzip csv_zenkoku.zip\n```\n\n\u4f4f\u6240\u30c7\u30fc\u30bf\u3092\u683c\u7d0d\u3059\u308b\u305f\u3081\u306e\u30c6\u30fc\u30d6\u30eb\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n```\nCREATE TABLE zenkoku (\n\t\"\u4f4f\u6240CD\" text,\n\t\"\u90fd\u9053\u5e9c\u770cCD\" text,\n\t\"\u5e02\u533a\u753a\u6751CD\" text,\n\t\"\u753a\u57dfCD\" text,\n\t\"\u90f5\u4fbf\u756a\u53f7\" text,\n\t\"\u4e8b\u696d\u6240\u30d5\u30e9\u30b0\" text,\n\t\"\u5ec3\u6b62\u30d5\u30e9\u30b0\" text,\n\t\"\u90fd\u9053\u5e9c\u770c\" text,\n\t\"\u90fd\u9053\u5e9c\u770c\u30ab\u30ca\" text,\n\t\"\u5e02\u533a\u753a\u6751\" text,\n\t\"\u5e02\u533a\u753a\u6751\u30ab\u30ca\" text,\n\t\"\u753a\u57df\" text,\n\t\"\u753a\u57df\u30ab\u30ca\" text,\n\t\"\u753a\u57df\u88dc\u8db3\" text,\n\t\"\u4eac\u90fd\u901a\u308a\u540d\" text,\n\t\"\u5b57\u4e01\u76ee\" text,\n\t\"\u5b57\u4e01\u76ee\u30ab\u30ca\" text,\n\t\"\u88dc\u8db3\" text,\n\t\"\u4e8b\u696d\u6240\u540d\" text,\n\t\"\u4e8b\u696d\u6240\u540d\u30ab\u30ca\" text,\n\t\"\u4e8b\u696d\u6240\u4f4f\u6240\" text,\n\t\"\u65b0\u4f4f\u6240CD\" text);\n```\n\n\u4f4f\u6240\u30c7\u30fc\u30bf\u3092PostgreSQL\u306b\u53d6\u308a\u8fbc\u3093\u3067\u3001``\u5e02\u533a\u753a\u6751``\u3068``\u753a\u57df``\u306b\u5bfe\u3057\u3066pg_bigm\u306e\u5168\u6587\u691c\u7d22\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\u4f4f\u6240\u30c7\u30fc\u30bf\u306f\u3001CSV\u5f62\u5f0f\u3067\u5148\u982d\u884c\u304c\u30d8\u30c3\u30c0\u60c5\u5831\u306a\u306e\u3067\u3001\\copy\u3067\u30c7\u30fc\u30bf\u3092\u53d6\u308a\u8fbc\u3080\u969b\u306b\u306fcsv\u3068header\u30aa\u30d7\u30b7\u30e7\u30f3\u3092\u6307\u5b9a\u3057\u307e\u3059\u3002\u307e\u305f\u3001\u4f4f\u6240\u30c7\u30fc\u30bf\u306e\u30a8\u30f3\u30b3\u30fc\u30c7\u30a3\u30f3\u30b0\u306fSJIS\u306a\u306e\u3067\u3001encoding 'sjis'\u306e\u30aa\u30d7\u30b7\u30e7\u30f3\u3082\u6307\u5b9a\u304c\u5fc5\u8981\u3067\u3059\u3002\n\n```\n\\copy zenkoku from /tmp/zenkoku.csv with csv header encoding 'sjis'\nCREATE INDEX zenkoku_idx ON zenkoku USING gin (\"\u5e02\u533a\u753a\u6751\" gin_bigm_ops, \"\u753a\u57df\" gin_bigm_ops);\n```\n\n\u4f4f\u6240\u30c7\u30fc\u30bf\u306b\u306f\u3001147,769\u4ef6\u306e\u30c7\u30fc\u30bf\u304c\u542b\u307e\u308c\u3066\u3044\u307e\u3059\u3002\n\n```\nSELECT count(*) FROM zenkoku ;\n count  \n--------\n 147769\n(1 row)\n```\n\n``\u5e02\u533a\u753a\u6751``\u306b\u300c\u9752\u300d\u3001``\u753a\u57df``\u306b\u300c\u8d64\u300d\u304c\u542b\u307e\u308c\u3066\u3044\u308b\u4f4f\u6240\u3092\u691c\u7d22\u3057\u307e\u3059\u3002\u3069\u3046\u3084\u3089\u3001\u305d\u3093\u306a\u4f4f\u6240\u304c2\u4ef6\u3042\u308b\u3088\u3046\u3067\u3059\u3002\n\n```\nSELECT \"\u90fd\u9053\u5e9c\u770c\" || \"\u5e02\u533a\u753a\u6751\" || \"\u753a\u57df\" \u4f4f\u6240 from zenkoku where \"\u5e02\u533a\u753a\u6751\" like '%\u9752%' AND \"\u753a\u57df\" like '%\u8d64%';\n          \u4f4f\u6240          \n------------------------\n \u9752\u68ee\u770c\u9752\u68ee\u5e02\u8d64\u5742\n \u5bae\u57ce\u770c\u4ed9\u53f0\u5e02\u9752\u8449\u533a\u8d64\u5742\n(2 rows)\n```\n\n\u5168\u6587\u691c\u7d22\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u3092\u4f7f\u3063\u305f\u691c\u7d22\u3068\u30b7\u30fc\u30b1\u30f3\u30b7\u30e3\u30eb\u306a\u691c\u7d22\u306e\u6027\u80fd\u5dee\u3092\u78ba\u8a8d\u3057\u3066\u307f\u307e\u3059\u3002\n\n\u307e\u305a\u306f\u5168\u6587\u691c\u7d22\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u3092\u4f7f\u3063\u305f\u5834\u5408\u3067\u3059\u3002147,769\u4ef6\u304b\u30892\u4ef6\u691c\u7d22\u3059\u308b\u306e\u306b0.863 ms\u304b\u304b\u3063\u3066\u307e\u3059\u3002\n\n```\nEXPLAIN ANALYZE SELECT \"\u90fd\u9053\u5e9c\u770c\" || \"\u5e02\u533a\u753a\u6751\" || \"\u753a\u57df\" \u4f4f\u6240 from zenkoku where \"\u5e02\u533a\u753a\u6751\" like '%\u9752%' AND \"\u753a\u57df\" like '%\u8d64%';\n                                                     QUERY PLAN                                                      \n---------------------------------------------------------------------------------------------------------------------\n Bitmap Heap Scan on zenkoku  (cost=60.01..64.03 rows=1 width=34) (actual time=0.807..0.812 rows=2 loops=1)\n   Recheck Cond: ((\"\u5e02\u533a\u753a\u6751\" ~~ '%\u9752%'::text) AND (\"\u753a\u57df\" ~~ '%\u8d64%'::text))\n   ->  Bitmap Index Scan on zenkoku_idx  (cost=0.00..60.01 rows=1 width=0) (actual time=0.791..0.791 rows=2 loops=1)\n         Index Cond: ((\"\u5e02\u533a\u753a\u6751\" ~~ '%\u9752%'::text) AND (\"\u753a\u57df\" ~~ '%\u8d64%'::text))\n Total runtime: 0.863 ms\n(5 rows)\n```\n\n\u6b21\u306b\u3001\u30b7\u30fc\u30b1\u30f3\u30b7\u30e3\u30eb\u30b9\u30ad\u30e3\u30f3\u3067\u691c\u7d22\u3057\u305f\u5834\u5408\u3067\u300170.684 ms\u304b\u304b\u3063\u3066\u307e\u3059\u3002\n\n```\nSET enable_bitmapscan TO off;\nEXPLAIN ANALYZE SELECT \"\u90fd\u9053\u5e9c\u770c\" || \"\u5e02\u533a\u753a\u6751\" || \"\u753a\u57df\" \u4f4f\u6240 from zenkoku where \"\u5e02\u533a\u753a\u6751\" like '%\u9752%' AND \"\u753a\u57df\" like '%\u8d64%';\n                                              QUERY PLAN                                              \n------------------------------------------------------------------------------------------------------\n Seq Scan on zenkoku  (cost=0.00..5765.54 rows=1 width=34) (actual time=5.155..70.649 rows=2 loops=1)\n   Filter: ((\"\u5e02\u533a\u753a\u6751\" ~~ '%\u9752%'::text) AND (\"\u753a\u57df\" ~~ '%\u8d64%'::text))\n   Rows Removed by Filter: 147767\n Total runtime: 70.684 ms\n(4 rows)\n\nSET enable_bitmapscan TO on;\n```\n\n\u3068\u3044\u3046\u308f\u3051\u3067\u3001\u4f4f\u6240\u30c7\u30fc\u30bf\u306b\u3064\u3044\u3066\u3082\u3001pg_bigm\u3067\u306e\u9ad8\u901f\u306a\u65e5\u672c\u8a9e\u691c\u7d22\u304c\u78ba\u8a8d\u3067\u304d\u307e\u3057\u305f\uff01\n\n## \u65e5\u672c\u7248Wikipedia\u306e\u30bf\u30a4\u30c8\u30eb\u4e00\u89a7\u30c7\u30fc\u30bf\u306e\u691c\u7d22\n\u65e5\u672c\u7248Wikipedia\u306e\u30bf\u30a4\u30c8\u30eb\u4e00\u89a7\u30c7\u30fc\u30bf(jawiki-latest-all-titles.gz)\u3092[\u3053\u3053](http://dumps.wikimedia.org/jawiki/latest/)\u304b\u3089\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u307e\u3059\u3002\n\n```\n$ cd /tmp\n$ wget http://dumps.wikimedia.org/jawiki/latest/jawiki-latest-all-titles.gz\n$ gunzip -d jawiki-latest-all-titles.gz\n```\n\n\u30bf\u30a4\u30c8\u30eb\u4e00\u89a7\u3092\u683c\u7d0d\u3059\u308b\u305f\u3081\u306e\u30c6\u30fc\u30d6\u30eb\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n```\nCREATE TABLE wikipedia_title (title text);\n```\n\n\u30bf\u30a4\u30c8\u30eb\u4e00\u89a7\u3092PostgreSQL\u306b\u53d6\u308a\u8fbc\u3081\u308b\u3088\u3046\u306b\u3001\u30bf\u30a4\u30c8\u30eb\u6587\u5b57\u5217\u5185\u306e\u30c0\u30d6\u30eb\u30af\u30a9\u30fc\u30c8\u6587\u5b57\u3092\u30c0\u30d6\u30eb\u30af\u30a9\u30fc\u30c8\u6587\u5b57\u3067\u30a8\u30f3\u30b3\u30fc\u30c7\u30a3\u30f3\u30b0\u3057\u3001\u307e\u305f\u30bf\u30a4\u30c8\u30eb\u6587\u5b57\u5217\u306e\u5148\u982d\u3068\u672b\u5c3e\u306b\u30c0\u30d6\u30eb\u30af\u30a9\u30fc\u30c8\u6587\u5b57\u3092\u8ffd\u52a0\u3057\u307e\u3059\u3002\n\n```\n$ sed s/\\\"/\\\"\\\"/g jawiki-latest-all-titles | sed s/^/\\\"/g | sed s/$/\\\"/g > jawiki-latest-all-titles.tmp\n```\n\n\u30bf\u30a4\u30c8\u30eb\u4e00\u89a7\u3092PostgreSQL\u306b\u53d6\u308a\u8fbc\u3093\u3067\u3001``title``\u306b\u5bfe\u3057\u3066pg_bigm\u306e\u5168\u6587\u691c\u7d22\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\u30bf\u30a4\u30c8\u30eb\u4e00\u89a7\u306f\u3001CSV\u5f62\u5f0f\u3067\u5148\u982d\u884c\u304c\u30d8\u30c3\u30c0\u60c5\u5831\u306a\u306e\u3067\u3001\\copy\u3067\u30c7\u30fc\u30bf\u3092\u53d6\u308a\u8fbc\u3080\u969b\u306b\u306fcsv\u3068header\u30aa\u30d7\u30b7\u30e7\u30f3\u3092\u6307\u5b9a\u3057\u307e\u3059\u3002\n\n```\n\\copy wikipedia_title from /tmp/jawiki-latest-all-titles.tmp csv header\nCREATE INDEX wikipedia_title_idx ON wikipedia_title USING gin (title gin_bigm_ops);\n```\n\n\u30bf\u30a4\u30c8\u30eb\u4e00\u89a7\u306b\u306f\u30012,461,588\u4ef6\u306e\u30c7\u30fc\u30bf\u304c\u542b\u307e\u308c\u3066\u3044\u307e\u3059\u3002\n\n```\nSELECT count(*) FROM wikipedia_title;\n  count  \n---------\n 2461588\n(1 row)\n```\n\n``title``\u306b\u300c\u5168\u6587\u691c\u7d22\u300d\u304c\u542b\u307e\u308c\u3066\u3044\u308b\u30bf\u30a4\u30c8\u30eb\u3092\u691c\u7d22\u3057\u307e\u3059\u3002\u305d\u3093\u306a\u30bf\u30a4\u30c8\u30eb\u304c3\u4ef6\u3042\u308b\u3088\u3046\u3067\u3001\u540c\u3058\u30bf\u30a4\u30c8\u30eb\u304c2\u56de\u51fa\u3066\u304d\u3066\u3044\u307e\u3059\u304c\u3001\u3069\u3046\u3084\u3089\u65e5\u672c\u8a9eWikipedia\u306e\u30bf\u30a4\u30c8\u30eb\u4e00\u89a7\u306b\u306f\u540c\u3058\u30bf\u30a4\u30c8\u30eb\u3067\u8907\u6570\u56de\u73fe\u308c\u308b\u3082\u306e\u304c\u3042\u308b\u3088\u3046\u3067\u3059\u3002\n\n```\nSELECT title FROM wikipedia_title WHERE title LIKE likequery('\u5168\u6587\u691c\u7d22');\n      title       \n------------------\n \u5168\u6587\u691c\u7d22\n \u5168\u6587\u691c\u7d22\u30a8\u30f3\u30b8\u30f3\n \u5168\u6587\u691c\u7d22\n(3 rows)\n```\n\n\u5168\u6587\u691c\u7d22\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u3092\u4f7f\u3063\u305f\u691c\u7d22\u3068\u30b7\u30fc\u30b1\u30f3\u30b7\u30e3\u30eb\u306a\u691c\u7d22\u306e\u6027\u80fd\u5dee\u3092\u78ba\u8a8d\u3057\u3066\u307f\u307e\u3059\u3002\n\n\u307e\u305a\u306f\u5168\u6587\u691c\u7d22\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u3092\u4f7f\u3063\u305f\u5834\u5408\u3067\u3059\u30022,461,588\u4ef6\u304b\u30893\u4ef6\u691c\u7d22\u3059\u308b\u306e\u306b0.150 ms\u304b\u304b\u3063\u3066\u307e\u3059\u3002\n\n```\nEXPLAIN ANALYZE SELECT title FROM wikipedia_title WHERE title LIKE likequery('\u5168\u6587\u691c\u7d22');\n                                                          QUERY PLAN                                                           \n-------------------------------------------------------------------------------------------------------------------------------\n Bitmap Heap Scan on wikipedia_title  (cost=53.90..942.57 rows=245 width=21) (actual time=0.109..0.114 rows=3 loops=1)\n   Recheck Cond: (title ~~ '%\u5168\u6587\u691c\u7d22%'::text)\n   ->  Bitmap Index Scan on wikipedia_title_idx  (cost=0.00..53.84 rows=245 width=0) (actual time=0.097..0.097 rows=3 loops=1)\n         Index Cond: (title ~~ '%\u5168\u6587\u691c\u7d22%'::text)\n Total runtime: 0.150 ms\n(5 rows)\n```\n\n\u6b21\u306b\u3001\u30b7\u30fc\u30b1\u30f3\u30b7\u30e3\u30eb\u30b9\u30ad\u30e3\u30f3\u3067\u691c\u7d22\u3057\u305f\u5834\u5408\u3067\u3001943.450 ms\u304b\u304b\u3063\u3066\u307e\u3059\u3002\n\n```\nSET enable_bitmapscan TO off;\nEXPLAIN ANALYZE SELECT title FROM wikipedia_title WHERE title LIKE likequery('\u5168\u6587\u691c\u7d22');\n                                                     QUERY PLAN                                                     \n--------------------------------------------------------------------------------------------------------------------\n Seq Scan on wikipedia_title  (cost=0.00..46768.85 rows=245 width=21) (actual time=302.481..943.421 rows=3 loops=1)\n   Filter: (title ~~ '%\u5168\u6587\u691c\u7d22%'::text)\n   Rows Removed by Filter: 2461585\n Total runtime: 943.450 ms\n(4 rows)\n\nSET enable_bitmapscan TO on;\n```\n\n\u3068\u3044\u3046\u308f\u3051\u3067\u3001200\u4e07\u4ef6\u8d85\u306e\u30c7\u30fc\u30bf\u306b\u3064\u3044\u3066\u3082\u3001pg_bigm\u3067\u306e\u9ad8\u901f\u306a\u65e5\u672c\u8a9e\u691c\u7d22\u304c\u78ba\u8a8d\u3067\u304d\u307e\u3057\u305f\uff01\n\n## \u3055\u3044\u3054\u306b\npg_bigm\u3092\u4f7f\u3046\u3053\u3068\u3067\u3001PostgreSQL\u306b\u683c\u7d0d\u3057\u305f\u6587\u66f8\u30c7\u30fc\u30bf\u3092\u9ad8\u901f\u306b\u691c\u7d22\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3059\uff01\u7c21\u5358\u306b\u5c0e\u5165\u3067\u304d\u308b\u30e2\u30b8\u30e5\u30fc\u30eb\u306a\u306e\u3067\u3001\u305c\u3072\u3001\u3044\u308d\u3093\u306a\u30c7\u30fc\u30bf\u3067\u304a\u8a66\u3057\u304f\u3060\u3055\u3044\uff01\n", "tags": ["PostgreSQL", "pg_bigm", "\u5168\u6587\u691c\u7d22"]}