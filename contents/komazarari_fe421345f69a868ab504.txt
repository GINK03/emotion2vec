{"context": "\n\n\u3084\u308a\u305f\u3044\u3053\u3068\n\u81ea\u4f5c\u306e Web UI \u304b\u3089\u30dd\u30c1\u3063\u3068\u3057\u3066 Jenkins job \u3092\u8d77\u52d5\u3057\u3001\u975e\u540c\u671f\u3067\u5b9f\u884c\u7d50\u679c\u304c\u307b\u3057\u3044\n\n\u3084\u308a\u304b\u305f\n\nJenkins \u306e CORS \u8a31\u53ef\nCORS Filter Plugin \u3092\u5165\u308c\u308b\n\u81ea\u30c9\u30e1\u30a4\u30f3\u304b\u3089 Ajax \u3067 Jenkins API \u3092\u53e9\u3044\u3066\u7d50\u679c\u3092\u3082\u3089\u3044\u305f\u3044\u306e\u3067\u3001Jenkins \u306b CORS \u3092\u8a31\u53ef\u3059\u308b\u3088\u3046\u8a2d\u5b9a\u3059\u308b\u3002\n\nAccess-Control-Allow-Origins: \u81ea\u5206\u306e\u30c9\u30e1\u30a4\u30f3 + (\u30c6\u30b9\u30c8\u7528\u306b localhost\u7b49)\nAccess-Control-Allow-Methods: GET\nAccess-Control-Allow-Headers: \u3068\u304f\u306b\u306a\u3057\nAccess-Control-Expose-Headers: Location\n\n\u304c\u6700\u4f4e\u9650\u5fc5\u8981\u306b\u306a\u308a\u305d\u3046\n\n\u30d3\u30eb\u30c9 URL \u3092\u53e9\u304f\n\u53e9\u3044\u3066 Polling \u3059\u308b\u2026\n\u30d3\u30eb\u30c9\u3092\u30c8\u30ea\u30ac\u30fc\u3059\u308b URL \u306b\u3064\u3044\u3066\u306f\u904e\u53bb\u8a18\u4e8b\u306a\u3069\u53c2\u7167\u3002\n\njQuery \u306e\u4f8b\n$.ajax({\n  type: 'GET',\n  url: 'https://myjenkins.example.com/job/myjob/buildWithParameters',\n  data: { foo: 'bar', hoge: 'fuga' },\n  success: function(_d, _t, xhr) {\n    var queueUrl = xhr.getResponseHeader('Location');\n    var queueId = setInterval(function() {\n      console.log(\"Start queue polling\");\n      $.ajax({\n        url: `${queueUrl}api/json`,\n        dataType: 'json',\n        success: function(data) {\n          if (data.executable) {\n            clearInterval(queueId);\n\n            var jobWaitId = setInterval(function() {\n              console.log(\"Start job polling\");\n              $.ajax({\n                url: `${data.executable.url}api/json`,\n                dataType: 'json',\n                success: function(data) {\n                  if (data.result) {\n                    console.log('Job finished ! result: ', data.result);\n                    clearInterval(jobWaitId);\n                  }\n                }\n              })\n            }, 1000);\n          }\n        },\n        error: function(xhr, st, err) {}\n      });\n    }, 1000)\n  },\n  error: function(xhr, st, err) {}\n})\n\n\n\nes6 & whatwg fetch \u306e\u4f8b\nfetch('https://myjenkins.example.com/job/myjob/buildWithParameters/?foo=bar&hoge=fuga')\n  .then(res => {\n    const queueUrl = `${res.headers.get('Location')}/api/json`;\n    const queueId = setInterval(() => {\n      console.log(\"Start queue polling\");\n      fetch(queueUrl)\n        .then(res => res.json())\n        .then(json => {\n          if (json.executable) {\n            clearInterval(queueId);\n\n            const jobWaitId = setInterval(() => {\n              console.log(\"Start job polling\");\n              fetch(`${json.executable.url}/api/json`)\n                .then(res => res.json())\n                .then(json => {\n                  if (json.result) {\n                    console.log('Job finished ! result: ', data.result);\n                    clearInterval(jobWaitId);\n                  }\n                })\n            }, 1000);\n          }\n        })\n    }, 1000);\n  })\n\n\n\u4ed5\u7d44\u307f\nJenkins \u306e\u30d3\u30eb\u30c9 URL \u3092\u53e9\u304f\u3068\u3001\u30ec\u30b9\u30dd\u30f3\u30b9\u30d8\u30c3\u30c0\u306e Location \u306b\u30ad\u30e5\u30fc\u306e URL \u304c\u5165\u3063\u3066\u304f\u308b\u3002\nhttps://issues.jenkins-ci.org/browse/JENKINS-30317\nCORS \u6709\u52b9\u306b\u3057\u306a\u3044\u3068\u3053\u306e\u30ec\u30b9\u30dd\u30f3\u30b9\u30d8\u30c3\u30c0\u304c\u3068\u308c\u306a\u3044\u3002\nJenkins \u306f URL \u306e\u304a\u3057\u308a\u306b /api/<format> \u306e\u3088\u3046\u306b\u3057\u3066\u30c7\u30fc\u30bf\u304c\u53d6\u308c\u308b\u3002\n\u3053\u306e\u30ad\u30e5\u30fc URL \u3092\u3057\u3070\u3089\u304f\u898b\u3066\u3044\u308b\u3068\u3001\u30d3\u30eb\u30c9\u3092\u30c8\u30ea\u30ac\u30fc\u3057\u305f\u76f4\u5f8c\u306f Quiet Period \u3068\u306a\u3063\u3066\u304a\u308a\u3001job \u5b9f\u884c\u5f85\u3061\u306e\u72b6\u614b\u3060\u304c\u3001\u3057\u3070\u3089\u304f\u5f85\u3064\u3068 executable.url \u306b\u5b9f\u884c job \u306e URL \u304c\u5165\u3063\u3066\u304f\u308b\u3002\n\u3055\u3089\u306b\u305d\u306e job URL \u306e\u5b9f\u884c\u72b6\u614b\u3092\u30c1\u30a7\u30c3\u30af\u3057\u306a\u304c\u3089\u3001job \u304c\u5b8c\u4e86\u3059\u308b\u3068 result \u304c\u53d6\u5f97\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u308b\u306e\u3067\u305d\u308c\u3092\u5f85\u3064\u3002\n\u308f\u308a\u3068\u3081\u3093\u3069\u304f\u3055\u3044  \n# \u3084\u308a\u305f\u3044\u3053\u3068\n\n\u81ea\u4f5c\u306e Web UI \u304b\u3089\u30dd\u30c1\u3063\u3068\u3057\u3066 Jenkins job \u3092\u8d77\u52d5\u3057\u3001\u975e\u540c\u671f\u3067\u5b9f\u884c\u7d50\u679c\u304c\u307b\u3057\u3044\n\n# \u3084\u308a\u304b\u305f\n## Jenkins \u306e CORS \u8a31\u53ef\n**[CORS Filter Plugin](https://wiki.jenkins-ci.org/display/JENKINS/Cors+Filter+Plugin) \u3092\u5165\u308c\u308b**\n\n\u81ea\u30c9\u30e1\u30a4\u30f3\u304b\u3089 Ajax \u3067 Jenkins API \u3092\u53e9\u3044\u3066\u7d50\u679c\u3092\u3082\u3089\u3044\u305f\u3044\u306e\u3067\u3001Jenkins \u306b CORS \u3092\u8a31\u53ef\u3059\u308b\u3088\u3046\u8a2d\u5b9a\u3059\u308b\u3002\n\n- Access-Control-Allow-Origins: \u81ea\u5206\u306e\u30c9\u30e1\u30a4\u30f3 + (\u30c6\u30b9\u30c8\u7528\u306b localhost\u7b49)\n- Access-Control-Allow-Methods: GET\n- Access-Control-Allow-Headers: \u3068\u304f\u306b\u306a\u3057\n- Access-Control-Expose-Headers: Location\n\n\u304c\u6700\u4f4e\u9650\u5fc5\u8981\u306b\u306a\u308a\u305d\u3046\n\n## \u30d3\u30eb\u30c9 URL \u3092\u53e9\u304f\n\u53e9\u3044\u3066 Polling \u3059\u308b\u2026\n\n\u30d3\u30eb\u30c9\u3092\u30c8\u30ea\u30ac\u30fc\u3059\u308b URL \u306b\u3064\u3044\u3066\u306f[\u904e\u53bb\u8a18\u4e8b](http://qiita.com/komazarari/items/58f512cac8a9e4de554c)\u306a\u3069\u53c2\u7167\u3002\n\n### jQuery \u306e\u4f8b\n\n```js\n$.ajax({\n  type: 'GET',\n  url: 'https://myjenkins.example.com/job/myjob/buildWithParameters',\n  data: { foo: 'bar', hoge: 'fuga' },\n  success: function(_d, _t, xhr) {\n    var queueUrl = xhr.getResponseHeader('Location');\n    var queueId = setInterval(function() {\n      console.log(\"Start queue polling\");\n      $.ajax({\n        url: `${queueUrl}api/json`,\n        dataType: 'json',\n        success: function(data) {\n          if (data.executable) {\n            clearInterval(queueId);\n\n            var jobWaitId = setInterval(function() {\n              console.log(\"Start job polling\");\n              $.ajax({\n                url: `${data.executable.url}api/json`,\n                dataType: 'json',\n                success: function(data) {\n                  if (data.result) {\n                    console.log('Job finished ! result: ', data.result);\n                    clearInterval(jobWaitId);\n                  }\n                }\n              })\n            }, 1000);\n          }\n        },\n        error: function(xhr, st, err) {}\n      });\n    }, 1000)\n  },\n  error: function(xhr, st, err) {}\n})\n      \n``` \n\n### es6 & whatwg fetch \u306e\u4f8b\n\n```js\nfetch('https://myjenkins.example.com/job/myjob/buildWithParameters/?foo=bar&hoge=fuga')\n  .then(res => {\n    const queueUrl = `${res.headers.get('Location')}/api/json`;\n    const queueId = setInterval(() => {\n      console.log(\"Start queue polling\");\n      fetch(queueUrl)\n        .then(res => res.json())\n        .then(json => {\n          if (json.executable) {\n            clearInterval(queueId);\n\n            const jobWaitId = setInterval(() => {\n              console.log(\"Start job polling\");\n              fetch(`${json.executable.url}/api/json`)\n                .then(res => res.json())\n                .then(json => {\n                  if (json.result) {\n                    console.log('Job finished ! result: ', data.result);\n                    clearInterval(jobWaitId);\n                  }\n                })\n            }, 1000);\n          }\n        })\n    }, 1000);\n  })\n```\n\n# \u4ed5\u7d44\u307f\n\nJenkins \u306e\u30d3\u30eb\u30c9 URL \u3092\u53e9\u304f\u3068\u3001\u30ec\u30b9\u30dd\u30f3\u30b9\u30d8\u30c3\u30c0\u306e `Location` \u306b\u30ad\u30e5\u30fc\u306e URL \u304c\u5165\u3063\u3066\u304f\u308b\u3002\nhttps://issues.jenkins-ci.org/browse/JENKINS-30317\nCORS \u6709\u52b9\u306b\u3057\u306a\u3044\u3068\u3053\u306e\u30ec\u30b9\u30dd\u30f3\u30b9\u30d8\u30c3\u30c0\u304c\u3068\u308c\u306a\u3044\u3002\n\nJenkins \u306f URL \u306e\u304a\u3057\u308a\u306b `/api/<format>` \u306e\u3088\u3046\u306b\u3057\u3066\u30c7\u30fc\u30bf\u304c\u53d6\u308c\u308b\u3002\n\n\u3053\u306e\u30ad\u30e5\u30fc URL \u3092\u3057\u3070\u3089\u304f\u898b\u3066\u3044\u308b\u3068\u3001\u30d3\u30eb\u30c9\u3092\u30c8\u30ea\u30ac\u30fc\u3057\u305f\u76f4\u5f8c\u306f Quiet Period \u3068\u306a\u3063\u3066\u304a\u308a\u3001job \u5b9f\u884c\u5f85\u3061\u306e\u72b6\u614b\u3060\u304c\u3001\u3057\u3070\u3089\u304f\u5f85\u3064\u3068 `executable.url` \u306b\u5b9f\u884c job \u306e URL \u304c\u5165\u3063\u3066\u304f\u308b\u3002\n\n\u3055\u3089\u306b\u305d\u306e job URL \u306e\u5b9f\u884c\u72b6\u614b\u3092\u30c1\u30a7\u30c3\u30af\u3057\u306a\u304c\u3089\u3001job \u304c\u5b8c\u4e86\u3059\u308b\u3068 `result` \u304c\u53d6\u5f97\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u308b\u306e\u3067\u305d\u308c\u3092\u5f85\u3064\u3002\n\n\n\u308f\u308a\u3068\u3081\u3093\u3069\u304f\u3055\u3044 :weary: \n", "tags": ["Jenkins", "Ajax"]}