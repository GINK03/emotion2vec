{"context": " More than 1 year has passed since last update.\u4eca\u5e74\u3082\u767b\u9332\u3057\u3066\u3057\u307e\u3063\u305f\u30a2\u30c9\u30d9\u30f3\u30c8\u30ab\u30ec\u30f3\u30c0\u30fc\u3002\u3002\n\u30ea\u30d6\u30bb\u30f3\u30b9 @eri \u3067\u3059\u3002\u8ee2\u8077\u30b5\u30a4\u30c8\u30b8\u30e7\u30d6\u30bb\u30f3\u30b9\u30ea\u30f3\u30af\u306e\u958b\u767a\u3092\u3057\u3066\u3044\u307e\u3059\u3002\u4e00\u6628\u65e5\u306e\u6669\u3054\u306f\u3093\u306f\u7bc9\u5730\u3067\u3075\u3050\u523a\u3057\u3092\u98df\u3079\u307e\u3057\u305f\u3002\n\u30c1\u30e3\u30c3\u30c8\u30a2\u30d7\u30ea\u304b\u3089\u306e\u30c1\u30e3\u30c3\u30c8\u3092\u4ed6\u7aef\u672b\u304b\u3089\u9001\u308c\u305f\u308a\u3057\u306a\u3044\u304b\u306a\u30fc\u3001\u304b\u3089\u306e\u6d41\u308c\u3067\u30c1\u30e3\u30c3\u30c8\u306e\u4ed5\u7d44\u307f\u304c\u6c17\u306b\u306a\u308a\u3001Websocket\u306b\u3064\u3044\u3066\u8abf\u3079\u3066\u3044\u307e\u3057\u305f\u3002\nHTTP\u901a\u4fe1\u3068\u7570\u306a\u308bWebsocket\u306e\u7279\u5fb4\u3068\u3057\u3066\u30011\u30b3\u30cd\u30af\u30b7\u30e7\u30f3\u3067\u306e\u53cc\u65b9\u5411\u901a\u4fe1\u3001\u8ee2\u9001\u30c7\u30fc\u30bf\u304c\u8efd\u91cf\u3001\u975e\u540c\u671f\u306a\u3069\u306a\u3069\u3042\u308a\u307e\u3059\u304c\u3001\u4eca\u56de\u306f\u30c7\u30fc\u30bf\u8ee2\u9001\u30d1\u30b1\u30c3\u30c8\u306e\u69cb\u9020\u3092\u30e1\u30a4\u30f3\u306b\u8aac\u660e\u3057\u307e\u3059\u3002\n\nWebsocket\u6982\u8981\nWebsocket\u306e\u5168\u5bb9\u306f\u3001\u5206\u304b\u308a\u3084\u3059\u3044\u30b9\u30e9\u30a4\u30c9\u304c\u3042\u3063\u305f\u306e\u3067\u305d\u3061\u3089\u3092\u898b\u3066\u3044\u305f\u3060\u304f\u3068\u3057\u3066\u3002\nhttp://www.slideshare.net/mawarimichi/websocketwebrtc\nWebsocket\u901a\u4fe1\u304c\u78ba\u7acb\u3059\u308b\u307e\u3067\u306b\u3001\u30b5\u30fc\u30d0\u30fc\u30fb\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u9593\u3067\u8272\u3005\u306a\u3084\u308a\u53d6\u308a(Websocket opening \u30cf\u30f3\u30c9\u30b7\u30a7\u30a4\u30af\u3068\u547c\u3070\u308c\u308b)\u304c\u884c\u308f\u308c\u307e\u3059\u3002\n\u901a\u4fe1(\u5b9f\u306fTCP)\u304c\u78ba\u7acb\u3057\u305f\u5f8c\u3001\u4f4e\u30b3\u30b9\u30c8\u3067\u306e\u30c7\u30fc\u30bf\u8ee2\u9001\u304c\u884c\u308f\u308c\u307e\u3059\u3002\u30d8\u30c3\u30c0\u30fc\u9577\u304c\u9577\u304f\u306a\u308a\u304c\u3061\u306aHTTP\u901a\u4fe1\u3088\u308a\u3082\u304b\u306a\u308a\u8ee2\u9001\u91cf\u304c\u6291\u3048\u3089\u308c\u3066\u3044\u307e\u3059\u3002\n\u3057\u304b\u3057\u3001\u8ee2\u9001\u5185\u5bb9\u306b\u306f\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u304c\u9001\u308a\u305f\u3044\u7d20\u306e\u30c7\u30fc\u30bf\u5165\u3063\u3066\u3044\u308b\u306e\u3067\u306f\u306a\u304f\u3001Websocket\u306e\u30d7\u30ed\u30c8\u30b3\u30eb\u3067\u7d44\u307f\u7acb\u3066\u3089\u308c\u305f\u30c7\u30fc\u30bf\u304c\u8ee2\u9001\u3055\u308c\u307e\u3059\u3002\u52c9\u5f37\u304c\u3066\u3089\u3001\u30d1\u30b1\u30c3\u30c8\u304b\u3089\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u30c7\u30fc\u30bf\u3092\u53d6\u308a\u51fa\u3059\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u66f8\u3044\u3066\u3044\u304d\u307e\u3059\u3002\n\n\u6e96\u5099\n\u307e\u305a\u3001Websocket\u3067\u30c6\u30ad\u30b9\u30c8\u3092\u3084\u308a\u53d6\u308a\u3059\u308b\u3060\u3051\u306e\u4ed5\u7d44\u307f\u3092\u4f5c\u3063\u3066\u304a\u304d\u307e\u3059\u3002\nOS/\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u74b0\u5883/\u5229\u7528\u8a00\u8a9e\u30fb\u30e2\u30b8\u30e5\u30fc\u30eb\n\nMac OS 10.11.1\nGoogle Chrome 47\nNode.js v4.2.2\n\nwebsocket (Node.js\u30e2\u30b8\u30e5\u30fc\u30eb)\nruby 2.0.0p645\n\n\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u5074\n\nindex.html\n\n<!DOCTYPE html>\n<html>\n<head>\n  <title>websocket sample</title>\n</head>\n\n<body>\n  <input type=\"text\" id=\"message\"> <input type=\"button\" id=\"send\" value=\"submit\">\n\n  <script>\n    (function() {\n        var ws = new WebSocket(\"ws://localhost:8008\");\n        var output = document.getElementById('output');\n        var send = document.getElementById('send');\n        send.addEventListener('click', function() {\n          var msg = document.getElementById('message').value;\n          ws.send(msg);\n        });\n      }());\n  </script>\n</body>\n</html>\n\n\n\n\u30b5\u30fc\u30d0\u30fc\u5074\n\napp.js\nvar http = require('http');\nvar clientHtml = require('fs').readFileSync('index.html');\n\nvar httpServer = http.createServer(function(req, res) {\n  res.writeHead(200, { 'Content-Type': 'text/html' });\n  res.end(clientHtml);\n});\n\nhttpServer.listen(8008);\n\nvar WebSocketServer = require('websocket').server;\nvar wsServer = new WebSocketServer({ httpServer: httpServer });\n\nwsServer.on('request', function (req) {\n  var connection = req.accept(null, req.origin);\n  connection.on('message', function(msg) {\n    console.log(msg.utf8Data);\n  });\n});\n\n\n\u30b5\u30fc\u30d0\u30fc\u3092\u7acb\u3061\u4e0a\u3052\u3001\n$ node app.js\n\nhttp://localhost:8008 \u306b\u30a2\u30af\u30bb\u30b9\n\n\u3053\u3053\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u5074\u3067\u30c6\u30ad\u30b9\u30c8\u3092submit\u3059\u308b\u3068\u3001\u30b5\u30fc\u30d0\u30fc\u5074\u3067echo\u3055\u308c\u307e\u3059\u3002\n\n\u30d1\u30b1\u30c3\u30c8\u53d6\u5f97\n\u30d1\u30b1\u30c3\u30c8\u3092\u53d6\u5f97\u3059\u308b\u305f\u3081\u306b\u3001\u30c6\u30ad\u30b9\u30c8submit\u76f4\u5f8c\u306e\u901a\u4fe1\u3092dump\u3057\u307e\u3059\u3002\n$ tcpdump dst port 8008 -i lo0 -s0 -w send.pcap\n\n\u30b5\u30fc\u30d0\u30fc\u5074\u3067Listen\u3057\u3066\u308b\u30dd\u30fc\u30c8\u756a\u53f7\u3067\u7d5e\u308a\u8fbc\u307f\u3001\n-i lo0\u3067localhost\u9593\u306e\u901a\u4fe1\u306e\u307f\u3092\u7d5e\u308a\u8fbc\u3093\u3067\u307e\u3059\u3002\n\n\u4eca\u56de\u306f7\u30d0\u30a4\u30c8\u306eASCII\u30c6\u30ad\u30b9\u30c8\u3092\u9001\u4fe1\u3002\nsend.pcap\u306b\u4fdd\u5b58\u3055\u308c\u307e\u3057\u305f\u3002\n\nTCP\u30c7\u30fc\u30bf\u53d6\u5f97\ndump\u7d50\u679c\u306f\u305d\u306e\u307e\u307e\u3067\u306f\u8aad\u3081\u306a\u3044(\u30d0\u30a4\u30ca\u30ea)\u3001\u5404\u901a\u4fe1\u30d7\u30ed\u30c8\u30b3\u30eb\u3092\u89e3\u8aad\u3057\u3066\u3044\u304f\u306e\u306f\u9762\u5012\u3001\u3068\u306b\u304b\u304fTCP\u30c7\u30fc\u30bf\u672c\u4f53\u3060\u3051\u898b\u305f\u3044\u3001\u3068\u3044\u3046\u3053\u3068\u3067Wireshark\u306e\u529b\u3092\u501f\u308a\u307e\u3059\u3002\nWireshark\u306fGUI\u3060\u3051\u3067\u306a\u304fCLI\u3082\u7528\u610f\u3055\u308c\u3066\u3042\u308a\u3001\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u5f8ctshark\u30b3\u30de\u30f3\u30c9\u304c\u4f7f\u3048\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\n\u30c7\u30fc\u30bf\u3060\u3051\u6b32\u3057\u3044\u3001\u3068\u3044\u3046\u30aa\u30d7\u30b7\u30e7\u30f3\u3092\u6307\u5b9a\u3057\u3066\u3042\u3052\u308b\u3068\u3001\n$ tshark -r send.pcap -T fields -e data\n8187e1a4c61d8cc5f46e80cfa7\n\n16\u9032\u6570\u3067TCP\u306e\u30c7\u30fc\u30bf\u304c\u53d6\u308c\u307e\u3057\u305f\u300213\u30d0\u30a4\u30c8\u3057\u304b\u3042\u308a\u307e\u305b\u3093\u3002\n\n\u30d0\u30a4\u30c8\u3054\u3068\u306e\u53d6\u308a\u51fa\u3057\n\u53d6\u308c\u305f\u30c7\u30fc\u30bf\u3092\u64cd\u4f5c\u3059\u308b\u305f\u3081\u306b\u300116\u9032\u6587\u5b57\u5217\u306en+1\u30d0\u30a4\u30c8\u76ee\u3092\u3001\u7b26\u53f7\u306a\u3057\u6574\u6570\u3067\u53d6\u308a\u51fa\u3059\u30e1\u30bd\u30c3\u30c9\u3082\u3053\u3053\u3067\u4f5c\u3063\u3066\u304a\u304d\u307e\u3059\u3002(Ruby)\ntcp_data = `tshark -r send.pcap -T fields -e data`.chomp\n\ndef tcp_data.get_char(n)\n  [self].pack(\"H*\")[n].unpack(\"C*\")[0]\nend\n\n16\u9032\u6587\u5b57\u5217\u3092\u30d0\u30a4\u30ca\u30ea\u5909\u63db\u3057\u30661\u30d0\u30a4\u30c8\u53d6\u308a\u51fa\u3057\u3001\u305d\u308c\u3092char\u578b\u306b\u5909\u63db\u3057\u3066\u3044\u307e\u3059\u3002\n\nWebsocket\u30c7\u30fc\u30bf\u89e3\u8aad\nWebsocket\u3067\u306e\u30c7\u30fc\u30bf\u306f\u30d5\u30ec\u30fc\u30e0\u3068\u547c\u3070\u308c\u3066\u304a\u308a\u3001RFC6455 \u306e Base Framing Protocol\u306b\u30d5\u30ec\u30fc\u30e0\u306e\u8aad\u307f\u65b9\u304c\u8a18\u8f09\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n  0                   1                   2                   3\n  0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1\n +-+-+-+-+-------+-+-------------+-------------------------------+\n |F|R|R|R| opcode|M| Payload len |    Extended payload length    |\n |I|S|S|S|  (4)  |A|     (7)     |             (16/64)           |\n |N|V|V|V|       |S|             |   (if payload len==126/127)   |\n | |1|2|3|       |K|             |                               |\n +-+-+-+-+-------+-+-------------+ - - - - - - - - - - - - - - - +\n |     Extended payload length continued, if payload len == 127  |\n + - - - - - - - - - - - - - - - +-------------------------------+\n |                               |Masking-key, if MASK set to 1  |\n +-------------------------------+-------------------------------+\n | Masking-key (continued)       |          Payload Data         |\n +-------------------------------- - - - - - - - - - - - - - - - +\n :                     Payload Data continued ...                :\n + - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - +\n |                     Payload Data continued ...                |\n +---------------------------------------------------------------+\n\n\u6a2a\u5e454\u30d0\u30a4\u30c8\u5206\u306e\u8868\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002\n\u30d5\u30ec\u30fc\u30e0\u30d7\u30ed\u30c8\u30b3\u30eb\u306e\u5404\u8981\u7d20\u3092\u898b\u3066\u3044\u304d\u307e\u3059\u3002\u7aef\u6298\u3063\u3066\u3044\u308b\u306e\u3067\u3001\u8a73\u3057\u304f\u306fRFC6455\u3092\u898b\u3066\u304f\u3060\u3055\u3044\u3002\nFIN\n\u9001\u3089\u308c\u305f\u30d5\u30ec\u30fc\u30e0\u304c\u6700\u5f8c\u306e\u30d5\u30e9\u30b0\u30e1\u30f3\u30c8\u3060\u3063\u305f\u5834\u5408\u306b1\u3002\n(Websocket\u3067\u306f\u30c7\u30fc\u30bf\u3092\u30d5\u30e9\u30b0\u30e1\u30f3\u30c8\u3068\u3044\u3046\u5358\u4f4d\u306b\u5206\u5272\u3057\u3066\u9001\u308b\u3053\u3068\u3082\u51fa\u6765\u307e\u3059\u3002)\n(tcp_data.get_char(0) & 0b10000000) >> 7\n=> 1\n\n\u4eca\u56de1\u3002\nRSV1, RSV2, RSV3\n0\u4ee5\u5916\u306e\u5024\u306b\u3066\u610f\u5473\u3092\u5b9a\u7fa9\u3059\u308b\u62e1\u5f35\u304c\u30cd\u30b4\u30b7\u30a8\u30fc\u30b7\u30e7\u30f3\u3055\u308c\u3066\u3044\u306a\u3044\u9650\u308a\u30010\u3067\u306a\u3051\u308c\u3070\u306a\u3089\u306a\u3044\u3002\u901a\u5e380\u3002\n(tcp_data.get_char(0) & 0b01110000) >> 4\n=> 0\n\n\u5168\u30660\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002\nopcode\nPayload data\u306e\u5f62\u5f0f\u3092\u6307\u5b9a\u3002\u5148\u7a0b\u30d5\u30a9\u30fc\u30e0\u304b\u3089\u9001\u4fe1\u3057\u305f\u30c7\u30fc\u30bf\u306b\u3042\u305f\u308b\u3002\u30c6\u30ad\u30b9\u30c8\u306e\u5834\u54081\u3002\u30d0\u30a4\u30ca\u30ea\u30c7\u30fc\u30bf\u3082Websocket\u3067\u9001\u4fe1\u53ef\u80fd\u3067\u3001\u305d\u306e\u5834\u54082\u3068\u306a\u308b\u3002\u305d\u306e\u4ed6\u3001\u63a5\u7d9aclose\u306e\u969b\u306e\u5024\u3084\u3001\u4eca\u5f8c\u306e\u62e1\u5f35\u306e\u305f\u3081\u306e\u4e88\u7d04\u6e08\u307f\u306e\u5024\u306a\u3069\u69d8\u3005\u6c7a\u3081\u3089\u308c\u3066\u3044\u308b\ntcp_data.get_char(0) & 0b00001111\n=> 1\n\n\u30c6\u30ad\u30b9\u30c8\u3092\u9001\u4fe1\u3057\u305f\u306e\u30671\u3002\nMask\n1\u306e\u5834\u5408\u3001Payload data\u304cMasking-key\u3067\u30de\u30b9\u30af\u3055\u308c\u3066\u3044\u308b\u3002\n\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u304b\u3089\u30b5\u30fc\u30d0\u30fc\u3078\u306e\u9001\u4fe1\u306e\u5834\u5408\u306f1\u3002\n(tcp_data.get_char(1) & 0b10000000) >> 7\n=> 1\n\n\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u304b\u3089\u9001\u4fe1\u3057\u3066\u308b\u305f\u30811\u3002\nPayload len\nPayload data\u306e\u9577\u3055(\u30d0\u30a4\u30c8\u6570)\ntcp_data.get_char(1) & 0b01111111\n=> 7\n\n7\u30d0\u30a4\u30c8\u306e\u30c6\u30ad\u30b9\u30c8\u3067\u3042\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\nExtended payload length\nPayload len\u304c126\u304b127\u3060\u3063\u305f\u5834\u5408\u306b\u6307\u5b9a\u3055\u308c\u308b\u306e\u3067\u3001\u4eca\u56de\u306f\u306a\u3057\u3002\nMasking-key\nMask\u304c1\u306e\u5834\u5408\u3001Masking-key\u304c\u5b58\u5728\u3059\u308b\u3002Payload Data\u3092\u30de\u30b9\u30ad\u30f3\u30b0\u3057\u3066\u3044\u308b\u3002\nTCP\u30c7\u30fc\u30bf\u306e3\u30d0\u30a4\u30c8\u76ee\u301c6\u30d0\u30a4\u30c8\u76ee\u3002\nPayload Data\nWebsocket\u306e\u30c7\u30fc\u30bf\u90e8\u3002\u5148\u7a0b\u30d5\u30a9\u30fc\u30e0\u304b\u3089\u9001\u4fe1\u3057\u305f\u30c6\u30ad\u30b9\u30c8\u306b\u3042\u305f\u308b\u3002\nTCP\u30c7\u30fc\u30bf\u306e7\u30d0\u30a4\u30c8\u76ee\u301c13\u30d0\u30a4\u30c8\u76ee\u3002\n\n\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u30c7\u30fc\u30bf\u306e\u30a2\u30f3\u30de\u30b9\u30af\nMask\u304c\u9069\u7528\u3055\u308c\u3066\u3044\u308b\u306e\u3067\u30a2\u30f3\u30de\u30b9\u30af\u3057\u3066\u3042\u3052\u307e\u3059\u3002\nPayload Data\u306b\u5bfe\u3057\u3001Masking-key\u30921\u30d0\u30a4\u30c8\u305a\u3064XOR\u3059\u308b\u3068\u3001\u30a2\u30f3\u30de\u30b9\u30af\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\nmasking_key_start_index = 2\npayload_start_index = 6\npayload_length = tcp_data.get_char(1) & 0b01111111\n\ndata = ''\npayload_length.times do |i|\n  # Masking-key\u306f4\u30d0\u30a4\u30c8\u3057\u304b\u306a\u3044\u305f\u3081\u3001\u305d\u308c\u3088\u308a\u3082Payload Data\u304c\u9577\u3044\u5834\u5408\u306f\u7e70\u308a\u8fd4\u3057\u9069\u7528\n  masking_key_index = masking_key_start_index + (i % 4)\n  masking_key_char = tcp_data.get_char(masking_key_index)\n\n  masked_char = tcp_data.get_char(payload_start_index + i)\n\n  # Masking-key\u3068Payload Data\u30921\u30d0\u30a4\u30c8\u305a\u3064XOR\n  data << (masking_key_char ^ masked_char)\nend\n\n\n\u30d1\u30b1\u30c3\u30c8\u89e3\u6790\u30b9\u30af\u30ea\u30d7\u30c8\u307e\u3068\u3081\n\u30d1\u30b1\u30c3\u30c8\u3092\u6e21\u3059\u3068\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u30c7\u30fc\u30bf\u304c\u8fd4\u308b\u30b9\u30af\u30ea\u30d7\u30c8\u3068\u3057\u3066\u3001\u4ee5\u4e0a\u3092\u307e\u3068\u3081\u307e\u3059\u3002\n\nparse_packet.rb\ntcp_data = `tshark -r send.pcap -T fields -e data`.chomp\n\ndef tcp_data.get_char(n)\n  [self].pack(\"H*\")[n].unpack(\"C*\")[0]\nend\n\nmasking_key_start_index = 2\npayload_start_index = 6\npayload_length = tcp_data.get_char(1) & 0b01111111\n\ndata = ''\npayload_length.times do |i|\n  masking_key_index = masking_key_start_index + (i % 4)\n  masking_key_char = tcp_data.get_char(masking_key_index)\n\n  masked_char = tcp_data.get_char(payload_start_index + i)\n\n  data << (masking_key_char ^ masked_char)\nend\n\nputs data\n\n\n\u5b9f\u884c\u3059\u308b\u3068\u3001\n$ ruby parse_packet.rb\nma2saka\n\n\u3067\u304d\u307e\u3057\u305f\uff01\n\u30a8\u30e9\u30fc\u51e6\u7406\u7121\u3057\u3001\u30c6\u30ad\u30b9\u30c8\u30c7\u30fc\u30bf\u306e\u307f\u3001125\u30d0\u30a4\u30c8\u4ee5\u4e0b\u306e\u30c7\u30fc\u30bf\u306e\u307f\u3001\u5225\u9014\u30d1\u30b1\u30c3\u30c8\u30ad\u30e3\u30d7\u30c1\u30e3\u304c\u5fc5\u8981\u3001\u306a\u3069\u8ab2\u984c\u306f\u3042\u308a\u307e\u3059\u304c\u4e00\u4f8b\u3092\u51fa\u305b\u305f\u306e\u3067\u3088\u3057\u3068\u3057\u307e\u3059\u3002\n\n\u5f8c\u65e5\u8ac7\nWebsocket\u3068\u3044\u3048\u3070\u3001socket.io\u304c\u6709\u540d\u306a\u30e2\u30b8\u30e5\u30fc\u30eb\u306e\u3046\u3061\u306e\u4e00\u3064\u3067\u3059\u3002\n\u5f53\u521d\u3001Websocket\u3092\u52d5\u304b\u3059\u305f\u3081\u306bsocket.io\u4f7f\u3063\u3066\u305f\u306e\u3067\u3059\u304c\u3001\u30c7\u30fc\u30bf\u30d5\u30ec\u30fc\u30e0\u3092\u89e3\u6790\u3057\u3066\u307f\u308b\u3068\u3001\u30a2\u30f3\u30de\u30b9\u30af\u3057\u3066\u3082\u30c6\u30ad\u30b9\u30c8\u304c\u8b0e\u306e\u8a18\u53f7\u306e\u7f85\u5217\u3060\u3063\u305f\u308a\u3001RSV1\u304c1\u3060\u3063\u305f\u308a\u3001\u7d50\u5c40\u89e3\u8aad\u51fa\u6765\u305a\u4eca\u56de\u306ewebsocket\u30e2\u30b8\u30e5\u30fc\u30eb\u3092\u4f7f\u3044\u307e\u3057\u305f\u3002socket.io\u3067\u306f\u300c\u610f\u5473\u3092\u5b9a\u7fa9\u3059\u308b\u62e1\u5f35\u304c\u30cd\u30b4\u30b7\u30a8\u30fc\u30b7\u30e7\u30f3\u300d\u3055\u308c\u3066\u308b\u306e\u3067\u3057\u3087\u3046\u304b\u3002\n\u307e\u305fsocket.io\u3067\u306e\u901a\u4fe1\u30d1\u30b1\u30c3\u30c8\u3092\u773a\u3081\u3066\u3044\u308b\u3068\u3001\u540c\u3058\u30c6\u30ad\u30b9\u30c8\u3092\u8907\u6570\u56de\u9001\u4fe1\u3059\u308b\u3068\u3001TCP\u30c7\u30fc\u30bf\u9577\u304c\u77ed\u3044\u5024\u306b\u53ce\u307e\u3063\u3066\u3044\u304f\u50be\u5411\u306b\u3042\u308a\u307e\u3057\u305f\u3002\u66f4\u306b\u30c7\u30fc\u30bf\u91cf\u3092\u524a\u6e1b\u3059\u308b\u305f\u3081\u306b\u3001\u5185\u90e8\u3067\u5de5\u592b\u3057\u3066\u308b\u306e\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u3002\n\u660e\u65e5\u306f\u30aa\u30d5\u30a3\u30b9\u3067\u5e2d\u304c\u53f3\u96a3\u306e\u65b0\u5352\u540c\u671f @ktmg \u306b\u7d9a\u304d\u307e\u3059!!\n\n\u4eca\u5e74\u3082\u767b\u9332\u3057\u3066\u3057\u307e\u3063\u305f\u30a2\u30c9\u30d9\u30f3\u30c8\u30ab\u30ec\u30f3\u30c0\u30fc\u3002\u3002\n\u30ea\u30d6\u30bb\u30f3\u30b9 @eri \u3067\u3059\u3002\u8ee2\u8077\u30b5\u30a4\u30c8[\u30b8\u30e7\u30d6\u30bb\u30f3\u30b9\u30ea\u30f3\u30af](http://job.j-sen.jp/)\u306e\u958b\u767a\u3092\u3057\u3066\u3044\u307e\u3059\u3002\u4e00\u6628\u65e5\u306e\u6669\u3054\u306f\u3093\u306f\u7bc9\u5730\u3067\u3075\u3050\u523a\u3057\u3092\u98df\u3079\u307e\u3057\u305f\u3002\n\n\u30c1\u30e3\u30c3\u30c8\u30a2\u30d7\u30ea\u304b\u3089\u306e\u30c1\u30e3\u30c3\u30c8\u3092\u4ed6\u7aef\u672b\u304b\u3089\u9001\u308c\u305f\u308a\u3057\u306a\u3044\u304b\u306a\u30fc\u3001\u304b\u3089\u306e\u6d41\u308c\u3067\u30c1\u30e3\u30c3\u30c8\u306e\u4ed5\u7d44\u307f\u304c\u6c17\u306b\u306a\u308a\u3001Websocket\u306b\u3064\u3044\u3066\u8abf\u3079\u3066\u3044\u307e\u3057\u305f\u3002\n\nHTTP\u901a\u4fe1\u3068\u7570\u306a\u308bWebsocket\u306e\u7279\u5fb4\u3068\u3057\u3066\u30011\u30b3\u30cd\u30af\u30b7\u30e7\u30f3\u3067\u306e\u53cc\u65b9\u5411\u901a\u4fe1\u3001\u8ee2\u9001\u30c7\u30fc\u30bf\u304c\u8efd\u91cf\u3001\u975e\u540c\u671f\u306a\u3069\u306a\u3069\u3042\u308a\u307e\u3059\u304c\u3001\u4eca\u56de\u306f\u30c7\u30fc\u30bf\u8ee2\u9001\u30d1\u30b1\u30c3\u30c8\u306e\u69cb\u9020\u3092\u30e1\u30a4\u30f3\u306b\u8aac\u660e\u3057\u307e\u3059\u3002\n\n# Websocket\u6982\u8981\n\nWebsocket\u306e\u5168\u5bb9\u306f\u3001\u5206\u304b\u308a\u3084\u3059\u3044\u30b9\u30e9\u30a4\u30c9\u304c\u3042\u3063\u305f\u306e\u3067\u305d\u3061\u3089\u3092\u898b\u3066\u3044\u305f\u3060\u304f\u3068\u3057\u3066\u3002\nhttp://www.slideshare.net/mawarimichi/websocketwebrtc\n\nWebsocket\u901a\u4fe1\u304c\u78ba\u7acb\u3059\u308b\u307e\u3067\u306b\u3001\u30b5\u30fc\u30d0\u30fc\u30fb\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u9593\u3067\u8272\u3005\u306a\u3084\u308a\u53d6\u308a(Websocket opening \u30cf\u30f3\u30c9\u30b7\u30a7\u30a4\u30af\u3068\u547c\u3070\u308c\u308b)\u304c\u884c\u308f\u308c\u307e\u3059\u3002\n\n\u901a\u4fe1(\u5b9f\u306fTCP)\u304c\u78ba\u7acb\u3057\u305f\u5f8c\u3001\u4f4e\u30b3\u30b9\u30c8\u3067\u306e\u30c7\u30fc\u30bf\u8ee2\u9001\u304c\u884c\u308f\u308c\u307e\u3059\u3002\u30d8\u30c3\u30c0\u30fc\u9577\u304c\u9577\u304f\u306a\u308a\u304c\u3061\u306aHTTP\u901a\u4fe1\u3088\u308a\u3082\u304b\u306a\u308a\u8ee2\u9001\u91cf\u304c\u6291\u3048\u3089\u308c\u3066\u3044\u307e\u3059\u3002\n\n\u3057\u304b\u3057\u3001\u8ee2\u9001\u5185\u5bb9\u306b\u306f\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u304c\u9001\u308a\u305f\u3044\u7d20\u306e\u30c7\u30fc\u30bf\u5165\u3063\u3066\u3044\u308b\u306e\u3067\u306f\u306a\u304f\u3001Websocket\u306e\u30d7\u30ed\u30c8\u30b3\u30eb\u3067\u7d44\u307f\u7acb\u3066\u3089\u308c\u305f\u30c7\u30fc\u30bf\u304c\u8ee2\u9001\u3055\u308c\u307e\u3059\u3002\u52c9\u5f37\u304c\u3066\u3089\u3001\u30d1\u30b1\u30c3\u30c8\u304b\u3089\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u30c7\u30fc\u30bf\u3092\u53d6\u308a\u51fa\u3059\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u66f8\u3044\u3066\u3044\u304d\u307e\u3059\u3002\n\n# \u6e96\u5099\n\u307e\u305a\u3001Websocket\u3067\u30c6\u30ad\u30b9\u30c8\u3092\u3084\u308a\u53d6\u308a\u3059\u308b\u3060\u3051\u306e\u4ed5\u7d44\u307f\u3092\u4f5c\u3063\u3066\u304a\u304d\u307e\u3059\u3002\n\n**OS/\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u74b0\u5883/\u5229\u7528\u8a00\u8a9e\u30fb\u30e2\u30b8\u30e5\u30fc\u30eb**\n\n- Mac OS 10.11.1\n- Google Chrome 47\n- Node.js v4.2.2\n- [websocket](https://www.npmjs.com/package/websocket) (Node.js\u30e2\u30b8\u30e5\u30fc\u30eb)\n- ruby 2.0.0p645\n\n\n**\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u5074**\n\n```html:index.html\n\n<!DOCTYPE html>\n<html>\n<head>\n  <title>websocket sample</title>\n</head>\n\n<body>\n  <input type=\"text\" id=\"message\"> <input type=\"button\" id=\"send\" value=\"submit\">\n\n  <script>\n    (function() {\n        var ws = new WebSocket(\"ws://localhost:8008\");\n        var output = document.getElementById('output');\n        var send = document.getElementById('send');\n        send.addEventListener('click', function() {\n          var msg = document.getElementById('message').value;\n          ws.send(msg);\n        });\n      }());\n  </script>\n</body>\n</html>\n\n```\n\n**\u30b5\u30fc\u30d0\u30fc\u5074**\n\n```js:app.js\nvar http = require('http');\nvar clientHtml = require('fs').readFileSync('index.html');\n\nvar httpServer = http.createServer(function(req, res) {\n  res.writeHead(200, { 'Content-Type': 'text/html' });\n  res.end(clientHtml);\n});\n\nhttpServer.listen(8008);\n\nvar WebSocketServer = require('websocket').server;\nvar wsServer = new WebSocketServer({ httpServer: httpServer });\n\nwsServer.on('request', function (req) {\n  var connection = req.accept(null, req.origin);\n  connection.on('message', function(msg) {\n    console.log(msg.utf8Data);\n  });\n});\n```\n\n\u30b5\u30fc\u30d0\u30fc\u3092\u7acb\u3061\u4e0a\u3052\u3001\n\n```shell-session\n$ node app.js\n```\n\nhttp://localhost:8008 \u306b\u30a2\u30af\u30bb\u30b9\n\n![image](https://qiita-image-store.s3.amazonaws.com/0/54562/8175ead2-4f7f-fb1c-b238-298687eba421.png)\n\n\u3053\u3053\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u5074\u3067\u30c6\u30ad\u30b9\u30c8\u3092submit\u3059\u308b\u3068\u3001\u30b5\u30fc\u30d0\u30fc\u5074\u3067echo\u3055\u308c\u307e\u3059\u3002\n\n#\u30d1\u30b1\u30c3\u30c8\u53d6\u5f97\n\u30d1\u30b1\u30c3\u30c8\u3092\u53d6\u5f97\u3059\u308b\u305f\u3081\u306b\u3001\u30c6\u30ad\u30b9\u30c8submit\u76f4\u5f8c\u306e\u901a\u4fe1\u3092dump\u3057\u307e\u3059\u3002\n\n```shell-session\n$ tcpdump dst port 8008 -i lo0 -s0 -w send.pcap\n```\n\n\u30b5\u30fc\u30d0\u30fc\u5074\u3067Listen\u3057\u3066\u308b\u30dd\u30fc\u30c8\u756a\u53f7\u3067\u7d5e\u308a\u8fbc\u307f\u3001\n`-i lo0`\u3067localhost\u9593\u306e\u901a\u4fe1\u306e\u307f\u3092\u7d5e\u308a\u8fbc\u3093\u3067\u307e\u3059\u3002\n\n\n\n![image](https://qiita-image-store.s3.amazonaws.com/0/54562/7194ae8b-0d04-ec7e-80d5-0e34e2d0729d.png)\n\n\n\u4eca\u56de\u306f7\u30d0\u30a4\u30c8\u306eASCII\u30c6\u30ad\u30b9\u30c8\u3092\u9001\u4fe1\u3002\nsend.pcap\u306b\u4fdd\u5b58\u3055\u308c\u307e\u3057\u305f\u3002\n\n#TCP\u30c7\u30fc\u30bf\u53d6\u5f97\ndump\u7d50\u679c\u306f\u305d\u306e\u307e\u307e\u3067\u306f\u8aad\u3081\u306a\u3044(\u30d0\u30a4\u30ca\u30ea)\u3001\u5404\u901a\u4fe1\u30d7\u30ed\u30c8\u30b3\u30eb\u3092\u89e3\u8aad\u3057\u3066\u3044\u304f\u306e\u306f\u9762\u5012\u3001\u3068\u306b\u304b\u304fTCP\u30c7\u30fc\u30bf\u672c\u4f53\u3060\u3051\u898b\u305f\u3044\u3001\u3068\u3044\u3046\u3053\u3068\u3067[Wireshark](https://www.wireshark.org/download.html)\u306e\u529b\u3092\u501f\u308a\u307e\u3059\u3002\n\nWireshark\u306fGUI\u3060\u3051\u3067\u306a\u304fCLI\u3082\u7528\u610f\u3055\u308c\u3066\u3042\u308a\u3001\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u5f8c`tshark`\u30b3\u30de\u30f3\u30c9\u304c\u4f7f\u3048\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\n\u30c7\u30fc\u30bf\u3060\u3051\u6b32\u3057\u3044\u3001\u3068\u3044\u3046\u30aa\u30d7\u30b7\u30e7\u30f3\u3092\u6307\u5b9a\u3057\u3066\u3042\u3052\u308b\u3068\u3001\n\n```shell-session\n$ tshark -r send.pcap -T fields -e data\n8187e1a4c61d8cc5f46e80cfa7\n```\n\n16\u9032\u6570\u3067TCP\u306e\u30c7\u30fc\u30bf\u304c\u53d6\u308c\u307e\u3057\u305f\u300213\u30d0\u30a4\u30c8\u3057\u304b\u3042\u308a\u307e\u305b\u3093\u3002\n\n#\u30d0\u30a4\u30c8\u3054\u3068\u306e\u53d6\u308a\u51fa\u3057\n\u53d6\u308c\u305f\u30c7\u30fc\u30bf\u3092\u64cd\u4f5c\u3059\u308b\u305f\u3081\u306b\u300116\u9032\u6587\u5b57\u5217\u306en+1\u30d0\u30a4\u30c8\u76ee\u3092\u3001\u7b26\u53f7\u306a\u3057\u6574\u6570\u3067\u53d6\u308a\u51fa\u3059\u30e1\u30bd\u30c3\u30c9\u3082\u3053\u3053\u3067\u4f5c\u3063\u3066\u304a\u304d\u307e\u3059\u3002(Ruby)\n\n```rb:\ntcp_data = `tshark -r send.pcap -T fields -e data`.chomp\n\ndef tcp_data.get_char(n)\n  [self].pack(\"H*\")[n].unpack(\"C*\")[0]\nend\n```\n16\u9032\u6587\u5b57\u5217\u3092\u30d0\u30a4\u30ca\u30ea\u5909\u63db\u3057\u30661\u30d0\u30a4\u30c8\u53d6\u308a\u51fa\u3057\u3001\u305d\u308c\u3092char\u578b\u306b\u5909\u63db\u3057\u3066\u3044\u307e\u3059\u3002\n\n#Websocket\u30c7\u30fc\u30bf\u89e3\u8aad\nWebsocket\u3067\u306e\u30c7\u30fc\u30bf\u306f\u30d5\u30ec\u30fc\u30e0\u3068\u547c\u3070\u308c\u3066\u304a\u308a\u3001[RFC6455](http://tools.ietf.org/html/rfc6455#section-5.2) \u306e Base Framing Protocol\u306b\u30d5\u30ec\u30fc\u30e0\u306e\u8aad\u307f\u65b9\u304c\u8a18\u8f09\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n\n\n\n      0                   1                   2                   3\n      0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1\n     +-+-+-+-+-------+-+-------------+-------------------------------+\n     |F|R|R|R| opcode|M| Payload len |    Extended payload length    |\n     |I|S|S|S|  (4)  |A|     (7)     |             (16/64)           |\n     |N|V|V|V|       |S|             |   (if payload len==126/127)   |\n     | |1|2|3|       |K|             |                               |\n     +-+-+-+-+-------+-+-------------+ - - - - - - - - - - - - - - - +\n     |     Extended payload length continued, if payload len == 127  |\n     + - - - - - - - - - - - - - - - +-------------------------------+\n     |                               |Masking-key, if MASK set to 1  |\n     +-------------------------------+-------------------------------+\n     | Masking-key (continued)       |          Payload Data         |\n     +-------------------------------- - - - - - - - - - - - - - - - +\n     :                     Payload Data continued ...                :\n     + - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - +\n     |                     Payload Data continued ...                |\n     +---------------------------------------------------------------+\n\n\n\u6a2a\u5e454\u30d0\u30a4\u30c8\u5206\u306e\u8868\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002\n\u30d5\u30ec\u30fc\u30e0\u30d7\u30ed\u30c8\u30b3\u30eb\u306e\u5404\u8981\u7d20\u3092\u898b\u3066\u3044\u304d\u307e\u3059\u3002\u7aef\u6298\u3063\u3066\u3044\u308b\u306e\u3067\u3001\u8a73\u3057\u304f\u306f[RFC6455](http://tools.ietf.org/html/rfc6455#section-5.2)\u3092\u898b\u3066\u304f\u3060\u3055\u3044\u3002\n\n**FIN**\n\u9001\u3089\u308c\u305f\u30d5\u30ec\u30fc\u30e0\u304c\u6700\u5f8c\u306e\u30d5\u30e9\u30b0\u30e1\u30f3\u30c8\u3060\u3063\u305f\u5834\u5408\u306b1\u3002\n(Websocket\u3067\u306f\u30c7\u30fc\u30bf\u3092\u30d5\u30e9\u30b0\u30e1\u30f3\u30c8\u3068\u3044\u3046\u5358\u4f4d\u306b\u5206\u5272\u3057\u3066\u9001\u308b\u3053\u3068\u3082\u51fa\u6765\u307e\u3059\u3002)\n\n```rb\n(tcp_data.get_char(0) & 0b10000000) >> 7\n=> 1\n```\n\u4eca\u56de1\u3002\n\n**RSV1, RSV2, RSV3**\n0\u4ee5\u5916\u306e\u5024\u306b\u3066\u610f\u5473\u3092\u5b9a\u7fa9\u3059\u308b\u62e1\u5f35\u304c\u30cd\u30b4\u30b7\u30a8\u30fc\u30b7\u30e7\u30f3\u3055\u308c\u3066\u3044\u306a\u3044\u9650\u308a\u30010\u3067\u306a\u3051\u308c\u3070\u306a\u3089\u306a\u3044\u3002\u901a\u5e380\u3002\n\n```rb\n(tcp_data.get_char(0) & 0b01110000) >> 4\n=> 0\n```\n\u5168\u30660\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002\n\n**opcode**\nPayload data\u306e\u5f62\u5f0f\u3092\u6307\u5b9a\u3002\u5148\u7a0b\u30d5\u30a9\u30fc\u30e0\u304b\u3089\u9001\u4fe1\u3057\u305f\u30c7\u30fc\u30bf\u306b\u3042\u305f\u308b\u3002\u30c6\u30ad\u30b9\u30c8\u306e\u5834\u54081\u3002\u30d0\u30a4\u30ca\u30ea\u30c7\u30fc\u30bf\u3082Websocket\u3067\u9001\u4fe1\u53ef\u80fd\u3067\u3001\u305d\u306e\u5834\u54082\u3068\u306a\u308b\u3002\u305d\u306e\u4ed6\u3001\u63a5\u7d9aclose\u306e\u969b\u306e\u5024\u3084\u3001\u4eca\u5f8c\u306e\u62e1\u5f35\u306e\u305f\u3081\u306e\u4e88\u7d04\u6e08\u307f\u306e\u5024\u306a\u3069\u69d8\u3005\u6c7a\u3081\u3089\u308c\u3066\u3044\u308b\n\n```rb\ntcp_data.get_char(0) & 0b00001111\n=> 1\n```\n\n\u30c6\u30ad\u30b9\u30c8\u3092\u9001\u4fe1\u3057\u305f\u306e\u30671\u3002\n\n**Mask**\n1\u306e\u5834\u5408\u3001Payload data\u304cMasking-key\u3067\u30de\u30b9\u30af\u3055\u308c\u3066\u3044\u308b\u3002\n\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u304b\u3089\u30b5\u30fc\u30d0\u30fc\u3078\u306e\u9001\u4fe1\u306e\u5834\u5408\u306f1\u3002\n\n```rb\n(tcp_data.get_char(1) & 0b10000000) >> 7\n=> 1\n```\n\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u304b\u3089\u9001\u4fe1\u3057\u3066\u308b\u305f\u30811\u3002\n\n**Payload len**\nPayload data\u306e\u9577\u3055(\u30d0\u30a4\u30c8\u6570)\n\n```rb\ntcp_data.get_char(1) & 0b01111111\n=> 7\n```\n\n7\u30d0\u30a4\u30c8\u306e\u30c6\u30ad\u30b9\u30c8\u3067\u3042\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n\n**Extended payload length**\nPayload len\u304c126\u304b127\u3060\u3063\u305f\u5834\u5408\u306b\u6307\u5b9a\u3055\u308c\u308b\u306e\u3067\u3001\u4eca\u56de\u306f\u306a\u3057\u3002\n\n**Masking-key**\nMask\u304c1\u306e\u5834\u5408\u3001Masking-key\u304c\u5b58\u5728\u3059\u308b\u3002Payload Data\u3092\u30de\u30b9\u30ad\u30f3\u30b0\u3057\u3066\u3044\u308b\u3002\nTCP\u30c7\u30fc\u30bf\u306e3\u30d0\u30a4\u30c8\u76ee\u301c6\u30d0\u30a4\u30c8\u76ee\u3002\n\n**Payload Data**\nWebsocket\u306e\u30c7\u30fc\u30bf\u90e8\u3002\u5148\u7a0b\u30d5\u30a9\u30fc\u30e0\u304b\u3089\u9001\u4fe1\u3057\u305f\u30c6\u30ad\u30b9\u30c8\u306b\u3042\u305f\u308b\u3002\nTCP\u30c7\u30fc\u30bf\u306e7\u30d0\u30a4\u30c8\u76ee\u301c13\u30d0\u30a4\u30c8\u76ee\u3002\n\n#\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u30c7\u30fc\u30bf\u306e\u30a2\u30f3\u30de\u30b9\u30af\nMask\u304c\u9069\u7528\u3055\u308c\u3066\u3044\u308b\u306e\u3067\u30a2\u30f3\u30de\u30b9\u30af\u3057\u3066\u3042\u3052\u307e\u3059\u3002\nPayload Data\u306b\u5bfe\u3057\u3001Masking-key\u30921\u30d0\u30a4\u30c8\u305a\u3064XOR\u3059\u308b\u3068\u3001\u30a2\u30f3\u30de\u30b9\u30af\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\n```rb\nmasking_key_start_index = 2\npayload_start_index = 6\npayload_length = tcp_data.get_char(1) & 0b01111111\n\ndata = ''\npayload_length.times do |i|\n  # Masking-key\u306f4\u30d0\u30a4\u30c8\u3057\u304b\u306a\u3044\u305f\u3081\u3001\u305d\u308c\u3088\u308a\u3082Payload Data\u304c\u9577\u3044\u5834\u5408\u306f\u7e70\u308a\u8fd4\u3057\u9069\u7528\n  masking_key_index = masking_key_start_index + (i % 4)\n  masking_key_char = tcp_data.get_char(masking_key_index)\n\n  masked_char = tcp_data.get_char(payload_start_index + i)\n\n  # Masking-key\u3068Payload Data\u30921\u30d0\u30a4\u30c8\u305a\u3064XOR\n  data << (masking_key_char ^ masked_char)\nend\n```\n\n#\u30d1\u30b1\u30c3\u30c8\u89e3\u6790\u30b9\u30af\u30ea\u30d7\u30c8\u307e\u3068\u3081\n\u30d1\u30b1\u30c3\u30c8\u3092\u6e21\u3059\u3068\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u30c7\u30fc\u30bf\u304c\u8fd4\u308b\u30b9\u30af\u30ea\u30d7\u30c8\u3068\u3057\u3066\u3001\u4ee5\u4e0a\u3092\u307e\u3068\u3081\u307e\u3059\u3002\n\n```parse_packet.rb\ntcp_data = `tshark -r send.pcap -T fields -e data`.chomp\n\ndef tcp_data.get_char(n)\n  [self].pack(\"H*\")[n].unpack(\"C*\")[0]\nend\n\nmasking_key_start_index = 2\npayload_start_index = 6\npayload_length = tcp_data.get_char(1) & 0b01111111\n\ndata = ''\npayload_length.times do |i|\n  masking_key_index = masking_key_start_index + (i % 4)\n  masking_key_char = tcp_data.get_char(masking_key_index)\n\n  masked_char = tcp_data.get_char(payload_start_index + i)\n\n  data << (masking_key_char ^ masked_char)\nend\n\nputs data\n```\n\n\u5b9f\u884c\u3059\u308b\u3068\u3001\n\n```shell-session\n$ ruby parse_packet.rb\nma2saka\n```\n\n\u3067\u304d\u307e\u3057\u305f\uff01\n\u30a8\u30e9\u30fc\u51e6\u7406\u7121\u3057\u3001\u30c6\u30ad\u30b9\u30c8\u30c7\u30fc\u30bf\u306e\u307f\u3001125\u30d0\u30a4\u30c8\u4ee5\u4e0b\u306e\u30c7\u30fc\u30bf\u306e\u307f\u3001\u5225\u9014\u30d1\u30b1\u30c3\u30c8\u30ad\u30e3\u30d7\u30c1\u30e3\u304c\u5fc5\u8981\u3001\u306a\u3069\u8ab2\u984c\u306f\u3042\u308a\u307e\u3059\u304c\u4e00\u4f8b\u3092\u51fa\u305b\u305f\u306e\u3067\u3088\u3057\u3068\u3057\u307e\u3059\u3002\n\n\n#\u5f8c\u65e5\u8ac7\nWebsocket\u3068\u3044\u3048\u3070\u3001socket.io\u304c\u6709\u540d\u306a\u30e2\u30b8\u30e5\u30fc\u30eb\u306e\u3046\u3061\u306e\u4e00\u3064\u3067\u3059\u3002\n\u5f53\u521d\u3001Websocket\u3092\u52d5\u304b\u3059\u305f\u3081\u306bsocket.io\u4f7f\u3063\u3066\u305f\u306e\u3067\u3059\u304c\u3001\u30c7\u30fc\u30bf\u30d5\u30ec\u30fc\u30e0\u3092\u89e3\u6790\u3057\u3066\u307f\u308b\u3068\u3001\u30a2\u30f3\u30de\u30b9\u30af\u3057\u3066\u3082\u30c6\u30ad\u30b9\u30c8\u304c\u8b0e\u306e\u8a18\u53f7\u306e\u7f85\u5217\u3060\u3063\u305f\u308a\u3001**RSV1\u304c1**\u3060\u3063\u305f\u308a\u3001\u7d50\u5c40\u89e3\u8aad\u51fa\u6765\u305a\u4eca\u56de\u306ewebsocket\u30e2\u30b8\u30e5\u30fc\u30eb\u3092\u4f7f\u3044\u307e\u3057\u305f\u3002socket.io\u3067\u306f\u300c\u610f\u5473\u3092\u5b9a\u7fa9\u3059\u308b\u62e1\u5f35\u304c\u30cd\u30b4\u30b7\u30a8\u30fc\u30b7\u30e7\u30f3\u300d\u3055\u308c\u3066\u308b\u306e\u3067\u3057\u3087\u3046\u304b\u3002\n\n\u307e\u305fsocket.io\u3067\u306e\u901a\u4fe1\u30d1\u30b1\u30c3\u30c8\u3092\u773a\u3081\u3066\u3044\u308b\u3068\u3001\u540c\u3058\u30c6\u30ad\u30b9\u30c8\u3092\u8907\u6570\u56de\u9001\u4fe1\u3059\u308b\u3068\u3001TCP\u30c7\u30fc\u30bf\u9577\u304c\u77ed\u3044\u5024\u306b\u53ce\u307e\u3063\u3066\u3044\u304f\u50be\u5411\u306b\u3042\u308a\u307e\u3057\u305f\u3002\u66f4\u306b\u30c7\u30fc\u30bf\u91cf\u3092\u524a\u6e1b\u3059\u308b\u305f\u3081\u306b\u3001\u5185\u90e8\u3067\u5de5\u592b\u3057\u3066\u308b\u306e\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u3002\n\n\n\u660e\u65e5\u306f\u30aa\u30d5\u30a3\u30b9\u3067\u5e2d\u304c\u53f3\u96a3\u306e\u65b0\u5352\u540c\u671f @ktmg \u306b\u7d9a\u304d\u307e\u3059!!\n\n\n\n", "tags": ["websocket", "Ruby", "Wireshark", "\u30d1\u30b1\u30c3\u30c8\u30ad\u30e3\u30d7\u30c1\u30e3"]}