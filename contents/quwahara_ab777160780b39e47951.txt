{"context": "\n\n\u306f\u3058\u3081\u306b\nSpring Boot\u3068Angular JS\u306e\u7c21\u5358\u306aWeb\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306b\u3001Spring Security\u3092\u7d44\u307f\u8fbc\u3093\u3067\u307f\u307e\u3059\u3002\n\n\u53c2\u8003\n\u5143\u30cd\u30bf\u3067\u3059\u3002\nSpring Security and Angular JS\nhttps://spring.io/guides/tutorials/spring-security-and-angular-js/\n\n\u524d\u63d0\u6761\u4ef6\n\u4e0b\u306e\u8a18\u4e8b\u306e\u5f8c\u306e\u72b6\u614b\u3092\u524d\u63d0\u306b\u3057\u3066\u3044\u307e\u3059\nSpring Boot\u3068AngularUI UI-Router\u3092\u4f7f\u3063\u3066\u307f\u308b\n\n\u74b0\u5883\nJVM:          1.8.0_45 (Oracle Corporation 25.45-b02)\nOS:           Mac OS X 10.11.3 x86_64\n\nSpring Tool Suite\nVersion: 3.7.3.RELEASE\nBuild Id: 201602250940\nPlatform: Eclipse Mars.2 (4.5.2)\n(\u3053\u3061\u3089\u304b\u3089\u5165\u308c\u307e\u3057\u305f https://spring.io/tools/sts/all)\nBuildship: Eclipse Plug-ins for Gradle  1.0.13.v20160411-1723\n(Help -> Eclipse marketplace\u304b\u3089\u5165\u308c\u307e\u3057\u305f)\n\n\u624b\u9806\n\nSpring Security\u3092\u8ffd\u52a0\u3059\u308b\nSpring Security\u304c\u4f7f\u3048\u308b\u3088\u3046\u306b\u3001\u30d3\u30eb\u30c9\u30b9\u30af\u30ea\u30d7\u30c8\u306e\u4f9d\u5b58\u7269\u3068\u3057\u3066\u3001// Add\u3092\u8ffd\u8a18\u3057\u307e\u3059\u3002\n\nbuild.gradle\ndependencies {\n    compile 'org.webjars:jquery:2.2.3'\n    compile 'org.webjars:angularjs:1.5.3'\n    compile 'org.webjars:angular-ui-router:0.2.18'\n    compile 'org.webjars:bootstrap:3.3.6'\n\n    compile('org.springframework.boot:spring-boot-starter-web')\n    // Add\n    compile('org.springframework.boot:spring-boot-starter-security')\n    testCompile('org.springframework.boot:spring-boot-starter-test') \n}\n\n\n\n\u53c2\u8003\nSpring IO Platform Reference Guide\nV. Appendices\nA. Dependency versions\nhttp://docs.spring.io/platform/docs/2.0.3.RELEASE/reference/htmlsingle/#appendix-dependency-versions\n\u8ffd\u8a18\u3092\u53cd\u6620\u3059\u308b\u305f\u3081\u306b\u3001Package Explorer\u3067SSP37(\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u30eb\u30fc\u30c8)\u3092\u9078\u3073\u53f3\u30af\u30ea\u30c3\u30af\u3001\nGradle -> Refresh Gradle Project\n\u3092\u30af\u30ea\u30c3\u30af\u3057\u307e\u3059\u3002\nPackage Explorer\u306eProject and External Dependencies\u306b\u3001\u8ffd\u8a18\u3057\u305fJar\u3042\u308b\u304b\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\nBasic\u8a8d\u8a3c\u304c\u304b\u304b\u3063\u305f\u304b\u78ba\u8a8d\u3059\u308b\nSpring Security\u304c\u81ea\u52d5\u7684\u306b\u3001Security\u3092\u304b\u3051\u3066\u304f\u308c\u305f\u304b\u78ba\u8a8d\u3057\u307e\u3057\u3087\u3046\u3002\nWeb\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3092\u518d\u8d77\u52d5\u3057\u307e\u3059\u3002\nhttp://localhost:8080/index.html \u3092\u958b\u304d\u307e\u3059\u3002\nBasic\u8a8d\u8a3c\u30c0\u30a4\u30a2\u30ed\u30b0\u304c\u8868\u793a\u3055\u308c\u308b\u306f\u305a\u3067\u3059\u304c\u3001\u3044\u304b\u304b\u3067\u3057\u3087\u3046\u304b\u3002\n\n\u30e6\u30fc\u30b6\u30fc\u540d\u306buser\u3001\u30d1\u30b9\u30ef\u30fc\u30c9\u306b\u8d77\u52d5\u6642\u30ed\u30b0\u306b\u51fa\u529b\u3055\u308c\u308b\u30d1\u30b9\u30ef\u30fc\u30c9\u3092\u5165\u308c\u3001\u30ed\u30b0\u30a4\u30f3\u3057\u307e\u3059\u3002\n\u8d77\u52d5\u6642\u30ed\u30b0\u306e\u30d1\u30b9\u30ef\u30fc\u30c9\u4f8b\n\n\u753b\u9762\u304c\u8868\u793a\u3055\u308c\u308c\u3070OK\u3067\u3059\u3002\n\u8868\u793a\u3055\u308c\u306a\u3044\u5834\u5408\u306f\u3001\u30d6\u30e9\u30a6\u30b6\u30ad\u30e3\u30c3\u30b7\u30e5\u30af\u30ea\u30a2\u3084\u3001\u30b7\u30fc\u30af\u30ec\u30c3\u30c8\u30a6\u30a3\u30f3\u30c9\u30a6\u3067\u306e\u8868\u793a\u306a\u3069\u3092\u8a66\u3057\u3066\u307f\u3066\u4e0b\u3055\u3044\u3002\n\n\u30ed\u30b0\u30a4\u30f3\u30d5\u30a9\u30fc\u30e0\u3067\u8a8d\u8a3c\u3059\u308b\n\u3088\u308a\u6c4e\u7528\u6027\u306e\u3042\u308bSecurity\u3068\u3057\u3066\u3001\u30ed\u30b0\u30a4\u30f3\u30d5\u30a9\u30fc\u30e0\u3067\u306e\u8a8d\u8a3c\u3092\u884c\u3063\u3066\u307f\u307e\u3057\u3087\u3046\u3002\n\u3053\u308c\u306f\u4e0b\u306e\u8a18\u4e8b\u3092\u5143\u306b\u3057\u3066\u3044\u307e\u3059\u3002\n\n[TUTORIAL] Spring Security and Angular JS\nThe Login Page\nhttps://spring.io/guides/tutorials/spring-security-and-angular-js/#_the_login_page_angular_js_and_spring_security_part_ii\n\n\n\u9759\u7684\u30ea\u30bd\u30fc\u30b9\u3092\u516c\u958b\u3059\u308b\n\u73fe\u72b6\u3067\u306fJavaScript Library\u3084Html Template\u306a\u3069\u306e\u9759\u7684\u30ea\u30bd\u30fc\u30b9\u304c\u3001Spring Security\u306b\u3088\u3063\u3066\u4fdd\u8b77\u3055\u308c\u305f\u72b6\u614b\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002\n\u30ed\u30b0\u30a4\u30f3\u30d5\u30a9\u30fc\u30e0\u3092\u8868\u793a\u3059\u308b\u306b\u3082\u3001\u3053\u308c\u3089\u306e\u9759\u7684\u30ea\u30bd\u30fc\u30b9\u304c\u5fc5\u8981\u3067\u3059\u3002\n\u30ed\u30b0\u30a4\u30f3\u524d\u304b\u3089\u9759\u7684\u30ea\u30bd\u30fc\u30b9\u306b\u30a2\u30af\u30bb\u30b9\u3067\u304d\u308b\u3088\u3046\u306b\u3001Spring Security\u306e\u4fdd\u8b77\u304b\u3089\u5916\u3059\u8a2d\u5b9a\u3092\u3057\u307e\u3057\u3087\u3046\u3002\n\u4e0b\u306e// Add\u306e\u3088\u3046\u306b\u8a2d\u5b9aClass\u3092\u8ffd\u8a18\u3057\u307e\u3059\u3002\u3053\u308c\u3067webjars\u3084src/main/resources/static\u4e0b\u306b\u3042\u308b\u9759\u7684\u30ea\u30bd\u30fc\u30b9\u3078\u306e\u30a2\u30af\u30bb\u30b9\u3092\u8a31\u53ef\u3057\u307e\u3057\u305f\u3002\u305d\u308c\u4ee5\u5916\u3078\u306e\u30a2\u30af\u30bb\u30b9\u306f\u4fdd\u8b77\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n\nsrc/main/java/com/example/Ssp37Application.java\n@SpringBootApplication\n@Controller\npublic class Ssp37Application {\n    // Omit\n    // Add\n    @Configuration\n    @Order(SecurityProperties.ACCESS_OVERRIDE_ORDER)\n    protected static class SecurityConfiguration extends WebSecurityConfigurerAdapter {\n        @Override\n        protected void configure(HttpSecurity http) throws Exception {\n            http\n                .httpBasic()\n            .and()\n                .authorizeRequests()\n                    .antMatchers(\"/webjars/**\", \"/js/**\", \"/templates/**\", \"/index.html\", \"/\").permitAll()\n                    .anyRequest().authenticated();\n        }\n    }\n}\n\n\n\n\u30ed\u30b0\u30a4\u30f3\u30d5\u30a9\u30fc\u30e0\u306e\u8a8d\u8a3c\u5148\u306b\u306a\u308bendpoint\u3092RestController\u306b\u4f5c\u308b\n\u30b5\u30fc\u30d0\u5074\u306eMyRestController\u306b\u3001\u8a8d\u8a3c\u306e\u305f\u3081\u306e/user\u3068\u3044\u3046endpoint\u3092\u8ffd\u52a0\u3057\u307e\u3059\u3002\n\nsrc/main/java/com/example/controllers/MyRestController.java\n@RestController\npublic class MyRestController {\n    // Omit\n    // Add\n    @RequestMapping(\"/user\")\n    public Principal user(Principal user) {\n        return user;\n    }\n\n}\n\n\n\u3053\u306e/user\u3092\u4f7f\u3063\u305f\u8a8d\u8a3c\u306f\u6b21\u306e\u3088\u3046\u306a\u624b\u9806\u3092\u8e0f\u307f\u307e\u3059\u3002\n\u307e\u305a\u30ed\u30b0\u30a4\u30f3\u30d5\u30a9\u30fc\u30e0\u306f/user\u3078\u3001\u8a8d\u8a3c\u306e\u305f\u3081\u306bGet\u30ea\u30af\u30a8\u30b9\u30c8\u3057\u307e\u3059\u3002\n\u305d\u306e\u30ea\u30af\u30a8\u30b9\u30c8\u30d8\u30c3\u30c0\u30fc\u306b\u3001\u30e6\u30fc\u30b6\u30fc\u540d\u3068\u30d1\u30b9\u30ef\u30fc\u30c9\u3092\u542b\u3081\u307e\u3059\u3002\n\u30b5\u30fc\u30d0\u5074\u3067\u305d\u306e\u30ea\u30af\u30a8\u30b9\u30c8\u306f\u3001/user\u306b\u5bfe\u5fdc\u4ed8\u3051\u3089\u308c\u305fuser()\u30e1\u30bd\u30c3\u30c9\u3088\u308a\u3082\u524d\u306b\u3001Spring Security\u304c\u6355\u6349\u3057\u307e\u3059\u3002\nSpring Security\u306f\u30ea\u30af\u30a8\u30b9\u30c8\u30d8\u30c3\u30c0\u30fc\u306e\u30e6\u30fc\u30b6\u30fc\u540d\u3068\u30d1\u30b9\u30ef\u30fc\u30c9\u3092\u78ba\u8a8d\u3057\u3001\u8a8d\u3081\u3089\u308c\u306a\u3044\u3082\u306e\u306a\u3089\u3070\u3001401 (Unauthorized)\u3092\u5fdc\u7b54\u3057\u307e\u3059\u3002user()\u30e1\u30bd\u30c3\u30c9\u306b\u51e6\u7406\u304c\u6e21\u308a\u307e\u305b\u3093\u3002\n\u8a8d\u3081\u3089\u308c\u308b\u3082\u306e\u306a\u3089\u3070\u3001\u73fe\u5728\u8a8d\u8a3c\u3055\u308c\u3066\u3044\u308buser\u60c5\u5831\u3092\u5f15\u6570\u306b\u3001user()\u30e1\u30bd\u30c3\u30c9\u306b\u51e6\u7406\u304c\u6e21\u308a\u307e\u3059\u3002\n\u305d\u3057\u3066user()\u30e1\u30bd\u30c3\u30c9\u3067\u305d\u306e\u307e\u307e\u3001user\u60c5\u5831\u3092200 (OK)\u3068\u3068\u3082\u306b\u3001\u5fdc\u7b54\u3057\u307e\u3059\u3002\n\n\u8a8d\u8a3c\u3092\u884c\u3046auth\u3092factory\u306b\u4f5c\u308b\n\u30d6\u30e9\u30a6\u30b6\u5074\u306b\u306flogin/logout\u51e6\u7406\u3068\u3001\u305d\u306e\u51e6\u7406\u7d50\u679c\u306e\u72b6\u614b\u3092\u6301\u3064auth(\u30b5\u30fc\u30d3\u30b9)\u3092\u4f5c\u308a\u307e\u3057\u3087\u3046\u3002\nlogin\u3067\u306f\u5148\u307b\u3069\u306e/user\u306b\u30a2\u30af\u30bb\u30b9\u3057\u307e\u3059\u3002\u305d\u306e\u969b\u3001\u30ea\u30af\u30a8\u30b9\u30c8\u30d8\u30c3\u30c0\u30fc\u306b\u3001\u30e6\u30fc\u30b6\u30fc\u540d\u3068\u30d1\u30b9\u30ef\u30fc\u30c9\u3092\u542b\u3081\u307e\u3059\u3002\u6210\u529f\u3057\u305f\u3089\u8a8d\u8a3c\u6e08\u3068\u3057\u3066authenticated\u3092true\u306b\u3057\u3001\u30e6\u30fc\u30b6\u30fc\u60c5\u5831\u3092principal\u306b\u6301\u3061\u307e\u3059\u3002\nlogout\u3067\u306fSpring Security\u304c\u7528\u610f\u3057\u3066\u3044\u308blogout\u7528\u306eendpoint\u306b\u30a2\u30af\u30bb\u30b9\u3057\u3066\u3001\u30ed\u30b0\u30a4\u30f3\u60c5\u5831\u3092\u7834\u68c4\u3057\u307e\u3059\u3002\n\nsrc/main/resources/static/js/app.js\nangular.module('ssp37App', ['ui.router'])\n    // Omit\n    // Add\n    .factory('auth', function($http, $q) {\n        return {\n            authenticated: false,\n            principal: {},\n            login: function(credentials) {\n                var self = this\n                var headers = credentials\n                ? { authorization : \"Basic \" + btoa(credentials.username + \":\" + credentials.password) }\n                : {};\n                return $http.get('/user', {headers : headers})\n                .then(function(response) {\n                    self.authenticated = true\n                    self.principal = response.data\n                    return response;\n                })\n                .catch(function(response) {\n                    self.authenticated = false\n                    self.principal = {}                    \n                    return $q.reject(response);\n                });\n            },\n            logout: function() {\n                var self = this\n                return $http.post(\"/logout\", {})\n                .finally(function() {\n                    self.authenticated = false\n                    self.principal = {}                    \n                });\n            }\n        };\n    })\n    // Omit\n    ;\n\n\n\nstate\u306e\u30de\u30c3\u30d4\u30f3\u30b0\u3084auth\u3092\u5229\u7528\u3059\u308bController\u306e\u4f5c\u6210\n\u307e\u305aURL\u304c\u3069\u306estate\u306b\u3082\u5f53\u3066\u306f\u307e\u3089\u306a\u3044\u3068\u304d\u306e\u3001\u65e2\u5b9a\u5024\u3068\u3057\u3066otherwise(\"/login\")\u3092\u6307\u5b9a\u3057\u307e\u3057\u305f\u3002\n\u307e\u305fBasic\u8a8d\u8a3c\u30c0\u30a4\u30a2\u30ed\u30b0\u3092\u6291\u5236\u3059\u308b\u305f\u3081\u306b\u3001X-Requested-With\u3092\u30d8\u30c3\u30c0\u30fc\u306b\u4ed8\u4e0e\u3059\u308b\u3088\u3046\u306b\u3057\u3066\u3044\u307e\u3059\u3002\nstate\u306b\u306flogin\u3068logout\u3092\u5c0e\u5165\u3057\u3001\u305d\u308c\u305e\u308cController\u3092\u95a2\u9023\u4ed8\u3051\u3066\u3044\u307e\u3059\u3002\nLoginCtrl\u3067\u306f\u3001\u30ed\u30b0\u30a4\u30f3\u51e6\u7406\u306e\u72b6\u614b\u3092\u6301\u3064\u9805\u76ee\u3068\u3001auth.login\u3092\u547c\u3073\u51fa\u3057\u3066\u7d50\u679c\u3092\u72b6\u614b\u306b\u53cd\u6620\u3059\u308b\u95a2\u6570\u3092\u3001$scope\u306b\u4f5c\u3063\u3066\u3044\u307e\u3059\u3002\nauth.login\u547c\u3073\u51fa\u3057\u3067\u8a8d\u8a3c\u3055\u308c\u308b\u3068\u3001hello state\u3078\u9077\u79fb\u3057\u307e\u3059\u3002\nLogoutCtrl\u3067\u306f\u3001auth.logout\u3092\u547c\u3073\u51fa\u3057\u3001\u305d\u306e\u5f8c\u3001login state\u3078\u9077\u79fb\u3059\u308b\u3088\u3046\u306b\u3057\u3066\u3044\u307e\u3059\u3002\n\nsrc/main/resources/static/js/app.js\nangular.module('ssp37App', ['ui.router'])\n    .config(function($stateProvider, $urlRouterProvider, $httpProvider) {\n        // Change\n        $urlRouterProvider.otherwise(\"/login\")\n        $stateProvider\n            // Add\n            .state('login', {\n                url: \"/login\",\n                templateUrl: \"templates/login.html\",\n                controller: \"LoginCtrl\"\n            })\n            // Add\n            .state('logout', {\n                url: \"/logout\",\n                controller: \"LogoutCtrl\"\n            })\n            // Omit\n            ;\n        // Add\n        $httpProvider.defaults.headers.common[\"X-Requested-With\"] = 'XMLHttpRequest';\n    })\n    // Omit\n    // Add\n    .controller('LoginCtrl', function($scope, $state, auth) {\n        $scope.error = false\n        $scope.authenticated = auth.authenticated\n        $scope.credentials = { username: \"\", password: \"\" }\n        $scope.login = function(credentials) {\n            return auth.login(credentials)\n            .finally(function() {\n                $scope.error = !auth.authenticated\n                $scope.authenticated = auth.authenticated\n                if($scope.authenticated) {\n                    $state.go(\"hello\")\n                }\n            });\n        }\n    })\n    // Add\n    .controller('LogoutCtrl', function($state, auth) {\n        auth.logout()\n        .finally(function() {\n            $state.go(\"login\")\n        });\n    })\n    // Omit\n    ;\n\n\n\n\u30ed\u30b0\u30a4\u30f3\u30d5\u30a9\u30fc\u30e0\u3092\u4f5c\u308b\n\u30ed\u30b0\u30a4\u30f3\u30d5\u30a9\u30fc\u30e0\u306fLoginCtrl\u3067\\$scope\u306b\u4f5c\u3063\u305f\u9805\u76ee\u3068\u95a2\u9023\u3057\u3066\u3044\u307e\u3059\u3002\nLogin\u30dc\u30bf\u30f3\u3092\u62bc\u3059\u3068\u3001\\$scope.login\u95a2\u6570\u304c\u30e6\u30fc\u30b6\u30fc\u540d\u3068\u30d1\u30b9\u30ef\u30fc\u30c9\u3092\u6301\u3064credentials\u3092\u5f15\u6570\u306b\u547c\u3073\u51fa\u3055\u308c\u3001auth.login\u3092\u884c\u3044\u307e\u3059\u3002\n\u3082\u3057\u8a8d\u8a3c\u304c\u5931\u6557\u3057\u305f\u3089\u3001ng-show\u30c7\u30a3\u30ec\u30af\u30c6\u30a3\u30d6\u3092\u6301\u3064<div>\u30bf\u30b0\u304c\u6709\u52b9\u306b\u306a\u308a\u3001\u30a8\u30e9\u30fc\u30e1\u30c3\u30bb\u30fc\u30b8\u304c\u8868\u793a\u3055\u308c\u307e\u3059\u3002\n\nsrc/main/resources/static/templates/login.html\n<div class=\"alert alert-danger\" ng-show=\"error\">\n    There was a problem logging in. Please try again.\n</div>\n<form role=\"form\" ng-submit=\"login(credentials)\">\n    <div class=\"form-group\">\n        <label for=\"username\">Username:</label>\n        <input type=\"text\" class=\"form-control\" id=\"username\" name=\"username\" ng-model=\"credentials.username\"/>\n    </div>\n    <div class=\"form-group\">\n        <label for=\"password\">Password:</label>\n        <input type=\"password\" class=\"form-control\" id=\"password\" name=\"password\" ng-model=\"credentials.password\"/>\n    </div>\n    <button type=\"submit\" class=\"btn btn-primary\">Login</button>\n</form>\n\n\n\n\u30ca\u30d3\u30b2\u30fc\u30b7\u30e7\u30f3\u306blogin/logout\u3092\u8ffd\u52a0\u3059\u308b\n\u30ca\u30d3\u30b2\u30fc\u30b7\u30e7\u30f3\u306e\u9805\u76ee\u306blogin/logout\u3092\u8ffd\u52a0\u3057\u307e\u3057\u305f\u3002\n\nsrc/main/resources/static/index.html\n<html ng-app=\"ssp37App\">\n<head>\n<meta charset=\"utf-8\">\n<title>SSP37</title>\n<link rel=\"stylesheet\" href=\"webjars/bootstrap/3.3.6/css/bootstrap.min.css\">\n</head>\n<body>\n    <div class=\"container\">\n        <!-- Change -->\n        <ul class=\"nav nav-pills\" role=\"tablist\" ng-controller=\"NavCtrl\">\n            <!-- Add -->\n            <li><a ui-sref=\"login\"  ng-hide=\"auth.authenticated\">login</a></li>\n            <!-- Add -->\n            <li><a ui-sref=\"logout\" ng-show=\"auth.authenticated\">logout</a></li>\n            <li><a ui-sref=\"hello\"  >hello</a></li>\n            <li><a ui-sref=\"blue\"   >blue</a></li>\n            <li><a ui-sref=\"green\"  >green</a></li>\n        </ul>\n    </div>\n    <div ui-view class=\"container\"></div>\n    <script src=\"webjars/jquery/2.2.3/jquery.min.js\"></script>\n    <script src=\"webjars/bootstrap/3.3.6/js/bootstrap.min.js\"></script>\n    <script src=\"webjars/angularjs/1.5.3/angular.min.js\"></script>\n    <script src=\"webjars/angular-ui-router/0.2.18/angular-ui-router.min.js\"></script>\n    <script src=\"js/app.js\"></script>\n</body>\n</html>\n\n\n\u307e\u305f\u305d\u306elogin/logout\u306e\u8868\u793a\u3092\u5207\u66ff\u3048\u308b\u3001NavCtrl\u3092\u8ffd\u52a0\u3057\u307e\u3057\u305f\u3002\n\nsrc/main/resources/static/js/app.js\nangular.module('ssp37App', ['ui.router'])\n    // Omit\n    // Add\n    .controller('NavCtrl', function($scope, auth) {\n        $scope.auth = auth\n    })\n    // Omit\n    ;\n\n\n\n\u52d5\u4f5c\u78ba\u8a8d\u3059\u308b\n\u3053\u306e\u6bb5\u968e\u3067login->hello\u8868\u793a->logout\u304c\u3067\u304d\u308b\u306f\u305a\u306a\u306e\u3067\u8a66\u3057\u3066\u307f\u307e\u3057\u3087\u3046\u3002\nhttp://localhost:8080/index.html \u3092\u958b\u304d\u307e\u3059\u3002\n\u30ed\u30b0\u30a4\u30f3\u30d5\u30a9\u30fc\u30e0\u304c\u3067\u308b\u3067\u3057\u3087\u3046\u304b\u3002\nBasic\u8a8d\u8a3c\u306e\u3068\u304d\u3068\u540c\u3058\u3088\u3046\u306b\u3001\u30e6\u30fc\u30b6\u30fc\u540d\u306buser\u3001\u30d1\u30b9\u30ef\u30fc\u30c9\u306b\u8d77\u52d5\u6642\u30ed\u30b0\u306b\u51fa\u529b\u3055\u308c\u308b\u30d1\u30b9\u30ef\u30fc\u30c9\u3092\u5165\u308c\u3001\u30ed\u30b0\u30a4\u30f3\u3057\u307e\u3059\u3002\nhello\u306b\u9077\u79fb\u3057\u307e\u3059\u3002\n\u6b21\u306blogout\u3092\u30af\u30ea\u30c3\u30af\u3057\u307e\u3059\u3002\n\u3059\u308b\u3068403 (Forbidden)\u306e\u30a8\u30e9\u30fc\u306b\u306a\u3063\u3066\u3057\u307e\u3044\u307e\u3059\u3002\n\u3053\u308c\u306fSpring Security\u304c\u65e2\u5b9a\u3067\u3001logout\u3078\u306ePost\u3092CSRF\u304b\u3089\u4fdd\u8b77\u3057\u3066\u3044\u308b\u305f\u3081\u3067\u3059\u3002\n\u3053\u306e\u4fdd\u8b77\u306b\u5f93\u3063\u3066\u52d5\u4f5c\u3059\u308b\u3088\u3046\u306b\u3057\u307e\u3057\u3087\u3046\u3002\n\nCSRF Token\u3092\u53d6\u308a\u6271\u3044\u65b9\nCSRF\u306e\u4fdd\u8b77\u306f\u6b21\u306e\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002\n\u30b5\u30fc\u30d0\u5074\u3067Token\u3092\u751f\u6210\u3057\u3001Cookie\u3067\u30d6\u30e9\u30a6\u30b6\u306b\u6e21\u3057\u307e\u3059\u3002\n\u30d6\u30e9\u30a6\u30b6\u306fPost\u3092\u3059\u308b\u6642\u306b\u3001\u305d\u306eToken\u3092\u30d8\u30c3\u30c0\u30fc\u306b\u5165\u308c\u3066\u8fd4\u5374\u3057\u307e\u3059\u3002\nPost\u3092\u53d7\u3051\u53d6\u3063\u305f\u30b5\u30fc\u30d0\u306f\u3001\u305d\u306eToken\u3092\u898b\u3066\u6e21\u3057\u305f\u3068\u304d\u3068\u540c\u5024\u304b\u78ba\u8a8d\u3059\u308b\u3053\u3068\u3067\u3001\u4fdd\u8b77\u3057\u3066\u3044\u307e\u3059\u3002\nAngularJS\u3067\u306f\u65e2\u5b9a\u3067\u3053\u306e\u52d5\u4f5c\u3092\u63d0\u4f9b\u3057\u3066\u3044\u307e\u3059\u3002\n\u30af\u30c3\u30ad\u30fc\u540d\u3001XSRF-TOKEN\u3092\u53d7\u3051\u53d6\u308b\u3068\u3001\u305d\u306e\u5024\u3092\u30d8\u30c3\u30c0\u30fc\u540d\u3001X-XSRF-TOKEN\u3067\u8fd4\u5374\u3057\u3066\u304f\u308c\u307e\u3059\u3002\n\u30b5\u30fc\u30d0\u5074\u304b\u3089\u305d\u306e\u3088\u3046\u306a\u540d\u524d\u306e\u30af\u30c3\u30ad\u30fc\u3067Token\u3092\u9001\u4fe1\u3057\u3001\u30d8\u30c3\u30c0\u30fc\u304b\u3089\u53d7\u3051\u53d6\u308b\u3088\u3046\u306b\u3057\u307e\u3057\u3087\u3046\u3002\n\nXSRF-TOKEN\u30af\u30c3\u30ad\u30fc\u3092\u9001\u308b\nSpring Security\u306fCSRF\u306eToken\u3092\u3001CsrfFilter\u3067request\u306eattribute\u306b\u7528\u610f\u3057\u3066\u304f\u308c\u3066\u3044\u307e\u3059\u3002\n\u305d\u306eCsrfFilter\u306e\u5f8c\u306b\u7d9a\u304f\u3088\u3046\u306b\u3001\u30af\u30c3\u30ad\u30fc\u3092\u9001\u308bFilter\u3092\u8ffd\u52a0\u3057\u307e\u3059\u3002\uff08addFilterAfter()\uff09\n\u30af\u30c3\u30ad\u30fc\u3092\u9001\u308bFilter\u306e\u4e2d\u3067\u3001\u305d\u306eToken\u3092Cookie\u306b\u5165\u308c\u307e\u3059\u3002(csrfHeaderFilter())\n\nsrc/main/java/com/example/Ssp37Application.java\n@SpringBootApplication\n@Controller\npublic class Ssp37Application {\n    // Omit\n    @Configuration\n    @Order(SecurityProperties.ACCESS_OVERRIDE_ORDER)\n    protected static class SecurityConfiguration extends WebSecurityConfigurerAdapter {\n        @Override\n        protected void configure(HttpSecurity http) throws Exception {\n            http\n                .httpBasic()\n            .and()\n                .authorizeRequests()\n                    .antMatchers(\"/webjars/**\", \"/js/**\", \"/templates/**\", \"/index.html\", \"/\").permitAll()\n                    .anyRequest().authenticated()\n            .and()\n                // Add\n                .addFilterAfter(csrfHeaderFilter(), CsrfFilter.class)\n            ;\n        }\n\n        // Add\n        private Filter csrfHeaderFilter() {\n            return new OncePerRequestFilter() {\n                @Override\n                protected void doFilterInternal(HttpServletRequest request,\n                        HttpServletResponse response, FilterChain filterChain)\n                        throws ServletException, IOException {\n                    CsrfToken csrf = (CsrfToken) request.getAttribute(CsrfToken.class\n                            .getName());\n                    if (csrf != null) {\n                        Cookie cookie = WebUtils.getCookie(request, \"XSRF-TOKEN\");\n                        String token = csrf.getToken();\n                        if (cookie == null || token != null\n                                && !token.equals(cookie.getValue())) {\n                            cookie = new Cookie(\"XSRF-TOKEN\", token);\n                            cookie.setPath(\"/\");\n                            response.addCookie(cookie);\n                        }\n                    }\n                    filterChain.doFilter(request, response);\n                }\n            };\n        }\n    }\n}\n\n\n\nX-XSRF-TOKEN\u30d8\u30c3\u30c0\u30fc\u3092\u53d7\u3051\u53d6\u308b\nCSRF\u306eToken\u3092\u30d8\u30c3\u30c0\u30fc\u540d\u3001X-XSRF-TOKEN\u3067\u53d7\u3051\u53d6\u308c\u308b\u3088\u3046\u306aCsrfTokenRepository\u3092\u7528\u610f\u3057\u307e\u3059\u3002(csrfTokenRepository())\n\u305d\u308c\u3092Spring Security\u306b\u8a2d\u5b9a\u3057\u307e\u3059\u3002(http.csrf().csrfTokenRepository())\n\nsrc/main/java/com/example/Ssp37Application.java\n@SpringBootApplication\n@Controller\npublic class Ssp37Application {\n    // Omit\n    @Configuration\n    @Order(SecurityProperties.ACCESS_OVERRIDE_ORDER)\n    protected static class SecurityConfiguration extends WebSecurityConfigurerAdapter {\n        @Override\n        protected void configure(HttpSecurity http) throws Exception {\n            http\n                .httpBasic()\n            .and()\n                .authorizeRequests()\n                    .antMatchers(\"/webjars/**\", \"/js/**\", \"/templates/**\", \"/index.html\", \"/\").permitAll()\n                    .anyRequest().authenticated()\n            .and()\n                // Add\n                .addFilterAfter(csrfHeaderFilter(), CsrfFilter.class)\n                // Add\n                .csrf()\n                    .csrfTokenRepository(csrfTokenRepository())\n            ;\n        }\n\n        // Omit\n\n        // Add\n        private CsrfTokenRepository csrfTokenRepository() {\n            HttpSessionCsrfTokenRepository repository = new HttpSessionCsrfTokenRepository();\n            repository.setHeaderName(\"X-XSRF-TOKEN\");\n            return repository;\n        }\n    }\n}\n\n\n\n\u518d\u3073\u52d5\u4f5c\u78ba\u8a8d\u3059\u308b\n403 (Forbidden)\u306b\u306a\u3089\u305alogout\u3067\u304d\u308b\u306f\u305a\u306a\u306e\u3067\u8a66\u3057\u3066\u307f\u307e\u3057\u3087\u3046\u3002\nWeb\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3092\u518d\u8d77\u52d5\u3057\u3066\u3001 http://localhost:8080/index.html \u3092\u958b\u304d\u307e\u3059\u3002\nBasic\u8a8d\u8a3c\u306e\u3068\u304d\u3068\u540c\u3058\u3088\u3046\u306b\u3001\u30e6\u30fc\u30b6\u30fc\u540d\u306buser\u3001\u30d1\u30b9\u30ef\u30fc\u30c9\u306b\u8d77\u52d5\u6642\u30ed\u30b0\u306b\u51fa\u529b\u3055\u308c\u308b\u30d1\u30b9\u30ef\u30fc\u30c9\u3092\u5165\u308c\u3001\u30ed\u30b0\u30a4\u30f3\u3057\u307e\u3059\u3002\nhello\u306b\u9077\u79fb\u3057\u307e\u3059\u3002\n\u6b21\u306blogout\u3092\u30af\u30ea\u30c3\u30af\u3057\u307e\u3059\u3002\n\u3059\u308b\u3068\u4eca\u5ea6\u306fGET http://localhost:8080/login?logout 401 (Unauthorized)\u306b\u306a\u308a\u307e\u3059\u3002\n\u3053\u308c\u306fSpring Security\u304c\u65e2\u5b9a\u3067\u3001logout\u5f8c\u306b\u8868\u793a\u3059\u308b\u30da\u30fc\u30b8\u3078Redirection\u3092\u3057\u3066\u3044\u308b\u304b\u3089\u3067\u3059\u3002\n\u3061\u3087\u3063\u3068\u6c17\u6301\u3061\u60aa\u3044\u3067\u3059\u304c\u3001Unauthorized\u306b\u306a\u3063\u3066\u3044\u308b\u306e\u3067\u3001logout\u306b\u3088\u3063\u3066\u8a8d\u8a3c\u304c\u5207\u308c\u3066\u3044\u308b\u3088\u3046\u3067\u3059\u3002\n\n\u53c2\u8003\nSample Repository\nhttps://github.com/quwahara/SSP37/tree/510-security\n\n# \u306f\u3058\u3081\u306b\n\nSpring Boot\u3068Angular JS\u306e\u7c21\u5358\u306aWeb\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306b\u3001Spring Security\u3092\u7d44\u307f\u8fbc\u3093\u3067\u307f\u307e\u3059\u3002\n\n## \u53c2\u8003\n\n\u5143\u30cd\u30bf\u3067\u3059\u3002\nSpring Security and Angular JS\nhttps://spring.io/guides/tutorials/spring-security-and-angular-js/\n\n# \u524d\u63d0\u6761\u4ef6\n\n\u4e0b\u306e\u8a18\u4e8b\u306e\u5f8c\u306e\u72b6\u614b\u3092\u524d\u63d0\u306b\u3057\u3066\u3044\u307e\u3059\n[Spring Boot\u3068AngularUI UI-Router\u3092\u4f7f\u3063\u3066\u307f\u308b](http://qiita.com/quwahara/items/658078100c2597cab30c)\n\n# \u74b0\u5883\n\nJVM:          1.8.0_45 (Oracle Corporation 25.45-b02)\nOS:           Mac OS X 10.11.3 x86_64\n\n## Spring Tool Suite\n\nVersion: 3.7.3.RELEASE\nBuild Id: 201602250940\nPlatform: Eclipse Mars.2 (4.5.2)\n(\u3053\u3061\u3089\u304b\u3089\u5165\u308c\u307e\u3057\u305f https://spring.io/tools/sts/all)\n\nBuildship: Eclipse Plug-ins for Gradle\t1.0.13.v20160411-1723\n(Help -> Eclipse marketplace\u304b\u3089\u5165\u308c\u307e\u3057\u305f)\n\n# \u624b\u9806\n\n## Spring Security\u3092\u8ffd\u52a0\u3059\u308b\n\nSpring Security\u304c\u4f7f\u3048\u308b\u3088\u3046\u306b\u3001\u30d3\u30eb\u30c9\u30b9\u30af\u30ea\u30d7\u30c8\u306e\u4f9d\u5b58\u7269\u3068\u3057\u3066\u3001// Add\u3092\u8ffd\u8a18\u3057\u307e\u3059\u3002\n\n```groovy:build.gradle\ndependencies {\n\tcompile 'org.webjars:jquery:2.2.3'\n\tcompile 'org.webjars:angularjs:1.5.3'\n\tcompile 'org.webjars:angular-ui-router:0.2.18'\n\tcompile 'org.webjars:bootstrap:3.3.6'\n\n\tcompile('org.springframework.boot:spring-boot-starter-web')\n\t// Add\n\tcompile('org.springframework.boot:spring-boot-starter-security')\n\ttestCompile('org.springframework.boot:spring-boot-starter-test') \n}\n```\n\n### \u53c2\u8003\n\nSpring IO Platform Reference Guide\nV. Appendices\nA. Dependency versions\nhttp://docs.spring.io/platform/docs/2.0.3.RELEASE/reference/htmlsingle/#appendix-dependency-versions\n\n\u8ffd\u8a18\u3092\u53cd\u6620\u3059\u308b\u305f\u3081\u306b\u3001Package Explorer\u3067SSP37(\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u30eb\u30fc\u30c8)\u3092\u9078\u3073\u53f3\u30af\u30ea\u30c3\u30af\u3001\nGradle -> Refresh Gradle Project\n\u3092\u30af\u30ea\u30c3\u30af\u3057\u307e\u3059\u3002\nPackage Explorer\u306eProject and External Dependencies\u306b\u3001\u8ffd\u8a18\u3057\u305fJar\u3042\u308b\u304b\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n## Basic\u8a8d\u8a3c\u304c\u304b\u304b\u3063\u305f\u304b\u78ba\u8a8d\u3059\u308b\n\nSpring Security\u304c\u81ea\u52d5\u7684\u306b\u3001Security\u3092\u304b\u3051\u3066\u304f\u308c\u305f\u304b\u78ba\u8a8d\u3057\u307e\u3057\u3087\u3046\u3002\nWeb\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3092\u518d\u8d77\u52d5\u3057\u307e\u3059\u3002\nhttp://localhost:8080/index.html \u3092\u958b\u304d\u307e\u3059\u3002\nBasic\u8a8d\u8a3c\u30c0\u30a4\u30a2\u30ed\u30b0\u304c\u8868\u793a\u3055\u308c\u308b\u306f\u305a\u3067\u3059\u304c\u3001\u3044\u304b\u304b\u3067\u3057\u3087\u3046\u304b\u3002\n\n![\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2016-04-15 10.26.34.png](https://qiita-image-store.s3.amazonaws.com/0/77421/a2802e9d-00ab-89c2-b636-a9f71d6644fa.png)\n\n\u30e6\u30fc\u30b6\u30fc\u540d\u306buser\u3001\u30d1\u30b9\u30ef\u30fc\u30c9\u306b\u8d77\u52d5\u6642\u30ed\u30b0\u306b\u51fa\u529b\u3055\u308c\u308b\u30d1\u30b9\u30ef\u30fc\u30c9\u3092\u5165\u308c\u3001\u30ed\u30b0\u30a4\u30f3\u3057\u307e\u3059\u3002\n\n\u8d77\u52d5\u6642\u30ed\u30b0\u306e\u30d1\u30b9\u30ef\u30fc\u30c9\u4f8b\n![\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2016-04-15 10.26.15.png](https://qiita-image-store.s3.amazonaws.com/0/77421/fb5f814f-38d3-86fb-ece5-38a63d112aed.png)\n\n\u753b\u9762\u304c\u8868\u793a\u3055\u308c\u308c\u3070OK\u3067\u3059\u3002\n\u8868\u793a\u3055\u308c\u306a\u3044\u5834\u5408\u306f\u3001\u30d6\u30e9\u30a6\u30b6\u30ad\u30e3\u30c3\u30b7\u30e5\u30af\u30ea\u30a2\u3084\u3001\u30b7\u30fc\u30af\u30ec\u30c3\u30c8\u30a6\u30a3\u30f3\u30c9\u30a6\u3067\u306e\u8868\u793a\u306a\u3069\u3092\u8a66\u3057\u3066\u307f\u3066\u4e0b\u3055\u3044\u3002\n\n## \u30ed\u30b0\u30a4\u30f3\u30d5\u30a9\u30fc\u30e0\u3067\u8a8d\u8a3c\u3059\u308b\n\n\u3088\u308a\u6c4e\u7528\u6027\u306e\u3042\u308bSecurity\u3068\u3057\u3066\u3001\u30ed\u30b0\u30a4\u30f3\u30d5\u30a9\u30fc\u30e0\u3067\u306e\u8a8d\u8a3c\u3092\u884c\u3063\u3066\u307f\u307e\u3057\u3087\u3046\u3002\n\u3053\u308c\u306f\u4e0b\u306e\u8a18\u4e8b\u3092\u5143\u306b\u3057\u3066\u3044\u307e\u3059\u3002\n\n> \\[TUTORIAL\\] Spring Security and Angular JS\n> The Login Page\n> https://spring.io/guides/tutorials/spring-security-and-angular-js/#_the_login_page_angular_js_and_spring_security_part_ii\n\n### \u9759\u7684\u30ea\u30bd\u30fc\u30b9\u3092\u516c\u958b\u3059\u308b\n\n\u73fe\u72b6\u3067\u306fJavaScript Library\u3084Html Template\u306a\u3069\u306e\u9759\u7684\u30ea\u30bd\u30fc\u30b9\u304c\u3001Spring Security\u306b\u3088\u3063\u3066\u4fdd\u8b77\u3055\u308c\u305f\u72b6\u614b\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002\n\u30ed\u30b0\u30a4\u30f3\u30d5\u30a9\u30fc\u30e0\u3092\u8868\u793a\u3059\u308b\u306b\u3082\u3001\u3053\u308c\u3089\u306e\u9759\u7684\u30ea\u30bd\u30fc\u30b9\u304c\u5fc5\u8981\u3067\u3059\u3002\n\u30ed\u30b0\u30a4\u30f3\u524d\u304b\u3089\u9759\u7684\u30ea\u30bd\u30fc\u30b9\u306b\u30a2\u30af\u30bb\u30b9\u3067\u304d\u308b\u3088\u3046\u306b\u3001Spring Security\u306e\u4fdd\u8b77\u304b\u3089\u5916\u3059\u8a2d\u5b9a\u3092\u3057\u307e\u3057\u3087\u3046\u3002\n\u4e0b\u306e// Add\u306e\u3088\u3046\u306b\u8a2d\u5b9aClass\u3092\u8ffd\u8a18\u3057\u307e\u3059\u3002\u3053\u308c\u3067webjars\u3084src/main/resources/static\u4e0b\u306b\u3042\u308b\u9759\u7684\u30ea\u30bd\u30fc\u30b9\u3078\u306e\u30a2\u30af\u30bb\u30b9\u3092\u8a31\u53ef\u3057\u307e\u3057\u305f\u3002\u305d\u308c\u4ee5\u5916\u3078\u306e\u30a2\u30af\u30bb\u30b9\u306f\u4fdd\u8b77\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n\n```java:src/main/java/com/example/Ssp37Application.java\n@SpringBootApplication\n@Controller\npublic class Ssp37Application {\n    // Omit\n    // Add\n    @Configuration\n    @Order(SecurityProperties.ACCESS_OVERRIDE_ORDER)\n    protected static class SecurityConfiguration extends WebSecurityConfigurerAdapter {\n        @Override\n        protected void configure(HttpSecurity http) throws Exception {\n            http\n                .httpBasic()\n            .and()\n                .authorizeRequests()\n                    .antMatchers(\"/webjars/**\", \"/js/**\", \"/templates/**\", \"/index.html\", \"/\").permitAll()\n                    .anyRequest().authenticated();\n        }\n    }\n}\n```\n\n### \u30ed\u30b0\u30a4\u30f3\u30d5\u30a9\u30fc\u30e0\u306e\u8a8d\u8a3c\u5148\u306b\u306a\u308bendpoint\u3092RestController\u306b\u4f5c\u308b\n\n\u30b5\u30fc\u30d0\u5074\u306eMyRestController\u306b\u3001\u8a8d\u8a3c\u306e\u305f\u3081\u306e/user\u3068\u3044\u3046endpoint\u3092\u8ffd\u52a0\u3057\u307e\u3059\u3002\n\n```java:src/main/java/com/example/controllers/MyRestController.java\n@RestController\npublic class MyRestController {\n    // Omit\n    // Add\n    @RequestMapping(\"/user\")\n    public Principal user(Principal user) {\n        return user;\n    }\n\n}\n```\n\n\u3053\u306e/user\u3092\u4f7f\u3063\u305f\u8a8d\u8a3c\u306f\u6b21\u306e\u3088\u3046\u306a\u624b\u9806\u3092\u8e0f\u307f\u307e\u3059\u3002\n\u307e\u305a\u30ed\u30b0\u30a4\u30f3\u30d5\u30a9\u30fc\u30e0\u306f/user\u3078\u3001\u8a8d\u8a3c\u306e\u305f\u3081\u306bGet\u30ea\u30af\u30a8\u30b9\u30c8\u3057\u307e\u3059\u3002\n\u305d\u306e\u30ea\u30af\u30a8\u30b9\u30c8\u30d8\u30c3\u30c0\u30fc\u306b\u3001\u30e6\u30fc\u30b6\u30fc\u540d\u3068\u30d1\u30b9\u30ef\u30fc\u30c9\u3092\u542b\u3081\u307e\u3059\u3002\n\u30b5\u30fc\u30d0\u5074\u3067\u305d\u306e\u30ea\u30af\u30a8\u30b9\u30c8\u306f\u3001/user\u306b\u5bfe\u5fdc\u4ed8\u3051\u3089\u308c\u305fuser()\u30e1\u30bd\u30c3\u30c9\u3088\u308a\u3082\u524d\u306b\u3001Spring Security\u304c\u6355\u6349\u3057\u307e\u3059\u3002\nSpring Security\u306f\u30ea\u30af\u30a8\u30b9\u30c8\u30d8\u30c3\u30c0\u30fc\u306e\u30e6\u30fc\u30b6\u30fc\u540d\u3068\u30d1\u30b9\u30ef\u30fc\u30c9\u3092\u78ba\u8a8d\u3057\u3001\u8a8d\u3081\u3089\u308c\u306a\u3044\u3082\u306e\u306a\u3089\u3070\u3001401 (Unauthorized)\u3092\u5fdc\u7b54\u3057\u307e\u3059\u3002user()\u30e1\u30bd\u30c3\u30c9\u306b\u51e6\u7406\u304c\u6e21\u308a\u307e\u305b\u3093\u3002\n\u8a8d\u3081\u3089\u308c\u308b\u3082\u306e\u306a\u3089\u3070\u3001\u73fe\u5728\u8a8d\u8a3c\u3055\u308c\u3066\u3044\u308buser\u60c5\u5831\u3092\u5f15\u6570\u306b\u3001user()\u30e1\u30bd\u30c3\u30c9\u306b\u51e6\u7406\u304c\u6e21\u308a\u307e\u3059\u3002\n\u305d\u3057\u3066user()\u30e1\u30bd\u30c3\u30c9\u3067\u305d\u306e\u307e\u307e\u3001user\u60c5\u5831\u3092200 (OK)\u3068\u3068\u3082\u306b\u3001\u5fdc\u7b54\u3057\u307e\u3059\u3002\n\n### \u8a8d\u8a3c\u3092\u884c\u3046auth\u3092factory\u306b\u4f5c\u308b\n\n\u30d6\u30e9\u30a6\u30b6\u5074\u306b\u306flogin/logout\u51e6\u7406\u3068\u3001\u305d\u306e\u51e6\u7406\u7d50\u679c\u306e\u72b6\u614b\u3092\u6301\u3064auth(\u30b5\u30fc\u30d3\u30b9)\u3092\u4f5c\u308a\u307e\u3057\u3087\u3046\u3002\nlogin\u3067\u306f\u5148\u307b\u3069\u306e/user\u306b\u30a2\u30af\u30bb\u30b9\u3057\u307e\u3059\u3002\u305d\u306e\u969b\u3001\u30ea\u30af\u30a8\u30b9\u30c8\u30d8\u30c3\u30c0\u30fc\u306b\u3001\u30e6\u30fc\u30b6\u30fc\u540d\u3068\u30d1\u30b9\u30ef\u30fc\u30c9\u3092\u542b\u3081\u307e\u3059\u3002\u6210\u529f\u3057\u305f\u3089\u8a8d\u8a3c\u6e08\u3068\u3057\u3066authenticated\u3092true\u306b\u3057\u3001\u30e6\u30fc\u30b6\u30fc\u60c5\u5831\u3092principal\u306b\u6301\u3061\u307e\u3059\u3002\nlogout\u3067\u306fSpring Security\u304c\u7528\u610f\u3057\u3066\u3044\u308blogout\u7528\u306eendpoint\u306b\u30a2\u30af\u30bb\u30b9\u3057\u3066\u3001\u30ed\u30b0\u30a4\u30f3\u60c5\u5831\u3092\u7834\u68c4\u3057\u307e\u3059\u3002\n\n```js:src/main/resources/static/js/app.js\nangular.module('ssp37App', ['ui.router'])\n    // Omit\n    // Add\n    .factory('auth', function($http, $q) {\n        return {\n            authenticated: false,\n            principal: {},\n            login: function(credentials) {\n                var self = this\n                var headers = credentials\n                ? { authorization : \"Basic \" + btoa(credentials.username + \":\" + credentials.password) }\n                : {};\n                return $http.get('/user', {headers : headers})\n                .then(function(response) {\n                    self.authenticated = true\n                    self.principal = response.data\n                    return response;\n                })\n                .catch(function(response) {\n                    self.authenticated = false\n                    self.principal = {}                    \n                    return $q.reject(response);\n                });\n            },\n            logout: function() {\n                var self = this\n                return $http.post(\"/logout\", {})\n                .finally(function() {\n                    self.authenticated = false\n                    self.principal = {}                    \n                });\n            }\n        };\n    })\n    // Omit\n    ;\n```\n\n### state\u306e\u30de\u30c3\u30d4\u30f3\u30b0\u3084auth\u3092\u5229\u7528\u3059\u308bController\u306e\u4f5c\u6210\n\n\u307e\u305aURL\u304c\u3069\u306estate\u306b\u3082\u5f53\u3066\u306f\u307e\u3089\u306a\u3044\u3068\u304d\u306e\u3001\u65e2\u5b9a\u5024\u3068\u3057\u3066otherwise(\"/login\")\u3092\u6307\u5b9a\u3057\u307e\u3057\u305f\u3002\n\u307e\u305fBasic\u8a8d\u8a3c\u30c0\u30a4\u30a2\u30ed\u30b0\u3092\u6291\u5236\u3059\u308b\u305f\u3081\u306b\u3001X-Requested-With\u3092\u30d8\u30c3\u30c0\u30fc\u306b\u4ed8\u4e0e\u3059\u308b\u3088\u3046\u306b\u3057\u3066\u3044\u307e\u3059\u3002\nstate\u306b\u306flogin\u3068logout\u3092\u5c0e\u5165\u3057\u3001\u305d\u308c\u305e\u308cController\u3092\u95a2\u9023\u4ed8\u3051\u3066\u3044\u307e\u3059\u3002\nLoginCtrl\u3067\u306f\u3001\u30ed\u30b0\u30a4\u30f3\u51e6\u7406\u306e\u72b6\u614b\u3092\u6301\u3064\u9805\u76ee\u3068\u3001auth.login\u3092\u547c\u3073\u51fa\u3057\u3066\u7d50\u679c\u3092\u72b6\u614b\u306b\u53cd\u6620\u3059\u308b\u95a2\u6570\u3092\u3001$scope\u306b\u4f5c\u3063\u3066\u3044\u307e\u3059\u3002\nauth.login\u547c\u3073\u51fa\u3057\u3067\u8a8d\u8a3c\u3055\u308c\u308b\u3068\u3001hello state\u3078\u9077\u79fb\u3057\u307e\u3059\u3002\nLogoutCtrl\u3067\u306f\u3001auth.logout\u3092\u547c\u3073\u51fa\u3057\u3001\u305d\u306e\u5f8c\u3001login state\u3078\u9077\u79fb\u3059\u308b\u3088\u3046\u306b\u3057\u3066\u3044\u307e\u3059\u3002\n\n```js:src/main/resources/static/js/app.js\nangular.module('ssp37App', ['ui.router'])\n    .config(function($stateProvider, $urlRouterProvider, $httpProvider) {\n        // Change\n        $urlRouterProvider.otherwise(\"/login\")\n        $stateProvider\n            // Add\n            .state('login', {\n                url: \"/login\",\n                templateUrl: \"templates/login.html\",\n                controller: \"LoginCtrl\"\n            })\n            // Add\n            .state('logout', {\n                url: \"/logout\",\n                controller: \"LogoutCtrl\"\n            })\n            // Omit\n            ;\n        // Add\n        $httpProvider.defaults.headers.common[\"X-Requested-With\"] = 'XMLHttpRequest';\n    })\n    // Omit\n    // Add\n    .controller('LoginCtrl', function($scope, $state, auth) {\n        $scope.error = false\n        $scope.authenticated = auth.authenticated\n        $scope.credentials = { username: \"\", password: \"\" }\n        $scope.login = function(credentials) {\n            return auth.login(credentials)\n            .finally(function() {\n                $scope.error = !auth.authenticated\n                $scope.authenticated = auth.authenticated\n                if($scope.authenticated) {\n                    $state.go(\"hello\")\n                }\n            });\n        }\n    })\n    // Add\n    .controller('LogoutCtrl', function($state, auth) {\n        auth.logout()\n        .finally(function() {\n            $state.go(\"login\")\n        });\n    })\n    // Omit\n    ;\n```\n\n### \u30ed\u30b0\u30a4\u30f3\u30d5\u30a9\u30fc\u30e0\u3092\u4f5c\u308b\n\n\u30ed\u30b0\u30a4\u30f3\u30d5\u30a9\u30fc\u30e0\u306fLoginCtrl\u3067\\$scope\u306b\u4f5c\u3063\u305f\u9805\u76ee\u3068\u95a2\u9023\u3057\u3066\u3044\u307e\u3059\u3002\nLogin\u30dc\u30bf\u30f3\u3092\u62bc\u3059\u3068\u3001\\$scope.login\u95a2\u6570\u304c\u30e6\u30fc\u30b6\u30fc\u540d\u3068\u30d1\u30b9\u30ef\u30fc\u30c9\u3092\u6301\u3064credentials\u3092\u5f15\u6570\u306b\u547c\u3073\u51fa\u3055\u308c\u3001auth.login\u3092\u884c\u3044\u307e\u3059\u3002\n\u3082\u3057\u8a8d\u8a3c\u304c\u5931\u6557\u3057\u305f\u3089\u3001ng-show\u30c7\u30a3\u30ec\u30af\u30c6\u30a3\u30d6\u3092\u6301\u3064\\<div\\>\u30bf\u30b0\u304c\u6709\u52b9\u306b\u306a\u308a\u3001\u30a8\u30e9\u30fc\u30e1\u30c3\u30bb\u30fc\u30b8\u304c\u8868\u793a\u3055\u308c\u307e\u3059\u3002\n\n```html:src/main/resources/static/templates/login.html\n<div class=\"alert alert-danger\" ng-show=\"error\">\n    There was a problem logging in. Please try again.\n</div>\n<form role=\"form\" ng-submit=\"login(credentials)\">\n    <div class=\"form-group\">\n        <label for=\"username\">Username:</label>\n        <input type=\"text\" class=\"form-control\" id=\"username\" name=\"username\" ng-model=\"credentials.username\"/>\n    </div>\n    <div class=\"form-group\">\n        <label for=\"password\">Password:</label>\n        <input type=\"password\" class=\"form-control\" id=\"password\" name=\"password\" ng-model=\"credentials.password\"/>\n    </div>\n    <button type=\"submit\" class=\"btn btn-primary\">Login</button>\n</form>\n```\n\n### \u30ca\u30d3\u30b2\u30fc\u30b7\u30e7\u30f3\u306blogin/logout\u3092\u8ffd\u52a0\u3059\u308b\n\n\u30ca\u30d3\u30b2\u30fc\u30b7\u30e7\u30f3\u306e\u9805\u76ee\u306blogin/logout\u3092\u8ffd\u52a0\u3057\u307e\u3057\u305f\u3002\n\n```html:src/main/resources/static/index.html\n<html ng-app=\"ssp37App\">\n<head>\n<meta charset=\"utf-8\">\n<title>SSP37</title>\n<link rel=\"stylesheet\" href=\"webjars/bootstrap/3.3.6/css/bootstrap.min.css\">\n</head>\n<body>\n\t<div class=\"container\">\n\t\t<!-- Change -->\n\t\t<ul class=\"nav nav-pills\" role=\"tablist\" ng-controller=\"NavCtrl\">\n\t\t\t<!-- Add -->\n\t\t\t<li><a ui-sref=\"login\"  ng-hide=\"auth.authenticated\">login</a></li>\n\t\t\t<!-- Add -->\n\t\t\t<li><a ui-sref=\"logout\"\tng-show=\"auth.authenticated\">logout</a></li>\n\t\t\t<li><a ui-sref=\"hello\"\t>hello</a></li>\n\t\t\t<li><a ui-sref=\"blue\"  \t>blue</a></li>\n\t\t\t<li><a ui-sref=\"green\"\t>green</a></li>\n\t\t</ul>\n\t</div>\n\t<div ui-view class=\"container\"></div>\n\t<script src=\"webjars/jquery/2.2.3/jquery.min.js\"></script>\n\t<script src=\"webjars/bootstrap/3.3.6/js/bootstrap.min.js\"></script>\n\t<script src=\"webjars/angularjs/1.5.3/angular.min.js\"></script>\n\t<script src=\"webjars/angular-ui-router/0.2.18/angular-ui-router.min.js\"></script>\n\t<script src=\"js/app.js\"></script>\n</body>\n</html>\n```\n\n\u307e\u305f\u305d\u306elogin/logout\u306e\u8868\u793a\u3092\u5207\u66ff\u3048\u308b\u3001NavCtrl\u3092\u8ffd\u52a0\u3057\u307e\u3057\u305f\u3002\n\n```js:src/main/resources/static/js/app.js\nangular.module('ssp37App', ['ui.router'])\n    // Omit\n    // Add\n    .controller('NavCtrl', function($scope, auth) {\n        $scope.auth = auth\n    })\n    // Omit\n    ;\n```\n\n### \u52d5\u4f5c\u78ba\u8a8d\u3059\u308b\n\n\u3053\u306e\u6bb5\u968e\u3067login-\\>hello\u8868\u793a-\\>logout\u304c\u3067\u304d\u308b\u306f\u305a\u306a\u306e\u3067\u8a66\u3057\u3066\u307f\u307e\u3057\u3087\u3046\u3002\nhttp://localhost:8080/index.html \u3092\u958b\u304d\u307e\u3059\u3002\n\u30ed\u30b0\u30a4\u30f3\u30d5\u30a9\u30fc\u30e0\u304c\u3067\u308b\u3067\u3057\u3087\u3046\u304b\u3002\nBasic\u8a8d\u8a3c\u306e\u3068\u304d\u3068\u540c\u3058\u3088\u3046\u306b\u3001\u30e6\u30fc\u30b6\u30fc\u540d\u306buser\u3001\u30d1\u30b9\u30ef\u30fc\u30c9\u306b\u8d77\u52d5\u6642\u30ed\u30b0\u306b\u51fa\u529b\u3055\u308c\u308b\u30d1\u30b9\u30ef\u30fc\u30c9\u3092\u5165\u308c\u3001\u30ed\u30b0\u30a4\u30f3\u3057\u307e\u3059\u3002\nhello\u306b\u9077\u79fb\u3057\u307e\u3059\u3002\n\u6b21\u306blogout\u3092\u30af\u30ea\u30c3\u30af\u3057\u307e\u3059\u3002\n\u3059\u308b\u3068403 (Forbidden)\u306e\u30a8\u30e9\u30fc\u306b\u306a\u3063\u3066\u3057\u307e\u3044\u307e\u3059\u3002\n\u3053\u308c\u306fSpring Security\u304c\u65e2\u5b9a\u3067\u3001logout\u3078\u306ePost\u3092CSRF\u304b\u3089\u4fdd\u8b77\u3057\u3066\u3044\u308b\u305f\u3081\u3067\u3059\u3002\n\u3053\u306e\u4fdd\u8b77\u306b\u5f93\u3063\u3066\u52d5\u4f5c\u3059\u308b\u3088\u3046\u306b\u3057\u307e\u3057\u3087\u3046\u3002\n\n### CSRF Token\u3092\u53d6\u308a\u6271\u3044\u65b9\n\nCSRF\u306e\u4fdd\u8b77\u306f\u6b21\u306e\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002\n\u30b5\u30fc\u30d0\u5074\u3067Token\u3092\u751f\u6210\u3057\u3001Cookie\u3067\u30d6\u30e9\u30a6\u30b6\u306b\u6e21\u3057\u307e\u3059\u3002\n\u30d6\u30e9\u30a6\u30b6\u306fPost\u3092\u3059\u308b\u6642\u306b\u3001\u305d\u306eToken\u3092\u30d8\u30c3\u30c0\u30fc\u306b\u5165\u308c\u3066\u8fd4\u5374\u3057\u307e\u3059\u3002\nPost\u3092\u53d7\u3051\u53d6\u3063\u305f\u30b5\u30fc\u30d0\u306f\u3001\u305d\u306eToken\u3092\u898b\u3066\u6e21\u3057\u305f\u3068\u304d\u3068\u540c\u5024\u304b\u78ba\u8a8d\u3059\u308b\u3053\u3068\u3067\u3001\u4fdd\u8b77\u3057\u3066\u3044\u307e\u3059\u3002\nAngularJS\u3067\u306f\u65e2\u5b9a\u3067\u3053\u306e\u52d5\u4f5c\u3092\u63d0\u4f9b\u3057\u3066\u3044\u307e\u3059\u3002\n\u30af\u30c3\u30ad\u30fc\u540d\u3001XSRF-TOKEN\u3092\u53d7\u3051\u53d6\u308b\u3068\u3001\u305d\u306e\u5024\u3092\u30d8\u30c3\u30c0\u30fc\u540d\u3001X-XSRF-TOKEN\u3067\u8fd4\u5374\u3057\u3066\u304f\u308c\u307e\u3059\u3002\n\u30b5\u30fc\u30d0\u5074\u304b\u3089\u305d\u306e\u3088\u3046\u306a\u540d\u524d\u306e\u30af\u30c3\u30ad\u30fc\u3067Token\u3092\u9001\u4fe1\u3057\u3001\u30d8\u30c3\u30c0\u30fc\u304b\u3089\u53d7\u3051\u53d6\u308b\u3088\u3046\u306b\u3057\u307e\u3057\u3087\u3046\u3002\n\n### XSRF-TOKEN\u30af\u30c3\u30ad\u30fc\u3092\u9001\u308b\n\nSpring Security\u306fCSRF\u306eToken\u3092\u3001CsrfFilter\u3067request\u306eattribute\u306b\u7528\u610f\u3057\u3066\u304f\u308c\u3066\u3044\u307e\u3059\u3002\n\u305d\u306eCsrfFilter\u306e\u5f8c\u306b\u7d9a\u304f\u3088\u3046\u306b\u3001\u30af\u30c3\u30ad\u30fc\u3092\u9001\u308bFilter\u3092\u8ffd\u52a0\u3057\u307e\u3059\u3002\uff08addFilterAfter()\uff09\n\u30af\u30c3\u30ad\u30fc\u3092\u9001\u308bFilter\u306e\u4e2d\u3067\u3001\u305d\u306eToken\u3092Cookie\u306b\u5165\u308c\u307e\u3059\u3002(csrfHeaderFilter())\n\n```java:src/main/java/com/example/Ssp37Application.java\n@SpringBootApplication\n@Controller\npublic class Ssp37Application {\n    // Omit\n    @Configuration\n    @Order(SecurityProperties.ACCESS_OVERRIDE_ORDER)\n    protected static class SecurityConfiguration extends WebSecurityConfigurerAdapter {\n        @Override\n        protected void configure(HttpSecurity http) throws Exception {\n            http\n                .httpBasic()\n            .and()\n                .authorizeRequests()\n                    .antMatchers(\"/webjars/**\", \"/js/**\", \"/templates/**\", \"/index.html\", \"/\").permitAll()\n                    .anyRequest().authenticated()\n            .and()\n                // Add\n                .addFilterAfter(csrfHeaderFilter(), CsrfFilter.class)\n            ;\n        }\n\n        // Add\n        private Filter csrfHeaderFilter() {\n            return new OncePerRequestFilter() {\n                @Override\n                protected void doFilterInternal(HttpServletRequest request,\n                        HttpServletResponse response, FilterChain filterChain)\n                        throws ServletException, IOException {\n                    CsrfToken csrf = (CsrfToken) request.getAttribute(CsrfToken.class\n                            .getName());\n                    if (csrf != null) {\n                        Cookie cookie = WebUtils.getCookie(request, \"XSRF-TOKEN\");\n                        String token = csrf.getToken();\n                        if (cookie == null || token != null\n                                && !token.equals(cookie.getValue())) {\n                            cookie = new Cookie(\"XSRF-TOKEN\", token);\n                            cookie.setPath(\"/\");\n                            response.addCookie(cookie);\n                        }\n                    }\n                    filterChain.doFilter(request, response);\n                }\n            };\n        }\n    }\n}\n```\n\n### X-XSRF-TOKEN\u30d8\u30c3\u30c0\u30fc\u3092\u53d7\u3051\u53d6\u308b\n\nCSRF\u306eToken\u3092\u30d8\u30c3\u30c0\u30fc\u540d\u3001X-XSRF-TOKEN\u3067\u53d7\u3051\u53d6\u308c\u308b\u3088\u3046\u306aCsrfTokenRepository\u3092\u7528\u610f\u3057\u307e\u3059\u3002(csrfTokenRepository())\n\u305d\u308c\u3092Spring Security\u306b\u8a2d\u5b9a\u3057\u307e\u3059\u3002(http.csrf().csrfTokenRepository())\n\n```java:src/main/java/com/example/Ssp37Application.java\n@SpringBootApplication\n@Controller\npublic class Ssp37Application {\n    // Omit\n    @Configuration\n    @Order(SecurityProperties.ACCESS_OVERRIDE_ORDER)\n    protected static class SecurityConfiguration extends WebSecurityConfigurerAdapter {\n        @Override\n        protected void configure(HttpSecurity http) throws Exception {\n            http\n                .httpBasic()\n            .and()\n                .authorizeRequests()\n                    .antMatchers(\"/webjars/**\", \"/js/**\", \"/templates/**\", \"/index.html\", \"/\").permitAll()\n                    .anyRequest().authenticated()\n            .and()\n                // Add\n                .addFilterAfter(csrfHeaderFilter(), CsrfFilter.class)\n                // Add\n                .csrf()\n                    .csrfTokenRepository(csrfTokenRepository())\n            ;\n        }\n\n        // Omit\n\n        // Add\n        private CsrfTokenRepository csrfTokenRepository() {\n            HttpSessionCsrfTokenRepository repository = new HttpSessionCsrfTokenRepository();\n            repository.setHeaderName(\"X-XSRF-TOKEN\");\n            return repository;\n        }\n    }\n}\n```\n\n### \u518d\u3073\u52d5\u4f5c\u78ba\u8a8d\u3059\u308b\n\n403 (Forbidden)\u306b\u306a\u3089\u305alogout\u3067\u304d\u308b\u306f\u305a\u306a\u306e\u3067\u8a66\u3057\u3066\u307f\u307e\u3057\u3087\u3046\u3002\nWeb\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3092\u518d\u8d77\u52d5\u3057\u3066\u3001 http://localhost:8080/index.html \u3092\u958b\u304d\u307e\u3059\u3002\nBasic\u8a8d\u8a3c\u306e\u3068\u304d\u3068\u540c\u3058\u3088\u3046\u306b\u3001\u30e6\u30fc\u30b6\u30fc\u540d\u306buser\u3001\u30d1\u30b9\u30ef\u30fc\u30c9\u306b\u8d77\u52d5\u6642\u30ed\u30b0\u306b\u51fa\u529b\u3055\u308c\u308b\u30d1\u30b9\u30ef\u30fc\u30c9\u3092\u5165\u308c\u3001\u30ed\u30b0\u30a4\u30f3\u3057\u307e\u3059\u3002\nhello\u306b\u9077\u79fb\u3057\u307e\u3059\u3002\n\u6b21\u306blogout\u3092\u30af\u30ea\u30c3\u30af\u3057\u307e\u3059\u3002\n\u3059\u308b\u3068\u4eca\u5ea6\u306fGET http://localhost:8080/login?logout 401 (Unauthorized)\u306b\u306a\u308a\u307e\u3059\u3002\n\u3053\u308c\u306fSpring Security\u304c\u65e2\u5b9a\u3067\u3001logout\u5f8c\u306b\u8868\u793a\u3059\u308b\u30da\u30fc\u30b8\u3078Redirection\u3092\u3057\u3066\u3044\u308b\u304b\u3089\u3067\u3059\u3002\n\u3061\u3087\u3063\u3068\u6c17\u6301\u3061\u60aa\u3044\u3067\u3059\u304c\u3001Unauthorized\u306b\u306a\u3063\u3066\u3044\u308b\u306e\u3067\u3001logout\u306b\u3088\u3063\u3066\u8a8d\u8a3c\u304c\u5207\u308c\u3066\u3044\u308b\u3088\u3046\u3067\u3059\u3002\n\n## \u53c2\u8003\n\nSample Repository\nhttps://github.com/quwahara/SSP37/tree/510-security\n", "tags": ["Java", "spring-security", "AngularJS"]}