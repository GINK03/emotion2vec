{"context": " More than 1 year has passed since last update.\n\u524d\u7de8\nEC2\u3067php\u74b0\u5883\u69cb\u7bc9 \u2460 Nginx + php56 + php56-fpm + virtualhost\n\n\n\u76ee\u6b21\n\ngit\u30ea\u30e2\u30fc\u30c8\u30b5\u30fc\u30d0\u69cb\u7bc9\ndeploy\u30e6\u30fc\u30b6\u30fc\u306e\u4f5c\u6210\n\u30c7\u30d7\u30ed\u30a4\u30b3\u30de\u30f3\u30c9\u3092\u4f5c\u6210\n\u6b21\u306b\u3084\u308b\u3053\u3068\n\n\n# EC2 IP Adress(\u4eee)\n52.111.111.111\n\n\ngit\u30ea\u30e2\u30fc\u30c8\u30b5\u30fc\u30d0\u69cb\u7bc9\n\n1. EC2\u3078\u30ed\u30b0\u30a4\u30f3\n[hoge@local ~]$ ssh -i \"XXX.pem\" ec2-user@52.111.111.111\n\n\n2. \u3010EC2\u3011gituser\u306e\u4f5c\u6210\n[ec2-user@ip-172-31-4-XXX ~]$ sudo useradd -m -s /bin/bash gituser\n[ec2-user@ip-172-31-4-XXX ~]$ sudo mkdir /home/gituser/.ssh\n[ec2-user@ip-172-31-4-XXX ~]$ sudo touch /home/gituser/.ssh/authorized_keys\n[ec2-user@ip-172-31-4-XXX ~]$ sudo chown gituser. /home/gituser/.ssh\n[ec2-user@ip-172-31-4-XXX ~]$ sudo chown gituser. /home/gituser/.ssh/authorized_keys\n[ec2-user@ip-172-31-4-XXX ~]$ sudo chmod 700 /home/gituser/.ssh\n[ec2-user@ip-172-31-4-XXX ~]$ sudo chmod 600 /home/gituser/.ssh/authorized_keys\n\n\n3. \u3010\u30ed\u30fc\u30ab\u30eb\u3011rsa\u30ad\u30fc\u3092\u30b3\u30d4\u30fc\n[hoge@local ~]$ pbcopy < ~/.ssh/id_rsa.pub\n\n\n4. \u3010EC2\u3011gituser\u306eauthorized_keys\u306b\u30da\u30fc\u30b9\u30c8\n[hoge@local ~]$ ssh -i \"XXX.pem\" ec2-user@52.111.111.111\n[ec2-user@ip-172-31-4-XXX ~]$ sudo su - gituser\n[gituser@ip-172-31-4-XXX ~]$ vi ~/.ssh/authorized_keys\n\n\n5. \u3010\u30ed\u30fc\u30ab\u30eb\u3011ssh\u63a5\u7d9a\u78ba\u8a8d\n[hoge@local ~]$ ssh gituser@52.111.111.111 -i ~/.ssh/id_rsa\n\n\n6. \u3010\u30ed\u30fc\u30ab\u30eb\u3011.ssh/config\u306b\u8a2d\u5b9a\n[hoge@local ~]$ touch ~/.ssh/config\n[hoge@local ~]$ vi ~/.ssh/config\n\n\n~/.ssh/config\nHost gitserver\n  User         gituser\n  hostname     52.111.111.111\n  identityfile ~/.ssh/id_rsa\n\n\n\n7. \u3010\u30ed\u30fc\u30ab\u30eb\u3011ssh\u63a5\u7d9a\u78ba\u8a8d\n[hoge@local ~]$ ssh gitserver\n\n\n8. \u3010EC2\u3011git\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n[hoge@local ~]$ ssh -i \"XXX.pem\" ec2-user@52.111.111.111\n[ec2-user@ip-172-31-4-XXX ~]$ sudo yum install git -y\n[ec2-user@ip-172-31-4-XXX ~]$ git --version\ngit version 2.1.0\n\n\n9. \u3010EC2\u3011\u30ea\u30dd\u30b8\u30c8\u30ea\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u4f5c\u6210\n[ec2-user@ip-172-31-4-XXX ~]$ sudo su - gituser\n[gituser@ip-172-31-4-XXX ~]$ mkdir -p ~/repos\n[gituser@ip-172-31-4-XXX ~]$ cd ~/repos\n[gituser@ip-172-31-4-XXX repos]$ mkdir -p global.git\n[gituser@ip-172-31-4-XXX repos]$ cd global.git\n[gituser@ip-172-31-4-XXX global.git]$ git --bare init\n\n\n10. \u3010\u30ed\u30fc\u30ab\u30eb\u3011\u30ea\u30e2\u30fc\u30c8\u30ea\u30dd\u30b8\u30c8\u30eaclone\n[hoge@local ~]$ mkdir -p ~/projects\n[hoge@local ~]$ cd ~/projects\n[hoge@local projects]$ git clone  gitserver:/home/gituser/repos/global.git\n\n\n11. \u3010\u30ed\u30fc\u30ab\u30eb\u3011\u30ea\u30dd\u30b8\u30c8\u30ea\u3067\u30d5\u30a1\u30a4\u30eb\u4f5c\u6210\u3057\u30b3\u30df\u30c3\u30c8\u3057push\n[hoge@local projects]$ cd global\n[hoge@local global]$ echo \"this is my first file.\" > README.md\n[hoge@local global]$ git add .\n[hoge@local global]$ git commit -m \"first commit\"\n[hoge@local global]$ git push origin master\n\n\n12. \u3010\u30ed\u30fc\u30ab\u30eb\u3011\u5225\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306bpull\u3057\u3066\u307f\u308b\n\n\u300cREADME.md\u300d\u304c\u5b58\u5728\u3057\u3066\u3044\u308c\u3070OK\n[hoge@local ~]$ cd ~/projects\n[hoge@local projects]$ git clone  gitserver:/home/gituser/repos/global.git global2\n[hoge@local projects]$ cd global2\n[hoge@local global2]$ cat README.md\nthis is my first file.\n\n\ndeploy\u30e6\u30fc\u30b6\u30fc\u306e\u4f5c\u6210\n\n1. EC2\u3078\u30ed\u30b0\u30a4\u30f3\n[hoge@local ~]$ ssh -i \"XXX.pem\" ec2-user@52.111.111.111\n\n\n2. \u3010EC2\u3011deploy\u30e6\u30fc\u30b6\u30fc\u306e\u4f5c\u6210\n\nwheel\u30b0\u30eb\u30fc\u30d7\u306fsudo\u53ef\u80fd\u306a\u306e\u3067\u3001wheel\u30b0\u30eb\u30fc\u30d7\u306b\u8ffd\u52a0\u3059\u308b\n[ec2-user@ip-172-31-4-XXX ~]$ sudo useradd -m -s /bin/bash deploy\n[ec2-user@ip-172-31-4-XXX ~]$ sudo usermod -G wheel deploy\n\n\n3. \u3010EC2\u3011deploy\u30e6\u30fc\u30b6\u30fc\u306bsudo\u6a29\u9650\u3092\u4ed8\u4e0e\u3059\u308b\n\nwheel\u30b0\u30eb\u30fc\u30d7\u306e\u30e6\u30fc\u30b6\u304cpasswd\u306a\u3057\u3067sudo\u306e\u30b3\u30de\u30f3\u30c9\u304c\u5b9f\u884c\u3067\u304d\u308b\u3088\u3046\u306b\u3057\u3066\u304a\u304f\n[ec2-user@ip-172-31-4-XXX ~]$ sudo su -\n[root@ip-172-31-4-XXX ~]$ visudo\n\n%wheel ALL=(ALL) NOPASSWD: ALL\u3000\u2192\u3000\u30b3\u30e1\u30f3\u30c8\u30a2\u30a6\u30c8\u9664\u53bb\n%wheel ALL=(ALL) ALL\u3000\u2192\u3000\u30b3\u30e1\u30f3\u30c8\u30a2\u30a6\u30c8\n\n/etc/sudoers\n# %wheel        ALL=(ALL)       ALL\n%wheel  ALL=(ALL)       NOPASSWD: ALL\n\n\n\n4. \u3010EC2\u3011\u30c7\u30d7\u30ed\u30a4\u5148\u306e\u300c/vaw/www\u300d\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306e\u30aa\u30fc\u30ca\u30fc\u3092deploy\u30e6\u30fc\u30b6\u30fc\u306b\u3059\u308b\n\n\u300c/vaw/www\u300d\u914d\u4e0b\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u524a\u9664\u3057\u3066\u304a\u304f\n[root@ip-172-31-4-XXX ~]$ chown -Rf deploy. /var/www\n[root@ip-172-31-4-XXX ~]$ rm -rf /var/www/*\n\n\n5. \u3010EC2\u3011\u30ed\u30fc\u30ab\u30eb\u304b\u3089deploy\u30e6\u30fc\u30b6\u30fc\u3078\u306essh\u30a2\u30af\u30bb\u30b9\u6a29\u9650\u4ed8\u4e0e\n\n\u30ed\u30fc\u30ab\u30eb\u306e\u516c\u958b\u9375\u3092\u30ea\u30e2\u30fc\u30c8\u30b5\u30fc\u30d0\u306e/home/deploy/.ssh/authorized_keys\u306b\u767b\u9332\u3057\u3066\u304a\u304f\u3002\n# \u30ed\u30fc\u30ab\u30eb\u306e\u516c\u958b\u9375\u3092\u30b3\u30d4\u30fc\n[hoge@local ~]$ cat ~/.ssh/id_rsa.pub | pbcopy\n# EC2\u3078\u30ed\u30b0\u30a4\u30f3\u3057\u30ed\u30fc\u30ab\u30eb\u306e\u516c\u958b\u9375\u3092\u767b\u9332\n[hoge@local ~]$ ssh -i \"XXX.pem\" ec2-user@52.111.111.111\n[ec2-user@ip-172-31-4-XXX ~]$ sudo su - deploy\n[deploy@ip-172-31-4-XXX ~]$ mkdir .ssh\n[deploy@ip-172-31-4-XXX ~]$ chmod 700 .ssh\n[deploy@ip-172-31-4-XXX .ssh]$ cd .ssh\n[deploy@ip-172-31-4-XXX .ssh]$ touch authorized_keys\n[deploy@ip-172-31-4-XXX .ssh]$ chmod 600 authorized_keys\n[deploy@ip-172-31-4-XXX .ssh]$ vi authorized_keys\n# authorized_keys\u306b\u8cbc\u308a\u4ed8\u3051\u3066\u4fdd\u5b58\n\n\n6. \u3010EC2\u3011\u30ed\u30fc\u30ab\u30eb\u304b\u3089deploy\u30e6\u30fc\u30b6\u30fc\u3078\u306e\u30a2\u30af\u30bb\u30b9\u78ba\u8a8d\n[hoge@local ~]$ ssh deploy@52.111.111.111\n[deploy@ip-172-31-4-XXX ~]$ \n\n\n7. \u3010EC2\u3011deploy\u30e6\u30fc\u30b6\u30fc\u304b\u3089gituser\u30e6\u30fc\u30b6\u30fc\u3078\u306e\u30a2\u30af\u30bb\u30b9\u6a29\u9650\u4ed8\u4e0e\n\ndeploy\u30e6\u30fc\u30b6\u30fc\u306e\u516c\u958b\u9375\u306e\u4f5c\u6210\u3057\u30b3\u30d4\u30fc\n[hoge@local ~]$ ssh deploy@52.111.111.111\n[deploy@ip-172-31-4-XXX ~]$ ssh-keygen -t rsa\n[deploy@ip-172-31-4-XXX ~]$ cat ~/.ssh/id_rsa.pub\n\n\ndeploy\u30e6\u30fc\u30b6\u30fc\u304b\u3089gituser\u3078\u306essh\u30a2\u30af\u30bb\u30b9\u8a31\u5bb9\n[hoge@local ~]$ ssh gituser@52.111.111.111\n[gituser@ip-172-31-4-XXX ~]$ vi ~/.ssh/authorized_keys\n# deploy\u30e6\u30fc\u30b6\u30fc\u306e\u516c\u958b\u9375\u3092\u8cbc\u308a\u4ed8\u3051\u3066\u4fdd\u5b58\n\n\n8. \u3010EC2\u3011deploy\u30e6\u30fc\u30b6\u30fc\u304b\u3089gituser\u30e6\u30fc\u30b6\u30fc\u3078\u306e\u30a2\u30af\u30bb\u30b9\u78ba\u8a8d\n[hoge@local ~]$ ssh deploy@52.111.111.111\n[deploy@ip-172-31-4-XXX ~]$ ssh gituser@52.111.111.111\n[gituser@ip-172-31-4-XXX ~]$ \n\n\n9. \u3010EC2\u3011deploy\u30e6\u30fc\u30b6\u30fc\u306e~/.ssh/config\u306bgituser\u306eHost\u3092\u767b\u9332\u3059\u308b\n[hoge@local ~]$ ssh deploy@52.111.111.111\n[deploy@ip-172-31-4-XXX ~]$ touch ~/.ssh/config\n[deploy@ip-172-31-4-XXX ~]$ chmod 600 ~/.ssh/config\n[deploy@ip-172-31-4-XXX ~]$ vi ~/.ssh/config\n\n\n~/.ssh/config\nHost gitserver\n  User         gituser\n  hostname     52.111.111.111\n  identityfile ~/.ssh/id_rsa\n\n\n\n10. \u3010EC2\u3011deploy\u30e6\u30fc\u30b6\u30fc\u304b\u3089gitserver\u3078\u306e\u30a2\u30af\u30bb\u30b9\u78ba\u8a8d\n[hoge@local ~]$ ssh deploy@52.111.111.111\n[deploy@ip-172-31-4-XXX ~]$ ssh gitserver\n[gituser@ip-172-31-4-XXX ~]$ \n\n\n\u30c7\u30d7\u30ed\u30a4\u30b3\u30de\u30f3\u30c9\u3092\u4f5c\u6210\n\n1. \u3010\u30ed\u30fc\u30ab\u30eb\u3011php\u30c7\u30d7\u30ed\u30a4\u30c4\u30fc\u30eb(altax)\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\n\naltax\u30c1\u30e5\u30fc\u30c8\u30ea\u30a2\u30eb\u53ca\u3073\u30d5\u30a1\u30ec\u30f3\u30b9\nhttp://kohkimakimoto.github.io/altax/ja/\n\n[hoge@local ~]$ curl -L https://raw.github.com/kohkimakimoto/altax/master/installer.sh | bash -s system\n\n\n2. \u3010\u30ed\u30fc\u30ab\u30eb\u3011altax\u3092\u521d\u671f\u5316\n[hoge@local ~]$ cd ~/projects/global\n[hoge@local global]$ altax init\nCreated file: /Users/hoge/projects/global/.altax/config.php\nCreated file: /Users/hoge/projects/global/.altax/composer.json\nCreated file: /Users/hoge/projects/global/.altax/.gitignore\n\n\n3. \u3010\u30ed\u30fc\u30ab\u30eb\u3011deploy\u30b3\u30de\u30f3\u30c9\u4f5c\u6210\n\naltax deploy \u30c7\u30d7\u30ed\u30a4\u3059\u308b\u74b0\u5883\u540d \u9069\u7528\u3057\u305f\u3044\u30d6\u30e9\u30f3\u30c1\u540d\n\n\n~/projects/global/.altax/config.php\nServer::node(\"deployserver\", array(\n    \"host\" => \"52.111.111.111\",\n    \"username\" => \"deploy\",\n    \"port\" => 22,\n    \"key\" => \"~/.ssh/id_rsa\"\n));\nServer::role(\"web\", array(\"deployserver\"));\nTask::register(\"deploy\", function($task) {\n\n  $envirName =  $task->getArgument(0, null);\n  $branchName =  $task->getArgument(1, null);\n  if (is_null($envirName) || is_null($branchName)) {\n    exit();\n  }\n\n  // \u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\n  $appDir = \"/var/www/$envirName\";\n\n  // Execute parallel processes for each nodes.\n  $task->exec(function($process) use ($appDir, $branchName) {\n\n    // Run a command remotely and get a return code.\n    if ($process->run(\"test -d $appDir\")->isFailed()) {\n      $process->run(\"git clone gitserver:~/repos/global.git $appDir\");\n    } else {\n      $process->run(array(\n        \"cd $appDir\",\n        \"git fetch -q\",\n        \"git co $branchName\",\n        \"git pull origin $branchName\",\n      ));\n    }\n\n  }, array(\"web\"));\n\n});\n\n\n\n4. \u3010\u30ed\u30fc\u30ab\u30eb\u3011\u30c7\u30d7\u30ed\u30a4\u5b9f\u884c\u3057\u3066\u307f\u308b\n\n\u521d\u56de\n[hoge@local ~]$ cd ~/projects/global\n[hoge@local global]$ echo \"feature1 deployed\" > index.php\n[hoge@local global]$ altax deploy feature1 develop\n[deployserver:555] Run: test -d /var/www/feature1\n[deployserver:555] Run: git clone gitserver:~/repos/global.git /var/www/feature1\nCloning into '/var/www/feature1'...\n\n\n2\u56de\u76ee\u4ee5\u964d\n[hoge@local global]$ altax deploy feature1 master\n[deployserver:559] Run: test -d /var/www/feature1\n[deployserver:559] Run: cd /var/www/feature1 && git fetch -q && git pull origin master\nFrom gitserver:~/repos/global\n * branch            master     -> FETCH_HEAD\nAlready up-to-date.\n\n\n5. \u3010\u30ed\u30fc\u30ab\u30eb\u3011\u30c7\u30d7\u30ed\u30a4\u3057\u305f\u30c9\u30e1\u30a4\u30f3\u306b\u5165\u3063\u3066\u66f4\u65b0\u3055\u308c\u305f\u304b\u78ba\u8a8d\n\nhttp://feature1-develop.com/\n\n\n\u3053\u308c\u3067\u30b5\u30fc\u30d0\u30fc\u69cb\u7bc9\u304b\u3089\u30c7\u30d7\u30ed\u30a4\u65b9\u6cd5\u307e\u3067\u3042\u308b\u7a0b\u5ea6\u5206\u304b\u308b\u3088\u3046\u306b\u306a\u3063\u305f\u3002\n\n\u6b21\u306b\u3084\u308b\u3053\u3068\n\u4eca\u56de\u306f\u30ea\u30dd\u30b8\u30c8\u30ea\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u76f4\u63a5\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u30eb\u30fc\u30c8\u306b\u3057\u305f\u304c\u3001\n\u4e0b\u8a18\u306e\u3088\u3046\u306b\u69cb\u6210\u3092\u5909\u66f4\u3057\u3066\u304a\u304f\u3002\n\n\u5404\u74b0\u5883\u306e\u30ea\u30dd\u30b8\u30c8\u30ea\u3092repo\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306b\u79fb\u884c\nrelease\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u4e8c\u3064\u7528\u610f(release/A,release/B)\ndeploy \u2192 repo\u66f4\u65b0 \u2192 release\u5207\u308a\u66ff\u3048 \u2192 \u8a72\u5f53release\u306brsync\u3000\u2192 current\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306e\u30b7\u30f3\u30dc\u30ea\u30c3\u30af\u30ea\u30f3\u30af\u5909\u66f4\ndeploy\u30ed\u30c3\u30af\u30d5\u30a1\u30a4\u30eb\u4f5c\u6210(\u91cd\u8907\u5b9f\u884c\u9632\u6b62)\n\n> \u524d\u7de8\n> [EC2\u3067php\u74b0\u5883\u69cb\u7bc9 \u2460 Nginx + php56 + php56-fpm + virtualhost](http://qiita.com/jjongs08/items/805aab3dc3483b499785)\n\n# \u76ee\u6b21\n- git\u30ea\u30e2\u30fc\u30c8\u30b5\u30fc\u30d0\u69cb\u7bc9\n- deploy\u30e6\u30fc\u30b6\u30fc\u306e\u4f5c\u6210\n- \u30c7\u30d7\u30ed\u30a4\u30b3\u30de\u30f3\u30c9\u3092\u4f5c\u6210\n- \u6b21\u306b\u3084\u308b\u3053\u3068\n\n####### EC2 IP Adress(\u4eee)\n```\n52.111.111.111\n```\n\n# git\u30ea\u30e2\u30fc\u30c8\u30b5\u30fc\u30d0\u69cb\u7bc9\n## 1. EC2\u3078\u30ed\u30b0\u30a4\u30f3\n```bash\n[hoge@local ~]$ ssh -i \"XXX.pem\" ec2-user@52.111.111.111\n```\n\n## 2. \u3010EC2\u3011gituser\u306e\u4f5c\u6210\n```bash\n[ec2-user@ip-172-31-4-XXX ~]$ sudo useradd -m -s /bin/bash gituser\n[ec2-user@ip-172-31-4-XXX ~]$ sudo mkdir /home/gituser/.ssh\n[ec2-user@ip-172-31-4-XXX ~]$ sudo touch /home/gituser/.ssh/authorized_keys\n[ec2-user@ip-172-31-4-XXX ~]$ sudo chown gituser. /home/gituser/.ssh\n[ec2-user@ip-172-31-4-XXX ~]$ sudo chown gituser. /home/gituser/.ssh/authorized_keys\n[ec2-user@ip-172-31-4-XXX ~]$ sudo chmod 700 /home/gituser/.ssh\n[ec2-user@ip-172-31-4-XXX ~]$ sudo chmod 600 /home/gituser/.ssh/authorized_keys\n```\n\n## 3. \u3010\u30ed\u30fc\u30ab\u30eb\u3011rsa\u30ad\u30fc\u3092\u30b3\u30d4\u30fc\n```bash\n[hoge@local ~]$ pbcopy < ~/.ssh/id_rsa.pub\n```\n\n## 4. \u3010EC2\u3011gituser\u306eauthorized_keys\u306b\u30da\u30fc\u30b9\u30c8\n```\n[hoge@local ~]$ ssh -i \"XXX.pem\" ec2-user@52.111.111.111\n[ec2-user@ip-172-31-4-XXX ~]$ sudo su - gituser\n[gituser@ip-172-31-4-XXX ~]$ vi ~/.ssh/authorized_keys\n```\n\n## 5. \u3010\u30ed\u30fc\u30ab\u30eb\u3011ssh\u63a5\u7d9a\u78ba\u8a8d\n```bash\n[hoge@local ~]$ ssh gituser@52.111.111.111 -i ~/.ssh/id_rsa\n```\n\n## 6. \u3010\u30ed\u30fc\u30ab\u30eb\u3011.ssh/config\u306b\u8a2d\u5b9a\n```bash\n[hoge@local ~]$ touch ~/.ssh/config\n[hoge@local ~]$ vi ~/.ssh/config\n```\n\n```~/.ssh/config\nHost gitserver\n  User         gituser\n  hostname     52.111.111.111\n  identityfile ~/.ssh/id_rsa\n```\n\n## 7. \u3010\u30ed\u30fc\u30ab\u30eb\u3011ssh\u63a5\u7d9a\u78ba\u8a8d\n```bash\n[hoge@local ~]$ ssh gitserver\n```\n\n## 8. \u3010EC2\u3011git\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n```bash\n[hoge@local ~]$ ssh -i \"XXX.pem\" ec2-user@52.111.111.111\n[ec2-user@ip-172-31-4-XXX ~]$ sudo yum install git -y\n[ec2-user@ip-172-31-4-XXX ~]$ git --version\ngit version 2.1.0\n```\n\n## 9. \u3010EC2\u3011\u30ea\u30dd\u30b8\u30c8\u30ea\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u4f5c\u6210\n```bash\n[ec2-user@ip-172-31-4-XXX ~]$ sudo su - gituser\n[gituser@ip-172-31-4-XXX ~]$ mkdir -p ~/repos\n[gituser@ip-172-31-4-XXX ~]$ cd ~/repos\n[gituser@ip-172-31-4-XXX repos]$ mkdir -p global.git\n[gituser@ip-172-31-4-XXX repos]$ cd global.git\n[gituser@ip-172-31-4-XXX global.git]$ git --bare init\n```\n\n## 10. \u3010\u30ed\u30fc\u30ab\u30eb\u3011\u30ea\u30e2\u30fc\u30c8\u30ea\u30dd\u30b8\u30c8\u30eaclone\n```bash\n[hoge@local ~]$ mkdir -p ~/projects\n[hoge@local ~]$ cd ~/projects\n[hoge@local projects]$ git clone  gitserver:/home/gituser/repos/global.git\n```\n\n## 11. \u3010\u30ed\u30fc\u30ab\u30eb\u3011\u30ea\u30dd\u30b8\u30c8\u30ea\u3067\u30d5\u30a1\u30a4\u30eb\u4f5c\u6210\u3057\u30b3\u30df\u30c3\u30c8\u3057push\n```bash\n[hoge@local projects]$ cd global\n[hoge@local global]$ echo \"this is my first file.\" > README.md\n[hoge@local global]$ git add .\n[hoge@local global]$ git commit -m \"first commit\"\n[hoge@local global]$ git push origin master\n```\n\n## 12. \u3010\u30ed\u30fc\u30ab\u30eb\u3011\u5225\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306bpull\u3057\u3066\u307f\u308b\n######\u300cREADME.md\u300d\u304c\u5b58\u5728\u3057\u3066\u3044\u308c\u3070OK\n```bash\n[hoge@local ~]$ cd ~/projects\n[hoge@local projects]$ git clone  gitserver:/home/gituser/repos/global.git global2\n[hoge@local projects]$ cd global2\n[hoge@local global2]$ cat README.md\nthis is my first file.\n```\n\n# deploy\u30e6\u30fc\u30b6\u30fc\u306e\u4f5c\u6210\n## 1. EC2\u3078\u30ed\u30b0\u30a4\u30f3\n```bash\n[hoge@local ~]$ ssh -i \"XXX.pem\" ec2-user@52.111.111.111\n```\n\n## 2. \u3010EC2\u3011deploy\u30e6\u30fc\u30b6\u30fc\u306e\u4f5c\u6210\n###### wheel\u30b0\u30eb\u30fc\u30d7\u306fsudo\u53ef\u80fd\u306a\u306e\u3067\u3001wheel\u30b0\u30eb\u30fc\u30d7\u306b\u8ffd\u52a0\u3059\u308b\n```bash\n[ec2-user@ip-172-31-4-XXX ~]$ sudo useradd -m -s /bin/bash deploy\n[ec2-user@ip-172-31-4-XXX ~]$ sudo usermod -G wheel deploy\n```\n\n## 3. \u3010EC2\u3011deploy\u30e6\u30fc\u30b6\u30fc\u306bsudo\u6a29\u9650\u3092\u4ed8\u4e0e\u3059\u308b\n###### wheel\u30b0\u30eb\u30fc\u30d7\u306e\u30e6\u30fc\u30b6\u304cpasswd\u306a\u3057\u3067sudo\u306e\u30b3\u30de\u30f3\u30c9\u304c\u5b9f\u884c\u3067\u304d\u308b\u3088\u3046\u306b\u3057\u3066\u304a\u304f\n```\n[ec2-user@ip-172-31-4-XXX ~]$ sudo su -\n[root@ip-172-31-4-XXX ~]$ visudo\n```\n\n%wheel ALL=(ALL) NOPASSWD: ALL\u3000\u2192\u3000\u30b3\u30e1\u30f3\u30c8\u30a2\u30a6\u30c8\u9664\u53bb\n%wheel ALL=(ALL) ALL\u3000\u2192\u3000\u30b3\u30e1\u30f3\u30c8\u30a2\u30a6\u30c8\n\n```:/etc/sudoers\n# %wheel        ALL=(ALL)       ALL\n%wheel  ALL=(ALL)       NOPASSWD: ALL\n```\n\n## 4. \u3010EC2\u3011\u30c7\u30d7\u30ed\u30a4\u5148\u306e\u300c/vaw/www\u300d\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306e\u30aa\u30fc\u30ca\u30fc\u3092deploy\u30e6\u30fc\u30b6\u30fc\u306b\u3059\u308b\n###### \u300c/vaw/www\u300d\u914d\u4e0b\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u524a\u9664\u3057\u3066\u304a\u304f\n```bash\n[root@ip-172-31-4-XXX ~]$ chown -Rf deploy. /var/www\n[root@ip-172-31-4-XXX ~]$ rm -rf /var/www/*\n```\n\n## 5. \u3010EC2\u3011\u30ed\u30fc\u30ab\u30eb\u304b\u3089deploy\u30e6\u30fc\u30b6\u30fc\u3078\u306essh\u30a2\u30af\u30bb\u30b9\u6a29\u9650\u4ed8\u4e0e\n###### \u30ed\u30fc\u30ab\u30eb\u306e\u516c\u958b\u9375\u3092\u30ea\u30e2\u30fc\u30c8\u30b5\u30fc\u30d0\u306e/home/deploy/.ssh/authorized_keys\u306b\u767b\u9332\u3057\u3066\u304a\u304f\u3002\n```bash\n# \u30ed\u30fc\u30ab\u30eb\u306e\u516c\u958b\u9375\u3092\u30b3\u30d4\u30fc\n[hoge@local ~]$ cat ~/.ssh/id_rsa.pub | pbcopy\n# EC2\u3078\u30ed\u30b0\u30a4\u30f3\u3057\u30ed\u30fc\u30ab\u30eb\u306e\u516c\u958b\u9375\u3092\u767b\u9332\n[hoge@local ~]$ ssh -i \"XXX.pem\" ec2-user@52.111.111.111\n[ec2-user@ip-172-31-4-XXX ~]$ sudo su - deploy\n[deploy@ip-172-31-4-XXX ~]$ mkdir .ssh\n[deploy@ip-172-31-4-XXX ~]$ chmod 700 .ssh\n[deploy@ip-172-31-4-XXX .ssh]$ cd .ssh\n[deploy@ip-172-31-4-XXX .ssh]$ touch authorized_keys\n[deploy@ip-172-31-4-XXX .ssh]$ chmod 600 authorized_keys\n[deploy@ip-172-31-4-XXX .ssh]$ vi authorized_keys\n# authorized_keys\u306b\u8cbc\u308a\u4ed8\u3051\u3066\u4fdd\u5b58\n```\n\n## 6. \u3010EC2\u3011\u30ed\u30fc\u30ab\u30eb\u304b\u3089deploy\u30e6\u30fc\u30b6\u30fc\u3078\u306e\u30a2\u30af\u30bb\u30b9\u78ba\u8a8d\n```\n[hoge@local ~]$ ssh deploy@52.111.111.111\n[deploy@ip-172-31-4-XXX ~]$ \n```\n\n## 7. \u3010EC2\u3011deploy\u30e6\u30fc\u30b6\u30fc\u304b\u3089gituser\u30e6\u30fc\u30b6\u30fc\u3078\u306e\u30a2\u30af\u30bb\u30b9\u6a29\u9650\u4ed8\u4e0e\n###### deploy\u30e6\u30fc\u30b6\u30fc\u306e\u516c\u958b\u9375\u306e\u4f5c\u6210\u3057\u30b3\u30d4\u30fc\n```bash\n[hoge@local ~]$ ssh deploy@52.111.111.111\n[deploy@ip-172-31-4-XXX ~]$ ssh-keygen -t rsa\n[deploy@ip-172-31-4-XXX ~]$ cat ~/.ssh/id_rsa.pub\n```\n###### deploy\u30e6\u30fc\u30b6\u30fc\u304b\u3089gituser\u3078\u306essh\u30a2\u30af\u30bb\u30b9\u8a31\u5bb9\n```bash\n[hoge@local ~]$ ssh gituser@52.111.111.111\n[gituser@ip-172-31-4-XXX ~]$ vi ~/.ssh/authorized_keys\n# deploy\u30e6\u30fc\u30b6\u30fc\u306e\u516c\u958b\u9375\u3092\u8cbc\u308a\u4ed8\u3051\u3066\u4fdd\u5b58\n```\n\n## 8. \u3010EC2\u3011deploy\u30e6\u30fc\u30b6\u30fc\u304b\u3089gituser\u30e6\u30fc\u30b6\u30fc\u3078\u306e\u30a2\u30af\u30bb\u30b9\u78ba\u8a8d\n```bash\n[hoge@local ~]$ ssh deploy@52.111.111.111\n[deploy@ip-172-31-4-XXX ~]$ ssh gituser@52.111.111.111\n[gituser@ip-172-31-4-XXX ~]$ \n```\n\n## 9. \u3010EC2\u3011deploy\u30e6\u30fc\u30b6\u30fc\u306e~/.ssh/config\u306bgituser\u306eHost\u3092\u767b\u9332\u3059\u308b\n```bash\n[hoge@local ~]$ ssh deploy@52.111.111.111\n[deploy@ip-172-31-4-XXX ~]$ touch ~/.ssh/config\n[deploy@ip-172-31-4-XXX ~]$ chmod 600 ~/.ssh/config\n[deploy@ip-172-31-4-XXX ~]$ vi ~/.ssh/config\n```\n\n```:~/.ssh/config\nHost gitserver\n  User         gituser\n  hostname     52.111.111.111\n  identityfile ~/.ssh/id_rsa\n```\n\n## 10. \u3010EC2\u3011deploy\u30e6\u30fc\u30b6\u30fc\u304b\u3089gitserver\u3078\u306e\u30a2\u30af\u30bb\u30b9\u78ba\u8a8d\n```bash\n[hoge@local ~]$ ssh deploy@52.111.111.111\n[deploy@ip-172-31-4-XXX ~]$ ssh gitserver\n[gituser@ip-172-31-4-XXX ~]$ \n```\n\n# \u30c7\u30d7\u30ed\u30a4\u30b3\u30de\u30f3\u30c9\u3092\u4f5c\u6210\n## 1. \u3010\u30ed\u30fc\u30ab\u30eb\u3011php\u30c7\u30d7\u30ed\u30a4\u30c4\u30fc\u30eb(altax)\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\n> altax\u30c1\u30e5\u30fc\u30c8\u30ea\u30a2\u30eb\u53ca\u3073\u30d5\u30a1\u30ec\u30f3\u30b9\n> http://kohkimakimoto.github.io/altax/ja/\n\n```bash\n[hoge@local ~]$ curl -L https://raw.github.com/kohkimakimoto/altax/master/installer.sh | bash -s system\n```\n\n## 2. \u3010\u30ed\u30fc\u30ab\u30eb\u3011altax\u3092\u521d\u671f\u5316\n```bash\n[hoge@local ~]$ cd ~/projects/global\n[hoge@local global]$ altax init\nCreated file: /Users/hoge/projects/global/.altax/config.php\nCreated file: /Users/hoge/projects/global/.altax/composer.json\nCreated file: /Users/hoge/projects/global/.altax/.gitignore\n```\n\n## 3. \u3010\u30ed\u30fc\u30ab\u30eb\u3011deploy\u30b3\u30de\u30f3\u30c9\u4f5c\u6210\n> altax deploy \u30c7\u30d7\u30ed\u30a4\u3059\u308b\u74b0\u5883\u540d \u9069\u7528\u3057\u305f\u3044\u30d6\u30e9\u30f3\u30c1\u540d\n\n```php:~/projects/global/.altax/config.php\nServer::node(\"deployserver\", array(\n    \"host\" => \"52.111.111.111\",\n    \"username\" => \"deploy\",\n    \"port\" => 22,\n    \"key\" => \"~/.ssh/id_rsa\"\n));\nServer::role(\"web\", array(\"deployserver\"));\nTask::register(\"deploy\", function($task) {\n\n  $envirName =  $task->getArgument(0, null);\n  $branchName =  $task->getArgument(1, null);\n  if (is_null($envirName) || is_null($branchName)) {\n    exit();\n  }\n\n  // \u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\n  $appDir = \"/var/www/$envirName\";\n\n  // Execute parallel processes for each nodes.\n  $task->exec(function($process) use ($appDir, $branchName) {\n\n    // Run a command remotely and get a return code.\n    if ($process->run(\"test -d $appDir\")->isFailed()) {\n      $process->run(\"git clone gitserver:~/repos/global.git $appDir\");\n    } else {\n      $process->run(array(\n        \"cd $appDir\",\n        \"git fetch -q\",\n        \"git co $branchName\",\n        \"git pull origin $branchName\",\n      ));\n    }\n\n  }, array(\"web\"));\n\n});\n```\n\n## 4. \u3010\u30ed\u30fc\u30ab\u30eb\u3011\u30c7\u30d7\u30ed\u30a4\u5b9f\u884c\u3057\u3066\u307f\u308b\n###### \u521d\u56de\n```bash\n[hoge@local ~]$ cd ~/projects/global\n[hoge@local global]$ echo \"feature1 deployed\" > index.php\n[hoge@local global]$ altax deploy feature1 develop\n[deployserver:555] Run: test -d /var/www/feature1\n[deployserver:555] Run: git clone gitserver:~/repos/global.git /var/www/feature1\nCloning into '/var/www/feature1'...\n```\n###### 2\u56de\u76ee\u4ee5\u964d\n```bash\n[hoge@local global]$ altax deploy feature1 master\n[deployserver:559] Run: test -d /var/www/feature1\n[deployserver:559] Run: cd /var/www/feature1 && git fetch -q && git pull origin master\nFrom gitserver:~/repos/global\n * branch            master     -> FETCH_HEAD\nAlready up-to-date.\n```\n\n## 5. \u3010\u30ed\u30fc\u30ab\u30eb\u3011\u30c7\u30d7\u30ed\u30a4\u3057\u305f\u30c9\u30e1\u30a4\u30f3\u306b\u5165\u3063\u3066\u66f4\u65b0\u3055\u308c\u305f\u304b\u78ba\u8a8d\n> http://feature1-develop.com/\n\n![FireShot Capture 2 -  - http___feature1-develop.com_.png](https://qiita-image-store.s3.amazonaws.com/0/71860/b326e3d9-a320-aad5-92f7-acedcafdbfef.png)\n\n\n\u3053\u308c\u3067\u30b5\u30fc\u30d0\u30fc\u69cb\u7bc9\u304b\u3089\u30c7\u30d7\u30ed\u30a4\u65b9\u6cd5\u307e\u3067\u3042\u308b\u7a0b\u5ea6\u5206\u304b\u308b\u3088\u3046\u306b\u306a\u3063\u305f\u3002\n\n# \u6b21\u306b\u3084\u308b\u3053\u3068\n\u4eca\u56de\u306f\u30ea\u30dd\u30b8\u30c8\u30ea\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u76f4\u63a5\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u30eb\u30fc\u30c8\u306b\u3057\u305f\u304c\u3001\n\u4e0b\u8a18\u306e\u3088\u3046\u306b\u69cb\u6210\u3092\u5909\u66f4\u3057\u3066\u304a\u304f\u3002\n\n- \u5404\u74b0\u5883\u306e\u30ea\u30dd\u30b8\u30c8\u30ea\u3092repo\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306b\u79fb\u884c\n- release\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u4e8c\u3064\u7528\u610f(release/A,release/B)\n- deploy \u2192 repo\u66f4\u65b0 \u2192 release\u5207\u308a\u66ff\u3048 \u2192 \u8a72\u5f53release\u306brsync\u3000\u2192 current\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306e\u30b7\u30f3\u30dc\u30ea\u30c3\u30af\u30ea\u30f3\u30af\u5909\u66f4\n- deploy\u30ed\u30c3\u30af\u30d5\u30a1\u30a4\u30eb\u4f5c\u6210(\u91cd\u8907\u5b9f\u884c\u9632\u6b62)\n", "tags": ["Git", "altax", "deploy"]}