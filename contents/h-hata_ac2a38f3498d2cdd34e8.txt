{"tags": ["amqp", "node-amqp", "RabbitMQ", "Node.js", "amqplib"], "context": "\n\nnode\u3067node-amqp\u3068amqplib\u3092\u4f7f\u3063\u305f\u5834\u5408\u306e\u305d\u308c\u305e\u308c\u306e\u66f8\u304d\u65b9\u306e\u9055\u3044\nRabbitMQ\u3092\u30ed\u30fc\u30ab\u30eb\u30db\u30b9\u30c8\u306b\u306f\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u8d77\u52d5\u6e08\u307f\nnpm install amqp\nnpm install amqplib\u3082\u7d42\u308f\u3063\u3066\u3044\u308b\u3082\u306e\u3068\u3057\u3066\u3044\u307e\u3059\u3002\n\n\uff13\u79d2\u3054\u3068\u306bbroker\u306b\u73fe\u5728\u6642\u523b\u3092\u9001\u4fe1\u3059\u308b\n\nnode-amqp\n\u63a5\u7d9a\u7528\u306e\u30aa\u30d7\u30b7\u30e7\u30f3\u306f\u30aa\u30d7\u30b7\u30e7\u30f3\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3067\u6307\u5b9a\u3057\u307e\u3059\n\u9001\u4fe1\u306b\u306fpublish\u95a2\u6570\u3092\u4f7f\u3044\u307e\u3059\n\npub1.js\nrequire('date-utils');\nvar amqp=require('amqp');\nvar connection = amqp.createConnection({\n    host: 'localhost',\n    login: 'genpub',\n    password: 'rabbitmq'\n});\nvar updater = setInterval(function() {\n    var cur= new Date();\n    var ts=cur.toFormat(\"HH24:MI:SS\");\n    console.log(ts);\n    connection.publish('work1',ts,{deliveryMode: 2});\n}, 3000);\n\n\n\namqplib\n\u63a5\u7d9a\u7528\u30aa\u30d7\u30b7\u30e7\u30f3\u306fURL\u306b\u57cb\u3081\u8fbc\u307f\u307e\u3059\nchannel\u751f\u6210\u3092\u660e\u793a\u7684\u306b\u884c\u3063\u3066\u3001\u30c1\u30e3\u30f3\u30cd\u30eb\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u306esendToQueue\u95a2\u6570\u3092\u4f7f\u3044\u307e\u3059\n\npub2.js\nrequire('date-utils');\nvar amqp = require('amqplib/callback_api');\nvar ch; \namqp.connect('amqp://genpub:rabbitmq@localhost', function(err, conn) {\n  conn.createChannel(function(err, channel) {\n    ch=channel;\n    console.log(\"connected\");\n  }); \n});\nvar updater = setInterval(function() {\n    var q = 'work1';\n    var cur= new Date();\n    var ts=cur.toFormat(\"HH24:MI:SS\");\n    ch.assertQueue(q, {durable: true});\n    ch.sendToQueue(q, new Buffer(ts), {persistent: true});\n    console.log(ts);\n}, 3000);\n\n\n\n\u30ef\u30fc\u30af\u30ad\u30e5\u30fc\u304b\u3089\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u53d7\u4fe1\u3059\u308b\n\u30ef\u30fc\u30af\u30ad\u30e5\u30fc\u306f\u3001\u8907\u6570\u306e\u53d7\u4fe1\u8005\u304c\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u5f85\u3061\u53d7\u3051\u3066\u3044\u308b\u6642\u3001\u8ab0\u304b\u4e00\u4eba\u306e\u53d7\u4fe1\u8005\u3060\u3051\u304c\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u53d7\u3051\u53d6\u308c\u307e\u3059\n\nnode-amqp\n\u5358\u7d14\u306b\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u53d7\u3051\u53d6\u3063\u305f\u3089\u305d\u308c\u3092\u8868\u793a\u3057\u3066\u518d\u5ea6\u5f85\u3061\u53d7\u3051\u72b6\u614b\u306b\u623b\u308a\u307e\u3059\u3002\n\nsub1.js\nvar amqp = require('amqp');\nvar connection = amqp.createConnection({\n  host: 'localhost',\n  login: 'gensub',\n  password: 'rabbitmq'\n});\nconnection.on('ready', function() {\n  connection.queue('work1', {autoDelete: false, durable: true},\n    function(q) {\n      q.subscribe(function(message){\n        var msg=message.data.toString('utf8');\n        console.log(msg);\n      }); \n  }); \n});\n\n\n\namqplib\n\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u53d7\u3051\u53d6\u3063\u305f\u3089\u3001\u4f55\u304b\u91cd\u3044\u4ed5\u4e8b\u3092\u3059\u308b\u60f3\u5b9a\u3068\u3057\u3066\uff11\uff10\u79d2\u9593\u30b9\u30ea\u30fc\u30d7\u3057\u307e\u3059\u3002\uff11\uff10\u79d2\u5f8c\u306b\u4ed5\u4e8b\u304c\u7d42\u308f\u3063\u305f\u3082\u306e\u3068\u3057\u3066\u3001\u518d\u3073\u30e1\u30c3\u30bb\u30fc\u30b8\u5f85\u3061\u53d7\u3051\u72b6\u614b\u306b\u623b\u308a\u307e\u3059\u3002\n\nsub2.js\nvar amqp = require('amqplib/callback_api');\namqp.connect('amqp://gensub:rabbitmq@localhost:5672', function(err, conn) {\n  conn.createChannel(function(err, ch) {\n    var q = 'work1';\n    ch.assertQueue(q, {durable: true});\n    ch.prefetch(1);//1\u30e1\u30c3\u30bb\u30fc\u30b8\u53d7\u3051\u53d6\u3063\u305f\u3089\u53d7\u4fe1\u306e\u4e00\u6642\u505c\u6b62\u3092\u901a\u77e5 \n    ch.consume(q, function(msg) {\n      var secs = 10; \n      console.log(\"Received %s\", msg.content.toString());\n      setTimeout(function() {\n        console.log(\"Done\");\n        ch.ack(msg);//\u518d\u3073\u53d7\u4fe1\u3092\u518d\u958b\n      }, secs * 1000);\n    }, {noAck: false});\n  }); \n});\n\n\n\n\u5b9f\u8a3c\u5b9f\u9a13\n\u7b2c\uff11\u753b\u9762\u3067pub1.js\u3092\u8d77\u52d5\u3057\u3066\uff13\u79d2\u3054\u3068\u306b\u73fe\u5728\u6642\u523b\u3092publish\u3059\u308b\n\u7b2c\uff12\u753b\u9762\u3067sub1.js\u3092\u8d77\u52d5\u3059\u308b\u3068\u3001\u6642\u523b\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u305d\u306e\u307e\u307e\u53d7\u4fe1\u3059\u308b\n\u7b2c\uff13\u753b\u9762\u306716:00:20\u306bsub2.js\u3092\u8d77\u52d5\u3059\u308b\u3068\u3001sub2.js\u306b16:00:21\u306e\u30e1\u30c3\u30bb\u30fc\u30b8\u304c\u6e21\u3055\u308c\u3066\u3001sub1.js\u306b\u306f\u6e21\u3089\u306a\u3044\u3002sub2.js\u306f10\u79d2\u9593\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u53d7\u3051\u53d6\u308c\u306a\u3044\u305f\u3081\u3001\u305d\u306e\u9593\u306fsub1\u304c\u53d7\u4fe1\u3059\u308b\u3002sub2\u306f10\u79d2\u5f8c\u306bDone\u3068\u3044\u3046\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u51fa\u3057\u3066\u3001\u518d\u3073\u30e1\u30c3\u30bb\u30fc\u30b8\u53d7\u4fe1\u53ef\u80fd\u72b6\u614b\u306b\u623b\u308b\u3002\n\n# node\u3067node-amqp\u3068amqplib\u3092\u4f7f\u3063\u305f\u5834\u5408\u306e\u305d\u308c\u305e\u308c\u306e\u66f8\u304d\u65b9\u306e\u9055\u3044\nRabbitMQ\u3092\u30ed\u30fc\u30ab\u30eb\u30db\u30b9\u30c8\u306b\u306f\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u8d77\u52d5\u6e08\u307f\nnpm install amqp\nnpm install amqplib\u3082\u7d42\u308f\u3063\u3066\u3044\u308b\u3082\u306e\u3068\u3057\u3066\u3044\u307e\u3059\u3002\n##\uff13\u79d2\u3054\u3068\u306bbroker\u306b\u73fe\u5728\u6642\u523b\u3092\u9001\u4fe1\u3059\u308b\n### node-amqp\n\u63a5\u7d9a\u7528\u306e\u30aa\u30d7\u30b7\u30e7\u30f3\u306f\u30aa\u30d7\u30b7\u30e7\u30f3\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3067\u6307\u5b9a\u3057\u307e\u3059\n\u9001\u4fe1\u306b\u306fpublish\u95a2\u6570\u3092\u4f7f\u3044\u307e\u3059\n\n```js:pub1.js\nrequire('date-utils');\nvar amqp=require('amqp');\nvar connection = amqp.createConnection({\n    host: 'localhost',\n    login: 'genpub',\n    password: 'rabbitmq'\n});\nvar updater = setInterval(function() {\n    var cur= new Date();\n    var ts=cur.toFormat(\"HH24:MI:SS\");\n    console.log(ts);\n    connection.publish('work1',ts,{deliveryMode: 2});\n}, 3000);\n```\n### amqplib\n\n\u63a5\u7d9a\u7528\u30aa\u30d7\u30b7\u30e7\u30f3\u306fURL\u306b\u57cb\u3081\u8fbc\u307f\u307e\u3059\nchannel\u751f\u6210\u3092\u660e\u793a\u7684\u306b\u884c\u3063\u3066\u3001\u30c1\u30e3\u30f3\u30cd\u30eb\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u306esendToQueue\u95a2\u6570\u3092\u4f7f\u3044\u307e\u3059\n\n```js:pub2.js\nrequire('date-utils');\nvar amqp = require('amqplib/callback_api');\nvar ch; \namqp.connect('amqp://genpub:rabbitmq@localhost', function(err, conn) {\n  conn.createChannel(function(err, channel) {\n    ch=channel;\n    console.log(\"connected\");\n  }); \n});\nvar updater = setInterval(function() {\n    var q = 'work1';\n    var cur= new Date();\n    var ts=cur.toFormat(\"HH24:MI:SS\");\n    ch.assertQueue(q, {durable: true});\n    ch.sendToQueue(q, new Buffer(ts), {persistent: true});\n    console.log(ts);\n}, 3000);\n```\n## \u30ef\u30fc\u30af\u30ad\u30e5\u30fc\u304b\u3089\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u53d7\u4fe1\u3059\u308b\n\u30ef\u30fc\u30af\u30ad\u30e5\u30fc\u306f\u3001\u8907\u6570\u306e\u53d7\u4fe1\u8005\u304c\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u5f85\u3061\u53d7\u3051\u3066\u3044\u308b\u6642\u3001\u8ab0\u304b\u4e00\u4eba\u306e\u53d7\u4fe1\u8005\u3060\u3051\u304c\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u53d7\u3051\u53d6\u308c\u307e\u3059\n### node-amqp\n\u5358\u7d14\u306b\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u53d7\u3051\u53d6\u3063\u305f\u3089\u305d\u308c\u3092\u8868\u793a\u3057\u3066\u518d\u5ea6\u5f85\u3061\u53d7\u3051\u72b6\u614b\u306b\u623b\u308a\u307e\u3059\u3002\n\n```js:sub1.js\nvar amqp = require('amqp');\nvar connection = amqp.createConnection({\n  host: 'localhost',\n  login: 'gensub',\n  password: 'rabbitmq'\n});\nconnection.on('ready', function() {\n  connection.queue('work1', {autoDelete: false, durable: true},\n    function(q) {\n      q.subscribe(function(message){\n        var msg=message.data.toString('utf8');\n        console.log(msg);\n      }); \n  }); \n});\n```\n### amqplib\n\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u53d7\u3051\u53d6\u3063\u305f\u3089\u3001\u4f55\u304b\u91cd\u3044\u4ed5\u4e8b\u3092\u3059\u308b\u60f3\u5b9a\u3068\u3057\u3066\uff11\uff10\u79d2\u9593\u30b9\u30ea\u30fc\u30d7\u3057\u307e\u3059\u3002\uff11\uff10\u79d2\u5f8c\u306b\u4ed5\u4e8b\u304c\u7d42\u308f\u3063\u305f\u3082\u306e\u3068\u3057\u3066\u3001\u518d\u3073\u30e1\u30c3\u30bb\u30fc\u30b8\u5f85\u3061\u53d7\u3051\u72b6\u614b\u306b\u623b\u308a\u307e\u3059\u3002\n\n```js:sub2.js\nvar amqp = require('amqplib/callback_api');\namqp.connect('amqp://gensub:rabbitmq@localhost:5672', function(err, conn) {\n  conn.createChannel(function(err, ch) {\n    var q = 'work1';\n    ch.assertQueue(q, {durable: true});\n    ch.prefetch(1);//1\u30e1\u30c3\u30bb\u30fc\u30b8\u53d7\u3051\u53d6\u3063\u305f\u3089\u53d7\u4fe1\u306e\u4e00\u6642\u505c\u6b62\u3092\u901a\u77e5 \n    ch.consume(q, function(msg) {\n      var secs = 10; \n      console.log(\"Received %s\", msg.content.toString());\n      setTimeout(function() {\n        console.log(\"Done\");\n        ch.ack(msg);//\u518d\u3073\u53d7\u4fe1\u3092\u518d\u958b\n      }, secs * 1000);\n    }, {noAck: false});\n  }); \n});\n```\n##\u5b9f\u8a3c\u5b9f\u9a13\n\u7b2c\uff11\u753b\u9762\u3067pub1.js\u3092\u8d77\u52d5\u3057\u3066\uff13\u79d2\u3054\u3068\u306b\u73fe\u5728\u6642\u523b\u3092publish\u3059\u308b\n\u7b2c\uff12\u753b\u9762\u3067sub1.js\u3092\u8d77\u52d5\u3059\u308b\u3068\u3001\u6642\u523b\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u305d\u306e\u307e\u307e\u53d7\u4fe1\u3059\u308b\n\u7b2c\uff13\u753b\u9762\u306716:00:20\u306bsub2.js\u3092\u8d77\u52d5\u3059\u308b\u3068\u3001sub2.js\u306b16:00:21\u306e\u30e1\u30c3\u30bb\u30fc\u30b8\u304c\u6e21\u3055\u308c\u3066\u3001sub1.js\u306b\u306f\u6e21\u3089\u306a\u3044\u3002sub2.js\u306f10\u79d2\u9593\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u53d7\u3051\u53d6\u308c\u306a\u3044\u305f\u3081\u3001\u305d\u306e\u9593\u306fsub1\u304c\u53d7\u4fe1\u3059\u308b\u3002sub2\u306f10\u79d2\u5f8c\u306bDone\u3068\u3044\u3046\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u51fa\u3057\u3066\u3001\u518d\u3073\u30e1\u30c3\u30bb\u30fc\u30b8\u53d7\u4fe1\u53ef\u80fd\u72b6\u614b\u306b\u623b\u308b\u3002\n\n![alt](http://www.olt.tokyo/img/wq.png)\n"}