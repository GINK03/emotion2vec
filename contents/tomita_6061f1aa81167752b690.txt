{"context": " More than 1 year has passed since last update.fabric\u3068host\u3068\u79c1 2014 \u306e\u9032\u5316\u7cfb\u3001\u4eca\u306f\u3053\u3093\u306a\u304b\u3093\u3058\u306b\u306a\u3063\u3066\u3044\u308b\n\n\u3069\u306etask\u306e\u524d\u306b\u3082\uff08\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092\u30ed\u30fc\u30c9\u3059\u308b\u306a\u3069\uff09\u5fc5\u305a\u3084\u308a\u305f\u3044\u3082\u306e\u304c\u3042\u308b\u3002\u2192 \u3053\u308c\u306b\u3064\u3044\u3066\u306f\u30012.x\u7cfb\u3067\u306fdepends\u304c\u30b5\u30dd\u30fc\u30c8\u3055\u308c\u308b\u3089\u3057\u3044\n\n\u3084\u308a\u305f\u3044\u3053\u3068\u304c\uff11\u500b\u5897\u3048\u3066\n\n\nfab prod deproy \u3068\u304b\u3059\u308b\u3068\u5168\u30b5\u30fc\u30d0\u30fc\u306b\u30c7\u30d7\u30ed\u30a4\u3001fab -H \"web1\" deploy \u3068\u3059\u308b\u3068web1 \u3060\u3051 \u306b\u30c7\u30d7\u30ed\u30a4\u3057\u305f\u3044\uff08\u30c7\u30d5\u30a9\u30eb\u30c8\u3067\u306f\u30ea\u30b9\u30c8\u6a19\u6e96\u306e\u30ea\u30b9\u30c8\uff0b\u6307\u5b9a\u3057\u305f\u30db\u30b9\u30c8\u306b\u306a\u308b\uff09\n\nfab\u306f\u3001\u5404\u30bf\u30b9\u30af\u5b9f\u884c\u3054\u3068\u306bhost\u304c\u30b3\u30d4\u30fc\u3055\u308c\u3066\u30ec\u30ad\u30b7\u30ab\u30eb\u306b\u4f7f\u308f\u308c\u308b\u306e\u3067\u3001\u3061\u3087\u3044\u8907\u96d1\u3067\u3042\u308b\u3002\u3051\u3063\u304d\u3087\u304f\u5404task\u3067\u5b9f\u884c\u3059\u3079\u304f\u3001task\u306e\u30e9\u30c3\u30d1\u30fc\u3068\u306a\u3063\u305f\u3002\u672c\u5bb6\u306bpatch\u9001\u308d\u3046\u3068\u601d\u3063\u305f\u304c\u3001\u307c\u304f\u306b\u3068\u3063\u3066\u305d\u306e\u65b9\u304c\u81ea\u7136\u3060\u308d\u3068\u304a\u3082\u3046\u3060\u3051\u3067\u4ed5\u69d8\u3067\u3042\u308b\u304b\u3089\u306b\u3002\nfrom fabric.api import *\nfrom fabric.contrib import files as remote_file\n\nimport functools\nimport importlib\nimport json\nimport os\nimport pprint\nimport re\nimport time\n\ndef command(*args, **kwargs):\n    \"\"\"\n    [Decorator] wrapper @task to check env before task.\n    \"\"\"\n\n    # @command(...) or just @command\n    invoked = bool(not args or kwargs)\n\n    def deco(func):\n        @functools.wraps(func)\n        def wrapper(*args, **kwargs):\n            execute(check_env)\n            return func(*args, **kwargs)\n\n        if len(kwargs) > 0:\n            return task(**kwargs)(wrapper)\n        else:\n            return task(wrapper)\n\n    if not invoked:\n        return deco(args[0])\n    else:\n        return deco\n\n@runs_once\ndef check_env():\n    if not env.get('app'):\n        execute('app', None) # \u3068\u304b\n    if not env.get('app'):\n        abort('please set \"app\"')\n\n    # \u3068\u304b\u306a\u3093\u3068\u304b\u3061\u3047\u3063\u304f\u3057\u305f\u308a\n\n    if not env.get('target'):\n        if len(env.hosts) > 0:\n            env.target = 'custom'\n        else:\n            abort('please set target hosts: fab (prod|dev) or fab -H \"server-01,server-02\"')\n\n\n\u30bf\u30b9\u30af\u66f8\u304f\u5074\u3067\u3001from fabric.api import *\u306e\u4ee3\u308f\u308a\u306b\u3001\u3053\u3044\u3064\u304b\u3089 import * \u3059\u308b\u3068\u3044\u308d\u3044\u308dimport\u3055\u308c\u308b\u3002@command \u304c @task \u3068\u540c\u3058\u3088\u3046\u306b\u4f7f\u3048\u308b\nfrom .task import *\n\n@command\ndef deploy():\n    \"\"\"\u30a2\u30d7\u30ea\u30c7\u30d7\u30ed\u30a4\uff08master\u30d6\u30e9\u30f3\u30c1\u304b\u3089pull\u3059\u308b\u3070\u3042\u3044\uff09\"\"\"\n    if remote_file.exists(env.app.path):\n        with cd(env.app.path):\n            run('git fetch -q -p origin && git merge -q origin/master') # \u4f8b\n    else:\n\n\nprod\u30bf\u30b9\u30af\u306f\u3053\u3093\u306a\u304b\u3093\u3058\u3002env.target\u306fhosts\u304c\u4f55\u7d4c\u7531\u3067\u30bb\u30c3\u30c8\u3055\u308c\u305f\u304b\u899a\u3048\u3068\u304f\u7528\u306e\u72ec\u81ea\u5909\u6570\n@task\n@runs_once\ndef prod():\n    \"\"\"env.hosts\u306b\u672c\u756a\u30b5\u30fc\u30d0\u30fc\u90e1\u3092\u30bb\u30c3\u30c8\"\"\"\n    env.target = 'prod'\n    env.hosts = [\n        'web01',\n        'web02',\n        'web03',\n        'web04',\n    ]\n\n[fabric\u3068host\u3068\u79c1 2014](http://tomi-ru.hatenablog.com/entry/2014/03/24/214955) \u306e\u9032\u5316\u7cfb\u3001\u4eca\u306f\u3053\u3093\u306a\u304b\u3093\u3058\u306b\u306a\u3063\u3066\u3044\u308b\n\n* \u3069\u306etask\u306e\u524d\u306b\u3082\uff08\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092\u30ed\u30fc\u30c9\u3059\u308b\u306a\u3069\uff09\u5fc5\u305a\u3084\u308a\u305f\u3044\u3082\u306e\u304c\u3042\u308b\u3002\u2192 \u3053\u308c\u306b\u3064\u3044\u3066\u306f\u30012.x\u7cfb\u3067\u306fdepends\u304c\u30b5\u30dd\u30fc\u30c8\u3055\u308c\u308b\u3089\u3057\u3044\n\n\u3084\u308a\u305f\u3044\u3053\u3068\u304c\uff11\u500b\u5897\u3048\u3066\n\n* `fab prod deproy` \u3068\u304b\u3059\u308b\u3068\u5168\u30b5\u30fc\u30d0\u30fc\u306b\u30c7\u30d7\u30ed\u30a4\u3001`fab -H \"web1\" deploy` \u3068\u3059\u308b\u3068web1 **\u3060\u3051** \u306b\u30c7\u30d7\u30ed\u30a4\u3057\u305f\u3044\uff08\u30c7\u30d5\u30a9\u30eb\u30c8\u3067\u306f\u30ea\u30b9\u30c8\u6a19\u6e96\u306e\u30ea\u30b9\u30c8\uff0b\u6307\u5b9a\u3057\u305f\u30db\u30b9\u30c8\u306b\u306a\u308b\uff09\n\nfab\u306f\u3001\u5404\u30bf\u30b9\u30af\u5b9f\u884c\u3054\u3068\u306bhost\u304c\u30b3\u30d4\u30fc\u3055\u308c\u3066\u30ec\u30ad\u30b7\u30ab\u30eb\u306b\u4f7f\u308f\u308c\u308b\u306e\u3067\u3001\u3061\u3087\u3044\u8907\u96d1\u3067\u3042\u308b\u3002\u3051\u3063\u304d\u3087\u304f\u5404task\u3067\u5b9f\u884c\u3059\u3079\u304f\u3001task\u306e\u30e9\u30c3\u30d1\u30fc\u3068\u306a\u3063\u305f\u3002\u672c\u5bb6\u306bpatch\u9001\u308d\u3046\u3068\u601d\u3063\u305f\u304c\u3001\u307c\u304f\u306b\u3068\u3063\u3066\u305d\u306e\u65b9\u304c\u81ea\u7136\u3060\u308d\u3068\u304a\u3082\u3046\u3060\u3051\u3067\u4ed5\u69d8\u3067\u3042\u308b\u304b\u3089\u306b\u3002\n\n```python\nfrom fabric.api import *\nfrom fabric.contrib import files as remote_file\n\nimport functools\nimport importlib\nimport json\nimport os\nimport pprint\nimport re\nimport time\n\ndef command(*args, **kwargs):\n    \"\"\"\n    [Decorator] wrapper @task to check env before task.\n    \"\"\"\n    \n    # @command(...) or just @command\n    invoked = bool(not args or kwargs)\n    \n    def deco(func):\n        @functools.wraps(func)\n        def wrapper(*args, **kwargs):\n            execute(check_env)\n            return func(*args, **kwargs)\n        \n        if len(kwargs) > 0:\n            return task(**kwargs)(wrapper)\n        else:\n            return task(wrapper)\n    \n    if not invoked:\n        return deco(args[0])\n    else:\n        return deco\n \n@runs_once\ndef check_env():\n    if not env.get('app'):\n        execute('app', None) # \u3068\u304b\n    if not env.get('app'):\n        abort('please set \"app\"')\n    \n    # \u3068\u304b\u306a\u3093\u3068\u304b\u3061\u3047\u3063\u304f\u3057\u305f\u308a\n\n    if not env.get('target'):\n        if len(env.hosts) > 0:\n            env.target = 'custom'\n        else:\n            abort('please set target hosts: fab (prod|dev) or fab -H \"server-01,server-02\"')\n\n```\n\n\u30bf\u30b9\u30af\u66f8\u304f\u5074\u3067\u3001`from fabric.api import *`\u306e\u4ee3\u308f\u308a\u306b\u3001\u3053\u3044\u3064\u304b\u3089 `import *` \u3059\u308b\u3068\u3044\u308d\u3044\u308dimport\u3055\u308c\u308b\u3002`@command` \u304c `@task` \u3068\u540c\u3058\u3088\u3046\u306b\u4f7f\u3048\u308b\n\n```py\nfrom .task import *\n\n@command\ndef deploy():\n    \"\"\"\u30a2\u30d7\u30ea\u30c7\u30d7\u30ed\u30a4\uff08master\u30d6\u30e9\u30f3\u30c1\u304b\u3089pull\u3059\u308b\u3070\u3042\u3044\uff09\"\"\"\n    if remote_file.exists(env.app.path):\n        with cd(env.app.path):\n            run('git fetch -q -p origin && git merge -q origin/master') # \u4f8b\n    else:\n\n```\n\nprod\u30bf\u30b9\u30af\u306f\u3053\u3093\u306a\u304b\u3093\u3058\u3002env.target\u306fhosts\u304c\u4f55\u7d4c\u7531\u3067\u30bb\u30c3\u30c8\u3055\u308c\u305f\u304b\u899a\u3048\u3068\u304f\u7528\u306e\u72ec\u81ea\u5909\u6570\n\n```py\n@task\n@runs_once\ndef prod():\n    \"\"\"env.hosts\u306b\u672c\u756a\u30b5\u30fc\u30d0\u30fc\u90e1\u3092\u30bb\u30c3\u30c8\"\"\"\n    env.target = 'prod'\n    env.hosts = [\n        'web01',\n        'web02',\n        'web03',\n        'web04',\n    ]\n```\n", "tags": ["fabric"]}