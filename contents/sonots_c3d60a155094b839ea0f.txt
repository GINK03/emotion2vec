{"context": "\u3084\u308a\u305f\u3044\u3053\u3068: capistrano \u306e\u30bf\u30b9\u30af\u3092 vagrant \u30de\u30b7\u30f3\u306b\u9069\u7528\u3057\u3066\u958b\u767a\u3057\u305f\u3044\u3002vagrant \u3078\u306e\u30ed\u30b0\u30a4\u30f3\u60c5\u5831\u3092 capistrano \u304b\u3089\u53d6\u5f97\u3057\u305f\u3044\n\n\u4e8b\u524d\u6e96\u5099\nvagrant \u5185\u3067 git clone \u306a\u3069\u3059\u308b\u3068\u601d\u3046\u306e\u3067\u3001ssh agent forward \u306e\u8a2d\u5b9a\u3092\u3057\u3066\u304a\u304f \n\nVagrantfile\nVagrant.configure(VAGRANTFILE_API_VERSION) do |config|\n+  config.ssh.forward_agent = true\nend\n\n\nMac \u306e keychain \u306b\u9375\u3092\u767b\u9332\u3057\u3066\u304a\u304f. keychain \u306b\u5165\u308c\u3066\u304a\u304f\u3068\u6bce\u56de ssh-add \u3057\u306a\u304f\u3066\u3059\u3080\u3002-K \u30aa\u30d7\u30b7\u30e7\u30f3\u3092\u4f7f\u3046\u3002\n$ ssh-add -K .ssh/id_rsa\n\n\n\u3084\u308a\u304b\u305f\nvagrant ssh-config \u3067\u8af8\u3005\u60c5\u5831\u304c\u53d6\u308c\u308b\n$ vagrant ssh-config\nHost vagrant-centos\n  HostName 127.0.0.1\n  User vagrant\n  Port 2200\n  UserKnownHostsFile /dev/null\n  StrictHostKeyChecking no\n  PasswordAuthentication no\n  IdentityFile /Users/seo.naotoshi/.vagrant/machines/vagrant-centos/virtualbox/private_key\n  IdentitiesOnly yes\n  LogLevel FATAL\n  ForwardAgent yes\n\n\u306a\u306e\u3067\u3001\u3053\u308c\u3092 capistrano \u306e\u5909\u6570\u306b\u8a2d\u5b9a\u3059\u308b\u30e1\u30bd\u30c3\u30c9\u3092\u3061\u3087\u308d\u3063\u3068\u66f8\u3044\u3066\u5229\u7528\u3059\u308b\n\nconfig/deploy.rb\nset :application, 'oreno'\nset :repo_url, 'git@github.com:sonots/oreno.git'\nset :deploy_to, '/var/app/oreno'\n\ndef set_vagrant_user\n  ssh_config = {}\n  Bundler.with_clean_env do\n    out = `vagrant ssh-config`\n    out.split(\"\\n\").each do |line|\n      line.strip!\n      key, value = line.split(\" \", 2)\n      value.slice!(0) if value.start_with?('\"')\n      value.slice!(-1) if value.end_with?('\"')\n      ssh_config[key] = value\n    end\n  end\n\n  set :user, ssh_config[\"User\"]\n  set :ssh_options,\n    user: ssh_config[\"User\"],\n    port: ssh_config[\"Port\"],\n    keys: [ssh_config[\"IdentityFile\"]],\n    forward_agent: ssh_config[\"ForwardAgent\"] == \"yes\" ? true : false\nend\n\n\n\nconfig/deploy/development.rb\nset_vagrant_user\n\nroles :app, ['127.0.0.1']\n\n\n\u3053\u308c\u3067\u3001\n$ cap development deploy\n\n\u3067 vagrant \u306b\u30ed\u30b0\u30a4\u30f3\u3057\u3066\u30c7\u30d7\u30ed\u30a4\u3067\u304d\u308b\u3002\n\nToDo\n\u3081\u3063\u3061\u3083\u5c0f\u3055\u3044\u30e1\u30bd\u30c3\u30c9\u3060\u3051\u3069 gem \u306b\u3057\u3066\u3082\u3044\u3044\u306e\u304b\u3082\u306d\u3002\n\u3084\u308a\u305f\u3044\u3053\u3068: capistrano \u306e\u30bf\u30b9\u30af\u3092 vagrant \u30de\u30b7\u30f3\u306b\u9069\u7528\u3057\u3066\u958b\u767a\u3057\u305f\u3044\u3002vagrant \u3078\u306e\u30ed\u30b0\u30a4\u30f3\u60c5\u5831\u3092 capistrano \u304b\u3089\u53d6\u5f97\u3057\u305f\u3044\n\n## \u4e8b\u524d\u6e96\u5099\n\nvagrant \u5185\u3067 git clone \u306a\u3069\u3059\u308b\u3068\u601d\u3046\u306e\u3067\u3001ssh agent forward \u306e\u8a2d\u5b9a\u3092\u3057\u3066\u304a\u304f \n\n```diff:Vagrantfile\nVagrant.configure(VAGRANTFILE_API_VERSION) do |config|\n+  config.ssh.forward_agent = true\nend\n```\n\nMac \u306e keychain \u306b\u9375\u3092\u767b\u9332\u3057\u3066\u304a\u304f. keychain \u306b\u5165\u308c\u3066\u304a\u304f\u3068\u6bce\u56de ssh-add \u3057\u306a\u304f\u3066\u3059\u3080\u3002-K \u30aa\u30d7\u30b7\u30e7\u30f3\u3092\u4f7f\u3046\u3002\n\n```\n$ ssh-add -K .ssh/id_rsa\n```\n\n## \u3084\u308a\u304b\u305f\n\nvagrant ssh-config \u3067\u8af8\u3005\u60c5\u5831\u304c\u53d6\u308c\u308b\n\n```\n$ vagrant ssh-config\nHost vagrant-centos\n  HostName 127.0.0.1\n  User vagrant\n  Port 2200\n  UserKnownHostsFile /dev/null\n  StrictHostKeyChecking no\n  PasswordAuthentication no\n  IdentityFile /Users/seo.naotoshi/.vagrant/machines/vagrant-centos/virtualbox/private_key\n  IdentitiesOnly yes\n  LogLevel FATAL\n  ForwardAgent yes\n```\n\n\u306a\u306e\u3067\u3001\u3053\u308c\u3092 capistrano \u306e\u5909\u6570\u306b\u8a2d\u5b9a\u3059\u308b\u30e1\u30bd\u30c3\u30c9\u3092\u3061\u3087\u308d\u3063\u3068\u66f8\u3044\u3066\u5229\u7528\u3059\u308b\n\n```ruby:config/deploy.rb\nset :application, 'oreno'\nset :repo_url, 'git@github.com:sonots/oreno.git'\nset :deploy_to, '/var/app/oreno'\n\ndef set_vagrant_user\n  ssh_config = {}\n  Bundler.with_clean_env do\n    out = `vagrant ssh-config`\n    out.split(\"\\n\").each do |line|\n      line.strip!\n      key, value = line.split(\" \", 2)\n      value.slice!(0) if value.start_with?('\"')\n      value.slice!(-1) if value.end_with?('\"')\n      ssh_config[key] = value\n    end\n  end\n\n  set :user, ssh_config[\"User\"]\n  set :ssh_options,\n    user: ssh_config[\"User\"],\n    port: ssh_config[\"Port\"],\n    keys: [ssh_config[\"IdentityFile\"]],\n    forward_agent: ssh_config[\"ForwardAgent\"] == \"yes\" ? true : false\nend\n```\n\n```ruby:config/deploy/development.rb\nset_vagrant_user\n\nroles :app, ['127.0.0.1']\n```\n\n\u3053\u308c\u3067\u3001\n\n```\n$ cap development deploy\n```\n\n\u3067 vagrant \u306b\u30ed\u30b0\u30a4\u30f3\u3057\u3066\u30c7\u30d7\u30ed\u30a4\u3067\u304d\u308b\u3002\n\n## ToDo\n\n\u3081\u3063\u3061\u3083\u5c0f\u3055\u3044\u30e1\u30bd\u30c3\u30c9\u3060\u3051\u3069 gem \u306b\u3057\u3066\u3082\u3044\u3044\u306e\u304b\u3082\u306d\u3002\n", "tags": ["capistrano3", "capistrano"]}