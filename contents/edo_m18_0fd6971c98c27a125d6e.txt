{"context": " More than 1 year has passed since last update.\u73fe\u5728\u306e\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u3067Metal\u306b\u89e6\u308c\u308b\u5fc5\u8981\u304c\u3042\u3063\u305f\u306e\u3067\u3056\u3063\u304f\u308a\u8abf\u3079\u3066\u307f\u307e\u3057\u305f\u3002\n\n\u4ee5\u4e0b\u306e\u8a18\u4e8b\u3092\u6700\u521d\u306b\u8aad\u3093\u3067\u304a\u304f\u3068\u8272\u3005\u3068\u7406\u89e3\u3057\u3084\u3059\u304f\u3066\u30aa\u30b9\u30b9\u30e1\u3067\u3059\u3002\n\nMetal\u306e\u300cshared CPU/GPU memory buffer\u300d\u306b\u3064\u3044\u3066\nMetal\u306e\u30b3\u30fc\u30c9\u3092\u8aad\u3080\u524d\u306b\u77e5\u3063\u3066\u304a\u304f\u3068\u697d\u306a\u3053\u3068\n\n\nMetal\u306e\u30b9\u30d4\u30fc\u30c9\u30a2\u30c3\u30d7\u306e\u8981\u54e1\u306e\u3072\u3068\u3064\u306fCPU/GPU\u306e\u30e1\u30e2\u30ea\u5171\u6709\n\u4e0a\u8a18\u306e\u8a18\u4e8b\u306e\u3056\u3063\u304f\u308a\u6982\u8981\u3060\u3051\u3092\u66f8\u304f\u3068\u3001Metal\u306e\u30b9\u30d4\u30fc\u30c9\u30a2\u30c3\u30d7\u306e\u79d8\u8a23\u306f\u3001CPU/GPU\u9593\u3067\u306e\u30e1\u30e2\u30ea\u5171\u6709\u3067\u3059\u3002\uff08\u305d\u308c\u3060\u3051\u3058\u3083\u306a\u3044\u3067\u3059\u304c\uff09\n\u305d\u306e\u305f\u3081\u3001OpenGL\u3067\u306f\u3044\u3061\u3044\u3061\u30c7\u30fc\u30bf\u306e\u3084\u308a\u3068\u308a\u3092\u5c0f\u96e3\u3057\u304f\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3057\u305f\u304c\u3001Metal\u3067\u306f\u305d\u308c\u304c\u3042\u308a\u307e\u305b\u3093\u3002\n\u3057\u304b\u3057Metal\u306fiOS\u7aef\u672b\u306e\u3001\u3055\u3089\u306b\u9650\u3089\u308c\u305f\u30c1\u30c3\u30d7\u304c\u642d\u8f09\u3055\u308c\u305f\u7aef\u672b\u306b\u9650\u5b9a\u3057\u3066\u3044\u308b\u6280\u8853\u3067\u3059\u3002\n\uff08\u9006\u306b\u8a00\u3046\u3068\u3001\u3060\u304b\u3089\u3053\u305d\u5b9f\u73fe\u3067\u304d\u3066\u3044\u308b\u6280\u8853\u3067\u3059\uff09\n\u7d30\u304b\u3044\u8a71\u3092\u3059\u308b\u3068\u3001\u672c\u6765GPU\u3068CPU\u306f\u7269\u7406\u7684\u306b\u96e2\u308c\u3066\u3044\u307e\u3059\u3002\n\uff08\u81ea\u4f5cPC\u3092\u4f5c\u3063\u305f\u7d4c\u9a13\u304c\u3042\u308b\u4eba\u3067\u3042\u308c\u3070GPU\u304c\u96e2\u308c\u3066\u3044\u308b\u306e\u306f\u3059\u3050\u5206\u304b\u308b\u3068\u601d\u3044\u307e\u3059\uff09\nCPU\u306e\u51e6\u7406\u30b9\u30d4\u30fc\u30c9\u7684\u306b\u3053\u306e\u8ddd\u96e2\u304c\u81f4\u547d\u7684\u306a\u306e\u3067\u3059\u3002\n\u305d\u308c\u304cA7\u30c1\u30c3\u30d7\u4ee5\u964d\u3001\uff08\u3068\u3044\u3046\u304biPhone\u306e\u69cb\u9020\u4e0a\uff09CPU\u3068GPU\u306f\u307b\u307c\u540c\u5c45\u3057\u3066\u304a\u308a\u3001\u524d\u8ff0\u306e\u3088\u3046\u306b\u30e1\u30e2\u30ea\u306e\u5171\u6709\u304c\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u3063\u305f\u3001\u3068\u3044\u3046\u308f\u3051\u3067\u3059\u3002\n\u306a\u306e\u3067\u30b7\u30df\u30e5\u30ec\u30fc\u30bf\u3067\u306f\u52d5\u304b\u306a\u3044\u3093\u3067\u3059\u306d\u3002\uff08PC\u3060\u3068\u5f53\u7136GPU\u306f\u96e2\u308c\u3066\u308b\uff09\n\nMetal\u306e\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\n\u4e3b\u306b\u3053\u3061\u3089\u306e\u8a18\u4e8b\u3092\u53c2\u8003\u306b\u3057\u307e\u3057\u305f\u3002\nMetal\u3092\u5229\u7528\u3059\u308b\u306b\u306f\u6700\u4f4e\u9650\u3001\u4ee5\u4e0b\u306e\u3082\u306e\u3092\u6e96\u5099\u3057\u307e\u3059\u3002\n\n\u300cMTLDevice\u300d\u306e\u751f\u6210\n\u300cCAMetalLayer\u300d\u306e\u751f\u6210\n\u300cVertex Buffer\u300d\u306e\u751f\u6210\n\u300cVertex Shader\u300d\u306e\u751f\u6210\n\u300cFragment Shader\u300d\u306e\u751f\u6210\n\u300cRender Pipeline\u300d\u306e\u751f\u6210\n\u300cCommand Queue\u300d\u306e\u751f\u6210\n\u300cCommand Buffer\u300d\u306e\u751f\u6210\n\u300cRender Pass Descriptor\u300d\u306e\u751f\u6210\n\u300cRender Command Encoder\u300d\u306e\u751f\u6210\n\n\nMTLDevice\u306e\u751f\u6210\nMTLDevice\u306fGPU\u306b\u30c0\u30a4\u30ec\u30af\u30c8\u306b\u30b3\u30cd\u30af\u30b7\u30e7\u30f3\u3092\u5f35\u308b\u3082\u306e\u3068\u8003\u3048\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\nOpenGL\u3067\u3044\u3046\u3068\u3053\u308d\u306egl\u30b3\u30f3\u30c6\u30ad\u30b9\u30c8\u306b\u4f3c\u3066\u3044\u307e\u3059\u3002\n\u30c6\u30af\u30b9\u30c1\u30e3\u306e\u751f\u6210\u3001\u30d0\u30c3\u30d5\u30a1\u306e\u751f\u6210\u306a\u3069GPU\u3078\u306e\u547d\u4ee4\u306f\u3053\u306eMTLDevice\u3092\u901a\u3057\u3066\u884c\u3044\u307e\u3059\u3002\n\ncreate-MTLDevice\n// MTLDeivce\u306e\u751f\u6210\nid <MTLDevice> device = MTLCreateSystemDefaultDevice();\n\n\n\nCAMetalLayer\u306e\u751f\u6210\nCAMetalLayer\u306fMetal.framework\u3067\u306f\u306a\u304f\u3001\u540d\u524d\u304b\u3089\u3082\u5206\u304b\u308b\u901a\u308aCore Animation\u3067\u5b9a\u7fa9\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n\u306a\u306e\u3067QuartzCore.framework\u3092\u8aad\u307f\u8fbc\u3080\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\u5f79\u5272\u306fMetal\u306e\u30ec\u30f3\u30c0\u30ea\u30f3\u30b0\u3092\u884c\u3046\u30ec\u30a4\u30e4\u30fc\u3067\u3059\u3002\n\ncreate-CAMetalLayer\nimport QuartzCore;\n\n// CAMetalLayer\u306e\u751f\u6210\nCAMetalLayer *metalLayer = [CAMetalLayer layer];\nmetalLayer.device = device;\nmetalLayer.pixelFormat = MTLPixelFormatBGRA8Unorm;\nmetalLayer.framebufferOnly = YES;\nmetalLayer.frame = self.view.layer.frame;\n[self.view.layer addSublayer:metalLayer];\n\n\n\nVertex Buffer\u306e\u751f\u6210\nOpenGL\u3067\u306fVBO\u3067\u3059\u306d\u3002\n\ncreate-Vertex_Buffer\n// \u9802\u70b9\u60c5\u5831\nCGFloat vertexData[] = {\n     0.0,  1.0, 0.0,\n    -1.0, -1.0, 0.0,\n     1.0, -1.0, 0.0,\n};\n\nNSInteger dataSize = sizeof(vertexData);\nid <MTLBuffer> vertexBuffer = [device newBufferWithBytes:vertexData length:dataSize options:MTLResourceOptionCPUCacheModeDefault];\n\n\nMTLDevice\u3067\u3082\u89e6\u308c\u305f\u901a\u308a\u3001device\u3092\u901a\u3057\u3066\u30d0\u30c3\u30d5\u30a1\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u751f\u6210\u3057\u3066\u3044\u307e\u3059\u3002\uff08newBufferWithBytes:length:options:\u30e1\u30bd\u30c3\u30c9\u304c\u305d\u308c\u3067\u3059\uff09\n\u307e\u305f\u3001Metal\u306e\u7279\u5fb4\u3068\u3057\u3066\u5927\u90e8\u5206\u306e\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u304cProtocol\u3067\u5b9f\u88c5\u3055\u308c\u3066\u3044\u308b\u70b9\u3067\u3059\u3002\n\u3053\u306e\u3078\u3093\u3082\u30b9\u30d4\u30fc\u30c9\u30a2\u30c3\u30d7\u306e\u305f\u3081\u306a\u306e\u3067\u3057\u3087\u3046\u304b\u3002\n\u306a\u306e\u3067\u3044\u305f\u308b\u3068\u3053\u308d\u3067id\u578b\u304c\u767b\u5834\u3057\u307e\u3059\u3002\n\nVertex Shader\u306e\u751f\u6210\n\u3055\u3066\u3001\u30b0\u30e9\u30d5\u30a3\u30c3\u30afAPI\u3068\u8a00\u3048\u3070\u30b7\u30a7\u30fc\u30c0\u3067\u3059\u306d\u3002\nMetal\u3067\u3082\u5f53\u7136\u30b7\u30a7\u30fc\u30c0\u3092\u66f8\u304d\u307e\u3059\u3002\u306a\u304a\u3001\u30b7\u30a7\u30fc\u30c0\u306f.metal\u30d5\u30a1\u30a4\u30eb\u306b\u306a\u308a\u307e\u3059\u3002\n\ncreate-Vertex_shader\nvertex float4 basic_vertex(\n    const device packed_float3 *vertex_array [[buffer(0)]],\n                           unsigned int vid [[vertex_id]]) {\n    return float4(vertex_array[vid], 1.0);\n}\n\n\n\n\u30b7\u30a7\u30fc\u30c0\u306e\u6c7a\u307e\u308a\u4e8b\n\u3059\u3079\u3066\u306e\u30d0\u30fc\u30c6\u30c3\u30af\u30b9\u30b7\u30a7\u30fc\u30c0\u306fvertex\u30ad\u30fc\u30ef\u30fc\u30c9\u3067\u59cb\u3081\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\u305d\u3057\u3066\u95a2\u6570\u306f\u3001\u6700\u7d42\u7684\u306aposition\u3092\u8fd4\u3055\u306a\u3044\u3068\u306a\u308a\u307e\u305b\u3093\u3002\n\u3053\u306e\u3042\u305f\u308a\u306fCg/HLSL\u3068\u4f3c\u305f\u3088\u3046\u306a\u611f\u3058\u3067\u3059\u306d\u3002\n\u5f15\u6570\n\u6700\u521d\u306e\u5f15\u6570\u306fpacked_float3\u3092\u6307\u5b9a\u3057\u307e\u3059\u3002\u3053\u308c\u306f\u9802\u70b9\u4f4d\u7f6e\u60c5\u5831\u306a\u3069\uff083\u3064\u306e\u8981\u7d20\u3092\u6301\u3064\u914d\u5217\uff09\u306e\u914d\u5217\u306b\u306a\u308a\u307e\u3059\u3002\n[[ ]] syntax\n[[ ]]\u3067\u56f2\u307e\u308c\u305f\u90e8\u5206\u306f\u8ffd\u52a0\u60c5\u5831\u306e\u5c5e\u6027\u3068\u3057\u3066\u4f7f\u308f\u308c\u307e\u3059\u3002\n\uff08\u4f8b\u3048\u3070\u30ea\u30bd\u30fc\u30b9\u4f4d\u7f6e\u3084\u30b7\u30a7\u30fc\u30c0\u306e\u5165\u529b\u3001\u30d3\u30eb\u30c8\u30a4\u30f3\u5909\u6570\u306a\u3069\uff09\n\u3053\u3053\u3067\u6307\u5b9a\u3055\u308c\u3066\u3044\u308b[[ buffer(0) ]]\u306fMetal\u306e\u30b3\u30fc\u30c9\u304b\u3089\u30b7\u30a7\u30fc\u30c0\u306b\u9001\u3089\u308c\u305f\u30c7\u30fc\u30bf\u306e\u3046\u3061\u3001\u6700\u521d\u306e\u30c7\u30fc\u30bf\u3092\u6307\u3057\u3066\u3044\u308b\u3053\u3068\u3092\u4f1d\u3048\u3066\u3044\u307e\u3059\u3002\n2\u3064\u76ee\u306e\u5f15\u6570\u306fvertex_id\u5c5e\u6027\u304c\u3064\u3044\u305f\u3082\u306e\u3067\u3059\u3002\n\u3053\u308c\u306f\u30b7\u30a7\u30fc\u30c0\u306b\u6e21\u3055\u308c\u305f\u9802\u70b9\u914d\u5217\u306e\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u3092\u793a\u3059\u3082\u306e\u3067\u3059\u3002\n\uff08\u306a\u306e\u3067vertex_array[vid]\u3067\u30a2\u30af\u30bb\u30b9\u3057\u3066\u3044\u308b\uff09\n\n\u69cb\u9020\u4f53\u3067\u30c7\u30fc\u30bf\u3092\u5f97\u308b\n\u306a\u304a\u3001Cg/HLSL\u3068\u540c\u3058\u3088\u3046\u306b\u69cb\u9020\u4f53\u3092\u5ba3\u8a00\u3057\u3066\u3001\u69cb\u9020\u4f53\u306e\u72b6\u614b\u3067\u30d0\u30c3\u30d5\u30a1\u304b\u3089\u30c7\u30fc\u30bf\u3092\u53d7\u3051\u53d6\u308a\u3001\u307e\u305f\u8fd4\u3059\u3053\u3068\u3082\u53ef\u80fd\u3067\u3059\u3002\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u3057\u307e\u3059\u3002\n// \u69cb\u9020\u4f53\u306e\u5ba3\u8a00\nstruct VertexIn {\n    packed_float3 position;\n    packed_float4 color;\n};\n\nstruct VertexOut {\n    float4 position [[position]];\n    float4 color;\n};\n\nvertex VertexOut vertex_shader_function(const device VertexIn *vertex_array [[buffer(0)]], unsigned int vid [[vertex_id]]) {\n    // do something.\n}\n\nfragment half4 fragment_shader_function(VertexOut input [[stage_in]]) {\n    // do something.\n}\n\n\nUniform\u5909\u6570\u3092\u53d7\u3051\u53d6\u308b\n\u4e0a\u8a18\u30b5\u30f3\u30d7\u30eb\u3067\u306f\u4f7f\u7528\u3057\u3066\u3044\u307e\u305b\u3093\u304c\u3001Uniform\u5909\u6570\u3082\u53d7\u3051\u53d6\u308a\u307e\u3059\u3002\n\u53d7\u3051\u53d6\u308b\u5834\u5408\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u3057\u307e\u3059\u3002\nvertex float4 vertex_function(const device packed_float3 *vertex_array [[buffer(0)]],\n                              const device Uniforms &uniforms     [[buffer(1)]],\n                              unsigned int vid [[vertex_id]]) {\n    // ...\n}\n\n\n\u30b7\u30a7\u30fc\u30c0\u3078\u30c7\u30fc\u30bf\u3092\u9001\u308b\n\u30b7\u30a7\u30fc\u30c0\u306b\u30c7\u30fc\u30bf\u3092\u9001\u308b\u306b\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306bMTLRenderCommandEncoder\u3092\u4f7f\u3044\u307e\u3059\u3002\n\u3053\u308c\u307e\u305fid\u578b\u3067\u3059\u306d\u3002\nid <MTLRenderCommandEncoder> renderEncoder = [commandBuffer renderCommandEncoderWithDescriptor:renderPassDescriptor];\n\n[renderEncoder setVertexBuffer:vertexBuffer offset:0 atIndex:0];\n\n\u3053\u306eatIndex:0\u304c\u3001[[buffer(0)]]\u3067\u8aad\u307f\u53d6\u308c\u308b\u30c7\u30fc\u30bf\u3067\u3059\u3002\n\u307e\u305f\u3001\u69cb\u9020\u4f53\u3067\u53d7\u3051\u308b\u3088\u3046\u306b\u3057\u305f\u5834\u5408\u306f\u9802\u70b9\u60c5\u5831\u306e\u6570\u306f\u69cb\u9020\u4f53\u3067\u53d7\u3051\u53d6\u308b\u6570\u3068\u540c\u3058\u3060\u3051\u5b9a\u7fa9\u3057\u306a\u3044\u3068\u306a\u308a\u307e\u305b\u3093\u3002\n\u4f8b\u3048\u3070\u524d\u8ff0\u306e\u4f8b\u3060\u3068packed_float3\u3068packed_float4\u3092\u5b9a\u7fa9\u3057\u3066\u3044\u308b\u306e\u3067\u30011\u9802\u70b9\u3042\u305f\u308a7\u500b\u306e\u6570\u5024\u304c\u5fc5\u8981\u3067\u3059\u3002\nCGFloat data[] = {\n    1, 2,  3,  4,  5,  6,  7, // 7\u500b\u3067\u3072\u3068\u3064\u306e\u9802\u70b9\u5206\u306e\u60c5\u5831\u306b\u306a\u308b\n    8, 9, 10, 11, 12, 13, 14,\n    ...\n};\n\n\nFragment Shader\u306e\u751f\u6210\n\u30d5\u30e9\u30b0\u30e1\u30f3\u30c8\u30b7\u30a7\u30fc\u30c0\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u5f62\u306b\u306a\u308a\u307e\u3059\u3002\n\ncreate-Fragment_shader\nfragment half4 basic_fragment() {\n    return half4(1.0);\n}\n\n\n\n\u30b7\u30a7\u30fc\u30c0\u306e\u6c7a\u307e\u308a\u4e8b\n\u3059\u3079\u3066\u306e\u30d5\u30e9\u30b0\u30e1\u30f3\u30c8\u30b7\u30a7\u30fc\u30c0\u306ffragment\u30ad\u30fc\u30ef\u30fc\u30c9\u3067\u59cb\u3081\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\u305d\u3057\u3066\u3059\u3079\u3066\u306e\u95a2\u6570\u306f\u6700\u7d42\u7684\u306a\u8272\uff08\u4f8b\u3067\u306fhalf4\uff09\u3092\u8fd4\u3055\u306a\u3044\u3068\u306a\u308a\u307e\u305b\u3093\u3002\n\n\nRender Pipeline\u306e\u751f\u6210\n\u30ec\u30f3\u30c0\u30fc\u30d1\u30a4\u30d7\u30e9\u30a4\u30f3\u3092\u751f\u6210\u3057\u307e\u3059\u3002\nMetal\u306e\u5229\u70b9\u3068\u3057\u3066\u30b7\u30a7\u30fc\u30c0\u304c\u30d7\u30ea\u30b3\u30f3\u30d1\u30a4\u30eb\u3055\u308c\u308b\u70b9\u304c\u3042\u308a\u307e\u3059\u3002\n\u307e\u305f\u3001\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u304c\u7d42\u308f\u3063\u305f\u6bb5\u968e\u3067\u30ec\u30f3\u30c0\u30fc\u30d1\u30a4\u30d7\u30e9\u30a4\u30f3\u69cb\u6210\u304c\u30b3\u30f3\u30d1\u30a4\u30eb\u3055\u308c\u308b\u305f\u3081\u3001\u975e\u5e38\u306b\u52b9\u7387\u7684\u306b\u5b9f\u884c\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\uff08\u3053\u306e\u3042\u305f\u308a\u304c\u3001OpenGL\u3088\u308a10\u500d\u65e9\u3044\u3001\u307f\u305f\u3044\u306a\u6700\u9069\u5316\u306e\u3044\u3063\u305f\u3093\u306a\u3093\u3067\u3057\u3087\u3046\u306d\uff09\n\nCreate-Render_pipeline\nid <MTLRenderPipelineState> pipelineState;\n\nid <MTLLibrary> defaultLibrary   = [device newDefaultLibrary];\nid <MTLFunction> fragmentProgram = [defaultLibrary newFunctionWithName:@\"basic_fragment\"];\nid <MTLFunction> vertexProgram   = [defaultLibrary newFunctionWithName:@\"basic_vertex\"];\n\nMTLRenderPipelineDescriptor *pipelineStateDescriptor = [[MTLRenderPipelineDescriptor alloc] init];\npipelineStateDescriptor.vertexFunction   = vertexProgram;\npipelineStateDescriptor.fragmentFunction = fragmentProgram;\n[pipelineStateDescriptor.colorAttachments objectAtIndexedSubscript:0].pixelFormat = MTLPixelFormatBGRA8Unorm;\n\nNSError *pipelineError = nil;\npipelineState = [device newRenderPipelineStateWithDescriptor:pipelineStateDescriptor error:&pipelineError];\n\nif (!pipelineState) {\n    NSLog(@\"Failed to create pipeline state, error %@\", pipelineError);\n}\n\n\n[device newDefaultLibrary]\u3067\u3001\u30b7\u30a7\u30fc\u30c0\u30e9\u30a4\u30d6\u30e9\u30ea\u3092\u64cd\u4f5c\u3059\u308b\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u5f97\u307e\u3059\u3002\n\u3061\u306a\u307f\u306b\u3001Metal\u306f\u30b3\u30f3\u30d1\u30a4\u30eb\u6642\u306b.metal\u30d5\u30a1\u30a4\u30eb\u3092\u8abf\u67fb\u3057\u3066\u3059\u3079\u3066\u3092\u30e9\u30a4\u30d6\u30e9\u30ea\u3068\u3057\u3066\u307e\u3068\u3081\u308b\u3088\u3046\u3067\u3059\u3002\u305d\u306e\u305f\u3081\u3001[defaultLibrary newFunctionWithName:@\"basic_fragment\"]\u306e\u3088\u3046\u306b\u3057\u3066\u95a2\u6570\u540d\u3060\u3051\u3067\u8a72\u5f53\u306e\u30b7\u30a7\u30fc\u30c0\u30b3\u30fc\u30c9\u3092\u53d6\u5f97\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u308b\u3001\u3068\u3044\u3046\u308f\u3051\u3067\u3059\u3002\n\u305d\u3057\u3066MTLRenderPipelineDescriptor\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u5316\u3057\u3001\u9069\u5207\u306b\u8a2d\u5b9a\u3092\u884c\u3044\u307e\u3059\u3002\uff08\u3053\u308c\u304c\u524d\u8ff0\u3057\u305f\u30d1\u30a4\u30d7\u30e9\u30a4\u30f3\u306e\u8a2d\u5b9a\uff09\n\uff08\u96f0\u56f2\u6c17\u7684\u306b\u306fOpenGL\u3067\u3044\u3046\u3068\u3053\u308d\u306eglProgram\u306b\u8fd1\u3044\u3067\u3059\u304b\u306d\uff09\n\n\u6587\u5b57\u5217\u304b\u3089\u30b7\u30a7\u30fc\u30c0\u3092\u751f\u6210\u3059\u308b\n.metal\u5f62\u5f0f\u306e\u30d5\u30a1\u30a4\u30eb\u306b\u30b7\u30a7\u30fc\u30c0\u3092\u8a18\u8ff0\u3059\u308b\u3068\u30b3\u30f3\u30d1\u30a4\u30eb\u6642\u306b\u81ea\u52d5\u7684\u306b\u30e9\u30a4\u30d6\u30e9\u30ea\u306b\u542b\u3081\u3066\u304f\u308c\u307e\u3059\u304c\u3001\u4e2d\u306b\u306f\u6587\u5b57\u5217\u304b\u3089\u30b7\u30a7\u30fc\u30c0\u3092\u751f\u6210\u3057\u305f\u3044\u3001\u3068\u3044\u3046\u5834\u5408\u304c\u3042\u308b\u3068\u601d\u3044\u307e\u3059\u3002\n\u305d\u3046\u3057\u305f\u5834\u5408\u306fnewLibraryWithSource:options:error:\u30e1\u30bd\u30c3\u30c9\u3092\u4f7f\u3044\u3001\u5f15\u6570\u306b\u30b7\u30a7\u30fc\u30c0\u30b3\u30fc\u30c9\u3092\u6587\u5b57\u5217\u3068\u3057\u3066\u6e21\u3057\u3066\u3084\u308b\u3053\u3068\u3067\u540c\u671f\u7684\u306b\u30b3\u30f3\u30d1\u30a4\u30eb\u3057\u3066\u304f\u308c\u307e\u3059\u3002\n\n\u30cf\u30de\u308a\u30dd\u30a4\u30f3\u30c8\n\u5730\u5473\u306b\u30cf\u30de\u3063\u305f\u306e\u304c\u3001\u6e21\u3059\u30bd\u30fc\u30b9\u30b3\u30fc\u30c9\u306e\u8a18\u8ff0\u6cd5\u3002\n\\n\u3092\u4f7f\u3063\u3066\u660e\u793a\u7684\u306b\u6539\u884c\u30b3\u30fc\u30c9\u3092\u5165\u308c\u3066\u3042\u3052\u306a\u3044\u3068\u3001\u30a8\u30e9\u30fc\u304c\u3067\u306a\u3044\u306e\u306b\u30b7\u30a7\u30fc\u30c0\u306e\u95a2\u6570\u304c\u53c2\u7167\u3067\u304d\u306a\u3044\u3001\u3068\u3044\u3046\u554f\u984c\u304c\u3042\u308a\u307e\u3057\u305f\u3002\n\u306a\u306e\u3067\u3001\u6587\u5b57\u5217\u304b\u3089\u751f\u6210\u3059\u308b\u5834\u5408\u306f\u8981\u6ce8\u610f\u3067\u3059\u3002\n\n\nCommand Queue\u306e\u751f\u6210\n\nCreate-Command_queue\nid <MTLCommandQueue> commandQueue = [device newCommandQueue];\n\n\n\u30b3\u30de\u30f3\u30c9\u30ad\u30e5\u30fc\u306f\u3001GPU\u306b\u5bfe\u3059\u308b\u547d\u4ee4\u306e\u30aa\u30fc\u30c0\u30fc\u30ea\u30b9\u30c8\u3067\u3059\u3002\n\uff08\u304a\u305d\u3089\u304f\u30ad\u30e5\u30fc\u306e\u540d\u306e\u901a\u308a\u3001\u30b3\u30de\u30f3\u30c9\u304c\u3072\u3068\u3064\u305a\u3064\u53d6\u308a\u51fa\u3055\u308c\u3066\u5b9f\u884c\u3055\u308c\u308b\uff1f\uff09\n\u30b3\u30de\u30f3\u30c9\u30ad\u30e5\u30fc\u3092\u5229\u7528\u3059\u308b\u7406\u7531\u306f\u3001CPU\u3068GPU\u3067\u306f\u52d5\u4f5c\u5468\u671f\u304c\u7570\u306a\u308a\u305d\u308c\u305e\u308c\u304c\u975e\u540c\u671f\u306b\u5b9f\u884c\u3055\u308c\u308b\u305f\u3081\u3001\u5b89\u5168\u306b\u30c7\u30fc\u30bf\u3092\u3084\u308a\u3068\u308a\u3059\u308b\u305f\u3081\u306e\u4ed5\u7d44\u307f\u3068\u3057\u3066\u30ad\u30e5\u30fc\u304c\u3042\u308a\u307e\u3059\u3002\n\u5f8c\u8ff0\u3057\u307e\u3059\u304c\u3001\u3053\u306e\u30ad\u30e5\u30fc\u306b\u300c\u30b3\u30de\u30f3\u30c9\u30d0\u30c3\u30d5\u30a1\u300d\u3092\u547c\u3070\u308c\u308b\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u30ad\u30e5\u30fc\u306b\u8ffd\u52a0\u3057\u3066\u3044\u304f\u3053\u3068\u3067\u30ec\u30f3\u30c0\u30ea\u30f3\u30b0\u3092\u5b9f\u73fe\u3057\u307e\u3059\u3002\n\u591a\u5206\u3067\u3059\u304c\u30b3\u30de\u30f3\u30c9\u30d0\u30c3\u30d5\u30a1\u304c\u4e00\u56de\u306eDraw Call\u3063\u307d\u3044\u3067\u3059\u3002\n\u306a\u306e\u3067\u30b3\u30de\u30f3\u30c9\u30d0\u30c3\u30d5\u30a1\u306b\u306f\u51e6\u7406\u304c\u7d42\u4e86\u3057\u305f\u3053\u3068\u3092\u901a\u77e5\u3059\u308b\u30cf\u30f3\u30c9\u30e9\u3092\u8a2d\u5b9a\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\u3082\u3057CPU\u5074\u3067\u30c7\u30fc\u30bf\u3092\u5909\u66f4\u3057\u305f\u3044\u5834\u5408\u306f\u3001\u3053\u306e\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u3092\u5f85\u3063\u3066\u304b\u3089\u51e6\u7406\u3092\u3059\u308b\u3053\u3068\u3067\u5b89\u5168\u306b\u30c7\u30fc\u30bf\u3092\u5909\u66f4\u3067\u304d\u308b\u3001\u3068\u3044\u3046\u308f\u3051\u3067\u3059\u3002\n\n\n\u4e09\u89d2\u5f62\u306e\u30ec\u30f3\u30c0\u30ea\u30f3\u30b0\n\u3055\u3066\u3001\u3053\u308c\u3067\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u304c\u7d42\u308f\u3063\u305f\u306e\u3067\u6b21\u306f\u30ec\u30f3\u30c0\u30ea\u30f3\u30b0\u3067\u3059\u3002\n\u4e3b\u306b\u4ee5\u4e0b\u306e\u30b9\u30c6\u30c3\u30d7\u306b\u306a\u308a\u307e\u3059\u3002\n\nCADisplayLink\u306e\u751f\u6210\nRender Pass Descriptor\u306e\u751f\u6210\nCommand Buffer\u306e\u751f\u6210\nRender Command Encoder\u306e\u751f\u6210\nCommand Buffer\u306e\u30b3\u30df\u30c3\u30c8\n\n\u203b ... \u672c\u6765\u3001CADisplayLink\u306f\u30ec\u30f3\u30c0\u30ea\u30f3\u30b0\u306b\u306f\u76f4\u63a5\u306f\u95a2\u4fc2\u3042\u308a\u307e\u305b\u3093\u304c\u30013D\u306f\u30ec\u30f3\u30c0\u30ea\u30f3\u30b0\u3092\u5e38\u306b\u884c\u3046\u304c\u666e\u901a\u306a\u306e\u3067\u305d\u306e\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u3082\u542b\u3081\u3066\u3044\u307e\u3059\u3002\n\n\nCADisplayLink\u306e\u751f\u6210\nCADisplayLink\u306e\u751f\u6210\u306f\u7279\u306b\u65b0\u3057\u3044\u3053\u3068\u306f\u3042\u308a\u307e\u305b\u3093\u3002\nCADisplayLink *timer = [CADisplayLink displayLinkWithTarget:self selector:@selector(gameloop)];\n[timer addToRunLoop:NSRunLoop.mainRunLoop forMode:NSDefaultRunLoopMode];\n\n/////////////////////////////////////////////////////////////////////////////\n\n- (void)gameloop\n{\n    @autoreleasepool {\n        [self render];\n    }\n}\n\nrender\u30e1\u30bd\u30c3\u30c9\u306e\u4e2d\u3067\u3001Metal\u3067\u306e\u30ec\u30f3\u30c0\u30ea\u30f3\u30b0\u51e6\u7406\u3092\u5b9f\u884c\u3059\u308c\u3070\u968f\u6642\u753b\u9762\u304c\u66f4\u65b0\u3055\u308c\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\n\n\nRender Pass Descriptor\u306e\u751f\u6210\n\u30ec\u30f3\u30c0\u30ea\u30f3\u30b0\u7528\u306edescriptor\u3092\u751f\u6210\u3057\u307e\u3059\u3002\n// Render Pass Descriptor\u306e\u751f\u6210\u3002\nMTLRenderPassDescriptor *renderPassDescriptor = [[MTLRenderPassDescriptor alloc] init];\nrenderPassDescriptor.colorAttachments[0].texture     = texture;\nrenderPassDescriptor.colorAttachments[0].loadAction  = MTLLoadActionClear;\nrenderPassDescriptor.colorAttachments[0].clearColor  = MTLClearColorMake(0.0, 104.0/255.0, 5.0/255.0, 1.0);\nrenderPassDescriptor.colorAttachments[0].storeAction = MTLStoreActionStore;\n\n\u751f\u6210\u306b\u306fMTLTexture\u304c\u5fc5\u8981\u3067\u3059\u3002\u3053\u3053\u306b\u8a2d\u5b9a\u3057\u305f\u30c6\u30af\u30b9\u30c1\u30e3\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u306b\u30ec\u30f3\u30c0\u30ea\u30f3\u30b0\u51e6\u7406\u304c\u884c\u308f\u308c\u307e\u3059\u3002\n\u306a\u306e\u3067\u3053\u3053\u306b\u3001\u30aa\u30d5\u30b9\u30af\u30ea\u30fc\u30f3\u7528\u306b\u751f\u6210\u3057\u305f\u30c6\u30af\u30b9\u30c1\u30e3\u3092\u6307\u5b9a\u3059\u308c\u3070\u7c21\u5358\u306b\u30aa\u30d5\u30b9\u30af\u30ea\u30fc\u30f3\u30ec\u30f3\u30c0\u30ea\u30f3\u30b0\u304c\u3067\u304d\u307e\u3059\u3002\n\n\nCommand Buffer\u306e\u751f\u6210\n\u30b3\u30de\u30f3\u30c9\u30d0\u30c3\u30d5\u30a1\u306f\u30011\u30d5\u30ec\u30fc\u30e0\u306b\u5b9f\u884c\u3057\u305f\u3044\u30ec\u30f3\u30c0\u30fc\u30b3\u30de\u30f3\u30c9\u306e\u30ea\u30b9\u30c8\u306e\u30a4\u30e1\u30fc\u30b8\u3067\u3059\u3002\n\u30b3\u30de\u30f3\u30c9\u30d0\u30c3\u30d5\u30a1\u306f\u30b3\u30de\u30f3\u30c9\u30ad\u30e5\u30fc\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u304b\u3089\u751f\u6210\u3057\u307e\u3059\u3002\n// create a new command queue\n_commandQueue = [_device newCommandQueue];\n\n/////////////////////////////////////////////////////////////////////////////\n\nid <MTLCommandBuffer> commandBuffer = [_commandQueue commandBuffer];\n\n\u3061\u306a\u307f\u306b\u30b3\u30de\u30f3\u30c9\u30d0\u30c3\u30d5\u30a1\u306f\u3001\u660e\u793a\u7684\u306b\u30b3\u30df\u30c3\u30c8\u3092\u884c\u3046\u307e\u3067\u306a\u306b\u3082\u5b9f\u884c\u3057\u307e\u305b\u3093\u3002\n\nRender Command Encoder\u306e\u751f\u6210\n\u5b9f\u969b\u306b\u30ec\u30f3\u30c0\u30ea\u30f3\u30b0\u3092\u884c\u3046\u30b3\u30de\u30f3\u30c9\u3067\u3059\u3002\n\u3053\u308c\u4ee5\u5916\u306b\u3082MTLComputeCommandEncoder\u3084MTLBlitCommandEncoder\u3068\u3044\u3063\u305f\u30ec\u30f3\u30c0\u30ea\u30f3\u30b0\u3092\u884c\u308f\u306a\u3044\u30b3\u30de\u30f3\u30c9\u3082\u3042\u308a\u307e\u3059\u3002\uff08MTLComputeCommandEncoder\u306f\u30d5\u30a3\u30eb\u30bf\u30fc\u306a\u3069\u3001\u30c6\u30af\u30b9\u30c1\u30e3\u306b\u51e6\u7406\u3092\u65bd\u3057\u3066\u30c6\u30af\u30b9\u30c1\u30e3\u3068\u3057\u3066\u66f8\u304d\u51fa\u3059\u3001\u307f\u305f\u3044\u306a\u3053\u3068\u304c\u3067\u304d\u308b\uff09\n\nCreate-Render_command_encoder\n// Render Command Encoder\u306e\u751f\u6210\nid <MTLRenderCommandEncoder> renderEncoder = [commandBuffer renderCommandEncoderWithDescriptor:renderPassDescriptor];\n\nif (renderEncoder) {\n    [renderEncoder setRenderPipelineState:self.pipelineState];\n    [renderEncoder setVertexBuffer:self.vertexBuffer offset:0 atIndex:0];\n    [renderEncoder drawPrimitives:MTLPrimitiveTypeTriangle vertexStart:0 vertexCount:3 instanceCount:1];\n    [renderEncoder endEncoding];\n}\n\n\nglDrawElements\u7684\u306a\u5f79\u5272\u3002\n\u3061\u306a\u307f\u306b\u751f\u6210\u306f\u300c\u30b3\u30de\u30f3\u30c9\u30d0\u30c3\u30d5\u30a1\u300d\u304b\u3089\u884c\u3044\u307e\u3059\u3002\n\u203b ... \u300c\u30d0\u30c3\u30d5\u30a1\u300d\u3068\u540d\u304c\u4ed8\u3044\u3066\u3044\u308b\u901a\u308a\u3001\u3044\u304f\u3064\u304b\u306e\u30b3\u30de\u30f3\u30c9\u3092\u3072\u3068\u307e\u3068\u3081\u306b\u3057\u3066\u30ad\u30e5\u30fc\u306b\u5165\u308c\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n[renderEncoder drawPrimitives:MTLPrimitiveTypeTriangle vertexStart:0 vertexCount:3 instanceCount:1];\u3067\u6307\u5b9a\u3057\u305fvertexCount\u3084instanceCount\u304c\u3001\u524d\u8ff0\u3057\u305f\u3001\u69cb\u9020\u4f53\u3067\u30c7\u30fc\u30bf\u3092\u9001\u308b\u969b\u306e\u6307\u6a19\u306b\u306a\u308b\u3082\u306e\u3067\u3059\u3002\n\u524d\u8ff0\u306e\u4f8b\u3067\u8a00\u3048\u3070vertexCount\u306f7\u306b\u306a\u308a\u307e\u3059\u3002\n\n\u30d0\u30c3\u30d5\u30a1\u30c7\u30fc\u30bf\u306e\u751f\u6210\u306b\u3064\u3044\u3066\u30e1\u30e2\nOpenGL\u3067\u8a00\u3046\u3068\u3053\u308d\u306eVBO\u306b\u3042\u305f\u308b\u30d0\u30c3\u30d5\u30a1\u306e\u7a2e\u985e\u306b\u3064\u3044\u3066\u3002\nOpenGL\u540c\u69d8\u3001attribute\u3084uniform\u306b\u3042\u305f\u308b\u5909\u6570\u304c\u3042\u308a\u307e\u3059\u3002\nattribute\u306a\u30d0\u30c3\u30d5\u30a1\u3092\u751f\u6210\u3059\u308b\u306b\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u3057\u307e\u3059\u3002\n// \u9802\u70b9\u30c7\u30fc\u30bf\u3092\u5b9a\u7fa9\u3059\u308b\nstatic const float vertexData[] = {\n     0.0, -1.0, 0.0,\n    -1.0,  1.0, 0.0,\n     1.0,  1.0, 0.0\n};\n\n\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u3057\u3066\u30d0\u30c3\u30d5\u30a1\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u306b\u3057\u307e\u3059\u3002\nid <MTLBuffer> buffer = [device newBufferWithBytes:vertexData length:sizeof(vertexData) options:MTLResourceOptionCPUCacheModelDefault];\n\n\u6b21\u306b\u3001uniform\u306a\u30d0\u30c3\u30d5\u30a1\u3092\u751f\u6210\u3059\u308b\u306b\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u3057\u307e\u3059\u3002\nstatic const float uniformData[] {\n    1.0, 1.0, 1.0, 1.0,\n};\n\n\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u3057\u3066\u30d0\u30c3\u30d5\u30a1\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u306b\u3057\u307e\u3059\u3002\nid <MTLBuffer> uniformBuffer = [device newBufferWithLength:sizeof(uniformData) options:MTLResourceOptionCPUCacheModelDefault];\n\nattribute\u3068\u306e\u9055\u3044\u306fnewBufferWithLength:options:\u30e1\u30bd\u30c3\u30c9\u3092\u5229\u7528\u3059\u308b\u70b9\u3067\u3059\u3002\n\u3053\u308c\u306f\u30d0\u30c3\u30d5\u30a1\u306e\u9818\u57df\u3092\u78ba\u4fdd\u3059\u308b\u306e\u307f\u3067\u3001\u30c7\u30fc\u30bf\u81ea\u4f53\u306f\u3042\u3068\u304b\u3089\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\u5177\u4f53\u7684\u306b\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u3057\u307e\u3059\u3002\nvoid *buf = [uniformBuffer contents];\nmemcpy(buf, uniformData, sizeof(uniformData));\n\n\n\n\u30b3\u30de\u30f3\u30c9\u30d0\u30c3\u30d5\u30a1\u306e\u30b3\u30df\u30c3\u30c8\n[commandBuffer presentDrawable:view.currentDrawable];\n[commandBuffer commit];\n\n\u6700\u5f8c\u306b\u30ec\u30f3\u30c0\u30ea\u30f3\u30b0\u3092GPU\u306b\u884c\u308f\u305b\u308b\u305f\u3081\u306b\u30b3\u30de\u30f3\u30c9\u30d0\u30c3\u30d5\u30a1\u3092\u30b3\u30df\u30c3\u30c8\u3057\u307e\u3059\u3002\ncommit\u30e1\u30bd\u30c3\u30c9\u306f\u30ad\u30e5\u30fc\u306b\u8ffd\u52a0\u3057\u3001\u3082\u3057\u53ef\u80fd\u3067\u3042\u308c\u3070\u5373\u5ea7\u306b\u30b3\u30de\u30f3\u30c9\u304c\u5b9f\u884c\u3055\u308c\u307e\u3059\u3002\uff08\u30ad\u30e5\u30fc\u304c\u5f85\u3061\u72b6\u614b\u306e\u5834\u5408\u306f\u6700\u5f8c\u306b\u8ffd\u52a0\u3055\u308c\u307e\u3059\uff09\n\n\u53c2\u8003\u306b\u3057\u305f\u8a18\u4e8b\n\niOS 8 Metal Tutorial with Swift: Getting Started\niOS 8 Metal Tutorial with Swift Part 2: Moving to 3D\n\niOS 8 Metal Tutorial with Swift Part 3: Adding Texture\nMetal\u306e\u300cshared CPU/GPU memory buffer\u300d\u306b\u3064\u3044\u3066\nMetal\u306e\u30b3\u30fc\u30c9\u3092\u8aad\u3080\u524d\u306b\u77e5\u3063\u3066\u304a\u304f\u3068\u697d\u306a\u3053\u3068\n\n\n\u73fe\u5728\u306e\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u3067Metal\u306b\u89e6\u308c\u308b\u5fc5\u8981\u304c\u3042\u3063\u305f\u306e\u3067\u3056\u3063\u304f\u308a\u8abf\u3079\u3066\u307f\u307e\u3057\u305f\u3002\n\n-------------------------------------------\n\n\u4ee5\u4e0b\u306e\u8a18\u4e8b\u3092\u6700\u521d\u306b\u8aad\u3093\u3067\u304a\u304f\u3068\u8272\u3005\u3068\u7406\u89e3\u3057\u3084\u3059\u304f\u3066\u30aa\u30b9\u30b9\u30e1\u3067\u3059\u3002\n\n- [Metal\u306e\u300cshared CPU/GPU memory buffer\u300d\u306b\u3064\u3044\u3066](http://dsas.blog.klab.org/archives/52168462.html)\n- [Metal\u306e\u30b3\u30fc\u30c9\u3092\u8aad\u3080\u524d\u306b\u77e5\u3063\u3066\u304a\u304f\u3068\u697d\u306a\u3053\u3068](http://dsas.blog.klab.org/archives/52168969.html)\n\n\n### Metal\u306e\u30b9\u30d4\u30fc\u30c9\u30a2\u30c3\u30d7\u306e\u8981\u54e1\u306e\u3072\u3068\u3064\u306fCPU/GPU\u306e\u30e1\u30e2\u30ea\u5171\u6709\n\n\u4e0a\u8a18\u306e\u8a18\u4e8b\u306e\u3056\u3063\u304f\u308a\u6982\u8981\u3060\u3051\u3092\u66f8\u304f\u3068\u3001Metal\u306e\u30b9\u30d4\u30fc\u30c9\u30a2\u30c3\u30d7\u306e\u79d8\u8a23\u306f\u3001CPU/GPU\u9593\u3067\u306e\u30e1\u30e2\u30ea\u5171\u6709\u3067\u3059\u3002\uff08\u305d\u308c\u3060\u3051\u3058\u3083\u306a\u3044\u3067\u3059\u304c\uff09\n\u305d\u306e\u305f\u3081\u3001OpenGL\u3067\u306f\u3044\u3061\u3044\u3061\u30c7\u30fc\u30bf\u306e\u3084\u308a\u3068\u308a\u3092\u5c0f\u96e3\u3057\u304f\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3057\u305f\u304c\u3001Metal\u3067\u306f\u305d\u308c\u304c\u3042\u308a\u307e\u305b\u3093\u3002\n\n\u3057\u304b\u3057Metal\u306fiOS\u7aef\u672b\u306e\u3001\u3055\u3089\u306b\u9650\u3089\u308c\u305f\u30c1\u30c3\u30d7\u304c\u642d\u8f09\u3055\u308c\u305f\u7aef\u672b\u306b\u9650\u5b9a\u3057\u3066\u3044\u308b\u6280\u8853\u3067\u3059\u3002\n*\uff08\u9006\u306b\u8a00\u3046\u3068\u3001\u3060\u304b\u3089\u3053\u305d\u5b9f\u73fe\u3067\u304d\u3066\u3044\u308b\u6280\u8853\u3067\u3059\uff09*\n\n\u7d30\u304b\u3044\u8a71\u3092\u3059\u308b\u3068\u3001\u672c\u6765GPU\u3068CPU\u306f\u7269\u7406\u7684\u306b\u96e2\u308c\u3066\u3044\u307e\u3059\u3002\n*\uff08\u81ea\u4f5cPC\u3092\u4f5c\u3063\u305f\u7d4c\u9a13\u304c\u3042\u308b\u4eba\u3067\u3042\u308c\u3070GPU\u304c\u96e2\u308c\u3066\u3044\u308b\u306e\u306f\u3059\u3050\u5206\u304b\u308b\u3068\u601d\u3044\u307e\u3059\uff09*\n\nCPU\u306e\u51e6\u7406\u30b9\u30d4\u30fc\u30c9\u7684\u306b\u3053\u306e\u8ddd\u96e2\u304c\u81f4\u547d\u7684\u306a\u306e\u3067\u3059\u3002\n\n\u305d\u308c\u304cA7\u30c1\u30c3\u30d7\u4ee5\u964d\u3001\uff08\u3068\u3044\u3046\u304biPhone\u306e\u69cb\u9020\u4e0a\uff09CPU\u3068GPU\u306f\u307b\u307c\u540c\u5c45\u3057\u3066\u304a\u308a\u3001\u524d\u8ff0\u306e\u3088\u3046\u306b\u30e1\u30e2\u30ea\u306e\u5171\u6709\u304c\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u3063\u305f\u3001\u3068\u3044\u3046\u308f\u3051\u3067\u3059\u3002\n\u306a\u306e\u3067\u30b7\u30df\u30e5\u30ec\u30fc\u30bf\u3067\u306f\u52d5\u304b\u306a\u3044\u3093\u3067\u3059\u306d\u3002\uff08PC\u3060\u3068\u5f53\u7136GPU\u306f\u96e2\u308c\u3066\u308b\uff09\n\n## Metal\u306e\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\n\n*\u4e3b\u306b[\u3053\u3061\u3089\u306e\u8a18\u4e8b](http://www.raywenderlich.com/77488/ios-8-metal-tutorial-swift-getting-started)\u3092\u53c2\u8003\u306b\u3057\u307e\u3057\u305f\u3002*\n\nMetal\u3092\u5229\u7528\u3059\u308b\u306b\u306f\u6700\u4f4e\u9650\u3001\u4ee5\u4e0b\u306e\u3082\u306e\u3092\u6e96\u5099\u3057\u307e\u3059\u3002\n\n1. \u300cMTLDevice\u300d\u306e\u751f\u6210\n2. \u300cCAMetalLayer\u300d\u306e\u751f\u6210\n3. \u300cVertex Buffer\u300d\u306e\u751f\u6210\n4. \u300cVertex Shader\u300d\u306e\u751f\u6210\n5. \u300cFragment Shader\u300d\u306e\u751f\u6210\n6. \u300cRender Pipeline\u300d\u306e\u751f\u6210\n7. \u300cCommand Queue\u300d\u306e\u751f\u6210\n8. \u300cCommand Buffer\u300d\u306e\u751f\u6210\n9. \u300cRender Pass Descriptor\u300d\u306e\u751f\u6210\n10. \u300cRender Command Encoder\u300d\u306e\u751f\u6210\n\n\n### `MTLDevice`\u306e\u751f\u6210\n\n`MTLDevice`\u306fGPU\u306b\u30c0\u30a4\u30ec\u30af\u30c8\u306b\u30b3\u30cd\u30af\u30b7\u30e7\u30f3\u3092\u5f35\u308b\u3082\u306e\u3068\u8003\u3048\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\nOpenGL\u3067\u3044\u3046\u3068\u3053\u308d\u306egl\u30b3\u30f3\u30c6\u30ad\u30b9\u30c8\u306b\u4f3c\u3066\u3044\u307e\u3059\u3002\n\u30c6\u30af\u30b9\u30c1\u30e3\u306e\u751f\u6210\u3001\u30d0\u30c3\u30d5\u30a1\u306e\u751f\u6210\u306a\u3069GPU\u3078\u306e\u547d\u4ee4\u306f\u3053\u306e`MTLDevice`\u3092\u901a\u3057\u3066\u884c\u3044\u307e\u3059\u3002\n\n```objc:create-MTLDevice\n// MTLDeivce\u306e\u751f\u6210\nid <MTLDevice> device = MTLCreateSystemDefaultDevice();\n```\n\n\n### `CAMetalLayer`\u306e\u751f\u6210\n\n`CAMetalLayer`\u306fMetal.framework\u3067\u306f\u306a\u304f\u3001\u540d\u524d\u304b\u3089\u3082\u5206\u304b\u308b\u901a\u308a`Core Animation`\u3067\u5b9a\u7fa9\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n\u306a\u306e\u3067QuartzCore.framework\u3092\u8aad\u307f\u8fbc\u3080\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\u5f79\u5272\u306fMetal\u306e\u30ec\u30f3\u30c0\u30ea\u30f3\u30b0\u3092\u884c\u3046\u30ec\u30a4\u30e4\u30fc\u3067\u3059\u3002\n\n```objc:create-CAMetalLayer\nimport QuartzCore;\n\n// CAMetalLayer\u306e\u751f\u6210\nCAMetalLayer *metalLayer = [CAMetalLayer layer];\nmetalLayer.device = device;\nmetalLayer.pixelFormat = MTLPixelFormatBGRA8Unorm;\nmetalLayer.framebufferOnly = YES;\nmetalLayer.frame = self.view.layer.frame;\n[self.view.layer addSublayer:metalLayer];\n```\n\n\n\n### `Vertex Buffer`\u306e\u751f\u6210\n\nOpenGL\u3067\u306f`VBO`\u3067\u3059\u306d\u3002\n\n```objc:create-Vertex_Buffer\n// \u9802\u70b9\u60c5\u5831\nCGFloat vertexData[] = {\n     0.0,  1.0, 0.0,\n    -1.0, -1.0, 0.0,\n     1.0, -1.0, 0.0,\n};\n\nNSInteger dataSize = sizeof(vertexData);\nid <MTLBuffer> vertexBuffer = [device newBufferWithBytes:vertexData length:dataSize options:MTLResourceOptionCPUCacheModeDefault];\n```\n\n`MTLDevice`\u3067\u3082\u89e6\u308c\u305f\u901a\u308a\u3001device\u3092\u901a\u3057\u3066\u30d0\u30c3\u30d5\u30a1\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u751f\u6210\u3057\u3066\u3044\u307e\u3059\u3002\uff08`newBufferWithBytes:length:options:`\u30e1\u30bd\u30c3\u30c9\u304c\u305d\u308c\u3067\u3059\uff09\n\u307e\u305f\u3001Metal\u306e\u7279\u5fb4\u3068\u3057\u3066\u5927\u90e8\u5206\u306e\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u304cProtocol\u3067\u5b9f\u88c5\u3055\u308c\u3066\u3044\u308b\u70b9\u3067\u3059\u3002\n\u3053\u306e\u3078\u3093\u3082\u30b9\u30d4\u30fc\u30c9\u30a2\u30c3\u30d7\u306e\u305f\u3081\u306a\u306e\u3067\u3057\u3087\u3046\u304b\u3002\n\u306a\u306e\u3067\u3044\u305f\u308b\u3068\u3053\u308d\u3067`id\u578b`\u304c\u767b\u5834\u3057\u307e\u3059\u3002\n\n\n### `Vertex Shader`\u306e\u751f\u6210\n\n\u3055\u3066\u3001\u30b0\u30e9\u30d5\u30a3\u30c3\u30afAPI\u3068\u8a00\u3048\u3070\u30b7\u30a7\u30fc\u30c0\u3067\u3059\u306d\u3002\nMetal\u3067\u3082\u5f53\u7136\u30b7\u30a7\u30fc\u30c0\u3092\u66f8\u304d\u307e\u3059\u3002\u306a\u304a\u3001\u30b7\u30a7\u30fc\u30c0\u306f`.metal`\u30d5\u30a1\u30a4\u30eb\u306b\u306a\u308a\u307e\u3059\u3002\n\n```metal:create-Vertex_shader\nvertex float4 basic_vertex(\n    const device packed_float3 *vertex_array [[buffer(0)]],\n                           unsigned int vid [[vertex_id]]) {\n    return float4(vertex_array[vid], 1.0);\n}\n```\n\n#### \u30b7\u30a7\u30fc\u30c0\u306e\u6c7a\u307e\u308a\u4e8b\n\n\u3059\u3079\u3066\u306e\u30d0\u30fc\u30c6\u30c3\u30af\u30b9\u30b7\u30a7\u30fc\u30c0\u306f`vertex`\u30ad\u30fc\u30ef\u30fc\u30c9\u3067\u59cb\u3081\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\u305d\u3057\u3066\u95a2\u6570\u306f\u3001\u6700\u7d42\u7684\u306aposition\u3092\u8fd4\u3055\u306a\u3044\u3068\u306a\u308a\u307e\u305b\u3093\u3002\n\u3053\u306e\u3042\u305f\u308a\u306fCg/HLSL\u3068\u4f3c\u305f\u3088\u3046\u306a\u611f\u3058\u3067\u3059\u306d\u3002\n\n**\u5f15\u6570**\n\n\u6700\u521d\u306e\u5f15\u6570\u306f`packed_float3`\u3092\u6307\u5b9a\u3057\u307e\u3059\u3002\u3053\u308c\u306f\u9802\u70b9\u4f4d\u7f6e\u60c5\u5831\u306a\u3069\uff083\u3064\u306e\u8981\u7d20\u3092\u6301\u3064\u914d\u5217\uff09\u306e\u914d\u5217\u306b\u306a\u308a\u307e\u3059\u3002\n\n**`[[ ]]` syntax**\n\n`[[ ]]`\u3067\u56f2\u307e\u308c\u305f\u90e8\u5206\u306f\u8ffd\u52a0\u60c5\u5831\u306e\u5c5e\u6027\u3068\u3057\u3066\u4f7f\u308f\u308c\u307e\u3059\u3002\n\uff08\u4f8b\u3048\u3070\u30ea\u30bd\u30fc\u30b9\u4f4d\u7f6e\u3084\u30b7\u30a7\u30fc\u30c0\u306e\u5165\u529b\u3001\u30d3\u30eb\u30c8\u30a4\u30f3\u5909\u6570\u306a\u3069\uff09\n\n\u3053\u3053\u3067\u6307\u5b9a\u3055\u308c\u3066\u3044\u308b`[[ buffer(0) ]]`\u306fMetal\u306e\u30b3\u30fc\u30c9\u304b\u3089\u30b7\u30a7\u30fc\u30c0\u306b\u9001\u3089\u308c\u305f\u30c7\u30fc\u30bf\u306e\u3046\u3061\u3001\u6700\u521d\u306e\u30c7\u30fc\u30bf\u3092\u6307\u3057\u3066\u3044\u308b\u3053\u3068\u3092\u4f1d\u3048\u3066\u3044\u307e\u3059\u3002\n\n2\u3064\u76ee\u306e\u5f15\u6570\u306f`vertex_id`\u5c5e\u6027\u304c\u3064\u3044\u305f\u3082\u306e\u3067\u3059\u3002\n\u3053\u308c\u306f\u30b7\u30a7\u30fc\u30c0\u306b\u6e21\u3055\u308c\u305f\u9802\u70b9\u914d\u5217\u306e\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u3092\u793a\u3059\u3082\u306e\u3067\u3059\u3002\n*\uff08\u306a\u306e\u3067`vertex_array[vid]`\u3067\u30a2\u30af\u30bb\u30b9\u3057\u3066\u3044\u308b\uff09*\n\n\n##### \u69cb\u9020\u4f53\u3067\u30c7\u30fc\u30bf\u3092\u5f97\u308b\n\n\u306a\u304a\u3001Cg/HLSL\u3068\u540c\u3058\u3088\u3046\u306b\u69cb\u9020\u4f53\u3092\u5ba3\u8a00\u3057\u3066\u3001\u69cb\u9020\u4f53\u306e\u72b6\u614b\u3067\u30d0\u30c3\u30d5\u30a1\u304b\u3089\u30c7\u30fc\u30bf\u3092\u53d7\u3051\u53d6\u308a\u3001\u307e\u305f\u8fd4\u3059\u3053\u3068\u3082\u53ef\u80fd\u3067\u3059\u3002\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u3057\u307e\u3059\u3002\n\n```metal\n// \u69cb\u9020\u4f53\u306e\u5ba3\u8a00\nstruct VertexIn {\n\tpacked_float3 position;\n\tpacked_float4 color;\n};\n\nstruct VertexOut {\n\tfloat4 position [[position]];\n\tfloat4 color;\n};\n\nvertex VertexOut vertex_shader_function(const device VertexIn *vertex_array [[buffer(0)]], unsigned int vid [[vertex_id]]) {\n\t// do something.\n}\n\nfragment half4 fragment_shader_function(VertexOut input [[stage_in]]) {\n\t// do something.\n}\n```\n\n##### Uniform\u5909\u6570\u3092\u53d7\u3051\u53d6\u308b\n\n\u4e0a\u8a18\u30b5\u30f3\u30d7\u30eb\u3067\u306f\u4f7f\u7528\u3057\u3066\u3044\u307e\u305b\u3093\u304c\u3001Uniform\u5909\u6570\u3082\u53d7\u3051\u53d6\u308a\u307e\u3059\u3002\n\u53d7\u3051\u53d6\u308b\u5834\u5408\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u3057\u307e\u3059\u3002\n\n```metal\nvertex float4 vertex_function(const device packed_float3 *vertex_array [[buffer(0)]],\n                              const device Uniforms &uniforms     [[buffer(1)]],\n                              unsigned int vid [[vertex_id]]) {\n    // ...\n}\n```\n\n\n#### \u30b7\u30a7\u30fc\u30c0\u3078\u30c7\u30fc\u30bf\u3092\u9001\u308b\n\n\u30b7\u30a7\u30fc\u30c0\u306b\u30c7\u30fc\u30bf\u3092\u9001\u308b\u306b\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b`MTLRenderCommandEncoder`\u3092\u4f7f\u3044\u307e\u3059\u3002\n\u3053\u308c\u307e\u305f`id\u578b`\u3067\u3059\u306d\u3002\n\n```objc\nid <MTLRenderCommandEncoder> renderEncoder = [commandBuffer renderCommandEncoderWithDescriptor:renderPassDescriptor];\n\n[renderEncoder setVertexBuffer:vertexBuffer offset:0 atIndex:0];\n```\n\n\u3053\u306e`atIndex:0`\u304c\u3001`[[buffer(0)]]`\u3067\u8aad\u307f\u53d6\u308c\u308b\u30c7\u30fc\u30bf\u3067\u3059\u3002\n\u307e\u305f\u3001\u69cb\u9020\u4f53\u3067\u53d7\u3051\u308b\u3088\u3046\u306b\u3057\u305f\u5834\u5408\u306f\u9802\u70b9\u60c5\u5831\u306e\u6570\u306f\u69cb\u9020\u4f53\u3067\u53d7\u3051\u53d6\u308b\u6570\u3068\u540c\u3058\u3060\u3051\u5b9a\u7fa9\u3057\u306a\u3044\u3068\u306a\u308a\u307e\u305b\u3093\u3002\n\n\u4f8b\u3048\u3070\u524d\u8ff0\u306e\u4f8b\u3060\u3068`packed_float3`\u3068`packed_float4`\u3092\u5b9a\u7fa9\u3057\u3066\u3044\u308b\u306e\u3067\u30011\u9802\u70b9\u3042\u305f\u308a7\u500b\u306e\u6570\u5024\u304c\u5fc5\u8981\u3067\u3059\u3002\n\n```objc\nCGFloat data[] = {\n\t1, 2,  3,  4,  5,  6,  7, // 7\u500b\u3067\u3072\u3068\u3064\u306e\u9802\u70b9\u5206\u306e\u60c5\u5831\u306b\u306a\u308b\n\t8, 9, 10, 11, 12, 13, 14,\n\t...\n};\n```\n\n\n### `Fragment Shader`\u306e\u751f\u6210\n\n\u30d5\u30e9\u30b0\u30e1\u30f3\u30c8\u30b7\u30a7\u30fc\u30c0\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u5f62\u306b\u306a\u308a\u307e\u3059\u3002\n\n```metal:create-Fragment_shader\nfragment half4 basic_fragment() {\n    return half4(1.0);\n}\n```\n\n#### \u30b7\u30a7\u30fc\u30c0\u306e\u6c7a\u307e\u308a\u4e8b\n\n\u3059\u3079\u3066\u306e\u30d5\u30e9\u30b0\u30e1\u30f3\u30c8\u30b7\u30a7\u30fc\u30c0\u306f`fragment`\u30ad\u30fc\u30ef\u30fc\u30c9\u3067\u59cb\u3081\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\u305d\u3057\u3066\u3059\u3079\u3066\u306e\u95a2\u6570\u306f\u6700\u7d42\u7684\u306a\u8272\uff08\u4f8b\u3067\u306f`half4`\uff09\u3092\u8fd4\u3055\u306a\u3044\u3068\u306a\u308a\u307e\u305b\u3093\u3002\n\n\n-------------------------------------------\n\n### `Render Pipeline`\u306e\u751f\u6210\n\n\u30ec\u30f3\u30c0\u30fc\u30d1\u30a4\u30d7\u30e9\u30a4\u30f3\u3092\u751f\u6210\u3057\u307e\u3059\u3002\n\nMetal\u306e\u5229\u70b9\u3068\u3057\u3066\u30b7\u30a7\u30fc\u30c0\u304c\u30d7\u30ea\u30b3\u30f3\u30d1\u30a4\u30eb\u3055\u308c\u308b\u70b9\u304c\u3042\u308a\u307e\u3059\u3002\n\u307e\u305f\u3001\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u304c\u7d42\u308f\u3063\u305f\u6bb5\u968e\u3067\u30ec\u30f3\u30c0\u30fc\u30d1\u30a4\u30d7\u30e9\u30a4\u30f3\u69cb\u6210\u304c\u30b3\u30f3\u30d1\u30a4\u30eb\u3055\u308c\u308b\u305f\u3081\u3001\u975e\u5e38\u306b\u52b9\u7387\u7684\u306b\u5b9f\u884c\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\uff08\u3053\u306e\u3042\u305f\u308a\u304c\u3001OpenGL\u3088\u308a10\u500d\u65e9\u3044\u3001\u307f\u305f\u3044\u306a\u6700\u9069\u5316\u306e\u3044\u3063\u305f\u3093\u306a\u3093\u3067\u3057\u3087\u3046\u306d\uff09\n\n```objc:Create-Render_pipeline\nid <MTLRenderPipelineState> pipelineState;\n\nid <MTLLibrary> defaultLibrary   = [device newDefaultLibrary];\nid <MTLFunction> fragmentProgram = [defaultLibrary newFunctionWithName:@\"basic_fragment\"];\nid <MTLFunction> vertexProgram   = [defaultLibrary newFunctionWithName:@\"basic_vertex\"];\n\nMTLRenderPipelineDescriptor *pipelineStateDescriptor = [[MTLRenderPipelineDescriptor alloc] init];\npipelineStateDescriptor.vertexFunction   = vertexProgram;\npipelineStateDescriptor.fragmentFunction = fragmentProgram;\n[pipelineStateDescriptor.colorAttachments objectAtIndexedSubscript:0].pixelFormat = MTLPixelFormatBGRA8Unorm;\n\nNSError *pipelineError = nil;\npipelineState = [device newRenderPipelineStateWithDescriptor:pipelineStateDescriptor error:&pipelineError];\n\nif (!pipelineState) {\n    NSLog(@\"Failed to create pipeline state, error %@\", pipelineError);\n}\n```\n\n`[device newDefaultLibrary]`\u3067\u3001\u30b7\u30a7\u30fc\u30c0\u30e9\u30a4\u30d6\u30e9\u30ea\u3092\u64cd\u4f5c\u3059\u308b\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u5f97\u307e\u3059\u3002\n\u3061\u306a\u307f\u306b\u3001Metal\u306f\u30b3\u30f3\u30d1\u30a4\u30eb\u6642\u306b`.metal`\u30d5\u30a1\u30a4\u30eb\u3092\u8abf\u67fb\u3057\u3066\u3059\u3079\u3066\u3092\u30e9\u30a4\u30d6\u30e9\u30ea\u3068\u3057\u3066\u307e\u3068\u3081\u308b\u3088\u3046\u3067\u3059\u3002\u305d\u306e\u305f\u3081\u3001`[defaultLibrary newFunctionWithName:@\"basic_fragment\"]`\u306e\u3088\u3046\u306b\u3057\u3066\u95a2\u6570\u540d\u3060\u3051\u3067\u8a72\u5f53\u306e\u30b7\u30a7\u30fc\u30c0\u30b3\u30fc\u30c9\u3092\u53d6\u5f97\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u308b\u3001\u3068\u3044\u3046\u308f\u3051\u3067\u3059\u3002\n\n\u305d\u3057\u3066`MTLRenderPipelineDescriptor`\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u5316\u3057\u3001\u9069\u5207\u306b\u8a2d\u5b9a\u3092\u884c\u3044\u307e\u3059\u3002\uff08\u3053\u308c\u304c\u524d\u8ff0\u3057\u305f\u30d1\u30a4\u30d7\u30e9\u30a4\u30f3\u306e\u8a2d\u5b9a\uff09\n*\uff08\u96f0\u56f2\u6c17\u7684\u306b\u306fOpenGL\u3067\u3044\u3046\u3068\u3053\u308d\u306eglProgram\u306b\u8fd1\u3044\u3067\u3059\u304b\u306d\uff09*\n\n\n#### \u6587\u5b57\u5217\u304b\u3089\u30b7\u30a7\u30fc\u30c0\u3092\u751f\u6210\u3059\u308b\n\n`.metal`\u5f62\u5f0f\u306e\u30d5\u30a1\u30a4\u30eb\u306b\u30b7\u30a7\u30fc\u30c0\u3092\u8a18\u8ff0\u3059\u308b\u3068\u30b3\u30f3\u30d1\u30a4\u30eb\u6642\u306b\u81ea\u52d5\u7684\u306b\u30e9\u30a4\u30d6\u30e9\u30ea\u306b\u542b\u3081\u3066\u304f\u308c\u307e\u3059\u304c\u3001\u4e2d\u306b\u306f\u6587\u5b57\u5217\u304b\u3089\u30b7\u30a7\u30fc\u30c0\u3092\u751f\u6210\u3057\u305f\u3044\u3001\u3068\u3044\u3046\u5834\u5408\u304c\u3042\u308b\u3068\u601d\u3044\u307e\u3059\u3002\n\n\u305d\u3046\u3057\u305f\u5834\u5408\u306f`newLibraryWithSource:options:error:`\u30e1\u30bd\u30c3\u30c9\u3092\u4f7f\u3044\u3001\u5f15\u6570\u306b\u30b7\u30a7\u30fc\u30c0\u30b3\u30fc\u30c9\u3092\u6587\u5b57\u5217\u3068\u3057\u3066\u6e21\u3057\u3066\u3084\u308b\u3053\u3068\u3067\u540c\u671f\u7684\u306b\u30b3\u30f3\u30d1\u30a4\u30eb\u3057\u3066\u304f\u308c\u307e\u3059\u3002\n\n##### \u30cf\u30de\u308a\u30dd\u30a4\u30f3\u30c8\n\n\u5730\u5473\u306b\u30cf\u30de\u3063\u305f\u306e\u304c\u3001\u6e21\u3059\u30bd\u30fc\u30b9\u30b3\u30fc\u30c9\u306e\u8a18\u8ff0\u6cd5\u3002\n`\\n`\u3092\u4f7f\u3063\u3066\u660e\u793a\u7684\u306b\u6539\u884c\u30b3\u30fc\u30c9\u3092\u5165\u308c\u3066\u3042\u3052\u306a\u3044\u3068\u3001\u30a8\u30e9\u30fc\u304c\u3067\u306a\u3044\u306e\u306b\u30b7\u30a7\u30fc\u30c0\u306e\u95a2\u6570\u304c\u53c2\u7167\u3067\u304d\u306a\u3044\u3001\u3068\u3044\u3046\u554f\u984c\u304c\u3042\u308a\u307e\u3057\u305f\u3002\n\u306a\u306e\u3067\u3001\u6587\u5b57\u5217\u304b\u3089\u751f\u6210\u3059\u308b\u5834\u5408\u306f\u8981\u6ce8\u610f\u3067\u3059\u3002\n\n-------------------------------------------\n\n### `Command Queue`\u306e\u751f\u6210\n\n```objc:Create-Command_queue\nid <MTLCommandQueue> commandQueue = [device newCommandQueue];\n```\n\n\u30b3\u30de\u30f3\u30c9\u30ad\u30e5\u30fc\u306f\u3001GPU\u306b\u5bfe\u3059\u308b\u547d\u4ee4\u306e\u30aa\u30fc\u30c0\u30fc\u30ea\u30b9\u30c8\u3067\u3059\u3002\n*\uff08\u304a\u305d\u3089\u304f\u30ad\u30e5\u30fc\u306e\u540d\u306e\u901a\u308a\u3001\u30b3\u30de\u30f3\u30c9\u304c\u3072\u3068\u3064\u305a\u3064\u53d6\u308a\u51fa\u3055\u308c\u3066\u5b9f\u884c\u3055\u308c\u308b\uff1f\uff09*\n\n\u30b3\u30de\u30f3\u30c9\u30ad\u30e5\u30fc\u3092\u5229\u7528\u3059\u308b\u7406\u7531\u306f\u3001CPU\u3068GPU\u3067\u306f\u52d5\u4f5c\u5468\u671f\u304c\u7570\u306a\u308a\u305d\u308c\u305e\u308c\u304c\u975e\u540c\u671f\u306b\u5b9f\u884c\u3055\u308c\u308b\u305f\u3081\u3001\u5b89\u5168\u306b\u30c7\u30fc\u30bf\u3092\u3084\u308a\u3068\u308a\u3059\u308b\u305f\u3081\u306e\u4ed5\u7d44\u307f\u3068\u3057\u3066\u30ad\u30e5\u30fc\u304c\u3042\u308a\u307e\u3059\u3002\n\n\u5f8c\u8ff0\u3057\u307e\u3059\u304c\u3001\u3053\u306e\u30ad\u30e5\u30fc\u306b\u300c\u30b3\u30de\u30f3\u30c9\u30d0\u30c3\u30d5\u30a1\u300d\u3092\u547c\u3070\u308c\u308b\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u30ad\u30e5\u30fc\u306b\u8ffd\u52a0\u3057\u3066\u3044\u304f\u3053\u3068\u3067\u30ec\u30f3\u30c0\u30ea\u30f3\u30b0\u3092\u5b9f\u73fe\u3057\u307e\u3059\u3002\n\n\u591a\u5206\u3067\u3059\u304c\u30b3\u30de\u30f3\u30c9\u30d0\u30c3\u30d5\u30a1\u304c\u4e00\u56de\u306eDraw Call\u3063\u307d\u3044\u3067\u3059\u3002\n\u306a\u306e\u3067\u30b3\u30de\u30f3\u30c9\u30d0\u30c3\u30d5\u30a1\u306b\u306f\u51e6\u7406\u304c\u7d42\u4e86\u3057\u305f\u3053\u3068\u3092\u901a\u77e5\u3059\u308b\u30cf\u30f3\u30c9\u30e9\u3092\u8a2d\u5b9a\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\u3082\u3057CPU\u5074\u3067\u30c7\u30fc\u30bf\u3092\u5909\u66f4\u3057\u305f\u3044\u5834\u5408\u306f\u3001\u3053\u306e\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u3092\u5f85\u3063\u3066\u304b\u3089\u51e6\u7406\u3092\u3059\u308b\u3053\u3068\u3067\u5b89\u5168\u306b\u30c7\u30fc\u30bf\u3092\u5909\u66f4\u3067\u304d\u308b\u3001\u3068\u3044\u3046\u308f\u3051\u3067\u3059\u3002\n\n-------------------------------------------\n\n## \u4e09\u89d2\u5f62\u306e\u30ec\u30f3\u30c0\u30ea\u30f3\u30b0\n\n\u3055\u3066\u3001\u3053\u308c\u3067\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u304c\u7d42\u308f\u3063\u305f\u306e\u3067\u6b21\u306f\u30ec\u30f3\u30c0\u30ea\u30f3\u30b0\u3067\u3059\u3002\n\u4e3b\u306b\u4ee5\u4e0b\u306e\u30b9\u30c6\u30c3\u30d7\u306b\u306a\u308a\u307e\u3059\u3002\n\n1. CADisplayLink\u306e\u751f\u6210\n2. Render Pass Descriptor\u306e\u751f\u6210\n3. Command Buffer\u306e\u751f\u6210\n4. Render Command Encoder\u306e\u751f\u6210\n5. Command Buffer\u306e\u30b3\u30df\u30c3\u30c8\n\n\u203b ... \u672c\u6765\u3001`CADisplayLink`\u306f\u30ec\u30f3\u30c0\u30ea\u30f3\u30b0\u306b\u306f\u76f4\u63a5\u306f\u95a2\u4fc2\u3042\u308a\u307e\u305b\u3093\u304c\u30013D\u306f\u30ec\u30f3\u30c0\u30ea\u30f3\u30b0\u3092\u5e38\u306b\u884c\u3046\u304c\u666e\u901a\u306a\u306e\u3067\u305d\u306e\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u3082\u542b\u3081\u3066\u3044\u307e\u3059\u3002\n\n-------------------------------------------\n\n### CADisplayLink\u306e\u751f\u6210\n\nCADisplayLink\u306e\u751f\u6210\u306f\u7279\u306b\u65b0\u3057\u3044\u3053\u3068\u306f\u3042\u308a\u307e\u305b\u3093\u3002\n\n```objc\nCADisplayLink *timer = [CADisplayLink displayLinkWithTarget:self selector:@selector(gameloop)];\n[timer addToRunLoop:NSRunLoop.mainRunLoop forMode:NSDefaultRunLoopMode];\n\n/////////////////////////////////////////////////////////////////////////////\n\n- (void)gameloop\n{\n    @autoreleasepool {\n        [self render];\n    }\n}\n```\n\n`render`\u30e1\u30bd\u30c3\u30c9\u306e\u4e2d\u3067\u3001Metal\u3067\u306e\u30ec\u30f3\u30c0\u30ea\u30f3\u30b0\u51e6\u7406\u3092\u5b9f\u884c\u3059\u308c\u3070\u968f\u6642\u753b\u9762\u304c\u66f4\u65b0\u3055\u308c\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\n\n-------------------------------------------\n\n### Render Pass Descriptor\u306e\u751f\u6210\n\n\u30ec\u30f3\u30c0\u30ea\u30f3\u30b0\u7528\u306edescriptor\u3092\u751f\u6210\u3057\u307e\u3059\u3002\n\n```objc\n// Render Pass Descriptor\u306e\u751f\u6210\u3002\nMTLRenderPassDescriptor *renderPassDescriptor = [[MTLRenderPassDescriptor alloc] init];\nrenderPassDescriptor.colorAttachments[0].texture     = texture;\nrenderPassDescriptor.colorAttachments[0].loadAction  = MTLLoadActionClear;\nrenderPassDescriptor.colorAttachments[0].clearColor  = MTLClearColorMake(0.0, 104.0/255.0, 5.0/255.0, 1.0);\nrenderPassDescriptor.colorAttachments[0].storeAction = MTLStoreActionStore;\n```\n\n\u751f\u6210\u306b\u306f`MTLTexture`\u304c\u5fc5\u8981\u3067\u3059\u3002\u3053\u3053\u306b\u8a2d\u5b9a\u3057\u305f\u30c6\u30af\u30b9\u30c1\u30e3\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u306b\u30ec\u30f3\u30c0\u30ea\u30f3\u30b0\u51e6\u7406\u304c\u884c\u308f\u308c\u307e\u3059\u3002\n\u306a\u306e\u3067\u3053\u3053\u306b\u3001\u30aa\u30d5\u30b9\u30af\u30ea\u30fc\u30f3\u7528\u306b\u751f\u6210\u3057\u305f\u30c6\u30af\u30b9\u30c1\u30e3\u3092\u6307\u5b9a\u3059\u308c\u3070\u7c21\u5358\u306b\u30aa\u30d5\u30b9\u30af\u30ea\u30fc\u30f3\u30ec\u30f3\u30c0\u30ea\u30f3\u30b0\u304c\u3067\u304d\u307e\u3059\u3002\n\n-------------------------------------------\n\n### Command Buffer\u306e\u751f\u6210\n\n\u30b3\u30de\u30f3\u30c9\u30d0\u30c3\u30d5\u30a1\u306f\u30011\u30d5\u30ec\u30fc\u30e0\u306b\u5b9f\u884c\u3057\u305f\u3044\u30ec\u30f3\u30c0\u30fc\u30b3\u30de\u30f3\u30c9\u306e\u30ea\u30b9\u30c8\u306e\u30a4\u30e1\u30fc\u30b8\u3067\u3059\u3002\n\u30b3\u30de\u30f3\u30c9\u30d0\u30c3\u30d5\u30a1\u306f\u30b3\u30de\u30f3\u30c9\u30ad\u30e5\u30fc\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u304b\u3089\u751f\u6210\u3057\u307e\u3059\u3002\n\n```metal\n// create a new command queue\n_commandQueue = [_device newCommandQueue];\n\n/////////////////////////////////////////////////////////////////////////////\n\nid <MTLCommandBuffer> commandBuffer = [_commandQueue commandBuffer];\n```\n\n\u3061\u306a\u307f\u306b\u30b3\u30de\u30f3\u30c9\u30d0\u30c3\u30d5\u30a1\u306f\u3001\u660e\u793a\u7684\u306b\u30b3\u30df\u30c3\u30c8\u3092\u884c\u3046\u307e\u3067\u306a\u306b\u3082\u5b9f\u884c\u3057\u307e\u305b\u3093\u3002\n\n\n### Render Command Encoder\u306e\u751f\u6210\n\n\u5b9f\u969b\u306b\u30ec\u30f3\u30c0\u30ea\u30f3\u30b0\u3092\u884c\u3046\u30b3\u30de\u30f3\u30c9\u3067\u3059\u3002\n\u3053\u308c\u4ee5\u5916\u306b\u3082`MTLComputeCommandEncoder`\u3084`MTLBlitCommandEncoder`\u3068\u3044\u3063\u305f\u30ec\u30f3\u30c0\u30ea\u30f3\u30b0\u3092\u884c\u308f\u306a\u3044\u30b3\u30de\u30f3\u30c9\u3082\u3042\u308a\u307e\u3059\u3002\uff08`MTLComputeCommandEncoder`\u306f\u30d5\u30a3\u30eb\u30bf\u30fc\u306a\u3069\u3001\u30c6\u30af\u30b9\u30c1\u30e3\u306b\u51e6\u7406\u3092\u65bd\u3057\u3066\u30c6\u30af\u30b9\u30c1\u30e3\u3068\u3057\u3066\u66f8\u304d\u51fa\u3059\u3001\u307f\u305f\u3044\u306a\u3053\u3068\u304c\u3067\u304d\u308b\uff09\n\n```objc:Create-Render_command_encoder\n// Render Command Encoder\u306e\u751f\u6210\nid <MTLRenderCommandEncoder> renderEncoder = [commandBuffer renderCommandEncoderWithDescriptor:renderPassDescriptor];\n\nif (renderEncoder) {\n    [renderEncoder setRenderPipelineState:self.pipelineState];\n    [renderEncoder setVertexBuffer:self.vertexBuffer offset:0 atIndex:0];\n    [renderEncoder drawPrimitives:MTLPrimitiveTypeTriangle vertexStart:0 vertexCount:3 instanceCount:1];\n    [renderEncoder endEncoding];\n}\n```\n\n`glDrawElements`\u7684\u306a\u5f79\u5272\u3002\n\u3061\u306a\u307f\u306b\u751f\u6210\u306f\u300c\u30b3\u30de\u30f3\u30c9\u30d0\u30c3\u30d5\u30a1\u300d\u304b\u3089\u884c\u3044\u307e\u3059\u3002\n\n\u203b ... \u300c\u30d0\u30c3\u30d5\u30a1\u300d\u3068\u540d\u304c\u4ed8\u3044\u3066\u3044\u308b\u901a\u308a\u3001\u3044\u304f\u3064\u304b\u306e\u30b3\u30de\u30f3\u30c9\u3092\u3072\u3068\u307e\u3068\u3081\u306b\u3057\u3066\u30ad\u30e5\u30fc\u306b\u5165\u308c\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\n`[renderEncoder drawPrimitives:MTLPrimitiveTypeTriangle vertexStart:0 vertexCount:3 instanceCount:1];`\u3067\u6307\u5b9a\u3057\u305f`vertexCount`\u3084`instanceCount`\u304c\u3001\u524d\u8ff0\u3057\u305f\u3001\u69cb\u9020\u4f53\u3067\u30c7\u30fc\u30bf\u3092\u9001\u308b\u969b\u306e\u6307\u6a19\u306b\u306a\u308b\u3082\u306e\u3067\u3059\u3002\n\u524d\u8ff0\u306e\u4f8b\u3067\u8a00\u3048\u3070`vertexCount`\u306f`7`\u306b\u306a\u308a\u307e\u3059\u3002\n\n## \u30d0\u30c3\u30d5\u30a1\u30c7\u30fc\u30bf\u306e\u751f\u6210\u306b\u3064\u3044\u3066\u30e1\u30e2\n\nOpenGL\u3067\u8a00\u3046\u3068\u3053\u308d\u306e`VBO`\u306b\u3042\u305f\u308b\u30d0\u30c3\u30d5\u30a1\u306e\u7a2e\u985e\u306b\u3064\u3044\u3066\u3002\nOpenGL\u540c\u69d8\u3001`attribute`\u3084`uniform`\u306b\u3042\u305f\u308b\u5909\u6570\u304c\u3042\u308a\u307e\u3059\u3002\n\n`attribute`\u306a\u30d0\u30c3\u30d5\u30a1\u3092\u751f\u6210\u3059\u308b\u306b\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u3057\u307e\u3059\u3002\n\n```objc\n// \u9802\u70b9\u30c7\u30fc\u30bf\u3092\u5b9a\u7fa9\u3059\u308b\nstatic const float vertexData[] = {\n\t 0.0, -1.0, 0.0,\n\t-1.0,  1.0, 0.0,\n\t 1.0,  1.0, 0.0\n};\n```\n\n\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u3057\u3066\u30d0\u30c3\u30d5\u30a1\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u306b\u3057\u307e\u3059\u3002\n\n```objc\nid <MTLBuffer> buffer = [device newBufferWithBytes:vertexData length:sizeof(vertexData) options:MTLResourceOptionCPUCacheModelDefault];\n```\n\n\n\u6b21\u306b\u3001`uniform`\u306a\u30d0\u30c3\u30d5\u30a1\u3092\u751f\u6210\u3059\u308b\u306b\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u3057\u307e\u3059\u3002\n\n```objc\nstatic const float uniformData[] {\n\t1.0, 1.0, 1.0, 1.0,\n};\n```\n\n\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u3057\u3066\u30d0\u30c3\u30d5\u30a1\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u306b\u3057\u307e\u3059\u3002\n\n```objc\nid <MTLBuffer> uniformBuffer = [device newBufferWithLength:sizeof(uniformData) options:MTLResourceOptionCPUCacheModelDefault];\n```\n\n`attribute`\u3068\u306e\u9055\u3044\u306f`newBufferWithLength:options:`\u30e1\u30bd\u30c3\u30c9\u3092\u5229\u7528\u3059\u308b\u70b9\u3067\u3059\u3002\n\u3053\u308c\u306f\u30d0\u30c3\u30d5\u30a1\u306e\u9818\u57df\u3092\u78ba\u4fdd\u3059\u308b\u306e\u307f\u3067\u3001\u30c7\u30fc\u30bf\u81ea\u4f53\u306f\u3042\u3068\u304b\u3089\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\u5177\u4f53\u7684\u306b\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u3057\u307e\u3059\u3002\n\n```objc\nvoid *buf = [uniformBuffer contents];\nmemcpy(buf, uniformData, sizeof(uniformData));\n```\n\n-------------------------------------------\n\n### \u30b3\u30de\u30f3\u30c9\u30d0\u30c3\u30d5\u30a1\u306e\u30b3\u30df\u30c3\u30c8\n\n```objc\n[commandBuffer presentDrawable:view.currentDrawable];\n[commandBuffer commit];\n```\n\n\u6700\u5f8c\u306b\u30ec\u30f3\u30c0\u30ea\u30f3\u30b0\u3092GPU\u306b\u884c\u308f\u305b\u308b\u305f\u3081\u306b\u30b3\u30de\u30f3\u30c9\u30d0\u30c3\u30d5\u30a1\u3092\u30b3\u30df\u30c3\u30c8\u3057\u307e\u3059\u3002\n`commit`\u30e1\u30bd\u30c3\u30c9\u306f\u30ad\u30e5\u30fc\u306b\u8ffd\u52a0\u3057\u3001\u3082\u3057\u53ef\u80fd\u3067\u3042\u308c\u3070\u5373\u5ea7\u306b\u30b3\u30de\u30f3\u30c9\u304c\u5b9f\u884c\u3055\u308c\u307e\u3059\u3002\uff08\u30ad\u30e5\u30fc\u304c\u5f85\u3061\u72b6\u614b\u306e\u5834\u5408\u306f\u6700\u5f8c\u306b\u8ffd\u52a0\u3055\u308c\u307e\u3059\uff09\n\n\n## \u53c2\u8003\u306b\u3057\u305f\u8a18\u4e8b\n\n- [iOS 8 Metal Tutorial with Swift: Getting Started](http://www.raywenderlich.com/77488/ios-8-metal-tutorial-swift-getting-started)\n- [iOS 8 Metal Tutorial with Swift Part 2: Moving to 3D](http://www.raywenderlich.com/81399/ios-8-metal-tutorial-swift-moving-to-3d)\n- [\niOS 8 Metal Tutorial with Swift Part 3: Adding Texture](http://www.raywenderlich.com/93997/ios-8-metal-tutorial-swift-part-3-adding-texture)\n- [Metal\u306e\u300cshared CPU/GPU memory buffer\u300d\u306b\u3064\u3044\u3066](http://dsas.blog.klab.org/archives/52168462.html)\n- [Metal\u306e\u30b3\u30fc\u30c9\u3092\u8aad\u3080\u524d\u306b\u77e5\u3063\u3066\u304a\u304f\u3068\u697d\u306a\u3053\u3068](http://dsas.blog.klab.org/archives/52168969.html)\n", "tags": ["iOS", "3D", "Metal"]}