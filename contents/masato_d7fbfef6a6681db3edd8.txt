{"tags": ["IDCF\u30af\u30e9\u30a6\u30c9", "CoreOS494.5.0", "Couchbase3.0.1", "CouchbaseSyncGateway", "fleet"], "context": " \u3053\u306e\u8a18\u4e8b\u306f\u6700\u7d42\u66f4\u65b0\u65e5\u304b\u30891\u5e74\u4ee5\u4e0a\u304c\u7d4c\u904e\u3057\u3066\u3044\u307e\u3059\u3002Couchbase Sync Gateway\u3092\u8ffd\u52a0\u3057\u305f\u30af\u30e9\u30b9\u30bf\u518d\u69cb\u6210\u3057\u3066\u3001Couchbase Mobile\u306e\u30b5\u30fc\u30d0\u30fc\u30b5\u30a4\u30c9\u3092\u69cb\u7bc9\u3057\u307e\u3059\u3002\u3088\u3046\u3084\u304f\u30b5\u30fc\u30d0\u30fc\u30b5\u30a4\u30c9\u304c\u3067\u304d\u3042\u304c\u308a\u307e\u3057\u305f\u3002\u3053\u306e\u5f8c\u306fXamarin\u3084ionic\u306a\u3069\u30d5\u30ed\u30f3\u30c8\u30a8\u30f3\u30c9\u958b\u767a\u3092\u3057\u3066Couchbase Mobile\u3068\u9023\u643a\u3057\u305f\u30a2\u30d7\u30ea\u3092\u958b\u767a\u3092\u3057\u307e\u3059\u3002\n\nfleet\u30af\u30e9\u30b9\u30bf\u306e\u518d\u69cb\u7bc9\n\u524d\u56de\u3001tleyden5iwx/couchbase-server-3.0.1\u3092\u4f7f\u3044\u69cb\u7bc9\u3057\u305fCouchbase Server\u306efleet\u30af\u30e9\u30b9\u30bf\u3092\u3001tleyden5iwx/couchbase-sync-gateway\u3092\u4f7f\u3063\u3066\u4f5c\u308a\u76f4\u3057\u307e\u3059\u3002\n\nfleet units\u306e\u7834\u68c4\n\u518d\u69cb\u7bc9\u524d\u306eunits\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002\n$ fleetctl list-units\nUNIT                                            MACHINE                 ACTIVE  SUB\ncouchbase_bootstrap_node.service                33bf6324.../10.3.0.7    active  running\ncouchbase_bootstrap_node_announce.service       33bf6324.../10.3.0.7    active  running\ncouchbase_node.1.service                        461b77ab.../10.3.0.193  active  running\ncouchbase_node.2.service                        80e8c0f2.../10.3.0.210  active  running\n\n\u30c7\u30d7\u30ed\u30a4\u6e08\u307f\u306eunits\u3092\u3059\u3079\u3066\u7834\u68c4\u3057\u307e\u3059\u3002\n$ fleetctl destroy couchbase_bootstrap_node.service couchbase_bootstrap_node_announce.service couchbase_node.1.service couchbase_node.2.service \nDestroyed couchbase_bootstrap_node.service\nDestroyed couchbase_bootstrap_node_announce.service\nDestroyed couchbase_node.1.service\nDestroyed couchbase_node.2.servic\n$ fleetctl list-units\nUNIT    MACHINE ACTIVE  SUB\n\n\ncloud-init\u306e\u3084\u308a\u76f4\u3057\n\u3059\u3079\u3066\u306e\u4eee\u60f3\u30de\u30b7\u30f3\u3067/var/lib/coreos-install/user_data/user_data\u3092\u7de8\u96c6\u3057\u3066cloud-init\u3092\u3084\u308a\u76f4\u3057\u307e\u3059\u3002CBFS\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u4f5c\u6210\u3059\u308bwrite_files\u3092\u8ffd\u8a18\u3057\u307e\u3059\u3002\n\n/var/lib/coreos-install/user_data/user_data\n\n- path: /var/lib/cbfs/data/.README\n    owner: core:core\n    permissions: 0644\n    content: |\n      CBFS files are stored here\n\n\n\u65b0\u3057\u3044cloud-config.yml\u306f\u4ee5\u4e0b\u306e\u901a\u308a\u3067\u3059\u3002\n\ncloud-config.yml\n#cloud-config\nwrite_files:\n  - path: /etc/environment\n    content: |\n      COREOS_PUBLIC_IPV4=\n      COREOS_PRIVATE_IPV4=10.3.0.7\n  - path: /etc/systemd/system/docker.service.d/increase-ulimit.conf\n    owner: core:core\n    permissions: 0644\n    content: |\n      [Service]\n      LimitMEMLOCK=infinity\n  - path: /var/lib/couchbase/data/.README\n    owner: core:core\n    permissions: 0644\n    content: |\n      Couchbase Data files are stored here\n  - path: /var/lib/couchbase/index/.README\n    owner: core:core\n    permissions: 0644\n    content: |\n      Couchbase Index files are stored here\n  - path: /var/lib/cbfs/data/.README\n    owner: core:core\n    permissions: 0644\n    content: |\n      CBFS files are stored here\ncoreos:\n  etcd:\n    discovery: https://discovery.etcd.io/5c8b6b2d75b706d24e37c2e202984a2f\n    addr: 10.3.0.7:4001\n    peer-addr: 10.3.0.7:7001\n  units:\n    - name: etcd.service\n      command: start\n    - name: fleet.service\n      command: start\n    - name: docker.service\n      command: restart\n    - name: timezone.service\n      command: start\n      content: |\n        [Unit]\n        Description=timezone\n        [Service]\n        Type=oneshot\n        RemainAfterExit=yes\n        ExecStart=/usr/bin/ln -sf ../usr/share/zoneinfo/Japan /etc/localtime\nssh_authorized_keys:\n  - ssh-rsa AAAAB3Nza...\n\n\ncoreos-cloudinit\u3092\u5b9f\u884c\u3057\u3066\u4e0a\u8a18\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n$ sudo coreos-cloudinit --from-file /var/lib/coreos-install/user_data\n\n\u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3\u56f3\u3092tleyden/sync-gateway-coreos\u304b\u3089\u8ee2\u8f09\u3057\u307e\u3059\u3002\n\n\nsync-gw-cluster-init.sh\u30b9\u30af\u30ea\u30d7\u30c8\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u3066\u5b9f\u884c\u6a29\u9650\u3092\u3064\u3051\u307e\u3059\u3002\nsync-gw-cluster-init.sh\n\nsync-gw-cluster-init.sh\n# Args:\n#   -n number of Sync Gateway nodes to start\n#   -c the commit or branch to use.  If \"image\" is given, will use master branch at time of docker image build.\n#   -b the name of the couchbase bucket to create, or leave this off if you don't need to create a bucket.  (optional)\n#   -z the size of the bucket in megabytes, or leave this off if you don't need to create a bucket.  (optional)\n#   -g the Sync Gateway config file or URL to use.\n#   -v Couchbase Server version (3.0.1 or 2.2, or 0 to skip the couchbase server initialization)\n#   -m number of couchbase nodes to start\n#   -u the username and password as a single string, delimited by a colon (:)\n\nusage=\"./sync-gw-cluster-init.sh -n 1 -c \\\"master\\\" -b \\\"todolite\\\" -z \\\"512\\\" -g \\\"http://foo.com/config.json\\\" -v 3.0.1 -m 3 -u \\\"user:passw0rd\\\"\"\n\n\nsync-gw-cluster-init.sh\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u3066\u5b9f\u884c\u6a29\u9650\u3092\u3064\u3051\u307e\u3059\u3002\n$ wget https://raw.githubusercontent.com/tleyden/sync-gateway-coreos/master/scripts/sync-gw-cluster-init.sh\n$ chmod +x sync-gw-cluster-init.sh\n\n\u74b0\u5883\u5909\u6570\u3092\u30bb\u30c3\u30c8\u3057\u3066\u3001\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u5b9f\u884c\u3057\u307e\u3059\u3002\n$ SG_CONFIG_URL=https://raw.githubusercontent.com/couchbaselabs/ToDoLite-iOS/master/sync-gateway-config.json\n$ ./sync-gw-cluster-init.sh -n 1 -c master -b \"todos\" -z 512 -g $SG_CONFIG_URL -v 3.0.1 -m 3 -u user:passw0rd\nKick off couchbase cluster\n--2015-01-09 12:26:26--  https://raw.githubusercontent.com/couchbaselabs/couchbase-server-docker/master/scripts/cluster-init.sh\nResolving raw.githubusercontent.com... 103.245.222.133\nConnecting to raw.githubusercontent.com|103.245.222.133|:443... connected.\nHTTP request sent, awaiting response... 200 OK\nLength: 1940 (1.9K) [text/plain]\nSaving to: 'cluster-init.sh'\n\ncluster-init.sh          100%[===================================>]   1.89K  --.-KB/s   in 0s\n\n2015-01-09 12:26:27 (82.4 MB/s) - 'cluster-init.sh' saved [1940/1940]\n\nCloning into 'couchbase-server-docker'...\nremote: Counting objects: 350, done.\nremote: Compressing objects: 100% (132/132), done.\nremote: Total 350 (delta 195), reused 350 (delta 195)\nReceiving objects: 100% (350/350), 39.46 KiB | 0 bytes/s, done.\nResolving deltas: 100% (195/195), done.\nChecking connectivity... done.\nuser:passw0rd\nKicking off couchbase server bootstrap node\nUnit couchbase_bootstrap_node.service launched\nUnit couchbase_bootstrap_node_announce.service launched on 33bf6324.../10.3.0.7\nKicking off  additional couchbase server nodes\nUnit couchbase_node.2.service launched on 80e8c0f2.../10.3.0.210\nUnit couchbase_node.1.service launched on 461b77ab.../10.3.0.193\nWait until Couchbase bootstrap node is up\nRetrying...\nCouchbase Server bootstrap ip: 10.3.0.7\nWait until 3 Couchbase Servers running\nRetrying... 0 != 3\nRetrying... 1 != 3\nRetrying... 1 != 3\nRetrying... 2 != 3\nDone waiting: 3 Couchbase Servers are running\nINFO: rebalancing . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .\nSUCCESS: rebalanced cluster\nCreate a bucket: todos with size: 512\nSUCCESS: bucket-create\nDone: created a bucket\nhttps://raw.githubusercontent.com/couchbaselabs/ToDoLite-iOS/master/sync-gateway-config.json\nmaster\nCloning into 'sync-gateway-coreos'...\nremote: Counting objects: 101, done.\nremote: Total 101 (delta 0), reused 0 (delta 0)\nReceiving objects: 100% (101/101), 16.93 KiB | 0 bytes/s, done.\nResolving deltas: 100% (49/49), done.\nChecking connectivity... done.\nUnit sync_gw_node@1.service launched on f0f5fcc4.../10.3.0.47\nUnit sync_gw_announce@1.service launched on f0f5fcc4.../10.3.0.47\nYour couchbase server + sync gateway cluster is now active!\n\n\u4f55\u3089\u304b\u306e\u4e8b\u8c61\u3067\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u306b\u5931\u6557\u3057\u305f\u5834\u5408\u306f\u3001\u3044\u3061\u3069\u30ab\u30ec\u30f3\u30c8\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u304d\u308c\u3044\u306b\u3057\u307e\u3059\u3002\n$ rm cluster-init.sh*\n$ rm -fr couchbase-server-docker sync-gateway-coreos\n$ SG_CONFIG_URL=https://raw.githubusercontent.com/couchbaselabs/ToDoLite-iOS/master/sync-gateway-config.json\n$ ./sync-gw-cluster-init.sh -n 1 -c master -b \"todos\" -z 512 -g $SG_CONFIG_URL -v 3.0.1 -m 3 -u user:passw0rd\nKick off couchbase cluster\n\n\nfleet units\u306e\u78ba\u8a8d\nfleet units\u3092\u30ea\u30b9\u30c8\u3057\u307e\u3059\u3002\n$ fleetctl list-units\nUNIT                                            MACHINE                 ACTIVE  SUB\ncouchbase_bootstrap_node.service                33bf6324.../10.3.0.7    active  running\ncouchbase_bootstrap_node_announce.service       33bf6324.../10.3.0.7    active  running\ncouchbase_node.1.service                        461b77ab.../10.3.0.193  active  running\ncouchbase_node.2.service                        80e8c0f2.../10.3.0.210  active  running\nsync_gw_announce@1.service                      f0f5fcc4.../10.3.0.47   active  running\nsync_gw_node@1.service                          f0f5fcc4.../10.3.0.47   active  running\n\ncouchbase_bootstrap_node\u3092\u542b\u3081\u3066Couchbase Server \u304c3\u53f0\u3001Couchbase Sync Gateway\u304c1\u53f0\u4f5c\u6210\u3067\u304d\u307e\u3057\u305f\u3002\nCouchbase Sync Gateway\u306e\u8d77\u52d5\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n$ curl 10.3.0.47:4984\n{\"couchdb\":\"Welcome\",\"vendor\":{\"name\":\"Couchbase Sync Gateway\",\"version\":1},\"version\":\"Couchbase Sync Gateway/master(6bdb3f6)\"}\n\n\u30d1\u30d6\u30ea\u30c3\u30afIP\u30a2\u30c9\u30ec\u30b9\u304b\u3089\u4f7f\u3046\u5834\u5408\u306f\u3001node\u306e\u4eee\u60f3\u30de\u30b7\u30f3\u3078\u306eport forward\u306e\u8a2d\u5b9a\u304c\u5fc5\u8981\u3067\u3059\u3002\n\u30d7\u30e9\u30a4\u30d9\u30fc\u30c8IP\u30a2\u30c9\u30ec\u30b9\nhttp://10.3.0.210:8091\n\u30d1\u30d6\u30ea\u30c3\u30afIP\u30a2\u30c9\u30ec\u30b9\nhttp://210.140.173.63:8091\n\nuser: user\npasswd: passw0rd\n\nCouchbaseSyncGateway Admin\u30a4\u30f3\u30bf\u30d5\u30a7\u30fc\u30b9\u306f\u30ed\u30fc\u30ab\u30eb\u306e\u307f\u30a2\u30af\u30bb\u30b9\u53ef\u80fd\u3067\u3059\u3002sync_gw_node\u306b\u30ed\u30b0\u30a4\u30f3\u3057\u3066\u304b\u3089\u5b9f\u884c\u3057\u307e\u3059\u3002\n$ fleetctl ssh f0f5fcc4\n$ curl localhost:4985\n{\"ADMIN\":true,\"couchdb\":\"Welcome\",\"vendor\":{\"name\":\"Couchbase Sync Gateway\",\"version\":1},\"version\":\"Couchbase Sync Gateway/master(6bdb3f6)\"}\n\n\u4ee5\u4e0b\u306e\u3088\u3046\u306bAdmin\u30dd\u30fc\u30c8\u306e4985\u306f\u3001\u5916\u90e8\u304b\u3089\u63a5\u7d9a\u3067\u304d\u307e\u305b\u3093\n$ curl 10.3.0.47:4985\ncurl: (7) Failed connect to 10.3.0.47:4985; Connection refused\n\n\u78ba\u8a8d\n$ curl localhost:4985/todos/\n{\"committed_update_seq\":1,\"compact_running\":false,\"db_name\":\"todos\",\"disk_format_version\":0,\"instance_start_time\":1420774094012079,\"purge_seq\":0,\"update_seq\":1}\n\nCouchbase Sync Gateway\u3092\u8ffd\u52a0\u3057\u305f\u30af\u30e9\u30b9\u30bf\u518d\u69cb\u6210\u3057\u3066\u3001Couchbase Mobile\u306e\u30b5\u30fc\u30d0\u30fc\u30b5\u30a4\u30c9\u3092\u69cb\u7bc9\u3057\u307e\u3059\u3002\u3088\u3046\u3084\u304f\u30b5\u30fc\u30d0\u30fc\u30b5\u30a4\u30c9\u304c\u3067\u304d\u3042\u304c\u308a\u307e\u3057\u305f\u3002\u3053\u306e\u5f8c\u306fXamarin\u3084ionic\u306a\u3069\u30d5\u30ed\u30f3\u30c8\u30a8\u30f3\u30c9\u958b\u767a\u3092\u3057\u3066Couchbase Mobile\u3068\u9023\u643a\u3057\u305f\u30a2\u30d7\u30ea\u3092\u958b\u767a\u3092\u3057\u307e\u3059\u3002\n\n\n## fleet\u30af\u30e9\u30b9\u30bf\u306e\u518d\u69cb\u7bc9\n\n[\u524d\u56de](http://qiita.com/masato/items/dab027b0d4b0146f9e40)\u3001[tleyden5iwx/couchbase-server-3.0.1](https://registry.hub.docker.com/u/tleyden5iwx/couchbase-server-3.0.1/)\u3092\u4f7f\u3044\u69cb\u7bc9\u3057\u305fCouchbase Server\u306efleet\u30af\u30e9\u30b9\u30bf\u3092\u3001[tleyden5iwx/couchbase-sync-gateway](https://registry.hub.docker.com/u/tleyden5iwx/couchbase-sync-gateway/)\u3092\u4f7f\u3063\u3066\u4f5c\u308a\u76f4\u3057\u307e\u3059\u3002\n\n## fleet units\u306e\u7834\u68c4\n\n\u518d\u69cb\u7bc9\u524d\u306eunits\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002\n\n``` bash\n$ fleetctl list-units\nUNIT                                            MACHINE                 ACTIVE  SUB\ncouchbase_bootstrap_node.service                33bf6324.../10.3.0.7    active  running\ncouchbase_bootstrap_node_announce.service       33bf6324.../10.3.0.7    active  running\ncouchbase_node.1.service                        461b77ab.../10.3.0.193  active  running\ncouchbase_node.2.service                        80e8c0f2.../10.3.0.210  active  running\n```\n\n\u30c7\u30d7\u30ed\u30a4\u6e08\u307f\u306eunits\u3092\u3059\u3079\u3066\u7834\u68c4\u3057\u307e\u3059\u3002\n\n``` bash\n$ fleetctl destroy couchbase_bootstrap_node.service couchbase_bootstrap_node_announce.service couchbase_node.1.service couchbase_node.2.service \nDestroyed couchbase_bootstrap_node.service\nDestroyed couchbase_bootstrap_node_announce.service\nDestroyed couchbase_node.1.service\nDestroyed couchbase_node.2.servic\n$ fleetctl list-units\nUNIT    MACHINE ACTIVE  SUB\n```\n\n## cloud-init\u306e\u3084\u308a\u76f4\u3057\n\n\u3059\u3079\u3066\u306e\u4eee\u60f3\u30de\u30b7\u30f3\u3067`/var/lib/coreos-install/user_data/user_data`\u3092\u7de8\u96c6\u3057\u3066cloud-init\u3092\u3084\u308a\u76f4\u3057\u307e\u3059\u3002CBFS\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u4f5c\u6210\u3059\u308b`write_files`\u3092\u8ffd\u8a18\u3057\u307e\u3059\u3002\n\n``` yml:/var/lib/coreos-install/user_data/user_data\n\n- path: /var/lib/cbfs/data/.README\n    owner: core:core\n    permissions: 0644\n    content: |\n      CBFS files are stored here\n```\n\n\u65b0\u3057\u3044cloud-config.yml\u306f\u4ee5\u4e0b\u306e\u901a\u308a\u3067\u3059\u3002\n\n``` yml:cloud-config.yml\n#cloud-config\nwrite_files:\n  - path: /etc/environment\n    content: |\n      COREOS_PUBLIC_IPV4=\n      COREOS_PRIVATE_IPV4=10.3.0.7\n  - path: /etc/systemd/system/docker.service.d/increase-ulimit.conf\n    owner: core:core\n    permissions: 0644\n    content: |\n      [Service]\n      LimitMEMLOCK=infinity\n  - path: /var/lib/couchbase/data/.README\n    owner: core:core\n    permissions: 0644\n    content: |\n      Couchbase Data files are stored here\n  - path: /var/lib/couchbase/index/.README\n    owner: core:core\n    permissions: 0644\n    content: |\n      Couchbase Index files are stored here\n  - path: /var/lib/cbfs/data/.README\n    owner: core:core\n    permissions: 0644\n    content: |\n      CBFS files are stored here\ncoreos:\n  etcd:\n    discovery: https://discovery.etcd.io/5c8b6b2d75b706d24e37c2e202984a2f\n    addr: 10.3.0.7:4001\n    peer-addr: 10.3.0.7:7001\n  units:\n    - name: etcd.service\n      command: start\n    - name: fleet.service\n      command: start\n    - name: docker.service\n      command: restart\n    - name: timezone.service\n      command: start\n      content: |\n        [Unit]\n        Description=timezone\n        [Service]\n        Type=oneshot\n        RemainAfterExit=yes\n        ExecStart=/usr/bin/ln -sf ../usr/share/zoneinfo/Japan /etc/localtime\nssh_authorized_keys:\n  - ssh-rsa AAAAB3Nza...\n```\n\ncoreos-cloudinit\u3092\u5b9f\u884c\u3057\u3066\u4e0a\u8a18\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n``` bash\n$ sudo coreos-cloudinit --from-file /var/lib/coreos-install/user_data\n```\n\n\u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3\u56f3\u3092[tleyden/sync-gateway-coreos](https://github.com/tleyden/sync-gateway-coreos)\u304b\u3089\u8ee2\u8f09\u3057\u307e\u3059\u3002\n\n![coreos-couchbase-sync-gateway.png](https://qiita-image-store.s3.amazonaws.com/0/43745/c7d65722-2e97-3277-2913-c6d75aba149c.png)\n\n\n## sync-gw-cluster-init.sh\u30b9\u30af\u30ea\u30d7\u30c8\n\n\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u3066\u5b9f\u884c\u6a29\u9650\u3092\u3064\u3051\u307e\u3059\u3002\n\n[sync-gw-cluster-init.sh](https://github.com/tleyden/sync-gateway-coreos/blob/master/scripts/sync-gw-cluster-init.sh)\n\n``` bash:sync-gw-cluster-init.sh\n# Args:\n#   -n number of Sync Gateway nodes to start\n#   -c the commit or branch to use.  If \"image\" is given, will use master branch at time of docker image build.\n#   -b the name of the couchbase bucket to create, or leave this off if you don't need to create a bucket.  (optional)\n#   -z the size of the bucket in megabytes, or leave this off if you don't need to create a bucket.  (optional)\n#   -g the Sync Gateway config file or URL to use.\n#   -v Couchbase Server version (3.0.1 or 2.2, or 0 to skip the couchbase server initialization)\n#   -m number of couchbase nodes to start\n#   -u the username and password as a single string, delimited by a colon (:)\n\nusage=\"./sync-gw-cluster-init.sh -n 1 -c \\\"master\\\" -b \\\"todolite\\\" -z \\\"512\\\" -g \\\"http://foo.com/config.json\\\" -v 3.0.1 -m 3 -u \\\"user:passw0rd\\\"\"\n```\n\nsync-gw-cluster-init.sh\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u3066\u5b9f\u884c\u6a29\u9650\u3092\u3064\u3051\u307e\u3059\u3002\n\n``` bash\n$ wget https://raw.githubusercontent.com/tleyden/sync-gateway-coreos/master/scripts/sync-gw-cluster-init.sh\n$ chmod +x sync-gw-cluster-init.sh\n```\n\n\u74b0\u5883\u5909\u6570\u3092\u30bb\u30c3\u30c8\u3057\u3066\u3001\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u5b9f\u884c\u3057\u307e\u3059\u3002\n\n```\n$ SG_CONFIG_URL=https://raw.githubusercontent.com/couchbaselabs/ToDoLite-iOS/master/sync-gateway-config.json\n$ ./sync-gw-cluster-init.sh -n 1 -c master -b \"todos\" -z 512 -g $SG_CONFIG_URL -v 3.0.1 -m 3 -u user:passw0rd\nKick off couchbase cluster\n--2015-01-09 12:26:26--  https://raw.githubusercontent.com/couchbaselabs/couchbase-server-docker/master/scripts/cluster-init.sh\nResolving raw.githubusercontent.com... 103.245.222.133\nConnecting to raw.githubusercontent.com|103.245.222.133|:443... connected.\nHTTP request sent, awaiting response... 200 OK\nLength: 1940 (1.9K) [text/plain]\nSaving to: 'cluster-init.sh'\n\ncluster-init.sh          100%[===================================>]   1.89K  --.-KB/s   in 0s\n\n2015-01-09 12:26:27 (82.4 MB/s) - 'cluster-init.sh' saved [1940/1940]\n\nCloning into 'couchbase-server-docker'...\nremote: Counting objects: 350, done.\nremote: Compressing objects: 100% (132/132), done.\nremote: Total 350 (delta 195), reused 350 (delta 195)\nReceiving objects: 100% (350/350), 39.46 KiB | 0 bytes/s, done.\nResolving deltas: 100% (195/195), done.\nChecking connectivity... done.\nuser:passw0rd\nKicking off couchbase server bootstrap node\nUnit couchbase_bootstrap_node.service launched\nUnit couchbase_bootstrap_node_announce.service launched on 33bf6324.../10.3.0.7\nKicking off  additional couchbase server nodes\nUnit couchbase_node.2.service launched on 80e8c0f2.../10.3.0.210\nUnit couchbase_node.1.service launched on 461b77ab.../10.3.0.193\nWait until Couchbase bootstrap node is up\nRetrying...\nCouchbase Server bootstrap ip: 10.3.0.7\nWait until 3 Couchbase Servers running\nRetrying... 0 != 3\nRetrying... 1 != 3\nRetrying... 1 != 3\nRetrying... 2 != 3\nDone waiting: 3 Couchbase Servers are running\nINFO: rebalancing . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .\nSUCCESS: rebalanced cluster\nCreate a bucket: todos with size: 512\nSUCCESS: bucket-create\nDone: created a bucket\nhttps://raw.githubusercontent.com/couchbaselabs/ToDoLite-iOS/master/sync-gateway-config.json\nmaster\nCloning into 'sync-gateway-coreos'...\nremote: Counting objects: 101, done.\nremote: Total 101 (delta 0), reused 0 (delta 0)\nReceiving objects: 100% (101/101), 16.93 KiB | 0 bytes/s, done.\nResolving deltas: 100% (49/49), done.\nChecking connectivity... done.\nUnit sync_gw_node@1.service launched on f0f5fcc4.../10.3.0.47\nUnit sync_gw_announce@1.service launched on f0f5fcc4.../10.3.0.47\nYour couchbase server + sync gateway cluster is now active!\n```\n\n\u4f55\u3089\u304b\u306e\u4e8b\u8c61\u3067\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u306b\u5931\u6557\u3057\u305f\u5834\u5408\u306f\u3001\u3044\u3061\u3069\u30ab\u30ec\u30f3\u30c8\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u304d\u308c\u3044\u306b\u3057\u307e\u3059\u3002\n\n``` bash\n$ rm cluster-init.sh*\n$ rm -fr couchbase-server-docker sync-gateway-coreos\n$ SG_CONFIG_URL=https://raw.githubusercontent.com/couchbaselabs/ToDoLite-iOS/master/sync-gateway-config.json\n$ ./sync-gw-cluster-init.sh -n 1 -c master -b \"todos\" -z 512 -g $SG_CONFIG_URL -v 3.0.1 -m 3 -u user:passw0rd\nKick off couchbase cluster\n```\n\n## fleet units\u306e\u78ba\u8a8d\n\nfleet units\u3092\u30ea\u30b9\u30c8\u3057\u307e\u3059\u3002\n\n``` bash\n$ fleetctl list-units\nUNIT                                            MACHINE                 ACTIVE  SUB\ncouchbase_bootstrap_node.service                33bf6324.../10.3.0.7    active  running\ncouchbase_bootstrap_node_announce.service       33bf6324.../10.3.0.7    active  running\ncouchbase_node.1.service                        461b77ab.../10.3.0.193  active  running\ncouchbase_node.2.service                        80e8c0f2.../10.3.0.210  active  running\nsync_gw_announce@1.service                      f0f5fcc4.../10.3.0.47   active  running\nsync_gw_node@1.service                          f0f5fcc4.../10.3.0.47   active  running\n```\n\ncouchbase_bootstrap_node\u3092\u542b\u3081\u3066Couchbase Server \u304c3\u53f0\u3001Couchbase Sync Gateway\u304c1\u53f0\u4f5c\u6210\u3067\u304d\u307e\u3057\u305f\u3002\n\n\nCouchbase Sync Gateway\u306e\u8d77\u52d5\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n``` bash\n$ curl 10.3.0.47:4984\n{\"couchdb\":\"Welcome\",\"vendor\":{\"name\":\"Couchbase Sync Gateway\",\"version\":1},\"version\":\"Couchbase Sync Gateway/master(6bdb3f6)\"}\n```\n\n\u30d1\u30d6\u30ea\u30c3\u30afIP\u30a2\u30c9\u30ec\u30b9\u304b\u3089\u4f7f\u3046\u5834\u5408\u306f\u3001node\u306e\u4eee\u60f3\u30de\u30b7\u30f3\u3078\u306eport forward\u306e\u8a2d\u5b9a\u304c\u5fc5\u8981\u3067\u3059\u3002\n\n\u30d7\u30e9\u30a4\u30d9\u30fc\u30c8IP\u30a2\u30c9\u30ec\u30b9\nhttp://10.3.0.210:8091\n\n\u30d1\u30d6\u30ea\u30c3\u30afIP\u30a2\u30c9\u30ec\u30b9\nhttp://210.140.173.63:8091\n\n\n* user: user\n* passwd: passw0rd\n\nCouchbaseSyncGateway Admin\u30a4\u30f3\u30bf\u30d5\u30a7\u30fc\u30b9\u306f\u30ed\u30fc\u30ab\u30eb\u306e\u307f\u30a2\u30af\u30bb\u30b9\u53ef\u80fd\u3067\u3059\u3002sync_gw_node\u306b\u30ed\u30b0\u30a4\u30f3\u3057\u3066\u304b\u3089\u5b9f\u884c\u3057\u307e\u3059\u3002\n\n```\n$ fleetctl ssh f0f5fcc4\n$ curl localhost:4985\n{\"ADMIN\":true,\"couchdb\":\"Welcome\",\"vendor\":{\"name\":\"Couchbase Sync Gateway\",\"version\":1},\"version\":\"Couchbase Sync Gateway/master(6bdb3f6)\"}\n```\n\n\u4ee5\u4e0b\u306e\u3088\u3046\u306bAdmin\u30dd\u30fc\u30c8\u306e4985\u306f\u3001\u5916\u90e8\u304b\u3089\u63a5\u7d9a\u3067\u304d\u307e\u305b\u3093\n\n``` bash\n$ curl 10.3.0.47:4985\ncurl: (7) Failed connect to 10.3.0.47:4985; Connection refused\n```\n\n\u78ba\u8a8d\n\n``` bash\n$ curl localhost:4985/todos/\n{\"committed_update_seq\":1,\"compact_running\":false,\"db_name\":\"todos\",\"disk_format_version\":0,\"instance_start_time\":1420774094012079,\"purge_seq\":0,\"update_seq\":1}\n```\n"}