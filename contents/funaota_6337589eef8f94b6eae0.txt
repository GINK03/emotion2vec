{"context": "\n\n\u2460Gemfile\u3092\u5909\u66f4\u3059\u308b\n\nGemfile\ngem 'devise'\ngem 'omniauth'\ngem 'omniauth-facebook'\n\n\n\u5909\u66f4\u3057\u305f\u3089$ bundle install\n\n\u2461 devise\u306e\u8af8\u3005\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\n$ bundle exec rails g devise:install\n$ bundle exec rails g devise User provider:string uid:string name:string token:string\n$ bundle exec rails g devise:controllers\n$ bundle exec rails g devise:views users\n$ bundle exec rails g controller home index\n\n\u6700\u5f8c\u306eController\u306froot\u7528\u3067\u3059\u305c\n$ rake db:create\n$ rake db:migrate\n\n\u3082\u5fd8\u308c\u305a\u306b\uff01\n\n\u2462 devise\u306e\u30c7\u30d5\u30a9\u30eb\u30c8\u306eURL\u3092\u5909\u66f4\n\nconfig/environments/development.rb\n\nRails.application.configure do\n\n  ...\n\n  # mailer setting\n  config.action_mailer.default_url_options = { host: 'localhost', port: 3000 }\n\nend\n\n\n\n\u2463 facebook\u306eAPPID\u3068SECRET_KEY\u3092GET\u3059\u308b\n\u3053\u3053\u304b\u3089GET\u3057\u3066\u304f\u308c\u3088\u306a\uff01\nhttps://developers.facebook.com/\n\n\u2464 \uff14\u3067\u53d6\u5f97\u3057\u305f\u3084\u3064\u3089\u3092config\u306b\u53cd\u6620\u3055\u305b\u308b\n\nconfig/initializers/devise.rb\nrequire \"omniauth-facebook\"\nDevise.setup do |config|\n\n  ...\n\n  OpenSSL::SSL::VERIFY_PEER = OpenSSL::SSL::VERIFY_NONE if Rails.env.development? #\u3068\u308a\u3042\u3048\u305a\u30ed\u30fc\u30ab\u30eb\u3067\u52d5\u304f\u5974\u3064\u304f\u308b\u3088\uff01\n  config.omniauth :facebook, ENV['FACEBOOK_APP_ID'], ENV['FACEBOOK_APP_SECRET']  #dotenv-rails\u3068\u304b\u4f7f\u3063\u3066\u306d\uff01\n\nend\n\n\nfacebook_app_id\u3068\u304b\u306fdotenv-rails\u3068\u304b\u3067\u7ba1\u7406\uff01\uff01\n\n\u2465User\u30e2\u30c7\u30eb\u306edevise\u8a2d\u5b9a\u306bomniauth\u3092\u8ffd\u52a0\u3059\u308b\u305c\n\napp/models/user.rb\nclass User < ActiveRecord::Base\n  # Include default devise modules. Others available are:\n  # :confirmable, :lockable, :timeoutable and :omniauthable\n  devise :database_authenticatable, :registerable, :recoverable,\n         :rememberable, :trackable, :validatable, :omniauthable\n\nend\n\n\n\n\u2466Routing\u3092\u5909\u66f4\u3059\u308b\n\nroutes.rb\n\nRails.application.routes.draw do\n\n  root 'home#index'\n  devise_for :users, :controllers => { omniauth_callbacks: 'users/omniauth_callbacks' }\n\nend\n\n\n\n\u30eb\u30fc\u30c8\u306e\u8a2d\u5b9a\u3068omniauth\u306erouting\u8a2d\u5b9a\u304c\u5927\u4e8b\n\n\u2467\u3058\u3083\u3042\u3001facebook\u30ed\u30b0\u30a4\u30f3\u7528\u306e\u30ea\u30f3\u30af\u3092view\u306b\u7528\u610f\u3057\u3088\u3046\u305c\n\napp/views/home.html.slim\n\nh1 Home#index\np Find me in app/views/home/index.html.slim\n\nh1\n  | Home#index\n  - if user_signed_in?\n    |  Logged in as\n    strong\n      = current_user.email\n    | .\n    = link_to \"Settings\", edit_user_registration_path, :class => \"navbar-link\"\n    |  |\n    = link_to \"Logout\", destroy_user_session_path, method: :delete, :class => \"navbar-link\"\n  - else\n    = link_to \"Sign up\", new_user_registration_path, :class => 'navbar-link'\n    |  |\n    = link_to \"Login\", new_user_session_path, :class => 'navbar-link'\n    |  |\n    = link_to \"Sign in with Facebook\", user_omniauth_authorize_path(:facebook)\n\n\n\n\n\u2468\u30ea\u30f3\u30af\u5148\u306eController\u3092\u5bfe\u5fdc\u3055\u305b\u3088\u3046\uff01\uff08\u30b4\u30fc\u30eb\u306f\u8fd1\u3044\uff09\n\napp/controllers/users/omniauth_callbacks_controller.rb\n\nclass Users::OmniauthCallbacksController < Devise::OmniauthCallbacksController\n\n  def facebook\n    callback_from :facebook\n  end\n\n  private\n  def callback_from(provider)\n    @user = User.find_for_oauth(request.env['omniauth.auth'])\n\n    if @user.persisted?\n      sign_in_and_redirect @user, :event => :authentication\n      set_flash_message(:notice, :success, :kind => provider.to_s) if is_navigational_format?\n    else\n      if provider.to_s == \"facebook\"\n        session[\"devise.facebook_data\"] = request.env[\"omniauth.auth\"]\n        redirect_to new_user_registration_url\n      end\n    end\n  end\nend\n\n\n\u6700\u5f8c\u306b\u3053\u306e\u30e1\u30bd\u30c3\u30c9\u3092User\u30e2\u30c7\u30eb\u306b\u5b9f\u88c5\u3057\u3088\u3046\uff01\nUser.find_for_oauth(request.env['omniauth.auth'])\n\n\u2469 find_for_oauth\u3092User\u30e2\u30c7\u30eb\u306b\u5b9f\u88c5\u3059\u308b\n\napp/models/user.rb\nclass User < ActiveRecord::Base\n  # Include default devise modules. Others available are:\n  # :confirmable, :lockable, :timeoutable and :omniauthable\n  devise :database_authenticatable, :registerable, :recoverable,\n         :rememberable, :trackable, :validatable, :omniauthable\n\n  def self.find_for_oauth(auth)\n    user = User.where(provider: auth.provider, uid: auth.uid).first\n\n    unless user\n      user = User.create( name:     auth.extra.raw_info.name,\n                          provider: auth.provider,\n                          uid:      auth.uid,\n                          email:    auth.info.email,\n                          token:    auth.credentials.token,\n                          password: Devise.friendly_token[0,20] )\n    end\n\n    return user\n  end\nend\n\n\n\u3053\u308c\u3067\u5b8c\u6210\uff01\uff01\uff01\uff01\uff01\uff01\uff01\uff01\uff01\uff01\uff01\n\u306a\u3001\u306f\u305a\uff01\n\u5e30\u3063\u305f\u3089\u78ba\u304b\u3081\u308b\u7b11\n\n\u53c2\u8003\u30ea\u30f3\u30af\n[Rails] devise\u306e\u4f7f\u3044\u65b9\nhttp://qiita.com/cigalecigales/items/73d7bd7ec59a001ccd74\ndevise \u3068 omniauth \u4f7f\u3063\u3066\u3001\u30aa\u30ea\u30b8\u30ca\u30eb\u30ed\u30b0\u30a4\u30f3\u30fbfacebook \u30ed\u30b0\u30a4\u30f3\u30fbtwitter \u30ed\u30b0\u30a4\u30f3\u3092\u5b9f\u88c5\u3059\u308b\u65b9\u6cd5\nhttp://abeyuusuke1978.hatenablog.com/entry/2015/01/03/235255\n\n\u6700\u901f\u30b7\u30ea\u30fc\u30ba\n\u3010\u6700\u901f\u30b7\u30ea\u30fc\u30ba\u3011\u6700\u901f\u3067Carrierwave\u3067\u753b\u50cf\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u307e\u3067\u4f5c\u308b\nhttp://qiita.com/funao/items/cd4c4e33cf43767338e2\n## \u2460Gemfile\u3092\u5909\u66f4\u3059\u308b\n```rb:Gemfile\ngem 'devise'\ngem 'omniauth'\ngem 'omniauth-facebook'\n```\n\u5909\u66f4\u3057\u305f\u3089`$ bundle install`\n## \u2461 devise\u306e\u8af8\u3005\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\n\n```rd\n$ bundle exec rails g devise:install\n$ bundle exec rails g devise User provider:string uid:string name:string token:string\n$ bundle exec rails g devise:controllers\n$ bundle exec rails g devise:views users\n$ bundle exec rails g controller home index\n```\n\u6700\u5f8c\u306eController\u306froot\u7528\u3067\u3059\u305c\n\n```\n$ rake db:create\n$ rake db:migrate\n```\n\u3082\u5fd8\u308c\u305a\u306b\uff01\n\n## \u2462 devise\u306e\u30c7\u30d5\u30a9\u30eb\u30c8\u306eURL\u3092\u5909\u66f4\n\n```rb:config/environments/development.rb\n\nRails.application.configure do\n  \n  ...\n\n  # mailer setting\n  config.action_mailer.default_url_options = { host: 'localhost', port: 3000 }\n\nend\n```\n## \u2463 facebook\u306eAPPID\u3068SECRET_KEY\u3092GET\u3059\u308b\n\n\u3053\u3053\u304b\u3089GET\u3057\u3066\u304f\u308c\u3088\u306a\uff01\nhttps://developers.facebook.com/\n\n## \u2464 \uff14\u3067\u53d6\u5f97\u3057\u305f\u3084\u3064\u3089\u3092config\u306b\u53cd\u6620\u3055\u305b\u308b\n\n```ruby:config/initializers/devise.rb\nrequire \"omniauth-facebook\"\nDevise.setup do |config|\n\n  ...\n\n  OpenSSL::SSL::VERIFY_PEER = OpenSSL::SSL::VERIFY_NONE if Rails.env.development? #\u3068\u308a\u3042\u3048\u305a\u30ed\u30fc\u30ab\u30eb\u3067\u52d5\u304f\u5974\u3064\u304f\u308b\u3088\uff01\n  config.omniauth :facebook, ENV['FACEBOOK_APP_ID'], ENV['FACEBOOK_APP_SECRET']  #dotenv-rails\u3068\u304b\u4f7f\u3063\u3066\u306d\uff01\n\nend\n```\n\nfacebook_app_id\u3068\u304b\u306fdotenv-rails\u3068\u304b\u3067\u7ba1\u7406\uff01\uff01\n\n## \u2465User\u30e2\u30c7\u30eb\u306edevise\u8a2d\u5b9a\u306bomniauth\u3092\u8ffd\u52a0\u3059\u308b\u305c\n\n```rb:app/models/user.rb\nclass User < ActiveRecord::Base\n  # Include default devise modules. Others available are:\n  # :confirmable, :lockable, :timeoutable and :omniauthable\n  devise :database_authenticatable, :registerable, :recoverable,\n         :rememberable, :trackable, :validatable, :omniauthable\n\nend\n```\n## \u2466Routing\u3092\u5909\u66f4\u3059\u308b\n\n```rb:routes.rb\n\nRails.application.routes.draw do\n\n  root 'home#index'\n  devise_for :users, :controllers => { omniauth_callbacks: 'users/omniauth_callbacks' }\n\nend\n\n```\n\n\u30eb\u30fc\u30c8\u306e\u8a2d\u5b9a\u3068omniauth\u306erouting\u8a2d\u5b9a\u304c\u5927\u4e8b\n\n## \u2467\u3058\u3083\u3042\u3001facebook\u30ed\u30b0\u30a4\u30f3\u7528\u306e\u30ea\u30f3\u30af\u3092view\u306b\u7528\u610f\u3057\u3088\u3046\u305c\n\n```slim:app/views/home.html.slim\n\nh1 Home#index\np Find me in app/views/home/index.html.slim\n\nh1\n  | Home#index\n  - if user_signed_in?\n    |  Logged in as\n    strong\n      = current_user.email\n    | .\n    = link_to \"Settings\", edit_user_registration_path, :class => \"navbar-link\"\n    |  |\n    = link_to \"Logout\", destroy_user_session_path, method: :delete, :class => \"navbar-link\"\n  - else\n    = link_to \"Sign up\", new_user_registration_path, :class => 'navbar-link'\n    |  |\n    = link_to \"Login\", new_user_session_path, :class => 'navbar-link'\n    |  |\n    = link_to \"Sign in with Facebook\", user_omniauth_authorize_path(:facebook)\n\n```\n\n## \u2468\u30ea\u30f3\u30af\u5148\u306eController\u3092\u5bfe\u5fdc\u3055\u305b\u3088\u3046\uff01\uff08\u30b4\u30fc\u30eb\u306f\u8fd1\u3044\uff09\n\n```rb:app/controllers/users/omniauth_callbacks_controller.rb\n\nclass Users::OmniauthCallbacksController < Devise::OmniauthCallbacksController\n\n  def facebook\n    callback_from :facebook\n  end\n\n  private\n  def callback_from(provider)\n    @user = User.find_for_oauth(request.env['omniauth.auth'])\n\n    if @user.persisted?\n      sign_in_and_redirect @user, :event => :authentication\n      set_flash_message(:notice, :success, :kind => provider.to_s) if is_navigational_format?\n    else\n      if provider.to_s == \"facebook\"\n        session[\"devise.facebook_data\"] = request.env[\"omniauth.auth\"]\n        redirect_to new_user_registration_url\n      end\n    end\n  end\nend\n```\n\n\u6700\u5f8c\u306b\u3053\u306e\u30e1\u30bd\u30c3\u30c9\u3092User\u30e2\u30c7\u30eb\u306b\u5b9f\u88c5\u3057\u3088\u3046\uff01\n`User.find_for_oauth(request.env['omniauth.auth'])`\n\n## \u2469 find_for_oauth\u3092User\u30e2\u30c7\u30eb\u306b\u5b9f\u88c5\u3059\u308b\n```rb:app/models/user.rb\nclass User < ActiveRecord::Base\n  # Include default devise modules. Others available are:\n  # :confirmable, :lockable, :timeoutable and :omniauthable\n  devise :database_authenticatable, :registerable, :recoverable,\n         :rememberable, :trackable, :validatable, :omniauthable\n\n  def self.find_for_oauth(auth)\n    user = User.where(provider: auth.provider, uid: auth.uid).first\n\n    unless user\n      user = User.create( name:     auth.extra.raw_info.name,\n                          provider: auth.provider,\n                          uid:      auth.uid,\n                          email:    auth.info.email,\n                          token:    auth.credentials.token,\n                          password: Devise.friendly_token[0,20] )\n    end\n\n    return user\n  end\nend\n```\n\n\n\u3053\u308c\u3067\u5b8c\u6210\uff01\uff01\uff01\uff01\uff01\uff01\uff01\uff01\uff01\uff01\uff01\n\u306a\u3001\u306f\u305a\uff01\n\u5e30\u3063\u305f\u3089\u78ba\u304b\u3081\u308b\u7b11\n\n## \u53c2\u8003\u30ea\u30f3\u30af\n[*Rails*] devise\u306e\u4f7f\u3044\u65b9\nhttp://qiita.com/cigalecigales/items/73d7bd7ec59a001ccd74\n\ndevise \u3068 omniauth \u4f7f\u3063\u3066\u3001\u30aa\u30ea\u30b8\u30ca\u30eb\u30ed\u30b0\u30a4\u30f3\u30fbfacebook \u30ed\u30b0\u30a4\u30f3\u30fbtwitter \u30ed\u30b0\u30a4\u30f3\u3092\u5b9f\u88c5\u3059\u308b\u65b9\u6cd5\nhttp://abeyuusuke1978.hatenablog.com/entry/2015/01/03/235255\n\n## \u6700\u901f\u30b7\u30ea\u30fc\u30ba\n\n\u3010\u6700\u901f\u30b7\u30ea\u30fc\u30ba\u3011\u6700\u901f\u3067Carrierwave\u3067\u753b\u50cf\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u307e\u3067\u4f5c\u308b\nhttp://qiita.com/funao/items/cd4c4e33cf43767338e2\n", "tags": ["Gem", "Rails", "devise", "Facebook", "\u65b0\u4eba\u30d7\u30ed\u30b0\u30e9\u30de\u5fdc\u63f4"]}