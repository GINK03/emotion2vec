{"context": "\n\n\u306f\u3058\u3081\u306b\n1\u5e74\u3050\u3089\u3044\u524d\u306b\u30d7\u30c3\u30b7\u30e5\u901a\u77e5\u3092\u5b9f\u88c5\u3057\u305f\u3068\u304d\u304b\u3089\u8a2d\u5b9a\u65b9\u6cd5\u304c\u82e5\u5e72\u5909\u308f\u3063\u3066\u3044\u305f\u306e\u3067\u3001\u3053\u306e\u8a18\u4e8b\u304c\u3044\u3064\u307e\u3067\u6709\u52b9\u304b\u306f\u308f\u304b\u308a\u307e\u305b\u3093\u304c\u3001Android\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u306e\u65b0\u898f\u4f5c\u6210\u304b\u3089\u30d7\u30c3\u30b7\u30e5\u901a\u77e5\u53d7\u4fe1\u78ba\u8a8d\u307e\u3067\u3092\u66f8\u3044\u3066\u304a\u3053\u3046\u3068\u601d\u3044\u307e\u3059\u3002\n\u3053\u306e\u8a18\u4e8b\u3092\u66f8\u3044\u3066\u3044\u308b\u6642\u70b9\u3067\u4f7f\u7528\u3057\u3066\u3044\u308bAndroid Studio\u30d0\u30fc\u30b8\u30e7\u30f3\u306f2.0\u3067\u3059\u3002\n\u3055\u3066\u3001\u6700\u521d\u306bAndroid Studio\u3067EmptyActivity\u3092\u6307\u5b9a\u3057\u3066\u3001PushNotificationSample\u3068\u3044\u3046\u540d\u524d\u306eNewProject\u3092\u4f5c\u6210\u3057\u3066\u304a\u304d\u307e\u3059\u3002\u305d\u306e\u524d\u63d0\u3067\u4ee5\u4e0b\u3001\u8a71\u3092\u9032\u3081\u3066\u3044\u304d\u307e\u3059\u3002\n\n\u30b5\u30f3\u30d7\u30eb\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u30ea\u30dd\u30b8\u30c8\u30ea\n\u5168\u4f53\u306e\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u306fkwmt/PushNotificationSample\u306b\u7f6e\u3044\u3066\u3044\u307e\u3059\u3002\n\nConfiguration\u30d5\u30a1\u30a4\u30eb(JSON\u30d5\u30a1\u30a4\u30eb)\u3092\u6e96\u5099\u3059\u308b\nAdd Google Services\n\u306b\u30a2\u30af\u30bb\u30b9\u3057\u3066\u3001Configuration file\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n\u4f5c\u6210\u3057\u305fgoogle-services.json\u3092app/\u306e\u76f4\u4e0b\u306b\u7f6e\u304d\u307e\u3059\u3002\n\u203bFlavor\u6bce\u306b\u7570\u306a\u3063\u305fgoogle-services.json\u3092\u4f7f\u3044\u305f\u3044\u5834\u5408\u306f\u3001 google-services:2.0.0-bata3\u304b\u3089\u3067\u304d\u305d\u3046\u3068\u3044\u3046\u8a71\u304c\u3042\u3063\u305f\u304c\u3001\u5b9f\u969b\u52d5\u304b\u306a\u3044\u3089\u3057\u3044\u306e\u3067\u3001beta\u3068\u308c\u308b\u306e\u5f85\u3064\u3057\u304b\u306a\u306e\u304b\u306a\u3041\u3002\n\u2192 2.1.0-beta1\u3067\u51fa\u6765\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3057\u305f\u3002(2016/04/18\u8ffd\u8a18)\n\u203bgoogle-services-gcm\u3092\u8ffd\u52a0\u3057\u305f\u3042\u3068\u3001gradle\u3092sync\u3059\u308b\u6642\u306bgoogle-services.json\u30d5\u30a1\u30a4\u30eb\u304c\u306a\u3044\u3068\u3001\u305f\u3068\u3048\u3070Build Variant\u3092debug\u306b\u6307\u5b9a\u3057\u3066\u3044\u308b\u3068\u304d\u306f\u3001\u4e0b\u8a18\u306e\u3088\u3046\u306a\u30a8\u30e9\u30fc\u304c\u51fa\u307e\u3059\u306e\u3067\u3054\u6ce8\u610f\u4e0b\u3055\u3044\u3002\nError:Execution failed for task ':app:processDebugGoogleServices'.\n> File google-services.json is missing. The Google Services Plugin cannot function without it.\n   Searched Location:\n  PushNotificationSample/app/src/debug/google-services.json\n  PushNotificationSample/app/google-services.json\n\n\nbuild.gradle\u3092\u7de8\u96c6\n\ngoogle-services\u3092\u8ffd\u52a0\u3059\u308b\n\n\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u30c8\u30c3\u30d7\u306ebuild.gradle\u3092\u7de8\u96c6\u3057\u307e\u3059\u3002\n--- a/build.gradle\n+++ b/build.gradle\n@@ -5,8 +5,9 @@ buildscript {\n         jcenter()\n     }\n     dependencies {\n-        classpath 'com.android.tools.build:gradle:1.5.0'\n-\n+        classpath 'com.android.tools.build:gradle:2.1.0-beta1'\n+        // https://develop  ers.google.com/cloud-messaging/android/client\n+        classpath 'com.google.gms:google-services:2.1.0-beta1'\n         // NOTE: Do not place your application dependencies here; they belong\n         // in the individual module build.gradle files\n     }\n\nGradle\u30d0\u30fc\u30b8\u30e7\u30f32.10\u304c\u5fc5\u8981\u3067\u3059\u304c\u3001Android Studio2.0\u3067\u3042\u308c\u3070\u3059\u3067\u306b\u4f7f\u3046\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002\n\napp/build.gradle\u3092\u7de8\u96c6\u3057\u307e\u3059\ndependencies\u306bplay-services-gcm\u3092\u8ffd\u52a0\u3057\u3001\u6700\u4e0b\u90e8\u306bapply plugin\u3092\u8a18\u5165\u3057\u307e\u3059\u3002\nplay-services\u306b\u3057\u3066\u306a\u3044\u306e\u306f\u300165k method limit\u5bfe\u7b56\u3067\u3059\u3002\n\u305f\u3060\u3067\u3055\u3048\u30e9\u30a4\u30d6\u30e9\u30ea\u3092\u305f\u304f\u3055\u3093\u4f7f\u7528\u3059\u308b\u306e\u3067\u3001\u4f59\u8a08\u306a\u30e9\u30a4\u30d6\u30e9\u30ea\u3092\u5165\u308c\u305f\u304f\u306a\u3044\u305f\u3081\u3067\u3059\u3002\n--- a/app/build.gradle\n+++ b/app/build.gradle\n@@ -23,4 +23,7 @@ dependencies {\n     compile fileTree(dir: 'libs', include: ['*.jar'])\n     testCompile 'junit:junit:4.12'\n     compile 'com.android.support:appcompat-v7:23.1.1'\n+    compile 'com.google.android.gms:play-services-gcm:8.4.0'\n }\n+\n+apply plugin: 'com.google.gms.google-services'\n\\ No newline at end of file\n\n\nAndroidManifest\u3092\u7de8\u96c6\n\n\u30d1\u30fc\u30df\u30c3\u30b7\u30e7\u30f3\u3092\u8ffd\u52a0\n\n${applicationId}.permission.C2D_MESSAGE\u306f\u3001\u4ed6\u306eAndroid\u30a2\u30d7\u30ea\u304b\u3089\u306e\u9001\u4fe1\u3084\u53d7\u4fe1\u304c\u3067\u304d\u306a\u3044\u3088\u3046\u306b\u3059\u308b\u30d1\u30fc\u30df\u30c3\u30b7\u30e7\u30f3\u3067\u3059\u3002${applicationId}\u3068\u3057\u3066\u3044\u308b\u306e\u306f\u3001\u3053\u308c\u306fapp/build.gradle\u306b\u8a18\u8f09\u3057\u3066\u3044\u308b\u30d1\u30c3\u30b1\u30fc\u30b8\u540d\u306b\u306a\u308a\u307e\u3059\u304c\u3001\u958b\u767a\u7528\u306e\u30d1\u30c3\u30b1\u30fc\u30b8\u540d\u306bapplicationIdSuffix\u3092\u3064\u3051\u305f\u308a\u3059\u308b\u306e\u3067\u3001${applicationId}\u3068\u3059\u308c\u3070\u76f4\u306b\u66f8\u304d\u63db\u3048\u306a\u304f\u3066\u826f\u3044\u306e\u3067\u697d\u306b\u306a\u308b\u304b\u3089\u3067\u3059\u3002\nWAKE_LOCK\u30d1\u30fc\u30df\u30c3\u30b7\u30e7\u30f3\u306f\u3001\u30aa\u30d7\u30b7\u30e7\u30f3\u3067\u4ed8\u3051\u3066\u3082\u4ed8\u3051\u306a\u304f\u3066\u3082\u826f\u3044\u3067\u3059\u3002\u8a73\u7d30\u306f Techbooster\u3055\u3093\u306e\u8a18\u4e8bWAKELOCK\u3092\u53d6\u5f97\u3057\u3001SLEEP\u72b6\u614b\u304b\u3089WAKE\u72b6\u614b\u3078\u9077\u79fb\u3059\u308b\u306a\u3069\u3092\u53c2\u8003\u306b\u3059\u308b\u3068\u3088\u3044\u3068\u601d\u3044\u307e\u3059\u3000\u3002\n\n--- a/app/src/main/AndroidManifest.xml\n+++ b/app/src/main/AndroidManifest.xml\n@@ -2,6 +2,19 @@\n <manifest package=\"net.kwmt27.pushnotificationsample\"\n           xmlns:android=\"http://schemas.android.com/apk/res/android\">\n\n+    <uses-permission android:name=\"android.permission.INTERNET\"/>\n+\n+    <!-- GCM permission -->\n+    <!--\n+        Android: Is it possible to read package name inside AndroidManifest.xml file\n+        http://stackoverflow.com/a/25186503\n+    -->\n+    <permission android:name=\"${applicationId}.permission.C2D_MESSAGE\"\n+                android:protectionLevel=\"signature\" />\n+    <uses-permission android:name=\"${applicationId}.permission.C2D_MESSAGE\"/>\n+    <uses-permission android:name=\"android.permission.WAKE_LOCK\" />\n+\n+\n     <application\n         android:allowBackup=\"true\"\n         android:icon=\"@mipmap/ic_launcher\"\n\n\n\u5fc5\u8981\u306a\u30af\u30e9\u30b9\u3092\u5ba3\u8a00\u3057\u307e\u3059\napplication\u30bf\u30b0\u306e\u4e2d\u306b\u4e0b\u8a18\u3092\u5ba3\u8a00\u3057\u307e\u3059\u3002\nGCM\u304b\u3089\u30a2\u30d7\u30ea\u306b\u9001\u3063\u305f\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u6271\u3046GcmReceiver\u3001\nRegitrationToken\u3092\u53d6\u5f97\u3068\u7aef\u672b\u500b\u5225\u60c5\u5831\u767b\u9332\u306e\u62c5\u5f53\u3059\u308bRegistrationIntentService\u3001\nRegistration token\u304c\u66f4\u65b0\u3055\u308c\u305f\u3068\u304d\u306e\u51e6\u7406\u3092\u62c5\u5f53\u3059\u308bInstanceIDListenerService\u3001\nPush\u53d7\u4fe1\u6642\u306e\u51e6\u7406\u3092\u62c5\u5f53\u3059\u308b(\u5b9f\u969b\u306bPush\u901a\u77e5\u3092\u53d7\u3051\u53d6\u3063\u3066\u304b\u3089\u306e\u51e6\u7406\u3092\u62c5\u5f53\u3059\u308b)GcmListenerService\u3002\n\u307e\u305f\u3001Android4.4KitKat\u4ee5\u524d\u3092\u30b5\u30dd\u30fc\u30c8\u3057\u305f\u3044\u5834\u5408\u306f\u3001GcmReceiver\u306bREGISTRATION\u30d1\u30fc\u30df\u30c3\u30b7\u30e7\u30f3\u3092\u4ed8\u3051\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n--- a/app/src/main/AndroidManifest.xml\n+++ b/app/src/main/AndroidManifest.xml\n@@ -15,6 +28,51 @@\n                 <category android:name=\"android.intent.category.LAUNCHER\"/>\n             </intent-filter>\n         </activity>\n+\n+        <!-- GCM receiver -->\n+        <receiver\n+            android:name=\"com.google.android.gms.gcm.GcmReceiver\"\n+            android:exported=\"true\"\n+            android:permission=\"com.google.android.c2dm.permission.SEND\" >\n+            <intent-filter>\n+                <action android:name=\"com.google.android.c2dm.intent.RECEIVE\" />\n+\n+                <!--\n+                    If you want to support pre-4.4 KitKat devices, add the following action to the intent filter declaration for the receiver:\n+                    <action android:name=\"com.google.android.c2dm.intent.REGISTRATION\" />\n+                    https://developers.google.com/cloud-messaging/android/client#manifest\n+                -->\n+                <action android:name=\"com.google.android.c2dm.intent.REGISTRATION\" />\n+                <category android:name=\"${applicationId}\" />\n+            </intent-filter>\n+        </receiver>\n+\n+        <service\n+            android:name=\".RegistrationIntentService\"\n+            android:exported=\"false\">\n+            <intent-filter>\n+                <action android:name=\"com.google.android.gms.iid.InstanceID\"/>\n+            </intent-filter>\n+        </service>\n+\n+        <!-- GCM Listener -->\n+        <service\n+            android:name=\".MyGcmListenerService\"\n+            android:exported=\"false\" >\n+            <intent-filter>\n+                <action android:name=\"com.google.android.c2dm.intent.RECEIVE\" />\n+            </intent-filter>\n+        </service>\n+\n+        <!-- GCM InstanceId listener -->\n+        <service\n+            android:name=\".MyInstanceIDListenerService\"\n+            android:exported=\"false\">\n+            <intent-filter>\n+                <action android:name=\"com.google.android.gms.iid.InstanceID\"/>\n+            </intent-filter>\n+        </service>\n+\n     </application>\n\n </manifest>\n\n\n\u5ba3\u8a00\u3057\u305f\u30af\u30e9\u30b9\u3092\u4f5c\u6210\u3057\u307e\u3059\nIntentService\u3092\u7d99\u627f\u3057\u305fRegistrationIntentService\u3001GcmListenerService\u3092\u7d99\u627f\u3057\u305fMyGcmListenerService\u3001InstanceIDListenerService\u3092\u7d99\u627f\u3057\u305fMyInstanceIDListenerService\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\u4ee5\u4e0b\u306f\u57fa\u672c\u7684\u306b\u3001google\u306esample\u3092\u53c2\u8003\u306b\u3057\u3066\u3044\u307e\u3059\u3002\n\nRegistrationIntentService.java\nRegistrationIntentService\u306f\u3001Google\u306eGCM\u30b3\u30cd\u30af\u30b7\u30e7\u30f3\u30b5\u30fc\u30d0\u30fc\u304b\u3089Registration Token\u3092\u53d7\u3051\u53d6\u3063\u3066\u3001\u81ea\u5206\u306e\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u306e\u30d7\u30c3\u30b7\u30e5\u901a\u77e5\u306e\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u9001\u4fe1\u3059\u308bAPI\u30b5\u30fc\u30d0\u30fc\u306a\u3069\u306bRegistration Token\u3092\u9001\u4fe1\u3059\u308b\u306e\u3092\u62c5\u5f53\u3057\u307e\u3059\u3002\nRegistration Token\u3092\u53d7\u3051\u53d6\u308b\u306b\u306f instanceID.getToken(SENDER_ID)\u3092\u4f7f\u7528\u3057\u307e\u3059\u3002SENDER_ID\u306fstring\u30ea\u30bd\u30fc\u30b9IDR.string.gcm_defaultSenderId\u3092\u6307\u5b9a\u3057\u3066\u3044\u307e\u3059\u304c\u3001google-services.json\u304b\u3089\u53d6\u5f97\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u3001gcm_defaultSenderId\u3092\u81ea\u5206\u3067\u8ffd\u52a0\u3059\u308b\u5fc5\u8981\u306f\u3042\u308a\u307e\u305b\u3093\u3002\nInstanceID instanceID = InstanceID.getInstance(this);\nString token = instanceID.getToken(getString(R.string.gcm_defaultSenderId),\n        GoogleCloudMessaging.INSTANCE_ID_SCOPE, null);\nsendRegistrationToServer(token);\n\nsendRegistrationToServer\u30e1\u30bd\u30c3\u30c9\u306fprivate\u3067\u3001\u81ea\u5206\u306eAPI\u30b5\u30fc\u30d0\u30fc\u306bRegistration Token\u3092\u767b\u9332\u3057\u3001\u767b\u9332\u5b8c\u4e86\u3057\u305f\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u3067Preferece\u306b\u3001\u201dRegistration Token\u3092\u30b5\u30fc\u30d0\u30fc\u306b\u767b\u9332\u3057\u305f\"\u3068\u3044\u3046\u60c5\u5831\u3092\u4fdd\u5b58\u3057\u3066\u3044\u307e\u3059\u3002\n\u30a2\u30d7\u30ea\u8d77\u52d5\u6642\u306b\u547c\u3070\u308c\u308b\u3053\u3068\u306b\u306a\u308b\u305f\u3081\u3001MainActivity\u3067startService\u3057\u307e\u3059\u3002\n\nMyInstanceIDListenerService.java\nInstanceIDListenerService\u3092\u7d99\u627f\u3057\u305fMyInstanceIDListenerService#onTokenRefresh\u30e1\u30bd\u30c3\u30c9\u306f\u3001Registration token\u304c\u66f4\u65b0\u3055\u308c\u305f\u6642\u306b\u547c\u3070\u308c\u307e\u3059\u3002\u66f4\u65b0\u3055\u308c\u308b\u3068API\u30b5\u30fc\u30d0\u30fc\u3082\u66f4\u65b0\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u305f\u3081\u3001onTokenRefresh\u30e1\u30bd\u30c3\u30c9\u5185\u3067Registration Token\u3092\u53d7\u3051\u53d6\u3063\u3066API\u30b5\u30fc\u30d0\u30fc\u306b\u767b\u9332\u3059\u308bRegistrationIntentService\u3092startService\u3057\u3066\u3044\u307e\u3059\u3002\nIntent intent = new Intent(this, RegistrationIntentService.class);\nstartService(intent);\n\n\u3061\u306a\u307f\u306b\u3001\u3053\u306e\u3068\u304dRegistrationIntentService\u306f\u3059\u3067\u306bstart\u3057\u3066\u3044\u307e\u3059\u304c\u3001startService\u306f\u30cd\u30b9\u30c8\u3057\u306a\u3044(\u3064\u307e\u308a\u52d5\u3044\u3066\u308b\u30b5\u30fc\u30d3\u30b9\u306f\u30b9\u30c8\u30c3\u30d7\u3057\u3066\u304b\u3089start\u3059\u308b)\u306e\u3067\u3001\u8907\u6570\u30b5\u30fc\u30d3\u30b9\u306fstart\u3055\u308c\u307e\u305b\u3093\u306e\u3067\u5b89\u5fc3\u3067\u3059\u3002\n\nMyGcmListenerService.java\n\u4ee5\u4e0a\u3067\u30d7\u30c3\u30b7\u30e5\u901a\u77e5\u3092\u53d7\u3051\u53d6\u308b\u8a2d\u5b9a\u304c\u3067\u304d\u305f\u611f\u3058\u3067\u3001\u3042\u3068\u306f\u5b9f\u969b\u306b\u30d7\u30c3\u30b7\u30e5\u901a\u77e5\u3092\u53d7\u3051\u3066\u3069\u3046\u3059\u308b\u304b\u306e\u51e6\u7406\u304c\u5fc5\u8981\u3067\u3059\u3002\u305d\u308c\u306fGcmListenerService\u3092\u7d99\u627f\u3057\u305fMyGcmListenerService\u304c\u62c5\u5f53\u3057\u3001\u30d7\u30c3\u30b7\u30e5\u901a\u77e5\u304c\u6765\u305f\u3089onMessageReceived\u30e1\u30bd\u30c3\u30c9\u304c\u547c\u3070\u308c\u307e\u3059\u3002\n@Override\npublic void onMessageReceived(String from, Bundle data) {\n    String message = data.getString(\"message\");\n    sendNotification(message);\n}\n\ndata.getString(\"message\")\u3067\u6307\u5b9a\u3057\u3066\u3044\u308bmessage\u306e\u30ad\u30fc\u306f\u30d7\u30c3\u30b7\u30e5\u901a\u77e5\u3092\u9001\u308b\u30b5\u30fc\u30d0\u30fc\u3068\u30a4\u30f3\u30bf\u30fc\u30d5\u30a7\u30fc\u30b9\u3092\u6c7a\u3081\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\nsendNotification\u30e1\u30bd\u30c3\u30c9\u306fprivate\u3067\u3001Notification\u306b\u8868\u793a\u3057\u3066\u3044\u307e\u3059\u3002\n\n\u30d7\u30c3\u30b7\u30e5\u901a\u77e5\u306e\u53d7\u4fe1\u78ba\u8a8d\n\u4ee5\u4e0a\u3067\u57fa\u672c\u7684\u306a\u30d7\u30c3\u30b7\u30e5\u901a\u77e5\u306e\u8a2d\u5b9a\u306f\u5b8c\u4e86\u3067\u3059\u306e\u3067\u3001\u901a\u77e5\u304c\u53d7\u4fe1\u3067\u304d\u308b\u304b\u78ba\u8a8d\u3057\u3066\u307f\u307e\u3059\u3002\n\u30d7\u30c3\u30b7\u30e5\u901a\u77e5\u306e\u9001\u4fe1\u30b5\u30fc\u30d0\u30fc\u3092\u66f8\u304f\u306e\u3082\u3044\u3044\u3067\u3059\u304c\u3001\u4ee5\u4e0b\u306ecurl\u3067\u3082\u78ba\u8a8d\u3067\u304d\u307e\u3059\u3002\ncurl --header \"Authorization: key=<Server API Key>\" --header Content-Type:\"application/json\" https://android.googleapis.com/gcm/send -d \"{\\\"registration_ids\\\":[\\\"<Registration Token>\\\"],\\\"data\\\":{\\\"message\\\":\\\"Hello\\\"}}\"\n\n\n\u901a\u77e5\u30d0\u30fc\u306bHello\u3068\u3044\u3046\u30e1\u30c3\u30bb\u30fc\u30b8\u304c\u8868\u793a\u3055\u308c\u305f\u3089\u6210\u529f\u3067\u3059\u3002\n\nPlayServices\u306e\u30c1\u30a7\u30c3\u30af\n\u30d7\u30c3\u30b7\u30e5\u901a\u77e5\u8a2d\u5b9a\u306e\u6700\u5f8c\u306b\u3001GCM\u306fGooglePlayServices\u30e9\u30a4\u30d6\u30e9\u30ea\u306b\u4f9d\u5b58\u3057\u3066\u3044\u3066\u3001\u3053\u306e\u30e9\u30a4\u30d6\u30e9\u30ea\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u304c\u53e4\u304b\u3063\u305f\u308a\u3059\u308b\u3068\u6b63\u3057\u304f\u30d7\u30c3\u30b7\u30e5\u901a\u77e5\u304c\u53d7\u4fe1\u3067\u304d\u306a\u3044\u306a\u3069\u306e\u4e0d\u5177\u5408\u3092\u751f\u3080\u53ef\u80fd\u6027\u304c\u3042\u308a\u307e\u3059\u306e\u3067\u3001\u30d0\u30fc\u30b8\u30e7\u30f3\u30c1\u30a7\u30c3\u30af\u306f\u5fc5\u8981\u306b\u306a\u308b\u3067\u3057\u3087\u3046\u3002\nPlayServicesUtils\u3068\u3044\u3046\u30af\u30e9\u30b9\u306b\u30d0\u30fc\u30b8\u30e7\u30f3\u3092\u78ba\u8a8d\u3059\u308bcheckGooglePlayServices\u30e1\u30bd\u30c3\u30c9\u3092\u8a18\u8ff0\u3057\u3066\u3044\u307e\u3059\u3002\u3082\u3057\u30d0\u30fc\u30b8\u30e7\u30f3\u304c\u53e4\u304b\u3063\u305f\u308a\u3059\u308b\u3068\u3001\u66f4\u65b0\u3057\u3066\u304f\u3060\u3055\u3044\u7684\u306a\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u8868\u793a\u3057\u3066\u304f\u308c\u307e\u3059\u3002\u3053\u3053\u3067\u306f\u3001\u66f4\u65b0\u3055\u308c\u306a\u304b\u3063\u305f\u3089Activity\u3092\u7d42\u4e86\u3059\u308b\u3088\u3046\u306b\u3057\u3066\u3044\u307e\u3059\u3002\npublic static boolean checkGooglePlayServices(final Activity activity) {\n    GoogleApiAvailability apiAvailability = GoogleApiAvailability.getInstance();\n    final int resultCode = apiAvailability.isGooglePlayServicesAvailable(activity);\n    if (resultCode == ConnectionResult.SUCCESS){\n        return true;\n    }\n\n    apiAvailability.getErrorDialog(activity, resultCode, 0, new DialogInterface.OnCancelListener() {\n        @Override\n        public void onCancel(DialogInterface dialogInterface) {\n            activity.finish();\n        }\n    }).show();\n    return  false;\n}\n\n\u3053\u306e\u30c1\u30a7\u30c3\u30af\u3092\u5229\u7528\u3057\u3066\u3001\u30c1\u30a7\u30c3\u30afOK\u306a\u3089RegistrationIntentService\u3092\u958b\u59cb\u3059\u308b\u3088\u3046\u306bMainActivity\u3092\u7de8\u96c6\u3057\u307e\u3059\u3002\n-- a/app/src/main/java/net/kwmt27/pushnotificationsample/MainActivity.java\n+++ b/app/src/main/java/net/kwmt27/pushnotificationsample/MainActivity.java\n     protected void onCreate(Bundle savedInstanceState) {\n         super.onCreate(savedInstanceState);\n         setContentView(R.layout.activity_main);\n+        // GooglePlayServices\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u30c1\u30a7\u30c3\u30af\n+        if (PlayServicesUtils.checkGooglePlayServices(this)) {\n+            Intent intent = new Intent(this, RegistrationIntentService.class);\n+            startService(intent);\n+        }\n+    }\n+\n+    @Override\n+    protected void onResume() {\n+        super.onResume();\n+        // GooglePlayServices\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u30c1\u30a7\u30c3\u30af\n+        PlayServicesUtils.checkGooglePlayServices(this);\n     }\n }\n\n\n\u88dc\u8db3\n\u30d7\u30c3\u30b7\u30e5\u901a\u77e5\u306b\u95a2\u3057\u3066\u306f\u4ee5\u4e0a\u3067\u7d42\u308f\u308a\u3067\u3059\u3002\u305f\u3060\u3001Registration Token\u3092Server\u306b\u9001\u4fe1\u3057\u305f\u308a\u3001\u9001\u4fe1\u3057\u305f\u3053\u3068\u3092Preference\u306b\u4fdd\u5b58\u3057\u305f\u308a\u3057\u3066\u3044\u3066\u3001\u305d\u306e\u90e8\u5206\u3082\u5b9f\u88c5\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u306e\u3067\u3001\u305d\u306e\u90e8\u5206\u306b\u3064\u3044\u3066\u3082\u66f8\u3044\u3066\u304a\u304d\u307e\u3059\u3002\n\nRegistration Token\u3092Server\u306b\u9001\u4fe1\nRegistrationIntentService\u3067sendRegistrationToServer\u3068\u3044\u3046\u30e1\u30bd\u30c3\u30c9\u3092\u4f5c\u6210\u3057\u307e\u3057\u305f\u3002\u305d\u306e\u4e2d\u8eab\u306f\u3001HTTP\u901a\u4fe1\u3067\u81ea\u5206\u306e\u30b5\u30fc\u30d0\u30fc\u306bRegistration Token\u3092\u9001\u4fe1\u3059\u308b\u3068\u3044\u3046\u5185\u5bb9\u306b\u306a\u308a\u307e\u3059\u3002\n\u5b9f\u88c5\u65b9\u6cd5\u306fAsyncTask\u3092\u4f7f\u3063\u305f\u308a\u3001HTTP\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u30e9\u30a4\u30d6\u30e9\u30ea\u3092\u4f7f\u3063\u305f\u308a\u3044\u308d\u3044\u308d\u3042\u308a\u307e\u3059\u304c\u3001\u3053\u3053\u3067\u306f okhttp3\u3068\u3044\u3046HTTP\u30af\u30e9\u30a4\u30f3\u30c8\u30e9\u30a4\u30d6\u30e9\u30ea\u3092\u4f7f\u3044\u307e\u3057\u305f\u3002\nMVC\u3092\u60f3\u5b9a\u3057\u3066\u3044\u308b\u306e\u3067(MVP\u304c\u3088\u3055\u305d\u3046\u3068\u3044\u3046\u8a18\u4e8b\u3082\u3042\u308a\u307e\u3059\u304c)\u3001\u30e2\u30c7\u30eb\u304b\u3089\u30ea\u30af\u30a8\u30b9\u30c8\u3057\u307e\u3059\u3002HTTP\u30ea\u30af\u30a8\u30b9\u30c8\u90e8\u5206\u3092\u5171\u901a\u5316\u3057\u305f\u3044\u305f\u3081\u3001ApiRequest\u3068\u3044\u3046\u30e2\u30c7\u30eb\u306b\u5b9f\u969b\u306eHTTP\u30ea\u30af\u30a8\u30b9\u30c8\u51e6\u7406\u3092\u8a18\u8ff0\u3057\u3066\u3044\u307e\u3059\u3002\n\nPreference\u306b\u4fdd\u5b58\u3059\u308b\n\u307e\u305f\u3001Registration Token\u3092API\u30b5\u30fc\u30d0\u30fc\u306b\u9001\u4fe1\u3057\u305f\u304b\u3069\u3046\u304b\u3092Preference\u306b\u4fdd\u5b58\u3057\u307e\u3059\u306e\u3067\u3001\u4fdd\u5b58\u3059\u308b\u51e6\u7406\u3092GcmModel\u306b\u8a18\u8ff0\u3057\u3066\u3044\u307e\u3059\u3002\n\nDagger\n\u3053\u306e\u8a18\u4e8b\u306e\u30b5\u30f3\u30d7\u30eb\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u3067\u306f Dagger\u3082\u5c0e\u5165\u3057\u3066\u3044\u307e\u3059\u304c\u3001\u76f4\u63a5\u30d7\u30c3\u30b7\u30e5\u901a\u77e5\u306b\u306f\u95a2\u4fc2\u306a\u3044\u305f\u3081\u8aac\u660e\u306f\u7701\u7565\u3057\u307e\u3059\u3002\n\n\u53c2\u8003\n\nSet up a GCM Client App on Android\ngooglesamples/google-services\n\n\n# \u306f\u3058\u3081\u306b\n\n1\u5e74\u3050\u3089\u3044\u524d\u306b\u30d7\u30c3\u30b7\u30e5\u901a\u77e5\u3092\u5b9f\u88c5\u3057\u305f\u3068\u304d\u304b\u3089\u8a2d\u5b9a\u65b9\u6cd5\u304c\u82e5\u5e72\u5909\u308f\u3063\u3066\u3044\u305f\u306e\u3067\u3001\u3053\u306e\u8a18\u4e8b\u304c\u3044\u3064\u307e\u3067\u6709\u52b9\u304b\u306f\u308f\u304b\u308a\u307e\u305b\u3093\u304c\u3001Android\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u306e\u65b0\u898f\u4f5c\u6210\u304b\u3089\u30d7\u30c3\u30b7\u30e5\u901a\u77e5\u53d7\u4fe1\u78ba\u8a8d\u307e\u3067\u3092\u66f8\u3044\u3066\u304a\u3053\u3046\u3068\u601d\u3044\u307e\u3059\u3002\n\n\u3053\u306e\u8a18\u4e8b\u3092\u66f8\u3044\u3066\u3044\u308b\u6642\u70b9\u3067\u4f7f\u7528\u3057\u3066\u3044\u308bAndroid Studio\u30d0\u30fc\u30b8\u30e7\u30f3\u306f`2.0`\u3067\u3059\u3002\n\n\u3055\u3066\u3001\u6700\u521d\u306bAndroid Studio\u3067EmptyActivity\u3092\u6307\u5b9a\u3057\u3066\u3001PushNotificationSample\u3068\u3044\u3046\u540d\u524d\u306eNewProject\u3092\u4f5c\u6210\u3057\u3066\u304a\u304d\u307e\u3059\u3002\u305d\u306e\u524d\u63d0\u3067\u4ee5\u4e0b\u3001\u8a71\u3092\u9032\u3081\u3066\u3044\u304d\u307e\u3059\u3002\n\n\n## \u30b5\u30f3\u30d7\u30eb\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u30ea\u30dd\u30b8\u30c8\u30ea\n\n\u5168\u4f53\u306e\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u306f<a href=\"https://github.com/kwmt/PushNotificationSample\" target=_blank>kwmt/PushNotificationSample</a>\u306b\u7f6e\u3044\u3066\u3044\u307e\u3059\u3002\n\n\n\n\n# Configuration\u30d5\u30a1\u30a4\u30eb(JSON\u30d5\u30a1\u30a4\u30eb)\u3092\u6e96\u5099\u3059\u308b\n<a href=\"https://developers.google.com/mobile/add?platform=android&cntapi=gcm&cnturl=https:%2F%2Fdevelopers.google.com%2Fcloud-messaging%2Fandroid%2Fclient&cntlbl=Continue%20Adding%20GCM%20Support&%3Fconfigured%3Dtrue\" target=_blank>Add Google Services</a>\n\u306b\u30a2\u30af\u30bb\u30b9\u3057\u3066\u3001Configuration file\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n<img src=\"https://qiita-image-store.s3.amazonaws.com/0/22161/bb53c234-f2d1-4559-1b7c-b25be7bd9793.png\" width=\"396\" height=\"300\" >\n\n\u4f5c\u6210\u3057\u305fgoogle-services.json\u3092`app/`\u306e\u76f4\u4e0b\u306b\u7f6e\u304d\u307e\u3059\u3002\n\n\u203bFlavor\u6bce\u306b\u7570\u306a\u3063\u305fgoogle-services.json\u3092\u4f7f\u3044\u305f\u3044\u5834\u5408\u306f\u3001 <a href=\"https://github.com/googlesamples/google-services/issues/54#issuecomment-165824720\" target=_blank>google-services:2.0.0-bata3\u304b\u3089\u3067\u304d\u305d\u3046\u3068\u3044\u3046\u8a71\u304c\u3042\u3063\u305f</a>\u304c\u3001\u5b9f\u969b\u52d5\u304b\u306a\u3044\u3089\u3057\u3044\u306e\u3067\u3001beta\u3068\u308c\u308b\u306e\u5f85\u3064\u3057\u304b\u306a\u306e\u304b\u306a\u3041\u3002\n\u2192 <a href=\"https://github.com/googlesamples/google-services/issues/54#issuecomment-209564732\" target=_blank>2.1.0-beta1\u3067\u51fa\u6765\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3057\u305f\u3002</a>(2016/04/18\u8ffd\u8a18)\n\n\u203bgoogle-services-gcm\u3092\u8ffd\u52a0\u3057\u305f\u3042\u3068\u3001gradle\u3092sync\u3059\u308b\u6642\u306bgoogle-services.json\u30d5\u30a1\u30a4\u30eb\u304c\u306a\u3044\u3068\u3001\u305f\u3068\u3048\u3070Build Variant\u3092debug\u306b\u6307\u5b9a\u3057\u3066\u3044\u308b\u3068\u304d\u306f\u3001\u4e0b\u8a18\u306e\u3088\u3046\u306a\u30a8\u30e9\u30fc\u304c\u51fa\u307e\u3059\u306e\u3067\u3054\u6ce8\u610f\u4e0b\u3055\u3044\u3002\n\n```\nError:Execution failed for task ':app:processDebugGoogleServices'.\n> File google-services.json is missing. The Google Services Plugin cannot function without it.\n   Searched Location:\n  PushNotificationSample/app/src/debug/google-services.json\n  PushNotificationSample/app/google-services.json\n```\n\n# build.gradle\u3092\u7de8\u96c6\n\n## google-services\u3092\u8ffd\u52a0\u3059\u308b\n\n### \u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u30c8\u30c3\u30d7\u306e`build.gradle`\u3092\u7de8\u96c6\u3057\u307e\u3059\u3002\n\n```\n--- a/build.gradle\n+++ b/build.gradle\n@@ -5,8 +5,9 @@ buildscript {\n         jcenter()\n     }\n     dependencies {\n-        classpath 'com.android.tools.build:gradle:1.5.0'\n-\n+        classpath 'com.android.tools.build:gradle:2.1.0-beta1'\n+        // https://develop  ers.google.com/cloud-messaging/android/client\n+        classpath 'com.google.gms:google-services:2.1.0-beta1'\n         // NOTE: Do not place your application dependencies here; they belong\n         // in the individual module build.gradle files\n     }\n```\n\nGradle\u30d0\u30fc\u30b8\u30e7\u30f32.10\u304c\u5fc5\u8981\u3067\u3059\u304c\u3001Android Studio2.0\u3067\u3042\u308c\u3070\u3059\u3067\u306b\u4f7f\u3046\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002\n\n### `app/build.gradle`\u3092\u7de8\u96c6\u3057\u307e\u3059\n\n\n`dependencies`\u306b`play-services-gcm`\u3092\u8ffd\u52a0\u3057\u3001\u6700\u4e0b\u90e8\u306bapply plugin\u3092\u8a18\u5165\u3057\u307e\u3059\u3002\n`play-services`\u306b\u3057\u3066\u306a\u3044\u306e\u306f\u300165k method limit\u5bfe\u7b56\u3067\u3059\u3002\n\u305f\u3060\u3067\u3055\u3048\u30e9\u30a4\u30d6\u30e9\u30ea\u3092\u305f\u304f\u3055\u3093\u4f7f\u7528\u3059\u308b\u306e\u3067\u3001\u4f59\u8a08\u306a\u30e9\u30a4\u30d6\u30e9\u30ea\u3092\u5165\u308c\u305f\u304f\u306a\u3044\u305f\u3081\u3067\u3059\u3002\n\n```\n--- a/app/build.gradle\n+++ b/app/build.gradle\n@@ -23,4 +23,7 @@ dependencies {\n     compile fileTree(dir: 'libs', include: ['*.jar'])\n     testCompile 'junit:junit:4.12'\n     compile 'com.android.support:appcompat-v7:23.1.1'\n+    compile 'com.google.android.gms:play-services-gcm:8.4.0'\n }\n+\n+apply plugin: 'com.google.gms.google-services'\n\\ No newline at end of file\n```\n\n\n# AndroidManifest\u3092\u7de8\u96c6\n\n## \u30d1\u30fc\u30df\u30c3\u30b7\u30e7\u30f3\u3092\u8ffd\u52a0\n\n* `${applicationId}.permission.C2D_MESSAGE`\u306f\u3001\u4ed6\u306eAndroid\u30a2\u30d7\u30ea\u304b\u3089\u306e\u9001\u4fe1\u3084\u53d7\u4fe1\u304c\u3067\u304d\u306a\u3044\u3088\u3046\u306b\u3059\u308b\u30d1\u30fc\u30df\u30c3\u30b7\u30e7\u30f3\u3067\u3059\u3002`${applicationId}`\u3068\u3057\u3066\u3044\u308b\u306e\u306f\u3001\u3053\u308c\u306f`app/build.gradle`\u306b\u8a18\u8f09\u3057\u3066\u3044\u308b\u30d1\u30c3\u30b1\u30fc\u30b8\u540d\u306b\u306a\u308a\u307e\u3059\u304c\u3001\u958b\u767a\u7528\u306e\u30d1\u30c3\u30b1\u30fc\u30b8\u540d\u306b`applicationIdSuffix`\u3092\u3064\u3051\u305f\u308a\u3059\u308b\u306e\u3067\u3001`${applicationId}`\u3068\u3059\u308c\u3070\u76f4\u306b\u66f8\u304d\u63db\u3048\u306a\u304f\u3066\u826f\u3044\u306e\u3067\u697d\u306b\u306a\u308b\u304b\u3089\u3067\u3059\u3002\n\n* `WAKE_LOCK`\u30d1\u30fc\u30df\u30c3\u30b7\u30e7\u30f3\u306f\u3001\u30aa\u30d7\u30b7\u30e7\u30f3\u3067\u4ed8\u3051\u3066\u3082\u4ed8\u3051\u306a\u304f\u3066\u3082\u826f\u3044\u3067\u3059\u3002\u8a73\u7d30\u306f Techbooster\u3055\u3093\u306e\u8a18\u4e8b<a href=\"http://techbooster.org/android/application/4429/\" target=_blank>WAKELOCK\u3092\u53d6\u5f97\u3057\u3001SLEEP\u72b6\u614b\u304b\u3089WAKE\u72b6\u614b\u3078\u9077\u79fb\u3059\u308b</a>\u306a\u3069\u3092\u53c2\u8003\u306b\u3059\u308b\u3068\u3088\u3044\u3068\u601d\u3044\u307e\u3059\u3000\u3002\n\n\n```\n--- a/app/src/main/AndroidManifest.xml\n+++ b/app/src/main/AndroidManifest.xml\n@@ -2,6 +2,19 @@\n <manifest package=\"net.kwmt27.pushnotificationsample\"\n           xmlns:android=\"http://schemas.android.com/apk/res/android\">\n \n+    <uses-permission android:name=\"android.permission.INTERNET\"/>\n+\n+    <!-- GCM permission -->\n+    <!--\n+        Android: Is it possible to read package name inside AndroidManifest.xml file\n+        http://stackoverflow.com/a/25186503\n+    -->\n+    <permission android:name=\"${applicationId}.permission.C2D_MESSAGE\"\n+                android:protectionLevel=\"signature\" />\n+    <uses-permission android:name=\"${applicationId}.permission.C2D_MESSAGE\"/>\n+    <uses-permission android:name=\"android.permission.WAKE_LOCK\" />\n+\n+\n     <application\n         android:allowBackup=\"true\"\n         android:icon=\"@mipmap/ic_launcher\"\n```\n\n\n## \u5fc5\u8981\u306a\u30af\u30e9\u30b9\u3092\u5ba3\u8a00\u3057\u307e\u3059\n\n`application`\u30bf\u30b0\u306e\u4e2d\u306b\u4e0b\u8a18\u3092\u5ba3\u8a00\u3057\u307e\u3059\u3002\n\nGCM\u304b\u3089\u30a2\u30d7\u30ea\u306b\u9001\u3063\u305f\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u6271\u3046GcmReceiver\u3001\nRegitrationToken\u3092\u53d6\u5f97\u3068\u7aef\u672b\u500b\u5225\u60c5\u5831\u767b\u9332\u306e\u62c5\u5f53\u3059\u308bRegistrationIntentService\u3001\nRegistration token\u304c\u66f4\u65b0\u3055\u308c\u305f\u3068\u304d\u306e\u51e6\u7406\u3092\u62c5\u5f53\u3059\u308bInstanceIDListenerService\u3001\nPush\u53d7\u4fe1\u6642\u306e\u51e6\u7406\u3092\u62c5\u5f53\u3059\u308b(\u5b9f\u969b\u306bPush\u901a\u77e5\u3092\u53d7\u3051\u53d6\u3063\u3066\u304b\u3089\u306e\u51e6\u7406\u3092\u62c5\u5f53\u3059\u308b)GcmListenerService\u3002\n\n\u307e\u305f\u3001Android4.4KitKat\u4ee5\u524d\u3092\u30b5\u30dd\u30fc\u30c8\u3057\u305f\u3044\u5834\u5408\u306f\u3001GcmReceiver\u306bREGISTRATION\u30d1\u30fc\u30df\u30c3\u30b7\u30e7\u30f3\u3092\u4ed8\u3051\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\n\n```\n--- a/app/src/main/AndroidManifest.xml\n+++ b/app/src/main/AndroidManifest.xml\n@@ -15,6 +28,51 @@\n                 <category android:name=\"android.intent.category.LAUNCHER\"/>\n             </intent-filter>\n         </activity>\n+\n+        <!-- GCM receiver -->\n+        <receiver\n+            android:name=\"com.google.android.gms.gcm.GcmReceiver\"\n+            android:exported=\"true\"\n+            android:permission=\"com.google.android.c2dm.permission.SEND\" >\n+            <intent-filter>\n+                <action android:name=\"com.google.android.c2dm.intent.RECEIVE\" />\n+\n+                <!--\n+                    If you want to support pre-4.4 KitKat devices, add the following action to the intent filter declaration for the receiver:\n+                    <action android:name=\"com.google.android.c2dm.intent.REGISTRATION\" />\n+                    https://developers.google.com/cloud-messaging/android/client#manifest\n+                -->\n+                <action android:name=\"com.google.android.c2dm.intent.REGISTRATION\" />\n+                <category android:name=\"${applicationId}\" />\n+            </intent-filter>\n+        </receiver>\n+\n+        <service\n+            android:name=\".RegistrationIntentService\"\n+            android:exported=\"false\">\n+            <intent-filter>\n+                <action android:name=\"com.google.android.gms.iid.InstanceID\"/>\n+            </intent-filter>\n+        </service>\n+\n+        <!-- GCM Listener -->\n+        <service\n+            android:name=\".MyGcmListenerService\"\n+            android:exported=\"false\" >\n+            <intent-filter>\n+                <action android:name=\"com.google.android.c2dm.intent.RECEIVE\" />\n+            </intent-filter>\n+        </service>\n+\n+        <!-- GCM InstanceId listener -->\n+        <service\n+            android:name=\".MyInstanceIDListenerService\"\n+            android:exported=\"false\">\n+            <intent-filter>\n+                <action android:name=\"com.google.android.gms.iid.InstanceID\"/>\n+            </intent-filter>\n+        </service>\n+\n     </application>\n \n </manifest>\n```\n\n# \u5ba3\u8a00\u3057\u305f\u30af\u30e9\u30b9\u3092\u4f5c\u6210\u3057\u307e\u3059\n\nIntentService\u3092\u7d99\u627f\u3057\u305fRegistrationIntentService\u3001GcmListenerService\u3092\u7d99\u627f\u3057\u305fMyGcmListenerService\u3001InstanceIDListenerService\u3092\u7d99\u627f\u3057\u305fMyInstanceIDListenerService\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n\u4ee5\u4e0b\u306f\u57fa\u672c\u7684\u306b\u3001<a href=\"https://github.com/googlesamples/google-services/blob/master/android/gcm/app/src/main/java/gcm/play/android/samples/com/gcmquickstart/\" target=_blank>google\u306esample</a>\u3092\u53c2\u8003\u306b\u3057\u3066\u3044\u307e\u3059\u3002\n\n## RegistrationIntentService.java\n\nRegistrationIntentService\u306f\u3001Google\u306eGCM\u30b3\u30cd\u30af\u30b7\u30e7\u30f3\u30b5\u30fc\u30d0\u30fc\u304b\u3089Registration Token\u3092\u53d7\u3051\u53d6\u3063\u3066\u3001\u81ea\u5206\u306e\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u306e\u30d7\u30c3\u30b7\u30e5\u901a\u77e5\u306e\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u9001\u4fe1\u3059\u308bAPI\u30b5\u30fc\u30d0\u30fc\u306a\u3069\u306bRegistration Token\u3092\u9001\u4fe1\u3059\u308b\u306e\u3092\u62c5\u5f53\u3057\u307e\u3059\u3002\n\nRegistration Token\u3092\u53d7\u3051\u53d6\u308b\u306b\u306f `instanceID.getToken(SENDER_ID)`\u3092\u4f7f\u7528\u3057\u307e\u3059\u3002`SENDER_ID`\u306fstring\u30ea\u30bd\u30fc\u30b9ID`R.string.gcm_defaultSenderId`\u3092\u6307\u5b9a\u3057\u3066\u3044\u307e\u3059\u304c\u3001google-services.json\u304b\u3089\u53d6\u5f97\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u3001`gcm_defaultSenderId`\u3092\u81ea\u5206\u3067\u8ffd\u52a0\u3059\u308b\u5fc5\u8981\u306f\u3042\u308a\u307e\u305b\u3093\u3002\n\n```\nInstanceID instanceID = InstanceID.getInstance(this);\nString token = instanceID.getToken(getString(R.string.gcm_defaultSenderId),\n        GoogleCloudMessaging.INSTANCE_ID_SCOPE, null);\nsendRegistrationToServer(token);\n```\n\n`sendRegistrationToServer`\u30e1\u30bd\u30c3\u30c9\u306fprivate\u3067\u3001\u81ea\u5206\u306eAPI\u30b5\u30fc\u30d0\u30fc\u306bRegistration Token\u3092\u767b\u9332\u3057\u3001\u767b\u9332\u5b8c\u4e86\u3057\u305f\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u3067Preferece\u306b\u3001\u201dRegistration Token\u3092\u30b5\u30fc\u30d0\u30fc\u306b\u767b\u9332\u3057\u305f\"\u3068\u3044\u3046\u60c5\u5831\u3092\u4fdd\u5b58\u3057\u3066\u3044\u307e\u3059\u3002\n\n\u30a2\u30d7\u30ea\u8d77\u52d5\u6642\u306b\u547c\u3070\u308c\u308b\u3053\u3068\u306b\u306a\u308b\u305f\u3081\u3001`MainActivity`\u3067`startService`\u3057\u307e\u3059\u3002\n\n\n## MyInstanceIDListenerService.java\n\n`InstanceIDListenerService`\u3092\u7d99\u627f\u3057\u305f`MyInstanceIDListenerService#onTokenRefresh`\u30e1\u30bd\u30c3\u30c9\u306f\u3001Registration token\u304c\u66f4\u65b0\u3055\u308c\u305f\u6642\u306b\u547c\u3070\u308c\u307e\u3059\u3002\u66f4\u65b0\u3055\u308c\u308b\u3068API\u30b5\u30fc\u30d0\u30fc\u3082\u66f4\u65b0\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u305f\u3081\u3001`onTokenRefresh`\u30e1\u30bd\u30c3\u30c9\u5185\u3067Registration Token\u3092\u53d7\u3051\u53d6\u3063\u3066API\u30b5\u30fc\u30d0\u30fc\u306b\u767b\u9332\u3059\u308b`RegistrationIntentService`\u3092`startService`\u3057\u3066\u3044\u307e\u3059\u3002\n\n```\nIntent intent = new Intent(this, RegistrationIntentService.class);\nstartService(intent);\n```\n\n\u3061\u306a\u307f\u306b\u3001\u3053\u306e\u3068\u304d`RegistrationIntentService`\u306f\u3059\u3067\u306bstart\u3057\u3066\u3044\u307e\u3059\u304c\u3001<a href=\"http://developer.android.com/intl/ja/reference/android/app/Service.html#ServiceLifecycle\" target=_blans>`startService`\u306f\u30cd\u30b9\u30c8\u3057\u306a\u3044(\u3064\u307e\u308a\u52d5\u3044\u3066\u308b\u30b5\u30fc\u30d3\u30b9\u306f\u30b9\u30c8\u30c3\u30d7\u3057\u3066\u304b\u3089start\u3059\u308b)</a>\u306e\u3067\u3001\u8907\u6570\u30b5\u30fc\u30d3\u30b9\u306fstart\u3055\u308c\u307e\u305b\u3093\u306e\u3067\u5b89\u5fc3\u3067\u3059\u3002\n\n\n## MyGcmListenerService.java\n\n\u4ee5\u4e0a\u3067\u30d7\u30c3\u30b7\u30e5\u901a\u77e5\u3092\u53d7\u3051\u53d6\u308b\u8a2d\u5b9a\u304c\u3067\u304d\u305f\u611f\u3058\u3067\u3001\u3042\u3068\u306f\u5b9f\u969b\u306b\u30d7\u30c3\u30b7\u30e5\u901a\u77e5\u3092\u53d7\u3051\u3066\u3069\u3046\u3059\u308b\u304b\u306e\u51e6\u7406\u304c\u5fc5\u8981\u3067\u3059\u3002\u305d\u308c\u306f`GcmListenerService`\u3092\u7d99\u627f\u3057\u305f`MyGcmListenerService`\u304c\u62c5\u5f53\u3057\u3001\u30d7\u30c3\u30b7\u30e5\u901a\u77e5\u304c\u6765\u305f\u3089`onMessageReceived`\u30e1\u30bd\u30c3\u30c9\u304c\u547c\u3070\u308c\u307e\u3059\u3002\n\n\n```\n@Override\npublic void onMessageReceived(String from, Bundle data) {\n    String message = data.getString(\"message\");\n    sendNotification(message);\n}\n```\n\n`data.getString(\"message\")`\u3067\u6307\u5b9a\u3057\u3066\u3044\u308b`message`\u306e\u30ad\u30fc\u306f\u30d7\u30c3\u30b7\u30e5\u901a\u77e5\u3092\u9001\u308b\u30b5\u30fc\u30d0\u30fc\u3068\u30a4\u30f3\u30bf\u30fc\u30d5\u30a7\u30fc\u30b9\u3092\u6c7a\u3081\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n`sendNotification`\u30e1\u30bd\u30c3\u30c9\u306fprivate\u3067\u3001Notification\u306b\u8868\u793a\u3057\u3066\u3044\u307e\u3059\u3002\n\n# \u30d7\u30c3\u30b7\u30e5\u901a\u77e5\u306e\u53d7\u4fe1\u78ba\u8a8d\n\n\u4ee5\u4e0a\u3067\u57fa\u672c\u7684\u306a\u30d7\u30c3\u30b7\u30e5\u901a\u77e5\u306e\u8a2d\u5b9a\u306f\u5b8c\u4e86\u3067\u3059\u306e\u3067\u3001\u901a\u77e5\u304c\u53d7\u4fe1\u3067\u304d\u308b\u304b\u78ba\u8a8d\u3057\u3066\u307f\u307e\u3059\u3002\n\u30d7\u30c3\u30b7\u30e5\u901a\u77e5\u306e\u9001\u4fe1\u30b5\u30fc\u30d0\u30fc\u3092\u66f8\u304f\u306e\u3082\u3044\u3044\u3067\u3059\u304c\u3001\u4ee5\u4e0b\u306ecurl\u3067\u3082\u78ba\u8a8d\u3067\u304d\u307e\u3059\u3002\n\n```\ncurl --header \"Authorization: key=<Server API Key>\" --header Content-Type:\"application/json\" https://android.googleapis.com/gcm/send -d \"{\\\"registration_ids\\\":[\\\"<Registration Token>\\\"],\\\"data\\\":{\\\"message\\\":\\\"Hello\\\"}}\"\n```\n\n<img src=\"https://qiita-image-store.s3.amazonaws.com/0/22161/c907ad05-d00d-a1b7-35c0-bc2871ef0ca4.png\" >\n\n\u901a\u77e5\u30d0\u30fc\u306bHello\u3068\u3044\u3046\u30e1\u30c3\u30bb\u30fc\u30b8\u304c\u8868\u793a\u3055\u308c\u305f\u3089\u6210\u529f\u3067\u3059\u3002\n\n# PlayServices\u306e\u30c1\u30a7\u30c3\u30af\n\n\u30d7\u30c3\u30b7\u30e5\u901a\u77e5\u8a2d\u5b9a\u306e\u6700\u5f8c\u306b\u3001GCM\u306fGooglePlayServices\u30e9\u30a4\u30d6\u30e9\u30ea\u306b\u4f9d\u5b58\u3057\u3066\u3044\u3066\u3001\u3053\u306e\u30e9\u30a4\u30d6\u30e9\u30ea\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u304c\u53e4\u304b\u3063\u305f\u308a\u3059\u308b\u3068\u6b63\u3057\u304f\u30d7\u30c3\u30b7\u30e5\u901a\u77e5\u304c\u53d7\u4fe1\u3067\u304d\u306a\u3044\u306a\u3069\u306e\u4e0d\u5177\u5408\u3092\u751f\u3080\u53ef\u80fd\u6027\u304c\u3042\u308a\u307e\u3059\u306e\u3067\u3001\u30d0\u30fc\u30b8\u30e7\u30f3\u30c1\u30a7\u30c3\u30af\u306f\u5fc5\u8981\u306b\u306a\u308b\u3067\u3057\u3087\u3046\u3002\n`PlayServicesUtils`\u3068\u3044\u3046\u30af\u30e9\u30b9\u306b\u30d0\u30fc\u30b8\u30e7\u30f3\u3092\u78ba\u8a8d\u3059\u308b`checkGooglePlayServices`\u30e1\u30bd\u30c3\u30c9\u3092\u8a18\u8ff0\u3057\u3066\u3044\u307e\u3059\u3002\u3082\u3057\u30d0\u30fc\u30b8\u30e7\u30f3\u304c\u53e4\u304b\u3063\u305f\u308a\u3059\u308b\u3068\u3001\u66f4\u65b0\u3057\u3066\u304f\u3060\u3055\u3044\u7684\u306a\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u8868\u793a\u3057\u3066\u304f\u308c\u307e\u3059\u3002\u3053\u3053\u3067\u306f\u3001\u66f4\u65b0\u3055\u308c\u306a\u304b\u3063\u305f\u3089Activity\u3092\u7d42\u4e86\u3059\u308b\u3088\u3046\u306b\u3057\u3066\u3044\u307e\u3059\u3002\n\n```\npublic static boolean checkGooglePlayServices(final Activity activity) {\n    GoogleApiAvailability apiAvailability = GoogleApiAvailability.getInstance();\n    final int resultCode = apiAvailability.isGooglePlayServicesAvailable(activity);\n    if (resultCode == ConnectionResult.SUCCESS){\n        return true;\n    }\n\n    apiAvailability.getErrorDialog(activity, resultCode, 0, new DialogInterface.OnCancelListener() {\n        @Override\n        public void onCancel(DialogInterface dialogInterface) {\n            activity.finish();\n        }\n    }).show();\n    return  false;\n}\n```\n\n\u3053\u306e\u30c1\u30a7\u30c3\u30af\u3092\u5229\u7528\u3057\u3066\u3001\u30c1\u30a7\u30c3\u30afOK\u306a\u3089`RegistrationIntentService`\u3092\u958b\u59cb\u3059\u308b\u3088\u3046\u306b`MainActivity`\u3092\u7de8\u96c6\u3057\u307e\u3059\u3002\n\n```\n-- a/app/src/main/java/net/kwmt27/pushnotificationsample/MainActivity.java\n+++ b/app/src/main/java/net/kwmt27/pushnotificationsample/MainActivity.java\n     protected void onCreate(Bundle savedInstanceState) {\n         super.onCreate(savedInstanceState);\n         setContentView(R.layout.activity_main);\n+        // GooglePlayServices\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u30c1\u30a7\u30c3\u30af\n+        if (PlayServicesUtils.checkGooglePlayServices(this)) {\n+            Intent intent = new Intent(this, RegistrationIntentService.class);\n+            startService(intent);\n+        }\n+    }\n+\n+    @Override\n+    protected void onResume() {\n+        super.onResume();\n+        // GooglePlayServices\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u30c1\u30a7\u30c3\u30af\n+        PlayServicesUtils.checkGooglePlayServices(this);\n     }\n }\n```\n\n\n# \u88dc\u8db3\n\n\u30d7\u30c3\u30b7\u30e5\u901a\u77e5\u306b\u95a2\u3057\u3066\u306f\u4ee5\u4e0a\u3067\u7d42\u308f\u308a\u3067\u3059\u3002\u305f\u3060\u3001Registration Token\u3092Server\u306b\u9001\u4fe1\u3057\u305f\u308a\u3001\u9001\u4fe1\u3057\u305f\u3053\u3068\u3092Preference\u306b\u4fdd\u5b58\u3057\u305f\u308a\u3057\u3066\u3044\u3066\u3001\u305d\u306e\u90e8\u5206\u3082\u5b9f\u88c5\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u306e\u3067\u3001\u305d\u306e\u90e8\u5206\u306b\u3064\u3044\u3066\u3082\u66f8\u3044\u3066\u304a\u304d\u307e\u3059\u3002\n\n## Registration Token\u3092Server\u306b\u9001\u4fe1\n\n`RegistrationIntentService`\u3067`sendRegistrationToServer`\u3068\u3044\u3046\u30e1\u30bd\u30c3\u30c9\u3092\u4f5c\u6210\u3057\u307e\u3057\u305f\u3002\u305d\u306e\u4e2d\u8eab\u306f\u3001HTTP\u901a\u4fe1\u3067\u81ea\u5206\u306e\u30b5\u30fc\u30d0\u30fc\u306bRegistration Token\u3092\u9001\u4fe1\u3059\u308b\u3068\u3044\u3046\u5185\u5bb9\u306b\u306a\u308a\u307e\u3059\u3002\n\u5b9f\u88c5\u65b9\u6cd5\u306fAsyncTask\u3092\u4f7f\u3063\u305f\u308a\u3001HTTP\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u30e9\u30a4\u30d6\u30e9\u30ea\u3092\u4f7f\u3063\u305f\u308a\u3044\u308d\u3044\u308d\u3042\u308a\u307e\u3059\u304c\u3001\u3053\u3053\u3067\u306f <a href=\"http://square.github.io/okhttp/\" target=_blank>okhttp3</a>\u3068\u3044\u3046HTTP\u30af\u30e9\u30a4\u30f3\u30c8\u30e9\u30a4\u30d6\u30e9\u30ea\u3092\u4f7f\u3044\u307e\u3057\u305f\u3002\n\nMVC\u3092\u60f3\u5b9a\u3057\u3066\u3044\u308b\u306e\u3067(<a href=\"http://konifar.hatenablog.com/entry/2015/04/17/010606\" target=_blank>MVP\u304c\u3088\u3055\u305d\u3046\u3068\u3044\u3046\u8a18\u4e8b</a>\u3082\u3042\u308a\u307e\u3059\u304c)\u3001\u30e2\u30c7\u30eb\u304b\u3089\u30ea\u30af\u30a8\u30b9\u30c8\u3057\u307e\u3059\u3002HTTP\u30ea\u30af\u30a8\u30b9\u30c8\u90e8\u5206\u3092\u5171\u901a\u5316\u3057\u305f\u3044\u305f\u3081\u3001`ApiRequest`\u3068\u3044\u3046\u30e2\u30c7\u30eb\u306b\u5b9f\u969b\u306eHTTP\u30ea\u30af\u30a8\u30b9\u30c8\u51e6\u7406\u3092\u8a18\u8ff0\u3057\u3066\u3044\u307e\u3059\u3002\n\n\n## Preference\u306b\u4fdd\u5b58\u3059\u308b\n\n\u307e\u305f\u3001Registration Token\u3092API\u30b5\u30fc\u30d0\u30fc\u306b\u9001\u4fe1\u3057\u305f\u304b\u3069\u3046\u304b\u3092Preference\u306b\u4fdd\u5b58\u3057\u307e\u3059\u306e\u3067\u3001\u4fdd\u5b58\u3059\u308b\u51e6\u7406\u3092`GcmModel`\u306b\u8a18\u8ff0\u3057\u3066\u3044\u307e\u3059\u3002\n\n\n## Dagger\n\n\u3053\u306e\u8a18\u4e8b\u306e\u30b5\u30f3\u30d7\u30eb\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u3067\u306f <a href=\"http://square.github.io/dagger/\" target=_blank>Dagger</a>\u3082\u5c0e\u5165\u3057\u3066\u3044\u307e\u3059\u304c\u3001\u76f4\u63a5\u30d7\u30c3\u30b7\u30e5\u901a\u77e5\u306b\u306f\u95a2\u4fc2\u306a\u3044\u305f\u3081\u8aac\u660e\u306f\u7701\u7565\u3057\u307e\u3059\u3002\n\n# \u53c2\u8003\n* <a href=\"https://developers.google.com/cloud-messaging/android/client\" target=_blank>Set up a GCM Client App on Android</a>\n* <a href=\"https://github.com/googlesamples/google-services/tree/master/android/gcm\" target=_blank>googlesamples/google-services</a>\n", "tags": ["GCM", "Push\u901a\u77e5", "Android"]}