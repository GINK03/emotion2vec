{"context": " More than 1 year has passed since last update.\n\n\u306f\u3058\u3081\u306b\nHAProxy\u3067Percona XtraDB Cluster\u3078\u306e\u30a2\u30af\u30bb\u30b9\u3092\u5206\u6563\u3059\u308b\u65b9\u6cd5\u3092\u8a18\u8ff0\u3057\u307e\u3059\u3002\n\n\u74b0\u5883\n\nCentOS 6.7\nPercona XtraDB Cluster 5.6\nHAProxy 1.5.4\n\n\n\u30b5\u30fc\u30d0\u69cb\u6210\n\n\n\n\u30db\u30b9\u30c8\u540d\nIP\u30a2\u30c9\u30ec\u30b9\n\u5f79\u5272\n\n\n\n\npxclient\n192.168.33.11\nclient/proxy\n\n\npercona01\n192.168.33.21\ncluster node1\n\n\npercona02\n192.168.33.22\ncluster node2\n\n\npercona03\n192.168.33.23\ncluster node3\n\n\n\n\nPercona XtraDB Cluster\u306e\u69cb\u7bc9\nCentOS6.7\u306bPercona XtraDB Cluster\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u3092\u3054\u53c2\u7167\u304f\u3060\u3055\u3044\n\nclustercheck\u306e\u8a2d\u5b9a\n\nnode1\n\nclustercheck\u7528\u306e\u30e6\u30fc\u30b6\u4f5c\u6210\n$ mysql -u root -p\nEnter password:\nWelcome to the MySQL monitor.  Commands end with ; or \\g.\nYour MySQL connection id is 9\nServer version: 5.6.24-72.2-56 Percona XtraDB Cluster (GPL), Release rel72.2, Revision 1, WSREP version 25.11, wsrep_25.11\n\nCopyright (c) 2009-2015 Percona LLC and/or its affiliates\nCopyright (c) 2000, 2015, Oracle and/or its affiliates. All rights reserved.\n\nOracle is a registered trademark of Oracle Corporation and/or its\naffiliates. Other names may be trademarks of their respective\nowners.\n\nType 'help;' or '\\h' for help. Type '\\c' to clear the current input statement.\n\nmysql> grant process on *.* to 'clustercheckuser'@'localhost' identified by 'clustercheckpassword!';\nQuery OK, 0 rows affected (0.06 sec)\n\nmysql> flush privileges;\nQuery OK, 0 rows affected (0.03 sec)\n\nmysql> exit\nBye\n\nclustercheck\u306e\u52d5\u4f5c\u78ba\u8a8d\n$ clustercheck\nHTTP/1.1 200 OK\nContent-Type: text/plain\nConnection: close\nContent-Length: 40\n\nPercona XtraDB Cluster Node is synced.\n\n\nnode1 \u301c node3\n\nxinetd\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n$ sudo yum install xinetd\n\u8aad\u307f\u8fbc\u3093\u3060\u30d7\u30e9\u30b0\u30a4\u30f3:fastestmirror, security\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u51e6\u7406\u306e\u8a2d\u5b9a\u3092\u3057\u3066\u3044\u307e\u3059\nLoading mirror speeds from cached hostfile\nepel/metalink                                                                                                                         | 4.9 kB     00:00\n * base: ftp.riken.jp\n * epel: ftp.riken.jp\n * extras: ftp.riken.jp\n * updates: ftp.riken.jp\nbase                                                                                                                                  | 3.7 kB     00:00\nextras                                                                                                                                | 3.4 kB     00:00\npercona-release-noarch                                                                                                                |  951 B     00:00\npercona-release-noarch/primary                                                                                                        | 5.0 kB     00:00\npercona-release-noarch                                                                                                                                 33/33\npercona-release-x86_64                                                                                                                |  951 B     00:00\nupdates                                                                                                                               | 3.4 kB     00:00\n\u4f9d\u5b58\u6027\u306e\u89e3\u6c7a\u3092\u3057\u3066\u3044\u307e\u3059\n--> \u30c8\u30e9\u30f3\u30b6\u30af\u30b7\u30e7\u30f3\u306e\u78ba\u8a8d\u3092\u5b9f\u884c\u3057\u3066\u3044\u307e\u3059\u3002\n---> Package xinetd.x86_64 2:2.3.14-39.el6_4 will be \u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n--> \u4f9d\u5b58\u6027\u89e3\u6c7a\u3092\u7d42\u4e86\u3057\u307e\u3057\u305f\u3002\n\n\u4f9d\u5b58\u6027\u3092\u89e3\u6c7a\u3057\u307e\u3057\u305f\n\n=============================================================================================================================================================\n \u30d1\u30c3\u30b1\u30fc\u30b8                         \u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3                     \u30d0\u30fc\u30b8\u30e7\u30f3                                     \u30ea\u30dd\u30b8\u30c8\u30ea\u30fc                      \u5bb9\u91cf\n=============================================================================================================================================================\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3066\u3044\u307e\u3059:\n xinetd                             x86_64                             2:2.3.14-39.el6_4                              base                             121 k\n\n\u30c8\u30e9\u30f3\u30b6\u30af\u30b7\u30e7\u30f3\u306e\u8981\u7d04\n=============================================================================================================================================================\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb         1 \u30d1\u30c3\u30b1\u30fc\u30b8\n\n\u7dcf\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u5bb9\u91cf: 121 k\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u6e08\u307f\u5bb9\u91cf: 259 k\n\u3053\u308c\u3067\u3044\u3044\u3067\u3059\u304b? [y/N]y\n\u30d1\u30c3\u30b1\u30fc\u30b8\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u3066\u3044\u307e\u3059:\nxinetd-2.3.14-39.el6_4.x86_64.rpm                                                                                                     | 121 kB     00:00\nrpm_check_debug \u3092\u5b9f\u884c\u3057\u3066\u3044\u307e\u3059\n\u30c8\u30e9\u30f3\u30b6\u30af\u30b7\u30e7\u30f3\u306e\u30c6\u30b9\u30c8\u3092\u5b9f\u884c\u3057\u3066\u3044\u307e\u3059\n\u30c8\u30e9\u30f3\u30b6\u30af\u30b7\u30e7\u30f3\u306e\u30c6\u30b9\u30c8\u3092\u6210\u529f\u3057\u307e\u3057\u305f\n\u30c8\u30e9\u30f3\u30b6\u30af\u30b7\u30e7\u30f3\u3092\u5b9f\u884c\u3057\u3066\u3044\u307e\u3059\n  \u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3066\u3044\u307e\u3059  : 2:xinetd-2.3.14-39.el6_4.x86_64                                                                                              1/1\n  Verifying               : 2:xinetd-2.3.14-39.el6_4.x86_64                                                                                              1/1\n\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb:\n  xinetd.x86_64 2:2.3.14-39.el6_4\n\n\u5b8c\u4e86\u3057\u307e\u3057\u305f!\n\n/etc/xinetd.d/mysqlchk\n\n/etc/xinetd.d/mysqlchk\n# default: on\n# description: mysqlchk\nservice mysqlchk\n{\n# this is a config for xinetd, place it in /etc/xinetd.d/\n        disable = no\n        flags           = REUSE\n        socket_type     = stream\n        type            = UNLISTED\n        port            = 9200\n        wait            = no\n        user            = nobody\n        server          = /usr/bin/clustercheck\n        log_on_failure  += USERID\n        only_from       = 0.0.0.0/0\n        #\n        # Passing arguments to clustercheck\n        # <user> <pass> <available_when_donor=0|1> <log_file> <available_when_readonly=0|1> <defaults_extra_file>\"\n        # Recommended: server_args   = user pass 1 /var/log/log-file 0 /etc/my.cnf.local\"\n        # Compatibility: server_args = user pass 1 /var/log/log-file 1 /etc/my.cnf.local\"\n        # 55-to-56 upgrade: server_args = user pass 1 /var/log/log-file 0 /etc/my.cnf.extra\"\n        #\n        # recommended to put the IPs that need\n        # to connect exclusively (security purposes)\n        per_source      = UNLIMITED\n}\n\n\nxinetd\u306e\u8d77\u52d5\n$ sudo service xinetd start\n\nxinetd\u7d4c\u7531\u306eclustercheck\u306e\u52d5\u4f5c\u78ba\u8a8d\n$ curl http://127.0.0.1:9200/\nPercona XtraDB Cluster Node is synced.\n\nmysqlchk\u3092service\u3078\u767b\u9332\n$ sudo vim /etc/services\n(\u8ffd\u8a18)\nmysqlchk 9200/tcp # mysqlchk\n\n$ sudo vim /etc/services\n[vagrant@percona01 ~]$ sudo service xinetd restart\nxinetd \u3092\u505c\u6b62\u4e2d:                                           [  OK  ]\nxinetd \u3092\u8d77\u52d5\u4e2d:                                           [  OK  ]\n\n\nHAProxy\u306e\u8a2d\u5b9a\n\nHAProxy\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n$ sudo yum install haproxy\n\u8aad\u307f\u8fbc\u3093\u3060\u30d7\u30e9\u30b0\u30a4\u30f3:fastestmirror\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u51e6\u7406\u306e\u8a2d\u5b9a\u3092\u3057\u3066\u3044\u307e\u3059\nLoading mirror speeds from cached hostfile\n * base: www.ftp.ne.jp\n * epel: ftp.riken.jp\n * extras: ftp.nara.wide.ad.jp\n * updates: www.ftp.ne.jp\n\u4f9d\u5b58\u6027\u306e\u89e3\u6c7a\u3092\u3057\u3066\u3044\u307e\u3059\n--> \u30c8\u30e9\u30f3\u30b6\u30af\u30b7\u30e7\u30f3\u306e\u78ba\u8a8d\u3092\u5b9f\u884c\u3057\u3066\u3044\u307e\u3059\u3002\n---> Package haproxy.x86_64 0:1.5.4-2.el6_7.1 will be \u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n--> \u4f9d\u5b58\u6027\u89e3\u6c7a\u3092\u7d42\u4e86\u3057\u307e\u3057\u305f\u3002\n\n\u4f9d\u5b58\u6027\u3092\u89e3\u6c7a\u3057\u307e\u3057\u305f\n\n=============================================================================================================================================================\n \u30d1\u30c3\u30b1\u30fc\u30b8                         \u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3                    \u30d0\u30fc\u30b8\u30e7\u30f3                                    \u30ea\u30dd\u30b8\u30c8\u30ea\u30fc                        \u5bb9\u91cf\n=============================================================================================================================================================\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3066\u3044\u307e\u3059:\n haproxy                            x86_64                            1.5.4-2.el6_7.1                               updates                            792 k\n\n\u30c8\u30e9\u30f3\u30b6\u30af\u30b7\u30e7\u30f3\u306e\u8981\u7d04\n=============================================================================================================================================================\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb         1 \u30d1\u30c3\u30b1\u30fc\u30b8\n\n\u7dcf\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u5bb9\u91cf: 792 k\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u6e08\u307f\u5bb9\u91cf: 2.4 M\n\u3053\u308c\u3067\u3044\u3044\u3067\u3059\u304b? [y/N]y\n\u30d1\u30c3\u30b1\u30fc\u30b8\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u3066\u3044\u307e\u3059:\nhaproxy-1.5.4-2.el6_7.1.x86_64.rpm                                                                                                    | 792 kB     00:00\nrpm_check_debug \u3092\u5b9f\u884c\u3057\u3066\u3044\u307e\u3059\n\u30c8\u30e9\u30f3\u30b6\u30af\u30b7\u30e7\u30f3\u306e\u30c6\u30b9\u30c8\u3092\u5b9f\u884c\u3057\u3066\u3044\u307e\u3059\n\u30c8\u30e9\u30f3\u30b6\u30af\u30b7\u30e7\u30f3\u306e\u30c6\u30b9\u30c8\u3092\u6210\u529f\u3057\u307e\u3057\u305f\n\u30c8\u30e9\u30f3\u30b6\u30af\u30b7\u30e7\u30f3\u3092\u5b9f\u884c\u3057\u3066\u3044\u307e\u3059\n  \u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3066\u3044\u307e\u3059  : haproxy-1.5.4-2.el6_7.1.x86_64                                                                                               1/1\n  Verifying               : haproxy-1.5.4-2.el6_7.1.x86_64                                                                                               1/1\n\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb:\n  haproxy.x86_64 0:1.5.4-2.el6_7.1\n\n\u5b8c\u4e86\u3057\u307e\u3057\u305f!\n\n\nsocat\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n$ sudo yum instal socat\n\u8aad\u307f\u8fbc\u3093\u3060\u30d7\u30e9\u30b0\u30a4\u30f3:fastestmirror\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u51e6\u7406\u306e\u8a2d\u5b9a\u3092\u3057\u3066\u3044\u307e\u3059\nLoading mirror speeds from cached hostfile\n * base: www.ftp.ne.jp\n * epel: ftp.riken.jp\n * extras: ftp.nara.wide.ad.jp\n * updates: www.ftp.ne.jp\n\u4f9d\u5b58\u6027\u306e\u89e3\u6c7a\u3092\u3057\u3066\u3044\u307e\u3059\n--> \u30c8\u30e9\u30f3\u30b6\u30af\u30b7\u30e7\u30f3\u306e\u78ba\u8a8d\u3092\u5b9f\u884c\u3057\u3066\u3044\u307e\u3059\u3002\n---> Package socat.x86_64 0:1.7.2.3-1.el6 will be \u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n--> \u4f9d\u5b58\u6027\u306e\u51e6\u7406\u3092\u3057\u3066\u3044\u307e\u3059: libreadline.so.5()(64bit) \u306e\u30d1\u30c3\u30b1\u30fc\u30b8: socat-1.7.2.3-1.el6.x86_64\n--> \u30c8\u30e9\u30f3\u30b6\u30af\u30b7\u30e7\u30f3\u306e\u78ba\u8a8d\u3092\u5b9f\u884c\u3057\u3066\u3044\u307e\u3059\u3002\n---> Package compat-readline5.x86_64 0:5.2-17.1.el6 will be \u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n--> \u4f9d\u5b58\u6027\u89e3\u6c7a\u3092\u7d42\u4e86\u3057\u307e\u3057\u305f\u3002\n\n\n\n\u4f9d\u5b58\u6027\u3092\u89e3\u6c7a\u3057\u307e\u3057\u305f\n\n=============================================================================================================================================================\n \u30d1\u30c3\u30b1\u30fc\u30b8                                 \u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3                   \u30d0\u30fc\u30b8\u30e7\u30f3                                 \u30ea\u30dd\u30b8\u30c8\u30ea\u30fc                    \u5bb9\u91cf\n\n\nglobal\n=============================================================================================================================================================\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3066\u3044\u307e\u3059:\n socat                                      x86_64                           1.7.2.3-1.el6                              epel                           246 k\n\u4f9d\u5b58\u6027\u95a2\u9023\u3067\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3092\u3057\u307e\u3059\u3002:\n compat-readline5                           x86_64                           5.2-17.1.el6                               base                           130 k\n\n\u30c8\u30e9\u30f3\u30b6\u30af\u30b7\u30e7\u30f3\u306e\u8981\u7d04\n=============================================================================================================================================================\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb         2 \u30d1\u30c3\u30b1\u30fc\u30b8\n\n\u7dcf\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u5bb9\u91cf: 375 k\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u6e08\u307f\u5bb9\u91cf: 1.2 M\n\u3053\u308c\u3067\u3044\u3044\u3067\u3059\u304b? [y/N]y\n\u30d1\u30c3\u30b1\u30fc\u30b8\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u3066\u3044\u307e\u3059:\n(1/2): compat-readline5-5.2-17.1.el6.x86_64.rpm                                                                                       | 130 kB     00:00\n(2/2): socat-1.7.2.3-1.el6.x86_64.rpm                                                                                                 | 246 kB     00:00\n-------------------------------------------------------------------------------------------------------------------------------------------------------------\n\u5408\u8a08                                                                                                                         454 kB/s | 375 kB     00:00\nrpm_check_debug \u3092\u5b9f\u884c\u3057\u3066\u3044\u307e\u3059\n\u30c8\u30e9\u30f3\u30b6\u30af\u30b7\u30e7\u30f3\u306e\u30c6\u30b9\u30c8\u3092\u5b9f\u884c\u3057\u3066\u3044\u307e\u3059\n\u30c8\u30e9\u30f3\u30b6\u30af\u30b7\u30e7\u30f3\u306e\u30c6\u30b9\u30c8\u3092\u6210\u529f\u3057\u307e\u3057\u305f\n\u30c8\u30e9\u30f3\u30b6\u30af\u30b7\u30e7\u30f3\u3092\u5b9f\u884c\u3057\u3066\u3044\u307e\u3059\n  \u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3066\u3044\u307e\u3059  : compat-readline5-5.2-17.1.el6.x86_64                                                                                         1/2\n  \u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3066\u3044\u307e\u3059  : socat-1.7.2.3-1.el6.x86_64                                                                                                   2/2\n  Verifying               : socat-1.7.2.3-1.el6.x86_64                                                                                                   1/2\n  Verifying               : compat-readline5-5.2-17.1.el6.x86_64                                                                                         2/2\n\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb:\n  socat.x86_64 0:1.7.2.3-1.el6\n\n\n\nglobal\n\u4f9d\u5b58\u6027\u95a2\u9023\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u307e\u3057\u305f:\n  compat-readline5.x86_64 0:5.2-17.1.el6\n\n\u5b8c\u4e86\u3057\u307e\u3057\u305f!\n\n\n/etc/haproxy/haproxy.cfg\n\n\n/etc/haproxy/haproxy.cfg\nglobal\nlog 127.0.0.1 local0\nlog 127.0.0.1 local1 notice\nmaxconn 4096\nchroot /usr/share/haproxy\nstats socket /var/run/haproxy.sock user root group wheel level admin\nuser haproxy\ngroup haproxy\ndaemon\n\ndefaults\nlog global\nmode http\noption tcplog\noption dontlognull\nretries 3\noption redispatch\nmaxconn 2000\ntimeout connect 5000\ntimeout client 50000\ntimeout server 50000\n\nfrontend pxc-front\nbind *:3307\nmode tcp\ndefault_backend pxc-back\n\nfrontend stats-front\nbind *:80\nmode http\ndefault_backend stats-back\n\nfrontend pxc-onenode-front\nbind *:3306\nmode tcp\ndefault_backend pxc-onenode-back\n\nbackend pxc-back\nmode tcp\nbalance leastconn\noption httpchk\nserver c1 192.168.33.21:3306 check port 9200 inter 12000 rise 3 fall 3\nserver c2 192.168.33.22:3306 check port 9200 inter 12000 rise 3 fall 3\nserver c3 192.168.33.23:3306 check port 9200 inter 12000 rise 3 fall 3\n\nbackend stats-back\nmode http\nbalance roundrobin\nstats uri /haproxy/stats\nstats auth pxcstats:secret\n\nbackend pxc-onenode-back\nmode tcp\nbalance leastconn\noption httpchk\nserver c1 192.168.33.21:3306 check port 9200 inter 12000 rise 3 fall 3\nserver c2 192.168.33.22:3306 check port 9200 inter 12000 rise 3 fall 3 backup\nserver c3 192.168.33.23:3306 check port 9200 inter 12000 rise 3 fall 3 backup\n\n\n\nHAProxy\u306e\u8d77\u52d5\n\n$ sudo service haproxy start\nhaproxy \u3092\u8d77\u52d5\u4e2d:                                          [  OK  ]\n\n\nHAProxy\u306e\u72b6\u614b\u78ba\u8a8d\n\n$ sudo sh -c 'echo \"show stat\" | socat unix-connect:/var/run/haproxy.sock stdio'\n# pxname,svname,qcur,qmax,scur,smax,slim,stot,bin,bout,dreq,dresp,ereq,econ,eresp,wretr,wredis,status,weight,act,bck,chkfail,chkdown,lastchg,downtime,qlimit,pid,iid,sid,throttle,lbtot,tracked,type,rate,rate_lim,rate_max,check_status,check_code,check_duration,hrsp_1xx,hrsp_2xx,hrsp_3xx,hrsp_4xx,hrsp_5xx,hrsp_other,hanafail,req_rate,req_rate_max,req_tot,cli_abrt,srv_abrt,comp_in,comp_out,comp_byp,comp_rsp,lastsess,last_chk,last_agt,qtime,ctime,rtime,ttime,\npxc-front,FRONTEND,,,0,0,2000,0,0,0,0,0,0,,,,,OPEN,,,,,,,,,1,2,0,,,,0,0,0,0,,,,,,,,,,,0,0,0,,,0,0,0,0,,,,,,,,\nstats-front,FRONTEND,,,0,0,2000,0,0,0,0,0,0,,,,,OPEN,,,,,,,,,1,3,0,,,,0,0,0,0,,,,0,0,0,0,0,0,,0,0,0,,,0,0,0,0,,,,,,,,\npxc-onenode-front,FRONTEND,,,0,0,2000,0,0,0,0,0,0,,,,,OPEN,,,,,,,,,1,4,0,,,,0,0,0,0,,,,,,,,,,,0,0,0,,,0,0,0,0,,,,,,,,\npxc-back,c1,0,0,0,0,,0,0,0,,0,,0,0,0,0,UP,1,1,0,0,0,520,0,,1,5,1,,0,,2,0,,0,L7OK,200,19,,,,,,,0,,,,0,0,,,,,-1,OK,,0,0,0,0,\npxc-back,c2,0,0,0,0,,0,0,0,,0,,0,0,0,0,UP,1,1,0,1,1,47,468,,1,5,2,,0,,2,0,,0,L7OK,200,15,,,,,,,0,,,,0,0,,,,,-1,OK,,0,0,0,0,\npxc-back,c3,0,0,0,0,,0,0,0,,0,,0,0,0,0,UP,1,1,0,1,1,15,498,,1,5,3,,0,,2,0,,0,L7OK,200,34,,,,,,,0,,,,0,0,,,,,-1,OK,,0,0,0,0,\npxc-back,BACKEND,0,0,0,0,200,0,0,0,0,0,,0,0,0,0,UP,3,3,0,,0,520,0,,1,5,0,,0,,1,0,,0,,,,,,,,,,,,,,0,0,0,0,0,0,-1,,,0,0,0,0,\nstats-back,BACKEND,0,0,0,0,200,0,0,0,0,0,,0,0,0,0,UP,0,0,0,,0,520,0,,1,6,0,,0,,1,0,,0,,,,0,0,0,0,0,0,,,,,0,0,0,0,0,0,-1,,,0,0,0,0,\npxc-onenode-back,c1,0,0,0,0,,0,0,0,,0,,0,0,0,0,UP,1,1,0,0,0,520,0,,1,7,1,,0,,2,0,,0,L7OK,200,20,,,,,,,0,,,,0,0,,,,,-1,OK,,0,0,0,0,\npxc-onenode-back,c2,0,0,0,0,,0,0,0,,0,,0,0,0,0,UP,1,0,1,1,1,46,466,,1,7,2,,0,,2,0,,0,L7OK,200,17,,,,,,,0,,,,0,0,,,,,-1,OK,,0,0,0,0,\npxc-onenode-back,c3,0,0,0,0,,0,0,0,,0,,0,0,0,0,UP,1,0,1,1,1,15,495,,1,7,3,,0,,2,0,,0,L7OK,200,36,,,,,,,0,,,,0,0,,,,,-1,OK,,0,0,0,0,\npxc-onenode-back,BACKEND,0,0,0,0,200,0,0,0,0,0,,0,0,0,0,UP,1,1,2,,0,520,0,,1,7,0,,0,,1,0,,0,,,,,,,,,,,,,,0,0,0,0,0,0,-1,,,0,0,0,0,\n\n\n\u52d5\u4f5c\u78ba\u8a8d\n\npxclient\u304b\u3089HAProxy\u7d4c\u7531\u3067\u30a2\u30af\u30bb\u30b9\n\n$ mysql -u pxclient -p -P 3307 -h 127.0.0.1 -e 'show variables like \"%hostname%\"'\nEnter password:\n+---------------+-----------+\n| Variable_name | Value     |\n+---------------+-----------+\n| hostname      | percona01 |\n+---------------+-----------+\n\n$ mysql -u pxclient -p -P 3307 -h 127.0.0.1 -e 'show variables like \"%hostname%\"'\nEnter password:\n+---------------+-----------+\n| Variable_name | Value     |\n+---------------+-----------+\n| hostname      | percona02 |\n+---------------+-----------+\n\n$ mysql -u pxclient -p -P 3307 -h 127.0.0.1 -e 'show variables like \"%hostname%\"'\nEnter password:\n+---------------+-----------+\n| Variable_name | Value     |\n+---------------+-----------+\n| hostname      | percona03 |\n+---------------+-----------+\n\n\n\u53c2\u8003\n\nSetting up PXC reference architecture with HAProxy\n\n\n## \u306f\u3058\u3081\u306b\n\nHAProxy\u3067Percona XtraDB Cluster\u3078\u306e\u30a2\u30af\u30bb\u30b9\u3092\u5206\u6563\u3059\u308b\u65b9\u6cd5\u3092\u8a18\u8ff0\u3057\u307e\u3059\u3002\n\n## \u74b0\u5883\n\n* CentOS 6.7\n* Percona XtraDB Cluster 5.6\n* HAProxy 1.5.4\n\n## \u30b5\u30fc\u30d0\u69cb\u6210\n\n|\u30db\u30b9\u30c8\u540d|IP\u30a2\u30c9\u30ec\u30b9|\u5f79\u5272|\n|:-:|:-:|:-:|\n|pxclient|192.168.33.11|client/proxy|\n|percona01|192.168.33.21|cluster node1|\n|percona02|192.168.33.22|cluster node2|\n|percona03|192.168.33.23|cluster node3|\n\n## Percona XtraDB Cluster\u306e\u69cb\u7bc9\n\n[CentOS6.7\u306bPercona XtraDB Cluster\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b](http://qiita.com/toshiro3/items/67da351a7ea1764c7997)\u3092\u3054\u53c2\u7167\u304f\u3060\u3055\u3044\n\n## clustercheck\u306e\u8a2d\u5b9a\n\n* node1\n\nclustercheck\u7528\u306e\u30e6\u30fc\u30b6\u4f5c\u6210\n\n```shell\n$ mysql -u root -p\nEnter password:\nWelcome to the MySQL monitor.  Commands end with ; or \\g.\nYour MySQL connection id is 9\nServer version: 5.6.24-72.2-56 Percona XtraDB Cluster (GPL), Release rel72.2, Revision 1, WSREP version 25.11, wsrep_25.11\n\nCopyright (c) 2009-2015 Percona LLC and/or its affiliates\nCopyright (c) 2000, 2015, Oracle and/or its affiliates. All rights reserved.\n\nOracle is a registered trademark of Oracle Corporation and/or its\naffiliates. Other names may be trademarks of their respective\nowners.\n\nType 'help;' or '\\h' for help. Type '\\c' to clear the current input statement.\n\nmysql> grant process on *.* to 'clustercheckuser'@'localhost' identified by 'clustercheckpassword!';\nQuery OK, 0 rows affected (0.06 sec)\n\nmysql> flush privileges;\nQuery OK, 0 rows affected (0.03 sec)\n\nmysql> exit\nBye\n```\n\nclustercheck\u306e\u52d5\u4f5c\u78ba\u8a8d\n\n```shell\n$ clustercheck\nHTTP/1.1 200 OK\nContent-Type: text/plain\nConnection: close\nContent-Length: 40\n\nPercona XtraDB Cluster Node is synced.\n```\n\n* node1 \u301c node3\n\nxinetd\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n```shell\n$ sudo yum install xinetd\n\u8aad\u307f\u8fbc\u3093\u3060\u30d7\u30e9\u30b0\u30a4\u30f3:fastestmirror, security\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u51e6\u7406\u306e\u8a2d\u5b9a\u3092\u3057\u3066\u3044\u307e\u3059\nLoading mirror speeds from cached hostfile\nepel/metalink                                                                                                                         | 4.9 kB     00:00\n * base: ftp.riken.jp\n * epel: ftp.riken.jp\n * extras: ftp.riken.jp\n * updates: ftp.riken.jp\nbase                                                                                                                                  | 3.7 kB     00:00\nextras                                                                                                                                | 3.4 kB     00:00\npercona-release-noarch                                                                                                                |  951 B     00:00\npercona-release-noarch/primary                                                                                                        | 5.0 kB     00:00\npercona-release-noarch                                                                                                                                 33/33\npercona-release-x86_64                                                                                                                |  951 B     00:00\nupdates                                                                                                                               | 3.4 kB     00:00\n\u4f9d\u5b58\u6027\u306e\u89e3\u6c7a\u3092\u3057\u3066\u3044\u307e\u3059\n--> \u30c8\u30e9\u30f3\u30b6\u30af\u30b7\u30e7\u30f3\u306e\u78ba\u8a8d\u3092\u5b9f\u884c\u3057\u3066\u3044\u307e\u3059\u3002\n---> Package xinetd.x86_64 2:2.3.14-39.el6_4 will be \u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n--> \u4f9d\u5b58\u6027\u89e3\u6c7a\u3092\u7d42\u4e86\u3057\u307e\u3057\u305f\u3002\n\n\u4f9d\u5b58\u6027\u3092\u89e3\u6c7a\u3057\u307e\u3057\u305f\n\n=============================================================================================================================================================\n \u30d1\u30c3\u30b1\u30fc\u30b8                         \u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3                     \u30d0\u30fc\u30b8\u30e7\u30f3                                     \u30ea\u30dd\u30b8\u30c8\u30ea\u30fc                      \u5bb9\u91cf\n=============================================================================================================================================================\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3066\u3044\u307e\u3059:\n xinetd                             x86_64                             2:2.3.14-39.el6_4                              base                             121 k\n\n\u30c8\u30e9\u30f3\u30b6\u30af\u30b7\u30e7\u30f3\u306e\u8981\u7d04\n=============================================================================================================================================================\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb         1 \u30d1\u30c3\u30b1\u30fc\u30b8\n\n\u7dcf\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u5bb9\u91cf: 121 k\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u6e08\u307f\u5bb9\u91cf: 259 k\n\u3053\u308c\u3067\u3044\u3044\u3067\u3059\u304b? [y/N]y\n\u30d1\u30c3\u30b1\u30fc\u30b8\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u3066\u3044\u307e\u3059:\nxinetd-2.3.14-39.el6_4.x86_64.rpm                                                                                                     | 121 kB     00:00\nrpm_check_debug \u3092\u5b9f\u884c\u3057\u3066\u3044\u307e\u3059\n\u30c8\u30e9\u30f3\u30b6\u30af\u30b7\u30e7\u30f3\u306e\u30c6\u30b9\u30c8\u3092\u5b9f\u884c\u3057\u3066\u3044\u307e\u3059\n\u30c8\u30e9\u30f3\u30b6\u30af\u30b7\u30e7\u30f3\u306e\u30c6\u30b9\u30c8\u3092\u6210\u529f\u3057\u307e\u3057\u305f\n\u30c8\u30e9\u30f3\u30b6\u30af\u30b7\u30e7\u30f3\u3092\u5b9f\u884c\u3057\u3066\u3044\u307e\u3059\n  \u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3066\u3044\u307e\u3059  : 2:xinetd-2.3.14-39.el6_4.x86_64                                                                                              1/1\n  Verifying               : 2:xinetd-2.3.14-39.el6_4.x86_64                                                                                              1/1\n\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb:\n  xinetd.x86_64 2:2.3.14-39.el6_4\n\n\u5b8c\u4e86\u3057\u307e\u3057\u305f!\n```\n\n/etc/xinetd.d/mysqlchk\n\n```conf:/etc/xinetd.d/mysqlchk\n# default: on\n# description: mysqlchk\nservice mysqlchk\n{\n# this is a config for xinetd, place it in /etc/xinetd.d/\n        disable = no\n        flags           = REUSE\n        socket_type     = stream\n        type            = UNLISTED\n        port            = 9200\n        wait            = no\n        user            = nobody\n        server          = /usr/bin/clustercheck\n        log_on_failure  += USERID\n        only_from       = 0.0.0.0/0\n        #\n        # Passing arguments to clustercheck\n        # <user> <pass> <available_when_donor=0|1> <log_file> <available_when_readonly=0|1> <defaults_extra_file>\"\n        # Recommended: server_args   = user pass 1 /var/log/log-file 0 /etc/my.cnf.local\"\n        # Compatibility: server_args = user pass 1 /var/log/log-file 1 /etc/my.cnf.local\"\n        # 55-to-56 upgrade: server_args = user pass 1 /var/log/log-file 0 /etc/my.cnf.extra\"\n        #\n        # recommended to put the IPs that need\n        # to connect exclusively (security purposes)\n        per_source      = UNLIMITED\n}\n```\n\nxinetd\u306e\u8d77\u52d5\n\n```shell\n$ sudo service xinetd start\n```\n\nxinetd\u7d4c\u7531\u306eclustercheck\u306e\u52d5\u4f5c\u78ba\u8a8d\n\n```shell\n$ curl http://127.0.0.1:9200/\nPercona XtraDB Cluster Node is synced.\n```\n\nmysqlchk\u3092service\u3078\u767b\u9332\n\n```shell\n$ sudo vim /etc/services\n(\u8ffd\u8a18)\nmysqlchk 9200/tcp # mysqlchk\n\n$ sudo vim /etc/services\n[vagrant@percona01 ~]$ sudo service xinetd restart\nxinetd \u3092\u505c\u6b62\u4e2d:                                           [  OK  ]\nxinetd \u3092\u8d77\u52d5\u4e2d:                                           [  OK  ]\n```\n\n## HAProxy\u306e\u8a2d\u5b9a\n\n* HAProxy\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n```shell\n$ sudo yum install haproxy\n\u8aad\u307f\u8fbc\u3093\u3060\u30d7\u30e9\u30b0\u30a4\u30f3:fastestmirror\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u51e6\u7406\u306e\u8a2d\u5b9a\u3092\u3057\u3066\u3044\u307e\u3059\nLoading mirror speeds from cached hostfile\n * base: www.ftp.ne.jp\n * epel: ftp.riken.jp\n * extras: ftp.nara.wide.ad.jp\n * updates: www.ftp.ne.jp\n\u4f9d\u5b58\u6027\u306e\u89e3\u6c7a\u3092\u3057\u3066\u3044\u307e\u3059\n--> \u30c8\u30e9\u30f3\u30b6\u30af\u30b7\u30e7\u30f3\u306e\u78ba\u8a8d\u3092\u5b9f\u884c\u3057\u3066\u3044\u307e\u3059\u3002\n---> Package haproxy.x86_64 0:1.5.4-2.el6_7.1 will be \u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n--> \u4f9d\u5b58\u6027\u89e3\u6c7a\u3092\u7d42\u4e86\u3057\u307e\u3057\u305f\u3002\n\n\u4f9d\u5b58\u6027\u3092\u89e3\u6c7a\u3057\u307e\u3057\u305f\n\n=============================================================================================================================================================\n \u30d1\u30c3\u30b1\u30fc\u30b8                         \u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3                    \u30d0\u30fc\u30b8\u30e7\u30f3                                    \u30ea\u30dd\u30b8\u30c8\u30ea\u30fc                        \u5bb9\u91cf\n=============================================================================================================================================================\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3066\u3044\u307e\u3059:\n haproxy                            x86_64                            1.5.4-2.el6_7.1                               updates                            792 k\n\n\u30c8\u30e9\u30f3\u30b6\u30af\u30b7\u30e7\u30f3\u306e\u8981\u7d04\n=============================================================================================================================================================\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb         1 \u30d1\u30c3\u30b1\u30fc\u30b8\n\n\u7dcf\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u5bb9\u91cf: 792 k\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u6e08\u307f\u5bb9\u91cf: 2.4 M\n\u3053\u308c\u3067\u3044\u3044\u3067\u3059\u304b? [y/N]y\n\u30d1\u30c3\u30b1\u30fc\u30b8\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u3066\u3044\u307e\u3059:\nhaproxy-1.5.4-2.el6_7.1.x86_64.rpm                                                                                                    | 792 kB     00:00\nrpm_check_debug \u3092\u5b9f\u884c\u3057\u3066\u3044\u307e\u3059\n\u30c8\u30e9\u30f3\u30b6\u30af\u30b7\u30e7\u30f3\u306e\u30c6\u30b9\u30c8\u3092\u5b9f\u884c\u3057\u3066\u3044\u307e\u3059\n\u30c8\u30e9\u30f3\u30b6\u30af\u30b7\u30e7\u30f3\u306e\u30c6\u30b9\u30c8\u3092\u6210\u529f\u3057\u307e\u3057\u305f\n\u30c8\u30e9\u30f3\u30b6\u30af\u30b7\u30e7\u30f3\u3092\u5b9f\u884c\u3057\u3066\u3044\u307e\u3059\n  \u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3066\u3044\u307e\u3059  : haproxy-1.5.4-2.el6_7.1.x86_64                                                                                               1/1\n  Verifying               : haproxy-1.5.4-2.el6_7.1.x86_64                                                                                               1/1\n\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb:\n  haproxy.x86_64 0:1.5.4-2.el6_7.1\n\n\u5b8c\u4e86\u3057\u307e\u3057\u305f!\n```\n\n* socat\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n```shell\n$ sudo yum instal socat\n\u8aad\u307f\u8fbc\u3093\u3060\u30d7\u30e9\u30b0\u30a4\u30f3:fastestmirror\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u51e6\u7406\u306e\u8a2d\u5b9a\u3092\u3057\u3066\u3044\u307e\u3059\nLoading mirror speeds from cached hostfile\n * base: www.ftp.ne.jp\n * epel: ftp.riken.jp\n * extras: ftp.nara.wide.ad.jp\n * updates: www.ftp.ne.jp\n\u4f9d\u5b58\u6027\u306e\u89e3\u6c7a\u3092\u3057\u3066\u3044\u307e\u3059\n--> \u30c8\u30e9\u30f3\u30b6\u30af\u30b7\u30e7\u30f3\u306e\u78ba\u8a8d\u3092\u5b9f\u884c\u3057\u3066\u3044\u307e\u3059\u3002\n---> Package socat.x86_64 0:1.7.2.3-1.el6 will be \u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n--> \u4f9d\u5b58\u6027\u306e\u51e6\u7406\u3092\u3057\u3066\u3044\u307e\u3059: libreadline.so.5()(64bit) \u306e\u30d1\u30c3\u30b1\u30fc\u30b8: socat-1.7.2.3-1.el6.x86_64\n--> \u30c8\u30e9\u30f3\u30b6\u30af\u30b7\u30e7\u30f3\u306e\u78ba\u8a8d\u3092\u5b9f\u884c\u3057\u3066\u3044\u307e\u3059\u3002\n---> Package compat-readline5.x86_64 0:5.2-17.1.el6 will be \u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n--> \u4f9d\u5b58\u6027\u89e3\u6c7a\u3092\u7d42\u4e86\u3057\u307e\u3057\u305f\u3002\n\n\n\n\u4f9d\u5b58\u6027\u3092\u89e3\u6c7a\u3057\u307e\u3057\u305f\n\n=============================================================================================================================================================\n \u30d1\u30c3\u30b1\u30fc\u30b8                                 \u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3                   \u30d0\u30fc\u30b8\u30e7\u30f3                                 \u30ea\u30dd\u30b8\u30c8\u30ea\u30fc                    \u5bb9\u91cf\n\n\nglobal\n=============================================================================================================================================================\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3066\u3044\u307e\u3059:\n socat                                      x86_64                           1.7.2.3-1.el6                              epel                           246 k\n\u4f9d\u5b58\u6027\u95a2\u9023\u3067\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3092\u3057\u307e\u3059\u3002:\n compat-readline5                           x86_64                           5.2-17.1.el6                               base                           130 k\n\n\u30c8\u30e9\u30f3\u30b6\u30af\u30b7\u30e7\u30f3\u306e\u8981\u7d04\n=============================================================================================================================================================\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb         2 \u30d1\u30c3\u30b1\u30fc\u30b8\n\n\u7dcf\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u5bb9\u91cf: 375 k\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u6e08\u307f\u5bb9\u91cf: 1.2 M\n\u3053\u308c\u3067\u3044\u3044\u3067\u3059\u304b? [y/N]y\n\u30d1\u30c3\u30b1\u30fc\u30b8\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u3066\u3044\u307e\u3059:\n(1/2): compat-readline5-5.2-17.1.el6.x86_64.rpm                                                                                       | 130 kB     00:00\n(2/2): socat-1.7.2.3-1.el6.x86_64.rpm                                                                                                 | 246 kB     00:00\n-------------------------------------------------------------------------------------------------------------------------------------------------------------\n\u5408\u8a08                                                                                                                         454 kB/s | 375 kB     00:00\nrpm_check_debug \u3092\u5b9f\u884c\u3057\u3066\u3044\u307e\u3059\n\u30c8\u30e9\u30f3\u30b6\u30af\u30b7\u30e7\u30f3\u306e\u30c6\u30b9\u30c8\u3092\u5b9f\u884c\u3057\u3066\u3044\u307e\u3059\n\u30c8\u30e9\u30f3\u30b6\u30af\u30b7\u30e7\u30f3\u306e\u30c6\u30b9\u30c8\u3092\u6210\u529f\u3057\u307e\u3057\u305f\n\u30c8\u30e9\u30f3\u30b6\u30af\u30b7\u30e7\u30f3\u3092\u5b9f\u884c\u3057\u3066\u3044\u307e\u3059\n  \u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3066\u3044\u307e\u3059  : compat-readline5-5.2-17.1.el6.x86_64                                                                                         1/2\n  \u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3066\u3044\u307e\u3059  : socat-1.7.2.3-1.el6.x86_64                                                                                                   2/2\n  Verifying               : socat-1.7.2.3-1.el6.x86_64                                                                                                   1/2\n  Verifying               : compat-readline5-5.2-17.1.el6.x86_64                                                                                         2/2\n\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb:\n  socat.x86_64 0:1.7.2.3-1.el6\n\n\n\nglobal\n\u4f9d\u5b58\u6027\u95a2\u9023\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u307e\u3057\u305f:\n  compat-readline5.x86_64 0:5.2-17.1.el6\n\n\u5b8c\u4e86\u3057\u307e\u3057\u305f!\n```\n\n* /etc/haproxy/haproxy.cfg\n\n```conf:/etc/haproxy/haproxy.cfg\nglobal\nlog 127.0.0.1 local0\nlog 127.0.0.1 local1 notice\nmaxconn 4096\nchroot /usr/share/haproxy\nstats socket /var/run/haproxy.sock user root group wheel level admin\nuser haproxy\ngroup haproxy\ndaemon\n\ndefaults\nlog global\nmode http\noption tcplog\noption dontlognull\nretries 3\noption redispatch\nmaxconn 2000\ntimeout connect 5000\ntimeout client 50000\ntimeout server 50000\n\nfrontend pxc-front\nbind *:3307\nmode tcp\ndefault_backend pxc-back\n\nfrontend stats-front\nbind *:80\nmode http\ndefault_backend stats-back\n\nfrontend pxc-onenode-front\nbind *:3306\nmode tcp\ndefault_backend pxc-onenode-back\n\nbackend pxc-back\nmode tcp\nbalance leastconn\noption httpchk\nserver c1 192.168.33.21:3306 check port 9200 inter 12000 rise 3 fall 3\nserver c2 192.168.33.22:3306 check port 9200 inter 12000 rise 3 fall 3\nserver c3 192.168.33.23:3306 check port 9200 inter 12000 rise 3 fall 3\n\nbackend stats-back\nmode http\nbalance roundrobin\nstats uri /haproxy/stats\nstats auth pxcstats:secret\n\nbackend pxc-onenode-back\nmode tcp\nbalance leastconn\noption httpchk\nserver c1 192.168.33.21:3306 check port 9200 inter 12000 rise 3 fall 3\nserver c2 192.168.33.22:3306 check port 9200 inter 12000 rise 3 fall 3 backup\nserver c3 192.168.33.23:3306 check port 9200 inter 12000 rise 3 fall 3 backup\n```\n\n* HAProxy\u306e\u8d77\u52d5\n\n```shell\n$ sudo service haproxy start\nhaproxy \u3092\u8d77\u52d5\u4e2d:                                          [  OK  ]\n```\n\n* HAProxy\u306e\u72b6\u614b\u78ba\u8a8d\n\n```shell\n$ sudo sh -c 'echo \"show stat\" | socat unix-connect:/var/run/haproxy.sock stdio'\n# pxname,svname,qcur,qmax,scur,smax,slim,stot,bin,bout,dreq,dresp,ereq,econ,eresp,wretr,wredis,status,weight,act,bck,chkfail,chkdown,lastchg,downtime,qlimit,pid,iid,sid,throttle,lbtot,tracked,type,rate,rate_lim,rate_max,check_status,check_code,check_duration,hrsp_1xx,hrsp_2xx,hrsp_3xx,hrsp_4xx,hrsp_5xx,hrsp_other,hanafail,req_rate,req_rate_max,req_tot,cli_abrt,srv_abrt,comp_in,comp_out,comp_byp,comp_rsp,lastsess,last_chk,last_agt,qtime,ctime,rtime,ttime,\npxc-front,FRONTEND,,,0,0,2000,0,0,0,0,0,0,,,,,OPEN,,,,,,,,,1,2,0,,,,0,0,0,0,,,,,,,,,,,0,0,0,,,0,0,0,0,,,,,,,,\nstats-front,FRONTEND,,,0,0,2000,0,0,0,0,0,0,,,,,OPEN,,,,,,,,,1,3,0,,,,0,0,0,0,,,,0,0,0,0,0,0,,0,0,0,,,0,0,0,0,,,,,,,,\npxc-onenode-front,FRONTEND,,,0,0,2000,0,0,0,0,0,0,,,,,OPEN,,,,,,,,,1,4,0,,,,0,0,0,0,,,,,,,,,,,0,0,0,,,0,0,0,0,,,,,,,,\npxc-back,c1,0,0,0,0,,0,0,0,,0,,0,0,0,0,UP,1,1,0,0,0,520,0,,1,5,1,,0,,2,0,,0,L7OK,200,19,,,,,,,0,,,,0,0,,,,,-1,OK,,0,0,0,0,\npxc-back,c2,0,0,0,0,,0,0,0,,0,,0,0,0,0,UP,1,1,0,1,1,47,468,,1,5,2,,0,,2,0,,0,L7OK,200,15,,,,,,,0,,,,0,0,,,,,-1,OK,,0,0,0,0,\npxc-back,c3,0,0,0,0,,0,0,0,,0,,0,0,0,0,UP,1,1,0,1,1,15,498,,1,5,3,,0,,2,0,,0,L7OK,200,34,,,,,,,0,,,,0,0,,,,,-1,OK,,0,0,0,0,\npxc-back,BACKEND,0,0,0,0,200,0,0,0,0,0,,0,0,0,0,UP,3,3,0,,0,520,0,,1,5,0,,0,,1,0,,0,,,,,,,,,,,,,,0,0,0,0,0,0,-1,,,0,0,0,0,\nstats-back,BACKEND,0,0,0,0,200,0,0,0,0,0,,0,0,0,0,UP,0,0,0,,0,520,0,,1,6,0,,0,,1,0,,0,,,,0,0,0,0,0,0,,,,,0,0,0,0,0,0,-1,,,0,0,0,0,\npxc-onenode-back,c1,0,0,0,0,,0,0,0,,0,,0,0,0,0,UP,1,1,0,0,0,520,0,,1,7,1,,0,,2,0,,0,L7OK,200,20,,,,,,,0,,,,0,0,,,,,-1,OK,,0,0,0,0,\npxc-onenode-back,c2,0,0,0,0,,0,0,0,,0,,0,0,0,0,UP,1,0,1,1,1,46,466,,1,7,2,,0,,2,0,,0,L7OK,200,17,,,,,,,0,,,,0,0,,,,,-1,OK,,0,0,0,0,\npxc-onenode-back,c3,0,0,0,0,,0,0,0,,0,,0,0,0,0,UP,1,0,1,1,1,15,495,,1,7,3,,0,,2,0,,0,L7OK,200,36,,,,,,,0,,,,0,0,,,,,-1,OK,,0,0,0,0,\npxc-onenode-back,BACKEND,0,0,0,0,200,0,0,0,0,0,,0,0,0,0,UP,1,1,2,,0,520,0,,1,7,0,,0,,1,0,,0,,,,,,,,,,,,,,0,0,0,0,0,0,-1,,,0,0,0,0,\n```\n\n## \u52d5\u4f5c\u78ba\u8a8d\n\n* pxclient\u304b\u3089HAProxy\u7d4c\u7531\u3067\u30a2\u30af\u30bb\u30b9\n\n```shell\n$ mysql -u pxclient -p -P 3307 -h 127.0.0.1 -e 'show variables like \"%hostname%\"'\nEnter password:\n+---------------+-----------+\n| Variable_name | Value     |\n+---------------+-----------+\n| hostname      | percona01 |\n+---------------+-----------+\n\n$ mysql -u pxclient -p -P 3307 -h 127.0.0.1 -e 'show variables like \"%hostname%\"'\nEnter password:\n+---------------+-----------+\n| Variable_name | Value     |\n+---------------+-----------+\n| hostname      | percona02 |\n+---------------+-----------+\n\n$ mysql -u pxclient -p -P 3307 -h 127.0.0.1 -e 'show variables like \"%hostname%\"'\nEnter password:\n+---------------+-----------+\n| Variable_name | Value     |\n+---------------+-----------+\n| hostname      | percona03 |\n+---------------+-----------+\n```\n\n## \u53c2\u8003\n\n* [Setting up PXC reference architecture with HAProxy](https://www.percona.com/doc/percona-xtradb-cluster/5.6/howtos/virt_sandbox.html)\n", "tags": ["percona", "CentOS6", "haproxy", "xtradb"]}