{"context": "\n\n\u306f\u3058\u3081\u306b\n\u4ee5\u4e0b\u306e\u8a18\u4e8b\u3067 Device Tree Overlay \u3068 FPGA Manager \u306b\u5bfe\u5fdc\u3057\u305f FPGA+SoC+Linux \u306e\u52d5\u4f5c\u74b0\u5883\u3092\u7d39\u4ecb\u3057\u307e\u3057\u305f\u3002\n\n\u300cFPGA+SoC+Linux+Device Tree Overlay+FPGA Manager(\u30d6\u30fc\u30c8\u30a4\u30e1\u30fc\u30b8\u306e\u63d0\u4f9b)\u300d@Qiita\n\n\u3055\u3089\u306b\u3001\u4ee5\u4e0b\u306e\u8a18\u4e8b\u3067\u3053\u306e\u30b7\u30b9\u30c6\u30e0\u3092 ZYBO \u3068 DE0-Nano-SoC \u306b\u5bfe\u5fdc\u3057\u305f\u5b9f\u4f8b\u3092\u7d39\u4ecb\u3057\u307e\u3057\u305f\u3002\n\n\u300cFPGA+SoC+Linux+Device Tree Overlay+FPGA Manager(ZYBO-Examples)\u300d@Qiita\n\u300cFPGA+SoC+Linux+Device Tree Overlay+FPGA Manager(DE0-Nano-SoC-Examples)\u300d@Qiita\n\n\u4e0a\u3067\u7d39\u4ecb\u3057\u305f\u5b9f\u4f8b\u3067\u306f ZYBO \u3068 DE0-Nano-SoC \u3067\u5225\u3005\u306e SD-Card \u3092\u7528\u610f\u3057\u3066\u3044\u307e\u3057\u305f\u304c\u3001\u3053\u306e\u8a18\u4e8b\u3067\u306f\u30011\u679a\u306e SD-Card \u3067 ZYBO \u3068 DE0-Nano-SoC \u306e\uff12\u7a2e\u985e\u306e\u30dc\u30fc\u30c9\u3067\u8d77\u52d5\u3059\u308b\u65b9\u6cd5\u3092\u7d39\u4ecb\u3057\u307e\u3059\u3002\n\u3082\u3068\u3082\u3068\u3001\u3053\u306e\u30c7\u30e5\u30a2\u30eb\u30d6\u30fc\u30c8\u65b9\u6cd5\u306f\u3001\u6b21\u306e\u8cc7\u6599\u306b\u89e6\u767a\u3055\u308c\u305f\u3082\u306e\u3067\u3001\u304a\u304a\u3044\u306b\u53c2\u8003\u306b\u3055\u305b\u3066\u3082\u3089\u3044\u307e\u3057\u305f\u3002\u3053\u306e\u5834\u3092\u501f\u308a\u3066\u304a\u793c\u3092\u7533\u3057\u4e0a\u3052\u307e\u3059\u3002\n\n\u77f3\u539f\u3072\u3067\u307f. \u300e\u7b2c\u4e94\u7ae0 \u3064\u3044\u306b\u8d77\u52d5\uff01\u30c7\u30e5\u30a2\u30eb\u30fb\u30d6\u30fc\u30c8 SD \u30ab\u30fc\u30c9\u306e\u4f5c\u308a\u65b9\u300f\u300cFPGA \u30de\u30ac\u30b8\u30f3 No.12\u300d57\u9801\n\n\n\u8ffd\u8a18\n\n2017/1/14 \u306b Linux Kernel \u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u3092 v4.8.17 \u306b\u66f4\u65b0\u3057\u307e\u3057\u305f\u3002\n2017/1/31 \u306b udmabuf \u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u3092 v0.6.0 \u306b\u66f4\u65b0\u3057\u307e\u3057\u305f\u3002\n\n\n\u6982\u8981\n\nHardware\n\n\nZYBO : Xilinx Zynq-7000 ARM/FPGA SoC Trainer Board by Digilent\nDE0-Nano-SoC : Altera SoC FPGA Development Kit by terasic\n\n\nU-Boot v2016.03 (customized)\n\n\nBuild for ZYBO and DE0-Nano-SoC\nCustomized boot by uEnv.txt\nCustomized boot by boot.scr\n\n\nLinux Kernel Version v4.4.7 or v4.8.17\n\n\nAvailable in both Xilinx-Zynq-7000 and Altera-SoC in a single image\nEnable Device Tree Overlay\nEnable FPGA Manager\n\n\nDebian8(jessie) Root File System\n\n\nInstalled build-essential\nInstalled device-tree-compiler\nInstalled ruby ruby-msgpack ruby-serialport\nInstalled u-boot-tools\n\n\nFPGA Device Drivers\n\n\ndtbocfg     (Device Tree Blob Overlay Configuration File System)\nfpgacfg     (FPGA Configuration Interface for Linux FPGA Manager Framework)\nfclkcfg     (FPGA Clock Configuration Device Driver)\nudmabuf     (User space mappable DMA Buffer)\nzptty       (Pseudo TeleTYpewriter for FPGA Device)\nfpga-bridge (FPGA to/from HPS Bridge Driver for Altera SoCFPGA Devices)\n\n\n\n\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\ngithub \u304b\u3089\u6b21\u306e\u3088\u3046\u306b\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\u73fe\u6642\u70b9\u306e\u6700\u65b0\u30d0\u30fc\u30b8\u30e7\u30f3\u306f v0.2.0 \u3067\u3059\u3002\u30c1\u30a7\u30c3\u30af\u30a2\u30a6\u30c8\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\u306a\u304a\u3001\u3044\u304f\u3064\u304b\u306e\u30a4\u30e1\u30fc\u30b8\u30d5\u30a1\u30a4\u30eb\u306f\u304b\u306a\u308a\u5927\u304d\u3044\u306e\u3067\u3001Git LFS(Large File Storage)\u3092\u4f7f\u3063\u3066\u3044\u307e\u3059\u3002\n\u304a\u4f7f\u3044\u306e\u74b0\u5883\u306b git-lfs \u304c\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3055\u308c\u3066\u3044\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\nshell$ git clone git://github.com/ikwzm/FPGA-SoC-Linux\nshell$ cd FPGA-SoC-Linux\nshell$ git checkout v0.2.0\nshell$ git lfs pull\n\n\nBuild boot files\nZYBO \u7528\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3068 DE0-Nano-SoC \u7528\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u304b\u3089\u5fc5\u8981\u306a\u30d5\u30a1\u30a4\u30eb\u3092\u30c7\u30e5\u30a2\u30eb\u30fb\u30d6\u30fc\u30c8\u7528\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea(target/zynq-zybo-de0-nano-soc)\u306b\u30b3\u30d4\u30fc\u3057\u307e\u3059\u3002\ntarget/zynq-zybo-de0-nano-soc/Makefile \u3092\u7528\u610f\u3057\u3066\u3044\u307e\u3059\u306e\u3067\u6d3b\u7528\u3057\u3066\u304f\u3060\u3055\u3044\u3002\nshell$ cd target/zynq-zybo-de0-nano-soc/\nshell$ make\nmkimage -A arm -O linux -T script -C none -a 0 -e 0 -n \"linux boot script\" -d boot/boot.script boot/boot.scr\nImage Name:   linux boot script\nCreated:      Fri Jan 13 17:05:07 2017\nImage Type:   ARM Linux Script (uncompressed)\nData Size:    1324 Bytes = 1.29 kB = 0.00 MB\nLoad Address: 00000000\nEntry Point:  00000000\nContents:\n   Image 0: 1316 Bytes = 1.29 kB = 0.00 MB\ncp ../zynq-zybo/boot/zImage-4.8.17-armv7-fpga boot/zImage-4.8.17-armv7-fpga\ncp ../zynq-zybo/boot/boot.bin boot/boot.bin\ncp ../zynq-zybo/boot/design_1_wrapper.bit boot/design_1_wrapper.bit\ncp ../zynq-zybo/boot/devicetree-4.8.17-zynq-zybo.dtb boot/devicetree-4.8.17-zynq-zybo.dtb\ncp ../zynq-zybo/boot/devicetree-4.8.17-zynq-zybo.dts boot/devicetree-4.8.17-zynq-zybo.dts\ncp ../zynq-zybo/boot/u-boot.img boot/u-boot.img\ncp ../de0-nano-soc//boot/devicetree-4.8.17-socfpga.dtb boot/devicetree-4.8.17-socfpga.dtb\ncp ../de0-nano-soc//boot/devicetree-4.8.17-socfpga.dts boot/devicetree-4.8.17-socfpga.dts\ncp ../de0-nano-soc//boot/DE0_NANO_SOC.rbf boot/DE0_NANO_SOC.rbf\ncp ../de0-nano-soc//u-boot/u-boot-spl.sfp u-boot/u-boot-spl.sfp\ncp ../de0-nano-soc//u-boot/u-boot.img u-boot/u-boot.img\n\n\n\u30d5\u30a1\u30a4\u30eb\u306e\u8aac\u660e\n\u30c7\u30e5\u30a2\u30eb\u30fb\u30d6\u30fc\u30c8\u7528\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea(tareget/zynq-zybo-de0-nano-soc)\u306b\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u30d5\u30a1\u30a4\u30eb\u304c\u3042\u308a\u307e\u3059\u3002\n\ntareget/zynq-zybo-de0-nano-soc/\n\n\nboot/\n\n\nboot.bin                                                  : Stage 1 Boot Loader      (for ZYBO U-boot-spl)\nu-boot.img                                                : Stage 2 Boot Loader      (for ZYBO U-boot image)\nuEnv.txt                                                  : U-Boot environment variables for set kernel version\nboot.script                                               : U-Boot boot script       (source)\nboot.scr                                                  : U-Boot boot script       (binary)\ndesign_1_wrapper.bit                                      : FPGA configuration file  (for ZYBO)\nDE0_NANO_SOC.rbf                                          : FPGA configuration file  (for DE0-Nano-SoC)\nzImage-4.8.17-armv7-fpga                                  : Linux Kernel Image\ndevicetree-4.8.17-zynq-zybo.dtb                           : Linux Device Tree Blob   (for ZYBO)\ndevicetree-4.8.17-zynq-zybo.dts                           : Linux Device Tree Source (for ZYBO)\ndevicetree-4.8.17-socfpga.dtb                             : Linux Device Tree Blob   (for DE0-Nano-SoC)\ndevicetree-4.8.17-socfpga.dts                             : Linux Device Tree Source (for DE0-Nano-SoC)\n\n\nu-boot/\n\n\nu-boot-spl.sfp                                            : Stage 1 Boot Loader      (for DE0-Nano-SoC U-boot-spl)\nu-boot.img                                                : Stage 2 Boot Loader      (for DE0-Nano-SoC U-boot image)\n\n\n\n\ndebian8-rootfs-vanilla.tgz                                    : Debian8 Root File System (use Git LFS)\nlinux-image-4.8.17-armv7-fpga_4.8.17-armv7-fpga-1_armhf.deb   : Linux Image Package      (use Git LFS)\nlinux-headers-4.8.17-armv7-fpga_4.8.17-armv7-fpga-1_armhf.deb : Linux Headers Package    (use Git LFS)\nfpga-soc-linux-drivers-4.8.17-armv7-fpga_0.0.3-1_armhf.deb    : Device Drivers Package   (use Git LFS)\n\n\nSD-Card \u306e\u30d5\u30a9\u30fc\u30de\u30c3\u30c8\nSD-Card \u306e\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\uff11\u3092 FAT File System \u3067\u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0\u3092\u4f5c\u308a\u307e\u3059\u3002\nSD-Card \u306e\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\uff12\u3092 ext3 File System \u3067\u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0\u3092\u4f5c\u308a\u307e\u3059\u3002\nSD-Card \u306e\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\uff13\u3092 \u7279\u6b8a\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3(\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u30bf\u30a4\u30d7=0xa2)\u306b\u3057\u307e\u3059\u3002\u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0\u306f\u4f5c\u308a\u307e\u305b\u3093\u3002\n\u30d5\u30a9\u30fc\u30de\u30c3\u30c8\u65b9\u6cd5\u306e\u8a73\u7d30\u306f\u300e\u7b2c\u4e94\u7ae0 \u3064\u3044\u306b\u8d77\u52d5\uff01\u30c7\u30e5\u30a2\u30eb\u30fb\u30d6\u30fc\u30c8 SD \u30ab\u30fc\u30c9\u306e\u4f5c\u308a\u65b9\u300f\u300cFPGA \u30de\u30ac\u30b8\u30f3 No.12\u300d\u3092\u53c2\u7167\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\nSD-Card \u3078\u306e\u66f8\u304d\u8fbc\u307f\nSD-Card \u306e\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\uff13(\u4e0b\u306e\u4f8b\u3067\u306f/dev/sdc3)\u306b target/zynq-zybo-de0-nano-soc/u-boot/ \u4e0b\u306e\u30d5\u30a1\u30a4\u30eb\u30a4\u30e1\u30fc\u30b8\u3092 dd \u3092\u4f7f\u3063\u3066\u66f8\u304d\u8fbc\u307f\u307e\u3059\u3002\nSD-Card \u306e\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\uff11(\u4e0b\u306e\u4f8b\u3067\u306f/dev/sdc1)\u306b target/zynq-zybo-de0-nano-soc/boot/ \u4e0b\u306e\u30d5\u30a1\u30a4\u30eb\u3092\u30b3\u30d4\u30fc\u3057\u307e\u3059\u3002\nSD-Card \u306e\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\uff12(\u4e0b\u306e\u4f8b\u3067\u306f/dev/sdc2)\u306b debian8-rootfs-vanilla.tgz \u306e\u4e2d\u8eab\u3092\u5c55\u958b\u3057\u307e\u3059\u3002\n\u307e\u305f\u3001\u5c55\u958b\u3057\u305f\u30eb\u30fc\u30c8\u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0\u306e home/fpga \u306b fpga-soc-linux-drivers \u30d1\u30c3\u30b1\u30fc\u30b8\u3092\u3042\u3089\u304b\u3058\u3081\u30b3\u30d4\u30fc\u3057\u3066\u304a\u304f\u3068\u826f\u3044\u3067\u3057\u3087\u3046\u3002\u5f8c\u304b\u3089 network \u7d4c\u7531\u3067\u30b3\u30d4\u30fc\u3057\u3066\u3082\u304b\u307e\u3044\u307e\u305b\u3093\u3002\nshell# mount /dev/sdc1 /mnt/usb1\nshell# mount /dev/sdc2 /mnt/usb2\nshell# cp target/zynq-zybo-de0-nano-soc/boot/*                          /mnt/usb1\nshell# dd if=target/zynq-zybo-de0-nano-soc/u-boot/u-boot-spl.sfp of=/dev/sdc3 bs=64k seek=0\nshell# dd if=target/zynq-zybo-de0-nano-soc/u-boot/u-boot.img     of=/dev/sdc3 bs=64k seek=4\nshell# tar xfz debian8-rootfs-vanilla.tgz -C                            /mnt/usb2\nshell# cp linux-image-4.8.17-armv7-fpga_4.8.17-armv7-fpga-1_armhf.deb   /mnt/usb2/home/fpga\nshell# cp linux-headers-4.8.17-armv7-fpga_4.8.17-armv7-fpga-1_armhf.deb /mnt/usb2/home/fpga\nshell# cp fpga-soc-linux-drivers-4.8.17-armv7-fpga_0.0.3-1_armhf.deb    /mnt/usb2/home/fpga\nshell# umount mnt/usb1\nshell# umount mnt/usb2\n\n\n\u30c7\u30d0\u30a4\u30b9\u30c9\u30e9\u30a4\u30d0\u30d1\u30c3\u30b1\u30fc\u30b8\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\u7701\u7565\u3057\u307e\u3059\u3002\u300cFPGA+SoC+Linux+Device Tree Overlay+FPGA Manager(\u30d6\u30fc\u30c8\u30a4\u30e1\u30fc\u30b8\u306e\u63d0\u4f9b)\u300d \u3092\u53c2\u7167\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n\u30c7\u30e5\u30a2\u30eb\u30fb\u30d6\u30fc\u30c8\u306e\u3057\u304f\u307f\n\uff11\u679a\u306e SD-Card \u3067 ZYNQ \u3068 DE0-Nano-SoC \u306e\u4e21\u65b9\u3092\u30d6\u30fc\u30c8\u3059\u308b\u3057\u304f\u307f\u306b\u95a2\u3057\u3066\u306f\u300e\u7b2c\u4e94\u7ae0 \u3064\u3044\u306b\u8d77\u52d5\uff01\u30c7\u30e5\u30a2\u30eb\u30fb\u30d6\u30fc\u30c8 SD \u30ab\u30fc\u30c9\u306e\u4f5c\u308a\u65b9\u300f\u3092\u53c2\u7167\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\u3053\u3053\u3067\u306f\u3001U-Boot \u304c\u30b9\u30af\u30ea\u30d7\u30c8\u306b\u3088\u3063\u3066 ZYBO \u3068 DE0-Nano-SoC \u3067\u30d6\u30fc\u30c8\u624b\u9806\u3092\u5207\u308a\u66ff\u3048\u308b\u624b\u6cd5\u306e\u8aac\u660e\u3092\u3057\u307e\u3059\u3002\n\nU-Boot \u306e\u6539\u826f\nhttps://github.com/ikwzm/FPGA-SoC-Linux\u3067\u7528\u610f\u3057\u305f U-Boot \u306b\u306f\u3001\u30bd\u30fc\u30b9\u30b3\u30fc\u30c9\u306b\u5c11\u3057\u7d30\u5de5\u304c\u3057\u3066\u3042\u308a\u307e\u3059\u3002\nZYBO \u7528\u306e U-Boot \u306e\u30bd\u30fc\u30b9\u30b3\u30fc\u30c9\u306b\u306f\u6b21\u306e\u3088\u3046\u306a\u30d1\u30c3\u30c1\u3092\u3042\u3066\u3066\u3044\u307e\u3059\u3002\ndiff --git configs/zynq_zybo_defconfig configs/zynq_zybo_defconfig\nindex 7c23fec..8fc954e 100644\n--- configs/zynq_zybo_defconfig\n+++ configs/zynq_zybo_defconfig\n@@ -22,3 +22,5 @@ CONFIG_DEBUG_UART_ZYNQ=y\n CONFIG_DEBUG_UART_BASE=0xe0001000\n CONFIG_DEBUG_UART_CLOCK=50000000\n CONFIG_ZYNQ_QSPI=y\n+# CONFIG_OF_SEPARATE is not set\n+CONFIG_OF_EMBED=y\ndiff --git include/configs/zynq-common.h include/configs/zynq-common.h\nindex 982905d..fd50c69 100644\n--- include/configs/zynq-common.h\n+++ include/configs/zynq-common.h\n@@ -227,10 +227,35 @@\n    \"usbboot=if usb start; then \" \\\n            \"echo Copying FIT from USB to RAM... && \" \\\n            \"load usb 0 ${load_addr} ${fit_image} && \" \\\n-           \"bootm ${load_addr}; fi\\0\" \\\n-       DFU_ALT_INFO\n-\n-#define CONFIG_BOOTCOMMAND     \"run $modeboot\"\n+           \"bootm ${load_addr}\\0\" \\\n+       \"fi\\0\" \\\n+   \"bootenv=uEnv.txt\\0\" \\\n+        \"config=\" CONFIG_DEFAULT_DEVICE_TREE \"\\0\" \\\n+   \"loadbootenv=load mmc 0 ${load_addr} ${bootenv}\\0\" \\\n+   \"importbootenv=echo Importing environment from mmc ...;\" \\\n+       \"env import -t $load_addr $filesize\\0\" \\\n+        \"loadbootscript=load mmc 0 ${load_addr} boot.scr\\0\" \\\n+        \"bootscript=echo Running bootscript from mmc ...;\" \\\n+                \"source ${load_addr}\\0\" \\\n+   DFU_ALT_INFO\n+\n+#define CONFIG_BOOTCOMMAND \\\n+   \"if mmc rescan; then \" \\\n+       \"echo SD/MMC found on device...;\" \\\n+       \"if run loadbootenv; then \" \\\n+           \"echo Loaded environment from ${bootenv};\" \\\n+           \"run importbootenv;\" \\\n+       \"fi;\" \\\n+       \"if test -n $uenvcmd; then \" \\\n+           \"echo Running uenvcmd ...;\" \\\n+           \"run uenvcmd;\" \\\n+       \"fi;\" \\\n+       \"if run loadbootscript; then \" \\\n+           \"run bootscript; \" \\\n+       \"fi; \" \\\n+   \"fi;\" \\\n+        \"run $modeboot\"\n+#define CONFIG_CMD_BOOTZ\n #define CONFIG_BOOTDELAY       3 /* -1 to Disable autoboot */\n #define CONFIG_SYS_LOAD_ADDR       0 /* default? */\n\nDE0-Nano-SoC \u7528\u306e U-Boot \u306e\u30bd\u30fc\u30b9\u30b3\u30fc\u30c9\u306b\u306f\u6b21\u306e\u3088\u3046\u306a\u30d1\u30c3\u30c1\u3092\u3042\u3066\u3066\u3044\u307e\u3059\u3002\ndiff --git include/configs/socfpga_de0_nano_soc.h include/configs/socfpga_de0_nano_soc.h\nindex cbc7396..1b68bdb 100644\n--- include/configs/socfpga_de0_nano_soc.h\n+++ include/configs/socfpga_de0_nano_soc.h\n@@ -37,7 +37,22 @@\n #define CONFIG_BOOTDELAY   3\n #define CONFIG_BOOTFILE        \"fitImage\"\n #define CONFIG_BOOTARGS        \"console=ttyS0,\" __stringify(CONFIG_BAUDRATE)\n-#define CONFIG_BOOTCOMMAND \"run mmcload; run mmcboot\"\n+#define CONFIG_BOOTCOMMAND     \\\n+   \"if mmc rescan; then \" \\\n+       \"echo SD/MMC found on device...;\" \\\n+       \"if run loadbootenv; then \" \\\n+           \"echo Loaded environment from ${bootenv};\" \\\n+           \"run importbootenv;\" \\\n+       \"fi;\" \\\n+       \"if test -n $uenvcmd; then \" \\\n+           \"echo Running uenvcmd ...;\" \\\n+           \"run uenvcmd;\" \\\n+       \"fi;\" \\\n+       \"if run loadbootscript; then \" \\\n+           \"run bootscript; \" \\\n+       \"fi; \" \\\n+   \"fi;\" \\\n+        \"run mmcload; run mmcboot\"\n #define CONFIG_LOADADDR        0x01000000\n #define CONFIG_SYS_LOAD_ADDR   CONFIG_LOADADDR\n\n@@ -65,6 +80,15 @@\n    \"mmcload=mmc rescan;\" \\\n        \"load mmc 0:1 ${loadaddr} ${bootimage};\" \\\n        \"load mmc 0:1 ${fdt_addr} ${fdtimage}\\0\" \\\n+        \"fpgadata=0x02000000\\0\" \\\n+   \"bootenv=uEnv.txt\\0\" \\\n+   \"config=\" CONFIG_DEFAULT_DEVICE_TREE \"\\0\" \\\n+   \"loadbootenv=load mmc 0 ${loadaddr} ${bootenv}\\0\" \\\n+   \"importbootenv=echo Importing environment from mmc ...;\" \\\n+       \"env import -t $loadaddr $filesize\\0\" \\\n+        \"loadbootscript=load mmc 0 ${loadaddr} boot.scr\\0\" \\\n+        \"bootscript=echo Running bootscript from mmc ...;\" \\\n+                \"source ${loadaddr}\\0\" \\\n\n /* The rest of the configuration is shared */\n #include <configs/socfpga_common.h>\n\n\u3044\u305a\u308c\u306e\u30d1\u30c3\u30c1\u3082\u6b21\u306e\u3088\u3046\u306a\u4fee\u6b63\u3092\u3057\u3066\u3044\u307e\u3059\u3002\n\nconfig \u5909\u6570\u306b U-Boot \u30d3\u30eb\u30c9\u6642\u306e\u30dc\u30fc\u30c9\u540d\u3092\u8a2d\u5b9a\u3059\u308b\n\u30d6\u30fc\u30c8\u6642\u306b uEnv.txt \u3092\u8aad\u3093\u3067\u74b0\u5883\u5909\u6570\u3092\u8a2d\u5b9a\u3059\u308b\n\u30d6\u30fc\u30c8\u6642\u306b uEnv.txt \u306b uenvcmd \u5909\u6570\u304c\u8a2d\u5b9a\u3055\u308c\u3066\u3044\u305f\u5834\u5408\u306f\u3053\u308c\u3092\u5b9f\u884c\u3059\u308b\n\u30d6\u30fc\u30c8\u6642\u306b uenvcmd \u304c\u7121\u304f\u3066 boot.scr \u304c\u3042\u308c\u3070\u3001boot.scr \u3092\u5b9f\u884c\u3059\u308b\n\n\nuEnv.txt\nuEnv.txt \u3067\u306f Linux Kernel \u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u756a\u53f7\u3092\u8a2d\u5b9a\u3057\u3066\u3044\u307e\u3059\u3002\n\nuEnv.txt\nkernel_version=4.8.17\n\n\n\nboot.scr\nboot.scr \u306f\u6b21\u306e\u3088\u3046\u306a\u30b9\u30af\u30ea\u30d7\u30c8(boot.script)\u3092 U-Boot \u7528\u306b\u30b3\u30f3\u30d1\u30a4\u30eb\u3057\u305f\u3082\u306e\u3067\u3059\u3002\n\nboot.script\nif test $config = \"zynq-zybo\"; then\n    echo \"Configuration for \" $config\n    boot_image=zImage-$kernel_version-armv7-fpga\n    fdt_image=devicetree-$kernel_version-zynq-zybo.dtb\n    fpga_image=design_1_wrapper.bit\n    if  fatload mmc 0 0x03000000 $fpga_image; then\n        fpga loadb  0 0x03000000 $filesize\n        mw.l 0xF8000008 0xDF0D\n        mw.l 0xF8000170 0x00100A00\n        mw.l 0xF8000004 0x767B\n    fi\n    fatload mmc 0 0x03000000 $boot_image\n    fatload mmc 0 0x02A00000 $fdt_image\n    setenv bootargs console=ttyPS0,115200 root=/dev/mmcblk0p2 rw rootwait uio_pdrv_genirq.of_id=generic-uio\n    if test $kernel_version = \"4.8.17\"; then\n        setenv bootargs $bootargs sdhci.debug_quirks=64\n    fi\n    bootz 0x03000000 - 0x02A00000\nfi\nif test $config = \"socfpga_cyclone5_de0_nano_soc\"; then\n    echo \"Configuration for \" $config\n    boot_image=zImage-$kernel_version-armv7-fpga\n    fdt_image=devicetree-$kernel_version-socfpga.dtb\n    fpga_image=DE0_NANO_SOC.rbf\n    if  fatload mmc 0 $fpgadata $fpga_image; then\n        fpga load 0   $fpgadata $filesize\n        bridge enable\n    fi\n    fatload mmc 0 $loadaddr $boot_image\n    fatload mmc 0 $fdt_addr $fdt_image\n    setenv bootargs console=ttyS0,115200 root=/dev/mmcblk0p2 rw rootwait uio_pdrv_genirq.of_id=generic-uio\n    bootz $loadaddr - $fdt_addr\nfi\n\n\nU-Boot \u306e\u30d3\u30eb\u30c9\u6642\u306b config \u5909\u6570\u306b\u30dc\u30fc\u30c9\u306e\u7a2e\u985e\u304c\u8a2d\u5b9a\u3055\u308c\u3066\u3044\u3066\u3001\u3053\u306e config \u5909\u6570\u306e\u5024\u306b\u3088\u3063\u3066\u30d6\u30fc\u30c8\u306e\u624b\u9806\u3092\u5207\u308a\u66ff\u3048\u3066\u3044\u307e\u3059\u3002\nuEnv.txt \u3067 kernel_verion \u5909\u6570\u306b Linux \u30ab\u30fc\u30cd\u30eb\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u3092\u8a2d\u5b9a\u3057\u3066\u3001\u305d\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u306b\u5bfe\u5fdc\u3057\u305f\u30ab\u30fc\u30cd\u30eb\u306e\u30a4\u30e1\u30fc\u30b8\u3068\u30c7\u30d0\u30a4\u30b9\u30c4\u30ea\u30fc\u3092\u30ed\u30fc\u30c9\u3059\u308b\u3088\u3046\u306b\u3057\u3066\u3044\u307e\u3059\u3002\n\u306a\u304a\u3001Linux Kernel v4.8.17 \u306b\u306f sdhci \u30c9\u30e9\u30a4\u30d0\u306b\u554f\u984c\u304c\u3042\u3063\u3066\u3001\u305d\u306e\u307e\u307e\u3067\u306f ZYNQ \u3067\u306f\u52d5\u304d\u307e\u305b\u3093\u3002\u305d\u306e\u56de\u907f\u7b56\u3068\u3057\u3066 bootargs \u306b sdhci.debug_quirks=64 \u3092\u8ffd\u52a0\u3057\u3066\u3044\u307e\u3059\u3002\u8a73\u7d30\u306f\u300cZynq + Linux Kernel 4.5(\u4ee5\u964d) \u3067 \"mmc0: Timeout waiting for hardware interrupt\" \u304c\u8d77\u304d\u308b\u5834\u5408\u306e\u5bfe\u51e6\u65b9\u6cd5\u300d \u3092\u53c2\u7167\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n\u53c2\u8003\n\nhttps://github.com/ikwzm/FPGA-SoC-Linux\n\u300cFPGA+SoC+Linux+Device Tree Overlay+FPGA Manager(\u30d6\u30fc\u30c8\u30a4\u30e1\u30fc\u30b8\u306e\u63d0\u4f9b)\u300d@Qiita\n\u300cFPGA+SoC+Linux+Device Tree Overlay+FPGA Manager(ZYBO-Examples)\u300d@Qiita\n\u300cFPGA+SoC+Linux+Device Tree Overlay+FPGA Manager(DE0-Nano-SoC-Examples)\u300d@Qiita\n\u300cZynq + Linux Kernel 4.5(\u4ee5\u964d) \u3067 \"mmc0: Timeout waiting for hardware interrupt\" \u304c\u8d77\u304d\u308b\u5834\u5408\u306e\u5bfe\u51e6\u65b9\u6cd5\u300d@Qiita\n\u77f3\u539f\u3072\u3067\u307f. \u300e\u7b2c\u4e94\u7ae0 \u3064\u3044\u306b\u8d77\u52d5\uff01\u30c7\u30e5\u30a2\u30eb\u30fb\u30d6\u30fc\u30c8 SD \u30ab\u30fc\u30c9\u306e\u4f5c\u308a\u65b9\u300f\u300cFPGA \u30de\u30ac\u30b8\u30f3 No.12\u300d57\u9801\n\n## \u306f\u3058\u3081\u306b\n\n\u4ee5\u4e0b\u306e\u8a18\u4e8b\u3067 Device Tree Overlay \u3068 FPGA Manager \u306b\u5bfe\u5fdc\u3057\u305f FPGA+SoC+Linux \u306e\u52d5\u4f5c\u74b0\u5883\u3092\u7d39\u4ecb\u3057\u307e\u3057\u305f\u3002\n\n* [\u300cFPGA+SoC+Linux+Device Tree Overlay+FPGA Manager(\u30d6\u30fc\u30c8\u30a4\u30e1\u30fc\u30b8\u306e\u63d0\u4f9b)\u300d@Qiita](http://qiita.com/ikwzm/items/cdeb3c9c352776eac683)\n\n\u3055\u3089\u306b\u3001\u4ee5\u4e0b\u306e\u8a18\u4e8b\u3067\u3053\u306e\u30b7\u30b9\u30c6\u30e0\u3092 ZYBO \u3068 DE0-Nano-SoC \u306b\u5bfe\u5fdc\u3057\u305f\u5b9f\u4f8b\u3092\u7d39\u4ecb\u3057\u307e\u3057\u305f\u3002\n\n* [\u300cFPGA+SoC+Linux+Device Tree Overlay+FPGA Manager(ZYBO-Examples)\u300d@Qiita](http://qiita.com/ikwzm/items/61ea3c5a037b83006f17)\n* [\u300cFPGA+SoC+Linux+Device Tree Overlay+FPGA Manager(DE0-Nano-SoC-Examples)\u300d@Qiita](http://qiita.com/ikwzm/items/ca6229d4e32fb421b0a9)\n\n\u4e0a\u3067\u7d39\u4ecb\u3057\u305f\u5b9f\u4f8b\u3067\u306f ZYBO \u3068 DE0-Nano-SoC \u3067\u5225\u3005\u306e SD-Card \u3092\u7528\u610f\u3057\u3066\u3044\u307e\u3057\u305f\u304c\u3001\u3053\u306e\u8a18\u4e8b\u3067\u306f\u30011\u679a\u306e SD-Card \u3067 ZYBO \u3068 DE0-Nano-SoC \u306e\uff12\u7a2e\u985e\u306e\u30dc\u30fc\u30c9\u3067\u8d77\u52d5\u3059\u308b\u65b9\u6cd5\u3092\u7d39\u4ecb\u3057\u307e\u3059\u3002\n\n\u3082\u3068\u3082\u3068\u3001\u3053\u306e\u30c7\u30e5\u30a2\u30eb\u30d6\u30fc\u30c8\u65b9\u6cd5\u306f\u3001\u6b21\u306e\u8cc7\u6599\u306b\u89e6\u767a\u3055\u308c\u305f\u3082\u306e\u3067\u3001\u304a\u304a\u3044\u306b\u53c2\u8003\u306b\u3055\u305b\u3066\u3082\u3089\u3044\u307e\u3057\u305f\u3002\u3053\u306e\u5834\u3092\u501f\u308a\u3066\u304a\u793c\u3092\u7533\u3057\u4e0a\u3052\u307e\u3059\u3002\n\n* \u77f3\u539f\u3072\u3067\u307f. \u300e\u7b2c\u4e94\u7ae0 \u3064\u3044\u306b\u8d77\u52d5\uff01\u30c7\u30e5\u30a2\u30eb\u30fb\u30d6\u30fc\u30c8 SD \u30ab\u30fc\u30c9\u306e\u4f5c\u308a\u65b9\u300f\u300cFPGA \u30de\u30ac\u30b8\u30f3 No.12\u300d57\u9801\n\n## \u8ffd\u8a18\n\n* 2017/1/14 \u306b Linux Kernel \u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u3092 v4.8.17 \u306b\u66f4\u65b0\u3057\u307e\u3057\u305f\u3002\n* 2017/1/31 \u306b udmabuf \u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u3092 v0.6.0 \u306b\u66f4\u65b0\u3057\u307e\u3057\u305f\u3002\n\n## \u6982\u8981\n\n* Hardware\n  + ZYBO : Xilinx Zynq-7000 ARM/FPGA SoC Trainer Board by Digilent\n  + DE0-Nano-SoC : Altera SoC FPGA Development Kit by terasic\n* U-Boot v2016.03 (customized)\n  + Build for ZYBO and DE0-Nano-SoC\n  + Customized boot by uEnv.txt\n  + Customized boot by boot.scr\n* Linux Kernel Version v4.4.7 or v4.8.17\n  + Available in both Xilinx-Zynq-7000 and Altera-SoC in a single image\n  + Enable Device Tree Overlay\n  + Enable FPGA Manager\n* Debian8(jessie) Root File System\n  + Installed build-essential\n  + Installed device-tree-compiler\n  + Installed ruby ruby-msgpack ruby-serialport\n  + Installed u-boot-tools\n* FPGA Device Drivers\n  + dtbocfg     (Device Tree Blob Overlay Configuration File System)\n  + fpgacfg     (FPGA Configuration Interface for Linux FPGA Manager Framework)\n  + fclkcfg     (FPGA Clock Configuration Device Driver)\n  + udmabuf     (User space mappable DMA Buffer)\n  + zptty       (Pseudo TeleTYpewriter for FPGA Device)\n  + fpga-bridge (FPGA to/from HPS Bridge Driver for Altera SoCFPGA Devices)\n\n## \u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n### \u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\n\ngithub \u304b\u3089\u6b21\u306e\u3088\u3046\u306b\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\u73fe\u6642\u70b9\u306e\u6700\u65b0\u30d0\u30fc\u30b8\u30e7\u30f3\u306f v0.2.0 \u3067\u3059\u3002\u30c1\u30a7\u30c3\u30af\u30a2\u30a6\u30c8\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\u306a\u304a\u3001\u3044\u304f\u3064\u304b\u306e\u30a4\u30e1\u30fc\u30b8\u30d5\u30a1\u30a4\u30eb\u306f\u304b\u306a\u308a\u5927\u304d\u3044\u306e\u3067\u3001Git LFS(Large File Storage)\u3092\u4f7f\u3063\u3066\u3044\u307e\u3059\u3002\n\u304a\u4f7f\u3044\u306e\u74b0\u5883\u306b git-lfs \u304c\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3055\u308c\u3066\u3044\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\n```\nshell$ git clone git://github.com/ikwzm/FPGA-SoC-Linux\nshell$ cd FPGA-SoC-Linux\nshell$ git checkout v0.2.0\nshell$ git lfs pull\n```\n\n### Build boot files\n\nZYBO \u7528\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3068 DE0-Nano-SoC \u7528\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u304b\u3089\u5fc5\u8981\u306a\u30d5\u30a1\u30a4\u30eb\u3092\u30c7\u30e5\u30a2\u30eb\u30fb\u30d6\u30fc\u30c8\u7528\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea(target/zynq-zybo-de0-nano-soc)\u306b\u30b3\u30d4\u30fc\u3057\u307e\u3059\u3002\ntarget/zynq-zybo-de0-nano-soc/Makefile \u3092\u7528\u610f\u3057\u3066\u3044\u307e\u3059\u306e\u3067\u6d3b\u7528\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n```\nshell$ cd target/zynq-zybo-de0-nano-soc/\nshell$ make\nmkimage -A arm -O linux -T script -C none -a 0 -e 0 -n \"linux boot script\" -d boot/boot.script boot/boot.scr\nImage Name:   linux boot script\nCreated:      Fri Jan 13 17:05:07 2017\nImage Type:   ARM Linux Script (uncompressed)\nData Size:    1324 Bytes = 1.29 kB = 0.00 MB\nLoad Address: 00000000\nEntry Point:  00000000\nContents:\n   Image 0: 1316 Bytes = 1.29 kB = 0.00 MB\ncp ../zynq-zybo/boot/zImage-4.8.17-armv7-fpga boot/zImage-4.8.17-armv7-fpga\ncp ../zynq-zybo/boot/boot.bin boot/boot.bin\ncp ../zynq-zybo/boot/design_1_wrapper.bit boot/design_1_wrapper.bit\ncp ../zynq-zybo/boot/devicetree-4.8.17-zynq-zybo.dtb boot/devicetree-4.8.17-zynq-zybo.dtb\ncp ../zynq-zybo/boot/devicetree-4.8.17-zynq-zybo.dts boot/devicetree-4.8.17-zynq-zybo.dts\ncp ../zynq-zybo/boot/u-boot.img boot/u-boot.img\ncp ../de0-nano-soc//boot/devicetree-4.8.17-socfpga.dtb boot/devicetree-4.8.17-socfpga.dtb\ncp ../de0-nano-soc//boot/devicetree-4.8.17-socfpga.dts boot/devicetree-4.8.17-socfpga.dts\ncp ../de0-nano-soc//boot/DE0_NANO_SOC.rbf boot/DE0_NANO_SOC.rbf\ncp ../de0-nano-soc//u-boot/u-boot-spl.sfp u-boot/u-boot-spl.sfp\ncp ../de0-nano-soc//u-boot/u-boot.img u-boot/u-boot.img\n```\n\n### \u30d5\u30a1\u30a4\u30eb\u306e\u8aac\u660e\n\n\u30c7\u30e5\u30a2\u30eb\u30fb\u30d6\u30fc\u30c8\u7528\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea(tareget/zynq-zybo-de0-nano-soc)\u306b\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u30d5\u30a1\u30a4\u30eb\u304c\u3042\u308a\u307e\u3059\u3002\n\n * tareget/zynq-zybo-de0-nano-soc/\n   + boot/\n     - boot.bin                                                  : Stage 1 Boot Loader      (for ZYBO U-boot-spl)\n     - u-boot.img                                                : Stage 2 Boot Loader      (for ZYBO U-boot image)\n     - uEnv.txt                                                  : U-Boot environment variables for set kernel version\n     - boot.script                                               : U-Boot boot script       (source)\n     - boot.scr                                                  : U-Boot boot script       (binary)\n     - design_1_wrapper.bit                                      : FPGA configuration file  (for ZYBO)\n     - DE0_NANO_SOC.rbf                                          : FPGA configuration file  (for DE0-Nano-SoC)\n     - zImage-4.8.17-armv7-fpga                                  : Linux Kernel Image\n     - devicetree-4.8.17-zynq-zybo.dtb                           : Linux Device Tree Blob   (for ZYBO)\n     - devicetree-4.8.17-zynq-zybo.dts                           : Linux Device Tree Source (for ZYBO)\n     - devicetree-4.8.17-socfpga.dtb                             : Linux Device Tree Blob   (for DE0-Nano-SoC)\n     - devicetree-4.8.17-socfpga.dts                             : Linux Device Tree Source (for DE0-Nano-SoC)\n   + u-boot/\n     - u-boot-spl.sfp                                            : Stage 1 Boot Loader      (for DE0-Nano-SoC U-boot-spl)\n     - u-boot.img                                                : Stage 2 Boot Loader      (for DE0-Nano-SoC U-boot image)\n * debian8-rootfs-vanilla.tgz                                    : Debian8 Root File System (use Git LFS)\n * linux-image-4.8.17-armv7-fpga_4.8.17-armv7-fpga-1_armhf.deb   : Linux Image Package      (use Git LFS)\n * linux-headers-4.8.17-armv7-fpga_4.8.17-armv7-fpga-1_armhf.deb : Linux Headers Package    (use Git LFS)\n * fpga-soc-linux-drivers-4.8.17-armv7-fpga_0.0.3-1_armhf.deb    : Device Drivers Package   (use Git LFS)\n\n\n### SD-Card \u306e\u30d5\u30a9\u30fc\u30de\u30c3\u30c8\n\nSD-Card \u306e\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\uff11\u3092 FAT File System \u3067\u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0\u3092\u4f5c\u308a\u307e\u3059\u3002\nSD-Card \u306e\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\uff12\u3092 ext3 File System \u3067\u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0\u3092\u4f5c\u308a\u307e\u3059\u3002\nSD-Card \u306e\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\uff13\u3092 \u7279\u6b8a\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3(\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u30bf\u30a4\u30d7=0xa2)\u306b\u3057\u307e\u3059\u3002\u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0\u306f\u4f5c\u308a\u307e\u305b\u3093\u3002\n\u30d5\u30a9\u30fc\u30de\u30c3\u30c8\u65b9\u6cd5\u306e\u8a73\u7d30\u306f\u300e\u7b2c\u4e94\u7ae0 \u3064\u3044\u306b\u8d77\u52d5\uff01\u30c7\u30e5\u30a2\u30eb\u30fb\u30d6\u30fc\u30c8 SD \u30ab\u30fc\u30c9\u306e\u4f5c\u308a\u65b9\u300f\u300cFPGA \u30de\u30ac\u30b8\u30f3 No.12\u300d\u3092\u53c2\u7167\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n### SD-Card \u3078\u306e\u66f8\u304d\u8fbc\u307f\n\nSD-Card \u306e\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\uff13(\u4e0b\u306e\u4f8b\u3067\u306f/dev/sdc3)\u306b target/zynq-zybo-de0-nano-soc/u-boot/ \u4e0b\u306e\u30d5\u30a1\u30a4\u30eb\u30a4\u30e1\u30fc\u30b8\u3092 dd \u3092\u4f7f\u3063\u3066\u66f8\u304d\u8fbc\u307f\u307e\u3059\u3002\nSD-Card \u306e\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\uff11(\u4e0b\u306e\u4f8b\u3067\u306f/dev/sdc1)\u306b target/zynq-zybo-de0-nano-soc/boot/ \u4e0b\u306e\u30d5\u30a1\u30a4\u30eb\u3092\u30b3\u30d4\u30fc\u3057\u307e\u3059\u3002\nSD-Card \u306e\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\uff12(\u4e0b\u306e\u4f8b\u3067\u306f/dev/sdc2)\u306b debian8-rootfs-vanilla.tgz \u306e\u4e2d\u8eab\u3092\u5c55\u958b\u3057\u307e\u3059\u3002\n\u307e\u305f\u3001\u5c55\u958b\u3057\u305f\u30eb\u30fc\u30c8\u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0\u306e home/fpga \u306b fpga-soc-linux-drivers \u30d1\u30c3\u30b1\u30fc\u30b8\u3092\u3042\u3089\u304b\u3058\u3081\u30b3\u30d4\u30fc\u3057\u3066\u304a\u304f\u3068\u826f\u3044\u3067\u3057\u3087\u3046\u3002\u5f8c\u304b\u3089 network \u7d4c\u7531\u3067\u30b3\u30d4\u30fc\u3057\u3066\u3082\u304b\u307e\u3044\u307e\u305b\u3093\u3002\n\n````\nshell# mount /dev/sdc1 /mnt/usb1\nshell# mount /dev/sdc2 /mnt/usb2\nshell# cp target/zynq-zybo-de0-nano-soc/boot/*                          /mnt/usb1\nshell# dd if=target/zynq-zybo-de0-nano-soc/u-boot/u-boot-spl.sfp of=/dev/sdc3 bs=64k seek=0\nshell# dd if=target/zynq-zybo-de0-nano-soc/u-boot/u-boot.img     of=/dev/sdc3 bs=64k seek=4\nshell# tar xfz debian8-rootfs-vanilla.tgz -C                            /mnt/usb2\nshell# cp linux-image-4.8.17-armv7-fpga_4.8.17-armv7-fpga-1_armhf.deb   /mnt/usb2/home/fpga\nshell# cp linux-headers-4.8.17-armv7-fpga_4.8.17-armv7-fpga-1_armhf.deb /mnt/usb2/home/fpga\nshell# cp fpga-soc-linux-drivers-4.8.17-armv7-fpga_0.0.3-1_armhf.deb    /mnt/usb2/home/fpga\nshell# umount mnt/usb1\nshell# umount mnt/usb2\n````\n\n### \u30c7\u30d0\u30a4\u30b9\u30c9\u30e9\u30a4\u30d0\u30d1\u30c3\u30b1\u30fc\u30b8\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n\u7701\u7565\u3057\u307e\u3059\u3002[\u300cFPGA+SoC+Linux+Device Tree Overlay+FPGA Manager(\u30d6\u30fc\u30c8\u30a4\u30e1\u30fc\u30b8\u306e\u63d0\u4f9b)\u300d](http://qiita.com/ikwzm/items/cdeb3c9c352776eac683) \u3092\u53c2\u7167\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n\n## \u30c7\u30e5\u30a2\u30eb\u30fb\u30d6\u30fc\u30c8\u306e\u3057\u304f\u307f\n\n\uff11\u679a\u306e SD-Card \u3067 ZYNQ \u3068 DE0-Nano-SoC \u306e\u4e21\u65b9\u3092\u30d6\u30fc\u30c8\u3059\u308b\u3057\u304f\u307f\u306b\u95a2\u3057\u3066\u306f\u300e\u7b2c\u4e94\u7ae0 \u3064\u3044\u306b\u8d77\u52d5\uff01\u30c7\u30e5\u30a2\u30eb\u30fb\u30d6\u30fc\u30c8 SD \u30ab\u30fc\u30c9\u306e\u4f5c\u308a\u65b9\u300f\u3092\u53c2\u7167\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n\u3053\u3053\u3067\u306f\u3001U-Boot \u304c\u30b9\u30af\u30ea\u30d7\u30c8\u306b\u3088\u3063\u3066 ZYBO \u3068 DE0-Nano-SoC \u3067\u30d6\u30fc\u30c8\u624b\u9806\u3092\u5207\u308a\u66ff\u3048\u308b\u624b\u6cd5\u306e\u8aac\u660e\u3092\u3057\u307e\u3059\u3002\n\n### U-Boot \u306e\u6539\u826f\n\n[https://github.com/ikwzm/FPGA-SoC-Linux](https://github.com/ikwzm/FPGA-SoC-Linux)\u3067\u7528\u610f\u3057\u305f U-Boot \u306b\u306f\u3001\u30bd\u30fc\u30b9\u30b3\u30fc\u30c9\u306b\u5c11\u3057\u7d30\u5de5\u304c\u3057\u3066\u3042\u308a\u307e\u3059\u3002\n\nZYBO \u7528\u306e U-Boot \u306e\u30bd\u30fc\u30b9\u30b3\u30fc\u30c9\u306b\u306f\u6b21\u306e\u3088\u3046\u306a\u30d1\u30c3\u30c1\u3092\u3042\u3066\u3066\u3044\u307e\u3059\u3002\n\n```\ndiff --git configs/zynq_zybo_defconfig configs/zynq_zybo_defconfig\nindex 7c23fec..8fc954e 100644\n--- configs/zynq_zybo_defconfig\n+++ configs/zynq_zybo_defconfig\n@@ -22,3 +22,5 @@ CONFIG_DEBUG_UART_ZYNQ=y\n CONFIG_DEBUG_UART_BASE=0xe0001000\n CONFIG_DEBUG_UART_CLOCK=50000000\n CONFIG_ZYNQ_QSPI=y\n+# CONFIG_OF_SEPARATE is not set\n+CONFIG_OF_EMBED=y\ndiff --git include/configs/zynq-common.h include/configs/zynq-common.h\nindex 982905d..fd50c69 100644\n--- include/configs/zynq-common.h\n+++ include/configs/zynq-common.h\n@@ -227,10 +227,35 @@\n \t\"usbboot=if usb start; then \" \\\n \t\t\t\"echo Copying FIT from USB to RAM... && \" \\\n \t\t\t\"load usb 0 ${load_addr} ${fit_image} && \" \\\n-\t\t\t\"bootm ${load_addr}; fi\\0\" \\\n-\t\tDFU_ALT_INFO\n-\n-#define CONFIG_BOOTCOMMAND\t\t\"run $modeboot\"\n+\t\t\t\"bootm ${load_addr}\\0\" \\\n+\t\t\"fi\\0\" \\\n+\t\"bootenv=uEnv.txt\\0\" \\\n+        \"config=\" CONFIG_DEFAULT_DEVICE_TREE \"\\0\" \\\n+\t\"loadbootenv=load mmc 0 ${load_addr} ${bootenv}\\0\" \\\n+\t\"importbootenv=echo Importing environment from mmc ...;\" \\\n+\t\t\"env import -t $load_addr $filesize\\0\" \\\n+        \"loadbootscript=load mmc 0 ${load_addr} boot.scr\\0\" \\\n+        \"bootscript=echo Running bootscript from mmc ...;\" \\\n+                \"source ${load_addr}\\0\" \\\n+\tDFU_ALT_INFO\n+\n+#define CONFIG_BOOTCOMMAND \\\n+\t\"if mmc rescan; then \" \\\n+\t\t\"echo SD/MMC found on device...;\" \\\n+\t\t\"if run loadbootenv; then \" \\\n+\t\t\t\"echo Loaded environment from ${bootenv};\" \\\n+\t\t\t\"run importbootenv;\" \\\n+\t\t\"fi;\" \\\n+\t\t\"if test -n $uenvcmd; then \" \\\n+\t\t\t\"echo Running uenvcmd ...;\" \\\n+\t\t\t\"run uenvcmd;\" \\\n+\t\t\"fi;\" \\\n+\t\t\"if run loadbootscript; then \" \\\n+\t\t\t\"run bootscript; \" \\\n+\t\t\"fi; \" \\\n+\t\"fi;\" \\\n+        \"run $modeboot\"\n+#define CONFIG_CMD_BOOTZ\n #define CONFIG_BOOTDELAY\t\t3 /* -1 to Disable autoboot */\n #define CONFIG_SYS_LOAD_ADDR\t\t0 /* default? */\n```\n\nDE0-Nano-SoC \u7528\u306e U-Boot \u306e\u30bd\u30fc\u30b9\u30b3\u30fc\u30c9\u306b\u306f\u6b21\u306e\u3088\u3046\u306a\u30d1\u30c3\u30c1\u3092\u3042\u3066\u3066\u3044\u307e\u3059\u3002\n\n```\ndiff --git include/configs/socfpga_de0_nano_soc.h include/configs/socfpga_de0_nano_soc.h\nindex cbc7396..1b68bdb 100644\n--- include/configs/socfpga_de0_nano_soc.h\n+++ include/configs/socfpga_de0_nano_soc.h\n@@ -37,7 +37,22 @@\n #define CONFIG_BOOTDELAY\t3\n #define CONFIG_BOOTFILE\t\t\"fitImage\"\n #define CONFIG_BOOTARGS\t\t\"console=ttyS0,\" __stringify(CONFIG_BAUDRATE)\n-#define CONFIG_BOOTCOMMAND\t\"run mmcload; run mmcboot\"\n+#define CONFIG_BOOTCOMMAND     \\\n+\t\"if mmc rescan; then \" \\\n+\t\t\"echo SD/MMC found on device...;\" \\\n+\t\t\"if run loadbootenv; then \" \\\n+\t\t\t\"echo Loaded environment from ${bootenv};\" \\\n+\t\t\t\"run importbootenv;\" \\\n+\t\t\"fi;\" \\\n+\t\t\"if test -n $uenvcmd; then \" \\\n+\t\t\t\"echo Running uenvcmd ...;\" \\\n+\t\t\t\"run uenvcmd;\" \\\n+\t\t\"fi;\" \\\n+\t\t\"if run loadbootscript; then \" \\\n+\t\t\t\"run bootscript; \" \\\n+\t\t\"fi; \" \\\n+\t\"fi;\" \\\n+        \"run mmcload; run mmcboot\"\n #define CONFIG_LOADADDR\t\t0x01000000\n #define CONFIG_SYS_LOAD_ADDR\tCONFIG_LOADADDR\n \n@@ -65,6 +80,15 @@\n \t\"mmcload=mmc rescan;\" \\\n \t\t\"load mmc 0:1 ${loadaddr} ${bootimage};\" \\\n \t\t\"load mmc 0:1 ${fdt_addr} ${fdtimage}\\0\" \\\n+        \"fpgadata=0x02000000\\0\" \\\n+\t\"bootenv=uEnv.txt\\0\" \\\n+\t\"config=\" CONFIG_DEFAULT_DEVICE_TREE \"\\0\" \\\n+\t\"loadbootenv=load mmc 0 ${loadaddr} ${bootenv}\\0\" \\\n+\t\"importbootenv=echo Importing environment from mmc ...;\" \\\n+\t\t\"env import -t $loadaddr $filesize\\0\" \\\n+        \"loadbootscript=load mmc 0 ${loadaddr} boot.scr\\0\" \\\n+        \"bootscript=echo Running bootscript from mmc ...;\" \\\n+                \"source ${loadaddr}\\0\" \\\n \n /* The rest of the configuration is shared */\n #include <configs/socfpga_common.h>\n```\n\n\u3044\u305a\u308c\u306e\u30d1\u30c3\u30c1\u3082\u6b21\u306e\u3088\u3046\u306a\u4fee\u6b63\u3092\u3057\u3066\u3044\u307e\u3059\u3002\n\n1. config \u5909\u6570\u306b U-Boot \u30d3\u30eb\u30c9\u6642\u306e\u30dc\u30fc\u30c9\u540d\u3092\u8a2d\u5b9a\u3059\u308b\n2. \u30d6\u30fc\u30c8\u6642\u306b uEnv.txt \u3092\u8aad\u3093\u3067\u74b0\u5883\u5909\u6570\u3092\u8a2d\u5b9a\u3059\u308b\n3. \u30d6\u30fc\u30c8\u6642\u306b uEnv.txt \u306b uenvcmd \u5909\u6570\u304c\u8a2d\u5b9a\u3055\u308c\u3066\u3044\u305f\u5834\u5408\u306f\u3053\u308c\u3092\u5b9f\u884c\u3059\u308b\n4. \u30d6\u30fc\u30c8\u6642\u306b uenvcmd \u304c\u7121\u304f\u3066 boot.scr \u304c\u3042\u308c\u3070\u3001boot.scr \u3092\u5b9f\u884c\u3059\u308b\n\n### uEnv.txt\n\nuEnv.txt \u3067\u306f Linux Kernel \u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u756a\u53f7\u3092\u8a2d\u5b9a\u3057\u3066\u3044\u307e\u3059\u3002\n\n```:uEnv.txt\nkernel_version=4.8.17\n```\n\n### boot.scr\n\nboot.scr \u306f\u6b21\u306e\u3088\u3046\u306a\u30b9\u30af\u30ea\u30d7\u30c8(boot.script)\u3092 U-Boot \u7528\u306b\u30b3\u30f3\u30d1\u30a4\u30eb\u3057\u305f\u3082\u306e\u3067\u3059\u3002\n\n```:boot.script\nif test $config = \"zynq-zybo\"; then\n    echo \"Configuration for \" $config\n    boot_image=zImage-$kernel_version-armv7-fpga\n    fdt_image=devicetree-$kernel_version-zynq-zybo.dtb\n    fpga_image=design_1_wrapper.bit\n    if  fatload mmc 0 0x03000000 $fpga_image; then\n        fpga loadb  0 0x03000000 $filesize\n        mw.l 0xF8000008 0xDF0D\n        mw.l 0xF8000170 0x00100A00\n        mw.l 0xF8000004 0x767B\n    fi\n    fatload mmc 0 0x03000000 $boot_image\n    fatload mmc 0 0x02A00000 $fdt_image\n    setenv bootargs console=ttyPS0,115200 root=/dev/mmcblk0p2 rw rootwait uio_pdrv_genirq.of_id=generic-uio\n    if test $kernel_version = \"4.8.17\"; then\n        setenv bootargs $bootargs sdhci.debug_quirks=64\n    fi\n    bootz 0x03000000 - 0x02A00000\nfi\nif test $config = \"socfpga_cyclone5_de0_nano_soc\"; then\n    echo \"Configuration for \" $config\n    boot_image=zImage-$kernel_version-armv7-fpga\n    fdt_image=devicetree-$kernel_version-socfpga.dtb\n    fpga_image=DE0_NANO_SOC.rbf\n    if  fatload mmc 0 $fpgadata $fpga_image; then\n        fpga load 0   $fpgadata $filesize\n        bridge enable\n    fi\n    fatload mmc 0 $loadaddr $boot_image\n    fatload mmc 0 $fdt_addr $fdt_image\n    setenv bootargs console=ttyS0,115200 root=/dev/mmcblk0p2 rw rootwait uio_pdrv_genirq.of_id=generic-uio\n    bootz $loadaddr - $fdt_addr\nfi\n```\n\nU-Boot \u306e\u30d3\u30eb\u30c9\u6642\u306b config \u5909\u6570\u306b\u30dc\u30fc\u30c9\u306e\u7a2e\u985e\u304c\u8a2d\u5b9a\u3055\u308c\u3066\u3044\u3066\u3001\u3053\u306e config \u5909\u6570\u306e\u5024\u306b\u3088\u3063\u3066\u30d6\u30fc\u30c8\u306e\u624b\u9806\u3092\u5207\u308a\u66ff\u3048\u3066\u3044\u307e\u3059\u3002\n\nuEnv.txt \u3067 kernel_verion \u5909\u6570\u306b Linux \u30ab\u30fc\u30cd\u30eb\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u3092\u8a2d\u5b9a\u3057\u3066\u3001\u305d\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u306b\u5bfe\u5fdc\u3057\u305f\u30ab\u30fc\u30cd\u30eb\u306e\u30a4\u30e1\u30fc\u30b8\u3068\u30c7\u30d0\u30a4\u30b9\u30c4\u30ea\u30fc\u3092\u30ed\u30fc\u30c9\u3059\u308b\u3088\u3046\u306b\u3057\u3066\u3044\u307e\u3059\u3002\n\n\u306a\u304a\u3001Linux Kernel v4.8.17 \u306b\u306f sdhci \u30c9\u30e9\u30a4\u30d0\u306b\u554f\u984c\u304c\u3042\u3063\u3066\u3001\u305d\u306e\u307e\u307e\u3067\u306f ZYNQ \u3067\u306f\u52d5\u304d\u307e\u305b\u3093\u3002\u305d\u306e\u56de\u907f\u7b56\u3068\u3057\u3066 bootargs \u306b sdhci.debug_quirks=64 \u3092\u8ffd\u52a0\u3057\u3066\u3044\u307e\u3059\u3002\u8a73\u7d30\u306f[\u300cZynq + Linux Kernel 4.5(\u4ee5\u964d) \u3067 \"mmc0: Timeout waiting for hardware interrupt\" \u304c\u8d77\u304d\u308b\u5834\u5408\u306e\u5bfe\u51e6\u65b9\u6cd5\u300d](http://qiita.com/ikwzm/items/9d64d9583f8e3eb5c94a) \u3092\u53c2\u7167\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n## \u53c2\u8003\n\n* [https://github.com/ikwzm/FPGA-SoC-Linux](https://github.com/ikwzm/FPGA-SoC-Linux)\n* [\u300cFPGA+SoC+Linux+Device Tree Overlay+FPGA Manager(\u30d6\u30fc\u30c8\u30a4\u30e1\u30fc\u30b8\u306e\u63d0\u4f9b)\u300d@Qiita](http://qiita.com/ikwzm/items/cdeb3c9c352776eac683)\n* [\u300cFPGA+SoC+Linux+Device Tree Overlay+FPGA Manager(ZYBO-Examples)\u300d@Qiita](http://qiita.com/ikwzm/items/61ea3c5a037b83006f17)\n* [\u300cFPGA+SoC+Linux+Device Tree Overlay+FPGA Manager(DE0-Nano-SoC-Examples)\u300d@Qiita](http://qiita.com/ikwzm/items/ca6229d4e32fb421b0a9)\n* [\u300cZynq + Linux Kernel 4.5(\u4ee5\u964d) \u3067 \"mmc0: Timeout waiting for hardware interrupt\" \u304c\u8d77\u304d\u308b\u5834\u5408\u306e\u5bfe\u51e6\u65b9\u6cd5\u300d@Qiita](http://qiita.com/ikwzm/items/9d64d9583f8e3eb5c94a)\n\n* \u77f3\u539f\u3072\u3067\u307f. \u300e\u7b2c\u4e94\u7ae0 \u3064\u3044\u306b\u8d77\u52d5\uff01\u30c7\u30e5\u30a2\u30eb\u30fb\u30d6\u30fc\u30c8 SD \u30ab\u30fc\u30c9\u306e\u4f5c\u308a\u65b9\u300f\u300cFPGA \u30de\u30ac\u30b8\u30f3 No.12\u300d57\u9801\n", "tags": ["FPGA", "Linux", "zynq", "zybo", "Atlas-SoC"]}