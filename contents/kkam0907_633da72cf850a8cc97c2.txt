{"context": "\n\n\u6982\u8981\nkubernetes\u3067redis cluster\u69cb\u7bc9\u3057\u3066\u307f\u305f\u5099\u5fd8\u9332\nhttps://github.com/kelseyhightower/kubernetes-redis-cluster\n\u307b\u307c\u3053\u3061\u3089\u3092\u305d\u306e\u307e\u307e\u4f7f\u3063\u3066\u3044\u308b\n\nRedis server version\u30013.2.0\n\u30c7\u30fc\u30bf\u306e\u6c38\u7d9a\u5316\u306f\u3057\u306a\u3044\nredis\u30af\u30e9\u30b9\u30bf\u57fa\u672cmaster\u00d73\u306b\u30ec\u30d7\u30ea\u30ab\u7528 slave\u00d73\n\nredis (loadbalancer) \n  |\n  |- [ redis-1(master) ] - [redis-4(slave)]\n  |- [ redis-2(master) ] - [redis-5(slave)]\n  |- [ redis-3(master) ] - [redis-6(slave)]\n\n\n\nmaxmemory-policy \u306f\u3001\u30c7\u30d5\u30a9\u30eb\u30c8volatile-lru\n\n\n`volatile-lru` remove the key with an expire set using an LRU algorithm\n\n\u30bb\u30c3\u30b7\u30e7\u30f3\u4fdd\u5b58\u6642\u306b\u3001\u6709\u52b9\u671f\u9650\u3092\u8a2d\u5b9a\u3059\u308b\u60f3\u5b9a\nredis-1 ~ redis6\u3082replicaset\u3067pod\u4f5c\u6210\u3057\u3066\u3044\u308b\u306e\u3067\u8a2d\u5b9a\u3092\u5909\u3048\u308c\u3070\u8907\u6570pod\u8d77\u52d5\u53ef\u80fd\u3002\n1pod\u305a\u3064\u3067\u4ee5\u4e0b\u69cb\u7bc9\u3068\u78ba\u8a8d\u3092\u884c\u3046\u3002\n\n\u30bd\u30fc\u30b9\nhttps://github.com/lovelytokyo/kubernetes-redis-cluster\n\n\u69cb\u7bc9\n\nkubernetes\u3067replicaset\u3068service\u3067pod\u3068loadbalancer\u3092\u8d77\u52d5\u3059\u308b\n\n$ kubectl create configmap redis-conf --from-file=redis.conf \n$ kubectl create -f replicasets\n$ kubectl create -f services\n\n\npod\u3092redis cluster\u306b\u7e4b\u3050\n\nredis cluster\u4f5c\u6210\u30b3\u30de\u30f3\u30c9\u5b9f\u884c\u7528pod\u3092\u8d77\u52d5\u3059\u308b\n$ kubectl run -i --tty ubuntu --image=ubuntu --restart=Never /bin/bash\n\n\n\u5fc5\u8981\u306a\u30e9\u30a4\u30d6\u30e9\u30ea\u30fc\u985e\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\n$ apt-get update\n$ apt-get install ruby vim wget redis-tools\n$ gem install redis\n$ wget http://download.redis.io/redis-stable/src/redis-trib.rb\n$ chmod 755 redis-trib.rb\n\nredis cluster\u3092\u4f5c\u6210\u3059\u308b\n$ ./redis-trib.rb create --replicas 1 \\\n  10.107.255.1:6379 \\\n  10.107.255.2:6379 \\\n  10.107.255.3:6379 \\\n  10.107.255.4:6379 \\\n  10.107.255.5:6379 \\\n  10.107.255.6:6379\n>>> Creating cluster\n>>> Performing hash slots allocation on 6 nodes...\nUsing 3 masters:\n10.107.255.1:6379\n10.107.255.2:6379\n10.107.255.3:6379\nAdding replica 10.107.255.4:6379 to 10.107.255.1:6379\nAdding replica 10.107.255.5:6379 to 10.107.255.2:6379\nAdding replica 10.107.255.6:6379 to 10.107.255.3:6379\nM: d4dfb6366289f581e395428811af4bb6e1f07e2d 10.107.255.1:6379   10.104.1.34\n   slots:0-5460 (5461 slots) master\nM: 4b23c907ef408e5efd6225fffd11a6cdff5de337 10.107.255.2:6379   10.104.1.35\n   slots:5461-10922 (5462 slots) master\nM: 189ee8e87202326675adef4f507a80b5b5873369 10.107.255.3:6379   10.104.1.36\n   slots:10923-16383 (5461 slots) master\nS: 37b2b6b625d8bfba7c8997abfe894df099761937 10.107.255.4:6379   10.104.1.37\n   replicates d4dfb6366289f581e395428811af4bb6e1f07e2d\nS: f2229c73056a819f3cee6521d231e65ce1f4c180 10.107.255.5:6379   10.104.0.14\n   replicates 4b23c907ef408e5efd6225fffd11a6cdff5de337\nS: ad1aa4c73849622068c96976998f778673a2ce4c 10.107.255.6:6379   10.104.1.38\n   replicates 189ee8e87202326675adef4f507a80b5b5873369\nCan I set the above configuration? (type 'yes' to accept): yes\n>>> Nodes configuration updated\n>>> Assign a different config epoch to each node\n>>> Sending CLUSTER MEET messages to join the cluster\nWaiting for the cluster to join..\n>>> Performing Cluster Check (using node 10.107.255.1:6379)\nM: d4dfb6366289f581e395428811af4bb6e1f07e2d 10.107.255.1:6379\n   slots:0-5460 (5461 slots) master\n   1 additional replica(s)\nM: 189ee8e87202326675adef4f507a80b5b5873369 10.104.1.36:6379\n   slots:10923-16383 (5461 slots) master\n   1 additional replica(s)\nM: 4b23c907ef408e5efd6225fffd11a6cdff5de337 10.104.1.35:6379\n   slots:5461-10922 (5462 slots) master\n   1 additional replica(s)\nS: ad1aa4c73849622068c96976998f778673a2ce4c 10.104.1.38:6379\n   slots: (0 slots) slave\n   replicates 189ee8e87202326675adef4f507a80b5b5873369\nS: f2229c73056a819f3cee6521d231e65ce1f4c180 10.104.0.14:6379\n   slots: (0 slots) slave\n   replicates 4b23c907ef408e5efd6225fffd11a6cdff5de337\nS: 37b2b6b625d8bfba7c8997abfe894df099761937 10.104.1.37:6379\n   slots: (0 slots) slave\n   replicates d4dfb6366289f581e395428811af4bb6e1f07e2d\n[OK] All nodes agree about slots configuration.\n>>> Check for open slots...\n>>> Check slots coverage...\n[OK] All 16384 slots covered.\n\n\n\u78ba\u8a8d\n\ndocker\u3092\u843d\u3068\u3057\u3066\u3082\u4ed6\u306eredis\u30ce\u30fc\u30c9\u304b\u3089\u5024\u304c\u5e30\u3063\u3066\u304f\u308b\u4e8b\u3092\u78ba\u8a8d\u3059\u308b\n\n master\u30921pod\u6b62\u3081\u3066\u3001\u81ea\u52d5\u8d77\u52d5\u3059\u308b\u304b\u78ba\u8a8d\u3059\u308b\n\npod\u4e00\u89a7\n$ kubectl get pods --show-all\nNAME            READY     STATUS    RESTARTS   AGE\nredis-1-2pg4v   1/1       Running   0          56m\nredis-2-fbzks   1/1       Running   0          56m\nredis-3-4fs93   1/1       Running   0          56m\nredis-4-pjxt1   1/1       Running   0          56m\nredis-5-bt1wm   1/1       Running   0          56m\nredis-6-qpvvl   1/1       Running   0          56m\nubuntu          1/1       Running   0          20m\n\nredis-1(master)pod\u3092\u6b62\u3081\u308b\n$ kubectl stop pod redis-1-2pg4v\nCommand \"stop\" is deprecated, use \"delete\" instead.\npod \"redis-1-2pg4v\" deleted\n\npod\u4e00\u89a7\n$ kubectl get pods --show-all\nNAME            READY     STATUS    RESTARTS   AGE\nredis-1-b7blk   1/1       Running   0          3m \u3000\u2190 redis-1(master)\u306epod\u304c\u65b0\u305f\u306b\u8d77\u52d5\u3055\u308c\u305f\nredis-2-fbzks   1/1       Running   0          1h\nredis-3-4fs93   1/1       Running   0          1h\nredis-4-pjxt1   1/1       Running   0          1h\nredis-5-bt1wm   1/1       Running   0          1h\nredis-6-qpvvl   1/1       Running   0          1h\nubuntu          1/1       Running   0          24m\n\n\ndocker\u3092\u6b62\u3081\u3066\u3082\u6b63\u5e38\u306b\u30c7\u30fc\u30bf\u53d6\u5f97\u3067\u304d\u308b\u304b\n\na12948@gke-satsuma-redis-default-pool-f99bcf1a-cft1 ~ $ docker ps -a | grep redis-server\n4b1cac0124e9        redis:3.2.0-alpine                                                     \"redis-server /etc/re\"   8 minutes ago       Up 8 minutes                                   k8s_redis.638d2d73_redis-1-b7blk_default_2df04edf-e91c-11e6-999b-42010af00135_72d2a8a6\n6fef91ca8ca5        redis:3.2.0-alpine                                                     \"redis-server /etc/re\"   5 hours ago         Exited (0) 8 minutes ago                       k8s_redis.638d2d73_redis-1-b7blk_default_2df04edf-e91c-11e6-999b-42010af00135_74b5a100\n\n$ kubectl exec -it ubuntu sh\n# redis-cli -h 10.107.244.37 -c\n10.107.244.37:6379> get hoge\n\"fuga\"\n10.107.244.37:6379> get hogehoge\n\"fugafuga\"\n\n\n\u30ce\u30fc\u30c9\u3092\u843d\u3068\u3057\u3066\u3082redis\u30ce\u30fc\u30c9\u304b\u3089\u5024\u304c\u5e30\u3063\u3066\u304f\u308b\u4e8b\u3092\u78ba\u8a8d\u3059\u308b\n\uff01\uff01container cluster\u306enode\u304c1\u3064\u306b\u306a\u3063\u3066\u3057\u307e\u3046\u3068\u81ea\u52d5\u8d77\u52d5\u3067\u3044\u306a\u3044pod\u304c\u3067\u304d\u3066\u3057\u307e\u3046\u305f\u3081\u3001\n\u5c11\u306a\u304f\u3066\u30822\u3064\u306enode\u304c\u5fc5\u8981\u3067\u3042\u308b\u3002\nnode\u304c1\u3064\u843d\u3061\u3066\u3057\u307e\u3063\u305f\u6642\u3092\u8003\u616e\u3057\u3001\u30af\u30e9\u30b9\u30bf\u306e\u8a2d\u5b9a\u3092\u4ee5\u4e0b\u306b\u3059\u308b\n\nnode\u6700\u5c0f\u30b5\u30a4\u30ba3\ncontainer cluster \u81ea\u52d5\u30b9\u30b1\u30fc\u30ea\u30f3\u30b0 ON\n\n\n$ kubectl get nodes\nNAME                                           STATUS    AGE\ngke-satsuma-redis-default-pool-f99bcf1a-cft1   Ready     2d\ngke-satsuma-redis-default-pool-f99bcf1a-lj8d   Ready     9m\n\n$ kubectl delete node gke-satsuma-redis-default-pool-f99bcf1a-cft1\nnode \"gke-satsuma-redis-default-pool-f99bcf1a-cft1\" deleted\n\n$ kubectl get nodes\nNAME                                           STATUS    AGE\ngke-satsuma-redis-default-pool-f99bcf1a-lj8d   Ready     10m\n\n$ kubectl exec -it ubuntu sh\n# redis-cli -h 10.107.244.37 -c\n10.107.244.37:6379> get hoge\n-> Redirected to slot [1525] located at 10.104.0.20:6379\n\"fuga\"\n10.104.0.20:6379> get hogehoge\n\"fugafuga\"\n10.104.0.20:6379> get hoge\n\"fuga\"\n10.104.0.20:6379> get hogehoge\n\"fugafuga\"\n\n\nservice\u306b\u7d10\u4ed8\u3051\u3066\u5168redis\u30ce\u30fc\u30c9\u306b\u30e9\u30f3\u30c0\u30e0\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3082\u3001\u5024\u3092\u6b63\u5e38\u306b\u53d6\u5f97\u3067\u304d\u308b\u4e8b\u3092\u78ba\u8a8d\u3059\u308b\n\nservice redis\u304c  redis-1\u301credis-6endpoint\u306b\u5411\u3044\u3066\u3044\u308b\u304b\u78ba\u8a8d\n\n$ kubectl get services\nNAME         CLUSTER-IP      EXTERNAL-IP   PORT(S)              AGE\nkubernetes   10.107.240.1    <none>        443/TCP              2d\nredis        10.107.244.37   <none>        6379/TCP,16379/TCP   52m\nredis-1      10.107.255.1    <none>        6379/TCP,16379/TCP   52m\nredis-2      10.107.255.2    <none>        6379/TCP,16379/TCP   52m\nredis-3      10.107.255.3    <none>        6379/TCP,16379/TCP   52m\nredis-4      10.107.255.4    <none>        6379/TCP,16379/TCP   52m\nredis-5      10.107.255.5    <none>        6379/TCP,16379/TCP   52m\nredis-6      10.107.255.6    <none>        6379/TCP,16379/TCP   52m\n\n$ kubectl describe service redis\nName:     redis\nNamespace:    default\nLabels:     <none>\nSelector:   app=redis\nType:     ClusterIP\nIP:     10.107.244.37\nPort:     redis 6379/TCP\nEndpoints:    10.104.0.18:6379,10.104.0.19:6379,10.104.0.20:6379 + 3 more...\nPort:     cluster 16379/TCP\nEndpoints:    10.104.0.18:16379,10.104.0.19:16379,10.104.0.20:16379 + 3 more...\nSession Affinity: None\n\n\n master\u3067\u30c7\u30fc\u30bf\u3092\u633f\u5165\u3057\u3001loadbalancer\u304b\u3089\u30c7\u30fc\u30bf\u304c\u6b63\u3057\u304f\u53d6\u5f97\u3067\u304d\u308b\u304b\u78ba\u8a8d\u3059\u308b\n\nredis-1(master)\u306b\u3066\u30c7\u30fc\u30bf\u3092\u633f\u5165\u3059\u308b\n$ kubectl exec -it redis-1-2pg4v -- sh \n/data # redis-cli -c\n127.0.0.1:6379> set hoge fuga\nOK\n\nredis-3(master)\u306b\u3066\u30c7\u30fc\u30bf\u3092\u633f\u5165\u3059\u308b\n$ kubectl exec -it redis-3-4fs93 -- sh\n/data # redis-cli -c\n127.0.0.1:6379> set hogehoge fugafuga\n-> Redirected to slot [694] located at 10.104.1.44:6379\nOK\n\nredis(loadalancer)\u306b\u3066\u30c7\u30fc\u30bf\u3092\u53d6\u5f97\u3057\u3066\u307f\u308b\n$ kubectl exec -it ubuntu -- sh\n# redis-cli -h 10.107.244.37 -c\n10.107.244.37:6379> get hoge\n-> Redirected to slot [1525] located at 10.104.1.44:6379\n\"fuga\"\n10.104.1.44:6379> get hogehoge\n\"fugafuga\"\n\nredis-2(master)\u306b\u3066\u53d6\u5f97\u3057\u3066\u307f\u308b\n$ kubectl exec -it redis-2-fbzks sh                                                                                                       (feature/redis\u2731)\n/data # redis-cli -c\n127.0.0.1:6379> get hoge\n-> Redirected to slot [1525] located at 10.104.1.46:6379\n\"fuga\"\n10.104.1.46:6379> get hogehoge\n\"fugafuga\"\n\nredis-5(slave)\u306b\u3066\u53d6\u5f97\u3057\u3066\u307f\u308b\n$ kubectl exec -it redis-5-bt1wm sh\n/data # redis-cli -c\n127.0.0.1:6379> get hoge\n-> Redirected to slot [1525] located at 10.104.1.46:6379\n\"fuga\"\n10.104.1.46:6379> get hogehoge\n\"fugafuga\"\n\n\n\u691c\u8a3c\n\n- gcp redis\u4e0a\u30671000000\u4e07\u4ef6\u30c7\u30fc\u30bf\u4f5c\u6210\n$ redis-cli debug populate 1000000\n10.104.0.6:6379> mget key:0\n1) \"value:0\"\n10.104.1.4:6379> mget key:99999\n-> Redirected to slot [2036] located at 10.104.0.6:6379\n1) \"value:99999\"\n\n\n- \u4f7f\u7528memory\u78ba\u8a8d \n$ redis-cli info\n# Memory\nused_memory:2278256\nused_memory_human:2.17M\nused_memory_rss:3805184\nused_memory_peak:2278256\nused_memory_peak_human:2.17M\nused_memory_lua:36864\nmem_fragmentation_ratio:1.67\nmem_allocator:libc\n\n\u4fdd\u5b58\u3059\u308b\u30c7\u30fc\u30bf\u306e\u6587\u5b57\u5217\u306e\u9577\u3055\u3067\u4e88\u60f3\u3055\u308c\u308b\u30c7\u30fc\u30bf\u4ef6\u6570\u3092\u898b\u7a4d\u3082\u308a\u3001\u8a2d\u5b9a\u3057\u305f\u30e1\u30e2\u30ea\u3067\u8010\u3048\u308b\u304b\u691c\u8a3c\u304c\u5225\u9014\u5fc5\u8981\u3067\u3042\u308b\n# \u6982\u8981\nkubernetes\u3067redis cluster\u69cb\u7bc9\u3057\u3066\u307f\u305f\u5099\u5fd8\u9332\n\nhttps://github.com/kelseyhightower/kubernetes-redis-cluster\n\u307b\u307c\u3053\u3061\u3089\u3092\u305d\u306e\u307e\u307e\u4f7f\u3063\u3066\u3044\u308b\n\n- Redis server version\u30013.2.0\n- \u30c7\u30fc\u30bf\u306e\u6c38\u7d9a\u5316\u306f\u3057\u306a\u3044\n- redis\u30af\u30e9\u30b9\u30bf\u57fa\u672cmaster\u00d73\u306b\u30ec\u30d7\u30ea\u30ab\u7528 slave\u00d73\n\n```\nredis (loadbalancer) \n  |\n  |- [ redis-1(master) ] - [redis-4(slave)]\n  |- [ redis-2(master) ] - [redis-5(slave)]\n  |- [ redis-3(master) ] - [redis-6(slave)]\n``` \n\n- `maxmemory-policy` \u306f\u3001\u30c7\u30d5\u30a9\u30eb\u30c8`volatile-lru`\n\n```\n`volatile-lru` remove the key with an expire set using an LRU algorithm\n```\n\u30bb\u30c3\u30b7\u30e7\u30f3\u4fdd\u5b58\u6642\u306b\u3001\u6709\u52b9\u671f\u9650\u3092\u8a2d\u5b9a\u3059\u308b\u60f3\u5b9a\n\n\nredis-1 ~ redis6\u3082replicaset\u3067pod\u4f5c\u6210\u3057\u3066\u3044\u308b\u306e\u3067\u8a2d\u5b9a\u3092\u5909\u3048\u308c\u3070\u8907\u6570pod\u8d77\u52d5\u53ef\u80fd\u3002\n1pod\u305a\u3064\u3067\u4ee5\u4e0b\u69cb\u7bc9\u3068\u78ba\u8a8d\u3092\u884c\u3046\u3002\n\n# \u30bd\u30fc\u30b9\nhttps://github.com/lovelytokyo/kubernetes-redis-cluster\n\n# \u69cb\u7bc9\n\n- kubernetes\u3067replicaset\u3068service\u3067pod\u3068loadbalancer\u3092\u8d77\u52d5\u3059\u308b\n\n```\n$ kubectl create configmap redis-conf --from-file=redis.conf \n$ kubectl create -f replicasets\n$ kubectl create -f services\n```\n\n- pod\u3092redis cluster\u306b\u7e4b\u3050\n\nredis cluster\u4f5c\u6210\u30b3\u30de\u30f3\u30c9\u5b9f\u884c\u7528pod\u3092\u8d77\u52d5\u3059\u308b\n\n```\n$ kubectl run -i --tty ubuntu --image=ubuntu --restart=Never /bin/bash\n\n```\n\n\u5fc5\u8981\u306a\u30e9\u30a4\u30d6\u30e9\u30ea\u30fc\u985e\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\n\n```\n$ apt-get update\n$ apt-get install ruby vim wget redis-tools\n$ gem install redis\n$ wget http://download.redis.io/redis-stable/src/redis-trib.rb\n$ chmod 755 redis-trib.rb\n```\n\nredis cluster\u3092\u4f5c\u6210\u3059\u308b\n\n```\n$ ./redis-trib.rb create --replicas 1 \\\n  10.107.255.1:6379 \\\n  10.107.255.2:6379 \\\n  10.107.255.3:6379 \\\n  10.107.255.4:6379 \\\n  10.107.255.5:6379 \\\n  10.107.255.6:6379\n>>> Creating cluster\n>>> Performing hash slots allocation on 6 nodes...\nUsing 3 masters:\n10.107.255.1:6379\n10.107.255.2:6379\n10.107.255.3:6379\nAdding replica 10.107.255.4:6379 to 10.107.255.1:6379\nAdding replica 10.107.255.5:6379 to 10.107.255.2:6379\nAdding replica 10.107.255.6:6379 to 10.107.255.3:6379\nM: d4dfb6366289f581e395428811af4bb6e1f07e2d 10.107.255.1:6379   10.104.1.34\n   slots:0-5460 (5461 slots) master\nM: 4b23c907ef408e5efd6225fffd11a6cdff5de337 10.107.255.2:6379   10.104.1.35\n   slots:5461-10922 (5462 slots) master\nM: 189ee8e87202326675adef4f507a80b5b5873369 10.107.255.3:6379   10.104.1.36\n   slots:10923-16383 (5461 slots) master\nS: 37b2b6b625d8bfba7c8997abfe894df099761937 10.107.255.4:6379   10.104.1.37\n   replicates d4dfb6366289f581e395428811af4bb6e1f07e2d\nS: f2229c73056a819f3cee6521d231e65ce1f4c180 10.107.255.5:6379   10.104.0.14\n   replicates 4b23c907ef408e5efd6225fffd11a6cdff5de337\nS: ad1aa4c73849622068c96976998f778673a2ce4c 10.107.255.6:6379   10.104.1.38\n   replicates 189ee8e87202326675adef4f507a80b5b5873369\nCan I set the above configuration? (type 'yes' to accept): yes\n>>> Nodes configuration updated\n>>> Assign a different config epoch to each node\n>>> Sending CLUSTER MEET messages to join the cluster\nWaiting for the cluster to join..\n>>> Performing Cluster Check (using node 10.107.255.1:6379)\nM: d4dfb6366289f581e395428811af4bb6e1f07e2d 10.107.255.1:6379\n   slots:0-5460 (5461 slots) master\n   1 additional replica(s)\nM: 189ee8e87202326675adef4f507a80b5b5873369 10.104.1.36:6379\n   slots:10923-16383 (5461 slots) master\n   1 additional replica(s)\nM: 4b23c907ef408e5efd6225fffd11a6cdff5de337 10.104.1.35:6379\n   slots:5461-10922 (5462 slots) master\n   1 additional replica(s)\nS: ad1aa4c73849622068c96976998f778673a2ce4c 10.104.1.38:6379\n   slots: (0 slots) slave\n   replicates 189ee8e87202326675adef4f507a80b5b5873369\nS: f2229c73056a819f3cee6521d231e65ce1f4c180 10.104.0.14:6379\n   slots: (0 slots) slave\n   replicates 4b23c907ef408e5efd6225fffd11a6cdff5de337\nS: 37b2b6b625d8bfba7c8997abfe894df099761937 10.104.1.37:6379\n   slots: (0 slots) slave\n   replicates d4dfb6366289f581e395428811af4bb6e1f07e2d\n[OK] All nodes agree about slots configuration.\n>>> Check for open slots...\n>>> Check slots coverage...\n[OK] All 16384 slots covered.\n```\n\n# \u78ba\u8a8d\n## docker\u3092\u843d\u3068\u3057\u3066\u3082\u4ed6\u306eredis\u30ce\u30fc\u30c9\u304b\u3089\u5024\u304c\u5e30\u3063\u3066\u304f\u308b\u4e8b\u3092\u78ba\u8a8d\u3059\u308b\n-  master\u30921pod\u6b62\u3081\u3066\u3001\u81ea\u52d5\u8d77\u52d5\u3059\u308b\u304b\u78ba\u8a8d\u3059\u308b\n\npod\u4e00\u89a7\n\n```\n$ kubectl get pods --show-all\nNAME            READY     STATUS    RESTARTS   AGE\nredis-1-2pg4v   1/1       Running   0          56m\nredis-2-fbzks   1/1       Running   0          56m\nredis-3-4fs93   1/1       Running   0          56m\nredis-4-pjxt1   1/1       Running   0          56m\nredis-5-bt1wm   1/1       Running   0          56m\nredis-6-qpvvl   1/1       Running   0          56m\nubuntu          1/1       Running   0          20m\n```\n\nredis-1(master)pod\u3092\u6b62\u3081\u308b\n\n```\n$ kubectl stop pod redis-1-2pg4v\nCommand \"stop\" is deprecated, use \"delete\" instead.\npod \"redis-1-2pg4v\" deleted\n```\n\npod\u4e00\u89a7\n\n```\n$ kubectl get pods --show-all\nNAME            READY     STATUS    RESTARTS   AGE\nredis-1-b7blk   1/1       Running   0          3m \u3000\u2190 redis-1(master)\u306epod\u304c\u65b0\u305f\u306b\u8d77\u52d5\u3055\u308c\u305f\nredis-2-fbzks   1/1       Running   0          1h\nredis-3-4fs93   1/1       Running   0          1h\nredis-4-pjxt1   1/1       Running   0          1h\nredis-5-bt1wm   1/1       Running   0          1h\nredis-6-qpvvl   1/1       Running   0          1h\nubuntu          1/1       Running   0          24m\n```\n\n- docker\u3092\u6b62\u3081\u3066\u3082\u6b63\u5e38\u306b\u30c7\u30fc\u30bf\u53d6\u5f97\u3067\u304d\u308b\u304b\n\n```\na12948@gke-satsuma-redis-default-pool-f99bcf1a-cft1 ~ $ docker ps -a | grep redis-server\n4b1cac0124e9        redis:3.2.0-alpine                                                     \"redis-server /etc/re\"   8 minutes ago       Up 8 minutes                                   k8s_redis.638d2d73_redis-1-b7blk_default_2df04edf-e91c-11e6-999b-42010af00135_72d2a8a6\n6fef91ca8ca5        redis:3.2.0-alpine                                                     \"redis-server /etc/re\"   5 hours ago         Exited (0) 8 minutes ago                       k8s_redis.638d2d73_redis-1-b7blk_default_2df04edf-e91c-11e6-999b-42010af00135_74b5a100\n```\n\n```\n$ kubectl exec -it ubuntu sh\n# redis-cli -h 10.107.244.37 -c\n10.107.244.37:6379> get hoge\n\"fuga\"\n10.107.244.37:6379> get hogehoge\n\"fugafuga\"\n```\n\n## \u30ce\u30fc\u30c9\u3092\u843d\u3068\u3057\u3066\u3082redis\u30ce\u30fc\u30c9\u304b\u3089\u5024\u304c\u5e30\u3063\u3066\u304f\u308b\u4e8b\u3092\u78ba\u8a8d\u3059\u308b\n\uff01\uff01container cluster\u306enode\u304c1\u3064\u306b\u306a\u3063\u3066\u3057\u307e\u3046\u3068\u81ea\u52d5\u8d77\u52d5\u3067\u3044\u306a\u3044pod\u304c\u3067\u304d\u3066\u3057\u307e\u3046\u305f\u3081\u3001\n\u5c11\u306a\u304f\u3066\u30822\u3064\u306enode\u304c\u5fc5\u8981\u3067\u3042\u308b\u3002\nnode\u304c1\u3064\u843d\u3061\u3066\u3057\u307e\u3063\u305f\u6642\u3092\u8003\u616e\u3057\u3001\u30af\u30e9\u30b9\u30bf\u306e\u8a2d\u5b9a\u3092\u4ee5\u4e0b\u306b\u3059\u308b\n\n- node\u6700\u5c0f\u30b5\u30a4\u30ba3\n- container cluster \u81ea\u52d5\u30b9\u30b1\u30fc\u30ea\u30f3\u30b0 `ON`\n\n\n```\n$ kubectl get nodes\nNAME                                           STATUS    AGE\ngke-satsuma-redis-default-pool-f99bcf1a-cft1   Ready     2d\ngke-satsuma-redis-default-pool-f99bcf1a-lj8d   Ready     9m\n\n$ kubectl delete node gke-satsuma-redis-default-pool-f99bcf1a-cft1\nnode \"gke-satsuma-redis-default-pool-f99bcf1a-cft1\" deleted\n\n$ kubectl get nodes\nNAME                                           STATUS    AGE\ngke-satsuma-redis-default-pool-f99bcf1a-lj8d   Ready     10m\n```\n\n```\n$ kubectl exec -it ubuntu sh\n# redis-cli -h 10.107.244.37 -c\n10.107.244.37:6379> get hoge\n-> Redirected to slot [1525] located at 10.104.0.20:6379\n\"fuga\"\n10.104.0.20:6379> get hogehoge\n\"fugafuga\"\n10.104.0.20:6379> get hoge\n\"fuga\"\n10.104.0.20:6379> get hogehoge\n\"fugafuga\"\n```\n\n\n## service\u306b\u7d10\u4ed8\u3051\u3066\u5168redis\u30ce\u30fc\u30c9\u306b\u30e9\u30f3\u30c0\u30e0\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3082\u3001\u5024\u3092\u6b63\u5e38\u306b\u53d6\u5f97\u3067\u304d\u308b\u4e8b\u3092\u78ba\u8a8d\u3059\u308b\n\n- service `redis`\u304c  `redis-1`\u301c`redis-6`endpoint\u306b\u5411\u3044\u3066\u3044\u308b\u304b\u78ba\u8a8d\n\n```\n$ kubectl get services\nNAME         CLUSTER-IP      EXTERNAL-IP   PORT(S)              AGE\nkubernetes   10.107.240.1    <none>        443/TCP              2d\nredis        10.107.244.37   <none>        6379/TCP,16379/TCP   52m\nredis-1      10.107.255.1    <none>        6379/TCP,16379/TCP   52m\nredis-2      10.107.255.2    <none>        6379/TCP,16379/TCP   52m\nredis-3      10.107.255.3    <none>        6379/TCP,16379/TCP   52m\nredis-4      10.107.255.4    <none>        6379/TCP,16379/TCP   52m\nredis-5      10.107.255.5    <none>        6379/TCP,16379/TCP   52m\nredis-6      10.107.255.6    <none>        6379/TCP,16379/TCP   52m\n```\n\n```\n$ kubectl describe service redis\nName:     redis\nNamespace:    default\nLabels:     <none>\nSelector:   app=redis\nType:     ClusterIP\nIP:     10.107.244.37\nPort:     redis 6379/TCP\nEndpoints:    10.104.0.18:6379,10.104.0.19:6379,10.104.0.20:6379 + 3 more...\nPort:     cluster 16379/TCP\nEndpoints:    10.104.0.18:16379,10.104.0.19:16379,10.104.0.20:16379 + 3 more...\nSession Affinity: None\n```\n\n-  master\u3067\u30c7\u30fc\u30bf\u3092\u633f\u5165\u3057\u3001loadbalancer\u304b\u3089\u30c7\u30fc\u30bf\u304c\u6b63\u3057\u304f\u53d6\u5f97\u3067\u304d\u308b\u304b\u78ba\u8a8d\u3059\u308b\n\nredis-1(master)\u306b\u3066\u30c7\u30fc\u30bf\u3092\u633f\u5165\u3059\u308b\n\n```\n$ kubectl exec -it redis-1-2pg4v -- sh \n/data # redis-cli -c\n127.0.0.1:6379> set hoge fuga\nOK\n```\n\nredis-3(master)\u306b\u3066\u30c7\u30fc\u30bf\u3092\u633f\u5165\u3059\u308b\n\n```\n$ kubectl exec -it redis-3-4fs93 -- sh\n/data # redis-cli -c\n127.0.0.1:6379> set hogehoge fugafuga\n-> Redirected to slot [694] located at 10.104.1.44:6379\nOK\n```\n\nredis(loadalancer)\u306b\u3066\u30c7\u30fc\u30bf\u3092\u53d6\u5f97\u3057\u3066\u307f\u308b\n\n```\n$ kubectl exec -it ubuntu -- sh\n# redis-cli -h 10.107.244.37 -c\n10.107.244.37:6379> get hoge\n-> Redirected to slot [1525] located at 10.104.1.44:6379\n\"fuga\"\n10.104.1.44:6379> get hogehoge\n\"fugafuga\"\n```\n\nredis-2(master)\u306b\u3066\u53d6\u5f97\u3057\u3066\u307f\u308b\n\n```\n$ kubectl exec -it redis-2-fbzks sh                                                                                                       (feature/redis\u2731)\n/data # redis-cli -c\n127.0.0.1:6379> get hoge\n-> Redirected to slot [1525] located at 10.104.1.46:6379\n\"fuga\"\n10.104.1.46:6379> get hogehoge\n\"fugafuga\"\n```\n\nredis-5(slave)\u306b\u3066\u53d6\u5f97\u3057\u3066\u307f\u308b\n\n```\n$ kubectl exec -it redis-5-bt1wm sh\n/data # redis-cli -c\n127.0.0.1:6379> get hoge\n-> Redirected to slot [1525] located at 10.104.1.46:6379\n\"fuga\"\n10.104.1.46:6379> get hogehoge\n\"fugafuga\"\n```\n\n# \u691c\u8a3c\n- gcp redis\u4e0a\u30671000000\u4e07\u4ef6\u30c7\u30fc\u30bf\u4f5c\u6210\n- \n```\n$ redis-cli debug populate 1000000\n10.104.0.6:6379> mget key:0\n1) \"value:0\"\n10.104.1.4:6379> mget key:99999\n-> Redirected to slot [2036] located at 10.104.0.6:6379\n1) \"value:99999\"\n```\n\n- \u4f7f\u7528memory\u78ba\u8a8d \n- \n```\n$ redis-cli info\n# Memory\nused_memory:2278256\nused_memory_human:2.17M\nused_memory_rss:3805184\nused_memory_peak:2278256\nused_memory_peak_human:2.17M\nused_memory_lua:36864\nmem_fragmentation_ratio:1.67\nmem_allocator:libc\n```\n\n\u4fdd\u5b58\u3059\u308b\u30c7\u30fc\u30bf\u306e\u6587\u5b57\u5217\u306e\u9577\u3055\u3067\u4e88\u60f3\u3055\u308c\u308b\u30c7\u30fc\u30bf\u4ef6\u6570\u3092\u898b\u7a4d\u3082\u308a\u3001\u8a2d\u5b9a\u3057\u305f\u30e1\u30e2\u30ea\u3067\u8010\u3048\u308b\u304b\u691c\u8a3c\u304c\u5225\u9014\u5fc5\u8981\u3067\u3042\u308b\n", "tags": ["kubernetes", "gcp", "Redis"]}