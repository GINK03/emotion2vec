{"tags": ["Ruby", "Rails", "AdventCalendar", "Resque", "Heroku"], "context": " \u3053\u306e\u8a18\u4e8b\u306f\u6700\u7d42\u66f4\u65b0\u65e5\u304b\u30891\u5e74\u4ee5\u4e0a\u304c\u7d4c\u904e\u3057\u3066\u3044\u307e\u3059\u3002\n\n\u53c2\u8003\u30ea\u30f3\u30af\n\n#271 Resque - RailsCasts\ndefunkt/resque\nTwiwt:Blog / jugyo : Rails3 \u3067 resque \u3092\u4f7f\u3046 #1\n\n\nRedis\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n\u30bf\u30fc\u30df\u30ca\u30eb\nbrew install redis\n----------\n==> Downloading http://redis.googlecode.com/files/redis-2.4.15.tar.gz\n######################################################################## 100.0%\n==> make -C /private/tmp/homebrew-redis-2.4.15-bg22/redis-2.4.15/src CC=/usr/bin/gcc-4.2\n==> Caveats\nIf this is your first install, automatically load on login with:\n    mkdir -p ~/Library/LaunchAgents\n    cp /usr/local/Cellar/redis/2.4.15/homebrew.mxcl.redis.plist ~/Library/LaunchAgents/\n    launchctl load -w ~/Library/LaunchAgents/homebrew.mxcl.redis.plist\n\nIf this is an upgrade and you already have the homebrew.mxcl.redis.plist loaded:\n    launchctl unload -w ~/Library/LaunchAgents/homebrew.mxcl.redis.plist\n    cp /usr/local/Cellar/redis/2.4.15/homebrew.mxcl.redis.plist ~/Library/LaunchAgents/\n    launchctl load -w ~/Library/LaunchAgents/homebrew.mxcl.redis.plist\n\n  To start redis manually:\n    redis-server /usr/local/etc/redis.conf\n\n  To access the server:\n    redis-cli\n==> Summary\n/usr/local/Cellar/redis/2.4.15: 9 files, 576K, built in 19 seconds\n----------\n\n\nRedis\u30b5\u30fc\u30d0\u8d77\u52d5\n\n\u30bf\u30fc\u30df\u30ca\u30eb\nredis-server /usr/local/etc/redis.conf\n----------\n[1648] 20 Sep 12:14:06 * Server started, Redis version 2.4.15\n[1648] 20 Sep 12:14:06 * The server is now ready to accept connections on port 6379\n[1648] 20 Sep 12:14:06 - 0 clients connected (0 slaves), 922304 bytes in use\n----------\n\n\n\nResque\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\nGemfile\ngem 'resque', require: 'resque/server'\n\n\n\n\u30bf\u30fc\u30df\u30ca\u30eb\nbundle install\n\n\n\nRedis\uff0fResque\u8a2d\u5b9a\u4f5c\u6210\nvi config/initializers/resque.rb\n\nconfig/initializers/resque.rb\nResque.redis = 'localhost:6379'\n\n\n\nRake\u30bf\u30b9\u30af\u8ffd\u52a0\nvi lib/tasks/resque.rake\n\nlib/tasks/resque.rake\nrequire \"resque/tasks\"\n\ntask \"resque:setup\" => :environment\n\n\n\n\u30ad\u30e5\u30fc\u8ffd\u52a0\n\u203bController\u3001Model\u306a\u3069\nResque.enqueue( SnippetHighlighter, @snippet.id )\n\n\nworker\u4f5c\u6210\n\napp/workers/snippet_highlighter.rb\nclass SnippetHighlighter\n  @queue = :snippets_queue\n\n  def self.perform(snippet_id)\n    snippet = Snippet.find(snippet_id)\n    uri = URI.parse('http://pygments.appspot.com/')\n    request = Net::HTTP.post_form(uri, {'lang' => \u21b5\n      snippet.language, 'code' => snippet.plain_code})\n    snippet.update_attribute(:highlighted_code, request.body)\n  end\nend\n\n\n\nRake\u30bf\u30b9\u30af\u5b9f\u884c\n\u203b\u8d77\u52d5\u3057\u3066\u304a\u304f\u3068\u767a\u751f\u3057\u305f\u30ad\u30e5\u30fc\u3092\u9806\u6b21\u5b9f\u884c\u3057\u3066\u3044\u304f(\u300cQUEUE=queue_name\u300d\u3067\u30ad\u30e3\u30c3\u30c1\u3059\u308b\u30ad\u30e5\u30fc\u3092\u6307\u5b9a\u3059\u308b\u3001\u5168\u3066\u306e\u5834\u5408\u306f\u300cQUEUE='*'\u300d)\n\n\u30bf\u30fc\u30df\u30ca\u30eb\nbundle exec rake resque:work QUEUE=snippets_queue\n\n\n\n\u30bf\u30fc\u30df\u30ca\u30eb\nbundle exec rake resque:work QUEUE='*'\n\n\n\n\u30b8\u30e7\u30d6\u7ba1\u7406\u753b\u9762\u8d77\u52d5\n\n\u30bf\u30fc\u30df\u30ca\u30eb\nresque-web\n\n\n\nResque\u306eWeb\u30a4\u30f3\u30bf\u30fc\u30d5\u30a7\u30a4\u30b9\u3092Rails\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3078\u7d44\u307f\u8fbc\u3080\n\nconfig/routes.rb\nMyApp::Application.routes.draw do\n  mount Resque::Server, at: \"/resque\"\n\n  # \u301c\nend\n\n\nhttp://localhost:3000/resque\n\nDevise\u8a8d\u8a3c\u7528\n\nconfig/routes.rb\nMyApp::Application.routes.draw do\n  authenticate :admin do\n    mount Resque::Server, at: \"/resque\"\n  end\nend\n\n\n\nBASIC\u8a8d\u8a3c\u7528\n\nconfig/initializers/resque_auth.rb\nResque::Server.use(Rack::Auth::Basic) do |user, password|\n  password == \"secret\"\nend\n\n\n\n\nHeroku - Redis To Go\n\nRedis To Go\u30a2\u30c9\u30aa\u30f3\u8ffd\u52a0\n\n\u30bf\u30fc\u30df\u30ca\u30eb\nheroku addons:add redistogo:nano\n\n\n\nRedis To Go\u7528\u8a2d\u5b9a\u8ffd\u52a0\nRedis To Go\u30a2\u30c9\u30ec\u30b9\u78ba\u8a8d\n\n\u30bf\u30fc\u30df\u30ca\u30eb\nheroku config | grep \"REDISTOGO_URL\"\n\n\n\nconfig/initializers/resque.rb\nif Rails.env.development?\n  Resque.redis = 'localhost:6379'\nelse\n  Resque.redis = ENV['REDISTOGO_URL']\nend\n\n\n\nHeroku\u4e0aRake\u30bf\u30b9\u30af\u5b9f\u884c\n\n\u30bf\u30fc\u30df\u30ca\u30eb\nheroku run bundle exec rake resque:work QUEUE='*'\n\n\n\n\u300cPG::Error: SSL error: decryption failed or bad record mac\u300d\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3057\u305f\u5834\u5408\n\nResque with Rails 3 + Heroku + RedisToGo giving Postgresql error - Stack Overflow\nruby on rails - Postgres error on Heroku with Resque - Stack Overflow\n\n\nlib/tasks/resque.rake\nrequire \"resque/tasks\"\n\ntask \"resque:setup\" => :environment do\n  ENV['QUEUE'] = '*'\n  Resque.after_fork = Proc.new { ActiveRecord::Base.establish_connection }\nend\n\n\n\n### \u53c2\u8003\u30ea\u30f3\u30af\n\n* [#271 Resque - RailsCasts](http://railscasts.com/episodes/271-resque?language=ja&view=asciicast)\n* [defunkt/resque](https://github.com/defunkt/resque)\n* [Twiwt:Blog / jugyo : Rails3 \u3067 resque \u3092\u4f7f\u3046 #1](http://blog.twiwt.org/e/386f1c)\n\n### Redis\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n```:\u30bf\u30fc\u30df\u30ca\u30eb\nbrew install redis\n----------\n==> Downloading http://redis.googlecode.com/files/redis-2.4.15.tar.gz\n######################################################################## 100.0%\n==> make -C /private/tmp/homebrew-redis-2.4.15-bg22/redis-2.4.15/src CC=/usr/bin/gcc-4.2\n==> Caveats\nIf this is your first install, automatically load on login with:\n    mkdir -p ~/Library/LaunchAgents\n    cp /usr/local/Cellar/redis/2.4.15/homebrew.mxcl.redis.plist ~/Library/LaunchAgents/\n    launchctl load -w ~/Library/LaunchAgents/homebrew.mxcl.redis.plist\n\nIf this is an upgrade and you already have the homebrew.mxcl.redis.plist loaded:\n    launchctl unload -w ~/Library/LaunchAgents/homebrew.mxcl.redis.plist\n    cp /usr/local/Cellar/redis/2.4.15/homebrew.mxcl.redis.plist ~/Library/LaunchAgents/\n    launchctl load -w ~/Library/LaunchAgents/homebrew.mxcl.redis.plist\n\n  To start redis manually:\n    redis-server /usr/local/etc/redis.conf\n\n  To access the server:\n    redis-cli\n==> Summary\n/usr/local/Cellar/redis/2.4.15: 9 files, 576K, built in 19 seconds\n----------\n```\n\nRedis\u30b5\u30fc\u30d0\u8d77\u52d5\n\n```:\u30bf\u30fc\u30df\u30ca\u30eb\nredis-server /usr/local/etc/redis.conf\n----------\n[1648] 20 Sep 12:14:06 * Server started, Redis version 2.4.15\n[1648] 20 Sep 12:14:06 * The server is now ready to accept connections on port 6379\n[1648] 20 Sep 12:14:06 - 0 clients connected (0 slaves), 922304 bytes in use\n----------\n```\n\n### Resque\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n```:Gemfile\ngem 'resque', require: 'resque/server'\n```\n\n```:\u30bf\u30fc\u30df\u30ca\u30eb\nbundle install\n```\n\n### Redis\uff0fResque\u8a2d\u5b9a\u4f5c\u6210\n\nvi config/initializers/resque.rb\n\n```ruby:config/initializers/resque.rb\nResque.redis = 'localhost:6379'\n```\n\n### Rake\u30bf\u30b9\u30af\u8ffd\u52a0\n\nvi lib/tasks/resque.rake\n\n```ruby:lib/tasks/resque.rake\nrequire \"resque/tasks\"\n\ntask \"resque:setup\" => :environment\n```\n\n### \u30ad\u30e5\u30fc\u8ffd\u52a0\n\n\u203bController\u3001Model\u306a\u3069\n\n```ruby\nResque.enqueue( SnippetHighlighter, @snippet.id )\n```\n\n### worker\u4f5c\u6210\n\n```ruby:app/workers/snippet_highlighter.rb\nclass SnippetHighlighter\n  @queue = :snippets_queue\n\n  def self.perform(snippet_id)\n    snippet = Snippet.find(snippet_id)\n    uri = URI.parse('http://pygments.appspot.com/')\n    request = Net::HTTP.post_form(uri, {'lang' => \u21b5\n      snippet.language, 'code' => snippet.plain_code})\n    snippet.update_attribute(:highlighted_code, request.body)\n  end\nend\n```\n\n### Rake\u30bf\u30b9\u30af\u5b9f\u884c\n\n\u203b\u8d77\u52d5\u3057\u3066\u304a\u304f\u3068\u767a\u751f\u3057\u305f\u30ad\u30e5\u30fc\u3092\u9806\u6b21\u5b9f\u884c\u3057\u3066\u3044\u304f(\u300cQUEUE=queue_name\u300d\u3067\u30ad\u30e3\u30c3\u30c1\u3059\u308b\u30ad\u30e5\u30fc\u3092\u6307\u5b9a\u3059\u308b\u3001\u5168\u3066\u306e\u5834\u5408\u306f\u300cQUEUE='*'\u300d)\n\n```:\u30bf\u30fc\u30df\u30ca\u30eb\nbundle exec rake resque:work QUEUE=snippets_queue\n```\n\n```:\u30bf\u30fc\u30df\u30ca\u30eb\nbundle exec rake resque:work QUEUE='*'\n```\n\n### \u30b8\u30e7\u30d6\u7ba1\u7406\u753b\u9762\u8d77\u52d5\n\n```:\u30bf\u30fc\u30df\u30ca\u30eb\nresque-web\n```\n\n### Resque\u306eWeb\u30a4\u30f3\u30bf\u30fc\u30d5\u30a7\u30a4\u30b9\u3092Rails\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3078\u7d44\u307f\u8fbc\u3080\n\n```ruby:config/routes.rb\nMyApp::Application.routes.draw do\n  mount Resque::Server, at: \"/resque\"\n\n  # \u301c\nend\n```\n\n[http://localhost:3000/resque](http://localhost:3000/resque)\n\n----\n\nDevise\u8a8d\u8a3c\u7528\n\n```ruby:config/routes.rb\nMyApp::Application.routes.draw do\n  authenticate :admin do\n    mount Resque::Server, at: \"/resque\"\n  end\nend\n```\n\n----\n\nBASIC\u8a8d\u8a3c\u7528\n\n```ruby:config/initializers/resque_auth.rb\nResque::Server.use(Rack::Auth::Basic) do |user, password|\n  password == \"secret\"\nend\n```\n\n----\n\n# Heroku - Redis To Go\n\n### Redis To Go\u30a2\u30c9\u30aa\u30f3\u8ffd\u52a0\n\n```:\u30bf\u30fc\u30df\u30ca\u30eb\nheroku addons:add redistogo:nano\n```\n\n### Redis To Go\u7528\u8a2d\u5b9a\u8ffd\u52a0\n\nRedis To Go\u30a2\u30c9\u30ec\u30b9\u78ba\u8a8d\n\n```:\u30bf\u30fc\u30df\u30ca\u30eb\nheroku config | grep \"REDISTOGO_URL\"\n```\n\n```:config/initializers/resque.rb\nif Rails.env.development?\n  Resque.redis = 'localhost:6379'\nelse\n  Resque.redis = ENV['REDISTOGO_URL']\nend\n```\n\n### Heroku\u4e0aRake\u30bf\u30b9\u30af\u5b9f\u884c\n\n```:\u30bf\u30fc\u30df\u30ca\u30eb\nheroku run bundle exec rake resque:work QUEUE='*'\n```\n\n### \u300cPG::Error: SSL error: decryption failed or bad record mac\u300d\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3057\u305f\u5834\u5408\n\n* [Resque with Rails 3 + Heroku + RedisToGo giving Postgresql error - Stack Overflow](http://stackoverflow.com/questions/9915146/resque-with-rails-3-heroku-redistogo-giving-postgresql-error)\n* [ruby on rails - Postgres error on Heroku with Resque - Stack Overflow](http://stackoverflow.com/questions/9961044/postgres-error-on-heroku-with-resque)\n\n```ruby:lib/tasks/resque.rake\nrequire \"resque/tasks\"\n\ntask \"resque:setup\" => :environment do\n  ENV['QUEUE'] = '*'\n  Resque.after_fork = Proc.new { ActiveRecord::Base.establish_connection }\nend\n```"}