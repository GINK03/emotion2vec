{"context": "\n\n\u6982\u8981\nAnsible\u3067\u3055\u304f\u3089VPS\u306e\u521d\u671f\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u3092\u81ea\u52d5\u5316\u3057\u307e\u3059\u3002\n\n\u74b0\u5883\n\n\u3055\u304f\u3089VPS\nCentOS7.3\nAnsible2.2.1.0\n\n\n\u524d\u63d0\u77e5\u8b58\n\n\u3055\u304f\u3089VPS\u3092\u306e\u521d\u671f\u8a2d\u5b9a\u306e\u6d41\u308c\u3092\u7406\u89e3\u3057\u3066\u3044\u308b\u3053\u3068\u3002\n\n\n\u3055\u304f\u3089VPS\u306e\u521d\u671f\u8a2d\u5b9a\n\n\n\n\n\u3055\u304f\u3089VPS\u306bCentOS7\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\u3055\u304f\u3089VPS\u306e\u30b3\u30f3\u30bd\u30fc\u30eb\u753b\u9762\u304b\u3089OS\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb>\u30ab\u30b9\u30bf\u30e0OS\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3092\u9078\u629e\u3057\u3066CentOS7\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u304c\u958b\u59cb\u3055\u308c\u308b\u3068\u3001CentOS7\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u7528\u30b3\u30f3\u30bd\u30fc\u30eb\u753b\u9762\uff08VNC\u30b3\u30f3\u30bd\u30fc\u30eb\u306eHTML5\u7248\u304bJava Applet\u7248\uff09\u3092\u958b\u304f\u3053\u3068\u304c\u3067\u304d\u308b\u306e\u3067\u3001\u74b0\u5883\u306b\u5408\u308f\u305b\u3066\u597d\u304d\u306a\u65b9\u3092\u9078\u3073\u307e\u3059\u3002\nCentOS7\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3067\u306f\u3001\u8a00\u8a9e\u8a2d\u5b9a\u3084\u30c7\u30a3\u30b9\u30af\u306e\u521d\u671f\u5316\u306a\u3069\u884c\u3046\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\nroot\u30e6\u30fc\u30b6\u30fc\u306e\u30d1\u30b9\u30ef\u30fc\u30c9\u8a2d\u5b9a\u3068\u65b0\u898f\u30e6\u30fc\u30b6\u30fc\u4f5c\u6210\u3092\u3059\u308b\u753b\u9762\u304c\u3042\u308a\u307e\u3059\u304c\u3001\u65b0\u898f\u30e6\u30fc\u30b6\u30fc\u4f5c\u6210\u306fAnsible\u3067\u884c\u3046\u306e\u3067\u3001root\u30e6\u30fc\u30b6\u30fc\u306e\u30d1\u30b9\u30ef\u30fc\u30c9\u8a2d\u5b9a\u306e\u307f\u3060\u3051\u3067OK\u3067\u3059\u3002\n\u6b21\u306b\u3001\u516c\u958b\u9375\u3092ansible\u30db\u30b9\u30c8\u5074\u304b\u3089\u3055\u304f\u3089VPS\u306b\u9001\u308a\u307e\u3059\u3002\uff08\u9375\u306f\u4e8b\u524d\u306b\u4f5c\u6210\u3057\u3066\u304a\u3044\u3066\u304f\u3060\u3055\u3044\u3002\u3053\u3053\u3067\u306f\u5272\u611b\u3057\u307e\u3059\u3002\uff09\n\u3053\u3061\u3089\u306e\u9375\u306fAnsible\u3067\u65b0\u898f\u306b\u4f5c\u6210\u3059\u308b\u30e6\u30fc\u30b6\u30fc\u7528\u306e\u9375\u3067\u3059\u3002\nssh-copy-id -i ~/.ssh/id_rsa.pub root@123.45.678.910\nssh root@123.45.678.901\u3067\u3055\u304f\u3089VPS\u306bssh\u63a5\u7d9a\u3067\u304d\u308c\u3070\u6e96\u5099OK\u3067\u3059\u3002\n\nAnsible\u3067\u3055\u304f\u3089VPS\u306e\u521d\u671f\u8a2d\u5b9a\u3092\u3059\u308b\n\nhosts\u30d5\u30a1\u30a4\u30eb\u3092\u5b9a\u7fa9\nhosts\n[sakura]\n123.45.678.910 ansible_ssh_user=root ansible_ssh_private_key_file=~/.ssh/id_rsa\n\n[hogemoge]\n123.45.678.910 ansible_ssh_user=hogemoge ansible_ssh_port=50055 ansible_ssh_private_key_file=~/.ssh/id_rsa\n\n\nPlaybook\u3092\u5b9a\u7fa9\n\u30bf\u30b9\u30af\u5185\u5bb9\u306f\u3053\u3093\u306a\u611f\u3058\u3067\u3059\u3002\n\n\u30e6\u30fc\u30b6\u30fc\u3092\u65b0\u898f\u4f5c\u6210\u3059\u308b\nauthorize_keys\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3059\u308b\nauthorize_keys\u30d5\u30a1\u30a4\u30eb\u306e\u30d1\u30fc\u30df\u30c3\u30b7\u30e7\u30f3\u3092\u8abf\u6574\u3059\u308b\nwheel\u30b0\u30eb\u30fc\u30d7\u306bsudo\u6a29\u9650\u3092\u4e0e\u3048\u308b\nroot\u30e6\u30fc\u30b6\u30fc\u3067\u306essh\u63a5\u7d9a\u3092\u7981\u6b62\u3059\u308b\nssh\u63a5\u7d9a\u306e\u30dd\u30fc\u30c8\u756a\u53f7\u3092\u5909\u66f4\u3059\u308b\niptables\u306etcp\u30dd\u30fc\u30c8\u3092\u5909\u66f4\u3059\u308b\nssh\u30dd\u30fc\u30c8\u3092\u30b7\u30e3\u30c3\u30c8\u30c0\u30a6\u30f3\u3059\u308b\nSELinux\u3092disabled\u306b\u8a2d\u5b9a\u3059\u308b\n\n1\u70b9\u6ce8\u610f\u70b9\u304c\u3042\u308a\u307e\u3059\u3002\nssh_user_password\u306fopenssl\u3067\u6697\u53f7\u5316\u3057\u305f\u3082\u306e\u3092\u6307\u5b9a\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\nopenssl passwd -salt hoge -1 moge\nPlaybook\u306f\u53c2\u8003\u30b5\u30a4\u30c8\u3092\u5927\u3044\u306b\u53c2\u8003\u306b\u3055\u305b\u3066\u9802\u304d\u307e\u3057\u305f\u3002m(_ _)m\ninit.yml\n---\n- hosts: sakura\n  become: yes\n  user: root\n  vars:\n    ssh_user: hogemoge\n    ssh_user_password: hogehogemogemoge\n    ssh_port: 50055\n  tasks:\n  - name: Add a new user\n    user:\n     name=\"{{ ssh_user }}\"\n     groups=wheel\n     password=\"{{ ssh_user_password }}\"\n     generate_ssh_key=yes\n     ssh_key_bits=2048\n\n  - name: Create an authorize_keys file\n    command: /bin/cp /home/{{ ssh_user }}/.ssh/id_rsa.pub /home/{{ ssh_user}}/.ssh/authorized_keys\n\n  - name: Change attributes of an authorized_keys file\n    file:\n     path: /home/{{ ssh_user }}/.ssh/authorized_keys\n     owner: \"{{ ssh_user }}\"\n     group: \"{{ ssh_user }}\"\n     mode: 0600\n\n  - name: Allow wheel group to use sudo\n    lineinfile:\n     dest: /etc/sudoers\n     state: present\n     insertafter: \"^# %wheel\\\\s+ALL=\\\\(ALL\\\\)\\\\s+NOPASSWD:\\\\s+ALL\"\n     line: \"%wheel ALL=(ALL) NOPASSWD: ALL\"\n     validate: \"visudo -cf %s\"\n     backup: yes\n\n  - name: Forbid root to access via ssh\n    lineinfile:\n     dest: /etc/ssh/sshd_config\n     state: present\n     regexp: \"^PermitRootLogin without-password\"\n     line: \"PermitRootLogin no\"\n     backrefs: yes\n     validate: \"sshd -T -f %s\"\n     backup: yes\n    notify:\n     - restart sshd\n\n  - name: Permit only specific user to access via ssh\n    lineinfile:\n     dest: /etc/ssh/sshd_config\n     state: present\n     insertafter: \"^PasswordAuthentication no\"\n     regexp: \"^AllowUsers\"\n     line: \"AllowUsers {{ ssh_user }}\"\n     validate: \"sshd -T -f %s\"\n     backup: yes\n    notify:\n     - restart sshd\n\n  - name: Change ssh port number\n    lineinfile:\n     dest: /etc/ssh/sshd_config\n     state: present\n     insertafter: \"^#Port 22\"\n     regexp: \"^Port\"\n     line: \"Port {{ ssh_port }}\"\n     validate: \"sshd -T -f %s\"\n     backup: yes\n    notify:\n     - restart sshd\n\n  - name: Change acceptable tcp port for ssh on iptables\n    firewalld: port={{ ssh_port }}/tcp permanent=true state=enabled immediate=yes\n\n  - name: shutdown ssh port\n    firewalld: service=sshd permanent=true state=disabled immediate=yes\n\n  - name: disable selinux\n    selinux: state=disabled\n\n\nhandler\u3092\u5b9a\u7fa9\n\u30cf\u30f3\u30c9\u30e9\u30fc\u3092\u5b9a\u7fa9\u3057\u307e\u3059\u3002\nmain.yml\n---\n- name: restart sshd\n  service: name=iptables start restarted\n\n\nAnsible\u5b9f\u884c\nansible-playbook sakura.yml -i hosts -k -c paramiko\n\u30bf\u30b9\u30af\u306e\u5b9f\u884c\u304c\u5168\u3066\u5b8c\u4e86\u3057\u305f\u3089\u3001\u30b5\u30fc\u30d0\u30fc\u3092\u4e00\u5ea6\u518d\u8d77\u52d5\u3057\u3066\u5b8c\u4e86\u3067\u3059\u3002\n\n\u53c2\u8003\n\nAnsible\u3067\u3055\u304f\u3089VPS\u306e\u521d\u671f\u8a2d\u5b9a\nAnsible\u3067\u5149\u306e\u901f\u3055\u306eWEB\u30b5\u30fc\u30d0\u30fc\u3092\u5149\u306e\u901f\u3055\u3067\u69cb\u6210\u3057\u3066\u307f\u308b\u3002\n\n# \u6982\u8981\nAnsible\u3067\u3055\u304f\u3089VPS\u306e\u521d\u671f\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u3092\u81ea\u52d5\u5316\u3057\u307e\u3059\u3002\n\n# \u74b0\u5883\n+ \u3055\u304f\u3089VPS\n+ CentOS7.3\n+ Ansible2.2.1.0\n\n# \u524d\u63d0\u77e5\u8b58\n+ \u3055\u304f\u3089VPS\u3092\u306e\u521d\u671f\u8a2d\u5b9a\u306e\u6d41\u308c\u3092\u7406\u89e3\u3057\u3066\u3044\u308b\u3053\u3068\u3002\n  + [\u3055\u304f\u3089VPS\u306e\u521d\u671f\u8a2d\u5b9a](google.com)\n\n# \u3055\u304f\u3089VPS\u306bCentOS7\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\u3055\u304f\u3089VPS\u306e\u30b3\u30f3\u30bd\u30fc\u30eb\u753b\u9762\u304b\u3089`OS\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb>\u30ab\u30b9\u30bf\u30e0OS\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb`\u3092\u9078\u629e\u3057\u3066CentOS7\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u304c\u958b\u59cb\u3055\u308c\u308b\u3068\u3001CentOS7\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u7528\u30b3\u30f3\u30bd\u30fc\u30eb\u753b\u9762\uff08VNC\u30b3\u30f3\u30bd\u30fc\u30eb\u306eHTML5\u7248\u304bJava Applet\u7248\uff09\u3092\u958b\u304f\u3053\u3068\u304c\u3067\u304d\u308b\u306e\u3067\u3001\u74b0\u5883\u306b\u5408\u308f\u305b\u3066\u597d\u304d\u306a\u65b9\u3092\u9078\u3073\u307e\u3059\u3002\n\nCentOS7\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3067\u306f\u3001\u8a00\u8a9e\u8a2d\u5b9a\u3084\u30c7\u30a3\u30b9\u30af\u306e\u521d\u671f\u5316\u306a\u3069\u884c\u3046\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\nroot\u30e6\u30fc\u30b6\u30fc\u306e\u30d1\u30b9\u30ef\u30fc\u30c9\u8a2d\u5b9a\u3068\u65b0\u898f\u30e6\u30fc\u30b6\u30fc\u4f5c\u6210\u3092\u3059\u308b\u753b\u9762\u304c\u3042\u308a\u307e\u3059\u304c\u3001\u65b0\u898f\u30e6\u30fc\u30b6\u30fc\u4f5c\u6210\u306fAnsible\u3067\u884c\u3046\u306e\u3067\u3001root\u30e6\u30fc\u30b6\u30fc\u306e\u30d1\u30b9\u30ef\u30fc\u30c9\u8a2d\u5b9a\u306e\u307f\u3060\u3051\u3067OK\u3067\u3059\u3002\n\n\u6b21\u306b\u3001\u516c\u958b\u9375\u3092ansible\u30db\u30b9\u30c8\u5074\u304b\u3089\u3055\u304f\u3089VPS\u306b\u9001\u308a\u307e\u3059\u3002\uff08\u9375\u306f\u4e8b\u524d\u306b\u4f5c\u6210\u3057\u3066\u304a\u3044\u3066\u304f\u3060\u3055\u3044\u3002\u3053\u3053\u3067\u306f\u5272\u611b\u3057\u307e\u3059\u3002\uff09\n\u3053\u3061\u3089\u306e\u9375\u306fAnsible\u3067\u65b0\u898f\u306b\u4f5c\u6210\u3059\u308b\u30e6\u30fc\u30b6\u30fc\u7528\u306e\u9375\u3067\u3059\u3002\n`ssh-copy-id -i ~/.ssh/id_rsa.pub root@123.45.678.910`\n\n`ssh root@123.45.678.901`\u3067\u3055\u304f\u3089VPS\u306bssh\u63a5\u7d9a\u3067\u304d\u308c\u3070\u6e96\u5099OK\u3067\u3059\u3002\n\n# Ansible\u3067\u3055\u304f\u3089VPS\u306e\u521d\u671f\u8a2d\u5b9a\u3092\u3059\u308b\n\n## hosts\u30d5\u30a1\u30a4\u30eb\u3092\u5b9a\u7fa9\nhosts\n\n```\n[sakura]\n123.45.678.910 ansible_ssh_user=root ansible_ssh_private_key_file=~/.ssh/id_rsa\n\n[hogemoge]\n123.45.678.910 ansible_ssh_user=hogemoge ansible_ssh_port=50055 ansible_ssh_private_key_file=~/.ssh/id_rsa\n```\n\n## Playbook\u3092\u5b9a\u7fa9\n\u30bf\u30b9\u30af\u5185\u5bb9\u306f\u3053\u3093\u306a\u611f\u3058\u3067\u3059\u3002\n\n+ \u30e6\u30fc\u30b6\u30fc\u3092\u65b0\u898f\u4f5c\u6210\u3059\u308b\n+ authorize_keys\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3059\u308b\n+ authorize_keys\u30d5\u30a1\u30a4\u30eb\u306e\u30d1\u30fc\u30df\u30c3\u30b7\u30e7\u30f3\u3092\u8abf\u6574\u3059\u308b\n+ wheel\u30b0\u30eb\u30fc\u30d7\u306bsudo\u6a29\u9650\u3092\u4e0e\u3048\u308b\n+ root\u30e6\u30fc\u30b6\u30fc\u3067\u306essh\u63a5\u7d9a\u3092\u7981\u6b62\u3059\u308b\n+ ssh\u63a5\u7d9a\u306e\u30dd\u30fc\u30c8\u756a\u53f7\u3092\u5909\u66f4\u3059\u308b\n+ iptables\u306etcp\u30dd\u30fc\u30c8\u3092\u5909\u66f4\u3059\u308b\n+ ssh\u30dd\u30fc\u30c8\u3092\u30b7\u30e3\u30c3\u30c8\u30c0\u30a6\u30f3\u3059\u308b\n+ SELinux\u3092disabled\u306b\u8a2d\u5b9a\u3059\u308b\n\n1\u70b9\u6ce8\u610f\u70b9\u304c\u3042\u308a\u307e\u3059\u3002\n`ssh_user_password`\u306f`openssl`\u3067\u6697\u53f7\u5316\u3057\u305f\u3082\u306e\u3092\u6307\u5b9a\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\n`openssl passwd -salt hoge -1 moge`\n\nPlaybook\u306f\u53c2\u8003\u30b5\u30a4\u30c8\u3092\u5927\u3044\u306b\u53c2\u8003\u306b\u3055\u305b\u3066\u9802\u304d\u307e\u3057\u305f\u3002m(_ _)m\n\ninit.yml\n\n```\n---\n- hosts: sakura\n  become: yes\n  user: root\n  vars:\n    ssh_user: hogemoge\n    ssh_user_password: hogehogemogemoge\n    ssh_port: 50055\n  tasks:\n  - name: Add a new user\n    user:\n     name=\"{{ ssh_user }}\"\n     groups=wheel\n     password=\"{{ ssh_user_password }}\"\n     generate_ssh_key=yes\n     ssh_key_bits=2048\n\n  - name: Create an authorize_keys file\n    command: /bin/cp /home/{{ ssh_user }}/.ssh/id_rsa.pub /home/{{ ssh_user}}/.ssh/authorized_keys\n\n  - name: Change attributes of an authorized_keys file\n    file:\n     path: /home/{{ ssh_user }}/.ssh/authorized_keys\n     owner: \"{{ ssh_user }}\"\n     group: \"{{ ssh_user }}\"\n     mode: 0600\n\n  - name: Allow wheel group to use sudo\n    lineinfile:\n     dest: /etc/sudoers\n     state: present\n     insertafter: \"^# %wheel\\\\s+ALL=\\\\(ALL\\\\)\\\\s+NOPASSWD:\\\\s+ALL\"\n     line: \"%wheel ALL=(ALL) NOPASSWD: ALL\"\n     validate: \"visudo -cf %s\"\n     backup: yes\n\n  - name: Forbid root to access via ssh\n    lineinfile:\n     dest: /etc/ssh/sshd_config\n     state: present\n     regexp: \"^PermitRootLogin without-password\"\n     line: \"PermitRootLogin no\"\n     backrefs: yes\n     validate: \"sshd -T -f %s\"\n     backup: yes\n    notify:\n     - restart sshd\n\n  - name: Permit only specific user to access via ssh\n    lineinfile:\n     dest: /etc/ssh/sshd_config\n     state: present\n     insertafter: \"^PasswordAuthentication no\"\n     regexp: \"^AllowUsers\"\n     line: \"AllowUsers {{ ssh_user }}\"\n     validate: \"sshd -T -f %s\"\n     backup: yes\n    notify:\n     - restart sshd\n\n  - name: Change ssh port number\n    lineinfile:\n     dest: /etc/ssh/sshd_config\n     state: present\n     insertafter: \"^#Port 22\"\n     regexp: \"^Port\"\n     line: \"Port {{ ssh_port }}\"\n     validate: \"sshd -T -f %s\"\n     backup: yes\n    notify:\n     - restart sshd\n\n  - name: Change acceptable tcp port for ssh on iptables\n    firewalld: port={{ ssh_port }}/tcp permanent=true state=enabled immediate=yes\n\n  - name: shutdown ssh port\n    firewalld: service=sshd permanent=true state=disabled immediate=yes\n\n  - name: disable selinux\n    selinux: state=disabled\n```\n\n## handler\u3092\u5b9a\u7fa9\n\u30cf\u30f3\u30c9\u30e9\u30fc\u3092\u5b9a\u7fa9\u3057\u307e\u3059\u3002\n\nmain.yml\n\n```\n---\n- name: restart sshd\n  service: name=iptables start restarted\n```\n\n# Ansible\u5b9f\u884c\n`ansible-playbook sakura.yml -i hosts -k -c paramiko`\n\n\u30bf\u30b9\u30af\u306e\u5b9f\u884c\u304c\u5168\u3066\u5b8c\u4e86\u3057\u305f\u3089\u3001\u30b5\u30fc\u30d0\u30fc\u3092\u4e00\u5ea6\u518d\u8d77\u52d5\u3057\u3066\u5b8c\u4e86\u3067\u3059\u3002\n\n# \u53c2\u8003\n+ [Ansible\u3067\u3055\u304f\u3089VPS\u306e\u521d\u671f\u8a2d\u5b9a](http://qiita.com/meganii/items/8c91a43e52bd5d61cdde#hosts)\n+ [Ansible\u3067\u5149\u306e\u901f\u3055\u306eWEB\u30b5\u30fc\u30d0\u30fc\u3092\u5149\u306e\u901f\u3055\u3067\u69cb\u6210\u3057\u3066\u307f\u308b\u3002](http://qiita.com/sak_2/items/7dd3dcd864f93103f0db#%E3%81%95%E3%81%8F%E3%82%89vps%E5%81%B4%E3%81%AE%E6%BA%96%E5%82%99)\n", "tags": ["\u3055\u304f\u3089VPS", "centos7.3", "Ansible"]}