{"tags": ["netflow", "fluentd", "influxdb", "grafana", "docker"], "context": "\u30eb\u30fc\u30bf\u30fc\u304b\u3089\u30a8\u30af\u30b9\u30dd\u30fc\u30c8\u3055\u308c\u308bNetFlow version 9\u30ec\u30b3\u30fc\u30c9\u3092\u53ce\u96c6\u3057\u3066\u30c8\u30e9\u30d5\u30a3\u30c3\u30af\u72b6\u6cc1\u3092\u8996\u899a\u5316\u3001\u5206\u6790\u3059\u308b\u30b7\u30b9\u30c6\u30e0\u3092\u69cb\u7bc9\u3057\u3066\u307f\u307e\u3057\u305f\u3002\n\n\u5b8c\u6210\u54c1\u30a4\u30e1\u30fc\u30b8\nGrafana\u306b\u3088\u308bNetFlow\u30c8\u30e9\u30d5\u30a3\u30c3\u30af\u53ef\u8996\u5316\u30c0\u30c3\u30b7\u30e5\u30dc\u30fc\u30c9\n\n\n\u76ee\u7684\nNetFlow v9\u306b\u5bfe\u5fdc\u3057\u305f\u30d5\u30ea\u30fc\u306e\u53ef\u8996\u5316\u30bd\u30d5\u30c8\u30a6\u30a7\u30a2\u304c\u5c11\u306a\u304f\u3001\u5546\u7528\u30bd\u30d5\u30c8\u30a6\u30a8\u30a2\u306f\u9ad8\u4fa1\u306a\u305f\u3081\u3001\u6c17\u8efd\u306b\u53ef\u8996\u5316\u3067\u304d\u308b\u3057\u304f\u307f\u3092\u4f5c\u308c\u306a\u3044\u304b\u3068\u601d\u3063\u3066\u3044\u305f\u3068\u3053\u308d\u3001NetOpsCoding #3\u52c9\u5f37\u4f1a\u3067\u3001\u65e5\u672c\u30de\u30a4\u30af\u30ed\u30bd\u30d5\u30c8\u306e\u5317\u5cf6\u3055\u3093\u306e\u300cMonitoring Intelligence\u300d\u3068\u3044\u3046\u30d7\u30ed\u30b0\u30e9\u30e0\u7d39\u4ecb\u3055\u308c\u3066\u3044\u305f\u30c4\u30fc\u30eb\u3092\u5fdc\u7528\u3059\u308c\u3070\u4f5c\u308c\u305d\u3046\u304b\u306a\u3068\u601d\u3044\u30c8\u30e9\u30a4\u3057\u3066\u307f\u307e\u3057\u305f\u3002\n\n\u69cb\u7bc9\n\nNetFlow\u30a8\u30af\u30b9\u30dd\u30fc\u30bf\u30fc(\u30eb\u30fc\u30bf\u30fc)\u306e\u6e96\u5099\u3001\u69cb\u7bc9\nCisco ASR1001\u3092\u4f7f\u3063\u3066\u307f\u307e\u3057\u305f\u3002\n\nCisco ASR 1001\n\n\nIOS XE Software, Version 03.16.03.S\n\n\n\nCisco AVC(Application Visibility and Control)\u3068\u3044\u3046\u6a5f\u80fd\u3067\u3001\u30c8\u30e9\u30d5\u30a3\u30c3\u30af\u3092\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u8b58\u5225\u3055\u305b\u308b\u30d5\u30a3\u30fc\u30eb\u30c9\u3092NetFlow v9\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u306b\u8f09\u305b\u3066\u307f\u307e\u3057\u305f\u3002\n\u8a2d\u5b9a\u306f\u3053\u3093\u306a\u611f\u3058\u3067\u3059\u3002\n\n\u30d5\u30ed\u30fc\u30ec\u30b3\u30fc\u30c9\u60c5\u5831\u3068\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u51fa\u529b\u3092\u78ba\u8a8d\u3002\n#show flow monitor monitor-avc-monitoring cache format table \n\nIPV4 SRC ADDR    IPV4 DST ADDR    APP NAME                          trns src port  trns dst port  intf input            intf output                bytes        pkts    time first     time last  ip prot\n===============  ===============  ================================  =============  =============  ====================  ====================  ==========  ==========  ============  ============  =======\nX.X.X.X          X.X.X.X          layer7 twitter                            52441            443  Gi0/0/1               Gi0/0/0                     4898          37  11:43:44.132  11:43:51.553        6\nX.X.X.X          X.X.X.X          layer7 facebook                             443          52321  Gi0/0/0               Gi0/0/1                   112313         130  11:43:27.969  11:43:52.749        6\nX.X.X.X          X.X.X.X          layer7 skype                              51200            443  Gi0/0/1               Gi0/0/0                      793           3  11:43:27.383  11:43:31.048        6\nX.X.X.X          X.X.X.X          layer7 ssl                                  443          51467  Gi0/0/0               Gi0/0/1                    15644          12  11:43:33.639  11:43:33.789        6\nX.X.X.X          X.X.X.X          port telnet                                  23          52400  Gi0/0/0               Gi0/0/1                     8269          11  11:43:36.925  11:43:55.947        6\nX.X.X.X          X.X.X.X          layer7 google-services                      443          52469  Gi0/0/0               Gi0/0/1                      712           9  11:43:49.134  11:43:49.351        6\n\n#show flow exporter exporter-avc-monitoring templates\nFlow Exporter exporter-avc-monitoring:\nClient: Flow Monitor monitor-avc-monitoring\nExporter Format: NetFlow Version 9\nTemplate ID    : 274\nSource ID      : 256\nRecord Size    : 41\nTemplate layout\n_____________________________________________________________________\n|                 Field                   |  Type | Offset |  Size  |\n---------------------------------------------------------------------\n| ipv4 source address                     |     8 |     0  |     4  |\n| ipv4 destination address                |    12 |     4  |     4  |\n| ip protocol                             |     4 |     8  |     1  |\n| transport source-port                   |     7 |     9  |     2  |\n| transport destination-port              |    11 |    11  |     2  |\n| interface input snmp                    |    10 |    13  |     4  |\n| application id                          |    95 |    17  |     4  |\n| interface output snmp                   |    14 |    21  |     4  |\n| counter bytes                           |     1 |    25  |     4  |\n| counter packets                         |     2 |    29  |     4  |\n| timestamp sys-uptime first              |    22 |    33  |     4  |\n| timestamp sys-uptime last               |    21 |    37  |     4  |\n---------------------------------------------------------------------\n\n\nNetFlow\u30b3\u30ec\u30af\u30bf\u30fc(\u53ef\u8996\u5316\u30c4\u30fc\u30eb)\u306e\u6e96\u5099\u3001\u69cb\u7bc9\nDockerHub\u4e0a\u306e\u30a4\u30e1\u30fc\u30b8\u3092\u4f7f\u3063\u3066Fluentd\u3068InfluxDB\u3001Grafana\u3092\u6e96\u5099\u3057\u307e\u3059\u3002\n\u4f7f\u7528\u3057\u305fOS, \u30c4\u30fc\u30eb\u306f\u4ee5\u4e0b\u3067\u3059\u3002\n\nUbuntu 16.04.1 LTS\nDocker 1.10.3\nDocker Image\n\n\nfluent/fluentd 0.12.28 (latest)\ninfluxdb 0.13.0 (latest)\ngrafana/grafana 3.1.1 (latest)\n\n\nFluentd Plugin\n\n\nfluent-plugin-influxdb (0.2.8)\nfluent-plugin-netflow (0.2.4)\n\n\n\n\nUbuntu/Docker\u306e\u6e96\u5099\nDocker\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u307e\u3059\u3002Ubuntu atp docker.io\u30d1\u30c3\u30b1\u30fc\u30b8\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u307e\u3059\u3002\n$ sudo apt install docker.io\n\n\nFluentd\u306e\u6e96\u5099\n\u30eb\u30fc\u30bf\u30fc\u304b\u3089\u306eNetFlow\u30c7\u30fc\u30bf\u3092\u53d7\u4fe1\u3057\u3066InfluxDB\u306b\u4fdd\u5b58\u3059\u308bFluentd\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u307e\u3059\u3002\nfluent-plugin-influxdb, fluent-plugin-netflow\u4e21\u65b9\u306e\u30d7\u30e9\u30b0\u30a4\u30f3\u306b\u5bfe\u5fdc\u3057\u305fDocker Image\u304c\u306a\u304b\u3063\u305f\u305f\u3081\u3001fluent project\u306eFluentd Docker Image (fluent/fluentd)\u3092clone\u3057\u3066\u30ab\u30b9\u30bf\u30de\u30a4\u30ba\u3057\u3066build\u3057\u307e\u3057\u305f\u3002\n$ git clone https://github.com/fluent/fluentd-docker-image.git\n$ cd fluentd-docker-image/\n\n\nDockerfile.\n$ diff -uw Dockerfile.orig Dockerfile\n--- Dockerfile.orig     2016-08-25 11:03:39.264019589 +0900\n+++ Dockerfile  2016-08-25 11:02:59.523127344 +0900\n@@ -14,6 +14,8 @@\n     echo 'gem: --no-document' >> /etc/gemrc && \\\n     gem install oj && \\\n     gem install fluentd -v 0.12.28 && \\\n+    gem install fluent-plugin-influxdb && \\\n+    gem install fluent-plugin-netflow && \\\n     apk del build-base ruby-dev && \\\n     rm -rf /tmp/* /var/tmp/* /var/cache/apk/* /usr/lib/ruby/gems/*/cache/*.gem\n\n\n\nfluent.conf\n<source>\n  type netflow\n  tag netflow\n  bind 172.17.0.3\n  port 9996\n</source>\n<match netflow>\n  type influxdb\n  host influxdb\n  port 8086\n  dbname netflow9\n  time_precision s\n  tag_keys [\"app_id\", \"first_switched\", \"last_switched\", \"flowset_id\", \"host\", \"input_snmp\", \"output_snmp\", \"ipv4_src_addr\", \"ipv4_dst_addr\", \"l4_src_port\", \"l4_dst_port\", \"protocol\", \"version\", \"ip_dscp\", \"ip_frag_offset\", \"ip_frag_flags\", \"icmp_ipv4_type\", \"icmp_ipv4_code\", \"tcp_ack_num\", \"tcp_header_len\", \"tcp_flags\" ]\n</match>\n<match **>\n type stdout\n</match>\n\n\n$ cd ..\n$ sudo docker build -t fluentd-netflow:fluentd fluentd-docker-image\n\n\nInfluxDB\u306e\u6e96\u5099\n$ sudo docker pull influxdb\n\n\nGrafana\u306e\u6e96\u5099\n$ sudo docker pull grafana/grafana\n\n\nDocker\u30a4\u30e1\u30fc\u30b8\u306e\u8d77\u52d5\nInfluxDB\u306e\u8d77\u52d5\u3001InfluxDB\u306e\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u3001Fluentd, Grafana\u8d77\u52d5\u306e\u9806\u306b\u304a\u3053\u306a\u3044\u307e\u3059\u3002\n$ sudo docker run -d --name=influxdb -p 8083:8083 -p 8086:8086 -v $HOME/influxdb:/var/lib/influxdb influxdb\n\n$ influx\n> create database netflow9\n> create retention policy netflow on netflow9 duration 8w replication 1 default\n\n$ sudo docker run -d --name=fluentd --link influxdb:influxdb -p 24224:24224 -p 9996:9996/udp -v $HOME/fluentd/:/var/lib/fluentd fluentd-netflow:fluentd\n\n$ sudo docker run -d --name=grafana --link influxdb:influxdb -p 3000:3000 -v $HOME/grafana/:/var/lib/grafana grafana/grafana\n\n\n\u30c7\u30fc\u30bf\u306e\u78ba\u8a8d\n\u4ee5\u4e0b\u306e\u69d8\u306a\u30b3\u30de\u30f3\u30c9\u3067\u30ec\u30b3\u30fc\u30c9\u304c\u51fa\u529b\u3055\u308c\u305f\u3089NetFlow\u30ec\u30b3\u30fc\u30c9\u306eDB\u66f8\u304d\u8fbc\u307f\u304c\u6210\u529f\u3057\u3066\u3044\u307e\u3059\u3002\n$ influx\n> use netflow9\n> select * from netflow where time > now() - 3m\n\n\nGrafana\u306e\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\nGrafana\u306e\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u306f\u300cGrafana\u3068InfluxDB\u3067\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u30ea\u30bd\u30fc\u30b9\u306e\u8996\u899a\u5316\u300d\u306e\u8a18\u4e8b\u304c\u53c2\u8003\u306b\u306a\u308a\u307e\u3059\u3002\nGrafana\u306eGraph\u8a2d\u5b9a\u306eMetrics\u9805\u76ee\u306b\u8a2d\u5b9a\u3059\u308b\u5185\u5bb9\u306f\u4ee5\u4e0b\u3092\u53c2\u8003\u306b\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\u30a4\u30f3\u30bf\u30fc\u30d5\u30a7\u30fc\u30b9\u304b\u3089\u5165\u3063\u3066\u304f\u308b\u30c8\u30e9\u30d5\u30a3\u30c3\u30af\nSELECT sum(\"in_bytes\") *8/30.0 FROM \"netflow\" WHERE \"input_snmp\" = '1' AND  $timeFilter GROUP BY time(30s) fill(0)\n\n\u30a4\u30f3\u30bf\u30fc\u30d5\u30a7\u30fc\u30b9\u304b\u3089\u5165\u3063\u3066\u304f\u308bTCP\u30c8\u30e9\u30d5\u30a3\u30c3\u30af\nSELECT sum(\"in_bytes\") *8/30.0 FROM \"netflow\" WHERE \"input_snmp\" = '1' AND \"protocol\" = '6' AND  $timeFilter GROUP BY time(30s) fill(0)\n\n\u30a4\u30f3\u30bf\u30fc\u30d5\u30a7\u30fc\u30b9\u304b\u3089\u5165\u3063\u3066\u304f\u308b\u30c8\u30e9\u30d5\u30a3\u30c3\u30af\u306e\u3046\u3061Cisco AVC\u3067Twitter\u3068\u8b58\u5225\u3055\u308c\u308b\u30c8\u30e9\u30d5\u30a3\u30c3\u30af\nSELECT sum(\"in_bytes\") *8/30.0 FROM \"netflow\" WHERE \"input_snmp\" = '1' AND \"app_id\" = '218104325' AND $timeFilter GROUP BY time(30s) fill(0)\n\n\n\u5b8c\u6210\n\u8272\u3005\u3068\u8a66\u3057\u3066\u307f\u3066\u304f\u3060\u3055\u3044\u3002\n\u30b3\u30e1\u30f3\u30c8\u306a\u3069\u6b53\u8fce\u3057\u307e\u3059\u3002\n\n\u53c2\u8003\u8cc7\u6599\n\nFreeware NetFlow Software - Cisco IOS NetFlow\nNetOpsCoding #3\nGrafana\u3068InfluxDB\u3067\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u30ea\u30bd\u30fc\u30b9\u306e\u8996\u899a\u5316\nELK\u306b\u3088\u308b\u69cb\u7bc9\u8a18\u4e8b - Step-by-Step Setup of ELK for NetFlow Analytics\n\n\u30eb\u30fc\u30bf\u30fc\u304b\u3089\u30a8\u30af\u30b9\u30dd\u30fc\u30c8\u3055\u308c\u308bNetFlow version 9\u30ec\u30b3\u30fc\u30c9\u3092\u53ce\u96c6\u3057\u3066\u30c8\u30e9\u30d5\u30a3\u30c3\u30af\u72b6\u6cc1\u3092\u8996\u899a\u5316\u3001\u5206\u6790\u3059\u308b\u30b7\u30b9\u30c6\u30e0\u3092\u69cb\u7bc9\u3057\u3066\u307f\u307e\u3057\u305f\u3002\n\n#\u5b8c\u6210\u54c1\u30a4\u30e1\u30fc\u30b8\nGrafana\u306b\u3088\u308bNetFlow\u30c8\u30e9\u30d5\u30a3\u30c3\u30af\u53ef\u8996\u5316\u30c0\u30c3\u30b7\u30e5\u30dc\u30fc\u30c9\n\n![grafana_dashboard2.png](https://qiita-image-store.s3.amazonaws.com/0/134927/78ea4ce3-418b-7c17-0a16-ddc4208c577e.png)\n\n#\u76ee\u7684\n[NetFlow v9\u306b\u5bfe\u5fdc\u3057\u305f\u30d5\u30ea\u30fc\u306e\u53ef\u8996\u5316\u30bd\u30d5\u30c8\u30a6\u30a7\u30a2](http://www.cisco.com/c/en/us/products/ios-nx-os-software/ios-netflow/networking_solutions_products_genericcontent0900aecd805ff72b.html)\u304c\u5c11\u306a\u304f\u3001\u5546\u7528\u30bd\u30d5\u30c8\u30a6\u30a8\u30a2\u306f\u9ad8\u4fa1\u306a\u305f\u3081\u3001\u6c17\u8efd\u306b\u53ef\u8996\u5316\u3067\u304d\u308b\u3057\u304f\u307f\u3092\u4f5c\u308c\u306a\u3044\u304b\u3068\u601d\u3063\u3066\u3044\u305f\u3068\u3053\u308d\u3001[NetOpsCoding #3](https://atnd.org/events/78025)\u52c9\u5f37\u4f1a\u3067\u3001\u65e5\u672c\u30de\u30a4\u30af\u30ed\u30bd\u30d5\u30c8\u306e\u5317\u5cf6\u3055\u3093\u306e\u300cMonitoring Intelligence\u300d\u3068\u3044\u3046\u30d7\u30ed\u30b0\u30e9\u30e0\u7d39\u4ecb\u3055\u308c\u3066\u3044\u305f\u30c4\u30fc\u30eb\u3092\u5fdc\u7528\u3059\u308c\u3070\u4f5c\u308c\u305d\u3046\u304b\u306a\u3068\u601d\u3044\u30c8\u30e9\u30a4\u3057\u3066\u307f\u307e\u3057\u305f\u3002\n\n#\u69cb\u7bc9\n## NetFlow\u30a8\u30af\u30b9\u30dd\u30fc\u30bf\u30fc(\u30eb\u30fc\u30bf\u30fc)\u306e\u6e96\u5099\u3001\u69cb\u7bc9\nCisco ASR1001\u3092\u4f7f\u3063\u3066\u307f\u307e\u3057\u305f\u3002\n\n- Cisco ASR 1001\n - IOS XE Software, Version 03.16.03.S\n\nCisco AVC(Application Visibility and Control)\u3068\u3044\u3046\u6a5f\u80fd\u3067\u3001\u30c8\u30e9\u30d5\u30a3\u30c3\u30af\u3092\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u8b58\u5225\u3055\u305b\u308b\u30d5\u30a3\u30fc\u30eb\u30c9\u3092NetFlow v9\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u306b\u8f09\u305b\u3066\u307f\u307e\u3057\u305f\u3002\n\n\u8a2d\u5b9a\u306f\u3053\u3093\u306a\u611f\u3058\u3067\u3059\u3002\n![cisco_netflow_config.png](https://qiita-image-store.s3.amazonaws.com/0/134927/3519df6f-10ab-d00b-78ac-0b908d56b4f8.png)\n\n\n\u30d5\u30ed\u30fc\u30ec\u30b3\u30fc\u30c9\u60c5\u5831\u3068\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u51fa\u529b\u3092\u78ba\u8a8d\u3002\n\n```\n#show flow monitor monitor-avc-monitoring cache format table \n\nIPV4 SRC ADDR    IPV4 DST ADDR    APP NAME                          trns src port  trns dst port  intf input            intf output                bytes        pkts    time first     time last  ip prot\n===============  ===============  ================================  =============  =============  ====================  ====================  ==========  ==========  ============  ============  =======\nX.X.X.X          X.X.X.X          layer7 twitter                            52441            443  Gi0/0/1               Gi0/0/0                     4898          37  11:43:44.132  11:43:51.553        6\nX.X.X.X          X.X.X.X          layer7 facebook                             443          52321  Gi0/0/0               Gi0/0/1                   112313         130  11:43:27.969  11:43:52.749        6\nX.X.X.X          X.X.X.X          layer7 skype                              51200            443  Gi0/0/1               Gi0/0/0                      793           3  11:43:27.383  11:43:31.048        6\nX.X.X.X          X.X.X.X          layer7 ssl                                  443          51467  Gi0/0/0               Gi0/0/1                    15644          12  11:43:33.639  11:43:33.789        6\nX.X.X.X          X.X.X.X          port telnet                                  23          52400  Gi0/0/0               Gi0/0/1                     8269          11  11:43:36.925  11:43:55.947        6\nX.X.X.X          X.X.X.X          layer7 google-services                      443          52469  Gi0/0/0               Gi0/0/1                      712           9  11:43:49.134  11:43:49.351        6\n```\n\n```\n#show flow exporter exporter-avc-monitoring templates\nFlow Exporter exporter-avc-monitoring:\nClient: Flow Monitor monitor-avc-monitoring\nExporter Format: NetFlow Version 9\nTemplate ID    : 274\nSource ID      : 256\nRecord Size    : 41\nTemplate layout\n_____________________________________________________________________\n|                 Field                   |  Type | Offset |  Size  |\n---------------------------------------------------------------------\n| ipv4 source address                     |     8 |     0  |     4  |\n| ipv4 destination address                |    12 |     4  |     4  |\n| ip protocol                             |     4 |     8  |     1  |\n| transport source-port                   |     7 |     9  |     2  |\n| transport destination-port              |    11 |    11  |     2  |\n| interface input snmp                    |    10 |    13  |     4  |\n| application id                          |    95 |    17  |     4  |\n| interface output snmp                   |    14 |    21  |     4  |\n| counter bytes                           |     1 |    25  |     4  |\n| counter packets                         |     2 |    29  |     4  |\n| timestamp sys-uptime first              |    22 |    33  |     4  |\n| timestamp sys-uptime last               |    21 |    37  |     4  |\n---------------------------------------------------------------------\n```\n\n\n## NetFlow\u30b3\u30ec\u30af\u30bf\u30fc(\u53ef\u8996\u5316\u30c4\u30fc\u30eb)\u306e\u6e96\u5099\u3001\u69cb\u7bc9\nDockerHub\u4e0a\u306e\u30a4\u30e1\u30fc\u30b8\u3092\u4f7f\u3063\u3066Fluentd\u3068InfluxDB\u3001Grafana\u3092\u6e96\u5099\u3057\u307e\u3059\u3002\n\n\u4f7f\u7528\u3057\u305fOS, \u30c4\u30fc\u30eb\u306f\u4ee5\u4e0b\u3067\u3059\u3002\n\n- Ubuntu 16.04.1 LTS\n- Docker 1.10.3\n- Docker Image\n - fluent/fluentd 0.12.28 (latest)\n - influxdb 0.13.0 (latest)\n - grafana/grafana 3.1.1 (latest)\n- Fluentd Plugin\n - fluent-plugin-influxdb (0.2.8)\n - fluent-plugin-netflow (0.2.4)\n\n### Ubuntu/Docker\u306e\u6e96\u5099\nDocker\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u307e\u3059\u3002Ubuntu atp docker.io\u30d1\u30c3\u30b1\u30fc\u30b8\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u307e\u3059\u3002\n\n```\n$ sudo apt install docker.io\n```\n\n### Fluentd\u306e\u6e96\u5099\n\u30eb\u30fc\u30bf\u30fc\u304b\u3089\u306eNetFlow\u30c7\u30fc\u30bf\u3092\u53d7\u4fe1\u3057\u3066InfluxDB\u306b\u4fdd\u5b58\u3059\u308bFluentd\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u307e\u3059\u3002\nfluent-plugin-influxdb, fluent-plugin-netflow\u4e21\u65b9\u306e\u30d7\u30e9\u30b0\u30a4\u30f3\u306b\u5bfe\u5fdc\u3057\u305fDocker Image\u304c\u306a\u304b\u3063\u305f\u305f\u3081\u3001fluent project\u306eFluentd Docker Image (fluent/fluentd)\u3092clone\u3057\u3066\u30ab\u30b9\u30bf\u30de\u30a4\u30ba\u3057\u3066build\u3057\u307e\u3057\u305f\u3002\n\n```\n$ git clone https://github.com/fluent/fluentd-docker-image.git\n$ cd fluentd-docker-image/\n```\n\n```Dockerfile. \n$ diff -uw Dockerfile.orig Dockerfile\n--- Dockerfile.orig     2016-08-25 11:03:39.264019589 +0900\n+++ Dockerfile  2016-08-25 11:02:59.523127344 +0900\n@@ -14,6 +14,8 @@\n     echo 'gem: --no-document' >> /etc/gemrc && \\\n     gem install oj && \\\n     gem install fluentd -v 0.12.28 && \\\n+    gem install fluent-plugin-influxdb && \\\n+    gem install fluent-plugin-netflow && \\\n     apk del build-base ruby-dev && \\\n     rm -rf /tmp/* /var/tmp/* /var/cache/apk/* /usr/lib/ruby/gems/*/cache/*.gem\n```\n\n```fluent.conf\n<source>\n  type netflow\n  tag netflow\n  bind 172.17.0.3\n  port 9996\n</source>\n<match netflow>\n  type influxdb\n  host influxdb\n  port 8086\n  dbname netflow9\n  time_precision s\n  tag_keys [\"app_id\", \"first_switched\", \"last_switched\", \"flowset_id\", \"host\", \"input_snmp\", \"output_snmp\", \"ipv4_src_addr\", \"ipv4_dst_addr\", \"l4_src_port\", \"l4_dst_port\", \"protocol\", \"version\", \"ip_dscp\", \"ip_frag_offset\", \"ip_frag_flags\", \"icmp_ipv4_type\", \"icmp_ipv4_code\", \"tcp_ack_num\", \"tcp_header_len\", \"tcp_flags\" ]\n</match>\n<match **>\n type stdout\n</match>\n```\n\n```\n$ cd ..\n$ sudo docker build -t fluentd-netflow:fluentd fluentd-docker-image\n```\n\n### InfluxDB\u306e\u6e96\u5099\n```\n$ sudo docker pull influxdb\n```\n\n### Grafana\u306e\u6e96\u5099\n```\n$ sudo docker pull grafana/grafana\n```\n\n### Docker\u30a4\u30e1\u30fc\u30b8\u306e\u8d77\u52d5\nInfluxDB\u306e\u8d77\u52d5\u3001InfluxDB\u306e\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u3001Fluentd, Grafana\u8d77\u52d5\u306e\u9806\u306b\u304a\u3053\u306a\u3044\u307e\u3059\u3002\n\n```\n$ sudo docker run -d --name=influxdb -p 8083:8083 -p 8086:8086 -v $HOME/influxdb:/var/lib/influxdb influxdb\n\n$ influx\n> create database netflow9\n> create retention policy netflow on netflow9 duration 8w replication 1 default\n\n$ sudo docker run -d --name=fluentd --link influxdb:influxdb -p 24224:24224 -p 9996:9996/udp -v $HOME/fluentd/:/var/lib/fluentd fluentd-netflow:fluentd\n\n$ sudo docker run -d --name=grafana --link influxdb:influxdb -p 3000:3000 -v $HOME/grafana/:/var/lib/grafana grafana/grafana\n```\n\n\n### \u30c7\u30fc\u30bf\u306e\u78ba\u8a8d\n\u4ee5\u4e0b\u306e\u69d8\u306a\u30b3\u30de\u30f3\u30c9\u3067\u30ec\u30b3\u30fc\u30c9\u304c\u51fa\u529b\u3055\u308c\u305f\u3089NetFlow\u30ec\u30b3\u30fc\u30c9\u306eDB\u66f8\u304d\u8fbc\u307f\u304c\u6210\u529f\u3057\u3066\u3044\u307e\u3059\u3002\n\n```\n$ influx\n> use netflow9\n> select * from netflow where time > now() - 3m\n```\n\n### Grafana\u306e\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\nGrafana\u306e\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u306f[\u300cGrafana\u3068InfluxDB\u3067\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u30ea\u30bd\u30fc\u30b9\u306e\u8996\u899a\u5316\u300d]\n(http://qiita.com/kooshin/items/a770c6df33fe2ffb2d0b#%E6%BA%96%E5%82%99)\u306e\u8a18\u4e8b\u304c\u53c2\u8003\u306b\u306a\u308a\u307e\u3059\u3002\nGrafana\u306eGraph\u8a2d\u5b9a\u306eMetrics\u9805\u76ee\u306b\u8a2d\u5b9a\u3059\u308b\u5185\u5bb9\u306f\u4ee5\u4e0b\u3092\u53c2\u8003\u306b\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n```\n\u30a4\u30f3\u30bf\u30fc\u30d5\u30a7\u30fc\u30b9\u304b\u3089\u5165\u3063\u3066\u304f\u308b\u30c8\u30e9\u30d5\u30a3\u30c3\u30af\nSELECT sum(\"in_bytes\") *8/30.0 FROM \"netflow\" WHERE \"input_snmp\" = '1' AND  $timeFilter GROUP BY time(30s) fill(0)\n\n\u30a4\u30f3\u30bf\u30fc\u30d5\u30a7\u30fc\u30b9\u304b\u3089\u5165\u3063\u3066\u304f\u308bTCP\u30c8\u30e9\u30d5\u30a3\u30c3\u30af\nSELECT sum(\"in_bytes\") *8/30.0 FROM \"netflow\" WHERE \"input_snmp\" = '1' AND \"protocol\" = '6' AND  $timeFilter GROUP BY time(30s) fill(0)\n\n\u30a4\u30f3\u30bf\u30fc\u30d5\u30a7\u30fc\u30b9\u304b\u3089\u5165\u3063\u3066\u304f\u308b\u30c8\u30e9\u30d5\u30a3\u30c3\u30af\u306e\u3046\u3061Cisco AVC\u3067Twitter\u3068\u8b58\u5225\u3055\u308c\u308b\u30c8\u30e9\u30d5\u30a3\u30c3\u30af\nSELECT sum(\"in_bytes\") *8/30.0 FROM \"netflow\" WHERE \"input_snmp\" = '1' AND \"app_id\" = '218104325' AND $timeFilter GROUP BY time(30s) fill(0)\n```\n\n# \u5b8c\u6210\n\u8272\u3005\u3068\u8a66\u3057\u3066\u307f\u3066\u304f\u3060\u3055\u3044\u3002\n\u30b3\u30e1\u30f3\u30c8\u306a\u3069\u6b53\u8fce\u3057\u307e\u3059\u3002\n\n# \u53c2\u8003\u8cc7\u6599\n- [Freeware NetFlow Software - Cisco IOS NetFlow](http://www.cisco.com/c/en/us/products/ios-nx-os-software/ios-netflow/networking_solutions_products_genericcontent0900aecd805ff72b.html)\n\n- [NetOpsCoding #3](https://atnd.org/events/78025)\n\n- [Grafana\u3068InfluxDB\u3067\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u30ea\u30bd\u30fc\u30b9\u306e\u8996\u899a\u5316]\n(http://qiita.com/kooshin/items/a770c6df33fe2ffb2d0b#%E6%BA%96%E5%82%99)\n\n- [ELK\u306b\u3088\u308b\u69cb\u7bc9\u8a18\u4e8b - Step-by-Step Setup of ELK for NetFlow Analytics]\n(http://blogs.cisco.com/security/step-by-step-setup-of-elk-for-netflow-analytics)\n"}