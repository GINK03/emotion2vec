{"context": " More than 1 year has passed since last update.mruby\u3092\u4f7f\u3063\u3066\u3044\u3066segmentation fault\u3068\u304b\u51fa\u3066\u56f0\u3063\u305f\u3053\u3068\u306f\u7121\u3044\u3067\u3057\u3087\u3046\u304b\u3002\u3053\u3046\u3044\u3046\u5834\u5408\u306bgdb\u3067\u30c7\u30d0\u30c3\u30b0\u3059\u308b\u30ce\u30a6\u30cf\u30a6\u3092\u66f8\u304d\u307e\u3059\u3002gdb\u306e\u4f7f\u3044\u65b9\u306b\u3064\u3044\u3066\u306f\u3053\u3053\u3067\u306f\u8aac\u660e\u3057\u307e\u305b\u3093\u3002\n\n\u9006\u30a2\u30bb\u30f3\u30d6\u30e9\ngdb\u3067\u30c7\u30d0\u30c3\u30b0\u3059\u308b\u306a\u3089mruby\u306e\u30d0\u30a4\u30c8\u30b3\u30fc\u30c9\u306e\u9006\u30a2\u30bb\u30f3\u30d6\u30e9\u304c\u5fc5\u8981\u3067\u3059\u3002\u6a19\u6e96\u3067\u306fcodedump\u95a2\u6570\u304c\u7528\u610f\u3055\u308c\u3066\u3044\u307e\u3059\u304c\u3001\u306a\u305c\u304b\u3053\u3053\u3067\u8aac\u660e\u3059\u308b\u3088\u3046\u306a\u4f7f\u3044\u65b9\u306f\u3067\u304d\u306a\u3044\u3088\u3046\u3067\u3059\u3002mruby\u306eJIT\u3067\u4f7f\u3063\u3066\u3044\u308b\u3082\u306e\u304c\u3053\u3053\u306b\u3042\u308a\u307e\u3059\u306e\u3067\u3001\u30b3\u30d4\u30fc\u3057\u3066codedump.c\u3042\u305f\u308a\u306b\u3067\u3082\u5165\u308c\u3066\u304a\u3044\u3066\u304f\u304f\u3060\u3055\u3044\u3002\n\u3053\u308c\u3092\u4f7f\u3046\u3068\u3001\u5909\u6570mrb\u3068irep\u304c\u898b\u3048\u3066\u3044\u308c\u3070\u3001\u3053\u3093\u306a\u611f\u3058\u3067disasm_irep\u95a2\u6570\u3092\u547c\u3073\u51fa\u3059\u3053\u3068\u3067\u9006\u30a2\u30bb\u30f3\u30d6\u30eb\u3067\u304d\u307e\u3059\u3002\u898b\u3048\u3066\u3044\u306a\u3044\u5834\u5408\u3001gdb\u306eup\u30b3\u30de\u30f3\u30c9\u3067\u547c\u3073\u51fa\u3057\u5143\u3092\u8fbf\u3063\u3066\u3044\u3066\u898b\u3048\u308b\u3068\u3053\u308d\u304c\u3042\u308c\u3070\u305d\u3053\u3067\u5b9f\u884c\u53ef\u80fd\u3067\u3059\u3002disasm_irep\u306f\u5024\u3092\u8fd4\u3055\u306a\u3044\u306e\u3067call\u3092\u4f7f\u3046\u65b9\u304c\u3088\u3055\u305d\u3046\u3067\u3059\u304c\u3001p\u306e\u65b9\u304c\u77ed\u3044\u306e\u3067p\u3092\u826f\u304f\u4f7f\u3063\u3066\u3044\u307e\u3059\u304c\u597d\u307f\u306e\u554f\u984c\u3067\u3059\u3002\n(gdb) p disasm_irep (mrb, irep)\n   0 OP_ENTER   0:0:1:0:0:0:0\n   1 OP_LOADSELF        R3\n   2 OP_ARRAY   R4      R4      0\n   3 OP_MOVE    R5      R1      ; R1:names\n   4 OP_ARYCAT  R4      R5\n   5 OP_SEND    R3      :attr_reader    127\n   6 OP_LOADSELF        R3\n   7 OP_ARRAY   R4      R4      0\n   8 OP_MOVE    R5      R1      ; R1:names\n   9 OP_ARYCAT  R4      R5\n   a OP_SEND    R3      :attr_writer    127\n   b OP_RETURN  R3      normal\n$6 = void\n(gdb)\n\n\u307e\u305f\u3001\u73fe\u5728\u3069\u306e\u30e1\u30bd\u30c3\u30c9\u3084\u30d6\u30ed\u30c3\u30af\u3068\u3044\u3046\u30ec\u30d9\u30eb\u3067\u306f\u306a\u304f\u3069\u306e\u547d\u4ee4\u3092\u5b9f\u884c\u4e2d\u304b\u77e5\u308a\u305f\u3044\u5834\u5408\u3082\u3042\u308a\u307e\u3059\u3002\u305d\u3046\u3044\u3046\u5834\u5408\u306b\u306f\u3001disasm_once\u3092\u4f7f\u3044\u307e\u3059\u3002\u3053\u306e\u3070\u3042\u3044\u3001\u5909\u6570pc\u304c\u898b\u3048\u3066\u3044\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n(gdb) p disasm_once (mrb, irep, *pc)\nOP_ENTER        0:0:1:0:0:0:0\n$7 = void\n(gdb)\n\npc\u306f\u30c7\u30ea\u30d5\u30a1\u30ec\u30f3\u30b9\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\nVM\u306e\u30ec\u30b8\u30b9\u30bf\nmruby\u306eVM\u3067\u306f\u30e1\u30bd\u30c3\u30c9\u306e\u5f15\u6570\u3068\u304b\u30ed\u30fc\u30ab\u30eb\u5909\u6570\u3068\u304b\u306bRITE VM\u306e\u30ec\u30b8\u30b9\u30bf\u3092\u4f7f\u3044\u307e\u3059\u3002\u30c7\u30d0\u30c3\u30b0\u3067\u3001VM\u306e\u30ec\u30b8\u30b9\u30bf\u304c\u307f\u305f\u3044\u3053\u3068\u304c\u826f\u304f\u3042\u308a\u307e\u3059\u3002\u3053\u306e\u3088\u3046\u306a\u5834\u5408\u306f\u3001\u6700\u5bc4\u308a\u306e mrb_context_run\u307e\u3067up\u30b3\u30de\u30f3\u30c9\u3067\u4e0a\u3063\u3066\u884c\u3063\u3066\u3001p regs[\u30ec\u30b8\u30b9\u30bf\u756a\u53f7]\u3068\u3057\u307e\u3059\u3002\u30ec\u30b8\u30b9\u30bf\u756a\u53f7\u304c0\u306f\u5e38\u306bself\u3067\u3042\u308b\u3053\u3068\u306f\u899a\u3048\u3066\u304a\u3044\u3066\u640d\u306f\u306a\u3044\u3067\u3057\u3087\u3046\u3002\n(gdb) down\n#0  mrb_irep_incref (mrb=mrb@entry=0x200398d0, irep=irep@entry=0x400d1250)\n    at C:\\cygwin\\home\\PCUser\\work\\mruby\\src\\state.c:129\n129       irep->refcnt++;\n(gdb) up\n#1  0x0041f090 in mrb_proc_new (mrb=mrb@entry=0x200398d0,\n    irep=irep@entry=0x400d1250)\n    at C:\\cygwin\\home\\PCUser\\work\\mruby\\src\\proc.c:32\n32        mrb_irep_incref(mrb, irep);\n(gdb) up\n#2  0x00433dc1 in mrb_context_run (mrb=mrb@entry=0x200398d0, proc=0x2003c380,\n    proc@entry=0x2003c578, self=..., stack_keep=stack_keep@entry=0)\n    at C:\\cygwin\\home\\PCUser\\work\\mruby\\src\\vm.c:2321\n2321                    p = mrb_proc_new(mrb, nirep);\n(gdb) p regs[0]\n$8 = {{f = -nan(0xa2003bc60), value = {{{p = 537115744, i = 537115744,\n          sym = 537115744}, ttt = 4293918730}}}}\n\nmruby\u306e\u751f\u306emrb_value\u578b\u3067\u306f\u304a\u8179\u3092\u58ca\u3059\u4eba\u306f\u3001mrb_p\u95a2\u6570\u304c\u4fbf\u5229\u3067\u3059\u3002mrb\u3092\u6e21\u3059\u3053\u3068\u306b\u6ce8\u610f\u3057\u307e\u3057\u3087\u3046\u3002\n(gdb) p mrb_p(mrb, regs[0])\nStopIteration\n$9 = void\n\n\n\u30d0\u30c3\u30af\u30c8\u30ec\u30fc\u30b9\nmruby\u304c\u3069\u3046\u3044\u3063\u305f\u547c\u3073\u51fa\u3057\u5c65\u6b74\u3067\u843d\u3061\u3066\u3057\u307e\u3063\u305f\u306e\u304b\u3001\u77e5\u308a\u305f\u3044\u5834\u5408\u3082\u3088\u304f\u3042\u308a\u307e\u3059\u3002\u305d\u3093\u306a\u3068\u304d\u306f\u3001\u3053\u308c\u3092.gdb\u306b\u5165\u308c\u3066\u304a\u3051\u3070\u3001mbt\u3068\u6253\u3064\u3068\u30d0\u30c3\u30af\u30c8\u30ec\u30fc\u30b9\u304c\u898b\u3048\u307e\u3059\u3002\u305f\u3060\u3057\u3001mrb\u304c\u898b\u3048\u3066\u3044\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\ndefine mbt\n  set $p = mrb->c->ci\n  while ($p > mrb->c->cibase)\n    if (($p->proc->flags & 128) != 0 )\n      printf \"0x%x   C \", $p\n      output $p->proc->body.func\n      printf \"\\n\"\n    else\n      set $irep = $p->proc->body.irep\n      set $mid = $p->mid\n      set $method_name = mrb_sym2name(mrb, $mid)\n      set $filename = $irep->filename\n      set $lines = $irep->lines\n      if ($filename && $lines)\n    if ($p == mrb->c->ci)\n      set $lineno = $lines[pc - $irep->iseq]\n    else\n      set $lineno = $lines[($p + 1)->pc - $irep->iseq]\n    end\n        printf \"0x%x MRUBY %s : %s:%d\\n\", $p, $method_name, $filename, $lineno\n      else\n        printf \"0x%x MRUBY %s : \\n\", $p, $method_name\n      end\n    end\n    set $p = $p - 1\n  end\nend\n\n\u30d0\u30c3\u30af\u30c8\u30ec\u30fc\u30b9\u51fa\u529b\u4f8b\u306f\u3053\u3093\u306a\u611f\u3058\u3067\u3059\n(gdb) mbt\n0x20046380   C (mrb_func_t) 0x46ac00 <mrb_printstr>\n0x20046340 MRUBY p :\n0x20046300 MRUBY derivative : benchmark/nuralnet.rb:47\n0x200462c0 MRUBY output_train : benchmark/nuralnet.rb:50\n0x20046280 MRUBY call : benchmark/nuralnet.rb:97\n0x20046240 MRUBY each :\n0x20046200 MRUBY train : benchmark/nuralnet.rb:99\n0x200461c0 MRUBY call : benchmark/nuralnet.rb:124\n0x20046180 MRUBY times :\n0x20046140 MRUBY call : benchmark/nuralnet.rb:128\n0x20046100 MRUBY times :\n\n\u3061\u306a\u307f\u306b\u3001\u5de6\u5074\u306e\u6570\u5b57\u306f\u305d\u306e\u968e\u5c64\u306ecall info\u3067\u3059\u3002\u3044\u308d\u3093\u306a\u60c5\u5831\u304c\u5165\u3063\u3066\u3044\u308b\u306e\u3067\u3001\u3053\u306e\u5148\u306e\u30c7\u30d0\u30c3\u30b0\u306b\u5f79\u7acb\u3064\u3053\u3068\u3067\u3057\u3087\u3046\u3002\n\u305f\u3068\u3048\u3070\u3001\n0x20046200 MRUBY train : benchmark/nuralnet.rb:99\n\u306e\u884c\u306e\u9006\u30a2\u30bb\u30f3\u30d6\u30e9\u3092\u51fa\u529b\u3057\u3066\u307f\u307e\u3057\u3087\u3046\n(gdb) p disasm_irep(mrb, ((struct mrb_callinfo *)0x20046200)->proc->body.irep)\n   0 OP_ENTER   2:0:0:0:0:0:0\n   1 OP_LOADSELF        R4\n   2 OP_MOVE    R5      R1      ; R1:inputs\n   3 OP_SEND    R4      :feed_forward   1\n   4 OP_GETIV   R4      @output_layer\n   5 OP_MOVE    R5      R2      ; R2:targets\n   6 OP_SEND    R4      :zip    1\n   7 OP_LAMBDA  R5      I(+1)   2\n   8 OP_SENDB   R4      :each   0\n   9 OP_GETIV   R4      @hidden_layer\n   a OP_LAMBDA  R5      I(+2)   2\n   b OP_SENDB   R4      :each   0\n   c OP_RETURN  R4      normal\n\n\u307e\u305f\u3001\u3053\u306e\u968e\u5c64\u3067\u306eR2\u30ec\u30b8\u30b9\u30bf\u306e\u5185\u5bb9\u306f\u3053\u3093\u306a\u611f\u3058\u3067\u8868\u793a\u3067\u304d\u307e\u3059\u3002\n(gdb) p mrb_p(mrb, ((struct mrb_callinfo *)0x20046200)->stackent[2])\n[0, 0]\n$20 = void\n\n\nirep\u3068\u304bregs\u3068\u304b\u306a\u3044\u5834\u5408\u3001\u307e\u305f\u306f\u58ca\u308c\u3066\u3044\u308b\u5834\u5408\nSegmentation Failt\u3068\u304b\u304c\u51fa\u308b\u3068\u3044\u3046\u3053\u3068\u306f\u3001irep\u3068\u304bregs\u304c\u58ca\u308c\u3066\u3044\u308b\u5834\u5408\u3063\u3066\u306e\u3082\u7d50\u69cb\u3042\u308a\u307e\u3059\u3002\u3053\u3046\u3044\u3046\u5834\u5408\u306f\u3042\u304d\u3089\u3081\u308b\u3057\u304b\u306a\u3044\uff1f\u3068\u3044\u3046\u3068\u307e\u3060\u7c98\u308c\u307e\u3059\u3002\nmrb->c->ci\u306b\u306f\u3001\u73fe\u5728\u5b9f\u884c\u4e2d\u306e\u30b3\u30f3\u30c6\u30af\u30b9\u30c8\u304c\u53ce\u3081\u3089\u308c\u3066\u3044\u3066\u3001\u3053\u306e\u4e2d\u306birep\u3068\u304bregs\u3068\u304b\u3042\u308b\u304b\u3089\u3067\u3059\u3002\u307e\u305f\u3001mrb->c->ci[-1]\u3068\u3059\u308b\u3068\u3001caller\u306e\u30b3\u30f3\u30c6\u30af\u30b9\u30c8\u304c\u5f97\u3089\u308c\u307e\u3059\u3002\u3053\u308c\u3092\u5229\u7528\u3059\u308b\u3068\u3001caller\u306e\u9006\u30a2\u30bb\u30f3\u30d6\u30eb\u3092\u3057\u305f\u308a\u3067\u304d\u307e\u3059\u3002\u5148\u307b\u3069\u306e\u3001gdb\u306embt\u30de\u30af\u30ed\u306f\u3053\u306e\u8fba\u306e\u30ce\u30a6\u30cf\u30a6\u304c\u8a70\u307e\u3063\u3066\u3044\u307e\u3059\u306e\u3067\u3001\u8aad\u3093\u3067\u307f\u308b\u3068\u3088\u3044\u304b\u3068\u601d\u3044\u307e\u3059\u3002\nregs\u306fmrb->c->stack\u3092\u6307\u3057\u3066\u3044\u308b\u306e\u3067\u3001mrb->c->stack\u3067regs\u306e\u4ee3\u308f\u308a\u306b\u30a2\u30af\u30bb\u30b9\u3067\u304d\u307e\u3059\u3002\n(gdb) p mrb_p(mrb, mrb->c->stack[0])\nStopIteration\n$11 = void\n(gdb) p disasm_irep (mrb, mrb->c->ci->proc->body.irep)\n   0 OP_ENTER   0:0:1:0:0:0:0\n   1 OP_LOADSELF        R3\n   2 OP_ARRAY   R4      R4      0\n   3 OP_MOVE    R5      R1      ; R1:names\n   4 OP_ARYCAT  R4      R5\n   5 OP_SEND    R3      :attr_reader    127\n   6 OP_LOADSELF        R3\n   7 OP_ARRAY   R4      R4      0\n   8 OP_MOVE    R5      R1      ; R1:names\n   9 OP_ARYCAT  R4      R5\n   a OP_SEND    R3      :attr_writer    127\n   b OP_RETURN  R3      normal\n$12 = void\n(gdb)\n\nmrb->c->ci[-\u623b\u308b\u6df1\u3055].proc->body.irep\u306f\u3088\u304f\u4f7f\u3044\u307e\u3059\u306e\u3067\u3001\u899a\u3048\u3066\u304a\u304f\u3068\u3044\u3044\u3067\u3057\u3087\u3046\u3002\n\n(gdb) p disasm_irep (mrb, mrb->c->ci[-1].proc->body.irep)\n   0 OP_LOADSELF        R1\n   1 OP_LOADSYM R2      :result\n   2 OP_SEND    R1      :attr_accessor  1\n   3 OP_RETURN  R0      normal\n$14 = void\n(gdb)\n\n\n\u305d\u308c\u3067\u3082\u99c4\u76ee\u306a\u6642\u306ewatch point\n\u3053\u3093\u306a\u611f\u3058\u3067\u4f55\u304c\u60aa\u3044\u306e\u304b\u304c\u5206\u304b\u3063\u305f\u3068\u3057\u307e\u3059\u3002segmentation fault\u306f\u5909\u6570\u3068\u304b\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u306b\u60f3\u5b9a\u3057\u3066\u3044\u306a\u3044\u5024\u304c\u5165\u3063\u3066\u3044\u308b\u3082\u306e\u3067\u3059\u3002\u5909\u6570\u3084\u30c7\u30fc\u30bf\u69cb\u9020\u306e\u5024\u304c\u58ca\u308c\u3066\u3044\u308b\u3001GC\u304b\u30b3\u30f3\u30d1\u30a4\u30e9\u306e\u30d0\u30b0\u304b\uff1f\u3063\u3066\u601d\u3046\u5fc3\u3092\u3050\u3063\u3068\u6291\u3048\u3066\u3001\u843d\u3061\u3064\u304d\u307e\u3057\u3087\u3046\u3002\n\u58ca\u308c\u3066\u3044\u308b\u306e\u304c\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3067\u3042\u308b\u5834\u5408\u3001\u5e78\u3044\u3067\u3059\u3002\u5f7c\u3089\u306b\u306fwatch\u30b3\u30de\u30f3\u30c9\u304c\u4e0e\u3048\u3089\u308c\u308b\u304b\u3089\u3067\u3059\u3002watch\u30b3\u30de\u30f3\u30c9\u306f\u5909\u6570\u3060\u3051\u3067\u306f\u306a\u304f\u3001\u30a2\u30c9\u30ec\u30b9\u3092\u6307\u5b9a\u3059\u308b\u3053\u3068\u3082\u3067\u304d\u307e\u3059\u3002\nx86\u3067\u306f\u30cf\u30fc\u30c9\u30a6\u30a8\u30a2\u652f\u63f4\u304c\u3042\u308b\u306e\u3067\u639b\u3051\u3066\u3044\u3066\u3082\u305d\u308c\u307b\u3069\u901f\u5ea6\u3082\u843d\u3061\u307e\u305b\u3093\u3002\n\n\u6700\u5f8c\u306f\u3084\u3063\u3071\u308aprintf\nwatch\u306f\u3068\u3066\u3082\u5f37\u529b\u3067\u3059\u304c\u3001\u9577\u3044\u9577\u3044\u5b9f\u884c\u306e\u672b\u306b\u306f\u3058\u3081\u3066\u8d77\u304d\u308b\u3068\u3044\u3046\u7a2e\u985e\u306e\u30d0\u30b0\u306b\u306f\u5411\u304d\u307e\u305b\u3093\u3002\u3053\u3046\u3044\u3046\u306e\u306b\u306f\u3084\u306f\u308aprintf\u3067\u3057\u3087\u3046\u3002\nmruby\u3092\u4f7f\u3063\u3066\u3044\u3066segmentation fault\u3068\u304b\u51fa\u3066\u56f0\u3063\u305f\u3053\u3068\u306f\u7121\u3044\u3067\u3057\u3087\u3046\u304b\u3002\u3053\u3046\u3044\u3046\u5834\u5408\u306bgdb\u3067\u30c7\u30d0\u30c3\u30b0\u3059\u308b\u30ce\u30a6\u30cf\u30a6\u3092\u66f8\u304d\u307e\u3059\u3002gdb\u306e\u4f7f\u3044\u65b9\u306b\u3064\u3044\u3066\u306f\u3053\u3053\u3067\u306f\u8aac\u660e\u3057\u307e\u305b\u3093\u3002\n\n# \u9006\u30a2\u30bb\u30f3\u30d6\u30e9\ngdb\u3067\u30c7\u30d0\u30c3\u30b0\u3059\u308b\u306a\u3089mruby\u306e\u30d0\u30a4\u30c8\u30b3\u30fc\u30c9\u306e\u9006\u30a2\u30bb\u30f3\u30d6\u30e9\u304c\u5fc5\u8981\u3067\u3059\u3002\u6a19\u6e96\u3067\u306fcodedump\u95a2\u6570\u304c\u7528\u610f\u3055\u308c\u3066\u3044\u307e\u3059\u304c\u3001\u306a\u305c\u304b\u3053\u3053\u3067\u8aac\u660e\u3059\u308b\u3088\u3046\u306a\u4f7f\u3044\u65b9\u306f\u3067\u304d\u306a\u3044\u3088\u3046\u3067\u3059\u3002mruby\u306eJIT\u3067\u4f7f\u3063\u3066\u3044\u308b\u3082\u306e\u304c[\u3053\u3053\u306b\u3042\u308a\u307e\u3059\u306e\u3067](https://github.com/miura1729/mruby/blob/master/src/codedump.c#L456-L835)\u3001\u30b3\u30d4\u30fc\u3057\u3066codedump.c\u3042\u305f\u308a\u306b\u3067\u3082\u5165\u308c\u3066\u304a\u3044\u3066\u304f\u304f\u3060\u3055\u3044\u3002\n\n\u3053\u308c\u3092\u4f7f\u3046\u3068\u3001\u5909\u6570mrb\u3068irep\u304c\u898b\u3048\u3066\u3044\u308c\u3070\u3001\u3053\u3093\u306a\u611f\u3058\u3067disasm_irep\u95a2\u6570\u3092\u547c\u3073\u51fa\u3059\u3053\u3068\u3067\u9006\u30a2\u30bb\u30f3\u30d6\u30eb\u3067\u304d\u307e\u3059\u3002\u898b\u3048\u3066\u3044\u306a\u3044\u5834\u5408\u3001gdb\u306eup\u30b3\u30de\u30f3\u30c9\u3067\u547c\u3073\u51fa\u3057\u5143\u3092\u8fbf\u3063\u3066\u3044\u3066\u898b\u3048\u308b\u3068\u3053\u308d\u304c\u3042\u308c\u3070\u305d\u3053\u3067\u5b9f\u884c\u53ef\u80fd\u3067\u3059\u3002disasm_irep\u306f\u5024\u3092\u8fd4\u3055\u306a\u3044\u306e\u3067call\u3092\u4f7f\u3046\u65b9\u304c\u3088\u3055\u305d\u3046\u3067\u3059\u304c\u3001p\u306e\u65b9\u304c\u77ed\u3044\u306e\u3067p\u3092\u826f\u304f\u4f7f\u3063\u3066\u3044\u307e\u3059\u304c\u597d\u307f\u306e\u554f\u984c\u3067\u3059\u3002\n\n```\n(gdb) p disasm_irep (mrb, irep)\n   0 OP_ENTER   0:0:1:0:0:0:0\n   1 OP_LOADSELF        R3\n   2 OP_ARRAY   R4      R4      0\n   3 OP_MOVE    R5      R1      ; R1:names\n   4 OP_ARYCAT  R4      R5\n   5 OP_SEND    R3      :attr_reader    127\n   6 OP_LOADSELF        R3\n   7 OP_ARRAY   R4      R4      0\n   8 OP_MOVE    R5      R1      ; R1:names\n   9 OP_ARYCAT  R4      R5\n   a OP_SEND    R3      :attr_writer    127\n   b OP_RETURN  R3      normal\n$6 = void\n(gdb)\n```\n\n\u307e\u305f\u3001\u73fe\u5728\u3069\u306e\u30e1\u30bd\u30c3\u30c9\u3084\u30d6\u30ed\u30c3\u30af\u3068\u3044\u3046\u30ec\u30d9\u30eb\u3067\u306f\u306a\u304f\u3069\u306e\u547d\u4ee4\u3092\u5b9f\u884c\u4e2d\u304b\u77e5\u308a\u305f\u3044\u5834\u5408\u3082\u3042\u308a\u307e\u3059\u3002\u305d\u3046\u3044\u3046\u5834\u5408\u306b\u306f\u3001disasm_once\u3092\u4f7f\u3044\u307e\u3059\u3002\u3053\u306e\u3070\u3042\u3044\u3001\u5909\u6570pc\u304c\u898b\u3048\u3066\u3044\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\n```\n(gdb) p disasm_once (mrb, irep, *pc)\nOP_ENTER        0:0:1:0:0:0:0\n$7 = void\n(gdb)\n```\npc\u306f\u30c7\u30ea\u30d5\u30a1\u30ec\u30f3\u30b9\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\n# VM\u306e\u30ec\u30b8\u30b9\u30bf\n\nmruby\u306eVM\u3067\u306f\u30e1\u30bd\u30c3\u30c9\u306e\u5f15\u6570\u3068\u304b\u30ed\u30fc\u30ab\u30eb\u5909\u6570\u3068\u304b\u306bRITE VM\u306e\u30ec\u30b8\u30b9\u30bf\u3092\u4f7f\u3044\u307e\u3059\u3002\u30c7\u30d0\u30c3\u30b0\u3067\u3001VM\u306e\u30ec\u30b8\u30b9\u30bf\u304c\u307f\u305f\u3044\u3053\u3068\u304c\u826f\u304f\u3042\u308a\u307e\u3059\u3002\u3053\u306e\u3088\u3046\u306a\u5834\u5408\u306f\u3001\u6700\u5bc4\u308a\u306e mrb_context_run\u307e\u3067up\u30b3\u30de\u30f3\u30c9\u3067\u4e0a\u3063\u3066\u884c\u3063\u3066\u3001p regs[\u30ec\u30b8\u30b9\u30bf\u756a\u53f7]\u3068\u3057\u307e\u3059\u3002\u30ec\u30b8\u30b9\u30bf\u756a\u53f7\u304c0\u306f\u5e38\u306bself\u3067\u3042\u308b\u3053\u3068\u306f\u899a\u3048\u3066\u304a\u3044\u3066\u640d\u306f\u306a\u3044\u3067\u3057\u3087\u3046\u3002\n\n```\n(gdb) down\n#0  mrb_irep_incref (mrb=mrb@entry=0x200398d0, irep=irep@entry=0x400d1250)\n    at C:\\cygwin\\home\\PCUser\\work\\mruby\\src\\state.c:129\n129       irep->refcnt++;\n(gdb) up\n#1  0x0041f090 in mrb_proc_new (mrb=mrb@entry=0x200398d0,\n    irep=irep@entry=0x400d1250)\n    at C:\\cygwin\\home\\PCUser\\work\\mruby\\src\\proc.c:32\n32        mrb_irep_incref(mrb, irep);\n(gdb) up\n#2  0x00433dc1 in mrb_context_run (mrb=mrb@entry=0x200398d0, proc=0x2003c380,\n    proc@entry=0x2003c578, self=..., stack_keep=stack_keep@entry=0)\n    at C:\\cygwin\\home\\PCUser\\work\\mruby\\src\\vm.c:2321\n2321                    p = mrb_proc_new(mrb, nirep);\n(gdb) p regs[0]\n$8 = {{f = -nan(0xa2003bc60), value = {{{p = 537115744, i = 537115744,\n          sym = 537115744}, ttt = 4293918730}}}}\n```\n\nmruby\u306e\u751f\u306emrb_value\u578b\u3067\u306f\u304a\u8179\u3092\u58ca\u3059\u4eba\u306f\u3001mrb_p\u95a2\u6570\u304c\u4fbf\u5229\u3067\u3059\u3002mrb\u3092\u6e21\u3059\u3053\u3068\u306b\u6ce8\u610f\u3057\u307e\u3057\u3087\u3046\u3002\n\n```\n(gdb) p mrb_p(mrb, regs[0])\nStopIteration\n$9 = void\n```\n\n# \u30d0\u30c3\u30af\u30c8\u30ec\u30fc\u30b9\nmruby\u304c\u3069\u3046\u3044\u3063\u305f\u547c\u3073\u51fa\u3057\u5c65\u6b74\u3067\u843d\u3061\u3066\u3057\u307e\u3063\u305f\u306e\u304b\u3001\u77e5\u308a\u305f\u3044\u5834\u5408\u3082\u3088\u304f\u3042\u308a\u307e\u3059\u3002\u305d\u3093\u306a\u3068\u304d\u306f\u3001\u3053\u308c\u3092.gdb\u306b\u5165\u308c\u3066\u304a\u3051\u3070\u3001mbt\u3068\u6253\u3064\u3068\u30d0\u30c3\u30af\u30c8\u30ec\u30fc\u30b9\u304c\u898b\u3048\u307e\u3059\u3002\u305f\u3060\u3057\u3001mrb\u304c\u898b\u3048\u3066\u3044\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\n```\ndefine mbt\n  set $p = mrb->c->ci\n  while ($p > mrb->c->cibase)\n    if (($p->proc->flags & 128) != 0 )\n      printf \"0x%x   C \", $p\n      output $p->proc->body.func\n      printf \"\\n\"\n    else\n      set $irep = $p->proc->body.irep\n      set $mid = $p->mid\n      set $method_name = mrb_sym2name(mrb, $mid)\n      set $filename = $irep->filename\n      set $lines = $irep->lines\n      if ($filename && $lines)\n\tif ($p == mrb->c->ci)\n\t  set $lineno = $lines[pc - $irep->iseq]\n\telse\n\t  set $lineno = $lines[($p + 1)->pc - $irep->iseq]\n\tend\n        printf \"0x%x MRUBY %s : %s:%d\\n\", $p, $method_name, $filename, $lineno\n      else\n        printf \"0x%x MRUBY %s : \\n\", $p, $method_name\n      end\n    end\n    set $p = $p - 1\n  end\nend\n```\n\n\u30d0\u30c3\u30af\u30c8\u30ec\u30fc\u30b9\u51fa\u529b\u4f8b\u306f\u3053\u3093\u306a\u611f\u3058\u3067\u3059\n\n```\n(gdb) mbt\n0x20046380   C (mrb_func_t) 0x46ac00 <mrb_printstr>\n0x20046340 MRUBY p :\n0x20046300 MRUBY derivative : benchmark/nuralnet.rb:47\n0x200462c0 MRUBY output_train : benchmark/nuralnet.rb:50\n0x20046280 MRUBY call : benchmark/nuralnet.rb:97\n0x20046240 MRUBY each :\n0x20046200 MRUBY train : benchmark/nuralnet.rb:99\n0x200461c0 MRUBY call : benchmark/nuralnet.rb:124\n0x20046180 MRUBY times :\n0x20046140 MRUBY call : benchmark/nuralnet.rb:128\n0x20046100 MRUBY times :\n```\n\u3061\u306a\u307f\u306b\u3001\u5de6\u5074\u306e\u6570\u5b57\u306f\u305d\u306e\u968e\u5c64\u306ecall info\u3067\u3059\u3002\u3044\u308d\u3093\u306a\u60c5\u5831\u304c\u5165\u3063\u3066\u3044\u308b\u306e\u3067\u3001\u3053\u306e\u5148\u306e\u30c7\u30d0\u30c3\u30b0\u306b\u5f79\u7acb\u3064\u3053\u3068\u3067\u3057\u3087\u3046\u3002\n\u305f\u3068\u3048\u3070\u3001\n0x20046200 MRUBY train : benchmark/nuralnet.rb:99\n\u306e\u884c\u306e\u9006\u30a2\u30bb\u30f3\u30d6\u30e9\u3092\u51fa\u529b\u3057\u3066\u307f\u307e\u3057\u3087\u3046\n\n```\n(gdb) p disasm_irep(mrb, ((struct mrb_callinfo *)0x20046200)->proc->body.irep)\n   0 OP_ENTER   2:0:0:0:0:0:0\n   1 OP_LOADSELF        R4\n   2 OP_MOVE    R5      R1      ; R1:inputs\n   3 OP_SEND    R4      :feed_forward   1\n   4 OP_GETIV   R4      @output_layer\n   5 OP_MOVE    R5      R2      ; R2:targets\n   6 OP_SEND    R4      :zip    1\n   7 OP_LAMBDA  R5      I(+1)   2\n   8 OP_SENDB   R4      :each   0\n   9 OP_GETIV   R4      @hidden_layer\n   a OP_LAMBDA  R5      I(+2)   2\n   b OP_SENDB   R4      :each   0\n   c OP_RETURN  R4      normal\n```\n\u307e\u305f\u3001\u3053\u306e\u968e\u5c64\u3067\u306eR2\u30ec\u30b8\u30b9\u30bf\u306e\u5185\u5bb9\u306f\u3053\u3093\u306a\u611f\u3058\u3067\u8868\u793a\u3067\u304d\u307e\u3059\u3002\n\n```\n(gdb) p mrb_p(mrb, ((struct mrb_callinfo *)0x20046200)->stackent[2])\n[0, 0]\n$20 = void\n```\n\n# irep\u3068\u304bregs\u3068\u304b\u306a\u3044\u5834\u5408\u3001\u307e\u305f\u306f\u58ca\u308c\u3066\u3044\u308b\u5834\u5408\nSegmentation Failt\u3068\u304b\u304c\u51fa\u308b\u3068\u3044\u3046\u3053\u3068\u306f\u3001irep\u3068\u304bregs\u304c\u58ca\u308c\u3066\u3044\u308b\u5834\u5408\u3063\u3066\u306e\u3082\u7d50\u69cb\u3042\u308a\u307e\u3059\u3002\u3053\u3046\u3044\u3046\u5834\u5408\u306f\u3042\u304d\u3089\u3081\u308b\u3057\u304b\u306a\u3044\uff1f\u3068\u3044\u3046\u3068\u307e\u3060\u7c98\u308c\u307e\u3059\u3002\nmrb->c->ci\u306b\u306f\u3001\u73fe\u5728\u5b9f\u884c\u4e2d\u306e\u30b3\u30f3\u30c6\u30af\u30b9\u30c8\u304c\u53ce\u3081\u3089\u308c\u3066\u3044\u3066\u3001\u3053\u306e\u4e2d\u306birep\u3068\u304bregs\u3068\u304b\u3042\u308b\u304b\u3089\u3067\u3059\u3002\u307e\u305f\u3001mrb->c->ci[-1]\u3068\u3059\u308b\u3068\u3001caller\u306e\u30b3\u30f3\u30c6\u30af\u30b9\u30c8\u304c\u5f97\u3089\u308c\u307e\u3059\u3002\u3053\u308c\u3092\u5229\u7528\u3059\u308b\u3068\u3001caller\u306e\u9006\u30a2\u30bb\u30f3\u30d6\u30eb\u3092\u3057\u305f\u308a\u3067\u304d\u307e\u3059\u3002\u5148\u307b\u3069\u306e\u3001gdb\u306embt\u30de\u30af\u30ed\u306f\u3053\u306e\u8fba\u306e\u30ce\u30a6\u30cf\u30a6\u304c\u8a70\u307e\u3063\u3066\u3044\u307e\u3059\u306e\u3067\u3001\u8aad\u3093\u3067\u307f\u308b\u3068\u3088\u3044\u304b\u3068\u601d\u3044\u307e\u3059\u3002\n\nregs\u306fmrb->c->stack\u3092\u6307\u3057\u3066\u3044\u308b\u306e\u3067\u3001mrb->c->stack\u3067regs\u306e\u4ee3\u308f\u308a\u306b\u30a2\u30af\u30bb\u30b9\u3067\u304d\u307e\u3059\u3002\n\n```\n(gdb) p mrb_p(mrb, mrb->c->stack[0])\nStopIteration\n$11 = void\n(gdb) p disasm_irep (mrb, mrb->c->ci->proc->body.irep)\n   0 OP_ENTER   0:0:1:0:0:0:0\n   1 OP_LOADSELF        R3\n   2 OP_ARRAY   R4      R4      0\n   3 OP_MOVE    R5      R1      ; R1:names\n   4 OP_ARYCAT  R4      R5\n   5 OP_SEND    R3      :attr_reader    127\n   6 OP_LOADSELF        R3\n   7 OP_ARRAY   R4      R4      0\n   8 OP_MOVE    R5      R1      ; R1:names\n   9 OP_ARYCAT  R4      R5\n   a OP_SEND    R3      :attr_writer    127\n   b OP_RETURN  R3      normal\n$12 = void\n(gdb)\n```\nmrb->c->ci[-\u623b\u308b\u6df1\u3055].proc->body.irep\u306f\u3088\u304f\u4f7f\u3044\u307e\u3059\u306e\u3067\u3001\u899a\u3048\u3066\u304a\u304f\u3068\u3044\u3044\u3067\u3057\u3087\u3046\u3002\n```\n(gdb) p disasm_irep (mrb, mrb->c->ci[-1].proc->body.irep)\n   0 OP_LOADSELF        R1\n   1 OP_LOADSYM R2      :result\n   2 OP_SEND    R1      :attr_accessor  1\n   3 OP_RETURN  R0      normal\n$14 = void\n(gdb)\n```\n# \u305d\u308c\u3067\u3082\u99c4\u76ee\u306a\u6642\u306ewatch point\n\u3053\u3093\u306a\u611f\u3058\u3067\u4f55\u304c\u60aa\u3044\u306e\u304b\u304c\u5206\u304b\u3063\u305f\u3068\u3057\u307e\u3059\u3002segmentation fault\u306f\u5909\u6570\u3068\u304b\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u306b\u60f3\u5b9a\u3057\u3066\u3044\u306a\u3044\u5024\u304c\u5165\u3063\u3066\u3044\u308b\u3082\u306e\u3067\u3059\u3002\u5909\u6570\u3084\u30c7\u30fc\u30bf\u69cb\u9020\u306e\u5024\u304c\u58ca\u308c\u3066\u3044\u308b\u3001GC\u304b\u30b3\u30f3\u30d1\u30a4\u30e9\u306e\u30d0\u30b0\u304b\uff1f\u3063\u3066\u601d\u3046\u5fc3\u3092\u3050\u3063\u3068\u6291\u3048\u3066\u3001\u843d\u3061\u3064\u304d\u307e\u3057\u3087\u3046\u3002\n\u58ca\u308c\u3066\u3044\u308b\u306e\u304c\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3067\u3042\u308b\u5834\u5408\u3001\u5e78\u3044\u3067\u3059\u3002\u5f7c\u3089\u306b\u306fwatch\u30b3\u30de\u30f3\u30c9\u304c\u4e0e\u3048\u3089\u308c\u308b\u304b\u3089\u3067\u3059\u3002watch\u30b3\u30de\u30f3\u30c9\u306f\u5909\u6570\u3060\u3051\u3067\u306f\u306a\u304f\u3001\u30a2\u30c9\u30ec\u30b9\u3092\u6307\u5b9a\u3059\u308b\u3053\u3068\u3082\u3067\u304d\u307e\u3059\u3002\nx86\u3067\u306f\u30cf\u30fc\u30c9\u30a6\u30a8\u30a2\u652f\u63f4\u304c\u3042\u308b\u306e\u3067\u639b\u3051\u3066\u3044\u3066\u3082\u305d\u308c\u307b\u3069\u901f\u5ea6\u3082\u843d\u3061\u307e\u305b\u3093\u3002\n\n# \u6700\u5f8c\u306f\u3084\u3063\u3071\u308aprintf\nwatch\u306f\u3068\u3066\u3082\u5f37\u529b\u3067\u3059\u304c\u3001\u9577\u3044\u9577\u3044\u5b9f\u884c\u306e\u672b\u306b\u306f\u3058\u3081\u3066\u8d77\u304d\u308b\u3068\u3044\u3046\u7a2e\u985e\u306e\u30d0\u30b0\u306b\u306f\u5411\u304d\u307e\u305b\u3093\u3002\u3053\u3046\u3044\u3046\u306e\u306b\u306f\u3084\u306f\u308aprintf\u3067\u3057\u3087\u3046\u3002\n", "tags": ["mruby", "gdb"]}