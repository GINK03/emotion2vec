{"context": " More than 1 year has passed since last update.\n\nActiveRecord / Arel\n\u4ee5\u4e0b\u306e\u7d9a\u7de8\u3068\u3057\u3066\u304a\u8aad\u307f\u304f\u3060\u3055\u3044\nRails\u306e\u8907\u96d1\u306a\u691c\u7d22\u306f\u30b9\u30b3\u30fc\u30d7\u3092\u4f7f\u304a\u3046\nRails\u3067SQL\u6587\u3092\u3069\u3093\u3069\u3093\u90e8\u54c1\u5316\u3057\u3066\u3044\u304d\u307e\u3059\n\u4eca\u56deDatabase\u304cRedshift(Postgresql\u306b\u4f3c\u3066\u3044\u308b)\u3067\u3059\n\nArel::Nodes::NamedFunction\nDB\u56fa\u6709\u306e\u95a2\u6570\u3092\u4f7f\u3046\u5834\u5408\u306a\u3069\u306f\u3053\u308c\n# \u3053\u3093\u306a\u611f\u3058\u306e\u30c6\u30fc\u30d6\u30eb\u304c\u3042\u308b\u3088\n# create table timeaxis (time_s timestamp)\ntime_table = Arel::Table.new('timeaxis')\ntime_table.project(\n  Arel::Nodes::NamedFunction.new(\n    'date_trunc',\n    [Arel::Nodes::build_quoted('day'),\n     time_table[:time_s]]\n  ).as('daily')\n).group(\n  Arel::Nodes::NamedFunction.new(\n    'date_trunc',\n    [Arel::Nodes::build_quoted('day'),\n     time_table[:time_s]]\n  )\n)\n\n# \u5f97\u3089\u308c\u308bSQL\n# SELECT\n#   date_trunc('day', \"time_table\".\"time_s\") AS daily\n# FROM\n#   \"time_table\"\n# GROUP BY\n#   date_trunc('day', \"time_table\".\"time_s\")\n\n\n\u30bf\u30a4\u30e0\u30b9\u30bf\u30f3\u30d7\u3092\u65e5\u6b21\u306b\u3059\u308b\u4f8b\u3001scope\u3068\u3057\u3066\u5ba3\u8a00\u3057\u3066\u304a\u3051\u3070\u3001day\u306e\u90e8\u5206\u3092\u5f15\u6570\u306b\u3057\u3066\uff11\u6642\u9593\u3054\u3068\u3001\u6708\u3054\u3068\u306a\u3069\u5909\u66f4\u306f\u5bb9\u6613\u3067\u3059\nNamedFunction\u306f\u7b2c\u4e00\u5f15\u6570\u3092\u95a2\u6570\u540d\u3068\u3057\u3066\u3001\u7b2c\u4e8c\u5f15\u6570\u306b\u914d\u5217(\u4e2d\u8eab\u306fArel\u30aa\u30d6\u30b8\u30a7\u30af\u30c8)\u3092\u3068\u308a\u30ab\u30f3\u30de\u533a\u5207\u308a\u3067\u3064\u306a\u3050\u3088\u3046\u3067\u3059\u3002\u7b2c\u4e8c\u5f15\u6570\u306e\u914d\u5217\u5185\u306b\u306f\uff12\u3064\u3092\u8d85\u3048\u308b\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3082\u6e21\u305b\u307e\u3059\nbuild_quoted\u306f\u6587\u5b57\u5217\u3092\u30b7\u30f3\u30b0\u30eb\u30af\u30aa\u30fc\u30c8\u3067\u56f2\u3080\u307f\u305f\u3044\nPostgresql\u306eCAST\u3092\u30b9\u30b3\u30fc\u30d7\u306b\u8a2d\u5b9a\u3059\u308b\u306a\u3089\nscope :cast, lambda { |str, type|\n  Arel::Nodes::NamedFunction.new(\n    'CAST', [\n      Arel::Nodes::As.new(\n        Arel::Nodes.build_quoted(str),\n        Arel::Nodes::SqlLiteral.new(type)\n      )\n    ]\n  )\n}\n\n# cast('20.2', 'float') => CAST('20.2' AS float)\n# cast('1 HOUR', 'interval') => CAST('1 HOUR' AS interval)\n\n\u6587\u5b57\u5217\u3068\u5909\u63db\u3059\u308b\u578b\u3092\u5f15\u6570\u3068\u3057\u3066\u6e21\u305b\u3070\u578b\u5909\u63db\u3057\u3066\u304f\u308c\u307e\u3059\nAs\u306f\u4e8c\u3064\u306e\u5f15\u6570\u3092AS\u3067\u3064\u306a\u3044\u3067\u304f\u308c\u308b\u307f\u305f\u3044\nSqlLiteral\u306f\u6e21\u3057\u305f\u6587\u5b57\u5217\u3092Arel\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u306b\u3057\u3066\u304f\u308c\u308b\n\nArel::Nodes::InfixOperation\n\u3042\u307e\u308a\u4f7f\u3044\u9053\u306f\u898b\u3044\u3060\u305b\u307e\u305b\u3093\u304c\u3001\u3053\u3093\u306a\u3053\u3068\u3082\u53ef\u80fd\u3067\u3059\nArel::Nodes::NamedFunction.new(\n  'SELECT',\n  [Arel::Nodes::InfixOperation.new(\n    '+',\n    Arel::Nodes::NamedFunction.new(\n      'CAST', [\n        Arel::Nodes::As.new(\n          Arel::Nodes.build_quoted('2015-08-01'),\n          Arel::Nodes::SqlLiteral.new('TIMESTAMP')\n        )\n      ]\n    ),\n    Arel::Nodes::InfixOperation.new(\n      '*',\n      Arel::Nodes::NamedFunction.new(\n        'GENERATE_SERIES', [0, 23]\n      ),\n      Arel::Nodes::NamedFunction.new(\n        'CAST', [\n          Arel::Nodes::As.new(\n            Arel::Nodes.build_quoted('1 HOUR'),\n            Arel::Nodes::SqlLiteral.new('INTERVAL')\n          )\n        ]\n      )\n    )\n  )]\n).as('hourly')\n\n# \u5f97\u3089\u308c\u308bSQL\n# SELECT\n#    (CAST('2015-08-01' AS TIMESTAMP) + GENERATE_SERIES(0, 23)\n#    *\n#    CAST('1 HOUR' AS INTERVAL))\n# AS hourly\n\n\u7d50\u5c40\uff11\u6642\u9593\u3054\u3068\u3092\u5f97\u308b\u306e\u304b\u3088...\nInfixOperation\u306f\u7b2c\u4e00\u5f15\u6570\u306b\u30aa\u30da\u30ec\u30fc\u30bf\u3092\u3068\u308a\u3001\u7b2c\u4e8c\u5f15\u6570\u3068\u7b2c\u4e09\u5f15\u6570\u3092\u3064\u306a\u3050\u307f\u305f\u3044\n\u610f\u5473\u306f\u7121\u3044\u304c\u3001\u4e0b\u8a18\u306e\u3088\u3046\u306b\u3082\u4f7f\u3048\u308b\nArel::Nodes::NamedFunction.new(\n  'CAST', [\n    Arel::Nodes::InfixOperation.new(\n      'AS',\n      Arel::Nodes.build_quoted('2015-08-01'),\n      Arel::Nodes::SqlLiteral.new('TIMESTAMP')\n    )\n  ]\n)\n\n# CAST('2015-08-01' AS TIMESTAMP)\n\n\u5148\u8ff0\u306e\u901a\u308aAs\u3092\u4f7f\u3046\u306e\u304c\u826f\u3044\u3068\u601d\u3046\n\u306a\u306b\u3088\u308a\u3001Arel\u3067\u306f\u7b2c\u4e00\u5f15\u6570\u3092\u30aa\u30da\u30ec\u30fc\u30bf\u3068\u3057\u3066\u6271\u3046\u306e\u3067\u4e0d\u5177\u5408\u306e\u539f\u56e0\u3068\u306a\u308a\u305d\u3046\u306a\u306e\u3067\u975e\u63a8\u5968\n\n\u307e\u3068\u3081\nArel::Nodes\u3092\u5229\u7528\u3059\u308c\u3070Arel\u3067\u7528\u610f\u3055\u308c\u3066\u3044\u306a\u3044\u95a2\u6570\u306a\u3069\u3082\u4f7f\u3046\u3053\u3068\u304c\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3059\n\u307e\u305f\u672c\u6295\u7a3f\u3067\u306f\u5168\u3066\u306e\u30e2\u30b8\u30e5\u30fc\u30eb\u3092\u6271\u3063\u3066\u304a\u308a\u307e\u305b\u3093\u306e\u3067\u3001\u4e0b\u8a18\u3092\u53c2\u8003\u304f\u3060\u3055\u3044\nModule: Arel::Nodes\n## ActiveRecord / Arel\n\u4ee5\u4e0b\u306e\u7d9a\u7de8\u3068\u3057\u3066\u304a\u8aad\u307f\u304f\u3060\u3055\u3044\n[Rails\u306e\u8907\u96d1\u306a\u691c\u7d22\u306f\u30b9\u30b3\u30fc\u30d7\u3092\u4f7f\u304a\u3046](http://qiita.com/himinato/items/724a4a162dfa9e27754a)\nRails\u3067SQL\u6587\u3092\u3069\u3093\u3069\u3093\u90e8\u54c1\u5316\u3057\u3066\u3044\u304d\u307e\u3059\n\n\u4eca\u56deDatabase\u304cRedshift(Postgresql\u306b\u4f3c\u3066\u3044\u308b)\u3067\u3059\n\n## Arel::Nodes::NamedFunction\nDB\u56fa\u6709\u306e\u95a2\u6570\u3092\u4f7f\u3046\u5834\u5408\u306a\u3069\u306f\u3053\u308c\n\n```rb\n# \u3053\u3093\u306a\u611f\u3058\u306e\u30c6\u30fc\u30d6\u30eb\u304c\u3042\u308b\u3088\n# create table timeaxis (time_s timestamp)\ntime_table = Arel::Table.new('timeaxis')\ntime_table.project(\n  Arel::Nodes::NamedFunction.new(\n    'date_trunc',\n    [Arel::Nodes::build_quoted('day'),\n     time_table[:time_s]]\n  ).as('daily')\n).group(\n  Arel::Nodes::NamedFunction.new(\n    'date_trunc',\n    [Arel::Nodes::build_quoted('day'),\n     time_table[:time_s]]\n  )\n)\n\n# \u5f97\u3089\u308c\u308bSQL\n# SELECT\n#   date_trunc('day', \"time_table\".\"time_s\") AS daily\n# FROM\n#   \"time_table\"\n# GROUP BY\n#   date_trunc('day', \"time_table\".\"time_s\")\n\n```\n\n\u30bf\u30a4\u30e0\u30b9\u30bf\u30f3\u30d7\u3092\u65e5\u6b21\u306b\u3059\u308b\u4f8b\u3001**scope**\u3068\u3057\u3066\u5ba3\u8a00\u3057\u3066\u304a\u3051\u3070\u3001`day`\u306e\u90e8\u5206\u3092\u5f15\u6570\u306b\u3057\u3066\uff11\u6642\u9593\u3054\u3068\u3001\u6708\u3054\u3068\u306a\u3069\u5909\u66f4\u306f\u5bb9\u6613\u3067\u3059\n\n`NamedFunction`\u306f\u7b2c\u4e00\u5f15\u6570\u3092\u95a2\u6570\u540d\u3068\u3057\u3066\u3001\u7b2c\u4e8c\u5f15\u6570\u306b\u914d\u5217(\u4e2d\u8eab\u306fArel\u30aa\u30d6\u30b8\u30a7\u30af\u30c8)\u3092\u3068\u308a\u30ab\u30f3\u30de\u533a\u5207\u308a\u3067\u3064\u306a\u3050\u3088\u3046\u3067\u3059\u3002\u7b2c\u4e8c\u5f15\u6570\u306e\u914d\u5217\u5185\u306b\u306f\uff12\u3064\u3092\u8d85\u3048\u308b\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3082\u6e21\u305b\u307e\u3059\n\n`build_quoted`\u306f\u6587\u5b57\u5217\u3092\u30b7\u30f3\u30b0\u30eb\u30af\u30aa\u30fc\u30c8\u3067\u56f2\u3080\u307f\u305f\u3044\n\nPostgresql\u306eCAST\u3092\u30b9\u30b3\u30fc\u30d7\u306b\u8a2d\u5b9a\u3059\u308b\u306a\u3089\n\n```rb\nscope :cast, lambda { |str, type|\n  Arel::Nodes::NamedFunction.new(\n    'CAST', [\n      Arel::Nodes::As.new(\n        Arel::Nodes.build_quoted(str),\n        Arel::Nodes::SqlLiteral.new(type)\n      )\n    ]\n  )\n}\n\n# cast('20.2', 'float') => CAST('20.2' AS float)\n# cast('1 HOUR', 'interval') => CAST('1 HOUR' AS interval)\n```\n\n\u6587\u5b57\u5217\u3068\u5909\u63db\u3059\u308b\u578b\u3092\u5f15\u6570\u3068\u3057\u3066\u6e21\u305b\u3070\u578b\u5909\u63db\u3057\u3066\u304f\u308c\u307e\u3059\n\n`As`\u306f\u4e8c\u3064\u306e\u5f15\u6570\u3092`AS`\u3067\u3064\u306a\u3044\u3067\u304f\u308c\u308b\u307f\u305f\u3044\n`SqlLiteral`\u306f\u6e21\u3057\u305f\u6587\u5b57\u5217\u3092Arel\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u306b\u3057\u3066\u304f\u308c\u308b\n\n## Arel::Nodes::InfixOperation\n\u3042\u307e\u308a\u4f7f\u3044\u9053\u306f\u898b\u3044\u3060\u305b\u307e\u305b\u3093\u304c\u3001\u3053\u3093\u306a\u3053\u3068\u3082\u53ef\u80fd\u3067\u3059\n\n```rb\nArel::Nodes::NamedFunction.new(\n  'SELECT',\n  [Arel::Nodes::InfixOperation.new(\n    '+',\n    Arel::Nodes::NamedFunction.new(\n      'CAST', [\n        Arel::Nodes::As.new(\n          Arel::Nodes.build_quoted('2015-08-01'),\n          Arel::Nodes::SqlLiteral.new('TIMESTAMP')\n        )\n      ]\n    ),\n    Arel::Nodes::InfixOperation.new(\n      '*',\n      Arel::Nodes::NamedFunction.new(\n        'GENERATE_SERIES', [0, 23]\n      ),\n      Arel::Nodes::NamedFunction.new(\n        'CAST', [\n          Arel::Nodes::As.new(\n            Arel::Nodes.build_quoted('1 HOUR'),\n            Arel::Nodes::SqlLiteral.new('INTERVAL')\n          )\n        ]\n      )\n    )\n  )]\n).as('hourly')\n\n# \u5f97\u3089\u308c\u308bSQL\n# SELECT\n#    (CAST('2015-08-01' AS TIMESTAMP) + GENERATE_SERIES(0, 23)\n#    *\n#    CAST('1 HOUR' AS INTERVAL))\n# AS hourly\n```\n\n\u7d50\u5c40\uff11\u6642\u9593\u3054\u3068\u3092\u5f97\u308b\u306e\u304b\u3088...\n\n`InfixOperation`\u306f\u7b2c\u4e00\u5f15\u6570\u306b\u30aa\u30da\u30ec\u30fc\u30bf\u3092\u3068\u308a\u3001\u7b2c\u4e8c\u5f15\u6570\u3068\u7b2c\u4e09\u5f15\u6570\u3092\u3064\u306a\u3050\u307f\u305f\u3044\n\n\u610f\u5473\u306f\u7121\u3044\u304c\u3001\u4e0b\u8a18\u306e\u3088\u3046\u306b\u3082\u4f7f\u3048\u308b\n\n```rb\nArel::Nodes::NamedFunction.new(\n  'CAST', [\n    Arel::Nodes::InfixOperation.new(\n      'AS',\n      Arel::Nodes.build_quoted('2015-08-01'),\n      Arel::Nodes::SqlLiteral.new('TIMESTAMP')\n    )\n  ]\n)\n\n# CAST('2015-08-01' AS TIMESTAMP)\n```\n\n\u5148\u8ff0\u306e\u901a\u308a`As`\u3092\u4f7f\u3046\u306e\u304c\u826f\u3044\u3068\u601d\u3046\n\u306a\u306b\u3088\u308a\u3001Arel\u3067\u306f\u7b2c\u4e00\u5f15\u6570\u3092\u30aa\u30da\u30ec\u30fc\u30bf\u3068\u3057\u3066\u6271\u3046\u306e\u3067\u4e0d\u5177\u5408\u306e\u539f\u56e0\u3068\u306a\u308a\u305d\u3046\u306a\u306e\u3067\u975e\u63a8\u5968\n\n## \u307e\u3068\u3081\n**Arel::Nodes**\u3092\u5229\u7528\u3059\u308c\u3070Arel\u3067\u7528\u610f\u3055\u308c\u3066\u3044\u306a\u3044\u95a2\u6570\u306a\u3069\u3082\u4f7f\u3046\u3053\u3068\u304c\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3059\n\u307e\u305f\u672c\u6295\u7a3f\u3067\u306f\u5168\u3066\u306e\u30e2\u30b8\u30e5\u30fc\u30eb\u3092\u6271\u3063\u3066\u304a\u308a\u307e\u305b\u3093\u306e\u3067\u3001\u4e0b\u8a18\u3092\u53c2\u8003\u304f\u3060\u3055\u3044\n[Module: Arel::Nodes](http://www.rubydoc.info/github/rails/arel/Arel/Nodes)\n", "tags": ["Rails", "ActiveRecord"]}