{"context": "\n\n\u6982\u8981\nSQLServer\u306b\u304a\u3051\u308b\u3001\u5909\u66f4\u524d\u3068\u5909\u66f4\u5f8c\u306e\u6761\u4ef6\u3092\u3082\u3068\u306bUPDATE\u3092\u884c\u3046\u30c8\u30ea\u30ac\u30fc\n\u203b \u672c\u6765\u306f\u3001\u30a2\u30d7\u30ea\u3067\u5236\u5fa1\u3059\u308b\u3079\u304d\u3060\u304c\u3001\u672c\u8a18\u4e8b\u306f\u6280\u8853\u30cd\u30bf\u3068\u3057\u3066\u7d39\u4ecb\n\n\u6a5f\u80fd\u4ed5\u69d8\nUSER_TBL\n\n\n\n\u9805\u76ee\u540d\n\u5099\u8003\n\n\n\n\nID\nPRIMARY\n\n\nUSER_CODE\nKEY\n\n\nUSER_NAME\n\n\n\nSTART_DATE\nKEY\n\n\nEND_DATE\n\n\n\nINVALID_FLG\n\u7121\u52b9\uff081\uff09\u3001\u6709\u52b9\uff080\uff09\n\n\n\nUSER_CODE\uff08\u30e6\u30fc\u30b6\u30b3\u30fc\u30c9\uff09\u3068START_DATE\uff08\u958b\u59cb\u65e5\uff09\u304c\u30ad\u30fc\nUSER_TBL\u306b\u306f\u3001INVALID_FLG\uff08\u7121\u52b9\u30d5\u30e9\u30b0\uff09\u304c\u3042\u308a\u3001\n\u958b\u59cb\u65e5\uff1c\uff1d\u73fe\u5728\u65e5\u6642\uff1c\uff1d\u7d42\u4e86\u65e5\u306e\u6709\u52b9\u671f\u9593\u3092\u5916\u308c\u305f\u66f4\u65b0\u306e\u5834\u5408\u306b\u3001INVALID_FLG\u3092\u305f\u3066\u308b\u66f4\u65b0\u3092\u884c\u3046\n\u53c2\u8003\uff1ainserted \u30c6\u30fc\u30d6\u30eb\u3068 deleted \u30c6\u30fc\u30d6\u30eb\u306e\u4f7f\u7528 \u3068\u3001SET NOCOUNT\nCREATE TRIGGER TR_USER_TBL ON USER_TBL\nAFTER UPDATE\nAS\nBEGIN\n  -- \u73fe\u5728\u65e5\u6642\n  DECRARE @currentTime DATETIME\n  SET NOCOUNT ON\n  SET @currentTime = GETDATE()\n  -- START_DATE\u3082\u3057\u304f\u306fEND_DATE\u304c\u66f4\u65b0\u3055\u308c\u305f\u3068\u304d\n  IF UPDATE(START_DATE) OR UPDATE(END_DATE)\n  BEGIN\n    BEGIN TRY\n      UPDATE USER_TBL\n      SET\n        INVALID_FLG = '1'\n      FROM USER_TBL t\n      INNER JOIN deleted d\n      ON\n        d.USER_CODE = t.USER_CODE\n        AND d.START_DATE = t.START_DATE\n      INNER JOIN inserted i\n      ON\n        i.USER_CODE = t.USER_CODE\n        AND i.START_DATE = t.START_DATE\n      WHERE\n        -- [\u5909\u66f4\u524d]\n        -- \u958b\u59cb\u65e5 <= \u73fe\u5728\u65e5\u6642 <= \u7d42\u4e86\u65e5 \u304b\u3064\u3001\n        -- INVALID_FLG\uff08\u6709\u52b9\uff09\n        (\n          d.START_DATE <= @currentTime\n          AND @currentTime <= d.END_DATE\n          AND d.INVALID_FLG = '0'\n        )\n        OR \n        -- [\u5909\u66f4\u524d]\n        -- \u958b\u59cb\u65e5 <= \u73fe\u5728\u65e5\u6642 \u304b\u3064\u3001\n        -- INVALID_FLG\uff08\u6709\u52b9\uff09\n        (\n          d.START_DATE <= @currentTime\n          AND d.END_DATE IS NULL\n          AND d.INVALID_FLG = '0'\n        )\n        AND\n        -- [\u5909\u66f4\u5f8c] \u73fe\u5728\u65e5\u6642 < \u958b\u59cb\u65e5\n        -- \u3082\u3057\u304f\u306f\u3001\u7d42\u4e86\u65e5 < \u73fe\u5728\u65e5\u6642\n        (\n          @currentTime < i.START_DATE\n          OR (\n            i.END_DATE IS NOT NULL\n            AND i.END_DATE < @currentTime\n          )\n        )\n    END TRY\n    BEGIN CATCH\n      THROW\n    END CATCH\n  END\nEND\n\n# \u6982\u8981\nSQLServer\u306b\u304a\u3051\u308b\u3001\u5909\u66f4\u524d\u3068\u5909\u66f4\u5f8c\u306e\u6761\u4ef6\u3092\u3082\u3068\u306bUPDATE\u3092\u884c\u3046\u30c8\u30ea\u30ac\u30fc\n\u203b \u672c\u6765\u306f\u3001\u30a2\u30d7\u30ea\u3067\u5236\u5fa1\u3059\u308b\u3079\u304d\u3060\u304c\u3001\u672c\u8a18\u4e8b\u306f\u6280\u8853\u30cd\u30bf\u3068\u3057\u3066\u7d39\u4ecb\n\n# \u6a5f\u80fd\u4ed5\u69d8\nUSER_TBL\n\n| \u9805\u76ee\u540d | \u5099\u8003 |\n|:--|:--|\n|ID|PRIMARY|\n|USER_CODE|KEY|\n|USER_NAME|   |\n|START_DATE|KEY|\n|END_DATE||\n|INVALID_FLG|\u7121\u52b9\uff081\uff09\u3001\u6709\u52b9\uff080\uff09|\n\nUSER_CODE\uff08\u30e6\u30fc\u30b6\u30b3\u30fc\u30c9\uff09\u3068START_DATE\uff08\u958b\u59cb\u65e5\uff09\u304c\u30ad\u30fc\nUSER_TBL\u306b\u306f\u3001INVALID_FLG\uff08\u7121\u52b9\u30d5\u30e9\u30b0\uff09\u304c\u3042\u308a\u3001\n\u958b\u59cb\u65e5\uff1c\uff1d\u73fe\u5728\u65e5\u6642\uff1c\uff1d\u7d42\u4e86\u65e5\u306e\u6709\u52b9\u671f\u9593\u3092\u5916\u308c\u305f\u66f4\u65b0\u306e\u5834\u5408\u306b\u3001INVALID_FLG\u3092\u305f\u3066\u308b\u66f4\u65b0\u3092\u884c\u3046\n\n\u53c2\u8003\uff1a[inserted \u30c6\u30fc\u30d6\u30eb\u3068 deleted \u30c6\u30fc\u30d6\u30eb\u306e\u4f7f\u7528](https://msdn.microsoft.com/ja-jp/library/ms191300.aspx) \u3068\u3001[SET NOCOUNT](https://technet.microsoft.com/ja-jp/library/ms189837(v=sql.110).aspx)\n\n```sql\nCREATE TRIGGER TR_USER_TBL ON USER_TBL\nAFTER UPDATE\nAS\nBEGIN\n  -- \u73fe\u5728\u65e5\u6642\n  DECRARE @currentTime DATETIME\n  SET NOCOUNT ON\n  SET @currentTime = GETDATE()\n  -- START_DATE\u3082\u3057\u304f\u306fEND_DATE\u304c\u66f4\u65b0\u3055\u308c\u305f\u3068\u304d\n  IF UPDATE(START_DATE) OR UPDATE(END_DATE)\n  BEGIN\n    BEGIN TRY\n      UPDATE USER_TBL\n      SET\n        INVALID_FLG = '1'\n      FROM USER_TBL t\n      INNER JOIN deleted d\n      ON\n        d.USER_CODE = t.USER_CODE\n        AND d.START_DATE = t.START_DATE\n      INNER JOIN inserted i\n      ON\n        i.USER_CODE = t.USER_CODE\n        AND i.START_DATE = t.START_DATE\n      WHERE\n        -- [\u5909\u66f4\u524d]\n        -- \u958b\u59cb\u65e5 <= \u73fe\u5728\u65e5\u6642 <= \u7d42\u4e86\u65e5 \u304b\u3064\u3001\n        -- INVALID_FLG\uff08\u6709\u52b9\uff09\n        (\n          d.START_DATE <= @currentTime\n          AND @currentTime <= d.END_DATE\n          AND d.INVALID_FLG = '0'\n        )\n        OR \n        -- [\u5909\u66f4\u524d]\n        -- \u958b\u59cb\u65e5 <= \u73fe\u5728\u65e5\u6642 \u304b\u3064\u3001\n        -- INVALID_FLG\uff08\u6709\u52b9\uff09\n        (\n          d.START_DATE <= @currentTime\n          AND d.END_DATE IS NULL\n          AND d.INVALID_FLG = '0'\n        )\n        AND\n        -- [\u5909\u66f4\u5f8c] \u73fe\u5728\u65e5\u6642 < \u958b\u59cb\u65e5\n        -- \u3082\u3057\u304f\u306f\u3001\u7d42\u4e86\u65e5 < \u73fe\u5728\u65e5\u6642\n        (\n          @currentTime < i.START_DATE\n          OR (\n            i.END_DATE IS NOT NULL\n            AND i.END_DATE < @currentTime\n          )\n        )\n    END TRY\n    BEGIN CATCH\n      THROW\n    END CATCH\n  END\nEND\n```\n\n", "tags": ["Trigger", "SQLServer", "SQL"]}