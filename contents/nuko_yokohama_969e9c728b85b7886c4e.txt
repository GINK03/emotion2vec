{"tags": ["PostgreSQL", "extension"], "context": "\n\n\u306f\u3058\u3081\u306b\n\u5148\u65e5\u3001ANNOUNCE\u306eML\u306bpg_squeeze\u3068\u3044\u3046\u898b\u6163\u308c\u306cEXTENSION\u306ebeta\u30ea\u30ea\u30fc\u30b9\u304c\u6d41\u308c\u3066\u3044\u305f\u306e\u3067\u3001\u3061\u3087\u3063\u3068\u8a66\u3057\u3066\u307f\u308b\u3053\u3068\u306b\u3057\u305f\u3002\n\npg_squeeze\u3068\u306f\n\u3056\u3063\u3068\u898b\u305f\u611f\u3058\u3067\u306f\u3001\u81ea\u52d5\u7684\u306b\u30c6\u30fc\u30d6\u30eb\u306e\u518d\u7de8\u6210\u3092\u884c\u3046\u30c4\u30fc\u30eb\u306e\u3088\u3046\u3060\u3002\n\u8981\u3059\u308b\u306b\u3001\u81ea\u52d5CLUSTER\u3001\u3042\u308b\u3044\u306f\u81ea\u52d5pg_repack\u3068\u3044\u3046\u611f\u3058\u306e\u30c4\u30fc\u30eb\u304b\u3002\nPostgreSQL 9.3\u304b\u3089\u5c0e\u5165\u3055\u308c\u305fBackground Worker\u57fa\u76e4\u306e\u4e0a\u3067\u52d5\u304f\u30c4\u30fc\u30eb\u306a\u306e\u3067\u3001EXTENSION\u3092\u7d44\u307f\u8fbc\u3093\u3067\u304a\u3051\u3070PostgreSQL\u8d77\u52d5\u3084\u7d42\u4e86\u3068\u540c\u671f\u3057\u3066\u304f\u308c\u308b\u306e\u304c\u30dd\u30a4\u30f3\u30c8\u304b\u3002\n\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\nmake\n\u3055\u3063\u305d\u304f\u3001\u30bd\u30fc\u30b9\u306e\u30a2\u30fc\u30ab\u30a4\u30d6\u3092\u5165\u624b\u3057\u3066\u30d3\u30eb\u30c9\u3057\u3066\u307f\u308b\u3002\u4eca\u56de\u306fPostgreSQL 9.6\u4e0a\u306b\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3066\u307f\u308b\u3002\n\u4f55\u3082\u8003\u3048\u305a\u306b\u30a2\u30fc\u30ab\u30a4\u30d6\u3092\u5c55\u958b\u3057\u3066make\u3057\u3066\u307f\u308b\u3068\u30fb\u30fb\u30fb\n[nuko@localhost pg_squeeze-1.0beta1]$ make USE_PGXS=1\nmake: --pgxs: \u30b3\u30de\u30f3\u30c9\u304c\u898b\u3064\u304b\u308a\u307e\u305b\u3093\u3067\u3057\u305f\nmake: *** \u30bf\u30fc\u30b2\u30c3\u30c8\u304c\u3042\u308a\u307e\u305b\u3093.  \u4e2d\u6b62.\n\n(\u00b4\u30fb\u03c9\u30fb`) \u3057\u3087\u307c\u30fc\u3093\n\u304d\u3061\u3093\u3068README\u3092\u898b\u308b\u304b\u3002\nREADME\u3092\u898b\u308b\u3068\u3001\u74b0\u5883\u5909\u6570PG_CONFIG\u3092\u8a2d\u5b9a\u3057\u306a\u3044\u3068\u3044\u3051\u306a\u3044\u3088\u3046\u3060\u3002\u3048\u30fc\u3002\n\u74b0\u5883\u5909\u6570\u3092\u8a2d\u5b9a\u3057\u3066\u518d\u5ea6\u30d3\u30eb\u30c9\u3057\u3066\u307f\u308b\u3002\n[nuko@localhost pg_squeeze-1.0beta1]$ export PG_CONFIG=/home/nuko/pgsql/pgsql-9.6.0/bin/pg_config\n[nuko@localhost pg_squeeze-1.0beta1]$ make\ngcc -Wall -Wmissing-prototypes -Wpointer-arith -Wdeclaration-after-statement -Wendif-labels -Wmissing-format-attribute -Wformat-security -fno-strict-aliasing -fwrapv -fexcess-precision=standard -O2 -fpic -I. -I./ -I/home/nuko/pgsql/pgsql-9.6.0/include/server -I/home/nuko/pgsql/pgsql-9.6.0/include/internal -D_GNU_SOURCE   -c -o pg_squeeze.o pg_squeeze.c\npg_squeeze.c: \u95a2\u6570 \u2018squeeze_table\u2019 \u5185:\npg_squeeze.c:1887:6: \u8b66\u544a: \u2018tup_in\u2019 \u306f\u3053\u306e\u95a2\u6570\u5185\u521d\u671f\u5316\u3055\u308c\u305a\u306b\u4f7f\u7528\u3055\u308c\u308b\u304b\u3082\u3057\u308c\u307e\u305b\u3093 [-Wmaybe-uninitialized]\n   if (tup_in == NULL)\n      ^\npg_squeeze.c:1771:13: \u5099\u8003: \u2018tup_in\u2019 \u306f\u3053\u3053\u3067\u5b9a\u7fa9\u3055\u308c\u3066\u3044\u307e\u3059\n   HeapTuple tup_in;\n             ^\ngcc -Wall -Wmissing-prototypes -Wpointer-arith -Wdeclaration-after-statement -Wendif-labels -Wmissing-format-attribute -Wformat-security -fno-strict-aliasing -fwrapv -fexcess-precision=standard -O2 -fpic -I. -I./ -I/home/nuko/pgsql/pgsql-9.6.0/include/server -I/home/nuko/pgsql/pgsql-9.6.0/include/internal -D_GNU_SOURCE   -c -o concurrent.o concurrent.c\ngcc -Wall -Wmissing-prototypes -Wpointer-arith -Wdeclaration-after-statement -Wendif-labels -Wmissing-format-attribute -Wformat-security -fno-strict-aliasing -fwrapv -fexcess-precision=standard -O2 -fpic -I. -I./ -I/home/nuko/pgsql/pgsql-9.6.0/include/server -I/home/nuko/pgsql/pgsql-9.6.0/include/internal -D_GNU_SOURCE   -c -o worker.o worker.c\ngcc -Wall -Wmissing-prototypes -Wpointer-arith -Wdeclaration-after-statement -Wendif-labels -Wmissing-format-attribute -Wformat-security -fno-strict-aliasing -fwrapv -fexcess-precision=standard -O2 -fpic -I. -I./ -I/home/nuko/pgsql/pgsql-9.6.0/include/server -I/home/nuko/pgsql/pgsql-9.6.0/include/internal -D_GNU_SOURCE   -c -o pgstatapprox.o pgstatapprox.c\ngcc -Wall -Wmissing-prototypes -Wpointer-arith -Wdeclaration-after-statement -Wendif-labels -Wmissing-format-attribute -Wformat-security -fno-strict-aliasing -fwrapv -fexcess-precision=standard -O2 -fpic -shared -o pg_squeeze.so pg_squeeze.o concurrent.o worker.o pgstatapprox.o  -L/home/nuko/pgsql/pgsql-9.6.0/lib -Wl,--as-needed -Wl,-rpath,'/home/nuko/pgsql/pgsql-9.6.0/lib',--enable-new-dtags  \n[nuko@localhost pg_squeeze-1.0beta1]$\n\n\u306a\u3093\u304b\u8b66\u544a\u306f\u51fa\u3066\u308b\u3051\u3069\u4e00\u5fdc\u306f\u30d3\u30eb\u30c9\u3067\u304d\u305f\u3002\n\nmake check\nmake check\u306f\u30b5\u30dd\u30fc\u30c8\u3057\u3066\u3044\u306a\u3044\u3002\n[nuko@localhost pg_squeeze-1.0beta1]$ make check\n\"make check\" is not supported.\nDo \"make install\", then \"make installcheck\" instead.\n[nuko@localhost pg_squeeze-1.0beta1]$\n\n\nmake install\n\u306a\u306e\u3067\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3066\u304b\u3089installcheck\u3092\u52d5\u304b\u3059\u3053\u3068\u306b\u3059\u308b\u3002\n[nuko@localhost pg_squeeze-1.0beta1]$ make install\n/usr/bin/mkdir -p '/home/nuko/pgsql/pgsql-9.6.0/lib'\n/usr/bin/mkdir -p '/home/nuko/pgsql/pgsql-9.6.0/share/extension'\n/usr/bin/mkdir -p '/home/nuko/pgsql/pgsql-9.6.0/share/extension'\n/usr/bin/install -c -m 755  pg_squeeze.so '/home/nuko/pgsql/pgsql-9.6.0/lib/pg_squeeze.so'\n/usr/bin/install -c -m 644 .//pg_squeeze.control '/home/nuko/pgsql/pgsql-9.6.0/share/extension/'\n/usr/bin/install -c -m 644 .//pg_squeeze--1.0.sql  '/home/nuko/pgsql/pgsql-9.6.0/share/extension/'\n\n\u7121\u4e8b\u306b\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u5b8c\u4e86\u3002\n\nmake installcheck\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3067\u304d\u305f\u306e\u3067\u3001installcheck\u3092\u304b\u3051\u3066\u307f\u308b\u3002\n[nuko@localhost pg_squeeze-1.0beta1]$ make installcheck\n/home/nuko/pgsql/pgsql-9.6.0/lib/pgxs/src/makefiles/../../src/test/regress/pg_regress --inputdir=./ --bindir='/home/nuko/pgsql/pgsql-9.6.0/bin'    --dbname=contrib_regression squeeze\n(using postmaster on Unix socket, default port)\n============== dropping database \"contrib_regression\" ==============\nNOTICE:  database \"contrib_regression\" does not exist, skipping\nDROP DATABASE\n============== creating database \"contrib_regression\" ==============\nERROR:  permission denied to create database\ncommand failed: \"/home/nuko/pgsql/pgsql-9.6.0/bin/psql\" -X -c \"CREATE DATABASE \\\"contrib_regression\\\" TEMPLATE=template0\" \"postgres\"\nmake: *** [installcheck] \u30a8\u30e9\u30fc 2\n\n\u3042\u30fc\u3001\u3046\u3061\u306e\u74b0\u5883\u3067\u52d5\u304b\u3059\u3068\u30e6\u30fc\u30b6\u540d\u304cnuko\u306b\u306a\u3063\u3061\u3083\u3046\u3093\u3060\u3088\u306a\u3002\u4ed5\u65b9\u304c\u306a\u3044\u3002\n\u74b0\u5883\u5909\u6570PGUSER=postgres\u3092\u8a2d\u5b9a\u3057\u3066\u30ea\u30c8\u30e9\u30a4\u3002\n[nuko@localhost pg_squeeze-1.0beta1]$ export PGUSER=postgres\n[nuko@localhost pg_squeeze-1.0beta1]$ make installcheck\n/home/nuko/pgsql/pgsql-9.6.0/lib/pgxs/src/makefiles/../../src/test/regress/pg_regress --inputdir=./ --bindir='/home/nuko/pgsql/pgsql-9.6.0/bin'    --dbname=contrib_regression squeeze\n(using postmaster on Unix socket, default port)\n============== dropping database \"contrib_regression\" ==============\nNOTICE:  database \"contrib_regression\" does not exist, skipping\nDROP DATABASE\n============== creating database \"contrib_regression\" ==============\nCREATE DATABASE\nALTER DATABASE\n============== running regression test queries        ==============\ntest squeeze                  ... FAILED (test process exited with exit code 2)\n\n======================\n 1 of 1 tests failed. \n======================\n\nThe differences that caused some tests to fail can be viewed in the\nfile \"/home/nuko/src/pg_squeeze-1.0beta1/regression.diffs\".  A copy of the test summary that you see\nabove is saved in the file \"/home/nuko/src/pg_squeeze-1.0beta1/regression.out\".\n\nmake: *** [installcheck] \u30a8\u30e9\u30fc 1\n[nuko@localhost pg_squeeze-1.0beta1]$ \n\n\u3048\u30fc\u3001installcheck\u306b\u30ab\u30b8\u30e5\u30a2\u30eb\u306b\u5931\u6557\u3057\u3066\u308b\u3093\u3060\u3051\u3069\u30fb\u30fb\u30fb\u3002\nregression\u306ediff\u3092\u898b\u3066\u307f\u308b\u3068\u3001\n---\n> FATAL:  cannot create PGC_POSTMASTER variables after startup\n> server closed the connection unexpectedly\n>   This probably means the server terminated abnormally\n>   before or while processing the request.\n> connection to server was lost\n\n\u3048\u30fc\u3001PGC_POSTMASTER\u5909\u6570\u3063\u3066\u4f55\u3088\u30fb\u30fb\u30fb\u3002\u305d\u3093\u306a\u306eREADME\u306b\u66f8\u3044\u3066\u306a\u3044\u3093\u3060\u304c\u3002\n\u307e\u3042\u3001\u3044\u3044\u3084\u3002\u3068\u308a\u3042\u3048\u305a\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u306f\u3067\u304d\u305f\u3093\u3060\u308d\u3046\u3057\u3001\u5148\u306b\u52d5\u304b\u3057\u3066\u307f\u3088\u3046\u3002\n\n\u4f7f\u7528\u6761\u4ef6\n\u3053\u306e\u30c4\u30fc\u30eb\u3082CLUSTER\u30b3\u30de\u30f3\u30c9\u3084\u3001pg_repack\u3068\u540c\u69d8\u306bPrimary Key/Unique Key\u304c\u5b58\u5728\u3059\u308b\u30c6\u30fc\u30d6\u30eb\u3067\u306a\u3044\u3068\u52d5\u4f5c\u3057\u306a\u3044\u3063\u307d\u3044\u3002\n\nFirst, make sure that your table has either primary key or unique\nconstraint. This is necessary to process changes other transactions might do\nwhile \"pg_squeeze\" is doing its work.\n\n\nPostgreSQL\u8a2d\u5b9a\nREADME\u3092\u8aad\u3080\u3068\u3001\u4ee5\u4e0b\u306ePostgreSQL\u8a2d\u5b9a\u304c\u5fc5\u8981\u3068\u306a\u3002\n4. Apply the following settings to postgresql.conf:\n\n   wal_level = logical\n\n   max_replication_slots = 1 # ... or add 1 to the current value.\n\n   shared_preload_libraries = 'pg_squeeze' # ... or add the library to the existing ones.\n\n\u307b\u304a\u3002pg_squeeze\u306f\u30ed\u30b8\u30ab\u30eb\u30c7\u30b3\u30fc\u30c7\u30a3\u30f3\u30b0\u306e\u6a5f\u80fd\u3082\u4f7f\u3063\u3066\u3044\u308b\u3093\u3060\u306a\u3002\u3075\u3080\u3002\n\u3042\u30fb\u30fb\u30fb\u3068\u3044\u3046\u3053\u3068\u306f\u3001UNLOGGED TABLE\u306b\u5bfe\u3057\u3066\u306f\u3053\u306e\u30c4\u30fc\u30eb\u306f\u4f7f\u3048\u306a\u3044\u3063\u3066\u3053\u3068\u306a\u306e\u304b\u306a\u30fb\u30fb\u30fb\u3002\n\u3068\u308a\u3042\u3048\u305a\u3001postgresql.conf\u306b\u4e0a\u8a18\u306e\u3088\u3046\u306a\u8a2d\u5b9a\u3092\u3057\u3066PostgreSQL\u3092\u518d\u8d77\u52d5\u3057\u3066\u307f\u308b\u3002\nshared_preload_libraries = 'pg_squeeze'\nsqueeze.worker_autostart = 'bench'\nsqueeze.worker_role = postgres\n\n\nsqueeze.* \u306e\u30d1\u30e9\u30e1\u30fc\u30bf\u306fpg_squeeze\u5c02\u7528\u306e\u3082\u306e\u3002\u3053\u306e\u8a2d\u5b9a\u306b\u3057\u3066\u304a\u304f\u3068\u3001PostgreSQL\u30b5\u30fc\u30d0\u8d77\u52d5\u6642\u306b\u81ea\u52d5\u7684\u306bbench\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306b\u5bfe\u3059\u308bpg_squeeze\u306e\u51e6\u7406\u3092\u3057\u3066\u304f\u308c\u308b\u3082\u306e\u3063\u307d\u3044(\u305f\u3076\u3093)\u3002\n\u30b5\u30fc\u30d0\u30ed\u30b0\u3092\u898b\u308b\u3068\u3001\u3068\u304f\u306b\u3053\u306eEXTENSION\u3092\u7d44\u307f\u8fbc\u307f\u304c\u6b63\u5e38\u306b\u7d42\u4e86\u3057\u305f\u7b49\u306e\u30e1\u30c3\u30bb\u30fc\u30b8\u306f\u51fa\u3066\u3044\u306a\u3044\u3002pgaudit\u307f\u305f\u3044\u306b\u7d44\u307f\u8fbc\u3093\u3060\u3053\u3068\u304c\u5206\u304b\u308b\u30e1\u30c3\u30bb\u30fc\u30b8\u304f\u3089\u3044\u51fa\u3057\u3066\u3082\u3044\u3044\u306e\u306b\u306a\u3042\u3002\n\nEXTENSION\u306e\u767b\u9332\npg_squeeze\u306f\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u3078\u306e\u767b\u9332\u304c\u5fc5\u8981\u3089\u3057\u3044\u3002\u4eca\u56de\u306fpgbench\u7528\u306e\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9bench\u306b\u7d44\u307f\u8fbc\u3093\u3067\u898b\u308b\u3002\n[nuko@localhost ~]$ psql -U postgres bench\npsql (9.6.0)\nType \"help\" for help.\n\nbench=# CREATE EXTENSION pg_squeeze ;\nCREATE EXTENSION\nbench=# \n\n\npg_squeeze\u7528\u306e\u8a2d\u5b9a\n\u3055\u3066\u3001\u3053\u306epg_squeeze\u3060\u304c\u3001EXTENSION\u3092\u7d44\u307f\u8fbc\u3093\u3060\u3060\u3051\u3067\u81ea\u52d5\u7684\u306b\u3088\u3057\u306a\u306b\u518d\u7de8\u6210\u30fb\u30fb\u30fb\u3068\u3044\u3046\u3053\u3068\u306f\u3057\u3066\u304f\u308c\u306a\u3044\u3002\n\u3044\u308d\u3044\u308d\u8a2d\u5b9a\u304c\u5fc5\u8981\u3063\u307d\u3044\u3002\n\nsqueeze\u30b9\u30ad\u30fc\u30de\u306e\u30c6\u30fc\u30d6\u30eb\u7fa4\npg_squeeze\u3067\u306f\u3001\u7ba1\u7406\u7528\u306b\u3044\u308d\u3093\u306a\u30c6\u30fc\u30d6\u30eb\u3092squeeze\u30b9\u30ad\u30fc\u30de\u4e0a\u306b\u4f5c\u3063\u3066\u307f\u308b\u307f\u305f\u3044\u3002\nbench-# \\d squeeze.\nsqueeze.errors                        squeeze.tables                        squeeze.tables_tabschema_tabname_key\nsqueeze.errors_id_seq                 squeeze.tables_id_seq                 squeeze.tasks\nsqueeze.errors_pkey                   squeeze.tables_internal               squeeze.tasks_active_idx\nsqueeze.log                           squeeze.tables_internal_pkey          squeeze.tasks_id_seq\nsqueeze.log_started_idx               squeeze.tables_pkey                   squeeze.tasks_pkey\nbench-# \\d squeeze.\n\npg_squeeze\u3092\u4f7f\u3046\u5834\u5408\u306b\u306f\u3001squeeze.table\u306b\u518d\u7de8\u6210\u51e6\u7406\u5bfe\u8c61\u306e\u30c6\u30fc\u30d6\u30eb\u3092\u767b\u9332\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u3002\u3081\u3093\u3069\u3044\u3002\n\u4eca\u56de\u306f\u3001pgbench_branches\u30c6\u30fc\u30d6\u30eb\u3092\u5bfe\u8c61\u306b\u3059\u308b\u3002\u3053\u306e\u30c6\u30fc\u30d6\u30eb\u306f\u3001fillfactor\u3092\u8a2d\u5b9a\u3057\u306a\u3044\u3068\u3001\u3059\u3050\u306b\u80a5\u5927\u5316\u3057\u305d\u3046\u3060\u304b\u3089\u3060\u3002\n(\u3082\u3063\u3068\u3082\u3001\u30ec\u30b3\u30fc\u30c9\u6570\u81ea\u4f53\u306f\u975e\u5e38\u306b\u5c11\u306a\u3044\u306e\u3067\u3001\u80a5\u5927\u5316\u3057\u305f\u3068\u3057\u3066\u3082\u3001\u305d\u308c\u307b\u3069\u5b9f\u5bb3\u306f\u306a\u3044\u3088\u3046\u306a\u6c17\u3082\u3059\u308b\u304c)\nsqueeze.table\u306f\u3053\u3093\u306a\u30c6\u30fc\u30d6\u30eb\u3060\u3002\nbench-# \\d squeeze.tables\n                                          Table \"squeeze.tables\"\n      Column      |           Type           |                          Modifiers                          \n------------------+--------------------------+-------------------------------------------------------------\n id               | integer                  | not null default nextval('squeeze.tables_id_seq'::regclass)\n tabschema        | name                     | not null\n tabname          | name                     | not null\n clustering_index | name                     | \n rel_tablespace   | name                     | \n ind_tablespaces  | name[]                   | \n task_interval    | interval                 | not null default '01:00:00'::interval\n first_check      | timestamp with time zone | not null\n free_space_extra | integer                  | not null default 50\n min_size         | real                     | not null default 8\n vacuum_max_age   | interval                 | not null default '01:00:00'::interval\n max_retry        | integer                  | not null default 0\n skip_analyze     | boolean                  | not null default false\nIndexes:\n    \"tables_pkey\" PRIMARY KEY, btree (id)\n    \"tables_tabschema_tabname_key\" UNIQUE CONSTRAINT, btree (tabschema, tabname)\nCheck constraints:\n    \"tables_free_space_extra_check\" CHECK (free_space_extra >= 0 AND free_space_extra < 100)\n    \"tables_min_size_check\" CHECK (min_size > 0.0::double precision)\n    \"tables_task_interval_check\" CHECK (task_interval >= '00:01:00'::interval)\nReferenced by:\n    TABLE \"squeeze.tables_internal\" CONSTRAINT \"tables_internal_table_id_fkey\" FOREIGN KEY (table_id) REFERENCES squeeze.tables(id) ON DELETE CASCAD\nE\n    TABLE \"squeeze.tasks\" CONSTRAINT \"tasks_table_id_fkey\" FOREIGN KEY (table_id) REFERENCES squeeze.tables(id) ON DELETE CASCADE\nTriggers:\n    tables_internal_trig AFTER INSERT ON squeeze.tables FOR EACH ROW EXECUTE PROCEDURE squeeze.tables_internal_trig_func()\n\n\u30c8\u30ea\u30ac\u304c\u8a2d\u5b9a\u3055\u308c\u3066\u3044\u308b\u3002squeeze\u51e6\u7406\u5bfe\u8c61\u306e\u30c6\u30fc\u30d6\u30eb\u3092\u3053\u3053\u306b\u767b\u9332\u3059\u308b\u3068\u3001\u4ed6\u306e\u7ba1\u7406\u7528\u306e\u30c6\u30fc\u30d6\u30eb\u306b\u3082\u4f55\u304b\u3057\u3089\u306e\u8a2d\u5b9a\u3092\u4f1d\u64ad\u3059\u308b\u306e\u3060\u308d\u3046\u3002\n\u3068\u308a\u3042\u3048\u305a\u8a2d\u5b9a\u3057\u3066\u307f\u308b\u3002\nbench=# INSERT INTO squeeze.tables (tabschema, tabname, first_check, task_interval, min_size) \nVALUES ('public','pgbench_branches',now(),'1 min', 0.1);\nINSERT 0 1\nbench=# INSERT INTO squeeze.tables (tabschema, tabname, first_check, task_interval, min_size) \nVALUES ('public','pgbench_tellers',now(),'1 min', 0.1);\nINSERT 0 1\nbench=# \n\n\u3068\u308a\u3042\u3048\u305aINSERT\u306f\u3055\u308c\u305f\u3002\u305f\u3076\u3093\u3001\u3053\u3046\u3044\u3046\u8a2d\u5b9a\u3002\n\n\u30bf\u30fc\u30b2\u30c3\u30c8\u306fpublic.pgbench_accounts\u3068public.pgbench_tellers\n\u6700\u521d\u306esqueeze\u51e6\u7406\u306e\u305f\u3081\u306e\u30c1\u30a7\u30c3\u30af\u306fINSERT\u6587\u5b9f\u884c\u6642\n1\u5206\u6bce\u306b\u30c1\u30a7\u30c3\u30af(\u30c7\u30d5\u30a9\u30eb\u30c8\u306f1\u6642\u9593\u307d\u3044)\n\u80a5\u5927\u5316\u3057\u305f\u304b\u3069\u3046\u304b\u306e\u95be\u5024(?)\u306f 0.1 MB\n\n\npgbench\u306b\u3088\u308b\u52d5\u4f5c\u78ba\u8a8d\n\n\u6e2c\u5b9a\u74b0\u5883\n\u4eca\u56de\u306fScale Factor = 10\u306e\u72b6\u614b\u3067pgbench\u74b0\u5883\u3092\u521d\u671f\u751f\u6210\u3057\u305f\u3002\n[nuko@localhost ~]$ pgbench -i -s 10 -U postgres bench \ncreating tables...\n100000 of 1000000 tuples (10%) done (elapsed 0.15 s, remaining 1.38 s)\n200000 of 1000000 tuples (20%) done (elapsed 0.42 s, remaining 1.68 s)\n300000 of 1000000 tuples (30%) done (elapsed 0.70 s, remaining 1.63 s)\n400000 of 1000000 tuples (40%) done (elapsed 0.83 s, remaining 1.25 s)\n500000 of 1000000 tuples (50%) done (elapsed 1.04 s, remaining 1.04 s)\n600000 of 1000000 tuples (60%) done (elapsed 1.27 s, remaining 0.85 s)\n700000 of 1000000 tuples (70%) done (elapsed 1.44 s, remaining 0.62 s)\n800000 of 1000000 tuples (80%) done (elapsed 1.65 s, remaining 0.41 s)\n900000 of 1000000 tuples (90%) done (elapsed 1.86 s, remaining 0.21 s)\n1000000 of 1000000 tuples (100%) done (elapsed 2.88 s, remaining 0.00 s)\nvacuum...\nset primary keys...\ndone.\n[nuko@localhost ~]$\n\npgbench\u3092\u30c7\u30d5\u30a9\u30eb\u30c8\u30c8\u30e9\u30f3\u30b6\u30af\u30b7\u30e7\u30f3\u3067\u52d5\u304b\u3059\u3068\u3001pgbench_accounts, pgbench_branches, pgbench_tellers\u306b\u5bfe\u3057\u3066UPDATE\u6587\u304c\u767a\u884c\u3055\u308c\u308b\u3002\n\u73fe\u72b6\u306f\u3042\u3048\u3066fillfactor\u3092100\u306b\u3057\u3066\u3044\u308b\u306e\u3067\u3001\u3069\u306e\u30c6\u30fc\u30d6\u30eb\u3082HOT\u66f4\u65b0\u304c\u3055\u308c\u306b\u304f\u304f\u3001\u80a5\u5927\u5316\u3057\u3084\u3059\u3044\u306f\u305a\u3002\nbench=# \\d+ pgbench_accounts\n                       Table \"public.pgbench_accounts\"\n  Column  |     Type      | Modifiers | Storage  | Stats target | Description \n----------+---------------+-----------+----------+--------------+-------------\n aid      | integer       | not null  | plain    |              | \n bid      | integer       |           | plain    |              | \n abalance | integer       |           | plain    |              | \n filler   | character(84) |           | extended |              | \nIndexes:\n    \"pgbench_accounts_pkey\" PRIMARY KEY, btree (aid)\nOptions: fillfactor=100\n\nscale factor\u309210\u306b\u3057\u3066\u52d5\u304b\u3057\u3066\u3044\u308b\u306e\u3067\u3001pgbench_branches\u306e\u521d\u671f\u4ef6\u6570\u306f10\u4ef6\u3002\u30ea\u30ec\u30fc\u30b7\u30e7\u30f3\u30b5\u30a4\u30ba\u306f8192\u30d0\u30a4\u30c8(1\u30da\u30fc\u30b8)\u3002pgbench_tellers\u306e\u521d\u671f\u4ef6\u6570\u306f100\u4ef6\u3001\u30ea\u30ec\u30fc\u30b7\u30e7\u30f3\u30b5\u30a4\u30ba\u306f2\u30da\u30fc\u30b8\u3002\n\u3053\u306e\u72b6\u614b\u3067pg_squeeze\u3092\u7121\u52b9\u5316/\u6709\u52b9\u5316\u3057\u306610\u4e07\u30c8\u30e9\u30f3\u30b6\u30af\u30b7\u30e7\u30f3\u5b9f\u884c\u3057\u3066\u307f\u308b\u3002\n[nuko@localhost ~]$ pgbench -U postgres bench -c 4 -t 25000\nstarting vacuum...end.\ntransaction type: <builtin: TPC-B (sort of)>\nscaling factor: 10\nquery mode: simple\nnumber of clients: 4\nnumber of threads: 1\nnumber of transactions per client: 25000\nnumber of transactions actually processed: 100000/100000\nlatency average = 3.371 ms\ntps = 1186.728938 (including connections establishing)\ntps = 1186.921844 (excluding connections establishing)\n[nuko@localhost ~]$\n\n\npgbench\u5b9f\u884c\u524d/\u5b9f\u884c\u5f8c\u306e\u30ea\u30ec\u30fc\u30b7\u30e7\u30f3\u30b5\u30a4\u30ba\n10\u4e07\u56depgbench\u306e\u30c7\u30d5\u30a9\u30eb\u30c8\u30c8\u30e9\u30f3\u30b6\u30af\u30b7\u30e7\u30f3\u5b9f\u884c\u5f8c\u306e\u30c6\u30fc\u30d6\u30eb\u30b5\u30a4\u30ba\u3092pg_relation_size()\u306e\u5024\u3067\u6bd4\u8f03\u3057\u3066\u307f\u305f(\u30b5\u30a4\u30ba\u306fbyte)\u3002\n\n\n\n\u8a2d\u5b9a\n\u521d\u671f\u30b5\u30a4\u30ba\npg_squeeze\u306a\u3057\npg_squeeze\u3042\u308a\n\n\n\n\npgbench_tellers\n16384\n204800\n49152\n\n\npgbench_branches\n8192\n65536\n16384\n\n\n\n\n\u304a\u3001\u3069\u3061\u3089\u306e\u30c6\u30fc\u30d6\u30eb\u308225%\u7a0b\u5ea6\u306e\u30b5\u30a4\u30ba\u306b\u7e2e\u5c0f\u3055\u308c\u3066\u307e\u3059\u306d\u3002\n\n\u304a\u308f\u308a\u306b\n\u307e\u3060\u03b2\u30d0\u30fc\u30b8\u30e7\u30f3\u306a\u306e\u3067\u3001\u4f7f\u3044\u5012\u3059\u3068\u3044\u308d\u3044\u308d\u30c8\u30e9\u30d6\u30eb\u3082\u3042\u308b\u304b\u3082\u3057\u308c\u306a\u3044\u304c(\u4f8b\u3048\u3070\u3001\u518d\u5ea6CREATE EXTENSION\u3059\u308b\u3068\u304d\u306b\u30d0\u30c3\u30af\u30a8\u30f3\u30c9\u7570\u5e38\u304c\u8d77\u304d\u305f\u308a\u3082\u3057\u305f)\u3001\u30c6\u30fc\u30d6\u30eb\u304c\u80a5\u5927\u5316\u3057\u304c\u3061\u306a\u6848\u4ef6\u3067\u3042\u308c\u3070\u3001\u8a66\u3057\u306b\u4f7f\u3063\u3066\u307f\u308b\u306e\u3082\u3042\u308a\u304b\u306a\u3001\u3068\u3044\u3046\u5370\u8c61\u306f\u3082\u3063\u305f\u3002\n\u3042\u3068\u306f\u3001\u518d\u7de8\u6210\u4e2d\u306b\u3069\u306e\u304f\u3089\u3044\u6027\u80fd\u306b\u5f71\u97ff\u304c\u3067\u308b\u304b\u3001\u3069\u3053\u304b\u3067\u6e2c\u5b9a\u3057\u3066\u304a\u304d\u305f\u3044\u3082\u306e\u3002\n\n\n# \u306f\u3058\u3081\u306b\n\u5148\u65e5\u3001ANNOUNCE\u306eML\u306b[pg_squeeze](http://www.cybertec.at/en/products/pg_squeeze-postgresql-extension-to-auto-rebuild-bloated-tables/)\u3068\u3044\u3046\u898b\u6163\u308c\u306cEXTENSION\u306ebeta\u30ea\u30ea\u30fc\u30b9\u304c\u6d41\u308c\u3066\u3044\u305f\u306e\u3067\u3001\u3061\u3087\u3063\u3068\u8a66\u3057\u3066\u307f\u308b\u3053\u3068\u306b\u3057\u305f\u3002\n\n# pg_squeeze\u3068\u306f\n\u3056\u3063\u3068\u898b\u305f\u611f\u3058\u3067\u306f\u3001\u81ea\u52d5\u7684\u306b\u30c6\u30fc\u30d6\u30eb\u306e\u518d\u7de8\u6210\u3092\u884c\u3046\u30c4\u30fc\u30eb\u306e\u3088\u3046\u3060\u3002\n\u8981\u3059\u308b\u306b\u3001\u81ea\u52d5CLUSTER\u3001\u3042\u308b\u3044\u306f\u81ea\u52d5pg_repack\u3068\u3044\u3046\u611f\u3058\u306e\u30c4\u30fc\u30eb\u304b\u3002\nPostgreSQL 9.3\u304b\u3089\u5c0e\u5165\u3055\u308c\u305fBackground Worker\u57fa\u76e4\u306e\u4e0a\u3067\u52d5\u304f\u30c4\u30fc\u30eb\u306a\u306e\u3067\u3001EXTENSION\u3092\u7d44\u307f\u8fbc\u3093\u3067\u304a\u3051\u3070PostgreSQL\u8d77\u52d5\u3084\u7d42\u4e86\u3068\u540c\u671f\u3057\u3066\u304f\u308c\u308b\u306e\u304c\u30dd\u30a4\u30f3\u30c8\u304b\u3002\n\n# \u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n## make\n\u3055\u3063\u305d\u304f\u3001\u30bd\u30fc\u30b9\u306e\u30a2\u30fc\u30ab\u30a4\u30d6\u3092\u5165\u624b\u3057\u3066\u30d3\u30eb\u30c9\u3057\u3066\u307f\u308b\u3002\u4eca\u56de\u306fPostgreSQL 9.6\u4e0a\u306b\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3066\u307f\u308b\u3002\n\u4f55\u3082\u8003\u3048\u305a\u306b\u30a2\u30fc\u30ab\u30a4\u30d6\u3092\u5c55\u958b\u3057\u3066make\u3057\u3066\u307f\u308b\u3068\u30fb\u30fb\u30fb\n\n```\n[nuko@localhost pg_squeeze-1.0beta1]$ make USE_PGXS=1\nmake: --pgxs: \u30b3\u30de\u30f3\u30c9\u304c\u898b\u3064\u304b\u308a\u307e\u305b\u3093\u3067\u3057\u305f\nmake: *** \u30bf\u30fc\u30b2\u30c3\u30c8\u304c\u3042\u308a\u307e\u305b\u3093.  \u4e2d\u6b62.\n```\n\n(\u00b4\u30fb\u03c9\u30fb`) \u3057\u3087\u307c\u30fc\u3093\n\n\u304d\u3061\u3093\u3068README\u3092\u898b\u308b\u304b\u3002\nREADME\u3092\u898b\u308b\u3068\u3001\u74b0\u5883\u5909\u6570PG_CONFIG\u3092\u8a2d\u5b9a\u3057\u306a\u3044\u3068\u3044\u3051\u306a\u3044\u3088\u3046\u3060\u3002\u3048\u30fc\u3002\n\u74b0\u5883\u5909\u6570\u3092\u8a2d\u5b9a\u3057\u3066\u518d\u5ea6\u30d3\u30eb\u30c9\u3057\u3066\u307f\u308b\u3002\n\n```\n[nuko@localhost pg_squeeze-1.0beta1]$ export PG_CONFIG=/home/nuko/pgsql/pgsql-9.6.0/bin/pg_config\n[nuko@localhost pg_squeeze-1.0beta1]$ make\ngcc -Wall -Wmissing-prototypes -Wpointer-arith -Wdeclaration-after-statement -Wendif-labels -Wmissing-format-attribute -Wformat-security -fno-strict-aliasing -fwrapv -fexcess-precision=standard -O2 -fpic -I. -I./ -I/home/nuko/pgsql/pgsql-9.6.0/include/server -I/home/nuko/pgsql/pgsql-9.6.0/include/internal -D_GNU_SOURCE   -c -o pg_squeeze.o pg_squeeze.c\npg_squeeze.c: \u95a2\u6570 \u2018squeeze_table\u2019 \u5185:\npg_squeeze.c:1887:6: \u8b66\u544a: \u2018tup_in\u2019 \u306f\u3053\u306e\u95a2\u6570\u5185\u521d\u671f\u5316\u3055\u308c\u305a\u306b\u4f7f\u7528\u3055\u308c\u308b\u304b\u3082\u3057\u308c\u307e\u305b\u3093 [-Wmaybe-uninitialized]\n   if (tup_in == NULL)\n      ^\npg_squeeze.c:1771:13: \u5099\u8003: \u2018tup_in\u2019 \u306f\u3053\u3053\u3067\u5b9a\u7fa9\u3055\u308c\u3066\u3044\u307e\u3059\n   HeapTuple tup_in;\n             ^\ngcc -Wall -Wmissing-prototypes -Wpointer-arith -Wdeclaration-after-statement -Wendif-labels -Wmissing-format-attribute -Wformat-security -fno-strict-aliasing -fwrapv -fexcess-precision=standard -O2 -fpic -I. -I./ -I/home/nuko/pgsql/pgsql-9.6.0/include/server -I/home/nuko/pgsql/pgsql-9.6.0/include/internal -D_GNU_SOURCE   -c -o concurrent.o concurrent.c\ngcc -Wall -Wmissing-prototypes -Wpointer-arith -Wdeclaration-after-statement -Wendif-labels -Wmissing-format-attribute -Wformat-security -fno-strict-aliasing -fwrapv -fexcess-precision=standard -O2 -fpic -I. -I./ -I/home/nuko/pgsql/pgsql-9.6.0/include/server -I/home/nuko/pgsql/pgsql-9.6.0/include/internal -D_GNU_SOURCE   -c -o worker.o worker.c\ngcc -Wall -Wmissing-prototypes -Wpointer-arith -Wdeclaration-after-statement -Wendif-labels -Wmissing-format-attribute -Wformat-security -fno-strict-aliasing -fwrapv -fexcess-precision=standard -O2 -fpic -I. -I./ -I/home/nuko/pgsql/pgsql-9.6.0/include/server -I/home/nuko/pgsql/pgsql-9.6.0/include/internal -D_GNU_SOURCE   -c -o pgstatapprox.o pgstatapprox.c\ngcc -Wall -Wmissing-prototypes -Wpointer-arith -Wdeclaration-after-statement -Wendif-labels -Wmissing-format-attribute -Wformat-security -fno-strict-aliasing -fwrapv -fexcess-precision=standard -O2 -fpic -shared -o pg_squeeze.so pg_squeeze.o concurrent.o worker.o pgstatapprox.o  -L/home/nuko/pgsql/pgsql-9.6.0/lib -Wl,--as-needed -Wl,-rpath,'/home/nuko/pgsql/pgsql-9.6.0/lib',--enable-new-dtags  \n[nuko@localhost pg_squeeze-1.0beta1]$\n```\n\n\u306a\u3093\u304b\u8b66\u544a\u306f\u51fa\u3066\u308b\u3051\u3069\u4e00\u5fdc\u306f\u30d3\u30eb\u30c9\u3067\u304d\u305f\u3002\n\n## make check\n\nmake check\u306f\u30b5\u30dd\u30fc\u30c8\u3057\u3066\u3044\u306a\u3044\u3002\n\n```\n[nuko@localhost pg_squeeze-1.0beta1]$ make check\n\"make check\" is not supported.\nDo \"make install\", then \"make installcheck\" instead.\n[nuko@localhost pg_squeeze-1.0beta1]$\n```\n\n## make install\n\u306a\u306e\u3067\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3066\u304b\u3089installcheck\u3092\u52d5\u304b\u3059\u3053\u3068\u306b\u3059\u308b\u3002\n\n```\n[nuko@localhost pg_squeeze-1.0beta1]$ make install\n/usr/bin/mkdir -p '/home/nuko/pgsql/pgsql-9.6.0/lib'\n/usr/bin/mkdir -p '/home/nuko/pgsql/pgsql-9.6.0/share/extension'\n/usr/bin/mkdir -p '/home/nuko/pgsql/pgsql-9.6.0/share/extension'\n/usr/bin/install -c -m 755  pg_squeeze.so '/home/nuko/pgsql/pgsql-9.6.0/lib/pg_squeeze.so'\n/usr/bin/install -c -m 644 .//pg_squeeze.control '/home/nuko/pgsql/pgsql-9.6.0/share/extension/'\n/usr/bin/install -c -m 644 .//pg_squeeze--1.0.sql  '/home/nuko/pgsql/pgsql-9.6.0/share/extension/'\n```\n\n\u7121\u4e8b\u306b\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u5b8c\u4e86\u3002\n\n## make installcheck\n\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3067\u304d\u305f\u306e\u3067\u3001installcheck\u3092\u304b\u3051\u3066\u307f\u308b\u3002\n\n```\n[nuko@localhost pg_squeeze-1.0beta1]$ make installcheck\n/home/nuko/pgsql/pgsql-9.6.0/lib/pgxs/src/makefiles/../../src/test/regress/pg_regress --inputdir=./ --bindir='/home/nuko/pgsql/pgsql-9.6.0/bin'    --dbname=contrib_regression squeeze\n(using postmaster on Unix socket, default port)\n============== dropping database \"contrib_regression\" ==============\nNOTICE:  database \"contrib_regression\" does not exist, skipping\nDROP DATABASE\n============== creating database \"contrib_regression\" ==============\nERROR:  permission denied to create database\ncommand failed: \"/home/nuko/pgsql/pgsql-9.6.0/bin/psql\" -X -c \"CREATE DATABASE \\\"contrib_regression\\\" TEMPLATE=template0\" \"postgres\"\nmake: *** [installcheck] \u30a8\u30e9\u30fc 2\n```\n\n\u3042\u30fc\u3001\u3046\u3061\u306e\u74b0\u5883\u3067\u52d5\u304b\u3059\u3068\u30e6\u30fc\u30b6\u540d\u304c```nuko```\u306b\u306a\u3063\u3061\u3083\u3046\u3093\u3060\u3088\u306a\u3002\u4ed5\u65b9\u304c\u306a\u3044\u3002\n\u74b0\u5883\u5909\u6570```PGUSER=postgres```\u3092\u8a2d\u5b9a\u3057\u3066\u30ea\u30c8\u30e9\u30a4\u3002\n\n```\n[nuko@localhost pg_squeeze-1.0beta1]$ export PGUSER=postgres\n[nuko@localhost pg_squeeze-1.0beta1]$ make installcheck\n/home/nuko/pgsql/pgsql-9.6.0/lib/pgxs/src/makefiles/../../src/test/regress/pg_regress --inputdir=./ --bindir='/home/nuko/pgsql/pgsql-9.6.0/bin'    --dbname=contrib_regression squeeze\n(using postmaster on Unix socket, default port)\n============== dropping database \"contrib_regression\" ==============\nNOTICE:  database \"contrib_regression\" does not exist, skipping\nDROP DATABASE\n============== creating database \"contrib_regression\" ==============\nCREATE DATABASE\nALTER DATABASE\n============== running regression test queries        ==============\ntest squeeze                  ... FAILED (test process exited with exit code 2)\n\n======================\n 1 of 1 tests failed. \n======================\n\nThe differences that caused some tests to fail can be viewed in the\nfile \"/home/nuko/src/pg_squeeze-1.0beta1/regression.diffs\".  A copy of the test summary that you see\nabove is saved in the file \"/home/nuko/src/pg_squeeze-1.0beta1/regression.out\".\n\nmake: *** [installcheck] \u30a8\u30e9\u30fc 1\n[nuko@localhost pg_squeeze-1.0beta1]$ \n```\n\n\u3048\u30fc\u3001installcheck\u306b\u30ab\u30b8\u30e5\u30a2\u30eb\u306b\u5931\u6557\u3057\u3066\u308b\u3093\u3060\u3051\u3069\u30fb\u30fb\u30fb\u3002\nregression\u306ediff\u3092\u898b\u3066\u307f\u308b\u3068\u3001\n\n```\n---\n> FATAL:  cannot create PGC_POSTMASTER variables after startup\n> server closed the connection unexpectedly\n> \tThis probably means the server terminated abnormally\n> \tbefore or while processing the request.\n> connection to server was lost\n```\n\n\u3048\u30fc\u3001PGC_POSTMASTER\u5909\u6570\u3063\u3066\u4f55\u3088\u30fb\u30fb\u30fb\u3002\u305d\u3093\u306a\u306eREADME\u306b\u66f8\u3044\u3066\u306a\u3044\u3093\u3060\u304c\u3002\n\u307e\u3042\u3001\u3044\u3044\u3084\u3002\u3068\u308a\u3042\u3048\u305a\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u306f\u3067\u304d\u305f\u3093\u3060\u308d\u3046\u3057\u3001\u5148\u306b\u52d5\u304b\u3057\u3066\u307f\u3088\u3046\u3002\n\n# \u4f7f\u7528\u6761\u4ef6\n\u3053\u306e\u30c4\u30fc\u30eb\u3082CLUSTER\u30b3\u30de\u30f3\u30c9\u3084\u3001pg_repack\u3068\u540c\u69d8\u306bPrimary Key/Unique Key\u304c\u5b58\u5728\u3059\u308b\u30c6\u30fc\u30d6\u30eb\u3067\u306a\u3044\u3068\u52d5\u4f5c\u3057\u306a\u3044\u3063\u307d\u3044\u3002\n\n> First, make sure that your table has either primary key or unique\n> constraint. This is necessary to process changes other transactions might do\n> while \"pg_squeeze\" is doing its work.\n\n# PostgreSQL\u8a2d\u5b9a\nREADME\u3092\u8aad\u3080\u3068\u3001\u4ee5\u4e0b\u306ePostgreSQL\u8a2d\u5b9a\u304c\u5fc5\u8981\u3068\u306a\u3002\n\n```\n4. Apply the following settings to postgresql.conf:\n\n   wal_level = logical\n\n   max_replication_slots = 1 # ... or add 1 to the current value.\n\n   shared_preload_libraries = 'pg_squeeze' # ... or add the library to the existing ones.\n```\n\n\u307b\u304a\u3002pg_squeeze\u306f\u30ed\u30b8\u30ab\u30eb\u30c7\u30b3\u30fc\u30c7\u30a3\u30f3\u30b0\u306e\u6a5f\u80fd\u3082\u4f7f\u3063\u3066\u3044\u308b\u3093\u3060\u306a\u3002\u3075\u3080\u3002\n\u3042\u30fb\u30fb\u30fb\u3068\u3044\u3046\u3053\u3068\u306f\u3001UNLOGGED TABLE\u306b\u5bfe\u3057\u3066\u306f\u3053\u306e\u30c4\u30fc\u30eb\u306f\u4f7f\u3048\u306a\u3044\u3063\u3066\u3053\u3068\u306a\u306e\u304b\u306a\u30fb\u30fb\u30fb\u3002\n\n\u3068\u308a\u3042\u3048\u305a\u3001postgresql.conf\u306b\u4e0a\u8a18\u306e\u3088\u3046\u306a\u8a2d\u5b9a\u3092\u3057\u3066PostgreSQL\u3092\u518d\u8d77\u52d5\u3057\u3066\u307f\u308b\u3002\n\n```\nshared_preload_libraries = 'pg_squeeze'\nsqueeze.worker_autostart = 'bench'\nsqueeze.worker_role = postgres\n\n```\n\nsqueeze.* \u306e\u30d1\u30e9\u30e1\u30fc\u30bf\u306fpg_squeeze\u5c02\u7528\u306e\u3082\u306e\u3002\u3053\u306e\u8a2d\u5b9a\u306b\u3057\u3066\u304a\u304f\u3068\u3001PostgreSQL\u30b5\u30fc\u30d0\u8d77\u52d5\u6642\u306b\u81ea\u52d5\u7684\u306bbench\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306b\u5bfe\u3059\u308bpg_squeeze\u306e\u51e6\u7406\u3092\u3057\u3066\u304f\u308c\u308b\u3082\u306e\u3063\u307d\u3044(\u305f\u3076\u3093)\u3002\n\n\n\u30b5\u30fc\u30d0\u30ed\u30b0\u3092\u898b\u308b\u3068\u3001\u3068\u304f\u306b\u3053\u306eEXTENSION\u3092\u7d44\u307f\u8fbc\u307f\u304c\u6b63\u5e38\u306b\u7d42\u4e86\u3057\u305f\u7b49\u306e\u30e1\u30c3\u30bb\u30fc\u30b8\u306f\u51fa\u3066\u3044\u306a\u3044\u3002pgaudit\u307f\u305f\u3044\u306b\u7d44\u307f\u8fbc\u3093\u3060\u3053\u3068\u304c\u5206\u304b\u308b\u30e1\u30c3\u30bb\u30fc\u30b8\u304f\u3089\u3044\u51fa\u3057\u3066\u3082\u3044\u3044\u306e\u306b\u306a\u3042\u3002\n\n# EXTENSION\u306e\u767b\u9332\npg_squeeze\u306f\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u3078\u306e\u767b\u9332\u304c\u5fc5\u8981\u3089\u3057\u3044\u3002\u4eca\u56de\u306fpgbench\u7528\u306e\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9bench\u306b\u7d44\u307f\u8fbc\u3093\u3067\u898b\u308b\u3002\n\n```\n[nuko@localhost ~]$ psql -U postgres bench\npsql (9.6.0)\nType \"help\" for help.\n\nbench=# CREATE EXTENSION pg_squeeze ;\nCREATE EXTENSION\nbench=# \n```\n\n# pg_squeeze\u7528\u306e\u8a2d\u5b9a\n\u3055\u3066\u3001\u3053\u306epg_squeeze\u3060\u304c\u3001EXTENSION\u3092\u7d44\u307f\u8fbc\u3093\u3060\u3060\u3051\u3067\u81ea\u52d5\u7684\u306b\u3088\u3057\u306a\u306b\u518d\u7de8\u6210\u30fb\u30fb\u30fb\u3068\u3044\u3046\u3053\u3068\u306f\u3057\u3066\u304f\u308c\u306a\u3044\u3002\n\u3044\u308d\u3044\u308d\u8a2d\u5b9a\u304c\u5fc5\u8981\u3063\u307d\u3044\u3002\n\n## squeeze\u30b9\u30ad\u30fc\u30de\u306e\u30c6\u30fc\u30d6\u30eb\u7fa4\npg_squeeze\u3067\u306f\u3001\u7ba1\u7406\u7528\u306b\u3044\u308d\u3093\u306a\u30c6\u30fc\u30d6\u30eb\u3092squeeze\u30b9\u30ad\u30fc\u30de\u4e0a\u306b\u4f5c\u3063\u3066\u307f\u308b\u307f\u305f\u3044\u3002\n\n```\nbench-# \\d squeeze.\nsqueeze.errors                        squeeze.tables                        squeeze.tables_tabschema_tabname_key\nsqueeze.errors_id_seq                 squeeze.tables_id_seq                 squeeze.tasks\nsqueeze.errors_pkey                   squeeze.tables_internal               squeeze.tasks_active_idx\nsqueeze.log                           squeeze.tables_internal_pkey          squeeze.tasks_id_seq\nsqueeze.log_started_idx               squeeze.tables_pkey                   squeeze.tasks_pkey\nbench-# \\d squeeze.\n```\n\npg_squeeze\u3092\u4f7f\u3046\u5834\u5408\u306b\u306f\u3001```squeeze.table```\u306b\u518d\u7de8\u6210\u51e6\u7406\u5bfe\u8c61\u306e\u30c6\u30fc\u30d6\u30eb\u3092\u767b\u9332\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u3002\u3081\u3093\u3069\u3044\u3002\n\u4eca\u56de\u306f\u3001pgbench_branches\u30c6\u30fc\u30d6\u30eb\u3092\u5bfe\u8c61\u306b\u3059\u308b\u3002\u3053\u306e\u30c6\u30fc\u30d6\u30eb\u306f\u3001fillfactor\u3092\u8a2d\u5b9a\u3057\u306a\u3044\u3068\u3001\u3059\u3050\u306b\u80a5\u5927\u5316\u3057\u305d\u3046\u3060\u304b\u3089\u3060\u3002\n(\u3082\u3063\u3068\u3082\u3001\u30ec\u30b3\u30fc\u30c9\u6570\u81ea\u4f53\u306f\u975e\u5e38\u306b\u5c11\u306a\u3044\u306e\u3067\u3001\u80a5\u5927\u5316\u3057\u305f\u3068\u3057\u3066\u3082\u3001\u305d\u308c\u307b\u3069\u5b9f\u5bb3\u306f\u306a\u3044\u3088\u3046\u306a\u6c17\u3082\u3059\u308b\u304c)\n\n\nsqueeze.table\u306f\u3053\u3093\u306a\u30c6\u30fc\u30d6\u30eb\u3060\u3002\n\n```\nbench-# \\d squeeze.tables\n                                          Table \"squeeze.tables\"\n      Column      |           Type           |                          Modifiers                          \n------------------+--------------------------+-------------------------------------------------------------\n id               | integer                  | not null default nextval('squeeze.tables_id_seq'::regclass)\n tabschema        | name                     | not null\n tabname          | name                     | not null\n clustering_index | name                     | \n rel_tablespace   | name                     | \n ind_tablespaces  | name[]                   | \n task_interval    | interval                 | not null default '01:00:00'::interval\n first_check      | timestamp with time zone | not null\n free_space_extra | integer                  | not null default 50\n min_size         | real                     | not null default 8\n vacuum_max_age   | interval                 | not null default '01:00:00'::interval\n max_retry        | integer                  | not null default 0\n skip_analyze     | boolean                  | not null default false\nIndexes:\n    \"tables_pkey\" PRIMARY KEY, btree (id)\n    \"tables_tabschema_tabname_key\" UNIQUE CONSTRAINT, btree (tabschema, tabname)\nCheck constraints:\n    \"tables_free_space_extra_check\" CHECK (free_space_extra >= 0 AND free_space_extra < 100)\n    \"tables_min_size_check\" CHECK (min_size > 0.0::double precision)\n    \"tables_task_interval_check\" CHECK (task_interval >= '00:01:00'::interval)\nReferenced by:\n    TABLE \"squeeze.tables_internal\" CONSTRAINT \"tables_internal_table_id_fkey\" FOREIGN KEY (table_id) REFERENCES squeeze.tables(id) ON DELETE CASCAD\nE\n    TABLE \"squeeze.tasks\" CONSTRAINT \"tasks_table_id_fkey\" FOREIGN KEY (table_id) REFERENCES squeeze.tables(id) ON DELETE CASCADE\nTriggers:\n    tables_internal_trig AFTER INSERT ON squeeze.tables FOR EACH ROW EXECUTE PROCEDURE squeeze.tables_internal_trig_func()\n```\n\n\u30c8\u30ea\u30ac\u304c\u8a2d\u5b9a\u3055\u308c\u3066\u3044\u308b\u3002squeeze\u51e6\u7406\u5bfe\u8c61\u306e\u30c6\u30fc\u30d6\u30eb\u3092\u3053\u3053\u306b\u767b\u9332\u3059\u308b\u3068\u3001\u4ed6\u306e\u7ba1\u7406\u7528\u306e\u30c6\u30fc\u30d6\u30eb\u306b\u3082\u4f55\u304b\u3057\u3089\u306e\u8a2d\u5b9a\u3092\u4f1d\u64ad\u3059\u308b\u306e\u3060\u308d\u3046\u3002\n\n\u3068\u308a\u3042\u3048\u305a\u8a2d\u5b9a\u3057\u3066\u307f\u308b\u3002\n\n```\nbench=# INSERT INTO squeeze.tables (tabschema, tabname, first_check, task_interval, min_size) \nVALUES ('public','pgbench_branches',now(),'1 min', 0.1);\nINSERT 0 1\nbench=# INSERT INTO squeeze.tables (tabschema, tabname, first_check, task_interval, min_size) \nVALUES ('public','pgbench_tellers',now(),'1 min', 0.1);\nINSERT 0 1\nbench=# \n```\n\n\u3068\u308a\u3042\u3048\u305aINSERT\u306f\u3055\u308c\u305f\u3002\u305f\u3076\u3093\u3001\u3053\u3046\u3044\u3046\u8a2d\u5b9a\u3002\n\n* \u30bf\u30fc\u30b2\u30c3\u30c8\u306fpublic.pgbench_accounts\u3068public.pgbench_tellers\n* \u6700\u521d\u306esqueeze\u51e6\u7406\u306e\u305f\u3081\u306e\u30c1\u30a7\u30c3\u30af\u306fINSERT\u6587\u5b9f\u884c\u6642\n* 1\u5206\u6bce\u306b\u30c1\u30a7\u30c3\u30af(\u30c7\u30d5\u30a9\u30eb\u30c8\u306f1\u6642\u9593\u307d\u3044)\n* \u80a5\u5927\u5316\u3057\u305f\u304b\u3069\u3046\u304b\u306e\u95be\u5024(?)\u306f 0.1 MB\n\n# pgbench\u306b\u3088\u308b\u52d5\u4f5c\u78ba\u8a8d\n## \u6e2c\u5b9a\u74b0\u5883\n\u4eca\u56de\u306fScale Factor = 10\u306e\u72b6\u614b\u3067pgbench\u74b0\u5883\u3092\u521d\u671f\u751f\u6210\u3057\u305f\u3002\n\n```\n[nuko@localhost ~]$ pgbench -i -s 10 -U postgres bench \ncreating tables...\n100000 of 1000000 tuples (10%) done (elapsed 0.15 s, remaining 1.38 s)\n200000 of 1000000 tuples (20%) done (elapsed 0.42 s, remaining 1.68 s)\n300000 of 1000000 tuples (30%) done (elapsed 0.70 s, remaining 1.63 s)\n400000 of 1000000 tuples (40%) done (elapsed 0.83 s, remaining 1.25 s)\n500000 of 1000000 tuples (50%) done (elapsed 1.04 s, remaining 1.04 s)\n600000 of 1000000 tuples (60%) done (elapsed 1.27 s, remaining 0.85 s)\n700000 of 1000000 tuples (70%) done (elapsed 1.44 s, remaining 0.62 s)\n800000 of 1000000 tuples (80%) done (elapsed 1.65 s, remaining 0.41 s)\n900000 of 1000000 tuples (90%) done (elapsed 1.86 s, remaining 0.21 s)\n1000000 of 1000000 tuples (100%) done (elapsed 2.88 s, remaining 0.00 s)\nvacuum...\nset primary keys...\ndone.\n[nuko@localhost ~]$\n```\n\npgbench\u3092\u30c7\u30d5\u30a9\u30eb\u30c8\u30c8\u30e9\u30f3\u30b6\u30af\u30b7\u30e7\u30f3\u3067\u52d5\u304b\u3059\u3068\u3001pgbench_accounts, pgbench_branches, pgbench_tellers\u306b\u5bfe\u3057\u3066UPDATE\u6587\u304c\u767a\u884c\u3055\u308c\u308b\u3002\n\u73fe\u72b6\u306f\u3042\u3048\u3066fillfactor\u3092100\u306b\u3057\u3066\u3044\u308b\u306e\u3067\u3001\u3069\u306e\u30c6\u30fc\u30d6\u30eb\u3082HOT\u66f4\u65b0\u304c\u3055\u308c\u306b\u304f\u304f\u3001\u80a5\u5927\u5316\u3057\u3084\u3059\u3044\u306f\u305a\u3002\n\n```\nbench=# \\d+ pgbench_accounts\n                       Table \"public.pgbench_accounts\"\n  Column  |     Type      | Modifiers | Storage  | Stats target | Description \n----------+---------------+-----------+----------+--------------+-------------\n aid      | integer       | not null  | plain    |              | \n bid      | integer       |           | plain    |              | \n abalance | integer       |           | plain    |              | \n filler   | character(84) |           | extended |              | \nIndexes:\n    \"pgbench_accounts_pkey\" PRIMARY KEY, btree (aid)\nOptions: fillfactor=100\n```\n\nscale factor\u309210\u306b\u3057\u3066\u52d5\u304b\u3057\u3066\u3044\u308b\u306e\u3067\u3001pgbench_branches\u306e\u521d\u671f\u4ef6\u6570\u306f10\u4ef6\u3002\u30ea\u30ec\u30fc\u30b7\u30e7\u30f3\u30b5\u30a4\u30ba\u306f8192\u30d0\u30a4\u30c8(1\u30da\u30fc\u30b8)\u3002pgbench_tellers\u306e\u521d\u671f\u4ef6\u6570\u306f100\u4ef6\u3001\u30ea\u30ec\u30fc\u30b7\u30e7\u30f3\u30b5\u30a4\u30ba\u306f2\u30da\u30fc\u30b8\u3002\n\u3053\u306e\u72b6\u614b\u3067pg_squeeze\u3092\u7121\u52b9\u5316/\u6709\u52b9\u5316\u3057\u306610\u4e07\u30c8\u30e9\u30f3\u30b6\u30af\u30b7\u30e7\u30f3\u5b9f\u884c\u3057\u3066\u307f\u308b\u3002\n\n```\n[nuko@localhost ~]$ pgbench -U postgres bench -c 4 -t 25000\nstarting vacuum...end.\ntransaction type: <builtin: TPC-B (sort of)>\nscaling factor: 10\nquery mode: simple\nnumber of clients: 4\nnumber of threads: 1\nnumber of transactions per client: 25000\nnumber of transactions actually processed: 100000/100000\nlatency average = 3.371 ms\ntps = 1186.728938 (including connections establishing)\ntps = 1186.921844 (excluding connections establishing)\n[nuko@localhost ~]$\n```\n\n## pgbench\u5b9f\u884c\u524d/\u5b9f\u884c\u5f8c\u306e\u30ea\u30ec\u30fc\u30b7\u30e7\u30f3\u30b5\u30a4\u30ba\n10\u4e07\u56depgbench\u306e\u30c7\u30d5\u30a9\u30eb\u30c8\u30c8\u30e9\u30f3\u30b6\u30af\u30b7\u30e7\u30f3\u5b9f\u884c\u5f8c\u306e\u30c6\u30fc\u30d6\u30eb\u30b5\u30a4\u30ba\u3092pg_relation_size()\u306e\u5024\u3067\u6bd4\u8f03\u3057\u3066\u307f\u305f(\u30b5\u30a4\u30ba\u306fbyte)\u3002\n\n|\u8a2d\u5b9a  |\u521d\u671f\u30b5\u30a4\u30ba |pg_squeeze\u306a\u3057 |pg_squeeze\u3042\u308a|\n|:--|--:|--:|--:|\n|pgbench_tellers  |16384     |204800               |49152|\n|pgbench_branches |8192      |65536                |16384|\n\n![20161104-pg_squeeze.png](https://qiita-image-store.s3.amazonaws.com/0/32626/1e9f8d26-a223-413b-6a9d-20015a51912c.png)\n\n\n\u304a\u3001\u3069\u3061\u3089\u306e\u30c6\u30fc\u30d6\u30eb\u308225%\u7a0b\u5ea6\u306e\u30b5\u30a4\u30ba\u306b\u7e2e\u5c0f\u3055\u308c\u3066\u307e\u3059\u306d\u3002\n\n# \u304a\u308f\u308a\u306b\n\u307e\u3060\u03b2\u30d0\u30fc\u30b8\u30e7\u30f3\u306a\u306e\u3067\u3001\u4f7f\u3044\u5012\u3059\u3068\u3044\u308d\u3044\u308d\u30c8\u30e9\u30d6\u30eb\u3082\u3042\u308b\u304b\u3082\u3057\u308c\u306a\u3044\u304c(\u4f8b\u3048\u3070\u3001\u518d\u5ea6CREATE EXTENSION\u3059\u308b\u3068\u304d\u306b\u30d0\u30c3\u30af\u30a8\u30f3\u30c9\u7570\u5e38\u304c\u8d77\u304d\u305f\u308a\u3082\u3057\u305f)\u3001\u30c6\u30fc\u30d6\u30eb\u304c\u80a5\u5927\u5316\u3057\u304c\u3061\u306a\u6848\u4ef6\u3067\u3042\u308c\u3070\u3001\u8a66\u3057\u306b\u4f7f\u3063\u3066\u307f\u308b\u306e\u3082\u3042\u308a\u304b\u306a\u3001\u3068\u3044\u3046\u5370\u8c61\u306f\u3082\u3063\u305f\u3002\n\u3042\u3068\u306f\u3001\u518d\u7de8\u6210\u4e2d\u306b\u3069\u306e\u304f\u3089\u3044\u6027\u80fd\u306b\u5f71\u97ff\u304c\u3067\u308b\u304b\u3001\u3069\u3053\u304b\u3067\u6e2c\u5b9a\u3057\u3066\u304a\u304d\u305f\u3044\u3082\u306e\u3002\n\n\n"}