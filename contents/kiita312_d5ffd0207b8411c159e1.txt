{"tags": ["google", "GoogleAppsScript"], "context": " \u3053\u306e\u8a18\u4e8b\u306f\u6700\u7d42\u66f4\u65b0\u65e5\u304b\u30891\u5e74\u4ee5\u4e0a\u304c\u7d4c\u904e\u3057\u3066\u3044\u307e\u3059\u3002\n\n\u306f\u3058\u3081\u306b\nSearchConsole\u306e\u30c7\u30fc\u30bf\u304b\u3089\u65e5\u4ed8\u00d7URL\u3068\u3044\u3046\u8868\u304c\u4f5c\u308a\u305f\u304b\u3063\u305f\u306e\u3067\u3001Google SpreadSheet\u4e0a\u3067AppsScript\u3067\u4f5c\u308c\u3070\u30b5\u30fc\u30d0\u30fc\u3082\u3044\u3089\u306a\u3044\u3057\u3001\u3044\u3044\u3058\u3083\u306a\u3044\u304b\u3068\u601d\u3063\u3066\u4f5c\u3063\u3066\u307f\u307e\u3057\u305f\u3002\n\n\u6ce8\u610f\u4e8b\u9805\nSpreadSheet\u3092\u4f7f\u3046\u4e0a\u3067\u5236\u9650\u304c\u3042\u308a\u307e\u3059\u3002\n\n200\u4e07\u30bb\u30eb\u304c\u6700\u5927\n\u30c9\u30e9\u30a4\u30d6 \u30d8\u30eb\u30d7\n\u3042\u307e\u308a\u9577\u671f\u9593\u306e\u30c7\u30fc\u30bf\u3092\u629c\u3053\u3046\u3068\u3059\u308b\u3068\u3001\u66f8\u304d\u8fbc\u3081\u306a\u304f\u306a\u308a\u307e\u3059\u3002\nSpreadsheets\u4f5c\u6210 1\u65e5250\u56de\nURL Fetch(http\u30a2\u30af\u30bb\u30b9)\u30001\u65e52\u4e07\u56de\nURL Fetch(http\u30a2\u30af\u30bb\u30b9)\u30001\u65e550MB\n\nQuotas for Google Services\n\u958b\u767a\u4e2d\u306b\u304c\u3093\u304c\u3093\u8a66\u3057\u3066\u3044\u305f\u308950MB\u306b\u3072\u3063\u304b\u304b\u308a\u307e\u3057\u305f\u3002\n\n\u30a2\u30ab\u30a6\u30f3\u30c8\u6e96\u5099\nSearchConsole\u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u305f\u3081\u306b\u8a8d\u8a3c\u304c\u5fc5\u8981\u306b\u306a\u308b\u306e\u3067\u3001\u30a2\u30ab\u30a6\u30f3\u30c8\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\u307e\u305fOAuth\u8a8d\u8a3c\u7528\u306e\u306e\u30e9\u30a4\u30d6\u30e9\u30ea\u3082\u4f7f\u7528\u3057\u307e\u3059\u3002\napps-script-oauth2\nGoogle Developers Console\u304b\u3089OAuth\u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u30af\u30e9\u30a4\u30a2\u30f3\u30c8ID\u3092\u767a\u884c\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n* \u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u3092\u4f5c\u6210\n* API\u3068\u8a8d\u8a3c > \u8a8d\u8a3c\u60c5\u5831 > \u8a8d\u8a3c\u60c5\u5831\u3092\u8ffd\u52a0 > OAuth 2.0 \u30af\u30e9\u30a4\u30a2\u30f3\u30c8 ID\n* - \u30a6\u30a7\u30d6\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3092\u9078\u629e\n* - \u8a8d\u8a3c\u6e08\u307f\u306e\u30ea\u30c0\u30a4\u30ec\u30af\u30c8URI\u306b\u4ee5\u4e0b\u3092\u8a2d\u5b9a\n* https://script.google.com/macros/d/{PROJECT_KEY}/usercallback\n{PROJECT_KEY}\u306b\u306f\u30b9\u30d7\u30ec\u30c3\u30c9\u30b7\u30fc\u30c8\u306e\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u30ad\u30fc\u3092\u5165\u308c\u3066\u304f\u3060\u3055\u3044\u3002\n* \u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u30ad\u30fc\u306f\u30b9\u30af\u30ea\u30d7\u30c8\u30a8\u30c7\u30a3\u30bf\u30fc\u306e\u30e1\u30cb\u30e5\u30fc\u304b\u3089\u78ba\u8a8d\u3067\u304d\u307e\u3059\u3002\n\u30d5\u30a1\u30a4\u30eb > \u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u306e\u30d7\u30ed\u30d1\u30c6\u30a3 > \u60c5\u5831 > \u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u30ad\u30fc\n\n\u8a8d\u8a3c\nvar CLIENT_ID = 'YOUR_ID';\nvar CLIENT_SECRET = 'YOUR_SECRET';\n\n// \u8a8d\u8a3c\u306e\u30a8\u30f3\u30c9\u30dd\u30a4\u30f3\u30c8\u3068\u306a\u308b\u30c0\u30a4\u30a2\u30ed\u30b0\u3092\u8868\u793a\u3057\u307e\u3059\u3002\nfunction alertAuth() {\n  var service = getService();\n  var authorizationUrl = service.getAuthorizationUrl();\n  var template = HtmlService.createTemplate(\n    '<a href=\"<?= authorizationUrl ?>\" target=\"_blank\">\u8a8d\u8a3c</a>. ' +\n    '\u8a8d\u8a3c\u304c\u5b8c\u4e86\u3057\u305f\u3089\u518d\u5ea6\u64cd\u4f5c\u3092\u884c\u3063\u3066\u304f\u3060\u3055\u3044\u3002');\n  template.authorizationUrl = authorizationUrl;\n  var page = template.evaluate();\n\n  SpreadsheetApp.getUi().showModalDialog(page, \"\u8a8d\u8a3c\u304c\u5fc5\u8981\u3067\u3059\");\n  Logger.log(\"\u8a8d\u8a3c\u304c\u5207\u308c\u3066\u3044\u307e\u3059\");\n}\n\n// SearchConsole API\u306e\u30b5\u30fc\u30d3\u30b9\u3092\u53d6\u5f97\nfunction getService() {\n  // Create a new service with the given name. The name will be used when\n  // persisting the authorized token, so ensure it is unique within the\n  // scope of the property store.\n  return OAuth2.createService('webmasters')\n\n      // Set the endpoint URLs, which are the same for all Google services.\n      .setAuthorizationBaseUrl('https://accounts.google.com/o/oauth2/auth')\n      .setTokenUrl('https://accounts.google.com/o/oauth2/token')\n\n      // Set the client ID and secret, from the Google Developers Console.\n      .setClientId(CLIENT_ID)\n      .setClientSecret(CLIENT_SECRET)\n\n      // Set the name of the callback function in the script referenced\n      // above that should be invoked to complete the OAuth flow.\n      .setCallbackFunction('authCallback')\n\n      // Set the property store where authorized tokens should be persisted.\n      .setPropertyStore(PropertiesService.getUserProperties())\n\n      // Set the scopes to request (space-separated for Google services).\n      .setScope('https://www.googleapis.com/auth/webmasters.readonly')\n}\n\n//\u8a8d\u8a3c\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\nfunction authCallback(request) {\n  var service = getService();\n  var isAuthorized = service.handleCallback(request);\n  if (isAuthorized) {\n    return HtmlService.createHtmlOutput('\u8a8d\u8a3c\u306b\u6210\u529f\u3057\u307e\u3057\u305f\u3002\u30bf\u30d6\u3092\u9589\u3058\u3066\u304f\u3060\u3055\u3044\u3002');\n  } else {\n    return HtmlService.createHtmlOutput('\u8a8d\u8a3c\u306b\u5931\u6557\u3057\u307e\u3057\u305f\u3002\u30bf\u30d6\u3092\u9589\u3058\u3066\u304f\u3060\u3055\u3044\u3002');\n  }\n}\n\nalert()\u3092\u547c\u3073\u51fa\u3057\u305f\u3089\u30dd\u30c3\u30d7\u30a2\u30c3\u30d7\u304c\u8868\u793a\u3055\u308c\u3066\u3001\u8a8d\u8a3c\u306e\u30ea\u30f3\u30af\u3092\u62bc\u3059\u3068Oauth\u306e\u753b\u9762\u306b\u9077\u79fb\u3059\u308b\u4ed5\u7d44\u307f\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002\nOauth\u3078\u306eURL\u3078\u30b3\u30fc\u30c9\u4e0a\u3067\u30ea\u30c0\u30a4\u30ec\u30af\u30c8\u3055\u305b\u308b\u3053\u3068\u304c\u3067\u304d\u306a\u3044\u3088\u3046\u306a\u306e\u3067\u3001\u30ea\u30f3\u30af\u3067\u98db\u3070\u3059\u3088\u3046\u306b\u3057\u3066\u3044\u307e\u3059\u3002\n\nSearchConsole\u3078\u306e\u30ea\u30af\u30a8\u30b9\u30c8\nvar SITE_URL = 'https%3A%2F%2Fmatome.miil.me'\n\n/* SearchConsole\u304b\u3089\u30c7\u30fc\u30bf\u3092\u53d6\u5f97\n* @param date Date \u65e5\u4ed8\n* @param unscope_url Array \u9664\u5916\u3059\u308bURL\u306e\u30ea\u30b9\u30c8\n* @return Hash \u30ec\u30b9\u30dd\u30f3\u30b9\n*/\nfunction importData(date, unscope_url){\n  // \u6761\u4ef6\u6307\u5b9a\n  // \u8aad\u307f\u8fbc\u307f\u6e08\u307f\u306eURL\u3092\u9664\u5916\n  for(var i=0; i<unscope_url.length; i++){\n    filters.push({\n      dimension: \"page\",\n      operator: \"notEquals\",\n      expression: unscope_url[i]\n    })\n  }\n\n  var params = {\n    rowLimit: PER_RECORD,\n    startDate: date.toISOString().substring(0, 10),\n    endDate: date.toISOString().substring(0, 10),\n    dimensions: [\"page\"],\n    dimensionFilterGroups:[\n      {\n        filters: filters\n      },\n    ],\n  }\n\n  return query(params);\n}\n\n/* SearchConsole\u3078\u30af\u30a8\u30ea\u554f\u3044\u5408\u308f\u305b\n*/\nfunction query(params) {\n  var service = getService();\n  var response = UrlFetchApp.fetch('https://www.googleapis.com/webmasters/v3/sites/'+ SITE_URL +'/searchAnalytics/query', {\n    method : \"post\",\n    contentType: \"application/json\",   \n    headers: {\n      Authorization: 'Bearer ' + service.getAccessToken(),\n    },\n    payload:JSON.stringify(params),\n  });\n  return response;\n}\n\nimportData\u3092\u547c\u3073\u51fa\u3059\u3068\u30c7\u30fc\u30bf\u304c\u3068\u308c\u308b\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002\n\u9664\u5916\u306eURL\u30ea\u30b9\u30c8\u3092\u6e21\u3059\u306e\u306f\u3001SearchConsole\u306eAPI\u304c5,000\u4ef6\u307e\u3067\u3057\u304b\uff11\u5ea6\u306b\u3068\u308c\u306a\u3044\u306e\u3068\u3001\u30da\u30fc\u30b8\u30cd\u30fc\u30b7\u30e7\u30f3\u304c\u884c\u3048\u306a\u3044\u306e\u3067\u4ed5\u65b9\u306a\u304f\u4e00\u5ea6\u53d6\u5f97\u3057\u305fURL\u306f\u6b21\u306f\u53d6\u3089\u306a\u3044\u3088\u3046\u306b\u30d5\u30a3\u30eb\u30bf\u30fc\u3068\u3057\u3066\u6e21\u3059\u305f\u3081\u3067\u3059\u3002\n\n\u30b7\u30fc\u30c8\u3078\u306e\u66f8\u304d\u8fbc\u307f\n//  \u65e5\u4ed8\u306e\u671f\u9593\nvar DATE_RANGE = 7;\n\n/*\n* \u5168\u30b7\u30fc\u30c8\u3092\u66f4\u65b0\n* \u6628\u65e5\u304b\u3089\u6570\u65e5\u5206\u306e\u30b7\u30fc\u30c8\u3092\u518d\u4f5c\u6210\u3059\u308b\n*/\nfunction updateSheets(){\n  var service = getService();  \n  if(!service.hasAccess()){\n    alertAuth();\n    return;\n  }\n  var date = new Date();\n  date.setDate(date.getDate() - 2);\n  create_records_sheet(date,DATE_RANGE);\n}\n\n/* \u6307\u5b9a\u671f\u9593\u306e\u30ec\u30b3\u30fc\u30c9\u306e\u30b7\u30fc\u30c8\u3092\u4f5c\u6210\u3059\u308b\n* \uff20@param Date \u53d6\u5f97\u5bfe\u8c61\u306e\u65e5\u4ed8\n* @param Int \u53d6\u5f97\u904e\u53bb\u65e5\u6570\n*/\nfunction create_records_sheet(date, dateRange){\n  sheet = getSheet(\"\u30ec\u30b3\u30fc\u30c9\");\n  sheet.clear();\n  set_record_format(sheet);\n\n  date.setDate(date.getDate() - dateRange);\n  var rowIndex = 2;\n  for(var i=0; i < dateRange; i++){\n    rowIndex = add_records(date, sheet, rowIndex);\n    date.setDate(date.getDate() + 1);\n  }\n  sheet.autoResizeColumn(2);\n}\n\n// \u30ec\u30b3\u30fc\u30c9\u8a18\u8f09\u7528\u306e\u30b7\u30fc\u30c8\u306e\u30d5\u30a9\u30fc\u30de\u30c3\u30c8\u3092\u8a2d\u5b9a\u3059\u308b\nfunction set_record_format(sheet){\n  ranges = sheet.getRange(1,1,1,6)\n  ranges.setValues([[\"\u65e5\u4ed8\",\"URL\",\"\u30af\u30ea\u30c3\u30af\u6570\",\"\u8868\u793a\u56de\u6570\",\"CTR\",\"\u63b2\u8f09\u9806\u4f4d\"]])\n}\n\n/* \u6307\u5b9a\u3057\u305f\u65e5\u4ed8\u306e\u30c7\u30fc\u30bf\u3092\u6307\u5b9a\u306e\u30b7\u30fc\u30c8\u306b\u8ffd\u8a18\u3059\u308b\n* @param date \u30c7\u30fc\u30bf\u53d6\u5f97\u5bfe\u8c61\u65e5\n* @param sheet \u8ffd\u52a0\u5148\u306e\u30b7\u30fc\u30c8\n* @param row \u633f\u5165\u958b\u59cb\u884c\u756a\u53f7\n*/\nfunction add_records(date,sheet,rowIndex){\n  var unscope_url = [];\n  //\u4e00\u5ea6\u306b\u8aad\u307f\u8fbc\u3081\u308b\u4ef6\u6570\u306b\u5236\u9650\u304c\u3042\u308b(\u30da\u30fc\u30b8\u30f3\u30b0\u5236\u5fa1\u3082\u306a\u3044)\u306e\u3067\u3001\u30eb\u30fc\u30d7\u3057\u3066\u5168\u4ef6\u5206\u3092\u884c\u3046\n  for(var count=0; count < 3; count++){ //\u7121\u9650\u30eb\u30fc\u30d7\u3067\u3082\u3044\u3044\u3051\u3069\u3001\u5ff5\u306e\u70ba100\u56de\u304f\u3089\u3044\u3067\u6b62\u3081\u3066\u304a\u304f\n    // \u30c7\u30fc\u30bf\u3092\u53d6\u5f97\n    var data = JSON.parse(importData(date,unscope_url));\n\n    // SpreadSheet\u306b\u7a81\u3063\u8fbc\u3080\u305f\u3081\u306b\u6574\u5f62\n    var records = modify_records(data,date);\n    if(records.length == 0){\n      break; //\u8aad\u8fbc\u7d42\u4e86\u3057\u3066\u308b\u306e\u3067\u306c\u3051\u308b\n    }\n\n    //\u53d6\u5f97\u3057\u305fURL\u306f\u8aad\u307f\u8fbc\u307f\u6e08\u307f\u306e\u30ea\u30b9\u30c8\u3078\u8ffd\u52a0\n    for(var i = 0; i < records.length; i++){\n      unscope_url.push(records[i][1]);\n    }\n\n    // SpreadSheet\u3078\u66f8\u304d\u8fbc\u307f\n    writeSheet(sheet,records, rowIndex);\n    rowIndex += records.length;\n  }\n  return rowIndex;\n}\n\n//  SearchConsole\u306e\u7d50\u679c\u3092SpreadSheet\u306b\u7a81\u3063\u8fbc\u3080\u305f\u3081\u306b\u6574\u5f62\nfunction modify_records(data,date){\n  var records = [];\n  var date_str = date.toISOString().substring(0, 10);\n  if(data[\"rows\"] != undefined){\n    for (var i = 0; i < data[\"rows\"].length; i++){\n      record = data[\"rows\"][i]\n      records.push([date_str,record[\"keys\"][0],record[\"clicks\"],record[\"impressions\"],record['ctr'],record['position']]);\n    }\n  }\n  return records;  \n}\n\n/*\n* \u30c7\u30fc\u30bf\u3092\u30b7\u30fc\u30c8\u306b\u51fa\u529b\u3059\u308b\n* @param sheet, \u66f8\u304d\u8fbc\u3080\u5148\u306e\u30b7\u30fc\u30c8\n* @param records \u66f8\u304d\u8fbc\u3080\u30ec\u30b3\u30fc\u30c9 2\u6b21\u5143\u914d\u5217\u3092\u308f\u305f\u3059\n* @param row \u66f8\u304d\u8fbc\u307f\u958b\u59cb\u3059\u308b\u884c\u756a\u53f7\n*/\nfunction writeSheet(sheet,records,row){  \n  ranges = sheet.getRange(row,1,records.length,6)\n  ranges.setValues(records)\n}\n\n// \u30b7\u30fc\u30c8\u3092\u53d6\u5f97\n// \u540c\u3058\u30b7\u30fc\u30c8\u540d\u304c\u3042\u308c\u3070\u65e2\u5b58\u306e\u30b7\u30fc\u30c8\u3092\u8fd4\u3059\n// \u540c\u3058\u30b7\u30fc\u30c8\u540d\u304c\u306a\u3051\u308c\u3070\u65b0\u3057\u304f\u4f5c\u6210\u3059\u308b\nfunction getSheet(sheetName){\n  var spreadsheet = SpreadsheetApp.getActive();\n  var sheet = spreadsheet.getSheetByName(sheetName);\n  if (sheet == null) {\n    sheet = spreadsheet.insertSheet(sheetName);\n  }\n  return sheet;\n}\n\nupdateSheet\u3092\u547c\u3073\u51fa\u305b\u3070\u6570\u65e5\u5206\u306e\u30c7\u30fc\u30bf\u304c\u65e5\u3054\u3068\u306b\"\u30ec\u30b3\u30fc\u30c9\"\u306e\u30b7\u30fc\u30c8\u306b\u66f8\u304d\u8fbc\u307e\u308c\u307e\u3059\u3002\n\u3042\u3068\u306f\u305d\u306e\u30b7\u30fc\u30c8\u304b\u3089\u30d4\u30dc\u30c3\u30c8\u30c6\u30fc\u30d6\u30eb\u3092\u4f5c\u308c\u3070\u65e5\u4ed8\u00d7URL\u306e\u8868\u304c\u3064\u304f\u308c\u307e\u3059\u3002\n\u6700\u5f8c\u306b\u4f7f\u3044\u3084\u3059\u3044\u3088\u3046\u306b\u66f4\u65b0\u306e\u30b3\u30de\u30f3\u30c9\u3092\u30e1\u30cb\u30e5\u30fc\u306b\u8ffd\u52a0\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n//\u30b7\u30fc\u30c8\u958b\u59cb\u6642\u306e\u51e6\u7406\nfunction onOpen() {\n  // \u66f4\u65b0\u7528\u306e\u30e1\u30cb\u30e5\u30fc\u3092\u8ffd\u52a0\n  SpreadsheetApp.getUi()\n      .createMenu('SearchConsole')\n      .addItem('\u6700\u65b0\u306e\u60c5\u5831\u3092\u53d6\u5f97', 'updateSheets')\n      .addToUi();\n}\n\n\n\n\u7d42\u308f\u308a\u306b\n\u4f5c\u3063\u3066\u307f\u3066\u3001SearchConsole\u306e\u30c7\u30fc\u30bf\u306f\u8868\u793a\u56de\u6570\u304c0\u306a\u3089\u3070\u30c7\u30fc\u30bf\u304c\u5165\u3063\u3066\u3053\u306a\u3044\u3067\u3059\u3002\n\u305d\u308c\u3068\u30af\u30a8\u30ea\u3082\u6307\u5b9a\u3057\u306a\u3044\u3068\u4f55\u3067\u8868\u793a\u3055\u308c\u305f\u63b2\u8f09\u9806\u4f4d\u304b\u3082\u308f\u304b\u3089\u306a\u3044\u3001\u3068\u3044\u3046\u306e\u304c\u8f9b\u3044\u3068\u3053\u308d\n\n## \u306f\u3058\u3081\u306b\nSearchConsole\u306e\u30c7\u30fc\u30bf\u304b\u3089\u65e5\u4ed8\u00d7URL\u3068\u3044\u3046\u8868\u304c\u4f5c\u308a\u305f\u304b\u3063\u305f\u306e\u3067\u3001Google SpreadSheet\u4e0a\u3067AppsScript\u3067\u4f5c\u308c\u3070\u30b5\u30fc\u30d0\u30fc\u3082\u3044\u3089\u306a\u3044\u3057\u3001\u3044\u3044\u3058\u3083\u306a\u3044\u304b\u3068\u601d\u3063\u3066\u4f5c\u3063\u3066\u307f\u307e\u3057\u305f\u3002\n\n## \u6ce8\u610f\u4e8b\u9805\nSpreadSheet\u3092\u4f7f\u3046\u4e0a\u3067\u5236\u9650\u304c\u3042\u308a\u307e\u3059\u3002\n\n -  200\u4e07\u30bb\u30eb\u304c\u6700\u5927\n[\u30c9\u30e9\u30a4\u30d6 \u30d8\u30eb\u30d7](https://support.google.com/drive/answer/37603?hl=ja)\n\u3042\u307e\u308a\u9577\u671f\u9593\u306e\u30c7\u30fc\u30bf\u3092\u629c\u3053\u3046\u3068\u3059\u308b\u3068\u3001\u66f8\u304d\u8fbc\u3081\u306a\u304f\u306a\u308a\u307e\u3059\u3002\n\n - Spreadsheets\u4f5c\u6210 1\u65e5250\u56de\n - URL Fetch(http\u30a2\u30af\u30bb\u30b9)\u30001\u65e52\u4e07\u56de\n - URL Fetch(http\u30a2\u30af\u30bb\u30b9)\u30001\u65e550MB\n\n[Quotas for Google Services](https://developers.google.com/apps-script/guides/services/quotas)\n\u958b\u767a\u4e2d\u306b\u304c\u3093\u304c\u3093\u8a66\u3057\u3066\u3044\u305f\u308950MB\u306b\u3072\u3063\u304b\u304b\u308a\u307e\u3057\u305f\u3002\n\n## \u30a2\u30ab\u30a6\u30f3\u30c8\u6e96\u5099\nSearchConsole\u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u305f\u3081\u306b\u8a8d\u8a3c\u304c\u5fc5\u8981\u306b\u306a\u308b\u306e\u3067\u3001\u30a2\u30ab\u30a6\u30f3\u30c8\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\u307e\u305fOAuth\u8a8d\u8a3c\u7528\u306e\u306e\u30e9\u30a4\u30d6\u30e9\u30ea\u3082\u4f7f\u7528\u3057\u307e\u3059\u3002\n[apps-script-oauth2](https://github.com/googlesamples/apps-script-oauth2)\n\n[Google Developers Console](https://console.developers.google.com/project?pli=1)\u304b\u3089OAuth\u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u30af\u30e9\u30a4\u30a2\u30f3\u30c8ID\u3092\u767a\u884c\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n* \u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u3092\u4f5c\u6210\n* API\u3068\u8a8d\u8a3c > \u8a8d\u8a3c\u60c5\u5831 > \u8a8d\u8a3c\u60c5\u5831\u3092\u8ffd\u52a0 > OAuth 2.0 \u30af\u30e9\u30a4\u30a2\u30f3\u30c8 ID\n* - \u30a6\u30a7\u30d6\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3092\u9078\u629e\n* - \u8a8d\u8a3c\u6e08\u307f\u306e\u30ea\u30c0\u30a4\u30ec\u30af\u30c8URI\u306b\u4ee5\u4e0b\u3092\u8a2d\u5b9a\n* https://script.google.com/macros/d/{PROJECT_KEY}/usercallback\n{PROJECT_KEY}\u306b\u306f\u30b9\u30d7\u30ec\u30c3\u30c9\u30b7\u30fc\u30c8\u306e\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u30ad\u30fc\u3092\u5165\u308c\u3066\u304f\u3060\u3055\u3044\u3002\n* \u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u30ad\u30fc\u306f\u30b9\u30af\u30ea\u30d7\u30c8\u30a8\u30c7\u30a3\u30bf\u30fc\u306e\u30e1\u30cb\u30e5\u30fc\u304b\u3089\u78ba\u8a8d\u3067\u304d\u307e\u3059\u3002\n\u30d5\u30a1\u30a4\u30eb > \u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u306e\u30d7\u30ed\u30d1\u30c6\u30a3 > \u60c5\u5831 > \u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u30ad\u30fc\n\n## \u8a8d\u8a3c\n```javascript\nvar CLIENT_ID = 'YOUR_ID';\nvar CLIENT_SECRET = 'YOUR_SECRET';\n\n// \u8a8d\u8a3c\u306e\u30a8\u30f3\u30c9\u30dd\u30a4\u30f3\u30c8\u3068\u306a\u308b\u30c0\u30a4\u30a2\u30ed\u30b0\u3092\u8868\u793a\u3057\u307e\u3059\u3002\nfunction alertAuth() {\n  var service = getService();\n  var authorizationUrl = service.getAuthorizationUrl();\n  var template = HtmlService.createTemplate(\n    '<a href=\"<?= authorizationUrl ?>\" target=\"_blank\">\u8a8d\u8a3c</a>. ' +\n    '\u8a8d\u8a3c\u304c\u5b8c\u4e86\u3057\u305f\u3089\u518d\u5ea6\u64cd\u4f5c\u3092\u884c\u3063\u3066\u304f\u3060\u3055\u3044\u3002');\n  template.authorizationUrl = authorizationUrl;\n  var page = template.evaluate();\n  \n  SpreadsheetApp.getUi().showModalDialog(page, \"\u8a8d\u8a3c\u304c\u5fc5\u8981\u3067\u3059\");\n  Logger.log(\"\u8a8d\u8a3c\u304c\u5207\u308c\u3066\u3044\u307e\u3059\");\n}\n\n// SearchConsole API\u306e\u30b5\u30fc\u30d3\u30b9\u3092\u53d6\u5f97\nfunction getService() {\n  // Create a new service with the given name. The name will be used when\n  // persisting the authorized token, so ensure it is unique within the\n  // scope of the property store.\n  return OAuth2.createService('webmasters')\n\n      // Set the endpoint URLs, which are the same for all Google services.\n      .setAuthorizationBaseUrl('https://accounts.google.com/o/oauth2/auth')\n      .setTokenUrl('https://accounts.google.com/o/oauth2/token')\n\n      // Set the client ID and secret, from the Google Developers Console.\n      .setClientId(CLIENT_ID)\n      .setClientSecret(CLIENT_SECRET)\n\n      // Set the name of the callback function in the script referenced\n      // above that should be invoked to complete the OAuth flow.\n      .setCallbackFunction('authCallback')\n\n      // Set the property store where authorized tokens should be persisted.\n      .setPropertyStore(PropertiesService.getUserProperties())\n\n      // Set the scopes to request (space-separated for Google services).\n      .setScope('https://www.googleapis.com/auth/webmasters.readonly')\n}\n\n//\u8a8d\u8a3c\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\nfunction authCallback(request) {\n  var service = getService();\n  var isAuthorized = service.handleCallback(request);\n  if (isAuthorized) {\n    return HtmlService.createHtmlOutput('\u8a8d\u8a3c\u306b\u6210\u529f\u3057\u307e\u3057\u305f\u3002\u30bf\u30d6\u3092\u9589\u3058\u3066\u304f\u3060\u3055\u3044\u3002');\n  } else {\n    return HtmlService.createHtmlOutput('\u8a8d\u8a3c\u306b\u5931\u6557\u3057\u307e\u3057\u305f\u3002\u30bf\u30d6\u3092\u9589\u3058\u3066\u304f\u3060\u3055\u3044\u3002');\n  }\n}\n```\nalert()\u3092\u547c\u3073\u51fa\u3057\u305f\u3089\u30dd\u30c3\u30d7\u30a2\u30c3\u30d7\u304c\u8868\u793a\u3055\u308c\u3066\u3001\u8a8d\u8a3c\u306e\u30ea\u30f3\u30af\u3092\u62bc\u3059\u3068Oauth\u306e\u753b\u9762\u306b\u9077\u79fb\u3059\u308b\u4ed5\u7d44\u307f\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002\nOauth\u3078\u306eURL\u3078\u30b3\u30fc\u30c9\u4e0a\u3067\u30ea\u30c0\u30a4\u30ec\u30af\u30c8\u3055\u305b\u308b\u3053\u3068\u304c\u3067\u304d\u306a\u3044\u3088\u3046\u306a\u306e\u3067\u3001\u30ea\u30f3\u30af\u3067\u98db\u3070\u3059\u3088\u3046\u306b\u3057\u3066\u3044\u307e\u3059\u3002\n\n## SearchConsole\u3078\u306e\u30ea\u30af\u30a8\u30b9\u30c8\n\n```javascript\nvar SITE_URL = 'https%3A%2F%2Fmatome.miil.me'\n\n/* SearchConsole\u304b\u3089\u30c7\u30fc\u30bf\u3092\u53d6\u5f97\n* @param date Date \u65e5\u4ed8\n* @param unscope_url Array \u9664\u5916\u3059\u308bURL\u306e\u30ea\u30b9\u30c8\n* @return Hash \u30ec\u30b9\u30dd\u30f3\u30b9\n*/\nfunction importData(date, unscope_url){\n  // \u6761\u4ef6\u6307\u5b9a\n  // \u8aad\u307f\u8fbc\u307f\u6e08\u307f\u306eURL\u3092\u9664\u5916\n  for(var i=0; i<unscope_url.length; i++){\n    filters.push({\n      dimension: \"page\",\n      operator: \"notEquals\",\n      expression: unscope_url[i]\n    })\n  }\n  \n  var params = {\n    rowLimit: PER_RECORD,\n    startDate: date.toISOString().substring(0, 10),\n    endDate: date.toISOString().substring(0, 10),\n    dimensions: [\"page\"],\n    dimensionFilterGroups:[\n      {\n        filters: filters\n      },\n    ],\n  }\n\n  return query(params);\n}\n\n/* SearchConsole\u3078\u30af\u30a8\u30ea\u554f\u3044\u5408\u308f\u305b\n*/\nfunction query(params) {\n  var service = getService();\n  var response = UrlFetchApp.fetch('https://www.googleapis.com/webmasters/v3/sites/'+ SITE_URL +'/searchAnalytics/query', {\n    method : \"post\",\n    contentType: \"application/json\",   \n    headers: {\n      Authorization: 'Bearer ' + service.getAccessToken(),\n    },\n    payload:JSON.stringify(params),\n  });\n  return response;\n}\n```\nimportData\u3092\u547c\u3073\u51fa\u3059\u3068\u30c7\u30fc\u30bf\u304c\u3068\u308c\u308b\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002\n\u9664\u5916\u306eURL\u30ea\u30b9\u30c8\u3092\u6e21\u3059\u306e\u306f\u3001SearchConsole\u306eAPI\u304c5,000\u4ef6\u307e\u3067\u3057\u304b\uff11\u5ea6\u306b\u3068\u308c\u306a\u3044\u306e\u3068\u3001\u30da\u30fc\u30b8\u30cd\u30fc\u30b7\u30e7\u30f3\u304c\u884c\u3048\u306a\u3044\u306e\u3067\u4ed5\u65b9\u306a\u304f\u4e00\u5ea6\u53d6\u5f97\u3057\u305fURL\u306f\u6b21\u306f\u53d6\u3089\u306a\u3044\u3088\u3046\u306b\u30d5\u30a3\u30eb\u30bf\u30fc\u3068\u3057\u3066\u6e21\u3059\u305f\u3081\u3067\u3059\u3002\n\n## \u30b7\u30fc\u30c8\u3078\u306e\u66f8\u304d\u8fbc\u307f\n```javascript\n//  \u65e5\u4ed8\u306e\u671f\u9593\nvar DATE_RANGE = 7;\n\n/*\n* \u5168\u30b7\u30fc\u30c8\u3092\u66f4\u65b0\n* \u6628\u65e5\u304b\u3089\u6570\u65e5\u5206\u306e\u30b7\u30fc\u30c8\u3092\u518d\u4f5c\u6210\u3059\u308b\n*/\nfunction updateSheets(){\n  var service = getService();  \n  if(!service.hasAccess()){\n    alertAuth();\n    return;\n  }\n  var date = new Date();\n  date.setDate(date.getDate() - 2);\n  create_records_sheet(date,DATE_RANGE);\n}\n\n/* \u6307\u5b9a\u671f\u9593\u306e\u30ec\u30b3\u30fc\u30c9\u306e\u30b7\u30fc\u30c8\u3092\u4f5c\u6210\u3059\u308b\n* \uff20@param Date \u53d6\u5f97\u5bfe\u8c61\u306e\u65e5\u4ed8\n* @param Int \u53d6\u5f97\u904e\u53bb\u65e5\u6570\n*/\nfunction create_records_sheet(date, dateRange){\n  sheet = getSheet(\"\u30ec\u30b3\u30fc\u30c9\");\n  sheet.clear();\n  set_record_format(sheet);\n  \n  date.setDate(date.getDate() - dateRange);\n  var rowIndex = 2;\n  for(var i=0; i < dateRange; i++){\n    rowIndex = add_records(date, sheet, rowIndex);\n    date.setDate(date.getDate() + 1);\n  }\n  sheet.autoResizeColumn(2);\n}\n\n// \u30ec\u30b3\u30fc\u30c9\u8a18\u8f09\u7528\u306e\u30b7\u30fc\u30c8\u306e\u30d5\u30a9\u30fc\u30de\u30c3\u30c8\u3092\u8a2d\u5b9a\u3059\u308b\nfunction set_record_format(sheet){\n  ranges = sheet.getRange(1,1,1,6)\n  ranges.setValues([[\"\u65e5\u4ed8\",\"URL\",\"\u30af\u30ea\u30c3\u30af\u6570\",\"\u8868\u793a\u56de\u6570\",\"CTR\",\"\u63b2\u8f09\u9806\u4f4d\"]])\n}\n\n/* \u6307\u5b9a\u3057\u305f\u65e5\u4ed8\u306e\u30c7\u30fc\u30bf\u3092\u6307\u5b9a\u306e\u30b7\u30fc\u30c8\u306b\u8ffd\u8a18\u3059\u308b\n* @param date \u30c7\u30fc\u30bf\u53d6\u5f97\u5bfe\u8c61\u65e5\n* @param sheet \u8ffd\u52a0\u5148\u306e\u30b7\u30fc\u30c8\n* @param row \u633f\u5165\u958b\u59cb\u884c\u756a\u53f7\n*/\nfunction add_records(date,sheet,rowIndex){\n  var unscope_url = [];\n  //\u4e00\u5ea6\u306b\u8aad\u307f\u8fbc\u3081\u308b\u4ef6\u6570\u306b\u5236\u9650\u304c\u3042\u308b(\u30da\u30fc\u30b8\u30f3\u30b0\u5236\u5fa1\u3082\u306a\u3044)\u306e\u3067\u3001\u30eb\u30fc\u30d7\u3057\u3066\u5168\u4ef6\u5206\u3092\u884c\u3046\n  for(var count=0; count < 3; count++){ //\u7121\u9650\u30eb\u30fc\u30d7\u3067\u3082\u3044\u3044\u3051\u3069\u3001\u5ff5\u306e\u70ba100\u56de\u304f\u3089\u3044\u3067\u6b62\u3081\u3066\u304a\u304f\n    // \u30c7\u30fc\u30bf\u3092\u53d6\u5f97\n    var data = JSON.parse(importData(date,unscope_url));\n    \n    // SpreadSheet\u306b\u7a81\u3063\u8fbc\u3080\u305f\u3081\u306b\u6574\u5f62\n    var records = modify_records(data,date);\n    if(records.length == 0){\n      break; //\u8aad\u8fbc\u7d42\u4e86\u3057\u3066\u308b\u306e\u3067\u306c\u3051\u308b\n    }\n    \n    //\u53d6\u5f97\u3057\u305fURL\u306f\u8aad\u307f\u8fbc\u307f\u6e08\u307f\u306e\u30ea\u30b9\u30c8\u3078\u8ffd\u52a0\n    for(var i = 0; i < records.length; i++){\n      unscope_url.push(records[i][1]);\n    }\n    \n    // SpreadSheet\u3078\u66f8\u304d\u8fbc\u307f\n    writeSheet(sheet,records, rowIndex);\n    rowIndex += records.length;\n  }\n  return rowIndex;\n}\n\n//  SearchConsole\u306e\u7d50\u679c\u3092SpreadSheet\u306b\u7a81\u3063\u8fbc\u3080\u305f\u3081\u306b\u6574\u5f62\nfunction modify_records(data,date){\n  var records = [];\n  var date_str = date.toISOString().substring(0, 10);\n  if(data[\"rows\"] != undefined){\n    for (var i = 0; i < data[\"rows\"].length; i++){\n      record = data[\"rows\"][i]\n      records.push([date_str,record[\"keys\"][0],record[\"clicks\"],record[\"impressions\"],record['ctr'],record['position']]);\n    }\n  }\n  return records;  \n}\n\n/*\n* \u30c7\u30fc\u30bf\u3092\u30b7\u30fc\u30c8\u306b\u51fa\u529b\u3059\u308b\n* @param sheet, \u66f8\u304d\u8fbc\u3080\u5148\u306e\u30b7\u30fc\u30c8\n* @param records \u66f8\u304d\u8fbc\u3080\u30ec\u30b3\u30fc\u30c9 2\u6b21\u5143\u914d\u5217\u3092\u308f\u305f\u3059\n* @param row \u66f8\u304d\u8fbc\u307f\u958b\u59cb\u3059\u308b\u884c\u756a\u53f7\n*/\nfunction writeSheet(sheet,records,row){  \n  ranges = sheet.getRange(row,1,records.length,6)\n  ranges.setValues(records)\n}\n\n// \u30b7\u30fc\u30c8\u3092\u53d6\u5f97\n// \u540c\u3058\u30b7\u30fc\u30c8\u540d\u304c\u3042\u308c\u3070\u65e2\u5b58\u306e\u30b7\u30fc\u30c8\u3092\u8fd4\u3059\n// \u540c\u3058\u30b7\u30fc\u30c8\u540d\u304c\u306a\u3051\u308c\u3070\u65b0\u3057\u304f\u4f5c\u6210\u3059\u308b\nfunction getSheet(sheetName){\n  var spreadsheet = SpreadsheetApp.getActive();\n  var sheet = spreadsheet.getSheetByName(sheetName);\n  if (sheet == null) {\n    sheet = spreadsheet.insertSheet(sheetName);\n  }\n  return sheet;\n}\n```\nupdateSheet\u3092\u547c\u3073\u51fa\u305b\u3070\u6570\u65e5\u5206\u306e\u30c7\u30fc\u30bf\u304c\u65e5\u3054\u3068\u306b\"\u30ec\u30b3\u30fc\u30c9\"\u306e\u30b7\u30fc\u30c8\u306b\u66f8\u304d\u8fbc\u307e\u308c\u307e\u3059\u3002\n\u3042\u3068\u306f\u305d\u306e\u30b7\u30fc\u30c8\u304b\u3089\u30d4\u30dc\u30c3\u30c8\u30c6\u30fc\u30d6\u30eb\u3092\u4f5c\u308c\u3070\u65e5\u4ed8\u00d7URL\u306e\u8868\u304c\u3064\u304f\u308c\u307e\u3059\u3002\n\u6700\u5f8c\u306b\u4f7f\u3044\u3084\u3059\u3044\u3088\u3046\u306b\u66f4\u65b0\u306e\u30b3\u30de\u30f3\u30c9\u3092\u30e1\u30cb\u30e5\u30fc\u306b\u8ffd\u52a0\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\n```javascript\n//\u30b7\u30fc\u30c8\u958b\u59cb\u6642\u306e\u51e6\u7406\nfunction onOpen() {\n  // \u66f4\u65b0\u7528\u306e\u30e1\u30cb\u30e5\u30fc\u3092\u8ffd\u52a0\n  SpreadsheetApp.getUi()\n      .createMenu('SearchConsole')\n      .addItem('\u6700\u65b0\u306e\u60c5\u5831\u3092\u53d6\u5f97', 'updateSheets')\n      .addToUi();\n}\n\n```\n\n## \u7d42\u308f\u308a\u306b\n\u4f5c\u3063\u3066\u307f\u3066\u3001SearchConsole\u306e\u30c7\u30fc\u30bf\u306f\u8868\u793a\u56de\u6570\u304c0\u306a\u3089\u3070\u30c7\u30fc\u30bf\u304c\u5165\u3063\u3066\u3053\u306a\u3044\u3067\u3059\u3002\n\u305d\u308c\u3068\u30af\u30a8\u30ea\u3082\u6307\u5b9a\u3057\u306a\u3044\u3068\u4f55\u3067\u8868\u793a\u3055\u308c\u305f\u63b2\u8f09\u9806\u4f4d\u304b\u3082\u308f\u304b\u3089\u306a\u3044\u3001\u3068\u3044\u3046\u306e\u304c\u8f9b\u3044\u3068\u3053\u308d\n"}