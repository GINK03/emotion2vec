{"context": " More than 1 year has passed since last update.GitHub\u3068Backlog\u3069\u3061\u3089\u3082\u66f4\u65b0\u72b6\u614b\u3092\u540c\u3058\u306b\u4fdd\u3064\u306e\u3092\u624b\u52d5\u3067\u64cd\u4f5c\u3059\u308b\u306e\u306f\u9762\u5012\u3060\u3068\u601d\u3063\u305f\u306e\u3067\u3001\nAPI\u3092\u4f7f\u3063\u3066\u3001\u81ea\u52d5\u66f4\u65b0\u304c\u3067\u304d\u308b\u3088\u3046\u306b\u3057\u3066\u307f\u307e\u3057\u305f\u3002\n\n\u4eca\u56de\u306e\u4ed5\u69d8\n\nGitHub\u3067Merge\u3055\u308c\u305f\u3089\u6b21\u3092\u5b9f\u884c\n\n\u8ab2\u984c\u62c5\u5f53\u8005\u3092\u300cStgUp\u5f85\u3061\u300d\u30e6\u30fc\u30b6\u30fc\u306b\u5207\u308a\u66ff\u3048\u308b\u3002\n\n\u3000\u3000\u203b\u300cStgUp\u5f85\u3061\u300d\u3068\u3044\u3046\u540d\u524d\u306eBacklog\u30e6\u30fc\u30b6\u30fc\u3092\u4f5c\u3063\u3066\n\u3000\u3000\u3000\u3069\u306e\u30bf\u30b9\u30af\u304c\u5b8c\u4e86\u3057\u3066\u3044\u3066Stg\u74b0\u5883\u306b\u3042\u3052\u3066\u3044\u3044\u306e\u304b\u3092\u5206\u304b\u308b\u3088\u3046\u306b\u904b\u55b6\u3057\u3066\u3044\u308b\u70ba\u3002\n\n\u51e6\u7406\u6e08\u30b9\u30c6\u30fc\u30bf\u30b9\u306b\u5207\u308a\u66ff\u3048\u308b\n\u30b3\u30e1\u30f3\u30c8\u306b\u3001\u30d7\u30eb\u30ea\u30afURL\u3068Merge\u30e6\u30fc\u30b6\u30fc\u540d\u3092\u6295\u7a3f\n\u30de\u30fc\u30b8\u3055\u308c\u305f\u3053\u3068\u3092\u5b9f\u88c5\u62c5\u5f53\u8005\u306bBacklog\u306e\u304a\u77e5\u3089\u305b\u6a5f\u80fd\u3067\u901a\u77e5\n\n\n\u6ce8\u610f\u70b9\n\u4eca\u306e\u3068\u3053\u308d\u4e0b\u8a18\u6761\u4ef6\u3067\u306f\u66f4\u65b0\u3055\u308c\u306a\u3044\u4ed5\u69d8\n\nProjectID\u3092\u542b\u3080BacklogID\u304c\u30d7\u30eb\u30ea\u30af\u30a8\u30b9\u30c8\u306e\u30bf\u30a4\u30c8\u30eb\u306b\u542b\u307e\u308c\u3066\u3044\u306a\u3044\u5834\u5408\nBacklog\u306e\u8ab2\u984c\u304c\u65e2\u306b\u3001\u62c5\u5f53\u8005\u5207\u66ff\u4e88\u5b9a\u306e\u30e6\u30fc\u30b6\u30fc(StgUp\u5f85\u3061)\u307e\u305f\u306f\u51e6\u7406\u6e08\u307f\u30b9\u30c6\u30fc\u30bf\u30b9\u306b\u306a\u3063\u3066\u3044\u305f\u5834\u5408\u3002\n\n\n\u5b9f\u88c5\u74b0\u5883\n\nHeroku\nhttps://dashboard.heroku.com\n\nRails\nruby '2.1.2'\nrails '4.1.4'\n\nGitHub Webhook\nGithub\u4e0a\u3067\u8d77\u304d\u305f\u30a2\u30af\u30b7\u30e7\u30f3\u306e\u5ea6\u306b\u6307\u5b9a\u3057\u305furl\u306b\u60c5\u5831\u3092post\u3057\u3066\u304f\u308c\u308bWebhook\u6a5f\u80fd\u3092\u5229\u7528\u3002\nhttps://developer.github.com/webhooks/\n\nBacklog API2\nAPI \u30d0\u30fc\u30b8\u30e7\u30f3\uff12 \u3092\u4f7f\u3044\u307e\u3057\u305f\nhttp://developer.nulab-inc.com/ja/docs/backlog/api/2/update-issue\n\nRails Code\n\nhooks_controller.rb\nclass HooksController < ApplicationController\n\n  # Merge\u3055\u308c\u305f\u3089Backlog\u3092\u66f4\u65b0\n  def change_backlog_status\n    render :nothing => true\n    if params[:pull_request].present?\n      # PullRequests \u5185\u5bb9\n      title = params[:pull_request][\"title\"]\n      merged = params[:pull_request][\"merged\"]\n      backlog_id = title.scan(/#{Backlog::PJT_KEY}-\\d+/)\n      backlog_id = backlog_id[0]\n      puts \"backlog_id: #{backlog_id}------>\"\n\n      if title.present? && merged == true\n        puts \"merged: true------>\"\n        # Backlog\u30b3\u30e1\u30f3\u30c8\u5185\u5bb9\n        pull_request_url = params[:pull_request][\"html_url\"]\n        merge_user = params[:pull_request][\"merged_by\"][\"login\"]\n        comment_text = \"\u25bc\u30b3\u30fc\u30c9\u304cdevelop\u306b\u30de\u30fc\u30b8\u3055\u308c\u307e\u3057\u305f\u3002 \\n \u30fbGitHub: #{pull_request_url} \\n \u30fbMergeUser: #{merge_user}\"\n        # \u66f4\u65b0\n        backlog_change(backlog_id, comment_text)\n      end\n    end\n  end\n\n  private\n    # BacklogAPI: http://developer.nulab-inc.com/ja/docs/backlog/api/2/get-space\n\n    def get_backlog_data(get_url)\n      api_url = \"#{Backlog::URL}#{get_url}?apiKey=#{Backlog::API_KEY}\"\n      response = Net::HTTP.get(URI(api_url))\n      JSON.parse(response)\n    end\n\n    def get_http(api_url)\n      uri = URI(api_url)\n      http = Net::HTTP.new(uri.host, uri.port)\n      http.use_ssl = true\n      http.verify_mode = OpenSSL::SSL::VERIFY_NONE\n      http\n    end\n\n    # \u30b3\u30e1\u30f3\u30c8\u3092\u62c5\u5f53\u8005\u3060\u3063\u305f\u4eba\u306b\u304a\u77e5\u3089\u305b\n    def notifications(backlog_id, user_id)\n      # \u30b3\u30e1\u30f3\u30c8ID\u53d6\u5f97: http://developer.nulab-inc.com/ja/docs/backlog/api/2/get-comments\n      get_url = \"/api/v2/issues/#{backlog_id}/comments\"\n      comments = get_backlog_data(get_url)\n      comment_id = comments.first[\"id\"]\n      puts \"comment_id: #{comment_id}----->\"\n\n      # \u30b3\u30e1\u30f3\u30c8\u3092\u304a\u77e5\u3089\u305b: http://developer.nulab-inc.com/ja/docs/backlog/api/2/add-comment-notification\n      update_url = \"/api/v2/issues/#{backlog_id}/comments/#{comment_id}/notifications\"\n      api_url = \"#{Backlog::URL}#{update_url}?apiKey=#{Backlog::API_KEY}\"\n      http = get_http(api_url)\n      params = {\"notifiedUserId\"=>[user_id]}.to_param\n      response = http.send_request('POST', api_url, params)\n    end\n\n    # Backlog\u66f4\u65b0\n    def backlog_change(backlog_id, comment_text)\n      # \u66f4\u65b0: http://developer.nulab-inc.com/ja/docs/backlog/api/2/update-issue\n      update_url = \"/api/v2/issues/#{backlog_id}\" # PATCH\n      api_url = \"#{Backlog::URL}#{update_url}?apiKey=#{Backlog::API_KEY}\"\n      http = get_http(api_url)\n      # \u66f4\u65b0\u524d\u62c5\u5f53\u8005ID\u53d6\u5f97\n      issues = get_backlog_data(\"/api/v2/issues/#{backlog_id}\")\n      user_id = issues[\"assignee\"][\"id\"]\n      puts \"user_id: #{user_id}------>\"\n      # \u5185\u5bb9\uff1aStgUp\u5f85\u3061\u30e6\u30fc\u30b6\u30fc\u306b/\u51e6\u7406\u6e08(id:3)\u3078/comment:PullRequests URL + Merge\u30e6\u30fc\u30b6\u30fc\u540d\u3092\u6295\u7a3f\n      params = {\"assigneeId\"=>Backlog::STG_USER, \"statusId\"=>3, \"comment\"=>comment_text}.to_param\n      response = http.send_request('PATCH', api_url, params)\n\n      # \u304a\u77e5\u3089\u305b\n      notifications(backlog_id, user_id)\n    end\nend\n\n\n\n\u53c2\u8003\u306b\u3057\u305f\u8a18\u4e8b\u3084\u30b3\u30fc\u30c9\u30e1\u30e2\u03c6(\u30fb\u30fb*)\n\nRails 4.0\u3060\u3068CSRF\u30c8\u30fc\u30af\u30f3\u3067\u30a8\u30e9\u30fc\u306b\u306a\u308b - Qiita http://qiita.com/naoty_k/items/b40b13735fd7f06f8cb7\nHTTP\u53c2\u8003\uff1ahttps://github.com/rohit9889/http-requestor/blob/master/lib/http_requestor.rb\n\u521d\u5fc3\u8005\u3067\u308215\u5206\u3067\u516c\u958b\u3067\u304d\u308bHeroku\u306e\u306f\u3058\u3081\u304b\u305f \u2014 Mobage Developers Blog \nhttp://developers.mobage.jp/blog/how-to-use-for-beginners-heroku\n\n\nGitHub\u3068Backlog\u3069\u3061\u3089\u3082\u66f4\u65b0\u72b6\u614b\u3092\u540c\u3058\u306b\u4fdd\u3064\u306e\u3092\u624b\u52d5\u3067\u64cd\u4f5c\u3059\u308b\u306e\u306f\u9762\u5012\u3060\u3068\u601d\u3063\u305f\u306e\u3067\u3001\nAPI\u3092\u4f7f\u3063\u3066\u3001\u81ea\u52d5\u66f4\u65b0\u304c\u3067\u304d\u308b\u3088\u3046\u306b\u3057\u3066\u307f\u307e\u3057\u305f\u3002\n\n## \u4eca\u56de\u306e\u4ed5\u69d8\n\n### GitHub\u3067Merge\u3055\u308c\u305f\u3089\u6b21\u3092\u5b9f\u884c\n\n* \u8ab2\u984c\u62c5\u5f53\u8005\u3092\u300cStgUp\u5f85\u3061\u300d\u30e6\u30fc\u30b6\u30fc\u306b\u5207\u308a\u66ff\u3048\u308b\u3002\n\n\u3000\u3000\u203b\u300cStgUp\u5f85\u3061\u300d\u3068\u3044\u3046\u540d\u524d\u306eBacklog\u30e6\u30fc\u30b6\u30fc\u3092\u4f5c\u3063\u3066\n\u3000\u3000\u3000\u3069\u306e\u30bf\u30b9\u30af\u304c\u5b8c\u4e86\u3057\u3066\u3044\u3066Stg\u74b0\u5883\u306b\u3042\u3052\u3066\u3044\u3044\u306e\u304b\u3092\u5206\u304b\u308b\u3088\u3046\u306b\u904b\u55b6\u3057\u3066\u3044\u308b\u70ba\u3002\n\n* \u51e6\u7406\u6e08\u30b9\u30c6\u30fc\u30bf\u30b9\u306b\u5207\u308a\u66ff\u3048\u308b\n* \u30b3\u30e1\u30f3\u30c8\u306b\u3001\u30d7\u30eb\u30ea\u30afURL\u3068Merge\u30e6\u30fc\u30b6\u30fc\u540d\u3092\u6295\u7a3f\n* \u30de\u30fc\u30b8\u3055\u308c\u305f\u3053\u3068\u3092\u5b9f\u88c5\u62c5\u5f53\u8005\u306bBacklog\u306e\u304a\u77e5\u3089\u305b\u6a5f\u80fd\u3067\u901a\u77e5\n\n\n### \u6ce8\u610f\u70b9\n\u4eca\u306e\u3068\u3053\u308d\u4e0b\u8a18\u6761\u4ef6\u3067\u306f\u66f4\u65b0\u3055\u308c\u306a\u3044\u4ed5\u69d8\n\n* ProjectID\u3092\u542b\u3080BacklogID\u304c\u30d7\u30eb\u30ea\u30af\u30a8\u30b9\u30c8\u306e\u30bf\u30a4\u30c8\u30eb\u306b\u542b\u307e\u308c\u3066\u3044\u306a\u3044\u5834\u5408\n* Backlog\u306e\u8ab2\u984c\u304c\u65e2\u306b\u3001\u62c5\u5f53\u8005\u5207\u66ff\u4e88\u5b9a\u306e\u30e6\u30fc\u30b6\u30fc(StgUp\u5f85\u3061)\u307e\u305f\u306f\u51e6\u7406\u6e08\u307f\u30b9\u30c6\u30fc\u30bf\u30b9\u306b\u306a\u3063\u3066\u3044\u305f\u5834\u5408\u3002\n\n\n## \u5b9f\u88c5\u74b0\u5883\n\n### Heroku\nhttps://dashboard.heroku.com\n\n### Rails\nruby '2.1.2'\nrails '4.1.4'\n\n### GitHub Webhook\nGithub\u4e0a\u3067\u8d77\u304d\u305f\u30a2\u30af\u30b7\u30e7\u30f3\u306e\u5ea6\u306b\u6307\u5b9a\u3057\u305furl\u306b\u60c5\u5831\u3092post\u3057\u3066\u304f\u308c\u308bWebhook\u6a5f\u80fd\u3092\u5229\u7528\u3002\nhttps://developer.github.com/webhooks/\n\n\n### Backlog API2\n\nAPI \u30d0\u30fc\u30b8\u30e7\u30f3\uff12 \u3092\u4f7f\u3044\u307e\u3057\u305f\nhttp://developer.nulab-inc.com/ja/docs/backlog/api/2/update-issue\n\n\n\n## Rails Code\n\n```ruby:hooks_controller.rb\nclass HooksController < ApplicationController\n\n  # Merge\u3055\u308c\u305f\u3089Backlog\u3092\u66f4\u65b0\n  def change_backlog_status\n    render :nothing => true\n    if params[:pull_request].present?\n      # PullRequests \u5185\u5bb9\n      title = params[:pull_request][\"title\"]\n      merged = params[:pull_request][\"merged\"]\n      backlog_id = title.scan(/#{Backlog::PJT_KEY}-\\d+/)\n      backlog_id = backlog_id[0]\n      puts \"backlog_id: #{backlog_id}------>\"\n\n      if title.present? && merged == true\n        puts \"merged: true------>\"\n        # Backlog\u30b3\u30e1\u30f3\u30c8\u5185\u5bb9\n        pull_request_url = params[:pull_request][\"html_url\"]\n        merge_user = params[:pull_request][\"merged_by\"][\"login\"]\n        comment_text = \"\u25bc\u30b3\u30fc\u30c9\u304cdevelop\u306b\u30de\u30fc\u30b8\u3055\u308c\u307e\u3057\u305f\u3002 \\n \u30fbGitHub: #{pull_request_url} \\n \u30fbMergeUser: #{merge_user}\"\n        # \u66f4\u65b0\n        backlog_change(backlog_id, comment_text)\n      end\n    end\n  end\n\n  private\n    # BacklogAPI: http://developer.nulab-inc.com/ja/docs/backlog/api/2/get-space\n\n    def get_backlog_data(get_url)\n      api_url = \"#{Backlog::URL}#{get_url}?apiKey=#{Backlog::API_KEY}\"\n      response = Net::HTTP.get(URI(api_url))\n      JSON.parse(response)\n    end\n\n    def get_http(api_url)\n      uri = URI(api_url)\n      http = Net::HTTP.new(uri.host, uri.port)\n      http.use_ssl = true\n      http.verify_mode = OpenSSL::SSL::VERIFY_NONE\n      http\n    end\n\n    # \u30b3\u30e1\u30f3\u30c8\u3092\u62c5\u5f53\u8005\u3060\u3063\u305f\u4eba\u306b\u304a\u77e5\u3089\u305b\n    def notifications(backlog_id, user_id)\n      # \u30b3\u30e1\u30f3\u30c8ID\u53d6\u5f97: http://developer.nulab-inc.com/ja/docs/backlog/api/2/get-comments\n      get_url = \"/api/v2/issues/#{backlog_id}/comments\"\n      comments = get_backlog_data(get_url)\n      comment_id = comments.first[\"id\"]\n      puts \"comment_id: #{comment_id}----->\"\n\n      # \u30b3\u30e1\u30f3\u30c8\u3092\u304a\u77e5\u3089\u305b: http://developer.nulab-inc.com/ja/docs/backlog/api/2/add-comment-notification\n      update_url = \"/api/v2/issues/#{backlog_id}/comments/#{comment_id}/notifications\"\n      api_url = \"#{Backlog::URL}#{update_url}?apiKey=#{Backlog::API_KEY}\"\n      http = get_http(api_url)\n      params = {\"notifiedUserId\"=>[user_id]}.to_param\n      response = http.send_request('POST', api_url, params)\n    end\n\n    # Backlog\u66f4\u65b0\n    def backlog_change(backlog_id, comment_text)\n      # \u66f4\u65b0: http://developer.nulab-inc.com/ja/docs/backlog/api/2/update-issue\n      update_url = \"/api/v2/issues/#{backlog_id}\" # PATCH\n      api_url = \"#{Backlog::URL}#{update_url}?apiKey=#{Backlog::API_KEY}\"\n      http = get_http(api_url)\n      # \u66f4\u65b0\u524d\u62c5\u5f53\u8005ID\u53d6\u5f97\n      issues = get_backlog_data(\"/api/v2/issues/#{backlog_id}\")\n      user_id = issues[\"assignee\"][\"id\"]\n      puts \"user_id: #{user_id}------>\"\n      # \u5185\u5bb9\uff1aStgUp\u5f85\u3061\u30e6\u30fc\u30b6\u30fc\u306b/\u51e6\u7406\u6e08(id:3)\u3078/comment:PullRequests URL + Merge\u30e6\u30fc\u30b6\u30fc\u540d\u3092\u6295\u7a3f\n      params = {\"assigneeId\"=>Backlog::STG_USER, \"statusId\"=>3, \"comment\"=>comment_text}.to_param\n      response = http.send_request('PATCH', api_url, params)\n\n      # \u304a\u77e5\u3089\u305b\n      notifications(backlog_id, user_id)\n    end\nend\n```\n\n## \u53c2\u8003\u306b\u3057\u305f\u8a18\u4e8b\u3084\u30b3\u30fc\u30c9\u30e1\u30e2\u03c6(\u30fb\u30fb*)\n\n* Rails 4.0\u3060\u3068CSRF\u30c8\u30fc\u30af\u30f3\u3067\u30a8\u30e9\u30fc\u306b\u306a\u308b - Qiita http://qiita.com/naoty_k/items/b40b13735fd7f06f8cb7\n\n* HTTP\u53c2\u8003\uff1ahttps://github.com/rohit9889/http-requestor/blob/master/lib/http_requestor.rb\n\n* \u521d\u5fc3\u8005\u3067\u308215\u5206\u3067\u516c\u958b\u3067\u304d\u308bHeroku\u306e\u306f\u3058\u3081\u304b\u305f \u2014 Mobage Developers Blog \n http://developers.mobage.jp/blog/how-to-use-for-beginners-heroku\n", "tags": ["GitHub", "Rails", "backlog", "api"]}