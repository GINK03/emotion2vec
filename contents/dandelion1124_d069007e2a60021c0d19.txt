{"context": "\u3053\u306e\u8a18\u4e8b\u306fOpenCV Advent Calendar 2016\u306e4\u65e5\u76ee\u306e\u8a18\u4e8b\u3067\u3059\uff0e\n\n\u306f\u3058\u3081\u306b\n\u3053\u306e\u8a18\u4e8b\u3067\u306fOpenCV\u306ecuda\u30e2\u30b8\u30e5\u30fc\u30eb\u3067\u63d0\u4f9b\u3055\u308c\u3066\u3044\u308bcuda::Stream\u3068\u305d\u306e\u4f7f\u3044\u65b9\u3092\u7d39\u4ecb\u3057\u307e\u3059\uff0e\n\u4eca\u56de\u7d39\u4ecb\u3059\u308bcuda::Stream\u3067\u3059\u304c\uff0c\u3082\u3057\u304b\u3057\u305f\u3089OpenCV\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u3067\u898b\u305f\u3053\u3068\u3042\u308b\u65b9\u3044\u3089\u3063\u3057\u3083\u308b\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u306d\uff0e\n\n\u4ee5\u964d\u306f\u57fa\u672c\u7684\u306bOpenCV 3.x\u7cfb\u3092\u524d\u63d0\u306b\u8aac\u660e\u3057\u307e\u3059\uff08\u6700\u5f8c\u306e\u65b9\u30672.4\u7cfb\u306b\u3064\u3044\u3066\u3082\u8efd\u304f\u89e6\u308c\u307e\u3059\uff09\uff0e\n\ncuda::Stream\u30af\u30e9\u30b9\u3068\u306f\nCUDA\u306eStream\u306fGPU\u4e0a\u306e\u51e6\u7406\u3092\u7ba1\u7406\u3059\u308b\u30ad\u30e5\u30fc\u306e\u3053\u3068\u3067\u30ab\u30fc\u30cd\u30eb\u5b9f\u884c\u3084\u30e1\u30e2\u30ea\u8ee2\u9001\u306e\u4e26\u5217\u6027\uff0c\u5b9f\u884c\u9806\u5e8f\u3092\u5236\u5fa1\u3059\u308b\u305f\u3081\u306b\u7528\u3044\u3089\u308c\u307e\u3059\uff0eCUDA\u306eStream\u306b\u95a2\u3057\u3066\u306f\u4ee5\u4e0b\u306e\u8a18\u4e8b\u3092\u53c2\u7167\u304f\u3060\u3055\u3044\uff0e\n\n\u30b9\u30c8\u30ea\u30fc\u30e0\u3092\u7528\u3044\u305f\u30b3\u30f3\u30ab\u30ec\u30f3\u30c8\u30ab\u30fc\u30cd\u30eb\u30d7\u30ed\u30b0\u30e9\u30df\u30f3\u30b0\u3068\u6700\u9069\u5316\nHow to Overlap Data Transfers in CUDA C/C++\nGPU Pro Tip: CUDA 7 Streams Simplify Concurrency\n\n\u307e\u305f\uff0cOpenCV\u306ecuda\u30e2\u30b8\u30e5\u30fc\u30eb\u3067\u306f\u3053\u306eStream\u3092\u7c21\u5358\u306b\u5229\u7528\u3059\u308b\u305f\u3081\u306bcuda::Stream\u30af\u30e9\u30b9\u3092\u63d0\u4f9b\u3057\u3066\u3044\u307e\u3059\uff0e\n\ncuda::Stream\u30af\u30e9\u30b9\u304c\u63d0\u4f9b\u3059\u308bAPI\n\u5192\u982d\u3067\u3082\u7d39\u4ecb\u3057\u305fcuda::Stream\u30af\u30e9\u30b9\u306f\u4ee5\u4e0b\u306eAPI\u3092\u63d0\u4f9b\u3057\u3066\u3044\u307e\u3059\uff0e\n\u5404API\u306e\u8a73\u7d30\u306b\u3064\u3044\u3066\u306f\u516c\u5f0f\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u3092\u53c2\u7167\u304f\u3060\u3055\u3044\uff0e\n\n\n\nAPI\n\u6a5f\u80fd\n\n\n\n\nwaitForCompletion\nStream\u306e\u4e00\u9023\u306e\u51e6\u7406\u304c\u7d42\u308f\u308b\u307e\u3067\u73fe\u5728\u306eCPU\u30b9\u30ec\u30c3\u30c9\u3092\u30d6\u30ed\u30c3\u30ad\u30f3\u30b0\u3059\u308b\n\n\nwaitEvent\nStream\u306e\u30a4\u30d9\u30f3\u30c8\u3092\u5f85\u6a5f\u3059\u308b\u203b\u30a4\u30d9\u30f3\u30c8\u306b\u3064\u3044\u3066\u306f\u516c\u5f0f\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u3092\u53c2\u7167\u304f\u3060\u3055\u3044\n\n\nqueryIfComplete\n\u73fe\u5728\u306estream queue\u306e\u51e6\u7406\u304c\u7d42\u308f\u3063\u3066\u3044\u308b\u304b\u3069\u3046\u304b\u3092\u8abf\u3079\u308b\n\n\nenqueueHostCallback\nStream\u306e\u30ad\u30e5\u30fc\u30a4\u30f3\u30b0\u51e6\u7406\u5b8c\u4e86\u5f8c\u306b\u30db\u30b9\u30c8\u5074\u3067\u5b9f\u884c\u3055\u308c\u308b\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u95a2\u6570\u3092\u8a2d\u5b9a\u3059\u308b\n\n\n\n\u307e\u305f\uff0cenqueueHostCallback\u306e\u4f7f\u3044\u65b9\u306f\u516c\u5f0f\u30c6\u30b9\u30c8\u30b3\u30fc\u30c9\u304c\u53c2\u8003\u306b\u306a\u308b\u3067\u3057\u3087\u3046\uff0e\n\ncuda::Stream\u30af\u30e9\u30b9\u306e\u4f7f\u3044\u65b9\nOpenCV\u306ecuda\u30e2\u30b8\u30e5\u30fc\u30ebAPI\u3067\u660e\u793a\u7684\u306bcuda::Stream\u3092\u4f7f\u3046\u306e\u306f\u975e\u5e38\u306b\u7c21\u5358\u3067\u3059\uff0e\n\u57fa\u672c\u7684\u306a\u5b9f\u88c5\u624b\u9806\u306f\u4ee5\u4e0b\u306e\u901a\u308a\u3067\u3059\uff0e\n\n\ncuda::Stream\u30af\u30e9\u30b9\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u751f\u6210\u3059\u308b\ncuda\u30e2\u30b8\u30e5\u30fc\u30eb\u306eAPI\u306bcuda::Stream\u30af\u30e9\u30b9\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u6e21\u3059\n\n\u4e00\u8a00\u3067\u8a00\u3046\u3068\u300ccuda::Stream\u30af\u30e9\u30b9\u306e\u30a4\u30f3\u30bf\u30f3\u30b9\u3092cuda\u30e2\u30b8\u30e5\u30fc\u30eb\u306eAPI\u306b\u660e\u793a\u7684\u306b\u30bb\u30c3\u30c8\u3059\u308b\u300d\u3060\u3051\u3067OK\u3067\u3059\uff0e\n\n\u30b5\u30f3\u30d7\u30eb\u30b3\u30fc\u30c9\n\u304a\u305d\u3089\u304f\u5b9f\u969b\u306e\u30b3\u30fc\u30c9\u3092\u8aad\u3080\u306e\u304c\u308f\u304b\u308a\u3084\u3059\u3044\u3068\u601d\u3046\u306e\u3067\u30b5\u30f3\u30d7\u30eb\u30b3\u30fc\u30c9\u3092\u4ee5\u4e0b\u306b\u793a\u3057\u307e\u3059\uff0e\n// (1) cuda::Stream\u30af\u30e9\u30b9\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u751f\u6210\u3059\u308b\ncv::cuda::Stream stream;\n\n// (2) cuda\u30e2\u30b8\u30e5\u30fc\u30eb\u306eAPI\u306bcuda::Stream\u30af\u30e9\u30b9\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u6e21\u3059\ncv::cuda::cvtColor(d_img, d_gray, cv::COLOR_BGR2GRAY, 0, stream);\n\n\ncuda::Stream\u3092\u4f7f\u3046\u30e1\u30ea\u30c3\u30c8\ncuda::Stream\u3092\u4f7f\u3046\u3053\u3068\u3067\u30c7\u30fc\u30bf\u8ee2\u9001\u3068\u30ab\u30fc\u30cd\u30eb\u5b9f\u884c\u3092\u30aa\u30fc\u30d0\u30fc\u30e9\u30c3\u30d7\u3055\u305b\u308b\u3053\u3068\u304c\u3067\u304d\uff0c\u30c7\u30fc\u30bf\u8ee2\u9001\u6642\u9593\u3092\u96a0\u853d\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3059\uff0e\u3068\u8a00\u3063\u3066\u3082\u30d4\u30f3\u3068\u6765\u306a\u3044\u3068\u601d\u3046\u306e\u3067\u30b5\u30f3\u30d7\u30eb\u30b3\u30fc\u30c9\u3092\u7528\u3044\u306a\u304c\u3089\u8aac\u660e\u3057\u307e\u3059\uff0e\n\n\u660e\u793a\u7684\u306bcuda::Stream\u3092\u30bb\u30c3\u30c8\u3057\u306a\u3044\u5834\u5408\nOpenCV\u306ecuda\u30e2\u30b8\u30e5\u30fc\u30ebAPI\u306bcuda::Stream\u30af\u30e9\u30b9\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u660e\u793a\u7684\u306b\u30bb\u30c3\u30c8\u3057\u306a\u3044\u5834\u5408\uff0c\nDefault Stream\u3092\u4f7f\u3063\u3066\u51e6\u7406\u304c\u884c\u308f\u308c\u307e\u3059\uff0e\u3053\u3053\u3067\u306f\u30b5\u30f3\u30d7\u30eb\u30b3\u30fc\u30c9\u3068NVIDIA Visual Profiler\u3067\u53d6\u5f97\u3057\u305f\u30bf\u30a4\u30e0\u30e9\u30a4\u30f3\u3092\u793a\u3057\u307e\u3059\uff0e\n\n\u30b5\u30f3\u30d7\u30eb\u30b3\u30fc\u30c9\ncv::Mat src(cv::Size(3840, 2160), CV_8UC3, cv::Scalar(0));\ncv::cuda::HostMem dst1, dst2, dst3;\ncv::cuda::GpuMat d_src;\ncv::cuda::GpuMat d_gray1, d_gray2, d_gray3;\ncv::cuda::GpuMat d_dst1, d_dst2, d_dst3;\n\n// \u30c7\u30d0\u30a4\u30b9\u306b\u8ee2\u9001\nd_src.upload(src);\n\n// GpuMat\u3092\u4f7f\u3063\u305f\u51e6\u7406(Default Stream)\ncv::cuda::cvtColor(d_src, d_gray1, cv::COLOR_BGR2GRAY, 0);\ncv::cuda::threshold(d_gray1, d_dst1, 200, 255, cv::THRESH_BINARY);\n\n//\u30db\u30b9\u30c8\u3078\u8ee2\u9001(Default Stream)\nd_dst1.download(dst1);\n\n// GpuMat\u3092\u4f7f\u3063\u305f\u51e6\u7406(Default Stream)\ncv::cuda::cvtColor(d_src, d_gray2, cv::COLOR_BGR2GRAY, 0);\ncv::cuda::threshold(d_gray2, d_dst2, 200, 255, cv::THRESH_BINARY);\n\n//\u30db\u30b9\u30c8\u306b\u8ee2\u9001(Default Stream)\nd_dst2.download(dst2);\n\n// GpuMat\u3092\u4f7f\u3063\u305f\u51e6\u7406(Default Stream)\ncv::cuda::cvtColor(d_src, d_gray3, cv::COLOR_BGR2GRAY, 0);\ncv::cuda::threshold(d_gray3, d_dst3, 200, 255, cv::THRESH_BINARY);\n\n//\u30db\u30b9\u30c8\u306b\u8ee2\u9001(Default Stream)\nd_dst3.download(dst3);\n\n\n\u30bf\u30a4\u30e0\u30e9\u30a4\u30f3\n\u30b5\u30f3\u30d7\u30eb\u30b3\u30fc\u30c9\u3092\u5b9f\u884c\u3057\u305f\u3068\u304d\u306e\u30bf\u30a4\u30e0\u30e9\u30a4\u30f3\u306f\u4ee5\u4e0b\u306e\u901a\u308a\u3067\u3059\uff0e\n\ncuda\u30e2\u30b8\u30e5\u30fc\u30ebAPI\u306bcuda::Stream\u30af\u30e9\u30b9\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u660e\u793a\u7684\u306b\u30bb\u30c3\u30c8\u3057\u306a\u3044\u3068\nDefault Stream\u304c\u4f7f\u308f\u308c\u3066\u3044\u3066\u30c7\u30fc\u30bf\u8ee2\u9001\u3084\u30ab\u30fc\u30cd\u30eb\u5b9f\u884c\u304c\u4e26\u5217\u306b\u884c\u308f\u308c\u3066\u306a\u3044\u3053\u3068\u304c\u308f\u304b\u308a\u307e\u3059\uff0e\n\n\u660e\u793a\u7684\u306bcuda::Stream\u3092\u30bb\u30c3\u30c8\u3059\u308b\u5834\u5408\n\u3053\u3053\u3067\u306fcuda::Stream\u3092\u4f7f\u3063\u305f\u5834\u5408\u306e\u30b5\u30f3\u30d7\u30eb\u30b3\u30fc\u30c9\u3068\u30bf\u30a4\u30e0\u30e9\u30a4\u30f3\u3092\u793a\u3057\u307e\u3059\uff0e\n\n\u30b5\u30f3\u30d7\u30eb\u30b3\u30fc\u30c9\ncv::Mat src(cv::Size(3840, 2160), CV_8UC3, cv::Scalar(0));\ncv::cuda::HostMem dst1, dst2, dst3;\ncv::cuda::GpuMat d_src;\ncv::cuda::GpuMat d_gray1, d_gray2, d_gray3;\ncv::cuda::GpuMat d_dst1, d_dst2, d_dst3;\n\ncv::cuda::Stream stream[3];\n\n// \u30c7\u30d0\u30a4\u30b9\u306b\u8ee2\u9001\nd_src.upload(src);\n\n// GpuMat\u3092\u4f7f\u3063\u305f\u51e6\u7406(cuda::Stream)\ncv::cuda::cvtColor(d_src, d_gray1, cv::COLOR_BGR2GRAY, 0, stream[0]);\ncv::cuda::threshold(d_gray1, d_dst1, 200, 255, cv::THRESH_BINARY, stream[0]);\n\n//\u30db\u30b9\u30c8\u306b\u8ee2\u9001(cuda::Stream)\nd_dst1.download(dst1, stream[0]);\n\n// GpuMat\u3092\u4f7f\u3063\u305f\u51e6\u7406(cuda::Stream)\ncv::cuda::cvtColor(d_src, d_gray2, cv::COLOR_BGR2GRAY, 0, stream[1]);\ncv::cuda::threshold(d_gray2, d_dst2, 200, 255, cv::THRESH_BINARY, stream[1]);\n\n//\u30db\u30b9\u30c8\u306b\u8ee2\u9001(cuda::Stream)\nd_dst2.download(dst2, stream[1]);\n\n// GpuMat\u3092\u4f7f\u3063\u305f\u51e6\u7406(cuda::Stream)\ncv::cuda::cvtColor(d_src, d_gray3, cv::COLOR_BGR2GRAY, 0, stream[2]);\ncv::cuda::threshold(d_gray3, d_dst3, 200, 255, cv::THRESH_BINARY, stream[2]);\n\n//\u30db\u30b9\u30c8\u306b\u8ee2\u9001(cuda::Stream)\nd_dst3.download(dst3, stream[2]);\n\n\n\u30bf\u30a4\u30e0\u30e9\u30a4\u30f3\n\u30b5\u30f3\u30d7\u30eb\u30b3\u30fc\u30c9\u3092\u5b9f\u884c\u3057\u305f\u3068\u304d\u306e\u30bf\u30a4\u30e0\u30e9\u30a4\u30f3\u306f\u4ee5\u4e0b\u306e\u901a\u308a\u3067\u3059\uff0e\n\n\u3053\u306e\u30b5\u30f3\u30d7\u30eb\u30b3\u30fc\u30c9\u3067\u306f\u8907\u6570\u306ecuda::Stream\u3092\u4f7f\u3063\u3066\u30c7\u30fc\u30bf\u8ee2\u9001\u3084\u30ab\u30fc\u30cd\u30eb\u5b9f\u884c\u306b\u5272\u308a\u5f53\u3066\u308b\u3053\u3068\u3067\u30c7\u30fc\u30bf\u8ee2\u9001\u3068\u30ab\u30fc\u30cd\u30eb\u5b9f\u884c\u3092\u30aa\u30fc\u30d0\u30fc\u30e9\u30c3\u30d7\u3055\u305b\u308b\u3053\u3068\u304c\u3067\u304d\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308a\u307e\u3059\uff0e\n\u307e\u305f\uff0c\u30b5\u30f3\u30d7\u30eb\u30b3\u30fc\u30c9\u306f\u5272\u611b\u3057\u307e\u3059\u304c\uff0c\u4eca\u56de\u7528\u3044\u305fGeForce GTX 1060\u306fCopy Engine\u30922\u3064\u6301\u3063\u3066\u3044\u308b\u306e\u3067\uff0c\u51e6\u7406\u306b\u3088\u3063\u3066\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u30c7\u30fc\u30bf\u8ee2\u9001\uff08\u30db\u30b9\u30c8\u2192\u30c7\u30d0\u30a4\u30b9\uff09\u3068\u30c7\u30fc\u30bf\u8ee2\u9001\uff08\u30c7\u30d0\u30a4\u30b9\u2192\u30db\u30b9\u30c8\uff09\u3092\u30aa\u30fc\u30d0\u30fc\u30e9\u30c3\u30d7\u3055\u305b\u308b\u3053\u3068\u3082\u3067\u304d\u307e\u3059\uff0e\n\n\ncuda::Stream\u30af\u30e9\u30b9\u3092\u4f7f\u3063\u305f\u5b9f\u88c5\u65b9\u6cd5\n\u3053\u3053\u307e\u3067\u306fOpenCV\u306ecuda\u30e2\u30b8\u30e5\u30fc\u30eb\u306eAPI\u3067cuda::Stream\u3092\u660e\u793a\u7684\u306b\u4f7f\u3046\u304a\u8a71\u3067\u3057\u305f\uff0e\n\u4e00\u65b9\u3067OpenCV\u3068\u9023\u643a\u3057\u305f\u81ea\u4f5cCUDA\u30ab\u30fc\u30cd\u30eb\u3067cuda::Stream\u3092\u5229\u7528\u3057\u305f\u3044\u30b1\u30fc\u30b9\u3082\u3042\u308b\u3068\u601d\u3044\u307e\u3059\uff0e\n\u57fa\u672c\u7684\u306a\u5b9f\u88c5\u624b\u9806\u306f\u4ee5\u4e0b\u306e\u901a\u308a\u3067\u3059\uff0e\n\n\u95a2\u6570\u306e\u5f15\u6570\u306bcuda::Stream\u30af\u30e9\u30b9\u306e\u5909\u6570\u3092\u8ffd\u52a0\u3059\u308b\n\ncuda::StreamAccessor::getStream\u30e1\u30bd\u30c3\u30c9\uff08\u516c\u5f0f\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\uff09\u3092\u4f7f\u3063\u3066CUDA\u306eStream\u3092\u53d6\u5f97\u3059\u308b\nCUDA\u30ab\u30fc\u30cd\u30eb\u8d77\u52d5\u6642\u306b2.\u3067\u53d6\u5f97\u3057\u305fStream\u3092\u6307\u5b9a\u3059\u308b\n\n\n\u30b5\u30f3\u30d7\u30eb\u30b3\u30fc\u30c9\n\u3053\u3061\u3089\u3082\u304a\u305d\u3089\u304f\u5b9f\u969b\u306e\u30b3\u30fc\u30c9\u3092\u8aad\u3080\u306e\u304c\u308f\u304b\u308a\u3084\u3059\u3044\u3068\u601d\u3046\u306e\u3067\u30b5\u30f3\u30d7\u30eb\u30b3\u30fc\u30c9\u3092\u4ee5\u4e0b\u306b\u793a\u3057\u307e\u3059\uff0e\n// (1) \u95a2\u6570\u306e\u5f15\u6570\u306bcuda::Stream\u30af\u30e9\u30b9\u306e\u5909\u6570\u3092\u8ffd\u52a0\u3059\u308b\nvoid hoge_func(cv::cuda::GpuMat& img, cv::cuda::Stream& stream_)\n{\n    // (2) CUDA\u306eStream\u3092\u53d6\u5f97\u3059\u308b\n    cudaStream_t stream = cv::cuda::StreamAccessor::getStream(stream_);\n\n    const dim3 threads(32, 8);\n    const dim3 grid(divUp(img.cols, threads.x), divUp(img.rows, threads.y));\n\n    // (3) CUDA\u30ab\u30fc\u30cd\u30eb\u8d77\u52d5\u6642\u306b(2)\u3067\u53d6\u5f97\u3057\u305fStream\u3092\u6307\u5b9a\u3059\u308b\n    hoge_kernel<<<grid, threads, 0, stream>>>(img);\n\n    cudaGetLastError();\n    cudaDeviceSynchronize();\n}\n\n\u524d\u306b\u8ff0\u3079\u305f\u3088\u3046\u306b\n\n\u95a2\u6570\u306e\u5f15\u6570\u306bcuda::Stream\u30af\u30e9\u30b9\u306e\u5909\u6570\u3092\u8ffd\u52a0\u3059\u308b\n\ncuda::StreamAccessor::getStream\u30e1\u30bd\u30c3\u30c9\uff08\u516c\u5f0f\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\uff09\u3092\u4f7f\u3063\u3066CUDA\u306eStream\u3092\u53d6\u5f97\u3059\u308b\nCUDA\u30ab\u30fc\u30cd\u30eb\u8d77\u52d5\u6642\u306b2.\u3067\u53d6\u5f97\u3057\u305fStream\u3092\u6307\u5b9a\u3059\u308b\n\n\u3068\u3044\u3046\u6d41\u308c\u305d\u306e\u307e\u307e\u306a\u306e\u3067\u7c21\u5358\u3067\u3059\u306d\uff01\n\nOpenCV 2.4\u7cfb\u306f\uff1f\n\u5192\u982d\u3067\u8ff0\u3079\u305f\u3088\u3046\u306b\u3053\u3053\u307e\u3067OpenCV 3.x\u7cfb\u3092\u524d\u63d0\u3068\u3057\u305f\u8a71\u306b\u306a\u3063\u3066\u3044\u307e\u3057\u305f\uff0e\u3053\u3053\u307e\u3067\u805e\u3044\u3066\u300c\u3058\u3083\u3042\uff0ccuda::Stream\u30af\u30e9\u30b9\u3063\u3066OpenCV 2.4\u7cfb\u3058\u3083\u4f7f\u3048\u306a\u3044\u306e\uff1f\u300d\u3068\u7591\u554f\u304c\u751f\u3058\u308b\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u304c\u5b89\u5fc3\u3057\u3066\u304f\u3060\u3055\u3044\uff0e\nOpenCV 2.4\u7cfb\u3060\u3068gpu::Stream\u30af\u30e9\u30b9\u304c\u305d\u306e\u5f79\u5272\u3092\u62c5\u3063\u3066\u3044\u307e\u3059\uff0e\n\u305f\u3060\u3057\uff0cGpuMat\u30af\u30e9\u30b9\u306eupload\uff0cdownload\u30e1\u30bd\u30c3\u30c9\u306e\u6271\u3044\u304c\u82e5\u5e72\u7570\u3063\u3066\u3044\u3066\uff0cOpenCV 2.4\u7cfb\u3060\u3068gpu::Stream::enqueueUpload\uff0cgpu::Stream::enqueueDownload\u30e1\u30bd\u30c3\u30c9\u3092\u4f7f\u3046\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\uff0e\n\u5404API\u306e\u8a73\u7d30\u306f\u4ee5\u4e0b\u306eURL\u3092\u53c2\u7167\u304f\u3060\u3055\u3044\u3002\n* http://docs.opencv.org/2.4.13/modules/gpu/doc/data_structures.html#gpu-stream-enqueueupload\n* http://docs.opencv.org/2.4.13/modules/gpu/doc/data_structures.html#gpu-stream-enqueuedownload\n\u3068\u3044\u3046\u3053\u3068\u3067\uff0c2.4\u7cfb\u3060\u3068\u5177\u4f53\u7684\u306b\u3069\u3046\u3044\u3046\u5b9f\u88c5\u306b\u306a\u308b\u304b\u30a4\u30e1\u30fc\u30b8\u3057\u3084\u3059\u3044\u3088\u3046\n3.x\u7cfb\u3068\u5bfe\u6bd4\u3057\u306a\u304c\u3089\u30b5\u30f3\u30d7\u30eb\u30b3\u30fc\u30c9\u3092\u898b\u3066\u307f\u307e\u3057\u3087\u3046\uff0e\n\n\u30b5\u30f3\u30d7\u30eb\u30b3\u30fc\u30c9\uff08OpenCV 3.x\u7cfb\uff09\n// cuda::Stream\u30af\u30e9\u30b9\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u751f\u6210\u3059\u308b\ncv::cuda::Stream stream;\n\n// upload\u30e1\u30bd\u30c3\u30c9\u306bcuda::Stream\u30af\u30e9\u30b9\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u6e21\u3059\nd_src.upload(src, stream);\n\n// GpuMat\u3092\u4f7f\u3063\u305f\u51e6\u7406\n\n// download\u30e1\u30bd\u30c3\u30c9\u306bcuda::Stream\u30af\u30e9\u30b9\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u6e21\u3059\nd_dst.download(dst, stream);\n\n\n\n\u30b5\u30f3\u30d7\u30eb\u30b3\u30fc\u30c9\uff08OpenCV 2.4\u7cfb\uff09\n// gpu::Stream\u30af\u30e9\u30b9\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u751f\u6210\u3059\u308b\ncv::gpu::Stream stream;\n\n// enqueueUpload\u30e1\u30bd\u30c3\u30c9\u3092\u4f7f\u3046\nstream.enqueueUpload(src, d_src);\n\n// GpuMat\u3092\u4f7f\u3063\u305f\u51e6\u7406\n\n// enqueueDownload\u30e1\u30bd\u30c3\u30c9\u3092\u4f7f\u3046\nstream.enqueueDownload(d_dst, dst);\n\n\u3068\u3044\u3046\u3053\u3068\u3067\uff0c2.4\u7cfb\u3067\u3082\u305d\u3053\u307e\u3067\u5927\u304d\u306a\u9055\u3044\u304c\u306a\u304f\uff0cStream\u304c\u4f7f\u3048\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3068\u601d\u3044\u307e\u3059\uff0e\n\n\u304a\u308f\u308a\u306b\n\u3053\u306e\u8a18\u4e8b\u3067\u306fOpenCV\u306ecuda\u30e2\u30b8\u30e5\u30fc\u30eb\u3067\u63d0\u4f9b\u3055\u308c\u3066\u3044\u308bcuda::Stream\u3068\u305d\u306e\u4f7f\u3044\u65b9\u3092\u7d39\u4ecb\u3057\u307e\u3057\u305f\uff0e\ncuda\u30e2\u30b8\u30e5\u30fc\u30eb\u3092\u4f7f\u3046\u6a5f\u4f1a\u304c\u3042\u308c\u3070\u5fc5\u8981\u306b\u5fdc\u3058\u3066cuda::Stream\u3092\u4f7f\u3063\u3066\u307f\u3066\u304f\u3060\u3055\u3044\uff01\n\n\u5099\u8003\n\u7b46\u8005\u306f\u4ee5\u4e0b\u306e\u74b0\u5883\u3067\u52d5\u4f5c\u78ba\u8a8d\u3057\u307e\u3057\u305f\uff0e\n\nCPU\uff1aIntel Core i7-6700HQ\n\u30e1\u30e2\u30ea\uff1a64GB\nGPU\uff1aNVIDIA GeForce GTX 1060 / 6GB\nUbuntu 16.04 LTS(64bit)\nOpenCV 3.1.0\nCUDA 8.0\ngcc 5.4.0\n\n\n\u53c2\u8003URL\n\nHow to Overlap Data Transfers in CUDA C/C++\nGPU Pro Tip: CUDA 7 Streams Simplify Concurrency\n\u30b9\u30c8\u30ea\u30fc\u30e0\u3092\u7528\u3044\u305f\u30b3\u30f3\u30ab\u30ec\u30f3\u30c8\u30ab\u30fc\u30cd\u30eb\u30d7\u30ed\u30b0\u30e9\u30df\u30f3\u30b0\u3068\u6700\u9069\u5316\nstream\u3067\u901f\u304f\u3059\u308b(1) \uff5e\u30a4\u30f3\u30c8\u30ed\nstream\u3067\u901f\u304f\u3059\u308b(2)\nstream\u3067\u901f\u304f\u3059\u308b(3) \uff5e\u304b\u3089\u304f\u308a\nGetting started with OpenCV on GPUs\nComputer Vision on GPU with OpenCV\nHyper-Q\u306e\u9650\u754c\u307e\u3067Stream\u3092\u4e26\u5217\u52d5\u4f5c\u3055\u305b\u3066\u307f\u305f on JetsonTX1\nOpenCV\u306egpu::countNonZero\u3092gpu::Stream\u3067\u9ad8\u901f\u5316\u3059\u308b\n\n\u3053\u306e\u8a18\u4e8b\u306f[OpenCV Advent Calendar 2016](http://qiita.com/advent-calendar/2016/opencv)\u306e4\u65e5\u76ee\u306e\u8a18\u4e8b\u3067\u3059\uff0e\n\n# \u306f\u3058\u3081\u306b\n\u3053\u306e\u8a18\u4e8b\u3067\u306fOpenCV\u306ecuda\u30e2\u30b8\u30e5\u30fc\u30eb\u3067\u63d0\u4f9b\u3055\u308c\u3066\u3044\u308b**cuda::Stream**\u3068\u305d\u306e\u4f7f\u3044\u65b9\u3092\u7d39\u4ecb\u3057\u307e\u3059\uff0e\n\u4eca\u56de\u7d39\u4ecb\u3059\u308b**cuda::Stream**\u3067\u3059\u304c\uff0c\u3082\u3057\u304b\u3057\u305f\u3089OpenCV\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u3067\u898b\u305f\u3053\u3068\u3042\u308b\u65b9\u3044\u3089\u3063\u3057\u3083\u308b\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u306d\uff0e\n\n![opencv_cuda_stream.png](https://qiita-image-store.s3.amazonaws.com/0/31158/30baf4e7-f79b-6660-d7c1-ea93391f5869.png)\n\n\u4ee5\u964d\u306f\u57fa\u672c\u7684\u306bOpenCV 3.x\u7cfb\u3092\u524d\u63d0\u306b\u8aac\u660e\u3057\u307e\u3059\uff08\u6700\u5f8c\u306e\u65b9\u30672.4\u7cfb\u306b\u3064\u3044\u3066\u3082\u8efd\u304f\u89e6\u308c\u307e\u3059\uff09\uff0e\n\n# cuda::Stream\u30af\u30e9\u30b9\u3068\u306f\nCUDA\u306eStream\u306fGPU\u4e0a\u306e\u51e6\u7406\u3092\u7ba1\u7406\u3059\u308b\u30ad\u30e5\u30fc\u306e\u3053\u3068\u3067**\u30ab\u30fc\u30cd\u30eb\u5b9f\u884c\u3084\u30e1\u30e2\u30ea\u8ee2\u9001\u306e\u4e26\u5217\u6027\uff0c\u5b9f\u884c\u9806\u5e8f**\u3092\u5236\u5fa1\u3059\u308b\u305f\u3081\u306b\u7528\u3044\u3089\u308c\u307e\u3059\uff0eCUDA\u306eStream\u306b\u95a2\u3057\u3066\u306f\u4ee5\u4e0b\u306e\u8a18\u4e8b\u3092\u53c2\u7167\u304f\u3060\u3055\u3044\uff0e\n\n* [\u30b9\u30c8\u30ea\u30fc\u30e0\u3092\u7528\u3044\u305f\u30b3\u30f3\u30ab\u30ec\u30f3\u30c8\u30ab\u30fc\u30cd\u30eb\u30d7\u30ed\u30b0\u30e9\u30df\u30f3\u30b0\u3068\u6700\u9069\u5316](http://on-demand.gputechconf.com/gtc/2014/jp/sessions/4004.pdf)\n* [How to Overlap Data Transfers in CUDA C/C++](https://devblogs.nvidia.com/parallelforall/how-overlap-data-transfers-cuda-cc/)\n* [GPU Pro Tip: CUDA 7 Streams Simplify Concurrency](https://devblogs.nvidia.com/parallelforall/gpu-pro-tip-cuda-7-streams-simplify-concurrency/)\n\n\u307e\u305f\uff0cOpenCV\u306ecuda\u30e2\u30b8\u30e5\u30fc\u30eb\u3067\u306f\u3053\u306eStream\u3092\u7c21\u5358\u306b\u5229\u7528\u3059\u308b\u305f\u3081\u306b**cuda::Stream**\u30af\u30e9\u30b9\u3092\u63d0\u4f9b\u3057\u3066\u3044\u307e\u3059\uff0e\n\n## **cuda::Stream**\u30af\u30e9\u30b9\u304c\u63d0\u4f9b\u3059\u308bAPI\n\u5192\u982d\u3067\u3082\u7d39\u4ecb\u3057\u305f**cuda::Stream**\u30af\u30e9\u30b9\u306f\u4ee5\u4e0b\u306eAPI\u3092\u63d0\u4f9b\u3057\u3066\u3044\u307e\u3059\uff0e\n\u5404API\u306e\u8a73\u7d30\u306b\u3064\u3044\u3066\u306f[\u516c\u5f0f\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8](http://docs.opencv.org/3.1.0/d9/df3/classcv_1_1cuda_1_1Stream.html)\u3092\u53c2\u7167\u304f\u3060\u3055\u3044\uff0e\n\n| API                | \u6a5f\u80fd        |\n|:-------------------|:------------|\n| waitForCompletion  | Stream\u306e\u4e00\u9023\u306e\u51e6\u7406\u304c\u7d42\u308f\u308b\u307e\u3067\u73fe\u5728\u306eCPU\u30b9\u30ec\u30c3\u30c9\u3092\u30d6\u30ed\u30c3\u30ad\u30f3\u30b0\u3059\u308b |\n| waitEvent          | Stream\u306e\u30a4\u30d9\u30f3\u30c8\u3092\u5f85\u6a5f\u3059\u308b<br>\u203b\u30a4\u30d9\u30f3\u30c8\u306b\u3064\u3044\u3066\u306f[\u516c\u5f0f\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8](http://docs.opencv.org/3.1.0/d5/d38/classcv_1_1cuda_1_1Event.html)\u3092\u53c2\u7167\u304f\u3060\u3055\u3044 |\n| queryIfComplete    | \u73fe\u5728\u306estream queue\u306e\u51e6\u7406\u304c\u7d42\u308f\u3063\u3066\u3044\u308b\u304b\u3069\u3046\u304b\u3092\u8abf\u3079\u308b |\n| enqueueHostCallback| Stream\u306e\u30ad\u30e5\u30fc\u30a4\u30f3\u30b0\u51e6\u7406\u5b8c\u4e86\u5f8c\u306b\u30db\u30b9\u30c8\u5074\u3067\u5b9f\u884c\u3055\u308c\u308b\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u95a2\u6570\u3092\u8a2d\u5b9a\u3059\u308b |\n\n\n\u307e\u305f\uff0cenqueueHostCallback\u306e\u4f7f\u3044\u65b9\u306f[\u516c\u5f0f\u30c6\u30b9\u30c8\u30b3\u30fc\u30c9](https://github.com/opencv/opencv/blob/3.1.0/modules/cudaarithm/test/test_stream.cpp)\u304c\u53c2\u8003\u306b\u306a\u308b\u3067\u3057\u3087\u3046\uff0e\n\n# **cuda::Stream**\u30af\u30e9\u30b9\u306e\u4f7f\u3044\u65b9\nOpenCV\u306ecuda\u30e2\u30b8\u30e5\u30fc\u30ebAPI\u3067\u660e\u793a\u7684\u306b**cuda::Stream**\u3092\u4f7f\u3046\u306e\u306f\u975e\u5e38\u306b\u7c21\u5358\u3067\u3059\uff0e\n\u57fa\u672c\u7684\u306a\u5b9f\u88c5\u624b\u9806\u306f\u4ee5\u4e0b\u306e\u901a\u308a\u3067\u3059\uff0e\n\n1. **cuda::Stream**\u30af\u30e9\u30b9\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u751f\u6210\u3059\u308b\n1. cuda\u30e2\u30b8\u30e5\u30fc\u30eb\u306eAPI\u306b**cuda::Stream**\u30af\u30e9\u30b9\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u6e21\u3059\n\n\u4e00\u8a00\u3067\u8a00\u3046\u3068**\u300ccuda::Stream\u30af\u30e9\u30b9\u306e\u30a4\u30f3\u30bf\u30f3\u30b9\u3092cuda\u30e2\u30b8\u30e5\u30fc\u30eb\u306eAPI\u306b\u660e\u793a\u7684\u306b\u30bb\u30c3\u30c8\u3059\u308b\u300d**\u3060\u3051\u3067OK\u3067\u3059\uff0e\n\n## \u30b5\u30f3\u30d7\u30eb\u30b3\u30fc\u30c9\n\u304a\u305d\u3089\u304f\u5b9f\u969b\u306e\u30b3\u30fc\u30c9\u3092\u8aad\u3080\u306e\u304c\u308f\u304b\u308a\u3084\u3059\u3044\u3068\u601d\u3046\u306e\u3067\u30b5\u30f3\u30d7\u30eb\u30b3\u30fc\u30c9\u3092\u4ee5\u4e0b\u306b\u793a\u3057\u307e\u3059\uff0e\n\n```cpp:\n// (1) cuda::Stream\u30af\u30e9\u30b9\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u751f\u6210\u3059\u308b\ncv::cuda::Stream stream;\n\n// (2) cuda\u30e2\u30b8\u30e5\u30fc\u30eb\u306eAPI\u306bcuda::Stream\u30af\u30e9\u30b9\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u6e21\u3059\ncv::cuda::cvtColor(d_img, d_gray, cv::COLOR_BGR2GRAY, 0, stream);\n```\n\n# **cuda::Stream**\u3092\u4f7f\u3046\u30e1\u30ea\u30c3\u30c8\n**cuda::Stream**\u3092\u4f7f\u3046\u3053\u3068\u3067\u30c7\u30fc\u30bf\u8ee2\u9001\u3068\u30ab\u30fc\u30cd\u30eb\u5b9f\u884c\u3092\u30aa\u30fc\u30d0\u30fc\u30e9\u30c3\u30d7\u3055\u305b\u308b\u3053\u3068\u304c\u3067\u304d\uff0c\u30c7\u30fc\u30bf\u8ee2\u9001\u6642\u9593\u3092\u96a0\u853d\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3059\uff0e\u3068\u8a00\u3063\u3066\u3082\u30d4\u30f3\u3068\u6765\u306a\u3044\u3068\u601d\u3046\u306e\u3067\u30b5\u30f3\u30d7\u30eb\u30b3\u30fc\u30c9\u3092\u7528\u3044\u306a\u304c\u3089\u8aac\u660e\u3057\u307e\u3059\uff0e\n\n## \u660e\u793a\u7684\u306b**cuda::Stream**\u3092\u30bb\u30c3\u30c8\u3057\u306a\u3044\u5834\u5408\nOpenCV\u306ecuda\u30e2\u30b8\u30e5\u30fc\u30ebAPI\u306b**cuda::Stream**\u30af\u30e9\u30b9\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u660e\u793a\u7684\u306b\u30bb\u30c3\u30c8\u3057\u306a\u3044\u5834\u5408\uff0c\n**Default Stream**\u3092\u4f7f\u3063\u3066\u51e6\u7406\u304c\u884c\u308f\u308c\u307e\u3059\uff0e\u3053\u3053\u3067\u306f\u30b5\u30f3\u30d7\u30eb\u30b3\u30fc\u30c9\u3068[NVIDIA Visual Profiler](https://developer.nvidia.com/nvidia-visual-profiler)\u3067\u53d6\u5f97\u3057\u305f\u30bf\u30a4\u30e0\u30e9\u30a4\u30f3\u3092\u793a\u3057\u307e\u3059\uff0e\n\n### \u30b5\u30f3\u30d7\u30eb\u30b3\u30fc\u30c9\n```cpp:\ncv::Mat src(cv::Size(3840, 2160), CV_8UC3, cv::Scalar(0));\ncv::cuda::HostMem dst1, dst2, dst3;\ncv::cuda::GpuMat d_src;\ncv::cuda::GpuMat d_gray1, d_gray2, d_gray3;\ncv::cuda::GpuMat d_dst1, d_dst2, d_dst3;\n\n// \u30c7\u30d0\u30a4\u30b9\u306b\u8ee2\u9001\nd_src.upload(src);\n\n// GpuMat\u3092\u4f7f\u3063\u305f\u51e6\u7406(Default Stream)\ncv::cuda::cvtColor(d_src, d_gray1, cv::COLOR_BGR2GRAY, 0);\ncv::cuda::threshold(d_gray1, d_dst1, 200, 255, cv::THRESH_BINARY);\n\n//\u30db\u30b9\u30c8\u3078\u8ee2\u9001(Default Stream)\nd_dst1.download(dst1);\n\n// GpuMat\u3092\u4f7f\u3063\u305f\u51e6\u7406(Default Stream)\ncv::cuda::cvtColor(d_src, d_gray2, cv::COLOR_BGR2GRAY, 0);\ncv::cuda::threshold(d_gray2, d_dst2, 200, 255, cv::THRESH_BINARY);\n\n//\u30db\u30b9\u30c8\u306b\u8ee2\u9001(Default Stream)\nd_dst2.download(dst2);\n\n// GpuMat\u3092\u4f7f\u3063\u305f\u51e6\u7406(Default Stream)\ncv::cuda::cvtColor(d_src, d_gray3, cv::COLOR_BGR2GRAY, 0);\ncv::cuda::threshold(d_gray3, d_dst3, 200, 255, cv::THRESH_BINARY);\n\n//\u30db\u30b9\u30c8\u306b\u8ee2\u9001(Default Stream)\nd_dst3.download(dst3);\n```\n\n### \u30bf\u30a4\u30e0\u30e9\u30a4\u30f3\n\u30b5\u30f3\u30d7\u30eb\u30b3\u30fc\u30c9\u3092\u5b9f\u884c\u3057\u305f\u3068\u304d\u306e\u30bf\u30a4\u30e0\u30e9\u30a4\u30f3\u306f\u4ee5\u4e0b\u306e\u901a\u308a\u3067\u3059\uff0e\n\n![timeline_default_stream.png](https://qiita-image-store.s3.amazonaws.com/0/31158/70aca3c3-6b9b-46f1-a35a-737e520cc86c.png)\n\ncuda\u30e2\u30b8\u30e5\u30fc\u30ebAPI\u306b**cuda::Stream**\u30af\u30e9\u30b9\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u660e\u793a\u7684\u306b\u30bb\u30c3\u30c8\u3057\u306a\u3044\u3068\n**Default Stream**\u304c\u4f7f\u308f\u308c\u3066\u3044\u3066\u30c7\u30fc\u30bf\u8ee2\u9001\u3084\u30ab\u30fc\u30cd\u30eb\u5b9f\u884c\u304c\u4e26\u5217\u306b\u884c\u308f\u308c\u3066\u306a\u3044\u3053\u3068\u304c\u308f\u304b\u308a\u307e\u3059\uff0e\n\n## \u660e\u793a\u7684\u306b**cuda::Stream**\u3092\u30bb\u30c3\u30c8\u3059\u308b\u5834\u5408\n\u3053\u3053\u3067\u306f**cuda::Stream**\u3092\u4f7f\u3063\u305f\u5834\u5408\u306e\u30b5\u30f3\u30d7\u30eb\u30b3\u30fc\u30c9\u3068\u30bf\u30a4\u30e0\u30e9\u30a4\u30f3\u3092\u793a\u3057\u307e\u3059\uff0e\n\n### \u30b5\u30f3\u30d7\u30eb\u30b3\u30fc\u30c9\n```cpp:\ncv::Mat src(cv::Size(3840, 2160), CV_8UC3, cv::Scalar(0));\ncv::cuda::HostMem dst1, dst2, dst3;\ncv::cuda::GpuMat d_src;\ncv::cuda::GpuMat d_gray1, d_gray2, d_gray3;\ncv::cuda::GpuMat d_dst1, d_dst2, d_dst3;\n\ncv::cuda::Stream stream[3];\n\n// \u30c7\u30d0\u30a4\u30b9\u306b\u8ee2\u9001\nd_src.upload(src);\n\n// GpuMat\u3092\u4f7f\u3063\u305f\u51e6\u7406(cuda::Stream)\ncv::cuda::cvtColor(d_src, d_gray1, cv::COLOR_BGR2GRAY, 0, stream[0]);\ncv::cuda::threshold(d_gray1, d_dst1, 200, 255, cv::THRESH_BINARY, stream[0]);\n\n//\u30db\u30b9\u30c8\u306b\u8ee2\u9001(cuda::Stream)\nd_dst1.download(dst1, stream[0]);\n\n// GpuMat\u3092\u4f7f\u3063\u305f\u51e6\u7406(cuda::Stream)\ncv::cuda::cvtColor(d_src, d_gray2, cv::COLOR_BGR2GRAY, 0, stream[1]);\ncv::cuda::threshold(d_gray2, d_dst2, 200, 255, cv::THRESH_BINARY, stream[1]);\n\n//\u30db\u30b9\u30c8\u306b\u8ee2\u9001(cuda::Stream)\nd_dst2.download(dst2, stream[1]);\n\n// GpuMat\u3092\u4f7f\u3063\u305f\u51e6\u7406(cuda::Stream)\ncv::cuda::cvtColor(d_src, d_gray3, cv::COLOR_BGR2GRAY, 0, stream[2]);\ncv::cuda::threshold(d_gray3, d_dst3, 200, 255, cv::THRESH_BINARY, stream[2]);\n\n//\u30db\u30b9\u30c8\u306b\u8ee2\u9001(cuda::Stream)\nd_dst3.download(dst3, stream[2]);\n```\n\n### \u30bf\u30a4\u30e0\u30e9\u30a4\u30f3\n\u30b5\u30f3\u30d7\u30eb\u30b3\u30fc\u30c9\u3092\u5b9f\u884c\u3057\u305f\u3068\u304d\u306e\u30bf\u30a4\u30e0\u30e9\u30a4\u30f3\u306f\u4ee5\u4e0b\u306e\u901a\u308a\u3067\u3059\uff0e\n\n![timeline_multi_stream1.png](https://qiita-image-store.s3.amazonaws.com/0/31158/1e21c85e-ee6b-c6b8-cbc3-0112e6fd2e9a.png)\n\n\u3053\u306e\u30b5\u30f3\u30d7\u30eb\u30b3\u30fc\u30c9\u3067\u306f\u8907\u6570\u306e**cuda::Stream**\u3092\u4f7f\u3063\u3066\u30c7\u30fc\u30bf\u8ee2\u9001\u3084\u30ab\u30fc\u30cd\u30eb\u5b9f\u884c\u306b\u5272\u308a\u5f53\u3066\u308b\u3053\u3068\u3067\u30c7\u30fc\u30bf\u8ee2\u9001\u3068\u30ab\u30fc\u30cd\u30eb\u5b9f\u884c\u3092\u30aa\u30fc\u30d0\u30fc\u30e9\u30c3\u30d7\u3055\u305b\u308b\u3053\u3068\u304c\u3067\u304d\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308a\u307e\u3059\uff0e\n\n\u307e\u305f\uff0c\u30b5\u30f3\u30d7\u30eb\u30b3\u30fc\u30c9\u306f\u5272\u611b\u3057\u307e\u3059\u304c\uff0c\u4eca\u56de\u7528\u3044\u305fGeForce GTX 1060\u306fCopy Engine\u30922\u3064\u6301\u3063\u3066\u3044\u308b\u306e\u3067\uff0c\u51e6\u7406\u306b\u3088\u3063\u3066\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b**\u30c7\u30fc\u30bf\u8ee2\u9001\uff08\u30db\u30b9\u30c8\u2192\u30c7\u30d0\u30a4\u30b9\uff09**\u3068**\u30c7\u30fc\u30bf\u8ee2\u9001\uff08\u30c7\u30d0\u30a4\u30b9\u2192\u30db\u30b9\u30c8\uff09**\u3092\u30aa\u30fc\u30d0\u30fc\u30e9\u30c3\u30d7\u3055\u305b\u308b\u3053\u3068\u3082\u3067\u304d\u307e\u3059\uff0e\n\n![timeline_multi_stream2.png](https://qiita-image-store.s3.amazonaws.com/0/31158/d8d348df-c067-0a1f-fd65-a12e657a3f3b.png)\n\n\n# **cuda::Stream**\u30af\u30e9\u30b9\u3092\u4f7f\u3063\u305f\u5b9f\u88c5\u65b9\u6cd5\n\u3053\u3053\u307e\u3067\u306fOpenCV\u306ecuda\u30e2\u30b8\u30e5\u30fc\u30eb\u306eAPI\u3067**cuda::Stream**\u3092\u660e\u793a\u7684\u306b\u4f7f\u3046\u304a\u8a71\u3067\u3057\u305f\uff0e\n\u4e00\u65b9\u3067OpenCV\u3068\u9023\u643a\u3057\u305f\u81ea\u4f5cCUDA\u30ab\u30fc\u30cd\u30eb\u3067**cuda::Stream**\u3092\u5229\u7528\u3057\u305f\u3044\u30b1\u30fc\u30b9\u3082\u3042\u308b\u3068\u601d\u3044\u307e\u3059\uff0e\n\n\u57fa\u672c\u7684\u306a\u5b9f\u88c5\u624b\u9806\u306f\u4ee5\u4e0b\u306e\u901a\u308a\u3067\u3059\uff0e\n\n1. \u95a2\u6570\u306e\u5f15\u6570\u306b**cuda::Stream**\u30af\u30e9\u30b9\u306e\u5909\u6570\u3092\u8ffd\u52a0\u3059\u308b\n1. <code>cuda&#058;&#058;StreamAccessor&#058;&#058;getStream</code>\u30e1\u30bd\u30c3\u30c9\uff08[\u516c\u5f0f\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8](http://docs.opencv.org/3.1.0/d6/df1/structcv_1_1cuda_1_1StreamAccessor.html#a5830d99635f08b462a429771bfad71a9)\uff09\u3092\u4f7f\u3063\u3066CUDA\u306eStream\u3092\u53d6\u5f97\u3059\u308b\n1. CUDA\u30ab\u30fc\u30cd\u30eb\u8d77\u52d5\u6642\u306b2.\u3067\u53d6\u5f97\u3057\u305fStream\u3092\u6307\u5b9a\u3059\u308b\n\n## \u30b5\u30f3\u30d7\u30eb\u30b3\u30fc\u30c9\n\u3053\u3061\u3089\u3082\u304a\u305d\u3089\u304f\u5b9f\u969b\u306e\u30b3\u30fc\u30c9\u3092\u8aad\u3080\u306e\u304c\u308f\u304b\u308a\u3084\u3059\u3044\u3068\u601d\u3046\u306e\u3067\u30b5\u30f3\u30d7\u30eb\u30b3\u30fc\u30c9\u3092\u4ee5\u4e0b\u306b\u793a\u3057\u307e\u3059\uff0e\n\n```cpp:\n// (1) \u95a2\u6570\u306e\u5f15\u6570\u306bcuda::Stream\u30af\u30e9\u30b9\u306e\u5909\u6570\u3092\u8ffd\u52a0\u3059\u308b\nvoid hoge_func(cv::cuda::GpuMat& img, cv::cuda::Stream& stream_)\n{\n    // (2) CUDA\u306eStream\u3092\u53d6\u5f97\u3059\u308b\n    cudaStream_t stream = cv::cuda::StreamAccessor::getStream(stream_);\n\n    const dim3 threads(32, 8);\n    const dim3 grid(divUp(img.cols, threads.x), divUp(img.rows, threads.y));\n\n    // (3) CUDA\u30ab\u30fc\u30cd\u30eb\u8d77\u52d5\u6642\u306b(2)\u3067\u53d6\u5f97\u3057\u305fStream\u3092\u6307\u5b9a\u3059\u308b\n    hoge_kernel<<<grid, threads, 0, stream>>>(img);\n\n    cudaGetLastError();\n    cudaDeviceSynchronize();\n}\n```\n\n\u524d\u306b\u8ff0\u3079\u305f\u3088\u3046\u306b\n\n1. \u95a2\u6570\u306e\u5f15\u6570\u306b**cuda::Stream**\u30af\u30e9\u30b9\u306e\u5909\u6570\u3092\u8ffd\u52a0\u3059\u308b\n1. <code>cuda&#058;&#058;StreamAccessor&#058;&#058;getStream</code>\u30e1\u30bd\u30c3\u30c9\uff08[\u516c\u5f0f\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8](http://docs.opencv.org/3.1.0/d6/df1/structcv_1_1cuda_1_1StreamAccessor.html#a5830d99635f08b462a429771bfad71a9)\uff09\u3092\u4f7f\u3063\u3066CUDA\u306eStream\u3092\u53d6\u5f97\u3059\u308b\n1. CUDA\u30ab\u30fc\u30cd\u30eb\u8d77\u52d5\u6642\u306b2.\u3067\u53d6\u5f97\u3057\u305fStream\u3092\u6307\u5b9a\u3059\u308b\n\n\u3068\u3044\u3046\u6d41\u308c\u305d\u306e\u307e\u307e\u306a\u306e\u3067\u7c21\u5358\u3067\u3059\u306d\uff01\n\n# OpenCV 2.4\u7cfb\u306f\uff1f\n\u5192\u982d\u3067\u8ff0\u3079\u305f\u3088\u3046\u306b\u3053\u3053\u307e\u3067OpenCV 3.x\u7cfb\u3092\u524d\u63d0\u3068\u3057\u305f\u8a71\u306b\u306a\u3063\u3066\u3044\u307e\u3057\u305f\uff0e\u3053\u3053\u307e\u3067\u805e\u3044\u3066\u300c\u3058\u3083\u3042\uff0c**cuda::Stream**\u30af\u30e9\u30b9\u3063\u3066OpenCV 2.4\u7cfb\u3058\u3083\u4f7f\u3048\u306a\u3044\u306e\uff1f\u300d\u3068\u7591\u554f\u304c\u751f\u3058\u308b\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u304c\u5b89\u5fc3\u3057\u3066\u304f\u3060\u3055\u3044\uff0e\nOpenCV 2.4\u7cfb\u3060\u3068[**gpu::Stream**\u30af\u30e9\u30b9](http://docs.opencv.org/2.4.13/modules/gpu/doc/data_structures.html#gpu-stream)\u304c\u305d\u306e\u5f79\u5272\u3092\u62c5\u3063\u3066\u3044\u307e\u3059\uff0e\n\n\u305f\u3060\u3057\uff0cGpuMat\u30af\u30e9\u30b9\u306eupload\uff0cdownload\u30e1\u30bd\u30c3\u30c9\u306e\u6271\u3044\u304c\u82e5\u5e72\u7570\u3063\u3066\u3044\u3066\uff0cOpenCV 2.4\u7cfb\u3060\u3068<code>gpu&#058;&#058;Stream::enqueueUpload</code>\uff0c<code>gpu&#058;&#058;Stream::enqueueDownload</code>\u30e1\u30bd\u30c3\u30c9\u3092\u4f7f\u3046\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\uff0e\n\n\u5404API\u306e\u8a73\u7d30\u306f\u4ee5\u4e0b\u306eURL\u3092\u53c2\u7167\u304f\u3060\u3055\u3044\u3002\n* <http://docs.opencv.org/2.4.13/modules/gpu/doc/data_structures.html#gpu-stream-enqueueupload>\n* <http://docs.opencv.org/2.4.13/modules/gpu/doc/data_structures.html#gpu-stream-enqueuedownload>\n\n\u3068\u3044\u3046\u3053\u3068\u3067\uff0c2.4\u7cfb\u3060\u3068\u5177\u4f53\u7684\u306b\u3069\u3046\u3044\u3046\u5b9f\u88c5\u306b\u306a\u308b\u304b\u30a4\u30e1\u30fc\u30b8\u3057\u3084\u3059\u3044\u3088\u3046\n3.x\u7cfb\u3068\u5bfe\u6bd4\u3057\u306a\u304c\u3089\u30b5\u30f3\u30d7\u30eb\u30b3\u30fc\u30c9\u3092\u898b\u3066\u307f\u307e\u3057\u3087\u3046\uff0e\n\n## \u30b5\u30f3\u30d7\u30eb\u30b3\u30fc\u30c9\uff08OpenCV 3.x\u7cfb\uff09\n\n```cpp:\n// cuda::Stream\u30af\u30e9\u30b9\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u751f\u6210\u3059\u308b\ncv::cuda::Stream stream;\n\n// upload\u30e1\u30bd\u30c3\u30c9\u306bcuda::Stream\u30af\u30e9\u30b9\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u6e21\u3059\nd_src.upload(src, stream);\n\n// GpuMat\u3092\u4f7f\u3063\u305f\u51e6\u7406\n\n// download\u30e1\u30bd\u30c3\u30c9\u306bcuda::Stream\u30af\u30e9\u30b9\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u6e21\u3059\nd_dst.download(dst, stream);\n\n```\n\n## \u30b5\u30f3\u30d7\u30eb\u30b3\u30fc\u30c9\uff08OpenCV 2.4\u7cfb\uff09\n\n```cpp:\n// gpu::Stream\u30af\u30e9\u30b9\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u751f\u6210\u3059\u308b\ncv::gpu::Stream stream;\n\n// enqueueUpload\u30e1\u30bd\u30c3\u30c9\u3092\u4f7f\u3046\nstream.enqueueUpload(src, d_src);\n\n// GpuMat\u3092\u4f7f\u3063\u305f\u51e6\u7406\n\n// enqueueDownload\u30e1\u30bd\u30c3\u30c9\u3092\u4f7f\u3046\nstream.enqueueDownload(d_dst, dst);\n```\n\n\u3068\u3044\u3046\u3053\u3068\u3067\uff0c2.4\u7cfb\u3067\u3082\u305d\u3053\u307e\u3067\u5927\u304d\u306a\u9055\u3044\u304c\u306a\u304f\uff0cStream\u304c\u4f7f\u3048\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3068\u601d\u3044\u307e\u3059\uff0e\n\n# \u304a\u308f\u308a\u306b\n\u3053\u306e\u8a18\u4e8b\u3067\u306fOpenCV\u306ecuda\u30e2\u30b8\u30e5\u30fc\u30eb\u3067\u63d0\u4f9b\u3055\u308c\u3066\u3044\u308b**cuda::Stream**\u3068\u305d\u306e\u4f7f\u3044\u65b9\u3092\u7d39\u4ecb\u3057\u307e\u3057\u305f\uff0e\ncuda\u30e2\u30b8\u30e5\u30fc\u30eb\u3092\u4f7f\u3046\u6a5f\u4f1a\u304c\u3042\u308c\u3070\u5fc5\u8981\u306b\u5fdc\u3058\u3066**cuda::Stream**\u3092\u4f7f\u3063\u3066\u307f\u3066\u304f\u3060\u3055\u3044\uff01\n\n# \u5099\u8003\n\u7b46\u8005\u306f\u4ee5\u4e0b\u306e\u74b0\u5883\u3067\u52d5\u4f5c\u78ba\u8a8d\u3057\u307e\u3057\u305f\uff0e\n\n* CPU\uff1aIntel Core i7-6700HQ\n* \u30e1\u30e2\u30ea\uff1a64GB\n* GPU\uff1aNVIDIA GeForce GTX 1060 / 6GB\n* Ubuntu 16.04 LTS(64bit)\n* [OpenCV 3.1.0](https://github.com/Itseez/opencv/releases/tag/3.1.0)\n* CUDA 8.0\n* gcc 5.4.0\n\n# \u53c2\u8003URL\n* [How to Overlap Data Transfers in CUDA C/C++](https://devblogs.nvidia.com/parallelforall/how-overlap-data-transfers-cuda-cc/)\n* [GPU Pro Tip: CUDA 7 Streams Simplify Concurrency](https://devblogs.nvidia.com/parallelforall/gpu-pro-tip-cuda-7-streams-simplify-concurrency/)\n* [\u30b9\u30c8\u30ea\u30fc\u30e0\u3092\u7528\u3044\u305f\u30b3\u30f3\u30ab\u30ec\u30f3\u30c8\u30ab\u30fc\u30cd\u30eb\u30d7\u30ed\u30b0\u30e9\u30df\u30f3\u30b0\u3068\u6700\u9069\u5316](http://on-demand.gputechconf.com/gtc/2014/jp/sessions/4004.pdf)\n* [stream\u3067\u901f\u304f\u3059\u308b(1) \uff5e\u30a4\u30f3\u30c8\u30ed](http://fareastprogramming.hatenadiary.jp/entry/2016/10/21/220352)\n* [stream\u3067\u901f\u304f\u3059\u308b(2)](http://fareastprogramming.hatenadiary.jp/entry/2016/10/21/221314)\n* [stream\u3067\u901f\u304f\u3059\u308b(3) \uff5e\u304b\u3089\u304f\u308a](http://fareastprogramming.hatenadiary.jp/entry/2016/10/21/225438)\n* [Getting started with OpenCV on GPUs](http://on-demand.gputechconf.com/gtc/2013/webinar/gtc-express-itseez-opencv-webinar.pdf)\n* [Computer Vision on GPU with OpenCV](http://www.gipsa-lab.grenoble-inp.fr/summerschool/gpu2011/fichiers/6_Obukhov_OpenCV_rev5.pdf)\n* [Hyper-Q\u306e\u9650\u754c\u307e\u3067Stream\u3092\u4e26\u5217\u52d5\u4f5c\u3055\u305b\u3066\u307f\u305f on JetsonTX1](http://wazalabo.com/hyper-q-on-jetsontx1.html)\n* [OpenCV\u306egpu::countNonZero\u3092gpu::Stream\u3067\u9ad8\u901f\u5316\u3059\u308b](http://phst.hateblo.jp/entry/2016/10/05/140102)\n", "tags": ["OpenCV", "CUDA", "\u753b\u50cf\u51e6\u7406", "C++"]}