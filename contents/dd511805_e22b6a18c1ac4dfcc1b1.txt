{"tags": ["h2o"], "context": "apache+mod_php\u3067\u52d5\u3044\u3066\u3044\u305f\u30b5\u30fc\u30d3\u30b9\u3092H2O\u306b\u7f6e\u304d\u63db\u3048\u305f\u3068\u304d\u306b\u884c\u3063\u305f\u3053\u3068\u306b\n\u3064\u3044\u3066\u66f8\u304d\u307e\u3059\u3002\n\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\nH2O\u306f\u4ee5\u4e0b\u306e\u624b\u9806\u3067\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u307e\u3057\u305f\u3002OS\u306fAmazon Linux 2016.09\u3092\u4f7f\u3063\u3066\u3044\u307e\u3059\u3002\nCentOS 6\u7cfb\u306e\u30b5\u30fc\u30d0\u30fc\u3067\u3082\u540c\u3058\u69d8\u306a\u624b\u9806\u306b\u306a\u308b\u3068\u601d\u3044\u307e\u3059\u3002\n\u307e\u305a\u306f\u5fc5\u8981\u306a\u30e9\u30a4\u30d6\u30e9\u30ea\u7b49\u3092yum\u3067\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u307e\u3059\u3002\n$ yum -y gcc gcc-c++ curl curl-devel libarchive libarchive-devel expat expat-devel libyaml-devel zlib zlib-devel openssl-devel libyaml-devel bison \n\nCMake\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u3066\u304d\u3066\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3092\u884c\u3044\u307e\u3059\u3002\n    cd /usr/local/src\n    wget http://www.cmake.org/files/v3.0/cmake-3.6.2.tar.gz\n    tar -xvf cmake-3.6.2.tar.gz\n    cd cmake-3.6\n            ./bootstrap --prefix=/usr \\\n            --system-libs       \\\n            --mandir=/share/man \\\n            --no-system-jsoncpp \\\n            --docdir=/share/doc/cmake-3.6.2\n    make\n    make install\n\nH2O\u3092github\u304b\u3089clone\u3057\u3066\u304d\u3066\u3001\u30d3\u30eb\u30c9\u3057\u307e\u3059\u3002\u4eca\u56de\u306fv2.1.0-beta4\u3092\u30d3\u30eb\u30c9\u3057\u307e\u3057\u305f\u3002\n    cd /usr/local/src\n    git clone https://github.com/h2o/h2o.git\n    git checkout refs/tags/v2.1.0-beta4\n \u3000 git submodule update --init --recursive\n    cmake -DWITH_BUNDLED_SSL=on .\n    make\n    sudo make install\n\n\nPHP\u306e\u8a2d\u5b9a\u306b\u3064\u3044\u3066\napache\u3067\u306fmod_php\u3067PHP\u3092\u5b9f\u884c\u3059\u308b\u3053\u3068\u304c\u591a\u3044\u3068\u601d\u3044\u307e\u3059\u3002H2O\u306b\u3082FastCGI\u306e\u6a5f\u80fd\u306f\n\u3042\u308a\u307e\u3059\u304c\u3001\u4eca\u56de\u306fphp-fpm\u3092\u4f7f\u3063\u3066\u3001unixsocket\u3067H2O\u3068\u901a\u4fe1\u3059\u308b\u3053\u3068\u306b\u3057\u307e\u3057\u305f\u3002\n\u4f8b\u3048\u3070\u306ewordpress\u306e\u8a2d\u5b9a\u306f\u8a2d\u5b9a\u306f\u4ee5\u4e0b\u306e\u69d8\u306b\u306a\u308a\u307e\u3059\u3002\n\n/etc/h2o/conf/h2o.conf\npid-file: /var/run/h2o.pid\nuser: nobody\n\nerror-log: /var/log/h2o/error.log\n\n# PHP\u306e\u8a2d\u5b9a\nfile.custom-handler:\n  extension: .php\n  access-log:\n    path: /var/www/logs/foo/fpm-access.log\n    format: \"%h %l %u %t \\\"%r\\\" %s %b \\\"%{Referer}i\\\" \\\"%{User-agent}i\\\" \\\"%{X-Forwarded-For}i\\\" %{process-time}x %{duration}x\"\n  fastcgi.connect:\n    port: /var/run/php-fpm/php-fpm.sock\n    type: unix\n\n# \u30c9\u30e1\u30a4\u30f3\u8a2d\u5b9a\nhosts:\n  \"foo.example.com:80\":\n    listen:\n      port: 80\n    access-log:\n      path: /var/www/logs/foo/access.log\n      format: \"%h %l %u %t \\\"%r\\\" %s %b \\\"%{Referer}i\\\" \\\"%{User-agent}i\\\" \\\"%{X-Forwarded-For}i\\\" %{process-time}x %{duration}x\"\n    paths:\n      \"/\":\n        file.dir: /var/www/html/foo/\n        redirect:\n          url: /index.php/\n          internal: YES\n          status: 307\n\n\n\nRewrite\u7b49\u306e\u8a2d\u5b9a\u306b\u3064\u3044\u3066\nphp\u3092\u52d5\u304b\u3059\u307e\u3067\u306f\u4e0a\u8a18\u306e\u8a2d\u5b9a\u3067\u3044\u3044\u306e\u3067\u3059\u304c\u3001\u79fb\u884c\u4f5c\u696d\u3068\u306a\u308b\u3068\u4eca\u307e\u3067Apache\u304c\u884c\u3063\u3066\u3044\u305f\n\u51e6\u7406\u3092H2O\u306b\u79fb\u3059\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\u305d\u306e\u4e2d\u3067\u6700\u3082\u4ee3\u8868\u7684\u306a\u306e\u304c\u3001apache\u306emod_rewrite\u306a\u306e\n\u3067\u306f\u306a\u3044\u304b\u3068\u601d\u3044\u307e\u3059\u3002\u7c21\u5358\u306a\u8a2d\u5b9a\u306a\u3089\u3001H2O\u306econf\u306b\u3082\u66f8\u304f\u3053\u3068\u304c\u51fa\u6765\u307e\u3059\u304c\u3001\u6b63\u898f\u8868\u73fe\n\u3067\u30de\u30c3\u30c1\u3057\u305f\u5185\u5bb9\u3092\u3082\u3068\u306brewrite\u3092\u3057\u3066\u3044\u308b\u5834\u5408\u306fh2o\u306emruby handler\u3092\u4f7f\u3063\u3066\u5b9f\u73fe\u3067\u304d\u307e\u3059\u3002\n\u4f8b\u3048\u3070apache\u3067\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u30ea\u30c0\u30a4\u30ec\u30af\u30c8\u8a2d\u5b9a\u306fH2O\u3067\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u66f8\u3051\u307e\u3059\u3002\nRewriteRule   ^/aaa/test/                                https://foo.example.com/aaa/                       [R=301,L]\nRewriteRule   ^/bbb/test/                                https://foo.example.com/bbb/                       [R=301,L]\n\n\n\n/etc/h2o/hook/rerirect_rule.rb\nclass RedirectRule\n\n  def call(env)\n    if !/^(aaaa|bbb)\\/test/.match(env['PATH_INFO'])\n      redirect_path = $1\n      return [301, {'Location' => \"http://foo.example.com#{redirect_path}\"}, []]\n    else\n      [399, {}, []]\n    end\n  end\nend\n\nRedirectRule.new\n\n\nmruby\u3067\u306e\u30cf\u30f3\u30c9\u30e9\u30fc\u306e\u8a18\u8ff0\u306frack\u306e\u30a4\u30f3\u30bf\u30fc\u30d5\u30a7\u30fc\u30b9\u306b\u6cbf\u3063\u305f\u3082\u306e\u306b\u306a\u308a\u307e\u3059\u3002\nreturn \u3059\u308b\u914d\u5217\u306e\uff11\u3064\u76ee\u304c\u30b9\u30c6\u30fc\u30bf\u30b9\u30b3\u30fc\u30c9\u30012\u3064\u76ee\u304c\u30ec\u30b9\u30dd\u30f3\u30b9\u30d8\u30c3\u30c0\u30fc\u30013\u3064\u76ee\u304c\nBody\u306b\u306a\u308a\u307e\u3059\u3002\u30b9\u30c6\u30fc\u30bf\u30b9399\u306fH2O\u3067\u4f7f\u3048\u308b\u7279\u5225\u306a\u30b9\u30c6\u30fc\u30bf\u30b9\u3067\u3001\u6b21\u306e\u30cf\u30f3\u30c9\u30e9\u30fc\u306b\n\u51e6\u7406\u3092\u59d4\u8b72\u3057\u307e\u3059\u3002\n\u307e\u305f\u5f15\u6570\u306eenv\u306fhash\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3067\u30ad\u30fc\u306f\u4ee5\u4e0b\u306e\u5185\u5bb9\u306b\u306a\u308a\u307e\u3059\u3002\n\n[\"REQUEST_METHOD\", \"SCRIPT_NAME\", \"PATH_INFO\", \"QUERY_STRING\", \"SERVER_NAME\", \"SERVER_ADDR\", \"SERVER_PORT\", \"HTTP_HOST\", \"REMOTE_ADDR\", \"REMOTE_PORT\", \"USER_NAME\", \"ENV_NAME\", \"HTTP_ACCEPT\", \"HTTP_COOKIE\", \"HTTP_USER_AGENT\", \"HTTP_CACHE_CONTROL\", \"HTTP_ACCEPT_ENCODING\", \"HTTP_ACCEPT_LANGUAGE\", \"HTTP_UPGRADE_INSECURE_REQUESTS\", \"rack.url_scheme\", \"rack.multithread\", \"rack.multiprocess\", \"rack.run_once\", \"rack.hijack?\", \"rack.errors\", \"SERVER_SOFTWARE\"]\n\nH2O\u306e\u524d\u6bb5\u306bRP\u304c\u3042\u308b\u5834\u5408\u306f\u3082\u3063\u3068\u30d8\u30c3\u30c0\u30fc\n\u304c\u5897\u3048\u308b\u3068\u601d\u3044\u307e\u3059\u304c\u3001rewrite\u7b49\u306e\u4f5c\u696d\u3067\u826f\u304f\u4f7f\u3046\u306e\u306f\u3001\"PATH_INFO\"\u3068\"HTTP_USER_AGENT\"\u3060\u3068\u601d\u3044\u307e\u3059\u3002\n\u4ed6\u306e\u30b5\u30fc\u30d0\u30fc\u306e\u5bfe\u3057\u3066mod_rewrite\u3067proxy\u3092mruby\u3067\u5b9f\u73fe\u3059\u308b\u5834\u5408\u306fhttp_request\u95a2\u6570\u3092\u4f7f\u7528\u3057\u307e\u3059\u3002\nRewriteRule ^/contact(.*)$  http://foo.example.net/contact$1                 [QSA,NE,P,L]\n\n\n/etc/h2o/hook/proxy_rule.rb\nclass ProxyRule\n  def call(env)\n    if /^\\/contact(\\.*)/.match(env[\"PATH_INFO\"])\n      rewrite_path = $1\n      headers = {}\n      env.each do |key, value|\n        if /^HTTP_/.match(key)\n          headers[$'] = value\n        end\n      end\n      headers['Content-Type'] = env['CONTENT_TYPE']\n      headers['X-Forwarded-Host'] = env['HTTP_HOST']\n      headers['X-Forwarded-For'] = env['REMOTE_ADDR']\n      headers['User-Agent'] = env['HTTP_USER_AGENT']\n      return  http_request(\n                \"http://foo.example.net/contact#{rewrite_path}?#{env[\"QUERY_STRING\"]}\",\n                method:  env[\"REQUEST_METHOD\"],\n                headers: headers,\n                body:    env[\"rack.input\"]\n              ).join\n    end\n  end\nend\n\nProxyRule.new\n\n\nenv\u306b\u5165\u3063\u3066\u304d\u3066\u3044\u308b\u30d8\u30c3\u30c0\u30fc\u60c5\u5831\u306f\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u304b\u3089\u9001\u3089\u308c\u3066\u3044\u308b\u30d8\u30c3\u30c0\u30fc\u306e\u60c5\u5831\u3068\u9055\u3063\u3066\u304d\u3066\u3044\u307e\u3059\u306e\u3067\u3001\nproxy\u5148\u306e\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306b\u3088\u3063\u3066\u306f\u3001\u5fc5\u8981\u306a\u30d8\u30c3\u30c0\u30fc\u60c5\u5831\u3092\u5408\u308f\u305b\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\u4e0a\u8a18\u306e\u4f8b\u3067\u306fContent-Type\n\u306a\u3069\u306e\u30d8\u30c3\u30c0\u30fc\u3092\u66f8\u304d\u63db\u3048\u3066\u3044\u307e\u3059\u3002\n\n\u30d8\u30c3\u30c0\u30fc\u60c5\u5831\u306e\u8ffd\u52a0\u306b\u3064\u3044\u3066\n\u30d6\u30e9\u30a6\u30b6\u304c\u30da\u30fc\u30b8\u3092\u56de\u904a\u3057\u3066\u3044\u308b\u969b\u306b\u540c\u3058\u753b\u50cf\u3084CSS\u3092\u8aad\u307f\u8fbc\u307e\u306a\u3044\u3088\u3046\u306bexpire\u30d8\u30c3\u30c0\u30fc\u3092\u4ed8\u52a0\u3059\u308b\u3053\u3068\u304c\n\u3042\u308a\u307e\u3059\u3002Apache\u306e\u5834\u5408\u3067\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u8a18\u8ff0\u3057\u307e\u3059\u3002\n    ExpiresActive On\n    <FilesMatch \"\\.(gif|jpg|png|js)$\">\n        ExpiresDefault \"access plus 1 month\"\n        Header set Cache-Control \"max-age=604800\"\n    </FilesMatch>\n\nH2O\u3067\u306f\u5148\u307b\u3069\u306erewrite\u3068\u540c\u3058\u3088\u3046\u306bmruby handler\u3067\u5236\u5fa1\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\n/etc/h2o/hook/add_expire_header.rb\nclass AddExpireHeader\n  def call(env)\n    headers = {}\n    if /\\.(css|js|png|jpg|gif)/.match(env[\"PATH_INFO\"])\n      headers[\"cache-control\"] = \"max-age=86400\"\n      headers[\"Expires\"] = \"30d\"\n    end\n    [399, headers, []]\n  end\nend\n\nAddExpireHeader.new\n\n\n\n\u30a2\u30af\u30bb\u30b9\u5236\u9650\u306b\u3064\u3044\u3066\n\u7ba1\u7406\u753b\u9762\u306a\u3069\u3001\u7279\u5b9a\u306eIP\u4ee5\u5916\u306f\u95b2\u89a7\u3055\u305b\u305f\u3044\u306a\u304f\u5834\u5408\u3082\u51fa\u3066\u304d\u307e\u3059\u3002Apache\u3067\u306f\u4ee5\u4e0b\u306e\u65b9\u6cd5\u3067\u5236\u5fa1\u3057\u3066\u3044\u307e\u3059\u3002\n    <Location /wp_login.php>\n        Require ip 169.254.0.0/24\n        Require ip 10.1.0.0/16\n    </Location>\n\n    <Location /wp_admin>\n        Require ip 169.254.0.0/24\n        Require ip 10.1.0.0/16\n    </Location>\n\nH2O\u3067\u306f\u3001ACL\u3092\u884c\u3046DSL\u304c\u3042\u308b\u306e\u3067\u3001\u305d\u308c\u3092\u4f7f\u7528\u3057\u3066\u3001\u30a2\u30af\u30bb\u30b9\u5236\u9650\u3092\u884c\u3046\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\n/etc/h2o/hook/acl.rb\nALLOW_HOSTS = %w(\n169.254.0.0/24 10.1.0.0/16\n)\n\nrequire \"trie_addr.rb\"\ntrie = TrieAddr.new.add(ALLOW_HOSTS)\n\nacl {\n  deny { !trie.match?(addr) && (path.start_with?(\"/wp-login\") ||  path =~ /wp-admin/) }\n}\n\n\n\n\n\u307e\u3068\u3081\napache\u306econf\u306e\u4e00\u90e8\u3092H2O\u3067\u5b9f\u73fe\u3059\u308b\u65b9\u6cd5\u3092\u898b\u3066\u304d\u307e\u3057\u305f\u3002\u7279\u306b\u5f53\u521d\u306fPHP\u30d5\u30a1\u30a4\u30eb\u3092fast-cgi\u3067\u52d5\u304b\u3057\u3066\n\u3044\u305f\u3088\u3046\u306a\u30b5\u30fc\u30d3\u30b9\u3060\u3068\u3001\u6a5f\u80fd\u5b9f\u73fe\u306e\u305f\u3081\u306b\u3001apache\u306erewrite\u306e\u30dc\u30ea\u30e5\u30fc\u30e0\u304c\u5927\u304d\u304f\u306a\u308b\u50be\u5411\u306b\u306a\u308b\u306e\u3067\u306f\n\u306a\u3044\u304b\u3068\u601d\u3044\u307e\u3059\u3002\nEOL\u3092\u8fce\u3048\u305fPHP\u3092PHP7\u306b\u3057\u3066\u3001\u3064\u3044\u3067\u306bweb\u30b5\u30fc\u30d0\u30fc\u3092\u5909\u66f4\u3057\u305f\u3044\u3088\u3046\u306a\u5834\u5408\u3067\u306f\u3001\nmruby\u306b\u3088\u308brewrite\u3084proxy\u306fapache\u306econf\u307b\u3069\u7c21\u6f54\u306b\u8868\u73fe\u3067\u304d\u308b\u308f\u3051\u3067\u306f\u3042\u308a\u307e\u305b\u3093\u304c\u3001\u4eba\u306e\u76ee\u3067\u898b\u3066\n\u7406\u89e3\u3057\u3084\u3059\u3044\u8a18\u8ff0\u304c\u3067\u304d\u308b\u306e\u3067\u306f\u306a\u3044\u304b\u3068\u601d\u3044\u307e\u3059\u3002\napache+mod_php\u3067\u52d5\u3044\u3066\u3044\u305f\u30b5\u30fc\u30d3\u30b9\u3092H2O\u306b\u7f6e\u304d\u63db\u3048\u305f\u3068\u304d\u306b\u884c\u3063\u305f\u3053\u3068\u306b\n\u3064\u3044\u3066\u66f8\u304d\u307e\u3059\u3002\n\n# \u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\nH2O\u306f\u4ee5\u4e0b\u306e\u624b\u9806\u3067\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u307e\u3057\u305f\u3002OS\u306fAmazon Linux 2016.09\u3092\u4f7f\u3063\u3066\u3044\u307e\u3059\u3002\nCentOS 6\u7cfb\u306e\u30b5\u30fc\u30d0\u30fc\u3067\u3082\u540c\u3058\u69d8\u306a\u624b\u9806\u306b\u306a\u308b\u3068\u601d\u3044\u307e\u3059\u3002\n\u307e\u305a\u306f\u5fc5\u8981\u306a\u30e9\u30a4\u30d6\u30e9\u30ea\u7b49\u3092yum\u3067\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u307e\u3059\u3002\n\n```\n$ yum -y gcc gcc-c++ curl curl-devel libarchive libarchive-devel expat expat-devel libyaml-devel zlib zlib-devel openssl-devel libyaml-devel bison \n```\n\nCMake\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u3066\u304d\u3066\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3092\u884c\u3044\u307e\u3059\u3002\n\n```\n    cd /usr/local/src\n    wget http://www.cmake.org/files/v3.0/cmake-3.6.2.tar.gz\n    tar -xvf cmake-3.6.2.tar.gz\n    cd cmake-3.6\n            ./bootstrap --prefix=/usr \\\n            --system-libs       \\\n            --mandir=/share/man \\\n            --no-system-jsoncpp \\\n            --docdir=/share/doc/cmake-3.6.2\n    make\n    make install\n```\n\nH2O\u3092github\u304b\u3089clone\u3057\u3066\u304d\u3066\u3001\u30d3\u30eb\u30c9\u3057\u307e\u3059\u3002\u4eca\u56de\u306fv2.1.0-beta4\u3092\u30d3\u30eb\u30c9\u3057\u307e\u3057\u305f\u3002\n\n```\n    cd /usr/local/src\n    git clone https://github.com/h2o/h2o.git\n    git checkout refs/tags/v2.1.0-beta4\n \u3000 git submodule update --init --recursive\n    cmake -DWITH_BUNDLED_SSL=on .\n    make\n    sudo make install\n```\n\n# PHP\u306e\u8a2d\u5b9a\u306b\u3064\u3044\u3066\n\napache\u3067\u306fmod_php\u3067PHP\u3092\u5b9f\u884c\u3059\u308b\u3053\u3068\u304c\u591a\u3044\u3068\u601d\u3044\u307e\u3059\u3002H2O\u306b\u3082FastCGI\u306e\u6a5f\u80fd\u306f\n\u3042\u308a\u307e\u3059\u304c\u3001\u4eca\u56de\u306fphp-fpm\u3092\u4f7f\u3063\u3066\u3001unixsocket\u3067H2O\u3068\u901a\u4fe1\u3059\u308b\u3053\u3068\u306b\u3057\u307e\u3057\u305f\u3002\n\u4f8b\u3048\u3070\u306ewordpress\u306e\u8a2d\u5b9a\u306f\u8a2d\u5b9a\u306f\u4ee5\u4e0b\u306e\u69d8\u306b\u306a\u308a\u307e\u3059\u3002\n\n```yaml:/etc/h2o/conf/h2o.conf\npid-file: /var/run/h2o.pid\nuser: nobody\n\nerror-log: /var/log/h2o/error.log\n\n# PHP\u306e\u8a2d\u5b9a\nfile.custom-handler:\n  extension: .php\n  access-log:\n    path: /var/www/logs/foo/fpm-access.log\n    format: \"%h %l %u %t \\\"%r\\\" %s %b \\\"%{Referer}i\\\" \\\"%{User-agent}i\\\" \\\"%{X-Forwarded-For}i\\\" %{process-time}x %{duration}x\"\n  fastcgi.connect:\n    port: /var/run/php-fpm/php-fpm.sock\n    type: unix\n\n# \u30c9\u30e1\u30a4\u30f3\u8a2d\u5b9a\nhosts:\n  \"foo.example.com:80\":\n    listen:\n      port: 80\n    access-log:\n      path: /var/www/logs/foo/access.log\n      format: \"%h %l %u %t \\\"%r\\\" %s %b \\\"%{Referer}i\\\" \\\"%{User-agent}i\\\" \\\"%{X-Forwarded-For}i\\\" %{process-time}x %{duration}x\"\n    paths:\n      \"/\":\n        file.dir: /var/www/html/foo/\n        redirect:\n          url: /index.php/\n          internal: YES\n          status: 307\n```\n\n# Rewrite\u7b49\u306e\u8a2d\u5b9a\u306b\u3064\u3044\u3066\n\nphp\u3092\u52d5\u304b\u3059\u307e\u3067\u306f\u4e0a\u8a18\u306e\u8a2d\u5b9a\u3067\u3044\u3044\u306e\u3067\u3059\u304c\u3001\u79fb\u884c\u4f5c\u696d\u3068\u306a\u308b\u3068\u4eca\u307e\u3067Apache\u304c\u884c\u3063\u3066\u3044\u305f\n\u51e6\u7406\u3092H2O\u306b\u79fb\u3059\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\u305d\u306e\u4e2d\u3067\u6700\u3082\u4ee3\u8868\u7684\u306a\u306e\u304c\u3001apache\u306emod_rewrite\u306a\u306e\n\u3067\u306f\u306a\u3044\u304b\u3068\u601d\u3044\u307e\u3059\u3002\u7c21\u5358\u306a\u8a2d\u5b9a\u306a\u3089\u3001H2O\u306econf\u306b\u3082\u66f8\u304f\u3053\u3068\u304c\u51fa\u6765\u307e\u3059\u304c\u3001\u6b63\u898f\u8868\u73fe\n\u3067\u30de\u30c3\u30c1\u3057\u305f\u5185\u5bb9\u3092\u3082\u3068\u306brewrite\u3092\u3057\u3066\u3044\u308b\u5834\u5408\u306fh2o\u306emruby handler\u3092\u4f7f\u3063\u3066\u5b9f\u73fe\u3067\u304d\u307e\u3059\u3002\n\n\u4f8b\u3048\u3070apache\u3067\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u30ea\u30c0\u30a4\u30ec\u30af\u30c8\u8a2d\u5b9a\u306fH2O\u3067\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u66f8\u3051\u307e\u3059\u3002\n\n```\nRewriteRule   ^/aaa/test/                                https://foo.example.com/aaa/                       [R=301,L]\nRewriteRule   ^/bbb/test/                                https://foo.example.com/bbb/                       [R=301,L]\n\n```\n\n```ruby:/etc/h2o/hook/rerirect_rule.rb\nclass RedirectRule\n\n  def call(env)\n    if !/^(aaaa|bbb)\\/test/.match(env['PATH_INFO'])\n      redirect_path = $1\n      return [301, {'Location' => \"http://foo.example.com#{redirect_path}\"}, []]\n    else\n      [399, {}, []]\n    end\n  end\nend\n\nRedirectRule.new\n```\n\nmruby\u3067\u306e\u30cf\u30f3\u30c9\u30e9\u30fc\u306e\u8a18\u8ff0\u306frack\u306e\u30a4\u30f3\u30bf\u30fc\u30d5\u30a7\u30fc\u30b9\u306b\u6cbf\u3063\u305f\u3082\u306e\u306b\u306a\u308a\u307e\u3059\u3002\nreturn \u3059\u308b\u914d\u5217\u306e\uff11\u3064\u76ee\u304c\u30b9\u30c6\u30fc\u30bf\u30b9\u30b3\u30fc\u30c9\u30012\u3064\u76ee\u304c\u30ec\u30b9\u30dd\u30f3\u30b9\u30d8\u30c3\u30c0\u30fc\u30013\u3064\u76ee\u304c\nBody\u306b\u306a\u308a\u307e\u3059\u3002\u30b9\u30c6\u30fc\u30bf\u30b9399\u306fH2O\u3067\u4f7f\u3048\u308b\u7279\u5225\u306a\u30b9\u30c6\u30fc\u30bf\u30b9\u3067\u3001\u6b21\u306e\u30cf\u30f3\u30c9\u30e9\u30fc\u306b\n\u51e6\u7406\u3092\u59d4\u8b72\u3057\u307e\u3059\u3002\n\n\u307e\u305f\u5f15\u6570\u306eenv\u306fhash\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3067\u30ad\u30fc\u306f\u4ee5\u4e0b\u306e\u5185\u5bb9\u306b\u306a\u308a\u307e\u3059\u3002\n```\n[\"REQUEST_METHOD\", \"SCRIPT_NAME\", \"PATH_INFO\", \"QUERY_STRING\", \"SERVER_NAME\", \"SERVER_ADDR\", \"SERVER_PORT\", \"HTTP_HOST\", \"REMOTE_ADDR\", \"REMOTE_PORT\", \"USER_NAME\", \"ENV_NAME\", \"HTTP_ACCEPT\", \"HTTP_COOKIE\", \"HTTP_USER_AGENT\", \"HTTP_CACHE_CONTROL\", \"HTTP_ACCEPT_ENCODING\", \"HTTP_ACCEPT_LANGUAGE\", \"HTTP_UPGRADE_INSECURE_REQUESTS\", \"rack.url_scheme\", \"rack.multithread\", \"rack.multiprocess\", \"rack.run_once\", \"rack.hijack?\", \"rack.errors\", \"SERVER_SOFTWARE\"]\n```\n\nH2O\u306e\u524d\u6bb5\u306bRP\u304c\u3042\u308b\u5834\u5408\u306f\u3082\u3063\u3068\u30d8\u30c3\u30c0\u30fc\n\u304c\u5897\u3048\u308b\u3068\u601d\u3044\u307e\u3059\u304c\u3001rewrite\u7b49\u306e\u4f5c\u696d\u3067\u826f\u304f\u4f7f\u3046\u306e\u306f\u3001\"PATH_INFO\"\u3068\"HTTP_USER_AGENT\"\u3060\u3068\u601d\u3044\u307e\u3059\u3002\n\n\u4ed6\u306e\u30b5\u30fc\u30d0\u30fc\u306e\u5bfe\u3057\u3066mod_rewrite\u3067proxy\u3092mruby\u3067\u5b9f\u73fe\u3059\u308b\u5834\u5408\u306fhttp_request\u95a2\u6570\u3092\u4f7f\u7528\u3057\u307e\u3059\u3002\n\n\n```\nRewriteRule ^/contact(.*)$  http://foo.example.net/contact$1                 [QSA,NE,P,L]\n```\n\n```ruby:/etc/h2o/hook/proxy_rule.rb\nclass ProxyRule\n  def call(env)\n    if /^\\/contact(\\.*)/.match(env[\"PATH_INFO\"])\n      rewrite_path = $1\n      headers = {}\n      env.each do |key, value|\n        if /^HTTP_/.match(key)\n          headers[$'] = value\n        end\n      end\n      headers['Content-Type'] = env['CONTENT_TYPE']\n      headers['X-Forwarded-Host'] = env['HTTP_HOST']\n      headers['X-Forwarded-For'] = env['REMOTE_ADDR']\n      headers['User-Agent'] = env['HTTP_USER_AGENT']\n      return  http_request(\n                \"http://foo.example.net/contact#{rewrite_path}?#{env[\"QUERY_STRING\"]}\",\n                method:  env[\"REQUEST_METHOD\"],\n                headers: headers,\n                body:    env[\"rack.input\"]\n              ).join\n    end\n  end\nend\n\nProxyRule.new\n```\n\nenv\u306b\u5165\u3063\u3066\u304d\u3066\u3044\u308b\u30d8\u30c3\u30c0\u30fc\u60c5\u5831\u306f\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u304b\u3089\u9001\u3089\u308c\u3066\u3044\u308b\u30d8\u30c3\u30c0\u30fc\u306e\u60c5\u5831\u3068\u9055\u3063\u3066\u304d\u3066\u3044\u307e\u3059\u306e\u3067\u3001\nproxy\u5148\u306e\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306b\u3088\u3063\u3066\u306f\u3001\u5fc5\u8981\u306a\u30d8\u30c3\u30c0\u30fc\u60c5\u5831\u3092\u5408\u308f\u305b\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\u4e0a\u8a18\u306e\u4f8b\u3067\u306fContent-Type\n\u306a\u3069\u306e\u30d8\u30c3\u30c0\u30fc\u3092\u66f8\u304d\u63db\u3048\u3066\u3044\u307e\u3059\u3002\n\n# \u30d8\u30c3\u30c0\u30fc\u60c5\u5831\u306e\u8ffd\u52a0\u306b\u3064\u3044\u3066\n\u30d6\u30e9\u30a6\u30b6\u304c\u30da\u30fc\u30b8\u3092\u56de\u904a\u3057\u3066\u3044\u308b\u969b\u306b\u540c\u3058\u753b\u50cf\u3084CSS\u3092\u8aad\u307f\u8fbc\u307e\u306a\u3044\u3088\u3046\u306bexpire\u30d8\u30c3\u30c0\u30fc\u3092\u4ed8\u52a0\u3059\u308b\u3053\u3068\u304c\n\u3042\u308a\u307e\u3059\u3002Apache\u306e\u5834\u5408\u3067\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u8a18\u8ff0\u3057\u307e\u3059\u3002\n\n```\n    ExpiresActive On\n    <FilesMatch \"\\.(gif|jpg|png|js)$\">\n        ExpiresDefault \"access plus 1 month\"\n        Header set Cache-Control \"max-age=604800\"\n    </FilesMatch>\n```\n\nH2O\u3067\u306f\u5148\u307b\u3069\u306erewrite\u3068\u540c\u3058\u3088\u3046\u306bmruby handler\u3067\u5236\u5fa1\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\n```ruby:/etc/h2o/hook/add_expire_header.rb\nclass AddExpireHeader\n  def call(env)\n    headers = {}\n    if /\\.(css|js|png|jpg|gif)/.match(env[\"PATH_INFO\"])\n      headers[\"cache-control\"] = \"max-age=86400\"\n      headers[\"Expires\"] = \"30d\"\n    end\n    [399, headers, []]\n  end\nend\n\nAddExpireHeader.new\n```\n# \u30a2\u30af\u30bb\u30b9\u5236\u9650\u306b\u3064\u3044\u3066\n\u7ba1\u7406\u753b\u9762\u306a\u3069\u3001\u7279\u5b9a\u306eIP\u4ee5\u5916\u306f\u95b2\u89a7\u3055\u305b\u305f\u3044\u306a\u304f\u5834\u5408\u3082\u51fa\u3066\u304d\u307e\u3059\u3002Apache\u3067\u306f\u4ee5\u4e0b\u306e\u65b9\u6cd5\u3067\u5236\u5fa1\u3057\u3066\u3044\u307e\u3059\u3002\n\n```\n    <Location /wp_login.php>\n        Require ip 169.254.0.0/24\n        Require ip 10.1.0.0/16\n    </Location>\n\n    <Location /wp_admin>\n        Require ip 169.254.0.0/24\n        Require ip 10.1.0.0/16\n    </Location>\n```\n\nH2O\u3067\u306f\u3001ACL\u3092\u884c\u3046DSL\u304c\u3042\u308b\u306e\u3067\u3001\u305d\u308c\u3092\u4f7f\u7528\u3057\u3066\u3001\u30a2\u30af\u30bb\u30b9\u5236\u9650\u3092\u884c\u3046\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\n```ruby:/etc/h2o/hook/acl.rb\nALLOW_HOSTS = %w(\n169.254.0.0/24 10.1.0.0/16\n)\n\nrequire \"trie_addr.rb\"\ntrie = TrieAddr.new.add(ALLOW_HOSTS)\n\nacl {\n  deny { !trie.match?(addr) && (path.start_with?(\"/wp-login\") ||  path =~ /wp-admin/) }\n}\n\n```\n\n# \u307e\u3068\u3081\n\napache\u306econf\u306e\u4e00\u90e8\u3092H2O\u3067\u5b9f\u73fe\u3059\u308b\u65b9\u6cd5\u3092\u898b\u3066\u304d\u307e\u3057\u305f\u3002\u7279\u306b\u5f53\u521d\u306fPHP\u30d5\u30a1\u30a4\u30eb\u3092fast-cgi\u3067\u52d5\u304b\u3057\u3066\n\u3044\u305f\u3088\u3046\u306a\u30b5\u30fc\u30d3\u30b9\u3060\u3068\u3001\u6a5f\u80fd\u5b9f\u73fe\u306e\u305f\u3081\u306b\u3001apache\u306erewrite\u306e\u30dc\u30ea\u30e5\u30fc\u30e0\u304c\u5927\u304d\u304f\u306a\u308b\u50be\u5411\u306b\u306a\u308b\u306e\u3067\u306f\n\u306a\u3044\u304b\u3068\u601d\u3044\u307e\u3059\u3002\nEOL\u3092\u8fce\u3048\u305fPHP\u3092PHP7\u306b\u3057\u3066\u3001\u3064\u3044\u3067\u306bweb\u30b5\u30fc\u30d0\u30fc\u3092\u5909\u66f4\u3057\u305f\u3044\u3088\u3046\u306a\u5834\u5408\u3067\u306f\u3001\nmruby\u306b\u3088\u308brewrite\u3084proxy\u306fapache\u306econf\u307b\u3069\u7c21\u6f54\u306b\u8868\u73fe\u3067\u304d\u308b\u308f\u3051\u3067\u306f\u3042\u308a\u307e\u305b\u3093\u304c\u3001\u4eba\u306e\u76ee\u3067\u898b\u3066\n\u7406\u89e3\u3057\u3084\u3059\u3044\u8a18\u8ff0\u304c\u3067\u304d\u308b\u306e\u3067\u306f\u306a\u3044\u304b\u3068\u601d\u3044\u307e\u3059\u3002\n"}