{"context": "\n\n\u6982\u8981\n\nmackerel\u3067working\u4ee5\u5916\u306e\u30b9\u30c6\u30fc\u30bf\u30b9\u306b\u306a\u3063\u3066\u308b\u3084\u3064\u3092\u898b\u9003\u3059\u3053\u3068\u3042\u308b\u3088\u306d\n\u306a\u306e\u3067mkr\u3067\u5b9a\u671f\u7684\u306bslack\u306b\u901a\u77e5\u3055\u305b\u307e\u3057\u3087\u3046\n\u3067\u3082\u610f\u56f3\u7684\u306bstandby\u306b\u3059\u308b\u3084\u3064\u306f\u9664\u5916\u30eb\u30fc\u30eb\u306b\u66f8\u3044\u3061\u3083\u3044\u307e\u3059\n\n\n\u5185\u5bb9\n\n\u2460\u5fc5\u8981\u306agem\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n$ gem install slack-notifier\n\n\n\u2461slack\u306b\u901a\u77e5\u3055\u305b\u308b\u30d7\u30ed\u30b0\u30e9\u30e0\n$ vim /tmp/check_mackerel_status.rb\n\n# -*- coding:utf-8 -*-\n# need:\n# $ gem install slack-notifier\n#\n# $ vim /tmp/exclude_hosts.rb\n# $un_watch = [\n#   ['server1', '10\u6708\u4e0a\u65ec\u306b\u524a\u9664\u3057\u307e\u3059'],\n#   ['server2', '10\u6708\u4e0a\u65ec\u306b\u524a\u9664\u3057\u307e\u3059']\n# ]\n#\n# $ crontab -e\n# 0 10 * * 1-5 ruby /tmp/check_mackerel_status.rb\n\n\nrequire 'json'\nrequire 'slack-notifier'\nrequire '/tmp/exclude_hosts'\n\nexclude_host = []\nhost_list = []\nmessage = ''\nmessage_exclude = ''\nwebhook_url = 'https://hooks.slack.com/services/xxxxxxxxxxxxxxxxxxxxxxxx'\n\n# mackerel\u304b\u3089\u30c7\u30fc\u30bf\u3092\u53d6\u5f97\ncmd = `mkr hosts`\nJSON.load(cmd).each do |t|\n  host_list.push(t) if t['status'] != 'working'\nend\n\n# \u610f\u56f3\u7684\u306b\u76e3\u8996\u3057\u3066\u308b\u30db\u30b9\u30c8\u4e00\u89a7\n$un_watch.each do |t|\n   exclude_host.push(t[0])\n   message_exclude += \"#{t[0]}: #{t[1]}\\n\"\nend\n\n# \u610f\u56f3\u3057\u306a\u3044working\u30b9\u30c6\u30fc\u30bf\u30b9\u4ee5\u5916\u306e\u30db\u30b9\u30c8\u3092\u53d6\u5f97\nhost_list.each do |t|\n  unless exclude_host.include?(t['name'])\n    message += \"#{t['status']} : #{t['name']}\\n\"\n  end\nend\n\nunless message.empty?\n  notifier = Slack::Notifier.new webhook_url, channel: '#infra-channel', username: 'botname'\n  notifier.ping \"```\\nmackerel\u3067working\u4ee5\u5916\u306e\u30b5\u30fc\u30d0\u4e00\u89a7\u3067\u3059\\n#{message}```\\n\"\nend\n\n\n\u2462\u9664\u5916\u3059\u308b\u30db\u30b9\u30c8\u3092\u683c\u7d0d\u3059\u308b\u90e8\u5206\n$ vim /tmp/exclude_hosts.rb\n\n# mackerel\u4e0a\u306e\u30db\u30b9\u30c8\u540d\u3068\u7406\u7531\u3092\u66f8\u3044\u3066\u307e\u3059\n$un_watch = [\n  ['server1', '10\u6708\u4e0a\u65ec\u306b\u524a\u9664\u3057\u307e\u3059'],\n  ['server2', '10\u6708\u4e0a\u65ec\u306b\u524a\u9664\u3057\u307e\u3059']\n]\n\n\n\u2463\u3042\u3068\u306fcron\u3067\u52d5\u304b\u3057\u3066\u306d\uff01\n$ crontab -e\n0 10 * * 1-5 ruby /tmp/check_mackerel_status.rb\n\n# \u6982\u8981\n* mackerel\u3067working\u4ee5\u5916\u306e\u30b9\u30c6\u30fc\u30bf\u30b9\u306b\u306a\u3063\u3066\u308b\u3084\u3064\u3092\u898b\u9003\u3059\u3053\u3068\u3042\u308b\u3088\u306d\n* \u306a\u306e\u3067mkr\u3067\u5b9a\u671f\u7684\u306bslack\u306b\u901a\u77e5\u3055\u305b\u307e\u3057\u3087\u3046\n* \u3067\u3082\u610f\u56f3\u7684\u306bstandby\u306b\u3059\u308b\u3084\u3064\u306f\u9664\u5916\u30eb\u30fc\u30eb\u306b\u66f8\u3044\u3061\u3083\u3044\u307e\u3059\n\n# \u5185\u5bb9\n### \u2460\u5fc5\u8981\u306agem\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n```bash\n$ gem install slack-notifier\n```\n\n### \u2461slack\u306b\u901a\u77e5\u3055\u305b\u308b\u30d7\u30ed\u30b0\u30e9\u30e0\n```bash\n$ vim /tmp/check_mackerel_status.rb\n```\n\n```rb\n# -*- coding:utf-8 -*-\n# need:\n# $ gem install slack-notifier\n#\n# $ vim /tmp/exclude_hosts.rb\n# $un_watch = [\n#   ['server1', '10\u6708\u4e0a\u65ec\u306b\u524a\u9664\u3057\u307e\u3059'],\n#   ['server2', '10\u6708\u4e0a\u65ec\u306b\u524a\u9664\u3057\u307e\u3059']\n# ]\n#\n# $ crontab -e\n# 0 10 * * 1-5 ruby /tmp/check_mackerel_status.rb\n\n\nrequire 'json'\nrequire 'slack-notifier'\nrequire '/tmp/exclude_hosts'\n\nexclude_host = []\nhost_list = []\nmessage = ''\nmessage_exclude = ''\nwebhook_url = 'https://hooks.slack.com/services/xxxxxxxxxxxxxxxxxxxxxxxx'\n\n# mackerel\u304b\u3089\u30c7\u30fc\u30bf\u3092\u53d6\u5f97\ncmd = `mkr hosts`\nJSON.load(cmd).each do |t|\n  host_list.push(t) if t['status'] != 'working'\nend\n\n# \u610f\u56f3\u7684\u306b\u76e3\u8996\u3057\u3066\u308b\u30db\u30b9\u30c8\u4e00\u89a7\n$un_watch.each do |t|\n   exclude_host.push(t[0])\n   message_exclude += \"#{t[0]}: #{t[1]}\\n\"\nend\n\n# \u610f\u56f3\u3057\u306a\u3044working\u30b9\u30c6\u30fc\u30bf\u30b9\u4ee5\u5916\u306e\u30db\u30b9\u30c8\u3092\u53d6\u5f97\nhost_list.each do |t|\n  unless exclude_host.include?(t['name'])\n    message += \"#{t['status']} : #{t['name']}\\n\"\n  end\nend\n\nunless message.empty?\n  notifier = Slack::Notifier.new webhook_url, channel: '#infra-channel', username: 'botname'\n  notifier.ping \"```\\nmackerel\u3067working\u4ee5\u5916\u306e\u30b5\u30fc\u30d0\u4e00\u89a7\u3067\u3059\\n#{message}```\\n\"\nend\n```\n\n### \u2462\u9664\u5916\u3059\u308b\u30db\u30b9\u30c8\u3092\u683c\u7d0d\u3059\u308b\u90e8\u5206\n```bash\n$ vim /tmp/exclude_hosts.rb\n```\n```rb\n# mackerel\u4e0a\u306e\u30db\u30b9\u30c8\u540d\u3068\u7406\u7531\u3092\u66f8\u3044\u3066\u307e\u3059\n$un_watch = [\n  ['server1', '10\u6708\u4e0a\u65ec\u306b\u524a\u9664\u3057\u307e\u3059'],\n  ['server2', '10\u6708\u4e0a\u65ec\u306b\u524a\u9664\u3057\u307e\u3059']\n]\n```\n\n### \u2463\u3042\u3068\u306fcron\u3067\u52d5\u304b\u3057\u3066\u306d\uff01\n```bash\n$ crontab -e\n0 10 * * 1-5 ruby /tmp/check_mackerel_status.rb\n```\n", "tags": ["Mackerel", "Slack", "slackbot"]}