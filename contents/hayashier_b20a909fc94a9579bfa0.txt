{"context": "Fluentd\u3092\u4f7f\u3063\u3066\u3001\u8907\u6570\u306eEC2\u304b\u3089\u30ed\u30b0\u3092\u53ce\u96c6\u3057\u3001S3\u3084ElasticSearch Service\u306b\u8ee2\u9001\u3059\u308b\u51e6\u7406\u3092\u884c\u3063\u305f\u306e\u3067\u3001\u6ce8\u610f\u4e8b\u9805\u3082\u542b\u3081\u3066\u30e1\u30e2\u3057\u307e\u3059\u3002\n\n\u4e8b\u524d\u6e96\u5099\n\nS3\u30d0\u30b1\u30c3\u30c8\u306e\u4f5c\u6210\n\u30de\u30cd\u30b8\u30e1\u30f3\u30c8\u30b3\u30f3\u30bd\u30fc\u30eb\u304b\u3089S3\u3092\u9078\u629e\u3057\u3001[\u30d0\u30b1\u30c3\u30c8\u3092\u4f5c\u6210]\u3092\u9078\u629e\u3002\n\u73fe\u308c\u308b\u30de\u30cd\u30b8\u30e1\u30f3\u30c8\u30b3\u30f3\u30bd\u30fc\u30eb\u306b\u4f8b\u3048\u3070\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u5165\u529b\u3059\u308b\u3002\n\u30d0\u30b1\u30c3\u30c8\u540d: my-server-log\n\u30ea\u30fc\u30b8\u30e7\u30f3: Tokyo\n\u203bS3\u306e\u30d0\u30b1\u30c3\u30c8\u540d\u306fAWS\u5168\u4f53\u3067\u4e00\u610f\u306a\u306e\u3067\u6ce8\u610f\u3002\u5404\u81ea\u9069\u5b9c\u540d\u524d\u3092\u3064\u3051\u308b\u3053\u3068\u3002\n[\u4f5c\u6210]\u3092\u9078\u629e\n\nElasticSearch Service\u306e\u30c9\u30e1\u30a4\u30f3\u4f5c\u6210\n\u30de\u30cd\u30b8\u30e1\u30f3\u30c8\u30b3\u30f3\u30bd\u30fc\u30eb\u304b\u3089ElasticSerch Service\u3092\u9078\u629e\n[Create a new domain]\u3092\u9078\u629e\n\nStep 1: Define domain\nElasticsearch domain name: my-search-domain\nElasticsearch version: 5.1\n\nStep 2: Configure cluster\n\u57fa\u672c\u306f\u30c7\u30d5\u30a9\u30eb\u30c8\u8a2d\u5b9a\u306e\u307e\u307e\u3067\u826f\u3044\u3002\n\u3053\u3053\u3067\u306f\u3001\nInstance type: t2.micro.elasticsearch\nStorage type: EBS\n\u306b\u5909\u66f4\u3057\u3066\u304a\u304f\u3002\n[Next]\u3092\u9078\u629e\u3002\n\nStep 3: Set up access policy\nSet the domain access policy to [Select a template]\n\u3067\u3001\u3053\u3053\u3067\u306f\u3001Allow open access to the domain\u3092\u9078\u629e\u3002\n[Next]\u3092\u9078\u629e\u3002\n\nStep 4: Review\n\u5185\u5bb9\u3092\u78ba\u8a8d\u3057\u305f\u3089\u3001[Confirm and create]\u3092\u9078\u629e\n\nFluentd\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n$ curl -L https://toolbelt.treasuredata.com/sh/install-redhat-td-agent2.sh | sh\n\n\u3061\u306a\u307f\u306b\u5185\u90e8\u3067\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u30b9\u30af\u30ea\u30d7\u30c8\u304c\u5b9f\u884c\u3055\u308c\u3066\u3044\u308b\u3088\u3046\u3067\u3059\u3002\nTreasure Data\u306e\u30ec\u30dd\u30b8\u30c8\u30ea\u3092yum\u306b\u8ffd\u52a0\u3057\u3066td-agent\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3066\u3044\u308b\u3002\n\nfluent.sh\necho \"This script requires superuser access to install rpm packages.\"\necho \"You will be prompted for your password by sudo.\"\n\n# clear any previous sudo permission\nsudo -k\n\n# run inside sudo\nsudo sh <<SCRIPT\n\n  # add GPG key\n  rpm --import https://packages.treasuredata.com/GPG-KEY-td-agent\n\n  # add treasure data repository to yum\n  cat >/etc/yum.repos.d/td.repo <<'EOF';\n[treasuredata]\nname=TreasureData\nbaseurl=http://packages.treasuredata.com/2/redhat/\\$releasever/\\$basearch\ngpgcheck=1\ngpgkey=https://packages.treasuredata.com/GPG-KEY-td-agent\nEOF\n\n  # update your sources\n  yum check-update\n\n  # install the toolbelt\n  yes | yum install -y td-agent\n\nSCRIPT\n\n\nElasticSearch Service\u306b\u6d41\u3059\u305f\u3081\u306eFluentd\u306e\u30d7\u30e9\u30b0\u30a4\u30f3\u3092\u5404\u30b5\u30fc\u30d0\u306b\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n$ sudo td-agent-gem install fluent-plugin-elasticsearch\n\n\u203b\u6ce8\u610f\u70b9\u3068\u3057\u3066\u306f\u3001Aggregator\u3068\u306a\u308bEC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u30b0\u30eb\u30fc\u30d7\u306bTCP\u3068UDP\u306e\u4e21\u65b9\u306e24224\u756a\u30dd\u30fc\u30c8\u3092\u958b\u653e\u3057\u3066\u304a\u304b\u306a\u3051\u308c\u3070\u3044\u3051\u306a\u3044\u3002\n\nFluentd\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u306e\u4f5c\u6210\n\u30ed\u30b0\u3092\u96c6\u3081\u308b\u5404\u30b5\u30fc\u30d0\u306b\u3064\u3044\u3066\u3001/etc/td-agent/td-agnet.conf\u3092\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u7de8\u96c6\u3059\u308b\u3002\n\ntd-agent.conf\n<source>\n  type tail\n  format /^(?<host>[^ ]*) (?<remotelog>[^ ]*) (?<user>[^ ]*) \\[(?<time>[^\\]]*)\\] \"(?<method>\\S+)(?: +(?<path>[^ ]*) +\\S*)?\" (?<status>[^ ]*) (?<size>[^ ]*) \"(?<referer>[^\\\"]*)\" \"(?<agent>.*)\"\\ *(?<querystring>[^\\\"]*)$/\n  time_format %d/%b/%Y:%H:%M:%S %z\n  path /var/log/httpd/access_log\n  tag sample.service.access.log.aggregate\n  pos_file /tmp/fluent/logpos/access_log.pos\n</source>\n\n<source>\n  type tail\n  format /^\\[(?<time>[^\\]]*)\\] \\[(?<type>[^\\]]*)\\] \\[(?<pid>[^\\]]*)\\] (\\[(?<client>[^\\]]*)\\](?<error>.*)|(?<error>.*))$/\n  time_format %a %b %d %H:%M:%S.%N %Y\n  path /var/log/httpd/error_log\n  tag sample.service.error.log.aggregate\n  pos_file /tmp/fluent/logpos/error_log.pos\n</source>\n\n<match **>\n  type forward\n\n  <server>\n    name fluent01\n    host 10.0.0.31\n    port 24224\n  </server>\n</match>\n\n\n\u203bformat\u306f\u9069\u5b9c\u30b5\u30fc\u30d0\u306e\u30ed\u30b0\u51fa\u529b\u306b\u5408\u308f\u305b\u3066\u540d\u524d\u4ed8\u304d\u30ad\u30e3\u30d7\u30c1\u30e3\u3092\u7528\u3044\u305f\u6b63\u898f\u8868\u73fe\u3082\u3057\u304f\u306f\u4e88\u3081\u7528\u610f\u3055\u308c\u3066\u3044\u308b\u3082\u306e\u3092\u5229\u7528\u3057\u3066\u8868\u73fe\u3059\u308b\u3002\u8868\u8a18\u9593\u9055\u3048\u306e\u306a\u3044\u3088\u3046\u306b\u6ce8\u610f\u3059\u308b\u3002\nAggregator\u3068\u306a\u308b\u30b5\u30fc\u30d0\u306b\u3064\u3044\u3066\u306f\u3001/etc/td-agent/td-agnet.conf\u3092\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u7de8\u96c6\u3059\u308b\u3002\n\ntd-agent.conf\n<source>\n  type forward\n  port 24224\n</source>\n\n<match sample.service.access.**>\n  type copy\n\n  <store>\n    type elasticsearch\n    host https://my-search-domain-xxxxxxxxxxxxxxxxxxxxx.ap-northeast-1.es.amazonaws.com\n    port 443\n    scheme https\n    type_name access_log\n    logstash_format true\n    logstash_prefix micoly-service-log-access\n    request_timeout 10s\n    buffer_type memory\n    flush_interval 60\n    retry_limit 17\n    retry_wait 1.0\n    num_threads 1\n    reload_connections false\n  </store>\n\n  <store>\n    type s3\n    aws_key_id AKIAXXXXXXXXXXXXXXXX\n    aws_sec_key XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX\n    s3_bucket my-server-log\n    s3_region ap-northeast-1\n    s3_object_key_format %{path}%{time_slice}/%{index}.%{hostname}.%{file_extension}\n    path access-logs/\n    buffer_path /tmp/fluent/s3/access/\n    time_slice_format %Y%m%d-%H\n    time_slice_wait 10m\n    utc\n    include_time_key true\n  </store>\n</match>\n\n<match sample.service.error.**>\n  type copy\n\n  <store>\n    type elasticsearch\n    host https://my-search-domain-xxxxxxxxxxxxxxxxxxxxx.ap-northeast-1.es.amazonaws.com\n    port 443\n    scheme https\n    type_name access_log\n    logstash_format true\n    logstash_prefix micoly-service-log-access\n    request_timeout 10s\n    buffer_type memory\n    flush_interval 60\n    retry_limit 17\n    retry_wait 1.0\n    num_threads 1\n    reload_connections false\n  </store>\n\n  <store>\n    type s3\n    aws_key_id AKIAXXXXXXXXXXXXXXXX\n    aws_sec_key XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX\n    s3_bucket my-server-log\n    s3_region ap-northeast-1\n    s3_object_key_format %{path}%{time_slice}/%{index}.%{hostname}.%{file_extension}\n    path error-logs/\n    buffer_path /tmp/fluent/s3/error\n    time_slice_format %Y%m%d-%H\n    time_slice_wait 10m\n    utc\n    include_time_key true\n  </store>\n</match>\n\n\n\u203bElasticsearch Service\u3067\u306fElasticsearch\u30ce\u30fc\u30c9\u306b\u76f4\u63a5\u30a2\u30af\u30bb\u30b9\u3067\u304d\u306a\u3044\u306e\u3067reload_connections false\u3068\u3057\u306a\u3044\u3068\u3044\u3051\u306a\u3044\u3002\nhttp://kakakakakku.hatenablog.com/entry/2016/10/29/142937\nApache\u306ehttpd.conf\u30ed\u30b0\u306e\u51fa\u529b\u306e\u8a2d\u5b9a\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u308b\u3002\nErrorLog \"logs/error_log\"\nLogLevel warn\n\n<IfModule log_config_module>\n    LogFormat \"%h %l %u %t \\\"%r\\\" %>s %b \\\"%{Referer}i\\\" \\\"%{User-Agent}i\\\" %q\" combined\n    LogFormat \"%h %l %u %t \\\"%r\\\" %>s %b %q\" common\n\n    <IfModule logio_module>\n      LogFormat \"%h %l %u %t \\\"%r\\\" %>s %b \\\"%{Referer}i\\\" \\\"%{User-Agent}i\\\" %I %O %q\" combinedio\n    </IfModule>\n    CustomLog \"logs/access_log\" combined\n</IfModule>\n\n\u6a29\u9650\u306e\u8a2d\u5b9a\u3092\u3057\u3066\u304a\u304f\u3002\n```bash\n$ sudo chown td-agent:td-agent /tmp/fluent/logpos/access_log.pos\n$ sudo chown td-agent:td-agent /tmp/fluent/logpos/error_log.pos\n\n$ sudo chgrp td-agent /var/log/httpd/\n$ sudo chgrp td-agent /var/log/messages\n\n$ sudo chmod g+rx /var/log/httpd/\n$ sudo chmod g+rx /var/log/messages\n\ntd-agent\u3092\u30b9\u30bf\u30fc\u30c8\u3059\u308c\u3070\u30ed\u30b0\u306e\u53ce\u96c6\u304c\u958b\u59cb\u3055\u308c\u308b\u3002\n$ sudo service td-agent start\n\n\u6570\u5341\u79d2\u5f8c\u306b\u306fElasticsearch Service\u306eIndices\u306b\u5404\u7a2e\u30c7\u30fc\u30bf\u304c\u66f4\u65b0\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u304c\u78ba\u8a8d\u3067\u304d\u308b\u3002\n\nKibana\u3067\u7c21\u5358\u306b\u53ef\u8996\u5316\u306e\u8a2d\u5b9a\u3082\u3067\u304d\u308b\u3002\n\n\n\u6ce8\u610f\u70b9 \u307e\u3068\u3081\n\n\u30c7\u30d0\u30c3\u30b0\u306f/var/log/td-agent/td-agent.log\u3092\u898b\u306a\u304c\u3089\u884c\u3046\u306a\u3046\u3068\u3088\u3044\u3002\nformat\u306f\u9069\u5b9c\u30b5\u30fc\u30d0\u306e\u30ed\u30b0\u51fa\u529b\u306b\u5408\u308f\u305b\u3066\u540d\u524d\u4ed8\u304d\u30ad\u30e3\u30d7\u30c1\u30e3\u3092\u7528\u3044\u305f\u6b63\u898f\u8868\u73fe\u3082\u3057\u304f\u306f\u4e88\u3081\u7528\u610f\u3055\u308c\u3066\u3044\u308b\u3082\u306e\u3092\u5229\u7528\u3057\u3066\u8868\u73fe\u3059\u308b\u3002\u8868\u8a18\u9593\u9055\u3048\u306e\u306a\u3044\u3088\u3046\u306b\u6ce8\u610f\u3059\u308b\u3002\nElasticsearch Service\u3067\u306fElasticsearch\u30ce\u30fc\u30c9\u306b\u76f4\u63a5\u30a2\u30af\u30bb\u30b9\u3067\u304d\u306a\u3044\u306e\u3067reload_connections false\u3068\u3057\u306a\u3044\u3068\u3044\u3051\u306a\u3044\u3002\nfluentd\u3067\u306fTCP\u3068UDP\u306e\u4e21\u65b9\u3067\u8a2d\u5b9a\u3057\u305f\u30dd\u30fc\u30c8\u756a\u53f7(\u3053\u3053\u3067\u306f24224\u756a)\u3092\u4f7f\u7528\u3059\u308b\u306e\u3067\u3001Aggragator\u5074\u306e\u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u30b0\u30eb\u30fc\u30d7\u306e\u30a4\u30f3\u30d0\u30a6\u30f3\u30c9\u65b9\u5411\u3092\u89e3\u653e\u3059\u308b\u8a2d\u5b9a\u3092\u3057\u5fd8\u308c\u306a\u3044\u3088\u3046\u306b\u3059\u308b\u3002\n\u6ce8\u610f\u70b9\u3068\u3057\u3066\u306f\u3001pos_file\u3084buffer_path\u306e\u3088\u3046\u306a\u4e00\u6642\u30d5\u30a1\u30a4\u30eb\u3068\u3057\u3066\u4f7f\u7528\u3059\u308b\u30d5\u30a1\u30a4\u30eb\u306e\u6a29\u9650\u306b\u6ce8\u610f\u3002\u9069\u5207\u306a\u6a29\u9650\u3092\u4ed8\u4e0e\u3059\u308b\u306a\u3069\u306e\u5bfe\u51e6\u3092\u884c\u3046\u3002\n\u4ed5\u69d8\u3067\u3001\u30bf\u30b0\u540d\u90e8\u5206\u306e\u30ef\u30a4\u30eb\u30c9\u30ab\u30fc\u30c9\u3092\u8868\u3059\u8a18\u53f7\u304c*\u3067\u306f\u306a\u304f**\n\n\u30d7\u30e9\u30b0\u30a4\u30f3\u304c\u5165\u3063\u3066\u3044\u306a\u304f\u3066\u3082\u30a8\u30e9\u30fc\u7b49\u304c\u51fa\u306a\u3044\u3002\u76f4\u63a5Elasticsearch\u306b\u30af\u30a8\u30ea\u3092\u53e9\u304f\u306a\u3069\u3057\u3066\u539f\u56e0\u306e\u5207\u308a\u5206\u3051\u3092\u660e\u78ba\u306b\u3059\u308b\u3002\n\nFluentd\u306e\u30ed\u30b0\u306f/var/log/td-agent/td-agent.log\u306b\u4fdd\u5b58\u3055\u308c\u308b\u306e\u3067\u3001\u3046\u307e\u304f\u52d5\u4f5c\u3057\u306a\u3044\u5834\u5408\u306f\u3053\u306e\u30ed\u30b0\u3092\u53c2\u7167\u3059\u308b\u3053\u3068\u3002\n\n\u53c2\u8003\nhttp://blog.serverworks.co.jp/tech/2015/10/15/play-with-fluentd/\nhttp://blog.serverworks.co.jp/tech/2015/10/30/play-with-amazon-es/\nhttp://blog.serverworks.co.jp/tech/2013/06/27/fluentdtos3/\nhttps://eure.jp/blog/fluentd_elasticsearch_kibana/\nhttp://qiita.com/maru3/items/15db610c460ce84171e7\nFluentd\u3092\u4f7f\u3063\u3066\u3001\u8907\u6570\u306eEC2\u304b\u3089\u30ed\u30b0\u3092\u53ce\u96c6\u3057\u3001S3\u3084ElasticSearch Service\u306b\u8ee2\u9001\u3059\u308b\u51e6\u7406\u3092\u884c\u3063\u305f\u306e\u3067\u3001\u6ce8\u610f\u4e8b\u9805\u3082\u542b\u3081\u3066\u30e1\u30e2\u3057\u307e\u3059\u3002\n\n#\u4e8b\u524d\u6e96\u5099\n##S3\u30d0\u30b1\u30c3\u30c8\u306e\u4f5c\u6210\n\u30de\u30cd\u30b8\u30e1\u30f3\u30c8\u30b3\u30f3\u30bd\u30fc\u30eb\u304b\u3089S3\u3092\u9078\u629e\u3057\u3001[\u30d0\u30b1\u30c3\u30c8\u3092\u4f5c\u6210]\u3092\u9078\u629e\u3002\n\u73fe\u308c\u308b\u30de\u30cd\u30b8\u30e1\u30f3\u30c8\u30b3\u30f3\u30bd\u30fc\u30eb\u306b\u4f8b\u3048\u3070\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u5165\u529b\u3059\u308b\u3002\n\n\u30d0\u30b1\u30c3\u30c8\u540d: my-server-log\n\u30ea\u30fc\u30b8\u30e7\u30f3: Tokyo\n\n\u203bS3\u306e\u30d0\u30b1\u30c3\u30c8\u540d\u306fAWS\u5168\u4f53\u3067\u4e00\u610f\u306a\u306e\u3067\u6ce8\u610f\u3002\u5404\u81ea\u9069\u5b9c\u540d\u524d\u3092\u3064\u3051\u308b\u3053\u3068\u3002\n\n[\u4f5c\u6210]\u3092\u9078\u629e\n\n##ElasticSearch Service\u306e\u30c9\u30e1\u30a4\u30f3\u4f5c\u6210\n\u30de\u30cd\u30b8\u30e1\u30f3\u30c8\u30b3\u30f3\u30bd\u30fc\u30eb\u304b\u3089ElasticSerch Service\u3092\u9078\u629e\n[Create a new domain]\u3092\u9078\u629e\n\n###Step 1: Define domain\nElasticsearch domain name: my-search-domain\nElasticsearch version: 5.1\n\n###Step 2: Configure cluster\n\u57fa\u672c\u306f\u30c7\u30d5\u30a9\u30eb\u30c8\u8a2d\u5b9a\u306e\u307e\u307e\u3067\u826f\u3044\u3002\n\n\u3053\u3053\u3067\u306f\u3001\nInstance type: t2.micro.elasticsearch\nStorage type: EBS\n\u306b\u5909\u66f4\u3057\u3066\u304a\u304f\u3002\n[Next]\u3092\u9078\u629e\u3002\n\n###Step 3: Set up access policy\nSet the domain access policy to [Select a template]\n\u3067\u3001\u3053\u3053\u3067\u306f\u3001Allow open access to the domain\u3092\u9078\u629e\u3002\n[Next]\u3092\u9078\u629e\u3002\n\n###Step 4: Review\n\u5185\u5bb9\u3092\u78ba\u8a8d\u3057\u305f\u3089\u3001[Confirm and create]\u3092\u9078\u629e\n\n#Fluentd\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n```bash\n$ curl -L https://toolbelt.treasuredata.com/sh/install-redhat-td-agent2.sh | sh\n```\n\n\u3061\u306a\u307f\u306b\u5185\u90e8\u3067\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u30b9\u30af\u30ea\u30d7\u30c8\u304c\u5b9f\u884c\u3055\u308c\u3066\u3044\u308b\u3088\u3046\u3067\u3059\u3002\nTreasure Data\u306e\u30ec\u30dd\u30b8\u30c8\u30ea\u3092yum\u306b\u8ffd\u52a0\u3057\u3066td-agent\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3066\u3044\u308b\u3002\n\n```fluent.sh\necho \"This script requires superuser access to install rpm packages.\"\necho \"You will be prompted for your password by sudo.\"\n\n# clear any previous sudo permission\nsudo -k\n\n# run inside sudo\nsudo sh <<SCRIPT\n\n  # add GPG key\n  rpm --import https://packages.treasuredata.com/GPG-KEY-td-agent\n\n  # add treasure data repository to yum\n  cat >/etc/yum.repos.d/td.repo <<'EOF';\n[treasuredata]\nname=TreasureData\nbaseurl=http://packages.treasuredata.com/2/redhat/\\$releasever/\\$basearch\ngpgcheck=1\ngpgkey=https://packages.treasuredata.com/GPG-KEY-td-agent\nEOF\n\n  # update your sources\n  yum check-update\n\n  # install the toolbelt\n  yes | yum install -y td-agent\n\nSCRIPT\n```\n\n\nElasticSearch Service\u306b\u6d41\u3059\u305f\u3081\u306eFluentd\u306e\u30d7\u30e9\u30b0\u30a4\u30f3\u3092\u5404\u30b5\u30fc\u30d0\u306b\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n```bash\n$ sudo td-agent-gem install fluent-plugin-elasticsearch\n```\n\n\u203b\u6ce8\u610f\u70b9\u3068\u3057\u3066\u306f\u3001Aggregator\u3068\u306a\u308bEC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u30b0\u30eb\u30fc\u30d7\u306bTCP\u3068UDP\u306e\u4e21\u65b9\u306e24224\u756a\u30dd\u30fc\u30c8\u3092\u958b\u653e\u3057\u3066\u304a\u304b\u306a\u3051\u308c\u3070\u3044\u3051\u306a\u3044\u3002\n\n\n#Fluentd\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u306e\u4f5c\u6210\n\u30ed\u30b0\u3092\u96c6\u3081\u308b\u5404\u30b5\u30fc\u30d0\u306b\u3064\u3044\u3066\u3001```/etc/td-agent/td-agnet.conf```\u3092\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u7de8\u96c6\u3059\u308b\u3002\n\n\n```td-agent.conf\n<source>\n  type tail\n  format /^(?<host>[^ ]*) (?<remotelog>[^ ]*) (?<user>[^ ]*) \\[(?<time>[^\\]]*)\\] \"(?<method>\\S+)(?: +(?<path>[^ ]*) +\\S*)?\" (?<status>[^ ]*) (?<size>[^ ]*) \"(?<referer>[^\\\"]*)\" \"(?<agent>.*)\"\\ *(?<querystring>[^\\\"]*)$/\n  time_format %d/%b/%Y:%H:%M:%S %z\n  path /var/log/httpd/access_log\n  tag sample.service.access.log.aggregate\n  pos_file /tmp/fluent/logpos/access_log.pos\n</source>\n\n<source>\n  type tail\n  format /^\\[(?<time>[^\\]]*)\\] \\[(?<type>[^\\]]*)\\] \\[(?<pid>[^\\]]*)\\] (\\[(?<client>[^\\]]*)\\](?<error>.*)|(?<error>.*))$/\n  time_format %a %b %d %H:%M:%S.%N %Y\n  path /var/log/httpd/error_log\n  tag sample.service.error.log.aggregate\n  pos_file /tmp/fluent/logpos/error_log.pos\n</source>\n\n<match **>\n  type forward\n\n  <server>\n    name fluent01\n    host 10.0.0.31\n    port 24224\n  </server>\n</match>\n```\n\n\u203bformat\u306f\u9069\u5b9c\u30b5\u30fc\u30d0\u306e\u30ed\u30b0\u51fa\u529b\u306b\u5408\u308f\u305b\u3066\u540d\u524d\u4ed8\u304d\u30ad\u30e3\u30d7\u30c1\u30e3\u3092\u7528\u3044\u305f\u6b63\u898f\u8868\u73fe\u3082\u3057\u304f\u306f\u4e88\u3081\u7528\u610f\u3055\u308c\u3066\u3044\u308b\u3082\u306e\u3092\u5229\u7528\u3057\u3066\u8868\u73fe\u3059\u308b\u3002\u8868\u8a18\u9593\u9055\u3048\u306e\u306a\u3044\u3088\u3046\u306b\u6ce8\u610f\u3059\u308b\u3002\n\nAggregator\u3068\u306a\u308b\u30b5\u30fc\u30d0\u306b\u3064\u3044\u3066\u306f\u3001```/etc/td-agent/td-agnet.conf```\u3092\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u7de8\u96c6\u3059\u308b\u3002\n\n\n```td-agent.conf\n<source>\n  type forward\n  port 24224\n</source>\n\n<match sample.service.access.**>\n  type copy\n\n  <store>\n    type elasticsearch\n    host https://my-search-domain-xxxxxxxxxxxxxxxxxxxxx.ap-northeast-1.es.amazonaws.com\n    port 443\n    scheme https\n    type_name access_log\n    logstash_format true\n    logstash_prefix micoly-service-log-access\n    request_timeout 10s\n    buffer_type memory\n    flush_interval 60\n    retry_limit 17\n    retry_wait 1.0\n    num_threads 1\n    reload_connections false\n  </store>\n\n  <store>\n    type s3\n    aws_key_id AKIAXXXXXXXXXXXXXXXX\n    aws_sec_key XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX\n    s3_bucket my-server-log\n    s3_region ap-northeast-1\n    s3_object_key_format %{path}%{time_slice}/%{index}.%{hostname}.%{file_extension}\n    path access-logs/\n    buffer_path /tmp/fluent/s3/access/\n    time_slice_format %Y%m%d-%H\n    time_slice_wait 10m\n    utc\n    include_time_key true\n  </store>\n</match>\n\n<match sample.service.error.**>\n  type copy\n\n  <store>\n    type elasticsearch\n    host https://my-search-domain-xxxxxxxxxxxxxxxxxxxxx.ap-northeast-1.es.amazonaws.com\n    port 443\n    scheme https\n    type_name access_log\n    logstash_format true\n    logstash_prefix micoly-service-log-access\n    request_timeout 10s\n    buffer_type memory\n    flush_interval 60\n    retry_limit 17\n    retry_wait 1.0\n    num_threads 1\n    reload_connections false\n  </store>\n\n  <store>\n    type s3\n    aws_key_id AKIAXXXXXXXXXXXXXXXX\n    aws_sec_key XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX\n    s3_bucket my-server-log\n    s3_region ap-northeast-1\n    s3_object_key_format %{path}%{time_slice}/%{index}.%{hostname}.%{file_extension}\n    path error-logs/\n    buffer_path /tmp/fluent/s3/error\n    time_slice_format %Y%m%d-%H\n    time_slice_wait 10m\n    utc\n    include_time_key true\n  </store>\n</match>\n```\n\n\u203bElasticsearch Service\u3067\u306fElasticsearch\u30ce\u30fc\u30c9\u306b\u76f4\u63a5\u30a2\u30af\u30bb\u30b9\u3067\u304d\u306a\u3044\u306e\u3067`reload_connections false`\u3068\u3057\u306a\u3044\u3068\u3044\u3051\u306a\u3044\u3002\nhttp://kakakakakku.hatenablog.com/entry/2016/10/29/142937\n\nApache\u306ehttpd.conf\u30ed\u30b0\u306e\u51fa\u529b\u306e\u8a2d\u5b9a\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u308b\u3002\n\n```\nErrorLog \"logs/error_log\"\nLogLevel warn\n\n<IfModule log_config_module>\n    LogFormat \"%h %l %u %t \\\"%r\\\" %>s %b \\\"%{Referer}i\\\" \\\"%{User-Agent}i\\\" %q\" combined\n    LogFormat \"%h %l %u %t \\\"%r\\\" %>s %b %q\" common\n\n    <IfModule logio_module>\n      LogFormat \"%h %l %u %t \\\"%r\\\" %>s %b \\\"%{Referer}i\\\" \\\"%{User-Agent}i\\\" %I %O %q\" combinedio\n    </IfModule>\n    CustomLog \"logs/access_log\" combined\n</IfModule>\n```\n\n\n\u6a29\u9650\u306e\u8a2d\u5b9a\u3092\u3057\u3066\u304a\u304f\u3002\n\n```\n```bash\n$ sudo chown td-agent:td-agent /tmp/fluent/logpos/access_log.pos\n$ sudo chown td-agent:td-agent /tmp/fluent/logpos/error_log.pos\n```\n\n```bash\n$ sudo chgrp td-agent /var/log/httpd/\n$ sudo chgrp td-agent /var/log/messages\n\n$ sudo chmod g+rx /var/log/httpd/\n$ sudo chmod g+rx /var/log/messages\n```\n\ntd-agent\u3092\u30b9\u30bf\u30fc\u30c8\u3059\u308c\u3070\u30ed\u30b0\u306e\u53ce\u96c6\u304c\u958b\u59cb\u3055\u308c\u308b\u3002\n\n\n```bash\n$ sudo service td-agent start\n```\n\n\u6570\u5341\u79d2\u5f8c\u306b\u306fElasticsearch Service\u306eIndices\u306b\u5404\u7a2e\u30c7\u30fc\u30bf\u304c\u66f4\u65b0\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u304c\u78ba\u8a8d\u3067\u304d\u308b\u3002\n<img width=\"1245\" alt=\"\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2017-02-25 1.27.34.png\" src=\"https://qiita-image-store.s3.amazonaws.com/0/81083/59867fe7-9e84-af4c-1c3f-6a007cf791f7.png\">\n\nKibana\u3067\u7c21\u5358\u306b\u53ef\u8996\u5316\u306e\u8a2d\u5b9a\u3082\u3067\u304d\u308b\u3002\n\n<img width=\"1254\" alt=\"\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2017-02-25 1.23.25.png\" src=\"https://qiita-image-store.s3.amazonaws.com/0/81083/30b253d1-a029-2b59-d8a9-cf4979d28f8d.png\">\n\n#\u6ce8\u610f\u70b9 \u307e\u3068\u3081\n- \u30c7\u30d0\u30c3\u30b0\u306f`/var/log/td-agent/td-agent.log`\u3092\u898b\u306a\u304c\u3089\u884c\u3046\u306a\u3046\u3068\u3088\u3044\u3002\n- format\u306f\u9069\u5b9c\u30b5\u30fc\u30d0\u306e\u30ed\u30b0\u51fa\u529b\u306b\u5408\u308f\u305b\u3066\u540d\u524d\u4ed8\u304d\u30ad\u30e3\u30d7\u30c1\u30e3\u3092\u7528\u3044\u305f\u6b63\u898f\u8868\u73fe\u3082\u3057\u304f\u306f\u4e88\u3081\u7528\u610f\u3055\u308c\u3066\u3044\u308b\u3082\u306e\u3092\u5229\u7528\u3057\u3066\u8868\u73fe\u3059\u308b\u3002\u8868\u8a18\u9593\u9055\u3048\u306e\u306a\u3044\u3088\u3046\u306b\u6ce8\u610f\u3059\u308b\u3002\n- Elasticsearch Service\u3067\u306fElasticsearch\u30ce\u30fc\u30c9\u306b\u76f4\u63a5\u30a2\u30af\u30bb\u30b9\u3067\u304d\u306a\u3044\u306e\u3067`reload_connections false`\u3068\u3057\u306a\u3044\u3068\u3044\u3051\u306a\u3044\u3002\n- fluentd\u3067\u306fTCP\u3068UDP\u306e\u4e21\u65b9\u3067\u8a2d\u5b9a\u3057\u305f\u30dd\u30fc\u30c8\u756a\u53f7(\u3053\u3053\u3067\u306f24224\u756a)\u3092\u4f7f\u7528\u3059\u308b\u306e\u3067\u3001Aggragator\u5074\u306e\u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u30b0\u30eb\u30fc\u30d7\u306e\u30a4\u30f3\u30d0\u30a6\u30f3\u30c9\u65b9\u5411\u3092\u89e3\u653e\u3059\u308b\u8a2d\u5b9a\u3092\u3057\u5fd8\u308c\u306a\u3044\u3088\u3046\u306b\u3059\u308b\u3002\n- \u6ce8\u610f\u70b9\u3068\u3057\u3066\u306f\u3001```pos_file```\u3084```buffer_path```\u306e\u3088\u3046\u306a\u4e00\u6642\u30d5\u30a1\u30a4\u30eb\u3068\u3057\u3066\u4f7f\u7528\u3059\u308b\u30d5\u30a1\u30a4\u30eb\u306e\u6a29\u9650\u306b\u6ce8\u610f\u3002\u9069\u5207\u306a\u6a29\u9650\u3092\u4ed8\u4e0e\u3059\u308b\u306a\u3069\u306e\u5bfe\u51e6\u3092\u884c\u3046\u3002\n- \u4ed5\u69d8\u3067\u3001\u30bf\u30b0\u540d\u90e8\u5206\u306e\u30ef\u30a4\u30eb\u30c9\u30ab\u30fc\u30c9\u3092\u8868\u3059\u8a18\u53f7\u304c```*```\u3067\u306f\u306a\u304f```**```\n- \u30d7\u30e9\u30b0\u30a4\u30f3\u304c\u5165\u3063\u3066\u3044\u306a\u304f\u3066\u3082\u30a8\u30e9\u30fc\u7b49\u304c\u51fa\u306a\u3044\u3002\u76f4\u63a5Elasticsearch\u306b\u30af\u30a8\u30ea\u3092\u53e9\u304f\u306a\u3069\u3057\u3066\u539f\u56e0\u306e\u5207\u308a\u5206\u3051\u3092\u660e\u78ba\u306b\u3059\u308b\u3002\n\nFluentd\u306e\u30ed\u30b0\u306f```/var/log/td-agent/td-agent.log```\u306b\u4fdd\u5b58\u3055\u308c\u308b\u306e\u3067\u3001\u3046\u307e\u304f\u52d5\u4f5c\u3057\u306a\u3044\u5834\u5408\u306f\u3053\u306e\u30ed\u30b0\u3092\u53c2\u7167\u3059\u308b\u3053\u3068\u3002\n\n\n#\u53c2\u8003\nhttp://blog.serverworks.co.jp/tech/2015/10/15/play-with-fluentd/\nhttp://blog.serverworks.co.jp/tech/2015/10/30/play-with-amazon-es/\nhttp://blog.serverworks.co.jp/tech/2013/06/27/fluentdtos3/\nhttps://eure.jp/blog/fluentd_elasticsearch_kibana/\nhttp://qiita.com/maru3/items/15db610c460ce84171e7\n", "tags": ["fluentd", "fluent-plugin-elasticsearch", "S3", "ElasticsearchService", "AWS"]}