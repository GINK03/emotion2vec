{"context": "\n\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\nCentOS 7\u3067\u3059\u3002\nyum install corosync paceaker pcs mysql-server\n\n\nCorosync\u306e\u8a2d\u5b9a\n\u4ee5\u4e0b\u306e\u8a2d\u5b9a\u3092\u3001\u4e21\u30ce\u30fc\u30c9\u3067\u884c\u3046\u3002\n\n/etc/corosync/corosync.conf\ntotem {\n    version: 2\n\n    crypto_cipher: none\n    crypto_hash: none\n\n    interface{\n        ringnumber:0\n\n        bindnetaddr: 192.168.10.0 # \u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u30a2\u30c9\u30ec\u30b9\n        mcastport: 5405\n        ttl: 1\n    }\n    transport: udpu\n}\n\nnodelist {\n    node{\n        ring0_addr: hostname1 # \u30db\u30b9\u30c8\u540d1\n        nodeid: 1\n    }\n\n    node{\n        ring0_addr: hostname2 # \u30db\u30b9\u30c8\u540d2\n        nodeid: 2\n    }\n}\n\nlogging {\n    fileline: off\n    to_syslog: yes\n    to_logfile: yes\n        logfile: /var/log/cluster/corosync.log\n    debug: off\n    timestamp: on\n    logger_subsys {\n        subsys: QUORUM\n        debug: off\n    }\n}\n\nquorum {\n    provider: corosync_votequorum\n    expected_votes: 2\n}\n\n\n# firewall-cmd --add-port=5405/udp --permanent\n# firewall-cmd --add-port=2224/tcp --permanent\n# systemctl enable corosync\n# systemctl enable pacemaker\n# systemctl enable pcsd\n\n\u4e00\u65e6reboot\u3059\u308b\u3002\n# pcs status\u3067\u52d5\u4f5c\u3057\u3066\u3044\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3059\u308b\u3002\n# passwd hacluster\u3067\u30af\u30e9\u30b9\u30bf\u306e\u8a8d\u8a3c\u7528\u30e6\u30fc\u30b6hacluster\u306e\u30d1\u30b9\u30ef\u30fc\u30c9\u3092\u8a2d\u5b9a\u3059\u308b\u3002\n\n\u30af\u30e9\u30b9\u30bf\u306e\u8a8d\u8a3c\n\u4e21\u65b9\u306e\u30ce\u30fc\u30c9\u3067\u8a8d\u8a3c\u3092\u884c\u3044\u3001# pcs status\u3067\u78ba\u8a8d\u3059\u308b\u3002PCSD Status\u304cOnline\u306b\u306a\u3063\u3066\u3044\u308c\u3070OK\u3002\n# pcs cluster auth <\u30db\u30b9\u30c81> <\u30db\u30b9\u30c82> -u hacluster -p <password> --force\n\n\nMySQL (MariaDB)\u306e\u8a2d\u5b9a\n\u30db\u30b9\u30c81\u3067\u306fserver-id=1\u3001\u30db\u30b9\u30c82\u3067\u306fserver-id=2\u3067\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\netc/my.cnf\n[mysqld]\nlog-bin=mariadb-bin\nserver-id=1\n\n\n\n\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30e6\u30fc\u30b6\u306e\u4f5c\u6210\n\u30db\u30b9\u30c81\u306e\u307f\u3002DB\u3092\u8d77\u52d5\u3057\u3066\u30e6\u30fc\u30b6\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n# systemctl start mariadb.service\nmysql> GRANT REPLICATION SLAVE ON *.* TO 'repl'@'%' IDENTIFIED BY 'slavepass';\nmysql> GRANT SUPER,REPLICATION SLAVE,REPLICATION CLIENT,PROCESS ON *.* TO 'repl'@'localhost' IDENTIFIED BY 'slavepass';\nmysql> FLUSH PRIVILEGES;\n\nDB\u3092\u505c\u6b62\u3057\u3066\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u30d5\u30a1\u30a4\u30eb\u4e00\u5f0f\u3092\u30db\u30b9\u30c82\u306b\u30b3\u30d4\u30fc\u3057\u307e\u3059\u3002\n# systemctl stop mariadb.service\n# ssh <\u30db\u30b9\u30c82> rm -rf /var/lib/mysql\n# tar cf - -C /var/lib mysql | ssh <\u30db\u30b9\u30c82> tar xpvf - -C /var/lib/\n\n\n\u30af\u30e9\u30b9\u30bf\u30fc\u30ea\u30bd\u30fc\u30b9\u306e\u8a2d\u5b9a\n\u6700\u521d\u306bSlave\u3068\u3057\u3066\u7a3c\u50cd\u3055\u305b\u308b\u30db\u30b9\u30c82\u3092Standby\u306b\u3057\u305f\u5f8c\u3001\u30ea\u30bd\u30fc\u30b9\u3092\u767b\u9332\u3057\u307e\u3059\u3002\n# pcs cluster standby <\u30db\u30b9\u30c82>\n# pcs cluster cib mysql_repl\n# pcs -f mysql_repl resource create mysql ocf:heartbeat:mysql\n# pcs -f mysql_repl resource update mysql binary=/usr/bin/mysqld_safe\n# pcs -f mysql_repl resource update mysql datadir=/var/lib/mysql\n# pcs -f mysql_repl resource update mysql log=/var/log/mariadb/mariadb.log\n# pcs -f mysql_repl resource update mysql pid=/run/mariadb/mariadb.pid\n# pcs -f mysql_repl resource update mysql replication_user=repl\n# pcs -f mysql_repl resource update mysql replication_passwd=slavepass\n# pcs -f mysql_repl resource op add mysql start interval=0 timeout=120s\n# pcs -f mysql_repl resource op add mysql stop interval=0 timeout=120s\n# pcs -f mysql_repl resource op add mysql monitor interval=20s timeout=30s\n# pcs -f mysql_repl resource op add mysql monitor interval=10s role=Master timeout=30s\n# pcs -f mysql_repl resource op add mysql monitor interval=30s role=Slave timeout=30s\n# pcs -f mysql_repl resource op add mysql promote interval=0 timeout=120s\n# pcs -f mysql_repl resource op add mysql demote interval=0 timeout=120s\n# pcs -f mysql_repl resource op add mysql notify interval=0 timeout=90s\n# pcs cluster cib-push mysql_repl\n\nMaster/Slave\u30bb\u30c3\u30c8\u306e\u4f5c\u6210\u3057\u3001\u30af\u30e9\u30b9\u30bf\u30fc\u30ea\u30bd\u30fc\u30b9\u3092\u958b\u59cb\u3057\u307e\u3059\u3002\npcs resource master mysql-clone mysql master-max=1 master-node-max=1 clone-max=2 clone-node-max=1 notify=true\npcs resource start mysql-clone\n\n\u30db\u30b9\u30c81\u306e\u8d77\u52d5\u78ba\u8a8d\u5f8c\u30db\u30b9\u30c82\u3092\u8d77\u52d5\u3057\u307e\u3059\u3002\npcs cluster unstandby <\u30db\u30b9\u30c82>\n\n\n\u30d5\u30a7\u30a4\u30eb\u30aa\u30fc\u30d0\u78ba\u8a8d\npcs cluster standby <\u30db\u30b9\u30c81>\u3067Master\u5074\u3092Standby\u306b\u3059\u308b\u3068Master\u304c\u30db\u30b9\u30c82\u306b\u5207\u308a\u66ff\u308f\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\nMaster\u304c\u5207\u308a\u66ff\u308f\u3063\u305f\u3089pcs cluster unstandby <\u30db\u30b9\u30c81>\u3067Standby\u89e3\u9664\u3059\u308b\u3068\u30db\u30b9\u30c81\u306fSlave\u3068\u3057\u3066\u7a3c\u50cd\u3092\u958b\u59cb\u3059\u308b\u306f\u305a\u3067\u3059\u3002\n\n\u53c2\u8003\n\nPacemaker\u3067MySQL\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u69cb\u6210 \u2013 CentOS7+MariaDB\u7de8\n\n# \u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\nCentOS 7\u3067\u3059\u3002\n\n```\nyum install corosync paceaker pcs mysql-server\n```\n\n# Corosync\u306e\u8a2d\u5b9a\n\u4ee5\u4e0b\u306e\u8a2d\u5b9a\u3092\u3001\u4e21\u30ce\u30fc\u30c9\u3067\u884c\u3046\u3002\n\n```text:/etc/corosync/corosync.conf\ntotem {\n\tversion: 2\n\t\n\tcrypto_cipher: none\n\tcrypto_hash: none\n\n\tinterface{\n\t\tringnumber:0\n\n\t\tbindnetaddr: 192.168.10.0 # \u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u30a2\u30c9\u30ec\u30b9\n\t\tmcastport: 5405\n\t\tttl: 1\n\t}\n\ttransport: udpu\n}\n\nnodelist {\n\tnode{\n\t\tring0_addr: hostname1 # \u30db\u30b9\u30c8\u540d1\n\t\tnodeid: 1\n\t}\n\t\t\n\tnode{\n\t\tring0_addr: hostname2 # \u30db\u30b9\u30c8\u540d2\n\t\tnodeid: 2\n\t}\n}\n\nlogging {\n\tfileline: off\n\tto_syslog: yes\n\tto_logfile: yes\n        logfile: /var/log/cluster/corosync.log\n\tdebug: off\n\ttimestamp: on\n\tlogger_subsys {\n\t\tsubsys: QUORUM\n\t\tdebug: off\n\t}\n}\n\nquorum {\n\tprovider: corosync_votequorum\n\texpected_votes: 2\n}\n```\n\n```\n# firewall-cmd --add-port=5405/udp --permanent\n# firewall-cmd --add-port=2224/tcp --permanent\n# systemctl enable corosync\n# systemctl enable pacemaker\n# systemctl enable pcsd\n```\n\n\u4e00\u65e6reboot\u3059\u308b\u3002\n`# pcs status`\u3067\u52d5\u4f5c\u3057\u3066\u3044\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3059\u308b\u3002\n`# passwd hacluster`\u3067\u30af\u30e9\u30b9\u30bf\u306e\u8a8d\u8a3c\u7528\u30e6\u30fc\u30b6hacluster\u306e\u30d1\u30b9\u30ef\u30fc\u30c9\u3092\u8a2d\u5b9a\u3059\u308b\u3002\n\n### \u30af\u30e9\u30b9\u30bf\u306e\u8a8d\u8a3c\n\u4e21\u65b9\u306e\u30ce\u30fc\u30c9\u3067\u8a8d\u8a3c\u3092\u884c\u3044\u3001`# pcs status`\u3067\u78ba\u8a8d\u3059\u308b\u3002PCSD Status\u304cOnline\u306b\u306a\u3063\u3066\u3044\u308c\u3070OK\u3002\n\n```\n# pcs cluster auth <\u30db\u30b9\u30c81> <\u30db\u30b9\u30c82> -u hacluster -p <password> --force\n```\n\n# MySQL (MariaDB)\u306e\u8a2d\u5b9a\n\u30db\u30b9\u30c81\u3067\u306fserver-id=1\u3001\u30db\u30b9\u30c82\u3067\u306fserver-id=2\u3067\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\n```text:etc/my.cnf\n[mysqld]\nlog-bin=mariadb-bin\nserver-id=1\n```\n\n### \u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30e6\u30fc\u30b6\u306e\u4f5c\u6210\n\u30db\u30b9\u30c81\u306e\u307f\u3002DB\u3092\u8d77\u52d5\u3057\u3066\u30e6\u30fc\u30b6\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n```\n# systemctl start mariadb.service\nmysql> GRANT REPLICATION SLAVE ON *.* TO 'repl'@'%' IDENTIFIED BY 'slavepass';\nmysql> GRANT SUPER,REPLICATION SLAVE,REPLICATION CLIENT,PROCESS ON *.* TO 'repl'@'localhost' IDENTIFIED BY 'slavepass';\nmysql> FLUSH PRIVILEGES;\n```\n\nDB\u3092\u505c\u6b62\u3057\u3066\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u30d5\u30a1\u30a4\u30eb\u4e00\u5f0f\u3092\u30db\u30b9\u30c82\u306b\u30b3\u30d4\u30fc\u3057\u307e\u3059\u3002\n\n```\n# systemctl stop mariadb.service\n# ssh <\u30db\u30b9\u30c82> rm -rf /var/lib/mysql\n# tar cf - -C /var/lib mysql | ssh <\u30db\u30b9\u30c82> tar xpvf - -C /var/lib/\n```\n\n# \u30af\u30e9\u30b9\u30bf\u30fc\u30ea\u30bd\u30fc\u30b9\u306e\u8a2d\u5b9a\n\u6700\u521d\u306bSlave\u3068\u3057\u3066\u7a3c\u50cd\u3055\u305b\u308b\u30db\u30b9\u30c82\u3092Standby\u306b\u3057\u305f\u5f8c\u3001\u30ea\u30bd\u30fc\u30b9\u3092\u767b\u9332\u3057\u307e\u3059\u3002\n\n```\n# pcs cluster standby <\u30db\u30b9\u30c82>\n# pcs cluster cib mysql_repl\n# pcs -f mysql_repl resource create mysql ocf:heartbeat:mysql\n# pcs -f mysql_repl resource update mysql binary=/usr/bin/mysqld_safe\n# pcs -f mysql_repl resource update mysql datadir=/var/lib/mysql\n# pcs -f mysql_repl resource update mysql log=/var/log/mariadb/mariadb.log\n# pcs -f mysql_repl resource update mysql pid=/run/mariadb/mariadb.pid\n# pcs -f mysql_repl resource update mysql replication_user=repl\n# pcs -f mysql_repl resource update mysql replication_passwd=slavepass\n# pcs -f mysql_repl resource op add mysql start interval=0 timeout=120s\n# pcs -f mysql_repl resource op add mysql stop interval=0 timeout=120s\n# pcs -f mysql_repl resource op add mysql monitor interval=20s timeout=30s\n# pcs -f mysql_repl resource op add mysql monitor interval=10s role=Master timeout=30s\n# pcs -f mysql_repl resource op add mysql monitor interval=30s role=Slave timeout=30s\n# pcs -f mysql_repl resource op add mysql promote interval=0 timeout=120s\n# pcs -f mysql_repl resource op add mysql demote interval=0 timeout=120s\n# pcs -f mysql_repl resource op add mysql notify interval=0 timeout=90s\n# pcs cluster cib-push mysql_repl\n```\n\nMaster/Slave\u30bb\u30c3\u30c8\u306e\u4f5c\u6210\u3057\u3001\u30af\u30e9\u30b9\u30bf\u30fc\u30ea\u30bd\u30fc\u30b9\u3092\u958b\u59cb\u3057\u307e\u3059\u3002\n\n```\npcs resource master mysql-clone mysql master-max=1 master-node-max=1 clone-max=2 clone-node-max=1 notify=true\npcs resource start mysql-clone\n```\n\n\u30db\u30b9\u30c81\u306e\u8d77\u52d5\u78ba\u8a8d\u5f8c\u30db\u30b9\u30c82\u3092\u8d77\u52d5\u3057\u307e\u3059\u3002\n\n```\npcs cluster unstandby <\u30db\u30b9\u30c82>\n```\n\n# \u30d5\u30a7\u30a4\u30eb\u30aa\u30fc\u30d0\u78ba\u8a8d\n`pcs cluster standby <\u30db\u30b9\u30c81>`\u3067Master\u5074\u3092Standby\u306b\u3059\u308b\u3068Master\u304c\u30db\u30b9\u30c82\u306b\u5207\u308a\u66ff\u308f\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\nMaster\u304c\u5207\u308a\u66ff\u308f\u3063\u305f\u3089`pcs cluster unstandby <\u30db\u30b9\u30c81>`\u3067Standby\u89e3\u9664\u3059\u308b\u3068\u30db\u30b9\u30c81\u306fSlave\u3068\u3057\u3066\u7a3c\u50cd\u3092\u958b\u59cb\u3059\u308b\u306f\u305a\u3067\u3059\u3002\n\n# \u53c2\u8003\n- [Pacemaker\u3067MySQL\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u69cb\u6210 \u2013 CentOS7+MariaDB\u7de8](http://gmt-24.net/archives/tag/pacemaker)\n", "tags": ["MySQL", "\u5197\u9577\u5316", "pacemaker", "corosync", "mariadb"]}