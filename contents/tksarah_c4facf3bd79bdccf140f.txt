{"tags": ["ZFS", "openstack", "Manila"], "context": "\u672c\u7a3f\u306f\u3001OpenStack Days 2016 Tokyo \u3067\u767a\u8868\u3055\u305b\u3066\u3082\u3089\u3063\u305f\u4e2d\u3067\u8a66\u3057\u305f ZFSonLinux \u3092\u30d0\u30c3\u30af\u30a8\u30f3\u30c9\u3068\u3057\u3066\u8a66\u3057\u305f\u8a73\u7d30\u3092\u4f55\u56de\u304b\u306b\u5206\u3051\u3066\u8a18\u8f09\u3057\u307e\u3059\u3002\u4eca\u56de\u521d\u56de\u306a\u306e\u3067\u3001\u307e\u305a\u30d5\u30a1\u30a4\u30eb\u30b7\u30a7\u30a2\u304c\u51fa\u6765\u304d\u3001\u30de\u30a6\u30f3\u30c8\u3059\u308b\u307e\u3067\u3067\u3059\u3002\n\nOpenStack Manila \u6982\u8981\nOpenStack \u306e\u4e2d\u3067\u30d5\u30a1\u30a4\u30eb\u30b5\u30fc\u30d0\u3092\u63d0\u4f9b\u3059\u308b\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u3067\u3059\u3002\u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3\u306f Cinder \u3068\u975e\u5e38\u306b\u826f\u304f\u4f3c\u3066\u3044\u308b\u306e\u3067\u8003\u3048\u65b9\u69cb\u6210\u306a\u3069\u306f\u7406\u89e3\u3057\u3084\u3059\u3044\u3068\u601d\u308f\u308c\u308b\u3002\n\u5358\u54c1\u3067\u8a66\u3059\u5834\u5408\u306f\u3053\u3061\u3089\u3002OpenStack Manila on RDO\n\nZFSonLinux\nZFS\u306f\u5143\u3005Solaris\u3067\u5b9f\u88c5\u3055\u308c\u3066\u3044\u305f\u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0\u3067\u3057\u305f\u304c\u3001Linux\u4e0a\u3067\u3082\u4f7f\u3048\u308b\u3088\u3046\u306b\u3057\u305f\u306e\u304c\u3053\u308c\u3002\u3053\u3053\u304b\u3089\u306f2016\u5e747\u6708\u6642\u70b9\u3067\u306e\u500b\u4eba\u7684\u898b\u89e3\u3067\u306f\u3042\u308b\u304c\u3001\u4f7f\u3044\u52dd\u624b\u3082\u697d\u3067\u975e\u5e38\u306b\u30b9\u30c8\u30ec\u30fc\u30b8\u3068\u3057\u3066\u591a\u6a5f\u80fd\u3067\u3042\u308b\u305f\u3081\u3001OpenStack\u306e\u30d0\u30c3\u30af\u30a8\u30f3\u30c9\u3068\u3057\u3066\u5229\u7528\u3059\u308b\u306b\u306f\u5546\u7528\uff08\u30a8\u30f3\u30bf\u30fc\u30d7\u30e9\u30a4\u30ba\u30b9\u30c8\u30ec\u30fc\u30b8\uff09\u306b\u5f15\u3051\u3092\u3068\u3089\u306a\u3044\u3068\u3044\u3046\u3053\u3068\u3082\u3042\u308a\u4eca\u56de\u9078\u629e\u3057\u305f\u3002\u6280\u8853\u8005\u3068\u3057\u3066\u306f\u3044\u308d\u3044\u308d\u8a66\u305b\u308b\u65b9\u304c\u9762\u767d\u3044\u3068\u3044\u3046\u306e\u3082\u3042\u308b\u3002\nManila\u3067\u30b5\u30dd\u30fc\u30c8\u3055\u308c\u3066\u3044\u308b\u6a5f\u80fd\u4e00\u89a7\u3068\u3057\u3066\u306f\u3053\u3061\u3089\u3092\u53c2\u7167\u3002Manila share features support mapping\n\n\u8a55\u4fa1\u74b0\u5883\n\n\u8a55\u4fa1\u30de\u30b7\u30f3\nOpenStack , ZFSonLinux \u5171\u306b\u3001\nCentOS Linux release 7.2.1511 (Core)\n\nOpenStack Mitaka Release (centos-release-openstack-mitaka-1-3.el7)\nopenstack-manila-2.0.0-1.el7.noarch\nopenstack-manila-ui-2.1.0-1.el7.noarch\npython-manila-2.0.0-1.el7.noarch\nopenstack-manila-share-2.0.0-1.el7.noarch\npython-manilaclient-1.8.1-1.el7.noarch\n\nZFS\nzfs-release.el7.noarch.rpm\ndkms-2.2.0.3-34.git.9e0394d.el7.noarch.rpm\n\n\u8a55\u4fa1\u9805\u76ee\n\u4e0b\u8a18\u306e\u6a5f\u80fd\u3092\u8a55\u4fa1\n\nCreate Share\nDelete Share\nAllow NFS Share access\nDeny NFS Share access\nCreate Snapshot\nDelete Snapshot\nCreate share from snapshot\nExtend Share\nShrink Share\n\n\n\u69cb\u6210\u30a4\u30e1\u30fc\u30b8\n\u4eca\u56de\u3001ZFSonLinux \u30b5\u30fc\u30d0\u306f\u5225\u5efa\u3066\u3057\u3066\u3044\u308b\u3002\n\n\n\u30d5\u30a1\u30a4\u30eb\u30b7\u30a7\u30a2\uff08\u3053\u3053\u3067\u306f\u30d5\u30a1\u30a4\u30eb\u30b5\u30fc\u30d0\uff09\u304c\u51fa\u6765\u308b\u307e\u3067\u306e\u6d41\u308c\n\nmanila-api \u30ea\u30af\u30a8\u30b9\u30c8\nmanila-scheduler \u30b9\u30b1\u30b8\u30e5\u30fc\u30ea\u30f3\u30b0\nmanila-share \u51e6\u7406\n\n\n\u51e6\u7406\u3092\u3059\u308b\u904e\u7a0b\u3068\u3057\u3066\u3001SSH\u7d4c\u7531\u3067ZFSonLinux\u306b\u63a5\u7d9a\u3059\u308b\uff08\u30d1\u30b9\u30ef\u30fc\u30c9\u3001\u9375\u8a8d\u8a3c\uff09\nZFSonLinux \u30b5\u30fc\u30d0\u5074\u306f\u30d7\u30fc\u30eb\u304b\u3089\u30dc\u30ea\u30e5\u30fc\u30e0\u3092\u5207\u308a\u51fa\u3059\n\u5207\u308a\u3060\u3055\u308c\u305f\u30d7\u30fc\u30eb\u3092\u30a8\u30af\u30b9\u30dd\u30fc\u30c8\u3059\u308b\n\n\nmanila-share \u5b8c\u4e86\n\n\n\u69cb\u7bc9\u624b\u9806\n\u524d\u63d0\u3068\u3057\u3066\u3001OpenStack Manila \u306e\u5c0e\u5165\u305d\u306e\u3082\u306e\u306f\u7d42\u308f\u3063\u3066\u3044\u308b\u3082\u306e\u3068\u3059\u308b\u3002\u3053\u306e\u90e8\u5206\u306b\u3064\u3044\u3066\u306f\u53c2\u8003\u306b\u3064\u3051\u3066\u3044\u308b\u30da\u30fc\u30b8\u3092\u53c2\u7167\u3002\n\nZFS\u69cb\u6210\u3068\u8a2d\u5b9a\n\nZFS\u306e\u5c0e\u5165\n\nhttps://github.com/zfsonlinux/zfs/wiki/RHEL-%26-CentOS\n\n# yum update\n# yum groupinstall \"Development tools\"\n# yum install epel-release\n# yum localinstall --nogpgcheck http://archive.zfsonlinux.org/epel/zfs-release$(rpm -E %dist).noarch.rpm\n# gpg --quiet --with-fingerprint /etc/pki/rpm-gpg/RPM-GPG-KEY-zfsonlinux\n# yum install kernel-devel zfs\n\n\nZPool \u4f5c\u6210\n\u3053\u306eZFSonLinux\u306e\u30b5\u30fc\u30d0\u306b\u306f10GB\u306eHDD\u3092\u5916\u4ed8\u3051\u30674\u3064\u3064\u3051\u3066\u304a\u308a\u3001\u305d\u308c\u3092\u4eca\u56deZPool\u3068\u3057\u3066\u5272\u308a\u5f53\u3066\u308b\u3002RAID\u3068\u3057\u3066raidz3\u3092\u6307\u5b9a\u3057\u3001\u300ctrank\u300d\u3068\u3044\u3046\u30d7\u30fc\u30eb\u540d\u3067\u4f5c\u6210\u3002\n# modrobe zfs\n# cat /proc/filesystems |grep zfs\nnodev   zfs\n\n# zpool create trank raidz3 /dev/sdb /dev/sdc /dev/sdd /dev/sde -f \n\n# zpool status\n  pool: trank\n state: ONLINE\n  scan: none requested\nconfig:\n\n        NAME        STATE     READ WRITE CKSUM\n        trank       ONLINE       0     0     0\n          raidz3-0  ONLINE       0     0     0\n            sdb     ONLINE       0     0     0\n            sdc     ONLINE       0     0     0\n            sdd     ONLINE       0     0     0\n            sde     ONLINE       0     0     0\n\nerrors: No known data errors\n\n# zpool list\nNAME    SIZE  ALLOC   FREE  EXPANDSZ   FRAG    CAP  DEDUP  HEALTH  ALTROOT\ntrank  39.8G   256K  39.7G         -     0%     0%  1.00x  ONLINE  -\n\n# LANG=C df -h\nFilesystem               Size  Used Avail Use% Mounted on\n/dev/mapper/centos-root   18G  1.8G   16G  10% /\ndevtmpfs                 911M     0  911M   0% /dev\ntmpfs                    921M     0  921M   0% /dev/shm\ntmpfs                    921M  8.6M  912M   1% /run\ntmpfs                    921M     0  921M   0% /sys/fs/cgroup\ntrank                    9.7G     0  9.7G   0% /trank                  <= \u3053\u308c\n/dev/sda1                497M  167M  331M  34% /boot\ntmpfs                    185M     0  185M   0% /run/user/0\n\n\nNFS Server \u3092\u8d77\u52d5\n\u3057\u3066\u3044\u306a\u3051\u308c\u3070\u8d77\u52d5\u3002\n# systemctl start nfs-server\n# systemctl enable nfs-server\n\n\nSSH\u30e6\u30fc\u30b6\u306e\u4f5c\u6210\nmanila-share \u3067\u51e6\u7406\u3055\u308c\u308b\u305f\u3081\u306e\u30a2\u30af\u30bb\u30b9\u30e6\u30fc\u30b6\u3068\u3057\u3066\u3001\u300czfsuser\u300d\u3092\u4f5c\u308b\u3002\n\n\u4eca\u56de\u306e\u74b0\u5883\u3067\u306f\u3001OpenStack Manila \u5074\u3067\u306f\u3001manila-share \u304c manila \u30e6\u30fc\u30b6\u3067\u52d5\u3044\u3066\u3044\u308b\u306e\u3067\u3001\u3053\u306e manila \u30e6\u30fc\u30b6\u304c ssh \u3092\u53e9\u3044\u3066 ZFSonLinux \u30b5\u30fc\u30d0\u306b\u51e6\u7406\u4f9d\u983c\u3002\u9375\u3092\u4f5c\u3063\u3066\u3001\u79d8\u5bc6\u9375\u3092 manila-share \u304c\u7a3c\u50cd\u3057\u3066\u3044\u308b\u6240\u5b9a\u306e\u5834\u6240\u306b\u914d\u7f6e\u3059\u308b\u3002\uff08\u4eca\u56de\u306f\u3001/etc/manila/nonpass.key \u5c5e\u6027\u306f 0440 \u3068\u3057\u305f\uff09\n\n\u307e\u305f\u3001zfsuser \u30e6\u30fc\u30b6\u3067 ZFS\u306e\u7ba1\u7406\u30b3\u30de\u30f3\u30c9\u306f\u5b9f\u884c\u3067\u304d\u306a\u3044\u306e\u3067\u3001ssh\u3067\u30a2\u30af\u30bb\u30b9\u5f8c\u306f\u3001sudo \u306b\u3088\u308a ZFS \u7ba1\u7406\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3059\u308b\u3002\u3053\u3053\u3067\u3082 sudo \u3067\u30ce\u30f3\u30d1\u30b9\u3067\u5b9f\u884c\u3067\u304d\u308b\u3088\u3046\u306b\u8a2d\u5b9a\u3092\u3057\u3066\u304f\u3002\uff08visudo\u5b9f\u884c\u306b\u3088\u308b\uff09\n\n/etc/sudoers\n%zfsuser        ALL=(ALL)       NOPASSWD: ALL\n\n\n\nmanila create \u6642\u306e\u30a8\u30e9\u30fc\u306b\u5bfe\u3057\u3066\u306e\u30ef\u30fc\u30af\u30a2\u30e9\u30a6\u30f3\u30c9\n\u4e3b\u306b\u30de\u30cb\u30e5\u30a2\u30eb\u306b\u8a18\u8f09\u3055\u308c\u3066\u306a\u304b\u3063\u305f\u308a\u3001\u8a66\u3057\u3066\u6c17\u3065\u3044\u305f\u3068\u3053\u308d\u306e\u56de\u907f\u7b56\u3002\n\n\u300csorry, you must have a tty to run sudo\u300d\n\nssh \u3057\u305f\u5f8c\u306e sudo \u5b9f\u884c\u3092\u8a31\u53ef\u3059\u308b\u305f\u3081\u306b\u3059\u308b\u305f\u3081\u306b\u300cDefaults requiretty\u300d\u306f\u30b3\u30e1\u30f3\u30c8\u30a2\u30a6\u30c8\u3002\n\n/etc/sudoers\n#Defaults    requiretty\n\n\n\n\nZFSonLinux \u3067 exportfs \u304c\u306a\u3044\u3068\u30a8\u30e9\u30fc\u304c\u3067\u305f\u51e6\u7406\n/usr/local/bin , /usr/bin \u3078 exportfs \u3092\u63a2\u3057\u306b\u3044\u3063\u3066\u3044\u308b\u3088\u3046\u3060\u3063\u305f\u306e\u3067\u3001\u4eca\u56de\u306e\u74b0\u5883\u3067\u306f\u30b7\u30f3\u30dc\u30ea\u30c3\u30af\u30ea\u30f3\u30af\u3067\u5bfe\u5fdc\u3002\n\n#  ln -s /usr/sbin/exportfs /usr/local/bin/exportfs\n\n\n\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u30a2\u30af\u30bb\u30b9\u306e\u8a31\u53ef\uff08Allow IP\u30a2\u30c9\u30ec\u30b9\uff09\u3067\u30a8\u30e9\u30fc\u306b\u306a\u308b\u4ef6\n\n\u30a8\u30e9\u30fc\u3092\u30c9\u30ea\u30eb\u30c0\u30a6\u30f3\u3057\u3066\u3044\u304f\u3068\u3001\u4f7f\u3063\u3066\u3044\u308bZFS\u304cFuse\u5b9f\u88c5\u306a\u306e\u304bkernel\u30e2\u30b8\u30e5\u30fc\u30eb\u5b9f\u88c5\u306a\u306e\u304b\u3067 export \u3059\u308b\u969b\u306b\u30aa\u30d7\u30b7\u30e7\u30f3\u3092\u5909\u3048\u308b\u5206\u5c90\u304c\u3042\u308a\u3001\u305d\u3053\u3067\u4f7f\u3063\u3066\u3044\u308b modinfo \u306e\u547c\u3073\u51fa\u3057\u90e8\u5206\u3067\u300cmodinfo\u300d\u304c\u898b\u3064\u304b\u3089\u306a\u3044\u305f\u3081\u5931\u6557\u3057\u3066\u308b\u3002\u5358\u306b modinfo \u4f7f\u3046\u305f\u3081\u306b sudo \u5fd8\u308c\u3066\u3044\u308b\u3060\u3051\u3002\n/usr/lib/python2.7/site-packages/manila/share/drivers/zfsonlinux/utils.py \u3092\u4fee\u6b63\n# pwd\n/usr/lib/python2.7/site-packages/manila/share/drivers/zfsonlinux/utils.py\n\n# diff back.utils.py utils.py\n176c176,177\n<                 self.execute('modinfo', 'zfs')\n---\n>                 self.execute('sudo','modinfo', 'zfs')\n>                 #self.execute('modinfo', 'zfs')\n\n# python -m compileall utils.py\n\n# systemctl restart openstack-manila-share\n\n\nManila\u69cb\u6210\u3068\u8a2d\u5b9a\n\nmanila.conf \u8a2d\u5b9a\n\u8a2d\u5b9a\u306e\u4e2d\u5fc3\u306f\u300cmanila.conf\u300d\u3067\u3059\u3002\u300cZFS\u3092\u30d0\u30c3\u30af\u30a8\u30f3\u30c9\u3067\u4f7f\u3046\u300d\u305f\u3081\u306e\u60c5\u5831\u3092\u5165\u308c\u308b\u3002\u5177\u4f53\u7684\u306b\u306f\u30bb\u30af\u30b7\u30e7\u30f3\u306e\u8ffd\u52a0\u3068\u3001\u6709\u52b9\u5316\u3002\n\nmanila.conf\n\nenabled_share_backends = generic , zfs\n\n[zfs]\nshare_driver = manila.share.drivers.zfsonlinux.driver.ZFSonLinuxShareDriver\ndriver_handles_share_servers = False\nzfs_share_export_ip = 192.168.0.4\nzfs_service_ip = 192.168.0.4\nzfs_zpool_list = trank\nzfs_share_helpers = NFS=manila.share.drivers.zfsonlinux.utils.NFSviaZFSHelper\nzfs_use_ssh = True\nzfs_ssh_username = zfsuser\n#zfs_ssh_user_password = password\nzfs_ssh_private_key_path = /etc/manila/nonpass.key\nzfs_dataset_creation_options = dedup=off\nshare_backend_name = zfs\n\n\n\nZFSonLinux \u30b5\u30fc\u30d0\u306e\u5b9b\u5148\u3092\u6307\u5b9a\n\u4e8b\u524d\u306b\u4f5c\u6210\u3057\u305f\u30d7\u30fc\u30eb\u540d\u3092\u6307\u5b9a\nSSH\u306e\u30e6\u30fc\u30b6\u540d\u3092\u6307\u5b9a\uff08\u4eca\u56de\u306f\u9375\u3092\u4f7f\u3063\u3066\u30ce\u30f3\u30d1\u30b9\u30a2\u30af\u30bb\u30b9\uff09\n\n\u30aa\u30d7\u30b7\u30e7\u30f3\u306e\u8a73\u7d30 ZFSonLinux-Driver\n\u8a2d\u5b9a\u304c\u7d42\u308f\u3063\u305f\u3089 Manila \u30b5\u30fc\u30d3\u30b9\u3092\u518d\u8d77\u52d5\u3001manila service-list \u3067\u78ba\u8a8d\u3002\n# systemctl restart openstack-manila-api.service\n# systemctl restart openstack-manila-scheduler.service\n# systemctl restart openstack-manila-share.service\n\n# manila service-list\n+----+------------------+-------------------------+------+---------+-------+----------------------------+\n| Id | Binary           | Host                    | Zone | Status  | State | Updated_at                 |\n+----+------------------+-------------------------+------+---------+-------+----------------------------+\n| 1  | manila-scheduler | akira.tk.net            | nova | enabled | up    | 2016-07-02T02:04:35.000000 |\n| 2  | manila-share     | akira.tk.net@generic    | nova | enabled | up    | 2016-07-02T02:04:30.000000 |\n| 3  | manila-share     | akira.tk.net@akira      | nova | enabled | down  | 2016-06-30T04:26:48.000000 |\n| 4  | manila-share     | akira.tk.net@locallvm   | nova | enabled | up    | 2016-07-02T02:04:31.000000 |\n| 5  | manila-share     | akira.tk.net@zfs        | nova | enabled | up    | 2016-07-02T02:04:31.000000 |\n+----+------------------+-------------------------+------+---------+-------+----------------------------+\n\n\n\n\u4e0a\u8a18\u3067\u8a00\u3046\u3068\u3001\u30a8\u30f3\u30c8\u30ea\u300c5\u300d\u306e\u3068\u3053\u308d\u304c\u8ffd\u52a0\u3057\u305f\u3068\u3053\u308d\u3067\u3042\u308a\u3001Status : enabled \u3001 State : up \u3068\u306a\u3063\u3066\u3044\u308c\u3070OK\u3002\n\n\u30bf\u30a4\u30d7\u8a2d\u5b9a\n\u30bf\u30a4\u30d7\u3068\u305d\u308c\u306b\u7d10\u3065\u304f\u30d0\u30c3\u30af\u30a8\u30f3\u30c9\u3092\u8a2d\u5b9a\u3059\u308b\u3002\n\n\u3053\u3053\u306f\u3001Cinder \u306e\u6642\u3068\u3068\u540c\u3058\u3088\u3046\u306b\u4f5c\u308b\u3002\n\n(admin) # manila type-create zfs False\n(admin) # manila type-list\n+--------------------------------------+--------------------+------------+------------+--------------------------------------+-------------------------+\n| ID                                   | Name               | visibility | is_default | required_extra_specs                 | optional_extra_specs    |\n+--------------------------------------+--------------------+------------+------------+--------------------------------------+-------------------------+\n| 617d0932-7904-4229-ad5d-cf23df2cf2e1 | akira              | public     | -          | driver_handles_share_servers : False | snapshot_support : True |\n| e0a86b9b-63ff-48a9-a689-d6f667ec5e94 | default_share_type | public     | -          | driver_handles_share_servers : True  | snapshot_support : True |\n| ec19ec3e-de2e-464c-b5f7-354b1c0c8a03 | zfs                | public     | -          | driver_handles_share_servers : False | snapshot_support : True |\n+--------------------------------------+--------------------+------------+------------+--------------------------------------+-------------------------+\n\n(admin) # manila type-key zfs set share_backend_name=zfs \n(admin) # manila extra-specs-list\n+--------------------------------------+--------------------+--------------------------------------+\n| ID                                   | Name               | all_extra_specs                      |\n+--------------------------------------+--------------------+--------------------------------------+\n| 617d0932-7904-4229-ad5d-cf23df2cf2e1 | akira              | snapshot_support : True              |\n|                                      |                    | share_backend_name : locallvm        |\n|                                      |                    | driver_handles_share_servers : False |\n| e0a86b9b-63ff-48a9-a689-d6f667ec5e94 | default_share_type | snapshot_support : True              |\n|                                      |                    | driver_handles_share_servers : True  |\n| ec19ec3e-de2e-464c-b5f7-354b1c0c8a03 | zfs                | snapshot_support : True              |\n|                                      |                    | share_backend_name : zfs             |\n|                                      |                    | driver_handles_share_servers : False |\n+--------------------------------------+--------------------+--------------------------------------+\n\n\n\n\u30b7\u30a7\u30a2\u306e\u4f5c\u6210\uff08\u30d5\u30a1\u30a4\u30eb\u30b5\u30fc\u30d0\uff09\n\u30bf\u30a4\u30d7\u3068\u3057\u3066\u3001NFS\u30b7\u30a7\u30a2\u3092\u8a66\u307f\u308b\u3002\n(demo) # manila create NFS 5 --name zfsvol --share-type zfs\n+-----------------------------+--------------------------------------+\n| Property                    | Value                                |\n+-----------------------------+--------------------------------------+\n| status                      | creating                             |\n| share_type_name             | zfs                                  |\n| description                 | None                                 |\n| availability_zone           | None                                 |\n| share_network_id            | None                                 |\n| host                        |                                      |\n| access_rules_status         | active                               |\n| snapshot_id                 | None                                 |\n| is_public                   | False                                |\n| task_state                  | None                                 |\n| snapshot_support            | True                                 |\n| id                          | 77309678-c7b8-45d0-83c1-a6f7b4b545d8 |\n| size                        | 5                                    |\n| name                        | zfsvol                               |\n| share_type                  | ec19ec3e-de2e-464c-b5f7-354b1c0c8a03 |\n| has_replicas                | False                                |\n| replication_type            | None                                 |\n| created_at                  | 2016-09-11T05:01:18.000000           |\n| share_proto                 | NFS                                  |\n| consistency_group_id        | None                                 |\n| source_cgsnapshot_member_id | None                                 |\n| project_id                  | 7116ec60ce72461fa4a12f567a8eb4eb     |\n| metadata                    | {}                                   |\n+-----------------------------+--------------------------------------+\n(demo) # manila list\n+--------------------------------------+--------+------+-------------+----------+-----------+-----------------+------------------------+-------------------+\n| ID                                   | Name   | Size | Share Proto | Status   | Is Public | Share Type Name | Host                   | Availability Zone |\n+--------------------------------------+--------+------+-------------+----------+-----------+-----------------+------------------------+-------------------+\n| 77309678-c7b8-45d0-83c1-a6f7b4b545d8 | zfsvol | 5    | NFS         | creating | False     | zfs             | akira.tk.net@zfs#trank | nova              |\n+--------------------------------------+--------+------+-------------+----------+-----------+-----------------+------------------------+-------------------+\n(demo) # manila list\n+--------------------------------------+--------+------+-------------+-----------+-----------+-----------------+------------------------+-------------------+\n| ID                                   | Name   | Size | Share Proto | Status    | Is Public | Share Type Name | Host                   | Availability Zone |\n+--------------------------------------+--------+------+-------------+-----------+-----------+-----------------+------------------------+-------------------+\n| 77309678-c7b8-45d0-83c1-a6f7b4b545d8 | zfsvol | 5    | NFS         | available | False     | zfs             | akira.tk.net@zfs#trank | nova              |\n+--------------------------------------+--------+------+-------------+-----------+-----------+-----------------+------------------------+-------------------+\n\n\nZFSonLinux \u5074\u306f\u3069\u3046\u304b\u3068\u3044\u3046\u3068\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u30d7\u30fc\u30eb\u304b\u3089\u30dc\u30ea\u30e5\u30fc\u30e0\u304c\u5207\u308a\u3060\u3055\u308c\u3066\u3044\u308b\u3002\n(ZFSonLinux) # zfs list\nNAME                                                      USED  AVAIL  REFER  MOUNTPOINT\ntrank                                                     239K  9.63G    19K  /trank\ntrank/manila_share_bff9e10d_37e4_4d33_ab5d_b8d7baaae4d1    19K  5.00G    19K  /trank/manila_share_bff9e10d_37e4_4d33_ab5d_b8d7baaae4d1\n\n(ZFSonLinux) # df -k\n\u30d5\u30a1\u30a4\u30eb\u30b7\u30b9                                            1K-\u30d6\u30ed\u30c3\u30af    \u4f7f\u7528   \u4f7f\u7528\u53ef \u4f7f\u7528% \u30de\u30a6\u30f3\u30c8\u4f4d\u7f6e\n/dev/mapper/centos-root                                    18307072 1796672 16510400   10% /\ndevtmpfs                                                     932192       0   932192    0% /dev\ntmpfs                                                        942252       0   942252    0% /dev/shm\ntmpfs                                                        942252    8780   933472    1% /run\ntmpfs                                                        942252       0   942252    0% /sys/fs/cgroup\ntrank                                                      10094336       0 10094336    0% /trank\n/dev/sda1                                                    508588  169996   338592   34% /boot\ntmpfs                                                        188452       0   188452    0% /run/user/0\ntmpfs                                                        188452       0   188452    0% /run/user/1000\ntrank/manila_share_bff9e10d_37e4_4d33_ab5d_b8d7baaae4d1     5242880     128  5242752    1% /trank/manila_share_bff9e10d_37e4_4d33_ab5d_b8d7baaae4d1\n\n\n\u3053\u308c\u3060\u3051\u3060\u3068\u3001NFS\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u306f\u7e4b\u3052\u3089\u308c\u306a\u3044\u306e\u3067\u3001\u8a31\u53ef\u8a2d\u5b9a\u3092\u3059\u308b\u3002\n\n(demo) # manila access-allow zfsvol ip 192.168.0.154\n+--------------+--------------------------------------+\n| Property     | Value                                |\n+--------------+--------------------------------------+\n| share_id     | 77309678-c7b8-45d0-83c1-a6f7b4b545d8 |\n| access_type  | ip                                   |\n| access_to    | 192.168.0.154                        |\n| access_level | rw                                   |\n| state        | new                                  |\n| id           | c59bf658-8bc2-4b4a-ad91-c9c5bd1d47ee |\n+--------------+--------------------------------------+\n\n(demo) # manila access-list zfsvol\n+--------------------------------------+-------------+---------------+--------------+--------+\n| id                                   | access_type | access_to     | access_level | state  |\n+--------------------------------------+-------------+---------------+--------------+--------+\n| c59bf658-8bc2-4b4a-ad91-c9c5bd1d47ee | ip          | 192.168.0.154 | rw           | active |\n+--------------------------------------+-------------+---------------+--------------+--------+\n\n\u3059\u308b\u3068 ZFSonLinux \u3067\u306f\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u30a8\u30af\u30b9\u30dd\u30fc\u30c8\u3055\u308c\u3066\u3044\u308b\u3002\n(ZFSonLinux) # exportfs\n/trank/manila_share_bff9e10d_37e4_4d33_ab5d_b8d7baaae4d1\n                192.168.0.154\n\n\u5b9f\u969b\u306bNFS\u30de\u30a6\u30f3\u30c8\u3057\u3066\u307f\u308b\u3002\n\u30de\u30a6\u30f3\u30c8\u30dd\u30a4\u30f3\u30c8\u3092\u6539\u3081\u3066\u78ba\u8a8d\u3002\n(demo) # manila share-export-location-list zfsvol\n+--------------------------------------+----------------------------------------------------------------------+-----------+\n| ID                                   | Path                                                                 | Preferred |\n+--------------------------------------+----------------------------------------------------------------------+-----------+\n| 12ad1380-fff4-4bb0-aa4a-455550a4fa52 | 192.168.0.4:/trank/manila_share_bff9e10d_37e4_4d33_ab5d_b8d7baaae4d1 | False     |\n+--------------------------------------+----------------------------------------------------------------------+-----------+\n\n\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u304b\u3089\u30de\u30a6\u30f3\u30c8\u3002\n(Client) # mount 192.168.0.4:/trank/manila_share_bff9e10d_37e4_4d33_ab5d_b8d7baaae4d1 /mnt\n(Client) # df -h\nFilesystem                                                            Size  Used Avail Use% Mounted on\n/dev/vda1                                                              40G  6.2G   34G  16% /\ndevtmpfs                                                              1.9G     0  1.9G   0% /dev\ntmpfs                                                                 1.9G     0  1.9G   0% /dev/shm\ntmpfs                                                                 1.9G   17M  1.9G   1% /run\ntmpfs                                                                 1.9G     0  1.9G   0% /sys/fs/cgroup\ntmpfs                                                                 380M     0  380M   0% /run/user/1000\n192.168.0.4:/trank/manila_share_bff9e10d_37e4_4d33_ab5d_b8d7baaae4d1  5.0G     0  5.0G   0% /mnt\n\n(Client) # echo \"Hellow World\" >> /mnt/testfile\n\n(Client) # more /mnt/testfile\nHellow World\n\n\n\u30b7\u30a7\u30a2\u306e\u524a\u9664\n\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u304b\u3089\u30a2\u30f3\u30de\u30a6\u30f3\u30c8\u3057\u3066\u304a\u304f\u3002\n(demo) # manila delete zfsvol\n\n(demo) # manila list\n+----+------+------+-------------+--------+-----------+-----------------+------+-------------------+\n| ID | Name | Size | Share Proto | Status | Is Public | Share Type Name | Host | Availability Zone |\n+----+------+------+-------------+--------+-----------+-----------------+------+-------------------+\n+----+------+------+-------------+--------+-----------+-----------------+------+-------------------+\n\nZFSonLinux \u5074\u3082\u524a\u9664\u3055\u308c\u308b\u3002\n(ZFSonLinux) # zfs list\nNAME    USED  AVAIL  REFER  MOUNTPOINT\ntrank   223K  9.63G    19K  /trank\n\n(ZFSonLinux) # exportfs\n(ZFSonLinux) #\n\n\n\u53c2\u8003\n\nZFSonLinux\n\nOpenStack Days \u8b1b\u6f14\u8cc7\u6599\u30a2\u30ea\nManila share features support mapping\nManila \u3092 RDO \u3067\u8a66\u3057\u3066\u307f\u308b\uff08\u6e96\u5099\u7de8\uff09\n\n\u672c\u7a3f\u306f\u3001OpenStack Days 2016 Tokyo \u3067\u767a\u8868\u3055\u305b\u3066\u3082\u3089\u3063\u305f\u4e2d\u3067\u8a66\u3057\u305f **ZFSonLinux** \u3092\u30d0\u30c3\u30af\u30a8\u30f3\u30c9\u3068\u3057\u3066\u8a66\u3057\u305f\u8a73\u7d30\u3092\u4f55\u56de\u304b\u306b\u5206\u3051\u3066\u8a18\u8f09\u3057\u307e\u3059\u3002\u4eca\u56de\u521d\u56de\u306a\u306e\u3067\u3001\u307e\u305a\u30d5\u30a1\u30a4\u30eb\u30b7\u30a7\u30a2\u304c\u51fa\u6765\u304d\u3001\u30de\u30a6\u30f3\u30c8\u3059\u308b\u307e\u3067\u3067\u3059\u3002\n\n# OpenStack Manila \u6982\u8981\nOpenStack \u306e\u4e2d\u3067\u30d5\u30a1\u30a4\u30eb\u30b5\u30fc\u30d0\u3092\u63d0\u4f9b\u3059\u308b\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u3067\u3059\u3002\u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3\u306f **Cinder** \u3068\u975e\u5e38\u306b\u826f\u304f\u4f3c\u3066\u3044\u308b\u306e\u3067\u8003\u3048\u65b9\u69cb\u6210\u306a\u3069\u306f\u7406\u89e3\u3057\u3084\u3059\u3044\u3068\u601d\u308f\u308c\u308b\u3002\n\n\u5358\u54c1\u3067\u8a66\u3059\u5834\u5408\u306f\u3053\u3061\u3089\u3002[OpenStack Manila on RDO](http://qiita.com/tksarah/items/3368b6e502ce5092340b)\n\n# ZFSonLinux\nZFS\u306f\u5143\u3005Solaris\u3067\u5b9f\u88c5\u3055\u308c\u3066\u3044\u305f\u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0\u3067\u3057\u305f\u304c\u3001Linux\u4e0a\u3067\u3082\u4f7f\u3048\u308b\u3088\u3046\u306b\u3057\u305f\u306e\u304c\u3053\u308c\u3002\u3053\u3053\u304b\u3089\u306f**2016\u5e747\u6708\u6642\u70b9**\u3067\u306e\u500b\u4eba\u7684\u898b\u89e3\u3067\u306f\u3042\u308b\u304c\u3001\u4f7f\u3044\u52dd\u624b\u3082\u697d\u3067\u975e\u5e38\u306b\u30b9\u30c8\u30ec\u30fc\u30b8\u3068\u3057\u3066\u591a\u6a5f\u80fd\u3067\u3042\u308b\u305f\u3081\u3001OpenStack\u306e\u30d0\u30c3\u30af\u30a8\u30f3\u30c9\u3068\u3057\u3066\u5229\u7528\u3059\u308b\u306b\u306f\u5546\u7528\uff08\u30a8\u30f3\u30bf\u30fc\u30d7\u30e9\u30a4\u30ba\u30b9\u30c8\u30ec\u30fc\u30b8\uff09\u306b\u5f15\u3051\u3092\u3068\u3089\u306a\u3044\u3068\u3044\u3046\u3053\u3068\u3082\u3042\u308a\u4eca\u56de\u9078\u629e\u3057\u305f\u3002\u6280\u8853\u8005\u3068\u3057\u3066\u306f\u3044\u308d\u3044\u308d\u8a66\u305b\u308b\u65b9\u304c\u9762\u767d\u3044\u3068\u3044\u3046\u306e\u3082\u3042\u308b\u3002\n\nManila\u3067\u30b5\u30dd\u30fc\u30c8\u3055\u308c\u3066\u3044\u308b\u6a5f\u80fd\u4e00\u89a7\u3068\u3057\u3066\u306f\u3053\u3061\u3089\u3092\u53c2\u7167\u3002[Manila share features support mapping](http://docs.openstack.org/developer/manila/devref/share_back_ends_feature_support_mapping.html)\n\n# \u8a55\u4fa1\u74b0\u5883\n## \u8a55\u4fa1\u30de\u30b7\u30f3 \nOpenStack , ZFSonLinux \u5171\u306b\u3001\n**CentOS Linux release 7.2.1511 (Core)**\n\n## OpenStack Mitaka Release (centos-release-openstack-mitaka-1-3.el7)\nopenstack-manila-2.0.0-1.el7.noarch\nopenstack-manila-ui-2.1.0-1.el7.noarch\npython-manila-2.0.0-1.el7.noarch\nopenstack-manila-share-2.0.0-1.el7.noarch\npython-manilaclient-1.8.1-1.el7.noarch\n\n## ZFS\nzfs-release.el7.noarch.rpm\ndkms-2.2.0.3-34.git.9e0394d.el7.noarch.rpm\n\n\n# \u8a55\u4fa1\u9805\u76ee\n\u4e0b\u8a18\u306e\u6a5f\u80fd\u3092\u8a55\u4fa1\n\n* Create Share\n* Delete Share\n* Allow NFS Share access\n* Deny NFS Share access\n* Create Snapshot\n* Delete Snapshot\n* Create share from snapshot\n* Extend Share\n* Shrink Share\n\n\n# \u69cb\u6210\u30a4\u30e1\u30fc\u30b8\n\u4eca\u56de\u3001ZFSonLinux \u30b5\u30fc\u30d0\u306f\u5225\u5efa\u3066\u3057\u3066\u3044\u308b\u3002\n\n![zfsonlinux-manila-image.jpg](https://qiita-image-store.s3.amazonaws.com/0/75458/e3588bcc-d4b5-17ce-af7a-1374d32240c4.jpeg)\n\n# \u30d5\u30a1\u30a4\u30eb\u30b7\u30a7\u30a2\uff08\u3053\u3053\u3067\u306f\u30d5\u30a1\u30a4\u30eb\u30b5\u30fc\u30d0\uff09\u304c\u51fa\u6765\u308b\u307e\u3067\u306e\u6d41\u308c\n\n1. manila-api \u30ea\u30af\u30a8\u30b9\u30c8\n2. manila-scheduler \u30b9\u30b1\u30b8\u30e5\u30fc\u30ea\u30f3\u30b0\n3. manila-share \u51e6\u7406\n    1. \u51e6\u7406\u3092\u3059\u308b\u904e\u7a0b\u3068\u3057\u3066\u3001SSH\u7d4c\u7531\u3067ZFSonLinux\u306b\u63a5\u7d9a\u3059\u308b\uff08\u30d1\u30b9\u30ef\u30fc\u30c9\u3001\u9375\u8a8d\u8a3c\uff09\n    2. ZFSonLinux \u30b5\u30fc\u30d0\u5074\u306f\u30d7\u30fc\u30eb\u304b\u3089\u30dc\u30ea\u30e5\u30fc\u30e0\u3092\u5207\u308a\u51fa\u3059\n    3. \u5207\u308a\u3060\u3055\u308c\u305f\u30d7\u30fc\u30eb\u3092\u30a8\u30af\u30b9\u30dd\u30fc\u30c8\u3059\u308b\n4. manila-share \u5b8c\u4e86\n\n# \u69cb\u7bc9\u624b\u9806\n\u524d\u63d0\u3068\u3057\u3066\u3001OpenStack Manila \u306e\u5c0e\u5165\u305d\u306e\u3082\u306e\u306f\u7d42\u308f\u3063\u3066\u3044\u308b\u3082\u306e\u3068\u3059\u308b\u3002\u3053\u306e\u90e8\u5206\u306b\u3064\u3044\u3066\u306f**\u53c2\u8003**\u306b\u3064\u3051\u3066\u3044\u308b\u30da\u30fc\u30b8\u3092\u53c2\u7167\u3002\n\n## ZFS\u69cb\u6210\u3068\u8a2d\u5b9a\n### ZFS\u306e\u5c0e\u5165\n\n* https://github.com/zfsonlinux/zfs/wiki/RHEL-%26-CentOS\n\n```shell-session\n# yum update\n# yum groupinstall \"Development tools\"\n# yum install epel-release\n# yum localinstall --nogpgcheck http://archive.zfsonlinux.org/epel/zfs-release$(rpm -E %dist).noarch.rpm\n# gpg --quiet --with-fingerprint /etc/pki/rpm-gpg/RPM-GPG-KEY-zfsonlinux\n# yum install kernel-devel zfs\n```\n### ZPool \u4f5c\u6210\n\u3053\u306eZFSonLinux\u306e\u30b5\u30fc\u30d0\u306b\u306f10GB\u306eHDD\u3092\u5916\u4ed8\u3051\u3067**4\u3064**\u3064\u3051\u3066\u304a\u308a\u3001\u305d\u308c\u3092\u4eca\u56deZPool\u3068\u3057\u3066\u5272\u308a\u5f53\u3066\u308b\u3002RAID\u3068\u3057\u3066**raidz3**\u3092\u6307\u5b9a\u3057\u3001\u300c**trank**\u300d\u3068\u3044\u3046\u30d7\u30fc\u30eb\u540d\u3067\u4f5c\u6210\u3002\n\n\n```shell-session\n# modrobe zfs\n# cat /proc/filesystems |grep zfs\nnodev   zfs\n\n# zpool create trank raidz3 /dev/sdb /dev/sdc /dev/sdd /dev/sde -f \n\n# zpool status\n  pool: trank\n state: ONLINE\n  scan: none requested\nconfig:\n\n        NAME        STATE     READ WRITE CKSUM\n        trank       ONLINE       0     0     0\n          raidz3-0  ONLINE       0     0     0\n            sdb     ONLINE       0     0     0\n            sdc     ONLINE       0     0     0\n            sdd     ONLINE       0     0     0\n            sde     ONLINE       0     0     0\n\nerrors: No known data errors\n\n# zpool list\nNAME    SIZE  ALLOC   FREE  EXPANDSZ   FRAG    CAP  DEDUP  HEALTH  ALTROOT\ntrank  39.8G   256K  39.7G         -     0%     0%  1.00x  ONLINE  -\n\n# LANG=C df -h\nFilesystem               Size  Used Avail Use% Mounted on\n/dev/mapper/centos-root   18G  1.8G   16G  10% /\ndevtmpfs                 911M     0  911M   0% /dev\ntmpfs                    921M     0  921M   0% /dev/shm\ntmpfs                    921M  8.6M  912M   1% /run\ntmpfs                    921M     0  921M   0% /sys/fs/cgroup\ntrank                    9.7G     0  9.7G   0% /trank                  <= \u3053\u308c\n/dev/sda1                497M  167M  331M  34% /boot\ntmpfs                    185M     0  185M   0% /run/user/0\n```\n\n### NFS Server \u3092\u8d77\u52d5\n\u3057\u3066\u3044\u306a\u3051\u308c\u3070\u8d77\u52d5\u3002\n\n```shell-session\n# systemctl start nfs-server\n# systemctl enable nfs-server\n```\n\n### SSH\u30e6\u30fc\u30b6\u306e\u4f5c\u6210\nmanila-share \u3067\u51e6\u7406\u3055\u308c\u308b\u305f\u3081\u306e\u30a2\u30af\u30bb\u30b9\u30e6\u30fc\u30b6\u3068\u3057\u3066\u3001\u300c**zfsuser**\u300d\u3092\u4f5c\u308b\u3002\n>\u4eca\u56de\u306e\u74b0\u5883\u3067\u306f\u3001OpenStack Manila \u5074\u3067\u306f\u3001manila-share \u304c manila \u30e6\u30fc\u30b6\u3067\u52d5\u3044\u3066\u3044\u308b\u306e\u3067\u3001\u3053\u306e manila \u30e6\u30fc\u30b6\u304c ssh \u3092\u53e9\u3044\u3066 ZFSonLinux \u30b5\u30fc\u30d0\u306b\u51e6\u7406\u4f9d\u983c\u3002\u9375\u3092\u4f5c\u3063\u3066\u3001\u79d8\u5bc6\u9375\u3092 manila-share \u304c\u7a3c\u50cd\u3057\u3066\u3044\u308b\u6240\u5b9a\u306e\u5834\u6240\u306b\u914d\u7f6e\u3059\u308b\u3002\uff08\u4eca\u56de\u306f\u3001/etc/manila/nonpass.key \u5c5e\u6027\u306f 0440 \u3068\u3057\u305f\uff09\n\n\u307e\u305f\u3001zfsuser \u30e6\u30fc\u30b6\u3067 ZFS\u306e\u7ba1\u7406\u30b3\u30de\u30f3\u30c9\u306f\u5b9f\u884c\u3067\u304d\u306a\u3044\u306e\u3067\u3001ssh\u3067\u30a2\u30af\u30bb\u30b9\u5f8c\u306f\u3001sudo \u306b\u3088\u308a ZFS \u7ba1\u7406\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3059\u308b\u3002\u3053\u3053\u3067\u3082 sudo \u3067\u30ce\u30f3\u30d1\u30b9\u3067\u5b9f\u884c\u3067\u304d\u308b\u3088\u3046\u306b\u8a2d\u5b9a\u3092\u3057\u3066\u304f\u3002\uff08visudo\u5b9f\u884c\u306b\u3088\u308b\uff09\n\n```{file:/etc/sudoers}\n%zfsuser        ALL=(ALL)       NOPASSWD: ALL\n```\n\n### manila create \u6642\u306e\u30a8\u30e9\u30fc\u306b\u5bfe\u3057\u3066\u306e\u30ef\u30fc\u30af\u30a2\u30e9\u30a6\u30f3\u30c9\n\u4e3b\u306b\u30de\u30cb\u30e5\u30a2\u30eb\u306b\u8a18\u8f09\u3055\u308c\u3066\u306a\u304b\u3063\u305f\u308a\u3001\u8a66\u3057\u3066\u6c17\u3065\u3044\u305f\u3068\u3053\u308d\u306e\u56de\u907f\u7b56\u3002\n\n* **\u300csorry, you must have a tty to run sudo\u300d**\n\nssh \u3057\u305f\u5f8c\u306e sudo \u5b9f\u884c\u3092\u8a31\u53ef\u3059\u308b\u305f\u3081\u306b\u3059\u308b\u305f\u3081\u306b\u300cDefaults requiretty\u300d\u306f\u30b3\u30e1\u30f3\u30c8\u30a2\u30a6\u30c8\u3002\n\n```{file:/etc/sudoers}\n#Defaults    requiretty\n```\n\n\n* **ZFSonLinux \u3067 exportfs \u304c\u306a\u3044\u3068\u30a8\u30e9\u30fc\u304c\u3067\u305f\u51e6\u7406**\n/usr/local/bin , /usr/bin \u3078 exportfs \u3092\u63a2\u3057\u306b\u3044\u3063\u3066\u3044\u308b\u3088\u3046\u3060\u3063\u305f\u306e\u3067\u3001\u4eca\u56de\u306e\u74b0\u5883\u3067\u306f\u30b7\u30f3\u30dc\u30ea\u30c3\u30af\u30ea\u30f3\u30af\u3067\u5bfe\u5fdc\u3002\n\n```shell-session\n#  ln -s /usr/sbin/exportfs /usr/local/bin/exportfs\n```\n\n* **\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u30a2\u30af\u30bb\u30b9\u306e\u8a31\u53ef\uff08Allow IP\u30a2\u30c9\u30ec\u30b9\uff09\u3067\u30a8\u30e9\u30fc\u306b\u306a\u308b\u4ef6**\n\n\u30a8\u30e9\u30fc\u3092\u30c9\u30ea\u30eb\u30c0\u30a6\u30f3\u3057\u3066\u3044\u304f\u3068\u3001\u4f7f\u3063\u3066\u3044\u308bZFS\u304cFuse\u5b9f\u88c5\u306a\u306e\u304bkernel\u30e2\u30b8\u30e5\u30fc\u30eb\u5b9f\u88c5\u306a\u306e\u304b\u3067 export \u3059\u308b\u969b\u306b\u30aa\u30d7\u30b7\u30e7\u30f3\u3092\u5909\u3048\u308b\u5206\u5c90\u304c\u3042\u308a\u3001\u305d\u3053\u3067\u4f7f\u3063\u3066\u3044\u308b modinfo \u306e\u547c\u3073\u51fa\u3057\u90e8\u5206\u3067\u300cmodinfo\u300d\u304c\u898b\u3064\u304b\u3089\u306a\u3044\u305f\u3081\u5931\u6557\u3057\u3066\u308b\u3002\u5358\u306b modinfo \u4f7f\u3046\u305f\u3081\u306b **sudo** \u5fd8\u308c\u3066\u3044\u308b\u3060\u3051\u3002\n/usr/lib/python2.7/site-packages/manila/share/drivers/zfsonlinux/utils.py \u3092\u4fee\u6b63\n\n```shell-session\n# pwd\n/usr/lib/python2.7/site-packages/manila/share/drivers/zfsonlinux/utils.py\n\n# diff back.utils.py utils.py\n176c176,177\n<                 self.execute('modinfo', 'zfs')\n---\n>                 self.execute('sudo','modinfo', 'zfs')\n>                 #self.execute('modinfo', 'zfs')\n\n# python -m compileall utils.py\n\n# systemctl restart openstack-manila-share\n```\n\n## Manila\u69cb\u6210\u3068\u8a2d\u5b9a\n### manila.conf \u8a2d\u5b9a\n\u8a2d\u5b9a\u306e\u4e2d\u5fc3\u306f\u300cmanila.conf\u300d\u3067\u3059\u3002\u300cZFS\u3092\u30d0\u30c3\u30af\u30a8\u30f3\u30c9\u3067\u4f7f\u3046\u300d\u305f\u3081\u306e\u60c5\u5831\u3092\u5165\u308c\u308b\u3002\u5177\u4f53\u7684\u306b\u306f\u30bb\u30af\u30b7\u30e7\u30f3\u306e\u8ffd\u52a0\u3068\u3001\u6709\u52b9\u5316\u3002\n\n\n```{manila.conf}\n\nenabled_share_backends = generic , zfs\n\n[zfs]\nshare_driver = manila.share.drivers.zfsonlinux.driver.ZFSonLinuxShareDriver\ndriver_handles_share_servers = False\nzfs_share_export_ip = 192.168.0.4\nzfs_service_ip = 192.168.0.4\nzfs_zpool_list = trank\nzfs_share_helpers = NFS=manila.share.drivers.zfsonlinux.utils.NFSviaZFSHelper\nzfs_use_ssh = True\nzfs_ssh_username = zfsuser\n#zfs_ssh_user_password = password\nzfs_ssh_private_key_path = /etc/manila/nonpass.key\nzfs_dataset_creation_options = dedup=off\nshare_backend_name = zfs\n```\n\n* ZFSonLinux \u30b5\u30fc\u30d0\u306e\u5b9b\u5148\u3092\u6307\u5b9a\n* \u4e8b\u524d\u306b\u4f5c\u6210\u3057\u305f\u30d7\u30fc\u30eb\u540d\u3092\u6307\u5b9a\n* SSH\u306e\u30e6\u30fc\u30b6\u540d\u3092\u6307\u5b9a\uff08\u4eca\u56de\u306f\u9375\u3092\u4f7f\u3063\u3066\u30ce\u30f3\u30d1\u30b9\u30a2\u30af\u30bb\u30b9\uff09\n\n\u30aa\u30d7\u30b7\u30e7\u30f3\u306e\u8a73\u7d30 [ZFSonLinux-Driver](http://docs.openstack.org/mitaka/config-reference/shared-file-systems/drivers/zfs-on-linux-driver.html)\n\n\u8a2d\u5b9a\u304c\u7d42\u308f\u3063\u305f\u3089 Manila \u30b5\u30fc\u30d3\u30b9\u3092\u518d\u8d77\u52d5\u3001manila service-list \u3067\u78ba\u8a8d\u3002\n\n```\n# systemctl restart openstack-manila-api.service\n# systemctl restart openstack-manila-scheduler.service\n# systemctl restart openstack-manila-share.service\n\n# manila service-list\n+----+------------------+-------------------------+------+---------+-------+----------------------------+\n| Id | Binary           | Host                    | Zone | Status  | State | Updated_at                 |\n+----+------------------+-------------------------+------+---------+-------+----------------------------+\n| 1  | manila-scheduler | akira.tk.net            | nova | enabled | up    | 2016-07-02T02:04:35.000000 |\n| 2  | manila-share     | akira.tk.net@generic    | nova | enabled | up    | 2016-07-02T02:04:30.000000 |\n| 3  | manila-share     | akira.tk.net@akira      | nova | enabled | down  | 2016-06-30T04:26:48.000000 |\n| 4  | manila-share     | akira.tk.net@locallvm   | nova | enabled | up    | 2016-07-02T02:04:31.000000 |\n| 5  | manila-share     | akira.tk.net@zfs        | nova | enabled | up    | 2016-07-02T02:04:31.000000 |\n+----+------------------+-------------------------+------+---------+-------+----------------------------+\n\n\n```\n\n\u4e0a\u8a18\u3067\u8a00\u3046\u3068\u3001\u30a8\u30f3\u30c8\u30ea\u300c5\u300d\u306e\u3068\u3053\u308d\u304c\u8ffd\u52a0\u3057\u305f\u3068\u3053\u308d\u3067\u3042\u308a\u3001Status : enabled \u3001 State : up \u3068\u306a\u3063\u3066\u3044\u308c\u3070OK\u3002\n\n\n### \u30bf\u30a4\u30d7\u8a2d\u5b9a\n\n\u30bf\u30a4\u30d7\u3068\u305d\u308c\u306b\u7d10\u3065\u304f\u30d0\u30c3\u30af\u30a8\u30f3\u30c9\u3092\u8a2d\u5b9a\u3059\u308b\u3002\n\n>\u3053\u3053\u306f\u3001Cinder \u306e\u6642\u3068\u3068\u540c\u3058\u3088\u3046\u306b\u4f5c\u308b\u3002\n\n```shell-session\n(admin) # manila type-create zfs False\n(admin) # manila type-list\n+--------------------------------------+--------------------+------------+------------+--------------------------------------+-------------------------+\n| ID                                   | Name               | visibility | is_default | required_extra_specs                 | optional_extra_specs    |\n+--------------------------------------+--------------------+------------+------------+--------------------------------------+-------------------------+\n| 617d0932-7904-4229-ad5d-cf23df2cf2e1 | akira              | public     | -          | driver_handles_share_servers : False | snapshot_support : True |\n| e0a86b9b-63ff-48a9-a689-d6f667ec5e94 | default_share_type | public     | -          | driver_handles_share_servers : True  | snapshot_support : True |\n| ec19ec3e-de2e-464c-b5f7-354b1c0c8a03 | zfs                | public     | -          | driver_handles_share_servers : False | snapshot_support : True |\n+--------------------------------------+--------------------+------------+------------+--------------------------------------+-------------------------+\n\n(admin) # manila type-key zfs set share_backend_name=zfs \n(admin) # manila extra-specs-list\n+--------------------------------------+--------------------+--------------------------------------+\n| ID                                   | Name               | all_extra_specs                      |\n+--------------------------------------+--------------------+--------------------------------------+\n| 617d0932-7904-4229-ad5d-cf23df2cf2e1 | akira              | snapshot_support : True              |\n|                                      |                    | share_backend_name : locallvm        |\n|                                      |                    | driver_handles_share_servers : False |\n| e0a86b9b-63ff-48a9-a689-d6f667ec5e94 | default_share_type | snapshot_support : True              |\n|                                      |                    | driver_handles_share_servers : True  |\n| ec19ec3e-de2e-464c-b5f7-354b1c0c8a03 | zfs                | snapshot_support : True              |\n|                                      |                    | share_backend_name : zfs             |\n|                                      |                    | driver_handles_share_servers : False |\n+--------------------------------------+--------------------+--------------------------------------+\n\n```\n\n# \u30b7\u30a7\u30a2\u306e\u4f5c\u6210\uff08\u30d5\u30a1\u30a4\u30eb\u30b5\u30fc\u30d0\uff09\n\n\u30bf\u30a4\u30d7\u3068\u3057\u3066\u3001NFS\u30b7\u30a7\u30a2\u3092\u8a66\u307f\u308b\u3002\n\n```shell-session\n(demo) # manila create NFS 5 --name zfsvol --share-type zfs\n+-----------------------------+--------------------------------------+\n| Property                    | Value                                |\n+-----------------------------+--------------------------------------+\n| status                      | creating                             |\n| share_type_name             | zfs                                  |\n| description                 | None                                 |\n| availability_zone           | None                                 |\n| share_network_id            | None                                 |\n| host                        |                                      |\n| access_rules_status         | active                               |\n| snapshot_id                 | None                                 |\n| is_public                   | False                                |\n| task_state                  | None                                 |\n| snapshot_support            | True                                 |\n| id                          | 77309678-c7b8-45d0-83c1-a6f7b4b545d8 |\n| size                        | 5                                    |\n| name                        | zfsvol                               |\n| share_type                  | ec19ec3e-de2e-464c-b5f7-354b1c0c8a03 |\n| has_replicas                | False                                |\n| replication_type            | None                                 |\n| created_at                  | 2016-09-11T05:01:18.000000           |\n| share_proto                 | NFS                                  |\n| consistency_group_id        | None                                 |\n| source_cgsnapshot_member_id | None                                 |\n| project_id                  | 7116ec60ce72461fa4a12f567a8eb4eb     |\n| metadata                    | {}                                   |\n+-----------------------------+--------------------------------------+\n(demo) # manila list\n+--------------------------------------+--------+------+-------------+----------+-----------+-----------------+------------------------+-------------------+\n| ID                                   | Name   | Size | Share Proto | Status   | Is Public | Share Type Name | Host                   | Availability Zone |\n+--------------------------------------+--------+------+-------------+----------+-----------+-----------------+------------------------+-------------------+\n| 77309678-c7b8-45d0-83c1-a6f7b4b545d8 | zfsvol | 5    | NFS         | creating | False     | zfs             | akira.tk.net@zfs#trank | nova              |\n+--------------------------------------+--------+------+-------------+----------+-----------+-----------------+------------------------+-------------------+\n(demo) # manila list\n+--------------------------------------+--------+------+-------------+-----------+-----------+-----------------+------------------------+-------------------+\n| ID                                   | Name   | Size | Share Proto | Status    | Is Public | Share Type Name | Host                   | Availability Zone |\n+--------------------------------------+--------+------+-------------+-----------+-----------+-----------------+------------------------+-------------------+\n| 77309678-c7b8-45d0-83c1-a6f7b4b545d8 | zfsvol | 5    | NFS         | available | False     | zfs             | akira.tk.net@zfs#trank | nova              |\n+--------------------------------------+--------+------+-------------+-----------+-----------+-----------------+------------------------+-------------------+\n\n```\n\nZFSonLinux \u5074\u306f\u3069\u3046\u304b\u3068\u3044\u3046\u3068\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u30d7\u30fc\u30eb\u304b\u3089\u30dc\u30ea\u30e5\u30fc\u30e0\u304c\u5207\u308a\u3060\u3055\u308c\u3066\u3044\u308b\u3002\n\n```shell-session\n(ZFSonLinux) # zfs list\nNAME                                                      USED  AVAIL  REFER  MOUNTPOINT\ntrank                                                     239K  9.63G    19K  /trank\ntrank/manila_share_bff9e10d_37e4_4d33_ab5d_b8d7baaae4d1    19K  5.00G    19K  /trank/manila_share_bff9e10d_37e4_4d33_ab5d_b8d7baaae4d1\n\n(ZFSonLinux) # df -k\n\u30d5\u30a1\u30a4\u30eb\u30b7\u30b9                                            1K-\u30d6\u30ed\u30c3\u30af    \u4f7f\u7528   \u4f7f\u7528\u53ef \u4f7f\u7528% \u30de\u30a6\u30f3\u30c8\u4f4d\u7f6e\n/dev/mapper/centos-root                                    18307072 1796672 16510400   10% /\ndevtmpfs                                                     932192       0   932192    0% /dev\ntmpfs                                                        942252       0   942252    0% /dev/shm\ntmpfs                                                        942252    8780   933472    1% /run\ntmpfs                                                        942252       0   942252    0% /sys/fs/cgroup\ntrank                                                      10094336       0 10094336    0% /trank\n/dev/sda1                                                    508588  169996   338592   34% /boot\ntmpfs                                                        188452       0   188452    0% /run/user/0\ntmpfs                                                        188452       0   188452    0% /run/user/1000\ntrank/manila_share_bff9e10d_37e4_4d33_ab5d_b8d7baaae4d1     5242880     128  5242752    1% /trank/manila_share_bff9e10d_37e4_4d33_ab5d_b8d7baaae4d1\n\n```\n\n\u3053\u308c\u3060\u3051\u3060\u3068\u3001NFS\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u306f\u7e4b\u3052\u3089\u308c\u306a\u3044\u306e\u3067\u3001\u8a31\u53ef\u8a2d\u5b9a\u3092\u3059\u308b\u3002\n\n```shell-session\n\n(demo) # manila access-allow zfsvol ip 192.168.0.154\n+--------------+--------------------------------------+\n| Property     | Value                                |\n+--------------+--------------------------------------+\n| share_id     | 77309678-c7b8-45d0-83c1-a6f7b4b545d8 |\n| access_type  | ip                                   |\n| access_to    | 192.168.0.154                        |\n| access_level | rw                                   |\n| state        | new                                  |\n| id           | c59bf658-8bc2-4b4a-ad91-c9c5bd1d47ee |\n+--------------+--------------------------------------+\n\n(demo) # manila access-list zfsvol\n+--------------------------------------+-------------+---------------+--------------+--------+\n| id                                   | access_type | access_to     | access_level | state  |\n+--------------------------------------+-------------+---------------+--------------+--------+\n| c59bf658-8bc2-4b4a-ad91-c9c5bd1d47ee | ip          | 192.168.0.154 | rw           | active |\n+--------------------------------------+-------------+---------------+--------------+--------+\n```\n\n\u3059\u308b\u3068 ZFSonLinux \u3067\u306f\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u30a8\u30af\u30b9\u30dd\u30fc\u30c8\u3055\u308c\u3066\u3044\u308b\u3002\n\n```shell-session\n(ZFSonLinux) # exportfs\n/trank/manila_share_bff9e10d_37e4_4d33_ab5d_b8d7baaae4d1\n                192.168.0.154\n```\n\n\u5b9f\u969b\u306bNFS\u30de\u30a6\u30f3\u30c8\u3057\u3066\u307f\u308b\u3002\n\n\u30de\u30a6\u30f3\u30c8\u30dd\u30a4\u30f3\u30c8\u3092\u6539\u3081\u3066\u78ba\u8a8d\u3002\n\n```shell-session\n(demo) # manila share-export-location-list zfsvol\n+--------------------------------------+----------------------------------------------------------------------+-----------+\n| ID                                   | Path                                                                 | Preferred |\n+--------------------------------------+----------------------------------------------------------------------+-----------+\n| 12ad1380-fff4-4bb0-aa4a-455550a4fa52 | 192.168.0.4:/trank/manila_share_bff9e10d_37e4_4d33_ab5d_b8d7baaae4d1 | False     |\n+--------------------------------------+----------------------------------------------------------------------+-----------+\n```\n\n\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u304b\u3089\u30de\u30a6\u30f3\u30c8\u3002\n\n```shell-session\n(Client) # mount 192.168.0.4:/trank/manila_share_bff9e10d_37e4_4d33_ab5d_b8d7baaae4d1 /mnt\n(Client) # df -h\nFilesystem                                                            Size  Used Avail Use% Mounted on\n/dev/vda1                                                              40G  6.2G   34G  16% /\ndevtmpfs                                                              1.9G     0  1.9G   0% /dev\ntmpfs                                                                 1.9G     0  1.9G   0% /dev/shm\ntmpfs                                                                 1.9G   17M  1.9G   1% /run\ntmpfs                                                                 1.9G     0  1.9G   0% /sys/fs/cgroup\ntmpfs                                                                 380M     0  380M   0% /run/user/1000\n192.168.0.4:/trank/manila_share_bff9e10d_37e4_4d33_ab5d_b8d7baaae4d1  5.0G     0  5.0G   0% /mnt\n\n(Client) # echo \"Hellow World\" >> /mnt/testfile\n\n(Client) # more /mnt/testfile\nHellow World\n```\n\n# \u30b7\u30a7\u30a2\u306e\u524a\u9664\n\n\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u304b\u3089\u30a2\u30f3\u30de\u30a6\u30f3\u30c8\u3057\u3066\u304a\u304f\u3002\n\n```shell-session\n(demo) # manila delete zfsvol\n\n(demo) # manila list\n+----+------+------+-------------+--------+-----------+-----------------+------+-------------------+\n| ID | Name | Size | Share Proto | Status | Is Public | Share Type Name | Host | Availability Zone |\n+----+------+------+-------------+--------+-----------+-----------------+------+-------------------+\n+----+------+------+-------------+--------+-----------+-----------------+------+-------------------+\n```\n\nZFSonLinux \u5074\u3082\u524a\u9664\u3055\u308c\u308b\u3002\n\n```shell-session\n(ZFSonLinux) # zfs list\nNAME    USED  AVAIL  REFER  MOUNTPOINT\ntrank   223K  9.63G    19K  /trank\n\n(ZFSonLinux) # exportfs\n(ZFSonLinux) #\n```\n\n# \u53c2\u8003\n\n* [ZFSonLinux](http://zfsonlinux.org/)\n* [OpenStack Days](http://openstackdays.com/) \u8b1b\u6f14\u8cc7\u6599\u30a2\u30ea\n* [Manila share features support mapping](http://docs.openstack.org/developer/manila/devref/share_back_ends_feature_support_mapping.html)\n* [Manila \u3092 RDO \u3067\u8a66\u3057\u3066\u307f\u308b\uff08\u6e96\u5099\u7de8\uff09](http://qiita.com/tksarah/items/dca0ee806779540a90c6)\n\n"}