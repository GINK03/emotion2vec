{"context": "\n\n1 \u306f\u3058\u3081\u306b\n\u4e0b\u8a18\u6761\u4ef6\u3067\u3001Prometheus\u3092\u8d77\u52d5\u3057\u305f\u3044\u3002\n\n\u5e38\u306b\u540c\u3058\u7248\u6570\u306eprometheus,node-exporter\u30a4\u30e1\u30fc\u30b8\u3092\u4f7f\u3044\u305f\u3044\u3002\n\u305d\u306e\u30a4\u30e1\u30fc\u30b8\u3092\u5236\u5fa1\u306e\u52b9\u304f\u7d44\u7e54\u5185\u306e\u30b5\u30fc\u30d0\u306b\u4fdd\u5b58\u3059\u308b\u3002\uff08\u4fdd\u5b58\u3057\u305f\u30a4\u30e1\u30fc\u30b8\u3092\u52dd\u624b\u306b\u524a\u9664\u3055\u308c\u308b\u3053\u3068\u304c\u306a\u3044\uff09\n\u305f\u3060\u3057\u3001\u30d7\u30e9\u30a4\u30d9\u30fc\u30c8\u306aDocker\u30ec\u30b8\u30b9\u30c8\u30ea\u306f\u4f7f\u308f\u306a\u3044\u3002\uff08\u3068\u3044\u3046\u304b\u4f7f\u3048\u306a\u3044\uff09\n\u4eee\u60f3\u30de\u30b7\u30f3\u306e\u74b0\u5883\u69cb\u7bc9\u6642\u306bPrometheus\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u305f\u3044\u3002\n\n\n2 \u691c\u8a3c\u74b0\u5883\n\n\u4eee\u60f3\u30de\u30b7\u30f3\u306f2\u53f0\n\u4eee\u60f3\u30de\u30b7\u30f3\u540d\u306f\u3001master1,master2\n\u5404\u4eee\u60f3\u30de\u30b7\u30f3\u306eOS\u306fCentOS7.2\n\n   +---- master1 ----+      +---- master2 ----+\n   |   (CentOS7.2)   |      |   (CentOS7.2)   |\n   |                 |      |                 |\n   |  prometheus     |      |                 |\n   |  node-exporter  |      |  node-exporter  |\n   |                 |      |                 |\n   +----- eth0 ------+      +----- eth0 ------+\n           |                         |\n   +------------------------------------------+\n   |              VMWare Workstation          |\n   +------------------------------------------+\n\n\n\n3 \u691c\u8a3c\u306e\u305f\u3081\u306e\u6e96\u5099\n\u691c\u8a3c\u3067\u4f7f\u3046\u30a4\u30e1\u30fc\u30b8\u3092\u3042\u3089\u304b\u3058\u3081\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3059\u308b\u3002master1\u3060\u3051\u3067\u3088\u3044\u3002\n[root@master1 prometheus]# docker pull quay.io/coreos/prometheus:0.19.2\n[root@master1 prometheus]# docker pull docker.io/prom/node-exporter\n\ndocker\u30a4\u30e1\u30fc\u30b8\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 prometheus]# docker images |grep prom\ndocker.io/prom/node-exporter       latest        7faa2f21a307        8 weeks ago         14.56 MB\nquay.io/coreos/prometheus          0.19.2        1adebd6630d9        7 months ago        43.17 MB\n\ndocker\u30a4\u30e1\u30fc\u30b8\u3092tar\u30d5\u30a1\u30a4\u30eb\u306b\u5909\u63db\u3059\u308b\u3002\n[root@master1 ansible]# docker save quay.io/coreos/prometheus:0.19.2 > prometheus.tar\n[root@master1 ansible]# ls prometheus.tar\nprometheus.tar\n\ndocker\u30a4\u30e1\u30fc\u30b8\u3092tar\u30d5\u30a1\u30a4\u30eb\u306b\u5909\u63db\u3059\u308b\u3002\n[root@master1 ansible]# docker save docker.io/prom/node-exporter > node-exporter.tar\n[root@master1 ansible]# ls node-exporter.tar\nnode-exporter.tar\n\ntar\u30d5\u30a1\u30a4\u30eb\u306b\u5909\u63db\u3057\u305f\u3042\u3068\u3001\u30a4\u30e1\u30fc\u30b8\u3092\u524a\u9664\u3059\u308b\u3002\uff08\u30c6\u30b9\u30c8\u306e\u305f\u3081\uff09\n\u3053\u306e\u6642\u70b9\u3067\u3001master1\u3067prometheus\u3068node-exporter\u30a4\u30e1\u30fc\u30b8\u306f\u5b58\u5728\u3057\u306a\u3044\u3053\u3068\u306b\u306a\u308b\u3002\n[root@master1 prometheus]# docker rmi quay.io/coreos/prometheus:0.19.2\n[root@master1 prometheus]# docker rmi docker.io/prom/node-exporter\n[root@master1 prometheus]# docker images |grep prom\n[root@master1 prometheus]#\n\n\u30d5\u30a1\u30a4\u30eb\u3092\u78ba\u8a8d\u3059\u308b\u3002\u4f5c\u6210\u3057\u305ftar\u30d5\u30a1\u30a4\u30eb\u304c\u78ba\u8a8d\u3067\u304d\u308b\u3002yaml\u30d5\u30a1\u30a4\u30eb\u306e\u4e2d\u8eab\u306f\u3001\u3042\u3068\u306b\u8a18\u8f09\u3002\n[root@master1 prometheus]# ls\nnode-exporter.tar  node-exporter.yaml  prometheus-configmap-1.yaml  prometheus-deployment.yaml  prometheus.tar\n[root@master1 prometheus]#\n\n\n\n4 playbook\u306e\u4f5c\u6210\n\u8a71\u3092\u7c21\u5358\u306b\u3059\u308b\u305f\u3081\u3001playbook\u306f\u3001\u30b5\u30fc\u30d0\u304b\u3089tar\u30d5\u30a1\u30a4\u30eb\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3059\u308b\u306e\u3067\u306f\u306a\u304f\u3001\nmaster1\u306b\u3042\u308btar\u30d5\u30a1\u30a4\u30eb\u3092\u4f7f\u3046\u3068\u3044\u3046\u5185\u5bb9\u306b\u306a\u3063\u3066\u3044\u308b\u3002\n\u30a4\u30f3\u30d9\u30f3\u30c8\u30ea\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3059\u308b\u3002\n[root@master1 ansible]# vi hosts\n[root@master1 ansible]# cat hosts\n[master]\nmaster1\nmaster2\n\nplaybook\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3059\u308b\u3002\n[root@master1 ansible]# vi test.yml\n[root@master1 ansible]# cat test.yml\n- hosts: master1\n  tasks:\n    - name: copying prometheus.tar\n      copy: src=/root/prometheus/prometheus.tar dest=/tmp/\n    - name: copying node-exporter.tar\n      copy: src=/root/prometheus/node-exporter.tar dest=/tmp/\n    - name: unarchiving prometheus.tar\n      shell: docker load -i /tmp/prometheus.tar\n    - name: unarchiving node-exporter.tar\n      shell: docker load -i /tmp/node-exporter.tar\n    - name: removing files\n      file: path=/tmp/prometheus.tar state=absent\n    - name: removing files\n      file: path=/tmp/node-exporter.tar state=absent\n- hosts: master2\n  tasks:\n    - name: copying node-exporter.tar\n      copy: src=/root/prometheus/node-exporter.tar dest=/tmp/\n    - name: unarchiving node-exporter.tar\n      shell: docker load -i /tmp/node-exporter.tar\n    - name: removing files\n      file: path=/tmp/node-exporter.tar state=absent\n- hosts: master1\n  tasks:\n    - name: copying\n      copy: src=/root/prometheus/node-exporter.yaml dest=/tmp/\n    - name: copying\n      copy: src=/root/prometheus/prometheus-configmap-1.yaml dest=/tmp/\n    - name: copying\n      copy: src=/root/prometheus/prometheus-deployment.yaml dest=/tmp/\n    - name:\n      shell: kubectl create -f /tmp/prometheus-configmap-1.yaml\n    - name:\n      shell: kubectl create -f /tmp/prometheus-deployment.yaml\n    - name:\n      shell: kubectl create -f /tmp/node-exporter.yaml\n    - name: removing files\n      file: path=/tmp/node-exporter.yaml state=absent\n    - name: removing files\n      file: path=/tmp/prometheus-configmap-1.yaml state=absent\n    - name: removing files\n      file: path=/tmp/prometheus-deployment.yaml state=absent\n[root@master1 ansible]#\n\n\u4f5c\u6210\u3057\u305f\u30d5\u30a1\u30a4\u30eb\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 ansible]# ls\nhosts  test.yml\n\n\n\n5 playbook\u306e\u5b9f\u884c\nplaybook\u3092\u5b9f\u884c\u3059\u308b\u3002\n[root@master1 ansible]# ansible-playbook -i hosts test.yml\n\nPLAY [master1] *****************************************************************\n\nTASK [setup] *******************************************************************\nok: [master1]\n\nTASK [copying prometheus.tar] **************************************************\nchanged: [master1]\n\nTASK [copying node-exporter.tar] ***********************************************\nchanged: [master1]\n\nTASK [unarchiving prometheus.tar] **********************************************\nchanged: [master1]\n\nTASK [unarchiving node-exporter.tar] *******************************************\nchanged: [master1]\n\nTASK [removing files] **********************************************************\nchanged: [master1]\n\nTASK [removing files] **********************************************************\nchanged: [master1]\n\nPLAY [master2] *****************************************************************\n\nTASK [setup] *******************************************************************\nok: [master2]\n\nTASK [copying node-exporter.tar] ***********************************************\nchanged: [master2]\n\nTASK [unarchiving node-exporter.tar] *******************************************\nchanged: [master2]\n\nTASK [removing files] **********************************************************\nchanged: [master2]\n\nPLAY [master1] *****************************************************************\n\nTASK [setup] *******************************************************************\nok: [master1]\n\nTASK [copying] *****************************************************************\nchanged: [master1]\n\nTASK [copying] *****************************************************************\nchanged: [master1]\n\nTASK [copying] *****************************************************************\nchanged: [master1]\n\nTASK [command] *****************************************************************\nchanged: [master1]\n\nTASK [command] *****************************************************************\nchanged: [master1]\n\nTASK [command] *****************************************************************\nchanged: [master1]\n\nTASK [removing files] **********************************************************\nchanged: [master1]\n\nTASK [removing files] **********************************************************\nchanged: [master1]\n\nTASK [removing files] **********************************************************\nchanged: [master1]\n\nPLAY RECAP *********************************************************************\nmaster1                    : ok=17   changed=15   unreachable=0    failed=0\nmaster2                    : ok=4    changed=3    unreachable=0    failed=0\n\n[root@master1 ansible]#\n\n\n\n6 playbook\u306e\u5b9f\u884c\u7d50\u679c\u78ba\u8a8d\nPod\u306e\u72b6\u614b\u3092\u78ba\u8a8d\u3059\u308b\u3002prometheus,node-exporter\u304c\u8d77\u52d5\u3067\u304d\u305f\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@master1 ansible]# kubectl get pod -o wide\nNAME                          READY     STATUS    RESTARTS   AGE       NODE\nnode-exporter-qfsp3           1/1       Running   0          1m        master1\nnode-exporter-xe044           1/1       Running   0          1m        master2\nprometheus-1402422302-nicfk   1/1       Running   0          1m        master1\n[root@master1 ansible]#\n\nmaster1\u3067\u30a4\u30e1\u30fc\u30b8\u3092\u78ba\u8a8d\u3059\u308b\u3002ansible-playbook\u5b9f\u884c\u306b\u3088\u308a\u3001\u30a4\u30e1\u30fc\u30b8\u304c\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@master1 ansible]# docker images |grep prom\ndocker.io/prom/node-exporter                          latest               7faa2f21a307        8 weeks ago         14.56 MB\nquay.io/coreos/prometheus                             0.19.2               1adebd6630d9        7 months ago        43.17 MB\n[root@master1 ansible]#\n\nmaster2\u3067\u30a4\u30e1\u30fc\u30b8\u3092\u78ba\u8a8d\u3059\u308b\u3002ansible-playbook\u5b9f\u884c\u306b\u3088\u308a\u3001\u30a4\u30e1\u30fc\u30b8\u304c\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@master2 ~]# docker images |grep prom\ndocker.io/prom/node-exporter                          latest               7faa2f21a307        8 weeks ago         14.56 MB\n[root@master2 ~]#\n\n\n\n7 prometheus\u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3002\nhttp://192.168.0.10:30900/\n\n\n8 \u691c\u8a3c\u3067\u4f7f\u3046yaml\u30d5\u30a1\u30a4\u30eb\n\u5168\u90e8\u30673\u3064\u3002\n--------------------------\n1. node-exporter.yaml\n--------------------------\n[root@master1 prometheus]# cat node-exporter.yaml\napiVersion: v1\nkind: Service\nmetadata:\n  annotations:\n    prometheus.io/scrape: 'true'\n  labels:\n    app: node-exporter\n    name: node-exporter\n  name: node-exporter\nspec:\n  clusterIP: None\n  ports:\n  - name: scrape\n    port: 9100\n    protocol: TCP\n  selector:\n    app: node-exporter\n  type: ClusterIP\n----\napiVersion: extensions/v1beta1\nkind: DaemonSet\nmetadata:\n  name: node-exporter\nspec:\n  template:\n    metadata:\n      labels:\n        app: node-exporter\n      name: node-exporter\n    spec:\n      containers:\n      - image: prom/node-exporter\n        name: node-exporter\n        ports:\n        - containerPort: 9100\n          hostPort: 9100\n          name: scrape\n      hostNetwork: true\n      hostPID: true\n\n--------------------------------\n2. prometheus-configmap-1.yaml\n--------------------------------\n[root@master1 prometheus]# cat prometheus-configmap-1.yaml\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: prometheus\ndata:\n  prometheus.yml: |-\n    global:\n      scrape_interval: 15s\n    scrape_configs:\n    # etcd is living outside of our cluster and we configure\n    # it directly.\n    - job_name: 'etcd'\n      target_groups:\n      - targets:\n        - 192.168.0.10:2379      # mod (172.17.4.51:2379 => 192.168.0.10:2379)\n\n    - job_name: 'node_exporter'  # new add\n      target_groups:             # new add\n      - targets:                 # new add\n        - 192.168.0.10:9100      # master1=192.168.0.10\n        - 192.168.0.20:9100      # master2=192.168.0.20\n\n    - job_name: 'kubernetes_components'\n      kubernetes_sd_configs:\n      - api_servers:\n        - 'https://kubernetes'\n        in_cluster: true\n        # This configures Prometheus to identify itself when scraping\n        # metrics from Kubernetes cluster components.\n      tls_config:\n        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt\n      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token\n      # Prometheus provides meta labels for each monitoring targets. We use\n      # these to select targets we want to monitor and to modify labels attached\n      # to scraped metrics.\n      relabel_configs:\n      # Only scrape apiserver and kubelets.\n      - source_labels: [__meta_kubernetes_role]\n        action: keep\n        regex: (?:apiserver|node)\n      # Redefine the Prometheus job based on the monitored Kubernetes component.\n      - source_labels: [__meta_kubernetes_role]\n        target_label: job\n        replacement: kubernetes_$1\n      # Attach all node labels to the metrics scraped from the components running\n      # on that node.\n      - action: labelmap\n        regex: __meta_kubernetes_node_label_(.+)\n[root@master1 prometheus]#\n\n--------------------------------\n3. prometheus-deployment.yaml\n--------------------------------\n[root@master1 prometheus]# cat prometheus-deployment.yaml\napiVersion: v1\nkind: Service\nmetadata:\n  annotations:\n    prometheus.io/scrape: 'true'\n  labels:\n    name: prometheus\n  name: prometheus\nspec:\n  selector:\n    app: prometheus\n  type: NodePort\n  ports:\n  - name: prometheus\n    protocol: TCP\n    port: 9090\n    nodePort: 30900\n----\napiVersion: extensions/v1beta1\nkind: Deployment\nmetadata:\n  name: prometheus\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: prometheus\n  template:\n    metadata:\n      name: prometheus\n      labels:\n        app: prometheus\n    spec:\n      containers:\n      - name: prometheus\n        image: quay.io/coreos/prometheus:0.19.2\n        args:\n          - '-storage.local.retention=6h'\n          - '-storage.local.memory-chunks=500000'\n          - '-config.file=/etc/prometheus/prometheus.yml'\n        ports:\n        - name: web\n          containerPort: 9090\n        volumeMounts:\n        - name: config-volume\n          mountPath: /etc/prometheus\n      nodeSelector:                      # new add\n        kubernetes.io/hostname: master1  # new add\n      volumes:\n      - name: config-volume\n        configMap:\n          name: prometheus\n[root@master1 prometheus]#\n\n\n\n9 skydns\u8d77\u52d5\u6642\u306b\u5fc5\u8981\u306a\u30a4\u30e1\u30fc\u30b8\ngcr.io/google_containers/exechealthz   1.0                  82a141f5d06d        10 months ago       7.116 MB\ngcr.io/google_containers/kube2sky      1.14                 a4892326f8cf        10 months ago       27.8 MB\ngcr.io/google_containers/etcd-amd64    2.2.1                3ae398308ded        12 months ago       28.19 MB\ngcr.io/google_containers/skydns        2015-10-13-8c72f8c   718809956625        15 months ago       40.55 MB\ngcr.io/google_containers/pause         2.0                  2b58359142b0        15 months ago       350.2 kB\n\n\n#1 \u306f\u3058\u3081\u306b\n\n\u4e0b\u8a18\u6761\u4ef6\u3067\u3001Prometheus\u3092\u8d77\u52d5\u3057\u305f\u3044\u3002\n\n- \u5e38\u306b\u540c\u3058\u7248\u6570\u306eprometheus,node-exporter\u30a4\u30e1\u30fc\u30b8\u3092\u4f7f\u3044\u305f\u3044\u3002\n- \u305d\u306e\u30a4\u30e1\u30fc\u30b8\u3092\u5236\u5fa1\u306e\u52b9\u304f\u7d44\u7e54\u5185\u306e\u30b5\u30fc\u30d0\u306b\u4fdd\u5b58\u3059\u308b\u3002\uff08\u4fdd\u5b58\u3057\u305f\u30a4\u30e1\u30fc\u30b8\u3092\u52dd\u624b\u306b\u524a\u9664\u3055\u308c\u308b\u3053\u3068\u304c\u306a\u3044\uff09\n- \u305f\u3060\u3057\u3001\u30d7\u30e9\u30a4\u30d9\u30fc\u30c8\u306aDocker\u30ec\u30b8\u30b9\u30c8\u30ea\u306f\u4f7f\u308f\u306a\u3044\u3002\uff08\u3068\u3044\u3046\u304b\u4f7f\u3048\u306a\u3044\uff09\n- \u4eee\u60f3\u30de\u30b7\u30f3\u306e\u74b0\u5883\u69cb\u7bc9\u6642\u306bPrometheus\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u305f\u3044\u3002\n\n\n#2 \u691c\u8a3c\u74b0\u5883\n\n- \u4eee\u60f3\u30de\u30b7\u30f3\u306f2\u53f0\n- \u4eee\u60f3\u30de\u30b7\u30f3\u540d\u306f\u3001master1,master2\n- \u5404\u4eee\u60f3\u30de\u30b7\u30f3\u306eOS\u306fCentOS7.2\n\n\n```\n   +---- master1 ----+      +---- master2 ----+\n   |   (CentOS7.2)   |      |   (CentOS7.2)   |\n   |                 |      |                 |\n   |  prometheus     |      |                 |\n   |  node-exporter  |      |  node-exporter  |\n   |                 |      |                 |\n   +----- eth0 ------+      +----- eth0 ------+\n           |                         |\n   +------------------------------------------+\n   |              VMWare Workstation          |\n   +------------------------------------------+\n\n```\n\n\n\n\n#3 \u691c\u8a3c\u306e\u305f\u3081\u306e\u6e96\u5099\n\n```\n\u691c\u8a3c\u3067\u4f7f\u3046\u30a4\u30e1\u30fc\u30b8\u3092\u3042\u3089\u304b\u3058\u3081\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3059\u308b\u3002master1\u3060\u3051\u3067\u3088\u3044\u3002\n[root@master1 prometheus]# docker pull quay.io/coreos/prometheus:0.19.2\n[root@master1 prometheus]# docker pull docker.io/prom/node-exporter\n\ndocker\u30a4\u30e1\u30fc\u30b8\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 prometheus]# docker images |grep prom\ndocker.io/prom/node-exporter       latest        7faa2f21a307        8 weeks ago         14.56 MB\nquay.io/coreos/prometheus          0.19.2        1adebd6630d9        7 months ago        43.17 MB\n\ndocker\u30a4\u30e1\u30fc\u30b8\u3092tar\u30d5\u30a1\u30a4\u30eb\u306b\u5909\u63db\u3059\u308b\u3002\n[root@master1 ansible]# docker save quay.io/coreos/prometheus:0.19.2 > prometheus.tar\n[root@master1 ansible]# ls prometheus.tar\nprometheus.tar\n\ndocker\u30a4\u30e1\u30fc\u30b8\u3092tar\u30d5\u30a1\u30a4\u30eb\u306b\u5909\u63db\u3059\u308b\u3002\n[root@master1 ansible]# docker save docker.io/prom/node-exporter > node-exporter.tar\n[root@master1 ansible]# ls node-exporter.tar\nnode-exporter.tar\n\ntar\u30d5\u30a1\u30a4\u30eb\u306b\u5909\u63db\u3057\u305f\u3042\u3068\u3001\u30a4\u30e1\u30fc\u30b8\u3092\u524a\u9664\u3059\u308b\u3002\uff08\u30c6\u30b9\u30c8\u306e\u305f\u3081\uff09\n\u3053\u306e\u6642\u70b9\u3067\u3001master1\u3067prometheus\u3068node-exporter\u30a4\u30e1\u30fc\u30b8\u306f\u5b58\u5728\u3057\u306a\u3044\u3053\u3068\u306b\u306a\u308b\u3002\n[root@master1 prometheus]# docker rmi quay.io/coreos/prometheus:0.19.2\n[root@master1 prometheus]# docker rmi docker.io/prom/node-exporter\n[root@master1 prometheus]# docker images |grep prom\n[root@master1 prometheus]#\n\n\u30d5\u30a1\u30a4\u30eb\u3092\u78ba\u8a8d\u3059\u308b\u3002\u4f5c\u6210\u3057\u305ftar\u30d5\u30a1\u30a4\u30eb\u304c\u78ba\u8a8d\u3067\u304d\u308b\u3002yaml\u30d5\u30a1\u30a4\u30eb\u306e\u4e2d\u8eab\u306f\u3001\u3042\u3068\u306b\u8a18\u8f09\u3002\n[root@master1 prometheus]# ls\nnode-exporter.tar  node-exporter.yaml  prometheus-configmap-1.yaml  prometheus-deployment.yaml  prometheus.tar\n[root@master1 prometheus]#\n\n```\n\n\n#4 playbook\u306e\u4f5c\u6210\n\n\u8a71\u3092\u7c21\u5358\u306b\u3059\u308b\u305f\u3081\u3001playbook\u306f\u3001\u30b5\u30fc\u30d0\u304b\u3089tar\u30d5\u30a1\u30a4\u30eb\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3059\u308b\u306e\u3067\u306f\u306a\u304f\u3001\nmaster1\u306b\u3042\u308btar\u30d5\u30a1\u30a4\u30eb\u3092\u4f7f\u3046\u3068\u3044\u3046\u5185\u5bb9\u306b\u306a\u3063\u3066\u3044\u308b\u3002\n\n```\n\u30a4\u30f3\u30d9\u30f3\u30c8\u30ea\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3059\u308b\u3002\n[root@master1 ansible]# vi hosts\n[root@master1 ansible]# cat hosts\n[master]\nmaster1\nmaster2\n\nplaybook\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3059\u308b\u3002\n[root@master1 ansible]# vi test.yml\n[root@master1 ansible]# cat test.yml\n- hosts: master1\n  tasks:\n    - name: copying prometheus.tar\n      copy: src=/root/prometheus/prometheus.tar dest=/tmp/\n    - name: copying node-exporter.tar\n      copy: src=/root/prometheus/node-exporter.tar dest=/tmp/\n    - name: unarchiving prometheus.tar\n      shell: docker load -i /tmp/prometheus.tar\n    - name: unarchiving node-exporter.tar\n      shell: docker load -i /tmp/node-exporter.tar\n    - name: removing files\n      file: path=/tmp/prometheus.tar state=absent\n    - name: removing files\n      file: path=/tmp/node-exporter.tar state=absent\n- hosts: master2\n  tasks:\n    - name: copying node-exporter.tar\n      copy: src=/root/prometheus/node-exporter.tar dest=/tmp/\n    - name: unarchiving node-exporter.tar\n      shell: docker load -i /tmp/node-exporter.tar\n    - name: removing files\n      file: path=/tmp/node-exporter.tar state=absent\n- hosts: master1\n  tasks:\n    - name: copying\n      copy: src=/root/prometheus/node-exporter.yaml dest=/tmp/\n    - name: copying\n      copy: src=/root/prometheus/prometheus-configmap-1.yaml dest=/tmp/\n    - name: copying\n      copy: src=/root/prometheus/prometheus-deployment.yaml dest=/tmp/\n    - name:\n      shell: kubectl create -f /tmp/prometheus-configmap-1.yaml\n    - name:\n      shell: kubectl create -f /tmp/prometheus-deployment.yaml\n    - name:\n      shell: kubectl create -f /tmp/node-exporter.yaml\n    - name: removing files\n      file: path=/tmp/node-exporter.yaml state=absent\n    - name: removing files\n      file: path=/tmp/prometheus-configmap-1.yaml state=absent\n    - name: removing files\n      file: path=/tmp/prometheus-deployment.yaml state=absent\n[root@master1 ansible]#\n\n\u4f5c\u6210\u3057\u305f\u30d5\u30a1\u30a4\u30eb\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 ansible]# ls\nhosts  test.yml\n\n```\n\n\n\n#5 playbook\u306e\u5b9f\u884c\n\n```\nplaybook\u3092\u5b9f\u884c\u3059\u308b\u3002\n[root@master1 ansible]# ansible-playbook -i hosts test.yml\n\nPLAY [master1] *****************************************************************\n\nTASK [setup] *******************************************************************\nok: [master1]\n\nTASK [copying prometheus.tar] **************************************************\nchanged: [master1]\n\nTASK [copying node-exporter.tar] ***********************************************\nchanged: [master1]\n\nTASK [unarchiving prometheus.tar] **********************************************\nchanged: [master1]\n\nTASK [unarchiving node-exporter.tar] *******************************************\nchanged: [master1]\n\nTASK [removing files] **********************************************************\nchanged: [master1]\n\nTASK [removing files] **********************************************************\nchanged: [master1]\n\nPLAY [master2] *****************************************************************\n\nTASK [setup] *******************************************************************\nok: [master2]\n\nTASK [copying node-exporter.tar] ***********************************************\nchanged: [master2]\n\nTASK [unarchiving node-exporter.tar] *******************************************\nchanged: [master2]\n\nTASK [removing files] **********************************************************\nchanged: [master2]\n\nPLAY [master1] *****************************************************************\n\nTASK [setup] *******************************************************************\nok: [master1]\n\nTASK [copying] *****************************************************************\nchanged: [master1]\n\nTASK [copying] *****************************************************************\nchanged: [master1]\n\nTASK [copying] *****************************************************************\nchanged: [master1]\n\nTASK [command] *****************************************************************\nchanged: [master1]\n\nTASK [command] *****************************************************************\nchanged: [master1]\n\nTASK [command] *****************************************************************\nchanged: [master1]\n\nTASK [removing files] **********************************************************\nchanged: [master1]\n\nTASK [removing files] **********************************************************\nchanged: [master1]\n\nTASK [removing files] **********************************************************\nchanged: [master1]\n\nPLAY RECAP *********************************************************************\nmaster1                    : ok=17   changed=15   unreachable=0    failed=0\nmaster2                    : ok=4    changed=3    unreachable=0    failed=0\n\n[root@master1 ansible]#\n\n```\n\n\n#6 playbook\u306e\u5b9f\u884c\u7d50\u679c\u78ba\u8a8d\n\n```\nPod\u306e\u72b6\u614b\u3092\u78ba\u8a8d\u3059\u308b\u3002prometheus,node-exporter\u304c\u8d77\u52d5\u3067\u304d\u305f\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@master1 ansible]# kubectl get pod -o wide\nNAME                          READY     STATUS    RESTARTS   AGE       NODE\nnode-exporter-qfsp3           1/1       Running   0          1m        master1\nnode-exporter-xe044           1/1       Running   0          1m        master2\nprometheus-1402422302-nicfk   1/1       Running   0          1m        master1\n[root@master1 ansible]#\n\nmaster1\u3067\u30a4\u30e1\u30fc\u30b8\u3092\u78ba\u8a8d\u3059\u308b\u3002ansible-playbook\u5b9f\u884c\u306b\u3088\u308a\u3001\u30a4\u30e1\u30fc\u30b8\u304c\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@master1 ansible]# docker images |grep prom\ndocker.io/prom/node-exporter                          latest               7faa2f21a307        8 weeks ago         14.56 MB\nquay.io/coreos/prometheus                             0.19.2               1adebd6630d9        7 months ago        43.17 MB\n[root@master1 ansible]#\n\nmaster2\u3067\u30a4\u30e1\u30fc\u30b8\u3092\u78ba\u8a8d\u3059\u308b\u3002ansible-playbook\u5b9f\u884c\u306b\u3088\u308a\u3001\u30a4\u30e1\u30fc\u30b8\u304c\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@master2 ~]# docker images |grep prom\ndocker.io/prom/node-exporter                          latest               7faa2f21a307        8 weeks ago         14.56 MB\n[root@master2 ~]#\n\n```\n\n#7 prometheus\u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3002\nhttp://192.168.0.10:30900/\n\n![prometeus.png](https://qiita-image-store.s3.amazonaws.com/0/146813/a960dd98-2fcb-253a-0db5-29ee9228aa27.png)\n\n\n\n#8 \u691c\u8a3c\u3067\u4f7f\u3046yaml\u30d5\u30a1\u30a4\u30eb\n\n\u5168\u90e8\u30673\u3064\u3002\n\n```\n--------------------------\n1. node-exporter.yaml\n--------------------------\n[root@master1 prometheus]# cat node-exporter.yaml\napiVersion: v1\nkind: Service\nmetadata:\n  annotations:\n    prometheus.io/scrape: 'true'\n  labels:\n    app: node-exporter\n    name: node-exporter\n  name: node-exporter\nspec:\n  clusterIP: None\n  ports:\n  - name: scrape\n    port: 9100\n    protocol: TCP\n  selector:\n    app: node-exporter\n  type: ClusterIP\n----\napiVersion: extensions/v1beta1\nkind: DaemonSet\nmetadata:\n  name: node-exporter\nspec:\n  template:\n    metadata:\n      labels:\n        app: node-exporter\n      name: node-exporter\n    spec:\n      containers:\n      - image: prom/node-exporter\n        name: node-exporter\n        ports:\n        - containerPort: 9100\n          hostPort: 9100\n          name: scrape\n      hostNetwork: true\n      hostPID: true\n\n--------------------------------\n2. prometheus-configmap-1.yaml\n--------------------------------\n[root@master1 prometheus]# cat prometheus-configmap-1.yaml\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: prometheus\ndata:\n  prometheus.yml: |-\n    global:\n      scrape_interval: 15s\n    scrape_configs:\n    # etcd is living outside of our cluster and we configure\n    # it directly.\n    - job_name: 'etcd'\n      target_groups:\n      - targets:\n        - 192.168.0.10:2379      # mod (172.17.4.51:2379 => 192.168.0.10:2379)\n\n    - job_name: 'node_exporter'  # new add\n      target_groups:             # new add\n      - targets:                 # new add\n        - 192.168.0.10:9100      # master1=192.168.0.10\n        - 192.168.0.20:9100      # master2=192.168.0.20\n\n    - job_name: 'kubernetes_components'\n      kubernetes_sd_configs:\n      - api_servers:\n        - 'https://kubernetes'\n        in_cluster: true\n        # This configures Prometheus to identify itself when scraping\n        # metrics from Kubernetes cluster components.\n      tls_config:\n        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt\n      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token\n      # Prometheus provides meta labels for each monitoring targets. We use\n      # these to select targets we want to monitor and to modify labels attached\n      # to scraped metrics.\n      relabel_configs:\n      # Only scrape apiserver and kubelets.\n      - source_labels: [__meta_kubernetes_role]\n        action: keep\n        regex: (?:apiserver|node)\n      # Redefine the Prometheus job based on the monitored Kubernetes component.\n      - source_labels: [__meta_kubernetes_role]\n        target_label: job\n        replacement: kubernetes_$1\n      # Attach all node labels to the metrics scraped from the components running\n      # on that node.\n      - action: labelmap\n        regex: __meta_kubernetes_node_label_(.+)\n[root@master1 prometheus]#\n\n--------------------------------\n3. prometheus-deployment.yaml\n--------------------------------\n[root@master1 prometheus]# cat prometheus-deployment.yaml\napiVersion: v1\nkind: Service\nmetadata:\n  annotations:\n    prometheus.io/scrape: 'true'\n  labels:\n    name: prometheus\n  name: prometheus\nspec:\n  selector:\n    app: prometheus\n  type: NodePort\n  ports:\n  - name: prometheus\n    protocol: TCP\n    port: 9090\n    nodePort: 30900\n----\napiVersion: extensions/v1beta1\nkind: Deployment\nmetadata:\n  name: prometheus\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: prometheus\n  template:\n    metadata:\n      name: prometheus\n      labels:\n        app: prometheus\n    spec:\n      containers:\n      - name: prometheus\n        image: quay.io/coreos/prometheus:0.19.2\n        args:\n          - '-storage.local.retention=6h'\n          - '-storage.local.memory-chunks=500000'\n          - '-config.file=/etc/prometheus/prometheus.yml'\n        ports:\n        - name: web\n          containerPort: 9090\n        volumeMounts:\n        - name: config-volume\n          mountPath: /etc/prometheus\n      nodeSelector:                      # new add\n        kubernetes.io/hostname: master1  # new add\n      volumes:\n      - name: config-volume\n        configMap:\n          name: prometheus\n[root@master1 prometheus]#\n\n```\n\n\n\n#9 skydns\u8d77\u52d5\u6642\u306b\u5fc5\u8981\u306a\u30a4\u30e1\u30fc\u30b8\n```\ngcr.io/google_containers/exechealthz   1.0                  82a141f5d06d        10 months ago       7.116 MB\ngcr.io/google_containers/kube2sky      1.14                 a4892326f8cf        10 months ago       27.8 MB\ngcr.io/google_containers/etcd-amd64    2.2.1                3ae398308ded        12 months ago       28.19 MB\ngcr.io/google_containers/skydns        2015-10-13-8c72f8c   718809956625        15 months ago       40.55 MB\ngcr.io/google_containers/pause         2.0                  2b58359142b0        15 months ago       350.2 kB\n\n```\n\n\n", "tags": ["docker", "prometheus", "centos7", "\u30d0\u30fc\u30b8\u30e7\u30f3", "Ansible"]}