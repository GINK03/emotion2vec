{"context": " More than 1 year has passed since last update.\u540c\u3058\u5f79\u5272\u306e\u8907\u6570\u53f0\u306eEC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u69cb\u6210\u3059\u308b\u969b\u3001AMI\u3092\u72ec\u81ea\u306b\u4f5c\u308b\u3053\u3068\u304c\u3042\u308b\u3068\u601d\u3046\u3002\n\u305d\u308c\u3092JSON\u5f62\u5f0f\u306e\u5b9a\u7fa9\u30d5\u30a1\u30a4\u30eb\u3092\u7528\u3044\u3066\u5b9f\u73fe\u3055\u305b\u3066\u307f\u308b\u3002\n\n\u30b7\u30ca\u30ea\u30aa\n\nAmazon Linux AMI \u304b\u3089EC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9A\u8d77\u52d5\n\u5171\u901a\u8a2d\u5b9a\u3068\u304b\u6295\u5165\u3057\u305fEC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9A\u304b\u3089\u5143\u3068\u306a\u308bAMI(BaseAMI)\u3092\u4f5c\u6210\nBaseAMI\u304b\u3089\u65b0\u305f\u306bEC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9B\u3092\u8d77\u52d5\nEC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9B\u306b\u8a2d\u5b9a\u6295\u5165\n\n\u3053\u306e\u3046\u3061\u30011\u301c3\u307e\u3067\u3092\u3084\u3063\u3066\u307f\u305f\u30024\u3068\u304b\u306fChef\u3068\u304b\u3067\u3084\u308b\u3068\u601d\u3046\u306e\u3067\u5272\u611b\u3002\n\n1. Amazon Linux AMI \u304b\u3089EC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9A\u8d77\u52d5\n\n\u96db\u5f62\u51fa\u529b\n\u6700\u8fd1\u306eAWS CLI\u306eVer(1.6\u3068\u304b1.7\u4ee5\u964d?)\u3067\u306f\u3001JSON\u5f62\u5f0f\u51fa\u529b\u7528\u306e\u30aa\u30d7\u30b7\u30e7\u30f3 --generate-cli-skeleton \u304c\u307b\u307c\u5168\u3066\u306e\u30b3\u30de\u30f3\u30c9\u306b\u3064\u3044\u3066\u308b\u306e\u3067\u305d\u308c\u3092\u5229\u7528\u3059\u308b\u3002\n$ aws ec2 run-instances --generate-cli-skeleton > run-instances_base.json\n\n\nJSON\u30d5\u30a1\u30a4\u30eb\u4fee\u6b63\n\u51fa\u529b\u3055\u308c\u305f\u96db\u5f62\u306b\u5bfe\u3057\u3066\u5fc5\u8981\u306a\u8a2d\u5b9a\u3092\u8ffd\u52a0\u3057\u3066\u3044\u304f\u3002\n\u6700\u5c0f\u9650\u306e\u8a2d\u5b9a\u3068\u3057\u3066\u3001\u4ee5\u4e0b\u3092\u8a2d\u5b9a\u3002IP\u30a2\u30c9\u30ec\u30b9\u306e\u4ed6\u3001EBS\u30923\u3064\u4ed8\u3051\u3066\u307f\u305f\u3002\nSecurityGroup\u306f\u540d\u79f0\u3060\u3068\u4e0a\u624b\u304f\u3044\u304b\u306a\u3044\u306e\u3067ID\u3067\u8a2d\u5b9a\u3002\n\nImageId : ami-4985b048 [Amazon Linux AMI 2014.09.1 (HVM)]\nKeyName : \u81ea\u5206\u306e\u3067\nInstanceType : t2.micro\nAvailabilityZone : \u597d\u304d\u306aAZ\u3067\nSecurityGroupIds : \u30a2\u30af\u30bb\u30b9\u3067\u304d\u308bSG\u3067\nSubnetId : \u597d\u304d\u306aSubnet\u3067\nPrivateIpAddress : \u597d\u304d\u306aIP\u3067\nBlockDeviceMappings : 3\u3064\u4ed8\u3051\u3066\u307f\u305f\n\n\nrun-instances_base.json\n{\n    \"ImageId\": \"ami-4985b048\",\n    \"KeyName\": \"YOUR_KEY_NAME\",\n    \"InstanceType\": \"t2.micro\",\n    \"Placement\": {\n        \"AvailabilityZone\": \"ap-northeast-1X\"\n    },\n    \"SecurityGroupIds\": [\n        \"sg-XXXXXXXX\"\n    ],\n    \"SubnetId\": \"subnet-XXXXXXXX\",\n    \"PrivateIpAddress\": \"10.X.X.X\",\n    \"BlockDeviceMappings\": [\n        {\n            \"DeviceName\": \"/dev/xvda\",\n            \"Ebs\": {\n                \"VolumeSize\": 30\n            }\n        },\n        {\n            \"DeviceName\": \"/dev/xvdba\",\n            \"Ebs\": {\n                \"VolumeSize\": 10\n            }\n        },\n        {\n            \"DeviceName\": \"/dev/xvdbb\",\n            \"Ebs\": {\n                \"VolumeSize\": 10\n            }\n        }\n    ]\n}\n\n\n\nuserdata\u4f5c\u6210\nEC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u8d77\u52d5\u6642\u306b\u30db\u30b9\u30c8\u540d\u3092\u8a2d\u5b9a\u3055\u305b\u305f\u3044\u3001\u3068\u3044\u3046\u5834\u5408\u306b\u306fuserdata\u3068\u8a00\u3046\u540d\u306e\u30b7\u30a7\u30eb\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u5b9f\u884c\u3055\u305b\u308b\u3053\u3068\u304c\u3067\u304d\u308b\u3002\n16KB\u5236\u9650\u3089\u3057\u3044\u304c\u3001\u305d\u3053\u307e\u3067\u9577\u5927\u306a\u3082\u306e\u306f\u66f8\u304b\u306a\u3044\u306e\u3067\u5927\u4e08\u592b\u304b\u3068\u3002\n\u4eca\u56de\u306f\u30db\u30b9\u30c8\u540d\u306e\u8a2d\u5b9a\u53ca\u3073hosts\u8ffd\u8a18\u3068\u30012\u3064\u306eEBS\u3092LVM\u3067\u675f\u306d\u308b\u30b9\u30af\u30ea\u30d7\u30c8\u306b\u3057\u3066\u307f\u305f\u3002\n\nuserdata_base.sh\n#!/bin/bash\nhostname test-instance-a\nsed -i -e \"s/HOSTNAME=\\(.*\\)/HOSTNAME=test-instance-a/\" /etc/sysconfig/network\necho \"10.X.X.X    test-instance-a\" >> /etc/hosts\n/sbin/pvcreate /dev/sdb[ab]\n/sbin/vgcreate /dev/vgtest /dev/sdb[ab]\n/sbin/lvcreate -l 100%FREE -n lvtest vgtest\n/sbin/mkfs.ext4 -j /dev/vgtest/lvtest\n/bin/mkdir -p /export/test\n/bin/mount -t ext4 /dev/vgtest/lvtest /export/test\necho \"/dev/vgtest/lvtest /export/test ext4 defaults 0 0\" >> /etc/fstab\n\n\n\nEC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9A\u8d77\u52d5\n\u4f5c\u6210\u3057\u305fJSON\u30d5\u30a1\u30a4\u30eb\u3068userdata\u3092\u5f15\u6570\u306b\u6307\u5b9a\u3059\u308b\u3002file:// \u3068\u3044\u3046\u30b9\u30ad\u30fc\u30de\u304c\u5fc5\u8981\u3002\n\u5b9f\u884c\u306b\u6210\u529f\u3059\u308b\u3068\u3001\u7d50\u679c\u3070\u3076\u308f\u3041\u30fc\u3063\u3068JSON\u5f62\u5f0f\u3067\u51fa\u529b\u3055\u308c\u308b\u306e\u3067\u3001\u5909\u6570\u306b\u5165\u308c\u3066\u304a\u304f\u3002\u5f8c\u3005\u4f7f\u3048\u308b\u306e\u3067\u3002\n$ RET=$(aws ec2 run-instances --cli-input-json file://run-instances_base.json --user-data file://userdata_base.sh)\n\n\nTag\u4ed8\u4e0e\nrun-instances \u5b9f\u884c\u6642\u306b\u5408\u308f\u305b\u3066\u8a2d\u5b9a\u3059\u308b\u65b9\u6cd5\u304c\u4e0d\u660e\u306a\u306e\u3067\u3001\u3061\u3087\u3063\u3068\u30e1\u30f3\u30c9\u30a4\u65b9\u6cd5\u3067\u8a2d\u5b9a\u3002\n\u307e\u305a\u3001\u4e0a\u8a18\u306e run-instances \u5b9f\u884c\u7d50\u679c\u304b\u3089\u3001InstanceId \u3092\u62bd\u51fa\u3057\u3066\u3001\u305d\u306e InstanceId \u3092\u5f15\u6570\u306b\u3057\u3066Tag\u3092\u4ed8\u4e0e\u3059\u308b\u3002\n$ INSTANCE_ID=$(echo ${RET} | python -m json.tool | grep \"InstanceId\" | awk -F: '{print $2}' | sed -e 's/\\\"//g' -e 's/,//g')\n\n$ aws ec2 create-tags --resource ${INSTANCE_ID} --tags Key=Name,Value=test-instance-a\n\n\n2. \u5171\u901a\u8a2d\u5b9a\u3068\u304b\u6295\u5165\u3057\u305fEC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9A\u304b\u3089\u5143\u3068\u306a\u308bAMI(BaseAMI)\u3092\u4f5c\u6210\n\nuserdata\u306e\u8a2d\u5b9a\u78ba\u8a8d\n\u5148\u307b\u3069\u306euserdata\u304c\u53cd\u6620\u3055\u308c\u3066\u3044\u308b\u304b\u30ed\u30b0\u30a4\u30f3\u3057\u3066\u78ba\u8a8d\u3059\u308b\u3002\n$ ssh -i ~/.ssh/XXXX.pem ec2-user@10.X.X.X\n\n\n$ sudo hostname\ntest-instance-a\n\n$ sudo df -h /export/test\nFilesystem                 Size  Used Avail Use% Mounted on\n/dev/mapper/vgtest-lvtest   20G   45M   19G   1% /export/test\n\n\n\u8a2d\u5b9a\n\u4ed6\u306b\u8a2d\u5b9a\u3057\u305f\u3044\u3082\u306e\u304c\u3042\u308c\u3070\u3002\n\u9069\u5f53\u306b yum update \u3068\u304b\u30d1\u30c3\u30b1\u30fc\u30b8\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3066\u304a\u304f\u3002\n\u7d42\u308f\u3063\u305f\u3089\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u505c\u6b62\u3055\u305b\u308b\u3002\n$ sudo yum -y install dstat git nginx expect\n$ sudo yum -y update\n$ sudo shutdown -h now\n\n\nAMI\u4f5c\u6210\n\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u304c\u505c\u6b62\u3057\u305f\u3089\u3001\u5148\u307b\u3069 run-instances \u3057\u305f\u6642\u306e InstanceId \u3092\u6307\u5b9a\u3057\u3066\u4f5c\u6210\u3002\n$ aws ec2 create-image --instance-id ${INSTANCE_ID} --name test-base-ami\n{\n    \"ImageId\": \"ami-ac564aad\"\n}\n\nAMI\u304c\u51fa\u6765\u4e0a\u304c\u308b\u307e\u3067\u3061\u3087\u3063\u3068\u6642\u9593\u304c\u639b\u304b\u308b\u3002\n\n3. BaseAMI\u304b\u3089\u65b0\u305f\u306bEC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9B\u3092\u8d77\u52d5\n\nJSON\u30d5\u30a1\u30a4\u30eb\u4fee\u6b63\n\u3055\u3063\u304d\u4f7f\u3063\u305f\u306e\u3092\u30d9\u30fc\u30b9\u306b\u4fee\u6b63\u3002\u5909\u66f4\u70b9\u306f\u4ee5\u4e0b\u3002\n\nImageId : \u3055\u3063\u304d\u306e create-image \u5b9f\u884c\u7d50\u679c\nKeyName : \u81ea\u5206\u306e\u3067\nInstanceType : t2.micro\nAvailabilityZone : \u597d\u304d\u306aAZ\u3067\nSecurityGroupIds : \u30a2\u30af\u30bb\u30b9\u3067\u304d\u308bSG\u3067\nSubnetId : \u597d\u304d\u306aSubnet\u3067\nPrivateIpAddress : \u597d\u304d\u306aIP\u3067\nBlockDeviceMappings : \u8a18\u8ff0\u3092\u524a\u9664\n\n\nrun-instances_b.json\n{\n    \"ImageId\": \"ami-XXXXXXXX\",\n    \"KeyName\": \"YOUR_KEY_NAME\",\n    \"InstanceType\": \"t2.micro\",\n    \"Placement\": {\n        \"AvailabilityZone\": \"ap-northeast-1X\"\n    },\n    \"SecurityGroupIds\": [\n        \"sg-XXXXXXXX\"\n    ],\n    \"SubnetId\": \"subnet-XXXXXXXX\",\n    \"PrivateIpAddress\": \"10.X.X.Z\"\n}\n\n\n\nuserdata\u4f5c\u6210\n\u4eca\u56de\u306f\u30db\u30b9\u30c8\u540d\u306e\u8a2d\u5b9a\u53ca\u3073hosts\u8ffd\u8a18\u306e\u307f\u3002\n\nuserdata_b.sh\n#!/bin/bash\nhostname test-instance-b\nsed -i -e \"s/HOSTNAME=\\(.*\\)/HOSTNAME=test-instance-b/\" /etc/sysconfig/network\necho \"10.X.X.Z    test-instance-b\" >> /etc/hosts\n\n\n\nEC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9B\u8d77\u52d5 & Tag\u4ed8\u4e0e\n\u3055\u3063\u304d\u3068\u540c\u3058\u3088\u3046\u306b\u5b9f\u884c\u3002\n$ RET=$(aws ec2 run-instances --cli-input-json file://run-instances_b.json --user-data file://userdata_b.sh)\n\n$ INSTANCE_ID=$(echo ${RET} | python -m json.tool | grep \"InstanceId\" | awk -F: '{print $2}' | sed -e 's/\\\"//g' -e 's/,//g')\n\n$ aws ec2 create-tags --resource ${INSTANCE_ID} --tags Key=Name,Value=test-instance-b\n\n\u3042\u3068\u306f\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u304c\u8d77\u52d5\u3059\u308b\u306e\u3092\u5f85\u3064\u306e\u307f\u3002\n\u307e\u3041\u78ba\u8a8d\u306f\u5272\u611b\u3067\u3002\n\n\u4ee5\u4e0a\n\n\u540c\u3058\u5f79\u5272\u306e\u8907\u6570\u53f0\u306eEC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u69cb\u6210\u3059\u308b\u969b\u3001AMI\u3092\u72ec\u81ea\u306b\u4f5c\u308b\u3053\u3068\u304c\u3042\u308b\u3068\u601d\u3046\u3002\n\u305d\u308c\u3092JSON\u5f62\u5f0f\u306e\u5b9a\u7fa9\u30d5\u30a1\u30a4\u30eb\u3092\u7528\u3044\u3066\u5b9f\u73fe\u3055\u305b\u3066\u307f\u308b\u3002\n\n### \u30b7\u30ca\u30ea\u30aa\n1. Amazon Linux AMI \u304b\u3089EC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9A\u8d77\u52d5\n2. \u5171\u901a\u8a2d\u5b9a\u3068\u304b\u6295\u5165\u3057\u305fEC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9A\u304b\u3089\u5143\u3068\u306a\u308bAMI(BaseAMI)\u3092\u4f5c\u6210\n3. BaseAMI\u304b\u3089\u65b0\u305f\u306bEC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9B\u3092\u8d77\u52d5\n4. EC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9B\u306b\u8a2d\u5b9a\u6295\u5165\n\n\u3053\u306e\u3046\u3061\u30011\u301c3\u307e\u3067\u3092\u3084\u3063\u3066\u307f\u305f\u30024\u3068\u304b\u306fChef\u3068\u304b\u3067\u3084\u308b\u3068\u601d\u3046\u306e\u3067\u5272\u611b\u3002\n\n\n### 1. Amazon Linux AMI \u304b\u3089EC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9A\u8d77\u52d5\n#### \u96db\u5f62\u51fa\u529b\n\u6700\u8fd1\u306eAWS CLI\u306eVer(1.6\u3068\u304b1.7\u4ee5\u964d?)\u3067\u306f\u3001JSON\u5f62\u5f0f\u51fa\u529b\u7528\u306e\u30aa\u30d7\u30b7\u30e7\u30f3 `--generate-cli-skeleton` \u304c\u307b\u307c\u5168\u3066\u306e\u30b3\u30de\u30f3\u30c9\u306b\u3064\u3044\u3066\u308b\u306e\u3067\u305d\u308c\u3092\u5229\u7528\u3059\u308b\u3002\n\n```bash\n$ aws ec2 run-instances --generate-cli-skeleton > run-instances_base.json\n```\n\n#### JSON\u30d5\u30a1\u30a4\u30eb\u4fee\u6b63\n\u51fa\u529b\u3055\u308c\u305f\u96db\u5f62\u306b\u5bfe\u3057\u3066\u5fc5\u8981\u306a\u8a2d\u5b9a\u3092\u8ffd\u52a0\u3057\u3066\u3044\u304f\u3002\n\u6700\u5c0f\u9650\u306e\u8a2d\u5b9a\u3068\u3057\u3066\u3001\u4ee5\u4e0b\u3092\u8a2d\u5b9a\u3002IP\u30a2\u30c9\u30ec\u30b9\u306e\u4ed6\u3001EBS\u30923\u3064\u4ed8\u3051\u3066\u307f\u305f\u3002\nSecurityGroup\u306f\u540d\u79f0\u3060\u3068\u4e0a\u624b\u304f\u3044\u304b\u306a\u3044\u306e\u3067ID\u3067\u8a2d\u5b9a\u3002\n\n* ImageId : ami-4985b048 [Amazon Linux AMI 2014.09.1 (HVM)]\n* KeyName : \u81ea\u5206\u306e\u3067\n* InstanceType : t2.micro\n* AvailabilityZone : \u597d\u304d\u306aAZ\u3067\n* SecurityGroupIds : \u30a2\u30af\u30bb\u30b9\u3067\u304d\u308bSG\u3067\n* SubnetId : \u597d\u304d\u306aSubnet\u3067\n* PrivateIpAddress : \u597d\u304d\u306aIP\u3067\n* BlockDeviceMappings : 3\u3064\u4ed8\u3051\u3066\u307f\u305f\n\n```json:run-instances_base.json\n{\n    \"ImageId\": \"ami-4985b048\",\n    \"KeyName\": \"YOUR_KEY_NAME\",\n    \"InstanceType\": \"t2.micro\",\n    \"Placement\": {\n        \"AvailabilityZone\": \"ap-northeast-1X\"\n    },\n    \"SecurityGroupIds\": [\n        \"sg-XXXXXXXX\"\n    ],\n    \"SubnetId\": \"subnet-XXXXXXXX\",\n    \"PrivateIpAddress\": \"10.X.X.X\",\n    \"BlockDeviceMappings\": [\n        {\n            \"DeviceName\": \"/dev/xvda\",\n            \"Ebs\": {\n                \"VolumeSize\": 30\n            }\n        },\n        {\n            \"DeviceName\": \"/dev/xvdba\",\n            \"Ebs\": {\n                \"VolumeSize\": 10\n            }\n        },\n        {\n            \"DeviceName\": \"/dev/xvdbb\",\n            \"Ebs\": {\n                \"VolumeSize\": 10\n            }\n        }\n    ]\n}\n```\n\n#### userdata\u4f5c\u6210\nEC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u8d77\u52d5\u6642\u306b\u30db\u30b9\u30c8\u540d\u3092\u8a2d\u5b9a\u3055\u305b\u305f\u3044\u3001\u3068\u3044\u3046\u5834\u5408\u306b\u306fuserdata\u3068\u8a00\u3046\u540d\u306e\u30b7\u30a7\u30eb\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u5b9f\u884c\u3055\u305b\u308b\u3053\u3068\u304c\u3067\u304d\u308b\u3002\n16KB\u5236\u9650\u3089\u3057\u3044\u304c\u3001\u305d\u3053\u307e\u3067\u9577\u5927\u306a\u3082\u306e\u306f\u66f8\u304b\u306a\u3044\u306e\u3067\u5927\u4e08\u592b\u304b\u3068\u3002\n\u4eca\u56de\u306f\u30db\u30b9\u30c8\u540d\u306e\u8a2d\u5b9a\u53ca\u3073hosts\u8ffd\u8a18\u3068\u30012\u3064\u306eEBS\u3092LVM\u3067\u675f\u306d\u308b\u30b9\u30af\u30ea\u30d7\u30c8\u306b\u3057\u3066\u307f\u305f\u3002\n\n```bash:userdata_base.sh\n#!/bin/bash\nhostname test-instance-a\nsed -i -e \"s/HOSTNAME=\\(.*\\)/HOSTNAME=test-instance-a/\" /etc/sysconfig/network\necho \"10.X.X.X    test-instance-a\" >> /etc/hosts\n/sbin/pvcreate /dev/sdb[ab]\n/sbin/vgcreate /dev/vgtest /dev/sdb[ab]\n/sbin/lvcreate -l 100%FREE -n lvtest vgtest\n/sbin/mkfs.ext4 -j /dev/vgtest/lvtest\n/bin/mkdir -p /export/test\n/bin/mount -t ext4 /dev/vgtest/lvtest /export/test\necho \"/dev/vgtest/lvtest /export/test ext4 defaults 0 0\" >> /etc/fstab\n```\n\n#### EC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9A\u8d77\u52d5\n\u4f5c\u6210\u3057\u305fJSON\u30d5\u30a1\u30a4\u30eb\u3068userdata\u3092\u5f15\u6570\u306b\u6307\u5b9a\u3059\u308b\u3002`file://` \u3068\u3044\u3046\u30b9\u30ad\u30fc\u30de\u304c\u5fc5\u8981\u3002\n\u5b9f\u884c\u306b\u6210\u529f\u3059\u308b\u3068\u3001\u7d50\u679c\u3070\u3076\u308f\u3041\u30fc\u3063\u3068JSON\u5f62\u5f0f\u3067\u51fa\u529b\u3055\u308c\u308b\u306e\u3067\u3001\u5909\u6570\u306b\u5165\u308c\u3066\u304a\u304f\u3002\u5f8c\u3005\u4f7f\u3048\u308b\u306e\u3067\u3002\n\n```bash\n$ RET=$(aws ec2 run-instances --cli-input-json file://run-instances_base.json --user-data file://userdata_base.sh)\n```\n\n#### Tag\u4ed8\u4e0e\n`run-instances` \u5b9f\u884c\u6642\u306b\u5408\u308f\u305b\u3066\u8a2d\u5b9a\u3059\u308b\u65b9\u6cd5\u304c\u4e0d\u660e\u306a\u306e\u3067\u3001\u3061\u3087\u3063\u3068\u30e1\u30f3\u30c9\u30a4\u65b9\u6cd5\u3067\u8a2d\u5b9a\u3002\n\u307e\u305a\u3001\u4e0a\u8a18\u306e `run-instances` \u5b9f\u884c\u7d50\u679c\u304b\u3089\u3001`InstanceId` \u3092\u62bd\u51fa\u3057\u3066\u3001\u305d\u306e `InstanceId` \u3092\u5f15\u6570\u306b\u3057\u3066Tag\u3092\u4ed8\u4e0e\u3059\u308b\u3002\n\n```bash\n$ INSTANCE_ID=$(echo ${RET} | python -m json.tool | grep \"InstanceId\" | awk -F: '{print $2}' | sed -e 's/\\\"//g' -e 's/,//g')\n\n$ aws ec2 create-tags --resource ${INSTANCE_ID} --tags Key=Name,Value=test-instance-a\n```\n\n\n### 2. \u5171\u901a\u8a2d\u5b9a\u3068\u304b\u6295\u5165\u3057\u305fEC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9A\u304b\u3089\u5143\u3068\u306a\u308bAMI(BaseAMI)\u3092\u4f5c\u6210\n#### userdata\u306e\u8a2d\u5b9a\u78ba\u8a8d\n\u5148\u307b\u3069\u306euserdata\u304c\u53cd\u6620\u3055\u308c\u3066\u3044\u308b\u304b\u30ed\u30b0\u30a4\u30f3\u3057\u3066\u78ba\u8a8d\u3059\u308b\u3002\n\n```bash\n$ ssh -i ~/.ssh/XXXX.pem ec2-user@10.X.X.X\n\n\n$ sudo hostname\ntest-instance-a\n\n$ sudo df -h /export/test\nFilesystem                 Size  Used Avail Use% Mounted on\n/dev/mapper/vgtest-lvtest   20G   45M   19G   1% /export/test\n```\n\n#### \u8a2d\u5b9a\n\u4ed6\u306b\u8a2d\u5b9a\u3057\u305f\u3044\u3082\u306e\u304c\u3042\u308c\u3070\u3002\n\u9069\u5f53\u306b `yum update` \u3068\u304b\u30d1\u30c3\u30b1\u30fc\u30b8\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3066\u304a\u304f\u3002\n\u7d42\u308f\u3063\u305f\u3089\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u505c\u6b62\u3055\u305b\u308b\u3002\n\n```bash\n$ sudo yum -y install dstat git nginx expect\n$ sudo yum -y update\n$ sudo shutdown -h now\n```\n\n#### AMI\u4f5c\u6210\n\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u304c\u505c\u6b62\u3057\u305f\u3089\u3001\u5148\u307b\u3069 `run-instances` \u3057\u305f\u6642\u306e `InstanceId` \u3092\u6307\u5b9a\u3057\u3066\u4f5c\u6210\u3002\n\n```bash\n$ aws ec2 create-image --instance-id ${INSTANCE_ID} --name test-base-ami\n{\n    \"ImageId\": \"ami-ac564aad\"\n}\n```\n\nAMI\u304c\u51fa\u6765\u4e0a\u304c\u308b\u307e\u3067\u3061\u3087\u3063\u3068\u6642\u9593\u304c\u639b\u304b\u308b\u3002\n\n### 3. BaseAMI\u304b\u3089\u65b0\u305f\u306bEC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9B\u3092\u8d77\u52d5\n#### JSON\u30d5\u30a1\u30a4\u30eb\u4fee\u6b63\n\u3055\u3063\u304d\u4f7f\u3063\u305f\u306e\u3092\u30d9\u30fc\u30b9\u306b\u4fee\u6b63\u3002\u5909\u66f4\u70b9\u306f\u4ee5\u4e0b\u3002\n\n* ImageId : \u3055\u3063\u304d\u306e `create-image` \u5b9f\u884c\u7d50\u679c\n* KeyName : \u81ea\u5206\u306e\u3067\n* InstanceType : t2.micro\n* AvailabilityZone : \u597d\u304d\u306aAZ\u3067\n* SecurityGroupIds : \u30a2\u30af\u30bb\u30b9\u3067\u304d\u308bSG\u3067\n* SubnetId : \u597d\u304d\u306aSubnet\u3067\n* PrivateIpAddress : \u597d\u304d\u306aIP\u3067\n* BlockDeviceMappings : \u8a18\u8ff0\u3092\u524a\u9664\n\n```json:run-instances_b.json\n{\n    \"ImageId\": \"ami-XXXXXXXX\",\n    \"KeyName\": \"YOUR_KEY_NAME\",\n    \"InstanceType\": \"t2.micro\",\n    \"Placement\": {\n        \"AvailabilityZone\": \"ap-northeast-1X\"\n    },\n    \"SecurityGroupIds\": [\n        \"sg-XXXXXXXX\"\n    ],\n    \"SubnetId\": \"subnet-XXXXXXXX\",\n    \"PrivateIpAddress\": \"10.X.X.Z\"\n}\n```\n\n#### userdata\u4f5c\u6210\n\u4eca\u56de\u306f\u30db\u30b9\u30c8\u540d\u306e\u8a2d\u5b9a\u53ca\u3073hosts\u8ffd\u8a18\u306e\u307f\u3002\n\n```bash:userdata_b.sh\n#!/bin/bash\nhostname test-instance-b\nsed -i -e \"s/HOSTNAME=\\(.*\\)/HOSTNAME=test-instance-b/\" /etc/sysconfig/network\necho \"10.X.X.Z    test-instance-b\" >> /etc/hosts\n```\n\n\n#### EC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9B\u8d77\u52d5 & Tag\u4ed8\u4e0e\n\u3055\u3063\u304d\u3068\u540c\u3058\u3088\u3046\u306b\u5b9f\u884c\u3002\n\n```bash\n$ RET=$(aws ec2 run-instances --cli-input-json file://run-instances_b.json --user-data file://userdata_b.sh)\n\n$ INSTANCE_ID=$(echo ${RET} | python -m json.tool | grep \"InstanceId\" | awk -F: '{print $2}' | sed -e 's/\\\"//g' -e 's/,//g')\n\n$ aws ec2 create-tags --resource ${INSTANCE_ID} --tags Key=Name,Value=test-instance-b\n```\n\n\u3042\u3068\u306f\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u304c\u8d77\u52d5\u3059\u308b\u306e\u3092\u5f85\u3064\u306e\u307f\u3002\n\u307e\u3041\u78ba\u8a8d\u306f\u5272\u611b\u3067\u3002\n\n---\n\u4ee5\u4e0a\n", "tags": ["cli", "EC2", "AWS"]}