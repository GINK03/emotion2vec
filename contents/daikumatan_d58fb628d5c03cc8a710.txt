{"context": " More than 1 year has passed since last update.\n\n\u5fc5\u8981\u306a\u74b0\u5883\n\u4e0b\u8a18\u74b0\u5883\u304c\u5fc5\u8981\u306b\u306a\u308a\u307e\u3059\u306e\u3067\u3042\u3089\u304b\u3058\u3081\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3066\u304f\u3060\u3055\u3044\n\naws cli\njq\n\n\n\u5f93\u6765\u306e\u554f\u984c\u70b9\nkinesis \u306e describe-stream \u30b3\u30de\u30f3\u30c9\u3060\u3068\u3001JSON\u304c\u3069\u3070\u30fc\u3063\u3066\u3067\u3066\u304d\u3066\u3001\u73fe\u5728\u6709\u52b9\u306ashardId \u304c\u3072\u3068\u76ee\u3067\u308f\u304b\u3089\u306a\u3044\u3068\u3044\u3063\u305f\u554f\u984c\u304c\u3042\u308a\u307e\u3057\u305f\n\u4e0b\u8a18\u304c\u4f8b\u3067\u3059\u3002\u3053\u306e\u4f8b\u3060\u3068\u3001shardId-000000000003 \u4ee5\u5916\u306f\u3001\u30c7\u30fc\u30bf\u30ec\u30b3\u30fc\u30c9\u3092 put \u3067\u304d\u306a\u3044 shard \u306a\u306e\u3067\u3059\u304c\u3001\u308f\u304b\u3089\u306a\u3044\u3067\u3059\u3088\u306d\uff01(close \u306a shard \u306f\u3001shard \u306e\u5206\u5272\u3001\u30de\u30fc\u30b8\u306b\u3088\u3063\u3066\u767a\u751f\u3057\u307e\u3059\uff09\n\ncommand\naws kinesis describe-stream --stream-name <\u30b9\u30c8\u30ea\u30fc\u30e0\u540d>\n\n\n\n\u7d50\u679c\u4f8b\n{\n    \"StreamDescription\": {\n        \"StreamStatus\": \"ACTIVE\", \n        \"StreamName\": \"<\u30b9\u30c8\u30ea\u30fc\u30e0\u540d>\", \n        \"StreamARN\": \"arn:aws:kinesis:ap-northeast-1:XXXXXXXXXXXX:stream/handson\", \n        \"Shards\": [\n            {\n                \"ShardId\": \"shardId-000000000000\", \n                \"HashKeyRange\": {\n                    \"EndingHashKey\": \"340282366920938463463374607431768211455\", \n                    \"StartingHashKey\": \"0\"\n                }, \n                \"SequenceNumberRange\": {\n                    \"EndingSequenceNumber\": \"49550864092662459711139433817050545721599481607404650498\", \n                    \"StartingSequenceNumber\": \"49550864092651309338540168505480986788282674130572017666\"\n                }\n            }, \n            {\n                \"ShardId\": \"shardId-000000000001\", \n                \"HashKeyRange\": {\n                    \"EndingHashKey\": \"170141183460469231731687303715884105727\", \n                    \"StartingHashKey\": \"0\"\n                }, \n                \"ParentShardId\": \"shardId-000000000000\", \n                \"SequenceNumberRange\": {\n                    \"EndingSequenceNumber\": \"49550864601498562906012662037471029548617289644346703890\", \n                    \"StartingSequenceNumber\": \"49550864601487412533413396725901470615300436606500995090\"\n                }\n            }, \n            {\n                \"ShardId\": \"shardId-000000000002\", \n                \"HashKeyRange\": {\n                    \"EndingHashKey\": \"340282366920938463463374607431768211455\", \n                    \"StartingHashKey\": \"170141183460469231731687303715884105728\"\n                }, \n                \"ParentShardId\": \"shardId-000000000000\", \n                \"SequenceNumberRange\": {\n                    \"EndingSequenceNumber\": \"49550864601520863651211192660612565266889938005852684322\", \n                    \"StartingSequenceNumber\": \"49550864601509713278611927349043006333573084968006975522\"\n                }\n            }, \n            {\n                \"ShardId\": \"shardId-000000000003\", \n                \"HashKeyRange\": {\n                    \"EndingHashKey\": \"340282366920938463463374607431768211455\", \n                    \"StartingHashKey\": \"0\"\n                }, \n                \"ParentShardId\": \"shardId-000000000001\", \n                \"AdjacentParentShardId\": \"shardId-000000000002\", \n                \"SequenceNumberRange\": {\n                    \"StartingSequenceNumber\": \"49550865346912121539498005854874389596844711860389281842\"\n                }\n            }\n        ]\n    }\n}\n\n\n\n\u89e3\u6c7a\u7b56\n\u305d\u3053\u3067\u30ef\u30f3\u30e9\u30a4\u30ca\u30fc\u4f5c\u308a\u307e\u3057\u305f\u3002\n\u51fa\u529b\u3055\u308c\u308bjson\u3092\u52a0\u5de5\u3057\u3066\u3001\u3042\u3068\u306f awk \u3067\u3053\u306d\u304f\u308a\u56de\u3057\u3066\u3044\u307e\u3059\u3002\n\ncommand\nSTREAM_NAME=<\u30b9\u30c8\u30ea\u30fc\u30e0\u540d>\n\n\n\ncommand\naws kinesis describe-stream --stream-name ${STREAM_NAME} | jq -r '.StreamDescription | .Shards[] | \"\\(.ShardId) \\(.ParentShardId) \\( .AdjacentParentShardId) \\(.HashKeyRange | .StartingHashKey)\"' | sed s/shardId-//g |awk 'BEGIN{i=0;print}{hashKey[i]=$4;state[i]=\"Open\";if($2 != \"null\"){state[$2/1]=\"Close\"};if($3 != \"null\"){state[$3/1]=\"Close\"};i++}END{for(j=0;j<i;j++) printf(\"shardId-%012d %5s start: %s\\n\",j,state[j],hashKey[j]);}'\n\n\n\u51fa\u529b\u7d50\u679c\u306f\u4e0b\u8a18\u306e\u3088\u3046\u306a\u611f\u3058\u3002\n\u5de6\u304b\u3089shardId, \u73fe\u5728\u6709\u52b9/\u7121\u52b9\u306ashard\u306fOpen/close\u3001\"Start: \u6570\u5024\"\u306f shard\u306e \"StartingHashKey\u3092\u8868\u3057\u3066\u3044\u307e\u3059\n\nresult\nshardId-000000000000 Close Start: 0\nshardId-000000000001 Close Start: 0\nshardId-000000000002 Close Start: 170141183460469231731687303715884105728\nshardId-000000000003  Open Start: 0\n\n\n\u305c\u3072\u4f7f\u3063\u3066\u304f\u3060\u3055\u3044\u306d\uff01\n\n\u30b7\u30a7\u30eb\u30b9\u30af\u30ea\u30d7\u30c8\n\u4e0a\u8a18\u3060\u3068\u5206\u304b\u308a\u306b\u304f\u3044\u306e\u3067\u3001\u4e00\u5fdc\u30b9\u30af\u30ea\u30d7\u30c8\u5316\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\"ParentShardId\" \u3082\u3057\u304f\u306f \"AdjacentParentShardId\" \u306b\u66f8\u304b\u308c\u3066\u3044\u308bShardId\u306f\u3059\u3067\u306b close \u3055\u308c\u3066\u3044\u307e\u3059\u3002\u3053\u306e\u6027\u8cea\u3092\u5229\u7528\u3057\u3066\u3001Open\u3001\u304b Close\u3092\u5224\u5b9a\u3057\u3066\u3044\u307e\u3059\u3002shardId\u306e\"Id\"\u306e\u307f\u3092\u629c\u304d\u51fa\u3057\u3066\u3001state \u914d\u5217\u306e Index \u306b\u5165\u308c\u308b\u3053\u3068\u304c\u30dd\u30a4\u30f3\u30c8\u3067\u3059\n\u30a2\u30eb\u30b4\u30ea\u30ba\u30e0\u306e\u8a73\u7d30\u306f\u4e0b\u8a18 3STEP \u3067\u3059\u3002\n\nShard\u306e\u30b9\u30c6\u30fc\u30bf\u30b9\u3092\u4fdd\u6301\u3059\u308bstate[i]\u306b\u5bfe\u3057\u3001\u307e\u305a\u3001Open \u3067 \u521d\u671f\u5316\u3059\u308b\n\"ParentShardId\" \u3082\u3057\u304f\u306f \"AdjacentParentShardId\" \u304c \u3042\u308c\u3070\u3001\u305d\u306eShardId\u306e\"\u6570\u5b57\u306e\u307f\"\u3092\u53d6\u5f97\u3059\u308b(\u4f8b\uff1ashardId-000000000001\u306a\u3089\u3001\"1\")\n\u53d6\u5f97\u3057\u305f\u6570\u5b57\u3092 Shard\u306e\u30b9\u30c6\u30fc\u30bf\u30b9\u3092\u4fdd\u6301\u3059\u308bstate\u914d\u5217\u306eIndex\u306b\u5165\u308c\u3001\u5024\u3092 Open \u304b\u3089 Close \u306b\u4e0a\u66f8\u304d\u3059\u308b(state[$2/1]\u306e\u3088\u3046\u306b1\u3067\u5272\u3063\u3066\u3044\u308b\u306e\u306f\u5f37\u5f15\u306bInt\u578b\u306b\u30ad\u30e3\u30b9\u30c8\u3059\u308b\u305f\u3081)\n\n\nscript\n#!/bin/bash\n\nSTREAM_NAME=$1\n\n#\n# open/close \u5224\u5b9a\n#\nshardChecker()\n{\n\nawk '\nBEGIN{\n    i=0;\n    printf(\"\\n\");\n}\n{\n    hashKey[i]=$4;\n    state[i]=\"Open\";\n    if($2 != \"null\"){state[$2/1]=\"Close\"};\n    if($3 != \"null\"){state[$3/1]=\"Close\"};\n    i++;\n}\nEND{\n    for(j=0;j<i;j++) {\n        printf(\"shardId-%012d %5s start: %s\\n\",j,state[j],hashKey[j]);\n    }\n}'\n\n}\n\n#\n# main\n#\naws kinesis describe-stream --stream-name ${STREAM_NAME} \\\n| jq -r '.StreamDescription | .Shards[] | \"\\(.ShardId) \\(.ParentShardId) \\( .AdjacentParentShardId) \\(.HashKeyRange | .StartingHashKey)\"'\\\n| sed s/shardId-//g \\\n| shardChecker\n\n\n\n\u5fc5\u8981\u306a\u74b0\u5883\n==============\n\n\u4e0b\u8a18\u74b0\u5883\u304c\u5fc5\u8981\u306b\u306a\u308a\u307e\u3059\u306e\u3067\u3042\u3089\u304b\u3058\u3081\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3066\u304f\u3060\u3055\u3044\n\n- aws cli\n- jq\n\n\n\n\u5f93\u6765\u306e\u554f\u984c\u70b9\n==============\n\nkinesis \u306e describe-stream \u30b3\u30de\u30f3\u30c9\u3060\u3068\u3001JSON\u304c\u3069\u3070\u30fc\u3063\u3066\u3067\u3066\u304d\u3066\u3001\u73fe\u5728\u6709\u52b9\u306ashardId \u304c\u3072\u3068\u76ee\u3067\u308f\u304b\u3089\u306a\u3044\u3068\u3044\u3063\u305f\u554f\u984c\u304c\u3042\u308a\u307e\u3057\u305f\n\n\u4e0b\u8a18\u304c\u4f8b\u3067\u3059\u3002\u3053\u306e\u4f8b\u3060\u3068\u3001shardId-000000000003 \u4ee5\u5916\u306f\u3001\u30c7\u30fc\u30bf\u30ec\u30b3\u30fc\u30c9\u3092 put \u3067\u304d\u306a\u3044 shard \u306a\u306e\u3067\u3059\u304c\u3001\u308f\u304b\u3089\u306a\u3044\u3067\u3059\u3088\u306d\uff01(close \u306a shard \u306f\u3001shard \u306e\u5206\u5272\u3001\u30de\u30fc\u30b8\u306b\u3088\u3063\u3066\u767a\u751f\u3057\u307e\u3059\uff09\n\n```bash:command\naws kinesis describe-stream --stream-name <\u30b9\u30c8\u30ea\u30fc\u30e0\u540d>\n```\n\n\n```JSON:\u7d50\u679c\u4f8b\n{\n    \"StreamDescription\": {\n        \"StreamStatus\": \"ACTIVE\", \n        \"StreamName\": \"<\u30b9\u30c8\u30ea\u30fc\u30e0\u540d>\", \n        \"StreamARN\": \"arn:aws:kinesis:ap-northeast-1:XXXXXXXXXXXX:stream/handson\", \n        \"Shards\": [\n            {\n                \"ShardId\": \"shardId-000000000000\", \n                \"HashKeyRange\": {\n                    \"EndingHashKey\": \"340282366920938463463374607431768211455\", \n                    \"StartingHashKey\": \"0\"\n                }, \n                \"SequenceNumberRange\": {\n                    \"EndingSequenceNumber\": \"49550864092662459711139433817050545721599481607404650498\", \n                    \"StartingSequenceNumber\": \"49550864092651309338540168505480986788282674130572017666\"\n                }\n            }, \n            {\n                \"ShardId\": \"shardId-000000000001\", \n                \"HashKeyRange\": {\n                    \"EndingHashKey\": \"170141183460469231731687303715884105727\", \n                    \"StartingHashKey\": \"0\"\n                }, \n                \"ParentShardId\": \"shardId-000000000000\", \n                \"SequenceNumberRange\": {\n                    \"EndingSequenceNumber\": \"49550864601498562906012662037471029548617289644346703890\", \n                    \"StartingSequenceNumber\": \"49550864601487412533413396725901470615300436606500995090\"\n                }\n            }, \n            {\n                \"ShardId\": \"shardId-000000000002\", \n                \"HashKeyRange\": {\n                    \"EndingHashKey\": \"340282366920938463463374607431768211455\", \n                    \"StartingHashKey\": \"170141183460469231731687303715884105728\"\n                }, \n                \"ParentShardId\": \"shardId-000000000000\", \n                \"SequenceNumberRange\": {\n                    \"EndingSequenceNumber\": \"49550864601520863651211192660612565266889938005852684322\", \n                    \"StartingSequenceNumber\": \"49550864601509713278611927349043006333573084968006975522\"\n                }\n            }, \n            {\n                \"ShardId\": \"shardId-000000000003\", \n                \"HashKeyRange\": {\n                    \"EndingHashKey\": \"340282366920938463463374607431768211455\", \n                    \"StartingHashKey\": \"0\"\n                }, \n                \"ParentShardId\": \"shardId-000000000001\", \n                \"AdjacentParentShardId\": \"shardId-000000000002\", \n                \"SequenceNumberRange\": {\n                    \"StartingSequenceNumber\": \"49550865346912121539498005854874389596844711860389281842\"\n                }\n            }\n        ]\n    }\n}\n```\n\n\n\u89e3\u6c7a\u7b56\n==============\n\n\u305d\u3053\u3067\u30ef\u30f3\u30e9\u30a4\u30ca\u30fc\u4f5c\u308a\u307e\u3057\u305f\u3002\n\u51fa\u529b\u3055\u308c\u308bjson\u3092\u52a0\u5de5\u3057\u3066\u3001\u3042\u3068\u306f awk \u3067\u3053\u306d\u304f\u308a\u56de\u3057\u3066\u3044\u307e\u3059\u3002\n\n```bash:command\nSTREAM_NAME=<\u30b9\u30c8\u30ea\u30fc\u30e0\u540d>\n```\n\n```bash:command\naws kinesis describe-stream --stream-name ${STREAM_NAME} | jq -r '.StreamDescription | .Shards[] | \"\\(.ShardId) \\(.ParentShardId) \\( .AdjacentParentShardId) \\(.HashKeyRange | .StartingHashKey)\"' | sed s/shardId-//g |awk 'BEGIN{i=0;print}{hashKey[i]=$4;state[i]=\"Open\";if($2 != \"null\"){state[$2/1]=\"Close\"};if($3 != \"null\"){state[$3/1]=\"Close\"};i++}END{for(j=0;j<i;j++) printf(\"shardId-%012d %5s start: %s\\n\",j,state[j],hashKey[j]);}'\n```\n\n\u51fa\u529b\u7d50\u679c\u306f\u4e0b\u8a18\u306e\u3088\u3046\u306a\u611f\u3058\u3002\n\u5de6\u304b\u3089shardId, \u73fe\u5728\u6709\u52b9/\u7121\u52b9\u306ashard\u306fOpen/close\u3001\"Start: \u6570\u5024\"\u306f shard\u306e \"StartingHashKey\u3092\u8868\u3057\u3066\u3044\u307e\u3059\n \n```bash:result\nshardId-000000000000 Close Start: 0\nshardId-000000000001 Close Start: 0\nshardId-000000000002 Close Start: 170141183460469231731687303715884105728\nshardId-000000000003  Open Start: 0\n```\n\n\u305c\u3072\u4f7f\u3063\u3066\u304f\u3060\u3055\u3044\u306d\uff01\n\n\u30b7\u30a7\u30eb\u30b9\u30af\u30ea\u30d7\u30c8\n======\n\n\n\u4e0a\u8a18\u3060\u3068\u5206\u304b\u308a\u306b\u304f\u3044\u306e\u3067\u3001\u4e00\u5fdc\u30b9\u30af\u30ea\u30d7\u30c8\u5316\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\n\"ParentShardId\" \u3082\u3057\u304f\u306f \"AdjacentParentShardId\" \u306b\u66f8\u304b\u308c\u3066\u3044\u308bShardId\u306f\u3059\u3067\u306b close \u3055\u308c\u3066\u3044\u307e\u3059\u3002\u3053\u306e\u6027\u8cea\u3092\u5229\u7528\u3057\u3066\u3001Open\u3001\u304b Close\u3092\u5224\u5b9a\u3057\u3066\u3044\u307e\u3059\u3002shardId\u306e\"Id\"\u306e\u307f\u3092\u629c\u304d\u51fa\u3057\u3066\u3001state \u914d\u5217\u306e Index \u306b\u5165\u308c\u308b\u3053\u3068\u304c\u30dd\u30a4\u30f3\u30c8\u3067\u3059\n\n\u30a2\u30eb\u30b4\u30ea\u30ba\u30e0\u306e\u8a73\u7d30\u306f\u4e0b\u8a18 3STEP \u3067\u3059\u3002\n\n1. Shard\u306e\u30b9\u30c6\u30fc\u30bf\u30b9\u3092\u4fdd\u6301\u3059\u308b`state[i]`\u306b\u5bfe\u3057\u3001\u307e\u305a\u3001Open \u3067 \u521d\u671f\u5316\u3059\u308b\n2. \"ParentShardId\" \u3082\u3057\u304f\u306f \"AdjacentParentShardId\" \u304c \u3042\u308c\u3070\u3001\u305d\u306eShardId\u306e\"\u6570\u5b57\u306e\u307f\"\u3092\u53d6\u5f97\u3059\u308b(\u4f8b\uff1ashardId-000000000001\u306a\u3089\u3001\"1\")\n3. \u53d6\u5f97\u3057\u305f\u6570\u5b57\u3092 Shard\u306e\u30b9\u30c6\u30fc\u30bf\u30b9\u3092\u4fdd\u6301\u3059\u308bstate\u914d\u5217\u306eIndex\u306b\u5165\u308c\u3001\u5024\u3092 Open \u304b\u3089 Close \u306b\u4e0a\u66f8\u304d\u3059\u308b(state[$2/1]\u306e\u3088\u3046\u306b1\u3067\u5272\u3063\u3066\u3044\u308b\u306e\u306f\u5f37\u5f15\u306bInt\u578b\u306b\u30ad\u30e3\u30b9\u30c8\u3059\u308b\u305f\u3081)\n\n\n```bash:script\n#!/bin/bash\n\nSTREAM_NAME=$1\n\n#\n# open/close \u5224\u5b9a\n#\nshardChecker()\n{\n\nawk '\nBEGIN{\n    i=0;\n\tprintf(\"\\n\");\n}\n{\n    hashKey[i]=$4;\n    state[i]=\"Open\";\n    if($2 != \"null\"){state[$2/1]=\"Close\"};\n    if($3 != \"null\"){state[$3/1]=\"Close\"};\n    i++;\n}\nEND{\n    for(j=0;j<i;j++) {\n        printf(\"shardId-%012d %5s start: %s\\n\",j,state[j],hashKey[j]);\n    }\n}'\n\n}\n\n#\n# main\n#\naws kinesis describe-stream --stream-name ${STREAM_NAME} \\\n| jq -r '.StreamDescription | .Shards[] | \"\\(.ShardId) \\(.ParentShardId) \\( .AdjacentParentShardId) \\(.HashKeyRange | .StartingHashKey)\"'\\\n| sed s/shardId-//g \\\n| shardChecker\n```\n\n", "tags": ["aws-cli", "Kinesis", "AWS", "IoT"]}