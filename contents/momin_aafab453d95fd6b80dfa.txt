{"context": " More than 1 year has passed since last update.S3\u306b\u65b0\u3057\u3044\u6a5f\u80fd\u304c\u8ffd\u52a0\u3055\u308c\u307e\u3057\u305f\u306d\uff08\u3053\u3061\u3089\u3010AWS\u767a\u8868\u3011S3\u306e\u65b0\u3057\u3044\u30a4\u30d9\u30f3\u30c8\u901a\u77e5\u6a5f\u80fd\uff09\u3002\n\u65e9\u901f\u30af\u30e9\u30b9\u30e1\u30bd\u30c3\u30c9\u3055\u3093\u306a\u3069\u4f7f\u3044\u65b9\u3092\u516c\u958b\u3055\u308c\u3066\u4e0b\u3055\u308a\u3001\u3042\u308a\u304c\u305f\u3044\u9650\u308a\u3067\u3059\u3002\uff08[AWS\u65b0\u6a5f\u80fd] Amazon S3 Event Notifications\u3092\u4f7f\u3063\u3066\u307f\u305f #reinvent\uff09\n\u79c1\u3082\u65e9\u901f\u5229\u7528\u3057\u3066\u307f\u3088\u3046\u3068\u601d\u3044\u307e\u3059\u3002\u307e\u305aSNSTopic\u306e\u8a2d\u5b9a\u3084S3\u306e\u8a2d\u5b9a\u306a\u3069\u306f\u4e0a\u8a18\u30af\u30e9\u30b9\u30e1\u30bd\u30c3\u30c9\u3055\u3093\u3092\u53c2\u8003\u306b\u3057\u3066\u3044\u305f\u3060\u3051\u305f\u3089\u2026\uff08\u624b\u629c\u304d\u2026\n\u3042\u3001SNS\u3067\u30b5\u30d6\u30b9\u30af\u30ea\u30d7\u30b7\u30e7\u30f3\u3092\u4f5c\u6210\u3059\u308b\u3068\u304d\u306f\n\nProtocol: http\nEndpoint: http://Sinatra\u304c\u52d5\u3044\u3066\u3044\u308b\u30b5\u30fc\u30d0:4567/s3notification\n\n\n\u3068\u3057\u3066\u304f\u3060\u3055\u3044\u3002\nSNS\u306eHTTP\u901a\u77e5\u3092Sinatra\u3067\u4f5c\u6210\u3057\u305f\u30a2\u30d7\u30ea\u3067\u53d7\u3051\u3066\u3001\u30a4\u30d9\u30f3\u30c8\u306e\u5185\u5bb9\u3092\u30ed\u30b0\u306b\u6b8b\u305d\u3046\u3063\u3066\u304b\u3093\u3058\u3067\u3059\u3002\n\u305f\u3060\u3001Ruby\u306elogger\u3092\u5229\u7528\u3057\u3066\u3044\u308b\u3060\u3051\u306a\u306e\u3067\u51dd\u3063\u305f\u30ed\u30b0\u306b\u3057\u3066\u308b\u308f\u3051\u3058\u3083\u306a\u3044\u3067\u3059\u3002\n\u5185\u5bb9\u306f\u7c21\u5358\u3067\n1. Sinatra\u3067SNS\u306e\u30b5\u30d6\u30b9\u30af\u30ea\u30d7\u30b7\u30e7\u30f3\u3092\u53d7\u3051\u308b\u3001\u627f\u8a8d\u3059\u308b\u3002\n2. S3\u306b\u30d5\u30a1\u30a4\u30eb\u304c\u8ffd\u52a0\u3055\u308c\u305f\u901a\u77e5\u3092\u53d7\u3051\u53d6\u308b\u3002\n3. \u5185\u5bb9\u3092\u30ed\u30b0\u306b\u66f8\u304d\u51fa\u3059\u3002 \n\u3060\u3051\n# SNS \u306e\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u30ed\u30fc\u30c9\nSNS = Aws::SNS::Client.new(region: 'ap-northeast-1')\n\n# SNS\u901a\u77e5\u306e\u53d7\u3051\u53e3\npost '/s3notification' do\n  notif = JSON.parse(request.body.read)\n\n  case notif['Type']\n  # \u30b5\u30d6\u30b9\u30af\u30ea\u30d7\u30b7\u30e7\u30f3\u8a8d\u8a3c\u306e\u30ea\u30af\u30a8\u30b9\u30c8\u3092\u53d7\u3051\u53d6\u3063\u305f\u306e\u3067\u627f\u8a8d\u3059\u308b\u3002\n  when \"SubscriptionConfirmation\" then\n    SNS.confirm_subscription(:topic_arn => notif['TopicArn'],\n                             :token => notif['Token'],\n                             :authenticate_on_unsubscribe => 'true'\n    )\n  # \u901a\u77e5\u3092\u53d7\u3051\u53d6\u3063\u305f\u306e\u3067\u30ea\u30af\u30a8\u30b9\u30c8\u306emessage\u3092\u30ed\u30b0\u3068\u3057\u3066\u51fa\u529b\n  when \"Notification\" then\n   LOGGER.info(notif['Message'])  \n  else\n    LOGGER.info(notif)  \n  end\nend\n\n\n\u5b9f\u969b\u306e\u30b3\u30fc\u30c9\u306f\u3053\u3061\u3089 https://github.com/mominosin/s3-notification-receiver\n\u5b9f\u969b\u306bS3 Notification\u3092\u8a2d\u5b9a\u3057\u305fS3\u306b test01.txt \u3092\u914d\u7f6e\u3057\u305f\u6642\u306b\u98db\u3093\u3067\u304d\u305f\u30ed\u30b0\nI, [2014-11-14T17:48:44.411781 #24933]  INFO -- : {\"Records\":[{\"eventVersion\":\"2.0\",\"eventSource\":\"aws:s3\",\"awsRegion\":\"ap-northeast-1\",\"eventTime\":\"2014-11-14T17:46:17.469Z\",\"eventName\":\"ObjectCreated:Put\",\"userIdentity\":{\"principalId\":\"A3336BHUMP8V3P\"},\"requestParameters\":{\"sourceIPAddress\":\"10.114.229.8\"},\"responseElements\":{\"x-amz-request-id\":\"08E05D2DDE657BF4\",\"x-amz-id-2\":\"ngr1FgdrUyg4MiAPwwYdOKxGMxgNVfPGJ9R9rBuhr6aJ0w31v+i/CYw4J2RlhpWh\"},\"s3\":{\"s3SchemaVersion\":\"1.0\",\"configurationId\":\"s3-notification\",\"bucket\":{\"name\":\"s3-notif-test\",\"ownerIdentity\":{\"principalId\":\"A3336BHUMP8V3P\"},\"arn\":\"arn:aws:s3:::s3-notif-test\"},\"object\":{\"key\":\"test01.txt\",\"size\":4815,\"eTag\":\"3a777152a1477fe290405dc5b9b0f59c\"}}}]}\n\n\u307f\u305a\u3089\u3044\u3063\u3059\u306djq\u306b\u304b\u3051\u3066\u307f\u307e\u3057\u305f\u3002\n{\n  \"Records\": [\n    {\n      \"s3\": {\n        \"object\": {\n          \"eTag\": \"3a777152a1477fe290405dc5b9b0f59c\",\n          \"size\": 4815,\n          \"key\": \"test01.txt\"\n        },\n        \"bucket\": {\n          \"arn\": \"arn:aws:s3:::s3-notif-test\",\n          \"ownerIdentity\": {\n            \"principalId\": \"A3336BHUMP8V3P\"\n          },\n          \"name\": \"s3-notif-test\"\n        },\n        \"configurationId\": \"s3-notification\",\n        \"s3SchemaVersion\": \"1.0\"\n      },\n      \"eventVersion\": \"2.0\",\n      \"eventSource\": \"aws:s3\",\n      \"awsRegion\": \"ap-northeast-1\",\n      \"eventTime\": \"2014-11-14T17:46:17.469Z\",\n      \"eventName\": \"ObjectCreated:Put\",\n      \"userIdentity\": {\n        \"principalId\": \"A3336BHUMP8V3P\"\n      },\n      \"requestParameters\": {\n        \"sourceIPAddress\": \"10.114.229.8\"\n      },\n      \"responseElements\": {\n        \"x-amz-id-2\": \"ngr1FgdrUyg4MiAPwwYdOKxGMxgNVfPGJ9R9rBuhr6aJ0w31v+i/CYw4J2RlhpWh\",\n        \"x-amz-request-id\": \"08E05D2DDE657BF4\"\n      }\n    }\n  ]\n}\n\neventName\u3068\u304b\u898b\u308c\u3070S3\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u306e\u8ffd\u52a0\u306e\u3055\u308c\u65b9\u304cput\u306a\u306e\u304b\u3001copy\u306a\u306e\u304b\u306a\u3069\u306e\u5224\u5225\u3082\u3067\u304d\u308b\u306e\u304b\u306a\u3068\u601d\u3044\u307e\u3059\u3002\n\nS3\u306b\u65b0\u3057\u3044\u6a5f\u80fd\u304c\u8ffd\u52a0\u3055\u308c\u307e\u3057\u305f\u306d\uff08\u3053\u3061\u3089[\u3010AWS\u767a\u8868\u3011S3\u306e\u65b0\u3057\u3044\u30a4\u30d9\u30f3\u30c8\u901a\u77e5\u6a5f\u80fd](http://aws.typepad.com/aws_japan/2014/11/s3-event-notification.html)\uff09\u3002\n\n\u65e9\u901f\u30af\u30e9\u30b9\u30e1\u30bd\u30c3\u30c9\u3055\u3093\u306a\u3069\u4f7f\u3044\u65b9\u3092\u516c\u958b\u3055\u308c\u3066\u4e0b\u3055\u308a\u3001\u3042\u308a\u304c\u305f\u3044\u9650\u308a\u3067\u3059\u3002\uff08[[AWS\u65b0\u6a5f\u80fd] Amazon S3 Event Notifications\u3092\u4f7f\u3063\u3066\u307f\u305f #reinvent](http://dev.classmethod.jp/cloud/amazon-s3-event-notifications/)\uff09\n\n\u79c1\u3082\u65e9\u901f\u5229\u7528\u3057\u3066\u307f\u3088\u3046\u3068\u601d\u3044\u307e\u3059\u3002\u307e\u305aSNSTopic\u306e\u8a2d\u5b9a\u3084S3\u306e\u8a2d\u5b9a\u306a\u3069\u306f\u4e0a\u8a18\u30af\u30e9\u30b9\u30e1\u30bd\u30c3\u30c9\u3055\u3093\u3092\u53c2\u8003\u306b\u3057\u3066\u3044\u305f\u3060\u3051\u305f\u3089\u2026\uff08\u624b\u629c\u304d\u2026\n\u3042\u3001SNS\u3067\u30b5\u30d6\u30b9\u30af\u30ea\u30d7\u30b7\u30e7\u30f3\u3092\u4f5c\u6210\u3059\u308b\u3068\u304d\u306f\n\n* Protocol: http\n* Endpoint: http://Sinatra\u304c\u52d5\u3044\u3066\u3044\u308b\u30b5\u30fc\u30d0:4567/s3notification\n \n\u3068\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\nSNS\u306eHTTP\u901a\u77e5\u3092Sinatra\u3067\u4f5c\u6210\u3057\u305f\u30a2\u30d7\u30ea\u3067\u53d7\u3051\u3066\u3001\u30a4\u30d9\u30f3\u30c8\u306e\u5185\u5bb9\u3092\u30ed\u30b0\u306b\u6b8b\u305d\u3046\u3063\u3066\u304b\u3093\u3058\u3067\u3059\u3002\n\u305f\u3060\u3001Ruby\u306elogger\u3092\u5229\u7528\u3057\u3066\u3044\u308b\u3060\u3051\u306a\u306e\u3067\u51dd\u3063\u305f\u30ed\u30b0\u306b\u3057\u3066\u308b\u308f\u3051\u3058\u3083\u306a\u3044\u3067\u3059\u3002\n\n\u5185\u5bb9\u306f\u7c21\u5358\u3067\n1. Sinatra\u3067SNS\u306e\u30b5\u30d6\u30b9\u30af\u30ea\u30d7\u30b7\u30e7\u30f3\u3092\u53d7\u3051\u308b\u3001\u627f\u8a8d\u3059\u308b\u3002\n2. S3\u306b\u30d5\u30a1\u30a4\u30eb\u304c\u8ffd\u52a0\u3055\u308c\u305f\u901a\u77e5\u3092\u53d7\u3051\u53d6\u308b\u3002\n3. \u5185\u5bb9\u3092\u30ed\u30b0\u306b\u66f8\u304d\u51fa\u3059\u3002 \n\n\u3060\u3051\n\n```rb\n# SNS \u306e\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u30ed\u30fc\u30c9\nSNS = Aws::SNS::Client.new(region: 'ap-northeast-1')\n\n# SNS\u901a\u77e5\u306e\u53d7\u3051\u53e3\npost '/s3notification' do\n  notif = JSON.parse(request.body.read)\n  \n  case notif['Type']\n  # \u30b5\u30d6\u30b9\u30af\u30ea\u30d7\u30b7\u30e7\u30f3\u8a8d\u8a3c\u306e\u30ea\u30af\u30a8\u30b9\u30c8\u3092\u53d7\u3051\u53d6\u3063\u305f\u306e\u3067\u627f\u8a8d\u3059\u308b\u3002\n  when \"SubscriptionConfirmation\" then\n    SNS.confirm_subscription(:topic_arn => notif['TopicArn'],\n                             :token => notif['Token'],\n                             :authenticate_on_unsubscribe => 'true'\n    )\n  # \u901a\u77e5\u3092\u53d7\u3051\u53d6\u3063\u305f\u306e\u3067\u30ea\u30af\u30a8\u30b9\u30c8\u306emessage\u3092\u30ed\u30b0\u3068\u3057\u3066\u51fa\u529b\n  when \"Notification\" then\n   LOGGER.info(notif['Message'])  \n  else\n    LOGGER.info(notif)  \n  end\nend\n\n```\n\u5b9f\u969b\u306e\u30b3\u30fc\u30c9\u306f\u3053\u3061\u3089 https://github.com/mominosin/s3-notification-receiver\n\n\u5b9f\u969b\u306bS3 Notification\u3092\u8a2d\u5b9a\u3057\u305fS3\u306b test01.txt \u3092\u914d\u7f6e\u3057\u305f\u6642\u306b\u98db\u3093\u3067\u304d\u305f\u30ed\u30b0\n\n```\nI, [2014-11-14T17:48:44.411781 #24933]  INFO -- : {\"Records\":[{\"eventVersion\":\"2.0\",\"eventSource\":\"aws:s3\",\"awsRegion\":\"ap-northeast-1\",\"eventTime\":\"2014-11-14T17:46:17.469Z\",\"eventName\":\"ObjectCreated:Put\",\"userIdentity\":{\"principalId\":\"A3336BHUMP8V3P\"},\"requestParameters\":{\"sourceIPAddress\":\"10.114.229.8\"},\"responseElements\":{\"x-amz-request-id\":\"08E05D2DDE657BF4\",\"x-amz-id-2\":\"ngr1FgdrUyg4MiAPwwYdOKxGMxgNVfPGJ9R9rBuhr6aJ0w31v+i/CYw4J2RlhpWh\"},\"s3\":{\"s3SchemaVersion\":\"1.0\",\"configurationId\":\"s3-notification\",\"bucket\":{\"name\":\"s3-notif-test\",\"ownerIdentity\":{\"principalId\":\"A3336BHUMP8V3P\"},\"arn\":\"arn:aws:s3:::s3-notif-test\"},\"object\":{\"key\":\"test01.txt\",\"size\":4815,\"eTag\":\"3a777152a1477fe290405dc5b9b0f59c\"}}}]}\n```\n\u307f\u305a\u3089\u3044\u3063\u3059\u306djq\u306b\u304b\u3051\u3066\u307f\u307e\u3057\u305f\u3002\n\n```rb\n{\n  \"Records\": [\n    {\n      \"s3\": {\n        \"object\": {\n          \"eTag\": \"3a777152a1477fe290405dc5b9b0f59c\",\n          \"size\": 4815,\n          \"key\": \"test01.txt\"\n        },\n        \"bucket\": {\n          \"arn\": \"arn:aws:s3:::s3-notif-test\",\n          \"ownerIdentity\": {\n            \"principalId\": \"A3336BHUMP8V3P\"\n          },\n          \"name\": \"s3-notif-test\"\n        },\n        \"configurationId\": \"s3-notification\",\n        \"s3SchemaVersion\": \"1.0\"\n      },\n      \"eventVersion\": \"2.0\",\n      \"eventSource\": \"aws:s3\",\n      \"awsRegion\": \"ap-northeast-1\",\n      \"eventTime\": \"2014-11-14T17:46:17.469Z\",\n      \"eventName\": \"ObjectCreated:Put\",\n      \"userIdentity\": {\n        \"principalId\": \"A3336BHUMP8V3P\"\n      },\n      \"requestParameters\": {\n        \"sourceIPAddress\": \"10.114.229.8\"\n      },\n      \"responseElements\": {\n        \"x-amz-id-2\": \"ngr1FgdrUyg4MiAPwwYdOKxGMxgNVfPGJ9R9rBuhr6aJ0w31v+i/CYw4J2RlhpWh\",\n        \"x-amz-request-id\": \"08E05D2DDE657BF4\"\n      }\n    }\n  ]\n}\n```\n\neventName\u3068\u304b\u898b\u308c\u3070S3\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u306e\u8ffd\u52a0\u306e\u3055\u308c\u65b9\u304cput\u306a\u306e\u304b\u3001copy\u306a\u306e\u304b\u306a\u3069\u306e\u5224\u5225\u3082\u3067\u304d\u308b\u306e\u304b\u306a\u3068\u601d\u3044\u307e\u3059\u3002\n", "tags": ["Sinatra", "AWS", "Ruby", "aws-sdk", "S3"]}