{"tags": ["Java", "JavaEE", "JAX-RS"], "context": " \u3053\u306e\u8a18\u4e8b\u306f\u6700\u7d42\u66f4\u65b0\u65e5\u304b\u30891\u5e74\u4ee5\u4e0a\u304c\u7d4c\u904e\u3057\u3066\u3044\u307e\u3059\u3002\n\n\u6982\u8981\nJAX-RS\u30ea\u30bd\u30fc\u30b9\u306b @CacheControl(\u307b\u3052\u307b\u3052) \u306e\u3088\u3046\u306a\u30a2\u30ce\u30c6\u30fc\u30b7\u30e7\u30f3\u3092\u4ed8\u4e0e\u3059\u308b\u3053\u3068\u3067\u3001\u30ec\u30b9\u30dd\u30f3\u30b9\u30d5\u30a3\u30eb\u30bf\u3067CacheControl HTTP\u30d8\u30c3\u30c0\u3092\u51fa\u529b\u3057\u307e\u3059\u3002\n\n\u4f7f\u3044\u65b9\n\nSampleResource.java\npublic class SampleResource {\n    @GET\n    @CacheControl(value=CacheResponseDirective.MustRevalidate, maxAge=0)\n    public SomeEntity getEntity() {\n    }\n}\n\n\n\u4e0a\u8a18\u30ea\u30bd\u30fc\u30b9\u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3068\u3001\u3053\u306e\u3088\u3046\u306aHTTP\u30d8\u30c3\u30c0\u304c\u51fa\u529b\u3055\u308c\u307e\u3059\u3002\nCache-Control: must-revalidate,max-age=0\n\n\n\u74b0\u5883\n\nJava 1.8 u31\nGlassfish 4.1\n\n\n\u30b3\u30fc\u30c9\n\nCache-Control\u30d8\u30c3\u30c0\u306eenum\nCache-Control\u30d8\u30c3\u30c0\u3067\u4f7f\u3048\u308b\u3082\u306e\u306e\u4e00\u89a7\u3067\u3059\u3002\n\nCacheResponseDirective.java\npublic enum CacheResponseDirective {\n\n    Public(\"public\"),\n    Private(\"private\"),\n    NoCache(\"no-cache\"),\n    NoStore(\"no-store\"),\n    NoTransform(\"no-transform\"),\n    MustRevalidate(\"must-revalidate\"),\n    ProxyRevalidate(\"proxy-revalidate\");\n\n    private final String represent;\n\n    private CacheResponseDirective(String represent) {\n        this.represent = represent;\n    }\n\n    @Override\n    public String toString() {\n        return represent;\n    }\n}\n\n\n\n\u30a2\u30ce\u30c6\u30fc\u30b7\u30e7\u30f3\nJAX-RS\u30ea\u30bd\u30fc\u30b9\u306b\u4ed8\u3051\u308b\u30a2\u30ce\u30c6\u30fc\u30b7\u30e7\u30f3\u3067\u3059\u3002\n@NameBinding\u3092\u4ed8\u3051\u305f\u306e\u3067\u3001\u3053\u306e\u30a2\u30ce\u30c6\u30fc\u30b7\u30e7\u30f3\u304c\u4ed8\u4e0e\u3055\u308c\u305f\u30ea\u30bd\u30fc\u30b9\u306b\u306e\u307f\u30d5\u30a3\u30eb\u30bf\u304c\u9069\u7528\u3055\u308c\u307e\u3059\u3002\n\nCacheControl.java\nimport java.lang.annotation.ElementType;\nimport java.lang.annotation.Retention;\nimport java.lang.annotation.RetentionPolicy;\nimport java.lang.annotation.Target;\nimport javax.ws.rs.NameBinding;\n\n@NameBinding\n@Target({ElementType.TYPE, ElementType.METHOD})\n@Retention(RetentionPolicy.RUNTIME)\npublic @interface CacheControl {\n\n    CacheResponseDirective[] value() default CacheResponseDirective.Public;\n\n    /**\n     * max-age\u3092\u3092\u6307\u5b9a\u3002\u5358\u4f4d\u306f\u79d2\u3002\n     * <p>\n     * \u5024\u304c0\u4ee5\u4e0a\u306e\u6642\u51fa\u529b\u3057\u307e\u3059\u3002\n     * @return \n     */\n    int maxAge() default -1;\n\n    /**\n     * s-maxage\u3092\u6307\u5b9a\u3002\u5358\u4f4d\u306f\u79d2\u3002\n     * <p>\n     * \u5024\u304c0\u4ee5\u4e0a\u306e\u6642\u51fa\u529b\u3057\u307e\u3059\u3002\n     * @return \n     */\n    int sMaxage() default -1;\n}\n\n\n\n\u30ec\u30b9\u30dd\u30f3\u30b9\u30d5\u30a3\u30eb\u30bf\n\u5b9f\u969b\u306bCache-Control\u30d8\u30c3\u30c0\u3092\u51fa\u529b\u3059\u308b\u30d5\u30a3\u30eb\u30bf\u3067\u3059\u3002\n\nCacheControlFilter.java\nimport java.io.IOException;\nimport java.lang.annotation.Annotation;\nimport java.util.Arrays;\nimport java.util.Optional;\nimport javax.ws.rs.container.ContainerRequestContext;\nimport javax.ws.rs.container.ContainerResponseContext;\nimport javax.ws.rs.container.ContainerResponseFilter;\nimport javax.ws.rs.core.HttpHeaders;\nimport javax.ws.rs.ext.Provider;\n\n@Provider\n@CacheControl\npublic class CacheControlFilter implements ContainerResponseFilter {\n\n    @Override\n    public void filter(ContainerRequestContext request, ContainerResponseContext response) throws IOException {\n        final Annotation[] annotations = response.getEntityAnnotations();\n        final Optional<Annotation> optional = Arrays.stream(annotations)\n                .filter(x -> x.annotationType() == CacheControl.class)\n                .findFirst();\n\n        if (optional.isPresent()) {\n            final CacheControl annotation = (CacheControl) optional.get();\n            final List<String> directives = Arrays.stream(annotation.value())\n                    .map(x -> x.toString())\n                    .collect(Collectors.toList());\n\n            // max-age\u3084s-maxage\u306f0\u4ee5\u4e0a\u306e\u5024\u304c\u6307\u5b9a\u3055\u308c\u305f\u3068\u304d\u306b\u51fa\u529b\u3057\u307e\u3059\u3002\n            if (annotation.maxAge() >= 0) {\n                directives.add(String.format(\"max-age=%d\", annotation.maxAge()));\n            }\n\n            if (annotation.sMaxage() >= 0) {\n                directives.add(String.format(\"s-maxage=%d\", annotation.sMaxage()));\n            }\n\n            final String token = String.join(\",\", directives);\n\n            response.getHeaders().putSingle(HttpHeaders.CACHE_CONTROL, token);\n        }\n    }\n}\n\n\n\n# \u6982\u8981\n\nJAX-RS\u30ea\u30bd\u30fc\u30b9\u306b ``@CacheControl(\u307b\u3052\u307b\u3052)`` \u306e\u3088\u3046\u306a\u30a2\u30ce\u30c6\u30fc\u30b7\u30e7\u30f3\u3092\u4ed8\u4e0e\u3059\u308b\u3053\u3068\u3067\u3001\u30ec\u30b9\u30dd\u30f3\u30b9\u30d5\u30a3\u30eb\u30bf\u3067CacheControl HTTP\u30d8\u30c3\u30c0\u3092\u51fa\u529b\u3057\u307e\u3059\u3002\n\n## \u4f7f\u3044\u65b9\n\n```java:SampleResource.java\npublic class SampleResource {\n    @GET\n    @CacheControl(value=CacheResponseDirective.MustRevalidate, maxAge=0)\n    public SomeEntity getEntity() {\n    }\n}\n```\n\n\u4e0a\u8a18\u30ea\u30bd\u30fc\u30b9\u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3068\u3001\u3053\u306e\u3088\u3046\u306aHTTP\u30d8\u30c3\u30c0\u304c\u51fa\u529b\u3055\u308c\u307e\u3059\u3002\n\n```\nCache-Control: must-revalidate,max-age=0\n```\n\n# \u74b0\u5883\n\n- Java 1.8 u31\n- Glassfish 4.1\n\n\n# \u30b3\u30fc\u30c9\n\n## Cache-Control\u30d8\u30c3\u30c0\u306eenum\n\nCache-Control\u30d8\u30c3\u30c0\u3067\u4f7f\u3048\u308b\u3082\u306e\u306e\u4e00\u89a7\u3067\u3059\u3002\n\n```java:CacheResponseDirective.java\npublic enum CacheResponseDirective {\n\n    Public(\"public\"),\n    Private(\"private\"),\n    NoCache(\"no-cache\"),\n    NoStore(\"no-store\"),\n    NoTransform(\"no-transform\"),\n    MustRevalidate(\"must-revalidate\"),\n    ProxyRevalidate(\"proxy-revalidate\");\n\n    private final String represent;\n\n    private CacheResponseDirective(String represent) {\n        this.represent = represent;\n    }\n\n    @Override\n    public String toString() {\n        return represent;\n    }\n}\n```\n\n## \u30a2\u30ce\u30c6\u30fc\u30b7\u30e7\u30f3\n\nJAX-RS\u30ea\u30bd\u30fc\u30b9\u306b\u4ed8\u3051\u308b\u30a2\u30ce\u30c6\u30fc\u30b7\u30e7\u30f3\u3067\u3059\u3002\n\n``@NameBinding``\u3092\u4ed8\u3051\u305f\u306e\u3067\u3001\u3053\u306e\u30a2\u30ce\u30c6\u30fc\u30b7\u30e7\u30f3\u304c\u4ed8\u4e0e\u3055\u308c\u305f\u30ea\u30bd\u30fc\u30b9\u306b\u306e\u307f\u30d5\u30a3\u30eb\u30bf\u304c\u9069\u7528\u3055\u308c\u307e\u3059\u3002\n\n```java:CacheControl.java\nimport java.lang.annotation.ElementType;\nimport java.lang.annotation.Retention;\nimport java.lang.annotation.RetentionPolicy;\nimport java.lang.annotation.Target;\nimport javax.ws.rs.NameBinding;\n\n@NameBinding\n@Target({ElementType.TYPE, ElementType.METHOD})\n@Retention(RetentionPolicy.RUNTIME)\npublic @interface CacheControl {\n\n    CacheResponseDirective[] value() default CacheResponseDirective.Public;\n    \n    /**\n     * max-age\u3092\u3092\u6307\u5b9a\u3002\u5358\u4f4d\u306f\u79d2\u3002\n     * <p>\n     * \u5024\u304c0\u4ee5\u4e0a\u306e\u6642\u51fa\u529b\u3057\u307e\u3059\u3002\n     * @return \n     */\n    int maxAge() default -1;\n    \n    /**\n     * s-maxage\u3092\u6307\u5b9a\u3002\u5358\u4f4d\u306f\u79d2\u3002\n     * <p>\n     * \u5024\u304c0\u4ee5\u4e0a\u306e\u6642\u51fa\u529b\u3057\u307e\u3059\u3002\n     * @return \n     */\n    int sMaxage() default -1;\n}\n```\n\n## \u30ec\u30b9\u30dd\u30f3\u30b9\u30d5\u30a3\u30eb\u30bf\n\n\u5b9f\u969b\u306bCache-Control\u30d8\u30c3\u30c0\u3092\u51fa\u529b\u3059\u308b\u30d5\u30a3\u30eb\u30bf\u3067\u3059\u3002\n\n```java:CacheControlFilter.java\nimport java.io.IOException;\nimport java.lang.annotation.Annotation;\nimport java.util.Arrays;\nimport java.util.Optional;\nimport javax.ws.rs.container.ContainerRequestContext;\nimport javax.ws.rs.container.ContainerResponseContext;\nimport javax.ws.rs.container.ContainerResponseFilter;\nimport javax.ws.rs.core.HttpHeaders;\nimport javax.ws.rs.ext.Provider;\n\n@Provider\n@CacheControl\npublic class CacheControlFilter implements ContainerResponseFilter {\n\n    @Override\n    public void filter(ContainerRequestContext request, ContainerResponseContext response) throws IOException {\n        final Annotation[] annotations = response.getEntityAnnotations();\n        final Optional<Annotation> optional = Arrays.stream(annotations)\n                .filter(x -> x.annotationType() == CacheControl.class)\n                .findFirst();\n\n        if (optional.isPresent()) {\n            final CacheControl annotation = (CacheControl) optional.get();\n            final List<String> directives = Arrays.stream(annotation.value())\n                    .map(x -> x.toString())\n                    .collect(Collectors.toList());\n\n            // max-age\u3084s-maxage\u306f0\u4ee5\u4e0a\u306e\u5024\u304c\u6307\u5b9a\u3055\u308c\u305f\u3068\u304d\u306b\u51fa\u529b\u3057\u307e\u3059\u3002\n            if (annotation.maxAge() >= 0) {\n                directives.add(String.format(\"max-age=%d\", annotation.maxAge()));\n            }\n\n            if (annotation.sMaxage() >= 0) {\n                directives.add(String.format(\"s-maxage=%d\", annotation.sMaxage()));\n            }\n\n            final String token = String.join(\",\", directives);\n\n            response.getHeaders().putSingle(HttpHeaders.CACHE_CONTROL, token);\n        }\n    }\n}\n\n```\n"}