{"tags": ["chef-solo", "Ruby"], "context": " More than 1 year has passed since last update.\u3068\u308a\u3042\u3048\u305a\u914d\u5217\u3068\u304b\u30cf\u30c3\u30b7\u30e5\u3068\u304b\u306e\u6271\u3044\u65b9\u3092\u30d4\u30c3\u30af\u30a2\u30c3\u30d7\u3057\u3066\u5099\u5fd8\u9332\u3092\u3002\n\u203bdata_bag\u306e\u30c7\u30fc\u30bf\u3092\u6271\u3046\u30cf\u30f3\u30ba\u30aa\u30f3\u98a8\u306b\u3057\u3088\u3046\u3068\u3057\u3066\u5931\u6557\u3002\u3068\u308a\u3042\u3048\u305a\u5099\u5fd8\u9332\u306a\u306e\u3067\u3054\u53c2\u8003\u307e\u3067\u3002\n\n\uff10\uff0e\u30c4\u30fc\u30eb\u306e\u4f7f\u3044\u65b9\u307b\u304b\u4e0b\u6e96\u5099\nknife-solo\u3068knife-solo_data_bag\u306egem\u304c\u5165\u3063\u3066\u306a\u3051\u308c\u3070\u5165\u308c\u308b\u3002\ngem install knife-solo knife-solo_data_bag\n\nEDITOR\u74b0\u5883\u5909\u6570\u3092export\u3059\u308b\u3088\u3046\u306b\u3069\u3063\u304b\u306b\u304b\u3044\u3068\u304f\nvi ~/.bashrc\nexport EDITOR=vi\n\nknife\u30b3\u30de\u30f3\u30c9\u3067data_bags\u3092\u958b\u3051\u308b\u3068\u304d\u306bEDITOR\u306b\u6307\u5b9a\u3057\u305f\u3082\u306e\u304c\u4f7f\u308f\u308c\u307e\u3059\u3002\n\n\uff11\uff0e\u6697\u53f7\u9375\u3092\u4f5c\u308b\u3001\u9375\u306e\u7ba1\u7406\u306b\u3064\u3044\u3066\n\u30fb\u6697\u53f7\u9375\u3092\u3064\u304f\u308b\nopenssl rand -base64 512 > databag_key\n\n\u4f5c\u3089\u308c\u305f\u9375\u3092git\u306b\u30b3\u30df\u30c3\u30c8\u3055\u308c\u306a\u3044\u3088\u3046\u306b.gitignore\u306b\u8a18\u8f09\nvi .gitignore\ndatabag_key\n\n\uff08\u203b\u9375\u306f\u6848\u4ef6\u3054\u3068\u306b\u7570\u306a\u308b\u30a4\u30e1\u30fc\u30b8\u3067\u3001\u6d41\u51fa\u53b3\u7981\u304b\u3064\u7121\u304f\u3059\u3068\u30c7\u30fc\u30bf\u304c\u898b\u3048\u306a\u304f\u306a\u308a\u307e\u3059\u3002\uff09\n\n\uff12\uff0e\u6697\u53f7\u9375\u3092~/chefrepo/.chef/knife.rb\u306b\u8a2d\u5b9a\u3059\u308b\nvi ~/chefrepo/.chef/knife.rb\n-----\nchef_repo = File.join(File.dirname(__FILE__), \"..\")\ncurrent_dir = File.dirname(__FILE__)\nlog_level                :info\nlog_location             STDOUT\nclient_key               \"#{current_dir}/dummy.pem\"\nvalidation_client_name   'chef-validator'\nvalidation_key           \"#{current_dir}/dummy.pem\"\ncookbook_path    [\"#{chef_repo}/cookbooks\", \"#{chef_repo}/site-cookbooks\"]\nnode_path        \"#{chef_repo}/nodes\"\nrole_path        \"#{chef_repo}/roles\"\nenvironment_path \"#{chef_repo}/environments\"\ndata_bag_path    \"#{chef_repo}/data_bags\"\nencrypted_data_bag_secret \"#{chef_repo}/databag_key\" ##\u2605\u3053\u3053\n\n#puts Chef::Config.inspect\n-----\n\n\n\uff13\uff0e\u6697\u53f7\u5316\u3057\u306a\u3044\u30c7\u30fc\u30bf\u3092\u767b\u9332\u3059\u308b\nencrypted_data_bag_secret \u306b\u9375\u3092\u6307\u5b9a\u3057\u305f\u72b6\u614b\u3067knife solo data bag\u30b3\u30de\u30f3\u30c9\u3092\u4f7f\u3046\u3068\u30c7\u30fc\u30bf\u304c\u6697\u53f7\u5316\u3055\u308c\u3066\u767b\u9332\u3055\u308c\u307e\u3059\u3002\n\u306a\u306e\u3067\u6697\u53f7\u5316\u3057\u305f\u304f\u306a\u3044\u5834\u5408\u306fvi\u7b49\u306e\u901a\u5e38\u3064\u304b\u3063\u3066\u3044\u308b\u30a8\u30c7\u30a3\u30bf\u3067\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\nvi ~/chefrepo/data_bags/<bag-name>/<json-data-file-name>.json\nvi ~/chefrepo/data_bags/fluentd/loghost.json\n-------\n{\n  \"id\": \"loghost\",\n  \"loghost\": \"log.mng.local\",\n  \"key1\": \"value1\",\n  \"key2\": \"value2\"\n}\n-------\ncat ~/chefrepo/data_bags/fluentd/loghost.json |json_verify\n\n\u3000\u203bjson\u30c7\u30fc\u30bf\u306e\u30b7\u30f3\u30bf\u30c3\u30af\u30b9\u30c1\u30a7\u30c3\u30af\u3092json_verify\u3084jsonlint\u306b\u6e21\u3059\u7b49\u3067\u5b9f\u65bd\u3059\u308b\u3068\u52b9\u7387\u304c\u826f\u3044\u3067\u3059\u3002\uff08\u6700\u7d42\u884c\u306e\u30ab\u30f3\u30de\u6709\u3068\u9014\u4e2d\u306e\u884c\u306e\u30ab\u30f3\u30de\u5fd8\u308c\u6ce8\u610f\uff09\n\u3000\u203bid\u304c\u6700\u3082\u91cd\u8981\u3067\u3001\u30ec\u30b7\u30d4\u5185\u90e8\u304b\u3089\u547c\u3073\u51fa\u3059\u6642\u306b\u306fid\u3092\u7528\u3044\u307e\u3059\uff08\u30b3\u30d4\u30fc\u3057\u305f\u5f8c\u306e\u4fee\u6b63\u6f0f\u308c\u306b\u6ce8\u610f\uff09\u3002\n\u3000\u3000\u3064\u307e\u308a\u30d5\u30a1\u30a4\u30eb\u540d\u3068id\u304c\u4e00\u81f4\u3057\u3066\u3044\u308b\u5fc5\u8981\u306f\u306a\u3055\u3052\u3067\u3059\u304c\u3001json\u30d5\u30a1\u30a4\u30eb\u540d\u3092id\u3068\u540c\u3058\u306b\u3059\u308b\u3068\u308f\u304b\u308a\u3084\u3059\u3044\u3067\u3059\u3002\n\n\uff14\uff0e\u6697\u53f7\u5316\u3057\u306a\u3044\u30c7\u30fc\u30bf\u3092\u53d6\u308a\u51fa\u3059\nvi ~/chefrepo/site-cookbooks/<cookbook-name>/recipes/<recipe-name>.rb\n-------\nloghost = data_bag_item('fluentd',\"loghost\")['loghost']  ##\u2605data_bag_item('bag\u540d\u2252\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u540d',\"json\u30d5\u30a1\u30a4\u30eb\u5185id\u5024\")['\u30ad\u30fc\u5024']\nkey1 = data_bag_item('fluentd',\"loghost\")['key1']\ntemplate \"/etc/td-agent/extra/td-agent-syslog.conf\" do\n  action :create\n  source \"td-agent.conf.client-syslog.erb\"\n  notifies :restart, 'service[td-agent]'\n  variables ({\n   :loghost => loghost,   ##\u2605\u3053\u3053\u3067\u30cf\u30c3\u30b7\u30e5\u3068\u3057\u3066\u5b9a\u7fa9\u3057\u3066\u308b\u3002:template\u30d5\u30a1\u30a4\u30eb\u5185\u306e@\u5909\u6570 => recipe\u3067\u6307\u5b9a\u3057\u3066\u308b\u5909\u6570\u3000\n\u3000 :key1 => key1\n  })\nend\n-------\n\nvi ~/chefrepo/site-cookbooks/<cookbook-name>/templates/default/td-agent.conf.client-syslog.erb\n-------\n  <store>\n    type forward\n    heartbeat_type tcp\n    send_timeout 60s\n    flush_interval 1s\n    buffer_queue_limit 512\n    buffer_type file\n    buffer_path /var/tmp/fluent_buf\n    expire_dns_cache 10\n  <server>\n      host <%= @loghost %>  ##\u2605\u3053\u3053\u3067<%= @var %>\u3067\u6307\u5b9a\u3057\u305f\u5909\u6570\u306brecipe\u306etemplate\u30ea\u30bd\u30fc\u30b9\u306evariables\u3067\u6307\u5b9a\u3057\u305f\u5024\u304c\u5165\u308b\n      port 24224\n  </server>\n  </store>\n-------\n\n\u3000\u203b\u5358\u72ec\u306ekey\u3092\u53d6\u308a\u51fa\u3057\u305f\u3044\u306e\u3067\u306a\u3051\u308c\u3070\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u66f8\u304d\u65b9\u304c\u3042\u308a\u307e\u3059\u3002\nlogdata = data_bag_item('fluentd',\"#{account}_loghost\")\nloghost = logdata['loghost']\nkey1 = logdata['key1']\nkey2 = logdata['key2']\n\n\n\uff15\uff0eknife\u3067\u6697\u53f7\u5316\u3059\u308b\u30c7\u30fc\u30bf\u3092\u767b\u9332\u3059\u308b\n\u3000\u30fbsolo\u3060\u3068knife solo data bag   \u3068\u3044\u3046\u611f\u3058\u3067\u3001\u30b5\u30d6\u30b3\u30de\u30f3\u30c9\u306f\u4ee5\u4e0b\u304c\u3042\u308b\n\n\n\nName\n\u30b5\u30d6\u30b3\u30de\u30f3\u30c9\u89e3\u8aac\n\n\n\n\ncreate\n\u65b0\u898f\u4f5c\u6210\u3002\u65e2\u5b58\u306b\u3084\u308b\u3068\u4e0a\u66f8\u304d\u3055\u308c\u308b\u306e\u3067\u6ce8\u610f\u3002git checkout\u3067\u623b\u3057\u307e\u3057\u3087\u3046\u3002\n\n\nedit\n\u7de8\u96c6\u3002\u65e2\u5b58\u30d5\u30a1\u30a4\u30eb\u3092\u7de8\u96c6\u3057\u305f\u3044\u3068\u304d\u306b\u3002\u65b0\u898f\u4f5c\u6210\u306f\u3067\u304d\u307e\u305b\u3093\u3002\u7de8\u96c6\u3057\u306a\u3044\u3067\u9589\u3058\u3066\u3082git\u7684\u306b\u306f\u66f4\u65b0\u3055\u308c\u3066\u308b\u98a8\u306b\u306a\u308b\u306e\u3067git checkout\u3067\u623b\u3057\u307e\u3057\u3087\u3046\u3002\n\n\nshow\n\u4e2d\u8eab\u3092\u307f\u305f\u3044\u3060\u3051\u306e\u3068\u304d\u306b\u8868\u793a\u3057\u3066\u304f\u308c\u308b\u3002json\u5f62\u5f0f\u3067\u306f\u306a\u3044\u3002\n\n\nlist\nbag\u306e\u30ea\u30b9\u30c8\u3092\u8868\u793a\u3057\u3066\u304f\u308c\u308b\u3060\u3051(data_bags\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u76f4\u4e0b\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u304c\u4e00\u89a7\u8868\u793a\u3055\u308c\u308b\u3060\u3051)\n\n\n\nknife solo data bag create fluentd loghost\nknife solo data bag edit fluentd loghost\nknife solo data bag show fluentd loghost\n\n\u3000\u203bknife\u30b3\u30de\u30f3\u30c9\u4f7f\u3046\u5834\u5408\u306f\u30b7\u30f3\u30bf\u30c3\u30af\u30b9\u304c\u9593\u9055\u3063\u305f\u30c7\u30fc\u30bf\u3092\u767b\u9332\u3057\u305f\u307e\u307e\u30a8\u30c7\u30a3\u30bf\u3092\u9589\u3058\u3088\u3046\u3068\u3059\u308b\u3068\u30a8\u30e9\u30fc\u3067\u9589\u3058\u308c\u306a\u3044\u304b\u518d\u3073\u958b\u3044\u305f\u3068\u304d\u306b\u7a7a\u306b\u306a\u3063\u3066\u308b\u3068\u601d\u3044\u307e\u3059\u3002\n\n\uff16\uff0e\u6697\u53f7\u5316\u3059\u308b\u30c7\u30fc\u30bf\u3092\u53d6\u308a\u51fa\u3059\n\u66f8\u304d\u304b\u305f\u304c\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u5909\u308f\u308b\u3060\u3051\u3067\u3042\u3068\u306f\u540c\u3058\u3002\nlogdata = data_bag_item('fluentd',\"#{account}_loghost\")\n\u3000\u2193\nlogdata = Chef::EncryptedDataBagItem.load('fluentd',\"#{account}_loghost\")\n\n\n\uff17\uff0e1\u6b21\u5143\u306e\u914d\u5217\u30c7\u30fc\u30bf\u3092\u767b\u9332\u3059\u308b\nruby\u306b\u304a\u3051\u308b\u914d\u5217\u306f\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u5b9a\u7fa9\u3059\u308b\u3053\u3068\u304c\u53ef\u80fd\u3067\u3059\u3002\narray = [\"var1\",\"var2\",\"var3\"]\narray = %w{\"var1\" \"var2\" \"var3\"}\n\n\u914d\u5217\u3092\u521d\u671f\u5316\u3057\u305f\u5909\u6570\u3092\u30c7\u30d5\u30a9\u30eb\u30c8\u306eattribute\u3068\u3057\u3066\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u767b\u9332\u3057\u3066\u304a\u304b\u306a\u3044\u3068\u30a8\u30e9\u30fc\u306b\u306a\u308b\u5834\u5408\u304c\u3042\u308a\u307e\u3059\u3002(\u521d\u671f\u5316\u306e\u914d\u7f6e\u5834\u6240\u306f\u30ec\u30b7\u30d4\u5185\u3067\u3082attribute\u3067\u3082\u3069\u3063\u3061\u3067\u3082OK)\narray = []\n\nvi ~/chefrepo/data_bags/awskeys/zabbix_all.json\n-------\n{\n  \"id\": \"zabbix-all\",\n  \"accounts\": [ \"hoge\", \"fuga\", \"piyo\" ]\n}\n-------\n\n\n\uff18\uff0e1\u6b21\u5143\u306e\u914d\u5217\u30c7\u30fc\u30bf\u3092\u53d6\u308a\u51fa\u3059\n\u914d\u5217\u30c7\u30fc\u30bf\u306feach\u3067\u53d6\u308a\u51fa\u305b\u307e\u3059\u3002for\u3068each\u306f\u304a\u306a\u3058\u6a5f\u80fd\u306e\u30e1\u30bd\u30c3\u30c9\u3067\u3059(for\u306e\u5b9f\u4f53\u304ceach\u3060\u3063\u305f\u6c17\u304c\u3059\u308b)\u3002\naccounts = key_data['accounts']\naccounts.each do |account|\n cron \"test_#{accounts}\" do\n    user \"root\"\n    command \"/bin/echo #{account} > /tmp/#{account}.txt 2>&1\"\n    hour \"*\"\n    minute \"0\"\n  end\nend\n\n\n\uff19\uff0e\u914d\u5217\u3068\u30cf\u30c3\u30b7\u30e5\u306e\u5165\u308c\u5b50\u30c7\u30fc\u30bf\u3092\u767b\u9332\u3059\u308b\n\u7570\u306a\u308bkey=value\u306e\u96c6\u5408\u30c7\u30fc\u30bf\u3092\u30cf\u30c3\u30b7\u30e5\u3068\u3044\u3044\u307e\u3059\u3002\n\u30cf\u30c3\u30b7\u30e5\u306fruby\u3060\u3068\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u5b9a\u7fa9\u3067\u304d\u307e\u3059\u304c\u3001chef\u306eattribute\u7684\u306b\u306f\u3001{ \"key1\": \"var1\", \"key2\": \"var2\",, }\u3068\u3044\u3046\u611f\u3058\u3067\u3059\u3002\nhash = { \"key1\" => \"var1\", \"key2\" => \"var2\", \"key3\" => \"var3\" }\n\u4ee5\u4e0b\u306e\u4f8b\u3067\u306f\u914d\u5217\u306e\u4e2d\u306b\u30cf\u30c3\u30b7\u30e5\u304c\u5165\u3063\u3066\u3044\u307e\u3059\u3002\nvi ~/chefrepo/data_bags/awskeys/zabbix_all.json\n-----------\n{\n  \"id\": \"zabbix-all\",\n  \"awskeys\": [\n    {\n      \"zabbix_account\": \"zabbix-prd\",\n      \"region\": \"us-**st-2\",\n      \"aws_access_key_id\": \"AKIA***************\",\n      \"aws_secret_access_key\": \"****************************************\"\n    },\n    {\n      \"zabbix_account\": \"zabbix-dev\",\n      \"region\": \"us-**st-2\",\n      \"aws_access_key_id\": \"AKIA*****************\",\n      \"aws_secret_access_key\": \"****************************************\"\n    }\n  ],\n  \"accounts\": [ \"hoge\", \"fuga\", \"piyo\" ]\n}\n-----------\n\n\n\uff11\uff10\uff0e\u914d\u5217\u3068\u30cf\u30c3\u30b7\u30e5\u306e\u5165\u308c\u5b50\u30c7\u30fc\u30bf\u3092\u53d6\u308a\u51fa\u3059\n\u30fb\u307e\u3068\u3081\u3066\u3068\u308a\u3060\u3057\u3066for\u3067\u5168\u90e8\u306e\u30c7\u30fc\u30bf\u3092\u7f6e\u304f\u30d1\u30bf\u30fc\u30f3\n\u3000template\u30d5\u30a1\u30a4\u30eb\u5074\u306bfor\u30eb\u30fc\u30d7\u306e\u30e1\u30bd\u30c3\u30c9\u3092\u4ed5\u8fbc\u3093\u3067\u53d6\u308a\u51fa\u3057\u307e\u3059\u3002\nvi ~/chefrepo/site-cookbooks/zabbix/recipes/cloudtrail.rb\n-----------\nawskeys = key_data['awskeys']\ntemplate \"/root/.aws/config\" do\n  source \"config_root.erb\"\n  mode 0700\n  owner \"root\"\n  group \"root\"\n  variables ({\n    :awskeys => awskeys\n  })\nend\n-----------\nvi ~/chefrepo/site-cookbooks/zabbix/templates/default/config_root.erb\n-----------\n<% for key in @awskeys %>\n[profile <%= key[\"zabbix_account\"] %>]\noutput=json\naws_access_key_id=<%= key[\"aws_access_key_id\"] %>\naws_secret_access_key=<%= key[\"aws_secret_access_key\"] %>\nregion=<%= key[\"region\"] %>\n\n<% end %>\n-----------\n\n\u3000\u203btemplate\u30d5\u30a1\u30a4\u30eb\u5185\u3067\u306f<% %>\u5185\u306bruby\u306e\u30b3\u30fc\u30c9\u304c\u66f8\u3051\u307e\u3059\u3002\u3088\u3063\u3066if\u3068\u304belsif\u3068\u304b\u3082\u66f8\u3051\u307e\u3059\u3002\n\u30fb\u7279\u5b9a\u306e\u6587\u5b57\u5217\u306b\u4e00\u81f4\u3059\u308b\u5024\u3060\u3051\u53d6\u308a\u51fa\u3057\u305f\u3044\u30d1\u30bf\u30fc\u30f3(\u30ec\u30b7\u30d4\u629c\u7c8b\u4f8b\uff09\n\u3000\u3053\u3061\u3089\u306f\u30ec\u30b7\u30d4\u5074\u3067\u76ee\u7684\u306b\u3042\u3063\u305f\u30e1\u30bd\u30c3\u30c9\u3092\u7528\u3044\u3066\u5024\u3092\u6574\u3048\u3066\u53d6\u308a\u51fa\u3059\u5f62\u3067\u3059\u3002\n  ## set client variables for secure_forward.\n  sfvariables = {}\n  fluentusers.each do |fluentuser|\n    if fluentuser.has_value?(\"#{account}\")         ##\u4e00\u81f4\u3059\u308b\u30a2\u30ab\u30a6\u30f3\u30c8\u304c\u542b\u307e\u308c\u3066\u3044\u308b\u30cf\u30c3\u30b7\u30e5\u306e\u5834\u5408\u3060\u3051\u3001\u3001\n      fluentuser.values_at(:username, :password)   ##\u6307\u5b9a\u3057\u305fkey\u3092\u62bd\u51fa\u3057\u305f\u30cf\u30c3\u30b7\u30e5\u30c7\u30fc\u30bf\u3092\u3082\u3068\u306e\u30cf\u30c3\u30b7\u30e5\u306b\u5165\u308c\u3066\u3001\n      sfvariables = fluentuser                     ##\u30d4\u30c3\u30af\u30a2\u30c3\u30d7\u3057\u305f\u5024\u3092\u65b0\u3057\u3044\u30cf\u30c3\u30b7\u30e5\u306b\u4ee3\u5165\n    end\n  end\n  sfvariables.merge! ({                            ##\u307b\u304b\u306e\u30cf\u30c3\u30b7\u30e5\u3068\u7d50\u5408\u3057\u305f\u304b\u3063\u305f\u3089\u3057\u3066!\u304c\u3064\u3044\u3066\u308b\u306e\u3067\u4e0a\u66f8\u304d\u3002\n        :shared_key => shared_key,\n        :sslcacrt => sslcacrtfile,\n        :servers => servers,\n  })\n  ## set client template for secure_forward.\n  template \"/etc/td-agent/extra/td-agent-#{ssl_conf}\" do\n    action :create\n    source \"td-agent.conf.server-#{ssl_conf}.erb\"\n    notifies :restart, 'service[td-agent]'\n    variables sfvariables                          ##template\u30ea\u30bd\u30fc\u30b9\u3067variables\u306b\u3055\u3063\u304d\u4f5c\u3063\u305f\u30cf\u30c3\u30b7\u30e5\u3092\u6307\u5b9a\u3057\u3066template\u30d5\u30a1\u30a4\u30eb\u5185\u306e@\u3068\u5dee\u3057\u66ff\u3048\u308b\u3002\n  end\n\n\n\uff11\uff11\uff0e\u8a3c\u660e\u66f8\u3092\u767b\u9332\u3059\u308b\ncat\u3057\u3066perl\u3068\u304b\u3067\u672b\u5c3e\u306e\u6539\u884c\u3092\u6587\u5b57\u5217\u306b\u7f6e\u63db\u3057\u305f\u5024\u3092key\u306b\u5bfe\u3059\u308bvalue\u3068\u3057\u30661\u884c\u3067\u767b\u9332\u3059\u308b\u611f\u3058\u3067\u3059\u3002\u6697\u53f7\u5316\u5fc5\u9808\u3067\u3059\u3002\ncat certdata.txt | perl -pe 's/\\n/\\\\n/g'\nknife solo data bag create certs mng-wildcard2\n{\n  \"id\": \"mng-wildcard2\",\n  \"crt\": \"\u3053\u3053\u306b1\u884c\u306b\u5909\u63db\u3057\u305f\u5024\u3092\u30b3\u30d4\u30da\",\n  \"key\": \"\u3053\u3053\u306b1\u884c\u306b\u5909\u63db\u3057\u305f\u5024\u3092\u30b3\u30d4\u30da\",\n  \"cacrt\": \"\u3053\u3053\u306b1\u884c\u306b\u5909\u63db\u3057\u305f\u5024\u3092\u30b3\u30d4\u30da\"\n}\n\n\n\uff11\uff12\uff0e\u8a3c\u660e\u66f8\u3092\u53d6\u308a\u51fa\u3059\n\u30fbcerts\u306b\u6697\u53f7\u5316\u3055\u308c\u305f\u8a3c\u660e\u66f8\u672c\u4f53\u3092\u5165\u308c\u3066\u3001ssl\u3067\u305d\u306e\u8a3c\u660e\u66f8\u3092\u30dd\u30a4\u30f3\u30bf\u3057\u3066\u3001\n\u3000role\u305d\u306e\u305f\u306e\u30a2\u30c8\u30ea\u30d3\u30e5\u30fc\u30c8\u3067ssl\u5074\u306edata_bags\u540d\u3092\u6307\u5b9a\u3059\u308b\u307f\u305f\u3044\u306a\u30a4\u30e2\u30c5\u30eb\u65b9\u5f0f\u306b\u3057\u3066\u3044\u307e\u3059\u3002\n\u3000\u7406\u7531\u3068\u3057\u3066\u306f\u8a3c\u660e\u66f8\u81ea\u4f53\u306e\u66f4\u65b0\u4f5c\u696d\u306f\u30b7\u30f3\u30d7\u30eb\u306b\u3057\u305f\u3044\u9700\u8981\u304b\u3089\u3002\n vi ~/chefrepo/site-cookbooks/nginx/recipes/nginx_ssl.rb\n---------------------\nenvironment = node.chef_environment\ndata_type = node['nginx']['data_type']\ndatafile = \"#{data_type}_#{environment}\"\n  sslclientconf_type = node['nginx']['sslclientconf_type']\n  sslkeydir = '/etc/nginx'\n  ssl_databag = data_bag_item(\"ssl\", \"#{datafile}\")\n\n  # SSL Server Certificate\n  sslcert_type = ssl_databag[\"cert-type\"]\n  servercerts_databag = Chef::EncryptedDataBagItem.load(\"certs\", \"#{sslcert_type}\")\n  sslkeyfile = \"#{sslcert_type}.key\"\n  sslcrtfile = \"#{sslcert_type}.crt\"\n  sslcrtdata = servercerts_databag[\"crt\"]\n  sslkeydata = servercerts_databag[\"key\"]\n\n  variables.merge!({\n    :sslcrt => sslcrtfile,\n    :sslkey => sslkeyfile\n  })\n\n  # SSL Server Certificate and Key\n  file \"#{sslkeydir}/#{sslcrtfile}\" do\n    notifies :restart, 'service[nginx]'\n    content  sslcrtdata\n  end\n\n  file \"#{sslkeydir}/#{sslkeyfile}\" do\n    notifies :restart, 'service[nginx]'\n    content sslkeydata\n  end\n---------------------\n\n\u3000\u203bfile\u30ea\u30bd\u30fc\u30b9\u306econtent\u3092\u4f7f\u3046\u3068template\u304c\u8981\u3089\u306a\u3044\u306e\u3067\u7c21\u5358\u30b7\u30f3\u30d7\u30eb\u306b\u3002\n\u3000\u203b\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u8a3c\u660e\u66f8\u3092\u4f7f\u3046\u4f7f\u308f\u306a\u3044\u4ed6\u306e\u5206\u5c90\u304c\u5165\u308b\u3068\u4e0a\u8a18\u3088\u308a\u306ffor\u3068\u304bmerge!\u3068\u304b\u591a\u7528\u306b\u306a\u308b\u304b\u3082\u3002\n\n\uff11\uff13\uff0e\u53c2\u8003\u8cc7\u6599\ntemplate \u2014 Chef Docs\ndatabags \u3092\u4f7f\u3063\u3066\u307f\u305f\u4e00\u90e8\u59cb\u7d42\uff081\uff09 - \u3088\u3046\u3078\u3044\u306e\u65e5\u3005\u7cbe\u9032\n\u914d\u5217\u306e\u306a\u304b\u306b\u5165\u308c\u5b50\u306a\u8907\u6570\u306e\u30cf\u30c3\u30b7\u30e5\u306edata_bags\u306ejson\u3092chef\u3067\u6271\u3046\u30ec\u30b7\u30d4 - Qiita\n\u3068\u308a\u3042\u3048\u305a\u914d\u5217\u3068\u304b\u30cf\u30c3\u30b7\u30e5\u3068\u304b\u306e\u6271\u3044\u65b9\u3092\u30d4\u30c3\u30af\u30a2\u30c3\u30d7\u3057\u3066\u5099\u5fd8\u9332\u3092\u3002\n\n\u203bdata_bag\u306e\u30c7\u30fc\u30bf\u3092\u6271\u3046\u30cf\u30f3\u30ba\u30aa\u30f3\u98a8\u306b\u3057\u3088\u3046\u3068\u3057\u3066\u5931\u6557\u3002\u3068\u308a\u3042\u3048\u305a\u5099\u5fd8\u9332\u306a\u306e\u3067\u3054\u53c2\u8003\u307e\u3067\u3002\n\n### \uff10\uff0e\u30c4\u30fc\u30eb\u306e\u4f7f\u3044\u65b9\u307b\u304b\u4e0b\u6e96\u5099\n\nknife-solo\u3068knife-solo_data_bag\u306egem\u304c\u5165\u3063\u3066\u306a\u3051\u308c\u3070\u5165\u308c\u308b\u3002\n\n```\ngem install knife-solo knife-solo_data_bag\n```\n\nEDITOR\u74b0\u5883\u5909\u6570\u3092export\u3059\u308b\u3088\u3046\u306b\u3069\u3063\u304b\u306b\u304b\u3044\u3068\u304f\n\n```\nvi ~/.bashrc\nexport EDITOR=vi\n```\n\nknife\u30b3\u30de\u30f3\u30c9\u3067data_bags\u3092\u958b\u3051\u308b\u3068\u304d\u306bEDITOR\u306b\u6307\u5b9a\u3057\u305f\u3082\u306e\u304c\u4f7f\u308f\u308c\u307e\u3059\u3002\n\n###  \uff11\uff0e\u6697\u53f7\u9375\u3092\u4f5c\u308b\u3001\u9375\u306e\u7ba1\u7406\u306b\u3064\u3044\u3066\n\n\u30fb\u6697\u53f7\u9375\u3092\u3064\u304f\u308b\n\n```\nopenssl rand -base64 512 > databag_key\n```\n\n\u4f5c\u3089\u308c\u305f\u9375\u3092git\u306b\u30b3\u30df\u30c3\u30c8\u3055\u308c\u306a\u3044\u3088\u3046\u306b.gitignore\u306b\u8a18\u8f09\n\n```\nvi .gitignore\ndatabag_key\n```\n\n\uff08\u203b\u9375\u306f\u6848\u4ef6\u3054\u3068\u306b\u7570\u306a\u308b\u30a4\u30e1\u30fc\u30b8\u3067\u3001\u6d41\u51fa\u53b3\u7981\u304b\u3064\u7121\u304f\u3059\u3068\u30c7\u30fc\u30bf\u304c\u898b\u3048\u306a\u304f\u306a\u308a\u307e\u3059\u3002\uff09\n\n\n###  \uff12\uff0e\u6697\u53f7\u9375\u3092~/chefrepo/.chef/knife.rb\u306b\u8a2d\u5b9a\u3059\u308b\n\n```\nvi ~/chefrepo/.chef/knife.rb\n-----\nchef_repo = File.join(File.dirname(__FILE__), \"..\")\ncurrent_dir = File.dirname(__FILE__)\nlog_level                :info\nlog_location             STDOUT\nclient_key               \"#{current_dir}/dummy.pem\"\nvalidation_client_name   'chef-validator'\nvalidation_key           \"#{current_dir}/dummy.pem\"\ncookbook_path    [\"#{chef_repo}/cookbooks\", \"#{chef_repo}/site-cookbooks\"]\nnode_path        \"#{chef_repo}/nodes\"\nrole_path        \"#{chef_repo}/roles\"\nenvironment_path \"#{chef_repo}/environments\"\ndata_bag_path    \"#{chef_repo}/data_bags\"\nencrypted_data_bag_secret \"#{chef_repo}/databag_key\" ##\u2605\u3053\u3053\n\n#puts Chef::Config.inspect\n-----\n```\n\n###  \uff13\uff0e\u6697\u53f7\u5316\u3057\u306a\u3044\u30c7\u30fc\u30bf\u3092\u767b\u9332\u3059\u308b\n\nencrypted_data_bag_secret \u306b\u9375\u3092\u6307\u5b9a\u3057\u305f\u72b6\u614b\u3067knife solo data bag\u30b3\u30de\u30f3\u30c9\u3092\u4f7f\u3046\u3068\u30c7\u30fc\u30bf\u304c\u6697\u53f7\u5316\u3055\u308c\u3066\u767b\u9332\u3055\u308c\u307e\u3059\u3002\n\u306a\u306e\u3067\u6697\u53f7\u5316\u3057\u305f\u304f\u306a\u3044\u5834\u5408\u306fvi\u7b49\u306e\u901a\u5e38\u3064\u304b\u3063\u3066\u3044\u308b\u30a8\u30c7\u30a3\u30bf\u3067\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n```\nvi ~/chefrepo/data_bags/<bag-name>/<json-data-file-name>.json\nvi ~/chefrepo/data_bags/fluentd/loghost.json\n-------\n{\n  \"id\": \"loghost\",\n  \"loghost\": \"log.mng.local\",\n  \"key1\": \"value1\",\n  \"key2\": \"value2\"\n}\n-------\ncat ~/chefrepo/data_bags/fluentd/loghost.json |json_verify\n```\n\n\u3000\u203bjson\u30c7\u30fc\u30bf\u306e\u30b7\u30f3\u30bf\u30c3\u30af\u30b9\u30c1\u30a7\u30c3\u30af\u3092json_verify\u3084jsonlint\u306b\u6e21\u3059\u7b49\u3067\u5b9f\u65bd\u3059\u308b\u3068\u52b9\u7387\u304c\u826f\u3044\u3067\u3059\u3002\uff08\u6700\u7d42\u884c\u306e\u30ab\u30f3\u30de\u6709\u3068\u9014\u4e2d\u306e\u884c\u306e\u30ab\u30f3\u30de\u5fd8\u308c\u6ce8\u610f\uff09\n\u3000\u203bid\u304c\u6700\u3082\u91cd\u8981\u3067\u3001\u30ec\u30b7\u30d4\u5185\u90e8\u304b\u3089\u547c\u3073\u51fa\u3059\u6642\u306b\u306fid\u3092\u7528\u3044\u307e\u3059\uff08\u30b3\u30d4\u30fc\u3057\u305f\u5f8c\u306e\u4fee\u6b63\u6f0f\u308c\u306b\u6ce8\u610f\uff09\u3002\n\u3000\u3000\u3064\u307e\u308a\u30d5\u30a1\u30a4\u30eb\u540d\u3068id\u304c\u4e00\u81f4\u3057\u3066\u3044\u308b\u5fc5\u8981\u306f\u306a\u3055\u3052\u3067\u3059\u304c\u3001json\u30d5\u30a1\u30a4\u30eb\u540d\u3092id\u3068\u540c\u3058\u306b\u3059\u308b\u3068\u308f\u304b\u308a\u3084\u3059\u3044\u3067\u3059\u3002\n\n###  \uff14\uff0e\u6697\u53f7\u5316\u3057\u306a\u3044\u30c7\u30fc\u30bf\u3092\u53d6\u308a\u51fa\u3059\n\n```\nvi ~/chefrepo/site-cookbooks/<cookbook-name>/recipes/<recipe-name>.rb\n-------\nloghost = data_bag_item('fluentd',\"loghost\")['loghost']  ##\u2605data_bag_item('bag\u540d\u2252\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u540d',\"json\u30d5\u30a1\u30a4\u30eb\u5185id\u5024\")['\u30ad\u30fc\u5024']\nkey1 = data_bag_item('fluentd',\"loghost\")['key1']\ntemplate \"/etc/td-agent/extra/td-agent-syslog.conf\" do\n  action :create\n  source \"td-agent.conf.client-syslog.erb\"\n  notifies :restart, 'service[td-agent]'\n  variables ({\n   :loghost => loghost,   ##\u2605\u3053\u3053\u3067\u30cf\u30c3\u30b7\u30e5\u3068\u3057\u3066\u5b9a\u7fa9\u3057\u3066\u308b\u3002:template\u30d5\u30a1\u30a4\u30eb\u5185\u306e@\u5909\u6570 => recipe\u3067\u6307\u5b9a\u3057\u3066\u308b\u5909\u6570\u3000\n\u3000 :key1 => key1\n  })\nend\n-------\n\nvi ~/chefrepo/site-cookbooks/<cookbook-name>/templates/default/td-agent.conf.client-syslog.erb\n-------\n  <store>\n    type forward\n    heartbeat_type tcp\n    send_timeout 60s\n    flush_interval 1s\n    buffer_queue_limit 512\n    buffer_type file\n    buffer_path /var/tmp/fluent_buf\n    expire_dns_cache 10\n  <server>\n      host <%= @loghost %>  ##\u2605\u3053\u3053\u3067<%= @var %>\u3067\u6307\u5b9a\u3057\u305f\u5909\u6570\u306brecipe\u306etemplate\u30ea\u30bd\u30fc\u30b9\u306evariables\u3067\u6307\u5b9a\u3057\u305f\u5024\u304c\u5165\u308b\n      port 24224\n  </server>\n  </store>\n-------\n```\n\n\u3000\u203b\u5358\u72ec\u306ekey\u3092\u53d6\u308a\u51fa\u3057\u305f\u3044\u306e\u3067\u306a\u3051\u308c\u3070\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u66f8\u304d\u65b9\u304c\u3042\u308a\u307e\u3059\u3002\n\n```\nlogdata = data_bag_item('fluentd',\"#{account}_loghost\")\nloghost = logdata['loghost']\nkey1 = logdata['key1']\nkey2 = logdata['key2']\n```\n\n###  \uff15\uff0eknife\u3067\u6697\u53f7\u5316\u3059\u308b\u30c7\u30fc\u30bf\u3092\u767b\u9332\u3059\u308b\n\n\u3000\u30fbsolo\u3060\u3068knife solo data bag <subcommand> <bag-name> <id-name>\u3068\u3044\u3046\u611f\u3058\u3067\u3001\u30b5\u30d6\u30b3\u30de\u30f3\u30c9\u306f\u4ee5\u4e0b\u304c\u3042\u308b\n\n|Name|\u30b5\u30d6\u30b3\u30de\u30f3\u30c9\u89e3\u8aac|\n|:--|:--|\n|create|\u65b0\u898f\u4f5c\u6210\u3002\u65e2\u5b58\u306b\u3084\u308b\u3068\u4e0a\u66f8\u304d\u3055\u308c\u308b\u306e\u3067\u6ce8\u610f\u3002git checkout\u3067\u623b\u3057\u307e\u3057\u3087\u3046\u3002|\n|edit|\u7de8\u96c6\u3002\u65e2\u5b58\u30d5\u30a1\u30a4\u30eb\u3092\u7de8\u96c6\u3057\u305f\u3044\u3068\u304d\u306b\u3002\u65b0\u898f\u4f5c\u6210\u306f\u3067\u304d\u307e\u305b\u3093\u3002\u7de8\u96c6\u3057\u306a\u3044\u3067\u9589\u3058\u3066\u3082git\u7684\u306b\u306f\u66f4\u65b0\u3055\u308c\u3066\u308b\u98a8\u306b\u306a\u308b\u306e\u3067git checkout\u3067\u623b\u3057\u307e\u3057\u3087\u3046\u3002|\n|show|\u4e2d\u8eab\u3092\u307f\u305f\u3044\u3060\u3051\u306e\u3068\u304d\u306b\u8868\u793a\u3057\u3066\u304f\u308c\u308b\u3002json\u5f62\u5f0f\u3067\u306f\u306a\u3044\u3002|\n|list|bag\u306e\u30ea\u30b9\u30c8\u3092\u8868\u793a\u3057\u3066\u304f\u308c\u308b\u3060\u3051(data_bags\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u76f4\u4e0b\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u304c\u4e00\u89a7\u8868\u793a\u3055\u308c\u308b\u3060\u3051)|\n\n\n```\nknife solo data bag create fluentd loghost\nknife solo data bag edit fluentd loghost\nknife solo data bag show fluentd loghost\n```\n\n\u3000\u203bknife\u30b3\u30de\u30f3\u30c9\u4f7f\u3046\u5834\u5408\u306f\u30b7\u30f3\u30bf\u30c3\u30af\u30b9\u304c\u9593\u9055\u3063\u305f\u30c7\u30fc\u30bf\u3092\u767b\u9332\u3057\u305f\u307e\u307e\u30a8\u30c7\u30a3\u30bf\u3092\u9589\u3058\u3088\u3046\u3068\u3059\u308b\u3068\u30a8\u30e9\u30fc\u3067\u9589\u3058\u308c\u306a\u3044\u304b\u518d\u3073\u958b\u3044\u305f\u3068\u304d\u306b\u7a7a\u306b\u306a\u3063\u3066\u308b\u3068\u601d\u3044\u307e\u3059\u3002\n\n###  \uff16\uff0e\u6697\u53f7\u5316\u3059\u308b\u30c7\u30fc\u30bf\u3092\u53d6\u308a\u51fa\u3059\n\n\u66f8\u304d\u304b\u305f\u304c\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u5909\u308f\u308b\u3060\u3051\u3067\u3042\u3068\u306f\u540c\u3058\u3002\n\n```\nlogdata = data_bag_item('fluentd',\"#{account}_loghost\")\n\u3000\u2193\nlogdata = Chef::EncryptedDataBagItem.load('fluentd',\"#{account}_loghost\")\n```\n\n###  \uff17\uff0e1\u6b21\u5143\u306e\u914d\u5217\u30c7\u30fc\u30bf\u3092\u767b\u9332\u3059\u308b\n\nruby\u306b\u304a\u3051\u308b\u914d\u5217\u306f\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u5b9a\u7fa9\u3059\u308b\u3053\u3068\u304c\u53ef\u80fd\u3067\u3059\u3002\n\n```\narray = [\"var1\",\"var2\",\"var3\"]\narray = %w{\"var1\" \"var2\" \"var3\"}\n```\n\n\u914d\u5217\u3092\u521d\u671f\u5316\u3057\u305f\u5909\u6570\u3092\u30c7\u30d5\u30a9\u30eb\u30c8\u306eattribute\u3068\u3057\u3066\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u767b\u9332\u3057\u3066\u304a\u304b\u306a\u3044\u3068\u30a8\u30e9\u30fc\u306b\u306a\u308b\u5834\u5408\u304c\u3042\u308a\u307e\u3059\u3002(\u521d\u671f\u5316\u306e\u914d\u7f6e\u5834\u6240\u306f\u30ec\u30b7\u30d4\u5185\u3067\u3082attribute\u3067\u3082\u3069\u3063\u3061\u3067\u3082OK)\n\n```\narray = []\n```\n\n```\nvi ~/chefrepo/data_bags/awskeys/zabbix_all.json\n-------\n{\n  \"id\": \"zabbix-all\",\n  \"accounts\": [ \"hoge\", \"fuga\", \"piyo\" ]\n}\n-------\n```\n\n###  \uff18\uff0e1\u6b21\u5143\u306e\u914d\u5217\u30c7\u30fc\u30bf\u3092\u53d6\u308a\u51fa\u3059\n\n\u914d\u5217\u30c7\u30fc\u30bf\u306feach\u3067\u53d6\u308a\u51fa\u305b\u307e\u3059\u3002for\u3068each\u306f\u304a\u306a\u3058\u6a5f\u80fd\u306e\u30e1\u30bd\u30c3\u30c9\u3067\u3059(for\u306e\u5b9f\u4f53\u304ceach\u3060\u3063\u305f\u6c17\u304c\u3059\u308b)\u3002\n\n```\naccounts = key_data['accounts']\naccounts.each do |account|\n cron \"test_#{accounts}\" do\n    user \"root\"\n    command \"/bin/echo #{account} > /tmp/#{account}.txt 2>&1\"\n    hour \"*\"\n    minute \"0\"\n  end\nend\n```\n\n###  \uff19\uff0e\u914d\u5217\u3068\u30cf\u30c3\u30b7\u30e5\u306e\u5165\u308c\u5b50\u30c7\u30fc\u30bf\u3092\u767b\u9332\u3059\u308b\n\n\u7570\u306a\u308bkey=value\u306e\u96c6\u5408\u30c7\u30fc\u30bf\u3092\u30cf\u30c3\u30b7\u30e5\u3068\u3044\u3044\u307e\u3059\u3002\n\u30cf\u30c3\u30b7\u30e5\u306fruby\u3060\u3068\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u5b9a\u7fa9\u3067\u304d\u307e\u3059\u304c\u3001chef\u306eattribute\u7684\u306b\u306f\u3001{ \"key1\": \"var1\", \"key2\": \"var2\",, }\u3068\u3044\u3046\u611f\u3058\u3067\u3059\u3002\nhash = { \"key1\" => \"var1\", \"key2\" => \"var2\", \"key3\" => \"var3\" }\n\u4ee5\u4e0b\u306e\u4f8b\u3067\u306f\u914d\u5217\u306e\u4e2d\u306b\u30cf\u30c3\u30b7\u30e5\u304c\u5165\u3063\u3066\u3044\u307e\u3059\u3002\n\n```\nvi ~/chefrepo/data_bags/awskeys/zabbix_all.json\n-----------\n{\n  \"id\": \"zabbix-all\",\n  \"awskeys\": [\n    {\n      \"zabbix_account\": \"zabbix-prd\",\n      \"region\": \"us-**st-2\",\n      \"aws_access_key_id\": \"AKIA***************\",\n      \"aws_secret_access_key\": \"****************************************\"\n    },\n    {\n      \"zabbix_account\": \"zabbix-dev\",\n      \"region\": \"us-**st-2\",\n      \"aws_access_key_id\": \"AKIA*****************\",\n      \"aws_secret_access_key\": \"****************************************\"\n    }\n  ],\n  \"accounts\": [ \"hoge\", \"fuga\", \"piyo\" ]\n}\n-----------\n```\n\n###  \uff11\uff10\uff0e\u914d\u5217\u3068\u30cf\u30c3\u30b7\u30e5\u306e\u5165\u308c\u5b50\u30c7\u30fc\u30bf\u3092\u53d6\u308a\u51fa\u3059\n\n\u30fb\u307e\u3068\u3081\u3066\u3068\u308a\u3060\u3057\u3066for\u3067\u5168\u90e8\u306e\u30c7\u30fc\u30bf\u3092\u7f6e\u304f\u30d1\u30bf\u30fc\u30f3\n\u3000template\u30d5\u30a1\u30a4\u30eb\u5074\u306bfor\u30eb\u30fc\u30d7\u306e\u30e1\u30bd\u30c3\u30c9\u3092\u4ed5\u8fbc\u3093\u3067\u53d6\u308a\u51fa\u3057\u307e\u3059\u3002\n\n```\nvi ~/chefrepo/site-cookbooks/zabbix/recipes/cloudtrail.rb\n-----------\nawskeys = key_data['awskeys']\ntemplate \"/root/.aws/config\" do\n  source \"config_root.erb\"\n  mode 0700\n  owner \"root\"\n  group \"root\"\n  variables ({\n    :awskeys => awskeys\n  })\nend\n-----------\nvi ~/chefrepo/site-cookbooks/zabbix/templates/default/config_root.erb\n-----------\n<% for key in @awskeys %>\n[profile <%= key[\"zabbix_account\"] %>]\noutput=json\naws_access_key_id=<%= key[\"aws_access_key_id\"] %>\naws_secret_access_key=<%= key[\"aws_secret_access_key\"] %>\nregion=<%= key[\"region\"] %>\n\n<% end %>\n-----------\n```\n\n\u3000\u203btemplate\u30d5\u30a1\u30a4\u30eb\u5185\u3067\u306f<% %>\u5185\u306bruby\u306e\u30b3\u30fc\u30c9\u304c\u66f8\u3051\u307e\u3059\u3002\u3088\u3063\u3066if\u3068\u304belsif\u3068\u304b\u3082\u66f8\u3051\u307e\u3059\u3002\n\n\u30fb\u7279\u5b9a\u306e\u6587\u5b57\u5217\u306b\u4e00\u81f4\u3059\u308b\u5024\u3060\u3051\u53d6\u308a\u51fa\u3057\u305f\u3044\u30d1\u30bf\u30fc\u30f3(\u30ec\u30b7\u30d4\u629c\u7c8b\u4f8b\uff09\n\u3000\u3053\u3061\u3089\u306f\u30ec\u30b7\u30d4\u5074\u3067\u76ee\u7684\u306b\u3042\u3063\u305f\u30e1\u30bd\u30c3\u30c9\u3092\u7528\u3044\u3066\u5024\u3092\u6574\u3048\u3066\u53d6\u308a\u51fa\u3059\u5f62\u3067\u3059\u3002\n\n```\n  ## set client variables for secure_forward.\n  sfvariables = {}\n  fluentusers.each do |fluentuser|\n    if fluentuser.has_value?(\"#{account}\")         ##\u4e00\u81f4\u3059\u308b\u30a2\u30ab\u30a6\u30f3\u30c8\u304c\u542b\u307e\u308c\u3066\u3044\u308b\u30cf\u30c3\u30b7\u30e5\u306e\u5834\u5408\u3060\u3051\u3001\u3001\n      fluentuser.values_at(:username, :password)   ##\u6307\u5b9a\u3057\u305fkey\u3092\u62bd\u51fa\u3057\u305f\u30cf\u30c3\u30b7\u30e5\u30c7\u30fc\u30bf\u3092\u3082\u3068\u306e\u30cf\u30c3\u30b7\u30e5\u306b\u5165\u308c\u3066\u3001\n      sfvariables = fluentuser                     ##\u30d4\u30c3\u30af\u30a2\u30c3\u30d7\u3057\u305f\u5024\u3092\u65b0\u3057\u3044\u30cf\u30c3\u30b7\u30e5\u306b\u4ee3\u5165\n    end\n  end\n  sfvariables.merge! ({                            ##\u307b\u304b\u306e\u30cf\u30c3\u30b7\u30e5\u3068\u7d50\u5408\u3057\u305f\u304b\u3063\u305f\u3089\u3057\u3066!\u304c\u3064\u3044\u3066\u308b\u306e\u3067\u4e0a\u66f8\u304d\u3002\n        :shared_key => shared_key,\n        :sslcacrt => sslcacrtfile,\n        :servers => servers,\n  })\n  ## set client template for secure_forward.\n  template \"/etc/td-agent/extra/td-agent-#{ssl_conf}\" do\n    action :create\n    source \"td-agent.conf.server-#{ssl_conf}.erb\"\n    notifies :restart, 'service[td-agent]'\n    variables sfvariables                          ##template\u30ea\u30bd\u30fc\u30b9\u3067variables\u306b\u3055\u3063\u304d\u4f5c\u3063\u305f\u30cf\u30c3\u30b7\u30e5\u3092\u6307\u5b9a\u3057\u3066template\u30d5\u30a1\u30a4\u30eb\u5185\u306e@\u3068\u5dee\u3057\u66ff\u3048\u308b\u3002\n  end\n```\n\n###  \uff11\uff11\uff0e\u8a3c\u660e\u66f8\u3092\u767b\u9332\u3059\u308b\n\ncat\u3057\u3066perl\u3068\u304b\u3067\u672b\u5c3e\u306e\u6539\u884c\u3092\u6587\u5b57\u5217\u306b\u7f6e\u63db\u3057\u305f\u5024\u3092key\u306b\u5bfe\u3059\u308bvalue\u3068\u3057\u30661\u884c\u3067\u767b\u9332\u3059\u308b\u611f\u3058\u3067\u3059\u3002\u6697\u53f7\u5316\u5fc5\u9808\u3067\u3059\u3002\n\n```\ncat certdata.txt | perl -pe 's/\\n/\\\\n/g'\nknife solo data bag create certs mng-wildcard2\n{\n  \"id\": \"mng-wildcard2\",\n  \"crt\": \"\u3053\u3053\u306b1\u884c\u306b\u5909\u63db\u3057\u305f\u5024\u3092\u30b3\u30d4\u30da\",\n  \"key\": \"\u3053\u3053\u306b1\u884c\u306b\u5909\u63db\u3057\u305f\u5024\u3092\u30b3\u30d4\u30da\",\n  \"cacrt\": \"\u3053\u3053\u306b1\u884c\u306b\u5909\u63db\u3057\u305f\u5024\u3092\u30b3\u30d4\u30da\"\n}\n```\n\n###  \uff11\uff12\uff0e\u8a3c\u660e\u66f8\u3092\u53d6\u308a\u51fa\u3059\n\n\u30fbcerts\u306b\u6697\u53f7\u5316\u3055\u308c\u305f\u8a3c\u660e\u66f8\u672c\u4f53\u3092\u5165\u308c\u3066\u3001ssl\u3067\u305d\u306e\u8a3c\u660e\u66f8\u3092\u30dd\u30a4\u30f3\u30bf\u3057\u3066\u3001\n\u3000role\u305d\u306e\u305f\u306e\u30a2\u30c8\u30ea\u30d3\u30e5\u30fc\u30c8\u3067ssl\u5074\u306edata_bags\u540d\u3092\u6307\u5b9a\u3059\u308b\u307f\u305f\u3044\u306a\u30a4\u30e2\u30c5\u30eb\u65b9\u5f0f\u306b\u3057\u3066\u3044\u307e\u3059\u3002\n\u3000\u7406\u7531\u3068\u3057\u3066\u306f\u8a3c\u660e\u66f8\u81ea\u4f53\u306e\u66f4\u65b0\u4f5c\u696d\u306f\u30b7\u30f3\u30d7\u30eb\u306b\u3057\u305f\u3044\u9700\u8981\u304b\u3089\u3002\n\n```\n vi ~/chefrepo/site-cookbooks/nginx/recipes/nginx_ssl.rb\n---------------------\nenvironment = node.chef_environment\ndata_type = node['nginx']['data_type']\ndatafile = \"#{data_type}_#{environment}\"\n  sslclientconf_type = node['nginx']['sslclientconf_type']\n  sslkeydir = '/etc/nginx'\n  ssl_databag = data_bag_item(\"ssl\", \"#{datafile}\")\n\n  # SSL Server Certificate\n  sslcert_type = ssl_databag[\"cert-type\"]\n  servercerts_databag = Chef::EncryptedDataBagItem.load(\"certs\", \"#{sslcert_type}\")\n  sslkeyfile = \"#{sslcert_type}.key\"\n  sslcrtfile = \"#{sslcert_type}.crt\"\n  sslcrtdata = servercerts_databag[\"crt\"]\n  sslkeydata = servercerts_databag[\"key\"]\n\n  variables.merge!({\n    :sslcrt => sslcrtfile,\n    :sslkey => sslkeyfile\n  })\n\n  # SSL Server Certificate and Key\n  file \"#{sslkeydir}/#{sslcrtfile}\" do\n    notifies :restart, 'service[nginx]'\n    content  sslcrtdata\n  end\n\n  file \"#{sslkeydir}/#{sslkeyfile}\" do\n    notifies :restart, 'service[nginx]'\n    content sslkeydata\n  end\n---------------------\n```\n\n\u3000\u203bfile\u30ea\u30bd\u30fc\u30b9\u306econtent\u3092\u4f7f\u3046\u3068template\u304c\u8981\u3089\u306a\u3044\u306e\u3067\u7c21\u5358\u30b7\u30f3\u30d7\u30eb\u306b\u3002\n\u3000\u203b\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u8a3c\u660e\u66f8\u3092\u4f7f\u3046\u4f7f\u308f\u306a\u3044\u4ed6\u306e\u5206\u5c90\u304c\u5165\u308b\u3068\u4e0a\u8a18\u3088\u308a\u306ffor\u3068\u304bmerge!\u3068\u304b\u591a\u7528\u306b\u306a\u308b\u304b\u3082\u3002\n\n###  \uff11\uff13\uff0e\u53c2\u8003\u8cc7\u6599\n\n[template \u2014 Chef Docs](https://docs.chef.io/resource_template.html)\n[databags \u3092\u4f7f\u3063\u3066\u307f\u305f\u4e00\u90e8\u59cb\u7d42\uff081\uff09 - \u3088\u3046\u3078\u3044\u306e\u65e5\u3005\u7cbe\u9032](http://inokara.hateblo.jp/entry/2013/05/05/084251)\n[\u914d\u5217\u306e\u306a\u304b\u306b\u5165\u308c\u5b50\u306a\u8907\u6570\u306e\u30cf\u30c3\u30b7\u30e5\u306edata_bags\u306ejson\u3092chef\u3067\u6271\u3046\u30ec\u30b7\u30d4 - Qiita](http://qiita.com/smallpalace/private/66e80df6de693779c224)\n\n\n"}