{"tags": ["nginx", "nginx_lua_module", "proxy"], "context": " More than 1 year has passed since last update.Nginx\u3092\u4f7f\u3063\u3066\u3044\u3066\u3001proxy_pass\u306a\u3069\u3067IP\u30a2\u30c9\u30ec\u30b9\u3067\u306f\u306a\u304f\u30db\u30b9\u30c8\u540d\u3092\u5229\u7528\u3057\u305f\u3044\u5834\u5408\u306f\u3001\nlocation / {\n    resolver 192.168.0.2 valid=2s;//DNS\u30b5\u30fc\u30d0\u306eIP\n\n\u306e\u3088\u3046\u306b\u8a18\u8f09\u3059\u308b\u3068\u3001\u7121\u4e8b\u30db\u30b9\u30c8\u304b\u3089\u30a8\u30a4\u30ea\u30a2\u30b9\u3092\u5f15\u3044\u3066\u304f\u308c\u307e\u3059\u3002\nAWS\u4e0a\u3067VPC\u3092\u69cb\u7bc9\u3057\u3066\u304a\u308a\u3001Route53\u3092\u5229\u7528\u3057\u3066\u3044\u308b\u5834\u5408\u306f\u3001VPC\u306e\u30ed\u30fc\u30ab\u30eb\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u30a2\u30c9\u30ec\u30b9\u306e2\u756a\u76ee\u304c\u56fa\u5b9a\u3067\u8a2d\u5b9a\u3055\u308c\u3066\u3044\u308b\u306e\u3067\u3001\u300c10.xxx.xxx.2\u300d\u3084\u300c172.xxx.xxx.2\u300d\u306a\u3069\u6307\u5b9a\u3059\u308c\u3070\u3001Route53\u3092\u898b\u3066\u304f\u308c\u307e\u3059\u3002\n\nnginx_lua_module\u3092\u5229\u7528\u3057\u3066DB\u306b\u63a5\u7d9a\u3059\u308b\u5834\u5408\nOpenResty\u7b49\u3067\u3001nginx_lua_module\u3092\u5229\u7528\u3057\u5916\u90e8DB\u306a\u3069\u306b\u63a5\u7d9a\u3059\u308b\u5834\u5408\u306e\u30db\u30b9\u30c8\u540d\u3082\u540c\u69d8\u3067\u3059\u3002\n\u4f8b\u3048\u3070\u3001AWS\u4e0a\u306eVPC\u3067\u30d7\u30e9\u30a4\u30d9\u30fc\u30c8DNS\u3092Route53\u3067\u69cb\u7bc9\u3057\u3066\u3044\u308b\u5834\u5408\u3001\nlocation / {\n   resolver 192.168.0.2 valid=2s;\n   local mysql = require \"resty.mysql\"\n   local db, err = mysql:new()\n   if not db then\n      ngx.exit(ngx.HTTP_SERVICE_UNAVAILABLE)\n   end\n   local ok, err, errno, sqlstate = db:connect{\n      host = \"db.hogehoge.local\",\n         port = 3306,\n         database = \"aiueo\",\n         user = \"username\",\n         password = \"userpass\"\n   }\n\n\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306e\u30db\u30b9\u30c8\u306b\u30db\u30b9\u30c8\u540d\u3092\u4f7f\u3044\u305f\u3044\u5834\u5408\u306f\u3001resolver\u30c7\u30a3\u30ec\u30af\u30c6\u30a3\u30d6\u3092\u6307\u5b9a\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\nresolver\u3067\u6307\u5b9a\u3059\u308b\u5024\u306fIP\u30a2\u30c9\u30ec\u30b9\u3067\u3042\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\uff08\u591a\u5206\uff09\u3002\n\u3088\u308d\u3002\nNginx\u3092\u4f7f\u3063\u3066\u3044\u3066\u3001proxy_pass\u306a\u3069\u3067IP\u30a2\u30c9\u30ec\u30b9\u3067\u306f\u306a\u304f\u30db\u30b9\u30c8\u540d\u3092\u5229\u7528\u3057\u305f\u3044\u5834\u5408\u306f\u3001\n\n<pre>\nlocation / {\n    resolver 192.168.0.2 valid=2s;//DNS\u30b5\u30fc\u30d0\u306eIP\n</pre>\n\u306e\u3088\u3046\u306b\u8a18\u8f09\u3059\u308b\u3068\u3001\u7121\u4e8b\u30db\u30b9\u30c8\u304b\u3089\u30a8\u30a4\u30ea\u30a2\u30b9\u3092\u5f15\u3044\u3066\u304f\u308c\u307e\u3059\u3002\n\nAWS\u4e0a\u3067VPC\u3092\u69cb\u7bc9\u3057\u3066\u304a\u308a\u3001Route53\u3092\u5229\u7528\u3057\u3066\u3044\u308b\u5834\u5408\u306f\u3001VPC\u306e\u30ed\u30fc\u30ab\u30eb\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u30a2\u30c9\u30ec\u30b9\u306e2\u756a\u76ee\u304c\u56fa\u5b9a\u3067\u8a2d\u5b9a\u3055\u308c\u3066\u3044\u308b\u306e\u3067\u3001\u300c10.xxx.xxx.2\u300d\u3084\u300c172.xxx.xxx.2\u300d\u306a\u3069\u6307\u5b9a\u3059\u308c\u3070\u3001Route53\u3092\u898b\u3066\u304f\u308c\u307e\u3059\u3002\n\n##nginx_lua_module\u3092\u5229\u7528\u3057\u3066DB\u306b\u63a5\u7d9a\u3059\u308b\u5834\u5408\nOpenResty\u7b49\u3067\u3001nginx_lua_module\u3092\u5229\u7528\u3057\u5916\u90e8DB\u306a\u3069\u306b\u63a5\u7d9a\u3059\u308b\u5834\u5408\u306e\u30db\u30b9\u30c8\u540d\u3082\u540c\u69d8\u3067\u3059\u3002\n\n\u4f8b\u3048\u3070\u3001AWS\u4e0a\u306eVPC\u3067\u30d7\u30e9\u30a4\u30d9\u30fc\u30c8DNS\u3092Route53\u3067\u69cb\u7bc9\u3057\u3066\u3044\u308b\u5834\u5408\u3001\n\n<pre>\nlocation / {\n   resolver 192.168.0.2 valid=2s;\n   local mysql = require \"resty.mysql\"\n   local db, err = mysql:new()\n   if not db then\n      ngx.exit(ngx.HTTP_SERVICE_UNAVAILABLE)\n   end\n   local ok, err, errno, sqlstate = db:connect{\n      host = \"db.hogehoge.local\",\n         port = 3306,\n         database = \"aiueo\",\n         user = \"username\",\n         password = \"userpass\"\n   }\n</pre>\n\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306e\u30db\u30b9\u30c8\u306b\u30db\u30b9\u30c8\u540d\u3092\u4f7f\u3044\u305f\u3044\u5834\u5408\u306f\u3001resolver\u30c7\u30a3\u30ec\u30af\u30c6\u30a3\u30d6\u3092\u6307\u5b9a\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\n\nresolver\u3067\u6307\u5b9a\u3059\u308b\u5024\u306fIP\u30a2\u30c9\u30ec\u30b9\u3067\u3042\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\uff08\u591a\u5206\uff09\u3002\n\n\u3088\u308d\u3002\n"}