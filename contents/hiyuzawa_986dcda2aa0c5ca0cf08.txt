{"context": " More than 1 year has passed since last update.\u305d\u306e1\n\u305d\u306e2\n\u305d\u306e3\n\nnginx \u306e\u30c1\u30e5\u30fc\u30cb\u30f3\u30b0\n\n\u30d1\u30e9\u30e1\u30fc\u30bf\u8abf\u6574\n\u521d\u671f\u72b6\u614b\u306enginx\u306e\u30d1\u30e9\u30e1\u30fc\u30bf\u306f\u4ee5\u4e0b\u306e\u3068\u304a\u308a.\n# /etc/nginx/nginx.conf\nworker_processes  1;\n\nevents {\n  worker_connections  1024;\n}\n\n\u30d9\u30f3\u30c1\u30de\u30fc\u30af\u5b9f\u884c\u3068ReverseProxy\u3082\u540c\u4e00\u30b5\u30fc\u30d0\u3067\u7a3c\u50cd\u3059\u308b\u72b6\u614b\u3067\u30c1\u30e5\u30fc\u30cb\u30f3\u30b0\u304c\u3084\u308a\u306b\u304f\u3044\u3051\u3069\u3001\n\u3068\u308a\u3042\u3048\u305a\u3001CPU(m3.xlarge=4)\u306b\u5bfe\u3057\u3066\u8a2d\u5b9a\u5024\u3092\u5909\u66f4\u3057\u3066\u8abf\u6574\u3057\u3066\u307f\u308b\u3002\n# /etc/nginx/nginx.conf\nworker_processes  2;\nworker_rlimit_nofile 40000;\nevents {\n  worker_connections  10000;\n}\nhttp {\n  sendfile on;\n  tcp_nopush on;\n  ...\n\n\u30d7\u30ed\u30bb\u30b9\u5358\u4f4d\u306e\u30d5\u30a1\u30a4\u30eb\u30c7\u30a3\u30b9\u30af\u30ea\u30d7\u30bf\u306eOpen\u6570 (worker_rlimit_nofile) \u3092\u5927\u304d\u304f\u3057\u3068\u304f\n$ sudo service nginx restart\n\n$ cat /proc/2559/limits\nMax open files            40000                40000                files\n\n\nnginx \u3068 ReverseProxy\u9593\u3092Unix domain socket \u901a\u4fe1\u3078\u5909\u66f4\n# /etc/nginx/nginx.conf\n...\nhttp {\n  ...\n  upstream app_socket {\n    server unix:/var/log/nginx/starman.sock;\n  }\n  ...\n  server {\n     ...\n     location / {\n     proxy_pass http://app_socket;\n  }\n}\n\n#/etc/supervisord.conf\n...\n# command=/home/isucon/env.sh carton exec plackup -s Starman --host localhost:8080 -E prod app.psgi\ncommand=/home/isucon/env.sh carton exec plackup -s Starman --listen /var/log/nginx/starman.sock -E prod app.psgi\n...\n\n\u3053\u308c\u3067 nginx \u3068 Starman\u3092\u518d\u8d77\u52d5\u3057\u305f\u308d\u3053\u308d\u3001nginx\u304b\u3089socket\u30d5\u30a1\u30a4\u30eb\u306e\u30a2\u30af\u30bb\u30b9\u3067permission denied\u304c\u3067\u305f\u3002\nnginx \u3092 user isucon; \u3067\u8d77\u52d5\u3057\u305f\u3089\u6b63\u5e38\u306b\u30a2\u30af\u30bb\u30b9\u3067\u304d\u305f\u306e\u3067\u3068\u308a\u3042\u3048\u305a\u305d\u3046\u3057\u3066\u304a\u304f\u3002\n\n\u3042\u3089\u3081\u3066\u30d9\u30f3\u30c1\u30de\u30fc\u30af\n$  ./benchmarker bench --workload 10\n14:10:18 type:info      message:launch benchmarker\n14:10:18 type:warning   message:Result not sent to server because API key is not set\n14:10:18 type:info      message:init environment\n14:10:35 type:info      message:run benchmark workload: 10\n14:11:36 type:info      message:finish benchmark workload: 10\n14:11:41 type:info      message:check banned ips and locked users report\n14:11:43 type:report    count:banned ips        value:642\n14:11:43 type:report    count:locked users      value:4299\n14:11:43 type:info      message:Result not sent to server because API key is not set\n14:11:43 type:score     success:179350  fail:0  score:38744\n\n38774\u70b9 \n\nMySQL\u306e\u30c1\u30e5\u30fc\u30cb\u30f3\u30b0\n\u30c1\u30e5\u30fc\u30cb\u30f3\u30b0\u3068\u3044\u3046\u304b\u3001\u3053\u308c\u3050\u3089\u3044\u306e\u5229\u7528\u3060\u3068MyISAM\u3067\u3044\u3044\u3093\u3058\u3083\u306d\uff1f\u3068\u3044\u3046\u3053\u3068\u3067\u305d\u3046\u3057\u3066\u307f\u308b\n#sql/schema.sql\nCREATE TABLE IF NOT EXISTS `users` (\n...\n) DEFAULT CHARSET=utf8, ENGINE=myisam;\n\nCREATE TABLE IF NOT EXISTS `login_log` (\n...\n) DEFAULT CHARSET=utf8, ENGINE=myisam;\n\n\u3053\u308c\u3067\u30d9\u30f3\u30c1\u30de\u30fc\u30af\n14:40:35 type:score     success:183000  fail:0  score:39533\n\n39533\u70b9\n\u3068\u308a\u3042\u3048\u305a\u30d2\u30ab\u30ea\u30a8\u30ec\u30d9\u30eb\u307e\u3067\u9054\u3057\u305f\u3002\nhttp://isucon.net/archives/40576269.html\n\n[\u305d\u306e1](http://qiita.com/hiyuzawa/items/dfeb4362916732f4d067)\n[\u305d\u306e2](http://qiita.com/hiyuzawa/items/f67711458887a1b7137c)\n[\u305d\u306e3](http://qiita.com/hiyuzawa/items/039c3905fa384a06c1c4)\n\n## nginx \u306e\u30c1\u30e5\u30fc\u30cb\u30f3\u30b0\n\n### \u30d1\u30e9\u30e1\u30fc\u30bf\u8abf\u6574\n\n\u521d\u671f\u72b6\u614b\u306enginx\u306e\u30d1\u30e9\u30e1\u30fc\u30bf\u306f\u4ee5\u4e0b\u306e\u3068\u304a\u308a.\n\n```bash\n# /etc/nginx/nginx.conf\nworker_processes  1;\n\nevents {\n  worker_connections  1024;\n}\n```\n\n\n\u30d9\u30f3\u30c1\u30de\u30fc\u30af\u5b9f\u884c\u3068ReverseProxy\u3082\u540c\u4e00\u30b5\u30fc\u30d0\u3067\u7a3c\u50cd\u3059\u308b\u72b6\u614b\u3067\u30c1\u30e5\u30fc\u30cb\u30f3\u30b0\u304c\u3084\u308a\u306b\u304f\u3044\u3051\u3069\u3001\n\u3068\u308a\u3042\u3048\u305a\u3001CPU(m3.xlarge=4)\u306b\u5bfe\u3057\u3066\u8a2d\u5b9a\u5024\u3092\u5909\u66f4\u3057\u3066\u8abf\u6574\u3057\u3066\u307f\u308b\u3002\n\n```bash\n# /etc/nginx/nginx.conf\nworker_processes  2;\nworker_rlimit_nofile 40000;\nevents {\n  worker_connections  10000;\n}\nhttp {\n  sendfile on;\n  tcp_nopush on;\n  ...\n```\n\n\u30d7\u30ed\u30bb\u30b9\u5358\u4f4d\u306e\u30d5\u30a1\u30a4\u30eb\u30c7\u30a3\u30b9\u30af\u30ea\u30d7\u30bf\u306eOpen\u6570 (worker_rlimit_nofile) \u3092\u5927\u304d\u304f\u3057\u3068\u304f\n\n```bash\n$ sudo service nginx restart\n```\n\n```bash\n$ cat /proc/2559/limits\nMax open files            40000                40000                files\n```\n\n### nginx \u3068 ReverseProxy\u9593\u3092Unix domain socket \u901a\u4fe1\u3078\u5909\u66f4\n\n```bash\n# /etc/nginx/nginx.conf\n...\nhttp {\n  ...\n  upstream app_socket {\n    server unix:/var/log/nginx/starman.sock;\n  }\n  ...\n  server {\n     ...\n     location / {\n     proxy_pass http://app_socket;\n  }\n}\n```\n\n```bash\n#/etc/supervisord.conf\n...\n# command=/home/isucon/env.sh carton exec plackup -s Starman --host localhost:8080 -E prod app.psgi\ncommand=/home/isucon/env.sh carton exec plackup -s Starman --listen /var/log/nginx/starman.sock -E prod app.psgi\n...\n```\n\n\u3053\u308c\u3067 nginx \u3068 Starman\u3092\u518d\u8d77\u52d5\u3057\u305f\u308d\u3053\u308d\u3001nginx\u304b\u3089socket\u30d5\u30a1\u30a4\u30eb\u306e\u30a2\u30af\u30bb\u30b9\u3067permission denied\u304c\u3067\u305f\u3002\nnginx \u3092 user isucon; \u3067\u8d77\u52d5\u3057\u305f\u3089\u6b63\u5e38\u306b\u30a2\u30af\u30bb\u30b9\u3067\u304d\u305f\u306e\u3067\u3068\u308a\u3042\u3048\u305a\u305d\u3046\u3057\u3066\u304a\u304f\u3002\n\n## \u3042\u3089\u3081\u3066\u30d9\u30f3\u30c1\u30de\u30fc\u30af\n\n```\n$  ./benchmarker bench --workload 10\n14:10:18 type:info      message:launch benchmarker\n14:10:18 type:warning   message:Result not sent to server because API key is not set\n14:10:18 type:info      message:init environment\n14:10:35 type:info      message:run benchmark workload: 10\n14:11:36 type:info      message:finish benchmark workload: 10\n14:11:41 type:info      message:check banned ips and locked users report\n14:11:43 type:report    count:banned ips        value:642\n14:11:43 type:report    count:locked users      value:4299\n14:11:43 type:info      message:Result not sent to server because API key is not set\n14:11:43 type:score     success:179350  fail:0  score:38744\n```\n38774\u70b9 \n\n## MySQL\u306e\u30c1\u30e5\u30fc\u30cb\u30f3\u30b0\n\n\u30c1\u30e5\u30fc\u30cb\u30f3\u30b0\u3068\u3044\u3046\u304b\u3001\u3053\u308c\u3050\u3089\u3044\u306e\u5229\u7528\u3060\u3068MyISAM\u3067\u3044\u3044\u3093\u3058\u3083\u306d\uff1f\u3068\u3044\u3046\u3053\u3068\u3067\u305d\u3046\u3057\u3066\u307f\u308b\n\n```bash\n#sql/schema.sql\nCREATE TABLE IF NOT EXISTS `users` (\n...\n) DEFAULT CHARSET=utf8, ENGINE=myisam;\n\nCREATE TABLE IF NOT EXISTS `login_log` (\n...\n) DEFAULT CHARSET=utf8, ENGINE=myisam;\n```\n\n\u3053\u308c\u3067\u30d9\u30f3\u30c1\u30de\u30fc\u30af\n\n```\n14:40:35 type:score     success:183000  fail:0  score:39533\n```\n\n39533\u70b9\n\u3068\u308a\u3042\u3048\u305a\u30d2\u30ab\u30ea\u30a8\u30ec\u30d9\u30eb\u307e\u3067\u9054\u3057\u305f\u3002\nhttp://isucon.net/archives/40576269.html\n", "tags": ["isucon"]}