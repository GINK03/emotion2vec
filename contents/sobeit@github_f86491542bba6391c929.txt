{"context": " More than 1 year has passed since last update.\n\nSails\u3068Passport\u3067OAuth\u8a8d\u53ef\u3059\u308b\n\n\u203b\u8ffd\u8a18\uff1a\u5229\u7528\u30d0\u30fc\u30b8\u30e7\u30f3\u3092\u66f8\u304d\u5fd8\u308c\u3066\u3044\u305f\u306e\u3067\u8ffd\u8a18\n\n\u30d0\u30fc\u30b8\u30e7\u30f3\n*Sails v0.9.9\n*Passport.js v0.2.0\n*passport-google-oauth v0.1.5\n\n\u3053\u3053\u3067\u306fGoogle\u306eAPI\u3092\u4f7f\u3063\u3066OAuth\u3057\u3066\u307f\u308b\u3002\u30d7\u30ed\u30c8\u30b3\u30eb\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u306fOAuth2.0\u3002Passport\u306e\u30b9\u30c8\u30ec\u30c6\u30b8\u306fpassport-google-oauth\u3067OAuth2Strategy\u3092\u4f7f\u3046\u3002\n\n\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\n\nAuthController.js\n/**\n * AuthController\n *\n * @module      :: Controller\n * @description :: A set of functions called `actions`.\n *\n *                 Actions contain code telling Sails how to respond to a certain type of request.\n *                 (i.e. do stuff, then send some JSON, show an HTML page, or redirect to another URL)\n *\n *                 You can configure the blueprint URLs which trigger these actions (`config/controllers.js`)\n *                 and/or override them with custom routes (`config/routes.js`)\n *\n *                 NOTE: The code you write here supports both HTTP and Socket.io automatically.\n *\n * @docs        :: http://sailsjs.org/#!documentation/controllers\n */\nvar passport = require('passport');\nmodule.exports = {\n  login: function(req,res){\n    res.view();\n  },\n  authenticate: function(req,res){\n    passport.authenticate('google',{scope:['https://www.googleapis.com/auth/userinfo.profile']})(req,res);\n  },\n  authcallback: function(req,res){\n    passport.authenticate('google', {failureRedirect: 'login',successRedirect:'/message/success'})(req,res);\n  },\n  logout: function(req,res){\n    req.logout();\n    res.send('logout');\n  },\n  /**\n   * Overrides for the settings in `config/controllers.js`\n   * (specific to AuthController)\n   */\n  _config: {}\n};\n\n\nlogin\u304b\u3089authenticate\u3092\u547c\u51fa\u3057\u3001Google\u306e\u8a8d\u53ef\u30d5\u30ed\u30fc\u306b\u30ea\u30c0\u30a4\u30ec\u30af\u30c8\u5f8c\u3001authcallback\u306b\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u3055\u308c\u3066\u623b\u3063\u3066\u304f\u308b\u3002\n\napi/services/passport.js\n\npassport.js\n// api/services/passport.js\n// This code is a little dirty. TODO: refactor this code for easy to read.\n\nvar passport = require('passport'),\nGoogleStrategy = require('passport-google-oauth').OAuth2Strategy;\n\npassport.serializeUser(function (user, done) {\n  done(null, user.userId);\n});\n\npassport.deserializeUser(function (id, done) {\n  User.findOne({userId:id}).done(function(err, user){\n    if(err){\n      done(null,null);\n    } else {\n      done(null,user);\n    }\n  });\n});\npassport.use(new GoogleStrategy({\n           clientID:\"\",\n           clientSecret: \"\",\n               callbackURL: \"http://localhost:1337/auth/authcallback\"\n            },\n            function(accessToken,regreshToken,profile,done) {\n           process.nextTick(function(){\n               User.findOne({userId:profile.id}).done(function(err, user){\n                   if(err){\n                                     return done(null,err);\n                                   } else {\n                                     if(!user){\n                                       User.create({userId:profile.id, userName:profile.name}).done(\n                                                    function(err,createUser){\n                                                       if(err){\n                                                         return done(null,err);\n                                                       } else {\n                             return done(null,createUser);\n                               }\n                                                    });\n                                     } else {\n                       return done(null,user);\n                     }\n                                   }\n                });\n               });\n}));\n\n\n\u8a8d\u53ef\u5f8c\u306e\u51e6\u7406\u3092\u542b\u3080\u30d5\u30ed\u30fc\u3002\u30bb\u30c3\u30b7\u30e7\u30f3\u306e\u30c7\u30fc\u30bf\u306e\u30b7\u30ea\u30a2\u30e9\u30a4\u30ba\u3068\u30c7\u30b7\u30ea\u30a2\u30e9\u30a4\u30ba\u3082\u3053\u3053\u306b\u8a18\u8ff0\u3002\u65b0\u3057\u3044\u30e6\u30fc\u30b6\u306a\u3089\u30e6\u30fc\u30b6\u60c5\u5831\u3092\u30ed\u30fc\u30ab\u30eb\u306eDB\u306b\u3082\u4fdd\u5b58\u3059\u308b\u3002\n\nconfig/config_passport.js\n\nconfig_passport.js\n// config/passport.js\n// initialize passport as middleware\n\nvar passport = require('passport'),\nGoogleStrategy = require('passport-google-oauth').OAuth2Strategy;\n\nmodule.exports = {\n  express: {\n    customMiddleware: function(app) {\n      app.use(passport.initialize());\n      app.use(passport.session());\n    }\n  }\n};\n\n\nmidlleware\u3068\u3057\u3066initialize\u3059\u308b\u305f\u3081\u306e\u8a18\u8ff0\u3002Sails\u306e\u30a2\u30d7\u30ea\u8d77\u52d5\u6642\u306b\u547c\u3073\u51fa\u3055\u308c\u3066\u521d\u671f\u5316\u3055\u308c\u308b\u3002\n\nviews/auth/login.ejs\n\nlogin.ejs\n// views/auth/login.ejs\n<h2>Google Login</h2>\n<form action=\"/auth/authenticate\" method=\"post\">\n<div><input type=\"submit\"></div>\n</form>\n\n\nauthenticate\u3092\u547c\u3073\u51fa\u3057\u3066\u3044\u308b\u3060\u3051\u3002\n\u3042\u3068\u306f\u5fc5\u8981\u306b\u5fdc\u3058\u3066policies.js\u3067\u8a8d\u53ef\u524d\u30a2\u30af\u30bb\u30b9\u306e\u5236\u5fa1\uff08AuthController\u306e\u30e1\u30bd\u30c3\u30c9\u306f\u8a8d\u53ef\u524d\u3067\u3082\u30a2\u30af\u30bb\u30b9\u53ef\u306b\u3057\u3066\u304a\u304f\uff09\u3068api/policies\u5185\u306b\u914d\u7f6e\u3059\u308b\u30b3\u30fc\u30c9\u3067\u8a8d\u53ef\u524d\u8a8d\u53ef\u5f8c\u306e\u30bb\u30c3\u30b7\u30e7\u30f3\u306e\u30c1\u30a7\u30c3\u30af\u306e\u30b3\u30fc\u30c9\u3092\u8ffd\u8a18\u3059\u308b\u3002\n##Sails\u3068Passport\u3067OAuth\u8a8d\u53ef\u3059\u308b\n***\n**\u203b\u8ffd\u8a18\uff1a\u5229\u7528\u30d0\u30fc\u30b8\u30e7\u30f3\u3092\u66f8\u304d\u5fd8\u308c\u3066\u3044\u305f\u306e\u3067\u8ffd\u8a18**\n###\u30d0\u30fc\u30b8\u30e7\u30f3\n*Sails v0.9.9\n*Passport.js v0.2.0\n*passport-google-oauth v0.1.5\n***\n\u3053\u3053\u3067\u306fGoogle\u306eAPI\u3092\u4f7f\u3063\u3066OAuth\u3057\u3066\u307f\u308b\u3002\u30d7\u30ed\u30c8\u30b3\u30eb\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u306fOAuth2.0\u3002Passport\u306e\u30b9\u30c8\u30ec\u30c6\u30b8\u306fpassport-google-oauth\u3067OAuth2Strategy\u3092\u4f7f\u3046\u3002\n\n###\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\n```js:AuthController.js\n/**\n * AuthController\n *\n * @module      :: Controller\n * @description\t:: A set of functions called `actions`.\n *\n *                 Actions contain code telling Sails how to respond to a certain type of request.\n *                 (i.e. do stuff, then send some JSON, show an HTML page, or redirect to another URL)\n *\n *                 You can configure the blueprint URLs which trigger these actions (`config/controllers.js`)\n *                 and/or override them with custom routes (`config/routes.js`)\n *\n *                 NOTE: The code you write here supports both HTTP and Socket.io automatically.\n *\n * @docs        :: http://sailsjs.org/#!documentation/controllers\n */\nvar passport = require('passport');\nmodule.exports = {\n  login: function(req,res){\n    res.view();\n  },\n  authenticate: function(req,res){\n    passport.authenticate('google',{scope:['https://www.googleapis.com/auth/userinfo.profile']})(req,res);\n  },\n  authcallback: function(req,res){\n    passport.authenticate('google', {failureRedirect: 'login',successRedirect:'/message/success'})(req,res);\n  },\n  logout: function(req,res){\n    req.logout();\n    res.send('logout');\n  },\n  /**\n   * Overrides for the settings in `config/controllers.js`\n   * (specific to AuthController)\n   */\n  _config: {}\n};\n```\nlogin\u304b\u3089authenticate\u3092\u547c\u51fa\u3057\u3001Google\u306e\u8a8d\u53ef\u30d5\u30ed\u30fc\u306b\u30ea\u30c0\u30a4\u30ec\u30af\u30c8\u5f8c\u3001authcallback\u306b\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u3055\u308c\u3066\u623b\u3063\u3066\u304f\u308b\u3002\n\n###api/services/passport.js\n```js:passport.js\n// api/services/passport.js\n// This code is a little dirty. TODO: refactor this code for easy to read.\n \nvar passport = require('passport'),\nGoogleStrategy = require('passport-google-oauth').OAuth2Strategy;\n \npassport.serializeUser(function (user, done) {\n  done(null, user.userId);\n});\n \npassport.deserializeUser(function (id, done) {\n  User.findOne({userId:id}).done(function(err, user){\n    if(err){\n      done(null,null);\n    } else {\n      done(null,user);\n    }\n  });\n});\npassport.use(new GoogleStrategy({\n\t       clientID:\"\",\n\t       clientSecret: \"\",\n               callbackURL: \"http://localhost:1337/auth/authcallback\"\n            },\n            function(accessToken,regreshToken,profile,done) {\n\t       process.nextTick(function(){\n\t           User.findOne({userId:profile.id}).done(function(err, user){\n\t\t\t\t   if(err){\n                                     return done(null,err);\n                                   } else {\n                                     if(!user){\n                                       User.create({userId:profile.id, userName:profile.name}).done(\n                                                    function(err,createUser){\n                                                       if(err){\n                                                         return done(null,err);\n                                                       } else {\n\t\t\t\t\t\t\t return done(null,createUser);\n\t\t\t\t\t\t       }\n                                                    });\n                                     } else {\n\t\t\t\t       return done(null,user);\n\t\t\t\t     }\n                                   }\n\t\t\t\t});\n               });\n}));\n```\n\u8a8d\u53ef\u5f8c\u306e\u51e6\u7406\u3092\u542b\u3080\u30d5\u30ed\u30fc\u3002\u30bb\u30c3\u30b7\u30e7\u30f3\u306e\u30c7\u30fc\u30bf\u306e\u30b7\u30ea\u30a2\u30e9\u30a4\u30ba\u3068\u30c7\u30b7\u30ea\u30a2\u30e9\u30a4\u30ba\u3082\u3053\u3053\u306b\u8a18\u8ff0\u3002\u65b0\u3057\u3044\u30e6\u30fc\u30b6\u306a\u3089\u30e6\u30fc\u30b6\u60c5\u5831\u3092\u30ed\u30fc\u30ab\u30eb\u306eDB\u306b\u3082\u4fdd\u5b58\u3059\u308b\u3002\n\n###config/config_passport.js\n```js:config_passport.js\n// config/passport.js\n// initialize passport as middleware\n \nvar passport = require('passport'),\nGoogleStrategy = require('passport-google-oauth').OAuth2Strategy;\n \nmodule.exports = {\n  express: {\n    customMiddleware: function(app) {\n      app.use(passport.initialize());\n      app.use(passport.session());\n    }\n  }\n};\n```\nmidlleware\u3068\u3057\u3066initialize\u3059\u308b\u305f\u3081\u306e\u8a18\u8ff0\u3002Sails\u306e\u30a2\u30d7\u30ea\u8d77\u52d5\u6642\u306b\u547c\u3073\u51fa\u3055\u308c\u3066\u521d\u671f\u5316\u3055\u308c\u308b\u3002\n\n###views/auth/login.ejs\n```html:login.ejs\n// views/auth/login.ejs\n<h2>Google Login</h2>\n<form action=\"/auth/authenticate\" method=\"post\">\n<div><input type=\"submit\"></div>\n</form>\n```\nauthenticate\u3092\u547c\u3073\u51fa\u3057\u3066\u3044\u308b\u3060\u3051\u3002\n\n\u3042\u3068\u306f\u5fc5\u8981\u306b\u5fdc\u3058\u3066policies.js\u3067\u8a8d\u53ef\u524d\u30a2\u30af\u30bb\u30b9\u306e\u5236\u5fa1\uff08AuthController\u306e\u30e1\u30bd\u30c3\u30c9\u306f\u8a8d\u53ef\u524d\u3067\u3082\u30a2\u30af\u30bb\u30b9\u53ef\u306b\u3057\u3066\u304a\u304f\uff09\u3068api/policies\u5185\u306b\u914d\u7f6e\u3059\u308b\u30b3\u30fc\u30c9\u3067\u8a8d\u53ef\u524d\u8a8d\u53ef\u5f8c\u306e\u30bb\u30c3\u30b7\u30e7\u30f3\u306e\u30c1\u30a7\u30c3\u30af\u306e\u30b3\u30fc\u30c9\u3092\u8ffd\u8a18\u3059\u308b\u3002\n", "tags": ["JavaScript", "Node.js", "Sails.js"]}