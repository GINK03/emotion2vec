{"tags": ["docker1.6.0", "Ubuntu14.04", "etcd2.0.4", "flannel0.3.1"], "context": " More than 1 year has passed since last update.\u30de\u30eb\u30c1\u30db\u30b9\u30c8\u3067\u52d5\u4f5c\u3059\u308bDocker\u30cd\u30c3\u30c8\u30ef\u30fc\u30ad\u30f3\u30b0\u30c4\u30fc\u30eb\u306b\u3064\u3044\u3066\u306e\u307e\u3068\u3081\u7b2c\u4e8c\u6bb5\u3002\n\uff08\u7b2c\u4e00\u5f3e\uff1apipework\uff0bGRE\uff09\n\uff08\u7b2c\u4e09\u5f3e\uff1aweave\uff09\n\u4eca\u56de\u306fcoreos/flannel\u3092\u53d6\u308a\u4e0a\u3052\u308b\u3002\n\n\u691c\u8a3c\u74b0\u5883\nSoftLayer\u306b\u4ee5\u4e0b\u306eVirtual Server\u3092\u7acb\u3061\u4e0a\u3052\u3066\u691c\u8a3c\u3057\u305f\u3002\n\n\n\n\nDC\nhostname\nprivate IP(eth0)\npublic IP(eth1)\n\n\n\n\n\u30db\u30b9\u30c81\nDallas 9\nflannel01\n10.142.51.197\nX.X.X.X\n\n\n\u30db\u30b9\u30c82\nDallas 9\nflannel02\n10.142.51.198\nY.Y.Y.Y\n\n\n\u30db\u30b9\u30c83\nDallas 6\nflannel03\n10.106.91.131\nZ.Z.Z.Z\n\n\n\n\u30db\u30b9\u30c81\u3068\u30db\u30b9\u30c82\u306f\u540c\u4e00VLAN\u4e0a\u306b\u3042\u308a\u3001\u30db\u30b9\u30c83\u306f\u5225VLAN\u4e0a\u3067\u30db\u30b9\u30c81,2\u3068L3\u3067\u63a5\u7d9a\u3055\u308c\u3066\u3044\u308b\u3002\n\u5404\u7a2e\u30d0\u30fc\u30b8\u30e7\u30f3\u306f\u4ee5\u4e0b\u306e\u901a\u308a\u3002\n\n\n\n\nversion\n\n\n\n\ndistribution\nUbuntu 14.04.2 LTS\n\n\nkernel\n3.13.0-48-generic\n\n\ndocker\n1.6.0\n\n\netcd\n2.0.4+git\n\n\nflannel\n0.3.1+git\n\n\n\n\n\u6e96\u5099\n\u3059\u3079\u3066\u306e\u30db\u30b9\u30c8\u3067\u4ee5\u4e0b\u306e\u4f5c\u696d\u3092\u5b9f\u65bd\u3059\u308b\u3002\n\n\u5fc5\u8981\u30d1\u30c3\u30b1\u30fc\u30b8\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\nroot@flannel01:~# apt-get update\nroot@flannel01:~# apt-get upgrade -y\nroot@flannel01:~# apt-get install build-essential linux-libc-dev bridge-utils git curl -y\n\n\n\ngolang\u3068docker\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\nroot@flannel01:~# wget -O - https://storage.googleapis.com/golang/go1.4.2.linux-amd64.tar.gz | tar -C /usr/local -vxzf -\nroot@flannel01:~# echo 'export PATH=$PATH:/usr/local/go/bin' >> /etc/profile\nroot@flannel01:~# source /etc/profile\nroot@flannel01:~# wget -qO- https://get.docker.com/ | sh\n\n\n\netcd\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\nroot@flannel01:~# git clone https://github.com/coreos/etcd.git /opt/coreos/etcd\nroot@flannel01:~# cd /opt/coreos/etcd\nroot@flannel01:/opt/coreos/etcd# ./build\nroot@flannel01:/opt/coreos/etcd# ln -s /opt/coreos/etcd/bin/etcd /usr/local/bin/etcd\nroot@flannel01:/opt/coreos/etcd# ln -s /opt/coreos/etcd/bin/etcdctl /usr/local/bin/etcdctl\n\n\n\nflannel\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\nroot@flannel01:~# git clone https://github.com/coreos/flannel.git /opt/coreos/flannel\nroot@flannel01:~# cd /opt/coreos/flannel \nroot@flannel01:/opt/coreos/flannel# ./build\nroot@flannel01:/opt/coreos/flannel# ln -s /opt/coreos/flannel/bin/flanneld /usr/local/bin/flanneld\n\n\n\netcd\u30af\u30e9\u30b9\u30bf\u306e\u69cb\u7bc9\n\u307e\u305a\u306f\u4ee5\u4e0b\u306e\u624b\u9806\u3092\u53c2\u8003\u306b\u3001\u5168\u3066\u306e\u30db\u30b9\u30c8\u304c\u53c2\u52a0\u3059\u308betcd\u30af\u30e9\u30b9\u30bf\u3092\u69cb\u7bc9\u3059\u308b\u3002\nhttps://github.com/coreos/etcd/blob/master/Documentation/clustering.md\netcd\u30af\u30e9\u30b9\u30bf\u306e\u8d77\u52d5\u306f\u30aa\u30d7\u30b7\u30e7\u30f3\u304c\u7169\u96d1\u306a\u306e\u3067\u3001bash\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u4f5c\u308b\u3002\n\nstart-etcd.sh\n#!/bin/bash\n\nif [ $# -ne 1 ]; then\n  echo \"usage: $0 nodename\"\n  exit 1\nfi\n\ndeclare -A NODES\n\nNODES[\"flannel1\"]=\"http://10.142.51.197:2380\"\nNODES[\"flannel2\"]=\"http://10.142.51.198:2380\"\nNODES[\"flannel3\"]=\"http://10.106.91.131:2380\"\n\nTOKEN=\"flannel-cluster\"\n\nif [[ \"${NODES[$1]+_}\" != \"_\" ]]; then\n  echo \"invalid nodename\"\n  exit 1\nelse\n  NAME=$1\nfi\n\nCLUSTER=\"\"\n\nfor i in ${!NODES[@]}; do\n  if [ -n \"$CLUSTER\" ]; then\n    CLUSTER=$CLUSTER\",\"\n  fi\n  CLUSTER=$CLUSTER${i}=${NODES[$i]}\ndone\n\nset -x\n\n/usr/local/bin/etcd -name $NAME \\\n  -initial-advertise-peer-urls ${NODES[$NAME]} \\\n  -listen-peer-urls ${NODES[$NAME]} \\\n  -initial-cluster-token $TOKEN \\\n  -initial-cluster $CLUSTER \\\n  -initial-cluster-state new \\\n  > /var/log/etcd.log 2>&1 &\n\n\n\n\n\u30db\u30b9\u30c8\uff11\n\netcd\u306e\u8d77\u52d5\nroot@flannel01:~# ./start-etcd.sh flannel1\nroot@flannel01:~# ps aux | grep etcd\nroot     12199  0.8  1.9  32436 19968 pts/0    Sl   01:13   0:03 /usr/local/bin/etcd -name flannel1 -initial-advertise-peer-urls http://10.142.51.197:2380 -listen-peer-urls http://10.142.51.197:2380 -initial-cluster-token flannel-cluster -initial-cluster flannel1=http://10.142.51.197:2380,flannel2=http://10.142.51.198:2380,flannel3=http://10.106.91.131:2380 -initial-cluster-state new\n\n\n\n\u30db\u30b9\u30c8\uff12\n\netcd\u306e\u8d77\u52d5\nroot@flannel02:~# ./start-etcd.sh flannel2\nroot@flannel02:~# ps aux | grep etcd\nroot     10218  0.4  1.2  26988 12772 pts/0    Sl   01:17   0:00 /usr/local/bin/etcd -name flannel2 -initial-advertise-peer-urls http://10.142.51.198:2380 -listen-peer-urls http://10.142.51.198:2380 -initial-cluster-token flannel-cluster -initial-cluster flannel1=http://10.142.51.197:2380,flannel2=http://10.142.51.198:2380,flannel3=http://10.106.91.131:2380 -initial-cluster-state new\n\n\n\n\u30db\u30b9\u30c8\uff13\n\netcd\u306e\u8d77\u52d5\nroot@flannel03:~# ./start-etcd.sh flannel3\nroot@flannel03:~# ps aux | grep etcd\nroot     10304  0.4  1.1  25900 11620 pts/0    Sl   01:18   0:00 /usr/local/bin/etcd -name flannel3 -initial-advertise-peer-urls http://10.106.91.131:2380 -listen-peer-urls http://10.106.91.131:2380 -initial-cluster-token flannel-cluster -initial-cluster flannel1=http://10.142.51.197:2380,flannel2=http://10.142.51.198:2380,flannel3=http://10.106.91.131:2380 -initial-cluster-state new\n\n\n\nflannel\u7528\u306e\u8a2d\u5b9a\u3092etcd\u306b\u6295\u5165\netcd\u306bflannel\u7528\u306e\u8a2d\u5b9a\u3092\u6295\u5165\u3059\u308b\u3002\u30db\u30b9\u30c8\uff11\u3067\u8a2d\u5b9a\u3057\u305f\u60c5\u5831\u306fetcd\u30af\u30e9\u30b9\u30bf\u3067\u5171\u6709\u3055\u308c\u308b\u305f\u3081\u3001\u30db\u30b9\u30c8\uff12\u3084\u30db\u30b9\u30c8\uff13\u304b\u3089\u3082\u53d6\u5f97\u3067\u304d\u308b\u3002\n\netcd\u30af\u30e9\u30b9\u30bf\u306e\u72b6\u614b\u78ba\u8a8d\nroot@flannel01:~# etcdctl member list\n12c356968a3f262f: name=flannel1 peerURLs=http://10.142.51.197:2380 clientURLs=http://localhost:2379,http://localhost:4001\n7415c1f880800621: name=flannel3 peerURLs=http://10.106.91.131:2380 clientURLs=http://localhost:2379,http://localhost:4001\n758e04f1ad0b9fef: name=flannel2 peerURLs=http://10.142.51.198:2380 clientURLs=http://localhost:2379,http://localhost:4001\n\nroot@flannel01:~# etcdctl cluster-health\ncluster is healthy\nmember 12c356968a3f262f is healthy\nmember 7415c1f880800621 is healthy\nmember 758e04f1ad0b9fef is healthy\n\n\n\nflannel\u306e\u8a2d\u5b9a\u6295\u5165\nroot@flannel01:~# etcdctl set /coreos.com/network/config '{\"Network\": \"192.168.0.0/16\", \"SubnetLen\": 24, \"SubnetMin\": \"192.168.90.0\", \"SubnetMax\": \"192.168.99.0\"}'\n\n\n\nflanneld\u8d77\u52d5\n\u5404\u30db\u30b9\u30c8\u3067flanneld\u3092\u8d77\u52d5\u3059\u308b\u3068\u3001etcd\u306b\u8a2d\u5b9a\u3057\u305f\u4eee\u60f3\u30cd\u30c3\u30c8\u30ef\u30fc\u30af192.168.0.0/16\u304b\u3089\u6307\u5b9a\u3057\u305f/24\u306e\u30b5\u30d6\u30cd\u30c3\u30c8\u304c\u5207\u308a\u3060\u3055\u308c\u3001\u305d\u306e\u8a2d\u5b9a\u304c\u74b0\u5883\u5909\u6570\u30d5\u30a1\u30a4\u30eb/run/flannel/subnet.env\u306b\u66f8\u304d\u3060\u3055\u308c\u308b\u3002\n\u203bSSH\u30bb\u30c3\u30b7\u30e7\u30f3\u304c\u5207\u65ad\u3055\u308c\u305f\u5834\u5408\u3001\u4ee5\u4e0b\u306e\u8d77\u52d5\u624b\u9806\u3060\u3068flanneld\u306f\u505c\u6b62\u3059\u308b\u3002SSH\u30bb\u30c3\u30b7\u30e7\u30f3\u304c\u5207\u65ad\u3055\u308c\u308b\u53ef\u80fd\u6027\u304c\u6709\u308b\u5834\u5408\u3001nohup\u3057\u305f\u307b\u3046\u304c\u826f\u3044\u3002\n\n\u30db\u30b9\u30c8\uff11\n\nflanneld\u306e\u8d77\u52d5\nroot@flannel01:~# flanneld -iface=eth0 > /var/log/flannel.log 2>&1 &\nroot@flannel01:~# ps aux | grep flanneld\nroot     13531  0.0  0.3 260804  3944 pts/0    Sl   01:36   0:00 flanneld -iface=eth0\n\nroot@flannel01:~# cat /run/flannel/subnet.env \nFLANNEL_SUBNET=192.168.93.1/24\nFLANNEL_MTU=1472\nFLANNEL_IPMASQ=false\n\n\n\n\u30db\u30b9\u30c8\uff12\n\nflanneld\u306e\u8d77\u52d5\nroot@flannel02:~# flanneld -iface=eth0 > /var/log/flannel.log 2>&1 &\nroot@flannel02:~# ps aux | grep flanneld\nroot     11446  0.0  0.3 260804  3940 pts/0    Sl   01:38   0:00 flanneld -iface=eth0\n\nroot@flannel02:~# cat /run/flannel/subnet.env \nFLANNEL_SUBNET=192.168.97.1/24\nFLANNEL_MTU=1472\nFLANNEL_IPMASQ=false\n\n\n\n\u30db\u30b9\u30c8\uff13\n\nflannel\u306e\u8d77\u52d5\nroot@flannel03:~# flanneld -iface=eth0 > /var/log/flannel.log 2>&1 &\nroot@flannel03:~# ps aux | grep flanneld\nroot     11346  0.0  0.4 260804  4204 pts/0    Sl   01:38   0:00 flanneld -iface=eth0\n\nroot@flannel03:~# \nroot@flannel03:~# cat /run/flannel/subnet.env \nFLANNEL_SUBNET=192.168.98.1/24\nFLANNEL_MTU=1472\nFLANNEL_IPMASQ=false\n\n\n\ndocker0\u306e\u8a2d\u5b9a\u5909\u66f4\nflanneld\u304c\u51fa\u529b\u3057\u305f\u74b0\u5883\u5909\u6570\u30d5\u30a1\u30a4\u30eb\u3092\u7528\u3044\u3066\u8d77\u52d5\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u4fee\u6b63\u3057\u3066Docker\u30c7\u30fc\u30e2\u30f3\u3092\u518d\u8d77\u52d5\u3057\u3001\u4eee\u60f3\u30d6\u30ea\u30c3\u30b8docker0\u306e\u8a2d\u5b9a\u3092\u9069\u5207\u306b\u5909\u66f4\u3059\u308b\u3002\n\u5168\u3066\u306e\u30db\u30b9\u30c8\u3067\u4e0b\u8a18\u306e\u624b\u9806\u3092\u5b9f\u884c\u3059\u308b\u3002\n\nDocker\u30c7\u30fc\u30e2\u30f3\u505c\u6b62&docker0\u524a\u9664\nroot@flannel01:~# service docker stop\nroot@flannel01:~# ip link set dev docker0 down\nroot@flannel01:~# brctl delbr docker0\nroot@flannel01:~# iptables -t nat -F POSTROUTING\n\n\n\nDocker\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u4fee\u6b63\nroot@flannel01:~# sed -i -e '/^FLANNEL.*/d' /etc/default/docker\nroot@flannel01:~# sed -i -e '/^DOCKER_OPTS=\"$DOCKER_OPTS --bip=${FLANNEL_SUBNET} --mtu=${FLANNEL_MTU}\"$/d' /etc/default/docker\nroot@flannel01:~# cat /run/flannel/subnet.env >> /etc/default/docker\nroot@flannel01:~# echo 'DOCKER_OPTS=\"$DOCKER_OPTS --bip=${FLANNEL_SUBNET} --mtu=${FLANNEL_MTU}\"' >>  /etc/default/docker\n\n\n\nDocker\u30c7\u30fc\u30e2\u30f3\u8d77\u52d5\nroot@flannel01:~# service docker start\n\n\n\u3053\u308c\u306b\u3088\u308a\u3001flannel\u304c\u5272\u308a\u5f53\u3066\u305f\u30b5\u30d6\u30cd\u30c3\u30c8\u3092\u5229\u7528\u3059\u308b\u3088\u3046\u306bdocker0\u306e\u8a2d\u5b9a\u304c\u5909\u66f4\u3055\u308c\u308b\u3002\n\n\u30db\u30b9\u30c8\uff11\n\n\u30db\u30b9\u30c8\uff11\u306e\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\nroot@flannel01:~# ip addr show docker0\n9: docker0: <NO-CARRIER,BROADCAST,MULTICAST,UP> mtu 1500 qdisc noqueue state DOWN group default \n    link/ether 56:84:7a:fe:97:99 brd ff:ff:ff:ff:ff:ff\n    inet 192.168.93.1/24 scope global docker0\n       valid_lft forever preferred_lft forever\nroot@flannel01:~# ip addr show flannel0\n8: flannel0: <POINTOPOINT,UP,LOWER_UP> mtu 1472 qdisc pfifo_fast state UNKNOWN group default qlen 500\n    link/none \n    inet 192.168.93.0/16 scope global flannel0\n       valid_lft forever preferred_lft forever\nroot@flannel01:~# ip route show\ndefault via X.X.X.X dev eth1 \n10.0.0.0/8 via 10.142.51.193 dev eth0 \n10.142.51.192/26 dev eth0  proto kernel  scope link  src 10.142.51.197 \nX.X.X.x/28 dev eth1  proto kernel  scope link  src X.X.X.X \n192.168.0.0/16 dev flannel0 \n192.168.93.0/24 dev docker0  proto kernel  scope link  src 192.168.93.1 \n\n\n\n\u30db\u30b9\u30c8\uff12\n\n\u30db\u30b9\u30c8\uff12\u306e\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\nroot@flannel02:~# ip addr show docker0\n7: docker0: <NO-CARRIER,BROADCAST,MULTICAST,UP> mtu 1500 qdisc noqueue state DOWN group default \n    link/ether 56:84:7a:fe:97:99 brd ff:ff:ff:ff:ff:ff\n    inet 192.168.97.1/24 scope global docker0\n       valid_lft forever preferred_lft forever\nroot@flannel02:~# ip addr show flannel0\n6: flannel0: <POINTOPOINT,UP,LOWER_UP> mtu 1472 qdisc pfifo_fast state UNKNOWN group default qlen 500\n    link/none \n    inet 192.168.97.0/16 scope global flannel0\n       valid_lft forever preferred_lft forever\nroot@flannel02:~# ip route show\ndefault via Y.Y.Y.Y dev eth1 \n10.0.0.0/8 via 10.142.51.193 dev eth0 \n10.142.51.192/26 dev eth0  proto kernel  scope link  src 10.142.51.198 \nY.Y.Y.y/28 dev eth1  proto kernel  scope link  src Y.Y.Y.Y\n192.168.0.0/16 dev flannel0  proto kernel  scope link  src 192.168.97.0 \n192.168.97.0/24 dev docker0  proto kernel  scope link  src 192.168.97.1 \n\n\n\n\u30db\u30b9\u30c8\uff13\n\n\u30db\u30b9\u30c8\uff13\u306e\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\nroot@flannel03:~# ip addr show docker0\n7: docker0: <NO-CARRIER,BROADCAST,MULTICAST,UP> mtu 1500 qdisc noqueue state DOWN group default \n    link/ether 56:84:7a:fe:97:99 brd ff:ff:ff:ff:ff:ff\n    inet 192.168.98.1/24 scope global docker0\n       valid_lft forever preferred_lft forever\nroot@flannel03:~# ip addr show flannel0\n6: flannel0: <POINTOPOINT,UP,LOWER_UP> mtu 1472 qdisc pfifo_fast state UNKNOWN group default qlen 500\n    link/none \n    inet 192.168.98.0/16 scope global flannel0\n       valid_lft forever preferred_lft forever\nroot@flannel03:~# ip route show\ndefault via Z.Z.Z.Z dev eth1 \n10.0.0.0/8 via 10.106.91.129 dev eth0 \n10.106.91.128/26 dev eth0  proto kernel  scope link  src 10.106.91.131 \nZ.Z.Z.z/28 dev eth1  proto kernel  scope link  src Z.Z.Z.Z \n192.168.0.0/16 dev flannel0  proto kernel  scope link  src 192.168.98.0 \n192.168.98.0/24 dev docker0  proto kernel  scope link  src 192.168.98.1 \n\n\n\u3053\u3053\u307e\u3067\u3067docker0\u306e\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u304c\u9069\u5207\u306b\u518d\u8a2d\u5b9a\u3055\u308c\u3001192.168.0.0/16\u3068\u3044\u3046\u4eee\u60f3\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u304c\u6577\u8a2d\u3055\u308c\u308b\u3002\n\n\nDocker\u30b3\u30f3\u30c6\u30ca\u8d77\u52d5\n\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\nfalnnel\u306f\u30b3\u30f3\u30c6\u30ca\u306b\u5272\u308a\u632f\u3089\u308c\u308bIP\u30a2\u30c9\u30ec\u30b9\u3092\u6307\u5b9a\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u306a\u3044\u305f\u3081\u3001Docker\u30b3\u30f3\u30c6\u30ca\u8d77\u52d5\u5f8c\u306bdocker inspect\u3067IP\u30a2\u30c9\u30ec\u30b9\u3092\u8abf\u3079\u308b\u3002\n\n\n\n\u30db\u30b9\u30c8\n\u30b3\u30f3\u30c6\u30ca\u540d\nDocker\u304c\u5272\u308a\u5f53\u3066\u305fIP\u30a2\u30c9\u30ec\u30b9\n\n\n\n\n\n\u30db\u30b9\u30c81\nhttpd\n192.168.93.2/24\napache2\u3092\u8d77\u52d5\n\n\n\u30db\u30b9\u30c81\nclient1\n192.168.93.3/24\n\n\n\n\u30db\u30b9\u30c82\nclient2\n192.168.97.2/24\n\n\n\n\u30db\u30b9\u30c83\nclient3\n192.168.98.2/24\n\n\n\n\n\n\u30db\u30b9\u30c8\uff11\n\nhttpd\u8d77\u52d5\nroot@flannel01:~# HTTPD=$(docker run -d -i -t ubuntu:latest /bin/bash)\nroot@flannel01:~# docker inspect --format=\"{{.NetworkSettings.IPAddress}}/{{.NetworkSettings.IPPrefixLen}}\" $HTTPD\n192.168.93.2/24\n\n\n\nclient1\u8d77\u52d5\nroot@flannel01:~# CLIENT1=$(docker run -d -i -t ubuntu:latest /bin/bash)\nroot@flannel01:~# docker inspect --format=\"{{.NetworkSettings.IPAddress}}/{{.NetworkSettings.IPPrefixLen}}\" $CLIENT1\n192.168.93.3/24\n\n\n\nhttpd\u30b3\u30f3\u30c6\u30ca\n\nhttpd\u30b3\u30f3\u30c6\u30ca\u306e\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\nroot@flannel01:~# docker attach $HTTPD\n\nroot@7ba62b092066:/# ip addr show eth0\n10: eth0: <BROADCAST,UP,LOWER_UP> mtu 1472 qdisc noqueue state UP group default \n    link/ether 02:42:c0:a8:5d:02 brd ff:ff:ff:ff:ff:ff\n    inet 192.168.93.2/24 scope global eth0\n       valid_lft forever preferred_lft forever\n    inet6 fe80::42:c0ff:fea8:5d02/64 scope link \n       valid_lft forever preferred_lft forever\n\nroot@7ba62b092066:/# ip route show\ndefault via 192.168.93.1 dev eth0 \n192.168.93.0/24 dev eth0  proto kernel  scope link  src 192.168.93.2\n\n\n\napache2\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\nroot@7ba62b092066:/# apt-get install apache2 -y\nroot@7ba62b092066:/# apachectl start\n\n\n\nclient1\u30b3\u30f3\u30c6\u30ca\n\nclient1\u30b3\u30f3\u30c6\u30ca\u306e\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\nroot@flannel01:~# docker attach $CLIENT1\n\nroot@0914ea0ca6ab:/# ip addr show eth0\n12: eth0: <BROADCAST,UP,LOWER_UP> mtu 1472 qdisc noqueue state UP group default \n    link/ether 02:42:c0:a8:5d:03 brd ff:ff:ff:ff:ff:ff\n    inet 192.168.93.3/24 scope global eth0\n       valid_lft forever preferred_lft forever\n    inet6 fe80::42:c0ff:fea8:5d03/64 scope link \n       valid_lft forever preferred_lft forever\n\nroot@0914ea0ca6ab:/# ip route show\ndefault via 192.168.93.1 dev eth0 \n192.168.93.0/24 dev eth0  proto kernel  scope link  src 192.168.93.3 \n\n\n\ncurl\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\nroot@0914ea0ca6ab:/# apt-get install curl -y\n\n\n\n\u30db\u30b9\u30c8\uff12\n\nclient2\u8d77\u52d5\nroot@flannel02:~# CLIENT2=$(docker run -d -i -t ubuntu:latest /bin/bash)\nroot@flannel02:~# docker inspect --format=\"{{.NetworkSettings.IPAddress}}/{{.NetworkSettings.IPPrefixLen}}\" $CLIENT2\n192.168.97.2/24\n\n\n\nclient2\u30b3\u30f3\u30c6\u30ca\n\nclient2\u30b3\u30f3\u30c6\u30ca\u306e\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\nroot@flannel02:~# docker attach $CLIENT2\n\nroot@d875be3ae788:/# ip addr show eth0\n8: eth0: <BROADCAST,UP,LOWER_UP> mtu 1472 qdisc noqueue state UP group default \n    link/ether 02:42:c0:a8:61:02 brd ff:ff:ff:ff:ff:ff\n    inet 192.168.97.2/24 scope global eth0\n       valid_lft forever preferred_lft forever\n    inet6 fe80::42:c0ff:fea8:6102/64 scope link \n       valid_lft forever preferred_lft forever\n\nroot@d875be3ae788:/# ip route show\ndefault via 192.168.97.1 dev eth0 \n192.168.97.0/24 dev eth0  proto kernel  scope link  src 192.168.97.2\n\n\n\ncurl\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\nroot@d875be3ae788:/# apt-get install curl -y\n\n\n\n\u30db\u30b9\u30c8\uff13\n\nclient3\u8d77\u52d5\nroot@flannel03:~# CLIENT3=$(docker run -d -i -t ubuntu:latest /bin/bash)\nroot@flannel03:~# docker inspect --format=\"{{.NetworkSettings.IPAddress}}/{{.NetworkSettings.IPPrefixLen}}\" $CLIENT3\n192.168.98.2/24\n\n\n\nclient3\u30b3\u30f3\u30c6\u30ca\n\nclient3\u30b3\u30f3\u30c6\u30ca\u306e\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\nroot@flannel03:~# docker attach $CLIENT3\n\nroot@6e553d2a2ad1:/# ip addr show eth0\n9: eth0: <BROADCAST,UP,LOWER_UP> mtu 1472 qdisc noqueue state UP group default \n    link/ether 02:42:c0:a8:62:02 brd ff:ff:ff:ff:ff:ff\n    inet 192.168.98.2/24 scope global eth0\n       valid_lft forever preferred_lft forever\n    inet6 fe80::42:c0ff:fea8:6202/64 scope link \n       valid_lft forever preferred_lft forever\n\nroot@6e553d2a2ad1:/# ip route show\ndefault via 192.168.98.1 dev eth0 \n192.168.98.0/24 dev eth0  proto kernel  scope link  src 192.168.98.2 \n\n\n\ncurl\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\nroot@6e553d2a2ad1:/# apt-get install curl -y\n\n\n\n\n\u758e\u901a\u78ba\u8a8d\n\u3053\u3053\u307e\u3067\u3067\u3001\u8907\u6570\u30db\u30b9\u30c8\u3092\u307e\u305f\u304c\u3063\u3066\u6577\u8a2d\u3055\u308c\u305f192.168.0.0/16\u3068\u3044\u3046\u4eee\u60f3\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u4e0a\u306b4\u3064\u306e\u30b3\u30f3\u30c6\u30ca\u304c\u8d77\u52d5\u3057\u305f\u3002\u30b3\u30f3\u30c6\u30ca\u3084\u30db\u30b9\u30c8\u304b\u3089\u758e\u901a\u78ba\u8a8d\u3092\u884c\u3046\u3002\n\u203b\u30d1\u30b1\u30c3\u30c8\u306fflanneld\u304c\u30ab\u30d7\u30bb\u30eb\u5316\u3057\u3066\u304a\u308a\u3001\u304b\u3064etcd\u304c\u30cf\u30fc\u30c8\u30d3\u30fc\u30c8\u3092\u983b\u7e41\u306b\u9001\u308a\u5408\u3063\u3066\u3044\u308b\u305f\u3081\u3001tcpdump\u3092\u4ed5\u639b\u3051\u3066\u3082\u3069\u308c\u304c\u30b3\u30f3\u30c6\u30ca\u304b\u3089\u306e\u30d1\u30b1\u30c3\u30c8\u306a\u306e\u304b\u5224\u5225\u3067\u304d\u306a\u3044\u3002\u3002\u3002\nroot@flannel01:~# tcpdump -v -i eth0 src host 10.142.51.198\ntcpdump: listening on eth0, link-type EN10MB (Ethernet), capture size 65535 bytes\n04:44:10.100921 IP (tos 0x0, ttl 64, id 26599, offset 0, flags [DF], proto TCP (6), length 75)\n    10.142.51.198.2380 > 10.142.51.197.36000: Flags [P.], cksum 0xa8e2 (correct), seq 2675:2698, ack 1, win 235, options [nop,nop,TS val 6265207 ecr 6596379], length 23\n04:44:10.103224 IP (tos 0x0, ttl 64, id 51049, offset 0, flags [DF], proto TCP (6), length 52)\n    10.142.51.198.46572 > 10.142.51.197.2380: Flags [.], cksum 0x5e92 (correct), ack 9388, win 257, options [nop,nop,TS val 6265207 ecr 6596504], length 0\n04:44:10.103439 IP (tos 0x0, ttl 64, id 26600, offset 0, flags [DF], proto TCP (6), length 75)\n    10.142.51.198.2380 > 10.142.51.197.36000: Flags [P.], cksum 0xa74f (correct), seq 2698:2721, ack 1, win 235, options [nop,nop,TS val 6265207 ecr 6596503], length 23\n04:44:10.105420 IP (tos 0x0, ttl 64, id 51050, offset 0, flags [DF], proto TCP (6), length 52)\n    10.142.51.198.46572 > 10.142.51.197.2380: Flags [.], cksum 0x5e54 (correct), ack 9449, win 257, options [nop,nop,TS val 6265208 ecr 6596504], length 0\n...\n\n\n\u30db\u30b9\u30c8\uff11 \u2192 httpd\u30b3\u30f3\u30c6\u30ca\nhttpd\u30b3\u30f3\u30c6\u30ca\u306f\u30db\u30b9\u30c81\u4e0a\u306e\u4eee\u60f3\u30d6\u30ea\u30c3\u30b8docker0\u306b\u3064\u306a\u304c\u3063\u3066\u3044\u308b\u305f\u3081\u3001\u305d\u306e\u307e\u307e\u901a\u4fe1\u3067\u304d\u308b\u3002\n\nping(\u30db\u30b9\u30c8\uff11\u2192httpd\u30b3\u30f3\u30c6\u30ca)\nroot@flannel01:~# ping 192.168.93.2\nPING 192.168.93.2 (192.168.93.2) 56(84) bytes of data.\n64 bytes from 192.168.93.2: icmp_seq=1 ttl=64 time=0.044 ms\n64 bytes from 192.168.93.2: icmp_seq=2 ttl=64 time=0.038 ms\n...\n\n\n\nHTTP(\u30db\u30b9\u30c8\uff11\u2192httpd\u30b3\u30f3\u30c6\u30ca\uff09\nroot@flannel01:~# curl 192.168.93.2\n\n<!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.0 Transitional//EN\" \"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\">\n<html xmlns=\"http://www.w3.org/1999/xhtml\">\n...\n\n\n\nclient1\u30b3\u30f3\u30c6\u30ca \u2192 httpd\u30b3\u30f3\u30c6\u30ca\nclient1\u30b3\u30f3\u30c6\u30ca\u3068httpd\u30b3\u30f3\u30c6\u30ca\u306f\u540c\u3058\u4eee\u60f3\u30d6\u30ea\u30c3\u30b8docker0\u306b\u3064\u306a\u304c\u3063\u3066\u3044\u308b\u305f\u3081\u3001\u305d\u306e\u307e\u307e\u901a\u4fe1\u3067\u304d\u308b\u3002\n\nping(client1\u30b3\u30f3\u30c6\u30ca\u2192httpd\u30b3\u30f3\u30c6\u30ca\uff09\nroot@0914ea0ca6ab:/# ping 192.168.93.2\nPING 192.168.93.2 (192.168.93.2) 56(84) bytes of data.\n64 bytes from 192.168.93.2: icmp_seq=1 ttl=64 time=0.059 ms\n64 bytes from 192.168.93.2: icmp_seq=2 ttl=64 time=0.050 ms\n...\n\n\n\nHTTP(client1\u30b3\u30f3\u30c6\u30ca\u2192httpd\u30b3\u30f3\u30c6\u30ca\uff09\nroot@0914ea0ca6ab:/# curl 192.168.93.2\n\n<!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.0 Transitional//EN\" \"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\">\n<html xmlns=\"http://www.w3.org/1999/xhtml\">\n...\n\n\n\n\u30db\u30b9\u30c82 \u2192 httpd\u30b3\u30f3\u30c6\u30ca\nflanneld\u306b\u3088\u3063\u3066\u30d1\u30b1\u30c3\u30c8\u304c\u30e9\u30c3\u30d7\u3055\u308c\u3001\u540c\u4e00VLAN\u306e\u30db\u30b9\u30c8\uff11\u4e0a\u306ehttpd\u30b3\u30f3\u30c6\u30ca\u3068\u901a\u4fe1\u3067\u304d\u308b\u3002\n\nping(\u30db\u30b9\u30c82\u2192httpd\u30b3\u30f3\u30c6\u30ca)\nroot@flannel02:~# ping 192.168.93.2\nPING 192.168.93.2 (192.168.93.2) 56(84) bytes of data.\n64 bytes from 192.168.93.2: icmp_seq=1 ttl=61 time=0.616 ms\n64 bytes from 192.168.93.2: icmp_seq=2 ttl=61 time=0.317 ms\n...\n\n\n\nHTTP(\u30db\u30b9\u30c82\u2192httpd\u30b3\u30f3\u30c6\u30ca)\nroot@flannel02:~# curl 192.168.93.2\n\n<!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.0 Transitional//EN\" \"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\">\n<html xmlns=\"http://www.w3.org/1999/xhtml\">\n...\n\n\n\nclient2\u30b3\u30f3\u30c6\u30ca \u2192 httpd\u30b3\u30f3\u30c6\u30ca\nflanneld\u306b\u3088\u3063\u3066\u30d1\u30b1\u30c3\u30c8\u304c\u30e9\u30c3\u30d7\u3055\u308c\u3001\u540c\u4e00VLAN\u306e\u30db\u30b9\u30c8\uff11\u4e0a\u306ehttpd\u30b3\u30f3\u30c6\u30ca\u3068\u901a\u4fe1\u3067\u304d\u308b\u3002\n\nping(client2\u30b3\u30f3\u30c6\u30ca\u2192httpd\u30b3\u30f3\u30c6\u30ca)\nroot@d875be3ae788:/# ping 192.168.93.2\nPING 192.168.93.2 (192.168.93.2) 56(84) bytes of data.\n64 bytes from 192.168.93.2: icmp_seq=1 ttl=60 time=0.728 ms\n64 bytes from 192.168.93.2: icmp_seq=2 ttl=60 time=0.314 ms\n...\n\n\n\nHTTP(client2\u30b3\u30f3\u30c6\u30ca\u2192httpd\u30b3\u30f3\u30c6\u30ca)\nroot@d875be3ae788:/# curl 192.168.93.2\n\n<!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.0 Transitional//EN\" \"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\">\n<html xmlns=\"http://www.w3.org/1999/xhtml\">\n...\n\n\n\n\u30db\u30b9\u30c83 \u2192 httpd\u30b3\u30f3\u30c6\u30ca\nflanneld\u306b\u3088\u3063\u3066\u30d1\u30b1\u30c3\u30c8\u304c\u30e9\u30c3\u30d7\u3055\u308c\u3001\u7570\u306a\u308bVLAN\u306e\u30db\u30b9\u30c8\uff11\u4e0a\u306ehttpd\u30b3\u30f3\u30c6\u30ca\u3068\u901a\u4fe1\u3067\u304d\u308b\u3002\n\nping(\u30db\u30b9\u30c83\u2192httpd\u30b3\u30f3\u30c6\u30ca)\nroot@flannel03:~# ping 192.168.93.2\nPING 192.168.93.2 (192.168.93.2) 56(84) bytes of data.\n64 bytes from 192.168.93.2: icmp_seq=1 ttl=61 time=1.82 ms\n64 bytes from 192.168.93.2: icmp_seq=2 ttl=61 time=1.52 ms\n...\n\n\n\nHTTP(\u30db\u30b9\u30c83\u2192httpd\u30b3\u30f3\u30c6\u30ca)\nroot@flannel03:~# curl 192.168.93.2\n\n<!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.0 Transitional//EN\" \"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\">\n<html xmlns=\"http://www.w3.org/1999/xhtml\">\n...\n\n\n\nclien3\u30b3\u30f3\u30c6\u30ca \u2192 httpd\u30b3\u30f3\u30c6\u30ca\nflanneld\u306b\u3088\u3063\u3066\u30d1\u30b1\u30c3\u30c8\u304c\u30e9\u30c3\u30d7\u3055\u308c\u3001\u7570\u306a\u308bVLAN\u306e\u30db\u30b9\u30c8\uff11\u4e0a\u306ehttpd\u30b3\u30f3\u30c6\u30ca\u3068\u901a\u4fe1\u3067\u304d\u308b\u3002\n\nping(client3\u30b3\u30f3\u30c6\u30ca\u2192httpd\u30b3\u30f3\u30c6\u30ca)\nroot@6e553d2a2ad1:/# ping 192.168.93.2\nPING 192.168.93.2 (192.168.93.2) 56(84) bytes of data.\n64 bytes from 192.168.93.2: icmp_seq=1 ttl=60 time=1.86 ms\n64 bytes from 192.168.93.2: icmp_seq=2 ttl=60 time=1.62 ms\n...\n\n\n\nHTTP(client3\u30b3\u30f3\u30c6\u30ca\u2192httpd\u30b3\u30f3\u30c6\u30ca)\nroot@6e553d2a2ad1:/# curl 192.168.93.2\n\n<!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.0 Transitional//EN\" \"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\">\n<html xmlns=\"http://www.w3.org/1999/xhtml\">\n...\n\n\n\n\u307e\u3068\u3081\netcd\u3068flannel\u3092\u7528\u3044\u308b\u3053\u3068\u3067\u3001L2 & L3\u3067\u63a5\u7d9a\u3055\u308c\u305f\u8907\u6570\u30db\u30b9\u30c8\u9593\u306b\u4eee\u60f3\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u3092\u6577\u8a2d\u3057\u3066Docker\u30b3\u30f3\u30c6\u30ca\u3092\u6240\u5c5e\u3055\u305b\u3001\u76f8\u4e92\u306b\u901a\u4fe1\u3055\u305b\u308b\u3053\u3068\u304c\u3067\u304d\u305f\u3002\n\u305f\u3060\u3057etcd+flannel\u306fDocker\u30b3\u30f3\u30c6\u30ca\u306eIP\u30a2\u30c9\u30ec\u30b9\u3092\u660e\u793a\u7684\u306b\u6307\u5b9a\u3059\u308b\uff08\u3042\u308b\u3044\u306fDHCP\u3092\u6307\u5b9a\u3059\u308b\uff09\u3053\u3068\u304c\u3067\u304d\u306a\u3044\u305f\u3081\u3001\u6ce8\u610f\u304c\u5fc5\u8981\u3067\u3042\u308b\u3002\n\u30de\u30eb\u30c1\u30db\u30b9\u30c8\u3067\u52d5\u4f5c\u3059\u308bDocker\u30cd\u30c3\u30c8\u30ef\u30fc\u30ad\u30f3\u30b0\u30c4\u30fc\u30eb\u306b\u3064\u3044\u3066\u306e\u307e\u3068\u3081\u7b2c\u4e8c\u6bb5\u3002\n\uff08\u7b2c\u4e00\u5f3e\uff1a[pipework\uff0bGRE](http://qiita.com/nmatsui/items/fb7fc01dbba16b0ecb8e)\uff09\n\uff08\u7b2c\u4e09\u5f3e\uff1a[weave](http://qiita.com/nmatsui/items/a7caa5a3840b8c920124)\uff09\n\u4eca\u56de\u306f[coreos/flannel](https://github.com/coreos/flannel)\u3092\u53d6\u308a\u4e0a\u3052\u308b\u3002\n\n# \u691c\u8a3c\u74b0\u5883\nSoftLayer\u306b\u4ee5\u4e0b\u306eVirtual Server\u3092\u7acb\u3061\u4e0a\u3052\u3066\u691c\u8a3c\u3057\u305f\u3002\n\n||DC|hostname|private IP(eth0)|public IP(eth1)|\n|:--|:--|:--|:--|:--|:--|\n|\u30db\u30b9\u30c81|Dallas 9|flannel01|10.142.51.197|X.X.X.X|\n|\u30db\u30b9\u30c82|Dallas 9|flannel02|10.142.51.198|Y.Y.Y.Y|\n|\u30db\u30b9\u30c83|Dallas 6|flannel03|10.106.91.131|Z.Z.Z.Z|\n\n\u30db\u30b9\u30c81\u3068\u30db\u30b9\u30c82\u306f\u540c\u4e00VLAN\u4e0a\u306b\u3042\u308a\u3001\u30db\u30b9\u30c83\u306f\u5225VLAN\u4e0a\u3067\u30db\u30b9\u30c81,2\u3068L3\u3067\u63a5\u7d9a\u3055\u308c\u3066\u3044\u308b\u3002\n\n\u5404\u7a2e\u30d0\u30fc\u30b8\u30e7\u30f3\u306f\u4ee5\u4e0b\u306e\u901a\u308a\u3002\n\n| |version|\n|:--|:--|\n|distribution|Ubuntu 14.04.2 LTS|\n|kernel|3.13.0-48-generic|\n|docker|1.6.0|\n|etcd|2.0.4+git|\n|flannel|0.3.1+git|\n\n# \u6e96\u5099\n\u3059\u3079\u3066\u306e\u30db\u30b9\u30c8\u3067\u4ee5\u4e0b\u306e\u4f5c\u696d\u3092\u5b9f\u65bd\u3059\u308b\u3002\n\n```text:\u5fc5\u8981\u30d1\u30c3\u30b1\u30fc\u30b8\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\nroot@flannel01:~# apt-get update\nroot@flannel01:~# apt-get upgrade -y\nroot@flannel01:~# apt-get install build-essential linux-libc-dev bridge-utils git curl -y\n```\n\n```text:golang\u3068docker\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\nroot@flannel01:~# wget -O - https://storage.googleapis.com/golang/go1.4.2.linux-amd64.tar.gz | tar -C /usr/local -vxzf -\nroot@flannel01:~# echo 'export PATH=$PATH:/usr/local/go/bin' >> /etc/profile\nroot@flannel01:~# source /etc/profile\nroot@flannel01:~# wget -qO- https://get.docker.com/ | sh\n```\n\n```text:etcd\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\nroot@flannel01:~# git clone https://github.com/coreos/etcd.git /opt/coreos/etcd\nroot@flannel01:~# cd /opt/coreos/etcd\nroot@flannel01:/opt/coreos/etcd# ./build\nroot@flannel01:/opt/coreos/etcd# ln -s /opt/coreos/etcd/bin/etcd /usr/local/bin/etcd\nroot@flannel01:/opt/coreos/etcd# ln -s /opt/coreos/etcd/bin/etcdctl /usr/local/bin/etcdctl\n```\n\n```text:flannel\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\nroot@flannel01:~# git clone https://github.com/coreos/flannel.git /opt/coreos/flannel\nroot@flannel01:~# cd /opt/coreos/flannel \nroot@flannel01:/opt/coreos/flannel# ./build\nroot@flannel01:/opt/coreos/flannel# ln -s /opt/coreos/flannel/bin/flanneld /usr/local/bin/flanneld\n```\n\n# etcd\u30af\u30e9\u30b9\u30bf\u306e\u69cb\u7bc9\n\n\u307e\u305a\u306f\u4ee5\u4e0b\u306e\u624b\u9806\u3092\u53c2\u8003\u306b\u3001\u5168\u3066\u306e\u30db\u30b9\u30c8\u304c\u53c2\u52a0\u3059\u308betcd\u30af\u30e9\u30b9\u30bf\u3092\u69cb\u7bc9\u3059\u308b\u3002\nhttps://github.com/coreos/etcd/blob/master/Documentation/clustering.md\n\netcd\u30af\u30e9\u30b9\u30bf\u306e\u8d77\u52d5\u306f\u30aa\u30d7\u30b7\u30e7\u30f3\u304c\u7169\u96d1\u306a\u306e\u3067\u3001bash\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u4f5c\u308b\u3002\n\n```bash:start-etcd.sh\n#!/bin/bash\n\nif [ $# -ne 1 ]; then\n  echo \"usage: $0 nodename\"\n  exit 1\nfi\n\ndeclare -A NODES\n\nNODES[\"flannel1\"]=\"http://10.142.51.197:2380\"\nNODES[\"flannel2\"]=\"http://10.142.51.198:2380\"\nNODES[\"flannel3\"]=\"http://10.106.91.131:2380\"\n\nTOKEN=\"flannel-cluster\"\n\nif [[ \"${NODES[$1]+_}\" != \"_\" ]]; then\n  echo \"invalid nodename\"\n  exit 1\nelse\n  NAME=$1\nfi\n\nCLUSTER=\"\"\n\nfor i in ${!NODES[@]}; do\n  if [ -n \"$CLUSTER\" ]; then\n    CLUSTER=$CLUSTER\",\"\n  fi\n  CLUSTER=$CLUSTER${i}=${NODES[$i]}\ndone\n\nset -x\n\n/usr/local/bin/etcd -name $NAME \\\n  -initial-advertise-peer-urls ${NODES[$NAME]} \\\n  -listen-peer-urls ${NODES[$NAME]} \\\n  -initial-cluster-token $TOKEN \\\n  -initial-cluster $CLUSTER \\\n  -initial-cluster-state new \\\n  > /var/log/etcd.log 2>&1 &\n\n```\n\n## \u30db\u30b9\u30c8\uff11\n\n```text:etcd\u306e\u8d77\u52d5\nroot@flannel01:~# ./start-etcd.sh flannel1\nroot@flannel01:~# ps aux | grep etcd\nroot     12199  0.8  1.9  32436 19968 pts/0    Sl   01:13   0:03 /usr/local/bin/etcd -name flannel1 -initial-advertise-peer-urls http://10.142.51.197:2380 -listen-peer-urls http://10.142.51.197:2380 -initial-cluster-token flannel-cluster -initial-cluster flannel1=http://10.142.51.197:2380,flannel2=http://10.142.51.198:2380,flannel3=http://10.106.91.131:2380 -initial-cluster-state new\n```\n\n## \u30db\u30b9\u30c8\uff12\n\n```text:etcd\u306e\u8d77\u52d5\nroot@flannel02:~# ./start-etcd.sh flannel2\nroot@flannel02:~# ps aux | grep etcd\nroot     10218  0.4  1.2  26988 12772 pts/0    Sl   01:17   0:00 /usr/local/bin/etcd -name flannel2 -initial-advertise-peer-urls http://10.142.51.198:2380 -listen-peer-urls http://10.142.51.198:2380 -initial-cluster-token flannel-cluster -initial-cluster flannel1=http://10.142.51.197:2380,flannel2=http://10.142.51.198:2380,flannel3=http://10.106.91.131:2380 -initial-cluster-state new\n```\n\n## \u30db\u30b9\u30c8\uff13\n\n```text:etcd\u306e\u8d77\u52d5\nroot@flannel03:~# ./start-etcd.sh flannel3\nroot@flannel03:~# ps aux | grep etcd\nroot     10304  0.4  1.1  25900 11620 pts/0    Sl   01:18   0:00 /usr/local/bin/etcd -name flannel3 -initial-advertise-peer-urls http://10.106.91.131:2380 -listen-peer-urls http://10.106.91.131:2380 -initial-cluster-token flannel-cluster -initial-cluster flannel1=http://10.142.51.197:2380,flannel2=http://10.142.51.198:2380,flannel3=http://10.106.91.131:2380 -initial-cluster-state new\n```\n\n# flannel\u7528\u306e\u8a2d\u5b9a\u3092etcd\u306b\u6295\u5165\n\netcd\u306bflannel\u7528\u306e\u8a2d\u5b9a\u3092\u6295\u5165\u3059\u308b\u3002\u30db\u30b9\u30c8\uff11\u3067\u8a2d\u5b9a\u3057\u305f\u60c5\u5831\u306fetcd\u30af\u30e9\u30b9\u30bf\u3067\u5171\u6709\u3055\u308c\u308b\u305f\u3081\u3001\u30db\u30b9\u30c8\uff12\u3084\u30db\u30b9\u30c8\uff13\u304b\u3089\u3082\u53d6\u5f97\u3067\u304d\u308b\u3002\n\n```text:etcd\u30af\u30e9\u30b9\u30bf\u306e\u72b6\u614b\u78ba\u8a8d\nroot@flannel01:~# etcdctl member list\n12c356968a3f262f: name=flannel1 peerURLs=http://10.142.51.197:2380 clientURLs=http://localhost:2379,http://localhost:4001\n7415c1f880800621: name=flannel3 peerURLs=http://10.106.91.131:2380 clientURLs=http://localhost:2379,http://localhost:4001\n758e04f1ad0b9fef: name=flannel2 peerURLs=http://10.142.51.198:2380 clientURLs=http://localhost:2379,http://localhost:4001\n\nroot@flannel01:~# etcdctl cluster-health\ncluster is healthy\nmember 12c356968a3f262f is healthy\nmember 7415c1f880800621 is healthy\nmember 758e04f1ad0b9fef is healthy\n```\n\n```text:flannel\u306e\u8a2d\u5b9a\u6295\u5165\nroot@flannel01:~# etcdctl set /coreos.com/network/config '{\"Network\": \"192.168.0.0/16\", \"SubnetLen\": 24, \"SubnetMin\": \"192.168.90.0\", \"SubnetMax\": \"192.168.99.0\"}'\n```\n\n# flanneld\u8d77\u52d5\n\n\u5404\u30db\u30b9\u30c8\u3067flanneld\u3092\u8d77\u52d5\u3059\u308b\u3068\u3001etcd\u306b\u8a2d\u5b9a\u3057\u305f\u4eee\u60f3\u30cd\u30c3\u30c8\u30ef\u30fc\u30af**192.168.0.0/16**\u304b\u3089\u6307\u5b9a\u3057\u305f**/24**\u306e\u30b5\u30d6\u30cd\u30c3\u30c8\u304c\u5207\u308a\u3060\u3055\u308c\u3001\u305d\u306e\u8a2d\u5b9a\u304c\u74b0\u5883\u5909\u6570\u30d5\u30a1\u30a4\u30eb**/run/flannel/subnet.env**\u306b\u66f8\u304d\u3060\u3055\u308c\u308b\u3002\n\n\u203bSSH\u30bb\u30c3\u30b7\u30e7\u30f3\u304c\u5207\u65ad\u3055\u308c\u305f\u5834\u5408\u3001\u4ee5\u4e0b\u306e\u8d77\u52d5\u624b\u9806\u3060\u3068flanneld\u306f\u505c\u6b62\u3059\u308b\u3002SSH\u30bb\u30c3\u30b7\u30e7\u30f3\u304c\u5207\u65ad\u3055\u308c\u308b\u53ef\u80fd\u6027\u304c\u6709\u308b\u5834\u5408\u3001nohup\u3057\u305f\u307b\u3046\u304c\u826f\u3044\u3002\n\n## \u30db\u30b9\u30c8\uff11\n\n```text:flanneld\u306e\u8d77\u52d5\nroot@flannel01:~# flanneld -iface=eth0 > /var/log/flannel.log 2>&1 &\nroot@flannel01:~# ps aux | grep flanneld\nroot     13531  0.0  0.3 260804  3944 pts/0    Sl   01:36   0:00 flanneld -iface=eth0\n\nroot@flannel01:~# cat /run/flannel/subnet.env \nFLANNEL_SUBNET=192.168.93.1/24\nFLANNEL_MTU=1472\nFLANNEL_IPMASQ=false\n```\n\n## \u30db\u30b9\u30c8\uff12\n\n```text:flanneld\u306e\u8d77\u52d5\nroot@flannel02:~# flanneld -iface=eth0 > /var/log/flannel.log 2>&1 &\nroot@flannel02:~# ps aux | grep flanneld\nroot     11446  0.0  0.3 260804  3940 pts/0    Sl   01:38   0:00 flanneld -iface=eth0\n\nroot@flannel02:~# cat /run/flannel/subnet.env \nFLANNEL_SUBNET=192.168.97.1/24\nFLANNEL_MTU=1472\nFLANNEL_IPMASQ=false\n```\n\n## \u30db\u30b9\u30c8\uff13\n\n```text:flannel\u306e\u8d77\u52d5\nroot@flannel03:~# flanneld -iface=eth0 > /var/log/flannel.log 2>&1 &\nroot@flannel03:~# ps aux | grep flanneld\nroot     11346  0.0  0.4 260804  4204 pts/0    Sl   01:38   0:00 flanneld -iface=eth0\n\nroot@flannel03:~# \nroot@flannel03:~# cat /run/flannel/subnet.env \nFLANNEL_SUBNET=192.168.98.1/24\nFLANNEL_MTU=1472\nFLANNEL_IPMASQ=false\n```\n\n# docker0\u306e\u8a2d\u5b9a\u5909\u66f4\n\nflanneld\u304c\u51fa\u529b\u3057\u305f\u74b0\u5883\u5909\u6570\u30d5\u30a1\u30a4\u30eb\u3092\u7528\u3044\u3066\u8d77\u52d5\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u4fee\u6b63\u3057\u3066Docker\u30c7\u30fc\u30e2\u30f3\u3092\u518d\u8d77\u52d5\u3057\u3001\u4eee\u60f3\u30d6\u30ea\u30c3\u30b8**docker0**\u306e\u8a2d\u5b9a\u3092\u9069\u5207\u306b\u5909\u66f4\u3059\u308b\u3002\n\n\u5168\u3066\u306e\u30db\u30b9\u30c8\u3067\u4e0b\u8a18\u306e\u624b\u9806\u3092\u5b9f\u884c\u3059\u308b\u3002\n\n```text:Docker\u30c7\u30fc\u30e2\u30f3\u505c\u6b62&docker0\u524a\u9664\nroot@flannel01:~# service docker stop\nroot@flannel01:~# ip link set dev docker0 down\nroot@flannel01:~# brctl delbr docker0\nroot@flannel01:~# iptables -t nat -F POSTROUTING\n```\n\n```text:Docker\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u4fee\u6b63\nroot@flannel01:~# sed -i -e '/^FLANNEL.*/d' /etc/default/docker\nroot@flannel01:~# sed -i -e '/^DOCKER_OPTS=\"$DOCKER_OPTS --bip=${FLANNEL_SUBNET} --mtu=${FLANNEL_MTU}\"$/d' /etc/default/docker\nroot@flannel01:~# cat /run/flannel/subnet.env >> /etc/default/docker\nroot@flannel01:~# echo 'DOCKER_OPTS=\"$DOCKER_OPTS --bip=${FLANNEL_SUBNET} --mtu=${FLANNEL_MTU}\"' >>  /etc/default/docker\n```\n\n```text:Docker\u30c7\u30fc\u30e2\u30f3\u8d77\u52d5\nroot@flannel01:~# service docker start\n```\n\n\u3053\u308c\u306b\u3088\u308a\u3001flannel\u304c\u5272\u308a\u5f53\u3066\u305f\u30b5\u30d6\u30cd\u30c3\u30c8\u3092\u5229\u7528\u3059\u308b\u3088\u3046\u306bdocker0\u306e\u8a2d\u5b9a\u304c\u5909\u66f4\u3055\u308c\u308b\u3002\n\n## \u30db\u30b9\u30c8\uff11\n\n```text:\u30db\u30b9\u30c8\uff11\u306e\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\nroot@flannel01:~# ip addr show docker0\n9: docker0: <NO-CARRIER,BROADCAST,MULTICAST,UP> mtu 1500 qdisc noqueue state DOWN group default \n    link/ether 56:84:7a:fe:97:99 brd ff:ff:ff:ff:ff:ff\n    inet 192.168.93.1/24 scope global docker0\n       valid_lft forever preferred_lft forever\nroot@flannel01:~# ip addr show flannel0\n8: flannel0: <POINTOPOINT,UP,LOWER_UP> mtu 1472 qdisc pfifo_fast state UNKNOWN group default qlen 500\n    link/none \n    inet 192.168.93.0/16 scope global flannel0\n       valid_lft forever preferred_lft forever\nroot@flannel01:~# ip route show\ndefault via X.X.X.X dev eth1 \n10.0.0.0/8 via 10.142.51.193 dev eth0 \n10.142.51.192/26 dev eth0  proto kernel  scope link  src 10.142.51.197 \nX.X.X.x/28 dev eth1  proto kernel  scope link  src X.X.X.X \n192.168.0.0/16 dev flannel0 \n192.168.93.0/24 dev docker0  proto kernel  scope link  src 192.168.93.1 \n```\n\n## \u30db\u30b9\u30c8\uff12\n\n```text:\u30db\u30b9\u30c8\uff12\u306e\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\nroot@flannel02:~# ip addr show docker0\n7: docker0: <NO-CARRIER,BROADCAST,MULTICAST,UP> mtu 1500 qdisc noqueue state DOWN group default \n    link/ether 56:84:7a:fe:97:99 brd ff:ff:ff:ff:ff:ff\n    inet 192.168.97.1/24 scope global docker0\n       valid_lft forever preferred_lft forever\nroot@flannel02:~# ip addr show flannel0\n6: flannel0: <POINTOPOINT,UP,LOWER_UP> mtu 1472 qdisc pfifo_fast state UNKNOWN group default qlen 500\n    link/none \n    inet 192.168.97.0/16 scope global flannel0\n       valid_lft forever preferred_lft forever\nroot@flannel02:~# ip route show\ndefault via Y.Y.Y.Y dev eth1 \n10.0.0.0/8 via 10.142.51.193 dev eth0 \n10.142.51.192/26 dev eth0  proto kernel  scope link  src 10.142.51.198 \nY.Y.Y.y/28 dev eth1  proto kernel  scope link  src Y.Y.Y.Y\n192.168.0.0/16 dev flannel0  proto kernel  scope link  src 192.168.97.0 \n192.168.97.0/24 dev docker0  proto kernel  scope link  src 192.168.97.1 \n````\n\n## \u30db\u30b9\u30c8\uff13\n\n```text:\u30db\u30b9\u30c8\uff13\u306e\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\nroot@flannel03:~# ip addr show docker0\n7: docker0: <NO-CARRIER,BROADCAST,MULTICAST,UP> mtu 1500 qdisc noqueue state DOWN group default \n    link/ether 56:84:7a:fe:97:99 brd ff:ff:ff:ff:ff:ff\n    inet 192.168.98.1/24 scope global docker0\n       valid_lft forever preferred_lft forever\nroot@flannel03:~# ip addr show flannel0\n6: flannel0: <POINTOPOINT,UP,LOWER_UP> mtu 1472 qdisc pfifo_fast state UNKNOWN group default qlen 500\n    link/none \n    inet 192.168.98.0/16 scope global flannel0\n       valid_lft forever preferred_lft forever\nroot@flannel03:~# ip route show\ndefault via Z.Z.Z.Z dev eth1 \n10.0.0.0/8 via 10.106.91.129 dev eth0 \n10.106.91.128/26 dev eth0  proto kernel  scope link  src 10.106.91.131 \nZ.Z.Z.z/28 dev eth1  proto kernel  scope link  src Z.Z.Z.Z \n192.168.0.0/16 dev flannel0  proto kernel  scope link  src 192.168.98.0 \n192.168.98.0/24 dev docker0  proto kernel  scope link  src 192.168.98.1 \n```\n\n\u3053\u3053\u307e\u3067\u3067docker0\u306e\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u304c\u9069\u5207\u306b\u518d\u8a2d\u5b9a\u3055\u308c\u3001**192.168.0.0/16**\u3068\u3044\u3046\u4eee\u60f3\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u304c\u6577\u8a2d\u3055\u308c\u308b\u3002\n\n![docker_networking_3_01.png](https://qiita-image-store.s3.amazonaws.com/0/37648/1a10e726-e255-6b8a-3b02-59f92c7f261e.png)\n\n\n# Docker\u30b3\u30f3\u30c6\u30ca\u8d77\u52d5\n\n\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\nfalnnel\u306f\u30b3\u30f3\u30c6\u30ca\u306b\u5272\u308a\u632f\u3089\u308c\u308bIP\u30a2\u30c9\u30ec\u30b9\u3092\u6307\u5b9a\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u306a\u3044\u305f\u3081\u3001Docker\u30b3\u30f3\u30c6\u30ca\u8d77\u52d5\u5f8c\u306b`docker inspect`\u3067IP\u30a2\u30c9\u30ec\u30b9\u3092\u8abf\u3079\u308b\u3002\n\n|\u30db\u30b9\u30c8|\u30b3\u30f3\u30c6\u30ca\u540d|Docker\u304c\u5272\u308a\u5f53\u3066\u305fIP\u30a2\u30c9\u30ec\u30b9||\n|:--|:--|:--|:--|\n|\u30db\u30b9\u30c81|httpd|192.168.93.2/24|apache2\u3092\u8d77\u52d5|\n|\u30db\u30b9\u30c81|client1|192.168.93.3/24||\n|\u30db\u30b9\u30c82|client2|192.168.97.2/24||\n|\u30db\u30b9\u30c83|client3|192.168.98.2/24||\n\n## \u30db\u30b9\u30c8\uff11\n\n```text:httpd\u8d77\u52d5\nroot@flannel01:~# HTTPD=$(docker run -d -i -t ubuntu:latest /bin/bash)\nroot@flannel01:~# docker inspect --format=\"{{.NetworkSettings.IPAddress}}/{{.NetworkSettings.IPPrefixLen}}\" $HTTPD\n192.168.93.2/24\n```\n\n```text:client1\u8d77\u52d5\nroot@flannel01:~# CLIENT1=$(docker run -d -i -t ubuntu:latest /bin/bash)\nroot@flannel01:~# docker inspect --format=\"{{.NetworkSettings.IPAddress}}/{{.NetworkSettings.IPPrefixLen}}\" $CLIENT1\n192.168.93.3/24\n```\n\n### httpd\u30b3\u30f3\u30c6\u30ca\n\n```text:httpd\u30b3\u30f3\u30c6\u30ca\u306e\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\nroot@flannel01:~# docker attach $HTTPD\n\nroot@7ba62b092066:/# ip addr show eth0\n10: eth0: <BROADCAST,UP,LOWER_UP> mtu 1472 qdisc noqueue state UP group default \n    link/ether 02:42:c0:a8:5d:02 brd ff:ff:ff:ff:ff:ff\n    inet 192.168.93.2/24 scope global eth0\n       valid_lft forever preferred_lft forever\n    inet6 fe80::42:c0ff:fea8:5d02/64 scope link \n       valid_lft forever preferred_lft forever\n\nroot@7ba62b092066:/# ip route show\ndefault via 192.168.93.1 dev eth0 \n192.168.93.0/24 dev eth0  proto kernel  scope link  src 192.168.93.2\n```\n\n```text:apache2\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\nroot@7ba62b092066:/# apt-get install apache2 -y\nroot@7ba62b092066:/# apachectl start\n```\n\n### client1\u30b3\u30f3\u30c6\u30ca\n\n```text:client1\u30b3\u30f3\u30c6\u30ca\u306e\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\nroot@flannel01:~# docker attach $CLIENT1\n\nroot@0914ea0ca6ab:/# ip addr show eth0\n12: eth0: <BROADCAST,UP,LOWER_UP> mtu 1472 qdisc noqueue state UP group default \n    link/ether 02:42:c0:a8:5d:03 brd ff:ff:ff:ff:ff:ff\n    inet 192.168.93.3/24 scope global eth0\n       valid_lft forever preferred_lft forever\n    inet6 fe80::42:c0ff:fea8:5d03/64 scope link \n       valid_lft forever preferred_lft forever\n\nroot@0914ea0ca6ab:/# ip route show\ndefault via 192.168.93.1 dev eth0 \n192.168.93.0/24 dev eth0  proto kernel  scope link  src 192.168.93.3 \n```\n\n```text:curl\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\nroot@0914ea0ca6ab:/# apt-get install curl -y\n```\n\n## \u30db\u30b9\u30c8\uff12\n\n```text:client2\u8d77\u52d5\nroot@flannel02:~# CLIENT2=$(docker run -d -i -t ubuntu:latest /bin/bash)\nroot@flannel02:~# docker inspect --format=\"{{.NetworkSettings.IPAddress}}/{{.NetworkSettings.IPPrefixLen}}\" $CLIENT2\n192.168.97.2/24\n```\n\n### client2\u30b3\u30f3\u30c6\u30ca\n\n```text:client2\u30b3\u30f3\u30c6\u30ca\u306e\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\nroot@flannel02:~# docker attach $CLIENT2\n\nroot@d875be3ae788:/# ip addr show eth0\n8: eth0: <BROADCAST,UP,LOWER_UP> mtu 1472 qdisc noqueue state UP group default \n    link/ether 02:42:c0:a8:61:02 brd ff:ff:ff:ff:ff:ff\n    inet 192.168.97.2/24 scope global eth0\n       valid_lft forever preferred_lft forever\n    inet6 fe80::42:c0ff:fea8:6102/64 scope link \n       valid_lft forever preferred_lft forever\n\nroot@d875be3ae788:/# ip route show\ndefault via 192.168.97.1 dev eth0 \n192.168.97.0/24 dev eth0  proto kernel  scope link  src 192.168.97.2\n```\n\n```text:curl\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\nroot@d875be3ae788:/# apt-get install curl -y\n```\n\n## \u30db\u30b9\u30c8\uff13\n\n```text:client3\u8d77\u52d5\nroot@flannel03:~# CLIENT3=$(docker run -d -i -t ubuntu:latest /bin/bash)\nroot@flannel03:~# docker inspect --format=\"{{.NetworkSettings.IPAddress}}/{{.NetworkSettings.IPPrefixLen}}\" $CLIENT3\n192.168.98.2/24\n```\n\n### client3\u30b3\u30f3\u30c6\u30ca\n\n```text:client3\u30b3\u30f3\u30c6\u30ca\u306e\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\nroot@flannel03:~# docker attach $CLIENT3\n\nroot@6e553d2a2ad1:/# ip addr show eth0\n9: eth0: <BROADCAST,UP,LOWER_UP> mtu 1472 qdisc noqueue state UP group default \n    link/ether 02:42:c0:a8:62:02 brd ff:ff:ff:ff:ff:ff\n    inet 192.168.98.2/24 scope global eth0\n       valid_lft forever preferred_lft forever\n    inet6 fe80::42:c0ff:fea8:6202/64 scope link \n       valid_lft forever preferred_lft forever\n\nroot@6e553d2a2ad1:/# ip route show\ndefault via 192.168.98.1 dev eth0 \n192.168.98.0/24 dev eth0  proto kernel  scope link  src 192.168.98.2 \n```\n\n```text:curl\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\nroot@6e553d2a2ad1:/# apt-get install curl -y\n```\n\n![docker_networking_3_02.png](https://qiita-image-store.s3.amazonaws.com/0/37648/f3724dc7-a9d9-37b2-f118-31394105296c.png)\n\n\n# \u758e\u901a\u78ba\u8a8d\n\u3053\u3053\u307e\u3067\u3067\u3001\u8907\u6570\u30db\u30b9\u30c8\u3092\u307e\u305f\u304c\u3063\u3066\u6577\u8a2d\u3055\u308c\u305f192.168.0.0/16\u3068\u3044\u3046\u4eee\u60f3\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u4e0a\u306b4\u3064\u306e\u30b3\u30f3\u30c6\u30ca\u304c\u8d77\u52d5\u3057\u305f\u3002\u30b3\u30f3\u30c6\u30ca\u3084\u30db\u30b9\u30c8\u304b\u3089\u758e\u901a\u78ba\u8a8d\u3092\u884c\u3046\u3002\n\n\u203b\u30d1\u30b1\u30c3\u30c8\u306fflanneld\u304c\u30ab\u30d7\u30bb\u30eb\u5316\u3057\u3066\u304a\u308a\u3001\u304b\u3064etcd\u304c\u30cf\u30fc\u30c8\u30d3\u30fc\u30c8\u3092\u983b\u7e41\u306b\u9001\u308a\u5408\u3063\u3066\u3044\u308b\u305f\u3081\u3001tcpdump\u3092\u4ed5\u639b\u3051\u3066\u3082\u3069\u308c\u304c\u30b3\u30f3\u30c6\u30ca\u304b\u3089\u306e\u30d1\u30b1\u30c3\u30c8\u306a\u306e\u304b\u5224\u5225\u3067\u304d\u306a\u3044\u3002\u3002\u3002\n\n```\nroot@flannel01:~# tcpdump -v -i eth0 src host 10.142.51.198\ntcpdump: listening on eth0, link-type EN10MB (Ethernet), capture size 65535 bytes\n04:44:10.100921 IP (tos 0x0, ttl 64, id 26599, offset 0, flags [DF], proto TCP (6), length 75)\n    10.142.51.198.2380 > 10.142.51.197.36000: Flags [P.], cksum 0xa8e2 (correct), seq 2675:2698, ack 1, win 235, options [nop,nop,TS val 6265207 ecr 6596379], length 23\n04:44:10.103224 IP (tos 0x0, ttl 64, id 51049, offset 0, flags [DF], proto TCP (6), length 52)\n    10.142.51.198.46572 > 10.142.51.197.2380: Flags [.], cksum 0x5e92 (correct), ack 9388, win 257, options [nop,nop,TS val 6265207 ecr 6596504], length 0\n04:44:10.103439 IP (tos 0x0, ttl 64, id 26600, offset 0, flags [DF], proto TCP (6), length 75)\n    10.142.51.198.2380 > 10.142.51.197.36000: Flags [P.], cksum 0xa74f (correct), seq 2698:2721, ack 1, win 235, options [nop,nop,TS val 6265207 ecr 6596503], length 23\n04:44:10.105420 IP (tos 0x0, ttl 64, id 51050, offset 0, flags [DF], proto TCP (6), length 52)\n    10.142.51.198.46572 > 10.142.51.197.2380: Flags [.], cksum 0x5e54 (correct), ack 9449, win 257, options [nop,nop,TS val 6265208 ecr 6596504], length 0\n...\n```\n\n## \u30db\u30b9\u30c8\uff11 \u2192 httpd\u30b3\u30f3\u30c6\u30ca\n\nhttpd\u30b3\u30f3\u30c6\u30ca\u306f\u30db\u30b9\u30c81\u4e0a\u306e\u4eee\u60f3\u30d6\u30ea\u30c3\u30b8docker0\u306b\u3064\u306a\u304c\u3063\u3066\u3044\u308b\u305f\u3081\u3001\u305d\u306e\u307e\u307e\u901a\u4fe1\u3067\u304d\u308b\u3002\n\n```text:ping(\u30db\u30b9\u30c8\uff11\u2192httpd\u30b3\u30f3\u30c6\u30ca)\nroot@flannel01:~# ping 192.168.93.2\nPING 192.168.93.2 (192.168.93.2) 56(84) bytes of data.\n64 bytes from 192.168.93.2: icmp_seq=1 ttl=64 time=0.044 ms\n64 bytes from 192.168.93.2: icmp_seq=2 ttl=64 time=0.038 ms\n...\n```\n\n```text:HTTP(\u30db\u30b9\u30c8\uff11\u2192httpd\u30b3\u30f3\u30c6\u30ca\uff09\nroot@flannel01:~# curl 192.168.93.2\n\n<!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.0 Transitional//EN\" \"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\">\n<html xmlns=\"http://www.w3.org/1999/xhtml\">\n...\n```\n\n## client1\u30b3\u30f3\u30c6\u30ca \u2192 httpd\u30b3\u30f3\u30c6\u30ca\n\nclient1\u30b3\u30f3\u30c6\u30ca\u3068httpd\u30b3\u30f3\u30c6\u30ca\u306f\u540c\u3058\u4eee\u60f3\u30d6\u30ea\u30c3\u30b8docker0\u306b\u3064\u306a\u304c\u3063\u3066\u3044\u308b\u305f\u3081\u3001\u305d\u306e\u307e\u307e\u901a\u4fe1\u3067\u304d\u308b\u3002\n\n```text:ping(client1\u30b3\u30f3\u30c6\u30ca\u2192httpd\u30b3\u30f3\u30c6\u30ca\uff09\nroot@0914ea0ca6ab:/# ping 192.168.93.2\nPING 192.168.93.2 (192.168.93.2) 56(84) bytes of data.\n64 bytes from 192.168.93.2: icmp_seq=1 ttl=64 time=0.059 ms\n64 bytes from 192.168.93.2: icmp_seq=2 ttl=64 time=0.050 ms\n...\n```\n\n```text:HTTP(client1\u30b3\u30f3\u30c6\u30ca\u2192httpd\u30b3\u30f3\u30c6\u30ca\uff09\nroot@0914ea0ca6ab:/# curl 192.168.93.2\n\n<!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.0 Transitional//EN\" \"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\">\n<html xmlns=\"http://www.w3.org/1999/xhtml\">\n...\n```\n\n## \u30db\u30b9\u30c82 \u2192 httpd\u30b3\u30f3\u30c6\u30ca\n\nflanneld\u306b\u3088\u3063\u3066\u30d1\u30b1\u30c3\u30c8\u304c\u30e9\u30c3\u30d7\u3055\u308c\u3001\u540c\u4e00VLAN\u306e\u30db\u30b9\u30c8\uff11\u4e0a\u306ehttpd\u30b3\u30f3\u30c6\u30ca\u3068\u901a\u4fe1\u3067\u304d\u308b\u3002\n\n```text:ping(\u30db\u30b9\u30c82\u2192httpd\u30b3\u30f3\u30c6\u30ca)\nroot@flannel02:~# ping 192.168.93.2\nPING 192.168.93.2 (192.168.93.2) 56(84) bytes of data.\n64 bytes from 192.168.93.2: icmp_seq=1 ttl=61 time=0.616 ms\n64 bytes from 192.168.93.2: icmp_seq=2 ttl=61 time=0.317 ms\n...\n```\n\n```text:HTTP(\u30db\u30b9\u30c82\u2192httpd\u30b3\u30f3\u30c6\u30ca)\nroot@flannel02:~# curl 192.168.93.2\n\n<!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.0 Transitional//EN\" \"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\">\n<html xmlns=\"http://www.w3.org/1999/xhtml\">\n...\n```\n\n## client2\u30b3\u30f3\u30c6\u30ca \u2192 httpd\u30b3\u30f3\u30c6\u30ca\n\nflanneld\u306b\u3088\u3063\u3066\u30d1\u30b1\u30c3\u30c8\u304c\u30e9\u30c3\u30d7\u3055\u308c\u3001\u540c\u4e00VLAN\u306e\u30db\u30b9\u30c8\uff11\u4e0a\u306ehttpd\u30b3\u30f3\u30c6\u30ca\u3068\u901a\u4fe1\u3067\u304d\u308b\u3002\n\n```text:ping(client2\u30b3\u30f3\u30c6\u30ca\u2192httpd\u30b3\u30f3\u30c6\u30ca)\nroot@d875be3ae788:/# ping 192.168.93.2\nPING 192.168.93.2 (192.168.93.2) 56(84) bytes of data.\n64 bytes from 192.168.93.2: icmp_seq=1 ttl=60 time=0.728 ms\n64 bytes from 192.168.93.2: icmp_seq=2 ttl=60 time=0.314 ms\n...\n```\n\n```text:HTTP(client2\u30b3\u30f3\u30c6\u30ca\u2192httpd\u30b3\u30f3\u30c6\u30ca)\nroot@d875be3ae788:/# curl 192.168.93.2\n\n<!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.0 Transitional//EN\" \"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\">\n<html xmlns=\"http://www.w3.org/1999/xhtml\">\n...\n```\n\n## \u30db\u30b9\u30c83 \u2192 httpd\u30b3\u30f3\u30c6\u30ca\n\nflanneld\u306b\u3088\u3063\u3066\u30d1\u30b1\u30c3\u30c8\u304c\u30e9\u30c3\u30d7\u3055\u308c\u3001\u7570\u306a\u308bVLAN\u306e\u30db\u30b9\u30c8\uff11\u4e0a\u306ehttpd\u30b3\u30f3\u30c6\u30ca\u3068\u901a\u4fe1\u3067\u304d\u308b\u3002\n\n```text:ping(\u30db\u30b9\u30c83\u2192httpd\u30b3\u30f3\u30c6\u30ca)\nroot@flannel03:~# ping 192.168.93.2\nPING 192.168.93.2 (192.168.93.2) 56(84) bytes of data.\n64 bytes from 192.168.93.2: icmp_seq=1 ttl=61 time=1.82 ms\n64 bytes from 192.168.93.2: icmp_seq=2 ttl=61 time=1.52 ms\n...\n```\n\n```text:HTTP(\u30db\u30b9\u30c83\u2192httpd\u30b3\u30f3\u30c6\u30ca)\nroot@flannel03:~# curl 192.168.93.2\n\n<!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.0 Transitional//EN\" \"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\">\n<html xmlns=\"http://www.w3.org/1999/xhtml\">\n...\n```\n\n## clien3\u30b3\u30f3\u30c6\u30ca \u2192 httpd\u30b3\u30f3\u30c6\u30ca\n\nflanneld\u306b\u3088\u3063\u3066\u30d1\u30b1\u30c3\u30c8\u304c\u30e9\u30c3\u30d7\u3055\u308c\u3001\u7570\u306a\u308bVLAN\u306e\u30db\u30b9\u30c8\uff11\u4e0a\u306ehttpd\u30b3\u30f3\u30c6\u30ca\u3068\u901a\u4fe1\u3067\u304d\u308b\u3002\n\n```text:ping(client3\u30b3\u30f3\u30c6\u30ca\u2192httpd\u30b3\u30f3\u30c6\u30ca)\nroot@6e553d2a2ad1:/# ping 192.168.93.2\nPING 192.168.93.2 (192.168.93.2) 56(84) bytes of data.\n64 bytes from 192.168.93.2: icmp_seq=1 ttl=60 time=1.86 ms\n64 bytes from 192.168.93.2: icmp_seq=2 ttl=60 time=1.62 ms\n...\n```\n\n```text:HTTP(client3\u30b3\u30f3\u30c6\u30ca\u2192httpd\u30b3\u30f3\u30c6\u30ca)\nroot@6e553d2a2ad1:/# curl 192.168.93.2\n\n<!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.0 Transitional//EN\" \"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\">\n<html xmlns=\"http://www.w3.org/1999/xhtml\">\n...\n```\n\n# \u307e\u3068\u3081\netcd\u3068flannel\u3092\u7528\u3044\u308b\u3053\u3068\u3067\u3001L2 & L3\u3067\u63a5\u7d9a\u3055\u308c\u305f\u8907\u6570\u30db\u30b9\u30c8\u9593\u306b\u4eee\u60f3\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u3092\u6577\u8a2d\u3057\u3066Docker\u30b3\u30f3\u30c6\u30ca\u3092\u6240\u5c5e\u3055\u305b\u3001\u76f8\u4e92\u306b\u901a\u4fe1\u3055\u305b\u308b\u3053\u3068\u304c\u3067\u304d\u305f\u3002\n\u305f\u3060\u3057etcd+flannel\u306fDocker\u30b3\u30f3\u30c6\u30ca\u306eIP\u30a2\u30c9\u30ec\u30b9\u3092\u660e\u793a\u7684\u306b\u6307\u5b9a\u3059\u308b\uff08\u3042\u308b\u3044\u306fDHCP\u3092\u6307\u5b9a\u3059\u308b\uff09\u3053\u3068\u304c\u3067\u304d\u306a\u3044\u305f\u3081\u3001\u6ce8\u610f\u304c\u5fc5\u8981\u3067\u3042\u308b\u3002\n"}