{"tags": ["docker", "CI", "drone.io"], "context": " More than 1 year has passed since last update.\n\n\u6982\u8981\n\u30ec\u30dd\u30b8\u30c8\u30ea\u306e Dockerfile \u3092\u66f4\u65b0\u3057\u305f\u3089\u81ea\u52d5\u3067 Docker Image \u3092\u30c6\u30b9\u30c8/\u30d3\u30eb\u30c9\u3057\u3066 Registry \u306b Push \u3059\u308b\u307e\u3067\u306e\u74b0\u5883\u3092\u69cb\u7bc9\n\u203bDocker \u30b3\u30f3\u30c6\u30ca\u5185\u3067 Docke Image \u3092\u30d3\u30eb\u30c9\u3059\u308b\u305f\u3081\u3001 Docker in Docker \u306a\u74b0\u5883\u304c\u5fc5\u8981\n\u53c2\u8003\nhttp://paislee.io/how-to-build-and-deploy-docker-images-with-drone/\n\n\u74b0\u5883\nOS : CentOS Linux release 7.1\nDocker : 1.8.2, build bb472f0/1.8.2\nDocker : Registry: 2.0\ndrone : 0.3.0-alpha\n\u203bDrone, Docker Registry\u7b49 \u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u306f\u5272\u611b\n\n\u30d3\u30eb\u30c9\u30b3\u30f3\u30c6\u30ca\nalpine \u30d9\u30fc\u30b9\u3067 DockerImage \u3092\u4f5c\u6210\n\nDockerfile\nFROM alpine:3.2\n\nRUN apk add --update \\\n        curl \\\n                bash \\\n                openssh \\\n                perl \\\n                git \\\n                btrfs-progs \\\n                e2fsprogs \\\n                iptables \\\n                xz \\\n    && rm -rf /var/cache/apk/*\n\nENV DOCKER_BUCKET get.docker.com\nENV DOCKER_VERSION 1.8.2\nENV DOCKER_SHA256 97a3f5924b0b831a310efa8bf0a4c91956cd6387c4a8667d27e2b2dd3da67e4d\n\nRUN curl -fSL \"https://${DOCKER_BUCKET}/builds/Linux/x86_64/docker-$DOCKER_VERSION\" -o /usr/local/bin/docker \\\n    && echo \"${DOCKER_SHA256}  /usr/local/bin/docker\" | sha256sum -c - \\\n    && chmod +x /usr/local/bin/docker\n\nENV DIND_COMMIT b8bed8832b77a478360ae946a69dab5e922b194e\n\nRUN wget \"https://raw.githubusercontent.com/docker/docker/${DIND_COMMIT}/hack/dind\" -O /usr/local/bin/dind \\\n    && chmod +x /usr/local/bin/dind\n\nADD ./binary/dmsetup /usr/local/bin/dmsetup\nRUN chmod +x /usr/local/bin/dmsetup\n\nVOLUME /var/lib/docker\nCMD [\"wrapdocker\"]\n\n\n\n\u30ec\u30dd\u30b8\u30c8\u30ea\u306e\u69cb\u6210\n/my-repository:branch\n|--.drone.yml\n|\n|--/.drone\n|  |--build.sh\n|\n|--Dockerfile\n\n\u203bbranch \u3067 \u5404 Dockerfile \u3092\u7ba1\u7406\n\n.drone.yml\n\n.drone.yml\nimage: docker-registry:5000/dind\nenv:\n  - DOCKER_DAEMON_ARGS=--insecure-registry docker-registry:5000\nscript:  \n  - ./.drone/build.sh\nnotify:\n  slack:\n    webhook_url: 'https://hooks.slack.com/services/\u2026\n    channel: '#my-channel'\n    username: 'drone.io'\n\n\n\u203bimage \u306f alpine \u3092\u30d9\u30fc\u30b9\u306b dind(wrapdocker) \u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u305f\u30b3\u30f3\u30c6\u30ca\u3092\u4f7f\u7528\n\u203bregistry \u306b push \u3059\u308b\u969b\u306b\u30a8\u30e9\u30fc\u3068\u306a\u308b\u305f\u3081\u3001DOCKER_DAEMON_ARGS \u306b insecure-registry \u30aa\u30d7\u30b7\u30e7\u30f3\u3092\u6307\u5b9a\n\u3000(\u672c\u5f53\u306f\u3061\u3083\u3093\u3068\u8a3c\u660e\u66f8\u3092\u7528\u610f\u3057\u305f\u65b9\u304c\u826f\u3044)\n\u203b\u901a\u77e5\u306f Slack \u306b\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u6d41\u3059\n\n\u30d3\u30eb\u30c9\u30b9\u30af\u30ea\u30d7\u30c8\n\nbuild.sh\n#!/bin/bash\nset -e  \ncd /var/cache/drone/src/path/to/dockerfile\n\n/usr/local/bin/wrapdocker &  \nsleep 60\n\ndocker build -t docker-registry:5000/$DRONE_BRANCH .\ndocker push docker-registry:5000/$DRONE_BRANCH\n\n\n\u203bimage \u306f branch \u540d\u3092\u3064\u3051\u308b\n\u203b\u74b0\u5883\u306b\u3088\u3063\u3066\u306f wrapdocker \u306e\u8d77\u52d5\u306b\u6642\u9593\u304c\u304b\u304b\u308b\u5834\u5408\u3082\u3042\u3063\u305f\u305f\u3081 sleep \u306f\u9577\u3081\u306b\u8a2d\u5b9a\ndind \u306f privileged \u30aa\u30d7\u30b7\u30e7\u30f3\u304c\u5fc5\u8981\u306a\u305f\u3081\u3001\u4e8b\u524d\u306b drone \u5074\u306e\u30ec\u30dd\u30b8\u30c8\u30ea\u8a2d\u5b9a\u3092 privileged \u3092\u6709\u52b9\u306b\u3057\u3066\u304a\u304f\n  \"private\": true,\n  \"privileged\": true,\n  \"post_commits\": true,\n\n\n\u5b9f\u884c\nDockerfile \u3092\u9069\u5f53\u306b\u4fee\u6b63\u3057\u3066 push \u3059\u308b\u3068\u81ea\u52d5\u7684\u306b\u30c6\u30b9\u30c8\u304c\u5b9f\u884c\n\n\u30ec\u30dd\u30b8\u30c8\u30ea\u306e Dockerfile \u3092\u66f4\u65b0\u3057\u305f\u3089\u81ea\u52d5\u3067 Registry \u306b Push \u3055\u308c\u308b\u305f\u3081\u3001Registry \u4e0a\u306e Docker Image \u306f\u5e38\u306b\u6700\u65b0\u306e\u72b6\u614b\u306b\u306a\u308b\n# \u6982\u8981\n\u30ec\u30dd\u30b8\u30c8\u30ea\u306e Dockerfile \u3092\u66f4\u65b0\u3057\u305f\u3089\u81ea\u52d5\u3067 Docker Image \u3092\u30c6\u30b9\u30c8/\u30d3\u30eb\u30c9\u3057\u3066 Registry \u306b Push \u3059\u308b\u307e\u3067\u306e\u74b0\u5883\u3092\u69cb\u7bc9\n\u203bDocker \u30b3\u30f3\u30c6\u30ca\u5185\u3067 Docke Image \u3092\u30d3\u30eb\u30c9\u3059\u308b\u305f\u3081\u3001 Docker in Docker \u306a\u74b0\u5883\u304c\u5fc5\u8981\n\n\u53c2\u8003\nhttp://paislee.io/how-to-build-and-deploy-docker-images-with-drone/\n\n# \u74b0\u5883\nOS : CentOS Linux release 7.1\nDocker : 1.8.2, build bb472f0/1.8.2\nDocker : Registry: 2.0\ndrone : 0.3.0-alpha\n\n\u203bDrone, Docker Registry\u7b49 \u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u306f\u5272\u611b\n\n# \u30d3\u30eb\u30c9\u30b3\u30f3\u30c6\u30ca\nalpine \u30d9\u30fc\u30b9\u3067 DockerImage \u3092\u4f5c\u6210\n\n```:Dockerfile\nFROM alpine:3.2\n\nRUN apk add --update \\\n\t\tcurl \\\n                bash \\\n                openssh \\\n                perl \\\n                git \\\n                btrfs-progs \\\n                e2fsprogs \\\n                iptables \\\n                xz \\\n\t&& rm -rf /var/cache/apk/*\n\nENV DOCKER_BUCKET get.docker.com\nENV DOCKER_VERSION 1.8.2\nENV DOCKER_SHA256 97a3f5924b0b831a310efa8bf0a4c91956cd6387c4a8667d27e2b2dd3da67e4d\n\nRUN curl -fSL \"https://${DOCKER_BUCKET}/builds/Linux/x86_64/docker-$DOCKER_VERSION\" -o /usr/local/bin/docker \\\n\t&& echo \"${DOCKER_SHA256}  /usr/local/bin/docker\" | sha256sum -c - \\\n\t&& chmod +x /usr/local/bin/docker\n\nENV DIND_COMMIT b8bed8832b77a478360ae946a69dab5e922b194e\n\nRUN wget \"https://raw.githubusercontent.com/docker/docker/${DIND_COMMIT}/hack/dind\" -O /usr/local/bin/dind \\\n\t&& chmod +x /usr/local/bin/dind\n\nADD ./binary/dmsetup /usr/local/bin/dmsetup\nRUN chmod +x /usr/local/bin/dmsetup\n\nVOLUME /var/lib/docker\nCMD [\"wrapdocker\"]\n```\n\n# \u30ec\u30dd\u30b8\u30c8\u30ea\u306e\u69cb\u6210\n\n```\n/my-repository:branch\n|--.drone.yml\n|\n|--/.drone\n|  |--build.sh\n|\n|--Dockerfile\n```\n\u203bbranch \u3067 \u5404 Dockerfile \u3092\u7ba1\u7406\n\n\n# .drone.yml\n```yaml:.drone.yml\nimage: docker-registry:5000/dind\nenv:\n  - DOCKER_DAEMON_ARGS=--insecure-registry docker-registry:5000\nscript:  \n  - ./.drone/build.sh\nnotify:\n  slack:\n    webhook_url: 'https://hooks.slack.com/services/\u2026\n    channel: '#my-channel'\n    username: 'drone.io'\n```\n\u203bimage \u306f alpine \u3092\u30d9\u30fc\u30b9\u306b dind(wrapdocker) \u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u305f\u30b3\u30f3\u30c6\u30ca\u3092\u4f7f\u7528\n\u203bregistry \u306b push \u3059\u308b\u969b\u306b\u30a8\u30e9\u30fc\u3068\u306a\u308b\u305f\u3081\u3001DOCKER_DAEMON_ARGS \u306b insecure-registry \u30aa\u30d7\u30b7\u30e7\u30f3\u3092\u6307\u5b9a\n\u3000(\u672c\u5f53\u306f\u3061\u3083\u3093\u3068\u8a3c\u660e\u66f8\u3092\u7528\u610f\u3057\u305f\u65b9\u304c\u826f\u3044)\n\u203b\u901a\u77e5\u306f Slack \u306b\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u6d41\u3059\n\n# \u30d3\u30eb\u30c9\u30b9\u30af\u30ea\u30d7\u30c8\n```bash:build.sh\n#!/bin/bash\nset -e  \ncd /var/cache/drone/src/path/to/dockerfile\n\n/usr/local/bin/wrapdocker &  \nsleep 60\n\ndocker build -t docker-registry:5000/$DRONE_BRANCH .\ndocker push docker-registry:5000/$DRONE_BRANCH\n```\n\u203bimage \u306f branch \u540d\u3092\u3064\u3051\u308b\n\u203b\u74b0\u5883\u306b\u3088\u3063\u3066\u306f wrapdocker \u306e\u8d77\u52d5\u306b\u6642\u9593\u304c\u304b\u304b\u308b\u5834\u5408\u3082\u3042\u3063\u305f\u305f\u3081 sleep \u306f\u9577\u3081\u306b\u8a2d\u5b9a\n\n\ndind \u306f privileged \u30aa\u30d7\u30b7\u30e7\u30f3\u304c\u5fc5\u8981\u306a\u305f\u3081\u3001\u4e8b\u524d\u306b drone \u5074\u306e\u30ec\u30dd\u30b8\u30c8\u30ea\u8a2d\u5b9a\u3092 privileged \u3092\u6709\u52b9\u306b\u3057\u3066\u304a\u304f\n\n```\n  \"private\": true,\n  \"privileged\": true,\n  \"post_commits\": true,\n```\n\n# \u5b9f\u884c\nDockerfile \u3092\u9069\u5f53\u306b\u4fee\u6b63\u3057\u3066 push \u3059\u308b\u3068\u81ea\u52d5\u7684\u306b\u30c6\u30b9\u30c8\u304c\u5b9f\u884c\n\n![01.png](https://qiita-image-store.s3.amazonaws.com/0/105824/f5b0468e-b8a9-0e84-190c-4a99588e7b6b.png)\n\n\n\n\u30ec\u30dd\u30b8\u30c8\u30ea\u306e Dockerfile \u3092\u66f4\u65b0\u3057\u305f\u3089\u81ea\u52d5\u3067 Registry \u306b Push \u3055\u308c\u308b\u305f\u3081\u3001Registry \u4e0a\u306e Docker Image \u306f\u5e38\u306b\u6700\u65b0\u306e\u72b6\u614b\u306b\u306a\u308b\n\n\n"}