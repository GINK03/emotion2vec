{"context": "\n\n1. \u69cb\u6210\n\u30fb3\u53f0\u69cb\u6210(VMware\u4e0a\u306e\u4eee\u60f3\u30de\u30b7\u30f3)\n\u30fb\u4eee\u60f3\u30de\u30b7\u30f3\u306eOS\u306fCentOS7.2\u3001etcd\u306e\u7248\u6570\u306fversion 2.3.7\n\u30fb\u30db\u30b9\u30c8\u540d\u306f\u3001master1,master2,master3\n\u30fbDB(\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\uff09\u306f\u3001etcd\u30c7\u30fc\u30e2\u30f3\u306e\u8d77\u52d5\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306b\u4f5c\u6210\u3055\u308c\u308b\u3002\n\n\n\netcd\u30c7\u30fc\u30e2\u30f3\u304c\u4f7f\u3046\u30dd\u30fc\u30c8\u756a\u53f7v2(v1)\n\u7528\u9014\n\n\n\n\n2379(4001)\netcdctl\u30b3\u30de\u30f3\u30c9\u306e\u3088\u3046\u306a\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u3068\u306e\u901a\u4fe1\u306b\u4f7f\u3046\n\n\n2380(7001)\netcd\u30af\u30e9\u30b9\u30bf\u306e\u4e2d\u3067\u3001\u3069\u306eetcd\u3092\u30ea\u30fc\u30c0\u306b\u3059\u308b\u304b?\u3001\u3068\u3044\u3063\u305f\u3088\u3046\u306a\u5236\u5fa1\u60c5\u5831\u306e\u3084\u308a\u3068\u308a\u306b\u4f7f\u3046\n\n\n\n\n\n  +------ master1(CentOS7.2) -----------+   +- master2(CentOS7.2) -+   +- master3(CentOS7.2) -+\n  |                                     |   |                      |   |                      |\n  |  +- etcdctl -+   +----- etcd ----+  |   |  +----- etcd ----+   |   |   +----- etcd ----+  |\n  |  |           |   |               |  |   |  |               |   |   |   |               |  |\n  |  |           |   |               |  |   |  |               |   |   |   |               |  |\n  |  +-----------+   +- 2379 - 2380 -+  |   |  +- 2379 - 2380 -+   |   |   +- 2379 - 2380 -+  |\n  |        A                     A      |   |               A      |   |      A         A     |\n  |        |     +----+          |      |   |       +----+  |      |   |      | +----+  |     |\n  |        |     | DB |          |      |   |       | DB |  |      |   |      | | DB |  |     |\n  |        |     +----+   +------+      |   |       +----+  |      |   |      | +----+  |     |\n  |        |              |             |   |               |      |   |      |         |     |\n  +--------|----- eth0 ---|-------------+   +-------- eth0 -|------+   +------|- eth0 --|-----+\n           |        |     |                            |    |                 |   |     |\n           |        |     |                            |    |                 |   |     |\n           |        |     |                            |    |                 |   |     |\n  +--------|--------+-----|------- \u4eee\u60f3\u30b9\u30a4\u30c3\u30c1 --------+----|-----------------|---+-----|-----+\n  |        |              |                                 |                 |         |     |\n  |        |              +=================================+=================|=========+     |\n  |        |                                                                  |               |\n  |        +==================================================================+               |\n  |                                                                                           |\n  +-------------------------------------------------------------------------------------------+\n\n\n\n\n2. etcd\u30af\u30e9\u30b9\u30bf\u306e\u69cb\u7bc9\u65b9\u6cd5\n\u3053\u3053\u3067\u306f\u3001static\u65b9\u5f0f\u306b\u3064\u3044\u3066\u8aac\u660e\u3092\u3059\u308b\u3002\n\n\n\n\u65b9\u5f0f\n\u5185\u5bb9\n\n\n\n\nstatic\n\u3042\u3089\u304b\u3058\u3081\u30af\u30e9\u30b9\u30bf\u306e\u30e1\u30f3\u30d0\u3092\u5b9a\u7fa9\u30d5\u30a1\u30a4\u30eb\u306b\u6307\u5b9a\u3057\u3066\u304a\u304f\n\n\netcd discovery\nhttp://qiita.com/hana_shin/items/f8de83a8cc91adae6262\n\n\nDNS  discovery\n\u8abf\u67fb\u4e2d\n\n\n\n\n3. \u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u30d1\u30c3\u30b1\u30fc\u30b8\n\u4eee\u60f3\u30de\u30b7\u30f3\u306betcd\u30d1\u30c3\u30b1\u30fc\u30b8\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u3002\n[root@master1 ~]# yum -y install etcd\n[root@master2 ~]# yum -y install etcd\n[root@master3 ~]# yum -y install etcd\n\n\n4. \u8a2d\u5b9a\u5185\u5bb9\n\n4.1 \u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3068\u8a2d\u5b9a\u5185\u5bb9\n/etc/etcd/etcd.conf\n\n\n\n\u9805\u76ee\n\u610f\u5473\n\n\n\n\nETCD_NAME\n\u30db\u30b9\u30c8\u540d\u3092\u8a2d\u5b9a\u3059\u308b\n\n\nETCD_DATA_DIR\nDB\u306e\u30d1\u30b9\u3092\u8a2d\u5b9a\u3059\u308b\u3002\u30c7\u30d5\u30a9\u30eb\u30c8\u306e\u30d1\u30b9\u306fvar/lib/etcd/default.etcd\n\n\nETCD_LISTEN_PEER_URLS\netcd\u30c7\u30fc\u30e2\u30f3\u9593\u306e\u9001\u53d7\u4fe1\u306b\u4f7f\u3046IP\u30a2\u30c9\u30ec\u30b9\u3068\u30dd\u30fc\u30c8\u756a\u53f7\u3092\u8a2d\u5b9a\u3059\u308b\n\n\nETCD_INITIAL_CLUSTER\netcd\u30af\u30e9\u30b9\u30bf\u306e\u30e1\u30f3\u30d0\u3092\u8a2d\u5b9a\u3059\u308b\u3002\n\n\nETCD_INITIAL_CLUSTER_STATE\nnew\u3092\u8a2d\u5b9a\u3059\u308b\n\n\nETCD_INITIAL_CLUSTER_TOKEN\netcd\u30af\u30e9\u30b9\u30bf\u3092\u8b58\u5225\u3059\u308b\u305f\u3081\u306e\u6587\u5b57\u5217\u3002\u540c\u4e00\u30af\u30e9\u30b9\u30bf\u5185\u306e\u30e1\u30f3\u30d0\u306f\u540c\u3058\u6587\u5b57\u5217\u3092\u8a2d\u5b9a\u3059\u308b\n\n\n\n\n4.2 master1\u306e\u8a2d\u5b9a\u5185\u5bb9\n[root@master1 ~]# cat /etc/hosts\n127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4\n::1         localhost localhost.localdomain localhost6 localhost6.localdomain6\n192.168.0.10  master1\n192.168.0.20  master2\n192.168.0.30  master3\n\n\u6709\u52b9\u306a\u884c\u3060\u3051\u8868\u793a\u3059\u308b\uff08\u30b3\u30e1\u30f3\u30c8\u884c\u3068\u7a7a\u767d\u884c\u306f\u7701\u7565\uff09\n[root@master1 ~]# cat /etc/etcd/etcd.conf |grep -v ^# |grep -v ^$\nETCD_NAME=master1\nETCD_DATA_DIR=\"/var/lib/etcd/default.etcd\"\nETCD_LISTEN_PEER_URLS=\"http://192.168.0.10:2380\"\nETCD_LISTEN_CLIENT_URLS=\"http://0.0.0.0:2379\"\nETCD_INITIAL_ADVERTISE_PEER_URLS=\"http://192.168.0.10:2380\"\nETCD_INITIAL_CLUSTER=\"master1=http://192.168.0.10:2380,master2=http://192.168.0.20:2380,master3=http://192.168.0.30:2380\"\nETCD_INITIAL_CLUSTER_STATE=\"new\"\nETCD_INITIAL_CLUSTER_TOKEN=\"etcd-cluster\"\nETCD_ADVERTISE_CLIENT_URLS=\"http://192.168.0.10:2379\"\n\n\n4.3 master2\u306e\u8a2d\u5b9a\u5185\u5bb9\n[root@master2 ~]# cat /etc/hosts\n127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4\n::1         localhost localhost.localdomain localhost6 localhost6.localdomain6\n192.168.0.10  master1\n192.168.0.20  master2\n192.168.0.30  master3\n\n\u6709\u52b9\u306a\u884c\u3060\u3051\u8868\u793a\u3059\u308b\uff08\u30b3\u30e1\u30f3\u30c8\u884c\u3068\u7a7a\u767d\u884c\u306f\u7701\u7565\uff09\n[root@master2 ~]# cat /etc/etcd/etcd.conf |grep -v ^# |grep -v ^$\nETCD_NAME=master2\nETCD_DATA_DIR=\"/var/lib/etcd/default.etcd\"\nETCD_LISTEN_PEER_URLS=\"http://192.168.0.20:2380\"\nETCD_LISTEN_CLIENT_URLS=\"http://0.0.0.0:2379\"\nETCD_INITIAL_ADVERTISE_PEER_URLS=\"http://192.168.0.20:2380\"\nETCD_INITIAL_CLUSTER=\"master1=http://192.168.0.10:2380,master2=http://192.168.0.20:2380,master3=http://192.168.0.30:2380\"\nETCD_INITIAL_CLUSTER_STATE=\"new\"\nETCD_INITIAL_CLUSTER_TOKEN=\"etcd-cluster\"\nETCD_ADVERTISE_CLIENT_URLS=\"http://192.168.0.20:2379\"\n[root@master2 ~]#\n\n\n4.4 master3\u306e\u8a2d\u5b9a\u5185\u5bb9\n[root@master3 ~]# cat /etc/hosts\n127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4\n::1         localhost localhost.localdomain localhost6 localhost6.localdomain6\n192.168.0.10  master1\n192.168.0.20  master2\n192.168.0.30  master3\n\n\u6709\u52b9\u306a\u884c\u3060\u3051\u8868\u793a\u3059\u308b\uff08\u30b3\u30e1\u30f3\u30c8\u884c\u3068\u7a7a\u767d\u884c\u306f\u7701\u7565\uff09\n[root@master3 ~]# cat /etc/etcd/etcd.conf |grep -v ^# |grep -v ^$\nETCD_NAME=master3\nETCD_DATA_DIR=\"/var/lib/etcd/default.etcd\"\nETCD_LISTEN_PEER_URLS=\"http://192.168.0.30:2380\"\nETCD_LISTEN_CLIENT_URLS=\"http://0.0.0.0:2379\"\nETCD_INITIAL_ADVERTISE_PEER_URLS=\"http://192.168.0.30:2380\"\nETCD_INITIAL_CLUSTER=\"master1=http://192.168.0.10:2380,master2=http://192.168.0.20:2380,master3=http://192.168.0.30:2380\"\nETCD_INITIAL_CLUSTER_STATE=\"new\"\nETCD_INITIAL_CLUSTER_TOKEN=\"etcd-cluster\"\nETCD_ADVERTISE_CLIENT_URLS=\"http://192.168.0.30:2379\"\n[root@master3 ~]#\n\n\n\n5. \u52d5\u4f5c\u78ba\u8a8d\n\n5.1 etcd\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@master1 ~]# systemctl start etcd\n[root@master2 ~]# systemctl start etcd\n[root@master3 ~]# systemctl start etcd\n\n\n\n5.2 etcd\u306e\u7248\u6570\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 ~]# etcdctl --version\netcdctl version 2.3.7\n[root@master2 ~]# etcdctl --version\netcdctl version 2.3.7\n[root@master3 ~]# etcdctl --version\netcdctl version 2.3.7\n\n\n5.3 \u30e1\u30f3\u30d0\u9593\u306e\u30c7\u30fc\u30bf\u306e\u540c\u671f\u3092\u78ba\u8a8d\u3059\u308b\u3002\n\nmaster1\u306b\u66f8\u304d\u8fbc\u3093\u3060\u30c7\u30fc\u30bf\u304c\u3001master2,master3\u3067\u8aad\u3081\u308b\u304b\u3069\u3046\u304b\u3092\u78ba\u8a8d\u3059\u308b\u3002\nmaster1\u3067os\u306blinux\u3068\u3044\u3046\u5024\u3092\u8a2d\u5b9a\u3059\u308b\u3002\n[root@master1 ~]# etcdctl set os linux\nlinux\n[root@master1 ~]# etcdctl get os\nlinux\n\nmaster2\u3067os\u306e\u5024\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master2 ~]# etcdctl get os\nlinux\n\nmaster3\u3067os\u306e\u5024\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master3 ~]# etcdctl get os\nlinux\n\n\n\nmaster3\u3067os\u306b\u8a2d\u5b9a\u3055\u308c\u305f\u5024\u3092\u524a\u9664\u3059\u308b\u3002master1,master2\u3067os\u306b\u8a2d\u5b9a\u3055\u308c\u305f\u5024\u304c\u524a\u9664\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master3 ~]# etcdctl rm os\nPrevNode.Value: linux\n[root@master3 ~]# etcdctl get os\nError:  100: Key not found (/os) [41]\n[root@master3 ~]#\n\nmaster2\u3067os\u306b\u8a2d\u5b9a\u3057\u305f\u78ba\u8a8d\u3059\u308b\u3002\u5024\u304c\u524a\u9664\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@master2 ~]# etcdctl get os\nError:  100: Key not found (/os) [41]\n[root@master2 ~]#\n\nmaster1\u3067os\u306b\u8a2d\u5b9a\u3057\u305f\u5024\u3092\u78ba\u8a8d\u3059\u308b\u3002\u5024\u304c\u524a\u9664\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@master1 ~]# etcdctl get os\nError:  100: Key not found (/os) [41]\n[root@master1 ~]#\n\n\n\n5.4 \u30ea\u30fc\u30c0\u306e\u79fb\u52d5\u3092\u78ba\u8a8d\u3059\u308b\u3002\netcd\u30af\u30e9\u30b9\u30bf\u306e\u30ea\u30fc\u30c0\u3092\u78ba\u8a8d\u3059\u308b\u3002\u73fe\u5728\u306e\u30ea\u30fc\u30c0\u306fmaster3(isLeader=true)\u3067\u3042\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@master1 ~]# etcdctl member list\n7bf3dc7e1bfc9229: name=master3 peerURLs=http://192.168.0.30:2380 clientURLs=http://192.168.0.30:2379 isLeader=true\nb19e62a463d4b18e: name=master2 peerURLs=http://192.168.0.20:2380 clientURLs=http://192.168.0.20:2379 isLeader=false\nb22cf29c2bebb484: name=master1 peerURLs=http://192.168.0.10:2380 clientURLs=http://192.168.0.10:2379 isLeader=false\n[root@master1 ~]#\n\n\nmaster3(\u30ea\u30fc\u30c0)\u306eetcd\u30c7\u30fc\u30e2\u30f3\u3092\u7d42\u4e86\u3059\u308b\u3002\u30ea\u30fc\u30c0\u304c\u5207\u308a\u66ff\u308f\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3059\u308b\u3002\nmaster3\u3067\u52d5\u304fetcd\u30c7\u30fc\u30e2\u30f3\u306ePID\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master3 ~]# ps -C etcd\n   PID TTY          TIME CMD\n  1247 pts/0    00:02:20 etcd\n\netcd\u30c7\u30fc\u30e2\u30f3\u3092\u7d42\u4e86\u3059\u308b\u3002\n[root@master3 ~]# kill 1247\n[root@master3 ~]#\n\nmaster1\u3067\u30ea\u30fc\u30c0\u3092\u78ba\u8a8d\u3059\u308b\u3002master1\u304c\u30ea\u30fc\u30c0\u306b\u306a\u3063\u305f\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@master1 ~]# etcdctl member list\n7bf3dc7e1bfc9229: name=master3 peerURLs=http://192.168.0.30:2380 clientURLs=http://192.168.0.30:2379 isLeader=false\nb19e62a463d4b18e: name=master2 peerURLs=http://192.168.0.20:2380 clientURLs=http://192.168.0.20:2379 isLeader=false\nb22cf29c2bebb484: name=master1 peerURLs=http://192.168.0.10:2380 clientURLs=http://192.168.0.10:2379 isLeader=true\n\nmaster2\u3067\u3082\u30ea\u30fc\u30c0\u3092\u78ba\u8a8d\u3057\u3066\u307f\u308b\u3002master1\u304c\u30ea\u30fc\u30c0\u3067\u3042\u308b\u3053\u3068\u304c\u78ba\u8a8d\u3067\u304d\u308b\u3002\n[root@master2 ~]# etcdctl member list\n7bf3dc7e1bfc9229: name=master3 peerURLs=http://192.168.0.30:2380 clientURLs=http://192.168.0.30:2379 isLeader=false\nb19e62a463d4b18e: name=master2 peerURLs=http://192.168.0.20:2380 clientURLs=http://192.168.0.20:2379 isLeader=false\nb22cf29c2bebb484: name=master1 peerURLs=http://192.168.0.10:2380 clientURLs=http://192.168.0.10:2379 isLeader=true\n[root@master2 ~]#\n\n\n\u3055\u3089\u306b\u3001master1\uff08\u30ea\u30fc\u30c0)\u306eetcd\u30c7\u30fc\u30e2\u30f3\u3092\u7d42\u4e86\u3059\u308b\u3002\n\u3053\u306e\u6642\u70b9\u3067master1,master3\u306eetcd\u30c7\u30fc\u30e2\u30f3\u304c\u7d42\u4e86\u3057\u305f\u3053\u3068\u306b\u306a\u308b\u3002\n\netcd\u30c7\u30fc\u30e2\u30f3\u306ePID\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 ~]# ps -C etcd\n   PID TTY          TIME CMD\n  1792 pts/0    00:03:57 etcd\n\netcd\u30c7\u30fc\u30e2\u30f3\u3092\u7d42\u4e86\u3059\u308b\u3002\n[root@master1 ~]# kill 1792\n[root@master1 ~]# ps -C etcd\n   PID TTY          TIME CMD\n[root@master1 ~]#\n\n\u3053\u306e\u6642\u70b9\u3067master2\u306eetcd\u30c7\u30fc\u30e2\u30f3\u306e\u307f\u751f\u304d\u3066\u3044\u308b\u3002\n[root@master2 ~]# ps -C etcd\n   PID TTY          TIME CMD\n  1087 pts/0    00:05:42 etcd\n\nmaster2(\u30ea\u30fc\u30c0)\u3067etcd\u30af\u30e9\u30b9\u30bf\u306e\u30e1\u30f3\u30d0\u3092\u78ba\u8a8d\u3059\u308b\u3002etcd\u30af\u30e9\u30b9\u30bf\u304c\u5229\u7528\u4e0d\u53ef\u3068\u306e\u30e1\u30c3\u30bb\u30fc\u30b8\u304c\u51fa\u529b\u3055\u308c\u308b\u3002\n[root@master2 ~]# etcdctl member list\nFailed to get leader:  client: etcd cluster is unavailable or misconfigured\n\n\nmaster1,master3\u3067\u306f\u3001\u4ee5\u4e0b\u306e\u30e1\u30c3\u30bb\u30fc\u30b8\u304c\u51fa\u529b\u3055\u308c\u305f\u3002\netcd\u30c7\u30fc\u30e2\u30f3\u304c\u3044\u306a\u3044\u306e\u3067\u3001TCP\u63a5\u7d9a\u8981\u6c42\u304c\u62d2\u5426\u3055\u308c\u305f\u3053\u3068\u3092\u793a\u3057\u3066\u3044\u308b\u3002\n[root@master1 ~]# etcdctl member list\nError:  client: etcd cluster is unavailable or misconfigured\nerror #0: dial tcp 127.0.0.1:2379: getsockopt: connection refused\nerror #1: dial tcp 127.0.0.1:4001: getsockopt: connection refused\n\n[root@master3 ~]# etcdctl member list\nError:  client: etcd cluster is unavailable or misconfigured\nerror #0: dial tcp 127.0.0.1:2379: getsockopt: connection refused\nerror #1: dial tcp 127.0.0.1:4001: getsockopt: connection refused\n\n\n\n\n5.5 etcd\u30af\u30e9\u30b9\u30bf\u306e\u72b6\u614b\u3092\u78ba\u8a8d\u3059\u308b\u3002\n\n\u30af\u30e9\u30b9\u30bf\u306e\u30e1\u30f3\u30d0\u304c\u6b8b\u308a1\u3064\u306b\u306a\u308b\u3068\u3001\u30af\u30e9\u30b9\u30bf\u304cunhealthy\u3068\u306a\u308a\u3001\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u304b\u3089\u306e\u30ea\u30fc\u30c9\u306f\u3067\u304d\u308b\u3051\u3069\u3001\u30e9\u30a4\u30c8\u306f\u3067\u304d\u306a\u304f\u306a\u308b\u6a21\u69d8\u3002\u307b\u3093\u3068???\n\u30af\u30e9\u30b9\u30bf\u306e\u72b6\u614b\u3092\u78ba\u8a8d\u3059\u308b\u3002\u5168\u3066(master1,master2,master3)\u306e\u30e1\u30f3\u30d0\u304c\u751f\u304d\u3066\u3044\u308b\u3002\n[root@master1 ~]# etcdctl cluster-health\nmember 7bf3dc7e1bfc9229 is healthy: got healthy result from http://192.168.0.30:2379\nmember b19e62a463d4b18e is healthy: got healthy result from http://192.168.0.20:2379\nmember b22cf29c2bebb484 is healthy: got healthy result from http://192.168.0.10:2379\n\n[root@master1 ~]# etcdctl set os linux\nlinux\n\n[root@master1 ~]# etcdctl get os\nlinux\n\n[root@master3 ~]# ps -C etcd\n   PID TTY          TIME CMD\n  1820 pts/3    00:01:58 etcd\n[root@master3 ~]# kill 1820\n\n\n\u30af\u30e9\u30b9\u30bf\u306e\u72b6\u614b\u3092\u78ba\u8a8d\u3059\u308b\u3002master1\u3068master2\u304c\u751f\u304d\u3066\u3044\u308b\u3002master3\u306f\u6b7b\u3093\u3067\u3044\u308b\u3002\n[root@master1 ~]# etcdctl cluster-health\nfailed to check the health of member 7bf3dc7e1bfc9229 on http://192.168.0.30:2379: Get http://192.168.0.30:2379/health: dial tcp 192.168.0.30:2379: getsockopt: connection refused\nmember 7bf3dc7e1bfc9229 is unreachable: [http://192.168.0.30:2379] are all unreachable\nmember b19e62a463d4b18e is healthy: got healthy result from http://192.168.0.20:2379\nmember b22cf29c2bebb484 is healthy: got healthy result from http://192.168.0.10:2379\ncluster is healthy\n\n\n3\u3064\u306e\u30e1\u30f3\u30d0\u306e\u3046\u30612\u3064\u304c\u751f\u304d\u3066\u3044\u308c\u3070\u3001\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u3078\u306e\u30e9\u30a4\u30c8\u304c\u3067\u304d\u308b\u3002\n[root@master1 ~]# etcdctl set car GT-R\nGT-R\n\nmaster2\u306eetcd\u3092\u7d42\u4e86\u3059\u308b\u3002\n[root@master2 ~]# ps -C etcd\n   PID TTY          TIME CMD\n  1790 pts/0    00:03:07 etcd\n[root@master2 ~]# kill 1790\n\n\n\u30af\u30e9\u30b9\u30bf\u306e\u72b6\u614b\u3092\u78ba\u8a8d\u3059\u308b\u3002master1\u3060\u3051\u304c\u751f\u304d\u3066\u3044\u308b\u3002master2,3\u306f\u6b7b\u3093\u3067\u3044\u308b\u3002\n[root@master1 ~]# etcdctl cluster-health\nfailed to check the health of member 7bf3dc7e1bfc9229 on http://192.168.0.30:2379: Get http://192.168.0.30:2379/health: dial tcp 192.168.0.30:2379: getsockopt: connection refused\nmember 7bf3dc7e1bfc9229 is unreachable: [http://192.168.0.30:2379] are all unreachable\nfailed to check the health of member b19e62a463d4b18e on http://192.168.0.20:2379: Get http://192.168.0.20:2379/health: dial tcp 192.168.0.20:2379: getsockopt: connection refused\nmember b19e62a463d4b18e is unreachable: [http://192.168.0.20:2379] are all unreachable\nmember b22cf29c2bebb484 is unhealthy: got unhealthy result from http://192.168.0.10:2379\ncluster is unhealthy     <<<<<< \u30af\u30e9\u30b9\u30bf\u306e\u72b6\u614b\u304cunhealthy\u3068\u5224\u5b9a\u3055\u308c\u3066\u3044\u308b\u3002\n\n\n\u30af\u30e9\u30b9\u30bf\u5185\u306e\u30e1\u30f3\u30d0\u304c1\u3064\u3060\u3051\u3057\u304b\u751f\u304d\u3066\u3044\u306a\u3044\u3068\u3001\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u3078\u306e\u30e9\u30a4\u30c8\u304c\u3067\u304d\u306a\u3044\u3002\n[root@master1 ~]# etcdctl set month Nov\nError:  client: etcd cluster is unavailable or misconfigured\nerror #0: client: endpoint http://192.168.0.10:2379 exceeded header timeout\nerror #1: dial tcp 192.168.0.20:2379: getsockopt: connection refused\nerror #2: dial tcp 192.168.0.30:2379: getsockopt: connection refused\n\n\u3057\u304b\u3057\u3001\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u304b\u3089\u306e\u30ea\u30fc\u30c9\u306f\u3067\u304d\u308b\u3002\n[root@master1 ~]# etcdctl ls\n/os\n/car\n\n\u3053\u3053\u3067master2\u306eetcd\u3092\u8d77\u52d5\u3059\u308b\u3002\u3053\u306e\u6642\u70b9\u3067master1,master2\u304c\u751f\u304d\u3066\u3044\u308b\u3053\u3068\u306b\u306a\u308b\u3002\n[root@master2 ~]# ps -C etcd\n   PID TTY          TIME CMD\n  1811 pts/0    00:00:11 etcd\n\nmonth\u306b\u30c7\u30fc\u30bf\u3092\u8a2d\u5b9a\u3059\u308b\u3002\u8a2d\u5b9a\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u305f\u3002\n[root@master1 ~]# etcdctl set month Nov\nNov\n\n\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306e\u30ea\u30fc\u30c9\u3082\u3067\u304d\u305f\u3002\n[root@master1 ~]# etcdctl ls\n/month\n/os\n/car\n\n\n\n5.6 TCP2379\u756a\u30dd\u30fc\u30c8\u3078\u306e\u30a2\u30af\u30bb\u30b9\u3092\u78ba\u8a8d\u3059\u308b\u3002\ntcpdump\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u3002\n[root@master1 ~]# yum -y install tcpdump\n\ntcpdump\u3092\u8d77\u52d5\u3059\u308b\u3002\u30dd\u30fc\u30c8\u756a\u53f7\u306b2379\u3092\u6307\u5b9a\u3059\u308b\u3002\n[root@master1 ~]# tcpdump -i eth0 tcp port 2379\ntcpdump: verbose output suppressed, use -v or -vv for full protocol decode\nlistening on eth0, link-type EN10MB (Ethernet), capture size 65535 bytes\n\n\n\n\u3082\u30461\u3064\u7aef\u672b\u3092\u8d77\u52d5\u3059\u308b\u3002\u305d\u3053\u3067\u3001etcdctl\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3059\u308b\u3002\n[root@master1 ~]# etcdctl member list\n\n\netcdctl\u30b3\u30de\u30f3\u30c9\u306e\u5b9f\u884c\u3068\u540c\u671f\u3057\u3066\u3001TCP\u30d1\u30b1\u30c3\u30c8\u306e\u9001\u53d7\u4fe1\u304c\u78ba\u8a8d\u3067\u304d\u308b\u3002\n\u6700\u521d\u306e3\u30d1\u30b1\u30c3\u30c8\u3067\u3001master1\u306eetcdctl\u30b3\u30de\u30f3\u30c9\u3068master3\uff08\u30ea\u30fc\u30c0\uff09\u306eetcd\u30c7\u30fc\u30e2\u30f3\u306e\u9593\u3067\nTCP\u30b3\u30cd\u30af\u30b7\u30e7\u30f3\u306e\u78ba\u7acb(3 way handshake)\u304c\u884c\u308f\u308c\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n\n\n\u3000\u3000\u3000master1:53186(etcdctl)         master3:2379(etcd)\n       |                                    |\n       +---------------- SYN  ------------->|\n       |<--------------- SYN +ACK ----------|\n       |---------------- ACK -------------->|\n\n\n\n17:59:48.705597 IP master1.53186 > master3.2379: Flags [S], seq 1724156849, win 14600, options [mss 1460,sackOK,TS val 3687348 ecr 0,nop,wscale 7], length 0\n17:59:48.707562 IP master3.2379 > master1.53186: Flags [S.], seq 354533212, ack 1724156850, win 14480, options [mss 1460,sackOK,TS val 3478680 ecr 3687348,nop,wscale 7], length 0\n17:59:48.708494 IP master1.53186 > master3.2379: Flags [.], ack 1, win 115, options [nop,nop,TS val 3687353 ecr 3478680], length 0\n17:59:48.713164 IP master1.53186 > master3.2379: Flags [P.], seq 1:109, ack 1, win 115, options [nop,nop,TS val 3687354 ecr 3478680], length 108\n17:59:48.714680 IP master3.2379 > master1.53186: Flags [.], ack 109, win 114, options [nop,nop,TS val 3478688 ecr 3687354], length 0\n17:59:48.715199 IP master3.2379 > master1.53186: Flags [P.], seq 1:536, ack 109, win 114, options [nop,nop,TS val 3478689 ecr 3687354], length 535\n17:59:48.715242 IP master1.53186 > master3.2379: Flags [.], ack 536, win 123, options [nop,nop,TS val 3687359 ecr 3478689], length 0\n17:59:48.716397 IP master1.53186 > master3.2379: Flags [P.], seq 109:224, ack 536, win 123, options [nop,nop,TS val 3687360 ecr 3478689], length 115\n17:59:48.718197 IP master3.2379 > master1.53186: Flags [P.], seq 536:807, ack 224, win 114, options [nop,nop,TS val 3478692 ecr 3687360], length 271\n17:59:48.720172 IP master1.53186 > master3.2379: Flags [F.], seq 224, ack 807, win 131, options [nop,nop,TS val 3687364 ecr 3478692], length 0\n17:59:48.721524 IP master3.2379 > master1.53186: Flags [F.], seq 807, ack 225, win 114, options [nop,nop,TS val 3478696 ecr 3687364], length 0\n17:59:48.721614 IP master1.53186 > master3.2379: Flags [.], ack 808, win 131, options [nop,nop,TS val 3687366 ecr 3478696], length 0\n\n\n\n\n5.6 TCP2380\u756a\u30dd\u30fc\u30c8\u3078\u306e\u30a2\u30af\u30bb\u30b9\u3092\u78ba\u8a8d\u3059\u308b\u3002\n2380\u756a\u30dd\u30fc\u30c8\u3067\u306f\u3001\u5e38\u6642\u3001\u30e1\u30c3\u30bb\u30fc\u30b8\u304c\u9001\u53d7\u4fe1\u3055\u308c\u3066\u3044\u308b\u3002\n[root@master1 ~]# tcpdump -i eth0 tcp port 2380\ntcpdump: verbose output suppressed, use -v or -vv for full protocol decode\nlistening on eth0, link-type EN10MB (Ethernet), capture size 65535 bytes\n18:06:40.973494 IP master2.2380 > master3.52766: Flags [P.], seq 835860753:835860814, ack 2448790313, win 122, options [nop,nop,TS val 3945499 ecr 3890848], length 61\n18:06:40.973526 IP master2.2380 > master1.54930: Flags [P.], seq 4072016314:4072016376, ack 3951593931, win 122, options [nop,nop,TS val 3945499 ecr 4099518], length 62\n18:06:40.973590 IP master1.54930 > master2.2380: Flags [.], ack 62, win 123, options [nop,nop,TS val 4099618 ecr 3945499], length 0\n18:06:40.974528 IP master3.52766 > master2.2380: Flags [.], ack 61, win 148, options [nop,nop,TS val 3890947 ecr 3945499], length 0\n18:06:40.974535 IP master3.2380 > master2.38787: Flags [P.], seq 1427255133:1427255193, ack 3674681492, win 122, options [nop,nop,TS val 3890948 ecr 3945407], length 60\n18:06:40.974879 IP master2.38787 > master3.2380: Flags [.], ack 60, win 331, options [nop,nop,TS val 3945501 ecr 3890948], length 0\n18:06:40.976762 IP master1.2380 > master2.36442: Flags [P.], seq 1235860774:1235860835, ack 2751211062, win 122, options [nop,nop,TS val 4099620 ecr 3945411], length 61\n18:06:40.978482 IP master2.36442 > master1.2380: Flags [.], ack 61, win 331, options [nop,nop,TS val 3945505 ecr 4099620], length 0\n18:06:41.073308 IP master2.2380 > master3.52766: Flags [P.], seq 61:122, ack 1, win 122, options [nop,nop,TS val 3945599 ecr 3890947], length 61\n18:06:41.073337 IP master2.2380 > master1.54930: Flags [P.], seq 62:124, ack 1, win 122, options [nop,nop,TS val 3945599 ecr 4099618], length 62\n18:06:41.074338 IP master3.52766 > master2.2380: Flags [.], ack 122, win 148, options [nop,nop,TS val 3891047 ecr 3945599], length 0\n\u4ee5\u4e0b\u3001\u7565\n\n\n\n7. \u30b3\u30de\u30f3\u30c9\u304b\u3089etcd\u3092\u8d77\u52d5\u3059\u308b\u3002\n\n7.1 master1\u3067\u5b9f\u884c\u3059\u308b\u30b3\u30de\u30f3\u30c9\n[root@master1 ~]# etcd -name master1 \\\n>      -initial-advertise-peer-urls http://192.168.0.10:2380 \\\n>      -listen-peer-urls http://192.168.0.10:2380 \\\n>      -listen-client-urls http://192.168.0.10:2379,http://127.0.0.1:2379 \\\n>      -advertise-client-urls http://192.168.0.10:2379 \\\n>      -initial-cluster-token mytoken \\\n>      -initial-cluster master1=http://192.168.0.10:2380,master2=http://192.168.0.20:2380,master3=http://192.168.0.30:2380 \\\n>      -initial-cluster-state new &\n\n\n7.2 master2\u3067\u5b9f\u884c\u3059\u308b\u30b3\u30de\u30f3\u30c9\n[root@master2 ~]# etcd -name master2 \\\n>      -initial-advertise-peer-urls http://192.168.0.20:2380 \\\n>      -listen-peer-urls http://192.168.0.20:2380 \\\n>      -listen-client-urls http://192.168.0.20:2379,http://127.0.0.1:2379 \\\n>      -advertise-client-urls http://192.168.0.20:2379 \\\n>      -initial-cluster-token mytoken \\\n>      -initial-cluster master1=http://192.168.0.10:2380,master2=http://192.168.0.20:2380,master3=http://192.168.0.30:2380 \\\n>      -initial-cluster-state new &\n\n\n7.3 master3\u3067\u5b9f\u884c\u3059\u308b\u30b3\u30de\u30f3\u30c9\n[root@master3 ~]# etcd -name master3 \\\n>      -initial-advertise-peer-urls http://192.168.0.30:2380 \\\n>      -listen-peer-urls http://192.168.0.30:2380 \\\n>      -listen-client-urls http://192.168.0.30:2379,http://127.0.0.1:2379 \\\n>      -advertise-client-urls http://192.168.0.30:2379 \\\n>      -initial-cluster-token mytoken \\\n>      -initial-cluster master1=http://192.168.0.10:2380,master2=http://192.168.0.20:2380,master3=http://192.168.0.30:2380 \\\n>      -initial-cluster-state new &\n\n\n\n8. \u53c2\u8003\u60c5\u5831\n[Configuration flags]https://coreos.com/etcd/docs/latest/op-guide/configuration.html\n#1. \u69cb\u6210\n\u30fb3\u53f0\u69cb\u6210(VMware\u4e0a\u306e\u4eee\u60f3\u30de\u30b7\u30f3)\n\u30fb\u4eee\u60f3\u30de\u30b7\u30f3\u306eOS\u306fCentOS7.2\u3001etcd\u306e\u7248\u6570\u306fversion 2.3.7\n\u30fb\u30db\u30b9\u30c8\u540d\u306f\u3001master1,master2,master3\n\u30fbDB(\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\uff09\u306f\u3001etcd\u30c7\u30fc\u30e2\u30f3\u306e\u8d77\u52d5\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306b\u4f5c\u6210\u3055\u308c\u308b\u3002\n\n\n| etcd\u30c7\u30fc\u30e2\u30f3\u304c\u4f7f\u3046\u30dd\u30fc\u30c8\u756a\u53f7v2(v1)| \u7528\u9014 |\n|:------------|:--------------------------------------------------------------------------------|\n| 2379(4001)  | etcdctl\u30b3\u30de\u30f3\u30c9\u306e\u3088\u3046\u306a\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u3068\u306e\u901a\u4fe1\u306b\u4f7f\u3046                                   |\n| 2380(7001)  | etcd\u30af\u30e9\u30b9\u30bf\u306e\u4e2d\u3067\u3001\u3069\u306eetcd\u3092\u30ea\u30fc\u30c0\u306b\u3059\u308b\u304b?\u3001\u3068\u3044\u3063\u305f\u3088\u3046\u306a\u5236\u5fa1\u60c5\u5831\u306e\u3084\u308a\u3068\u308a\u306b\u4f7f\u3046  |\n\n\n\n```\n\n\n  +------ master1(CentOS7.2) -----------+   +- master2(CentOS7.2) -+   +- master3(CentOS7.2) -+\n  |                                     |   |                      |   |                      |\n  |  +- etcdctl -+   +----- etcd ----+  |   |  +----- etcd ----+   |   |   +----- etcd ----+  |\n  |  |           |   |               |  |   |  |               |   |   |   |               |  |\n  |  |           |   |               |  |   |  |               |   |   |   |               |  |\n  |  +-----------+   +- 2379 - 2380 -+  |   |  +- 2379 - 2380 -+   |   |   +- 2379 - 2380 -+  |\n  |        A                     A      |   |               A      |   |      A         A     |\n  |        |     +----+          |      |   |       +----+  |      |   |      | +----+  |     |\n  |        |     | DB |          |      |   |       | DB |  |      |   |      | | DB |  |     |\n  |        |     +----+   +------+      |   |       +----+  |      |   |      | +----+  |     |\n  |        |              |             |   |               |      |   |      |         |     |\n  +--------|----- eth0 ---|-------------+   +-------- eth0 -|------+   +------|- eth0 --|-----+\n           |        |     |                            |    |                 |   |     |\n           |        |     |                            |    |                 |   |     |\n           |        |     |                            |    |                 |   |     |\n  +--------|--------+-----|------- \u4eee\u60f3\u30b9\u30a4\u30c3\u30c1 --------+----|-----------------|---+-----|-----+\n  |        |              |                                 |                 |         |     |\n  |        |              +=================================+=================|=========+     |\n  |        |                                                                  |               |\n  |        +==================================================================+               |\n  |                                                                                           |\n  +-------------------------------------------------------------------------------------------+\n\n\n```\n\n#2. etcd\u30af\u30e9\u30b9\u30bf\u306e\u69cb\u7bc9\u65b9\u6cd5\n\u3053\u3053\u3067\u306f\u3001static\u65b9\u5f0f\u306b\u3064\u3044\u3066\u8aac\u660e\u3092\u3059\u308b\u3002\n\n| \u65b9\u5f0f             | \u5185\u5bb9                                                   |\n|:-----------------|:------------------------------------------------------|\n| static           | \u3042\u3089\u304b\u3058\u3081\u30af\u30e9\u30b9\u30bf\u306e\u30e1\u30f3\u30d0\u3092\u5b9a\u7fa9\u30d5\u30a1\u30a4\u30eb\u306b\u6307\u5b9a\u3057\u3066\u304a\u304f     |\n| etcd discovery   | http://qiita.com/hana_shin/items/f8de83a8cc91adae6262 |\n| DNS  discovery   | \u8abf\u67fb\u4e2d                                                |\n\n\n\n\n#3. \u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u30d1\u30c3\u30b1\u30fc\u30b8\n\n```\n\u4eee\u60f3\u30de\u30b7\u30f3\u306betcd\u30d1\u30c3\u30b1\u30fc\u30b8\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u3002\n[root@master1 ~]# yum -y install etcd\n[root@master2 ~]# yum -y install etcd\n[root@master3 ~]# yum -y install etcd\n```\n\n#4. \u8a2d\u5b9a\u5185\u5bb9\n\n##4.1 \u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3068\u8a2d\u5b9a\u5185\u5bb9\n/etc/etcd/etcd.conf\n\n| \u9805\u76ee | \u610f\u5473 |\n|:------------------------------|:-----------------------------------|\n|ETCD_NAME   | \u30db\u30b9\u30c8\u540d\u3092\u8a2d\u5b9a\u3059\u308b  |\n|ETCD_DATA_DIR   | DB\u306e\u30d1\u30b9\u3092\u8a2d\u5b9a\u3059\u308b\u3002\u30c7\u30d5\u30a9\u30eb\u30c8\u306e\u30d1\u30b9\u306fvar/lib/etcd/default.etcd  |\n|ETCD_LISTEN_PEER_URLS   | etcd\u30c7\u30fc\u30e2\u30f3\u9593\u306e\u9001\u53d7\u4fe1\u306b\u4f7f\u3046IP\u30a2\u30c9\u30ec\u30b9\u3068\u30dd\u30fc\u30c8\u756a\u53f7\u3092\u8a2d\u5b9a\u3059\u308b  |\n|ETCD_INITIAL_CLUSTER   | etcd\u30af\u30e9\u30b9\u30bf\u306e\u30e1\u30f3\u30d0\u3092\u8a2d\u5b9a\u3059\u308b\u3002  |\n|ETCD_INITIAL_CLUSTER_STATE   | new\u3092\u8a2d\u5b9a\u3059\u308b  |\n|ETCD_INITIAL_CLUSTER_TOKEN   | etcd\u30af\u30e9\u30b9\u30bf\u3092\u8b58\u5225\u3059\u308b\u305f\u3081\u306e\u6587\u5b57\u5217\u3002\u540c\u4e00\u30af\u30e9\u30b9\u30bf\u5185\u306e\u30e1\u30f3\u30d0\u306f\u540c\u3058\u6587\u5b57\u5217\u3092\u8a2d\u5b9a\u3059\u308b  |\n\n##4.2 master1\u306e\u8a2d\u5b9a\u5185\u5bb9\n```\n[root@master1 ~]# cat /etc/hosts\n127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4\n::1         localhost localhost.localdomain localhost6 localhost6.localdomain6\n192.168.0.10  master1\n192.168.0.20  master2\n192.168.0.30  master3\n\n\u6709\u52b9\u306a\u884c\u3060\u3051\u8868\u793a\u3059\u308b\uff08\u30b3\u30e1\u30f3\u30c8\u884c\u3068\u7a7a\u767d\u884c\u306f\u7701\u7565\uff09\n[root@master1 ~]# cat /etc/etcd/etcd.conf |grep -v ^# |grep -v ^$\nETCD_NAME=master1\nETCD_DATA_DIR=\"/var/lib/etcd/default.etcd\"\nETCD_LISTEN_PEER_URLS=\"http://192.168.0.10:2380\"\nETCD_LISTEN_CLIENT_URLS=\"http://0.0.0.0:2379\"\nETCD_INITIAL_ADVERTISE_PEER_URLS=\"http://192.168.0.10:2380\"\nETCD_INITIAL_CLUSTER=\"master1=http://192.168.0.10:2380,master2=http://192.168.0.20:2380,master3=http://192.168.0.30:2380\"\nETCD_INITIAL_CLUSTER_STATE=\"new\"\nETCD_INITIAL_CLUSTER_TOKEN=\"etcd-cluster\"\nETCD_ADVERTISE_CLIENT_URLS=\"http://192.168.0.10:2379\"\n```\n\n\n##4.3 master2\u306e\u8a2d\u5b9a\u5185\u5bb9\n```\n[root@master2 ~]# cat /etc/hosts\n127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4\n::1         localhost localhost.localdomain localhost6 localhost6.localdomain6\n192.168.0.10  master1\n192.168.0.20  master2\n192.168.0.30  master3\n\n\u6709\u52b9\u306a\u884c\u3060\u3051\u8868\u793a\u3059\u308b\uff08\u30b3\u30e1\u30f3\u30c8\u884c\u3068\u7a7a\u767d\u884c\u306f\u7701\u7565\uff09\n[root@master2 ~]# cat /etc/etcd/etcd.conf |grep -v ^# |grep -v ^$\nETCD_NAME=master2\nETCD_DATA_DIR=\"/var/lib/etcd/default.etcd\"\nETCD_LISTEN_PEER_URLS=\"http://192.168.0.20:2380\"\nETCD_LISTEN_CLIENT_URLS=\"http://0.0.0.0:2379\"\nETCD_INITIAL_ADVERTISE_PEER_URLS=\"http://192.168.0.20:2380\"\nETCD_INITIAL_CLUSTER=\"master1=http://192.168.0.10:2380,master2=http://192.168.0.20:2380,master3=http://192.168.0.30:2380\"\nETCD_INITIAL_CLUSTER_STATE=\"new\"\nETCD_INITIAL_CLUSTER_TOKEN=\"etcd-cluster\"\nETCD_ADVERTISE_CLIENT_URLS=\"http://192.168.0.20:2379\"\n[root@master2 ~]#\n```\n\n##4.4 master3\u306e\u8a2d\u5b9a\u5185\u5bb9\n```\n[root@master3 ~]# cat /etc/hosts\n127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4\n::1         localhost localhost.localdomain localhost6 localhost6.localdomain6\n192.168.0.10  master1\n192.168.0.20  master2\n192.168.0.30  master3\n\n\u6709\u52b9\u306a\u884c\u3060\u3051\u8868\u793a\u3059\u308b\uff08\u30b3\u30e1\u30f3\u30c8\u884c\u3068\u7a7a\u767d\u884c\u306f\u7701\u7565\uff09\n[root@master3 ~]# cat /etc/etcd/etcd.conf |grep -v ^# |grep -v ^$\nETCD_NAME=master3\nETCD_DATA_DIR=\"/var/lib/etcd/default.etcd\"\nETCD_LISTEN_PEER_URLS=\"http://192.168.0.30:2380\"\nETCD_LISTEN_CLIENT_URLS=\"http://0.0.0.0:2379\"\nETCD_INITIAL_ADVERTISE_PEER_URLS=\"http://192.168.0.30:2380\"\nETCD_INITIAL_CLUSTER=\"master1=http://192.168.0.10:2380,master2=http://192.168.0.20:2380,master3=http://192.168.0.30:2380\"\nETCD_INITIAL_CLUSTER_STATE=\"new\"\nETCD_INITIAL_CLUSTER_TOKEN=\"etcd-cluster\"\nETCD_ADVERTISE_CLIENT_URLS=\"http://192.168.0.30:2379\"\n[root@master3 ~]#\n\n```\n\n#5. \u52d5\u4f5c\u78ba\u8a8d\n\n##5.1 etcd\u3092\u8d77\u52d5\u3059\u308b\u3002\n\n```\n[root@master1 ~]# systemctl start etcd\n[root@master2 ~]# systemctl start etcd\n[root@master3 ~]# systemctl start etcd\n\n```\n\n\n##5.2 etcd\u306e\u7248\u6570\u3092\u78ba\u8a8d\u3059\u308b\u3002\n\n```\n[root@master1 ~]# etcdctl --version\netcdctl version 2.3.7\n[root@master2 ~]# etcdctl --version\netcdctl version 2.3.7\n[root@master3 ~]# etcdctl --version\netcdctl version 2.3.7\n```\n\n\n##5.3 \u30e1\u30f3\u30d0\u9593\u306e\u30c7\u30fc\u30bf\u306e\u540c\u671f\u3092\u78ba\u8a8d\u3059\u308b\u3002\n### master1\u306b\u66f8\u304d\u8fbc\u3093\u3060\u30c7\u30fc\u30bf\u304c\u3001master2,master3\u3067\u8aad\u3081\u308b\u304b\u3069\u3046\u304b\u3092\u78ba\u8a8d\u3059\u308b\u3002\n\n```\nmaster1\u3067os\u306blinux\u3068\u3044\u3046\u5024\u3092\u8a2d\u5b9a\u3059\u308b\u3002\n[root@master1 ~]# etcdctl set os linux\nlinux\n[root@master1 ~]# etcdctl get os\nlinux\n\nmaster2\u3067os\u306e\u5024\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master2 ~]# etcdctl get os\nlinux\n\nmaster3\u3067os\u306e\u5024\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master3 ~]# etcdctl get os\nlinux\n\n```\n\n### master3\u3067os\u306b\u8a2d\u5b9a\u3055\u308c\u305f\u5024\u3092\u524a\u9664\u3059\u308b\u3002master1,master2\u3067os\u306b\u8a2d\u5b9a\u3055\u308c\u305f\u5024\u304c\u524a\u9664\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3059\u308b\u3002\n\n```\n[root@master3 ~]# etcdctl rm os\nPrevNode.Value: linux\n[root@master3 ~]# etcdctl get os\nError:  100: Key not found (/os) [41]\n[root@master3 ~]#\n\nmaster2\u3067os\u306b\u8a2d\u5b9a\u3057\u305f\u78ba\u8a8d\u3059\u308b\u3002\u5024\u304c\u524a\u9664\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@master2 ~]# etcdctl get os\nError:  100: Key not found (/os) [41]\n[root@master2 ~]#\n\nmaster1\u3067os\u306b\u8a2d\u5b9a\u3057\u305f\u5024\u3092\u78ba\u8a8d\u3059\u308b\u3002\u5024\u304c\u524a\u9664\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@master1 ~]# etcdctl get os\nError:  100: Key not found (/os) [41]\n[root@master1 ~]#\n\n```\n\n##5.4 \u30ea\u30fc\u30c0\u306e\u79fb\u52d5\u3092\u78ba\u8a8d\u3059\u308b\u3002\netcd\u30af\u30e9\u30b9\u30bf\u306e\u30ea\u30fc\u30c0\u3092\u78ba\u8a8d\u3059\u308b\u3002\u73fe\u5728\u306e\u30ea\u30fc\u30c0\u306fmaster3(isLeader=true)\u3067\u3042\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n\n```\n[root@master1 ~]# etcdctl member list\n7bf3dc7e1bfc9229: name=master3 peerURLs=http://192.168.0.30:2380 clientURLs=http://192.168.0.30:2379 isLeader=true\nb19e62a463d4b18e: name=master2 peerURLs=http://192.168.0.20:2380 clientURLs=http://192.168.0.20:2379 isLeader=false\nb22cf29c2bebb484: name=master1 peerURLs=http://192.168.0.10:2380 clientURLs=http://192.168.0.10:2379 isLeader=false\n[root@master1 ~]#\n\n```\n\n\nmaster3(\u30ea\u30fc\u30c0)\u306eetcd\u30c7\u30fc\u30e2\u30f3\u3092\u7d42\u4e86\u3059\u308b\u3002\u30ea\u30fc\u30c0\u304c\u5207\u308a\u66ff\u308f\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3059\u308b\u3002\n\n```\nmaster3\u3067\u52d5\u304fetcd\u30c7\u30fc\u30e2\u30f3\u306ePID\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master3 ~]# ps -C etcd\n   PID TTY          TIME CMD\n  1247 pts/0    00:02:20 etcd\n\netcd\u30c7\u30fc\u30e2\u30f3\u3092\u7d42\u4e86\u3059\u308b\u3002\n[root@master3 ~]# kill 1247\n[root@master3 ~]#\n\nmaster1\u3067\u30ea\u30fc\u30c0\u3092\u78ba\u8a8d\u3059\u308b\u3002master1\u304c\u30ea\u30fc\u30c0\u306b\u306a\u3063\u305f\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n[root@master1 ~]# etcdctl member list\n7bf3dc7e1bfc9229: name=master3 peerURLs=http://192.168.0.30:2380 clientURLs=http://192.168.0.30:2379 isLeader=false\nb19e62a463d4b18e: name=master2 peerURLs=http://192.168.0.20:2380 clientURLs=http://192.168.0.20:2379 isLeader=false\nb22cf29c2bebb484: name=master1 peerURLs=http://192.168.0.10:2380 clientURLs=http://192.168.0.10:2379 isLeader=true\n\nmaster2\u3067\u3082\u30ea\u30fc\u30c0\u3092\u78ba\u8a8d\u3057\u3066\u307f\u308b\u3002master1\u304c\u30ea\u30fc\u30c0\u3067\u3042\u308b\u3053\u3068\u304c\u78ba\u8a8d\u3067\u304d\u308b\u3002\n[root@master2 ~]# etcdctl member list\n7bf3dc7e1bfc9229: name=master3 peerURLs=http://192.168.0.30:2380 clientURLs=http://192.168.0.30:2379 isLeader=false\nb19e62a463d4b18e: name=master2 peerURLs=http://192.168.0.20:2380 clientURLs=http://192.168.0.20:2379 isLeader=false\nb22cf29c2bebb484: name=master1 peerURLs=http://192.168.0.10:2380 clientURLs=http://192.168.0.10:2379 isLeader=true\n[root@master2 ~]#\n\n```\n\n\n\u3055\u3089\u306b\u3001master1\uff08\u30ea\u30fc\u30c0)\u306eetcd\u30c7\u30fc\u30e2\u30f3\u3092\u7d42\u4e86\u3059\u308b\u3002\n\u3053\u306e\u6642\u70b9\u3067master1,master3\u306eetcd\u30c7\u30fc\u30e2\u30f3\u304c\u7d42\u4e86\u3057\u305f\u3053\u3068\u306b\u306a\u308b\u3002\n\n```\n\netcd\u30c7\u30fc\u30e2\u30f3\u306ePID\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@master1 ~]# ps -C etcd\n   PID TTY          TIME CMD\n  1792 pts/0    00:03:57 etcd\n\netcd\u30c7\u30fc\u30e2\u30f3\u3092\u7d42\u4e86\u3059\u308b\u3002\n[root@master1 ~]# kill 1792\n[root@master1 ~]# ps -C etcd\n   PID TTY          TIME CMD\n[root@master1 ~]#\n\n\u3053\u306e\u6642\u70b9\u3067master2\u306eetcd\u30c7\u30fc\u30e2\u30f3\u306e\u307f\u751f\u304d\u3066\u3044\u308b\u3002\n[root@master2 ~]# ps -C etcd\n   PID TTY          TIME CMD\n  1087 pts/0    00:05:42 etcd\n\nmaster2(\u30ea\u30fc\u30c0)\u3067etcd\u30af\u30e9\u30b9\u30bf\u306e\u30e1\u30f3\u30d0\u3092\u78ba\u8a8d\u3059\u308b\u3002etcd\u30af\u30e9\u30b9\u30bf\u304c\u5229\u7528\u4e0d\u53ef\u3068\u306e\u30e1\u30c3\u30bb\u30fc\u30b8\u304c\u51fa\u529b\u3055\u308c\u308b\u3002\n[root@master2 ~]# etcdctl member list\nFailed to get leader:  client: etcd cluster is unavailable or misconfigured\n\n\nmaster1,master3\u3067\u306f\u3001\u4ee5\u4e0b\u306e\u30e1\u30c3\u30bb\u30fc\u30b8\u304c\u51fa\u529b\u3055\u308c\u305f\u3002\netcd\u30c7\u30fc\u30e2\u30f3\u304c\u3044\u306a\u3044\u306e\u3067\u3001TCP\u63a5\u7d9a\u8981\u6c42\u304c\u62d2\u5426\u3055\u308c\u305f\u3053\u3068\u3092\u793a\u3057\u3066\u3044\u308b\u3002\n[root@master1 ~]# etcdctl member list\nError:  client: etcd cluster is unavailable or misconfigured\nerror #0: dial tcp 127.0.0.1:2379: getsockopt: connection refused\nerror #1: dial tcp 127.0.0.1:4001: getsockopt: connection refused\n\n[root@master3 ~]# etcdctl member list\nError:  client: etcd cluster is unavailable or misconfigured\nerror #0: dial tcp 127.0.0.1:2379: getsockopt: connection refused\nerror #1: dial tcp 127.0.0.1:4001: getsockopt: connection refused\n\n\n```\n\n##5.5 etcd\u30af\u30e9\u30b9\u30bf\u306e\u72b6\u614b\u3092\u78ba\u8a8d\u3059\u308b\u3002\n### \u30af\u30e9\u30b9\u30bf\u306e\u30e1\u30f3\u30d0\u304c\u6b8b\u308a1\u3064\u306b\u306a\u308b\u3068\u3001\u30af\u30e9\u30b9\u30bf\u304cunhealthy\u3068\u306a\u308a\u3001\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u304b\u3089\u306e\u30ea\u30fc\u30c9\u306f\u3067\u304d\u308b\u3051\u3069\u3001\u30e9\u30a4\u30c8\u306f\u3067\u304d\u306a\u304f\u306a\u308b\u6a21\u69d8\u3002\u307b\u3093\u3068???\n\n```\n\u30af\u30e9\u30b9\u30bf\u306e\u72b6\u614b\u3092\u78ba\u8a8d\u3059\u308b\u3002\u5168\u3066(master1,master2,master3)\u306e\u30e1\u30f3\u30d0\u304c\u751f\u304d\u3066\u3044\u308b\u3002\n[root@master1 ~]# etcdctl cluster-health\nmember 7bf3dc7e1bfc9229 is healthy: got healthy result from http://192.168.0.30:2379\nmember b19e62a463d4b18e is healthy: got healthy result from http://192.168.0.20:2379\nmember b22cf29c2bebb484 is healthy: got healthy result from http://192.168.0.10:2379\n\n[root@master1 ~]# etcdctl set os linux\nlinux\n\n[root@master1 ~]# etcdctl get os\nlinux\n\n[root@master3 ~]# ps -C etcd\n   PID TTY          TIME CMD\n  1820 pts/3    00:01:58 etcd\n[root@master3 ~]# kill 1820\n\n\n\u30af\u30e9\u30b9\u30bf\u306e\u72b6\u614b\u3092\u78ba\u8a8d\u3059\u308b\u3002master1\u3068master2\u304c\u751f\u304d\u3066\u3044\u308b\u3002master3\u306f\u6b7b\u3093\u3067\u3044\u308b\u3002\n[root@master1 ~]# etcdctl cluster-health\nfailed to check the health of member 7bf3dc7e1bfc9229 on http://192.168.0.30:2379: Get http://192.168.0.30:2379/health: dial tcp 192.168.0.30:2379: getsockopt: connection refused\nmember 7bf3dc7e1bfc9229 is unreachable: [http://192.168.0.30:2379] are all unreachable\nmember b19e62a463d4b18e is healthy: got healthy result from http://192.168.0.20:2379\nmember b22cf29c2bebb484 is healthy: got healthy result from http://192.168.0.10:2379\ncluster is healthy\n\n\n3\u3064\u306e\u30e1\u30f3\u30d0\u306e\u3046\u30612\u3064\u304c\u751f\u304d\u3066\u3044\u308c\u3070\u3001\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u3078\u306e\u30e9\u30a4\u30c8\u304c\u3067\u304d\u308b\u3002\n[root@master1 ~]# etcdctl set car GT-R\nGT-R\n\nmaster2\u306eetcd\u3092\u7d42\u4e86\u3059\u308b\u3002\n[root@master2 ~]# ps -C etcd\n   PID TTY          TIME CMD\n  1790 pts/0    00:03:07 etcd\n[root@master2 ~]# kill 1790\n\n\n\u30af\u30e9\u30b9\u30bf\u306e\u72b6\u614b\u3092\u78ba\u8a8d\u3059\u308b\u3002master1\u3060\u3051\u304c\u751f\u304d\u3066\u3044\u308b\u3002master2,3\u306f\u6b7b\u3093\u3067\u3044\u308b\u3002\n[root@master1 ~]# etcdctl cluster-health\nfailed to check the health of member 7bf3dc7e1bfc9229 on http://192.168.0.30:2379: Get http://192.168.0.30:2379/health: dial tcp 192.168.0.30:2379: getsockopt: connection refused\nmember 7bf3dc7e1bfc9229 is unreachable: [http://192.168.0.30:2379] are all unreachable\nfailed to check the health of member b19e62a463d4b18e on http://192.168.0.20:2379: Get http://192.168.0.20:2379/health: dial tcp 192.168.0.20:2379: getsockopt: connection refused\nmember b19e62a463d4b18e is unreachable: [http://192.168.0.20:2379] are all unreachable\nmember b22cf29c2bebb484 is unhealthy: got unhealthy result from http://192.168.0.10:2379\ncluster is unhealthy     <<<<<< \u30af\u30e9\u30b9\u30bf\u306e\u72b6\u614b\u304cunhealthy\u3068\u5224\u5b9a\u3055\u308c\u3066\u3044\u308b\u3002\n\n\n\u30af\u30e9\u30b9\u30bf\u5185\u306e\u30e1\u30f3\u30d0\u304c1\u3064\u3060\u3051\u3057\u304b\u751f\u304d\u3066\u3044\u306a\u3044\u3068\u3001\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u3078\u306e\u30e9\u30a4\u30c8\u304c\u3067\u304d\u306a\u3044\u3002\n[root@master1 ~]# etcdctl set month Nov\nError:  client: etcd cluster is unavailable or misconfigured\nerror #0: client: endpoint http://192.168.0.10:2379 exceeded header timeout\nerror #1: dial tcp 192.168.0.20:2379: getsockopt: connection refused\nerror #2: dial tcp 192.168.0.30:2379: getsockopt: connection refused\n\n\u3057\u304b\u3057\u3001\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u304b\u3089\u306e\u30ea\u30fc\u30c9\u306f\u3067\u304d\u308b\u3002\n[root@master1 ~]# etcdctl ls\n/os\n/car\n\n\u3053\u3053\u3067master2\u306eetcd\u3092\u8d77\u52d5\u3059\u308b\u3002\u3053\u306e\u6642\u70b9\u3067master1,master2\u304c\u751f\u304d\u3066\u3044\u308b\u3053\u3068\u306b\u306a\u308b\u3002\n[root@master2 ~]# ps -C etcd\n   PID TTY          TIME CMD\n  1811 pts/0    00:00:11 etcd\n\nmonth\u306b\u30c7\u30fc\u30bf\u3092\u8a2d\u5b9a\u3059\u308b\u3002\u8a2d\u5b9a\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u305f\u3002\n[root@master1 ~]# etcdctl set month Nov\nNov\n\n\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306e\u30ea\u30fc\u30c9\u3082\u3067\u304d\u305f\u3002\n[root@master1 ~]# etcdctl ls\n/month\n/os\n/car\n\n```\n\n\n##5.6 TCP2379\u756a\u30dd\u30fc\u30c8\u3078\u306e\u30a2\u30af\u30bb\u30b9\u3092\u78ba\u8a8d\u3059\u308b\u3002\n\n```\ntcpdump\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u3002\n[root@master1 ~]# yum -y install tcpdump\n\ntcpdump\u3092\u8d77\u52d5\u3059\u308b\u3002\u30dd\u30fc\u30c8\u756a\u53f7\u306b2379\u3092\u6307\u5b9a\u3059\u308b\u3002\n[root@master1 ~]# tcpdump -i eth0 tcp port 2379\ntcpdump: verbose output suppressed, use -v or -vv for full protocol decode\nlistening on eth0, link-type EN10MB (Ethernet), capture size 65535 bytes\n\n\n\n\u3082\u30461\u3064\u7aef\u672b\u3092\u8d77\u52d5\u3059\u308b\u3002\u305d\u3053\u3067\u3001etcdctl\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3059\u308b\u3002\n[root@master1 ~]# etcdctl member list\n\n\netcdctl\u30b3\u30de\u30f3\u30c9\u306e\u5b9f\u884c\u3068\u540c\u671f\u3057\u3066\u3001TCP\u30d1\u30b1\u30c3\u30c8\u306e\u9001\u53d7\u4fe1\u304c\u78ba\u8a8d\u3067\u304d\u308b\u3002\n\u6700\u521d\u306e3\u30d1\u30b1\u30c3\u30c8\u3067\u3001master1\u306eetcdctl\u30b3\u30de\u30f3\u30c9\u3068master3\uff08\u30ea\u30fc\u30c0\uff09\u306eetcd\u30c7\u30fc\u30e2\u30f3\u306e\u9593\u3067\nTCP\u30b3\u30cd\u30af\u30b7\u30e7\u30f3\u306e\u78ba\u7acb(3 way handshake)\u304c\u884c\u308f\u308c\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n\n\n\u3000\u3000\u3000master1:53186(etcdctl)         master3:2379(etcd)\n       |                                    |\n       +---------------- SYN  ------------->|\n       |<--------------- SYN +ACK ----------|\n       |---------------- ACK -------------->|\n\n\n\n17:59:48.705597 IP master1.53186 > master3.2379: Flags [S], seq 1724156849, win 14600, options [mss 1460,sackOK,TS val 3687348 ecr 0,nop,wscale 7], length 0\n17:59:48.707562 IP master3.2379 > master1.53186: Flags [S.], seq 354533212, ack 1724156850, win 14480, options [mss 1460,sackOK,TS val 3478680 ecr 3687348,nop,wscale 7], length 0\n17:59:48.708494 IP master1.53186 > master3.2379: Flags [.], ack 1, win 115, options [nop,nop,TS val 3687353 ecr 3478680], length 0\n17:59:48.713164 IP master1.53186 > master3.2379: Flags [P.], seq 1:109, ack 1, win 115, options [nop,nop,TS val 3687354 ecr 3478680], length 108\n17:59:48.714680 IP master3.2379 > master1.53186: Flags [.], ack 109, win 114, options [nop,nop,TS val 3478688 ecr 3687354], length 0\n17:59:48.715199 IP master3.2379 > master1.53186: Flags [P.], seq 1:536, ack 109, win 114, options [nop,nop,TS val 3478689 ecr 3687354], length 535\n17:59:48.715242 IP master1.53186 > master3.2379: Flags [.], ack 536, win 123, options [nop,nop,TS val 3687359 ecr 3478689], length 0\n17:59:48.716397 IP master1.53186 > master3.2379: Flags [P.], seq 109:224, ack 536, win 123, options [nop,nop,TS val 3687360 ecr 3478689], length 115\n17:59:48.718197 IP master3.2379 > master1.53186: Flags [P.], seq 536:807, ack 224, win 114, options [nop,nop,TS val 3478692 ecr 3687360], length 271\n17:59:48.720172 IP master1.53186 > master3.2379: Flags [F.], seq 224, ack 807, win 131, options [nop,nop,TS val 3687364 ecr 3478692], length 0\n17:59:48.721524 IP master3.2379 > master1.53186: Flags [F.], seq 807, ack 225, win 114, options [nop,nop,TS val 3478696 ecr 3687364], length 0\n17:59:48.721614 IP master1.53186 > master3.2379: Flags [.], ack 808, win 131, options [nop,nop,TS val 3687366 ecr 3478696], length 0\n\n\n```\n\n##5.6 TCP2380\u756a\u30dd\u30fc\u30c8\u3078\u306e\u30a2\u30af\u30bb\u30b9\u3092\u78ba\u8a8d\u3059\u308b\u3002\n2380\u756a\u30dd\u30fc\u30c8\u3067\u306f\u3001\u5e38\u6642\u3001\u30e1\u30c3\u30bb\u30fc\u30b8\u304c\u9001\u53d7\u4fe1\u3055\u308c\u3066\u3044\u308b\u3002\n\n```\n[root@master1 ~]# tcpdump -i eth0 tcp port 2380\ntcpdump: verbose output suppressed, use -v or -vv for full protocol decode\nlistening on eth0, link-type EN10MB (Ethernet), capture size 65535 bytes\n18:06:40.973494 IP master2.2380 > master3.52766: Flags [P.], seq 835860753:835860814, ack 2448790313, win 122, options [nop,nop,TS val 3945499 ecr 3890848], length 61\n18:06:40.973526 IP master2.2380 > master1.54930: Flags [P.], seq 4072016314:4072016376, ack 3951593931, win 122, options [nop,nop,TS val 3945499 ecr 4099518], length 62\n18:06:40.973590 IP master1.54930 > master2.2380: Flags [.], ack 62, win 123, options [nop,nop,TS val 4099618 ecr 3945499], length 0\n18:06:40.974528 IP master3.52766 > master2.2380: Flags [.], ack 61, win 148, options [nop,nop,TS val 3890947 ecr 3945499], length 0\n18:06:40.974535 IP master3.2380 > master2.38787: Flags [P.], seq 1427255133:1427255193, ack 3674681492, win 122, options [nop,nop,TS val 3890948 ecr 3945407], length 60\n18:06:40.974879 IP master2.38787 > master3.2380: Flags [.], ack 60, win 331, options [nop,nop,TS val 3945501 ecr 3890948], length 0\n18:06:40.976762 IP master1.2380 > master2.36442: Flags [P.], seq 1235860774:1235860835, ack 2751211062, win 122, options [nop,nop,TS val 4099620 ecr 3945411], length 61\n18:06:40.978482 IP master2.36442 > master1.2380: Flags [.], ack 61, win 331, options [nop,nop,TS val 3945505 ecr 4099620], length 0\n18:06:41.073308 IP master2.2380 > master3.52766: Flags [P.], seq 61:122, ack 1, win 122, options [nop,nop,TS val 3945599 ecr 3890947], length 61\n18:06:41.073337 IP master2.2380 > master1.54930: Flags [P.], seq 62:124, ack 1, win 122, options [nop,nop,TS val 3945599 ecr 4099618], length 62\n18:06:41.074338 IP master3.52766 > master2.2380: Flags [.], ack 122, win 148, options [nop,nop,TS val 3891047 ecr 3945599], length 0\n\u4ee5\u4e0b\u3001\u7565\n\n```\n\n\n\n#7. \u30b3\u30de\u30f3\u30c9\u304b\u3089etcd\u3092\u8d77\u52d5\u3059\u308b\u3002\n##7.1 master1\u3067\u5b9f\u884c\u3059\u308b\u30b3\u30de\u30f3\u30c9\n\n```\n[root@master1 ~]# etcd -name master1 \\\n>      -initial-advertise-peer-urls http://192.168.0.10:2380 \\\n>      -listen-peer-urls http://192.168.0.10:2380 \\\n>      -listen-client-urls http://192.168.0.10:2379,http://127.0.0.1:2379 \\\n>      -advertise-client-urls http://192.168.0.10:2379 \\\n>      -initial-cluster-token mytoken \\\n>      -initial-cluster master1=http://192.168.0.10:2380,master2=http://192.168.0.20:2380,master3=http://192.168.0.30:2380 \\\n>      -initial-cluster-state new &\n```\n\n##7.2 master2\u3067\u5b9f\u884c\u3059\u308b\u30b3\u30de\u30f3\u30c9\n\n```\n[root@master2 ~]# etcd -name master2 \\\n>      -initial-advertise-peer-urls http://192.168.0.20:2380 \\\n>      -listen-peer-urls http://192.168.0.20:2380 \\\n>      -listen-client-urls http://192.168.0.20:2379,http://127.0.0.1:2379 \\\n>      -advertise-client-urls http://192.168.0.20:2379 \\\n>      -initial-cluster-token mytoken \\\n>      -initial-cluster master1=http://192.168.0.10:2380,master2=http://192.168.0.20:2380,master3=http://192.168.0.30:2380 \\\n>      -initial-cluster-state new &\n```\n\n##7.3 master3\u3067\u5b9f\u884c\u3059\u308b\u30b3\u30de\u30f3\u30c9\n\n```\n[root@master3 ~]# etcd -name master3 \\\n>      -initial-advertise-peer-urls http://192.168.0.30:2380 \\\n>      -listen-peer-urls http://192.168.0.30:2380 \\\n>      -listen-client-urls http://192.168.0.30:2379,http://127.0.0.1:2379 \\\n>      -advertise-client-urls http://192.168.0.30:2379 \\\n>      -initial-cluster-token mytoken \\\n>      -initial-cluster master1=http://192.168.0.10:2380,master2=http://192.168.0.20:2380,master3=http://192.168.0.30:2380 \\\n>      -initial-cluster-state new &\n\n```\n\n#8. \u53c2\u8003\u60c5\u5831\n[Configuration flags]https://coreos.com/etcd/docs/latest/op-guide/configuration.html\n\n\n\n\n", "tags": ["kubernetes", "k8s", "etcd", "\u30af\u30e9\u30b9\u30bf", "CentOS"]}