{"context": " More than 1 year has passed since last update.Google Apps Script\u3067\u5272\u3068\u7c21\u5358\u306bGmail\u3092\u76e3\u8996\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u305f\u306e\u3067\u3001\n\u3010\u672a\u8aad\u3067 \u304b\u3064 \u4ef6\u540d\u306b\u300c\u52e4\u6020\u300d\u3068\u3044\u3046\u6587\u5b57\u5217\u304c\u542b\u307e\u308c\u3066\u3044\u308b\u3011\u30e1\u30fc\u30eb\u304c\u6765\u305f\u3089\u3001\u305d\u306e\u30e1\u30fc\u30eb\u3092\u65e2\u8aad\u306b\u5909\u3048\u3001\n\u5185\u5bb9\u3092Slack\u306b\u6295\u3052\u3066\u3001Garoon\u306e\u30b9\u30b1\u30b8\u30e5\u30fc\u30eb\u306b\u767b\u9332\u3059\u308b\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u66f8\u304d\u307e\u3057\u305f\uff01\nGaroon\u306e\u30e6\u30fc\u30b6ID\u304c\u308f\u304b\u308c\u3070GaroonAPI\u4f7f\u3063\u3066\u30b9\u30af\u30ea\u30d7\u30c8\u3067\u81ea\u52d5\u7684\u306b\u8272\u3005\u3067\u304d\u305d\u3046\u3067\u3059\u306d\n\n\u5168\u4f53\u306e\u30b3\u30fc\u30c9\n\n//\u30e6\u30fc\u30b6\u60c5\u5831(\u9023\u60f3\u914d\u5217)\nvar user_info = {\n  'ka2ya30201@gmail.com' : '0',\n};\n\n//MAIN\nfunction myFunction() {\n  try{\n    //\u4efb\u610f\u306e\u30af\u30a8\u30ea\u3067\u691c\u7d22\u3057\u305f\u7d50\u679c\u3092\u53d6\u5f97\n    var threads = GmailApp.search('is:unread AND subject:\u52e4\u6020');//\u30ab\u30c3\u30b3\u306e\u4e2d\u306f\u597d\u304d\u306a\u3088\u3046\u306b\n\n    //\u30b9\u30ec\u30c3\u30c9\u306e\u6570\u5206\u30eb\u30fc\u30d7\n    for (var i = 0; i < threads.length; i++) {\n      var thd = threads[i];\n      var msgs = thd.getMessages();\n\n      thd.markRead();\n\n      for (var j = 0; j < msgs.length; j++) {\n        var msg =        msgs[j];\n        var from =       msg.getFrom();\n        var address =    from.match(/\\<.+?\\>/)[0].replace(/<|>/g,\"\");\n\n        if(address in user_info){\n          var plain_body = msg.getPlainBody();\n          plain_body =     plain_body.substring(0,plain_body.indexOf(\"--\"));//\u7f72\u540d\u3092\u6d88\u3059\u51e6\u7406\n\n          var title =      thd.getFirstMessageSubject();\n          var link =       thd.getPermalink();\n\n          var m_date =     msg.getDate(); \n          var rm_date =    m_date.toLocaleString().replace(/JST/g,\"\");\n\n          var m_date_y =   m_date.getFullYear();\n          var m_date_m =   m_date.getMonth() + 1;\n          var m_date_d =   m_date.getDate();\n          var g_date =     m_date_y +\"-\"+ m_date_m +\"-\"+ m_date_d;\n\n          //Slack\u306b\u30e1\u30fc\u30eb\u5185\u5bb9\u6295\u3052\u308b\n          sendHttpPostSlack(\n            \"```\u4ef6\u540d: \" + title//\u3053\u3053\u304b\u3089\n            + rm_date\n            + \"\\nFrom: \" + from\n            + \"\\nTo: \" + msg.getTo()\n            + \"\\n\\n\" + plain_body.replace(/[\\n\\r]/g,\"\")\n            + \"\\n\\nlink: \" + link + \"``` \"//\u3053\u3053\u307e\u3067\u304cmessage\n            ,\"\u304d\u3093\u305f\u3044\u308c\u3093\u3089\u304f\u3093\");//username\n\n          //Garoon\u306b\u30e1\u30fc\u30eb\u5185\u5bb9\u6295\u3052\u308b\n          sendHttpPostGaroon(g_date,address,plain_body,title,link);\n        }\n        else\n        {\n          Logger.log(\"\u77e5\u3089\u306a\u3044\u30a2\u30c9\u30ec\u30b9\u304b\u3089\u30e1\u30fc\u30eb\u304c\u6765\u305f\u3088\");\n          return;\n        }\n      }\n    }\n  }\n  catch(e)\n  {\n    Logger.log(e);\n  }\n}\n\n/**\n * Slack\u306b\u30e1\u30fc\u30eb\u306e\u5185\u5bb9\u3092\u6295\u3052\u308b\n */\nfunction sendHttpPostSlack(message, username) {\n  //slack\u306eincoming webhooks\u306eurl\n\u3000var postUrl_slack = \"\u25b2\u25bc\u25b2\u25bc\u25b2\u25bc\u25b2\u25bc\u25b2\u25bc\u25b2\u25bc\u25b2\u25bc\u25b2\u25bc\u25b2\u25bc\u25b2\u25bc\u25b2\u25bc\u25b2\u25bc\u25b2\u25bc\u25b2\u25bc\u25b2\u25bc\u25b2\u25bc\u25b2\";\n\n  var postChannel =   \"#\u25b2\u25bc\u25b2\u25bc\u25b2\u25bc\u25b2\u25bc\u25b2\u25bc\u25b2\u25bc\u25b2\u25bc\u25b2\u25bc\u25b2\";//\u30e1\u30fc\u30eb\u306e\u4e2d\u8eab\u3092\u6d41\u3057\u305f\u3044slack\u306e\u30c1\u30e3\u30f3\u30cd\u30eb\uff08incoming webhooks\u306b\u3082\u540c\u3058\u540d\u524d\u3067\u6307\u5b9a\u3059\u308b\uff09\n\n  var jsonData = {\n    \"channel\": postChannel,\n    \"username\": username,\n    \"text\": message\n  };\n\n  var payload = JSON.stringify(jsonData);\n\n  var options = {\n    \"method\": \"post\",\n    \"contentType\": \"application/json\",\n    \"payload\": payload\n  };\n  UrlFetchApp.fetch(postUrl_slack, options);\n}\n\n/**\n * Garoon\u306b\u30e1\u30fc\u30eb\u306e\u5185\u5bb9\u3092\u6295\u3052\u308b\n */\nfunction sendHttpPostGaroon(g_date,address,plain_body,title,link) {\n  var url =     \"https://\u25b2\u25bc\u25b2\u25bc\u25b2\u25bc\u25b2\u25bc\u25b2.cybozu.com/g/cbpapi/schedule/api.csp?\";\n  var user_id = user_info[address];\n\n  var payload = createXML(user_id,g_date,plain_body,title,link);\n\n  var options = {\n    \"method\": \"post\",\n    \"contextType\": \"application/soap+xml\",\n    \"muteHttpExceptions\" : true,\n    \"payload\": payload\n  };\n  var response = UrlFetchApp.fetch(url, options);\n  Logger.log(XmlService.parse(response.getContentText()));\n}\n\nfunction createXML(user_id,g_date,plain_body,title,link){\n\n  var postUrl_garoon = \n    \"<?xml version=\\\"1.0\\\" encoding=\\\"UTF-8\\\"?>\\n\"+\n    \"<SOAP-ENV:Envelope xmlns:SOAP-ENV=\\\"http://www.w3.org/2003/05/soap-envelope\\\"\"+\n     \" xmlns:xsd=\\\"http://www.w3.org/2001/XMLSchema\\\"\"+\n     \" xmlns:xsi=\\\"http://www.w3.org/2001/XMLSchema-instance\\\"\"+\n     \" xmlns:SOAP-ENC=\\\"http://schemas.xmlsoap.org/soap/encoding\\\"\"+\n     \" xmlns:base_services=\\\"http://wsdl.cybozu.co.jp/base/2008\\\">\\n\"+\n      \"<SOAP-ENV:Header>\\n\"+\n        \"<Timestamp SOAP-ENV:mustUnderstand=\\\"1\\\" Id=\\\"id\\\"\"+\n         \" xmlns=\\\"http://schemas.xmlsoap.org/ws/2002/07/utility\\\">\\n\"+\n          \"<Created>2010-08-12T14:45:00Z</Created>\\n\"+\n          \"<Expires>2037-08-12T14:45:00Z</Expires>\\n\"+\n        \"</Timestamp>\\n\"+\n        \"<Action SOAP-ENV:mustUnderstand=\\\"1\\\"\"+\n          \" xmlns=\\\"http://schemas.xmlsoap.org/ws/2003/03/addressing\\\">\"+\n         \"ScheduleAddEvents\"+\n        \"</Action>\\n\"+\n        \"<Security xmlns:wsu=\\\"http://schemas.xmlsoap.org/ws/2002/07/utility\\\"\"+\n          \"SOAP-ENV:mustUnderstand=\\\"1\\\"\"+\n          \" xmlns=\\\"http://schemas.xmlsoap.org/ws/2002/12/secext\\\">\\n\"+\n          \"<UsernameToken wsu:Id=\\\"id\\\">\\n\"+\n            \"<Username>\u25b2\u25bc\u25b2\u25bc\u25b2\u25bc\u25b2\u25bc\u25b2\u25bc\u25b2\u25bc\u25b2\u25bc\u25b2\u25bc\u25b2\u25bc\u25b2\u25bc\u25b2\u25bc\u25b2\u25bc\u25b2\u25bc\u25b2\u25bc\u25b2\u25bc\u25b2\u25bc\u25b2</Username>\\n\"+\n            \"<Password>\u25b2\u25bc\u25b2\u25bc\u25b2\u25bc\u25b2\u25bc\u25b2\u25bc</Password>\\n\"+\n          \"</UsernameToken>\\n\"+\n        \"</Security>\\n\"+\n        \"<Locale>jp</Locale>\\n\"+\n      \"</SOAP-ENV:Header>\\n\"+\n      \"<SOAP-ENV:Body>\\n\"+\n        \"<ScheduleAddEvents>\\n\"+\n          \"<parameters>\\n\"+\n            \"<schedule_event\\n\"+\n             \" xmlns=\\\"\\\"\"+\n             \" id=\\\"dummy\\\"\"+\n             \" event_type=\\\"normal\\\"\"+\n             \" version=\\\"dummy\\\"\"+\n             \" public_type=\\\"public\\\"\"+\n             \" plan=\\\"\u4f11\u307f\\\"\"+\n             \" detail=\\\"\"+  title+ \"\\\"\"+\n             \" description=\\\"\" + plain_body +\"\\\"\"+\n             \" timezone=\\\"Asia/Tokyo\\\"\"+\n             \" end_timezone=\\\"Asia/Tokyo\\\"\"+\n             \" allday=\\\"true\\\">\\n\"+\n              \"<members>\\n\"+\n                \"<member>\\n\"+\n                  \"<user id=\\\"\"+ user_id + \"\\\"></user>\\n\"+\n                \"</member>\\n\"+\n              \"</members>\\n\"+\n              \"<when>\\n\"+\n                \"<date start=\\\"\" + g_date + \"\\\" end=\\\"\" + g_date + \"\\\"></date>\\n\"+\n              \"</when>\\n\"+\n            \"</schedule_event>\\n\"+\n          \"</parameters>\\n\"+\n        \"</ScheduleAddEvents>\\n\"+\n      \"</SOAP-ENV:Body>\\n\"+\n    \"</SOAP-ENV:Envelope>\\n\";\n\n  return postUrl_garoon;\n}\n\n\nGoogle Apps Script\u3067\u5272\u3068\u7c21\u5358\u306bGmail\u3092\u76e3\u8996\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u305f\u306e\u3067\u3001\n\u3010\u672a\u8aad\u3067 \u304b\u3064 \u4ef6\u540d\u306b\u300c\u52e4\u6020\u300d\u3068\u3044\u3046\u6587\u5b57\u5217\u304c\u542b\u307e\u308c\u3066\u3044\u308b\u3011\u30e1\u30fc\u30eb\u304c\u6765\u305f\u3089\u3001\u305d\u306e\u30e1\u30fc\u30eb\u3092\u65e2\u8aad\u306b\u5909\u3048\u3001\n\u5185\u5bb9\u3092Slack\u306b\u6295\u3052\u3066\u3001Garoon\u306e\u30b9\u30b1\u30b8\u30e5\u30fc\u30eb\u306b\u767b\u9332\u3059\u308b\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u66f8\u304d\u307e\u3057\u305f\uff01\nGaroon\u306e\u30e6\u30fc\u30b6ID\u304c\u308f\u304b\u308c\u3070GaroonAPI\u4f7f\u3063\u3066\u30b9\u30af\u30ea\u30d7\u30c8\u3067\u81ea\u52d5\u7684\u306b\u8272\u3005\u3067\u304d\u305d\u3046\u3067\u3059\u306d\n\n## \u5168\u4f53\u306e\u30b3\u30fc\u30c9\n\n```js\n\n//\u30e6\u30fc\u30b6\u60c5\u5831(\u9023\u60f3\u914d\u5217)\nvar user_info = {\n  'ka2ya30201@gmail.com' : '0',\n};\n\n//MAIN\nfunction myFunction() {\n  try{\n    //\u4efb\u610f\u306e\u30af\u30a8\u30ea\u3067\u691c\u7d22\u3057\u305f\u7d50\u679c\u3092\u53d6\u5f97\n    var threads = GmailApp.search('is:unread AND subject:\u52e4\u6020');//\u30ab\u30c3\u30b3\u306e\u4e2d\u306f\u597d\u304d\u306a\u3088\u3046\u306b\n    \n    //\u30b9\u30ec\u30c3\u30c9\u306e\u6570\u5206\u30eb\u30fc\u30d7\n    for (var i = 0; i < threads.length; i++) {\n      var thd = threads[i];\n      var msgs = thd.getMessages();\n\n      thd.markRead();\n\n      for (var j = 0; j < msgs.length; j++) {\n        var msg =        msgs[j];\n        var from =       msg.getFrom();\n        var address =    from.match(/\\<.+?\\>/)[0].replace(/<|>/g,\"\");\n        \n        if(address in user_info){\n          var plain_body = msg.getPlainBody();\n          plain_body =     plain_body.substring(0,plain_body.indexOf(\"--\"));//\u7f72\u540d\u3092\u6d88\u3059\u51e6\u7406\n\n          var title =      thd.getFirstMessageSubject();\n          var link =       thd.getPermalink();\n\n          var m_date =     msg.getDate(); \n          var rm_date =    m_date.toLocaleString().replace(/JST/g,\"\");\n\n          var m_date_y =   m_date.getFullYear();\n          var m_date_m =   m_date.getMonth() + 1;\n          var m_date_d =   m_date.getDate();\n          var g_date =     m_date_y +\"-\"+ m_date_m +\"-\"+ m_date_d;\n          \n          //Slack\u306b\u30e1\u30fc\u30eb\u5185\u5bb9\u6295\u3052\u308b\n          sendHttpPostSlack(\n            \"```\u4ef6\u540d: \" + title//\u3053\u3053\u304b\u3089\n            + rm_date\n            + \"\\nFrom: \" + from\n            + \"\\nTo: \" + msg.getTo()\n            + \"\\n\\n\" + plain_body.replace(/[\\n\\r]/g,\"\")\n            + \"\\n\\nlink: \" + link + \"``` \"//\u3053\u3053\u307e\u3067\u304cmessage\n            ,\"\u304d\u3093\u305f\u3044\u308c\u3093\u3089\u304f\u3093\");//username\n\n          //Garoon\u306b\u30e1\u30fc\u30eb\u5185\u5bb9\u6295\u3052\u308b\n          sendHttpPostGaroon(g_date,address,plain_body,title,link);\n        }\n        else\n        {\n          Logger.log(\"\u77e5\u3089\u306a\u3044\u30a2\u30c9\u30ec\u30b9\u304b\u3089\u30e1\u30fc\u30eb\u304c\u6765\u305f\u3088\");\n          return;\n        }\n      }\n    }\n  }\n  catch(e)\n  {\n    Logger.log(e);\n  }\n}\n\n/**\n * Slack\u306b\u30e1\u30fc\u30eb\u306e\u5185\u5bb9\u3092\u6295\u3052\u308b\n */\nfunction sendHttpPostSlack(message, username) {\n  //slack\u306eincoming webhooks\u306eurl\n\u3000var postUrl_slack = \"\u25b2\u25bc\u25b2\u25bc\u25b2\u25bc\u25b2\u25bc\u25b2\u25bc\u25b2\u25bc\u25b2\u25bc\u25b2\u25bc\u25b2\u25bc\u25b2\u25bc\u25b2\u25bc\u25b2\u25bc\u25b2\u25bc\u25b2\u25bc\u25b2\u25bc\u25b2\u25bc\u25b2\";\n\n  var postChannel =   \"#\u25b2\u25bc\u25b2\u25bc\u25b2\u25bc\u25b2\u25bc\u25b2\u25bc\u25b2\u25bc\u25b2\u25bc\u25b2\u25bc\u25b2\";//\u30e1\u30fc\u30eb\u306e\u4e2d\u8eab\u3092\u6d41\u3057\u305f\u3044slack\u306e\u30c1\u30e3\u30f3\u30cd\u30eb\uff08incoming webhooks\u306b\u3082\u540c\u3058\u540d\u524d\u3067\u6307\u5b9a\u3059\u308b\uff09\n\n  var jsonData = {\n    \"channel\": postChannel,\n    \"username\": username,\n    \"text\": message\n  };\n  \n  var payload = JSON.stringify(jsonData);\n  \n  var options = {\n    \"method\": \"post\",\n    \"contentType\": \"application/json\",\n    \"payload\": payload\n  };\n  UrlFetchApp.fetch(postUrl_slack, options);\n}\n\n/**\n * Garoon\u306b\u30e1\u30fc\u30eb\u306e\u5185\u5bb9\u3092\u6295\u3052\u308b\n */\nfunction sendHttpPostGaroon(g_date,address,plain_body,title,link) {\n  var url =     \"https://\u25b2\u25bc\u25b2\u25bc\u25b2\u25bc\u25b2\u25bc\u25b2.cybozu.com/g/cbpapi/schedule/api.csp?\";\n  var user_id = user_info[address];\n\n  var payload = createXML(user_id,g_date,plain_body,title,link);\n\n  var options = {\n    \"method\": \"post\",\n    \"contextType\": \"application/soap+xml\",\n    \"muteHttpExceptions\" : true,\n    \"payload\": payload\n  };\n  var response = UrlFetchApp.fetch(url, options);\n  Logger.log(XmlService.parse(response.getContentText()));\n}\n\nfunction createXML(user_id,g_date,plain_body,title,link){\n\n  var postUrl_garoon = \n    \"<?xml version=\\\"1.0\\\" encoding=\\\"UTF-8\\\"?>\\n\"+\n    \"<SOAP-ENV:Envelope xmlns:SOAP-ENV=\\\"http://www.w3.org/2003/05/soap-envelope\\\"\"+\n     \" xmlns:xsd=\\\"http://www.w3.org/2001/XMLSchema\\\"\"+\n     \" xmlns:xsi=\\\"http://www.w3.org/2001/XMLSchema-instance\\\"\"+\n     \" xmlns:SOAP-ENC=\\\"http://schemas.xmlsoap.org/soap/encoding\\\"\"+\n     \" xmlns:base_services=\\\"http://wsdl.cybozu.co.jp/base/2008\\\">\\n\"+\n      \"<SOAP-ENV:Header>\\n\"+\n        \"<Timestamp SOAP-ENV:mustUnderstand=\\\"1\\\" Id=\\\"id\\\"\"+\n         \" xmlns=\\\"http://schemas.xmlsoap.org/ws/2002/07/utility\\\">\\n\"+\n          \"<Created>2010-08-12T14:45:00Z</Created>\\n\"+\n          \"<Expires>2037-08-12T14:45:00Z</Expires>\\n\"+\n        \"</Timestamp>\\n\"+\n        \"<Action SOAP-ENV:mustUnderstand=\\\"1\\\"\"+\n          \" xmlns=\\\"http://schemas.xmlsoap.org/ws/2003/03/addressing\\\">\"+\n         \"ScheduleAddEvents\"+\n        \"</Action>\\n\"+\n        \"<Security xmlns:wsu=\\\"http://schemas.xmlsoap.org/ws/2002/07/utility\\\"\"+\n          \"SOAP-ENV:mustUnderstand=\\\"1\\\"\"+\n          \" xmlns=\\\"http://schemas.xmlsoap.org/ws/2002/12/secext\\\">\\n\"+\n          \"<UsernameToken wsu:Id=\\\"id\\\">\\n\"+\n            \"<Username>\u25b2\u25bc\u25b2\u25bc\u25b2\u25bc\u25b2\u25bc\u25b2\u25bc\u25b2\u25bc\u25b2\u25bc\u25b2\u25bc\u25b2\u25bc\u25b2\u25bc\u25b2\u25bc\u25b2\u25bc\u25b2\u25bc\u25b2\u25bc\u25b2\u25bc\u25b2\u25bc\u25b2</Username>\\n\"+\n            \"<Password>\u25b2\u25bc\u25b2\u25bc\u25b2\u25bc\u25b2\u25bc\u25b2\u25bc</Password>\\n\"+\n          \"</UsernameToken>\\n\"+\n        \"</Security>\\n\"+\n        \"<Locale>jp</Locale>\\n\"+\n      \"</SOAP-ENV:Header>\\n\"+\n      \"<SOAP-ENV:Body>\\n\"+\n        \"<ScheduleAddEvents>\\n\"+\n          \"<parameters>\\n\"+\n            \"<schedule_event\\n\"+\n             \" xmlns=\\\"\\\"\"+\n             \" id=\\\"dummy\\\"\"+\n             \" event_type=\\\"normal\\\"\"+\n             \" version=\\\"dummy\\\"\"+\n             \" public_type=\\\"public\\\"\"+\n             \" plan=\\\"\u4f11\u307f\\\"\"+\n             \" detail=\\\"\"+  title+ \"\\\"\"+\n             \" description=\\\"\" + plain_body +\"\\\"\"+\n             \" timezone=\\\"Asia/Tokyo\\\"\"+\n             \" end_timezone=\\\"Asia/Tokyo\\\"\"+\n             \" allday=\\\"true\\\">\\n\"+\n              \"<members>\\n\"+\n                \"<member>\\n\"+\n                  \"<user id=\\\"\"+ user_id + \"\\\"></user>\\n\"+\n                \"</member>\\n\"+\n              \"</members>\\n\"+\n              \"<when>\\n\"+\n                \"<date start=\\\"\" + g_date + \"\\\" end=\\\"\" + g_date + \"\\\"></date>\\n\"+\n              \"</when>\\n\"+\n            \"</schedule_event>\\n\"+\n          \"</parameters>\\n\"+\n        \"</ScheduleAddEvents>\\n\"+\n      \"</SOAP-ENV:Body>\\n\"+\n    \"</SOAP-ENV:Envelope>\\n\";\n\n  return postUrl_garoon;\n}\n\n```\n", "tags": ["GoogleAppsScript", "gmail", "Slack", "garoon", "Cybozu"]}