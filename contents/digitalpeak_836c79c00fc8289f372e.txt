{"context": "\n\n\u76ee\u7684\n\nAZ\u3092\u8de8\u3044\u3060\u5197\u9577\u69cb\u6210\uff08Active-Standby\uff09\n\u6d6e\u52d5ip\u3067\u306e\u904b\u7528\u3067\u306a\u304f\u3001ELB\u306e\u30d8\u30eb\u30b9\u30c1\u30a7\u30c3\u30af\u306b\u4f9d\u5b58\u3055\u305b\u308b\n\n\n\u6700\u8fd1Update\u3055\u308c\u305f\u6a5f\u80fd\u306b\u3088\u308a\u3001\u904b\u7528\u304c\u53ef\u80fd\u306b\u3002Register or De-Register EC2 Instances for Your Load Balancer\n\nScaling Rundeck\n\n\n\n\n\u30a4\u30e1\u30fc\u30b8\n\n\n\u74b0\u5883\n\n\nRundeck -\u69cb\u7bc9\uff08H/A\u306a\u3057\uff09-\u306e\u69cb\u6210\u306bEC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u8ffd\u52a0\nActive/Standby\u69cb\u6210\uff08Standby\u306f\u30b5\u30fc\u30d0\u306f\u8d77\u52d5\u3057\u3066\u3044\u308b\u304c\u3001F/O\u306e\u30c8\u30ea\u30ac\u30fc\u3068\u306a\u308b\u30d7\u30ed\u30bb\u30b9\u3092\u505c\u6b62\u3055\u305b\u3066\u3044\u308b\uff09\nF/O\u306e\u30c8\u30ea\u30ac\u30fc\u306fRundeckd\u306e\u505c\u6b62\n\u30af\u30e9\u30b9\u30bf\u5236\u5fa1\u306b\u306fCorosync\u3001\u30ea\u30bd\u30fc\u30b9\u5236\u5fa1\u306fPacemaker\u3092\u4f7f\u7528\nRundeck\u306fProject\u3084\u305d\u308c\u306b\u53c2\u52a0\u3059\u308b\u30ce\u30fc\u30c9\u3092\u8a18\u8ff0\u3057\u305fResource\u3092DB\u3067\u306a\u304f\u3001\u30b5\u30fc\u30d0\u3067\u6301\u3064\u70ba\u3001Primary\u3068Secondary\u3067\u540c\u671f\u304c\u5fc5\u8981\uff08DRBD\u3084Rsync\u7b49\uff09\nELB\u3001SES,RDS,Route53,DRBD,VPC\u8a2d\u8a08\u306f\u7701\u304d\u307e\u3059\n\n\n\u69cb\u7bc9\n\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n$ sudo yum install http://iij.dl.osdn.jp/linux-ha/63919/pacemaker-repo-1.1.13-1.1.el6.x86_64.rpm\n$ sudo yum -c pacemaker.repo install pacemaker corosync pcs\n\n\n\u30af\u30e9\u30b9\u30bf\u5236\u5fa1\u8a2d\u5b9a\n\nPrimary\u3067authkey\u4f5c\u6210\n\n$ cd /etc/corosync\n$ sudo corosync-keygen -l\nCorosync Cluster Engine Authentication key generator.\nGathering 1024 bits for key from /dev/urandom.\nWriting corosync key to /etc/corosync/authkey.\n\n#Primary\u3068Secondary\u306e\u30d1\u30b9\u30d5\u30ec\u30fc\u30ba\u306a\u3057\u3067Keypair\u4f5c\u6210\n$ ssh-keygen -t rsa\nGenerating public/private rsa key pair.\nEnter file in which to save the key (/home/ec2-user/.ssh/id_rsa): \nEnter passphrase (empty for no passphrase): \nEnter same passphrase again: \nYour identification has been saved in /home/ec2-user/.ssh/id_rsa.\nYour public key has been saved in /home/ec2-user/.ssh/id_rsa.pub.\nThe key fingerprint is:\nd1:47:2f:98:fe:17:ab:02:f1:9f:14:cb:2c:73:b1:e5 ec2-user@ip-10-0-3-6\nThe key's randomart image is:\n+--[ RSA 2048]----+\n|            .    |\n|         . + .   |\n|        . + o .  |\n|        .o .o..  |\n|        So.o B.  |\n|        . +.B Eo |\n|         . *..o  |\n|          . oo   |\n|           ..    |\n+-----------------+\n$ sudo chown ec2-user authkey\n\n\nSecondary\u3067authkey\u4f5c\u6210\n\n$ cd /etc/corosync\n$ sudo touch authkey\n$ sudo chown e2-user authkey&&sudo chmod 600 authkey\n# ~/.ssh/authorized_keys\u306bPrimary\u3067\u4f5c\u6210\u3057\u305f\u516c\u958b\u9375\u3092\u8a18\u8ff0\n\n\nPrimary\u304b\u3089Secondary\u3078authkey\u3092\u30b3\u30d4\u30fc\n\n$ scp -i /home/ec2-user/.ssh/id_rsa /etc/corosync/authkey ec2-user@10.0.3.6:/etc/corosync/authkey\nauthkey                                                                                                                       100%  128     0.1KB/s   00:00\n\n\nconf\u8a2d\u5b9a\n\n\nPrimary\n\n\n\n\ncorosync.conf\n$ cd /etc/corosync\n$ sudo cp corosync.conf.example.udpu corosync.conf\n# Please read the corosync.conf.5 manual page\ntotem {\n        version: 2\n\n        crypto_cipher: none\n        crypto_hash: none\n\n        interface {\n                ringnumber: 0\n                bindnetaddr: 10.0.1.23\n                mcastport: 5405\n                ttl: 1\n        }\n        transport: udpu\n}\n\nlogging {\n        fileline: off\n        to_logfile: yes\n        to_syslog: yes\n        logfile: /var/log/cluster/corosync.log\n        debug: off\n        timestamp: on\n        logger_subsys {\n                subsys: QUORUM\n                debug: off\n        }\n}\n\nnodelist {\n        node {\n                ring0_addr: 10.0.1.23\n                nodeid: 1\n        }\n\n        node {\n                ring0_addr: 10.0.3.6\n                nodeid: 2\n        }\n\n}\n\nquorum {\n        # Enable and configure quorum subsystem (default: off)\n        # see also corosync.conf.5 and votequorum.5\n        provider: corosync_votequorum\n        expected_votes: 2\n}\n\n\n\nconf\u8a2d\u5b9a\n\n\nSecondary\n\n\n\n# Please read the corosync.conf.5 manual page\ntotem {\n    version: 2\n\n    crypto_cipher: none\n    crypto_hash: none\n\n    interface {\n        ringnumber: 0\n        bindnetaddr: 10.0.3.6\n        mcastport: 5405\n        ttl: 1\n    }\n    transport: udpu\n}\n\nlogging {\n    fileline: off\n    to_logfile: yes\n    to_syslog: yes\n    logfile: /var/log/cluster/corosync.log\n    debug: off\n    timestamp: on\n    logger_subsys {\n        subsys: QUORUM\n        debug: off\n    }\n}\n\nnodelist {\n    node {\n        ring0_addr: 10.0.1.23\n        nodeid: 1\n    }\n\n    node {\n        ring0_addr: 10.0.3.6\n        nodeid: 2\n    }\n\n}\n\nquorum {\n    # Enable and configure quorum subsystem (default: off)\n    # see also corosync.conf.5 and votequorum.5\n    provider: corosync_votequorum\n        expected_votes: 2\n}\n\n\nSG\u306eInbound\u306b5405(UDP)\u3092\u5b9a\u7fa9\u3059\u308b\n\n\n\n\u8d77\u52d5\u78ba\u8a8d\n\n\nPrimary\u30fbSecondary\u3067\u30b5\u30fc\u30d3\u30b9\u8d77\u52d5\n\n\n\n$ sudo service corosync start && sudo service pacemaker start\n$ sudo chkconfig corosync on&&sudo chkconfig pacemaker on&&sudo chkconfig --list | egrep -i 'corosync|pacemaker'\ncorosync        0:off   1:off   2:on    3:on    4:on    5:on    6:off\npacemaker       0:off   1:off   2:on    3:on    4:on    5:on    6:off\n$ sudo crm_mon -1\n#Current DC(designated controller)\u306f\u5148\u306b\u30b5\u30fc\u30d3\u30b9\u3092\u8d77\u52d5\u3055\u305b\u305f\u30b5\u30fc\u30d0\u306b\u306a\u308b\u3002\n#\u3053\u3053\u3067\u306fPrimary\u304cDC\u3002\nLast updated: Sat Dec 26 02:59:16 2015\nLast change: Sat Dec 26 02:28:53 2015 by hacluster via crmd on ip-10-0-1-23\nStack: corosync\nCurrent DC: ip-10-0-1-23 - partition with quorum\nVersion: 1.1.13-6052cd1\n2 Nodes configured\n0 Resources configured\n\n\nOnline: [ ip-10-0-1-23 ip-10-0-3-6 ]\n\n\n\u30ea\u30bd\u30fc\u30b9\u5236\u5fa1\u8a2d\u5b9a\n\nF/O\u306e\u30c8\u30ea\u30ac\u30fc\u306frundeckd\u306e\u505c\u6b62\n\u8a2d\u5b9a\u306fPrimary\u3060\u3051\u3067OK\u3002\n\n#\"no-quorum-policy: ignore\"\u306f\u30b9\u30d7\u30ea\u30c3\u30c8\u30d6\u30ec\u30a4\u30f3\u767a\u751f\u6642\u306b\u30af\u30a9\u30fc\u30e9\u30e0\uff08\u904e\u534a\u6570\u3068\u901a\u4fe1\u3067\u304d\u308b\u30ce\u30fc\u30c9\u304cHA\u30af\u30e9\u30b9\u30bf\u3068\u3057\u3066\u52d5\u4f5c\u3067\u304d\u308b\uff09\n#\u3092\u7121\u8996\u3059\u308b\u8a2d\u5b9a\uff08\u30af\u30a9\u30fc\u30e9\u30e0\u3092\u7372\u5f97\u3057\u3066\u52d5\u4f5c\u3059\u308b\uff09\u3067\u30012\u53f0\u69cb\u6210\u306e\u5834\u5408\u306f\u5fc5\u9808\n#STONITH(\u5236\u5fa1\u4e0d\u80fd\u306e\u30b5\u30fc\u30d0\u3092\u5f37\u5236\u7684\u306b\u96fb\u6e90OFF)\u306f2\u53f0\u69cb\u6210\u306e\u5834\u5408\u3001\u30bf\u30a4\u30df\u30f3\u30b0\u304c\u60aa\u3044\u3068\u76f8\u6253\u3061\u306b\u306a\u308b\u53ef\u80fd\u6027\u304c\u3042\u308b\u305f\u3081\u3001\u660e\u793a\u7684\u306b\u7121\u52b9\u5316\u8a2d\u5b9a\n#\u30ea\u30bd\u30fc\u30b9\u6545\u969c\u304c1\u56de\u767a\u751f\u3067F/O\u3059\u308b\u3088\u3046\u306b\u8a2d\u5b9a\n#\u30ea\u30bd\u30fc\u30b9\u76e3\u8996\u611f\u899a\u306f30\u79d2\n$ sudo pcs property set no-quorum-policy=ignore\n$ sudo pcs property set stonith-enabled=false\n$ sudo pcs resource defaults resource-stickiness=\"INFINITY\" migration-threshold=\"1\"\n$ sudo pcs resource create resource1 lsb:rundeckd op monitor interval=\"30\"\n$ sudo pcs resource group add rundeckd resource1\n\n$ sudo pcs property show\nCluster Properties:\n cluster-infrastructure: corosync\n dc-version: 1.1.13-6052cd1\n have-watchdog: false\n no-quorum-policy: ignore\n stonith-enabled: false\n$ sudo pcs resource show\n resource1      (lsb:rundeckd): Started ip-10-0-1-23\n\n\n\u6b63\u5e38\u306b\u30af\u30e9\u30b9\u30bf\u30ea\u30f3\u30b0\u3055\u308c\u3066\u3044\u308b\u72b6\u614b\n\n\n\u30af\u30a9\u30fc\u30e9\u30e0\u306fPrimary\u304c\u7372\u5f97\n\n\n\n$ sudo crm_mon -1\nLast updated: Sat Dec 26 07:38:10 2015\nLast change: Sat Dec 26 05:19:08 2015 by root via cibadmin on ip-10-0-1-23\nStack: corosync\nCurrent DC: ip-10-0-1-23 - partition with quorum\nVersion: 1.1.13-6052cd1\n2 Nodes configured\n1 Resources configured\n\n\nOnline: [ ip-10-0-1-23 ip-10-0-3-6 ]\n\n resource1      (lsb:rundeckd): Started ip-10-0-1-23\n\n\n\u52d5\u4f5c\u78ba\u8a8d\n\n\nELB\n\n\u7247\u7cfb\u3067\u3042\u308b\u3053\u3068\u3092\u78ba\u8a8d\n\n\n\n\nPrimary\u3067\u30c8\u30ea\u30ac\u30fc\u767a\u52d5\u3055\u305b\u308b\n\n[ec2-user@ip-10-0-1-23 ~]$ sudo service rundeckd stop\nStopping rundeckd:                                         [  OK  ]\n\n\nF/O\n\n\nPrimary\u3067\u30d7\u30ed\u30bb\u30b9\u30c0\u30a6\u30f3\u3092\u691c\u77e5\u3057\u3001resource\u304cSecondary\u3067\u30b9\u30bf\u30fc\u30c8\u3057\u305f\u3053\u3068\u3092\u78ba\u8a8d\n\n\n\n$ sudo crm_mon\nLast updated: Sun Dec 27 05:01:47 2015\nLast change: Sat Dec 26 05:19:08 2015 by root via cibadmin on ip-10-0-1-23\nStack: corosync\nCurrent DC: ip-10-0-1-23 - partition with quorum\nVersion: 1.1.13-6052cd1\n2 Nodes configured\n1 Resources configured\n\n\nOnline: [ ip-10-0-1-23 ip-10-0-3-6 ]\n\nresource1       (lsb:rundeckd): Started ip-10-0-3-6\n\nFailed actions:\n    resource1_monitor_30000 on ip-10-0-1-23 'not running' (7): call=13, status=complete, exit-reason='none', last-rc-change='Sun Dec 27 05:01:21 2015', queued=0ms, exec=0ms\n\n\n\nELB\n\nSecondary\u306b\u5207\u308a\u66ff\u308f\u3063\u3066\u3044\u308b\u3053\u3068\u3092\u78ba\u8a8d\n\n\n\u5207\u308a\u66ff\u308f\u308b\u6642\u9593\u306f\u30d8\u30eb\u30b9\u30c1\u30a7\u30c3\u30af\u306b\u4f9d\u5b58\u3059\u308b\n\n\n\u4e0b\u8a18\u3067\u306f1:10\u4ee5\u4e0a\u306f\u5fc5\u8981\uff08\u30c0\u30a6\u30f3\u30bf\u30a4\u30e0\uff09\n\n\n\u6d6e\u52d5IP\u306e\u904b\u7528\u3067\u3042\u308c\u3070\u3001\u30c0\u30a6\u30f3\u30bf\u30a4\u30e0\u306f\u6570\u79d2\n\n\n\n\n\n\n\n\n\nF/B\n\nSecondary\u304c\u30af\u30a9\u30fc\u30e9\u30e0\u3092\u7372\u5f97\u3059\u308b\u3088\u3046\u306bPrimary\u306e\u30af\u30e9\u30b9\u30bf\u3092\u518d\u8d77\u52d5\u3055\u305b\u308b\n\n\n\n$ sudo service corosync restart&&sudo service pacemaker restart\n$ sudo crm_mon -1\nLast updated: Sun Dec 27 16:43:30 2015\nLast change: Sat Dec 26 05:19:08 2015 by root via cibadmin on ip-10-0-1-23\nStack: corosync\nCurrent DC: ip-10-0-3-6 - partition with quorum\nVersion: 1.1.13-6052cd1\n2 Nodes configured\n1 Resources configured\n\n\nOnline: [ ip-10-0-1-23 ip-10-0-3-6 ]\n\n resource1      (lsb:rundeckd): Started ip-10-0-3-6\n\n\nSecondary\u3067\u30c8\u30ea\u30ac\u30fc\u767a\u52d5\n\n\n\u30af\u30e9\u30b9\u30bf\u518d\u8d77\u52d5\u3055\u305b\u3001Primary\u306b\u30af\u30a9\u30fc\u30e9\u30e0\u3092\u7372\u5f97\u3055\u305b\u308b\n\n\n\n$ sudo service rundeckd stop\nStopping rundeckd:                                         [  OK  ]\n[ec2-user@ip-10-0-3-6 ~]$ sudo service corosync restart&&sudo service pacemaker restart\nSignaling Corosync Cluster Engine (corosync) to terminate: [  OK  ]\nWaiting for corosync services to unload:.                  [  OK  ]\nStarting Corosync Cluster Engine (corosync):               [  OK  ]\nPacemaker Cluster Manager is already stopped               [  OK  ]\nStarting Pacemaker Cluster Manager \n\n$ sudo crm_mon -1\nLast updated: Sun Dec 27 16:53:45 2015\nLast change: Sat Dec 26 05:19:08 2015 by root via cibadmin on ip-10-0-1-23\nStack: corosync\nCurrent DC: ip-10-0-1-23 - partition with quorum\nVersion: 1.1.13-6052cd1\n2 Nodes configured\n1 Resources configured\n\n\nOnline: [ ip-10-0-1-23 ip-10-0-3-6 ]\n\n resource1      (lsb:rundeckd): Started ip-10-0-1-23\n\n\n\n# \u76ee\u7684\n* AZ\u3092\u8de8\u3044\u3060\u5197\u9577\u69cb\u6210\uff08Active-Standby\uff09\n* \u6d6e\u52d5ip\u3067\u306e\u904b\u7528\u3067\u306a\u304f\u3001ELB\u306e\u30d8\u30eb\u30b9\u30c1\u30a7\u30c3\u30af\u306b\u4f9d\u5b58\u3055\u305b\u308b\n    * \u6700\u8fd1Update\u3055\u308c\u305f\u6a5f\u80fd\u306b\u3088\u308a\u3001\u904b\u7528\u304c\u53ef\u80fd\u306b\u3002[Register or De-Register EC2 Instances for Your Load Balancer](http://docs.aws.amazon.com/ElasticLoadBalancing/latest/DeveloperGuide/elb-deregister-register-instances.html)\n    * [Scaling Rundeck](http://rundeck.org/1.6.2/administration/scaling-rundeck.html#overview)\n\n# \u30a4\u30e1\u30fc\u30b8\n![cloudcraft - Rundeck_H-A.png](https://qiita-image-store.s3.amazonaws.com/0/58788/9795cf16-7384-f308-d35a-6719a5cf188c.png)\n\n\n# \u74b0\u5883\n* [Rundeck -\u69cb\u7bc9\uff08H/A\u306a\u3057\uff09-](http://qiita.com/digitalpeak/items/57075937bd18ab782a00)\u306e\u69cb\u6210\u306bEC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u8ffd\u52a0\n* Active/Standby\u69cb\u6210\uff08Standby\u306f\u30b5\u30fc\u30d0\u306f\u8d77\u52d5\u3057\u3066\u3044\u308b\u304c\u3001F/O\u306e\u30c8\u30ea\u30ac\u30fc\u3068\u306a\u308b\u30d7\u30ed\u30bb\u30b9\u3092\u505c\u6b62\u3055\u305b\u3066\u3044\u308b\uff09\n* F/O\u306e\u30c8\u30ea\u30ac\u30fc\u306fRundeckd\u306e\u505c\u6b62\n* \u30af\u30e9\u30b9\u30bf\u5236\u5fa1\u306b\u306fCorosync\u3001\u30ea\u30bd\u30fc\u30b9\u5236\u5fa1\u306fPacemaker\u3092\u4f7f\u7528\n* Rundeck\u306fProject\u3084\u305d\u308c\u306b\u53c2\u52a0\u3059\u308b\u30ce\u30fc\u30c9\u3092\u8a18\u8ff0\u3057\u305fResource\u3092DB\u3067\u306a\u304f\u3001\u30b5\u30fc\u30d0\u3067\u6301\u3064\u70ba\u3001Primary\u3068Secondary\u3067\u540c\u671f\u304c\u5fc5\u8981\uff08DRBD\u3084Rsync\u7b49\uff09\n* ELB\u3001SES,RDS,Route53,DRBD,VPC\u8a2d\u8a08\u306f\u7701\u304d\u307e\u3059\n\n\n# \u69cb\u7bc9\n## \u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n```bash\n$ sudo yum install http://iij.dl.osdn.jp/linux-ha/63919/pacemaker-repo-1.1.13-1.1.el6.x86_64.rpm\n$ sudo yum -c pacemaker.repo install pacemaker corosync pcs\n```\n## \u30af\u30e9\u30b9\u30bf\u5236\u5fa1\u8a2d\u5b9a\n* Primary\u3067authkey\u4f5c\u6210\n\n```bash\n$ cd /etc/corosync\n$ sudo corosync-keygen -l\nCorosync Cluster Engine Authentication key generator.\nGathering 1024 bits for key from /dev/urandom.\nWriting corosync key to /etc/corosync/authkey.\n\n#Primary\u3068Secondary\u306e\u30d1\u30b9\u30d5\u30ec\u30fc\u30ba\u306a\u3057\u3067Keypair\u4f5c\u6210\n$ ssh-keygen -t rsa\nGenerating public/private rsa key pair.\nEnter file in which to save the key (/home/ec2-user/.ssh/id_rsa): \nEnter passphrase (empty for no passphrase): \nEnter same passphrase again: \nYour identification has been saved in /home/ec2-user/.ssh/id_rsa.\nYour public key has been saved in /home/ec2-user/.ssh/id_rsa.pub.\nThe key fingerprint is:\nd1:47:2f:98:fe:17:ab:02:f1:9f:14:cb:2c:73:b1:e5 ec2-user@ip-10-0-3-6\nThe key's randomart image is:\n+--[ RSA 2048]----+\n|            .    |\n|         . + .   |\n|        . + o .  |\n|        .o .o..  |\n|        So.o B.  |\n|        . +.B Eo |\n|         . *..o  |\n|          . oo   |\n|           ..    |\n+-----------------+\n$ sudo chown ec2-user authkey\n```\n\n* Secondary\u3067authkey\u4f5c\u6210\n\n```bash\n$ cd /etc/corosync\n$ sudo touch authkey\n$ sudo chown e2-user authkey&&sudo chmod 600 authkey\n# ~/.ssh/authorized_keys\u306bPrimary\u3067\u4f5c\u6210\u3057\u305f\u516c\u958b\u9375\u3092\u8a18\u8ff0\n```\n\n* Primary\u304b\u3089Secondary\u3078authkey\u3092\u30b3\u30d4\u30fc\n \n```bash\n$ scp -i /home/ec2-user/.ssh/id_rsa /etc/corosync/authkey ec2-user@10.0.3.6:/etc/corosync/authkey\nauthkey                                                                                                                       100%  128     0.1KB/s   00:00\n```\n\n* conf\u8a2d\u5b9a\n    * Primary\n\n```bash:corosync.conf\n$ cd /etc/corosync\n$ sudo cp corosync.conf.example.udpu corosync.conf\n# Please read the corosync.conf.5 manual page\ntotem {\n        version: 2\n\n        crypto_cipher: none\n        crypto_hash: none\n\n        interface {\n                ringnumber: 0\n                bindnetaddr: 10.0.1.23\n                mcastport: 5405\n                ttl: 1\n        }\n        transport: udpu\n}\n\nlogging {\n        fileline: off\n        to_logfile: yes\n        to_syslog: yes\n        logfile: /var/log/cluster/corosync.log\n        debug: off\n        timestamp: on\n        logger_subsys {\n                subsys: QUORUM\n                debug: off\n        }\n}\n\nnodelist {\n        node {\n                ring0_addr: 10.0.1.23\n                nodeid: 1\n        }\n\n        node {\n                ring0_addr: 10.0.3.6\n                nodeid: 2\n        }\n\n}\n\nquorum {\n        # Enable and configure quorum subsystem (default: off)\n        # see also corosync.conf.5 and votequorum.5\n        provider: corosync_votequorum\n        expected_votes: 2\n}\n```\n\n* conf\u8a2d\u5b9a\n    * Secondary\n\n```bash\n# Please read the corosync.conf.5 manual page\ntotem {\n\tversion: 2\n\n\tcrypto_cipher: none\n\tcrypto_hash: none\n\n\tinterface {\n\t\tringnumber: 0\n\t\tbindnetaddr: 10.0.3.6\n\t\tmcastport: 5405\n\t\tttl: 1\n\t}\n\ttransport: udpu\n}\n\nlogging {\n\tfileline: off\n\tto_logfile: yes\n\tto_syslog: yes\n\tlogfile: /var/log/cluster/corosync.log\n\tdebug: off\n\ttimestamp: on\n\tlogger_subsys {\n\t\tsubsys: QUORUM\n\t\tdebug: off\n\t}\n}\n\nnodelist {\n\tnode {\n\t\tring0_addr: 10.0.1.23\n\t\tnodeid: 1\n\t}\n\n\tnode {\n\t\tring0_addr: 10.0.3.6\n\t\tnodeid: 2\n\t}\n\n}\n\nquorum {\n\t# Enable and configure quorum subsystem (default: off)\n\t# see also corosync.conf.5 and votequorum.5\n\tprovider: corosync_votequorum\n        expected_votes: 2\n}\n```\n* SG\u306eInbound\u306b5405(UDP)\u3092\u5b9a\u7fa9\u3059\u308b\n\n***\n* \u8d77\u52d5\u78ba\u8a8d\n    * Primary\u30fbSecondary\u3067\u30b5\u30fc\u30d3\u30b9\u8d77\u52d5\n\n```bash\n$ sudo service corosync start && sudo service pacemaker start\n$ sudo chkconfig corosync on&&sudo chkconfig pacemaker on&&sudo chkconfig --list | egrep -i 'corosync|pacemaker'\ncorosync        0:off   1:off   2:on    3:on    4:on    5:on    6:off\npacemaker       0:off   1:off   2:on    3:on    4:on    5:on    6:off\n$ sudo crm_mon -1\n#Current DC(designated controller)\u306f\u5148\u306b\u30b5\u30fc\u30d3\u30b9\u3092\u8d77\u52d5\u3055\u305b\u305f\u30b5\u30fc\u30d0\u306b\u306a\u308b\u3002\n#\u3053\u3053\u3067\u306fPrimary\u304cDC\u3002\nLast updated: Sat Dec 26 02:59:16 2015\nLast change: Sat Dec 26 02:28:53 2015 by hacluster via crmd on ip-10-0-1-23\nStack: corosync\nCurrent DC: ip-10-0-1-23 - partition with quorum\nVersion: 1.1.13-6052cd1\n2 Nodes configured\n0 Resources configured\n\n\nOnline: [ ip-10-0-1-23 ip-10-0-3-6 ]\n```\n\n# \u30ea\u30bd\u30fc\u30b9\u5236\u5fa1\u8a2d\u5b9a\n* F/O\u306e\u30c8\u30ea\u30ac\u30fc\u306frundeckd\u306e\u505c\u6b62\n* \u8a2d\u5b9a\u306fPrimary\u3060\u3051\u3067OK\u3002\n\n```bash\n#\"no-quorum-policy: ignore\"\u306f\u30b9\u30d7\u30ea\u30c3\u30c8\u30d6\u30ec\u30a4\u30f3\u767a\u751f\u6642\u306b\u30af\u30a9\u30fc\u30e9\u30e0\uff08\u904e\u534a\u6570\u3068\u901a\u4fe1\u3067\u304d\u308b\u30ce\u30fc\u30c9\u304cHA\u30af\u30e9\u30b9\u30bf\u3068\u3057\u3066\u52d5\u4f5c\u3067\u304d\u308b\uff09\n#\u3092\u7121\u8996\u3059\u308b\u8a2d\u5b9a\uff08\u30af\u30a9\u30fc\u30e9\u30e0\u3092\u7372\u5f97\u3057\u3066\u52d5\u4f5c\u3059\u308b\uff09\u3067\u30012\u53f0\u69cb\u6210\u306e\u5834\u5408\u306f\u5fc5\u9808\n#STONITH(\u5236\u5fa1\u4e0d\u80fd\u306e\u30b5\u30fc\u30d0\u3092\u5f37\u5236\u7684\u306b\u96fb\u6e90OFF)\u306f2\u53f0\u69cb\u6210\u306e\u5834\u5408\u3001\u30bf\u30a4\u30df\u30f3\u30b0\u304c\u60aa\u3044\u3068\u76f8\u6253\u3061\u306b\u306a\u308b\u53ef\u80fd\u6027\u304c\u3042\u308b\u305f\u3081\u3001\u660e\u793a\u7684\u306b\u7121\u52b9\u5316\u8a2d\u5b9a\n#\u30ea\u30bd\u30fc\u30b9\u6545\u969c\u304c1\u56de\u767a\u751f\u3067F/O\u3059\u308b\u3088\u3046\u306b\u8a2d\u5b9a\n#\u30ea\u30bd\u30fc\u30b9\u76e3\u8996\u611f\u899a\u306f30\u79d2\n$ sudo pcs property set no-quorum-policy=ignore\n$ sudo pcs property set stonith-enabled=false\n$ sudo pcs resource defaults resource-stickiness=\"INFINITY\" migration-threshold=\"1\"\n$ sudo pcs resource create resource1 lsb:rundeckd op monitor interval=\"30\"\n$ sudo pcs resource group add rundeckd resource1\n\n$ sudo pcs property show\nCluster Properties:\n cluster-infrastructure: corosync\n dc-version: 1.1.13-6052cd1\n have-watchdog: false\n no-quorum-policy: ignore\n stonith-enabled: false\n$ sudo pcs resource show\n resource1      (lsb:rundeckd): Started ip-10-0-1-23\n```\n\n* \u6b63\u5e38\u306b\u30af\u30e9\u30b9\u30bf\u30ea\u30f3\u30b0\u3055\u308c\u3066\u3044\u308b\u72b6\u614b\n    * \u30af\u30a9\u30fc\u30e9\u30e0\u306fPrimary\u304c\u7372\u5f97\n\n```bash\n$ sudo crm_mon -1\nLast updated: Sat Dec 26 07:38:10 2015\nLast change: Sat Dec 26 05:19:08 2015 by root via cibadmin on ip-10-0-1-23\nStack: corosync\nCurrent DC: ip-10-0-1-23 - partition with quorum\nVersion: 1.1.13-6052cd1\n2 Nodes configured\n1 Resources configured\n\n\nOnline: [ ip-10-0-1-23 ip-10-0-3-6 ]\n\n resource1      (lsb:rundeckd): Started ip-10-0-1-23\n```\n\n#\u52d5\u4f5c\u78ba\u8a8d\n* ELB\n    * \u7247\u7cfb\u3067\u3042\u308b\u3053\u3068\u3092\u78ba\u8a8d\n![1.png](https://qiita-image-store.s3.amazonaws.com/0/58788/cc48290b-5f10-c6ed-7296-e8f5de5cc812.png)\n\n\n* Primary\u3067\u30c8\u30ea\u30ac\u30fc\u767a\u52d5\u3055\u305b\u308b\n\n```bash\n[ec2-user@ip-10-0-1-23 ~]$ sudo service rundeckd stop\nStopping rundeckd:                                         [  OK  ]\n```\n* F/O\n    * Primary\u3067\u30d7\u30ed\u30bb\u30b9\u30c0\u30a6\u30f3\u3092\u691c\u77e5\u3057\u3001resource\u304cSecondary\u3067\u30b9\u30bf\u30fc\u30c8\u3057\u305f\u3053\u3068\u3092\u78ba\u8a8d\n\n```bash\n$ sudo crm_mon\nLast updated: Sun Dec 27 05:01:47 2015\nLast change: Sat Dec 26 05:19:08 2015 by root via cibadmin on ip-10-0-1-23\nStack: corosync\nCurrent DC: ip-10-0-1-23 - partition with quorum\nVersion: 1.1.13-6052cd1\n2 Nodes configured\n1 Resources configured\n\n\nOnline: [ ip-10-0-1-23 ip-10-0-3-6 ]\n\nresource1       (lsb:rundeckd): Started ip-10-0-3-6\n\nFailed actions:\n    resource1_monitor_30000 on ip-10-0-1-23 'not running' (7): call=13, status=complete, exit-reason='none', last-rc-change='Sun Dec 27 05:01:21 2015', queued=0ms, exec=0ms\n```\n\n* ELB\n    * Secondary\u306b\u5207\u308a\u66ff\u308f\u3063\u3066\u3044\u308b\u3053\u3068\u3092\u78ba\u8a8d\n![a6ae3cba-1e3f-2536-7d00-ef816fcfc193.png](https://qiita-image-store.s3.amazonaws.com/0/58788/dade55c5-1ad5-be3c-eb15-1c1cb485b8b2.png)\n\n    * \u5207\u308a\u66ff\u308f\u308b\u6642\u9593\u306f\u30d8\u30eb\u30b9\u30c1\u30a7\u30c3\u30af\u306b\u4f9d\u5b58\u3059\u308b\n        * \u4e0b\u8a18\u3067\u306f1:10\u4ee5\u4e0a\u306f\u5fc5\u8981\uff08\u30c0\u30a6\u30f3\u30bf\u30a4\u30e0\uff09\n            * \u6d6e\u52d5IP\u306e\u904b\u7528\u3067\u3042\u308c\u3070\u3001\u30c0\u30a6\u30f3\u30bf\u30a4\u30e0\u306f\u6570\u79d2\n![2.png](https://qiita-image-store.s3.amazonaws.com/0/58788/636e90ef-ad8b-3c42-fa78-bf65ae2d350b.png)\n\n\n\n* F/B\n    * Secondary\u304c\u30af\u30a9\u30fc\u30e9\u30e0\u3092\u7372\u5f97\u3059\u308b\u3088\u3046\u306bPrimary\u306e\u30af\u30e9\u30b9\u30bf\u3092\u518d\u8d77\u52d5\u3055\u305b\u308b\n\n```bash\n$ sudo service corosync restart&&sudo service pacemaker restart\n$ sudo crm_mon -1\nLast updated: Sun Dec 27 16:43:30 2015\nLast change: Sat Dec 26 05:19:08 2015 by root via cibadmin on ip-10-0-1-23\nStack: corosync\nCurrent DC: ip-10-0-3-6 - partition with quorum\nVersion: 1.1.13-6052cd1\n2 Nodes configured\n1 Resources configured\n\n\nOnline: [ ip-10-0-1-23 ip-10-0-3-6 ]\n\n resource1      (lsb:rundeckd): Started ip-10-0-3-6\n```\n\n* Secondary\u3067\u30c8\u30ea\u30ac\u30fc\u767a\u52d5\n    * \u30af\u30e9\u30b9\u30bf\u518d\u8d77\u52d5\u3055\u305b\u3001Primary\u306b\u30af\u30a9\u30fc\u30e9\u30e0\u3092\u7372\u5f97\u3055\u305b\u308b\n\n```bash\n$ sudo service rundeckd stop\nStopping rundeckd:                                         [  OK  ]\n[ec2-user@ip-10-0-3-6 ~]$ sudo service corosync restart&&sudo service pacemaker restart\nSignaling Corosync Cluster Engine (corosync) to terminate: [  OK  ]\nWaiting for corosync services to unload:.                  [  OK  ]\nStarting Corosync Cluster Engine (corosync):               [  OK  ]\nPacemaker Cluster Manager is already stopped               [  OK  ]\nStarting Pacemaker Cluster Manager \n\n$ sudo crm_mon -1\nLast updated: Sun Dec 27 16:53:45 2015\nLast change: Sat Dec 26 05:19:08 2015 by root via cibadmin on ip-10-0-1-23\nStack: corosync\nCurrent DC: ip-10-0-1-23 - partition with quorum\nVersion: 1.1.13-6052cd1\n2 Nodes configured\n1 Resources configured\n\n\nOnline: [ ip-10-0-1-23 ip-10-0-3-6 ]\n\n resource1      (lsb:rundeckd): Started ip-10-0-1-23\n\n```\n![3.png](https://qiita-image-store.s3.amazonaws.com/0/58788/3fd12f45-d147-bacd-f549-b9ce3c3b9a84.png)\n\n\n\n\n", "tags": ["rundeck", "Job_Scheduling", "pacemaker", "corosync"]}