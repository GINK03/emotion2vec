{"context": " More than 1 year has passed since last update.Python\u3067API\u30b5\u30fc\u30d0\u30fc\u4f5c\u308b\u3068\u304d\u306e\u81ea\u5206\u7528\u306eAMI\u306b\u3064\u3044\u3066\u30e1\u30e2\u3002\n\u30d0\u30c3\u30af\u30c9\u30a2\u3068\u304b\u4ed5\u8fbc\u307e\u308c\u3066\u305f\u3089\u5acc\u3060\u304b\u3089\u3001\u4ed6\u4eba\u304c\u4f7f\u3046\u3053\u3068\u306f\u7121\u3044\u3060\u308d\u3046\u3051\u3069\u3001\u3082\u3057\u4f7f\u308f\u308c\u308b\u65b9\u304c\u3044\u308c\u3070\u81ea\u5df1\u8cac\u4efb\u3067\u304a\u9858\u3044\u81f4\u3057\u307e\u3059\u3002\n\u30c0\u30e1\u306a\u8a2d\u5b9a\u3068\u304b\u3042\u308c\u3070\u3001\u3054\u6307\u6458\u3044\u305f\u3060\u3051\u305f\u3089\u5e78\u3044\u3067\u3059\u3002\nnginx\u3001gunicorn\u3092\u5165\u308c\u3066\u308b\u3002\n\u5927\u96d1\u628a\u306b\u306f\u3001gunicorn\u3092Upstart\u4f7f\u3063\u30668000\u30dd\u30fc\u30c8\u3067\u7acb\u3061\u4e0a\u3052\u3068\u3044\u3066\u3001nginx\u3067\u30ea\u30d0\u30fc\u30b9\u30d7\u30ed\u30ad\u30b7\u3059\u308b\u611f\u3058\u3002\n\u958b\u767a\u7528\u30b5\u30fc\u30d0\u30fc\u3068\u3057\u3066\u8907\u6570\u306e\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u3092\u30db\u30b9\u30c6\u30a3\u30f3\u30b0\u3059\u308b\u306e\u3092\u60f3\u5b9a\u3057\u3066\u4f5c\u3063\u3066\u3066\u3001\u5404\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u7528\u306e\u30d5\u30a9\u30eb\u30c0\u69cb\u6210\u306f\u4ee5\u4e0b\u306e\u901a\u308a\u3002\n/home/www/\n\u2514\u2500\u2500 somedomain\n    \u251c\u2500\u2500 api_server\n    \u2502\u00a0\u00a0 \u251c\u2500\u2500 virtualenv\n    \u2502\u00a0\u00a0 \u251c\u2500\u2500 pip.txt\n    \u2502\u00a0\u00a0 \u2514\u2500\u2500 python\n    \u2502\u00a0\u00a0  \u00a0\u00a0 \u2514\u2500\u2500 server.py\n    \u2514\u2500\u2500 web\n        \u2514\u2500\u2500 htdocs\n         \u00a0\u00a0 \u2514\u2500\u2500 index.html\n\nwww\u306fnginx\u3084API\u30b5\u30fc\u30d0\u30fc\u3092\u5b9f\u884c\u3057\u3066\u308b\u30e6\u30fc\u30b6\u30fc\u3002\n\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u3054\u3068\u306bsomedomain\u30d5\u30a9\u30eb\u30c0\u304c\u5897\u3048\u3066\u3044\u304f\u611f\u3058\u3002\n\n\u30b5\u30fc\u30d0\u30fc\u306e\u7acb\u3061\u4e0a\u3052\u65b9\n\u516c\u958b\u3057\u3066\u308bAMI\u306eID\u306f\u3001ami-24486d4a\u3002\n\u9593\u9055\u3063\u3066\u9055\u3046AMI\u3092\u5165\u308c\u306a\u3044\u3088\u3046\u306b\u3057\u306a\u3044\u3068\u3002\nEC2\u306e\u30b3\u30f3\u30bd\u30fc\u30eb\u3092\u958b\u304f\u3002\n\u5de6\u306e\u30e1\u30cb\u30e5\u30fc\u306eAMI\u3092\u30af\u30ea\u30c3\u30af\u3057\u3066\u3001\u30a4\u30e1\u30fc\u30b8\u306e\u691c\u7d22\u30d0\u30fc\u3092\u30d1\u30d6\u30ea\u30c3\u30af\u30a4\u30e1\u30fc\u30b8\u306b\u3057\u3066\u3001\u691c\u7d22\u30d5\u30a3\u30fc\u30eb\u30c9\u306bami-24486d4a\u3092\u5165\u308c\u305f\u3089\u30a4\u30e1\u30fc\u30b8\u304c\u51fa\u3066\u304f\u308b\u3002\n\u53f3\u30af\u30ea\u30c3\u30af\u3067\u8d77\u52d5\u3059\u308b\u3002\n\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u305f\u3082\u306e\n\nyum\u306b\u3066\n\nnginx\ngit\n\n\n\u8a2d\u5b9a\n\u3044\u3058\u3063\u305f\u30d5\u30a1\u30a4\u30eb\u306f\u4ee5\u4e0b\u306e\u901a\u308a\u3002\n\nWeb\u30b5\u30fc\u30d0\u30fc\u306e\u8a2d\u5b9a\uff08nginx\uff09\n\n\u30b5\u30fc\u30d0\u30fc\u672c\u4f53\u306e\u8a2d\u5b9a\n\n/etc/nginx/nginx.conf\nuser  www;\nworker_processes  auto;\n\nerror_log  /var/log/nginx/error.log;\n\npid        /var/run/nginx.pid;\n\n\nevents {\n    worker_connections 1024;\n}\n\nhttp {\n    include         /etc/nginx/mime.types;\n    default_type    application/octet-stream;\n\n    log_format  main  '$remote_addr - $remote_user [$time_local] \"$request\" '\n                      '$status $body_bytes_sent \"$http_referer\" '\n                      '\"$http_user_agent\" \"$http_x_forwarded_for\"';\n\n    access_log  /var/log/nginx/access.log  main;\n\n    sendfile            on;\n    tcp_nopush          on;\n    tcp_nodelay         on;\n\n    keepalive_timeout   65;\n    types_hash_max_size 2048;\n\n    include /etc/nginx/conf.d/*.conf;\n\n    index   index.html index.htm;\n\n}\n\n\n\u30ec\u30b9\u30dd\u30f3\u30b9\u306b\u30b5\u30fc\u30d0\u30fc\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u304c\u5165\u3063\u3061\u3083\u3046\u30aa\u30d7\u30b7\u30e7\u30f3\u3092\u6d88\u3057\u5fd8\u308c\u3066\u305f\u306e\u3067\u3001\u3053\u306e\u8a2d\u5b9a\u3092http\u30c7\u30a3\u30ec\u30af\u30c6\u30a3\u30d6\u306e\u4e2d\u306b\u8ffd\u52a0\u3002\n    server_tokens off;\n\n\u4fee\u6b63\u304c\u6e9c\u307e\u3063\u305f\u3089\u3001AMI\u3092\u66f4\u65b0\u3057\u3088\u3046\u3002\n\n\u30d0\u30fc\u30c1\u30e3\u30eb\u30db\u30b9\u30c8\u306e\u8a2d\u5b9a\nCloudFlare\u4f7f\u3063\u3066\u3066\u3082\u3001\u5143IP\u304c\u5909\u308f\u3093\u306a\u3044\u3088\u3046\u306b\u3059\u308b\u8a2d\u5b9a\u5165\u308c\u3066\u308b\u3002\n\u8a73\u3057\u304f\u306f\u3001\u3053\u3061\u3089\u3002\n__pull_from_bitbucket\u306f\u3001Bitbucket\u3068\u30c7\u30d7\u30ed\u30a4\u9023\u643a\u3059\u308b\u3068\u304d\u306b\u3001\u30a2\u30af\u30bb\u30b9\u5143\u3092Bitbucket\u306eIP\u3067\u7d5e\u3063\u3066\u308b\u3002\nBitbucket\u3092\u4f7f\u308f\u306a\u3044\u6642\u306f\u3001\u6d88\u3059\u3002\n\n/etc/nginx/conf.d/somedomain.conf\nupstream somedomain_api_server {\n    server 127.0.0.1:8000 fail_timeout=0;\n}\n\nserver {\n    listen       80;\n    server_name  somedomain;\n    root         /home/www/somedomain/web/htdocs;\n\n    #charset koi8-r;\n\n    # for CloudFlare\n    set_real_ip_from 199.27.128.0/21;\n    set_real_ip_from 173.245.48.0/20;\n    set_real_ip_from 103.21.244.0/22;\n    set_real_ip_from 103.22.200.0/22;\n    set_real_ip_from 103.31.4.0/22;\n    set_real_ip_from 141.101.64.0/18;\n    set_real_ip_from 108.162.192.0/18;\n    set_real_ip_from 190.93.240.0/20;\n    set_real_ip_from 188.114.96.0/20; \n    set_real_ip_from 197.234.240.0/22;\n    set_real_ip_from 198.41.128.0/17;\n    set_real_ip_from 162.158.0.0/15;\n    set_real_ip_from 104.16.0.0/12;\n    set_real_ip_from 172.64.0.0/13;\n    set_real_ip_from 2400:cb00::/32;\n    set_real_ip_from 2606:4700::/32;\n    set_real_ip_from 2803:f800::/32;\n    set_real_ip_from 2405:b500::/32;\n    set_real_ip_from 2405:8100::/32;\n    real_ip_header CF-Connecting-IP;\n\n    access_log  /var/log/nginx/somedomain.access.log  main;\n\n    location /__pull_from_bitbucket {\n        satisfy any;\n        allow 131.103.20.160/27;\n        allow 165.254.145.0/26;\n        allow 104.192.143.0/24;\n        allow 220.156.98.58/32;\n        deny all;\n\n        try_files $uri $uri/ @proxy_to_app;\n    }\n\n    location / {\n        try_files $uri $uri/ @proxy_to_app;\n\n        add_header Cache-Tag main;\n    }\n\n    location @proxy_to_app {\n        satisfy any;\n\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_set_header Host $http_host;\n        proxy_redirect off;\n        #proxy_buffering off;\n        proxy_pass   http://somedomain_api_server;\n    } \n}\n\n\n\nAPI\u30b5\u30fc\u30d0\u30fc\u306e\u8a2d\u5b9a\uff08Upstart\u3067gunicorn\uff09\nwww\u30e6\u30fc\u30b6\u30fc\u3067API\u30b5\u30fc\u30d0\u30fc\u7528\u306evirtualenv\u74b0\u5883\u306bgunicorn\u3092\u5165\u308c\u3066\u308b\u3002\nGITHUB_HOOK_SECRET\u306f\u3001GitHub\u3068\u30c7\u30d7\u30ed\u30a4\u9023\u643a\u3059\u308b\u6642\u306b\u3001\u4f7f\u3046\u74b0\u5883\u5909\u6570\u3002\nGitHub\u4f7f\u308f\u306a\u3044\u6642\u306f\u3001\u6d88\u3059\u3002\n\n/etc/init/somedomain-api-server.conf\ndescription \"Somedomain API Server\"\n\nstart on runlevel [2345]\nstop on runlevel [016]\n\n# GitHub Hook Secret\nenv GITHUB_HOOK_SECRET=\"\"\n\nrespawn\nexec /home/www/somedomain/api_server/virtualenv/bin/gunicorn -b 127.0.0.1:8000 -w 4 -u www --chdir /home/www/somedomain/api_server/python --log-file /home/www/somedomain/api_server/logs/error_log --pythonpath /home/www/somedomain/api_server/python server:application\n\n\n\n\u30b5\u30f3\u30d7\u30eb\u30a2\u30d7\u30ea\nwww\u30e6\u30fc\u30b6\u30fc\u306e/home/www/somedomain\u306b\u304a\u3044\u3066\u308b\u3002\n\u9759\u7684\u30b3\u30f3\u30c6\u30f3\u30c4\u7528\u306e\u30d5\u30a9\u30eb\u30c0\u306fweb\u3001Python\u7528\u306e\u30d5\u30a9\u30eb\u30c0\u306fapi_server\u306b\u3057\u3066\u308b\u3002\nvirtualenv\u306f\u3001api_server/virtualenv\u306b\u5165\u308c\u3066\u308b\u3002\n\n\u30b5\u30fc\u30d0\u30fc\u306e\u8d77\u52d5\u3001\u505c\u6b62\n\nnginx\u306e\u8d77\u52d5\uff0f\u505c\u6b62\n# \u8d77\u52d5\nsudo /etc/init.d/nginx start\n\n# \u505c\u6b62\nsudo /etc/init.d/nginx stop\n\n# \u518d\u8d77\u52d5\nsudo /etc/init.d/nginx restart\n\n\ngunicorn\u306e\u8d77\u52d5\uff0f\u505c\u6b62\n# \u8d77\u52d5\nsudo start somedomain-api-server\n\n# \u505c\u6b62\nsudo stop somedomain-api-server\n\n# \u518d\u8d77\u52d5\nsudo restart somedomain-api-server\n\n\n\u30d0\u30fc\u30c1\u30e3\u30eb\u30db\u30b9\u30c8\u306e\u8ffd\u52a0\u624b\u9806\n\nwww\u30e6\u30fc\u30b6\u30fc\u306b\u306a\u3063\u3066\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u7528\u306e\u30d5\u30a9\u30eb\u30c0\u3092\u4f5c\u3063\u3066\u3001Python\u3068\u304bWeb\u306e\u30d5\u30a1\u30a4\u30eb\u3092\u7f6e\u304f\u3002\nAPI\u30b5\u30fc\u30d0\u30fc\u306e\u8a2d\u5b9a\u3092\u3059\u308b\u3002\uff08\u53c2\u8003\uff09\nWeb\u30b5\u30fc\u30d0\u30fc\u306e\u8a2d\u5b9a\u3092\u3059\u308b\u3002\uff08\u53c2\u8003\uff09\n\u5fc5\u8981\u306b\u5fdc\u3058\u3066GitHub\u3001Bitbucket\u306e\u30c7\u30d7\u30ed\u30a4\u9023\u643a\u306e\u8a2d\u5b9a\u3092\u3059\u308b\u3002\n\nPython\u3067API\u30b5\u30fc\u30d0\u30fc\u4f5c\u308b\u3068\u304d\u306e\u81ea\u5206\u7528\u306eAMI\u306b\u3064\u3044\u3066\u30e1\u30e2\u3002\n\u30d0\u30c3\u30af\u30c9\u30a2\u3068\u304b\u4ed5\u8fbc\u307e\u308c\u3066\u305f\u3089\u5acc\u3060\u304b\u3089\u3001\u4ed6\u4eba\u304c\u4f7f\u3046\u3053\u3068\u306f\u7121\u3044\u3060\u308d\u3046\u3051\u3069\u3001\u3082\u3057\u4f7f\u308f\u308c\u308b\u65b9\u304c\u3044\u308c\u3070\u81ea\u5df1\u8cac\u4efb\u3067\u304a\u9858\u3044\u81f4\u3057\u307e\u3059\u3002\n\n\u30c0\u30e1\u306a\u8a2d\u5b9a\u3068\u304b\u3042\u308c\u3070\u3001\u3054\u6307\u6458\u3044\u305f\u3060\u3051\u305f\u3089\u5e78\u3044\u3067\u3059\u3002\n\nnginx\u3001[gunicorn](http://gunicorn.org/)\u3092\u5165\u308c\u3066\u308b\u3002\n\n\u5927\u96d1\u628a\u306b\u306f\u3001gunicorn\u3092[Upstart](https://ja.wikipedia.org/wiki/Upstart)\u4f7f\u3063\u30668000\u30dd\u30fc\u30c8\u3067\u7acb\u3061\u4e0a\u3052\u3068\u3044\u3066\u3001nginx\u3067\u30ea\u30d0\u30fc\u30b9\u30d7\u30ed\u30ad\u30b7\u3059\u308b\u611f\u3058\u3002\n\n\u958b\u767a\u7528\u30b5\u30fc\u30d0\u30fc\u3068\u3057\u3066\u8907\u6570\u306e\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u3092\u30db\u30b9\u30c6\u30a3\u30f3\u30b0\u3059\u308b\u306e\u3092\u60f3\u5b9a\u3057\u3066\u4f5c\u3063\u3066\u3066\u3001\u5404\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u7528\u306e\u30d5\u30a9\u30eb\u30c0\u69cb\u6210\u306f\u4ee5\u4e0b\u306e\u901a\u308a\u3002\n\n```text\n/home/www/\n\u2514\u2500\u2500 somedomain\n    \u251c\u2500\u2500 api_server\n    \u2502\u00a0\u00a0 \u251c\u2500\u2500 virtualenv\n    \u2502\u00a0\u00a0 \u251c\u2500\u2500 pip.txt\n    \u2502\u00a0\u00a0 \u2514\u2500\u2500 python\n    \u2502\u00a0\u00a0  \u00a0\u00a0 \u2514\u2500\u2500 server.py\n    \u2514\u2500\u2500 web\n        \u2514\u2500\u2500 htdocs\n         \u00a0\u00a0 \u2514\u2500\u2500 index.html\n```\n\n`www`\u306f*nginx*\u3084API\u30b5\u30fc\u30d0\u30fc\u3092\u5b9f\u884c\u3057\u3066\u308b\u30e6\u30fc\u30b6\u30fc\u3002\n\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u3054\u3068\u306b`somedomain`\u30d5\u30a9\u30eb\u30c0\u304c\u5897\u3048\u3066\u3044\u304f\u611f\u3058\u3002\n\n# \u30b5\u30fc\u30d0\u30fc\u306e\u7acb\u3061\u4e0a\u3052\u65b9\n\n\u516c\u958b\u3057\u3066\u308bAMI\u306eID\u306f\u3001`ami-24486d4a`\u3002\n\u9593\u9055\u3063\u3066\u9055\u3046AMI\u3092\u5165\u308c\u306a\u3044\u3088\u3046\u306b\u3057\u306a\u3044\u3068\u3002\n\nEC2\u306e\u30b3\u30f3\u30bd\u30fc\u30eb\u3092\u958b\u304f\u3002\n\n\u5de6\u306e\u30e1\u30cb\u30e5\u30fc\u306eAMI\u3092\u30af\u30ea\u30c3\u30af\u3057\u3066\u3001\u30a4\u30e1\u30fc\u30b8\u306e\u691c\u7d22\u30d0\u30fc\u3092*\u30d1\u30d6\u30ea\u30c3\u30af\u30a4\u30e1\u30fc\u30b8*\u306b\u3057\u3066\u3001\u691c\u7d22\u30d5\u30a3\u30fc\u30eb\u30c9\u306b`ami-24486d4a`\u3092\u5165\u308c\u305f\u3089\u30a4\u30e1\u30fc\u30b8\u304c\u51fa\u3066\u304f\u308b\u3002\n\n\u53f3\u30af\u30ea\u30c3\u30af\u3067\u8d77\u52d5\u3059\u308b\u3002\n\n\n# \u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u305f\u3082\u306e\n\n## yum\u306b\u3066\n\n- nginx\n- git\n\n\n# \u8a2d\u5b9a\n\n\u3044\u3058\u3063\u305f\u30d5\u30a1\u30a4\u30eb\u306f\u4ee5\u4e0b\u306e\u901a\u308a\u3002\n\n## Web\u30b5\u30fc\u30d0\u30fc\u306e\u8a2d\u5b9a\uff08nginx\uff09\n\n### \u30b5\u30fc\u30d0\u30fc\u672c\u4f53\u306e\u8a2d\u5b9a\n\n```nginx:/etc/nginx/nginx.conf\nuser  www;\nworker_processes  auto;\n\nerror_log  /var/log/nginx/error.log;\n\npid        /var/run/nginx.pid;\n\n\nevents {\n    worker_connections 1024;\n}\n\nhttp {\n    include         /etc/nginx/mime.types;\n    default_type    application/octet-stream;\n\n    log_format  main  '$remote_addr - $remote_user [$time_local] \"$request\" '\n                      '$status $body_bytes_sent \"$http_referer\" '\n                      '\"$http_user_agent\" \"$http_x_forwarded_for\"';\n\n    access_log  /var/log/nginx/access.log  main;\n\n    sendfile            on;\n    tcp_nopush          on;\n    tcp_nodelay         on;\n\n    keepalive_timeout   65;\n    types_hash_max_size 2048;\n\n    include /etc/nginx/conf.d/*.conf;\n\n    index   index.html index.htm;\n\n}\n```\n\n\u30ec\u30b9\u30dd\u30f3\u30b9\u306b\u30b5\u30fc\u30d0\u30fc\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u304c\u5165\u3063\u3061\u3083\u3046\u30aa\u30d7\u30b7\u30e7\u30f3\u3092\u6d88\u3057\u5fd8\u308c\u3066\u305f\u306e\u3067\u3001\u3053\u306e\u8a2d\u5b9a\u3092http\u30c7\u30a3\u30ec\u30af\u30c6\u30a3\u30d6\u306e\u4e2d\u306b\u8ffd\u52a0\u3002\n\n```nginx\n    server_tokens off;\n```\n\n\u4fee\u6b63\u304c\u6e9c\u307e\u3063\u305f\u3089\u3001AMI\u3092\u66f4\u65b0\u3057\u3088\u3046\u3002\n\n### \u30d0\u30fc\u30c1\u30e3\u30eb\u30db\u30b9\u30c8\u306e\u8a2d\u5b9a\n\n[CloudFlare](https://www.cloudflare.com/)\u4f7f\u3063\u3066\u3066\u3082\u3001\u5143IP\u304c\u5909\u308f\u3093\u306a\u3044\u3088\u3046\u306b\u3059\u308b\u8a2d\u5b9a\u5165\u308c\u3066\u308b\u3002\n\u8a73\u3057\u304f\u306f\u3001[\u3053\u3061\u3089](https://support.cloudflare.com/hc/en-us/articles/200170706-How-do-I-restore-original-visitor-IP-with-Nginx-)\u3002\n\n`__pull_from_bitbucket`\u306f\u3001[Bitbucket\u3068\u30c7\u30d7\u30ed\u30a4\u9023\u643a\u3059\u308b](http://qiita.com/polikeiji/items/fc6f9bbe7a619a053319)\u3068\u304d\u306b\u3001\u30a2\u30af\u30bb\u30b9\u5143\u3092*Bitbucket*\u306eIP\u3067\u7d5e\u3063\u3066\u308b\u3002\nBitbucket\u3092\u4f7f\u308f\u306a\u3044\u6642\u306f\u3001\u6d88\u3059\u3002\n\n```nginx:/etc/nginx/conf.d/somedomain.conf\nupstream somedomain_api_server {\n    server 127.0.0.1:8000 fail_timeout=0;\n}\n\nserver {\n    listen       80;\n    server_name  somedomain;\n    root         /home/www/somedomain/web/htdocs;\n\n    #charset koi8-r;\n\n    # for CloudFlare\n    set_real_ip_from 199.27.128.0/21;\n    set_real_ip_from 173.245.48.0/20;\n    set_real_ip_from 103.21.244.0/22;\n    set_real_ip_from 103.22.200.0/22;\n    set_real_ip_from 103.31.4.0/22;\n    set_real_ip_from 141.101.64.0/18;\n    set_real_ip_from 108.162.192.0/18;\n    set_real_ip_from 190.93.240.0/20;\n    set_real_ip_from 188.114.96.0/20; \n    set_real_ip_from 197.234.240.0/22;\n    set_real_ip_from 198.41.128.0/17;\n    set_real_ip_from 162.158.0.0/15;\n    set_real_ip_from 104.16.0.0/12;\n    set_real_ip_from 172.64.0.0/13;\n    set_real_ip_from 2400:cb00::/32;\n    set_real_ip_from 2606:4700::/32;\n    set_real_ip_from 2803:f800::/32;\n    set_real_ip_from 2405:b500::/32;\n    set_real_ip_from 2405:8100::/32;\n    real_ip_header CF-Connecting-IP;\n\n    access_log  /var/log/nginx/somedomain.access.log  main;\n\n    location /__pull_from_bitbucket {\n        satisfy any;\n        allow 131.103.20.160/27;\n        allow 165.254.145.0/26;\n        allow 104.192.143.0/24;\n        allow 220.156.98.58/32;\n        deny all;\n\n        try_files $uri $uri/ @proxy_to_app;\n    }\n\n    location / {\n        try_files $uri $uri/ @proxy_to_app;\n\n        add_header Cache-Tag main;\n    }\n\n    location @proxy_to_app {\n        satisfy any;\n\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_set_header Host $http_host;\n        proxy_redirect off;\n        #proxy_buffering off;\n        proxy_pass   http://somedomain_api_server;\n    } \n}\n```\n\n## API\u30b5\u30fc\u30d0\u30fc\u306e\u8a2d\u5b9a\uff08Upstart\u3067gunicorn\uff09\n\n*www*\u30e6\u30fc\u30b6\u30fc\u3067API\u30b5\u30fc\u30d0\u30fc\u7528\u306e*virtualenv*\u74b0\u5883\u306b*gunicorn*\u3092\u5165\u308c\u3066\u308b\u3002\n\nGITHUB_HOOK_SECRET\u306f\u3001[GitHub\u3068\u30c7\u30d7\u30ed\u30a4\u9023\u643a\u3059\u308b](http://qiita.com/polikeiji/items/fc6f9bbe7a619a053319)\u6642\u306b\u3001\u4f7f\u3046\u74b0\u5883\u5909\u6570\u3002\nGitHub\u4f7f\u308f\u306a\u3044\u6642\u306f\u3001\u6d88\u3059\u3002\n\n\n```bash:/etc/init/somedomain-api-server.conf\ndescription \"Somedomain API Server\"\n\nstart on runlevel [2345]\nstop on runlevel [016]\n\n# GitHub Hook Secret\nenv GITHUB_HOOK_SECRET=\"\"\n\nrespawn\nexec /home/www/somedomain/api_server/virtualenv/bin/gunicorn -b 127.0.0.1:8000 -w 4 -u www --chdir /home/www/somedomain/api_server/python --log-file /home/www/somedomain/api_server/logs/error_log --pythonpath /home/www/somedomain/api_server/python server:application\n```\n\n## \u30b5\u30f3\u30d7\u30eb\u30a2\u30d7\u30ea\n\n*www*\u30e6\u30fc\u30b6\u30fc\u306e`/home/www/somedomain`\u306b\u304a\u3044\u3066\u308b\u3002\n\n\u9759\u7684\u30b3\u30f3\u30c6\u30f3\u30c4\u7528\u306e\u30d5\u30a9\u30eb\u30c0\u306f`web`\u3001Python\u7528\u306e\u30d5\u30a9\u30eb\u30c0\u306f`api_server`\u306b\u3057\u3066\u308b\u3002\n*virtualenv*\u306f\u3001`api_server/virtualenv`\u306b\u5165\u308c\u3066\u308b\u3002\n\n\n# \u30b5\u30fc\u30d0\u30fc\u306e\u8d77\u52d5\u3001\u505c\u6b62\n\n## nginx\u306e\u8d77\u52d5\uff0f\u505c\u6b62\n\n```bash\n# \u8d77\u52d5\nsudo /etc/init.d/nginx start\n\n# \u505c\u6b62\nsudo /etc/init.d/nginx stop\n\n# \u518d\u8d77\u52d5\nsudo /etc/init.d/nginx restart\n```\n\n## gunicorn\u306e\u8d77\u52d5\uff0f\u505c\u6b62\n\n```bash\n# \u8d77\u52d5\nsudo start somedomain-api-server\n\n# \u505c\u6b62\nsudo stop somedomain-api-server\n\n# \u518d\u8d77\u52d5\nsudo restart somedomain-api-server\n```\n\n\n# \u30d0\u30fc\u30c1\u30e3\u30eb\u30db\u30b9\u30c8\u306e\u8ffd\u52a0\u624b\u9806\n\n1. www\u30e6\u30fc\u30b6\u30fc\u306b\u306a\u3063\u3066\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u7528\u306e\u30d5\u30a9\u30eb\u30c0\u3092\u4f5c\u3063\u3066\u3001Python\u3068\u304bWeb\u306e\u30d5\u30a1\u30a4\u30eb\u3092\u7f6e\u304f\u3002\n2. API\u30b5\u30fc\u30d0\u30fc\u306e\u8a2d\u5b9a\u3092\u3059\u308b\u3002\uff08[\u53c2\u8003](http://qiita.com/polikeiji/items/51052ab6df169287a922#api%E3%82%B5%E3%83%BC%E3%83%90%E3%83%BC%E3%81%AE%E8%A8%AD%E5%AE%9Aupstart%E3%81%A7gunicorn)\uff09\n3. Web\u30b5\u30fc\u30d0\u30fc\u306e\u8a2d\u5b9a\u3092\u3059\u308b\u3002\uff08[\u53c2\u8003](http://qiita.com/polikeiji/items/51052ab6df169287a922#web%E3%82%B5%E3%83%BC%E3%83%90%E3%83%BC%E3%81%AE%E8%A8%AD%E5%AE%9Anginx)\uff09\n4. \u5fc5\u8981\u306b\u5fdc\u3058\u3066GitHub\u3001Bitbucket\u306e\u30c7\u30d7\u30ed\u30a4\u9023\u643a\u306e\u8a2d\u5b9a\u3092\u3059\u308b\u3002\n", "tags": ["AWS", "EC2", "Python", "bottle", "ami"]}