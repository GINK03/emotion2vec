{"context": "\n\n\u6982\u8981\nCircleCI \u3068 Serverless \u3092\u4f7f\u3063\u305f\u30b5\u30fc\u30d3\u30b9\u306e\u958b\u767a\u74b0\u5883\u306e\u96db\u5f62\u3002\n\n\u306f\u3058\u3081\u306b\n\u65b0\u3057\u304f\u30b5\u30fc\u30d3\u30b9\u3092\u4f5c\u308b\u3053\u3068\u306b\u306a\u308a\u307e\u3057\u3066\u3001 Serverless \u3092\u4f7f\u3046\u3053\u3068\u306b\u3057\u307e\u3059\u3002\nServerless: https://github.com/serverless/serverless\nCircleCI \u3067\u81ea\u52d5\u7684\u306b\u30c6\u30b9\u30c8\u3001 AWS \u306b\u30c7\u30d7\u30ed\u30a4\u3059\u308b\u3088\u3046\u306b\u3057\u3066\u304a\u304d\u307e\u3059\u3002\nCircleCI: https://circleci.com/\nGithub \u3067\u96db\u5f62\u3092\u516c\u958b\u3057\u307e\u3059\u3002\nhttps://github.com/exabugs/circleci\n\u96db\u5f62\u3092\u4f7f\u3063\u3066\u6700\u77ed\u3067\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u3092\u7acb\u3061\u4e0a\u3052\u308b\u624b\u9806\u3092\u4ee5\u4e0b\u3067\u793a\u3057\u307e\u3059\u3002\n\n\u6700\u77ed\u3067\u8a66\u3059\u306b\u306f\n\n\u30a2\u30ab\u30a6\u30f3\u30c8\u4f5c\u6210\n\n\nAWS\nGithub\nCircleCI\n\n\nGithub \u304b\u3089 clone Fork\ngit clone https://github.com/exabugs/circleci\n\u2192 [\u9593\u9055\u3044] Fork \u3067\u3059\u3002\u81ea\u5206\u306e Github \u306b Fork \u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\nCircleCI \u8a2d\u5b9a\n\n\u4e0a\u8a18 clone Fork \u3057\u305f\u30ea\u30dd\u30b8\u30c8\u30ea\u3092 CircleCI \u306e\u51e6\u7406\u5bfe\u8c61\u306b\u3059\u308b\u3002\n(\u30d7\u30e9\u30a4\u30d9\u30fc\u30c8\u3067\u3082\u53ef\u80fd)\nAWS\u7528\u306e\u4ee5\u4e0b\u306e\u74b0\u5883\u5909\u6570\u3092\u3001\u300cEnvironment variables\u300d\u306e\u8a2d\u5b9a\u306b\u8db3\u3059\u3002\n\nAWS_ACCESS_KEY_ID \nAWS_SECRET_ACCESS_KEY\n\n\n\n\n\n\n\u95a2\u6570 1 \u500b (functions/func1) \u3060\u3051\u30b5\u30f3\u30d7\u30eb\u3067\u5165\u308c\u3066\u307e\u3059\u3002\n\u95a2\u6570\u3092\u8ffd\u52a0\u3059\u308b\u306b\u306f\u4ee5\u4e0b\u306e\u30b3\u30de\u30f3\u30c9\u3067\nsls function create functions/func2\n\n\nPush\u3059\u308b\u3068\u3001CircleCI \u304c\u52d5\u4f5c\u3057\u3066\u3001AWS \u306b\u30c7\u30d7\u30ed\u30a4\u3057\u3066\u304f\u308c\u308b\u3002\n\u30d7\u30eb\u30ea\u30af\u306a\u3089\u3001\u30de\u30fc\u30b8\u524d\u306b\u30c6\u30b9\u30c8\u3057\u3066\u304f\u308c\u308b\u3002\u3053\u308c\u306f\u4fbf\u5229!!\n\n\n\n\u30b3\u30fc\u30c9\u8a73\u7d30\n\n\nscripts/aws_init\nAWS \u306e\u30af\u30ec\u30c7\u30f3\u30b7\u30e3\u30eb\u60c5\u5831\u3092 Serverless \u3067\u4f7f\u3048\u308b\u3088\u3046\u306b\u3059\u308b\u30b9\u30af\u30ea\u30d7\u30c8\nAWSDIR=~/.aws\nmkdir -p ${AWSDIR}\n\ncat << EOS > ${AWSDIR}/config\n[default]\nregion=${AWS_REGION}\nEOS\n\ncat << EOS > ${AWSDIR}/credentials\n[${AWS_PROFILE}]\naws_access_key_id=${AWS_ACCESS_KEY_ID}\naws_secret_access_key=${AWS_SECRET_ACCESS_KEY}\nEOS\n\n\n\nscripts/serverless.sh\nServerless \u306e\u5b9f\u884c\u30b9\u30af\u30ea\u30d7\u30c8\n(\u521d\u56de\u4ee5\u5916\u306f \u300cServerlessError: Stage dev already exists\u300d\u30a8\u30e9\u30fc\u306b\u306a\u308b\u304c\u5927\u4e08\u592b\u3002\u6c17\u306b\u3057\u306a\u3044\u3002)\nSTAGE=dev\nOPTION=\"-s $STAGE -r $AWS_REGION\"\nsls project init -p $AWS_PROFILE $OPTION\nsls resources deploy $OPTION\nsls function deploy $OPTION\nsls endpoint deploy $OPTION\n\n\n\ncircle.yml\nmachine:\n  timezone: Asia/Tokyo\n\n  node:\n    version: 4.4.1\n\n  environment:\n    AWS_REGION: ap-northeast-1\n    AWS_PROFILE: serverless-circleci_dev\n\n  post:\n    - bash ${CIRCLE_PROJECT_REPONAME}/scripts/circleci_env\n    - bash ${CIRCLE_PROJECT_REPONAME}/scripts/aws_init\n\ntest:\n  override:\n    - npm test\n\ndeployment:\n  production:\n    branch: master\n    commands:\n      - npm run deploy_prod\n\n  staging:\n    branch: develop\n    commands:\n      - npm run deploy_staging\n\n\n\ns-templates.json\nhttp://docs.serverless.com/docs/templates-variables#section-templates\n{\n  \"apiRequestTemplate\": {\n    \"application/json\": {\n      \"httpMethod\": \"$context.httpMethod\",\n      \"body\": \"$input.json('$')\",\n      \"queryParams\": \"$input.params().querystring\",\n      \"headerParams\": \"$input.params().header\",\n      \"headerParamNames\": \"$input.params().header.keySet()\",\n      \"contentTypeValue\": \"$input.params().header.get('Content-Type')\"\n    }\n  }\n}\n\n\n\n\n\u307e\u3068\u3081\n\nServerless \u306f\u307e\u3060\u03b2\u7248\u3067\u3001\u983b\u7e41\u306b\u66f4\u65b0\u3055\u308c\u3066\u3044\u308b\u306e\u3067\u8981\u6ce8\u610f\u3067\u3059\u3002\n\u30b5\u30fc\u30d0\u30ec\u30b9 (Lambda) \u3067\u30b5\u30fc\u30d3\u30b9\u5168\u4f53\u3092\u4f5c\u308b\u3053\u3068\u304c\u3067\u304d\u308b\u304b\u5206\u304b\u3089\u306a\u3044\u304c\u3001\u3068\u306b\u304b\u304f\u30c1\u30e3\u30ec\u30f3\u30b8\u3057\u3066\u307f\u307e\u3059\u3002\n\u8352\u3044\u8a18\u4e8b\u3067\u30b9\u30a4\u30de\u30bb\u30f3\u3002\u3053\u306a\u308c\u3066\u304d\u305f\u3089\u66f4\u65b0\u3057\u307e\u3059\u3002\n\n\n\u4ed8\u9332\n\nCircleCI \u8a2d\u5b9a\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\nhttps://circleci.com/docs/configuration\n\nCircleCI \u5b9f\u884c\u9806\u5e8f\n\n\nINFRASTRUCTURE\n\nStarting the build\nStart container\nEnable SSH\n\n\n\nCHECKOUT\n\nRestore source cache\nCheckout using deploy key: \n\n\n\nMACHINE\n\nSetting timezone to Asia/Tokyo\n\nExporting env vars from circle.yml\n(\u3010\u5b9a\u7fa9\u3011 circle.yml environment: )\n( \u2192 Github \u3067\u7ba1\u7406\u3059\u308b\u30d1\u30e9\u30e1\u30fc\u30bf)\nExporting AWS_REGION\nExporting AWS_PROFILE\n\n\n\nExporting env vars from project settings\n(\u3010\u5b9a\u7fa9\u3011 CircleCI\u8a2d\u5b9a Tweaks-EnvironmentVariables )\n( \u2192 Github \u3067\u7ba1\u7406\u3057\u306a\u3044\u30d1\u30e9\u30e1\u30fc\u30bf)\nExporting AWS_ACCESS_KEY_ID\nExporting AWS_SECRET_ACCESS_KEY\n\n\nset node.js version to 4.4.1\nRestore cache\n\npost\n\n$ npm run aws_init\n$ bash scripts/circleci_env\n$ bash scripts/aws_init\n\n\n\n\n\nDEPENDENCIES\n\n\nExporting NODE_ENV\nExporting NODE_ENV\n\n\n\nExporting PATH\nExporting PATH\n\n\n$ npm install\n\n\n\nDATABASE\n\nSave cache\n\n\n\nTEST\n\n$ npm test\n\n\nTEARDOWN\n\n## \u6982\u8981\nCircleCI \u3068 Serverless \u3092\u4f7f\u3063\u305f\u30b5\u30fc\u30d3\u30b9\u306e\u958b\u767a\u74b0\u5883\u306e\u96db\u5f62\u3002\n\n## \u306f\u3058\u3081\u306b\n\u65b0\u3057\u304f\u30b5\u30fc\u30d3\u30b9\u3092\u4f5c\u308b\u3053\u3068\u306b\u306a\u308a\u307e\u3057\u3066\u3001 Serverless \u3092\u4f7f\u3046\u3053\u3068\u306b\u3057\u307e\u3059\u3002\nServerless: https://github.com/serverless/serverless\n\nCircleCI \u3067\u81ea\u52d5\u7684\u306b\u30c6\u30b9\u30c8\u3001 AWS \u306b\u30c7\u30d7\u30ed\u30a4\u3059\u308b\u3088\u3046\u306b\u3057\u3066\u304a\u304d\u307e\u3059\u3002\nCircleCI: https://circleci.com/\n\nGithub \u3067\u96db\u5f62\u3092\u516c\u958b\u3057\u307e\u3059\u3002\nhttps://github.com/exabugs/circleci\n\n\u96db\u5f62\u3092\u4f7f\u3063\u3066\u6700\u77ed\u3067\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u3092\u7acb\u3061\u4e0a\u3052\u308b\u624b\u9806\u3092\u4ee5\u4e0b\u3067\u793a\u3057\u307e\u3059\u3002\n\n## \u6700\u77ed\u3067\u8a66\u3059\u306b\u306f\n\n1. \u30a2\u30ab\u30a6\u30f3\u30c8\u4f5c\u6210\n    - AWS\n    - Github\n    - CircleCI\n1. Github \u304b\u3089 ~~clone~~ Fork\n    ~~git clone https://github.com/exabugs/circleci~~\n    \u2192 [\u9593\u9055\u3044] Fork \u3067\u3059\u3002\u81ea\u5206\u306e Github \u306b Fork \u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n1. CircleCI \u8a2d\u5b9a\n\n    1. \u4e0a\u8a18 ~~clone~~ Fork \u3057\u305f\u30ea\u30dd\u30b8\u30c8\u30ea\u3092 CircleCI \u306e\u51e6\u7406\u5bfe\u8c61\u306b\u3059\u308b\u3002  \n      (\u30d7\u30e9\u30a4\u30d9\u30fc\u30c8\u3067\u3082\u53ef\u80fd)\n\n    1. AWS\u7528\u306e\u4ee5\u4e0b\u306e\u74b0\u5883\u5909\u6570\u3092\u3001\u300cEnvironment variables\u300d\u306e\u8a2d\u5b9a\u306b\u8db3\u3059\u3002  \n       - AWS_ACCESS_KEY_ID \n       - AWS_SECRET_ACCESS_KEY\n\n    ![\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2016-03-29 19.53.12.png](https://qiita-image-store.s3.amazonaws.com/0/69410/b4644252-8096-8388-2fdc-3af0aef7d1da.png)\n\n1. \u95a2\u6570 1 \u500b (functions/func1) \u3060\u3051\u30b5\u30f3\u30d7\u30eb\u3067\u5165\u308c\u3066\u307e\u3059\u3002\n\u95a2\u6570\u3092\u8ffd\u52a0\u3059\u308b\u306b\u306f\u4ee5\u4e0b\u306e\u30b3\u30de\u30f3\u30c9\u3067\n\n    ```\n    sls function create functions/func2\n    ```\n\n1. Push\u3059\u308b\u3068\u3001CircleCI \u304c\u52d5\u4f5c\u3057\u3066\u3001AWS \u306b\u30c7\u30d7\u30ed\u30a4\u3057\u3066\u304f\u308c\u308b\u3002\n\u30d7\u30eb\u30ea\u30af\u306a\u3089\u3001\u30de\u30fc\u30b8\u524d\u306b\u30c6\u30b9\u30c8\u3057\u3066\u304f\u308c\u308b\u3002\u3053\u308c\u306f\u4fbf\u5229!!\n\n![\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2016-03-29 23.16.12.png](https://qiita-image-store.s3.amazonaws.com/0/69410/626f5c80-0879-f6d8-efcb-7de544e3a8c4.png)\n\n\n\n\n\n## \u30b3\u30fc\u30c9\u8a73\u7d30\n\n- scripts/aws_init\n    AWS \u306e\u30af\u30ec\u30c7\u30f3\u30b7\u30e3\u30eb\u60c5\u5831\u3092 Serverless \u3067\u4f7f\u3048\u308b\u3088\u3046\u306b\u3059\u308b\u30b9\u30af\u30ea\u30d7\u30c8\n\n    ```\n    AWSDIR=~/.aws\n    mkdir -p ${AWSDIR}\n\n    cat << EOS > ${AWSDIR}/config\n    [default]\n    region=${AWS_REGION}\n    EOS\n\n    cat << EOS > ${AWSDIR}/credentials\n    [${AWS_PROFILE}]\n    aws_access_key_id=${AWS_ACCESS_KEY_ID}\n    aws_secret_access_key=${AWS_SECRET_ACCESS_KEY}\n    EOS\n    ```\n\n\n- scripts/serverless.sh\n    Serverless \u306e\u5b9f\u884c\u30b9\u30af\u30ea\u30d7\u30c8\n    (\u521d\u56de\u4ee5\u5916\u306f \u300cServerlessError: Stage dev already exists\u300d\u30a8\u30e9\u30fc\u306b\u306a\u308b\u304c\u5927\u4e08\u592b\u3002\u6c17\u306b\u3057\u306a\u3044\u3002)\n\n\n    ```\n    STAGE=dev\n    OPTION=\"-s $STAGE -r $AWS_REGION\"\n    sls project init -p $AWS_PROFILE $OPTION\n    sls resources deploy $OPTION\n    sls function deploy $OPTION\n    sls endpoint deploy $OPTION\n    ```\n\n- circle.yml\n\n    ```\n    machine:\n      timezone: Asia/Tokyo\n\n      node:\n        version: 4.4.1\n\n      environment:\n        AWS_REGION: ap-northeast-1\n        AWS_PROFILE: serverless-circleci_dev\n\n      post:\n        - bash ${CIRCLE_PROJECT_REPONAME}/scripts/circleci_env\n        - bash ${CIRCLE_PROJECT_REPONAME}/scripts/aws_init\n\n    test:\n      override:\n        - npm test\n\n    deployment:\n      production:\n        branch: master\n        commands:\n          - npm run deploy_prod\n\n      staging:\n        branch: develop\n        commands:\n          - npm run deploy_staging\n      ```\n\n- s-templates.json\n    http://docs.serverless.com/docs/templates-variables#section-templates\n\n    ```\n    {\n      \"apiRequestTemplate\": {\n        \"application/json\": {\n          \"httpMethod\": \"$context.httpMethod\",\n          \"body\": \"$input.json('$')\",\n          \"queryParams\": \"$input.params().querystring\",\n          \"headerParams\": \"$input.params().header\",\n          \"headerParamNames\": \"$input.params().header.keySet()\",\n          \"contentTypeValue\": \"$input.params().header.get('Content-Type')\"\n        }\n      }\n    }\n    ```\n\n## \u307e\u3068\u3081\n - Serverless \u306f\u307e\u3060\u03b2\u7248\u3067\u3001\u983b\u7e41\u306b\u66f4\u65b0\u3055\u308c\u3066\u3044\u308b\u306e\u3067\u8981\u6ce8\u610f\u3067\u3059\u3002\n - \u30b5\u30fc\u30d0\u30ec\u30b9 (Lambda) \u3067\u30b5\u30fc\u30d3\u30b9\u5168\u4f53\u3092\u4f5c\u308b\u3053\u3068\u304c\u3067\u304d\u308b\u304b\u5206\u304b\u3089\u306a\u3044\u304c\u3001\u3068\u306b\u304b\u304f\u30c1\u30e3\u30ec\u30f3\u30b8\u3057\u3066\u307f\u307e\u3059\u3002\n - \u8352\u3044\u8a18\u4e8b\u3067\u30b9\u30a4\u30de\u30bb\u30f3\u3002\u3053\u306a\u308c\u3066\u304d\u305f\u3089\u66f4\u65b0\u3057\u307e\u3059\u3002\n\n## \u4ed8\u9332\n\n### CircleCI \u8a2d\u5b9a\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\nhttps://circleci.com/docs/configuration\n\n### CircleCI \u5b9f\u884c\u9806\u5e8f\n\n1. INFRASTRUCTURE\n    1. Starting the build\n    1. Start container\n    1. Enable SSH\n\n1. CHECKOUT\n    1. Restore source cache\n    1. Checkout using deploy key: \n\n1. MACHINE\n    1. Setting timezone to Asia/Tokyo\n    1. Exporting env vars from circle.yml\n(\u3010\u5b9a\u7fa9\u3011 circle.yml environment: )\n( \u2192 Github \u3067\u7ba1\u7406\u3059\u308b\u30d1\u30e9\u30e1\u30fc\u30bf)\n\n        ```\n        Exporting AWS_REGION\n        Exporting AWS_PROFILE\n        ```\n\n    1. Exporting env vars from project settings\n(\u3010\u5b9a\u7fa9\u3011 CircleCI\u8a2d\u5b9a Tweaks-EnvironmentVariables )\n( \u2192 Github \u3067\u7ba1\u7406\u3057\u306a\u3044\u30d1\u30e9\u30e1\u30fc\u30bf)\n\n        ```\n        Exporting AWS_ACCESS_KEY_ID\n        Exporting AWS_SECRET_ACCESS_KEY\n        ```\n\n    1. set node.js version to 4.4.1\n    1. Restore cache\n    1. post\n        1. $ npm run aws_init\n        2. $ bash scripts/circleci_env\n        3. $ bash scripts/aws_init\n\n1. DEPENDENCIES\n    1. Exporting NODE_ENV\n\n        ```\n        Exporting NODE_ENV\n        ```\n\n    1. Exporting PATH\n\n        ```\n        Exporting PATH\n        ```\n\n    1. $ npm install\n\n1. DATABASE\n    1. Save cache\n\n1. TEST\n    1. $ npm test\n\n1. TEARDOWN\n", "tags": ["CircleCI", "serverless", "lambda", "GitHub", "AWS"]}