{"context": " More than 1 year has passed since last update.\u672c\u8a18\u4e8b\u306f\u3001Spark, SQL on Hadoop etc. Advent Calendar 2014\u306e8\u65e5\u76ee\u306e\u8a18\u4e8b\u3060\u3063\u305f\u306f\u305a\u306e\u539f\u7a3f\u3067\u3059\u3002\nMovielens\u30c7\u30fc\u30bf\u30bb\u30c3\u30c8\u3092\u4f7f\u3063\u3066\u3001Hivemall\u306b\u304a\u3051\u308bMatrix Factorization\u306e\u5b9f\u884c\u65b9\u6cd5\u3092\u89e3\u8aac\u3057\u307e\u3059\u3002\n\n\u306f\u3058\u3081\u306b\n\u4ee5\u524d\u3001Hadoop Conference 2014\u3067\u767a\u8868\u3055\u305b\u3066\u9802\u3044\u305f\u3068\u304d\u306b\u8074\u8846\u306e\u65b9\u306b\u30a2\u30f3\u30b1\u30fc\u30c8\u3092\u3068\u3063\u305f\u3068\u3053\u308d\u30ec\u30b3\u30e1\u30f3\u30c7\u30fc\u30b7\u30e7\u30f3\u306e\u9700\u8981\u304c\uff08\u30af\u30e9\u30b9\u5206\u985e\u304b\u56de\u5e30\u5206\u6790\u3068\u6bd4\u3079\u3066\uff09\u975e\u5e38\u306b\u9ad8\u3044\u3068\u3044\u3046\u50be\u5411\u304c\u3042\u308a\u307e\u3057\u305f\u3002Hivemall\u306ev0.3\u4ee5\u524d\u3082minhash\u3084k\u8fd1\u508d\u6cd5\u3092\u7528\u3044\u305f\u30ec\u30b3\u30e1\u30f3\u30c7\u30fc\u30b7\u30e7\u30f3\u6a5f\u80fd\u3092\u30b5\u30dd\u30fc\u30c8\u3057\u3066\u304a\u308a\u307e\u3057\u305f\u304c\u3001v0.3\u304b\u3089\u306fMatrix Factorization\u3082\u30b5\u30dd\u30fc\u30c8\u81f4\u3057\u307e\u3057\u305f\u3002\n\u672c\u8a18\u4e8b\u3067\u306f\u3001Hivemall\u306b\u304a\u3051\u308bMatrix Factorization\u3092\u7528\u3044\u305f\u8a55\u4fa1\u5024\u306e\u4e88\u6e2c\u65b9\u6cd5\u3092\u7d39\u4ecb\u3057\u307e\u3059\u3002\n\nMatrix Factorization\u3068\u306f\nnun_{u}\u4eba\u306e\u30e6\u30fc\u30b6\u306enin_{i}\u500b\u306e\u5404\u5546\u54c1\u306b\u5bfe\u3059\u308bnu\u00d7nin_{u}\\times n_{i}\u306e\u8a55\u4fa1\u5024\u884c\u5217RR\u3092\u60f3\u5b9a\u4e0b\u3055\u3044\u3002\n\nMatrix Factorization\u3067\u306f\u8a55\u4fa1\u5024\u884c\u5217RR\u3092nu\u00d7kn_{u} \\times k\u306e\u30e6\u30fc\u30b6\u884c\u5217PP\u3068k\u00d7nik \\times n_{i}\u306e\u5546\u54c1\u884c\u5217QQ\u3092\u7528\u3044\u3066\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u8fd1\u4f3c\u3057\u307e\u3059\u3002\nR \\approx P^{T}Q\nR\u2248PTQ{R \\approx P^{T}Q\n}\n\u56f3\u3067\u793a\u3059\u3068\u6b21\u306e\u3088\u3046\u306a\u5f62\u3067\u3059\u3002\n\n\u3064\u307e\u308a\u3001kk\u500b\u306e\u6f5c\u5728\u56e0\u5b50\u306b\u3088\u3063\u3066\u5404\u30e6\u30fc\u30b6PuP_{u}\u304a\u3088\u3073\u5404\u5546\u54c1QiQ_{i}\u304c\u7279\u5fb4\u4ed8\u3051\u3055\u308c\u307e\u3059\u3002\n\u3053\u3053\u3067\u3001\u30e6\u30fc\u30b6uu\u306b\u5bfe\u3059\u308b\u5546\u54c1ii\u306e\u4e88\u6e2c\u8a55\u4fa1\u5024RuiR_{ui}\u306f\u3001\u2192PuT\u2192Qi\\overrightarrow{P_{u}}^{T}\\overrightarrow{Q_{i}}\u3092\u4ecb\u3057\u3066\u6c42\u3081\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\u3088\u308a\u8a73\u3057\u3044Matrix Factorization\u306e\u89e3\u8aac\u306f\u3001\u4ed6\u306e\u65b9\u306e\u8a18\u4e8b12\u3092\u53c2\u7167\u4e0b\u3055\u3044\u3002\n\n\u30d0\u30a4\u30a2\u30b9\u3092\u8003\u616e\u3057\u305f Matrix Factorization\nMatrix Factorization\u306e\u30a2\u30eb\u30b4\u30ea\u30ba\u30e0\u306b\u3082\u69d8\u3005\u3042\u308a\u307e\u3059\u304c\u3001Hivemall\u3067\u306fKoren\u3089\u306b\u3088\u308b\u30d0\u30a4\u30a2\u30b9\u3092\u8003\u616e\u3057\u305fMatrix Factorization\u624b\u6cd5\uff08\u4ee5\u4e0b\uff0cBiasedMF\uff093\u306e\u78ba\u7387\u7684\u52fe\u914d\u964d\u4e0b\u6cd5\uff08\u304a\u3088\u3073AdaGrad\uff09\u306b\u3088\u308b\u5b9f\u88c5\u3092\u30b5\u30dd\u30fc\u30c8\u3057\u3066\u304a\u308a\u307e\u3059\u3002\nBisedMF\u306e\u4e88\u6e2c\u30e2\u30c7\u30eb\u3067\u306f\u3001\u8a55\u4fa1\u306e\u5e73\u5747\u03bc\\mu\u3001\u30e6\u30fc\u30b6\u3054\u3068\u306e\u8a55\u4fa1\u30d0\u30a4\u30a2\u30b9BuB_{u}\u3001\u5546\u54c1\u3054\u3068\u306e\u8a55\u4fa1\u30d0\u30a4\u30a2\u30b9BiB_{i}\u3092\u8003\u616e\u3057\u305f\u4e0a\u3067\u8a55\u4fa1\u5024R\u2032uiR^{'}_{ui}\u3092\u4e88\u6e2c\u3057\u307e\u3059\u3002\nR^{'}_{ui} = \\mu + B_{u} + B_{i} + \\overrightarrow{P_{u}}^{T}\\overrightarrow{Q_{i}}\nR\u2032ui=\u03bc+Bu+Bi+\u2192PuT\u2192Qi{R^{'}_{ui} = \\mu + B_{u} + B_{i} + \\overrightarrow{P_{u}}^{T}\\overrightarrow{Q_{i}}\n}\n\u5b66\u7fd2\u3067\u306f\u3001\u4ee5\u4e0b\u306e\u5f0f\u3092\u6e80\u305f\u3059PP, QQ\u304a\u3088\u3073BB\u3092\u8a13\u7df4\u30c7\u30fc\u30bf\u304b\u3089\u5c0e\u304d\u307e\u3059\u3002\nmin_{P,Q,B} \\sum_{(u,i) \\in R}{(R_{ui}-R^{'}_{ui})^{2} + \\lambda ({||B_{u}||}^{2} + {||B_{i}||}^{2} + {||\\overrightarrow{P_{u}}||}^{2} + {||\\overrightarrow{Q_{i}}||}^{2}})\nminP,Q,B\u2211(u,i)\u2208R(Rui\u2212R\u2032ui)2+\u03bb(||Bu||2+||Bi||2+||\u2192Pu||2+||\u2192Qi||2){min_{P,Q,B} \\sum_{(u,i) \\in R}{(R_{ui}-R^{'}_{ui})^{2} + \\lambda ({||B_{u}||}^{2} + {||B_{i}||}^{2} + {||\\overrightarrow{P_{u}}||}^{2} + {||\\overrightarrow{Q_{i}}||}^{2}})\n}\n\u7b2c2\u9805\u306e\u03bb\\lambda\u306f\u3001\u6559\u5e2b\u30c7\u30fc\u30bf\u3078\u306e\u904e\u5270\u9069\u5408\uff08\u904e\u5b66\u7fd2\uff09\u3092\u9632\u3050\u305f\u3081\u306e\u6b63\u5247\u5316\u4fc2\u6570\u3067\u3059\u3002\u8aa4\u5dee\u6700\u5c0f\u5316\u306e\u76ee\u7684\u95a2\u6570\u306b\u6b63\u5247\u5316\u9805\u3092\u53d6\u308a\u5165\u308c\u308b\u3053\u3068\u3067\u6c4e\u5316\u6027\u80fd\uff08\u672a\u77e5\u306e\u30c7\u30fc\u30bf\u3078\u306e\u8b58\u5225\u6027\u80fd\uff09\u306e\u3042\u308b\u30e2\u30c7\u30eb\u304c\u5b66\u7fd2\u3055\u308c\u307e\u3059\u3002\n\u306a\u304a\u3001\u03bc\\mu\u306b\u3042\u3066\u305a\u3063\u307d\u3046\u306a\u5024\u3092\u6307\u5b9a\u3057\u305f\u5834\u5408\u3084\u8a2d\u5b9a\u3057\u306a\u3044\uff08\u03bc=0\\mu=0\uff09\u3067\u3082\u5b66\u7fd2\u81ea\u4f53\u306f\u53ef\u80fd\u3067\u3059\u3002\n\nMovielens 1M Dataset\u306e\u6e96\u5099\n\u4eca\u56de\u306f\u3053\u3061\u30892\u306eSpark MLlib\u3067\u306e\u691c\u8a3c\u3068\u6bd4\u8f03\u3057\u3084\u3059\u3044\u3088\u3046\u306b\u3001MovieLens 1M\u3092\u4f7f\u7528\u3057\u307e\u3059\u3002\n6,040\u4eba\u306e\u30e6\u30fc\u30b6\u304c\u305d\u308c\u305e\u308c\u306e\u6620\u753b\u30921\uff5e5\u306e5\u6bb5\u968e\u8a55\u4fa1\u3057\u3066\u3044\u308b\u30c7\u30fc\u30bf\u30bb\u30c3\u30c8\u3067\u8a55\u4fa1\u6570\u306f\u7d04100\u4e07\uff081,000,209\uff09\u4ef6\u3067\u3059\u3002\n\u307e\u305a\u3001\u6b21\u306e\u3088\u3046\u306bHive\u306e\u5916\u90e8\u30c6\u30fc\u30d6\u30eb\u3092\u5b9a\u7fa9\u3057\u307e\u3057\u3087\u3046\u3002\ncreate database movielens;\nuse movielens;\n\nCREATE EXTERNAL TABLE ratings (\n  userid INT, \n  movieid INT,\n  rating INT, \n  tstamp STRING\n) ROW FORMAT DELIMITED\nFIELDS TERMINATED BY '#'\nSTORED AS TEXTFILE\nLOCATION '/dataset/movielens/ratings';\n\n\u30c6\u30fc\u30d6\u30eb\u306b\u30c7\u30fc\u30bf\u3092\u6295\u5165\u3057\u307e\u3059\u3002sed\u3067\u52a0\u5de5\u3057\u3066\u304b\u3089HDFS\u306e\u6307\u5b9a\u306e\u30d1\u30b9\u306b\u30c7\u30fc\u30bf\u3092\u6295\u5165\u3057\u307e\u3059\u3002\nsed 's/::/#/g' ratings.dat | hadoop fs -put - /dataset/movielens/ratings/ratings.t\n\n\n\u8a13\u7df4\u30c7\u30fc\u30bf/\u30c6\u30b9\u30c8\u30c7\u30fc\u30bf\u306e\u4f5c\u6210\n\u3053\u3053\u3067\u306f\u3001\u30e9\u30f3\u30c0\u30e0\u306b\u9078\u629e\u3057\u305f8\u5272\u3092\u8a13\u7df4\u30c7\u30fc\u30bf\u3001\u6b8b\u308a\u306e2\u5272\u3092\u30c6\u30b9\u30c8\u30c7\u30fc\u30bf\u3068\u3057\u3066\u5229\u7528\u3057\u307e\u3059\u3002\ntraining/testing\u30c6\u30fc\u30d6\u30eb\u3092\u305d\u308c\u305e\u308c\u6b21\u306e\u3088\u3046\u306b\u4f5c\u6210\u3057\u307e\u3059\u3002\nSET hivevar:seed=31;\nCREATE TABLE ratings2\nas\nselect\n  rand(${seed}) as rnd, \n  userid, \n  movieid, \n  rating\nfrom \n  ratings;\n\nCREATE TABLE training\nas\nselect * from ratings2\norder by rnd DESC\nlimit 800000;\n\nCREATE TABLE testing\nas\nselect * from ratings2\norder by rnd ASC\nlimit 200209;\n\n\u78ba\u7387\u7684\u52fe\u914d\u964d\u4e0b\u6cd5\u3092\u7528\u3044\u305f\u30aa\u30f3\u30e9\u30a4\u30f3\u5b66\u7fd2\u3067\u306f\u3001\u5b66\u7fd2\u30c7\u30fc\u30bf\u3092\u30e9\u30f3\u30c0\u30e0\u306b\u30b7\u30e3\u30c3\u30d5\u30eb\u3057\u3066\u304a\u304f\u3053\u3068\u304c\u91cd\u8981\u3067\u3059\u3002\n\u30b7\u30e3\u30c3\u30d5\u30eb\u306b\u306fHive\u306eCLUSTER BY\u69cb\u6587\u3092\u5229\u7528\u3057\u305fCLUSTER BY rand()\u3082\u6709\u7528\u3067\u3059\u3002\n\n\u5b66\u7fd2\u306e\u30d1\u30e9\u30e1\u30bf\u306e\u8a2d\u5b9a\n\u3053\u3053\u3067\u306f\u3001\u5b66\u7fd2\u306b\u5229\u7528\u3059\u308b\u30d1\u30e9\u30e1\u30bf\u30923\u3064\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\u3053\u308c\u3089\u306e\u30d1\u30e9\u30e1\u30bf\u306f\u30aa\u30d7\u30b7\u30e7\u30f3\u306b\u6307\u5b9a\u3057\u306a\u304f\u3066\u3082\u30c7\u30d5\u30a9\u30eb\u30c8\u5024\u304c\u5229\u7528\u3055\u308c\u3066\u52d5\u304d\u307e\u3059\u304c\u3001\u8a2d\u5b9a\u3059\u308b\u3053\u3068\u3092\u304a\u3059\u3059\u3081\u3057\u3066\u3044\u307e\u3059\u3002\n-- 1) mean rating\nset hivevar:mu=3.593565;\n-- 2) number of factors\nset hivevar:factor=10;\n-- 3) maximum number of training iterations\nset hivevar:iters=50;\n\n\n\u4e00\u3064\u76ee\u306e$mu\u306f\u3001\u30c8\u30ec\u30fc\u30cb\u30f3\u30b0\u30c7\u30fc\u30bf\u306e\u8a55\u4fa1\u5024\u306e\u5e73\u5747\u5024\u3067\u3059\u3002\n\nselect avg(rating) from training;\n\n\u3067\u5e73\u5747\u5024\u3092\u6c42\u3081\u305f\u4e0a\u3067\u8a2d\u5b9a\u4e0b\u3055\u3044\uff08\u3053\u306e\u4f8b\u3067\u306f\u3001$mu=3.593565\uff09\u3002\n\n$factor\u306b\u306f\u6f5c\u5728\u56e0\u5b50\u306e\u6570\u3092\u6307\u5b9a\u3057\u307e\u3059\u3002\u3053\u3053\u3067\u306f\u3001$factor=10\u3068\u3057\u307e\u3059\u3002\n$iters\u306b\u306f\u305d\u308c\u305e\u308c\u306e(map)\u30bf\u30b9\u30af\u306b\u304a\u3051\u308b\u5b66\u7fd2\u306e\u6700\u5927\u30a4\u30c6\u30ec\u30fc\u30b7\u30e7\u30f3\u56de\u6570\u3092\u6307\u5b9a\u3057\u307e\u3059\u3002\n\u3053\u3053\u3067\u306f\u3001\u6700\u592750\u30a4\u30c6\u30ec\u30fc\u30b7\u30e7\u30f3\u3092\u6307\u5b9a\u3057\u307e\u3059\u3002\u7d4c\u9a13\u30ed\u30b9\u306e\u5909\u5316\u306e\u5272\u5408\u304b\u3089\u5b66\u7fd2\u304c\u53ce\u675f\u3057\u305f\u3068\u5224\u65ad\u3055\u308c\u305f\u5834\u5408\u306f\u5b66\u7fd2\u3092\u7d42\u4e86\u3057\u307e\u3059\u3002\n\n\nMatrix Factorization\u306e\u5b66\u7fd2\ntrain_mf_sgd\u30e6\u30fc\u30b6\u5b9a\u7fa9\u30c6\u30fc\u30d6\u30eb\u751f\u6210\u95a2\u6570\u3092\u7528\u3044\u3066\u3001\u6b21\u306e\u3088\u3046\u306b\u30e2\u30c7\u30eb\u3092\u69cb\u7bc9\u3057\u307e\u3059\u3002\ntrain_mf_sgd\u306e\u7b2c4\u5f15\u6570\u3067\u5b66\u7fd2\u306b\u5229\u7528\u3059\u308b\u30d1\u30e9\u30e1\u30bf\u3092\u6307\u5b9a\u3057\u307e\u3059\u3002\ncreate table sgd_model\nas\nselect\n  idx, \n  array_avg(u_rank) as Pu, \n  array_avg(m_rank) as Qi, \n  avg(u_bias) as Bu, \n  avg(m_bias) as Bi\nfrom (\n  select \n    train_mf_sgd(userid, movieid, rating, \"-factor ${factor} -mu ${mu} -iter ${iters}\") as (idx, u_rank, m_rank, u_bias, m_bias)\n  from \n    training\n) t\ngroup by idx;\n\n\u4f5c\u6210\u3055\u308c\u308b\u4e88\u6e2c\u30e2\u30c7\u30eb\u30c6\u30fc\u30d6\u30eb\u306e\u5f62\u5f0f\u306f\u6b21\u306e\u3068\u304a\u308a\u3067\u3059\u3002\nhive> desc sgd_model;\n\nidx                     int\npu                      array<float>\nqi                      array<float>\nbu                      double\nbi                      double\n\n\u95a2\u4fc2\u30e2\u30c7\u30eb\u3068\u306e\u89aa\u548c\u6027\u3092\u8003\u616e\u3057\u3066\u3001\u4e88\u6e2c\u30e2\u30c7\u30eb\u306f\u30d9\u30af\u30c8\u30eb\u306eidx\u3054\u3068\u306b\u30bf\u30d7\u30eb\u3068\u3057\u3066\u8868\u73fe\u3057\u3066\u3044\u307e\u3059\u3002\n\u3053\u3053\u3067\u3001PuP_{u}\u304a\u3088\u3073QiQ_{i}\u306f$factor\u3067\u6307\u5b9a\u3057\u305f\u8981\u7d20\u6570\u3092\u6301\u3061\u307e\u3059\u3002\n\n\u8a55\u4fa1\u5024\u306e\u4e88\u6e2c\n\u30c6\u30b9\u30c8\u30c7\u30fc\u30bf\u306b\u5bfe\u3057\u3066\u3001Pu,BuP_{u}, B_{u}\u304a\u3088\u3073Qi,BiQ_{i}, B_{i}\u3092LEFT JOIN\u306b\u3088\u3063\u3066\u7d50\u5408\u3057\u307e\u3059\u3002\n\u305d\u306e\u4e0a\u3067\u3001mf_predict\u95a2\u6570\u3092\u5229\u7528\u3057\u3066\u4e88\u6e2c\u8a55\u4fa1\u5024\u3092\u5f97\u307e\u3059\u3002\nselect\n  t2.actual,\n  mf_predict(t2.Pu, p2.Qi, t2.Bu, p2.Bi, ${mu}) as predicted\nfrom (\n  select\n    t1.userid, \n    t1.movieid,\n    t1.rating as actual,\n    p1.Pu,\n    p1.Bu\n  from\n    testing t1 LEFT OUTER JOIN sgd_model p1\n    ON (t1.userid = p1.idx) \n) t2 \nLEFT OUTER JOIN sgd_model p2\nON (t2.movieid = p2.idx);\n\n\n\u30a2\u30a4\u30c6\u30e0\u306e\u63a8\u85a6\uff08\u30ec\u30b3\u30e1\u30f3\u30c9\uff09\nuserid=1\u306e\u30e6\u30fc\u30b6\u306b\u3001\u30e6\u30fc\u30b6\u304c\u307e\u3060\u8a55\u4fa1\u3057\u3066\u3044\u306a\u3044$topk\u500b\u306e\u6620\u753b\u3092\u63a8\u85a6\u3059\u308b\u5834\u5408\u306f\u6b21\u306e\u3088\u3046\u306a\u30af\u30a8\u30ea\u3092\u7528\u3044\u307e\u3059\u3002\nset hivevar:userid=1;\nset hivevar:topk=5;\n\nselect\n  t1.movieid, \n  mf_predict(t2.Pu, t1.Qi, t2.Bu, t1.Bi, ${mu}) as predicted\nfrom (\n  select\n    idx as movieid,\n    Qi, \n    Bi\n  from\n    sgd_model p\n  where\n    p.idx NOT IN \n      (select movieid from training where userid=${userid})\n) t1 CROSS JOIN (\n  select\n    Pu,\n    Bu\n  from \n    sgd_model\n  where\n    idx = ${userid}\n) t2\norder by\n  predicted DESC\nlimit ${topk};\n\n\u3053\u3053\u3067\u306f\u3001t1\u3067\u6c42\u3081\u308b\u672a\u8a55\u4fa1\u306e\u6620\u753b\u306e\u7279\u5fb4\u91cf\u3068t2\u3067\u6c42\u3081\u308b\u30e6\u30fc\u30b6\u306e\u7279\u5fb4\u91cf\u304b\u3089\u6620\u753b\u306e\u8a55\u4fa1\u5024\u3092\u4e88\u6e2c\u3057\u3066\u3044\u307e\u3059\u3002\n\n\n\nmovieid\npredicted\n\n\n\n\n318\n4.8051853\n\n\n2503\n4.788541\n\n\n53\n4.7518783\n\n\n904\n4.7463417\n\n\n953\n4.732769\n\n\n\n\u306a\u304a\u3001SQL\u306eNOT IN\u53e5\u306fHive v0.13\u4ee5\u964d\u304b\u3089\u30b5\u30dd\u30fc\u30c8\u3055\u308c\u305f\u6a5f\u80fd\u3067\u3042\u308b\u3053\u3068\u306b\u3054\u6ce8\u610f\u4e0b\u3055\u3044\u3002NOT IN\u306fJOIN\u3068IS NULL\u3067\u8868\u73fe\u3059\u308b\u3053\u3068\u304c\u53ef\u80fd\u3067\u3059\u306e\u3067\u3001\u53e4\u3044\u30d0\u30fc\u30b8\u30e7\u30f3\u306eHive\u3067\u306fJOIN\u3068IS NULL\u3092\u4f7f\u3063\u305f\u30af\u30a8\u30ea\u3092\u4ee3\u7528\u4e0b\u3055\u3044\u3002\n\u30a2\u30a4\u30c6\u30e0\u3067\u306f\u306a\u304f\u3001\u30e6\u30fc\u30b6\u306e\u63a8\u85a6\u3082\u4e0a\u8a18\u306e\u30af\u30a8\u30ea\u3092\u8aad\u307f\u66ff\u3048\u308b\u3053\u3068\u3067\u53ef\u80fd\u3067\u3059\u3002\n\n\u8a55\u4fa1\nMAE\uff08Mean Absolute Error\uff09\u304a\u3088\u3073RMSE\uff08Root Mean Squared Error)\u3092\u5229\u7528\u3057\u305f\u8a55\u4fa1\u306f\u6b21\u306e\u3088\u3046\u306b\u884c\u3044\u307e\u3059\u3002\n\u305d\u308c\u305e\u308c\u4e88\u6e2c\u8a55\u4fa1\u5024\u304c\u5b9f\u969b\u306e\u8a55\u4fa1\u5024\u304b\u3089\u3069\u308c\u304f\u3089\u3044\u96e2\u308c\u3066\u3044\u308b\u304b\u306e\u5c3a\u5ea6\u3067\u3001\u5c0f\u3055\u3044\u65b9\u304c\u4e88\u6e2c\u7cbe\u5ea6\u304c\u9ad8\u3044\u3082\u306e\u3068\u306a\u308a\u307e\u3059\u3002\nselect\n  mae(predicted, actual) as mae,\n  rmse(predicted, actual) as rmse\nfrom (\n  select\n    t2.actual,\n    mf_predict(t2.Pu, p2.Qi, t2.Bu, p2.Bi, ${mu}) as predicted\n  from (\n    select\n      t1.userid, \n      t1.movieid,\n      t1.rating as actual,\n      p1.Pu,\n      p1.Bu\n    from\n      testing t1 LEFT OUTER JOIN sgd_model p1\n      ON (t1.userid = p1.idx) \n  ) t2 \n  LEFT OUTER JOIN sgd_model p2\n  ON (t2.movieid = p2.idx)\n) t;\n\n\n0.6728969407733578 (MAE)\n0.8584162122694449 (RMSE)\n\n\u306a\u304a\u3001\u5e73\u5747\u7d76\u5bfe\u8aa4\u5dee\uff08MAE\uff09\u306e\u5b9a\u7fa9\u306f\u6b21\u306e\u3068\u304a\u308a\u3067\u3001\uff08\u4e88\u6e2c\u5024\u3068\u5b9f\u969b\u306e\u5024\u306e\uff09\u8aa4\u5dee\u306e\u7d76\u5bfe\u5024\u306e\u5e73\u5747\u3067\u3059\u3002\n\\mathrm{MAE} = \\frac{1}{n}\\sum_{i=1}^n \\left| f_i-y_i\\right| =\\frac{1}{n}\\sum_{i=1}^n \\left| e_i \\right|\nMAE=1nn\u2211i=1|fi\u2212yi|=1nn\u2211i=1|ei|{\\mathrm{MAE} = \\frac{1}{n}\\sum_{i=1}^n \\left| f_i-y_i\\right| =\\frac{1}{n}\\sum_{i=1}^n \\left| e_i \\right|\n}\n\n\u4ea4\u5dee\u691c\u5b9a (10-fold cross validation)\n\u3053\u3053\u3067\u306f\u3001\u4ea4\u5dee\u691c\u5b9a4\u306b\u3088\u308a\u4e88\u6e2c\u6027\u80fd\u306e\u8a55\u4fa1\u3092\u884c\u3044\u307e\u3059\u3002\n\u4eca\u56de\u306f\u5b66\u7fd2\u30c7\u30fc\u30bf : \u8a55\u4fa1\u30c7\u30fc\u30bf\u30929 : 1 \u3067\u5206\u5272\u3057\u300110-fold\u306e\u4ea4\u5dee\u691c\u5b9a\u3092\u884c\u3063\u305f\u4e0a\u3067MAE/RMSE\u3067\u8a55\u4fa1\u3057\u307e\u3059\u3002\n\n\u4ea4\u5dee\u691c\u5b9a\u7528\u306e\u30c7\u30fc\u30bf\u30bb\u30c3\u30c8\u306e\u6e96\u5099\n\u6b21\u306e\u3088\u3046\u306bkfold=10\u3092\u6307\u5b9a\u3057\u3066\u3001\u5143\u306e\u30c7\u30fc\u30bf\u30bb\u30c3\u30c8(ratings\u30c6\u30fc\u30d6\u30eb\uff09\u306b\u4ea4\u5dee\u691c\u5b9a\u7528\u306e\u30b0\u30eb\u30fc\u30d7ID(gid)\u3092\u52a0\u3048\u305f\u30c6\u30fc\u30d6\u30eb\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\nset hivevar:kfold=10;\nset hivevar:seed=31;\n\n-- Adding group id (gid) to each training instance\ndrop table ratings_groupded;\ncreate table ratings_groupded\nas\nselect\n  rand_gid2(${kfold}, ${seed}) gid, -- generates group id ranging from 1 to 10\n  userid, \n  movieid, \n  rating\nfrom\n  ratings\ncluster by gid, rand(${seed});\n\n\n\u5b66\u7fd2\u7528\u30d1\u30e9\u30e1\u30bf\u306e\u8a2d\u5b9a\n-- latent factors\nset hivevar:factor=10;\n-- maximum number of iterations\nset hivevar:iters=50;\n-- regularization parameter\nset hivevar:lambda=0.05;\n-- learning rate\nset hivevar:eta=0.005;\n-- conversion rate (if changes between iterations became less or equals to ${cv_rate}, the training will stop)\nset hivevar:cv_rate=0.001;\n\n$lambda\u306f\u6b63\u5247\u5316\u306e\u30d1\u30e9\u30e1\u30bf\u3001$eta\u306f\u5b66\u7fd2\u7387\u3001$cv_rate\u306f\u5b66\u7fd2\u306e\u53ce\u675f\u3092\u5224\u5b9a\u3059\u308b\u305f\u3081\u306eTHRESHOLD\uff08\u30a4\u30c6\u30ec\u30fc\u30b7\u30e7\u30f3\u3092\u91cd\u306d\u3066\u30820.1%\u4ee5\u4e0b\u306e\u5909\u5316\u306a\u3089\u3070\u53ce\u675f\u3057\u305f\u3068\u898b\u306a\u3059\uff09\u306b\u306a\u308a\u307e\u3059\u3002\n$mu\u306b\u306f\u6b63\u78ba\u3067\u306a\u3044\u5024\u3067\u3082\u69cb\u3044\u307e\u305b\u3093\u304c\u3001\u30b5\u30f3\u30d7\u30ea\u30f3\u30b0\u306a\u3069\u3092\u7528\u3044\u3066\u5e73\u5747\u7684\u306a\u5024\u3092\u6307\u5b9a\u3057\u3066\u304f\u3060\u3055\u3044\uff08\u4f8b\u3048\u30705\u6bb5\u968e\u30673\uff09\u3002\nselect avg(rating) from ratings;\n\n\n3.581564453029317\n\n-- mean rating value (Optional but recommended to set ${mu})\nset hivevar:mu=3.581564453029317;\n\n\nCross Validation\u7528\u306e\u30af\u30a8\u30ea\u306e\u81ea\u52d5\u751f\u6210\u3068\u5b9f\u884c\ngenerate_cv.sh\u3092\u5b9f\u884c\u3059\u308b\u3068generate_cv.sql\u304c\u751f\u6210\u3055\u308c\u307e\u3059\u3002\ngenerate_cv.sql\u3092\u5b9f\u884c\u3059\u308b\u3068MAE\u3068RMSE\u304c\u7d50\u679c\u3068\u3057\u3066\u8fd4\u308a\u307e\u3059\u3002\n\n0.6695442192077673 (MAE)\n0.8502739040257945 (RMSE)\n\n\u4ea4\u5dee\u691c\u5b9a\u7528\u306e\u30af\u30a8\u30ea\u306f\u591a\u304f\u306emap/reduce\u30bf\u30b9\u30af\u3092\u5fc5\u8981\u3068\u3057\u307e\u3059\u306e\u3067Apache Tez\u3092\u5229\u7528\u3057\u305f\u5b9f\u884c\u3092\u304a\u3059\u3059\u3081\u3057\u307e\u3059\u3002\u79c1\u306e32\u30ce\u30fc\u30c9\u306eHadoop\u30af\u30e9\u30b9\u30bf\u306eHive(Tez)\u74b0\u5883\u3067\u306f\u3001\u4e26\u5217\u306b\u30bf\u30b9\u30af\u304c\u5b9f\u884c\u3055\u308c\u3066\u7d0445\u79d2\u3067JOB\u304c\u7d42\u4e86\u3057\u307e\u3057\u305f\u3002\n\u5b9f\u969b\u306b\u4f55\u3092\u3084\u3063\u3066\u3044\u308b\u304b\u306fgenerate_cv.sql\u3092\u78ba\u8a8d\u304f\u3060\u3055\u3044\u3002\n\u307b\u304b\u306e\u30c7\u30fc\u30bf\u30bb\u30c3\u30c8\u306b\u4ea4\u5dee\u691c\u5b9a\u3092\u9069\u7528\u3059\u308b\u3068\u304d\u306f\u3001generate_cv.sh\u3092\u7de8\u96c6\u9802\u304f\u3053\u3068\u306b\u306a\u308a\u307e\u3059\u3002\n\n\u3055\u3044\u3054\u306b\nMovielens 1M\u3067\u306f\u3001Spark MLlib\u306eALS-WR2\u3068\u306f\u8aa4\u5dee\u6700\u5c0f\u5316\u306e\u76ee\u7684\u95a2\u6570\u3084\u6700\u9069\u5316\u65b9\u6cd5\u304c\u7570\u306a\u308a\u307e\u3059\u304c\u3001\u540c\u7b49\u306e\u4e88\u6e2c\u6027\u80fd\u3068\u306a\u308a\u307e\u3057\u305f\u3002\nHivemall\u306eMatrix Factorization\u306f\u30ce\u30fc\u30c9\u9593\u306e\u30d1\u30e9\u30e1\u30bf\u4ea4\u63db\u3092\u307e\u3060\u884c\u3063\u3066\u3044\u306a\u3044\u306e\u3067\u6539\u5584\u4f59\u5730\u306e\u3042\u308b\u6a5f\u80fd\u3067\u3059\u3002\n\u3054\u81ea\u8eab\u306e\u624b\u3067\u8a66\u3057\u3066\u3044\u305f\u3060\u304d\u3001\u30d5\u30a3\u30fc\u30c9\u30d0\u30c3\u30af\u306a\u308aPull request\u3092\u9802\u3051\u308c\u3070\u3068\u601d\u3044\u307e\u3059\u3002\n\n\u53c2\u8003\u8cc7\u6599\n\n\n\n\nMachine Learning Advent Calendar 2013 16\u65e5\u76ee - Matrix Factorization\u3068\u306f\u00a0\u21a9\n\n\n\u30ab\u30a8\u30eb\u3067\u3082\u308f\u304b\u308b\uff01Spark / MLlib \u3067\u3084\u3063\u3066\u307f\u308b\u5354\u8abf\u30d5\u30a3\u30eb\u30bf\u30ea\u30f3\u30b0\u00a0\u21a9\n\n\nYehuda Koren, \"Factorization Meets the Neighborhood: a Multifaceted Collaborative Filtering Model\", Proc. KDD 2008.\u00a0\u21a9\n\n\n\u7b2c21\u56de\uff08\u6700\u7d42\u56de\uff09\u6a5f\u68b0\u5b66\u7fd2 \u306f\u3058\u3081\u3088\u3046\u00a0\u21a9\n\n\n\n\u672c\u8a18\u4e8b\u306f\u3001[Spark, SQL on Hadoop etc. Advent Calendar 2014](http://qiita.com/advent-calendar/2014/distributedcomputing)\u306e8\u65e5\u76ee\u306e\u8a18\u4e8b**\u3060\u3063\u305f\u306f\u305a**\u306e\u539f\u7a3f\u3067\u3059\u3002\n\n[Movielens\u30c7\u30fc\u30bf\u30bb\u30c3\u30c8](http://grouplens.org/datasets/movielens/)\u3092\u4f7f\u3063\u3066\u3001[Hivemall](https://github.com/myui/hivemall)\u306b\u304a\u3051\u308bMatrix Factorization\u306e\u5b9f\u884c\u65b9\u6cd5\u3092\u89e3\u8aac\u3057\u307e\u3059\u3002\n\n# \u306f\u3058\u3081\u306b\n\n\u4ee5\u524d\u3001[Hadoop Conference 2014](http://hugjp.org/hadoop-conference-japan-2014-report/)\u3067\u767a\u8868\u3055\u305b\u3066\u9802\u3044\u305f\u3068\u304d\u306b\u8074\u8846\u306e\u65b9\u306b\u30a2\u30f3\u30b1\u30fc\u30c8\u3092\u3068\u3063\u305f\u3068\u3053\u308d\u30ec\u30b3\u30e1\u30f3\u30c7\u30fc\u30b7\u30e7\u30f3\u306e\u9700\u8981\u304c\uff08\u30af\u30e9\u30b9\u5206\u985e\u304b\u56de\u5e30\u5206\u6790\u3068\u6bd4\u3079\u3066\uff09\u975e\u5e38\u306b\u9ad8\u3044\u3068\u3044\u3046\u50be\u5411\u304c\u3042\u308a\u307e\u3057\u305f\u3002[Hivemall](https://github.com/myui)\u306ev0.3\u4ee5\u524d\u3082[minhash](http://qiita.com/shima_x/items/84cfbe43dd6255ba90ec)\u3084k\u8fd1\u508d\u6cd5\u3092\u7528\u3044\u305f\u30ec\u30b3\u30e1\u30f3\u30c7\u30fc\u30b7\u30e7\u30f3\u6a5f\u80fd\u3092\u30b5\u30dd\u30fc\u30c8\u3057\u3066\u304a\u308a\u307e\u3057\u305f\u304c\u3001v0.3\u304b\u3089\u306fMatrix Factorization\u3082\u30b5\u30dd\u30fc\u30c8\u81f4\u3057\u307e\u3057\u305f\u3002\n\n\u672c\u8a18\u4e8b\u3067\u306f\u3001Hivemall\u306b\u304a\u3051\u308bMatrix Factorization\u3092\u7528\u3044\u305f\u8a55\u4fa1\u5024\u306e\u4e88\u6e2c\u65b9\u6cd5\u3092\u7d39\u4ecb\u3057\u307e\u3059\u3002\n\n# Matrix Factorization\u3068\u306f\n\n$n_{u}$\u4eba\u306e\u30e6\u30fc\u30b6\u306e$n_{i}$\u500b\u306e\u5404\u5546\u54c1\u306b\u5bfe\u3059\u308b$n_{u}\\times n_{i}$\u306e\u8a55\u4fa1\u5024\u884c\u5217$R$\u3092\u60f3\u5b9a\u4e0b\u3055\u3044\u3002\n![rating_matrix.png](https://qiita-image-store.s3.amazonaws.com/0/32790/1f8812a6-c746-3530-c12a-faa2d09d884f.png)\n\nMatrix Factorization\u3067\u306f\u8a55\u4fa1\u5024\u884c\u5217$R$\u3092$n_{u} \\times k$\u306e\u30e6\u30fc\u30b6\u884c\u5217$P$\u3068$k \\times n_{i}$\u306e\u5546\u54c1\u884c\u5217$Q$\u3092\u7528\u3044\u3066\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u8fd1\u4f3c\u3057\u307e\u3059\u3002\n\n```math\nR \\approx P^{T}Q\n```\n\n\u56f3\u3067\u793a\u3059\u3068\u6b21\u306e\u3088\u3046\u306a\u5f62\u3067\u3059\u3002\n![approx.png](https://qiita-image-store.s3.amazonaws.com/0/32790/e171bfcc-413c-db4c-da6e-9178ba8779e1.png)\n\n\u3064\u307e\u308a\u3001$k$\u500b\u306e\u6f5c\u5728\u56e0\u5b50\u306b\u3088\u3063\u3066\u5404\u30e6\u30fc\u30b6$P_{u}$\u304a\u3088\u3073\u5404\u5546\u54c1$Q_{i}$\u304c\u7279\u5fb4\u4ed8\u3051\u3055\u308c\u307e\u3059\u3002\n\u3053\u3053\u3067\u3001\u30e6\u30fc\u30b6$u$\u306b\u5bfe\u3059\u308b\u5546\u54c1$i$\u306e\u4e88\u6e2c\u8a55\u4fa1\u5024$R_{ui}$\u306f\u3001$\\overrightarrow{P_{u}}^{T}\\overrightarrow{Q_{i}}$\u3092\u4ecb\u3057\u3066\u6c42\u3081\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\n\u3088\u308a\u8a73\u3057\u3044Matrix Factorization\u306e\u89e3\u8aac\u306f\u3001\u4ed6\u306e\u65b9\u306e\u8a18\u4e8b[^qiitamf][^sparkmf]\u3092\u53c2\u7167\u4e0b\u3055\u3044\u3002\n\n# \u30d0\u30a4\u30a2\u30b9\u3092\u8003\u616e\u3057\u305f Matrix Factorization\n\nMatrix Factorization\u306e\u30a2\u30eb\u30b4\u30ea\u30ba\u30e0\u306b\u3082\u69d8\u3005\u3042\u308a\u307e\u3059\u304c\u3001Hivemall\u3067\u306fKoren\u3089\u306b\u3088\u308b\u30d0\u30a4\u30a2\u30b9\u3092\u8003\u616e\u3057\u305fMatrix Factorization\u624b\u6cd5\uff08\u4ee5\u4e0b\uff0cBiasedMF\uff09[^biasedmf]\u306e[\u78ba\u7387\u7684\u52fe\u914d\u964d\u4e0b\u6cd5](http://ibisforest.org/index.php?%E7%A2%BA%E7%8E%87%E7%9A%84%E5%8B%BE%E9%85%8D%E9%99%8D%E4%B8%8B%E6%B3%95)\uff08\u304a\u3088\u3073[AdaGrad](http://www.logos.t.u-tokyo.ac.jp/~hassy/deep_learning/adagrad/)\uff09\u306b\u3088\u308b\u5b9f\u88c5\u3092\u30b5\u30dd\u30fc\u30c8\u3057\u3066\u304a\u308a\u307e\u3059\u3002\n\nBisedMF\u306e\u4e88\u6e2c\u30e2\u30c7\u30eb\u3067\u306f\u3001\u8a55\u4fa1\u306e\u5e73\u5747$\\mu$\u3001\u30e6\u30fc\u30b6\u3054\u3068\u306e\u8a55\u4fa1\u30d0\u30a4\u30a2\u30b9$B_{u}$\u3001\u5546\u54c1\u3054\u3068\u306e\u8a55\u4fa1\u30d0\u30a4\u30a2\u30b9$B_{i}$\u3092\u8003\u616e\u3057\u305f\u4e0a\u3067\u8a55\u4fa1\u5024$R^{'}_{ui}$\u3092\u4e88\u6e2c\u3057\u307e\u3059\u3002\n\n```math\nR^{'}_{ui} = \\mu + B_{u} + B_{i} + \\overrightarrow{P_{u}}^{T}\\overrightarrow{Q_{i}}\n```\n\n\u5b66\u7fd2\u3067\u306f\u3001\u4ee5\u4e0b\u306e\u5f0f\u3092\u6e80\u305f\u3059$P$, $Q$\u304a\u3088\u3073$B$\u3092\u8a13\u7df4\u30c7\u30fc\u30bf\u304b\u3089\u5c0e\u304d\u307e\u3059\u3002\n\n```math\nmin_{P,Q,B} \\sum_{(u,i) \\in R}{(R_{ui}-R^{'}_{ui})^{2} + \\lambda ({||B_{u}||}^{2} + {||B_{i}||}^{2} + {||\\overrightarrow{P_{u}}||}^{2} + {||\\overrightarrow{Q_{i}}||}^{2}})\n```\n\n\u7b2c2\u9805\u306e$\\lambda$\u306f\u3001\u6559\u5e2b\u30c7\u30fc\u30bf\u3078\u306e\u904e\u5270\u9069\u5408\uff08[\u904e\u5b66\u7fd2](http://gihyo.jp/dev/serial/01/machine-learning/0021)\uff09\u3092\u9632\u3050\u305f\u3081\u306e\u6b63\u5247\u5316\u4fc2\u6570\u3067\u3059\u3002\u8aa4\u5dee\u6700\u5c0f\u5316\u306e\u76ee\u7684\u95a2\u6570\u306b\u6b63\u5247\u5316\u9805\u3092\u53d6\u308a\u5165\u308c\u308b\u3053\u3068\u3067\u6c4e\u5316\u6027\u80fd\uff08\u672a\u77e5\u306e\u30c7\u30fc\u30bf\u3078\u306e\u8b58\u5225\u6027\u80fd\uff09\u306e\u3042\u308b\u30e2\u30c7\u30eb\u304c\u5b66\u7fd2\u3055\u308c\u307e\u3059\u3002\n\n\u306a\u304a\u3001$\\mu$\u306b\u3042\u3066\u305a\u3063\u307d\u3046\u306a\u5024\u3092\u6307\u5b9a\u3057\u305f\u5834\u5408\u3084\u8a2d\u5b9a\u3057\u306a\u3044\uff08$\\mu=0$\uff09\u3067\u3082\u5b66\u7fd2\u81ea\u4f53\u306f\u53ef\u80fd\u3067\u3059\u3002\n\n# Movielens 1M Dataset\u306e\u6e96\u5099\n\n\u4eca\u56de\u306f\u3053\u3061\u3089[^sparkmf]\u306eSpark MLlib\u3067\u306e\u691c\u8a3c\u3068\u6bd4\u8f03\u3057\u3084\u3059\u3044\u3088\u3046\u306b\u3001[MovieLens 1M](http://grouplens.org/datasets/movielens/)\u3092\u4f7f\u7528\u3057\u307e\u3059\u3002\n\n6,040\u4eba\u306e\u30e6\u30fc\u30b6\u304c\u305d\u308c\u305e\u308c\u306e\u6620\u753b\u30921\uff5e5\u306e5\u6bb5\u968e\u8a55\u4fa1\u3057\u3066\u3044\u308b\u30c7\u30fc\u30bf\u30bb\u30c3\u30c8\u3067\u8a55\u4fa1\u6570\u306f\u7d04100\u4e07\uff081,000,209\uff09\u4ef6\u3067\u3059\u3002\n\n\u307e\u305a\u3001\u6b21\u306e\u3088\u3046\u306bHive\u306e\u5916\u90e8\u30c6\u30fc\u30d6\u30eb\u3092\u5b9a\u7fa9\u3057\u307e\u3057\u3087\u3046\u3002\n\n```sql\ncreate database movielens;\nuse movielens;\n\nCREATE EXTERNAL TABLE ratings (\n  userid INT, \n  movieid INT,\n  rating INT, \n  tstamp STRING\n) ROW FORMAT DELIMITED\nFIELDS TERMINATED BY '#'\nSTORED AS TEXTFILE\nLOCATION '/dataset/movielens/ratings';\n```\n\n\u30c6\u30fc\u30d6\u30eb\u306b\u30c7\u30fc\u30bf\u3092\u6295\u5165\u3057\u307e\u3059\u3002sed\u3067\u52a0\u5de5\u3057\u3066\u304b\u3089HDFS\u306e\u6307\u5b9a\u306e\u30d1\u30b9\u306b\u30c7\u30fc\u30bf\u3092\u6295\u5165\u3057\u307e\u3059\u3002\n\n```shell-session\nsed 's/::/#/g' ratings.dat | hadoop fs -put - /dataset/movielens/ratings/ratings.t\n```\n\n# \u8a13\u7df4\u30c7\u30fc\u30bf/\u30c6\u30b9\u30c8\u30c7\u30fc\u30bf\u306e\u4f5c\u6210\n\n\u3053\u3053\u3067\u306f\u3001\u30e9\u30f3\u30c0\u30e0\u306b\u9078\u629e\u3057\u305f8\u5272\u3092\u8a13\u7df4\u30c7\u30fc\u30bf\u3001\u6b8b\u308a\u306e2\u5272\u3092\u30c6\u30b9\u30c8\u30c7\u30fc\u30bf\u3068\u3057\u3066\u5229\u7528\u3057\u307e\u3059\u3002\ntraining/testing\u30c6\u30fc\u30d6\u30eb\u3092\u305d\u308c\u305e\u308c\u6b21\u306e\u3088\u3046\u306b\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n```sql\nSET hivevar:seed=31;\nCREATE TABLE ratings2\nas\nselect\n  rand(${seed}) as rnd, \n  userid, \n  movieid, \n  rating\nfrom \n  ratings;\n\nCREATE TABLE training\nas\nselect * from ratings2\norder by rnd DESC\nlimit 800000;\n\nCREATE TABLE testing\nas\nselect * from ratings2\norder by rnd ASC\nlimit 200209;\n```\n\n\u78ba\u7387\u7684\u52fe\u914d\u964d\u4e0b\u6cd5\u3092\u7528\u3044\u305f\u30aa\u30f3\u30e9\u30a4\u30f3\u5b66\u7fd2\u3067\u306f\u3001\u5b66\u7fd2\u30c7\u30fc\u30bf\u3092\u30e9\u30f3\u30c0\u30e0\u306b\u30b7\u30e3\u30c3\u30d5\u30eb\u3057\u3066\u304a\u304f\u3053\u3068\u304c\u91cd\u8981\u3067\u3059\u3002\n\u30b7\u30e3\u30c3\u30d5\u30eb\u306b\u306fHive\u306e[CLUSTER BY\u69cb\u6587](https://cwiki.apache.org/confluence/display/Hive/LanguageManual+SortBy#LanguageManualSortBy-SyntaxofClusterByandDistributeBy)\u3092\u5229\u7528\u3057\u305f[CLUSTER BY rand()](https://github.com/myui/hivemall/wiki/news20-binary-dataset)\u3082\u6709\u7528\u3067\u3059\u3002\n\n# \u5b66\u7fd2\u306e\u30d1\u30e9\u30e1\u30bf\u306e\u8a2d\u5b9a\n\n\u3053\u3053\u3067\u306f\u3001\u5b66\u7fd2\u306b\u5229\u7528\u3059\u308b\u30d1\u30e9\u30e1\u30bf\u30923\u3064\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\u3053\u308c\u3089\u306e\u30d1\u30e9\u30e1\u30bf\u306f\u30aa\u30d7\u30b7\u30e7\u30f3\u306b\u6307\u5b9a\u3057\u306a\u304f\u3066\u3082\u30c7\u30d5\u30a9\u30eb\u30c8\u5024\u304c\u5229\u7528\u3055\u308c\u3066\u52d5\u304d\u307e\u3059\u304c\u3001\u8a2d\u5b9a\u3059\u308b\u3053\u3068\u3092\u304a\u3059\u3059\u3081\u3057\u3066\u3044\u307e\u3059\u3002\n\n```sql\n-- 1) mean rating\nset hivevar:mu=3.593565;\n-- 2) number of factors\nset hivevar:factor=10;\n-- 3) maximum number of training iterations\nset hivevar:iters=50;\n```\n\n+ \u4e00\u3064\u76ee\u306e$mu\u306f\u3001\u30c8\u30ec\u30fc\u30cb\u30f3\u30b0\u30c7\u30fc\u30bf\u306e\u8a55\u4fa1\u5024\u306e\u5e73\u5747\u5024\u3067\u3059\u3002\n\n```sql\nselect avg(rating) from training;\n```\n\u3067\u5e73\u5747\u5024\u3092\u6c42\u3081\u305f\u4e0a\u3067\u8a2d\u5b9a\u4e0b\u3055\u3044\uff08\u3053\u306e\u4f8b\u3067\u306f\u3001\\$mu=3.593565\uff09\u3002\n\n+ \\$factor\u306b\u306f\u6f5c\u5728\u56e0\u5b50\u306e\u6570\u3092\u6307\u5b9a\u3057\u307e\u3059\u3002\u3053\u3053\u3067\u306f\u3001\\$factor=10\u3068\u3057\u307e\u3059\u3002\n\n+ \\$iters\u306b\u306f\u305d\u308c\u305e\u308c\u306e(map)\u30bf\u30b9\u30af\u306b\u304a\u3051\u308b\u5b66\u7fd2\u306e\u6700\u5927\u30a4\u30c6\u30ec\u30fc\u30b7\u30e7\u30f3\u56de\u6570\u3092\u6307\u5b9a\u3057\u307e\u3059\u3002\n\u3053\u3053\u3067\u306f\u3001\u6700\u592750\u30a4\u30c6\u30ec\u30fc\u30b7\u30e7\u30f3\u3092\u6307\u5b9a\u3057\u307e\u3059\u3002\u7d4c\u9a13\u30ed\u30b9\u306e\u5909\u5316\u306e\u5272\u5408\u304b\u3089\u5b66\u7fd2\u304c\u53ce\u675f\u3057\u305f\u3068\u5224\u65ad\u3055\u308c\u305f\u5834\u5408\u306f\u5b66\u7fd2\u3092\u7d42\u4e86\u3057\u307e\u3059\u3002\n\n# Matrix Factorization\u306e\u5b66\u7fd2\n\ntrain_mf_sgd\u30e6\u30fc\u30b6\u5b9a\u7fa9\u30c6\u30fc\u30d6\u30eb\u751f\u6210\u95a2\u6570\u3092\u7528\u3044\u3066\u3001\u6b21\u306e\u3088\u3046\u306b\u30e2\u30c7\u30eb\u3092\u69cb\u7bc9\u3057\u307e\u3059\u3002\ntrain_mf_sgd\u306e\u7b2c4\u5f15\u6570\u3067\u5b66\u7fd2\u306b\u5229\u7528\u3059\u308b\u30d1\u30e9\u30e1\u30bf\u3092\u6307\u5b9a\u3057\u307e\u3059\u3002\n\n```sql\ncreate table sgd_model\nas\nselect\n  idx, \n  array_avg(u_rank) as Pu, \n  array_avg(m_rank) as Qi, \n  avg(u_bias) as Bu, \n  avg(m_bias) as Bi\nfrom (\n  select \n    train_mf_sgd(userid, movieid, rating, \"-factor ${factor} -mu ${mu} -iter ${iters}\") as (idx, u_rank, m_rank, u_bias, m_bias)\n  from \n    training\n) t\ngroup by idx;\n```\n\n\u4f5c\u6210\u3055\u308c\u308b\u4e88\u6e2c\u30e2\u30c7\u30eb\u30c6\u30fc\u30d6\u30eb\u306e\u5f62\u5f0f\u306f\u6b21\u306e\u3068\u304a\u308a\u3067\u3059\u3002\n\n```sql\nhive> desc sgd_model;\n\nidx                     int\npu                      array<float>\nqi                      array<float>\nbu                      double\nbi                      double\n```\n\n\u95a2\u4fc2\u30e2\u30c7\u30eb\u3068\u306e\u89aa\u548c\u6027\u3092\u8003\u616e\u3057\u3066\u3001\u4e88\u6e2c\u30e2\u30c7\u30eb\u306f\u30d9\u30af\u30c8\u30eb\u306eidx\u3054\u3068\u306b\u30bf\u30d7\u30eb\u3068\u3057\u3066\u8868\u73fe\u3057\u3066\u3044\u307e\u3059\u3002\n\u3053\u3053\u3067\u3001$P_{u}$\u304a\u3088\u3073$Q_{i}$\u306f$factor\u3067\u6307\u5b9a\u3057\u305f\u8981\u7d20\u6570\u3092\u6301\u3061\u307e\u3059\u3002\n\n# \u8a55\u4fa1\u5024\u306e\u4e88\u6e2c\n\n\u30c6\u30b9\u30c8\u30c7\u30fc\u30bf\u306b\u5bfe\u3057\u3066\u3001$P_{u}, B_{u}$\u304a\u3088\u3073$Q_{i}, B_{i}$\u3092LEFT JOIN\u306b\u3088\u3063\u3066\u7d50\u5408\u3057\u307e\u3059\u3002\n\u305d\u306e\u4e0a\u3067\u3001mf_predict\u95a2\u6570\u3092\u5229\u7528\u3057\u3066\u4e88\u6e2c\u8a55\u4fa1\u5024\u3092\u5f97\u307e\u3059\u3002\n\n```sql\nselect\n  t2.actual,\n  mf_predict(t2.Pu, p2.Qi, t2.Bu, p2.Bi, ${mu}) as predicted\nfrom (\n  select\n    t1.userid, \n    t1.movieid,\n    t1.rating as actual,\n    p1.Pu,\n    p1.Bu\n  from\n    testing t1 LEFT OUTER JOIN sgd_model p1\n    ON (t1.userid = p1.idx) \n) t2 \nLEFT OUTER JOIN sgd_model p2\nON (t2.movieid = p2.idx);\n```\n\n# \u30a2\u30a4\u30c6\u30e0\u306e\u63a8\u85a6\uff08\u30ec\u30b3\u30e1\u30f3\u30c9\uff09\n\nuserid=1\u306e\u30e6\u30fc\u30b6\u306b\u3001\u30e6\u30fc\u30b6\u304c\u307e\u3060\u8a55\u4fa1\u3057\u3066\u3044\u306a\u3044\\$topk\u500b\u306e\u6620\u753b\u3092\u63a8\u85a6\u3059\u308b\u5834\u5408\u306f\u6b21\u306e\u3088\u3046\u306a\u30af\u30a8\u30ea\u3092\u7528\u3044\u307e\u3059\u3002\n\n```sql\nset hivevar:userid=1;\nset hivevar:topk=5;\n\nselect\n  t1.movieid, \n  mf_predict(t2.Pu, t1.Qi, t2.Bu, t1.Bi, ${mu}) as predicted\nfrom (\n  select\n    idx as movieid,\n    Qi, \n    Bi\n  from\n    sgd_model p\n  where\n    p.idx NOT IN \n      (select movieid from training where userid=${userid})\n) t1 CROSS JOIN (\n  select\n    Pu,\n    Bu\n  from \n    sgd_model\n  where\n    idx = ${userid}\n) t2\norder by\n  predicted DESC\nlimit ${topk};\n```\n\n\u3053\u3053\u3067\u306f\u3001t1\u3067\u6c42\u3081\u308b\u672a\u8a55\u4fa1\u306e\u6620\u753b\u306e\u7279\u5fb4\u91cf\u3068t2\u3067\u6c42\u3081\u308b\u30e6\u30fc\u30b6\u306e\u7279\u5fb4\u91cf\u304b\u3089\u6620\u753b\u306e\u8a55\u4fa1\u5024\u3092\u4e88\u6e2c\u3057\u3066\u3044\u307e\u3059\u3002\n\n| movieid | predicted |\n|--------:|----------:|\n| 318     | 4.8051853 |\n| 2503    | 4.788541  |\n| 53      | 4.7518783 |\n| 904     | 4.7463417 |\n| 953     | 4.732769  |\n\n\u306a\u304a\u3001SQL\u306e[NOT IN\u53e5\u306fHive v0.13\u4ee5\u964d\u304b\u3089\u30b5\u30dd\u30fc\u30c8\u3055\u308c\u305f](https://cwiki.apache.org/confluence/display/Hive/LanguageManual+SubQueries#LanguageManualSubQueries-SubqueriesintheWHEREClause)\u6a5f\u80fd\u3067\u3042\u308b\u3053\u3068\u306b\u3054\u6ce8\u610f\u4e0b\u3055\u3044\u3002NOT IN\u306f[JOIN\u3068IS NULL\u3067\u8868\u73fe\u3059\u308b\u3053\u3068\u304c\u53ef\u80fd](http://explainextended.com/2009/09/15/not-in-vs-not-exists-vs-left-join-is-null-sql-server/)\u3067\u3059\u306e\u3067\u3001\u53e4\u3044\u30d0\u30fc\u30b8\u30e7\u30f3\u306eHive\u3067\u306fJOIN\u3068IS NULL\u3092\u4f7f\u3063\u305f\u30af\u30a8\u30ea\u3092\u4ee3\u7528\u4e0b\u3055\u3044\u3002\n\n\u30a2\u30a4\u30c6\u30e0\u3067\u306f\u306a\u304f\u3001\u30e6\u30fc\u30b6\u306e\u63a8\u85a6\u3082\u4e0a\u8a18\u306e\u30af\u30a8\u30ea\u3092\u8aad\u307f\u66ff\u3048\u308b\u3053\u3068\u3067\u53ef\u80fd\u3067\u3059\u3002\n\n# \u8a55\u4fa1\n\n[MAE\uff08Mean Absolute Error\uff09](http://en.wikipedia.org/wiki/Mean_absolute_error)\u304a\u3088\u3073[RMSE\uff08Root Mean Squared Error)](https://www.kaggle.com/wiki/RootMeanSquaredError)\u3092\u5229\u7528\u3057\u305f\u8a55\u4fa1\u306f\u6b21\u306e\u3088\u3046\u306b\u884c\u3044\u307e\u3059\u3002\n\n\u305d\u308c\u305e\u308c\u4e88\u6e2c\u8a55\u4fa1\u5024\u304c\u5b9f\u969b\u306e\u8a55\u4fa1\u5024\u304b\u3089\u3069\u308c\u304f\u3089\u3044\u96e2\u308c\u3066\u3044\u308b\u304b\u306e\u5c3a\u5ea6\u3067\u3001\u5c0f\u3055\u3044\u65b9\u304c\u4e88\u6e2c\u7cbe\u5ea6\u304c\u9ad8\u3044\u3082\u306e\u3068\u306a\u308a\u307e\u3059\u3002\n\n```sql\nselect\n  mae(predicted, actual) as mae,\n  rmse(predicted, actual) as rmse\nfrom (\n  select\n    t2.actual,\n    mf_predict(t2.Pu, p2.Qi, t2.Bu, p2.Bi, ${mu}) as predicted\n  from (\n    select\n      t1.userid, \n      t1.movieid,\n      t1.rating as actual,\n      p1.Pu,\n      p1.Bu\n    from\n      testing t1 LEFT OUTER JOIN sgd_model p1\n      ON (t1.userid = p1.idx) \n  ) t2 \n  LEFT OUTER JOIN sgd_model p2\n  ON (t2.movieid = p2.idx)\n) t;\n```\n\n> 0.6728969407733578 (MAE)\n> 0.8584162122694449 (RMSE)\n\n\u306a\u304a\u3001\u5e73\u5747\u7d76\u5bfe\u8aa4\u5dee\uff08MAE\uff09\u306e\u5b9a\u7fa9\u306f\u6b21\u306e\u3068\u304a\u308a\u3067\u3001\uff08\u4e88\u6e2c\u5024\u3068\u5b9f\u969b\u306e\u5024\u306e\uff09\u8aa4\u5dee\u306e\u7d76\u5bfe\u5024\u306e\u5e73\u5747\u3067\u3059\u3002\n\n```math\n\\mathrm{MAE} = \\frac{1}{n}\\sum_{i=1}^n \\left| f_i-y_i\\right| =\\frac{1}{n}\\sum_{i=1}^n \\left| e_i \\right|\n```\n\n# \u4ea4\u5dee\u691c\u5b9a (10-fold cross validation)\n\n\u3053\u3053\u3067\u306f\u3001\u4ea4\u5dee\u691c\u5b9a[^crossvalid]\u306b\u3088\u308a\u4e88\u6e2c\u6027\u80fd\u306e\u8a55\u4fa1\u3092\u884c\u3044\u307e\u3059\u3002\n\u4eca\u56de\u306f\u5b66\u7fd2\u30c7\u30fc\u30bf : \u8a55\u4fa1\u30c7\u30fc\u30bf\u30929 : 1 \u3067\u5206\u5272\u3057\u300110-fold\u306e\u4ea4\u5dee\u691c\u5b9a\u3092\u884c\u3063\u305f\u4e0a\u3067MAE/RMSE\u3067\u8a55\u4fa1\u3057\u307e\u3059\u3002\n\n## \u4ea4\u5dee\u691c\u5b9a\u7528\u306e\u30c7\u30fc\u30bf\u30bb\u30c3\u30c8\u306e\u6e96\u5099\n\n\u6b21\u306e\u3088\u3046\u306bkfold=10\u3092\u6307\u5b9a\u3057\u3066\u3001\u5143\u306e\u30c7\u30fc\u30bf\u30bb\u30c3\u30c8(ratings\u30c6\u30fc\u30d6\u30eb\uff09\u306b\u4ea4\u5dee\u691c\u5b9a\u7528\u306e\u30b0\u30eb\u30fc\u30d7ID(gid)\u3092\u52a0\u3048\u305f\u30c6\u30fc\u30d6\u30eb\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n```sql\nset hivevar:kfold=10;\nset hivevar:seed=31;\n\n-- Adding group id (gid) to each training instance\ndrop table ratings_groupded;\ncreate table ratings_groupded\nas\nselect\n  rand_gid2(${kfold}, ${seed}) gid, -- generates group id ranging from 1 to 10\n  userid, \n  movieid, \n  rating\nfrom\n  ratings\ncluster by gid, rand(${seed});\n```\n\n## \u5b66\u7fd2\u7528\u30d1\u30e9\u30e1\u30bf\u306e\u8a2d\u5b9a\n\n```sql\n-- latent factors\nset hivevar:factor=10;\n-- maximum number of iterations\nset hivevar:iters=50;\n-- regularization parameter\nset hivevar:lambda=0.05;\n-- learning rate\nset hivevar:eta=0.005;\n-- conversion rate (if changes between iterations became less or equals to ${cv_rate}, the training will stop)\nset hivevar:cv_rate=0.001;\n```\n\\$lambda\u306f\u6b63\u5247\u5316\u306e\u30d1\u30e9\u30e1\u30bf\u3001\\$eta\u306f\u5b66\u7fd2\u7387\u3001\\$cv_rate\u306f\u5b66\u7fd2\u306e\u53ce\u675f\u3092\u5224\u5b9a\u3059\u308b\u305f\u3081\u306eTHRESHOLD\uff08\u30a4\u30c6\u30ec\u30fc\u30b7\u30e7\u30f3\u3092\u91cd\u306d\u3066\u30820.1%\u4ee5\u4e0b\u306e\u5909\u5316\u306a\u3089\u3070\u53ce\u675f\u3057\u305f\u3068\u898b\u306a\u3059\uff09\u306b\u306a\u308a\u307e\u3059\u3002\n\n$mu\u306b\u306f\u6b63\u78ba\u3067\u306a\u3044\u5024\u3067\u3082\u69cb\u3044\u307e\u305b\u3093\u304c\u3001\u30b5\u30f3\u30d7\u30ea\u30f3\u30b0\u306a\u3069\u3092\u7528\u3044\u3066\u5e73\u5747\u7684\u306a\u5024\u3092\u6307\u5b9a\u3057\u3066\u304f\u3060\u3055\u3044\uff08\u4f8b\u3048\u30705\u6bb5\u968e\u30673\uff09\u3002\n\n```sql\nselect avg(rating) from ratings;\n```\n> 3.581564453029317\n\n```sql\n-- mean rating value (Optional but recommended to set ${mu})\nset hivevar:mu=3.581564453029317;\n```\n\n## Cross Validation\u7528\u306e\u30af\u30a8\u30ea\u306e\u81ea\u52d5\u751f\u6210\u3068\u5b9f\u884c\n\n[generate_cv.sh](https://gist.github.com/myui/c2009e5791cca650a4d0)\u3092\u5b9f\u884c\u3059\u308b\u3068[generate_cv.sql](https://gist.github.com/myui/2e2018217e2188222655)\u304c\u751f\u6210\u3055\u308c\u307e\u3059\u3002\n\n[generate_cv.sql](https://gist.github.com/myui/2e2018217e2188222655)\u3092\u5b9f\u884c\u3059\u308b\u3068MAE\u3068RMSE\u304c\u7d50\u679c\u3068\u3057\u3066\u8fd4\u308a\u307e\u3059\u3002\n\n> 0.6695442192077673 (MAE)\n> 0.8502739040257945 (RMSE)\n\n\u4ea4\u5dee\u691c\u5b9a\u7528\u306e\u30af\u30a8\u30ea\u306f\u591a\u304f\u306emap/reduce\u30bf\u30b9\u30af\u3092\u5fc5\u8981\u3068\u3057\u307e\u3059\u306e\u3067[Apache Tez](http://tez.apache.org/)\u3092\u5229\u7528\u3057\u305f\u5b9f\u884c\u3092\u304a\u3059\u3059\u3081\u3057\u307e\u3059\u3002\u79c1\u306e32\u30ce\u30fc\u30c9\u306eHadoop\u30af\u30e9\u30b9\u30bf\u306eHive(Tez)\u74b0\u5883\u3067\u306f\u3001\u4e26\u5217\u306b\u30bf\u30b9\u30af\u304c\u5b9f\u884c\u3055\u308c\u3066\u7d0445\u79d2\u3067JOB\u304c\u7d42\u4e86\u3057\u307e\u3057\u305f\u3002\n\n\u5b9f\u969b\u306b\u4f55\u3092\u3084\u3063\u3066\u3044\u308b\u304b\u306f[generate_cv.sql](https://gist.github.com/myui/2e2018217e2188222655)\u3092\u78ba\u8a8d\u304f\u3060\u3055\u3044\u3002\n\u307b\u304b\u306e\u30c7\u30fc\u30bf\u30bb\u30c3\u30c8\u306b\u4ea4\u5dee\u691c\u5b9a\u3092\u9069\u7528\u3059\u308b\u3068\u304d\u306f\u3001[generate_cv.sh](https://gist.github.com/myui/c2009e5791cca650a4d0)\u3092\u7de8\u96c6\u9802\u304f\u3053\u3068\u306b\u306a\u308a\u307e\u3059\u3002\n\n# \u3055\u3044\u3054\u306b\n\nMovielens 1M\u3067\u306f\u3001Spark MLlib\u306eALS-WR[^sparkmf]\u3068\u306f\u8aa4\u5dee\u6700\u5c0f\u5316\u306e\u76ee\u7684\u95a2\u6570\u3084\u6700\u9069\u5316\u65b9\u6cd5\u304c\u7570\u306a\u308a\u307e\u3059\u304c\u3001\u540c\u7b49\u306e\u4e88\u6e2c\u6027\u80fd\u3068\u306a\u308a\u307e\u3057\u305f\u3002\n\nHivemall\u306eMatrix Factorization\u306f\u30ce\u30fc\u30c9\u9593\u306e\u30d1\u30e9\u30e1\u30bf\u4ea4\u63db\u3092\u307e\u3060\u884c\u3063\u3066\u3044\u306a\u3044\u306e\u3067\u6539\u5584\u4f59\u5730\u306e\u3042\u308b\u6a5f\u80fd\u3067\u3059\u3002\n\u3054\u81ea\u8eab\u306e\u624b\u3067\u8a66\u3057\u3066\u3044\u305f\u3060\u304d\u3001\u30d5\u30a3\u30fc\u30c9\u30d0\u30c3\u30af\u306a\u308aPull request\u3092\u9802\u3051\u308c\u3070\u3068\u601d\u3044\u307e\u3059\u3002\n\n# \u53c2\u8003\u8cc7\u6599\n\n[^qiitamf]: [Machine Learning Advent Calendar 2013 16\u65e5\u76ee - Matrix Factorization\u3068\u306f](http://qiita.com/ysks3n/items/c81ff24da0390a74fc6c)\n[^sparkmf]: [\u30ab\u30a8\u30eb\u3067\u3082\u308f\u304b\u308b\uff01Spark / MLlib \u3067\u3084\u3063\u3066\u307f\u308b\u5354\u8abf\u30d5\u30a3\u30eb\u30bf\u30ea\u30f3\u30b0](http://tech.albert2005.co.jp/blog/2014/10/31/spark-mllib-collaborative-filtering-1/)\n[^biasedmf]: [Yehuda Koren, \"Factorization Meets the Neighborhood: a Multifaceted Collaborative Filtering Model\", Proc. KDD 2008.](http://www.citeulike.org/user/myui/article/3800901)\n[^crossvalid]: [\u7b2c21\u56de\uff08\u6700\u7d42\u56de\uff09\u6a5f\u68b0\u5b66\u7fd2 \u306f\u3058\u3081\u3088\u3046](http://gihyo.jp/dev/serial/01/machine-learning/0021)\n", "tags": ["hadoop", "hive", "\u6a5f\u68b0\u5b66\u7fd2", "matrix-factorization", "\u63a8\u85a6\u30b7\u30b9\u30c6\u30e0"]}