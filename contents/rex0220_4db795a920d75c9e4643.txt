{"context": "kintone \u3067SQL\u3092\u4f7f\u3046 \u306e\u7d9a\u304d\u3002\n\u5bfe\u8c61\u30ec\u30b3\u30fc\u30c9\u3092\u901a\u5e38\u4f7f\u308f\u308c\u308b\u7a0b\u5ea6\u306b\u5897\u3084\u3057\u3066\u3001\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u691c\u8a3c\u3057\u3066\u307f\u307e\u3057\u305f\u3002\n\u7d50\u679c\u306f\u3001\u30ec\u30b3\u30fc\u30c9\u53d6\u5f97\u304c\u307b\u3068\u3093\u3069\u306e\u51e6\u7406\u6642\u9593\u3067\u3001\u96c6\u8a08\u30fb\u8868\u793a\u306f\u554f\u984c\u306a\u3057\u3002\n\n\u96c6\u8a08\u5143\u30a2\u30d7\u30ea\u3000\n\u305d\u308c\u306a\u308a\u306b\u6570\u5024\u306e\u4ef6\u6570\u304c\u3042\u308b\u3082\u306e\u3068\u3044\u3046\u3053\u3068\u3067\u3001\u5e02\u533a\u753a\u6751\u5225\u4eba\u53e3\u30c7\u30fc\u30bf\u3092\u4f7f\u3044\u307e\u3059\u3002\n\n\n\u96c6\u8a08\u7d50\u679c\n\n\n\u5fc5\u8981\u30e9\u30a4\u30d6\u30e9\u30ea\n\n\nalasql.min.js : JavaScript \u3067 SQL \u304c\u4f7f\u3048\u307e\u3059\u3002\n\nhandsontable : \u30b0\u30ea\u30c3\u30c9\u8868\u793a\u7528\n\n\n\u96c6\u8a08\u30b3\u30fc\u30c9\n\u51e6\u7406\u6982\u8981\n\n\u4eba\u53e3\u60c5\u5831\u30a2\u30d7\u30ea\u306e\u30ec\u30b3\u30fc\u30c9\u3092\u53d6\u5f97\njson \u69cb\u9020\u3092\u7c21\u5358\u5316\nSQL \u3067\u96c6\u8a08\uff08Group By\uff09\n\u30ed\u30b0\u51e6\u7406\n\n////////////////////////////////////////////////////////////////////////////\n// kintone JavaScript: Summary of kintone records by alasql.\n//  2017.02.15 by rex0220\n////////////////////////////////////////////////////////////////////////////\n(function() {\n    \"use strict\";\n\n    // Log Output\n    var Log = (function() {\n        // \u30b3\u30f3\u30b9\u30c8\u30e9\u30af\u30bf\n        var Log = function(name, enabled) {\n            if(!(this instanceof Log)) {\n                return new Log(name);\n            }\n            this.name = name || 'log';\n            this.enabled = enabled;\n            this.start  = moment();\n            this.prev = this.start;\n            this.sno = 1;\n            if (!this.enabled) return;\n            console.log(this.name + ' start: ' + this.start.format('YYYY-MM-DD HH:mm:ss'));\n        }\n\n        var p = Log.prototype;\n\n        // write\u30e1\u30bd\u30c3\u30c9\n        p.write = function(step, info) {\n            if (!this.enabled) return;\n            var m1 = moment();\n            var d1 = m1.diff(this.prev, 'sss') / 1000;\n            if (info)\n                console.log(this.name + '-' + this.sno + ' ' + m1.format('HH:mm:ss')  + ' (' + d1 + ' \u79d2) : ' + step + ', ', info );\n            else\n                console.log(this.name + '-' + this.sno + ' ' + m1.format('HH:mm:ss')  + ' (' + d1 + ' \u79d2) : ' + step );\n            this.prev = m1;\n            this.sno++;\n        }\n\n        // info\u30e1\u30bd\u30c3\u30c9\n        p.info = function(step, info) {\n            if (!this.enabled) return;\n            console.log(this.name + '-' + this.sno + ' ' + step, info );\n        }\n\n        // end\u30e1\u30bd\u30c3\u30c9\n        p.end = function() {\n            if (!this.enabled) return;\n            var m1 = moment();\n            var d1 = m1.diff(this.start, 'sss') / 1000;\n            console.log(this.name + ' end  : ' + m1.format('YYYY-MM-DD HH:mm:ss')  + ' (' + d1 + ' \u79d2)' );\n        }\n\n        return Log;\n    })();\n\n\n    // \u4e00\u89a7\u8868\u793a\n    kintone.events.on(\"app.record.index.show\", function(event) {\n        if (event.viewId !== 5332655) return event;\n\n        var log = new Log('SQL-CHECK', true);\n\n        var obj = {};\n\n        // \u4eba\u53e3\u60c5\u5831\u53d6\u5f97\n        fetchRecords(event.appId, '\u5e02\u306a\u3069\u533a\u5206 in (\"1\",\"2\",\"3\")', ['\u90fd\u9053\u5e9c\u770c\u30b3\u30fc\u30c9', '\u90fd\u9053\u5e9c\u770c\u540d', '\u7dcf\u6570', '\u7dcf\u6570_\u7537', '\u7dcf\u6570_\u5973']).then(function(records) {\n\n            log.write('get record', records.length + ' records.' );\n\n            obj.rs1 = convertToRows(records);\n\n            log.write('convert rows', obj.rs1.length + ' rows.' );\n\n\n            // \u9867\u5ba2\u60c5\u5831\u3068\u6ce8\u6587\u60c5\u5831\u3092\u96c6\u8a08\n            var result1 = \n                alasql(\n                \"SELECT a.[\u90fd\u9053\u5e9c\u770c\u30b3\u30fc\u30c9], a.[\u90fd\u9053\u5e9c\u770c\u540d], SUM(a.[\u7dcf\u6570]) as [\u7dcf\u6570], SUM(a.[\u7dcf\u6570_\u7537]) as [\u7dcf\u6570_\u7537], SUM(a.[\u7dcf\u6570_\u5973]) as [\u7dcf\u6570_\u5973] \\\n                FROM ? AS a \\\n                GROUP BY a.[\u90fd\u9053\u5e9c\u770c\u30b3\u30fc\u30c9], a.[\u90fd\u9053\u5e9c\u770c\u540d] \\\n                ORDER BY a.[\u90fd\u9053\u5e9c\u770c\u30b3\u30fc\u30c9], a.[\u90fd\u9053\u5e9c\u770c\u540d]\", [obj.rs1]);\n\n            log.write('select group by', result1.length + ' rows.' );\n\n            // grid \u8868\u793a\n            var grid = document.getElementById('xp-grid');\n            new Handsontable(grid, { \n                data: result1, \n                colWidths: [50, 100, 200, 200, 200],\n                colHeaders: ['\u90fd\u9053\u5e9c\u770c\u30b3\u30fc\u30c9', '\u90fd\u9053\u5e9c\u770c\u540d', '\u7dcf\u6570', '\u7dcf\u6570_\u7537', '\u7dcf\u6570_\u5973'], \n                columns: [\n                    { data: '\u90fd\u9053\u5e9c\u770c\u30b3\u30fc\u30c9' },\n                    { data: '\u90fd\u9053\u5e9c\u770c\u540d' },\n                    { data: '\u7dcf\u6570', type: 'numeric', format: '0,0' },\n                    { data: '\u7dcf\u6570_\u7537', type: 'numeric', format: '0,0' },\n                    { data: '\u7dcf\u6570_\u5973', type: 'numeric', format: '0,0' },\n                ],\n                readOnly: true \n            });\n\n            log.write('grid display ');\n            log.end();\n\n        });\n\n        return event;\n    });\n\n\n    // get records\n    function fetchRecords(appId, opt_query, opt_fields, opt_offset, opt_limit, opt_records) {\n        var query = opt_query || '';\n        var offset = opt_offset || 0;\n        var limit = opt_limit || 500;\n        var allRecords = opt_records || [];\n        var params = {app: appId, query: query + ' limit ' + limit + ' offset ' + offset };\n        if (opt_fields) params.fields = opt_fields;\n        return kintone.api(kintone.api.url('/k/v1/records', true), 'GET', params).then(function(resp) {\n            allRecords = allRecords.concat(resp.records);\n            if (resp.records.length === limit) {\n                return fetchRecords(appId, query, opt_fields, offset + limit, limit, allRecords);\n            }\n            return allRecords;\n        });\n    }\n\n    // records convert to table rows \n    function convertToRows(records) {\n        var rows = records.map(function(record){\n            var keys = Object.keys(record);\n            var row = {};\n            keys.map(function(key){\n                row[key] = record[key].type === 'NUMBER' ? Number(record[key].value) : record[key].value;\n            });\n            return row;\n        });\n        return rows;\n    }\n\n})();\n\n\n\u5b9f\u884c\u6642\u9593\n\u7d04\uff15\u79d2\u306e\u51e6\u7406\u6642\u9593\u306e\u307b\u3068\u3093\u3069\u304c\u30ec\u30b3\u30fc\u30c9\u53d6\u5f97\u306b\u304b\u304b\u3063\u3066\u304a\u308a\u3001SQL \u51e6\u7406\u306f\u554f\u984c\u306a\u3044\u3002\nSQL-CHECK start: 2017-02-15 13:59:20\nSQL-CHECK-1 13:59:24 (4.568 \u79d2) : get record,  1719 records.\nSQL-CHECK-2 13:59:24 (0.007 \u79d2) : convert rows,  1719 rows.\nSQL-CHECK-3 13:59:24 (0.03 \u79d2) : select group by,  47 rows.\nSQL-CHECK-4 13:59:24 (0.067 \u79d2) : grid display \nSQL-CHECK end  : 2017-02-15 13:59:24 (4.673 \u79d2)\n\n\u5bfe\u8c61\u30ec\u30b3\u30fc\u30c9\u306e\u62bd\u51fa\u6761\u4ef6\u3092\u5909\u3048\u3066\u3001\u4ef6\u6570\u3092\u7d5e\u3063\u305f\u5834\u5408\u3002\n\u7d041,000 \u4ef6\u306e\u30c7\u30fc\u30bf\u3067\u3001\u7d04\uff13\u79d2\u3002\u3053\u306e\u7a0b\u5ea6\u306a\u3089\u3001\u904b\u7528\u3067\u3082\u554f\u984c\u306a\u3044\u3068\u601d\u308f\u308c\u308b\u3002\nSQL-CHECK start: 2017-02-15 14:08:16\nSQL-CHECK-1 14:08:19 (2.832 \u79d2) : get record,  1058 records.\nSQL-CHECK-2 14:08:19 (0.005 \u79d2) : convert rows,  1058 rows.\nSQL-CHECK-3 14:08:19 (0.035 \u79d2) : select group by,  25 rows.\nSQL-CHECK-4 14:08:19 (0.062 \u79d2) : grid display \nSQL-CHECK end  : 2017-02-15 14:08:19 (2.934 \u79d2)\n\n\n\u3042\u3068\u304c\u304d\nSQL \u5b9f\u884c\u306e\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u306b\u3064\u3044\u3066\u306f\u3001kintone \u306e 1,000 \u30ec\u30b3\u30fc\u30c9\u7a0b\u5ea6\u306a\u3089\u554f\u984c\u306a\u3057\u3002\n\u8907\u6570\u30a2\u30d7\u30ea\u306e\u30ec\u30b3\u30fc\u30c9\u3092 Join \u3059\u308b\u3057\u304f\u307f\u306a\u3069\u3067\u3082\u3001\u30ec\u30b3\u30fc\u30c9\u53d6\u5f97\u306e\u51e6\u7406\u304c\u8ab2\u984c\u306b\u306a\u308b\u3002\n[kintone \u3067SQL\u3092\u4f7f\u3046](http://qiita.com/rex0220/items/4d0c757344e8ac144f8d) \u306e\u7d9a\u304d\u3002\n\u5bfe\u8c61\u30ec\u30b3\u30fc\u30c9\u3092\u901a\u5e38\u4f7f\u308f\u308c\u308b\u7a0b\u5ea6\u306b\u5897\u3084\u3057\u3066\u3001\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u691c\u8a3c\u3057\u3066\u307f\u307e\u3057\u305f\u3002\n\n\u7d50\u679c\u306f\u3001\u30ec\u30b3\u30fc\u30c9\u53d6\u5f97\u304c\u307b\u3068\u3093\u3069\u306e\u51e6\u7406\u6642\u9593\u3067\u3001\u96c6\u8a08\u30fb\u8868\u793a\u306f\u554f\u984c\u306a\u3057\u3002\n\n# \u96c6\u8a08\u5143\u30a2\u30d7\u30ea\u3000\n\u305d\u308c\u306a\u308a\u306b\u6570\u5024\u306e\u4ef6\u6570\u304c\u3042\u308b\u3082\u306e\u3068\u3044\u3046\u3053\u3068\u3067\u3001\u5e02\u533a\u753a\u6751\u5225\u4eba\u53e3\u30c7\u30fc\u30bf\u3092\u4f7f\u3044\u307e\u3059\u3002\n\n![2017-02-15_12h16_06.png](https://qiita-image-store.s3.amazonaws.com/0/100572/97a91bda-e4da-00a5-791e-7041b416975e.png)\n\n\n# \u96c6\u8a08\u7d50\u679c\n\n\n![2017-02-15_12h19_22.png](https://qiita-image-store.s3.amazonaws.com/0/100572/0bf8c7b1-13ae-0d52-0598-54947ae152df.png)\n\n\n# \u5fc5\u8981\u30e9\u30a4\u30d6\u30e9\u30ea\n\n- [alasql.min.js](http://alasql.org/) : JavaScript \u3067 SQL \u304c\u4f7f\u3048\u307e\u3059\u3002\n- [handsontable](https://handsontable.com/?_ga=1.73131861.714310381.1484906350) : \u30b0\u30ea\u30c3\u30c9\u8868\u793a\u7528\n\n# \u96c6\u8a08\u30b3\u30fc\u30c9\n\n\u51e6\u7406\u6982\u8981\n\n- \u4eba\u53e3\u60c5\u5831\u30a2\u30d7\u30ea\u306e\u30ec\u30b3\u30fc\u30c9\u3092\u53d6\u5f97\n- json \u69cb\u9020\u3092\u7c21\u5358\u5316\n- SQL \u3067\u96c6\u8a08\uff08Group By\uff09\n- \u30ed\u30b0\u51e6\u7406\n\n```\n////////////////////////////////////////////////////////////////////////////\n// kintone JavaScript: Summary of kintone records by alasql.\n//  2017.02.15 by rex0220\n////////////////////////////////////////////////////////////////////////////\n(function() {\n    \"use strict\";\n\n    // Log Output\n    var Log = (function() {\n        // \u30b3\u30f3\u30b9\u30c8\u30e9\u30af\u30bf\n        var Log = function(name, enabled) {\n            if(!(this instanceof Log)) {\n                return new Log(name);\n            }\n            this.name = name || 'log';\n            this.enabled = enabled;\n            this.start  = moment();\n            this.prev = this.start;\n            this.sno = 1;\n            if (!this.enabled) return;\n            console.log(this.name + ' start: ' + this.start.format('YYYY-MM-DD HH:mm:ss'));\n        }\n\n        var p = Log.prototype;\n\n        // write\u30e1\u30bd\u30c3\u30c9\n        p.write = function(step, info) {\n            if (!this.enabled) return;\n            var m1 = moment();\n            var d1 = m1.diff(this.prev, 'sss') / 1000;\n            if (info)\n                console.log(this.name + '-' + this.sno + ' ' + m1.format('HH:mm:ss')  + ' (' + d1 + ' \u79d2) : ' + step + ', ', info );\n            else\n                console.log(this.name + '-' + this.sno + ' ' + m1.format('HH:mm:ss')  + ' (' + d1 + ' \u79d2) : ' + step );\n            this.prev = m1;\n            this.sno++;\n        }\n\n        // info\u30e1\u30bd\u30c3\u30c9\n        p.info = function(step, info) {\n            if (!this.enabled) return;\n            console.log(this.name + '-' + this.sno + ' ' + step, info );\n        }\n\n        // end\u30e1\u30bd\u30c3\u30c9\n        p.end = function() {\n            if (!this.enabled) return;\n            var m1 = moment();\n            var d1 = m1.diff(this.start, 'sss') / 1000;\n            console.log(this.name + ' end  : ' + m1.format('YYYY-MM-DD HH:mm:ss')  + ' (' + d1 + ' \u79d2)' );\n        }\n\n        return Log;\n    })();\n\n\n    // \u4e00\u89a7\u8868\u793a\n    kintone.events.on(\"app.record.index.show\", function(event) {\n        if (event.viewId !== 5332655) return event;\n\n        var log = new Log('SQL-CHECK', true);\n\n        var obj = {};\n\n        // \u4eba\u53e3\u60c5\u5831\u53d6\u5f97\n        fetchRecords(event.appId, '\u5e02\u306a\u3069\u533a\u5206 in (\"1\",\"2\",\"3\")', ['\u90fd\u9053\u5e9c\u770c\u30b3\u30fc\u30c9', '\u90fd\u9053\u5e9c\u770c\u540d', '\u7dcf\u6570', '\u7dcf\u6570_\u7537', '\u7dcf\u6570_\u5973']).then(function(records) {\n\n            log.write('get record', records.length + ' records.' );\n\n            obj.rs1 = convertToRows(records);\n\n            log.write('convert rows', obj.rs1.length + ' rows.' );\n\n\n            // \u9867\u5ba2\u60c5\u5831\u3068\u6ce8\u6587\u60c5\u5831\u3092\u96c6\u8a08\n            var result1 = \n                alasql(\n                \"SELECT a.[\u90fd\u9053\u5e9c\u770c\u30b3\u30fc\u30c9], a.[\u90fd\u9053\u5e9c\u770c\u540d], SUM(a.[\u7dcf\u6570]) as [\u7dcf\u6570], SUM(a.[\u7dcf\u6570_\u7537]) as [\u7dcf\u6570_\u7537], SUM(a.[\u7dcf\u6570_\u5973]) as [\u7dcf\u6570_\u5973] \\\n                FROM ? AS a \\\n                GROUP BY a.[\u90fd\u9053\u5e9c\u770c\u30b3\u30fc\u30c9], a.[\u90fd\u9053\u5e9c\u770c\u540d] \\\n                ORDER BY a.[\u90fd\u9053\u5e9c\u770c\u30b3\u30fc\u30c9], a.[\u90fd\u9053\u5e9c\u770c\u540d]\", [obj.rs1]);\n\n            log.write('select group by', result1.length + ' rows.' );\n\n            // grid \u8868\u793a\n            var grid = document.getElementById('xp-grid');\n            new Handsontable(grid, { \n                data: result1, \n                colWidths: [50, 100, 200, 200, 200],\n                colHeaders: ['\u90fd\u9053\u5e9c\u770c\u30b3\u30fc\u30c9', '\u90fd\u9053\u5e9c\u770c\u540d', '\u7dcf\u6570', '\u7dcf\u6570_\u7537', '\u7dcf\u6570_\u5973'], \n                columns: [\n                    { data: '\u90fd\u9053\u5e9c\u770c\u30b3\u30fc\u30c9' },\n                    { data: '\u90fd\u9053\u5e9c\u770c\u540d' },\n                    { data: '\u7dcf\u6570', type: 'numeric', format: '0,0' },\n                    { data: '\u7dcf\u6570_\u7537', type: 'numeric', format: '0,0' },\n                    { data: '\u7dcf\u6570_\u5973', type: 'numeric', format: '0,0' },\n                ],\n                readOnly: true \n            });\n\n            log.write('grid display ');\n            log.end();\n\n        });\n\n        return event;\n    });\n\n\n    // get records\n    function fetchRecords(appId, opt_query, opt_fields, opt_offset, opt_limit, opt_records) {\n        var query = opt_query || '';\n        var offset = opt_offset || 0;\n        var limit = opt_limit || 500;\n        var allRecords = opt_records || [];\n        var params = {app: appId, query: query + ' limit ' + limit + ' offset ' + offset };\n        if (opt_fields) params.fields = opt_fields;\n        return kintone.api(kintone.api.url('/k/v1/records', true), 'GET', params).then(function(resp) {\n            allRecords = allRecords.concat(resp.records);\n            if (resp.records.length === limit) {\n                return fetchRecords(appId, query, opt_fields, offset + limit, limit, allRecords);\n            }\n            return allRecords;\n        });\n    }\n\n    // records convert to table rows \n    function convertToRows(records) {\n        var rows = records.map(function(record){\n            var keys = Object.keys(record);\n            var row = {};\n            keys.map(function(key){\n                row[key] = record[key].type === 'NUMBER' ? Number(record[key].value) : record[key].value;\n            });\n            return row;\n        });\n        return rows;\n    }\n\n})();\n```\n\n#\u5b9f\u884c\u6642\u9593\n\n\u7d04\uff15\u79d2\u306e\u51e6\u7406\u6642\u9593\u306e\u307b\u3068\u3093\u3069\u304c\u30ec\u30b3\u30fc\u30c9\u53d6\u5f97\u306b\u304b\u304b\u3063\u3066\u304a\u308a\u3001SQL \u51e6\u7406\u306f\u554f\u984c\u306a\u3044\u3002\n\n```\nSQL-CHECK start: 2017-02-15 13:59:20\nSQL-CHECK-1 13:59:24 (4.568 \u79d2) : get record,  1719 records.\nSQL-CHECK-2 13:59:24 (0.007 \u79d2) : convert rows,  1719 rows.\nSQL-CHECK-3 13:59:24 (0.03 \u79d2) : select group by,  47 rows.\nSQL-CHECK-4 13:59:24 (0.067 \u79d2) : grid display \nSQL-CHECK end  : 2017-02-15 13:59:24 (4.673 \u79d2)\n```\n\n\u5bfe\u8c61\u30ec\u30b3\u30fc\u30c9\u306e\u62bd\u51fa\u6761\u4ef6\u3092\u5909\u3048\u3066\u3001\u4ef6\u6570\u3092\u7d5e\u3063\u305f\u5834\u5408\u3002\n\u7d041,000 \u4ef6\u306e\u30c7\u30fc\u30bf\u3067\u3001\u7d04\uff13\u79d2\u3002\u3053\u306e\u7a0b\u5ea6\u306a\u3089\u3001\u904b\u7528\u3067\u3082\u554f\u984c\u306a\u3044\u3068\u601d\u308f\u308c\u308b\u3002\n\n```\nSQL-CHECK start: 2017-02-15 14:08:16\nSQL-CHECK-1 14:08:19 (2.832 \u79d2) : get record,  1058 records.\nSQL-CHECK-2 14:08:19 (0.005 \u79d2) : convert rows,  1058 rows.\nSQL-CHECK-3 14:08:19 (0.035 \u79d2) : select group by,  25 rows.\nSQL-CHECK-4 14:08:19 (0.062 \u79d2) : grid display \nSQL-CHECK end  : 2017-02-15 14:08:19 (2.934 \u79d2)\n```\n\n# \u3042\u3068\u304c\u304d\n\nSQL \u5b9f\u884c\u306e\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u306b\u3064\u3044\u3066\u306f\u3001kintone \u306e 1,000 \u30ec\u30b3\u30fc\u30c9\u7a0b\u5ea6\u306a\u3089\u554f\u984c\u306a\u3057\u3002\n\u8907\u6570\u30a2\u30d7\u30ea\u306e\u30ec\u30b3\u30fc\u30c9\u3092 Join \u3059\u308b\u3057\u304f\u307f\u306a\u3069\u3067\u3082\u3001\u30ec\u30b3\u30fc\u30c9\u53d6\u5f97\u306e\u51e6\u7406\u304c\u8ab2\u984c\u306b\u306a\u308b\u3002\n\n", "tags": ["kintone", "alasql", "JavaScript"]}