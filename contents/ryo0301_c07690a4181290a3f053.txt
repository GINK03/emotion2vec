{"context": " More than 1 year has passed since last update.\n\n\u6982\u8981\nS3 \u306b JavaScript \u306e\u30e2\u30b8\u30e5\u30fc\u30eb\u3092\u7f6e\u304d\u3001\u305d\u306e\u30d0\u30b1\u30c3\u30c8\u540d\u3068\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u30ad\u30fc\u3092 Kinesis \u30b9\u30c8\u30ea\u30fc\u30e0\u306b\u6d41\u3059\u3053\u3068\u3067 Lambda \u304b\u3089\u52d5\u7684\u306b JS \u3092\u547c\u3073\u51fa\u3057\u5b9f\u884c\u3057\u3066\u307f\u308b\u3002\n\u4f55\u306b\u4f7f\u3046\u3093\u3067\u3057\u3087\u3046\u306d\u3002\n\n\u30b5\u30f3\u30d7\u30eb\u30b3\u30fc\u30c9\n\u30ed\u30fc\u30ab\u30eb\u306b\u66f8\u304d\u51fa\u3057\u305f\u30d5\u30a1\u30a4\u30eb\u540d\u306b context.invokeid \u3092\u4f7f\u3046\u3053\u3068\u3067 require \u306b\u30ad\u30e3\u30c3\u30b7\u30e5\u3055\u308c\u308b\u3053\u3068\u306f\u306a\u304f\u306a\u3063\u305f\u3002\n\u3064\u307e\u308a\u9045\u3044\u3002\n\u3064\u307e\u308a\u30b9\u30c6\u30fc\u30c8\u30ec\u30b9\u3068\u8a00\u3063\u3066\u3044\u308b\u3051\u3069 require \u306e\u7d50\u679c\u306f\u30ad\u30e3\u30c3\u30b7\u30e5\u3055\u308c\u3066\u3044\u308b\u307f\u305f\u3044\u3002\n\nLambda function\n\nhandler\nvar fs = require('fs');\nvar aws = require('aws-sdk');\nvar s3 = new aws.S3({apiVersion: '2006-03-01'});\n\nexports.handler = function(event, context) {\n    console.log(JSON.stringify(event, null, 2));\n    console.log(JSON.stringify(context, null, 2));\n\n    var encodedPayload = event.Records[0].kinesis.data;\n    var data = JSON.parse(new Buffer(encodedPayload, 'base64').toString('ascii'));\n    console.log(JSON.stringify(data, null, 2));\n\n    var bucket = data.bucket;\n    var key = data.key;\n\n    s3.getObject({ Bucket:bucket, Key:key }, function(err, data) {\n        if (err) {\n            context.done('error getting object', err);\n        } else {\n            var modPath = '/tmp/' + context.invokeid;\n            var w = fs.createWriteStream(modPath);\n            w.write(data.Body);\n            w.end(function() {\n                var mod = require(modPath);\n                mod.do(event, function(err, res) {\n                    if (err) {\n                        context.done('error', err);\n                    } else {\n                        context.done(null, res);\n                    }\n                });\n            });\n        }\n    });\n};\n\n\n\nevent\nevent.Records[0].kinesis.data \u3092 decode \u3059\u308b\u3068\u4e0b\u8a18\u306e\u3088\u3046\u306aJSON\u306b\u306a\u308b\u3002\n\nevent.Records[0].kinesis.data\n{\n  \"bucket\" : \"js-bucket\",\n  \"key\" : \"/path/to/target.js\"\n}\n\n\n\u3061\u306a\u307f\u306b Management Console \u3067 Lambda \u306e\u7de8\u96c6\u6642\u306b\u8868\u793a\u3055\u308c\u308b Sample event \u306f Kinesis \u3082 DynamoDB Streams \u3082\u5b9f\u969b\u306e\u30c7\u30fc\u30bf\u3068\u9055\u3046\u306e\u3067\u6ce8\u610f\u3002\n\u305f\u3060 Lambda \u306f Preview \u306a\u306e\u3067\u6700\u7d42\u7684\u306b\u3069\u3046\u306a\u308b\u304b\u306f\u5206\u304b\u3089\u306a\u3044\u3002\n\nkinesis\n{\n  \"Records\": [\n    {\n      \"kinesis\": {\n        \"partitionKey\": \"shardId-000000000000\",\n        \"kinesisSchemaVersion\": \"1.0\",\n        \"data\": \"eyJidWNrZXQiOiJoaWRlbm8tdGVzdC1pbnZva2UtanMiLCXXXXXXXXXXXXXXXXXX\",\n        \"sequenceNumber\": \"49545662236882836628328222551726608793875413962349084674\"\n      },\n      \"eventSource\": \"aws:kinesis\",\n      \"eventID\": \"shardId-000000000000:49545662236882836628328222000000000000000000000000000000\",\n      \"invokeIdentityArn\": \"arn:aws:iam::000000000000:role/invocation-role\",\n      \"eventVersion\": \"1.0\",\n      \"eventName\": \"aws:kinesis:record\",\n      \"eventSourceARN\": \"arn:aws:kinesis:us-east-1:000000000000:stream/stream-name\",\n      \"awsRegion\": \"us-east-1\"\n    }\n  ]\n}\n\n\n\nS3\u4e0a\u306eJS\n\ndo.js\nexports.do = function(event, callback) {\n    console.log('doing');\n    callback(null, 'done');\n};\n\n\n\nKinesis \u3068 Lambda \u306e\u7d10\u4ed8\u3051\nCLI \u3088\u308a pry + SDK \u306e\u307b\u3046\u304c\u597d\u304d\u306a\u306e\u3067\u305d\u3046\u3057\u305f\u3002\nbatch_size \u306f\u30c7\u30d5\u30a9\u30eb\u30c8\u3067 1 \u306b\u306a\u308b\u3002\u672c\u5f53\u306f\u6307\u5b9a\u3057\u5fd8\u308c\u305f\u3060\u3051\u3060\u3051\u3069\u305d\u308c\u3067\u3044\u3044\u3002\n\u8a73\u7d30\u306f\u4e0b\u8a18\u306e\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u3092\u53c2\u7167\u3002\u4e00\u9023\u306e\u6d41\u308c\u304c\u66f8\u3044\u3066\u3042\u308b\u3002\nhttp://docs.aws.amazon.com/lambda/latest/dg/walkthrough-kinesis-events-adminuser.html\nl = Aws::Lambda::Client.new region: 'us-east-1'\n\nes = 'arn:aws:kinesis:us-east-1:000000000000:stream/stream-name'\nrole = 'arn:aws:iam::000000000000:role/invocation-role'\nl.add_event_source event_source: es, function_name: 'invoke-js', role: role\n\n\nKinesis \u306b\u30ea\u30af\u30a8\u30b9\u30c8\u3092\u6d41\u3059\nk = Aws::Kinesis::Client.new region: 'us-east-1'\n\ndata = {'bucket' => 'js-bucket', 'key' => '/path/to/target.js'}.to_json\nk.put_record stream_name: 'stream-name', data: data, partition_key: 'shardId-000000000000'\n\n\u3053\u308c\u306f\u30c6\u30b9\u30c8\u5b9f\u884c\u306e\u7d50\u679c\u3060\u3051\u3069\u3001\u3053\u3093\u306a\u611f\u3058\u3067 CloudWatch Logs \u306b\u3082\u51fa\u529b\u3055\u308c\u308b\u3002\nLogs\n----\nSTART RequestId: 6cb8aa1e-7a93-11e4-ae0c-cb41dfce093f\n2014-12-03T02:23:21.297Z    6cb8aa1e-7a93-11e4-ae0c-cb41dfce093f    {\n  \"Records\": [\n    {\n      \"awsRegion\": \"us-east-1\",\n      \"sequenceNumber\": \"196800000000000000000000\",\n      \"partitionKey\": \"2efdb0ea22685b46993e42a67302a001\",\n      \"eventSource\": \"aws:kinesis\",\n      \"kinesis\": {\n        \"data\": \"XXXXXXXXXXXXX............\"\n      }\n    }\n  ]\n}\n2014-12-03T02:23:21.298Z    6cb8aa1e-7a93-11e4-ae0c-cb41dfce093f    {\n  \"invokeid\": \"6cb8aa1e-7a93-11e4-ae0c-cb41dfce093f\"\n}\n2014-12-03T02:23:21.298Z    6cb8aa1e-7a93-11e4-ae0c-cb41dfce093f    {\n  \"bucket\": \"js-bucket\",\n  \"key\": \"/path/to/target.js\"\n}\n2014-12-03T02:23:21.379Z    6cb8aa1e-7a93-11e4-ae0c-cb41dfce093f    doing\nEND RequestId: 6cb8aa1e-7a93-11e4-ae0c-cb41dfce093f\nREPORT RequestId: 6cb8aa1e-7a93-11e4-ae0c-cb41dfce093f  Duration: 95.43 ms  Billed Duration: 100 ms     Memory Size: 128 MB Max Memory Used: 17 MB  \n\nMessage\n-------\ndone\n\n\n\u611f\u60f3\n\u5b9f\u969b\u4f7f\u3046\u304b\u3068\u8a00\u308f\u308c\u308c\u3070\u4f7f\u308f\u306a\u3044\u304b\u306a\u3068\u601d\u3046\u3002S3\u3092git\u30ea\u30dd\u30b8\u30c8\u30ea\u306b\u3057\u3066\u5358\u767a\u3067\u52d5\u304b\u3059\u3068\u958b\u767a\u3057\u3084\u3059\u3044\u3001\u304b\u306a\u3042\u30fb\u30fb\u30fb\nLambda \u30d5\u30a1\u30f3\u30af\u30b7\u30e7\u30f3\u306b\u4ed8\u3051\u308b execution role \u306b\u306f\u6c17\u3092\u3064\u3051\u3088\u3046\u3002\n\u6b21\u306f Function \u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u30b7\u30ea\u30a2\u30e9\u30a4\u30ba\u3057\u3066 Kinesis \u30b9\u30c8\u30ea\u30fc\u30e0\u306b\u6d41\u3057\u3066 Lambda \u3067\u5b9f\u884c\u3057\u3066\u307f\u305f\u3044\u3002\n\n# \u6982\u8981\n\nS3 \u306b JavaScript \u306e\u30e2\u30b8\u30e5\u30fc\u30eb\u3092\u7f6e\u304d\u3001\u305d\u306e\u30d0\u30b1\u30c3\u30c8\u540d\u3068\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u30ad\u30fc\u3092 Kinesis \u30b9\u30c8\u30ea\u30fc\u30e0\u306b\u6d41\u3059\u3053\u3068\u3067 Lambda \u304b\u3089\u52d5\u7684\u306b JS \u3092\u547c\u3073\u51fa\u3057\u5b9f\u884c\u3057\u3066\u307f\u308b\u3002\n\u4f55\u306b\u4f7f\u3046\u3093\u3067\u3057\u3087\u3046\u306d\u3002\n\n# \u30b5\u30f3\u30d7\u30eb\u30b3\u30fc\u30c9\n\n\u30ed\u30fc\u30ab\u30eb\u306b\u66f8\u304d\u51fa\u3057\u305f\u30d5\u30a1\u30a4\u30eb\u540d\u306b `context.invokeid` \u3092\u4f7f\u3046\u3053\u3068\u3067 `require` \u306b\u30ad\u30e3\u30c3\u30b7\u30e5\u3055\u308c\u308b\u3053\u3068\u306f\u306a\u304f\u306a\u3063\u305f\u3002\n\u3064\u307e\u308a\u9045\u3044\u3002\n\u3064\u307e\u308a\u30b9\u30c6\u30fc\u30c8\u30ec\u30b9\u3068\u8a00\u3063\u3066\u3044\u308b\u3051\u3069 `require` \u306e\u7d50\u679c\u306f\u30ad\u30e3\u30c3\u30b7\u30e5\u3055\u308c\u3066\u3044\u308b\u307f\u305f\u3044\u3002\n\n## Lambda function\n\n```js:handler\nvar fs = require('fs');\nvar aws = require('aws-sdk');\nvar s3 = new aws.S3({apiVersion: '2006-03-01'});\n\nexports.handler = function(event, context) {\n    console.log(JSON.stringify(event, null, 2));\n    console.log(JSON.stringify(context, null, 2));\n    \n    var encodedPayload = event.Records[0].kinesis.data;\n    var data = JSON.parse(new Buffer(encodedPayload, 'base64').toString('ascii'));\n    console.log(JSON.stringify(data, null, 2));\n    \n    var bucket = data.bucket;\n    var key = data.key;\n    \n    s3.getObject({ Bucket:bucket, Key:key }, function(err, data) {\n        if (err) {\n            context.done('error getting object', err);\n        } else {\n            var modPath = '/tmp/' + context.invokeid;\n            var w = fs.createWriteStream(modPath);\n            w.write(data.Body);\n            w.end(function() {\n                var mod = require(modPath);\n                mod.do(event, function(err, res) {\n                    if (err) {\n                        context.done('error', err);\n                    } else {\n                        context.done(null, res);\n                    }\n                });\n            });\n        }\n    });\n};\n```\n\n## event\n\n`event.Records[0].kinesis.data` \u3092 decode \u3059\u308b\u3068\u4e0b\u8a18\u306e\u3088\u3046\u306aJSON\u306b\u306a\u308b\u3002\n\n```js:event.Records[0].kinesis.data\n{\n  \"bucket\" : \"js-bucket\",\n  \"key\" : \"/path/to/target.js\"\n}\n```\n\n\u3061\u306a\u307f\u306b Management Console \u3067 Lambda \u306e\u7de8\u96c6\u6642\u306b\u8868\u793a\u3055\u308c\u308b Sample event \u306f Kinesis \u3082 DynamoDB Streams \u3082\u5b9f\u969b\u306e\u30c7\u30fc\u30bf\u3068\u9055\u3046\u306e\u3067\u6ce8\u610f\u3002\n\u305f\u3060 Lambda \u306f Preview \u306a\u306e\u3067\u6700\u7d42\u7684\u306b\u3069\u3046\u306a\u308b\u304b\u306f\u5206\u304b\u3089\u306a\u3044\u3002\n\n```js:kinesis\n{\n  \"Records\": [\n    {\n      \"kinesis\": {\n        \"partitionKey\": \"shardId-000000000000\",\n        \"kinesisSchemaVersion\": \"1.0\",\n        \"data\": \"eyJidWNrZXQiOiJoaWRlbm8tdGVzdC1pbnZva2UtanMiLCXXXXXXXXXXXXXXXXXX\",\n        \"sequenceNumber\": \"49545662236882836628328222551726608793875413962349084674\"\n      },\n      \"eventSource\": \"aws:kinesis\",\n      \"eventID\": \"shardId-000000000000:49545662236882836628328222000000000000000000000000000000\",\n      \"invokeIdentityArn\": \"arn:aws:iam::000000000000:role/invocation-role\",\n      \"eventVersion\": \"1.0\",\n      \"eventName\": \"aws:kinesis:record\",\n      \"eventSourceARN\": \"arn:aws:kinesis:us-east-1:000000000000:stream/stream-name\",\n      \"awsRegion\": \"us-east-1\"\n    }\n  ]\n}\n```\n\n## S3\u4e0a\u306eJS\n\n```js:do.js\nexports.do = function(event, callback) {\n    console.log('doing');\n    callback(null, 'done');\n};\n```\n\n# Kinesis \u3068 Lambda \u306e\u7d10\u4ed8\u3051\n\nCLI \u3088\u308a pry + SDK \u306e\u307b\u3046\u304c\u597d\u304d\u306a\u306e\u3067\u305d\u3046\u3057\u305f\u3002\n`batch_size` \u306f\u30c7\u30d5\u30a9\u30eb\u30c8\u3067 1 \u306b\u306a\u308b\u3002\u672c\u5f53\u306f\u6307\u5b9a\u3057\u5fd8\u308c\u305f\u3060\u3051\u3060\u3051\u3069\u305d\u308c\u3067\u3044\u3044\u3002\n\n\u8a73\u7d30\u306f\u4e0b\u8a18\u306e\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u3092\u53c2\u7167\u3002\u4e00\u9023\u306e\u6d41\u308c\u304c\u66f8\u3044\u3066\u3042\u308b\u3002\nhttp://docs.aws.amazon.com/lambda/latest/dg/walkthrough-kinesis-events-adminuser.html\n\n```rb\nl = Aws::Lambda::Client.new region: 'us-east-1'\n\nes = 'arn:aws:kinesis:us-east-1:000000000000:stream/stream-name'\nrole = 'arn:aws:iam::000000000000:role/invocation-role'\nl.add_event_source event_source: es, function_name: 'invoke-js', role: role\n```\n\n# Kinesis \u306b\u30ea\u30af\u30a8\u30b9\u30c8\u3092\u6d41\u3059\n\n```rb\nk = Aws::Kinesis::Client.new region: 'us-east-1'\n\ndata = {'bucket' => 'js-bucket', 'key' => '/path/to/target.js'}.to_json\nk.put_record stream_name: 'stream-name', data: data, partition_key: 'shardId-000000000000'\n```\n\n\u3053\u308c\u306f\u30c6\u30b9\u30c8\u5b9f\u884c\u306e\u7d50\u679c\u3060\u3051\u3069\u3001\u3053\u3093\u306a\u611f\u3058\u3067 CloudWatch Logs \u306b\u3082\u51fa\u529b\u3055\u308c\u308b\u3002\n\n```\nLogs\n----\nSTART RequestId: 6cb8aa1e-7a93-11e4-ae0c-cb41dfce093f\n2014-12-03T02:23:21.297Z\t6cb8aa1e-7a93-11e4-ae0c-cb41dfce093f\t{\n  \"Records\": [\n    {\n      \"awsRegion\": \"us-east-1\",\n      \"sequenceNumber\": \"196800000000000000000000\",\n      \"partitionKey\": \"2efdb0ea22685b46993e42a67302a001\",\n      \"eventSource\": \"aws:kinesis\",\n      \"kinesis\": {\n        \"data\": \"XXXXXXXXXXXXX............\"\n      }\n    }\n  ]\n}\n2014-12-03T02:23:21.298Z\t6cb8aa1e-7a93-11e4-ae0c-cb41dfce093f\t{\n  \"invokeid\": \"6cb8aa1e-7a93-11e4-ae0c-cb41dfce093f\"\n}\n2014-12-03T02:23:21.298Z\t6cb8aa1e-7a93-11e4-ae0c-cb41dfce093f\t{\n  \"bucket\": \"js-bucket\",\n  \"key\": \"/path/to/target.js\"\n}\n2014-12-03T02:23:21.379Z\t6cb8aa1e-7a93-11e4-ae0c-cb41dfce093f\tdoing\nEND RequestId: 6cb8aa1e-7a93-11e4-ae0c-cb41dfce093f\nREPORT RequestId: 6cb8aa1e-7a93-11e4-ae0c-cb41dfce093f\tDuration: 95.43 ms\tBilled Duration: 100 ms \tMemory Size: 128 MB\tMax Memory Used: 17 MB\t\n\nMessage\n-------\ndone\n```\n\n# \u611f\u60f3\n\n\u5b9f\u969b\u4f7f\u3046\u304b\u3068\u8a00\u308f\u308c\u308c\u3070\u4f7f\u308f\u306a\u3044\u304b\u306a\u3068\u601d\u3046\u3002S3\u3092git\u30ea\u30dd\u30b8\u30c8\u30ea\u306b\u3057\u3066\u5358\u767a\u3067\u52d5\u304b\u3059\u3068\u958b\u767a\u3057\u3084\u3059\u3044\u3001\u304b\u306a\u3042\u30fb\u30fb\u30fb\nLambda \u30d5\u30a1\u30f3\u30af\u30b7\u30e7\u30f3\u306b\u4ed8\u3051\u308b execution role \u306b\u306f\u6c17\u3092\u3064\u3051\u3088\u3046\u3002\n\n\u6b21\u306f Function \u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u30b7\u30ea\u30a2\u30e9\u30a4\u30ba\u3057\u3066 Kinesis \u30b9\u30c8\u30ea\u30fc\u30e0\u306b\u6d41\u3057\u3066 Lambda \u3067\u5b9f\u884c\u3057\u3066\u307f\u305f\u3044\u3002\n", "tags": ["Kinesis", "lambda", "AWS", "S3"]}