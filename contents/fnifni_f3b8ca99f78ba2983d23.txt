{"context": "\u3053\u3093\u306b\u3061\u306f\u3001\u3072\u308d\u304b\u305a\u3067\u3059\u3002\nDocker\u30b3\u30f3\u30c6\u30ca\u304c\u7a3c\u50cd\u3059\u308bContainer Instance\u306bDeep Security Agent\u3092\u5c0e\u5165\u3059\u308b\u9700\u8981\u304c\u3042\u308b\u306e\u3067\u3001\u4e00\u7b46\u66f8\u304d\u307e\u3059\u3002\n\n2016\u5e744\u67088\u65e5\u8ffd\u88dc\ndocker\u306f\u3001\u30db\u30b9\u30c8\u3068Container\u9593\u306e\u901a\u4fe1\u3092iptables\u3067nat\u3059\u308b\u305f\u3081\u3001\u6697\u9ed9\u7684\u306biptables\u3092\u4f7f\u7528\u3057\u307e\u3059\u3002\nDeep Security Agent\u306f\u3001\u8d77\u52d5\u6642\u306biptables\u3092\u505c\u6b62\u3059\u308b\u306e\u3067\u3001\u4e8b\u524d\u306biptables\u306b\u5f71\u97ff\u3092\u53ca\u307c\u3055\u306a\u3044\u63aa\u7f6e\u3092\u53d6\u3063\u3066\u304a\u304f\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\u53c2\u8003\u8a18\u4e8b\nNAT\u30b5\u30fc\u30d0\u306bDSA\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b(Deep Security 9.5 / DSaaS)\n\n\u524d\u63d0\n\nDeep Security Manager 9.6\u3001\u307e\u305f\u306fDSaaS\u306e\u5c0e\u5165\u304c\u5b8c\u4e86\u3057\u3066\u3044\u308b\u3053\u3068\u3002\n\u30e9\u30a4\u30bb\u30f3\u30b9\u3092\u6295\u5165\u3057\u3066\u3044\u308b\u3053\u3068\u3002\nContainer Instance\u3092\u914d\u7f6e\u3059\u308bVPC, Subnet, SecurityGroup\u304c\u5b58\u5728\u3059\u308b\u3053\u3068\u3002\nContainer Instance\u3092\u914d\u7f6e\u3059\u308bAWS\u30a2\u30ab\u30a6\u30f3\u30c8\u306e\u30af\u30e9\u30a6\u30c9\u30a2\u30ab\u30a6\u30f3\u30c8\u304c\u767b\u9332\u6e08\u307f\u3067\u3042\u308b\u3053\u3068\u3002(\u53c2\u7167:Auto Scale\u3057\u305f\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092Deep Security\u3067\u7ba1\u7406\u3059\u308b)\n\n\n\u53c2\u7167\u60c5\u5831\n\nAmazon EC2 Container Service:\u3088\u304f\u3042\u308b\u8cea\u554f:\u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\nAmazon EC2 Container Service:Developer Guide: Getting Started with Amazon ECS\nsuz-lab - blog:CloudFormation\u3067\"Container Instance\"\u304c\"Auto Scaling\"\u3067\u7ba1\u7406\u3055\u308c\u3066\u3044\u308bECS\u306e\u30af\u30e9\u30b9\u30bf\u30fc\u3092\u4f5c\u6210\u3057\u3066\u307f\u305f\n\n\n\u76ee\u7684\u3068\u30b4\u30fc\u30eb\n\nCloudFormation\u3067\u8d77\u52d5\u6642\u306bDeep Security Agent\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb/\u6709\u52b9\u5316\u3057\u305fContainer Instance\u304cAuto Scaling\u3067\u7ba1\u7406\u3055\u308c\u3066\u3044\u308bECS\u306e\u30af\u30e9\u30b9\u30bf\u30fc\u3092\u4f5c\u6210\u3059\u308b\u3002\nDocker Container\u3067\u7a3c\u50cd\u3059\u308bWeb\u30b5\u30fc\u30d3\u30b9\u306b\u5411\u3051\u305f\u653b\u6483\u901a\u4fe1\u3092Deep Security\u304c\u691c\u77e5\u3059\u308b\u3002\n\n\u69cb\u6210\u306f\u3053\u3093\u306a\u611f\u3058\u3067\u3059\u3002\n\n\n\u5de5\u7a0b\n\nCloudFormation\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u3092\u7528\u610f\u3059\u308b\u3002\nCloudFormation\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u3092\u5b9f\u884c\u3059\u308b\u3002\nTask Definitions\u3092\u8a2d\u5b9a\u3059\u308b\nDocker Container\u3067\u7a3c\u50cd\u3059\u308bWeb\u30b5\u30fc\u30d3\u30b9\u306b\u5411\u3051\u305f\u7591\u4f3c\u653b\u6483\u901a\u4fe1\u3092\u9001\u4fe1\u3059\u308b\u3002\n\n\n1. CloudFormation\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u3092\u7528\u610f\u3059\u308b\u3002\n\u4eca\u56de\u306f\u3001suz-lab - blog:CloudFormation\u3067\"Container Instance\"\u304c\"Auto Scaling\"\u3067\u7ba1\u7406\u3055\u308c\u3066\u3044\u308bECS\u306e\u30af\u30e9\u30b9\u30bf\u30fc\u3092\u4f5c\u6210\u3057\u3066\u307f\u305f\u3067\u516c\u958b\u3055\u308c\u3066\u3044\u308bCloudFormation\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u3092\u30d9\u30fc\u30b9\u306b\u3001UserData\u306bDeep Security Agent\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb/\u6709\u52b9\u5316\u3059\u308b\u30b3\u30de\u30f3\u30c9\u3092\u8ffd\u52a0\u3057\u307e\u3059\u3002\n\nCloudFormation\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\n\u3053\u3061\u3089\u306b\u4e0a\u3052\u3066\u304a\u304d\u307e\u3057\u305f\u3002\nDeep Security\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb/\u6709\u52b9\u5316\u306e\u305f\u3081\u306b\u5909\u66f4\u3057\u305f\u30dd\u30a4\u30f3\u30c8\u306f\u4ee5\u4e0b\u3067\u3059\u3002\n\nwget\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\nDeep Security Agent\u6709\u52b9\u5316\u6642\u306bpolicy\u304c\u9069\u7528\u3055\u308c\u307e\u3059\u304c\u3001\u30e2\u30b8\u30e5\u30fc\u30eb\u5c0e\u5165\u306e\u6642\u9593\u3092\u8003\u616e\u3057\u3066\u3001\u30cf\u30fc\u30c8\u30d3\u30fc\u30c8\u30b3\u30de\u30f3\u30c9\u306e\u5b9f\u884c\u3068\u5f85\u3061\u6642\u9593\u3092\u5165\u308c\u3066\u3044\u307e\u3059\u3002\n\u4eca\u56de\u306fUserData\u3092\u7528\u3044\u307e\u3057\u305f\u304c\u3001\u5b9f\u88c5\u306b\u5fdc\u3058\u3066CloudInit\u3092\u7528\u3044\u308b\u7b49\u691c\u8a0e\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\u4f7f\u7528\u3059\u308b\u306b\u306f\u3001dsm-ipaddress \u3068 policyid:XX\u3092\u5b9f\u969b\u306e\u5024\u306b\u7f6e\u304d\u63db\u3048\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\n                \"UserData\": { \"Fn::Base64\": { \"Fn::Join\" : [ \"\\n\", [\n                    \"#!/bin/bash\",\n                    \"yum install -y wget\",\n                    \"wget https://dsm-ipaddress.194:4119/software/agent/amzn1/x86_64/ -O /tmp/agent.rpm --no-check-certificate --quiet\",\n                    \"rpm -ihv /tmp/agent.rpm\",\n                    \"sleep 10\",\n                    \"/opt/ds_agent/dsa_control -a dsm://dsm-ipaddress:4120/ \\\"policyid:XX\\\"\",\n                    \"sleep 10\",\n                    \"/opt/ds_agent/dsa_control -m\",\n                    \"sleep 10\",\n                    \"/opt/ds_agent/dsa_control -m\",\n                    \"sleep 10\",\n                    \"yum -y update\",\n                    \"grubby --default-kernel | grep `uname -r` || reboot\",\n                    { \"Fn::Join\" : [ \"\", [\n                        \"echo ECS_CLUSTER=\",\n                        { \"Ref\": \"Cluster\" },\n                        \" >> /etc/ecs/ecs.config\"\n                    ] ] }\n                ] ] } }\n\n\n\n2. CloudFormation\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u3092\u5b9f\u884c\u3059\u308b\u3002\n\u5148\u306e\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u3067Create Stack\u3092\u5b9f\u884c\u3057\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\n\u4ee5\u4e0b\u306e\u3088\u3046\u306bECS\u30af\u30e9\u30b9\u30bf\u304c\u4f5c\u6210\u3055\u308c\u307e\u3059\u3002\n(\u3053\u306e\u6642\u70b9\u3067\u306f\u3001Running tasks\u306f0\u3067\u3059\u3002)\n\n\u3053\u306e\u6642\u70b9\u3067\u3001Deep Security Manager\u30672\u3064\u306e\u30b3\u30f3\u30d4\u30e5\u30fc\u30bf\u304c\u6709\u52b9\u5316\u3055\u308c\u3066\u307e\u3059\u306d\u3002\n\n\u30dd\u30ea\u30b7\u30fc\u306e\u4e2d\u8eab\u306f\u3053\u3093\u306a\u611f\u3058\u3067\u3059\u3002\n\u4eca\u56de\u306f\u3001\u8a66\u9a13\u901a\u4fe1\u3068\u3057\u3066SQL Injection\u3092\u7528\u3044\u308b\u306e\u3067\u3001SQL Injection\u7528\u306e\u30eb\u30fc\u30eb\u3092\u9069\u7528\u3057\u307e\u3057\u305f\u3002\n\n\n3. Task Definitions\u3092\u8a2d\u5b9a\u3059\u308b\n\u6b21\u306bContainer Instance\u3067\u7a3c\u50cd\u3059\u308bWeb\u30b5\u30fc\u30d3\u30b9\u3092\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\u4eca\u56de\u306f\u3001http\u30ea\u30af\u30a8\u30b9\u30c8\u3092\u53d7\u3051\u3089\u308c\u308b\u3088\u3046\u3001apache\u304c\u7a3c\u50cd\u3059\u308bContainer\u3092\u8a2d\u5b9a\u3057\u307e\u3059\u3002\nTask Definitions\u304b\u3089\u3001 Create new Task Definition \u3092\u9078\u629e\u3057\u307e\u3059\n\nTask Definition\u540d\u3092\u5165\u529b\u3057\u3066\u3001 Add container \u3092\u9078\u629e\u3057\u307e\u3059\u3002\n\n\u53c2\u8003\u60c5\u5831\uff1aAmazon EC2 Container Service:Developer Guide: Getting Started with Amazon ECS\u3092\u53c2\u8003\u306b\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\n\u4f5c\u6210\u3057\u305fTask Definition\u3092ECS\u30af\u30e9\u30b9\u30bf\u306b\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\u4f5c\u6210\u3057\u305fTask Definition\u753b\u9762\u306b\u3066Run Task\u3092\u9078\u629e\u3057\u3001\u2192\n\n\u2192 \u5b9f\u884c\u3055\u305b\u308bECS\u30af\u30e9\u30b9\u30bf\u3092\u9078\u629e\u3057\u307e\u3059\u3002\n\n\u3059\u308b\u3068\u3001ECS\u30af\u30e9\u30b9\u30bf\u306e\u30b9\u30c6\u30fc\u30bf\u30b9\u304c\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u5909\u308f\u308a\u307e\u3059\u3002\n\n\u30dd\u30fc\u30c880\u3067\u5f85\u53d7\u3092\u958b\u59cb\u3057\u3066\u307e\u3059\u306d\u3002\n# netstat -luntp\nActive Internet connections (only servers)\nProto Recv-Q Send-Q Local Address               Foreign Address             State       PID/Program name\n:\ntcp        0      0 127.0.0.1:51678             0.0.0.0:*                   LISTEN      2494/docker-proxy\ntcp        0      0 :::80                       :::*                        LISTEN      2795/docker-proxy\ntcp        0      0 :::4118                     :::*                        LISTEN      1969/ds_agent\n:\n\n\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3068\u3053\u3093\u306a\u611f\u3058\u3067\u3059\u3002\n\n\n4. Docker Container\u3067\u7a3c\u50cd\u3059\u308bWeb\u30b5\u30fc\u30d3\u30b9\u306b\u5411\u3051\u305f\u7591\u4f3c\u653b\u6483\u901a\u4fe1\u3092\u9001\u4fe1\u3059\u308b\u3002\n\u3053\u3093\u306a\u30ea\u30af\u30a8\u30b9\u30c8\u3092\u6295\u3052\u3066\u307f\u307e\u3059\u3002\n\n\u691c\u77e5\u3057\u307e\u3057\u305f\u3002\n\n\n2016\u5e744\u67088\u65e5\u8ffd\u88dc\ndocker\u306f\u3001\u30db\u30b9\u30c8\u3068Container\u9593\u306e\u901a\u4fe1\u3092iptables\u3067nat\u3059\u308b\u305f\u3081\u3001\u6697\u9ed9\u7684\u306biptables\u3092\u4f7f\u7528\u3057\u307e\u3059\u3002\nDeep Security Agent\u306f\u3001\u8d77\u52d5\u6642\u306biptables\u3092\u505c\u6b62\u3059\u308b\u306e\u3067\u3001\u4e8b\u524d\u306biptables\u306b\u5f71\u97ff\u3092\u53ca\u307c\u3055\u306a\u3044\u63aa\u7f6e\u3092\u53d6\u3063\u3066\u304a\u304f\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\u53c2\u8003\u8a18\u4e8b\nNAT\u30b5\u30fc\u30d0\u306bDSA\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b(Deep Security 9.5 / DSaaS)\n\n\u6700\u5f8c\u306b\ndocker\u30b3\u30f3\u30c6\u30ca\u306bDeep Security\u3092\u5c0e\u5165\u3059\u308b\u3053\u3068\u306f\u3067\u304d\u307e\u305b\u3093\u304c\u3001Container Instance\u306eNetwork Interface\u3067Deep Security\u304c\u691c\u67fb\u3059\u308b\u3053\u3068\u306f\u3067\u304d\u307e\u3059\u3002\n\u5b9f\u88c5\u3059\u308b\u969b\u306f\u3001\u30dd\u30ea\u30b7\u30fc\u306bContainer\u5185\u3067\u4f7f\u7528\u3055\u308c\u3066\u3044\u308b\u30df\u30c9\u30eb\u30a6\u30a7\u30a2\u306b\u5bfe\u5fdc\u3057\u305f\u30eb\u30fc\u30eb\u3092\u8a2d\u5b9a\u3059\u308b\u3088\u3046\u6ce8\u610f\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n\u3053\u3093\u306b\u3061\u306f\u3001\u3072\u308d\u304b\u305a\u3067\u3059\u3002\nDocker\u30b3\u30f3\u30c6\u30ca\u304c\u7a3c\u50cd\u3059\u308bContainer Instance\u306bDeep Security Agent\u3092\u5c0e\u5165\u3059\u308b\u9700\u8981\u304c\u3042\u308b\u306e\u3067\u3001\u4e00\u7b46\u66f8\u304d\u307e\u3059\u3002\n\n###2016\u5e744\u67088\u65e5\u8ffd\u88dc\ndocker\u306f\u3001\u30db\u30b9\u30c8\u3068Container\u9593\u306e\u901a\u4fe1\u3092iptables\u3067nat\u3059\u308b\u305f\u3081\u3001\u6697\u9ed9\u7684\u306biptables\u3092\u4f7f\u7528\u3057\u307e\u3059\u3002\nDeep Security Agent\u306f\u3001\u8d77\u52d5\u6642\u306biptables\u3092\u505c\u6b62\u3059\u308b\u306e\u3067\u3001\u4e8b\u524d\u306biptables\u306b\u5f71\u97ff\u3092\u53ca\u307c\u3055\u306a\u3044\u63aa\u7f6e\u3092\u53d6\u3063\u3066\u304a\u304f\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\u53c2\u8003\u8a18\u4e8b\n[NAT\u30b5\u30fc\u30d0\u306bDSA\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b(Deep Security 9.5 / DSaaS)](http://qiita.com/fnifni/items/922fb8ee153f755da5bc)\n\n#\u524d\u63d0\n- Deep Security Manager 9.6\u3001\u307e\u305f\u306fDSaaS\u306e\u5c0e\u5165\u304c\u5b8c\u4e86\u3057\u3066\u3044\u308b\u3053\u3068\u3002\n- \u30e9\u30a4\u30bb\u30f3\u30b9\u3092\u6295\u5165\u3057\u3066\u3044\u308b\u3053\u3068\u3002\n- Container Instance\u3092\u914d\u7f6e\u3059\u308bVPC, Subnet, SecurityGroup\u304c\u5b58\u5728\u3059\u308b\u3053\u3068\u3002\n- Container Instance\u3092\u914d\u7f6e\u3059\u308bAWS\u30a2\u30ab\u30a6\u30f3\u30c8\u306e\u30af\u30e9\u30a6\u30c9\u30a2\u30ab\u30a6\u30f3\u30c8\u304c\u767b\u9332\u6e08\u307f\u3067\u3042\u308b\u3053\u3068\u3002(\u53c2\u7167:[Auto Scale\u3057\u305f\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092Deep Security\u3067\u7ba1\u7406\u3059\u308b](http://qiita.com/fnifni/items/6226354354db3f3587f8))\n\n#\u53c2\u7167\u60c5\u5831\n- [Amazon EC2 Container Service:\u3088\u304f\u3042\u308b\u8cea\u554f:\u30bb\u30ad\u30e5\u30ea\u30c6\u30a3](https://aws.amazon.com/jp/ecs/faqs/#security)\n- [Amazon EC2 Container Service:Developer Guide: Getting Started with Amazon ECS](http://docs.aws.amazon.com/ja_jp/AmazonECS/latest/developerguide/ECS_GetStarted.html)\n- [suz-lab - blog:CloudFormation\u3067\"Container Instance\"\u304c\"Auto Scaling\"\u3067\u7ba1\u7406\u3055\u308c\u3066\u3044\u308bECS\u306e\u30af\u30e9\u30b9\u30bf\u30fc\u3092\u4f5c\u6210\u3057\u3066\u307f\u305f](http://blog.suz-lab.com/2015/06/cloudformationcontainer-instanceauto.html)\n\n#\u76ee\u7684\u3068\u30b4\u30fc\u30eb\n- CloudFormation\u3067\u8d77\u52d5\u6642\u306bDeep Security Agent\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb/\u6709\u52b9\u5316\u3057\u305fContainer Instance\u304cAuto Scaling\u3067\u7ba1\u7406\u3055\u308c\u3066\u3044\u308bECS\u306e\u30af\u30e9\u30b9\u30bf\u30fc\u3092\u4f5c\u6210\u3059\u308b\u3002\n- Docker Container\u3067\u7a3c\u50cd\u3059\u308bWeb\u30b5\u30fc\u30d3\u30b9\u306b\u5411\u3051\u305f\u653b\u6483\u901a\u4fe1\u3092Deep Security\u304c\u691c\u77e5\u3059\u308b\u3002\n\n\u69cb\u6210\u306f\u3053\u3093\u306a\u611f\u3058\u3067\u3059\u3002\n![\u69cb\u6210\u4f8b.png](https://qiita-image-store.s3.amazonaws.com/0/46611/8cb142d7-2e5c-611c-2be7-f93d2640cda1.png \"\u69cb\u6210\u4f8b.png\")\n\n#\u5de5\u7a0b\n1. CloudFormation\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u3092\u7528\u610f\u3059\u308b\u3002\n2. CloudFormation\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u3092\u5b9f\u884c\u3059\u308b\u3002\n3. Task Definitions\u3092\u8a2d\u5b9a\u3059\u308b\n4. Docker Container\u3067\u7a3c\u50cd\u3059\u308bWeb\u30b5\u30fc\u30d3\u30b9\u306b\u5411\u3051\u305f\u7591\u4f3c\u653b\u6483\u901a\u4fe1\u3092\u9001\u4fe1\u3059\u308b\u3002\n\n#1. CloudFormation\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u3092\u7528\u610f\u3059\u308b\u3002\n\u4eca\u56de\u306f\u3001[suz-lab - blog:CloudFormation\u3067\"Container Instance\"\u304c\"Auto Scaling\"\u3067\u7ba1\u7406\u3055\u308c\u3066\u3044\u308bECS\u306e\u30af\u30e9\u30b9\u30bf\u30fc\u3092\u4f5c\u6210\u3057\u3066\u307f\u305f](http://blog.suz-lab.com/2015/06/cloudformationcontainer-instanceauto.html)\u3067\u516c\u958b\u3055\u308c\u3066\u3044\u308bCloudFormation\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u3092\u30d9\u30fc\u30b9\u306b\u3001UserData\u306bDeep Security Agent\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb/\u6709\u52b9\u5316\u3059\u308b\u30b3\u30de\u30f3\u30c9\u3092\u8ffd\u52a0\u3057\u307e\u3059\u3002\n##CloudFormation\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\n[\u3053\u3061\u3089](https://github.com/fnifni/deepsecurity/blob/master/cfn-ecs-ds-tmp.json)\u306b\u4e0a\u3052\u3066\u304a\u304d\u307e\u3057\u305f\u3002\n\nDeep Security\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb/\u6709\u52b9\u5316\u306e\u305f\u3081\u306b\u5909\u66f4\u3057\u305f\u30dd\u30a4\u30f3\u30c8\u306f\u4ee5\u4e0b\u3067\u3059\u3002\n\n- wget\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n- Deep Security Agent\u6709\u52b9\u5316\u6642\u306bpolicy\u304c\u9069\u7528\u3055\u308c\u307e\u3059\u304c\u3001\u30e2\u30b8\u30e5\u30fc\u30eb\u5c0e\u5165\u306e\u6642\u9593\u3092\u8003\u616e\u3057\u3066\u3001\u30cf\u30fc\u30c8\u30d3\u30fc\u30c8\u30b3\u30de\u30f3\u30c9\u306e\u5b9f\u884c\u3068\u5f85\u3061\u6642\u9593\u3092\u5165\u308c\u3066\u3044\u307e\u3059\u3002\n- \u4eca\u56de\u306fUserData\u3092\u7528\u3044\u307e\u3057\u305f\u304c\u3001\u5b9f\u88c5\u306b\u5fdc\u3058\u3066CloudInit\u3092\u7528\u3044\u308b\u7b49\u691c\u8a0e\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n- \u4f7f\u7528\u3059\u308b\u306b\u306f\u3001`dsm-ipaddress` \u3068 `policyid:XX`\u3092\u5b9f\u969b\u306e\u5024\u306b\u7f6e\u304d\u63db\u3048\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\n```\n                \"UserData\": { \"Fn::Base64\": { \"Fn::Join\" : [ \"\\n\", [\n                    \"#!/bin/bash\",\n                    \"yum install -y wget\",\n                    \"wget https://dsm-ipaddress.194:4119/software/agent/amzn1/x86_64/ -O /tmp/agent.rpm --no-check-certificate --quiet\",\n                    \"rpm -ihv /tmp/agent.rpm\",\n                    \"sleep 10\",\n                    \"/opt/ds_agent/dsa_control -a dsm://dsm-ipaddress:4120/ \\\"policyid:XX\\\"\",\n                    \"sleep 10\",\n                    \"/opt/ds_agent/dsa_control -m\",\n                    \"sleep 10\",\n                    \"/opt/ds_agent/dsa_control -m\",\n                    \"sleep 10\",\n                    \"yum -y update\",\n                    \"grubby --default-kernel | grep `uname -r` || reboot\",\n                    { \"Fn::Join\" : [ \"\", [\n                        \"echo ECS_CLUSTER=\",\n                        { \"Ref\": \"Cluster\" },\n                        \" >> /etc/ecs/ecs.config\"\n                    ] ] }\n                ] ] } }\n\n```\n\n#2. CloudFormation\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u3092\u5b9f\u884c\u3059\u308b\u3002\n\u5148\u306e\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u3067Create Stack\u3092\u5b9f\u884c\u3057\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n![1_Create_Stack.png](https://qiita-image-store.s3.amazonaws.com/0/46611/29aef97d-08ae-c30b-0974-0dcd8bd72624.png \"1_Create_Stack.png\")\n\n\u4ee5\u4e0b\u306e\u3088\u3046\u306bECS\u30af\u30e9\u30b9\u30bf\u304c\u4f5c\u6210\u3055\u308c\u307e\u3059\u3002\n(\u3053\u306e\u6642\u70b9\u3067\u306f\u3001Running tasks\u306f0\u3067\u3059\u3002)\n![2_ECS_cluster.png](https://qiita-image-store.s3.amazonaws.com/0/46611/8d843d1a-5b41-3dd2-d727-10bb60c5e97a.png \"2_ECS_cluster.png\")\n\n\u3053\u306e\u6642\u70b9\u3067\u3001Deep Security Manager\u30672\u3064\u306e\u30b3\u30f3\u30d4\u30e5\u30fc\u30bf\u304c\u6709\u52b9\u5316\u3055\u308c\u3066\u307e\u3059\u306d\u3002\n![9_DSM.png](https://qiita-image-store.s3.amazonaws.com/0/46611/3b7f4bd9-c426-c6f1-0b8b-547911070fcb.png \"9_DSM.png\")\n\n\u30dd\u30ea\u30b7\u30fc\u306e\u4e2d\u8eab\u306f\u3053\u3093\u306a\u611f\u3058\u3067\u3059\u3002\n\u4eca\u56de\u306f\u3001\u8a66\u9a13\u901a\u4fe1\u3068\u3057\u3066SQL Injection\u3092\u7528\u3044\u308b\u306e\u3067\u3001SQL Injection\u7528\u306e\u30eb\u30fc\u30eb\u3092\u9069\u7528\u3057\u307e\u3057\u305f\u3002\n![10_test_policy.png](https://qiita-image-store.s3.amazonaws.com/0/46611/7cda1167-621c-2c50-62ef-6eb8d3c232b9.png \"10_test_policy.png\")\n\n\n#3. Task Definitions\u3092\u8a2d\u5b9a\u3059\u308b\n\u6b21\u306bContainer Instance\u3067\u7a3c\u50cd\u3059\u308bWeb\u30b5\u30fc\u30d3\u30b9\u3092\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\u4eca\u56de\u306f\u3001http\u30ea\u30af\u30a8\u30b9\u30c8\u3092\u53d7\u3051\u3089\u308c\u308b\u3088\u3046\u3001apache\u304c\u7a3c\u50cd\u3059\u308bContainer\u3092\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\nTask Definitions\u304b\u3089\u3001 `Create new Task Definition` \u3092\u9078\u629e\u3057\u307e\u3059\n![3_create_task.png](https://qiita-image-store.s3.amazonaws.com/0/46611/1736c87c-d506-8809-5c8d-151fa7ad72c6.png \"3_create_task.png\")\n\nTask Definition\u540d\u3092\u5165\u529b\u3057\u3066\u3001 `Add container` \u3092\u9078\u629e\u3057\u307e\u3059\u3002\n![4_Add_container.png](https://qiita-image-store.s3.amazonaws.com/0/46611/e58e3691-3b04-acc5-0677-89af2acef5ba.png \"4_Add_container.png\")\n\n[\u53c2\u8003\u60c5\u5831\uff1aAmazon EC2 Container Service:Developer Guide: Getting Started with Amazon ECS](http://docs.aws.amazon.com/ja_jp/AmazonECS/latest/developerguide/ECS_GetStarted.html)\u3092\u53c2\u8003\u306b\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n![5_add_container.png](https://qiita-image-store.s3.amazonaws.com/0/46611/22d27791-345f-aa27-3c8e-e9cbf3c26074.png \"5_add_container.png\")\n\n\u4f5c\u6210\u3057\u305fTask Definition\u3092ECS\u30af\u30e9\u30b9\u30bf\u306b\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\u4f5c\u6210\u3057\u305fTask Definition\u753b\u9762\u306b\u3066Run Task\u3092\u9078\u629e\u3057\u3001\u2192\n![6_Run_task.png](https://qiita-image-store.s3.amazonaws.com/0/46611/6a404f77-678b-47a8-dbec-13330fdfff61.png \"6_Run_task.png\")\n\u2192 \u5b9f\u884c\u3055\u305b\u308bECS\u30af\u30e9\u30b9\u30bf\u3092\u9078\u629e\u3057\u307e\u3059\u3002\n![7_Run_task.png](https://qiita-image-store.s3.amazonaws.com/0/46611/20f9ea5e-92d7-a5f9-a390-7ce428fbd5d5.png \"7_Run_task.png\")\n\n\u3059\u308b\u3068\u3001ECS\u30af\u30e9\u30b9\u30bf\u306e\u30b9\u30c6\u30fc\u30bf\u30b9\u304c\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u5909\u308f\u308a\u307e\u3059\u3002\n![8_ECS_cluster.png](https://qiita-image-store.s3.amazonaws.com/0/46611/5adcc8ad-95a9-3f7b-82c6-3d90d6f74f86.png \"8_ECS_cluster.png\")\n\n\u30dd\u30fc\u30c880\u3067\u5f85\u53d7\u3092\u958b\u59cb\u3057\u3066\u307e\u3059\u306d\u3002\n\n```\n# netstat -luntp\nActive Internet connections (only servers)\nProto Recv-Q Send-Q Local Address               Foreign Address             State       PID/Program name\n:\ntcp        0      0 127.0.0.1:51678             0.0.0.0:*                   LISTEN      2494/docker-proxy\ntcp        0      0 :::80                       :::*                        LISTEN      2795/docker-proxy\ntcp        0      0 :::4118                     :::*                        LISTEN      1969/ds_agent\n:\n```\n\n\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3068\u3053\u3093\u306a\u611f\u3058\u3067\u3059\u3002\n![11_http.png](https://qiita-image-store.s3.amazonaws.com/0/46611/d421b0a0-f1ae-92c3-ee28-30a582ab26fe.png \"11_http.png\")\n\n\n#4. Docker Container\u3067\u7a3c\u50cd\u3059\u308bWeb\u30b5\u30fc\u30d3\u30b9\u306b\u5411\u3051\u305f\u7591\u4f3c\u653b\u6483\u901a\u4fe1\u3092\u9001\u4fe1\u3059\u308b\u3002\n\u3053\u3093\u306a\u30ea\u30af\u30a8\u30b9\u30c8\u3092\u6295\u3052\u3066\u307f\u307e\u3059\u3002\n![12_http_attack.png](https://qiita-image-store.s3.amazonaws.com/0/46611/5786e3ea-df28-cd49-c019-2893b8a1ead7.png \"12_http_attack.png\")\n\n\u691c\u77e5\u3057\u307e\u3057\u305f\u3002\n![13_detect.png](https://qiita-image-store.s3.amazonaws.com/0/46611/4c0abbea-11ed-33f8-7a4a-ba109df57776.png \"13_detect.png\")\n\n###2016\u5e744\u67088\u65e5\u8ffd\u88dc\ndocker\u306f\u3001\u30db\u30b9\u30c8\u3068Container\u9593\u306e\u901a\u4fe1\u3092iptables\u3067nat\u3059\u308b\u305f\u3081\u3001\u6697\u9ed9\u7684\u306biptables\u3092\u4f7f\u7528\u3057\u307e\u3059\u3002\nDeep Security Agent\u306f\u3001\u8d77\u52d5\u6642\u306biptables\u3092\u505c\u6b62\u3059\u308b\u306e\u3067\u3001\u4e8b\u524d\u306biptables\u306b\u5f71\u97ff\u3092\u53ca\u307c\u3055\u306a\u3044\u63aa\u7f6e\u3092\u53d6\u3063\u3066\u304a\u304f\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\u53c2\u8003\u8a18\u4e8b\n[NAT\u30b5\u30fc\u30d0\u306bDSA\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b(Deep Security 9.5 / DSaaS)](http://qiita.com/fnifni/items/922fb8ee153f755da5bc)\n\n#\u6700\u5f8c\u306b\ndocker\u30b3\u30f3\u30c6\u30ca\u306bDeep Security\u3092\u5c0e\u5165\u3059\u308b\u3053\u3068\u306f\u3067\u304d\u307e\u305b\u3093\u304c\u3001Container Instance\u306eNetwork Interface\u3067Deep Security\u304c\u691c\u67fb\u3059\u308b\u3053\u3068\u306f\u3067\u304d\u307e\u3059\u3002\n\u5b9f\u88c5\u3059\u308b\u969b\u306f\u3001\u30dd\u30ea\u30b7\u30fc\u306bContainer\u5185\u3067\u4f7f\u7528\u3055\u308c\u3066\u3044\u308b\u30df\u30c9\u30eb\u30a6\u30a7\u30a2\u306b\u5bfe\u5fdc\u3057\u305f\u30eb\u30fc\u30eb\u3092\u8a2d\u5b9a\u3059\u308b\u3088\u3046\u6ce8\u610f\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n", "tags": ["DeepSecurity", "autoscale", "AWS", "ECS"]}