{"context": " More than 1 year has passed since last update.\n\nfluentd\u3092\u4f7f\u3046\u6642\u306b\u307e\u305a\u77e5\u3063\u3066\u304a\u3044\u305f\u307b\u3046\u304c\u3088\u3055\u305d\u3046\u306a\u3053\u3068\n\n\u306f\u3058\u3081\u306b\n\n\u671d\u304b\u3089Elasticsearch\u3078\u306e\u30c7\u30fc\u30bf\u306e\u6295\u3052\u8fbc\u307f\u65b9\u3092\u8003\u3048\u3066\u3044\u307e\u3057\u305f\u3002\n\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u3084\u30e1\u30c3\u30bb\u30fc\u30b8\u30ad\u30e5\u30fc\u306a\u3069\u306b\u30c7\u30fc\u30bf\u3092\u6295\u3052\u8fbc\u3093\u3067\u304a\u3044\u3066\u3001\u30cb\u30a2\u30ea\u30a2\u30eb\u306a\u30d0\u30c3\u30c1\u3067Elasticsearch\u306b\u6295\u3052\u8fbc\u3080\u3088\u308a\u3082\u3001fluentd\u3092\u4f7f\u3046\u65b9\u304c\u5727\u5012\u7684\u306b\u7c21\u5358\u3067\u4fe1\u983c\u6027\u304c\u9ad8\u3044\u3082\u306e\u304c\u3067\u304d\u307e\u3059\u306d\u3002\u81ea\u5206\u3067\u4f5c\u308a\u3053\u3080\u306e\u304c\u30d0\u30ab\u3089\u3057\u304f\u306a\u308a\u307e\u3059\u306d\u3002\n\u3068\u3044\u3046\u3053\u3068\u3067\u3001fluentd\u5229\u7528\u6642\u306b\u6c17\u3092\u4ed8\u3051\u3066\u304a\u304d\u305f\u3044\u3053\u3068\u306b\u3064\u3044\u3066\u8abf\u3079\u3066\u307f\u307e\u3057\u305f\u3002\u5185\u5bb9\u306f\u516c\u5f0f\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u306e\u5185\u5bb9\u3092\u30d9\u30fc\u30b9\u306b\u81ea\u8eab\u3067\u8abf\u3079\u305f\u3053\u3068\u3092\u8ffd\u8a18\u3057\u3066\u3044\u307e\u3059\u3002\u516c\u5f0f\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u3078\u306e\u30ea\u30f3\u30af\u3082\u8cbc\u3063\u3066\u3042\u308a\u307e\u3059\u306e\u3067\u9069\u5b9c\u305d\u3061\u3089\u3092\u3054\u89a7\u3044\u305f\u3060\u3051\u308c\u3070\u3068\u3002\n\n\n\n\u74b0\u5883\n\nCentOS6.7\ntd-agent 0.12.19\nRuby2.2.2\uff08\u30ea\u30b9\u30c8\u30a2\u30b9\u30af\u30ea\u30d7\u30c8\u3067\u5229\u7528\uff09\nFluent-Logger(0.5.1)\nElasticsearch2.1.1\n\n\n\nfluentd vs logstash\n\nFluentd vs. Logstash: A Comparison of Log Collectors\nFluentd vs Logstash\nFluentd\u306e\u73fe\u5b9f\u88c5\u306ePros/Cons\n\u3053\u308c\u7d50\u69cb\u60a9\u307f\u307e\u3059\u3088\u306d\u3002\n\u79c1\u304c\u3084\u308a\u305f\u304b\u3063\u305f\u3053\u3068\u306fSQS\u3068Elasticsesarch,S3\u306b\u30c7\u30fc\u30bf\u3092\u6d41\u3057\u8fbc\u3081\u308c\u3070\u826f\u304b\u3063\u305f\u306e\u3067\u3059\u304c\u3001\u4e21\u8005\u3068\u3082\u30d7\u30e9\u30b0\u30a4\u30f3\u306f\u516c\u958b\u3055\u308c\u3066\u3044\u307e\u3057\u305f\u3002\u307e\u305f\u3001\u305d\u308c\u4ee5\u5916\u306e\u30d7\u30e9\u30b0\u30a4\u30f3\u3082\u305f\u304f\u3055\u3093\u3042\u308b\u3088\u3046\u3067\u3057\u3066\u3001\u30d7\u30e9\u30b0\u30a4\u30f3\u306e\u6570\u306a\u3069\u306f\u7532\u4e59\u4ed8\u3051\u96e3\u3044\u3002\n\u69cb\u6210\u9762\u3067\u8a00\u3046\u3068Active-Standby\u69cb\u6210\u306f\u3069\u3061\u3089\u3082\u53d6\u308c\u307e\u3059\u306e\u3067\u3001\u79c1\u304c\u6e80\u305f\u3057\u305f\u3044\u8981\u4ef6\u306f\u63c3\u3063\u3066\u3044\u308b\u3088\u3046\u306b\u601d\u3048\u307e\u3057\u305f\u3002\n\u7d50\u5c40\u89e6\u3063\u3066\u307f\u305f\u7d50\u679c\u3001\u30d0\u30c3\u30d5\u30a1\u30ea\u30f3\u30b0\u6a5f\u80fd\u3068\u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b9\u6a5f\u80fd\u306e\u90e8\u5206\u306e\u5dee\u3067fluentd\u3092\u4f7f\u3046\u3053\u3068\u306b\u3057\u307e\u3057\u305f\u3002\n\n\nfluentd\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n\n\u3044\u3064\u3082\u901a\u308aansible playbook\u306b\u304a\u3068\u3057\u3066\u3042\u308a\u307e\u3059\u3002 - ansible-td-agent\n\n\n\nNTP\n\n\u5f53\u7136\u3067\u3059\u3051\u3069\u8a2d\u5b9a\u3057\u3066\u304a\u304d\u307e\u3057\u3087\u3046\u3002\u30ed\u30b0\u3067\u30bf\u30a4\u30e0\u30b9\u30bf\u30f3\u30d7\u30ba\u30ec\u306f\u8a71\u306b\u306a\u3089\u306a\u3044\u306e\u3067\u3002\n\n\nFile Descriptors\n\nFile Descriptors\u304c\u8db3\u308a\u306a\u304f\u306a\u308b\u6050\u308c\u304c\u3042\u308b\u306e\u3067\u5897\u3084\u3057\u3066\u304a\u304f\u3002\u305f\u3060\u3057\u3001\u6700\u65b0\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u3060\u3068\u8d77\u52d5\u30b9\u30af\u30ea\u30d7\u30c8\u5185\u306b\u4ee5\u4e0b\u306e\u8a18\u8ff0\u304c\u3042\u308b\u305f\u3081\u7279\u306b\u8a2d\u5b9a\u306f\u4e0d\u8981\n\nulimit -n 65536 1>/dev/null 2>&1 || true\n\n\n\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u30ab\u30fc\u30cd\u30eb\u30d1\u30e9\u30e1\u30fc\u30bf\u306e\u5909\u66f4\n\n\u30de\u30cb\u30e5\u30a2\u30eb\u306b\u306fTCP_WAIT\u304c\u554f\u984c\u306b\u306a\u3063\u3066\u3044\u308b\u5834\u5408\u306f\u8a2d\u5b9a\u3057\u306a\u3055\u3044\u3068\u3044\u3046\u6ce8\u610f\u66f8\u304d\u304c\u3042\u308b\u3002\n\u30bd\u30b1\u30c3\u30c8\u306e\u518d\u5229\u7528\u8a2d\u5b9a\u3092\u884c\u3044\u52b9\u7387\u7684\u306b\u901a\u4fe1\u3059\u308b\u8a2d\u5b9a\u3084\u30ed\u30fc\u30ab\u30eb\u30dd\u30fc\u30c8\u304c\u67af\u6e07\u3059\u308b\u3088\u3046\u306a\u5834\u5408\u306b\u5099\u3048\u3066\u30ec\u30f3\u30b8\u3092\u5897\u3084\u3057\u3066\u3044\u308b\u3002\u53cd\u6620\u306f\u518d\u8d77\u52d5\u304b\u3001sysctl -w\u3002\n\n\n/etc/sysctl.conf\nnet.ipv4.tcp_tw_recycle = 1\nnet.ipv4.tcp_tw_reuse = 1\nnet.ipv4.ip_local_port_range = 10240    65535\n\n\n\n\u76e3\u8996 - Monitoring Fluentd\n\n\nmonitor_agent\n\n\nplugin\u306e\u72b6\u614b\u306e\u76e3\u8996\u304c\u53ef\u80fd\u3067\u3059\u3002buffer_queue_length\u3068\u304bbuffer_total_queued_size\u3068\u304b\u308f\u304b\u308b\u306e\u306f\u3042\u308a\u304c\u305f\u3044\u3067\u3059\u306d\u3002\u8a2d\u5b9a\u306ftd-agent.conf\u306b\u4ee5\u4e0b\u3092\u8ffd\u8a18\u3057\u3066\u518d\u8d77\u52d5\u3059\u308b\u3060\u3051\u3002\n\n\n/etc/td-agent/td-agent.conf\n<source>\n  @type monitor_agent\n  bind 0.0.0.0\n  port 24220\n</source>\n\n\n\nhttp\u306e\u30dd\u30fc\u30c8\u304clisten\u3059\u308b\u306e\u3067\u76e3\u8996\u30b5\u30fc\u30d3\u30b9\u304b\u3089\u306ehttp\u76e3\u8996\u3068\u3057\u3066\u5229\u7528\u3057\u3066\u3082\u826f\u3044\u3068\u601d\u308f\u308c\u307e\u3059\u3002\ncurl\u3067\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3053\u3068\u306b\u3088\u3063\u3066plugin\u306e\u60c5\u5831\u304c\u62bd\u51fa\u3067\u304d\u307e\u3059\u3002.json\u3092\u4ed8\u3051\u306a\u3044\u3068tsv\u5f62\u5f0f\u3067\u62bd\u51fa\u53ef\u80fd\u3067\u3059\u3002\n\n[root@es1 restore]# curl -s http://localhost:24220/api/plugins.json | jq .\n{\n  \"plugins\": [\n\u30fb\u30fb\u30fb\u30fb\n    {\n      \"retry_count\": 0,\n      \"buffer_total_queued_size\": 0,\n      \"buffer_queue_length\": 0,\n      \"output_plugin\": true,\n      \"config\": {\n        \"retry_wait\": \"1s\",\n        \"retry_limit\": \"16\",\n        \"flush_interval\": \"1s\",\n        \"buffer_queue_limit\": \"10\",\n        \"type\": \"elasticsearch\",\n        \"host\": \"192.168.1.41\",\n        \"port\": \"9200\",\n        \"type_name\": \"access_log\",\n        \"logstash_format\": \"true\",\n        \"logstash_prefix\": \"test-apache-access\",\n        \"buffer_type\": \"memory\",\n        \"buffer_chunk_limit\": \"10m\"\n      },\n      \"type\": \"elasticsearch\",\n      \"plugin_category\": \"output\",\n      \"plugin_id\": \"object:3fb52c489614\"\n    }\n  ]\n}\n\n\n\u3053\u308c\u3089\u3092monitoring\u3059\u308b\u30b5\u30fc\u30d3\u30b9\u3092TreasureData\u793e\u304c\u7121\u6599\u3067\u63d0\u4f9b\u3057\u3066\u3044\u308b\u3088\u3046\u3067\u3057\u3066\u3061\u3087\u3063\u3068\u8a66\u3057\u3066\u307f\u307e\u3057\u305f\u304c\u3059\u3054\u304f\u7c21\u5358\u306b\u3067\u304d\u305d\u3046\u3067\u3059\u3002 - Treasure Agent Monitoring Service\n\n\n\n\u30d7\u30ed\u30bb\u30b9\u76e3\u8996\n\n\n2\u3064\u306eruby\u30d7\u30ed\u30bb\u30b9\u304c\u4e0a\u304c\u3063\u3066\u3044\u308b\u3053\u3068\u3092\u76e3\u8996\u3057\u3066\u304a\u304f\n\n[root@es1 restore]# ps w -C ruby -C td-agent --no-heading\n23228 ?        Sl     0:00 /opt/td-agent/embedded/bin/ruby /usr/sbin/td-agent --log /var/log/td-agent/td-agent.log --use-v1-config -\n23231 ?        Sl     0:00 /opt/td-agent/embedded/bin/ruby /usr/sbin/td-agent --log /var/log/td-agent/td-agent.log --use-v1-config -\n\n\n\u30dd\u30fc\u30c8\n\n\n24220(default\u306e\u5834\u5408)\u306f\u76e3\u8996\u3057\u3066\u304a\u304f\u3002\nfluent debug\u306a\u308b\u3082\u306e\u304c\u3042\u3063\u3066\u3001\u3053\u306e\u30dd\u30fc\u30c8\u306f\u30c8\u30e9\u30d6\u30eb\u30b7\u30e5\u30fc\u30c6\u30a3\u30f3\u30b0\u306e\u70ba\u306b\u30ed\u30fc\u30ab\u30eb\u304b\u3089\u306e\u30a2\u30af\u30bb\u30b9\u3060\u3051\u3067\u3082\u826f\u3044\u306e\u3067\u7a7a\u3051\u3066\u304a\u3044\u305f\u65b9\u304c\u3044\u3056\u3068\u3044\u3046\u6642\u306b\u3088\u3055\u305d\u3046\u3067\u3059\u3002\n\n<source>\n  @type debug_agent\n  bind 127.0.0.1\n  port 24230\n</source>\n\n\n\u5177\u4f53\u7684\u306a\u4f7f\u3044\u65b9\u306ffluent-debug\u3068\u622f\u308c\u308b\u3092\u53c2\u7167\u3002\n\n\nflowcounter\n\n\n\u3069\u306e\u304f\u3089\u3044\u306e\u6d41\u91cf\u304c\u6d41\u308c\u3066\u3044\u308b\u304b\u3063\u3066\u30e2\u30cb\u30bf\u30ea\u30f3\u30b0\u3057\u305f\u3044\u3067\u3059\u3088\u306d\u3002\u305d\u3093\u306a\u3068\u304d\u306fflowcounter plugin\u3092\u4f7f\u3046\u3068\u3088\u3055\u305d\u3046\u3067\u3059\u3002\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u65b9\u6cd5\n\ntd-agent-gem install fluent-plugin-flowcounter\n\n\n\u8a2d\u5b9a\u306faggregator\u5074\u3067copy\u3092\u4f7f\u3063\u3066\u8a2d\u5b9a\u3057\u307e\u3059\u3002\u4eca\u56de\u306fElasticsearch\u3078\u306e\u6295\u5165\u3068file\u3078\u306e\u51fa\u529b\u3092\u540c\u6642\u306b\u884c\u3046\u3088\u3046\u306a\u8a2d\u5b9a\u306b\u306a\u308a\u307e\u3059\u3002\nunit\u306f\u5358\u4f4d\u3067\u3001munite\u3092\u8a2d\u5b9a\u3059\u308b\u3068\u5206\u5358\u4f4d\u3067\u306e\u8a2d\u5b9a\u306b\u306a\u308a\u307e\u3059\u3002aggregate\u306f\u4f55\u3092\u53d6\u308b\u304b\u3067\u3001\u4eca\u56de\u306f\u5168\u3066\u3092\u53d6\u5f97\u3059\u308b\u3088\u3046\u306a\u8a2d\u5b9a\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002\u3061\u306a\u307f\u306btag\u540d\u306fflowcount\u3068\u8a2d\u5b9a\u3057\u3066\u3042\u308a\u307e\u3059\u304c\u7701\u7565\u3057\u305f\u5834\u5408\u3082flowcount\u306b\u306a\u308a\u307e\u3059\u3002\n\n<match test.apache.access>\n  @type copy\n  <store>\n    type elasticsearch\n    host 192.168.1.41\n    port 9200\n    \u30fb\u30fb\u30fb Elasticsearch\u3078\u30c7\u30fc\u30bf\u6295\u5165\u3059\u308b\u8a2d\u5b9a\n  </store>\n  <store>\n    @type flowcounter\n    count_keys *\n    unit minute\n    aggregate all\n    tag flowcount\n  </store>\n</match>\n<match flowcount>\n  type file\n  path /var/log/td-agent/traffic\n  time_slice_format %Y%m%d%H%M\n</match>\n\n\n\u51fa\u529b\u7d50\u679c\n\n[root@es1 td-agent]# tail -f /var/log/td-agent/traffic.20160127_0.log\n2016-01-27T04:56:05+00:00       flowcount       {\"count\":5,\"bytes\":995,\"count_rate\":0.08,\"bytes_rate\":16.58}\n\n\n\nFluentd Meetup #2 @\u5916\u9053\u7236 Fluentd\u3092\u512a\u3057\u304f\u898b\u5b88\u308b\u76e3\u8996\u4e8b\u4f8b\u3092\u53c2\u8003\u306b\u3055\u305b\u3066\u3044\u305f\u3060\u304f\u30681\u6642\u9593\u306b1\u56de\u3001\u6708\u5225\u306e\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3059\u308b\u3088\u3046\u306b\u904b\u7528\u3055\u308c\u3066\u3044\u308b\u305d\u3046\u3067\u3059\u3002\u3053\u3053\u306f\u60f3\u5b9a\u3055\u308c\u308b\u30c8\u30e9\u30d5\u30a3\u30c3\u30af\u306a\u3069\u306b\u5408\u308f\u305b\u3066\u8003\u616e\u304c\u5fc5\u8981\u3067\u3059\u306d\u3002\n\n\n\u30b7\u30b0\u30ca\u30eb\u3068API\u3092\u4f7f\u3063\u305f\u30cf\u30f3\u30c9\u30ea\u30f3\u30b0\n\n\u30b7\u30b0\u30ca\u30eb or API\u3092\u53e9\u304f\u3053\u3068\u3067\u505c\u6b62\u3084\u30d0\u30c3\u30d5\u30a1\u306eflush\u306a\u3093\u304b\u3092\u884c\u3048\u307e\u3059\u3002\nAPI\u3092\u53e9\u3051\u308b\u3088\u3046\u306b\u3059\u308b\u306b\u306ftd-agent.conf\u306b\u8a2d\u5b9a\u3057\u3066\u518d\u8d77\u52d5\u3059\u308b\u3060\u3051\u3002API\u3068\u30b7\u30b0\u30ca\u30eb\u306f\u540c\u3058\u52d5\u304d\u3092\u3059\u308b\u306e\u3067\u5916\u90e8\u304b\u3089API\u3092\u53e9\u304f\u3088\u3046\u306a\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3092\u4f5c\u308d\u3046\u3068\u3057\u306a\u3044\u9650\u308a\u30b7\u30b0\u30ca\u30eb\u3060\u3051\u3067\u5341\u5206\u3060\u3068\u601d\u308f\u308c\u307e\u3059\u3002\n\n<system> rpc_endpoint 127.0.0.1:24444 </system>\n\n\ngraceful\u306b\u505c\u6b62\n\n1\u56de\u3060\u3051\u30d0\u30c3\u30d5\u30a1\u306eflush\u3092\u8a66\u307f\u305f\u3042\u3068\u3001graceful\u306b\u505c\u6b62\u3055\u305b\u308b\nSIGINT or SIGTERM\n/api/processes.interruptWorkers\n/api/processes.killWorkers\n\n\n\u30d0\u30c3\u30d5\u30a1\u306eflush\n\nflush_interval\u3092\u7dad\u6301\u3057\u305f\u307e\u307e\u3059\u3050\u306b\u30d0\u30c3\u30d5\u30a1\u3092flush\u3059\u308b\nSIGUSR1\n/api/plugins.flushBuffers\n\n\n\u8a2d\u5b9a\u306e\u30ea\u30ed\u30fc\u30c9\n\nSIGHUP\n/api/config.reload\n\n\n\n\u30ed\u30b0\u306e\u8a2d\u5b9a\n\ntd-agent.log\u306e\u8a2d\u5b9a\n\ntd-agent.log\u306e\u30ed\u30b0\u30ec\u30d9\u30eb\u306e\u5909\u66f4\u306a\u3069\u306f/etc/td-agent/td-agent.conf\u306b\u8a18\u8f09\u3057\u307e\u3059\u3002\n\u30ed\u30b0\u30ec\u30d9\u30eb\u306fdefault\u3067info.trace,debug,info,warn,error,fatal\u304b\u3089\u8a2d\u5b9a\u53ef\u80fd\u3067\u3059\u3002\nsuppress_repeated_stacktrace:\u9023\u7d9a\u3057\u3066\u540c\u4e00\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3057\u305f\u5834\u5408\u6291\u5236\u3057\u307e\u3059\u3002\nemit_error_log_interval: \u6307\u5b9a\u6642\u9593\u5185\u306e\u540c\u4e00\u30a8\u30e9\u30fc\u3092\u6291\u5236\u3057\u307e\u3059\nsuppress_config_dump: \u8d77\u52d5\u6642\u306b\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u304ctd-agent.log\u306b\u51fa\u529b\u3055\u308c\u307e\u3059\u304c\u3001\u305d\u308c\u3092\u6291\u5236\u3057\u307e\u3059\u3002\n\n<system>\n  log_level trace\n  suppress_repeated_stacktrace true\n  emit_error_log_interval 60s\n  suppress_config_dump false\n</system>\n\n\ntd-agent.log\u306e\u30ed\u30fc\u30c6\u30fc\u30c8\n\nlogrotate\u3067\u30ed\u30fc\u30c6\u30fc\u30c8\u3057\u307e\u3059\u3002TreasureData\u306eGithub\u306b\u30b5\u30f3\u30d7\u30eb\u304c\u3042\u308a\u307e\u3057\u305f\u3002\u2193\ntd-agent/td-agent.logrotate\n\n\n\n\u30c7\u30a3\u30b9\u30af\u30d0\u30c3\u30d5\u30a1\u3092\u4f7f\u3046\u304b\u30e1\u30e2\u30ea\u30d0\u30c3\u30d5\u30a1\u3092\u4f7f\u3046\u304b\n\n\u53c2\u8003\uff1atd-agent \u306e\u30e1\u30e2\u30ea\u30d0\u30c3\u30d5\u30a1\u3068\u30d5\u30a1\u30a4\u30eb\u30d0\u30c3\u30d5\u30a1\u3067\u3069\u3093\u306a\u9055\u3044\u304c\u767a\u751f\u3059\u308b\u304b\u89b3\u5bdf\u3057\u3066\u307f\u305f\n\n\u30c7\u30a3\u30b9\u30af\u30d0\u30c3\u30d5\u30a1\u306e\u65b9\u304c\u9045\u3044\u3093\u3058\u3083\u306a\u3044\u304b\u3068\u52dd\u624b\u306b\u601d\u3044\u8fbc\u3093\u3067\u3044\u305f\u306e\u3067\u3059\u304c\u3069\u3046\u3084\u3089\u305d\u3046\u3067\u3082\u306a\u3044\u3088\u3046\u3067\u3059\u3002\u30c7\u30fc\u30bf\u30ed\u30b9\u30c8\u3059\u308b\u53ef\u80fd\u6027\u3082\u8003\u616e\u3059\u308b\u3068\u30c7\u30a3\u30b9\u30af\u30d0\u30c3\u30d5\u30a1\u3092\u4f7f\u3063\u3066\u304a\u3044\u305f\u65b9\u304c\u5b89\u5168\u3067\u3059\u306d\u3002\u30c7\u30a3\u30b9\u30af\u30d0\u30c3\u30d5\u30a1\u3092\u4f7f\u3063\u3066\u304a\u3051\u3070\u6b21\u56de\u306f\u305d\u3053\u304b\u3089\u518d\u9001\u3057\u3066\u304f\u308c\u307e\u3059\u3057\u3001\u30ad\u30e5\u30fc\u304c\u3042\u3075\u308c\u308b\u53ef\u80fd\u6027\u3082\u306a\u304f\u306a\u308a\u307e\u3059\u3002\n\u5ff5\u306e\u305f\u3081\u6027\u80fd\u30c6\u30b9\u30c8\u3057\u3066\u8981\u4ef6\u304c\u6e80\u305f\u305b\u308b\u3053\u3068\u3060\u3051\u306f\u78ba\u8a8d\u3057\u3066\u304a\u3051\u3070\u3088\u3055\u305d\u3046\u3067\u3059\u3002\n\n\n\nHigh Availability\n\n\nfluentd\u306f\u5358\u4f53\u3067\u3082\u4fe1\u983c\u6027\u306e\u9ad8\u3044\u518d\u9001\u51e6\u7406\u3092\u884c\u3063\u3066\u304f\u308c\u308b\u307b\u304b\u3001active-standby\u69cb\u6210\u3084\u3001\u8ca0\u8377\u5206\u6563\u69cb\u6210\u3001\u3055\u3089\u306bactive-standby\u69cb\u6210\u3067\u3082\u6551\u3048\u306a\u304b\u3063\u305f\u5834\u5408\u306b\u3079\u3064\u306e\u5a92\u4f53\uff08\u30d5\u30a1\u30a4\u30eb\u306a\u3069\uff09\u306b\u4fdd\u7ba1\u3057\u3066\u304a\u304f\u3053\u3068\u304c\u53ef\u80fd\u3067\u3059\u3002\u3053\u308c\u3092\u5b9f\u969b\u306b\u898b\u3066\u3044\u304d\u305f\u3044\u3068\u601d\u3044\u307e\u3059\u3002\n\n\n\u3069\u3093\u306a\u69cb\u6210\u3067\u8a66\u3057\u305f\u306e\u304b\n\napache\u306e\u30a2\u30af\u30bb\u30b9\u30ed\u30b0\u3092\u2460\u306e\u30b5\u30fc\u30d0\u306etd-agent\u304c\u62fe\u3044\u3001\u2461\u306e\u30b5\u30fc\u30d0\u3067\u53d7\u3051\u53d6\u308aElasticsearch\u306b\u6295\u5165\u3059\u308b\u69cb\u6210\u3068\u3057\u307e\u3057\u305f\u3002\u2461\u3068\u2462\u306e\u30b5\u30fc\u30d0\u306f\u30af\u30e9\u30b9\u30bf\u304c\u7d44\u307e\u308c\u3066\u304a\u308a\u3001\u305d\u308c\u305e\u308c\u306e\u30b5\u30fc\u30d0\u306btd-agent\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3066\u3042\u308a\u307e\u3059\u3002\n\n\n\n\n\u756a\u53f7\nhost\nIP\u30a2\u30c9\u30ec\u30b9\n\u8aac\u660e\n\n\n\n\n\u2460\nclient\n192.168.1.10\nhttpd,td-agent(forwarder)\n\n\n\u2461\nes01\n192.168.1.41\nElasticsearch,td-agent(aggregator)\n\n\n\u2462\nes02\n192.168.1.42\nElasticsearch,td-agent(aggregator)\n\n\n\n\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u306b\u3064\u3044\u3066\u306e\u88dc\u8db3\n\n\u3059\u3079\u3066\u81ea\u524d\u306eansible playbook\u3067\u5165\u308c\u307e\u3057\u305f\u30022,3\u5206\u3042\u308c\u30703\u53f0\u5206\u5165\u308c\u3089\u308c\u307e\u3059\u3002\ntd-agent\nElasticsearch\n\n\n\u306a\u305c\u30ed\u30fc\u30ab\u30eb\u306etd-agent\u306b\u4e00\u5ea6\u9001\u308b\u306e\u304b\uff1f\n\n\u76f4\u63a5aggregator\u30ce\u30fc\u30c9\u306b\u9001\u4fe1\u3059\u308b\u3053\u3068\u306f\u53ef\u80fd\u3067\u3059\u304c\u3001\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u65ad\u306a\u3069\u304c\u767a\u751f\u3057\u305f\u3068\u304d\u306b\u518d\u9001\u51e6\u7406\u304c\u5fc5\u8981\u306b\u306a\u308a\u3001\u8003\u616e\u3059\u308b\u3053\u3068\u304c\u5897\u3048\u3066\u3057\u307e\u3044\u307e\u3059\u3002\u306a\u306e\u3067\u4e00\u5ea6\u30ed\u30fc\u30ab\u30eb\u306etd-agent\u306b\u9001\u4fe1\u3057\u3066\u30ad\u30e5\u30fc\u30a4\u30f3\u30b0\u3055\u305b\u3066\u304b\u3089aggregator\u306b\u9001\u308b\u304c\u3088\u3044\u304b\u3068\u601d\u3044\u307e\u3059\u3002\n\u3053\u308c\u306f\u975e\u540c\u671f\u3067\u30e1\u30c3\u30bb\u30fc\u30b8\u30f3\u30b0\u3059\u308b\u6642\u306a\u3069\u306e\u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3\u3067\u306f\u826f\u304f\u3042\u308b\u30d1\u30bf\u30fc\u30f3\u3067\u3059\u306d\n\n\n\u2460\u306e\u30b5\u30fc\u30d0\u304b\u3089\u2461\u306e\u30b5\u30fc\u30d0\u306b\u9001\u308b\u3060\u3051\u306e\u8a2d\u5b9a\n\n\u4e0b\u8a18\u306e\u8a2d\u5b9a\u306fapache\u306e\u30a2\u30af\u30bb\u30b9\u30ed\u30b0\u3092tail\u3067\u62fe\u3063\u3066\u3001es01(192.168.1.41 24224)\u306b\u9001\u4fe1\u3059\u308b\u8a2d\u5b9a\u3067\u3059\u3002\n\u5b9f\u969b\u306b\u9001\u4fe1\u3059\u308b\u3068\u304d\u306b\u2461\u306e\u30b5\u30fc\u30d0\u304c\u30c0\u30a6\u30f3\u3057\u3066\u3044\u305f\u3089\u3069\u3046\u306a\u308b\u304b\u3068\u3044\u3046\u3068\u3001retry_limit\u3067\u8a2d\u5b9a\u3055\u308c\u305f\u56de\u6570\u5206\u30ea\u30c8\u30e9\u30a4\u3057\u7d9a\u3051\u3001\u305d\u306e\u9593\u306bes01\u304c\u5fa9\u65e7\u3057\u305f\u3089\u81ea\u52d5\u7684\u306b\u518d\u9001\u3057\u3066\u304f\u308c\u307e\u3059\u3002\nretry\u3059\u308b\u79d2\u6570\u306f\u6307\u6570\u95a2\u6570\u7684\u306b\u5897\u3048\u3066\u3044\u304f\u306e\u3067\u3059\u304c\u305d\u308c\u306f\u3053\u3061\u3089\u306e\u8a18\u4e8b\u300cBufferedOutput plugin\u306e\u4ee3\u8868\u7684\u306aoption\u306b\u3064\u3044\u3066\u300d\u306eretry_wait,retry_limit,max_retry_wait\u3042\u305f\u308a\u304c\u308f\u304b\u308a\u3084\u3059\u3044\u306e\u3067\u8aad\u3093\u3067\u3044\u305f\u3060\u3051\u308c\u3070\u3068\u601d\u3044\u307e\u3059\u3002\n\u5fa9\u65e7\u3059\u308b\u307e\u3067\u306e\u6642\u9593\u30d0\u30c3\u30d5\u30a1\u30ea\u30f3\u30b0\u3057\u7d9a\u3051\u308b\u3053\u3068\u306f\u53ef\u80fd\u3067\u3057\u3066\u3001buffer_chunk_limit x buffer_queue_limit\u3067\u6c7a\u307e\u308a\u307e\u3059\u3002\u30e1\u30e2\u30ea\u30d0\u30c3\u30d5\u30a1\u3092\u4f7f\u3046\u5834\u5408\u306f\u3053\u306e\u91cf\u30d0\u30c3\u30d5\u30a1\u30ea\u30f3\u30b0\u3067\u304d\u308b\u304f\u3089\u3044\u30e1\u30e2\u30ea\u306e\u78ba\u4fdd\u306f\u5fc5\u8981\u3067\u3057\u3087\u3046\u3002\n\n\n/etc/td-agent/td-agent.conf\n<source>\n  type tail\n  format apache2\n  path /var/log/httpd/access_log\n  tag test.apache.access\n  pos_file /var/log/td-agent/position/access_log.pos\n  types code:integer,size:integer\n</source>\n\n<match **>\n  type forward\n  send_timeout 60s\n  recover_wait 10s\n  heartbeat_interval 1s\n  phi_threshold 8\n  hard_timeout 60s\n  retry_limit 2\n  retry_wait 2s\n  max_retry_wait 30s\n  <server>\n    name es01\n    host 192.168.1.41\n    port 24224\n  </server>\n</match>\n\n\n\n\u30ea\u30c8\u30e9\u30a4\u3057\u3066\u3044\u308b\u9593\u306b\u30ce\u30fc\u30c9\u304c\u30c0\u30a6\u30f3\u3057\u3066\u3057\u307e\u3063\u305f\u3089\u30fb\u30fb\u30fb\u3068\u304b\u3001\u5927\u91cf\u306e\u30c7\u30fc\u30bf\u3092\u518d\u9001\u3059\u308b\u306e\u304c\u6016\u3044\u5834\u5408\u306f\u3001\u3042\u308b\u4e00\u5b9a\u306e\u30ea\u30c8\u30e9\u30a4\u56de\u6570\u3092\u8d85\u3048\u305f\u3089\u30d5\u30a1\u30a4\u30eb\u306b\u843d\u3068\u3057\u3066\u3057\u307e\u3046\u306e\u3082\u3042\u308a\u3060\u3068\u601d\u3044\u307e\u3059\u3002\n\u30d5\u30a1\u30a4\u30eb\u306b\u843d\u3068\u3059\u306b\u306f\u306e\u4e0b\u306b\u3092\u8ffd\u8a18\u3057\u307e\u3059\u3002\n\n  <secondary>\n    type file\n    path /var/log/td-agent/forward-failed\n  </secondary>\n\n\n\u3053\u306e\u3088\u3046\u306b\u3057\u3066\u304a\u304f\u3068/var/log/td-agent/forward-failed.tag\u540d0.log\u306a\u3069\u3068\u3044\u3046\u30d5\u30a1\u30a4\u30eb\u304c\u3067\u304d\u3001\u3053\u3053\u304b\u3089\u5fa9\u65e7\u3059\u308b\u3053\u3068\u304c\u53ef\u80fd\u3067\u3059\u3002Elasticsearch\u306b\u5927\u91cf\u306e\u30c7\u30fc\u30bf\u3092\u6295\u5165\u3057\u76f4\u3059\u3068\u304d\u306frefreshinterval\u3092\u9577\u3081\u306b\u8a2d\u5b9a\u3057\u3066\u304a\u304f\u3053\u3068\u3082\u304a\u5fd8\u308c\u306a\u304f\u3002\n\n\n\nActive-Standby\u69cb\u6210\n\nes01\u304c\u30c0\u30a6\u30f3\u3057\u305f\u5834\u5408\u306b\u3001es02\u306b\u9001\u308a\u305f\u3044\u3002\u3068\u3044\u3046\u5834\u5408\u306f\u30bf\u30b0\u3092\u8ffd\u52a0\u3057\u3001standby\u5074\u306bstandby\u3068\u8a18\u8ff0\u3057\u307e\u3059\u3002\nes01\u3078\u306e\u30d8\u30eb\u30b9\u30c1\u30a7\u30c3\u30af\u9593\u9694\u306fheartbeat_interval\u3067\u6307\u5b9a\u3055\u308c\u3066\u304a\u308a\u3001hard timeout\u3067\u6307\u5b9a\u3055\u308c\u305f\u79d2\u6570\u304c\u7d4c\u904e\u3059\u308b\u3068\u30c0\u30a6\u30f3\u3057\u305f\u3068\u898b\u306a\u3055\u308ces02\u306b\u9001\u308d\u3046\u3068\u3057\u307e\u3059\u3002\nstandby\u304c\u843d\u3061\u305f\u6642\u306e\u3053\u3068\u3092\u8003\u616e\u3057\u3066\u3001\u3067\u30d5\u30a1\u30a4\u30eb\u306b\u843d\u3068\u3057\u3066\u304a\u304f\u3068\u5c1a\u826f\u3044\u3068\u601d\u308f\u308c\u307e\u3059\u3002\n\n\n/etc/td-agent/td-agent.conf\n<source>\n  type tail\n  format apache2\n  path /var/log/httpd/access_log\n  tag test.apache.access\n  pos_file /var/log/td-agent/position/access_log.pos\n  types code:integer,size:integer\n</source>\n\n<match **>\n  type forward\n  send_timeout 60s\n  recover_wait 10s\n  heartbeat_interval 1s\n  phi_threshold 8\n  hard_timeout 60s\n  retry_limit 2\n  retry_wait 2s\n  max_retry_wait 30s\n  <server>\n    name es01\n    host 192.168.1.41\n    port 24224\n  </server>\n  <server>\n    name es02\n    host 192.168.1.42\n    port 24224\n    standby\n  </server>\n</match>\n\n\n\n\n\u8ca0\u8377\u5206\u6563\u69cb\u6210\n\nes01\u3068es02\u306b\u8ca0\u8377\u5206\u6563\u3057\u305f\u3044\u5834\u5408\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u8a2d\u5b9a\u3057\u307e\u3059\u3002\nweight\u3067\u504f\u308a\u3092\u8a2d\u5b9a\u3057\u307e\u3059\u3002\u5408\u8a08\u3067100\u3067\u3042\u308b\u5fc5\u8981\u306f\u306a\u304f\u3001\u5272\u5408\u3092\u8a18\u8f09\u3059\u308c\u3070\u826f\u3044\u3067\u3059\u3002\u3061\u306a\u307f\u306b\u30c7\u30d5\u30a9\u30eb\u30c8\u306f60\u3002\n\n  <server>\n    name es01\n    host 192.168.1.41\n    port 24224\n    weight 60\n  </server>\n  <server>\n    name es02\n    host 192.168.1.42\n    port 24224\n    weight 60\n  </server>\n\n\n\n\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u30c1\u30e5\u30fc\u30cb\u30f3\u30b0\n\n\n\u516c\u5f0f\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u3092\u898b\u308b\u3068top\u30b3\u30de\u30f3\u30c9\u3068\u304b\u3067CPU,Memory,DiskIO\u3069\u308c\u304c\u30dc\u30c8\u30eb\u30cd\u30c3\u30af\u306a\u306e\u304b\u306f\u898b\u3066\u304a\u304f\u3068\u826f\u3044\u3088\u3002\u3068\u66f8\u304b\u308c\u3066\u3044\u307e\u3059\u3002\nCPU\u304c\u591a\u304f\u306e\u5834\u5408\u30dc\u30c8\u30eb\u30cd\u30c3\u30af\u306b\u306a\u308b\u3088\u3046\u3067\u3001\u8907\u6570\u306eCPU\u30b3\u30a2\u3092\u5229\u7528\u3059\u308b\u305f\u3081in_multiprocess\u30d7\u30e9\u30b0\u30a4\u30f3\u3068\u3044\u3046\u306e\u3092\u4f7f\u3046\u3068\u826f\u3044\u3068\u306e\u3053\u3068\u3002\n\u307e\u3041\u3001\u79c1\u304c\u4eca\u4ed5\u4e8b\u3067\u3084\u308d\u3046\u3068\u3057\u3066\u3044\u308b\u30e6\u30fc\u30b9\u30b1\u30fc\u30b9\u3067\u306f\u5fc5\u8981\u306b\u306a\u308b\u3053\u3068\u306f\u306a\u3055\u305d\u3046\u306a\u306e\u3067\u3059\u304c\u3001\u3053\u3061\u3089\u306e\u8a18\u4e8b\u300c\u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b9 + \u30de\u30eb\u30c1\u30d7\u30ed\u30bb\u30b9\u5316\u3067 Fluentd \u306e\u30ed\u30b0\u53ce\u96c6\u3092\u52b9\u7387\u5316\u3059\u308b\u300d\u306b\u8a73\u3057\u304f\u8a18\u8f09\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n\u4f7f\u3046\u304b\u4f7f\u308f\u306a\u3044\u304b\u306f\u304a\u3044\u3068\u3044\u3066\u3001\u3044\u3056\u3068\u3044\u3046\u6642\u306e\u70ba\u306b\u59cb\u3081\u304b\u3089\u5165\u308c\u3066\u304a\u3044\u3066\u3082\u826f\u3044\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u3002\n\n\n\nUI\n\n\nbootstrap\u3067\u4f5c\u3089\u308c\u305fUI\u3082\u7528\u610f\u3055\u308c\u3066\u3044\u308b\u3088\u3046\u3067\u3059\u3002\u65e5\u672c\u8a9e\u3067\u3059\u3002\u3061\u3087\u3063\u3068\u3073\u3063\u304f\u308a\u3057\u307e\u3057\u305f\u3002\n\u8d77\u52d5\u3059\u308b\u306b\u306f\u3053\u3093\u306a\u611f\u3058\n\n[root@es1 td-agent]# td-agent-ui start\nPuma 2.11.1 starting...\n* Min threads: 0, max threads: 16\n* Environment: production\n* Listening on tcp://0.0.0.0:9292\n\n\n\u4e0b\u8a18\u306eURL\u3067\u30a2\u30af\u30bb\u30b9\u3057\u3001\u30a2\u30ab\u30a6\u30f3\u30c8\u306fadmin\u3001\u30d1\u30b9\u30ef\u30fc\u30c9\u306fchangeme\u3067\u30ed\u30b0\u30a4\u30f3\u53ef\u80fd\u3067\u3059\u3002\u5229\u7528\u3059\u308b\u5834\u5408\u306f\u521d\u671f\u30d1\u30b9\u30ef\u30fc\u30c9\u3092\u5909\u66f4\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\nhttp://host:9292/\n\n\nUI\u304b\u3089\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u3067\u304d\u305f\u308a\u3001\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3055\u308c\u3066\u3044\u308b\u30d7\u30e9\u30b0\u30a4\u30f3\u306e\u4e00\u89a7\u306a\u3069\u3092\u898b\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\u904b\u7528\u3067\u306f\u3042\u307e\u308a\u4f7f\u308f\u306a\u3044\u306e\u304b\u306a\u3002\n\n\n\u53c2\u8003\n\nfluentd \u516c\u5f0f\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\nFluentd\u306e\u4ed5\u7d44\u307f -\u30d0\u30c3\u30d5\u30a1\u6a5f\u80fd\u3067\u30ed\u30b0\u53ce\u96c6\u6f0f\u308c\u3092\u9632\u3050-\nBufferedOutput plugin\u306e\u4ee3\u8868\u7684\u306aoption\u306b\u3064\u3044\u3066\nFlunetd\u3001forward\u5148\u304c\u30c0\u30e1\u3060\u3063\u305f\u6642\u306bforward\u5143\u3067\u3042\u308b\u7a0b\u5ea6\u30ed\u30b0\u3092\u62c5\u4fdd\u3057\u305f\u3044\nFluentd\u306e\u969c\u5bb3\u6642\u52d5\u4f5c\nElasticsearch\u5c0e\u5165\u524d\u306b\u6c17\u3092\u4ed8\u3051\u3066\u304a\u304d\u305f\u3044\u3053\u3068\uff01\n\n# fluentd\u3092\u4f7f\u3046\u6642\u306b\u307e\u305a\u77e5\u3063\u3066\u304a\u3044\u305f\u307b\u3046\u304c\u3088\u3055\u305d\u3046\u306a\u3053\u3068\n\n## \u306f\u3058\u3081\u306b\n\n* \u671d\u304b\u3089Elasticsearch\u3078\u306e\u30c7\u30fc\u30bf\u306e\u6295\u3052\u8fbc\u307f\u65b9\u3092\u8003\u3048\u3066\u3044\u307e\u3057\u305f\u3002\n* \u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u3084\u30e1\u30c3\u30bb\u30fc\u30b8\u30ad\u30e5\u30fc\u306a\u3069\u306b\u30c7\u30fc\u30bf\u3092\u6295\u3052\u8fbc\u3093\u3067\u304a\u3044\u3066\u3001\u30cb\u30a2\u30ea\u30a2\u30eb\u306a\u30d0\u30c3\u30c1\u3067Elasticsearch\u306b\u6295\u3052\u8fbc\u3080\u3088\u308a\u3082\u3001fluentd\u3092\u4f7f\u3046\u65b9\u304c\u5727\u5012\u7684\u306b\u7c21\u5358\u3067\u4fe1\u983c\u6027\u304c\u9ad8\u3044\u3082\u306e\u304c\u3067\u304d\u307e\u3059\u306d\u3002\u81ea\u5206\u3067\u4f5c\u308a\u3053\u3080\u306e\u304c\u30d0\u30ab\u3089\u3057\u304f\u306a\u308a\u307e\u3059\u306d\u3002\n* \u3068\u3044\u3046\u3053\u3068\u3067\u3001fluentd\u5229\u7528\u6642\u306b\u6c17\u3092\u4ed8\u3051\u3066\u304a\u304d\u305f\u3044\u3053\u3068\u306b\u3064\u3044\u3066\u8abf\u3079\u3066\u307f\u307e\u3057\u305f\u3002\u5185\u5bb9\u306f[\u516c\u5f0f\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8](http://docs.fluentd.org/articles/quickstart)\u306e\u5185\u5bb9\u3092\u30d9\u30fc\u30b9\u306b\u81ea\u8eab\u3067\u8abf\u3079\u305f\u3053\u3068\u3092\u8ffd\u8a18\u3057\u3066\u3044\u307e\u3059\u3002\u516c\u5f0f\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u3078\u306e\u30ea\u30f3\u30af\u3082\u8cbc\u3063\u3066\u3042\u308a\u307e\u3059\u306e\u3067\u9069\u5b9c\u305d\u3061\u3089\u3092\u3054\u89a7\u3044\u305f\u3060\u3051\u308c\u3070\u3068\u3002\n\n---\n\n## \u74b0\u5883\n\n* CentOS6.7\n* td-agent 0.12.19\n* Ruby2.2.2\uff08\u30ea\u30b9\u30c8\u30a2\u30b9\u30af\u30ea\u30d7\u30c8\u3067\u5229\u7528\uff09\n* [Fluent-Logger(0.5.1)](https://github.com/fluent/fluent-logger-ruby)\n* Elasticsearch2.1.1\n\n---\n\n## fluentd vs logstash\n\n* [Fluentd vs. Logstash: A Comparison of Log Collectors](http://logz.io/blog/fluentd-logstash/)\n* [Fluentd vs Logstash](http://www.slideshare.net/td-nttcom/fluentd-vs-logstash-for-openstack-log-management)\n* [Fluentd\u306e\u73fe\u5b9f\u88c5\u306ePros/Cons](http://repeatedly.github.io/ja/2015/04/fluentd-architecture-pros-and-cons/)\n* \u3053\u308c\u7d50\u69cb\u60a9\u307f\u307e\u3059\u3088\u306d\u3002\n* \u79c1\u304c\u3084\u308a\u305f\u304b\u3063\u305f\u3053\u3068\u306fSQS\u3068Elasticsesarch,S3\u306b\u30c7\u30fc\u30bf\u3092\u6d41\u3057\u8fbc\u3081\u308c\u3070\u826f\u304b\u3063\u305f\u306e\u3067\u3059\u304c\u3001\u4e21\u8005\u3068\u3082\u30d7\u30e9\u30b0\u30a4\u30f3\u306f\u516c\u958b\u3055\u308c\u3066\u3044\u307e\u3057\u305f\u3002\u307e\u305f\u3001\u305d\u308c\u4ee5\u5916\u306e\u30d7\u30e9\u30b0\u30a4\u30f3\u3082\u305f\u304f\u3055\u3093\u3042\u308b\u3088\u3046\u3067\u3057\u3066\u3001\u30d7\u30e9\u30b0\u30a4\u30f3\u306e\u6570\u306a\u3069\u306f\u7532\u4e59\u4ed8\u3051\u96e3\u3044\u3002\n* \u69cb\u6210\u9762\u3067\u8a00\u3046\u3068Active-Standby\u69cb\u6210\u306f\u3069\u3061\u3089\u3082\u53d6\u308c\u307e\u3059\u306e\u3067\u3001\u79c1\u304c\u6e80\u305f\u3057\u305f\u3044\u8981\u4ef6\u306f\u63c3\u3063\u3066\u3044\u308b\u3088\u3046\u306b\u601d\u3048\u307e\u3057\u305f\u3002\n* \u7d50\u5c40\u89e6\u3063\u3066\u307f\u305f\u7d50\u679c\u3001\u30d0\u30c3\u30d5\u30a1\u30ea\u30f3\u30b0\u6a5f\u80fd\u3068\u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b9\u6a5f\u80fd\u306e\u90e8\u5206\u306e\u5dee\u3067fluentd\u3092\u4f7f\u3046\u3053\u3068\u306b\u3057\u307e\u3057\u305f\u3002\n\n## [fluentd\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb](http://docs.fluentd.org/articles/before-install)\n\n* \u3044\u3064\u3082\u901a\u308aansible playbook\u306b\u304a\u3068\u3057\u3066\u3042\u308a\u307e\u3059\u3002 - [ansible-td-agent](https://github.com/uzresk/ansible-td-agent)\n\n### NTP\n\n* \u5f53\u7136\u3067\u3059\u3051\u3069\u8a2d\u5b9a\u3057\u3066\u304a\u304d\u307e\u3057\u3087\u3046\u3002\u30ed\u30b0\u3067\u30bf\u30a4\u30e0\u30b9\u30bf\u30f3\u30d7\u30ba\u30ec\u306f\u8a71\u306b\u306a\u3089\u306a\u3044\u306e\u3067\u3002\n\n### File Descriptors\n\n* File Descriptors\u304c\u8db3\u308a\u306a\u304f\u306a\u308b\u6050\u308c\u304c\u3042\u308b\u306e\u3067\u5897\u3084\u3057\u3066\u304a\u304f\u3002\u305f\u3060\u3057\u3001\u6700\u65b0\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u3060\u3068\u8d77\u52d5\u30b9\u30af\u30ea\u30d7\u30c8\u5185\u306b\u4ee5\u4e0b\u306e\u8a18\u8ff0\u304c\u3042\u308b\u305f\u3081\u7279\u306b\u8a2d\u5b9a\u306f\u4e0d\u8981\n\n```\nulimit -n 65536 1>/dev/null 2>&1 || true\n```\n\n### \u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u30ab\u30fc\u30cd\u30eb\u30d1\u30e9\u30e1\u30fc\u30bf\u306e\u5909\u66f4\n\n* \u30de\u30cb\u30e5\u30a2\u30eb\u306b\u306fTCP_WAIT\u304c\u554f\u984c\u306b\u306a\u3063\u3066\u3044\u308b\u5834\u5408\u306f\u8a2d\u5b9a\u3057\u306a\u3055\u3044\u3068\u3044\u3046\u6ce8\u610f\u66f8\u304d\u304c\u3042\u308b\u3002\n* \u30bd\u30b1\u30c3\u30c8\u306e\u518d\u5229\u7528\u8a2d\u5b9a\u3092\u884c\u3044\u52b9\u7387\u7684\u306b\u901a\u4fe1\u3059\u308b\u8a2d\u5b9a\u3084\u30ed\u30fc\u30ab\u30eb\u30dd\u30fc\u30c8\u304c\u67af\u6e07\u3059\u308b\u3088\u3046\u306a\u5834\u5408\u306b\u5099\u3048\u3066\u30ec\u30f3\u30b8\u3092\u5897\u3084\u3057\u3066\u3044\u308b\u3002\u53cd\u6620\u306f\u518d\u8d77\u52d5\u304b\u3001sysctl -w\u3002\n\n```/etc/sysctl.conf\nnet.ipv4.tcp_tw_recycle = 1\nnet.ipv4.tcp_tw_reuse = 1\nnet.ipv4.ip_local_port_range = 10240    65535\n```\n\n## \u76e3\u8996 - [Monitoring Fluentd](http://docs.fluentd.org/articles/monitoring)\n\n### [monitor_agent](http://docs.fluentd.org/articles/monitoring#monitoring-agent)\n\n* plugin\u306e\u72b6\u614b\u306e\u76e3\u8996\u304c\u53ef\u80fd\u3067\u3059\u3002buffer_queue_length\u3068\u304bbuffer_total_queued_size\u3068\u304b\u308f\u304b\u308b\u306e\u306f\u3042\u308a\u304c\u305f\u3044\u3067\u3059\u306d\u3002\u8a2d\u5b9a\u306ftd-agent.conf\u306b\u4ee5\u4e0b\u3092\u8ffd\u8a18\u3057\u3066\u518d\u8d77\u52d5\u3059\u308b\u3060\u3051\u3002\n\n```/etc/td-agent/td-agent.conf\n<source>\n  @type monitor_agent\n  bind 0.0.0.0\n  port 24220\n</source>\n```\n\n* http\u306e\u30dd\u30fc\u30c8\u304clisten\u3059\u308b\u306e\u3067\u76e3\u8996\u30b5\u30fc\u30d3\u30b9\u304b\u3089\u306ehttp\u76e3\u8996\u3068\u3057\u3066\u5229\u7528\u3057\u3066\u3082\u826f\u3044\u3068\u601d\u308f\u308c\u307e\u3059\u3002\n* curl\u3067\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3053\u3068\u306b\u3088\u3063\u3066plugin\u306e\u60c5\u5831\u304c\u62bd\u51fa\u3067\u304d\u307e\u3059\u3002.json\u3092\u4ed8\u3051\u306a\u3044\u3068tsv\u5f62\u5f0f\u3067\u62bd\u51fa\u53ef\u80fd\u3067\u3059\u3002\n\n```\n[root@es1 restore]# curl -s http://localhost:24220/api/plugins.json | jq .\n{\n  \"plugins\": [\n\u30fb\u30fb\u30fb\u30fb\n    {\n      \"retry_count\": 0,\n      \"buffer_total_queued_size\": 0,\n      \"buffer_queue_length\": 0,\n      \"output_plugin\": true,\n      \"config\": {\n        \"retry_wait\": \"1s\",\n        \"retry_limit\": \"16\",\n        \"flush_interval\": \"1s\",\n        \"buffer_queue_limit\": \"10\",\n        \"type\": \"elasticsearch\",\n        \"host\": \"192.168.1.41\",\n        \"port\": \"9200\",\n        \"type_name\": \"access_log\",\n        \"logstash_format\": \"true\",\n        \"logstash_prefix\": \"test-apache-access\",\n        \"buffer_type\": \"memory\",\n        \"buffer_chunk_limit\": \"10m\"\n      },\n      \"type\": \"elasticsearch\",\n      \"plugin_category\": \"output\",\n      \"plugin_id\": \"object:3fb52c489614\"\n    }\n  ]\n}\n```\n\n* \u3053\u308c\u3089\u3092monitoring\u3059\u308b\u30b5\u30fc\u30d3\u30b9\u3092TreasureData\u793e\u304c\u7121\u6599\u3067\u63d0\u4f9b\u3057\u3066\u3044\u308b\u3088\u3046\u3067\u3057\u3066\u3061\u3087\u3063\u3068\u8a66\u3057\u3066\u307f\u307e\u3057\u305f\u304c\u3059\u3054\u304f\u7c21\u5358\u306b\u3067\u304d\u305d\u3046\u3067\u3059\u3002 - [Treasure Agent Monitoring Service](http://www.slideshare.net/tamuraaa/treasure-agent-mo)\n\n### [\u30d7\u30ed\u30bb\u30b9\u76e3\u8996](http://docs.fluentd.org/articles/monitoring#process-monitoring)\n\n* 2\u3064\u306eruby\u30d7\u30ed\u30bb\u30b9\u304c\u4e0a\u304c\u3063\u3066\u3044\u308b\u3053\u3068\u3092\u76e3\u8996\u3057\u3066\u304a\u304f\n\n```\n[root@es1 restore]# ps w -C ruby -C td-agent --no-heading\n23228 ?        Sl     0:00 /opt/td-agent/embedded/bin/ruby /usr/sbin/td-agent --log /var/log/td-agent/td-agent.log --use-v1-config -\n23231 ?        Sl     0:00 /opt/td-agent/embedded/bin/ruby /usr/sbin/td-agent --log /var/log/td-agent/td-agent.log --use-v1-config -\n```\n\n### [\u30dd\u30fc\u30c8](http://docs.fluentd.org/articles/monitoring#port-monitoring)\n\n* 24220(default\u306e\u5834\u5408)\u306f\u76e3\u8996\u3057\u3066\u304a\u304f\u3002\n* fluent debug\u306a\u308b\u3082\u306e\u304c\u3042\u3063\u3066\u3001\u3053\u306e\u30dd\u30fc\u30c8\u306f\u30c8\u30e9\u30d6\u30eb\u30b7\u30e5\u30fc\u30c6\u30a3\u30f3\u30b0\u306e\u70ba\u306b\u30ed\u30fc\u30ab\u30eb\u304b\u3089\u306e\u30a2\u30af\u30bb\u30b9\u3060\u3051\u3067\u3082\u826f\u3044\u306e\u3067\u7a7a\u3051\u3066\u304a\u3044\u305f\u65b9\u304c\u3044\u3056\u3068\u3044\u3046\u6642\u306b\u3088\u3055\u305d\u3046\u3067\u3059\u3002\n\n```\n<source>\n  @type debug_agent\n  bind 127.0.0.1\n  port 24230\n</source>\n```\n\n* \u5177\u4f53\u7684\u306a\u4f7f\u3044\u65b9\u306f[fluent-debug\u3068\u622f\u308c\u308b](http://qiita.com/tatsu-yam/items/1f882e27865739fb5af2)\u3092\u53c2\u7167\u3002\n\n### [flowcounter](https://github.com/tagomoris/fluent-plugin-flowcounter.git)\n\n* \u3069\u306e\u304f\u3089\u3044\u306e\u6d41\u91cf\u304c\u6d41\u308c\u3066\u3044\u308b\u304b\u3063\u3066\u30e2\u30cb\u30bf\u30ea\u30f3\u30b0\u3057\u305f\u3044\u3067\u3059\u3088\u306d\u3002\u305d\u3093\u306a\u3068\u304d\u306fflowcounter plugin\u3092\u4f7f\u3046\u3068\u3088\u3055\u305d\u3046\u3067\u3059\u3002\n* \u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u65b9\u6cd5\n\n```\ntd-agent-gem install fluent-plugin-flowcounter\n```\n\n* \u8a2d\u5b9a\u306faggregator\u5074\u3067copy\u3092\u4f7f\u3063\u3066\u8a2d\u5b9a\u3057\u307e\u3059\u3002\u4eca\u56de\u306fElasticsearch\u3078\u306e\u6295\u5165\u3068file\u3078\u306e\u51fa\u529b\u3092\u540c\u6642\u306b\u884c\u3046\u3088\u3046\u306a\u8a2d\u5b9a\u306b\u306a\u308a\u307e\u3059\u3002\n* unit\u306f\u5358\u4f4d\u3067\u3001munite\u3092\u8a2d\u5b9a\u3059\u308b\u3068\u5206\u5358\u4f4d\u3067\u306e\u8a2d\u5b9a\u306b\u306a\u308a\u307e\u3059\u3002aggregate\u306f\u4f55\u3092\u53d6\u308b\u304b\u3067\u3001\u4eca\u56de\u306f\u5168\u3066\u3092\u53d6\u5f97\u3059\u308b\u3088\u3046\u306a\u8a2d\u5b9a\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002\u3061\u306a\u307f\u306btag\u540d\u306fflowcount\u3068\u8a2d\u5b9a\u3057\u3066\u3042\u308a\u307e\u3059\u304c\u7701\u7565\u3057\u305f\u5834\u5408\u3082flowcount\u306b\u306a\u308a\u307e\u3059\u3002\n\n```\n<match test.apache.access>\n  @type copy\n  <store>\n    type elasticsearch\n    host 192.168.1.41\n    port 9200\n    \u30fb\u30fb\u30fb Elasticsearch\u3078\u30c7\u30fc\u30bf\u6295\u5165\u3059\u308b\u8a2d\u5b9a\n  </store>\n  <store>\n    @type flowcounter\n    count_keys *\n    unit minute\n    aggregate all\n    tag flowcount\n  </store>\n</match>\n<match flowcount>\n  type file\n  path /var/log/td-agent/traffic\n  time_slice_format %Y%m%d%H%M\n</match>\n```\n\n* \u51fa\u529b\u7d50\u679c\n\n```\n[root@es1 td-agent]# tail -f /var/log/td-agent/traffic.20160127_0.log\n2016-01-27T04:56:05+00:00       flowcount       {\"count\":5,\"bytes\":995,\"count_rate\":0.08,\"bytes_rate\":16.58}\n```\n\n* [Fluentd Meetup #2 @\u5916\u9053\u7236 Fluentd\u3092\u512a\u3057\u304f\u898b\u5b88\u308b\u76e3\u8996\u4e8b\u4f8b](http://www.slideshare.net/GedowFather/fluentd-meetup-2-fluentd)\u3092\u53c2\u8003\u306b\u3055\u305b\u3066\u3044\u305f\u3060\u304f\u30681\u6642\u9593\u306b1\u56de\u3001\u6708\u5225\u306e\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3059\u308b\u3088\u3046\u306b\u904b\u7528\u3055\u308c\u3066\u3044\u308b\u305d\u3046\u3067\u3059\u3002\u3053\u3053\u306f\u60f3\u5b9a\u3055\u308c\u308b\u30c8\u30e9\u30d5\u30a3\u30c3\u30af\u306a\u3069\u306b\u5408\u308f\u305b\u3066\u8003\u616e\u304c\u5fc5\u8981\u3067\u3059\u306d\u3002\n\n## [\u30b7\u30b0\u30ca\u30eb](http://docs.fluentd.org/articles/signals)\u3068[API](http://docs.fluentd.org/articles/rpc)\u3092\u4f7f\u3063\u305f\u30cf\u30f3\u30c9\u30ea\u30f3\u30b0\n\n* \u30b7\u30b0\u30ca\u30eb or API\u3092\u53e9\u304f\u3053\u3068\u3067\u505c\u6b62\u3084\u30d0\u30c3\u30d5\u30a1\u306eflush\u306a\u3093\u304b\u3092\u884c\u3048\u307e\u3059\u3002\n* API\u3092\u53e9\u3051\u308b\u3088\u3046\u306b\u3059\u308b\u306b\u306ftd-agent.conf\u306b\u8a2d\u5b9a\u3057\u3066\u518d\u8d77\u52d5\u3059\u308b\u3060\u3051\u3002API\u3068\u30b7\u30b0\u30ca\u30eb\u306f\u540c\u3058\u52d5\u304d\u3092\u3059\u308b\u306e\u3067\u5916\u90e8\u304b\u3089API\u3092\u53e9\u304f\u3088\u3046\u306a\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3092\u4f5c\u308d\u3046\u3068\u3057\u306a\u3044\u9650\u308a\u30b7\u30b0\u30ca\u30eb\u3060\u3051\u3067\u5341\u5206\u3060\u3068\u601d\u308f\u308c\u307e\u3059\u3002\n\n```\n<system> rpc_endpoint 127.0.0.1:24444 </system>\n```\n\n### graceful\u306b\u505c\u6b62\n\n* 1\u56de\u3060\u3051\u30d0\u30c3\u30d5\u30a1\u306eflush\u3092\u8a66\u307f\u305f\u3042\u3068\u3001graceful\u306b\u505c\u6b62\u3055\u305b\u308b\n* SIGINT or SIGTERM\n* /api/processes.interruptWorkers\n* /api/processes.killWorkers\n\n### \u30d0\u30c3\u30d5\u30a1\u306eflush\n\n* flush_interval\u3092\u7dad\u6301\u3057\u305f\u307e\u307e\u3059\u3050\u306b\u30d0\u30c3\u30d5\u30a1\u3092flush\u3059\u308b\n* SIGUSR1\n* /api/plugins.flushBuffers\n\n### \u8a2d\u5b9a\u306e\u30ea\u30ed\u30fc\u30c9\n\n* SIGHUP\n* /api/config.reload\n\n---\n\n## \u30ed\u30b0\u306e\u8a2d\u5b9a\n\n### td-agent.log\u306e\u8a2d\u5b9a\n\n* td-agent.log\u306e\u30ed\u30b0\u30ec\u30d9\u30eb\u306e\u5909\u66f4\u306a\u3069\u306f/etc/td-agent/td-agent.conf\u306b\u8a18\u8f09\u3057\u307e\u3059\u3002\n* \u30ed\u30b0\u30ec\u30d9\u30eb\u306fdefault\u3067info.trace,debug,info,warn,error,fatal\u304b\u3089\u8a2d\u5b9a\u53ef\u80fd\u3067\u3059\u3002\n* suppress_repeated_stacktrace:\u9023\u7d9a\u3057\u3066\u540c\u4e00\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3057\u305f\u5834\u5408\u6291\u5236\u3057\u307e\u3059\u3002\n* emit_error_log_interval: \u6307\u5b9a\u6642\u9593\u5185\u306e\u540c\u4e00\u30a8\u30e9\u30fc\u3092\u6291\u5236\u3057\u307e\u3059\n* suppress_config_dump: \u8d77\u52d5\u6642\u306b\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u304ctd-agent.log\u306b\u51fa\u529b\u3055\u308c\u307e\u3059\u304c\u3001\u305d\u308c\u3092\u6291\u5236\u3057\u307e\u3059\u3002\n\n```\n<system>\n  log_level trace\n  suppress_repeated_stacktrace true\n  emit_error_log_interval 60s\n  suppress_config_dump false\n</system>\n```\n\n### td-agent.log\u306e\u30ed\u30fc\u30c6\u30fc\u30c8\n\n* logrotate\u3067\u30ed\u30fc\u30c6\u30fc\u30c8\u3057\u307e\u3059\u3002TreasureData\u306eGithub\u306b\u30b5\u30f3\u30d7\u30eb\u304c\u3042\u308a\u307e\u3057\u305f\u3002\u2193\n* [td-agent/td-agent.logrotate](https://github.com/treasure-data/td-agent/blob/master/td-agent.logrotate)\n\n---\n\n## \u30c7\u30a3\u30b9\u30af\u30d0\u30c3\u30d5\u30a1\u3092\u4f7f\u3046\u304b\u30e1\u30e2\u30ea\u30d0\u30c3\u30d5\u30a1\u3092\u4f7f\u3046\u304b\n\n* \u53c2\u8003\uff1a[td-agent \u306e\u30e1\u30e2\u30ea\u30d0\u30c3\u30d5\u30a1\u3068\u30d5\u30a1\u30a4\u30eb\u30d0\u30c3\u30d5\u30a1\u3067\u3069\u3093\u306a\u9055\u3044\u304c\u767a\u751f\u3059\u308b\u304b\u89b3\u5bdf\u3057\u3066\u307f\u305f](http://inokara.hateblo.jp/entry/2013/11/03/104235)\n* \u30c7\u30a3\u30b9\u30af\u30d0\u30c3\u30d5\u30a1\u306e\u65b9\u304c\u9045\u3044\u3093\u3058\u3083\u306a\u3044\u304b\u3068\u52dd\u624b\u306b\u601d\u3044\u8fbc\u3093\u3067\u3044\u305f\u306e\u3067\u3059\u304c\u3069\u3046\u3084\u3089\u305d\u3046\u3067\u3082\u306a\u3044\u3088\u3046\u3067\u3059\u3002\u30c7\u30fc\u30bf\u30ed\u30b9\u30c8\u3059\u308b\u53ef\u80fd\u6027\u3082\u8003\u616e\u3059\u308b\u3068\u30c7\u30a3\u30b9\u30af\u30d0\u30c3\u30d5\u30a1\u3092\u4f7f\u3063\u3066\u304a\u3044\u305f\u65b9\u304c\u5b89\u5168\u3067\u3059\u306d\u3002\u30c7\u30a3\u30b9\u30af\u30d0\u30c3\u30d5\u30a1\u3092\u4f7f\u3063\u3066\u304a\u3051\u3070\u6b21\u56de\u306f\u305d\u3053\u304b\u3089\u518d\u9001\u3057\u3066\u304f\u308c\u307e\u3059\u3057\u3001\u30ad\u30e5\u30fc\u304c\u3042\u3075\u308c\u308b\u53ef\u80fd\u6027\u3082\u306a\u304f\u306a\u308a\u307e\u3059\u3002\n* \u5ff5\u306e\u305f\u3081\u6027\u80fd\u30c6\u30b9\u30c8\u3057\u3066\u8981\u4ef6\u304c\u6e80\u305f\u305b\u308b\u3053\u3068\u3060\u3051\u306f\u78ba\u8a8d\u3057\u3066\u304a\u3051\u3070\u3088\u3055\u305d\u3046\u3067\u3059\u3002\n\n---\n\n## [High Availability](http://docs.fluentd.org/articles/high-availability)\n\n* fluentd\u306f\u5358\u4f53\u3067\u3082\u4fe1\u983c\u6027\u306e\u9ad8\u3044\u518d\u9001\u51e6\u7406\u3092\u884c\u3063\u3066\u304f\u308c\u308b\u307b\u304b\u3001active-standby\u69cb\u6210\u3084\u3001\u8ca0\u8377\u5206\u6563\u69cb\u6210\u3001\u3055\u3089\u306bactive-standby\u69cb\u6210\u3067\u3082\u6551\u3048\u306a\u304b\u3063\u305f\u5834\u5408\u306b\u3079\u3064\u306e\u5a92\u4f53\uff08\u30d5\u30a1\u30a4\u30eb\u306a\u3069\uff09\u306b\u4fdd\u7ba1\u3057\u3066\u304a\u304f\u3053\u3068\u304c\u53ef\u80fd\u3067\u3059\u3002\u3053\u308c\u3092\u5b9f\u969b\u306b\u898b\u3066\u3044\u304d\u305f\u3044\u3068\u601d\u3044\u307e\u3059\u3002\n\n### \u3069\u3093\u306a\u69cb\u6210\u3067\u8a66\u3057\u305f\u306e\u304b\n\n* apache\u306e\u30a2\u30af\u30bb\u30b9\u30ed\u30b0\u3092\u2460\u306e\u30b5\u30fc\u30d0\u306etd-agent\u304c\u62fe\u3044\u3001\u2461\u306e\u30b5\u30fc\u30d0\u3067\u53d7\u3051\u53d6\u308aElasticsearch\u306b\u6295\u5165\u3059\u308b\u69cb\u6210\u3068\u3057\u307e\u3057\u305f\u3002\u2461\u3068\u2462\u306e\u30b5\u30fc\u30d0\u306f\u30af\u30e9\u30b9\u30bf\u304c\u7d44\u307e\u308c\u3066\u304a\u308a\u3001\u305d\u308c\u305e\u308c\u306e\u30b5\u30fc\u30d0\u306btd-agent\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3066\u3042\u308a\u307e\u3059\u3002\n\n|\u756a\u53f7|host|IP\u30a2\u30c9\u30ec\u30b9|\u8aac\u660e|\n|:--|:--|:------------|:-----------|:-----------|\n|\u2460|client|192.168.1.10|httpd,td-agent(forwarder)|\n|\u2461|es01|192.168.1.41|Elasticsearch,td-agent(aggregator)|\n|\u2462|es02|192.168.1.42|Elasticsearch,td-agent(aggregator)|\n\n\n### \u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u306b\u3064\u3044\u3066\u306e\u88dc\u8db3\n\n* \u3059\u3079\u3066\u81ea\u524d\u306eansible playbook\u3067\u5165\u308c\u307e\u3057\u305f\u30022,3\u5206\u3042\u308c\u30703\u53f0\u5206\u5165\u308c\u3089\u308c\u307e\u3059\u3002\n* [td-agent](https://github.com/uzresk/ansible-td-agent.git)\n* [Elasticsearch](https://github.com/uzresk/ansible-elasticsearch2.git)\n\n### \u306a\u305c\u30ed\u30fc\u30ab\u30eb\u306etd-agent\u306b\u4e00\u5ea6\u9001\u308b\u306e\u304b\uff1f\n\n* \u76f4\u63a5aggregator\u30ce\u30fc\u30c9\u306b\u9001\u4fe1\u3059\u308b\u3053\u3068\u306f\u53ef\u80fd\u3067\u3059\u304c\u3001\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u65ad\u306a\u3069\u304c\u767a\u751f\u3057\u305f\u3068\u304d\u306b\u518d\u9001\u51e6\u7406\u304c\u5fc5\u8981\u306b\u306a\u308a\u3001\u8003\u616e\u3059\u308b\u3053\u3068\u304c\u5897\u3048\u3066\u3057\u307e\u3044\u307e\u3059\u3002\u306a\u306e\u3067\u4e00\u5ea6\u30ed\u30fc\u30ab\u30eb\u306etd-agent\u306b\u9001\u4fe1\u3057\u3066\u30ad\u30e5\u30fc\u30a4\u30f3\u30b0\u3055\u305b\u3066\u304b\u3089aggregator\u306b\u9001\u308b\u304c\u3088\u3044\u304b\u3068\u601d\u3044\u307e\u3059\u3002\n* \u3053\u308c\u306f\u975e\u540c\u671f\u3067\u30e1\u30c3\u30bb\u30fc\u30b8\u30f3\u30b0\u3059\u308b\u6642\u306a\u3069\u306e\u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3\u3067\u306f\u826f\u304f\u3042\u308b\u30d1\u30bf\u30fc\u30f3\u3067\u3059\u306d\n\n### \u2460\u306e\u30b5\u30fc\u30d0\u304b\u3089\u2461\u306e\u30b5\u30fc\u30d0\u306b\u9001\u308b\u3060\u3051\u306e\u8a2d\u5b9a\n\n* \u4e0b\u8a18\u306e\u8a2d\u5b9a\u306fapache\u306e\u30a2\u30af\u30bb\u30b9\u30ed\u30b0\u3092tail\u3067\u62fe\u3063\u3066\u3001es01(192.168.1.41 24224)\u306b\u9001\u4fe1\u3059\u308b\u8a2d\u5b9a\u3067\u3059\u3002\n* \u5b9f\u969b\u306b\u9001\u4fe1\u3059\u308b\u3068\u304d\u306b\u2461\u306e\u30b5\u30fc\u30d0\u304c\u30c0\u30a6\u30f3\u3057\u3066\u3044\u305f\u3089\u3069\u3046\u306a\u308b\u304b\u3068\u3044\u3046\u3068\u3001retry_limit\u3067\u8a2d\u5b9a\u3055\u308c\u305f\u56de\u6570\u5206\u30ea\u30c8\u30e9\u30a4\u3057\u7d9a\u3051\u3001\u305d\u306e\u9593\u306bes01\u304c\u5fa9\u65e7\u3057\u305f\u3089\u81ea\u52d5\u7684\u306b\u518d\u9001\u3057\u3066\u304f\u308c\u307e\u3059\u3002\n* retry\u3059\u308b\u79d2\u6570\u306f\u6307\u6570\u95a2\u6570\u7684\u306b\u5897\u3048\u3066\u3044\u304f\u306e\u3067\u3059\u304c\u305d\u308c\u306f[\u3053\u3061\u3089\u306e\u8a18\u4e8b\u300cBufferedOutput plugin\u306e\u4ee3\u8868\u7684\u306aoption\u306b\u3064\u3044\u3066\u300d](http://qiita.com/tatsu-yam/items/bd7006e483f3b3c64309)\u306eretry_wait,retry_limit,max_retry_wait\u3042\u305f\u308a\u304c\u308f\u304b\u308a\u3084\u3059\u3044\u306e\u3067\u8aad\u3093\u3067\u3044\u305f\u3060\u3051\u308c\u3070\u3068\u601d\u3044\u307e\u3059\u3002\n* \u5fa9\u65e7\u3059\u308b\u307e\u3067\u306e\u6642\u9593\u30d0\u30c3\u30d5\u30a1\u30ea\u30f3\u30b0\u3057\u7d9a\u3051\u308b\u3053\u3068\u306f\u53ef\u80fd\u3067\u3057\u3066\u3001buffer_chunk_limit x buffer_queue_limit\u3067\u6c7a\u307e\u308a\u307e\u3059\u3002\u30e1\u30e2\u30ea\u30d0\u30c3\u30d5\u30a1\u3092\u4f7f\u3046\u5834\u5408\u306f\u3053\u306e\u91cf\u30d0\u30c3\u30d5\u30a1\u30ea\u30f3\u30b0\u3067\u304d\u308b\u304f\u3089\u3044\u30e1\u30e2\u30ea\u306e\u78ba\u4fdd\u306f\u5fc5\u8981\u3067\u3057\u3087\u3046\u3002\n\n```/etc/td-agent/td-agent.conf\n<source>\n  type tail\n  format apache2\n  path /var/log/httpd/access_log\n  tag test.apache.access\n  pos_file /var/log/td-agent/position/access_log.pos\n  types code:integer,size:integer\n</source>\n\n<match **>\n  type forward\n  send_timeout 60s\n  recover_wait 10s\n  heartbeat_interval 1s\n  phi_threshold 8\n  hard_timeout 60s\n  retry_limit 2\n  retry_wait 2s\n  max_retry_wait 30s\n  <server>\n    name es01\n    host 192.168.1.41\n    port 24224\n  </server>\n</match>\n```\n\n* \u30ea\u30c8\u30e9\u30a4\u3057\u3066\u3044\u308b\u9593\u306b\u30ce\u30fc\u30c9\u304c\u30c0\u30a6\u30f3\u3057\u3066\u3057\u307e\u3063\u305f\u3089\u30fb\u30fb\u30fb\u3068\u304b\u3001\u5927\u91cf\u306e\u30c7\u30fc\u30bf\u3092\u518d\u9001\u3059\u308b\u306e\u304c\u6016\u3044\u5834\u5408\u306f\u3001\u3042\u308b\u4e00\u5b9a\u306e\u30ea\u30c8\u30e9\u30a4\u56de\u6570\u3092\u8d85\u3048\u305f\u3089\u30d5\u30a1\u30a4\u30eb\u306b\u843d\u3068\u3057\u3066\u3057\u307e\u3046\u306e\u3082\u3042\u308a\u3060\u3068\u601d\u3044\u307e\u3059\u3002\n* \u30d5\u30a1\u30a4\u30eb\u306b\u843d\u3068\u3059\u306b\u306f<server>\u306e\u4e0b\u306b<secondary>\u3092\u8ffd\u8a18\u3057\u307e\u3059\u3002\n\n```\n  <secondary>\n    type file\n    path /var/log/td-agent/forward-failed\n  </secondary>\n```\n\n* \u3053\u306e\u3088\u3046\u306b\u3057\u3066\u304a\u304f\u3068/var/log/td-agent/forward-failed.tag\u540d_0.log\u306a\u3069\u3068\u3044\u3046\u30d5\u30a1\u30a4\u30eb\u304c\u3067\u304d\u3001\u3053\u3053\u304b\u3089\u5fa9\u65e7\u3059\u308b\u3053\u3068\u304c\u53ef\u80fd\u3067\u3059\u3002Elasticsearch\u306b\u5927\u91cf\u306e\u30c7\u30fc\u30bf\u3092\u6295\u5165\u3057\u76f4\u3059\u3068\u304d\u306frefresh_interval\u3092\u9577\u3081\u306b\u8a2d\u5b9a\u3057\u3066\u304a\u304f\u3053\u3068\u3082\u304a\u5fd8\u308c\u306a\u304f\u3002\n\n---\n\n### Active-Standby\u69cb\u6210\n\n* es01\u304c\u30c0\u30a6\u30f3\u3057\u305f\u5834\u5408\u306b\u3001es02\u306b\u9001\u308a\u305f\u3044\u3002\u3068\u3044\u3046\u5834\u5408\u306f<server>\u30bf\u30b0\u3092\u8ffd\u52a0\u3057\u3001standby\u5074\u306bstandby\u3068\u8a18\u8ff0\u3057\u307e\u3059\u3002\n* es01\u3078\u306e\u30d8\u30eb\u30b9\u30c1\u30a7\u30c3\u30af\u9593\u9694\u306fheartbeat_interval\u3067\u6307\u5b9a\u3055\u308c\u3066\u304a\u308a\u3001hard timeout\u3067\u6307\u5b9a\u3055\u308c\u305f\u79d2\u6570\u304c\u7d4c\u904e\u3059\u308b\u3068\u30c0\u30a6\u30f3\u3057\u305f\u3068\u898b\u306a\u3055\u308ces02\u306b\u9001\u308d\u3046\u3068\u3057\u307e\u3059\u3002\n* standby\u304c\u843d\u3061\u305f\u6642\u306e\u3053\u3068\u3092\u8003\u616e\u3057\u3066\u3001<secondary>\u3067\u30d5\u30a1\u30a4\u30eb\u306b\u843d\u3068\u3057\u3066\u304a\u304f\u3068\u5c1a\u826f\u3044\u3068\u601d\u308f\u308c\u307e\u3059\u3002\n\n```/etc/td-agent/td-agent.conf\n<source>\n  type tail\n  format apache2\n  path /var/log/httpd/access_log\n  tag test.apache.access\n  pos_file /var/log/td-agent/position/access_log.pos\n  types code:integer,size:integer\n</source>\n\n<match **>\n  type forward\n  send_timeout 60s\n  recover_wait 10s\n  heartbeat_interval 1s\n  phi_threshold 8\n  hard_timeout 60s\n  retry_limit 2\n  retry_wait 2s\n  max_retry_wait 30s\n  <server>\n    name es01\n    host 192.168.1.41\n    port 24224\n  </server>\n  <server>\n    name es02\n    host 192.168.1.42\n    port 24224\n    standby\n  </server>\n</match>\n```\n\n--- \n\n### \u8ca0\u8377\u5206\u6563\u69cb\u6210\n\n* es01\u3068es02\u306b\u8ca0\u8377\u5206\u6563\u3057\u305f\u3044\u5834\u5408\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n* weight\u3067\u504f\u308a\u3092\u8a2d\u5b9a\u3057\u307e\u3059\u3002\u5408\u8a08\u3067100\u3067\u3042\u308b\u5fc5\u8981\u306f\u306a\u304f\u3001\u5272\u5408\u3092\u8a18\u8f09\u3059\u308c\u3070\u826f\u3044\u3067\u3059\u3002\u3061\u306a\u307f\u306b\u30c7\u30d5\u30a9\u30eb\u30c8\u306f60\u3002\n\n```\n  <server>\n    name es01\n    host 192.168.1.41\n    port 24224\n    weight 60\n  </server>\n  <server>\n    name es02\n    host 192.168.1.42\n    port 24224\n    weight 60\n  </server>\n```\n\n---\n\n## [\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u30c1\u30e5\u30fc\u30cb\u30f3\u30b0](http://docs.fluentd.org/articles/performance-tuning)\n\n* \u516c\u5f0f\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u3092\u898b\u308b\u3068top\u30b3\u30de\u30f3\u30c9\u3068\u304b\u3067CPU,Memory,DiskIO\u3069\u308c\u304c\u30dc\u30c8\u30eb\u30cd\u30c3\u30af\u306a\u306e\u304b\u306f\u898b\u3066\u304a\u304f\u3068\u826f\u3044\u3088\u3002\u3068\u66f8\u304b\u308c\u3066\u3044\u307e\u3059\u3002\n* CPU\u304c\u591a\u304f\u306e\u5834\u5408\u30dc\u30c8\u30eb\u30cd\u30c3\u30af\u306b\u306a\u308b\u3088\u3046\u3067\u3001\u8907\u6570\u306eCPU\u30b3\u30a2\u3092\u5229\u7528\u3059\u308b\u305f\u3081in_multiprocess\u30d7\u30e9\u30b0\u30a4\u30f3\u3068\u3044\u3046\u306e\u3092\u4f7f\u3046\u3068\u826f\u3044\u3068\u306e\u3053\u3068\u3002\n* \u307e\u3041\u3001\u79c1\u304c\u4eca\u4ed5\u4e8b\u3067\u3084\u308d\u3046\u3068\u3057\u3066\u3044\u308b\u30e6\u30fc\u30b9\u30b1\u30fc\u30b9\u3067\u306f\u5fc5\u8981\u306b\u306a\u308b\u3053\u3068\u306f\u306a\u3055\u305d\u3046\u306a\u306e\u3067\u3059\u304c\u3001[\u3053\u3061\u3089\u306e\u8a18\u4e8b\u300c\u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b9 + \u30de\u30eb\u30c1\u30d7\u30ed\u30bb\u30b9\u5316\u3067 Fluentd \u306e\u30ed\u30b0\u53ce\u96c6\u3092\u52b9\u7387\u5316\u3059\u308b\u300d](http://im-sei.tumblr.com/post/73384019991/%E3%83%AD%E3%83%BC%E3%83%89%E3%83%90%E3%83%A9%E3%83%B3%E3%82%B9-%E3%83%9E%E3%83%AB%E3%83%81%E3%83%97%E3%83%AD%E3%82%BB%E3%82%B9%E5%8C%96%E3%81%A7-fluentd-%E3%81%AE%E3%83%AD%E3%82%B0%E5%8F%8E%E9%9B%86%E3%82%92%E5%8A%B9%E7%8E%87%E5%8C%96%E3%81%99%E3%82%8B)\u306b\u8a73\u3057\u304f\u8a18\u8f09\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n* \u4f7f\u3046\u304b\u4f7f\u308f\u306a\u3044\u304b\u306f\u304a\u3044\u3068\u3044\u3066\u3001\u3044\u3056\u3068\u3044\u3046\u6642\u306e\u70ba\u306b\u59cb\u3081\u304b\u3089\u5165\u308c\u3066\u304a\u3044\u3066\u3082\u826f\u3044\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u3002\n\n---\n\n## [UI](http://docs.fluentd.org/articles/fluentd-ui)\n\n* bootstrap\u3067\u4f5c\u3089\u308c\u305fUI\u3082\u7528\u610f\u3055\u308c\u3066\u3044\u308b\u3088\u3046\u3067\u3059\u3002\u65e5\u672c\u8a9e\u3067\u3059\u3002\u3061\u3087\u3063\u3068\u3073\u3063\u304f\u308a\u3057\u307e\u3057\u305f\u3002\n* \u8d77\u52d5\u3059\u308b\u306b\u306f\u3053\u3093\u306a\u611f\u3058\n\n```\n[root@es1 td-agent]# td-agent-ui start\nPuma 2.11.1 starting...\n* Min threads: 0, max threads: 16\n* Environment: production\n* Listening on tcp://0.0.0.0:9292\n```\n\n* \u4e0b\u8a18\u306eURL\u3067\u30a2\u30af\u30bb\u30b9\u3057\u3001\u30a2\u30ab\u30a6\u30f3\u30c8\u306fadmin\u3001\u30d1\u30b9\u30ef\u30fc\u30c9\u306fchangeme\u3067\u30ed\u30b0\u30a4\u30f3\u53ef\u80fd\u3067\u3059\u3002\u5229\u7528\u3059\u308b\u5834\u5408\u306f\u521d\u671f\u30d1\u30b9\u30ef\u30fc\u30c9\u3092\u5909\u66f4\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\n```\nhttp://host:9292/\n```\n\n* UI\u304b\u3089\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u3067\u304d\u305f\u308a\u3001\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3055\u308c\u3066\u3044\u308b\u30d7\u30e9\u30b0\u30a4\u30f3\u306e\u4e00\u89a7\u306a\u3069\u3092\u898b\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\u904b\u7528\u3067\u306f\u3042\u307e\u308a\u4f7f\u308f\u306a\u3044\u306e\u304b\u306a\u3002\n\n## \u53c2\u8003\n\n* [fluentd \u516c\u5f0f\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8](http://docs.fluentd.org/articles/quickstart)\n* [Fluentd\u306e\u4ed5\u7d44\u307f -\u30d0\u30c3\u30d5\u30a1\u6a5f\u80fd\u3067\u30ed\u30b0\u53ce\u96c6\u6f0f\u308c\u3092\u9632\u3050-](http://tech-sketch.jp/2013/05/fluentd-buffer.html)\n* [BufferedOutput plugin\u306e\u4ee3\u8868\u7684\u306aoption\u306b\u3064\u3044\u3066](http://qiita.com/tatsu-yam/items/bd7006e483f3b3c64309)\n* [Flunetd\u3001forward\u5148\u304c\u30c0\u30e1\u3060\u3063\u305f\u6642\u306bforward\u5143\u3067\u3042\u308b\u7a0b\u5ea6\u30ed\u30b0\u3092\u62c5\u4fdd\u3057\u305f\u3044](http://blog.kenjiskywalker.org/blog/2014/04/01/fluentd-buffer-forward/)\n* [Fluentd\u306e\u969c\u5bb3\u6642\u52d5\u4f5c](http://ogibayashi.github.io/blog/2014/06/04/how-fluentd-works-in-case-of-failures/)\n* [Elasticsearch\u5c0e\u5165\u524d\u306b\u6c17\u3092\u4ed8\u3051\u3066\u304a\u304d\u305f\u3044\u3053\u3068\uff01](http://qiita.com/uzresk/items/e0b10c14875b79c450f2)\n", "tags": ["fluentd", "Elasticsearch", "td-agent", "CentOS"]}