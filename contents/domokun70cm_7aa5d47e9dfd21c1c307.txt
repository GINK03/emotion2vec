{"tags": ["aws-cli"], "context": " More than 1 year has passed since last update.OpsWorks\u304cWindows Server\u3092\u30b5\u30dd\u30fc\u30c8\u3057\u305f\u306e\u3067\u3001AWS CLI\u3067\u8a66\u3057\u3066\u307f\u305f\n\u516c\u5f0f\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u306e\u624b\u9806\u3092\u53c2\u8003\u306b\u3057\u3066\u3044\u307e\u3059\u3002\nGetting Started with Windows Stacks\n\u3053\u3053\u3067\u306f\u3001\n\nIIS\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\u9759\u7684\u306aWeb\u30da\u30fc\u30b8\u3092\u914d\u7f6e\n\n\u3092\u884c\u3063\u3066\u3044\u307e\u3059\n\n\u524d\u63d0\u6761\u4ef6\n\nAdministratorAccess\u306e\u6a29\u9650\u3067\u5b9f\u884c\u3057\u307e\u3057\u305f\u3002\n\u6771\u4eac\u30ea\u30fc\u30b8\u30e7\u30f3\u3067\u5b9f\u884c\u3057\u307e\u3059\u3002\uff08\u305f\u3060\u3057\u3001OpsWorks\u306e\u30a8\u30f3\u30c9\u30dd\u30a4\u30f3\u30c8\u306fus-east-1\u306e\u307f\u3067\u3042\u308b\u305f\u3081\u3001aws opsworks\u30b3\u30de\u30f3\u30c9\u306f\u30ea\u30fc\u30b8\u30e7\u30f3\u3092\u6307\u5b9a\u3057\u3066\u5b9f\u884c\u3057\u3066\u3044\u307e\u3059\u3002\uff09\nVPC\u3001Subnet\u3001SSH Key\u306f\u4e8b\u524d\u306b\u4f5c\u6210\u3057\u305f\u3082\u306e\u3092\u4f7f\u7528\u3057\u307e\u3059\u3002\nService Role\u304a\u3088\u3073Instance Profile(IAM Role)\u3092\u4e8b\u524d\u306b\u4f5c\u6210\u3057\u307e\u3059\u3002\nCookbook\u304a\u3088\u3073Recipe\u3092\u4e8b\u524d\u306bS3\u3078\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u3057\u307e\u3059\u3002\nIIS\u306b\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u3059\u308b\u9759\u7684\u306aWeb\u30da\u30fc\u30b8\u3082S3\u3078\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u3057\u307e\u3059\u3002\n\n\u30ea\u30fc\u30b8\u30e7\u30f3\u306e\u6307\u5b9a\nexport AWS_DEFAULT_REGION=\"ap-northeast-1\"\n\nVPC\u304a\u3088\u3073Default Subnet\u306e\u6307\u5b9a\nVPC_ID=\"(vpc_id)\"\nSUBNET_ID=\"(subnet_id)\"\nKEY_PAIR_NAME=\"OpsWorks-for-Windows\"\n\nService Role\u306e\u4f5c\u6210\nSERVICE_ROLE_NAME=\"OpsWorks-for-Windows\"\nASSUME_ROLE_POLICY_DOCUMENT=\"assume-role-policy-document.json\"\n\ncat << EOF > ${ASSUME_ROLE_POLICY_DOCUMENT}\n{\n  \"Version\": \"2008-10-17\",\n  \"Statement\": [\n    {\n      \"Sid\": \"\",\n      \"Effect\": \"Allow\",\n      \"Principal\": {\n        \"Service\": \"opsworks.amazonaws.com\"\n      },\n      \"Action\": \"sts:AssumeRole\"\n    }\n  ]\n}\nEOF\n\naws iam create-role --role-name \"${SERVICE_ROLE_NAME}\" --assume-role-policy-document file://${ASSUME_ROLE_POLICY_DOCUMENT}\n\nAWS_ACCOUNT_ID=\"(aws-account)\"\nSERVICE_POLICY_NAME=\"opsworks-service-policy\"\nSERVICE_POLICY_ARN=\"arn:aws:iam::\"${AWS_ACCOUNT_ID}\":policy/\"${SERVICE_POLICY_NAME}\nOPSWORKS_SERVICE_POLICY_DOCUMENT=\"opsworks-service-policy-document.json\"\n\ncat << EOF > ${OPSWORKS_SERVICE_POLICY_DOCUMENT}\n{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Effect\": \"Allow\",\n      \"Action\": [\n        \"ec2:*\",\n        \"elasticloadbalancing:*\",\n        \"rds:*\",\n        \"cloudwatch:GetMetricStatistics\",\n        \"cloudwatch:DescribeAlarms\",\n        \"iam:PassRole\"\n      ],\n      \"Resource\": \"*\"\n    }\n  ]\n}\nEOF\n\naws iam create-policy --policy-name \"${SERVICE_POLICY_NAME}\" --policy-document file://${OPSWORKS_SERVICE_POLICY_DOCUMENT}\n\naws iam attach-role-policy --role-name \"${SERVICE_ROLE_NAME}\" --policy-arn ${SERVICE_POLICY_ARN}\n\n\nInstance Role\u306e\u4f5c\u6210\n\uff08Cokbook\u304a\u3088\u3073Recipe\u3092S3\u306b\u914d\u7f6e\u3059\u308b\u305f\u3081\u3001\u8aad\u307f\u53d6\u308a\u6a29\u9650\u3092\u4ed8\u4e0e\uff09\nINSTANCE_ROLE_NAME=\"OpsWorks-for-Windows-Instance\"\nASSUME_ROLE_POLICY_DOCUMENT_FOR_INSTANCE=\"assume-role-policy-document-for-instance.json\"\n\ncat << EOF > ${ASSUME_ROLE_POLICY_DOCUMENT_FOR_INSTANCE}\n{\n  \"Version\": \"2008-10-17\",\n  \"Statement\": [\n    {\n      \"Sid\": \"\",\n      \"Effect\": \"Allow\",\n      \"Principal\": {\n        \"Service\": \"ec2.amazonaws.com\"\n      },\n      \"Action\": \"sts:AssumeRole\"\n    }\n  ]\n}\nEOF\n\naws iam create-role --role-name \"${INSTANCE_ROLE_NAME}\" --assume-role-policy-document file://${ASSUME_ROLE_POLICY_DOCUMENT_FOR_INSTANCE}\n\nAWS_ACCOUNT_ID=\"(aws-account)\"\nINSTANCE_POLICY_NAME=\"opsworks-instance-policy\"\nINSTANCE_POLICY_ARN=\"arn:aws:iam::\"${AWS_ACCOUNT_ID}\":policy/\"${INSTANCE_POLICY_NAME}\nOPSWORKS_INSTANCE_POLICY_DOCUMENT=\"opsworks-instance-policy-document.json\"\n\ncat << EOF > ${OPSWORKS_INSTANCE_POLICY_DOCUMENT}\n{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Effect\": \"Allow\",\n      \"Action\": [\n        \"s3:Get*\",\n        \"s3:List*\"\n      ],\n      \"Resource\": \"*\"\n    }\n  ]\n}\nEOF\n\naws iam create-policy --policy-name \"${INSTANCE_POLICY_NAME}\" --policy-document file://${OPSWORKS_INSTANCE_POLICY_DOCUMENT}\n\naws iam attach-role-policy --role-name \"${INSTANCE_ROLE_NAME}\" --policy-arn ${INSTANCE_POLICY_ARN}\n\n\nINSTANCE_PROFILE_NAME=\"${INSTANCE_ROLE_NAME}\"\n\naws iam create-instance-profile --instance-profile-name ${INSTANCE_PROFILE_NAME}\n\naws iam add-role-to-instance-profile \\\n --instance-profile-name  ${INSTANCE_PROFILE_NAME} \\\n --role-name ${INSTANCE_ROLE_NAME}\n\nCOOKBOOK\n\nmetadata.rb\nname \"iis-cookbook\"\nversion \"0.1.0\"\n\n\nSetup\u7528Recipe\n\ninstall.rb\npowershell_script 'Install IIS' do\n  code 'Add-WindowsFeature Web-Server'\n  not_if \"(Get-WindowsFeature -Name Web-Server).Installed\"\nend\n\nservice 'w3svc' do\n  action [:start, :enable]\nend\n\n\n\nDeploy\u7528Recipes\n\ndeploy.rb\nchef_gem \"aws-sdk\" do\n  compile_time false\n  action :install\nend\n\nruby_block \"download-object\" do\n  block do\n    require 'aws-sdk'\n\n    #1\n    Aws.config[:ssl_ca_bundle] = 'C:\\ProgramData\\Git\\bin\\curl-ca-bundle.crt'\n\n    #2\n    query = Chef::Search::Query.new\n    app = query.search(:aws_opsworks_app, \"type:other\").first\n    s3region = app[0][:environment][:S3REGION]\n    s3bucket = app[0][:environment][:BUCKET]\n    s3filename = app[0][:environment][:FILENAME]\n\n    #3\n    s3_client = Aws::S3::Client.new(region: s3region)\n    s3_client.get_object(bucket: s3bucket,\n                         key: s3filename,\n                         response_target: 'C:\\inetpub\\wwwroot\\default.htm')\n  end\n  action :run\nend\n\n\n\u9759\u7684\u306aWeb\u30da\u30fc\u30b8\uff08default.htm\uff09\n<!DOCTYPE html>\n<html>\n  <head>\n    <title>IIS Example</title>\n  </head>\n  <body>\n    <h1>Hello World!</h1>\n  </body>\n</html>\n\n\nStack\u306e\u4f5c\u6210\nSTACK_NAME=\"WindowsStack\"\nDEFAULT_OS=\"Microsoft Windows Server 2012 R2 Base\"\nSERVICE_ROLE_ARN=\"arn:aws:iam::\"${AWS_ACCOUNT_ID}\":role/\"${SERVICE_ROLE_NAME}\nDEFAULT_ROOT_DEVICE_TYPE=\"ebs\"\nINSTANCE_PROFILE_ARN=\"arn:aws:iam::\"${AWS_ACCOUNT_ID}\":instance-profile/\"${INSTANCE_PROFILE_NAME}\n\nCUSTOM_COOKBOOKS_SOURCE=\"opsworks-custom-coockbooks-source.json\"\ncat << EOF > ${CUSTOM_COOKBOOKS_SOURCE}\n{\n  \"Type\": \"s3\",\n  \"Url\": \"https://s3-ap-northeast-1.amazonaws.com/opsworks-${AWS_ACCOUNT_ID}-cookbook/iis-cookbook.zip\"\n}\nEOF\n\nCONFIGURATION_MANAGER=\"configuration-manager.json\"\ncat << EOF > ${CONFIGURATION_MANAGER}\n{\n  \"Name\": \"Chef\",\n  \"Version\": \"12.2\"\n}\nEOF\n\naws opsworks create-stack \\\n --name \"${STACK_NAME}\" \\\n --stack-region ${AWS_DEFAULT_REGION} \\\n --service-role-arn ${SERVICE_ROLE_ARN} \\\n --default-instance-profile-arn ${INSTANCE_PROFILE_ARN} \\\n --vpc-id ${VPC_ID} \\\n --default-os \"${DEFAULT_OS}\" \\\n --default-subnet-id ${SUBNET_ID} \\\n --configuration-manager file://${CONFIGURATION_MANAGER} \\\n --use-custom-cookbooks \\\n --custom-cookbooks-source file://${CUSTOM_COOKBOOKS_SOURCE} \\\n --use-opsworks-security-groups \\\n --default-ssh-key-name \"${KEY_PAIR_NAME}\" \\\n --default-root-device-type \"${DEFAULT_ROOT_DEVICE_TYPE}\" \\\n --region \"us-east-1\"\n\n\n\nSecurity Group\u306e\u5909\u66f4\n\u81ea\u52d5\u7684\u306b\u4f5c\u6210\u3055\u308c\u308bSecurity Group AWS-OpsWorks-RDP-Server \u306bRDP\u3067\u30a2\u30af\u30bb\u30b9\u3067\u304d\u308b\u6a29\u9650\u3092\u4ed8\u4e0e\u3057\u307e\u3059\u3002\n\uff08\u30b9\u30af\u30ea\u30d7\u30c8\u306f\u5272\u611b\uff09\n\n\u30e6\u30fc\u30b6\u306e\u4f5c\u6210\nMANAGER_USER_NAME=\"ops-mngr\"\nMANAGER_USER_PASSWORD=\"**********\"\nMANAGER_USER_POLICY_ARN=\"arn:aws:iam::aws:policy/service-role/AWSOpsWorksRole\"\n\naws iam create-user --user-name ${MANAGER_USER_NAME}\n\naws iam create-login-profile \\\n --user-name ${MANAGER_USER_NAME} \\\n --password ${MANAGER_USER_PASSWORD} \\\n --no-password-reset-required\n\naws iam attach-user-policy --user-name ${MANAGER_USER_NAME} --policy-arn ${MANAGER_USER_POLICY_ARN}\n\n\n\nIAM\u30e6\u30fc\u30b6\u3078\u306e\u6a29\u9650\u306e\u4ed8\u4e0e\nSTACK_ID=\"********-****-****-****-************\"\nMANAGER_USER_ARN=\"arn:aws:iam::${AWS_ACCOUNT_ID}:user/${MANAGER_USER_NAME}\"\nPERMISSION_LEVEL=\"iam_only\"\n\naws opsworks create-user-profile --iam-user-arn ${MANAGER_USER_ARN} --region \"us-east-1\"\n\naws opsworks set-permission \\\n --stack-id ${STACK_ID} \\\n --iam-user-arn ${MANAGER_USER_ARN} \\\n --allow-ssh \\\n --allow-sudo \\\n --level ${PERMISSION_LEVEL} \\\n --region \"us-east-1\"\n\n\n\nLayer\u306e\u4f5c\u6210\nLAYER_TYPE=\"custom\"\nLAYER_NAME=\"IISExample\"\nLAYER_SHORTNAME=\"iisexample\"\n\nCUSTOM_RECIPES=\"custom-recipes.json\"\ncat << EOF > ${CUSTOM_RECIPES}\n{\n  \"Setup\": [\"iis-cookbook::install\"],\n  \"Deploy\": [\"iis-cookbook::deploy\"]\n}\nEOF\n\naws opsworks create-layer \\\n --stack-id ${STACK_ID} \\\n --type ${LAYER_TYPE} \\\n --name \"${LAYER_NAME}\" \\\n --shortname \"${LAYER_SHORTNAME}\" \\\n --custom-recipes file://${CUSTOM_RECIPES} \\\n --region \"us-east-1\"\n\n\nInstance\u306e\u4f5c\u6210\nLAYER_ID=\"********-****-****-****-************\"\nINSTANCE_TYPE=\"m3.large\"\n\naws opsworks create-instance \\\n --stack-id ${STACK_ID} \\\n --layer-ids ${LAYER_ID} \\\n --instance-type ${INSTANCE_TYPE} \\\n --region \"us-east-1\"\n\n\nApps\u306e\u4f5c\u6210\nAPPS_NAME=\"IIS-Example-App\"\nTYPE=\"other\"\n\nAPP_SOURCE=\"OpsWorks-app-source.json\"\ncat << EOF > ${APP_SOURCE}\n{\n  \"Type\": \"other\"\n}\nEOF\n\nENVIRONMENT_VARIABLES=\"Environment-Variables.json\"\ncat << EOF > ${ENVIRONMENT_VARIABLES}\n[\n  {\n    \"Key\": \"S3REGION\",\n    \"Value\": \"ap-northeast-1\",\n    \"Secure\": false\n  },\n  {\n    \"Key\": \"BUCKET\",\n    \"Value\": \"opsworks-${AWS_ACCOUNT_ID}-cookbook\",\n    \"Secure\": false\n  },\n  {\n    \"Key\": \"FILENAME\",\n    \"Value\": \"iis-application/default.htm\",\n    \"Secure\": false\n  }\n]\nEOF\n\naws opsworks create-app \\\n --stack-id ${STACK_ID} \\\n --name ${APPS_NAME} \\\n --type ${TYPE} \\\n --app-source file://${APP_SOURCE} \\\n --environment file://${ENVIRONMENT_VARIABLES} \\\n --region \"us-east-1\"\n\n\n\uff08\u52d5\u4f5c\u78ba\u8a8d\uff09Instance\u306e\u8d77\u52d5\nINSTANCE_ID=\"********-****-****-****-************\"\n\naws opsworks start-instance --instance-id ${INSTANCE_ID} --region \"us-east-1\"\n\naws opsworks stop-instance --instance-id ${INSTANCE_ID} --region \"us-east-1\"\n\nPublic DNS\u306b\u30d6\u30e9\u30a6\u30b6\u3067\u30a2\u30af\u30bb\u30b9\u3057\u3066\u3001Hello World\u3067\u304d\u305f\u3089\u6210\u529f\u3067\u3059\u3002\n\u307e\u305f\u3001Management Console\u306bssh(rdp)\u3092\u8a31\u53ef\u3057\u305fIAM\u30e6\u30fc\u30b6\u3067\u30ed\u30b0\u30a4\u30f3\u3057\u3001RDP\u3067\u30ed\u30b0\u30a4\u30f3\u3059\u308b\u305f\u3081\u306e\u30d1\u30b9\u30ef\u30fc\u30c9\u3092\u767a\u884c\u3059\u308b\u3053\u3068\u304c\u53ef\u80fd\u3067\u3059\u3002\n\uff08\u6b63\u5e38\u306b\u30ed\u30b0\u30a4\u30f3\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u308b\u307e\u3067\u3001\u6570\u5206\u304b\u304b\u308b\u3088\u3046\u3067\u3059\u3002\uff09\nOpsWorks\u304cWindows Server\u3092\u30b5\u30dd\u30fc\u30c8\u3057\u305f\u306e\u3067\u3001AWS CLI\u3067\u8a66\u3057\u3066\u307f\u305f\n\n\u516c\u5f0f\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u306e\u624b\u9806\u3092\u53c2\u8003\u306b\u3057\u3066\u3044\u307e\u3059\u3002\n\n[Getting Started with Windows Stacks](http://docs.aws.amazon.com/opsworks/latest/userguide/gettingstarted-windows.html)\n\n\u3053\u3053\u3067\u306f\u3001\n\n* IIS\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n* \u9759\u7684\u306aWeb\u30da\u30fc\u30b8\u3092\u914d\u7f6e\n\n\u3092\u884c\u3063\u3066\u3044\u307e\u3059\n\n# \u524d\u63d0\u6761\u4ef6\n* AdministratorAccess\u306e\u6a29\u9650\u3067\u5b9f\u884c\u3057\u307e\u3057\u305f\u3002\n* \u6771\u4eac\u30ea\u30fc\u30b8\u30e7\u30f3\u3067\u5b9f\u884c\u3057\u307e\u3059\u3002\uff08\u305f\u3060\u3057\u3001OpsWorks\u306e\u30a8\u30f3\u30c9\u30dd\u30a4\u30f3\u30c8\u306fus-east-1\u306e\u307f\u3067\u3042\u308b\u305f\u3081\u3001aws opsworks\u30b3\u30de\u30f3\u30c9\u306f\u30ea\u30fc\u30b8\u30e7\u30f3\u3092\u6307\u5b9a\u3057\u3066\u5b9f\u884c\u3057\u3066\u3044\u307e\u3059\u3002\uff09\n* VPC\u3001Subnet\u3001SSH Key\u306f\u4e8b\u524d\u306b\u4f5c\u6210\u3057\u305f\u3082\u306e\u3092\u4f7f\u7528\u3057\u307e\u3059\u3002\n* Service Role\u304a\u3088\u3073Instance Profile(IAM Role)\u3092\u4e8b\u524d\u306b\u4f5c\u6210\u3057\u307e\u3059\u3002\n* Cookbook\u304a\u3088\u3073Recipe\u3092\u4e8b\u524d\u306bS3\u3078\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u3057\u307e\u3059\u3002\n* IIS\u306b\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u3059\u308b\u9759\u7684\u306aWeb\u30da\u30fc\u30b8\u3082S3\u3078\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u3057\u307e\u3059\u3002\n\n\n\u30ea\u30fc\u30b8\u30e7\u30f3\u306e\u6307\u5b9a\n\n```bash\nexport AWS_DEFAULT_REGION=\"ap-northeast-1\"\n```\n\nVPC\u304a\u3088\u3073Default Subnet\u306e\u6307\u5b9a\n\n```bash\nVPC_ID=\"(vpc_id)\"\nSUBNET_ID=\"(subnet_id)\"\nKEY_PAIR_NAME=\"OpsWorks-for-Windows\"\n```\n\nService Role\u306e\u4f5c\u6210\n\n```bash\nSERVICE_ROLE_NAME=\"OpsWorks-for-Windows\"\nASSUME_ROLE_POLICY_DOCUMENT=\"assume-role-policy-document.json\"\n\ncat << EOF > ${ASSUME_ROLE_POLICY_DOCUMENT}\n{\n  \"Version\": \"2008-10-17\",\n  \"Statement\": [\n    {\n      \"Sid\": \"\",\n      \"Effect\": \"Allow\",\n      \"Principal\": {\n        \"Service\": \"opsworks.amazonaws.com\"\n      },\n      \"Action\": \"sts:AssumeRole\"\n    }\n  ]\n}\nEOF\n\naws iam create-role --role-name \"${SERVICE_ROLE_NAME}\" --assume-role-policy-document file://${ASSUME_ROLE_POLICY_DOCUMENT}\n\nAWS_ACCOUNT_ID=\"(aws-account)\"\nSERVICE_POLICY_NAME=\"opsworks-service-policy\"\nSERVICE_POLICY_ARN=\"arn:aws:iam::\"${AWS_ACCOUNT_ID}\":policy/\"${SERVICE_POLICY_NAME}\nOPSWORKS_SERVICE_POLICY_DOCUMENT=\"opsworks-service-policy-document.json\"\n\ncat << EOF > ${OPSWORKS_SERVICE_POLICY_DOCUMENT}\n{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Effect\": \"Allow\",\n      \"Action\": [\n        \"ec2:*\",\n        \"elasticloadbalancing:*\",\n        \"rds:*\",\n        \"cloudwatch:GetMetricStatistics\",\n        \"cloudwatch:DescribeAlarms\",\n        \"iam:PassRole\"\n      ],\n      \"Resource\": \"*\"\n    }\n  ]\n}\nEOF\n\naws iam create-policy --policy-name \"${SERVICE_POLICY_NAME}\" --policy-document file://${OPSWORKS_SERVICE_POLICY_DOCUMENT}\n\naws iam attach-role-policy --role-name \"${SERVICE_ROLE_NAME}\" --policy-arn ${SERVICE_POLICY_ARN}\n\n```\n\nInstance Role\u306e\u4f5c\u6210\n\uff08Cokbook\u304a\u3088\u3073Recipe\u3092S3\u306b\u914d\u7f6e\u3059\u308b\u305f\u3081\u3001\u8aad\u307f\u53d6\u308a\u6a29\u9650\u3092\u4ed8\u4e0e\uff09\n\n```bash\nINSTANCE_ROLE_NAME=\"OpsWorks-for-Windows-Instance\"\nASSUME_ROLE_POLICY_DOCUMENT_FOR_INSTANCE=\"assume-role-policy-document-for-instance.json\"\n\ncat << EOF > ${ASSUME_ROLE_POLICY_DOCUMENT_FOR_INSTANCE}\n{\n  \"Version\": \"2008-10-17\",\n  \"Statement\": [\n    {\n      \"Sid\": \"\",\n      \"Effect\": \"Allow\",\n      \"Principal\": {\n        \"Service\": \"ec2.amazonaws.com\"\n      },\n      \"Action\": \"sts:AssumeRole\"\n    }\n  ]\n}\nEOF\n\naws iam create-role --role-name \"${INSTANCE_ROLE_NAME}\" --assume-role-policy-document file://${ASSUME_ROLE_POLICY_DOCUMENT_FOR_INSTANCE}\n\nAWS_ACCOUNT_ID=\"(aws-account)\"\nINSTANCE_POLICY_NAME=\"opsworks-instance-policy\"\nINSTANCE_POLICY_ARN=\"arn:aws:iam::\"${AWS_ACCOUNT_ID}\":policy/\"${INSTANCE_POLICY_NAME}\nOPSWORKS_INSTANCE_POLICY_DOCUMENT=\"opsworks-instance-policy-document.json\"\n\ncat << EOF > ${OPSWORKS_INSTANCE_POLICY_DOCUMENT}\n{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Effect\": \"Allow\",\n      \"Action\": [\n        \"s3:Get*\",\n        \"s3:List*\"\n      ],\n      \"Resource\": \"*\"\n    }\n  ]\n}\nEOF\n\naws iam create-policy --policy-name \"${INSTANCE_POLICY_NAME}\" --policy-document file://${OPSWORKS_INSTANCE_POLICY_DOCUMENT}\n\naws iam attach-role-policy --role-name \"${INSTANCE_ROLE_NAME}\" --policy-arn ${INSTANCE_POLICY_ARN}\n\n\nINSTANCE_PROFILE_NAME=\"${INSTANCE_ROLE_NAME}\"\n\naws iam create-instance-profile --instance-profile-name ${INSTANCE_PROFILE_NAME}\n\naws iam add-role-to-instance-profile \\\n --instance-profile-name  ${INSTANCE_PROFILE_NAME} \\\n --role-name ${INSTANCE_ROLE_NAME}\n```\n\nCOOKBOOK\n\n```rb:metadata.rb\nname \"iis-cookbook\"\nversion \"0.1.0\"\n```\n\nSetup\u7528Recipe\n\n```rb:install.rb\npowershell_script 'Install IIS' do\n  code 'Add-WindowsFeature Web-Server'\n  not_if \"(Get-WindowsFeature -Name Web-Server).Installed\"\nend\n\nservice 'w3svc' do\n  action [:start, :enable]\nend\n\n```\n\nDeploy\u7528Recipes\n\n```rb:deploy.rb\nchef_gem \"aws-sdk\" do\n  compile_time false\n  action :install\nend\n\nruby_block \"download-object\" do\n  block do\n    require 'aws-sdk'\n\n    #1\n    Aws.config[:ssl_ca_bundle] = 'C:\\ProgramData\\Git\\bin\\curl-ca-bundle.crt'\n\n    #2\n    query = Chef::Search::Query.new\n    app = query.search(:aws_opsworks_app, \"type:other\").first\n    s3region = app[0][:environment][:S3REGION]\n    s3bucket = app[0][:environment][:BUCKET]\n    s3filename = app[0][:environment][:FILENAME]\n\n    #3\n    s3_client = Aws::S3::Client.new(region: s3region)\n    s3_client.get_object(bucket: s3bucket,\n                         key: s3filename,\n                         response_target: 'C:\\inetpub\\wwwroot\\default.htm')\n  end\n  action :run\nend\n```\n\n\u9759\u7684\u306aWeb\u30da\u30fc\u30b8\uff08default.htm\uff09\n\n```html\n<!DOCTYPE html>\n<html>\n  <head>\n    <title>IIS Example</title>\n  </head>\n  <body>\n    <h1>Hello World!</h1>\n  </body>\n</html>\n```\n\n\n# Stack\u306e\u4f5c\u6210\n\n```bash\nSTACK_NAME=\"WindowsStack\"\nDEFAULT_OS=\"Microsoft Windows Server 2012 R2 Base\"\nSERVICE_ROLE_ARN=\"arn:aws:iam::\"${AWS_ACCOUNT_ID}\":role/\"${SERVICE_ROLE_NAME}\nDEFAULT_ROOT_DEVICE_TYPE=\"ebs\"\nINSTANCE_PROFILE_ARN=\"arn:aws:iam::\"${AWS_ACCOUNT_ID}\":instance-profile/\"${INSTANCE_PROFILE_NAME}\n\nCUSTOM_COOKBOOKS_SOURCE=\"opsworks-custom-coockbooks-source.json\"\ncat << EOF > ${CUSTOM_COOKBOOKS_SOURCE}\n{\n  \"Type\": \"s3\",\n  \"Url\": \"https://s3-ap-northeast-1.amazonaws.com/opsworks-${AWS_ACCOUNT_ID}-cookbook/iis-cookbook.zip\"\n}\nEOF\n\nCONFIGURATION_MANAGER=\"configuration-manager.json\"\ncat << EOF > ${CONFIGURATION_MANAGER}\n{\n  \"Name\": \"Chef\",\n  \"Version\": \"12.2\"\n}\nEOF\n\naws opsworks create-stack \\\n --name \"${STACK_NAME}\" \\\n --stack-region ${AWS_DEFAULT_REGION} \\\n --service-role-arn ${SERVICE_ROLE_ARN} \\\n --default-instance-profile-arn ${INSTANCE_PROFILE_ARN} \\\n --vpc-id ${VPC_ID} \\\n --default-os \"${DEFAULT_OS}\" \\\n --default-subnet-id ${SUBNET_ID} \\\n --configuration-manager file://${CONFIGURATION_MANAGER} \\\n --use-custom-cookbooks \\\n --custom-cookbooks-source file://${CUSTOM_COOKBOOKS_SOURCE} \\\n --use-opsworks-security-groups \\\n --default-ssh-key-name \"${KEY_PAIR_NAME}\" \\\n --default-root-device-type \"${DEFAULT_ROOT_DEVICE_TYPE}\" \\\n --region \"us-east-1\"\n\n```\n\n# Security Group\u306e\u5909\u66f4\n\n\u81ea\u52d5\u7684\u306b\u4f5c\u6210\u3055\u308c\u308bSecurity Group **AWS-OpsWorks-RDP-Server** \u306bRDP\u3067\u30a2\u30af\u30bb\u30b9\u3067\u304d\u308b\u6a29\u9650\u3092\u4ed8\u4e0e\u3057\u307e\u3059\u3002\n\n\uff08\u30b9\u30af\u30ea\u30d7\u30c8\u306f\u5272\u611b\uff09\n\n# \u30e6\u30fc\u30b6\u306e\u4f5c\u6210\n\n```bash\nMANAGER_USER_NAME=\"ops-mngr\"\nMANAGER_USER_PASSWORD=\"**********\"\nMANAGER_USER_POLICY_ARN=\"arn:aws:iam::aws:policy/service-role/AWSOpsWorksRole\"\n\naws iam create-user --user-name ${MANAGER_USER_NAME}\n\naws iam create-login-profile \\\n --user-name ${MANAGER_USER_NAME} \\\n --password ${MANAGER_USER_PASSWORD} \\\n --no-password-reset-required\n\naws iam attach-user-policy --user-name ${MANAGER_USER_NAME} --policy-arn ${MANAGER_USER_POLICY_ARN}\n\n```\n\n# IAM\u30e6\u30fc\u30b6\u3078\u306e\u6a29\u9650\u306e\u4ed8\u4e0e\n\n```bash\nSTACK_ID=\"********-****-****-****-************\"\nMANAGER_USER_ARN=\"arn:aws:iam::${AWS_ACCOUNT_ID}:user/${MANAGER_USER_NAME}\"\nPERMISSION_LEVEL=\"iam_only\"\n\naws opsworks create-user-profile --iam-user-arn ${MANAGER_USER_ARN} --region \"us-east-1\"\n\naws opsworks set-permission \\\n --stack-id ${STACK_ID} \\\n --iam-user-arn ${MANAGER_USER_ARN} \\\n --allow-ssh \\\n --allow-sudo \\\n --level ${PERMISSION_LEVEL} \\\n --region \"us-east-1\"\n\n```\n\n# Layer\u306e\u4f5c\u6210\n\n```bash\nLAYER_TYPE=\"custom\"\nLAYER_NAME=\"IISExample\"\nLAYER_SHORTNAME=\"iisexample\"\n\nCUSTOM_RECIPES=\"custom-recipes.json\"\ncat << EOF > ${CUSTOM_RECIPES}\n{\n  \"Setup\": [\"iis-cookbook::install\"],\n  \"Deploy\": [\"iis-cookbook::deploy\"]\n}\nEOF\n\naws opsworks create-layer \\\n --stack-id ${STACK_ID} \\\n --type ${LAYER_TYPE} \\\n --name \"${LAYER_NAME}\" \\\n --shortname \"${LAYER_SHORTNAME}\" \\\n --custom-recipes file://${CUSTOM_RECIPES} \\\n --region \"us-east-1\"\n```\n\n\n# Instance\u306e\u4f5c\u6210\n\n```bash\nLAYER_ID=\"********-****-****-****-************\"\nINSTANCE_TYPE=\"m3.large\"\n\naws opsworks create-instance \\\n --stack-id ${STACK_ID} \\\n --layer-ids ${LAYER_ID} \\\n --instance-type ${INSTANCE_TYPE} \\\n --region \"us-east-1\"\n```\n\n# Apps\u306e\u4f5c\u6210\n\n```bash\nAPPS_NAME=\"IIS-Example-App\"\nTYPE=\"other\"\n\nAPP_SOURCE=\"OpsWorks-app-source.json\"\ncat << EOF > ${APP_SOURCE}\n{\n  \"Type\": \"other\"\n}\nEOF\n\nENVIRONMENT_VARIABLES=\"Environment-Variables.json\"\ncat << EOF > ${ENVIRONMENT_VARIABLES}\n[\n  {\n    \"Key\": \"S3REGION\",\n    \"Value\": \"ap-northeast-1\",\n    \"Secure\": false\n  },\n  {\n    \"Key\": \"BUCKET\",\n    \"Value\": \"opsworks-${AWS_ACCOUNT_ID}-cookbook\",\n    \"Secure\": false\n  },\n  {\n    \"Key\": \"FILENAME\",\n    \"Value\": \"iis-application/default.htm\",\n    \"Secure\": false\n  }\n]\nEOF\n\naws opsworks create-app \\\n --stack-id ${STACK_ID} \\\n --name ${APPS_NAME} \\\n --type ${TYPE} \\\n --app-source file://${APP_SOURCE} \\\n --environment file://${ENVIRONMENT_VARIABLES} \\\n --region \"us-east-1\"\n```\n\n# \uff08\u52d5\u4f5c\u78ba\u8a8d\uff09Instance\u306e\u8d77\u52d5\n\n```bash\nINSTANCE_ID=\"********-****-****-****-************\"\n\naws opsworks start-instance --instance-id ${INSTANCE_ID} --region \"us-east-1\"\n\naws opsworks stop-instance --instance-id ${INSTANCE_ID} --region \"us-east-1\"\n```\n\nPublic DNS\u306b\u30d6\u30e9\u30a6\u30b6\u3067\u30a2\u30af\u30bb\u30b9\u3057\u3066\u3001Hello World\u3067\u304d\u305f\u3089\u6210\u529f\u3067\u3059\u3002\n\n\n\u307e\u305f\u3001Management Console\u306bssh(rdp)\u3092\u8a31\u53ef\u3057\u305fIAM\u30e6\u30fc\u30b6\u3067\u30ed\u30b0\u30a4\u30f3\u3057\u3001RDP\u3067\u30ed\u30b0\u30a4\u30f3\u3059\u308b\u305f\u3081\u306e\u30d1\u30b9\u30ef\u30fc\u30c9\u3092\u767a\u884c\u3059\u308b\u3053\u3068\u304c\u53ef\u80fd\u3067\u3059\u3002\n\uff08\u6b63\u5e38\u306b\u30ed\u30b0\u30a4\u30f3\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u308b\u307e\u3067\u3001\u6570\u5206\u304b\u304b\u308b\u3088\u3046\u3067\u3059\u3002\uff09\n"}