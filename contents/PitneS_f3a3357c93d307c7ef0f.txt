{"context": " More than 1 year has passed since last update.\n\n\u6a5f\u80fd\u6982\u8981 What you can do by reading this article\ndev1.domain.tld\u3067\u30a2\u30af\u30bb\u30b9\u3057\u305f\u3068\u304d\u306fdev1\u306eMinecraft\u30b5\u30fc\u30d0\u3078\u3001\ndev2.domain.tld\u3067\u30a2\u30af\u30bb\u30b9\u3057\u305f\u3068\u304d\u306fdev2\u306eMinecraft\u30b5\u30fc\u30d0\u3078\u30a2\u30af\u30bb\u30b9\u3067\u304d\u308b\u3088\u3046\u306b\u3059\u308b\u3002\n\u305f\u3060\u3057\u3001dev1.domain.tld\u3082\u3001dev2.domain.tld\u3082\u3001\u540c\u3058\u30b0\u30ed\u30fc\u30d0\u30ebIP\u3092\u6307\u3059\u3082\u306e\u3068\u3059\u308b\u3002\nRouting connections of Minecraft based on their domain names such as dev1.domain.tld or dev2.domain.ld WHILE those domains point the same global ip address.\n\n\u65b9\u6cd5\u6982\u8981 Logic explanation\nHAProxy(L7\u30d7\u30ed\u30ad\u30b7)\u3092\u4f7f\u3046\u3002\nMinecraft\u306e\u63a5\u7d9a\u78ba\u7acb\u6642\u306e\u901a\u4fe1\u5185\u5bb9\uff08\u30c9\u30e1\u30a4\u30f3\u540d\u304c\u542b\u307e\u308c\u308b\uff09\u3092\u4e00\u90e8\u8aad\u307f\u53d6\u308a\u3001\u305d\u306e\u5185\u5bb9\u306b\u5fdc\u3058\u3066\u30eb\u30fc\u30c6\u30a3\u30f3\u30b0\u5148\u3092\u5236\u5fa1\u3059\u308b\u3002\nWe use the Layer-7 proxy called HAProxy. Based on the payload information in the tcp packet after TCP handshake, determine to where the following packets go.\n\n\u74b0\u5883 Environment\nCentOS 7.1\nCraft Bukkit 1.8.8\nHAProxy 1.5.14-3.el7\n\n\u624b\u9806 How to\n\u8a73\u3057\u304f\u306f\u3053\u3053\u3092\u3002\n\nfrontend\u3068\u3057\u3066\u4ee5\u4e0b\u3092\u8a18\u8ff0\u3002\n\n\nmode, bind, tcp-request\n\n\n\n/etc/haproxy/haproxy.cfg\nfrontend minecraft\n    mode tcp                                  # Minecraft\u306fTCP\u63a5\u7d9a\n    bind 0.0.0.0:25565                        # Minecraft\u30dd\u30fc\u30c8(25565)\u3067\u5f85\u3061\u53d7\u3051\n    tcp-request inspect-delay 5s              # \u6700\u59275\u79d2\u306e\u9045\u5ef6\u307e\u3067OK\uff08SSL\u3084SMTP\u3067\u306f\u5fc5\u8981\u3060\u3051\u3069Minecraft\u3067\u306f\u8981\u3089\u306a\u3044\u304b\u3082\uff09\n\n    acl mc_dev1_flg payload(4,4) -m sub dev1  # \u30c9\u30e1\u30a4\u30f3\u540d\u306e\u5148\u982d4\u6587\u5b57\u304cdev1\u306a\u3089\n    tcp-request content accept if mc_dev1_flg # \u53d7\u3051\u5165\u308c\u308b\n    use_backend mc_dev1_app if mc_dev1_flg    # mc_dev1_app\u306e\u30d0\u30c3\u30af\u30a8\u30f3\u30c9\u3078\n\n    acl mc_dev2_flg payload(4,4) -m sub dev2\n    tcp-request content accept if mc_dev2_flg\n    use_backend mc_dev2_app if mc_dev2_flg\n\n\n\nbackend\u3068\u3057\u3066\u4ee5\u4e0b\u3092\u8a18\u8ff0\u3002\n\n/etc/haproxy/haproxy.cfg\nbackend mc_dev1_app\n    server mc_dev1_srv 10.0.0.1  # \u540c\u3058\u30dd\u30fc\u30c8\u3078\u306a\u3089\u30dd\u30fc\u30c8\u6307\u5b9a\u8981\u3089\u305a\n\nbackend mc_dev2_app\n    server mc_dev2_srv 10.0.0.2  # 10.0.0.1:25564 \u3068\u304b\u3067\u3082OK\n\n\n\n\u7d50\u679c Result\n\u697d\u3057\u3044\u3002XD\n#\u6a5f\u80fd\u6982\u8981 What you can do by reading this article\ndev1.domain.tld\u3067\u30a2\u30af\u30bb\u30b9\u3057\u305f\u3068\u304d\u306fdev1\u306eMinecraft\u30b5\u30fc\u30d0\u3078\u3001\ndev2.domain.tld\u3067\u30a2\u30af\u30bb\u30b9\u3057\u305f\u3068\u304d\u306fdev2\u306eMinecraft\u30b5\u30fc\u30d0\u3078\u30a2\u30af\u30bb\u30b9\u3067\u304d\u308b\u3088\u3046\u306b\u3059\u308b\u3002\n\u305f\u3060\u3057\u3001dev1.domain.tld\u3082\u3001dev2.domain.tld\u3082\u3001\u540c\u3058\u30b0\u30ed\u30fc\u30d0\u30ebIP\u3092\u6307\u3059\u3082\u306e\u3068\u3059\u308b\u3002\n`Routing connections of Minecraft based on their domain names such as dev1.domain.tld or dev2.domain.ld WHILE those domains point the same global ip address.`\n\n#\u65b9\u6cd5\u6982\u8981 Logic explanation\nHAProxy(L7\u30d7\u30ed\u30ad\u30b7)\u3092\u4f7f\u3046\u3002\nMinecraft\u306e\u63a5\u7d9a\u78ba\u7acb\u6642\u306e\u901a\u4fe1\u5185\u5bb9\uff08\u30c9\u30e1\u30a4\u30f3\u540d\u304c\u542b\u307e\u308c\u308b\uff09\u3092\u4e00\u90e8\u8aad\u307f\u53d6\u308a\u3001\u305d\u306e\u5185\u5bb9\u306b\u5fdc\u3058\u3066\u30eb\u30fc\u30c6\u30a3\u30f3\u30b0\u5148\u3092\u5236\u5fa1\u3059\u308b\u3002\n`We use the Layer-7 proxy called HAProxy. Based on the payload information in the tcp packet after TCP handshake, determine to where the following packets go.`\n\n#\u74b0\u5883 Environment\nCentOS 7.1\nCraft Bukkit 1.8.8\nHAProxy 1.5.14-3.el7\n\n#\u624b\u9806 How to\n\u8a73\u3057\u304f\u306f[\u3053\u3053](http://cbonte.github.io/haproxy-dconv/configuration-1.7.html)\u3092\u3002\n\n##frontend\u3068\u3057\u3066\u4ee5\u4e0b\u3092\u8a18\u8ff0\u3002\n\n - [x] [mode](http://cbonte.github.io/haproxy-dconv/configuration-1.7.html#4.2-mode), [bind](http://cbonte.github.io/haproxy-dconv/configuration-1.7.html#4.2-bind), [tcp-request](http://cbonte.github.io/haproxy-dconv/configuration-1.7.html#4.2-tcp-request%20inspect-delay)\n\n```file:/etc/haproxy/haproxy.cfg\nfrontend minecraft\n    mode tcp                                  # Minecraft\u306fTCP\u63a5\u7d9a\n    bind 0.0.0.0:25565                        # Minecraft\u30dd\u30fc\u30c8(25565)\u3067\u5f85\u3061\u53d7\u3051\n    tcp-request inspect-delay 5s              # \u6700\u59275\u79d2\u306e\u9045\u5ef6\u307e\u3067OK\uff08SSL\u3084SMTP\u3067\u306f\u5fc5\u8981\u3060\u3051\u3069Minecraft\u3067\u306f\u8981\u3089\u306a\u3044\u304b\u3082\uff09\n\n    acl mc_dev1_flg payload(4,4) -m sub dev1  # \u30c9\u30e1\u30a4\u30f3\u540d\u306e\u5148\u982d4\u6587\u5b57\u304cdev1\u306a\u3089\n    tcp-request content accept if mc_dev1_flg # \u53d7\u3051\u5165\u308c\u308b\n    use_backend mc_dev1_app if mc_dev1_flg    # mc_dev1_app\u306e\u30d0\u30c3\u30af\u30a8\u30f3\u30c9\u3078\n\n    acl mc_dev2_flg payload(4,4) -m sub dev2\n    tcp-request content accept if mc_dev2_flg\n    use_backend mc_dev2_app if mc_dev2_flg\n```\n\n##backend\u3068\u3057\u3066\u4ee5\u4e0b\u3092\u8a18\u8ff0\u3002\n\n```file:/etc/haproxy/haproxy.cfg\nbackend mc_dev1_app\n\tserver mc_dev1_srv 10.0.0.1  # \u540c\u3058\u30dd\u30fc\u30c8\u3078\u306a\u3089\u30dd\u30fc\u30c8\u6307\u5b9a\u8981\u3089\u305a\n\nbackend mc_dev2_app\n\tserver mc_dev2_srv 10.0.0.2  # 10.0.0.1:25564 \u3068\u304b\u3067\u3082OK\n```\n\n#\u7d50\u679c Result\n\u697d\u3057\u3044\u3002`XD`\n", "tags": ["haproxy", "minecraft", "VirtualHost"]}