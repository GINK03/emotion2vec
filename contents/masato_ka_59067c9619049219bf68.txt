{"tags": ["ESP8266", "ESP-WROOM-02", "ADMP441", "SPI", "Arduino"], "context": "\n\n1. \u306f\u3058\u3081\u306b\n\u672c\u8a18\u4e8b\u3067\u306f\u30c7\u30b8\u30bf\u30eb\u30de\u30a4\u30afADMP441\u3092\u4f7f\u3044ESP-WROOM-02\u3067\u97f3\u58f0\u3092\u96c6\u97f3\u3059\u308b\u65b9\u6cd5\u3092\u7d39\u4ecb\u3057\u307e\u3059\u3002\n\u4ee5\u4e0b\u306e\u5185\u5bb9\u306b\u3064\u3044\u3066\u89e6\u308c\u307e\u3059\u3002\n\nADMP441\u3068ESP-WROOM-02\u3068\u306e\u63a5\u7d9a(SPI)\n\u97f3\u58f0\u30c7\u30fc\u30bf\u3092\u30b7\u30ea\u30a2\u30eb\u3067\u53d6\u5f97\u3059\u308b\n\n\u4eca\u56de\u306f16bit 8kHz\u306e\u30d5\u30a9\u30fc\u30de\u30c3\u30c8\u30672\u79d2\u7a0b\u5ea6\u306e\u97f3\u58f0\u30c7\u30fc\u30bf\u3092\u53ce\u9332\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3057\u305f\u3002\u53ce\u9332\u79d2\u6570\u306fESP-WROOM-02\u306e\u30cf\u30fc\u30c9\u30a6\u30a7\u30a2\u7684\u4ed5\u69d8\u306b\u3088\u308b\u3082\u306e\u3067\u3059\u3002(\u30e6\u30fc\u30b6\u30e9\u30f3\u30c9\u306eRAM\u30b5\u30a4\u30ba\u8d77\u56e0)\n \u307e\u305f\u3001 \u30c7\u30fc\u30bf\u306e\u53d6\u5f97\u3068\u5916\u90e8\u3078\u306e\u9001\u4fe1\u306f\u540c\u6642\u306b\u3067\u304d\u307e\u305b\u3093\u3002\uff08\u73fe\u5728\u30c1\u30e3\u30ec\u30f3\u30b8\u4e2d\uff09\nADMP441\u81ea\u4f53\u306f\u5ec3\u76e4?\u306b\u306a\u3063\u305f\u3088\u3046\u3067\u3059\u304c\u3001\u79cb\u6708\u306a\u3069\u306e\u5728\u5eab\u306f\u307e\u3060\u3042\u308a\u305d\u3046\u3067\u3059\u3002\n\u672c\u8a18\u4e8b\u306f\u96fb\u5b50\u56de\u8def\u306e\u77e5\u8b58\u304c\u5fc5\u8981\u3067\u3059\u3002\u5b9f\u65bd\u306f\u5404\u4eba\u306e\u8cac\u4efb\u3067\u304a\u9858\u3044\u3044\u305f\u3057\u307e\u3059\u3002\n\n2. \u5229\u7528\u65b9\u6cd5\u306e\u691c\u8a0e\n\n2.1 ADMP441\u306e\u6982\u8981\n\u3000\nADMP441\u306fMEMS\u30de\u30a4\u30af\u3001\u30a2\u30f3\u30d7\u3001A/D\u5909\u63db\u3001\u30c7\u30b8\u30bf\u30eb\u30d5\u30a3\u30eb\u30bf\u3092\u30ef\u30f3\u30d1\u30c3\u30b1\u30fc\u30b8\u306b\u53ce\u3081\u305f\u30c7\u30b8\u30bf\u30eb\u30de\u30a4\u30af\u30e2\u30b8\u30e5\u30fc\u30eb\u3067\u3059\u3002\u51fa\u529b\u306fI2S\u3068\u547c\u3070\u308c\u308b3\u7dda\u306e\u30b7\u30ea\u30a2\u30eb\u901a\u4fe1\u3092\u5229\u7528\u3057\u307e\u3059\u30023\u7dda\u306f\u305d\u308c\u305e\u308c\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u6a5f\u80fd\u5272\u308a\u5f53\u3066\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002\n\n\n\n\u540d\u79f0\n\u6a5f\u80fd\n\n\n\n\nSCK\n\u540c\u671f\u30af\u30ed\u30c3\u30af(500kHz\u301c3MHz\u7a0b\u5ea6\u307e\u3067)\u30af\u30ed\u30c3\u30af\u306b\u5fdc\u3058\u3066\u30b5\u30f3\u30d7\u30ea\u30f3\u30b0\u5468\u6ce2\u6570\u304c\u5909\u308f\u308b\n\n\nSD\n\u97f3\u58f0\u306e\u30c7\u30fc\u30bf\u4fe1\u53f7(1\u30af\u30ed\u30c3\u30af\u3054\u3068\u306b1bit)\n\n\nWS\nL\u5074R\u5074\u306e\u51fa\u529b\u30bb\u30ec\u30af\u30bf\u4fe1\u53f7SCK\u306e64\u500d\u306e\u5468\u671f(SD\u306e64bit\u5206)\u3067\u52d5\u4f5c\u3055\u305b\u308b\u3002\n\n\n\n\u624b\u306b\u5165\u308c\u3084\u3059\u3044\u88fd\u54c1\u3068\u3057\u3066\u306f\u4ee5\u4e0b\u306e\uff12\u3064\u304c\u3042\u308a\u307e\u3059\u3002\u672c\u8a18\u4e8b\u3067\u306f1\u756a\u306e\u79cb\u6708\u96fb\u5b50\u306e\u88fd\u54c1\u3092\u5229\u7528\u3057\u307e\u3057\u305f\u3002\n\nhttp://akizukidenshi.com/catalog/g/gK-06864/\nhttps://strawberry-linux.com/catalog/items?code=12036\n\n\n2.2 ADMP441\u306e\u52d5\u4f5c\n\nADMP441\u306e\u30d4\u30f3\u914d\u7f6e\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002\n\n\n\n\u30d4\u30f3\u756a\u53f7\n\u540d\u79f0\n\u6a5f\u80fd\n\n\n\n\n1\nSCK\nI2S\u306e\u52d5\u4f5c\u30af\u30ed\u30c3\u30af\u5165\u529b(500kHz\u301c3MHz)\n\n\n2\nSD\n\u30c7\u30fc\u30bf\u51fa\u529b\n\n\n3\nWS\nLR\u30bb\u30ec\u30af\u30bf\u5165\u529b(Low\u3067L\u5074\u30c7\u30fc\u30bf\u51fa\u529b)\n\n\n4\nL/R\n\u30de\u30a4\u30af\u306eL/R\u9078\u629e(GND\u63a5\u7d9a\u3067L\u5074\u51fa\u529b)\n\n\n5\nGND\n\u30b0\u30e9\u30f3\u30c9\n\n\n6\nVDD\n3.3V\n\n\n7\nEN\n\u30c1\u30c3\u30d7\u30a4\u30cd\u30fc\u30d6\u30eb(VDD\u63a5\u7d9a)\n\n\n8\nGND\n\u30b0\u30e9\u30f3\u30c9\n\n\n\nADMP441\u306f1\u756a\u30d4\u30f3\u306eSCK\u30af\u30ed\u30c3\u30af\u3068WS\u30af\u30ed\u30c3\u30af\u5165\u529b\u306b\u5f93\u3063\u3066\u52d5\u4f5c\u3092\u958b\u59cb\u3057\u307e\u3059\u30022^18\u4e57\u5206\u306eSCK\u30af\u30ed\u30c3\u30af\u3092\u53d7\u3051\u308b\u3068SD\u30d4\u30f3\u304b\u3089\u30c7\u30fc\u30bf\u3092\u51fa\u529b\u3057\u307e\u3059\u3002\n\u3000SD\u304b\u3089\u306fSCK\u30af\u30ed\u30c3\u30af\u306e\u7acb\u3061\u4e0a\u304c\u308a\u306e\u30bf\u30a4\u30df\u30f3\u30b0(Low->High)\u30671bit\u5206\u306e\u30c7\u30fc\u30bf\u304c\u51fa\u529b\u3055\u308c\u307e\u3059\u3002\u307e\u305fL/R\u30c1\u30e3\u30f3\u30cd\u30eb\u9078\u629e(\uff14\u756a\u30d4\u30f3)\u306e\u8a2d\u5b9a\u306b\u5f93\u3044\u3001WS\u30d4\u30f3\u306b\u5165\u529b\u3055\u308c\u308b\u30af\u30ed\u30c3\u30af\u306b\u540c\u671f\u3057\u3066L/R\u306b\u5206\u3051\u3066\u51fa\u529b\u3055\u308c\u307e\u3059\u3002\n\u3000SD\u304b\u3089\u51fa\u529b\u3055\u308c\u308b\u30c7\u30fc\u30bf\u306f\u30e2\u30ce\u30e9\u30eb1\u30c1\u30e3\u30f3\u30cd\u30eb\u5206\u306732bit\u306e\u30c7\u30fc\u30bf\u306b\u306a\u308a\u307e\u3059\u3002\u305d\u306e\u305f\u3081\u3001WS\u306b\u5165\u529b\u3059\u308b\u30af\u30ed\u30c3\u30af\u306fSCK\u306e32\u30af\u30ed\u30c3\u30af\u3054\u3068\u306b\u5207\u308a\u66ff\u3048\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\u3000\u53d6\u5f97\u3055\u308c\u308b\u30c7\u30fc\u30bf\u306f\u7247\u507432bit\u3067\u3059\u304c\u5b9f\u969b\u306b\u6709\u52b9\u306a\u30c7\u30fc\u30bf\u306f24bit\u306e\u30c7\u30fc\u30bf\u304c\u53d6\u5f97\u3055\u308c\u308b\u306e\u3067\u3001\u5148\u982d1bit\u3068\u5f8c\u308d7bit\u306f\u30bd\u30d5\u30c8\u30a6\u30a7\u30a2\u7684\u306b\u9664\u53bb\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\u3000\u524d\u8ff0\u306e\u3088\u3046\u306bL/R\u306e\u8a2d\u5b9a\u3068WS\u306b\u5f93\u3063\u3066L\u30c1\u30e3\u30f3\u30cd\u30ebR\u30c1\u30e3\u30f3\u30cd\u30eb\u306e\u30c7\u30fc\u30bf\u3092\u51fa\u529b\u3057\u307e\u3059\u3002\u305d\u306e\u305f\u3081\u3001L/R\u306e\u8a2d\u5b9a\u304c\u9055\u3046\u30de\u30a4\u30af\u3092\uff12\u3064\u63a5\u7d9a\u3059\u308b\u3068\u30b9\u30c6\u30ec\u30aa\u30de\u30a4\u30af\u3068\u3057\u3066\u5229\u7528\u3067\u304d\u307e\u3059\u3002\n\u30bf\u30a4\u30df\u30f3\u30b0\u30c1\u30e3\u30fc\u30c8\u3068\u8a73\u7d30\u306a\u4ed5\u69d8\u306b\u3064\u3044\u3066\u306f\u4ee5\u4e0b\u306e\u30c7\u30fc\u30bf\u30b7\u30fc\u30c8\u3092\u3054\u89a7\u304f\u3060\u3055\u3044\u3002\n\nhttp://akizukidenshi.com/download/ds/analog/admp441.pdf\n\n\n3. ESP-WROOM-02\u3068\u306e\u63a5\u7d9a\n\n3.1 WROOM-02\u3068\u306e\u63a5\u7d9a\u65b9\u6cd5\u691c\u8a0e\n\u524d\u8ff0\u306e\u901a\u308a\u3001ADMP441\u306e\u30a4\u30f3\u30bf\u30d5\u30a7\u30fc\u30b9\u306fI2S\u3067\u3059\u3002I2S\u306fSPI\u3068\u5171\u901a\u70b9\u304c\u308a\u307e\u3059\u3002\u305d\u306e\u305f\u3081\u3001SPI\u306e\u6a5f\u80fd\u3092\u5229\u7528\u3057\u3066\u53d6\u308a\u8fbc\u3080\u3053\u3068\u3082\u53ef\u80fd\u3067\u3059\u3002ESP-WROOM-02\u306b\u306fI2S,SPI\u306e\u30e2\u30b8\u30e5\u30fc\u30eb\u304c\u5185\u8535\u3055\u308c\u3066\u3044\u307e\u3059\u3002I2S\u3067\u63a5\u7d9a\u3059\u308b\u304bSPI\u3067\u63a5\u7d9a\u3059\u308b\u304b\u691c\u8a0e\u3092\u884c\u3044\u307e\u3057\u305f\u3002\n\n3.1.1 I2S\u63a5\u7d9a\n\u3000ESP8266\u7528\u306eArduino\u30e9\u30a4\u30d6\u30e9\u30ea\u306bI2S\u7528API\u304c\u7528\u610f\u3055\u308c\u3066\u3044\u307e\u3059\u304c\u30c7\u30fc\u30bf\u306e\u51fa\u529b\u306f\u3067\u304d\u308b\u3082\u306e\u306e\u3001I2S\u7d4c\u7531\u3067\u30c7\u30fc\u30bf\u3092\u8aad\u307f\u53d6\u308b\u65b9\u6cd5\u306f\u63d0\u4f9b\u3055\u308c\u3066\u3044\u307e\u305b\u3093\u3002\n\u3000\u3055\u3089\u306b\u3001I2S\u306e\u30c7\u30fc\u30bf\u53d7\u4fe1\u306b\u304a\u3044\u3066\u3001\u30de\u30b9\u30bf(ESP8266\u5074)\u306f\u30af\u30ed\u30c3\u30af\u3092\u51fa\u529b\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u304c\u3001WS\u306f\u30b9\u30ec\u30fc\u30d6\u304b\u3089\u9001\u3089\u308c\u3066\u304f\u308b\u4ed5\u69d8\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002\u3053\u308c\u306fADMP441\u306e\u4f7f\u7528\u3068\u5408\u81f4\u3057\u307e\u305b\u3093\u3002\u30b9\u30ec\u30fc\u30d6\u306b\u3057\u305f\u5834\u5408\u306f\u30af\u30ed\u30c3\u30af\u3082\u5916\u90e8\u304b\u3089\u306e\u5165\u529b\u306b\u306a\u308a\u307e\u3059\u3002\u305d\u306e\u305f\u3081\u3001ADMP441\u3068\u5229\u7528\u3059\u308b\u305f\u3081\u306b\u306fESP8266\u3092\u30b9\u30ec\u30fc\u30d6\u306b\u8a2d\u5b9a\u3057\u3001\u5916\u90e8\u304b\u3089\u30af\u30ed\u30c3\u30af\u3092\u5165\u529b\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u305d\u3046\u3067\u3059\u3002\u3000\n  \u305f\u3060\u3001I2S\u81ea\u4f53\u306f\u30c7\u30fc\u30bf\u306e\u8ee2\u9001\u3092DMA\u306b\u4efb\u305b\u308b\u3053\u3068\u304c\u51fa\u308b\u305f\u3081\u3001\u8aad\u307f\u66f8\u304d\u3057\u306a\u304c\u3089\u4ed6\u306e\u5272\u308a\u8fbc\u307f\u51e6\u7406\u3084\u30b7\u30ea\u30a2\u30eb\u3078\u306e\u30c7\u30fc\u30bf\u9001\u4fe1\u304c\u53ef\u80fd\u3067\u3059\u3002\u7279\u5fb4\u3092\u4ee5\u4e0b\u306b\u307e\u3068\u3081\u307e\u3059\u3002\n\n\u30e1\u30e2\u30ea\u8ee2\u9001\u306bDMA\u304c\u5229\u7528\u3067\u304d\u308b\u305f\u3081CPU\u3092\u6709\u52b9\u6d3b\u7528\u3067\u304d\u308b\n\u30002. I2S\u30c7\u30fc\u30bf\u53d7\u4fe1\u3092\u30de\u30b9\u30bf\u30e2\u30fc\u30c9\u3067\u52d5\u304b\u3059\u3068WS\u30af\u30ed\u30c3\u30af\u3092\u51fa\u529b\u3067\u304d\u306a\u3044\n\u30003. \u30b9\u30ec\u30fc\u30d6\u30e2\u30fc\u30c9\u3067\u52d5\u304b\u3059\u3068\u5916\u90e8\u306b\u30af\u30ed\u30c3\u30af\u4f9b\u7d66\u6e90\u3092\u4f5c\u308b\u5fc5\u8981\u304c\u3042\u308b\n\u30003. \u305d\u3082\u305d\u3082\u53d7\u4fe1\u3057\u305f\u30c7\u30fc\u30bf\u306e\u53d6\u308a\u51fa\u3057\u65b9\u304c\u4e0d\u660e(\u60c5\u5831\u304c\u5c11\u306a\u3044)\n\n\u30aa\u30fc\u30c7\u30a3\u30aa\u30c7\u30fc\u30bf\u3092\u51fa\u529b\u3059\u308b\u3060\u3051\u3067\u3042\u308c\u3070\u30cf\u30fc\u30c9\u30eb\u304c\u4f4e\u305d\u3046\u3067\u3059\u304c\u3001\u53d6\u308a\u8fbc\u307f\u306b\u95a2\u3057\u3066\u306f\u30cf\u30fc\u30c9\u30eb\u304c\u9ad8\u305d\u3046\u3067\u3059\u3002\u5b9f\u969b\u3001\u30c1\u30e3\u30ec\u30f3\u30b8\u4e2d\u3067\u3059\u304c\u96e3\u5100\u3057\u3066\u3044\u307e\u3059\u3002\n\n3.1.2 SPI\u63a5\u7d9a\n\u3000SPI\u3092\u5229\u7528\u3057\u305f\u5834\u5408\u306e\u7279\u5fb4\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002\n\u30001. SPI\u306eAPI\u306fread write\u3068\u3082\u53ef\u80fd\n\u30002. SPI\u306e\u51e6\u7406\u3092CPU\u3067\u51e6\u7406\u3059\u308b\u305f\u3081\u3001\u30c7\u30fc\u30bf\u53d6\u308a\u8fbc\u307f\u4e2d\u306f\u4ed6\u306e\u51e6\u7406\u304c\u5272\u308a\u8fbc\u3081\u306a\u3044\n\u30003. \u4ed6\u306e\u51e6\u7406\u3092\u5b9f\u884c\u3059\u308b\u3068\u30af\u30ed\u30c3\u30af\u304c\u505c\u6b62\u3059\u308b\n\u30004. WS\u30af\u30ed\u30c3\u30af\u306fIO\u3092\u76f4\u63a5\u64cd\u4f5c\u3057\u3066\u51fa\u529b\u3059\u308b\u3002\n\u3053\u3061\u3089\u3082\u3084\u3084\u96e3\u304c\u3042\u308a\u305d\u3046\u3067\u3059\u304cI2S\u3088\u308a\u306f\u30cf\u30fc\u30c9\u30eb\u304c\u4f4e\u305d\u3046\u306a\u305f\u3081\u4eca\u56de\u306fSPI\u63a5\u7d9a\u3067\u5229\u7528\u3059\u308b\u3053\u3068\u3068\u3057\u307e\u3057\u305f\u3002\n\n3.2 \u914d\u7dda(SPI\u63a5\u7d9a)\n\u914d\u7dda\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002IOxx\u306fESP-WROOM-02\u306e\u30d4\u30f3\u756a\u53f7\u306b\u306a\u308a\u307e\u3059\u3002\u4eca\u56de\u306f\u30b9\u30a4\u30c3\u30c1\u30b5\u30a4\u30a8\u30f3\u30b9\u3055\u3093\u306eEsperDeveloper\u3092\u5229\u7528\u3057\u307e\u3057\u305f\u3002\n\n\n\nADMP441\u30d4\u30f3\u756a\u53f7\n\u63a5\u7d9a\n\n\n\n\n1(SCK)\nIO14\n\n\n2(SD)\nIO12 (100k\u03a9\u306e\u30d7\u30eb\u30a2\u30c3\u30d7\u62b5\u6297\u3092\u5165\u308c\u308b)\n\n\n3(WS)\nIO15\n\n\n4(L/R)\n\u30b0\u30e9\u30f3\u30c9\n\n\n5(GND)\n\u30b0\u30e9\u30f3\u30c9\n\n\n6(VDD)\n3.3V\n\n\n7(EN)\n3.3V\n\n\n8(GND)\n\u30b0\u30e9\u30f3\u30c9\n\n\n\n\n4. \u30d7\u30ed\u30b0\u30e9\u30e0\n\n4.1 ESP-WROOM-02(SPI)\n\u3000ESP-WROOM-02\u5074\u306e\u30d7\u30ed\u30b0\u30e9\u30e0\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002SPI\u306eMODE\u306f0\u306b\u8a2d\u5b9a\u3057\u307e\u3059\u3002\u307e\u305fADMP441\u304c\u51fa\u529b\u3059\u308b\u30c7\u30fc\u30bf\u306f\u30d3\u30c3\u30af\u30a8\u30f3\u30c7\u30a3\u30a2\u30f3\u306b\u306a\u308b\u305f\u3081\u3001BitOrder\u3092MSBSHIFT\u306b\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\u3000\u30c7\u30fc\u30bf\u306e\u8aad\u307f\u51fa\u3057\u90e8\u306b\u3064\u3044\u3066\u306fIO15\u3092Low\u306b\u3057\u30014Byte(32bit)\u5206SPI\u304b\u3089\u30c7\u30fc\u30bf\u3092\u8aad\u307f\u51fa\u3057\u307e\u3059\u3002\u3053\u308c\u3067L\u30c1\u30e3\u30f3\u30cd\u30eb\u306e\u30c7\u30fc\u30bf\u304c\u53d6\u5f97\u3067\u304d\u307e\u3059\u3002\u53d6\u5f97\u3055\u308c\u305f\u30c7\u30fc\u30bf\u306e\u3046\u306124bit\u304c\u5fc5\u8981\u306a\u30c7\u30fc\u30bf\u306b\u306a\u308a\u307e\u3059\u304c\u3001\u6271\u3044\u3084\u3059\u3055\u3092\u8003\u616e\u3057\u3066LSB\u50748bit\u3092\u7121\u8996\u3057\u306616bit\u306b\u3057\u3066\u3044\u307e\u3059\u3002R\u5074\u306f\u30c7\u30fc\u30bf\u304c\u51fa\u3066\u3044\u306a\u3044\u305f\u3081\u8aad\u307f\u98db\u3070\u3057\u307e\u3059\u3002\n\u51fa\u529b\u51e6\u7406\u3067\u306f\u8caf\u3081\u305f\u30d0\u30c3\u30d5\u30a1\u3092\u30b7\u30ea\u30a2\u30eb\u306b\u6d41\u3057\u3066\u3044\u308b\u3060\u3051\u3067\u3059\u3002\n\u8aad\u307f\u53d6\u308a\u5074\u3067\u9010\u6b21\u30b7\u30ea\u30a2\u30eb\u5074\u306b\u51fa\u305d\u3046\u3068\u3059\u308b\u3068\u30af\u30ed\u30c3\u30af\u505c\u6b62\u6642\u9593\u304c\u9577\u304f\u306a\u308a\u3001\u30de\u30a4\u30af\u304c\u52d5\u4f5c\u3057\u307e\u305b\u3093\u3002\u307e\u305f\u3001EERROM\u3082\u8a66\u3057\u3066\u307f\u307e\u3057\u305f\u304c\u540c\u3058\u3067\u3057\u305f\u3002\u8aad\u307f\u53d6\u308a\u5074\u3067\u306fRAM\u3078\u306e\u66f8\u304d\u8fbc\u307f\u304c\u9650\u754c\u306e\u3088\u3046\u3067\u3059\u3002\n\nADMP441.ino\n#include <SPI.h>\n\n#define RING_BUFFER_SIZE 16000 //16000 sample / 8000Hz = 2sec\n\nuint8_t inputs[4]={0};\n\n//RING Buffer\nint buffer_index = 0;\nshort ring_buffer[RING_BUFFER_SIZE]; //2 * 16000 = 32000 Byte\n\nvoid setup() {\n  Serial.begin(115200);\n  SPI.begin();\n  SPI.setDataMode(SPI_MODE0);// ClockPolarity active LOW, Clock Phase \u7acb\u3061\u4e0a\u304c\u308a\n  SPI.setFrequency(500000);// 500kHz=~8000*64clock( wav-file sampling rate 8000Hz)\n  SPI.setBitOrder(MSBFIRST);//Big Endian\n  pinMode(15, OUTPUT);// Setting for WS\n  delay(20);\n}\n\nvoid loop() {\n  while(true){\n    int LRSelect=0;\n    //Read data from microfon\n    for ( int i=0; i<RING_BUFFER_SIZE; i++) {\n        ESP.wdtFeed();\n       digitalWrite(15, LRSelect);//Left channel\n       LRSelect = ~LRSelect;\n       SPI.transferBytes(0, inputs, 4);                 \n       //   |MSB    ||       ||    LSB|\n       //  x1111111 11111111 11111111 1xxxxxxx\n       //               to\n       //  |MSB   | |      | |   LSB|\n       //  11111111 11111111 11111111 xxxxxxxx\n       uint8_t MSB = (inputs[0] << 1) | (0x01 & (inputs[1] >> 7));\n       uint8_t MID = (inputs[1] << 1) | (0x01 & (inputs[2] >> 7));\n       uint8_t LSB = (inputs[2] << 1) | (0x01 & (inputs[3] >> 7));\n       buffer_index = i % RING_BUFFER_SIZE;\n       ring_buffer[buffer_index] =   (0xFF00 & ((short)MSB<<8)) | (0x00FF &(short)MID); \n       //Don't write Serial.print or EEPROM.write. \n       //Because waiting I/O and SPI clock stopped long time.\n       digitalWrite(15, LRSelect);//Right channels\n       LRSelect = ~LRSelect;\n       SPI.transferBytes(0, inputs, 4);\n\n    }  \n\n    //Output to Serial and stop SPI clock\n    for(int i=0; i<RING_BUFFER_SIZE; i++){\n      ESP.wdtFeed();\n      Serial.println(ring_buffer[i]);\n    }\n\n  }\n}\n\n\n\n\u30b7\u30ea\u30a2\u30eb\u53d7\u3051\u5074(Python)\n\u30b7\u30ea\u30a2\u30eb\u5074\u306f\u4ee5\u4e0b\u306e\u30d7\u30ed\u30b0\u30e9\u30e0\u3092\u6e96\u5099\u3057\u307e\u3057\u305f\u3002\u9069\u5f53\u306a\u6642\u9593\u3067\u6b62\u3081\u308b\u3068\u30d0\u30a4\u30ca\u30ea\u30d5\u30a1\u30a4\u30eb\u304c\u51fa\u529b\u3055\u308c\u307e\u3059\u3002\u30d8\u30c3\u30c0\u306a\u3069\u304c\u306a\u3044\u305f\u3081\u3001Audacity\u306a\u3069RAW\u306ePCM\u30c7\u30fc\u30bf\u304c\u6271\u3048\u308b\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3067\u958b\u304f\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002Linux\u306e\u5834\u5408\u306f\u3000aplay\u306b\u30aa\u30d7\u30b7\u30e7\u30f3\u6307\u5b9a(aplay -f S16_LE -r 8000 wav.pcm)\u3067\u518d\u751f\u3067\u304d\u307e\u3059\u3002\n\nmic.py\n# -*- coding: utf-8 -*-                                                                                                                                                                                                                       \n\nimport serial\nimport struct\n\ncom = \"\" #TODO \u30b7\u30ea\u30a2\u30eb\u306e\u30dd\u30fc\u30c8\u3092\u74b0\u5883\u306b\u5408\u308f\u305b\u3066\u6307\u5b9a\n\ndef main():\n\n    s = serial.Serial(com,115200)\n\n    for i in range(0,100):\n        trash = s.readline()\n    with open(\"wave.pcm\", \"wb\") as fout:\n      while True:\n          data = s.readline()\n          bin = struct.pack('<h',int(data.strip())) #\u30ea\u30c8\u30eb\u30a8\u30f3\u30c7\u30a3\u30a2\u30f3\u306b\u5909\u63db\n          fout.write(bin)\n\nif __name__ == \"__main__\":\n\n    main()\n\n\n\n\n\u7d50\u679c\n\u4ee5\u4e0b\u306b\u3001\u7d50\u679c\u3092\u5831\u544a\u3057\u307e\u3059\u3002\n\nSPI\u306e\u30af\u30ed\u30c3\u30af\n8kHz*64bit(32*2\u30c1\u30e3\u30f3\u30cd\u30eb)\u2252500kHz \u30672us\u5468\u671f\u306e\u30af\u30ed\u30c3\u30af\u304c\u51fa\u529b\u3055\u308c\u3066\u3044\u307e\u3059\u3002\uff08\uff11\u30de\u30b9\u304c2us\uff09\n\n\nWS\u3068\u51fa\u529b\u30c7\u30fc\u30bf\n\u4e0a\u5074WS\u304cL\u306e\u6642\u306e\u307f\u4e0b\u5074\u30de\u30a4\u30af\u5074\u304b\u3089\u306e\u51fa\u529b\u304c\u51fa\u3066\u3044\u307e\u3059\u3002WS\u306f150us\u7a0b\u5ea6\u306e\u5468\u671f\u306b\u306a\u308a\u300164bit\u5206\u306b\u76f8\u5f53\u3057\u307e\u3059\u3002(1\u30de\u30b9\u304c50us)\n\n\u30ed\u30b8\u30a2\u30ca\u304c\u3042\u308b\u3068\u3082\u3046\u5c11\u3057\u308f\u304b\u308a\u3084\u3059\u304f\u306a\u308b\u3068\u601d\u3044\u307e\u3059\u3002\n\n\u97f3\u58f0\u306e\u6ce2\u5f62\n\u96c6\u97f3\u3057\u305f\u97f3\u58f0\u306e\u6ce2\u5f62\u3067\u3059\u3002\u518d\u751f\u3059\u308b\u3068\u3061\u3083\u3093\u3068\u805e\u3053\u3048\u307e\u3059\uff08\u5f53\u305f\u308a\u524d\u3067\u3059\u304c\uff09\nAudacity\u306e[\u30d5\u30a1\u30a4\u30eb]->[\u53d6\u308a\u8fbc\u307f]->[\u30ed\u30fc\u306e\u53d6\u308a\u8fbc\u307f]\u304b\u3089\u3001mic.py\u3067\u4fdd\u5b58\u3057\u305f\u30d5\u30a1\u30a4\u30eb\u3092\u958b\u304d\u307e\u3059\u3002(Signed 16bit \u30ea\u30c8\u30eb\u30a8\u30f3\u30c7\u30a3\u30a2\u30f3 1\u30c1\u30e3\u30f3\u30cd\u30eb 8kHz)\n\n\u6ce2\u5f62\u304c\u30b0\u30cb\u30e7\u3063\u3068\u4e0b\u306b\u6b6a\u3080\u30bf\u30a4\u30df\u30f3\u30b0\u304c\u3042\u308a\u307e\u3059\u3002\u3053\u308c\u306f\u30c7\u30fc\u30bf\u8ee2\u9001\u5f8c\u3001\u518d\u5ea6\u96c6\u97f3\u3092\u958b\u59cb\u3057\u305f\u30bf\u30a4\u30df\u30f3\u30b0\u3067\u3059\u3002\u304a\u305d\u3089\u304f\u30de\u30a4\u30af\u306e\u51fa\u529b\u304c\u5b89\u5b9a\u3057\u3066\u3044\u306a\u3044\u305f\u3081\u3060\u3068\u601d\u308f\u308c\u307e\u3059\u30028kHz\u306e\u5834\u5408\u30010.5\u79d2(2us*2^18)\u307b\u3069\u8aad\u307f\u98db\u3070\u305b\u3070\u5b89\u5b9a\u3057\u305f\u90e8\u5206\u306e\u307f\u53ce\u9332\u304c\u53ef\u80fd\u3067\u3059\u3002\n\n\u307e\u3068\u3081\n\u30de\u30a4\u30af\u81ea\u4f53\u306f\u63a5\u7d9a\u3067\u304d\u307e\u3057\u305f\u304c\u3001RAM\u306e\u5236\u7d04\u4e0a\u53d6\u308a\u8fbc\u3093\u3060\u97f3\u58f0\u304c\u77ed\u3044\u3067\u3059\u3002\u307e\u305f\u96c6\u97f3\u3068\u5916\u90e8\u3078\u306e\u8ee2\u9001\u304c\u540c\u6642\u306b\u3067\u304d\u307e\u305b\u3093\u3002\u3053\u306e\u554f\u984c\u306e\u89e3\u6c7a\u7b56\u3068\u3057\u3066I2S\u3092\u5229\u7528(DMA\u306b\u3088\u308b\u30e1\u30e2\u30ea\u8ee2\u9001)\u304c\u8003\u3048\u3089\u308c\u307e\u3059\u3002\u3053\u3061\u3089\u306b\u3064\u3044\u3066\u306f\u53d6\u308a\u7d44\u307f\u4e2d\u3067\u3059\u304c\u3002\u3002\u3002\n#1. \u306f\u3058\u3081\u306b\n\u672c\u8a18\u4e8b\u3067\u306f\u30c7\u30b8\u30bf\u30eb\u30de\u30a4\u30afADMP441\u3092\u4f7f\u3044ESP-WROOM-02\u3067\u97f3\u58f0\u3092\u96c6\u97f3\u3059\u308b\u65b9\u6cd5\u3092\u7d39\u4ecb\u3057\u307e\u3059\u3002\n\u4ee5\u4e0b\u306e\u5185\u5bb9\u306b\u3064\u3044\u3066\u89e6\u308c\u307e\u3059\u3002\n\n * ADMP441\u3068ESP-WROOM-02\u3068\u306e\u63a5\u7d9a(SPI)\n * \u97f3\u58f0\u30c7\u30fc\u30bf\u3092\u30b7\u30ea\u30a2\u30eb\u3067\u53d6\u5f97\u3059\u308b\n\n\u4eca\u56de\u306f16bit 8kHz\u306e\u30d5\u30a9\u30fc\u30de\u30c3\u30c8\u30672\u79d2\u7a0b\u5ea6\u306e\u97f3\u58f0\u30c7\u30fc\u30bf\u3092\u53ce\u9332\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3057\u305f\u3002\u53ce\u9332\u79d2\u6570\u306fESP-WROOM-02\u306e\u30cf\u30fc\u30c9\u30a6\u30a7\u30a2\u7684\u4ed5\u69d8\u306b\u3088\u308b\u3082\u306e\u3067\u3059\u3002(\u30e6\u30fc\u30b6\u30e9\u30f3\u30c9\u306eRAM\u30b5\u30a4\u30ba\u8d77\u56e0)\n \u307e\u305f\u3001 \u30c7\u30fc\u30bf\u306e\u53d6\u5f97\u3068\u5916\u90e8\u3078\u306e\u9001\u4fe1\u306f\u540c\u6642\u306b\u3067\u304d\u307e\u305b\u3093\u3002\uff08\u73fe\u5728\u30c1\u30e3\u30ec\u30f3\u30b8\u4e2d\uff09\nADMP441\u81ea\u4f53\u306f[\u5ec3\u76e4?](http://www.analog.com/jp/products/obsolete/admp441.html)\u306b\u306a\u3063\u305f\u3088\u3046\u3067\u3059\u304c\u3001\u79cb\u6708\u306a\u3069\u306e\u5728\u5eab\u306f\u307e\u3060\u3042\u308a\u305d\u3046\u3067\u3059\u3002\n\n\u672c\u8a18\u4e8b\u306f\u96fb\u5b50\u56de\u8def\u306e\u77e5\u8b58\u304c\u5fc5\u8981\u3067\u3059\u3002\u5b9f\u65bd\u306f\u5404\u4eba\u306e\u8cac\u4efb\u3067\u304a\u9858\u3044\u3044\u305f\u3057\u307e\u3059\u3002\n\n# 2. \u5229\u7528\u65b9\u6cd5\u306e\u691c\u8a0e\n\n## 2.1 ADMP441\u306e\u6982\u8981\n\u3000\nADMP441\u306fMEMS\u30de\u30a4\u30af\u3001\u30a2\u30f3\u30d7\u3001A/D\u5909\u63db\u3001\u30c7\u30b8\u30bf\u30eb\u30d5\u30a3\u30eb\u30bf\u3092\u30ef\u30f3\u30d1\u30c3\u30b1\u30fc\u30b8\u306b\u53ce\u3081\u305f\u30c7\u30b8\u30bf\u30eb\u30de\u30a4\u30af\u30e2\u30b8\u30e5\u30fc\u30eb\u3067\u3059\u3002\u51fa\u529b\u306fI2S\u3068\u547c\u3070\u308c\u308b3\u7dda\u306e\u30b7\u30ea\u30a2\u30eb\u901a\u4fe1\u3092\u5229\u7528\u3057\u307e\u3059\u30023\u7dda\u306f\u305d\u308c\u305e\u308c\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u6a5f\u80fd\u5272\u308a\u5f53\u3066\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002\n\n| \u540d\u79f0 | \u6a5f\u80fd |\n|------|------|  \n| SCK  | \u540c\u671f\u30af\u30ed\u30c3\u30af(500kHz\u301c3MHz\u7a0b\u5ea6\u307e\u3067)<br>\u30af\u30ed\u30c3\u30af\u306b\u5fdc\u3058\u3066\u30b5\u30f3\u30d7\u30ea\u30f3\u30b0\u5468\u6ce2\u6570\u304c\u5909\u308f\u308b|\n| SD   | \u97f3\u58f0\u306e\u30c7\u30fc\u30bf\u4fe1\u53f7(1\u30af\u30ed\u30c3\u30af\u3054\u3068\u306b1bit)|\n| WS   | L\u5074R\u5074\u306e\u51fa\u529b\u30bb\u30ec\u30af\u30bf\u4fe1\u53f7<br>SCK\u306e64\u500d\u306e\u5468\u671f(SD\u306e64bit\u5206)\u3067\u52d5\u4f5c\u3055\u305b\u308b\u3002|\n\n\n\u624b\u306b\u5165\u308c\u3084\u3059\u3044\u88fd\u54c1\u3068\u3057\u3066\u306f\u4ee5\u4e0b\u306e\uff12\u3064\u304c\u3042\u308a\u307e\u3059\u3002\u672c\u8a18\u4e8b\u3067\u306f1\u756a\u306e\u79cb\u6708\u96fb\u5b50\u306e\u88fd\u54c1\u3092\u5229\u7528\u3057\u307e\u3057\u305f\u3002\n\n1. http://akizukidenshi.com/catalog/g/gK-06864/\n2. https://strawberry-linux.com/catalog/items?code=12036\n\n* 2.2 ADMP441\u306e\u52d5\u4f5c\n\nADMP441\u306e\u30d4\u30f3\u914d\u7f6e\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002\n\n| \u30d4\u30f3\u756a\u53f7 | \u540d\u79f0 | \u6a5f\u80fd |\n|---------|------|------|  \n|  1      | SCK  | I2S\u306e\u52d5\u4f5c\u30af\u30ed\u30c3\u30af\u5165\u529b(500kHz\u301c3MHz)|\n|  2      | SD   | \u30c7\u30fc\u30bf\u51fa\u529b |\n|  3      | WS   | LR\u30bb\u30ec\u30af\u30bf\u5165\u529b(Low\u3067L\u5074\u30c7\u30fc\u30bf\u51fa\u529b)|\n|  4      | L/R  | \u30de\u30a4\u30af\u306eL/R\u9078\u629e(GND\u63a5\u7d9a\u3067L\u5074\u51fa\u529b)|\n|  5      | GND  | \u30b0\u30e9\u30f3\u30c9|\n|  6      | VDD  | 3.3V   |\n|  7      | EN   | \u30c1\u30c3\u30d7\u30a4\u30cd\u30fc\u30d6\u30eb(VDD\u63a5\u7d9a) |\n|  8      | GND  | \u30b0\u30e9\u30f3\u30c9|\n\nADMP441\u306f1\u756a\u30d4\u30f3\u306eSCK\u30af\u30ed\u30c3\u30af\u3068WS\u30af\u30ed\u30c3\u30af\u5165\u529b\u306b\u5f93\u3063\u3066\u52d5\u4f5c\u3092\u958b\u59cb\u3057\u307e\u3059\u30022^18\u4e57\u5206\u306eSCK\u30af\u30ed\u30c3\u30af\u3092\u53d7\u3051\u308b\u3068SD\u30d4\u30f3\u304b\u3089\u30c7\u30fc\u30bf\u3092\u51fa\u529b\u3057\u307e\u3059\u3002\n\u3000SD\u304b\u3089\u306fSCK\u30af\u30ed\u30c3\u30af\u306e\u7acb\u3061\u4e0a\u304c\u308a\u306e\u30bf\u30a4\u30df\u30f3\u30b0(Low->High)\u30671bit\u5206\u306e\u30c7\u30fc\u30bf\u304c\u51fa\u529b\u3055\u308c\u307e\u3059\u3002\u307e\u305fL/R\u30c1\u30e3\u30f3\u30cd\u30eb\u9078\u629e(\uff14\u756a\u30d4\u30f3)\u306e\u8a2d\u5b9a\u306b\u5f93\u3044\u3001WS\u30d4\u30f3\u306b\u5165\u529b\u3055\u308c\u308b\u30af\u30ed\u30c3\u30af\u306b\u540c\u671f\u3057\u3066L/R\u306b\u5206\u3051\u3066\u51fa\u529b\u3055\u308c\u307e\u3059\u3002\n\u3000SD\u304b\u3089\u51fa\u529b\u3055\u308c\u308b\u30c7\u30fc\u30bf\u306f\u30e2\u30ce\u30e9\u30eb1\u30c1\u30e3\u30f3\u30cd\u30eb\u5206\u306732bit\u306e\u30c7\u30fc\u30bf\u306b\u306a\u308a\u307e\u3059\u3002\u305d\u306e\u305f\u3081\u3001WS\u306b\u5165\u529b\u3059\u308b\u30af\u30ed\u30c3\u30af\u306fSCK\u306e32\u30af\u30ed\u30c3\u30af\u3054\u3068\u306b\u5207\u308a\u66ff\u3048\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\u3000\u53d6\u5f97\u3055\u308c\u308b\u30c7\u30fc\u30bf\u306f\u7247\u507432bit\u3067\u3059\u304c\u5b9f\u969b\u306b\u6709\u52b9\u306a\u30c7\u30fc\u30bf\u306f24bit\u306e\u30c7\u30fc\u30bf\u304c\u53d6\u5f97\u3055\u308c\u308b\u306e\u3067\u3001\u5148\u982d1bit\u3068\u5f8c\u308d7bit\u306f\u30bd\u30d5\u30c8\u30a6\u30a7\u30a2\u7684\u306b\u9664\u53bb\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\u3000\u524d\u8ff0\u306e\u3088\u3046\u306bL/R\u306e\u8a2d\u5b9a\u3068WS\u306b\u5f93\u3063\u3066L\u30c1\u30e3\u30f3\u30cd\u30ebR\u30c1\u30e3\u30f3\u30cd\u30eb\u306e\u30c7\u30fc\u30bf\u3092\u51fa\u529b\u3057\u307e\u3059\u3002\u305d\u306e\u305f\u3081\u3001L/R\u306e\u8a2d\u5b9a\u304c\u9055\u3046\u30de\u30a4\u30af\u3092\uff12\u3064\u63a5\u7d9a\u3059\u308b\u3068\u30b9\u30c6\u30ec\u30aa\u30de\u30a4\u30af\u3068\u3057\u3066\u5229\u7528\u3067\u304d\u307e\u3059\u3002\n\n\u30bf\u30a4\u30df\u30f3\u30b0\u30c1\u30e3\u30fc\u30c8\u3068\u8a73\u7d30\u306a\u4ed5\u69d8\u306b\u3064\u3044\u3066\u306f\u4ee5\u4e0b\u306e\u30c7\u30fc\u30bf\u30b7\u30fc\u30c8\u3092\u3054\u89a7\u304f\u3060\u3055\u3044\u3002\n\n* http://akizukidenshi.com/download/ds/analog/admp441.pdf\n\n# 3. ESP-WROOM-02\u3068\u306e\u63a5\u7d9a\n\n## 3.1 WROOM-02\u3068\u306e\u63a5\u7d9a\u65b9\u6cd5\u691c\u8a0e\n\n\u524d\u8ff0\u306e\u901a\u308a\u3001ADMP441\u306e\u30a4\u30f3\u30bf\u30d5\u30a7\u30fc\u30b9\u306fI2S\u3067\u3059\u3002I2S\u306fSPI\u3068\u5171\u901a\u70b9\u304c\u308a\u307e\u3059\u3002\u305d\u306e\u305f\u3081\u3001SPI\u306e\u6a5f\u80fd\u3092\u5229\u7528\u3057\u3066\u53d6\u308a\u8fbc\u3080\u3053\u3068\u3082\u53ef\u80fd\u3067\u3059\u3002ESP-WROOM-02\u306b\u306fI2S,SPI\u306e\u30e2\u30b8\u30e5\u30fc\u30eb\u304c\u5185\u8535\u3055\u308c\u3066\u3044\u307e\u3059\u3002I2S\u3067\u63a5\u7d9a\u3059\u308b\u304bSPI\u3067\u63a5\u7d9a\u3059\u308b\u304b\u691c\u8a0e\u3092\u884c\u3044\u307e\u3057\u305f\u3002\n\n### 3.1.1 I2S\u63a5\u7d9a\n\n\u3000ESP8266\u7528\u306eArduino\u30e9\u30a4\u30d6\u30e9\u30ea\u306bI2S\u7528API\u304c\u7528\u610f\u3055\u308c\u3066\u3044\u307e\u3059\u304c\u30c7\u30fc\u30bf\u306e\u51fa\u529b\u306f\u3067\u304d\u308b\u3082\u306e\u306e\u3001I2S\u7d4c\u7531\u3067\u30c7\u30fc\u30bf\u3092\u8aad\u307f\u53d6\u308b\u65b9\u6cd5\u306f\u63d0\u4f9b\u3055\u308c\u3066\u3044\u307e\u305b\u3093\u3002\n\u3000\u3055\u3089\u306b\u3001I2S\u306e\u30c7\u30fc\u30bf\u53d7\u4fe1\u306b\u304a\u3044\u3066\u3001\u30de\u30b9\u30bf(ESP8266\u5074)\u306f\u30af\u30ed\u30c3\u30af\u3092\u51fa\u529b\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u304c\u3001WS\u306f\u30b9\u30ec\u30fc\u30d6\u304b\u3089\u9001\u3089\u308c\u3066\u304f\u308b\u4ed5\u69d8\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002\u3053\u308c\u306fADMP441\u306e\u4f7f\u7528\u3068\u5408\u81f4\u3057\u307e\u305b\u3093\u3002\u30b9\u30ec\u30fc\u30d6\u306b\u3057\u305f\u5834\u5408\u306f\u30af\u30ed\u30c3\u30af\u3082\u5916\u90e8\u304b\u3089\u306e\u5165\u529b\u306b\u306a\u308a\u307e\u3059\u3002\u305d\u306e\u305f\u3081\u3001ADMP441\u3068\u5229\u7528\u3059\u308b\u305f\u3081\u306b\u306fESP8266\u3092\u30b9\u30ec\u30fc\u30d6\u306b\u8a2d\u5b9a\u3057\u3001\u5916\u90e8\u304b\u3089\u30af\u30ed\u30c3\u30af\u3092\u5165\u529b\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u305d\u3046\u3067\u3059\u3002\u3000\n  \u305f\u3060\u3001I2S\u81ea\u4f53\u306f\u30c7\u30fc\u30bf\u306e\u8ee2\u9001\u3092DMA\u306b\u4efb\u305b\u308b\u3053\u3068\u304c\u51fa\u308b\u305f\u3081\u3001\u8aad\u307f\u66f8\u304d\u3057\u306a\u304c\u3089\u4ed6\u306e\u5272\u308a\u8fbc\u307f\u51e6\u7406\u3084\u30b7\u30ea\u30a2\u30eb\u3078\u306e\u30c7\u30fc\u30bf\u9001\u4fe1\u304c\u53ef\u80fd\u3067\u3059\u3002\u7279\u5fb4\u3092\u4ee5\u4e0b\u306b\u307e\u3068\u3081\u307e\u3059\u3002\n\n  1. \u30e1\u30e2\u30ea\u8ee2\u9001\u306bDMA\u304c\u5229\u7528\u3067\u304d\u308b\u305f\u3081CPU\u3092\u6709\u52b9\u6d3b\u7528\u3067\u304d\u308b\n\u30002. I2S\u30c7\u30fc\u30bf\u53d7\u4fe1\u3092\u30de\u30b9\u30bf\u30e2\u30fc\u30c9\u3067\u52d5\u304b\u3059\u3068WS\u30af\u30ed\u30c3\u30af\u3092\u51fa\u529b\u3067\u304d\u306a\u3044\n\u30003. \u30b9\u30ec\u30fc\u30d6\u30e2\u30fc\u30c9\u3067\u52d5\u304b\u3059\u3068\u5916\u90e8\u306b\u30af\u30ed\u30c3\u30af\u4f9b\u7d66\u6e90\u3092\u4f5c\u308b\u5fc5\u8981\u304c\u3042\u308b\n\u30003. \u305d\u3082\u305d\u3082\u53d7\u4fe1\u3057\u305f\u30c7\u30fc\u30bf\u306e\u53d6\u308a\u51fa\u3057\u65b9\u304c\u4e0d\u660e(\u60c5\u5831\u304c\u5c11\u306a\u3044)\n\n\u30aa\u30fc\u30c7\u30a3\u30aa\u30c7\u30fc\u30bf\u3092\u51fa\u529b\u3059\u308b\u3060\u3051\u3067\u3042\u308c\u3070\u30cf\u30fc\u30c9\u30eb\u304c\u4f4e\u305d\u3046\u3067\u3059\u304c\u3001\u53d6\u308a\u8fbc\u307f\u306b\u95a2\u3057\u3066\u306f\u30cf\u30fc\u30c9\u30eb\u304c\u9ad8\u305d\u3046\u3067\u3059\u3002\u5b9f\u969b\u3001\u30c1\u30e3\u30ec\u30f3\u30b8\u4e2d\u3067\u3059\u304c\u96e3\u5100\u3057\u3066\u3044\u307e\u3059\u3002\n\n### 3.1.2 SPI\u63a5\u7d9a\n\n\u3000SPI\u3092\u5229\u7528\u3057\u305f\u5834\u5408\u306e\u7279\u5fb4\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002\n \n\u30001. SPI\u306eAPI\u306fread write\u3068\u3082\u53ef\u80fd\n\u30002. SPI\u306e\u51e6\u7406\u3092CPU\u3067\u51e6\u7406\u3059\u308b\u305f\u3081\u3001\u30c7\u30fc\u30bf\u53d6\u308a\u8fbc\u307f\u4e2d\u306f\u4ed6\u306e\u51e6\u7406\u304c\u5272\u308a\u8fbc\u3081\u306a\u3044\n\u30003. \u4ed6\u306e\u51e6\u7406\u3092\u5b9f\u884c\u3059\u308b\u3068\u30af\u30ed\u30c3\u30af\u304c\u505c\u6b62\u3059\u308b\n\u30004. WS\u30af\u30ed\u30c3\u30af\u306fIO\u3092\u76f4\u63a5\u64cd\u4f5c\u3057\u3066\u51fa\u529b\u3059\u308b\u3002\n\n\u3053\u3061\u3089\u3082\u3084\u3084\u96e3\u304c\u3042\u308a\u305d\u3046\u3067\u3059\u304cI2S\u3088\u308a\u306f\u30cf\u30fc\u30c9\u30eb\u304c\u4f4e\u305d\u3046\u306a\u305f\u3081\u4eca\u56de\u306fSPI\u63a5\u7d9a\u3067\u5229\u7528\u3059\u308b\u3053\u3068\u3068\u3057\u307e\u3057\u305f\u3002\n\n\n## 3.2 \u914d\u7dda(SPI\u63a5\u7d9a)\n\u914d\u7dda\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002IOxx\u306fESP-WROOM-02\u306e\u30d4\u30f3\u756a\u53f7\u306b\u306a\u308a\u307e\u3059\u3002\u4eca\u56de\u306f\u30b9\u30a4\u30c3\u30c1\u30b5\u30a4\u30a8\u30f3\u30b9\u3055\u3093\u306e[EsperDeveloper](https://www.switch-science.com/catalog/2500/)\u3092\u5229\u7528\u3057\u307e\u3057\u305f\u3002\n\n| ADMP441\u30d4\u30f3\u756a\u53f7 | \u63a5\u7d9a |\n|----------------|------|  \n|  1(SCK)        | IO14|\n|  2(SD)         | IO12 (100k\u03a9\u306e\u30d7\u30eb\u30a2\u30c3\u30d7\u62b5\u6297\u3092\u5165\u308c\u308b)|\n|  3(WS)         | IO15|\n|  4(L/R)        | \u30b0\u30e9\u30f3\u30c9|\n|  5(GND)        | \u30b0\u30e9\u30f3\u30c9|\n|  6(VDD)        | 3.3V   |\n|  7(EN)         | 3.3V |\n|  8(GND)        | \u30b0\u30e9\u30f3\u30c9|\n\n# 4. \u30d7\u30ed\u30b0\u30e9\u30e0\n\n## 4.1 ESP-WROOM-02(SPI)\n\n\u3000ESP-WROOM-02\u5074\u306e\u30d7\u30ed\u30b0\u30e9\u30e0\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002SPI\u306eMODE\u306f0\u306b\u8a2d\u5b9a\u3057\u307e\u3059\u3002\u307e\u305fADMP441\u304c\u51fa\u529b\u3059\u308b\u30c7\u30fc\u30bf\u306f\u30d3\u30c3\u30af\u30a8\u30f3\u30c7\u30a3\u30a2\u30f3\u306b\u306a\u308b\u305f\u3081\u3001BitOrder\u3092MSBSHIFT\u306b\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\u3000\u30c7\u30fc\u30bf\u306e\u8aad\u307f\u51fa\u3057\u90e8\u306b\u3064\u3044\u3066\u306fIO15\u3092Low\u306b\u3057\u30014Byte(32bit)\u5206SPI\u304b\u3089\u30c7\u30fc\u30bf\u3092\u8aad\u307f\u51fa\u3057\u307e\u3059\u3002\u3053\u308c\u3067L\u30c1\u30e3\u30f3\u30cd\u30eb\u306e\u30c7\u30fc\u30bf\u304c\u53d6\u5f97\u3067\u304d\u307e\u3059\u3002\u53d6\u5f97\u3055\u308c\u305f\u30c7\u30fc\u30bf\u306e\u3046\u306124bit\u304c\u5fc5\u8981\u306a\u30c7\u30fc\u30bf\u306b\u306a\u308a\u307e\u3059\u304c\u3001\u6271\u3044\u3084\u3059\u3055\u3092\u8003\u616e\u3057\u3066LSB\u50748bit\u3092\u7121\u8996\u3057\u306616bit\u306b\u3057\u3066\u3044\u307e\u3059\u3002R\u5074\u306f\u30c7\u30fc\u30bf\u304c\u51fa\u3066\u3044\u306a\u3044\u305f\u3081\u8aad\u307f\u98db\u3070\u3057\u307e\u3059\u3002\n\u51fa\u529b\u51e6\u7406\u3067\u306f\u8caf\u3081\u305f\u30d0\u30c3\u30d5\u30a1\u3092\u30b7\u30ea\u30a2\u30eb\u306b\u6d41\u3057\u3066\u3044\u308b\u3060\u3051\u3067\u3059\u3002\n\u8aad\u307f\u53d6\u308a\u5074\u3067\u9010\u6b21\u30b7\u30ea\u30a2\u30eb\u5074\u306b\u51fa\u305d\u3046\u3068\u3059\u308b\u3068\u30af\u30ed\u30c3\u30af\u505c\u6b62\u6642\u9593\u304c\u9577\u304f\u306a\u308a\u3001\u30de\u30a4\u30af\u304c\u52d5\u4f5c\u3057\u307e\u305b\u3093\u3002\u307e\u305f\u3001EERROM\u3082\u8a66\u3057\u3066\u307f\u307e\u3057\u305f\u304c\u540c\u3058\u3067\u3057\u305f\u3002\u8aad\u307f\u53d6\u308a\u5074\u3067\u306fRAM\u3078\u306e\u66f8\u304d\u8fbc\u307f\u304c\u9650\u754c\u306e\u3088\u3046\u3067\u3059\u3002\n\n```C++:ADMP441.ino\n#include <SPI.h>\n\n#define RING_BUFFER_SIZE 16000 //16000 sample / 8000Hz = 2sec\n\nuint8_t inputs[4]={0};\n\n//RING Buffer\nint buffer_index = 0;\nshort ring_buffer[RING_BUFFER_SIZE]; //2 * 16000 = 32000 Byte\n\nvoid setup() {\n  Serial.begin(115200);\n  SPI.begin();\n  SPI.setDataMode(SPI_MODE0);// ClockPolarity active LOW, Clock Phase \u7acb\u3061\u4e0a\u304c\u308a\n  SPI.setFrequency(500000);// 500kHz=~8000*64clock( wav-file sampling rate 8000Hz)\n  SPI.setBitOrder(MSBFIRST);//Big Endian\n  pinMode(15, OUTPUT);// Setting for WS\n  delay(20);\n}\n\nvoid loop() {\n  while(true){\n    int LRSelect=0;\n    //Read data from microfon\n    for ( int i=0; i<RING_BUFFER_SIZE; i++) {\n        ESP.wdtFeed();\n       digitalWrite(15, LRSelect);//Left channel\n       LRSelect = ~LRSelect;\n       SPI.transferBytes(0, inputs, 4);                 \n       //   |MSB    ||       ||    LSB|\n       //  x1111111 11111111 11111111 1xxxxxxx\n       //               to\n       //  |MSB   | |      | |   LSB|\n       //  11111111 11111111 11111111 xxxxxxxx\n       uint8_t MSB = (inputs[0] << 1) | (0x01 & (inputs[1] >> 7));\n       uint8_t MID = (inputs[1] << 1) | (0x01 & (inputs[2] >> 7));\n       uint8_t LSB = (inputs[2] << 1) | (0x01 & (inputs[3] >> 7));\n       buffer_index = i % RING_BUFFER_SIZE;\n       ring_buffer[buffer_index] =   (0xFF00 & ((short)MSB<<8)) | (0x00FF &(short)MID); \n       //Don't write Serial.print or EEPROM.write. \n       //Because waiting I/O and SPI clock stopped long time.\n       digitalWrite(15, LRSelect);//Right channels\n       LRSelect = ~LRSelect;\n       SPI.transferBytes(0, inputs, 4);\n       \n    }  \n\n    //Output to Serial and stop SPI clock\n    for(int i=0; i<RING_BUFFER_SIZE; i++){\n      ESP.wdtFeed();\n      Serial.println(ring_buffer[i]);\n    }\n   \n  }\n}\n```\n\n\n## \u30b7\u30ea\u30a2\u30eb\u53d7\u3051\u5074(Python)\n\n\u30b7\u30ea\u30a2\u30eb\u5074\u306f\u4ee5\u4e0b\u306e\u30d7\u30ed\u30b0\u30e9\u30e0\u3092\u6e96\u5099\u3057\u307e\u3057\u305f\u3002\u9069\u5f53\u306a\u6642\u9593\u3067\u6b62\u3081\u308b\u3068\u30d0\u30a4\u30ca\u30ea\u30d5\u30a1\u30a4\u30eb\u304c\u51fa\u529b\u3055\u308c\u307e\u3059\u3002\u30d8\u30c3\u30c0\u306a\u3069\u304c\u306a\u3044\u305f\u3081\u3001[Audacity](http://audacity.softonic.jp)\u306a\u3069RAW\u306ePCM\u30c7\u30fc\u30bf\u304c\u6271\u3048\u308b\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3067\u958b\u304f\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002Linux\u306e\u5834\u5408\u306f\u3000aplay\u306b\u30aa\u30d7\u30b7\u30e7\u30f3\u6307\u5b9a(aplay -f S16_LE -r 8000 wav.pcm)\u3067\u518d\u751f\u3067\u304d\u307e\u3059\u3002\n\n```python:mic.py\n# -*- coding: utf-8 -*-                                                                                                                                                                                                                       \n\nimport serial\nimport struct\n\ncom = \"\" #TODO \u30b7\u30ea\u30a2\u30eb\u306e\u30dd\u30fc\u30c8\u3092\u74b0\u5883\u306b\u5408\u308f\u305b\u3066\u6307\u5b9a\n\ndef main():\n\n    s = serial.Serial(com,115200)\n\n    for i in range(0,100):\n        trash = s.readline()\n    with open(\"wave.pcm\", \"wb\") as fout:\n      while True:\n          data = s.readline()\n          bin = struct.pack('<h',int(data.strip())) #\u30ea\u30c8\u30eb\u30a8\u30f3\u30c7\u30a3\u30a2\u30f3\u306b\u5909\u63db\n          fout.write(bin)\n\nif __name__ == \"__main__\":\n\n    main()\n\n```\n\n#\u7d50\u679c\n\n\u4ee5\u4e0b\u306b\u3001\u7d50\u679c\u3092\u5831\u544a\u3057\u307e\u3059\u3002\n\n## SPI\u306e\u30af\u30ed\u30c3\u30af\n8kHz*64bit(32*2\u30c1\u30e3\u30f3\u30cd\u30eb)\u2252500kHz \u30672us\u5468\u671f\u306e\u30af\u30ed\u30c3\u30af\u304c\u51fa\u529b\u3055\u308c\u3066\u3044\u307e\u3059\u3002\uff08\uff11\u30de\u30b9\u304c2us\uff09\n![IMG_2834.JPG](https://qiita-image-store.s3.amazonaws.com/0/3264/f518de53-adf3-d10d-5cdb-9ff4dcfd7a1e.jpeg)\n\n## WS\u3068\u51fa\u529b\u30c7\u30fc\u30bf\n\u4e0a\u5074WS\u304cL\u306e\u6642\u306e\u307f\u4e0b\u5074\u30de\u30a4\u30af\u5074\u304b\u3089\u306e\u51fa\u529b\u304c\u51fa\u3066\u3044\u307e\u3059\u3002WS\u306f150us\u7a0b\u5ea6\u306e\u5468\u671f\u306b\u306a\u308a\u300164bit\u5206\u306b\u76f8\u5f53\u3057\u307e\u3059\u3002(1\u30de\u30b9\u304c50us)\n![IMG_2836.JPG](https://qiita-image-store.s3.amazonaws.com/0/3264/e3fa10e0-6e04-c43b-e5de-497517b657ef.jpeg)\n\u30ed\u30b8\u30a2\u30ca\u304c\u3042\u308b\u3068\u3082\u3046\u5c11\u3057\u308f\u304b\u308a\u3084\u3059\u304f\u306a\u308b\u3068\u601d\u3044\u307e\u3059\u3002\n\n##\u97f3\u58f0\u306e\u6ce2\u5f62\n\u96c6\u97f3\u3057\u305f\u97f3\u58f0\u306e\u6ce2\u5f62\u3067\u3059\u3002\u518d\u751f\u3059\u308b\u3068\u3061\u3083\u3093\u3068\u805e\u3053\u3048\u307e\u3059\uff08\u5f53\u305f\u308a\u524d\u3067\u3059\u304c\uff09\nAudacity\u306e[\u30d5\u30a1\u30a4\u30eb]->[\u53d6\u308a\u8fbc\u307f]->[\u30ed\u30fc\u306e\u53d6\u308a\u8fbc\u307f]\u304b\u3089\u3001mic.py\u3067\u4fdd\u5b58\u3057\u305f\u30d5\u30a1\u30a4\u30eb\u3092\u958b\u304d\u307e\u3059\u3002(Signed 16bit \u30ea\u30c8\u30eb\u30a8\u30f3\u30c7\u30a3\u30a2\u30f3 1\u30c1\u30e3\u30f3\u30cd\u30eb 8kHz)\n\n![\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2016-09-25 11.50.53.png](https://qiita-image-store.s3.amazonaws.com/0/3264/24991481-49a7-3e8c-3ae6-467090663eeb.png)\n\n\u6ce2\u5f62\u304c\u30b0\u30cb\u30e7\u3063\u3068\u4e0b\u306b\u6b6a\u3080\u30bf\u30a4\u30df\u30f3\u30b0\u304c\u3042\u308a\u307e\u3059\u3002\u3053\u308c\u306f\u30c7\u30fc\u30bf\u8ee2\u9001\u5f8c\u3001\u518d\u5ea6\u96c6\u97f3\u3092\u958b\u59cb\u3057\u305f\u30bf\u30a4\u30df\u30f3\u30b0\u3067\u3059\u3002\u304a\u305d\u3089\u304f\u30de\u30a4\u30af\u306e\u51fa\u529b\u304c\u5b89\u5b9a\u3057\u3066\u3044\u306a\u3044\u305f\u3081\u3060\u3068\u601d\u308f\u308c\u307e\u3059\u30028kHz\u306e\u5834\u5408\u30010.5\u79d2(2us*2^18)\u307b\u3069\u8aad\u307f\u98db\u3070\u305b\u3070\u5b89\u5b9a\u3057\u305f\u90e8\u5206\u306e\u307f\u53ce\u9332\u304c\u53ef\u80fd\u3067\u3059\u3002\n\n#\u307e\u3068\u3081\n\u30de\u30a4\u30af\u81ea\u4f53\u306f\u63a5\u7d9a\u3067\u304d\u307e\u3057\u305f\u304c\u3001RAM\u306e\u5236\u7d04\u4e0a\u53d6\u308a\u8fbc\u3093\u3060\u97f3\u58f0\u304c\u77ed\u3044\u3067\u3059\u3002\u307e\u305f\u96c6\u97f3\u3068\u5916\u90e8\u3078\u306e\u8ee2\u9001\u304c\u540c\u6642\u306b\u3067\u304d\u307e\u305b\u3093\u3002\u3053\u306e\u554f\u984c\u306e\u89e3\u6c7a\u7b56\u3068\u3057\u3066I2S\u3092\u5229\u7528(DMA\u306b\u3088\u308b\u30e1\u30e2\u30ea\u8ee2\u9001)\u304c\u8003\u3048\u3089\u308c\u307e\u3059\u3002\u3053\u3061\u3089\u306b\u3064\u3044\u3066\u306f\u53d6\u308a\u7d44\u307f\u4e2d\u3067\u3059\u304c\u3002\u3002\u3002\n"}