{"tags": ["Spark"], "context": " More than 1 year has passed since last update.\n\n\u306f\u3058\u3081\u306b\n\u3053\u3093\u306b\u3061\u306f\u3002\n\u3053\u306e\u8a18\u4e8b\u306fApache Spark Advent Calendar 2015\u306e19\u65e5\u76ee\u306e\u8a18\u4e8b\u3067\u3059\u3002\n\nSpark\u3092\u4f7f\u3046\u306b\u3042\u305f\u3063\u3066\u56f0\u308b\u70b9\nSpark\u3092\u4f7f\u3063\u3066\u3044\u308b\u7686\u3055\u3093\u306a\u3089\u5b9f\u611f\u3057\u3064\u3064\u3042\u308b\u3068\u601d\u3044\u307e\u3059\u304c\u3001Spark\u306b\u306f\u56f0\u3063\u305f\u70b9\u3082\u3042\u308a\u307e\u3059\u3002\n\u3068\u308a\u3042\u3048\u305a\u30b5\u30f3\u30d7\u30eb\u3092\u52d5\u304b\u3059\u3060\u3051\u3001\u3067\u3042\u308c\u3070\u305d\u308c\u307b\u3069\u82e6\u52b4\u3059\u308b\u3053\u3068\u306f\u7121\u3044\u306e\u3067\u3059\u304c\u3001\u5b9f\u969b\u306b\u5927\u898f\u6a21\u30c7\u30fc\u30bf\u3092\u7528\u3044\u3066\u4f7f\u7528\u3057\u51fa\u3059\u3068\u3001\u4e0b\u8a18\u306e\u3088\u3046\u306a\u554f\u984c\u304c\u983b\u767a\u3057\u307e\u3059\u3002\n\n\u9069\u5207\u306a\u30c1\u30e5\u30fc\u30cb\u30f3\u30b0\u304c\u65bd\u3055\u308c\u3066\u3044\u306a\u3044\u3068\u30b9\u30d4\u30fc\u30c9\u304c\u51fa\u306a\u3044\n\u4e00\u90e8\u306e\u30b3\u30f3\u30dd\u30fc\u30cd\u30f3\u30c8\u306f\u305d\u3082\u305d\u3082\u52d5\u304b\u306a\u3044\uff08\u7279\u306bMLlib\uff09\n\u554f\u984c\u304c\u767a\u751f\u3057\u305f\u6642\u3001\u3069\u3053\u3067\u767a\u751f\u3057\u305f\u304b\u304c\u3071\u3063\u3068\u306f\u308f\u304b\u308a\u306b\u304f\u3044\n\n\u305d\u306e\u305f\u3081\u3001\u3042\u308b\u7a0b\u5ea6\u5185\u90e8\u69cb\u9020\u304b\u3001\u30c1\u30e5\u30fc\u30cb\u30f3\u30b0\u306e\u52d8\u6240\u3092\u304a\u3055\u3048\u3066\u304a\u304b\u306a\u3044\u3068\u82e6\u52b4\u3059\u308b\u3053\u3068\u306b\u306a\u308a\u307e\u3059\u3002\n\u512a\u308c\u3066\u306f\u3044\u308b\u3093\u3067\u3059\u304c\u3001\u305d\u306e\u5206\u30d4\u30fc\u30ad\u30fc\u306a\u30d5\u30ec\u30fc\u30e0\u30ef\u30fc\u30af\u3001\u3068\u3044\u3046\u306e\u304cMapReduce\u3068\u6bd4\u3079\u305f\u79c1\u306e\u5370\u8c61\u3067\u3059\u3002\n\u305d\u3093\u306a\u308f\u3051\u3067\u3001Spark\u306e\u5185\u90e8\u69cb\u9020\u3092\u8aac\u660e\u3057\u305f\u8cc7\u6599\u306f\u7121\u3044\u306e\u304b\u306a\u3001\u3068\u3044\u3046\u5f62\u3067\u624b\u9803\u306a\u8cc7\u6599\u304c\u306a\u3044\u304b\u3092\u78ba\u8a8d\u3057\u305f\u6240\u3001SparkInternals\u3068\u3044\u3046\u8cc7\u6599\u304c\u898b\u3064\u304b\u3063\u305f\u305f\u3081\u3001\u305d\u308c\u3092\u8aad\u3093\u3060\u7d50\u679c\u3092\u307e\u3068\u3081\u3066\u307f\u307e\u3059\u3002\n\u82e5\u5e72\u53e4\u3044\u30d0\u30fc\u30b8\u30e7\u30f3\u306eSpark\u306e\u5185\u5bb9\u306b\u306a\u308a\u307e\u3059\u304c\u3001\u305d\u308c\u3067\u3082\u5927\u4f53\u306e\u6d41\u308c\u306f\u898b\u3048\u308b\u69cb\u6210\u3068\u306a\u3063\u3066\u3044\u307e\u3059\u3002\uff08\u672a\u5b8c\u7d50\u3001\u304b\u3064\u3053\u306e\u6295\u7a3f\u3067\u306f\u5168\u90e8\u306f\u8a33\u305b\u3066\u3044\u307e\u305b\u3093\u304c\uff09\n\u5c1a\u3001\u6587\u3092\u5168\u3066\u8a33\u3057\u3066\u3044\u308b\u308f\u3051\u3067\u306f\u306a\u304f\u3001\u5927\u4f53\u610f\u5473\u304c\u901a\u308a\u305d\u3046\u3001\u3068\u3044\u3046\u30ec\u30d9\u30eb\u306e\u8aad\u8fbc\u307f\u3067\u3059\u306e\u3067\u3001\u305d\u306e\u3042\u305f\u308a\u306f\u3054\u4e86\u627f\u304f\u3060\u3055\u3044\u3002\n\u30fb\u30fb\u3068\u3044\u3044\u3064\u3064\u3001\u5927\u90e8\u5206\u306f\u305d\u306e\u307e\u307e\u8a33\u3057\u3066\u3057\u307e\u3063\u3066\u3044\u307e\u3059\u304c\u3002\n\u4ee5\u5f8c\u3001\u4e0b\u8a18\u306e\u5224\u4f8b\u3068\u306a\u308a\u307e\u3059\u3002\nSparkInternals\u8a33\u6587\n\u30b3\u30e1\u30f3\u30c8\n\nSparkInternals\n\nOverview of Apache Spark\n\u3053\u306e\u7ae0\u3067\u306f\u4e0b\u8a18\u306e\u8cea\u554f\u306b\u5bfe\u3057\u3066\u7126\u70b9\u3092\u5f53\u3066\u3066\u8a18\u8ff0\u3059\u308b\u3002\n- \u30c7\u30d7\u30ed\u30a4\u6210\u529f\u5f8c\u3001\u5404\u30ce\u30fc\u30c9\u3067\u3069\u306e\u3088\u3046\u306b\u30b5\u30fc\u30d3\u30b9\u304c\u5b9f\u884c\u3055\u308c\u308b\u304b\uff1f\n- \u3069\u306e\u3088\u3046\u306bSpark\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u304c\u751f\u6210\u5b9f\u884c\u3055\u308c\u308b\u304b\uff1f\n\n\u30c7\u30d7\u30ed\u30a4\u56f3\n\nStandalone Cluster\u30e2\u30fc\u30c9\u306e\u5834\u5408\u3001\u30c7\u30d7\u30ed\u30a4\u306e\u6d41\u308c\u306f\u4e0a\u8a18\u306b\u793a\u3057\u305f\u56f3\u306e\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u308b\u3002\n- SparkCluster\u306fMasterNode\u3068\u8907\u6570\u306eWorkerNode\u304b\u3089\u306a\u308a\u3001Hadoop\u3068\u985e\u4f3c\u3057\u305f\u69cb\u6210\u306b\u306a\u3063\u3066\u3044\u308b\u3002\n- MasterNode\u306fMasterDaemonProcess\u3092\u4fdd\u6301\u3057\u3001WorkerNode\u306e\u7ba1\u7406\u3092\u884c\u3046\u3002\n- WorkerNode\u306fWorkerDaemonProcess\u3092\u4fdd\u6301\u3057\u3001MasterNode\u3068\u306e\u901a\u4fe1\u3068\u3001LocalExecutor\u306e\u7ba1\u7406\u3092\u884c\u3046\u3002\n\u516c\u5f0f\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u4e2d\u3067\u306fDriver\u306fmain\u95a2\u6570\u306e\u5b9f\u884c\u3068SparkContext\u306e\u4f5c\u6210\u3092\u884c\u3046\u3068\u3044\u3046\u8a18\u8ff0\u304c\u3042\u308b\u3002\nDriver\u30d7\u30ed\u30b0\u30e9\u30e0\u3001\u4f8b\u3048\u3070WordCount.scala\u306fSpark\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3068\u307f\u306a\u3055\u308c\u3066\u3044\u308b\u3002Driver\u30d7\u30ed\u30b0\u30e9\u30e0\u306f\u4e0b\u8a18\u306e\u3088\u3046\u306a\u30b3\u30de\u30f3\u30c9\u3067MasterNode\u3067\u8d77\u52d5\u3055\u308c\u308b\u3002\n./bin/run-example SparkPi 10\n\nSparkPi\u30d7\u30ed\u30b0\u30e9\u30e0\u306fMasterNode\u4e0a\u3067Driver\u30d7\u30ed\u30b0\u30e9\u30e0\u3068\u3057\u3066\u52d5\u4f5c\u3059\u308b\u3002\u3057\u304b\u3057\u306a\u304c\u3089\u3001Driver\u30d7\u30ed\u30b0\u30e9\u30e0\u304cYARN\u30af\u30e9\u30b9\u30bf\u306bsubmit\u3055\u308c\u305f\u5834\u5408\u3001Driver\u30d7\u30ed\u30b0\u30e9\u30e0\u306fWorkerNode\u4e0a\u306b\u30b9\u30b1\u30b8\u30e5\u30fc\u30ea\u30f3\u30b0\u3055\u308c\u308b\u3053\u3068\u3082\u3042\u308b\u3002\uff08\u4f8b\u3048\u3070WorkerNode 2\u306e\u3088\u3046\u306a\uff09\nDriver\u30d7\u30ed\u30b0\u30e9\u30e0\u304c\u30ed\u30fc\u30ab\u30eb\u30de\u30b7\u30f3\u3067\u4e0b\u8a18\u306e\u3088\u3046\u306a\u30b3\u30fc\u30c9\u3092\u5b9f\u884c\u3057\u3066\u8d77\u52d5\u3057\u305f\u5834\u5408\u306f\u307e\u305f\u72b6\u6cc1\u304c\u5909\u308f\u308b\u3002\nval sc = new SparkContext(\"spark://master:7077\", \"AppName\")\n...\n\nDriver\u30d7\u30ed\u30b0\u30e9\u30e0\u306f\u30ed\u30fc\u30ab\u30eb\u30de\u30b7\u30f3\u4e0a\u3067\u52d5\u304f\u304c\u3001\u3053\u306e\u65b9\u6cd5\u306f\u30ed\u30fc\u30ab\u30eb\u30de\u30b7\u30f3\u304cWorkerNode\u3068\u540c\u4e00\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u306b\u6240\u5c5e\u3057\u3066\u3044\u306a\u3044\u3053\u3068\u3082\u591a\u304f\u3001Driver\u3068Executor\u9593\u3067\u306e\u901a\u4fe1\u901f\u5ea6\u306e\u554f\u984c\u306b\u3088\u3063\u3066\u5b9f\u884c\u304c\u9045\u304f\u306a\u308b\u30b1\u30fc\u30b9\u304c\u591a\u3044\u305f\u3081\u3001\u304a\u52e7\u3081\u3057\u306a\u3044\u3002\n\u5404WorkerNode\u306f\u8907\u6570\u306eExecutorBackend\u30d7\u30ed\u30bb\u30b9\u3092\u7ba1\u7406\u3057\u3066\u3044\u308b\u3002\u5404ExecutorBackend\u30d7\u30ed\u30bb\u30b9\u306f\u8d77\u52d5\u5f8cExecutor\u3092\u7ba1\u7406\u3059\u308b\u3002\u5404Executor\u306f\u30b9\u30ec\u30c3\u30c9\u30d7\u30fc\u30eb\u3092\u4fdd\u6301\u3057\u3001\u5404Task\u304c\u30b9\u30ec\u30c3\u30c9\u4e0a\u3067\u5b9f\u884c\u3055\u308c\u308b\u3002\nSpark\u306b\u304a\u3044\u3066\u5404\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306fDriver\u3068\u8907\u6570\u306eExecutor\u3092\u4fdd\u6301\u3059\u308b\u3002\u540c\u4e00Executor\u4e0a\u3067\u5b9f\u884c\u3055\u308c\u308bTask\u306f\u5168\u3066\u540c\u4e00\u30d7\u30ed\u30bb\u30b9\u306b\u6240\u5c5e\u3059\u308b\u5f62\u306b\u306a\u308b\u3002\nStandalone Cluster\u30e2\u30fc\u30c9\u306e\u5834\u5408\u3001ExecutorBackend\u306fCoarseGrainedExecutorBackend\u3068\u3057\u3066\u521d\u671f\u5316\u3055\u308c\u308b\u3002\nWorkerNode\u306f\u5404CoarseGrainedExecutorBackend\u30d7\u30ed\u30bb\u30b9\u3092ExecutorRunner\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3068\u3057\u3066\u7ba1\u7406\u3059\u308b\u3002\n\nA simple Spark application\n\u4ee5\u4e0b\u306e\u30b5\u30f3\u30d7\u30eb\u306fspark-example\u30d1\u30c3\u30b1\u30fc\u30b8\u306b\u542b\u307e\u308c\u308bGroupByTest\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3067\u3042\u308b\u3002\nMasterNode\u3067\u4e0b\u8a18\u306e\u3088\u3046\u306a\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3059\u308b\u3053\u3068\u3067\u8d77\u52d5\u3055\u308c\u308b\u3002\n/* Usage: GroupByTest [numMappers] [numKVPairs] [valSize] [numReducers] */\n\nbin/run-example GroupByTest 100 10000 1000 36\n\n\u4e0a\u8a18\u306e\u30b3\u30de\u30f3\u30c9\u3067\u5b9f\u884c\u3055\u308c\u308b\u30d7\u30ed\u30b0\u30e9\u30e0\u306f\u4e0b\u8a18\u3002\n\nGroupByTest.scala\npackage org.apache.spark.examples\n\nimport java.util.Random\n\nimport org.apache.spark.{SparkConf, SparkContext}\nimport org.apache.spark.SparkContext._\n\n/**\n  * Usage: GroupByTest [numMappers] [numKVPairs] [valSize] [numReducers]\n  */\nobject GroupByTest {\n  def main(args: Array[String]) {\n    val sparkConf = new SparkConf().setAppName(\"GroupBy Test\")\n    var numMappers = 100\n    var numKVPairs = 10000\n    var valSize = 1000\n    var numReducers = 36\n\n    val sc = new SparkContext(sparkConf)\n\n    val pairs1 = sc.parallelize(0 until numMappers, numMappers).flatMap { p =>\n      val ranGen = new Random\n      var arr1 = new Array[(Int, Array[Byte])](numKVPairs)\n      for (i <- 0 until numKVPairs) {\n        val byteArr = new Array[Byte](valSize)\n        ranGen.nextBytes(byteArr)\n        arr1(i) = (ranGen.nextInt(Int.MaxValue), byteArr)\n      }\n      arr1\n    }.cache\n    // Enforce that everything has been calculated and in cache\n    pairs1.count\n\n    println(pairs1.groupByKey(numReducers).count)\n\n    sc.stop()\n  }\n}\n\n\n\u4e0a\u8a18\u306e\u3088\u3046\u306a\u30b3\u30fc\u30c9\u304c\u982d\u306e\u4e2d\u3067\u306f\u4e0b\u8a18\u306e\u3088\u3046\u306b\u5b9f\u884c\u3055\u308c\u308b\u3068\u601d\u308f\u308c\u308b\u3002\n\n\u3053\u308c\u306f\u5358\u7d14\u306a\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306a\u306e\u3067\u3001\u5404\u30b9\u30c6\u30c3\u30d7\u3067\u30c7\u30fc\u30bf\u304c\u3069\u306e\u3088\u3046\u306b\u5909\u52d5\u3059\u308b\u304b\u3092\u8ffd\u3063\u3066\u307f\u308b\u3002\n\nSparkConf\u304c\u521d\u671f\u5316\u3055\u308c\u308b\u3002\n\nnumMappers=100, numKVPairs=10,000, valSize=1000, numReducers=36\u3068\u3057\u3066\u521d\u671f\u5316\u3055\u308c\u308b\u3002\nSparkContext\u304c\u521d\u671f\u5316\u3055\u308c\u3001Driver\u306b\u5fc5\u8981\u306a\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3068\u30a2\u30af\u30bf\u30fc\u985e\u304c\u751f\u6210\u3055\u308c\u308b\u3002\n\u5404Mapper\u3067\u306farr1: Array[(Int, Byte[])]\u3092\u751f\u6210\u3057\u3001numKVPairs\u500b\u306e\u8981\u7d20\u3092\u4fdd\u6301\u3059\u308b\u3002\u5404Int\u5024\u306f\u30e9\u30f3\u30c0\u30e0\u306e\u6574\u6570\u5024\u3068\u306a\u3063\u3066\u304a\u308a\u3001\u5404Byte\u914d\u5217\u306e\u30b5\u30a4\u30ba\u306fvalSize\u3068\u306a\u3063\u3066\u3044\u308b\u3002 arr1\u306e\u30b5\u30a4\u30ba\u306fnumKVPairs * (4 + valSize) \u3088\u308a10MB\u3068\u8a08\u7b97\u3055\u308c\u308b\u305f\u3081\u3001pairs1\u306e\u30b5\u30a4\u30ba\u306fnumMappers * Size(arr1)\u3088\u308a1000MB\u3068\u306a\u308b\u3002\n\u5404Mapper\u306farr1\u3092\u30e1\u30e2\u30ea\u4e0a\u306b\u30ad\u30e3\u30c3\u30b7\u30e5\u3059\u308b\u3088\u3046\u6307\u5b9a\u3055\u308c\u3066\u3044\u308b\u3002\ncount()\u30a2\u30af\u30b7\u30e7\u30f3\u304c\u5168Mapper\u4e0a\u306earr1\u306e\u8981\u7d20\u6570\u306e\u5408\u8a08\u3092\u53d6\u5f97\u3059\u308b\u3088\u3046\u52d5\u4f5c\u3057\u3001\u7d50\u679c\u306fnumMappers * numKVPairs\u304b\u30891,000,000\u3068\u306a\u308b\u3002\u3053\u306e\u30a2\u30af\u30b7\u30e7\u30f3\u306b\u3088\u3063\u3066\u5b9f\u969b\u306barr1\u306e\u8a08\u7b97\u304c\u304a\u3053\u306a\u308f\u308c\u3001\u30ad\u30e3\u30c3\u30b7\u30e5\u3055\u308c\u308b\u3002\ngroupByKey\u30aa\u30da\u30ec\u30fc\u30b7\u30e7\u30f3\u306f\u30ad\u30e3\u30c3\u30b7\u30e5\u3055\u308c\u305fpairs1\u306b\u5bfe\u3057\u3066\u5b9f\u884c\u3055\u308c\u308b\u3002Reducer\u6570\uff08\uff1d\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u6570\uff09\u306fnumReducers\u3067\u793a\u3055\u308c\u308b\u3002 \u7406\u8ad6\u4e0a\u3001\u3082\u3057hash(key)\u304c\u4e0a\u624b\u304f\u5206\u6563\u3055\u308c\u305f\u5834\u5408\u3001\u5404Reducer\u306fnumMappers * numKVPairs / numReducer\u3088\u308a27,777\u500b\u306e(Int, Array[Byte])\u30da\u30a2\u3092\u53d7\u4fe1\u3059\u308b\u3002\u305d\u306e\u305f\u3081\u3001\u5404Reducer\u4e0a\u306b\u304a\u3051\u308b\u30c7\u30fc\u30bf\u30b5\u30a4\u30ba\u306fSize(pairs1) / numReducer\u3088\u308a27MB\u3068\u306a\u308b\u3002\nReducer\u306f\u540c\u4e00\u306eInt\u30ad\u30fc\u5024\u3092\u4fdd\u6301\u3059\u308b\u30ec\u30b3\u30fc\u30c9\u3092\u30de\u30fc\u30b8\u3057\u3001(Int, List(Byte[], Byte[], ..., Byte[]))\u306e\u7d50\u679c\u3092\u751f\u6210\u3059\u308b\u3002\n\u6700\u5f8c\u306bcount()\u30a2\u30af\u30b7\u30e7\u30f3\u304c\u5404Reducer\u4e0a\u3067\u306e\u30ec\u30b3\u30fc\u30c9\u6570\u306e\u5408\u8a08\u5024\u3092\u53d6\u5f97\u3057\u3001\u6700\u7d42\u7684\u306a\u7d50\u679c\u306fparis1\u4e2d\u306e\u30ad\u30fc\u91cd\u8907\u3092\u6392\u9664\u3057\u305f\u500b\u6570\u3068\u306a\u308b\u3002\n\n\nLogical Plan\n\u5b9f\u969b\u306e\u5b9f\u884c\u624b\u9806\u306f\u524d\u8ff0\u306e\u3082\u306e\u3088\u308a\u3082\u8907\u96d1\u306a\u3082\u306e\u3068\u306a\u3063\u3066\u3044\u308b\u3002\u5927\u307e\u304b\u306a\u6d41\u308c\u3068\u3057\u3066\u3001Spark\u306f\u307e\u305aLogicalPlan\uff08DataDependencyGraph\u3068\u547c\u3070\u308c\u308b\uff09\u3092\u5404\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306b\u5bfe\u3057\u3066\u4f5c\u6210\u3057\u3001LogicalPlan\u3092\u57fa\u306bPhysicalPlan\uff08Map/Reduce\u306eStage\u306eDAG\uff09\u3092\u4f5c\u6210\u3059\u308b\u3002\u305d\u306e\u5f8c\u3001Stage\u3092\u66f4\u306b\u5206\u5272\u3057\u305fTask\u3092Map/Reduce\u3068\u3057\u3066\u8d77\u52d5\u3057\u3001\u5165\u529b\u30c7\u30fc\u30bf\u3092\u51e6\u7406\u3059\u308b\u3002\u3042\u308b\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306eLogicalPlan\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u308b\u3002\nRDD.toDebugString\u95a2\u6570\u3092\u5b9f\u884c\u3059\u308b\u3068RDD\u306eLogicalPlan\u304c\u51fa\u529b\u3055\u308c\u308b\u304c\u3001\u968e\u5c64\u306b\u793a\u3059\u3068\u4e0b\u8a18\u306e\u3088\u3046\u306b\u306a\u308b\u3002\n  MapPartitionsRDD[3] at groupByKey at GroupByTest.scala:51 (36 partitions)\n    ShuffledRDD[2] at groupByKey at GroupByTest.scala:51 (36 partitions)\n      FlatMappedRDD[1] at flatMap at GroupByTest.scala:38 (100 partitions)\n        ParallelCollectionRDD[0] at parallelize at GroupByTest.scala:38 (100 partitions)\n\n\n\u306a\u304a\u3001\u5404Partition\u306f\u72ec\u7acb\u3057\u3066\u51e6\u7406\u3055\u308c\u308b\u305f\u3081\u3001\u5168\u30c7\u30fc\u30bf\u304c\u540c\u4e00\u306e\u30bf\u30a4\u30df\u30f3\u30b0\u3067\u30e1\u30e2\u30ea\u4e0a\u306b\u5b58\u5728\u3059\u308b\u308f\u3051\u3067\u306f\u306a\u3044\u3002\n\u8a73\u7d30\u306f\u4ee5\u4e0b\u306e\u901a\u308a\u3002\n\n\u30e6\u30fc\u30b6\u5074\u3067100\u306e\u6574\u6570\u5024\u3092\u4fdd\u6301\u3059\u308b\u914d\u5217(\u4eca\u56de\u306e\u5834\u54080\uff5e99)\u3092\u521d\u671f\u5316\u3059\u308b\u3002\nparallelize()\u306f\u5404\u8981\u7d20\u304c\u6574\u6570\u5024i\u3092\u542b\u3080ParallelCollectionRDD\u3092\u751f\u6210\u3059\u308b\u3002\nflatMap\u30e1\u30bd\u30c3\u30c9\u306b\u3088\u3063\u3066ParallelCollectionRDD\u304b\u3089FlatMappedRDD\u304c\u751f\u6210\u3055\u308c\u308b\u3002\nFlatMappedRDD\u306e\u5404Partition\u306f[(Int, Array[Byte])]\u306e\u914d\u5217\u3092\u4fdd\u6301\u3059\u308b\u3002\ncount()\u304cFlatMappedRDD\u306b\u5bfe\u3057\u3066\u5b9f\u884c\u3055\u308c\u308b\u3002\nFlatMappedRDD\u304c\u30e1\u30e2\u30ea\u306b\u30ad\u30e3\u30c3\u30b7\u30e5\u3055\u308c\u308b\u3002\uff08\u8272\u3092\u5909\u3048\u3066\u3042\u308b\uff09\ngroupByKey()\u304c\u7d9a\u304f2\u3064\u306eRDD(ShuffledRDD and MapPartitionsRDD)\u3092\u751f\u6210\u3059\u308b\u3002\uff08\u8a73\u7d30\u306b\u3064\u3044\u3066\u306f\u5f8c\u306e\u7ae0\u3067\u8aac\u660e\uff09\nShuffleRDD\u306fLogicalPlan\u4e2d\u3067\u306fShuffle\u304c\u5fc5\u8981\u306a\u30b8\u30e7\u30d6\u3068\u3057\u3066\u793a\u3055\u308c\u3066\u3044\u308b\u3002Shuffle\u306fHadoop MapReduce\u3067\u306eShuffle\u3068\u5171\u901a\u3002\nMapPartitionRDD\u304cgroupByKey()\u306e\u7d50\u679c\u3092\u4fdd\u6301\u3059\u308b\u3002\nMapPartitionRDD(Array[Byte])\u306e\u5404\u8981\u7d20\u304cIterable\u306b\u5909\u63db\u3055\u308c\u308b\u3002\n\u6700\u7d42\u7684\u306acount()\u30a2\u30af\u30b7\u30e7\u30f3\u304cMapPartitionRDD\u306b\u5bfe\u3057\u3066\u5b9f\u884c\u3055\u308c\u308b\u3002\nLogicalPlan\u306f\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u30c7\u30fc\u30bf\u30d5\u30ed\u30fc\uff08Transformation\u7fa4\u3001\u5185\u90e8RDD\u3001RDD\u9593\u306e\u4f9d\u5b58\u95a2\u4fc2 \uff09\u3092\u793a\u3057\u3066\u3044\u308b\u3002\n\n\nPhysical Plan\nLogicalPlan\u304c\u30c7\u30fc\u30bf\u30d5\u30ed\u30fc\u306e\u5b9a\u7fa9\u306b\u7126\u70b9\u3092\u5f53\u3066\u3066\u304a\u308a\u3001\u5b9f\u969b\u306e\u5b9f\u884c\u30d5\u30ed\u30fc\u306b\u3064\u3044\u3066\u306f\u89e6\u308c\u3066\u3044\u306a\u3044\u3002\u30c7\u30fc\u30bf\u30d5\u30ed\u30fc\u3068\u5b9f\u884c\u30d5\u30ed\u30fc\u306fHadoop\u3067\u306f\u540c\u4e00\u306e\u3082\u306e\u3068\u306a\u3063\u3066\u3044\u308b\u3002Hadoop\u306b\u304a\u3044\u3066\u306f\u30c7\u30fc\u30bf\u30d5\u30ed\u30fc\u306f\u4e8b\u524d\u5b9a\u7fa9\u3001\u304b\u3064\u56fa\u5b9a\u5316\u3055\u308c\u305f\u3082\u306e\u3068\u306a\u3063\u3066\u304a\u308a\u3001\u305d\u306e\u4e2d\u3067\u5b9f\u884c\u3055\u308c\u308bMap/Reduce\u3092\u30e6\u30fc\u30b6\u304c\u5b9a\u7fa9\u3057\u3066\u3044\u308b\u3002Map/Reduce\u30bf\u30b9\u30af\u306f\u56fa\u5b9a\u3055\u308c\u305f\u5b9f\u884c\u30b9\u30c6\u30c3\u30d7\u306b\u5f93\u3063\u3066\u5b9f\u884c\u3055\u308c\u308b\u3002\u3057\u304b\u3057\u3001Spark\u306b\u304a\u3044\u3066\u306f\u30c7\u30fc\u30bf\u30d5\u30ed\u30fc\u306f\u67d4\u8edf\u304b\u3064\u8907\u96d1\u306a\u3082\u306e\u3068\u306a\u3063\u3066\u3044\u308b\u305f\u3081\u3001\u5358\u7d14\u306b\u30c7\u30fc\u30bf\u30d5\u30ed\u30fc\u3068\u5b9f\u884c\u30d5\u30ed\u30fc\u3092\u540c\u4e00\u5316\u3059\u308b\u3053\u3068\u306f\u56f0\u96e3\u3067\u3042\u308b\u3002\u305d\u306e\u305f\u3081\u3001Spark\u306f\u30c7\u30fc\u30bf\u30d5\u30ed\u30fc\u3068\u5b9f\u969b\u306b\u30bf\u30b9\u30af\u3092\u5b9f\u884c\u3059\u308b\u5b9f\u884c\u30d5\u30ed\u30fc\u3092\u5207\u308a\u5206\u3051\u3001\u30c7\u30fc\u30bf\u30d5\u30ed\u30fc\u3092\u5b9f\u884c\u30d5\u30ed\u30fc\u306b\u5909\u63db\u3059\u308b\u4ed5\u7d44\u307f\u3092\u5c0e\u5165\u3057\u3066\u3044\u308b\u3002\u3053\u3053\u3067\u306f\u305d\u306e\u30c7\u30fc\u30bf\u30d5\u30ed\u30fc\u304b\u3089\u5b9f\u884c\u30d5\u30ed\u30fc\u3078\u306e\u5909\u63db\u306b\u3064\u3044\u3066\u793a\u3059\u3002\n\u3067\u306f\u3001\u524d\u8ff0\u306e\u30b5\u30f3\u30d7\u30eb\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3092\u57fa\u306bPhysicalDAGPlan\u306b\u3064\u3044\u3066\u898b\u3066\u3044\u304f\u3002\n\n\u4e0a\u8a18\u306e\u56f3\u304b\u3089\u3001GroupByTest\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306f2\u500b\u306eSpark\u30b8\u30e7\u30d6\u3092\u751f\u6210\u3059\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n\u306f\u3058\u3081\u306e\u30b8\u30e7\u30d6\u306f\u521d\u56de\u306b\u5b9f\u884c\u3055\u308c\u308bcount\u30a2\u30af\u30b7\u30e7\u30f3\u3067\u3042\u308a\u3001\u8a73\u7d30\u306f\u4ee5\u4e0b\u306e\u3068\u304a\u308a\u3068\u306a\u308b\u3002\n\u30b8\u30e7\u30d6\u306f1Stage(100\u306eResultTask\u3092\u4fdd\u6301)\u304b\u3089\u69cb\u6210\u3055\u308c\u308b\u3002\u3053\u3053\u3067\u306eStage\u306fHadoop\u306eMap Stage\u3068\u4f3c\u3066\u3044\u308b\u3002\uff08\u56f3\u4e2d\u3067\u306f\u793a\u3055\u308c\u306a\u3044\u304c\uff09\n\u6700\u521d\u306e\u30b8\u30e7\u30d6\u306f\u3064\u307e\u308a\u306f\u4e0b\u306b\u3042\u308bfirst count()\u3067\u793a\u3055\u308c\u308bresut 1 \uff5e result 99\u304c\u8868\u793a\u3055\u308c\u3066\u3044\u308b\u90e8\u5206\u306e\u307f\u3092\u793a\u3059\u308f\u3051\u3067\u3059\u306d\u3002\n\u5404Task\u306fflatMap\u95a2\u6570\u3092\u5b9f\u884c\u3057\u3001FlatMappedRDD\u3092\u751f\u6210\u3059\u308b\u3002\u305d\u306e\u5f8ccount\u30a2\u30af\u30b7\u30e7\u30f3\u3092\u5b9f\u884c\u3059\u308b\u3053\u3068\u3067\u5404Partition\u304c\u4fdd\u6301\u3059\u308b\u30ec\u30b3\u30fc\u30c9\u6570\u3092\u30ab\u30a6\u30f3\u30c8\u3059\u308b\u3002\u4f8b\u3048\u3070\u3001Partition99\u306f\u56f3\u4e2d\u3067\u306f9\u500b\u306e\u30ec\u30b3\u30fc\u30c9\u3092\u4fdd\u6301\u3059\u308b\u305f\u3081\u3001Partition99\u306ecount\u7d50\u679c\u306f9\u3068\u306a\u308b\u3002\npairs1\u306f\u30ad\u30e3\u30c3\u30b7\u30e5\u3055\u308c\u308b\u3053\u3068\u3092\u6307\u5b9a\u3055\u308c\u3066\u3044\u308b\u305f\u3081\u3001\u672cTask\u5b9f\u884c\u6642\u306bFlatMappedRDD\u306ePartition\u7fa4\u306fExecutor\u306e\u30e1\u30e2\u30ea\u4e0a\u306b\u4fdd\u5b58\u3055\u308c\u3001\u305d\u308c\u306f\u5b9f\u884c\u4e2d\u5e38\u6642\u4fdd\u6301\u3055\u308c\u308b\u3002\nResultTask\u7fa4\u7d42\u4e86\u5f8c\u3001Driver\u306f\u5404Task\u306e\u7d50\u679c\u304b\u3089\u7d50\u679c\u3092\u53ce\u96c6\u3057\u3001\u305d\u308c\u3092\u5408\u8a08\u3057\u3066\u7d50\u679c\u3092\u7b97\u51fa\u3059\u308b\u3002\n\u3053\u308c\u3067\u30b8\u30e7\u30d60\u304c\u7d42\u4e86\u3068\u306a\u308b\u3002\n\u6b21\u306e\u30b8\u30e7\u30d6\u306fpairs1.groupByKey(numReducers).count\u306e\u5b9f\u884c\u306b\u3088\u3063\u3066\u8d77\u52d5\u3055\u308c\u308b\u3002\n\u3053\u306e\u30b8\u30e7\u30d6\u306f2\u500b\u306eStage\u304b\u3089\u69cb\u6210\u3055\u308c\u308b\u3002\n\u5de6\u4e0a\u306eShuffleTask\u3068\u3001\u53f3\u4e0a\u306eResultTask\u304c\u5bfe\u8c61\u3068\u306a\u308a\u307e\u3059\u3002\nStage0\u306f100\u500b\u306eShuffleMapTask\u3092\u4fdd\u6301\u3057\u3001\u5404Task\u306fparis1\u306ePartition\u3092\u30ad\u30e3\u30c3\u30b7\u30e5\u304b\u3089\u8aad\u307f\u8fbc\u307f\u3001Repartition\u3092\u884c\u3044\u3001\u305d\u306eRepartition\u5b9f\u884c\u7d50\u679c\u3092\u30ed\u30fc\u30ab\u30eb\u30c7\u30a3\u30b9\u30af\u306b\u51fa\u529b\u3059\u308b\u3002\u3053\u306e\u904e\u7a0b\u306fHadoop MapReduce\u306b\u304a\u3044\u3066Map\u304c\u7d50\u679c\u306e\u5404Partition\u3092\u51fa\u529b\u3059\u308b\u51e6\u7406\u3068\u5171\u901a\u3002\n\u5c1a\u3001\u3053\u306e\u5148\u3092\u8aad\u3093\u3060\u9650\u308a\u3067\u3082Repartition\u304c\u8d70\u308b\u51e6\u7406\u3092\u5b9f\u884c\u3057\u305f\u5834\u5408\u306b\u306f\u30c7\u30fc\u30bf\u3092\u5168\u3066\u30ed\u30fc\u30ab\u30eb\u30c7\u30a3\u30b9\u30af\u306b\u51fa\u529b\u3059\u308b\u51e6\u7406\u304c\u5e38\u6642\u8d70\u308a\u3001\u8a2d\u5b9a\u3067\u7121\u52b9\u5316\u3059\u308b\u3053\u3068\u3082\u51fa\u6765\u306a\u3044\u3088\u3046\u3067\u3059\u3002\nStage1\u306f36\u500b\u306eResultTasks\u3092\u4fdd\u6301\u3059\u308b\u3002\u5404Task\u306f\u5404\u30d7\u30ed\u30bb\u30b9\u304c\u5fc5\u8981\u3068\u3059\u308b\u30c7\u30fc\u30bf\u3092\u53d6\u5f97\u3057\u3001Shuffle\u3059\u308b\u3002\u30c7\u30fc\u30bf\u53d6\u5f97\u5f8c\u30c7\u30fc\u30bf\u3092\u7d71\u5408\u3057\u3001mapPartitions\u51e6\u7406\u3092\u30d1\u30a4\u30d7\u30e9\u30a4\u30f3\u306e\u3088\u3046\u306b\u5b9f\u884c\u3059\u308b\u3002\u6700\u7d42\u7684\u306b\u3001count\u30a2\u30af\u30b7\u30e7\u30f3\u304c\u5b9f\u884c\u3055\u308c\u3001\u5404\u7d50\u679c\u306e\u53d6\u5f97\u304c\u884c\u308f\u308c\u308b\u3002\nResultTasks\u7d42\u4e86\u5f8c\u3001Driver\u306fTask\u306e\u5b9f\u884c\u7d50\u679c\u3092\u53d6\u5f97\u3057\u3001\u5408\u8a08\u3059\u308b\u3002\n\u3053\u308c\u3067\u30b8\u30e7\u30d61\u304c\u7d42\u4e86\u3068\u306a\u308b\u3002\n\u4ee5\u4e0a\u3067\u308f\u304b\u308b\u3088\u3046\u306b\u3001Spark\u306ePhysicalPlan\u306f\u5358\u7d14\u3067\u306f\u306a\u3044\u3002Spark\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306f\u8907\u6570\u306e\u30b8\u30e7\u30d6\u3092\u5185\u5305\u3057\u3001\u5404\u30b8\u30e7\u30d6\u306f\u8907\u6570\u306eStage\u3092\u5185\u5305\u3057\u3001\u5404Stage\u306f\u8907\u6570\u306eTask\u3092\u5185\u5305\u3057\u3066\u3044\u308b\u3002\n\u4ee5\u5f8c\u306e\u7ae0\u3067\u306f\u3053\u308c\u3089\u306e\u30b8\u30e7\u30d6\u3001Stage\u3001Task\u304c\u3069\u3046\u751f\u6210\u3055\u308c\u308b\u304b\u3001\u8a73\u7d30\u3092\u898b\u3066\u3044\u304f\u3002\n\nConclusion\n\u3053\u306e\u7ae0\u3067Spark\u30b8\u30e7\u30d6\u306e\u751f\u6210\u3001\u5b9f\u884c\u306e\u57fa\u790e\u306b\u3064\u3044\u3066\u793a\u3057\u305f\u3002\u4ee5\u5f8c\u306e\u7ae0\u3067\u30ad\u30e3\u30c3\u30b7\u30e5\u306e\u30e1\u30ab\u30cb\u30ba\u30e0\u3084\u30b8\u30e7\u30d6\u306e\u751f\u6210\u3001\u5b9f\u884c\u306e\u8a73\u7d30\u306b\u3064\u3044\u3066\u8aac\u660e\u3059\u308b\u3002\u7ae0\u69cb\u6210\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u308b\u3002\n\nLogical plan generation\nPhysical plan generation\nJob submission and scheduling\nTask's creation, execution and result handling\nHow shuffle is done in Spark\nCache mechanism\nBroadcast mechanism\n\n\nLogical plan of a job (data dependency graph)\n\nAn example of general logical plan\n\n\u4e0a\u8a18\u306e\u56f3\u306f\u4e00\u822c\u7684\u306a\u30b8\u30e7\u30d6\u306eLogicalPlan\u3092\u793a\u3057\u305f\u3082\u306e\u3067\u3001\u6700\u7d42\u7684\u306a\u7d50\u679c\u3092\u7b97\u51fa\u3059\u308b\u307e\u3067\u306b4\u3064\u306eStep\u304b\u3089\u306a\u308b\u3002\n\u6700\u521d\u306eRDD\u3092\u4f55\u304b\u3057\u3089\u306e\u30c7\u30fc\u30bf\u30bd\u30fc\u30b9\uff08\u30e1\u30e2\u30ea\u3001\u30ed\u30fc\u30ab\u30eb\u30d5\u30a1\u30a4\u30eb\u3001HDFS\u3001HBase etc..\uff09\u304b\u3089\u751f\u6210\u3059\u308b\u3002\u5c1a\u3001createRDD\u306f\u524d\u7ae0\u306eparallelize\u3068\u8a18\u8ff0\u3055\u308c\u305f\u7b87\u6240\u3068\u52d5\u4f5c\u3068\u3057\u3066\u306f\u540c\u3058\u3002\nRDD\u306b\u5bfe\u3059\u308b\u5909\u63db\u30aa\u30da\u30ec\u30fc\u30b7\u30e7\u30f3\u7fa4\u306ftransformation()\u3068\u3057\u3066\u8a18\u8ff0\u3055\u308c\u308b\u3002\u5404transformation()\u306f1\u500b\u3001\u307e\u305f\u306f\u8907\u6570\u306eRDD[T]\u3092\u751f\u6210\u3059\u308b\u3002\uff08T\u306fScala\u306e\u578b\uff09\n\u3082\u3057T\u304c(K, V)\u3068\u3044\u3046Key\u3068Value\u306e\u30da\u30a2\u3060\u3063\u305f\u5834\u5408\u3001K\u306f\u30b3\u30ec\u30af\u30b7\u30e7\u30f3\u578b\uff08Array\u3084List\u7b49\uff09\u3092\u8a2d\u5b9a\u3059\u308b\u3053\u3068\u306f\u51fa\u6765\u306a\u3044\u3002\u7406\u7531\u306f\u3001\u30b3\u30ec\u30af\u30b7\u30e7\u30f3\u578b\u306e\u5834\u5408Partition\u3092\u5b9a\u7fa9\u3057\u3066\u5206\u5272\u3059\u308b\u3053\u3068\u304c\u56f0\u96e3\u3068\u306a\u308b\u305f\u3081\u3002\naction\u3068\u8a18\u8ff0\u3055\u308c\u308b\u30a2\u30af\u30b7\u30e7\u30f3\u30aa\u30da\u30ec\u30fc\u30b7\u30e7\u30f3\u306f\u6700\u5f8c\u306eRDD\u306b\u5bfe\u3057\u3066\u5b9f\u884c\u3055\u308c\u3001\u5404Partition\u304b\u3089\u7d50\u679c\u3092\u751f\u6210\u3059\u308b\u3002\n\u5404\u7d50\u679c\u306fDriver\u30d7\u30ed\u30b0\u30e9\u30e0\u306b\u9001\u4fe1\u3055\u308c\u3001f(List[Result])\u304c\u6700\u7d42\u7684\u7d50\u679c\u3068\u3057\u3066\u8a08\u7b97\u3055\u308c\u308b\u3002\u4f8b\u3048\u3070\u3001count\u306faction\u3068sum\u306e2\u30b9\u30c6\u30c3\u30d7\u3092\u7d4c\u308b\u3002\uff08\u5404RDD\u3067action\u3092\u5b9f\u884c\u3057\u3066\u8981\u7d20\u6570\u3092\u30ab\u30a6\u30f3\u30c8\u3057\u3001Driver\u306b\u9001\u4fe1\u3057\u3066\u5408\u8a08\u5024\u8a08\u7b97\uff09\nRDD\u306fcache/persist/checkpoint\u30e1\u30bd\u30c3\u30c9\u3092\u5b9f\u884c\u3059\u308b\u3053\u3068\u3067\u30e1\u30e2\u30ea\u4e0a\u306b\u30ad\u30e3\u30c3\u30b7\u30e5\u3059\u308b\u304b\u3001\u30c7\u30a3\u30b9\u30af\u4e0a\u306b\u4fdd\u5b58\u3059\u308b\u3053\u3068\u304c\u51fa\u6765\u308b\u3002Partition\u6570\u306f\u57fa\u672c\u306f\u30e6\u30fc\u30b6\u306b\u3088\u3063\u3066\u6307\u5b9a\u3055\u308c\u308b\u30022RDD\u9593\u306ePartition\u306e\u30de\u30c3\u30d4\u30f3\u30b0\u306f1:1 or M:N\u306e2\u7a2e\u985e\u304c\u3042\u308b\u3002\u4e0a\u8a18\u306e\u56f3\u306e\u4e2d\u3067\u306f\u4e21\u65b9\u306e\u30d1\u30bf\u30fc\u30f3\u304c\u8a18\u8ff0\u3055\u308c\u3066\u3044\u308b\u3002\n\nLogical Plan\nSpark\u306e\u30b3\u30fc\u30c9\u3092\u66f8\u3044\u3066\u3044\u308b\u6700\u4e2d\u306b\u5b9f\u88c5\u8005\u306f\u982d\u306e\u4e2d\u3067LogicalPlan\uff08\u4f8b\u3048\u3070\u3001\u3044\u304f\u3064\u306eRDD\u304c\u751f\u6210\u3055\u308c\u308b\u304b\uff09\u3092\u601d\u3044\u6d6e\u304b\u3079\u3066\u3044\u308b\u304b\u3082\u3057\u308c\u306a\u3044\u3002\u3060\u304c\u3001\u5b9f\u969b\u306f\u66f4\u306b\u591a\u304f\u306eRDD\u304c\u5b9f\u884c\u4e2d\u306b\u751f\u6210\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u304c\u591a\u3044\u3002\nLogicalPlan\u306e\u751f\u6210\u65b9\u6cd5\u3092\u660e\u78ba\u306b\u3059\u308b\u3053\u3068\u3067\u3001\u4e0e\u3048\u3089\u308c\u305fSparkProgram\u306b\u304a\u3044\u3066\u3044\u304f\u3064RDD\u304c\u751f\u6210\u3055\u308c\u308b\u304b\u3001\u3068\u3044\u3063\u305f\u8cea\u554f\u306b\u3082\u7b54\u3048\u3089\u308c\u308b\u3088\u3046\u306b\u306a\u308b\u3060\u308d\u3046\u3002\n\u3069\u306e\u3088\u3046\u306bRDD\u304c\u751f\u6210\u3055\u308c\u308b\u306e\u304b\uff1f\n\u3069\u306e\u3088\u3046\u306a\u7a2e\u985e\u306eRDD\u304c\u751f\u6210\u3055\u308c\u308b\u306e\u304b\uff1f\n\u3069\u306e\u3088\u3046\u306bRDD\u9593\u304c\u63a5\u7d9a\u3055\u308c\u308b\u306e\u304b\uff1f\uff08\u4f8b\u3048\u3070\u4f9d\u5b58\u95a2\u4fc2\u306b\u3042\u308bRDD\uff09\n\n1. \u3069\u306e\u3088\u3046\u306aRDD\u304c\u3069\u3046\u3084\u3063\u3066\u751f\u6210\u3055\u308c\u308b\u306e\u304b\uff1f\ntransformation\u306f\u57fa\u672c\u306f\u65b0\u305f\u306aRDD\u3092\u4e00\u3064\u751f\u6210\u3059\u308b\u304c\u3001\u3044\u304f\u3064\u304b\u306etransformation\u3067\u306f\u8907\u6570\u306e\u30d5\u30a7\u30fc\u30ba\u306b\u5206\u3051\u3066\u6f14\u7b97\u304c\u884c\u308f\u308c\u305f\u308a\u3001\u30b5\u30d6transformation\u3092\u542b\u3080\u305f\u3081\u8907\u6570\u306eRDD\u3092\u751f\u6210\u3057\u3066\u3044\u308b\u3002\u305d\u308c\u304c\u8003\u3048\u3066\u3044\u308b\u3088\u308a\u3082\u591a\u304f\u306eRDD\u304c\u751f\u6210\u3055\u308c\u308b\u7406\u7531\u3068\u306a\u308b\u3002\nLogicalPlan\u306f\u8a00\u3063\u3066\u3057\u307e\u3048\u3070\u6f14\u7b97\u306e\u9023\u9396\u3068\u3082\u8a00\u3044\u8868\u3059\u3053\u3068\u304c\u51fa\u6765\u308b\u3002\u3042\u3089\u3086\u308bRDD\u306fcompute()\u30e1\u30bd\u30c3\u30c9\u3092\u4fdd\u6301\u3057\u3066\u304a\u308a\u3001\u524d\u306eRDD\u304b\u30c7\u30fc\u30bf\u30bd\u30fc\u30b9\u304b\u3089\u53d6\u5f97\u3057\u305f\u5165\u529b\u30ec\u30b3\u30fc\u30c9\u3092\u57fa\u306btransformation()\u3092\u5b9f\u884c\u3057\u3066\u65b0\u305f\u306a\u30ec\u30b3\u30fc\u30c9\u3092\u51fa\u529b\u3059\u308b\u3053\u3068\u304c\u51fa\u6765\u308b\u305f\u3081\u3067\u3042\u308b\u3002\n\u3069\u306e\u3088\u3046\u306aRDD\u304ctransformation()\u306e\u5b9f\u884c\u306b\u3088\u3063\u3066\u751f\u6210\u3055\u308c\u308b\u304b\u3092\u77e5\u308b\u305f\u3081\u306b\u3001\u57fa\u672c\u7684\u306atransformation()\u306b\u5bfe\u3057\u3066\u3069\u306e\u3088\u3046\u306aRDD\u304c\u751f\u6210\u3055\u308c\u308b\u304b\u3092\u8a18\u8ff0\u3059\u308b\u3002\ntransformation()\u304cSpark\u30b5\u30a4\u30c9\u3067\u6301\u3064\u610f\u5473\u306b\u3064\u3044\u3066\u5b66\u3076\u305f\u3081\u306b\u3001\u307e\u305a\u306f\u5404transformation()\u306e\u8a73\u7d30\u306b\u3064\u3044\u3066\u4e0b\u8a18\u306e\u8868\u306b\u8a18\u8ff0\u3057\u305f\u3002iterator(split)\u306e\u30ab\u30e9\u30e0\u306fPartition\u4e2d\u306e\u5404\u30ec\u30b3\u30fc\u30c9\u306b\u5bfe\u3057\u3066\u3069\u306e\u3088\u3046\u306b\u51e6\u7406\u304c\u884c\u308f\u308c\u308b\u304b\u3092\u8a18\u8ff0\u3057\u3066\u3044\u308b\u3002\n\u4e0b\u8a18\u306e\u8868\u306e\u4e2d\u306b\u306f\u3044\u304f\u3064\u304b\u30d6\u30e9\u30f3\u30af\u306b\u306a\u3063\u3066\u3044\u308b\u500b\u6240\u304c\u3042\u308b\u304c\u3001\u305d\u308c\u306f\u8907\u96d1\u306atransformation()\u3068\u306a\u3063\u3066\u304a\u308a\u3001\u8907\u6570\u306eRDD\u3092\u751f\u6210\u3059\u308b\u305f\u3081\u3067\u3042\u308b\u3002\n\u8a73\u7d30\u306f\u3053\u306e\u5f8c\u8a18\u8ff0\u3059\u308b\u3002\n\n\n\nTransformation\nGenerated RDDs\nCompute()\n\n\n\n\nmap(func)\nMappedRDD\niterator(split).map(f)\n\n\nfilter(func)\nFilteredRDD\niterator(split).filter(f)\n\n\nflatMap(func)\nFlatMappedRDD\niterator(split).flatMap(f)\n\n\nmapPartitions(func)\nMapPartitionsRDD\nf(iterator(split))\n\n\nmapPartitionsWithIndex(func)\nMapPartitionsRDD\nf(split.index, iterator(split))\n\n\nsample(withReplacement, fraction, seed)\nPartitionwiseSampledRDD\nPoissonSampler.sample(iterator(split))\u3000BernoulliSampler.sample(iterator(split))\n\n\npipe(command, [envVars])\nPipedRDD\n\n\n\nunion(otherDataset)\n\n\n\n\nintersection(otherDataset)\n\n\n\n\ndistinct([numTasks]))\n\n\n\n\ngroupByKey([numTasks])\n\n\n\n\nreduceByKey(func, [numTasks])\n\n\n\n\nsortByKey([ascending], [numTasks])\n\n\n\n\njoin(otherDataset, [numTasks])\n\n\n\n\ncogroup(otherDataset, [numTasks])\n\n\n\n\ncartesian(otherDataset)\n\n\n\n\ncoalesce(numPartitions)\n\n\n\n\nrepartition(numPartitions)\n\n\n\n\n\n\n2. \u3069\u306e\u3088\u3046\u306b\u8907\u6570RDD\u9593\u306e\u30c7\u30fc\u30bf\u4f9d\u5b58\u304c\u751f\u6210\u3055\u308c\u308b\u306e\u304b\uff1f\n\u3053\u306e\u8cea\u554f\u306f3\u500b\u306e\u5c0f\u3055\u306a\u8cea\u554f\u306b\u5206\u5272\u3055\u308c\u308b\u3002\n\n\u5bfe\u8c61\u306eRDD\u306f1\u500b\u306e\u89aaRDD\u306b\u4f9d\u5b58\u3059\u308b\u306e\u304b\uff1f\u305d\u308c\u3068\u3082\u8907\u6570\u306e\u89aaRDD\u306b\u4f9d\u5b58\u3059\u308b\u306e\u304b\uff1f\nRDD\u306b\u306f\u3044\u304f\u3064\u306ePartition\u304c\u5b58\u5728\u3059\u308b\u306e\u304b\uff1f\n\u5bfe\u8c61\u306eRDD\u3068\u89aaRDD\u306e\u95a2\u4fc2\u306f\u3069\u3046\u306a\u3063\u3066\u3044\u308b\u306e\u304b\uff1f\u5bfe\u8c61RDD\u306e1\u500b\u306ePartition\u306f\u89aaRDD\u306e1\u500b\u306ePartition\u306b\u4f9d\u5b58\u3059\u308b\u306e\u304b\uff1f\u305d\u308c\u3068\u3082\u8907\u6570\u306ePartition\u306b\u4f9d\u5b58\u3059\u308b\u306e\u304b\uff1f\n\n2\u500b\u76ee\u306e\u8cea\u554f\u3078\u306e\u56de\u7b54\u3068\u3057\u3066\u306f\u3001Partition\u6570\u306f\u30e6\u30fc\u30b6\u306b\u3088\u3063\u3066\u6307\u5b9a\u3055\u308c\u308b\u304c\u3001\u6307\u5b9a\u304c\u306a\u3044\u5834\u5408\u3001\u5b50RDD\u306e\u4fdd\u6301\u3059\u308bPartition\u6570\u306f\u4f9d\u5b58\u3059\u308b\u89aaRDD\u306e\u4e2d\u3067\u6700\u3082\u591a\u3044Partition\u3092\u6301\u3064RDD\u306ePartition\u6570\u3068\u540c\u4e00\u306e\u5024\u3068\u306a\u308b\u3002\n3\u500b\u76ee\u306e\u8cea\u554f\u3078\u306e\u56de\u7b54\u306f\u8907\u96d1\u306b\u306a\u308b\u3002\u4f55\u6545\u306a\u3089\u3001transformation()\u306e\u30bb\u30de\u30f3\u30c6\u30a3\u30af\u30b9\u3092\u8003\u3048\u308b\u5fc5\u8981\u304c\u3042\u308b\u305f\u3081\u3002\u7570\u306a\u308btransformation()\u306f\u7570\u306a\u308b\u30c7\u30fc\u30bf\u4f9d\u5b58\u6027\u3092\u6301\u3064\u3002\u4f8b\u3048\u3070\u3001map()\u306f1:1\u306e\u5bfe\u5fdc\u3092\u6301\u3064transformation()\u3060\u304cgroupByKey()\u306fShuffledRDD\u3092\u751f\u6210\u3057\u3001ShuffledRDD\u306e\u5404Partition\u306f\u89aaRDD\u306e\u5168\u3066\u306ePartition\u306b\u4f9d\u5b58\u3057\u3066\u3044\u308b\u3002\u5225\u306etransformation()\u3067\u306f\u3001\u66f4\u306b\u8907\u96d1\u306b\u306a\u308b\u30d1\u30bf\u30fc\u30f3\u3082\u3042\u308b\u3002\nSpark\u306b\u304a\u3044\u3066\u306f\u4e0b\u8a18\u306e2\u7a2e\u985e\u306eRDD\u9593\u306ePartition\u4f9d\u5b58\u304c\u5b58\u5728\u3057\u3066\u3044\u308b\u3002\n\n1.NarrowDependency (e.g., OneToOneDependency and RangeDependency)\n\n\u5b50RDD\u306e\u5404Partition\u306f\u89aaRDD\u306e\u3044\u304f\u3064\u304b\u306ePartition\u306b\u4f9d\u5b58\u3059\u308b\u3002FullDependency\u3068\u66f8\u3044\u305f\u5834\u5408\u3001\u5b50Partition\u306f\u89aaPartition\u306e\u5168\u4f53\u306b\u4f9d\u5b58\u3059\u308b\u3002\n\n2.ShuffleDependency (or Wide dependency mentioned in Matei's paper)\n\n\u5b50RDD\u306e\u8907\u6570\u306ePartition\u304c\u89aaRDD\u306ePartition\u306b\u4f9d\u5b58\u3059\u308b\u3068\u3044\u3046\u30d1\u30bf\u30fc\u30f3\u3002PartialDependency\u3068\u66f8\u3044\u305f\u5834\u5408\u3001\u5404\u5b50Partition\u306f\u89aaPartition\u306e\u4e00\u90e8\u306e\u5024\u306b\u4f9d\u5b58\u3059\u308b\u3002\n\u4f8b\u3048\u3070\u3001map()\u306fNarrowDependency\u3092\u793a\u3057\u3001join()\u306f\u57fa\u672c\u306fWideDependency\u3092\u793a\u3059\u3002\n\u307e\u305f\u3001\u5b50Partition\u306f\u89aaRDD\u4e2d\u306e1Partition\u3068\u3001\u5225\u306e\u89aaRDD\u306e1Partition\u306b\u4f9d\u5b58\u3059\u308b\u30d1\u30bf\u30fc\u30f3\u3082\u3042\u308b\u3002\n\u53c2\u8003\u3068\u3057\u3066\u3001NarrowDependency\u306e\u5834\u5408\u3001\u5b50Partition\u304c\u305d\u306e\u89aaPartition\u306b\u4f9d\u5b58\u3059\u308b\u304b\u306f\u5b50RDD\u304c\u4fdd\u6301\u3059\u308bgetParents(partition i)\u3092\u7528\u3044\u3066\u53d6\u5f97\u3059\u308b\u3053\u3068\u304c\u51fa\u6765\u308b\u3002\nShuffleDependency\u306e\u5834\u5408\u3001MapReduce\u306eShuffleDependency\u3068\u540c\u3058\u69cb\u6210\u3068\u306a\u3063\u3066\u3044\u308b\u3002\uff08Mapper\u304c\u5404Partition\u306e\u5024\u3092\u51fa\u529b\u3057\u3001\u5404Reducer\u304c\u5168\u3066\u306e\u5fc5\u8981Partition\u306e\u5024\u3092http.fetch\u3067\u53d6\u5f97\uff09\n\u3053\u306e2\u7a2e\u985e\u306e\u4f9d\u5b58\u95a2\u4fc2\u306f\u4e0b\u56f3\u306e\u3088\u3046\u306b\u8868\u308f\u3055\u308c\u308b\u3002\n\n\u5b9a\u7fa9\u304b\u3089\u3059\u308b\u3068\u3001\u6700\u521d\u306e\u30b1\u30fc\u30b9\u304cNarrowDependency\u3067\u3001\u6700\u5f8c\u306e\u30b1\u30fc\u30b9\u304cShuffleDependency\u306b\u306a\u308b\u3002\n\u8ffd\u8a18\u3057\u3066\u304a\u304f\u3068\u3001\u5de6\u4e0b\u306e\u30b1\u30fc\u30b9\u306fN:N NarrowDependency\u3060\u304c\u3001\u30ec\u30a2\u30b1\u30fc\u30b9\u3068\u306a\u308b\u3002ShuffleDependency\u3068\u3082\u4f3c\u3066\u306f\u3044\u308b\u304c\u3001\u3053\u308c\u306fFullDependency\u3067\u3042\u308b\u3002\u3053\u308c\u306f\u3044\u304f\u3064\u304b\u306e\u7279\u6b8a\u306atransformation()\u7fa4\u3067\u306e\u307f\u751f\u6210\u3055\u308c\u308b\u3002NarrowDependency\u306fSpark\u306b\u304a\u3044\u3066\u672c\u8cea\u7684\u306b\u306f\u5404\u5b50Partition\u306f\u305f\u304b\u3060\u304b1\u500b\u306e\u89aaPartition\u306b\u4f9d\u5b58\u3059\u308b\u7269\u306e\u305f\u3081\u3001\u3053\u3053\u3067\u306f\u3053\u306e\u7279\u6b8a\u30b1\u30fc\u30b9\u306f\u6271\u308f\u306a\u3044\u3002\n\u307e\u3068\u3081\u308b\u3068\u3001Partition\u9593\u306e\u4f9d\u5b58\u6027\u306f\u4e0b\u8a18\u306e\u30d1\u30bf\u30fc\u30f3\u304c\u3042\u308b\u3002\n- NarrowDependency (black arrow)\n  - RangeDependency => only used for UnionRDD\n  - OneToOneDependency (1:1) => e.g., map(), filter()\n  - NarrowDependency (N:1) => e.g., co-partitioned join()\n  - NarrowDependency (N:N) => a rare case\n- ShuffleDependency (red arrow)\n\u3053\u306e\u7ae0\u3067\u306f\u3053\u308c\u4ee5\u964d\u3001NarrowDependency\u3092\u9ed2\u77e2\u5370\u3067\u3001ShuffleDependency\u3092\u8d64\u77e2\u5370\u3067\u8a18\u8ff0\u3059\u308b\u3002\nNarrowDependency\u3068ShuffleDependency\u306e\u7279\u5fb4\u306fPhysicalPlan\u3092\u4f5c\u6210\u3059\u308b\u306e\u306b\u5fc5\u8981\u306b\u306a\u308b\u304c\u3001\u8a73\u7d30\u306f\u6b21\u306e\u7ae0\u3067\u8ff0\u3079\u308b\u3002\n\n3. \u3069\u306e\u3088\u3046\u306bRDD\u4e2d\u306e\u30ec\u30b3\u30fc\u30c9\u306f\u8a08\u7b97\u3055\u308c\u308b\u306e\u304b\uff1f\nOneToOneDependency\u306e\u5834\u5408\u3001\u4e0b\u8a18\u306e\u56f3\u306e\u3088\u3046\u306b\u793a\u3055\u308c\u308b\u3002\n\u3060\u304c\u3001Partition\u9593\u306e\u95a2\u4fc2\u306f1:1\u3067\u3042\u3063\u3066\u3082\u3001\u305d\u308c\u306f\u5404Partition\u4e2d\u306eRecord\u30921\u30ec\u30b3\u30fc\u30c9\u305a\u3064\u51e6\u7406\u3059\u308b\u3053\u3068\u3068\u30a4\u30b3\u30fc\u30eb\u3067\u306f\u306a\u3044\u3002\n\n\u56f3\u306e\u53f3\u5074\u306b\u793a\u3057\u305f2\u30d1\u30bf\u30fc\u30f3\u306e\u9055\u3044\u306b\u3064\u3044\u3066\u306f\u4e0b\u8a18\u306e\u30bd\u30fc\u30b9\u30b3\u30fc\u30c9\u30b9\u30cb\u30da\u30c3\u30c8\u3068\u3057\u3066\u793a\u3059\u3053\u3068\u304c\u51fa\u6765\u308b\u3002\nCode of iter.f():\nint[] array = {1, 2, 3, 4, 5}\nfor(int i = 0; i < array.length; i++)\n    output f(array[i])\n\nCode of f(iter):\nint[] array = {1, 2, 3, 4, 5}\noutput f(array)\n\n\n4. \u57fa\u672c\u306ePartition\u9593\u306e\u4f9d\u5b58\u3092\u56f3\u793a\u3057\u3066\u307f\u308b\u3068\uff1f\n1) union(otherRDD)\n\nunion()\u306f\u5358\u7d14\u306b2\u500b\u304b\u305d\u308c\u4ee5\u4e0a\u306eRDD\u3092\u7d50\u5408\u3059\u308b\u306e\u307f\u3002union()\u3067\u306f\u5404Partition\u4e2d\u306e\u30c7\u30fc\u30bf\u306f\u5909\u66f4\u3055\u308c\u306a\u3044\u3002RangeDependency(1:1)\u306f\u5143\u306ePartition\u3092\u518d\u53d6\u5f97\u3059\u308b\u306e\u3092\u5bb9\u6613\u306b\u3059\u308b\u305f\u3081\u306b\u3001\u5143\u306eRDD\u306ePartition\u9593\u306e\u533a\u5207\u308a\u3092\u305d\u306e\u307e\u307e\u7dad\u6301\u3059\u308b\u3002\n2) groupByKey(numPartitions)\n\n\u65e2\u306b\u524dgroupByKey\u306e\u30c7\u30fc\u30bf\u4f9d\u5b58\u306b\u3064\u3044\u3066\u8ff0\u3079\u3066\u308b\u304c\u3001\u3053\u3053\u3067\u306f\u3088\u308a\u660e\u78ba\u306b\u8a18\u8ff0\u3059\u308b\u3002\ngroupByKey()\u306f\u540c\u3058\u30ad\u30fc\u5024\u3092\u6301\u3064\u30ec\u30b3\u30fc\u30c9\u3092Shuffle\u306b\u3088\u3063\u3066\u96c6\u7d04\u3059\u308b\u3002\n\u305d\u306e\u305f\u3081\u3001ShuffledRDD\u306b\u5bfe\u3059\u308bcompute()\u95a2\u6570\u306f\u5404Partition\u306b\u5fc5\u8981\u306a\u5fc5\u8981\u306a\u30c7\u30fc\u30bf\u3092\u53d6\u5f97\u3057\u3001\u5f8c\u6bb5\u306emapPartition()\u306b\u5bfe\u3057\u3066OneToOneDependency\u3068\u540c\u3058\u3088\u3046\u306b\u30c7\u30fc\u30bf\u3092\u6d41\u3059\u3002\u6700\u7d42\u7684\u306b\u3001ArrayBuffer\u304cIterable\u306b\u30ad\u30e3\u30b9\u30c8\u3055\u308c\u305f\u4e0a\u3067\u5f8c\u306eRDD\u304b\u3089\u30a2\u30af\u30bb\u30b9\u53ef\u80fd\u3068\u306a\u308b\u3002\ngroupByKey()\u306fMapSideCombine\u306f\u30c7\u30fc\u30bf\u91cf\u304c\u524a\u6e1b\u3055\u308c\u306a\u3044\u4e0a\u3001\u5168Mapper\u306e\u51fa\u529b\u30c7\u30fc\u30bf\u3092HashTable\u306b\u5165\u308c\u8fbc\u3080\u3053\u3068\u304c\u5fc5\u8981\u306b\u306a\u308a\u3001\u30c7\u30fc\u30bf\u91cf\u304c\u6ea2\u308c\u308b\u95a2\u4fc2\u4e0a\u5b9f\u65bd\u3057\u3066\u3044\u306a\u3044\u3002\nArrayBuffer\u306f\u57fa\u672c\u7684\u306b\u306fCompactBuffer\u304c\u4f7f\u308f\u308c\u308b\u3002CompactBuffer\u306fArrayBuffer\u306b\u4f3c\u305fappend-only\u306a\u30d0\u30c3\u30d5\u30a1\u3068\u306a\u3063\u3066\u304a\u308a\u3001\u5c0f\u898f\u6a21\u30d0\u30c3\u30d5\u30a1\u306b\u304a\u3044\u3066\u30e1\u30e2\u30ea\u3092\u6709\u52b9\u6d3b\u7528\u3059\u308b\u3053\u3068\u304c\u51fa\u6765\u308b\u3002\n3) reduceyByKey(func, numPartitions)\n\nreduceByKey()\u306fMapReduce\u3067\u306ereduce()\u3068\u306b\u3066\u304a\u308a\u3001\u30c7\u30fc\u30bf\u30d5\u30ed\u30fc\u3068\u3057\u3066\u306f\u540c\u7b49\u3068\u306a\u3063\u3066\u3044\u308b\u3002redcuceByKey()\u306f\u30c7\u30d5\u30a9\u30eb\u30c8\u3067\u306fshuffle\u524d\u306bMapSideCombine\u3092\u5b9f\u884c\u3057\u3066\u3044\u308b\u3002shuffle\u5f8c\u3001\u518d\u5ea6\u5404MapPartition\u306b\u5bfe\u3057\u3066aggregate\u3092\u5b9f\u884c\u3057\u3001\u7d50\u679c\u3068\u3057\u3066\u306fMapPartitionsRDD\u304c\u751f\u6210\u3055\u308c\u308b\u3002\n4) distinct(numPartitions)\n\ndistinct()\u306fRDD\u4e2d\u306e\u91cd\u8907\u3057\u305f\u30ec\u30b3\u30fc\u30c9\u3092\u9664\u53bb\u3059\u308b\u3053\u3068\u3092\u76ee\u7684\u3068\u3057\u3066\u3044\u308b\u3002\u7570\u306a\u308bPartition\u4e2d\u306b\u91cd\u8907\u3057\u305f\u30ec\u30b3\u30fc\u30c9\u304c\u5b58\u5728\u3059\u308b\u5834\u5408\u3001\u9664\u53bb\u3059\u308b\u305f\u3081\u306b\u306fshuffle + aggregation\u304c\u5fc5\u8981\u3068\u306a\u308b\u3002\u3060\u304c\u3001shuffle\u3092\u5b9f\u884c\u3059\u308b\u306b\u306fRDD\u306e\u578b\u304cRDD[(K,V)]\u3067\u3042\u308b\u5fc5\u8981\u304c\u3042\u308b\u305f\u3081\u3001\u5143\u306eRDD\u304c\u5358\u4e00\u306e\u5024\u3057\u304b\u3082\u305f\u306a\u3044\u30ec\u30b3\u30fc\u30c9\uff08\u4f8b\u3048\u3070\u3001RDD[Int]\uff09\u3060\u3063\u305f\u5834\u5408\u3001\u4e00\u5ea6map() transform\u3092\u9069\u7528\u3057\u3066\u306e\u5f62\u5f0f\u306b\u5909\u63db\u3057\u3066\u3044\u308b\u3002\u305d\u306e\u5f8c\u3001reduceByKey()\u306f\u3044\u304f\u3064\u304b\u306eshuffle\u51e6\u7406\uff08mapSideCombine => reduce => MapPartitionsRDD\uff09\u3092\u5b9f\u884c\u3059\u308b\u3002\u6700\u7d42\u7684\u306b\u5f62\u5f0f\u306e\u30ec\u30b3\u30fc\u30c9\u304b\u3089\u30ad\u30fc\u306e\u307f\u3092\u62bd\u51fa\u3057\u3001\u5143\u306eRDD\u306e\u578b\u306b\u5408\u308f\u305b\u3066\u3044\u308b\u3002\u4e0a\u8a18\u306e\u56f3\u306e\u4e2d\u3067\u306f\u7d14\u7c8b\u306breduceByKey()\u90e8\u3092\u793a\u3057\u3066\u3044\u308b\u306e\u306f\u9752\u306eRDD\u306e\u307f\u3068\u306a\u3063\u3066\u3044\u308b\u3002\n5) cogroup(otherRDD, numPartitions)\n\ngroupByKey()\u3068\u7570\u306a\u308a\u3001cogroup()\u306f2\u500b\u304b\u305d\u308c\u4ee5\u4e0a\u306eRDD\u3092\u7d71\u5408\u3057\u3066\u3044\u308b\u3002\n\u305d\u306e\u305f\u3081\u3001\u8cea\u554f\u304c\u751f\u3058\u308b\u3002\u89aaRDD\u3068CoGroupedRDD\u306ePartition\u9593\u306e\u4f9d\u5b58\u306fShuffleDependency\u306a\u306e\u304b\u3001OneToOneDependency\u306a\u306e\u304b\uff1f \u3053\u306e\u8cea\u554f\u306f\u4ee5\u4e0b\u306e2\u3064\u306e\u8981\u7d20\u306b\u4f9d\u5b58\u3059\u308b\u305f\u3081\u3001\u3044\u3055\u3055\u304b\u8907\u96d1\u306b\u306a\u308b\u3002\n\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u6570\nCoGroupedRDD\u306ePartition\u6570\u306f\u30e6\u30fc\u30b6\u306b\u3088\u3063\u3066\u6307\u5b9a\u3055\u308c\u3001\u89aa\u3068\u306a\u308bRDD a\u3068RDD b\u3068\u306f\u95a2\u4fc2\u304c\u306a\u3044\u3002\n\u3060\u304c\u3001CoGroupedRDD\u306ePartition\u6570\u304cRDD a\u3084RDD b\u3068\u7570\u306a\u308b\u5834\u5408\u3001Partition\u4f9d\u5b58\u306fOneToOneDependency\u3067\u306f\u89e3\u6c7a\u3067\u304d\u306a\u3044\u3002\nPartitioner\u306e\u578b\ncogroup\u3092\u884c\u3046\u969b\u306b\u30c7\u30fc\u30bf\u3092\u3069\u3046\u914d\u5206\u3059\u308b\u304b\u306ePartitioner\u3082\u30e6\u30fc\u30b6\u306b\u3088\u3063\u3066\u6307\u5b9a\u3055\u308c\u308b\uff08\u30c7\u30d5\u30a9\u30eb\u30c8\u306fHashPartitioner \uff09\u3002\u3082\u3057RDD a\u3001RDD b\u3001CoGroupedRDD\u306ePartition\u6570\u304c\u540c\u3058\u3067\u3042\u3063\u3066\u3082Partitioner\u304c\u9055\u3046\u5834\u5408\u3001Partition\u9593\u306e\u4f9d\u5b58\u306f OneToOneDependency\u306b\u51fa\u6765\u306a\u3044\u3002\n\u305d\u306e\u305f\u3081\u3001\u4e0a\u8a18\u306e\u56f3\u306e\u6700\u5f8c\u306e\u30d1\u30bf\u30fc\u30f3\uff08RDD a is RangePartitioner, RDD b is HashPartitioner, and CoGroupedRDD is RangePartitioner with the same # partition as RDD a\uff09\u306b\u3064\u3044\u3066\u8003\u3048\u3066\u307f\u308b\u3002RDD a\u5074\u306e\u5404Partition\u4e2d\u306e\u30ec\u30b3\u30fc\u30c9\u306f\u5bfe\u5fdc\u3059\u308bCoGroupedRDD\u306b\u5bfe\u3057\u3066\u9001\u3063\u3066\u3057\u307e\u3063\u3066\u554f\u984c\u306a\u3044\u3002\u3060\u304c\u3001RDD b\u306e\u5404Partition\u4e2d\u306e\u30ec\u30b3\u30fc\u30c9\u306fCoGroupedRDD\u306b\u4f75\u305b\u3066Shuffle\u3057\u3066\u5bfe\u5fdc\u305a\u3051\u308b\u5fc5\u8981\u304c\u3042\u308b\u3002\n\u7d50\u8ad6\u3068\u3057\u3066\u3001OneToOneDependency\u306f\u89aaRDD\u3068CoGroupedRDD\u306ePartitioner\u3068Partition\u6570\u304c\u540c\u4e00\u3067\u3042\u308b\u5834\u5408\u306e\u307f\u9069\u7528\u3055\u308c\u308b\u3002\u305d\u3046\u3067\u306a\u3044\u5834\u5408\u3001ShuffleDependency\u3068\u306a\u308b\u3002\u3053\u308c\u4ee5\u4e0a\u306e\u8a73\u7d30\u306fCoGroupedRDD.getDependencies()\u306e\u30b3\u30fc\u30c9\u3092\u8aad\u3093\u3067\u307b\u3057\u3044\u3002\nSpark\u306f\u3069\u306e\u3088\u3046\u306b\u3057\u3066CoGroupedRDD\u306e\u5404Partition\u306e\u8907\u6570\u306e\u4f9d\u5b58Partition\u3092\u7dad\u6301\u3057\u3066\u3044\u308b\u306e\u304b\uff1f\n\u307e\u305a\u306f\u3058\u3081\u306b\u3001CoGroupedRDD\u306f\u5168\u3066\u306e\u89aaRDD\u3092RDDs\u306b\u5165\u308c\u3001\u4e0b\u8a18\u306e\u51e6\u7406\u3092\u884c\u3046\u3002\nForeach rdd = rdds(i):\n    if the dependency between CoGroupedRDD and rdd is OneToOneDependency\n        Dependecy[i] = new OneToOneDependency(rdd)\n    else\n        Dependecy[i] = new ShuffleDependency(rdd)\n\n\u6700\u7d42\u7684\u306b\u4e0a\u8a18\u306e\u30b3\u30fc\u30c9\u306f\u5404\u89aaRDD\u306b\u5bfe\u3059\u308b\u4f9d\u5b58\u6027\u914d\u5217\u3067\u3042\u308bdeps\u3092\u8fd4\u3059\u3002\nDependency.getParents(partition id) \u306f Partitions: List[Int] \u306f\u4e0e\u3048\u3089\u308c\u305f\u4f9d\u5b58\u6027\u306b\u5bfe\u5fdc\u3059\u308bPartition\u3092\u8fd4\u3059\u3002\ngetPartitions()\u30e1\u30bd\u30c3\u30c9\u306fRDD\u306b\u3044\u304f\u3064\u306ePartition\u304c\u5b58\u5728\u3057\u3066\u304a\u308a\u3001\u3069\u306e\u3088\u3046\u306b\u30b7\u30ea\u30a2\u30e9\u30a4\u30ba\u5316\u3055\u308c\u308b\u304b\u3082\u8fd4\u3059\u3002\n6) intersection(otherRDD)\n\nintersection()\u306fRDD a\u3068RDD b\u306e\u9593\u306b\u5b58\u5728\u3059\u308b\u5171\u901a\u8981\u7d20\u3092\u62bd\u51fa\u3059\u308b\u3053\u3068\u3092\u76ee\u7684\u3068\u3057\u3066\u3044\u308b\u3002\u306f\u3058\u3081\u306bRDD[T]\u3092RDD[(T,null)]\u306b\u5909\u63db\u3059\u308b\u3002\uff08\u305d\u306e\u305f\u3081\u3001T\u306f\u30b3\u30ec\u30af\u30b7\u30e7\u30f3\u578b\u3067\u3042\u3063\u3066\u306f\u3044\u3051\u306a\u3044\uff09\u305d\u306e\u5f8c\u3001a.cogroup(b)\u3092\u5b9f\u884c\uff08\u9752\u3044\u90e8\u5206\uff09\u3059\u308b\u3002\u6b21\u306bFilter\u3092\u884c\u3044\u3001RDD a\u8d77\u6e90\u306e\u8981\u7d20\u3068RDD b\u8d77\u6e90\u306e\u8981\u7d20\u306e\u4e21\u65b9\u304c\u5b58\u5728\u3057\u3066\u3044\u306a\u3044\u8981\u7d20\u3092\u30d5\u30a3\u30eb\u30bf\u30ea\u30f3\u30b0\u3059\u308b\u3002\u6700\u7d42\u7684\u306b\u30ad\u30fc\u90e8\u5206\u306e\u307f\u3092\u62bd\u51fa\u3057\u305fMappedRDD\u306b\u5909\u63db\u3092\u884c\u3046\u3002\n7) join(otherRDD, numPartitions)\n\njoin()\u306fKey\u5024\u3068Value\u5024\u3092\u4fdd\u6301\u3059\u308bRDD\uff08RDD[(K,V)]\uff09\u30922\u500b\u3082\u3061\u3044\u3066SQL\u306ejoin\u306e\u3088\u3046\u306b\u7d50\u5408\u3092\u884c\u3046\u3002\u51e6\u7406\u3068\u3057\u3066\u306fintersection()\u3068\u540c\u3058\u3088\u3046\u306b\u306f\u3058\u3081\u306bcogroup()\u51e6\u7406\u3092\u547c\u3073\u51fa\u3057\u3001\u5404\u8981\u7d20\u3092Iterable\u306b\u3057\u305fRDD[(K, (Iterable[V1],Iterable[V2]))]\u3092\u751f\u6210\u3059\u308b\u3002\u305d\u306e\u5f8c\u3001\u5404\u30ec\u30b3\u30fc\u30c9\u304c\u4fdd\u6301\u3059\u308b\u8981\u7d20\u306e\u76f4\u7a4d\u96c6\u5408\u3092flatMap()\u3092\u7528\u3044\u3066\u751f\u6210\u3059\u308b\u3002\n\u56f3\u4e2d\u3067\u306f2\u30d1\u30bf\u30fc\u30f3\u306e\u4f8b\u3092\u793a\u3057\u3066\u3044\u308b\u3002\n1\u500b\u76ee\u306e\u4f8b\u306fRDD 1\u3068RDD 2\u304cRangePartitioner\u3001CoGroupedRDD\u304cHashPartitioner\u3092\u4f7f\u7528\u3057\u3066\u3044\u308b\u305f\u3081\u3001\u5404Partition\u9593\u306e\u4f9d\u5b58\u304cShuffleDependency\u306b\u306a\u3063\u305f\u30d1\u30bf\u30fc\u30f3\u30022\u500b\u76ee\u306e\u4f8b\u304cRDD 1\u304cCoGroupedRDD\u3068\u540c\u4e00\u306ePartition\u6570\u3001Partitioner\u3060\u3063\u305f\u305f\u3081\u4f9d\u5b58\u304cOneToOneDependency\u3068\u306a\u3063\u305f\u30d1\u30bf\u30fc\u30f3\u3002\u3082\u3057\u4eee\u306bRDD 2\u3082\u540c\u4e00\u306ePartition\u6570\u3001Partitioner\u3060\u3063\u305f\u5834\u5408\u3001\u5168\u4f9d\u5b58\u304cOneToOneDependency\u3068\u306a\u308b\u3002\u3053\u306e\u3088\u3046\u306a\u30b1\u30fc\u30b9\u306eJoin\u306fhashjoin\u3068\u547c\u3070\u308c\u308b\u3002\n8) sortByKey(ascending, numPartitions)\n\nsortByKey()\u306fRDD[(K,V)]\u5f62\u5f0f\u306eRDD\u3092Key\u5024\u3067\u30bd\u30fc\u30c8\u3059\u308b\u3002ascending\u306f\u5f53\u7136\u308f\u304b\u308b\u901a\u308aBoolean\u30d5\u30e9\u30b0\u3002sortByKey()\u306fRangePartitioner\u3067\u533a\u5207\u3063\u305fShuffledRDD\u3092\u751f\u6210\u3059\u308b\u3002RangePartitioner\u306fRDD\u4e2d\u306e\u5404Partition\u306e\u533a\u5207\u308a\u3092\u8a2d\u5b9a\u3059\u308b\u3002\u4f8b\u3048\u3070\u30011Partition\u76ee\u304cA-B\u30012Partition\u76ee\u304cC-D\u306e\u3088\u3046\u306b\u3002\u5404Partition\u5185\u3067\u306f\u30ec\u30b3\u30fc\u30c9\u306fKey\u5024\u306b\u3088\u3063\u3066\u30bd\u30fc\u30c8\u3055\u308c\u3066\u3044\u308b\u3002\u6700\u7d42\u7684\u306b\u3001\u30bd\u30fc\u30c8\u3055\u308c\u305f\u30ec\u30b3\u30fc\u30c9\u3092\u4fdd\u6301\u3057\u3066\u3044\u308bMapPartitionsRDD\u3092\u51fa\u529b\u3057\u3066\u3044\u308b\u3002\nsortByKey()\u306f\u5404\u30ec\u30b3\u30fc\u30c9\u3092Array\u3092\u7528\u3044\u3066\u30bd\u30fc\u30c8\u3092\u884c\u3046\u3002\n9) cartesian(otherRDD)\n\nCartesian()\u306f2\u500b\u306eRDD\u306e\u8981\u7d20\u540c\u58eb\u306e\u76f4\u7a4d\u96c6\u5408\u3092\u4fdd\u6301\u3059\u308bRDD\u3092\u8fd4\u3059\u3002\u51fa\u529b\u3055\u308c\u308bRDD\u306ePartition\u6570\u306f(RDD a\u306ePartition\u6570\uff09* (RDD b\u306ePartition\u6570\uff09\u3068\u306a\u308b\u3002\n\u4f9d\u5b58\u95a2\u4fc2\u3067\u6ce8\u610f\u3059\u308b\u3079\u304d\u3053\u3068\u3068\u3057\u3066\u3001\u7d50\u679c\u306e\u5404Partition\u306f2\u3064\u306e\u89aaRDD\u306e\u5168\u8981\u7d20\u306b\u4f9d\u5b58\u3057\u3066\u3044\u308b\u3002\u305d\u306e\u305f\u3081\u3001\u5168\u3066NarrowDependency\u306e\u69cb\u6210\u3068\u306a\u3063\u3066\u3044\u308b\u3002\nCartesianRDD.getDependencies() \u306frdds\u3068\u3057\u3066 Array(RDD a, RDD b) \u3092\u8fd4\u3059\u3002\n\u5c1a\u3001CartesianRDD\u306ei\u756a\u76ee\u306e\u4f9d\u5b58Partition\u306f\u4e0b\u8a18\u306e\u3088\u3046\u306b\u306a\u308b\u3002\na.partitions(i / #partitionA)\nb.partitions(i % #partitionB)\n\n10) coalesce(numPartitions, shuffle = false)\n\ncoalesce()\u306fPartition\u306e\u518d\u69cb\u6210\u3092\u884c\u3046\u3002\u4f8b\u3048\u3070\u3001Partition\u6570\u30925>3\u306b\u6e1b\u3089\u3057\u305f\u308a\u30015>10\u306b\u5897\u3084\u3057\u305f\u308a\u3059\u308b\u3053\u3068\u304c\u53ef\u80fd\u3002\n\u305f\u3060\u3057\u3001\u6ce8\u610f\u3059\u3079\u304d\u70b9\u3068\u3057\u3066\u306fshuffle\u3092false\u306b\u3057\u3066\u3044\u305f\u5834\u5408\u3001Partition\u6570\u3092\u5897\u3084\u3059\u3053\u3068\u306f\u51fa\u6765\u306a\u3044\u3002\u5fc5\u305aPartition\u6570\u5897\u52a0\u306b\u306fshuffle\u304c\u5fc5\u8981\u306b\u306a\u308b\u305f\u3081\u3002\ncoalesce()\u3092\u7406\u89e3\u3059\u308b\u305f\u3081\u306bCoalescedRDD\u306ePartition\u3068\u89aaPartition\u306e\u95a2\u4fc2\u3092\u77e5\u308b\u5fc5\u8981\u304c\u3042\u308b\u3002\ncoalesce(shuffle = false)\u306e\u30b1\u30fc\u30b9\u306e\u5834\u5408shuffle\u304c\u51fa\u6765\u306a\u3044\u305f\u3081\u3001\u5358\u7d14\u306bRDD\u4e2d\u306ePartition\u3092\u30de\u30fc\u30b8\u3059\u308b\u306e\u307f\u3067\u3001\u5b50Partition\u306f\u89aaParition\u306e\u5168\u8981\u7d20\u306b\u5bfe\u3057\u3048\u4f9d\u5b58\u3059\u308b\u3002\u5b9f\u969b\u306e\u6240\u3001Partition\u306e\u6709\u52b9\u306a\u30b0\u30eb\u30fc\u30d7\u5316\u306b\u3064\u3044\u3066\u306f\u591a\u304f\u306e\u8981\u7d20\u3084\u8003\u3048\u308b\u3053\u3068\u304c\u3042\u308b\u3002\u4f8b\u3048\u3070\u3001Partition\u6570\u306e\u4fdd\u6301\u3059\u308b\u30ec\u30b3\u30fc\u30c9\u6570\u3001\u5c40\u6240\u6027\u3001Partition\u9593\u306e\u30d0\u30e9\u30f3\u30b9\u7b49\u3002\u3053\u308c\u3089\u3092\u9054\u6210\u3059\u308b\u305f\u3081\u306bSpark\u306f\u8907\u96d1\u306a\u30a2\u30eb\u30b4\u30ea\u30ba\u30e0\u3092\u4fdd\u6301\u3057\u3066\u3044\u308b\u3002\uff08\u3053\u3053\u3067\u306f\u8aac\u660e\u3057\u306a\u3044\u304c\uff09\ncoalesce(shuffle = true)\u3068\u3057\u3066shuffle\u304c\u6709\u52b9\u5316\u3055\u308c\u3066\u3044\u308b\u5834\u5408\u3001coalesce\u306f\u5358\u7d14\u306bRDD\u306e\u5168\u30ec\u30b3\u30fc\u30c9\u3092\u7d50\u679c\u3067\u3042\u308bN\u500b\u306ePartition\u306b\u4e0b\u8a18\u306e\u3088\u3046\u306b\u3057\u3066\u5206\u5272\u3059\u308b\uff08\u30e9\u30a6\u30f3\u30c9\u30ed\u30d3\u30f3\u306e\u3088\u3046\u306a\u30a2\u30eb\u30b4\u30ea\u30ba\u30e0\u3068\u306a\u3063\u3066\u3044\u308b\u3002\uff09\n\u5404Pertition\u4e2d\u306e\u5168\u30ec\u30b3\u30fc\u30c9\u306b\u5bfe\u3057\u3066\u5897\u52a0\u3059\u308b\u6570\u5024\u3092\u30ad\u30fc\u3068\u3057\u3066\u5272\u308a\u632f\u308b\u3002\n\u5272\u308a\u632f\u3063\u305f\u30ad\u30fc\u3092HashPartitioner\u3067\u5206\u5272\u3059\u308b\u3068\u5404\u30ec\u30b3\u30fc\u30c9\u304c\u7570\u306a\u308bPartition\u306b\u5747\u7b49\u306b\u5272\u308a\u632f\u3089\u308c\u308b\u3002\n\u56f3\u4e2d\u306e2\u756a\u76ee\u306e\u4f8b\u306b\u304a\u3044\u3066\u306fMapPartitionRDD\u306e\u5de6\u5074\u306e\u8981\u7d20\u304c\u5272\u308a\u632f\u3063\u305f\u30ad\u30fc\u3068\u306a\u3063\u3066\u3044\u308b\u3002\u5272\u308a\u632f\u3089\u308c\u308b\u30ad\u30fc\u306e\u521d\u671f\u5024\u306f (new Random(index)).nextInt(numPartitions) \u3067\u7b97\u51fa\u3055\u308c\u308b\u3002\u3053\u3053\u3067index\u306f\u5143\u306eRDD\u3067\u306ePartition\u306e\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u756a\u53f7\u3001numPartitions\u306fCoalescedRDD\u306ePartition\u6570\u3068\u306a\u3063\u3066\u3044\u308b\u3002\u30ad\u30fc\u306f1\u305a\u3064\u5897\u52a0\u3055\u305b\u3066\u5272\u308a\u632f\u308b\u3002Shuffle\u5f8c\u3001ShffledRDD\u306e\u5404\u30ec\u30b3\u30fc\u30c9\u306f\u5747\u7b49\u306b\u5206\u6563\u3055\u308c\u3066\u3044\u308b\u3002\u6700\u7d42\u7684\u306b\u30ad\u30fc\u306f\u9664\u53bb\u3055\u308c\u3066\u5143\u306e\u5024\u306b\u623b\u3055\u308c\u308b\u3002\n11) repartition(numPartitions)\n\u4e2d\u8eab\u306fcoalesce(numPartitions, shuffle = true)\u3068\u540c\u4e00\u3002\n\n\u5171\u901a\u7684\u306a\u57fa\u672c\u51e6\u7406\ncombineByKey()\n\u3053\u308c\u307e\u3067\u8907\u6570\u306eLogicalPlan\u306b\u3064\u3044\u3066\u307f\u3066\u304d\u305f\u304c\u3001\u3044\u304f\u3064\u304b\u306e\u3082\u306e\u306f\u975e\u5e38\u306b\u4f3c\u901a\u3063\u3066\u3044\u308b\u3002\u305d\u308c\u306f\u7686\u540c\u3058shuffle + aggregate\u306e\u3075\u308b\u307e\u3044\u3092\u6301\u3064\u305f\u3081\u3067\u3042\u308b\u3002\ntransform\u5b9f\u884c\u6642\u306bShuffleDependency\u306e\u57fa\u3068\u306a\u308bRDD\u306fRDD[(K,V)]\u3068\u306a\u308a\u3001\u5909\u63db\u5f8c\u306eRDD\u306b\u304a\u3044\u3066\u540c\u3058\u30ad\u30fc\u3092\u7528\u3044\u3066\u7d71\u5408\u3059\u308b\u969b\u306b\u7570\u306a\u308b\u30a2\u30eb\u30b4\u30ea\u30ba\u30e0\u3092\u7528\u3044\u3066\u884c\u3046\u3068\u3044\u3046\u5dee\u5206\u304c\u3042\u308b\u306e\u307f\u3068\u306a\u3063\u3066\u3044\u308b\u3002\n\u5b9f\u969b\u3001\u8907\u6570\u306etransformation()\uff08\u4f8b\u3048\u3070groupByKey()\u3001reduceBykey()\uff09\u3067\u306f\u8ad6\u7406\u7684\u306b\u540c\u3058\u30bf\u30a4\u30df\u30f3\u30b0\u3067aggregate\u3092\u5b9f\u884c\u3057\u3066\u3044\u308b\u3002\u305d\u306e\u305f\u3081\u3001\u5171\u901a\u70b9\u306faggregate()\u3068compute()\u3092\u540c\u6642\u306b\u5b9f\u884c\u3059\u308b\u3053\u3068\u304b\u3089\u304f\u308b\u3002Spark\u3067\u306fcombineByKey()\u3092 to aggregate() + compute()\u306e\u51e6\u7406\u306e\u5b9f\u88c5\u3068\u3057\u3066\u7528\u3044\u3066\u3044\u308b\u3002\ncombineByKey()\u306e\u5b9a\u7fa9\u306f\u4e0b\u8a18\u306e\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u308b\u3002\n def combineByKey[C](createCombiner: V => C,\n      mergeValue: (C, V) => C,\n      mergeCombiners: (C, C) => C,\n      partitioner: Partitioner,\n      mapSideCombine: Boolean = true,\n      serializer: Serializer = null): RDD[(K, C)]\n\n\u4e0a\u8a18\u306e\u30b3\u30fc\u30c9\u306e\u4e2d\u306b\u306f3\u500b\u306e\u91cd\u8981\u306a\u30d1\u30e9\u30e1\u30fc\u30bf\u304c\u3042\u308b\u3002\n\ncreateCombiner, \u5404Value\u3092\u7d50\u5408\uff08\u4f8b\u3048\u30701\u500b\u76ee\u306e\u8981\u7d20\u3092\u5358\u4e00\u8981\u7d20\u306e\u30ea\u30b9\u30c8\u3068\u3057\u3066\u7d50\u5408\u53ef\u80fd\u306a\u3082\u306e\u306b\u5909\u63db\uff09\nmergeValue, \u5404Value\u5024\u3068\u7d50\u5408\u6e08\u307f\u306e\u5024\u3092\u7d50\u5408\uff08\u4f8b\u3048\u3070\u30ea\u30b9\u30c8\u306b\u5bfe\u3057\u3066\u5024\u3092\u8ffd\u52a0\uff09\nmergeCombiners, \u7d50\u5408\u6e08\u307f\u306e\u5024\u3092\u7d50\u5408\uff08\u4f8b\u3048\u3070\u30ea\u30b9\u30c8\u540c\u58eb\u30921\u3064\u306e\u30ea\u30b9\u30c8\u306b\u7d50\u5408\uff09\n\n\u4e0a\u8a18\u306e\u30d1\u30e9\u30e1\u30fc\u30bf\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u7528\u3044\u3089\u308c\u308b\u3002\n(K, V)\u306e\u5024\u3092\u4fdd\u6301\u3059\u308b\u30ec\u30b3\u30fc\u30c9\u7fa4\u304ccombineByKey()\u306b\u6e21\u3055\u308c\u305f\u5834\u5408\u3001\u6700\u521d\u306e\u8981\u7d20\u3092createCombiner\u3092\u7528\u3044\u3066\u30ea\u30b9\u30c8\u5316\u3059\u308b\u3002\n2\u500b\u76ee\u4ee5\u964d\u306e\u5024\u306fmergeValue\u3092\u4f7f\u7528\u3057\u3066\u30ea\u30b9\u30c8\u5316\u3057\u305f\u8981\u7d20\u306b\u5bfe\u3057\u30661\u500b\u305a\u3064\u8ffd\u52a0\u3057\u3066\u3044\u304f\u3002\nsum\u3092\u4f8b\u3068\u3057\u3066\u8003\u3048\u3066\u307f\u308b\u3068\u3001mergeValue\u306f combiner = combiner + record \u3068\u3057\u3066\u793a\u305b\u308b\u3002\n\u3053\u306e\u3088\u3046\u306b\u3057\u3066\u3001\u5168\u3066\u306e\u30ec\u30b3\u30fc\u30c9\u30921\u500b\u306e\u5024\u306b\u30de\u30fc\u30b8\u3057\u3066\u3044\u304f\u3002\n\u3082\u3057\u7570\u306a\u308b\u30ad\u30fc\u3092\u6301\u3064\u30ec\u30b3\u30fc\u30c9\u304c\u6295\u5165\u3055\u308c\u305f\u5834\u5408\u3001combineByKey()\u306fcreateCombiner\u3092\u7528\u3044\u3066\u518d\u5ea6\u7570\u306a\u308bcombiner\u3092\u751f\u6210\u3059\u308b\u3002\u6700\u7d42\u7684\u306a\u7d50\u679c\u306f\u30de\u30fc\u30b8\u3055\u308c\u305f\u5024\u540c\u58eb\u3092mergeCombiners\u3092\u7528\u3044\u3066\u30de\u30fc\u30b8\u3059\u308b\u3053\u3068\u3067\u751f\u6210\u3055\u308c\u308b\u3002\n\nConclusion\n\u3053\u3053\u307e\u3067\u3067\u3001\u30b8\u30e7\u30d6\u4e2d\u306eLogicalPlan\u304c\u3069\u306e\u3088\u3046\u306bSpark\u306b\u304a\u3044\u3066Partition\u306b\u5206\u5272\u3055\u308c\u3001\u4f9d\u5b58\u6027\u3092\u95a2\u9023\u4ed8\u3051\u3066\u51e6\u7406\u3055\u308c\u308b\u304b\u306b\u3064\u3044\u3066\u8ff0\u3079\u3066\u304d\u305f\u3002\ntranformation()\u306b\u3088\u3063\u3066\u3069\u306e\u3088\u3046\u306aRDD\u304c\u751f\u6210\u3055\u308c\u308b\u304b\u6c7a\u307e\u308a\u3001\u4e00\u90e8\u306etranformation()\u3067\u306f\u4ed6\u306etranformation()\u3092\u518d\u5ea6\u5229\u7528\u3057\u3066\u3044\u308b\u3082\u306e\u3082\u3042\u3063\u305f\u3002\uff08\u4f8b\u3048\u3070cogroup)\nRDD\u9593\u306e\u4f9d\u5b58\u306ftranformation()\u306e\u30bb\u30de\u30f3\u30c6\u30a3\u30af\u30b9\u306b\u4f9d\u5b58\u3057\u3066\u3044\u308b\u3002\u4f8b\u3048\u3070\u3001cogroup()\u3067\u751f\u6210\u3055\u308c\u308bCoGroupdRDD\u304c\u3069\u306e\u3088\u3046\u306a\u4f9d\u5b58\u69cb\u6210\u3092\u53d6\u308b\u304b\u3001\u7b49\u3002\nRDD\u4e2d\u306ePartition\u9593\u306e\u95a2\u9023\u306fNarrowDependency\u3068ShuffleDependency\u3067\u793a\u3055\u308c\u308b\u3002\n\u524d\u8005\u306fFullDependency\u3067\u5f8c\u8005\u306fPartialDependency\u3068\u306a\u308b\u3002\n\u4f9d\u5b58\u6027\u306ftransformation()\u4e2d\u306e\u30d1\u30e9\u30e1\u30fc\u30bf\u6b21\u7b2c\u3067\u5909\u5316\u3059\u308b\u30b1\u30fc\u30b9\u3082\u3042\u3063\u305f\u3002\u4f8b\u3048\u3070\u3001RDD\u306ePartition\u6570\u3068Partitioner\u304c\u7b49\u3057\u3044\u5834\u5408\u306e\u307fNarrowDependency\u306b\u306a\u308b\u7b49\n\u30c7\u30fc\u30bf\u30d5\u30ed\u30fc\u306e\u8996\u70b9\u3067\u8a00\u3048\u3070\u3001MapReduce\u306fmap() + reduceByKey()\u3068\u3044\u3046\u30e2\u30c7\u30eb\u3068\u306a\u308b\u3002\u53b3\u5bc6\u306b\u8a00\u3048\u3070MapReduce\u306ereduce()reduceByKey()\u3088\u308a\u9ad8\u6a5f\u80fd\u3067\u306f\u3042\u308b\u304c\u3002\nShuffle\u306e\u8a2d\u8a08\u5b9f\u88c5\u306e\u8a73\u7d30\u306b\u3064\u3044\u3066\u306f\u4eca\u5f8c\u306e\u7ae0\u3067\u8a18\u8ff0\u3059\u308b\u3002\n\n\u307e\u3068\u3081\nSparkInternals\u306e\u306f\u3058\u3081\u306e2\u7ae0\u3092\u8aad\u3093\u3067\u307f\u307e\u3057\u305f\u304c\u3001\u8aad\u3080\u3054\u3068\u306b\u3069\u306e\u3088\u3046\u306b\u52d5\u3044\u3066\u3044\u308b\u304b\u306e\u6982\u8981\u304c\u898b\u3048\u3066\u304d\u307e\u3059\u306d\u3002\n\u7279\u306b2\u7ae0\u306eRDD\u306b\u5bfe\u3059\u308bTransformation\u306b\u3064\u3044\u3066\u306f\u308f\u304b\u3063\u3066\u3044\u308b\u304b\u3044\u306a\u3044\u304b\u3067\u7406\u89e3\u306b\u5927\u304d\u306a\u9055\u3044\u304c\u51fa\u3066\u304f\u308b\u306e\u3067\u306f\u306a\u3044\u304b\u3068\u601d\u3044\u307e\u3059\u3002\n\u3055\u3059\u304c\u306b7\u7ae0\u5168\u3066\u30921\u6295\u7a3f\u306b\u307e\u3068\u3081\u308b\u306e\u306f\u7121\u7406\u3067\u3057\u305f\u304c\u3001\u3053\u3053\u307e\u3067\u3067\u3082\u30c7\u30fc\u30bf\u30d5\u30ed\u30fc\u306e\u30a4\u30e1\u30fc\u30b8\u306f1\u6bb5\u968e\u306f\u51fa\u6765\u308b\u3088\u3046\u306b\u306a\u308b\u304b\u3068\u3002\n\u3053\u308c\u304b\u3089\u5e74\u672b\u306b\u5165\u3063\u3066\u3044\u304f\u306e\u3067\u3001\u6298\u3092\u898b\u3066\u7d9a\u304d\u3082\u8a33\u3057\u3066\u307f\u3088\u3046\u3068\u601d\u3044\u307e\u3059\u304c\u3001\u3072\u3068\u307e\u305a\u4eca\u56de\u306f\u3053\u3053\u307e\u3067\u3067\u3059\u3002\n\u305d\u308c\u3067\u306f\u3001\u7686\u3055\u3093\u3001\u826f\u3044\u5e74\u672b\u3092\uff01\n# \u306f\u3058\u3081\u306b\n\u3053\u3093\u306b\u3061\u306f\u3002\n\u3053\u306e\u8a18\u4e8b\u306f[Apache Spark Advent Calendar 2015](http://qiita.com/advent-calendar/2015/apache-spark)\u306e19\u65e5\u76ee\u306e\u8a18\u4e8b\u3067\u3059\u3002\n\n# Spark\u3092\u4f7f\u3046\u306b\u3042\u305f\u3063\u3066\u56f0\u308b\u70b9\nSpark\u3092\u4f7f\u3063\u3066\u3044\u308b\u7686\u3055\u3093\u306a\u3089\u5b9f\u611f\u3057\u3064\u3064\u3042\u308b\u3068\u601d\u3044\u307e\u3059\u304c\u3001Spark\u306b\u306f\u56f0\u3063\u305f\u70b9\u3082\u3042\u308a\u307e\u3059\u3002\n\n\u3068\u308a\u3042\u3048\u305a\u30b5\u30f3\u30d7\u30eb\u3092\u52d5\u304b\u3059\u3060\u3051\u3001\u3067\u3042\u308c\u3070\u305d\u308c\u307b\u3069\u82e6\u52b4\u3059\u308b\u3053\u3068\u306f\u7121\u3044\u306e\u3067\u3059\u304c\u3001\u5b9f\u969b\u306b\u5927\u898f\u6a21\u30c7\u30fc\u30bf\u3092\u7528\u3044\u3066\u4f7f\u7528\u3057\u51fa\u3059\u3068\u3001\u4e0b\u8a18\u306e\u3088\u3046\u306a\u554f\u984c\u304c\u983b\u767a\u3057\u307e\u3059\u3002\n\n1. \u9069\u5207\u306a\u30c1\u30e5\u30fc\u30cb\u30f3\u30b0\u304c\u65bd\u3055\u308c\u3066\u3044\u306a\u3044\u3068\u30b9\u30d4\u30fc\u30c9\u304c\u51fa\u306a\u3044\n2. \u4e00\u90e8\u306e\u30b3\u30f3\u30dd\u30fc\u30cd\u30f3\u30c8\u306f\u305d\u3082\u305d\u3082\u52d5\u304b\u306a\u3044\uff08\u7279\u306bMLlib\uff09\n3. \u554f\u984c\u304c\u767a\u751f\u3057\u305f\u6642\u3001\u3069\u3053\u3067\u767a\u751f\u3057\u305f\u304b\u304c\u3071\u3063\u3068\u306f\u308f\u304b\u308a\u306b\u304f\u3044\n\n\u305d\u306e\u305f\u3081\u3001\u3042\u308b\u7a0b\u5ea6\u5185\u90e8\u69cb\u9020\u304b\u3001\u30c1\u30e5\u30fc\u30cb\u30f3\u30b0\u306e\u52d8\u6240\u3092\u304a\u3055\u3048\u3066\u304a\u304b\u306a\u3044\u3068\u82e6\u52b4\u3059\u308b\u3053\u3068\u306b\u306a\u308a\u307e\u3059\u3002\n\u512a\u308c\u3066\u306f\u3044\u308b\u3093\u3067\u3059\u304c\u3001\u305d\u306e\u5206\u30d4\u30fc\u30ad\u30fc\u306a\u30d5\u30ec\u30fc\u30e0\u30ef\u30fc\u30af\u3001\u3068\u3044\u3046\u306e\u304cMapReduce\u3068\u6bd4\u3079\u305f\u79c1\u306e\u5370\u8c61\u3067\u3059\u3002\n\n\u305d\u3093\u306a\u308f\u3051\u3067\u3001Spark\u306e\u5185\u90e8\u69cb\u9020\u3092\u8aac\u660e\u3057\u305f\u8cc7\u6599\u306f\u7121\u3044\u306e\u304b\u306a\u3001\u3068\u3044\u3046\u5f62\u3067\u624b\u9803\u306a\u8cc7\u6599\u304c\u306a\u3044\u304b\u3092\u78ba\u8a8d\u3057\u305f\u6240\u3001[SparkInternals](https://github.com/JerryLead/SparkInternals)\u3068\u3044\u3046\u8cc7\u6599\u304c\u898b\u3064\u304b\u3063\u305f\u305f\u3081\u3001\u305d\u308c\u3092\u8aad\u3093\u3060\u7d50\u679c\u3092\u307e\u3068\u3081\u3066\u307f\u307e\u3059\u3002\n\u82e5\u5e72\u53e4\u3044\u30d0\u30fc\u30b8\u30e7\u30f3\u306eSpark\u306e\u5185\u5bb9\u306b\u306a\u308a\u307e\u3059\u304c\u3001\u305d\u308c\u3067\u3082\u5927\u4f53\u306e\u6d41\u308c\u306f\u898b\u3048\u308b\u69cb\u6210\u3068\u306a\u3063\u3066\u3044\u307e\u3059\u3002\uff08\u672a\u5b8c\u7d50\u3001\u304b\u3064\u3053\u306e\u6295\u7a3f\u3067\u306f\u5168\u90e8\u306f\u8a33\u305b\u3066\u3044\u307e\u305b\u3093\u304c\uff09\n\u5c1a\u3001\u6587\u3092\u5168\u3066\u8a33\u3057\u3066\u3044\u308b\u308f\u3051\u3067\u306f\u306a\u304f\u3001\u5927\u4f53\u610f\u5473\u304c\u901a\u308a\u305d\u3046\u3001\u3068\u3044\u3046\u30ec\u30d9\u30eb\u306e\u8aad\u8fbc\u307f\u3067\u3059\u306e\u3067\u3001\u305d\u306e\u3042\u305f\u308a\u306f\u3054\u4e86\u627f\u304f\u3060\u3055\u3044\u3002\n\u30fb\u30fb\u3068\u3044\u3044\u3064\u3064\u3001\u5927\u90e8\u5206\u306f\u305d\u306e\u307e\u307e\u8a33\u3057\u3066\u3057\u307e\u3063\u3066\u3044\u307e\u3059\u304c\u3002\n\n\u4ee5\u5f8c\u3001\u4e0b\u8a18\u306e\u5224\u4f8b\u3068\u306a\u308a\u307e\u3059\u3002\n\nSparkInternals\u8a33\u6587\n*\u30b3\u30e1\u30f3\u30c8*\n\n# SparkInternals\n## Overview of Apache Spark\n\u3053\u306e\u7ae0\u3067\u306f\u4e0b\u8a18\u306e\u8cea\u554f\u306b\u5bfe\u3057\u3066\u7126\u70b9\u3092\u5f53\u3066\u3066\u8a18\u8ff0\u3059\u308b\u3002\n- \u30c7\u30d7\u30ed\u30a4\u6210\u529f\u5f8c\u3001\u5404\u30ce\u30fc\u30c9\u3067\u3069\u306e\u3088\u3046\u306b\u30b5\u30fc\u30d3\u30b9\u304c\u5b9f\u884c\u3055\u308c\u308b\u304b\uff1f\n- \u3069\u306e\u3088\u3046\u306bSpark\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u304c\u751f\u6210\u5b9f\u884c\u3055\u308c\u308b\u304b\uff1f\n\n### \u30c7\u30d7\u30ed\u30a4\u56f3\n![deploy.png](https://qiita-image-store.s3.amazonaws.com/0/9616/39463495-7e11-8f7b-0d95-3acbcb1e1b03.png)\n\nStandalone Cluster\u30e2\u30fc\u30c9\u306e\u5834\u5408\u3001\u30c7\u30d7\u30ed\u30a4\u306e\u6d41\u308c\u306f\u4e0a\u8a18\u306b\u793a\u3057\u305f\u56f3\u306e\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u308b\u3002\n- SparkCluster\u306fMasterNode\u3068\u8907\u6570\u306eWorkerNode\u304b\u3089\u306a\u308a\u3001Hadoop\u3068\u985e\u4f3c\u3057\u305f\u69cb\u6210\u306b\u306a\u3063\u3066\u3044\u308b\u3002\n- MasterNode\u306fMasterDaemonProcess\u3092\u4fdd\u6301\u3057\u3001WorkerNode\u306e\u7ba1\u7406\u3092\u884c\u3046\u3002\n- WorkerNode\u306fWorkerDaemonProcess\u3092\u4fdd\u6301\u3057\u3001MasterNode\u3068\u306e\u901a\u4fe1\u3068\u3001LocalExecutor\u306e\u7ba1\u7406\u3092\u884c\u3046\u3002\n\n\u516c\u5f0f\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u4e2d\u3067\u306fDriver\u306fmain\u95a2\u6570\u306e\u5b9f\u884c\u3068SparkContext\u306e\u4f5c\u6210\u3092\u884c\u3046\u3068\u3044\u3046\u8a18\u8ff0\u304c\u3042\u308b\u3002\nDriver\u30d7\u30ed\u30b0\u30e9\u30e0\u3001\u4f8b\u3048\u3070WordCount.scala\u306fSpark\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3068\u307f\u306a\u3055\u308c\u3066\u3044\u308b\u3002Driver\u30d7\u30ed\u30b0\u30e9\u30e0\u306f\u4e0b\u8a18\u306e\u3088\u3046\u306a\u30b3\u30de\u30f3\u30c9\u3067MasterNode\u3067\u8d77\u52d5\u3055\u308c\u308b\u3002\n\n```shell-session\n./bin/run-example SparkPi 10\n```\n\nSparkPi\u30d7\u30ed\u30b0\u30e9\u30e0\u306fMasterNode\u4e0a\u3067Driver\u30d7\u30ed\u30b0\u30e9\u30e0\u3068\u3057\u3066\u52d5\u4f5c\u3059\u308b\u3002\u3057\u304b\u3057\u306a\u304c\u3089\u3001Driver\u30d7\u30ed\u30b0\u30e9\u30e0\u304cYARN\u30af\u30e9\u30b9\u30bf\u306bsubmit\u3055\u308c\u305f\u5834\u5408\u3001Driver\u30d7\u30ed\u30b0\u30e9\u30e0\u306fWorkerNode\u4e0a\u306b\u30b9\u30b1\u30b8\u30e5\u30fc\u30ea\u30f3\u30b0\u3055\u308c\u308b\u3053\u3068\u3082\u3042\u308b\u3002\uff08\u4f8b\u3048\u3070WorkerNode 2\u306e\u3088\u3046\u306a\uff09\nDriver\u30d7\u30ed\u30b0\u30e9\u30e0\u304c\u30ed\u30fc\u30ab\u30eb\u30de\u30b7\u30f3\u3067\u4e0b\u8a18\u306e\u3088\u3046\u306a\u30b3\u30fc\u30c9\u3092\u5b9f\u884c\u3057\u3066\u8d77\u52d5\u3057\u305f\u5834\u5408\u306f\u307e\u305f\u72b6\u6cc1\u304c\u5909\u308f\u308b\u3002\n\n```scala\nval sc = new SparkContext(\"spark://master:7077\", \"AppName\")\n...\n```\n\nDriver\u30d7\u30ed\u30b0\u30e9\u30e0\u306f\u30ed\u30fc\u30ab\u30eb\u30de\u30b7\u30f3\u4e0a\u3067\u52d5\u304f\u304c\u3001\u3053\u306e\u65b9\u6cd5\u306f\u30ed\u30fc\u30ab\u30eb\u30de\u30b7\u30f3\u304cWorkerNode\u3068\u540c\u4e00\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u306b\u6240\u5c5e\u3057\u3066\u3044\u306a\u3044\u3053\u3068\u3082\u591a\u304f\u3001Driver\u3068Executor\u9593\u3067\u306e\u901a\u4fe1\u901f\u5ea6\u306e\u554f\u984c\u306b\u3088\u3063\u3066\u5b9f\u884c\u304c\u9045\u304f\u306a\u308b\u30b1\u30fc\u30b9\u304c\u591a\u3044\u305f\u3081\u3001\u304a\u52e7\u3081\u3057\u306a\u3044\u3002\n\n\u5404WorkerNode\u306f\u8907\u6570\u306eExecutorBackend\u30d7\u30ed\u30bb\u30b9\u3092\u7ba1\u7406\u3057\u3066\u3044\u308b\u3002\u5404ExecutorBackend\u30d7\u30ed\u30bb\u30b9\u306f\u8d77\u52d5\u5f8cExecutor\u3092\u7ba1\u7406\u3059\u308b\u3002\u5404Executor\u306f\u30b9\u30ec\u30c3\u30c9\u30d7\u30fc\u30eb\u3092\u4fdd\u6301\u3057\u3001\u5404Task\u304c\u30b9\u30ec\u30c3\u30c9\u4e0a\u3067\u5b9f\u884c\u3055\u308c\u308b\u3002\n\nSpark\u306b\u304a\u3044\u3066\u5404\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306fDriver\u3068\u8907\u6570\u306eExecutor\u3092\u4fdd\u6301\u3059\u308b\u3002\u540c\u4e00Executor\u4e0a\u3067\u5b9f\u884c\u3055\u308c\u308bTask\u306f\u5168\u3066\u540c\u4e00\u30d7\u30ed\u30bb\u30b9\u306b\u6240\u5c5e\u3059\u308b\u5f62\u306b\u306a\u308b\u3002\nStandalone Cluster\u30e2\u30fc\u30c9\u306e\u5834\u5408\u3001ExecutorBackend\u306fCoarseGrainedExecutorBackend\u3068\u3057\u3066\u521d\u671f\u5316\u3055\u308c\u308b\u3002\nWorkerNode\u306f\u5404CoarseGrainedExecutorBackend\u30d7\u30ed\u30bb\u30b9\u3092ExecutorRunner\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3068\u3057\u3066\u7ba1\u7406\u3059\u308b\u3002\n\n### A simple Spark application\n\n\u4ee5\u4e0b\u306e\u30b5\u30f3\u30d7\u30eb\u306fspark-example\u30d1\u30c3\u30b1\u30fc\u30b8\u306b\u542b\u307e\u308c\u308bGroupByTest\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3067\u3042\u308b\u3002\nMasterNode\u3067\u4e0b\u8a18\u306e\u3088\u3046\u306a\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3059\u308b\u3053\u3068\u3067\u8d77\u52d5\u3055\u308c\u308b\u3002\n\n```shell-session\n/* Usage: GroupByTest [numMappers] [numKVPairs] [valSize] [numReducers] */\n\nbin/run-example GroupByTest 100 10000 1000 36\n```\n\n\u4e0a\u8a18\u306e\u30b3\u30de\u30f3\u30c9\u3067\u5b9f\u884c\u3055\u308c\u308b\u30d7\u30ed\u30b0\u30e9\u30e0\u306f\u4e0b\u8a18\u3002\n\n```scala:GroupByTest.scala\npackage org.apache.spark.examples\n\nimport java.util.Random\n\nimport org.apache.spark.{SparkConf, SparkContext}\nimport org.apache.spark.SparkContext._\n\n/**\n  * Usage: GroupByTest [numMappers] [numKVPairs] [valSize] [numReducers]\n  */\nobject GroupByTest {\n  def main(args: Array[String]) {\n    val sparkConf = new SparkConf().setAppName(\"GroupBy Test\")\n    var numMappers = 100\n    var numKVPairs = 10000\n    var valSize = 1000\n    var numReducers = 36\n\n    val sc = new SparkContext(sparkConf)\n\n    val pairs1 = sc.parallelize(0 until numMappers, numMappers).flatMap { p =>\n      val ranGen = new Random\n      var arr1 = new Array[(Int, Array[Byte])](numKVPairs)\n      for (i <- 0 until numKVPairs) {\n        val byteArr = new Array[Byte](valSize)\n        ranGen.nextBytes(byteArr)\n        arr1(i) = (ranGen.nextInt(Int.MaxValue), byteArr)\n      }\n      arr1\n    }.cache\n    // Enforce that everything has been calculated and in cache\n    pairs1.count\n\n    println(pairs1.groupByKey(numReducers).count)\n\n    sc.stop()\n  }\n}\n```\n\n\u4e0a\u8a18\u306e\u3088\u3046\u306a\u30b3\u30fc\u30c9\u304c\u982d\u306e\u4e2d\u3067\u306f\u4e0b\u8a18\u306e\u3088\u3046\u306b\u5b9f\u884c\u3055\u308c\u308b\u3068\u601d\u308f\u308c\u308b\u3002\n\n![UserView.png](https://qiita-image-store.s3.amazonaws.com/0/9616/9ca39396-e8cd-e4ee-def1-6c6b155adc20.png)\n\n\u3053\u308c\u306f\u5358\u7d14\u306a\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306a\u306e\u3067\u3001\u5404\u30b9\u30c6\u30c3\u30d7\u3067\u30c7\u30fc\u30bf\u304c\u3069\u306e\u3088\u3046\u306b\u5909\u52d5\u3059\u308b\u304b\u3092\u8ffd\u3063\u3066\u307f\u308b\u3002\n\n1. SparkConf\u304c\u521d\u671f\u5316\u3055\u308c\u308b\u3002\n2. `numMappers=100, numKVPairs=10,000, valSize=1000, numReducers=36`\u3068\u3057\u3066\u521d\u671f\u5316\u3055\u308c\u308b\u3002\n3. SparkContext\u304c\u521d\u671f\u5316\u3055\u308c\u3001Driver\u306b\u5fc5\u8981\u306a\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3068\u30a2\u30af\u30bf\u30fc\u985e\u304c\u751f\u6210\u3055\u308c\u308b\u3002\n4. \u5404Mapper\u3067\u306f`arr1: Array[(Int, Byte[])]`\u3092\u751f\u6210\u3057\u3001numKVPairs\u500b\u306e\u8981\u7d20\u3092\u4fdd\u6301\u3059\u308b\u3002\u5404Int\u5024\u306f\u30e9\u30f3\u30c0\u30e0\u306e\u6574\u6570\u5024\u3068\u306a\u3063\u3066\u304a\u308a\u3001\u5404Byte\u914d\u5217\u306e\u30b5\u30a4\u30ba\u306fvalSize\u3068\u306a\u3063\u3066\u3044\u308b\u3002 arr1\u306e\u30b5\u30a4\u30ba\u306f`numKVPairs * (4 + valSize)` \u3088\u308a10MB\u3068\u8a08\u7b97\u3055\u308c\u308b\u305f\u3081\u3001pairs1\u306e\u30b5\u30a4\u30ba\u306f`numMappers * Size(arr1)`\u3088\u308a1000MB\u3068\u306a\u308b\u3002\n5. \u5404Mapper\u306farr1\u3092\u30e1\u30e2\u30ea\u4e0a\u306b\u30ad\u30e3\u30c3\u30b7\u30e5\u3059\u308b\u3088\u3046\u6307\u5b9a\u3055\u308c\u3066\u3044\u308b\u3002\n6. count()\u30a2\u30af\u30b7\u30e7\u30f3\u304c\u5168Mapper\u4e0a\u306earr1\u306e\u8981\u7d20\u6570\u306e\u5408\u8a08\u3092\u53d6\u5f97\u3059\u308b\u3088\u3046\u52d5\u4f5c\u3057\u3001\u7d50\u679c\u306f`numMappers * numKVPairs`\u304b\u30891,000,000\u3068\u306a\u308b\u3002\u3053\u306e\u30a2\u30af\u30b7\u30e7\u30f3\u306b\u3088\u3063\u3066\u5b9f\u969b\u306barr1\u306e\u8a08\u7b97\u304c\u304a\u3053\u306a\u308f\u308c\u3001\u30ad\u30e3\u30c3\u30b7\u30e5\u3055\u308c\u308b\u3002\n7. groupByKey\u30aa\u30da\u30ec\u30fc\u30b7\u30e7\u30f3\u306f\u30ad\u30e3\u30c3\u30b7\u30e5\u3055\u308c\u305fpairs1\u306b\u5bfe\u3057\u3066\u5b9f\u884c\u3055\u308c\u308b\u3002Reducer\u6570\uff08\uff1d\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u6570\uff09\u306fnumReducers\u3067\u793a\u3055\u308c\u308b\u3002 \u7406\u8ad6\u4e0a\u3001\u3082\u3057hash(key)\u304c\u4e0a\u624b\u304f\u5206\u6563\u3055\u308c\u305f\u5834\u5408\u3001\u5404Reducer\u306f`numMappers * numKVPairs / numReducer`\u3088\u308a27,777\u500b\u306e(Int, Array[Byte])\u30da\u30a2\u3092\u53d7\u4fe1\u3059\u308b\u3002\u305d\u306e\u305f\u3081\u3001\u5404Reducer\u4e0a\u306b\u304a\u3051\u308b\u30c7\u30fc\u30bf\u30b5\u30a4\u30ba\u306f`Size(pairs1) / numReducer`\u3088\u308a27MB\u3068\u306a\u308b\u3002\n8. Reducer\u306f\u540c\u4e00\u306eInt\u30ad\u30fc\u5024\u3092\u4fdd\u6301\u3059\u308b\u30ec\u30b3\u30fc\u30c9\u3092\u30de\u30fc\u30b8\u3057\u3001`(Int, List(Byte[], Byte[], ..., Byte[]))`\u306e\u7d50\u679c\u3092\u751f\u6210\u3059\u308b\u3002\n9. \u6700\u5f8c\u306bcount()\u30a2\u30af\u30b7\u30e7\u30f3\u304c\u5404Reducer\u4e0a\u3067\u306e\u30ec\u30b3\u30fc\u30c9\u6570\u306e\u5408\u8a08\u5024\u3092\u53d6\u5f97\u3057\u3001\u6700\u7d42\u7684\u306a\u7d50\u679c\u306fparis1\u4e2d\u306e\u30ad\u30fc\u91cd\u8907\u3092\u6392\u9664\u3057\u305f\u500b\u6570\u3068\u306a\u308b\u3002\n\n### Logical Plan\n\u5b9f\u969b\u306e\u5b9f\u884c\u624b\u9806\u306f\u524d\u8ff0\u306e\u3082\u306e\u3088\u308a\u3082\u8907\u96d1\u306a\u3082\u306e\u3068\u306a\u3063\u3066\u3044\u308b\u3002\u5927\u307e\u304b\u306a\u6d41\u308c\u3068\u3057\u3066\u3001Spark\u306f\u307e\u305aLogicalPlan\uff08DataDependencyGraph\u3068\u547c\u3070\u308c\u308b\uff09\u3092\u5404\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306b\u5bfe\u3057\u3066\u4f5c\u6210\u3057\u3001LogicalPlan\u3092\u57fa\u306bPhysicalPlan\uff08Map/Reduce\u306eStage\u306eDAG\uff09\u3092\u4f5c\u6210\u3059\u308b\u3002\u305d\u306e\u5f8c\u3001Stage\u3092\u66f4\u306b\u5206\u5272\u3057\u305fTask\u3092Map/Reduce\u3068\u3057\u3066\u8d77\u52d5\u3057\u3001\u5165\u529b\u30c7\u30fc\u30bf\u3092\u51e6\u7406\u3059\u308b\u3002\u3042\u308b\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306eLogicalPlan\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u308b\u3002\n\nRDD.toDebugString\u95a2\u6570\u3092\u5b9f\u884c\u3059\u308b\u3068RDD\u306eLogicalPlan\u304c\u51fa\u529b\u3055\u308c\u308b\u304c\u3001\u968e\u5c64\u306b\u793a\u3059\u3068\u4e0b\u8a18\u306e\u3088\u3046\u306b\u306a\u308b\u3002\n\n```scala\n  MapPartitionsRDD[3] at groupByKey at GroupByTest.scala:51 (36 partitions)\n    ShuffledRDD[2] at groupByKey at GroupByTest.scala:51 (36 partitions)\n      FlatMappedRDD[1] at flatMap at GroupByTest.scala:38 (100 partitions)\n        ParallelCollectionRDD[0] at parallelize at GroupByTest.scala:38 (100 partitions)\n```\n\n![JobRDD.png](https://qiita-image-store.s3.amazonaws.com/0/9616/6b530c74-56eb-18bf-0650-11a1af92b27e.png)\n\n\u306a\u304a\u3001\u5404Partition\u306f\u72ec\u7acb\u3057\u3066\u51e6\u7406\u3055\u308c\u308b\u305f\u3081\u3001\u5168\u30c7\u30fc\u30bf\u304c\u540c\u4e00\u306e\u30bf\u30a4\u30df\u30f3\u30b0\u3067\u30e1\u30e2\u30ea\u4e0a\u306b\u5b58\u5728\u3059\u308b\u308f\u3051\u3067\u306f\u306a\u3044\u3002\n\u8a73\u7d30\u306f\u4ee5\u4e0b\u306e\u901a\u308a\u3002\n\n- \u30e6\u30fc\u30b6\u5074\u3067100\u306e\u6574\u6570\u5024\u3092\u4fdd\u6301\u3059\u308b\u914d\u5217(\u4eca\u56de\u306e\u5834\u54080\uff5e99)\u3092\u521d\u671f\u5316\u3059\u308b\u3002\n- parallelize()\u306f\u5404\u8981\u7d20\u304c\u6574\u6570\u5024i\u3092\u542b\u3080ParallelCollectionRDD\u3092\u751f\u6210\u3059\u308b\u3002\n- flatMap\u30e1\u30bd\u30c3\u30c9\u306b\u3088\u3063\u3066ParallelCollectionRDD\u304b\u3089FlatMappedRDD\u304c\u751f\u6210\u3055\u308c\u308b\u3002\n- FlatMappedRDD\u306e\u5404Partition\u306f[(Int, Array[Byte])]\u306e\u914d\u5217\u3092\u4fdd\u6301\u3059\u308b\u3002\n- count()\u304cFlatMappedRDD\u306b\u5bfe\u3057\u3066\u5b9f\u884c\u3055\u308c\u308b\u3002\n- FlatMappedRDD\u304c\u30e1\u30e2\u30ea\u306b\u30ad\u30e3\u30c3\u30b7\u30e5\u3055\u308c\u308b\u3002\uff08\u8272\u3092\u5909\u3048\u3066\u3042\u308b\uff09\n- groupByKey()\u304c\u7d9a\u304f2\u3064\u306eRDD(ShuffledRDD and MapPartitionsRDD)\u3092\u751f\u6210\u3059\u308b\u3002\uff08\u8a73\u7d30\u306b\u3064\u3044\u3066\u306f\u5f8c\u306e\u7ae0\u3067\u8aac\u660e\uff09\n- ShuffleRDD\u306fLogicalPlan\u4e2d\u3067\u306fShuffle\u304c\u5fc5\u8981\u306a\u30b8\u30e7\u30d6\u3068\u3057\u3066\u793a\u3055\u308c\u3066\u3044\u308b\u3002Shuffle\u306fHadoop MapReduce\u3067\u306eShuffle\u3068\u5171\u901a\u3002\n- MapPartitionRDD\u304cgroupByKey()\u306e\u7d50\u679c\u3092\u4fdd\u6301\u3059\u308b\u3002\n- MapPartitionRDD(Array[Byte])\u306e\u5404\u8981\u7d20\u304cIterable\u306b\u5909\u63db\u3055\u308c\u308b\u3002\n- \u6700\u7d42\u7684\u306acount()\u30a2\u30af\u30b7\u30e7\u30f3\u304cMapPartitionRDD\u306b\u5bfe\u3057\u3066\u5b9f\u884c\u3055\u308c\u308b\u3002\n- LogicalPlan\u306f\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u30c7\u30fc\u30bf\u30d5\u30ed\u30fc\uff08Transformation\u7fa4\u3001\u5185\u90e8RDD\u3001RDD\u9593\u306e\u4f9d\u5b58\u95a2\u4fc2 \uff09\u3092\u793a\u3057\u3066\u3044\u308b\u3002\n\n### Physical Plan\n\nLogicalPlan\u304c\u30c7\u30fc\u30bf\u30d5\u30ed\u30fc\u306e\u5b9a\u7fa9\u306b\u7126\u70b9\u3092\u5f53\u3066\u3066\u304a\u308a\u3001\u5b9f\u969b\u306e\u5b9f\u884c\u30d5\u30ed\u30fc\u306b\u3064\u3044\u3066\u306f\u89e6\u308c\u3066\u3044\u306a\u3044\u3002\u30c7\u30fc\u30bf\u30d5\u30ed\u30fc\u3068\u5b9f\u884c\u30d5\u30ed\u30fc\u306fHadoop\u3067\u306f\u540c\u4e00\u306e\u3082\u306e\u3068\u306a\u3063\u3066\u3044\u308b\u3002Hadoop\u306b\u304a\u3044\u3066\u306f\u30c7\u30fc\u30bf\u30d5\u30ed\u30fc\u306f\u4e8b\u524d\u5b9a\u7fa9\u3001\u304b\u3064\u56fa\u5b9a\u5316\u3055\u308c\u305f\u3082\u306e\u3068\u306a\u3063\u3066\u304a\u308a\u3001\u305d\u306e\u4e2d\u3067\u5b9f\u884c\u3055\u308c\u308bMap/Reduce\u3092\u30e6\u30fc\u30b6\u304c\u5b9a\u7fa9\u3057\u3066\u3044\u308b\u3002Map/Reduce\u30bf\u30b9\u30af\u306f\u56fa\u5b9a\u3055\u308c\u305f\u5b9f\u884c\u30b9\u30c6\u30c3\u30d7\u306b\u5f93\u3063\u3066\u5b9f\u884c\u3055\u308c\u308b\u3002\u3057\u304b\u3057\u3001Spark\u306b\u304a\u3044\u3066\u306f\u30c7\u30fc\u30bf\u30d5\u30ed\u30fc\u306f\u67d4\u8edf\u304b\u3064\u8907\u96d1\u306a\u3082\u306e\u3068\u306a\u3063\u3066\u3044\u308b\u305f\u3081\u3001\u5358\u7d14\u306b\u30c7\u30fc\u30bf\u30d5\u30ed\u30fc\u3068\u5b9f\u884c\u30d5\u30ed\u30fc\u3092\u540c\u4e00\u5316\u3059\u308b\u3053\u3068\u306f\u56f0\u96e3\u3067\u3042\u308b\u3002\u305d\u306e\u305f\u3081\u3001Spark\u306f\u30c7\u30fc\u30bf\u30d5\u30ed\u30fc\u3068\u5b9f\u969b\u306b\u30bf\u30b9\u30af\u3092\u5b9f\u884c\u3059\u308b\u5b9f\u884c\u30d5\u30ed\u30fc\u3092\u5207\u308a\u5206\u3051\u3001\u30c7\u30fc\u30bf\u30d5\u30ed\u30fc\u3092\u5b9f\u884c\u30d5\u30ed\u30fc\u306b\u5909\u63db\u3059\u308b\u4ed5\u7d44\u307f\u3092\u5c0e\u5165\u3057\u3066\u3044\u308b\u3002\u3053\u3053\u3067\u306f\u305d\u306e\u30c7\u30fc\u30bf\u30d5\u30ed\u30fc\u304b\u3089\u5b9f\u884c\u30d5\u30ed\u30fc\u3078\u306e\u5909\u63db\u306b\u3064\u3044\u3066\u793a\u3059\u3002\n\n\u3067\u306f\u3001\u524d\u8ff0\u306e\u30b5\u30f3\u30d7\u30eb\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3092\u57fa\u306bPhysicalDAGPlan\u306b\u3064\u3044\u3066\u898b\u3066\u3044\u304f\u3002\n\n![PhysicalView.png](https://qiita-image-store.s3.amazonaws.com/0/9616/1b7bda0d-f26b-2be1-c230-1d17b4304e82.png)\n\n\u4e0a\u8a18\u306e\u56f3\u304b\u3089\u3001GroupByTest\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306f2\u500b\u306eSpark\u30b8\u30e7\u30d6\u3092\u751f\u6210\u3059\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n\u306f\u3058\u3081\u306e\u30b8\u30e7\u30d6\u306f\u521d\u56de\u306b\u5b9f\u884c\u3055\u308c\u308bcount\u30a2\u30af\u30b7\u30e7\u30f3\u3067\u3042\u308a\u3001\u8a73\u7d30\u306f\u4ee5\u4e0b\u306e\u3068\u304a\u308a\u3068\u306a\u308b\u3002\n\n\u30b8\u30e7\u30d6\u306f1Stage(100\u306eResultTask\u3092\u4fdd\u6301)\u304b\u3089\u69cb\u6210\u3055\u308c\u308b\u3002\u3053\u3053\u3067\u306eStage\u306fHadoop\u306eMap Stage\u3068\u4f3c\u3066\u3044\u308b\u3002\uff08\u56f3\u4e2d\u3067\u306f\u793a\u3055\u308c\u306a\u3044\u304c\uff09\n*\u6700\u521d\u306e\u30b8\u30e7\u30d6\u306f\u3064\u307e\u308a\u306f\u4e0b\u306b\u3042\u308bfirst count()\u3067\u793a\u3055\u308c\u308bresut 1 \uff5e result 99\u304c\u8868\u793a\u3055\u308c\u3066\u3044\u308b\u90e8\u5206\u306e\u307f\u3092\u793a\u3059\u308f\u3051\u3067\u3059\u306d\u3002*\n\u5404Task\u306fflatMap\u95a2\u6570\u3092\u5b9f\u884c\u3057\u3001FlatMappedRDD\u3092\u751f\u6210\u3059\u308b\u3002\u305d\u306e\u5f8ccount\u30a2\u30af\u30b7\u30e7\u30f3\u3092\u5b9f\u884c\u3059\u308b\u3053\u3068\u3067\u5404Partition\u304c\u4fdd\u6301\u3059\u308b\u30ec\u30b3\u30fc\u30c9\u6570\u3092\u30ab\u30a6\u30f3\u30c8\u3059\u308b\u3002\u4f8b\u3048\u3070\u3001Partition99\u306f\u56f3\u4e2d\u3067\u306f9\u500b\u306e\u30ec\u30b3\u30fc\u30c9\u3092\u4fdd\u6301\u3059\u308b\u305f\u3081\u3001Partition99\u306ecount\u7d50\u679c\u306f9\u3068\u306a\u308b\u3002\npairs1\u306f\u30ad\u30e3\u30c3\u30b7\u30e5\u3055\u308c\u308b\u3053\u3068\u3092\u6307\u5b9a\u3055\u308c\u3066\u3044\u308b\u305f\u3081\u3001\u672cTask\u5b9f\u884c\u6642\u306bFlatMappedRDD\u306ePartition\u7fa4\u306fExecutor\u306e\u30e1\u30e2\u30ea\u4e0a\u306b\u4fdd\u5b58\u3055\u308c\u3001\u305d\u308c\u306f\u5b9f\u884c\u4e2d\u5e38\u6642\u4fdd\u6301\u3055\u308c\u308b\u3002\nResultTask\u7fa4\u7d42\u4e86\u5f8c\u3001Driver\u306f\u5404Task\u306e\u7d50\u679c\u304b\u3089\u7d50\u679c\u3092\u53ce\u96c6\u3057\u3001\u305d\u308c\u3092\u5408\u8a08\u3057\u3066\u7d50\u679c\u3092\u7b97\u51fa\u3059\u308b\u3002\n\u3053\u308c\u3067\u30b8\u30e7\u30d60\u304c\u7d42\u4e86\u3068\u306a\u308b\u3002\n\n\u6b21\u306e\u30b8\u30e7\u30d6\u306fpairs1.groupByKey(numReducers).count\u306e\u5b9f\u884c\u306b\u3088\u3063\u3066\u8d77\u52d5\u3055\u308c\u308b\u3002\n\u3053\u306e\u30b8\u30e7\u30d6\u306f2\u500b\u306eStage\u304b\u3089\u69cb\u6210\u3055\u308c\u308b\u3002\n*\u5de6\u4e0a\u306eShuffleTask\u3068\u3001\u53f3\u4e0a\u306eResultTask\u304c\u5bfe\u8c61\u3068\u306a\u308a\u307e\u3059\u3002*\nStage0\u306f100\u500b\u306eShuffleMapTask\u3092\u4fdd\u6301\u3057\u3001\u5404Task\u306fparis1\u306ePartition\u3092\u30ad\u30e3\u30c3\u30b7\u30e5\u304b\u3089\u8aad\u307f\u8fbc\u307f\u3001Repartition\u3092\u884c\u3044\u3001\u305d\u306eRepartition\u5b9f\u884c\u7d50\u679c\u3092\u30ed\u30fc\u30ab\u30eb\u30c7\u30a3\u30b9\u30af\u306b\u51fa\u529b\u3059\u308b\u3002\u3053\u306e\u904e\u7a0b\u306fHadoop MapReduce\u306b\u304a\u3044\u3066Map\u304c\u7d50\u679c\u306e\u5404Partition\u3092\u51fa\u529b\u3059\u308b\u51e6\u7406\u3068\u5171\u901a\u3002\n*\u5c1a\u3001\u3053\u306e\u5148\u3092\u8aad\u3093\u3060\u9650\u308a\u3067\u3082Repartition\u304c\u8d70\u308b\u51e6\u7406\u3092\u5b9f\u884c\u3057\u305f\u5834\u5408\u306b\u306f\u30c7\u30fc\u30bf\u3092\u5168\u3066\u30ed\u30fc\u30ab\u30eb\u30c7\u30a3\u30b9\u30af\u306b\u51fa\u529b\u3059\u308b\u51e6\u7406\u304c\u5e38\u6642\u8d70\u308a\u3001\u8a2d\u5b9a\u3067\u7121\u52b9\u5316\u3059\u308b\u3053\u3068\u3082\u51fa\u6765\u306a\u3044\u3088\u3046\u3067\u3059\u3002*\nStage1\u306f36\u500b\u306eResultTasks\u3092\u4fdd\u6301\u3059\u308b\u3002\u5404Task\u306f\u5404\u30d7\u30ed\u30bb\u30b9\u304c\u5fc5\u8981\u3068\u3059\u308b\u30c7\u30fc\u30bf\u3092\u53d6\u5f97\u3057\u3001Shuffle\u3059\u308b\u3002\u30c7\u30fc\u30bf\u53d6\u5f97\u5f8c\u30c7\u30fc\u30bf\u3092\u7d71\u5408\u3057\u3001mapPartitions\u51e6\u7406\u3092\u30d1\u30a4\u30d7\u30e9\u30a4\u30f3\u306e\u3088\u3046\u306b\u5b9f\u884c\u3059\u308b\u3002\u6700\u7d42\u7684\u306b\u3001count\u30a2\u30af\u30b7\u30e7\u30f3\u304c\u5b9f\u884c\u3055\u308c\u3001\u5404\u7d50\u679c\u306e\u53d6\u5f97\u304c\u884c\u308f\u308c\u308b\u3002\nResultTasks\u7d42\u4e86\u5f8c\u3001Driver\u306fTask\u306e\u5b9f\u884c\u7d50\u679c\u3092\u53d6\u5f97\u3057\u3001\u5408\u8a08\u3059\u308b\u3002\n\u3053\u308c\u3067\u30b8\u30e7\u30d61\u304c\u7d42\u4e86\u3068\u306a\u308b\u3002\n\n\u4ee5\u4e0a\u3067\u308f\u304b\u308b\u3088\u3046\u306b\u3001Spark\u306ePhysicalPlan\u306f\u5358\u7d14\u3067\u306f\u306a\u3044\u3002Spark\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306f\u8907\u6570\u306e\u30b8\u30e7\u30d6\u3092\u5185\u5305\u3057\u3001\u5404\u30b8\u30e7\u30d6\u306f\u8907\u6570\u306eStage\u3092\u5185\u5305\u3057\u3001\u5404Stage\u306f\u8907\u6570\u306eTask\u3092\u5185\u5305\u3057\u3066\u3044\u308b\u3002\n\u4ee5\u5f8c\u306e\u7ae0\u3067\u306f\u3053\u308c\u3089\u306e\u30b8\u30e7\u30d6\u3001Stage\u3001Task\u304c\u3069\u3046\u751f\u6210\u3055\u308c\u308b\u304b\u3001\u8a73\u7d30\u3092\u898b\u3066\u3044\u304f\u3002\n\n### Conclusion\n\n\u3053\u306e\u7ae0\u3067Spark\u30b8\u30e7\u30d6\u306e\u751f\u6210\u3001\u5b9f\u884c\u306e\u57fa\u790e\u306b\u3064\u3044\u3066\u793a\u3057\u305f\u3002\u4ee5\u5f8c\u306e\u7ae0\u3067\u30ad\u30e3\u30c3\u30b7\u30e5\u306e\u30e1\u30ab\u30cb\u30ba\u30e0\u3084\u30b8\u30e7\u30d6\u306e\u751f\u6210\u3001\u5b9f\u884c\u306e\u8a73\u7d30\u306b\u3064\u3044\u3066\u8aac\u660e\u3059\u308b\u3002\u7ae0\u69cb\u6210\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u308b\u3002\n\n- Logical plan generation\n- Physical plan generation\n- Job submission and scheduling\n- Task's creation, execution and result handling\n- How shuffle is done in Spark\n- Cache mechanism\n- Broadcast mechanism\n\n## Logical plan of a job (data dependency graph)\n\n### An example of general logical plan\n\n![GeneralLogicalPlan.png](https://qiita-image-store.s3.amazonaws.com/0/9616/cab9f03b-55c0-6709-48a9-1040cb4c66b8.png)\n\n\u4e0a\u8a18\u306e\u56f3\u306f\u4e00\u822c\u7684\u306a\u30b8\u30e7\u30d6\u306eLogicalPlan\u3092\u793a\u3057\u305f\u3082\u306e\u3067\u3001\u6700\u7d42\u7684\u306a\u7d50\u679c\u3092\u7b97\u51fa\u3059\u308b\u307e\u3067\u306b4\u3064\u306eStep\u304b\u3089\u306a\u308b\u3002\n\n\u6700\u521d\u306eRDD\u3092\u4f55\u304b\u3057\u3089\u306e\u30c7\u30fc\u30bf\u30bd\u30fc\u30b9\uff08\u30e1\u30e2\u30ea\u3001\u30ed\u30fc\u30ab\u30eb\u30d5\u30a1\u30a4\u30eb\u3001HDFS\u3001HBase etc..\uff09\u304b\u3089\u751f\u6210\u3059\u308b\u3002\u5c1a\u3001createRDD\u306f\u524d\u7ae0\u306eparallelize\u3068\u8a18\u8ff0\u3055\u308c\u305f\u7b87\u6240\u3068\u52d5\u4f5c\u3068\u3057\u3066\u306f\u540c\u3058\u3002\n\nRDD\u306b\u5bfe\u3059\u308b\u5909\u63db\u30aa\u30da\u30ec\u30fc\u30b7\u30e7\u30f3\u7fa4\u306ftransformation()\u3068\u3057\u3066\u8a18\u8ff0\u3055\u308c\u308b\u3002\u5404transformation()\u306f1\u500b\u3001\u307e\u305f\u306f\u8907\u6570\u306eRDD[T]\u3092\u751f\u6210\u3059\u308b\u3002\uff08T\u306fScala\u306e\u578b\uff09\n\n\u3082\u3057T\u304c(K, V)\u3068\u3044\u3046Key\u3068Value\u306e\u30da\u30a2\u3060\u3063\u305f\u5834\u5408\u3001K\u306f\u30b3\u30ec\u30af\u30b7\u30e7\u30f3\u578b\uff08Array\u3084List\u7b49\uff09\u3092\u8a2d\u5b9a\u3059\u308b\u3053\u3068\u306f\u51fa\u6765\u306a\u3044\u3002\u7406\u7531\u306f\u3001\u30b3\u30ec\u30af\u30b7\u30e7\u30f3\u578b\u306e\u5834\u5408Partition\u3092\u5b9a\u7fa9\u3057\u3066\u5206\u5272\u3059\u308b\u3053\u3068\u304c\u56f0\u96e3\u3068\u306a\u308b\u305f\u3081\u3002\naction\u3068\u8a18\u8ff0\u3055\u308c\u308b\u30a2\u30af\u30b7\u30e7\u30f3\u30aa\u30da\u30ec\u30fc\u30b7\u30e7\u30f3\u306f\u6700\u5f8c\u306eRDD\u306b\u5bfe\u3057\u3066\u5b9f\u884c\u3055\u308c\u3001\u5404Partition\u304b\u3089\u7d50\u679c\u3092\u751f\u6210\u3059\u308b\u3002\n\n\u5404\u7d50\u679c\u306fDriver\u30d7\u30ed\u30b0\u30e9\u30e0\u306b\u9001\u4fe1\u3055\u308c\u3001f(List[Result])\u304c\u6700\u7d42\u7684\u7d50\u679c\u3068\u3057\u3066\u8a08\u7b97\u3055\u308c\u308b\u3002\u4f8b\u3048\u3070\u3001count\u306faction\u3068sum\u306e2\u30b9\u30c6\u30c3\u30d7\u3092\u7d4c\u308b\u3002\uff08\u5404RDD\u3067action\u3092\u5b9f\u884c\u3057\u3066\u8981\u7d20\u6570\u3092\u30ab\u30a6\u30f3\u30c8\u3057\u3001Driver\u306b\u9001\u4fe1\u3057\u3066\u5408\u8a08\u5024\u8a08\u7b97\uff09\n\nRDD\u306fcache/persist/checkpoint\u30e1\u30bd\u30c3\u30c9\u3092\u5b9f\u884c\u3059\u308b\u3053\u3068\u3067\u30e1\u30e2\u30ea\u4e0a\u306b\u30ad\u30e3\u30c3\u30b7\u30e5\u3059\u308b\u304b\u3001\u30c7\u30a3\u30b9\u30af\u4e0a\u306b\u4fdd\u5b58\u3059\u308b\u3053\u3068\u304c\u51fa\u6765\u308b\u3002Partition\u6570\u306f\u57fa\u672c\u306f\u30e6\u30fc\u30b6\u306b\u3088\u3063\u3066\u6307\u5b9a\u3055\u308c\u308b\u30022RDD\u9593\u306ePartition\u306e\u30de\u30c3\u30d4\u30f3\u30b0\u306f1:1 or M:N\u306e2\u7a2e\u985e\u304c\u3042\u308b\u3002\u4e0a\u8a18\u306e\u56f3\u306e\u4e2d\u3067\u306f\u4e21\u65b9\u306e\u30d1\u30bf\u30fc\u30f3\u304c\u8a18\u8ff0\u3055\u308c\u3066\u3044\u308b\u3002\n\n### Logical Plan\n\nSpark\u306e\u30b3\u30fc\u30c9\u3092\u66f8\u3044\u3066\u3044\u308b\u6700\u4e2d\u306b\u5b9f\u88c5\u8005\u306f\u982d\u306e\u4e2d\u3067LogicalPlan\uff08\u4f8b\u3048\u3070\u3001\u3044\u304f\u3064\u306eRDD\u304c\u751f\u6210\u3055\u308c\u308b\u304b\uff09\u3092\u601d\u3044\u6d6e\u304b\u3079\u3066\u3044\u308b\u304b\u3082\u3057\u308c\u306a\u3044\u3002\u3060\u304c\u3001\u5b9f\u969b\u306f\u66f4\u306b\u591a\u304f\u306eRDD\u304c\u5b9f\u884c\u4e2d\u306b\u751f\u6210\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u304c\u591a\u3044\u3002\n\nLogicalPlan\u306e\u751f\u6210\u65b9\u6cd5\u3092\u660e\u78ba\u306b\u3059\u308b\u3053\u3068\u3067\u3001\u4e0e\u3048\u3089\u308c\u305fSparkProgram\u306b\u304a\u3044\u3066\u3044\u304f\u3064RDD\u304c\u751f\u6210\u3055\u308c\u308b\u304b\u3001\u3068\u3044\u3063\u305f\u8cea\u554f\u306b\u3082\u7b54\u3048\u3089\u308c\u308b\u3088\u3046\u306b\u306a\u308b\u3060\u308d\u3046\u3002\n\n\u3069\u306e\u3088\u3046\u306bRDD\u304c\u751f\u6210\u3055\u308c\u308b\u306e\u304b\uff1f\n\u3069\u306e\u3088\u3046\u306a\u7a2e\u985e\u306eRDD\u304c\u751f\u6210\u3055\u308c\u308b\u306e\u304b\uff1f\n\u3069\u306e\u3088\u3046\u306bRDD\u9593\u304c\u63a5\u7d9a\u3055\u308c\u308b\u306e\u304b\uff1f\uff08\u4f8b\u3048\u3070\u4f9d\u5b58\u95a2\u4fc2\u306b\u3042\u308bRDD\uff09\n\n#### 1. \u3069\u306e\u3088\u3046\u306aRDD\u304c\u3069\u3046\u3084\u3063\u3066\u751f\u6210\u3055\u308c\u308b\u306e\u304b\uff1f\n\ntransformation\u306f\u57fa\u672c\u306f\u65b0\u305f\u306aRDD\u3092\u4e00\u3064\u751f\u6210\u3059\u308b\u304c\u3001\u3044\u304f\u3064\u304b\u306etransformation\u3067\u306f\u8907\u6570\u306e\u30d5\u30a7\u30fc\u30ba\u306b\u5206\u3051\u3066\u6f14\u7b97\u304c\u884c\u308f\u308c\u305f\u308a\u3001\u30b5\u30d6transformation\u3092\u542b\u3080\u305f\u3081\u8907\u6570\u306eRDD\u3092\u751f\u6210\u3057\u3066\u3044\u308b\u3002\u305d\u308c\u304c\u8003\u3048\u3066\u3044\u308b\u3088\u308a\u3082\u591a\u304f\u306eRDD\u304c\u751f\u6210\u3055\u308c\u308b\u7406\u7531\u3068\u306a\u308b\u3002\n\nLogicalPlan\u306f\u8a00\u3063\u3066\u3057\u307e\u3048\u3070\u6f14\u7b97\u306e\u9023\u9396\u3068\u3082\u8a00\u3044\u8868\u3059\u3053\u3068\u304c\u51fa\u6765\u308b\u3002\u3042\u3089\u3086\u308bRDD\u306fcompute()\u30e1\u30bd\u30c3\u30c9\u3092\u4fdd\u6301\u3057\u3066\u304a\u308a\u3001\u524d\u306eRDD\u304b\u30c7\u30fc\u30bf\u30bd\u30fc\u30b9\u304b\u3089\u53d6\u5f97\u3057\u305f\u5165\u529b\u30ec\u30b3\u30fc\u30c9\u3092\u57fa\u306btransformation()\u3092\u5b9f\u884c\u3057\u3066\u65b0\u305f\u306a\u30ec\u30b3\u30fc\u30c9\u3092\u51fa\u529b\u3059\u308b\u3053\u3068\u304c\u51fa\u6765\u308b\u305f\u3081\u3067\u3042\u308b\u3002\n\n\u3069\u306e\u3088\u3046\u306aRDD\u304ctransformation()\u306e\u5b9f\u884c\u306b\u3088\u3063\u3066\u751f\u6210\u3055\u308c\u308b\u304b\u3092\u77e5\u308b\u305f\u3081\u306b\u3001\u57fa\u672c\u7684\u306atransformation()\u306b\u5bfe\u3057\u3066\u3069\u306e\u3088\u3046\u306aRDD\u304c\u751f\u6210\u3055\u308c\u308b\u304b\u3092\u8a18\u8ff0\u3059\u308b\u3002\n\ntransformation()\u304cSpark\u30b5\u30a4\u30c9\u3067\u6301\u3064\u610f\u5473\u306b\u3064\u3044\u3066\u5b66\u3076\u305f\u3081\u306b\u3001\u307e\u305a\u306f\u5404transformation()\u306e\u8a73\u7d30\u306b\u3064\u3044\u3066\u4e0b\u8a18\u306e\u8868\u306b\u8a18\u8ff0\u3057\u305f\u3002iterator(split)\u306e\u30ab\u30e9\u30e0\u306fPartition\u4e2d\u306e\u5404\u30ec\u30b3\u30fc\u30c9\u306b\u5bfe\u3057\u3066\u3069\u306e\u3088\u3046\u306b\u51e6\u7406\u304c\u884c\u308f\u308c\u308b\u304b\u3092\u8a18\u8ff0\u3057\u3066\u3044\u308b\u3002\n\u4e0b\u8a18\u306e\u8868\u306e\u4e2d\u306b\u306f\u3044\u304f\u3064\u304b\u30d6\u30e9\u30f3\u30af\u306b\u306a\u3063\u3066\u3044\u308b\u500b\u6240\u304c\u3042\u308b\u304c\u3001\u305d\u308c\u306f\u8907\u96d1\u306atransformation()\u3068\u306a\u3063\u3066\u304a\u308a\u3001\u8907\u6570\u306eRDD\u3092\u751f\u6210\u3059\u308b\u305f\u3081\u3067\u3042\u308b\u3002\n\u8a73\u7d30\u306f\u3053\u306e\u5f8c\u8a18\u8ff0\u3059\u308b\u3002\n\n| Transformation | Generated RDDs | Compute() |\n|:-----------|:------------|:---------------|\n|map(func)|MappedRDD|iterator(split).map(f)|\n|filter(func)|FilteredRDD|iterator(split).filter(f)|\n|flatMap(func)|FlatMappedRDD|iterator(split).flatMap(f)|\n|mapPartitions(func)|MapPartitionsRDD|f(iterator(split))|\n|mapPartitionsWithIndex(func)|MapPartitionsRDD|f(split.index, iterator(split))|\n|sample(withReplacement, fraction, seed)|PartitionwiseSampledRDD|PoissonSampler.sample(iterator(split))\u3000<br>BernoulliSampler.sample(iterator(split))|\n|pipe(command, [envVars])|PipedRDD||\n|union(otherDataset)|||\n|intersection(otherDataset)|||\n|distinct([numTasks]))|||\n|groupByKey([numTasks])|||\n|reduceByKey(func, [numTasks])|||\n|sortByKey([ascending], [numTasks])|||\n|join(otherDataset, [numTasks])|||\n|cogroup(otherDataset, [numTasks])|||\n|cartesian(otherDataset)|||\n|coalesce(numPartitions)|||\n|repartition(numPartitions)|||\n\n#### 2. \u3069\u306e\u3088\u3046\u306b\u8907\u6570RDD\u9593\u306e\u30c7\u30fc\u30bf\u4f9d\u5b58\u304c\u751f\u6210\u3055\u308c\u308b\u306e\u304b\uff1f\n\n\u3053\u306e\u8cea\u554f\u306f3\u500b\u306e\u5c0f\u3055\u306a\u8cea\u554f\u306b\u5206\u5272\u3055\u308c\u308b\u3002\n\n1. \u5bfe\u8c61\u306eRDD\u306f1\u500b\u306e\u89aaRDD\u306b\u4f9d\u5b58\u3059\u308b\u306e\u304b\uff1f\u305d\u308c\u3068\u3082\u8907\u6570\u306e\u89aaRDD\u306b\u4f9d\u5b58\u3059\u308b\u306e\u304b\uff1f\n2. RDD\u306b\u306f\u3044\u304f\u3064\u306ePartition\u304c\u5b58\u5728\u3059\u308b\u306e\u304b\uff1f\n3. \u5bfe\u8c61\u306eRDD\u3068\u89aaRDD\u306e\u95a2\u4fc2\u306f\u3069\u3046\u306a\u3063\u3066\u3044\u308b\u306e\u304b\uff1f\u5bfe\u8c61RDD\u306e1\u500b\u306ePartition\u306f\u89aaRDD\u306e1\u500b\u306ePartition\u306b\u4f9d\u5b58\u3059\u308b\u306e\u304b\uff1f\u305d\u308c\u3068\u3082\u8907\u6570\u306ePartition\u306b\u4f9d\u5b58\u3059\u308b\u306e\u304b\uff1f\n\n2\u500b\u76ee\u306e\u8cea\u554f\u3078\u306e\u56de\u7b54\u3068\u3057\u3066\u306f\u3001Partition\u6570\u306f\u30e6\u30fc\u30b6\u306b\u3088\u3063\u3066\u6307\u5b9a\u3055\u308c\u308b\u304c\u3001\u6307\u5b9a\u304c\u306a\u3044\u5834\u5408\u3001\u5b50RDD\u306e\u4fdd\u6301\u3059\u308bPartition\u6570\u306f\u4f9d\u5b58\u3059\u308b\u89aaRDD\u306e\u4e2d\u3067\u6700\u3082\u591a\u3044Partition\u3092\u6301\u3064RDD\u306ePartition\u6570\u3068\u540c\u4e00\u306e\u5024\u3068\u306a\u308b\u3002\n\n3\u500b\u76ee\u306e\u8cea\u554f\u3078\u306e\u56de\u7b54\u306f\u8907\u96d1\u306b\u306a\u308b\u3002\u4f55\u6545\u306a\u3089\u3001transformation()\u306e\u30bb\u30de\u30f3\u30c6\u30a3\u30af\u30b9\u3092\u8003\u3048\u308b\u5fc5\u8981\u304c\u3042\u308b\u305f\u3081\u3002\u7570\u306a\u308btransformation()\u306f\u7570\u306a\u308b\u30c7\u30fc\u30bf\u4f9d\u5b58\u6027\u3092\u6301\u3064\u3002\u4f8b\u3048\u3070\u3001map()\u306f1:1\u306e\u5bfe\u5fdc\u3092\u6301\u3064transformation()\u3060\u304cgroupByKey()\u306fShuffledRDD\u3092\u751f\u6210\u3057\u3001ShuffledRDD\u306e\u5404Partition\u306f\u89aaRDD\u306e\u5168\u3066\u306ePartition\u306b\u4f9d\u5b58\u3057\u3066\u3044\u308b\u3002\u5225\u306etransformation()\u3067\u306f\u3001\u66f4\u306b\u8907\u96d1\u306b\u306a\u308b\u30d1\u30bf\u30fc\u30f3\u3082\u3042\u308b\u3002\n\nSpark\u306b\u304a\u3044\u3066\u306f\u4e0b\u8a18\u306e2\u7a2e\u985e\u306eRDD\u9593\u306ePartition\u4f9d\u5b58\u304c\u5b58\u5728\u3057\u3066\u3044\u308b\u3002\n\n- 1.NarrowDependency (e.g., OneToOneDependency and RangeDependency)\n\n\u5b50RDD\u306e\u5404Partition\u306f\u89aaRDD\u306e\u3044\u304f\u3064\u304b\u306ePartition\u306b\u4f9d\u5b58\u3059\u308b\u3002FullDependency\u3068\u66f8\u3044\u305f\u5834\u5408\u3001\u5b50Partition\u306f\u89aaPartition\u306e\u5168\u4f53\u306b\u4f9d\u5b58\u3059\u308b\u3002\n\n- 2.ShuffleDependency (or Wide dependency mentioned in Matei's paper)\n\n\u5b50RDD\u306e\u8907\u6570\u306ePartition\u304c\u89aaRDD\u306ePartition\u306b\u4f9d\u5b58\u3059\u308b\u3068\u3044\u3046\u30d1\u30bf\u30fc\u30f3\u3002PartialDependency\u3068\u66f8\u3044\u305f\u5834\u5408\u3001\u5404\u5b50Partition\u306f\u89aaPartition\u306e\u4e00\u90e8\u306e\u5024\u306b\u4f9d\u5b58\u3059\u308b\u3002\n\n\u4f8b\u3048\u3070\u3001map()\u306fNarrowDependency\u3092\u793a\u3057\u3001join()\u306f\u57fa\u672c\u306fWideDependency\u3092\u793a\u3059\u3002\n\u307e\u305f\u3001\u5b50Partition\u306f\u89aaRDD\u4e2d\u306e1Partition\u3068\u3001\u5225\u306e\u89aaRDD\u306e1Partition\u306b\u4f9d\u5b58\u3059\u308b\u30d1\u30bf\u30fc\u30f3\u3082\u3042\u308b\u3002\n\n\u53c2\u8003\u3068\u3057\u3066\u3001NarrowDependency\u306e\u5834\u5408\u3001\u5b50Partition\u304c\u305d\u306e\u89aaPartition\u306b\u4f9d\u5b58\u3059\u308b\u304b\u306f\u5b50RDD\u304c\u4fdd\u6301\u3059\u308bgetParents(partition i)\u3092\u7528\u3044\u3066\u53d6\u5f97\u3059\u308b\u3053\u3068\u304c\u51fa\u6765\u308b\u3002\nShuffleDependency\u306e\u5834\u5408\u3001MapReduce\u306eShuffleDependency\u3068\u540c\u3058\u69cb\u6210\u3068\u306a\u3063\u3066\u3044\u308b\u3002\uff08Mapper\u304c\u5404Partition\u306e\u5024\u3092\u51fa\u529b\u3057\u3001\u5404Reducer\u304c\u5168\u3066\u306e\u5fc5\u8981Partition\u306e\u5024\u3092http.fetch\u3067\u53d6\u5f97\uff09\n\n\u3053\u306e2\u7a2e\u985e\u306e\u4f9d\u5b58\u95a2\u4fc2\u306f\u4e0b\u56f3\u306e\u3088\u3046\u306b\u8868\u308f\u3055\u308c\u308b\u3002\n\n![Dependency.png](https://qiita-image-store.s3.amazonaws.com/0/9616/44e91880-20d2-f11d-1b36-c748e3136332.png)\n\n\u5b9a\u7fa9\u304b\u3089\u3059\u308b\u3068\u3001\u6700\u521d\u306e\u30b1\u30fc\u30b9\u304cNarrowDependency\u3067\u3001\u6700\u5f8c\u306e\u30b1\u30fc\u30b9\u304cShuffleDependency\u306b\u306a\u308b\u3002\n\n\u8ffd\u8a18\u3057\u3066\u304a\u304f\u3068\u3001\u5de6\u4e0b\u306e\u30b1\u30fc\u30b9\u306fN:N NarrowDependency\u3060\u304c\u3001\u30ec\u30a2\u30b1\u30fc\u30b9\u3068\u306a\u308b\u3002ShuffleDependency\u3068\u3082\u4f3c\u3066\u306f\u3044\u308b\u304c\u3001\u3053\u308c\u306fFullDependency\u3067\u3042\u308b\u3002\u3053\u308c\u306f\u3044\u304f\u3064\u304b\u306e\u7279\u6b8a\u306atransformation()\u7fa4\u3067\u306e\u307f\u751f\u6210\u3055\u308c\u308b\u3002NarrowDependency\u306fSpark\u306b\u304a\u3044\u3066\u672c\u8cea\u7684\u306b\u306f\u5404\u5b50Partition\u306f\u305f\u304b\u3060\u304b1\u500b\u306e\u89aaPartition\u306b\u4f9d\u5b58\u3059\u308b\u7269\u306e\u305f\u3081\u3001\u3053\u3053\u3067\u306f\u3053\u306e\u7279\u6b8a\u30b1\u30fc\u30b9\u306f\u6271\u308f\u306a\u3044\u3002\n\n\u307e\u3068\u3081\u308b\u3068\u3001Partition\u9593\u306e\u4f9d\u5b58\u6027\u306f\u4e0b\u8a18\u306e\u30d1\u30bf\u30fc\u30f3\u304c\u3042\u308b\u3002\n- NarrowDependency (black arrow)\n  - RangeDependency => only used for UnionRDD\n  - OneToOneDependency (1:1) => e.g., map(), filter()\n  - NarrowDependency (N:1) => e.g., co-partitioned join()\n  - NarrowDependency (N:N) => a rare case\n- ShuffleDependency (red arrow)\n\n\u3053\u306e\u7ae0\u3067\u306f\u3053\u308c\u4ee5\u964d\u3001NarrowDependency\u3092\u9ed2\u77e2\u5370\u3067\u3001ShuffleDependency\u3092\u8d64\u77e2\u5370\u3067\u8a18\u8ff0\u3059\u308b\u3002\nNarrowDependency\u3068ShuffleDependency\u306e\u7279\u5fb4\u306fPhysicalPlan\u3092\u4f5c\u6210\u3059\u308b\u306e\u306b\u5fc5\u8981\u306b\u306a\u308b\u304c\u3001\u8a73\u7d30\u306f\u6b21\u306e\u7ae0\u3067\u8ff0\u3079\u308b\u3002\n\n#### 3. \u3069\u306e\u3088\u3046\u306bRDD\u4e2d\u306e\u30ec\u30b3\u30fc\u30c9\u306f\u8a08\u7b97\u3055\u308c\u308b\u306e\u304b\uff1f\n\nOneToOneDependency\u306e\u5834\u5408\u3001\u4e0b\u8a18\u306e\u56f3\u306e\u3088\u3046\u306b\u793a\u3055\u308c\u308b\u3002\n\u3060\u304c\u3001Partition\u9593\u306e\u95a2\u4fc2\u306f1:1\u3067\u3042\u3063\u3066\u3082\u3001\u305d\u308c\u306f\u5404Partition\u4e2d\u306eRecord\u30921\u30ec\u30b3\u30fc\u30c9\u305a\u3064\u51e6\u7406\u3059\u308b\u3053\u3068\u3068\u30a4\u30b3\u30fc\u30eb\u3067\u306f\u306a\u3044\u3002\n\n![OneToOneDependency.png](https://qiita-image-store.s3.amazonaws.com/0/9616/2b3793c9-639d-cec0-f61e-63afa1d8b0cc.png)\n\n\u56f3\u306e\u53f3\u5074\u306b\u793a\u3057\u305f2\u30d1\u30bf\u30fc\u30f3\u306e\u9055\u3044\u306b\u3064\u3044\u3066\u306f\u4e0b\u8a18\u306e\u30bd\u30fc\u30b9\u30b3\u30fc\u30c9\u30b9\u30cb\u30da\u30c3\u30c8\u3068\u3057\u3066\u793a\u3059\u3053\u3068\u304c\u51fa\u6765\u308b\u3002\n\nCode of iter.f():\n\n```scala\nint[] array = {1, 2, 3, 4, 5}\nfor(int i = 0; i < array.length; i++)\n    output f(array[i])\n```\n\nCode of f(iter):\n\n```scala\nint[] array = {1, 2, 3, 4, 5}\noutput f(array)\n```\n\n#### 4. \u57fa\u672c\u306ePartition\u9593\u306e\u4f9d\u5b58\u3092\u56f3\u793a\u3057\u3066\u307f\u308b\u3068\uff1f\n\n**1) union(otherRDD)**\n\n![union.png](https://qiita-image-store.s3.amazonaws.com/0/9616/efd24088-769d-d4da-be34-7fa585003899.png)\n\nunion()\u306f\u5358\u7d14\u306b2\u500b\u304b\u305d\u308c\u4ee5\u4e0a\u306eRDD\u3092\u7d50\u5408\u3059\u308b\u306e\u307f\u3002union()\u3067\u306f\u5404Partition\u4e2d\u306e\u30c7\u30fc\u30bf\u306f\u5909\u66f4\u3055\u308c\u306a\u3044\u3002RangeDependency(1:1)\u306f\u5143\u306ePartition\u3092\u518d\u53d6\u5f97\u3059\u308b\u306e\u3092\u5bb9\u6613\u306b\u3059\u308b\u305f\u3081\u306b\u3001\u5143\u306eRDD\u306ePartition\u9593\u306e\u533a\u5207\u308a\u3092\u305d\u306e\u307e\u307e\u7dad\u6301\u3059\u308b\u3002\n\n**2) groupByKey(numPartitions)**\n\n![groupByKey.png](https://qiita-image-store.s3.amazonaws.com/0/9616/f63154f4-3653-6591-d190-09114718be48.png)\n\n\u65e2\u306b\u524dgroupByKey\u306e\u30c7\u30fc\u30bf\u4f9d\u5b58\u306b\u3064\u3044\u3066\u8ff0\u3079\u3066\u308b\u304c\u3001\u3053\u3053\u3067\u306f\u3088\u308a\u660e\u78ba\u306b\u8a18\u8ff0\u3059\u308b\u3002\n\ngroupByKey()\u306f\u540c\u3058\u30ad\u30fc\u5024\u3092\u6301\u3064\u30ec\u30b3\u30fc\u30c9\u3092Shuffle\u306b\u3088\u3063\u3066\u96c6\u7d04\u3059\u308b\u3002\n\u305d\u306e\u305f\u3081\u3001ShuffledRDD\u306b\u5bfe\u3059\u308bcompute()\u95a2\u6570\u306f\u5404Partition\u306b\u5fc5\u8981\u306a\u5fc5\u8981\u306a\u30c7\u30fc\u30bf\u3092\u53d6\u5f97\u3057\u3001\u5f8c\u6bb5\u306emapPartition()\u306b\u5bfe\u3057\u3066OneToOneDependency\u3068\u540c\u3058\u3088\u3046\u306b\u30c7\u30fc\u30bf\u3092\u6d41\u3059\u3002\u6700\u7d42\u7684\u306b\u3001ArrayBuffer\u304cIterable\u306b\u30ad\u30e3\u30b9\u30c8\u3055\u308c\u305f\u4e0a\u3067\u5f8c\u306eRDD\u304b\u3089\u30a2\u30af\u30bb\u30b9\u53ef\u80fd\u3068\u306a\u308b\u3002\n\ngroupByKey()\u306fMapSideCombine\u306f\u30c7\u30fc\u30bf\u91cf\u304c\u524a\u6e1b\u3055\u308c\u306a\u3044\u4e0a\u3001\u5168Mapper\u306e\u51fa\u529b\u30c7\u30fc\u30bf\u3092HashTable\u306b\u5165\u308c\u8fbc\u3080\u3053\u3068\u304c\u5fc5\u8981\u306b\u306a\u308a\u3001\u30c7\u30fc\u30bf\u91cf\u304c\u6ea2\u308c\u308b\u95a2\u4fc2\u4e0a\u5b9f\u65bd\u3057\u3066\u3044\u306a\u3044\u3002\nArrayBuffer\u306f\u57fa\u672c\u7684\u306b\u306fCompactBuffer\u304c\u4f7f\u308f\u308c\u308b\u3002CompactBuffer\u306fArrayBuffer\u306b\u4f3c\u305fappend-only\u306a\u30d0\u30c3\u30d5\u30a1\u3068\u306a\u3063\u3066\u304a\u308a\u3001\u5c0f\u898f\u6a21\u30d0\u30c3\u30d5\u30a1\u306b\u304a\u3044\u3066\u30e1\u30e2\u30ea\u3092\u6709\u52b9\u6d3b\u7528\u3059\u308b\u3053\u3068\u304c\u51fa\u6765\u308b\u3002\n\n**3) reduceyByKey(func, numPartitions)**\n\n![reduceByKey.png](https://qiita-image-store.s3.amazonaws.com/0/9616/9bbe618b-69b2-58da-6f01-0cf39d1d33ee.png)\n\nreduceByKey()\u306fMapReduce\u3067\u306ereduce()\u3068\u306b\u3066\u304a\u308a\u3001\u30c7\u30fc\u30bf\u30d5\u30ed\u30fc\u3068\u3057\u3066\u306f\u540c\u7b49\u3068\u306a\u3063\u3066\u3044\u308b\u3002redcuceByKey()\u306f\u30c7\u30d5\u30a9\u30eb\u30c8\u3067\u306fshuffle\u524d\u306bMapSideCombine\u3092\u5b9f\u884c\u3057\u3066\u3044\u308b\u3002shuffle\u5f8c\u3001\u518d\u5ea6\u5404MapPartition\u306b\u5bfe\u3057\u3066aggregate\u3092\u5b9f\u884c\u3057\u3001\u7d50\u679c\u3068\u3057\u3066\u306fMapPartitionsRDD\u304c\u751f\u6210\u3055\u308c\u308b\u3002\n\n**4) distinct(numPartitions)**\n\n![distinct.png](https://qiita-image-store.s3.amazonaws.com/0/9616/da144832-98c1-9bf8-b28c-e2bc9874311c.png)\n\ndistinct()\u306fRDD\u4e2d\u306e\u91cd\u8907\u3057\u305f\u30ec\u30b3\u30fc\u30c9\u3092\u9664\u53bb\u3059\u308b\u3053\u3068\u3092\u76ee\u7684\u3068\u3057\u3066\u3044\u308b\u3002\u7570\u306a\u308bPartition\u4e2d\u306b\u91cd\u8907\u3057\u305f\u30ec\u30b3\u30fc\u30c9\u304c\u5b58\u5728\u3059\u308b\u5834\u5408\u3001\u9664\u53bb\u3059\u308b\u305f\u3081\u306b\u306fshuffle + aggregation\u304c\u5fc5\u8981\u3068\u306a\u308b\u3002\u3060\u304c\u3001shuffle\u3092\u5b9f\u884c\u3059\u308b\u306b\u306fRDD\u306e\u578b\u304cRDD[(K,V)]\u3067\u3042\u308b\u5fc5\u8981\u304c\u3042\u308b\u305f\u3081\u3001\u5143\u306eRDD\u304c\u5358\u4e00\u306e\u5024\u3057\u304b\u3082\u305f\u306a\u3044\u30ec\u30b3\u30fc\u30c9\uff08\u4f8b\u3048\u3070\u3001RDD[Int]\uff09\u3060\u3063\u305f\u5834\u5408\u3001\u4e00\u5ea6map() transform\u3092\u9069\u7528\u3057\u3066<K,null>\u306e\u5f62\u5f0f\u306b\u5909\u63db\u3057\u3066\u3044\u308b\u3002\u305d\u306e\u5f8c\u3001reduceByKey()\u306f\u3044\u304f\u3064\u304b\u306eshuffle\u51e6\u7406\uff08mapSideCombine => reduce => MapPartitionsRDD\uff09\u3092\u5b9f\u884c\u3059\u308b\u3002\u6700\u7d42\u7684\u306b<K,null>\u5f62\u5f0f\u306e\u30ec\u30b3\u30fc\u30c9\u304b\u3089\u30ad\u30fc\u306e\u307f\u3092\u62bd\u51fa\u3057\u3001\u5143\u306eRDD\u306e\u578b\u306b\u5408\u308f\u305b\u3066\u3044\u308b\u3002\u4e0a\u8a18\u306e\u56f3\u306e\u4e2d\u3067\u306f\u7d14\u7c8b\u306breduceByKey()\u90e8\u3092\u793a\u3057\u3066\u3044\u308b\u306e\u306f\u9752\u306eRDD\u306e\u307f\u3068\u306a\u3063\u3066\u3044\u308b\u3002\n\n**5) cogroup(otherRDD, numPartitions)**\n\n![cogroup.png](https://qiita-image-store.s3.amazonaws.com/0/9616/e3b1fcc6-e064-857b-292c-ee28a316340b.png)\n\ngroupByKey()\u3068\u7570\u306a\u308a\u3001cogroup()\u306f2\u500b\u304b\u305d\u308c\u4ee5\u4e0a\u306eRDD\u3092\u7d71\u5408\u3057\u3066\u3044\u308b\u3002\n\u305d\u306e\u305f\u3081\u3001\u8cea\u554f\u304c\u751f\u3058\u308b\u3002\u89aaRDD\u3068CoGroupedRDD\u306ePartition\u9593\u306e\u4f9d\u5b58\u306fShuffleDependency\u306a\u306e\u304b\u3001OneToOneDependency\u306a\u306e\u304b\uff1f \u3053\u306e\u8cea\u554f\u306f\u4ee5\u4e0b\u306e2\u3064\u306e\u8981\u7d20\u306b\u4f9d\u5b58\u3059\u308b\u305f\u3081\u3001\u3044\u3055\u3055\u304b\u8907\u96d1\u306b\u306a\u308b\u3002\n\n**\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u6570**\n\nCoGroupedRDD\u306ePartition\u6570\u306f\u30e6\u30fc\u30b6\u306b\u3088\u3063\u3066\u6307\u5b9a\u3055\u308c\u3001\u89aa\u3068\u306a\u308bRDD a\u3068RDD b\u3068\u306f\u95a2\u4fc2\u304c\u306a\u3044\u3002\n\u3060\u304c\u3001CoGroupedRDD\u306ePartition\u6570\u304cRDD a\u3084RDD b\u3068\u7570\u306a\u308b\u5834\u5408\u3001Partition\u4f9d\u5b58\u306fOneToOneDependency\u3067\u306f\u89e3\u6c7a\u3067\u304d\u306a\u3044\u3002\n\n**Partitioner\u306e\u578b**\n\ncogroup\u3092\u884c\u3046\u969b\u306b\u30c7\u30fc\u30bf\u3092\u3069\u3046\u914d\u5206\u3059\u308b\u304b\u306ePartitioner\u3082\u30e6\u30fc\u30b6\u306b\u3088\u3063\u3066\u6307\u5b9a\u3055\u308c\u308b\uff08\u30c7\u30d5\u30a9\u30eb\u30c8\u306fHashPartitioner \uff09\u3002\u3082\u3057RDD a\u3001RDD b\u3001CoGroupedRDD\u306ePartition\u6570\u304c\u540c\u3058\u3067\u3042\u3063\u3066\u3082Partitioner\u304c\u9055\u3046\u5834\u5408\u3001Partition\u9593\u306e\u4f9d\u5b58\u306f OneToOneDependency\u306b\u51fa\u6765\u306a\u3044\u3002\n\u305d\u306e\u305f\u3081\u3001\u4e0a\u8a18\u306e\u56f3\u306e\u6700\u5f8c\u306e\u30d1\u30bf\u30fc\u30f3\uff08RDD a is RangePartitioner, RDD b is HashPartitioner, and CoGroupedRDD is RangePartitioner with the same # partition as RDD a\uff09\u306b\u3064\u3044\u3066\u8003\u3048\u3066\u307f\u308b\u3002RDD a\u5074\u306e\u5404Partition\u4e2d\u306e\u30ec\u30b3\u30fc\u30c9\u306f\u5bfe\u5fdc\u3059\u308bCoGroupedRDD\u306b\u5bfe\u3057\u3066\u9001\u3063\u3066\u3057\u307e\u3063\u3066\u554f\u984c\u306a\u3044\u3002\u3060\u304c\u3001RDD b\u306e\u5404Partition\u4e2d\u306e\u30ec\u30b3\u30fc\u30c9\u306fCoGroupedRDD\u306b\u4f75\u305b\u3066Shuffle\u3057\u3066\u5bfe\u5fdc\u305a\u3051\u308b\u5fc5\u8981\u304c\u3042\u308b\u3002\n\n\u7d50\u8ad6\u3068\u3057\u3066\u3001OneToOneDependency\u306f\u89aaRDD\u3068CoGroupedRDD\u306ePartitioner\u3068Partition\u6570\u304c\u540c\u4e00\u3067\u3042\u308b\u5834\u5408\u306e\u307f\u9069\u7528\u3055\u308c\u308b\u3002\u305d\u3046\u3067\u306a\u3044\u5834\u5408\u3001ShuffleDependency\u3068\u306a\u308b\u3002\u3053\u308c\u4ee5\u4e0a\u306e\u8a73\u7d30\u306fCoGroupedRDD.getDependencies()\u306e\u30b3\u30fc\u30c9\u3092\u8aad\u3093\u3067\u307b\u3057\u3044\u3002\n\n**Spark\u306f\u3069\u306e\u3088\u3046\u306b\u3057\u3066CoGroupedRDD\u306e\u5404Partition\u306e\u8907\u6570\u306e\u4f9d\u5b58Partition\u3092\u7dad\u6301\u3057\u3066\u3044\u308b\u306e\u304b\uff1f**\n\n\u307e\u305a\u306f\u3058\u3081\u306b\u3001CoGroupedRDD\u306f\u5168\u3066\u306e\u89aaRDD\u3092RDDs\u306b\u5165\u308c\u3001\u4e0b\u8a18\u306e\u51e6\u7406\u3092\u884c\u3046\u3002\n\n```scala\nForeach rdd = rdds(i):\n    if the dependency between CoGroupedRDD and rdd is OneToOneDependency\n        Dependecy[i] = new OneToOneDependency(rdd)\n    else\n        Dependecy[i] = new ShuffleDependency(rdd)\n```\n\n\u6700\u7d42\u7684\u306b\u4e0a\u8a18\u306e\u30b3\u30fc\u30c9\u306f\u5404\u89aaRDD\u306b\u5bfe\u3059\u308b\u4f9d\u5b58\u6027\u914d\u5217\u3067\u3042\u308bdeps\u3092\u8fd4\u3059\u3002\n\n`Dependency.getParents(partition id)` \u306f `Partitions: List[Int]` \u306f\u4e0e\u3048\u3089\u308c\u305f\u4f9d\u5b58\u6027\u306b\u5bfe\u5fdc\u3059\u308bPartition\u3092\u8fd4\u3059\u3002\ngetPartitions()\u30e1\u30bd\u30c3\u30c9\u306fRDD\u306b\u3044\u304f\u3064\u306ePartition\u304c\u5b58\u5728\u3057\u3066\u304a\u308a\u3001\u3069\u306e\u3088\u3046\u306b\u30b7\u30ea\u30a2\u30e9\u30a4\u30ba\u5316\u3055\u308c\u308b\u304b\u3082\u8fd4\u3059\u3002\n\n**6) intersection(otherRDD)**\n\n![intersection.png](https://qiita-image-store.s3.amazonaws.com/0/9616/dc7d8863-ac1a-6a25-6d32-2425cb425f64.png)\n\nintersection()\u306fRDD a\u3068RDD b\u306e\u9593\u306b\u5b58\u5728\u3059\u308b\u5171\u901a\u8981\u7d20\u3092\u62bd\u51fa\u3059\u308b\u3053\u3068\u3092\u76ee\u7684\u3068\u3057\u3066\u3044\u308b\u3002\u306f\u3058\u3081\u306bRDD[T]\u3092RDD[(T,null)]\u306b\u5909\u63db\u3059\u308b\u3002\uff08\u305d\u306e\u305f\u3081\u3001T\u306f\u30b3\u30ec\u30af\u30b7\u30e7\u30f3\u578b\u3067\u3042\u3063\u3066\u306f\u3044\u3051\u306a\u3044\uff09\u305d\u306e\u5f8c\u3001a.cogroup(b)\u3092\u5b9f\u884c\uff08\u9752\u3044\u90e8\u5206\uff09\u3059\u308b\u3002\u6b21\u306bFilter\u3092\u884c\u3044\u3001RDD a\u8d77\u6e90\u306e\u8981\u7d20\u3068RDD b\u8d77\u6e90\u306e\u8981\u7d20\u306e\u4e21\u65b9\u304c\u5b58\u5728\u3057\u3066\u3044\u306a\u3044\u8981\u7d20\u3092\u30d5\u30a3\u30eb\u30bf\u30ea\u30f3\u30b0\u3059\u308b\u3002\u6700\u7d42\u7684\u306b\u30ad\u30fc\u90e8\u5206\u306e\u307f\u3092\u62bd\u51fa\u3057\u305fMappedRDD\u306b\u5909\u63db\u3092\u884c\u3046\u3002\n\n**7) join(otherRDD, numPartitions)**\n\n![join.png](https://qiita-image-store.s3.amazonaws.com/0/9616/d1f92ec3-9383-6a2b-b9c0-465ee7128721.png)\n\njoin()\u306fKey\u5024\u3068Value\u5024\u3092\u4fdd\u6301\u3059\u308bRDD\uff08RDD[(K,V)]\uff09\u30922\u500b\u3082\u3061\u3044\u3066SQL\u306ejoin\u306e\u3088\u3046\u306b\u7d50\u5408\u3092\u884c\u3046\u3002\u51e6\u7406\u3068\u3057\u3066\u306fintersection()\u3068\u540c\u3058\u3088\u3046\u306b\u306f\u3058\u3081\u306bcogroup()\u51e6\u7406\u3092\u547c\u3073\u51fa\u3057\u3001\u5404\u8981\u7d20\u3092Iterable\u306b\u3057\u305fRDD[(K, (Iterable[V1],Iterable[V2]))]\u3092\u751f\u6210\u3059\u308b\u3002\u305d\u306e\u5f8c\u3001\u5404\u30ec\u30b3\u30fc\u30c9\u304c\u4fdd\u6301\u3059\u308b\u8981\u7d20\u306e\u76f4\u7a4d\u96c6\u5408\u3092flatMap()\u3092\u7528\u3044\u3066\u751f\u6210\u3059\u308b\u3002\n\n\u56f3\u4e2d\u3067\u306f2\u30d1\u30bf\u30fc\u30f3\u306e\u4f8b\u3092\u793a\u3057\u3066\u3044\u308b\u3002\n1\u500b\u76ee\u306e\u4f8b\u306fRDD 1\u3068RDD 2\u304cRangePartitioner\u3001CoGroupedRDD\u304cHashPartitioner\u3092\u4f7f\u7528\u3057\u3066\u3044\u308b\u305f\u3081\u3001\u5404Partition\u9593\u306e\u4f9d\u5b58\u304cShuffleDependency\u306b\u306a\u3063\u305f\u30d1\u30bf\u30fc\u30f3\u30022\u500b\u76ee\u306e\u4f8b\u304cRDD 1\u304cCoGroupedRDD\u3068\u540c\u4e00\u306ePartition\u6570\u3001Partitioner\u3060\u3063\u305f\u305f\u3081\u4f9d\u5b58\u304cOneToOneDependency\u3068\u306a\u3063\u305f\u30d1\u30bf\u30fc\u30f3\u3002\u3082\u3057\u4eee\u306bRDD 2\u3082\u540c\u4e00\u306ePartition\u6570\u3001Partitioner\u3060\u3063\u305f\u5834\u5408\u3001\u5168\u4f9d\u5b58\u304cOneToOneDependency\u3068\u306a\u308b\u3002\u3053\u306e\u3088\u3046\u306a\u30b1\u30fc\u30b9\u306eJoin\u306fhashjoin\u3068\u547c\u3070\u308c\u308b\u3002\n\n**8) sortByKey(ascending, numPartitions)**\n\n![sortByKey.png](https://qiita-image-store.s3.amazonaws.com/0/9616/85264a80-65b2-4a6c-7dfb-665182460347.png)\n\nsortByKey()\u306fRDD[(K,V)]\u5f62\u5f0f\u306eRDD\u3092Key\u5024\u3067\u30bd\u30fc\u30c8\u3059\u308b\u3002ascending\u306f\u5f53\u7136\u308f\u304b\u308b\u901a\u308aBoolean\u30d5\u30e9\u30b0\u3002sortByKey()\u306fRangePartitioner\u3067\u533a\u5207\u3063\u305fShuffledRDD\u3092\u751f\u6210\u3059\u308b\u3002RangePartitioner\u306fRDD\u4e2d\u306e\u5404Partition\u306e\u533a\u5207\u308a\u3092\u8a2d\u5b9a\u3059\u308b\u3002\u4f8b\u3048\u3070\u30011Partition\u76ee\u304cA-B\u30012Partition\u76ee\u304cC-D\u306e\u3088\u3046\u306b\u3002\u5404Partition\u5185\u3067\u306f\u30ec\u30b3\u30fc\u30c9\u306fKey\u5024\u306b\u3088\u3063\u3066\u30bd\u30fc\u30c8\u3055\u308c\u3066\u3044\u308b\u3002\u6700\u7d42\u7684\u306b\u3001\u30bd\u30fc\u30c8\u3055\u308c\u305f\u30ec\u30b3\u30fc\u30c9\u3092\u4fdd\u6301\u3057\u3066\u3044\u308bMapPartitionsRDD\u3092\u51fa\u529b\u3057\u3066\u3044\u308b\u3002\nsortByKey()\u306f\u5404\u30ec\u30b3\u30fc\u30c9\u3092Array\u3092\u7528\u3044\u3066\u30bd\u30fc\u30c8\u3092\u884c\u3046\u3002\n\n**9) cartesian(otherRDD)**\n\n![Cartesian.png](https://qiita-image-store.s3.amazonaws.com/0/9616/555809f8-1f5b-6cb0-d2cc-1649b3f193ef.png)\n\nCartesian()\u306f2\u500b\u306eRDD\u306e\u8981\u7d20\u540c\u58eb\u306e\u76f4\u7a4d\u96c6\u5408\u3092\u4fdd\u6301\u3059\u308bRDD\u3092\u8fd4\u3059\u3002\u51fa\u529b\u3055\u308c\u308bRDD\u306ePartition\u6570\u306f(RDD a\u306ePartition\u6570\uff09* (RDD b\u306ePartition\u6570\uff09\u3068\u306a\u308b\u3002\n\n\u4f9d\u5b58\u95a2\u4fc2\u3067\u6ce8\u610f\u3059\u308b\u3079\u304d\u3053\u3068\u3068\u3057\u3066\u3001\u7d50\u679c\u306e\u5404Partition\u306f2\u3064\u306e\u89aaRDD\u306e\u5168\u8981\u7d20\u306b\u4f9d\u5b58\u3057\u3066\u3044\u308b\u3002\u305d\u306e\u305f\u3081\u3001\u5168\u3066NarrowDependency\u306e\u69cb\u6210\u3068\u306a\u3063\u3066\u3044\u308b\u3002\n\n`CartesianRDD.getDependencies()` \u306frdds\u3068\u3057\u3066 `Array(RDD a, RDD b)` \u3092\u8fd4\u3059\u3002\n\u5c1a\u3001CartesianRDD\u306ei\u756a\u76ee\u306e\u4f9d\u5b58Partition\u306f\u4e0b\u8a18\u306e\u3088\u3046\u306b\u306a\u308b\u3002\n\n```scala\na.partitions(i / #partitionA)\nb.partitions(i % #partitionB)\n```\n\n**10) coalesce(numPartitions, shuffle = false)**\n\n![Coalesce.png](https://qiita-image-store.s3.amazonaws.com/0/9616/7fb095c1-503b-df24-552b-60e512bb22d7.png)\n\ncoalesce()\u306fPartition\u306e\u518d\u69cb\u6210\u3092\u884c\u3046\u3002\u4f8b\u3048\u3070\u3001Partition\u6570\u30925>3\u306b\u6e1b\u3089\u3057\u305f\u308a\u30015>10\u306b\u5897\u3084\u3057\u305f\u308a\u3059\u308b\u3053\u3068\u304c\u53ef\u80fd\u3002\n\u305f\u3060\u3057\u3001\u6ce8\u610f\u3059\u3079\u304d\u70b9\u3068\u3057\u3066\u306fshuffle\u3092false\u306b\u3057\u3066\u3044\u305f\u5834\u5408\u3001Partition\u6570\u3092\u5897\u3084\u3059\u3053\u3068\u306f\u51fa\u6765\u306a\u3044\u3002\u5fc5\u305aPartition\u6570\u5897\u52a0\u306b\u306fshuffle\u304c\u5fc5\u8981\u306b\u306a\u308b\u305f\u3081\u3002\n\ncoalesce()\u3092\u7406\u89e3\u3059\u308b\u305f\u3081\u306bCoalescedRDD\u306ePartition\u3068\u89aaPartition\u306e\u95a2\u4fc2\u3092\u77e5\u308b\u5fc5\u8981\u304c\u3042\u308b\u3002\n\ncoalesce(shuffle = false)\u306e\u30b1\u30fc\u30b9\u306e\u5834\u5408shuffle\u304c\u51fa\u6765\u306a\u3044\u305f\u3081\u3001\u5358\u7d14\u306bRDD\u4e2d\u306ePartition\u3092\u30de\u30fc\u30b8\u3059\u308b\u306e\u307f\u3067\u3001\u5b50Partition\u306f\u89aaParition\u306e\u5168\u8981\u7d20\u306b\u5bfe\u3057\u3048\u4f9d\u5b58\u3059\u308b\u3002\u5b9f\u969b\u306e\u6240\u3001Partition\u306e\u6709\u52b9\u306a\u30b0\u30eb\u30fc\u30d7\u5316\u306b\u3064\u3044\u3066\u306f\u591a\u304f\u306e\u8981\u7d20\u3084\u8003\u3048\u308b\u3053\u3068\u304c\u3042\u308b\u3002\u4f8b\u3048\u3070\u3001Partition\u6570\u306e\u4fdd\u6301\u3059\u308b\u30ec\u30b3\u30fc\u30c9\u6570\u3001\u5c40\u6240\u6027\u3001Partition\u9593\u306e\u30d0\u30e9\u30f3\u30b9\u7b49\u3002\u3053\u308c\u3089\u3092\u9054\u6210\u3059\u308b\u305f\u3081\u306bSpark\u306f\u8907\u96d1\u306a\u30a2\u30eb\u30b4\u30ea\u30ba\u30e0\u3092\u4fdd\u6301\u3057\u3066\u3044\u308b\u3002\uff08\u3053\u3053\u3067\u306f\u8aac\u660e\u3057\u306a\u3044\u304c\uff09\n\ncoalesce(shuffle = true)\u3068\u3057\u3066shuffle\u304c\u6709\u52b9\u5316\u3055\u308c\u3066\u3044\u308b\u5834\u5408\u3001coalesce\u306f\u5358\u7d14\u306bRDD\u306e\u5168\u30ec\u30b3\u30fc\u30c9\u3092\u7d50\u679c\u3067\u3042\u308bN\u500b\u306ePartition\u306b\u4e0b\u8a18\u306e\u3088\u3046\u306b\u3057\u3066\u5206\u5272\u3059\u308b\uff08\u30e9\u30a6\u30f3\u30c9\u30ed\u30d3\u30f3\u306e\u3088\u3046\u306a\u30a2\u30eb\u30b4\u30ea\u30ba\u30e0\u3068\u306a\u3063\u3066\u3044\u308b\u3002\uff09\n\n\u5404Pertition\u4e2d\u306e\u5168\u30ec\u30b3\u30fc\u30c9\u306b\u5bfe\u3057\u3066\u5897\u52a0\u3059\u308b\u6570\u5024\u3092\u30ad\u30fc\u3068\u3057\u3066\u5272\u308a\u632f\u308b\u3002\n\u5272\u308a\u632f\u3063\u305f\u30ad\u30fc\u3092HashPartitioner\u3067\u5206\u5272\u3059\u308b\u3068\u5404\u30ec\u30b3\u30fc\u30c9\u304c\u7570\u306a\u308bPartition\u306b\u5747\u7b49\u306b\u5272\u308a\u632f\u3089\u308c\u308b\u3002\n\u56f3\u4e2d\u306e2\u756a\u76ee\u306e\u4f8b\u306b\u304a\u3044\u3066\u306fMapPartitionRDD\u306e\u5de6\u5074\u306e\u8981\u7d20\u304c\u5272\u308a\u632f\u3063\u305f\u30ad\u30fc\u3068\u306a\u3063\u3066\u3044\u308b\u3002\u5272\u308a\u632f\u3089\u308c\u308b\u30ad\u30fc\u306e\u521d\u671f\u5024\u306f `(new Random(index)).nextInt(numPartitions)` \u3067\u7b97\u51fa\u3055\u308c\u308b\u3002\u3053\u3053\u3067index\u306f\u5143\u306eRDD\u3067\u306ePartition\u306e\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u756a\u53f7\u3001numPartitions\u306fCoalescedRDD\u306ePartition\u6570\u3068\u306a\u3063\u3066\u3044\u308b\u3002\u30ad\u30fc\u306f1\u305a\u3064\u5897\u52a0\u3055\u305b\u3066\u5272\u308a\u632f\u308b\u3002Shuffle\u5f8c\u3001ShffledRDD\u306e\u5404\u30ec\u30b3\u30fc\u30c9\u306f\u5747\u7b49\u306b\u5206\u6563\u3055\u308c\u3066\u3044\u308b\u3002\u6700\u7d42\u7684\u306b\u30ad\u30fc\u306f\u9664\u53bb\u3055\u308c\u3066\u5143\u306e\u5024\u306b\u623b\u3055\u308c\u308b\u3002\n\n**11) repartition(numPartitions)**\n\n\u4e2d\u8eab\u306fcoalesce(numPartitions, shuffle = true)\u3068\u540c\u4e00\u3002\n\n### \u5171\u901a\u7684\u306a\u57fa\u672c\u51e6\u7406\n**combineByKey()**\n\n\u3053\u308c\u307e\u3067\u8907\u6570\u306eLogicalPlan\u306b\u3064\u3044\u3066\u307f\u3066\u304d\u305f\u304c\u3001\u3044\u304f\u3064\u304b\u306e\u3082\u306e\u306f\u975e\u5e38\u306b\u4f3c\u901a\u3063\u3066\u3044\u308b\u3002\u305d\u308c\u306f\u7686\u540c\u3058shuffle + aggregate\u306e\u3075\u308b\u307e\u3044\u3092\u6301\u3064\u305f\u3081\u3067\u3042\u308b\u3002\n\ntransform\u5b9f\u884c\u6642\u306bShuffleDependency\u306e\u57fa\u3068\u306a\u308bRDD\u306fRDD[(K,V)]\u3068\u306a\u308a\u3001\u5909\u63db\u5f8c\u306eRDD\u306b\u304a\u3044\u3066\u540c\u3058\u30ad\u30fc\u3092\u7528\u3044\u3066\u7d71\u5408\u3059\u308b\u969b\u306b\u7570\u306a\u308b\u30a2\u30eb\u30b4\u30ea\u30ba\u30e0\u3092\u7528\u3044\u3066\u884c\u3046\u3068\u3044\u3046\u5dee\u5206\u304c\u3042\u308b\u306e\u307f\u3068\u306a\u3063\u3066\u3044\u308b\u3002\n\n\u5b9f\u969b\u3001\u8907\u6570\u306etransformation()\uff08\u4f8b\u3048\u3070groupByKey()\u3001reduceBykey()\uff09\u3067\u306f\u8ad6\u7406\u7684\u306b\u540c\u3058\u30bf\u30a4\u30df\u30f3\u30b0\u3067aggregate\u3092\u5b9f\u884c\u3057\u3066\u3044\u308b\u3002\u305d\u306e\u305f\u3081\u3001\u5171\u901a\u70b9\u306faggregate()\u3068compute()\u3092\u540c\u6642\u306b\u5b9f\u884c\u3059\u308b\u3053\u3068\u304b\u3089\u304f\u308b\u3002Spark\u3067\u306fcombineByKey()\u3092 to aggregate() + compute()\u306e\u51e6\u7406\u306e\u5b9f\u88c5\u3068\u3057\u3066\u7528\u3044\u3066\u3044\u308b\u3002\n\ncombineByKey()\u306e\u5b9a\u7fa9\u306f\u4e0b\u8a18\u306e\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u308b\u3002\n\n```scala\n def combineByKey[C](createCombiner: V => C,\n      mergeValue: (C, V) => C,\n      mergeCombiners: (C, C) => C,\n      partitioner: Partitioner,\n      mapSideCombine: Boolean = true,\n      serializer: Serializer = null): RDD[(K, C)]\n```\n\n\u4e0a\u8a18\u306e\u30b3\u30fc\u30c9\u306e\u4e2d\u306b\u306f3\u500b\u306e\u91cd\u8981\u306a\u30d1\u30e9\u30e1\u30fc\u30bf\u304c\u3042\u308b\u3002\n\n- createCombiner, \u5404Value\u3092\u7d50\u5408\uff08\u4f8b\u3048\u30701\u500b\u76ee\u306e\u8981\u7d20\u3092\u5358\u4e00\u8981\u7d20\u306e\u30ea\u30b9\u30c8\u3068\u3057\u3066\u7d50\u5408\u53ef\u80fd\u306a\u3082\u306e\u306b\u5909\u63db\uff09\n- mergeValue, \u5404Value\u5024\u3068\u7d50\u5408\u6e08\u307f\u306e\u5024\u3092\u7d50\u5408\uff08\u4f8b\u3048\u3070\u30ea\u30b9\u30c8\u306b\u5bfe\u3057\u3066\u5024\u3092\u8ffd\u52a0\uff09\n- mergeCombiners, \u7d50\u5408\u6e08\u307f\u306e\u5024\u3092\u7d50\u5408\uff08\u4f8b\u3048\u3070\u30ea\u30b9\u30c8\u540c\u58eb\u30921\u3064\u306e\u30ea\u30b9\u30c8\u306b\u7d50\u5408\uff09\n\n\u4e0a\u8a18\u306e\u30d1\u30e9\u30e1\u30fc\u30bf\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u7528\u3044\u3089\u308c\u308b\u3002\n\n(K, V)\u306e\u5024\u3092\u4fdd\u6301\u3059\u308b\u30ec\u30b3\u30fc\u30c9\u7fa4\u304ccombineByKey()\u306b\u6e21\u3055\u308c\u305f\u5834\u5408\u3001\u6700\u521d\u306e\u8981\u7d20\u3092createCombiner\u3092\u7528\u3044\u3066\u30ea\u30b9\u30c8\u5316\u3059\u308b\u3002\n2\u500b\u76ee\u4ee5\u964d\u306e\u5024\u306fmergeValue\u3092\u4f7f\u7528\u3057\u3066\u30ea\u30b9\u30c8\u5316\u3057\u305f\u8981\u7d20\u306b\u5bfe\u3057\u30661\u500b\u305a\u3064\u8ffd\u52a0\u3057\u3066\u3044\u304f\u3002\nsum\u3092\u4f8b\u3068\u3057\u3066\u8003\u3048\u3066\u307f\u308b\u3068\u3001mergeValue\u306f `combiner = combiner + record` \u3068\u3057\u3066\u793a\u305b\u308b\u3002\n\u3053\u306e\u3088\u3046\u306b\u3057\u3066\u3001\u5168\u3066\u306e\u30ec\u30b3\u30fc\u30c9\u30921\u500b\u306e\u5024\u306b\u30de\u30fc\u30b8\u3057\u3066\u3044\u304f\u3002\n\n\u3082\u3057\u7570\u306a\u308b\u30ad\u30fc\u3092\u6301\u3064\u30ec\u30b3\u30fc\u30c9\u304c\u6295\u5165\u3055\u308c\u305f\u5834\u5408\u3001combineByKey()\u306fcreateCombiner\u3092\u7528\u3044\u3066\u518d\u5ea6\u7570\u306a\u308bcombiner\u3092\u751f\u6210\u3059\u308b\u3002\u6700\u7d42\u7684\u306a\u7d50\u679c\u306f\u30de\u30fc\u30b8\u3055\u308c\u305f\u5024\u540c\u58eb\u3092mergeCombiners\u3092\u7528\u3044\u3066\u30de\u30fc\u30b8\u3059\u308b\u3053\u3068\u3067\u751f\u6210\u3055\u308c\u308b\u3002\n\n### Conclusion\n\n\u3053\u3053\u307e\u3067\u3067\u3001\u30b8\u30e7\u30d6\u4e2d\u306eLogicalPlan\u304c\u3069\u306e\u3088\u3046\u306bSpark\u306b\u304a\u3044\u3066Partition\u306b\u5206\u5272\u3055\u308c\u3001\u4f9d\u5b58\u6027\u3092\u95a2\u9023\u4ed8\u3051\u3066\u51e6\u7406\u3055\u308c\u308b\u304b\u306b\u3064\u3044\u3066\u8ff0\u3079\u3066\u304d\u305f\u3002\n\ntranformation()\u306b\u3088\u3063\u3066\u3069\u306e\u3088\u3046\u306aRDD\u304c\u751f\u6210\u3055\u308c\u308b\u304b\u6c7a\u307e\u308a\u3001\u4e00\u90e8\u306etranformation()\u3067\u306f\u4ed6\u306etranformation()\u3092\u518d\u5ea6\u5229\u7528\u3057\u3066\u3044\u308b\u3082\u306e\u3082\u3042\u3063\u305f\u3002\uff08\u4f8b\u3048\u3070cogroup)\n\nRDD\u9593\u306e\u4f9d\u5b58\u306ftranformation()\u306e\u30bb\u30de\u30f3\u30c6\u30a3\u30af\u30b9\u306b\u4f9d\u5b58\u3057\u3066\u3044\u308b\u3002\u4f8b\u3048\u3070\u3001cogroup()\u3067\u751f\u6210\u3055\u308c\u308bCoGroupdRDD\u304c\u3069\u306e\u3088\u3046\u306a\u4f9d\u5b58\u69cb\u6210\u3092\u53d6\u308b\u304b\u3001\u7b49\u3002\n\nRDD\u4e2d\u306ePartition\u9593\u306e\u95a2\u9023\u306fNarrowDependency\u3068ShuffleDependency\u3067\u793a\u3055\u308c\u308b\u3002\n\u524d\u8005\u306fFullDependency\u3067\u5f8c\u8005\u306fPartialDependency\u3068\u306a\u308b\u3002\n\u4f9d\u5b58\u6027\u306ftransformation()\u4e2d\u306e\u30d1\u30e9\u30e1\u30fc\u30bf\u6b21\u7b2c\u3067\u5909\u5316\u3059\u308b\u30b1\u30fc\u30b9\u3082\u3042\u3063\u305f\u3002\u4f8b\u3048\u3070\u3001RDD\u306ePartition\u6570\u3068Partitioner\u304c\u7b49\u3057\u3044\u5834\u5408\u306e\u307fNarrowDependency\u306b\u306a\u308b\u7b49\n\n\u30c7\u30fc\u30bf\u30d5\u30ed\u30fc\u306e\u8996\u70b9\u3067\u8a00\u3048\u3070\u3001MapReduce\u306fmap() + reduceByKey()\u3068\u3044\u3046\u30e2\u30c7\u30eb\u3068\u306a\u308b\u3002\u53b3\u5bc6\u306b\u8a00\u3048\u3070MapReduce\u306ereduce()reduceByKey()\u3088\u308a\u9ad8\u6a5f\u80fd\u3067\u306f\u3042\u308b\u304c\u3002\nShuffle\u306e\u8a2d\u8a08\u5b9f\u88c5\u306e\u8a73\u7d30\u306b\u3064\u3044\u3066\u306f\u4eca\u5f8c\u306e\u7ae0\u3067\u8a18\u8ff0\u3059\u308b\u3002\n\n# \u307e\u3068\u3081\nSparkInternals\u306e\u306f\u3058\u3081\u306e2\u7ae0\u3092\u8aad\u3093\u3067\u307f\u307e\u3057\u305f\u304c\u3001\u8aad\u3080\u3054\u3068\u306b\u3069\u306e\u3088\u3046\u306b\u52d5\u3044\u3066\u3044\u308b\u304b\u306e\u6982\u8981\u304c\u898b\u3048\u3066\u304d\u307e\u3059\u306d\u3002\n\u7279\u306b2\u7ae0\u306eRDD\u306b\u5bfe\u3059\u308bTransformation\u306b\u3064\u3044\u3066\u306f\u308f\u304b\u3063\u3066\u3044\u308b\u304b\u3044\u306a\u3044\u304b\u3067\u7406\u89e3\u306b\u5927\u304d\u306a\u9055\u3044\u304c\u51fa\u3066\u304f\u308b\u306e\u3067\u306f\u306a\u3044\u304b\u3068\u601d\u3044\u307e\u3059\u3002\n\u3055\u3059\u304c\u306b7\u7ae0\u5168\u3066\u30921\u6295\u7a3f\u306b\u307e\u3068\u3081\u308b\u306e\u306f\u7121\u7406\u3067\u3057\u305f\u304c\u3001\u3053\u3053\u307e\u3067\u3067\u3082\u30c7\u30fc\u30bf\u30d5\u30ed\u30fc\u306e\u30a4\u30e1\u30fc\u30b8\u306f1\u6bb5\u968e\u306f\u51fa\u6765\u308b\u3088\u3046\u306b\u306a\u308b\u304b\u3068\u3002\n\n\u3053\u308c\u304b\u3089\u5e74\u672b\u306b\u5165\u3063\u3066\u3044\u304f\u306e\u3067\u3001\u6298\u3092\u898b\u3066\u7d9a\u304d\u3082\u8a33\u3057\u3066\u307f\u3088\u3046\u3068\u601d\u3044\u307e\u3059\u304c\u3001\u3072\u3068\u307e\u305a\u4eca\u56de\u306f\u3053\u3053\u307e\u3067\u3067\u3059\u3002\n\u305d\u308c\u3067\u306f\u3001\u7686\u3055\u3093\u3001\u826f\u3044\u5e74\u672b\u3092\uff01\n"}