{"context": " More than 1 year has passed since last update.\n\nTSV\u5f62\u5f0f\u3067S3\u306b\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u3055\u308c\u305fGZ\u30d5\u30a1\u30a4\u30eb\u306e\u6d41\u3057\u8fbc\u307f\nCopy\u3092\u4f7f\u3046\ncopy \u30c6\u30fc\u30d6\u30eb\u540d (\u30ab\u30e9\u30e01,\u30ab\u30e9\u30e02,\u30ab\u30e9\u30e03,...)\nfrom 's3://\u30d0\u30b1\u30c3\u30c8\u540d/path/to/\u30d5\u30a1\u30a4\u30eb\u540d'\ncredentials 'aws_access_key_id=\u30a2\u30af\u30bb\u30b9\u30ad\u30fc'\nGZIP\ndelimiter '\\t';\n\n\nRedshift\u30c7\u30fc\u30bf\u306eTSV\u5f62\u5f0f\u306eGZ\u30d5\u30a1\u30a4\u30eb\u306eS3\u3078\u306e\u30a8\u30af\u30b9\u30dd\u30fc\u30c8\nUNLOAD\u3092\u4f7f\u3046\nunload ('\nselect \u30ab\u30e9\u30e01,\u30ab\u30e9\u30e02,\u30ab\u30e9\u30e0\nfrom \u30c6\u30fc\u30d6\u30eb\u540d\nwhere ...\n')\nto 's3://\u30d0\u30b1\u30c3\u30c8\u540d/path/to/\u30d5\u30a1\u30a4\u30eb\u540d'\ncredentials 'aws_access_key_id=\u30a2\u30af\u30bb\u30b9\u30ad\u30fc'\nGZIP\ndelimiter as '\\t';\n\n\nRedshift\u306e\u30b9\u30c8\u30ec\u30fc\u30b8\u4f7f\u7528\u5bb9\u91cf\n\u51fa\u5178: \u516c\u5f0f\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\nselect stv_tbl_perm.name as table, count(*) as mb\nfrom stv_blocklist, stv_tbl_perm\nwhere stv_blocklist.tbl = stv_tbl_perm.id\nand stv_blocklist.slice = stv_tbl_perm.slice\nand stv_tbl_perm.name in ('client_analytics_traffic','client_analytics_reference','client_analytics_traffic_by_page_group','client_analytics_reference_by_page_group','client_site_search_ranking','conflict_site_search_ranking','client_site_findability_score','conflict_site_findability_score')\ngroup by stv_tbl_perm.name\norder by 1 asc;\n\n\n\u30bd\u30fc\u30c8\u72b6\u6cc1\u306e\u78ba\u8a8d\u30af\u30a8\u30ea\n\u51fa\u5178: Amazon Redshift Useful SQL: VACUUM\u51e6\u7406\u304c\u5fc5\u8981\u306a\u30c6\u30fc\u30d6\u30eb\u3092\u6d17\u3044\u51fa\u3059\n/** 0.VACUUM\u51e6\u7406\u304c\u884c\u308f\u308c\u3066\u3044\u306a\u3044\u30c6\u30fc\u30d6\u30eb\u7fa4 */\nselect\n  '0_not_sorted' as status,\n  sum_result.tablename,\n  sum_result.sorted_rows,\n  sum_result.rows,\n  cast(0 as decimal(5,3)) as sort_percentage\nfrom\n(select\n  trim(name) as tablename,\n  sum(sorted_rows) as sorted_rows,\n  sum(rows) as rows\nfrom\n  stv_tbl_perm\ngroup by name\norder by name) sum_result\nwhere\n  sorted_rows = 0\nUNION ALL\n/** 1.VACUUM\u51e6\u7406\u304c\u884c\u308f\u308c\u3066\u3044\u308b\u30c6\u30fc\u30d6\u30eb\u7fa4 */\nselect\n  '1_sorted' as status,\n  sum_result.tablename,\n  sum_result.sorted_rows,\n  sum_result.rows,\n  cast(\n    cast(sum_result.sorted_rows as double precision) / cast(sum_result.rows as double precision)\n    as decimal(5,3)\n  ) as sort_percentage\nfrom\n(select\n  trim(name) as tablename,\n  sum(sorted_rows) as sorted_rows,\n  sum(rows) as rows\nfrom\n  stv_tbl_perm\ngroup by name\norder by name) sum_result\nwhere\n  sorted_rows != 0\norder by\n  status asc,\n  sort_percentage asc,\n  rows desc;\n\n\n\u30c6\u30fc\u30d6\u30eb\u5b9a\u7fa9\u306e\u78ba\u8a8d\n\u51fa\u5178: Redshift\u306e\u8abf\u67fb\u7cfb\u30af\u30a8\u30ea3\u9078\nSELECT * FROM pg_table_def WHERE tablename = '\u30c6\u30fc\u30d6\u30eb\u540d';\n\n## TSV\u5f62\u5f0f\u3067S3\u306b\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u3055\u308c\u305fGZ\u30d5\u30a1\u30a4\u30eb\u306e\u6d41\u3057\u8fbc\u307f\nCopy\u3092\u4f7f\u3046\n\n```\ncopy \u30c6\u30fc\u30d6\u30eb\u540d (\u30ab\u30e9\u30e01,\u30ab\u30e9\u30e02,\u30ab\u30e9\u30e03,...)\nfrom 's3://\u30d0\u30b1\u30c3\u30c8\u540d/path/to/\u30d5\u30a1\u30a4\u30eb\u540d'\ncredentials 'aws_access_key_id=\u30a2\u30af\u30bb\u30b9\u30ad\u30fc'\nGZIP\ndelimiter '\\t';\n```\n\n## Redshift\u30c7\u30fc\u30bf\u306eTSV\u5f62\u5f0f\u306eGZ\u30d5\u30a1\u30a4\u30eb\u306eS3\u3078\u306e\u30a8\u30af\u30b9\u30dd\u30fc\u30c8\nUNLOAD\u3092\u4f7f\u3046\n\n```\nunload ('\nselect \u30ab\u30e9\u30e01,\u30ab\u30e9\u30e02,\u30ab\u30e9\u30e0\nfrom \u30c6\u30fc\u30d6\u30eb\u540d\nwhere ...\n')\nto 's3://\u30d0\u30b1\u30c3\u30c8\u540d/path/to/\u30d5\u30a1\u30a4\u30eb\u540d'\ncredentials 'aws_access_key_id=\u30a2\u30af\u30bb\u30b9\u30ad\u30fc'\nGZIP\ndelimiter as '\\t';\n```\n\n## Redshift\u306e\u30b9\u30c8\u30ec\u30fc\u30b8\u4f7f\u7528\u5bb9\u91cf\n\u51fa\u5178: [\u516c\u5f0f\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8](http://docs.aws.amazon.com/ja_jp/redshift/latest/dg/tutorial-tuning-tables-test-performance.html)\n\n```\nselect stv_tbl_perm.name as table, count(*) as mb\nfrom stv_blocklist, stv_tbl_perm\nwhere stv_blocklist.tbl = stv_tbl_perm.id\nand stv_blocklist.slice = stv_tbl_perm.slice\nand stv_tbl_perm.name in ('client_analytics_traffic','client_analytics_reference','client_analytics_traffic_by_page_group','client_analytics_reference_by_page_group','client_site_search_ranking','conflict_site_search_ranking','client_site_findability_score','conflict_site_findability_score')\ngroup by stv_tbl_perm.name\norder by 1 asc;\n```\n\n## \u30bd\u30fc\u30c8\u72b6\u6cc1\u306e\u78ba\u8a8d\u30af\u30a8\u30ea\n\u51fa\u5178: [Amazon Redshift Useful SQL: VACUUM\u51e6\u7406\u304c\u5fc5\u8981\u306a\u30c6\u30fc\u30d6\u30eb\u3092\u6d17\u3044\u51fa\u3059](http://dev.classmethod.jp/cloud/aws/amazon-redshift-useful-sql-require-tables-to-vacuum/)\n\n```\n/** 0.VACUUM\u51e6\u7406\u304c\u884c\u308f\u308c\u3066\u3044\u306a\u3044\u30c6\u30fc\u30d6\u30eb\u7fa4 */\nselect\n  '0_not_sorted' as status,\n  sum_result.tablename,\n  sum_result.sorted_rows,\n  sum_result.rows,\n  cast(0 as decimal(5,3)) as sort_percentage\nfrom\n(select\n  trim(name) as tablename,\n  sum(sorted_rows) as sorted_rows,\n  sum(rows) as rows\nfrom\n  stv_tbl_perm\ngroup by name\norder by name) sum_result\nwhere\n  sorted_rows = 0\nUNION ALL\n/** 1.VACUUM\u51e6\u7406\u304c\u884c\u308f\u308c\u3066\u3044\u308b\u30c6\u30fc\u30d6\u30eb\u7fa4 */\nselect\n  '1_sorted' as status,\n  sum_result.tablename,\n  sum_result.sorted_rows,\n  sum_result.rows,\n  cast(\n    cast(sum_result.sorted_rows as double precision) / cast(sum_result.rows as double precision)\n    as decimal(5,3)\n  ) as sort_percentage\nfrom\n(select\n  trim(name) as tablename,\n  sum(sorted_rows) as sorted_rows,\n  sum(rows) as rows\nfrom\n  stv_tbl_perm\ngroup by name\norder by name) sum_result\nwhere\n  sorted_rows != 0\norder by\n  status asc,\n  sort_percentage asc,\n  rows desc;\n```\n\n## \u30c6\u30fc\u30d6\u30eb\u5b9a\u7fa9\u306e\u78ba\u8a8d\n\u51fa\u5178: [Redshift\u306e\u8abf\u67fb\u7cfb\u30af\u30a8\u30ea3\u9078](https://librabuch.jp/2013/10/redshift_system_query/)\n\n```\nSELECT * FROM pg_table_def WHERE tablename = '\u30c6\u30fc\u30d6\u30eb\u540d';\n```\n", "tags": ["redshift", "AWS"]}