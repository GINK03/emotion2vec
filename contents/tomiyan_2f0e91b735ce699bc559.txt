{"context": "API Gateway\u3001Cognito\u3001IAM\u306e\u8a2d\u5b9a\u306f\u30af\u30e9\u30b9\u30e1\u30bd\u30c3\u30c9\u3055\u3093\u306e\u300eAmazon API Gateway \u306e API \u3092 Cognito \u3067\u8a8d\u8a3c\u3057\u3066\u547c\u3073\u51fa\u3059\u300f\u3092\u53c2\u8003\u306b\u3057\u3066\u304f\u3060\u3055\u3044\n\n\u691c\u8a3c\u30d0\u30fc\u30b8\u30e7\u30f3\n\nNode.js 0.10.41\nnpm\n\n\naws-sdk 2.4.4\naws4 1.41\n\n\n\n\n\u30bd\u30fc\u30b9\u30b3\u30fc\u30c9\nAWS\u306eregion\u3001Cognito\u306eIdentityPoolId\u3001API Gateway\u306ehostname\u3001path\u306f\u74b0\u5883\u306b\u5fdc\u3058\u3066\u5909\u66f4\u3057\u3066\u304f\u3060\u3055\u3044\nvar https = require('https')\n  , aws4 = require('aws4')\n  , AWS = require('aws-sdk')\n  , region = 'ap-northeast-1'\n  ;\n\nvar cognitoOptions = {\n  IdentityPoolId: 'YOUR_COGNITO_IDENTITY_POOL_ID'\n};\nvar httpOptions = {\n  service: 'execute-api',\n  region: region,\n  hostname: 'YOUR_API_ID.execute-api.ap-northeast-1.amazonaws.com',\n  path: '/prod/resorucePath',\n  method: 'GET'\n};\n\ngetCredentials(cognitoOptions, function (error, credentials) {\n  request(httpOptions, credentials, function (error, body) {\n    console.log('body: ', body);\n  });\n});\n\nfunction getCredentials(options, done) {\n  AWS.config.region = region;\n  var cognitoidentity = new AWS.CognitoIdentity();\n  cognitoidentity.getId(options, function (err, objectHavingIdentityId) {\n    if (err) return done(err);\n    cognitoidentity.getCredentialsForIdentity(objectHavingIdentityId, function (err, data) {\n      if (err) return done(err);\n      var credentials = {\n        accessKeyId: data.Credentials.AccessKeyId,\n        secretAccessKey: data.Credentials.SecretKey,\n        sessionToken: data.Credentials.SessionToken\n      };\n      done(null, credentials);\n    });\n  });\n}\n\nfunction request(options, credentials, done) {\n  var signedOptions = aws4.sign(options, credentials);\n  var req = https.request(signedOptions, function (res) {\n    var body = '';\n    console.log('statusCode: ', res.statusCode);\n    console.log('headers: ', res.headers);\n    res.setEncoding('utf8');\n    res.on('data', function (chunk) {\n      body += chunk;\n    });\n    res.on('end', function (res) {\n      done(null, body);\n    });\n  });\n  req.on('error', function (error) {\n    done(error);\n  });\n  req.end();\n}\n\n\n\u5b9f\u884c\u7d50\u679c\nstatusCode:  200\nheaders:  { 'content-type': 'application/json',\n  'content-length': '6',\n  connection: 'keep-alive',\n  date: 'Sat, 02 Jul 2016 00:42:07 GMT',\n  'access-control-allow-origin': '*',\n  'x-amzn-requestid': 'cd98a1d5-3fed-11e6-b0fe-e73602f4978c',\n  'x-cache': 'Miss from cloudfront',\n  via: '1.1 7f150809b0d3f0320b40d49f5756b015.cloudfront.net (CloudFront)',\n  'x-amz-cf-id': 'CEebYad9DSFzmLrsPKwxLyCaGhgSXr4z4VniqNr9oJzVcXo9DuFzrQ==' }\nbody:  \"hoge\"\n\n\n\u53c2\u8003\u8cc7\u6599\n\nAmazon API Gateway \u306e API \u3092 Cognito \u3067\u8a8d\u8a3c\u3057\u3066\u547c\u3073\u51fa\u3059\nAWS IoT\u306eMQTT over WebSocket\u3092Cognito\uff08Unauth\uff09\u3067\u8a8d\u8a3c\u3057\u3066\u4f7f\u3063\u3066\u307f\u305f\nhttps://github.com/mhart/aws4/issues/16\n\n\nAPI Gateway\u3001Cognito\u3001IAM\u306e\u8a2d\u5b9a\u306f\u30af\u30e9\u30b9\u30e1\u30bd\u30c3\u30c9\u3055\u3093\u306e[\u300eAmazon API Gateway \u306e API \u3092 Cognito \u3067\u8a8d\u8a3c\u3057\u3066\u547c\u3073\u51fa\u3059\u300f](http://dev.classmethod.jp/cloud/aws/api-gateway-cognito-auth/)\u3092\u53c2\u8003\u306b\u3057\u3066\u304f\u3060\u3055\u3044\n\n# \u691c\u8a3c\u30d0\u30fc\u30b8\u30e7\u30f3\n* Node.js 0.10.41\n* npm\n\t* aws-sdk 2.4.4\n\t* aws4 1.41\n\n# \u30bd\u30fc\u30b9\u30b3\u30fc\u30c9\nAWS\u306eregion\u3001Cognito\u306eIdentityPoolId\u3001API Gateway\u306ehostname\u3001path\u306f\u74b0\u5883\u306b\u5fdc\u3058\u3066\u5909\u66f4\u3057\u3066\u304f\u3060\u3055\u3044\n\n```javascript\nvar https = require('https')\n  , aws4 = require('aws4')\n  , AWS = require('aws-sdk')\n  , region = 'ap-northeast-1'\n  ;\n\nvar cognitoOptions = {\n  IdentityPoolId: 'YOUR_COGNITO_IDENTITY_POOL_ID'\n};\nvar httpOptions = {\n  service: 'execute-api',\n  region: region,\n  hostname: 'YOUR_API_ID.execute-api.ap-northeast-1.amazonaws.com',\n  path: '/prod/resorucePath',\n  method: 'GET'\n};\n\ngetCredentials(cognitoOptions, function (error, credentials) {\n  request(httpOptions, credentials, function (error, body) {\n    console.log('body: ', body);\n  });\n});\n\nfunction getCredentials(options, done) {\n  AWS.config.region = region;\n  var cognitoidentity = new AWS.CognitoIdentity();\n  cognitoidentity.getId(options, function (err, objectHavingIdentityId) {\n    if (err) return done(err);\n    cognitoidentity.getCredentialsForIdentity(objectHavingIdentityId, function (err, data) {\n      if (err) return done(err);\n      var credentials = {\n        accessKeyId: data.Credentials.AccessKeyId,\n        secretAccessKey: data.Credentials.SecretKey,\n        sessionToken: data.Credentials.SessionToken\n      };\n      done(null, credentials);\n    });\n  });\n}\n\nfunction request(options, credentials, done) {\n  var signedOptions = aws4.sign(options, credentials);\n  var req = https.request(signedOptions, function (res) {\n    var body = '';\n    console.log('statusCode: ', res.statusCode);\n    console.log('headers: ', res.headers);\n    res.setEncoding('utf8');\n    res.on('data', function (chunk) {\n      body += chunk;\n    });\n    res.on('end', function (res) {\n      done(null, body);\n    });\n  });\n  req.on('error', function (error) {\n    done(error);\n  });\n  req.end();\n}\n```\n\n# \u5b9f\u884c\u7d50\u679c\n\n```bash\nstatusCode:  200\nheaders:  { 'content-type': 'application/json',\n  'content-length': '6',\n  connection: 'keep-alive',\n  date: 'Sat, 02 Jul 2016 00:42:07 GMT',\n  'access-control-allow-origin': '*',\n  'x-amzn-requestid': 'cd98a1d5-3fed-11e6-b0fe-e73602f4978c',\n  'x-cache': 'Miss from cloudfront',\n  via: '1.1 7f150809b0d3f0320b40d49f5756b015.cloudfront.net (CloudFront)',\n  'x-amz-cf-id': 'CEebYad9DSFzmLrsPKwxLyCaGhgSXr4z4VniqNr9oJzVcXo9DuFzrQ==' }\nbody:  \"hoge\"\n```\n\n# \u53c2\u8003\u8cc7\u6599\n* [Amazon API Gateway \u306e API \u3092 Cognito \u3067\u8a8d\u8a3c\u3057\u3066\u547c\u3073\u51fa\u3059](http://dev.classmethod.jp/cloud/aws/api-gateway-cognito-auth/)\n* [AWS IoT\u306eMQTT over WebSocket\u3092Cognito\uff08Unauth\uff09\u3067\u8a8d\u8a3c\u3057\u3066\u4f7f\u3063\u3066\u307f\u305f](http://dev.classmethod.jp/cloud/aws/aws-iot-mqtt-over-websocket-cognito-identity-unatuh/)\n* https://github.com/mhart/aws4/issues/16\n", "tags": ["Node.js", "cognito", "APIGateway", "AWS"]}