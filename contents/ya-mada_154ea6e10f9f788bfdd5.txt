{"context": "\n\n\u306f\u3058\u3081\u306b\n\u30cd\u30c3\u30c8\u306bcognito\u306etoken\u5229\u7528\u306b\u95a2\u3057\u3066\u307e\u3068\u307e\u3063\u305f\u60c5\u5831\u304c\u306a\u3044\u306e\u3067\u5099\u5fd8\u7684\u306b\u307e\u3068\u3081\u3066\u307f\u307e\u3059\n\ncognito\u306b\u304a\u3051\u308btoken\u306e\u6271\u3044\ncognito\u306etoken\u306fJWT\u306e\u30d5\u30a9\u30fc\u30de\u30c3\u30c8\u306b\u5247\u3063\u3066\u304a\u308a\u3001token\u5229\u7528\u6642\u306f\u7f72\u540d\u78ba\u8a8d\u304c\u7fa9\u52d9\u4ed8\u3051\u3089\u308c\u3066\u3044\u307e\u3059\u3002\n\u203bJWT\u306e\u30d5\u30a9\u30fc\u30de\u30c3\u30c8\u306e\u8aac\u660e\u306f\u30cd\u30c3\u30c8\u3092\u63a2\u305b\u3070\u51fa\u3066\u304f\u308b\u306e\u3067\u5272\u611b\u3057\u307e\u3059\u3002\n\u305d\u3053\u3067\u3001token\u4f7f\u7528\u6642\u306e\u7f72\u540d\u78ba\u8a8d\u624b\u9806\u3092amazon\u30da\u30fc\u30b8\u3067\u3082\u78ba\u8a8d\u3057\u3066\u307f\u307e\u3059\u3002\n\u30e6\u30fc\u30b6\u30fc\u30d7\u30fc\u30eb\u306e\u30c8\u30fc\u30af\u30f3\u306e\u4f7f\u7528\n\u3002\u3002\u3002\u6210\u308b\u7a0b\u3001\u610f\u5473\u304c\u5224\u308a\u307e\u305b\u3093\uff08JWT\u524d\u63d0\u306a\u306e\u3067\u5f53\u7136\u3063\u3061\u3083\u5f53\u7136\u3067\u3059\u304cJWT\u306e\u4ed5\u69d8\u3068\u304c\u5224\u3089\u306a\u3044\u3068\u7406\u89e3\u4e0d\u80fd\u3067\u3059\u3002\n\u4ee5\u4e0b\u629c\u7c8b\u30fb\u30fb\u30fb\n\n\u30e6\u30fc\u30b6\u30fc\u30d7\u30fc\u30eb\u306e\u30c8\u30fc\u30af\u30f3\u306e\u4f7f\u7528\n1. \u30e6\u30fc\u30b6\u30fc\u30d7\u30fc\u30eb\u306e JSON Web \u30c8\u30fc\u30af\u30f3 (JWT) \u30bb\u30c3\u30c8\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u3066\u4fdd\u5b58\u3057\u307e\u3059\u3002\n\u3000\u3000\u305d\u308c\u3089\u3092https://cognito-idp.{region}.amazonaws.com/{userPoolId}/.well-known/jwks.json\u3067\u691c\u7d22\u3067\u304d\u307e\u3059\u3002\n\n2. JWT \u5f62\u5f0f\u304b\u3089\u30c8\u30fc\u30af\u30f3\u6587\u5b57\u5217\u3092\u30c7\u30b3\u30fc\u30c9\u3057\u307e\u3059\u3002\n\n3. iss \u30af\u30ec\u30fc\u30e0\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\u3000\u3000\u3053\u308c\u306f\u3001\u30e6\u30fc\u30b6\u30fc\u30d7\u30fc\u30eb\u3068\u4e00\u81f4\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\u3000\u3000\u305f\u3068\u3048\u3070\u3001us-east-1 \u30ea\u30fc\u30b8\u30e7\u30f3\u3067\u4f5c\u6210\u3055\u308c\u305f\u30e6\u30fc\u30b6\u30fc\u30d7\u30fc\u30eb\u306e iss \u5024\u304c https://cognito-idp.us-east-4.amazonaws.com/{userPoolId} \u3067\u3042\u308b\u3068\u3057\u307e\u3059\u3002\n\n4. token_use \u30af\u30ec\u30fc\u30e0\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\u3000\u3000\u30a6\u30a7\u30d6 API \u3067\u30a2\u30af\u30bb\u30b9\u30c8\u30fc\u30af\u30f3\u306e\u307f\u3092\u53d7\u3051\u5165\u308c\u3066\u3044\u308b\u5834\u5408\u3001\u305d\u306e\u5024\u306f access \u306b\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\u3000\u3000ID \u30c8\u30fc\u30af\u30f3\u306e\u307f\u3092\u4f7f\u7528\u3057\u3066\u3044\u308b\u5834\u5408\u3001\u305d\u306e\u5024\u306f id \u306b\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\u3000\u3000\u4e21\u65b9\u306e\u30c8\u30fc\u30af\u30f3\u3092\u4f7f\u7528\u3057\u3066\u3044\u308b\u5834\u5408\u3001\u305d\u306e\u5024\u306f id \u307e\u305f\u306f access \u306e\u3069\u3061\u3089\u304b\u3067\u3059\u3002\n\n5. JWT\u30c8\u30fc\u30af\u30f3\u30d8\u30c3\u30c0\u30fc\u304b\u3089 kid \u3092\u53d6\u5f97\u3059\u308b\u3068\u3001\u30b9\u30c6\u30c3\u30d7 1 \u3067\u4fdd\u5b58\u3055\u308c\u305f\u5bfe\u5fdc\u3059\u308b JSON Web \u30ad\u30fc\u304c\u53d6\u5f97\u3055\u308c\u307e\u3059\u3002\n\n6. \u30c7\u30b3\u30fc\u30c9\u3055\u308c\u305f JWT \u30c8\u30fc\u30af\u30f3\u306e\u7f72\u540d\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n7. exp \u30af\u30ec\u30fc\u30e0\u3092\u78ba\u8a8d\u3057\u3001\u30c8\u30fc\u30af\u30f3\u304c\u671f\u9650\u5207\u308c\u3067\u306a\u3044\u3053\u3068\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\u3000\u3000\u30c8\u30fc\u30af\u30f3\u5185\u3067\u30af\u30ec\u30fc\u30e0\u3092\u4fe1\u983c\u3057\u3001\u8981\u4ef6\u306b\u6e80\u305f\u3059\u3082\u306e\u3068\u3057\u3066\u305d\u308c\u3092\u4f7f\u7528\u3067\u304d\u307e\u3059\u3002\n\n\n\n\n\u3044\u307e\u3044\u3061\u7406\u89e3\u3067\u304d\u306a\u304b\u3063\u305f\u306e\u3067\u3001\u5b9f\u969b\u306bruby\u3067\u7f72\u540d\u30c1\u30a7\u30c3\u30af\u3057\u3066\u307f\u307e\u3057\u305f\n\nGemfile\ngem 'jwt'\n\n\n\nsample.rb\nrequire 'jwt'\n\n# AWS SDK\u8a2d\u5b9a\nclient = Aws::CognitoIdentityProvider::Client.new(\n  region: '{region}',\n  access_key_id: '{access_key_id}',\n  secret_access_key: '{secret_access_key}'\n)\n\n# user pools\u8a8d\u8a3c\n# id/pass\u8a8d\u8a3c\n# \u3068\u308a\u3042\u3048\u305a\u8a8d\u8a3cAPI\u3092\u5b9f\u884c\u3057\u3066\u307f\u308b\nresp = client.admin_initiate_auth(\n  auth_flow: 'ADMIN_NO_SRP_AUTH',\n  user_pool_id: '{user_pool_id}',\n  client_id: '{client_id}',\n  # \u30ed\u30b0\u30a4\u30f3\u3057\u305f\u3044\u30e6\u30fc\u30b6\u306e\u60c5\u5831\n  auth_parameters: {\n    USERNAME: '\uff5bUSERNAME\uff5d',\n    PASSWORD: '\uff5bPASSWORD\uff5d'\n  }\n)\n\n# \u5404\u7a2eTOKEN\u3092\u5f15\u3063\u3053\u629c\u304f\naccess_token = resp.authentication_result.access_token\nrefresh_token = resp.authentication_result.refresh_token\nid_token = resp.authentication_result.id_token\n\n# 1. \u30e6\u30fc\u30b6\u30fc\u30d7\u30fc\u30eb\u306e JSON Web \u30c8\u30fc\u30af\u30f3 (JWT) \u30bb\u30c3\u30c8\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u3066\u4fdd\u5b58\u3057\u307e\u3059\njwks = JSON.parse(open('https://cognito-idp.{region}.amazonaws.com/{userPoolId}/.well-known/jwks.json').read)\n\n# 2. JWT \u5f62\u5f0f\u304b\u3089\u30c8\u30fc\u30af\u30f3\u6587\u5b57\u5217\u3092\u30c7\u30b3\u30fc\u30c9\u3057\u307e\u3059\u3002  \ndecode = JWT.decode id_token, nil, false\n\n# \u3053\u3053\u304b\u3089\u30da\u30a4\u30ed\u30fc\u30c9\u90e8\u5206\u306e\u78ba\u8a8d\n# 3. iss \u30af\u30ec\u30fc\u30e0\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\nreturn false if decode[0]['iss'] != 'https://cognito-idp.us-east-4.amazonaws.com/{userPoolId}'\n\n# 4. token_use \u30af\u30ec\u30fc\u30e0\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\nreturn false if decode[0]['token_use'] != 'id'\n\n# 5. JWT \u30c8\u30fc\u30af\u30f3\u30d8\u30c3\u30c0\u30fc\u304b\u3089 kid \u3092\u53d6\u5f97\nkid = decode[1]['kid']\n# kid\u304c\u53d6\u308c\u305f\u306e\u3067\u516c\u958b\u9375\u3092\u751f\u6210\n# openssl_bn\u306e\u5b9f\u88c5\u306f\u5f8c\u8ff0\u306e\u5f15\u7528\u5148\u300cRuby\u3067Google\u306eJWK\u306b\u3042\u308bmodulus\u3068exponent\u304b\u3089OpenSSL\u3092\u4f7f\u3063\u3066\u516c\u958b\u9375\u3092\u751f\u6210\u3059\u308b\u300d\u3092\u53c2\u7167\n# jwks['keys']\u306f jwks['keys'][{\u914d\u5217\u756a\u53f7}]['kid']\u3067kid\u304c\u4e00\u81f4\u3059\u308b\u3082\u306e\u3092\u4f7f\u3046\nmodulus = openssl_bn(jwks['keys'][0]['n'])\nexponent = openssl_bn(jwks['keys'][0]['e'])\nsequence = OpenSSL::ASN1::Sequence.new(\n  [OpenSSL::ASN1::Integer.new(modulus),\n   OpenSSL::ASN1::Integer.new(exponent)]\n)\npublic_key = OpenSSL::PKey::RSA.new(sequence.to_der)\n\n# 6. \u30c7\u30b3\u30fc\u30c9\u3055\u308c\u305f JWT \u30c8\u30fc\u30af\u30f3\u306e\u7f72\u540d\u3092\u78ba\u8a8d\n# 7. exp \u30af\u30ec\u30fc\u30e0\u3092\u78ba\u8a8d\u3057\u3001\u30c8\u30fc\u30af\u30f3\u304c\u671f\u9650\u5207\u308c\u3067\u306a\u3044\u3053\u3068\u3092\u78ba\u8a8d\n# \u2193\u3067\u671f\u9650\u5207\u308c\u3082\u30c1\u30a7\u30c3\u30af\u3057\u3066\u304f\u308c\u307e\u3059\u3002\uff08\u5b9f\u306f1-7\u306e\u9806\u756a\u3058\u3083\u306a\u3044\u307b\u3046\u304c\u52b9\u7387\u7684\u3067\u3059\u304c\u6298\u89d2\u306a\u306e\u3067\u9806\u756a\u3069\u304a\u308a\u306b\u30c1\u30a7\u30c3\u30af\u3057\u307e\u3057\u305f\u3002\nJWT.decode id_token, public_key, true, algorithm: 'RS256'\n\n\n\npublic_key\u751f\u6210\u306f\u30b3\u30c1\u30e9\u306e\u8a18\u4e8b\u3092\u5f15\u7528\u3057\u3066\u3044\u307e\u3059\u3002\n\n\u300cRuby\u3067Google\u306eJWK\u306b\u3042\u308bmodulus\u3068exponent\u304b\u3089OpenSSL\u3092\u4f7f\u3063\u3066\u516c\u958b\u9375\u3092\u751f\u6210\u3059\u308b\u300d\n\n\n\u6700\u5f8c\u306b\n\u3053\u3053\u307e\u3067\u3084\u3063\u3066\u3084\u3063\u3068token\u5229\u7528\u306e\u8cc7\u683c\u3092\u5f97\u308b\u3053\u3068\u304c\u51fa\u6765\u307e\u3059\u3002\n\u9006\u306b\u3061\u3083\u3093\u3068\u7f72\u540d\u30c1\u30a7\u30c3\u30af\u3057\u306a\u3044\u3068\u6539\u7ac4\u691c\u77e5\u51fa\u6765\u306a\u3044\u306e\u3067\u3001\u7d76\u5bfe\u306b\u3084\u308a\u305f\u3044\u3067\u3059\u306d\u3002\n\u3068\u3044\u3046\u3053\u3068\u3067\u3001\u6b21\u306f\u3053\u3053\u307e\u3067\u3092\u8e0f\u307e\u3048\u3066SSO\u306e\u5b9f\u88c5\u3092\u8003\u3048\u3088\u3046\u3068\u304a\u3082\u3044\u307e\u3059\u3002\n# \u306f\u3058\u3081\u306b\n\u30cd\u30c3\u30c8\u306bcognito\u306etoken\u5229\u7528\u306b\u95a2\u3057\u3066\u307e\u3068\u307e\u3063\u305f\u60c5\u5831\u304c\u306a\u3044\u306e\u3067\u5099\u5fd8\u7684\u306b\u307e\u3068\u3081\u3066\u307f\u307e\u3059\n\n# cognito\u306b\u304a\u3051\u308btoken\u306e\u6271\u3044\ncognito\u306etoken\u306fJWT\u306e\u30d5\u30a9\u30fc\u30de\u30c3\u30c8\u306b\u5247\u3063\u3066\u304a\u308a\u3001token\u5229\u7528\u6642\u306f\u7f72\u540d\u78ba\u8a8d\u304c\u7fa9\u52d9\u4ed8\u3051\u3089\u308c\u3066\u3044\u307e\u3059\u3002\n\u203bJWT\u306e\u30d5\u30a9\u30fc\u30de\u30c3\u30c8\u306e\u8aac\u660e\u306f\u30cd\u30c3\u30c8\u3092\u63a2\u305b\u3070\u51fa\u3066\u304f\u308b\u306e\u3067\u5272\u611b\u3057\u307e\u3059\u3002\n\n\n\u305d\u3053\u3067\u3001token\u4f7f\u7528\u6642\u306e\u7f72\u540d\u78ba\u8a8d\u624b\u9806\u3092amazon\u30da\u30fc\u30b8\u3067\u3082\u78ba\u8a8d\u3057\u3066\u307f\u307e\u3059\u3002\n[\u30e6\u30fc\u30b6\u30fc\u30d7\u30fc\u30eb\u306e\u30c8\u30fc\u30af\u30f3\u306e\u4f7f\u7528](http://docs.aws.amazon.com/ja_jp/cognito/latest/developerguide/amazon-cognito-user-pools-using-tokens-with-identity-providers.html)\n\u3002\u3002\u3002\u6210\u308b\u7a0b\u3001\u610f\u5473\u304c\u5224\u308a\u307e\u305b\u3093\uff08JWT\u524d\u63d0\u306a\u306e\u3067\u5f53\u7136\u3063\u3061\u3083\u5f53\u7136\u3067\u3059\u304cJWT\u306e\u4ed5\u69d8\u3068\u304c\u5224\u3089\u306a\u3044\u3068\u7406\u89e3\u4e0d\u80fd\u3067\u3059\u3002\n\n\u4ee5\u4e0b\u629c\u7c8b\u30fb\u30fb\u30fb\n\n```text:\u30e6\u30fc\u30b6\u30fc\u30d7\u30fc\u30eb\u306e\u30c8\u30fc\u30af\u30f3\u306e\u4f7f\u7528\n1. \u30e6\u30fc\u30b6\u30fc\u30d7\u30fc\u30eb\u306e JSON Web \u30c8\u30fc\u30af\u30f3 (JWT) \u30bb\u30c3\u30c8\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u3066\u4fdd\u5b58\u3057\u307e\u3059\u3002\n\u3000\u3000\u305d\u308c\u3089\u3092https://cognito-idp.{region}.amazonaws.com/{userPoolId}/.well-known/jwks.json\u3067\u691c\u7d22\u3067\u304d\u307e\u3059\u3002\n\n2. JWT \u5f62\u5f0f\u304b\u3089\u30c8\u30fc\u30af\u30f3\u6587\u5b57\u5217\u3092\u30c7\u30b3\u30fc\u30c9\u3057\u307e\u3059\u3002\n\n3. iss \u30af\u30ec\u30fc\u30e0\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\u3000\u3000\u3053\u308c\u306f\u3001\u30e6\u30fc\u30b6\u30fc\u30d7\u30fc\u30eb\u3068\u4e00\u81f4\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\u3000\u3000\u305f\u3068\u3048\u3070\u3001us-east-1 \u30ea\u30fc\u30b8\u30e7\u30f3\u3067\u4f5c\u6210\u3055\u308c\u305f\u30e6\u30fc\u30b6\u30fc\u30d7\u30fc\u30eb\u306e iss \u5024\u304c https://cognito-idp.us-east-4.amazonaws.com/{userPoolId} \u3067\u3042\u308b\u3068\u3057\u307e\u3059\u3002\n\n4. token_use \u30af\u30ec\u30fc\u30e0\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\u3000\u3000\u30a6\u30a7\u30d6 API \u3067\u30a2\u30af\u30bb\u30b9\u30c8\u30fc\u30af\u30f3\u306e\u307f\u3092\u53d7\u3051\u5165\u308c\u3066\u3044\u308b\u5834\u5408\u3001\u305d\u306e\u5024\u306f access \u306b\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\u3000\u3000ID \u30c8\u30fc\u30af\u30f3\u306e\u307f\u3092\u4f7f\u7528\u3057\u3066\u3044\u308b\u5834\u5408\u3001\u305d\u306e\u5024\u306f id \u306b\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\u3000\u3000\u4e21\u65b9\u306e\u30c8\u30fc\u30af\u30f3\u3092\u4f7f\u7528\u3057\u3066\u3044\u308b\u5834\u5408\u3001\u305d\u306e\u5024\u306f id \u307e\u305f\u306f access \u306e\u3069\u3061\u3089\u304b\u3067\u3059\u3002\n\n5. JWT\u30c8\u30fc\u30af\u30f3\u30d8\u30c3\u30c0\u30fc\u304b\u3089 kid \u3092\u53d6\u5f97\u3059\u308b\u3068\u3001\u30b9\u30c6\u30c3\u30d7 1 \u3067\u4fdd\u5b58\u3055\u308c\u305f\u5bfe\u5fdc\u3059\u308b JSON Web \u30ad\u30fc\u304c\u53d6\u5f97\u3055\u308c\u307e\u3059\u3002\n\n6. \u30c7\u30b3\u30fc\u30c9\u3055\u308c\u305f JWT \u30c8\u30fc\u30af\u30f3\u306e\u7f72\u540d\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n7. exp \u30af\u30ec\u30fc\u30e0\u3092\u78ba\u8a8d\u3057\u3001\u30c8\u30fc\u30af\u30f3\u304c\u671f\u9650\u5207\u308c\u3067\u306a\u3044\u3053\u3068\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\u3000\u3000\u30c8\u30fc\u30af\u30f3\u5185\u3067\u30af\u30ec\u30fc\u30e0\u3092\u4fe1\u983c\u3057\u3001\u8981\u4ef6\u306b\u6e80\u305f\u3059\u3082\u306e\u3068\u3057\u3066\u305d\u308c\u3092\u4f7f\u7528\u3067\u304d\u307e\u3059\u3002\n\n```\n\n# \u3044\u307e\u3044\u3061\u7406\u89e3\u3067\u304d\u306a\u304b\u3063\u305f\u306e\u3067\u3001\u5b9f\u969b\u306bruby\u3067\u7f72\u540d\u30c1\u30a7\u30c3\u30af\u3057\u3066\u307f\u307e\u3057\u305f\n\n```ruby:Gemfile\ngem 'jwt'\n```\n\n```ruby:sample.rb\nrequire 'jwt'\n\n# AWS SDK\u8a2d\u5b9a\nclient = Aws::CognitoIdentityProvider::Client.new(\n  region: '{region}',\n  access_key_id: '{access_key_id}',\n  secret_access_key: '{secret_access_key}'\n)\n\n# user pools\u8a8d\u8a3c\n# id/pass\u8a8d\u8a3c\n# \u3068\u308a\u3042\u3048\u305a\u8a8d\u8a3cAPI\u3092\u5b9f\u884c\u3057\u3066\u307f\u308b\nresp = client.admin_initiate_auth(\n  auth_flow: 'ADMIN_NO_SRP_AUTH',\n  user_pool_id: '{user_pool_id}',\n  client_id: '{client_id}',\n  # \u30ed\u30b0\u30a4\u30f3\u3057\u305f\u3044\u30e6\u30fc\u30b6\u306e\u60c5\u5831\n  auth_parameters: {\n    USERNAME: '\uff5bUSERNAME\uff5d',\n    PASSWORD: '\uff5bPASSWORD\uff5d'\n  }\n)\n\n# \u5404\u7a2eTOKEN\u3092\u5f15\u3063\u3053\u629c\u304f\naccess_token = resp.authentication_result.access_token\nrefresh_token = resp.authentication_result.refresh_token\nid_token = resp.authentication_result.id_token\n\n# 1. \u30e6\u30fc\u30b6\u30fc\u30d7\u30fc\u30eb\u306e JSON Web \u30c8\u30fc\u30af\u30f3 (JWT) \u30bb\u30c3\u30c8\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u3066\u4fdd\u5b58\u3057\u307e\u3059\njwks = JSON.parse(open('https://cognito-idp.{region}.amazonaws.com/{userPoolId}/.well-known/jwks.json').read)\n\n# 2. JWT \u5f62\u5f0f\u304b\u3089\u30c8\u30fc\u30af\u30f3\u6587\u5b57\u5217\u3092\u30c7\u30b3\u30fc\u30c9\u3057\u307e\u3059\u3002  \ndecode = JWT.decode id_token, nil, false\n\n# \u3053\u3053\u304b\u3089\u30da\u30a4\u30ed\u30fc\u30c9\u90e8\u5206\u306e\u78ba\u8a8d\n# 3. iss \u30af\u30ec\u30fc\u30e0\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\nreturn false if decode[0]['iss'] != 'https://cognito-idp.us-east-4.amazonaws.com/{userPoolId}'\n\n# 4. token_use \u30af\u30ec\u30fc\u30e0\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\nreturn false if decode[0]['token_use'] != 'id'\n\n# 5. JWT \u30c8\u30fc\u30af\u30f3\u30d8\u30c3\u30c0\u30fc\u304b\u3089 kid \u3092\u53d6\u5f97\nkid = decode[1]['kid']\n# kid\u304c\u53d6\u308c\u305f\u306e\u3067\u516c\u958b\u9375\u3092\u751f\u6210\n# openssl_bn\u306e\u5b9f\u88c5\u306f\u5f8c\u8ff0\u306e\u5f15\u7528\u5148\u300cRuby\u3067Google\u306eJWK\u306b\u3042\u308bmodulus\u3068exponent\u304b\u3089OpenSSL\u3092\u4f7f\u3063\u3066\u516c\u958b\u9375\u3092\u751f\u6210\u3059\u308b\u300d\u3092\u53c2\u7167\n# jwks['keys']\u306f jwks['keys'][{\u914d\u5217\u756a\u53f7}]['kid']\u3067kid\u304c\u4e00\u81f4\u3059\u308b\u3082\u306e\u3092\u4f7f\u3046\nmodulus = openssl_bn(jwks['keys'][0]['n'])\nexponent = openssl_bn(jwks['keys'][0]['e'])\nsequence = OpenSSL::ASN1::Sequence.new(\n  [OpenSSL::ASN1::Integer.new(modulus),\n   OpenSSL::ASN1::Integer.new(exponent)]\n)\npublic_key = OpenSSL::PKey::RSA.new(sequence.to_der)\n\n# 6. \u30c7\u30b3\u30fc\u30c9\u3055\u308c\u305f JWT \u30c8\u30fc\u30af\u30f3\u306e\u7f72\u540d\u3092\u78ba\u8a8d\n# 7. exp \u30af\u30ec\u30fc\u30e0\u3092\u78ba\u8a8d\u3057\u3001\u30c8\u30fc\u30af\u30f3\u304c\u671f\u9650\u5207\u308c\u3067\u306a\u3044\u3053\u3068\u3092\u78ba\u8a8d\n# \u2193\u3067\u671f\u9650\u5207\u308c\u3082\u30c1\u30a7\u30c3\u30af\u3057\u3066\u304f\u308c\u307e\u3059\u3002\uff08\u5b9f\u306f1-7\u306e\u9806\u756a\u3058\u3083\u306a\u3044\u307b\u3046\u304c\u52b9\u7387\u7684\u3067\u3059\u304c\u6298\u89d2\u306a\u306e\u3067\u9806\u756a\u3069\u304a\u308a\u306b\u30c1\u30a7\u30c3\u30af\u3057\u307e\u3057\u305f\u3002\nJWT.decode id_token, public_key, true, algorithm: 'RS256'\n\n```\npublic_key\u751f\u6210\u306f\u30b3\u30c1\u30e9\u306e\u8a18\u4e8b\u3092\u5f15\u7528\u3057\u3066\u3044\u307e\u3059\u3002\n> [\u300cRuby\u3067Google\u306eJWK\u306b\u3042\u308bmodulus\u3068exponent\u304b\u3089OpenSSL\u3092\u4f7f\u3063\u3066\u516c\u958b\u9375\u3092\u751f\u6210\u3059\u308b\u300d](http://qiita.com/trysmr/items/e8d4225ff6a603e9e21a)\n\n# \u6700\u5f8c\u306b\n\u3053\u3053\u307e\u3067\u3084\u3063\u3066\u3084\u3063\u3068token\u5229\u7528\u306e\u8cc7\u683c\u3092\u5f97\u308b\u3053\u3068\u304c\u51fa\u6765\u307e\u3059\u3002\n\u9006\u306b\u3061\u3083\u3093\u3068\u7f72\u540d\u30c1\u30a7\u30c3\u30af\u3057\u306a\u3044\u3068\u6539\u7ac4\u691c\u77e5\u51fa\u6765\u306a\u3044\u306e\u3067\u3001\u7d76\u5bfe\u306b\u3084\u308a\u305f\u3044\u3067\u3059\u306d\u3002\n\n\u3068\u3044\u3046\u3053\u3068\u3067\u3001\u6b21\u306f\u3053\u3053\u307e\u3067\u3092\u8e0f\u307e\u3048\u3066SSO\u306e\u5b9f\u88c5\u3092\u8003\u3048\u3088\u3046\u3068\u304a\u3082\u3044\u307e\u3059\u3002\n\n\n", "tags": ["CognitoUserPools", "cognito", "Ruby", "Rails", "JWT"]}