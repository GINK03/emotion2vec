{"tags": ["PostgreSQL", "Security", "\u6697\u53f7\u5316"], "context": "\n\n\u900f\u904e\u7684\u6697\u53f7\u5316\u30c6\u30fc\u30d6\u30eb\u306e\u4f5c\u6210\n-- \u6697\u53f7\u5316\u30e2\u30b8\u30e5\u30fc\u30ebpgcrypto\u306e\u767b\u9332\nCREATE EXTENSION pgcrypto;\n\n-- \u6697\u53f7\u5316\u3057\u305f\u30e6\u30fc\u30b6\u30c7\u30fc\u30bf\u3092\u683c\u7d0d\u3059\u308b\u30c6\u30fc\u30d6\u30eb\u3092\u4f5c\u6210\nCREATE TABLE users_internal\n  (id BIGINT PRIMARY KEY, name BYTEA, addr BYTEA);\n\n-- \u30e6\u30fc\u30b6\u30c7\u30fc\u30bf\u306e\u30c6\u30fc\u30d6\u30eb\u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u305f\u3081\u306e\u30d3\u30e5\u30fc\u3092\u4f5c\u6210\n-- \u30e6\u30fc\u30b6\u540dname\u3068\u4f4f\u6240addr\u306e\u5404\u30ab\u30e9\u30e0\u3092\u6697\u53f7\u5316\n-- \u6697\u53f7\u5316\u30ad\u30fc\u306b\u306fapplication_name\u306e\u8a2d\u5b9a\u5024\u3092\u4f7f\u7528\nCREATE OR REPLACE VIEW users AS\n  SELECT\n    id,\n    pgp_sym_decrypt(name, current_setting('application_name')) \"name\",\n    pgp_sym_decrypt(addr, current_setting('application_name')) addr\n  FROM\n    users_internal;\n\n-- \u30d3\u30e5\u30fc\u306b\u5bfe\u3059\u308b\u64cd\u4f5c\u3092\u30c6\u30fc\u30d6\u30eb\u306b\u5bfe\u3059\u308b\u64cd\u4f5c\u306b\u5909\u63db\u3059\u308b\u30c8\u30ea\u30ac\u95a2\u6570\u306e\u4f5c\u6210\nCREATE OR REPLACE FUNCTION users_func() RETURNS trigger AS $$\nBEGIN\n  IF (TG_OP = 'INSERT') THEN\n    INSERT INTO users_internal VALUES(\n      NEW.id,\n      pgp_sym_encrypt(NEW.name, current_setting('application_name')),\n      pgp_sym_encrypt(NEW.addr, current_setting('application_name')));\n    RETURN NEW;\n  ELSIF (TG_OP = 'UPDATE') THEN\n    UPDATE users_internal SET\n      name = pgp_sym_encrypt(NEW.name, current_setting('application_name')),\n      addr = pgp_sym_encrypt(NEW.addr, current_setting('application_name'))\n    WHERE id = OLD.id;\n    RETURN NEW;\n  ELSIF (TG_OP = 'DELETE') THEN\n    DELETE FROM users_internal WHERE id = OLD.id;\n    RETURN OLD;\n  END IF;\nEND;\n$$ LANGUAGE plpgsql;\n\n-- \u30c8\u30ea\u30ac\u3092\u30d3\u30e5\u30fc\u306b\u8a2d\u5b9a\nCREATE TRIGGER users_trigger\n  INSTEAD OF INSERT OR UPDATE OR DELETE ON users\n  FOR EACH ROW EXECUTE PROCEDURE users_func();\n\n\n\u900f\u904e\u7684\u6697\u53f7\u5316\u306e\u78ba\u8a8d\n-- \u6697\u53f7\u5316\u30ad\u30fc\u3092mykey\u306b\u8a2d\u5b9a\nSET application_name TO 'mykey';\n\n-- \u30d3\u30e5\u30fc\u306b\u5bfe\u3057\u3066\u30e6\u30fc\u30b6\u30c7\u30fc\u30bf\u3092\u633f\u5165\u30fb\u66f4\u65b0\u30fb\u524a\u9664\nINSERT INTO users VALUES (1, '\u4f50\u85e4\u592a\u90ce', '\u6771\u4eac\u90fd\u6c5f\u6771\u533a');\nINSERT INTO users VALUES (2, '\u9234\u6728\u82b1\u5b50', '\u4eac\u90fd\u5e9c\u4eac\u90fd\u5e02\u5de6\u4eac\u533a');\nINSERT INTO users VALUES (3, '\u7530\u4e2d\u4e8c\u90ce', '\u611b\u77e5\u770c\u540d\u53e4\u5c4b\u5e02\u4e2d\u533a');\nUPDATE users SET addr = '\u6771\u4eac\u90fd\u6e2f\u533a' WHERE id = 1;\nDELETE FROM users WHERE id = 3;\n\n-- \u671f\u5f85\u3069\u304a\u308a\u306e\u691c\u7d22\u7d50\u679c\u3068\u306a\u308b\u3053\u3068\u3092\u78ba\u8a8d\nSELECT * FROM users ORDER BY id;\n id |   name   |        addr        \n----+----------+--------------------\n  1 | \u4f50\u85e4\u592a\u90ce | \u6771\u4eac\u90fd\u6e2f\u533a\n  2 | \u9234\u6728\u82b1\u5b50 | \u4eac\u90fd\u5e9c\u4eac\u90fd\u5e02\u5de6\u4eac\u533a\n(2 rows)\n\n-- \u6697\u53f7\u5316\u30ad\u30fc\u304c\u6b63\u3057\u304f\u306a\u3044\u3068\u3001\u30e6\u30fc\u30b6\u30c7\u30fc\u30bf\u306f\u9069\u5207\u306b\u5fa9\u53f7\u5316\u3055\u308c\u306a\u3044\u3053\u3068\u3092\u78ba\u8a8d\nSET application_name TO 'yourkey';\nSELECT * FROM users ORDER BY id;\nERROR:  Wrong key or corrupt data\n\n\napplication_name\u3092\u6697\u53f7\u5316\u30ad\u30fc\u306b\u4f7f\u3046\u5229\u70b9\u30fb\u8ab2\u984c\napplication_name\u306f\u3001PostgreSQL\u306e\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u30c4\u30fc\u30eb\u3084\u30e9\u30a4\u30d6\u30e9\u30ea\u304b\u3089PostgreSQL\u30b5\u30fc\u30d0\u306b\u900f\u904e\u7684\u306b\u5024\u3092\u6e21\u3059\u4ed5\u7d44\u307f(JDBC\u30c9\u30e9\u30a4\u30d0\u306eApplicationName\u63a5\u7d9a\u30d1\u30e9\u30e1\u30fc\u30bf\u3084PGAPPNAME\u74b0\u5883\u5909\u6570\u306a\u3069)\u304c\u65e2\u306b\u7528\u610f\u3055\u308c\u3066\u3044\u308b\u3002\u3053\u306e\u305f\u3081\u3001\u7279\u5225\u306aSQL\u3084\u30b3\u30de\u30f3\u30c9\u306e\u5b9f\u884c\u306a\u304f\u6697\u53f7\u5316\u30ad\u30fc\u3092\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u304b\u3089\u30b5\u30fc\u30d0\u306b\u6307\u5b9a\u3067\u304d\u3001\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3092\u900f\u904e\u7684\u6697\u53f7\u5316\u306e\u305f\u3081\u306b\u6539\u4fee\u3059\u308b\u5fc5\u8981\u304c\u306a\u3044\u3002\n\u305f\u3060\u3057\u3001application_name\u306fpg_stat_activity\u304b\u3089\u5bb9\u6613\u306b\u6f0f\u6d29\u3059\u308b\u305f\u3081\u5bfe\u7b56\u304c\u5fc5\u8981\u3068\u306a\u308b\u3002\n\n\u6697\u53f7\u5316\u30ad\u30fc\u6f0f\u6d29\u5bfe\u7b56\n## \u5bfe\u7b56\u306e\u305f\u3081\u306bpg_cheat_funcs\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n$ cd /tmp\n$ wget --no-check-certificate https://github.com/MasaoFujii/pg_cheat_funcs/archive/master.zip\n$ unzip master\n$ rm -f master\n$ cd pg_cheat_funcs-master\n$ make USE_PGXS=1 PG_CONFIG=/opt/pgsql-X.Y.Z/bin/pg_config\n$ make USE_PGXS=1 PG_CONFIG=/opt/pgsql-X.Y.Z/bin/pg_config install\n\n## \u6f0f\u6d29\u5bfe\u7b56\u306e\u305f\u3081\u306e\u30d1\u30e9\u30e1\u30fc\u30bf\u8a2d\u5b9a\n$ emacs $PGDATA/postgresql.conf\nshared_preload_libraries = 'pg_cheat_funcs'\npg_cheat_funcs.hide_appname = on\n\n## \u8a2d\u5b9a\u5909\u66f4\u3092\u6709\u52b9\u5316\u3059\u308b\u305f\u3081PostgreSQL\u518d\u8d77\u52d5\n$ pg_ctl -D $PGDATA restart\n\npg_cheat_funcs\u306b\u3088\u308a\u3001application_name\u306e\u5024(\u6697\u53f7\u5316\u30ad\u30fc)\u306fpg_cheat_funcs.hidden_appname\u306b\u30b3\u30d4\u30fc\u3055\u308c\u3001application_name\u81ea\u4f53\u306f\u7a7a\u6587\u5b57\u306b\u30ea\u30bb\u30c3\u30c8\u3002hidden_appname\u3092\u53c2\u7167\u3067\u304d\u308b\u306e\u306f\u305d\u306e\u30bb\u30c3\u30b7\u30e7\u30f3\u81ea\u8eab\u306e\u307f\u306e\u305f\u3081\u3001\u4ed6\u30bb\u30c3\u30b7\u30e7\u30f3\u306b\u6697\u53f7\u5316\u30ad\u30fc\u306f\u6f0f\u6d29\u3057\u306a\u3044\u3002\u307e\u305f\u3001application_name\u306f\u7a7a\u6587\u5b57\u306e\u305f\u3081\u3001pg_stat_activity\u304b\u3089\u6697\u53f7\u5316\u30ad\u30fc\u304c\u6f0f\u6d29\u3059\u308b\u3053\u3068\u3082\u306a\u3044\u3002\npg_cheat_funcs.hidden_appname\u306e\u6697\u53f7\u5316\u30ad\u30fc\u3092\u4f7f\u3046\u3088\u3046\u306b\u3001\u900f\u904e\u7684\u6697\u53f7\u5316\u30c6\u30fc\u30d6\u30eb\u306e\u5b9a\u7fa9\u3092\u6539\u4fee\u3059\u308b\u3002\nCREATE OR REPLACE VIEW users AS\n  SELECT\n    id,\n    pgp_sym_decrypt(name, current_setting('pg_cheat_funcs.hidden_appname')) \"name\",\n    pgp_sym_decrypt(addr, current_setting('pg_cheat_funcs.hidden_appname')) addr\n  FROM\n    users_internal;\n\nCREATE OR REPLACE FUNCTION users_func() RETURNS trigger AS $$\nBEGIN\n  IF (TG_OP = 'INSERT') THEN\n    INSERT INTO users_internal VALUES(\n      NEW.id,\n      pgp_sym_encrypt(NEW.name, current_setting('pg_cheat_funcs.hidden_appname')),\n      pgp_sym_encrypt(NEW.addr, current_setting('pg_cheat_funcs.hidden_appname')));\n    RETURN NEW;\n  ELSIF (TG_OP = 'UPDATE') THEN\n    UPDATE users_internal SET\n      name = pgp_sym_encrypt(NEW.name, current_setting('pg_cheat_funcs.hidden_appname')),\n      addr = pgp_sym_encrypt(NEW.addr, current_setting('pg_cheat_funcs.hidden_appname'))\n    WHERE id = OLD.id;\n    RETURN NEW;\n  ELSIF (TG_OP = 'DELETE') THEN\n    DELETE FROM users_internal WHERE id = OLD.id;\n    RETURN OLD;\n  END IF;\nEND;\n$$ LANGUAGE plpgsql;\n\n\n\u6697\u53f7\u5316\u30ad\u30fc\u304c\u6f0f\u6d29\u3057\u3066\u3044\u306a\u3044\u3053\u3068\u306e\u78ba\u8a8d\n## \u6f0f\u6d29\u5bfe\u7b56\u5f8c\u306f\u3001\u6697\u53f7\u5316\u30ad\u30fc\u306f\u63a5\u7d9a\u6642\u306bapplication_name\u306b\u8a2d\u5b9a\u3055\u308c\u3066\u3044\u306a\u3051\u308c\u3070\u306a\u3089\u306a\u3044\n## \u63a5\u7d9a\u5f8c\u306eSET\u30b3\u30de\u30f3\u30c9\u306b\u3088\u308b\u6307\u5b9a\u306fNG\n$ psql -d \"application_name=mykey\"\n\n-- \u6f0f\u6d29\u5bfe\u7b56\u5f8c\u306f\u3001application_name\u306f\u7a7a\u6587\u5b57\u306b\u30ea\u30bb\u30c3\u30c8\nSELECT application_name FROM pg_stat_activity WHERE pid = pg_backend_pid();\n application_name \n------------------\n\n(1 row)\n\n-- \u6f0f\u6d29\u5bfe\u7b56\u5f8c\u3082\u900f\u904e\u7684\u6697\u53f7\u5316\u30c6\u30fc\u30d6\u30eb\u306f\u5229\u7528\u53ef\u80fd\nSELECT * FROM users ORDER BY id;\n id |   name   |        addr        \n----+----------+--------------------\n  1 | \u4f50\u85e4\u592a\u90ce | \u6771\u4eac\u90fd\u6e2f\u533a\n  2 | \u9234\u6728\u82b1\u5b50 | \u4eac\u90fd\u5e9c\u4eac\u90fd\u5e02\u5de6\u4eac\u533a\n(2 rows)\n\n\n\u30b9\u30fc\u30d1\u30fc\u30e6\u30fc\u30b6\u306b\u3088\u308b\u6f0f\u6d29\u5bfe\u7b56\u7121\u52b9\u5316\u3078\u306e\u5bfe\u7b56\n\u30b9\u30fc\u30d1\u30fc\u30e6\u30fc\u30b6\u306f\u3001ALTER SYSTEM SET\u3084COPY PROGRAM\u30b3\u30de\u30f3\u30c9\u306b\u3088\u308a\u3001shared_preload_lilbraries\u3084pg_cheat_funcs.hide_appname\u3092\u8a2d\u5b9a\u5909\u66f4\u3057\u3066\u6f0f\u6d29\u5bfe\u7b56\u3092\u7121\u52b9\u5316\u3057\u3001\u6697\u53f7\u5316\u30ad\u30fc\u3092\u5165\u624b\u3067\u304d\u308b\u53ef\u80fd\u6027\u304c\u3042\u308b\u3002\n\u30b9\u30fc\u30d1\u30fc\u30e6\u30fc\u30b6\u306b\u3082\u6697\u53f7\u5316\u30c7\u30fc\u30bf\u3092\u53c2\u7167\u3055\u305b\u305f\u304f\u306a\u3044\u5834\u5408\u306f\u3001pg_disallow_utility\u3067ALTER SYSTEM SET\u3068COPY PROGRAM\u3092\u5b9f\u884cNG\u306b\u8a2d\u5b9a\u3059\u308b\u3002\n$ cd /tmp\n$ wget --no-check-certificate https://github.com/MasaoFujii/pg_disallow_utility/archive/master.zip\n$ unzip master\n$ rm -f master\n$ cd pg_disallow_utility-master\n$ make USE_PGXS=1 PG_CONFIG=/opt/pgsql-X.Y.Z/bin/pg_config\n$ make USE_PGXS=1 PG_CONFIG=/opt/pgsql-X.Y.Z/bin/pg_config install\n\n$ emacs $PGDATA/postgresql.conf\nshared_preload_libraries = 'pg_cheat_funcs, pg_disallow_utility'\npg_disallow_utility.alter_system = on\npg_disallow_utility.copy_program = on\n\n$ pg_ctl -D $PGDATA restart\n\n## \u900f\u904e\u7684\u6697\u53f7\u5316\u30c6\u30fc\u30d6\u30eb\u306e\u4f5c\u6210\n\n``` plpgsql\n-- \u6697\u53f7\u5316\u30e2\u30b8\u30e5\u30fc\u30ebpgcrypto\u306e\u767b\u9332\nCREATE EXTENSION pgcrypto;\n\n-- \u6697\u53f7\u5316\u3057\u305f\u30e6\u30fc\u30b6\u30c7\u30fc\u30bf\u3092\u683c\u7d0d\u3059\u308b\u30c6\u30fc\u30d6\u30eb\u3092\u4f5c\u6210\nCREATE TABLE users_internal\n  (id BIGINT PRIMARY KEY, name BYTEA, addr BYTEA);\n\n-- \u30e6\u30fc\u30b6\u30c7\u30fc\u30bf\u306e\u30c6\u30fc\u30d6\u30eb\u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u305f\u3081\u306e\u30d3\u30e5\u30fc\u3092\u4f5c\u6210\n-- \u30e6\u30fc\u30b6\u540dname\u3068\u4f4f\u6240addr\u306e\u5404\u30ab\u30e9\u30e0\u3092\u6697\u53f7\u5316\n-- \u6697\u53f7\u5316\u30ad\u30fc\u306b\u306fapplication_name\u306e\u8a2d\u5b9a\u5024\u3092\u4f7f\u7528\nCREATE OR REPLACE VIEW users AS\n  SELECT\n    id,\n\tpgp_sym_decrypt(name, current_setting('application_name')) \"name\",\n\tpgp_sym_decrypt(addr, current_setting('application_name')) addr\n  FROM\n    users_internal;\n\n-- \u30d3\u30e5\u30fc\u306b\u5bfe\u3059\u308b\u64cd\u4f5c\u3092\u30c6\u30fc\u30d6\u30eb\u306b\u5bfe\u3059\u308b\u64cd\u4f5c\u306b\u5909\u63db\u3059\u308b\u30c8\u30ea\u30ac\u95a2\u6570\u306e\u4f5c\u6210\nCREATE OR REPLACE FUNCTION users_func() RETURNS trigger AS $$\nBEGIN\n  IF (TG_OP = 'INSERT') THEN\n    INSERT INTO users_internal VALUES(\n\t  NEW.id,\n\t  pgp_sym_encrypt(NEW.name, current_setting('application_name')),\n\t  pgp_sym_encrypt(NEW.addr, current_setting('application_name')));\n\tRETURN NEW;\n  ELSIF (TG_OP = 'UPDATE') THEN\n    UPDATE users_internal SET\n\t  name = pgp_sym_encrypt(NEW.name, current_setting('application_name')),\n      addr = pgp_sym_encrypt(NEW.addr, current_setting('application_name'))\n    WHERE id = OLD.id;\n\tRETURN NEW;\n  ELSIF (TG_OP = 'DELETE') THEN\n    DELETE FROM users_internal WHERE id = OLD.id;\n\tRETURN OLD;\n  END IF;\nEND;\n$$ LANGUAGE plpgsql;\n\n-- \u30c8\u30ea\u30ac\u3092\u30d3\u30e5\u30fc\u306b\u8a2d\u5b9a\nCREATE TRIGGER users_trigger\n  INSTEAD OF INSERT OR UPDATE OR DELETE ON users\n  FOR EACH ROW EXECUTE PROCEDURE users_func();\n```\n\n## \u900f\u904e\u7684\u6697\u53f7\u5316\u306e\u78ba\u8a8d\n\n``` plpgsql\n-- \u6697\u53f7\u5316\u30ad\u30fc\u3092mykey\u306b\u8a2d\u5b9a\nSET application_name TO 'mykey';\n\n-- \u30d3\u30e5\u30fc\u306b\u5bfe\u3057\u3066\u30e6\u30fc\u30b6\u30c7\u30fc\u30bf\u3092\u633f\u5165\u30fb\u66f4\u65b0\u30fb\u524a\u9664\nINSERT INTO users VALUES (1, '\u4f50\u85e4\u592a\u90ce', '\u6771\u4eac\u90fd\u6c5f\u6771\u533a');\nINSERT INTO users VALUES (2, '\u9234\u6728\u82b1\u5b50', '\u4eac\u90fd\u5e9c\u4eac\u90fd\u5e02\u5de6\u4eac\u533a');\nINSERT INTO users VALUES (3, '\u7530\u4e2d\u4e8c\u90ce', '\u611b\u77e5\u770c\u540d\u53e4\u5c4b\u5e02\u4e2d\u533a');\nUPDATE users SET addr = '\u6771\u4eac\u90fd\u6e2f\u533a' WHERE id = 1;\nDELETE FROM users WHERE id = 3;\n\n-- \u671f\u5f85\u3069\u304a\u308a\u306e\u691c\u7d22\u7d50\u679c\u3068\u306a\u308b\u3053\u3068\u3092\u78ba\u8a8d\nSELECT * FROM users ORDER BY id;\n id |   name   |        addr        \n----+----------+--------------------\n  1 | \u4f50\u85e4\u592a\u90ce | \u6771\u4eac\u90fd\u6e2f\u533a\n  2 | \u9234\u6728\u82b1\u5b50 | \u4eac\u90fd\u5e9c\u4eac\u90fd\u5e02\u5de6\u4eac\u533a\n(2 rows)\n\n-- \u6697\u53f7\u5316\u30ad\u30fc\u304c\u6b63\u3057\u304f\u306a\u3044\u3068\u3001\u30e6\u30fc\u30b6\u30c7\u30fc\u30bf\u306f\u9069\u5207\u306b\u5fa9\u53f7\u5316\u3055\u308c\u306a\u3044\u3053\u3068\u3092\u78ba\u8a8d\nSET application_name TO 'yourkey';\nSELECT * FROM users ORDER BY id;\nERROR:  Wrong key or corrupt data\n```\n\n## application_name\u3092\u6697\u53f7\u5316\u30ad\u30fc\u306b\u4f7f\u3046\u5229\u70b9\u30fb\u8ab2\u984c\n\napplication_name\u306f\u3001PostgreSQL\u306e\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u30c4\u30fc\u30eb\u3084\u30e9\u30a4\u30d6\u30e9\u30ea\u304b\u3089PostgreSQL\u30b5\u30fc\u30d0\u306b\u900f\u904e\u7684\u306b\u5024\u3092\u6e21\u3059\u4ed5\u7d44\u307f(JDBC\u30c9\u30e9\u30a4\u30d0\u306eApplicationName\u63a5\u7d9a\u30d1\u30e9\u30e1\u30fc\u30bf\u3084PGAPPNAME\u74b0\u5883\u5909\u6570\u306a\u3069)\u304c\u65e2\u306b\u7528\u610f\u3055\u308c\u3066\u3044\u308b\u3002\u3053\u306e\u305f\u3081\u3001\u7279\u5225\u306aSQL\u3084\u30b3\u30de\u30f3\u30c9\u306e\u5b9f\u884c\u306a\u304f\u6697\u53f7\u5316\u30ad\u30fc\u3092\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u304b\u3089\u30b5\u30fc\u30d0\u306b\u6307\u5b9a\u3067\u304d\u3001\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3092\u900f\u904e\u7684\u6697\u53f7\u5316\u306e\u305f\u3081\u306b\u6539\u4fee\u3059\u308b\u5fc5\u8981\u304c\u306a\u3044\u3002\n\u305f\u3060\u3057\u3001application_name\u306fpg_stat_activity\u304b\u3089\u5bb9\u6613\u306b\u6f0f\u6d29\u3059\u308b\u305f\u3081\u5bfe\u7b56\u304c\u5fc5\u8981\u3068\u306a\u308b\u3002\n\n## \u6697\u53f7\u5316\u30ad\u30fc\u6f0f\u6d29\u5bfe\u7b56\n\n``` bash\n## \u5bfe\u7b56\u306e\u305f\u3081\u306bpg_cheat_funcs\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n$ cd /tmp\n$ wget --no-check-certificate https://github.com/MasaoFujii/pg_cheat_funcs/archive/master.zip\n$ unzip master\n$ rm -f master\n$ cd pg_cheat_funcs-master\n$ make USE_PGXS=1 PG_CONFIG=/opt/pgsql-X.Y.Z/bin/pg_config\n$ make USE_PGXS=1 PG_CONFIG=/opt/pgsql-X.Y.Z/bin/pg_config install\n\n## \u6f0f\u6d29\u5bfe\u7b56\u306e\u305f\u3081\u306e\u30d1\u30e9\u30e1\u30fc\u30bf\u8a2d\u5b9a\n$ emacs $PGDATA/postgresql.conf\nshared_preload_libraries = 'pg_cheat_funcs'\npg_cheat_funcs.hide_appname = on\n\n## \u8a2d\u5b9a\u5909\u66f4\u3092\u6709\u52b9\u5316\u3059\u308b\u305f\u3081PostgreSQL\u518d\u8d77\u52d5\n$ pg_ctl -D $PGDATA restart\n```\n\npg_cheat_funcs\u306b\u3088\u308a\u3001application_name\u306e\u5024(\u6697\u53f7\u5316\u30ad\u30fc)\u306fpg_cheat_funcs.hidden_appname\u306b\u30b3\u30d4\u30fc\u3055\u308c\u3001application_name\u81ea\u4f53\u306f\u7a7a\u6587\u5b57\u306b\u30ea\u30bb\u30c3\u30c8\u3002hidden_appname\u3092\u53c2\u7167\u3067\u304d\u308b\u306e\u306f\u305d\u306e\u30bb\u30c3\u30b7\u30e7\u30f3\u81ea\u8eab\u306e\u307f\u306e\u305f\u3081\u3001\u4ed6\u30bb\u30c3\u30b7\u30e7\u30f3\u306b\u6697\u53f7\u5316\u30ad\u30fc\u306f\u6f0f\u6d29\u3057\u306a\u3044\u3002\u307e\u305f\u3001application_name\u306f\u7a7a\u6587\u5b57\u306e\u305f\u3081\u3001pg_stat_activity\u304b\u3089\u6697\u53f7\u5316\u30ad\u30fc\u304c\u6f0f\u6d29\u3059\u308b\u3053\u3068\u3082\u306a\u3044\u3002\npg_cheat_funcs.hidden_appname\u306e\u6697\u53f7\u5316\u30ad\u30fc\u3092\u4f7f\u3046\u3088\u3046\u306b\u3001\u900f\u904e\u7684\u6697\u53f7\u5316\u30c6\u30fc\u30d6\u30eb\u306e\u5b9a\u7fa9\u3092\u6539\u4fee\u3059\u308b\u3002\n\n``` plpgsql\nCREATE OR REPLACE VIEW users AS\n  SELECT\n    id,\n\tpgp_sym_decrypt(name, current_setting('pg_cheat_funcs.hidden_appname')) \"name\",\n\tpgp_sym_decrypt(addr, current_setting('pg_cheat_funcs.hidden_appname')) addr\n  FROM\n    users_internal;\n\nCREATE OR REPLACE FUNCTION users_func() RETURNS trigger AS $$\nBEGIN\n  IF (TG_OP = 'INSERT') THEN\n    INSERT INTO users_internal VALUES(\n\t  NEW.id,\n\t  pgp_sym_encrypt(NEW.name, current_setting('pg_cheat_funcs.hidden_appname')),\n\t  pgp_sym_encrypt(NEW.addr, current_setting('pg_cheat_funcs.hidden_appname')));\n\tRETURN NEW;\n  ELSIF (TG_OP = 'UPDATE') THEN\n    UPDATE users_internal SET\n\t  name = pgp_sym_encrypt(NEW.name, current_setting('pg_cheat_funcs.hidden_appname')),\n      addr = pgp_sym_encrypt(NEW.addr, current_setting('pg_cheat_funcs.hidden_appname'))\n    WHERE id = OLD.id;\n\tRETURN NEW;\n  ELSIF (TG_OP = 'DELETE') THEN\n    DELETE FROM users_internal WHERE id = OLD.id;\n\tRETURN OLD;\n  END IF;\nEND;\n$$ LANGUAGE plpgsql;\n```\n\n## \u6697\u53f7\u5316\u30ad\u30fc\u304c\u6f0f\u6d29\u3057\u3066\u3044\u306a\u3044\u3053\u3068\u306e\u78ba\u8a8d\n\n``` bash\n## \u6f0f\u6d29\u5bfe\u7b56\u5f8c\u306f\u3001\u6697\u53f7\u5316\u30ad\u30fc\u306f\u63a5\u7d9a\u6642\u306bapplication_name\u306b\u8a2d\u5b9a\u3055\u308c\u3066\u3044\u306a\u3051\u308c\u3070\u306a\u3089\u306a\u3044\n## \u63a5\u7d9a\u5f8c\u306eSET\u30b3\u30de\u30f3\u30c9\u306b\u3088\u308b\u6307\u5b9a\u306fNG\n$ psql -d \"application_name=mykey\"\n```\n\n``` plpgsql\n-- \u6f0f\u6d29\u5bfe\u7b56\u5f8c\u306f\u3001application_name\u306f\u7a7a\u6587\u5b57\u306b\u30ea\u30bb\u30c3\u30c8\nSELECT application_name FROM pg_stat_activity WHERE pid = pg_backend_pid();\n application_name \n------------------\n \n(1 row)\n\n-- \u6f0f\u6d29\u5bfe\u7b56\u5f8c\u3082\u900f\u904e\u7684\u6697\u53f7\u5316\u30c6\u30fc\u30d6\u30eb\u306f\u5229\u7528\u53ef\u80fd\nSELECT * FROM users ORDER BY id;\n id |   name   |        addr        \n----+----------+--------------------\n  1 | \u4f50\u85e4\u592a\u90ce | \u6771\u4eac\u90fd\u6e2f\u533a\n  2 | \u9234\u6728\u82b1\u5b50 | \u4eac\u90fd\u5e9c\u4eac\u90fd\u5e02\u5de6\u4eac\u533a\n(2 rows)\n```\n\n## \u30b9\u30fc\u30d1\u30fc\u30e6\u30fc\u30b6\u306b\u3088\u308b\u6f0f\u6d29\u5bfe\u7b56\u7121\u52b9\u5316\u3078\u306e\u5bfe\u7b56\n\n\u30b9\u30fc\u30d1\u30fc\u30e6\u30fc\u30b6\u306f\u3001ALTER SYSTEM SET\u3084COPY PROGRAM\u30b3\u30de\u30f3\u30c9\u306b\u3088\u308a\u3001shared_preload_lilbraries\u3084pg_cheat_funcs.hide_appname\u3092\u8a2d\u5b9a\u5909\u66f4\u3057\u3066\u6f0f\u6d29\u5bfe\u7b56\u3092\u7121\u52b9\u5316\u3057\u3001\u6697\u53f7\u5316\u30ad\u30fc\u3092\u5165\u624b\u3067\u304d\u308b\u53ef\u80fd\u6027\u304c\u3042\u308b\u3002\n\u30b9\u30fc\u30d1\u30fc\u30e6\u30fc\u30b6\u306b\u3082\u6697\u53f7\u5316\u30c7\u30fc\u30bf\u3092\u53c2\u7167\u3055\u305b\u305f\u304f\u306a\u3044\u5834\u5408\u306f\u3001[pg_disallow_utility](https://github.com/MasaoFujii/pg_disallow_utility)\u3067ALTER SYSTEM SET\u3068COPY PROGRAM\u3092\u5b9f\u884cNG\u306b\u8a2d\u5b9a\u3059\u308b\u3002\n\n``` bash\n$ cd /tmp\n$ wget --no-check-certificate https://github.com/MasaoFujii/pg_disallow_utility/archive/master.zip\n$ unzip master\n$ rm -f master\n$ cd pg_disallow_utility-master\n$ make USE_PGXS=1 PG_CONFIG=/opt/pgsql-X.Y.Z/bin/pg_config\n$ make USE_PGXS=1 PG_CONFIG=/opt/pgsql-X.Y.Z/bin/pg_config install\n\n$ emacs $PGDATA/postgresql.conf\nshared_preload_libraries = 'pg_cheat_funcs, pg_disallow_utility'\npg_disallow_utility.alter_system = on\npg_disallow_utility.copy_program = on\n\n$ pg_ctl -D $PGDATA restart\n```\n"}