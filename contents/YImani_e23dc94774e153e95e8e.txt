{"context": "\u5404\u30b9\u30ca\u30c3\u30d7\u9593\u306b\u304a\u3051\u308b\u4e0a\u4f4d5\u3064\u306e\u5f85\u6a5f\u30a4\u30d9\u30f3\u30c8\u3092csv\u5f62\u5f0f\u3067\u51fa\u529b\u3059\u308b\u30b9\u30af\u30ea\u30d7\u30c8\u3067\u3059\u3002\n\nget_top5_wait_event.sql\nset serveroutput on\nset linesize 10000\nset pagesize 0\nset trimspool on\nset termout off\n\nspool top5_wait_event.log\nprompt begin_snapid,yyyy,mm,dd,hh,end_snapid,instance_num,event,waits,time\n\ndeclare\n  event varchar2(100);\n  waits number;\n  time  number;\nbegin\n  for snlp in\n  (\n    select\n            bsn.SNAP_ID bsid,\n            esn.SNAP_ID esid,\n            to_char(bsn.END_INTERVAL_TIME,'yyyy') yyyy,\n            to_char(bsn.END_INTERVAL_TIME,'mm')   mm,\n            to_char(bsn.END_INTERVAL_TIME,'dd')   dd,\n            to_char(bsn.END_INTERVAL_TIME,'hh24') hh,\n            bsn.INSTANCE_NUMBER inum\n    from \n            DBA_HIST_SNAPSHOT bsn,\n            DBA_HIST_SNAPSHOT esn\n    where\n            bsn.DBID = esn.DBID\n        and bsn.INSTANCE_NUMBER = esn.INSTANCE_NUMBER\n        and bsn.END_INTERVAL_TIME = esn.BEGIN_INTERVAL_TIME\n        and bsn.STARTUP_TIME = esn.STARTUP_TIME\n        and bsn.END_INTERVAL_TIME >= to_date('2016/04/05 09:50','yyyy/mm/dd hh24:mi')\n        and esn.END_INTERVAL_TIME <= to_date('2016/04/08 12:10','yyyy/mm/dd hh24:mi')\n  ) loop\n\n      for evlst in\n      (\n        select\n                event, waits, time\n        from\n        (   \n            select\n                event,\n                wtfg waits ,\n                tmfg/1000000 time\n            from\n            (\n                select \n                     e.EVENT_NAME event,\n                     case  when e.TOTAL_WAITS_FG is not null\n                           then e.TOTAL_WAITS_FG - nvl(b.total_waits_fg,0)\n                           else (e.TOTAL_WAITS - nvl(b.TOTAL_WAITS,0))\n                                 - greatest(0, (nvl(ebg.TOTAL_WAITS,0)\n                                 - nvl(bbg.TOTAL_WAITS,0)))\n                     end  wtfg,\n                     case when e.TIME_WAITED_MICRO_FG is not null\n                          then e.TIME_WAITED_MICRO_FG - nvl(b.TIME_WAITED_MICRO_FG,0)\n                          else (e.TIME_WAITED_MICRO - nvl(b.TIME_WAITED_MICRO,0))\n                                - greatest(0,(nvl(ebg.TIME_WAITED_MICRO,0)\n                                - nvl(bbg.TIME_WAITED_MICRO,0)))\n                     end tmfg\n                from\n                     DBA_HIST_SYSTEM_EVENT b,\n                     DBA_HIST_SYSTEM_EVENT e,\n                     DBA_HIST_BG_EVENT_SUMMARY bbg,\n                     DBA_HIST_BG_EVENT_SUMMARY ebg\n                where\n                       b.SNAP_ID  (+)  = snlp.bsid\n                   and e.SNAP_ID       = snlp.esid\n                   and bbg.SNAP_ID (+) = snlp.bsid\n                   and ebg.SNAP_ID (+) = snlp.esid\n                   and e.INSTANCE_NUMBER = snlp.inum\n                   and e.DBID = b.DBID (+)\n                   and e.INSTANCE_NUMBER = b.INSTANCE_NUMBER (+)\n                   and e.EVENT_ID        = b.EVENT_ID (+)\n                   and e.DBID            = ebg.DBID (+)\n                   and e.INSTANCE_NUMBER = ebg.INSTANCE_NUMBER (+)\n                   and e.EVENT_ID        = ebg.EVENT_ID (+)\n                   and e.DBID            = bbg.DBID (+)\n                   and e.INSTANCE_NUMBER = bbg.INSTANCE_NUMBER (+)\n                   and e.EVENT_ID        = bbg.EVENT_ID (+)\n                   and e.TOTAL_WAITS     > nvl(b.TOTAL_WAITS,0)\n                   and e.WAIT_CLASS     <> 'Idle'\n                union all\n                select\n                    'DB CPU' event, \n                     to_number(null)  wtfg,\n                     (esy.VALUE - bsy.VALUE) tmfg\n                from\n                     DBA_HIST_SYS_TIME_MODEL  bsy,\n                     DBA_HIST_SYS_TIME_MODEL  esy\n                where\n                       bsy.SNAP_ID  (+)  = snlp.bsid\n                   and esy.SNAP_ID       = snlp.esid\n                   and bsy.INSTANCE_NUMBER = snlp.inum\n                   and esy.INSTANCE_NUMBER = snlp.inum\n                   and bsy.STAT_NAME = esy.STAT_NAME\n                   and bsy.STAT_NAME = 'DB CPU'\n            ) \n            order by tmfg desc,\n                     wtfg desc\n        )\n        where rownum <= 5\n      ) loop\n           dbms_output.put_line(\n                              '\"'|| snlp.bsid\n                           || '\",\"'|| snlp.yyyy\n                           || '\",\"'|| snlp.mm\n                           || '\",\"'|| snlp.dd\n                           || '\",\"'|| snlp.hh\n                           || '\",\"'|| snlp.esid\n                           || '\",\"'|| snlp.inum\n                           || '\",\"'|| evlst.event\n                           || '\",\"'|| evlst.waits\n                           || '\",\"'|| evlst.time ||'\"');\n\n      end loop;\n\n  end loop;\nend;\n/\nspool off\n/\n\n\n\nExcel\u306b\u53d6\u308a\u8fbc\u307f\u3001\u30d4\u30dc\u30c3\u30c8\u30b0\u30e9\u30d5\u3067\u30b0\u30e9\u30d5\u5316\u3059\u308b\u3068\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u30a4\u30e1\u30fc\u30b8\u306b\u306a\u308a\u307e\u3059\u3002\n\n\uff08SQL\u306fDB12.1.0.2\u306b\u3066\u8a66\u884c\uff09\n\u5404\u30b9\u30ca\u30c3\u30d7\u9593\u306b\u304a\u3051\u308b\u4e0a\u4f4d5\u3064\u306e\u5f85\u6a5f\u30a4\u30d9\u30f3\u30c8\u3092csv\u5f62\u5f0f\u3067\u51fa\u529b\u3059\u308b\u30b9\u30af\u30ea\u30d7\u30c8\u3067\u3059\u3002\n\n```sql:get_top5_wait_event.sql\nset serveroutput on\nset linesize 10000\nset pagesize 0\nset trimspool on\nset termout off\n\nspool top5_wait_event.log\nprompt begin_snapid,yyyy,mm,dd,hh,end_snapid,instance_num,event,waits,time\n\ndeclare\n  event varchar2(100);\n  waits number;\n  time  number;\nbegin\n  for snlp in\n  (\n    select\n            bsn.SNAP_ID bsid,\n            esn.SNAP_ID esid,\n            to_char(bsn.END_INTERVAL_TIME,'yyyy') yyyy,\n            to_char(bsn.END_INTERVAL_TIME,'mm')   mm,\n            to_char(bsn.END_INTERVAL_TIME,'dd')   dd,\n            to_char(bsn.END_INTERVAL_TIME,'hh24') hh,\n            bsn.INSTANCE_NUMBER inum\n    from \n            DBA_HIST_SNAPSHOT bsn,\n            DBA_HIST_SNAPSHOT esn\n    where\n            bsn.DBID = esn.DBID\n        and bsn.INSTANCE_NUMBER = esn.INSTANCE_NUMBER\n        and bsn.END_INTERVAL_TIME = esn.BEGIN_INTERVAL_TIME\n        and bsn.STARTUP_TIME = esn.STARTUP_TIME\n        and bsn.END_INTERVAL_TIME >= to_date('2016/04/05 09:50','yyyy/mm/dd hh24:mi')\n        and esn.END_INTERVAL_TIME <= to_date('2016/04/08 12:10','yyyy/mm/dd hh24:mi')\n  ) loop\n\n      for evlst in\n      (\n        select\n                event, waits, time\n        from\n        (   \n            select\n                event,\n                wtfg waits ,\n                tmfg/1000000 time\n            from\n            (\n                select \n                     e.EVENT_NAME event,\n                     case  when e.TOTAL_WAITS_FG is not null\n                           then e.TOTAL_WAITS_FG - nvl(b.total_waits_fg,0)\n                           else (e.TOTAL_WAITS - nvl(b.TOTAL_WAITS,0))\n                                 - greatest(0, (nvl(ebg.TOTAL_WAITS,0)\n                                 - nvl(bbg.TOTAL_WAITS,0)))\n                     end  wtfg,\n                     case when e.TIME_WAITED_MICRO_FG is not null\n                          then e.TIME_WAITED_MICRO_FG - nvl(b.TIME_WAITED_MICRO_FG,0)\n                          else (e.TIME_WAITED_MICRO - nvl(b.TIME_WAITED_MICRO,0))\n                                - greatest(0,(nvl(ebg.TIME_WAITED_MICRO,0)\n                                - nvl(bbg.TIME_WAITED_MICRO,0)))\n                     end tmfg\n                from\n                     DBA_HIST_SYSTEM_EVENT b,\n                     DBA_HIST_SYSTEM_EVENT e,\n                     DBA_HIST_BG_EVENT_SUMMARY bbg,\n                     DBA_HIST_BG_EVENT_SUMMARY ebg\n                where\n                       b.SNAP_ID  (+)  = snlp.bsid\n                   and e.SNAP_ID       = snlp.esid\n                   and bbg.SNAP_ID (+) = snlp.bsid\n                   and ebg.SNAP_ID (+) = snlp.esid\n                   and e.INSTANCE_NUMBER = snlp.inum\n                   and e.DBID = b.DBID (+)\n                   and e.INSTANCE_NUMBER = b.INSTANCE_NUMBER (+)\n                   and e.EVENT_ID        = b.EVENT_ID (+)\n                   and e.DBID            = ebg.DBID (+)\n                   and e.INSTANCE_NUMBER = ebg.INSTANCE_NUMBER (+)\n                   and e.EVENT_ID        = ebg.EVENT_ID (+)\n                   and e.DBID            = bbg.DBID (+)\n                   and e.INSTANCE_NUMBER = bbg.INSTANCE_NUMBER (+)\n                   and e.EVENT_ID        = bbg.EVENT_ID (+)\n                   and e.TOTAL_WAITS     > nvl(b.TOTAL_WAITS,0)\n                   and e.WAIT_CLASS     <> 'Idle'\n                union all\n                select\n                    'DB CPU' event, \n                     to_number(null)  wtfg,\n                     (esy.VALUE - bsy.VALUE) tmfg\n                from\n                     DBA_HIST_SYS_TIME_MODEL  bsy,\n                     DBA_HIST_SYS_TIME_MODEL  esy\n                where\n                       bsy.SNAP_ID  (+)  = snlp.bsid\n                   and esy.SNAP_ID       = snlp.esid\n                   and bsy.INSTANCE_NUMBER = snlp.inum\n                   and esy.INSTANCE_NUMBER = snlp.inum\n                   and bsy.STAT_NAME = esy.STAT_NAME\n                   and bsy.STAT_NAME = 'DB CPU'\n            ) \n            order by tmfg desc,\n                     wtfg desc\n        )\n        where rownum <= 5\n      ) loop\n           dbms_output.put_line(\n                              '\"'|| snlp.bsid\n                           || '\",\"'|| snlp.yyyy\n                           || '\",\"'|| snlp.mm\n                           || '\",\"'|| snlp.dd\n                           || '\",\"'|| snlp.hh\n                           || '\",\"'|| snlp.esid\n                           || '\",\"'|| snlp.inum\n                           || '\",\"'|| evlst.event\n                           || '\",\"'|| evlst.waits\n                           || '\",\"'|| evlst.time ||'\"');\n\n      end loop;\n\n  end loop;\nend;\n/\nspool off\n/\n\n```\n\nExcel\u306b\u53d6\u308a\u8fbc\u307f\u3001\u30d4\u30dc\u30c3\u30c8\u30b0\u30e9\u30d5\u3067\u30b0\u30e9\u30d5\u5316\u3059\u308b\u3068\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u30a4\u30e1\u30fc\u30b8\u306b\u306a\u308a\u307e\u3059\u3002\n![wait_event.png](https://qiita-image-store.s3.amazonaws.com/0/120705/05aa1c8a-9f99-71fd-fcb7-c63b79786a15.png)\n\n\uff08SQL\u306fDB12.1.0.2\u306b\u3066\u8a66\u884c\uff09\n", "tags": ["oracle", "Sqlplus", "SQL", "awr"]}