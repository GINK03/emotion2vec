{"tags": ["PHP", "CodeIgniter", "ActiveRecord", "SQL", "MySQL"], "context": "\u682a\u5f0f\u4f1a\u793e\u30aa\u30ba\u30d3\u30b8\u30e7\u30f3\u306e@terra_yucco\u3067\u3059\u3002\n\u696d\u52d9\u958b\u767a\u3067\u3001SQL\u306e\u6539\u5584\u3092\u884c\u3044\u3064\u3064\u3001\u5e73\u6587\u3067\u66f8\u304b\u308c\u3066\u3044\u305fSQL\u3092ActiveRecord\u3092\u5229\u7528\u3057\u3066\u30ea\u30d5\u30a1\u30af\u30bf\u30ea\u30f3\u30b0\u3057\u307e\u3057\u305f\u3002\n\u53c2\u8003\u306b\u3057\u305f\u30b5\u30a4\u30c8\u3084StackOverFlow\u3092\u6dfb\u3048\u3066\u5bfe\u5fdc\u8a18\u9332\u3092\u6b8b\u3057\u3066\u304a\u3053\u3046\u3068\u601d\u3044\u307e\u3059\u3002\n\u304a\u56f0\u308a\u306e\u7686\u3055\u3093\u306e\u53c2\u8003\u306b\u306a\u308c\u3070\u5e78\u3044\u3067\u3059\uff01\n\n\u5143\u306e\u51e6\u7406\n\nSQL\u3063\u3066\u3044\u3046\u304b\u30b3\u30fc\u30c9\nfunction getGiftCodeStatus()\n{\n    $gift = $this->load->database('dummy', true);\n    $sql = \"SELECT type, value,\n            SUM(CASE WHEN user_id IS NULL THEN value ELSE 0 END) AS total,\n            MIN(CASE WHEN user_id IS NULL THEN gift_limit ELSE NULL END) AS min_gift_limit\n            FROM gift_code\n            GROUP BY type, value\n            ORDER BY type, value\";\n    return $gift->query($sql)->result();\n}\n\n\n\u30c6\u30fc\u30d6\u30eb\u69cb\u9020\n\n\u5b9f\u969b\u306e\u3082\u306e\u3092\u3042\u308b\u7a0b\u5ea6\u307c\u304b\u3057\u3066\u3044\u308b\u306e\u3067\u3001\u4e0d\u6574\u5408\u306f\u76ee\u3092\u7791\u3063\u3066\u304f\u3060\u3055\u3044\n\nmysql> desc gift_code;\n+----------------+--------------+------+-----+---------------------+-----------------------------+\n| Field          | Type         | Null | Key | Default             | Extra                       |\n+----------------+--------------+------+-----+---------------------+-----------------------------+\n| id             | bigint(20)   | NO   | PRI | NULL                | auto_increment              |\n| gift_code      | text         | NO   |     | NULL                |                             |\n| type           | varchar(32)  | NO   | MUL | NULL                |                             |\n| value          | int(11)      | NO   |     | NULL                |                             |\n| gift_limit     | varchar(16)  | YES  |     | NULL                |                             |\n| note_id        | bigint(20)   | YES  | MUL | NULL                |                             |\n| multiple_count | int(11)      | NO   |     | NULL                |                             |\n| user_id        | int(11)      | YES  | MUL | NULL                |                             |\n| sys_ins_date   | timestamp    | NO   |     | 0000-00-00 00:00:00 |                             |\n| sys_upd_date   | timestamp    | NO   |     | CURRENT_TIMESTAMP   | on update CURRENT_TIMESTAMP |\n+----------------+--------------+------+-----+---------------------+-----------------------------+\n11 rows in set (0.00 sec)\n\n\n\u767a\u884cSQL\u3092\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u5909\u66f4\u3057\u305f\u3044\n\nbefore\n\nSELECT\n  type,\n  value,\n  SUM(CASE WHEN user_id IS NULL THEN value ELSE 0 END) AS total,\n  MIN(CASE WHEN user_id IS NULL THEN gift_limit ELSE NULL END) AS min_gift_limit\nFROM\n  gift_code\nGROUP BY\n  type, value\nORDER BY\n  type, value\n\n\nafter\n\nSELECT\n  type,\n  value,\n  SUM(value) AS total,\n  MIN(gift_limit) AS min_gift_limit\nFROM\n  gift_code\nWHERE\n  user_id is null\nGROUP BY\n  type, value\nORDER BY\n  type, value\n\n\nexplain\u306e\u7d50\u679c (before)\nmysql> explain SELECT type, value, SUM(CASE WHEN user_id IS NULL THEN value ELSE 0 END) AS total, MIN(CASE WHEN user_id IS NULL THEN gift_limit ELSE NULL END) AS min_gift_limit FROM gift_code GROUP BY type,value ORDER BY type,value;\n\n+----+-------------+-----------+------+---------------+------+---------+------+--------+---------------------------------+\n| id | select_type | table     | type | possible_keys | key  | key_len | ref  | rows   | Extra                           |\n+----+-------------+-----------+------+---------------+------+---------+------+--------+---------------------------------+\n|  1 | SIMPLE      | gift_code | ALL  | NULL          | NULL | NULL    | NULL | 965718 | Using temporary; Using filesort |\n+----+-------------+-----------+------+---------------+------+---------+------+--------+---------------------------------+\n1 row in set (0.00 sec)\n\n\nexplain\u306e\u7d50\u679c (after)\nmysql> explain SELECT type, value, SUM(value) AS total, MIN(gift_limit) AS min_gift_limit FROM gift_code WHERE user_id is null GROUP BY type, value ORDER BY type, value;\n\n+----+-------------+-----------+------+---------------+-----------+---------+-------+-------+---------------------------------------------------------------------+\n| id | select_type | table     | type | possible_keys | key       | key_len | ref   | rows  | Extra                                                               |\n+----+-------------+-----------+------+---------------+-----------+---------+-------+-------+---------------------------------------------------------------------+\n|  1 | SIMPLE      | gift_code | ref  | user_id       | user_id   | 5       | const | 48244 | Using index condition; Using where; Using temporary; Using filesort |\n+----+-------------+-----------+------+---------------+-----------+---------+-------+-------+---------------------------------------------------------------------+\n1 row in set (0.01 sec)\n\n\n\u6539\u5584\u5f8c\u306e\u30b3\u30fc\u30c9\n\n\u53c2\u8003\u306b\u3057\u305f\u30ea\u30f3\u30af\n\nActiveRecord\u306eselect\u3067SUM\u3092\u53d6\u308a\u305f\u3044\n\n\nhttp://stackoverflow.com/questions/22219709/get-the-result-of-sum-and-group-field-from-active-record-in-codeigniter\n\n\nActiveRecord\u306ewhere\u3067IS NULL\u3092\u3084\u308a\u305f\u3044\n\n\nhttp://kihon-no-ki.com/codeigniter-select-null-or-is-not-null\n\n\nActiveRecord\u306egroup by\u3092\u8907\u6570\u30d5\u30a3\u30fc\u30eb\u30c9\u3067\u884c\u3046\n\n\nhttp://stackoverflow.com/questions/34012566/group-by-three-columns-doesnt-work-in-codeigniter\n\n\nActiveRecord\u306eorder by\u3092\u8907\u6570\u30d5\u30a3\u30fc\u30eb\u30c9\u3067\u884c\u3046\n\n\n\u3053\u308c\u3060\u3051\u826f\u3044\u7d50\u679c\u304c\u898b\u3064\u304b\u3089\u306a\u304b\u3063\u305f\u306e\u3067\u3001select\u306e\u691c\u7d22\u7d50\u679c\u306e\u30a2\u30c9\u30d0\u30a4\u30b9\u3092\u53d6\u308a\u5165\u308c\u3001\u30ab\u30b9\u30bf\u30e0\u30bb\u30f3\u30c6\u30f3\u30b9\u306b\u3057\u3066\u3044\u307e\u3059\u3002\n\u300cSetting FALSE as second parameter, 'select' allows to write a custom sentence.\u300d\n\n\n\n/**\n * \u30ae\u30d5\u30c8\u30b3\u30fc\u30c9\u306e\u6b8b\u9ad8\u3092\u7a2e\u5225\u3001\u5238\u7a2e\u3054\u3068\u306b\u53d6\u5f97\u3059\u308b\n *\n * @return array\n */\npublic function getGiftCodeStatus()\n{\n    $gift = $this->load->database('dummy', true);\n\n    $gift->select('type, value, SUM(value) AS total, MIN(gift_limit) AS min_gift_limit', false);\n    $gift->where('user_id', null);\n    $gift->group_by(array('type', 'value'));\n    $gift->order_by('type, value', false);\n    return $gift->get('gift_code')->result();\n}\n\n\n\u304a\u308f\u308a\u306b\n\u4e0a\u8a18\u306e\u6539\u5584\u524d\u306bINDEX\u3092\u8ffd\u52a0\u3057\u305f\u5bfe\u5fdc\u304c\u3042\u308a(\u305d\u3082\u305d\u3082\u4e0a\u8a18table\u306b\u306fPK\u3057\u304bindex\u3042\u308a\u307e\u305b\u3093\u3067\u3057\u305f)\u3001\n\u305d\u308c\u3060\u3051\u3067\u3082\u51e6\u7406\u306e\u5fdc\u7b54\u901f\u5ea6\u306f2s\u7a0b\u5ea6\u6539\u5584\u3055\u308c\u305f\u306e\u3067\u3059\u304c(9s\u21927s)\u3001\n\u307e\u3060\u307e\u3060\u9045\u3044\u3068\u3044\u3046\u3053\u3068\u3067\u884c\u304a\u3046\u3068\u3057\u3066\u3044\u308b\u5bfe\u5fdc\u306b\u306a\u308a\u307e\u3059\u3002\n\u3069\u308c\u3060\u3051\u901f\u304f\u3067\u304d\u308b\u304b\u304c\u4eca\u304b\u3089\u697d\u3057\u307f\u3067\u3059\uff01\n\u3053\u306e\u6a5f\u80fd\u306f\u5f0a\u793e\u306e\u63d0\u4f9b\u30b5\u30fc\u30d3\u30b9\u306e\u3001\u7ba1\u7406\u753b\u9762\u5074\u306e\u6a5f\u80fd\u306b\u306a\u308a\u307e\u3059\u3002\n\u30aa\u30ba\u30d3\u30b8\u30e7\u30f3\u3067\u306f\u83ef\u3084\u304b\u306a\u8868\u30b5\u30a4\u30c8\u5074\u3060\u3051\u3067\u306a\u304f\u3001\u7ba1\u7406\u753b\u9762\u5074\u3092\u6539\u5584\u3057\u3066\u3044\u3051\u308b\u30a8\u30f3\u30b8\u30cb\u30a2\u3082\u5168\u529b\u3067\u52df\u96c6\u3057\u3066\u3044\u307e\u3059\uff01\n\u305c\u3072\u3001\u6c17\u306b\u306a\u308a\u307e\u3057\u305f\u3089\u3001@terra_yucco \u307e\u3067\u304a\u6c17\u8efd\u306b\u304a\u58f0\u639b\u3051\u304f\u3060\u3055\u3044\uff01\n\u305d\u308c\u3067\u306f\u307e\u305f\u6b21\u306e\u6295\u7a3f\u3067\u304a\u4f1a\u3044\u3057\u307e\u3057\u3087\u3046\u3002\n\u304a\u3057\u307e\u3044\u3002\n[\u682a\u5f0f\u4f1a\u793e\u30aa\u30ba\u30d3\u30b8\u30e7\u30f3](http://www.oz-vision.co.jp/)\u306e@terra_yucco\u3067\u3059\u3002\n\n\u696d\u52d9\u958b\u767a\u3067\u3001SQL\u306e\u6539\u5584\u3092\u884c\u3044\u3064\u3064\u3001\u5e73\u6587\u3067\u66f8\u304b\u308c\u3066\u3044\u305fSQL\u3092ActiveRecord\u3092\u5229\u7528\u3057\u3066\u30ea\u30d5\u30a1\u30af\u30bf\u30ea\u30f3\u30b0\u3057\u307e\u3057\u305f\u3002\n\u53c2\u8003\u306b\u3057\u305f\u30b5\u30a4\u30c8\u3084StackOverFlow\u3092\u6dfb\u3048\u3066\u5bfe\u5fdc\u8a18\u9332\u3092\u6b8b\u3057\u3066\u304a\u3053\u3046\u3068\u601d\u3044\u307e\u3059\u3002\n\u304a\u56f0\u308a\u306e\u7686\u3055\u3093\u306e\u53c2\u8003\u306b\u306a\u308c\u3070\u5e78\u3044\u3067\u3059\uff01\n\n# \u5143\u306e\u51e6\u7406\n## SQL\u3063\u3066\u3044\u3046\u304b\u30b3\u30fc\u30c9\n```php\nfunction getGiftCodeStatus()\n{\n    $gift = $this->load->database('dummy', true);\n    $sql = \"SELECT type, value,\n            SUM(CASE WHEN user_id IS NULL THEN value ELSE 0 END) AS total,\n            MIN(CASE WHEN user_id IS NULL THEN gift_limit ELSE NULL END) AS min_gift_limit\n            FROM gift_code\n            GROUP BY type, value\n            ORDER BY type, value\";\n    return $gift->query($sql)->result();\n}\n```\n## \u30c6\u30fc\u30d6\u30eb\u69cb\u9020\n- \u5b9f\u969b\u306e\u3082\u306e\u3092\u3042\u308b\u7a0b\u5ea6\u307c\u304b\u3057\u3066\u3044\u308b\u306e\u3067\u3001\u4e0d\u6574\u5408\u306f\u76ee\u3092\u7791\u3063\u3066\u304f\u3060\u3055\u3044\n\n```sql\nmysql> desc gift_code;\n+----------------+--------------+------+-----+---------------------+-----------------------------+\n| Field          | Type         | Null | Key | Default             | Extra                       |\n+----------------+--------------+------+-----+---------------------+-----------------------------+\n| id             | bigint(20)   | NO   | PRI | NULL                | auto_increment              |\n| gift_code      | text         | NO   |     | NULL                |                             |\n| type           | varchar(32)  | NO   | MUL | NULL                |                             |\n| value          | int(11)      | NO   |     | NULL                |                             |\n| gift_limit     | varchar(16)  | YES  |     | NULL                |                             |\n| note_id        | bigint(20)   | YES  | MUL | NULL                |                             |\n| multiple_count | int(11)      | NO   |     | NULL                |                             |\n| user_id        | int(11)      | YES  | MUL | NULL                |                             |\n| sys_ins_date   | timestamp    | NO   |     | 0000-00-00 00:00:00 |                             |\n| sys_upd_date   | timestamp    | NO   |     | CURRENT_TIMESTAMP   | on update CURRENT_TIMESTAMP |\n+----------------+--------------+------+-----+---------------------+-----------------------------+\n11 rows in set (0.00 sec)\n```\n\n# \u767a\u884cSQL\u3092\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u5909\u66f4\u3057\u305f\u3044\n- before\n\n```sql\nSELECT\n  type,\n  value,\n  SUM(CASE WHEN user_id IS NULL THEN value ELSE 0 END) AS total,\n  MIN(CASE WHEN user_id IS NULL THEN gift_limit ELSE NULL END) AS min_gift_limit\nFROM\n  gift_code\nGROUP BY\n  type, value\nORDER BY\n  type, value\n```\n\n- after\n \n```sql\nSELECT\n  type,\n  value,\n  SUM(value) AS total,\n  MIN(gift_limit) AS min_gift_limit\nFROM\n  gift_code\nWHERE\n  user_id is null\nGROUP BY\n  type, value\nORDER BY\n  type, value\n```\n\n## explain\u306e\u7d50\u679c (before)\n```sql\nmysql> explain SELECT type, value, SUM(CASE WHEN user_id IS NULL THEN value ELSE 0 END) AS total, MIN(CASE WHEN user_id IS NULL THEN gift_limit ELSE NULL END) AS min_gift_limit FROM gift_code GROUP BY type,value ORDER BY type,value;\n\n+----+-------------+-----------+------+---------------+------+---------+------+--------+---------------------------------+\n| id | select_type | table     | type | possible_keys | key  | key_len | ref  | rows   | Extra                           |\n+----+-------------+-----------+------+---------------+------+---------+------+--------+---------------------------------+\n|  1 | SIMPLE      | gift_code | ALL  | NULL          | NULL | NULL    | NULL | 965718 | Using temporary; Using filesort |\n+----+-------------+-----------+------+---------------+------+---------+------+--------+---------------------------------+\n1 row in set (0.00 sec)\n```\n\n## explain\u306e\u7d50\u679c (after)\n```sql\nmysql> explain SELECT type, value, SUM(value) AS total, MIN(gift_limit) AS min_gift_limit FROM gift_code WHERE user_id is null GROUP BY type, value ORDER BY type, value;\n\n+----+-------------+-----------+------+---------------+-----------+---------+-------+-------+---------------------------------------------------------------------+\n| id | select_type | table     | type | possible_keys | key       | key_len | ref   | rows  | Extra                                                               |\n+----+-------------+-----------+------+---------------+-----------+---------+-------+-------+---------------------------------------------------------------------+\n|  1 | SIMPLE      | gift_code | ref  | user_id       | user_id   | 5       | const | 48244 | Using index condition; Using where; Using temporary; Using filesort |\n+----+-------------+-----------+------+---------------+-----------+---------+-------+-------+---------------------------------------------------------------------+\n1 row in set (0.01 sec)\n```\n\n# \u6539\u5584\u5f8c\u306e\u30b3\u30fc\u30c9\n## \u53c2\u8003\u306b\u3057\u305f\u30ea\u30f3\u30af\n- ActiveRecord\u306eselect\u3067SUM\u3092\u53d6\u308a\u305f\u3044\n    - http://stackoverflow.com/questions/22219709/get-the-result-of-sum-and-group-field-from-active-record-in-codeigniter\n- ActiveRecord\u306ewhere\u3067`IS NULL`\u3092\u3084\u308a\u305f\u3044\n    - http://kihon-no-ki.com/codeigniter-select-null-or-is-not-null\n- ActiveRecord\u306egroup by\u3092\u8907\u6570\u30d5\u30a3\u30fc\u30eb\u30c9\u3067\u884c\u3046\n    - http://stackoverflow.com/questions/34012566/group-by-three-columns-doesnt-work-in-codeigniter\n- ActiveRecord\u306eorder by\u3092\u8907\u6570\u30d5\u30a3\u30fc\u30eb\u30c9\u3067\u884c\u3046\n    - \u3053\u308c\u3060\u3051\u826f\u3044\u7d50\u679c\u304c\u898b\u3064\u304b\u3089\u306a\u304b\u3063\u305f\u306e\u3067\u3001select\u306e\u691c\u7d22\u7d50\u679c\u306e\u30a2\u30c9\u30d0\u30a4\u30b9\u3092\u53d6\u308a\u5165\u308c\u3001\u30ab\u30b9\u30bf\u30e0\u30bb\u30f3\u30c6\u30f3\u30b9\u306b\u3057\u3066\u3044\u307e\u3059\u3002\n    - \u300cSetting FALSE as second parameter, 'select' allows to write a custom sentence.\u300d\n\n```php\n/**\n * \u30ae\u30d5\u30c8\u30b3\u30fc\u30c9\u306e\u6b8b\u9ad8\u3092\u7a2e\u5225\u3001\u5238\u7a2e\u3054\u3068\u306b\u53d6\u5f97\u3059\u308b\n *\n * @return array\n */\npublic function getGiftCodeStatus()\n{\n    $gift = $this->load->database('dummy', true);\n\n    $gift->select('type, value, SUM(value) AS total, MIN(gift_limit) AS min_gift_limit', false);\n    $gift->where('user_id', null);\n    $gift->group_by(array('type', 'value'));\n    $gift->order_by('type, value', false);\n    return $gift->get('gift_code')->result();\n}\n```\n\n# \u304a\u308f\u308a\u306b\n\u4e0a\u8a18\u306e\u6539\u5584\u524d\u306bINDEX\u3092\u8ffd\u52a0\u3057\u305f\u5bfe\u5fdc\u304c\u3042\u308a(\u305d\u3082\u305d\u3082\u4e0a\u8a18table\u306b\u306fPK\u3057\u304bindex\u3042\u308a\u307e\u305b\u3093\u3067\u3057\u305f)\u3001\n\u305d\u308c\u3060\u3051\u3067\u3082\u51e6\u7406\u306e\u5fdc\u7b54\u901f\u5ea6\u306f2s\u7a0b\u5ea6\u6539\u5584\u3055\u308c\u305f\u306e\u3067\u3059\u304c(9s\u21927s)\u3001\n\u307e\u3060\u307e\u3060\u9045\u3044\u3068\u3044\u3046\u3053\u3068\u3067\u884c\u304a\u3046\u3068\u3057\u3066\u3044\u308b\u5bfe\u5fdc\u306b\u306a\u308a\u307e\u3059\u3002\n\u3069\u308c\u3060\u3051\u901f\u304f\u3067\u304d\u308b\u304b\u304c\u4eca\u304b\u3089\u697d\u3057\u307f\u3067\u3059\uff01\n\n\u3053\u306e\u6a5f\u80fd\u306f\u5f0a\u793e\u306e\u63d0\u4f9b\u30b5\u30fc\u30d3\u30b9\u306e\u3001\u7ba1\u7406\u753b\u9762\u5074\u306e\u6a5f\u80fd\u306b\u306a\u308a\u307e\u3059\u3002\n\u30aa\u30ba\u30d3\u30b8\u30e7\u30f3\u3067\u306f\u83ef\u3084\u304b\u306a\u8868\u30b5\u30a4\u30c8\u5074\u3060\u3051\u3067\u306a\u304f\u3001\u7ba1\u7406\u753b\u9762\u5074\u3092\u6539\u5584\u3057\u3066\u3044\u3051\u308b\u30a8\u30f3\u30b8\u30cb\u30a2\u3082\u5168\u529b\u3067\u52df\u96c6\u3057\u3066\u3044\u307e\u3059\uff01\n\u305c\u3072\u3001\u6c17\u306b\u306a\u308a\u307e\u3057\u305f\u3089\u3001@terra_yucco \u307e\u3067\u304a\u6c17\u8efd\u306b\u304a\u58f0\u639b\u3051\u304f\u3060\u3055\u3044\uff01\n\n\u305d\u308c\u3067\u306f\u307e\u305f\u6b21\u306e\u6295\u7a3f\u3067\u304a\u4f1a\u3044\u3057\u307e\u3057\u3087\u3046\u3002\n\u304a\u3057\u307e\u3044\u3002\n"}