{"context": " More than 1 year has passed since last update.\nDebian Jessie \u3067\u3084\u3063\u3066\u307f\u305f\n\n\n\u30ad\u30fc\u306e\u78ba\u8a8d\u3092\u30b3\u30de\u30f3\u30c9\u3067\u3084\u308b\n/etc/sshd/sshd_config:\nPasswordAuthentication no\n\nAuthorizedKeysCommand  /root/auth.bash\nAuthorizedKeysCommandUser root\n\n/root/auth.bash :\n#!/bin/bash\n\nLOG=/tmp/root.txt\n\ndate >> $LOG\necho $@ >> $LOG\ncat `dirname $0`/auth.key\n\n/root/auth.key \u306b\u30ad\u30fc\u3092\u767b\u9332\u3059\u308b\u3068\u30ed\u30b0\u30a4\u30f3\u3067\u304d\u305f:\nvagrant@10:~$ ssh vagrant@localhost\n\nYou have new mail.\nLast login: Thu Jan  8 06:16:50 2015 from ::1\n\nvagrant \u306b\u30ed\u30b0\u30a4\u30f3\u8981\u6c42\u304c\u6765\u3066\u308b:\nroot@10:/tmp# tail /tmp/root.txt \nThu Jan  8 06:16:50 UTC 2015\nvagrant\n\n\n\u30e6\u30fc\u30b6\u3092\u5909\u3048\u3066\u307f\u308b\nLogLevel ERROR\n\nAuthorizedKeysCommand  /home/vagrant/projects/sshkey/auth.bash\nAuthorizedKeysCommandUser vagrant\n\n\n# tail -f /var/log/auth.log\n\nJan  8 06:32:39 10 sshd[20926]: \nerror: Unsafe AuthorizedKeysCommand: \nbad ownership or modes for file /home/vagrant/projects/sshkey/auth.bash\n\nvagrant@10:~/projects/sshkey$ ls -al\ntotal 20\ndrwx------  3 vagrant vagrant 4096 Jan  8 06:27 .\ndrwxr-xr-x 10 vagrant vagrant 4096 Jan  8 04:54 ..\n-rwx------  1 vagrant vagrant   90 Jan  8 06:22 auth.bash\n-rw-------  1 vagrant vagrant  801 Jan  8 06:21 auth.key\n\n\n\n\u3053\u3053\u3092\u307f\u308b\u3068root\u4ee5\u5916\u306f\u30a8\u30e9\u30fc\u304c\u3067\u308b\u3063\u307d\u3044\u3002\nsshkey\u4ee5\u4e0b\u3092root\u6240\u6709\u306b\u5909\u3048\u3066AuthorizedKeysCommandUser=root\u306b\u3059\u308b\u3068\u3001sshkey\u306e\u89aa\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3067\u3001bad ownership \u306b\u306a\u308b\u3002\n\u304a\u3068\u306a\u3057\u304froot\u3067\u3084\u3063\u305f\u307b\u3046\u304c\u3044\u3044\u3067\u3057\u3087\u3046\n\n\nDjango\u3067\u30ad\u30fc\u7ba1\u7406\n\nkeys \u30a2\u30d7\u30ea\nkeys\n\u251c\u2500\u2500 admin.py\n\u251c\u2500\u2500 __init__.py\n\u251c\u2500\u2500 management\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 commands\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 __init__.py\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2514\u2500\u2500 sshkeys.py\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 __init__.py\n\u251c\u2500\u2500 migrations\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 0001_initial.py\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 __init__.py\n\u251c\u2500\u2500 models.py\n\u251c\u2500\u2500 tests.py\n\u2514\u2500\u2500 views.py\n\n\n\u30e2\u30c7\u30eb\n\nKey\n\n\u30ed\u30b0\u30a4\u30f3\u30e6\u30fc\u30b6\u30fc\u306f\u81ea\u5206\u306e\u9375\u306e\u30d1\u30d6\u30ea\u30c3\u30af\u30ad\u30fc\u306e\u7ba1\u7406\u3092\u3067\u304d\u308b\u3088\u3046\u306b\u3059\u308b\n\nfrom django.db import models\nfrom django.contrib.auth.models import User\n\nclass Key(models.Model):\n    user = models.ForeignKey(User)\n    name = models.CharField(max_length=100)\n    key = models.TextField()\n\n    def __unicode__(self):\n        return \"{0} {1}\".format(\n            self.user and self.user.username or '',\n            self.name or '',\n        )\n\n\n\nResource\n\n\u30ea\u30bd\u30fc\u30b9\u306e\u7ba1\u7406\u8005(root\u3068\u304b)\u306funix user\u3067\u30ea\u30bd\u30fc\u30b9\u767b\u9332\n\u7ba1\u7406\u8005\u306fusers\u306b\u8a31\u53ef\u3059\u308b\u30e6\u30fc\u30b6\u30fc\u3092\u767b\u9332\nkeys\u306busers\u306e\u30ad\u30fc\u304c\u767b\u9332\u3055\u308c\u308b\n\u30c7\u30d5\u30a9\u30eb\u30c8\u3067User\u306eKey\u3092\u5168\u3066\u767b\u9332\u3057\u3066\u3001\u3042\u3068\u3067\u3001User\u304c\u81ea\u8eab\u306e\u30ad\u30fc\u306e\u767b\u9332\u524a\u9664\u3092\u3067\u304d\u308b\u3088\u3046\u306b\u3059\u308b\n\nclass Resource(models.Model):\n    name = models.CharField(max_length=100)\n    unix_user = models.CharField(\n        max_length=100,\n        unique=True,\n    )\n    users = models.ManyToManyField(User, null=True, blank=True, default=None)\n    keys = models.ManyToManyField(Key, null=True, blank=True, default=None)\n\n\n\u30b3\u30de\u30f3\u30c9: \u30ea\u30bd\u30fc\u30b9\u306e\u30d1\u30d6\u30ea\u30c3\u30af\u30ad\u30fc\u3092\u8fd4\u3059\n\nsshkey authkeys $UNIX_USER \u306b\u5bfe\u5fdc\u3059\u308b\u30d1\u30d6\u30ea\u30c3\u30af\u30ad\u30fc\u3092\u8fd4\u3059\n\nfrom pycommand.command import Command as PyCommand, SubCommand\nfrom django.core.management.base import BaseCommand\n\nfrom keys.models import Key\n\nclass Command(BaseCommand, PyCommand):\n\n    def run_from_argv(self, argv):\n        return self.run(argv[1:])\n\n    class AuthKeys(SubCommand):\n        name = 'authkeys'\n        args = [\n            (('user', ), dict(nargs=1,)),\n        ]\n\n        def run(self, param, **options):\n            for key in Key.objects.filter(resource__unix_user=param.user[0]):\n                print key.key\n\n\nauth.bash\u304b\u3089\u30b3\u30de\u30f3\u30c9\u3092\u547c\u3076\n\nopenssh \u304b\u3089\u547c\u3070\u308c\u305f\u3089\u3001django\u306e\u30b3\u30de\u30f3\u30c9\u3067\u51e6\u7406\u3059\u308b\n\n#!/bin/bash\n\nPY=/home/vagrant/.pyenv/versions/wordpress/bin/python\nDJ=/home/vagrant/projects/sshauth/web\n\n$PY $DJ/manage.py sshkeys authkeys $1\n\n\n- Debian Jessie \u3067\u3084\u3063\u3066\u307f\u305f\n\n# \u30ad\u30fc\u306e\u78ba\u8a8d\u3092\u30b3\u30de\u30f3\u30c9\u3067\u3084\u308b\n\n/etc/sshd/sshd_config:\n\n```\nPasswordAuthentication no\n\nAuthorizedKeysCommand  /root/auth.bash\nAuthorizedKeysCommandUser root\n```\n\n/root/auth.bash :\n\n```\n#!/bin/bash\n\nLOG=/tmp/root.txt\n\ndate >> $LOG\necho $@ >> $LOG\ncat `dirname $0`/auth.key\n```\n\n/root/auth.key \u306b\u30ad\u30fc\u3092\u767b\u9332\u3059\u308b\u3068\u30ed\u30b0\u30a4\u30f3\u3067\u304d\u305f:\n\n```\nvagrant@10:~$ ssh vagrant@localhost\n\nYou have new mail.\nLast login: Thu Jan  8 06:16:50 2015 from ::1\n```\n\nvagrant \u306b\u30ed\u30b0\u30a4\u30f3\u8981\u6c42\u304c\u6765\u3066\u308b:\n\n```\nroot@10:/tmp# tail /tmp/root.txt \nThu Jan  8 06:16:50 UTC 2015\nvagrant\n```\n\n## \u30e6\u30fc\u30b6\u3092\u5909\u3048\u3066\u307f\u308b\n\n```\nLogLevel ERROR\n\nAuthorizedKeysCommand  /home/vagrant/projects/sshkey/auth.bash\nAuthorizedKeysCommandUser vagrant\n\n```\n\n```\n# tail -f /var/log/auth.log\n\nJan  8 06:32:39 10 sshd[20926]: \nerror: Unsafe AuthorizedKeysCommand: \nbad ownership or modes for file /home/vagrant/projects/sshkey/auth.bash\n```\n\n```\nvagrant@10:~/projects/sshkey$ ls -al\ntotal 20\ndrwx------  3 vagrant vagrant 4096 Jan  8 06:27 .\ndrwxr-xr-x 10 vagrant vagrant 4096 Jan  8 04:54 ..\n-rwx------  1 vagrant vagrant   90 Jan  8 06:22 auth.bash\n-rw-------  1 vagrant vagrant  801 Jan  8 06:21 auth.key\n```\n\n- [\u3053\u3053](https://lists.mindrot.org/pipermail/openssh-bugs/2013-April/012052.html)\u3092\u307f\u308b\u3068root\u4ee5\u5916\u306f\u30a8\u30e9\u30fc\u304c\u3067\u308b\u3063\u307d\u3044\u3002\n- sshkey\u4ee5\u4e0b\u3092root\u6240\u6709\u306b\u5909\u3048\u3066AuthorizedKeysCommandUser=root\u306b\u3059\u308b\u3068\u3001sshkey\u306e\u89aa\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3067\u3001`bad ownership` \u306b\u306a\u308b\u3002\n- \u304a\u3068\u306a\u3057\u304froot\u3067\u3084\u3063\u305f\u307b\u3046\u304c\u3044\u3044\u3067\u3057\u3087\u3046\n\n# Django\u3067\u30ad\u30fc\u7ba1\u7406\n\n## keys \u30a2\u30d7\u30ea\n\n```\nkeys\n\u251c\u2500\u2500 admin.py\n\u251c\u2500\u2500 __init__.py\n\u251c\u2500\u2500 management\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 commands\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 __init__.py\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2514\u2500\u2500 sshkeys.py\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 __init__.py\n\u251c\u2500\u2500 migrations\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 0001_initial.py\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 __init__.py\n\u251c\u2500\u2500 models.py\n\u251c\u2500\u2500 tests.py\n\u2514\u2500\u2500 views.py\n```\n\n##\u30e2\u30c7\u30eb\n\n### Key\n\n- \u30ed\u30b0\u30a4\u30f3\u30e6\u30fc\u30b6\u30fc\u306f\u81ea\u5206\u306e\u9375\u306e\u30d1\u30d6\u30ea\u30c3\u30af\u30ad\u30fc\u306e\u7ba1\u7406\u3092\u3067\u304d\u308b\u3088\u3046\u306b\u3059\u308b\n\n```py\nfrom django.db import models\nfrom django.contrib.auth.models import User\n\nclass Key(models.Model):\n    user = models.ForeignKey(User)\n    name = models.CharField(max_length=100)\n    key = models.TextField()\n\n    def __unicode__(self):\n        return \"{0} {1}\".format(\n            self.user and self.user.username or '',\n            self.name or '',\n        )\n\n```\n\n### Resource\n\n- \u30ea\u30bd\u30fc\u30b9\u306e\u7ba1\u7406\u8005(root\u3068\u304b)\u306funix user\u3067\u30ea\u30bd\u30fc\u30b9\u767b\u9332\n- \u7ba1\u7406\u8005\u306fusers\u306b\u8a31\u53ef\u3059\u308b\u30e6\u30fc\u30b6\u30fc\u3092\u767b\u9332\n- keys\u306busers\u306e\u30ad\u30fc\u304c\u767b\u9332\u3055\u308c\u308b\n- \u30c7\u30d5\u30a9\u30eb\u30c8\u3067User\u306eKey\u3092\u5168\u3066\u767b\u9332\u3057\u3066\u3001\u3042\u3068\u3067\u3001User\u304c\u81ea\u8eab\u306e\u30ad\u30fc\u306e\u767b\u9332\u524a\u9664\u3092\u3067\u304d\u308b\u3088\u3046\u306b\u3059\u308b\n\n```py\nclass Resource(models.Model):\n    name = models.CharField(max_length=100)\n    unix_user = models.CharField(\n        max_length=100,\n        unique=True,\n    )\n    users = models.ManyToManyField(User, null=True, blank=True, default=None)\n    keys = models.ManyToManyField(Key, null=True, blank=True, default=None)\n```    \n\n## \u30b3\u30de\u30f3\u30c9: \u30ea\u30bd\u30fc\u30b9\u306e\u30d1\u30d6\u30ea\u30c3\u30af\u30ad\u30fc\u3092\u8fd4\u3059\n\n- sshkey authkeys $UNIX_USER \u306b\u5bfe\u5fdc\u3059\u308b\u30d1\u30d6\u30ea\u30c3\u30af\u30ad\u30fc\u3092\u8fd4\u3059\n\n```\nfrom pycommand.command import Command as PyCommand, SubCommand\nfrom django.core.management.base import BaseCommand\n\nfrom keys.models import Key\n\nclass Command(BaseCommand, PyCommand):\n\n    def run_from_argv(self, argv):\n        return self.run(argv[1:])\n\n    class AuthKeys(SubCommand):\n        name = 'authkeys'\n        args = [\n            (('user', ), dict(nargs=1,)),\n        ]\n\n        def run(self, param, **options):\n            for key in Key.objects.filter(resource__unix_user=param.user[0]):\n                print key.key\n```\n\n## auth.bash\u304b\u3089\u30b3\u30de\u30f3\u30c9\u3092\u547c\u3076\n\n- openssh \u304b\u3089\u547c\u3070\u308c\u305f\u3089\u3001django\u306e\u30b3\u30de\u30f3\u30c9\u3067\u51e6\u7406\u3059\u308b\n\n```\n#!/bin/bash\n\nPY=/home/vagrant/.pyenv/versions/wordpress/bin/python\nDJ=/home/vagrant/projects/sshauth/web\n\n$PY $DJ/manage.py sshkeys authkeys $1\n```\n", "tags": ["SSH", "Django"]}