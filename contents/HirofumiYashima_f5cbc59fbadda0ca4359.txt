{"context": " More than 1 year has passed since last update.\n\nlag\u95a2\u6570\u3092\u4f7f\u3063\u3066\u3001\u57fa\u6e96\u30ab\u30e9\u30e0\u5024\u304cN\u500b\u5206 \u5c0f\u3055\u3044\u30ec\u30b3\u30fc\u30c9\u306e\u6307\u5b9a\u30ab\u30e9\u30e0\u5024\u3092\u53d6\u5f97\u3059\u308b\u969b\u306f\u3001from\u53e5\u3067\u6307\u5b9a\u3059\u308b\u30c6\u30fc\u30d6\u30eb\u306b\u3001\u305d\u306e\u30ec\u30b3\u30fc\u30c9\u304c\u306a\u3044\u3068NULL\u306b\u306a\u308b\n\n\n\u6628\u65e5\uff11\u65e5\u5206\u306e\u30c7\u30fc\u30bf\u306b\u3064\u3044\u3066\u3001\u4ee5\u4e0b\u306e\u30ab\u30e9\u30e0\u5217\u3092\u53c2\u7167\u3057\u3088\u3046\u3068\u3057\u3066\u3044\u308b\u5834\u5408\u3001\n\n\n\u65e5\u4ed8\n\u30e6\u30fc\u30b6ID\n\u30e6\u30fc\u30b6\u30fb\u30b9\u30c6\u30fc\u30bf\u30b9\u72b6\u6cc1\n1\u65e5\u524d\u306e\u300c\u30e6\u30fc\u30b6\u30fb\u30b9\u30c6\u30fc\u30bf\u30b9\u72b6\u6cc1\u300d \u203b\u53c2\u8003\u307e\u3067\u306b\u307f\u305f\u3044\n2\u65e5\u524d\u306e\u300c\u30e6\u30fc\u30b6\u30fb\u30b9\u30c6\u30fc\u30bf\u30b9\u72b6\u6cc1\u300d \u203b\u53c2\u8003\u307e\u3067\u306b\u307f\u305f\u3044\n3\u65e5\u524d\u306e\u300c\u30e6\u30fc\u30b6\u30fb\u30b9\u30c6\u30fc\u30bf\u30b9\u72b6\u6cc1\u300d \u203b\u53c2\u8003\u307e\u3067\u306b\u307f\u305f\u3044\n\n\n\u4ee5\u4e0b\u306e\u30af\u30a8\u30ea\u3060\u3068\u3001\u300c3\u65e5\u524d\u306e\u30b9\u30c6\u30fc\u30bf\u30b9\u300d\u3001\u300c2\u65e5\u524d\u306e\u30b9\u30c6\u30fc\u30bf\u30b9\u300d\u3001\u300c\uff11\u65e5\u524d\u306e\u30b9\u30c6\u30fc\u30bf\u30b9\u300d\u5217\u304c\u3059\u3079\u3066NULL\u306b\u306a\u308b\n\n\nSQL\nselect date, \n       user_id,\n       user_status,\n       lag(uer_status, 1) over(partition by user_id order by date) as status_1day_ago,\n       lag(uer_status, 2) over(partition by user_id order by date) as status_2day_ago,\n       lag(uer_status, 3) over(partition by user_id order by date) as status_3day_ago,\nfrom game_event_table\nwhere date = current_date + interval '-1 day'\n;\n\n\n\n\u4ee5\u4e0b\u3060\u3068OK\uff01\n\n\nSQL\nWith temp as (\nselect date, \n       user_id,\n       user_status,\n       lag(uer_status, 1) over(partition by user_id order by date) as status_1day_ago,\n       lag(uer_status, 2) over(partition by user_id order by date) as status_2day_ago,\n       lag(uer_status, 3) over(partition by user_id order by date) as status_3day_ago,\nfrom game_event_table\nwhere date between current_date + interval '-4 day' and current_date + interval '-1 day'\n)\nselect *\nfrom temp\nwhere date = current_date + interval '-1 day'\n;\n\n\n\n\n\u3010 \u4ee5\u4e0b\u3001\u89e3\u8aac \u3011\n\n\n\uff08Lag\u95a2\u6570\u3092\u542b\u3080SQL\uff09\n\n\u3042\u308b\u30ab\u30e9\u30e0\uff08\u30ab\u30e9\u30e0\u540d\uff1atarget_column_name\uff09\u3092\u3001\n\u57fa\u6e96\u30ab\u30e9\u30e0\uff08\u30ab\u30e9\u30e0\u540d\uff1alag_index_column_name\uff09\u3092\u8ef8\u306bN\u30ec\u30b3\u30fc\u30c9\u5206\u3001\n\u57fa\u6e96\u30ab\u30e9\u30e0\u5024\u304c\u5c0f\u3055\u3044\u30ab\u30e9\u30e0\u3092\u51fa\u3059\u3068\u304d\u306b\u306f\u3001\n\n\nSQL\nselect lag_index_column_name,\n       group_column_name,\n       target_column_name,\n       lag(target_column_name, N) over(partition by group_column_name order by lag_index_column_name)\nfrom table_name\n\n\n\n\n\uff08 \u4f8b )\n\n\nSQL\nselect date, \n       user_id,\n       user_status,\n       lag(uer_status, 1) over(partition by user_id order by date) as status_1day_ago,\n       lag(uer_status, 2) over(partition by user_id order by date) as status_2day_ago,\n       lag(uer_status, 3) over(partition by user_id order by date) as status_3day_ago,\nfrom game_event_table\nwhere date between '2015-07-05' and '2015-07-14'\norder by date desc\n\n\n\uff08\u4e0a\u8a18\u30af\u30a8\u30ea\u306e\u7d50\u679c\uff09\ndate,        user_id,   user_status, status_1day_ago, status_2day_ago, status_3day_ago\n2015-07-14   000000175       A            B              C                D\n2015-07-13   000000175       B            C              D                E\n2015-07-12   000000175       C            D              E                F\n2015-07-11   000000175       D            E              F                G\n2015-07-10   000000175       E            F              G                H\n2015-07-09   000000175       F            G              H                I\n2015-07-08   000000175       G            H              I                J\n2015-07-07   000000175       H            I              J                NULL\n2015-07-06   000000175       I            J              NULL             NULL\n2015-07-05   000000175       J            NULL           NULL             NULL\n\n\u65e5\u4ed8\u304c2015-07-05\u306e\u30ec\u30b3\u30fc\u30c9\u3092\u898b\u308b\u3068\u3001\u300c1\u65e5\u524d\u306e\u30b9\u30c6\u30fc\u30bf\u30b9\u300d\u3001\u300c2\u65e5\u524d\u306e\u30b9\u30c6\u30fc\u30bf\u30b9\u300d\u3001\u300c3\u65e5\u524d\u306e\u30b9\u30c6\u30fc\u30bf\u30b9\u300d\u306e\uff13\u5217\u304cNULL\u306b\u306a\u3063\u3066\u3044\u308b\u3002\n\u3053\u308c\u306f\u3001\n\n\u300c1\u65e5\u524d\u306e\u30b9\u30c6\u30fc\u30bf\u30b9\u300d = 2015-07-04\u306e\u30ec\u30b3\u30fc\u30c9\u304cfrom\u53e5\u306e\u30c6\u30fc\u30d6\u30eb\u306b\u5b58\u5728\u3057\u306a\u3044\n\u300c2\u65e5\u524d\u306e\u30b9\u30c6\u30fc\u30bf\u30b9\u300d = 2015-07-03\u306e\u30ec\u30b3\u30fc\u30c9\u304cfrom\u53e5\u306e\u30c6\u30fc\u30d6\u30eb\u306b\u5b58\u5728\u3057\u306a\u3044\n\u300c3\u65e5\u524d\u306e\u30b9\u30c6\u30fc\u30bf\u30b9\u300d = 2015-07-02\u306e\u30ec\u30b3\u30fc\u30c9\u304cfrom\u53e5\u306e\u30c6\u30fc\u30d6\u30eb\u306b\u5b58\u5728\u3057\u306a\u3044\n\n\u304b\u3089\u3067\u3042\u308b\u3002\n\u3061\u306a\u307f\u306b\u3001user_status\u5217\u306bNULL\u306e\u3042\u308b\u30ec\u30b3\u30fc\u30c9\u304c\u3042\u308b\u3068\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\ndate,        user_id,   user_status, status_1day_ago, status_2day_ago, status_3day_ago\n2015-07-14   000000175       A            NULL           C                D\n2015-07-13   000000175       NULL         C              D                E\n2015-07-12   000000175       C            D              E                F\n2015-07-11   000000175       D            E              F                G\n2015-07-10   000000175       E            F              G                H\n2015-07-09   000000175       F            G              H                NULL\n2015-07-08   000000175       G            H              NULL             J\n2015-07-07   000000175       H            NULL           J                NULL\n2015-07-06   000000175       NULL         J              NULL             NULL\n2015-07-05   000000175       J            NULL           NULL             NULL\n\n\u540c\u3058\u7406\u7531\u3067\u3001\n\u300c\u4eca\u65e5\u306e\u30b9\u30c6\u30fc\u30bf\u30b9\u300d\uff08\u30ab\u30e9\u30e0\u540d\uff1auser_status)\u3068\u4e26\u3079\u3066\u3001\u300c2\u65e5\u524d\u306e\u30b9\u30c6\u30fc\u30bf\u30b9\u300d\uff5e\u300c\u6628\u65e5\u306e\u30b9\u30c6\u30fc\u30bf\u30b9\u300d\u3092\u898b\u305f\u3044\u3068\u304d\u306f\u3001\nwhere\u53e5\u6761\u4ef6\u3067\u3001date between \u300c\u4eca\u65e5\u306e2\u65e5\u524d\u306e\u65e5\u4ed8\u300d and \u300c\u4eca\u65e5\u306e\u65e5\u4ed8\u300d\n\u3092\u8a2d\u5b9a\u3057\u306a\u3044\u3068\u3001NULL\u306b\u306a\u308b\u3002\nwhere\u53e5\u6761\u4ef6\u3092\u3001date between '2015-07-12' and '2015-07-14' \u306b\u3059\u308b\u3068\u3001\ndate,        user_id,   user_status, status_1day_ago, status_2day_ago, status_3day_ago\n2015-07-14   000000175       A            NULL           C                NULL\n2015-07-13   000000175       NULL         C              NULL             NULL\n2015-07-12   000000175       C            NULL           NULL             NULL\n\n\u306b\u306a\u308b\u3002\n\n\n\u3055\u3066\u3001\u3053\u3053\u3067\u5192\u982d\u306e\u554f\u984c\u30af\u30a8\u30ea\u306b\u623b\u308a\u307e\u3059\u3002\n\n\n\u300c\u4eca\u65e5\u300d\u3084\u300c\u6628\u65e5\u300d\u306a\u3069\u3001\u7279\u5b9a\u306e\uff11\u65e5\u5206\u306e\uff11\u30ec\u30b3\u30fc\u30c9\u306e\u307f select \u3057\u305f\u3044\u5834\u5408\u3001\n\nselect \u5bfe\u8c61\u306e\u65e5\u4ed8\u306b\u3001\u7279\u5b9a\u65e5\u3092\u6307\u5b9a\u3057\u3088\u3046\u3068\u3057\u3066\u3001\n\nSQL\nwhere date = '2015-07-14'\n\n\n\u306b\u3057\u3066\u3001\n\nSQL\nselect date, \n       user_id,\n       user_status,\n       lag(uer_status, 1) over(partition by user_id order by date) as status_1day_ago,\n       lag(uer_status, 2) over(partition by user_id order by date) as status_2day_ago,\n       lag(uer_status, 3) over(partition by user_id order by date) as status_3day_ago,\nfrom game_event_table\nwhere date = '2015-07-14'\n;\n\n\n\u3068\u3059\u308b\u3068\u3001\ndate,        user_id,   user_status, status_1day_ago, status_2day_ago, status_3day_ago\n2015-07-14   000000175       A            NULL           NULL                NULL\n\n\n\u3068\u306a\u308a\u3001\u904e\u53bb\u65e5\u306e\u300c\u30b9\u30c6\u30fc\u30bf\u30b9\u300d\u5217\u306e\u5024\u304c\u3059\u3079\u3066NULL\u306b\u306a\u3063\u3066\u3057\u307e\u3044\u307e\u3059\u3002_\n\n2015\u5e747\u670814\u65e5\u306e\u5404\u5217\u3092\u898b\u305f\u3044\u5834\u5408\u306f\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u3059\u308b\u3068OK\u3067\u3059\u3002\n\n\nSQL\nWith temp as (\nselect date, \n       user_id,\n       user_status,\n       lag(uer_status, 1) over(partition by user_id order by date) as status_1day_ago,\n       lag(uer_status, 2) over(partition by user_id order by date) as status_2day_ago,\n       lag(uer_status, 3) over(partition by user_id order by date) as status_3day_ago,\nfrom game_event_table\nwhere date between '2015-07-11' and '2015-07-14'\n)\nselect *\nfrom temp\nwhere date = '2015-07-14'\n;\n\n\n\u3010\u6ce8\u610f\u3011status_1day_ago\u5217 \u304c NULL \u306a\u306e\u306f\u3001date\u5217\u304c2015-07-03\u306e\u30ec\u30b3\u30fc\u30c9\u306euser_status\u5217\u304c\u3001\u305d\u3082\u305d\u3082NULL\u3067\u3042\u308b\u3053\u3068\u306b\u8d77\u56e0\u3059\u308b\u3082\u306e\ndate,        user_id,   user_status, status_1day_ago, status_2day_ago, status_3day_ago\n2015-07-14   000000175        A            NULL             C                D\n\n\n\u3010\u53c2\u8003\u3011 AWS Redshift \u3092\u4f7f\u3063\u3066\u3044\u3066\u3001where\u53e5\u306e\u300c\u4eca\u65e5\u306eX\u65e5\u524d\u300d\uff5e\u300c\u4eca\u65e5\u300d\u3092\u52d5\u7684\u306b\u8a2d\u5b9a\u3059\u308b\u5834\u5408_\n\nSQL\nWith temp as (\nselect date, \n       user_id,\n       user_status,\n       lag(uer_status, 1) over(partition by user_id order by date) as status_1day_ago,\n       lag(uer_status, 2) over(partition by user_id order by date) as status_2day_ago,\n       lag(uer_status, 3) over(partition by user_id order by date) as status_3day_ago,\nfrom game_event_table\nwhere date between current_date + interval '-3 day' and current_date\n)\nselect *\nfrom temp\nwhere date = current_date\n;\n\n\n\u3068\u306f\u3044\u3048\u3001\u305d\u306e\u65e5\u306e\u30c7\u30fc\u30bf\u304cDB\u306b\u5b8c\u5168\u306a\u5f62\u3067\u6295\u5165\u5b8c\u4e86\u3059\u308b\u306e\u306f\u3001\u7fcc\u671d\u4ee5\u964d\u3067\u3042\u308b\u3053\u3068\u591a\u3044\u306e\u3067\u3001\u96c6\u8a08\u5bfe\u8c61\u306f\u3001\u300e\u6628\u65e5\u300f\u307e\u3067\u306e\u30c7\u30fc\u30bf\u306b\u3059\u308b\u306e\u304c\u5b9f\u52d9\u7684\u3060\u308d\u3046\u3002\n\nSQL\nWith temp as (\nselect date, \n       user_id,\n       user_status,\n       lag(uer_status, 1) over(partition by user_id order by date) as status_1day_ago,\n       lag(uer_status, 2) over(partition by user_id order by date) as status_2day_ago,\n       lag(uer_status, 3) over(partition by user_id order by date) as status_3day_ago,\nfrom game_event_table\nwhere date between current_date + interval '-4 day' and current_date + interval '-1 day'\n)\nselect *\nfrom temp\nwhere date = current_date + interval '-1 day'\n;\n\n\n\n\uff08\u4f8b\uff09\u65e5\u4ed8\u30ab\u30e9\u30e0\u3092\u8ef8\u306b\u3057\u3066\u3001\u300c\uff08\u30ab\u30ec\u30f3\u30c8\u30ec\u30b3\u30fc\u30c9\u306e\uff09\u65e5\u4ed8\u3001\u30b2\u30fc\u30e0\u30a4\u30d9\u30f3\u30c8\u540d, \uff08\u30ab\u30ec\u30f3\u30c8\u30ec\u30b3\u30fc\u30c9\u306e\uff09\u30a2\u30af\u30c6\u30a3\u30d6UU\u6570\u3001\uff08\u30ab\u30ec\u30f3\u30c8\u30ec\u30b3\u30fc\u30c9\u306e\u300c\u65e5\u4ed8\u300d\u304b\u3089\u6570\u30ec\u30b3\u30fc\u30c9\u524d\uff08\u6570\u65e5\u524d\uff09\u30ec\u30b3\u30fc\u30c9\u306e\uff09\u300c\u30a2\u30af\u30c6\u30a3\u30d6UU\u300d\n\n\u3010DB\u60f3\u5b9a\u3011\n\nAmazon Redshift\u3092\u4f7f\u7528\u3057\u3066\u304a\u308a\u3001datetime\u5217\u306b\u3001YYYY-MM-DD HH24:MI:SS \u304c\u683c\u7d0d\u3055\u308c\u3066\u3044\u308b\u5834\u5408\u3092\u4eee\u5b9a\n\n\u3010\u8981\u6ce8\u610f\u3011UU_3ago\u5217\u306f\u3001\u30ab\u30ec\u30f3\u30c8\u30ec\u30b3\u30fc\u30c9\u306e\u65e5\u4ed8\uff08date)\u306e\u300c\uff13\u65e5\u524d\u300d\u3092\u5fc5\u305a\u610f\u5473\u3059\u308b\u308f\u3051\u3067\u306f\u306a\u3044\u3002\n\n\n\u30ab\u30ec\u30f3\u30c8\u30ec\u30b3\u30fc\u30c9\u306e\uff13\u30ec\u30b3\u30fc\u30c9\u524d\uff08date\u306e\u5024\u3067\u5168\u30ec\u30b3\u30fc\u30c9\u3092\u964d\u9806\u306b\u4e26\u3079\u305f\u3068\u304d\u306b\u3001\u30ab\u30ec\u30f3\u30c8\u30ec\u30b3\u30fc\u30c9\u306e\uff13\u30ec\u30b3\u30fc\u30c9\u524d\uff09\u306edate\u306e\u5024\u3092\u610f\u5473\u3059\u308b\u3002\n\n\n_\u30af\u30a8\u30ea\u304c\u8fd4\u3059\u7d50\u679c\u306edate\u5217\u304c\u30017/14, 7/13, 7/10, 7/8, 7/6, 7/5, 5/28, 5/24 \u3068\u4e26\u3093\u3067\u3044\u305f\u5834\u5408\u3001\u4e00\u756a\u4e0a\uff08date = 7/14)\u306e\u30ec\u30b3\u30fc\u30c9\u306eUU3ago\u5217\u306e\u5024\u306f\u3001date\u5217\u304c7/8\u306e\u30ec\u30b3\u30fc\u30c9\u306eUU\u306e\u5024\u306b\u306a\u308b\u3002 __\n\nSQL\nWith temp as (\nselect date_trunc('day', datetime) as date,\n       game_event_name,\n       count(distinct user_id) as UU\nfrom   game_event_table\ngroup by date, game_event_name\nhaving date_trunc('day', datetime) between current_date + interval '-9 DAY' and current_date + interval '-1 day' \n)\nselect date,\n       game_event_name,\n       UU,\n       lag(UU, 1) over(partition by game_event_name order by date) as UU_1ago,\n       lag(UU, 2) over(partition by game_event_name order by date) as UU_2ago,\n       lag(UU, 3) over(partition by game_event_name order by date) as UU_3ago,\n       lag(UU, 4) over(partition by game_event_name order by date) as UU_4ago,\n       lag(UU, 5) over(partition by game_event_name order by date) as UU_5ago,\n       lag(UU, 6) over(partition by game_event_name order by date) as UU_6ago,\n       lag(UU, 7) over(partition by game_event_name order by date) as UU_7ago      \nfrom   temp\norder by date desc\n;\n\n\n\n\n\uff08 \u76f4\u8fd1\uff08\u203b\u30c7\u30fc\u30bf\u304c\u683c\u7d0d\u3055\u308c\u3066\u3044\u308b\u518d\u76f4\u8fd1\u65e5\uff1d\u6628\u65e5\uff09\uff11\u65e5\u5206\u306e\u30ec\u30b3\u30fc\u30c9\u306e\u307f\u53c2\u7167\u3057\u305f\u3044\u5834\u5408 )\n\n\nSQL\nWith temp as (\nselect date_trunc('day', datetime) as date,\n       game_event_name,\n       count(distinct user_id) as UU\nfrom   game_event_table\ngroup by date, game_event_name\nhaving date_trunc('day', datetime) between current_date + interval '-9 DAY' and current_date + interval '-1 day' \n), temp_2 as (\nselect date,\n       game_event_name,\n       UU,\n       lag(UU, 1) over(partition by game_event_name order by date) as UU_1ago,\n       lag(UU, 2) over(partition by game_event_name order by date) as UU_2ago,\n       lag(UU, 3) over(partition by game_event_name order by date) as UU_3ago,\n       lag(UU, 4) over(partition by game_event_name order by date) as UU_4ago,\n       lag(UU, 5) over(partition by game_event_name order by date) as UU_5ago,\n       lag(UU, 6) over(partition by game_event_name order by date) as UU_6ago,\n       lag(UU, 7) over(partition by game_event_name order by date) as UU_7ago      \nfrom   temp\n)\nselect *\nfrom temp_2\nwhere date = current_date + interval '-1 day'\n;\n\n\n### __lag\u95a2\u6570\u3092\u4f7f\u3063\u3066\u3001\u57fa\u6e96\u30ab\u30e9\u30e0\u5024\u304cN\u500b\u5206 \u5c0f\u3055\u3044\u30ec\u30b3\u30fc\u30c9\u306e\u6307\u5b9a\u30ab\u30e9\u30e0\u5024\u3092\u53d6\u5f97\u3059\u308b\u969b\u306f\u3001from\u53e5\u3067\u6307\u5b9a\u3059\u308b\u30c6\u30fc\u30d6\u30eb\u306b\u3001\u305d\u306e\u30ec\u30b3\u30fc\u30c9\u304c\u306a\u3044\u3068NULL\u306b\u306a\u308b__\n### __\u6628\u65e5\uff11\u65e5\u5206\u306e\u30c7\u30fc\u30bf\u306b\u3064\u3044\u3066\u3001\u4ee5\u4e0b\u306e\u30ab\u30e9\u30e0\u5217\u3092\u53c2\u7167\u3057\u3088\u3046\u3068\u3057\u3066\u3044\u308b\u5834\u5408\u3001__\n\n* \u65e5\u4ed8\n* \u30e6\u30fc\u30b6ID\n* \u30e6\u30fc\u30b6\u30fb\u30b9\u30c6\u30fc\u30bf\u30b9\u72b6\u6cc1\n* 1\u65e5\u524d\u306e\u300c\u30e6\u30fc\u30b6\u30fb\u30b9\u30c6\u30fc\u30bf\u30b9\u72b6\u6cc1\u300d \u203b\u53c2\u8003\u307e\u3067\u306b\u307f\u305f\u3044\n* 2\u65e5\u524d\u306e\u300c\u30e6\u30fc\u30b6\u30fb\u30b9\u30c6\u30fc\u30bf\u30b9\u72b6\u6cc1\u300d \u203b\u53c2\u8003\u307e\u3067\u306b\u307f\u305f\u3044\n* 3\u65e5\u524d\u306e\u300c\u30e6\u30fc\u30b6\u30fb\u30b9\u30c6\u30fc\u30bf\u30b9\u72b6\u6cc1\u300d \u203b\u53c2\u8003\u307e\u3067\u306b\u307f\u305f\u3044\n\n\n#### __\u4ee5\u4e0b\u306e\u30af\u30a8\u30ea\u3060\u3068\u3001\u300c3\u65e5\u524d\u306e\u30b9\u30c6\u30fc\u30bf\u30b9\u300d\u3001\u300c2\u65e5\u524d\u306e\u30b9\u30c6\u30fc\u30bf\u30b9\u300d\u3001\u300c\uff11\u65e5\u524d\u306e\u30b9\u30c6\u30fc\u30bf\u30b9\u300d\u5217\u304c\u3059\u3079\u3066NULL\u306b\u306a\u308b__\n\n```{SQL:SQL}\nselect date, \n       user_id,\n       user_status,\n       lag(uer_status, 1) over(partition by user_id order by date) as status_1day_ago,\n       lag(uer_status, 2) over(partition by user_id order by date) as status_2day_ago,\n       lag(uer_status, 3) over(partition by user_id order by date) as status_3day_ago,\nfrom game_event_table\nwhere date = current_date + interval '-1 day'\n;\n```\n\n\n### __\u4ee5\u4e0b\u3060\u3068OK\uff01__\n\n```{SQL:SQL}\nWith temp as (\nselect date, \n       user_id,\n       user_status,\n       lag(uer_status, 1) over(partition by user_id order by date) as status_1day_ago,\n       lag(uer_status, 2) over(partition by user_id order by date) as status_2day_ago,\n       lag(uer_status, 3) over(partition by user_id order by date) as status_3day_ago,\nfrom game_event_table\nwhere date between current_date + interval '-4 day' and current_date + interval '-1 day'\n)\nselect *\nfrom temp\nwhere date = current_date + interval '-1 day'\n;\n```\n\n___\n\n## __\u3010 \u4ee5\u4e0b\u3001\u89e3\u8aac \u3011__\n\n___\n\n__\uff08Lag\u95a2\u6570\u3092\u542b\u3080SQL\uff09__\n\n* \u3042\u308b\u30ab\u30e9\u30e0\uff08\u30ab\u30e9\u30e0\u540d\uff1atarget_column_name\uff09\u3092\u3001\n* \u57fa\u6e96\u30ab\u30e9\u30e0\uff08\u30ab\u30e9\u30e0\u540d\uff1alag_index_column_name\uff09\u3092\u8ef8\u306bN\u30ec\u30b3\u30fc\u30c9\u5206\u3001\n* \u57fa\u6e96\u30ab\u30e9\u30e0\u5024\u304c\u5c0f\u3055\u3044\u30ab\u30e9\u30e0\u3092\u51fa\u3059\u3068\u304d\u306b\u306f\u3001\n\n\n```{SQL:SQL}\nselect lag_index_column_name,\n       group_column_name,\n       target_column_name,\n       lag(target_column_name, N) over(partition by group_column_name order by lag_index_column_name)\nfrom table_name\n```\n\n___\n\n\n### __\uff08 \u4f8b )__\n\n```{SQL:SQL}\nselect date, \n       user_id,\n       user_status,\n       lag(uer_status, 1) over(partition by user_id order by date) as status_1day_ago,\n       lag(uer_status, 2) over(partition by user_id order by date) as status_2day_ago,\n       lag(uer_status, 3) over(partition by user_id order by date) as status_3day_ago,\nfrom game_event_table\nwhere date between '2015-07-05' and '2015-07-14'\norder by date desc\n```\n\n__\uff08\u4e0a\u8a18\u30af\u30a8\u30ea\u306e\u7d50\u679c\uff09__\n\n\n```\ndate,        user_id,   user_status, status_1day_ago, status_2day_ago, status_3day_ago\n2015-07-14   000000175       A            B              C                D\n2015-07-13   000000175       B            C              D                E\n2015-07-12   000000175       C            D              E                F\n2015-07-11   000000175       D            E              F                G\n2015-07-10   000000175       E            F              G                H\n2015-07-09   000000175       F            G              H                I\n2015-07-08   000000175       G            H              I                J\n2015-07-07   000000175       H            I              J                NULL\n2015-07-06   000000175       I            J              NULL             NULL\n2015-07-05   000000175       J            NULL           NULL             NULL\n```\n\n__\u65e5\u4ed8\u304c2015-07-05\u306e\u30ec\u30b3\u30fc\u30c9\u3092\u898b\u308b\u3068\u3001\u300c1\u65e5\u524d\u306e\u30b9\u30c6\u30fc\u30bf\u30b9\u300d\u3001\u300c2\u65e5\u524d\u306e\u30b9\u30c6\u30fc\u30bf\u30b9\u300d\u3001\u300c3\u65e5\u524d\u306e\u30b9\u30c6\u30fc\u30bf\u30b9\u300d\u306e\uff13\u5217\u304cNULL\u306b\u306a\u3063\u3066\u3044\u308b\u3002__\n\n\n__\u3053\u308c\u306f\u3001__\n\n* \u300c1\u65e5\u524d\u306e\u30b9\u30c6\u30fc\u30bf\u30b9\u300d = 2015-07-04\u306e\u30ec\u30b3\u30fc\u30c9\u304cfrom\u53e5\u306e\u30c6\u30fc\u30d6\u30eb\u306b\u5b58\u5728\u3057\u306a\u3044\n* \u300c2\u65e5\u524d\u306e\u30b9\u30c6\u30fc\u30bf\u30b9\u300d = 2015-07-03\u306e\u30ec\u30b3\u30fc\u30c9\u304cfrom\u53e5\u306e\u30c6\u30fc\u30d6\u30eb\u306b\u5b58\u5728\u3057\u306a\u3044\n* \u300c3\u65e5\u524d\u306e\u30b9\u30c6\u30fc\u30bf\u30b9\u300d = 2015-07-02\u306e\u30ec\u30b3\u30fc\u30c9\u304cfrom\u53e5\u306e\u30c6\u30fc\u30d6\u30eb\u306b\u5b58\u5728\u3057\u306a\u3044\n\n__\u304b\u3089\u3067\u3042\u308b\u3002__\n\n\n\n__\u3061\u306a\u307f\u306b\u3001user_status\u5217\u306bNULL\u306e\u3042\u308b\u30ec\u30b3\u30fc\u30c9\u304c\u3042\u308b\u3068\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002__\n\n```\ndate,        user_id,   user_status, status_1day_ago, status_2day_ago, status_3day_ago\n2015-07-14   000000175       A            NULL           C                D\n2015-07-13   000000175       NULL         C              D                E\n2015-07-12   000000175       C            D              E                F\n2015-07-11   000000175       D            E              F                G\n2015-07-10   000000175       E            F              G                H\n2015-07-09   000000175       F            G              H                NULL\n2015-07-08   000000175       G            H              NULL             J\n2015-07-07   000000175       H            NULL           J                NULL\n2015-07-06   000000175       NULL         J              NULL             NULL\n2015-07-05   000000175       J            NULL           NULL             NULL\n```\n\n\u540c\u3058\u7406\u7531\u3067\u3001\n\n\u300c\u4eca\u65e5\u306e\u30b9\u30c6\u30fc\u30bf\u30b9\u300d\uff08\u30ab\u30e9\u30e0\u540d\uff1auser_status)\u3068\u4e26\u3079\u3066\u3001\u300c2\u65e5\u524d\u306e\u30b9\u30c6\u30fc\u30bf\u30b9\u300d\uff5e\u300c\u6628\u65e5\u306e\u30b9\u30c6\u30fc\u30bf\u30b9\u300d\u3092\u898b\u305f\u3044\u3068\u304d\u306f\u3001\n\n_**where\u53e5\u6761\u4ef6\u3067\u3001date between \u300c\u4eca\u65e5\u306e2\u65e5\u524d\u306e\u65e5\u4ed8\u300d and \u300c\u4eca\u65e5\u306e\u65e5\u4ed8\u300d**_\n\n\u3092\u8a2d\u5b9a\u3057\u306a\u3044\u3068\u3001NULL\u306b\u306a\u308b\u3002\n\n\n__where\u53e5\u6761\u4ef6\u3092\u3001date between '2015-07-12' and '2015-07-14' \u306b\u3059\u308b\u3068\u3001__\n\n```\ndate,        user_id,   user_status, status_1day_ago, status_2day_ago, status_3day_ago\n2015-07-14   000000175       A            NULL           C                NULL\n2015-07-13   000000175       NULL         C              NULL             NULL\n2015-07-12   000000175       C            NULL           NULL             NULL\n```\n\n__\u306b\u306a\u308b\u3002__\n\n\n___\n\n### __\u3055\u3066\u3001\u3053\u3053\u3067\u5192\u982d\u306e\u554f\u984c\u30af\u30a8\u30ea\u306b\u623b\u308a\u307e\u3059\u3002__\n\n#### __\u300c\u4eca\u65e5\u300d\u3084\u300c\u6628\u65e5\u300d\u306a\u3069\u3001\u7279\u5b9a\u306e\uff11\u65e5\u5206\u306e\uff11\u30ec\u30b3\u30fc\u30c9\u306e\u307f select \u3057\u305f\u3044\u5834\u5408\u3001__\n\nselect \u5bfe\u8c61\u306e\u65e5\u4ed8\u306b\u3001\u7279\u5b9a\u65e5\u3092\u6307\u5b9a\u3057\u3088\u3046\u3068\u3057\u3066\u3001\n\n```{SQL:SQL}\nwhere date = '2015-07-14'\n```\n\n\u306b\u3057\u3066\u3001\n\n```{SQL:SQL}\nselect date, \n       user_id,\n       user_status,\n       lag(uer_status, 1) over(partition by user_id order by date) as status_1day_ago,\n       lag(uer_status, 2) over(partition by user_id order by date) as status_2day_ago,\n       lag(uer_status, 3) over(partition by user_id order by date) as status_3day_ago,\nfrom game_event_table\nwhere date = '2015-07-14'\n;\n```\n\n\u3068\u3059\u308b\u3068\u3001\n\n```\ndate,        user_id,   user_status, status_1day_ago, status_2day_ago, status_3day_ago\n2015-07-14   000000175       A            NULL           NULL                NULL\n```\n\n#### _\u3068\u306a\u308a\u3001\u904e\u53bb\u65e5\u306e\u300c\u30b9\u30c6\u30fc\u30bf\u30b9\u300d\u5217\u306e\u5024\u304c\u3059\u3079\u3066NULL\u306b\u306a\u3063\u3066\u3057\u307e\u3044\u307e\u3059\u3002__\n\n\n#### __2015\u5e747\u670814\u65e5\u306e\u5404\u5217\u3092\u898b\u305f\u3044\u5834\u5408\u306f\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u3059\u308b\u3068OK\u3067\u3059\u3002__\n\n\n```{SQL:SQL}\nWith temp as (\nselect date, \n       user_id,\n       user_status,\n       lag(uer_status, 1) over(partition by user_id order by date) as status_1day_ago,\n       lag(uer_status, 2) over(partition by user_id order by date) as status_2day_ago,\n       lag(uer_status, 3) over(partition by user_id order by date) as status_3day_ago,\nfrom game_event_table\nwhere date between '2015-07-11' and '2015-07-14'\n)\nselect *\nfrom temp\nwhere date = '2015-07-14'\n;\n```\n\n__\u3010\u6ce8\u610f\u3011status_1day_ago\u5217 \u304c NULL \u306a\u306e\u306f\u3001date\u5217\u304c2015-07-03\u306e\u30ec\u30b3\u30fc\u30c9\u306euser_status\u5217\u304c\u3001\u305d\u3082\u305d\u3082NULL\u3067\u3042\u308b\u3053\u3068\u306b\u8d77\u56e0\u3059\u308b\u3082\u306e__\n \n```\ndate,        user_id,   user_status, status_1day_ago, status_2day_ago, status_3day_ago\n2015-07-14   000000175        A            NULL             C                D\n```\n\n### _\u3010\u53c2\u8003\u3011 AWS Redshift \u3092\u4f7f\u3063\u3066\u3044\u3066\u3001where\u53e5\u306e\u300c\u4eca\u65e5\u306eX\u65e5\u524d\u300d\uff5e\u300c\u4eca\u65e5\u300d\u3092\u52d5\u7684\u306b\u8a2d\u5b9a\u3059\u308b\u5834\u5408__\n\n```{SQL:SQL}\nWith temp as (\nselect date, \n       user_id,\n       user_status,\n       lag(uer_status, 1) over(partition by user_id order by date) as status_1day_ago,\n       lag(uer_status, 2) over(partition by user_id order by date) as status_2day_ago,\n       lag(uer_status, 3) over(partition by user_id order by date) as status_3day_ago,\nfrom game_event_table\nwhere date between current_date + interval '-3 day' and current_date\n)\nselect *\nfrom temp\nwhere date = current_date\n;\n```\n\n\u3068\u306f\u3044\u3048\u3001\u305d\u306e\u65e5\u306e\u30c7\u30fc\u30bf\u304cDB\u306b\u5b8c\u5168\u306a\u5f62\u3067\u6295\u5165\u5b8c\u4e86\u3059\u308b\u306e\u306f\u3001\u7fcc\u671d\u4ee5\u964d\u3067\u3042\u308b\u3053\u3068\u591a\u3044\u306e\u3067\u3001\u96c6\u8a08\u5bfe\u8c61\u306f\u3001\u300e\u6628\u65e5\u300f\u307e\u3067\u306e\u30c7\u30fc\u30bf\u306b\u3059\u308b\u306e\u304c\u5b9f\u52d9\u7684\u3060\u308d\u3046\u3002\n\n\n```{SQL:SQL}\nWith temp as (\nselect date, \n       user_id,\n       user_status,\n       lag(uer_status, 1) over(partition by user_id order by date) as status_1day_ago,\n       lag(uer_status, 2) over(partition by user_id order by date) as status_2day_ago,\n       lag(uer_status, 3) over(partition by user_id order by date) as status_3day_ago,\nfrom game_event_table\nwhere date between current_date + interval '-4 day' and current_date + interval '-1 day'\n)\nselect *\nfrom temp\nwhere date = current_date + interval '-1 day'\n;\n```\n___\n\n\n__\uff08\u4f8b\uff09\u65e5\u4ed8\u30ab\u30e9\u30e0\u3092\u8ef8\u306b\u3057\u3066\u3001\u300c\uff08\u30ab\u30ec\u30f3\u30c8\u30ec\u30b3\u30fc\u30c9\u306e\uff09\u65e5\u4ed8\u3001\u30b2\u30fc\u30e0\u30a4\u30d9\u30f3\u30c8\u540d, \uff08\u30ab\u30ec\u30f3\u30c8\u30ec\u30b3\u30fc\u30c9\u306e\uff09\u30a2\u30af\u30c6\u30a3\u30d6UU\u6570\u3001\uff08\u30ab\u30ec\u30f3\u30c8\u30ec\u30b3\u30fc\u30c9\u306e\u300c\u65e5\u4ed8\u300d\u304b\u3089\u6570\u30ec\u30b3\u30fc\u30c9\u524d\uff08\u6570\u65e5\u524d\uff09\u30ec\u30b3\u30fc\u30c9\u306e\uff09\u300c\u30a2\u30af\u30c6\u30a3\u30d6UU\u300d__\n\n### **\u3010DB\u60f3\u5b9a\u3011**\n__Amazon Redshift\u3092\u4f7f\u7528\u3057\u3066\u304a\u308a\u3001datetime\u5217\u306b\u3001YYYY-MM-DD HH24:MI:SS \u304c\u683c\u7d0d\u3055\u308c\u3066\u3044\u308b\u5834\u5408\u3092\u4eee\u5b9a__\n\n### **\u3010\u8981\u6ce8\u610f\u3011UU_3ago\u5217\u306f\u3001\u30ab\u30ec\u30f3\u30c8\u30ec\u30b3\u30fc\u30c9\u306e\u65e5\u4ed8\uff08date)\u306e\u300c\uff13\u65e5\u524d\u300d\u3092\u5fc5\u305a\u610f\u5473\u3059\u308b\u308f\u3051\u3067\u306f\u306a\u3044\u3002**\n#### __\u30ab\u30ec\u30f3\u30c8\u30ec\u30b3\u30fc\u30c9\u306e\uff13\u30ec\u30b3\u30fc\u30c9\u524d\uff08date\u306e\u5024\u3067\u5168\u30ec\u30b3\u30fc\u30c9\u3092\u964d\u9806\u306b\u4e26\u3079\u305f\u3068\u304d\u306b\u3001\u30ab\u30ec\u30f3\u30c8\u30ec\u30b3\u30fc\u30c9\u306e\uff13\u30ec\u30b3\u30fc\u30c9\u524d\uff09\u306edate\u306e\u5024\u3092\u610f\u5473\u3059\u308b\u3002__\n#### __\u30af\u30a8\u30ea\u304c\u8fd4\u3059\u7d50\u679c\u306edate\u5217\u304c\u30017/14, 7/13, 7/10, 7/8, 7/6, 7/5, 5/28, 5/24 \u3068\u4e26\u3093\u3067\u3044\u305f\u5834\u5408\u3001\u4e00\u756a\u4e0a\uff08date = 7/14)\u306e\u30ec\u30b3\u30fc\u30c9\u306eUU_3ago\u5217\u306e\u5024\u306f\u3001date\u5217\u304c7/8\u306e\u30ec\u30b3\u30fc\u30c9\u306eUU\u306e\u5024\u306b\u306a\u308b\u3002 __\n\n```{SQL:SQL}\nWith temp as (\nselect date_trunc('day', datetime) as date,\n       game_event_name,\n\t   count(distinct user_id) as UU\nfrom   game_event_table\ngroup by date, game_event_name\nhaving date_trunc('day', datetime) between current_date + interval '-9 DAY' and current_date + interval '-1 day' \n)\nselect date,\n       game_event_name,\n\t   UU,\n\t   lag(UU, 1) over(partition by game_event_name order by date) as UU_1ago,\n\t   lag(UU, 2) over(partition by game_event_name order by date) as UU_2ago,\n\t   lag(UU, 3) over(partition by game_event_name order by date) as UU_3ago,\n\t   lag(UU, 4) over(partition by game_event_name order by date) as UU_4ago,\n\t   lag(UU, 5) over(partition by game_event_name order by date) as UU_5ago,\n\t   lag(UU, 6) over(partition by game_event_name order by date) as UU_6ago,\n\t   lag(UU, 7) over(partition by game_event_name order by date) as UU_7ago\t   \nfrom   temp\norder by date desc\n;\n```\n\n___\n\n#### **\uff08 \u76f4\u8fd1\uff08\u203b\u30c7\u30fc\u30bf\u304c\u683c\u7d0d\u3055\u308c\u3066\u3044\u308b\u518d\u76f4\u8fd1\u65e5\uff1d\u6628\u65e5\uff09\uff11\u65e5\u5206\u306e\u30ec\u30b3\u30fc\u30c9\u306e\u307f\u53c2\u7167\u3057\u305f\u3044\u5834\u5408 )**\n\n\n\n```{SQL:SQL}\nWith temp as (\nselect date_trunc('day', datetime) as date,\n       game_event_name,\n\t   count(distinct user_id) as UU\nfrom   game_event_table\ngroup by date, game_event_name\nhaving date_trunc('day', datetime) between current_date + interval '-9 DAY' and current_date + interval '-1 day' \n), temp_2 as (\nselect date,\n       game_event_name,\n\t   UU,\n\t   lag(UU, 1) over(partition by game_event_name order by date) as UU_1ago,\n\t   lag(UU, 2) over(partition by game_event_name order by date) as UU_2ago,\n\t   lag(UU, 3) over(partition by game_event_name order by date) as UU_3ago,\n\t   lag(UU, 4) over(partition by game_event_name order by date) as UU_4ago,\n\t   lag(UU, 5) over(partition by game_event_name order by date) as UU_5ago,\n\t   lag(UU, 6) over(partition by game_event_name order by date) as UU_6ago,\n\t   lag(UU, 7) over(partition by game_event_name order by date) as UU_7ago\t   \nfrom   temp\n)\nselect *\nfrom temp_2\nwhere date = current_date + interval '-1 day'\n;\n```\n\n\n\n", "tags": ["SQL", "redshift", "\u6642\u7cfb\u5217\u89e3\u6790", "\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9", "\u30c7\u30fc\u30bf\u5206\u6790"]}