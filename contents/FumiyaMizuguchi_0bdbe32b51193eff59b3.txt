{"context": " More than 1 year has passed since last update.Ruby on Rails\u3092\u4f7f\u3063\u3066Facebook\u8a8d\u8a3c+\u30da\u30fc\u30b8\u306b\u3044\u3044\u306d\u3057\u306a\u3044\u3068\u30b3\u30f3\u30c6\u30f3\u30c4\u3092\u898b\u308b\u3053\u3068\u304c\u51fa\u6765\u306a\u3044\u30b5\u30fc\u30d3\u30b9\u3092\u4f5c\u3063\u305f\u306e\u3067\u3001\u5b9f\u88c5\u65b9\u6cd5\u3092\u66f8\u3044\u3066\u304a\u304d\u307e\u3059\u3002\u5e83\u544a\u7528\u306b\u30a2\u30d7\u30ea\u3092\u4f5c\u308a\u305f\u3044\uff01\u3068\u3044\u3046\u6642\u3068\u304b\u306b\u5f79\u7acb\u3064\u6a5f\u80fd\u3060\u3068\u601d\u3044\u307e\u3059\u3002\n\u5b9f\u88c5\u4f8b\uff1a\u300c\u540c\u3058\u8a95\u751f\u65e5\u306e\u6709\u540d\u4eba\u306f\u8ab0\uff1f\u300d\n\u3053\u306eWeb\u30a2\u30d7\u30ea\u3068\u540c\u3058\u5b9f\u88c5\u3092\u3057\u3066\u3044\u304d\u307e\u3059\u3002\n\n\u74b0\u5883\n\nRuby (2.1.1p76)\nRails (4.1.1)\ndevise (3.2.4)\nomniauth-facebook (1.6.0)\nkoala (1.8.0)\n\n\nGem\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\nGemfile\u306b\u4ee5\u4e0b\u306e\u30b3\u30fc\u30c9\u3092\u8ffd\u52a0\u3057\u3066bundle install\u3057\u307e\u3059\u3002\n# Gemfile\n\ngem 'devise'\ngem 'omniauth-facebook'\ngem 'koala'\n\n\n\u30e6\u30fc\u30b6\u8a8d\u8a3c\u6a5f\u80fd\u306e\u5b9f\u88c5\n\u30e6\u30fc\u30b6\u8a8d\u8a3c\u306bdevise\u3068omniauth-facebook\u3092\u4f7f\u3063\u3066\u3044\u304d\u307e\u3059\u3002\n\nDevise\u306e\u5c0e\u5165\n# config/inistializer/devise.rb\u3092(\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb)\u4f5c\u6210\n$ rails g devise:install\n\n# devise\u306e\u8a8d\u8a3c\u7528\u306eview\u306e\u4f5c\u6210\n$ bundle exec rails g devise:views\n\u3000\n# \u8a8d\u8a3c\u7528\u306e\u30e2\u30c7\u30eb\u3092\u4f5c\u6210(\u4eca\u56de\u306fUser\u306b\u3057\u305f)\n$ rails g devise user\n\n\n\nDevise\u306emigration\u8a2d\u5b9a\nFacebook\u306e\u8a8d\u8a3c\u306b\u5fc5\u8981\u306a\u30ab\u30e9\u30e0\u3092User\u30e2\u30c7\u30eb\u306b\u8ffd\u52a0\u3057\u3066\u3044\u304d\u307e\u3059\u3002\n# db/migrate/*_devise_create_users.rb\n\nclass DeviseCreateUsers < ActiveRecord::Migration\n  def change\n    create_table(:users) do |t|\n\n      ## \u3053\u306e3\u3064\u3092\u8ffd\u52a0\u3059\u308b\uff01\uff01\n      t.integer :uid, null: false, limit: 8\n      t.string :provider\n      t.string :token\n\n      ## Database authenticatable\n      t.string :email,              null: false, default: \"\"\n      t.string :encrypted_password, null: false, default: \"\"\n\n      ## Recoverable\n      t.string   :reset_password_token\n      t.datetime :reset_password_sent_at\n\n      ## Rememberable\n      t.datetime :remember_created_at\n\n      ## Trackable\n      t.integer  :sign_in_count, default: 0, null: false\n      t.datetime :current_sign_in_at\n      t.datetime :last_sign_in_at\n      t.string   :current_sign_in_ip\n      t.string   :last_sign_in_ip\n\n      t.timestamps\n    end\n\n    add_index :users, :email,                unique: true\n    add_index :users, :reset_password_token, unique: true\n\n  end\nend\n\n\u8ffd\u52a0\u3057\u7d42\u308f\u3063\u305f\u3089migrate\u3057\u307e\u3057\u3087\u3046\n$ bundle exec rake db:migrate\n\n\ndevise\u306e\u30e2\u30c7\u30eb\u3092\u7de8\u96c6\nUser\u30e2\u30c7\u30eb\u306bomniauth\u3092\u4f7f\u7528\u3059\u308b\u3053\u3068\u3092\u8a18\u5165\u3057\u307e\u3059\u3002\n# app/models/user.rb\n\nclass User < ActiveRecord::Base\n\n  devise :database_authenticatable, :omniauthable, :registerable,\n         :recoverable, :rememberable, :trackable, :validatable\nend\n\n\nFacebook\u30a2\u30d7\u30ea\u306e\u767b\u9332\n\n\u3053\u3061\u3089\u306e\u30b5\u30a4\u30c8\u3092\u898b\u3066\u3001\u958b\u767a\u8005\u767b\u9332\u3001\u30a2\u30d7\u30ea\u306e\u767b\u9332\u3092\u6e08\u307e\u305b\u308b\n[Settings]\u304b\u3089[Add Platform]\u3092\u30af\u30ea\u30c3\u30af\u3057\u3001[Website]\u3092\u9078\u629e\n[App Details]\u3067\u5404\u7a2e\u8a2d\u5b9a\u3092\u3059\u307e\u305b\u308b\n\n\u203b SiteURL\u306f\u958b\u767a\u74b0\u5883\u306a\u3089 http://localhost:3000/ \u3068\u304b\u3068\u308a\u3042\u3048\u305a\u3044\u308c\u3068\u3044\u3066\u4e0b\u3055\u3044\u3002\n\nAPI Key\u306e\u8a2d\u5b9a\n\u53d6\u5f97\u3057\u305fApp ID, App Secret\u3092devise.rb\u306b\u8a18\u5165\u3057\u3066\u3044\u304d\u307e\u3059\u3002\n# config/initializers/devise.rb\n\nDevise.setup do |config|\n  # ...\n\n  # API key\n  config.omniauth :facebook, \"App ID\", \"App Secret\",\n    scope: 'basic_info, email, user_likes, public_profile'\n\nend\n\n\nOAuth \u306e callback \u7528\u30eb\u30fc\u30c6\u30a3\u30f3\u30b0\u3092\u8ffd\u52a0\nconfig/routes.rb \u306b callback \u7528\u306e\u30eb\u30fc\u30c6\u30a3\u30f3\u30b0\u3092\u8ffd\u52a0\u3057\u307e\u3059\u3002\n# config/routes.rb\n\ndevise_for :users, :controllers => {\n  :omniauth_callbacks => \"users/omniauth_callbacks\" \n}\n\n\nUsers::OmniauthCallbacksController \u3092\u4f5c\u6210\nomniauth_callbacks_controller.rb\u3068\u3044\u3046\u30d5\u30a1\u30a4\u30eb\u3092app/controllers/users/\u306b\u4f5c\u6210\u3057\u3001\u4ee5\u4e0b\u306e\u5185\u5bb9\u3092\u8a18\u8ff0\u3057\u307e\u3059\u3002\nclass Users::OmniauthCallbacksController < Devise::OmniauthCallbacksController\n  def facebook\n    # You need to implement the method below in your model (e.g. app/models/user.rb)\n    @user = User.find_for_facebook_oauth(request.env[\"omniauth.auth\"], current_user)\n\n    if @user.persisted?\n      set_flash_message(:notice, :success, :kind => \"Facebook\") if is_navigational_format?\n      sign_in_and_redirect @user, :event => :authentication\n    else\n      session[\"devise.facebook_data\"] = request.env[\"omniauth.auth\"]\n      redirect_to new_user_registration_url\n    end\n  end\n\nend\n\n\nfind_for_facebook_oauth\u30e1\u30bd\u30c3\u30c9\u306e\u5b9a\u7fa9\n\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u30e1\u30bd\u30c3\u30c9\u306e\u4e2d\u3067find_for_facebook_oauth\u3068\u3044\u3046\u30e1\u30bd\u30c3\u30c9\u3092\u4f7f\u7528\u3059\u308b\u306e\u3067\u3001\u3053\u308c\u3092\u5b9a\u7fa9\u3057\u307e\u3059\u3002app/models/user.rb\u306b\u4ee5\u4e0b\u306e\u5185\u5bb9\u3092\u8ffd\u52a0\u3057\u3066\u4e0b\u3055\u3044\u3002\n# app/models/user.rb\n\ndef self.find_for_facebook_oauth(auth, signed_in_resource=nil)\n  user = User.where(:provider => auth.provider, :uid => auth.uid).first\n  unless user\n    user = User.create(name:     auth.extra.raw_info.name,\n                       provider: auth.provider,\n                       uid:      auth.uid,\n                       email:    auth.info.email,\n                       password: Devise.friendly_token[0,20]\n                      )\n  end\n  user\nend\n\n\nView\u306bOauth\u8a8d\u8a3c\u306e\u30ea\u30f3\u30af\u3092\u8ffd\u52a0\n\u30c8\u30c3\u30d7\u753b\u9762\u7b49\u3001Facebook\u8a8d\u8a3c\u3092\u3055\u305b\u305f\u3044\u753b\u9762\u306b\u4ee5\u4e0b\u306e\u30ea\u30f3\u30af\u3092\u633f\u5165\u3057\u307e\u3059\u3002\n<%= link_to \"Facebook\u3067\u30b5\u30a4\u30f3\u30a4\u30f3\", user_omniauth_authorize_path(:facebook) %>\n\n\u3068\u308a\u3042\u3048\u305a\u3053\u3053\u307e\u3067\u3067facebook\u8a8d\u8a3c\u306f\u5b9f\u88c5\u51fa\u6765\u305f\u306f\u305a\u3067\u3059\u3002\n\n\u3044\u3044\u306d\u3057\u306a\u3044\u3068\u8868\u793a\u51fa\u6765\u306a\u3044\u6a5f\u80fd\u306e\u5b9f\u88c5\n\u3067\u306f\u3001\u3044\u3044\u306d\u3092\u3057\u306a\u3044\u3068\u8868\u793a\u51fa\u6765\u306a\u3044\u30b3\u30f3\u30c6\u30f3\u30c4\u3092\u4f5c\u6210\u3057\u3066\u3044\u304d\u307e\u3057\u3087\u3046\u3002\n\u3053\u3053\u3067\u306f\u3001\u4f8b\u3068\u3057\u3066\u3001pages_controller\u3092\u4f5c\u6210\u3057\u3001check\u30a2\u30af\u30b7\u30e7\u30f3\u3067\u3044\u3044\u306d\u3057\u3066\u3044\u308b\u304b\u3069\u3046\u304b\u306e\u30c1\u30a7\u30c3\u30af\u3001\u304a\u3088\u3073\u306b\u3044\u3044\u306d\u3092\u3055\u305b\u308b\u3002result\u30a2\u30af\u30b7\u30e7\u30f3\u3067\u30b3\u30f3\u30c6\u30f3\u30c4\u3092\u8868\u793a\u3057\u3066\u3044\u304d\u307e\u3059\u3002\n\n\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u306e\u4f5c\u6210\n\u307e\u305a\u306f\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u3092\u4f5c\u6210\u3057\u307e\u3057\u3087\u3046\u3002\n$ rails generate controller page check result\n\n\u7d9a\u3044\u3066\u3001\u30ed\u30b0\u30a4\u30f3\u3057\u3066\u308b\u30e6\u30fc\u30b6\u306e\u307f\u30a2\u30af\u30bb\u30b9\u3067\u304d\u308b\u3088\u3046\u306b\u3001pages_controler\u306b :authenticate_user!\u30e1\u30bd\u30c3\u30c9\u3092\u8ffd\u52a0\n# app/controllers/pages_controller.rb\n\nclass PagesController < ApplicationController\n  before_filter :authenticate_user!\n\n  def result\n  end\n\n  def check\n  end\n\nend\n\n\u30eb\u30fc\u30c6\u30a3\u30f3\u30b0\u8a2d\u5b9a\u3082\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n# config/routes.rb\n\nmatch \"/result\", to: \"pages#result\", via: \"get\"\nmatch \"/check\", to: \"pages#check\", via: \"get\"\n\n\ncheck\u3092\u901a\u3089\u305a\u306bresult\u306b\u3044\u3051\u306a\u3044\u3088\u3046\u306b\u3059\u308b\ncheck\u3092\u901a\u3089\u305a\u306bresult\u3092\u8868\u793a\u51fa\u6765\u306a\u3044\u3088\u3046\u306b\u3057\u3066\u3044\u304d\u307e\u3059\u3002\u307e\u305a\u306f\u753b\u9762\u9077\u79fb\u3092session\u306b\u8a18\u9332\u3059\u308b\u3088\u3046\u306b\u3057\u307e\u3059\u3002\n# app/controllers/application_controller.rb\n\nclass ApplicationController < ActionController::Base\n\n  protect_from_forgery with: :null_session\n  after_filter :store_location\n\n  def store_location\n    session[:previous_url] = request.fullpath \n  end\nend\n\n\u6b21\u306b\u3001pages_controller\u306eresult\u30e1\u30bd\u30c3\u30c9\u306b\u4ee5\u4e0b\u306e\u5185\u5bb9\u3092\u8a18\u5165\u3057\u307e\u3059\n# app/controllers/pages_controller.rb\n\nclass PagesController < ApplicationController\n  before_filter :authenticate_user!\n\n  def result\n    if session[:previous_url] != check_path && session[:previous_url] != result_path\n      redirect_to check_path\n    end\n  end\n\n#...\nend\n\n\n\u30da\u30fc\u30b8\u306b\u30a4\u30a4\u30cd\u3057\u3066\u3044\u308b\u304b\u306e\u30c1\u30a7\u30c3\u30af\uff01\nkoala\u3092\u4f7f\u3063\u3066\u3001\u7279\u5b9a\u306efacebook\u30da\u30fc\u30b8\u306b\u30a4\u30a4\u30cd\u3057\u3066\u3044\u308b\u304b\u3069\u3046\u304b\u306e\u30c1\u30a7\u30c3\u30af\u3092\u3057\u3066\u3044\u304d\u307e\u3059\u3002\n\u307e\u305a\u306fuser\u30e2\u30c7\u30eb\u306b\u30e6\u30fc\u30b6\u306efacebook graph\u3092\u53d6\u5f97\u3059\u308b\u30e1\u30bd\u30c3\u30c9\u3092\u8ffd\u52a0\u3057\u307e\u3059\u3002\n# app/models/user.rb\n\nclass User < ActiveRecord::Base\n  # ...\n\n  def graph\n    Koala::Facebook::API.new(self.token)\n  end\nend\n\n\u6b21\u306bpages_controller\u306echeck\u30a2\u30af\u30b7\u30e7\u30f3\u3067\u30e6\u30fc\u30b6\u304c\u3044\u3044\u306d\u3092\u3057\u3066\u3044\u305f\u3089result\u306b\u98db\u3070\u3059\u5b9f\u88c5\u3092\u3057\u3066\u3044\u304d\u307e\u3059\u3002\n# app/controllers/pages_controller.rb\n\nclass PagesController < ApplicationController\n  # ...\n  def check\n    client = current_user.graph\n    likes = client.get_connections(\"me\", \"likes\")\n    likes.each do |like|\n      if like[\"id\"] == \"\u3042\u306a\u305f\u306eFacebook\u30da\u30fc\u30b8\u306eID\"\n        redirect_to result_path\n      end\n    end\n  end\n\nend\n\n\n\u30d3\u30e5\u30fc\u306b\u3044\u3044\u306d\u30dc\u30bf\u30f3\u3092\u8ffd\u52a0\n\u6700\u5f8c\u306b\u3001check\u30a2\u30af\u30b7\u30e7\u30f3\u306b\u4f7f\u3046view\u306b\u3044\u3044\u306d\u30dc\u30bf\u30f3\u3092\u57cb\u3081\u8fbc\u307f\u307e\u3057\u3087\u3046\u3002\n<!-- app/views/pages/check.html.erb -->\n\n<p>\u7d50\u679c\u3092\u898b\u308b\u306b\u306f\u4e0b\u306e\u3044\u3044\u306d!\u30dc\u30bf\u30f3\u3092\u62bc\u3057\u3066\u4e0b\u3055\u3044</p>\n<div class=\"like-box\"><div class=\"fb-like\" data-href=\"\u3042\u306a\u305f\u306efacebook\u30da\u30fc\u30b8\u306eURL\" data-width=\"500\" data-layout=\"box_count\" data-action=\"like\" data-show-faces=\"true\" data-share=\"false\"></div></div>\n<div id=\"fb-root\"></div>\n\n<script>\n// facebook\nwindow.fbAsyncInit = function() {\n  FB.init({\n    appId      : '\u3042\u306a\u305f\u306eAPP ID',\n    status     : false, // check the login status upon init?\n    cookie     : true, // set sessions cookies to allow your server to access the session?\n    xfbml      : true  // parse XFBML tags on this page?\n  });\n\n  // \u3044\u3044\u306d\u3057\u305f\u3068\u304d\u306e\u51e6\u7406\n  FB.Event.subscribe('edge.create',\n    function(response) {\n      location.href = \"<%= result_url %>\";\n    }\n  );\n};\n</script>\n\n\u4ee5\u4e0a\u3067\u3059\u3002\u5f8c\u306f\u597d\u304d\u306bview\u3084\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u3092\u3044\u3058\u3063\u3066\u30b3\u30f3\u30c6\u30f3\u30c4\u3092\u4f5c\u6210\u3057\u3066\u4e0b\u3055\u3044\u3002\n\u304a\u75b2\u308c\u3055\u307e\u3067\u3057\u305f\u3002\n\n\u53c2\u8003\n\n\u300cplataformatec/devise\u300d\nEasyRamble - Rails4 \u3067 Devise \u3068 OmniAuth \u3067\u3001Twitter/Facebook \u306eOAuth\u8a8d\u8a3c\u3068\u901a\u5e38\u30d5\u30a9\u30fc\u30e0\u3067\u306e\u8a8d\u8a3c\u3092\u4f75\u7528\u3057\u3066\u5b9f\u88c5\narsduo/koala\n\n\u30d6\u30ed\u30b0\u3084\u3063\u3066\u307e\u3059\uff01\uff01\n=>http://alex23drum.hatenablog.com\nRuby on Rails\u3092\u4f7f\u3063\u3066Facebook\u8a8d\u8a3c+\u30da\u30fc\u30b8\u306b\u3044\u3044\u306d\u3057\u306a\u3044\u3068\u30b3\u30f3\u30c6\u30f3\u30c4\u3092\u898b\u308b\u3053\u3068\u304c\u51fa\u6765\u306a\u3044\u30b5\u30fc\u30d3\u30b9\u3092\u4f5c\u3063\u305f\u306e\u3067\u3001\u5b9f\u88c5\u65b9\u6cd5\u3092\u66f8\u3044\u3066\u304a\u304d\u307e\u3059\u3002\u5e83\u544a\u7528\u306b\u30a2\u30d7\u30ea\u3092\u4f5c\u308a\u305f\u3044\uff01\u3068\u3044\u3046\u6642\u3068\u304b\u306b\u5f79\u7acb\u3064\u6a5f\u80fd\u3060\u3068\u601d\u3044\u307e\u3059\u3002\n\u5b9f\u88c5\u4f8b\uff1a[\u300c\u540c\u3058\u8a95\u751f\u65e5\u306e\u6709\u540d\u4eba\u306f\u8ab0\uff1f\u300d](http://same-birthday-2zigexn.sqale.jp)\n\u3053\u306eWeb\u30a2\u30d7\u30ea\u3068\u540c\u3058\u5b9f\u88c5\u3092\u3057\u3066\u3044\u304d\u307e\u3059\u3002\n\n## \u74b0\u5883\n\n* Ruby (2.1.1p76)\n* Rails (4.1.1)\n* devise (3.2.4)\n* omniauth-facebook (1.6.0)\n* koala (1.8.0)\n\n## Gem\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\nGemfile\u306b\u4ee5\u4e0b\u306e\u30b3\u30fc\u30c9\u3092\u8ffd\u52a0\u3057\u3066`bundle install`\u3057\u307e\u3059\u3002\n\n```ruby\n# Gemfile\n\ngem 'devise'\ngem 'omniauth-facebook'\ngem 'koala'\n```\n\n# \u30e6\u30fc\u30b6\u8a8d\u8a3c\u6a5f\u80fd\u306e\u5b9f\u88c5\n\n\u30e6\u30fc\u30b6\u8a8d\u8a3c\u306bdevise\u3068omniauth-facebook\u3092\u4f7f\u3063\u3066\u3044\u304d\u307e\u3059\u3002\n\n## Devise\u306e\u5c0e\u5165\n\n```bash\n# config/inistializer/devise.rb\u3092(\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb)\u4f5c\u6210\n$ rails g devise:install\n\n# devise\u306e\u8a8d\u8a3c\u7528\u306eview\u306e\u4f5c\u6210\n$ bundle exec rails g devise:views\n\u3000\n# \u8a8d\u8a3c\u7528\u306e\u30e2\u30c7\u30eb\u3092\u4f5c\u6210(\u4eca\u56de\u306fUser\u306b\u3057\u305f)\n$ rails g devise user\n\n```\n\n## Devise\u306emigration\u8a2d\u5b9a\n\nFacebook\u306e\u8a8d\u8a3c\u306b\u5fc5\u8981\u306a\u30ab\u30e9\u30e0\u3092User\u30e2\u30c7\u30eb\u306b\u8ffd\u52a0\u3057\u3066\u3044\u304d\u307e\u3059\u3002\n\n```bash\n# db/migrate/*_devise_create_users.rb\n\nclass DeviseCreateUsers < ActiveRecord::Migration\n  def change\n    create_table(:users) do |t|\n\n      ## \u3053\u306e3\u3064\u3092\u8ffd\u52a0\u3059\u308b\uff01\uff01\n      t.integer :uid, null: false, limit: 8\n      t.string :provider\n      t.string :token\n\n      ## Database authenticatable\n      t.string :email,              null: false, default: \"\"\n      t.string :encrypted_password, null: false, default: \"\"\n\n      ## Recoverable\n      t.string   :reset_password_token\n      t.datetime :reset_password_sent_at\n\n      ## Rememberable\n      t.datetime :remember_created_at\n\n      ## Trackable\n      t.integer  :sign_in_count, default: 0, null: false\n      t.datetime :current_sign_in_at\n      t.datetime :last_sign_in_at\n      t.string   :current_sign_in_ip\n      t.string   :last_sign_in_ip\n\n      t.timestamps\n    end\n\n    add_index :users, :email,                unique: true\n    add_index :users, :reset_password_token, unique: true\n\n  end\nend\n```\n\n\u8ffd\u52a0\u3057\u7d42\u308f\u3063\u305f\u3089migrate\u3057\u307e\u3057\u3087\u3046\n\n```bash\n$ bundle exec rake db:migrate\n```\n\n## devise\u306e\u30e2\u30c7\u30eb\u3092\u7de8\u96c6\nUser\u30e2\u30c7\u30eb\u306bomniauth\u3092\u4f7f\u7528\u3059\u308b\u3053\u3068\u3092\u8a18\u5165\u3057\u307e\u3059\u3002\n\n```ruby\n# app/models/user.rb\n\nclass User < ActiveRecord::Base\n\n  devise :database_authenticatable, :omniauthable, :registerable,\n         :recoverable, :rememberable, :trackable, :validatable\nend\n```\n\n## Facebook\u30a2\u30d7\u30ea\u306e\u767b\u9332\n\n1. [\u3053\u3061\u3089](http://princesswell.rocketserver.jp/web-cheat-sheet/facebook-developers-application/)\u306e\u30b5\u30a4\u30c8\u3092\u898b\u3066\u3001\u958b\u767a\u8005\u767b\u9332\u3001\u30a2\u30d7\u30ea\u306e\u767b\u9332\u3092\u6e08\u307e\u305b\u308b\n\n2. [Settings]\u304b\u3089[Add Platform]\u3092\u30af\u30ea\u30c3\u30af\u3057\u3001[Website]\u3092\u9078\u629e\n3. [App Details]\u3067\u5404\u7a2e\u8a2d\u5b9a\u3092\u3059\u307e\u305b\u308b\n\n\u203b SiteURL\u306f\u958b\u767a\u74b0\u5883\u306a\u3089 http://localhost:3000/ \u3068\u304b\u3068\u308a\u3042\u3048\u305a\u3044\u308c\u3068\u3044\u3066\u4e0b\u3055\u3044\u3002\n\n## API Key\u306e\u8a2d\u5b9a\n\n\u53d6\u5f97\u3057\u305fApp ID, App Secret\u3092devise.rb\u306b\u8a18\u5165\u3057\u3066\u3044\u304d\u307e\u3059\u3002\n\n```ruby\n# config/initializers/devise.rb\n\nDevise.setup do |config|\n  # ...\n \n  # API key\n  config.omniauth :facebook, \"App ID\", \"App Secret\",\n    scope: 'basic_info, email, user_likes, public_profile'\n\nend\n```\n\n## OAuth \u306e callback \u7528\u30eb\u30fc\u30c6\u30a3\u30f3\u30b0\u3092\u8ffd\u52a0\n\nconfig/routes.rb \u306b callback \u7528\u306e\u30eb\u30fc\u30c6\u30a3\u30f3\u30b0\u3092\u8ffd\u52a0\u3057\u307e\u3059\u3002\n\n```ruby\n# config/routes.rb\n\ndevise_for :users, :controllers => {\n  :omniauth_callbacks => \"users/omniauth_callbacks\" \n}\n```\n\n## Users::OmniauthCallbacksController \u3092\u4f5c\u6210\n\nomniauth_callbacks_controller.rb\u3068\u3044\u3046\u30d5\u30a1\u30a4\u30eb\u3092app/controllers/users/\u306b\u4f5c\u6210\u3057\u3001\u4ee5\u4e0b\u306e\u5185\u5bb9\u3092\u8a18\u8ff0\u3057\u307e\u3059\u3002\n\n```ruby\nclass Users::OmniauthCallbacksController < Devise::OmniauthCallbacksController\n  def facebook\n    # You need to implement the method below in your model (e.g. app/models/user.rb)\n    @user = User.find_for_facebook_oauth(request.env[\"omniauth.auth\"], current_user)\n \n    if @user.persisted?\n      set_flash_message(:notice, :success, :kind => \"Facebook\") if is_navigational_format?\n      sign_in_and_redirect @user, :event => :authentication\n    else\n      session[\"devise.facebook_data\"] = request.env[\"omniauth.auth\"]\n      redirect_to new_user_registration_url\n    end\n  end\n\nend\n```\n\n## find_for_facebook_oauth\u30e1\u30bd\u30c3\u30c9\u306e\u5b9a\u7fa9\n\n\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u30e1\u30bd\u30c3\u30c9\u306e\u4e2d\u3067find_for_facebook_oauth\u3068\u3044\u3046\u30e1\u30bd\u30c3\u30c9\u3092\u4f7f\u7528\u3059\u308b\u306e\u3067\u3001\u3053\u308c\u3092\u5b9a\u7fa9\u3057\u307e\u3059\u3002app/models/user.rb\u306b\u4ee5\u4e0b\u306e\u5185\u5bb9\u3092\u8ffd\u52a0\u3057\u3066\u4e0b\u3055\u3044\u3002\n\n```ruby\n# app/models/user.rb\n\ndef self.find_for_facebook_oauth(auth, signed_in_resource=nil)\n  user = User.where(:provider => auth.provider, :uid => auth.uid).first\n  unless user\n    user = User.create(name:     auth.extra.raw_info.name,\n                       provider: auth.provider,\n                       uid:      auth.uid,\n                       email:    auth.info.email,\n                       password: Devise.friendly_token[0,20]\n                      )\n  end\n  user\nend\n```\n\n## View\u306bOauth\u8a8d\u8a3c\u306e\u30ea\u30f3\u30af\u3092\u8ffd\u52a0\n\u30c8\u30c3\u30d7\u753b\u9762\u7b49\u3001Facebook\u8a8d\u8a3c\u3092\u3055\u305b\u305f\u3044\u753b\u9762\u306b\u4ee5\u4e0b\u306e\u30ea\u30f3\u30af\u3092\u633f\u5165\u3057\u307e\u3059\u3002\n\n```\n<%= link_to \"Facebook\u3067\u30b5\u30a4\u30f3\u30a4\u30f3\", user_omniauth_authorize_path(:facebook) %>\n```\n\u3068\u308a\u3042\u3048\u305a\u3053\u3053\u307e\u3067\u3067facebook\u8a8d\u8a3c\u306f\u5b9f\u88c5\u51fa\u6765\u305f\u306f\u305a\u3067\u3059\u3002\n\n# \u3044\u3044\u306d\u3057\u306a\u3044\u3068\u8868\u793a\u51fa\u6765\u306a\u3044\u6a5f\u80fd\u306e\u5b9f\u88c5\n\u3067\u306f\u3001\u3044\u3044\u306d\u3092\u3057\u306a\u3044\u3068\u8868\u793a\u51fa\u6765\u306a\u3044\u30b3\u30f3\u30c6\u30f3\u30c4\u3092\u4f5c\u6210\u3057\u3066\u3044\u304d\u307e\u3057\u3087\u3046\u3002\n\u3053\u3053\u3067\u306f\u3001\u4f8b\u3068\u3057\u3066\u3001pages_controller\u3092\u4f5c\u6210\u3057\u3001check\u30a2\u30af\u30b7\u30e7\u30f3\u3067\u3044\u3044\u306d\u3057\u3066\u3044\u308b\u304b\u3069\u3046\u304b\u306e\u30c1\u30a7\u30c3\u30af\u3001\u304a\u3088\u3073\u306b\u3044\u3044\u306d\u3092\u3055\u305b\u308b\u3002result\u30a2\u30af\u30b7\u30e7\u30f3\u3067\u30b3\u30f3\u30c6\u30f3\u30c4\u3092\u8868\u793a\u3057\u3066\u3044\u304d\u307e\u3059\u3002\n\n## \u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u306e\u4f5c\u6210\n\n\u307e\u305a\u306f\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u3092\u4f5c\u6210\u3057\u307e\u3057\u3087\u3046\u3002\n\n```bash\n$ rails generate controller page check result\n```\n\u7d9a\u3044\u3066\u3001\u30ed\u30b0\u30a4\u30f3\u3057\u3066\u308b\u30e6\u30fc\u30b6\u306e\u307f\u30a2\u30af\u30bb\u30b9\u3067\u304d\u308b\u3088\u3046\u306b\u3001pages_controler\u306b :authenticate_user!\u30e1\u30bd\u30c3\u30c9\u3092\u8ffd\u52a0\n\n```ruby\n# app/controllers/pages_controller.rb\n\nclass PagesController < ApplicationController\n  before_filter :authenticate_user!\n\n  def result\n  end\n\n  def check\n  end\n\nend\n```\n\n\u30eb\u30fc\u30c6\u30a3\u30f3\u30b0\u8a2d\u5b9a\u3082\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\n```ruby\n# config/routes.rb\n\nmatch \"/result\", to: \"pages#result\", via: \"get\"\nmatch \"/check\", to: \"pages#check\", via: \"get\"\n```\n\n\n## check\u3092\u901a\u3089\u305a\u306bresult\u306b\u3044\u3051\u306a\u3044\u3088\u3046\u306b\u3059\u308b\n\ncheck\u3092\u901a\u3089\u305a\u306bresult\u3092\u8868\u793a\u51fa\u6765\u306a\u3044\u3088\u3046\u306b\u3057\u3066\u3044\u304d\u307e\u3059\u3002\u307e\u305a\u306f\u753b\u9762\u9077\u79fb\u3092session\u306b\u8a18\u9332\u3059\u308b\u3088\u3046\u306b\u3057\u307e\u3059\u3002\n\n```ruby\n# app/controllers/application_controller.rb\n\nclass ApplicationController < ActionController::Base\n\n  protect_from_forgery with: :null_session\n  after_filter :store_location\n\n  def store_location\n    session[:previous_url] = request.fullpath \n  end\nend\n```\n\n\u6b21\u306b\u3001pages_controller\u306eresult\u30e1\u30bd\u30c3\u30c9\u306b\u4ee5\u4e0b\u306e\u5185\u5bb9\u3092\u8a18\u5165\u3057\u307e\u3059\n\n```ruby\n# app/controllers/pages_controller.rb\n\nclass PagesController < ApplicationController\n  before_filter :authenticate_user!\n\n  def result\n    if session[:previous_url] != check_path && session[:previous_url] != result_path\n      redirect_to check_path\n    end\n  end\n\n#...\nend\n```\n\n## \u30da\u30fc\u30b8\u306b\u30a4\u30a4\u30cd\u3057\u3066\u3044\u308b\u304b\u306e\u30c1\u30a7\u30c3\u30af\uff01\nkoala\u3092\u4f7f\u3063\u3066\u3001\u7279\u5b9a\u306efacebook\u30da\u30fc\u30b8\u306b\u30a4\u30a4\u30cd\u3057\u3066\u3044\u308b\u304b\u3069\u3046\u304b\u306e\u30c1\u30a7\u30c3\u30af\u3092\u3057\u3066\u3044\u304d\u307e\u3059\u3002\n\u307e\u305a\u306fuser\u30e2\u30c7\u30eb\u306b\u30e6\u30fc\u30b6\u306efacebook graph\u3092\u53d6\u5f97\u3059\u308b\u30e1\u30bd\u30c3\u30c9\u3092\u8ffd\u52a0\u3057\u307e\u3059\u3002\n\n```ruby\n# app/models/user.rb\n\nclass User < ActiveRecord::Base\n  # ...\n\n  def graph\n    Koala::Facebook::API.new(self.token)\n  end\nend\n```\n\n\u6b21\u306bpages_controller\u306echeck\u30a2\u30af\u30b7\u30e7\u30f3\u3067\u30e6\u30fc\u30b6\u304c\u3044\u3044\u306d\u3092\u3057\u3066\u3044\u305f\u3089result\u306b\u98db\u3070\u3059\u5b9f\u88c5\u3092\u3057\u3066\u3044\u304d\u307e\u3059\u3002\n\n```ruby\n# app/controllers/pages_controller.rb\n\nclass PagesController < ApplicationController\n  # ...\n  def check\n    client = current_user.graph\n    likes = client.get_connections(\"me\", \"likes\")\n    likes.each do |like|\n      if like[\"id\"] == \"\u3042\u306a\u305f\u306eFacebook\u30da\u30fc\u30b8\u306eID\"\n        redirect_to result_path\n      end\n    end\n  end\n\nend\n```\n\n## \u30d3\u30e5\u30fc\u306b\u3044\u3044\u306d\u30dc\u30bf\u30f3\u3092\u8ffd\u52a0\n\n\u6700\u5f8c\u306b\u3001check\u30a2\u30af\u30b7\u30e7\u30f3\u306b\u4f7f\u3046view\u306b\u3044\u3044\u306d\u30dc\u30bf\u30f3\u3092\u57cb\u3081\u8fbc\u307f\u307e\u3057\u3087\u3046\u3002\n\n```html\n<!-- app/views/pages/check.html.erb -->\n\n<p>\u7d50\u679c\u3092\u898b\u308b\u306b\u306f\u4e0b\u306e\u3044\u3044\u306d!\u30dc\u30bf\u30f3\u3092\u62bc\u3057\u3066\u4e0b\u3055\u3044</p>\n<div class=\"like-box\"><div class=\"fb-like\" data-href=\"\u3042\u306a\u305f\u306efacebook\u30da\u30fc\u30b8\u306eURL\" data-width=\"500\" data-layout=\"box_count\" data-action=\"like\" data-show-faces=\"true\" data-share=\"false\"></div></div>\n<div id=\"fb-root\"></div>\n\n<script>\n// facebook\nwindow.fbAsyncInit = function() {\n  FB.init({\n    appId      : '\u3042\u306a\u305f\u306eAPP ID',\n    status     : false, // check the login status upon init?\n    cookie     : true, // set sessions cookies to allow your server to access the session?\n    xfbml      : true  // parse XFBML tags on this page?\n  });\n\n  // \u3044\u3044\u306d\u3057\u305f\u3068\u304d\u306e\u51e6\u7406\n  FB.Event.subscribe('edge.create',\n    function(response) {\n      location.href = \"<%= result_url %>\";\n    }\n  );\n};\n</script>\n```\n\u4ee5\u4e0a\u3067\u3059\u3002\u5f8c\u306f\u597d\u304d\u306bview\u3084\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u3092\u3044\u3058\u3063\u3066\u30b3\u30f3\u30c6\u30f3\u30c4\u3092\u4f5c\u6210\u3057\u3066\u4e0b\u3055\u3044\u3002\n\u304a\u75b2\u308c\u3055\u307e\u3067\u3057\u305f\u3002\n\n# \u53c2\u8003\n\n* [\u300cplataformatec/devise\u300d](http://github.com/plataformatec/devise)\n* [EasyRamble - Rails4 \u3067 Devise \u3068 OmniAuth \u3067\u3001Twitter/Facebook \u306eOAuth\u8a8d\u8a3c\u3068\u901a\u5e38\u30d5\u30a9\u30fc\u30e0\u3067\u306e\u8a8d\u8a3c\u3092\u4f75\u7528\u3057\u3066\u5b9f\u88c5](http://easyramble.com/implement-devise-and-ominiauth-on-rails.html)\n* [arsduo/koala](https://github.com/arsduo/koala)\n\n\u30d6\u30ed\u30b0\u3084\u3063\u3066\u307e\u3059\uff01\uff01\n=>http://alex23drum.hatenablog.com\n", "tags": ["Rails", "Facebook", "Ruby", "OAuth", "Rails4"]}