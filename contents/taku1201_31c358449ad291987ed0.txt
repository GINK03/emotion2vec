{"context": "\n\n\u3053\u306e\u8a18\u4e8b\u306e\u5185\u5bb9\nELB(SSL Termination\u3057\u306a\u3044) -> \u8907\u6570\u306e\u540d\u524d\u30d9\u30fc\u30b9VirtualHost(SSL)\u306e\u632f\u308a\u5206\u3051\u8a2d\u5b9a\u3067\u3061\u3087\u3063\u3068\u30cf\u30de\u3063\u305f\u306e\u3067\u3001\u8abf\u3079\u3066\u8a66\u3057\u3066\u3046\u307e\u304f\u884c\u3063\u305f\u7d50\u679c\u3092\u30e1\u30e2\u3002\n\n\u74b0\u5883\nVPC: 192.168.0.0/16\nPublic Subnet: 192.168.0.0/24  (\u3053\u3063\u3061\u306bELB)\nPrivate Subnet: 192.168.1.0/24 (\u3053\u3063\u3061\u306bEC2)\nApache: httpd-2.4.18\n\n\u3084\u308a\u305f\u3044\u3053\u3068\n\nELB (SSL Termination\u3057\u306a\u3044) + EC2 (Apache + mod_ssl)\n\u540d\u524d\u30d9\u30fc\u30b9VirtualHost\u3067\u8907\u6570\u306e\u30b5\u30a4\u30c8\u3092\u30db\u30b9\u30c8\u3059\u308b \n\n\nhttpd.conf\u306e\u8a2d\u5b9a(\u5fc5\u8981\u306a\u3068\u3053\u308d\u306e\u307f)\n\nhttpd.conf\n\nListen 192.168.1.10:443\n\n# \u30c0\u30df\u30fc\u7528 (site-a\u3068site-b\u306b\u8a72\u5f53\u3057\u306a\u3044\u3082\u306e\u306f\u3059\u3079\u3066403\u6271\u3044\u306b\u3059\u308b)\n<VirtualHost 192.168.1.10:443>\n\n    ServerName            dummy\n    ServerAdmin           postmaster@example.com\n    DocumentRoot          \"/usr/local/httpd2/htdocs\"\n    DirectoryIndex        index.html\n\n    SSLEngine On\n    SSLCertificateFile    \"/usr/local/httpd2/ssl/server.crt\"\n    SSLCertificateKeyFile \"/usr/local/httpd2/ssl/server.key\"\n\n    <Directory \"/usr/local/httpd2/htdocs\">\n        Require all denied\n    </Directory>\n\n</VirtualHost>\n\n# site-a\u7528\u306eVirtualHost\n<VirtualHost 192.168.1.10:443>\n\n    ServerName            site-a.example.com\n    ServerAdmin           postmaster@example.com\n    DocumentRoot          \"/var/www/site-a\"\n    DirectoryIndex        index.html\n\n    SSLEngine On\n    SSLCertificateFile    \"/usr/local/httpd2/ssl/site-a.crt\"\n    SSLCertificateKeyFile \"/usr/local/httpd2/ssl/site-a.key\"\n\n    <Directory \"/var/www/site-a\">\n        Require all granted\n    </Directory>\n\n</VirtualHost>\n\n# site-b\u7528\u306eVirtualHost\n<VirtualHost 192.168.1.10:443>\n\n    ServerName            site-b.example.jp\n    ServerAdmin           postmaster@example.jp\n    DocumentRoot          \"/var/www/site-b\"\n    DirectoryIndex        index.html\n\n    SSLEngine On\n    SSLCertificateFile    \"/usr/local/httpd2/ssl/site-b.crt\"\n    SSLCertificateKeyFile \"/usr/local/httpd2/ssl/site-b.key\"\n\n    <Directory \"/var/www/site-b\">\n        Require all granted\n    </Directory>\n\n</VirtualHost>\n\n\n\nELB\u306e\u8a2d\u5b9a\n\u30ea\u30b9\u30ca\u30fc\u306e\u8a2d\u5b9a\u3067\u3001\u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b5\u30fc/\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3068\u3082\u306b\u30d7\u30ed\u30c8\u30b3\u30eb\u3092TCP:443\u306b\u8a2d\u5b9a\u3059\u308b\u3002\n\u3053\u3046\u3059\u308b\u3053\u3068\u3067\u3001ELB\u304cL4\u30ec\u30d9\u30eb\u306e\u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b5\u30fc\u3068\u3057\u3066\u632f\u308b\u821e\u3046(\u5358\u7d14\u306b\u88cf\u5074\u306eEC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306b\u632f\u308a\u5206\u3051\u3089\u308c\u308b)\u3002\n\u3053\u306e\u969b\u3001ELB\u306f\u5f53\u7136HTTP\u30d8\u30c3\u30c0\u3092\u8997\u304b\u306a\u3044\u306e\u3067\u3001X-Forwarded-For\u306a\u3069\u306e\u60c5\u5831\u3092\u5229\u7528\u3059\u308b\u3053\u3068\u306f\u3067\u304d\u306a\u304f\u306a\u308b\u3002\n\u3064\u307e\u308a\u672c\u6765\u306e\u63a5\u7d9a\u5143\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u3092\u7279\u5b9a\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u306a\u304f\u306a\u308b(Apache\u306e\u30ed\u30b0\u306b\u306fELB\u306e\u30d7\u30e9\u30a4\u30d9\u30fc\u30c8IP\u30a2\u30c9\u30ec\u30b9\u304c\u63a5\u7d9a\u5143\u3068\u3057\u3066\u8a18\u9332\u3055\u308c\u308b)\u3002\n\u305d\u306e\u4ee3\u308f\u308aELB\u3067\u306fX-Forwarded-For\u306e\u4ee3\u7528\u3068\u3057\u3066Proxy Protocol\u3092\u30b5\u30dd\u30fc\u30c8\u3059\u308b\u3088\u3046\u8a2d\u5b9a\u304c\u53ef\u80fd\u3067\u3042\u308b\u3002\nProxy Protocol\u306fL4\u30ec\u30d9\u30eb\u3067\u52d5\u4f5c\u3059\u308b\u30d7\u30ed\u30c8\u30b3\u30eb\u3067\u3001\u8ee2\u9001\u3092\u53d7\u3051\u305fWeb\u30b5\u30fc\u30d0\u306f\u3053\u3061\u3089\u306e\u60c5\u5831\u3092\u53c2\u7167\u3059\u308b\u3053\u3068\u3067\u3001\n\u63a5\u7d9a\u5143\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u3092\u7279\u5b9a\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u308b(Apache\u306f\u6a19\u6e96\u3067\u30b5\u30dd\u30fc\u30c8\u3057\u3066\u306a\u3044\u307f\u305f\u3044\uff1f)\u3002\n\u30b9\u30c6\u30c3\u30d71: \u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b5\u30fc\u306e\u5b9a\u7fa9\n\n\u30fb\u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b5\u30fc\u3092\u914d\u7f6e\u3059\u308b\u5834\u6240: 192.168.0.0/16\n\n\u30fb\u30ea\u30b9\u30ca\u30fc\u306e\u8a2d\u5b9a\n\n\u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b5\u30fc\u306e\u30d7\u30ed\u30c8\u30b3\u30eb  :  TCP\n\u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b5\u30fc\u306e\u30dd\u30fc\u30c8    \u3000:  443\n\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u30d7\u30ed\u30c8\u30b3\u30eb      :  TCP\n\u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b5\u30fc\u306e\u30dd\u30fc\u30c8      :  443\n\n\u30fb\u30b5\u30d6\u30cd\u30c3\u30c8\u306e\u9078\u629e: 192.168.0.0/24\n\n\u30b9\u30c6\u30c3\u30d72: \u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u30b0\u30eb\u30fc\u30d7\u306e\u5272\u308a\u5f53\u3066\n\u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u30b0\u30eb\u30fc\u30d7(sg_test\u3068\u3067\u3082)\n\u9001\u4fe1\u5143: 0.0.0.0/0 \u30dd\u30fc\u30c8\u7bc4\u56f2: 443\n\u3092\u5272\u308a\u5f53\u3066\u308b\n\n\u30b9\u30c6\u30c3\u30d73: \u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u8a2d\u5b9a\u306e\u69cb\u6210\nTCP -> TCP\u306a\u306e\u3067\u8a2d\u5b9a\u9805\u76ee\u306a\u3057\u3002\u6b21\u3078\n\n\u30b9\u30c6\u30c3\u30d74: \u30d8\u30eb\u30b9\u30c1\u30a7\u30c3\u30af\u306e\u8a2d\u5b9a\nELB\u304b\u3089\u5c4a\u304f\u3068\u3053\u308d\u3092Ping\u5bfe\u8c61\u3068\u3057\u3066\u8a2d\u5b9a\n\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u3001\u30d8\u30eb\u30b9\u30c1\u30a7\u30c3\u30af\u9593\u9694\u306a\u3069\u8a2d\u5b9a(\u3053\u306e\u8fba\u306f\u81ea\u660e\u306a\u306e\u3067\u6bb5\u3005\u96d1\u306b\u306a\u3063\u3066\u304d\u305f...)\n\n\u30b9\u30c6\u30c3\u30d75: EC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u8ffd\u52a0\n\u632f\u308a\u5206\u3051\u5bfe\u8c61\u306eEC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u8ffd\u52a0\u3059\u308b(\u4ee5\u4e0b\u7565)\n\n\n\n\u78ba\u8a8d\n\u4e0a\u8a18\u306e\u3088\u3046\u306a\u611f\u3058\u3067\u8a2d\u5b9a\u3092\u3057\u3066\nhttps://site-a.example.com/\nhttps://site-b.example.jp/\n\u306b\u30a2\u30af\u30bb\u30b9\u3057\u3001SSL\u63a5\u7d9a\u53ef\u80fd\u306a\u3053\u3068\u3092\u78ba\u8a8d\u3059\u308b\u3002\n### \u3053\u306e\u8a18\u4e8b\u306e\u5185\u5bb9\n\nELB(SSL Termination\u3057\u306a\u3044) -> \u8907\u6570\u306e\u540d\u524d\u30d9\u30fc\u30b9VirtualHost(SSL)\u306e\u632f\u308a\u5206\u3051\u8a2d\u5b9a\u3067\u3061\u3087\u3063\u3068\u30cf\u30de\u3063\u305f\u306e\u3067\u3001\u8abf\u3079\u3066\u8a66\u3057\u3066\u3046\u307e\u304f\u884c\u3063\u305f\u7d50\u679c\u3092\u30e1\u30e2\u3002\n\n### \u74b0\u5883\n\nVPC: 192.168.0.0/16\nPublic Subnet: 192.168.0.0/24  (\u3053\u3063\u3061\u306bELB)\nPrivate Subnet: 192.168.1.0/24 (\u3053\u3063\u3061\u306bEC2)\n\nApache: httpd-2.4.18\n\n### \u3084\u308a\u305f\u3044\u3053\u3068  \n\n- ELB (SSL Termination\u3057\u306a\u3044) + EC2 (Apache + mod_ssl)\n- \u540d\u524d\u30d9\u30fc\u30b9VirtualHost\u3067\u8907\u6570\u306e\u30b5\u30a4\u30c8\u3092\u30db\u30b9\u30c8\u3059\u308b \n\n### httpd.conf\u306e\u8a2d\u5b9a(\u5fc5\u8981\u306a\u3068\u3053\u308d\u306e\u307f)\n\n```apache:httpd.conf\n\nListen 192.168.1.10:443\n\n# \u30c0\u30df\u30fc\u7528 (site-a\u3068site-b\u306b\u8a72\u5f53\u3057\u306a\u3044\u3082\u306e\u306f\u3059\u3079\u3066403\u6271\u3044\u306b\u3059\u308b)\n<VirtualHost 192.168.1.10:443>\n\n    ServerName            dummy\n    ServerAdmin           postmaster@example.com\n    DocumentRoot          \"/usr/local/httpd2/htdocs\"\n    DirectoryIndex        index.html\n\n    SSLEngine On\n    SSLCertificateFile    \"/usr/local/httpd2/ssl/server.crt\"\n    SSLCertificateKeyFile \"/usr/local/httpd2/ssl/server.key\"\n\n    <Directory \"/usr/local/httpd2/htdocs\">\n        Require all denied\n    </Directory>\n\n</VirtualHost>\n\n# site-a\u7528\u306eVirtualHost\n<VirtualHost 192.168.1.10:443>\n\n    ServerName            site-a.example.com\n    ServerAdmin           postmaster@example.com\n    DocumentRoot          \"/var/www/site-a\"\n    DirectoryIndex        index.html\n\n    SSLEngine On\n    SSLCertificateFile    \"/usr/local/httpd2/ssl/site-a.crt\"\n    SSLCertificateKeyFile \"/usr/local/httpd2/ssl/site-a.key\"\n\n    <Directory \"/var/www/site-a\">\n        Require all granted\n    </Directory>\n\n</VirtualHost>\n\n# site-b\u7528\u306eVirtualHost\n<VirtualHost 192.168.1.10:443>\n\n    ServerName            site-b.example.jp\n    ServerAdmin           postmaster@example.jp\n    DocumentRoot          \"/var/www/site-b\"\n    DirectoryIndex        index.html\n\n    SSLEngine On\n    SSLCertificateFile    \"/usr/local/httpd2/ssl/site-b.crt\"\n    SSLCertificateKeyFile \"/usr/local/httpd2/ssl/site-b.key\"\n\n    <Directory \"/var/www/site-b\">\n        Require all granted\n    </Directory>\n\n</VirtualHost>\n```\n\n### ELB\u306e\u8a2d\u5b9a\n\u30ea\u30b9\u30ca\u30fc\u306e\u8a2d\u5b9a\u3067\u3001\u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b5\u30fc/\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3068\u3082\u306b\u30d7\u30ed\u30c8\u30b3\u30eb\u3092TCP:443\u306b\u8a2d\u5b9a\u3059\u308b\u3002\n\u3053\u3046\u3059\u308b\u3053\u3068\u3067\u3001ELB\u304cL4\u30ec\u30d9\u30eb\u306e\u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b5\u30fc\u3068\u3057\u3066\u632f\u308b\u821e\u3046(\u5358\u7d14\u306b\u88cf\u5074\u306eEC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306b\u632f\u308a\u5206\u3051\u3089\u308c\u308b)\u3002\n\u3053\u306e\u969b\u3001ELB\u306f\u5f53\u7136HTTP\u30d8\u30c3\u30c0\u3092\u8997\u304b\u306a\u3044\u306e\u3067\u3001X-Forwarded-For\u306a\u3069\u306e\u60c5\u5831\u3092\u5229\u7528\u3059\u308b\u3053\u3068\u306f\u3067\u304d\u306a\u304f\u306a\u308b\u3002\n\u3064\u307e\u308a\u672c\u6765\u306e\u63a5\u7d9a\u5143\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u3092\u7279\u5b9a\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u306a\u304f\u306a\u308b(Apache\u306e\u30ed\u30b0\u306b\u306fELB\u306e\u30d7\u30e9\u30a4\u30d9\u30fc\u30c8IP\u30a2\u30c9\u30ec\u30b9\u304c\u63a5\u7d9a\u5143\u3068\u3057\u3066\u8a18\u9332\u3055\u308c\u308b)\u3002\n\u305d\u306e\u4ee3\u308f\u308aELB\u3067\u306fX-Forwarded-For\u306e\u4ee3\u7528\u3068\u3057\u3066Proxy Protocol\u3092\u30b5\u30dd\u30fc\u30c8\u3059\u308b\u3088\u3046\u8a2d\u5b9a\u304c\u53ef\u80fd\u3067\u3042\u308b\u3002\nProxy Protocol\u306fL4\u30ec\u30d9\u30eb\u3067\u52d5\u4f5c\u3059\u308b\u30d7\u30ed\u30c8\u30b3\u30eb\u3067\u3001\u8ee2\u9001\u3092\u53d7\u3051\u305fWeb\u30b5\u30fc\u30d0\u306f\u3053\u3061\u3089\u306e\u60c5\u5831\u3092\u53c2\u7167\u3059\u308b\u3053\u3068\u3067\u3001\n\u63a5\u7d9a\u5143\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u3092\u7279\u5b9a\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u308b(Apache\u306f\u6a19\u6e96\u3067\u30b5\u30dd\u30fc\u30c8\u3057\u3066\u306a\u3044\u307f\u305f\u3044\uff1f)\u3002\n\n\n```\n\u30b9\u30c6\u30c3\u30d71: \u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b5\u30fc\u306e\u5b9a\u7fa9\n\n\u30fb\u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b5\u30fc\u3092\u914d\u7f6e\u3059\u308b\u5834\u6240: 192.168.0.0/16\n\n\u30fb\u30ea\u30b9\u30ca\u30fc\u306e\u8a2d\u5b9a\n\n\u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b5\u30fc\u306e\u30d7\u30ed\u30c8\u30b3\u30eb  :  TCP\n\u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b5\u30fc\u306e\u30dd\u30fc\u30c8    \u3000:  443\n\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u30d7\u30ed\u30c8\u30b3\u30eb      :  TCP\n\u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b5\u30fc\u306e\u30dd\u30fc\u30c8      :  443\n\n\u30fb\u30b5\u30d6\u30cd\u30c3\u30c8\u306e\u9078\u629e: 192.168.0.0/24\n\n\u30b9\u30c6\u30c3\u30d72: \u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u30b0\u30eb\u30fc\u30d7\u306e\u5272\u308a\u5f53\u3066\n\u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u30b0\u30eb\u30fc\u30d7(sg_test\u3068\u3067\u3082)\n\u9001\u4fe1\u5143: 0.0.0.0/0 \u30dd\u30fc\u30c8\u7bc4\u56f2: 443\n\u3092\u5272\u308a\u5f53\u3066\u308b\n\n\u30b9\u30c6\u30c3\u30d73: \u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u8a2d\u5b9a\u306e\u69cb\u6210\nTCP -> TCP\u306a\u306e\u3067\u8a2d\u5b9a\u9805\u76ee\u306a\u3057\u3002\u6b21\u3078\n\n\u30b9\u30c6\u30c3\u30d74: \u30d8\u30eb\u30b9\u30c1\u30a7\u30c3\u30af\u306e\u8a2d\u5b9a\nELB\u304b\u3089\u5c4a\u304f\u3068\u3053\u308d\u3092Ping\u5bfe\u8c61\u3068\u3057\u3066\u8a2d\u5b9a\n\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u3001\u30d8\u30eb\u30b9\u30c1\u30a7\u30c3\u30af\u9593\u9694\u306a\u3069\u8a2d\u5b9a(\u3053\u306e\u8fba\u306f\u81ea\u660e\u306a\u306e\u3067\u6bb5\u3005\u96d1\u306b\u306a\u3063\u3066\u304d\u305f...)\n\n\u30b9\u30c6\u30c3\u30d75: EC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u8ffd\u52a0\n\u632f\u308a\u5206\u3051\u5bfe\u8c61\u306eEC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u8ffd\u52a0\u3059\u308b(\u4ee5\u4e0b\u7565)\n\n```\n\n### \u78ba\u8a8d\n\n\u4e0a\u8a18\u306e\u3088\u3046\u306a\u611f\u3058\u3067\u8a2d\u5b9a\u3092\u3057\u3066\nhttps://site-a.example.com/\nhttps://site-b.example.jp/\n\u306b\u30a2\u30af\u30bb\u30b9\u3057\u3001SSL\u63a5\u7d9a\u53ef\u80fd\u306a\u3053\u3068\u3092\u78ba\u8a8d\u3059\u308b\u3002\n\n", "tags": ["elb", "EC2", "Apache"]}