{"context": " More than 1 year has passed since last update.\u524d\u56de\u306f\u3053\u3061\u3089 - \u6b21\u56de\u306f\u3053\u3061\u3089\n\n\n\u3053\u308c\u306f\u306a\u306b\n\u300cOpenStack\u30af\u30e9\u30a6\u30c9\u30a4\u30f3\u30c6\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3 \u30aa\u30fc\u30d7\u30f3\u30bd\u30fc\u30b9\u30af\u30e9\u30a6\u30c9\u306b\u3088\u308b\u30b5\u30fc\u30d3\u30b9\u69cb\u7bc9\u5165\u9580\u300d\u306e\u5b9f\u7fd2\u3092SoftLayer\u306e\u7121\u6599\u30d9\u30a2\u30e1\u30bf\u30eb\u3067\u884c\u3046\u8a18\u9332\u3067\u3042\u308b\u3002\n\n\n\u7b2c14\u7ae0 Docker\u306e\u57fa\u672c\u6a5f\u80fd\u3092\u5229\u7528\u74b0\u5883\u306e\u6e96\u5099\n\u5f53\u7ae0\u3067\u306fOpenstack\u306e\u4eee\u60f3\u30de\u30b7\u30f3\u4e0a\u3067Docker\u3092\u5229\u7528\u3059\u308b\u3002\n\u5f53\u7ae0\u306e\u652f\u63f4\u30d5\u30a1\u30a4\u30eb\u306f\u3053\u3061\u3089\u3002\n\n14.1 Docker\u3092\u5229\u7528\u3059\u308b\u30e1\u30ea\u30c3\u30c8\nDocker\u306e\u7c21\u5358\u306a\u8aac\u660e\u3002\n\n14.2 Docker\u306e\u57fa\u672c\u6a5f\u80fd\u3068\u5229\u7528\u74b0\u5883\u306e\u6e96\u5099\n\n14.2.1 Docker\u306e\u57fa\u672c\u6a5f\u80fd\nDocker\u306e\u30b3\u30f3\u30c6\u30ca\u9593\u300d\u306f\u4eee\u60f3\u30d6\u30ea\u30c3\u30b8\u3067\u76f4\u63a5\u901a\u4fe1\u3067\u304d\u308b\u304c\u3001\u5916\u90e8\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u3068\u306fNAPT\u304b\u30dd\u30fc\u30c8\u30d5\u30a9\u30ef\u30fc\u30c7\u30a3\u30f3\u30b0\u3067\u901a\u4fe1\u3059\u308b\u3002\n\n14.2.2 Docker\u306e\u52d5\u4f5c\u78ba\u8a8d\u3068\u4eee\u60f3\u30de\u30b7\u30f3\u30a4\u30e1\u30fc\u30b8\u306e\u4f5c\u6210\n\u65b0\u3057\u3044\u4eee\u60f3\u30de\u30b7\u30f3\u306bDocker\u3092\u5c0e\u5165\u3057\u3066\u52d5\u4f5c\u78ba\u8a8d\u3092\u884c\u3046\u3002\nDocker\u3092\u81ea\u52d5\u5c0e\u5165\u30fb\u81ea\u52d5\u8d77\u52d5\u3059\u308b\u3088\u3046\u306buserdata_docker.txt \u3092\u4f5c\u308b\u3002\n[root@step-server ~]# cat userdata_docker.txt\n#!/bin/bash\nyum -y install epel-release\nyum -y install docker-io\nchkconfig docker on\nservice docker start\n\n[root@step-server ~]# export MY_WORK_NET=`neutron net-show work-net | get_uuid`\n\n[root@step-server ~]# echo $MY_WORK_NET\n1fcd9570-8fb4-4929-99c8-94b410b8e1d6\n\n\n[root@step-server ~]# nova boot \\\n>    --flavor standard.xsmall \\\n>    --image centos-base \\\n>    --key-name key-for-internal \\\n>    --user-data userdata_docker.txt \\\n>    --security-groups sg-all-from-console \\\n>    --availability-zone az1 \\\n>    --nic net-id=${MY_WORK_NET} \\\n>    docker\n+--------------------------------------+----------------------------------------------------+\n| Property                             | Value                                              |\n+--------------------------------------+----------------------------------------------------+\n| OS-DCF:diskConfig                    | MANUAL                                             |\n| OS-EXT-AZ:availability_zone          | nova                                               |\n| OS-EXT-STS:power_state               | 0                                                  |\n| OS-EXT-STS:task_state                | scheduling                                         |\n| OS-EXT-STS:vm_state                  | building                                           |\n| OS-SRV-USG:launched_at               | -                                                  |\n| OS-SRV-USG:terminated_at             | -                                                  |\n| accessIPv4                           |                                                    |\n| accessIPv6                           |                                                    |\n| adminPass                            | W38PFTCABU4g                                       |\n| config_drive                         |                                                    |\n| created                              | 2015-04-02T06:46:50Z                               |\n| flavor                               | standard.xsmall (100)                              |\n| hostId                               |                                                    |\n| id                                   | 92ab2230-e91a-4180-881e-4ecc981722cb               |\n| image                                | centos-base (098f948e-e80b-4b1a-8a46-f8d2dd57e149) |\n| key_name                             | key-for-internal                                   |\n| metadata                             | {}                                                 |\n| name                                 | docker                                             |\n| os-extended-volumes:volumes_attached | []                                                 |\n| progress                             | 0                                                  |\n| security_groups                      | sg-all-from-console                                |\n| status                               | BUILD                                              |\n| tenant_id                            | 106e169743964758bcad1f06cc69c472                   |\n| updated                              | 2015-04-02T06:46:50Z                               |\n| user_id                              | 98dd78b670884b64b879568215777c53                   |\n+--------------------------------------+----------------------------------------------------+\n\n\u30ed\u30b0\u30a4\u30f3\u30d7\u30ed\u30f3\u30d7\u30c8\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@step-server ~]# nova console-log --length 5 docker\n\nCentOS release 6.6 (Final)\nKernel 2.6.32-504.el6.x86_64 on an x86_64\n\ndocker login:\n\n\u30ed\u30b0\u30a4\u30f3\u3059\u308b\u3002\n[root@step-server ~]# nova list --field name,networks\n+--------------------------------------+-------------+------------------------------------+\n| ID                                   | Name        | Networks                           |\n+--------------------------------------+-------------+------------------------------------+\n| 92ab2230-e91a-4180-881e-4ecc981722cb | docker      | work-net=10.0.0.3                  |\n| 65d3400d-3467-4563-9ff5-9c0e30c7157e | step-server | work-net=10.0.0.1, 192.168.100.131 |\n+--------------------------------------+-------------+------------------------------------+\n\n[root@step-server ~]# ssh -i key-for-internal.pem root@10.0.0.3\nThe authenticity of host '10.0.0.3 (10.0.0.3)' can't be established.\nRSA key fingerprint is b6:d3:04:8a:d3:65:13:00:23:43:b3:04:66:6e:aa:41.\nAre you sure you want to continue connecting (yes/no)? yes\nWarning: Permanently added '10.0.0.3' (RSA) to the list of known hosts.\n\ndocker info \u3067\u60c5\u5831\u304c\u8868\u793a\u3055\u308c\u308b\u3002\n[root@docker ~]# docker info\nContainers: 0\nImages: 0\nStorage Driver: devicemapper\n Pool Name: docker-252:1-402386-pool\n Pool Blocksize: 65.54 kB\n Data file: /var/lib/docker/devicemapper/devicemapper/data\n Metadata file: /var/lib/docker/devicemapper/devicemapper/metadata\n Data Space Used: 305.7 MB\n Data Space Total: 107.4 GB\n Metadata Space Used: 729.1 kB\n Metadata Space Total: 2.147 GB\n Library Version: 1.02.89-RHEL6 (2014-09-01)\nExecution Driver: native-0.2\nKernel Version: 2.6.32-504.el6.x86_64\nOperating System: <unknown>\nCPUs: 1\nTotal Memory: 996.4 MiB\nName: docker\nID: PL75:6U5C:V2II:6OH6:NBOC:PJ56:GMU5:AUQQ:ABBM:RL64:PIWE:S2GX\n\ncentos\u306e\u30b3\u30f3\u30c6\u30ca\u30a4\u30e1\u30fc\u30b8\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u78ba\u8a8d\u3059\u308b\u3002\n[root@docker ~]# docker pull -a centos\ncentos:5: The image you are pulling has been verified\n511136ea3c5a: Pull complete\n511136ea3c5a: Already exists\n511136ea3c5a: Already exists\n511136ea3c5a: Already exists\n511136ea3c5a: Already exists\n511136ea3c5a: Already exists\n511136ea3c5a: Already exists\n511136ea3c5a: Already exists\n511136ea3c5a: Already exists\n511136ea3c5a: Already exists\n511136ea3c5a: Already exists\n511136ea3c5a: Already exists\n511136ea3c5a: Already exists\n511136ea3c5a: Already exists\n511136ea3c5a: Already exists\n5b12ef8fd570: Already exists\nb58de3b24eb7: Pull complete\n5c5681003a50: Already exists\n2b8d6139a545: Already exists\ncentos:centos6: The image you are pulling has been verified\n5c5681003a50: Already exists\n2b8d6139a545: Already exists\nad3d57cba393: Already exists\nb58de3b24eb7: Already exists\ncentos:latest: The image you are pulling has been verified\nStatus: Downloaded newer image for centos\n\n[root@docker ~]# docker images\nREPOSITORY          TAG                 IMAGE ID            CREATED             VIRTUAL SIZE\ncentos              7.1.1503            b58de3b24eb7        39 hours ago        226 MB\ncentos              centos7.1.1503      b58de3b24eb7        39 hours ago        226 MB\ncentos              7                   2b8d6139a545        39 hours ago        226 MB\ncentos              centos7             2b8d6139a545        39 hours ago        226 MB\ncentos              latest              2b8d6139a545        39 hours ago        226 MB\ncentos              5.11                2e4a66ce2189        4 weeks ago         466.9 MB\ncentos              centos5.11          2e4a66ce2189        4 weeks ago         466.9 MB\ncentos              6.6                 0bc55ae673f7        4 weeks ago         215.8 MB\ncentos              centos6.6           0bc55ae673f7        4 weeks ago         215.8 MB\ncentos              7.0.1406            99d42dc65aa6        4 weeks ago         224.1 MB\ncentos              centos7.0.1406      99d42dc65aa6        4 weeks ago         224.1 MB\ncentos              5                   861c710fef70        4 weeks ago         466.9 MB\ncentos              centos5             861c710fef70        4 weeks ago         466.9 MB\ncentos              6                   f6808a3e4d9e        4 weeks ago         215.7 MB\ncentos              centos6             f6808a3e4d9e        4 weeks ago         215.7 MB\n\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\n[root@docker ~]# docker run -itd --name web -p 80:80 centos:centos6 /bin/bash\n03e99f8ba9a689254ba327a3d4308c829c00b2792bc44157544ee1bd548d61c4\n\n\u30b3\u30f3\u30c6\u30ca\u306b\u63a5\u7d9a\u3057\u5185\u90e8\u30d7\u30ed\u30bb\u30b9\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@docker ~]# docker attach web\n\n[root@03e99f8ba9a6 /]# ps -ef\nUID        PID  PPID  C STIME TTY          TIME CMD\nroot         1     0  0 07:10 ?        00:00:00 /bin/bash\nroot        15     1  0 07:16 ?        00:00:00 ps -ef\n\n[root@03e99f8ba9a6 /]# df\nFilesystem           1K-blocks    Used Available Use% Mounted on\nrootfs                10190136  245324   9420524   3% /\n/dev/mapper/docker-252:1-402386-03e99f8ba9a689254ba327a3d4308c829c00b2792bc44157544ee1bd548d61c4\n                      10190136  245324   9420524   3% /\ntmpfs                   510172       0    510172   0% /dev\nshm                      65536       0     65536   0% /dev/shm\n/dev/vda1             10189112 3487636   6177240  37% /etc/resolv.conf\n/dev/vda1             10189112 3487636   6177240  37% /etc/hostname\n/dev/vda1             10189112 3487636   6177240  37% /etc/hosts\ntmpfs                   510172       0    510172   0% /proc/kcore\n\n172.17.0.2 \u304c\u5272\u308a\u5f53\u3066\u3089\u308c\u3066\u3044\u308b\u3002\n[root@03e99f8ba9a6 /]# ifconfig\neth0      Link encap:Ethernet  HWaddr 02:42:AC:11:00:02\n          inet addr:172.17.0.2  Bcast:0.0.0.0  Mask:255.255.0.0\n          inet6 addr: fe80::42:acff:fe11:2/64 Scope:Link\n          UP BROADCAST RUNNING  MTU:1400  Metric:1\n          RX packets:6 errors:0 dropped:0 overruns:0 frame:0\n          TX packets:6 errors:0 dropped:0 overruns:0 carrier:0\n          collisions:0 txqueuelen:0\n          RX bytes:468 (468.0 b)  TX bytes:468 (468.0 b)\n\nlo        Link encap:Local Loopback\n          inet addr:127.0.0.1  Mask:255.0.0.0\n          inet6 addr: ::1/128 Scope:Host\n          UP LOOPBACK RUNNING  MTU:65536  Metric:1\n          RX packets:0 errors:0 dropped:0 overruns:0 frame:0\n          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0\n          collisions:0 txqueuelen:0\n          RX bytes:0 (0.0 b)  TX bytes:0 (0.0 b)\n\nhttpd\u3092\u5c0e\u5165\u3057\u8d77\u52d5\u3059\u308b\u3002\n[root@03e99f8ba9a6 /]# yum -y install httpd\n\uff5e\uff5e\uff5e\uff5e\uff5e\uff5e\uff5e\n\nInstalled:\n  httpd.x86_64 0:2.2.15-39.el6.centos\n\nDependency Installed:\n  apr.x86_64 0:1.3.9-5.el6_2                      apr-util.x86_64 0:1.3.9-3.el6_0.1       apr-util-ldap.x86_64 0:1.3.9-3.el6_0.1\n  httpd-tools.x86_64 0:2.2.15-39.el6.centos       mailcap.noarch 0:2.1.31-2.el6           redhat-logos.noarch 0:60.0.14-12.el6.centos\n\nComplete!\n\n[root@03e99f8ba9a6 /]# service httpd start\nStarting httpd: httpd: Could not reliably determine the server's fully qualified domain name, using 172.17.0.2 for ServerName\n                                                           [  OK  ]\n\n[Ctrl]+[P][Q]\u3067\u30b3\u30f3\u30c6\u30ca\u304b\u3089\u629c\u3051\u308b\u3002\u30b3\u30f3\u30c6\u30ca\u306f\u751f\u304d\u3066\u3044\u308b\u3002\n[root@03e99f8ba9a6 /]# [root@docker ~]# docker ps\nCONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS                NAMES\n03e99f8ba9a6        centos:6            \"/bin/bash\"         13 minutes ago      Up 13 minutes       0.0.0.0:80->80/tcp   web        \n\n\u8e0f\u307f\u53f0\u30b5\u30fc\u30d0\u30fc\u304b\u3089Docker\u4eee\u60f3\u30de\u30b7\u30f3\u306e\u30dd\u30fc\u30c880\u306b\u3064\u306a\u3050\u3068\u3001\u30b3\u30f3\u30c6\u30ca\u306e\u30dd\u30fc\u30c880\u306b\u8ee2\u9001\u3055\u308c\u30ec\u30b9\u30dd\u30f3\u30b9\u304c\u8fd4\u3063\u3066\u304f\u308b\u3002\n[root@step-server ~]# curl http://10.0.0.3\n<!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.1//EN\" \"http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd\">\n        <head>\n                <title>Apache HTTP Server Test Page powered by CentOS</title>\n\uff5e\uff5e\uff5e\uff5e\uff5e\uff5e\n\n\u30b3\u30f3\u30c6\u30ca\u3092\u7834\u68c4\u3059\u308b\u3002docker stop\u3067\u30b9\u30c6\u30fc\u30bf\u30b9\u304cExited\u306b\u306a\u308b\u3002\n[root@docker ~]# docker stop web\nweb\n\n[root@docker ~]# docker ps -a\nCONTAINER ID        IMAGE               COMMAND             CREATED             STATUS                      PORTS               NAMES\n03e99f8ba9a6        centos:6            \"/bin/bash\"         18 minutes ago      Exited (-1) 5 seconds ago                       web         \n\n\u8e0f\u307f\u53f0\u30b5\u30fc\u30d0\u30fc\u304b\u3089\u3064\u306a\u304c\u3089\u306a\u3044\u3002\n[root@step-server ~]# curl http://10.0.0.3\ncurl: (7) couldn't connect to host\n\ndocker rm \u3059\u308b\u3068\u300c-a\u300d\u4ed8\u304d\u306e docker ps \u3067\u3082\u8868\u793a\u3055\u308c\u306a\u304f\u306a\u308b\u3002\n[root@docker ~]# docker rm web\nweb\n\n[root@docker ~]# docker ps -a\nCONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES\n[root@docker ~]#\n\n\u3053\u306e\u4eee\u60f3\u30de\u30b7\u30f3\u3067docker\u304c\u52d5\u4f5c\u3059\u308b\u3053\u3068\u304c\u78ba\u8a8d\u3067\u304d\u305f\u306e\u3067\u4eee\u60f3\u30de\u30b7\u30f3\u3092\u505c\u6b62\u3057\u30a4\u30e1\u30fc\u30b8\u306b\u3059\u308b\u3002\n[root@docker ~]# exit\nlogout\nConnection to 10.0.0.3 closed.\n\n[root@step-server ~]# nova stop docker\n\n[root@step-server ~]# nova list --field name,status\n+--------------------------------------+-------------+---------+\n| ID                                   | Name        | Status  |\n+--------------------------------------+-------------+---------+\n| 92ab2230-e91a-4180-881e-4ecc981722cb | docker      | SHUTOFF |\n| 65d3400d-3467-4563-9ff5-9c0e30c7157e | step-server | ACTIVE  |\n+--------------------------------------+-------------+---------+\n\n[root@step-server ~]# nova image-create docker docker-base\n\n\u30a4\u30e1\u30fc\u30b8\u304c active \u306b\u306a\u308b\u306e\u3092\u5f85\u3064\u3002\n[root@step-server ~]# glance image-list --name docker-base\n+--------------------------------------+-------------+-------------+------------------+------+--------+\n| ID                                   | Name        | Disk Format | Container Format | Size | Status |\n+--------------------------------------+-------------+-------------+------------------+------+--------+\n| 935f9ed9-589f-4ad6-af06-b137576cdbea | docker-base | qcow2       | bare             |      | queued |\n+--------------------------------------+-------------+-------------+------------------+------+--------+\n\n[root@step-server ~]# glance image-list --name docker-base\n+--------------------------------------+-------------+-------------+------------------+------------+--------+\n| ID                                   | Name        | Disk Format | Container Format | Size       | Status |\n+--------------------------------------+-------------+-------------+------------------+------------+--------+\n| 935f9ed9-589f-4ad6-af06-b137576cdbea | docker-base | qcow2       | bare             | 5267718144 | saving |\n+--------------------------------------+-------------+-------------+------------------+------------+--------+\n\n[root@step-server ~]# glance image-list --name docker-base\n+--------------------------------------+-------------+-------------+------------------+------------+--------+\n| ID                                   | Name        | Disk Format | Container Format | Size       | Status |\n+--------------------------------------+-------------+-------------+------------------+------------+--------+\n| 935f9ed9-589f-4ad6-af06-b137576cdbea | docker-base | qcow2       | bare             | 5267718144 | active |\n+--------------------------------------+-------------+-------------+------------------+------------+--------+\n\n\u4eee\u60f3\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u8d77\u52d5\u3057\u3066\u304a\u304f\u3002\n[root@step-server ~]# nova start docker\n\n\n14.3 Dockerfile\u306b\u3088\u308b\u30b3\u30f3\u30c6\u30ca\u30a4\u30e1\u30fc\u30b8\u306e\u4f5c\u6210\n\u4f5c\u6210\u3057\u305f\u30a4\u30e1\u30fc\u30b8\u3092Docker Hub\u306b\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u3059\u308b\u30b9\u30c6\u30c3\u30d7\u304c\u3042\u308b\u306e\u3067\u3001Signup\u304b\u3089Docker Hub\u306e\u30e6\u30fc\u30b6\u30fc\u3092\u4f5c\u6210\u3057\u305f\u3002\n\n\u767b\u9332\u3057\u305f\u30e1\u30fc\u30eb\u30a2\u30c9\u30ec\u30b9\u306b\u30a2\u30ab\u30a6\u30f3\u30c8\u3092Activate\u306b\u3059\u308b\u30e1\u30fc\u30eb\u304c\u5c4a\u304f\u306e\u3067\u3001\u30af\u30ea\u30c3\u30af\u3059\u308b\u3002\n\n\u652f\u63f4\u30d5\u30a1\u30a4\u30eb\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3059\u308b\u3002\n[root@docker ~]# git clone https://github.com/josug-book1-materials/dockerfiles\nInitialized empty Git repository in /root/dockerfiles/.git/\nremote: Counting objects: 56, done.\nremote: Total 56 (delta 0), reused 0 (delta 0), pack-reused 56\nUnpacking objects: 100% (56/56), done.\n[root@docker ~]# cd dockerfiles/\n\n\n\n\n\u30b5\u30fc\u30d0\u30fc\nDockerfile\n\u8d77\u52d5\u30b9\u30af\u30ea\u30d7\u30c8\n\n\n\n\ndbs\nbuild_dbs/Dockerfile\nbuild_dbs/init.sh\n\n\napp\nbuild_app/Dockerfile\nbuild_app/init.sh\n\n\nweb\nbuild_web/Dockerfile\nbuild_dbs/init.sh\n\n\n\ndbs\u306b\u5bfe\u3057\u3066 docker build \u3092\u5b9f\u884c\u3059\u308b\u3002build_dbs/Dockerfile\u306b\u66f8\u304b\u308c\u3066\u3044\u308b\u5185\u5bb9\u304c Step X \u3067\u8868\u793a\u3055\u308c\u5b9f\u884c\u3055\u308c\u308b\u306e\u304c\u308f\u304b\u308b\u3002\n\u300cusername\u300d\u306e\u90e8\u5206\u306f\u5b9f\u969b\u306b\u306fDocker Hub\u306e\u30e6\u30fc\u30b6\u30fc\u540d\u3092\u6307\u5b9a\u3057\u3066\u3044\u308b\u3002\n[root@docker dockerfiles]# docker build -t username/dbs:ver1.0 build_dbs\nSending build context to Docker daemon 4.608 kB\nSending build context to Docker daemon\nStep 0 : FROM centos:centos6\n ---> f6808a3e4d9e\nStep 1 : MAINTAINER Etsuji Nakai\n ---> Running in d5d4df23af00\n ---> e944583839df\nRemoving intermediate container d5d4df23af00\nStep 2 : RUN yum -y install mysql-server\n ---> Running in a14937215402\nLoaded plugins: fastestmirror\nSetting up Install Process\n\uff5e\uff5e\uff5e\uff5e\uff5e\uff5e\uff5e\nComplete!\n ---> 328b42d182fc\nRemoving intermediate container a14937215402\nStep 3 : ADD my.cnf /etc/my.cnf\n ---> 8be8aa27f4b3\nRemoving intermediate container 3eefe8fab63d\nStep 4 : RUN service mysqld start;     mysql -u root -e \"create database sample_bbs default character set utf8;\";     mysql -u root -e \"grant all on sample_bbs.* to user@'%' identified by 'password'; flush privileges;\";     mysql -u root -e \"grant all on sample_bbs.* to user@localhost identified by 'password'; flush privileges;\"\n ---> Running in 36125891bff5\nInitializing MySQL database:  Installing MySQL system tables...\nOK\nFilling help tables...\nOK\n\uff5e\uff5e\uff5e\uff5e\uff5e\uff5e\uff5e\nStarting mysqld:  [  OK  ]\n ---> d6af82db821c\nRemoving intermediate container 36125891bff5\nStep 5 : ADD init.sh /usr/local/bin/init.sh\n ---> ab33a22ce681\nRemoving intermediate container 56801c0ebcff\nStep 6 : RUN chmod u+x /usr/local/bin/init.sh\n ---> Running in ae7bfadec8ff\n ---> 66eb3612585e\nRemoving intermediate container ae7bfadec8ff\nStep 7 : CMD /usr/local/bin/init.sh\n ---> Running in ffb0ef20fe3d\n ---> 44dc5392ebbc\nRemoving intermediate container ffb0ef20fe3d\nStep 8 : EXPOSE 3306\n ---> Running in 3ac90488ecde\n ---> f234940036ed\nRemoving intermediate container 3ac90488ecde\nSuccessfully built f234940036ed\n\n\n\u540c\u69d8\u306b app \u3092 build\u3002\n[root@docker dockerfiles]# docker build -t username/app:ver1.0 build_app\nSending build context to Docker daemon 3.072 kB\nSending build context to Docker daemon\nStep 0 : FROM centos:centos6\n ---> f6808a3e4d9e\nStep 1 : MAINTAINER Etsuji Nakai\n ---> Using cache\n ---> e944583839df\nStep 2 : RUN yum -y install epel-release;     yum -y install git gcc python-devel python-crypto python-pip mysql-devel\n ---> Running in c0c8e52cd014\nLoaded plugins: fastestmirror\nSetting up Install Process\n\uff5e\uff5e\uff5e\uff5e\uff5e\uff5e\uff5e\nComplete!\n ---> d4a4acc42571\nRemoving intermediate container c0c8e52cd014\nStep 3 : RUN cd /root;     git clone https://github.com/josug-book1-materials/sample-app.git;     cd /root/sample-app;     git checkout v1.0;     pip install -r server-setup/requirements.txt\n ---> Running in b21f473f4da1\nInitialized empty Git repository in /root/sample-app/.git/\n\uff5e\uff5e\uff5e\uff5e\uff5e\uff5e\uff5e\nCleaning up...\n ---> 1b3c00142686\nRemoving intermediate container b21f473f4da1\nStep 4 : ADD init.sh /usr/local/bin/init.sh\n ---> e7d433a88a32\nRemoving intermediate container 9edef6867f61\nStep 5 : RUN chmod u+x /usr/local/bin/init.sh\n ---> Running in b993abbdc151\n ---> 8f9cb916d82e\nRemoving intermediate container b993abbdc151\nStep 6 : CMD /usr/local/bin/init.sh\n ---> Running in 63c5065877da\n ---> 6f57c99b22dd\nRemoving intermediate container 63c5065877da\nStep 7 : EXPOSE 5555\n ---> Running in 79143c83bdf4\n ---> 4141334940f2\nRemoving intermediate container 79143c83bdf4\nSuccessfully built 4141334940f2\n\n\nweb \u3082 build\u3002\n[root@docker dockerfiles]# docker build -t username/web:ver1.0 build_web\nSending build context to Docker daemon 3.072 kB\nSending build context to Docker daemon\nStep 0 : FROM centos:centos6\n ---> f6808a3e4d9e\nStep 1 : MAINTAINER Etsuji Nakai\n ---> Using cache\n ---> e944583839df\nStep 2 : RUN yum -y install epel-release;     yum -y install git gcc python-devel python-crypto python-pip mysql-devel\n ---> Using cache\n ---> d4a4acc42571\nStep 3 : RUN cd /root;     git clone https://github.com/josug-book1-materials/sample-app.git;     cd /root/sample-app;     git checkout v1.0;     pip install -r server-setup/requirements.txt\n ---> Using cache\n ---> 1b3c00142686\nStep 4 : ADD init.sh /usr/local/bin/init.sh\n ---> 95fd813470a1\nRemoving intermediate container 1adf19a14965\nStep 5 : RUN chmod u+x /usr/local/bin/init.sh\n ---> Running in 9d6902397878\n ---> 8d8935b41f7e\nRemoving intermediate container 9d6902397878\nStep 6 : CMD /usr/local/bin/init.sh\n ---> Running in 3e1cd1bcde75\n ---> 78c0486fffa7\nRemoving intermediate container 3e1cd1bcde75\nSuccessfully built 78c0486fffa7\n\n\u30a4\u30e1\u30fc\u30b8\u304c\u30ed\u30fc\u30ab\u30eb\u306b\u767b\u9332\u3055\u308c\u3066\u3044\u308b\u3002\n[root@docker dockerfiles]# docker images\nREPOSITORY          TAG                 IMAGE ID            CREATED             VIRTUAL SIZE\nusername/web       ver1.0              78c0486fffa7        50 seconds ago      565.5 MB\nusername/app       ver1.0              4141334940f2        4 minutes ago       565.5 MB\nusername/dbs       ver1.0              f234940036ed        9 minutes ago       351.8 MB\ncentos              centos7.1.1503      b58de3b24eb7        45 hours ago        226 MB\n\uff5e\uff5e\uff5e\uff5e\uff5e\uff5e\uff5e\n\n\u30a4\u30e1\u30fc\u30b8\u3092 docker \u306b push\u3002\u30e6\u30fc\u30b6\u30fc\u540d\u3001\u30d1\u30b9\u30ef\u30fc\u30c9\u3001\u30e1\u30fc\u30eb\u30a2\u30c9\u30ec\u30b9\u3092\u5165\u529b\u3059\u308b\u3002\n[root@docker ~]# docker push username/dbs\nThe push refers to a repository [username/dbs] (len: 1)\nSending image list\n\nPlease login prior to push:\nUsername: username\nPassword:\nEmail: username@example.com\nLogin Succeeded\nThe push refers to a repository [username/dbs] (len: 1)\nSending image list\nPushing repository username/dbs (1 tags)\n511136ea3c5a: Image already pushed, skipping\n5b12ef8fd570: Image already pushed, skipping\nf6808a3e4d9e: Image already pushed, skipping\ne944583839df: Image successfully pushed\n328b42d182fc: Image successfully pushed\n8be8aa27f4b3: Image successfully pushed\nd6af82db821c: Image successfully pushed\nab33a22ce681: Image successfully pushed\n66eb3612585e: Image successfully pushed\n44dc5392ebbc: Image successfully pushed\nf234940036ed: Image successfully pushed\nPushing tag for rev [f234940036ed] on {https://cdn-registry-1.docker.io/v1/repositories/username/dbs/tags/ver1.0}\n\napp \u3068 web \u306e\u30a4\u30e1\u30fc\u30b8\u3082 push \u3059\u308b\u30022\u56de\u76ee\u4ee5\u964d\u306f\u8a8d\u8a3c\u306f\u6c42\u3081\u3089\u308c\u306a\u3044\u3002\n[root@docker ~]# docker push username/app\nThe push refers to a repository [username/app] (len: 1)\nSending image list\nPushing repository username/app (1 tags)\n511136ea3c5a: Image already pushed, skipping\n\uff5e\uff5e\uff5e\uff5e\uff5e\uff5e\uff5e\n4141334940f2: Image successfully pushed\nPushing tag for rev [4141334940f2] on {https://cdn-registry-1.docker.io/v1/repositories/orz4qiita/app/tags/ver1.0}\n\n[root@docker ~]# docker push username/web\nThe push refers to a repository [username/web] (len: 1)\nSending image list\nPushing repository username/web (1 tags)\n511136ea3c5a: Image already pushed, skipping\n\uff5e\uff5e\uff5e\uff5e\uff5e\uff5e\uff5e\n78c0486fffa7: Image successfully pushed\nPushing tag for rev [78c0486fffa7] on {https://cdn-registry-1.docker.io/v1/repositories/orz4qiita/web/tags/ver1.0}\n\n\n14.4 \u30b3\u30f3\u30c6\u30ca\u30fc\u30a4\u30e1\u30fc\u30b8\u306b\u3088\u308b\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u914d\u5e03\n\n14.4.1 \u5358\u4e00\u306e\u4eee\u60f3\u30de\u30b7\u30f3\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3078\u306e\u5c55\u958b\n\u3053\u3053\u3067\u306f\u3001\u5358\u4e00\u306e\u4eee\u60f3\u30de\u30b7\u30f3\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092nova boot\u3057\u3001\u305d\u306euserdata\u3067dbs/app/web\u306e\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\u5b9f\u884c\u3059\u308b\u5185\u5bb9\u306f\u3053\u3061\u3089\u3002\n\u4e0b\u8a18\u306e\u3088\u3046\u306buserdatra_docker-all.txt \u3092\u4f5c\u308b\u3002\u30a4\u30e1\u30fc\u30b8\u540d\u306b\u81ea\u5206\u306e\u30e6\u30fc\u30b6\u30fc\u540d\u304b\u3001\u8457\u8005\u304c\u7528\u610f\u3057\u305f\u3082\u306e\u3092\u4f7f\u3046\u5834\u5408\u306f\u300cenalai00\u300d\u3092\u6307\u5b9a\u3059\u308b\u3002\napp\u3067\u300c--link dbs:db\u300d\u3092\u6307\u5b9a\u3057\u3066\u3044\u308b\u3002build_dbs/Dockerfile\u3067\u300cEXPOSE 3306\u300d\u3067\u30dd\u30fc\u30c83306\u3092\u516c\u958b\u3059\u308b\u3053\u3068\u3092\u5ba3\u8a00\u3057\u3066\u3044\u308b\u306e\u3067\u3001app\u30b3\u30f3\u30c6\u30ca\u3067\u306fdbs\u30b3\u30f3\u30c6\u30ca\u306e\u30a2\u30c9\u30ec\u30b9\u304c\u74b0\u5883\u5909\u6570 DB_PORT_3306_TCP_ADDR\u3067\u53d6\u5f97\u3067\u304d\u3001\u5185\u90e8\u5229\u7528\u3067\u304d\u308b\u3002\nweb\u306e\u300c--link app:rest\u300d\u3082\u540c\u69d8\u3002build_app/Dockerfile\u3067\u300cEXPOSE 5555\u300d\u3092\u6307\u5b9a\u3057\u3066\u3044\u308b\u306e\u3067\u3001app\u30b3\u30f3\u30c6\u30ca\u306e\u30a2\u30c9\u30ec\u30b9\u304c\u74b0\u5883\u5909\u6570 REST_PORT_5555_TCP_ADDR\u3067\u3001web\u30b3\u30f3\u30c6\u30ca\u5074\u3067\u53d6\u5f97\u3067\u304d\u308b\u3002\n[root@step-server ~]# vi userdata_docker-all.txt\n[root@step-server ~]# cat userdata_docker-all.txt\n#!/bin/bash\nservice docker start\ndocker run -itd --name dbs username/dbs:ver1.0\ndocker run -itd --name app --link dbs:db username/app:ver1.0\ndocker run -itd --name web --link app:rest -p 80:80 username/web:ver1.0\n\nnova boot \u3067 docker-all \u3092\u8d77\u52d5\u3059\u308b\u3002\u3053\u308c\u307e\u3067\u9055\u3044\u3001docker \u3092\u5c0e\u5165\u6e08\u307f\u306e docker-base \u30a4\u30e1\u30fc\u30b8\u304b\u3089\u8d77\u52d5\u3057\u3066\u3044\u308b\u3053\u3068\u306b\u6ce8\u610f\u3002nova boot \u3067\u72b6\u614b\u304cACTIVE\u306b\u306a\u308b\u306e\u306b\u591a\u5c11\u3001\u6642\u9593\u304c\u304b\u304b\u3063\u305f\u3002\n[root@step-server ~]# function get_uuid () { cat - | grep \" id \" | awk '{print $4}'; }\n[root@step-server ~]# export MY_DMZ_NET=`neutron net-show dmz-net | get_uuid`\n[root@step-server ~]# echo $MY_DMZ_NET\n35e4baac-7230-4232-9644-856874dfe8af\n\n[root@step-server ~]# nova boot \\\n>     --flavor standard.xsmall \\\n>     --image docker-base \\\n>     --key-name key-for-internal \\\n>     --user-data userdata_docker-all.txt \\\n>     --security-groups sg-all-from-console,sg-web-from-internet \\\n>     --availability-zone az1 \\\n>     --nic net-id=${MY_DMZ_NET} \\\n>     docker-all\n+--------------------------------------+----------------------------------------------------+\n| Property                             | Value                                              |\n+--------------------------------------+----------------------------------------------------+\n| OS-DCF:diskConfig                    | MANUAL                                             |\n| OS-EXT-AZ:availability_zone          | nova                                               |\n| OS-EXT-STS:power_state               | 0                                                  |\n| OS-EXT-STS:task_state                | scheduling                                         |\n| OS-EXT-STS:vm_state                  | building                                           |\n| OS-SRV-USG:launched_at               | -                                                  |\n| OS-SRV-USG:terminated_at             | -                                                  |\n| accessIPv4                           |                                                    |\n| accessIPv6                           |                                                    |\n| adminPass                            | 6eo48P3XkedW                                       |\n| config_drive                         |                                                    |\n| created                              | 2015-04-03T04:17:12Z                               |\n| flavor                               | standard.xsmall (100)                              |\n| hostId                               |                                                    |\n| id                                   | fab76afe-43b3-483e-a29f-faa5631248cf               |\n| image                                | docker-base (935f9ed9-589f-4ad6-af06-b137576cdbea) |\n| key_name                             | key-for-internal                                   |\n| metadata                             | {}                                                 |\n| name                                 | docker-all                                         |\n| os-extended-volumes:volumes_attached | []                                                 |\n| progress                             | 0                                                  |\n| security_groups                      | sg-all-from-console, sg-web-from-internet          |\n| status                               | BUILD                                              |\n| tenant_id                            | 106e169743964758bcad1f06cc69c472                   |\n| updated                              | 2015-04-03T04:17:13Z                               |\n| user_id                              | 98dd78b670884b64b879568215777c53                   |\n+--------------------------------------+----------------------------------------------------+\n\nssh\u3067\u30ed\u30b0\u30a4\u30f3\u3057 docker ps \u3067\u72b6\u614b\u3092\u78ba\u8a8d\u3059\u308b\u30023\u3064\u306e\u30b3\u30f3\u30c6\u30ca\u304c\u8868\u793a\u3055\u308c\u308b\u307e\u3067\u3001\u591a\u5c11\u6642\u9593\u304c\u304b\u304b\u308b\u3002\n[root@step-server ~]# nova list --field name,networks\n+--------------------------------------+-------------+------------------------------------+\n| ID                                   | Name        | Networks                           |\n+--------------------------------------+-------------+------------------------------------+\n| 92ab2230-e91a-4180-881e-4ecc981722cb | docker      | work-net=10.0.0.3                  |\n| fab76afe-43b3-483e-a29f-faa5631248cf | docker-all  | dmz-net=192.168.0.31               |\n| 65d3400d-3467-4563-9ff5-9c0e30c7157e | step-server | work-net=10.0.0.1, 192.168.100.131 |\n+--------------------------------------+-------------+------------------------------------+\n\n[root@step-server ~]# ssh -i key-for-internal.pem root@192.168.0.31\n\n[root@docker-all ~]# docker ps\nCONTAINER ID        IMAGE                  COMMAND                CREATED             STATUS              PORTS               NAMES\nfc05cf947d96        username/dbs:ver1.0    \"/usr/local/bin/init   56 seconds ago      Up 54 seconds       3306/tcp            dbs\n\n[root@docker-all ~]# docker ps\nCONTAINER ID        IMAGE                  COMMAND                CREATED             STATUS              PORTS                NAMES\nc322096e629f        username/web:ver1.0    \"/usr/local/bin/init   28 seconds ago      Up 26 seconds       0.0.0.0:80->80/tcp   web\nf2006d629a91        username/app:ver1.0    \"/usr/local/bin/init   47 seconds ago      Up 45 seconds       5555/tcp             app\nfc05cf947d96        username/dbs:ver1.0    \"/usr/local/bin/init   3 minutes ago       Up 3 minutes        3306/tcp             dbs\n\nweb\u306b\u632f\u3089\u308c\u305fIP\u3092\u78ba\u8a8d\u3059\u308b\u3002\u65b9\u6cd5\u306f\u3053\u3061\u3089\u3092\u53c2\u8003\u306b\u3057\u305f\u3002\n[root@docker-all ~]# sudo docker inspect --format '{{ .NetworkSettings.IPAddress }}' web\n172.17.0.4\n\n\u4eee\u60f3\u30de\u30b7\u30f3\u4e0a\u304b\u3089w3m\u3067web\u30b3\u30f3\u30c6\u30ca\u306b\u63a5\u7d9a\u3059\u308b\u3002\n[root@docker-all ~]# w3m http://172.17.0.4/\n\nweb\u2192app\u2192dbs\u306e\u9023\u643a\u304c\u3068\u308c\u3001\u30a2\u30d7\u30ea\u304c\u6b63\u5e38\u306b\u52d5\u4f5c\u3057\u3066\u3044\u308b\u3053\u3068\u304c\u78ba\u8a8d\u3067\u304d\u308b\u3002\n\n\n14.4.2 \u8907\u6570\u306e\u4eee\u60f3\u30de\u30b7\u30f3\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3078\u306e\u5c55\u958b\n3\u3064\u306e\u4eee\u60f3\u30de\u30b7\u30f3\u3092\u8d77\u52d5\u3057\u3001\u304a\u306e\u304a\u306e\u306b\u30b3\u30f3\u30c6\u30ca\u3092\u3072\u3068\u3064\u305a\u3064\u52d5\u304b\u3059\u3002\n14.4.1 \u3067\u306f\u3001\u5358\u4e00\u30db\u30b9\u30c8\u5185\u306e\u30b3\u30f3\u30c6\u30ca\u3067\u3042\u3063\u305f\u305f\u3081\u300c--link dbs:db\u300d\u300c--link app:rest\u300d\u3067IP\u30a2\u30c9\u30ec\u30b9\u3092\u6e21\u3059\u3053\u3068\u304c\u3067\u304d\u305f\u3002\u4eca\u56de\u306f\u5225\u306e\u30db\u30b9\u30c8\u306e\u305f\u3081\u3001\u305d\u308c\u304c\u3067\u304d\u306a\u3044\u3002\u300c-e\u300d\u3067\u74b0\u5883\u5909\u6570\u306b\u30bb\u30c3\u30c8\u3059\u308b\u3002\u300c-p\u300d\u3067\u5229\u7528\u3059\u308b\u30dd\u30fc\u30c8\u3092\u4eee\u60f3\u30db\u30b9\u30c8\u306b\u30de\u30c3\u30d4\u30f3\u30b0\u3059\u308b\u306e\u3067\u3001\u4eee\u60f3\u30db\u30b9\u30c8\u306eIP\u3092\u30bb\u30c3\u30c8\u3059\u308c\u3070\u3088\u3044\u3002\n\u30b3\u30f3\u30c6\u30ca\u306e\u8d77\u52d5\u30b3\u30de\u30f3\u30c9\u306f\u4e0b\u8a18\u306e\u3068\u304a\u308a\u3002\ndocker run -itd --name dbs -p 3306:3306 username/dbs:ver1.0\n\ndocker run -itd --name app -e DB_PORT_3306_TCP_ADDR=<dbs IP> -p 5555:5555 username/app:ver1.0\n\ndocker run -itd --name web -e REST_PORT_5555_TCP_ADDR=<app IP> -p 80:80 username/web:ver1.0\n\n\u9023\u643a\u306b\u306fansible\u3092\u4f7f\u3046\u306e\u3067\u8e0f\u307f\u53f0\u30b5\u30fc\u30d0\u30fc\u3067\u30e6\u30fc\u30b6\u30fcansible\u306b\u5207\u308a\u66ff\u3048\u308b\u3002\n[root@step-server ~]# su - ansible\n[ansible@step-server ~]$ cd $HOME && source venv/bin/activate\n(venv)[ansible@step-server ~]$ source openrc\n\n\u300c11.5.2 \u4eee\u60f3\u30de\u30b7\u30f3\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u69cb\u7bc9\u306e\u81ea\u52d5\u5316\u300d\u3067\u5229\u7528\u3057\u305f\u30d7\u30ec\u30a4\u30d6\u30c3\u30af\u306e\u300cimage_name: \"centos-base\"\u300d\u3092\u300cimage_name: \"docker-base\"\u300d\u306b\u5909\u66f4\u3057\u305f\u30d7\u30ec\u30a4\u30d6\u30c3\u30af\u3092\u7528\u610f\u3059\u308b\u3002\n(venv)[ansible@step-server ~]$ sed 's/centos-base/docker-base/' chapter11/playbooks/book1/create_sample_vm.yml > create_docker_vm.yml\n\nweb\u7528VM\u3092\u8d77\u52d5\u3002\n(venv)[ansible@step-server ~]$ ansible-playbook -i ansible_hosts -e target=web create_docker_vm.yml\n\nPLAY [localhost] **************************************************************\n\nGATHERING FACTS ***************************************************************\nok: [localhost]\n\nTASK: [ansible_python_interpreter setup] **************************************\nok: [localhost]\n\nTASK: [get uuid for generate hostname] ****************************************\nchanged: [localhost]\n\nTASK: [create {{ target }}-server on nova-compute with floating_ip] ***********\nchanged: [localhost]\n\nTASK: [create {{ target }}-server on nova-compute without floating_ip] ********\nskipping: [localhost]\n\nPLAY RECAP ********************************************************************\nlocalhost                  : ok=4    changed=2    unreachable=0    failed=0\n\napp\u7528VM\u3092\u8d77\u52d5\u3002\n(venv)[ansible@step-server ~]$ ansible-playbook -i ansible_hosts -e target=app create_docker_vm.yml\n\nPLAY [localhost] **************************************************************\n\nGATHERING FACTS ***************************************************************\nok: [localhost]\n\nTASK: [ansible_python_interpreter setup] **************************************\nok: [localhost]\n\nTASK: [get uuid for generate hostname] ****************************************\nchanged: [localhost]\n\nTASK: [create {{ target }}-server on nova-compute with floating_ip] ***********\nskipping: [localhost]\n\nTASK: [create {{ target }}-server on nova-compute without floating_ip] ********\nchanged: [localhost]\n\nPLAY RECAP ********************************************************************\nlocalhost                  : ok=4    changed=2    unreachable=0    failed=0\n\ndbs\u7528VM\u3092\u8d77\u52d5\u3002\n(venv)[ansible@step-server ~]$ ansible-playbook -i ansible_hosts -e target=dbs create_docker_vm.yml\n\nPLAY [localhost] **************************************************************\n\nGATHERING FACTS ***************************************************************\nok: [localhost]\n\nTASK: [ansible_python_interpreter setup] **************************************\nok: [localhost]\n\nTASK: [get uuid for generate hostname] ****************************************\nchanged: [localhost]\n\nTASK: [create {{ target }}-server on nova-compute with floating_ip] ***********\nskipping: [localhost]\n\nTASK: [create {{ target }}-server on nova-compute without floating_ip] ********\nchanged: [localhost]\n\nPLAY RECAP ********************************************************************\nlocalhost                  : ok=4    changed=2    unreachable=0    failed=0\n\n\u8d77\u52d5\u3057\u3066\u304d\u305f\u3002\n(venv)[ansible@step-server ~]$ nova list --field name,networks --name ^...-\n+--------------------------------------+------------------------------------------+------------------------------------------------------------------+\n| ID                                   | Name                                     | Networks                                                         |\n+--------------------------------------+------------------------------------------+------------------------------------------------------------------+\n| 636a0bf9-a41b-4b1a-b86f-e4999bdce7fa | app-fbb61303-b0b2-43f4-893f-10c3ea79792d | dmz-net=192.168.0.33; app-net=172.16.10.20; dbs-net=172.16.20.12 |\n| 73efdad1-c0ad-440b-bfab-4a3d164fd895 | dbs-4a0d5541-3350-485e-9cbf-820d1770401a | dmz-net=192.168.0.34; dbs-net=172.16.20.13                       |\n| 0bfde50e-d4ce-4a49-9c16-e1319082aeb1 | web-b79aedaf-244f-4fd2-9b88-7487da35b4b8 | dmz-net=192.168.0.32, 192.168.100.136; app-net=172.16.10.19      |\n+--------------------------------------+------------------------------------------+------------------------------------------------------------------+\n\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u30d7\u30ec\u30a4\u30d6\u30c3\u30af\u306f\u3053\u3061\u3089\nDocker Hub\u306e\u30e6\u30fc\u30b6\u30fc\u540d\u3092\u5f15\u6570\u306b\u6307\u5b9a\u3057\u3066\u5b9f\u884c\u3059\u308b\u3002\u307e\u305a\u306fdbs\u3002\n(venv)[ansible@step-server ~]$ ansible-playbook -i sample_app_inventory.py -e target=dbs -e docker_user=username -u root do_docker_run.yml\n\nPLAY [dbs] ********************************************************************\n\nGATHERING FACTS ***************************************************************\nThe authenticity of host '192.168.0.35 (192.168.0.35)' can't be established.\nRSA key fingerprint is b6:d3:04:8a:d3:65:13:00:23:43:b3:04:66:6e:aa:41.\nAre you sure you want to continue connecting (yes/no)? yes\nok: [192.168.0.35]\n\nTASK: [install required packages] *********************************************\nok: [192.168.0.35] => (item=python-pip)\n\nTASK: [install python client for docker] **************************************\nchanged: [192.168.0.35] => (item=docker-py)\n\nTASK: [docker run \"{{ target }}\"] *********************************************\nchanged: [192.168.0.35]\n\nPLAY RECAP ********************************************************************\n192.168.0.35               : ok=4    changed=2    unreachable=0    failed=0\n\n\u6b21\u306bapp\u3002\n(venv)[ansible@step-server ~]$ ansible-playbook -i sample_app_inventory.py -e target=app -e docker_user=username -u root do_docker_run.yml\n\nPLAY [app] ********************************************************************\n\nGATHERING FACTS ***************************************************************\nThe authenticity of host '192.168.0.33 (192.168.0.33)' can't be established.\nRSA key fingerprint is b6:d3:04:8a:d3:65:13:00:23:43:b3:04:66:6e:aa:41.\nAre you sure you want to continue connecting (yes/no)? yes\nok: [192.168.0.33]\n\nTASK: [install required packages] *********************************************\nok: [192.168.0.33] => (item=python-pip)\n\nTASK: [install python client for docker] **************************************\nchanged: [192.168.0.33] => (item=docker-py)\n\nTASK: [docker run \"{{ target }}\"] *********************************************\nchanged: [192.168.0.33]\n\nPLAY RECAP ********************************************************************\n192.168.0.33               : ok=4    changed=2    unreachable=0    failed=0\n\n\u6700\u5f8c\u306bweb\u3002\n(venv)[ansible@step-server ~]$ ansible-playbook -i sample_app_inventory.py -e target=web -e docker_user=userdata -u root do_docker_run.yml\n\nPLAY [web] ********************************************************************\n\nGATHERING FACTS ***************************************************************\nThe authenticity of host '192.168.0.32 (192.168.0.32)' can't be established.\nRSA key fingerprint is b6:d3:04:8a:d3:65:13:00:23:43:b3:04:66:6e:aa:41.\nAre you sure you want to continue connecting (yes/no)? yes\nok: [192.168.0.32]\n\nTASK: [install required packages] *********************************************\nok: [192.168.0.32] => (item=python-pip)\n\nTASK: [install python client for docker] **************************************\nchanged: [192.168.0.32] => (item=docker-py)\n\nTASK: [docker run \"{{ target }}\"] *********************************************\nchanged: [192.168.0.32]\n\nPLAY RECAP ********************************************************************\n192.168.0.32               : ok=4    changed=2    unreachable=0    failed=0\n\nDocker Hub\u3067\u30a4\u30e1\u30fc\u30b8\u3092\u78ba\u8a8d\u3059\u308b\u3068\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u6570\u304c\u30ab\u30a6\u30f3\u30c8\u30a2\u30c3\u30d7\u3059\u308b\u306e\u304c\u78ba\u8a8d\u3067\u304d\u308b\u3002dbs\u304c3\u306a\u306e\u306f\u4e00\u5ea6\u3084\u308a\u76f4\u3057\u305f\u305b\u3044\u3002\n\n\n\u7b2c14\u7ae0\u306e\u5b8c\u4e86\u3002\n\n\u524d\u56de\u306f\u3053\u3061\u3089 - \u6b21\u56de\u306f\u3053\u3061\u3089\n[\u524d\u56de\u306f\u3053\u3061\u3089](http://qiita.com/orz/items/11bcaef5faf5d8ff87f2) - [\u6b21\u56de\u306f\u3053\u3061\u3089](http://qiita.com/orz/items/f73c7f5bc98a34957a35)\n***\n#\u3053\u308c\u306f\u306a\u306b\n[\u300cOpenStack\u30af\u30e9\u30a6\u30c9\u30a4\u30f3\u30c6\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3 \u30aa\u30fc\u30d7\u30f3\u30bd\u30fc\u30b9\u30af\u30e9\u30a6\u30c9\u306b\u3088\u308b\u30b5\u30fc\u30d3\u30b9\u69cb\u7bc9\u5165\u9580\u300d](http://www.shoeisha.co.jp/book/detail/9784798139784)\u306e\u5b9f\u7fd2\u3092SoftLayer\u306e\u7121\u6599\u30d9\u30a2\u30e1\u30bf\u30eb\u3067\u884c\u3046\u8a18\u9332\u3067\u3042\u308b\u3002\n![OpenStack\u30af\u30e9\u30a6\u30c9\u30a4\u30f3\u30c6\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3 \u30aa\u30fc\u30d7\u30f3\u30bd\u30fc\u30b9\u30af\u30e9\u30a6\u30c9\u306b\u3088\u308b\u30b5\u30fc\u30d3\u30b9\u69cb\u7bc9\u5165\u9580](http://www.seshop.com/static/images/product/17681/L.png)\n\n# \u7b2c14\u7ae0 Docker\u306e\u57fa\u672c\u6a5f\u80fd\u3092\u5229\u7528\u74b0\u5883\u306e\u6e96\u5099\n\n\u5f53\u7ae0\u3067\u306fOpenstack\u306e\u4eee\u60f3\u30de\u30b7\u30f3\u4e0a\u3067Docker\u3092\u5229\u7528\u3059\u308b\u3002\n\n\u5f53\u7ae0\u306e\u652f\u63f4\u30d5\u30a1\u30a4\u30eb\u306f[\u3053\u3061\u3089](https://github.com/josug-book1-materials/dockerfiles)\u3002\n\n## 14.1 Docker\u3092\u5229\u7528\u3059\u308b\u30e1\u30ea\u30c3\u30c8\n\nDocker\u306e\u7c21\u5358\u306a\u8aac\u660e\u3002\n\n## 14.2 Docker\u306e\u57fa\u672c\u6a5f\u80fd\u3068\u5229\u7528\u74b0\u5883\u306e\u6e96\u5099\n\n## 14.2.1 Docker\u306e\u57fa\u672c\u6a5f\u80fd\n\nDocker\u306e\u30b3\u30f3\u30c6\u30ca\u9593\u300d\u306f\u4eee\u60f3\u30d6\u30ea\u30c3\u30b8\u3067\u76f4\u63a5\u901a\u4fe1\u3067\u304d\u308b\u304c\u3001\u5916\u90e8\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u3068\u306fNAPT\u304b\u30dd\u30fc\u30c8\u30d5\u30a9\u30ef\u30fc\u30c7\u30a3\u30f3\u30b0\u3067\u901a\u4fe1\u3059\u308b\u3002\n\n## 14.2.2 Docker\u306e\u52d5\u4f5c\u78ba\u8a8d\u3068\u4eee\u60f3\u30de\u30b7\u30f3\u30a4\u30e1\u30fc\u30b8\u306e\u4f5c\u6210\n\n\u65b0\u3057\u3044\u4eee\u60f3\u30de\u30b7\u30f3\u306bDocker\u3092\u5c0e\u5165\u3057\u3066\u52d5\u4f5c\u78ba\u8a8d\u3092\u884c\u3046\u3002\n\nDocker\u3092\u81ea\u52d5\u5c0e\u5165\u30fb\u81ea\u52d5\u8d77\u52d5\u3059\u308b\u3088\u3046\u306buserdata_docker.txt \u3092\u4f5c\u308b\u3002\n\n```\n[root@step-server ~]# cat userdata_docker.txt\n#!/bin/bash\nyum -y install epel-release\nyum -y install docker-io\nchkconfig docker on\nservice docker start\n```\n\n<pre>\n[root@step-server ~]# export MY_WORK_NET=`neutron net-show work-net | get_uuid`\n\n[root@step-server ~]# echo $MY_WORK_NET\n1fcd9570-8fb4-4929-99c8-94b410b8e1d6\n\n\n[root@step-server ~]# nova boot \\\n>    --flavor standard.xsmall \\\n>    --image centos-base \\\n>    --key-name key-for-internal \\\n>    --user-data userdata_docker.txt \\\n>    --security-groups sg-all-from-console \\\n>    --availability-zone az1 \\\n>    --nic net-id=${MY_WORK_NET} \\\n>    docker\n+--------------------------------------+----------------------------------------------------+\n| Property                             | Value                                              |\n+--------------------------------------+----------------------------------------------------+\n| OS-DCF:diskConfig                    | MANUAL                                             |\n| OS-EXT-AZ:availability_zone          | nova                                               |\n| OS-EXT-STS:power_state               | 0                                                  |\n| OS-EXT-STS:task_state                | scheduling                                         |\n| OS-EXT-STS:vm_state                  | building                                           |\n| OS-SRV-USG:launched_at               | -                                                  |\n| OS-SRV-USG:terminated_at             | -                                                  |\n| accessIPv4                           |                                                    |\n| accessIPv6                           |                                                    |\n| adminPass                            | W38PFTCABU4g                                       |\n| config_drive                         |                                                    |\n| created                              | 2015-04-02T06:46:50Z                               |\n| flavor                               | standard.xsmall (100)                              |\n| hostId                               |                                                    |\n| id                                   | 92ab2230-e91a-4180-881e-4ecc981722cb               |\n| image                                | centos-base (098f948e-e80b-4b1a-8a46-f8d2dd57e149) |\n| key_name                             | key-for-internal                                   |\n| metadata                             | {}                                                 |\n| name                                 | docker                                             |\n| os-extended-volumes:volumes_attached | []                                                 |\n| progress                             | 0                                                  |\n| security_groups                      | sg-all-from-console                                |\n| status                               | BUILD                                              |\n| tenant_id                            | 106e169743964758bcad1f06cc69c472                   |\n| updated                              | 2015-04-02T06:46:50Z                               |\n| user_id                              | 98dd78b670884b64b879568215777c53                   |\n+--------------------------------------+----------------------------------------------------+\n</pre>\n\n\u30ed\u30b0\u30a4\u30f3\u30d7\u30ed\u30f3\u30d7\u30c8\u3092\u78ba\u8a8d\u3059\u308b\u3002\n\n```\n[root@step-server ~]# nova console-log --length 5 docker\n\nCentOS release 6.6 (Final)\nKernel 2.6.32-504.el6.x86_64 on an x86_64\n\ndocker login:\n```\n\n\u30ed\u30b0\u30a4\u30f3\u3059\u308b\u3002\n\n<pre>\n[root@step-server ~]# nova list --field name,networks\n+--------------------------------------+-------------+------------------------------------+\n| ID                                   | Name        | Networks                           |\n+--------------------------------------+-------------+------------------------------------+\n| 92ab2230-e91a-4180-881e-4ecc981722cb | docker      | work-net=10.0.0.3                  |\n| 65d3400d-3467-4563-9ff5-9c0e30c7157e | step-server | work-net=10.0.0.1, 192.168.100.131 |\n+--------------------------------------+-------------+------------------------------------+\n\n[root@step-server ~]# ssh -i key-for-internal.pem root@10.0.0.3\nThe authenticity of host '10.0.0.3 (10.0.0.3)' can't be established.\nRSA key fingerprint is b6:d3:04:8a:d3:65:13:00:23:43:b3:04:66:6e:aa:41.\nAre you sure you want to continue connecting (yes/no)? yes\nWarning: Permanently added '10.0.0.3' (RSA) to the list of known hosts.\n</pre>\n\ndocker info \u3067\u60c5\u5831\u304c\u8868\u793a\u3055\u308c\u308b\u3002\n\n```\n[root@docker ~]# docker info\nContainers: 0\nImages: 0\nStorage Driver: devicemapper\n Pool Name: docker-252:1-402386-pool\n Pool Blocksize: 65.54 kB\n Data file: /var/lib/docker/devicemapper/devicemapper/data\n Metadata file: /var/lib/docker/devicemapper/devicemapper/metadata\n Data Space Used: 305.7 MB\n Data Space Total: 107.4 GB\n Metadata Space Used: 729.1 kB\n Metadata Space Total: 2.147 GB\n Library Version: 1.02.89-RHEL6 (2014-09-01)\nExecution Driver: native-0.2\nKernel Version: 2.6.32-504.el6.x86_64\nOperating System: <unknown>\nCPUs: 1\nTotal Memory: 996.4 MiB\nName: docker\nID: PL75:6U5C:V2II:6OH6:NBOC:PJ56:GMU5:AUQQ:ABBM:RL64:PIWE:S2GX\n```\n\ncentos\u306e\u30b3\u30f3\u30c6\u30ca\u30a4\u30e1\u30fc\u30b8\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u78ba\u8a8d\u3059\u308b\u3002\n\n```\n[root@docker ~]# docker pull -a centos\ncentos:5: The image you are pulling has been verified\n511136ea3c5a: Pull complete\n511136ea3c5a: Already exists\n511136ea3c5a: Already exists\n511136ea3c5a: Already exists\n511136ea3c5a: Already exists\n511136ea3c5a: Already exists\n511136ea3c5a: Already exists\n511136ea3c5a: Already exists\n511136ea3c5a: Already exists\n511136ea3c5a: Already exists\n511136ea3c5a: Already exists\n511136ea3c5a: Already exists\n511136ea3c5a: Already exists\n511136ea3c5a: Already exists\n511136ea3c5a: Already exists\n5b12ef8fd570: Already exists\nb58de3b24eb7: Pull complete\n5c5681003a50: Already exists\n2b8d6139a545: Already exists\ncentos:centos6: The image you are pulling has been verified\n5c5681003a50: Already exists\n2b8d6139a545: Already exists\nad3d57cba393: Already exists\nb58de3b24eb7: Already exists\ncentos:latest: The image you are pulling has been verified\nStatus: Downloaded newer image for centos\n\n[root@docker ~]# docker images\nREPOSITORY          TAG                 IMAGE ID            CREATED             VIRTUAL SIZE\ncentos              7.1.1503            b58de3b24eb7        39 hours ago        226 MB\ncentos              centos7.1.1503      b58de3b24eb7        39 hours ago        226 MB\ncentos              7                   2b8d6139a545        39 hours ago        226 MB\ncentos              centos7             2b8d6139a545        39 hours ago        226 MB\ncentos              latest              2b8d6139a545        39 hours ago        226 MB\ncentos              5.11                2e4a66ce2189        4 weeks ago         466.9 MB\ncentos              centos5.11          2e4a66ce2189        4 weeks ago         466.9 MB\ncentos              6.6                 0bc55ae673f7        4 weeks ago         215.8 MB\ncentos              centos6.6           0bc55ae673f7        4 weeks ago         215.8 MB\ncentos              7.0.1406            99d42dc65aa6        4 weeks ago         224.1 MB\ncentos              centos7.0.1406      99d42dc65aa6        4 weeks ago         224.1 MB\ncentos              5                   861c710fef70        4 weeks ago         466.9 MB\ncentos              centos5             861c710fef70        4 weeks ago         466.9 MB\ncentos              6                   f6808a3e4d9e        4 weeks ago         215.7 MB\ncentos              centos6             f6808a3e4d9e        4 weeks ago         215.7 MB\n```\n\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\n\n```\n[root@docker ~]# docker run -itd --name web -p 80:80 centos:centos6 /bin/bash\n03e99f8ba9a689254ba327a3d4308c829c00b2792bc44157544ee1bd548d61c4\n```\n\n\u30b3\u30f3\u30c6\u30ca\u306b\u63a5\u7d9a\u3057\u5185\u90e8\u30d7\u30ed\u30bb\u30b9\u3092\u78ba\u8a8d\u3059\u308b\u3002\n\n```\n[root@docker ~]# docker attach web\n\n[root@03e99f8ba9a6 /]# ps -ef\nUID        PID  PPID  C STIME TTY          TIME CMD\nroot         1     0  0 07:10 ?        00:00:00 /bin/bash\nroot        15     1  0 07:16 ?        00:00:00 ps -ef\n```\n\n```\n[root@03e99f8ba9a6 /]# df\nFilesystem           1K-blocks    Used Available Use% Mounted on\nrootfs                10190136  245324   9420524   3% /\n/dev/mapper/docker-252:1-402386-03e99f8ba9a689254ba327a3d4308c829c00b2792bc44157544ee1bd548d61c4\n                      10190136  245324   9420524   3% /\ntmpfs                   510172       0    510172   0% /dev\nshm                      65536       0     65536   0% /dev/shm\n/dev/vda1             10189112 3487636   6177240  37% /etc/resolv.conf\n/dev/vda1             10189112 3487636   6177240  37% /etc/hostname\n/dev/vda1             10189112 3487636   6177240  37% /etc/hosts\ntmpfs                   510172       0    510172   0% /proc/kcore\n```\n\n172.17.0.2 \u304c\u5272\u308a\u5f53\u3066\u3089\u308c\u3066\u3044\u308b\u3002\n\n```\n[root@03e99f8ba9a6 /]# ifconfig\neth0      Link encap:Ethernet  HWaddr 02:42:AC:11:00:02\n          inet addr:172.17.0.2  Bcast:0.0.0.0  Mask:255.255.0.0\n          inet6 addr: fe80::42:acff:fe11:2/64 Scope:Link\n          UP BROADCAST RUNNING  MTU:1400  Metric:1\n          RX packets:6 errors:0 dropped:0 overruns:0 frame:0\n          TX packets:6 errors:0 dropped:0 overruns:0 carrier:0\n          collisions:0 txqueuelen:0\n          RX bytes:468 (468.0 b)  TX bytes:468 (468.0 b)\n\nlo        Link encap:Local Loopback\n          inet addr:127.0.0.1  Mask:255.0.0.0\n          inet6 addr: ::1/128 Scope:Host\n          UP LOOPBACK RUNNING  MTU:65536  Metric:1\n          RX packets:0 errors:0 dropped:0 overruns:0 frame:0\n          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0\n          collisions:0 txqueuelen:0\n          RX bytes:0 (0.0 b)  TX bytes:0 (0.0 b)\n```\n\nhttpd\u3092\u5c0e\u5165\u3057\u8d77\u52d5\u3059\u308b\u3002\n\n```\n[root@03e99f8ba9a6 /]# yum -y install httpd\n\uff5e\uff5e\uff5e\uff5e\uff5e\uff5e\uff5e\n\nInstalled:\n  httpd.x86_64 0:2.2.15-39.el6.centos\n\nDependency Installed:\n  apr.x86_64 0:1.3.9-5.el6_2                      apr-util.x86_64 0:1.3.9-3.el6_0.1       apr-util-ldap.x86_64 0:1.3.9-3.el6_0.1\n  httpd-tools.x86_64 0:2.2.15-39.el6.centos       mailcap.noarch 0:2.1.31-2.el6           redhat-logos.noarch 0:60.0.14-12.el6.centos\n\nComplete!\n\n[root@03e99f8ba9a6 /]# service httpd start\nStarting httpd: httpd: Could not reliably determine the server's fully qualified domain name, using 172.17.0.2 for ServerName\n                                                           [  OK  ]\n```\n\n[Ctrl]+[P][Q]\u3067\u30b3\u30f3\u30c6\u30ca\u304b\u3089\u629c\u3051\u308b\u3002\u30b3\u30f3\u30c6\u30ca\u306f\u751f\u304d\u3066\u3044\u308b\u3002\n\n```\n[root@03e99f8ba9a6 /]# [root@docker ~]# docker ps\nCONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS                NAMES\n03e99f8ba9a6        centos:6            \"/bin/bash\"         13 minutes ago      Up 13 minutes       0.0.0.0:80->80/tcp   web        \n```\n\n\u8e0f\u307f\u53f0\u30b5\u30fc\u30d0\u30fc\u304b\u3089Docker\u4eee\u60f3\u30de\u30b7\u30f3\u306e\u30dd\u30fc\u30c880\u306b\u3064\u306a\u3050\u3068\u3001\u30b3\u30f3\u30c6\u30ca\u306e\u30dd\u30fc\u30c880\u306b\u8ee2\u9001\u3055\u308c\u30ec\u30b9\u30dd\u30f3\u30b9\u304c\u8fd4\u3063\u3066\u304f\u308b\u3002\n\n```\n[root@step-server ~]# curl http://10.0.0.3\n<!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.1//EN\" \"http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd\">\n        <head>\n                <title>Apache HTTP Server Test Page powered by CentOS</title>\n\uff5e\uff5e\uff5e\uff5e\uff5e\uff5e\n```\n\n\u30b3\u30f3\u30c6\u30ca\u3092\u7834\u68c4\u3059\u308b\u3002docker stop\u3067\u30b9\u30c6\u30fc\u30bf\u30b9\u304cExited\u306b\u306a\u308b\u3002\n\n```\n[root@docker ~]# docker stop web\nweb\n\n[root@docker ~]# docker ps -a\nCONTAINER ID        IMAGE               COMMAND             CREATED             STATUS                      PORTS               NAMES\n03e99f8ba9a6        centos:6            \"/bin/bash\"         18 minutes ago      Exited (-1) 5 seconds ago                       web         \n```\n\n\u8e0f\u307f\u53f0\u30b5\u30fc\u30d0\u30fc\u304b\u3089\u3064\u306a\u304c\u3089\u306a\u3044\u3002\n\n```\n[root@step-server ~]# curl http://10.0.0.3\ncurl: (7) couldn't connect to host\n```\n\ndocker rm \u3059\u308b\u3068\u300c-a\u300d\u4ed8\u304d\u306e docker ps \u3067\u3082\u8868\u793a\u3055\u308c\u306a\u304f\u306a\u308b\u3002\n\n```\n[root@docker ~]# docker rm web\nweb\n\n[root@docker ~]# docker ps -a\nCONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES\n[root@docker ~]#\n```\n\n\u3053\u306e\u4eee\u60f3\u30de\u30b7\u30f3\u3067docker\u304c\u52d5\u4f5c\u3059\u308b\u3053\u3068\u304c\u78ba\u8a8d\u3067\u304d\u305f\u306e\u3067\u4eee\u60f3\u30de\u30b7\u30f3\u3092\u505c\u6b62\u3057\u30a4\u30e1\u30fc\u30b8\u306b\u3059\u308b\u3002\n\n<pre>\n[root@docker ~]# exit\nlogout\nConnection to 10.0.0.3 closed.\n\n[root@step-server ~]# nova stop docker\n\n[root@step-server ~]# nova list --field name,status\n+--------------------------------------+-------------+---------+\n| ID                                   | Name        | Status  |\n+--------------------------------------+-------------+---------+\n| 92ab2230-e91a-4180-881e-4ecc981722cb | docker      | SHUTOFF |\n| 65d3400d-3467-4563-9ff5-9c0e30c7157e | step-server | ACTIVE  |\n+--------------------------------------+-------------+---------+\n\n[root@step-server ~]# nova image-create docker docker-base\n</pre>\n\n\u30a4\u30e1\u30fc\u30b8\u304c active \u306b\u306a\u308b\u306e\u3092\u5f85\u3064\u3002\n\n<pre>\n[root@step-server ~]# glance image-list --name docker-base\n+--------------------------------------+-------------+-------------+------------------+------+--------+\n| ID                                   | Name        | Disk Format | Container Format | Size | Status |\n+--------------------------------------+-------------+-------------+------------------+------+--------+\n| 935f9ed9-589f-4ad6-af06-b137576cdbea | docker-base | qcow2       | bare             |      | queued |\n+--------------------------------------+-------------+-------------+------------------+------+--------+\n\n[root@step-server ~]# glance image-list --name docker-base\n+--------------------------------------+-------------+-------------+------------------+------------+--------+\n| ID                                   | Name        | Disk Format | Container Format | Size       | Status |\n+--------------------------------------+-------------+-------------+------------------+------------+--------+\n| 935f9ed9-589f-4ad6-af06-b137576cdbea | docker-base | qcow2       | bare             | 5267718144 | saving |\n+--------------------------------------+-------------+-------------+------------------+------------+--------+\n\n[root@step-server ~]# glance image-list --name docker-base\n+--------------------------------------+-------------+-------------+------------------+------------+--------+\n| ID                                   | Name        | Disk Format | Container Format | Size       | Status |\n+--------------------------------------+-------------+-------------+------------------+------------+--------+\n| 935f9ed9-589f-4ad6-af06-b137576cdbea | docker-base | qcow2       | bare             | 5267718144 | active |\n+--------------------------------------+-------------+-------------+------------------+------------+--------+\n</pre>\n\n\u4eee\u60f3\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u8d77\u52d5\u3057\u3066\u304a\u304f\u3002\n\n```\n[root@step-server ~]# nova start docker\n```\n\n## 14.3 Dockerfile\u306b\u3088\u308b\u30b3\u30f3\u30c6\u30ca\u30a4\u30e1\u30fc\u30b8\u306e\u4f5c\u6210\n\n\u4f5c\u6210\u3057\u305f\u30a4\u30e1\u30fc\u30b8\u3092Docker Hub\u306b\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u3059\u308b\u30b9\u30c6\u30c3\u30d7\u304c\u3042\u308b\u306e\u3067\u3001[Signup](https://hub.docker.com/account/signup/)\u304b\u3089Docker Hub\u306e\u30e6\u30fc\u30b6\u30fc\u3092\u4f5c\u6210\u3057\u305f\u3002\n\n![Docker Hub Signup](https://qiita-image-store.s3.amazonaws.com/0/71995/4c623812-2274-3b0d-2cc7-1e6464205d91.png)\n\n\n\u767b\u9332\u3057\u305f\u30e1\u30fc\u30eb\u30a2\u30c9\u30ec\u30b9\u306b\u30a2\u30ab\u30a6\u30f3\u30c8\u3092Activate\u306b\u3059\u308b\u30e1\u30fc\u30eb\u304c\u5c4a\u304f\u306e\u3067\u3001\u30af\u30ea\u30c3\u30af\u3059\u308b\u3002\n\n![Docker Hub Activate](https://qiita-image-store.s3.amazonaws.com/0/71995/a6da0ac8-0b33-9281-e358-330891beec54.png)\n\n\n\u652f\u63f4\u30d5\u30a1\u30a4\u30eb\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3059\u308b\u3002\n\n```\n[root@docker ~]# git clone https://github.com/josug-book1-materials/dockerfiles\nInitialized empty Git repository in /root/dockerfiles/.git/\nremote: Counting objects: 56, done.\nremote: Total 56 (delta 0), reused 0 (delta 0), pack-reused 56\nUnpacking objects: 100% (56/56), done.\n[root@docker ~]# cd dockerfiles/\n```\n\n| \u30b5\u30fc\u30d0\u30fc | Dockerfile|\u8d77\u52d5\u30b9\u30af\u30ea\u30d7\u30c8 |\n|:----------:|:-----------:|:------------:|\n| dbs |[build_dbs/Dockerfile](https://github.com/josug-book1-materials/dockerfiles/blob/master/build_dbs/Dockerfile) |[build_dbs/init.sh](https://github.com/josug-book1-materials/dockerfiles/blob/master/build_dbs/init.sh)|\n| app |[build_app/Dockerfile](https://github.com/josug-book1-materials/dockerfiles/blob/master/build_app/Dockerfile) |[build_app/init.sh](https://github.com/josug-book1-materials/dockerfiles/blob/master/build_app/init.sh)|\n| web | [build_web/Dockerfile](https://github.com/josug-book1-materials/dockerfiles/blob/master/build_web/Dockerfile) |[build_dbs/init.sh](https://github.com/josug-book1-materials/dockerfiles/blob/master/build_web/init.sh)|\n\n\ndbs\u306b\u5bfe\u3057\u3066 docker build \u3092\u5b9f\u884c\u3059\u308b\u3002[build_dbs/Dockerfile](https://github.com/josug-book1-materials/dockerfiles/blob/master/build_dbs/Dockerfile)\u306b\u66f8\u304b\u308c\u3066\u3044\u308b\u5185\u5bb9\u304c Step X \u3067\u8868\u793a\u3055\u308c\u5b9f\u884c\u3055\u308c\u308b\u306e\u304c\u308f\u304b\u308b\u3002\n\u300cusername\u300d\u306e\u90e8\u5206\u306f\u5b9f\u969b\u306b\u306fDocker Hub\u306e\u30e6\u30fc\u30b6\u30fc\u540d\u3092\u6307\u5b9a\u3057\u3066\u3044\u308b\u3002\n\n```\n[root@docker dockerfiles]# docker build -t username/dbs:ver1.0 build_dbs\nSending build context to Docker daemon 4.608 kB\nSending build context to Docker daemon\nStep 0 : FROM centos:centos6\n ---> f6808a3e4d9e\nStep 1 : MAINTAINER Etsuji Nakai\n ---> Running in d5d4df23af00\n ---> e944583839df\nRemoving intermediate container d5d4df23af00\nStep 2 : RUN yum -y install mysql-server\n ---> Running in a14937215402\nLoaded plugins: fastestmirror\nSetting up Install Process\n\uff5e\uff5e\uff5e\uff5e\uff5e\uff5e\uff5e\nComplete!\n ---> 328b42d182fc\nRemoving intermediate container a14937215402\nStep 3 : ADD my.cnf /etc/my.cnf\n ---> 8be8aa27f4b3\nRemoving intermediate container 3eefe8fab63d\nStep 4 : RUN service mysqld start;     mysql -u root -e \"create database sample_bbs default character set utf8;\";     mysql -u root -e \"grant all on sample_bbs.* to user@'%' identified by 'password'; flush privileges;\";     mysql -u root -e \"grant all on sample_bbs.* to user@localhost identified by 'password'; flush privileges;\"\n ---> Running in 36125891bff5\nInitializing MySQL database:  Installing MySQL system tables...\nOK\nFilling help tables...\nOK\n\uff5e\uff5e\uff5e\uff5e\uff5e\uff5e\uff5e\nStarting mysqld:  [  OK  ]\n ---> d6af82db821c\nRemoving intermediate container 36125891bff5\nStep 5 : ADD init.sh /usr/local/bin/init.sh\n ---> ab33a22ce681\nRemoving intermediate container 56801c0ebcff\nStep 6 : RUN chmod u+x /usr/local/bin/init.sh\n ---> Running in ae7bfadec8ff\n ---> 66eb3612585e\nRemoving intermediate container ae7bfadec8ff\nStep 7 : CMD /usr/local/bin/init.sh\n ---> Running in ffb0ef20fe3d\n ---> 44dc5392ebbc\nRemoving intermediate container ffb0ef20fe3d\nStep 8 : EXPOSE 3306\n ---> Running in 3ac90488ecde\n ---> f234940036ed\nRemoving intermediate container 3ac90488ecde\nSuccessfully built f234940036ed\n\n```\n\n\u540c\u69d8\u306b app \u3092 build\u3002\n\n\n```\n[root@docker dockerfiles]# docker build -t username/app:ver1.0 build_app\nSending build context to Docker daemon 3.072 kB\nSending build context to Docker daemon\nStep 0 : FROM centos:centos6\n ---> f6808a3e4d9e\nStep 1 : MAINTAINER Etsuji Nakai\n ---> Using cache\n ---> e944583839df\nStep 2 : RUN yum -y install epel-release;     yum -y install git gcc python-devel python-crypto python-pip mysql-devel\n ---> Running in c0c8e52cd014\nLoaded plugins: fastestmirror\nSetting up Install Process\n\uff5e\uff5e\uff5e\uff5e\uff5e\uff5e\uff5e\nComplete!\n ---> d4a4acc42571\nRemoving intermediate container c0c8e52cd014\nStep 3 : RUN cd /root;     git clone https://github.com/josug-book1-materials/sample-app.git;     cd /root/sample-app;     git checkout v1.0;     pip install -r server-setup/requirements.txt\n ---> Running in b21f473f4da1\nInitialized empty Git repository in /root/sample-app/.git/\n\uff5e\uff5e\uff5e\uff5e\uff5e\uff5e\uff5e\nCleaning up...\n ---> 1b3c00142686\nRemoving intermediate container b21f473f4da1\nStep 4 : ADD init.sh /usr/local/bin/init.sh\n ---> e7d433a88a32\nRemoving intermediate container 9edef6867f61\nStep 5 : RUN chmod u+x /usr/local/bin/init.sh\n ---> Running in b993abbdc151\n ---> 8f9cb916d82e\nRemoving intermediate container b993abbdc151\nStep 6 : CMD /usr/local/bin/init.sh\n ---> Running in 63c5065877da\n ---> 6f57c99b22dd\nRemoving intermediate container 63c5065877da\nStep 7 : EXPOSE 5555\n ---> Running in 79143c83bdf4\n ---> 4141334940f2\nRemoving intermediate container 79143c83bdf4\nSuccessfully built 4141334940f2\n\n```\n\nweb \u3082 build\u3002\n\n```\n[root@docker dockerfiles]# docker build -t username/web:ver1.0 build_web\nSending build context to Docker daemon 3.072 kB\nSending build context to Docker daemon\nStep 0 : FROM centos:centos6\n ---> f6808a3e4d9e\nStep 1 : MAINTAINER Etsuji Nakai\n ---> Using cache\n ---> e944583839df\nStep 2 : RUN yum -y install epel-release;     yum -y install git gcc python-devel python-crypto python-pip mysql-devel\n ---> Using cache\n ---> d4a4acc42571\nStep 3 : RUN cd /root;     git clone https://github.com/josug-book1-materials/sample-app.git;     cd /root/sample-app;     git checkout v1.0;     pip install -r server-setup/requirements.txt\n ---> Using cache\n ---> 1b3c00142686\nStep 4 : ADD init.sh /usr/local/bin/init.sh\n ---> 95fd813470a1\nRemoving intermediate container 1adf19a14965\nStep 5 : RUN chmod u+x /usr/local/bin/init.sh\n ---> Running in 9d6902397878\n ---> 8d8935b41f7e\nRemoving intermediate container 9d6902397878\nStep 6 : CMD /usr/local/bin/init.sh\n ---> Running in 3e1cd1bcde75\n ---> 78c0486fffa7\nRemoving intermediate container 3e1cd1bcde75\nSuccessfully built 78c0486fffa7\n```\n\n\u30a4\u30e1\u30fc\u30b8\u304c\u30ed\u30fc\u30ab\u30eb\u306b\u767b\u9332\u3055\u308c\u3066\u3044\u308b\u3002\n\n```\n[root@docker dockerfiles]# docker images\nREPOSITORY          TAG                 IMAGE ID            CREATED             VIRTUAL SIZE\nusername/web       ver1.0              78c0486fffa7        50 seconds ago      565.5 MB\nusername/app       ver1.0              4141334940f2        4 minutes ago       565.5 MB\nusername/dbs       ver1.0              f234940036ed        9 minutes ago       351.8 MB\ncentos              centos7.1.1503      b58de3b24eb7        45 hours ago        226 MB\n\uff5e\uff5e\uff5e\uff5e\uff5e\uff5e\uff5e\n```\n\n\u30a4\u30e1\u30fc\u30b8\u3092 docker \u306b push\u3002\u30e6\u30fc\u30b6\u30fc\u540d\u3001\u30d1\u30b9\u30ef\u30fc\u30c9\u3001\u30e1\u30fc\u30eb\u30a2\u30c9\u30ec\u30b9\u3092\u5165\u529b\u3059\u308b\u3002\n\n```\n[root@docker ~]# docker push username/dbs\nThe push refers to a repository [username/dbs] (len: 1)\nSending image list\n\nPlease login prior to push:\nUsername: username\nPassword:\nEmail: username@example.com\nLogin Succeeded\nThe push refers to a repository [username/dbs] (len: 1)\nSending image list\nPushing repository username/dbs (1 tags)\n511136ea3c5a: Image already pushed, skipping\n5b12ef8fd570: Image already pushed, skipping\nf6808a3e4d9e: Image already pushed, skipping\ne944583839df: Image successfully pushed\n328b42d182fc: Image successfully pushed\n8be8aa27f4b3: Image successfully pushed\nd6af82db821c: Image successfully pushed\nab33a22ce681: Image successfully pushed\n66eb3612585e: Image successfully pushed\n44dc5392ebbc: Image successfully pushed\nf234940036ed: Image successfully pushed\nPushing tag for rev [f234940036ed] on {https://cdn-registry-1.docker.io/v1/repositories/username/dbs/tags/ver1.0}\n```\n\napp \u3068 web \u306e\u30a4\u30e1\u30fc\u30b8\u3082 push \u3059\u308b\u30022\u56de\u76ee\u4ee5\u964d\u306f\u8a8d\u8a3c\u306f\u6c42\u3081\u3089\u308c\u306a\u3044\u3002\n\n```\n[root@docker ~]# docker push username/app\nThe push refers to a repository [username/app] (len: 1)\nSending image list\nPushing repository username/app (1 tags)\n511136ea3c5a: Image already pushed, skipping\n\uff5e\uff5e\uff5e\uff5e\uff5e\uff5e\uff5e\n4141334940f2: Image successfully pushed\nPushing tag for rev [4141334940f2] on {https://cdn-registry-1.docker.io/v1/repositories/orz4qiita/app/tags/ver1.0}\n\n[root@docker ~]# docker push username/web\nThe push refers to a repository [username/web] (len: 1)\nSending image list\nPushing repository username/web (1 tags)\n511136ea3c5a: Image already pushed, skipping\n\uff5e\uff5e\uff5e\uff5e\uff5e\uff5e\uff5e\n78c0486fffa7: Image successfully pushed\nPushing tag for rev [78c0486fffa7] on {https://cdn-registry-1.docker.io/v1/repositories/orz4qiita/web/tags/ver1.0}\n```\n\n## 14.4 \u30b3\u30f3\u30c6\u30ca\u30fc\u30a4\u30e1\u30fc\u30b8\u306b\u3088\u308b\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u914d\u5e03\n\n### 14.4.1 \u5358\u4e00\u306e\u4eee\u60f3\u30de\u30b7\u30f3\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3078\u306e\u5c55\u958b\n\n\u3053\u3053\u3067\u306f\u3001\u5358\u4e00\u306e\u4eee\u60f3\u30de\u30b7\u30f3\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092nova boot\u3057\u3001\u305d\u306euserdata\u3067dbs/app/web\u306e\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u3002\u5b9f\u884c\u3059\u308b\u5185\u5bb9\u306f[\u3053\u3061\u3089](https://github.com/josug-book1-materials/dockerfiles#run-containers)\u3002\n\n\n\u4e0b\u8a18\u306e\u3088\u3046\u306buserdatra_docker-all.txt \u3092\u4f5c\u308b\u3002\u30a4\u30e1\u30fc\u30b8\u540d\u306b\u81ea\u5206\u306e\u30e6\u30fc\u30b6\u30fc\u540d\u304b\u3001\u8457\u8005\u304c\u7528\u610f\u3057\u305f\u3082\u306e\u3092\u4f7f\u3046\u5834\u5408\u306f\u300cenalai00\u300d\u3092\u6307\u5b9a\u3059\u308b\u3002\n\napp\u3067\u300c--link dbs:db\u300d\u3092\u6307\u5b9a\u3057\u3066\u3044\u308b\u3002[build_dbs/Dockerfile](https://github.com/josug-book1-materials/dockerfiles/blob/master/build_dbs/Dockerfile)\u3067\u300cEXPOSE 3306\u300d\u3067\u30dd\u30fc\u30c83306\u3092\u516c\u958b\u3059\u308b\u3053\u3068\u3092\u5ba3\u8a00\u3057\u3066\u3044\u308b\u306e\u3067\u3001app\u30b3\u30f3\u30c6\u30ca\u3067\u306fdbs\u30b3\u30f3\u30c6\u30ca\u306e\u30a2\u30c9\u30ec\u30b9\u304c\u74b0\u5883\u5909\u6570 DB_PORT_3306_TCP_ADDR\u3067\u53d6\u5f97\u3067\u304d\u3001\u5185\u90e8\u5229\u7528\u3067\u304d\u308b\u3002\n\nweb\u306e\u300c--link app:rest\u300d\u3082\u540c\u69d8\u3002[build_app/Dockerfile](https://github.com/josug-book1-materials/dockerfiles/blob/master/build_app/Dockerfile)\u3067\u300cEXPOSE 5555\u300d\u3092\u6307\u5b9a\u3057\u3066\u3044\u308b\u306e\u3067\u3001app\u30b3\u30f3\u30c6\u30ca\u306e\u30a2\u30c9\u30ec\u30b9\u304c\u74b0\u5883\u5909\u6570 REST_PORT_5555_TCP_ADDR\u3067\u3001web\u30b3\u30f3\u30c6\u30ca\u5074\u3067\u53d6\u5f97\u3067\u304d\u308b\u3002\n\n```\n[root@step-server ~]# vi userdata_docker-all.txt\n[root@step-server ~]# cat userdata_docker-all.txt\n#!/bin/bash\nservice docker start\ndocker run -itd --name dbs username/dbs:ver1.0\ndocker run -itd --name app --link dbs:db username/app:ver1.0\ndocker run -itd --name web --link app:rest -p 80:80 username/web:ver1.0\n```\n\nnova boot \u3067 docker-all \u3092\u8d77\u52d5\u3059\u308b\u3002\u3053\u308c\u307e\u3067\u9055\u3044\u3001docker \u3092\u5c0e\u5165\u6e08\u307f\u306e docker-base \u30a4\u30e1\u30fc\u30b8\u304b\u3089\u8d77\u52d5\u3057\u3066\u3044\u308b\u3053\u3068\u306b\u6ce8\u610f\u3002nova boot \u3067\u72b6\u614b\u304cACTIVE\u306b\u306a\u308b\u306e\u306b\u591a\u5c11\u3001\u6642\u9593\u304c\u304b\u304b\u3063\u305f\u3002\n\n<pre>\n[root@step-server ~]# function get_uuid () { cat - | grep \" id \" | awk '{print $4}'; }\n[root@step-server ~]# export MY_DMZ_NET=`neutron net-show dmz-net | get_uuid`\n[root@step-server ~]# echo $MY_DMZ_NET\n35e4baac-7230-4232-9644-856874dfe8af\n\n[root@step-server ~]# nova boot \\\n>     --flavor standard.xsmall \\\n>     --image docker-base \\\n>     --key-name key-for-internal \\\n>     --user-data userdata_docker-all.txt \\\n>     --security-groups sg-all-from-console,sg-web-from-internet \\\n>     --availability-zone az1 \\\n>     --nic net-id=${MY_DMZ_NET} \\\n>     docker-all\n+--------------------------------------+----------------------------------------------------+\n| Property                             | Value                                              |\n+--------------------------------------+----------------------------------------------------+\n| OS-DCF:diskConfig                    | MANUAL                                             |\n| OS-EXT-AZ:availability_zone          | nova                                               |\n| OS-EXT-STS:power_state               | 0                                                  |\n| OS-EXT-STS:task_state                | scheduling                                         |\n| OS-EXT-STS:vm_state                  | building                                           |\n| OS-SRV-USG:launched_at               | -                                                  |\n| OS-SRV-USG:terminated_at             | -                                                  |\n| accessIPv4                           |                                                    |\n| accessIPv6                           |                                                    |\n| adminPass                            | 6eo48P3XkedW                                       |\n| config_drive                         |                                                    |\n| created                              | 2015-04-03T04:17:12Z                               |\n| flavor                               | standard.xsmall (100)                              |\n| hostId                               |                                                    |\n| id                                   | fab76afe-43b3-483e-a29f-faa5631248cf               |\n| image                                | docker-base (935f9ed9-589f-4ad6-af06-b137576cdbea) |\n| key_name                             | key-for-internal                                   |\n| metadata                             | {}                                                 |\n| name                                 | docker-all                                         |\n| os-extended-volumes:volumes_attached | []                                                 |\n| progress                             | 0                                                  |\n| security_groups                      | sg-all-from-console, sg-web-from-internet          |\n| status                               | BUILD                                              |\n| tenant_id                            | 106e169743964758bcad1f06cc69c472                   |\n| updated                              | 2015-04-03T04:17:13Z                               |\n| user_id                              | 98dd78b670884b64b879568215777c53                   |\n+--------------------------------------+----------------------------------------------------+\n</pre>\n\nssh\u3067\u30ed\u30b0\u30a4\u30f3\u3057 docker ps \u3067\u72b6\u614b\u3092\u78ba\u8a8d\u3059\u308b\u30023\u3064\u306e\u30b3\u30f3\u30c6\u30ca\u304c\u8868\u793a\u3055\u308c\u308b\u307e\u3067\u3001\u591a\u5c11\u6642\u9593\u304c\u304b\u304b\u308b\u3002\n\n<pre>\n[root@step-server ~]# nova list --field name,networks\n+--------------------------------------+-------------+------------------------------------+\n| ID                                   | Name        | Networks                           |\n+--------------------------------------+-------------+------------------------------------+\n| 92ab2230-e91a-4180-881e-4ecc981722cb | docker      | work-net=10.0.0.3                  |\n| fab76afe-43b3-483e-a29f-faa5631248cf | docker-all  | dmz-net=192.168.0.31               |\n| 65d3400d-3467-4563-9ff5-9c0e30c7157e | step-server | work-net=10.0.0.1, 192.168.100.131 |\n+--------------------------------------+-------------+------------------------------------+\n\n[root@step-server ~]# ssh -i key-for-internal.pem root@192.168.0.31\n\n[root@docker-all ~]# docker ps\nCONTAINER ID        IMAGE                  COMMAND                CREATED             STATUS              PORTS               NAMES\nfc05cf947d96        username/dbs:ver1.0    \"/usr/local/bin/init   56 seconds ago      Up 54 seconds       3306/tcp            dbs\n\n[root@docker-all ~]# docker ps\nCONTAINER ID        IMAGE                  COMMAND                CREATED             STATUS              PORTS                NAMES\nc322096e629f        username/web:ver1.0    \"/usr/local/bin/init   28 seconds ago      Up 26 seconds       0.0.0.0:80->80/tcp   web\nf2006d629a91        username/app:ver1.0    \"/usr/local/bin/init   47 seconds ago      Up 45 seconds       5555/tcp             app\nfc05cf947d96        username/dbs:ver1.0    \"/usr/local/bin/init   3 minutes ago       Up 3 minutes        3306/tcp             dbs\n</pre>\n\nweb\u306b\u632f\u3089\u308c\u305fIP\u3092\u78ba\u8a8d\u3059\u308b\u3002\u65b9\u6cd5\u306f[\u3053\u3061\u3089](http://qiita.com/suin/items/50033dc60bfba8553395)\u3092\u53c2\u8003\u306b\u3057\u305f\u3002\n\n```\n[root@docker-all ~]# sudo docker inspect --format '{{ .NetworkSettings.IPAddress }}' web\n172.17.0.4\n```\n\n\u4eee\u60f3\u30de\u30b7\u30f3\u4e0a\u304b\u3089w3m\u3067web\u30b3\u30f3\u30c6\u30ca\u306b\u63a5\u7d9a\u3059\u308b\u3002\n\n```\n[root@docker-all ~]# w3m http://172.17.0.4/\n```\nweb\u2192app\u2192dbs\u306e\u9023\u643a\u304c\u3068\u308c\u3001\u30a2\u30d7\u30ea\u304c\u6b63\u5e38\u306b\u52d5\u4f5c\u3057\u3066\u3044\u308b\u3053\u3068\u304c\u78ba\u8a8d\u3067\u304d\u308b\u3002\n\n![\u5358\u4e00\u306e\u4eee\u60f3\u3067\u306e\u7a3c\u52d5\u78ba\u8a8d](https://qiita-image-store.s3.amazonaws.com/0/71995/856d024d-eb08-eefe-4ab0-511404d95fc2.png)\n\n\n### 14.4.2 \u8907\u6570\u306e\u4eee\u60f3\u30de\u30b7\u30f3\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3078\u306e\u5c55\u958b\n\n3\u3064\u306e\u4eee\u60f3\u30de\u30b7\u30f3\u3092\u8d77\u52d5\u3057\u3001\u304a\u306e\u304a\u306e\u306b\u30b3\u30f3\u30c6\u30ca\u3092\u3072\u3068\u3064\u305a\u3064\u52d5\u304b\u3059\u3002\n\n\n14.4.1 \u3067\u306f\u3001\u5358\u4e00\u30db\u30b9\u30c8\u5185\u306e\u30b3\u30f3\u30c6\u30ca\u3067\u3042\u3063\u305f\u305f\u3081\u300c--link dbs:db\u300d\u300c--link app:rest\u300d\u3067IP\u30a2\u30c9\u30ec\u30b9\u3092\u6e21\u3059\u3053\u3068\u304c\u3067\u304d\u305f\u3002\u4eca\u56de\u306f\u5225\u306e\u30db\u30b9\u30c8\u306e\u305f\u3081\u3001\u305d\u308c\u304c\u3067\u304d\u306a\u3044\u3002\u300c-e\u300d\u3067\u74b0\u5883\u5909\u6570\u306b\u30bb\u30c3\u30c8\u3059\u308b\u3002\u300c-p\u300d\u3067\u5229\u7528\u3059\u308b\u30dd\u30fc\u30c8\u3092\u4eee\u60f3\u30db\u30b9\u30c8\u306b\u30de\u30c3\u30d4\u30f3\u30b0\u3059\u308b\u306e\u3067\u3001\u4eee\u60f3\u30db\u30b9\u30c8\u306eIP\u3092\u30bb\u30c3\u30c8\u3059\u308c\u3070\u3088\u3044\u3002\n\n\u30b3\u30f3\u30c6\u30ca\u306e\u8d77\u52d5\u30b3\u30de\u30f3\u30c9\u306f\u4e0b\u8a18\u306e\u3068\u304a\u308a\u3002\n\n```\ndocker run -itd --name dbs -p 3306:3306 username/dbs:ver1.0\n\ndocker run -itd --name app -e DB_PORT_3306_TCP_ADDR=<dbs IP> -p 5555:5555 username/app:ver1.0\n\ndocker run -itd --name web -e REST_PORT_5555_TCP_ADDR=<app IP> -p 80:80 username/web:ver1.0\n```\n\n\u9023\u643a\u306b\u306fansible\u3092\u4f7f\u3046\u306e\u3067\u8e0f\u307f\u53f0\u30b5\u30fc\u30d0\u30fc\u3067\u30e6\u30fc\u30b6\u30fcansible\u306b\u5207\u308a\u66ff\u3048\u308b\u3002\n\n```\n[root@step-server ~]# su - ansible\n[ansible@step-server ~]$ cd $HOME && source venv/bin/activate\n(venv)[ansible@step-server ~]$ source openrc\n```\n\n[\u300c11.5.2 \u4eee\u60f3\u30de\u30b7\u30f3\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u69cb\u7bc9\u306e\u81ea\u52d5\u5316\u300d\u3067\u5229\u7528\u3057\u305f\u30d7\u30ec\u30a4\u30d6\u30c3\u30af](https://github.com/josug-book1-materials/chapter11/blob/master/playbooks/book1/create_sample_vm.yml)\u306e\u300cimage_name: \"centos-base\"\u300d\u3092\u300cimage_name: \"docker-base\"\u300d\u306b\u5909\u66f4\u3057\u305f\u30d7\u30ec\u30a4\u30d6\u30c3\u30af\u3092\u7528\u610f\u3059\u308b\u3002\n\n```\n(venv)[ansible@step-server ~]$ sed 's/centos-base/docker-base/' chapter11/playbooks/book1/create_sample_vm.yml > create_docker_vm.yml\n```\n\nweb\u7528VM\u3092\u8d77\u52d5\u3002\n\n```\n(venv)[ansible@step-server ~]$ ansible-playbook -i ansible_hosts -e target=web create_docker_vm.yml\n\nPLAY [localhost] **************************************************************\n\nGATHERING FACTS ***************************************************************\nok: [localhost]\n\nTASK: [ansible_python_interpreter setup] **************************************\nok: [localhost]\n\nTASK: [get uuid for generate hostname] ****************************************\nchanged: [localhost]\n\nTASK: [create {{ target }}-server on nova-compute with floating_ip] ***********\nchanged: [localhost]\n\nTASK: [create {{ target }}-server on nova-compute without floating_ip] ********\nskipping: [localhost]\n\nPLAY RECAP ********************************************************************\nlocalhost                  : ok=4    changed=2    unreachable=0    failed=0\n```\n\napp\u7528VM\u3092\u8d77\u52d5\u3002\n\n```\n(venv)[ansible@step-server ~]$ ansible-playbook -i ansible_hosts -e target=app create_docker_vm.yml\n\nPLAY [localhost] **************************************************************\n\nGATHERING FACTS ***************************************************************\nok: [localhost]\n\nTASK: [ansible_python_interpreter setup] **************************************\nok: [localhost]\n\nTASK: [get uuid for generate hostname] ****************************************\nchanged: [localhost]\n\nTASK: [create {{ target }}-server on nova-compute with floating_ip] ***********\nskipping: [localhost]\n\nTASK: [create {{ target }}-server on nova-compute without floating_ip] ********\nchanged: [localhost]\n\nPLAY RECAP ********************************************************************\nlocalhost                  : ok=4    changed=2    unreachable=0    failed=0\n```\n\ndbs\u7528VM\u3092\u8d77\u52d5\u3002\n\n```\n(venv)[ansible@step-server ~]$ ansible-playbook -i ansible_hosts -e target=dbs create_docker_vm.yml\n\nPLAY [localhost] **************************************************************\n\nGATHERING FACTS ***************************************************************\nok: [localhost]\n\nTASK: [ansible_python_interpreter setup] **************************************\nok: [localhost]\n\nTASK: [get uuid for generate hostname] ****************************************\nchanged: [localhost]\n\nTASK: [create {{ target }}-server on nova-compute with floating_ip] ***********\nskipping: [localhost]\n\nTASK: [create {{ target }}-server on nova-compute without floating_ip] ********\nchanged: [localhost]\n\nPLAY RECAP ********************************************************************\nlocalhost                  : ok=4    changed=2    unreachable=0    failed=0\n```\n\n\u8d77\u52d5\u3057\u3066\u304d\u305f\u3002\n\n<pre>\n(venv)[ansible@step-server ~]$ nova list --field name,networks --name ^...-\n+--------------------------------------+------------------------------------------+------------------------------------------------------------------+\n| ID                                   | Name                                     | Networks                                                         |\n+--------------------------------------+------------------------------------------+------------------------------------------------------------------+\n| 636a0bf9-a41b-4b1a-b86f-e4999bdce7fa | app-fbb61303-b0b2-43f4-893f-10c3ea79792d | dmz-net=192.168.0.33; app-net=172.16.10.20; dbs-net=172.16.20.12 |\n| 73efdad1-c0ad-440b-bfab-4a3d164fd895 | dbs-4a0d5541-3350-485e-9cbf-820d1770401a | dmz-net=192.168.0.34; dbs-net=172.16.20.13                       |\n| 0bfde50e-d4ce-4a49-9c16-e1319082aeb1 | web-b79aedaf-244f-4fd2-9b88-7487da35b4b8 | dmz-net=192.168.0.32, 192.168.100.136; app-net=172.16.10.19      |\n+--------------------------------------+------------------------------------------+------------------------------------------------------------------+\n</pre>\n\n\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3059\u308b\u30d7\u30ec\u30a4\u30d6\u30c3\u30af\u306f[\u3053\u3061\u3089](https://github.com/josug-book1-materials/dockerfiles/blob/master/playbook/do_docker_run.yml)\n\nDocker Hub\u306e\u30e6\u30fc\u30b6\u30fc\u540d\u3092\u5f15\u6570\u306b\u6307\u5b9a\u3057\u3066\u5b9f\u884c\u3059\u308b\u3002\u307e\u305a\u306fdbs\u3002\n\n```\n(venv)[ansible@step-server ~]$ ansible-playbook -i sample_app_inventory.py -e target=dbs -e docker_user=username -u root do_docker_run.yml\n\nPLAY [dbs] ********************************************************************\n\nGATHERING FACTS ***************************************************************\nThe authenticity of host '192.168.0.35 (192.168.0.35)' can't be established.\nRSA key fingerprint is b6:d3:04:8a:d3:65:13:00:23:43:b3:04:66:6e:aa:41.\nAre you sure you want to continue connecting (yes/no)? yes\nok: [192.168.0.35]\n\nTASK: [install required packages] *********************************************\nok: [192.168.0.35] => (item=python-pip)\n\nTASK: [install python client for docker] **************************************\nchanged: [192.168.0.35] => (item=docker-py)\n\nTASK: [docker run \"{{ target }}\"] *********************************************\nchanged: [192.168.0.35]\n\nPLAY RECAP ********************************************************************\n192.168.0.35               : ok=4    changed=2    unreachable=0    failed=0\n```\n\n\u6b21\u306bapp\u3002\n\n```\n(venv)[ansible@step-server ~]$ ansible-playbook -i sample_app_inventory.py -e target=app -e docker_user=username -u root do_docker_run.yml\n\nPLAY [app] ********************************************************************\n\nGATHERING FACTS ***************************************************************\nThe authenticity of host '192.168.0.33 (192.168.0.33)' can't be established.\nRSA key fingerprint is b6:d3:04:8a:d3:65:13:00:23:43:b3:04:66:6e:aa:41.\nAre you sure you want to continue connecting (yes/no)? yes\nok: [192.168.0.33]\n\nTASK: [install required packages] *********************************************\nok: [192.168.0.33] => (item=python-pip)\n\nTASK: [install python client for docker] **************************************\nchanged: [192.168.0.33] => (item=docker-py)\n\nTASK: [docker run \"{{ target }}\"] *********************************************\nchanged: [192.168.0.33]\n\nPLAY RECAP ********************************************************************\n192.168.0.33               : ok=4    changed=2    unreachable=0    failed=0\n```\n\n\u6700\u5f8c\u306bweb\u3002\n\n```\n(venv)[ansible@step-server ~]$ ansible-playbook -i sample_app_inventory.py -e target=web -e docker_user=userdata -u root do_docker_run.yml\n\nPLAY [web] ********************************************************************\n\nGATHERING FACTS ***************************************************************\nThe authenticity of host '192.168.0.32 (192.168.0.32)' can't be established.\nRSA key fingerprint is b6:d3:04:8a:d3:65:13:00:23:43:b3:04:66:6e:aa:41.\nAre you sure you want to continue connecting (yes/no)? yes\nok: [192.168.0.32]\n\nTASK: [install required packages] *********************************************\nok: [192.168.0.32] => (item=python-pip)\n\nTASK: [install python client for docker] **************************************\nchanged: [192.168.0.32] => (item=docker-py)\n\nTASK: [docker run \"{{ target }}\"] *********************************************\nchanged: [192.168.0.32]\n\nPLAY RECAP ********************************************************************\n192.168.0.32               : ok=4    changed=2    unreachable=0    failed=0\n```\n\nDocker Hub\u3067\u30a4\u30e1\u30fc\u30b8\u3092\u78ba\u8a8d\u3059\u308b\u3068\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u6570\u304c\u30ab\u30a6\u30f3\u30c8\u30a2\u30c3\u30d7\u3059\u308b\u306e\u304c\u78ba\u8a8d\u3067\u304d\u308b\u3002dbs\u304c3\u306a\u306e\u306f\u4e00\u5ea6\u3084\u308a\u76f4\u3057\u305f\u305b\u3044\u3002\n\n![Docker Hub\u3067\u306e\u30a4\u30e1\u30fc\u30b8\u78ba\u8a8d](https://qiita-image-store.s3.amazonaws.com/0/71995/1ffcc3c4-0b52-fda2-c22e-9adbbbedc8ee.png)\n\n***\n\u7b2c14\u7ae0\u306e\u5b8c\u4e86\u3002\n***\n[\u524d\u56de\u306f\u3053\u3061\u3089](http://qiita.com/orz/items/11bcaef5faf5d8ff87f2) - [\u6b21\u56de\u306f\u3053\u3061\u3089](http://qiita.com/orz/items/f73c7f5bc98a34957a35)\n", "tags": ["SoftLayer", "openstack"]}