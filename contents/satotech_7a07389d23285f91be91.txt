{"context": " More than 1 year has passed since last update.\n\n\u306f\u3058\u3081\u306b\n\u5148\u65e5 Amazon RDS \u3067 OS \u306e\u8a73\u7d30\u60c5\u5831\u3092\u53d6\u5f97\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u3063\u305f\u306e\u3067\u3001Munin \u306b\u8868\u793a\u3057\u3066\u307f\u307e\u3057\u305f\u3002\n\n\u6982\u8981\nAmazon RDS \u306b\u8ffd\u52a0\u3055\u308c\u305f\u62e1\u5f35\u30e2\u30cb\u30bf\u30ea\u30f3\u30b0\u6a5f\u80fd\u306b\u3088\u308a\u3001RDS \u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e OS \u30ea\u30bd\u30fc\u30b9\u60c5\u5831\u304c CloudWatch Logs \u306b\u51fa\u529b\u3055\u308c\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3057\u305f\u3002\n\u4eca\u56de\u306f CloudWatch Logs \u306e\u30e1\u30c8\u30ea\u30c3\u30af\u30d5\u30a3\u30eb\u30bf\u3092\u4f7f\u7528\u3057\u3066\u3001\u30ed\u30fc\u30c9\u30a2\u30d9\u30ec\u30fc\u30b8\u3092 CloudWatch \u30e1\u30c8\u30ea\u30c3\u30af\u306b\u5909\u63db\u3001Munin \u3067\u30b0\u30e9\u30d5\u5316\u3057\u3066\u307f\u307e\u3059\u3002\n\n\u3084\u3063\u3066\u307f\u305f\n\nAmazon RDS \u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u62e1\u5f35\u30e2\u30cb\u30bf\u30ea\u30f3\u30b0\u3092\u6709\u52b9\u5316\n\u62e1\u5f35\u30e2\u30cb\u30bf\u30ea\u30f3\u30b0\u306e\u6709\u52b9\u5316\u306f\u3001\u30af\u30e9\u30b9\u30e1\u30bd\u30c3\u30c9\u3055\u3093\u306e\u30d6\u30ed\u30b0\u8a18\u4e8b [\u65b0\u6a5f\u80fd]Amazon RDS\u3067OS\u306e\u8a73\u7d30\u60c5\u5831\u3092\u53d6\u5f97\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3057\u305f\uff01 \u306b\u624b\u9806\u3068\u8a2d\u5b9a\u4f8b\u304c\u3042\u308a\u307e\u3059\u3002\n\nCloudWatch Logs \u306e\u753b\u9762\u3067\u30e1\u30c8\u30ea\u30c3\u30af\u30d5\u30a3\u30eb\u30bf\u3092\u4f5c\u6210\n\nCreate Metric Filter \u30dc\u30bf\u30f3\u3092\u30af\u30ea\u30c3\u30af\u3002\n\nDefine Logs Metric Filter \u753b\u9762\u3067 Filter Pattern \u3092\u6307\u5b9a\n\n\u4eca\u56de\u306f Filter Pattern \u306b\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9 ID \u3068 LoadAverage 5\u5206\u9593\u306e\u5e73\u5747\u5024\u3092\u30c1\u30a7\u30c3\u30af\u3059\u308b\u3088\u3046\u306b\u8a2d\u5b9a\u3057\u307e\u3059\u3002\nFilter Pattern\n{ $.instanceID = \"\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9ID\" && $.loadAverageMinute.five >= 0.00 }\nTest Pattern \u30dc\u30bf\u30f3\u3067 Filter \u3092\u30c6\u30b9\u30c8\u3057\u305f\u3089\u3001Assign Metric \u30dc\u30bf\u30f3\u3092\u30af\u30ea\u30c3\u30af\u3002\n\nCreate Metric Filter and Assign a Metric \u753b\u9762\u3067 Filter Name \u3068 Metric \u306e\u8a73\u7d30\u3092\u8a2d\u5b9a\n\nMetric \u306e\u8a73\u7d30\u3092\u6b21\u306e\u3088\u3046\u306b\u8a2d\u5b9a\u3001Create Filter \u30dc\u30bf\u30f3\u3092\u30af\u30ea\u30c3\u30af\u3002\n\nMetric Namespace: RDSOSMetrics\nMetric Name: \u30a4\u30f3\u30b9\u30bf\u30f3\u30b9ID_LoadAverage\nMetric Value: $.loadAverageMinute.five\n\nMetric Filter \u304c\u4f5c\u6210\u3055\u308c\u307e\u3057\u305f\u3002\n\nMetrics \u306e Custom Metrics \u304b\u3089\u300cRDSOSMetrics\u300d\u3092\u9078\u629e\u3059\u308b\u3068\u3001\u4f5c\u6210\u3057\u305f Metric \u304c\u8868\u793a\u3055\u308c\u307e\u3059\u3002\n\n\nMunin \u306e\u30d7\u30e9\u30b0\u30a4\u30f3\u3092\u4f5c\u6210\nCloudWatch Metrics \u304b\u3089\u60c5\u5831\u3092\u53d6\u5f97\u3059\u308b\u30d7\u30e9\u30b0\u30a4\u30f3\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\nCloudWatch Metrics \u304b\u3089\u306e Munin \u30d7\u30e9\u30b0\u30a4\u30f3\u4f5c\u6210\u306f\u3001AWSCLI \u3092\u4f7f\u3063\u3066 ELB \u306e\u30c8\u30e9\u30d5\u30a3\u30c3\u30af\u3092 munin \u3067\u30b0\u30e9\u30d5\u5316 \u3092\u53c2\u8003\u306b\u3055\u305b\u3066\u3044\u305f\u3060\u304d\u307e\u3057\u305f\u3002\nMetric Filter \u3092 RDS \u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u6570\u5206\u4f5c\u6210\u3057\u3066\u3001RDS_NAMES \u306b\u8a18\u8ff0\u3059\u308b\u30681\u3064\u306e\u30b0\u30e9\u30d5\u306b\u307e\u3068\u3081\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\n/usr/share/munin/plugins/rds_load\n#!/bin/bash\n\nAWS=\"/usr/bin/aws --region ap-northeast-1\"\nNAMESPACE=\"RDSOSMetrics\"\nMETRIC=\"LoadAverage\"\nRDS_NAMES=(\"test-db1\" \"test-db2\")\n\nif [ \"$1\" = \"autoconf\" ]; then\n    echo yes\n    exit 0\nfi\n\nif [ \"$1\" = \"config\" ]; then\n    echo \"graph_title Amazon RDS ${METRIC} \"\n    echo \"graph_args --base 1000 -l 0\"\n    echo \"graph_vlabel amazon rds ${METRIC}\"\n    echo \"graph_scale no\"\n    echo \"graph_category aws-rds\"\n    echo \"graph_info amazon rds ${METRIC}\"\n\n    for RDS_NAME in \"${RDS_NAMES[@]}\"\n    do\n        echo \"${RDS_NAME}_${METRIC}.label ${RDS_NAME}_${METRIC}\"\n        echo \"${RDS_NAME}_${METRIC}.info ${RDS_NAME}_${METRIC}\"\n        echo \"${RDS_NAME}_${METRIC}.type GAUGE\"\n        echo \"${RDS_NAME}_${METRIC}.draw LINE\"\n    done\n    exit 0\nfi\n\nfor RDS_NAME in \"${RDS_NAMES[@]}\"\ndo\n    retval=`${AWS} cloudwatch get-metric-statistics \\\n        --namespace ${NAMESPACE} \\\n        --metric-name \"${RDS_NAME}_${METRIC}\" \\\n        --period 60 \\\n        --start-time $(date --iso-8601=seconds --date '24 hour ago') \\\n        --end-time   $(date --iso-8601=seconds) \\\n        --statistics \"Average\" | /usr/local/bin/jq -r '.Datapoints | sort_by(.Timestamp) | reverse | .[0]'`\n\n    count=`echo \"${retval}\" | /usr/local/bin/jq -r '.Average'`\n    echo \"${RDS_NAME}_${METRIC}.value ${count}\"\ndone\n\nexit 0\n\n\n\u30d7\u30e9\u30b0\u30a4\u30f3\u3092\u4f5c\u6210\u3057\u305f\u3089 plugins \u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306b\u30b7\u30f3\u30dc\u30ea\u30c3\u30af\u30ea\u30f3\u30af\u3092\u4f5c\u6210\u3001munin-node \u3092\u518d\u8d77\u52d5\u3057\u307e\u3059\u3002\n# cd /etc/munin/plugins\n# ln -s /usr/share/munin/plugins/rds_load rds_load\n# /etc/init.d/munin-node restart\n\n\nMunin \u3067\u8868\u793a\u78ba\u8a8d\n\n\u7121\u4e8b Munin \u3067\u30b0\u30e9\u30d5\u5316\u3067\u304d\u307e\u3057\u305f\uff01\n\n\u307e\u3068\u3081\nRDS \u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u30ed\u30fc\u30c9\u30a2\u30d9\u30ec\u30fc\u30b8\u3092 Munin \u3067\u76e3\u8996\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3057\u305f\u3002\n\u4ed6\u306e\u30e1\u30c8\u30ea\u30af\u30b9\u3082 Munin \u3067\u3069\u3093\u3069\u3093\u30b0\u30e9\u30d5\u5316\u3057\u307e\u3057\u3087\u3046\uff01\n\n\u53c2\u8003\u8cc7\u6599\n[\u65b0\u6a5f\u80fd] Amazon RDS \u3067 OS \u306e\u8a73\u7d30\u60c5\u5831\u3092\u53d6\u5f97\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3057\u305f\uff01\n\u30ed\u30b0\u30d5\u30a1\u30a4\u30eb\u306e\u30e2\u30cb\u30bf\u30ea\u30f3\u30b0\nAWS-CLI \u3092\u4f7f\u3063\u3066 ELB \u306e\u30c8\u30e9\u30d5\u30a3\u30c3\u30af\u3092 munin \u3067\u30b0\u30e9\u30d5\u5316\n# \u306f\u3058\u3081\u306b\n\u5148\u65e5 Amazon RDS \u3067 OS \u306e\u8a73\u7d30\u60c5\u5831\u3092\u53d6\u5f97\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u3063\u305f\u306e\u3067\u3001Munin \u306b\u8868\u793a\u3057\u3066\u307f\u307e\u3057\u305f\u3002\n\n# \u6982\u8981\nAmazon RDS \u306b\u8ffd\u52a0\u3055\u308c\u305f\u62e1\u5f35\u30e2\u30cb\u30bf\u30ea\u30f3\u30b0\u6a5f\u80fd\u306b\u3088\u308a\u3001RDS \u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e OS \u30ea\u30bd\u30fc\u30b9\u60c5\u5831\u304c CloudWatch Logs \u306b\u51fa\u529b\u3055\u308c\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3057\u305f\u3002\n\u4eca\u56de\u306f CloudWatch Logs \u306e\u30e1\u30c8\u30ea\u30c3\u30af\u30d5\u30a3\u30eb\u30bf\u3092\u4f7f\u7528\u3057\u3066\u3001\u30ed\u30fc\u30c9\u30a2\u30d9\u30ec\u30fc\u30b8\u3092 CloudWatch \u30e1\u30c8\u30ea\u30c3\u30af\u306b\u5909\u63db\u3001Munin \u3067\u30b0\u30e9\u30d5\u5316\u3057\u3066\u307f\u307e\u3059\u3002\n\n# \u3084\u3063\u3066\u307f\u305f\n## Amazon RDS \u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u62e1\u5f35\u30e2\u30cb\u30bf\u30ea\u30f3\u30b0\u3092\u6709\u52b9\u5316\n\u62e1\u5f35\u30e2\u30cb\u30bf\u30ea\u30f3\u30b0\u306e\u6709\u52b9\u5316\u306f\u3001\u30af\u30e9\u30b9\u30e1\u30bd\u30c3\u30c9\u3055\u3093\u306e\u30d6\u30ed\u30b0\u8a18\u4e8b [[\u65b0\u6a5f\u80fd]Amazon RDS\u3067OS\u306e\u8a73\u7d30\u60c5\u5831\u3092\u53d6\u5f97\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3057\u305f\uff01](http://dev.classmethod.jp/cloud/aws/rds-enhanced-monitoring/) \u306b\u624b\u9806\u3068\u8a2d\u5b9a\u4f8b\u304c\u3042\u308a\u307e\u3059\u3002\n\n## CloudWatch Logs \u306e\u753b\u9762\u3067\u30e1\u30c8\u30ea\u30c3\u30af\u30d5\u30a3\u30eb\u30bf\u3092\u4f5c\u6210\n![1-1.png](https://qiita-image-store.s3.amazonaws.com/0/23579/81782224-6093-f213-0d59-4a427dcc9e95.png)\n\nCreate Metric Filter \u30dc\u30bf\u30f3\u3092\u30af\u30ea\u30c3\u30af\u3002\n\n## Define Logs Metric Filter \u753b\u9762\u3067 Filter Pattern \u3092\u6307\u5b9a\n![1-2.png](https://qiita-image-store.s3.amazonaws.com/0/23579/a36d04eb-e840-784d-1e0e-bd634a0ff4bf.png)\n\n\u4eca\u56de\u306f Filter Pattern \u306b\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9 ID \u3068 LoadAverage 5\u5206\u9593\u306e\u5e73\u5747\u5024\u3092\u30c1\u30a7\u30c3\u30af\u3059\u308b\u3088\u3046\u306b\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\nFilter Pattern\n`{ $.instanceID = \"\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9ID\" && $.loadAverageMinute.five >= 0.00 }`\n\nTest Pattern \u30dc\u30bf\u30f3\u3067 Filter \u3092\u30c6\u30b9\u30c8\u3057\u305f\u3089\u3001Assign Metric \u30dc\u30bf\u30f3\u3092\u30af\u30ea\u30c3\u30af\u3002\n\n## Create Metric Filter and Assign a Metric \u753b\u9762\u3067 Filter Name \u3068 Metric \u306e\u8a73\u7d30\u3092\u8a2d\u5b9a\n![1-3.png](https://qiita-image-store.s3.amazonaws.com/0/23579/bc2ae308-20f3-3084-b30d-53b1853e5b04.png)\n\nMetric \u306e\u8a73\u7d30\u3092\u6b21\u306e\u3088\u3046\u306b\u8a2d\u5b9a\u3001Create Filter \u30dc\u30bf\u30f3\u3092\u30af\u30ea\u30c3\u30af\u3002\n\n- Metric Namespace: RDSOSMetrics\n- Metric Name: \u30a4\u30f3\u30b9\u30bf\u30f3\u30b9ID_LoadAverage\n- Metric Value: $.loadAverageMinute.five\n\n\nMetric Filter \u304c\u4f5c\u6210\u3055\u308c\u307e\u3057\u305f\u3002\n![1-4.png](https://qiita-image-store.s3.amazonaws.com/0/23579/65052f52-5db8-3480-f2cb-36348dbb0512.png)\n\nMetrics \u306e Custom Metrics \u304b\u3089\u300cRDSOSMetrics\u300d\u3092\u9078\u629e\u3059\u308b\u3068\u3001\u4f5c\u6210\u3057\u305f Metric \u304c\u8868\u793a\u3055\u308c\u307e\u3059\u3002\n![1-5.png](https://qiita-image-store.s3.amazonaws.com/0/23579/828e7553-1014-f639-d721-61f290415225.png)\n\n\n## Munin \u306e\u30d7\u30e9\u30b0\u30a4\u30f3\u3092\u4f5c\u6210\nCloudWatch Metrics \u304b\u3089\u60c5\u5831\u3092\u53d6\u5f97\u3059\u308b\u30d7\u30e9\u30b0\u30a4\u30f3\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\nCloudWatch Metrics \u304b\u3089\u306e Munin \u30d7\u30e9\u30b0\u30a4\u30f3\u4f5c\u6210\u306f\u3001[AWSCLI \u3092\u4f7f\u3063\u3066 ELB \u306e\u30c8\u30e9\u30d5\u30a3\u30c3\u30af\u3092 munin \u3067\u30b0\u30e9\u30d5\u5316](http://rriifftt.hatenablog.com/entry/2015/04/09/100645) \u3092\u53c2\u8003\u306b\u3055\u305b\u3066\u3044\u305f\u3060\u304d\u307e\u3057\u305f\u3002\n\nMetric Filter \u3092 RDS \u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u6570\u5206\u4f5c\u6210\u3057\u3066\u3001RDS_NAMES \u306b\u8a18\u8ff0\u3059\u308b\u30681\u3064\u306e\u30b0\u30e9\u30d5\u306b\u307e\u3068\u3081\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\n```bash:/usr/share/munin/plugins/rds_load\n#!/bin/bash\n\nAWS=\"/usr/bin/aws --region ap-northeast-1\"\nNAMESPACE=\"RDSOSMetrics\"\nMETRIC=\"LoadAverage\"\nRDS_NAMES=(\"test-db1\" \"test-db2\")\n\nif [ \"$1\" = \"autoconf\" ]; then\n    echo yes\n    exit 0\nfi\n\nif [ \"$1\" = \"config\" ]; then\n    echo \"graph_title Amazon RDS ${METRIC} \"\n    echo \"graph_args --base 1000 -l 0\"\n    echo \"graph_vlabel amazon rds ${METRIC}\"\n    echo \"graph_scale no\"\n    echo \"graph_category aws-rds\"\n    echo \"graph_info amazon rds ${METRIC}\"\n\n    for RDS_NAME in \"${RDS_NAMES[@]}\"\n    do\n        echo \"${RDS_NAME}_${METRIC}.label ${RDS_NAME}_${METRIC}\"\n        echo \"${RDS_NAME}_${METRIC}.info ${RDS_NAME}_${METRIC}\"\n        echo \"${RDS_NAME}_${METRIC}.type GAUGE\"\n        echo \"${RDS_NAME}_${METRIC}.draw LINE\"\n    done\n    exit 0\nfi\n\nfor RDS_NAME in \"${RDS_NAMES[@]}\"\ndo\n    retval=`${AWS} cloudwatch get-metric-statistics \\\n        --namespace ${NAMESPACE} \\\n        --metric-name \"${RDS_NAME}_${METRIC}\" \\\n        --period 60 \\\n        --start-time $(date --iso-8601=seconds --date '24 hour ago') \\\n        --end-time   $(date --iso-8601=seconds) \\\n        --statistics \"Average\" | /usr/local/bin/jq -r '.Datapoints | sort_by(.Timestamp) | reverse | .[0]'`\n\n    count=`echo \"${retval}\" | /usr/local/bin/jq -r '.Average'`\n    echo \"${RDS_NAME}_${METRIC}.value ${count}\"\ndone\n\nexit 0\n```\n\n\u30d7\u30e9\u30b0\u30a4\u30f3\u3092\u4f5c\u6210\u3057\u305f\u3089 plugins \u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306b\u30b7\u30f3\u30dc\u30ea\u30c3\u30af\u30ea\u30f3\u30af\u3092\u4f5c\u6210\u3001munin-node \u3092\u518d\u8d77\u52d5\u3057\u307e\u3059\u3002\n\n```\n# cd /etc/munin/plugins\n# ln -s /usr/share/munin/plugins/rds_load rds_load\n# /etc/init.d/munin-node restart\n```\n\n## Munin \u3067\u8868\u793a\u78ba\u8a8d\n![1-6.png](https://qiita-image-store.s3.amazonaws.com/0/23579/db0998a6-d699-b10a-1795-808774c8cb67.png)\n\n\u7121\u4e8b Munin \u3067\u30b0\u30e9\u30d5\u5316\u3067\u304d\u307e\u3057\u305f\uff01\n\n# \u307e\u3068\u3081\nRDS \u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u30ed\u30fc\u30c9\u30a2\u30d9\u30ec\u30fc\u30b8\u3092 Munin \u3067\u76e3\u8996\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3057\u305f\u3002\n\u4ed6\u306e\u30e1\u30c8\u30ea\u30af\u30b9\u3082 Munin \u3067\u3069\u3093\u3069\u3093\u30b0\u30e9\u30d5\u5316\u3057\u307e\u3057\u3087\u3046\uff01\n\n# \u53c2\u8003\u8cc7\u6599\n[[\u65b0\u6a5f\u80fd] Amazon RDS \u3067 OS \u306e\u8a73\u7d30\u60c5\u5831\u3092\u53d6\u5f97\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3057\u305f\uff01](http://dev.classmethod.jp/cloud/aws/rds-enhanced-monitoring/)\n[\u30ed\u30b0\u30d5\u30a1\u30a4\u30eb\u306e\u30e2\u30cb\u30bf\u30ea\u30f3\u30b0](http://docs.aws.amazon.com/ja_jp/AmazonCloudWatch/latest/DeveloperGuide/WhatIsCloudWatchLogs.html)\n[AWS-CLI \u3092\u4f7f\u3063\u3066 ELB \u306e\u30c8\u30e9\u30d5\u30a3\u30c3\u30af\u3092 munin \u3067\u30b0\u30e9\u30d5\u5316](http://rriifftt.hatenablog.com/entry/2015/04/09/100645)\n", "tags": ["AWS", "RDS", "CloudWatch", "Munin"]}