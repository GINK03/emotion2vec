{"tags": ["AWS", "fluentd", "bigquery", "EC2"], "context": "\u30de\u30a4\u30af\u30ed\u30b5\u30fc\u30d3\u30b9\u306e\u958b\u767a\u30921\u304b\u3089\u4e00\u4eba\u3067\u4f5c\u3063\u305f\u8a71\u3002\n\u30b5\u30fc\u30d3\u30b9\u8981\u4ef6\u3084\u3001\u5168\u4f53\u306e\u30b7\u30b9\u30c6\u30e0\u69cb\u6210\u3001\u958b\u767a\u30d5\u30ed\u30fc\u306e\u304a\u304a\u307e\u304b\u306a\u6d41\u308c\u306f\u3001\u4ee5\u4e0b\u306e\u8a18\u4e8b\u306b\u307e\u3068\u3081\u305f\u3002\n\u4e00\u304b\u3089\u30de\u30a4\u30af\u30ed\u30b5\u30fc\u30d3\u30b9\u306e\u958b\u767a\u30d5\u30ed\u30fc\u3092\u4f5c\u3063\u305f\u8a71\n\n\u3053\u3053\u3067\u306f\u5404\u8ad6\u3092\u66f8\u304f\u3002\n\u307e\u305a\u306f\u672c\u756a\u3067\u306e\u30ed\u30b0\u306b\u3064\u3044\u3066\u3002\n\n\u30ed\u30b0\u306e\u91cd\u8981\u5ea6\u4ed8\u3051\u3068\u3001\u305d\u308c\u305e\u308c\u306e\u4fdd\u5b58\u5834\u6240\n\u307e\u305a\u30ed\u30b0\u306e\u91cd\u8981\u5ea6\u3068\u3001\u5229\u7528\u65b9\u6cd5\u304b\u3089\u4fdd\u5b58\u5834\u6240\u3092\u8003\u3048\u308b\u3002\n\u4eca\u56de\u306f\u4ee5\u4e0b\u306e\u3068\u304a\u308a\u3068\u3057\u305f\u3002\n\n\u72b6\u614b\u76e3\u8996\u3092\u3059\u308b\u305f\u3081\u306e\u3082\u306e\n\u95a2\u9023\u3059\u308b\u5404\u30b5\u30fc\u30d0\u306e\u30ed\u30b0\u3092\u3001\n\u30ed\u30b0\u96c6\u7d04\u30b5\u30fc\u30d0\u3067\u95b2\u89a7\u3067\u304d\u308b\u3088\u3046\u306b\u3059\u308b\u3053\u3068\u3002\n\u305d\u306e\u3068\u304d\u3060\u3051\u898b\u308c\u308c\u3070\u3088\u3044\u30ed\u30b0\u3002\n\n\u3082\u3057\u304b\u3057\u305f\u3089\u3042\u3068\u304b\u3089\u78ba\u8a8d\u3059\u308b\u3053\u3068\u306b\u306a\u308b\u304b\u3082\u3057\u308c\u306a\u3044\u3082\u306e\n\u975e\u5e38\u4e8b\u614b\u306b\u78ba\u8a8d\u3059\u308b\u304b\u3082\u3057\u308c\u306a\u3044\u30ed\u30b0\u3002\n\u91cd\u8981\u5ea6\u306b\u5fdc\u3058\u3066\u3001\u4fdd\u5b58\u3059\u308b\u671f\u9593\u3092\u6c7a\u3081\u3066\u304a\u304f\u3002\n\u4eca\u56de\u306fgzip\u5316\u3057\u305f\u3082\u306e\u3092\u3001S3\u306b\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u3059\u308b\u3002\n\n\u30b5\u30fc\u30d3\u30b9\u7ba1\u7406\u8005\u4ee5\u5916\u3082\u5229\u7528\u3059\u308b\u3082\u306e\n\u305f\u3068\u3048\u3070\u30c7\u30fc\u30bf\u306e\u96c6\u8a08\u3067\u5229\u7528\u3059\u308b\u3082\u306e\u3002\n\u307e\u305f\u3001\u672c\u30b5\u30fc\u30d3\u30b9\u3092\u5229\u7528\u3059\u308b\u30b5\u30fc\u30d3\u30b9\u304c\u30d0\u30b0\u306a\u3069\u306e\u8abf\u67fb\u3092\u884c\u3046\u5834\u5408\u3001\u5fc5\u8981\u3068\u306a\u308b\u3082\u306e\u3002\n\u4eca\u56de\u306fGoogle BigQuery\u306b\u4fdd\u5b58\u3002\n\n\u672c\u756a\u30b5\u30fc\u30d0\u3067\u898b\u308b\u30ed\u30b0\u306e\u7a2e\u985e\u3068\u5f79\u5272\n\u5f79\u5272\u306b\u5fdc\u3058\u3066\u3001\u4fdd\u5b58\u671f\u9593\u3084\u4fdd\u5b58\u5834\u6240\u3092\u5909\u66f4\u3059\u308b\u304c\u3001\n\u3059\u3079\u3066\u30ed\u30b0\u3092\u96c6\u7d04\u3059\u308b\u30b5\u30fc\u30d0\u3067\u78ba\u8a8d\u3067\u304d\u308b\u3088\u3046\u306b\u3059\u308b\u3002\n\u30ed\u30b0\u30d5\u30a1\u30a4\u30eb\u306f1\u6642\u9593\u3054\u3068\u306b\u65b0\u3057\u3044\u7269\u304c\u4f5c\u6210\u3055\u308c\u3001\u53e4\u3044\u3082\u306e\u306fxxx.log-ymdh\u306e\u5f62\u5f0f\u3067\u4fdd\u5b58\u3055\u308c\u308b\u3002\n\n\u30a2\u30af\u30bb\u30b9\u30ed\u30b0\n\n\n\u57fa\u672c\u7684\u306b\u306f\u3069\u306e\u30b5\u30fc\u30d0\u306b\u30a2\u30af\u30bb\u30b9\u304c\u3044\u3063\u3066\u3044\u308b\u304b\u898b\u308c\u308c\u3070\u3044\u3044\n\u76e3\u8996 + S3\u30d0\u30c3\u30af\u30a2\u30c3\u30d7 (3\u30f6\u6708)\n\n\n\u30a8\u30e9\u30fc\u30ed\u30b0\n\n\n\u3069\u306e\u30b5\u30fc\u30d0\u3067\u3069\u306e\u3088\u3046\u306a\u30a8\u30e9\u30fc\u304c\u3067\u3066\u308b\u304b\u77e5\u308b\u305f\u3081\n\u76e3\u8996 + S3\u30d0\u30c3\u30af\u30a2\u30c3\u30d7 (3\u30f6\u6708)\n\n\n\u30ea\u30af\u30a8\u30b9\u30c8/\u30ec\u30b9\u30dd\u30f3\u30b9\u30ed\u30b0\n\n\n\u30b5\u30fc\u30d3\u30b9\u5229\u7528\u8005(API\u547c\u3073\u51fa\u3057\u5143\u306e\u30b5\u30fc\u30d3\u30b9)\u3067\u306e\u8abf\u67fb\u3092\u53ef\u80fd\u306b\u3059\u308b\u305f\u3081\n\u30c7\u30fc\u30bf\u306e\u5fa9\u5143\u3092\u53ef\u80fd\u306b\u3059\u308b\u305f\u3081\n\u76e3\u8996 + S3\u30d0\u30c3\u30af\u30a2\u30c3\u30d7 + BigQuery\n\n\n\u30e6\u30fc\u30b6\u30fc\u30a2\u30af\u30b7\u30e7\u30f3\u30ed\u30b0(\u76e3\u8996/\u30d0\u30c3\u30af\u30a2\u30c3\u30d7+BigQuery\u306b\u4fdd\u5b58)\n\n\n\u30e6\u30fc\u30b6\u306e\u884c\u52d5\u3092\u5206\u6790\u3059\u308b\u305f\u3081\n\u30c7\u30fc\u30bf\u306e\u5fa9\u5143\u3092\u53ef\u80fd\u306b\u3059\u308b\u305f\u3081\n\u76e3\u8996 + S3\u30d0\u30c3\u30af\u30a2\u30c3\u30d7 + BigQuery\n\n\n\n\n\u30d5\u30a9\u30eb\u30c0\u69cb\u6210\nvar/log/fluentd\n|--accounts (\u30de\u30a4\u30af\u30ed\u30b5\u30fc\u30d3\u30b9\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u540d)\n|  |--nginx (\u30a2\u30af\u30bb\u30b9\u30ed\u30b0/\u30a8\u30e9\u30fc\u30ed\u30b0)\n|  |  |--api_access.log (\u73fe\u5728\u306e\u3082\u306e\u306f\u65e5\u6642\u3092\u4ed8\u3051\u305a\u306b\u51fa\u529b)\n|  |  |--api_access.log-2016062917 (1\u6642\u9593\u524d\u306e\u3082\u306e\u307e\u3067\u306ftxt\u3067\u4fdd\u5b58)\n|  |  |--api_acesss.log-XXXXXXXXXX.gz (2\u6642\u9593\u4ee5\u4e0a\u524d\u306e\u3082\u306e\u306fgzip\u5727\u7e2e\u3002\u30b5\u30fc\u30d0\u306b\u306f\u904e\u53bb3\u65e5\u5206\u307e\u3067\u4fdd\u5b58\u3002)\n|  |  |--api_error.log\n|  |--response (\u30ec\u30b9\u30dd\u30f3\u30b9\u30ed\u30b0)\n|  |  |--v2_accounts.log\n|  |  |--v2_accounts_param.log\n|  |  |--v2_accounts_param_items.log\n|  |  |--v2_accounts_param_items_param.log\n|  |--act (\u30e6\u30fc\u30b6\u30fc\u30a2\u30af\u30b7\u30e7\u30f3\u30ed\u30b0)\n|  |  |--act.log \n|--items (\u30de\u30a4\u30af\u30ed\u30b5\u30fc\u30d3\u30b9\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u540d)\n\u2026\u4ee5\u4e0b\u3001\u30de\u30a4\u30af\u30ed\u30b5\u30fc\u30d3\u30b9\u306e\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u3054\u3068\u306b\u540c\u3058\u69cb\u9020\u304c\u3064\u3065\u304f\n\n\n\u5177\u4f53\u7684\u306a\u30ed\u30b0\u306e\u5f62\u5f0f\n\n\u30ea\u30af\u30a8\u30b9\u30c8/\u30ec\u30b9\u30dd\u30f3\u30b9\u30ed\u30b0\n\n\u6982\u8981\n\u30b5\u30fc\u30d3\u30b9\u306b\u304d\u305fRequest\u30c7\u30fc\u30bf\u3068\u3001Response\u30c7\u30fc\u30bf\u3092\u5408\u308f\u305b\u3066\u4fdd\u5b58\u3059\u308b\u3002\n\n\u76ee\u7684\n\u30d7\u30e9\u30c3\u30c8\u30d5\u30a9\u30fc\u30e0\u3068\u306a\u308b\u30b5\u30fc\u30d3\u30b9\u306e\u305f\u3081\u3001\u5229\u7528\u3059\u308b\u5074\u3067\u30a8\u30e9\u30fc\u304c\u8d77\u3053\u3063\u305f\u5834\u5408\u3067\u3082\u3001\u8abf\u67fb\u65b9\u6cd5\u3092\u6559\u3048\u308c\u3070\u3001\u5229\u7528\u8005\u5074\u3067\u8abf\u67fb\u304c\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u308b\u3002\n\u307e\u305f\u3001\u521d\u671f\u306e\u30a2\u30af\u30b7\u30e7\u30f3\u30ed\u30b0\u304c\u5341\u5206\u3067\u306f\u306a\u3044\u3068\u304d\u306e\u305f\u3081\u3001\u8abf\u67fb\u3059\u308c\u3070\u8ab0\u304c\u3001\u3044\u3064\u3001\u3069\u306e\u3088\u3046\u306a\u3053\u3068\u3092\u3084\u3063\u305f\u304b\u6700\u4f4e\u9650\u306f\u308f\u304b\u308b\u3002\n\n\u30d5\u30a1\u30a4\u30eb\u540d\u306e\u547d\u540d\u898f\u5247\n\nendpoint\u306e[/]\u90e8\u5206\u3092[_]\u306b\u5909\u63db\n\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u53d7\u3051\u53d6\u308b\u3068\u3053\u308d\u306f\u3001[param]\u306b\u5909\u63db\n\n\u4f8b) RESTful\u306b\u4f5c\u3063\u305fAPI\u306e\u5834\u5408\n/v1/accounts/1/items \u3078\u306e\u30a2\u30af\u30bb\u30b9 =>  v1_accounts_param_items.log\n\n\u30b5\u30f3\u30d7\u30eb\u30ed\u30b0\n\u57fa\u672c\u7684\u306b\u306f\u30d5\u30a1\u30a4\u30eb\u540d(endpoint)\u3068\u6642\u9593\u3067\u691c\u7d22\u3059\u308b\u306e\u3067\u3001\u30ab\u30e9\u30e0\u306f\u5206\u3051\u305a\u3001\u30ed\u30b0\u3092\u4fdd\u5b58\u3059\u308b\u3002\n\n20160629 18:19:20 {\"request_uri\":\"/v2/accounts\",\n \"request_method\":\"POST\",\n \"request_body\":\"{\\\"nickname\\\":\\\"samplenickname\\\",\\\"app_code\\\":\\\"test\\\"}\",\n \"http_status_code\":\"200 OK\",\n \"response_body\":\"{\\\"id\\\":1881038,\\\"nickname\\\":\\\"samplenickname\\\",\\\"status\\\":\\\"valid\\\",\"session\":\"sample\"}\"\n}\n\n\n\u30e6\u30fc\u30b6\u30fc\u30a2\u30af\u30b7\u30e7\u30f3\u30ed\u30b0\n\n\u6982\u8981\n\u30e6\u30fc\u30b6\u304c\u7279\u5b9a\u306e\u884c\u52d5\u3092\u3057\u305f\u5834\u5408\u306b\u3001\u4ed8\u968f\u3059\u308b\u30c7\u30fc\u30bf\u3092\u5408\u308f\u305b\u3066\u4fdd\u5b58\u3059\u308b\n\n\u76ee\u7684\n\u30e6\u30fc\u30b6\u306e\u884c\u52d5\u6642\u306b\u3001\u305d\u306e\u6642\u70b9\u306e\u30c7\u30fc\u30bf\u3092\u4fdd\u5b58\u3057\u3066\u304a\u304f\u3053\u3068\u3067\u3001\u3069\u306e\u3088\u3046\u306a\u30b9\u30c6\u30fc\u30bf\u30b9\u306e\u969b\u306b\u3001\u3069\u306e\u3088\u3046\u306a\u884c\u52d5\u3092\u8d77\u3053\u3059\u306e\u304b\u95a2\u9023\u4ed8\u3051\u3066\u8003\u3048\u308b\u3053\u3068\u304c\u3067\u304d\u308b\u3002\n\u307e\u305f\u3001\u30ed\u30b0\u3092\u3082\u3068\u306b\u30c7\u30fc\u30bf\u3092\u5143\u306b\u3082\u3069\u3059\u3053\u3068\u304c\u3067\u304d\u308b\u3002\n\nfluentd\u306e\u8a2d\u5b9a\n\u30ed\u30b0\u96c6\u7d04\u30b5\u30fc\u30d0\u3068\u3001\n\u5b9f\u969b\u306b\u51e6\u7406\u3092\u884c\u3046\u30b5\u30fc\u30d0\u3067\u305d\u308c\u305e\u308c\u5225\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092\u5229\u7528\u3059\u308b\u3002\n\u4e8b\u524d\u306bfluentd\u306e\u30d7\u30e9\u30b0\u30a4\u30f3\u3092\u5165\u308c\u3066\u304a\u304f\n- fluent-plugin-forest\n- fluent-plugin-bigquery\n- fluent-plugin-out-file-with-fix-path\n\n\u51e6\u7406\u30b5\u30fc\u30d0\n\u57fa\u672c\u7684\u306b\u3001\u51e6\u7406\u30b5\u30fc\u30d0\u306b\u306f\u30ed\u30b0\u30d5\u30a1\u30a4\u30eb\u3092\u51fa\u529b\u305b\u305a\u3001\u96c6\u7d04\u30b5\u30fc\u30d0\u3078\u30ed\u30b0\u3092\u9001\u308b\u3002\n# \u5404\u7a2enginx\u30ed\u30b0\u3092\u7d71\u5408\n<source>\n  type tail_ex\n  path /home/ec2-user/var/log/nginx/**.log\n  pos_file /var/tmp/fluentd.pos\n  format /^(?<message>.*)$/\n  # \u9001\u3089\u308c\u308b\u30bf\u30b0\u306fnginx.(\u30ed\u30b0\u30d5\u30a9\u30eb\u30c0\u3078\u306e\u968e\u5c64)  \n  # \u4f8b) nginx.home.ec2-user.var.log.nginx.api.accounts.production.access.log\n  tag nginx.*\n  refresh_interval 5\n</source>\n\n## \u2191\u306b\u8a2d\u5b9a\u3057\u305f\u30a2\u30af\u30bb\u30b9\u30ed\u30b0\u3092aggregate\u30b5\u30fc\u30d0\u306b\u9001\u4fe1\n<match nginx.**>\n  @type forward\n  buffer_type memory\n  buffer_chunk_limit 16m\n  buffer_queue_limit 128\n  flush_interval 1s\n  <server>\n    host xxx.xxx.xxx # \u30ed\u30b0\u96c6\u7d04\u30b5\u30fc\u30d0\u306e\u30db\u30b9\u30c8\u3092\u6307\u5b9a\n    port xxxxxx\n  </server>\n  <secondary>\n    @type file\n    path /var/log/td-agent/nginx_forward-failed\n  </secondary>\n</match>\n\n### \u30e6\u30fc\u30b6\u30fc\u30a2\u30af\u30b7\u30e7\u30f3\u30ed\u30b0\u7528\n# <project\u540d>.actlog.<table\u540d(logtype)\u3068\u3059\u308b>\n<match **.actlog.**>\n  @type forward\n  buffer_type memory\n  buffer_chunk_limit 16m\n  buffer_queue_limit 128\n  flush_interval 1s\n  <server>\n    host xxxxxxxxx\n    port xxxxx\n  </server>\n  <secondary>\n    @type file\n    path /var/log/td-agent/actlog-forward-failed\n  </secondary>\n</match>\n\n# request/response\u306e\u30ed\u30b0\n<match td.response.**>\n  @type forward\n  buffer_type memory\n  buffer_chunk_limit 16m\n  buffer_queue_limit 128\n  flush_interval 1s\n  <server>\n    host xxxxxxxxx\n    port xxxxx\n  </server>\n  <secondary>\n    @type file\n    path /var/log/td-agent/response-forward-failed\n  </secondary>\n</match>\n\n\n\u30ed\u30b0\u96c6\u7d04\u30b5\u30fc\u30d0\n# clone\u30b5\u30fc\u30d0\u304b\u3089\u30ed\u30b0\u3092\u53d7\u3051\u53d6\u308b\n<source>\n  @type forward\n  port 24224\n</source>\n\n# nginx\u95a2\u9023\u306e\u30ed\u30b0\u3092fluentd\u30d5\u30a9\u30eb\u30c0\u5185\u306b\u4fdd\u5b58\n<match nginx.**>\n  type forest\n  subtype file_with_fix_path\n  <template>\n    path /home/ec2-user/var/log/fluentd/${tag_parts[7]}/${tag_parts[8]}/${tag_parts[6]}_${tag_parts[9]}.log\n    time_slice_format %Y%m%d\n    time_format %Y%m%dT%H%M%S%z\n    flush_interval 1s\n  </template>\n</match>\n\n# <dataset\u540d>.actlog.<table\u540d\u3068\u3059\u308b>\n# \u203b \u5fc5\u8981\u306a\u6e96\u5099\n# 1. BigQuery\u306b project\u540d\u3067 dataset\u3092\u4f5c\u6210\u3059\u308b\n<match *.actlog.**>\n  type forest\n  subtype copy\n  <template>\n    # \u30ed\u30b0\u30d5\u30a1\u30a4\u30eb\u306b\u51fa\u529b\n    <store>\n      type file_with_fix_path\n      path /home/ec2-user/var/log/fluentd/${tag_parts[0]}/act/act.log\n      time_slice_format %Y%m%d\n      time_format %Y%m%dT%H%M%S%z\n      flush_interval 1s\n    </store>\n    # bigquery\u306b\u3082\u4fdd\u5b58\n    <store>\n      type bigquery\n      method insert\n       # google developer\u3067\u5165\u624b\u3057\u305f\u8a8d\u8a3c\u30d5\u30a1\u30a4\u30eb\n      auth_method json_key\n      json_key /home/ec2-user/conf/td-agent/key/bigquery.json\n\n      # \u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u3092\u6307\u5b9a\n      project bigqueryproject \n      # dataset\u540d\u3092\u6c7a\u5b9a\n      dataset ${tag_parts[0]}_action_log\n      # \u6307\u5b9a\u3055\u308c\u305f\u30d5\u30a1\u30a4\u30eb\u304b\u3089\u30c6\u30fc\u30d6\u30eb\u3092\u81ea\u52d5\u4f5c\u6210\n      auto_create_table true\n      table  ${tag_parts[2]}_%Y%m%d\n\n      time_format %s\n      time_field timestamp\n\n      # \u81ea\u52d5\u4f5c\u6210\u3059\u308b\u30c6\u30fc\u30d6\u30eb\u306e\u30d5\u30a9\u30fc\u30de\u30c3\u30c8\u3092\u6307\u5b9a\n      schema_path /home/ec2-user/conf/td-agent/json/${tag_parts[0]}_actlog_format.json\n    </store>\n  </template>\n</match>\n\n# request/response\u306e\u30ed\u30b0\n# \u203b \u5fc5\u8981\u306a\u6e96\u5099\n# 1. BigQuery\u306b response \u30c6\u30fc\u30d6\u30eb\u3092\u4f5c\u6210\n# td.response.(accounts,items,*****).\n<match td.response.**>\n  type forest\n  subtype copy\n  <template>\n    <store>\n      type file_with_fix_path\n      path /home/ec2-user/var/log/fluentd/${tag_parts[2]}/response/${tag_parts[3]}.log\n      time_slice_format %Y%m%d\n      time_format %Y%m%dT%H%M%S%z\n      flush_interval 1s\n    </store>\n    <store>\n      type bigquery\n      method insert\n      auth_method json_key\n      json_key /home/ec2-user/conf/td-agent/key/bigquery.json\n      project bigquery\n      dataset ${tag_parts[2]}_response_log\n      auto_create_table true\n      table ${tag_parts[3]}_%Y%m%d\n\n      time_format %s\n      time_field timestamp\n      schema_path /home/ec2-user/conf/td-agent/json/response_log_format.json\n    </store>\n  </template>\n</match>\n\n\n\nBigQuery\u30c6\u30fc\u30d6\u30eb\u81ea\u52d5\u751f\u6210\u7528\u306e\u30d5\u30a1\u30a4\u30eb\nfluentd-plugin-bigquery\u306f\u3001schema_path\u3067\u4f5c\u6210\u3057\u305f\u30c6\u30fc\u30d6\u30eb\u306e\u69cb\u9020\u3092\u6307\u5b9a\u3059\u308b\u3068\u3001\u81ea\u52d5\u3067\u30c6\u30fc\u30d6\u30eb\u3092\u4f5c\u6210\u3057\u3066\u304f\u308c\u308b\u3002\n\u305f\u3068\u3048\u3070\u3001\u524d\u8ff0\u3057\u305f\u30ea\u30af\u30a8\u30b9\u30c8/\u30ec\u30b9\u30dd\u30f3\u30b9\u30ed\u30b0\u7528\u3067\u3042\u308c\u3070\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u30d5\u30a1\u30a4\u30eb\u3092\u6307\u5b9a\u3059\u308b\u3002\n[\n  {\n    \"name\": \"request_uri\",\n    \"type\": \"STRING\"\n  },\n  {\n    \"name\": \"request_method\",\n    \"type\": \"STRING\"\n  },\n  {\n    \"name\": \"request_body\",\n    \"type\": \"STRING\"\n  },\n  {\n    \"name\": \"http_status_code\",\n    \"type\": \"INTEGER\"\n  },\n  {\n    \"name\": \"response_body\",\n    \"type\": \"STRING\"\n  },\n  {\n    \"name\": \"timestamp\",\n    \"type\": \"TIMESTAMP\"\n  }\n]\n\n\n\nlogrotate\u306e\u8a2d\u5b9a\n# fluentd\u3067\u6765\u305f\u5404\u30b5\u30fc\u30d0\u306e\u30a2\u30af\u30bb\u30b9/\u30a8\u30e9\u30fc, response_log, action_log\u3092lotate\n/home/ec2-user/var/log/fluentd/*/*/*.log {\n  hourly\n  # 5\u65e5\u9593\u3067\u524a\u9664 : 24 * 5\n  rotate 120\n  # gzip\u5727\u7e2e\u3092\u6709\u52b9\n  compress\n  # \u3072\u3068\u4e16\u4ee3\u524d\u306e\u3082\u306e\u306f\u5727\u7e2e\u3057\u306a\u3044\u30022\u4e16\u4ee3\u4ee5\u4e0a\u524d\u306e\u3082\u306e\u306fgzip\u5727\u7e2e\n  delaycompress\n  # \u30d5\u30a1\u30a4\u30eb\u304c\u306a\u304f\u3066\u3082OK\n  missingok\n  # notifempty #\u7a7a\u306a\u3089\u66f4\u65b0\u3057\u306a\u3044\n  # \u30d5\u30a1\u30a4\u30eb\u672b\u5c3e\u306b\u65e5\u4ed8\n  dateext\n  create 644 td-agent td-agent\n  # postrotate\u30921\u56de\u306b\u307e\u3068\u3081\u308b\n  sharedscripts\n  postrotate\n    /home/ec2-user/bin/upload_s3.sh $@ # \u30ed\u30b0\u30d5\u30a1\u30a4\u30eb\u3092S3\u306b\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u3059\u308b\u30d5\u30a1\u30a4\u30eb\n    pid=/var/run/td-agent/td-agent.pid\n    test -s $pid && kill -USR1 \"$(cat $pid)\"\n  endscript\n}\n\n\u2191\u3067\u5229\u7528\u3057\u3066\u3044\u308bupload_s3.sh\n#!/bin/sh\nBUCKET=<BUCKET\u540d>\nfor LOGFILE in $@; do\n    # 3\u4e16\u4ee3\u524d\u306b\u6b8b\u3057\u305f\u30ed\u30b0\u3092\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\n    # logrotate\u306e\u8a2d\u5b9a\u30672\u4e16\u4ee3\u524d\u306e\u3082\u306e\u307e\u3067gzip\u5727\u7e2e\u3055\u308c\u3066\u304a\u308a\u3001\n    # \u672c\u30b9\u30af\u30ea\u30d7\u30c8\u306fpostrotate\u3067\u8aad\u307f\u8fbc\u307e\u308c\u308b\u306e\u3067\u30013\u6642\u9593\u524d\u306e\u3082\u306e\u304cgzip\u5727\u7e2e\u3055\u308c\u3066\u3044\u308b\n    LOGFILE=$LOGFILE-`date '+%Y%m%d%H' -d '3hours ago'`.gz\n    BUCKETPATH=`echo \"$LOGFILE\" | sed s:/home/ec2-user/var/log/fluentd/::g`\n\n    # mime-type\u306f\u672a\u8a2d\u5b9a\u306b\u3057\u3066\u304a\u304f\u3068gzip\u3068\u3057\u3066\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3067\u304d\u308b\n    /usr/bin/s3cmd -M put $LOGFILE s3://${BUCKET}/${BUCKETPATH}\ndone\n\n\n\n\u30de\u30a4\u30af\u30ed\u30b5\u30fc\u30d3\u30b9\u306e\u958b\u767a\u30921\u304b\u3089\u4e00\u4eba\u3067\u4f5c\u3063\u305f\u8a71\u3002\n\u30b5\u30fc\u30d3\u30b9\u8981\u4ef6\u3084\u3001\u5168\u4f53\u306e\u30b7\u30b9\u30c6\u30e0\u69cb\u6210\u3001\u958b\u767a\u30d5\u30ed\u30fc\u306e\u304a\u304a\u307e\u304b\u306a\u6d41\u308c\u306f\u3001\u4ee5\u4e0b\u306e\u8a18\u4e8b\u306b\u307e\u3068\u3081\u305f\u3002\n[\u4e00\u304b\u3089\u30de\u30a4\u30af\u30ed\u30b5\u30fc\u30d3\u30b9\u306e\u958b\u767a\u30d5\u30ed\u30fc\u3092\u4f5c\u3063\u305f\u8a71\n](http://qiita.com/tomoyamachi@github/items/0f049c87bfdef4aa6ad9)\n\n\u3053\u3053\u3067\u306f\u5404\u8ad6\u3092\u66f8\u304f\u3002\n\u307e\u305a\u306f\u672c\u756a\u3067\u306e\u30ed\u30b0\u306b\u3064\u3044\u3066\u3002\n\n## \u30ed\u30b0\u306e\u91cd\u8981\u5ea6\u4ed8\u3051\u3068\u3001\u305d\u308c\u305e\u308c\u306e\u4fdd\u5b58\u5834\u6240\n\u307e\u305a\u30ed\u30b0\u306e\u91cd\u8981\u5ea6\u3068\u3001\u5229\u7528\u65b9\u6cd5\u304b\u3089\u4fdd\u5b58\u5834\u6240\u3092\u8003\u3048\u308b\u3002\n\u4eca\u56de\u306f\u4ee5\u4e0b\u306e\u3068\u304a\u308a\u3068\u3057\u305f\u3002\n### \u72b6\u614b\u76e3\u8996\u3092\u3059\u308b\u305f\u3081\u306e\u3082\u306e\n\u95a2\u9023\u3059\u308b\u5404\u30b5\u30fc\u30d0\u306e\u30ed\u30b0\u3092\u3001\n\u30ed\u30b0\u96c6\u7d04\u30b5\u30fc\u30d0\u3067\u95b2\u89a7\u3067\u304d\u308b\u3088\u3046\u306b\u3059\u308b\u3053\u3068\u3002\n\u305d\u306e\u3068\u304d\u3060\u3051\u898b\u308c\u308c\u3070\u3088\u3044\u30ed\u30b0\u3002\n\n### \u3082\u3057\u304b\u3057\u305f\u3089\u3042\u3068\u304b\u3089\u78ba\u8a8d\u3059\u308b\u3053\u3068\u306b\u306a\u308b\u304b\u3082\u3057\u308c\u306a\u3044\u3082\u306e\n\u975e\u5e38\u4e8b\u614b\u306b\u78ba\u8a8d\u3059\u308b\u304b\u3082\u3057\u308c\u306a\u3044\u30ed\u30b0\u3002\n\u91cd\u8981\u5ea6\u306b\u5fdc\u3058\u3066\u3001\u4fdd\u5b58\u3059\u308b\u671f\u9593\u3092\u6c7a\u3081\u3066\u304a\u304f\u3002\n\u4eca\u56de\u306fgzip\u5316\u3057\u305f\u3082\u306e\u3092\u3001S3\u306b\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u3059\u308b\u3002\n\n### \u30b5\u30fc\u30d3\u30b9\u7ba1\u7406\u8005\u4ee5\u5916\u3082\u5229\u7528\u3059\u308b\u3082\u306e\n\u305f\u3068\u3048\u3070\u30c7\u30fc\u30bf\u306e\u96c6\u8a08\u3067\u5229\u7528\u3059\u308b\u3082\u306e\u3002\n\u307e\u305f\u3001\u672c\u30b5\u30fc\u30d3\u30b9\u3092\u5229\u7528\u3059\u308b\u30b5\u30fc\u30d3\u30b9\u304c\u30d0\u30b0\u306a\u3069\u306e\u8abf\u67fb\u3092\u884c\u3046\u5834\u5408\u3001\u5fc5\u8981\u3068\u306a\u308b\u3082\u306e\u3002\n\u4eca\u56de\u306fGoogle BigQuery\u306b\u4fdd\u5b58\u3002\n\n## \u672c\u756a\u30b5\u30fc\u30d0\u3067\u898b\u308b\u30ed\u30b0\u306e\u7a2e\u985e\u3068\u5f79\u5272\n\u5f79\u5272\u306b\u5fdc\u3058\u3066\u3001\u4fdd\u5b58\u671f\u9593\u3084\u4fdd\u5b58\u5834\u6240\u3092\u5909\u66f4\u3059\u308b\u304c\u3001\n\u3059\u3079\u3066\u30ed\u30b0\u3092\u96c6\u7d04\u3059\u308b\u30b5\u30fc\u30d0\u3067\u78ba\u8a8d\u3067\u304d\u308b\u3088\u3046\u306b\u3059\u308b\u3002\n\u30ed\u30b0\u30d5\u30a1\u30a4\u30eb\u306f1\u6642\u9593\u3054\u3068\u306b\u65b0\u3057\u3044\u7269\u304c\u4f5c\u6210\u3055\u308c\u3001\u53e4\u3044\u3082\u306e\u306fxxx.log-ymdh\u306e\u5f62\u5f0f\u3067\u4fdd\u5b58\u3055\u308c\u308b\u3002\n\n- \u30a2\u30af\u30bb\u30b9\u30ed\u30b0\n\t- \u57fa\u672c\u7684\u306b\u306f\u3069\u306e\u30b5\u30fc\u30d0\u306b\u30a2\u30af\u30bb\u30b9\u304c\u3044\u3063\u3066\u3044\u308b\u304b\u898b\u308c\u308c\u3070\u3044\u3044\n\t- \u76e3\u8996 + S3\u30d0\u30c3\u30af\u30a2\u30c3\u30d7 (3\u30f6\u6708)\n- \u30a8\u30e9\u30fc\u30ed\u30b0\n\t- \u3069\u306e\u30b5\u30fc\u30d0\u3067\u3069\u306e\u3088\u3046\u306a\u30a8\u30e9\u30fc\u304c\u3067\u3066\u308b\u304b\u77e5\u308b\u305f\u3081\n\t- \u76e3\u8996 + S3\u30d0\u30c3\u30af\u30a2\u30c3\u30d7 (3\u30f6\u6708)\n- \u30ea\u30af\u30a8\u30b9\u30c8/\u30ec\u30b9\u30dd\u30f3\u30b9\u30ed\u30b0\n\t- \u30b5\u30fc\u30d3\u30b9\u5229\u7528\u8005(API\u547c\u3073\u51fa\u3057\u5143\u306e\u30b5\u30fc\u30d3\u30b9)\u3067\u306e\u8abf\u67fb\u3092\u53ef\u80fd\u306b\u3059\u308b\u305f\u3081\n\t- \u30c7\u30fc\u30bf\u306e\u5fa9\u5143\u3092\u53ef\u80fd\u306b\u3059\u308b\u305f\u3081\n\t- \u76e3\u8996 + S3\u30d0\u30c3\u30af\u30a2\u30c3\u30d7 + BigQuery\n- \u30e6\u30fc\u30b6\u30fc\u30a2\u30af\u30b7\u30e7\u30f3\u30ed\u30b0(\u76e3\u8996/\u30d0\u30c3\u30af\u30a2\u30c3\u30d7+BigQuery\u306b\u4fdd\u5b58)\n\t- \u30e6\u30fc\u30b6\u306e\u884c\u52d5\u3092\u5206\u6790\u3059\u308b\u305f\u3081\n\t- \u30c7\u30fc\u30bf\u306e\u5fa9\u5143\u3092\u53ef\u80fd\u306b\u3059\u308b\u305f\u3081\n\t- \u76e3\u8996 + S3\u30d0\u30c3\u30af\u30a2\u30c3\u30d7 + BigQuery\n\n### \u30d5\u30a9\u30eb\u30c0\u69cb\u6210\n```\nvar/log/fluentd\n|--accounts (\u30de\u30a4\u30af\u30ed\u30b5\u30fc\u30d3\u30b9\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u540d)\n|  |--nginx (\u30a2\u30af\u30bb\u30b9\u30ed\u30b0/\u30a8\u30e9\u30fc\u30ed\u30b0)\n|  |  |--api_access.log (\u73fe\u5728\u306e\u3082\u306e\u306f\u65e5\u6642\u3092\u4ed8\u3051\u305a\u306b\u51fa\u529b)\n|  |  |--api_access.log-2016062917 (1\u6642\u9593\u524d\u306e\u3082\u306e\u307e\u3067\u306ftxt\u3067\u4fdd\u5b58)\n|  |  |--api_acesss.log-XXXXXXXXXX.gz (2\u6642\u9593\u4ee5\u4e0a\u524d\u306e\u3082\u306e\u306fgzip\u5727\u7e2e\u3002\u30b5\u30fc\u30d0\u306b\u306f\u904e\u53bb3\u65e5\u5206\u307e\u3067\u4fdd\u5b58\u3002)\n|  |  |--api_error.log\n|  |--response (\u30ec\u30b9\u30dd\u30f3\u30b9\u30ed\u30b0)\n|  |  |--v2_accounts.log\n|  |  |--v2_accounts_param.log\n|  |  |--v2_accounts_param_items.log\n|  |  |--v2_accounts_param_items_param.log\n|  |--act (\u30e6\u30fc\u30b6\u30fc\u30a2\u30af\u30b7\u30e7\u30f3\u30ed\u30b0)\n|  |  |--act.log \n|--items (\u30de\u30a4\u30af\u30ed\u30b5\u30fc\u30d3\u30b9\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u540d)\n\u2026\u4ee5\u4e0b\u3001\u30de\u30a4\u30af\u30ed\u30b5\u30fc\u30d3\u30b9\u306e\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u3054\u3068\u306b\u540c\u3058\u69cb\u9020\u304c\u3064\u3065\u304f\n```\n\n## \u5177\u4f53\u7684\u306a\u30ed\u30b0\u306e\u5f62\u5f0f\n### \u30ea\u30af\u30a8\u30b9\u30c8/\u30ec\u30b9\u30dd\u30f3\u30b9\u30ed\u30b0\n#### \u6982\u8981\n\u30b5\u30fc\u30d3\u30b9\u306b\u304d\u305fRequest\u30c7\u30fc\u30bf\u3068\u3001Response\u30c7\u30fc\u30bf\u3092\u5408\u308f\u305b\u3066\u4fdd\u5b58\u3059\u308b\u3002\n\n#### \u76ee\u7684\n\u30d7\u30e9\u30c3\u30c8\u30d5\u30a9\u30fc\u30e0\u3068\u306a\u308b\u30b5\u30fc\u30d3\u30b9\u306e\u305f\u3081\u3001\u5229\u7528\u3059\u308b\u5074\u3067\u30a8\u30e9\u30fc\u304c\u8d77\u3053\u3063\u305f\u5834\u5408\u3067\u3082\u3001\u8abf\u67fb\u65b9\u6cd5\u3092\u6559\u3048\u308c\u3070\u3001\u5229\u7528\u8005\u5074\u3067\u8abf\u67fb\u304c\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u308b\u3002\n\u307e\u305f\u3001\u521d\u671f\u306e\u30a2\u30af\u30b7\u30e7\u30f3\u30ed\u30b0\u304c\u5341\u5206\u3067\u306f\u306a\u3044\u3068\u304d\u306e\u305f\u3081\u3001\u8abf\u67fb\u3059\u308c\u3070\u8ab0\u304c\u3001\u3044\u3064\u3001\u3069\u306e\u3088\u3046\u306a\u3053\u3068\u3092\u3084\u3063\u305f\u304b\u6700\u4f4e\u9650\u306f\u308f\u304b\u308b\u3002\n\n#### \u30d5\u30a1\u30a4\u30eb\u540d\u306e\u547d\u540d\u898f\u5247 \n- endpoint\u306e[/]\u90e8\u5206\u3092[_]\u306b\u5909\u63db\n- \u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u53d7\u3051\u53d6\u308b\u3068\u3053\u308d\u306f\u3001[param]\u306b\u5909\u63db\n\n\u4f8b) RESTful\u306b\u4f5c\u3063\u305fAPI\u306e\u5834\u5408\n/v1/accounts/1/items \u3078\u306e\u30a2\u30af\u30bb\u30b9 =>  v1_accounts_param_items.log\n\n#### \u30b5\u30f3\u30d7\u30eb\u30ed\u30b0\n\u57fa\u672c\u7684\u306b\u306f\u30d5\u30a1\u30a4\u30eb\u540d(endpoint)\u3068\u6642\u9593\u3067\u691c\u7d22\u3059\u308b\u306e\u3067\u3001\u30ab\u30e9\u30e0\u306f\u5206\u3051\u305a\u3001\u30ed\u30b0\u3092\u4fdd\u5b58\u3059\u308b\u3002\n```\n20160629 18:19:20 {\"request_uri\":\"/v2/accounts\",\n \"request_method\":\"POST\",\n \"request_body\":\"{\\\"nickname\\\":\\\"samplenickname\\\",\\\"app_code\\\":\\\"test\\\"}\",\n \"http_status_code\":\"200 OK\",\n \"response_body\":\"{\\\"id\\\":1881038,\\\"nickname\\\":\\\"samplenickname\\\",\\\"status\\\":\\\"valid\\\",\"session\":\"sample\"}\"\n}\n```\n\n### \u30e6\u30fc\u30b6\u30fc\u30a2\u30af\u30b7\u30e7\u30f3\u30ed\u30b0\n#### \u6982\u8981\n\u30e6\u30fc\u30b6\u304c\u7279\u5b9a\u306e\u884c\u52d5\u3092\u3057\u305f\u5834\u5408\u306b\u3001\u4ed8\u968f\u3059\u308b\u30c7\u30fc\u30bf\u3092\u5408\u308f\u305b\u3066\u4fdd\u5b58\u3059\u308b\n#### \u76ee\u7684\n\u30e6\u30fc\u30b6\u306e\u884c\u52d5\u6642\u306b\u3001\u305d\u306e\u6642\u70b9\u306e\u30c7\u30fc\u30bf\u3092\u4fdd\u5b58\u3057\u3066\u304a\u304f\u3053\u3068\u3067\u3001\u3069\u306e\u3088\u3046\u306a\u30b9\u30c6\u30fc\u30bf\u30b9\u306e\u969b\u306b\u3001\u3069\u306e\u3088\u3046\u306a\u884c\u52d5\u3092\u8d77\u3053\u3059\u306e\u304b\u95a2\u9023\u4ed8\u3051\u3066\u8003\u3048\u308b\u3053\u3068\u304c\u3067\u304d\u308b\u3002\n\u307e\u305f\u3001\u30ed\u30b0\u3092\u3082\u3068\u306b\u30c7\u30fc\u30bf\u3092\u5143\u306b\u3082\u3069\u3059\u3053\u3068\u304c\u3067\u304d\u308b\u3002\n\n## fluentd\u306e\u8a2d\u5b9a\n\u30ed\u30b0\u96c6\u7d04\u30b5\u30fc\u30d0\u3068\u3001\n\u5b9f\u969b\u306b\u51e6\u7406\u3092\u884c\u3046\u30b5\u30fc\u30d0\u3067\u305d\u308c\u305e\u308c\u5225\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092\u5229\u7528\u3059\u308b\u3002\n\n\u4e8b\u524d\u306bfluentd\u306e\u30d7\u30e9\u30b0\u30a4\u30f3\u3092\u5165\u308c\u3066\u304a\u304f\n- [fluent-plugin-forest](https://github.com/tagomoris/fluent-plugin-forest)\n- [fluent-plugin-bigquery](https://github.com/kaizenplatform/fluent-plugin-bigquery)\n- [fluent-plugin-out-file-with-fix-path](https://github.com/fetaro/fluent-plugin-out-file-with-fix-path)\n\n### \u51e6\u7406\u30b5\u30fc\u30d0\n\u57fa\u672c\u7684\u306b\u3001\u51e6\u7406\u30b5\u30fc\u30d0\u306b\u306f\u30ed\u30b0\u30d5\u30a1\u30a4\u30eb\u3092\u51fa\u529b\u305b\u305a\u3001\u96c6\u7d04\u30b5\u30fc\u30d0\u3078\u30ed\u30b0\u3092\u9001\u308b\u3002\n\n```\n# \u5404\u7a2enginx\u30ed\u30b0\u3092\u7d71\u5408\n<source>\n  type tail_ex\n  path /home/ec2-user/var/log/nginx/**.log\n  pos_file /var/tmp/fluentd.pos\n  format /^(?<message>.*)$/\n  # \u9001\u3089\u308c\u308b\u30bf\u30b0\u306fnginx.(\u30ed\u30b0\u30d5\u30a9\u30eb\u30c0\u3078\u306e\u968e\u5c64)  \n  # \u4f8b) nginx.home.ec2-user.var.log.nginx.api.accounts.production.access.log\n  tag nginx.*\n  refresh_interval 5\n</source>\n\n## \u2191\u306b\u8a2d\u5b9a\u3057\u305f\u30a2\u30af\u30bb\u30b9\u30ed\u30b0\u3092aggregate\u30b5\u30fc\u30d0\u306b\u9001\u4fe1\n<match nginx.**>\n  @type forward\n  buffer_type memory\n  buffer_chunk_limit 16m\n  buffer_queue_limit 128\n  flush_interval 1s\n  <server>\n    host xxx.xxx.xxx # \u30ed\u30b0\u96c6\u7d04\u30b5\u30fc\u30d0\u306e\u30db\u30b9\u30c8\u3092\u6307\u5b9a\n    port xxxxxx\n  </server>\n  <secondary>\n    @type file\n    path /var/log/td-agent/nginx_forward-failed\n  </secondary>\n</match>\n\n### \u30e6\u30fc\u30b6\u30fc\u30a2\u30af\u30b7\u30e7\u30f3\u30ed\u30b0\u7528\n# <project\u540d>.actlog.<table\u540d(logtype)\u3068\u3059\u308b>\n<match **.actlog.**>\n  @type forward\n  buffer_type memory\n  buffer_chunk_limit 16m\n  buffer_queue_limit 128\n  flush_interval 1s\n  <server>\n    host xxxxxxxxx\n    port xxxxx\n  </server>\n  <secondary>\n    @type file\n    path /var/log/td-agent/actlog-forward-failed\n  </secondary>\n</match>\n\n# request/response\u306e\u30ed\u30b0\n<match td.response.**>\n  @type forward\n  buffer_type memory\n  buffer_chunk_limit 16m\n  buffer_queue_limit 128\n  flush_interval 1s\n  <server>\n    host xxxxxxxxx\n    port xxxxx\n  </server>\n  <secondary>\n    @type file\n    path /var/log/td-agent/response-forward-failed\n  </secondary>\n</match>\n```\n### \u30ed\u30b0\u96c6\u7d04\u30b5\u30fc\u30d0\n\n```\n# clone\u30b5\u30fc\u30d0\u304b\u3089\u30ed\u30b0\u3092\u53d7\u3051\u53d6\u308b\n<source>\n  @type forward\n  port 24224\n</source>\n\n# nginx\u95a2\u9023\u306e\u30ed\u30b0\u3092fluentd\u30d5\u30a9\u30eb\u30c0\u5185\u306b\u4fdd\u5b58\n<match nginx.**>\n  type forest\n  subtype file_with_fix_path\n  <template>\n    path /home/ec2-user/var/log/fluentd/${tag_parts[7]}/${tag_parts[8]}/${tag_parts[6]}_${tag_parts[9]}.log\n    time_slice_format %Y%m%d\n    time_format %Y%m%dT%H%M%S%z\n    flush_interval 1s\n  </template>\n</match>\n\n# <dataset\u540d>.actlog.<table\u540d\u3068\u3059\u308b>\n# \u203b \u5fc5\u8981\u306a\u6e96\u5099\n# 1. BigQuery\u306b project\u540d\u3067 dataset\u3092\u4f5c\u6210\u3059\u308b\n<match *.actlog.**>\n  type forest\n  subtype copy\n  <template>\n    # \u30ed\u30b0\u30d5\u30a1\u30a4\u30eb\u306b\u51fa\u529b\n    <store>\n      type file_with_fix_path\n      path /home/ec2-user/var/log/fluentd/${tag_parts[0]}/act/act.log\n      time_slice_format %Y%m%d\n      time_format %Y%m%dT%H%M%S%z\n      flush_interval 1s\n    </store>\n    # bigquery\u306b\u3082\u4fdd\u5b58\n    <store>\n      type bigquery\n      method insert\n       # google developer\u3067\u5165\u624b\u3057\u305f\u8a8d\u8a3c\u30d5\u30a1\u30a4\u30eb\n      auth_method json_key\n      json_key /home/ec2-user/conf/td-agent/key/bigquery.json\n\n      # \u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u3092\u6307\u5b9a\n      project bigqueryproject \n      # dataset\u540d\u3092\u6c7a\u5b9a\n      dataset ${tag_parts[0]}_action_log\n      # \u6307\u5b9a\u3055\u308c\u305f\u30d5\u30a1\u30a4\u30eb\u304b\u3089\u30c6\u30fc\u30d6\u30eb\u3092\u81ea\u52d5\u4f5c\u6210\n      auto_create_table true\n      table  ${tag_parts[2]}_%Y%m%d\n\n      time_format %s\n      time_field timestamp\n      \n      # \u81ea\u52d5\u4f5c\u6210\u3059\u308b\u30c6\u30fc\u30d6\u30eb\u306e\u30d5\u30a9\u30fc\u30de\u30c3\u30c8\u3092\u6307\u5b9a\n      schema_path /home/ec2-user/conf/td-agent/json/${tag_parts[0]}_actlog_format.json\n    </store>\n  </template>\n</match>\n\n# request/response\u306e\u30ed\u30b0\n# \u203b \u5fc5\u8981\u306a\u6e96\u5099\n# 1. BigQuery\u306b response \u30c6\u30fc\u30d6\u30eb\u3092\u4f5c\u6210\n# td.response.(accounts,items,*****).\n<match td.response.**>\n  type forest\n  subtype copy\n  <template>\n    <store>\n      type file_with_fix_path\n      path /home/ec2-user/var/log/fluentd/${tag_parts[2]}/response/${tag_parts[3]}.log\n      time_slice_format %Y%m%d\n      time_format %Y%m%dT%H%M%S%z\n      flush_interval 1s\n    </store>\n    <store>\n      type bigquery\n      method insert\n      auth_method json_key\n      json_key /home/ec2-user/conf/td-agent/key/bigquery.json\n      project bigquery\n      dataset ${tag_parts[2]}_response_log\n      auto_create_table true\n      table ${tag_parts[3]}_%Y%m%d\n\n      time_format %s\n      time_field timestamp\n      schema_path /home/ec2-user/conf/td-agent/json/response_log_format.json\n    </store>\n  </template>\n</match>\n\n```\n## BigQuery\u30c6\u30fc\u30d6\u30eb\u81ea\u52d5\u751f\u6210\u7528\u306e\u30d5\u30a1\u30a4\u30eb\nfluentd-plugin-bigquery\u306f\u3001schema_path\u3067\u4f5c\u6210\u3057\u305f\u30c6\u30fc\u30d6\u30eb\u306e\u69cb\u9020\u3092\u6307\u5b9a\u3059\u308b\u3068\u3001\u81ea\u52d5\u3067\u30c6\u30fc\u30d6\u30eb\u3092\u4f5c\u6210\u3057\u3066\u304f\u308c\u308b\u3002\n\u305f\u3068\u3048\u3070\u3001\u524d\u8ff0\u3057\u305f\u30ea\u30af\u30a8\u30b9\u30c8/\u30ec\u30b9\u30dd\u30f3\u30b9\u30ed\u30b0\u7528\u3067\u3042\u308c\u3070\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u30d5\u30a1\u30a4\u30eb\u3092\u6307\u5b9a\u3059\u308b\u3002\n\n```\n[\n  {\n    \"name\": \"request_uri\",\n    \"type\": \"STRING\"\n  },\n  {\n    \"name\": \"request_method\",\n    \"type\": \"STRING\"\n  },\n  {\n    \"name\": \"request_body\",\n    \"type\": \"STRING\"\n  },\n  {\n    \"name\": \"http_status_code\",\n    \"type\": \"INTEGER\"\n  },\n  {\n    \"name\": \"response_body\",\n    \"type\": \"STRING\"\n  },\n  {\n    \"name\": \"timestamp\",\n    \"type\": \"TIMESTAMP\"\n  }\n]\n\n```\n\n## logrotate\u306e\u8a2d\u5b9a\n\n```\n# fluentd\u3067\u6765\u305f\u5404\u30b5\u30fc\u30d0\u306e\u30a2\u30af\u30bb\u30b9/\u30a8\u30e9\u30fc, response_log, action_log\u3092lotate\n/home/ec2-user/var/log/fluentd/*/*/*.log {\n  hourly\n  # 5\u65e5\u9593\u3067\u524a\u9664 : 24 * 5\n  rotate 120\n  # gzip\u5727\u7e2e\u3092\u6709\u52b9\n  compress\n  # \u3072\u3068\u4e16\u4ee3\u524d\u306e\u3082\u306e\u306f\u5727\u7e2e\u3057\u306a\u3044\u30022\u4e16\u4ee3\u4ee5\u4e0a\u524d\u306e\u3082\u306e\u306fgzip\u5727\u7e2e\n  delaycompress\n  # \u30d5\u30a1\u30a4\u30eb\u304c\u306a\u304f\u3066\u3082OK\n  missingok\n  # notifempty #\u7a7a\u306a\u3089\u66f4\u65b0\u3057\u306a\u3044\n  # \u30d5\u30a1\u30a4\u30eb\u672b\u5c3e\u306b\u65e5\u4ed8\n  dateext\n  create 644 td-agent td-agent\n  # postrotate\u30921\u56de\u306b\u307e\u3068\u3081\u308b\n  sharedscripts\n  postrotate\n    /home/ec2-user/bin/upload_s3.sh $@ # \u30ed\u30b0\u30d5\u30a1\u30a4\u30eb\u3092S3\u306b\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u3059\u308b\u30d5\u30a1\u30a4\u30eb\n    pid=/var/run/td-agent/td-agent.pid\n    test -s $pid && kill -USR1 \"$(cat $pid)\"\n  endscript\n}\n```\n\n\u2191\u3067\u5229\u7528\u3057\u3066\u3044\u308bupload_s3.sh\n\n```\n#!/bin/sh\nBUCKET=<BUCKET\u540d>\nfor LOGFILE in $@; do\n    # 3\u4e16\u4ee3\u524d\u306b\u6b8b\u3057\u305f\u30ed\u30b0\u3092\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\n    # logrotate\u306e\u8a2d\u5b9a\u30672\u4e16\u4ee3\u524d\u306e\u3082\u306e\u307e\u3067gzip\u5727\u7e2e\u3055\u308c\u3066\u304a\u308a\u3001\n    # \u672c\u30b9\u30af\u30ea\u30d7\u30c8\u306fpostrotate\u3067\u8aad\u307f\u8fbc\u307e\u308c\u308b\u306e\u3067\u30013\u6642\u9593\u524d\u306e\u3082\u306e\u304cgzip\u5727\u7e2e\u3055\u308c\u3066\u3044\u308b\n    LOGFILE=$LOGFILE-`date '+%Y%m%d%H' -d '3hours ago'`.gz\n    BUCKETPATH=`echo \"$LOGFILE\" | sed s:/home/ec2-user/var/log/fluentd/::g`\n\n    # mime-type\u306f\u672a\u8a2d\u5b9a\u306b\u3057\u3066\u304a\u304f\u3068gzip\u3068\u3057\u3066\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3067\u304d\u308b\n    /usr/bin/s3cmd -M put $LOGFILE s3://${BUCKET}/${BUCKETPATH}\ndone\n```\n"}