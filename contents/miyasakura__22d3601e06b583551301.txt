{"context": "EBS\u306e\u30c7\u30a3\u30b9\u30af\u30b5\u30a4\u30ba\u3092\u7e2e\u5c0f\u3059\u308b\u3084\u308a\u65b9\u306f\u30b0\u30b0\u308b\u3068\u8272\u3005\u51fa\u3066\u304f\u308b\u3082\u306e\u306e\u3001\u306a\u305c\u304b\u73fe\u5728\u306eEBS Backed\u306a\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3060\u3068\u65e5\u672c\u8a9e\u306e\u60c5\u5831\u306e\u624b\u9806\u3067\u306f\u3067\u304d\u306a\u304b\u3063\u305f\u306e\u3067\u30e1\u30e2\u3002\n\u666e\u901a\u306b\u3086\u3063\u304f\u308a\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u6b62\u3081\u3089\u308c\u308b\u72b6\u6cc1\u3067\u306e\u3084\u308a\u65b9\u3067\u3059\u3002\uff08\u30b9\u30ca\u30c3\u30d7\u30b7\u30e7\u30c3\u30c8\u53d6\u3063\u3066\u65b0\u3057\u3044VM\u3067\u3084\u308b\u3053\u3068\u306a\u3069\u3067\u505c\u6b62\u6642\u9593\u306f\u77ed\u304f\u3059\u308b\u3053\u3068\u306f\u53ef\u80fd\uff09\n\n1. \u65b0\u898f\u306eEBS\u3092\u4f5c\u6210\n\u307e\u305a\u76ee\u7684\u306e\u30b5\u30a4\u30ba\u306eEBS\u3092\u6301\u3063\u305fEC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u4f5c\u308a\u3001\u305d\u306eEBS\u30dc\u30ea\u30e5\u30fc\u30e0\u3092\u30c7\u30bf\u30c3\u30c1\u3059\u308b\u3053\u3068\u3067\u4f5c\u6210\u3059\u308b\u3002\n\u3068\u3044\u3046\u306e\u3082\u3053\u3046\u3057\u306a\u3044\u3068 Partition \u306b BIOS Boot Partition \u304c\u7121\u304f\u3066\u7acb\u3061\u4e0a\u304c\u3089\u306a\u3044\u305f\u3081\u3002\n\u305d\u3057\u3066\u3053\u306e\u30dc\u30ea\u30e5\u30fc\u30e0\u306eVolumeID\u3092\u30e1\u30e2\u3063\u3066\u304a\u304f\u3002VM\u306f\u3053\u306e\u6642\u70b9\u3067\u7528\u6e08\u307f\u3068\u3044\u3046\u3053\u3068\u3067\u524a\u9664\u3002\n\n2. \u4f5c\u696d\u7528EC2\u3092\u4f5c\u6210\nt2.small\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3067\u5341\u5206\u307d\u3044\u3002\n\u4ee5\u4e0b\u4f5c\u696d\u306f\u5168\u3066 root \u306b\u3066\u3002\n\u6570\u767e\u30ae\u30ac\u3060\u3068 rsync \u3067\u306e\u30b3\u30d4\u30fc\u304c\u9577\u304f tmux \u306b\u3066\u4f5c\u696d\u3057\u305f\u3044\u306e\u3067tmux\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3002\nAWS\u30b3\u30de\u30f3\u30c9\u306ejson\u64cd\u4f5c\u3067jq\u306f\u5fc5\u9808\u306a\u306e\u3067\u3053\u308c\u3082\u5165\u308c\u308b\u3002\n\u3042\u3068 aws configure \u3067 cli \u64cd\u4f5c\u3082\u3067\u304d\u308b\u3088\u3046\u306b\u3057\u3066\u304a\u304f\u3002\u6a29\u9650\u306fEC2\u5468\u308a\u306f\u30d5\u30eb\u30a2\u30af\u30bb\u30b9\u3067\u3002\n# yum install tmux jq\n# aws configure\nAWS Access Key ID []: xxx\nAWS Secret Access Key []: xxx\nDefault region name []: ap-northeast-1\nDefault output format [None]: json\n\n(\u3053\u306e\u5f8c\u306e\u30b3\u30de\u30f3\u30c9\u3067\u3088\u304f\u4f7f\u3046\u306e\u3067)\n# export INSTANCE_ID=`/opt/aws/bin/ec2-metadata  | grep instance-id | cut -d \" \" -f2`\n# export NEW_VOLUME_ID=\u30e1\u30e2\u3063\u3066\u304a\u3044\u305fVolumeID\n\n\n3. \u65b0EBS\u3092Attach\naws ec2 attach-volume --volume-id ${NEW_VOLUME_ID} --instance-id ${INSTANCE_ID} --device /dev/sdf \nlsblk #\u78ba\u8a8d\n\n\n4. \u30d5\u30a9\u30fc\u30de\u30c3\u30c8\u3057\u3066\u4f59\u8a08\u306a\u30c7\u30fc\u30bf\u3092\u306a\u304f\u3059\nmkfs.ext4 /dev/xvdf1 \n\n\n5. \u5143\u3068\u306a\u308bEBS\u3092EC2\u304b\u3089\u30c7\u30bf\u30c3\u30c1\u3057\u3001\u4f5c\u696d\u7528AWS\u306b\u30a2\u30bf\u30c3\u30c1\nexport TARGET_NAME=hoge\nexport TARGET_ID=`aws ec2 describe-instances --filters \"Name=tag:Name,Values=${TARGET_NAME}\" | jq -r '.Reservations[].Instances[].InstanceId'`\n\naws ec2 describe-instances --instance-ids ${TARGET_ID} | jq -r '.Reservations[].Instances[].BlockDeviceMappings[].Ebs.VolumeId' | xargs aws ec2 detach-volume --volume-id\naws ec2 attach-volume --volume-id {\u623b\u308a\u5024\u306e\u30dc\u30ea\u30e5\u30fc\u30e0\u540d} --instance-id=${INSTANCE_ID} --device /dev/sdg\n\n\n6. \u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u306b\u30e9\u30d9\u30eb\u3092\u4ed8\u3051\u308b\nxvdg\u3068\u540c\u3058\u30e9\u30d9\u30eb\u3092\u3064\u3051\u308b\u3002\uff08/etc/fstab \u3084 /boot/grub/grub.conf \u3067\u6307\u5b9a\u3055\u308c\u3066\u3044\u308b\u5024\u306b\u3057\u306a\u3044\u5834\u5408\u306b\u8d77\u52d5\u6642\u306b\u30dc\u30ea\u30e5\u30fc\u30e0\u304c\u30de\u30a6\u30f3\u30c8\u3055\u308c\u306a\u3044\u305f\u3081\u3002\uff09\ne2label /dev/xvdg1\ne2label /dev/xvdf1\ne2label /dev/xvdf1 /\ne2label /dev/xvdf1\n\n\n7. \u30c7\u30d0\u30a4\u30b9\u3092\u30de\u30a6\u30f3\u30c8\nmkdir -p /mnt/small /mnt/large\nmount -t ext4 -r /dev/xvdg1 /mnt/large\nmount -t ext4 /dev/xvdf1 /mnt/small\ndf -hT\n\n\n8. Rsync\u3067\u30b3\u30d4\u30fc\ntmux\nrsync -ax /mnt/large/ /mnt/small\n\n\n9. \u30a2\u30f3\u30de\u30a6\u30f3\u30c8\numount /mnt/large/ /mnt/small/\n\n\n10. EBS\u3092\u30c7\u30bf\u30c3\u30c1\n/opt/aws/bin/ec2-describe-instances --region ap-northeast-1 `/opt/aws/bin/ec2-metadata  | grep instance-id | cut -d \" \" -f2` | grep /dev/sd | cut -f 3 | xargs -n 1 aws ec2 detach-volume --volume-id\n\n\u203b\u9069\u5f53\u306a\u30ef\u30f3\u30e9\u30a4\u30ca\u30fc\u306a\u306e\u3067\u3061\u3087\u3063\u3068\u52d5\u4f5c\u304c\u5909\u308f\u308b\u3068\u52d5\u304b\u306a\u3044\u304b\u3082\n\n11. \u5143\u306eEC2\u306b\u65b0\u3057\u3044\u65b9\u306eEBS\u3092\u30a2\u30bf\u30c3\u30c1\u3057\u3066\u8d77\u52d5\u5f8c\u306b\u52d5\u4f5c\u78ba\u8a8d\naws ec2 attach-volume --volume-id ${NEW_VOLUME_ID} --device /dev/xvda --instance-id $TARGET_ID\naws ec2 start-instances --instance-ids $TARGET_ID\n\n\n12. \u30b9\u30ca\u30c3\u30d7\u30b7\u30e7\u30c3\u30c8\u3092\u53d6\u3063\u3066AMI\u4f5c\u6210\naws ec2 create-image --instance-id $TARGET_ID --name ${TARGET_NAME}_`date \"+%Y%m%d\"`\n\n\n13. \u30a4\u30e1\u30fc\u30b8\u304b\u3089\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u4f5c\u308a\u76f4\u3059\nCloudFormation\u4f7f\u3063\u3066\u308c\u3070ImageId\u3092\u5909\u66f4\u3059\u308b\u3060\u3051\u3060\u3063\u305f\u308a\u3002\n\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u304c\u554f\u984c\u306a\u304f\u7acb\u3061\u4e0a\u304c\u3063\u305f\u3089\u4e0d\u8981\u306aEBS\u30dc\u30ea\u30e5\u30fc\u30e0\u3084\u30b9\u30ca\u30c3\u30d7\u30b7\u30e7\u30c3\u30c8\u3092\u524a\u9664\u3057\u3066\u5b8c\u4e86\u3002\n\n\u53c2\u8003\nhttp://superuser.com/questions/332252/creating-and-formating-a-partition-using-a-bash-script\nhttp://atodorov.org/blog/2014/02/07/aws-tip-shrinking-ebs-root-volume-size/\nEBS\u306e\u30c7\u30a3\u30b9\u30af\u30b5\u30a4\u30ba\u3092\u7e2e\u5c0f\u3059\u308b\u3084\u308a\u65b9\u306f\u30b0\u30b0\u308b\u3068\u8272\u3005\u51fa\u3066\u304f\u308b\u3082\u306e\u306e\u3001\u306a\u305c\u304b\u73fe\u5728\u306eEBS Backed\u306a\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3060\u3068\u65e5\u672c\u8a9e\u306e\u60c5\u5831\u306e\u624b\u9806\u3067\u306f\u3067\u304d\u306a\u304b\u3063\u305f\u306e\u3067\u30e1\u30e2\u3002\n\n\u666e\u901a\u306b\u3086\u3063\u304f\u308a\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u6b62\u3081\u3089\u308c\u308b\u72b6\u6cc1\u3067\u306e\u3084\u308a\u65b9\u3067\u3059\u3002\uff08\u30b9\u30ca\u30c3\u30d7\u30b7\u30e7\u30c3\u30c8\u53d6\u3063\u3066\u65b0\u3057\u3044VM\u3067\u3084\u308b\u3053\u3068\u306a\u3069\u3067\u505c\u6b62\u6642\u9593\u306f\u77ed\u304f\u3059\u308b\u3053\u3068\u306f\u53ef\u80fd\uff09\n\n## 1. \u65b0\u898f\u306eEBS\u3092\u4f5c\u6210\n\n\u307e\u305a\u76ee\u7684\u306e\u30b5\u30a4\u30ba\u306eEBS\u3092\u6301\u3063\u305fEC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u4f5c\u308a\u3001\u305d\u306eEBS\u30dc\u30ea\u30e5\u30fc\u30e0\u3092\u30c7\u30bf\u30c3\u30c1\u3059\u308b\u3053\u3068\u3067\u4f5c\u6210\u3059\u308b\u3002\n\u3068\u3044\u3046\u306e\u3082\u3053\u3046\u3057\u306a\u3044\u3068 Partition \u306b BIOS Boot Partition \u304c\u7121\u304f\u3066\u7acb\u3061\u4e0a\u304c\u3089\u306a\u3044\u305f\u3081\u3002\n\n\u305d\u3057\u3066\u3053\u306e\u30dc\u30ea\u30e5\u30fc\u30e0\u306eVolumeID\u3092\u30e1\u30e2\u3063\u3066\u304a\u304f\u3002VM\u306f\u3053\u306e\u6642\u70b9\u3067\u7528\u6e08\u307f\u3068\u3044\u3046\u3053\u3068\u3067\u524a\u9664\u3002\n\n## 2. \u4f5c\u696d\u7528EC2\u3092\u4f5c\u6210\n\nt2.small\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3067\u5341\u5206\u307d\u3044\u3002\n\u4ee5\u4e0b\u4f5c\u696d\u306f\u5168\u3066 root \u306b\u3066\u3002\n\n\u6570\u767e\u30ae\u30ac\u3060\u3068 rsync \u3067\u306e\u30b3\u30d4\u30fc\u304c\u9577\u304f tmux \u306b\u3066\u4f5c\u696d\u3057\u305f\u3044\u306e\u3067tmux\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3002\nAWS\u30b3\u30de\u30f3\u30c9\u306ejson\u64cd\u4f5c\u3067jq\u306f\u5fc5\u9808\u306a\u306e\u3067\u3053\u308c\u3082\u5165\u308c\u308b\u3002\n\n\u3042\u3068 aws configure \u3067 cli \u64cd\u4f5c\u3082\u3067\u304d\u308b\u3088\u3046\u306b\u3057\u3066\u304a\u304f\u3002\u6a29\u9650\u306fEC2\u5468\u308a\u306f\u30d5\u30eb\u30a2\u30af\u30bb\u30b9\u3067\u3002\n\n```\n# yum install tmux jq\n# aws configure\nAWS Access Key ID []: xxx\nAWS Secret Access Key []: xxx\nDefault region name []: ap-northeast-1\nDefault output format [None]: json\n\n(\u3053\u306e\u5f8c\u306e\u30b3\u30de\u30f3\u30c9\u3067\u3088\u304f\u4f7f\u3046\u306e\u3067)\n# export INSTANCE_ID=`/opt/aws/bin/ec2-metadata  | grep instance-id | cut -d \" \" -f2`\n# export NEW_VOLUME_ID=\u30e1\u30e2\u3063\u3066\u304a\u3044\u305fVolumeID\n```\n\n## 3. \u65b0EBS\u3092Attach\n\n```\naws ec2 attach-volume --volume-id ${NEW_VOLUME_ID} --instance-id ${INSTANCE_ID} --device /dev/sdf \nlsblk #\u78ba\u8a8d\n```\n\n## 4. \u30d5\u30a9\u30fc\u30de\u30c3\u30c8\u3057\u3066\u4f59\u8a08\u306a\u30c7\u30fc\u30bf\u3092\u306a\u304f\u3059\n\n```\nmkfs.ext4 /dev/xvdf1 \n```\n\n## 5. \u5143\u3068\u306a\u308bEBS\u3092EC2\u304b\u3089\u30c7\u30bf\u30c3\u30c1\u3057\u3001\u4f5c\u696d\u7528AWS\u306b\u30a2\u30bf\u30c3\u30c1\n\n```\nexport TARGET_NAME=hoge\nexport TARGET_ID=`aws ec2 describe-instances --filters \"Name=tag:Name,Values=${TARGET_NAME}\" | jq -r '.Reservations[].Instances[].InstanceId'`\n\naws ec2 describe-instances --instance-ids ${TARGET_ID} | jq -r '.Reservations[].Instances[].BlockDeviceMappings[].Ebs.VolumeId' | xargs aws ec2 detach-volume --volume-id\naws ec2 attach-volume --volume-id {\u623b\u308a\u5024\u306e\u30dc\u30ea\u30e5\u30fc\u30e0\u540d} --instance-id=${INSTANCE_ID} --device /dev/sdg\n```\n\n\n\n## 6. \u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u306b\u30e9\u30d9\u30eb\u3092\u4ed8\u3051\u308b\n\nxvdg\u3068\u540c\u3058\u30e9\u30d9\u30eb\u3092\u3064\u3051\u308b\u3002\uff08/etc/fstab \u3084 /boot/grub/grub.conf \u3067\u6307\u5b9a\u3055\u308c\u3066\u3044\u308b\u5024\u306b\u3057\u306a\u3044\u5834\u5408\u306b\u8d77\u52d5\u6642\u306b\u30dc\u30ea\u30e5\u30fc\u30e0\u304c\u30de\u30a6\u30f3\u30c8\u3055\u308c\u306a\u3044\u305f\u3081\u3002\uff09\n\n```\ne2label /dev/xvdg1\ne2label /dev/xvdf1\ne2label /dev/xvdf1 /\ne2label /dev/xvdf1\n```\n\n\n## 7. \u30c7\u30d0\u30a4\u30b9\u3092\u30de\u30a6\u30f3\u30c8\n\n```\nmkdir -p /mnt/small /mnt/large\nmount -t ext4 -r /dev/xvdg1 /mnt/large\nmount -t ext4 /dev/xvdf1 /mnt/small\ndf -hT\n```\n\n## 8. Rsync\u3067\u30b3\u30d4\u30fc\n\n```\ntmux\nrsync -ax /mnt/large/ /mnt/small\n```\n\n## 9. \u30a2\u30f3\u30de\u30a6\u30f3\u30c8\n\n```\numount /mnt/large/ /mnt/small/\n```\n\n## 10. EBS\u3092\u30c7\u30bf\u30c3\u30c1\n\n```\n/opt/aws/bin/ec2-describe-instances --region ap-northeast-1 `/opt/aws/bin/ec2-metadata  | grep instance-id | cut -d \" \" -f2` | grep /dev/sd | cut -f 3 | xargs -n 1 aws ec2 detach-volume --volume-id\n```\n\n\u203b\u9069\u5f53\u306a\u30ef\u30f3\u30e9\u30a4\u30ca\u30fc\u306a\u306e\u3067\u3061\u3087\u3063\u3068\u52d5\u4f5c\u304c\u5909\u308f\u308b\u3068\u52d5\u304b\u306a\u3044\u304b\u3082\n\n## 11. \u5143\u306eEC2\u306b\u65b0\u3057\u3044\u65b9\u306eEBS\u3092\u30a2\u30bf\u30c3\u30c1\u3057\u3066\u8d77\u52d5\u5f8c\u306b\u52d5\u4f5c\u78ba\u8a8d\n\n```\naws ec2 attach-volume --volume-id ${NEW_VOLUME_ID} --device /dev/xvda --instance-id $TARGET_ID\naws ec2 start-instances --instance-ids $TARGET_ID\n```\n\n## 12. \u30b9\u30ca\u30c3\u30d7\u30b7\u30e7\u30c3\u30c8\u3092\u53d6\u3063\u3066AMI\u4f5c\u6210\n\n```\naws ec2 create-image --instance-id $TARGET_ID --name ${TARGET_NAME}_`date \"+%Y%m%d\"`\n```\n\n## 13. \u30a4\u30e1\u30fc\u30b8\u304b\u3089\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u4f5c\u308a\u76f4\u3059\n\nCloudFormation\u4f7f\u3063\u3066\u308c\u3070ImageId\u3092\u5909\u66f4\u3059\u308b\u3060\u3051\u3060\u3063\u305f\u308a\u3002\n\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u304c\u554f\u984c\u306a\u304f\u7acb\u3061\u4e0a\u304c\u3063\u305f\u3089\u4e0d\u8981\u306aEBS\u30dc\u30ea\u30e5\u30fc\u30e0\u3084\u30b9\u30ca\u30c3\u30d7\u30b7\u30e7\u30c3\u30c8\u3092\u524a\u9664\u3057\u3066\u5b8c\u4e86\u3002\n\n\n# \u53c2\u8003\n\nhttp://superuser.com/questions/332252/creating-and-formating-a-partition-using-a-bash-script\nhttp://atodorov.org/blog/2014/02/07/aws-tip-shrinking-ebs-root-volume-size/\n", "tags": ["AWS", "ebs", "EC2"]}