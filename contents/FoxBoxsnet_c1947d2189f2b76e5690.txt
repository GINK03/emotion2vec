{"tags": ["IDCF\u30af\u30e9\u30a6\u30c9", "GoogleAppsScript"], "context": "\u7686\u3055\u3093 \u3053\u3093\u306b\u3061\u306f\u3002 @FoxBoxsnet \u3067\u3059\u3002\n\u6628\u65e5\u306f Rancher Meetup #4 \u306b\u3054\u53c2\u52a0\u9802\u3044\u305f\u65b9\u3042\u308a\u304c\u3068\u3046\u3054\u3056\u3044\u307e\u3057\u305f\u3002\n\u53c2\u52a0\u8005\u306e\u65b9\u304b\u3089\u30af\u30e9\u30a6\u30c9\u6599\u91d1\u304c\u6016\u3044 \u79c1\u3068\u540c\u3058\u65b9 \u304c\u3044\u3089\u3063\u3057\u3083\u3044\u307e\u3057\u305f\u306e\u3067\u79c1\u304c\u4f7f\u3063\u3066\u308b\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u516c\u958b\u3057\u3088\u3046\u304b\u3068\u601d\u3044\u307e\u3059\u3002\nIDCF Tech-Blog \u3067\u53d6\u308a\u4e0a\u3052\u3066\u3044\u305f\u306e\u3067\u3053\u3044\u3064\u3092\u30ac\u30c3\u30c4\u30ea\u6539\u9020\u3057\u3066\u4f5c\u6210\u3057\u307e\u3057\u305f\n\u5229\u7528\u660e\u7d30\uff06\u30d3\u30ea\u30f3\u30b0API\u3067IDCF\u30af\u30e9\u30a6\u30c9\u306e\u5229\u7528\u72b6\u6cc1\u3092\u628a\u63e1\u3057\u3088\u3046 - IDCF Tech-Blog\n\n\u3084\u308b\u3053\u3068\n\u3053\u308c\u3092\u8aad\u307f\u307e\u3059 \u5229\u7528\u660e\u7d30\uff06\u30d3\u30ea\u30f3\u30b0API\u3067IDCF\u30af\u30e9\u30a6\u30c9\u306e\u5229\u7528\u72b6\u6cc1\u3092\u628a\u63e1\u3057\u3088\u3046 - IDCF Tech-Blog \u8aad\u3080\u3068\u4ed5\u7d44\u307f\u304c\u308f\u304b\u308b\u3068\u601d\u3044\u307e\u3059\u3002\n\u305d\u3057\u3066\u3053\u3061\u3089\u306e\u3053\u30b3\u30fc\u30c9\u3092 \u30b9\u30af\u30ea\u30d7\u30c8\u30da\u30fc\u30b8\u306b\u8cbc\u308a\u4ed8\u3051\u3066\u304f\u3060\u3055\u3044\u3002\n/*\nLICENSE\n\n   Copyright 2017 Tokyo Home Security Operation Center\n\n   Licensed under the Apache License, Version 2.0 (the \"License\");\n   you may not use this file except in compliance with the License.\n   You may obtain a copy of the License at\n\n       http://www.apache.org/licenses/LICENSE-2.0\n\n   Unless required by applicable law or agreed to in writing, software\n   distributed under the License is distributed on an \"AS IS\" BASIS,\n   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n   See the License for the specific language gover\n*/\n\n/*\n######### \u4e0b\u8a18\u306e\u5024\u3092 [\u30d5\u30a1\u30a4\u30eb] \u2192 [\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u306e\u30d7\u30ed\u30d1\u30c6\u30a3] \u2192 [\u30b9\u30af\u30ea\u30d7\u30c8\u306e\u30d7\u30ed\u30d1\u30c6\u30a3] \u306b\u8a2d\u5b9a\u3057\u3066\u304f\u3060\u3055\u3044\u3002  #########\n\nIDCF_API_KEY = \"IDCF\u30af\u30e9\u30a6\u30c9\u306eAPI\u30ad\u30fc\u3092\u3044\u308c\u3066\u304f\u3060\u3055\u3044\";\nIDCF_SECRET_KEY = \"IDCF\u30af\u30e9\u30a6\u30c9\u306eSECRET\u30ad\u30fc\u3092\u3044\u308c\u3066\u304f\u3060\u3055\u3044\";\nSPREADSHEET_ID = \"Google\u30b9\u30d7\u30ec\u30c3\u30c9\u30b7\u30fc\u30c8\u306eID\u3092\u3044\u308c\u3066\u304f\u3060\u3055\u3044\";\nSLACK_WEBHOOK_URL = \"Slack\u306eWebhook\u306eURL\u3092\u3044\u308c\u3066\u304f\u3060\u3055\u3044\";\n\n\n\u8aac\u660e\u7528URL: \n*/\n\nvar prop = PropertiesService.getScriptProperties().getProperties();\n\nfunction getThisMonth() {\n  var date = new Date();\n  return date.getFullYear() + \"-\" + (\"0\" + (date.getMonth()+1)).slice(-2);\n}\n\nfunction getToday() {\n  var date = new Date();\n  var this_month = date.getFullYear() + \"-\" + (\"0\" + (date.getMonth()+1)).slice(-2);\n  return this_month + \"-\" + (\"0\" + date.getDate()).slice(-2);\n}\n\n// Billing API\u3067\u5229\u7528\u660e\u7d30\u3092\u53d6\u5f97\nfunction getUsageData(month) {\n  var query_string = \"format=json\";\n  var expiration_seconds = 30;\n\n  var date = new Date();\n  var endpoint_uri = \"/api/v1/billings/\" + month;\n  var expiration = (Math.floor(date.getTime()/1000) + expiration_seconds).toString();\n  var message =\"GET\" + \"\\n\" + endpoint_uri + \"\\n\" + prop.IDCF_API_KEY + \"\\n\" + expiration + \"\\n\" + query_string;\n  var signature = Utilities.base64Encode((Utilities.computeHmacSha256Signature(message, prop.IDCF_SECRET_KEY)));  \n  var url = \"https://your.idcfcloud.com\" + endpoint_uri + \"?\" + query_string;\n  var params = {\n    \"headers\": {\n      \"X-IDCF-APIKEY\": prop.IDCF_API_KEY,\n      \"X-IDCF-Expires\": expiration,\n      \"X-IDCF-Signature\": signature\n    }\n  }\n  return JSON.parse(UrlFetchApp.fetch(url, params).getContentText())[\"data\"];\n}\n\n// \u5229\u7528\u660e\u7d30\u306b\u672c\u65e5\u306e\u65e5\u4ed8\u3092\u8868\u3059Date\u5217\u3092\u4ed8\u52a0\u3057\u3066Google\u30b9\u30d7\u30ec\u30c3\u30c9\u30b7\u30fc\u30c8\u306b\u66f8\u304d\u8fbc\u3080\nfunction sendUsageDataToSpreadsheet(ss, sheet, data) {\n  var this_month = getThisMonth();\n  var today = getToday();\n  var keys = [\n    \"Region\",\n    \"ServiceName\",\n    \"ZoneName\",\n    \"Category\",\n    \"Menu\",\n    \"ResourceDisplayName\",\n    \"StartDate\",\n    \"EndDate\",\n    \"Usage\",\n    \"Allocated\",\n    \"Running\",\n    \"Stopped\",\n    \"Amount\",\n    \"Tax\",\n    \"Net\"\n  ];\n  if (!sheet) {\n    sheet = ss.insertSheet(this_month, 0);\n  }\n  if (sheet.getLastRow() == 0) {\n    sheet.appendRow([\"Date\"].concat(keys));\n  }\n  data.forEach(function(resource) {\n    var values = [today].concat(keys.map(function(key) { return resource[key]; }));\n    sheet.appendRow(values);\n  });\n}\n\n\n\n// Slack\u306b\u73fe\u5728\u306e\u8acb\u6c42\u984d\u3092\u6295\u7a3f\u3059\u308b\nfunction postTotalAmountToSlack(webhook_url, data) {\n  var total_amount = 0; \n\n  var jp_east_amount = 0;\n  var jp_east_vm = 0;\n  var jp_east_volume = 0;\n  var jp_east_archived_data = 0;\n  var jp_east_datatransfer_in = 0;\n  var jp_east_datatransfer_out = 0;\n  var jp_east_object_storage_traffic = 0;\n  var jp_east_object_storage_storage = 0;\n\n  var jp_west_amount = 0;\n  var jp_west_vm = 0;\n  var jp_west_volume = 0;\n  var jp_east_archived_data = 0;\n  var jp_west_datatransfer_in = 0;\n  var jp_west_datatransfer_out = 0;\n\n    data.forEach(function(resource) {\n    switch(resource[\"Region\"]){\n      case \"jp-east\":\n        jp_east_amount += resource[\"Amount\"];\n        switch(resource[\"ServiceName\"]){\n          case \"Cloud Computing\":\n            switch(resource[\"Category\"]){\n              case \"VirtualMachine\":\n                jp_east_vm += resource[\"Amount\"];\n                break;\n\n              case \"Volume\":\n                jp_east_volume += resource[\"Amount\"];\n                break;\n\n              case \"Internet Data Transfer\":\n                switch(resource[\"Menu\"]){\n                  case \"Internet Data Transfer [in]\":\n                    jp_east_datatransfer_in += resource[\"Usage\"];\n                    break;\n                  case \"Internet Data Transfer [out]\":\n                    jp_east_datatransfer_out += resource[\"Usage\"];\n                    break;\n                }\n                break;\n            }\n            break;\n          case \"Archived Data\":\n            switch(resource[\"Menu\"]){\n              case \"Archive Storage - Template Data Usage\":\n                jp_east_object_storage_traffic += resource[\"Amount\"];\n                break;\n            }\n            break;\n          case \"Object Storage\":\n            switch(resource[\"Menu\"]){\n              case \"Object Storage - Traffic Usage\":\n                jp_east_object_storage_traffic += resource[\"Usage\"];\n                break;\n              case \"Object Storage - Storage Usage\":\n                jp_east_object_storage_storage += resource[\"Usage\"];\n                break;\n            }\n            break;\n        }\n        break;\n      case \"jp-east-2\":\n        jp_east_amount += resource[\"Amount\"];\n        switch(resource[\"ServiceName\"]){\n          case \"Cloud Computing\":\n            switch(resource[\"Category\"]){\n              case \"VirtualMachine\":\n                jp_east_vm += resource[\"Amount\"];\n                break;\n\n              case \"Volume\":\n                jp_east_volume += resource[\"Amount\"];\n                break;\n\n              case \"Internet Data Transfer\":\n                switch(resource[\"Menu\"]){\n                  case \"Internet Data Transfer [in]\":\n                    jp_east_datatransfer_in += resource[\"Usage\"];\n                    break;\n                  case \"Internet Data Transfer [out]\":\n                    jp_east_datatransfer_out += resource[\"Usage\"];\n                    break;\n                }\n                break;\n            }\n            break;\n          case \"Archived Data\":\n            switch(resource[\"Menu\"]){\n              case \"Archive Storage - Template Data Usage\":\n                jp_east_object_storage_traffic += resource[\"Usage\"];\n                break;\n            }\n            break;\n          case \"Object Storage\":\n            switch(resource[\"Menu\"]){\n              case \"Object Storage - Traffic Usage\":\n                jp_east_object_storage_traffic += resource[\"Usage\"];\n                break;\n              case \"Object Storage - Storage Usage\":\n                jp_east_object_storage_storage += resource[\"Usage\"];\n                break;\n            }\n            break;\n        }\n        break;\n      case \"jp_west\":\n        jp_west_amount += resource[\"Amount\"];\n        switch(resource[\"ServiceName\"]){\n          case \"Cloud Computing\":\n            switch(resource[\"Category\"]){\n              case \"VirtualMachine\":\n                jp_west_vm += resource[\"Amount\"];\n                break;\n\n              case \"Volume\":\n                jp_west_volume += resource[\"Amount\"];\n                break;\n\n              case \"Internet Data Transfer\":\n                switch(resource[\"Menu\"]){\n                  case \"Internet Data Transfer [in]\":\n                    jp_west_datatransfer_in += resource[\"Usage\"];\n                    break;\n                  case \"Internet Data Transfer [out]\":\n                    jp_west_datatransfer_out += resource[\"Usage\"];\n                    break;\n                }\n                break;\n            }\n            break;\n          case \"Archived Data\":\n            switch(resource[\"Menu\"]){\n              case \"Archive Storage - Template Data Usage\":\n                jp_west_object_storage_traffic += resource[\"Amount\"];\n                break;\n            }\n            break;\n          case \"Object Storage\":\n            switch(resource[\"Menu\"]){\n              case \"Object Storage - Traffic Usage\":\n                jp_west_object_storage_traffic += resource[\"Usage\"];\n                break;\n              case \"Object Storage - Storage Usage\":\n                jp_west_object_storage_storage += resource[\"Usage\"];\n                break;\n            }\n            break;\n        }\n        break;\n    }\n    });\n\n\n\n  data.forEach(function(resource) {\n    total_amount += resource[\"Amount\"];\n  });\n\n\n  var message = {\n    \"attachments\": [\n      {\n        \"author_name\": \"\u5408\u8a08\",\n        \"color\": \"good\",\n        \"text\": \"\u4eca\u6708\u5206\u306e\u8acb\u6c42\u984d\u306f\u73fe\u5728\" + total_amount + \"\u5186\u3067\u3059\",\n        \"fields\": [\n        {\n        \"title\": \"\u6771\u65e5\u672c\u30ea\u30fc\u30b8\u30e7\u30f3\",\n        \"value\": jp_east_amount + \"\u5186\u3067\u3059\",\n        \"short\": true\n      },\n      {\n        \"title\": \"\u897f\u65e5\u672c\u30ea\u30fc\u30b8\u30e7\u30f3\",\n        \"value\": jp_west_amount + \"\u5186\u3067\u3059\",\n        \"short\": true\n      }\n    ]\n  },\n      {\n        \"author_name\": \"\u6771\u65e5\u672c\u30ea\u30fc\u30b8\u30e7\u30f3\",\n          \"color\": \"good\",\n            \"fields\": [\n              {\n                \"title\": \"\u4eee\u60f3\u30de\u30b7\u30f3\",\n                \"value\": jp_east_vm + \"\u5186\u3067\u3059\",\n                \"short\": false\n              },\n              {\n                \"title\": \"\u30dc\u30ea\u30e5\u30fc\u30e0(\u30eb\u30fc\u30c8\u30c7\u30a3\u30b9\u30af\u30fb\u30c7\u30fc\u30bf\u30c7\u30a3\u30b9\u30af)\",\n                \"value\": jp_east_volume + \"\u5186\u3067\u3059\",\n                \"short\": false\n              },\n              {\n                \"title\": \"\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u8ee2\u9001\",\n                \"value\": jp_east_datatransfer_in + jp_east_datatransfer_out + \"GB\u3067\u3059\",\n                \"short\": false\n              },\n              {\n                \"title\": \"\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u8ee2\u9001(IN)\",\n                \"value\": jp_east_datatransfer_in + \"GB\u3067\u3059\",\n                \"short\": true\n              },\n              {\n                \"title\": \"\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u8ee2\u9001(OUT)\",\n                \"value\": jp_east_datatransfer_out + \"GB\u3067\u3059\",\n                \"short\": true\n              },\n              {\n                \"title\": \"\u30a2\u30fc\u30ab\u30a4\u30d6\u30c7\u30fc\u30bf\",\n                \"value\": jp_east_datatransfer_out + \"GB\u3067\u3059\",\n                \"short\": false\n              },\n              {\n                \"title\": \"\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u30b9\u30c8\u30ec\u30fc\u30b8(Traffic)\",\n                \"value\": jp_east_object_storage_traffic + \"GB\u3067\u3059\",\n                \"short\": true\n              },\n              {\n                \"title\": \"\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u30b9\u30c8\u30ec\u30fc\u30b8(Storage)\",\n                \"value\": jp_east_object_storage_storage + \"GB\u3067\u3059\",\n                \"short\": true\n              }\n            ]\n      },\n        {\n          \"author_name\": \"\u897f\u65e5\u672c\u30ea\u30fc\u30b8\u30e7\u30f3\",\n            \"color\": \"good\",\n              \"fields\": [\n                {\n                  \"title\": \"\u4eee\u60f3\u30de\u30b7\u30f3\",\n                  \"value\": jp_west_vm + \"\u5186\u3067\u3059\",\n                  \"short\": false\n                },\n                {\n                  \"title\": \"\u30dc\u30ea\u30e5\u30fc\u30e0(\u30eb\u30fc\u30c8\u30c7\u30a3\u30b9\u30af\u30fb\u30c7\u30fc\u30bf\u30c7\u30a3\u30b9\u30af)\",\n                  \"value\": jp_west_volume + \"\u5186\u3067\u3059\",\n                  \"short\": false\n                },\n                {\n                  \"title\": \"\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u8ee2\u9001\",\n                  \"value\": jp_west_datatransfer_in + jp_west_datatransfer_out + \"GB\u3067\u3059\",\n                  \"short\": false\n                },\n                {\n                  \"title\": \"\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u8ee2\u9001(IN)\",\n                  \"value\": jp_west_datatransfer_in + \"GB\u3067\u3059\",\n                  \"short\": true\n                },\n                {\n                  \"title\": \"\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u8ee2\u9001(OUT)\",\n                  \"value\": jp_west_datatransfer_out + \"GB\u3067\u3059\",\n                  \"short\": true\n                },\n                {\n                \"title\": \"\u30a2\u30fc\u30ab\u30a4\u30d6\u30c7\u30fc\u30bf\",\n                \"value\": jp_west_datatransfer_out + \"GB\u3067\u3059\",\n                \"short\": false\n              },\n              ]\n        }\n  ]\n};\nvar params = {\n  \"method\": \"post\",\n  \"payload\": 'payload=' + JSON.stringify(message)\n};\nUrlFetchApp.fetch(prop.SLACK_WEBHOOK_URL, params)\n}\n\nfunction main() {\n  var this_month = getThisMonth();\n  var ss = SpreadsheetApp.openById(prop.SPREADSHEET_ID);\n  var sheet = ss.getSheetByName(this_month);\n\n  var data = getUsageData(this_month);\n  sendUsageDataToSpreadsheet(ss, sheet, data);\n  postTotalAmountToSlack(prop.SLACK_WEBHOOK_URL, data);\n}\n\n\nGogole AppsScript \u306bAPI\u30ad\u30fc\u306a\u3069\u3092\u767b\u9332\u3059\u308b\n[\u30d5\u30a1\u30a4\u30eb]\u2192[\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u30d7\u30ed\u30d1\u30c6\u30a3] \u3092\u958b\u304d\u307e\u3059\n\n[\u30b9\u30af\u30ea\u30d7\u30c8\u306e\u30d7\u30ed\u30d1\u30c6\u30a3] \u3092\u958b\u3044\u3066\u4e0b\u8a18\u306e\u5024\u3092\u8a2d\u5b9a\u3057\u3066\u304f\u3060\u3055\u3044\n\u672c\u5bb6: \u5229\u7528\u660e\u7d30\uff06\u30d3\u30ea\u30f3\u30b0API\u3067IDCF\u30af\u30e9\u30a6\u30c9\u306e\u5229\u7528\u72b6\u6cc1\u3092\u628a\u63e1\u3057\u3088\u3046 - IDCF Tech-Blog \u3067\u306f\u30b3\u30fc\u30c9\u306b\u76f4\u66f8\u304d\u3067\u3057\u305f\u306e\u3067\u4fee\u6b63\u3055\u305b\u3066\u9802\u304d\u307e\u3057\u305f\u3002\nIDCF_API_KEY = \"IDCF\u30af\u30e9\u30a6\u30c9\u306eAPI\u30ad\u30fc\u3092\u3044\u308c\u3066\u304f\u3060\u3055\u3044\";\nIDCF_SECRET_KEY = \"IDCF\u30af\u30e9\u30a6\u30c9\u306eSECRET\u30ad\u30fc\u3092\u3044\u308c\u3066\u304f\u3060\u3055\u3044\";\nSPREADSHEET_ID = \"Google\u30b9\u30d7\u30ec\u30c3\u30c9\u30b7\u30fc\u30c8\u306eID\u3092\u3044\u308c\u3066\u304f\u3060\u3055\u3044\";\nSLACK_WEBHOOK_URL = \"Slack\u306eWebhook\u306eURL\u3092\u3044\u308c\u3066\u304f\u3060\u3055\u3044\";\n\n\n\u5f8c\u306f\u624b\u9806\u901a\u308a\u3067\u7a3c\u50cd\u51fa\u6765\u308b\u3068\u601d\u3044\u307e\u3059\u3002\n\u901a\u77e5\u304c\u6765\u308b\u3068\u3053\u3093\u306a\u611f\u3058\u3067\u8868\u793a\u3055\u308c\u308b\u3088\u3046\u306b\u306a\u3063\u3066\u307e\u3059\u3002\nIDCF Cloud \u306e\u9805\u76ee\u3054\u3068\u306b\u30d1\u30fc\u30b9\u3092\u639b\u3051\u3066\u308b\u306e\u3067\u79c1\u304c\u77e5\u3089\u306a\u3044\u9805\u76ee\u306f\u3055\u308c\u306a\u3044\u306e\u3067\u4f55\u304b\u6f0f\u308c\u306a\u3069\u3042\u308a\u307e\u3057\u305f\u3089\u30b3\u30e1\u30f3\u30c8\u306a\u3069\u3067\u304a\u77e5\u3089\u305b\u304f\u3060\u3055\u3044\n\n\u826f\u3044 IDCF Cloud \u30e9\u30a4\u30d5\u3092!\uff01\n\u7686\u3055\u3093 \u3053\u3093\u306b\u3061\u306f\u3002 @FoxBoxsnet \u3067\u3059\u3002\n\n\u6628\u65e5\u306f Rancher Meetup #4 \u306b\u3054\u53c2\u52a0\u9802\u3044\u305f\u65b9\u3042\u308a\u304c\u3068\u3046\u3054\u3056\u3044\u307e\u3057\u305f\u3002\n\n\u53c2\u52a0\u8005\u306e\u65b9\u304b\u3089\u30af\u30e9\u30a6\u30c9\u6599\u91d1\u304c\u6016\u3044 **\u79c1\u3068\u540c\u3058\u65b9** \u304c\u3044\u3089\u3063\u3057\u3083\u3044\u307e\u3057\u305f\u306e\u3067\u79c1\u304c\u4f7f\u3063\u3066\u308b\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u516c\u958b\u3057\u3088\u3046\u304b\u3068\u601d\u3044\u307e\u3059\u3002\n\nIDCF Tech\\-Blog \u3067\u53d6\u308a\u4e0a\u3052\u3066\u3044\u305f\u306e\u3067\u3053\u3044\u3064\u3092\u30ac\u30c3\u30c4\u30ea\u6539\u9020\u3057\u3066\u4f5c\u6210\u3057\u307e\u3057\u305f\n[\u5229\u7528\u660e\u7d30\uff06\u30d3\u30ea\u30f3\u30b0API\u3067IDCF\u30af\u30e9\u30a6\u30c9\u306e\u5229\u7528\u72b6\u6cc1\u3092\u628a\u63e1\u3057\u3088\u3046 \\- IDCF Tech\\-Blog](http://blog.idcf.jp/entry/2016/08/31/154810)\n\n# \u3084\u308b\u3053\u3068\n\u3053\u308c\u3092\u8aad\u307f\u307e\u3059 [\u5229\u7528\u660e\u7d30\uff06\u30d3\u30ea\u30f3\u30b0API\u3067IDCF\u30af\u30e9\u30a6\u30c9\u306e\u5229\u7528\u72b6\u6cc1\u3092\u628a\u63e1\u3057\u3088\u3046 \\- IDCF Tech\\-Blog](http://blog.idcf.jp/entry/2016/08/31/154810) \u8aad\u3080\u3068\u4ed5\u7d44\u307f\u304c\u308f\u304b\u308b\u3068\u601d\u3044\u307e\u3059\u3002\n\n\u305d\u3057\u3066\u3053\u3061\u3089\u306e\u3053\u30b3\u30fc\u30c9\u3092 \u30b9\u30af\u30ea\u30d7\u30c8\u30da\u30fc\u30b8\u306b\u8cbc\u308a\u4ed8\u3051\u3066\u304f\u3060\u3055\u3044\u3002\n\n```java\n/*\nLICENSE\n\n   Copyright 2017 Tokyo Home Security Operation Center\n\n   Licensed under the Apache License, Version 2.0 (the \"License\");\n   you may not use this file except in compliance with the License.\n   You may obtain a copy of the License at\n\n       http://www.apache.org/licenses/LICENSE-2.0\n\n   Unless required by applicable law or agreed to in writing, software\n   distributed under the License is distributed on an \"AS IS\" BASIS,\n   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n   See the License for the specific language gover\n*/\n\n/*\n######### \u4e0b\u8a18\u306e\u5024\u3092 [\u30d5\u30a1\u30a4\u30eb] \u2192 [\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u306e\u30d7\u30ed\u30d1\u30c6\u30a3] \u2192 [\u30b9\u30af\u30ea\u30d7\u30c8\u306e\u30d7\u30ed\u30d1\u30c6\u30a3] \u306b\u8a2d\u5b9a\u3057\u3066\u304f\u3060\u3055\u3044\u3002  #########\n\nIDCF_API_KEY = \"IDCF\u30af\u30e9\u30a6\u30c9\u306eAPI\u30ad\u30fc\u3092\u3044\u308c\u3066\u304f\u3060\u3055\u3044\";\nIDCF_SECRET_KEY = \"IDCF\u30af\u30e9\u30a6\u30c9\u306eSECRET\u30ad\u30fc\u3092\u3044\u308c\u3066\u304f\u3060\u3055\u3044\";\nSPREADSHEET_ID = \"Google\u30b9\u30d7\u30ec\u30c3\u30c9\u30b7\u30fc\u30c8\u306eID\u3092\u3044\u308c\u3066\u304f\u3060\u3055\u3044\";\nSLACK_WEBHOOK_URL = \"Slack\u306eWebhook\u306eURL\u3092\u3044\u308c\u3066\u304f\u3060\u3055\u3044\";\n\n\n\u8aac\u660e\u7528URL: \n*/\n\nvar prop = PropertiesService.getScriptProperties().getProperties();\n\nfunction getThisMonth() {\n  var date = new Date();\n  return date.getFullYear() + \"-\" + (\"0\" + (date.getMonth()+1)).slice(-2);\n}\n\nfunction getToday() {\n  var date = new Date();\n  var this_month = date.getFullYear() + \"-\" + (\"0\" + (date.getMonth()+1)).slice(-2);\n  return this_month + \"-\" + (\"0\" + date.getDate()).slice(-2);\n}\n\n// Billing API\u3067\u5229\u7528\u660e\u7d30\u3092\u53d6\u5f97\nfunction getUsageData(month) {\n  var query_string = \"format=json\";\n  var expiration_seconds = 30;\n  \n  var date = new Date();\n  var endpoint_uri = \"/api/v1/billings/\" + month;\n  var expiration = (Math.floor(date.getTime()/1000) + expiration_seconds).toString();\n  var message =\"GET\" + \"\\n\" + endpoint_uri + \"\\n\" + prop.IDCF_API_KEY + \"\\n\" + expiration + \"\\n\" + query_string;\n  var signature = Utilities.base64Encode((Utilities.computeHmacSha256Signature(message, prop.IDCF_SECRET_KEY)));  \n  var url = \"https://your.idcfcloud.com\" + endpoint_uri + \"?\" + query_string;\n  var params = {\n    \"headers\": {\n      \"X-IDCF-APIKEY\": prop.IDCF_API_KEY,\n      \"X-IDCF-Expires\": expiration,\n      \"X-IDCF-Signature\": signature\n    }\n  }\n  return JSON.parse(UrlFetchApp.fetch(url, params).getContentText())[\"data\"];\n}\n\n// \u5229\u7528\u660e\u7d30\u306b\u672c\u65e5\u306e\u65e5\u4ed8\u3092\u8868\u3059Date\u5217\u3092\u4ed8\u52a0\u3057\u3066Google\u30b9\u30d7\u30ec\u30c3\u30c9\u30b7\u30fc\u30c8\u306b\u66f8\u304d\u8fbc\u3080\nfunction sendUsageDataToSpreadsheet(ss, sheet, data) {\n  var this_month = getThisMonth();\n  var today = getToday();\n  var keys = [\n    \"Region\",\n    \"ServiceName\",\n    \"ZoneName\",\n    \"Category\",\n    \"Menu\",\n    \"ResourceDisplayName\",\n    \"StartDate\",\n    \"EndDate\",\n    \"Usage\",\n    \"Allocated\",\n    \"Running\",\n    \"Stopped\",\n    \"Amount\",\n    \"Tax\",\n    \"Net\"\n  ];\n  if (!sheet) {\n    sheet = ss.insertSheet(this_month, 0);\n  }\n  if (sheet.getLastRow() == 0) {\n    sheet.appendRow([\"Date\"].concat(keys));\n  }\n  data.forEach(function(resource) {\n    var values = [today].concat(keys.map(function(key) { return resource[key]; }));\n    sheet.appendRow(values);\n  });\n}\n\n\n\n// Slack\u306b\u73fe\u5728\u306e\u8acb\u6c42\u984d\u3092\u6295\u7a3f\u3059\u308b\nfunction postTotalAmountToSlack(webhook_url, data) {\n  var total_amount = 0; \n  \n  var jp_east_amount = 0;\n  var jp_east_vm = 0;\n  var jp_east_volume = 0;\n  var jp_east_archived_data = 0;\n  var jp_east_datatransfer_in = 0;\n  var jp_east_datatransfer_out = 0;\n  var jp_east_object_storage_traffic = 0;\n  var jp_east_object_storage_storage = 0;\n  \n  var jp_west_amount = 0;\n  var jp_west_vm = 0;\n  var jp_west_volume = 0;\n  var jp_east_archived_data = 0;\n  var jp_west_datatransfer_in = 0;\n  var jp_west_datatransfer_out = 0;\n\n    data.forEach(function(resource) {\n    switch(resource[\"Region\"]){\n      case \"jp-east\":\n        jp_east_amount += resource[\"Amount\"];\n        switch(resource[\"ServiceName\"]){\n          case \"Cloud Computing\":\n            switch(resource[\"Category\"]){\n              case \"VirtualMachine\":\n                jp_east_vm += resource[\"Amount\"];\n                break;\n                \n              case \"Volume\":\n                jp_east_volume += resource[\"Amount\"];\n                break;\n                \n              case \"Internet Data Transfer\":\n                switch(resource[\"Menu\"]){\n                  case \"Internet Data Transfer [in]\":\n                    jp_east_datatransfer_in += resource[\"Usage\"];\n                    break;\n                  case \"Internet Data Transfer [out]\":\n                    jp_east_datatransfer_out += resource[\"Usage\"];\n                    break;\n                }\n                break;\n            }\n            break;\n          case \"Archived Data\":\n            switch(resource[\"Menu\"]){\n              case \"Archive Storage - Template Data Usage\":\n                jp_east_object_storage_traffic += resource[\"Amount\"];\n                break;\n            }\n            break;\n          case \"Object Storage\":\n            switch(resource[\"Menu\"]){\n              case \"Object Storage - Traffic Usage\":\n                jp_east_object_storage_traffic += resource[\"Usage\"];\n                break;\n              case \"Object Storage - Storage Usage\":\n                jp_east_object_storage_storage += resource[\"Usage\"];\n                break;\n            }\n            break;\n        }\n        break;\n      case \"jp-east-2\":\n        jp_east_amount += resource[\"Amount\"];\n        switch(resource[\"ServiceName\"]){\n          case \"Cloud Computing\":\n            switch(resource[\"Category\"]){\n              case \"VirtualMachine\":\n                jp_east_vm += resource[\"Amount\"];\n                break;\n                \n              case \"Volume\":\n                jp_east_volume += resource[\"Amount\"];\n                break;\n                \n              case \"Internet Data Transfer\":\n                switch(resource[\"Menu\"]){\n                  case \"Internet Data Transfer [in]\":\n                    jp_east_datatransfer_in += resource[\"Usage\"];\n                    break;\n                  case \"Internet Data Transfer [out]\":\n                    jp_east_datatransfer_out += resource[\"Usage\"];\n                    break;\n                }\n                break;\n            }\n            break;\n          case \"Archived Data\":\n            switch(resource[\"Menu\"]){\n              case \"Archive Storage - Template Data Usage\":\n                jp_east_object_storage_traffic += resource[\"Usage\"];\n                break;\n            }\n            break;\n          case \"Object Storage\":\n            switch(resource[\"Menu\"]){\n              case \"Object Storage - Traffic Usage\":\n                jp_east_object_storage_traffic += resource[\"Usage\"];\n                break;\n              case \"Object Storage - Storage Usage\":\n                jp_east_object_storage_storage += resource[\"Usage\"];\n                break;\n            }\n            break;\n        }\n        break;\n      case \"jp_west\":\n        jp_west_amount += resource[\"Amount\"];\n        switch(resource[\"ServiceName\"]){\n          case \"Cloud Computing\":\n            switch(resource[\"Category\"]){\n              case \"VirtualMachine\":\n                jp_west_vm += resource[\"Amount\"];\n                break;\n                \n              case \"Volume\":\n                jp_west_volume += resource[\"Amount\"];\n                break;\n                \n              case \"Internet Data Transfer\":\n                switch(resource[\"Menu\"]){\n                  case \"Internet Data Transfer [in]\":\n                    jp_west_datatransfer_in += resource[\"Usage\"];\n                    break;\n                  case \"Internet Data Transfer [out]\":\n                    jp_west_datatransfer_out += resource[\"Usage\"];\n                    break;\n                }\n                break;\n            }\n            break;\n          case \"Archived Data\":\n            switch(resource[\"Menu\"]){\n              case \"Archive Storage - Template Data Usage\":\n                jp_west_object_storage_traffic += resource[\"Amount\"];\n                break;\n            }\n            break;\n          case \"Object Storage\":\n            switch(resource[\"Menu\"]){\n              case \"Object Storage - Traffic Usage\":\n                jp_west_object_storage_traffic += resource[\"Usage\"];\n                break;\n              case \"Object Storage - Storage Usage\":\n                jp_west_object_storage_storage += resource[\"Usage\"];\n                break;\n            }\n            break;\n        }\n        break;\n    }\n    });\n  \n  \n  \n  data.forEach(function(resource) {\n    total_amount += resource[\"Amount\"];\n  });\n  \n  \n  var message = {\n    \"attachments\": [\n      {\n        \"author_name\": \"\u5408\u8a08\",\n        \"color\": \"good\",\n        \"text\": \"\u4eca\u6708\u5206\u306e\u8acb\u6c42\u984d\u306f\u73fe\u5728\" + total_amount + \"\u5186\u3067\u3059\",\n        \"fields\": [\n        {\n        \"title\": \"\u6771\u65e5\u672c\u30ea\u30fc\u30b8\u30e7\u30f3\",\n        \"value\": jp_east_amount + \"\u5186\u3067\u3059\",\n        \"short\": true\n      },\n      {\n        \"title\": \"\u897f\u65e5\u672c\u30ea\u30fc\u30b8\u30e7\u30f3\",\n        \"value\": jp_west_amount + \"\u5186\u3067\u3059\",\n        \"short\": true\n      }\n    ]\n  },\n      {\n        \"author_name\": \"\u6771\u65e5\u672c\u30ea\u30fc\u30b8\u30e7\u30f3\",\n          \"color\": \"good\",\n            \"fields\": [\n              {\n                \"title\": \"\u4eee\u60f3\u30de\u30b7\u30f3\",\n                \"value\": jp_east_vm + \"\u5186\u3067\u3059\",\n                \"short\": false\n              },\n              {\n                \"title\": \"\u30dc\u30ea\u30e5\u30fc\u30e0(\u30eb\u30fc\u30c8\u30c7\u30a3\u30b9\u30af\u30fb\u30c7\u30fc\u30bf\u30c7\u30a3\u30b9\u30af)\",\n                \"value\": jp_east_volume + \"\u5186\u3067\u3059\",\n                \"short\": false\n              },\n              {\n                \"title\": \"\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u8ee2\u9001\",\n                \"value\": jp_east_datatransfer_in + jp_east_datatransfer_out + \"GB\u3067\u3059\",\n                \"short\": false\n              },\n              {\n                \"title\": \"\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u8ee2\u9001(IN)\",\n                \"value\": jp_east_datatransfer_in + \"GB\u3067\u3059\",\n                \"short\": true\n              },\n              {\n                \"title\": \"\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u8ee2\u9001(OUT)\",\n                \"value\": jp_east_datatransfer_out + \"GB\u3067\u3059\",\n                \"short\": true\n              },\n              {\n                \"title\": \"\u30a2\u30fc\u30ab\u30a4\u30d6\u30c7\u30fc\u30bf\",\n                \"value\": jp_east_datatransfer_out + \"GB\u3067\u3059\",\n                \"short\": false\n              },\n              {\n                \"title\": \"\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u30b9\u30c8\u30ec\u30fc\u30b8(Traffic)\",\n                \"value\": jp_east_object_storage_traffic + \"GB\u3067\u3059\",\n                \"short\": true\n              },\n              {\n                \"title\": \"\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u30b9\u30c8\u30ec\u30fc\u30b8(Storage)\",\n                \"value\": jp_east_object_storage_storage + \"GB\u3067\u3059\",\n                \"short\": true\n              }\n            ]\n      },\n        {\n          \"author_name\": \"\u897f\u65e5\u672c\u30ea\u30fc\u30b8\u30e7\u30f3\",\n            \"color\": \"good\",\n              \"fields\": [\n                {\n                  \"title\": \"\u4eee\u60f3\u30de\u30b7\u30f3\",\n                  \"value\": jp_west_vm + \"\u5186\u3067\u3059\",\n                  \"short\": false\n                },\n                {\n                  \"title\": \"\u30dc\u30ea\u30e5\u30fc\u30e0(\u30eb\u30fc\u30c8\u30c7\u30a3\u30b9\u30af\u30fb\u30c7\u30fc\u30bf\u30c7\u30a3\u30b9\u30af)\",\n                  \"value\": jp_west_volume + \"\u5186\u3067\u3059\",\n                  \"short\": false\n                },\n                {\n                  \"title\": \"\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u8ee2\u9001\",\n                  \"value\": jp_west_datatransfer_in + jp_west_datatransfer_out + \"GB\u3067\u3059\",\n                  \"short\": false\n                },\n                {\n                  \"title\": \"\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u8ee2\u9001(IN)\",\n                  \"value\": jp_west_datatransfer_in + \"GB\u3067\u3059\",\n                  \"short\": true\n                },\n                {\n                  \"title\": \"\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u8ee2\u9001(OUT)\",\n                  \"value\": jp_west_datatransfer_out + \"GB\u3067\u3059\",\n                  \"short\": true\n                },\n                {\n                \"title\": \"\u30a2\u30fc\u30ab\u30a4\u30d6\u30c7\u30fc\u30bf\",\n                \"value\": jp_west_datatransfer_out + \"GB\u3067\u3059\",\n                \"short\": false\n              },\n              ]\n        }\n  ]\n};\nvar params = {\n  \"method\": \"post\",\n  \"payload\": 'payload=' + JSON.stringify(message)\n};\nUrlFetchApp.fetch(prop.SLACK_WEBHOOK_URL, params)\n}\n\nfunction main() {\n  var this_month = getThisMonth();\n  var ss = SpreadsheetApp.openById(prop.SPREADSHEET_ID);\n  var sheet = ss.getSheetByName(this_month);\n  \n  var data = getUsageData(this_month);\n  sendUsageDataToSpreadsheet(ss, sheet, data);\n  postTotalAmountToSlack(prop.SLACK_WEBHOOK_URL, data);\n}\n```\n\n## Gogole AppsScript \u306bAPI\u30ad\u30fc\u306a\u3069\u3092\u767b\u9332\u3059\u308b\n\n[\u30d5\u30a1\u30a4\u30eb]\u2192[\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u30d7\u30ed\u30d1\u30c6\u30a3] \u3092\u958b\u304d\u307e\u3059\n![](https://qiita-image-store.s3.amazonaws.com/0/121099/4bb667df-8a48-e352-c7d6-9570455b94af.png)\n\n[\u30b9\u30af\u30ea\u30d7\u30c8\u306e\u30d7\u30ed\u30d1\u30c6\u30a3] \u3092\u958b\u3044\u3066\u4e0b\u8a18\u306e\u5024\u3092\u8a2d\u5b9a\u3057\u3066\u304f\u3060\u3055\u3044\n\u672c\u5bb6: [\u5229\u7528\u660e\u7d30\uff06\u30d3\u30ea\u30f3\u30b0API\u3067IDCF\u30af\u30e9\u30a6\u30c9\u306e\u5229\u7528\u72b6\u6cc1\u3092\u628a\u63e1\u3057\u3088\u3046 \\- IDCF Tech\\-Blog](http://blog.idcf.jp/entry/2016/08/31/154810) \u3067\u306f\u30b3\u30fc\u30c9\u306b\u76f4\u66f8\u304d\u3067\u3057\u305f\u306e\u3067\u4fee\u6b63\u3055\u305b\u3066\u9802\u304d\u307e\u3057\u305f\u3002\n\n```\nIDCF_API_KEY = \"IDCF\u30af\u30e9\u30a6\u30c9\u306eAPI\u30ad\u30fc\u3092\u3044\u308c\u3066\u304f\u3060\u3055\u3044\";\nIDCF_SECRET_KEY = \"IDCF\u30af\u30e9\u30a6\u30c9\u306eSECRET\u30ad\u30fc\u3092\u3044\u308c\u3066\u304f\u3060\u3055\u3044\";\nSPREADSHEET_ID = \"Google\u30b9\u30d7\u30ec\u30c3\u30c9\u30b7\u30fc\u30c8\u306eID\u3092\u3044\u308c\u3066\u304f\u3060\u3055\u3044\";\nSLACK_WEBHOOK_URL = \"Slack\u306eWebhook\u306eURL\u3092\u3044\u308c\u3066\u304f\u3060\u3055\u3044\";\n```\n![2017-02-16 (2).png](https://qiita-image-store.s3.amazonaws.com/0/121099/659e771e-7d28-4461-6dc4-82ac068f2155.png)\n\n\n\u5f8c\u306f\u624b\u9806\u901a\u308a\u3067\u7a3c\u50cd\u51fa\u6765\u308b\u3068\u601d\u3044\u307e\u3059\u3002\n\n\u901a\u77e5\u304c\u6765\u308b\u3068\u3053\u3093\u306a\u611f\u3058\u3067\u8868\u793a\u3055\u308c\u308b\u3088\u3046\u306b\u306a\u3063\u3066\u307e\u3059\u3002\n**IDCF Cloud \u306e\u9805\u76ee\u3054\u3068\u306b\u30d1\u30fc\u30b9\u3092\u639b\u3051\u3066\u308b\u306e\u3067\u79c1\u304c\u77e5\u3089\u306a\u3044\u9805\u76ee\u306f\u3055\u308c\u306a\u3044\u306e\u3067\u4f55\u304b\u6f0f\u308c\u306a\u3069\u3042\u308a\u307e\u3057\u305f\u3089\u30b3\u30e1\u30f3\u30c8\u306a\u3069\u3067\u304a\u77e5\u3089\u305b\u304f\u3060\u3055\u3044**\n![](https://qiita-image-store.s3.amazonaws.com/0/121099/73ae4bd8-32f7-e392-54e3-636c066ff550.png)\n\n\n\u826f\u3044 IDCF Cloud \u30e9\u30a4\u30d5\u3092!\uff01\n\n"}