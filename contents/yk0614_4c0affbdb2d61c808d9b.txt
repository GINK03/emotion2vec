{"tags": ["nginx", "userAgent", "\u30ac\u30e9\u30b1\u30fc"], "context": "\n\n\u6982\u8981\nNginx\u3067Sticky\u4f7f\u3063\u3066\u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b5\u306e\u3088\u3046\u306bWeb\u30b5\u30fc\u30d0\u3092\u5272\u308a\u632f\u3063\u305f\u969b\u3001cookie\u975e\u5bfe\u5fdc\u7aef\u672b\u304b\u3089\u30a2\u30af\u30bb\u30b9\u3055\u308c\u305f\u5834\u5408\u306fSticky\u304c\u52b9\u304b\u306a\u3044\u306e\u3067\u3001\u30e6\u30fc\u30b6\u30fc\u30a8\u30fc\u30b8\u30a7\u30f3\u30c8\u3067cookie\u975e\u5bfe\u5fdc\u7aef\u672b\u304b\u5224\u5225\u3057\u3001cookie\u304c\u975e\u5bfe\u5fdc\u306a\u3089\u30b5\u30fc\u30d01\u53f0\u306b\u5272\u308a\u632f\u308b\u3088\u3046\u306b\u8a2d\u5b9a\u3057\u305f\u969b\u306e\u30e1\u30e2\u3067\u3059\u3002\n\n\u5404\u30ad\u30e3\u30ea\u30a2\u306eCookie\u4ed5\u69d8\u3068userAgent\n\n\u30c9\u30b3\u30e2\ni-mode 1.0\u7aef\u672b\u3067\u306fCookie\u975e\u5bfe\u5fdc\n(\u4f8b) \nDoCoMo/1.0\ni-mode 2.x\u7aef\u672b\u304b\u3064\u30ad\u30e3\u30c3\u30b7\u30e5\u30b5\u30a4\u30ba\u3092\u793a\u3059 c\u6570\u5b57 \u306e\u6570\u5b57\u90e8\u5206\u304c 500 \u4ee5\u4e0a \u306b\u306a\u3063\u3066\u3044\u308b\u3082\u306e\u306fCookie\u306b\u5bfe\u5fdc\n(\u4f8b)\nCookie\u5bfe\u5fdc\nDoCoMo/2.0 N03D(c500;TB;W24H16)\nCookie\u975e\u5bfe\u5fdc\nDoCoMo/2.0 F01G(c100;TC;W20H09)\n\nau\n\u5168\u6a5f\u7a2e\u5bfe\u5fdc\n(\u4f8b)\nKDDI-HI21 UP.Browser/6.0.2.254 (GUI) MMP/1.1\n\n\u30bd\u30d5\u30c8\u30d0\u30f3\u30af\nW\u578b\u30013GC\u578b\u6a5f\u7a2e\u306e\u307fCookie\u5bfe\u5fdc\n\u25b2\u25b2\u25b2\u25b2\u306b\u306f\u643a\u5e2f\u306e\u88fd\u9020\u756a\u53f7\uff08P\u578b\u306e\u307f\u3002\u30e6\u30fc\u30b6\u304c\u30e6\u30fc\u30b6ID\u901a\u77e5\u306e\u9001\u51fa\u3092\u8a31\u53ef\u3057\u305f\u5834\u5408\uff09\u3001\u25cf\u25cf\u25cf\u25cf\u306e\u90e8\u5206\u306f\u30e1\u30fc\u30ab\u30fc\u306e\u4efb\u610f\u306e\u6587\u5b57\n(\u4f8b)\nCookie\u975e\u5bfe\u5fdc\nC\u578b\nJ-PHONE/1.x \uff5e \nJ-PHONE/2.0/J-DN02\nJ-PHONE/3.0/J-PE03 \nP\u578b \nJ-PHONE/4.0/J-SH51[/\u25b2\u25b2\u25b2\u25b2] SH/\u25cf\u25cf\u25cf\u25cf Profile/MIDP-1.0 Configuration/CLDC-1.0 Ext-Profile/JSCL-1.1.0\nCookie\u5bfe\u5fdc\nW\u578b \nJ-PHONE/5.0/V801SA[/\u25b2\u25b2\u25b2\u25b2] SA/\u25cf\u25cf\u25cf\u25cf Profile/MIDP-1.0 Configuration/CLDC-1.0 Ext-Profile/JSCL-1.1.0\n3gc\u578b\nVodafone/1.x \uff5e \nSoftBank/1.x \uff5e\n\nNginx /etc/nginx/nginx.conf\u306e\u8a2d\u5b9a\nCookie\u975e\u5bfe\u5fdc\u7aef\u672b\u306euserAgent\u3092\u6b63\u898f\u8868\u73fe\u3067\u307e\u3068\u3081\u3001/etc/nginx/nginx.conf\u3092\u4e0b\u8a18\u306e\u3088\u3046\u306b\u8a18\u8f09\u3057\u8a2d\u5b9a\n\u203buserAgent\u3067\u632f\u308a\u5206\u3051\u3057\u3066\u3044\u308b\u90e8\u5206\u306e\u307f\u629c\u7c8b\n\n/etc/nginx/nginx.conf\n# Cookie\u975e\u5bfe\u5fdc\u30e6\u30fc\u30b6\u30fc\u30a8\u30fc\u30b8\u30a7\u30f3\u30c8\n    if ($http_user_agent ~* 'DoCoMo/1\\.0') {\n            set $ua '@fp';\n        }\n    if ($http_user_agent ~* 'J-PHONE/[1-4]'){\n            set $ua '@fp';\n        }\n    if ($http_user_agent ~* 'DoCoMo/2\\.0.+\\(c[1-4]'){\n            set $ua '@fp';\n        }\n\n    location / {\n        if ($ua = '@fp') {\n             proxy_pass http://webservergroup-fp;\n        }\n    }\n\u3000\u3000upstream webservergroup-fp {\n      \u3000server IP\u30a2\u30c9\u30ec\u30b9:\u30dd\u30fc\u30c8\u756a\u53f7;\n\u3000\u3000}\n\n\n\n\n\u88dc\u8db3\nnginx\u3067if\u30d6\u30ed\u30c3\u30af\u306e\u4e2d\u306bif\u6587\u306f\u66f8\u3051\u307e\u305b\u3093\u3002\n\u4e0b\u8a18\u306e\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3057\u307e\u3059\u3002\nStarting nginx: nginx: [emerg] \"if\" directive is not allowed here in /etc/nginx/lb.conf\n\n\n\u53c2\u8003\u6587\u732e\nhttp://www.kumoyanet.com/1773/\nhttp://mgng.mugbum.info/265\nhttp://bellks-tec.cocolog-nifty.com/blog/2006/07/jphone_vodafone_2c9a.html\nhttp://ueblog.natural-wave.com/2008/04/20/mobile-id/\nhttp://d.hatena.ne.jp/hirafoo/20120110/1326198877\n# \u6982\u8981\nNginx\u3067Sticky\u4f7f\u3063\u3066\u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b5\u306e\u3088\u3046\u306bWeb\u30b5\u30fc\u30d0\u3092\u5272\u308a\u632f\u3063\u305f\u969b\u3001cookie\u975e\u5bfe\u5fdc\u7aef\u672b\u304b\u3089\u30a2\u30af\u30bb\u30b9\u3055\u308c\u305f\u5834\u5408\u306fSticky\u304c\u52b9\u304b\u306a\u3044\u306e\u3067\u3001\u30e6\u30fc\u30b6\u30fc\u30a8\u30fc\u30b8\u30a7\u30f3\u30c8\u3067cookie\u975e\u5bfe\u5fdc\u7aef\u672b\u304b\u5224\u5225\u3057\u3001cookie\u304c\u975e\u5bfe\u5fdc\u306a\u3089\u30b5\u30fc\u30d01\u53f0\u306b\u5272\u308a\u632f\u308b\u3088\u3046\u306b\u8a2d\u5b9a\u3057\u305f\u969b\u306e\u30e1\u30e2\u3067\u3059\u3002\n\n\n\n# \u5404\u30ad\u30e3\u30ea\u30a2\u306eCookie\u4ed5\u69d8\u3068userAgent\n## \u30c9\u30b3\u30e2\ni-mode 1.0\u7aef\u672b\u3067\u306fCookie\u975e\u5bfe\u5fdc\n(\u4f8b) \n<b>DoCoMo/1.0\n\ni-mode 2.x\u7aef\u672b\u304b\u3064\u30ad\u30e3\u30c3\u30b7\u30e5\u30b5\u30a4\u30ba\u3092\u793a\u3059 c\u6570\u5b57 \u306e\u6570\u5b57\u90e8\u5206\u304c 500 \u4ee5\u4e0a \u306b\u306a\u3063\u3066\u3044\u308b\u3082\u306e\u306fCookie\u306b\u5bfe\u5fdc\n(\u4f8b)\nCookie\u5bfe\u5fdc\n<b>DoCoMo/2.0 N03D(c500;TB;W24H16)\n\nCookie\u975e\u5bfe\u5fdc\n<b>DoCoMo/2.0 F01G(c100;TC;W20H09)\n\n## au\n\u5168\u6a5f\u7a2e\u5bfe\u5fdc\n(\u4f8b)\n<b>KDDI-HI21 UP.Browser/6.0.2.254 (GUI) MMP/1.1\n\n## \u30bd\u30d5\u30c8\u30d0\u30f3\u30af\nW\u578b\u30013GC\u578b\u6a5f\u7a2e\u306e\u307fCookie\u5bfe\u5fdc\n\u25b2\u25b2\u25b2\u25b2\u306b\u306f\u643a\u5e2f\u306e\u88fd\u9020\u756a\u53f7\uff08P\u578b\u306e\u307f\u3002\u30e6\u30fc\u30b6\u304c\u30e6\u30fc\u30b6ID\u901a\u77e5\u306e\u9001\u51fa\u3092\u8a31\u53ef\u3057\u305f\u5834\u5408\uff09\u3001\u25cf\u25cf\u25cf\u25cf\u306e\u90e8\u5206\u306f\u30e1\u30fc\u30ab\u30fc\u306e\u4efb\u610f\u306e\u6587\u5b57\n\n(\u4f8b)\nCookie\u975e\u5bfe\u5fdc\nC\u578b\n<b>J-PHONE/1.x \uff5e \nJ-PHONE/2.0/J-DN02\nJ-PHONE/3.0/J-PE03 \n\nP\u578b \n<b>J-PHONE/4.0/J-SH51[/\u25b2\u25b2\u25b2\u25b2] SH/\u25cf\u25cf\u25cf\u25cf Profile/MIDP-1.0 Configuration/CLDC-1.0 Ext-Profile/JSCL-1.1.0\n\nCookie\u5bfe\u5fdc\nW\u578b \n<b>J-PHONE/5.0/V801SA[/\u25b2\u25b2\u25b2\u25b2] SA/\u25cf\u25cf\u25cf\u25cf Profile/MIDP-1.0 Configuration/CLDC-1.0 Ext-Profile/JSCL-1.1.0\n\n3gc\u578b\n<b>Vodafone/1.x \uff5e \nSoftBank/1.x \uff5e\n\n# Nginx /etc/nginx/nginx.conf\u306e\u8a2d\u5b9a\nCookie\u975e\u5bfe\u5fdc\u7aef\u672b\u306euserAgent\u3092\u6b63\u898f\u8868\u73fe\u3067\u307e\u3068\u3081\u3001/etc/nginx/nginx.conf\u3092\u4e0b\u8a18\u306e\u3088\u3046\u306b\u8a18\u8f09\u3057\u8a2d\u5b9a\n\u203buserAgent\u3067\u632f\u308a\u5206\u3051\u3057\u3066\u3044\u308b\u90e8\u5206\u306e\u307f\u629c\u7c8b\n\n```/etc/nginx/nginx.conf\n# Cookie\u975e\u5bfe\u5fdc\u30e6\u30fc\u30b6\u30fc\u30a8\u30fc\u30b8\u30a7\u30f3\u30c8\n    if ($http_user_agent ~* 'DoCoMo/1\\.0') {\n            set $ua '@fp';\n        }\n    if ($http_user_agent ~* 'J-PHONE/[1-4]'){\n            set $ua '@fp';\n        }\n    if ($http_user_agent ~* 'DoCoMo/2\\.0.+\\(c[1-4]'){\n            set $ua '@fp';\n        }\n\n    location / {\n        if ($ua = '@fp') {\n             proxy_pass http://webservergroup-fp;\n        }\n    }\n\u3000\u3000upstream webservergroup-fp {\n      \u3000server IP\u30a2\u30c9\u30ec\u30b9:\u30dd\u30fc\u30c8\u756a\u53f7;\n\u3000\u3000}\n\n```\n\n### \u88dc\u8db3\nnginx\u3067if\u30d6\u30ed\u30c3\u30af\u306e\u4e2d\u306bif\u6587\u306f\u66f8\u3051\u307e\u305b\u3093\u3002\n\u4e0b\u8a18\u306e\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3057\u307e\u3059\u3002\n\n```\nStarting nginx: nginx: [emerg] \"if\" directive is not allowed here in /etc/nginx/lb.conf\n```\n\n\n\n\n\n\n\n\n\n# \u53c2\u8003\u6587\u732e\nhttp://www.kumoyanet.com/1773/\nhttp://mgng.mugbum.info/265\nhttp://bellks-tec.cocolog-nifty.com/blog/2006/07/jphone_vodafone_2c9a.html\nhttp://ueblog.natural-wave.com/2008/04/20/mobile-id/\nhttp://d.hatena.ne.jp/hirafoo/20120110/1326198877\n"}