{"context": " More than 1 year has passed since last update.\n\nFlask + Gunicorn + Nginx + Supervisor \u3061\u3083\u3093\u3068\u52d5\u304f\u307e\u3067\n\n\u53c2\u8003:\nnginx/gunicorn/supervisor\u3067flask\u30a2\u30d7\u30ea\u3092\u52d5\u304b\u3059 | \u304b\u306d\u3057\u308d\u3050\nhttp://blog.shun-ichiro.com/howto/nginx-gunicorn-supervisor-flask/\n\n\nInformation\n\nwww\u30c7\u30a3\u30ec\u30af\u30c8\u30ea: /var/www\n\nFlask\u30a2\u30d7\u30ea\u30c7\u30a3\u30ec\u30af\u30c8\u30ea: /var/www/apps/\n\n\u4eca\u56de\u4f7f\u3046\u30b9\u30af\u30ea\u30d7\u30c8\u304c\u3042\u308b\u30c7\u30a3\u30ec\u30af\u30c8\u30ea: /var/www/apps/sampleapp/\n\n\n\nFlask\n\u30d9\u30fc\u30b9\u306b\u306a\u308b\u30b9\u30af\u30ea\u30d7\u30c8: /var/www/apps/sampleapp/sample.py\n\nsample.py\n#!/usr/bin/env python\n#coding: utf-8\n\nfrom flask import Flask\n\napp = Flask(\"sample\")\n\n@app.route(\"/sample\") #\u30c8\u30c3\u30d7\u30c7\u30a3\u30ec\u30af\u30c8\u30ea / \u306f\u5225\u306b\u4f7f\u3046\u305f\u3081\ndef index():\n\n    return \"<h1>Hello World</h1>\"\n\nif __name__ == \"__main__\":\n\n    app.run(host=\"0.0.0.0\",debug=True)\n\n\n\nGunicorn\n\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb: /var/www/apps/sampleapp/guniconf.py\n\nguniconf.py\nimport multiprocessing\n\n# Server Socket\nbind = 'unix:/tmp/gunicorn_my_app.sock'\nbacklog = 2048\n\n# Worker Processes\nworkers = multiprocessing.cpu_count() * 2 + 1\nworker_class = 'sync'\nworker_connections = 1000\nmax_requests = 0\ntimeout = 30\nkeepalive = 2\ndebug = False\nspew = False\n\n# Logging\nlogfile = '/var/www/apps/sampleapp/app.log'\nloglevel = 'info'\nlogconfig = None\n\n# Process Name\nproc_name = 'gunicorn_my_app'\n\n\n\u4e00\u56de\u8d77\u52d5\u3057\u3066\u307f\u308b\n$ cd /var/www/apps/sampleapp/\n$ gunicorn sample:app --config guniconf.py\n\n\nNginx\n\u30c7\u30d5\u30a9\u30eb\u30c8\u306e\u8a2d\u5b9a: /etc/nginx/sites-enabled/000-default.conf\nserver {\n  listen 80 default_server;\n\n  root /var/www;\n  index index.php index.html index.htm;\n\n  location / {\n          try_files $uri $uri/ /index.php?q=$uri&$args;\n          autoindex on;\n  }\n\n  error_page 404 /404.html;\n\n  error_page 500 502 503 504 /50x.html;\n  location = /50x.html {\n          root /usr/share/nginx/html;\n  }\n\n  location ~ \\.php$ {\n          try_files $uri =404;\n          fastcgi_split_path_info ^(.+\\.php)(/.+)$;\n          fastcgi_pass unix:/var/run/php5-fpm.sock;\n          fastcgi_index index.php;\n          include fastcgi_params;\n          fastcgi_param  SCRIPT_FILENAME    $document_root$fastcgi_script_name;\n  }\n}\n\n\u3053\u306e\u30d5\u30a1\u30a4\u30eb\u306b\u4ee5\u4e0b\u306e\u60c5\u5831\u3092\u8ffd\u52a0\n+ upstream my_app_server{\n+     #server unix:/tmp/gunicorn_my_app.sock fail_timeout=0;\n+     server unix:/tmp/gunicorn_my_app.sock;\n+ }\n\nserver {\n  listen 80 default_server;\n\n  root /var/www;\n  index index.php index.html index.htm;\n\n  location / {\n          try_files $uri $uri/ /index.php?q=$uri&$args;\n          autoindex on;\n  }\n\n  error_page 404 /404.html;\n\n  error_page 500 502 503 504 /50x.html;\n  location = /50x.html {\n          root /usr/share/nginx/html;\n  }\n\n  location ~ \\.php$ {\n          try_files $uri =404;\n          fastcgi_split_path_info ^(.+\\.php)(/.+)$;\n          fastcgi_pass unix:/var/run/php5-fpm.sock;\n          fastcgi_index index.php;\n          include fastcgi_params;\n          fastcgi_param  SCRIPT_FILENAME    $document_root$fastcgi_script_name;\n  }\n\n  + location /sample { \n  +         try_files $uri @my_app;\n  + }\n  + \n  + location @my_app {\n  + \n  +         proxy_set_header Host $host;\n  +         proxy_set_header X-Real-IP $remote_addr;\n  +         proxy_redirect off;\n  +     \n  +         proxy_pass http://my_app_server;\n  + }\n\n}\n\n\u4e00\u56de\u518d\u8d77\u52d5\n$ sudo service nginx restart\n\n\u518d\u8d77\u52d5\u3057\u3066Gunicorn\u8d77\u52d5\u3057\u305f\u3089\u3061\u3083\u3093\u3068\u30a2\u30af\u30bb\u30b9\u3067\u304d\u308b\u304b\u78ba\u8a8d\u3059\u308b\u3002\n\nSupervisor\nSupervisor\u306f \u30d7\u30ed\u30bb\u30b9\u3092\u30c7\u30fc\u30e2\u30f3\u5316 \u3059\u308b\u3082\u306e\u3002\n\u305d\u308c\u305e\u308c\u306e\u30c7\u30a3\u30b9\u30c8\u30ea\u30d3\u30e5\u30fc\u30b7\u30e7\u30f3\u7b49\u306e\u30d1\u30c3\u30b1\u30fc\u30b8\u30de\u30cd\u30fc\u30b8\u30e3\u3067\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u3002\n\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb: /etc/supervisor/conf.d/my_app.conf\n[program:my_app]\ncommand = /home/***/.pyenv/shims/gunicorn sample:app --config /var/www/apps/sampleapp/guniconf.py\ndirectory = /var/www/apps/sampleapp/\nuser = root \n\ngunicorn\u306e\u30b3\u30de\u30f3\u30c9\u306f \u7d76\u5bfe\u30d1\u30b9 \u3067\u66f8\u304f\u3002\u5404\u3005\u66f8\u304d\u63db\u3048\u3066\u4e0b\u3055\u3044\n\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092supervisor\u306b\u8aad\u307f\u8fbc\u307e\u305b\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n$ supervisorctl reread\n$ supervisorctl update\n$ supervisorctl start my_app\n\n\u3053\u308c\u3067\u4e00\u5fdc\u52d5\u304f\u306f\u305a\uff01\uff01\n# Flask + Gunicorn + Nginx + Supervisor \u3061\u3083\u3093\u3068\u52d5\u304f\u307e\u3067\n\n>\u53c2\u8003:\n> nginx/gunicorn/supervisor\u3067flask\u30a2\u30d7\u30ea\u3092\u52d5\u304b\u3059 | \u304b\u306d\u3057\u308d\u3050\n>http://blog.shun-ichiro.com/howto/nginx-gunicorn-supervisor-flask/\n\n## Information\n\n+ www\u30c7\u30a3\u30ec\u30af\u30c8\u30ea: `/var/www`\n+ Flask\u30a2\u30d7\u30ea\u30c7\u30a3\u30ec\u30af\u30c8\u30ea: `/var/www/apps/`\n+ \u4eca\u56de\u4f7f\u3046\u30b9\u30af\u30ea\u30d7\u30c8\u304c\u3042\u308b\u30c7\u30a3\u30ec\u30af\u30c8\u30ea: `/var/www/apps/sampleapp/`\n\n\n## Flask\n\n\u30d9\u30fc\u30b9\u306b\u306a\u308b\u30b9\u30af\u30ea\u30d7\u30c8: `/var/www/apps/sampleapp/sample.py`\n\n```python:sample.py\n#!/usr/bin/env python\n#coding: utf-8\n\nfrom flask import Flask\n\napp = Flask(\"sample\")\n\n@app.route(\"/sample\") #\u30c8\u30c3\u30d7\u30c7\u30a3\u30ec\u30af\u30c8\u30ea / \u306f\u5225\u306b\u4f7f\u3046\u305f\u3081\ndef index():\n\n    return \"<h1>Hello World</h1>\"\n\nif __name__ == \"__main__\":\n\n    app.run(host=\"0.0.0.0\",debug=True)\n```\n\n## Gunicorn\n\n\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb: `/var/www/apps/sampleapp/guniconf.py`\n\n```python:guniconf.py\nimport multiprocessing\n\n# Server Socket\nbind = 'unix:/tmp/gunicorn_my_app.sock'\nbacklog = 2048\n\n# Worker Processes\nworkers = multiprocessing.cpu_count() * 2 + 1\nworker_class = 'sync'\nworker_connections = 1000\nmax_requests = 0\ntimeout = 30\nkeepalive = 2\ndebug = False\nspew = False\n\n# Logging\nlogfile = '/var/www/apps/sampleapp/app.log'\nloglevel = 'info'\nlogconfig = None\n\n# Process Name\nproc_name = 'gunicorn_my_app'\n```\n\n\u4e00\u56de\u8d77\u52d5\u3057\u3066\u307f\u308b\n\n```\n$ cd /var/www/apps/sampleapp/\n$ gunicorn sample:app --config guniconf.py\n```\n\n\n## Nginx\n\n\u30c7\u30d5\u30a9\u30eb\u30c8\u306e\u8a2d\u5b9a: `/etc/nginx/sites-enabled/000-default.conf `\n\n```\nserver {\n  listen 80 default_server;\n\n  root /var/www;\n  index index.php index.html index.htm;\n\n  location / {\n          try_files $uri $uri/ /index.php?q=$uri&$args;\n          autoindex on;\n  }\n\n  error_page 404 /404.html;\n\n  error_page 500 502 503 504 /50x.html;\n  location = /50x.html {\n          root /usr/share/nginx/html;\n  }\n\n  location ~ \\.php$ {\n          try_files $uri =404;\n          fastcgi_split_path_info ^(.+\\.php)(/.+)$;\n          fastcgi_pass unix:/var/run/php5-fpm.sock;\n          fastcgi_index index.php;\n          include fastcgi_params;\n          fastcgi_param  SCRIPT_FILENAME    $document_root$fastcgi_script_name;\n  }\n}\n```\n\n\u3053\u306e\u30d5\u30a1\u30a4\u30eb\u306b\u4ee5\u4e0b\u306e\u60c5\u5831\u3092\u8ffd\u52a0\n\n```\n+ upstream my_app_server{\n+     #server unix:/tmp/gunicorn_my_app.sock fail_timeout=0;\n+     server unix:/tmp/gunicorn_my_app.sock;\n+ }\n\nserver {\n  listen 80 default_server;\n\n  root /var/www;\n  index index.php index.html index.htm;\n\n  location / {\n          try_files $uri $uri/ /index.php?q=$uri&$args;\n          autoindex on;\n  }\n\n  error_page 404 /404.html;\n\n  error_page 500 502 503 504 /50x.html;\n  location = /50x.html {\n          root /usr/share/nginx/html;\n  }\n\n  location ~ \\.php$ {\n          try_files $uri =404;\n          fastcgi_split_path_info ^(.+\\.php)(/.+)$;\n          fastcgi_pass unix:/var/run/php5-fpm.sock;\n          fastcgi_index index.php;\n          include fastcgi_params;\n          fastcgi_param  SCRIPT_FILENAME    $document_root$fastcgi_script_name;\n  }\n\n  + location /sample { \n  +         try_files $uri @my_app;\n  + }\n  + \n  + location @my_app {\n  + \n  +         proxy_set_header Host $host;\n  +         proxy_set_header X-Real-IP $remote_addr;\n  +         proxy_redirect off;\n  +     \n  +         proxy_pass http://my_app_server;\n  + }\n\n}\n```\n\n\u4e00\u56de\u518d\u8d77\u52d5\n\n```\n$ sudo service nginx restart\n```\n\n\u518d\u8d77\u52d5\u3057\u3066Gunicorn\u8d77\u52d5\u3057\u305f\u3089\u3061\u3083\u3093\u3068\u30a2\u30af\u30bb\u30b9\u3067\u304d\u308b\u304b\u78ba\u8a8d\u3059\u308b\u3002\n\n## Supervisor\n\nSupervisor\u306f **\u30d7\u30ed\u30bb\u30b9\u3092\u30c7\u30fc\u30e2\u30f3\u5316** \u3059\u308b\u3082\u306e\u3002\n\u305d\u308c\u305e\u308c\u306e\u30c7\u30a3\u30b9\u30c8\u30ea\u30d3\u30e5\u30fc\u30b7\u30e7\u30f3\u7b49\u306e\u30d1\u30c3\u30b1\u30fc\u30b8\u30de\u30cd\u30fc\u30b8\u30e3\u3067\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u3002\n\n\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb: `/etc/supervisor/conf.d/my_app.conf`\n\n```\n[program:my_app]\ncommand = /home/***/.pyenv/shims/gunicorn sample:app --config /var/www/apps/sampleapp/guniconf.py\ndirectory = /var/www/apps/sampleapp/\nuser = root \n```\n\ngunicorn\u306e\u30b3\u30de\u30f3\u30c9\u306f **\u7d76\u5bfe\u30d1\u30b9** \u3067\u66f8\u304f\u3002\u5404\u3005\u66f8\u304d\u63db\u3048\u3066\u4e0b\u3055\u3044\n\n\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092`supervisor`\u306b\u8aad\u307f\u8fbc\u307e\u305b\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\n```\n$ supervisorctl reread\n$ supervisorctl update\n$ supervisorctl start my_app\n```\n\n\u3053\u308c\u3067\u4e00\u5fdc\u52d5\u304f\u306f\u305a\uff01\uff01\n", "tags": ["Flask", "gunicorn", "nginx", "supervisor", "Python"]}