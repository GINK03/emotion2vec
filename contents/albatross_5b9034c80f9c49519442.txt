{"context": " More than 1 year has passed since last update.CentOS 6.5 + ModSecurity 2.8.0 + Nginx 1.6.0 \u3067\u30c6\u30b9\u30c8\nModSecurity \u3068 Nginx \u3092\u30b3\u30f3\u30d1\u30a4\u30eb\u3057\u3066\u52d5\u304b\u3057\u305f\u3089 audit log \u306b\u5999\u306a\u30e1\u30c3\u30bb\u30fc\u30b8\u304c\u3002\nMessage: Audit log: Failed to lock global mutex: Permission denied\n\nstrace \u3059\u308b\u3068 semop(2) \u3067\u5931\u6557\u3057\u3066\u3044\u308b\u3053\u3068\u304c\u5206\u304b\u308b\u3002\n3770  17:40:24.018266 semop(655372, {{0, -1, SEM_UNDO}}, 1) = -1 EACCES (Permission denied)\n\nipcs \u30b3\u30de\u30f3\u30c9\u3067\u78ba\u8a8d\u3059\u308b\u3068 owner \u304c\u304a\u304b\u3057\u3044\u3002\n------ Semaphore Arrays --------\nkey        semid      owner      perms      nsems\n0x00000000 0          root       600        1\n0x00000000 32769      root       600        1\n0x00000000 131074     4294967295 600        1\n0x00000000 163843     4294967295 600        1\n0x00000000 458756     4294967295 600        1\n0x00000000 491525     4294967295 600        1\n0x00000000 262150     4294967295 600        1\n0x00000000 294919     4294967295 600        1\n0x00000000 393224     4294967295 600        1\n0x00000000 425993     4294967295 600        1\n0x00000000 524298     4294967295 600        1\n0x00000000 557067     4294967295 600        1\n0x00000000 655372     4294967295 600        1\n0x00000000 688141     4294967295 600        1\n\nNginx \u3092 root \u3067\u52d5\u304b\u305b\u3070\u89e3\u6c7a\u3059\u308b\u3060\u308d\u3046\u304c\u3001\u305d\u308c\u306f\u907f\u3051\u305f\u3044\n\u30bd\u30fc\u30b9\u3092 grep \u3057\u3066\u63a2\u3057\u3066\u3044\u304f\u3068\u3001DEFAULT_USER \u306a\u308b\u3082\u306e\u304c\u898b\u3064\u304b\u308b\n[host]$ grep -r semctl *\nstandalone/server.c:            if (semctl(ospmutex.crossproc, 0, IPC_SET, ick) < 0) {\nstandalone/server.c:            if (semctl(ospmutex.crossproc, 0, IPC_SET, ick) < 0) {\n\n\nstandalone/server.c\n#if AP_SERVER_MAJORVERSION_NUMBER > 1 && AP_SERVER_MINORVERSION_NUMBER < 3\n    unixd_config.user_name = DEFAULT_USER;\n    unixd_config.user_id = ap_uname2id(DEFAULT_USER);\n    unixd_config.group_id = ap_gname2id(DEFAULT_GROUP);\n    unixd_config.suexec_enabled = 0;\n#else\n    ap_unixd_config.user_name = DEFAULT_USER;\n    ap_unixd_config.user_id = ap_uname2id(DEFAULT_USER);\n    ap_unixd_config.group_id = ap_gname2id(DEFAULT_GROUP);\n    ap_unixd_config.suexec_enabled = 0;\n#endif\n\n\n\nstandalone/server.c\n            apr_os_proc_mutex_get(&ospmutex, pmutex);\n            buf.sem_perm.uid = unixd_config.user_id;\n            buf.sem_perm.gid = unixd_config.group_id;\n            buf.sem_perm.mode = 0600;\n            ick.buf = &buf;\n            if (semctl(ospmutex.crossproc, 0, IPC_SET, ick) < 0) {\n                return errno;\n            }\n\n\nDEFAULT_USER \u3092\u63a2\u3059\n[host]$ grep -r DEFAULT_USER /usr/include/httpd/*\n/usr/include/httpd/unixd.h:#ifndef DEFAULT_USER\n/usr/include/httpd/unixd.h:#define DEFAULT_USER \"#-1\"\n\n\n/usr/include/httpd/unixd.h\n#ifndef DEFAULT_USER\n#define DEFAULT_USER \"#-1\"\n#endif\n#ifndef DEFAULT_GROUP\n#define DEFAULT_GROUP \"#-1\"\n#endif\n\n\nDEFAULT_USER \u306a\u3069\u3092\u5b9a\u7fa9\u3057\u3066\u3084\u308c\u3070\u3044\u3044\u306e\u3067\u3001ModSecurity \u304b\u3089\u30b3\u30f3\u30d1\u30a4\u30eb\u3057\u76f4\u3059\u3002\u4ee5\u4e0b\u306f\u4e00\u4f8b\u3067\u3001\u30aa\u30d7\u30b7\u30e7\u30f3\u306f\u5404\u74b0\u5883\u3067\u9069\u5207\u306b\u8a2d\u5b9a\u3059\u308b\u3002\n[host]# CFLAGS=\"-DDEFAULT_USER=\\\\\\\"nginx\\\\\\\" -DDEFAULT_GROUP=\\\\\\\"nginx\\\\\\\"\" \\\nCPPFLAGS=\"-I/usr/include/apr-1 -I/usr/include/httpd\" \\\n./configure \\\n--disable-apache2-module \\\n--disable-mlogc \\\n--enable-standalone-module\n[host]# make\n[host]# make install\n\nNginx \u3082\u30b3\u30f3\u30d1\u30a4\u30eb\u3057\u76f4\u3059\u3002\u4ee5\u4e0b\u306f\u4e00\u4f8b\u3067\u3001\u30aa\u30d7\u30b7\u30e7\u30f3\u306f\u5404\u74b0\u5883\u3054\u3068\u306b\u9069\u5207\u306b\u8a2d\u5b9a\u3059\u308b\n[host]# ./configure \\\n--add-module=../modsecurity-2.8.0/nginx/modsecurity \\\n--user=nginx --group=nginx \\\n--without-mail_pop3_module \\\n--without-mail_imap_module \\\n--without-mail_smtp_module \\\n--with-cc-opt=\"-I/usr/include/apr-1 -I/usr/include/httpd\" \\\n--with-ld-opt=\"-lapr-1 -laprutil-1\"\n[host]# make\n[host]# make install\n\n\u4fee\u6b63\u5b8c\u4e86\u3002\n[host]# service nginx start\n[host]# ipcs -s\n\n------ Semaphore Arrays --------\nkey        semid      owner      perms      nsems\n0x00000000 0          root       600        1\n0x00000000 32769      root       600        1\n0x00000000 131074     nginx      600        1\n0x00000000 163843     nginx      600        1\n\n\u4fee\u6b63\u524d\u306f\u3084\u305f\u3089\u3068\u6570\u304c\u591a\u304b\u3063\u305f\u3057\u3001\n\u591a\u5206\u76f4\u3059\u307e\u3067\u306f\u30bb\u30de\u30d5\u30a9\u306e\u524a\u9664\u306b\u3082\u5931\u6557\u3057\u3066\u3044\u305f\u3068\u601d\u308f\u308c\u308b\u3002\nCentOS 6.5 + ModSecurity 2.8.0 + Nginx 1.6.0 \u3067\u30c6\u30b9\u30c8\nModSecurity \u3068 Nginx \u3092\u30b3\u30f3\u30d1\u30a4\u30eb\u3057\u3066\u52d5\u304b\u3057\u305f\u3089 audit log \u306b\u5999\u306a\u30e1\u30c3\u30bb\u30fc\u30b8\u304c\u3002\n\n```\nMessage: Audit log: Failed to lock global mutex: Permission denied\n```\n\nstrace \u3059\u308b\u3068 semop(2) \u3067\u5931\u6557\u3057\u3066\u3044\u308b\u3053\u3068\u304c\u5206\u304b\u308b\u3002\n\n```\n3770  17:40:24.018266 semop(655372, {{0, -1, SEM_UNDO}}, 1) = -1 EACCES (Permission denied)\n```\n\nipcs \u30b3\u30de\u30f3\u30c9\u3067\u78ba\u8a8d\u3059\u308b\u3068 owner \u304c\u304a\u304b\u3057\u3044\u3002\n\n```\n------ Semaphore Arrays --------\nkey        semid      owner      perms      nsems\n0x00000000 0          root       600        1\n0x00000000 32769      root       600        1\n0x00000000 131074     4294967295 600        1\n0x00000000 163843     4294967295 600        1\n0x00000000 458756     4294967295 600        1\n0x00000000 491525     4294967295 600        1\n0x00000000 262150     4294967295 600        1\n0x00000000 294919     4294967295 600        1\n0x00000000 393224     4294967295 600        1\n0x00000000 425993     4294967295 600        1\n0x00000000 524298     4294967295 600        1\n0x00000000 557067     4294967295 600        1\n0x00000000 655372     4294967295 600        1\n0x00000000 688141     4294967295 600        1\n```\n\nNginx \u3092 root \u3067\u52d5\u304b\u305b\u3070\u89e3\u6c7a\u3059\u308b\u3060\u308d\u3046\u304c\u3001\u305d\u308c\u306f\u907f\u3051\u305f\u3044\n\n\u30bd\u30fc\u30b9\u3092 grep \u3057\u3066\u63a2\u3057\u3066\u3044\u304f\u3068\u3001DEFAULT_USER \u306a\u308b\u3082\u306e\u304c\u898b\u3064\u304b\u308b\n\n```\n[host]$ grep -r semctl *\nstandalone/server.c:            if (semctl(ospmutex.crossproc, 0, IPC_SET, ick) < 0) {\nstandalone/server.c:            if (semctl(ospmutex.crossproc, 0, IPC_SET, ick) < 0) {\n```\n\n\n```c:standalone/server.c\n#if AP_SERVER_MAJORVERSION_NUMBER > 1 && AP_SERVER_MINORVERSION_NUMBER < 3\n    unixd_config.user_name = DEFAULT_USER;\n    unixd_config.user_id = ap_uname2id(DEFAULT_USER);\n    unixd_config.group_id = ap_gname2id(DEFAULT_GROUP);\n    unixd_config.suexec_enabled = 0;\n#else\n    ap_unixd_config.user_name = DEFAULT_USER;\n    ap_unixd_config.user_id = ap_uname2id(DEFAULT_USER);\n    ap_unixd_config.group_id = ap_gname2id(DEFAULT_GROUP);\n    ap_unixd_config.suexec_enabled = 0;\n#endif\n```\n\n```c:standalone/server.c\n            apr_os_proc_mutex_get(&ospmutex, pmutex);\n            buf.sem_perm.uid = unixd_config.user_id;\n            buf.sem_perm.gid = unixd_config.group_id;\n            buf.sem_perm.mode = 0600;\n            ick.buf = &buf;\n            if (semctl(ospmutex.crossproc, 0, IPC_SET, ick) < 0) {\n                return errno;\n            }\n```\n\nDEFAULT_USER \u3092\u63a2\u3059\n\n```\n[host]$ grep -r DEFAULT_USER /usr/include/httpd/*\n/usr/include/httpd/unixd.h:#ifndef DEFAULT_USER\n/usr/include/httpd/unixd.h:#define DEFAULT_USER \"#-1\"\n```\n\n```c:/usr/include/httpd/unixd.h\n#ifndef DEFAULT_USER\n#define DEFAULT_USER \"#-1\"\n#endif\n#ifndef DEFAULT_GROUP\n#define DEFAULT_GROUP \"#-1\"\n#endif\n```\n\nDEFAULT_USER \u306a\u3069\u3092\u5b9a\u7fa9\u3057\u3066\u3084\u308c\u3070\u3044\u3044\u306e\u3067\u3001ModSecurity \u304b\u3089\u30b3\u30f3\u30d1\u30a4\u30eb\u3057\u76f4\u3059\u3002\u4ee5\u4e0b\u306f\u4e00\u4f8b\u3067\u3001\u30aa\u30d7\u30b7\u30e7\u30f3\u306f\u5404\u74b0\u5883\u3067\u9069\u5207\u306b\u8a2d\u5b9a\u3059\u308b\u3002\n\n```\n[host]# CFLAGS=\"-DDEFAULT_USER=\\\\\\\"nginx\\\\\\\" -DDEFAULT_GROUP=\\\\\\\"nginx\\\\\\\"\" \\\nCPPFLAGS=\"-I/usr/include/apr-1 -I/usr/include/httpd\" \\\n./configure \\\n--disable-apache2-module \\\n--disable-mlogc \\\n--enable-standalone-module\n[host]# make\n[host]# make install\n```\n\nNginx \u3082\u30b3\u30f3\u30d1\u30a4\u30eb\u3057\u76f4\u3059\u3002\u4ee5\u4e0b\u306f\u4e00\u4f8b\u3067\u3001\u30aa\u30d7\u30b7\u30e7\u30f3\u306f\u5404\u74b0\u5883\u3054\u3068\u306b\u9069\u5207\u306b\u8a2d\u5b9a\u3059\u308b\n\n```\n[host]# ./configure \\\n--add-module=../modsecurity-2.8.0/nginx/modsecurity \\\n--user=nginx --group=nginx \\\n--without-mail_pop3_module \\\n--without-mail_imap_module \\\n--without-mail_smtp_module \\\n--with-cc-opt=\"-I/usr/include/apr-1 -I/usr/include/httpd\" \\\n--with-ld-opt=\"-lapr-1 -laprutil-1\"\n[host]# make\n[host]# make install\n```\n\n\u4fee\u6b63\u5b8c\u4e86\u3002\n\n```\n[host]# service nginx start\n[host]# ipcs -s\n\n------ Semaphore Arrays --------\nkey        semid      owner      perms      nsems\n0x00000000 0          root       600        1\n0x00000000 32769      root       600        1\n0x00000000 131074     nginx      600        1\n0x00000000 163843     nginx      600        1\n```\n\n\u4fee\u6b63\u524d\u306f\u3084\u305f\u3089\u3068\u6570\u304c\u591a\u304b\u3063\u305f\u3057\u3001\n\u591a\u5206\u76f4\u3059\u307e\u3067\u306f\u30bb\u30de\u30d5\u30a9\u306e\u524a\u9664\u306b\u3082\u5931\u6557\u3057\u3066\u3044\u305f\u3068\u601d\u308f\u308c\u308b\u3002\n", "tags": ["nginx", "ModSecurity"]}