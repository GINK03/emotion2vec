{"context": " More than 1 year has passed since last update.\n\n\u306f\u3058\u3081\u306b\nCloudtrail\u30ed\u30b0\u3092Kibana\u304c\u4f7f\u3048\u308bElasticsearch\u306b\u653e\u308a\u8fbc\u3093\u3067\u5206\u6790\u3067\u304d\u305f\u3089\u4fbf\u5229\u3060\u3068\u601d\u3063\u305f\u306e\u3067\u3001\u3053\u3061\u3089\u3092\u53c2\u8003\u306bLambda function\u306e\u30b5\u30f3\u30d7\u30eb\u3092\u4f5c\u3063\u3066\u307f\u307e\u3057\u305f\u3002\n\n\u4f5c\u6210\u3057\u305f Lambda function \u306e\u30b3\u30fc\u30c9\u306f\u3053\u3061\u3089\u3002\n\nlambda-function.js\nvar aws = require('aws-sdk');\nvar zlib = require('zlib');\nvar elasticsearch = require('elasticsearch');\n\nvar ES_INDEX = 'cloudtrail'; // Elasticsearch index name\nvar ES_TYPE = 'log'; // Elsticsearch index type name\nvar ES_CLIENT = new elasticsearch.Client({\n    host: '<ELASTICSEARCH_URL:PORT_NUMBER>' //Elasticsearch URL:port\n}); \n\n//start lambda function\nexports.handler = function(event, context) {\n    console.log('Received event:');\n    var bucket = event.Records[0].s3.bucket.name;\n    var key = event.Records[0].s3.object.key;\n    var region = event.Records[0].awsRegion;\n    var s3 = new aws.S3({\n        apiVersion: '2006-03-01',\n        region : region\n    });\n\n    s3.getObject({\n        Bucket : bucket,\n        Key : key\n    }, function(err,data) {\n        if(err){\n            context.done('error','error getting file' + err);\n        } else {\n            var contentType = data.ContentType;\n            var contentEncoding = data.ContentEncoding;\n            if (contentType === \"application/json\"\n                && contentEncoding === \"gzip\") {\n                var logFileName = key.substr(key.lastIndexOf(\"/\") + 1);\n                var buf = data.Body;\n                zlib.gunzip(buf, function(_, dezipped) {\n                    var json = JSON.parse(dezipped.toString('utf-8'));\n                    sendToES(context,region,logFileName,json);\n                });\n            }\n        }\n    });\n};\n\n//bulk send to Elasticsearch\nfunction sendToES(context,region,logFileName,json){\n    var records = json.Records;\n    var searchRecords = [];\n    for(var i = 0; i < records.length; i++){\n        var record = records[i];\n        var header = {\n            \"index\":{\n                \"_index\": ES_INDEX,\n                \"_type\": ES_TYPE,\n                \"_id\": record.eventTime + \"-\" + record.requestID\n            }\n        };\n\n        var searchRecord = {\n            \"usertype\" : record.userIdentity.type,\n            \"arn\" : record.userIdentity.arn,\n            \"accesskeyid\" : record.userIdentity.accessKeyId,\n            \"username\" : record.userIdentity.userName,\n            \"eventtime\" : record.eventTime,\n            \"eventsource\" : record.eventSource,\n            \"eventname\" : record.eventName,\n            \"awsregion\" : record.awsRegion,\n            \"sourceipaddress\" : record.sourceIPAddress,\n            \"useragent\" : record.userAgent,\n            \"requestid\" : record.requestID,\n            \"eventid\" : record.eventID,\n            \"logfilename\" : logFileName\n        };\n        searchRecords.push(header);\n        searchRecords.push(searchRecord);\n    };\n    console.log(searchRecords);\n    ES_CLIENT.bulk({\n        \"body\": searchRecords\n    }, function(err, resp){\n            if(err){\n                console.log(err);\n                context.done(\"error\",err);\n            }else{\n                console.log(resp);\n                context.done(null,'success');\n            };\n    });\n};\n\n\n\n\u4f7f\u3044\u65b9\n\u203b\u3042\u3089\u304b\u3058\u3081Cloudtrail\u3092\u6709\u52b9\u5316\u3057\u3066\u304a\u3044\u3066\u304f\u3060\u3055\u3044\u3002Cloudtrail\u30ed\u30b0\u304c\u7f6e\u304b\u308c\u308b\u30d0\u30b1\u30c3\u30c8\u306fLambda function\u3068\u540c\u4e00\u30ea\u30fc\u30b8\u30e7\u30f3\u3067\u3042\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\u307e\u305aElasticsearch / kibana\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u305f\u30b5\u30fc\u30d0\u30fc\u3092\u7528\u610f\u3057\u307e\u3059\u3002kibana4\u304c\u5148\u65e5\u6b63\u5f0f\u30ea\u30ea\u30fc\u30b9\u306b\u306a\u3063\u305f\u306e\u3067\u3001\u4eca\u56de\u306fElasticsearch 1.4.4/kibana 4.0\u3092\u9078\u629e\u3002\n\nhttp://www.elasticsearch.org/download/\nhttp://www.elasticsearch.org/overview/kibana/installation/\n\nElasticsearch\u3092\u8d77\u52d5\u3057\u305f\u3089\u3001Index\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002Elasticsearch\u306f\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u3092put\u3059\u308b\u3068\u81ea\u52d5\u3067\u30de\u30c3\u30d4\u30f3\u30b0\u3092\u4f5c\u3063\u3066\u304f\u308c\u307e\u3059\u304c\u3001Kibana\u3067\u4f7f\u3046\u5834\u5408\u306fnot_analyzed\u3092\u660e\u793a\u7684\u306b\u6307\u5b9a\u3057\u3066\u304a\u3044\u305f\u65b9\u304c\u826f\u3044\u3067\u3059\u3002\ncurl -XPUT http://localhost:9200/cloudtrail -d '\n{\n    mappings: {\n        log: {\n            properties: {\n                accesskeyid: {\n                    type: \"string\",\n                    index: \"not_analyzed\"\n                },\n                arn: {\n                    type: \"string\",\n                    index: \"not_analyzed\"\n                },\n                awsregion: {\n                    type: \"string\",\n                    index: \"not_analyzed\"\n                },\n                eventid: {\n                    type: \"string\",\n                    index: \"not_analyzed\"\n                },\n                eventname: {\n                    type: \"string\",\n                    index: \"not_analyzed\"\n                },\n                eventsource: {\n                    type: \"string\",\n                    index: \"not_analyzed\"\n                },\n                eventtime: {\n                    type: \"date\",\n                    format: \"dateOptionalTime\"\n                },\n                logfilename: {\n                    type: \"string\",\n                    index: \"not_analyzed\"\n                },\n                requestid: {\n                    type: \"string\",\n                    index: \"not_analyzed\"\n                },\n                sourceipaddress: {\n                    type: \"string\",\n                    index: \"not_analyzed\"\n                },\n                useragent: {\n                    type: \"string\",\n                    index: \"not_analyzed\"\n                },\n                username: {\n                    type: \"string\",\n                    index: \"not_analyzed\"\n                },\n                usertype: {\n                    type: \"string\",\n                    index: \"not_analyzed\"\n                }\n            }\n        }\n    }\n}'\n\nElasticsearch\u74b0\u5883\u304c\u3067\u304d\u305f\u3089\u3001lambda function\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\nnode\u3068npm\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3001lambda function \u3092\u30d1\u30c3\u30b1\u30fc\u30b8\u3059\u308b\u74b0\u5883\u3092\u6574\u3048\u307e\u3059\u3002Lambda\u958b\u767a\u74b0\u5883\u306e\u8a2d\u5b9a\u306f\u3053\u3061\u3089\u304c\u53c2\u8003\u306b\u306a\u308a\u307e\u3057\u305f\u3002\nfunction\u306e\u4e2d\u3067Elasticsearch.js\u3092\u4f7f\u7528\u3059\u308b\u306e\u3067\u3001npm\u3067\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u307e\u3059\u3002\nnpm install elasticsearch\n\n\u5192\u982d\u306eLambda function\u3092js\u5f62\u5f0f\u3067\u4fdd\u5b58\u3057\u3001node_module\u3068\u4e00\u7dd2\u306b zip \u3067\u5727\u7e2e\u3057\u307e\u3059\u3002zip\u30d5\u30a1\u30a4\u30eb\u304c\u7528\u610f\u3067\u6765\u305f\u3089Lambda\u306b\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u3057\u307e\u3059\u3002\naws cli \u3092\u4f7f\u3046\u3068 \u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u3057\u3066\u305d\u306e\u307e\u307eLambda function \u3092\u4f5c\u6210\u3057\u3066\u304f\u308c\u307e\u3059\u3002\n$ zip -r function.zip lambda-function.js node_modules\n\n$ aws lambda upload-function --function-name CloudtrailToElasticsearch --function-zip \"./function.zip\" --runtime nodejs --role  arn:aws:iam::<AWS_ACCOUNT_ID>:role/lambda_exec_role --mode event --handler lambda-function.handler \n\nLambda Function\u3092\u4f5c\u3063\u305f\u3089\u30a4\u30d9\u30f3\u30c8\u30bd\u30fc\u30b9\u306e\u8a2d\u5b9a\u3092\u3057\u307e\u3059\u3002Lambda Management Console\u3067\"Configure event source\"\u3092\u30af\u30ea\u30c3\u30af\u3057\u3001Cloudtrail\u30ed\u30b0\u304c\u51fa\u529b\u3055\u308c\u308bs3\u30d0\u30b1\u30c3\u30c8\u3068\u3001\u8aad\u307f\u53d6\u308a\u6642\u306b\u4f7f\u7528\u3059\u308bIAM\u30ed\u30fc\u30eb\u3092\u9078\u629e\u3057\u3066\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\u3053\u3053\u307e\u3067\u8a2d\u5b9a\u3057\u3001\u7279\u306b\u554f\u984c\u304c\u306a\u3051\u308c\u3070Cloudtrail\u30ed\u30b0\u304c\u81ea\u52d5\u7684\u306bElasticsearch\u306bput\u3055\u308c\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\n\u3042\u3068\u306fkibana4\u3067Dashboard\u3092\u3064\u304f\u308b\u3060\u3051\u3002kibana4\u306e\u64cd\u4f5c\u306f\u3053\u3061\u3089\u304c\u3068\u3066\u3082\u53c2\u8003\u306b\u306a\u308a\u307e\u3057\u305f\u3002\n\u3053\u3093\u306a\u611f\u3058\u3067\u30ea\u30fc\u30b8\u30e7\u30f3\u3054\u3068\u306a\u3069\u5206\u6790\u3057\u305f\u3044\u5207\u308a\u53e3\u3067visualize\u3092\u4f5c\u6210\u3057\u3066\u3001\n\nDashboard\u306b\u307e\u3068\u3081\u308b\u3068\u3001\u3042\u3063\u3068\u3044\u3046\u9593\u306bCloudtrail\u30ed\u30b0\u306e\u53ef\u8996\u5316\u304c\u3067\u304d\u307e\u3059\u3002\n\n#\u306f\u3058\u3081\u306b\nCloudtrail\u30ed\u30b0\u3092Kibana\u304c\u4f7f\u3048\u308bElasticsearch\u306b\u653e\u308a\u8fbc\u3093\u3067\u5206\u6790\u3067\u304d\u305f\u3089\u4fbf\u5229\u3060\u3068\u601d\u3063\u305f\u306e\u3067\u3001[\u3053\u3061\u3089](http://c9katayama.hatenablog.com/entry/20141126/1417004295)\u3092\u53c2\u8003\u306bLambda function\u306e\u30b5\u30f3\u30d7\u30eb\u3092\u4f5c\u3063\u3066\u307f\u307e\u3057\u305f\u3002\n\n![SnapCrab_NoName_2015-2-21_23-17-16_No-00.png](https://qiita-image-store.s3.amazonaws.com/0/51577/7536424c-c633-75de-6ebf-6d581876d879.png)\n\n\u4f5c\u6210\u3057\u305f Lambda function \u306e\u30b3\u30fc\u30c9\u306f\u3053\u3061\u3089\u3002\n\n\n```lambda-function.js\nvar aws = require('aws-sdk');\nvar zlib = require('zlib');\nvar elasticsearch = require('elasticsearch');\n\nvar ES_INDEX = 'cloudtrail'; // Elasticsearch index name\nvar ES_TYPE = 'log'; // Elsticsearch index type name\nvar ES_CLIENT = new elasticsearch.Client({\n    host: '<ELASTICSEARCH_URL:PORT_NUMBER>' //Elasticsearch URL:port\n}); \n\n//start lambda function\nexports.handler = function(event, context) {\n    console.log('Received event:');\n    var bucket = event.Records[0].s3.bucket.name;\n    var key = event.Records[0].s3.object.key;\n    var region = event.Records[0].awsRegion;\n    var s3 = new aws.S3({\n        apiVersion: '2006-03-01',\n        region : region\n    });\n\n    s3.getObject({\n        Bucket : bucket,\n        Key : key\n    }, function(err,data) {\n        if(err){\n            context.done('error','error getting file' + err);\n        } else {\n            var contentType = data.ContentType;\n            var contentEncoding = data.ContentEncoding;\n            if (contentType === \"application/json\"\n                && contentEncoding === \"gzip\") {\n                var logFileName = key.substr(key.lastIndexOf(\"/\") + 1);\n                var buf = data.Body;\n                zlib.gunzip(buf, function(_, dezipped) {\n                    var json = JSON.parse(dezipped.toString('utf-8'));\n                    sendToES(context,region,logFileName,json);\n                });\n            }\n        }\n    });\n};\n\n//bulk send to Elasticsearch\nfunction sendToES(context,region,logFileName,json){\n    var records = json.Records;\n    var searchRecords = [];\n    for(var i = 0; i < records.length; i++){\n        var record = records[i];\n        var header = {\n            \"index\":{\n                \"_index\": ES_INDEX,\n                \"_type\": ES_TYPE,\n                \"_id\": record.eventTime + \"-\" + record.requestID\n            }\n        };\n\n        var searchRecord = {\n            \"usertype\" : record.userIdentity.type,\n            \"arn\" : record.userIdentity.arn,\n            \"accesskeyid\" : record.userIdentity.accessKeyId,\n            \"username\" : record.userIdentity.userName,\n            \"eventtime\" : record.eventTime,\n            \"eventsource\" : record.eventSource,\n            \"eventname\" : record.eventName,\n            \"awsregion\" : record.awsRegion,\n            \"sourceipaddress\" : record.sourceIPAddress,\n            \"useragent\" : record.userAgent,\n            \"requestid\" : record.requestID,\n            \"eventid\" : record.eventID,\n            \"logfilename\" : logFileName\n        };\n        searchRecords.push(header);\n        searchRecords.push(searchRecord);\n    };\n    console.log(searchRecords);\n    ES_CLIENT.bulk({\n        \"body\": searchRecords\n    }, function(err, resp){\n            if(err){\n                console.log(err);\n                context.done(\"error\",err);\n            }else{\n                console.log(resp);\n                context.done(null,'success');\n            };\n    });\n};\n```\n\n##\u4f7f\u3044\u65b9\n\u203b\u3042\u3089\u304b\u3058\u3081Cloudtrail\u3092\u6709\u52b9\u5316\u3057\u3066\u304a\u3044\u3066\u304f\u3060\u3055\u3044\u3002Cloudtrail\u30ed\u30b0\u304c\u7f6e\u304b\u308c\u308b\u30d0\u30b1\u30c3\u30c8\u306fLambda function\u3068\u540c\u4e00\u30ea\u30fc\u30b8\u30e7\u30f3\u3067\u3042\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\n\u307e\u305aElasticsearch / kibana\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u305f\u30b5\u30fc\u30d0\u30fc\u3092\u7528\u610f\u3057\u307e\u3059\u3002kibana4\u304c\u5148\u65e5\u6b63\u5f0f\u30ea\u30ea\u30fc\u30b9\u306b\u306a\u3063\u305f\u306e\u3067\u3001\u4eca\u56de\u306fElasticsearch 1.4.4/kibana 4.0\u3092\u9078\u629e\u3002\n\n * http://www.elasticsearch.org/download/\n * http://www.elasticsearch.org/overview/kibana/installation/\n\nElasticsearch\u3092\u8d77\u52d5\u3057\u305f\u3089\u3001Index\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002Elasticsearch\u306f\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u3092put\u3059\u308b\u3068\u81ea\u52d5\u3067\u30de\u30c3\u30d4\u30f3\u30b0\u3092\u4f5c\u3063\u3066\u304f\u308c\u307e\u3059\u304c\u3001Kibana\u3067\u4f7f\u3046\u5834\u5408\u306fnot_analyzed\u3092\u660e\u793a\u7684\u306b\u6307\u5b9a\u3057\u3066\u304a\u3044\u305f\u65b9\u304c\u826f\u3044\u3067\u3059\u3002\n\n```\ncurl -XPUT http://localhost:9200/cloudtrail -d '\n{\n    mappings: {\n        log: {\n            properties: {\n                accesskeyid: {\n                    type: \"string\",\n                    index: \"not_analyzed\"\n                },\n                arn: {\n                    type: \"string\",\n                    index: \"not_analyzed\"\n                },\n                awsregion: {\n                    type: \"string\",\n                    index: \"not_analyzed\"\n                },\n                eventid: {\n                    type: \"string\",\n                    index: \"not_analyzed\"\n                },\n                eventname: {\n                    type: \"string\",\n                    index: \"not_analyzed\"\n                },\n                eventsource: {\n                    type: \"string\",\n                    index: \"not_analyzed\"\n                },\n                eventtime: {\n                    type: \"date\",\n                    format: \"dateOptionalTime\"\n                },\n                logfilename: {\n                    type: \"string\",\n                    index: \"not_analyzed\"\n                },\n                requestid: {\n                    type: \"string\",\n                    index: \"not_analyzed\"\n                },\n                sourceipaddress: {\n                    type: \"string\",\n                    index: \"not_analyzed\"\n                },\n                useragent: {\n                    type: \"string\",\n                    index: \"not_analyzed\"\n                },\n                username: {\n                    type: \"string\",\n                    index: \"not_analyzed\"\n                },\n                usertype: {\n                    type: \"string\",\n                    index: \"not_analyzed\"\n                }\n            }\n        }\n    }\n}'\n```\n\nElasticsearch\u74b0\u5883\u304c\u3067\u304d\u305f\u3089\u3001lambda function\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\nnode\u3068npm\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3001lambda function \u3092\u30d1\u30c3\u30b1\u30fc\u30b8\u3059\u308b\u74b0\u5883\u3092\u6574\u3048\u307e\u3059\u3002Lambda\u958b\u767a\u74b0\u5883\u306e\u8a2d\u5b9a\u306f[\u3053\u3061\u3089](http://c9katayama.hatenablog.com/entry/20141126/1417004295)\u304c\u53c2\u8003\u306b\u306a\u308a\u307e\u3057\u305f\u3002\nfunction\u306e\u4e2d\u3067[Elasticsearch.js](http://www.elasticsearch.org/guide/en/elasticsearch/client/javascript-api/current/)\u3092\u4f7f\u7528\u3059\u308b\u306e\u3067\u3001npm\u3067\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u307e\u3059\u3002\n\n```\nnpm install elasticsearch\n```\n\n\u5192\u982d\u306eLambda function\u3092js\u5f62\u5f0f\u3067\u4fdd\u5b58\u3057\u3001node_module\u3068\u4e00\u7dd2\u306b zip \u3067\u5727\u7e2e\u3057\u307e\u3059\u3002zip\u30d5\u30a1\u30a4\u30eb\u304c\u7528\u610f\u3067\u6765\u305f\u3089Lambda\u306b\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u3057\u307e\u3059\u3002\naws cli \u3092\u4f7f\u3046\u3068 \u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u3057\u3066\u305d\u306e\u307e\u307eLambda function \u3092\u4f5c\u6210\u3057\u3066\u304f\u308c\u307e\u3059\u3002\n\n```\n$ zip -r function.zip lambda-function.js node_modules\n\n$ aws lambda upload-function --function-name CloudtrailToElasticsearch --function-zip \"./function.zip\" --runtime nodejs --role  arn:aws:iam::<AWS_ACCOUNT_ID>:role/lambda_exec_role --mode event --handler lambda-function.handler \n```\n\nLambda Function\u3092\u4f5c\u3063\u305f\u3089\u30a4\u30d9\u30f3\u30c8\u30bd\u30fc\u30b9\u306e\u8a2d\u5b9a\u3092\u3057\u307e\u3059\u3002Lambda Management Console\u3067\"Configure event source\"\u3092\u30af\u30ea\u30c3\u30af\u3057\u3001Cloudtrail\u30ed\u30b0\u304c\u51fa\u529b\u3055\u308c\u308bs3\u30d0\u30b1\u30c3\u30c8\u3068\u3001\u8aad\u307f\u53d6\u308a\u6642\u306b\u4f7f\u7528\u3059\u308bIAM\u30ed\u30fc\u30eb\u3092\u9078\u629e\u3057\u3066\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n\n\u3053\u3053\u307e\u3067\u8a2d\u5b9a\u3057\u3001\u7279\u306b\u554f\u984c\u304c\u306a\u3051\u308c\u3070Cloudtrail\u30ed\u30b0\u304c\u81ea\u52d5\u7684\u306bElasticsearch\u306bput\u3055\u308c\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\n\n\u3042\u3068\u306fkibana4\u3067Dashboard\u3092\u3064\u304f\u308b\u3060\u3051\u3002kibana4\u306e\u64cd\u4f5c\u306f[\u3053\u3061\u3089](http://qiita.com/harukasan/items/3737a1cc0bed2facc14e)\u304c\u3068\u3066\u3082\u53c2\u8003\u306b\u306a\u308a\u307e\u3057\u305f\u3002\n\n\u3053\u3093\u306a\u611f\u3058\u3067\u30ea\u30fc\u30b8\u30e7\u30f3\u3054\u3068\u306a\u3069\u5206\u6790\u3057\u305f\u3044\u5207\u308a\u53e3\u3067visualize\u3092\u4f5c\u6210\u3057\u3066\u3001\n![SnapCrab_NoName_2015-2-22_12-41-29_No-00.png](https://qiita-image-store.s3.amazonaws.com/0/51577/ccaa36a6-5c70-2085-9342-da956fcc58da.png)\n\nDashboard\u306b\u307e\u3068\u3081\u308b\u3068\u3001\u3042\u3063\u3068\u3044\u3046\u9593\u306bCloudtrail\u30ed\u30b0\u306e\u53ef\u8996\u5316\u304c\u3067\u304d\u307e\u3059\u3002\n![SnapCrab_NoName_2015-2-22_12-37-35_No-00.png](https://qiita-image-store.s3.amazonaws.com/0/51577/8575dc3a-415a-168e-51fc-1f8ac9c5c47e.png)\n", "tags": ["AWS", "lambda", "Cloudtrail", "Elasticsearch", "kibana"]}