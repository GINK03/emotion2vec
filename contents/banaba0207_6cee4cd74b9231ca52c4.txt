{"context": "\u7b2c\u4e8c\u56de\u306b\u5f15\u304d\u7d9a\u304d\u3001\u63b2\u793a\u677f\u306e\u4f5c\u6210\u3092\u884c\u3063\u3066\u3044\u304d\u307e\u3059\u3002\n\u4eca\u56de\u306f\n - \u753b\u50cf\u6295\u7a3f\u6a5f\u80fd\u306e\u5b9f\u88c5\n\u3092\u884c\u3063\u3066\u3044\u304d\u307e\u3059\u3002\n\n\u76ee\u6b21\n~\u7b2c\u4e00\u56de CRUD\u306e\u5b9f\u88c5~\n~\u7b2c\u4e8c\u56de paginate, \u30ca\u30d3\u30b2\u30fc\u30b7\u30e7\u30f3\u30d0\u30fc\u306e\u5b9f\u88c5~\n~\u7b2c\u4e09\u56de \u753b\u50cf\u6295\u7a3f\u6a5f\u80fd\u306e\u5b9f\u88c5~\n~\u7b2c\u56db\u56de \u30c9\u30e9\u30c3\u30b0\u30a2\u30f3\u30c9\u30c9\u30ed\u30c3\u30d7(DnD)\u3067\u306e\u753b\u50cf\u6dfb\u4ed8 ~\n\n\u65b9\u91dd\n\ninput\u30d5\u30a9\u30fc\u30e0\u304b\u3089\u753b\u50cf\u3092\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u3059\u308b\n\n\n\u5f62\u5f0f\u306f ipg, png, gif\u306e\u307f\uff08\u6700\u5927\u30b5\u30a4\u30ba 10M\uff09\n\n\nDB\u306b\u306f\u4ee5\u4e0b\u306e\u9805\u76ee\u3092\u683c\u7d0d\u3059\u308b\n\n\nimg_name (\u30e6\u30cb\u30fc\u30af\u306a\u540d\u524d)\nimg_ext (\u30d5\u30a1\u30a4\u30eb\u306e\u62e1\u5f35\u5b50)\nimg_size (\u30d5\u30a1\u30a4\u30eb\u306e\u5bb9\u91cf)\n\u30d5\u30a1\u30a4\u30eb\u306f\u30e6\u30cb\u30fc\u30af\u306a\u540d\u524d\u3092\u3064\u3051\u3066\u30ed\u30fc\u30ab\u30eb\uff08webroot/img\u4ee5\u4e0b\uff09\u306b\u4fdd\u5b58\u3059\u308b\n\u305d\u306e\u969b\u3001\u30b5\u30e0\u30cd\u30a4\u30eb\u3082\u751f\u6210\u3059\u308b\nwebroot/img/mini\u4ee5\u4e0b\u306b\u4fdd\u5b58\n\u8868\u793a\u3059\u308b\u969b\u306f\u30b5\u30e0\u30cd\u30a4\u30eb\u3067\u8868\u793a\u3057\u3001\u753b\u50cf\u304c\u30af\u30ea\u30c3\u30af\u3055\u308c\u305f\u969b\u306blightbox\u5f62\u5f0f\u3067\u8868\u793a\u3059\u308b\n\n\n\n\n\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u30d5\u30a9\u30fc\u30e0\u306e\u5b9f\u88c5\n\u524d\u56de\u4f5c\u6210\u3057\u305fform\u30a8\u30ec\u30e1\u30f3\u30c8\u3092\u5c11\u3057\u7de8\u96c6\u3057\u307e\u3059\u3002\n\nphp.src/Template/Element/form.ctp\n<?= $this->Form->create($post, array(\n    'url' => array('action' => $action),\n    'type' => 'file',                     //add\n    )) ?>\n<fieldset>\n<?php\n        echo $this->Form->hidden('postId');\n        echo $this->Form->hidden('resId');\n        echo $this->Form->input('title');\n        echo $this->Form->input('name');\n        echo $this->Form->input('content');\n        echo $this->Form->file('img');     //add\n        echo \"<br>\";\n    ?>\n</fieldset>\n<?= $this->Form->button(__('\u6295\u7a3f\u3059\u308b')) ?>\n<?= $this->Form->end() ?>\n\n\n\u4ee5\u4e0a\u3067\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u30d5\u30a9\u30fc\u30e0\u304c\u751f\u6210\u3055\u308c\u307e\u3059\u3002\n\n\u753b\u50cf\u306e\u4fdd\u5b58\n\u30d6\u30b5\u30a4\u30af\u306a\u3084\u308a\u65b9\u3067\u3059\u304c\u3001\u3054\u5bb9\u8d66\u4e0b\u3055\u3044\u3002\n\n\u30e2\u30c7\u30eb\u306e\u4fee\u6b63\n\n\njpg, png, gif\u4ee5\u5916\u306e\u62e1\u5f35\u5b50\u306e\u5834\u5408\u3001\u30d0\u30ea\u30c7\u30fc\u30b7\u30e7\u30f3\u30a8\u30e9\u30fc\u3092\u8fd4\u3059\u3088\u3046\u306b\u4fee\u6b63\n\u30d5\u30a1\u30a4\u30eb\u30b5\u30a4\u30ba\u304c10M\u4ee5\u4e0a\u306e\u5834\u5408\u3001\u30d0\u30ea\u30c7\u30fc\u30b7\u30e7\u30f3\u30a8\u30e9\u30fc\u3092\u8fd4\u3059\u3088\u3046\u306b\u4fee\u6b63\n\n\n\n\nphp.src/Model/Table/PostsTable.php\n~~\n        $validator\n            ->allowEmpty('img_ext')\n            ->add('img_ext', ['list' => [\n                'rule' => ['inList', ['jpg', 'png', 'gif']],\n                'message' => 'jpg, png, gif \u306e\u307f\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u53ef\u80fd\u3067\u3059.',\n            ]]);\n\n        $validator\n            ->integer('img_size')\n            ->allowEmpty('img_size')\n            ->add('img_size', 'comparison', [\n                'rule' => ['comparison', '<', 10485760],\n                'message' => '\u30d5\u30a1\u30a4\u30eb\u30b5\u30a4\u30ba\u304c\u8d85\u904e\u3057\u3066\u3044\u307e\u3059(MaxSize:10M)',\n            ]);\n~~\n\n\n\n\u30b3\u30f3\u30dd\u30fc\u30cd\u30f3\u30c8\u306e\u4f5c\u6210\n\n\nadd, edit \u30a2\u30af\u30b7\u30e7\u30f3\u306e\u4e21\u65b9\u3067\u7528\u3044\u308b\u306e\u3067\u3001\u30b3\u30f3\u30dd\u30fc\u30cd\u30f3\u30c8\u5316\u3057\u3001\u4f7f\u3044\u307e\u308f\u305b\u308b\u3088\u3046\u306b\u3057\u307e\u3059\n\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u30fc\u304b\u3089save\u30e1\u30bd\u30c3\u30c9\u3092\u547c\u3073\u51fa\u3059\u3053\u3068\u3067\u4ee5\u4e0b\u306e\u3053\u3068\u3092\u884c\u3044\u307e\u3059\n\n\n$post\u306b img_name, img_size, img_ext\u3092\u8a2d\u5b9a\n\n\nmd5(uniqid(rand(), 1))\u306b\u3088\u308a\u3001\u30e6\u30cb\u30fc\u30af\u306a\u6587\u5b57\u5217\u3092\u751f\u6210\u3057\u3001name\u306b\u8a2d\u5b9a\u3057\u3066\u3044\u307e\u3059\n\n\n\u753b\u50cf\u3092\u30ed\u30fc\u30ab\u30eb\u306b\u4fdd\u5b58\n\n\n\u203b\u30b5\u30e0\u30cd\u30a4\u30eb\u751f\u6210\u306e\u3068\u3053\u308d\u304c\u3084\u3084\u3053\u3057\u3059\u304e\u308b\u306e\u3067\u3001\u3088\u308a\u826f\u3044\u65b9\u6cd5\u3092\u601d\u6848\u4e2d\n\n\n\n\nphp.src/Controller/Component/ImgProcessComponent.php\n<?php\nnamespace App\\Controller\\Component;\n\nuse Cake\\Controller\\Component;\nuse Cake\\Controller\\ComponentRegistry;\n\n/**\n * ImgProcess component\n */\nclass ImgProcessComponent extends Component\n{\n    function initialize(array $config) {\n        $this->controller = $this->_registry->getController();\n    }\n\n    //validation\u9069\u7528\u306e\u305f\u3081\u3001rquest\u306b img_name, img_ext, img_size\u3092\u8a70\u3081\u308b\n    function save($request) {\n        $img = $request->data['img'];\n        $ext =  pathinfo($img['name'], PATHINFO_EXTENSION);\n        $name = md5(uniqid(rand(), 1)).'.'.$ext;\n        $request->data['img_ext'] = $ext;\n        $request->data['img_size'] = $img['size'];\n        $request->data['img_name'] = $name;\n    }\n\n    //\u30aa\u30ea\u30b8\u30ca\u30eb\u3068\u30b5\u30e0\u30cd\u30a4\u30eb\u4f5c\u6210\n    function generate($tmp_name, $post) {\n        move_uploaded_file($tmp_name, 'img/'.$post->img_name);\n        $original_file = 'img/'.$post->img_name;;\n        list($original_width, $original_height) = getimagesize($original_file);\n        $thumb_width = 300;\n        $thumb_height = round( $original_height * $thumb_width / $original_width );\n        if($post->img_ext === 'jpg') $original_image = imagecreatefromjpeg($original_file);\n        if($post->img_ext === 'png') $original_image = imagecreatefrompng($original_file);\n        if($post->img_ext === 'gif') $original_image = imagecreatefromgif($original_file);\n        $thumb_image = imagecreatetruecolor($thumb_width, $thumb_height);\n        imagecopyresized($thumb_image, $original_image, 0, 0, 0, 0,\n            $thumb_width, $thumb_height,\n            $original_width, $original_height);\n        if($post->img_ext === 'jpg') imagejpeg($thumb_image, 'img/mini/'.$post->img_name);\n        if($post->img_ext === 'png') imagepng($thumb_image, 'img/mini/'.$post->img_name);\n        if($post->img_ext === 'gif') imagegif($thumb_image, 'img/mini/'.$post->img_name);\n    }\n}\n\n\n\ncontroller\u306e\u4fee\u6b63\n\n\nphp.src/Controller/PostsController.php\n~~\n    public $components = array(\n        'ImgProcess' => array(),\n    );\n~~\n    public function add()\n    {\n        $post = $this->Posts->newEntity();\n        if ($this->request->is('post')) {\n            //\u8ffd\u52a0\uff08validation\u9069\u7528\u306e\u305f\u3081\u3001request\u306b\u8272\u3005\u8a70\u3081\u308b\u51e6\u7406\uff09--------------\n            if(!empty($this->request->data['img']['name'])) {\n                $this->ImgProcess->save($this->request);\n            }\n            //------------------------------------------------------------\n            $post = $this->Posts->patchEntity($post, $this->request->data);\n            if ($post->postId == -1) {\n                $post->postId = $this->Posts->find()\n                    ->order(['postId' => 'desc'])\n                    ->select(['postId'])\n                    ->first()['postId'] + 1;\n                $post->resId = 0;\n            }\n            if ($post->name === '') $post->name = '\u540d\u7121\u3057\u3055\u3093';\n            if ($this->Posts->save($post)) {\n               //\u8ffd\u52a0(\u30ed\u30fc\u30ab\u30eb\u306b\u4fdd\u5b58\uff06\u30b5\u30e0\u30cd\u30a4\u30eb\u751f\u6210)-------------------------\n                if(!empty($this->request->data['img']['name'])) {\n                    $this->ImgProcess->generate(\n                        $this->request->data['img']['tmp_name'], $post);\n                }\n               //-------------------------------------------------------\n                $this->Flash->success(__('\u6295\u7a3f\u3055\u308c\u307e\u3057\u305f.'));\n                if ($post->resId ===0) return $this->redirect(['action' => 'index']);\n                else                   return $this->redirect($this->referer());\n            } else {\n                //validation error\u306e\u8868\u793a\u6e96\u5099--------------------------------------------\n                if($post->errors()['img_ext'])\n                    $this->Flash->error(__($post->errors()['img_ext']['list']));\n                if($post->errors()['img_size'])\n                    $this->Flash->error(__($post->errors()['img_size']['comparison']));\n                //--------------------------------------------------------------------\n                $this->Flash->error(__('\u6295\u7a3f\u3067\u304d\u307e\u305b\u3093\u3067\u3057\u305f. \u518d\u5ea6\u304a\u8a66\u3057\u4e0b\u3055\u3044.'));\n                return $this->redirect($this->referer());\n            }\n        }\n        $this->set(compact('post'));\n        $this->set('_serialize', ['post']);\n    }\n~~\n}\n\n\n\u4ee5\u4e0a\u3067\u3001\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u3055\u308c\u305f\u30d5\u30a1\u30a4\u30eb\u3092\u30ed\u30fc\u30ab\u30eb\u306b\u4fdd\u5b58\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3057\u305f\u3002\n\n\u753b\u50cf\u306e\u8868\u793a\n\n\nlightbox\u306e\u5c0e\u5165\n\n\u82f1\u8a9e\u3067\u3059\u304c\u3001\u30b3\u30de\u30f3\u30c9\u3092\u8ffd\u3063\u3066\u3044\u3051\u3070\u7d44\u307f\u8fbc\u3080\u3053\u3068\u304c\u3067\u304d\u307e\u3057\u305f\n\n\nhttp://lokeshdhakar.com/projects/lightbox2/\n\n\n\n\n\ntemplete\u306e\u7de8\u96c6\n\none_article\u30a8\u30ec\u30e1\u30f3\u30c8\u3092\u7de8\u96c6\u3057\u307e\u3059\n\n\n$this->request->webroot \u3067webroot\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u53c2\u7167\u3059\u308bURL\u3092\u751f\u6210\u3067\u304d\u307e\u3059\nlightbox\u3092\u4f7f\u3046\u305f\u3081\u3001\u30bf\u30b0\u5185\u3092<a href=\"<?= $this->request->webroot ?>img/<?= $post->img_name ?>\" data-lightbox='image-1'>\u306e\u3088\u3046\u306b\u3057\u3066\u3044\u307e\u3059\n\n\n\n\n\n\nphp.src/Template/Element/one_article.ctp\n~~\n    <div class='panel-boby'>\n        <div style=\"padding:10px\">\n            <?= h($post->content) ?>\n        </div>\n        <div style=\"padding:10px\">\n            <?php if (!empty($post->img_name)): ?>\n                <a href=\"<?= $this->request->webroot ?>img/<?= $post->img_name ?>\" data-lightbox='image-1'>\n                <img src=\"<?= $this->request->webroot ?>img/mini/<?= $post->img_name ?>\"\n                   alt=\"<?= $post->img_name ?>\" height=\"200\" width=\"200\"/>\n                </a>\n            <?php endif; ?>\n        </div>\n    </div>\n~~\n\n\n\u4ee5\u4e0a\u306b\u3088\u308a\u3001lightbox\u5f62\u5f0f\u3067\u30ed\u30fc\u30ab\u30eb\u306b\u3042\u308b\u753b\u50cf\u3092\u8868\u793a\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3057\u305f\u3002\n\n\n\u524a\u9664\u6a5f\u80fd\n\u6295\u7a3f\u304c\u524a\u9664\u3055\u308c\u305f\u969b\u306b\u3001\u753b\u50cf\u3082\u4e00\u7dd2\u306b\u524a\u9664\u3059\u308b\u3088\u3046\u306bdelete\u30a2\u30af\u30b7\u30e7\u30f3\u3092\u7de8\u96c6\u3057\u307e\u3059\u3002\n\u4f8b\u306b\u3088\u3063\u3066\u30d6\u30b5\u30a4\u30af\u306a\u30b3\u30fc\u30c9\u3067\u3059\u304c\u3001\u4ee5\u4e0b\u89e3\u8aac\u3067\u3059\u3002\n 1. \u524a\u9664\u5bfe\u8c61\u304c\u8fd4\u4fe1\u6295\u7a3f\u306a\u306e\u304b\u5927\u5143\u306e\u6295\u7a3f\u306a\u306e\u304b\u3092\u5224\u5225\u3057\u307e\u3059\n 2. resID=0\u306e\u5834\u5408\u3001\u3059\u3079\u3066\u306e\u8fd4\u4fe1\u6295\u7a3f\u3092\u524a\u9664\u3059\u308b\u305f\u3081\u306bpostId\u304c\u4e00\u81f4\u3059\u308b\u6295\u7a3f\u306e\u753b\u50cf\u306e\u540d\u524d\u3092\u53d6\u5f97\u3057\u3001\u914d\u5217\u306b\u4fdd\u5b58\u3057\u3066\u304a\u304d\u307e\u3059\n 3. foreach\u3067\u307e\u308f\u3057\u3066\u3044\u304d\u3001\u30aa\u30ea\u30b8\u30ca\u30eb\u3068\u30b5\u30e0\u30cd\u30a4\u30eb\u30d5\u30a1\u30a4\u30eb\u3092\u524a\u9664\u3057\u3066\u3044\u304d\u307e\u3059\n 4. resId \u304c0 \u3067\u306a\u3044\u5834\u5408\u3001$del_post->img_name\u3068\u4e00\u81f4\u3059\u308b\u30d5\u30a1\u30a4\u30eb\u3092\u524a\u9664\u3057\u307e\u3059\n\nphp.src/Controller/PostsController.php\n~~\n//\u753b\u50cf\u524a\u9664\u306e\u305f\u3081\nuse Cake\\Filesystem\\Folder;\nuse Cake\\Filesystem\\File;\n~~\n    public function delete($id = null)\n    {\n        $this->request->allowMethod(['post', 'delete']);\n        $del_post = $this->Posts->get($id);\n        if($del_post->resId === 0) {                                          //1\n            //\u30d5\u30a1\u30a4\u30eb\u524a\u9664\u7528\u306b\u524a\u9664\u3059\u308b\u30d5\u30a1\u30a4\u30eb\u540d\u3092\u8a70\u3081\u305f del_imgs \u3092\u4f5c\u6210\u3000\u3000\u3000\u3000\u3000\u3000\u3000 //2\n            $query = $this->Posts->find()\n                ->where(['postId =' => $del_post->postId])\n                ->select(['img_name'])\n                ;\n            $del_imgs = [];\n            foreach($query as $q) array_push($del_imgs, $q->img_name);\n            //-----------------------------------------------------------\n\n            if ($this->Posts->deleteAll(array('postId' => $del_post->postId))) {\n                //\u30d5\u30a1\u30a4\u30eb\u524a\u9664-----\u3000\u3000\u3000\u3000\u3000\u3000\u3000\u3000\u3000\u3000\u3000\u3000\u3000\u3000\u3000\u3000\u3000\u3000\u3000\u3000\u3000\u3000\u3000\u3000//3\n                foreach($del_imgs as $q) {\n                    $file = new File(WWW_ROOT.'img/'.$q);\n                    $file->delete();\n                    $file = new File(WWW_ROOT.'img/mini/'.$q);\n                    $file->delete();\n                }\n                //-----------------\n                $this->Flash->success(__('\u6295\u7a3f\u304c\u524a\u9664\u3055\u308c\u307e\u3057\u305f.'));\n            } else {\n                $this->Flash->error(__('\u6295\u7a3f\u304c\u524a\u9664\u3055\u308c\u307e\u305b\u3093\u3067\u3057\u305f. \u3082\u3046\u4e00\u5ea6\u304a\u8a66\u3057\u4e0b\u3055\u3044.'));\n            }\n            return $this->redirect(['action' => 'index']);\n        }\n        else if ($this->Posts->delete($del_post)) {\n            //\u30d5\u30a1\u30a4\u30eb\u524a\u9664-----\u3000\u3000\u3000\u3000\u3000\u3000\u3000\u3000\u3000\u3000\u3000\u3000\u3000\u3000\u3000\u3000\u3000\u3000\u3000\u3000\u3000\u3000\u3000\u3000\u3000\u3000//4\n            $file = new File(WWW_ROOT.'img/'.$del_post->img_name);\n            $file->delete();\n            $file = new File(WWW_ROOT.'img/mini/'.$del_post->img_name);\n            $file->delete();\n            //-----------------\n            $this->Flash->success(__('\u6295\u7a3f\u304c\u524a\u9664\u3055\u308c\u307e\u3057\u305f.'));\n        } else {\n            $this->Flash->error(__('\u6295\u7a3f\u304c\u524a\u9664\u3055\u308c\u307e\u305b\u3093\u3067\u3057\u305f. \u3082\u3046\u4e00\u5ea6\u304a\u8a66\u3057\u4e0b\u3055\u3044.'));\n        }\n        return $this->redirect($this->referer());\n    }\n~~\n\n\n\u4f3c\u305f\u3088\u3046\u306a\u51e6\u7406\u304c\u3044\u304f\u3064\u304b\u6563\u3089\u3070\u3063\u3066\u3044\u308b\u306e\u3067\u3001\u4e0a\u624b\u304f\u30ea\u30d5\u30a1\u30af\u30bf\u30ea\u30f3\u30b0\u3057\u305f\u3044\u3067\u3059\u3002\n\u3068\u308a\u3042\u3048\u305a\u3001\u4ee5\u4e0a\u3067\u6295\u7a3f\u3092\u524a\u9664\u3057\u305f\u969b\u306b\u3001\u753b\u50cf\u30d5\u30a1\u30a4\u30eb\u3082\u4e00\u7dd2\u306b\u524a\u9664\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3057\u305f\u3002\n\n\u307e\u3068\u3081\n\u3068\u308a\u3042\u3048\u305a\u5b9f\u88c5\u3067\u304d\u307e\u3057\u305f\u304c\u3001\n- \u30b5\u30e0\u30cd\u30a4\u30eb\u751f\u6210\u306e\u51e6\u7406\u304c\u30d6\u30b5\u30a4\u30af\n- \u524a\u9664\u30a2\u30af\u30b7\u30e7\u30f3\u304c\u30d6\u30b5\u30a4\u30af\n\u7b49\u554f\u984c\u304c\u3042\u308b\u306e\u3067\u3001\u4f55\u304b\u30a2\u30c9\u30d0\u30a4\u30b9\u304c\u3042\u308a\u307e\u3057\u305f\u3089\u30b3\u30e1\u30f3\u30c8\u6b04\u306b\u3066\u304a\u9858\u3044\u3044\u305f\u3057\u307e\u3059m(__)m\n[\u7b2c\u4e8c\u56de](http://qiita.com/banaba0207/items/b05f0942d39792c412c5)\u306b\u5f15\u304d\u7d9a\u304d\u3001\u63b2\u793a\u677f\u306e\u4f5c\u6210\u3092\u884c\u3063\u3066\u3044\u304d\u307e\u3059\u3002\n\u4eca\u56de\u306f\n - \u753b\u50cf\u6295\u7a3f\u6a5f\u80fd\u306e\u5b9f\u88c5\n\u3092\u884c\u3063\u3066\u3044\u304d\u307e\u3059\u3002\n\n#\u76ee\u6b21\n[~\u7b2c\u4e00\u56de CRUD\u306e\u5b9f\u88c5~](http://qiita.com/banaba0207/items/3610f3f24f4f03e3b93f)\n[~\u7b2c\u4e8c\u56de paginate, \u30ca\u30d3\u30b2\u30fc\u30b7\u30e7\u30f3\u30d0\u30fc\u306e\u5b9f\u88c5~](http://qiita.com/banaba0207/items/b05f0942d39792c412c5)\n[~\u7b2c\u4e09\u56de \u753b\u50cf\u6295\u7a3f\u6a5f\u80fd\u306e\u5b9f\u88c5~](http://qiita.com/banaba0207/items/6cee4cd74b9231ca52c4)\n[~\u7b2c\u56db\u56de \u30c9\u30e9\u30c3\u30b0\u30a2\u30f3\u30c9\u30c9\u30ed\u30c3\u30d7(DnD)\u3067\u306e\u753b\u50cf\u6dfb\u4ed8 ~](http://qiita.com/banaba0207/items/ec5dd68413534eef938a)\n\n#\u65b9\u91dd\n - input\u30d5\u30a9\u30fc\u30e0\u304b\u3089\u753b\u50cf\u3092\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u3059\u308b\n    - \u5f62\u5f0f\u306f ipg, png, gif\u306e\u307f\uff08\u6700\u5927\u30b5\u30a4\u30ba 10M\uff09\n - DB\u306b\u306f\u4ee5\u4e0b\u306e\u9805\u76ee\u3092\u683c\u7d0d\u3059\u308b\n    - img_name (\u30e6\u30cb\u30fc\u30af\u306a\u540d\u524d)\n    - img_ext (\u30d5\u30a1\u30a4\u30eb\u306e\u62e1\u5f35\u5b50)\n    - img_size (\u30d5\u30a1\u30a4\u30eb\u306e\u5bb9\u91cf)\n- \u30d5\u30a1\u30a4\u30eb\u306f\u30e6\u30cb\u30fc\u30af\u306a\u540d\u524d\u3092\u3064\u3051\u3066\u30ed\u30fc\u30ab\u30eb\uff08webroot/img\u4ee5\u4e0b\uff09\u306b\u4fdd\u5b58\u3059\u308b\n    - \u305d\u306e\u969b\u3001\u30b5\u30e0\u30cd\u30a4\u30eb\u3082\u751f\u6210\u3059\u308b\n    - webroot/img/mini\u4ee5\u4e0b\u306b\u4fdd\u5b58\n- \u8868\u793a\u3059\u308b\u969b\u306f\u30b5\u30e0\u30cd\u30a4\u30eb\u3067\u8868\u793a\u3057\u3001\u753b\u50cf\u304c\u30af\u30ea\u30c3\u30af\u3055\u308c\u305f\u969b\u306blightbox\u5f62\u5f0f\u3067\u8868\u793a\u3059\u308b\n\n#\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u30d5\u30a9\u30fc\u30e0\u306e\u5b9f\u88c5\n\u524d\u56de\u4f5c\u6210\u3057\u305fform\u30a8\u30ec\u30e1\u30f3\u30c8\u3092\u5c11\u3057\u7de8\u96c6\u3057\u307e\u3059\u3002\n\n```php.src/Template/Element/form.ctp\n<?= $this->Form->create($post, array(\n    'url' => array('action' => $action),\n    'type' => 'file',                     //add\n    )) ?>\n<fieldset>\n<?php\n        echo $this->Form->hidden('postId');\n        echo $this->Form->hidden('resId');\n        echo $this->Form->input('title');\n        echo $this->Form->input('name');\n        echo $this->Form->input('content');\n        echo $this->Form->file('img');     //add\n        echo \"<br>\";\n    ?>\n</fieldset>\n<?= $this->Form->button(__('\u6295\u7a3f\u3059\u308b')) ?>\n<?= $this->Form->end() ?>\n```\n\n\u4ee5\u4e0a\u3067\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u30d5\u30a9\u30fc\u30e0\u304c\u751f\u6210\u3055\u308c\u307e\u3059\u3002\n\n#\u753b\u50cf\u306e\u4fdd\u5b58\n\u30d6\u30b5\u30a4\u30af\u306a\u3084\u308a\u65b9\u3067\u3059\u304c\u3001\u3054\u5bb9\u8d66\u4e0b\u3055\u3044\u3002\n\n- \u30e2\u30c7\u30eb\u306e\u4fee\u6b63\n    - jpg, png, gif\u4ee5\u5916\u306e\u62e1\u5f35\u5b50\u306e\u5834\u5408\u3001\u30d0\u30ea\u30c7\u30fc\u30b7\u30e7\u30f3\u30a8\u30e9\u30fc\u3092\u8fd4\u3059\u3088\u3046\u306b\u4fee\u6b63\n    - \u30d5\u30a1\u30a4\u30eb\u30b5\u30a4\u30ba\u304c10M\u4ee5\u4e0a\u306e\u5834\u5408\u3001\u30d0\u30ea\u30c7\u30fc\u30b7\u30e7\u30f3\u30a8\u30e9\u30fc\u3092\u8fd4\u3059\u3088\u3046\u306b\u4fee\u6b63\n\n```php.src/Model/Table/PostsTable.php\n~~\n        $validator\n            ->allowEmpty('img_ext')\n            ->add('img_ext', ['list' => [\n                'rule' => ['inList', ['jpg', 'png', 'gif']],\n                'message' => 'jpg, png, gif \u306e\u307f\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u53ef\u80fd\u3067\u3059.',\n            ]]);\n\n        $validator\n            ->integer('img_size')\n            ->allowEmpty('img_size')\n            ->add('img_size', 'comparison', [\n                'rule' => ['comparison', '<', 10485760],\n                'message' => '\u30d5\u30a1\u30a4\u30eb\u30b5\u30a4\u30ba\u304c\u8d85\u904e\u3057\u3066\u3044\u307e\u3059(MaxSize:10M)',\n            ]);\n~~\n```\n\n- \u30b3\u30f3\u30dd\u30fc\u30cd\u30f3\u30c8\u306e\u4f5c\u6210\n    - add, edit \u30a2\u30af\u30b7\u30e7\u30f3\u306e\u4e21\u65b9\u3067\u7528\u3044\u308b\u306e\u3067\u3001\u30b3\u30f3\u30dd\u30fc\u30cd\u30f3\u30c8\u5316\u3057\u3001\u4f7f\u3044\u307e\u308f\u305b\u308b\u3088\u3046\u306b\u3057\u307e\u3059\n    - \u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u30fc\u304b\u3089save\u30e1\u30bd\u30c3\u30c9\u3092\u547c\u3073\u51fa\u3059\u3053\u3068\u3067\u4ee5\u4e0b\u306e\u3053\u3068\u3092\u884c\u3044\u307e\u3059\n        - $post\u306b img_name, img_size, img_ext\u3092\u8a2d\u5b9a\n            - md5(uniqid(rand(), 1))\u306b\u3088\u308a\u3001\u30e6\u30cb\u30fc\u30af\u306a\u6587\u5b57\u5217\u3092\u751f\u6210\u3057\u3001name\u306b\u8a2d\u5b9a\u3057\u3066\u3044\u307e\u3059\n        - \u753b\u50cf\u3092\u30ed\u30fc\u30ab\u30eb\u306b\u4fdd\u5b58\n    - \u203b\u30b5\u30e0\u30cd\u30a4\u30eb\u751f\u6210\u306e\u3068\u3053\u308d\u304c\u3084\u3084\u3053\u3057\u3059\u304e\u308b\u306e\u3067\u3001\u3088\u308a\u826f\u3044\u65b9\u6cd5\u3092\u601d\u6848\u4e2d\n\n```php.src/Controller/Component/ImgProcessComponent.php\n<?php\nnamespace App\\Controller\\Component;\n\nuse Cake\\Controller\\Component;\nuse Cake\\Controller\\ComponentRegistry;\n\n/**\n * ImgProcess component\n */\nclass ImgProcessComponent extends Component\n{\n    function initialize(array $config) {\n        $this->controller = $this->_registry->getController();\n    }\n    \n    //validation\u9069\u7528\u306e\u305f\u3081\u3001rquest\u306b img_name, img_ext, img_size\u3092\u8a70\u3081\u308b\n    function save($request) {\n        $img = $request->data['img'];\n        $ext =  pathinfo($img['name'], PATHINFO_EXTENSION);\n        $name = md5(uniqid(rand(), 1)).'.'.$ext;\n        $request->data['img_ext'] = $ext;\n        $request->data['img_size'] = $img['size'];\n        $request->data['img_name'] = $name;\n    }\n\n    //\u30aa\u30ea\u30b8\u30ca\u30eb\u3068\u30b5\u30e0\u30cd\u30a4\u30eb\u4f5c\u6210\n    function generate($tmp_name, $post) {\n        move_uploaded_file($tmp_name, 'img/'.$post->img_name);\n        $original_file = 'img/'.$post->img_name;;\n        list($original_width, $original_height) = getimagesize($original_file);\n        $thumb_width = 300;\n        $thumb_height = round( $original_height * $thumb_width / $original_width );\n        if($post->img_ext === 'jpg') $original_image = imagecreatefromjpeg($original_file);\n        if($post->img_ext === 'png') $original_image = imagecreatefrompng($original_file);\n        if($post->img_ext === 'gif') $original_image = imagecreatefromgif($original_file);\n        $thumb_image = imagecreatetruecolor($thumb_width, $thumb_height);\n        imagecopyresized($thumb_image, $original_image, 0, 0, 0, 0,\n            $thumb_width, $thumb_height,\n            $original_width, $original_height);\n        if($post->img_ext === 'jpg') imagejpeg($thumb_image, 'img/mini/'.$post->img_name);\n        if($post->img_ext === 'png') imagepng($thumb_image, 'img/mini/'.$post->img_name);\n        if($post->img_ext === 'gif') imagegif($thumb_image, 'img/mini/'.$post->img_name);\n    }\n}\n```\n\n- controller\u306e\u4fee\u6b63\n\n```php.src/Controller/PostsController.php\n~~\n    public $components = array(\n        'ImgProcess' => array(),\n    );\n~~\n    public function add()\n    {\n        $post = $this->Posts->newEntity();\n        if ($this->request->is('post')) {\n            //\u8ffd\u52a0\uff08validation\u9069\u7528\u306e\u305f\u3081\u3001request\u306b\u8272\u3005\u8a70\u3081\u308b\u51e6\u7406\uff09--------------\n            if(!empty($this->request->data['img']['name'])) {\n                $this->ImgProcess->save($this->request);\n            }\n            //------------------------------------------------------------\n            $post = $this->Posts->patchEntity($post, $this->request->data);\n            if ($post->postId == -1) {\n                $post->postId = $this->Posts->find()\n                    ->order(['postId' => 'desc'])\n                    ->select(['postId'])\n                    ->first()['postId'] + 1;\n                $post->resId = 0;\n            }\n            if ($post->name === '') $post->name = '\u540d\u7121\u3057\u3055\u3093';\n            if ($this->Posts->save($post)) {\n               //\u8ffd\u52a0(\u30ed\u30fc\u30ab\u30eb\u306b\u4fdd\u5b58\uff06\u30b5\u30e0\u30cd\u30a4\u30eb\u751f\u6210)-------------------------\n                if(!empty($this->request->data['img']['name'])) {\n                    $this->ImgProcess->generate(\n                        $this->request->data['img']['tmp_name'], $post);\n                }\n               //-------------------------------------------------------\n                $this->Flash->success(__('\u6295\u7a3f\u3055\u308c\u307e\u3057\u305f.'));\n                if ($post->resId ===0) return $this->redirect(['action' => 'index']);\n                else                   return $this->redirect($this->referer());\n            } else {\n                //validation error\u306e\u8868\u793a\u6e96\u5099--------------------------------------------\n                if($post->errors()['img_ext'])\n                    $this->Flash->error(__($post->errors()['img_ext']['list']));\n                if($post->errors()['img_size'])\n                    $this->Flash->error(__($post->errors()['img_size']['comparison']));\n                //--------------------------------------------------------------------\n                $this->Flash->error(__('\u6295\u7a3f\u3067\u304d\u307e\u305b\u3093\u3067\u3057\u305f. \u518d\u5ea6\u304a\u8a66\u3057\u4e0b\u3055\u3044.'));\n                return $this->redirect($this->referer());\n            }\n        }\n        $this->set(compact('post'));\n        $this->set('_serialize', ['post']);\n    }\n~~\n}\n```\n\u4ee5\u4e0a\u3067\u3001\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u3055\u308c\u305f\u30d5\u30a1\u30a4\u30eb\u3092\u30ed\u30fc\u30ab\u30eb\u306b\u4fdd\u5b58\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3057\u305f\u3002\n\n#\u753b\u50cf\u306e\u8868\u793a\n\n- lightbox\u306e\u5c0e\u5165\n    - \u82f1\u8a9e\u3067\u3059\u304c\u3001\u30b3\u30de\u30f3\u30c9\u3092\u8ffd\u3063\u3066\u3044\u3051\u3070\u7d44\u307f\u8fbc\u3080\u3053\u3068\u304c\u3067\u304d\u307e\u3057\u305f\n        - http://lokeshdhakar.com/projects/lightbox2/\n\n- templete\u306e\u7de8\u96c6\n    - one_article\u30a8\u30ec\u30e1\u30f3\u30c8\u3092\u7de8\u96c6\u3057\u307e\u3059\n        - $this->request->webroot \u3067webroot\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u53c2\u7167\u3059\u308bURL\u3092\u751f\u6210\u3067\u304d\u307e\u3059\n        - lightbox\u3092\u4f7f\u3046\u305f\u3081\u3001\u30bf\u30b0\u5185\u3092`<a href=\"<?= $this->request->webroot ?>img/<?= $post->img_name ?>\" data-lightbox='image-1'>`\u306e\u3088\u3046\u306b\u3057\u3066\u3044\u307e\u3059\n\n```php.src/Template/Element/one_article.ctp\n~~\n    <div class='panel-boby'>\n        <div style=\"padding:10px\">\n            <?= h($post->content) ?>\n        </div>\n        <div style=\"padding:10px\">\n            <?php if (!empty($post->img_name)): ?>\n                <a href=\"<?= $this->request->webroot ?>img/<?= $post->img_name ?>\" data-lightbox='image-1'>\n                <img src=\"<?= $this->request->webroot ?>img/mini/<?= $post->img_name ?>\"\n                   alt=\"<?= $post->img_name ?>\" height=\"200\" width=\"200\"/>\n                </a>\n            <?php endif; ?>\n        </div>\n    </div>\n~~\n```\n\n\u4ee5\u4e0a\u306b\u3088\u308a\u3001lightbox\u5f62\u5f0f\u3067\u30ed\u30fc\u30ab\u30eb\u306b\u3042\u308b\u753b\u50cf\u3092\u8868\u793a\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3057\u305f\u3002\n![\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2016-03-21 19.14.28.png](https://qiita-image-store.s3.amazonaws.com/0/111756/8fe4f91e-c159-3fe0-7d39-e79e53789959.png)\n\n#\u524a\u9664\u6a5f\u80fd\n\u6295\u7a3f\u304c\u524a\u9664\u3055\u308c\u305f\u969b\u306b\u3001\u753b\u50cf\u3082\u4e00\u7dd2\u306b\u524a\u9664\u3059\u308b\u3088\u3046\u306bdelete\u30a2\u30af\u30b7\u30e7\u30f3\u3092\u7de8\u96c6\u3057\u307e\u3059\u3002\n\u4f8b\u306b\u3088\u3063\u3066\u30d6\u30b5\u30a4\u30af\u306a\u30b3\u30fc\u30c9\u3067\u3059\u304c\u3001\u4ee5\u4e0b\u89e3\u8aac\u3067\u3059\u3002\n 1. \u524a\u9664\u5bfe\u8c61\u304c\u8fd4\u4fe1\u6295\u7a3f\u306a\u306e\u304b\u5927\u5143\u306e\u6295\u7a3f\u306a\u306e\u304b\u3092\u5224\u5225\u3057\u307e\u3059\n 2. resID=0\u306e\u5834\u5408\u3001\u3059\u3079\u3066\u306e\u8fd4\u4fe1\u6295\u7a3f\u3092\u524a\u9664\u3059\u308b\u305f\u3081\u306bpostId\u304c\u4e00\u81f4\u3059\u308b\u6295\u7a3f\u306e\u753b\u50cf\u306e\u540d\u524d\u3092\u53d6\u5f97\u3057\u3001\u914d\u5217\u306b\u4fdd\u5b58\u3057\u3066\u304a\u304d\u307e\u3059\n 3. foreach\u3067\u307e\u308f\u3057\u3066\u3044\u304d\u3001\u30aa\u30ea\u30b8\u30ca\u30eb\u3068\u30b5\u30e0\u30cd\u30a4\u30eb\u30d5\u30a1\u30a4\u30eb\u3092\u524a\u9664\u3057\u3066\u3044\u304d\u307e\u3059\n 4. resId \u304c0 \u3067\u306a\u3044\u5834\u5408\u3001`$del_post->img_name`\u3068\u4e00\u81f4\u3059\u308b\u30d5\u30a1\u30a4\u30eb\u3092\u524a\u9664\u3057\u307e\u3059\n\n\n```php.src/Controller/PostsController.php\n~~\n//\u753b\u50cf\u524a\u9664\u306e\u305f\u3081\nuse Cake\\Filesystem\\Folder;\nuse Cake\\Filesystem\\File;\n~~\n    public function delete($id = null)\n    {\n        $this->request->allowMethod(['post', 'delete']);\n        $del_post = $this->Posts->get($id);\n        if($del_post->resId === 0) {                                          //1\n            //\u30d5\u30a1\u30a4\u30eb\u524a\u9664\u7528\u306b\u524a\u9664\u3059\u308b\u30d5\u30a1\u30a4\u30eb\u540d\u3092\u8a70\u3081\u305f del_imgs \u3092\u4f5c\u6210\u3000\u3000\u3000\u3000\u3000\u3000\u3000 //2\n            $query = $this->Posts->find()\n                ->where(['postId =' => $del_post->postId])\n                ->select(['img_name'])\n                ;\n            $del_imgs = [];\n            foreach($query as $q) array_push($del_imgs, $q->img_name);\n            //-----------------------------------------------------------\n\n            if ($this->Posts->deleteAll(array('postId' => $del_post->postId))) {\n                //\u30d5\u30a1\u30a4\u30eb\u524a\u9664-----\u3000\u3000\u3000\u3000\u3000\u3000\u3000\u3000\u3000\u3000\u3000\u3000\u3000\u3000\u3000\u3000\u3000\u3000\u3000\u3000\u3000\u3000\u3000\u3000//3\n                foreach($del_imgs as $q) {\n                    $file = new File(WWW_ROOT.'img/'.$q);\n                    $file->delete();\n                    $file = new File(WWW_ROOT.'img/mini/'.$q);\n                    $file->delete();\n                }\n                //-----------------\n                $this->Flash->success(__('\u6295\u7a3f\u304c\u524a\u9664\u3055\u308c\u307e\u3057\u305f.'));\n            } else {\n                $this->Flash->error(__('\u6295\u7a3f\u304c\u524a\u9664\u3055\u308c\u307e\u305b\u3093\u3067\u3057\u305f. \u3082\u3046\u4e00\u5ea6\u304a\u8a66\u3057\u4e0b\u3055\u3044.'));\n            }\n            return $this->redirect(['action' => 'index']);\n        }\n        else if ($this->Posts->delete($del_post)) {\n            //\u30d5\u30a1\u30a4\u30eb\u524a\u9664-----\u3000\u3000\u3000\u3000\u3000\u3000\u3000\u3000\u3000\u3000\u3000\u3000\u3000\u3000\u3000\u3000\u3000\u3000\u3000\u3000\u3000\u3000\u3000\u3000\u3000\u3000//4\n            $file = new File(WWW_ROOT.'img/'.$del_post->img_name);\n            $file->delete();\n            $file = new File(WWW_ROOT.'img/mini/'.$del_post->img_name);\n            $file->delete();\n            //-----------------\n            $this->Flash->success(__('\u6295\u7a3f\u304c\u524a\u9664\u3055\u308c\u307e\u3057\u305f.'));\n        } else {\n            $this->Flash->error(__('\u6295\u7a3f\u304c\u524a\u9664\u3055\u308c\u307e\u305b\u3093\u3067\u3057\u305f. \u3082\u3046\u4e00\u5ea6\u304a\u8a66\u3057\u4e0b\u3055\u3044.'));\n        }\n        return $this->redirect($this->referer());\n    }\n~~\n```\n\u4f3c\u305f\u3088\u3046\u306a\u51e6\u7406\u304c\u3044\u304f\u3064\u304b\u6563\u3089\u3070\u3063\u3066\u3044\u308b\u306e\u3067\u3001\u4e0a\u624b\u304f\u30ea\u30d5\u30a1\u30af\u30bf\u30ea\u30f3\u30b0\u3057\u305f\u3044\u3067\u3059\u3002\n\u3068\u308a\u3042\u3048\u305a\u3001\u4ee5\u4e0a\u3067\u6295\u7a3f\u3092\u524a\u9664\u3057\u305f\u969b\u306b\u3001\u753b\u50cf\u30d5\u30a1\u30a4\u30eb\u3082\u4e00\u7dd2\u306b\u524a\u9664\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3057\u305f\u3002\n\n#\u307e\u3068\u3081\n\u3068\u308a\u3042\u3048\u305a\u5b9f\u88c5\u3067\u304d\u307e\u3057\u305f\u304c\u3001\n- \u30b5\u30e0\u30cd\u30a4\u30eb\u751f\u6210\u306e\u51e6\u7406\u304c\u30d6\u30b5\u30a4\u30af\n- \u524a\u9664\u30a2\u30af\u30b7\u30e7\u30f3\u304c\u30d6\u30b5\u30a4\u30af\n\n\u7b49\u554f\u984c\u304c\u3042\u308b\u306e\u3067\u3001\u4f55\u304b\u30a2\u30c9\u30d0\u30a4\u30b9\u304c\u3042\u308a\u307e\u3057\u305f\u3089\u30b3\u30e1\u30f3\u30c8\u6b04\u306b\u3066\u304a\u9858\u3044\u3044\u305f\u3057\u307e\u3059m(__)m\n", "tags": ["cakephp3"]}