{"context": " More than 1 year has passed since last update.\u4ffa\u3067\u3059\u3002\nRedis\u30d0\u30fc\u30b8\u30e7\u30f3: 3.0.5\nRedis\u5185\u306e\u30c7\u30fc\u30bf\u304cnGB\u8d85\u3048\u3066\u3044\u305f\u306e\u3067\u30c1\u30e5\u30fc\u30cb\u30f3\u30b0\u3059\u308b\u3002\nrepl-timeout\u306fRedis\u306e\u30c7\u30fc\u30bf\u30b5\u30a4\u30ba\u306b\u5fdc\u3058\u3066\u9577\u3081\u306b\u8a2d\u5b9a\u3057\u305f\u3082\u306e\u306e\u3001\nslave\u518d\u63a5\u7d9a\u6642\u306bmaster\u3067\u5b9f\u884c\u3055\u308c\u308bdisk\u51fa\u529b\u306ebgsave\u3092\u6291\u3048\u308b\u65b9\u6cd5\u304c\u3042\u3063\u305f\u306e\u3067\u691c\u8a3c\u3057\u305f\u3002\n\u53c2\u8003 m(__)m\n\n\u691c\u8a3c\u7d50\u679c\n\nnGB\u8d85\u306e\u30c7\u30fc\u30bf\u3092\u6271\u3046\u969b\u306f\u30c7\u30a3\u30b9\u30af\u30ec\u30b9\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u304c\u6709\u52b9\u3067\u3059\u3002\n\u30c7\u30a3\u30b9\u30af\u30ec\u30b9\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3067\u3042\u308c\u3070master\u3067\u4e00\u6642\u30c0\u30f3\u30d7\u306f\u51fa\u529b\u3055\u308c\u306a\u3044\u306e\u3067cached memory\u306f\u6d88\u8cbb\u3057\u307e\u305b\u3093\n\u30c7\u30d5\u30a9\u30eb\u30c8\u306e\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306b\u6bd4\u3079\u3066Full sync\u306e\u6642\u9593\u304c1/2\u306b\u306a\u308a\u307e\u3057\u305f\u3002\n\u672c\u4f8b(master/slave\u95a2\u4fc2)\u3067\u306fmaster\u306e\u30ce\u30fc\u30c9\u306b\u306e\u307f\u30c7\u30a3\u30b9\u30af\u30ec\u30b9\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u30bb\u30c3\u30c8\u3057\u307e\u3057\u305f\u304c\u3001Sentinel\u3092\u5229\u7528\u3059\u308b\u5834\u5408\u306f\u5168Redis\u30ce\u30fc\u30c9\u306b\u5bfe\u3057\u3066\u8a2d\u5b9a\u3057\u3066\u304a\u304f\u306e\u304c\u826f\u3044\u3068\u601d\u3044\u307e\u3059\n\n\n\u6e96\u5099\n\u30bf\u30fc\u30b2\u30c3\u30c8\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\n\nr3.xlarge\n\n\u30c7\u30fc\u30bf\u30b5\u30a4\u30ba\n\nRedis\u306e\u30c7\u30fc\u30bf\u306fYCSB\u3067\u4f5c\u3063\u305f\u30c0\u30df\u30fc\u30c7\u30fc\u30bf.\u30b5\u30a4\u30ba 20GB\n\u30ab\u30fc\u30cd\u30eb\u30d1\u30e9\u30e1\u30fc\u30bf\n\nmaster/slave\u5171\u306b\u4e0b\u8a18\u304c\u6709\u52b9\nvm.swappiness=1\nvm.overcommit_memory=1\n\n\nredis.conf(master/slave)\n\n\u30c7\u30d5\u30a9\u30eb\u30c8\u5024\u306brepl-timeout\u3092\u8ffd\u52a0\nrepl-timeout 1800\n\n\nredis.conf(slave)\n\nslaveof <master ipaddr> 6379\n\n\n\u901a\u5e38\u306ereplication\n\n\u691c\u8a3c\u624b\u9806\n\nRedis master\u3092\u8d77\u52d5\u3057\u300120GB\u306e\u30c7\u30fc\u30bf\u3092\u30ed\u30fc\u30c9\u3059\u308b\nRedis slave\u3092\u8d77\u52d5\u3057\u3001Redis master\u3068\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3059\u308b\nps aux|grep redis, redis-cli info\u3068redis.log\u3092\u78ba\u8a8d\u3059\u308b\n\nmaster\u306e\u6319\u52d5\n\nslave\u3092\u8d77\u52d5\u3057\u3066master\u3078\u63a5\u7d9a\u3059\u308b\u6642\u306bmaster\u3067bgsave\u3092\u5b9f\u884c\u3059\u308b\n\nFull resync target: disk\u3068\u306a\u3063\u3066\u3044\u308b\n\u4e00\u5ea6master\u3067rdb\u30d5\u30a1\u30a4\u30eb\u3092\u51fa\u529b/\u4f5c\u6210\u3057\u3001slave\u306erdb\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3078\u8ee2\u9001\u3057\u3066\u3044\u308b\u6a21\u69d8\n\nmaster\u306e\u30d7\u30ed\u30bb\u30b9\u78ba\u8a8d\n\nmaster\u3067\u306fbgsave\u304c\u52d5\u4f5c\u3057\u3066\u3044\u308b\n[root@ip-172-31-5-23 lib]# ps aux|grep redis\nredis     6921 13.3 64.8 20516304 20375152 ?   Ssl  02:34   1:18 /usr/bin/redis-server *:6379\nroot      6958  0.0  0.0 107932   616 pts/1    S+   02:39   0:00 tail -f redis.log\nredis     6969 95.4 64.8 20516692 20374780 ?   R    02:43   0:42 redis-rdb-bgsave *:6379\nroot      6975  0.0  0.0 114632   920 pts/0    S+   02:43   0:00 grep redis\n\n6921:M 30 Nov 02:43:08.540 - Accepted 172.31.13.112:34156\n6921:M 30 Nov 02:43:08.541 * Slave 172.31.13.112:6379 asks for synchronization\n6921:M 30 Nov 02:43:08.541 * Full resync requested by slave 172.31.13.112:6379\n6921:M 30 Nov 02:43:08.541 * Starting BGSAVE for SYNC with target: disk\n6921:M 30 Nov 02:43:08.778 * Background saving started by pid 6969\n..\u7701\u7565\n6921:M 30 Nov 02:51:40.880 * Synchronization with slave 172.31.13.112:6379 succeeded\n\n\nslave\u306e\u6319\u52d5\n\nredis.log\n\n3099:S 30 Nov 02:43:08.530 * Connecting to MASTER 172.31.5.23:6379\n3099:S 30 Nov 02:43:08.530 * MASTER <-> SLAVE sync started\n3099:S 30 Nov 02:43:08.530 * Non blocking connect for SYNC fired the event.\n3099:S 30 Nov 02:43:08.530 * Master replied to PING, replication can continue...\n3099:S 30 Nov 02:43:08.530 * Partial resynchronization not possible (no cached master)\n3099:S 30 Nov 02:43:08.769 * Full resync from master: 61865c4afa66868ceee549a5fb1ebfc1020e934a:1\n..\u7701\u7565\n3099:S 30 Nov 02:51:40.977 * MASTER <-> SLAVE sync: Flushing old data\n3099:S 30 Nov 02:51:54.437 * MASTER <-> SLAVE sync: Loading DB in memory\n3099:S 30 Nov 02:53:56.212 - Accepted 127.0.0.1:42239\n3099:S 30 Nov 02:53:56.225 - Client closed connection\n3099:S 30 Nov 02:54:40.104 * MASTER <-> SLAVE sync: Finished with success\n\n\ndiskless replication\n\u4e8b\u524d\u306b\u4e0b\u8a18\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u30bb\u30c3\u30c8\u3059\u308b\n\u30d1\u30e9\u30e1\u30fc\u30bf\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u306fgithub\u3092\u53c2\u7167\n\n\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u306e\u8abf\u6574\nredis-cli CONFIG SET repl-timeout \"1800\"\n\n\u30c7\u30a3\u30b9\u30af\u30ec\u30b9\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u6709\u52b9\u5316\nredis-cli CONFIG SET repl-diskless-sync \"yes\"\n\nrepl-diskless-sync-delay\u30920\u306b\u3059\u308b\n\u30b9\u30ec\u30fc\u30d6\u63a5\u7d9a\u6642\u306e\u5f85\u3061\u6642\u9593\u3092\u306a\u3057\u306b\u3059\u308b\u3002\nredis-cli CONFIG SET repl-diskless-sync-delay 0\n\n\u30d0\u30c3\u30d5\u30a1\u30ea\u30df\u30c3\u30c8\u3092\u7121\u52b9\u5316\n\u30af\u30e9\u30a4\u30a2\u30f3\u30c8(slave)\u304c\u5f37\u5236\u5207\u65ad\u3055\u308c\u306a\u3044\u3088\u3046\u306b\u30d0\u30c3\u30d5\u30a1\u30ea\u30df\u30c3\u30c8\u3092\u7121\u52b9\u306b\u3059\u308b\nredis-cli CONFIG SET client-output-buffer-limit \"slave 0 0 0\"\n\nmaster\u306e\u6319\u52d5\n\nslave\u3092\u8d77\u52d5\u3057\u3066master\u3078\u63a5\u7d9a\u3059\u308b\u6642\u306bmaster\u3067bgsave\u3092\u5b9f\u884c\u3059\u308b\nmaster\u306e\u30d7\u30ed\u30bb\u30b9\u78ba\u8a8d\n\nmaster\u3067\u306fredis-rdb-to-slaves\u304c\u52d5\u4f5c\u3057\u3066\u3044\u308b\n[root@ip-172-31-5-23 lib]# ps aux|grep redis\nredis     6921  5.1 64.8 20516304 20375188 ?   Ssl  02:34   1:31 /usr/bin/redis-server *:6379\nredis     7103 79.4 64.8 20516688 20374632 ?   R    03:01   1:48 redis-rdb-to-slaves *:6379\nroot      7115  0.0  0.0 114632   924 pts/0    R+   03:03   0:00 grep redis\n\n\nredis.log\n\nStarting BGSAVE for SYNC with target: slaves sockets\u3068\u306a\u3063\u3066\u3044\u308b\nslave\u306esocket\u3078\u76f4\u63a5BGSAVE\u306e\u30c0\u30f3\u30d7\u3092\u8ee2\u9001\u3057\u3066\u3044\u308b\u6a21\u69d8\n6921:M 30 Nov 03:01:34.496 # Connection with slave client id #33 lost.\n6921:M 30 Nov 03:01:34.522 - Accepted 172.31.13.112:34189\n6921:M 30 Nov 03:01:34.522 * Slave 172.31.13.112:6379 asks for synchronization\n6921:M 30 Nov 03:01:34.522 * Full resync requested by slave 172.31.13.112:6379\n6921:M 30 Nov 03:01:35.220 * Starting BGSAVE for SYNC with target: slaves sockets\n6921:M 30 Nov 03:01:35.459 * Background RDB transfer started by pid 7103\n6921:M 30 Nov 03:05:03.333 * Background RDB transfer terminated with success\n6921:M 30 Nov 03:05:03.333 # Slave 172.31.13.112:6379 correctly received the streamed RDB file.\n6921:M 30 Nov 03:05:03.333 * Streamed RDB transfer with slave 172.31.13.112:6379 succeeded (socket). Waiting for REPLCONF ACK from slave to\nenable streaming\n..\u7701\u7565..\n6921:M 30 Nov 03:06:19.609 * Synchronization with slave 172.31.13.112:6379 succeeded\n\n\nslave\u306eredis.log\n3305:S 30 Nov 03:01:34.514 * Connecting to MASTER 172.31.5.23:6379\n3305:S 30 Nov 03:01:34.514 * MASTER <-> SLAVE sync started\n3305:S 30 Nov 03:01:34.515 * Non blocking connect for SYNC fired the event.\n3305:S 30 Nov 03:01:34.515 * Master replied to PING, replication can continue...\n3305:S 30 Nov 03:01:34.515 * Partial resynchronization not possible (no cached master)\n3305:S 30 Nov 03:01:35.213 * Full resync from master: 61865c4afa66868ceee549a5fb1ebfc1020e934a:1429\n3305:S 30 Nov 03:01:35.454 * MASTER <-> SLAVE sync: receiving streamed RDB from master\n..\u7701\u7565..\n3305:S 30 Nov 03:05:02.855 * MASTER <-> SLAVE sync: Flushing old data\n3305:S 30 Nov 03:05:02.855 * MASTER <-> SLAVE sync: Loading DB in memory\n3305:S 30 Nov 03:06:19.096 * MASTER <-> SLAVE sync: Finished with success\n\n\n\u53c2\u8003 Redis Full resync\u4e2d\u306eslave\u30b9\u30c6\u30fc\u30bf\u30b9\u9077\u79fb\nredis-cli info replication \u306e\u7d50\u679c\n\nmaster\u3067\u5b9f\u884c\n\nMaster bgsave\u4e2d\u306e\u30b9\u30c6\u30fc\u30bf\u30b9\nslave\u306fwait_bgsave\u306b\u306a\u3063\u3066\u3044\u308b\n# Replication\nrole:master\nconnected_slaves:1\nslave0:ip=172.31.13.112,port=6379,state=wait_bgsave,offset=0,lag=0\nmaster_repl_offset:253\nrepl_backlog_active:1\nrepl_backlog_size:1048576\nrepl_backlog_first_byte_offset:2\nrepl_backlog_histlen:252\n\n\u2193\nbgsave\u5b8c\u4e86\u5f8c\u3001\u30d0\u30eb\u30af\u30ed\u30fc\u30c9\u304c\u958b\u59cb\u3055\u308c\u308b\u3002\nsend_bulk\u306b\u5909\u66f4\u3055\u308c\u308b\n[root@ip-172-31-5-23 lib]# redis-cli info replication\n# Replication\nrole:master\nconnected_slaves:1\nslave0:ip=172.31.13.112,port=6379,state=send_bulk,offset=0,lag=0\nmaster_repl_offset:337\nrepl_backlog_active:1\nrepl_backlog_size:1048576\nrepl_backlog_first_byte_offset:2\nrepl_backlog_histlen:336\n\n\u2193\nonline\u306b\u5909\u66f4\u3055\u308c\u308b\n[root@ip-172-31-5-23 lib]# redis-cli info replication\n# Replication\nrole:master\nconnected_slaves:1\nslave0:ip=172.31.13.112,port=6379,state=online,offset=1051,lag=1\nmaster_repl_offset:1051\nrepl_backlog_active:1\nrepl_backlog_size:1048576\nrepl_backlog_first_byte_offset:2\nrepl_backlog_histlen:1050\n\n\n\n\u4ffa\u3067\u3059\u3002\nRedis\u30d0\u30fc\u30b8\u30e7\u30f3: 3.0.5\n\nRedis\u5185\u306e\u30c7\u30fc\u30bf\u304cnGB\u8d85\u3048\u3066\u3044\u305f\u306e\u3067\u30c1\u30e5\u30fc\u30cb\u30f3\u30b0\u3059\u308b\u3002\nrepl-timeout\u306fRedis\u306e\u30c7\u30fc\u30bf\u30b5\u30a4\u30ba\u306b\u5fdc\u3058\u3066\u9577\u3081\u306b\u8a2d\u5b9a\u3057\u305f\u3082\u306e\u306e\u3001\nslave\u518d\u63a5\u7d9a\u6642\u306bmaster\u3067\u5b9f\u884c\u3055\u308c\u308bdisk\u51fa\u529b\u306ebgsave\u3092\u6291\u3048\u308b\u65b9\u6cd5\u304c\u3042\u3063\u305f\u306e\u3067\u691c\u8a3c\u3057\u305f\u3002\n\n[\u53c2\u8003](http://takeshiyako.blogspot.jp/2015/04/bigdata-redis-replication.html) m(__)m\n\n# \u691c\u8a3c\u7d50\u679c\n\n- nGB\u8d85\u306e\u30c7\u30fc\u30bf\u3092\u6271\u3046\u969b\u306f\u30c7\u30a3\u30b9\u30af\u30ec\u30b9\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u304c\u6709\u52b9\u3067\u3059\u3002\n- \u30c7\u30a3\u30b9\u30af\u30ec\u30b9\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3067\u3042\u308c\u3070master\u3067\u4e00\u6642\u30c0\u30f3\u30d7\u306f\u51fa\u529b\u3055\u308c\u306a\u3044\u306e\u3067`cached memory`\u306f\u6d88\u8cbb\u3057\u307e\u305b\u3093\n- \u30c7\u30d5\u30a9\u30eb\u30c8\u306e\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306b\u6bd4\u3079\u3066Full sync\u306e\u6642\u9593\u304c1/2\u306b\u306a\u308a\u307e\u3057\u305f\u3002\n- \u672c\u4f8b(master/slave\u95a2\u4fc2)\u3067\u306fmaster\u306e\u30ce\u30fc\u30c9\u306b\u306e\u307f\u30c7\u30a3\u30b9\u30af\u30ec\u30b9\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u30bb\u30c3\u30c8\u3057\u307e\u3057\u305f\u304c\u3001Sentinel\u3092\u5229\u7528\u3059\u308b\u5834\u5408\u306f\u5168Redis\u30ce\u30fc\u30c9\u306b\u5bfe\u3057\u3066\u8a2d\u5b9a\u3057\u3066\u304a\u304f\u306e\u304c\u826f\u3044\u3068\u601d\u3044\u307e\u3059\n\n\n# \u6e96\u5099\n\n\u30bf\u30fc\u30b2\u30c3\u30c8\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\n\n- r3.xlarge\n\n\u30c7\u30fc\u30bf\u30b5\u30a4\u30ba\n\n- Redis\u306e\u30c7\u30fc\u30bf\u306fYCSB\u3067\u4f5c\u3063\u305f\u30c0\u30df\u30fc\u30c7\u30fc\u30bf.\u30b5\u30a4\u30ba 20GB\n\n- \u30ab\u30fc\u30cd\u30eb\u30d1\u30e9\u30e1\u30fc\u30bf\n\nmaster/slave\u5171\u306b\u4e0b\u8a18\u304c\u6709\u52b9\n\n```\nvm.swappiness=1\nvm.overcommit_memory=1\n```\n\n- redis.conf(master/slave)\n\n\u30c7\u30d5\u30a9\u30eb\u30c8\u5024\u306brepl-timeout\u3092\u8ffd\u52a0\n\n```\nrepl-timeout 1800\n```\n\n- redis.conf(slave)\n\n```\nslaveof <master ipaddr> 6379\n```\n\n## \u901a\u5e38\u306ereplication\n\n- \u691c\u8a3c\u624b\u9806\n\nRedis master\u3092\u8d77\u52d5\u3057\u300120GB\u306e\u30c7\u30fc\u30bf\u3092\u30ed\u30fc\u30c9\u3059\u308b\nRedis slave\u3092\u8d77\u52d5\u3057\u3001Redis master\u3068\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3059\u308b\n`ps aux|grep redis`, `redis-cli info`\u3068`redis.log`\u3092\u78ba\u8a8d\u3059\u308b\n\n### master\u306e\u6319\u52d5\n\n- slave\u3092\u8d77\u52d5\u3057\u3066master\u3078\u63a5\u7d9a\u3059\u308b\u6642\u306bmaster\u3067bgsave\u3092\u5b9f\u884c\u3059\u308b\n\n`Full resync target: disk`\u3068\u306a\u3063\u3066\u3044\u308b\n\u4e00\u5ea6master\u3067rdb\u30d5\u30a1\u30a4\u30eb\u3092\u51fa\u529b/\u4f5c\u6210\u3057\u3001slave\u306erdb\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3078\u8ee2\u9001\u3057\u3066\u3044\u308b\u6a21\u69d8\n\n- master\u306e\u30d7\u30ed\u30bb\u30b9\u78ba\u8a8d\n\nmaster\u3067\u306fbgsave\u304c\u52d5\u4f5c\u3057\u3066\u3044\u308b\n\n```\n[root@ip-172-31-5-23 lib]# ps aux|grep redis\nredis     6921 13.3 64.8 20516304 20375152 ?   Ssl  02:34   1:18 /usr/bin/redis-server *:6379\nroot      6958  0.0  0.0 107932   616 pts/1    S+   02:39   0:00 tail -f redis.log\nredis     6969 95.4 64.8 20516692 20374780 ?   R    02:43   0:42 redis-rdb-bgsave *:6379\nroot      6975  0.0  0.0 114632   920 pts/0    S+   02:43   0:00 grep redis\n```\n\n```\n6921:M 30 Nov 02:43:08.540 - Accepted 172.31.13.112:34156\n6921:M 30 Nov 02:43:08.541 * Slave 172.31.13.112:6379 asks for synchronization\n6921:M 30 Nov 02:43:08.541 * Full resync requested by slave 172.31.13.112:6379\n6921:M 30 Nov 02:43:08.541 * Starting BGSAVE for SYNC with target: disk\n6921:M 30 Nov 02:43:08.778 * Background saving started by pid 6969\n..\u7701\u7565\n6921:M 30 Nov 02:51:40.880 * Synchronization with slave 172.31.13.112:6379 succeeded\n```\n\n### slave\u306e\u6319\u52d5\n\n- redis.log\n\n```\n3099:S 30 Nov 02:43:08.530 * Connecting to MASTER 172.31.5.23:6379\n3099:S 30 Nov 02:43:08.530 * MASTER <-> SLAVE sync started\n3099:S 30 Nov 02:43:08.530 * Non blocking connect for SYNC fired the event.\n3099:S 30 Nov 02:43:08.530 * Master replied to PING, replication can continue...\n3099:S 30 Nov 02:43:08.530 * Partial resynchronization not possible (no cached master)\n3099:S 30 Nov 02:43:08.769 * Full resync from master: 61865c4afa66868ceee549a5fb1ebfc1020e934a:1\n..\u7701\u7565\n3099:S 30 Nov 02:51:40.977 * MASTER <-> SLAVE sync: Flushing old data\n3099:S 30 Nov 02:51:54.437 * MASTER <-> SLAVE sync: Loading DB in memory\n3099:S 30 Nov 02:53:56.212 - Accepted 127.0.0.1:42239\n3099:S 30 Nov 02:53:56.225 - Client closed connection\n3099:S 30 Nov 02:54:40.104 * MASTER <-> SLAVE sync: Finished with success\n```\n\n\n# diskless replication\n\n\u4e8b\u524d\u306b\u4e0b\u8a18\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u30bb\u30c3\u30c8\u3059\u308b\n\u30d1\u30e9\u30e1\u30fc\u30bf\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u306f[github](https://raw.githubusercontent.com/antirez/redis/3.0/redis.conf)\u3092\u53c2\u7167\n\n### \u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u306e\u8abf\u6574\n\n```redis-cli CONFIG SET repl-timeout \"1800\"```\n\n### \u30c7\u30a3\u30b9\u30af\u30ec\u30b9\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u6709\u52b9\u5316\n\n```redis-cli CONFIG SET repl-diskless-sync \"yes\"```\n\n### repl-diskless-sync-delay\u30920\u306b\u3059\u308b\n\n\u30b9\u30ec\u30fc\u30d6\u63a5\u7d9a\u6642\u306e\u5f85\u3061\u6642\u9593\u3092\u306a\u3057\u306b\u3059\u308b\u3002\n\n```redis-cli CONFIG SET repl-diskless-sync-delay 0```\n\n### \u30d0\u30c3\u30d5\u30a1\u30ea\u30df\u30c3\u30c8\u3092\u7121\u52b9\u5316\n\n\u30af\u30e9\u30a4\u30a2\u30f3\u30c8(slave)\u304c\u5f37\u5236\u5207\u65ad\u3055\u308c\u306a\u3044\u3088\u3046\u306b\u30d0\u30c3\u30d5\u30a1\u30ea\u30df\u30c3\u30c8\u3092\u7121\u52b9\u306b\u3059\u308b\n\n```redis-cli CONFIG SET client-output-buffer-limit \"slave 0 0 0\"```\n\n## master\u306e\u6319\u52d5\n\n- slave\u3092\u8d77\u52d5\u3057\u3066master\u3078\u63a5\u7d9a\u3059\u308b\u6642\u306bmaster\u3067bgsave\u3092\u5b9f\u884c\u3059\u308b\n\n\n- master\u306e\u30d7\u30ed\u30bb\u30b9\u78ba\u8a8d\n\nmaster\u3067\u306f`redis-rdb-to-slaves`\u304c\u52d5\u4f5c\u3057\u3066\u3044\u308b\n\n```\n[root@ip-172-31-5-23 lib]# ps aux|grep redis\nredis     6921  5.1 64.8 20516304 20375188 ?   Ssl  02:34   1:31 /usr/bin/redis-server *:6379\nredis     7103 79.4 64.8 20516688 20374632 ?   R    03:01   1:48 redis-rdb-to-slaves *:6379\nroot      7115  0.0  0.0 114632   924 pts/0    R+   03:03   0:00 grep redis\n```\n\n- redis.log\n\n`Starting BGSAVE for SYNC with target: slaves sockets`\u3068\u306a\u3063\u3066\u3044\u308b\nslave\u306esocket\u3078\u76f4\u63a5BGSAVE\u306e\u30c0\u30f3\u30d7\u3092\u8ee2\u9001\u3057\u3066\u3044\u308b\u6a21\u69d8\n \n```\n6921:M 30 Nov 03:01:34.496 # Connection with slave client id #33 lost.\n6921:M 30 Nov 03:01:34.522 - Accepted 172.31.13.112:34189\n6921:M 30 Nov 03:01:34.522 * Slave 172.31.13.112:6379 asks for synchronization\n6921:M 30 Nov 03:01:34.522 * Full resync requested by slave 172.31.13.112:6379\n6921:M 30 Nov 03:01:35.220 * Starting BGSAVE for SYNC with target: slaves sockets\n6921:M 30 Nov 03:01:35.459 * Background RDB transfer started by pid 7103\n6921:M 30 Nov 03:05:03.333 * Background RDB transfer terminated with success\n6921:M 30 Nov 03:05:03.333 # Slave 172.31.13.112:6379 correctly received the streamed RDB file.\n6921:M 30 Nov 03:05:03.333 * Streamed RDB transfer with slave 172.31.13.112:6379 succeeded (socket). Waiting for REPLCONF ACK from slave to\nenable streaming\n..\u7701\u7565..\n6921:M 30 Nov 03:06:19.609 * Synchronization with slave 172.31.13.112:6379 succeeded\n```\n\n### slave\u306eredis.log\n\n```\n3305:S 30 Nov 03:01:34.514 * Connecting to MASTER 172.31.5.23:6379\n3305:S 30 Nov 03:01:34.514 * MASTER <-> SLAVE sync started\n3305:S 30 Nov 03:01:34.515 * Non blocking connect for SYNC fired the event.\n3305:S 30 Nov 03:01:34.515 * Master replied to PING, replication can continue...\n3305:S 30 Nov 03:01:34.515 * Partial resynchronization not possible (no cached master)\n3305:S 30 Nov 03:01:35.213 * Full resync from master: 61865c4afa66868ceee549a5fb1ebfc1020e934a:1429\n3305:S 30 Nov 03:01:35.454 * MASTER <-> SLAVE sync: receiving streamed RDB from master\n..\u7701\u7565..\n3305:S 30 Nov 03:05:02.855 * MASTER <-> SLAVE sync: Flushing old data\n3305:S 30 Nov 03:05:02.855 * MASTER <-> SLAVE sync: Loading DB in memory\n3305:S 30 Nov 03:06:19.096 * MASTER <-> SLAVE sync: Finished with success\n```\n\n\n### \u53c2\u8003 Redis Full resync\u4e2d\u306eslave\u30b9\u30c6\u30fc\u30bf\u30b9\u9077\u79fb\n\n`redis-cli info replication` \u306e\u7d50\u679c\n\n- master\u3067\u5b9f\u884c\n\nMaster bgsave\u4e2d\u306e\u30b9\u30c6\u30fc\u30bf\u30b9\nslave\u306fwait_bgsave\u306b\u306a\u3063\u3066\u3044\u308b\n\n```\n# Replication\nrole:master\nconnected_slaves:1\nslave0:ip=172.31.13.112,port=6379,state=wait_bgsave,offset=0,lag=0\nmaster_repl_offset:253\nrepl_backlog_active:1\nrepl_backlog_size:1048576\nrepl_backlog_first_byte_offset:2\nrepl_backlog_histlen:252\n```\n\n\u2193\n\nbgsave\u5b8c\u4e86\u5f8c\u3001\u30d0\u30eb\u30af\u30ed\u30fc\u30c9\u304c\u958b\u59cb\u3055\u308c\u308b\u3002\nsend_bulk\u306b\u5909\u66f4\u3055\u308c\u308b\n\n```\n[root@ip-172-31-5-23 lib]# redis-cli info replication\n# Replication\nrole:master\nconnected_slaves:1\nslave0:ip=172.31.13.112,port=6379,state=send_bulk,offset=0,lag=0\nmaster_repl_offset:337\nrepl_backlog_active:1\nrepl_backlog_size:1048576\nrepl_backlog_first_byte_offset:2\nrepl_backlog_histlen:336\n```\n\n\u2193\n\nonline\u306b\u5909\u66f4\u3055\u308c\u308b\n\n```\n[root@ip-172-31-5-23 lib]# redis-cli info replication\n# Replication\nrole:master\nconnected_slaves:1\nslave0:ip=172.31.13.112,port=6379,state=online,offset=1051,lag=1\nmaster_repl_offset:1051\nrepl_backlog_active:1\nrepl_backlog_size:1048576\nrepl_backlog_first_byte_offset:2\nrepl_backlog_histlen:1050\n```\n", "tags": ["Redis"]}