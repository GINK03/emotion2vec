{"context": " More than 1 year has passed since last update.\u3082\u3046\u3059\u3054\u3044\u9069\u5f53\u3002\nphp\u306b\u3088\u308bLDAP\u306e\u30d1\u30b9\u30ef\u30fc\u30c9\u66f4\u65b0\u306e\u7c21\u5358\u306a\u3084\u3064\u304c\u898b\u3064\u304b\u3089\u306a\u304b\u3063\u305f\u306e\u3067\u3068\u308a\u3042\u3048\u305a\u66f8\u3044\u305f\u3002\n\n\u30d1\u30b9\u30ef\u30fc\u30c9\u306eencode\u90e8\u5206\u306f\u53c2\u8003\u306b\u3057\u307e\u3057\u305f\u3002 \nhttps://github.com/koppor/phpLdapPasswd/blob/master/functions.php \n\u30b5\u30fc\u30d0\u7684\u306b\u306f phpinfo \u3067LDAP\u304c\u6709\u52b9\u306a\u3053\u3068\u304c\u524d\u63d0\u3067\u3059\u3002 \n\u8981\u306f\u3053\u3053\u306e\u304c\u52d5\u3051\u3070\u3044\u3044\u3067\u3059\u3002 \nhttp://www.php.net/manual/ja/ref.ldap.php\n\n\nphpldap.php\n<?php\n\n// ldap \u30d0\u30a4\u30f3\u30c9\u3092\u4f7f\u7528\u3059\u308b\n$ldapdn  = 'dc=ldap-server, dc=sample.jp';     // ldap rdn \u3042\u308b\u3044\u306f dn\n$ldaprdn  = 'cn=Manager, ' . $ldapdn;   // ldap rdn \u3042\u308b\u3044\u306f dn\n$ldappass = 'managerpass';  // \u30d1\u30b9\u30ef\u30fc\u30c9\n\n$ldap_user = 'hoge';\n$ldap_newpass = 'hogehoge';\n\n// \u3053\u3053LDAP\u8a2d\u5b9a\u306b\u3088\u308a\u5909\u308f\u308b\u306e\u3067\u9069\u5f53\u3067\u3059\u304c\u3001\u3061\u3083\u3093\u3068\u8a2d\u5b9a\u3057\u306a\u3044\u3068\u52d5\u304d\u307e\u305b\u3093\n$ldap_fulldn = 'uid='.$ldap_user. ',ou=People,'. $ldapdn;\n\necho date(\"Y/m/d H:i:s \") . \"Connecting ...\". \"<br />\";\n\n// ldap \u30b5\u30fc\u30d0\u30fc\u306b\u63a5\u7d9a\u3059\u308b\n$ldapconn = ldap_connect(\"ldap-server.sample.jp\")\n or exit(\"Could not connect to LDAP server.\");\n\nif ($ldapconn) {\n\n    echo date(\"Y/m/d H:i:s \") . \"Binding ...\". \"<br />\";\n\n    // ldap \u30b5\u30fc\u30d0\u30fc\u306b\u30d0\u30a4\u30f3\u30c9\u3059\u308b\n    $ldapbind = ldap_bind($ldapconn, $ldaprdn, $ldappass);\n\n    echo date(\"Y/m/d H:i:s \") . \"Binding resuls is \" . $ldapbind . \"<br />\";\n\n    // \u30d0\u30a4\u30f3\u30c9\u7d50\u679c\u3092\u691c\u8a3c\u3059\u308b\n    if ($ldapbind) {\n        echo date(\"Y/m/d H:i:s \") . \"LDAP bind successful...\";\n    } else {\n        echo date(\"Y/m/d H:i:s \") . \"LDAP bind failed...\";\n        exit;\n    }\n\n    echo date(\"Y/m/d H:i:s \") . \" Searching ...\";\n\n    // \u30e6\u30fc\u30b6\u3092\u691c\u7d22\u3059\u308b\u30ef\u30fc\u30c9\uff08\u3053\u3053\u3067\u306f\u5f8c\u65b9\u4e00\u81f4\uff09\n    $person = $ldap_user;\n    $filter = \"(uid=$person*)\";\n    //$colmun = array(\"givenname\", \"mail\", \"userpassword\");  // \u53d6\u5f97\u3059\u308b\u30ab\u30e9\u30e0\u3092\u7d5e\u308b\u5834\u5408\n\n    $serchID = ldap_search($ldapconn, $ldapdn, $filter);\n    echo date(\"Y/m/d H:i:s \") . \"Search result is \" . $serchID . \"<br />\";\n    echo date(\"Y/m/d H:i:s \") . \"Number of entires returned is \" . ldap_count_entries($ldapconn, $serchID) . \"<br />\";\n\n    // \u4e0a\u8a18\u3067\u898b\u3064\u304b\u3063\u305fID\u9054\u3092\u53d6\u5f97\n    $entries = ldap_get_entries( $ldapconn, $serchID );\n\n    //print_r($entries);   \n\n    //\u5168\u4ef6\u8868\u793a\n     for ($i=0; $i<$entries[\"count\"]; $i++) {\n        // to show the attribute displayName (note the case!)\n        echo $entries[$i][\"uid\"][0].\":\".$entries[$i][\"mail\"][0] . \":\" . $entries[$i][\"userpassword\"][0] . \":\" . $entries[$i][\"dn\"] . \"<br />\";\n\n        // compare\u306e\u30c6\u30b9\u30c8\u3002\u57fa\u672c\u7684\u306b\u610f\u5473\u306a\u3057\u3002\n        $result = ldap_compare( $ldapconn, $entries[$i][\"dn\"] , \"userpassword\", $entries[$i][\"userpassword\"][0] );\n        if ( $result === -1 ) {\n            echo date(\"Y/m/d H:i:s \") . \"Error: \" . ldap_error($ldapconn) . \"<br />\";\n        } elseif ($result === true) {\n            echo date(\"Y/m/d H:i:s \") . \"Password correct.\" . \"<br />\";;\n        } elseif ($result === false) {\n            echo date(\"Y/m/d H:i:s \") . \"Wrong guess! Password incorrect.\" . \"<br />\";\n        }   \n    }\n\n    // SSHA\u30d1\u30b9\u30ef\u30fc\u30c9\u751f\u6210.\n    $encodedpass = encode_password( $ldap_newpass, \"ssha\");\n    echo \"encodedpass=\".$encodedpass . \"<br>\";\n\n    //\u30d1\u30b9\u30ef\u30fc\u30c9\u66f4\u65b0\uff01\n    if (!(@ldap_mod_replace($ldapconn, \"uid=$ldap_user,ou=People,dc=ldap-server,dc=sample.jp\", array('userpassword' => $encodedpass)))) {\n        exit(\"Unable to change password.\");\n    }\n    //\u4e0a\u8a18\u3067\u751f\u6210\u3057\u305fSSHA\u30d1\u30b9\u30ef\u30fc\u30c9\u4fdd\u5b58\u3055\u308c\u3066\u3044\u308b\u304b\u78ba\u8a8d\n    $iSerchID = ldap_search($ldapconn, $ldapdn, $filter);\n    $entries = ldap_get_entries( $ldapconn, $iSerchID );\n    for ($i=0; $i<$entries[\"count\"]; $i++) {\n        echo $entries[$i][\"uid\"][0].\":\".$entries[$i][\"mail\"][0] . \":\" . $entries[$i][\"userpassword\"][0] . \":\" . $entries[$i][\"dn\"] . \"<br />\";\n    }\n\n    // close\n    echo date(\"Y/m/d H:i:s \") . \" Closing connection\";\n    ldap_close($ldapconn);    \n} else {\n    echo date(\"Y/m/d H:i:s \") . \" failed connection\";    \n}\n\n/**\n * \u30d1\u30b9\u30ef\u30fc\u30c9\u751f\u6210\n * @password\n * @encoding\n * @see https://github.com/koppor/phpLdapPasswd/blob/master/functions.php #encode_password\n **/\nfunction encode_password ($password = \"\", $encoding = \"clear\") {\n    if (strcasecmp($encoding, \"clear\") == 0) {\n        $encodedpass = $password;\n    } elseif (strcasecmp($encoding, \"crypt\") == 0) {\n        $encodedpass = \"{CRYPT}\".crypt($password);\n    } elseif (strcasecmp($encoding, \"md5\") == 0) {\n        $encodedpass = \"{MD5}\".base64_encode(pack(\"H*\",md5($password)));\n    } elseif (strcasecmp($encoding, \"ssha\") == 0) {\n        mt_srand((double)microtime()*1000000);\n        $salt = mhash_keygen_s2k(MHASH_SHA1, $password, substr(pack('h*', md5(mt_rand())), 0, 8), 4);\n        $encodedpass = \"{SSHA}\".base64_encode(mhash(MHASH_SHA1, $password.$salt).$salt);\n    } else {\n        exit(\"Invalid password encoding method configured: $encoding\");\n    }\n\n    return($encodedpass);\n}\n\n?>\n\n\n\u3082\u3046\u3059\u3054\u3044\u9069\u5f53\u3002\n\nphp\u306b\u3088\u308bLDAP\u306e\u30d1\u30b9\u30ef\u30fc\u30c9\u66f4\u65b0\u306e\u7c21\u5358\u306a\u3084\u3064\u304c\u898b\u3064\u304b\u3089\u306a\u304b\u3063\u305f\u306e\u3067\u3068\u308a\u3042\u3048\u305a\u66f8\u3044\u305f\u3002\n\n* \u30d1\u30b9\u30ef\u30fc\u30c9\u306eencode\u90e8\u5206\u306f\u53c2\u8003\u306b\u3057\u307e\u3057\u305f\u3002 \nhttps://github.com/koppor/phpLdapPasswd/blob/master/functions.php \n\n* \u30b5\u30fc\u30d0\u7684\u306b\u306f phpinfo \u3067LDAP\u304c\u6709\u52b9\u306a\u3053\u3068\u304c\u524d\u63d0\u3067\u3059\u3002 \n\u8981\u306f\u3053\u3053\u306e\u304c\u52d5\u3051\u3070\u3044\u3044\u3067\u3059\u3002 \nhttp://www.php.net/manual/ja/ref.ldap.php\n\n```php:phpldap.php\n<?php\n\n// ldap \u30d0\u30a4\u30f3\u30c9\u3092\u4f7f\u7528\u3059\u308b\n$ldapdn  = 'dc=ldap-server, dc=sample.jp';     // ldap rdn \u3042\u308b\u3044\u306f dn\n$ldaprdn  = 'cn=Manager, ' . $ldapdn;   // ldap rdn \u3042\u308b\u3044\u306f dn\n$ldappass = 'managerpass';  // \u30d1\u30b9\u30ef\u30fc\u30c9\n\n$ldap_user = 'hoge';\n$ldap_newpass = 'hogehoge';\n\n// \u3053\u3053LDAP\u8a2d\u5b9a\u306b\u3088\u308a\u5909\u308f\u308b\u306e\u3067\u9069\u5f53\u3067\u3059\u304c\u3001\u3061\u3083\u3093\u3068\u8a2d\u5b9a\u3057\u306a\u3044\u3068\u52d5\u304d\u307e\u305b\u3093\n$ldap_fulldn = 'uid='.$ldap_user. ',ou=People,'. $ldapdn;\n\necho date(\"Y/m/d H:i:s \") . \"Connecting ...\". \"<br />\";\n\n// ldap \u30b5\u30fc\u30d0\u30fc\u306b\u63a5\u7d9a\u3059\u308b\n$ldapconn = ldap_connect(\"ldap-server.sample.jp\")\n or exit(\"Could not connect to LDAP server.\");\n\nif ($ldapconn) {\n \n    echo date(\"Y/m/d H:i:s \") . \"Binding ...\". \"<br />\";\n\n    // ldap \u30b5\u30fc\u30d0\u30fc\u306b\u30d0\u30a4\u30f3\u30c9\u3059\u308b\n    $ldapbind = ldap_bind($ldapconn, $ldaprdn, $ldappass);\n\n    echo date(\"Y/m/d H:i:s \") . \"Binding resuls is \" . $ldapbind . \"<br />\";\n\n    // \u30d0\u30a4\u30f3\u30c9\u7d50\u679c\u3092\u691c\u8a3c\u3059\u308b\n    if ($ldapbind) {\n        echo date(\"Y/m/d H:i:s \") . \"LDAP bind successful...\";\n    } else {\n        echo date(\"Y/m/d H:i:s \") . \"LDAP bind failed...\";\n        exit;\n    }\n\n    echo date(\"Y/m/d H:i:s \") . \" Searching ...\";\n\n    // \u30e6\u30fc\u30b6\u3092\u691c\u7d22\u3059\u308b\u30ef\u30fc\u30c9\uff08\u3053\u3053\u3067\u306f\u5f8c\u65b9\u4e00\u81f4\uff09\n    $person = $ldap_user;\n    $filter = \"(uid=$person*)\";\n    //$colmun = array(\"givenname\", \"mail\", \"userpassword\");  // \u53d6\u5f97\u3059\u308b\u30ab\u30e9\u30e0\u3092\u7d5e\u308b\u5834\u5408\n\n    $serchID = ldap_search($ldapconn, $ldapdn, $filter);\n    echo date(\"Y/m/d H:i:s \") . \"Search result is \" . $serchID . \"<br />\";\n    echo date(\"Y/m/d H:i:s \") . \"Number of entires returned is \" . ldap_count_entries($ldapconn, $serchID) . \"<br />\";\n    \n    // \u4e0a\u8a18\u3067\u898b\u3064\u304b\u3063\u305fID\u9054\u3092\u53d6\u5f97\n    $entries = ldap_get_entries( $ldapconn, $serchID );\n\n    //print_r($entries);   \n\n    //\u5168\u4ef6\u8868\u793a\n     for ($i=0; $i<$entries[\"count\"]; $i++) {\n        // to show the attribute displayName (note the case!)\n        echo $entries[$i][\"uid\"][0].\":\".$entries[$i][\"mail\"][0] . \":\" . $entries[$i][\"userpassword\"][0] . \":\" . $entries[$i][\"dn\"] . \"<br />\";\n        \n        // compare\u306e\u30c6\u30b9\u30c8\u3002\u57fa\u672c\u7684\u306b\u610f\u5473\u306a\u3057\u3002\n        $result = ldap_compare( $ldapconn, $entries[$i][\"dn\"] , \"userpassword\", $entries[$i][\"userpassword\"][0] );\n        if ( $result === -1 ) {\n            echo date(\"Y/m/d H:i:s \") . \"Error: \" . ldap_error($ldapconn) . \"<br />\";\n        } elseif ($result === true) {\n            echo date(\"Y/m/d H:i:s \") . \"Password correct.\" . \"<br />\";;\n        } elseif ($result === false) {\n            echo date(\"Y/m/d H:i:s \") . \"Wrong guess! Password incorrect.\" . \"<br />\";\n        }   \n    }\n\n    // SSHA\u30d1\u30b9\u30ef\u30fc\u30c9\u751f\u6210.\n    $encodedpass = encode_password( $ldap_newpass, \"ssha\");\n    echo \"encodedpass=\".$encodedpass . \"<br>\";\n\n    //\u30d1\u30b9\u30ef\u30fc\u30c9\u66f4\u65b0\uff01\n    if (!(@ldap_mod_replace($ldapconn, \"uid=$ldap_user,ou=People,dc=ldap-server,dc=sample.jp\", array('userpassword' => $encodedpass)))) {\n        exit(\"Unable to change password.\");\n    }\n    //\u4e0a\u8a18\u3067\u751f\u6210\u3057\u305fSSHA\u30d1\u30b9\u30ef\u30fc\u30c9\u4fdd\u5b58\u3055\u308c\u3066\u3044\u308b\u304b\u78ba\u8a8d\n    $iSerchID = ldap_search($ldapconn, $ldapdn, $filter);\n    $entries = ldap_get_entries( $ldapconn, $iSerchID );\n    for ($i=0; $i<$entries[\"count\"]; $i++) {\n        echo $entries[$i][\"uid\"][0].\":\".$entries[$i][\"mail\"][0] . \":\" . $entries[$i][\"userpassword\"][0] . \":\" . $entries[$i][\"dn\"] . \"<br />\";\n    }\n\n    // close\n    echo date(\"Y/m/d H:i:s \") . \" Closing connection\";\n    ldap_close($ldapconn);    \n} else {\n    echo date(\"Y/m/d H:i:s \") . \" failed connection\";    \n}\n\n/**\n * \u30d1\u30b9\u30ef\u30fc\u30c9\u751f\u6210\n * @password\n * @encoding\n * @see https://github.com/koppor/phpLdapPasswd/blob/master/functions.php #encode_password\n **/\nfunction encode_password ($password = \"\", $encoding = \"clear\") {\n    if (strcasecmp($encoding, \"clear\") == 0) {\n        $encodedpass = $password;\n    } elseif (strcasecmp($encoding, \"crypt\") == 0) {\n        $encodedpass = \"{CRYPT}\".crypt($password);\n    } elseif (strcasecmp($encoding, \"md5\") == 0) {\n        $encodedpass = \"{MD5}\".base64_encode(pack(\"H*\",md5($password)));\n    } elseif (strcasecmp($encoding, \"ssha\") == 0) {\n        mt_srand((double)microtime()*1000000);\n        $salt = mhash_keygen_s2k(MHASH_SHA1, $password, substr(pack('h*', md5(mt_rand())), 0, 8), 4);\n        $encodedpass = \"{SSHA}\".base64_encode(mhash(MHASH_SHA1, $password.$salt).$salt);\n    } else {\n        exit(\"Invalid password encoding method configured: $encoding\");\n    }\n\n    return($encodedpass);\n}\n\n?>\n```\n", "tags": ["PHP", "LDAP"]}