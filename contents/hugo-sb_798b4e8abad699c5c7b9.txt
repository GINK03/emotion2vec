{"context": " More than 1 year has passed since last update.\u6f2b\u753b\u597d\u304d\u3068\u3057\u3066\u306f\u65e5\u3005\u767a\u58f2\u3055\u308c\u308b\u65b0\u520a\u306e\u30c1\u30a7\u30c3\u30af\u306f\u6b20\u304b\u305b\u306a\u3044\u306e\u3067\u3059\u304c\u3001\u6b63\u76f4\u9762\u5012\u3067\u3082\u3042\u308a\u307e\u3059\u3002\n\u3082\u3063\u3068\u304a\u624b\u8efd\u306b\u65b0\u520a\u30c1\u30a7\u30c3\u30af\u3067\u304d\u306a\u3044\u304b\u3068\u601d\u3044\u3001iPhone\u7528\u306e\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3092\u4f5c\u308d\u3046\u304b\u3068\u8003\u3048\u307e\u3057\u305f\u3002\n\u3057\u304b\u3057iPhone\u30a2\u30d7\u30ea\u306f\u307e\u3060\u307e\u3068\u3082\u306b\u7d44\u3093\u3060\u3053\u3068\u304c\u306a\u3044\u306e\u3067\u3001\u3068\u308a\u3042\u3048\u305aiPhone\u4e0a\u306e\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306b\u65b0\u520a\u30b3\u30df\u30c3\u30af\u306e\u60c5\u5831\u3092JSON\u3067\u8fd4\u3059\u30b5\u30fc\u30d0\u30fc\u5074\u306eAPI\u3092\u3061\u3083\u3063\u3061\u3083\u3068\u66f8\u3044\u3066\u307f\u308b\u3053\u3068\u306b\u3057\u307e\u3057\u305f\u3002\n\n\u65b0\u520a\u30b3\u30df\u30c3\u30af\u306e\u60c5\u5831\u3092\u53d6\u5f97\u3059\u308b\n\u307e\u305a\u65b0\u520a\u30b3\u30df\u30c3\u30af\u306e\u60c5\u5831\u3092\u3069\u3053\u304b\u3089\u53d6\u5f97\u3059\u308b\u304b\u3067\u3059\u304c\u3001\u4eca\u56de\u306f\u300c\u30b3\u30df\u30c3\u30af\u30ca\u30bf\u30ea\u30fc\u300d\u306e\u300c\u672c\u65e5\u767a\u58f2\u306e\u5358\u884c\u672c\u30ea\u30b9\u30c8\u300d\u306e\u8a18\u4e8b\u3092\u30b9\u30af\u30ec\u30a4\u30d4\u30f3\u30b0\u3059\u308b\u3053\u3068\u306b\u3057\u307e\u3057\u305f\u3002\u65b0\u520a\u30b3\u30df\u30c3\u30af\u306e\u60c5\u5831\u3092\u63d0\u4f9b\u3057\u3066\u3044\u308b\u30b5\u30a4\u30c8\u306f\u5e7e\u3064\u304b\u3042\u308a\u307e\u3059\u304c\u3001RSS\u3092\u914d\u4fe1\u3057\u3066\u3044\u308b\u3001amazon\u3078\u306e\u30ea\u30f3\u30af\u304c\u3042\u308b\u3001HTML\u306e\u69cb\u9020\u304c\u5358\u7d14\u3067\u30b9\u30af\u30ec\u30a4\u30d4\u30f3\u30b0\u3057\u3084\u3059\u3044\u3068\u3044\u3046\u7406\u7531\u3067\u300c\u30b3\u30df\u30c3\u30af\u30ca\u30bf\u30ea\u30fc\u300d\u306b\u6c7a\u3081\u307e\u3057\u305f\u3002\n\u51e6\u7406\u306e\u5927\u307e\u304b\u306a\u6d41\u308c\u306f\u3001\n1.\u300c\u30b3\u30df\u30c3\u30af\u30ca\u30bf\u30ea\u30fc\u300d\u306eRSS\u304b\u3089\u300c\u672c\u65e5\u767a\u58f2\u306e\u5358\u884c\u672c\u30ea\u30b9\u30c8\u300d\u306eURL\u3092\u53d6\u5f97\u3059\u308b\n2.\u300c\u672c\u65e5\u767a\u58f2\u306e\u5358\u884c\u672c\u30ea\u30b9\u30c8\u300d\u30da\u30fc\u30b8\u306e\u5185\u5bb9\u3092\u53d6\u5f97\u3059\u308b\n3. HTML\u3092\u30b9\u30af\u30ec\u30a4\u30d4\u30f3\u30b0\u3057\u3066\u65b0\u520a\u60c5\u5831\u3092\u53d6\u5f97\u3059\u308b\n4. \u65b0\u520a\u60c5\u5831\u3092\u30c7\u30fc\u30bf\u30fc\u30d9\u30fc\u30b9\u306b\u4fdd\u5b58\u3059\u308b\u3002\n\u3068\u3044\u3046\u611f\u3058\u3067\u3057\u3087\u3046\u304b\u3002\n\u307b\u307c\u6d41\u308c\u306e\u307e\u307e\u306bruby\u3067\u30b5\u30af\u30c3\u3068\u66f8\u3044\u3066\u307f\u307e\u3057\u305f\u3002\n\nget_new_comics.rb\n\n# \u30b3\u30df\u30c3\u30af\u30ca\u30bf\u30ea\u30fc\u306e\u300c\u672c\u65e5\u767a\u58f2\u306e\u5358\u884c\u672c\u30ea\u30b9\u30c8\u300d\u3088\u308a\u66f8\u7c4d\u60c5\u5831\u3092\u30b9\u30af\u30ec\u30a4\u30d4\u30f3\u30b0\u3057\u3066\n# MySQL\u306b\u767b\u9332\u3059\u308b\n\nrequire 'rss'\nrequire 'open-uri'\nrequire 'nokogiri'\nrequire 'mysql2'\n\n# \u30b3\u30df\u30c3\u30af\u30ca\u30bf\u30ea\u30fc\u306eRSS\u304b\u3089\u65b0\u520a\u60c5\u5831\u306eURL\u3092\u53d6\u5f97\u3059\u308b\ndef get_urls(feed_url)\n  rss = RSS::Parser.parse(feed_url)\n  rss.items.select {|item| item.title.content =~ /\u672c\u65e5\u767a\u58f2\u306e\u5358\u884c\u672c\u30ea\u30b9\u30c8/}\n           .map {|item| item.link.href}\nend\n\n# URL\u304b\u3089\u30a2\u30d5\u30a3\u30ea\u30a8\u30a4\u30c8ID\u3092\u30ab\u30c3\u30c8\u3059\u308b\ndef strip_affiliate_id(url)\n    url.gsub(/[^\\/]+$/, \"\")\nend\n\n# amazon\u306e\u5546\u54c1URL\u304b\u3089ASIN\u5024\u3092\u53d6\u5f97\u3059\u308b\ndef asin(url)\n  if url =~ /ASIN\\/(\\d+)\\//\n    $1\n  else\n    \"\"\n  end\nend\n\n# \u65b0\u520a\u66f8\u7c4d\u60c5\u5831\u3092\u53d6\u5f97\u3059\u308b\ndef get_comic_info(url)\n\n  books = []\n\n  html = open(url).read\n  doc = Nokogiri::HTML.parse(html)\n\n  release_date = nil\n  if doc.title =~ /\u3010(\\d+)\u6708(\\d+)\u65e5\u4ed8\u3011/\n    release_date = Time.local(Time.now.year, $1.to_i, $2.to_i)\n  end\n\n  doc.xpath(\"//div[@class='NA_articleBody']\").each do |div|\n    publisher = nil\n    div.elements.each do |elm|\n      if elm.name == \"h4\"\n        publisher = elm.inner_text\n      end\n      if elm.name == \"p\" && !publisher.nil?\n        elm.inner_html.split(\"<br>\").each do |line|\n          if line =~ /^<a href=\"(.+?)\".*>.*\u300c(.+)\u300d.*<\\/a>(.+)$/\n            books << {\n                title: $2.strip,\n                author: $3.strip,\n                publisher: publisher,\n                link: strip_affiliate_id($1),\n                asin: asin($1),\n                release_date: release_date\n              }\n          end\n        end\n      end\n    end\n  end\n\n  books\nend\n\n# \u540c\u4e00\u306eASIN\u3092\u6301\u3064\u30c7\u30fc\u30bf\u304cDB\u4e0a\u306b\u5b58\u5728\u3059\u308b\u304b\u30c1\u30a7\u30c3\u30af\ndef is_exists(asin, client)\n    escaped_string = client.escape(asin)\n    sql = \"SELECT COUNT(*) as count FROM books WHERE asin = '#{escaped_string}'\"\n    client.query(sql).each do |row|\n        return row['count'] > 0\n    end\n    false\nend\n\n# \u633f\u5165\u7528\u306eSQL\u6587\u3092\u751f\u6210\u3059\u308b\ndef insert_sql(book, client)\n  fields = book.keys\n  values = []\n  fields.each do |f|\n    if (f == :release_date)\n      if (book[f])\n        values << \"'#{book[f].strftime('%Y-%m-%d')}'\"\n      else\n        values << \"NULL\"\n      end\n    else\n      escaped_string = client.escape(book[f])\n      values << \"'#{escaped_string}'\"\n    end\n  end\n  \"INSERT INTO books (#{fields.map(&:to_s).join(',')}) \" +\n  \"VALUES (#{values.join(',')})\"\nend\n\n##\n## PROGRAM START\n##\n\n# \u30b3\u30df\u30c3\u30af\u30ca\u30bf\u30ea\u30fc\u306eRSS\nFEED_URL = \"http://natalie.mu/comic/feed/news\"\n# MySQL\u63a5\u7d9a\u7528\u306e\u30a2\u30ab\u30a6\u30f3\u30c8\u3068\u30d1\u30b9\u30ef\u30fc\u30c9\nDB_USER = \"XXXXX\"\nDB_PASSWORD = \"XXXXX\"\n\n# MySQL\u306b\u63a5\u7d9a\u3059\u308b\nclient = Mysql2::Client.new(host: 'localhost', username: DB_USER, password: DB_PASSWORD, database: 'comic_db')\n\n# URL\u306e\u30ea\u30b9\u30c8\u3092\u9806\u6b21\u51e6\u7406\u3059\u308b\nurls = ARGV.empty? ? get_urls(FEED_URL) : ARGV\nurls.each do |url|\n  # \u30b3\u30df\u30c3\u30af\u30ca\u30bf\u30ea\u30fc\u306e\u65b0\u520a\u60c5\u5831\u30da\u30fc\u30b8\u3088\u308a\u66f8\u7c4d\u60c5\u5831\u3092\u53d6\u5f97\u3059\u308b\n  get_comic_info(url).each do |book|\n    # \u540c\u4e00ASIN\u306e\u66f8\u7c4d\u304cDB\u306b\u5b58\u5728\u3057\u306a\u3051\u308c\u3070\u767b\u9332\u3059\u308b\n    unless is_exists(book[:asin], client)\n      client.query(insert_sql(book, client))\n    end\n  end\nend\n\n\n\n\u53d6\u5f97\u3057\u305f\u65b0\u520a\u60c5\u5831\u306fMySQL\u4e0a\u306ebooks\u3068\u3044\u3046\u30c6\u30fc\u30d6\u30eb\u306b\u4fdd\u5b58\u3059\u308b\u3088\u3046\u306b\u3057\u307e\u3057\u305f\u3002\n\nCREATE TABLE `books` (\n  `id` int(10) unsigned NOT NULL AUTO_INCREMENT,\n  `title` varchar(250) DEFAULT NULL,\n  `author` varchar(250) DEFAULT NULL,\n  `publisher` varchar(250) DEFAULT NULL,\n  `link` varchar(250) DEFAULT NULL,\n  `asin` varchar(20) DEFAULT NULL,\n  `release_date` datetime DEFAULT NULL,\n  PRIMARY KEY (`id`),\n  KEY `IDX_ASIN` (`asin`)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8\n\n\n\u3053\u306eruby\u306e\u30b9\u30af\u30ea\u30d7\u30c8\u3092cron\u3067\u6bce\u65e5\u5b9f\u884c\u3057\u3066\u3084\u308c\u3070\u3001\u65e5\u3005\u767a\u58f2\u3055\u308c\u308b\u65b0\u520a\u30b3\u30df\u30c3\u30af\u306e\u60c5\u5831\u304c\u30b5\u30fc\u30d0\u30fc\u4e0a\u306e\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306b\u52dd\u624b\u306b\u6e9c\u307e\u3063\u3066\u3044\u304f\u3068\u3044\u3046\u5bf8\u6cd5\u3067\u3059\u3002\n\n\u65b0\u520a\u60c5\u5831\u3092\u53d6\u5f97\u3059\u308bAPI\n\u7d9a\u3044\u3066\u3001\u30b5\u30fc\u30d0\u30fc\u4e0a\u306e\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306b\u4fdd\u5b58\u3055\u308c\u305f\u65b0\u520a\u60c5\u5831\u3092JSON\u5f62\u5f0f\u3067\u8fd4\u3059API\u3067\u3059\u3002\n\u30d1\u30e9\u30e1\u30fc\u30bf\u30fc\u3068\u3057\u3066\u65e5\u4ed8\u3092\u6e21\u3057\u3066\u3001\u8a72\u5f53\u65e5\u306b\u767a\u58f2\u3055\u308c\u308b\u30b3\u30df\u30c3\u30af\u306e\u60c5\u5831\u3092JSON\u3067\u8fd4\u3059\u3068\u3044\u3046\u5358\u7d14\u306a\u3082\u306e\u3067\u3059\u3002\n\u30d5\u30ec\u30fc\u30e0\u30ef\u30fc\u30af\u3068\u304b\u5927\u8888\u88df\u306a\u3082\u306e\u306f\u4f7f\u308f\u305a\u7d20\u306ePHP\u3067\u3071\u3063\u3071\u3068\u66f8\u3044\u3066\u3057\u307e\u3044\u307e\u3059\u3002\n\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u53d6\u5f97\u3059\u308b\u3068\u3053\u3068\u304b\u3082\u3063\u3068\u30de\u30b7\u306b\u66f8\u3051\u305d\u3046\u306a\u6c17\u304c\u3057\u307e\u3059\u304c\u6c17\u306b\u3057\u306a\u3044\u3067\u304a\u304d\u307e\u3059\u3002\n\ncomic_list.php\n\n<?php\n    # \u6307\u5b9a\u3057\u305f\u65e5\u4ed8\u306e\u65b0\u520a\u66f8\u7c4d\u306e\u30ea\u30b9\u30c8\u3092JSON\u3067\u8fd4\u3059\u3002\n    # Using : http://foo.bar/api/comic_list.php?dt=20150101\n    # \u5f15\u6570\n    # \u3000dt\uff1a8\u6841\uff08\u5e744\u6841\u3001\u67082\u6841\u3001\u65e52\u6841\uff09\u306e\u65e5\u4ed8\u3092\u793a\u3059\u6570\u5024\uff08\u7701\u7565\u6642\u306f\u5f53\u65e5\uff09\n\n    # DB\u63a5\u7d9a\u7528\u306e\u5b9a\u6570\n    const DB_CONNECTION_STRING = \"mysql:host=localhost;dbname=comic_db;charset=utf8\";\n    const DB_USER = \"XXXXX\";\n    const DB_PASSWORD = \"XXXXX\";\n\n    # \u30d1\u30e9\u30e1\u30fc\u30bf\u30fc\u3092\u53d6\u5f97\u3059\u308b\n    function getParams()\n    {\n        if (empty($_GET[\"dt\"]))\n        {\n            $dt = new DateTimeImmutable();\n        }\n        else\n        {\n            if (preg_match(\"/^(\\d{4})(\\d{2})(\\d{2})$/\", $_GET[\"dt\"], $m))\n                $dt = new DateTimeImmutable(\"{$m[1]}-{$m[2]}-{$m[3]}\");\n            else\n                throw new Exception(\"Invalid format\");\n        }\n        return [\":dt\" => $dt->format(\"Y-m-d\")];\n    }\n\n    # DB\u3088\u308a\u66f8\u7c4d\u60c5\u5831\u3092\u53d6\u5f97\u3059\u308b\n    function getBooks($params)\n    {\n        $books = [];\n        $conn = new PDO(DB_CONNECTION_STRING,DB_USER,DB_PASSWORD);\n        $sql = \"SELECT * FROM books WHERE release_date = :dt ORDER BY id\";\n        $stmt = $conn->prepare($sql);\n        if ($stmt->execute($params))\n        {\n            while ($row = $stmt->fetch(PDO::FETCH_ASSOC))\n            {\n                $books[] = $row;\n            }\n        }\n        return $books;\n    }\n\n    #\n    # PROGRAM START\n    #\n    try\n    {\n        # \u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u53d6\u5f97\u3059\u308b\n        $params = getParams();\n\n        # \u66f8\u7c4d\u60c5\u5831\u3092\u53d6\u5f97\u3059\u308b\u3002\n        $books = getBooks($params);\n\n        # \u66f8\u7c4d\u60c5\u5831\u3092JSON\u3067\u8fd4\u3059\u3002\n        header(\"Content-Type: application/json\");\n        echo json_encode($books, JSON_UNESCAPED_UNICODE + JSON_UNESCAPED_SLASHES);\n    } \n    catch (Exception $e)\n    {\n        # \u4f8b\u5916\u304c\u767a\u751f\u3057\u305f\n        exit($e->getMessage());\n    }\n\n\n\n\u30b5\u30fc\u30d0\u30fc\u306b\u8a2d\u7f6e\u3057\u3066\u30a2\u30af\u30bb\u30b9\u3057\u3066\u307f\u308b\u3068\u3001\n[\n{\"id\":\"13\",\"title\":\"\u4faf\u7235\u3068\u3082\u3064\u308c\u305f\u611b\u306e\u7cf8\",\"author\":\"\u7dbe\u90e8\u745e\u7a42/\u30d0\u30fc\u30d0\u30e9\u30fb\u30ab\u30fc\u30c8\u30e9\u30f3\u30c9\",\"publisher\":\"\u5b99\u51fa\u7248\",\"link\":\"http://www.amazon.co.jp/exec/obidos/ASIN/4776739143/\",\"asin\":\"4776739143\",\"release_date\":\"2015-01-05 00:00:00\"},\n{\"id\":\"14\",\"title\":\"\u5e73\u5b89\u3061\u3087\u3053\u3063\u3068\u604b\u7d75\u5dfb\uff081\uff09\",\"author\":\"\u536f\u5d0e\u3072\u3068\u307f\",\"publisher\":\"\u5b99\u51fa\u7248\",\"link\":\"http://www.amazon.co.jp/exec/obidos/ASIN/4776739186/\",\"asin\":\"4776739186\",\"release_date\":\"2015-01-05 00:00:00\"},\n{\"id\":\"15\",\"title\":\"\u30cf\u30ea\u30a6\u30c3\u30c9\u30b9\u30bf\u30fc\u306e\u604b\u4eba\",\"author\":\"\u9152\u4e95\u7f8e\u7fbd\",\"publisher\":\"\u5b99\u51fa\u7248\",\"link\":\"http://www.amazon.co.jp/exec/obidos/ASIN/4776739135/\",\"asin\":\"4776739135\",\"release_date\":\"2015-01-05 00:00:00\"},{\"id\":\"16\",\"title\":\"\u5fa9\u8b90\u306e\u5473\u306f\u604b\u306e\u5473\",\"author\":\"\u6a4b\u672c\u591a\u4f73\u5b50/\u30b7\u30e3\u30fc\u30ea\u30fc\u30fb\u30b8\u30e3\u30f3\u30d7\",\"publisher\":\"\u5b99\u51fa\u7248\",\"link\":\"http://www.amazon.co.jp/exec/obidos/ASIN/4776739151/\",\"asin\":\"4776739151\",\"release_date\":\"2015-01-05 00:00:00\"},\n{\"id\":\"17\",\"title\":\"\u5929\u306b\u604b\u3046\uff084\uff09\",\"author\":\"\u671b\u6708\u685c/\u68a8\u5343\u5b50\",\"publisher\":\"\u5b99\u51fa\u7248\",\"link\":\"http://www.amazon.co.jp/exec/obidos/ASIN/4776739178/\",\"asin\":\"4776739178\",\"release_date\":\"2015-01-05 00:00:00\"},\n... \u7565 ...\n]\n\n\u3068\u3044\u3046\u611f\u3058\u306eJSON\u304c\u53d6\u5f97\u3067\u304d\u305f\u306e\u3067\u3001\u4f55\u3068\u304b\u52d5\u3044\u3066\u3044\u308b\u3088\u3046\u3060\u3002\n\u6b21\u306f\u3001\u3053\u306eAPI\u3092\u547c\u3073\u51fa\u3059iPhone\u7528\u306e\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3060\u3051\u3069\u3001\u30c7\u30d9\u30ed\u30c3\u30d1\u30fc\u5951\u7d04\u3059\u308b\u3068\u3053\u304b\u3089\u59cb\u3081\u306a\u3044\u3068...\n\n\n\u6f2b\u753b\u597d\u304d\u3068\u3057\u3066\u306f\u65e5\u3005\u767a\u58f2\u3055\u308c\u308b\u65b0\u520a\u306e\u30c1\u30a7\u30c3\u30af\u306f\u6b20\u304b\u305b\u306a\u3044\u306e\u3067\u3059\u304c\u3001\u6b63\u76f4\u9762\u5012\u3067\u3082\u3042\u308a\u307e\u3059\u3002\n\u3082\u3063\u3068\u304a\u624b\u8efd\u306b\u65b0\u520a\u30c1\u30a7\u30c3\u30af\u3067\u304d\u306a\u3044\u304b\u3068\u601d\u3044\u3001iPhone\u7528\u306e\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3092\u4f5c\u308d\u3046\u304b\u3068\u8003\u3048\u307e\u3057\u305f\u3002\n\u3057\u304b\u3057iPhone\u30a2\u30d7\u30ea\u306f\u307e\u3060\u307e\u3068\u3082\u306b\u7d44\u3093\u3060\u3053\u3068\u304c\u306a\u3044\u306e\u3067\u3001\u3068\u308a\u3042\u3048\u305aiPhone\u4e0a\u306e\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306b\u65b0\u520a\u30b3\u30df\u30c3\u30af\u306e\u60c5\u5831\u3092JSON\u3067\u8fd4\u3059\u30b5\u30fc\u30d0\u30fc\u5074\u306eAPI\u3092\u3061\u3083\u3063\u3061\u3083\u3068\u66f8\u3044\u3066\u307f\u308b\u3053\u3068\u306b\u3057\u307e\u3057\u305f\u3002\n\n### \u65b0\u520a\u30b3\u30df\u30c3\u30af\u306e\u60c5\u5831\u3092\u53d6\u5f97\u3059\u308b\n\n\u307e\u305a\u65b0\u520a\u30b3\u30df\u30c3\u30af\u306e\u60c5\u5831\u3092\u3069\u3053\u304b\u3089\u53d6\u5f97\u3059\u308b\u304b\u3067\u3059\u304c\u3001\u4eca\u56de\u306f\u300c[\u30b3\u30df\u30c3\u30af\u30ca\u30bf\u30ea\u30fc](http://natalie.mu/comic)\u300d\u306e\u300c\u672c\u65e5\u767a\u58f2\u306e\u5358\u884c\u672c\u30ea\u30b9\u30c8\u300d\u306e\u8a18\u4e8b\u3092\u30b9\u30af\u30ec\u30a4\u30d4\u30f3\u30b0\u3059\u308b\u3053\u3068\u306b\u3057\u307e\u3057\u305f\u3002\u65b0\u520a\u30b3\u30df\u30c3\u30af\u306e\u60c5\u5831\u3092\u63d0\u4f9b\u3057\u3066\u3044\u308b\u30b5\u30a4\u30c8\u306f\u5e7e\u3064\u304b\u3042\u308a\u307e\u3059\u304c\u3001RSS\u3092\u914d\u4fe1\u3057\u3066\u3044\u308b\u3001amazon\u3078\u306e\u30ea\u30f3\u30af\u304c\u3042\u308b\u3001HTML\u306e\u69cb\u9020\u304c\u5358\u7d14\u3067\u30b9\u30af\u30ec\u30a4\u30d4\u30f3\u30b0\u3057\u3084\u3059\u3044\u3068\u3044\u3046\u7406\u7531\u3067\u300c\u30b3\u30df\u30c3\u30af\u30ca\u30bf\u30ea\u30fc\u300d\u306b\u6c7a\u3081\u307e\u3057\u305f\u3002\n\n\u51e6\u7406\u306e\u5927\u307e\u304b\u306a\u6d41\u308c\u306f\u3001\n\n1.\u300c\u30b3\u30df\u30c3\u30af\u30ca\u30bf\u30ea\u30fc\u300d\u306eRSS\u304b\u3089\u300c\u672c\u65e5\u767a\u58f2\u306e\u5358\u884c\u672c\u30ea\u30b9\u30c8\u300d\u306eURL\u3092\u53d6\u5f97\u3059\u308b\b\n2.\u300c\u672c\u65e5\u767a\u58f2\u306e\u5358\u884c\u672c\u30ea\u30b9\u30c8\u300d\u30da\u30fc\u30b8\u306e\u5185\u5bb9\u3092\u53d6\u5f97\u3059\u308b\n3. HTML\u3092\u30b9\u30af\u30ec\u30a4\u30d4\u30f3\u30b0\u3057\u3066\u65b0\u520a\u60c5\u5831\u3092\u53d6\u5f97\u3059\u308b\n4. \u65b0\u520a\u60c5\u5831\u3092\u30c7\u30fc\u30bf\u30fc\u30d9\u30fc\u30b9\u306b\u4fdd\u5b58\u3059\u308b\u3002\n\n\u3068\u3044\u3046\u611f\u3058\u3067\u3057\u3087\u3046\u304b\u3002\n\n\u307b\u307c\u6d41\u308c\u306e\u307e\u307e\u306bruby\u3067\u30b5\u30af\u30c3\u3068\u66f8\u3044\u3066\u307f\u307e\u3057\u305f\u3002\n\n\n```ruby:get_new_comics.rb\n\n# \u30b3\u30df\u30c3\u30af\u30ca\u30bf\u30ea\u30fc\u306e\u300c\u672c\u65e5\u767a\u58f2\u306e\u5358\u884c\u672c\u30ea\u30b9\u30c8\u300d\u3088\u308a\u66f8\u7c4d\u60c5\u5831\u3092\u30b9\u30af\u30ec\u30a4\u30d4\u30f3\u30b0\u3057\u3066\n# MySQL\u306b\u767b\u9332\u3059\u308b\n\nrequire 'rss'\nrequire 'open-uri'\nrequire 'nokogiri'\nrequire 'mysql2'\n\n# \u30b3\u30df\u30c3\u30af\u30ca\u30bf\u30ea\u30fc\u306eRSS\u304b\u3089\u65b0\u520a\u60c5\u5831\u306eURL\u3092\u53d6\u5f97\u3059\u308b\ndef get_urls(feed_url)\n  rss = RSS::Parser.parse(feed_url)\n  rss.items.select {|item| item.title.content =~ /\u672c\u65e5\u767a\u58f2\u306e\u5358\u884c\u672c\u30ea\u30b9\u30c8/}\n           .map {|item| item.link.href}\nend\n\n# URL\u304b\u3089\u30a2\u30d5\u30a3\u30ea\u30a8\u30a4\u30c8ID\u3092\u30ab\u30c3\u30c8\u3059\u308b\ndef strip_affiliate_id(url)\n\turl.gsub(/[^\\/]+$/, \"\")\nend\n\n# amazon\u306e\u5546\u54c1URL\u304b\u3089ASIN\u5024\u3092\u53d6\u5f97\u3059\u308b\ndef asin(url)\n  if url =~ /ASIN\\/(\\d+)\\//\n    $1\n  else\n    \"\"\n  end\nend\n\n# \u65b0\u520a\u66f8\u7c4d\u60c5\u5831\u3092\u53d6\u5f97\u3059\u308b\ndef get_comic_info(url)\n\n  books = []\n\n  html = open(url).read\n  doc = Nokogiri::HTML.parse(html)\n\n  release_date = nil\n  if doc.title =~ /\u3010(\\d+)\u6708(\\d+)\u65e5\u4ed8\u3011/\n    release_date = Time.local(Time.now.year, $1.to_i, $2.to_i)\n  end\n\n  doc.xpath(\"//div[@class='NA_articleBody']\").each do |div|\n    publisher = nil\n    div.elements.each do |elm|\n      if elm.name == \"h4\"\n        publisher = elm.inner_text\n      end\n      if elm.name == \"p\" && !publisher.nil?\n        elm.inner_html.split(\"<br>\").each do |line|\n          if line =~ /^<a href=\"(.+?)\".*>.*\u300c(.+)\u300d.*<\\/a>(.+)$/\n            books << {\n                title: $2.strip,\n                author: $3.strip,\n                publisher: publisher,\n                link: strip_affiliate_id($1),\n                asin: asin($1),\n                release_date: release_date\n              }\n          end\n        end\n      end\n    end\n  end\n\n  books\nend\n\n# \u540c\u4e00\u306eASIN\u3092\u6301\u3064\u30c7\u30fc\u30bf\u304cDB\u4e0a\u306b\u5b58\u5728\u3059\u308b\u304b\u30c1\u30a7\u30c3\u30af\ndef is_exists(asin, client)\n\tescaped_string = client.escape(asin)\n\tsql = \"SELECT COUNT(*) as count FROM books WHERE asin = '#{escaped_string}'\"\n\tclient.query(sql).each do |row|\n\t\treturn row['count'] > 0\n\tend\n\tfalse\nend\n\n# \u633f\u5165\u7528\u306eSQL\u6587\u3092\u751f\u6210\u3059\u308b\ndef insert_sql(book, client)\n  fields = book.keys\n  values = []\n  fields.each do |f|\n    if (f == :release_date)\n      if (book[f])\n        values << \"'#{book[f].strftime('%Y-%m-%d')}'\"\n      else\n        values << \"NULL\"\n      end\n    else\n      escaped_string = client.escape(book[f])\n      values << \"'#{escaped_string}'\"\n    end\n  end\n  \"INSERT INTO books (#{fields.map(&:to_s).join(',')}) \" +\n  \"VALUES (#{values.join(',')})\"\nend\n\n##\n## PROGRAM START\n##\n\n# \u30b3\u30df\u30c3\u30af\u30ca\u30bf\u30ea\u30fc\u306eRSS\nFEED_URL = \"http://natalie.mu/comic/feed/news\"\n# MySQL\u63a5\u7d9a\u7528\u306e\u30a2\u30ab\u30a6\u30f3\u30c8\u3068\u30d1\u30b9\u30ef\u30fc\u30c9\nDB_USER = \"XXXXX\"\nDB_PASSWORD = \"XXXXX\"\n\n# MySQL\u306b\u63a5\u7d9a\u3059\u308b\nclient = Mysql2::Client.new(host: 'localhost', username: DB_USER, password: DB_PASSWORD, database: 'comic_db')\n\n# URL\u306e\u30ea\u30b9\u30c8\u3092\u9806\u6b21\u51e6\u7406\u3059\u308b\nurls = ARGV.empty? ? get_urls(FEED_URL) : ARGV\nurls.each do |url|\n  # \u30b3\u30df\u30c3\u30af\u30ca\u30bf\u30ea\u30fc\u306e\u65b0\u520a\u60c5\u5831\u30da\u30fc\u30b8\u3088\u308a\u66f8\u7c4d\u60c5\u5831\u3092\u53d6\u5f97\u3059\u308b\n  get_comic_info(url).each do |book|\n\t# \u540c\u4e00ASIN\u306e\u66f8\u7c4d\u304cDB\u306b\u5b58\u5728\u3057\u306a\u3051\u308c\u3070\u767b\u9332\u3059\u308b\n\tunless is_exists(book[:asin], client)\n      client.query(insert_sql(book, client))\n    end\n  end\nend\n\n```\n\n\u53d6\u5f97\u3057\u305f\u65b0\u520a\u60c5\u5831\u306fMySQL\u4e0a\u306ebooks\u3068\u3044\u3046\u30c6\u30fc\u30d6\u30eb\u306b\u4fdd\u5b58\u3059\u308b\u3088\u3046\u306b\u3057\u307e\u3057\u305f\u3002\n\n```SQL\n\nCREATE TABLE `books` (\n  `id` int(10) unsigned NOT NULL AUTO_INCREMENT,\n  `title` varchar(250) DEFAULT NULL,\n  `author` varchar(250) DEFAULT NULL,\n  `publisher` varchar(250) DEFAULT NULL,\n  `link` varchar(250) DEFAULT NULL,\n  `asin` varchar(20) DEFAULT NULL,\n  `release_date` datetime DEFAULT NULL,\n  PRIMARY KEY (`id`),\n  KEY `IDX_ASIN` (`asin`)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8\n\n```\n\n\u3053\u306eruby\u306e\u30b9\u30af\u30ea\u30d7\u30c8\u3092cron\u3067\u6bce\u65e5\u5b9f\u884c\u3057\u3066\u3084\u308c\u3070\u3001\u65e5\u3005\u767a\u58f2\u3055\u308c\u308b\u65b0\u520a\u30b3\u30df\u30c3\u30af\u306e\u60c5\u5831\u304c\u30b5\u30fc\u30d0\u30fc\u4e0a\u306e\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306b\u52dd\u624b\u306b\u6e9c\u307e\u3063\u3066\u3044\u304f\u3068\u3044\u3046\u5bf8\u6cd5\u3067\u3059\u3002\n\n### \u65b0\u520a\u60c5\u5831\u3092\u53d6\u5f97\u3059\u308bAPI\n\n\u7d9a\u3044\u3066\u3001\u30b5\u30fc\u30d0\u30fc\u4e0a\u306e\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306b\u4fdd\u5b58\u3055\u308c\u305f\u65b0\u520a\u60c5\u5831\u3092JSON\u5f62\u5f0f\u3067\u8fd4\u3059API\u3067\u3059\u3002\n\u30d1\u30e9\u30e1\u30fc\u30bf\u30fc\u3068\u3057\u3066\u65e5\u4ed8\u3092\u6e21\u3057\u3066\u3001\u8a72\u5f53\u65e5\u306b\u767a\u58f2\u3055\u308c\u308b\u30b3\u30df\u30c3\u30af\u306e\u60c5\u5831\u3092JSON\u3067\u8fd4\u3059\u3068\u3044\u3046\u5358\u7d14\u306a\u3082\u306e\u3067\u3059\u3002\n\u30d5\u30ec\u30fc\u30e0\u30ef\u30fc\u30af\u3068\u304b\u5927\u8888\u88df\u306a\u3082\u306e\u306f\u4f7f\u308f\u305a\b\u7d20\u306ePHP\u3067\u3071\u3063\u3071\u3068\u66f8\u3044\u3066\u3057\u307e\u3044\u307e\u3059\u3002\n\n\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u53d6\u5f97\u3059\u308b\u3068\u3053\u3068\u304b\u3082\u3063\u3068\u30de\u30b7\u306b\u66f8\u3051\u305d\u3046\u306a\u6c17\u304c\u3057\u307e\u3059\u304c\u6c17\u306b\u3057\u306a\u3044\u3067\u304a\u304d\u307e\u3059\u3002\n\n```php:comic_list.php\n\n<?php\n\t# \u6307\u5b9a\u3057\u305f\u65e5\u4ed8\u306e\u65b0\u520a\u66f8\u7c4d\u306e\u30ea\u30b9\u30c8\u3092JSON\u3067\u8fd4\u3059\u3002\n\t# Using : http://foo.bar/api/comic_list.php?dt=20150101\n\t# \u5f15\u6570\n\t# \u3000dt\uff1a8\u6841\uff08\u5e744\u6841\u3001\u67082\u6841\u3001\u65e52\u6841\uff09\u306e\u65e5\u4ed8\u3092\u793a\u3059\u6570\u5024\uff08\u7701\u7565\u6642\u306f\u5f53\u65e5\uff09\n\n\t# DB\u63a5\u7d9a\u7528\u306e\u5b9a\u6570\n\tconst DB_CONNECTION_STRING = \"mysql:host=localhost;dbname=comic_db;charset=utf8\";\n\tconst DB_USER = \"XXXXX\";\n\tconst DB_PASSWORD = \"XXXXX\";\n\n\t# \u30d1\u30e9\u30e1\u30fc\u30bf\u30fc\u3092\u53d6\u5f97\u3059\u308b\n\tfunction getParams()\n\t{\n\t\tif (empty($_GET[\"dt\"]))\n\t\t{\n\t\t\t$dt = new DateTimeImmutable();\n\t\t}\n\t\telse\n\t\t{\n\t\t\tif (preg_match(\"/^(\\d{4})(\\d{2})(\\d{2})$/\", $_GET[\"dt\"], $m))\n\t\t\t\t$dt = new DateTimeImmutable(\"{$m[1]}-{$m[2]}-{$m[3]}\");\n\t\t\telse\n\t\t\t\tthrow new Exception(\"Invalid format\");\n\t\t}\n\t\treturn [\":dt\" => $dt->format(\"Y-m-d\")];\n\t}\n\n\t# DB\u3088\u308a\u66f8\u7c4d\u60c5\u5831\u3092\u53d6\u5f97\u3059\u308b\n\tfunction getBooks($params)\n\t{\n\t\t$books = [];\n\t\t$conn = new PDO(DB_CONNECTION_STRING,DB_USER,DB_PASSWORD);\n\t\t$sql = \"SELECT * FROM books WHERE release_date = :dt ORDER BY id\";\n\t\t$stmt = $conn->prepare($sql);\n\t\tif ($stmt->execute($params))\n\t\t{\n\t\t\twhile ($row = $stmt->fetch(PDO::FETCH_ASSOC))\n\t\t\t{\n\t\t\t\t$books[] = $row;\n\t\t\t}\n\t\t}\n\t\treturn $books;\n\t}\n\n\t#\n\t# PROGRAM START\n\t#\n\ttry\n\t{\n\t\t# \u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u53d6\u5f97\u3059\u308b\n\t\t$params = getParams();\n\t\t\n\t\t# \u66f8\u7c4d\u60c5\u5831\u3092\u53d6\u5f97\u3059\u308b\u3002\n\t\t$books = getBooks($params);\n\t\t\n\t\t# \u66f8\u7c4d\u60c5\u5831\u3092JSON\u3067\u8fd4\u3059\u3002\n\t\theader(\"Content-Type: application/json\");\n\t\techo json_encode($books, JSON_UNESCAPED_UNICODE + JSON_UNESCAPED_SLASHES);\n\t} \n\tcatch (Exception $e)\n\t{\n\t\t# \u4f8b\u5916\u304c\u767a\u751f\u3057\u305f\n\t\texit($e->getMessage());\n\t}\n\n```\n\n\u30b5\u30fc\u30d0\u30fc\u306b\u8a2d\u7f6e\u3057\u3066\u30a2\u30af\u30bb\u30b9\u3057\u3066\u307f\u308b\u3068\u3001\n\n```\n[\n{\"id\":\"13\",\"title\":\"\u4faf\u7235\u3068\u3082\u3064\u308c\u305f\u611b\u306e\u7cf8\",\"author\":\"\u7dbe\u90e8\u745e\u7a42/\u30d0\u30fc\u30d0\u30e9\u30fb\u30ab\u30fc\u30c8\u30e9\u30f3\u30c9\",\"publisher\":\"\u5b99\u51fa\u7248\",\"link\":\"http://www.amazon.co.jp/exec/obidos/ASIN/4776739143/\",\"asin\":\"4776739143\",\"release_date\":\"2015-01-05 00:00:00\"},\n{\"id\":\"14\",\"title\":\"\u5e73\u5b89\u3061\u3087\u3053\u3063\u3068\u604b\u7d75\u5dfb\uff081\uff09\",\"author\":\"\u536f\u5d0e\u3072\u3068\u307f\",\"publisher\":\"\u5b99\u51fa\u7248\",\"link\":\"http://www.amazon.co.jp/exec/obidos/ASIN/4776739186/\",\"asin\":\"4776739186\",\"release_date\":\"2015-01-05 00:00:00\"},\n{\"id\":\"15\",\"title\":\"\u30cf\u30ea\u30a6\u30c3\u30c9\u30b9\u30bf\u30fc\u306e\u604b\u4eba\",\"author\":\"\u9152\u4e95\u7f8e\u7fbd\",\"publisher\":\"\u5b99\u51fa\u7248\",\"link\":\"http://www.amazon.co.jp/exec/obidos/ASIN/4776739135/\",\"asin\":\"4776739135\",\"release_date\":\"2015-01-05 00:00:00\"},{\"id\":\"16\",\"title\":\"\u5fa9\u8b90\u306e\u5473\u306f\u604b\u306e\u5473\",\"author\":\"\u6a4b\u672c\u591a\u4f73\u5b50/\u30b7\u30e3\u30fc\u30ea\u30fc\u30fb\u30b8\u30e3\u30f3\u30d7\",\"publisher\":\"\u5b99\u51fa\u7248\",\"link\":\"http://www.amazon.co.jp/exec/obidos/ASIN/4776739151/\",\"asin\":\"4776739151\",\"release_date\":\"2015-01-05 00:00:00\"},\n{\"id\":\"17\",\"title\":\"\u5929\u306b\u604b\u3046\uff084\uff09\",\"author\":\"\u671b\u6708\u685c/\u68a8\u5343\u5b50\",\"publisher\":\"\u5b99\u51fa\u7248\",\"link\":\"http://www.amazon.co.jp/exec/obidos/ASIN/4776739178/\",\"asin\":\"4776739178\",\"release_date\":\"2015-01-05 00:00:00\"},\n... \u7565 ...\n]\n```\n\n\u3068\u3044\u3046\u611f\u3058\u306eJSON\u304c\u53d6\u5f97\u3067\u304d\u305f\u306e\u3067\u3001\u4f55\u3068\u304b\u52d5\u3044\u3066\u3044\u308b\u3088\u3046\u3060\u3002\n\n\u6b21\u306f\u3001\u3053\u306eAPI\u3092\u547c\u3073\u51fa\u3059iPhone\u7528\u306e\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3060\u3051\u3069\u3001\u30c7\u30d9\u30ed\u30c3\u30d1\u30fc\u5951\u7d04\u3059\u308b\u3068\u3053\u304b\u3089\u59cb\u3081\u306a\u3044\u3068...\n", "tags": ["\u30b5\u30f3\u30d7\u30eb", "Ruby", "PHP"]}