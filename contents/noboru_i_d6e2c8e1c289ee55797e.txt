{"context": "\n\n\u306a\u305c\u3084\u308b\u304b\nGCP\u306f\u7121\u6599\u67a0\u304c\u5927\u304d\u304f\u3001\u5c0f\u898f\u6a21\u306e\u30b5\u30fc\u30d3\u30b9\u3067\u3042\u308c\u3070DataStore\u306f\u7121\u6599\u67a0\u3067\u4f7f\u3044\u7d9a\u3051\u3089\u308c\u308b\u3068\u601d\u3044\u307e\u3059\u3002\uff08 http://my-android-server.appspot.com/ \u306f\u3001\u5b9f\u969b\u306b\u7121\u6599\u67a0\u3067\u53ce\u307e\u3063\u3066\u3044\u307e\u3059\u3002\uff09\nGoogle App Engine\u3082\u5c0f\u898f\u6a21\u3067\u3042\u308c\u3070\u7121\u6599\u3067\u4f7f\u3044\u7d9a\u3051\u3089\u308c\u307e\u3059\u304c\u3001\u5229\u7528\u3067\u304d\u308b\u8a00\u8a9e\u306b\u5236\u9650\u304c\u3042\u308a\u307e\u3059\u3002\nRuby\u3092\u3084\u308a\u305f\u304f\u306a\u3063\u305f\u306e\u3067\u3001Heroku\u3078\u306e\u79fb\u884c\u3092\u691c\u8a0e\u3057\u3066\u3044\u307e\u3059\u304c\u3001DataStore\u306f\u305d\u306e\u307e\u307e\u4f7f\u3044\u7d9a\u3051\u305f\u304b\u3063\u305f\u306e\u3067\u3001DataStore\u3092\u5916\u90e8\u304b\u3089\u5229\u7528\u3059\u308b\u65b9\u6cd5\u3092\u8a66\u3057\u307e\u3057\u305f\u3002\n\nGCP\u4e0a\u3067\u30b5\u30fc\u30d3\u30b9\u30a2\u30ab\u30a6\u30f3\u30c8\u3092\u4f5c\u6210\nhttps://console.cloud.google.com/iam-admin/serviceaccounts/project?project=my-android-server\n\u203bmy-android-server\u306e\u90e8\u5206\u306f\u3001\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u306b\u5408\u308f\u305b\u3066\u5909\u3048\u308b\u3002\n\n\u300c\u30b5\u30fc\u30d3\u30b9\u30a2\u30ab\u30a6\u30f3\u30c8\u3092\u4f5c\u6210\u300d\u3092\u30af\u30ea\u30c3\u30af\n\n\u300c\u30b5\u30fc\u30d3\u30b9\u30a2\u30ab\u30a6\u30f3\u30c8\u540d\u300d\u3092\u9069\u5f53\u306b\u5165\u529b\u3001\n\u300c\u5f79\u5272\u300d\u306b\u3066\u5fc5\u8981\u306a\u6a29\u9650\uff08\u4eca\u56de\u3067\u3042\u308c\u3070\u300c\u7de8\u96c6\u8005\u300d\u3068\u300c\u30c7\u30fc\u30bf\u30b9\u30c8\u30a2\u30aa\u30fc\u30ca\u30fc\u300d\uff09\u3092\u9078\u629e\u3057\u3001\n\u300c\u65b0\u3057\u3044\u79d8\u5bc6\u9375\u306e\u63d0\u4f9b\u300d\u306b\u30c1\u30a7\u30c3\u30af\u3092\u5165\u308c\u3001\u300c\u4f5c\u6210\u300d\u3092\u30af\u30ea\u30c3\u30af\u3057\u307e\u3059\u3002\n\u203b\u300c\u30c7\u30fc\u30bf\u30b9\u30c8\u30a2\u30aa\u30fc\u30ca\u30fc\u300d\u3060\u3051\u3060\u3068\u3001\u6a29\u9650\u306e\u30a8\u30e9\u30fc\u304c\u51fa\u307e\u3057\u305f\u3002\u3002\u3002\u3051\u3069\u3001\u4eca\u300c\u7de8\u96c6\u8005\u300d\u3092\u5916\u3057\u3066\u3082\u52d5\u4f5c\u3059\u308b\u3002\u8b0e\u3002\nJSON\u30d5\u30a1\u30a4\u30eb\u304c\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3055\u308c\u308b\u306e\u3067\u3001Rails\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u4efb\u610f\u306e\u5834\u6240\u306b\u4fdd\u7ba1\u3057\u307e\u3059\u3002\n\u4eca\u56de\u306f\u3001\u76f4\u4e0b\u306bcert\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u4f5c\u6210\u3057\u3001\u305d\u3053\u306b\u914d\u7f6e\u3057\u307e\u3057\u305f\u3002\n\uff08\u30d5\u30a1\u30a4\u30eb\u540d\u306fmy-android-server-000000000000.json\u3068\u3057\u3066\u9032\u3081\u307e\u3059\u3002\uff09\n\nHeroku\u3067\u4f7f\u3046\u305f\u3081\u306e\u6e96\u5099\n\u7528\u610f\u3057\u305fcert\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092Git\u306b\u30b3\u30df\u30c3\u30c8\u3057\u305f\u304f\u306a\u304b\u3063\u305f\u306e\u3067\u3001Heroku\u306e\u74b0\u5883\u5909\u6570\u3068\u3057\u3066\u767b\u9332\u3059\u308b\u3053\u3068\u306b\u3057\u307e\u3057\u305f\u3002\nheroku config:add GCP_KEY=\"$(cat cert/my-android-server-000000000000.json)\"\n\u3053\u308c\u3067\u3001json\u306e\u5185\u5bb9\u3092\u74b0\u5883\u5909\u6570\u304b\u3089\u53d6\u5f97\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\n\nRails\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u5b9f\u88c5\nhttps://developers.google.com/api-client-library/ruby/auth/service-accounts\nhttps://cloud.google.com/datastore/reference/rest/v1beta3/projects/lookup\n\u3092\u53c2\u8003\u306b\u5b9f\u88c5\u3057\u3066\u3044\u304d\u307e\u3059\u3002\n\u3068\u308a\u3042\u3048\u305a\u3001controller\u306b\u3079\u305f\u66f8\u304d\u3057\u307e\u3057\u305f\u3002\uff08\u30db\u30f3\u30c8\u306flib\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306e\u4e2d\u3068\u304b\u3067\u62bd\u8c61\u5316\u3057\u305f\u307b\u3046\u304c\u826f\u3044\u306e\u304b\u306a\uff1f\uff09\nrequire 'googleauth'\nrequire 'google/apis/datastore_v1'\n\nclass WelcomeController < ApplicationController\n  # https://github.com/google/google-api-ruby-client/blob/master/generated/google/apis/datastore_v1/classes.rb\n  ServiceAccountCredentials  = Google::Auth::ServiceAccountCredentials\n  Datastore  = Google::Apis::DatastoreV1\n  RunQueryRequest = Google::Apis::DatastoreV1::RunQueryRequest\n  GqlQuery = Google::Apis::DatastoreV1::GqlQuery\n  GqlQueryParameter = Google::Apis::DatastoreV1::GqlQueryParameter\n  Value = Google::Apis::DatastoreV1::Value\n\n  def index\n    datastore = Google::Apis::DatastoreV1::DatastoreService.new\n\n    dummyFile = DummyFile.new(ENV['GCP_KEY']) if ENV['GCP_KEY'].present?\n    datastore.authorization = ServiceAccountCredentials.make_creds(\n        json_key_io: dummyFile || File.open('cert/my-android-server-000000000000.json'),\n        scope: [\n          Datastore::AUTH_CLOUD_PLATFORM,\n          Datastore::AUTH_DATASTORE\n        ]\n    )\n\n    query = GqlQuery.new(\n        query_string: 'SELECT * FROM GcmModel LIMIT @limit',\n        named_bindings: {\n          limit: GqlQueryParameter.new(value: Value.new(integer_value: '5'))\n        }\n    )\n    request = RunQueryRequest.new(gql_query: query)\n    result = datastore.run_project_query('my-android-server', request)\n    render json: result.batch.entity_results[0].entity.as_json\n  end\n\n  class DummyFile\n    attr_accessor :read\n    def initialize(read)\n       @read = read\n    end\n  end\nend\n\nmy-android-server\u3068\u3044\u3046\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u306e\u3001GcmModel\u30925\u4ef6\u53d6\u5f97\u3057\u3066\u30011\u4ef6\u76ee\u3092json\u5f62\u5f0f\u3067\u8fd4\u3057\u3066\u3044\u307e\u3059\u3002\nDummyFile\u3042\u305f\u308a\u304c\u4e0a\u624b\u304f\u5b9f\u88c5\u3067\u304d\u306a\u304f\u3066\u3001GCP_KEY\u304c\u5b58\u5728\u3059\u308b\u5834\u5408\u306f\u305d\u3053\u304b\u3089\u60c5\u5831\u3092\u8aad\u307f\u53d6\u308a\u3001\u305d\u308c\u4ee5\u5916\uff08\u30ed\u30fc\u30ab\u30eb\uff09\u3067\u306f\u30d5\u30a1\u30a4\u30eb\u304b\u3089\u8aad\u307f\u53d6\u308b\u3088\u3046\u306b\u3057\u3066\u3044\u307e\u3059\u3002\n\u5185\u90e8\u7684\u306bread\u3092\u5b9f\u884c\u3057\u3066\u3044\u305f\u306e\u3067\u3001read\u3068\u3044\u3046\u30d7\u30ed\u30d1\u30c6\u30a3\u3092\u6301\u305f\u305b\u308b\u3053\u3068\u3067\u56de\u907f\u3057\u307e\u3057\u305f\u3002\n\n\u7d50\u679c\n\u4e0b\u8a18\u306e\u3088\u3046\u306ajson\u3092\u53d6\u5f97\u3067\u304d\u307e\u3059\u3002\n{\n  \"properties\": {\n    \"registrationId\": {\n      \"string_value\": \"XXXX\"\n    },\n    \"registDate\": {\n      \"timestamp_value\": \"2012-10-08T21:59:59.661960Z\"\n    }\n  },\n  \"key\": {\n    \"partition_id\": {\n      \"project_id\": \"my-android-server\"\n    },\n    \"path\": [\n      {\n        \"kind\": \"GcmModel\",\n        \"id\": \"111111\"\n      }\n    ]\n  }\n}\n\nGcmModel\u3068\u3057\u3066\u306f\u3001registrationId\u3068registDate\u304c\u3042\u308a\u307e\u3059\u3002\nXXX_value\u3068\u3044\u3046\u306e\u304c\u3042\u308b\u306e\u304c\u3001\u3061\u3087\u3063\u3068\u9762\u5012\u3067\u3059\u306d\u3002\n## \u306a\u305c\u3084\u308b\u304b\n\nGCP\u306f\u7121\u6599\u67a0\u304c\u5927\u304d\u304f\u3001\u5c0f\u898f\u6a21\u306e\u30b5\u30fc\u30d3\u30b9\u3067\u3042\u308c\u3070DataStore\u306f\u7121\u6599\u67a0\u3067\u4f7f\u3044\u7d9a\u3051\u3089\u308c\u308b\u3068\u601d\u3044\u307e\u3059\u3002\uff08 http://my-android-server.appspot.com/ \u306f\u3001\u5b9f\u969b\u306b\u7121\u6599\u67a0\u3067\u53ce\u307e\u3063\u3066\u3044\u307e\u3059\u3002\uff09\n\nGoogle App Engine\u3082\u5c0f\u898f\u6a21\u3067\u3042\u308c\u3070\u7121\u6599\u3067\u4f7f\u3044\u7d9a\u3051\u3089\u308c\u307e\u3059\u304c\u3001\u5229\u7528\u3067\u304d\u308b\u8a00\u8a9e\u306b\u5236\u9650\u304c\u3042\u308a\u307e\u3059\u3002\n\nRuby\u3092\u3084\u308a\u305f\u304f\u306a\u3063\u305f\u306e\u3067\u3001Heroku\u3078\u306e\u79fb\u884c\u3092\u691c\u8a0e\u3057\u3066\u3044\u307e\u3059\u304c\u3001DataStore\u306f\u305d\u306e\u307e\u307e\u4f7f\u3044\u7d9a\u3051\u305f\u304b\u3063\u305f\u306e\u3067\u3001DataStore\u3092\u5916\u90e8\u304b\u3089\u5229\u7528\u3059\u308b\u65b9\u6cd5\u3092\u8a66\u3057\u307e\u3057\u305f\u3002\n\n## GCP\u4e0a\u3067\u30b5\u30fc\u30d3\u30b9\u30a2\u30ab\u30a6\u30f3\u30c8\u3092\u4f5c\u6210\n\nhttps://console.cloud.google.com/iam-admin/serviceaccounts/project?project=my-android-server\n\u203b`my-android-server`\u306e\u90e8\u5206\u306f\u3001\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u306b\u5408\u308f\u305b\u3066\u5909\u3048\u308b\u3002\n\n![image](https://qiita-image-store.s3.amazonaws.com/0/8708/e25632ef-9ce7-b7a3-6bca-4eae032fd7cf.png)\n\n\n\u300c\u30b5\u30fc\u30d3\u30b9\u30a2\u30ab\u30a6\u30f3\u30c8\u3092\u4f5c\u6210\u300d\u3092\u30af\u30ea\u30c3\u30af\n\n![image](https://qiita-image-store.s3.amazonaws.com/0/8708/8e36bf71-1c4e-334e-a5ec-311438ee8833.png)\n\n\u300c\u30b5\u30fc\u30d3\u30b9\u30a2\u30ab\u30a6\u30f3\u30c8\u540d\u300d\u3092\u9069\u5f53\u306b\u5165\u529b\u3001\n\u300c\u5f79\u5272\u300d\u306b\u3066\u5fc5\u8981\u306a\u6a29\u9650\uff08\u4eca\u56de\u3067\u3042\u308c\u3070\u300c\u7de8\u96c6\u8005\u300d\u3068\u300c\u30c7\u30fc\u30bf\u30b9\u30c8\u30a2\u30aa\u30fc\u30ca\u30fc\u300d\uff09\u3092\u9078\u629e\u3057\u3001\n\u300c\u65b0\u3057\u3044\u79d8\u5bc6\u9375\u306e\u63d0\u4f9b\u300d\u306b\u30c1\u30a7\u30c3\u30af\u3092\u5165\u308c\u3001\u300c\u4f5c\u6210\u300d\u3092\u30af\u30ea\u30c3\u30af\u3057\u307e\u3059\u3002\n\n\u203b\u300c\u30c7\u30fc\u30bf\u30b9\u30c8\u30a2\u30aa\u30fc\u30ca\u30fc\u300d\u3060\u3051\u3060\u3068\u3001\u6a29\u9650\u306e\u30a8\u30e9\u30fc\u304c\u51fa\u307e\u3057\u305f\u3002\u3002\u3002\u3051\u3069\u3001\u4eca\u300c\u7de8\u96c6\u8005\u300d\u3092\u5916\u3057\u3066\u3082\u52d5\u4f5c\u3059\u308b\u3002\u8b0e\u3002\n\nJSON\u30d5\u30a1\u30a4\u30eb\u304c\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3055\u308c\u308b\u306e\u3067\u3001Rails\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u4efb\u610f\u306e\u5834\u6240\u306b\u4fdd\u7ba1\u3057\u307e\u3059\u3002\n\u4eca\u56de\u306f\u3001\u76f4\u4e0b\u306bcert\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u4f5c\u6210\u3057\u3001\u305d\u3053\u306b\u914d\u7f6e\u3057\u307e\u3057\u305f\u3002\n\uff08\u30d5\u30a1\u30a4\u30eb\u540d\u306f`my-android-server-000000000000.json`\u3068\u3057\u3066\u9032\u3081\u307e\u3059\u3002\uff09\n\n## Heroku\u3067\u4f7f\u3046\u305f\u3081\u306e\u6e96\u5099\n\n\u7528\u610f\u3057\u305fcert\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092Git\u306b\u30b3\u30df\u30c3\u30c8\u3057\u305f\u304f\u306a\u304b\u3063\u305f\u306e\u3067\u3001Heroku\u306e\u74b0\u5883\u5909\u6570\u3068\u3057\u3066\u767b\u9332\u3059\u308b\u3053\u3068\u306b\u3057\u307e\u3057\u305f\u3002\n\n`heroku config:add GCP_KEY=\"$(cat cert/my-android-server-000000000000.json)\"`\n\n\u3053\u308c\u3067\u3001json\u306e\u5185\u5bb9\u3092\u74b0\u5883\u5909\u6570\u304b\u3089\u53d6\u5f97\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\n\n## Rails\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u5b9f\u88c5\n\nhttps://developers.google.com/api-client-library/ruby/auth/service-accounts\nhttps://cloud.google.com/datastore/reference/rest/v1beta3/projects/lookup\n\u3092\u53c2\u8003\u306b\u5b9f\u88c5\u3057\u3066\u3044\u304d\u307e\u3059\u3002\n\n\u3068\u308a\u3042\u3048\u305a\u3001controller\u306b\u3079\u305f\u66f8\u304d\u3057\u307e\u3057\u305f\u3002\uff08\u30db\u30f3\u30c8\u306flib\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306e\u4e2d\u3068\u304b\u3067\u62bd\u8c61\u5316\u3057\u305f\u307b\u3046\u304c\u826f\u3044\u306e\u304b\u306a\uff1f\uff09\n\n```ruby\nrequire 'googleauth'\nrequire 'google/apis/datastore_v1'\n\nclass WelcomeController < ApplicationController\n  # https://github.com/google/google-api-ruby-client/blob/master/generated/google/apis/datastore_v1/classes.rb\n  ServiceAccountCredentials  = Google::Auth::ServiceAccountCredentials\n  Datastore  = Google::Apis::DatastoreV1\n  RunQueryRequest = Google::Apis::DatastoreV1::RunQueryRequest\n  GqlQuery = Google::Apis::DatastoreV1::GqlQuery\n  GqlQueryParameter = Google::Apis::DatastoreV1::GqlQueryParameter\n  Value = Google::Apis::DatastoreV1::Value\n\n  def index\n    datastore = Google::Apis::DatastoreV1::DatastoreService.new\n\n    dummyFile = DummyFile.new(ENV['GCP_KEY']) if ENV['GCP_KEY'].present?\n    datastore.authorization = ServiceAccountCredentials.make_creds(\n        json_key_io: dummyFile || File.open('cert/my-android-server-000000000000.json'),\n        scope: [\n          Datastore::AUTH_CLOUD_PLATFORM,\n          Datastore::AUTH_DATASTORE\n        ]\n    )\n\n    query = GqlQuery.new(\n        query_string: 'SELECT * FROM GcmModel LIMIT @limit',\n        named_bindings: {\n          limit: GqlQueryParameter.new(value: Value.new(integer_value: '5'))\n        }\n    )\n    request = RunQueryRequest.new(gql_query: query)\n    result = datastore.run_project_query('my-android-server', request)\n    render json: result.batch.entity_results[0].entity.as_json\n  end\n\n  class DummyFile\n    attr_accessor :read\n    def initialize(read)\n       @read = read\n    end\n  end\nend\n```\n\n`my-android-server`\u3068\u3044\u3046\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u306e\u3001GcmModel\u30925\u4ef6\u53d6\u5f97\u3057\u3066\u30011\u4ef6\u76ee\u3092json\u5f62\u5f0f\u3067\u8fd4\u3057\u3066\u3044\u307e\u3059\u3002\n\n`DummyFile`\u3042\u305f\u308a\u304c\u4e0a\u624b\u304f\u5b9f\u88c5\u3067\u304d\u306a\u304f\u3066\u3001`GCP_KEY`\u304c\u5b58\u5728\u3059\u308b\u5834\u5408\u306f\u305d\u3053\u304b\u3089\u60c5\u5831\u3092\u8aad\u307f\u53d6\u308a\u3001\u305d\u308c\u4ee5\u5916\uff08\u30ed\u30fc\u30ab\u30eb\uff09\u3067\u306f\u30d5\u30a1\u30a4\u30eb\u304b\u3089\u8aad\u307f\u53d6\u308b\u3088\u3046\u306b\u3057\u3066\u3044\u307e\u3059\u3002\n\u5185\u90e8\u7684\u306b`read`\u3092\u5b9f\u884c\u3057\u3066\u3044\u305f\u306e\u3067\u3001`read`\u3068\u3044\u3046\u30d7\u30ed\u30d1\u30c6\u30a3\u3092\u6301\u305f\u305b\u308b\u3053\u3068\u3067\u56de\u907f\u3057\u307e\u3057\u305f\u3002\n\n## \u7d50\u679c\n\n\u4e0b\u8a18\u306e\u3088\u3046\u306ajson\u3092\u53d6\u5f97\u3067\u304d\u307e\u3059\u3002\n\n```\n{\n  \"properties\": {\n    \"registrationId\": {\n      \"string_value\": \"XXXX\"\n    },\n    \"registDate\": {\n      \"timestamp_value\": \"2012-10-08T21:59:59.661960Z\"\n    }\n  },\n  \"key\": {\n    \"partition_id\": {\n      \"project_id\": \"my-android-server\"\n    },\n    \"path\": [\n      {\n        \"kind\": \"GcmModel\",\n        \"id\": \"111111\"\n      }\n    ]\n  }\n}\n```\n\nGcmModel\u3068\u3057\u3066\u306f\u3001`registrationId`\u3068`registDate`\u304c\u3042\u308a\u307e\u3059\u3002\n`XXX_value`\u3068\u3044\u3046\u306e\u304c\u3042\u308b\u306e\u304c\u3001\u3061\u3087\u3063\u3068\u9762\u5012\u3067\u3059\u306d\u3002\n", "tags": ["Rails", "Heroku", "gcp", "datastore"]}