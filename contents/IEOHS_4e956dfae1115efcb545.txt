{"context": "\n\nWRF\u30c7\u30fc\u30bf\u304b\u3089\u7def\u5ea6\u30fb\u7d4c\u5ea6\u3092\u6307\u5b9a\u3057\u3066\u30c7\u30fc\u30bf\u3092\u629c\u304d\u51fa\u3059\n\u3000WRF\u306e\u8a08\u7b97\u7d50\u679c\u304b\u3089\u3042\u308b\u30b0\u30ea\u30c3\u30c9\uff08\u307e\u305f\u306f\u3001\u6307\u5b9a\u3059\u308b\u5730\u70b9\u306b\u6700\u3082\u8fd1\u3044\u30b0\u30ea\u30c3\u30c9\uff09\u306e\u30c7\u30fc\u30bf\u3092\u53d6\u5f97\u3057\u3066\u3001\u6642\u7cfb\u5217\u306e\u30c7\u30fc\u30bf\u89e3\u6790\u3092\u884c\u3044\u305f\u3044\u6642\u3001R\u3067\u30c7\u30fc\u30bf\u3092\u53d6\u5f97\u3059\u308b\u65b9\u6cd5\u3092\u30e1\u30e2\u3059\u308b\u3002\n\u3000WRF\u306e\u7d50\u679c\u306f\u30b0\u30ea\u30c3\u30c9\u306e\u4f4d\u7f6e\u60c5\u5831\u304c\u7def\u5ea6\u3001\u7d4c\u5ea6\u3067\u51fa\u529b\u3055\u308c\u308b\u306e\u3067\u3001\u6307\u5b9a\u3057\u305f\u4f4d\u7f6e\u3068\u6700\u3082\u8fd1\u3044\u8ddd\u96e2\u306b\u3042\u308b\u30b0\u30ea\u30c3\u30c9\u3092\u6c42\u3081\u308b\u3088\u3046\u3001\u8a08\u7b97\u5f0f\u306bHubeny\u306e\u516c\u5f0f\u3092\u7528\u3044\u305f\u3002\n\u3000Hubeny\u306e\u516c\u5f0f\u306f\u3001\u30ab\u30b7\u30df\u30fc\u30eb3D\u306a\u3069\u306e\u8ddd\u96e2\u8a08\u7b97\u306b\u4f7f\u7528\u3055\u308c\u3066\u3044\u308b\u7c21\u6613\u5f0f\u3067\u3001\u8a08\u7b97\u5f0f\u306e\u6982\u8981\u306f\u4e8c\u5730\u70b9\u306e\u7def\u5ea6\u30fb\u7d4c\u5ea6\u304b\u3089\u305d\u306e\u8ddd\u96e2\u3092\u8a08\u7b97\u3059\u308b[1]\u3084\u3001\u30d2\u30e5\u30d9\u30cb\u306e\u5f0f\u304c2\u7a2e\u985e\u3042\u308a\u307e\u3059\u304c\u3069\u3053\u304c\u9055\u3046\u306e\u3067\u3059\u304b\uff1f[2]\u306e\u30da\u30fc\u30b8\u306b\u8aac\u660e\u3055\u308c\u3066\u3044\u307e\u3059\u3002[1]\u306bR\u7248\u30b9\u30af\u30ea\u30d7\u30c8\u304c\u63b2\u8f09\u3055\u308c\u3066\u3044\u307e\u3057\u305f\u306e\u3067\u3001\u4e00\u90e8\u6539\u5909\u3057\u3066\u4f7f\u7528\u3055\u305b\u3066\u3044\u305f\u3060\u304d\u307e\u3057\u305f\u3002\n\u3000\u6b63\u76f4\u3001\u3053\u3053\u307e\u3067\u53b3\u5bc6\u3058\u3083\u306a\u304f\u3066\u3082\u3001\u7def\u5ea6\u3001\u7d4c\u5ea6\u5dee\u304c\u4e00\u756a\u5c0f\u3055\u304f\u306a\u308b\u30dd\u30a4\u30f3\u30c8\u3092\u629c\u304d\u51fa\u305b\u3070\u3059\u3080\u306e\u3060\u304c\u3001\u5225\u4ef6\u3067Hubeny\u306e\u5f0f\u3092\u4f7f\u3063\u305f\u306e\u3067\u3001\u4f7f\u3044\u65b9\u3092\u8a18\u9332\u3059\u308b\u3064\u3082\u308a\u3067\u66f8\u304d\u307e\u3057\u305f\u3002\n\n\nWRF\u306e\u7d50\u679c\u304b\u3089\u5fc5\u8981\u306a\u60c5\u5831\u3092\u53d6\u5f97\u3059\u308b\n##  \u30e9\u30a4\u30d6\u30e9\u30ea\u306e\u8aad\u307f\u8fbc\u307f\nlibrary(ncdf4)\nlibrary(maps)\nlibrary(mapdata)\nlibrary(fields)\n\n##  WRF\u30c7\u30fc\u30bf\u3092\u8aad\u307f\u8fbc\u3080\nWRF <- nc_open(\"./wrfout_d01_2014-01-01_00:00:00\")\n\n##  \u30b0\u30ea\u30c3\u30c9\u4e2d\u5fc3\u306e\u7def\u5ea6\u3001\u7d4c\u5ea6\u3092\u53d6\u5f97\u3059\u308b\nLON <- ncvar_get(WRF, \"XLONG\")[,,1]\nLAT <- ncvar_get(WRF, \"XLAT\")[,,1]\n\n\u6b21\u5143\u6570\u3092\u78ba\u8a8d\u3057\u3066\u307f\u308b\n> dim(LON)\n[1] 94 74\n\n\u3000WRF\u306e\u6b21\u5143\u6570\u306f\u3001R\u3067\u306f[\u7d4c\u5ea6, \u7def\u5ea6, z\u8ef8\u30ec\u30a4\u30e4, \u6642\u9593]\u3068\u3057\u3066\u8a8d\u8b58\u3055\u308c\u308b\u3002\u3053\u3053\u3067\u306f\u7d4c\u5ea6\u3001\u7def\u5ea6\u306e\u307f\u53d6\u5f97\u3057\u3066\u3044\u305f\u305f\u3081\u30012\u3064\u3057\u304b\u51fa\u529b\u3055\u308c\u306a\u3044\u3002\n\u3000\u3053\u306e\u30c7\u30fc\u30bf\u3067\u306f\u3001\u6771\u897f\u65b9\u5411\u306b94\u306e\u30dd\u30a4\u30f3\u30c8\u304c\u3042\u308a\u3001\u5357\u5317\u65b9\u5411\u306b74\u306e\u30dd\u30a4\u30f3\u30c8\u304c\u3042\u308b\u3002\nn.lon <- dim(LON)[1]  ## WRF\u306e\u6771\u897f\u30b0\u30ea\u30c3\u30c9\u6570\u3092\u53d6\u5f97\nn.lat <- dim(LON)[2]  ## WRF\u306e\u5357\u5317\u30b0\u30ea\u30c3\u30c9\u6570\u3092\u53d6\u5f97\n\n## \u7a7a\u767d\u306e\u30e9\u30b9\u30bf\u30fc\u30c7\u30fc\u30bf\u3092\u4f5c\u6210\nd.field <- matrix(nrow=n.lon, ncol=n.lat, 0)\n\n\nHubeny\u306e\u516c\u5f0f\u3092\u7528\u3044\u3066\u6307\u5b9a\u3057\u305f\u5730\u70b9\u306b\u6700\u3082\u8fd1\u3044\u30b0\u30ea\u30c3\u30c9\u3092\u8a08\u7b97\u3059\u308b\n\u3000\u7c21\u5358\u306b\u306f\u3001(x1-x2)+(y1-y2)\u304c\u6700\u5c0f\u5024\u306b\u306a\u308b\u4f4d\u7f6e\u3092\u8a08\u7b97\u3059\u308c\u3070\u826f\u3044\u306e\u3060\u304c\u3001\u30b0\u30ea\u30c3\u30c9\u4e2d\u5fc3\u4f4d\u7f6e\u3068\u306e\u8ddd\u96e2\u3092\u6c42\u3081\u308b\u305f\u3081\u3001Hubeny\u306e\u5f0f\u3092\u4f7f\u3063\u305f\u8a08\u7b97\u5f0f\u3092\u66f8\u304d\u307e\u3059\u3002\n\u3000\u6700\u77ed\u8ddd\u96e2\u304b\u3089\u7c21\u5358\u306b\u6307\u5b9a\u3057\u305f\u5730\u70b9\u3092\u63a2\u3059\u5834\u5408\u306f\u3001which.min\u95a2\u6570\u3092\u4f7f\u3063\u3066\u3001which.min(abs(LON - 130.000) + abs(LAT - 32.000))\u306a\u3069\u3068\u3057\u3066\u6c42\u3081\u308b\u3002\nSelect.Point <- function(x, y, grid){\n  ## x:\u7d4c\u5ea6, y:\u7def\u5ea6, grid:\u30b0\u30ea\u30c3\u30c9\u9593\u8ddd\u96e2(km; namelist\u3067\u8a2d\u5b9a)\n\n  ## \u65e5\u672c\u57df\u306e\u30c7\u30fc\u30bf\u53d6\u5f97\u3092\u524d\u63d0\u3068\u3057\u3066\u30011\u00b0\u2252100km\u3068\u3057\u3066\u8ddd\u96e2\u3092\u8a08\u7b97\n  ## \u30b0\u30ea\u30c3\u30c9\u9593\u8ddd\u96e2\u30921/2\u3059\u308b\n  Rx <- grid/100/2\n  a = 6378137.0\n  b = 6356752.314140\n\n  ## x\u3067\u6307\u5b9a\u3057\u305f\u7d4c\u5ea6\u306b\u8fd1\u3044\u30c7\u30fc\u30bf\u306b\u7d5e\u308b\n  ## x\u00b1Rx\u306e\u7bc4\u56f2\u3067\u7d5e\u308b\n  LONGITUDE <- which(LON<=(x+Rx)&LON>=(x-Rx), arr.ind=TRUE)\n  Len.LON <- length(LONGITUDE[,1])\n  min.Distance <- grid\n\n  ## LONGITUDE\u3067\u7d5e\u3063\u305f\u4e2d\u304b\u3089\u3001\u66f4\u306b\u8ddd\u96e2\u304c\u6700\u3082\u8fd1\u3044\u30dd\u30a4\u30f3\u30c8\u3092\u9078\u3076\n  ## for\u6587\u5185\u3067Hubeny\u306e\u5f0f\u3092\u4f7f\u7528\n  for (i in 1:Len.LON){\n    row.data <- LONGITUDE[i,2]\n    col.data <- LONGITUDE[i,1]\n    x2 <- LON[col.data, row.data]\n    y2 <- LAT[col.data, row.data]\n    dy <- (y - y2)*pi/180\n    dx <- (x - x2)*pi/180\n    my <- ((y + y2) / 2)*pi/180\n    e2 <- (a^2 - b^2) / a^2\n    Mnum <- a * (1 - e2)\n    W <- sqrt(1 - e2 * sin(my)^2)\n    M <- Mnum / W^3\n    N <- a / W\n    Distance <- sqrt((dy * M)^2 + (dx * N * cos(my))^2)/10^3\n    if (Distance <= min.Distance){\n      min.Distance <- Distance\n      min.row <- row.data\n      min.col <- col.data\n    }\n  }\n  lon <- LON[min.col, min.row]\n  lat <- LAT[min.col, min.row]\n\n  ## \u6c42\u3081\u305f\u30b0\u30ea\u30c3\u30c9\u4f4d\u7f6e\u306b\u30c7\u30fc\u30bf\u3092\u5165\u529b\n  d.field[min.col, min.row] <- 1\n\n  ## \u30c7\u30fc\u30bf\u53d6\u5f97\u4f4d\u7f6e\u3068\u5165\u529b\u3057\u305f\u4f4d\u7f6e\u60c5\u5831\u3092\u30de\u30c3\u30d7\u4e0a\u306b\u30d7\u30ed\u30c3\u30c8\n  image.plot(LON, LAT, d.field, col=c(NA, \"red\"), border=TRUE,\n             main=\"\u30c7\u30fc\u30bf\u62bd\u51fa\u5730\u70b9\",xlab=\"Longitude(deg)\",ylab=\"Latitude(deg)\",\n             xlim=c(lon-grid/20, lon+grid/20), ylim=c(lat-grid/20, lat+grid/20))\n  map(\"worldHires\", add=T)\n  map(\"japan\", add=T)\n  points(x, y, col=\"blue\", pch=18, cex=2)\n  legend(\"topleft\", legend=c(\"MODEL\", \"REAL\"), col=c(\"red\", \"blue\"), pch=c(15,18), bg = \"pink\", cex=1.2)\n  text(lon, lat + grid/50, x, col=\"blue\", cex=1.5)\n  text(lon, lat + grid/100, y, col=\"blue\", cex=1.5)\n  text(lon, lat - grid/100, lon, col=\"red\", cex=1.5)\n  text(lon, lat - grid/50, lat, col=\"red\", cex=1.5)\n  grid(col=\"black\")\n  select.point <- data.frame(ROW = min.row,\n                             COL = min.col,\n                             Latitude = lat,\n                             Longitude = lon,\n                             Distance=min.Distance)\n  return(select.point)\n}\n\n\n\n\u4efb\u610f\u306e\u5730\u70b9\u304c\u3069\u306e\u30b0\u30ea\u30c3\u30c9\u306b\u5bfe\u5fdc\u3059\u308b\u304b\u78ba\u8a8d\u3059\u308b\n## x:\u7d4c\u5ea6, y:\u7def\u5ea6, grid:\u30b0\u30ea\u30c3\u30c9\u9593\u8ddd\u96e2(km; namelist\u3067\u8a2d\u5b9a)\nSelect.Point(x=130.376501, y=33.582399, grid=81)\n## \u4f8b\u3068\u3057\u3066\u798f\u5ca1\u7ba1\u533a\u6c17\u8c61\u53f0\u306e\u4f4d\u7f6e\u3092\u8a2d\u5b9a\n## \u30b0\u30ea\u30c3\u30c9\u306f81km\u9593\u9694\u3067\u8a08\u7b97\u3057\u3066\u308b\n\n\u5b9f\u884c\u3059\u308b\u3068\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u51fa\u529b\u3068\u753b\u50cf\u304c\u30d7\u30ed\u30c3\u30c8\u3055\u308c\u308b\u3002\n> Select.Point(x=130.376501, y=33.582399, grid=81)\n    ROW COL Latitude Longitude Distance\ncol  44  65 33.51446   130.601 22.16525\n\nROW\uff1ax\u306b\u6700\u3082\u8fd1\u3044\u30b0\u30ea\u30c3\u30c9\u7d4c\u5ea6\u5730\u70b9\nCOL\uff1ay\u306b\u6700\u3082\u8fd1\u3044\u30b0\u30ea\u30c3\u30c9\u7def\u5ea6\u5730\u70b9\nLatitude\uff1aROW\u306b\u5bfe\u5fdc\u3059\u308b\u30b0\u30ea\u30c3\u30c9\u5024\uff08\u7def\u5ea6\uff09\nLongitude\uff1aCOL\u306b\u5bfe\u5fdc\u3059\u308b\u30b0\u30ea\u30c3\u30c9\u5024\uff08\u7d4c\u5ea6\uff09\nDistance\uff1a\u4efb\u610f\u306e\u5730\u70b9\u3068\u30b0\u30ea\u30c3\u30c9\u4e2d\u5fc3\u4f4d\u7f6e\u3068\u306e\u8ddd\u96e2\uff08km\uff09\n\n\u3000\u9752\u3044\u83f1\u578b\u306e\u30dd\u30a4\u30f3\u30c8\u304c\u3001x, y\u3067\u6307\u5b9a\u3057\u305f\u798f\u5ca1\u7ba1\u533a\u6c17\u8c61\u53f0\u306e\u4f4d\u7f6e\u3002\u8d64\u3044\u9818\u57df\u304cWRF\u306e\u7d50\u679c\u3067\u5bfe\u5fdc\u3059\u308b\u9818\u57df\u3002\u3053\u306e\u8d64\u3044\u9818\u57df\u306e\u30c7\u30fc\u30bf\u3092\u62bd\u51fa\u3059\u308b\u3002\n\u3000\u30c7\u30fc\u30bf\u3092\u629c\u304d\u51fa\u3059\u30dd\u30a4\u30f3\u30c8\u304c\u308f\u304b\u3063\u305f\u306e\u3067\u3001\u3042\u3068\u306fncvar_get(WRF, \"T2\")[ROW, COL, ]\u306a\u3069\u3068\u3057\u3066\u3001WRF\u8a08\u7b97\u7d50\u679c\u304b\u3089\u4efb\u610f\u306e\u5730\u70b9\u306e\u6642\u7cfb\u5217\u30c7\u30fc\u30bf\u3092\u62bd\u51fa\u3059\u308b\u3002\n\n\u4efb\u610f\u306e\u5730\u70b9\u306e\u30c7\u30fc\u30bf\u3092\u53d6\u5f97\u3059\u308b\n\u3000\u629c\u304d\u51fa\u3059\u4f4d\u7f6e\u304c\u308f\u304b\u3063\u305f\u306e\u3067\u3001\u305d\u308c\u3092\u5143\u306bWRF\u30c7\u30fc\u30bf\u304b\u3089\u3001\u5730\u4e0a2m\u306e\u6c17\u6e29[\u2103]\u3001\u5730\u4e0a2m\u306e\u6e7f\u5ea6[%]\u3001\u5730\u8868\u9762\u6c17\u5727[hPa]\u3001\u6d77\u9762\u66f4\u751f\u6c17\u5727[hPa]\u3001\u5730\u4e0a10m\u98a8\u901f[m/s]\u3001\u7d2f\u7a4d\u964d\u6c34\u91cf[mm]\u3001\u5883\u754c\u5c64\u9ad8\u5ea6[m]\u3001\u6a19\u9ad8[m]\u3092\u53d6\u5f97\u3059\u308b\u3002\n\u3000WRF\u306e\u7d50\u679c\u306f\u4f7f\u3044\u3084\u3059\u3044\u3088\u3046\u30011\u65e5\u3054\u3068\u306b\u5206\u5272\u3057\u3066\u51fa\u529b\u3059\u308b\u3088\u3046\u306b\u3057\u3066\u3044\u308b\u306e\u3067\u3001\u307e\u305a\u306f\u30d5\u30a1\u30a4\u30eb\u306e\u30ea\u30b9\u30c8\u3092\u4f5c\u6210\u3059\u308b\u3002\n## Select.Point\u3067\u6c42\u3081\u305fCOL, ROW\u3092\u8a2d\u5b9a\u3059\u308b\nCOL <- 65\nROW <- 44\n\n## WRF\u30d5\u30a1\u30a4\u30eb\u306e\u30ea\u30b9\u30c8\u3092\u4f5c\u6210\n## \u30c7\u30fc\u30bf\u3092\u62bd\u51fa\u3059\u308b\u30d5\u30a1\u30a4\u30eb\u3060\u3051\u307e\u3068\u3081\u3066\u30d5\u30a9\u30eb\u30c0\u3092\u4f5c\u3063\u3066\u304a\u304f\u3068\u697d\nwrf.dir <- \"./WRF_outdata/\"  ## \u6700\u5f8c\u306b\u5fc5\u305a\u30b9\u30e9\u30c3\u30b7\u30e5\"/\"\u3092\u3064\u3051\u308b\u3053\u3068\nfiles <- list.files(path=wrf.dir, pattern = \"wrfout_d01\")\nwrf.len <- length(files)\n\n\u6ce8\u610f\uff1aWRF\u306e\u30c7\u30fc\u30bf\u306f\u3001\u7d4c\u5ea6\u3001\u7def\u5ea6\u3001z\u8ef8\u30ec\u30a4\u30e4\u3001\u6642\u9593\u306e4\u6b21\u5143\u30c7\u30fc\u30bf\u3092\u57fa\u6e96\u306b\u3057\u3066\u3044\u308b\u305f\u3081\u30011\u6642\u9593\u3057\u304b\u30c7\u30fc\u30bf\u304c\u683c\u7d0d\u3055\u308c\u3066\u3044\u306a\u3044NetCDF\u30d5\u30a1\u30a4\u30eb\u3060\u3068\u30a8\u30e9\u30fc\u304c\u51fa\u308b\u3002\u305d\u3093\u306a\u30d5\u30a1\u30a4\u30eb\u306f\u9664\u3044\u3066\u304f\u3060\u3055\u3044\u3002\nWRF\u30d5\u30a1\u30a4\u30eb\u6570\u3060\u3051\u51e6\u7406\u3092\u7e70\u308a\u8fd4\u3057\u3001\u307e\u3068\u3081\u3066csv\u30d5\u30a1\u30a4\u30eb\u306b\u51fa\u529b\u3059\u308b\u3002\nWRF.OutData <- data.frame()\nfor (i in 1:wrf.len){\n  WRF <- nc_open(paste(wrf.dir, files[i], sep=\"\"))\n  TIME <- ncvar_get(WRF, \"Times\")\n  ## JST\u306b\u5909\u63db\n  str.T <- as.POSIXlt(paste(substring(TIME[1], 1, 10), \"00:00:00\", sep=\" \"), \"%Y-%m-%d %H:%M:%OS\") + 9*60*60\n  JST <- seq(str.T, by=\"hour\", length=24)\n\n  TEMP <- ncvar_get(WRF, \"T2\")[COL, ROW, ]-273.15 #\u5730\u4e0a2m\u306e\u6c17\u6e29\n  RAIN <- ncvar_get(WRF, \"RAINC\")[COL, ROW, ]  #\u7d2f\u7a4d\u964d\u6c34\u91cf(mm)\n  PRES <- ncvar_get(WRF, \"PSFC\")[COL, ROW, ]/100  #\u5730\u8868\u4ed8\u8fd1\u306e\u6c17\u5727(hPa)\n  HGT <- ncvar_get(WRF, \"HGT\")[COL, ROW, 1]  ## \u5730\u8868\u9762\u9ad8\u3055[m]\n  S.PRES <- PRES*(1-0.0065*HGT/(TEMP+273.15+0.0065*HGT))^(-5.257)  ## \u6d77\u9762\u66f4\u6b63\u6c17\u5727[hPa]  \n\n  XWS <- ncvar_get(WRF, \"U10\")[COL, ROW, ]  #\u5730\u4e0a10m\u306ex\u8ef8\u98a8\u901f(\u897f\u2192\u6771)\n  YWS <- ncvar_get(WRF, \"V10\")[COL, ROW, ]  #\u5730\u4e0a10m\u306ey\u8ef8\u98a8\u901f(\u5357\u2192\u5317)\n  Lon <- ncvar_get(WRF, \"XLONG\")[COL, ROW, ]     #\u7d4c\u5ea6\n  Lat <- ncvar_get(WRF, \"XLAT\")[COL, ROW, ]      #\u7def\u5ea6\n  QV <- ncvar_get(WRF, \"Q2\")[COL, ROW, ]         #\u5730\u4e0a2m\u306e\u6df7\u5408\u6bd4(\u6c34\u84b8\u6c17\u8cea\u91cfkg/\u4e7e\u71e5\u7a7a\u6c17\u8cea\u91cfkg)\n\n  ## \u98fd\u548c\u6c34\u84b8\u6c17\u5727\u306e\u8a08\u7b97\u3002Tetens\u306e\u5f0f\u3060\u304c\u3001Goff-Gratch\u306e\u5f0f\u3068\u8fd1\u4f3c\u3067\u304d\u308b\u3002\n  PHUM <- 6.1078*10^(\n    7.5*TEMP/(TEMP+237.3)\n  )\n  RH <- 100*PRES*QV/(PHUM*(0.622+QV)) \n  PBLH <- ncvar_get(WRF, \"PBLH\")[COL, ROW, ]      #\u5883\u754c\u5c64\u9ad8\u5ea6\n\n\n  Mid.frame <- data.frame(TIME_UTC=TIME,\n                          TIME_JST=JST,\n                          LON_deg=Lon, \n                          LAT_deg=Lat, \n                          TEMP_degC=TEMP, \n                          RH_percent=RH, \n                          RAIN_mm=RAIN, \n                          SFC_PRES_hPa=PRES,\n                          SEA_LEVEL_PRES_hPa=S.PRES,\n                          U10=XWS,\n                          V10=YWS,\n                          PBLH_m=PBLH,\n                          HEIGHT_m=HGT)\n  WRF.OutData<- rbind(WRF.OutData, Mid.frame)\n}\n\nhead(WRF.OutData)\u3067\u7def\u5ea6(LAT)\u3001\u7d4c\u5ea6(LON)\u304cSelect.Point\u306e\u51fa\u529b\u3068\u540c\u3058\u3067\u3042\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3059\u308b\u3002\n> head(WRF.OutData)\n             TIME_UTC            TIME_JST LON_deg  LAT_deg TEMP_degC RH_percent\n1 2014-01-15_00:00:00 2014-01-15 09:00:00 130.601 33.51446  3.787439   60.37696\n2 2014-01-15_01:00:00 2014-01-15 10:00:00 130.601 33.51446  5.069299   62.86162\n3 2014-01-15_02:00:00 2014-01-15 11:00:00 130.601 33.51446  5.671594   60.55730\n4 2014-01-15_03:00:00 2014-01-15 12:00:00 130.601 33.51446  6.196771   60.33883\n5 2014-01-15_04:00:00 2014-01-15 13:00:00 130.601 33.51446  6.581842   61.80480\n6 2014-01-15_05:00:00 2014-01-15 14:00:00 130.601 33.51446  6.771753   64.21387\n  RAIN_mm SFC_PRES_hPa SEA_LEVEL_PRES_hPa      U10       V10   PBLH_m HEIGHT_m\n1       0     1005.317           1028.986 1.713518 -1.446464    0.000 189.0172\n2       0     1005.254           1028.811 2.567818 -4.762895 1257.336 189.0172\n3       0     1004.958           1028.457 2.458457 -5.227210 1258.585 189.0172\n4       0     1004.848           1028.300 2.323239 -5.595024 1260.606 189.0172\n5       0     1004.771           1028.188 2.463428 -5.933176 1262.666 189.0172\n6       0     1004.595           1027.992 2.521139 -6.201655 1264.699 189.0172\n\n\u62bd\u51fa\u3057\u305f\u30c7\u30fc\u30bf\u3092csv\u5f62\u5f0f\u3067\u51fa\u529b\u3059\u308b\u3002\nwrite.table(WRF.OutData, \"./WRF_data.csv\", sep=\",\", row.names=FALSE)\n\n\u98a8\u5411\u98a8\u901f\u3092\u89d2\u5ea6\u3067\u6c42\u3081\u305f\u3044\u3068\u304d\u306f\u3001atan2()\u95a2\u6570\u3092\u4f7f\u3063\u3066\u6c42\u3081\u308b\u3068\u826f\u3044\nx <- c(1, sqrt(3)/2, 1/2, 0, -1/2, -sqrt(3)/2, -1, -sqrt(3)/2, -1/2, 0, 1/2, sqrt(3)/2, 1)\ny <- c(0, 1/2, sqrt(3)/2, 1, sqrt(3)/2, 1/2, 0, -1/2, -sqrt(3)/2, -1, -sqrt(3)/2, -1/2, 0)\n\n> atan2(y, x)/pi*180\n [1]    0   30   60   90  120  150  180 -150 -120  -90  -60  -30    0\n\n\u6771\u304c0\u00b0\u3067\u3001\u53cd\u6642\u8a08\u56de\u308a\u306b\u89d2\u5ea6\u304c\u6c7a\u307e\u308b\u3001\u4e09\u89d2\u95a2\u6570\u3067\u98a8\u5411\u304c\u51fa\u529b\u3055\u308c\u308b\u3002\u305f\u3060\u3057\u3001180\u00b0\u4ee5\u4e0a\u3067\u306f\u30de\u30a4\u30ca\u30b9\u5024\u306b\u306a\u308b\u305f\u3081\u3001\u305d\u306e\u5834\u5408\u306f360\u3092\u8db3\u3057\u307e\u3059\u3002\nWD <- atan2(y, x)/pi*180\n> WD\n [1]    0   30   60   90  120  150  180 -150 -120  -90  -60  -30    0\n\nWD <- ifelse(WD<0, WD+360, WD)\n> WD\n [1]   0  30  60  90 120 150 180 210 240 270 300 330   0\n\n\u98a8\u901f\u306fsqrt(x^2 + y^2)\u3067\u6c42\u307e\u308a\u307e\u3059\u306d\u3002\n\u62bd\u51fa\u3057\u305f\u30c7\u30fc\u30bf\u306fopenair\u30d1\u30c3\u30b1\u30fc\u30b8\u3092\u4f7f\u3046\u3068\u7dba\u9e97\u306a\u30b0\u30e9\u30d5\u304c\u51fa\u6765\u4e0a\u304c\u308a\u307e\u3059\u3002\n\n\n\u53c2\u8003\uff1a\n[1] \u65e5\u672c\u306f\u5c71\u3060\u3089\u3051\u301c \u6280\u8853\u7814\u7a76\u672c\u90e8 \u5831\u544a\u66f8 \u7b2c\u4e00\u53f7 (2009).\uff08http://yamadarake.jp/trdi/report000001.html)\n[2] \u30a2\u30de\u30ce\u6280\u7814. (http://www.amano-tec.com/apps/paceruler.html)\n[3] \u5e2b\u5320\u306e\u6563\u6b69 VBA\u3068\u6e2c\u5730\u5b66 Hubeny\u306e\u5f0f\u3092\u8003\u5bdf. (http://tancro.e-central.tv/grandmaster/excel/hubenystandard.html)\n#WRF\u30c7\u30fc\u30bf\u304b\u3089\u7def\u5ea6\u30fb\u7d4c\u5ea6\u3092\u6307\u5b9a\u3057\u3066\u30c7\u30fc\u30bf\u3092\u629c\u304d\u51fa\u3059\n\n\u3000WRF\u306e\u8a08\u7b97\u7d50\u679c\u304b\u3089\u3042\u308b\u30b0\u30ea\u30c3\u30c9\uff08\u307e\u305f\u306f\u3001\u6307\u5b9a\u3059\u308b\u5730\u70b9\u306b\u6700\u3082\u8fd1\u3044\u30b0\u30ea\u30c3\u30c9\uff09\u306e\u30c7\u30fc\u30bf\u3092\u53d6\u5f97\u3057\u3066\u3001\u6642\u7cfb\u5217\u306e\u30c7\u30fc\u30bf\u89e3\u6790\u3092\u884c\u3044\u305f\u3044\u6642\u3001R\u3067\u30c7\u30fc\u30bf\u3092\u53d6\u5f97\u3059\u308b\u65b9\u6cd5\u3092\u30e1\u30e2\u3059\u308b\u3002\n\u3000WRF\u306e\u7d50\u679c\u306f\u30b0\u30ea\u30c3\u30c9\u306e\u4f4d\u7f6e\u60c5\u5831\u304c\u7def\u5ea6\u3001\u7d4c\u5ea6\u3067\u51fa\u529b\u3055\u308c\u308b\u306e\u3067\u3001\u6307\u5b9a\u3057\u305f\u4f4d\u7f6e\u3068\u6700\u3082\u8fd1\u3044\u8ddd\u96e2\u306b\u3042\u308b\u30b0\u30ea\u30c3\u30c9\u3092\u6c42\u3081\u308b\u3088\u3046\u3001\u8a08\u7b97\u5f0f\u306bHubeny\u306e\u516c\u5f0f\u3092\u7528\u3044\u305f\u3002\n\u3000Hubeny\u306e\u516c\u5f0f\u306f\u3001\u30ab\u30b7\u30df\u30fc\u30eb3D\u306a\u3069\u306e\u8ddd\u96e2\u8a08\u7b97\u306b\u4f7f\u7528\u3055\u308c\u3066\u3044\u308b\u7c21\u6613\u5f0f\u3067\u3001\u8a08\u7b97\u5f0f\u306e\u6982\u8981\u306f[\u4e8c\u5730\u70b9\u306e\u7def\u5ea6\u30fb\u7d4c\u5ea6\u304b\u3089\u305d\u306e\u8ddd\u96e2\u3092\u8a08\u7b97\u3059\u308b](http://yamadarake.jp/trdi/report000001.html)[1]\u3084\u3001[\u30d2\u30e5\u30d9\u30cb\u306e\u5f0f\u304c2\u7a2e\u985e\u3042\u308a\u307e\u3059\u304c\u3069\u3053\u304c\u9055\u3046\u306e\u3067\u3059\u304b\uff1f](http://www.amano-tec.com/apps/paceruler.html)[2]\u306e\u30da\u30fc\u30b8\u306b\u8aac\u660e\u3055\u308c\u3066\u3044\u307e\u3059\u3002[1]\u306bR\u7248\u30b9\u30af\u30ea\u30d7\u30c8\u304c\u63b2\u8f09\u3055\u308c\u3066\u3044\u307e\u3057\u305f\u306e\u3067\u3001\u4e00\u90e8\u6539\u5909\u3057\u3066\u4f7f\u7528\u3055\u305b\u3066\u3044\u305f\u3060\u304d\u307e\u3057\u305f\u3002\n\u3000\u6b63\u76f4\u3001\u3053\u3053\u307e\u3067\u53b3\u5bc6\u3058\u3083\u306a\u304f\u3066\u3082\u3001\u7def\u5ea6\u3001\u7d4c\u5ea6\u5dee\u304c\u4e00\u756a\u5c0f\u3055\u304f\u306a\u308b\u30dd\u30a4\u30f3\u30c8\u3092\u629c\u304d\u51fa\u305b\u3070\u3059\u3080\u306e\u3060\u304c\u3001\u5225\u4ef6\u3067Hubeny\u306e\u5f0f\u3092\u4f7f\u3063\u305f\u306e\u3067\u3001\u4f7f\u3044\u65b9\u3092\u8a18\u9332\u3059\u308b\u3064\u3082\u308a\u3067\u66f8\u304d\u307e\u3057\u305f\u3002\n***\n\n##WRF\u306e\u7d50\u679c\u304b\u3089\u5fc5\u8981\u306a\u60c5\u5831\u3092\u53d6\u5f97\u3059\u308b\n\n```r\n##  \u30e9\u30a4\u30d6\u30e9\u30ea\u306e\u8aad\u307f\u8fbc\u307f\nlibrary(ncdf4)\nlibrary(maps)\nlibrary(mapdata)\nlibrary(fields)\n\n##  WRF\u30c7\u30fc\u30bf\u3092\u8aad\u307f\u8fbc\u3080\nWRF <- nc_open(\"./wrfout_d01_2014-01-01_00:00:00\")\n\n##  \u30b0\u30ea\u30c3\u30c9\u4e2d\u5fc3\u306e\u7def\u5ea6\u3001\u7d4c\u5ea6\u3092\u53d6\u5f97\u3059\u308b\nLON <- ncvar_get(WRF, \"XLONG\")[,,1]\nLAT <- ncvar_get(WRF, \"XLAT\")[,,1]\n```\n\n\u6b21\u5143\u6570\u3092\u78ba\u8a8d\u3057\u3066\u307f\u308b\n\n```r\n> dim(LON)\n[1] 94 74\n```\n\n\u3000WRF\u306e\u6b21\u5143\u6570\u306f\u3001R\u3067\u306f[\u7d4c\u5ea6, \u7def\u5ea6, z\u8ef8\u30ec\u30a4\u30e4, \u6642\u9593]\u3068\u3057\u3066\u8a8d\u8b58\u3055\u308c\u308b\u3002\u3053\u3053\u3067\u306f\u7d4c\u5ea6\u3001\u7def\u5ea6\u306e\u307f\u53d6\u5f97\u3057\u3066\u3044\u305f\u305f\u3081\u30012\u3064\u3057\u304b\u51fa\u529b\u3055\u308c\u306a\u3044\u3002\n\u3000\u3053\u306e\u30c7\u30fc\u30bf\u3067\u306f\u3001\u6771\u897f\u65b9\u5411\u306b94\u306e\u30dd\u30a4\u30f3\u30c8\u304c\u3042\u308a\u3001\u5357\u5317\u65b9\u5411\u306b74\u306e\u30dd\u30a4\u30f3\u30c8\u304c\u3042\u308b\u3002\n\n```r\nn.lon <- dim(LON)[1]  ## WRF\u306e\u6771\u897f\u30b0\u30ea\u30c3\u30c9\u6570\u3092\u53d6\u5f97\nn.lat <- dim(LON)[2]  ## WRF\u306e\u5357\u5317\u30b0\u30ea\u30c3\u30c9\u6570\u3092\u53d6\u5f97\n\n## \u7a7a\u767d\u306e\u30e9\u30b9\u30bf\u30fc\u30c7\u30fc\u30bf\u3092\u4f5c\u6210\nd.field <- matrix(nrow=n.lon, ncol=n.lat, 0)\n```\n\n##Hubeny\u306e\u516c\u5f0f\u3092\u7528\u3044\u3066\u6307\u5b9a\u3057\u305f\u5730\u70b9\u306b\u6700\u3082\u8fd1\u3044\u30b0\u30ea\u30c3\u30c9\u3092\u8a08\u7b97\u3059\u308b\n\u3000\u7c21\u5358\u306b\u306f\u3001`(x1-x2)+(y1-y2)`\u304c\u6700\u5c0f\u5024\u306b\u306a\u308b\u4f4d\u7f6e\u3092\u8a08\u7b97\u3059\u308c\u3070\u826f\u3044\u306e\u3060\u304c\u3001\u30b0\u30ea\u30c3\u30c9\u4e2d\u5fc3\u4f4d\u7f6e\u3068\u306e\u8ddd\u96e2\u3092\u6c42\u3081\u308b\u305f\u3081\u3001Hubeny\u306e\u5f0f\u3092\u4f7f\u3063\u305f\u8a08\u7b97\u5f0f\u3092\u66f8\u304d\u307e\u3059\u3002\n\u3000\u6700\u77ed\u8ddd\u96e2\u304b\u3089\u7c21\u5358\u306b\u6307\u5b9a\u3057\u305f\u5730\u70b9\u3092\u63a2\u3059\u5834\u5408\u306f\u3001which.min\u95a2\u6570\u3092\u4f7f\u3063\u3066\u3001`which.min(abs(LON - 130.000) + abs(LAT - 32.000))`\u306a\u3069\u3068\u3057\u3066\u6c42\u3081\u308b\u3002\n\n```r\nSelect.Point <- function(x, y, grid){\n  ## x:\u7d4c\u5ea6, y:\u7def\u5ea6, grid:\u30b0\u30ea\u30c3\u30c9\u9593\u8ddd\u96e2(km; namelist\u3067\u8a2d\u5b9a)\n  \n  ## \u65e5\u672c\u57df\u306e\u30c7\u30fc\u30bf\u53d6\u5f97\u3092\u524d\u63d0\u3068\u3057\u3066\u30011\u00b0\u2252100km\u3068\u3057\u3066\u8ddd\u96e2\u3092\u8a08\u7b97\n  ## \u30b0\u30ea\u30c3\u30c9\u9593\u8ddd\u96e2\u30921/2\u3059\u308b\n  Rx <- grid/100/2\n  a = 6378137.0\n  b = 6356752.314140\n\n  ## x\u3067\u6307\u5b9a\u3057\u305f\u7d4c\u5ea6\u306b\u8fd1\u3044\u30c7\u30fc\u30bf\u306b\u7d5e\u308b\n  ## x\u00b1Rx\u306e\u7bc4\u56f2\u3067\u7d5e\u308b\n  LONGITUDE <- which(LON<=(x+Rx)&LON>=(x-Rx), arr.ind=TRUE)\n  Len.LON <- length(LONGITUDE[,1])\n  min.Distance <- grid\n\n  ## LONGITUDE\u3067\u7d5e\u3063\u305f\u4e2d\u304b\u3089\u3001\u66f4\u306b\u8ddd\u96e2\u304c\u6700\u3082\u8fd1\u3044\u30dd\u30a4\u30f3\u30c8\u3092\u9078\u3076\n  ## for\u6587\u5185\u3067Hubeny\u306e\u5f0f\u3092\u4f7f\u7528\n  for (i in 1:Len.LON){\n    row.data <- LONGITUDE[i,2]\n    col.data <- LONGITUDE[i,1]\n    x2 <- LON[col.data, row.data]\n    y2 <- LAT[col.data, row.data]\n    dy <- (y - y2)*pi/180\n    dx <- (x - x2)*pi/180\n    my <- ((y + y2) / 2)*pi/180\n    e2 <- (a^2 - b^2) / a^2\n    Mnum <- a * (1 - e2)\n    W <- sqrt(1 - e2 * sin(my)^2)\n    M <- Mnum / W^3\n    N <- a / W\n    Distance <- sqrt((dy * M)^2 + (dx * N * cos(my))^2)/10^3\n    if (Distance <= min.Distance){\n      min.Distance <- Distance\n      min.row <- row.data\n      min.col <- col.data\n    }\n  }\n  lon <- LON[min.col, min.row]\n  lat <- LAT[min.col, min.row]\n  \n  ## \u6c42\u3081\u305f\u30b0\u30ea\u30c3\u30c9\u4f4d\u7f6e\u306b\u30c7\u30fc\u30bf\u3092\u5165\u529b\n  d.field[min.col, min.row] <- 1\n  \n  ## \u30c7\u30fc\u30bf\u53d6\u5f97\u4f4d\u7f6e\u3068\u5165\u529b\u3057\u305f\u4f4d\u7f6e\u60c5\u5831\u3092\u30de\u30c3\u30d7\u4e0a\u306b\u30d7\u30ed\u30c3\u30c8\n  image.plot(LON, LAT, d.field, col=c(NA, \"red\"), border=TRUE,\n             main=\"\u30c7\u30fc\u30bf\u62bd\u51fa\u5730\u70b9\",xlab=\"Longitude(deg)\",ylab=\"Latitude(deg)\",\n             xlim=c(lon-grid/20, lon+grid/20), ylim=c(lat-grid/20, lat+grid/20))\n  map(\"worldHires\", add=T)\n  map(\"japan\", add=T)\n  points(x, y, col=\"blue\", pch=18, cex=2)\n  legend(\"topleft\", legend=c(\"MODEL\", \"REAL\"), col=c(\"red\", \"blue\"), pch=c(15,18), bg = \"pink\", cex=1.2)\n  text(lon, lat + grid/50, x, col=\"blue\", cex=1.5)\n  text(lon, lat + grid/100, y, col=\"blue\", cex=1.5)\n  text(lon, lat - grid/100, lon, col=\"red\", cex=1.5)\n  text(lon, lat - grid/50, lat, col=\"red\", cex=1.5)\n  grid(col=\"black\")\n  select.point <- data.frame(ROW = min.row,\n                             COL = min.col,\n                             Latitude = lat,\n                             Longitude = lon,\n                             Distance=min.Distance)\n  return(select.point)\n}\n\n```\n\n\n##\u4efb\u610f\u306e\u5730\u70b9\u304c\u3069\u306e\u30b0\u30ea\u30c3\u30c9\u306b\u5bfe\u5fdc\u3059\u308b\u304b\u78ba\u8a8d\u3059\u308b\n```r\n## x:\u7d4c\u5ea6, y:\u7def\u5ea6, grid:\u30b0\u30ea\u30c3\u30c9\u9593\u8ddd\u96e2(km; namelist\u3067\u8a2d\u5b9a)\nSelect.Point(x=130.376501, y=33.582399, grid=81)\n## \u4f8b\u3068\u3057\u3066\u798f\u5ca1\u7ba1\u533a\u6c17\u8c61\u53f0\u306e\u4f4d\u7f6e\u3092\u8a2d\u5b9a\n## \u30b0\u30ea\u30c3\u30c9\u306f81km\u9593\u9694\u3067\u8a08\u7b97\u3057\u3066\u308b\n```\n\n\u5b9f\u884c\u3059\u308b\u3068\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u51fa\u529b\u3068\u753b\u50cf\u304c\u30d7\u30ed\u30c3\u30c8\u3055\u308c\u308b\u3002\n\n```r\n> Select.Point(x=130.376501, y=33.582399, grid=81)\n    ROW COL Latitude Longitude Distance\ncol  44  65 33.51446   130.601 22.16525\n```\n\nROW\uff1ax\u306b\u6700\u3082\u8fd1\u3044\u30b0\u30ea\u30c3\u30c9\u7d4c\u5ea6\u5730\u70b9\nCOL\uff1ay\u306b\u6700\u3082\u8fd1\u3044\u30b0\u30ea\u30c3\u30c9\u7def\u5ea6\u5730\u70b9\nLatitude\uff1aROW\u306b\u5bfe\u5fdc\u3059\u308b\u30b0\u30ea\u30c3\u30c9\u5024\uff08\u7def\u5ea6\uff09\nLongitude\uff1aCOL\u306b\u5bfe\u5fdc\u3059\u308b\u30b0\u30ea\u30c3\u30c9\u5024\uff08\u7d4c\u5ea6\uff09\nDistance\uff1a\u4efb\u610f\u306e\u5730\u70b9\u3068\u30b0\u30ea\u30c3\u30c9\u4e2d\u5fc3\u4f4d\u7f6e\u3068\u306e\u8ddd\u96e2\uff08km\uff09\n\n![sample.png](https://qiita-image-store.s3.amazonaws.com/0/113843/53c0cc6f-0ca8-69d9-a6ef-a82654d714b5.png)\n\u3000\u9752\u3044\u83f1\u578b\u306e\u30dd\u30a4\u30f3\u30c8\u304c\u3001x, y\u3067\u6307\u5b9a\u3057\u305f\u798f\u5ca1\u7ba1\u533a\u6c17\u8c61\u53f0\u306e\u4f4d\u7f6e\u3002\u8d64\u3044\u9818\u57df\u304cWRF\u306e\u7d50\u679c\u3067\u5bfe\u5fdc\u3059\u308b\u9818\u57df\u3002\u3053\u306e\u8d64\u3044\u9818\u57df\u306e\u30c7\u30fc\u30bf\u3092\u62bd\u51fa\u3059\u308b\u3002\n\u3000\u30c7\u30fc\u30bf\u3092\u629c\u304d\u51fa\u3059\u30dd\u30a4\u30f3\u30c8\u304c\u308f\u304b\u3063\u305f\u306e\u3067\u3001\u3042\u3068\u306f`ncvar_get(WRF, \"T2\")[ROW, COL, ]`\u306a\u3069\u3068\u3057\u3066\u3001WRF\u8a08\u7b97\u7d50\u679c\u304b\u3089\u4efb\u610f\u306e\u5730\u70b9\u306e\u6642\u7cfb\u5217\u30c7\u30fc\u30bf\u3092\u62bd\u51fa\u3059\u308b\u3002\n\n##\u4efb\u610f\u306e\u5730\u70b9\u306e\u30c7\u30fc\u30bf\u3092\u53d6\u5f97\u3059\u308b\n\u3000\u629c\u304d\u51fa\u3059\u4f4d\u7f6e\u304c\u308f\u304b\u3063\u305f\u306e\u3067\u3001\u305d\u308c\u3092\u5143\u306bWRF\u30c7\u30fc\u30bf\u304b\u3089\u3001\u5730\u4e0a2m\u306e\u6c17\u6e29[\u2103]\u3001\u5730\u4e0a2m\u306e\u6e7f\u5ea6[%]\u3001\u5730\u8868\u9762\u6c17\u5727[hPa]\u3001\u6d77\u9762\u66f4\u751f\u6c17\u5727[hPa]\u3001\u5730\u4e0a10m\u98a8\u901f[m/s]\u3001\u7d2f\u7a4d\u964d\u6c34\u91cf[mm]\u3001\u5883\u754c\u5c64\u9ad8\u5ea6[m]\u3001\u6a19\u9ad8[m]\u3092\u53d6\u5f97\u3059\u308b\u3002\n\n\u3000WRF\u306e\u7d50\u679c\u306f\u4f7f\u3044\u3084\u3059\u3044\u3088\u3046\u30011\u65e5\u3054\u3068\u306b\u5206\u5272\u3057\u3066\u51fa\u529b\u3059\u308b\u3088\u3046\u306b\u3057\u3066\u3044\u308b\u306e\u3067\u3001\u307e\u305a\u306f\u30d5\u30a1\u30a4\u30eb\u306e\u30ea\u30b9\u30c8\u3092\u4f5c\u6210\u3059\u308b\u3002\n\n```r\n## Select.Point\u3067\u6c42\u3081\u305fCOL, ROW\u3092\u8a2d\u5b9a\u3059\u308b\nCOL <- 65\nROW <- 44\n\n## WRF\u30d5\u30a1\u30a4\u30eb\u306e\u30ea\u30b9\u30c8\u3092\u4f5c\u6210\n## \u30c7\u30fc\u30bf\u3092\u62bd\u51fa\u3059\u308b\u30d5\u30a1\u30a4\u30eb\u3060\u3051\u307e\u3068\u3081\u3066\u30d5\u30a9\u30eb\u30c0\u3092\u4f5c\u3063\u3066\u304a\u304f\u3068\u697d\nwrf.dir <- \"./WRF_outdata/\"  ## \u6700\u5f8c\u306b\u5fc5\u305a\u30b9\u30e9\u30c3\u30b7\u30e5\"/\"\u3092\u3064\u3051\u308b\u3053\u3068\nfiles <- list.files(path=wrf.dir, pattern = \"wrfout_d01\")\nwrf.len <- length(files)\n```\n\u6ce8\u610f\uff1aWRF\u306e\u30c7\u30fc\u30bf\u306f\u3001\u7d4c\u5ea6\u3001\u7def\u5ea6\u3001z\u8ef8\u30ec\u30a4\u30e4\u3001\u6642\u9593\u306e4\u6b21\u5143\u30c7\u30fc\u30bf\u3092\u57fa\u6e96\u306b\u3057\u3066\u3044\u308b\u305f\u3081\u30011\u6642\u9593\u3057\u304b\u30c7\u30fc\u30bf\u304c\u683c\u7d0d\u3055\u308c\u3066\u3044\u306a\u3044NetCDF\u30d5\u30a1\u30a4\u30eb\u3060\u3068\u30a8\u30e9\u30fc\u304c\u51fa\u308b\u3002\u305d\u3093\u306a\u30d5\u30a1\u30a4\u30eb\u306f\u9664\u3044\u3066\u304f\u3060\u3055\u3044\u3002\nWRF\u30d5\u30a1\u30a4\u30eb\u6570\u3060\u3051\u51e6\u7406\u3092\u7e70\u308a\u8fd4\u3057\u3001\u307e\u3068\u3081\u3066csv\u30d5\u30a1\u30a4\u30eb\u306b\u51fa\u529b\u3059\u308b\u3002\n\n```r\nWRF.OutData <- data.frame()\nfor (i in 1:wrf.len){\n  WRF <- nc_open(paste(wrf.dir, files[i], sep=\"\"))\n  TIME <- ncvar_get(WRF, \"Times\")\n  ## JST\u306b\u5909\u63db\n  str.T <- as.POSIXlt(paste(substring(TIME[1], 1, 10), \"00:00:00\", sep=\" \"), \"%Y-%m-%d %H:%M:%OS\") + 9*60*60\n  JST <- seq(str.T, by=\"hour\", length=24)\n\n  TEMP <- ncvar_get(WRF, \"T2\")[COL, ROW, ]-273.15 #\u5730\u4e0a2m\u306e\u6c17\u6e29\n  RAIN <- ncvar_get(WRF, \"RAINC\")[COL, ROW, ]  #\u7d2f\u7a4d\u964d\u6c34\u91cf(mm)\n  PRES <- ncvar_get(WRF, \"PSFC\")[COL, ROW, ]/100  #\u5730\u8868\u4ed8\u8fd1\u306e\u6c17\u5727(hPa)\n  HGT <- ncvar_get(WRF, \"HGT\")[COL, ROW, 1]  ## \u5730\u8868\u9762\u9ad8\u3055[m]\n  S.PRES <- PRES*(1-0.0065*HGT/(TEMP+273.15+0.0065*HGT))^(-5.257)  ## \u6d77\u9762\u66f4\u6b63\u6c17\u5727[hPa]  \n\n  XWS <- ncvar_get(WRF, \"U10\")[COL, ROW, ]  #\u5730\u4e0a10m\u306ex\u8ef8\u98a8\u901f(\u897f\u2192\u6771)\n  YWS <- ncvar_get(WRF, \"V10\")[COL, ROW, ]  #\u5730\u4e0a10m\u306ey\u8ef8\u98a8\u901f(\u5357\u2192\u5317)\n  Lon <- ncvar_get(WRF, \"XLONG\")[COL, ROW, ]     #\u7d4c\u5ea6\n  Lat <- ncvar_get(WRF, \"XLAT\")[COL, ROW, ]      #\u7def\u5ea6\n  QV <- ncvar_get(WRF, \"Q2\")[COL, ROW, ]         #\u5730\u4e0a2m\u306e\u6df7\u5408\u6bd4(\u6c34\u84b8\u6c17\u8cea\u91cfkg/\u4e7e\u71e5\u7a7a\u6c17\u8cea\u91cfkg)\n  \n  ## \u98fd\u548c\u6c34\u84b8\u6c17\u5727\u306e\u8a08\u7b97\u3002Tetens\u306e\u5f0f\u3060\u304c\u3001Goff-Gratch\u306e\u5f0f\u3068\u8fd1\u4f3c\u3067\u304d\u308b\u3002\n  PHUM <- 6.1078*10^(\n    7.5*TEMP/(TEMP+237.3)\n  )\n  RH <- 100*PRES*QV/(PHUM*(0.622+QV)) \n  PBLH <- ncvar_get(WRF, \"PBLH\")[COL, ROW, ]      #\u5883\u754c\u5c64\u9ad8\u5ea6\n  \n  \n  Mid.frame <- data.frame(TIME_UTC=TIME,\n                          TIME_JST=JST,\n                          LON_deg=Lon, \n                          LAT_deg=Lat, \n                          TEMP_degC=TEMP, \n                          RH_percent=RH, \n                          RAIN_mm=RAIN, \n                          SFC_PRES_hPa=PRES,\n                          SEA_LEVEL_PRES_hPa=S.PRES,\n                          U10=XWS,\n                          V10=YWS,\n                          PBLH_m=PBLH,\n                          HEIGHT_m=HGT)\n  WRF.OutData<- rbind(WRF.OutData, Mid.frame)\n}\n```\n`head(WRF.OutData)`\u3067\u7def\u5ea6(LAT)\u3001\u7d4c\u5ea6(LON)\u304cSelect.Point\u306e\u51fa\u529b\u3068\u540c\u3058\u3067\u3042\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3059\u308b\u3002\n\n```r\n> head(WRF.OutData)\n             TIME_UTC            TIME_JST LON_deg  LAT_deg TEMP_degC RH_percent\n1 2014-01-15_00:00:00 2014-01-15 09:00:00 130.601 33.51446  3.787439   60.37696\n2 2014-01-15_01:00:00 2014-01-15 10:00:00 130.601 33.51446  5.069299   62.86162\n3 2014-01-15_02:00:00 2014-01-15 11:00:00 130.601 33.51446  5.671594   60.55730\n4 2014-01-15_03:00:00 2014-01-15 12:00:00 130.601 33.51446  6.196771   60.33883\n5 2014-01-15_04:00:00 2014-01-15 13:00:00 130.601 33.51446  6.581842   61.80480\n6 2014-01-15_05:00:00 2014-01-15 14:00:00 130.601 33.51446  6.771753   64.21387\n  RAIN_mm SFC_PRES_hPa SEA_LEVEL_PRES_hPa      U10       V10   PBLH_m HEIGHT_m\n1       0     1005.317           1028.986 1.713518 -1.446464    0.000 189.0172\n2       0     1005.254           1028.811 2.567818 -4.762895 1257.336 189.0172\n3       0     1004.958           1028.457 2.458457 -5.227210 1258.585 189.0172\n4       0     1004.848           1028.300 2.323239 -5.595024 1260.606 189.0172\n5       0     1004.771           1028.188 2.463428 -5.933176 1262.666 189.0172\n6       0     1004.595           1027.992 2.521139 -6.201655 1264.699 189.0172\n```\n\n\u62bd\u51fa\u3057\u305f\u30c7\u30fc\u30bf\u3092csv\u5f62\u5f0f\u3067\u51fa\u529b\u3059\u308b\u3002\n\n```r\nwrite.table(WRF.OutData, \"./WRF_data.csv\", sep=\",\", row.names=FALSE)\n```\n\n\u98a8\u5411\u98a8\u901f\u3092\u89d2\u5ea6\u3067\u6c42\u3081\u305f\u3044\u3068\u304d\u306f\u3001`atan2()`\u95a2\u6570\u3092\u4f7f\u3063\u3066\u6c42\u3081\u308b\u3068\u826f\u3044\n\n```r\nx <- c(1, sqrt(3)/2, 1/2, 0, -1/2, -sqrt(3)/2, -1, -sqrt(3)/2, -1/2, 0, 1/2, sqrt(3)/2, 1)\ny <- c(0, 1/2, sqrt(3)/2, 1, sqrt(3)/2, 1/2, 0, -1/2, -sqrt(3)/2, -1, -sqrt(3)/2, -1/2, 0)\n\n> atan2(y, x)/pi*180\n [1]    0   30   60   90  120  150  180 -150 -120  -90  -60  -30    0\n```\n\u6771\u304c0\u00b0\u3067\u3001\u53cd\u6642\u8a08\u56de\u308a\u306b\u89d2\u5ea6\u304c\u6c7a\u307e\u308b\u3001\u4e09\u89d2\u95a2\u6570\u3067\u98a8\u5411\u304c\u51fa\u529b\u3055\u308c\u308b\u3002\u305f\u3060\u3057\u3001180\u00b0\u4ee5\u4e0a\u3067\u306f\u30de\u30a4\u30ca\u30b9\u5024\u306b\u306a\u308b\u305f\u3081\u3001\u305d\u306e\u5834\u5408\u306f360\u3092\u8db3\u3057\u307e\u3059\u3002\n\n```r\nWD <- atan2(y, x)/pi*180\n> WD\n [1]    0   30   60   90  120  150  180 -150 -120  -90  -60  -30    0\n\nWD <- ifelse(WD<0, WD+360, WD)\n> WD\n [1]   0  30  60  90 120 150 180 210 240 270 300 330   0\n```\n\n\u98a8\u901f\u306f`sqrt(x^2 + y^2)`\u3067\u6c42\u307e\u308a\u307e\u3059\u306d\u3002\n\u62bd\u51fa\u3057\u305f\u30c7\u30fc\u30bf\u306fopenair\u30d1\u30c3\u30b1\u30fc\u30b8\u3092\u4f7f\u3046\u3068\u7dba\u9e97\u306a\u30b0\u30e9\u30d5\u304c\u51fa\u6765\u4e0a\u304c\u308a\u307e\u3059\u3002\n\n\n***\n***\n\u53c2\u8003\uff1a\n[1] \u65e5\u672c\u306f\u5c71\u3060\u3089\u3051\u301c \u6280\u8853\u7814\u7a76\u672c\u90e8 \u5831\u544a\u66f8 \u7b2c\u4e00\u53f7 (2009).\uff08http://yamadarake.jp/trdi/report000001.html)\n[2] \u30a2\u30de\u30ce\u6280\u7814. (http://www.amano-tec.com/apps/paceruler.html)\n[3] \u5e2b\u5320\u306e\u6563\u6b69 VBA\u3068\u6e2c\u5730\u5b66 Hubeny\u306e\u5f0f\u3092\u8003\u5bdf. (http://tancro.e-central.tv/grandmaster/excel/hubenystandard.html)\n", "tags": ["R", "WRF", "CMAQ", "NetCDF", "Hubeny\u306e\u5f0f"]}