{"context": " More than 1 year has passed since last update.\n\nIP\u30d5\u30a3\u30eb\u30bf\nCDN\u5229\u7528\u6642\u306b\u3001\u5b9fIP\u306e\u304b\u308f\u308a\u306bCDN\u306eIP\u304c\u6765\u308b\u5834\u5408\u3002\n(AWS\u306e\u4e00\u90e8\u306e\u30b5\u30fc\u30d3\u30b9\u3067\u3082\u540c\u3058\u65b9\u6cd5\u3067\u3002)\n\u30fbiptables\u3067\u898b\u3048\u308b\u306e\u306f\u3001CDN\u306eIP\u306a\u306e\u3067\u6ce8\u610f\u3002\n\u30fb\u51e6\u7406\u5bfe\u8c61\u304cHTTP\u30d8\u30c3\u30c0\u306a\u306e\u3067\u3001iptables\u3067\u306f\u306a\u304f\u3001Nginx\u306a\u3069\u3067\u51e6\u7406\u3059\u308b\u3002\n\u30fbCDN\u304c\u4ed8\u3051\u3066\u304f\u308c\u308b\u3001X-Forwarded-For\u306a\u3069\u3092\u5229\u7528\u3059\u308b\u3002\nNginx\nModule ngx_http_realip_module \u304c\u5fc5\u8981\u3002\n\u30d3\u30eb\u30c9\u6642\u306econfig\u306b\u3001--with-http_realip_module \u3092\u3064\u3051\u308b\u3002\nset_real_ip_from\u3001real_ip_header\u306f\u3001\n\nContext:   http, server, location\n\n\u306a\u306e\u3067\u3001http\u3001server\u3001location\u306a\u3069\u3067\u51e6\u7406\u3059\u308b\u3002\n\nset_real_ip_from\u3000CDN\u306e\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u30a2\u30c9\u30ec\u30b9;\nreal_ip_header    X-Forwarded-For;\n\n\u307e\u305f\u306f\u3001\n\nset_real_ip_from\u3000CDN\u306e\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u30a2\u30c9\u30ec\u30b9;\nreal_ip_header CF-Connecting-IP;\n\n\u203bCF-Connecting-IP\u306f\u3001CDN\u304cCloudFlare\u306e\u5834\u5408\u306b\u5229\u7528\u53ef\u80fd\u3002\n\u53c2\u8003:\nHow do I restore original visitor IP with Nginx?\nCloudFlare IP Ranges\n\n\n\u56fd\u5225\u30d5\u30a3\u30eb\u30bf\n\u30fbiptables\u3067\u898b\u3048\u308b\u306e\u306f\u3001CDN\u306eIP\u306a\u306e\u3067\u6ce8\u610f\u3002\n\u30fb\u51e6\u7406\u5bfe\u8c61\u304cHTTP\u30d8\u30c3\u30c0\u306a\u306e\u3067\u3001iptables\u3067\u306f\u306a\u304f\u3001Nginx\u306a\u3069\u3067\u51e6\u7406\u3059\u308b\u3002\n\u30fbCDN\u304c\u4ed8\u3051\u3066\u304f\u308c\u308b\u3001CF-IPCOUNTRY\u306a\u3069\u3092\u5229\u7528\u3059\u308b\u3002\n\u3000(\u307e\u305f\u306f\u3001set_real_ip_from\u3067\u5b9fIP\u306b\u623b\u3057\u305f\u3042\u3068\u306b\u51e6\u7406\u3059\u308b\u3002\u30fb\u30fb\u304a\u305d\u3089\u304f\u91cd\u3044\u3002)\n\u203bif\u6587\u3067\u306e\u5206\u5c90\u3092\u5897\u3084\u3055\u306a\u3044\u305f\u3081\u306b\u3001map\u3092\u4f7f\u3063\u3066\u3001CF-IPCOUNTRY\u3067\u6e21\u3055\u308c\u305f\u60c5\u5831\u3092\u3001yes \u307e\u305f\u306f no\u306b\u632f\u308a\u5206\u3051\u307e\u3059\u3002\n(allow\u3001yes\u3001no\u306f\u3001\u5225\u306e\u540d\u524d\u3067\u3082\u53ef)\n\u4f8b:JP\u3060\u3051\u3092yes\u306b\u3059\u308b\u5834\u5408\u3002\nhttp\u30d6\u30ed\u30c3\u30af\u3067\n\nmap $http_cf_ipcountry $allow {\n    default no;\n    JP yes;\n}\n\n\nserver\u30d6\u30ed\u30c3\u30af\u307e\u305f\u306flocation\u30d6\u30ed\u30c3\u30af\u3067\n\nif ($allow = no) {\n    return 403;\n}\n\n\n\u203breturn\u304c\u8868\u793a\u3059\u308b\u306e\u306f\u3001Nginx\u306e\u30c7\u30d5\u30a9\u30eb\u30c8\u306e\u30a8\u30e9\u30fc\u30da\u30fc\u30b8\u3067\u3059\u3002\n\u3000(error_page\u3067\u6307\u5b9a\u3057\u305f\u30da\u30fc\u30b8\u3067\u306f\u3042\u308a\u307e\u305b\u3093\u3002)\n\u203breturn\u306f\u3001300\u756a\u53f0(301, 302, 303, 307)\u4ee5\u5916\u306f\u3001\u5225\u306e\u30a2\u30c9\u30ec\u30b9\u306b\u8ee2\u9001\u3067\u304d\u307e\u305b\u3093\u3002\n\u203b\u8ee2\u9001\u3067\u304d\u306a\u3044\u30a8\u30e9\u30fc\u30bf\u30a4\u30d7\u306e\u5834\u5408\u306f\u3001\n\nreturn code [text];\n\n\u3068\u3057\u3066\u89e3\u91c8\u3055\u308c\u308b\u306e\u3067\u3001\u8ee2\u9001\u5148\u3060\u3068\u601d\u3063\u3066\u66f8\u3044\u305f\u30a2\u30c9\u30ec\u30b9\u304c\u3001\u305d\u306e\u307e\u307e\u30c6\u30ad\u30b9\u30c8\u3068\u3057\u3066\u8868\u793a\u3055\u308c\u307e\u3059\u3002\u8981\u6ce8\u610f\u3002\n\u53c2\u8003:\nUsing CloudFlare for country blocking\n#IP\u30d5\u30a3\u30eb\u30bf\nCDN\u5229\u7528\u6642\u306b\u3001\u5b9fIP\u306e\u304b\u308f\u308a\u306bCDN\u306eIP\u304c\u6765\u308b\u5834\u5408\u3002\n(AWS\u306e\u4e00\u90e8\u306e\u30b5\u30fc\u30d3\u30b9\u3067\u3082\u540c\u3058\u65b9\u6cd5\u3067\u3002)\n\n\u30fbiptables\u3067\u898b\u3048\u308b\u306e\u306f\u3001CDN\u306eIP\u306a\u306e\u3067\u6ce8\u610f\u3002\n\u30fb\u51e6\u7406\u5bfe\u8c61\u304cHTTP\u30d8\u30c3\u30c0\u306a\u306e\u3067\u3001iptables\u3067\u306f\u306a\u304f\u3001Nginx\u306a\u3069\u3067\u51e6\u7406\u3059\u308b\u3002\n\u30fbCDN\u304c\u4ed8\u3051\u3066\u304f\u308c\u308b\u3001X-Forwarded-For\u306a\u3069\u3092\u5229\u7528\u3059\u308b\u3002\n\nNginx\n[Module ngx_http_realip_module](http://nginx.org/en/docs/http/ngx_http_realip_module.html) \u304c\u5fc5\u8981\u3002\n\u30d3\u30eb\u30c9\u6642\u306econfig\u306b\u3001--with-http_realip_module \u3092\u3064\u3051\u308b\u3002\n\nset_real_ip_from\u3001real_ip_header\u306f\u3001\n>Context: \thttp, server, location\n\n\u306a\u306e\u3067\u3001http\u3001server\u3001location\u306a\u3069\u3067\u51e6\u7406\u3059\u308b\u3002\n\n>set_real_ip_from\u3000CDN\u306e\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u30a2\u30c9\u30ec\u30b9;\n>real_ip_header    X-Forwarded-For;\n\n\u307e\u305f\u306f\u3001\n\n>set_real_ip_from\u3000CDN\u306e\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u30a2\u30c9\u30ec\u30b9;\n>real_ip_header CF-Connecting-IP;\n\n\u203bCF-Connecting-IP\u306f\u3001CDN\u304cCloudFlare\u306e\u5834\u5408\u306b\u5229\u7528\u53ef\u80fd\u3002\n\n\u53c2\u8003:\n[How do I restore original visitor IP with Nginx?](file:///F:/Projects/Linux/data/Cloudflare/How%20do%20I%20restore%20original%20visitor%20IP%20with%20Nginx%20%20%E2%80%93%20CloudFlare%20Support.htm)\n[CloudFlare IP Ranges](https://www.cloudflare.com/ips)\n\n----\n#\u56fd\u5225\u30d5\u30a3\u30eb\u30bf\n\n\u30fbiptables\u3067\u898b\u3048\u308b\u306e\u306f\u3001CDN\u306eIP\u306a\u306e\u3067\u6ce8\u610f\u3002\n\u30fb\u51e6\u7406\u5bfe\u8c61\u304cHTTP\u30d8\u30c3\u30c0\u306a\u306e\u3067\u3001iptables\u3067\u306f\u306a\u304f\u3001Nginx\u306a\u3069\u3067\u51e6\u7406\u3059\u308b\u3002\n\u30fbCDN\u304c\u4ed8\u3051\u3066\u304f\u308c\u308b\u3001CF-IPCOUNTRY\u306a\u3069\u3092\u5229\u7528\u3059\u308b\u3002\n\u3000(\u307e\u305f\u306f\u3001set_real_ip_from\u3067\u5b9fIP\u306b\u623b\u3057\u305f\u3042\u3068\u306b\u51e6\u7406\u3059\u308b\u3002\u30fb\u30fb\u304a\u305d\u3089\u304f\u91cd\u3044\u3002)\n\n\u203b[if](http://nginx.org/en/docs/http/ngx_http_rewrite_module.html#if)\u6587\u3067\u306e\u5206\u5c90\u3092\u5897\u3084\u3055\u306a\u3044\u305f\u3081\u306b\u3001[map](http://nginx.org/en/docs/http/ngx_http_map_module.html#map)\u3092\u4f7f\u3063\u3066\u3001CF-IPCOUNTRY\u3067\u6e21\u3055\u308c\u305f\u60c5\u5831\u3092\u3001yes \u307e\u305f\u306f no\u306b\u632f\u308a\u5206\u3051\u307e\u3059\u3002\n(allow\u3001yes\u3001no\u306f\u3001\u5225\u306e\u540d\u524d\u3067\u3082\u53ef)\n\u4f8b:JP\u3060\u3051\u3092yes\u306b\u3059\u308b\u5834\u5408\u3002\nhttp\u30d6\u30ed\u30c3\u30af\u3067\n>```\nmap $http_cf_ipcountry $allow {\n    default no;\n    JP yes;\n}\n```\n\nserver\u30d6\u30ed\u30c3\u30af\u307e\u305f\u306flocation\u30d6\u30ed\u30c3\u30af\u3067\n>```\nif ($allow = no) {\n    return 403;\n}\n```\n\n\u203breturn\u304c\u8868\u793a\u3059\u308b\u306e\u306f\u3001Nginx\u306e\u30c7\u30d5\u30a9\u30eb\u30c8\u306e\u30a8\u30e9\u30fc\u30da\u30fc\u30b8\u3067\u3059\u3002\n\u3000(error_page\u3067\u6307\u5b9a\u3057\u305f\u30da\u30fc\u30b8\u3067\u306f\u3042\u308a\u307e\u305b\u3093\u3002)\n\u203b[return](http://nginx.org/en/docs/http/ngx_http_rewrite_module.html#return)\u306f\u3001300\u756a\u53f0(301, 302, 303, 307)\u4ee5\u5916\u306f\u3001\u5225\u306e\u30a2\u30c9\u30ec\u30b9\u306b\u8ee2\u9001\u3067\u304d\u307e\u305b\u3093\u3002\n\u203b\u8ee2\u9001\u3067\u304d\u306a\u3044\u30a8\u30e9\u30fc\u30bf\u30a4\u30d7\u306e\u5834\u5408\u306f\u3001\n>return code [text];\n\n\u3068\u3057\u3066\u89e3\u91c8\u3055\u308c\u308b\u306e\u3067\u3001\u8ee2\u9001\u5148\u3060\u3068\u601d\u3063\u3066\u66f8\u3044\u305f\u30a2\u30c9\u30ec\u30b9\u304c\u3001\u305d\u306e\u307e\u307e\u30c6\u30ad\u30b9\u30c8\u3068\u3057\u3066\u8868\u793a\u3055\u308c\u307e\u3059\u3002\u8981\u6ce8\u610f\u3002\n\n\u53c2\u8003:\n[Using CloudFlare for country blocking](http://nginxlibrary.com/using-cloudflare-for-country-blocking/)\n", "tags": ["nginx", "iptables"]}