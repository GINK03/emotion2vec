{"context": "\n\n\u306f\u3058\u3081\u306b\n\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3092\u9577\u304f\u904b\u7528\u3057\u3066\u3044\u308b\u3068\u3001\u30e6\u30fc\u30b6\u30fc\u306e\u64cd\u4f5c\u5c65\u6b74\u306a\u3069\u3001\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306b\u4fdd\u5b58\u3059\u308b\u30c7\u30fc\u30bf\u4ee5\u5916\u306b\u3001\u64cd\u4f5c\u30ed\u30b0\u306a\u3069\u3092\u53d6\u3089\u306a\u3051\u308c\u3070\u3044\u3051\u306a\u3044\u30b1\u30fc\u30b9\u304c\u51fa\u3066\u304d\u307e\u3059\u3002\n\u4eca\u66f4\u3067\u306f\u3042\u308a\u307e\u3059\u304c\u3001fluentd\u3092\u4f7f\u3063\u3066monolog\u304b\u3089\u51fa\u529b\u3055\u308c\u305f\u30ed\u30b0\u3092\u96c6\u7d04\u3057\u3066\u307f\u307e\u3059\u3002\n\n\u305d\u306e\uff11 Fluent-Logger-PHP\u3067\u76f4\u63a5fluentd\u306b\u30ed\u30b0\u3092\u9001\u308b\n\u65b0\u305f\u306b\u30ed\u30b0\u3092\u53d6\u308b\u5834\u5408\u306f\u3001\u3044\u3063\u305f\u3093\u30c6\u30ad\u30b9\u30c8\u30d5\u30a1\u30a4\u30eb\u306b\u51fa\u529b\u3057\u305f\u3082\u306e\u3092\u96c6\u8a08\u3059\u308b\u306e\u3067\u306f\u306a\u304f\u3001\u76f4\u63a5\u3001fluentd\u306b\u30ed\u30b0\u3092\u9001\u308a\u3064\u3051\u3066\u3082\u3044\u3044\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u3002\n\n\u69cb\u6210\n\n\u30a2\u30d7\u30ea\u5074\u306f\u3001monolog-fluent-handler\u3092\u4f7f\u3063\u3066\u30ed\u30b0\u3092\u51fa\u529b\n\u30a2\u30d7\u30ea\u304b\u3089\u51fa\u529b\u3055\u308c\u305f\u30ed\u30b0\u3092\u3001in_forward\u3067\u53d7\u4fe1\nrecord_transformer\u30d5\u30a3\u30eb\u30bf\u3067\u3001\u30ec\u30b3\u30fc\u30c9\u3092\u6574\u5f62\u3059\u308b\nsqlite3\u306b\u30d5\u30a3\u30eb\u30bf\u3057\u305f\u30c7\u30fc\u30bf\u3092INSERT\u3059\u308b\n\n\nmonolog-fluent-handler\u3092\u4f7f\u3063\u3066\u30ed\u30b0\u3092\u51fa\u529b\nmonolog\u3068monolog-fluent-handler\u3092require\u3057\u307e\u3059\u3002\n$ composer require \"monolog/monolog:1.*\"\n$ composer require \"dakatsuka/monolog-fluent-handler\"\n\n\ncomposer.json\n{\n    \"require\": {\n        \"monolog/monolog\": \"1.*\",\n        \"dakatsuka/monolog-fluent-handler\": \"^1.2\"\n    }\n}\n\n\n\nexample/fluent_handler.php\n<?php\nrequire_once __DIR__.'/../vendor/autoload.php';\n\nuse Dakatsuka\\MonologFluentHandler\\FluentHandler;\nuse Monolog\\Logger;\n\n// Global settings\nsetlocale(LC_ALL, 'ja_JP.UTF-8');\ndate_default_timezone_set('Asia/Tokyo');\n\n$logger = new Logger('example');\n$logger->pushHandler(new FluentHandler());\n\n$logger->debug('fluent', ['message' => 'foo bar']);\n\n\n\n\u30dd\u30a4\u30f3\u30c8\n\nFluentHandler\u306e\u5f15\u6570\u3092\u7701\u7565\u3059\u308b\u3068\u3001FluentLogger(fluent-logger-php)\u304c\u4f7f\u7528\u3055\u308c\u308b\nLogger\u306e\u30c1\u30e3\u30f3\u30cd\u30eb\u540d\u3068\u3001\u30ed\u30b0\u30e1\u30c3\u30bb\u30fc\u30b8\u304c\u7d44\u307f\u5408\u308f\u3055\u308c\u3066\u3001Tag\u540d\u306b\u306a\u308b\n\n    public function write(array $record)\n    {\n        $tag  = $record['channel'] . '.' . $record['message'];\n        $data = $record['context'];\n        $data['level'] = Logger::getLevelName($record['level']);\n\n        $this->logger->post($tag, $data);\n    }\n\n\n\u53c2\u8003URL\n\nMonolog\u306e\u30ed\u30b0\u51fa\u529b\u5148\u3092Fluentd\u306b\u5909\u66f4\u3057\u3066\u307f\u305f | dakatsuka's blog\nfluent/fluent-logger-php: A structured logger for Fluentd (PHP)\n\n\n\u30a2\u30d7\u30ea\u304b\u3089\u51fa\u529b\u3055\u308c\u305f\u30ed\u30b0\u3092\u3001in_forward\u3067\u53d7\u4fe1\n\n/etc/td-agent/td-agent.conf\n<source>\n  @type forward\n</source>\n\n\n\n\u53c2\u8003URL\n\nforward Input Plugin | Fluentd\n\n\nrecord_transformer\u30d5\u30a3\u30eb\u30bf\u3067\u3001\u30ec\u30b3\u30fc\u30c9\u3092\u6574\u5f62\u3059\u308b\n\n/etc/td-agent/td-agent.conf\n<filter example.fluent>\n  @type record_transformer\n  renew_record true\n  enable_ruby true\n  <record>\n    level ${level}\n    message ${message}\n    handler fluent\n    created_at ${time.to_datetime.strftime('%Y-%m-%d %H:%M:%S')}\n  </record>\n</filter>\n\n\n\n\u30dd\u30a4\u30f3\u30c8\n\nmonolog\u3067\u8a00\u3046$context\u304cfluent-logger-php\u3067\u306f\u3001\u30e1\u30a4\u30f3\u306e\u30c7\u30fc\u30bf\u3068\u3057\u3066\u6271\u308f\u308c\u308b\n\nrenew_record true\u3068\u3059\u308b\u3068\u3001<record></record>\u3067\u5b9a\u7fa9\u3055\u308c\u305f\u30a2\u30a4\u30c6\u30e0\u306e\u307f\u3068\u306a\u308b\u3001false\u307e\u305f\u306f\u672a\u5b9a\u7fa9\u3060\u3068\u3001<record></record>\u3067\u5b9a\u7fa9\u3055\u308c\u305f\u30a2\u30a4\u30c6\u30e0\u306f\u3001\u3059\u3067\u306b\u3042\u308b\u30c7\u30fc\u30bf\u306b\u8ffd\u52a0\u3055\u308c\u308b\n\nenable_ruby true\u3068\u3059\u308b\u3068\u3001ruby\u306e\u7d44\u307f\u8fbc\u307f\u95a2\u6570\u3092\u4f7f\u3046\u3053\u3068\u304c\u3067\u304d\u308b\n\n\n\u53c2\u8003URL\n\nrecord_transformer Filter Plugin | Fluentd\n\n\nsqlite3\u306b\u30d5\u30a3\u30eb\u30bf\u3057\u305f\u30c7\u30fc\u30bf\u3092INSERT\u3059\u308b\n\n/etc/td-agent/td-agent.conf\n<match example.fluent>\n  @type sqlite3\n  path /var/db/td-agent/example.sqlite3\n  table log\n  columns level,message,handler,created_at\n</match>\n\n\n\nfluent-plugin-sqlite3\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\u96c6\u3081\u305f\u30ed\u30b0\u3092SQLite\u306b\u4fdd\u5b58\u3057\u307e\u3059\u3002\n$ yum install -y sqlite-devel\n$ td-agent-gem install fluent-plugin-sqlite3\n\n\n\u4e8b\u524d\u306b\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u3092\u4f5c\u6210\n$ sqlite3 /path/to/database.sqlite3 < /path/to/create_tables.sql\n\n\ncreate_tables.sql\ncreate table if not exists log\n(\n  id INTEGER PRIMARY KEY AUTOINCREMENT,\n  level TEXT,\n  message TEXT,\n  handler TEXT,\n  created_at TIMESTAMP DEFAULT (datetime('now','localtime'))\n);\n\n\n\n\u30dd\u30a4\u30f3\u30c8\n\ncolumns\u306b\u5165\u529b\u5fc5\u8981\u306a\u5217\u306e\u30c7\u30fc\u30bf\u3092\u5217\u6319\u3059\u308b\u3001\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306e\u5217\u540d\u3068\u5408\u308f\u305b\u308b\u5fc5\u8981\u304c\u3042\u308b\n\n\n\u53c2\u8003URL\n\ntmtk75/fluent-plugin-sqlite3\n\n\n\u305d\u306e\uff12 StreamHandler\u3067\u51fa\u529b\u3057\u305f\u30c6\u30ad\u30b9\u30c8\u30ed\u30b0\u3092\u96c6\u7d04\u3059\u308b\n\u3059\u3067\u306b\u30c6\u30ad\u30b9\u30c8\u3068\u3057\u3066\u51fa\u529b\u3055\u308c\u3066\u3044\u308b\u30ed\u30b0\u3092\u6574\u5f62\u3057\u3066\u3001\u96c6\u7d04\u3057\u3066\u307f\u307e\u3059\u3002\n\n\u69cb\u6210\n\n\u30a2\u30d7\u30ea\u5074\u306f\u3001StreamHandler\u3092\u4f7f\u3063\u3066\u30ed\u30b0\u3092\u30c6\u30ad\u30b9\u30c8\u30d5\u30a1\u30a4\u30eb\u306b\u51fa\u529b\n\u30a2\u30d7\u30ea\u304b\u3089\u51fa\u529b\u3055\u308c\u305f\u30ed\u30b0\u3092\u3001in_tail\u3067\u53ce\u96c6 \u6b63\u898f\u8868\u73fe\u3067\u3056\u3063\u304f\u308a\u8981\u7d20\u5206\u89e3\n\n\u30ab\u30b9\u30bf\u30e0\u30d1\u30fc\u30b5\u30fc(parser_monolog.rb)\u3092\u8ffd\u52a0\u3001\u53ce\u96c6\u3057\u305f\u30ed\u30b0\u3092\u30d1\u30fc\u30b9\nparser\u30d7\u30e9\u30b0\u30a4\u30f3\u3067\u3001json\u90e8\u5206\u3092\u30d1\u30fc\u30b9\nrecord_transformer\u30d5\u30a3\u30eb\u30bf\u3067\u3001\u30ec\u30b3\u30fc\u30c9\u3092\u6574\u5f62\u3059\u308b\nsqlite3\u306b\u30d5\u30a3\u30eb\u30bf\u3057\u305f\u30c7\u30fc\u30bf\u3092INSERT\u3059\u308b\n\n\nStreamHandler\u3092\u4f7f\u3063\u3066\u30ed\u30b0\u3092\u30c6\u30ad\u30b9\u30c8\u30d5\u30a1\u30a4\u30eb\u306b\u51fa\u529b\n\nexample/stream_handler.php\n<?php\nrequire_once __DIR__.'/../vendor/autoload.php';\n\nuse Monolog\\Handler\\StreamHandler;\nuse Monolog\\Logger;\n\n// Global settings\nsetlocale(LC_ALL, 'ja_JP.UTF-8');\ndate_default_timezone_set('Asia/Tokyo');\n\n$logger = new Logger('example');\n$logger->pushHandler(new StreamHandler(__DIR__.'/../var/log/example_stream.log', Logger::DEBUG, true, 0777));\n\n$logger->debug('stream', ['message' => 'foo bar']);\n\n\n\u51fa\u529b\u3055\u308c\u305f\u30ed\u30b0\u30d5\u30a1\u30a4\u30eb\u306f\u4e0b\u8a18\u306e\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\n\nexample_stream.log\n[2016-07-06 19:02:28] example.DEBUG: stream {\"message\":\"foo bar\"} []\n\n\n\n\u30a2\u30d7\u30ea\u304b\u3089\u51fa\u529b\u3055\u308c\u305f\u30ed\u30b0\u3092\u3001in_tail\u3067\u53ce\u96c6 \u6b63\u898f\u8868\u73fe\u3067\u3056\u3063\u304f\u308a\u8981\u7d20\u5206\u89e3\n\n\n/etc/td-agent/td-agent.conf\n<source>\n  @type tail\n  path /data/var/log/example_stream.log\n  #format /^\\[(?<timestamp>[\\d\\-]+ [\\d\\:]+)\\] (?<log_name>.+)\\.(?<log_level>(DEBUG|INFO|NOTICE|WARNING|ERROR|CRITICAL|ALERT|EMERGENCY))\\: (?<message>.*) (?<context>\\{.+\\}) \\[(?<extra>.*)\\]$/\n  format monolog # parser_monolog.rb\n  pos_file /var/log/td-agent/example_stream.log.pos\n  tag example.stream\n</source>\n\n\n\n\u30dd\u30a4\u30f3\u30c8\n\ncontext\u306fjson\u3068\u3057\u3066\u51fa\u529b\u3055\u308c\u3066\u3044\u308b\u304c\u3001\u7d50\u679c\u3001json\u3068\u3057\u3066parse\u3057\u3066\u3042\u3052\u306a\u3044\u3068json\u3068\u3057\u3066\u6271\u3048\u306a\u3044\nformat\u3092\u6b63\u898f\u8868\u73fe\u304b\u3089\u3001monolog\uff08\u30ab\u30b9\u30bf\u30e0\u30d1\u30fc\u30b5\u30fc\uff09\u306b\u5909\u66f4\n\n\n\u53c2\u8003URL\n\ntail Input Plugin | Fluentd\n\n\n\u30ab\u30b9\u30bf\u30e0\u30d1\u30fc\u30b5\u30fc(parser_monolog.rb)\u3092\u8ffd\u52a0\u3001\u53ce\u96c6\u3057\u305f\u30ed\u30b0\u3092\u30d1\u30fc\u30b9\n\u3059\u3079\u3066\u30c6\u30ad\u30b9\u30c8\u3067\u3042\u308c\u3070\u3001\u6b63\u898f\u8868\u73fe\u3067\u30d1\u30fc\u30b9\u3067\u304d\u308c\u3070\u4e8b\u8db3\u308a\u305f\u306e\u3060\u304c\u3001context\u90e8\u5206\u306fJSON\u6587\u5b57\u5217\u306b\u306a\u308b\u305f\u3081\u3001fluent\u5185\u3067JSON\u3068\u3057\u3066\u6271\u3044\u305f\u3044\u3002\n\u305d\u306e\u305f\u3081\u306b\u3001fluent-plugin-parser\u3092\u4f7f\u3063\u3066\u3044\u305f\u304c\u3001\u6bce\u56demonolog\u7528\u306e\u6b63\u898f\u8868\u73fe\u3092\u30b3\u30d4\u30fc\u3059\u308b\u306e\u306f\u975e\u52b9\u7387\u306a\u306e\u3067\u3001\u30ab\u30b9\u30bf\u30e0\u30d1\u30fc\u30b5\u30fc\u3092\u4f5c\u308b\u3053\u3068\u306b\u3057\u307e\u3057\u305f\u3002\n\nfluent/plugin/parser_monolog.rb\nrequire 'fluent/parser'\nrequire 'json'\n\nmodule Fluent\n  class TextParser\n    class MonologParser < Parser\n      Plugin.register_parser('monolog', self)\n\n      REGEXP = /^\\[(?<time>[\\d\\-]+ [\\d\\:]+)\\] (?<channel>.+)\\.(?<level>(DEBUG|INFO|NOTICE|WARNING|ERROR|CRITICAL|ALERT|EMERGENCY))\\: (?<message>.*) (?<context>\\{.+\\}) \\[(?<extra>.*)\\]$/\n      TIME_FORMAT = \"%Y-%m-%d %H:%M:%S\"\n\n      def initialize\n        super\n        @time_parser = TimeParser.new(TIME_FORMAT)\n        @mutex = Mutex.new\n      end\n\n      def patterns\n        {'format' => REGEXP, 'time_format' => TIME_FORMAT}\n      end\n\n      def parse(text)\n        m = REGEXP.match(text)\n        unless m\n          yield nil, nil\n          return\n        end\n\n        time = m['time']\n        time = @mutex.synchronize { @time_parser.parse(time) }\n\n        channel = m['channel']\n        level = m['level']\n        message = m['message']\n        context = JSON.parse(m['context'])\n        extra = m['extra']\n\n        record = {\n            \"channel\" => channel,\n            \"level\" => level,\n            \"message\" => message,\n            \"context\" => context,\n            \"extra\" => extra\n        }\n        record[\"time\"] = m['time'] if @keep_time_key\n\n        yield time, record\n      end\n    end\n  end\nend\n\n\n\n\u30dd\u30a4\u30f3\u30c8\n\n\nlib/fluent/plugin/parser_apache2.rb\u306e\u307b\u307c\u30d1\u30af\u30ea\ncontext\u306fJSON.parse\u3057\u3066record\u306b\u30bb\u30c3\u30c8\n\n/etc/td-agent/plugin/ \u306b\u914d\u7f6e\u3057\u3066\u3001td-agent\u3092\u8d77\u52d5\u3059\u308b\u3060\u3051\n\n\n\u53c2\u8003URL\n\nFluentd Formatter \u30d7\u30e9\u30b0\u30a4\u30f3\u5165\u9580 - Qiita\nfluentd\u306e\u30ab\u30b9\u30bf\u30e0Parser Plugin\u3092\u4f5c\u3063\u3066\u307f\u308b - Qiita\n\n\nparser\u30d7\u30e9\u30b0\u30a4\u30f3\u3067\u3001json\u90e8\u5206\u3092\u30d1\u30fc\u30b9\n\n\nrecord_transformer\u30d5\u30a3\u30eb\u30bf\u3067\u3001\u30ec\u30b3\u30fc\u30c9\u3092\u6574\u5f62\u3059\u308b\n\n/etc/td-agent/td-agent.conf\n<filter example.stream>\n  @type record_transformer\n  renew_record true\n  enable_ruby true\n  <record>\n    level ${level}\n    message ${context[\"message\"]}\n    handler stream\n    created_at ${time.strftime('%Y-%m-%d %H:%M:%S')}\n  </record>\n</filter>\n\n\n\n\u30dd\u30a4\u30f3\u30c8\n\njson\u306b\u30d1\u30fc\u30b9\u3057\u3066\u3044\u308b\u306e\u3067\u3001${context[\"message\"]}\u306e\u3088\u3046\u306b\u3001json\u306e\u5404\u30d5\u30a3\u30fc\u30eb\u30c9\u3092\u53c2\u7167\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u308b\n\n\nsqlite3\u306b\u30d5\u30a3\u30eb\u30bf\u3057\u305f\u30c7\u30fc\u30bf\u3092INSERT\u3059\u308b\n\u524d\u8ff0\u3057\u305f\u65b9\u6cd5\u3068\u540c\u3058\u306a\u306e\u3067\u3001\u8aac\u660e\u3092\u5272\u611b\u3057\u307e\u3059\u3002\n\n\u7d50\u679c\nFluentHandler\u3068StreamHandler\u305d\u308c\u305e\u308c\u304b\u3089\u51fa\u529b\u3057\u305f\u30ed\u30b0\u304c\u3001\u3068\u3082\u306bsqlite3\u306b\u4fdd\u5b58\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n$ sqlite3 /var/db/td-agent/example.sqlite3 \"select * from log;\"\n1|DEBUG|foo bar|fluent|2016-07-06 18:59:09\n2|DEBUG|foo bar|stream|2016-07-06 19:02:28\n\n\nimunew/monolog-fluentd-example\u3067\u52d5\u4f5c\u78ba\u8a8d\u3067\u304d\u307e\u3059\nimunew/monolog-fluentd-example\u3092clone\u3057\u3001README\u3092\u898b\u306a\u304c\u3089\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u3059\u308c\u3070\u3001sandbox\u7684\u306b\u52d5\u4f5c\u78ba\u8a8d\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\n\u304a\u308f\u308a\u306b\n\nfluentd\u81ea\u4f53\u306f\u3001\u5927\u307e\u304b\u306b\u306f\u3001input\u3001output\u3001filter\u3067\u69cb\u6210\u3055\u308c\u3066\u3044\u3066\u3001\u8272\u3005\u306a\u7d44\u307f\u5408\u308f\u305b\u304c\u53ef\u80fd\u306b\u306a\u3063\u3066\u3044\u308b\n\u30b7\u30f3\u30d7\u30eb\u304b\u3064\u758e\u7d50\u5408\u306a\u30a8\u30b3\u30b7\u30b9\u30c6\u30e0\u306a\u306e\u3067\u3001\u81ea\u5206\u306e\u7528\u9014\u306b\u3042\u3063\u305fplugin\u3092\u4f5c\u6210\u30fb\u516c\u958b\u3057\u3066\u3082\u3044\u3044\u304b\u3082\u3057\u308c\u306a\u3044\nmonolog\u306fsymfony\u4ee5\u5916\u3067\u3082\u4f7f\u308f\u308c\u3066\u3044\u308b\u3068\u601d\u3046\u306e\u3067\u3001parser_monolog\u306f\u9700\u8981\u3042\u308a\u305d\u3046\n\n\n\nfluent-plugin-monolog\u3092rubygems.org\u306b\u516c\u958b\u3057\u307e\u3057\u305f - Qiita \uff082016-07-10\u8ffd\u8a18\uff09\n\n\n\n\n## \u306f\u3058\u3081\u306b\n\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3092\u9577\u304f\u904b\u7528\u3057\u3066\u3044\u308b\u3068\u3001\u30e6\u30fc\u30b6\u30fc\u306e\u64cd\u4f5c\u5c65\u6b74\u306a\u3069\u3001\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306b\u4fdd\u5b58\u3059\u308b\u30c7\u30fc\u30bf\u4ee5\u5916\u306b\u3001\u64cd\u4f5c\u30ed\u30b0\u306a\u3069\u3092\u53d6\u3089\u306a\u3051\u308c\u3070\u3044\u3051\u306a\u3044\u30b1\u30fc\u30b9\u304c\u51fa\u3066\u304d\u307e\u3059\u3002\n\u4eca\u66f4\u3067\u306f\u3042\u308a\u307e\u3059\u304c\u3001fluentd\u3092\u4f7f\u3063\u3066monolog\u304b\u3089\u51fa\u529b\u3055\u308c\u305f\u30ed\u30b0\u3092\u96c6\u7d04\u3057\u3066\u307f\u307e\u3059\u3002\n\n## \u305d\u306e\uff11 Fluent-Logger-PHP\u3067\u76f4\u63a5fluentd\u306b\u30ed\u30b0\u3092\u9001\u308b\n\u65b0\u305f\u306b\u30ed\u30b0\u3092\u53d6\u308b\u5834\u5408\u306f\u3001\u3044\u3063\u305f\u3093\u30c6\u30ad\u30b9\u30c8\u30d5\u30a1\u30a4\u30eb\u306b\u51fa\u529b\u3057\u305f\u3082\u306e\u3092\u96c6\u8a08\u3059\u308b\u306e\u3067\u306f\u306a\u304f\u3001\u76f4\u63a5\u3001fluentd\u306b\u30ed\u30b0\u3092\u9001\u308a\u3064\u3051\u3066\u3082\u3044\u3044\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u3002\n\n### \u69cb\u6210\n- \u30a2\u30d7\u30ea\u5074\u306f\u3001monolog-fluent-handler\u3092\u4f7f\u3063\u3066\u30ed\u30b0\u3092\u51fa\u529b\n- \u30a2\u30d7\u30ea\u304b\u3089\u51fa\u529b\u3055\u308c\u305f\u30ed\u30b0\u3092\u3001in_forward\u3067\u53d7\u4fe1\n- record_transformer\u30d5\u30a3\u30eb\u30bf\u3067\u3001\u30ec\u30b3\u30fc\u30c9\u3092\u6574\u5f62\u3059\u308b\n- sqlite3\u306b\u30d5\u30a3\u30eb\u30bf\u3057\u305f\u30c7\u30fc\u30bf\u3092INSERT\u3059\u308b\n\n### monolog-fluent-handler\u3092\u4f7f\u3063\u3066\u30ed\u30b0\u3092\u51fa\u529b\n`monolog`\u3068`monolog-fluent-handler`\u3092require\u3057\u307e\u3059\u3002\n\n```bash\n$ composer require \"monolog/monolog:1.*\"\n$ composer require \"dakatsuka/monolog-fluent-handler\"\n```\n\n```composer.json\n{\n    \"require\": {\n        \"monolog/monolog\": \"1.*\",\n        \"dakatsuka/monolog-fluent-handler\": \"^1.2\"\n    }\n}\n```\n\n```example/fluent_handler.php\n<?php\nrequire_once __DIR__.'/../vendor/autoload.php';\n\nuse Dakatsuka\\MonologFluentHandler\\FluentHandler;\nuse Monolog\\Logger;\n\n// Global settings\nsetlocale(LC_ALL, 'ja_JP.UTF-8');\ndate_default_timezone_set('Asia/Tokyo');\n\n$logger = new Logger('example');\n$logger->pushHandler(new FluentHandler());\n\n$logger->debug('fluent', ['message' => 'foo bar']);\n```\n\n#### \u30dd\u30a4\u30f3\u30c8\n- FluentHandler\u306e\u5f15\u6570\u3092\u7701\u7565\u3059\u308b\u3068\u3001FluentLogger(fluent-logger-php)\u304c\u4f7f\u7528\u3055\u308c\u308b\n- Logger\u306e\u30c1\u30e3\u30f3\u30cd\u30eb\u540d\u3068\u3001\u30ed\u30b0\u30e1\u30c3\u30bb\u30fc\u30b8\u304c\u7d44\u307f\u5408\u308f\u3055\u308c\u3066\u3001Tag\u540d\u306b\u306a\u308b\n\n  ```\n    public function write(array $record)\n    {\n        $tag  = $record['channel'] . '.' . $record['message'];\n        $data = $record['context'];\n        $data['level'] = Logger::getLevelName($record['level']);\n\n        $this->logger->post($tag, $data);\n    }\n  ```\n\n#### \u53c2\u8003URL\n\n- [Monolog\u306e\u30ed\u30b0\u51fa\u529b\u5148\u3092Fluentd\u306b\u5909\u66f4\u3057\u3066\u307f\u305f | dakatsuka's blog](https://blog.dakatsuka.jp/2013/10/18/monolog-fluentd.html)\n- [fluent/fluent-logger-php: A structured logger for Fluentd (PHP)](https://github.com/fluent/fluent-logger-php)\n\n\n### \u30a2\u30d7\u30ea\u304b\u3089\u51fa\u529b\u3055\u308c\u305f\u30ed\u30b0\u3092\u3001in_forward\u3067\u53d7\u4fe1\n```/etc/td-agent/td-agent.conf\n<source>\n  @type forward\n</source>\n```\n\n#### \u53c2\u8003URL\n- [forward Input Plugin | Fluentd](http://docs.fluentd.org/articles/in_forward)\n\n### record_transformer\u30d5\u30a3\u30eb\u30bf\u3067\u3001\u30ec\u30b3\u30fc\u30c9\u3092\u6574\u5f62\u3059\u308b\n\n```/etc/td-agent/td-agent.conf\n<filter example.fluent>\n  @type record_transformer\n  renew_record true\n  enable_ruby true\n  <record>\n    level ${level}\n    message ${message}\n    handler fluent\n    created_at ${time.to_datetime.strftime('%Y-%m-%d %H:%M:%S')}\n  </record>\n</filter>\n```\n\n#### \u30dd\u30a4\u30f3\u30c8\n- monolog\u3067\u8a00\u3046$context\u304cfluent-logger-php\u3067\u306f\u3001\u30e1\u30a4\u30f3\u306e\u30c7\u30fc\u30bf\u3068\u3057\u3066\u6271\u308f\u308c\u308b\n- `renew_record true`\u3068\u3059\u308b\u3068\u3001`<record></record>`\u3067\u5b9a\u7fa9\u3055\u308c\u305f\u30a2\u30a4\u30c6\u30e0\u306e\u307f\u3068\u306a\u308b\u3001false\u307e\u305f\u306f\u672a\u5b9a\u7fa9\u3060\u3068\u3001`<record></record>`\u3067\u5b9a\u7fa9\u3055\u308c\u305f\u30a2\u30a4\u30c6\u30e0\u306f\u3001\u3059\u3067\u306b\u3042\u308b\u30c7\u30fc\u30bf\u306b\u8ffd\u52a0\u3055\u308c\u308b\n- `enable_ruby true`\u3068\u3059\u308b\u3068\u3001ruby\u306e\u7d44\u307f\u8fbc\u307f\u95a2\u6570\u3092\u4f7f\u3046\u3053\u3068\u304c\u3067\u304d\u308b\n\n#### \u53c2\u8003URL\n- [record_transformer Filter Plugin | Fluentd](http://docs.fluentd.org/articles/filter_record_transformer)\n\n### sqlite3\u306b\u30d5\u30a3\u30eb\u30bf\u3057\u305f\u30c7\u30fc\u30bf\u3092INSERT\u3059\u308b\n\n```/etc/td-agent/td-agent.conf\n<match example.fluent>\n  @type sqlite3\n  path /var/db/td-agent/example.sqlite3\n  table log\n  columns level,message,handler,created_at\n</match>\n```\n\n#### fluent-plugin-sqlite3\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\u96c6\u3081\u305f\u30ed\u30b0\u3092SQLite\u306b\u4fdd\u5b58\u3057\u307e\u3059\u3002\n\n```\n$ yum install -y sqlite-devel\n$ td-agent-gem install fluent-plugin-sqlite3\n```\n\n#### \u4e8b\u524d\u306b\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u3092\u4f5c\u6210\n```bash\n$ sqlite3 /path/to/database.sqlite3 < /path/to/create_tables.sql\n```\n\n```create_tables.sql\ncreate table if not exists log\n(\n  id INTEGER PRIMARY KEY AUTOINCREMENT,\n  level TEXT,\n  message TEXT,\n  handler TEXT,\n  created_at TIMESTAMP DEFAULT (datetime('now','localtime'))\n);\n```\n\n#### \u30dd\u30a4\u30f3\u30c8\n- columns\u306b\u5165\u529b\u5fc5\u8981\u306a\u5217\u306e\u30c7\u30fc\u30bf\u3092\u5217\u6319\u3059\u308b\u3001\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306e\u5217\u540d\u3068\u5408\u308f\u305b\u308b\u5fc5\u8981\u304c\u3042\u308b\n\n#### \u53c2\u8003URL\n- [tmtk75/fluent-plugin-sqlite3](https://github.com/tmtk75/fluent-plugin-sqlite3)\n\n## \u305d\u306e\uff12 StreamHandler\u3067\u51fa\u529b\u3057\u305f\u30c6\u30ad\u30b9\u30c8\u30ed\u30b0\u3092\u96c6\u7d04\u3059\u308b\n\u3059\u3067\u306b\u30c6\u30ad\u30b9\u30c8\u3068\u3057\u3066\u51fa\u529b\u3055\u308c\u3066\u3044\u308b\u30ed\u30b0\u3092\u6574\u5f62\u3057\u3066\u3001\u96c6\u7d04\u3057\u3066\u307f\u307e\u3059\u3002\n\n### \u69cb\u6210\n- \u30a2\u30d7\u30ea\u5074\u306f\u3001StreamHandler\u3092\u4f7f\u3063\u3066\u30ed\u30b0\u3092\u30c6\u30ad\u30b9\u30c8\u30d5\u30a1\u30a4\u30eb\u306b\u51fa\u529b\n- \u30a2\u30d7\u30ea\u304b\u3089\u51fa\u529b\u3055\u308c\u305f\u30ed\u30b0\u3092\u3001in_tail\u3067\u53ce\u96c6 ~~\u6b63\u898f\u8868\u73fe\u3067\u3056\u3063\u304f\u308a\u8981\u7d20\u5206\u89e3~~\n- \u30ab\u30b9\u30bf\u30e0\u30d1\u30fc\u30b5\u30fc(parser_monolog.rb)\u3092\u8ffd\u52a0\u3001\u53ce\u96c6\u3057\u305f\u30ed\u30b0\u3092\u30d1\u30fc\u30b9\n- ~~parser\u30d7\u30e9\u30b0\u30a4\u30f3\u3067\u3001json\u90e8\u5206\u3092\u30d1\u30fc\u30b9~~\n- record_transformer\u30d5\u30a3\u30eb\u30bf\u3067\u3001\u30ec\u30b3\u30fc\u30c9\u3092\u6574\u5f62\u3059\u308b\n- sqlite3\u306b\u30d5\u30a3\u30eb\u30bf\u3057\u305f\u30c7\u30fc\u30bf\u3092INSERT\u3059\u308b\n\n### StreamHandler\u3092\u4f7f\u3063\u3066\u30ed\u30b0\u3092\u30c6\u30ad\u30b9\u30c8\u30d5\u30a1\u30a4\u30eb\u306b\u51fa\u529b\n```example/stream_handler.php\n<?php\nrequire_once __DIR__.'/../vendor/autoload.php';\n\nuse Monolog\\Handler\\StreamHandler;\nuse Monolog\\Logger;\n\n// Global settings\nsetlocale(LC_ALL, 'ja_JP.UTF-8');\ndate_default_timezone_set('Asia/Tokyo');\n\n$logger = new Logger('example');\n$logger->pushHandler(new StreamHandler(__DIR__.'/../var/log/example_stream.log', Logger::DEBUG, true, 0777));\n\n$logger->debug('stream', ['message' => 'foo bar']);\n```\n\n\u51fa\u529b\u3055\u308c\u305f\u30ed\u30b0\u30d5\u30a1\u30a4\u30eb\u306f\u4e0b\u8a18\u306e\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\n\n```example_stream.log\n[2016-07-06 19:02:28] example.DEBUG: stream {\"message\":\"foo bar\"} []\n```\n\n### \u30a2\u30d7\u30ea\u304b\u3089\u51fa\u529b\u3055\u308c\u305f\u30ed\u30b0\u3092\u3001in_tail\u3067\u53ce\u96c6 ~~\u6b63\u898f\u8868\u73fe\u3067\u3056\u3063\u304f\u308a\u8981\u7d20\u5206\u89e3~~\n```/etc/td-agent/td-agent.conf\n<source>\n  @type tail\n  path /data/var/log/example_stream.log\n  #format /^\\[(?<timestamp>[\\d\\-]+ [\\d\\:]+)\\] (?<log_name>.+)\\.(?<log_level>(DEBUG|INFO|NOTICE|WARNING|ERROR|CRITICAL|ALERT|EMERGENCY))\\: (?<message>.*) (?<context>\\{.+\\}) \\[(?<extra>.*)\\]$/\n  format monolog # parser_monolog.rb\n  pos_file /var/log/td-agent/example_stream.log.pos\n  tag example.stream\n</source>\n```\n\n#### \u30dd\u30a4\u30f3\u30c8\n- ~~context\u306fjson\u3068\u3057\u3066\u51fa\u529b\u3055\u308c\u3066\u3044\u308b\u304c\u3001\u7d50\u679c\u3001json\u3068\u3057\u3066parse\u3057\u3066\u3042\u3052\u306a\u3044\u3068json\u3068\u3057\u3066\u6271\u3048\u306a\u3044~~\n- format\u3092\u6b63\u898f\u8868\u73fe\u304b\u3089\u3001monolog\uff08\u30ab\u30b9\u30bf\u30e0\u30d1\u30fc\u30b5\u30fc\uff09\u306b\u5909\u66f4\n\n#### \u53c2\u8003URL\n- [tail Input Plugin | Fluentd](http://docs.fluentd.org/articles/in_tail)\n\n### \u30ab\u30b9\u30bf\u30e0\u30d1\u30fc\u30b5\u30fc(parser_monolog.rb)\u3092\u8ffd\u52a0\u3001\u53ce\u96c6\u3057\u305f\u30ed\u30b0\u3092\u30d1\u30fc\u30b9\n\u3059\u3079\u3066\u30c6\u30ad\u30b9\u30c8\u3067\u3042\u308c\u3070\u3001\u6b63\u898f\u8868\u73fe\u3067\u30d1\u30fc\u30b9\u3067\u304d\u308c\u3070\u4e8b\u8db3\u308a\u305f\u306e\u3060\u304c\u3001context\u90e8\u5206\u306fJSON\u6587\u5b57\u5217\u306b\u306a\u308b\u305f\u3081\u3001fluent\u5185\u3067JSON\u3068\u3057\u3066\u6271\u3044\u305f\u3044\u3002\n\u305d\u306e\u305f\u3081\u306b\u3001[fluent-plugin-parser](https://github.com/tagomoris/fluent-plugin-parser)\u3092\u4f7f\u3063\u3066\u3044\u305f\u304c\u3001\u6bce\u56demonolog\u7528\u306e\u6b63\u898f\u8868\u73fe\u3092\u30b3\u30d4\u30fc\u3059\u308b\u306e\u306f\u975e\u52b9\u7387\u306a\u306e\u3067\u3001\u30ab\u30b9\u30bf\u30e0\u30d1\u30fc\u30b5\u30fc\u3092\u4f5c\u308b\u3053\u3068\u306b\u3057\u307e\u3057\u305f\u3002\n\n```fluent/plugin/parser_monolog.rb\nrequire 'fluent/parser'\nrequire 'json'\n\nmodule Fluent\n  class TextParser\n    class MonologParser < Parser\n      Plugin.register_parser('monolog', self)\n\n      REGEXP = /^\\[(?<time>[\\d\\-]+ [\\d\\:]+)\\] (?<channel>.+)\\.(?<level>(DEBUG|INFO|NOTICE|WARNING|ERROR|CRITICAL|ALERT|EMERGENCY))\\: (?<message>.*) (?<context>\\{.+\\}) \\[(?<extra>.*)\\]$/\n      TIME_FORMAT = \"%Y-%m-%d %H:%M:%S\"\n\n      def initialize\n        super\n        @time_parser = TimeParser.new(TIME_FORMAT)\n        @mutex = Mutex.new\n      end\n\n      def patterns\n        {'format' => REGEXP, 'time_format' => TIME_FORMAT}\n      end\n\n      def parse(text)\n        m = REGEXP.match(text)\n        unless m\n          yield nil, nil\n          return\n        end\n\n        time = m['time']\n        time = @mutex.synchronize { @time_parser.parse(time) }\n\n        channel = m['channel']\n        level = m['level']\n        message = m['message']\n        context = JSON.parse(m['context'])\n        extra = m['extra']\n\n        record = {\n            \"channel\" => channel,\n            \"level\" => level,\n            \"message\" => message,\n            \"context\" => context,\n            \"extra\" => extra\n        }\n        record[\"time\"] = m['time'] if @keep_time_key\n\n        yield time, record\n      end\n    end\n  end\nend\n```\n\n#### \u30dd\u30a4\u30f3\u30c8\n- [lib/fluent/plugin/parser_apache2.rb](https://github.com/fluent/fluentd/blob/master/lib/fluent/plugin/parser_apache2.rb)\u306e\u307b\u307c\u30d1\u30af\u30ea\n- context\u306fJSON.parse\u3057\u3066record\u306b\u30bb\u30c3\u30c8\n- `/etc/td-agent/plugin/` \u306b\u914d\u7f6e\u3057\u3066\u3001td-agent\u3092\u8d77\u52d5\u3059\u308b\u3060\u3051\n\n#### \u53c2\u8003URL\n- [Fluentd Formatter \u30d7\u30e9\u30b0\u30a4\u30f3\u5165\u9580 - Qiita](http://qiita.com/sonots/items/d3c69e754814b8923e64)\n- [fluentd\u306e\u30ab\u30b9\u30bf\u30e0Parser Plugin\u3092\u4f5c\u3063\u3066\u307f\u308b - Qiita](http://qiita.com/toru-takahashi/items/b475aa4747e0e360f454)\n\n### ~~parser\u30d7\u30e9\u30b0\u30a4\u30f3\u3067\u3001json\u90e8\u5206\u3092\u30d1\u30fc\u30b9~~\n\n### record_transformer\u30d5\u30a3\u30eb\u30bf\u3067\u3001\u30ec\u30b3\u30fc\u30c9\u3092\u6574\u5f62\u3059\u308b\n```/etc/td-agent/td-agent.conf\n<filter example.stream>\n  @type record_transformer\n  renew_record true\n  enable_ruby true\n  <record>\n    level ${level}\n    message ${context[\"message\"]}\n    handler stream\n    created_at ${time.strftime('%Y-%m-%d %H:%M:%S')}\n  </record>\n</filter>\n```\n\n#### \u30dd\u30a4\u30f3\u30c8\n- json\u306b\u30d1\u30fc\u30b9\u3057\u3066\u3044\u308b\u306e\u3067\u3001`${context[\"message\"]}`\u306e\u3088\u3046\u306b\u3001json\u306e\u5404\u30d5\u30a3\u30fc\u30eb\u30c9\u3092\u53c2\u7167\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u308b\n\n### sqlite3\u306b\u30d5\u30a3\u30eb\u30bf\u3057\u305f\u30c7\u30fc\u30bf\u3092INSERT\u3059\u308b\n\u524d\u8ff0\u3057\u305f\u65b9\u6cd5\u3068\u540c\u3058\u306a\u306e\u3067\u3001\u8aac\u660e\u3092\u5272\u611b\u3057\u307e\u3059\u3002\n\n## \u7d50\u679c\nFluentHandler\u3068StreamHandler\u305d\u308c\u305e\u308c\u304b\u3089\u51fa\u529b\u3057\u305f\u30ed\u30b0\u304c\u3001\u3068\u3082\u306bsqlite3\u306b\u4fdd\u5b58\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n\n```bash\n$ sqlite3 /var/db/td-agent/example.sqlite3 \"select * from log;\"\n1|DEBUG|foo bar|fluent|2016-07-06 18:59:09\n2|DEBUG|foo bar|stream|2016-07-06 19:02:28\n```\n\n## imunew/monolog-fluentd-example\u3067\u52d5\u4f5c\u78ba\u8a8d\u3067\u304d\u307e\u3059\n[imunew/monolog-fluentd-example](https://github.com/imunew/monolog-fluentd-example)\u3092clone\u3057\u3001README\u3092\u898b\u306a\u304c\u3089\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u3059\u308c\u3070\u3001sandbox\u7684\u306b\u52d5\u4f5c\u78ba\u8a8d\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\n## \u304a\u308f\u308a\u306b\n- fluentd\u81ea\u4f53\u306f\u3001\u5927\u307e\u304b\u306b\u306f\u3001input\u3001output\u3001filter\u3067\u69cb\u6210\u3055\u308c\u3066\u3044\u3066\u3001\u8272\u3005\u306a\u7d44\u307f\u5408\u308f\u305b\u304c\u53ef\u80fd\u306b\u306a\u3063\u3066\u3044\u308b\n- \u30b7\u30f3\u30d7\u30eb\u304b\u3064\u758e\u7d50\u5408\u306a\u30a8\u30b3\u30b7\u30b9\u30c6\u30e0\u306a\u306e\u3067\u3001\u81ea\u5206\u306e\u7528\u9014\u306b\u3042\u3063\u305fplugin\u3092\u4f5c\u6210\u30fb\u516c\u958b\u3057\u3066\u3082\u3044\u3044\u304b\u3082\u3057\u308c\u306a\u3044\n- monolog\u306fsymfony\u4ee5\u5916\u3067\u3082\u4f7f\u308f\u308c\u3066\u3044\u308b\u3068\u601d\u3046\u306e\u3067\u3001parser_monolog\u306f\u9700\u8981\u3042\u308a\u305d\u3046\n  - [fluent-plugin-monolog\u3092rubygems.org\u306b\u516c\u958b\u3057\u307e\u3057\u305f - Qiita](http://qiita.com/imunew/items/fe6057692a73d1fdbea3) \uff082016-07-10\u8ffd\u8a18\uff09\n\n\n\n\n", "tags": ["monolog", "PHP", "fluentd"]}