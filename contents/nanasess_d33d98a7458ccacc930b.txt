{"tags": ["WordPress", "SQLServer", "SQLDatabase", "PHP", "ProjectNami"], "context": "Azure SQL Database/SQL Server \u3067 WordPress \u3092\u52d5\u4f5c\u3055\u305b\u308b\u30bd\u30ea\u30e5\u30fc\u30b7\u30e7\u30f3\u306b ProjectNami \u304c\u3042\u308a\u307e\u3059\u3002\n\u6a19\u6e96\u306e\u72b6\u614b\u3067\u65e5\u672c\u8a9e\u3092\u6271\u3046\u306b\u306f\u3001\u30b5\u30fc\u30d0\u30fc\u306e\u7167\u5408\u9806\u5e8f\u3092 Japanese_CI_AS \u306b\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\u3057\u304b\u3057\u3001\u3053\u306e\u72b6\u614b\u3067\u3059\u3068\u3001cp932 \u306e\u6587\u5b57\u96c6\u5408\u306e\u7bc4\u56f2\u5916\u306e\u6587\u5b57\u5217\u306f\u6587\u5b57\u5316\u3051\u3057\u3066\u3057\u307e\u3044\u307e\u3059\u3002\n\u30b9\u30de\u30fc\u30c8\u30d5\u30a9\u30f3\u3067\u3088\u304f\u4f7f\u7528\u3055\u308c\u308b\u7d75\u6587\u5b57\u304c\u6587\u5b57\u5316\u3051\u3057\u3066\u3057\u307e\u3046\u305f\u3081\u3001\u5df7\u3067\u306f\u3001\u5bff\u53f8\u30d3\u30fc\u30eb\u554f\u984c \u3068\u547c\u3070\u308c\u3066\u3044\u307e\u3059\u3002\u3053\u308c\u9632\u3050\u306b\u306f\u3001 N\u30d7\u30ec\u30d5\u30a3\u30c3\u30af\u30b9\u3092\u4ed8\u4e0e\u3059\u308b \u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u4fee\u6b63\u3067\u3001 UTF-8 \u3067\u306e\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u63a5\u7d9a\u304c\u6709\u52b9\u306b\u306a\u308a\u3001\u7167\u5408\u9806\u5e8f\u3092 SQL_Latin1_General_CP1_CI_AS \u3068\u3057\u3066\u3082\u6587\u5b57\u5316\u3051\u305b\u305a\u306b\u6295\u7a3f\u3067\u304d\u307e\u3059\u3002\n\u3082\u3061\u308d\u3093\u3001\u7d75\u6587\u5b57\u306a\u3069\u3001\u7279\u6b8a\u306a\u6587\u5b57\u5217\u306e\u4f7f\u7528\u3082\u53ef\u80fd\u3067\u3059\u3002\n\nutf-8.patch\ndiff --git a/wp-config.php b/wp-config.php\nindex a1a9449..7382888 100644\n--- a/wp-config.php\n+++ b/wp-config.php\n@@ -36,7 +36,8 @@ define('DB_HOST', ( getenv('ProjectNami.DBHost') ? getenv('ProjectNami.DBHost')\n define('DB_CHARSET', 'utf8');\n\n /** The Database Collate type. Don't change this if in doubt. */\n-define('DB_COLLATE', '');\n+define('DB_COLLATE', 'SQL_Latin1_General_CP1_CI_AS');\n+putenv('ProjectNami.UTF8=1');\n\n /**#@+\n  * Authentication Unique Keys and Salts.\ndiff --git a/wp-includes/wp-db.php b/wp-includes/wp-db.php\nindex 409d4a8..afa56ff 100644\n--- a/wp-includes/wp-db.php\n+++ b/wp-includes/wp-db.php\n@@ -1290,7 +1290,7 @@ class wpdb {\n                $query = str_replace( \"'%s'\", '%s', $query ); // in case someone mistakenly already singlequoted it\n                $query = str_replace( '\"%s\"', '%s', $query ); // doublequote unquoting\n                $query = preg_replace( '|(?<!%)%f|' , '%F', $query ); // Force floats to be locale unaware\n-               $query = preg_replace( '|(?<!%)%s|', \"'%s'\", $query ); // quote the strings, avoiding escaped strings like %%s\n+               $query = preg_replace( '|(?<!%)%s|', \"N'%s'\", $query ); // quote the strings, avoiding escaped strings like %%s\n                array_walk( $args, array( $this, 'escape_by_ref' ) );\n                return @vsprintf( $query, $args );\n        }\n\n\n\nSee Also\n\nAzure x EC-CUBE + WordPress + SQL Database \u3067\u6700\u5f37\u306e EC CMS \u3092\u69cb\u7bc9\u3057\u3088\u3046\nhttps://blogs.technet.microsoft.com/jpitpro/2016/01/27/project-nami-azure-sql-databasesql-server-wordpress/\n\nAzure SQL Database/SQL Server \u3067 WordPress \u3092\u52d5\u4f5c\u3055\u305b\u308b\u30bd\u30ea\u30e5\u30fc\u30b7\u30e7\u30f3\u306b [ProjectNami](http://projectnami.org) \u304c\u3042\u308a\u307e\u3059\u3002\n\n\u6a19\u6e96\u306e\u72b6\u614b\u3067\u65e5\u672c\u8a9e\u3092\u6271\u3046\u306b\u306f\u3001\u30b5\u30fc\u30d0\u30fc\u306e\u7167\u5408\u9806\u5e8f\u3092 `Japanese_CI_AS` \u306b\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\u3057\u304b\u3057\u3001\u3053\u306e\u72b6\u614b\u3067\u3059\u3068\u3001cp932 \u306e\u6587\u5b57\u96c6\u5408\u306e\u7bc4\u56f2\u5916\u306e\u6587\u5b57\u5217\u306f\u6587\u5b57\u5316\u3051\u3057\u3066\u3057\u307e\u3044\u307e\u3059\u3002\n\n\u30b9\u30de\u30fc\u30c8\u30d5\u30a9\u30f3\u3067\u3088\u304f\u4f7f\u7528\u3055\u308c\u308b\u7d75\u6587\u5b57\u304c\u6587\u5b57\u5316\u3051\u3057\u3066\u3057\u307e\u3046\u305f\u3081\u3001\u5df7\u3067\u306f\u3001**\u5bff\u53f8\u30d3\u30fc\u30eb\u554f\u984c** \u3068\u547c\u3070\u308c\u3066\u3044\u307e\u3059\u3002\u3053\u308c\u9632\u3050\u306b\u306f\u3001 [N\u30d7\u30ec\u30d5\u30a3\u30c3\u30af\u30b9\u3092\u4ed8\u4e0e\u3059\u308b](https://blogs.msdn.microsoft.com/dsazurejp/2012/06/28/sql-azure-unicodencharnvarchar/) \u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\n\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u4fee\u6b63\u3067\u3001 UTF-8 \u3067\u306e\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u63a5\u7d9a\u304c\u6709\u52b9\u306b\u306a\u308a\u3001\u7167\u5408\u9806\u5e8f\u3092 `SQL_Latin1_General_CP1_CI_AS` \u3068\u3057\u3066\u3082\u6587\u5b57\u5316\u3051\u305b\u305a\u306b\u6295\u7a3f\u3067\u304d\u307e\u3059\u3002\n\u3082\u3061\u308d\u3093\u3001\u7d75\u6587\u5b57\u306a\u3069\u3001\u7279\u6b8a\u306a\u6587\u5b57\u5217\u306e\u4f7f\u7528\u3082\u53ef\u80fd\u3067\u3059\u3002\n\n```utf-8.patch\ndiff --git a/wp-config.php b/wp-config.php\nindex a1a9449..7382888 100644\n--- a/wp-config.php\n+++ b/wp-config.php\n@@ -36,7 +36,8 @@ define('DB_HOST', ( getenv('ProjectNami.DBHost') ? getenv('ProjectNami.DBHost')\n define('DB_CHARSET', 'utf8');\n\n /** The Database Collate type. Don't change this if in doubt. */\n-define('DB_COLLATE', '');\n+define('DB_COLLATE', 'SQL_Latin1_General_CP1_CI_AS');\n+putenv('ProjectNami.UTF8=1');\n\n /**#@+\n  * Authentication Unique Keys and Salts.\ndiff --git a/wp-includes/wp-db.php b/wp-includes/wp-db.php\nindex 409d4a8..afa56ff 100644\n--- a/wp-includes/wp-db.php\n+++ b/wp-includes/wp-db.php\n@@ -1290,7 +1290,7 @@ class wpdb {\n                $query = str_replace( \"'%s'\", '%s', $query ); // in case someone mistakenly already singlequoted it\n                $query = str_replace( '\"%s\"', '%s', $query ); // doublequote unquoting\n                $query = preg_replace( '|(?<!%)%f|' , '%F', $query ); // Force floats to be locale unaware\n-               $query = preg_replace( '|(?<!%)%s|', \"'%s'\", $query ); // quote the strings, avoiding escaped strings like %%s\n+               $query = preg_replace( '|(?<!%)%s|', \"N'%s'\", $query ); // quote the strings, avoiding escaped strings like %%s\n                array_walk( $args, array( $this, 'escape_by_ref' ) );\n                return @vsprintf( $query, $args );\n        }\n```\n\n### See Also\n\n- [Azure x EC-CUBE + WordPress + SQL Database \u3067\u6700\u5f37\u306e EC CMS \u3092\u69cb\u7bc9\u3057\u3088\u3046](http://qiita.com/nanasess/items/5f7ff1a3f030f85032cf)\n- https://blogs.technet.microsoft.com/jpitpro/2016/01/27/project-nami-azure-sql-databasesql-server-wordpress/\n"}