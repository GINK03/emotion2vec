{"context": " More than 1 year has passed since last update.\u305d\u3046\u3044\u3046\u6a5f\u80fd\u304c\u3042\u308b\u6c17\u3082\u3057\u307e\u3059\u304c\u3001bash \u3067\u66f8\u3051\u305f\u306e\u3067\u6652\u3057\u3066\u307f\u307e\u3059\u3002\ncron \u306a\u3069\u3067\u65e5\u6b21\u3067\u52d5\u304b\u3059\u3053\u3068\u3092\u60f3\u5b9a\u3057\u3066\u3044\u307e\u3059\u3002\n\u3053\u306e\u5185\u5bb9\u3060\u3068\u300130/15/7\u65e5\u524d\u306b\u901a\u77e5\u30e1\u30fc\u30eb\u3092\u9001\u4fe1\u3059\u308b\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002\n\nri_expire_checker.sh\n#!/bin/bash\n\n# Reserved Instance expire checker\n\nfrom_address=\"_from_mail_address_\"\nto_address=\"_to_mail_address_\"\n\nnotification()\n{\n    MAILBODY=\"\"\"\nReservedInstances will expire ${d} days after.\nplease consider buying.\n\nAZ : ${AZ}\nInstanceType : ${INSTANCE_TYPE}\nInstanceCount : ${INSTANCE_COUNT}\n\"\"\"\n\n    echo \"${MAILBODY}\" | mail -s \"ReservedInstances Notification\" -r ${from_address} ${to_address}\n\n}\n\ncheck_ri()\n{\n    ACTIVE_RIS=$(aws --region ap-northeast-1 ec2 describe-reserved-instances \\\n        --query 'ReservedInstances[?State!==\\`Retired\\`].[End,AvailabilityZone,InstanceType,InstanceCount,State]' \\\n        --output text)\n\n    echo \"${ACTIVE_RIS}\" | while read line\n    do\n        AZ=$(echo \"${line}\" | awk {'print $2'})\n        INSTANCE_TYPE=`echo \"${line}\" | awk {'print $3'}`\n        INSTANCE_COUNT=`echo \"${line}\" | awk {'print $4'}`\n\n        TODAY=$(date +'%Y%m%d')\n        END_DATE=$(echo \"${line}\" | awk {'print $1'} | cut -d T -f 1)\n        CHECK_DATE_1=`date -d \"${END_DATE} - 30 days\" +'%Y%m%d'`\n        CHECK_DATE_2=`date -d \"${END_DATE} - 15 days\" +'%Y%m%d'`\n        CHECK_DATE_3=`date -d \"${END_DATE} - 7 days\" +'%Y%m%d'`\n\n        if [ ${TODAY} -eq ${CHECK_DATE_1} ]; then\n            d=\"30\"\n            notification\n        elif [ ${TODAY} -eq ${CHECK_DATE_2} ]; then\n            d=\"15\"\n            notification\n        elif [ ${TODAY} -eq ${CHECK_DATE_3} ]; then\n            d=\"7\"\n            notification\n        fi\n    done\n}\n\ncheck_ri && exit 0\n\n\n\u5143\u8a18\u4e8b\u306f\u3053\u3061\u3089\n\u305d\u3046\u3044\u3046\u6a5f\u80fd\u304c\u3042\u308b\u6c17\u3082\u3057\u307e\u3059\u304c\u3001bash \u3067\u66f8\u3051\u305f\u306e\u3067\u6652\u3057\u3066\u307f\u307e\u3059\u3002\n*cron* \u306a\u3069\u3067\u65e5\u6b21\u3067\u52d5\u304b\u3059\u3053\u3068\u3092\u60f3\u5b9a\u3057\u3066\u3044\u307e\u3059\u3002\n\n\u3053\u306e\u5185\u5bb9\u3060\u3068\u300130/15/7\u65e5\u524d\u306b\u901a\u77e5\u30e1\u30fc\u30eb\u3092\u9001\u4fe1\u3059\u308b\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002\n\n```sh:ri_expire_checker.sh\n#!/bin/bash\n\n# Reserved Instance expire checker\n\nfrom_address=\"_from_mail_address_\"\nto_address=\"_to_mail_address_\"\n\nnotification()\n{\n    MAILBODY=\"\"\"\nReservedInstances will expire ${d} days after.\nplease consider buying.\n\nAZ : ${AZ}\nInstanceType : ${INSTANCE_TYPE}\nInstanceCount : ${INSTANCE_COUNT}\n\"\"\"\n\n    echo \"${MAILBODY}\" | mail -s \"ReservedInstances Notification\" -r ${from_address} ${to_address}\n\n}\n\ncheck_ri()\n{\n    ACTIVE_RIS=$(aws --region ap-northeast-1 ec2 describe-reserved-instances \\\n        --query 'ReservedInstances[?State!==\\`Retired\\`].[End,AvailabilityZone,InstanceType,InstanceCount,State]' \\\n        --output text)\n\n    echo \"${ACTIVE_RIS}\" | while read line\n    do\n        AZ=$(echo \"${line}\" | awk {'print $2'})\n        INSTANCE_TYPE=`echo \"${line}\" | awk {'print $3'}`\n        INSTANCE_COUNT=`echo \"${line}\" | awk {'print $4'}`\n\n        TODAY=$(date +'%Y%m%d')\n        END_DATE=$(echo \"${line}\" | awk {'print $1'} | cut -d T -f 1)\n        CHECK_DATE_1=`date -d \"${END_DATE} - 30 days\" +'%Y%m%d'`\n        CHECK_DATE_2=`date -d \"${END_DATE} - 15 days\" +'%Y%m%d'`\n        CHECK_DATE_3=`date -d \"${END_DATE} - 7 days\" +'%Y%m%d'`\n\n        if [ ${TODAY} -eq ${CHECK_DATE_1} ]; then\n            d=\"30\"\n            notification\n        elif [ ${TODAY} -eq ${CHECK_DATE_2} ]; then\n            d=\"15\"\n            notification\n        elif [ ${TODAY} -eq ${CHECK_DATE_3} ]; then\n            d=\"7\"\n            notification\n        fi\n    done\n}\n\ncheck_ri && exit 0\n```\n\n\n\u5143\u8a18\u4e8b\u306f[\u3053\u3061\u3089](http://rriifftt.hatenablog.com/entry/2015/04/09/115925)\n", "tags": ["aws-cli"]}