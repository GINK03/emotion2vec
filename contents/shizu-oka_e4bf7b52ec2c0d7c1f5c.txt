{"context": "jq\u3067\u904a\u3093\u3067\u3044\u305f\u3089\u3001\u306a\u3093\u3068\u306a\u304f\u601d\u3044\u3064\u3044\u305f\u306e\u3067\u6295\u7a3f\u3002\n\n\u7528\u610f\u3059\u308b\u3082\u306e\nCentOS release 6.7\n\njq\ntop\u30b3\u30de\u30f3\u30c9\n\n\ntop + jq\ntop\u306e\u30d0\u30c3\u30c1\u30e2\u30fc\u30c9\u3068jq\u3067\u3001top\u306e\u51fa\u529b\u3092json\u5f62\u5f0f\u306b\u5909\u66f4\u3002\n$ top -b -n 1 | head -10 | tee top.txt\ntop - 01:58:31 up  2:47,  4 users,  load average: 0.00, 0.02, 0.00\nTasks:  99 total,   1 running,  98 sleeping,   0 stopped,   0 zombie\nCpu(s):  2.0%us,  0.9%sy,  0.0%ni, 96.4%id,  0.5%wa,  0.3%hi,  0.0%si,  0.0%st\nMem:    502040k total,   379992k used,   122048k free,    44600k buffers\nSwap:  1015804k total,        0k used,  1015804k free,   258188k cached\n\n  PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND\n    1 root      20   0 19232 1376 1100 S  0.0  0.3   0:00.41 init\n    2 root      20   0     0    0    0 S  0.0  0.0   0:00.00 kthreadd\n    3 root      RT   0     0    0    0 S  0.0  0.0   0:00.00 migration/0\n\n# jq\u3067json\u306b\u5909\u63db\n# \u30e1\u30e2\u30ea\u306e\u4f7f\u7528\u7387\u304c\u591a\u3044\u3084\u3064\u4e0a\u4f4d10\u4ef6\u3092\u53d6\u5f97\n$ cat top.txt | jq -rcsR '[ gsub(\"\\n$\";\"\") | splits(\"\\n\") | sub(\" +$\";\"\") | sub(\"^ +\";\"\")] | .[0:5] as $titles | .[6:] as $data | {\"sys\": [$titles | .[] | split(\",\") | [.[] | sub(\"^ +\";\"\")]]} as $sys |  [$data[0] | splits(\" +\") | sub(\"%\";\"\") | sub(\"\\\\+\";\"\")] as $row_keys | $data[1:] | [.[] | [splits(\" +\")]] | {\"task\":[.[] | [. as $r | range($row_keys|length) | {\"key\": $row_keys[.], \"value\": $r[.]}] | from_entries] | sort_by(.MEM) | reverse | .[:10]} as $task | $sys * $task'\n{\"sys\":[[\"top - 01:58:31 up  2:47\",\"4 users\",\"load average: 0.00\",\"0.02\",\"0.00\"],[\"Tasks:  99 total\",\"1 running\",\"98 sleeping\",\"0 stopped\",\"0 zombie\"],[\"Cpu(s):  2.0%us\",\"0.9%sy\",\"0.0%ni\",\"96.4%id\",\"0.5%wa\",\"0.3%hi\",\"0.0%si\",\"0.0%st\"],[\"Mem:    502040k total\",\"379992k used\",\"122048k free\",\"44600k buffers\"],[\"Swap:  1015804k total\",\"0k used\",\"1015804k free\",\"258188k cached\"]],\"task\":[{\"PID\":\"1\",\"USER\":\"root\",\"PR\":\"20\",\"NI\":\"0\",\"VIRT\":\"19232\",\"RES\":\"1376\",\"SHR\":\"1100\",\"S\":\"S\",\"CPU\":\"0.0\",\"MEM\":\"0.3\",\"TIME\":\"0:00.41\",\"COMMAND\":\"init\"},{\"PID\":\"3\",\"USER\":\"root\",\"PR\":\"RT\",\"NI\":\"0\",\"VIRT\":\"0\",\"RES\":\"0\",\"SHR\":\"0\",\"S\":\"S\",\"CPU\":\"0.0\",\"MEM\":\"0.0\",\"TIME\":\"0:00.00\",\"COMMAND\":\"migration/0\"},{\"PID\":\"2\",\"USER\":\"root\",\"PR\":\"20\",\"NI\":\"0\",\"VIRT\":\"0\",\"RES\":\"0\",\"SHR\":\"0\",\"S\":\"S\",\"CPU\":\"0.0\",\"MEM\":\"0.0\",\"TIME\":\"0:00.00\",\"COMMAND\":\"kthreadd\"}]}\n\n# 5\u79d2\u3054\u3068\u306btop+jq\n$ while true ; do top -b -n 1 | jq -rcsR '[ gsub(\"\\n$\";\"\") | splits(\"\\n\") | sub(\" +$\";\"\") | sub(\"^ +\";\"\")] | .[0:5] as $titles | .[6:] as $data | {\"sys\": [$titles | .[] | split(\",\") | [.[] | sub(\"^ +\";\"\")]]} as $sys |  [$data[0] | splits(\" +\") | sub(\"%\";\"\") | sub(\"\\\\+\";\"\")] as $row_keys | $data[1:] | [.[] | [splits(\" +\")]] | {\"task\":[.[] | [. as $r | range($row_keys|length) | {\"key\": $row_keys[.], \"value\": $r[.]}] | from_entries] | sort_by(.MEM) | reverse | .[:10]} as $task | $sys * $task'; sleep 5; done\n\n\ntop\u3068jq\u3067\u30b5\u30fc\u30d0\u30fc\u306e\u30d7\u30ed\u30bb\u30b9\u304cjson\u3067\u53d6\u5f97\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3057\u305f\u3002\n\n\u304a\u307e\u3051\n\u30d6\u30e9\u30a6\u30b6\u4e0a\u3067\u30ea\u30a2\u30eb\u30bf\u30a4\u30e0\u306b\u78ba\u8a8d\u3057\u305f\u3044\u306e\u3067\u3001websocket\u306e\u30b5\u30fc\u30d0\u30fc\u3068\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u3092\u4f5c\u6210\u3002\n\nCargo.toml\n[dependencies]\nws = \"*\"\n\n[[bin]]\nname = \"ws-server\"\npath = \"src/main.rs\"\n\n[[bin]]\nname = \"ws-client\"\npath = \"src/bin/client.rs\"\n\n\n\n\u30b5\u30fc\u30d0\u30fc\n\u30e1\u30c3\u30bb\u30fc\u30b8\u304c\u6765\u305f\u3089\u30d6\u30ed\u30fc\u30c9\u30ad\u30e3\u30b9\u30c8\u3059\u308b\u3060\u3051\u3002\n\nsrc/main.rs\nextern crate ws;\n\nfn main() {\n    ws::listen(\"<\u3055\u30fc\u3070\u30fc\u306eIP>:<\u307d\u30fc\u3068>\", |out| {\n        move |msg| { out.broadcast(msg) }\n    }).unwrap()\n}\n\n\n\n\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\n\u6a19\u6e96\u5165\u529b\u304b\u3089\u6301\u3063\u3066\u304d\u3066\u30b5\u30fc\u30d0\u30fc\u306b\u9001\u4fe1\u3059\u308b\u3060\u3051\u3002\n\nsrc/bin/client.rs\nextern crate ws;\n\nuse std::io::Read;\n\nfn main() {\n    ws::connect(\"<\u3055\u30fc\u3070\u30fc\u306eIP>:<\u307d\u30fc\u3068>\", |out| {\n        let mut buf = String::new();\n        let _ = std::io::stdin().read_to_string(&mut buf).unwrap();\n        out.send(buf).unwrap();\n        move |_| { out.close(ws::CloseCode::Normal) }\n    }).unwrap();\n}\n\n\n\n\u30d3\u30eb\u30c9\u3057\u3066\u5b9f\u884c\n$ cargo build --release\n\n# \u30b5\u30fc\u30d0\u30fc\u8d77\u52d5\n$ ./target/release/ws-server\n\n# \u5225\u306e\u30bf\u30fc\u30df\u30ca\u30eb\u3067\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u3050\u308b\u3050\u308b\n$ while true; do top -b -n 1 | jq -rcsR '[ gsub(\"\\n$\";\"\") | splits(\"\\n\") | sub(\" +$\";\"\") | sub(\"^ +\";\"\")] | .[0:5] as $titles | .[6:] as $data | {\"sys\": [$titles | .[] | split(\",\") | [.[] | sub(\"^ +\";\"\")]]} as $sys |  [$data[0] | splits(\" +\") | sub(\"%\";\"\") | sub(\"\\\\+\";\"\")] as $row_keys | $data[1:] | [.[] | [splits(\" +\")]] | {\"task\":[.[] | [. as $r | range($row_keys|length) | {\"key\": $row_keys[.], \"value\": $r[.]}] | from_entries] | sort_by(.MEM) | reverse | .[:10]} as $task | $sys * $task' | ./target/release/ws-client ; sleep 10 ; done\n\n\n10\u79d2\u3054\u3068\u306btop\u306ejson\u304c\u9001\u4fe1\u3055\u308c\u3066\u304f\u308b\u306e\u3067\u3001JS\u306eWebSocket(\"ws://<\u30b5\u30fc\u30d0\u30fc\u306eIP>:<\u30dd\u30fc\u30c8>/\")\u3067\n\u3054\u306b\u3087\u3054\u306b\u3087\u3057\u305f\u3089\u3044\u3044\u3068\u601d\u3044\u307e\u3059\u3002\njq\u3067\u904a\u3093\u3067\u3044\u305f\u3089\u3001\u306a\u3093\u3068\u306a\u304f\u601d\u3044\u3064\u3044\u305f\u306e\u3067\u6295\u7a3f\u3002\n\n# \u7528\u610f\u3059\u308b\u3082\u306e\n\nCentOS release 6.7\n\n- [jq](https://stedolan.github.io/jq/)\n- top\u30b3\u30de\u30f3\u30c9\n\n# top + jq\n\ntop\u306e\u30d0\u30c3\u30c1\u30e2\u30fc\u30c9\u3068jq\u3067\u3001top\u306e\u51fa\u529b\u3092json\u5f62\u5f0f\u306b\u5909\u66f4\u3002\n\n```bash\n$ top -b -n 1 | head -10 | tee top.txt\ntop - 01:58:31 up  2:47,  4 users,  load average: 0.00, 0.02, 0.00\nTasks:  99 total,   1 running,  98 sleeping,   0 stopped,   0 zombie\nCpu(s):  2.0%us,  0.9%sy,  0.0%ni, 96.4%id,  0.5%wa,  0.3%hi,  0.0%si,  0.0%st\nMem:    502040k total,   379992k used,   122048k free,    44600k buffers\nSwap:  1015804k total,        0k used,  1015804k free,   258188k cached\n\n  PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND\n    1 root      20   0 19232 1376 1100 S  0.0  0.3   0:00.41 init\n    2 root      20   0     0    0    0 S  0.0  0.0   0:00.00 kthreadd\n    3 root      RT   0     0    0    0 S  0.0  0.0   0:00.00 migration/0\n\n# jq\u3067json\u306b\u5909\u63db\n# \u30e1\u30e2\u30ea\u306e\u4f7f\u7528\u7387\u304c\u591a\u3044\u3084\u3064\u4e0a\u4f4d10\u4ef6\u3092\u53d6\u5f97\n$ cat top.txt | jq -rcsR '[ gsub(\"\\n$\";\"\") | splits(\"\\n\") | sub(\" +$\";\"\") | sub(\"^ +\";\"\")] | .[0:5] as $titles | .[6:] as $data | {\"sys\": [$titles | .[] | split(\",\") | [.[] | sub(\"^ +\";\"\")]]} as $sys |  [$data[0] | splits(\" +\") | sub(\"%\";\"\") | sub(\"\\\\+\";\"\")] as $row_keys | $data[1:] | [.[] | [splits(\" +\")]] | {\"task\":[.[] | [. as $r | range($row_keys|length) | {\"key\": $row_keys[.], \"value\": $r[.]}] | from_entries] | sort_by(.MEM) | reverse | .[:10]} as $task | $sys * $task'\n{\"sys\":[[\"top - 01:58:31 up  2:47\",\"4 users\",\"load average: 0.00\",\"0.02\",\"0.00\"],[\"Tasks:  99 total\",\"1 running\",\"98 sleeping\",\"0 stopped\",\"0 zombie\"],[\"Cpu(s):  2.0%us\",\"0.9%sy\",\"0.0%ni\",\"96.4%id\",\"0.5%wa\",\"0.3%hi\",\"0.0%si\",\"0.0%st\"],[\"Mem:    502040k total\",\"379992k used\",\"122048k free\",\"44600k buffers\"],[\"Swap:  1015804k total\",\"0k used\",\"1015804k free\",\"258188k cached\"]],\"task\":[{\"PID\":\"1\",\"USER\":\"root\",\"PR\":\"20\",\"NI\":\"0\",\"VIRT\":\"19232\",\"RES\":\"1376\",\"SHR\":\"1100\",\"S\":\"S\",\"CPU\":\"0.0\",\"MEM\":\"0.3\",\"TIME\":\"0:00.41\",\"COMMAND\":\"init\"},{\"PID\":\"3\",\"USER\":\"root\",\"PR\":\"RT\",\"NI\":\"0\",\"VIRT\":\"0\",\"RES\":\"0\",\"SHR\":\"0\",\"S\":\"S\",\"CPU\":\"0.0\",\"MEM\":\"0.0\",\"TIME\":\"0:00.00\",\"COMMAND\":\"migration/0\"},{\"PID\":\"2\",\"USER\":\"root\",\"PR\":\"20\",\"NI\":\"0\",\"VIRT\":\"0\",\"RES\":\"0\",\"SHR\":\"0\",\"S\":\"S\",\"CPU\":\"0.0\",\"MEM\":\"0.0\",\"TIME\":\"0:00.00\",\"COMMAND\":\"kthreadd\"}]}\n\n# 5\u79d2\u3054\u3068\u306btop+jq\n$ while true ; do top -b -n 1 | jq -rcsR '[ gsub(\"\\n$\";\"\") | splits(\"\\n\") | sub(\" +$\";\"\") | sub(\"^ +\";\"\")] | .[0:5] as $titles | .[6:] as $data | {\"sys\": [$titles | .[] | split(\",\") | [.[] | sub(\"^ +\";\"\")]]} as $sys |  [$data[0] | splits(\" +\") | sub(\"%\";\"\") | sub(\"\\\\+\";\"\")] as $row_keys | $data[1:] | [.[] | [splits(\" +\")]] | {\"task\":[.[] | [. as $r | range($row_keys|length) | {\"key\": $row_keys[.], \"value\": $r[.]}] | from_entries] | sort_by(.MEM) | reverse | .[:10]} as $task | $sys * $task'; sleep 5; done\n\n```\n\ntop\u3068jq\u3067\u30b5\u30fc\u30d0\u30fc\u306e\u30d7\u30ed\u30bb\u30b9\u304cjson\u3067\u53d6\u5f97\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3057\u305f\u3002\n\n# \u304a\u307e\u3051\n\n\u30d6\u30e9\u30a6\u30b6\u4e0a\u3067\u30ea\u30a2\u30eb\u30bf\u30a4\u30e0\u306b\u78ba\u8a8d\u3057\u305f\u3044\u306e\u3067\u3001websocket\u306e\u30b5\u30fc\u30d0\u30fc\u3068\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u3092\u4f5c\u6210\u3002\n\n```toml:Cargo.toml\n[dependencies]\nws = \"*\"\n\n[[bin]]\nname = \"ws-server\"\npath = \"src/main.rs\"\n\n[[bin]]\nname = \"ws-client\"\npath = \"src/bin/client.rs\"\n```\n\n## \u30b5\u30fc\u30d0\u30fc\n\u30e1\u30c3\u30bb\u30fc\u30b8\u304c\u6765\u305f\u3089\u30d6\u30ed\u30fc\u30c9\u30ad\u30e3\u30b9\u30c8\u3059\u308b\u3060\u3051\u3002\n\n```rust:src/main.rs\nextern crate ws;\n\nfn main() {\n    ws::listen(\"<\u3055\u30fc\u3070\u30fc\u306eIP>:<\u307d\u30fc\u3068>\", |out| {\n        move |msg| { out.broadcast(msg) }\n    }).unwrap()\n}\n```\n\n## \u30af\u30e9\u30a4\u30a2\u30f3\u30c8\n\u6a19\u6e96\u5165\u529b\u304b\u3089\u6301\u3063\u3066\u304d\u3066\u30b5\u30fc\u30d0\u30fc\u306b\u9001\u4fe1\u3059\u308b\u3060\u3051\u3002\n\n```rust:src/bin/client.rs\nextern crate ws;\n\nuse std::io::Read;\n\nfn main() {\n    ws::connect(\"<\u3055\u30fc\u3070\u30fc\u306eIP>:<\u307d\u30fc\u3068>\", |out| {\n        let mut buf = String::new();\n        let _ = std::io::stdin().read_to_string(&mut buf).unwrap();\n        out.send(buf).unwrap();\n        move |_| { out.close(ws::CloseCode::Normal) }\n    }).unwrap();\n}\n```\n\n## \u30d3\u30eb\u30c9\u3057\u3066\u5b9f\u884c\n\n```bash\n$ cargo build --release\n\n# \u30b5\u30fc\u30d0\u30fc\u8d77\u52d5\n$ ./target/release/ws-server\n\n# \u5225\u306e\u30bf\u30fc\u30df\u30ca\u30eb\u3067\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u3050\u308b\u3050\u308b\n$ while true; do top -b -n 1 | jq -rcsR '[ gsub(\"\\n$\";\"\") | splits(\"\\n\") | sub(\" +$\";\"\") | sub(\"^ +\";\"\")] | .[0:5] as $titles | .[6:] as $data | {\"sys\": [$titles | .[] | split(\",\") | [.[] | sub(\"^ +\";\"\")]]} as $sys |  [$data[0] | splits(\" +\") | sub(\"%\";\"\") | sub(\"\\\\+\";\"\")] as $row_keys | $data[1:] | [.[] | [splits(\" +\")]] | {\"task\":[.[] | [. as $r | range($row_keys|length) | {\"key\": $row_keys[.], \"value\": $r[.]}] | from_entries] | sort_by(.MEM) | reverse | .[:10]} as $task | $sys * $task' | ./target/release/ws-client ; sleep 10 ; done\n\n```\n\n10\u79d2\u3054\u3068\u306btop\u306ejson\u304c\u9001\u4fe1\u3055\u308c\u3066\u304f\u308b\u306e\u3067\u3001JS\u306e`WebSocket(\"ws://<\u30b5\u30fc\u30d0\u30fc\u306eIP>:<\u30dd\u30fc\u30c8>/\")`\u3067\n\u3054\u306b\u3087\u3054\u306b\u3087\u3057\u305f\u3089\u3044\u3044\u3068\u601d\u3044\u307e\u3059\u3002\n", "tags": ["jq", "rust"]}