{"context": " More than 1 year has passed since last update.pdist2\u306f\uff0c\u30c7\u30fc\u30bf\u9593\u306e\u30da\u30a2\u30ef\u30a4\u30ba\u8ddd\u96e2\u3092\u8a08\u7b97\u3057\u3066\u304f\u308c\u308b\u4fbf\u5229\u95a2\u6570\u3067\u3059\uff0e\u3067\u3059\u304c\uff0cMatlab\u30d7\u30ea\u30bb\u30c3\u30c8\u306epdist2\u306f\u30de\u30eb\u30c1\u30b3\u30a2\u3067\u306e\u4e26\u5217\u5316\u306b\u5bfe\u5fdc\u3057\u3066\u306a\u3044\u306e\u3067\uff0c\u30c7\u30fc\u30bf\u30b5\u30a4\u30ba\u304c\u3067\u304b\u304f\u306a\u308b\u3068\u8a08\u7b97\u6642\u9593\u304c\u304b\u304b\u308b\u3068\u3044\u3046\u554f\u984c\u304c\u3042\u308a\u307e\u3059\uff0e\n\u305d\u3053\u3067\u672c\u8a18\u4e8b\u3067\u306f\uff0c\u30c7\u30fc\u30bf\u4e26\u5217\u5316\u3092\u3059\u308b\u3053\u3068\u3067\u8a08\u7b97\u306e\u9ad8\u901f\u5316\u3092\u76ee\u6307\u3057\u307e\u3059\uff0estatistic toolbox (pdist2), parallel computing toolbox (parfor) \u304c\u5fc5\u8981\u3067\u3059\u306e\u3067\u3054\u6ce8\u610f\u304f\u3060\u3055\u3044\uff0e\n\npdist2_parallel\nfunction [ dmat ] = pdist2_parallel( X, Y, block_size, fun )\n%PDIST2_PARALLEL parallelized version of pdist2\n\nif(nargin<4)\n    fun='euclidean'; % \u3053\u306e\u8fba\u306f\u304a\u597d\u307f\u3067\nend\n\n% decompose similarity matrix\nstep_x=unique([1:block_size:size(X,1),size(X,1)+1])';\nstep_x=[step_x(1:end-1),step_x(2:end)-1];\nnsteps_x=size(step_x,1);\nX_sub=cell(nsteps_x,1);\nfor i=1:nsteps_x\n    X_sub{i}=X(step_x(i,1):step_x(i,2),:); % block_size\u306b\u57fa\u3065\u3044\u3066\u30c7\u30fc\u30bf\u3092\u5206\u5272\nend\nstep_y=unique([1:block_size:size(Y,1),size(Y,1)+1])';\nstep_y=[step_y(1:end-1),step_y(2:end)-1];\nnsteps_y=size(step_y,1);\nY_sub=cell(nsteps_y,1);\nfor i=1:nsteps_y\n    Y_sub{i}=Y(step_y(i,1):step_y(i,2),:); % block_size\u306b\u57fa\u3065\u3044\u3066\u30c7\u30fc\u30bf\u3092\u5206\u5272\nend\n\ndmat=cell(nsteps_x, nsteps_y);\nparfor i=1:nsteps_x*nsteps_y % \u30c7\u30fc\u30bf\u4e26\u5217\u5316\u3057\u307e\u3059\n    i1=mod(i-1,nsteps_x)+1;\n    i2=(i-mod(i-1,nsteps_x)-1)/nsteps_x+1;\n    dmat{i}=pdist2(X_sub{i1},Y_sub{i2}, fun);\nend\ndmat=cell2mat(dmat); % \u7d50\u679c\u3092\u7d50\u5408\u3057\u307e\u3059\n\nend\n\n\n\n\u5b9f\u9a13\n\u5b9f\u9a13\u74b0\u5883\u306f\nMac OS X (10.7.5)\nProcessor 2 x 2.66 GHz 6-Core Intel Xeon\nMemory 32GB\nMatlab2012b\n12\u500b\u306eworker\u3067\u5b9f\u9a13\u3092\u884c\u3044\u307e\u3059\uff08\u3064\u307e\u308a\u6700\u592712\u4e26\u5217\uff09\uff0e\n\n\u307e\u305a\u306f\u5206\u5272\u306e\u4ed5\u65b9\u3067\u7d50\u679c\u304c\u3069\u306e\u304f\u3089\u3044\u5909\u308f\u308b\u304b\u3092\u898b\u3066\u307f\u307e\u3059\uff0e\n\u30c7\u30fc\u30bf\u306f\u5b9f\u9a13\u7684\u306b100\u6b21\u5143\uff0c5000\u30b5\u30f3\u30d7\u30eb\u3067\u3084\u3063\u3066\u307f\u307e\u3059\uff0e\n\u30c7\u30fc\u30bf\u9593\u8ddd\u96e2\u306f\u30e6\u30fc\u30af\u30ea\u30c3\u30c9\u8ddd\u96e2\u3067\u6e2c\u308a\u307e\u3059\uff0e\n\nX=rand(5000,100);\nblock_size=[10, 50, 100, 500, 1000, 2500];\n\n% preallocation\ndmat=zeros(size(X,1),size(X,1));\n\n\n\nfor i=1:length(block_size)\n    tic\n    dmat=pdist2_parallel(X,X,block_size(i));\n    t=toc;\n    fprintf('block size %d: %f\\n', block_size(i), t);\nend\ntic\ndmat=pdist2(X,X);\nt=toc;\nfprintf('not parallelized: %f\\n', t);\n\n\n\u5b9f\u884c\u7d50\u679c\n\nblock size 10: 6.520659\nblock size 50: 1.252058\nblock size 100: 1.172509\nblock size 500: 1.237493\nblock size 1000: 1.209794\nblock size 2500: 1.765514\nnot parallelized: 2.847441\n\n\u4e26\u5217\u5316\u3057\u306a\u3044\u5834\u5408\u3068\u6bd4\u8f03\u3057\u3066\uff0c\u6700\u5927\u30672\u500d\u5f37\u901f\u304f\u306a\u308a\u307e\u3057\u305f\uff0e\u305f\u3060\u3057\uff0c\u5206\u5272\u3092\u7d30\u304b\u304f\u3057\u3059\u304e\u308b\u3068\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u304c\u843d\u3061\u3066\u3057\u307e\u3046\u306e\u3067\uff0c\u9069\u5207\u306a\u5206\u5272\u30b5\u30a4\u30ba\u3092\u898b\u3064\u3051\u308b\u5fc5\u8981\u304c\u3042\u308a\u305d\u3046\u3067\u3059\uff0e\n\n\n\u6b21\u306b\uff0c\u30c7\u30fc\u30bf\u30b5\u30a4\u30ba\u306b\u3088\u3063\u3066\u7d50\u679c\u304c\u3069\u306e\u7a0b\u5ea6\u5909\u308f\u308b\u304b\u3092\u898b\u3066\u307f\u307e\u3059\uff0e\n\u5148\u306e\u5b9f\u9a13\u7d50\u679c\u3092\u53c2\u8003\u306b\uff0c\u30c7\u30fc\u30bf\u309210\u5206\u5272\uff08\u3064\u307e\u308a\u8a08\u7b97\u3092100\u5206\u5272\uff09\u3057\u3066\u8a08\u7b97\u3057\u3066\u307f\u307e\u3059\uff0e\n\n%% test for data size\ndata_size=[100, 500, 1000, 5000, 10000];\nfor i=1:length(data_size)\n\n    X=rand(data_size(i),100);\n    block_size=data_size(i)/50;\n    fprintf('data size: %d\\n', data_size(i));\n\n    % preallocation\n    dmat=zeros(size(X,1),size(X,1));\n\n    tic\n    dmat=pdist2(X,X);\n    t=toc;\n\n    fprintf('not parallelized: %f\\n', t);\n\n    tic\n    dmat=pdist2_parallel(X,X,block_size);\n    t=toc;\n    fprintf('parallelized: %f\\n', t);\n\nend\n\n\n\u5b9f\u884c\u7d50\u679c\n\ndata size: 100\nnot parallelized: 0.001552\nparallelized: 0.055133\ndata size: 500\nnot parallelized: 0.029648\nparallelized: 0.068817\ndata size: 1000\nnot parallelized: 0.113881\nparallelized: 0.104183\ndata size: 5000\nnot parallelized: 2.892644\nparallelized: 1.191135\ndata size: 10000\nnot parallelized: 11.506141\nparallelized: 4.499590\n\n\u30c7\u30fc\u30bf\u30b5\u30a4\u30ba\u304c\u5c0f\u3055\u3044\u3046\u3061\u306f\u30aa\u30fc\u30d0\u30fc\u30d8\u30c3\u30c9\u306e\u554f\u984c\u3067\u4e26\u5217\u5316\u3057\u306a\u3044\u65b9\u304c\u9ad8\u901f\u3067\u3059\u304c\uff0c\u30c7\u30fc\u30bf\u30b5\u30a4\u30ba\u304c\u5927\u304d\u304f\u306a\u308b\u3068\uff0c\u4e26\u5217\u5316\u3057\u305f\u65b9\u304c2\u500d\u5f37\u901f\u304f\u306a\u308a\u307e\u3057\u305f\uff0e\n[pdist2](http://www.mathworks.co.jp/jp/help/stats/pdist2.html)\u306f\uff0c\u30c7\u30fc\u30bf\u9593\u306e\u30da\u30a2\u30ef\u30a4\u30ba\u8ddd\u96e2\u3092\u8a08\u7b97\u3057\u3066\u304f\u308c\u308b\u4fbf\u5229\u95a2\u6570\u3067\u3059\uff0e\u3067\u3059\u304c\uff0cMatlab\u30d7\u30ea\u30bb\u30c3\u30c8\u306epdist2\u306f\u30de\u30eb\u30c1\u30b3\u30a2\u3067\u306e\u4e26\u5217\u5316\u306b\u5bfe\u5fdc\u3057\u3066\u306a\u3044\u306e\u3067\uff0c\u30c7\u30fc\u30bf\u30b5\u30a4\u30ba\u304c\u3067\u304b\u304f\u306a\u308b\u3068\u8a08\u7b97\u6642\u9593\u304c\u304b\u304b\u308b\u3068\u3044\u3046\u554f\u984c\u304c\u3042\u308a\u307e\u3059\uff0e\n\n\u305d\u3053\u3067\u672c\u8a18\u4e8b\u3067\u306f\uff0c\u30c7\u30fc\u30bf\u4e26\u5217\u5316\u3092\u3059\u308b\u3053\u3068\u3067\u8a08\u7b97\u306e\u9ad8\u901f\u5316\u3092\u76ee\u6307\u3057\u307e\u3059\uff0estatistic toolbox (pdist2), parallel computing toolbox (parfor) \u304c\u5fc5\u8981\u3067\u3059\u306e\u3067\u3054\u6ce8\u610f\u304f\u3060\u3055\u3044\uff0e\n\n```matlab:pdist2_parallel\nfunction [ dmat ] = pdist2_parallel( X, Y, block_size, fun )\n%PDIST2_PARALLEL parallelized version of pdist2\n\nif(nargin<4)\n    fun='euclidean'; % \u3053\u306e\u8fba\u306f\u304a\u597d\u307f\u3067\nend\n\n% decompose similarity matrix\nstep_x=unique([1:block_size:size(X,1),size(X,1)+1])';\nstep_x=[step_x(1:end-1),step_x(2:end)-1];\nnsteps_x=size(step_x,1);\nX_sub=cell(nsteps_x,1);\nfor i=1:nsteps_x\n    X_sub{i}=X(step_x(i,1):step_x(i,2),:); % block_size\u306b\u57fa\u3065\u3044\u3066\u30c7\u30fc\u30bf\u3092\u5206\u5272\nend\nstep_y=unique([1:block_size:size(Y,1),size(Y,1)+1])';\nstep_y=[step_y(1:end-1),step_y(2:end)-1];\nnsteps_y=size(step_y,1);\nY_sub=cell(nsteps_y,1);\nfor i=1:nsteps_y\n    Y_sub{i}=Y(step_y(i,1):step_y(i,2),:); % block_size\u306b\u57fa\u3065\u3044\u3066\u30c7\u30fc\u30bf\u3092\u5206\u5272\nend\n\ndmat=cell(nsteps_x, nsteps_y);\nparfor i=1:nsteps_x*nsteps_y % \u30c7\u30fc\u30bf\u4e26\u5217\u5316\u3057\u307e\u3059\n    i1=mod(i-1,nsteps_x)+1;\n    i2=(i-mod(i-1,nsteps_x)-1)/nsteps_x+1;\n    dmat{i}=pdist2(X_sub{i1},Y_sub{i2}, fun);\nend\ndmat=cell2mat(dmat); % \u7d50\u679c\u3092\u7d50\u5408\u3057\u307e\u3059\n\nend\n```\n\n## \u5b9f\u9a13\n\u5b9f\u9a13\u74b0\u5883\u306f\nMac OS X (10.7.5)\nProcessor 2 x 2.66 GHz 6-Core Intel Xeon\nMemory 32GB\nMatlab2012b\n12\u500b\u306eworker\u3067\u5b9f\u9a13\u3092\u884c\u3044\u307e\u3059\uff08\u3064\u307e\u308a\u6700\u592712\u4e26\u5217\uff09\uff0e\n\n* \u307e\u305a\u306f\u5206\u5272\u306e\u4ed5\u65b9\u3067\u7d50\u679c\u304c\u3069\u306e\u304f\u3089\u3044\u5909\u308f\u308b\u304b\u3092\u898b\u3066\u307f\u307e\u3059\uff0e\n\u30c7\u30fc\u30bf\u306f\u5b9f\u9a13\u7684\u306b100\u6b21\u5143\uff0c5000\u30b5\u30f3\u30d7\u30eb\u3067\u3084\u3063\u3066\u307f\u307e\u3059\uff0e\n\u30c7\u30fc\u30bf\u9593\u8ddd\u96e2\u306f\u30e6\u30fc\u30af\u30ea\u30c3\u30c9\u8ddd\u96e2\u3067\u6e2c\u308a\u307e\u3059\uff0e\n\n```matlab\nX=rand(5000,100);\nblock_size=[10, 50, 100, 500, 1000, 2500];\n\n% preallocation\ndmat=zeros(size(X,1),size(X,1));\n\n\n\nfor i=1:length(block_size)\n    tic\n    dmat=pdist2_parallel(X,X,block_size(i));\n    t=toc;\n    fprintf('block size %d: %f\\n', block_size(i), t);\nend\ntic\ndmat=pdist2(X,X);\nt=toc;\nfprintf('not parallelized: %f\\n', t);\n```\n\n* \u5b9f\u884c\u7d50\u679c\n\n```\nblock size 10: 6.520659\nblock size 50: 1.252058\nblock size 100: 1.172509\nblock size 500: 1.237493\nblock size 1000: 1.209794\nblock size 2500: 1.765514\nnot parallelized: 2.847441\n```\n\n\u4e26\u5217\u5316\u3057\u306a\u3044\u5834\u5408\u3068\u6bd4\u8f03\u3057\u3066\uff0c\u6700\u5927\u30672\u500d\u5f37\u901f\u304f\u306a\u308a\u307e\u3057\u305f\uff0e\u305f\u3060\u3057\uff0c\u5206\u5272\u3092\u7d30\u304b\u304f\u3057\u3059\u304e\u308b\u3068\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u304c\u843d\u3061\u3066\u3057\u307e\u3046\u306e\u3067\uff0c\u9069\u5207\u306a\u5206\u5272\u30b5\u30a4\u30ba\u3092\u898b\u3064\u3051\u308b\u5fc5\u8981\u304c\u3042\u308a\u305d\u3046\u3067\u3059\uff0e\n\n- - -\n\n* \u6b21\u306b\uff0c\u30c7\u30fc\u30bf\u30b5\u30a4\u30ba\u306b\u3088\u3063\u3066\u7d50\u679c\u304c\u3069\u306e\u7a0b\u5ea6\u5909\u308f\u308b\u304b\u3092\u898b\u3066\u307f\u307e\u3059\uff0e\n\u5148\u306e\u5b9f\u9a13\u7d50\u679c\u3092\u53c2\u8003\u306b\uff0c\u30c7\u30fc\u30bf\u309210\u5206\u5272\uff08\u3064\u307e\u308a\u8a08\u7b97\u3092100\u5206\u5272\uff09\u3057\u3066\u8a08\u7b97\u3057\u3066\u307f\u307e\u3059\uff0e\n\n```matlab\n%% test for data size\ndata_size=[100, 500, 1000, 5000, 10000];\nfor i=1:length(data_size)\n    \n    X=rand(data_size(i),100);\n    block_size=data_size(i)/50;\n    fprintf('data size: %d\\n', data_size(i));\n\n    % preallocation\n    dmat=zeros(size(X,1),size(X,1));\n\n    tic\n    dmat=pdist2(X,X);\n    t=toc;\n    \n    fprintf('not parallelized: %f\\n', t);\n\n    tic\n    dmat=pdist2_parallel(X,X,block_size);\n    t=toc;\n    fprintf('parallelized: %f\\n', t);\n\nend\n```\n\n* \u5b9f\u884c\u7d50\u679c\n\n```\ndata size: 100\nnot parallelized: 0.001552\nparallelized: 0.055133\ndata size: 500\nnot parallelized: 0.029648\nparallelized: 0.068817\ndata size: 1000\nnot parallelized: 0.113881\nparallelized: 0.104183\ndata size: 5000\nnot parallelized: 2.892644\nparallelized: 1.191135\ndata size: 10000\nnot parallelized: 11.506141\nparallelized: 4.499590\n```\n\n\u30c7\u30fc\u30bf\u30b5\u30a4\u30ba\u304c\u5c0f\u3055\u3044\u3046\u3061\u306f\u30aa\u30fc\u30d0\u30fc\u30d8\u30c3\u30c9\u306e\u554f\u984c\u3067\u4e26\u5217\u5316\u3057\u306a\u3044\u65b9\u304c\u9ad8\u901f\u3067\u3059\u304c\uff0c\u30c7\u30fc\u30bf\u30b5\u30a4\u30ba\u304c\u5927\u304d\u304f\u306a\u308b\u3068\uff0c\u4e26\u5217\u5316\u3057\u305f\u65b9\u304c2\u500d\u5f37\u901f\u304f\u306a\u308a\u307e\u3057\u305f\uff0e", "tags": ["matlab"]}