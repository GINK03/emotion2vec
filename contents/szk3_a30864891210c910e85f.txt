{"tags": ["AWS", "Node.js", "ElasticBeanstalk"], "context": " More than 1 year has passed since last update.\u5148\u65e5\u3001\u540c\u50da\u304b\u3089ElasticBeansTalk\u3067\u7acb\u3066\u305f\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306b\u30ed\u30b0\u30a4\u30f3\u3057\u305f\u6642\u306b\u300180\u756a\u3092LISTEN\u3057\u3066\u306a\u3044\u3088\u3046\u306b\u898b\u3048\u308b\u3093\u3060\u3051\u3069\u3001\u4f55\u6545\u304b\u30ea\u30af\u30a8\u30b9\u30c8\u306f\u53d7\u3051\u4ed8\u3051\u308b\u3093\u3060\u3088\u306d\u3002\u3053\u308c\u3069\u3046\u3044\u3046\u3053\u3068\u3067\u3059\u304b\u306d\uff1f\n\u3068\u3044\u3046\u8cea\u554f\u3092\u9802\u304d\u307e\u3057\u305f\u3002\n\u4e0d\u601d\u8b70\u306b\u601d\u3063\u3066\u8abf\u67fb\u3057\u305f\u306e\u3067\u3001\u305d\u306e\u6642\u306e\u30e1\u30e2\u3092\u307e\u3068\u3081\u307e\u3057\u305f\u3002\n\n\u524d\u63d0\nElasticBeansTalk\u306f\u3001\u74b0\u5883\u67a0\u304cWeb Server \u3067 \u74b0\u5883\u30bf\u30a4\u30d7\u304cLoad balancing, auto scaling \u3092VPC\u3067\u52d5\u304b\u3057\u3066\u307e\u3059\u3002\u30a2\u30d7\u30ea\u306f\u3001node.js\u306e\u30b5\u30f3\u30d7\u30eb\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3092\u4f7f\u3063\u3066\u307e\u3059\u3002\n\n\u691c\u8a3c\n\u307e\u305a\u306f\u3001LISTEN\u306e\u72b6\u614b\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\u304a\u30fc\u3001\u30db\u30f3\u30c8\u3060\u300280\u756a\u306fLISTEN\u3057\u3066\u306a\u3044\u3088\u3046\u306b\u898b\u3048\u307e\u3059\u3002\n[ec2-user@ip-172-20-21-59 ~]$ ss -nlt\nState      Recv-Q Send-Q      Local Address:Port        Peer Address:Port \nLISTEN     0      128                     *:8080                   *:*     \nLISTEN     0      128                    :::22                    :::*     \nLISTEN     0      128                     *:22                     *:*     \nLISTEN     0      10              127.0.0.1:25                     *:*     \n\n\u6b21\u306bnginx\u306e\u8a2d\u5b9a\u3001\u3053\u308c\u308280\u756a\u3067LISTEN\u3059\u308b\u3088\u3046\u306a\u8a2d\u5b9a\u306f\u3042\u308a\u307e\u305b\u3093\u3002\nnginx\u306f8080\u3067LISTEN\u3057\u3066\u307e\u3059\u306d\u3002\n[ec2-user@ip-172-20-21-59 ~]$ grep -r listen /etc/nginx | grep -v .default\n/etc/nginx/conf.d/00_elastic_beanstalk_proxy.conf:    listen 8080;\n/etc/nginx/conf.d/virtual.conf:#    listen       8000;\n/etc/nginx/conf.d/virtual.conf:#    listen       somename:8080;\n\n\u78ba\u304b\u306b\u3001\u3053\u308c\u3060\u3051\u3060\u3068\u30d1\u30c3\u3068\u898b\u306780\u756a\u3092LISTEN\u3057\u3066\u306a\u3044\u3088\u3046\u306b\u898b\u3048\u307e\u3059\u3002\n\u3058\u3083\u3001\u3069\u3046\u306a\u3063\u3066\u3044\u308b\u306e\u304b\u3063\u3066\u3044\u3046\u3068\u3002\n\n\u7b54\u3048\n\u5b9f\u306fNAT\u304c\u52d5\u3044\u3066\u3044\u307e\u3059\u3002PREROUTING\u30c1\u30a7\u30a4\u30f3\u3067\u300180\u756a\u30dd\u30fc\u30c8\u30928080\u756a\u30dd\u30fc\u30c8\u306b\u30ea\u30c0\u30a4\u30ec\u30af\u30c8\u3059\u308b\u8a2d\u5b9a\u306b\u306a\u3063\u3066\u307e\u3057\u305f\u3002\n[ec2-user@ip-172-20-21-59 ~]$ sudo iptables -t nat -S PREROUTING -v\n-P PREROUTING ACCEPT -c 3 216\n-A PREROUTING -i eth0 -p tcp -m tcp --dport 80 -c 7124 427440 -j REDIRECT --to-ports 8080\n\n\n\u307e\u3068\u3081\nEB\u3067\u30c8\u30e9\u30d5\u30a3\u30c3\u30af\u3092\u6d41\u3059\u305f\u3081\u306b\u3001\u88cf\u5074\u3067\u3044\u308d\u3044\u308d\u304c\u3093\u3070\u3063\u3066\u3044\u308b\u59ff\u304c\u57a3\u9593\u898b\u308c\u305f\u6c17\u304c\u3057\u307e\u3057\u305f\u3002\u3042\u308a\u304c\u305f\u3044\u3067\u3059\u306d\u3002\n\u3067\u306f\u3001\u306a\u305c\u3053\u306e\u3088\u3046\u306a\u5f62\u3092\u3068\u3063\u3066\u3044\u308b\u306e\u3067\u3057\u3087\u3046\u304b\uff1f\n\u4e88\u60f3\u3067\u3059\u304c\u3001EB\u306e\u3088\u3046\u306a\u30de\u30cd\u30fc\u30b8\u30c9\u30b5\u30fc\u30d3\u30b9\u306e\u5834\u5408\u3001\u30ea\u30bd\u30fc\u30b9\u9593\u306e\u4f9d\u5b58\u6027\u3092\u89e3\u6c7a\u3059\u308b\u306e\u304c\u3081\u3093\u3069\u304f\u3055\u3044\u306e\u306f\u5bb9\u6613\u306b\u60f3\u50cf\u3067\u304d\u307e\u3059\u3002\u305d\u3053\u3067\u3001AWS\u306e\u30ea\u30bd\u30fc\u30b9\u306b\u3064\u3044\u3066\u306f\u3042\u308b\u7a0b\u5ea6\u5171\u901a\u306e\u5f62\u306b\u3057\u3066\u304a\u3044\u3066\u3001\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3(\u3068\u30df\u30c9\u30eb\u30a6\u30a7\u30a2)\u4f9d\u5b58\u306e\u3082\u306e\u306f\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306b\u96a0\u307a\u3044\u3059\u308b\u3053\u3068\u3067\u8cac\u4efb\u306e\u7bc4\u7587\u3092\u308f\u3051\u305f\u304b\u3063\u305f\u3068\u304b\u3001\u305f\u3076\u3093\u305d\u3093\u306a\u611f\u3058\u306a\u3093\u3058\u3083\u306a\u3044\u304b\u306a\u3068\u601d\u3044\u307e\u3057\u305f\u3002\n\u8ab0\u304b\u8a73\u3057\u3044\u3053\u3068\u3092\u3054\u5b58\u77e5\u306e\u65b9\u3044\u3089\u3063\u3057\u3083\u3044\u307e\u3057\u305f\u3089\u6559\u3048\u3066\u4e0b\u3055\u3044m(_ _)m\n\n\u8ffd\u8a18\nthakyuu\u3055\u3093\u304b\u3089\u3001\u7279\u6a29\u30dd\u30fc\u30c8\u306e\u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u30ea\u30b9\u30af\u56de\u907f\u304c\u7406\u7531\u3067\u306f\uff1f\u3068\u30b3\u30e1\u30f3\u30c8\u9802\u304d\u307e\u3057\u305f\u3002\n\u3042\u308a\u304c\u3068\u3046\u3054\u3056\u3044\u307e\u3057\u305f\u3002\n\n\u304a\u307e\u3051\nEnvironmentType\u304c Go(Preconfigured - Docker) \u306e\u5834\u5408\u3001\nnode.js\u306e\u6642\u3068\u540c\u69d8\u306bnat\u306e\u6a5f\u80fd\u3092\u4f7f\u3063\u3066\u3044\u308b\u3088\u3046\u3067\u3057\u305f\u3002(DOCKER\u30c1\u30a7\u30a4\u30f3\u306b\u6d41\u3057\u3066\u3044\u308b\u304c\u78ba\u8a8d\u3067\u304d\u307e\u3059\u306d\u3002)\n[ec2-user@ip-172-20-17-101 ~]$ sudo iptables -t nat -S PREROUTING -v\n-P PREROUTING ACCEPT -c 1757 105428\n-A PREROUTING -m addrtype --dst-type LOCAL -c 1757 105428 -j DOCKER\n\n[ec2-user@ip-172-20-17-101 ~]$ sudo iptables -t nat -L -v\nChain PREROUTING (policy ACCEPT 1835 packets, 110K bytes)\n pkts bytes target     prot opt in     out     source               destination         \n 1835  110K DOCKER     all  --  any    any     anywhere             anywhere             ADDRTYPE match dst-type LOCAL\n\nChain INPUT (policy ACCEPT 1835 packets, 110K bytes)\n pkts bytes target     prot opt in     out     source               destination         \n\nChain OUTPUT (policy ACCEPT 2233 packets, 158K bytes)\n pkts bytes target     prot opt in     out     source               destination         \n    0     0 DOCKER     all  --  any    any     anywhere            !loopback/8           ADDRTYPE match dst-type LOCAL\n\nChain POSTROUTING (policy ACCEPT 2233 packets, 158K bytes)\n pkts bytes target     prot opt in     out     source               destination         \n    0     0 MASQUERADE  all  --  any    !docker0  172.17.0.0/16        anywhere            \n\nChain DOCKER (2 references)\n pkts bytes target     prot opt in     out     source               destination \n\n\n\u5148\u65e5\u3001\u540c\u50da\u304b\u3089ElasticBeansTalk\u3067\u7acb\u3066\u305f\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306b\u30ed\u30b0\u30a4\u30f3\u3057\u305f\u6642\u306b\u300180\u756a\u3092LISTEN\u3057\u3066\u306a\u3044\u3088\u3046\u306b\u898b\u3048\u308b\u3093\u3060\u3051\u3069\u3001\u4f55\u6545\u304b\u30ea\u30af\u30a8\u30b9\u30c8\u306f\u53d7\u3051\u4ed8\u3051\u308b\u3093\u3060\u3088\u306d\u3002\u3053\u308c\u3069\u3046\u3044\u3046\u3053\u3068\u3067\u3059\u304b\u306d\uff1f\n\n\u3068\u3044\u3046\u8cea\u554f\u3092\u9802\u304d\u307e\u3057\u305f\u3002\n\n\u4e0d\u601d\u8b70\u306b\u601d\u3063\u3066\u8abf\u67fb\u3057\u305f\u306e\u3067\u3001\u305d\u306e\u6642\u306e\u30e1\u30e2\u3092\u307e\u3068\u3081\u307e\u3057\u305f\u3002\n\n## \u524d\u63d0\n\nElasticBeansTalk\u306f\u3001\u74b0\u5883\u67a0\u304c`Web Server` \u3067 \u74b0\u5883\u30bf\u30a4\u30d7\u304c`Load balancing, auto scaling` \u3092VPC\u3067\u52d5\u304b\u3057\u3066\u307e\u3059\u3002\u30a2\u30d7\u30ea\u306f\u3001`node.js`\u306e\u30b5\u30f3\u30d7\u30eb\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3092\u4f7f\u3063\u3066\u307e\u3059\u3002\n\n## \u691c\u8a3c\n\n\u307e\u305a\u306f\u3001LISTEN\u306e\u72b6\u614b\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\u304a\u30fc\u3001\u30db\u30f3\u30c8\u3060\u300280\u756a\u306fLISTEN\u3057\u3066\u306a\u3044\u3088\u3046\u306b\u898b\u3048\u307e\u3059\u3002\n\n```shell-session\n[ec2-user@ip-172-20-21-59 ~]$ ss -nlt\nState      Recv-Q Send-Q      Local Address:Port        Peer Address:Port \nLISTEN     0      128                     *:8080                   *:*     \nLISTEN     0      128                    :::22                    :::*     \nLISTEN     0      128                     *:22                     *:*     \nLISTEN     0      10              127.0.0.1:25                     *:*     \n```\n\n\u6b21\u306bnginx\u306e\u8a2d\u5b9a\u3001\u3053\u308c\u308280\u756a\u3067LISTEN\u3059\u308b\u3088\u3046\u306a\u8a2d\u5b9a\u306f\u3042\u308a\u307e\u305b\u3093\u3002\nnginx\u306f8080\u3067LISTEN\u3057\u3066\u307e\u3059\u306d\u3002\n\n```shell-session\n[ec2-user@ip-172-20-21-59 ~]$ grep -r listen /etc/nginx | grep -v .default\n/etc/nginx/conf.d/00_elastic_beanstalk_proxy.conf:    listen 8080;\n/etc/nginx/conf.d/virtual.conf:#    listen       8000;\n/etc/nginx/conf.d/virtual.conf:#    listen       somename:8080;\n```\n\n\u78ba\u304b\u306b\u3001\u3053\u308c\u3060\u3051\u3060\u3068\u30d1\u30c3\u3068\u898b\u306780\u756a\u3092LISTEN\u3057\u3066\u306a\u3044\u3088\u3046\u306b\u898b\u3048\u307e\u3059\u3002\n\n\u3058\u3083\u3001\u3069\u3046\u306a\u3063\u3066\u3044\u308b\u306e\u304b\u3063\u3066\u3044\u3046\u3068\u3002\n\n## \u7b54\u3048\n\n\u5b9f\u306fNAT\u304c\u52d5\u3044\u3066\u3044\u307e\u3059\u3002PREROUTING\u30c1\u30a7\u30a4\u30f3\u3067\u300180\u756a\u30dd\u30fc\u30c8\u30928080\u756a\u30dd\u30fc\u30c8\u306b\u30ea\u30c0\u30a4\u30ec\u30af\u30c8\u3059\u308b\u8a2d\u5b9a\u306b\u306a\u3063\u3066\u307e\u3057\u305f\u3002\n\n```shell-session\n[ec2-user@ip-172-20-21-59 ~]$ sudo iptables -t nat -S PREROUTING -v\n-P PREROUTING ACCEPT -c 3 216\n-A PREROUTING -i eth0 -p tcp -m tcp --dport 80 -c 7124 427440 -j REDIRECT --to-ports 8080\n```\n\n## \u307e\u3068\u3081\n\nEB\u3067\u30c8\u30e9\u30d5\u30a3\u30c3\u30af\u3092\u6d41\u3059\u305f\u3081\u306b\u3001\u88cf\u5074\u3067\u3044\u308d\u3044\u308d\u304c\u3093\u3070\u3063\u3066\u3044\u308b\u59ff\u304c\u57a3\u9593\u898b\u308c\u305f\u6c17\u304c\u3057\u307e\u3057\u305f\u3002\u3042\u308a\u304c\u305f\u3044\u3067\u3059\u306d\u3002\n\n\u3067\u306f\u3001\u306a\u305c\u3053\u306e\u3088\u3046\u306a\u5f62\u3092\u3068\u3063\u3066\u3044\u308b\u306e\u3067\u3057\u3087\u3046\u304b\uff1f\n\n\u4e88\u60f3\u3067\u3059\u304c\u3001EB\u306e\u3088\u3046\u306a\u30de\u30cd\u30fc\u30b8\u30c9\u30b5\u30fc\u30d3\u30b9\u306e\u5834\u5408\u3001\u30ea\u30bd\u30fc\u30b9\u9593\u306e\u4f9d\u5b58\u6027\u3092\u89e3\u6c7a\u3059\u308b\u306e\u304c\u3081\u3093\u3069\u304f\u3055\u3044\u306e\u306f\u5bb9\u6613\u306b\u60f3\u50cf\u3067\u304d\u307e\u3059\u3002\u305d\u3053\u3067\u3001AWS\u306e\u30ea\u30bd\u30fc\u30b9\u306b\u3064\u3044\u3066\u306f\u3042\u308b\u7a0b\u5ea6\u5171\u901a\u306e\u5f62\u306b\u3057\u3066\u304a\u3044\u3066\u3001\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3(\u3068\u30df\u30c9\u30eb\u30a6\u30a7\u30a2)\u4f9d\u5b58\u306e\u3082\u306e\u306f\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306b\u96a0\u307a\u3044\u3059\u308b\u3053\u3068\u3067\u8cac\u4efb\u306e\u7bc4\u7587\u3092\u308f\u3051\u305f\u304b\u3063\u305f\u3068\u304b\u3001\u305f\u3076\u3093\u305d\u3093\u306a\u611f\u3058\u306a\u3093\u3058\u3083\u306a\u3044\u304b\u306a\u3068\u601d\u3044\u307e\u3057\u305f\u3002\n\n\u8ab0\u304b\u8a73\u3057\u3044\u3053\u3068\u3092\u3054\u5b58\u77e5\u306e\u65b9\u3044\u3089\u3063\u3057\u3083\u3044\u307e\u3057\u305f\u3089\u6559\u3048\u3066\u4e0b\u3055\u3044m(_ _)m\n\n### \u8ffd\u8a18\nthakyuu\u3055\u3093\u304b\u3089\u3001\u7279\u6a29\u30dd\u30fc\u30c8\u306e\u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u30ea\u30b9\u30af\u56de\u907f\u304c\u7406\u7531\u3067\u306f\uff1f\u3068\u30b3\u30e1\u30f3\u30c8\u9802\u304d\u307e\u3057\u305f\u3002\n\u3042\u308a\u304c\u3068\u3046\u3054\u3056\u3044\u307e\u3057\u305f\u3002\n\n## \u304a\u307e\u3051\n\nEnvironmentType\u304c `Go(Preconfigured - Docker)` \u306e\u5834\u5408\u3001\nnode.js\u306e\u6642\u3068\u540c\u69d8\u306bnat\u306e\u6a5f\u80fd\u3092\u4f7f\u3063\u3066\u3044\u308b\u3088\u3046\u3067\u3057\u305f\u3002(DOCKER\u30c1\u30a7\u30a4\u30f3\u306b\u6d41\u3057\u3066\u3044\u308b\u304c\u78ba\u8a8d\u3067\u304d\u307e\u3059\u306d\u3002)\n\n```shell-session\n[ec2-user@ip-172-20-17-101 ~]$ sudo iptables -t nat -S PREROUTING -v\n-P PREROUTING ACCEPT -c 1757 105428\n-A PREROUTING -m addrtype --dst-type LOCAL -c 1757 105428 -j DOCKER\n\n[ec2-user@ip-172-20-17-101 ~]$ sudo iptables -t nat -L -v\nChain PREROUTING (policy ACCEPT 1835 packets, 110K bytes)\n pkts bytes target     prot opt in     out     source               destination         \n 1835  110K DOCKER     all  --  any    any     anywhere             anywhere             ADDRTYPE match dst-type LOCAL\n\nChain INPUT (policy ACCEPT 1835 packets, 110K bytes)\n pkts bytes target     prot opt in     out     source               destination         \n\nChain OUTPUT (policy ACCEPT 2233 packets, 158K bytes)\n pkts bytes target     prot opt in     out     source               destination         \n    0     0 DOCKER     all  --  any    any     anywhere            !loopback/8           ADDRTYPE match dst-type LOCAL\n\nChain POSTROUTING (policy ACCEPT 2233 packets, 158K bytes)\n pkts bytes target     prot opt in     out     source               destination         \n    0     0 MASQUERADE  all  --  any    !docker0  172.17.0.0/16        anywhere            \n\nChain DOCKER (2 references)\n pkts bytes target     prot opt in     out     source               destination \n```\n"}