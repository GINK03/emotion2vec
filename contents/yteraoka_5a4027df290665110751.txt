{"context": " More than 1 year has passed since last update.CentOS 7 \u3067 OpenLDAP \u30b5\u30fc\u30d0\u30fc2\u53f0\u3092\u30de\u30eb\u30c1\u30de\u30b9\u30bf\u69cb\u6210\u3067\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u3059\u308b\u65b9\u6cd5\u3067\u3059\nexample.com \u3068 example.net \u306e\u30de\u30eb\u30c1\u30c9\u30e1\u30a4\u30f3\u3067\u69cb\u6210\u3057\u307e\u3059\nSSL / TLS \u5bfe\u5fdc\u3082\u3055\u305b\u307e\u3059\n\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\nsudo yum -y install openldap-servers openldap-clients\n\n\n\u521d\u671f\u5316\n\u3084\u308a\u76f4\u3059\u3068\u304d\u306f\u3053\u3053\u304b\u3089\nsudo systemctl stop slapd\nsudo rm -fr /etc/openldap/slapd.d/cn=config/olcDatabase={2}hdb{,.ldif}\nsudo rm -fr /etc/openldap/slapd.d/cn=config/olcDatabase={3}hdb{,.ldif}\nsudo rm -fr /var/lib/ldap\nsudo install -d -o ldap -g ldap -m 0700 /var/lib/ldap\nsudo install -d -o ldap -g ldap -m 0700 /var/lib/ldap/example.com\nsudo install -d -o ldap -g ldap -m 0700 /var/lib/ldap/example.net\nsudo systemctl start slapd\n\n\n\u30c7\u30d5\u30a9\u30eb\u30c8\u306e URI \u3092\u8a2d\u5b9a\n\u4eca\u5f8c\u306e\u4f5c\u696d\u3092\u697d\u306b\u3059\u308b\u305f\u3081\u3001\u30c7\u30d5\u30a9\u30eb\u30c8\u306e URI \u3092\u8a2d\u5b9a\u3057\u307e\u3059\n/etc/openldap/ldap.conf \u306b\nURL ldapi://\n\n\u3092\u8a2d\u5b9a\u3057\u307e\u3059\u3002\u3053\u306e URI \u3067\u30a2\u30af\u30bb\u30b9\u3059\u308c\u3070 root \u306a\u3089\u306a\u3093\u3067\u3082\u3067\u304d\u307e\u3059\u3002\n\nLogLevel \u8a2d\u5b9a\nsudo ldapmodify <<__EOD__\ndn: cn=config\nchangetype: modify\nreplace: olcLogLevel\nolcLogLevel: config stats sync conns\n__EOD__\n\nsystemd \u3067\u306e\u30ed\u30b0\u78ba\u8a8d\u306f journalctl -aru slapd | less \u3042\u305f\u308a\u3067\u3002\n\nmy-domain.com \u306e\u4fee\u6b63\nyum \u3067\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u305f\u5834\u5408\u306e\u30b5\u30f3\u30d7\u30eb\u8a2d\u5b9a\u304c my-domain.com \u306a\u306e\u3067 example.com \u306b\u5909\u66f4\nsudo ldapmodify <<__EOD__\ndn: olcDatabase={1}monitor,cn=config\nchangetype: modify\nreplace: olcAccess\nolcAccess: to * by dn.base=\"gidNumber=0+uidNumber=0,cn=peercred,cn=external\n ,cn=auth\" read by dn.base=\"cn=Manager,dc=example,dc=com\" read by * none\n__EOD__\n\n\u78ba\u8a8d\nsudo ldapsearch -b cn=config olcDatabase=monitor\n\n\n\u30b9\u30ad\u30fc\u30de\u306e\u30a4\u30f3\u30dd\u30fc\u30c8\nsudo ldapadd -f /etc/openldap/schema/cosine.ldif\nsudo ldapadd -f /etc/openldap/schema/inetorgperson.ldif\n\nposix \u30a2\u30ab\u30a6\u30f3\u30c8\u306a\u3069\u5fc5\u8981\u3067\u3042\u308c\u3070\u305d\u308c (nis.ldif ?) \u306a\u3069\u3082\n\u3053\u308c\u306f /etc/openldap/slapd.d/cn=config/cn=schema/ \u306b\u4fdd\u5b58\u3055\u308c\u308b\u306e\u3067 /var/lib/ldap/* \u306e\u524a\u9664\u3067\u306f\u6d88\u3048\u307e\u305b\u3093\n\nexample.com, example.net \u7528\u306e\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u4f5c\u6210\nsudo ldapadd <<__EOD__\ndn: olcDatabase={2}hdb,cn=config\nobjectClass: olcDatabaseConfig\nobjectClass: olcHdbConfig\nolcDatabase: {2}hdb\nolcDbDirectory: /var/lib/ldap/example.com\nolcSuffix: dc=example,dc=com\nolcRootDN: cn=Manager,dc=example,dc=com\nolcAccess: to * by dn.base=\"gidNumber=0+uidNumber=0,cn=peercred,cn=external\n ,cn=auth\" manage by * none\nolcAccess: to dn.subtree=\"\" by * read\n__EOD__\n\nsudo ldapadd <<__EOD__\ndn: olcDatabase={3}hdb,cn=config\nobjectClass: olcDatabaseConfig\nobjectClass: olcHdbConfig\nolcDatabase: {3}hdb\nolcDbDirectory: /var/lib/ldap/example.net\nolcSuffix: dc=example,dc=net\nolcRootDN: cn=Manager,dc=example,dc=net\nolcAccess: to * by dn.base=\"gidNumber=0+uidNumber=0,cn=peercred,cn=external\n ,cn=auth\" manage by * none\nolcAccess: to dn.subtree=\"\" by * read\n__EOD__\n\nolcDatabase={2}hdb, olcDatabase={3}hdb \u3068\u6570\u5b57\u90e8\u5206\u3092\u660e\u793a\u3059\u308b\u3068\u3053\u308d\u3068\u30c9\u30e1\u30a4\u30f3\u3054\u3068\u306b\u5225\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea (olcDbDirectory) \u3092\u6307\u5b9a\u3059\u308b\u3068\u3053\u308d\u304c\u30dd\u30a4\u30f3\u30c8\n\n\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306e\u30c1\u30e5\u30fc\u30cb\u30f3\u30b0\n\u5024\u306f\u306a\u3093\u3068\u306a\u304f\u3067\u3059\nsudo ldapmodify <<__EOD__\ndn: olcDatabase={2}hdb,cn=config\nchangetype: modify\nadd: olcDbConfig\nolcDbConfig: set_cachesize 0 67108864 1\nolcDbConfig: set_lg_dir .\nolcDbConfig: set_lg_bsize 33554432\nolcDbConfig: set_lk_max_objects 3000\nolcDbConfig: set_lk_max_locks 3000\nolcDbConfig: set_lk_max_lockers 3000\nolcDbConfig: set_flags DB_LOG_AUTOREMOVE\n__EOD__\n\nsudo ldapmodify <<__EOD__\ndn: olcDatabase={3}hdb,cn=config\nchangetype: modify\nadd: olcDbConfig\nolcDbConfig: set_cachesize 0 67108864 1\nolcDbConfig: set_lg_dir .\nolcDbConfig: set_lg_bsize 33554432\nolcDbConfig: set_lk_max_objects 3000\nolcDbConfig: set_lk_max_locks 3000\nolcDbConfig: set_lk_max_lockers 3000\nolcDbConfig: set_flags DB_LOG_AUTOREMOVE\n__EOD__\n\n\n\u30c9\u30e1\u30a4\u30f3\u4f5c\u6210\u3068 RootDN \u30a2\u30ab\u30a6\u30f3\u30c8\u4f5c\u6210\n\u3053\u306e\u4f8b\u306e\u30d1\u30b9\u30ef\u30fc\u30c9\u306f 2h6R&9QE-6\nsudo ldapadd <<__EOD__\ndn: dc=example,dc=com\ndc: example\no: \"Example, Inc.\"\nobjectClass: dcObject\nobjectClass: organization\n\ndn: cn=Manager,dc=example,dc=com\nobjectClass: organizationalRole\nobjectClass: simpleSecurityObject\ncn: Manager\nuserPassword: {SSHA}T6fIJME1FHwKEuS9MG7BBhYU6TYLGRnX\n__EOD__\n\nsudo ldapadd <<__EOD__\ndn: dc=example,dc=net\ndc: example\no: \"Example, ltd.\"\nobjectClass: dcObject\nobjectClass: organization\n\ndn: cn=Manager,dc=example,dc=net\nobjectClass: organizationalRole\nobjectClass: simpleSecurityObject\ncn: Manager\nuserPassword: {SSHA}T6fIJME1FHwKEuS9MG7BBhYU6TYLGRnX\n__EOD__\n\n{SSHA} \u3067\u59cb\u307e\u308b\u30d1\u30b9\u30ef\u30fc\u30c9\u306e\u30cf\u30c3\u30b7\u30e5\u5024\u306f slappasswd \u30b3\u30de\u30f3\u30c9\u3067\u751f\u6210\u3067\u304d\u307e\u3059\n$ slappasswd\nNew password: \u30d1\u30b9\u30ef\u30fc\u30c9\nRe-enter new password: \u30d1\u30b9\u30ef\u30fc\u30c9\n{SSHA}T6fIJME1FHwKEuS9MG7BBhYU6TYLGRnX\n\n\nOU \u4f5c\u6210\n\u3068\u308a\u3042\u3048\u305a People \u3068 Group \u3092\u4f5c\u6210\u3057\u307e\u3059\u3002(People \u306b\u5bfe\u5fdc\u3059\u308b\u306e\u306f Groups \u3058\u3083\u306a\u3044\u306e\u304b\uff1f\u3068\u601d\u3044\u3064\u3064)\nsudo ldapadd <<__EOD__\ndn: ou=People,dc=example,dc=com\nou: People\nobjectClass: organizationalUnit\n\ndn: ou=Group,dc=example,dc=com\nou: Group\nobjectClass: organizationalUnit\n\ndn: ou=People,dc=example,dc=net\nou: People\nobjectClass: organizationalUnit\n\ndn: ou=Group,dc=example,dc=net\nou: Group\nobjectClass: organizationalUnit\n__EOD__\n\n\nACL \u8a2d\u5b9a\nsudo ldapmodify <<__EOD__\ndn: olcDatabase={2}hdb,cn=config\nreplace: olcAccess\nolcAccess: to * by dn.base=\"gidNumber=0+uidNumber=0,cn=peercred,cn=external\n ,cn=auth\" manage by * break\nolcAccess: to attrs=userPassword\n           by anonymous auth\n           by self write\n           by dn.exact=\"cn=Replication,dc=example,dc=com\" read\n           by dn.regex=\"uid=(user001|user002|user003),ou=People,dc=example,dc=com\" write\n           by group/groupOfUniqueNames/uniqueMember.exact=\"cn=Administrators,ou=Groups,dc=example,dc=com\" write\n           by * none\nolcAccess: to *\n           by dn.regex=\"uid=(user001|user002|user003),ou=People,dc=example,dc=com\" write\n           by group/groupOfUniqueNames/uniqueMember.exact=\"cn=Administrators,ou=Groups,dc=example,dc=com\" write\n           by * read\n__EOD__\n\nsudo ldapmodify <<__EOD__\ndn: olcDatabase={3}hdb,cn=config\nreplace: olcAccess\nolcAccess: to * by dn.base=\"gidNumber=0+uidNumber=0,cn=peercred,cn=external\n ,cn=auth\" manage by * break\nolcAccess: to attrs=userPassword\n           by anonymous auth\n           by self write\n           by dn.exact=\"cn=Replication,dc=example,dc=net\" read\n           by dn.regex=\"uid=(user001|user002|user003),ou=People,dc=example,dc=net\" write\n           by group/groupOfUniqueNames/uniqueMember.exact=\"cn=Administrators,ou=Groups,dc=example,dc=net\" write\n           by * none\nolcAccess: to *\n           by dn.regex=\"uid=(user001|user002|user003),ou=People,dc=example,dc=net\" write\n           by group/groupOfUniqueNames/uniqueMember.exact=\"cn=Administrators,ou=Groups,dc=example,dc=net\" write\n           by * read\n__EOD__\n\n\nuser001, user002, user003 \u3082\u3057\u304f\u306f Administrators \u30b0\u30eb\u30fc\u30d7\u306b\u6240\u5c5e\u3059\u308b\u30e1\u30f3\u30d0\u30fc\u306f\u5404\u30a8\u30f3\u30c8\u30ea\u306e\u66f8\u304d\u63db\u3048\u3084\u65b0\u898f\u30a8\u30f3\u30c8\u30ea\u306e\u8ffd\u52a0\u304c\u53ef\u80fd\n\u30d1\u30b9\u30ef\u30fc\u30c9\u4ee5\u5916\u306e\u53c2\u7167\u3067\u3042\u308c\u3070\u8ab0\u3067\u3082\u53ef\u80fd\n\u30d1\u30b9\u30ef\u30fc\u30c9\u306f\u8a8d\u8a3c\u3067\u306e\u5229\u7528\u304b\u3001\u672c\u4eba\u304c\u8a8d\u8a3c\u5f8c\u306b\u5909\u66f4\u3059\u308b\u3053\u3068\u306f\u53ef\u80fd\nReplication (\u5f8c\u3067\u8a2d\u5b9a\u3059\u308b) \u7528\u30e6\u30fc\u30b6\u30fc\u306f\u30d1\u30b9\u30ef\u30fc\u30c9\u3092\u53c2\u7167\u53ef\u80fd\n\n\n\u8a8d\u8a3c\u30c6\u30b9\u30c8\n\u3053\u3053\u3089\u3067\u8a8d\u8a3c\u306e\u30c6\u30b9\u30c8\u3092\u3057\u3066\u307f\u307e\u3059\nldapsearch -x -D \"cn=Manager,dc=example,dc=com\" -H ldap://localhost/ -W\n\nldapsearch -x -D \"cn=Manager,dc=example,dc=net\" -H ldap://localhost/ -W\n\n\u3069\u3061\u3089\u3067\u3082\u8a8d\u8a3c\u3067\u304d\u305f\u3067\u3057\u3087\u3046\u304b\n\n\u4e00\u610f\u6027\u5236\u7d04\n\u30e1\u30fc\u30eb\u30c9\u30ec\u30b9\u3084 uid \u306e\u91cd\u8907\u767b\u9332\u3092\u8a31\u5bb9\u3057\u306a\u3044\u3088\u3046\u306b Unique \u5236\u7d04\u3092\u3064\u3051\u307e\u3059\nsudo ldapadd <<__EOD__\ndn: cn=module,cn=config\ncn: module\nobjectClass: olcModuleList\nolcModulePath: /usr/lib64/openldap/\nolcModuleLoad: unique.la\n__EOD__\n\n\u30e2\u30b8\u30e5\u30fc\u30eb\u306e\u5b9a\u7fa9\u306f /etc/openldap/slapd.d/cn=config/cn=module{N}.ldif \u306b\u66f8\u304b\u308c\u308b\u306e\u3067 /var/lib/ldap/* \u3092\u6d88\u3057\u3066\u3082\u6b8b\u308a\u307e\u3059\nsudo ldapadd <<__EOD__\ndn: olcOverlay=unique,olcDatabase={2}hdb,cn=config\nobjectClass: olcOverlayConfig\nobjectClass: olcUniqueConfig\nolcOverlay: unique\nolcUniqueUri: ldap:///ou=People,dc=example,dc=com?uid?sub\nolcUniqueUri: ldap:///ou=People,dc=example,dc=com?mail?sub\n__EOD__\n\nsudo ldapadd <<__EOD__\ndn: olcOverlay=unique,olcDatabase={3}hdb,cn=config\nobjectClass: olcOverlayConfig\nobjectClass: olcUniqueConfig\nolcOverlay: unique\nolcUniqueUri: ldap:///ou=People,dc=example,dc=net?uid?sub\nolcUniqueUri: ldap:///ou=People,dc=example,dc=net?mail?sub\n__EOD__\n\n\n\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u4f5c\u6210\n\u6027\u80fd\u5411\u4e0a\u306e\u305f\u3081\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u6642\u306b\u3082\u4f7f\u308f\u308c\u307e\u3059\u3002\nsudo ldapmodify <<__EOD__\ndn: olcDatabase={2}hdb,cn=config\nchangetype: modify\nadd: olcDbIndex\nolcDbIndex: uid pres,eq,sub\n-\nadd: olcDbIndex\nolcDbIndex: ou pres,eq,sub\n-\nadd: olcDbIndex\nolcDbIndex: mail pres,eq,sub\n-\nadd: olcDbIndex\nolcDbIndex: objectClass eq\n-\nadd: olcDbIndex\nolcDbIndex: entryCSN eq\n-\nadd: olcDbIndex\nolcDbIndex: entryUUID eq\n__EOD__\n\nsudo ldapmodify <<__EOD__\ndn: olcDatabase={3}hdb,cn=config\nchangetype: modify\nadd: olcDbIndex\nolcDbIndex: uid pres,eq,sub\n-\nadd: olcDbIndex\nolcDbIndex: ou pres,eq,sub\n-\nadd: olcDbIndex\nolcDbIndex: mail pres,eq,sub\n-\nadd: olcDbIndex\nolcDbIndex: objectClass eq\n-\nadd: olcDbIndex\nolcDbIndex: entryCSN eq\n-\nadd: olcDbIndex\nolcDbIndex: entryUUID eq\n__EOD__\n\n\nSSL / TLS \u8a2d\u5b9a\n\n\u8a3c\u660e\u66f8\u8a2d\u5b9a\nMozilla \u306e Network Security Services (NSS) \u30c4\u30fc\u30eb\u3092\u4f7f\u3046\u4f8b\u304c\u3042\u3063\u305f\u308a\u3059\u308b\u306e\u3067\u3059\u304c\u3001\u624b\u6301\u3061\u306e PEM \u3092\u4f7f\u3046\u65b9\u6cd5\u304c\u3088\u304f\u308f\u304b\u3089\u306a\u304b\u3063\u305f\u305f\u3081\u3001PEM \u30d5\u30a1\u30a4\u30eb\u3092\u305d\u306e\u307e\u307e\u4f7f\u3044\u307e\u3059\u3002\ncertutil \u3067\u4f5c\u3089\u308c\u3066\u3044\u308b\u30d5\u30a1\u30a4\u30eb\u3092\u524a\u9664\nsudo rm /etc/openldap/certs/*\n\n\u624b\u6301\u3061\u306e\u8a3c\u660e\u66f8\u304c\u306a\u3051\u308c\u3070\u81ea\u5df1\u7f72\u540d\u306e\u8a3c\u660e\u66f8\u3092\u4f5c\u6210\nsudo openssl req -x509 -days 3650 -out /etc/openldap/certs/server.crt \\\n   -newkey rsa:2048 -keyout /etc/openldap/certs/server.key -nodes \\\n   -subj \"/C=JP/ST=Tokyo/L=Minato-ku/O=Example, Inc./CN=ldap.example.com/emailAddress=test@example.com\"\n\n/etc/openldap/certs/ca.crt \u306b\u4e2d\u9593\u8a3c\u660e\u66f8\u3092 /etc/openldap/certs/server.crt \u306b\u30b5\u30fc\u30d0\u30fc\u8a3c\u660e\u66f8\u3092 /etc/openldap/certs/server.key \u306b\u79d8\u5bc6\u9375\u3092\u7f6e\u304d\u307e\u3059\u3002\n\u79d8\u5bc6\u9375\u306f ldap \u30e6\u30fc\u30b6\u30fc\u3060\u3051\u304c\u8aad\u3081\u308c\u3070\u826f\u3044\u306e\u3067\nsudo chown ldap:ldap /etc/openldap/certs/server.key\nsudo chmod 400 /etc/openldap/certs/server.key\n\nsudo ldapmodify <<__EOD__\ndn: cn=config\nchangetype: modify\ndelete: olcTLSCACertificatePath\n-\nreplace: olcTLSCertificateFile\nolcTLSCertificateFile: /etc/openldap/certs/server.crt\n-\nreplace: olcTLSCertificateKeyFile\nolcTLSCertificateKeyFile: /etc/openldap/certs/server.key\n-\nreplace: olcTLSProtocolMin\nolcTLSProtocolMin: 3.1\n__EOD__\n\n\u4e2d\u9593\u8a3c\u660e\u66f8\u304c\u5fc5\u8981\u306a\u5834\u5408\u306f\u3053\u3061\u3089\u3082\nsudo ldapmodify <<__EOD__\ndn: cn=config\nchangetype: modify\nreplace: olcTLSCACertificateFile\nolcTLSCACertificateFile: /etc/openldap/certs/ca.crt\n__EOD__\n\n\u78ba\u8a8d\nsudo ldapsearch -b cn=config objectClass=olcGlobal\n\nPEM \u30d5\u30a1\u30a4\u30eb\u3092\u66f4\u65b0\u3057\u305f\u3089 slapd \u306e\u518d\u8d77\u52d5\u304c\u5fc5\u8981\u3067\u3059\n\u304c\u3001\u305d\u306e\u524d\u306b ldaps (636) \u30dd\u30fc\u30c8\u3092 Listen \u3059\u308b\u3088\u3046\u306b /etc/sysconfig/slapd \u3092\u66f8\u304d\u63db\u3048\u307e\u3059\n(SLAP_URLS \u306b ldaps:/// \u3092\u8ffd\u52a0)\nsudo sed -i -e 's#SLAPD_URLS=\"ldapi:/// ldap:///\"#SLAPD_URLS=\"ldapi:/// ldap:/// ldaps:///\"#' /etc/sysconfig/slapd\n\n\nslapd \u306e\u518d\u8d77\u52d5\nsudo systemctl restart slapd\n\n\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u5074\u306e\u8a2d\u5b9a\u3068\u306a\u308a\u307e\u3059\u304c /etc/openldap/ldap.conf \u3067 TLS_REQCERT allow \u3068\u6307\u5b9a\u3057\u306a\u3044\u5834\u5408\u3001ldapsearch \u30b3\u30de\u30f3\u30c9\u306a\u3069\u3067\u3044\u308f\u3086\u308b\u30aa\u30ec\u30aa\u30ec\u8a3c\u660e\u66f8\uff08\u81ea\u5df1\u7f72\u540d\uff09\u30b5\u30a4\u30c8\u306a\u3069\u306b\u30a2\u30af\u30bb\u30b9\u3067\u304d\u306a\u304f\u306a\u308a\u307e\u3059\u3002\nTLS_CACERT /etc/pki/tls/certs/ca-bundle.crt \u3068\u3057\u3066\u304a\u304f\u3068\u4e00\u822c\u7684\u306a\u8a3c\u660e\u6a5f\u95a2\u3067\u767a\u884c\u3055\u308c\u305f\u30b5\u30fc\u30d0\u30fc\u3078\u306e\u63a5\u7d9a\u304c\u53ef\u80fd\u3068\u306a\u308a\u307e\u3059\u3002\n\n\u30c6\u30b9\u30c8\nldapsearch -x -H ldaps://localhost/ -W -D cn=Manager,dc=example,dc=com -b dc=example,dc=com cn=Manager\n\nopenssl s_client -connect localhost:636\n\nopenssl \u30b3\u30de\u30f3\u30c9\u3067\u63a5\u7d9a\u3067\u304d\u308b\u306e\u306b ldapsearch \u3067\u63a5\u7d9a\u3067\u304d\u306a\u3044\u5834\u5408\u306f ldap.conf \u306e TLS_REQCERT allow \u3092\u78ba\u8a8d\n\n\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u8a2d\u5b9a\n\nServerID \u8a2d\u5b9a\nldap1 \u3068 ldap2 \u3068\u3044\u3046\u30b5\u30fc\u30d0\u30fc\u3067\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3059\u308b\u3068\u3057\u307e\u3059\nolcServerID \u3092\u30b5\u30fc\u30d0\u30fc\u3054\u3068\u306b\u4e00\u610f\u306b\u8a2d\u5b9a\u3057\u307e\u3059\nldap1 \u3067\nsudo ldapmodify <<__EOD__\ndn: cn=config\nchangetype: modify\nreplace: olcServerID\nolcServerID: 1\n__EOD__\n\nldap2 \u3067\nsudo ldapmodify <<__EOD__\ndn: cn=config\nchangetype: modify\nreplace: olcServerID\nolcServerID: 2\n__EOD__\n\n\u3092\u5b9f\u884c\u3057\u307e\u3059\n\n\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u7528\u30e6\u30fc\u30b6\u30fc\u4f5c\u6210\nACL \u8a2d\u5b9a\u3067\u65e2\u306b\u51fa\u3066\u3044\u307e\u3059\u304c Replication \u3068\u3044\u3046\u30e6\u30fc\u30b6\u30fc(?)\u3092\u4f5c\u6210\u3057\u307e\u3059\n\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306f\u53c2\u7167\u3055\u3048\u3067\u304d\u308c\u3070\u826f\u3044\u305f\u3081 RootDN (Manager) \u3068\u306f\u5225\u306b\u30e6\u30fc\u30b6\u30fc\u3092\u4f5c\u6210\u3057\u307e\u3059\n\u3053\u306e\u4f8b\u306e\u30d1\u30b9\u30ef\u30fc\u30c9\u306f YB)gNF!Q6)\nsudo ldapadd <<__EOD__\ndn: cn=Replication,dc=example,dc=com\nobjectClass: organizationalRole\nobjectClass: simpleSecurityObject\ncn: Replication\nuserPassword: {SSHA}bSU9ueMZ93IIlXB7KdiiLby9S0bF0C+J\n__EOD__\n\nsudo ldapadd <<__EOD__\ndn: cn=Replication,dc=example,dc=net\nobjectClass: organizationalRole\nobjectClass: simpleSecurityObject\ncn: Replication\nuserPassword: {SSHA}bSU9ueMZ93IIlXB7KdiiLby9S0bF0C+J\n__EOD__\n\n\u30d1\u30b9\u30ef\u30fc\u30c9\u5909\u66f4\u306f\u6b21\u306e\u3088\u3046\u306b\u3057\u3066\u884c\u3048\u307e\u3059 (-S \u306f\u30d1\u30b9\u30ef\u30fc\u30c9\u5165\u529b\u30d7\u30ed\u30f3\u30d7\u30c8\u8868\u793a\u306e\u6307\u5b9a)\nsudo ldappasswd -S cn=Replication,dc=example,dc=com\n\n\n\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30e2\u30b8\u30e5\u30fc\u30eb\u767b\u9332\nsudo ldapadd <<__EOD__\ndn: cn=module,cn=config\nobjectClass: olcModuleList\ncn: module\nolcmodulePath: /usr/lib64/openldap\nolcModuleLoad: syncprov.la\n__EOD__\n\n\u4e00\u610f\u6027(Unique)\u30e2\u30b8\u30e5\u30fc\u30eb\u3068\u540c\u69d8\u306b /etc/openldap/slapd.d/cn=config/cn=module{N}.ldif \u306b\u66f8\u304b\u308c\u307e\u3059\n\n\u30d7\u30ed\u30d0\u30a4\u30c0\u5074\u8a2d\u5b9a\nsudo ldapadd <<__EOD__\ndn: olcOverlay=syncprov,olcDatabase={2}hdb,cn=config\nobjectClass: olcOverlayConfig\nobjectClass: olcSyncProvConfig\nolcOverlay: syncprov\nolcSpSessionLog: 1000\n__EOD__\n\nsudo ldapadd <<__EOD__\ndn: olcOverlay=syncprov,olcDatabase={3}hdb,cn=config\nobjectClass: olcOverlayConfig\nobjectClass: olcSyncProvConfig\nolcOverlay: syncprov\nolcSpSessionLog: 1000\n__EOD__\n\n\n\u30b3\u30f3\u30b7\u30e5\u30fc\u30de\u5074\u8a2d\u5b9a\n\u53cc\u65b9\u306e\u30b5\u30fc\u30d0\u30fc\u3067\u3082\u3046\u4e00\u65b9\u306e\u30b5\u30fc\u30d0\u30fc\u3068\u540c\u671f\u3059\u308b\u3088\u3046\u306b\u8a2d\u5b9a\u3059\u308b\n\u53cc\u65b9\u5411\u306e\u305f\u3081(?) oldMirrorMode \u3092\u6709\u52b9\u306b\u3057\u307e\u3059\nsudo ldapmodify <<__EOD__\ndn: olcDatabase={2}hdb,cn=config\nchangetype: modify\nadd: olcSyncRepl\nolcSyncRepl: rid=001\n  provider=ldap://{\u76f8\u65b9\u30b5\u30fc\u30d0\u30fc}/\n  bindmethod=simple\n  binddn=\"cn=Replication,dc=example,dc=com\"\n  credentials=\"\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30e6\u30fc\u30b6\u30fc\u306e\u30d1\u30b9\u30ef\u30fc\u30c9\"\n  type=refreshAndPersist\n  interval=00:00:05:00\n  searchbase=\"dc=example,dc=com\"\n  scope=sub\n  retry=\"5 10 30 +\n__EOD__\n\nsudo ldapmodify <<__EOD__\ndn: olcDatabase={3}hdb,cn=config\nchangetype: modify\nadd: olcSyncRepl\nolcSyncRepl: rid=002\n  provider=ldap://{\u76f8\u65b9\u30b5\u30fc\u30d0\u30fc}/\n  bindmethod=simple\n  binddn=\"cn=Replication,dc=example,dc=net\"\n  credentials=\"\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30e6\u30fc\u30b6\u30fc\u306e\u30d1\u30b9\u30ef\u30fc\u30c9\"\n  type=refreshAndPersist\n  interval=00:00:05:00\n  searchbase=\"dc=example,dc=net\"\n  scope=sub\n  retry=\"5 10 30 +\n__EOD__\n\nsudo ldapmodify <<__EOD__\ndn: olcDatabase={2}hdb,cn=config\nchangetype: modify\nadd: olcMirrorMode\nolcMirrorMode: TRUE\n__EOD__\n\nsudo ldapmodify <<__EOD__\ndn: olcDatabase={3}hdb,cn=config\nchangetype: modify\nadd: olcMirrorMode\nolcMirrorMode: TRUE\n__EOD__\n\n\n\u30e6\u30fc\u30b6\u30fc\u3001\u30b0\u30eb\u30fc\u30d7\u3092\u767b\u9332\u3057\u3066\u307f\u308b\nsudo ldapadd <<__EOD__\ndn: uid=user01,ou=People,dc=example,dc=com\nobjectClass: person\nobjectClass: inetorgperson\nobjectClass: organizationalperson\nobjectClass: top\nuserPassword: {SSHA}OLoVlITmijyBebCFt8f9UfC+w3ikhDTK\nmail: user01@example.com\ngivenName: Taro\nuid: user01\ncn: Taro Yamada\nsn: Yamada\n\ndn: cn=group01,ou=Group,dc=example,dc=com\nobjectClass: groupOfUniqueNames\nobjectClass: top\ndescription:: dGVzdCBncm91cAo=\ncn: group01\nuniqueMember: uid=user01,ou=People,dc=example,dc=com\n__EOD__\n\n2\u53f0\u306e\u30b5\u30fc\u30d0\u30fc\u3067\u691c\u7d22\u3057\u3066\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u304c\u3046\u307e\u304f\u52d5\u4f5c\u3057\u3066\u3044\u308b\u304b\u3092\u78ba\u8a8d\u3059\u308b\nldapsearch -b dc=example,dc=com uid=user01\nldapsearch -b dc=example,dc=com cn=group01\n\n\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u304c\u3046\u307e\u304f\u52d5\u4f5c\u3057\u3066\u3044\u306a\u304b\u3063\u305f\u3089 firewalld \u306e\u8a2d\u5b9a\u3092\u78ba\u8a8d\u3057\u3066\u307f\u307e\u3057\u3087\u3046\nsudo firewall-cmd --list-all\n\nservices \u306b ldap, ldaps \u304c\u5165\u3063\u3066\u3044\u306a\u304b\u3063\u305f\u3089\u8ffd\u52a0\u3057\u307e\u3059\nsudo firewall-cmd --add-service=ldap\nsudo firewall-cmd --add-service=ldap --permanent\nsudo firewall-cmd --add-service=ldaps\nsudo firewall-cmd --add-service=ldaps --permanent\n\n\u30ed\u30b0\u3082\u78ba\u8a8d\nsudo journalctl -aru slapd | less\n\n\n\u30b5\u30a4\u30ba\u5236\u9650\n\u5909\u3048\u308b\u5fc5\u8981\u306f\u306a\u3044\u304b\u3082\u3057\u308c\u306a\u3044\u304c\u3001\u691c\u7d22\u3067\u5168\u4ef6\u8868\u793a\u3055\u305b\u3088\u3046\u3068\u601d\u3063\u3066\u3082\u5236\u9650\u306b\u304b\u304b\u3063\u3066\u4e00\u90e8\u3057\u304b\u51fa\u529b\u3055\u308c\u306a\u3044\u306e\u3067\u5236\u9650\u3092\u7de9\u548c\u3059\u308b\nsudo ldapmodify <<__EOD__\ndn: cn=config\nchangetype: modify\nreplace: olcSizeLimit\nolcSizeLimit: 3000\n__EOD__\n\n\nphpLDAPadmin \u306e\u8a2d\u5b9a\nphpLDAPadmin \u306f EPEL \u30ea\u30dd\u30b8\u30c8\u30ea\u304b\u3089\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3067\u304d\u307e\u3059\nsudo yum -y install epel-release\nsudo yum -y install phpldapadmin\n\n\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u304c /etc/phpldapadmin/config.php \u306b\u3042\u308a\u307e\u3059\n\nbase \u6307\u5b9a\n\u30de\u30eb\u30c1\u30c9\u30e1\u30a4\u30f3\u74b0\u5883\u3067\u5229\u7528\u3059\u308b\u5834\u5408\u305d\u308c\u305e\u308c\u306e base \u3092\u6307\u5b9a\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\n$servers->setValue('server','base',array('dc=example,dc=com', 'dc=example,dc=net'));\n\n\n\u4e0d\u8981\u306a\u8b66\u544a\u306e\u6291\u5236\n\u671f\u5f85\u3059\u308b\u30b9\u30ad\u30fc\u30de\u304c\u7121\u3044\u3068\u8b66\u544a\u304c\u8868\u793a\u3055\u308c\u3066\u3061\u3087\u3063\u3068\u3046\u308b\u3055\u3044\u306e\u3067\u8868\u793a\u3057\u306a\u3044\u3088\u3046\u306b\u3057\u307e\u3059\n$config->custom->appearance['hide_template_warning'] = true;\n\n\n\u30ed\u30b0\u30a4\u30f3ID\u8a2d\u5b9a\nuid \u3060\u3051\u3067\u30ed\u30b0\u30a4\u30f3\u3059\u308b\u306b\u306f\u6b21\u306e\u3088\u3046\u306b\u3057\u307e\u3059\u304c\u3001\u4e21\u65b9\u306e\u30c9\u30e1\u30a4\u30f3\u306b\u5b58\u5728\u3059\u308b uid \u306e\u5834\u5408\u306b\u3069\u3061\u3089\u304b\u306e\u30c9\u30e1\u30a4\u30f3\u3067\u3057\u304b\u30ed\u30b0\u30a4\u30f3\u3067\u304d\u307e\u305b\u3093\n$servers->setValue('login','attr','uid');\n$servers->setValue('login','base',array('ou=people,dc=example,dc=com', 'ou=people,dc=example,dc=net'));\n\n\u305d\u306e\u305f\u3081 dn \u3067 ID \u6307\u5b9a\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\nID \u306b uid=user01,ou=people,dc=example,dc=com \u3068\u5165\u529b\u3057\u307e\u3059\n$servers->setValue('login','attr','dn');\n\n\n\u4e00\u610f\u6027\u5236\u7d04\nOpenLDAP \u3068\u306f\u5225\u306b Unique \u5236\u7d04\u306e\u8a2d\u5b9a\u304c\u3042\u308a\u307e\u3059\u3002\u30c7\u30d5\u30a9\u30eb\u30c8\u3067 mail, uid, uidNumber \u306b\u5236\u7d04\u304c\u304b\u304b\u3063\u3066\u3044\u307e\u3059\u304c\u3001\u30c9\u30e1\u30a4\u30f3\u3092\u307e\u305f\u3044\u3067\u306e\u5236\u7d04\u3068\u306a\u3063\u3066\u304a\u308a\u3001uid=user01,ou=people,dc=example,dc=com \u304c\u5b58\u5728\u3059\u308b\u3068 uid=user01,ou=people,dc=example,dc=net \u304c\u767b\u9332\u3067\u304d\u307e\u305b\u3093\u3002\u305d\u3053\u3067\u3053\u306e\u8a2d\u5b9a\u3092 mail \u3060\u3051\u306b\u5909\u66f4\u3057\u307e\u3059\u3002\n$servers->setValue('unique','attrs',array('mail'));\n\n\n\u30a2\u30af\u30bb\u30b9\u5236\u9650\nyum \u3067 phpldapadmin \u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u305f\u5834\u5408\u3001\u30c7\u30d5\u30a9\u30eb\u30c8\u3067\u306f localhost \u304b\u3089\u3057\u304b\u30a2\u30af\u30bb\u30b9\u3067\u304d\u306a\u3044\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u308b\u305f\u3081 /etc/httpd/conf.d/phpldapadmin.conf \u3092\u7de8\u96c6\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\n\n\u304a\u307e\u3051\nOpenDJ \u3068\u3044\u3046 LDAP \u30b5\u30fc\u30d0\u30fc\u3092\u975e\u7279\u6a29\u30e6\u30fc\u30b6\u30fc\u3067\u4f7f\u3063\u3066\u3044\u305f\u305f\u3081\u3001\u65e2\u5b58\u30b5\u30fc\u30d0\u30fc\u306f 1389/tcp \u3068 1636/tcp \u3092 Listen \u3057\u3066\u3044\u307e\u3059\u3002\n\u3053\u308c\u3092\u30b9\u30e0\u30fc\u30ba\u306b\u79fb\u884c\u3055\u305b\u308b\u305f\u3081 iptables (firewalld) \u306b redirect \u306e\u8a2d\u5b9a\u3092\u3057\u3066\u307f\u307e\u3059\u3002\n\n/etc/firewalld/direct.xml\n<?xml version=\"1.0\" encoding=\"utf-8\"?>\n<direct>\n    <rule ipv=\"ipv4\" table=\"nat\" chain=\"PREROUTING\" priority=\"0\">-p tcp --dport 1389 -j REDIRECT --to-port 389</rule>\n    <rule ipv=\"ipv4\" table=\"nat\" chain=\"PREROUTING\" priority=\"0\">-p tcp --dport 1636 -j REDIRECT --to-port 636</rule>\n</direct>\n\n\nlocalhost \u304b\u3089\u306e\u30a2\u30af\u30bb\u30b9\u3067\u306f OUTPUT \u306b\u66f8\u304b\u306a\u3044\u3068\u30c0\u30e1\u3089\u3057\u3044\u3067\u3059\u304c\u3001\u5916\u90e8\u304b\u3089\u306e\u30a2\u30af\u30bb\u30b9\u3057\u304b\u306a\u3044\u306e\u3067\u3053\u308c\u3060\u3051\u3067\u826f\u3044\u3067\u3057\u3087\u3046\u3002\n\nLDAP\u30b5\u30fc\u30d0\u30fcOpenDJ\u3092\u4f7f\u304a\u3046(1)\nLDAP\u30b5\u30fc\u30d0\u30fcOpenDJ\u3092\u4f7f\u304a\u3046(2)\n\nCentOS 7 \u3067 OpenLDAP \u30b5\u30fc\u30d0\u30fc2\u53f0\u3092\u30de\u30eb\u30c1\u30de\u30b9\u30bf\u69cb\u6210\u3067\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u3059\u308b\u65b9\u6cd5\u3067\u3059\nexample.com \u3068 example.net \u306e\u30de\u30eb\u30c1\u30c9\u30e1\u30a4\u30f3\u3067\u69cb\u6210\u3057\u307e\u3059\nSSL / TLS \u5bfe\u5fdc\u3082\u3055\u305b\u307e\u3059\n\n## \u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n```bash\nsudo yum -y install openldap-servers openldap-clients\n```\n\n## \u521d\u671f\u5316\n\n\u3084\u308a\u76f4\u3059\u3068\u304d\u306f\u3053\u3053\u304b\u3089\n\n```bash\nsudo systemctl stop slapd\nsudo rm -fr /etc/openldap/slapd.d/cn=config/olcDatabase={2}hdb{,.ldif}\nsudo rm -fr /etc/openldap/slapd.d/cn=config/olcDatabase={3}hdb{,.ldif}\nsudo rm -fr /var/lib/ldap\nsudo install -d -o ldap -g ldap -m 0700 /var/lib/ldap\nsudo install -d -o ldap -g ldap -m 0700 /var/lib/ldap/example.com\nsudo install -d -o ldap -g ldap -m 0700 /var/lib/ldap/example.net\nsudo systemctl start slapd\n```\n\n## \u30c7\u30d5\u30a9\u30eb\u30c8\u306e URI \u3092\u8a2d\u5b9a\n\n\u4eca\u5f8c\u306e\u4f5c\u696d\u3092\u697d\u306b\u3059\u308b\u305f\u3081\u3001\u30c7\u30d5\u30a9\u30eb\u30c8\u306e URI \u3092\u8a2d\u5b9a\u3057\u307e\u3059\n`/etc/openldap/ldap.conf` \u306b\n\n```\nURL ldapi://\n```\n\n\u3092\u8a2d\u5b9a\u3057\u307e\u3059\u3002\u3053\u306e URI \u3067\u30a2\u30af\u30bb\u30b9\u3059\u308c\u3070 root \u306a\u3089\u306a\u3093\u3067\u3082\u3067\u304d\u307e\u3059\u3002\n\n## LogLevel \u8a2d\u5b9a\n\n```bash\nsudo ldapmodify <<__EOD__\ndn: cn=config\nchangetype: modify\nreplace: olcLogLevel\nolcLogLevel: config stats sync conns\n__EOD__\n```\n\nsystemd \u3067\u306e\u30ed\u30b0\u78ba\u8a8d\u306f `journalctl -aru slapd | less` \u3042\u305f\u308a\u3067\u3002\n\n## my-domain.com \u306e\u4fee\u6b63\n\nyum \u3067\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u305f\u5834\u5408\u306e\u30b5\u30f3\u30d7\u30eb\u8a2d\u5b9a\u304c my-domain.com \u306a\u306e\u3067 example.com \u306b\u5909\u66f4\n\n```bash\nsudo ldapmodify <<__EOD__\ndn: olcDatabase={1}monitor,cn=config\nchangetype: modify\nreplace: olcAccess\nolcAccess: to * by dn.base=\"gidNumber=0+uidNumber=0,cn=peercred,cn=external\n ,cn=auth\" read by dn.base=\"cn=Manager,dc=example,dc=com\" read by * none\n__EOD__\n```\n\n\u78ba\u8a8d\n\n```\nsudo ldapsearch -b cn=config olcDatabase=monitor\n```\n\n## \u30b9\u30ad\u30fc\u30de\u306e\u30a4\u30f3\u30dd\u30fc\u30c8\n\n```bash\nsudo ldapadd -f /etc/openldap/schema/cosine.ldif\nsudo ldapadd -f /etc/openldap/schema/inetorgperson.ldif\n```\n\nposix \u30a2\u30ab\u30a6\u30f3\u30c8\u306a\u3069\u5fc5\u8981\u3067\u3042\u308c\u3070\u305d\u308c (nis.ldif ?) \u306a\u3069\u3082\n\n\u3053\u308c\u306f /etc/openldap/slapd.d/cn=config/cn=schema/ \u306b\u4fdd\u5b58\u3055\u308c\u308b\u306e\u3067 /var/lib/ldap/* \u306e\u524a\u9664\u3067\u306f\u6d88\u3048\u307e\u305b\u3093\n\n## example.com, example.net \u7528\u306e\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u4f5c\u6210\n\n```bash\nsudo ldapadd <<__EOD__\ndn: olcDatabase={2}hdb,cn=config\nobjectClass: olcDatabaseConfig\nobjectClass: olcHdbConfig\nolcDatabase: {2}hdb\nolcDbDirectory: /var/lib/ldap/example.com\nolcSuffix: dc=example,dc=com\nolcRootDN: cn=Manager,dc=example,dc=com\nolcAccess: to * by dn.base=\"gidNumber=0+uidNumber=0,cn=peercred,cn=external\n ,cn=auth\" manage by * none\nolcAccess: to dn.subtree=\"\" by * read\n__EOD__\n```\n\n```bash\nsudo ldapadd <<__EOD__\ndn: olcDatabase={3}hdb,cn=config\nobjectClass: olcDatabaseConfig\nobjectClass: olcHdbConfig\nolcDatabase: {3}hdb\nolcDbDirectory: /var/lib/ldap/example.net\nolcSuffix: dc=example,dc=net\nolcRootDN: cn=Manager,dc=example,dc=net\nolcAccess: to * by dn.base=\"gidNumber=0+uidNumber=0,cn=peercred,cn=external\n ,cn=auth\" manage by * none\nolcAccess: to dn.subtree=\"\" by * read\n__EOD__\n```\n\nolcDatabase={2}hdb, olcDatabase={3}hdb \u3068\u6570\u5b57\u90e8\u5206\u3092\u660e\u793a\u3059\u308b\u3068\u3053\u308d\u3068\u30c9\u30e1\u30a4\u30f3\u3054\u3068\u306b\u5225\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea (olcDbDirectory) \u3092\u6307\u5b9a\u3059\u308b\u3068\u3053\u308d\u304c\u30dd\u30a4\u30f3\u30c8\n\n## \u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306e\u30c1\u30e5\u30fc\u30cb\u30f3\u30b0\n\n\u5024\u306f\u306a\u3093\u3068\u306a\u304f\u3067\u3059\n\n```bash\nsudo ldapmodify <<__EOD__\ndn: olcDatabase={2}hdb,cn=config\nchangetype: modify\nadd: olcDbConfig\nolcDbConfig: set_cachesize 0 67108864 1\nolcDbConfig: set_lg_dir .\nolcDbConfig: set_lg_bsize 33554432\nolcDbConfig: set_lk_max_objects 3000\nolcDbConfig: set_lk_max_locks 3000\nolcDbConfig: set_lk_max_lockers 3000\nolcDbConfig: set_flags DB_LOG_AUTOREMOVE\n__EOD__\n```\n\n```bash\nsudo ldapmodify <<__EOD__\ndn: olcDatabase={3}hdb,cn=config\nchangetype: modify\nadd: olcDbConfig\nolcDbConfig: set_cachesize 0 67108864 1\nolcDbConfig: set_lg_dir .\nolcDbConfig: set_lg_bsize 33554432\nolcDbConfig: set_lk_max_objects 3000\nolcDbConfig: set_lk_max_locks 3000\nolcDbConfig: set_lk_max_lockers 3000\nolcDbConfig: set_flags DB_LOG_AUTOREMOVE\n__EOD__\n```\n\n## \u30c9\u30e1\u30a4\u30f3\u4f5c\u6210\u3068 RootDN \u30a2\u30ab\u30a6\u30f3\u30c8\u4f5c\u6210\n\n\u3053\u306e\u4f8b\u306e\u30d1\u30b9\u30ef\u30fc\u30c9\u306f `2h6R&9QE-6`\n\n```bash\nsudo ldapadd <<__EOD__\ndn: dc=example,dc=com\ndc: example\no: \"Example, Inc.\"\nobjectClass: dcObject\nobjectClass: organization\n\ndn: cn=Manager,dc=example,dc=com\nobjectClass: organizationalRole\nobjectClass: simpleSecurityObject\ncn: Manager\nuserPassword: {SSHA}T6fIJME1FHwKEuS9MG7BBhYU6TYLGRnX\n__EOD__\n```\n\n```bash\nsudo ldapadd <<__EOD__\ndn: dc=example,dc=net\ndc: example\no: \"Example, ltd.\"\nobjectClass: dcObject\nobjectClass: organization\n\ndn: cn=Manager,dc=example,dc=net\nobjectClass: organizationalRole\nobjectClass: simpleSecurityObject\ncn: Manager\nuserPassword: {SSHA}T6fIJME1FHwKEuS9MG7BBhYU6TYLGRnX\n__EOD__\n```\n\n`{SSHA}` \u3067\u59cb\u307e\u308b\u30d1\u30b9\u30ef\u30fc\u30c9\u306e\u30cf\u30c3\u30b7\u30e5\u5024\u306f `slappasswd` \u30b3\u30de\u30f3\u30c9\u3067\u751f\u6210\u3067\u304d\u307e\u3059\n\n```bash\n$ slappasswd\nNew password: \u30d1\u30b9\u30ef\u30fc\u30c9\nRe-enter new password: \u30d1\u30b9\u30ef\u30fc\u30c9\n{SSHA}T6fIJME1FHwKEuS9MG7BBhYU6TYLGRnX\n```\n\n## OU \u4f5c\u6210\n\n\u3068\u308a\u3042\u3048\u305a People \u3068 Group \u3092\u4f5c\u6210\u3057\u307e\u3059\u3002(People \u306b\u5bfe\u5fdc\u3059\u308b\u306e\u306f Groups \u3058\u3083\u306a\u3044\u306e\u304b\uff1f\u3068\u601d\u3044\u3064\u3064)\n\n```bash\nsudo ldapadd <<__EOD__\ndn: ou=People,dc=example,dc=com\nou: People\nobjectClass: organizationalUnit\n\ndn: ou=Group,dc=example,dc=com\nou: Group\nobjectClass: organizationalUnit\n\ndn: ou=People,dc=example,dc=net\nou: People\nobjectClass: organizationalUnit\n\ndn: ou=Group,dc=example,dc=net\nou: Group\nobjectClass: organizationalUnit\n__EOD__\n```\n\n## ACL \u8a2d\u5b9a\n\n```bash\nsudo ldapmodify <<__EOD__\ndn: olcDatabase={2}hdb,cn=config\nreplace: olcAccess\nolcAccess: to * by dn.base=\"gidNumber=0+uidNumber=0,cn=peercred,cn=external\n ,cn=auth\" manage by * break\nolcAccess: to attrs=userPassword\n           by anonymous auth\n           by self write\n           by dn.exact=\"cn=Replication,dc=example,dc=com\" read\n           by dn.regex=\"uid=(user001|user002|user003),ou=People,dc=example,dc=com\" write\n           by group/groupOfUniqueNames/uniqueMember.exact=\"cn=Administrators,ou=Groups,dc=example,dc=com\" write\n           by * none\nolcAccess: to *\n           by dn.regex=\"uid=(user001|user002|user003),ou=People,dc=example,dc=com\" write\n           by group/groupOfUniqueNames/uniqueMember.exact=\"cn=Administrators,ou=Groups,dc=example,dc=com\" write\n           by * read\n__EOD__\n```\n\n```bash\nsudo ldapmodify <<__EOD__\ndn: olcDatabase={3}hdb,cn=config\nreplace: olcAccess\nolcAccess: to * by dn.base=\"gidNumber=0+uidNumber=0,cn=peercred,cn=external\n ,cn=auth\" manage by * break\nolcAccess: to attrs=userPassword\n           by anonymous auth\n           by self write\n           by dn.exact=\"cn=Replication,dc=example,dc=net\" read\n           by dn.regex=\"uid=(user001|user002|user003),ou=People,dc=example,dc=net\" write\n           by group/groupOfUniqueNames/uniqueMember.exact=\"cn=Administrators,ou=Groups,dc=example,dc=net\" write\n           by * none\nolcAccess: to *\n           by dn.regex=\"uid=(user001|user002|user003),ou=People,dc=example,dc=net\" write\n           by group/groupOfUniqueNames/uniqueMember.exact=\"cn=Administrators,ou=Groups,dc=example,dc=net\" write\n           by * read\n__EOD__\n```\n\n* user001, user002, user003 \u3082\u3057\u304f\u306f Administrators \u30b0\u30eb\u30fc\u30d7\u306b\u6240\u5c5e\u3059\u308b\u30e1\u30f3\u30d0\u30fc\u306f\u5404\u30a8\u30f3\u30c8\u30ea\u306e\u66f8\u304d\u63db\u3048\u3084\u65b0\u898f\u30a8\u30f3\u30c8\u30ea\u306e\u8ffd\u52a0\u304c\u53ef\u80fd\n* \u30d1\u30b9\u30ef\u30fc\u30c9\u4ee5\u5916\u306e\u53c2\u7167\u3067\u3042\u308c\u3070\u8ab0\u3067\u3082\u53ef\u80fd\n* \u30d1\u30b9\u30ef\u30fc\u30c9\u306f\u8a8d\u8a3c\u3067\u306e\u5229\u7528\u304b\u3001\u672c\u4eba\u304c\u8a8d\u8a3c\u5f8c\u306b\u5909\u66f4\u3059\u308b\u3053\u3068\u306f\u53ef\u80fd\n* Replication (\u5f8c\u3067\u8a2d\u5b9a\u3059\u308b) \u7528\u30e6\u30fc\u30b6\u30fc\u306f\u30d1\u30b9\u30ef\u30fc\u30c9\u3092\u53c2\u7167\u53ef\u80fd\n\n## \u8a8d\u8a3c\u30c6\u30b9\u30c8\n\n\u3053\u3053\u3089\u3067\u8a8d\u8a3c\u306e\u30c6\u30b9\u30c8\u3092\u3057\u3066\u307f\u307e\u3059\n\n```bash\nldapsearch -x -D \"cn=Manager,dc=example,dc=com\" -H ldap://localhost/ -W\n```\n\n```bash\nldapsearch -x -D \"cn=Manager,dc=example,dc=net\" -H ldap://localhost/ -W\n```\n\n\u3069\u3061\u3089\u3067\u3082\u8a8d\u8a3c\u3067\u304d\u305f\u3067\u3057\u3087\u3046\u304b\n\n\n## \u4e00\u610f\u6027\u5236\u7d04\n\n\u30e1\u30fc\u30eb\u30c9\u30ec\u30b9\u3084 uid \u306e\u91cd\u8907\u767b\u9332\u3092\u8a31\u5bb9\u3057\u306a\u3044\u3088\u3046\u306b Unique \u5236\u7d04\u3092\u3064\u3051\u307e\u3059\n\n```bash\nsudo ldapadd <<__EOD__\ndn: cn=module,cn=config\ncn: module\nobjectClass: olcModuleList\nolcModulePath: /usr/lib64/openldap/\nolcModuleLoad: unique.la\n__EOD__\n```\n\n\u30e2\u30b8\u30e5\u30fc\u30eb\u306e\u5b9a\u7fa9\u306f `/etc/openldap/slapd.d/cn=config/cn=module{N}.ldif` \u306b\u66f8\u304b\u308c\u308b\u306e\u3067 `/var/lib/ldap/*` \u3092\u6d88\u3057\u3066\u3082\u6b8b\u308a\u307e\u3059\n\n```bash\nsudo ldapadd <<__EOD__\ndn: olcOverlay=unique,olcDatabase={2}hdb,cn=config\nobjectClass: olcOverlayConfig\nobjectClass: olcUniqueConfig\nolcOverlay: unique\nolcUniqueUri: ldap:///ou=People,dc=example,dc=com?uid?sub\nolcUniqueUri: ldap:///ou=People,dc=example,dc=com?mail?sub\n__EOD__\n```\n\n```bash\nsudo ldapadd <<__EOD__\ndn: olcOverlay=unique,olcDatabase={3}hdb,cn=config\nobjectClass: olcOverlayConfig\nobjectClass: olcUniqueConfig\nolcOverlay: unique\nolcUniqueUri: ldap:///ou=People,dc=example,dc=net?uid?sub\nolcUniqueUri: ldap:///ou=People,dc=example,dc=net?mail?sub\n__EOD__\n```\n\n## \u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u4f5c\u6210\n\n\u6027\u80fd\u5411\u4e0a\u306e\u305f\u3081\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u6642\u306b\u3082\u4f7f\u308f\u308c\u307e\u3059\u3002\n\n```bash\nsudo ldapmodify <<__EOD__\ndn: olcDatabase={2}hdb,cn=config\nchangetype: modify\nadd: olcDbIndex\nolcDbIndex: uid pres,eq,sub\n-\nadd: olcDbIndex\nolcDbIndex: ou pres,eq,sub\n-\nadd: olcDbIndex\nolcDbIndex: mail pres,eq,sub\n-\nadd: olcDbIndex\nolcDbIndex: objectClass eq\n-\nadd: olcDbIndex\nolcDbIndex: entryCSN eq\n-\nadd: olcDbIndex\nolcDbIndex: entryUUID eq\n__EOD__\n\nsudo ldapmodify <<__EOD__\ndn: olcDatabase={3}hdb,cn=config\nchangetype: modify\nadd: olcDbIndex\nolcDbIndex: uid pres,eq,sub\n-\nadd: olcDbIndex\nolcDbIndex: ou pres,eq,sub\n-\nadd: olcDbIndex\nolcDbIndex: mail pres,eq,sub\n-\nadd: olcDbIndex\nolcDbIndex: objectClass eq\n-\nadd: olcDbIndex\nolcDbIndex: entryCSN eq\n-\nadd: olcDbIndex\nolcDbIndex: entryUUID eq\n__EOD__\n```\n\n## SSL / TLS \u8a2d\u5b9a\n\n### \u8a3c\u660e\u66f8\u8a2d\u5b9a\n\nMozilla \u306e Network Security Services (NSS) \u30c4\u30fc\u30eb\u3092\u4f7f\u3046\u4f8b\u304c\u3042\u3063\u305f\u308a\u3059\u308b\u306e\u3067\u3059\u304c\u3001\u624b\u6301\u3061\u306e PEM \u3092\u4f7f\u3046\u65b9\u6cd5\u304c\u3088\u304f\u308f\u304b\u3089\u306a\u304b\u3063\u305f\u305f\u3081\u3001PEM \u30d5\u30a1\u30a4\u30eb\u3092\u305d\u306e\u307e\u307e\u4f7f\u3044\u307e\u3059\u3002\n\ncertutil \u3067\u4f5c\u3089\u308c\u3066\u3044\u308b\u30d5\u30a1\u30a4\u30eb\u3092\u524a\u9664\n\n```bash\nsudo rm /etc/openldap/certs/*\n```\n\n\u624b\u6301\u3061\u306e\u8a3c\u660e\u66f8\u304c\u306a\u3051\u308c\u3070\u81ea\u5df1\u7f72\u540d\u306e\u8a3c\u660e\u66f8\u3092\u4f5c\u6210\n\n```bash\nsudo openssl req -x509 -days 3650 -out /etc/openldap/certs/server.crt \\\n   -newkey rsa:2048 -keyout /etc/openldap/certs/server.key -nodes \\\n   -subj \"/C=JP/ST=Tokyo/L=Minato-ku/O=Example, Inc./CN=ldap.example.com/emailAddress=test@example.com\"\n```\n\n`/etc/openldap/certs/ca.crt` \u306b\u4e2d\u9593\u8a3c\u660e\u66f8\u3092 `/etc/openldap/certs/server.crt` \u306b\u30b5\u30fc\u30d0\u30fc\u8a3c\u660e\u66f8\u3092 `/etc/openldap/certs/server.key` \u306b\u79d8\u5bc6\u9375\u3092\u7f6e\u304d\u307e\u3059\u3002\n\u79d8\u5bc6\u9375\u306f ldap \u30e6\u30fc\u30b6\u30fc\u3060\u3051\u304c\u8aad\u3081\u308c\u3070\u826f\u3044\u306e\u3067\n\n```bash\nsudo chown ldap:ldap /etc/openldap/certs/server.key\nsudo chmod 400 /etc/openldap/certs/server.key\n```\n\n```bash\nsudo ldapmodify <<__EOD__\ndn: cn=config\nchangetype: modify\ndelete: olcTLSCACertificatePath\n-\nreplace: olcTLSCertificateFile\nolcTLSCertificateFile: /etc/openldap/certs/server.crt\n-\nreplace: olcTLSCertificateKeyFile\nolcTLSCertificateKeyFile: /etc/openldap/certs/server.key\n-\nreplace: olcTLSProtocolMin\nolcTLSProtocolMin: 3.1\n__EOD__\n```\n\n\u4e2d\u9593\u8a3c\u660e\u66f8\u304c\u5fc5\u8981\u306a\u5834\u5408\u306f\u3053\u3061\u3089\u3082\n\n```bash\nsudo ldapmodify <<__EOD__\ndn: cn=config\nchangetype: modify\nreplace: olcTLSCACertificateFile\nolcTLSCACertificateFile: /etc/openldap/certs/ca.crt\n__EOD__\n```\n\n\u78ba\u8a8d\n\n```bash\nsudo ldapsearch -b cn=config objectClass=olcGlobal\n```\n\nPEM \u30d5\u30a1\u30a4\u30eb\u3092\u66f4\u65b0\u3057\u305f\u3089 slapd \u306e\u518d\u8d77\u52d5\u304c\u5fc5\u8981\u3067\u3059\n\n\u304c\u3001\u305d\u306e\u524d\u306b ldaps (636) \u30dd\u30fc\u30c8\u3092 Listen \u3059\u308b\u3088\u3046\u306b `/etc/sysconfig/slapd` \u3092\u66f8\u304d\u63db\u3048\u307e\u3059\n(SLAP_URLS \u306b ldaps:/// \u3092\u8ffd\u52a0)\n\n```bash\nsudo sed -i -e 's#SLAPD_URLS=\"ldapi:/// ldap:///\"#SLAPD_URLS=\"ldapi:/// ldap:/// ldaps:///\"#' /etc/sysconfig/slapd\n```\n\n## slapd \u306e\u518d\u8d77\u52d5\n\n```bash\nsudo systemctl restart slapd\n```\n\n\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u5074\u306e\u8a2d\u5b9a\u3068\u306a\u308a\u307e\u3059\u304c `/etc/openldap/ldap.conf` \u3067 `TLS_REQCERT allow` \u3068\u6307\u5b9a\u3057\u306a\u3044\u5834\u5408\u3001ldapsearch \u30b3\u30de\u30f3\u30c9\u306a\u3069\u3067\u3044\u308f\u3086\u308b\u30aa\u30ec\u30aa\u30ec\u8a3c\u660e\u66f8\uff08\u81ea\u5df1\u7f72\u540d\uff09\u30b5\u30a4\u30c8\u306a\u3069\u306b\u30a2\u30af\u30bb\u30b9\u3067\u304d\u306a\u304f\u306a\u308a\u307e\u3059\u3002\n`TLS_CACERT /etc/pki/tls/certs/ca-bundle.crt` \u3068\u3057\u3066\u304a\u304f\u3068\u4e00\u822c\u7684\u306a\u8a3c\u660e\u6a5f\u95a2\u3067\u767a\u884c\u3055\u308c\u305f\u30b5\u30fc\u30d0\u30fc\u3078\u306e\u63a5\u7d9a\u304c\u53ef\u80fd\u3068\u306a\u308a\u307e\u3059\u3002\n\n### \u30c6\u30b9\u30c8\n\n```bash\nldapsearch -x -H ldaps://localhost/ -W -D cn=Manager,dc=example,dc=com -b dc=example,dc=com cn=Manager\n```\n\n```bash\nopenssl s_client -connect localhost:636\n```\n\nopenssl \u30b3\u30de\u30f3\u30c9\u3067\u63a5\u7d9a\u3067\u304d\u308b\u306e\u306b ldapsearch \u3067\u63a5\u7d9a\u3067\u304d\u306a\u3044\u5834\u5408\u306f `ldap.conf` \u306e `TLS_REQCERT allow` \u3092\u78ba\u8a8d\n\n## \u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u8a2d\u5b9a\n\n### ServerID \u8a2d\u5b9a\n\nldap1 \u3068 ldap2 \u3068\u3044\u3046\u30b5\u30fc\u30d0\u30fc\u3067\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3059\u308b\u3068\u3057\u307e\u3059\n`olcServerID` \u3092\u30b5\u30fc\u30d0\u30fc\u3054\u3068\u306b\u4e00\u610f\u306b\u8a2d\u5b9a\u3057\u307e\u3059\n\n**ldap1** \u3067\n\n```bash\nsudo ldapmodify <<__EOD__\ndn: cn=config\nchangetype: modify\nreplace: olcServerID\nolcServerID: 1\n__EOD__\n```\n\n**ldap2** \u3067\n\n```bash\nsudo ldapmodify <<__EOD__\ndn: cn=config\nchangetype: modify\nreplace: olcServerID\nolcServerID: 2\n__EOD__\n```\n\n\u3092\u5b9f\u884c\u3057\u307e\u3059\n\n### \u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u7528\u30e6\u30fc\u30b6\u30fc\u4f5c\u6210\n\nACL \u8a2d\u5b9a\u3067\u65e2\u306b\u51fa\u3066\u3044\u307e\u3059\u304c Replication \u3068\u3044\u3046\u30e6\u30fc\u30b6\u30fc(?)\u3092\u4f5c\u6210\u3057\u307e\u3059\n\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306f\u53c2\u7167\u3055\u3048\u3067\u304d\u308c\u3070\u826f\u3044\u305f\u3081 RootDN (Manager) \u3068\u306f\u5225\u306b\u30e6\u30fc\u30b6\u30fc\u3092\u4f5c\u6210\u3057\u307e\u3059\n\n\u3053\u306e\u4f8b\u306e\u30d1\u30b9\u30ef\u30fc\u30c9\u306f `YB)gNF!Q6)`\n\n```bash\nsudo ldapadd <<__EOD__\ndn: cn=Replication,dc=example,dc=com\nobjectClass: organizationalRole\nobjectClass: simpleSecurityObject\ncn: Replication\nuserPassword: {SSHA}bSU9ueMZ93IIlXB7KdiiLby9S0bF0C+J\n__EOD__\n\nsudo ldapadd <<__EOD__\ndn: cn=Replication,dc=example,dc=net\nobjectClass: organizationalRole\nobjectClass: simpleSecurityObject\ncn: Replication\nuserPassword: {SSHA}bSU9ueMZ93IIlXB7KdiiLby9S0bF0C+J\n__EOD__\n```\n\n\u30d1\u30b9\u30ef\u30fc\u30c9\u5909\u66f4\u306f\u6b21\u306e\u3088\u3046\u306b\u3057\u3066\u884c\u3048\u307e\u3059 (-S \u306f\u30d1\u30b9\u30ef\u30fc\u30c9\u5165\u529b\u30d7\u30ed\u30f3\u30d7\u30c8\u8868\u793a\u306e\u6307\u5b9a)\n\n```bash\nsudo ldappasswd -S cn=Replication,dc=example,dc=com\n```\n\n### \u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30e2\u30b8\u30e5\u30fc\u30eb\u767b\u9332\n\n```bash\nsudo ldapadd <<__EOD__\ndn: cn=module,cn=config\nobjectClass: olcModuleList\ncn: module\nolcmodulePath: /usr/lib64/openldap\nolcModuleLoad: syncprov.la\n__EOD__\n```\n\n\u4e00\u610f\u6027(Unique)\u30e2\u30b8\u30e5\u30fc\u30eb\u3068\u540c\u69d8\u306b `/etc/openldap/slapd.d/cn=config/cn=module{N}.ldif` \u306b\u66f8\u304b\u308c\u307e\u3059\n\n### \u30d7\u30ed\u30d0\u30a4\u30c0\u5074\u8a2d\u5b9a\n\n```bash\nsudo ldapadd <<__EOD__\ndn: olcOverlay=syncprov,olcDatabase={2}hdb,cn=config\nobjectClass: olcOverlayConfig\nobjectClass: olcSyncProvConfig\nolcOverlay: syncprov\nolcSpSessionLog: 1000\n__EOD__\n\nsudo ldapadd <<__EOD__\ndn: olcOverlay=syncprov,olcDatabase={3}hdb,cn=config\nobjectClass: olcOverlayConfig\nobjectClass: olcSyncProvConfig\nolcOverlay: syncprov\nolcSpSessionLog: 1000\n__EOD__\n```\n\n### \u30b3\u30f3\u30b7\u30e5\u30fc\u30de\u5074\u8a2d\u5b9a\n\n\u53cc\u65b9\u306e\u30b5\u30fc\u30d0\u30fc\u3067\u3082\u3046\u4e00\u65b9\u306e\u30b5\u30fc\u30d0\u30fc\u3068\u540c\u671f\u3059\u308b\u3088\u3046\u306b\u8a2d\u5b9a\u3059\u308b\n\u53cc\u65b9\u5411\u306e\u305f\u3081(?) oldMirrorMode \u3092\u6709\u52b9\u306b\u3057\u307e\u3059\n\n```bash\nsudo ldapmodify <<__EOD__\ndn: olcDatabase={2}hdb,cn=config\nchangetype: modify\nadd: olcSyncRepl\nolcSyncRepl: rid=001\n  provider=ldap://{\u76f8\u65b9\u30b5\u30fc\u30d0\u30fc}/\n  bindmethod=simple\n  binddn=\"cn=Replication,dc=example,dc=com\"\n  credentials=\"\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30e6\u30fc\u30b6\u30fc\u306e\u30d1\u30b9\u30ef\u30fc\u30c9\"\n  type=refreshAndPersist\n  interval=00:00:05:00\n  searchbase=\"dc=example,dc=com\"\n  scope=sub\n  retry=\"5 10 30 +\n__EOD__\n\nsudo ldapmodify <<__EOD__\ndn: olcDatabase={3}hdb,cn=config\nchangetype: modify\nadd: olcSyncRepl\nolcSyncRepl: rid=002\n  provider=ldap://{\u76f8\u65b9\u30b5\u30fc\u30d0\u30fc}/\n  bindmethod=simple\n  binddn=\"cn=Replication,dc=example,dc=net\"\n  credentials=\"\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30e6\u30fc\u30b6\u30fc\u306e\u30d1\u30b9\u30ef\u30fc\u30c9\"\n  type=refreshAndPersist\n  interval=00:00:05:00\n  searchbase=\"dc=example,dc=net\"\n  scope=sub\n  retry=\"5 10 30 +\n__EOD__\n\nsudo ldapmodify <<__EOD__\ndn: olcDatabase={2}hdb,cn=config\nchangetype: modify\nadd: olcMirrorMode\nolcMirrorMode: TRUE\n__EOD__\n\nsudo ldapmodify <<__EOD__\ndn: olcDatabase={3}hdb,cn=config\nchangetype: modify\nadd: olcMirrorMode\nolcMirrorMode: TRUE\n__EOD__\n```\n\n## \u30e6\u30fc\u30b6\u30fc\u3001\u30b0\u30eb\u30fc\u30d7\u3092\u767b\u9332\u3057\u3066\u307f\u308b\n\n```bash\nsudo ldapadd <<__EOD__\ndn: uid=user01,ou=People,dc=example,dc=com\nobjectClass: person\nobjectClass: inetorgperson\nobjectClass: organizationalperson\nobjectClass: top\nuserPassword: {SSHA}OLoVlITmijyBebCFt8f9UfC+w3ikhDTK\nmail: user01@example.com\ngivenName: Taro\nuid: user01\ncn: Taro Yamada\nsn: Yamada\n\ndn: cn=group01,ou=Group,dc=example,dc=com\nobjectClass: groupOfUniqueNames\nobjectClass: top\ndescription:: dGVzdCBncm91cAo=\ncn: group01\nuniqueMember: uid=user01,ou=People,dc=example,dc=com\n__EOD__\n```\n\n2\u53f0\u306e\u30b5\u30fc\u30d0\u30fc\u3067\u691c\u7d22\u3057\u3066\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u304c\u3046\u307e\u304f\u52d5\u4f5c\u3057\u3066\u3044\u308b\u304b\u3092\u78ba\u8a8d\u3059\u308b\n\n```bash\nldapsearch -b dc=example,dc=com uid=user01\nldapsearch -b dc=example,dc=com cn=group01\n```\n\n\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u304c\u3046\u307e\u304f\u52d5\u4f5c\u3057\u3066\u3044\u306a\u304b\u3063\u305f\u3089 firewalld \u306e\u8a2d\u5b9a\u3092\u78ba\u8a8d\u3057\u3066\u307f\u307e\u3057\u3087\u3046\n\n```bash\nsudo firewall-cmd --list-all\n```\n\n`services` \u306b ldap, ldaps \u304c\u5165\u3063\u3066\u3044\u306a\u304b\u3063\u305f\u3089\u8ffd\u52a0\u3057\u307e\u3059\n\n```bash\nsudo firewall-cmd --add-service=ldap\nsudo firewall-cmd --add-service=ldap --permanent\nsudo firewall-cmd --add-service=ldaps\nsudo firewall-cmd --add-service=ldaps --permanent\n```\n\n\u30ed\u30b0\u3082\u78ba\u8a8d\n\n```bash\nsudo journalctl -aru slapd | less\n```\n\n## \u30b5\u30a4\u30ba\u5236\u9650\n\n\u5909\u3048\u308b\u5fc5\u8981\u306f\u306a\u3044\u304b\u3082\u3057\u308c\u306a\u3044\u304c\u3001\u691c\u7d22\u3067\u5168\u4ef6\u8868\u793a\u3055\u305b\u3088\u3046\u3068\u601d\u3063\u3066\u3082\u5236\u9650\u306b\u304b\u304b\u3063\u3066\u4e00\u90e8\u3057\u304b\u51fa\u529b\u3055\u308c\u306a\u3044\u306e\u3067\u5236\u9650\u3092\u7de9\u548c\u3059\u308b\n\n```bash\nsudo ldapmodify <<__EOD__\ndn: cn=config\nchangetype: modify\nreplace: olcSizeLimit\nolcSizeLimit: 3000\n__EOD__\n```\n\n## phpLDAPadmin \u306e\u8a2d\u5b9a\n\n[phpLDAPadmin](http://phpldapadmin.sourceforge.net/wiki/index.php/Main_Page) \u306f EPEL \u30ea\u30dd\u30b8\u30c8\u30ea\u304b\u3089\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3067\u304d\u307e\u3059\n\n```bash\nsudo yum -y install epel-release\nsudo yum -y install phpldapadmin\n```\n\n\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u304c `/etc/phpldapadmin/config.php` \u306b\u3042\u308a\u307e\u3059\n\n### base \u6307\u5b9a\n\n\u30de\u30eb\u30c1\u30c9\u30e1\u30a4\u30f3\u74b0\u5883\u3067\u5229\u7528\u3059\u308b\u5834\u5408\u305d\u308c\u305e\u308c\u306e base \u3092\u6307\u5b9a\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\n\n```php\n$servers->setValue('server','base',array('dc=example,dc=com', 'dc=example,dc=net'));\n```\n\n### \u4e0d\u8981\u306a\u8b66\u544a\u306e\u6291\u5236\n\n\u671f\u5f85\u3059\u308b\u30b9\u30ad\u30fc\u30de\u304c\u7121\u3044\u3068\u8b66\u544a\u304c\u8868\u793a\u3055\u308c\u3066\u3061\u3087\u3063\u3068\u3046\u308b\u3055\u3044\u306e\u3067\u8868\u793a\u3057\u306a\u3044\u3088\u3046\u306b\u3057\u307e\u3059\n\n```php\n$config->custom->appearance['hide_template_warning'] = true;\n```\n\n### \u30ed\u30b0\u30a4\u30f3ID\u8a2d\u5b9a\n\nuid \u3060\u3051\u3067\u30ed\u30b0\u30a4\u30f3\u3059\u308b\u306b\u306f\u6b21\u306e\u3088\u3046\u306b\u3057\u307e\u3059\u304c\u3001\u4e21\u65b9\u306e\u30c9\u30e1\u30a4\u30f3\u306b\u5b58\u5728\u3059\u308b uid \u306e\u5834\u5408\u306b\u3069\u3061\u3089\u304b\u306e\u30c9\u30e1\u30a4\u30f3\u3067\u3057\u304b\u30ed\u30b0\u30a4\u30f3\u3067\u304d\u307e\u305b\u3093\n\n```php\n$servers->setValue('login','attr','uid');\n$servers->setValue('login','base',array('ou=people,dc=example,dc=com', 'ou=people,dc=example,dc=net'));\n```\n\n\u305d\u306e\u305f\u3081 dn \u3067 ID \u6307\u5b9a\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\nID \u306b uid=user01,ou=people,dc=example,dc=com \u3068\u5165\u529b\u3057\u307e\u3059\n\n```php\n$servers->setValue('login','attr','dn');\n```\n\n### \u4e00\u610f\u6027\u5236\u7d04\n\nOpenLDAP \u3068\u306f\u5225\u306b Unique \u5236\u7d04\u306e\u8a2d\u5b9a\u304c\u3042\u308a\u307e\u3059\u3002\u30c7\u30d5\u30a9\u30eb\u30c8\u3067 `mail`, `uid`, `uidNumber` \u306b\u5236\u7d04\u304c\u304b\u304b\u3063\u3066\u3044\u307e\u3059\u304c\u3001\u30c9\u30e1\u30a4\u30f3\u3092\u307e\u305f\u3044\u3067\u306e\u5236\u7d04\u3068\u306a\u3063\u3066\u304a\u308a\u3001`uid=user01,ou=people,dc=example,dc=com` \u304c\u5b58\u5728\u3059\u308b\u3068 `uid=user01,ou=people,dc=example,dc=net` \u304c\u767b\u9332\u3067\u304d\u307e\u305b\u3093\u3002\u305d\u3053\u3067\u3053\u306e\u8a2d\u5b9a\u3092 `mail` \u3060\u3051\u306b\u5909\u66f4\u3057\u307e\u3059\u3002\n\n```php\n$servers->setValue('unique','attrs',array('mail'));\n```\n\n### \u30a2\u30af\u30bb\u30b9\u5236\u9650\n\nyum \u3067 phpldapadmin \u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u305f\u5834\u5408\u3001\u30c7\u30d5\u30a9\u30eb\u30c8\u3067\u306f localhost \u304b\u3089\u3057\u304b\u30a2\u30af\u30bb\u30b9\u3067\u304d\u306a\u3044\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u308b\u305f\u3081 `/etc/httpd/conf.d/phpldapadmin.conf` \u3092\u7de8\u96c6\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\n\n## \u304a\u307e\u3051\n\nOpenDJ \u3068\u3044\u3046 LDAP \u30b5\u30fc\u30d0\u30fc\u3092\u975e\u7279\u6a29\u30e6\u30fc\u30b6\u30fc\u3067\u4f7f\u3063\u3066\u3044\u305f\u305f\u3081\u3001\u65e2\u5b58\u30b5\u30fc\u30d0\u30fc\u306f 1389/tcp \u3068 1636/tcp \u3092 Listen \u3057\u3066\u3044\u307e\u3059\u3002\n\u3053\u308c\u3092\u30b9\u30e0\u30fc\u30ba\u306b\u79fb\u884c\u3055\u305b\u308b\u305f\u3081 iptables (firewalld) \u306b redirect \u306e\u8a2d\u5b9a\u3092\u3057\u3066\u307f\u307e\u3059\u3002\n\n```xml:/etc/firewalld/direct.xml\n<?xml version=\"1.0\" encoding=\"utf-8\"?>\n<direct>\n    <rule ipv=\"ipv4\" table=\"nat\" chain=\"PREROUTING\" priority=\"0\">-p tcp --dport 1389 -j REDIRECT --to-port 389</rule>\n    <rule ipv=\"ipv4\" table=\"nat\" chain=\"PREROUTING\" priority=\"0\">-p tcp --dport 1636 -j REDIRECT --to-port 636</rule>\n</direct>\n```\n\nlocalhost \u304b\u3089\u306e\u30a2\u30af\u30bb\u30b9\u3067\u306f OUTPUT \u306b\u66f8\u304b\u306a\u3044\u3068\u30c0\u30e1\u3089\u3057\u3044\u3067\u3059\u304c\u3001\u5916\u90e8\u304b\u3089\u306e\u30a2\u30af\u30bb\u30b9\u3057\u304b\u306a\u3044\u306e\u3067\u3053\u308c\u3060\u3051\u3067\u826f\u3044\u3067\u3057\u3087\u3046\u3002\n\n* [LDAP\u30b5\u30fc\u30d0\u30fcOpenDJ\u3092\u4f7f\u304a\u3046(1)](http://qiita.com/yteraoka/items/289ae6a1194f96c30db5)\n* [LDAP\u30b5\u30fc\u30d0\u30fcOpenDJ\u3092\u4f7f\u304a\u3046(2)](http://qiita.com/yteraoka/items/bac7cabb9b98eee666ef)\n", "tags": ["openldap2.4"]}