{"context": "\u3053\u306e\u8a18\u4e8b\u306fBitVisor Advent Calendar 17\u65e5\u76ee\u306e\u8a18\u4e8b\u3067\u3059\uff0e(\u307e\u305f\u3057\u3066\u3082\u9045\u523b\u3059\u307f\u307e\u305b\u3093...\nBitVisor\u306eEPT\u30a8\u30f3\u30c8\u30ea\u30fc\u3092\u3044\u3058\u3063\u3066\u7279\u5b9a\u306e\u30c9\u30e9\u30a4\u30d0\u304c\u5b9f\u884c\u3055\u308c\u305f\u6642\u306e\u307fBitVisor\u5074\u306b\u5236\u5fa1\u3092\u623b\u3059\u3088\u3046\u306b\u3057\u3066\u307f\u307e\u3059\u3002\n\nEPT\u6539\u9020\u3067\u3067\u304d\u308b\u4e8b\nBitVisor\u306f\u30b2\u30b9\u30c8OS\u306e\u7269\u7406\u30a2\u30c9\u30ec\u30b9\u3068\u30db\u30b9\u30c8\u306e\u7269\u7406\u30a2\u30c9\u30ec\u30b9\u306e\u5bfe\u5fdc\u3092EPT(Extended Page Table)\u3067\u884c\u3063\u3066\u3044\u307e\u3059\u3002\n\u3053\u308c\u3089EPT\u306e\u30a8\u30f3\u30c8\u30ea\u306b\u306f\u305d\u308c\u305e\u308cR(Read),W(Write),X(Execute)\u306e\u30d1\u30fc\u30df\u30c3\u30b7\u30e7\u30f3\u30d5\u30e9\u30b0\u304c\u8a2d\u5b9a\u3067\u304d\u3001\u3053\u308c\u306b\u3088\u308a\u30b2\u30b9\u30c8OS\u306e\u30da\u30fc\u30b8\u30f3\u30b0\u306e\u30d5\u30e9\u30b0\u3068\u5408\u308f\u305b\u3066\u30a2\u30af\u30bb\u30b9\u6a29\u9650\u3092\u8a2d\u5b9a\u3067\u304d\u307e\u3059\u3002\u3053\u308c\u3092\u5229\u7528\u3059\u308b\u3068\u3001\u30b2\u30b9\u30c8OS\u304b\u3089\u900f\u904e\u306a\u5834\u6240\u3067\u6a29\u9650\u8a2d\u5b9a\u3092\u884c\u3046\u3053\u3068\u304c\u3067\u304d\u308b\u305f\u3081\u3001\u30de\u30eb\u30a6\u30a7\u30a2\u89e3\u6790\u306b\u304a\u3044\u3066\u3001\u4f8b\u3048\u3070rootkit\u304b\u3089\u3082\u898b\u3048\u306a\u3044\u30a2\u30af\u30bb\u30b9\u4fdd\u8b77\u3092\u884c\u3046\u4e8b\u304c\u3067\u304d\u307e\u3059\u3002(\u7d50\u69cb\u6614\u304b\u3089\u3042\u308b\u7814\u7a76\u3067\u3059\u306d)\n\u3055\u3066\u3001\u4eca\u56de\u306f\u3053\u308c\u3092BitVisor\u306b\u3082\u5b9f\u88c5\u3057\u3001\u30b2\u30b9\u30c8OS\u306e\u7279\u5b9a\u306e\u30c9\u30e9\u30a4\u30d0\u9818\u57df\u306eEPT\u30a8\u30f3\u30c8\u30ea\u30fc\u304b\u3089X(Execute)\u30d5\u30e9\u30b0\u3092\u5916\u3059\u4e8b\u3067\u3001\u305d\u306e\u9818\u57df\u3092\u5b9f\u884c\u3057\u3088\u3046\u3068\u3059\u308b\u3068BitVisor\u5074\u306b\u5236\u5fa1\u304c\u623b\u308b\u3088\u3046\u306b\u3057\u3066\u307f\u307e\u3059\u3002\n\nBitVisor\u306eEPT\u30de\u30c3\u30d4\u30f3\u30b0\u51e6\u7406\nBitVisor\u3067\u306fEPT violation\u3057\u305f\u969b\u3001core/vt_ept.c\u3067EPT\u306e\u5404\u30a8\u30f3\u30c8\u30ea\u30fc\u3092\u4f5c\u6210\u3059\u308b\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002\u6ce8\u610f\u3059\u3079\u304d\u70b9\u3068\u3057\u3066\u306f\u3001(\u307e\u3042\u5f53\u7136\u3067\u3059\u304c)\u305d\u308c\u3089\u306e\u30a8\u30f3\u30c8\u30ea\u30fc\u306ftbl(phys)\u3068\u3044\u30461024\u500b\u306e\u914d\u5217\u304b\u3089\u53d6\u3063\u3066\u3053\u3089\u308c\u3001\u3082\u3057\u8db3\u308a\u306a\u304f\u306a\u308b\u3068\u4e00\u65e6\u30af\u30ea\u30a2\u3057\u3066\u3084\u308a\u306a\u304a\u3059\u4ed5\u7d44\u307f\u306b\u306a\u3063\u3066\u3044\u308b\u4e8b\u3067\u3059\u3002\n\u3064\u307e\u308a\u3001\u4eca\u56de\u7279\u5b9a\u306eEPT\u30a8\u30f3\u30c8\u30ea\u30fc\u304b\u3089X flag\u3092\u5916\u3057\u305f\u3044\u306e\u3067\u3059\u304c\u3001\u4eee\u306b\u3069\u3053\u304b\u306e\u30bf\u30a4\u30df\u30f3\u30b0\u3067X flag\u3092\u5916\u3057\u305f\u3068\u3057\u3066\u3082\u3001\u3057\u3070\u3089\u304f\u3057\u3066\u30a8\u30f3\u30c8\u30ea\u30fc\u304c\u3044\u3063\u3071\u3044\u306b\u306a\u308b\u3068\u30af\u30ea\u30a2\u3055\u308c\u3066\u3057\u307e\u3046\u53ef\u80fd\u6027\u304c\u3042\u308b\u3068\u3044\u3046\u4e8b\u3067\u3059\u3002\n\u3088\u3063\u3066\u30af\u30ea\u30a2\u3055\u308c\u305f\u5f8c\u3082X flag\u3092\u5916\u3057\u305f\u72b6\u614b\u3067\u518d\u5272\u5f53\u3066\u3057\u3066\u3082\u3089\u3046\u3088\u3046\u306b\u3001EPT\u306e\u5272\u5f53\u95a2\u6570vt_ept_map_page_sub()\u5185\u3067\u3001\u7279\u5b9a\u306e\u9818\u57df\u5185\u306a\u3089X flag\u3092\u629c\u3044\u3066\u30a8\u30f3\u30c8\u30ea\u30fc\u3092\u4f5c\u6210\u3059\u308b\u3088\u3046\u306b\u6539\u9020\u3057\u307e\u3057\u305f\u3002\ndiff --git a/bitvisor/../../bitvisor/core/vt_ept.c b/bitvisor/core/vt_ept.c\nindex 341e1e2..518e9ce 100644\n--- a/bitvisor/../../bitvisor/core/vt_ept.c\n+++ b/bitvisor/core/vt_ept.c\n\n static void\n vt_ept_map_page_sub (struct vt_ept *ept, bool write, u64 gphys)\n {\n@@ -154,8 +173,16 @@ vt_ept_map_page_sub (struct vt_ept *ept, bool write, u64 gphys)\n    hphys = current->gmm.gp2hp (gphys, &fakerom) & ~PAGESIZE_MASK;\n    if (fakerom && write)\n        panic (\"EPT: Writing to VMM memory.\");\n-   hattr = (cache_get_gmtrr_type (gphys) << EPTE_MT_SHIFT) |\n-       EPTE_READEXEC | EPTE_WRITE;\n+\n+   if (in_hook_point (&hook_point, gphys)) {\n+       hattr = (cache_get_gmtrr_type (gphys) << EPTE_MT_SHIFT) |\n+           EPTE_READ | EPTE_WRITE; // witout EXEC permission\n+       printf(\"remove x-bit from 0x%llx\\n\", gphys);\n+   }\n+   else\n+       hattr = (cache_get_gmtrr_type (gphys) << EPTE_MT_SHIFT) |\n+           EPTE_READEXEC | EPTE_WRITE;\n+\n    if (fakerom)\n        hattr &= ~EPTE_WRITE;\n    *p = hphys | hattr;\n@@ -238,6 +265,37 @@ vt_ept_map_page (struct vt_ept *ept, bool write, u64 gphys)\n }\n\n void\n+vt_ept_set_hook (u64 gphys, u32 size)\n+{\n+   struct vt_ept *ept;\n+   u32 i;\n+   u64 gp;\n+   u64 *m;\n+   hook_point.mod_areas = (u64*)alloc(sizeof *m * size);\n+   hook_point.size = size;\n+   hook_point.available = 1;\n+\n+   ept = current->u.vt.ept;\n+\n+   /* Clearing EPT entries, to hook */\n+   vt_ept_clear_all_slow();\n+\n+   printf(\"vt_ept_set_hook 0x%llx(%d)\\n\", gphys, size);\n+\n+   /* remap address range of kernel module\n+    * TODO: 2M page\n+    */\n+   m = hook_point.mod_areas;\n+\n+   for (i = 0; i < hook_point.size; i++) {\n+       read_gphys_q(gphys + sizeof(u64) * i, (void*)&m[i], 0);\n+       printf(\"ares[%d] = 0x%llx\\n\", i, m[i]);\n+       vt_ept_map_page(ept, false, m[i]);\n+   }\n+\n+}\n+\n\n\n\u30b3\u30a2\u9593\u306e\u30ad\u30e3\u30c3\u30b7\u30e5\u30b3\u30d2\u30fc\u30ec\u30f3\u30b7\n\u3055\u3066\u3001EPT\u30a8\u30f3\u30c8\u30ea\u30fc\u3092\u3044\u3058\u308b\u4e8b\u306f\u3067\u304d\u307e\u3057\u305f\u304c\u3001\u3082\u3046\u3072\u3068\u3064\u6c17\u3092\u4ed8\u3051\u306a\u3051\u308c\u3070\u306a\u3089\u306a\u3044\u306e\u304cTLB(Translation Lookaside Buffer)\u306e\u6271\u3044\u3067\u3059\u3002EPT\u306b\u3088\u308b\u5909\u63db\u306f\u5404\u30b3\u30a2\u306eTLB\u306b\u8f09\u3063\u3066\u3044\u308b\u305f\u3081\u3001\u304b\u308a\u306bX flag\u3092\u629c\u3044\u3066\u3082TLB\u306b\u3042\u308b\u53e4\u3044\u30a8\u30f3\u30c8\u30ea\u30fc\u304c\u4f7f\u308f\u308c\u7d9a\u3051\u308b\u3068\u610f\u5473\u304c\u3042\u308a\u307e\u305b\u3093\u3002\n\u305d\u3053\u3067X flag\u3092\u629c\u304f\u524d\u306b\u3001\u5168\u30b3\u30a2\u306b\u5bfe\u3057\u3066TLB\u3092\u30d5\u30e9\u30c3\u30b7\u30e5\u3059\u308b\u3088\u3046\u306b\u547d\u4ee4\u3057\u307e\u3059\u3002(\u3044\u308f\u3086\u308bTLB shootdown\u3067\u3059)\n\u305d\u3046\u3044\u3048\u3070\u3061\u3087\u3046\u3069\u5c11\u3057\u524d\u306bkernelvm\u52c9\u5f37\u4f1a\u3067deep_tkkn\u3055\u3093\u304cBitVisor\u3067TLB shootdown\u306e\u8a71\u3092\u3055\u308c\u3066\u305f\u306a\u3041\u3068\u601d\u3044\u3001\u305d\u306e\u6642\u306e\u767a\u8868\u8cc7\u6599\u3092\u53c2\u8003\u306b\u3055\u305b\u3066\u9802\u304d\u307e\u3057\u305f\u3002\n   EPT \u3068 TLB \u3067\u3057\u304f\u3058\u3063\u305f\u8a71  from Takaaki Fukai \n\u307e\u305ftwitter\u3067\u611a\u75f4\u3063\u3066\u3044\u305f\u6240\u3001deep_tkkn\u3055\u3093\u306bTLB shootdown\u306e\u30d1\u30c3\u30c1\u3092\u898b\u305b\u3066\u3044\u305f\u3060\u3051\u307e\u3057\u305f\u3002\n\u5727\u5012\u7684\u611f\u8b1dm(_ _)m\n\u5b9f\u88c5\u65b9\u6cd5\u3068\u3057\u3066\u306f\u3001BitVisor\u306f\u5404\u30b3\u30a2\u306b\u5bfe\u3057\u3066IPI\u3067NMI\u3092\u9001\u3063\u3066\u30cf\u30f3\u30c9\u30eb\u3059\u308b\u6a5f\u80fd\u304c\u3042\u308b\u306e\u3067\u305d\u308c\u3092\u5229\u7528\u3057\u3066\u3001NMI\u3068\u3057\u3066shootdown\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u9001\u308a\u3001\u5404\u30b3\u30a2\u306bTLB flush\u3055\u305b\u308b\u7269\u3067\u3059\u3002\n\u3053\u308c\u3067\u3046\u307e\u304f\u884c\u304d\u307e\u3057\u305f\u3002\n\n\u30c9\u30e9\u30a4\u30d0\u306e\u7269\u7406\u30a2\u30c9\u30ec\u30b9\u306e\u6271\u3044\n\u3055\u3066\u3053\u308c\u3067\u5168\u3066\u3046\u307e\u304f\u884c\u3063\u305f\u3088\u3046\u306b\u898b\u3048\u307e\u3059\u304c\u3001\u307e\u3060\u99c4\u76ee\u3067\u3059\u3002\n\u306a\u305c\u304b\u3068\u3044\u3046\u3068\u3001\u305d\u3082\u305d\u3082EPT violation\u3057\u305f\u6642\u306b\u53d6\u5f97\u3067\u304d\u308b\u306e\u306f\u30b2\u30b9\u30c8\u306e\u7269\u7406\u30a2\u30c9\u30ec\u30b9\u306a\u306e\u3067\u3059\u304c\u3001\u30c9\u30e9\u30a4\u30d0\u306e\u30ed\u30fc\u30c9\u3055\u308c\u3066\u3044\u308b\u9818\u57df\u306e\u7269\u7406\u30a2\u30c9\u30ec\u30b9\u306f\u3001\u5b9f\u306f\u9023\u7d9a\u3057\u3066\u3044\u308b\u4fdd\u8a3c\u304c\u3042\u308a\u307e\u305b\u3093\u3002\n\u3053\u308c\u306fLinux\u306e\u5834\u5408\u30c9\u30e9\u30a4\u30d0\u306e\u9818\u57df\u78ba\u4fdd\u304cvmalloc\u3067\u884c\u308f\u308c\u3066\u3044\u308b\u304b\u3089\u3067\u3059\u3002\n[\u53c2\u8003]\n- Linux\u306e\u30ab\u30fc\u30cd\u30eb\u30e2\u30b8\u30e5\u30fc\u30eb\u304c\u30ed\u30fc\u30c9\u3055\u308c\u308b\u30a2\u30c9\u30ec\u30b9\u7bc4\u56f2 http://kernhack.hatenablog.com/entry/2016/10/06/010004\n\u3088\u3063\u3066\u30c9\u30e9\u30a4\u30d0\u306e\u9818\u57df\u3092\u7db2\u7f85\u3059\u308b\u306b\u306f\u3001\u975e\u9023\u7d9a\u306a\u7269\u7406\u30a2\u30c9\u30ec\u30b9\u3092\u30ea\u30b9\u30c8\u3067\u7e4b\u3044\u3067BitVisor\u306b\u6e21\u3059\u304b\u3001\u9023\u7d9a\u306a\u9818\u57df\u306b\u30c9\u30e9\u30a4\u30d0\u3092\u30b3\u30d4\u30fc\u3057\u3066\u4eee\u60f3\u30a2\u30c9\u30ec\u30b9\u3092remap\u3059\u308b\u304b\u3067\u3059\u3002\n\u4eca\u56de\u306f\u3068\u308a\u3042\u3048\u305a\u524d\u8005\u3067\u5b9f\u88c5\u3057\u307e\u3057\u305f\u3002\n\u4ee5\u524d\u306e\u8a18\u4e8b\u3067\u4f5c\u3063\u305fLinux\u7528\u30a8\u30fc\u30b8\u30a7\u30f3\u30c8\u3092\u6539\u826f\u3057\u3001vmalloc\u306e\u7269\u7406\u30a2\u30c9\u30ec\u30b9\u3092\u30ea\u30b9\u30c8\u306b\u7e4b\u3044\u3067vmcall\u3067\u6e21\u3059\u3088\u3046\u306b\u3057\u307e\u3057\u305f\u3002\n[\u53c2\u8003]\n- BitVisor\u306bVMCALL\u3092\u8ffd\u52a0\u3057\u3066\u30c9\u30e9\u30a4\u30d0\u3092\u691c\u77e5\u3057\u3066\u307f\u308b http://qiita.com/RKX1209/items/91e45c5f1b9b9c7211f8\n\u6539\u9020\u3057\u305f\u4e3b\u306a\u90e8\u5206\u3067\u3059\u3002\n\ntools/drvhook/drvhook.c\n\nstatic void\ngen_phys_list (void *vmod, unsigned long size)\n{\n  /* [vmod, vmod+size] area is physically not-contiguous,\n      because it's allocated by vmalloc() in module_alloc. */\n  u64 p = vmod, phys;\n  mod_area_phys = (u64*)kmalloc(sizeof(u64) * (size / PAGE_SIZE), GFP_KERNEL);\n  for (p = vmod; p < (u64)vmod + size; p += PAGE_SIZE) {\n    phys = page_to_phys(vmalloc_to_page((void*)p));\n    pr_info(\"module: 0x%llx => [0x%llx,0x%llx]\\n\", p, phys, phys+PAGE_SIZE);\n    mod_area_phys[(p - (u64)vmod) / PAGE_SIZE] = phys;\n  }\n}\n\nstatic void\nvmcall_drvhook (void *vmod, unsigned long size)\n{\n  call_vmm_function_t drvf;\n  call_vmm_arg_t drv_a;\n  call_vmm_ret_t drv_r;\n  char drvhook[] = \"drvhook\";\n\n  vmmcall_get_function(drvhook, &drvf);\n  pr_info(\"drvhook number=%d\\n\",drvf.vmmcall_number);\n\n  gen_phys_list(vmod, size);\n  drv_a.rbx = (intptr_t)mod_area_phys;\n  drv_a.rcx = (intptr_t)__pa((void*)mod_area_phys);\n  drv_a.rdx = size / PAGE_SIZE;\n  call_vmm_call_function(&drvf, &drv_a, &drv_r);\n}\n\n\npage_to_phys(vmalloc_to_page)\u3067\u7269\u7406\u30a2\u30c9\u30ec\u30b9\u3092\u3068\u3063\u3066\u3064\u306a\u3052\u3066\u307e\u3059\u3002\u3082\u3061\u308d\u3093\u3064\u306a\u3052\u308b\u30ea\u30b9\u30c8\u305d\u308c\u81ea\u4f53\u306f\u9023\u7d9a\u3057\u3066\u3044\u308b\u5fc5\u8981\u304c\u3042\u308b\u306e\u3067\u3001kmalloc\u3067\u78ba\u4fdd\u3057\u3066\u3044\u307e\u3059\u3002\n\n\u5b9f\u884c\n\u3067\u306f\u5b9f\u969b\u306b\u52d5\u4f5c\u3055\u305b\u3066\u307f\u307e\u3059\u3002\nProcessor 3 tlb flush\nvt_flush_all_tlb\nsending to processor 2\ncomplete processor 2\nProcessor 2: tlb flush\nvt_ept_set_hook 0xa6be1200(4)\nares[0] = 0xd5443000\nremove x-bit from 0xd5443000\nares[1] = 0xd3cc1000\nremove x-bit from 0xd3cc1000\nares[2] = 0x98f1d000\nremove x-bit from 0x98f1d000\nares[3] = 0x9b054000\nremove x-bit from 0x9b054000\n(3)ept: 0xd5444000(write)\nremove x-bit from 0xd5444000\n(3)ept: 0xd5443040(exec)\nX-bit violation: 0xd5443040\n\n\n\u898b\u3065\u3089\u3044\u30ed\u30b0\u3067\u3059\u304c\u3001remo x-bit from\u3067\u30c9\u30e9\u30a4\u30d0\u306e\u9818\u57df(areas[0] ~ [4])\u304b\u3089X flag\u3092\u629c\u304d\u3001\u305d\u306e\u5f8c\u9069\u5f53\u306bioctl\u3092\u767a\u884c\u3057\u3066\u30c9\u30e9\u30a4\u30d0\u3092\u5b9f\u884c\u3059\u308b\u3068\u3001X-bit violation\u3067\u8a72\u5f53\u30a2\u30c9\u30ec\u30b9\u3067\u623b\u3063\u3066\u304d\u305f\u3068\u3044\u3046\u30ed\u30b0\u3067\u3059\u3002\n\n\u305d\u306e\u4ed6\n\u307e\u3042\u4e0a\u8a18\u306e\u30b3\u30fc\u30c9\u30b9\u30cb\u30da\u30c3\u30c8\u3092\u898b\u308c\u3070\u5206\u304b\u308b\u306e\u3067\u3059\u304c\u3001\u3053\u3053\u3067\u306f\u5168\u3066\u306e\u5b9f\u88c5\u306f\u8f09\u305b\u3066\u307e\u305b\u3093\u3002\n\u3044\u305a\u308c\u516c\u958b\u3057\u3088\u3046\u3068\u601d\u3044\u307e\u3059\u3002(\u5352\u8ad6\u304c\u7121\u4e8b\u7d42\u308f\u3063\u305f\u3089.....\n\u3053\u306e\u8a18\u4e8b\u306fBitVisor Advent Calendar 17\u65e5\u76ee\u306e\u8a18\u4e8b\u3067\u3059\uff0e(\u307e\u305f\u3057\u3066\u3082\u9045\u523b\u3059\u307f\u307e\u305b\u3093...\n\nBitVisor\u306eEPT\u30a8\u30f3\u30c8\u30ea\u30fc\u3092\u3044\u3058\u3063\u3066\u7279\u5b9a\u306e\u30c9\u30e9\u30a4\u30d0\u304c\u5b9f\u884c\u3055\u308c\u305f\u6642\u306e\u307fBitVisor\u5074\u306b\u5236\u5fa1\u3092\u623b\u3059\u3088\u3046\u306b\u3057\u3066\u307f\u307e\u3059\u3002\n\n#EPT\u6539\u9020\u3067\u3067\u304d\u308b\u4e8b\nBitVisor\u306f\u30b2\u30b9\u30c8OS\u306e\u7269\u7406\u30a2\u30c9\u30ec\u30b9\u3068\u30db\u30b9\u30c8\u306e\u7269\u7406\u30a2\u30c9\u30ec\u30b9\u306e\u5bfe\u5fdc\u3092EPT(Extended Page Table)\u3067\u884c\u3063\u3066\u3044\u307e\u3059\u3002\n\u3053\u308c\u3089EPT\u306e\u30a8\u30f3\u30c8\u30ea\u306b\u306f\u305d\u308c\u305e\u308cR(Read),W(Write),X(Execute)\u306e\u30d1\u30fc\u30df\u30c3\u30b7\u30e7\u30f3\u30d5\u30e9\u30b0\u304c\u8a2d\u5b9a\u3067\u304d\u3001\u3053\u308c\u306b\u3088\u308a\u30b2\u30b9\u30c8OS\u306e\u30da\u30fc\u30b8\u30f3\u30b0\u306e\u30d5\u30e9\u30b0\u3068\u5408\u308f\u305b\u3066\u30a2\u30af\u30bb\u30b9\u6a29\u9650\u3092\u8a2d\u5b9a\u3067\u304d\u307e\u3059\u3002\u3053\u308c\u3092\u5229\u7528\u3059\u308b\u3068\u3001\u30b2\u30b9\u30c8OS\u304b\u3089\u900f\u904e\u306a\u5834\u6240\u3067\u6a29\u9650\u8a2d\u5b9a\u3092\u884c\u3046\u3053\u3068\u304c\u3067\u304d\u308b\u305f\u3081\u3001\u30de\u30eb\u30a6\u30a7\u30a2\u89e3\u6790\u306b\u304a\u3044\u3066\u3001\u4f8b\u3048\u3070rootkit\u304b\u3089\u3082\u898b\u3048\u306a\u3044\u30a2\u30af\u30bb\u30b9\u4fdd\u8b77\u3092\u884c\u3046\u4e8b\u304c\u3067\u304d\u307e\u3059\u3002(\u7d50\u69cb\u6614\u304b\u3089\u3042\u308b\u7814\u7a76\u3067\u3059\u306d)\n\u3055\u3066\u3001\u4eca\u56de\u306f\u3053\u308c\u3092BitVisor\u306b\u3082\u5b9f\u88c5\u3057\u3001\u30b2\u30b9\u30c8OS\u306e\u7279\u5b9a\u306e\u30c9\u30e9\u30a4\u30d0\u9818\u57df\u306eEPT\u30a8\u30f3\u30c8\u30ea\u30fc\u304b\u3089X(Execute)\u30d5\u30e9\u30b0\u3092\u5916\u3059\u4e8b\u3067\u3001\u305d\u306e\u9818\u57df\u3092\u5b9f\u884c\u3057\u3088\u3046\u3068\u3059\u308b\u3068BitVisor\u5074\u306b\u5236\u5fa1\u304c\u623b\u308b\u3088\u3046\u306b\u3057\u3066\u307f\u307e\u3059\u3002\n\n\n#BitVisor\u306eEPT\u30de\u30c3\u30d4\u30f3\u30b0\u51e6\u7406\nBitVisor\u3067\u306fEPT violation\u3057\u305f\u969b\u3001core/vt_ept.c\u3067EPT\u306e\u5404\u30a8\u30f3\u30c8\u30ea\u30fc\u3092\u4f5c\u6210\u3059\u308b\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002\u6ce8\u610f\u3059\u3079\u304d\u70b9\u3068\u3057\u3066\u306f\u3001(\u307e\u3042\u5f53\u7136\u3067\u3059\u304c)\u305d\u308c\u3089\u306e\u30a8\u30f3\u30c8\u30ea\u30fc\u306ftbl(phys)\u3068\u3044\u30461024\u500b\u306e\u914d\u5217\u304b\u3089\u53d6\u3063\u3066\u3053\u3089\u308c\u3001\u3082\u3057\u8db3\u308a\u306a\u304f\u306a\u308b\u3068**\u4e00\u65e6\u30af\u30ea\u30a2\u3057\u3066\u3084\u308a\u306a\u304a\u3059\u4ed5\u7d44\u307f\u306b\u306a\u3063\u3066\u3044\u308b\u4e8b\u3067\u3059\u3002**\n\u3064\u307e\u308a\u3001\u4eca\u56de\u7279\u5b9a\u306eEPT\u30a8\u30f3\u30c8\u30ea\u30fc\u304b\u3089X flag\u3092\u5916\u3057\u305f\u3044\u306e\u3067\u3059\u304c\u3001\u4eee\u306b\u3069\u3053\u304b\u306e\u30bf\u30a4\u30df\u30f3\u30b0\u3067X flag\u3092\u5916\u3057\u305f\u3068\u3057\u3066\u3082\u3001\u3057\u3070\u3089\u304f\u3057\u3066\u30a8\u30f3\u30c8\u30ea\u30fc\u304c\u3044\u3063\u3071\u3044\u306b\u306a\u308b\u3068\u30af\u30ea\u30a2\u3055\u308c\u3066\u3057\u307e\u3046\u53ef\u80fd\u6027\u304c\u3042\u308b\u3068\u3044\u3046\u4e8b\u3067\u3059\u3002\n\u3088\u3063\u3066\u30af\u30ea\u30a2\u3055\u308c\u305f\u5f8c\u3082X flag\u3092\u5916\u3057\u305f\u72b6\u614b\u3067\u518d\u5272\u5f53\u3066\u3057\u3066\u3082\u3089\u3046\u3088\u3046\u306b\u3001EPT\u306e\u5272\u5f53\u95a2\u6570vt_ept_map_page_sub()\u5185\u3067\u3001\u7279\u5b9a\u306e\u9818\u57df\u5185\u306a\u3089X flag\u3092\u629c\u3044\u3066\u30a8\u30f3\u30c8\u30ea\u30fc\u3092\u4f5c\u6210\u3059\u308b\u3088\u3046\u306b\u6539\u9020\u3057\u307e\u3057\u305f\u3002\n\n```diff\ndiff --git a/bitvisor/../../bitvisor/core/vt_ept.c b/bitvisor/core/vt_ept.c\nindex 341e1e2..518e9ce 100644\n--- a/bitvisor/../../bitvisor/core/vt_ept.c\n+++ b/bitvisor/core/vt_ept.c\n\n static void\n vt_ept_map_page_sub (struct vt_ept *ept, bool write, u64 gphys)\n {\n@@ -154,8 +173,16 @@ vt_ept_map_page_sub (struct vt_ept *ept, bool write, u64 gphys)\n \thphys = current->gmm.gp2hp (gphys, &fakerom) & ~PAGESIZE_MASK;\n \tif (fakerom && write)\n \t\tpanic (\"EPT: Writing to VMM memory.\");\n-\thattr = (cache_get_gmtrr_type (gphys) << EPTE_MT_SHIFT) |\n-\t\tEPTE_READEXEC | EPTE_WRITE;\n+\n+\tif (in_hook_point (&hook_point, gphys)) {\n+\t\thattr = (cache_get_gmtrr_type (gphys) << EPTE_MT_SHIFT) |\n+\t\t\tEPTE_READ | EPTE_WRITE; // witout EXEC permission\n+\t\tprintf(\"remove x-bit from 0x%llx\\n\", gphys);\n+\t}\n+\telse\n+\t\thattr = (cache_get_gmtrr_type (gphys) << EPTE_MT_SHIFT) |\n+\t\t\tEPTE_READEXEC | EPTE_WRITE;\n+\n \tif (fakerom)\n \t\thattr &= ~EPTE_WRITE;\n \t*p = hphys | hattr;\n@@ -238,6 +265,37 @@ vt_ept_map_page (struct vt_ept *ept, bool write, u64 gphys)\n }\n\n void\n+vt_ept_set_hook (u64 gphys, u32 size)\n+{\n+\tstruct vt_ept *ept;\n+\tu32 i;\n+\tu64 gp;\n+\tu64 *m;\n+\thook_point.mod_areas = (u64*)alloc(sizeof *m * size);\n+\thook_point.size = size;\n+\thook_point.available = 1;\n+\n+\tept = current->u.vt.ept;\n+\n+\t/* Clearing EPT entries, to hook */\n+\tvt_ept_clear_all_slow();\n+\n+\tprintf(\"vt_ept_set_hook 0x%llx(%d)\\n\", gphys, size);\n+\n+\t/* remap address range of kernel module\n+\t * TODO: 2M page\n+\t */\n+\tm = hook_point.mod_areas;\n+\n+\tfor (i = 0; i < hook_point.size; i++) {\n+\t\tread_gphys_q(gphys + sizeof(u64) * i, (void*)&m[i], 0);\n+\t\tprintf(\"ares[%d] = 0x%llx\\n\", i, m[i]);\n+\t\tvt_ept_map_page(ept, false, m[i]);\n+\t}\n+\n+}\n+\n```\n\n#\u30b3\u30a2\u9593\u306e\u30ad\u30e3\u30c3\u30b7\u30e5\u30b3\u30d2\u30fc\u30ec\u30f3\u30b7\n\u3055\u3066\u3001EPT\u30a8\u30f3\u30c8\u30ea\u30fc\u3092\u3044\u3058\u308b\u4e8b\u306f\u3067\u304d\u307e\u3057\u305f\u304c\u3001\u3082\u3046\u3072\u3068\u3064\u6c17\u3092\u4ed8\u3051\u306a\u3051\u308c\u3070\u306a\u3089\u306a\u3044\u306e\u304cTLB(Translation Lookaside Buffer)\u306e\u6271\u3044\u3067\u3059\u3002EPT\u306b\u3088\u308b\u5909\u63db\u306f\u5404\u30b3\u30a2\u306eTLB\u306b\u8f09\u3063\u3066\u3044\u308b\u305f\u3081\u3001\u304b\u308a\u306bX flag\u3092\u629c\u3044\u3066\u3082TLB\u306b\u3042\u308b\u53e4\u3044\u30a8\u30f3\u30c8\u30ea\u30fc\u304c\u4f7f\u308f\u308c\u7d9a\u3051\u308b\u3068\u610f\u5473\u304c\u3042\u308a\u307e\u305b\u3093\u3002\n\u305d\u3053\u3067X flag\u3092\u629c\u304f\u524d\u306b\u3001\u5168\u30b3\u30a2\u306b\u5bfe\u3057\u3066TLB\u3092\u30d5\u30e9\u30c3\u30b7\u30e5\u3059\u308b\u3088\u3046\u306b\u547d\u4ee4\u3057\u307e\u3059\u3002(\u3044\u308f\u3086\u308bTLB shootdown\u3067\u3059)\n\u305d\u3046\u3044\u3048\u3070\u3061\u3087\u3046\u3069\u5c11\u3057\u524d\u306bkernelvm\u52c9\u5f37\u4f1a\u3067deep_tkkn\u3055\u3093\u304cBitVisor\u3067TLB shootdown\u306e\u8a71\u3092\u3055\u308c\u3066\u305f\u306a\u3041\u3068\u601d\u3044\u3001\u305d\u306e\u6642\u306e\u767a\u8868\u8cc7\u6599\u3092\u53c2\u8003\u306b\u3055\u305b\u3066\u9802\u304d\u307e\u3057\u305f\u3002\n\n<iframe src=\"//www.slideshare.net/slideshow/embed_code/key/jpQoGWiu8Jm2ZZ\" width=\"595\" height=\"485\" frameborder=\"0\" marginwidth=\"0\" marginheight=\"0\" scrolling=\"no\" style=\"border:1px solid #CCC; border-width:1px; margin-bottom:5px; max-width: 100%;\" allowfullscreen> </iframe> <div style=\"margin-bottom:5px\"> <strong> <a href=\"//www.slideshare.net/DeepTokikane/ept-tlb\" title=\"EPT \u3068 TLB \u3067\u3057\u304f\u3058\u3063\u305f\u8a71\" target=\"_blank\">EPT \u3068 TLB \u3067\u3057\u304f\u3058\u3063\u305f\u8a71</a> </strong> from <strong><a target=\"_blank\" href=\"//www.slideshare.net/DeepTokikane\">Takaaki Fukai</a></strong> </div>\n\n\u307e\u305ftwitter\u3067\u611a\u75f4\u3063\u3066\u3044\u305f\u6240\u3001deep_tkkn\u3055\u3093\u306bTLB shootdown\u306e\u30d1\u30c3\u30c1\u3092\u898b\u305b\u3066\u3044\u305f\u3060\u3051\u307e\u3057\u305f\u3002\n\u5727\u5012\u7684\u611f\u8b1dm(_ _)m\n\n\u5b9f\u88c5\u65b9\u6cd5\u3068\u3057\u3066\u306f\u3001BitVisor\u306f\u5404\u30b3\u30a2\u306b\u5bfe\u3057\u3066IPI\u3067NMI\u3092\u9001\u3063\u3066\u30cf\u30f3\u30c9\u30eb\u3059\u308b\u6a5f\u80fd\u304c\u3042\u308b\u306e\u3067\u305d\u308c\u3092\u5229\u7528\u3057\u3066\u3001NMI\u3068\u3057\u3066shootdown\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u9001\u308a\u3001\u5404\u30b3\u30a2\u306bTLB flush\u3055\u305b\u308b\u7269\u3067\u3059\u3002\n\u3053\u308c\u3067\u3046\u307e\u304f\u884c\u304d\u307e\u3057\u305f\u3002\n\n#\u30c9\u30e9\u30a4\u30d0\u306e\u7269\u7406\u30a2\u30c9\u30ec\u30b9\u306e\u6271\u3044\n\u3055\u3066\u3053\u308c\u3067\u5168\u3066\u3046\u307e\u304f\u884c\u3063\u305f\u3088\u3046\u306b\u898b\u3048\u307e\u3059\u304c\u3001\u307e\u3060\u99c4\u76ee\u3067\u3059\u3002\n\u306a\u305c\u304b\u3068\u3044\u3046\u3068\u3001\u305d\u3082\u305d\u3082EPT violation\u3057\u305f\u6642\u306b\u53d6\u5f97\u3067\u304d\u308b\u306e\u306f\u30b2\u30b9\u30c8\u306e\u7269\u7406\u30a2\u30c9\u30ec\u30b9\u306a\u306e\u3067\u3059\u304c\u3001\u30c9\u30e9\u30a4\u30d0\u306e\u30ed\u30fc\u30c9\u3055\u308c\u3066\u3044\u308b\u9818\u57df\u306e\u7269\u7406\u30a2\u30c9\u30ec\u30b9\u306f\u3001**\u5b9f\u306f\u9023\u7d9a\u3057\u3066\u3044\u308b\u4fdd\u8a3c\u304c\u3042\u308a\u307e\u305b\u3093\u3002**\n\u3053\u308c\u306fLinux\u306e\u5834\u5408\u30c9\u30e9\u30a4\u30d0\u306e\u9818\u57df\u78ba\u4fdd\u304cvmalloc\u3067\u884c\u308f\u308c\u3066\u3044\u308b\u304b\u3089\u3067\u3059\u3002\n[\u53c2\u8003]\n- Linux\u306e\u30ab\u30fc\u30cd\u30eb\u30e2\u30b8\u30e5\u30fc\u30eb\u304c\u30ed\u30fc\u30c9\u3055\u308c\u308b\u30a2\u30c9\u30ec\u30b9\u7bc4\u56f2 http://kernhack.hatenablog.com/entry/2016/10/06/010004\n\n\u3088\u3063\u3066\u30c9\u30e9\u30a4\u30d0\u306e\u9818\u57df\u3092\u7db2\u7f85\u3059\u308b\u306b\u306f\u3001\u975e\u9023\u7d9a\u306a\u7269\u7406\u30a2\u30c9\u30ec\u30b9\u3092\u30ea\u30b9\u30c8\u3067\u7e4b\u3044\u3067BitVisor\u306b\u6e21\u3059\u304b\u3001\u9023\u7d9a\u306a\u9818\u57df\u306b\u30c9\u30e9\u30a4\u30d0\u3092\u30b3\u30d4\u30fc\u3057\u3066\u4eee\u60f3\u30a2\u30c9\u30ec\u30b9\u3092remap\u3059\u308b\u304b\u3067\u3059\u3002\n\u4eca\u56de\u306f\u3068\u308a\u3042\u3048\u305a\u524d\u8005\u3067\u5b9f\u88c5\u3057\u307e\u3057\u305f\u3002\n\u4ee5\u524d\u306e\u8a18\u4e8b\u3067\u4f5c\u3063\u305fLinux\u7528\u30a8\u30fc\u30b8\u30a7\u30f3\u30c8\u3092\u6539\u826f\u3057\u3001vmalloc\u306e\u7269\u7406\u30a2\u30c9\u30ec\u30b9\u3092\u30ea\u30b9\u30c8\u306b\u7e4b\u3044\u3067vmcall\u3067\u6e21\u3059\u3088\u3046\u306b\u3057\u307e\u3057\u305f\u3002\n[\u53c2\u8003]\n- BitVisor\u306bVMCALL\u3092\u8ffd\u52a0\u3057\u3066\u30c9\u30e9\u30a4\u30d0\u3092\u691c\u77e5\u3057\u3066\u307f\u308b http://qiita.com/RKX1209/items/91e45c5f1b9b9c7211f8\n\n\u6539\u9020\u3057\u305f\u4e3b\u306a\u90e8\u5206\u3067\u3059\u3002\n\n```tools/drvhook/drvhook.c\n\nstatic void\ngen_phys_list (void *vmod, unsigned long size)\n{\n  /* [vmod, vmod+size] area is physically not-contiguous,\n      because it's allocated by vmalloc() in module_alloc. */\n  u64 p = vmod, phys;\n  mod_area_phys = (u64*)kmalloc(sizeof(u64) * (size / PAGE_SIZE), GFP_KERNEL);\n  for (p = vmod; p < (u64)vmod + size; p += PAGE_SIZE) {\n    phys = page_to_phys(vmalloc_to_page((void*)p));\n    pr_info(\"module: 0x%llx => [0x%llx,0x%llx]\\n\", p, phys, phys+PAGE_SIZE);\n    mod_area_phys[(p - (u64)vmod) / PAGE_SIZE] = phys;\n  }\n}\n\nstatic void\nvmcall_drvhook (void *vmod, unsigned long size)\n{\n  call_vmm_function_t drvf;\n  call_vmm_arg_t drv_a;\n  call_vmm_ret_t drv_r;\n  char drvhook[] = \"drvhook\";\n\n  vmmcall_get_function(drvhook, &drvf);\n  pr_info(\"drvhook number=%d\\n\",drvf.vmmcall_number);\n\n  gen_phys_list(vmod, size);\n  drv_a.rbx = (intptr_t)mod_area_phys;\n  drv_a.rcx = (intptr_t)__pa((void*)mod_area_phys);\n  drv_a.rdx = size / PAGE_SIZE;\n  call_vmm_call_function(&drvf, &drv_a, &drv_r);\n}\n```\n\npage_to_phys(vmalloc_to_page)\u3067\u7269\u7406\u30a2\u30c9\u30ec\u30b9\u3092\u3068\u3063\u3066\u3064\u306a\u3052\u3066\u307e\u3059\u3002\u3082\u3061\u308d\u3093\u3064\u306a\u3052\u308b\u30ea\u30b9\u30c8\u305d\u308c\u81ea\u4f53\u306f\u9023\u7d9a\u3057\u3066\u3044\u308b\u5fc5\u8981\u304c\u3042\u308b\u306e\u3067\u3001kmalloc\u3067\u78ba\u4fdd\u3057\u3066\u3044\u307e\u3059\u3002\n\n#\u5b9f\u884c\n\u3067\u306f\u5b9f\u969b\u306b\u52d5\u4f5c\u3055\u305b\u3066\u307f\u307e\u3059\u3002\n\n```\nProcessor 3 tlb flush\nvt_flush_all_tlb\nsending to processor 2\ncomplete processor 2\nProcessor 2: tlb flush\nvt_ept_set_hook 0xa6be1200(4)\nares[0] = 0xd5443000\nremove x-bit from 0xd5443000\nares[1] = 0xd3cc1000\nremove x-bit from 0xd3cc1000\nares[2] = 0x98f1d000\nremove x-bit from 0x98f1d000\nares[3] = 0x9b054000\nremove x-bit from 0x9b054000\n(3)ept: 0xd5444000(write)\nremove x-bit from 0xd5444000\n(3)ept: 0xd5443040(exec)\nX-bit violation: 0xd5443040\n\n```\n\u898b\u3065\u3089\u3044\u30ed\u30b0\u3067\u3059\u304c\u3001remo x-bit from\u3067\u30c9\u30e9\u30a4\u30d0\u306e\u9818\u57df(areas[0] ~ [4])\u304b\u3089X flag\u3092\u629c\u304d\u3001\u305d\u306e\u5f8c\u9069\u5f53\u306bioctl\u3092\u767a\u884c\u3057\u3066\u30c9\u30e9\u30a4\u30d0\u3092\u5b9f\u884c\u3059\u308b\u3068\u3001X-bit violation\u3067\u8a72\u5f53\u30a2\u30c9\u30ec\u30b9\u3067\u623b\u3063\u3066\u304d\u305f\u3068\u3044\u3046\u30ed\u30b0\u3067\u3059\u3002\n\n#\u305d\u306e\u4ed6\n\u307e\u3042\u4e0a\u8a18\u306e\u30b3\u30fc\u30c9\u30b9\u30cb\u30da\u30c3\u30c8\u3092\u898b\u308c\u3070\u5206\u304b\u308b\u306e\u3067\u3059\u304c\u3001\u3053\u3053\u3067\u306f\u5168\u3066\u306e\u5b9f\u88c5\u306f\u8f09\u305b\u3066\u307e\u305b\u3093\u3002\n\u3044\u305a\u308c\u516c\u958b\u3057\u3088\u3046\u3068\u601d\u3044\u307e\u3059\u3002(\u5352\u8ad6\u304c\u7121\u4e8b\u7d42\u308f\u3063\u305f\u3089.....\n", "tags": ["BitVisor"]}