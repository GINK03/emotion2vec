{"tags": ["Python", "tweepy", "TwitterAPI", "bottle"], "context": " More than 1 year has passed since last update.\u5358\u306btweepy\u3092\u30e9\u30c3\u30d4\u30f3\u30b0\u3057\u305f\u3060\u3051\u3060\u3051\u3069\u3001\u6bce\u56de\u3001\u53e4\u3044\u30b3\u30fc\u30c9\u3092\u6f01\u3063\u3066\u3001\u4f7f\u3044\u65b9\u3092\u601d\u3044\u51fa\u3059\u306e\u3082\u9762\u5012\u306a\u3093\u3067\u3001\u81ea\u5206\u7528Twitter API\u30e9\u30a4\u30d6\u30e9\u30ea\u3068\u4f7f\u3044\u65b9\u306e\u30e1\u30e2\u3002\n\nMy Twitter API\u30e9\u30a4\u30d6\u30e9\u30ea\n\u74b0\u5883\u5909\u6570\u306b\u4ee5\u4e0b\u306e\u5024\u3092\u8a2d\u5b9a\u3057\u3068\u304f\u3002\n- TWITTER_CONSUMER_KEY\uff1aTwitter App\u306e\u300cKeys and Access Tokens\u300d\u30bf\u30d6\u306b\u3042\u308b\u300cConsumer Key (API Key)\u300d\n- TWITTER_CONSUMER_SECRET\uff1aTwitter App\u306e\u300cKeys and Access Tokens\u300d\u30bf\u30d6\u306b\u3042\u308b\u300cConsumer Secret (API Secret)\u300d\n- TWITTER_CALLBACK_URL\uff1aTwitter App\u306e\u300cSettings\u300d\u30bf\u30d6\u3067\u8a2d\u5b9a\u3057\u305f\u300cCallback URL\u300d\n\ntwitter.py\n# -*- coding: utf-8 -*-\n\nimport os\nimport urllib2\nimport os.path\nimport logging\nimport traceback\n\nimport oauthlib\nimport tweepy\n\n\nCONSUMER_KEY = os.environ.get('TWITTER_CONSUMER_KEY')\nCONSUMER_SECRET = os.environ.get('TWITTER_CONSUMER_SECRET')\nCALLBACK_URL = os.environ.get('TWITTER_CALLBACK_URL')\n\n\n#\n\ndef api(access_token = None, access_token_secret = None, with_callback_url = False):\n    if with_callback_url:\n        auth = tweepy.OAuthHandler(\n            consumer_key = CONSUMER_KEY,\n            consumer_secret = CONSUMER_SECRET,\n            callback_url = CALLBACK_URL)\n    else:\n        auth = tweepy.OAuthHandler(\n            consumer_key = CONSUMER_KEY,\n            consumer_secret = CONSUMER_SECRET)\n\n    if access_token is not None and access_token_secret is not None:\n        auth.set_access_token(access_token, access_token_secret)\n\n    return tweepy.API(auth)\n\n\n# API\n\ndef get_tweets(screen_name = None, hashtag = None, count = 200):\n    if screen_name is not None:\n        cursor = tweepy.Cursor(api().user_timeline, \n        screen_name = screen_name, count = 200, exclude_replies = True)\n    elif hashtag is not None:\n        cursor = tweepy.Cursor(api().search, q = u\"#{0}\".format(hashtag), count = 200)\n\n    if count is not None:\n        return cursor.items(count)\n    else:\n        return cursor.items()\n\ndef tweet_link(tweet):\n    return \"https://twitter.com/{screen_name}/status/{tweet_id}\".format(\n        screen_name = tweet.user.screen_name,\n        tweet_id = tweet.id_str)\n\ndef get_friends(screen_name):\n    return tweepy.Cursor(api().friends, screen_name = screen_name, count = 200).items()\n\n\n# OAuth\n\ndef generate_auth_url():\n    oauth_handler = tweepy.OAuthHandler(CONSUMER_KEY, CONSUMER_SECRET, CALLBACK_URL)\n    redirect_url = oauth_handler.get_authorization_url(signin_with_twitter = True)\n    request_token = oauth_handler.request_token\n\n    return redirect_url, request_token['oauth_token'], request_token['oauth_token_secret'],\n\ndef get_access_token(request_token_key, request_token_secret, oauth_verifier):\n    oauth_handler = tweepy.OAuthHandler(CONSUMER_KEY, CONSUMER_SECRET)\n    oauth_handler.request_token = {\n        'oauth_token': request_token_key,\n        'oauth_token_secret': request_token_secret,\n        'oauth_callback_confirmed': True,\n    }\n    oauth_handler.get_access_token(oauth_verifier)\n\n    return oauth_handler.access_token, oauth_handler.access_token_secret\n\ndef verify_credentials(access_token, access_token_secret):\n    api = api(access_token, access_token_secret)\n    return api.verify_credentials()\n\n\n# Utility\n\ndef get_big_profile_image_url(profile_image_url):\n    return profile_image_url.replace('_normal', '')\n\n\n\nWeb\u3067OAuth\u8a8d\u8a3c\u3059\u308b\u624b\u9806\n\u66f8\u3044\u3066\u308b\u30b3\u30fc\u30c9\u306f\u3001Bottle\u7528\u306e\u30b5\u30f3\u30d7\u30eb\u30b3\u30fc\u30c9\u3002\n\n1. OAuth\u7528\u306eURL\u3092\u767a\u884c\u3059\u308b\n@get('/twitter_login')\ndef twitter_login():\n    auth_url, request_token_key, request_token_secret = twitter.generate_auth_url()\n\n    # request_token_key\u3068request_token_secret\u3092\u30bb\u30c3\u30b7\u30e7\u30f3\u306b\u4fdd\u5b58\u3059\u308b\u3002\n\n    redirect(auth_url)\n\ntwitter.generate_auth_url\u3092\u547c\u3073\u51fa\u3057\u3066\u3001Twitter\u306b\u98db\u3070\u3059URL\u3068\u30ea\u30af\u30a8\u30b9\u30c8\u30fb\u30c8\u30fc\u30af\u30f3\u3001\u30b7\u30fc\u30af\u30ec\u30c3\u30c8\u3092\u767a\u884c\u3059\u308b\u3002\n\u305d\u3057\u3066\u3001\u30ea\u30af\u30a8\u30b9\u30c8\u30fb\u30c8\u30fc\u30af\u30f3\u3001\u30b7\u30fc\u30af\u30ec\u30c3\u30c8\u3092\u3001\u30bb\u30c3\u30b7\u30e7\u30f3\u306b\u4fdd\u5b58\u3059\u308b\u3002\n\u3053\u3053\u3067\u4fdd\u5b58\u3057\u305f\u5024\u306f\u3001Twitter\u304b\u3089\u306e\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u306e\u51e6\u7406\u3067\u30a2\u30af\u30bb\u30b9\u30c8\u30fc\u30af\u30f3\u3092\u53d6\u5f97\u3059\u308b\u969b\u306b\u4f7f\u3046\u3002\n\u3053\u3053\u3001\u4eba\u306b\u3088\u3063\u3066\u5b9f\u88c5\u304c\u9055\u3046\u3068\u601d\u3046\u3093\u3060\u3051\u3069\u3001\u307c\u304f\u306f\u3001\u30ea\u30af\u30a8\u30b9\u30c8\u30fb\u30c8\u30fc\u30af\u30f3\u3001\u30b7\u30fc\u30af\u30ec\u30c3\u30c8\u3092\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306b\u4fdd\u5b58\u3057\u3066\u3001\u30ea\u30af\u30a8\u30b9\u30c8\u30fb\u30c8\u30fc\u30af\u30f3\u3060\u3051\u3092\u3001\u30af\u30c3\u30ad\u30fc\u306b\u5165\u308c\u305f\u308a\u3057\u3066\u308b\u3002\n\u3042\u3068\u3001CSFR\u5bfe\u7b56\u3067\u3001\u30a2\u30af\u30bb\u30b9\u5143\u306eIP\u3068\u304bUser Agent\u3082\u3001\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306b\u5165\u308c\u308b\u3053\u3068\u3082\u3042\u308b\u3002\n\u305d\u3057\u3066\u3001Twitter\u306b\u30ea\u30c0\u30a4\u30ec\u30af\u30c8\u3002\n\n2. \u30a2\u30af\u30bb\u30b9\u30c8\u30fc\u30af\u30f3\u306e\u53d6\u5f97\n@get('/twitter_callback')\ndef twitter_callback():\n    # \u30bb\u30c3\u30b7\u30e7\u30f3\u306b\u4fdd\u5b58\u3057\u305f\u30ea\u30af\u30a8\u30b9\u30c8\u30fb\u30c8\u30fc\u30af\u30f3\uff08request_token_key\uff09\u3001\u30b7\u30fc\u30af\u30ec\u30c3\u30c8\uff08request_token_secret\uff09\u3092\u53d6\u5f97\u3059\u308b\u3002\n\n    oauth_verifier = request.query['oauth_verifier']\n\n    access_token_key, access_token_secret = twitter.get_access_token(\n        twitter_connect.request_token_key,\n        twitter_connect.request_token_secret,\n        oauth_verifier)\n\n    twitter_user = twitter.verify_credentials(access_token_key, access_token_secret)\n\n    # \u30e6\u30fc\u30b6\u30fc\u767b\u9332\u3068\u304b\u30ed\u30b0\u30a4\u30f3\u3068\u304b\u306e\u51e6\u7406\n\nTwitter\u304b\u3089\u306e\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u306b\u306f\u3001oauth_verifier\u304c\u5165\u3063\u3066\u308b\u3093\u3067\u3001\u3053\u308c\u3068\u30bb\u30c3\u30b7\u30e7\u30f3\u306b\u5165\u308c\u3068\u3044\u305f\u30ea\u30af\u30a8\u30b9\u30c8\u30fb\u30c8\u30fc\u30af\u30f3\u3001\u30b7\u30fc\u30af\u30ec\u30c3\u30c8\u3092\u4f7f\u3063\u3066\u3001\u30a2\u30af\u30bb\u30b9\u30fb\u30c8\u30fc\u30af\u30f3\u3001\u30b7\u30fc\u30af\u30ec\u30c3\u30c8\u3092\u53d6\u5f97\u3059\u308b\u3002\n\u5358\u306b[tweepy](http://www.tweepy.org/)\u3092\u30e9\u30c3\u30d4\u30f3\u30b0\u3057\u305f\u3060\u3051\u3060\u3051\u3069\u3001\u6bce\u56de\u3001\u53e4\u3044\u30b3\u30fc\u30c9\u3092\u6f01\u3063\u3066\u3001\u4f7f\u3044\u65b9\u3092\u601d\u3044\u51fa\u3059\u306e\u3082\u9762\u5012\u306a\u3093\u3067\u3001\u81ea\u5206\u7528Twitter API\u30e9\u30a4\u30d6\u30e9\u30ea\u3068\u4f7f\u3044\u65b9\u306e\u30e1\u30e2\u3002\n\n# My Twitter API\u30e9\u30a4\u30d6\u30e9\u30ea\n\n\u74b0\u5883\u5909\u6570\u306b\u4ee5\u4e0b\u306e\u5024\u3092\u8a2d\u5b9a\u3057\u3068\u304f\u3002\n- `TWITTER_CONSUMER_KEY`\uff1aTwitter App\u306e\u300cKeys and Access Tokens\u300d\u30bf\u30d6\u306b\u3042\u308b\u300cConsumer Key (API Key)\u300d\n- `TWITTER_CONSUMER_SECRET`\uff1aTwitter App\u306e\u300cKeys and Access Tokens\u300d\u30bf\u30d6\u306b\u3042\u308b\u300cConsumer Secret (API Secret)\u300d\n- `TWITTER_CALLBACK_URL`\uff1aTwitter App\u306e\u300cSettings\u300d\u30bf\u30d6\u3067\u8a2d\u5b9a\u3057\u305f\u300cCallback URL\u300d\n\n```py:twitter.py\n# -*- coding: utf-8 -*-\n\nimport os\nimport urllib2\nimport os.path\nimport logging\nimport traceback\n\nimport oauthlib\nimport tweepy\n\n\nCONSUMER_KEY = os.environ.get('TWITTER_CONSUMER_KEY')\nCONSUMER_SECRET = os.environ.get('TWITTER_CONSUMER_SECRET')\nCALLBACK_URL = os.environ.get('TWITTER_CALLBACK_URL')\n\n\n#\n\ndef api(access_token = None, access_token_secret = None, with_callback_url = False):\n    if with_callback_url:\n        auth = tweepy.OAuthHandler(\n            consumer_key = CONSUMER_KEY,\n            consumer_secret = CONSUMER_SECRET,\n            callback_url = CALLBACK_URL)\n    else:\n        auth = tweepy.OAuthHandler(\n            consumer_key = CONSUMER_KEY,\n            consumer_secret = CONSUMER_SECRET)\n\n    if access_token is not None and access_token_secret is not None:\n        auth.set_access_token(access_token, access_token_secret)\n\n    return tweepy.API(auth)\n\n\n# API\n \ndef get_tweets(screen_name = None, hashtag = None, count = 200):\n    if screen_name is not None:\n        cursor = tweepy.Cursor(api().user_timeline, \n        screen_name = screen_name, count = 200, exclude_replies = True)\n    elif hashtag is not None:\n        cursor = tweepy.Cursor(api().search, q = u\"#{0}\".format(hashtag), count = 200)\n\n    if count is not None:\n        return cursor.items(count)\n    else:\n        return cursor.items()\n\ndef tweet_link(tweet):\n    return \"https://twitter.com/{screen_name}/status/{tweet_id}\".format(\n        screen_name = tweet.user.screen_name,\n        tweet_id = tweet.id_str)\n\ndef get_friends(screen_name):\n    return tweepy.Cursor(api().friends, screen_name = screen_name, count = 200).items()\n\n\n# OAuth\n\ndef generate_auth_url():\n    oauth_handler = tweepy.OAuthHandler(CONSUMER_KEY, CONSUMER_SECRET, CALLBACK_URL)\n    redirect_url = oauth_handler.get_authorization_url(signin_with_twitter = True)\n    request_token = oauth_handler.request_token\n\n    return redirect_url, request_token['oauth_token'], request_token['oauth_token_secret'],\n\ndef get_access_token(request_token_key, request_token_secret, oauth_verifier):\n    oauth_handler = tweepy.OAuthHandler(CONSUMER_KEY, CONSUMER_SECRET)\n    oauth_handler.request_token = {\n        'oauth_token': request_token_key,\n        'oauth_token_secret': request_token_secret,\n        'oauth_callback_confirmed': True,\n    }\n    oauth_handler.get_access_token(oauth_verifier)\n\n    return oauth_handler.access_token, oauth_handler.access_token_secret\n\ndef verify_credentials(access_token, access_token_secret):\n    api = api(access_token, access_token_secret)\n    return api.verify_credentials()\n\n\n# Utility\n\ndef get_big_profile_image_url(profile_image_url):\n    return profile_image_url.replace('_normal', '')\n```\n\n# Web\u3067OAuth\u8a8d\u8a3c\u3059\u308b\u624b\u9806\n\n\u66f8\u3044\u3066\u308b\u30b3\u30fc\u30c9\u306f\u3001[Bottle](http://bottlepy.org/)\u7528\u306e\u30b5\u30f3\u30d7\u30eb\u30b3\u30fc\u30c9\u3002\n\n##  1. OAuth\u7528\u306eURL\u3092\u767a\u884c\u3059\u308b\n\n```py\n@get('/twitter_login')\ndef twitter_login():\n    auth_url, request_token_key, request_token_secret = twitter.generate_auth_url()\n\n    # request_token_key\u3068request_token_secret\u3092\u30bb\u30c3\u30b7\u30e7\u30f3\u306b\u4fdd\u5b58\u3059\u308b\u3002\n\n    redirect(auth_url)\n```\n\n`twitter.generate_auth_url`\u3092\u547c\u3073\u51fa\u3057\u3066\u3001Twitter\u306b\u98db\u3070\u3059URL\u3068\u30ea\u30af\u30a8\u30b9\u30c8\u30fb\u30c8\u30fc\u30af\u30f3\u3001\u30b7\u30fc\u30af\u30ec\u30c3\u30c8\u3092\u767a\u884c\u3059\u308b\u3002\n\n\u305d\u3057\u3066\u3001\u30ea\u30af\u30a8\u30b9\u30c8\u30fb\u30c8\u30fc\u30af\u30f3\u3001\u30b7\u30fc\u30af\u30ec\u30c3\u30c8\u3092\u3001\u30bb\u30c3\u30b7\u30e7\u30f3\u306b\u4fdd\u5b58\u3059\u308b\u3002\n\u3053\u3053\u3067\u4fdd\u5b58\u3057\u305f\u5024\u306f\u3001Twitter\u304b\u3089\u306e\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u306e\u51e6\u7406\u3067\u30a2\u30af\u30bb\u30b9\u30c8\u30fc\u30af\u30f3\u3092\u53d6\u5f97\u3059\u308b\u969b\u306b\u4f7f\u3046\u3002\n\n\u3053\u3053\u3001\u4eba\u306b\u3088\u3063\u3066\u5b9f\u88c5\u304c\u9055\u3046\u3068\u601d\u3046\u3093\u3060\u3051\u3069\u3001\u307c\u304f\u306f\u3001\u30ea\u30af\u30a8\u30b9\u30c8\u30fb\u30c8\u30fc\u30af\u30f3\u3001\u30b7\u30fc\u30af\u30ec\u30c3\u30c8\u3092\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306b\u4fdd\u5b58\u3057\u3066\u3001\u30ea\u30af\u30a8\u30b9\u30c8\u30fb\u30c8\u30fc\u30af\u30f3\u3060\u3051\u3092\u3001\u30af\u30c3\u30ad\u30fc\u306b\u5165\u308c\u305f\u308a\u3057\u3066\u308b\u3002\n\u3042\u3068\u3001CSFR\u5bfe\u7b56\u3067\u3001*\u30a2\u30af\u30bb\u30b9\u5143\u306eIP*\u3068\u304b*User Agent*\u3082\u3001\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306b\u5165\u308c\u308b\u3053\u3068\u3082\u3042\u308b\u3002\n\n\u305d\u3057\u3066\u3001Twitter\u306b\u30ea\u30c0\u30a4\u30ec\u30af\u30c8\u3002\n\n\n## 2. \u30a2\u30af\u30bb\u30b9\u30c8\u30fc\u30af\u30f3\u306e\u53d6\u5f97\n\n```py\n@get('/twitter_callback')\ndef twitter_callback():\n    # \u30bb\u30c3\u30b7\u30e7\u30f3\u306b\u4fdd\u5b58\u3057\u305f\u30ea\u30af\u30a8\u30b9\u30c8\u30fb\u30c8\u30fc\u30af\u30f3\uff08request_token_key\uff09\u3001\u30b7\u30fc\u30af\u30ec\u30c3\u30c8\uff08request_token_secret\uff09\u3092\u53d6\u5f97\u3059\u308b\u3002\n\n    oauth_verifier = request.query['oauth_verifier']\n\n    access_token_key, access_token_secret = twitter.get_access_token(\n        twitter_connect.request_token_key,\n        twitter_connect.request_token_secret,\n        oauth_verifier)\n\n    twitter_user = twitter.verify_credentials(access_token_key, access_token_secret)\n\n    # \u30e6\u30fc\u30b6\u30fc\u767b\u9332\u3068\u304b\u30ed\u30b0\u30a4\u30f3\u3068\u304b\u306e\u51e6\u7406\n ```\n\nTwitter\u304b\u3089\u306e\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u306b\u306f\u3001`oauth_verifier`\u304c\u5165\u3063\u3066\u308b\u3093\u3067\u3001\u3053\u308c\u3068\u30bb\u30c3\u30b7\u30e7\u30f3\u306b\u5165\u308c\u3068\u3044\u305f\u30ea\u30af\u30a8\u30b9\u30c8\u30fb\u30c8\u30fc\u30af\u30f3\u3001\u30b7\u30fc\u30af\u30ec\u30c3\u30c8\u3092\u4f7f\u3063\u3066\u3001\u30a2\u30af\u30bb\u30b9\u30fb\u30c8\u30fc\u30af\u30f3\u3001\u30b7\u30fc\u30af\u30ec\u30c3\u30c8\u3092\u53d6\u5f97\u3059\u308b\u3002\n"}