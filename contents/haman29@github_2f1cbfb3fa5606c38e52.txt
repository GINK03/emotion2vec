{"tags": ["devise3.4.1", "Rails4.2.1", "letter_opener_web", "Ruby2.1.5"], "context": " More than 1 year has passed since last update.\n\n\u76ee\u7684\n\u30c7\u30d5\u30a9\u30eb\u30c8\u72b6\u614b\u3067\u306f\u3001\n\u65b0\u898f\u767b\u9332\u6642(confirmation)\u3068\u30e1\u30fc\u30eb\u30a2\u30c9\u30ec\u30b9\u5909\u66f4\u6642(reconfirmation)\u306b\u9001\u4fe1\u3059\u308b\u30e1\u30fc\u30eb\u306e\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u304c\u5171\u901a\u3067\u3001\u7d30\u304b\u304f\u5206\u3051\u305f\u3044\u6642\u306b\u4e0d\u4fbf\u3067\u3042\u308b\u3002\u4f8b\u3048\u3070\u30e1\u30fc\u30eb\u672c\u6587(body)\u306f\u6761\u4ef6\u5206\u5c90\u306a\u3069\u3067\u5bfe\u51e6\u3067\u304d\u308b\u304c\u3001\u4ef6\u540d(subject)\u306f\u5909\u66f4\u3067\u304d\u306a\u3044\u3002\ndevise\u3067\u306f\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u3092\u5206\u3051\u308b\u305f\u3081\u306e\u62e1\u5f35\u30dd\u30a4\u30f3\u30c8Devise::Models::Confirmable#send_on_create_confirmation_instructions\u3092\u7528\u610f\u3057\u3066\u3044\u308b\u3002\ndevise\u3092\u7d99\u627f\u3057\u305f\u30e2\u30c7\u30eb\u3067\u62e1\u5f35\u3067\u304d\u308b\u306e\u3067\u3001\u7c21\u5358\u306b\u5225\u306e\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u3092\u5b9a\u7fa9\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u308b\u3002\n\u4eca\u56de\u306e\u30b5\u30f3\u30d7\u30eb\u306f\u3053\u3061\u3089\u306b\u7f6e\u3044\u3066\u3044\u307e\u3059\u3002\n\n\u624b\u9806\n\nDevise\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n$ rails new devise-sample -T --skip-bundle\n\n\nGemfile\n+gem 'devise'\n+group :development do\n+  gem 'letter_opener_web' # \u3053\u308c\u306f\u7121\u304f\u3066\u3082OK\n+end\n\n\n$ bundle install\n\n$ rails generate devise:install\n\n\nconfig/environments/development.rb\nRails.application.configure do\n# ...\n  config.action_mailer.raise_delivery_errors = false\n+  config.action_mailer.default_url_options = { host: 'localhost', port: 3000 }\n+  config.action_mailer.delivery_method = :letter_opener_web\n# ...\n\n\n$ rails generate devise user\n$ rails g devise:views\n\n\nconfirmable, reconfirmable\u3092\u6709\u52b9\u306b\u3059\u308b\n\napp/models/user.rb\nclass User < ActiveRecord::Base\n   devise :database_authenticatable, :registerable,\n-         :recoverable, :rememberable, :trackable, :validatable\n+         :recoverable, :rememberable, :trackable, :validatable,\n+         :confirmable\n end\n\n\n\ndb/migrate/20150321024955_devise_create_users.rb\nclass DeviseCreateUsers < ActiveRecord::Migration\n       t.string   :last_sign_in_ip\n\n       ## Confirmable\n-      # t.string   :confirmation_token\n-      # t.datetime :confirmed_at\n-      # t.datetime :confirmation_sent_at\n-      # t.string   :unconfirmed_email # Only if using reconfirmable\n+      t.string   :confirmation_token\n+      t.datetime :confirmed_at\n+      t.datetime :confirmation_sent_at\n+      t.string   :unconfirmed_email # Only if using reconfirmable\nend\n\n\n\nconfig/initializers/devise.rb\n+  config.reconfirmable = true\n\n\n\n\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u3092\u5206\u3051\u308b\n\n\n\n\u7528\u9014\n\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\n\n\n\n\n\n\u65b0\u898f\u767b\u9332(confirmation)\nconfirmation_on_create_instructions.html.erb\n\u4efb\u610f\u306e\u540d\u524d(\u7d71\u4e00\u3059\u308b)\n\n\n\u30e1\u30fc\u30eb\u30a2\u30c9\u30ec\u30b9\u5909\u66f4(reconfirmation)\nconfirmation_instructions.html.erb\u3000\n\u30c7\u30d5\u30a9\u30eb\u30c8\n\n\n\nDevise::Models::Confirmable::send_confirmation_instructions\u3092\u53c2\u8003\u306b\u5b9f\u88c5\u3057\u307e\u3057\u305f\u3002\n\napp/models/user.rb\nclass User < ActiveRecord::Base\n   devise :database_authenticatable, :registerable,\n          :recoverable, :rememberable, :trackable, :validatable,\n          :confirmable\n+\n+  # override Devise::Models::Confirmable#send_on_create_confirmation_instructions\n+  def send_on_create_confirmation_instructions\n+    generate_confirmation_token!  unless @raw_confirmation_token\n+    send_devise_notification(:confirmation_on_create_instructions, @raw_confirmation_token, {})\n+  end\n end\n\n\n\napp/views/devise/mailer/confirmation_instructions.html.erb\n-<p>Welcome <%= @email %>!</p>\n+<p>Reconfirmation <%= @email %>!</p>\n\n <p>You can confirm your account email through the link below:</p>\n\n\n\ndevise-sample/app/views/devise/mailer/confirmation_on_create_instructions.erb\n+<p>Welcome <%= @email %>!</p>\n+\n+<p>You can confirm your account email through the link below:</p>\n+\n+<p><%= link_to 'Confirm my account', confirmation_url(@resource, confirmation_token: @token) %></p>\n\n\nDevise::Mailer\u3092\u53c2\u8003\u306b\u5b9f\u88c5\u3057\u307e\u3057\u305f\u3002\n\nconfig/initializers/monkey_patches/devise/mailer.rb\n+if defined?(ActionMailer)\n+  class Devise::Mailer < Devise.parent_mailer.constantize\n+    include Devise::Mailers::Helpers\n+\n+    def confirmation_instructions(record, token, opts={})\n+      @token = token\n+      devise_mail(record, :confirmation_instructions, opts)\n+    end\n+\n+    def reset_password_instructions(record, token, opts={})\n+      @token = token\n+      devise_mail(record, :reset_password_instructions, opts)\n+    end\n+\n+    def unlock_instructions(record, token, opts={})\n+      @token = token\n+      devise_mail(record, :unlock_instructions, opts)\n+    end\n+\n+    # \u65b0\u898f\u8ffd\u52a0!\n+    def confirmation_on_create_instructions(record, token, opts={})\n+      @token = token\n+      devise_mail(record, :confirmation_on_create_instructions, opts)\n+    end\n+  end\n+end\n\n\n\nconfig/locales/devise.en.yml\n       unauthenticated: \"You need to sign in or sign up before continuing.\"\n       unconfirmed: \"You have to confirm your email address before continuing.\"\n     mailer:\n-      confirmation_instructions:\n+      confirmation_on_create_instructions:\n         subject: \"Confirmation instructions\"\n+      confirmation_instructions:\n+        subject: \"Reconfirmation instructions\"\n       reset_password_instructions:\n         subject: \"Reset password instructions\"\n       unlock_instructions:\n\n\n\n\u78ba\u8a8d\nsign_up\u3057\u3066\u30e1\u30fc\u30eb\u304c\u98db\u3093\u3067\u308b\u304b\u78ba\u8a8d\u3059\u308b(\u4e0b\u8a18\u3067\u306f\u4f1a\u54e1\u767b\u9332\u6642\u3060\u3051..)\n\nletter_opener_web\u4fbf\u5229\n\n\n\u53c2\u8003\nhttp://willnet.in/86\nhttps://github.com/plataformatec/devise\nhttps://github.com/fgrehm/letter_opener_web\n## \u76ee\u7684\n\n\u30c7\u30d5\u30a9\u30eb\u30c8\u72b6\u614b\u3067\u306f\u3001\n\u65b0\u898f\u767b\u9332\u6642(confirmation)\u3068\u30e1\u30fc\u30eb\u30a2\u30c9\u30ec\u30b9\u5909\u66f4\u6642(reconfirmation)\u306b\u9001\u4fe1\u3059\u308b\u30e1\u30fc\u30eb\u306e\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u304c\u5171\u901a\u3067\u3001\u7d30\u304b\u304f\u5206\u3051\u305f\u3044\u6642\u306b\u4e0d\u4fbf\u3067\u3042\u308b\u3002\u4f8b\u3048\u3070\u30e1\u30fc\u30eb\u672c\u6587(body)\u306f\u6761\u4ef6\u5206\u5c90\u306a\u3069\u3067\u5bfe\u51e6\u3067\u304d\u308b\u304c\u3001\u4ef6\u540d(subject)\u306f\u5909\u66f4\u3067\u304d\u306a\u3044\u3002\n\ndevise\u3067\u306f\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u3092\u5206\u3051\u308b\u305f\u3081\u306e\u62e1\u5f35\u30dd\u30a4\u30f3\u30c8[`Devise::Models::Confirmable#send_on_create_confirmation_instructions`](https://github.com/plataformatec/devise/blob/v3.4.1/lib/devise/models/confirmable.rb#L157-L159)\u3092\u7528\u610f\u3057\u3066\u3044\u308b\u3002\ndevise\u3092\u7d99\u627f\u3057\u305f\u30e2\u30c7\u30eb\u3067\u62e1\u5f35\u3067\u304d\u308b\u306e\u3067\u3001\u7c21\u5358\u306b\u5225\u306e\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u3092\u5b9a\u7fa9\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u308b\u3002\n\u4eca\u56de\u306e\u30b5\u30f3\u30d7\u30eb\u306f[\u3053\u3061\u3089](https://github.com/haman29/sample/tree/master/devise-sample)\u306b\u7f6e\u3044\u3066\u3044\u307e\u3059\u3002\n\n## \u624b\u9806\n\n### Devise\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n```zsh\n$ rails new devise-sample -T --skip-bundle\n```\n\n```rb:Gemfile\n+gem 'devise'\n+group :development do\n+  gem 'letter_opener_web' # \u3053\u308c\u306f\u7121\u304f\u3066\u3082OK\n+end\n```\n\n```zsh\n$ bundle install\n```\n\n```zsh\n$ rails generate devise:install\n```\n\n```rb:config/environments/development.rb\nRails.application.configure do\n# ...\n  config.action_mailer.raise_delivery_errors = false\n+  config.action_mailer.default_url_options = { host: 'localhost', port: 3000 }\n+  config.action_mailer.delivery_method = :letter_opener_web\n# ...\n```\n\n```zsh\n$ rails generate devise user\n$ rails g devise:views\n```\n\n###confirmable, reconfirmable\u3092\u6709\u52b9\u306b\u3059\u308b\n\n```rb:app/models/user.rb\nclass User < ActiveRecord::Base\n   devise :database_authenticatable, :registerable,\n-         :recoverable, :rememberable, :trackable, :validatable\n+         :recoverable, :rememberable, :trackable, :validatable,\n+         :confirmable\n end\n```\n\n```rb:db/migrate/20150321024955_devise_create_users.rb\nclass DeviseCreateUsers < ActiveRecord::Migration\n       t.string   :last_sign_in_ip\n\n       ## Confirmable\n-      # t.string   :confirmation_token\n-      # t.datetime :confirmed_at\n-      # t.datetime :confirmation_sent_at\n-      # t.string   :unconfirmed_email # Only if using reconfirmable\n+      t.string   :confirmation_token\n+      t.datetime :confirmed_at\n+      t.datetime :confirmation_sent_at\n+      t.string   :unconfirmed_email # Only if using reconfirmable\nend\n```\n```rb:config/initializers/devise.rb\n+  config.reconfirmable = true\n```\n\n### \u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u3092\u5206\u3051\u308b\n\n| \u7528\u9014 | \u30c6\u30f3\u30d7\u30ec\u30fc\u30c8 | | \n|---|---|---|\n| \u65b0\u898f\u767b\u9332(confirmation) | confirmation_on_create_instructions.html.erb | \u4efb\u610f\u306e\u540d\u524d(\u7d71\u4e00\u3059\u308b)\n| \u30e1\u30fc\u30eb\u30a2\u30c9\u30ec\u30b9\u5909\u66f4(reconfirmation) | confirmation_instructions.html.erb\u3000| \u30c7\u30d5\u30a9\u30eb\u30c8 |\n\n[Devise::Models::Confirmable::send_confirmation_instructions](https://github.com/plataformatec/devise/blob/v3.4.1/lib/devise/models/confirmable.rb#L260-L267)\u3092\u53c2\u8003\u306b\u5b9f\u88c5\u3057\u307e\u3057\u305f\u3002\n\n```rb:app/models/user.rb\nclass User < ActiveRecord::Base\n   devise :database_authenticatable, :registerable,\n          :recoverable, :rememberable, :trackable, :validatable,\n          :confirmable\n+\n+  # override Devise::Models::Confirmable#send_on_create_confirmation_instructions\n+  def send_on_create_confirmation_instructions\n+    generate_confirmation_token!  unless @raw_confirmation_token\n+    send_devise_notification(:confirmation_on_create_instructions, @raw_confirmation_token, {})\n+  end\n end\n```\n\n```erb:app/views/devise/mailer/confirmation_instructions.html.erb\n-<p>Welcome <%= @email %>!</p>\n+<p>Reconfirmation <%= @email %>!</p>\n \n <p>You can confirm your account email through the link below:</p>\n```\n \n```erb:devise-sample/app/views/devise/mailer/confirmation_on_create_instructions.erb\n+<p>Welcome <%= @email %>!</p>\n+\n+<p>You can confirm your account email through the link below:</p>\n+\n+<p><%= link_to 'Confirm my account', confirmation_url(@resource, confirmation_token: @token) %></p>\n```\n[Devise::Mailer](https://github.com/plataformatec/devise/blob/v3.4.1/app/mailers/devise/mailer.rb)\u3092\u53c2\u8003\u306b\u5b9f\u88c5\u3057\u307e\u3057\u305f\u3002\n\n```rb:config/initializers/monkey_patches/devise/mailer.rb\n+if defined?(ActionMailer)\n+  class Devise::Mailer < Devise.parent_mailer.constantize\n+    include Devise::Mailers::Helpers\n+\n+    def confirmation_instructions(record, token, opts={})\n+      @token = token\n+      devise_mail(record, :confirmation_instructions, opts)\n+    end\n+\n+    def reset_password_instructions(record, token, opts={})\n+      @token = token\n+      devise_mail(record, :reset_password_instructions, opts)\n+    end\n+\n+    def unlock_instructions(record, token, opts={})\n+      @token = token\n+      devise_mail(record, :unlock_instructions, opts)\n+    end\n+\n+    # \u65b0\u898f\u8ffd\u52a0!\n+    def confirmation_on_create_instructions(record, token, opts={})\n+      @token = token\n+      devise_mail(record, :confirmation_on_create_instructions, opts)\n+    end\n+  end\n+end\n```\n\n```rb:config/locales/devise.en.yml\n       unauthenticated: \"You need to sign in or sign up before continuing.\"\n       unconfirmed: \"You have to confirm your email address before continuing.\"\n     mailer:\n-      confirmation_instructions:\n+      confirmation_on_create_instructions:\n         subject: \"Confirmation instructions\"\n+      confirmation_instructions:\n+        subject: \"Reconfirmation instructions\"\n       reset_password_instructions:\n         subject: \"Reset password instructions\"\n       unlock_instructions:\n```\n\n## \u78ba\u8a8d\n\nsign_up\u3057\u3066\u30e1\u30fc\u30eb\u304c\u98db\u3093\u3067\u308b\u304b\u78ba\u8a8d\u3059\u308b(\u4e0b\u8a18\u3067\u306f\u4f1a\u54e1\u767b\u9332\u6642\u3060\u3051..)\n\n![\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2015-03-21 12.34.14.png](https://qiita-image-store.s3.amazonaws.com/0/3556/c5250c34-bc85-78ad-9d16-1cb0517a2e23.png)\n\n\n`letter_opener_web`\u4fbf\u5229\n\n![\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2015-03-21 12.34.27.png](https://qiita-image-store.s3.amazonaws.com/0/3556/6d756fbb-e827-49f3-4878-8144b3e37e46.png)\n\n## \u53c2\u8003\n\nhttp://willnet.in/86\nhttps://github.com/plataformatec/devise\nhttps://github.com/fgrehm/letter_opener_web\n"}