{"context": " More than 1 year has passed since last update.(MacOSX10.9, Vagrant1.7.2)\n\n\u76ee\u7684\nCoreOS \u516c\u5f0f\u30b5\u30a4\u30c8\u3067\u7d39\u4ecb\u3055\u308c\u3066\u3044\u305f Ansible \u3067 CoreOS \u3092\u7ba1\u7406\u3059\u308b\u65b9\u6cd5\u3092\u8a66\u3057\u3066\u307f\u308b\u3002\n\u57fa\u672c\u7684\u306b\u8a18\u4e8b\u306e Example Playbook \u306e\u7b87\u6240\u307e\u3067\u306f\u305d\u306e\u307e\u307e\u3002\n\u500b\u4eba\u7684\u306b Nginx \u306e\u505c\u6b62\u30fb\u518d\u8d77\u52d5\u306e Playbook \u3092\u8ffd\u52a0\u3057\u3066\u8a66\u3057\u3066\u307f\u308b\u3002\n\nhttps://coreos.com/blog/managing-coreos-with-ansible/\n\n\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\nVagrant\n\nhttp://docs.vagrantup.com/v2/installation/\n\n\nAnsible\n\u30ed\u30fc\u30ab\u30eb\u306b Ansible \u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\n\nhttp://docs.ansible.com/intro_installation.html#installing-the-control-machine\n\n\nVagrant \u3067 CoreOS \u74b0\u5883\u3092\u69cb\u7bc9\u3059\u308b\n$ git clone https://github.com/defunctzombie/coreos-ansible-example.git\n$ cd coreos-ansible-example\n$ vagrant up\n$ ./bin/generate_ssh_config\n\n\ncoreos-bootstrap\nAnsible \u3067 coreos \u5185\u3067 python \u3068 pip \u3092\u4f7f\u3048\u308b\u3088\u3046\u306b\u3059\u308b\u3002\n\nhttps://github.com/defunctzombie/ansible-coreos-bootstrap\n\n$ ansible-galaxy install defunctzombie.coreos-bootstrap -p ./roles\n\n\nbootstrap.yml \u3092\u5b9f\u884c\u3059\u308b\n$ ansible-playbook -i inventory/vagrant bootstrap.yml\n\n\n\u5bfe\u8c61\u30db\u30b9\u30c8\u306e\u60c5\u5831\u3092\u53d6\u5f97\u3057\u3066\u307f\u308b\n$ ansible -i inventory/vagrant all -m setup\ncore-01 | success >> {\n    \"ansible_facts\": {\n        \"ansible_all_ipv4_addresses\": [\n            \"172.17.42.1\",\n            \"172.12.8.101\",\n            ...\n\n\nExample Playbook\n\nnginx container \u3092 pull \u3057\u3066\u8d77\u52d5\u3059\u308b\u3002\n$ ansible-playbook -i inventory/vagrant website.yml\n\n\nhttps://github.com/defunctzombie/coreos-ansible-example/blob/master/website.yml\n\nweb \u30d6\u30e9\u30a6\u30b6\u3067\u78ba\u8a8d\u3057\u3066\u307f\u308b\n\nhttp://172.12.8.101:8080/\n\n\n\nNginx \u306e\u505c\u6b62\u30fb\u518d\u8d77\u52d5\u306e Playbook \u3092\u8ffd\u52a0\u3057\u3066\u307f\u308b\n\u3053\u3053\u304b\u3089\u8a18\u4e8b\u3068\u306f\u5225\u306b\u500b\u4eba\u7684\u306a\u8ffd\u8a18\u3002\n\nnginx \u3092\u505c\u6b62\u3059\u308b\n\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3059\u308b\n\nstop_nginx.yml\n- name: example stop nginx\n  hosts: web\n  tasks:\n    - name: stop nginx\n      docker:\n        image=\"nginx:1.7.1\"\n        name=\"example-nginx\"\n        ports=\"8080:80\"\n        state=stopped\n\n\n\u5b9f\u884c\u3059\u308b\n$ ansible-playbook -i inventory/vagrant stop_nginx.yml\n\nPLAY [example stop nginx] *****************************************************\n\nGATHERING FACTS ***************************************************************\nok: [core-01]\n\nTASK: [stop nginx] ************************************************************\nchanged: [core-01]\n\nPLAY RECAP ********************************************************************\ncore-01                    : ok=2    changed=1    unreachable=0    failed=0\n\nweb \u30d6\u30e9\u30a6\u30b6\u3067\u78ba\u8a8d\u3059\u308b\u3068\u63a5\u7d9a\u3067\u304d\u306a\u304f\u306a\u3063\u3066\u3044\u308b\n\nhttp://172.12.8.101:8080/\n\n\nnginx \u3092\u30ea\u30b9\u30bf\u30fc\u30c8\u3059\u308b\n\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3059\u308b\n\nrestart_nginx.yml\n- name: example restart nginx\n  hosts: web\n  tasks:\n    - name: restart nginx\n      docker:\n        image=\"nginx:1.7.1\"\n        name=\"example-nginx\"\n        ports=\"8080:80\"\n        state=restarted\n\n\n\u5b9f\u884c\u3059\u308b\n$ ansible-playbook -i inventory/vagrant restart_nginx.yml\n\nPLAY [example restart nginx] **************************************************\n\nGATHERING FACTS ***************************************************************\nok: [core-01]\n\nTASK: [restart nginx] *********************************************************\nchanged: [core-01]\n\nPLAY RECAP ********************************************************************\ncore-01                    : ok=2    changed=1    unreachable=0    failed=0\n\nweb \u30d6\u30e9\u30a6\u30b6\u3067\u78ba\u8a8d\u3059\u308b\u3068\u8868\u793a\u3055\u308c\u3066\u3044\u308b\n\nhttp://172.12.8.101:8080/\n\n\n\n[\u8ffd\u8a18] systemd \u3067\u30b5\u30fc\u30d3\u30b9\u3092\u8d77\u52d5\u3057\u3066\u307f\u308b\n\u307e\u305a nginx \u306e docker \u30a4\u30e1\u30fc\u30b8\u3092\u524a\u9664\u3059\u308b\n$ vagrant ssh core-01\n\ncore@core-01 ~ $ docker ps\ncore@core-01 ~ $ docker kill example-nginx\ncore@core-01 ~ $ docker rm example-nginx\n\n\u8d77\u52d5\u3057\u3066\u3044\u306a\u3044\u4e8b\u3092\u78ba\u8a8d\u3059\u308b\u3002\ncore@core-01 ~ $ curl http://172.12.8.101:8080/\ncurl: (7) Failed to connect to 172.12.8.101 port 8080: Connection refused\n\n\nnginx.service \u3092\u4f5c\u6210\u3059\u308b\u3000\ncore@core-01 ~ $ sudo vim /etc/systemd/system/nginx.service\n\n\n/etc/systemd/system/nginx.service\n[Unit]\nDescription=example-nginx-description\nAfter=docker.service\nRequires=docker.service\n\n[Service]\nTimeoutStartSec=0\nExecStartPre=-/usr/bin/docker kill example-nginx\nExecStartPre=-/usr/bin/docker rm example-nginx\nExecStartPre=/usr/bin/docker pull nginx:1.7.1\nExecStart=/usr/bin/docker run -d -p 8080:80 --name example-nginx nginx\n\n[Install]\nWantedBy=multi-user.target\n\n\n\u3000\n\nsystemctl \u3067\u8d77\u52d5\u3059\u308b\nsudo systemctl enable /etc/systemd/system/nginx.service\ncore@core-01 ~ $ sudo systemctl start nginx.service\n\n\u8d77\u52d5\u3057\u3066\u3044\u308b\u304b\u78ba\u8a8d\u3059\u308b\ncore@core-01 ~ $ curl http://172.12.8.101:8080/\n<!DOCTYPE html>\n<html>\n<head>\n<title>Welcome to nginx!</title>\n<style>\n    body {\n        ...\n\n\n\u53c2\u8003\n\nhttps://coreos.com/blog/managing-coreos-with-ansible/\nhttps://coreos.com/docs/launching-containers/launching/getting-started-with-systemd/\nhttp://docs.ansible.com/docker_module.html\n\n\n(MacOSX10.9, Vagrant1.7.2)\n\n## \u76ee\u7684\n\nCoreOS \u516c\u5f0f\u30b5\u30a4\u30c8\u3067\u7d39\u4ecb\u3055\u308c\u3066\u3044\u305f Ansible \u3067 CoreOS \u3092\u7ba1\u7406\u3059\u308b\u65b9\u6cd5\u3092\u8a66\u3057\u3066\u307f\u308b\u3002\n\u57fa\u672c\u7684\u306b\u8a18\u4e8b\u306e `Example Playbook` \u306e\u7b87\u6240\u307e\u3067\u306f\u305d\u306e\u307e\u307e\u3002\n\u500b\u4eba\u7684\u306b Nginx \u306e\u505c\u6b62\u30fb\u518d\u8d77\u52d5\u306e Playbook \u3092\u8ffd\u52a0\u3057\u3066\u8a66\u3057\u3066\u307f\u308b\u3002\n\n- https://coreos.com/blog/managing-coreos-with-ansible/\n\n\n## \u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n### Vagrant\n\n- http://docs.vagrantup.com/v2/installation/\n\n### Ansible\n\n\u30ed\u30fc\u30ab\u30eb\u306b Ansible \u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\n\n- http://docs.ansible.com/intro_installation.html#installing-the-control-machine\n\n\n## Vagrant \u3067 CoreOS \u74b0\u5883\u3092\u69cb\u7bc9\u3059\u308b\n\n```\n$ git clone https://github.com/defunctzombie/coreos-ansible-example.git\n$ cd coreos-ansible-example\n$ vagrant up\n$ ./bin/generate_ssh_config\n```\n\n\n## coreos-bootstrap\n\nAnsible \u3067 coreos \u5185\u3067 python \u3068 pip \u3092\u4f7f\u3048\u308b\u3088\u3046\u306b\u3059\u308b\u3002\n\n- https://github.com/defunctzombie/ansible-coreos-bootstrap\n\n```\n$ ansible-galaxy install defunctzombie.coreos-bootstrap -p ./roles\n```\n\n### bootstrap.yml \u3092\u5b9f\u884c\u3059\u308b\n\n```\n$ ansible-playbook -i inventory/vagrant bootstrap.yml\n```\n\n### \u5bfe\u8c61\u30db\u30b9\u30c8\u306e\u60c5\u5831\u3092\u53d6\u5f97\u3057\u3066\u307f\u308b\n\n```\n$ ansible -i inventory/vagrant all -m setup\ncore-01 | success >> {\n    \"ansible_facts\": {\n        \"ansible_all_ipv4_addresses\": [\n            \"172.17.42.1\",\n            \"172.12.8.101\",\n            ...\n```\n\n## Example Playbook\n\n### nginx container \u3092 pull \u3057\u3066\u8d77\u52d5\u3059\u308b\u3002\n\n```\n$ ansible-playbook -i inventory/vagrant website.yml\n```\n\n- https://github.com/defunctzombie/coreos-ansible-example/blob/master/website.yml\n\nweb \u30d6\u30e9\u30a6\u30b6\u3067\u78ba\u8a8d\u3057\u3066\u307f\u308b\n \n- http://172.12.8.101:8080/\n\n![\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2015-05-31 12.54.53.png](https://qiita-image-store.s3.amazonaws.com/0/41656/fe3a0fa2-c957-685e-4c4c-6da58f2f84f8.png \"\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2015-05-31 12.54.53.png\")\n\n\n## Nginx \u306e\u505c\u6b62\u30fb\u518d\u8d77\u52d5\u306e Playbook \u3092\u8ffd\u52a0\u3057\u3066\u307f\u308b\n\n\u3053\u3053\u304b\u3089\u8a18\u4e8b\u3068\u306f\u5225\u306b\u500b\u4eba\u7684\u306a\u8ffd\u8a18\u3002\n\n### nginx \u3092\u505c\u6b62\u3059\u308b\n\n\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3059\u308b\n\n```stop_nginx.yml\n- name: example stop nginx\n  hosts: web\n  tasks:\n    - name: stop nginx\n      docker:\n        image=\"nginx:1.7.1\"\n        name=\"example-nginx\"\n        ports=\"8080:80\"\n        state=stopped\n```\n\n\u5b9f\u884c\u3059\u308b\n\n```\n$ ansible-playbook -i inventory/vagrant stop_nginx.yml\n\nPLAY [example stop nginx] *****************************************************\n\nGATHERING FACTS ***************************************************************\nok: [core-01]\n\nTASK: [stop nginx] ************************************************************\nchanged: [core-01]\n\nPLAY RECAP ********************************************************************\ncore-01                    : ok=2    changed=1    unreachable=0    failed=0\n```\n\nweb \u30d6\u30e9\u30a6\u30b6\u3067\u78ba\u8a8d\u3059\u308b\u3068\u63a5\u7d9a\u3067\u304d\u306a\u304f\u306a\u3063\u3066\u3044\u308b\n \n- http://172.12.8.101:8080/\n\n\n### nginx \u3092\u30ea\u30b9\u30bf\u30fc\u30c8\u3059\u308b\n\n\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3059\u308b\n\n```restart_nginx.yml\n- name: example restart nginx\n  hosts: web\n  tasks:\n    - name: restart nginx\n      docker:\n        image=\"nginx:1.7.1\"\n        name=\"example-nginx\"\n        ports=\"8080:80\"\n        state=restarted\n```\n\n\u5b9f\u884c\u3059\u308b\n\n```\n$ ansible-playbook -i inventory/vagrant restart_nginx.yml\n\nPLAY [example restart nginx] **************************************************\n\nGATHERING FACTS ***************************************************************\nok: [core-01]\n\nTASK: [restart nginx] *********************************************************\nchanged: [core-01]\n\nPLAY RECAP ********************************************************************\ncore-01                    : ok=2    changed=1    unreachable=0    failed=0\n```\n\nweb \u30d6\u30e9\u30a6\u30b6\u3067\u78ba\u8a8d\u3059\u308b\u3068\u8868\u793a\u3055\u308c\u3066\u3044\u308b\n \n- http://172.12.8.101:8080/\n\n![\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2015-05-31 12.54.53.png](https://qiita-image-store.s3.amazonaws.com/0/41656/fe3a0fa2-c957-685e-4c4c-6da58f2f84f8.png \"\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2015-05-31 12.54.53.png\")\n\n\n## [\u8ffd\u8a18] systemd \u3067\u30b5\u30fc\u30d3\u30b9\u3092\u8d77\u52d5\u3057\u3066\u307f\u308b\n\n\n\u307e\u305a nginx \u306e docker \u30a4\u30e1\u30fc\u30b8\u3092\u524a\u9664\u3059\u308b\n\n```\n$ vagrant ssh core-01\n\ncore@core-01 ~ $ docker ps\ncore@core-01 ~ $ docker kill example-nginx\ncore@core-01 ~ $ docker rm example-nginx\n```\n\n\u8d77\u52d5\u3057\u3066\u3044\u306a\u3044\u4e8b\u3092\u78ba\u8a8d\u3059\u308b\u3002\n\n```\ncore@core-01 ~ $ curl http://172.12.8.101:8080/\ncurl: (7) Failed to connect to 172.12.8.101 port 8080: Connection refused\n```\n\n### nginx.service \u3092\u4f5c\u6210\u3059\u308b\u3000\n\n```\ncore@core-01 ~ $ sudo vim /etc/systemd/system/nginx.service\n```\n\n```/etc/systemd/system/nginx.service\n[Unit]\nDescription=example-nginx-description\nAfter=docker.service\nRequires=docker.service\n\n[Service]\nTimeoutStartSec=0\nExecStartPre=-/usr/bin/docker kill example-nginx\nExecStartPre=-/usr/bin/docker rm example-nginx\nExecStartPre=/usr/bin/docker pull nginx:1.7.1\nExecStart=/usr/bin/docker run -d -p 8080:80 --name example-nginx nginx\n\n[Install]\nWantedBy=multi-user.target\n```\n\u3000\n### systemctl \u3067\u8d77\u52d5\u3059\u308b\n\n\n```\nsudo systemctl enable /etc/systemd/system/nginx.service\ncore@core-01 ~ $ sudo systemctl start nginx.service\n```\n\n\u8d77\u52d5\u3057\u3066\u3044\u308b\u304b\u78ba\u8a8d\u3059\u308b\n\n```\ncore@core-01 ~ $ curl http://172.12.8.101:8080/\n<!DOCTYPE html>\n<html>\n<head>\n<title>Welcome to nginx!</title>\n<style>\n    body {\n        ...\n```\n\n\n## \u53c2\u8003\n\n- https://coreos.com/blog/managing-coreos-with-ansible/\n- https://coreos.com/docs/launching-containers/launching/getting-started-with-systemd/\n- http://docs.ansible.com/docker_module.html\n", "tags": ["docker", "CoreOS", "Ansible", "vagrant"]}