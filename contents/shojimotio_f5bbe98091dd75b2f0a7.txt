{"tags": ["AWS", "AWS_SDK", "PHP"], "context": " More than 1 year has passed since last update.\n\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u30d0\u30c3\u30af\u30a2\u30c3\u30d7(AMI)\u3092\u81ea\u52d5\u30671\u65e51\u56de\u4f5c\u308a\u305f\u3044\u3002\n\u4efb\u610f\u306e\u6642\u9593\u306bcrontab\u3067\uff11\u56de\u5b9f\u884c\u3057\u3088\u3046\u3002\n\u4fdd\u5b58\u671f\u9593\u30923\u65e5\u9593\uff5e7\u65e5\u9593\u3001\u307e\u305f\u306f\u4efb\u610f\u306e\u65e5\u6570\u4fdd\u5b58\u3057\u3066\u304a\u304d\u305f\u3044\u3002\n\u53e4\u3044AMI\u306f\u81ea\u52d5\u3067\u524a\u9664\u3057\u305f\u3044\u3002AMI\u3068\u30b9\u30ca\u30c3\u30d7\u30b7\u30e7\u30c3\u30c8\u3092\u4e21\u65b9\u6d88\u3059\u5fc5\u8981\u304c\u3042\u308b\u3002\u30bf\u30b0AutoCreated\u306b\u4f5c\u6210\u65e5\u3092\u4ed8\u3051\u3066\u53d6\u5f97\u3057\u3088\u3046\u3002\n\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u3057\u305f\u3044EC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306b\u30bf\u30b0DailyBackup\u3092\u4ed8\u3051\u3066\u5236\u5fa1\u3057\u305f\u3044\u3002\n\n\n\u3044\u304d\u306a\u308a\u30d7\u30ed\u30b0\u30e9\u30e0\u3092\u30b3\u30d4\u30da\u3059\u308b\n\ncreate_image.php\n<?php\n\n// Include the SDK using the Composer autoloader\nrequire 'vendor/autoload.php';\n\nuse Aws\\Ec2\\Ec2Client;\n\n$today = date('Y-m-d H:i:s');\necho \"---BEGIN--- Create Image {$today}\\n\";\n\n# \u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u306e\u4fdd\u5b58\u65e5\u6570\n$delete_date = date('Y-m-d', strtotime('- 3 day'));\ndefine('DELETE_DATE', $delete_date);\n\n# ap-northeast-1    \u30a2\u30b8\u30a2\u30d1\u30b7\u30d5\u30a3\u30c3\u30af\uff08\u6771\u4eac\uff09\n# ap-southeast-1    \u30a2\u30b8\u30a2\u30d1\u30b7\u30d5\u30a3\u30c3\u30af (\u30b7\u30f3\u30ac\u30dd\u30fc\u30eb)\n# ap-southeast-2    \u30a2\u30b8\u30a2\u30d1\u30b7\u30d5\u30a3\u30c3\u30af\uff08\u30b7\u30c9\u30cb\u30fc\uff09\n# eu-central-1      \u6b27\u5dde (\u30d5\u30e9\u30f3\u30af\u30d5\u30eb\u30c8)\n# eu-west-1         \u6b27\u5dde (\u30a2\u30a4\u30eb\u30e9\u30f3\u30c9)\n# sa-east-1         \u5357\u7c73\uff08\u30b5\u30f3\u30d1\u30a6\u30ed\uff09\n# us-east-1         US East (N. Virginia)\n# us-west-1         \u7c73\u56fd\u897f\u90e8\uff08\u5317\u30ab\u30ea\u30d5\u30a9\u30eb\u30cb\u30a2\uff09\n# us-west-2         \u7c73\u56fd\u897f\u90e8\uff08\u30aa\u30ec\u30b4\u30f3\uff09\n# \u51e6\u7406\u5b9f\u884c\u3059\u308b\u30ea\u30fc\u30b8\u30e7\u30f3\n# eu-central-1      \u6b27\u5dde (\u30d5\u30e9\u30f3\u30af\u30d5\u30eb\u30c8) \u3053\u3053\u306f\u6709\u52b9\u9818\u57df\u3067\u306a\u3044\u306e\u3067\u5916\u3059\u3053\u3068\n$regions = [\n    'ap-northeast-1',\n    'ap-southeast-1',\n    'ap-southeast-2',\n    'eu-west-1',\n    'sa-east-1',\n    'us-east-1',\n    'us-west-1',\n    'us-west-2',\n];\n\n# \u5404\u30ea\u30fc\u30b8\u30e7\u30f3\u6bce\u306b\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\n$return = array_map('backup', $regions);\n# \u5404\u30ea\u30fc\u30b8\u30e7\u30f3\u6bce\u306b\u4fdd\u5b58\u671f\u9593\u306e\u904e\u304e\u305fAMI\u3068Snapshot\u3092\u6d88\u3059\n$return = array_map('delete_images', $regions);\n\nfunction backup($region)\n{\n    echo \"---$region BIGIN--- Auto Backup\\n\";\n\n    # \u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u4f5c\u6210\n    $ec2client = Ec2Client::factory(['region' => $region]);\n\n    # \u5bfe\u8c61instance_ids\u53d6\u5f97\n    $target_instances = $ec2client->describeInstances(\n        [\n            'Filters' => [\n                [\n                    'Name' => 'tag:DailyBackup',\n                    'Values' => ['true'],\n                ],\n            ],\n        ]\n    );\n\n    $target_ids = $target_instances->getPath('Reservations/*/Instances/0/InstanceId');\n\n    # id\u7121\u3044\u306a\u3089\u51e6\u7406\u7d42\u4e86\n    if (empty($target_ids))\n    {\n        echo \"---$region FINISH--- Target insetances is empty. Not back up anything.\\n\";\n\n        return;\n    }\n\n    # AMI\u3092instance_ids\u5206\u4f5c\u308b\u3002\n    foreach ($target_ids as $id)\n    {\n        $result = create_image($ec2client, $id);\n        $image_id = $result['ImageId'];\n\n        # Image\u304c\u4f5c\u6210\u3055\u308c\u308b\u307e\u3067\u5c11\u3057\u5f85\u3064\u3002sleep\u7121\u3044\u3068\u3001\u30bf\u30b0\u304c\u4ed8\u304b\u306a\u3044\u4e8b\u304c\u3042\u3063\u305f\n        sleep(1);\n        $result = add_tag($ec2client, $image_id, 'AutoCreated', date('Y-m-d'));\n\n        $image_info = $ec2client->describeImages(\n            [\n                'ImageIds' => [$image_id],\n            ]\n        );\n        $snapshot_id = $image_info->getPath('Images/0/BlockDeviceMappings/0/Ebs/SnapshotId');\n        $result = add_tag($ec2client, $snapshot_id, 'AutoCreated', date('Y-m-d'));\n        echo \"instance_id: $id AMI: $image_id Snapshot_id: $snapshot_id \\n\";\n    }\n    echo \"---$region FINISH--- Auto Backup\\n\";\n}\n\nfunction create_image($ec2client, $instance_id)\n{\n    $result = $ec2client->createImage(\n        [\n            'InstanceId' => $instance_id,\n            'Name' => $instance_id . '_autobackup_' . date('Y-m-d-H-i-s'),\n            'Description' => 'autobackup create' . date('Y-m-d-H-i-s'),\n            'NoReboot' => true,\n        ]\n    );\n\n    return $result;\n}\n\nfunction add_tag($ec2client, $resource_id, $key, $value)\n{\n    $result = $ec2client->createTags(\n        [\n            'Resources' => [$resource_id],\n            'Tags' => [\n                [\n                    'Key' => $key,\n                    'Value' => $value,\n                ],\n            ],\n        ]\n    );\n\n    return $result;\n}\n\nfunction delete_images($region)\n{\n    echo \"---$region BIGIN--- Delete AMI and SnapShot\\n\";\n\n    # \u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u4f5c\u6210\n    $ec2client = Ec2Client::factory(['region' => $region]);\n\n    # \u524a\u9664\u5bfe\u8c61\u306eID\u3092\u53d6\u5f97\u3059\u308b\n    list($image_ids, $snapshot_ids) = get_delete_image_ids($ec2client);\n\n    # ID\u304c\u7121\u3044\u306a\u3089\u51e6\u7406\u7d42\u4e86\n    if (empty($image_ids))\n    {\n        echo \"---$region FINISH--- Image ids is empty. Not delete anything\\n\";\n\n        return;\n    }\n\n    # AMI\u3092\u524a\u9664\u3059\u308b\n    $result = deregister_images($ec2client, $image_ids);\n\n    # SnapShot\u3092\u524a\u9664\u3059\u308b\n    $result = delete_snapshot($ec2client, $snapshot_ids);\n\n    echo \"---$region FINISH--- Delete AMI and SnapShot\\n\";\n}\n\nfunction get_delete_image_ids($ec2client)\n{\n    $result = $ec2client->describeImages([\n        'Filters' => [\n            [\n                'Name' => 'tag:AutoCreated',\n                'Values' => [DELETE_DATE],\n            ],\n        ],\n    ]);\n\n    # image_id\u3092\u53d6\u5f97\u3059\u308b\u3064\u3044\u3067\u306bSnapshot_id\u3082\u53d6\u5f97\u3067\u304d\u308b\u306e\u3067\u53d6\u5f97\u3059\u308b\n    $image_ids = $result->getPath('Images/*/ImageId');\n    $snapshot_ids = $result->getPath('Images/*/BlockDeviceMappings/0/Ebs/SnapshotId');\n\n    return [$image_ids, $snapshot_ids];\n}\n\nfunction deregister_images($ec2client, $image_ids)\n{\n    foreach ($image_ids as $id)\n    {\n        $result = $ec2client->deregisterImage(\n            [\n                'ImageId' => $id,\n            ]\n        );\n        echo 'deregister Image: ', $id, \"\\n\";\n    }\n\n    return $result;\n}\n\nfunction delete_snapshot($ec2client, $snapshot_ids)\n{\n    foreach ($snapshot_ids as $id)\n    {\n        $result = $ec2client->deleteSnapshot(\n            [\n                'SnapshotId' => $id,\n            ]\n        );\n        echo 'delete snapshot:  ', $id, \"\\n\";\n    }\n\n    return $result;\n}\n\necho \"---END--- Create Image \\n\";\n\n\n\n\n\u5b9f\u884c\n\n\u30bf\u30b0DailyBackup:true\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u304c\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u3055\u308c\u308b\n\u30bf\u30b0AutoCreated\uff1aYY-mm-dd\u3068\u3064\u3044\u3066\u3044\u3066\u3001\uff13\u65e5\u524d\u306eAMI\u3068\u5bfe\u5fdc\u3059\u308bSnapShot\u304c\u524a\u9664\u3055\u308c\u308b\u3002\n\n$ php create_image.php\n---BEGIN--- Create Image 2015-04-30 16:00:11\n---sa-east-1 BIGIN--- Auto Backup\n---sa-east-1 FINISH--- Target insetances is empty. Not back up anything.\n---us-east-1 BIGIN--- Auto Backup\ninstance_id: i-e74019b7 AMI: ami-82e5eaea Snapshot_id: snap-c03c2559\ninstance_id: i-ac737157 AMI: ami-66e4eb0e Snapshot_id: snap-183e2781\n---us-east-1 FINISH--- Auto Backup\n---sa-east-1 BIGIN--- Delete AMI and SnapShot\n---sa-east-1 FINISH--- Image ids is empty. Not delete anything\n---us-east-1 BIGIN--- Delete AMI and SnapShot\n---us-east-1 FINISH--- Image ids is empty. Not delete anything\n---END--- Create Image\n\n\nCrontab\u3067\uff11\u65e5\u4e00\u56de \u81ea\u52d5\u5b9f\u884c\u3055\u305b\u308b\n\ncrontab\nSHELL=/bin/bash\n# root PATH\u3092\u8a2d\u5b9a\nPATH=/usr/local/bin:/bin:/usr/bin:/usr/local/sbin:/usr/sbin:/sbin:/opt/aws/bin:/home/ec2-user/bin:/opt/aws/bin\n# mail\u3092\u9001\u4fe1\u3057\u305f\u304f\u306a\u3044\u6642\nMAILTO=\"\"\nAWS=/home/ec2-user/aws-php\n\n# \u6642\u9593\u306fJST\u304bUST\u304b\u30b7\u30b9\u30c6\u30e0\u306b\u5408\u308f\u305b\u308b\u3002\u4eca\u56de\u306fJST\u3002 \u30ed\u30b0\u306fmessage\u306b\u5410\u304d\u51fa\u3059\u3002\n# EC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u696d\u52d9\u6642\u9593\u3060\u3051\u81ea\u52d5\u8d77\u52d5\u3059\u308b\u51e6\u7406\n27 8 * * 1-5 php $AWS/ec2_start.php  2>&1 | logger -t AWS_SDK_AUTO -p local0.info\n# EC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u6bce\u65e5\u81ea\u52d5\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u3059\u308b\u51e6\u7406\n21 8 * * * php $AWS/create_image.php  2>&1 | logger -t AWS_SDK_AUTO -p local0.info\n\n\n\n\u95a2\u9023\u3059\u308b\u30da\u30fc\u30b8\nEC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u696d\u52d9\u6642\u9593\u3060\u3051\u81ea\u52d5\u8d77\u52d5\u3059\u308b\u51e6\u7406\u3092AWS SDK for PHP 2\u3067\u4f5c\u6210\u3059\u308b\n\u81ea\u52d5\u8d77\u52d5\u51e6\u7406\u3059\u308bEC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u81ea\u8eab\u3092\u30aa\u30fc\u30c8\u30b9\u30b1\u30fc\u30eb\u30671\u6642\u9593\u3060\u3051\u8d77\u52d5\u3059\u308b\n* \u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u30d0\u30c3\u30af\u30a2\u30c3\u30d7(AMI)\u3092\u81ea\u52d5\u30671\u65e51\u56de\u4f5c\u308a\u305f\u3044\u3002\n* \u4efb\u610f\u306e\u6642\u9593\u306bcrontab\u3067\uff11\u56de\u5b9f\u884c\u3057\u3088\u3046\u3002\n* \u4fdd\u5b58\u671f\u9593\u30923\u65e5\u9593\uff5e7\u65e5\u9593\u3001\u307e\u305f\u306f\u4efb\u610f\u306e\u65e5\u6570\u4fdd\u5b58\u3057\u3066\u304a\u304d\u305f\u3044\u3002\n* \u53e4\u3044AMI\u306f\u81ea\u52d5\u3067\u524a\u9664\u3057\u305f\u3044\u3002AMI\u3068\u30b9\u30ca\u30c3\u30d7\u30b7\u30e7\u30c3\u30c8\u3092\u4e21\u65b9\u6d88\u3059\u5fc5\u8981\u304c\u3042\u308b\u3002\u30bf\u30b0AutoCreated\u306b\u4f5c\u6210\u65e5\u3092\u4ed8\u3051\u3066\u53d6\u5f97\u3057\u3088\u3046\u3002\n* \u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u3057\u305f\u3044EC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306b\u30bf\u30b0DailyBackup\u3092\u4ed8\u3051\u3066\u5236\u5fa1\u3057\u305f\u3044\u3002\n\n# \u3044\u304d\u306a\u308a\u30d7\u30ed\u30b0\u30e9\u30e0\u3092\u30b3\u30d4\u30da\u3059\u308b\n\n```php:create_image.php\n<?php\n\n// Include the SDK using the Composer autoloader\nrequire 'vendor/autoload.php';\n\nuse Aws\\Ec2\\Ec2Client;\n\n$today = date('Y-m-d H:i:s');\necho \"---BEGIN--- Create Image {$today}\\n\";\n\n# \u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u306e\u4fdd\u5b58\u65e5\u6570\n$delete_date = date('Y-m-d', strtotime('- 3 day'));\ndefine('DELETE_DATE', $delete_date);\n\n# ap-northeast-1    \u30a2\u30b8\u30a2\u30d1\u30b7\u30d5\u30a3\u30c3\u30af\uff08\u6771\u4eac\uff09\n# ap-southeast-1    \u30a2\u30b8\u30a2\u30d1\u30b7\u30d5\u30a3\u30c3\u30af (\u30b7\u30f3\u30ac\u30dd\u30fc\u30eb)\n# ap-southeast-2    \u30a2\u30b8\u30a2\u30d1\u30b7\u30d5\u30a3\u30c3\u30af\uff08\u30b7\u30c9\u30cb\u30fc\uff09\n# eu-central-1      \u6b27\u5dde (\u30d5\u30e9\u30f3\u30af\u30d5\u30eb\u30c8)\n# eu-west-1         \u6b27\u5dde (\u30a2\u30a4\u30eb\u30e9\u30f3\u30c9)\n# sa-east-1         \u5357\u7c73\uff08\u30b5\u30f3\u30d1\u30a6\u30ed\uff09\n# us-east-1         US East (N. Virginia)\n# us-west-1         \u7c73\u56fd\u897f\u90e8\uff08\u5317\u30ab\u30ea\u30d5\u30a9\u30eb\u30cb\u30a2\uff09\n# us-west-2         \u7c73\u56fd\u897f\u90e8\uff08\u30aa\u30ec\u30b4\u30f3\uff09\n# \u51e6\u7406\u5b9f\u884c\u3059\u308b\u30ea\u30fc\u30b8\u30e7\u30f3\n# eu-central-1      \u6b27\u5dde (\u30d5\u30e9\u30f3\u30af\u30d5\u30eb\u30c8) \u3053\u3053\u306f\u6709\u52b9\u9818\u57df\u3067\u306a\u3044\u306e\u3067\u5916\u3059\u3053\u3068\n$regions = [\n    'ap-northeast-1',\n    'ap-southeast-1',\n    'ap-southeast-2',\n    'eu-west-1',\n    'sa-east-1',\n    'us-east-1',\n    'us-west-1',\n    'us-west-2',\n];\n\n# \u5404\u30ea\u30fc\u30b8\u30e7\u30f3\u6bce\u306b\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\n$return = array_map('backup', $regions);\n# \u5404\u30ea\u30fc\u30b8\u30e7\u30f3\u6bce\u306b\u4fdd\u5b58\u671f\u9593\u306e\u904e\u304e\u305fAMI\u3068Snapshot\u3092\u6d88\u3059\n$return = array_map('delete_images', $regions);\n\nfunction backup($region)\n{\n    echo \"---$region BIGIN--- Auto Backup\\n\";\n\n    # \u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u4f5c\u6210\n    $ec2client = Ec2Client::factory(['region' => $region]);\n\n    # \u5bfe\u8c61instance_ids\u53d6\u5f97\n    $target_instances = $ec2client->describeInstances(\n        [\n            'Filters' => [\n                [\n                    'Name' => 'tag:DailyBackup',\n                    'Values' => ['true'],\n                ],\n            ],\n        ]\n    );\n\n    $target_ids = $target_instances->getPath('Reservations/*/Instances/0/InstanceId');\n\n    # id\u7121\u3044\u306a\u3089\u51e6\u7406\u7d42\u4e86\n    if (empty($target_ids))\n    {\n        echo \"---$region FINISH--- Target insetances is empty. Not back up anything.\\n\";\n\n        return;\n    }\n\n    # AMI\u3092instance_ids\u5206\u4f5c\u308b\u3002\n    foreach ($target_ids as $id)\n    {\n        $result = create_image($ec2client, $id);\n        $image_id = $result['ImageId'];\n\n        # Image\u304c\u4f5c\u6210\u3055\u308c\u308b\u307e\u3067\u5c11\u3057\u5f85\u3064\u3002sleep\u7121\u3044\u3068\u3001\u30bf\u30b0\u304c\u4ed8\u304b\u306a\u3044\u4e8b\u304c\u3042\u3063\u305f\n        sleep(1);\n        $result = add_tag($ec2client, $image_id, 'AutoCreated', date('Y-m-d'));\n\n        $image_info = $ec2client->describeImages(\n            [\n                'ImageIds' => [$image_id],\n            ]\n        );\n        $snapshot_id = $image_info->getPath('Images/0/BlockDeviceMappings/0/Ebs/SnapshotId');\n        $result = add_tag($ec2client, $snapshot_id, 'AutoCreated', date('Y-m-d'));\n        echo \"instance_id: $id AMI: $image_id Snapshot_id: $snapshot_id \\n\";\n    }\n    echo \"---$region FINISH--- Auto Backup\\n\";\n}\n\nfunction create_image($ec2client, $instance_id)\n{\n    $result = $ec2client->createImage(\n        [\n            'InstanceId' => $instance_id,\n            'Name' => $instance_id . '_autobackup_' . date('Y-m-d-H-i-s'),\n            'Description' => 'autobackup create' . date('Y-m-d-H-i-s'),\n            'NoReboot' => true,\n        ]\n    );\n\n    return $result;\n}\n\nfunction add_tag($ec2client, $resource_id, $key, $value)\n{\n    $result = $ec2client->createTags(\n        [\n            'Resources' => [$resource_id],\n            'Tags' => [\n                [\n                    'Key' => $key,\n                    'Value' => $value,\n                ],\n            ],\n        ]\n    );\n\n    return $result;\n}\n\nfunction delete_images($region)\n{\n    echo \"---$region BIGIN--- Delete AMI and SnapShot\\n\";\n\n    # \u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u4f5c\u6210\n    $ec2client = Ec2Client::factory(['region' => $region]);\n\n    # \u524a\u9664\u5bfe\u8c61\u306eID\u3092\u53d6\u5f97\u3059\u308b\n    list($image_ids, $snapshot_ids) = get_delete_image_ids($ec2client);\n\n    # ID\u304c\u7121\u3044\u306a\u3089\u51e6\u7406\u7d42\u4e86\n    if (empty($image_ids))\n    {\n        echo \"---$region FINISH--- Image ids is empty. Not delete anything\\n\";\n\n        return;\n    }\n\n    # AMI\u3092\u524a\u9664\u3059\u308b\n    $result = deregister_images($ec2client, $image_ids);\n\n    # SnapShot\u3092\u524a\u9664\u3059\u308b\n    $result = delete_snapshot($ec2client, $snapshot_ids);\n\n    echo \"---$region FINISH--- Delete AMI and SnapShot\\n\";\n}\n\nfunction get_delete_image_ids($ec2client)\n{\n    $result = $ec2client->describeImages([\n        'Filters' => [\n            [\n                'Name' => 'tag:AutoCreated',\n                'Values' => [DELETE_DATE],\n            ],\n        ],\n    ]);\n\n    # image_id\u3092\u53d6\u5f97\u3059\u308b\u3064\u3044\u3067\u306bSnapshot_id\u3082\u53d6\u5f97\u3067\u304d\u308b\u306e\u3067\u53d6\u5f97\u3059\u308b\n    $image_ids = $result->getPath('Images/*/ImageId');\n    $snapshot_ids = $result->getPath('Images/*/BlockDeviceMappings/0/Ebs/SnapshotId');\n\n    return [$image_ids, $snapshot_ids];\n}\n\nfunction deregister_images($ec2client, $image_ids)\n{\n    foreach ($image_ids as $id)\n    {\n        $result = $ec2client->deregisterImage(\n            [\n                'ImageId' => $id,\n            ]\n        );\n        echo 'deregister Image: ', $id, \"\\n\";\n    }\n\n    return $result;\n}\n\nfunction delete_snapshot($ec2client, $snapshot_ids)\n{\n    foreach ($snapshot_ids as $id)\n    {\n        $result = $ec2client->deleteSnapshot(\n            [\n                'SnapshotId' => $id,\n            ]\n        );\n        echo 'delete snapshot:  ', $id, \"\\n\";\n    }\n\n    return $result;\n}\n\necho \"---END--- Create Image \\n\";\n\n```\n\n# \u5b9f\u884c\n\n* \u30bf\u30b0DailyBackup:true\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u304c\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u3055\u308c\u308b\n* \u30bf\u30b0AutoCreated\uff1aYY-mm-dd\u3068\u3064\u3044\u3066\u3044\u3066\u3001\uff13\u65e5\u524d\u306eAMI\u3068\u5bfe\u5fdc\u3059\u308bSnapShot\u304c\u524a\u9664\u3055\u308c\u308b\u3002\n\n```\n$ php create_image.php\n---BEGIN--- Create Image 2015-04-30 16:00:11\n---sa-east-1 BIGIN--- Auto Backup\n---sa-east-1 FINISH--- Target insetances is empty. Not back up anything.\n---us-east-1 BIGIN--- Auto Backup\ninstance_id: i-e74019b7 AMI: ami-82e5eaea Snapshot_id: snap-c03c2559\ninstance_id: i-ac737157 AMI: ami-66e4eb0e Snapshot_id: snap-183e2781\n---us-east-1 FINISH--- Auto Backup\n---sa-east-1 BIGIN--- Delete AMI and SnapShot\n---sa-east-1 FINISH--- Image ids is empty. Not delete anything\n---us-east-1 BIGIN--- Delete AMI and SnapShot\n---us-east-1 FINISH--- Image ids is empty. Not delete anything\n---END--- Create Image\n```\n\n## Crontab\u3067\uff11\u65e5\u4e00\u56de \u81ea\u52d5\u5b9f\u884c\u3055\u305b\u308b\n\n```file:crontab\nSHELL=/bin/bash\n# root PATH\u3092\u8a2d\u5b9a\nPATH=/usr/local/bin:/bin:/usr/bin:/usr/local/sbin:/usr/sbin:/sbin:/opt/aws/bin:/home/ec2-user/bin:/opt/aws/bin\n# mail\u3092\u9001\u4fe1\u3057\u305f\u304f\u306a\u3044\u6642\nMAILTO=\"\"\nAWS=/home/ec2-user/aws-php\n\n# \u6642\u9593\u306fJST\u304bUST\u304b\u30b7\u30b9\u30c6\u30e0\u306b\u5408\u308f\u305b\u308b\u3002\u4eca\u56de\u306fJST\u3002 \u30ed\u30b0\u306fmessage\u306b\u5410\u304d\u51fa\u3059\u3002\n# EC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u696d\u52d9\u6642\u9593\u3060\u3051\u81ea\u52d5\u8d77\u52d5\u3059\u308b\u51e6\u7406\n27 8 * * 1-5 php $AWS/ec2_start.php  2>&1 | logger -t AWS_SDK_AUTO -p local0.info\n# EC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u6bce\u65e5\u81ea\u52d5\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u3059\u308b\u51e6\u7406\n21 8 * * * php $AWS/create_image.php  2>&1 | logger -t AWS_SDK_AUTO -p local0.info\n```\n\n## \u95a2\u9023\u3059\u308b\u30da\u30fc\u30b8\n\n[EC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u696d\u52d9\u6642\u9593\u3060\u3051\u81ea\u52d5\u8d77\u52d5\u3059\u308b\u51e6\u7406\u3092AWS SDK for PHP 2\u3067\u4f5c\u6210\u3059\u308b](http://qiita.com/shojimotio/items/0fe9e81da40524ffafc0)\n[\u81ea\u52d5\u8d77\u52d5\u51e6\u7406\u3059\u308bEC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u81ea\u8eab\u3092\u30aa\u30fc\u30c8\u30b9\u30b1\u30fc\u30eb\u30671\u6642\u9593\u3060\u3051\u8d77\u52d5\u3059\u308b](http://qiita.com/shojimotio/items/081fb7c21dee029137a0)\n"}