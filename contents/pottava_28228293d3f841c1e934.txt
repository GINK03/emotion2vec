{"tags": ["Azure", "NVIDIA", "GPU", "docker", "DeepLearning"], "context": "Docker Advent Calendar 2016 \u306e 11 \u65e5\u76ee\u3067\u3059\u3002\u6628\u65e5\u306f @nekop \u3055\u3093\u306e\u300cDockerfile\u306e\u7121\u99c4\u306a\u30ec\u30a4\u30e4\u30ea\u30f3\u30b0\u3092\u6392\u9664\u3057\u3066\u30d3\u30eb\u30c9\u3092\u9ad8\u901f\u5316\u3059\u308b\u300d\u3067\u3057\u305f\u3002\n\nGPU \u3067\u3059\u3088\n\u6700\u8fd1\u4ed5\u4e8b\u3067 GPU \u304c\u6b20\u304b\u305b\u306a\u3044\u306e\u3067\u3001\u5099\u5fd8\u3092\u517c\u306d\u3066\u3001Azure \u306e GPU \u304c\u642d\u8f09\u3055\u308c\u305f\u65b0\u3057\u3044 N \u30b7\u30ea\u30fc\u30ba \u3067 NVIDIA GPU \u3092\u4f7f\u3046 + Tips \u3092\u6b8b\u3057\u307e\u3059\u3002\n\nAzure \u3067 VM \u8d77\u52d5\n\nLinux Data Science Virtual Machine\n\u6700\u8fd1 \u6a5f\u68b0\u5b66\u7fd2\u5411\u3051\u306e\u30de\u30b7\u30f3\u30a4\u30e1\u30fc\u30b8 \u304c\u51fa\u305f\u3068\u306e\u3053\u3068\u3067\u3053\u308c\u3092\u4f7f\u304a\u3046\u3068\u3057\u305f\u306e\u3067\u3059\u304c\u3001\u6b8b\u5ff5\u3001GPU \u672a\u5bfe\u5fdc\u306e\u3088\u3046\u3067\u3059\u3002\u304c\u3063\u3064\u308a\u5b66\u7fd2\u306b\u5229\u7528\u3059\u308b\u3068\u3044\u3046\u3088\u308a\u3001\u8a66\u884c\u932f\u8aa4\u3059\u308b\u30d5\u30a7\u30fc\u30ba\u5411\u3051\u306a\u6c17\u3082\u3057\u307e\u3059\u3057\u3001\u79c1\u306e\u76ee\u8ad6\u898b\u304c\u4e0d\u7d14\u3067\u3057\u305f\u3001\u3059\u307f\u307e\u305b\u3093\u30fb\u30fb\u3002\n\n\u5236\u9650\n\u3067\u3001\u73fe\u72b6\u306f\u3001\u516c\u5f0f\u306e Set up GPU drivers for N-series VMs \u306b\u3042\u308b\u3088\u3046\u306b\nLinux \u306e GPU \u30b5\u30dd\u30fc\u30c8\u306f\u73fe\u5728\u3001Ubuntu Server 16.04 LTS \u3067\u7a3c\u50cd\u3059\u308b Azure NC \u30b7\u30ea\u30fc\u30ba\u306e\u4eee\u60f3\u30b5\u30fc\u30d0\u306e\u307f\u3067\u3059\n\u3068\u306e\u3053\u3068\u306a\u306e\u3067\u3001\u8a72\u5f53\u306e\u30b5\u30fc\u30d0\u30a4\u30e1\u30fc\u30b8\u3092\u63a2\u3057\u307e\u3059\u3002\u63a2\u3057\u305f\u3089\u3001\n\nCLI \u3067\u8d77\u52d5\nSouth Central US \u3067 N \u30b7\u30ea\u30fc\u30ba\u306e VM \u3092 1 \u53f0\u8d77\u52d5\u3057\u307e\u3059\u3002\n\u4ee5\u4e0b\u3001CLI \u306f v1 \u3092\u4f7f\u3044\u307e\u3059\u3002\n\u30de\u30b7\u30f3\u8d77\u52d5\u6642\u306e\u5927\u4e8b\u306a\u5f15\u6570\u306f\u4ee5\u4e0b\u306e\u3068\u304a\u308a\u3002\n\n\n\n\u30ad\u30fc\n\u5024\n\n\n\n\n--os-type\nLinux\n\n\n--location\nsouthcentralus\n\n\n--vm-size\nStandard_NC6\n\n\n--image-urn\nCanonical:UbuntuServer:16.04-LTS:16.04.201612050\n\n\n\n\u9375\u306f\u3042\u3089\u304b\u3058\u3081\u7528\u610f\u3057\u3064\u3064\u3001\u6b8b\u308a\u306e\u5f15\u6570\u306f\u3088\u3057\u306a\u306b\u5909\u3048\u3066\u5b9f\u884c\u3057\u307e\u3059\u3002\n\ncreate-vm\n$ azure vm create -g gpus -n demo --os-type Linux \\\n    --location southcentralus --vm-size Standard_NC6 \\\n    --image-urn Canonical:UbuntuServer:16.04-LTS:16.04.201612050 \\\n    --admin-username azure --ssh-publickey-file key.pub \\\n    --vnet-name demo-vnet --vnet-subnet-name demo-subnet \\\n    --nic-name demo-nic --public-ip-name demo-pip \\\n    --storage-account-name demogpu20161212\n\n\n\u4eee\u60f3\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u306e CIDR \u30d6\u30ed\u30c3\u30af\u3068\u30d1\u30d6\u30ea\u30c3\u30af DNS \u540d\u3092\u5bfe\u8a71\u7684\u306b\u6c7a\u3081\u3057\u3070\u3089\u304f\u3059\u308b\u3068\u3001\u30b5\u30fc\u30d0\u304c\u8d77\u52d5\u3057\u307e\u3059\u3002\n\nGPU \u8af8\u3005\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\n\n1. SSH \u30ed\u30b0\u30a4\u30f3\n\nssh\n$ ssh -i key azure@<domain-name>.southcentralus.cloudapp.azure.com\n\n\n\u30c9\u30e1\u30a4\u30f3\u540d\u306b\u306f\u3001\u5148\u307b\u3069 VM \u8d77\u52d5\u6642\u306b\u5bfe\u8a71\u7684\u306b\u6c7a\u3081\u305f\u540d\u524d\u304c\u5165\u308a\u307e\u3059\u3002\n\n2. GPU \u30c1\u30a7\u30c3\u30af\nCUDA \u304c\u4f7f\u3048\u308b GPU \u3067\u3042\u308b\u3053\u3068\u3092\u30c1\u30a7\u30c3\u30af\u3057\u3066\u307f\u307e\u3059\u3002\n\ncheck-cuda-capability\nazure@demo:~$ lspci | grep -i NVIDIA\n\na848:00:00.0 3D controller: NVIDIA Corporation GK210GL [Tesla K80] (rev a1)\n\n\n\n3. NVIDIA \u30c9\u30e9\u30a4\u30d0\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\ninstall-nvidia-driver\nsudo apt-get update\nsudo apt install -y gcc make\nwget -O /tmp/NVIDIA-Linux-x86_64-375.20.run http://us.download.nvidia.com/XFree86/Linux-x86_64/375.20/NVIDIA-Linux-x86_64-375.20.run\nchmod +x /tmp/NVIDIA-Linux-x86_64-375.20.run\nsudo sh /tmp/NVIDIA-Linux-x86_64-375.20.run\n\n\n\u30c0\u30a4\u30a2\u30ed\u30b0\u306b\u5f93\u3063\u3066\u3001\u30e9\u30a4\u30bb\u30f3\u30b9\u306b Agree \u3057\u305f\u5f8c\u306f OK \u3067\u9032\u3081\u3066\u3044\u304d\u307e\u3059\u3002\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u304c\u7d42\u308f\u3063\u305f\u3089\u3001\u30c7\u30d0\u30a4\u30b9\u306e\u72b6\u614b\u3092 nvidia-smi \u3067\u78ba\u304b\u3081\u3066\u307f\u307e\u3059\u3002\n\nquery-the-gpu-device-state\nazure@demo:~$ nvidia-smi\n\nMon Dec 12 08:36:20 2016\n+-----------------------------------------------------------------------------+\n| NVIDIA-SMI 375.20                 Driver Version: 375.20                    |\n|-------------------------------+----------------------+----------------------+\n| GPU  Name        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC |\n| Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage | GPU-Util  Compute M. |\n|===============================+======================+======================|\n|   0  Tesla K80           Off  | A848:00:00.0     Off |                    0 |\n| N/A   43C    P0    74W / 149W |      0MiB / 11471MiB |     96%      Default |\n+-------------------------------+----------------------+----------------------+\n\n+-----------------------------------------------------------------------------+\n| Processes:                                                       GPU Memory |\n|  GPU       PID  Type  Process name                               Usage      |\n|=============================================================================|\n|  No running processes found                                                 |\n+-----------------------------------------------------------------------------+\n\n\n\u898b\u3048\u307e\u3057\u305f\u306d\u3002\n\nDocker \u8af8\u3005\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\n\u30db\u30b9\u30c8\u306b\u306f\u6700\u4f4e\u9650 GPU \u30c9\u30e9\u30a4\u30d0 \u306e\u307f\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3001\u305d\u306e\u4e0a\u306e\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306f\u306a\u3093\u3067\u3082\u52d5\u304b\u3057\u3084\u3059\u3044\u3088\u3046\u3001Docker \u30d9\u30fc\u30b9\u306e\u74b0\u5883\u306b\u3057\u307e\u3059\u3002\n\n1. Docker \u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\ninstall-docker\n$ curl -sSL https://get.docker.com/ | sh\n$ sudo service docker start\n$ sudo usermod -aG docker azure\n\n\nazure \u30e6\u30fc\u30b6\u3067\u3082 sudo \u306a\u3057\u3067 docker \u30b3\u30de\u30f3\u30c9\u304c\u4f7f\u3048\u308b\u3088\u3046\u306b\u3044\u3063\u305f\u3093 SSH \u304b\u3089\u629c\u3051\u5165\u308a\u76f4\u3057\u307e\u3059\u3002\n\n2. nvidia-docker \u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\ninstall-nvidia-docker\n$ wget -P /tmp https://github.com/NVIDIA/nvidia-docker/releases/download/v1.0.0/nvidia-docker_1.0.0-1_amd64.deb\n$ sudo dpkg -i /tmp/nvidia-docker*.deb && rm /tmp/nvidia-docker*.deb\n\n\n\n3. \u8d77\u52d5\u30c1\u30a7\u30c3\u30af\n\uff08\u521d\u56de\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u6642\u306f\u5c11\u3057\u6642\u9593\u304c\u304b\u304b\u308a\u307e\u3059\u304c\uff09\n\u5148\u307b\u3069\u306e nvidia-smi \u3092 Docker \u7d4c\u7531\u3067\u5b9f\u884c\u3057\u3066\u307f\u307e\u3059\u3002\n\nnvidia-smi-with-docker\nazure@demo:~$ nvidia-docker run --rm nvidia/cuda nvidia-smi\n\nUsing default tag: latest\nlatest: Pulling from nvidia/cuda\n04cf3f0e25b6: Pull complete\n..\nDigest: sha256:e8ad1b9d0c3840ba07da8b622a0ede291c0c24d4025bda0a8f488b00d34c0eee\nStatus: Downloaded newer image for nvidia/cuda:latest\nMon Dec 12 08:50:47 2016\n+-----------------------------------------------------------------------------+\n| NVIDIA-SMI 375.20                 Driver Version: 375.20                    |\n|-------------------------------+----------------------+----------------------+\n| GPU  Name        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC |\n| Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage | GPU-Util  Compute M. |\n|===============================+======================+======================|\n|   0  Tesla K80           Off  | A848:00:00.0     Off |                    0 |\n| N/A   38C    P8    33W / 149W |    121MiB / 11471MiB |      0%      Default |\n+-------------------------------+----------------------+----------------------+\n\n+-----------------------------------------------------------------------------+\n| Processes:                                                       GPU Memory |\n|  GPU       PID  Type  Process name                               Usage      |\n|=============================================================================|\n|  No running processes found                                                 |\n+-----------------------------------------------------------------------------+\n\n\n\u3044\u3044\u3067\u3059\u306d\u3002\u30b3\u30f3\u30c6\u30ca\u306e\u4e2d\u304b\u3089\u3082\u30db\u30b9\u30c8\u306e GPU \u304c\u898b\u3048\u307e\u3057\u305f\uff01\n\nDocker \u306e\u8d77\u52d5\u30d5\u30e9\u30b0\nnvidia-docker \u3092\u4f7f\u3046\u3068\u3068\u3066\u3082\u697d\u304c\u3067\u304d\u308b\u3082\u306e\u306e\u3001\u6700\u5f8c\u306b\u3001\u305d\u308c\u304c\u306a\u304f\u3068\u3082 Docker \u304b\u3089 GPU \u3092\u4f7f\u3046\u305f\u3081\u306e\u65b9\u6cd5\u3092\u307e\u3068\u3081\u76f4\u3057\u307e\u3059\u3002\n\n--privileged\n--device\n\n\n--privileged\n\u7279\u6a29\u30e2\u30fc\u30c9\u3068\u306a\u308b\u305f\u3081\u3001\u30db\u30b9\u30c8\u306e \u3059\u3079\u3066\u306e\u30c7\u30d0\u30a4\u30b9 \u304c\u305d\u306e\u307e\u307e\u898b\u3048\u307e\u3059\u3002\n\u5fc5\u8981\u4ee5\u4e0a\u306b\u6a29\u9650\u3092\u6e21\u3059\u3053\u3068\u306b\u306a\u308b\u305f\u3081\u3001\u5f8c\u8ff0\u306e --device \u306e\u65b9\u304c\u671b\u307e\u3057\u3044\u3002\n\nprivileged\nazure@demo:~$ docker run -it --rm --privileged nvidia/cuda sh\nroot# ls -la /dev | grep nvidia\n\ncrw-rw-rw-  1 root root    245,   0 Dec 12 10:05 nvidia-uvm\ncrw-rw-rw-  1 root root    245,   1 Dec 12 10:05 nvidia-uvm-tools\ncrw-rw-rw-  1 root root    195,   0 Dec 12 10:05 nvidia0\ncrw-rw-rw-  1 root root    195, 255 Dec 12 10:05 nvidiactl\n\n\n\n--device\n\u7279\u5b9a\u306e\u30c7\u30d0\u30a4\u30b9\u306e\u307f\u306b\u30a2\u30af\u30bb\u30b9\u3092\u8a31\u53ef\u3059\u308b\u306b\u306f --device \u3092\u4f7f\u3044\u307e\u3059\u3002:rwm \u30aa\u30d7\u30b7\u30e7\u30f3\u306b\u3088\u3063\u3066\u8aad\u307f\u8fbc\u307f\u5c02\u7528\u306a\u3069\u306e\u8aad\u307f\u66f8\u304d\u5236\u5fa1\u3082\u4ed8\u4e0e\u3067\u304d\u307e\u3059\u3002\nnvidia-docker \u304c\u5185\u90e8\u7684\u306b\u4f7f\u3063\u3066\u3044\u308b\u306e\u306f\u3053\u308c\u3002\u5b9f\u969b\u306b\u3001nvidia-docker-plugin \u306b HTTP \u30ea\u30af\u30a8\u30b9\u30c8\u3067\u554f\u3044\u5408\u308f\u305b\u308c\u3070 docker \u306b\u6e21\u3057\u3066\u3044\u308b\u30aa\u30d7\u30b7\u30e7\u30f3\u3092\u78ba\u8a8d\u3059\u308b\u3053\u3068\u3082\u3067\u304d\u307e\u3059\u3002\n\nnvidia-docker-plugin\nazure@demo:~$ curl 127.0.0.1:3476/v1.0/docker/cli\n\n--volume-driver=nvidia-docker --volume=nvidia_driver_375.20:/usr/local/nvidia:ro --device=/dev/nvidiactl --device=/dev/nvidia-uvm --device=/dev/nvidia-uvm-tools --device=/dev/nvidia0\n\n\n\u3064\u307e\u308a nvidia-docker \u3067 docker \u3092\u30e9\u30c3\u30d7\u3059\u308b\u3068\u3001\u5185\u90e8\u7684\u306b\u4ee5\u4e0b\u306e\u5f15\u6570\u3092 docker run \u306b\u52a0\u3048\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308a\u307e\u3059\u3002\n\n\n\n\u30aa\u30d7\u30b7\u30e7\u30f3\n\u5024\n\n\n\n\n--volume-driver\nnvidia-docker\n\n\n--volume\nnvidia_driver_375.20:/usr/local/nvidia:ro\n\n\n--device\n/dev/nvidiactl\n\n\n--device\n/dev/nvidia-uvm\n\n\n--device\n/dev/nvidia-uvm-tools\n\n\n--device\n/dev/nvidia0\n\n\n\n--device \u30aa\u30d7\u30b7\u30e7\u30f3\u3092\u4f7f\u3063\u3066\u307f\u308b\u3068\n\ndevice\nazure@demo:~$ docker run -it --rm --device=/dev/nvidia0 nvidia/cuda sh\nroot# ls -la /dev | grep nvidia\n\ncrw-rw-rw-  1 root root 195,   0 Dec 12 10:16 nvidia0\n\n\n\u671f\u5f85\u901a\u308a\u3001\u6e21\u3057\u305f GPU \u3060\u3051\u304c\u898b\u3048\u307e\u3057\u305f\u3002\n\u304a\u308f\u308a\n[Docker Advent Calendar 2016](http://qiita.com/advent-calendar/2016/docker) \u306e 11 \u65e5\u76ee\u3067\u3059\u3002\u6628\u65e5\u306f @nekop \u3055\u3093\u306e\u300c[Dockerfile\u306e\u7121\u99c4\u306a\u30ec\u30a4\u30e4\u30ea\u30f3\u30b0\u3092\u6392\u9664\u3057\u3066\u30d3\u30eb\u30c9\u3092\u9ad8\u901f\u5316\u3059\u308b](http://nekop.hatenablog.com/entry/2016/12/09/112301)\u300d\u3067\u3057\u305f\u3002\n\n# GPU \u3067\u3059\u3088\n\n\u6700\u8fd1\u4ed5\u4e8b\u3067 GPU \u304c\u6b20\u304b\u305b\u306a\u3044\u306e\u3067\u3001\u5099\u5fd8\u3092\u517c\u306d\u3066\u3001[Azure](https://azure.microsoft.com/ja-jp/) \u306e GPU \u304c\u642d\u8f09\u3055\u308c\u305f\u65b0\u3057\u3044 [N \u30b7\u30ea\u30fc\u30ba](https://blogs.technet.microsoft.com/jpitpro/2016/11/22/azure-n-series-general-availability-on-december-1/) \u3067 NVIDIA GPU \u3092\u4f7f\u3046 + Tips \u3092\u6b8b\u3057\u307e\u3059\u3002\n\n# Azure \u3067 VM \u8d77\u52d5\n\n## Linux Data Science Virtual Machine\n\n\u6700\u8fd1 [\u6a5f\u68b0\u5b66\u7fd2\u5411\u3051\u306e\u30de\u30b7\u30f3\u30a4\u30e1\u30fc\u30b8](https://docs.microsoft.com/ja-jp/azure/machine-learning/machine-learning-data-science-linux-dsvm-intro) \u304c\u51fa\u305f\u3068\u306e\u3053\u3068\u3067\u3053\u308c\u3092\u4f7f\u304a\u3046\u3068\u3057\u305f\u306e\u3067\u3059\u304c\u3001\u6b8b\u5ff5\u3001GPU \u672a\u5bfe\u5fdc\u306e\u3088\u3046\u3067\u3059\u3002\u304c\u3063\u3064\u308a\u5b66\u7fd2\u306b\u5229\u7528\u3059\u308b\u3068\u3044\u3046\u3088\u308a\u3001\u8a66\u884c\u932f\u8aa4\u3059\u308b\u30d5\u30a7\u30fc\u30ba\u5411\u3051\u306a\u6c17\u3082\u3057\u307e\u3059\u3057\u3001\u79c1\u306e\u76ee\u8ad6\u898b\u304c\u4e0d\u7d14\u3067\u3057\u305f\u3001\u3059\u307f\u307e\u305b\u3093\u30fb\u30fb\u3002\n\n\n## \u5236\u9650\n\n\u3067\u3001\u73fe\u72b6\u306f\u3001\u516c\u5f0f\u306e [Set up GPU drivers for N-series VMs](https://github.com/Microsoft/azure-docs/blob/master/articles/virtual-machines/virtual-machines-linux-n-series-driver-setup.md) \u306b\u3042\u308b\u3088\u3046\u306b\n`Linux \u306e GPU \u30b5\u30dd\u30fc\u30c8\u306f\u73fe\u5728\u3001Ubuntu Server 16.04 LTS \u3067\u7a3c\u50cd\u3059\u308b Azure NC \u30b7\u30ea\u30fc\u30ba\u306e\u4eee\u60f3\u30b5\u30fc\u30d0\u306e\u307f\u3067\u3059`\n\u3068\u306e\u3053\u3068\u306a\u306e\u3067\u3001\u8a72\u5f53\u306e\u30b5\u30fc\u30d0\u30a4\u30e1\u30fc\u30b8\u3092\u63a2\u3057\u307e\u3059\u3002\u63a2\u3057\u305f\u3089\u3001\n\n## CLI \u3067\u8d77\u52d5\n\nSouth Central US \u3067 N \u30b7\u30ea\u30fc\u30ba\u306e VM \u3092 1 \u53f0\u8d77\u52d5\u3057\u307e\u3059\u3002\n\u4ee5\u4e0b\u3001CLI \u306f [v1](https://docs.microsoft.com/ja-jp/azure/xplat-cli-install) \u3092\u4f7f\u3044\u307e\u3059\u3002\n\n\u30de\u30b7\u30f3\u8d77\u52d5\u6642\u306e\u5927\u4e8b\u306a\u5f15\u6570\u306f\u4ee5\u4e0b\u306e\u3068\u304a\u308a\u3002\n\n| \u30ad\u30fc | \u5024 |\n|:--|:--|\n| --os-type | Linux |\n| --location | southcentralus |\n| --vm-size | Standard_NC6 |\n| --image-urn | Canonical:UbuntuServer:16.04-LTS:16.04.201612050 |\n\n\n\u9375\u306f\u3042\u3089\u304b\u3058\u3081\u7528\u610f\u3057\u3064\u3064\u3001\u6b8b\u308a\u306e\u5f15\u6570\u306f\u3088\u3057\u306a\u306b\u5909\u3048\u3066\u5b9f\u884c\u3057\u307e\u3059\u3002\n\n```sh:create-vm\n$ azure vm create -g gpus -n demo --os-type Linux \\\n    --location southcentralus --vm-size Standard_NC6 \\\n    --image-urn Canonical:UbuntuServer:16.04-LTS:16.04.201612050 \\\n    --admin-username azure --ssh-publickey-file key.pub \\\n    --vnet-name demo-vnet --vnet-subnet-name demo-subnet \\\n    --nic-name demo-nic --public-ip-name demo-pip \\\n    --storage-account-name demogpu20161212\n```\n\n\u4eee\u60f3\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u306e CIDR \u30d6\u30ed\u30c3\u30af\u3068\u30d1\u30d6\u30ea\u30c3\u30af DNS \u540d\u3092\u5bfe\u8a71\u7684\u306b\u6c7a\u3081\u3057\u3070\u3089\u304f\u3059\u308b\u3068\u3001\u30b5\u30fc\u30d0\u304c\u8d77\u52d5\u3057\u307e\u3059\u3002\n\n#  GPU \u8af8\u3005\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\n\n## 1. SSH \u30ed\u30b0\u30a4\u30f3\n\n```sh:ssh\n$ ssh -i key azure@<domain-name>.southcentralus.cloudapp.azure.com\n```\n\n\u30c9\u30e1\u30a4\u30f3\u540d\u306b\u306f\u3001\u5148\u307b\u3069 VM \u8d77\u52d5\u6642\u306b\u5bfe\u8a71\u7684\u306b\u6c7a\u3081\u305f\u540d\u524d\u304c\u5165\u308a\u307e\u3059\u3002\n\n## 2. GPU \u30c1\u30a7\u30c3\u30af\n\nCUDA \u304c\u4f7f\u3048\u308b GPU \u3067\u3042\u308b\u3053\u3068\u3092\u30c1\u30a7\u30c3\u30af\u3057\u3066\u307f\u307e\u3059\u3002\n\n```sh:check-cuda-capability\nazure@demo:~$ lspci | grep -i NVIDIA\n\na848:00:00.0 3D controller: NVIDIA Corporation GK210GL [Tesla K80] (rev a1)\n```\n\n## 3. NVIDIA \u30c9\u30e9\u30a4\u30d0\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n```sh:install-nvidia-driver\nsudo apt-get update\nsudo apt install -y gcc make\nwget -O /tmp/NVIDIA-Linux-x86_64-375.20.run http://us.download.nvidia.com/XFree86/Linux-x86_64/375.20/NVIDIA-Linux-x86_64-375.20.run\nchmod +x /tmp/NVIDIA-Linux-x86_64-375.20.run\nsudo sh /tmp/NVIDIA-Linux-x86_64-375.20.run\n```\n\n\u30c0\u30a4\u30a2\u30ed\u30b0\u306b\u5f93\u3063\u3066\u3001\u30e9\u30a4\u30bb\u30f3\u30b9\u306b `Agree` \u3057\u305f\u5f8c\u306f OK \u3067\u9032\u3081\u3066\u3044\u304d\u307e\u3059\u3002\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u304c\u7d42\u308f\u3063\u305f\u3089\u3001\u30c7\u30d0\u30a4\u30b9\u306e\u72b6\u614b\u3092 `nvidia-smi` \u3067\u78ba\u304b\u3081\u3066\u307f\u307e\u3059\u3002\n\n```sh:query-the-gpu-device-state\nazure@demo:~$ nvidia-smi\n\nMon Dec 12 08:36:20 2016\n+-----------------------------------------------------------------------------+\n| NVIDIA-SMI 375.20                 Driver Version: 375.20                    |\n|-------------------------------+----------------------+----------------------+\n| GPU  Name        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC |\n| Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage | GPU-Util  Compute M. |\n|===============================+======================+======================|\n|   0  Tesla K80           Off  | A848:00:00.0     Off |                    0 |\n| N/A   43C    P0    74W / 149W |      0MiB / 11471MiB |     96%      Default |\n+-------------------------------+----------------------+----------------------+\n\n+-----------------------------------------------------------------------------+\n| Processes:                                                       GPU Memory |\n|  GPU       PID  Type  Process name                               Usage      |\n|=============================================================================|\n|  No running processes found                                                 |\n+-----------------------------------------------------------------------------+\n```\n\n\u898b\u3048\u307e\u3057\u305f\u306d\u3002\n\n# Docker \u8af8\u3005\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\n\n\u30db\u30b9\u30c8\u306b\u306f\u6700\u4f4e\u9650 `GPU \u30c9\u30e9\u30a4\u30d0` \u306e\u307f\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3001\u305d\u306e\u4e0a\u306e\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306f\u306a\u3093\u3067\u3082\u52d5\u304b\u3057\u3084\u3059\u3044\u3088\u3046\u3001Docker \u30d9\u30fc\u30b9\u306e\u74b0\u5883\u306b\u3057\u307e\u3059\u3002\n\n## 1. Docker \u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n```sh:install-docker\n$ curl -sSL https://get.docker.com/ | sh\n$ sudo service docker start\n$ sudo usermod -aG docker azure\n```\n\nazure \u30e6\u30fc\u30b6\u3067\u3082 sudo \u306a\u3057\u3067 docker \u30b3\u30de\u30f3\u30c9\u304c\u4f7f\u3048\u308b\u3088\u3046\u306b\u3044\u3063\u305f\u3093 SSH \u304b\u3089\u629c\u3051\u5165\u308a\u76f4\u3057\u307e\u3059\u3002\n\n## 2. nvidia-docker \u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n```sh:install-nvidia-docker\n$ wget -P /tmp https://github.com/NVIDIA/nvidia-docker/releases/download/v1.0.0/nvidia-docker_1.0.0-1_amd64.deb\n$ sudo dpkg -i /tmp/nvidia-docker*.deb && rm /tmp/nvidia-docker*.deb\n```\n\n## 3. \u8d77\u52d5\u30c1\u30a7\u30c3\u30af\n\n\uff08\u521d\u56de\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u6642\u306f\u5c11\u3057\u6642\u9593\u304c\u304b\u304b\u308a\u307e\u3059\u304c\uff09\n\u5148\u307b\u3069\u306e `nvidia-smi` \u3092 Docker \u7d4c\u7531\u3067\u5b9f\u884c\u3057\u3066\u307f\u307e\u3059\u3002\n\n```sh:nvidia-smi-with-docker\nazure@demo:~$ nvidia-docker run --rm nvidia/cuda nvidia-smi\n\nUsing default tag: latest\nlatest: Pulling from nvidia/cuda\n04cf3f0e25b6: Pull complete\n..\nDigest: sha256:e8ad1b9d0c3840ba07da8b622a0ede291c0c24d4025bda0a8f488b00d34c0eee\nStatus: Downloaded newer image for nvidia/cuda:latest\nMon Dec 12 08:50:47 2016\n+-----------------------------------------------------------------------------+\n| NVIDIA-SMI 375.20                 Driver Version: 375.20                    |\n|-------------------------------+----------------------+----------------------+\n| GPU  Name        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC |\n| Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage | GPU-Util  Compute M. |\n|===============================+======================+======================|\n|   0  Tesla K80           Off  | A848:00:00.0     Off |                    0 |\n| N/A   38C    P8    33W / 149W |    121MiB / 11471MiB |      0%      Default |\n+-------------------------------+----------------------+----------------------+\n\n+-----------------------------------------------------------------------------+\n| Processes:                                                       GPU Memory |\n|  GPU       PID  Type  Process name                               Usage      |\n|=============================================================================|\n|  No running processes found                                                 |\n+-----------------------------------------------------------------------------+\n```\n\n\u3044\u3044\u3067\u3059\u306d\u3002\u30b3\u30f3\u30c6\u30ca\u306e\u4e2d\u304b\u3089\u3082\u30db\u30b9\u30c8\u306e GPU \u304c\u898b\u3048\u307e\u3057\u305f\uff01\n\n\n# Docker \u306e\u8d77\u52d5\u30d5\u30e9\u30b0\n\nnvidia-docker \u3092\u4f7f\u3046\u3068\u3068\u3066\u3082\u697d\u304c\u3067\u304d\u308b\u3082\u306e\u306e\u3001\u6700\u5f8c\u306b\u3001\u305d\u308c\u304c\u306a\u304f\u3068\u3082 Docker \u304b\u3089 GPU \u3092\u4f7f\u3046\u305f\u3081\u306e\u65b9\u6cd5\u3092\u307e\u3068\u3081\u76f4\u3057\u307e\u3059\u3002\n\n* --privileged\n* --device\n\n## --privileged\n\n\u7279\u6a29\u30e2\u30fc\u30c9\u3068\u306a\u308b\u305f\u3081\u3001\u30db\u30b9\u30c8\u306e **\u3059\u3079\u3066\u306e\u30c7\u30d0\u30a4\u30b9** \u304c\u305d\u306e\u307e\u307e\u898b\u3048\u307e\u3059\u3002\n\u5fc5\u8981\u4ee5\u4e0a\u306b\u6a29\u9650\u3092\u6e21\u3059\u3053\u3068\u306b\u306a\u308b\u305f\u3081\u3001\u5f8c\u8ff0\u306e `--device` \u306e\u65b9\u304c\u671b\u307e\u3057\u3044\u3002\n\n```sh:privileged\nazure@demo:~$ docker run -it --rm --privileged nvidia/cuda sh\nroot# ls -la /dev | grep nvidia\n\ncrw-rw-rw-  1 root root    245,   0 Dec 12 10:05 nvidia-uvm\ncrw-rw-rw-  1 root root    245,   1 Dec 12 10:05 nvidia-uvm-tools\ncrw-rw-rw-  1 root root    195,   0 Dec 12 10:05 nvidia0\ncrw-rw-rw-  1 root root    195, 255 Dec 12 10:05 nvidiactl\n```\n\n## --device\n\n\u7279\u5b9a\u306e\u30c7\u30d0\u30a4\u30b9\u306e\u307f\u306b\u30a2\u30af\u30bb\u30b9\u3092\u8a31\u53ef\u3059\u308b\u306b\u306f `--device` \u3092\u4f7f\u3044\u307e\u3059\u3002`:rwm` \u30aa\u30d7\u30b7\u30e7\u30f3\u306b\u3088\u3063\u3066\u8aad\u307f\u8fbc\u307f\u5c02\u7528\u306a\u3069\u306e\u8aad\u307f\u66f8\u304d\u5236\u5fa1\u3082\u4ed8\u4e0e\u3067\u304d\u307e\u3059\u3002\n\nnvidia-docker \u304c\u5185\u90e8\u7684\u306b\u4f7f\u3063\u3066\u3044\u308b\u306e\u306f\u3053\u308c\u3002\u5b9f\u969b\u306b\u3001nvidia-docker-plugin \u306b HTTP \u30ea\u30af\u30a8\u30b9\u30c8\u3067\u554f\u3044\u5408\u308f\u305b\u308c\u3070 docker \u306b\u6e21\u3057\u3066\u3044\u308b\u30aa\u30d7\u30b7\u30e7\u30f3\u3092\u78ba\u8a8d\u3059\u308b\u3053\u3068\u3082\u3067\u304d\u307e\u3059\u3002\n\n```sh:nvidia-docker-plugin\nazure@demo:~$ curl 127.0.0.1:3476/v1.0/docker/cli\n\n--volume-driver=nvidia-docker --volume=nvidia_driver_375.20:/usr/local/nvidia:ro --device=/dev/nvidiactl --device=/dev/nvidia-uvm --device=/dev/nvidia-uvm-tools --device=/dev/nvidia0\n```\n\n\u3064\u307e\u308a nvidia-docker \u3067 docker \u3092\u30e9\u30c3\u30d7\u3059\u308b\u3068\u3001\u5185\u90e8\u7684\u306b\u4ee5\u4e0b\u306e\u5f15\u6570\u3092 `docker run` \u306b\u52a0\u3048\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308a\u307e\u3059\u3002\n\n|\u30aa\u30d7\u30b7\u30e7\u30f3 | \u5024 |\n|:--|:--|\n| --volume-driver | nvidia-docker |\n| --volume | nvidia_driver_375.20:/usr/local/nvidia:ro |\n| --device | /dev/nvidiactl |\n| --device | /dev/nvidia-uvm |\n| --device | /dev/nvidia-uvm-tools |\n| --device | /dev/nvidia0 |\n\n--device \u30aa\u30d7\u30b7\u30e7\u30f3\u3092\u4f7f\u3063\u3066\u307f\u308b\u3068\n\n```sh:device\nazure@demo:~$ docker run -it --rm --device=/dev/nvidia0 nvidia/cuda sh\nroot# ls -la /dev | grep nvidia\n\ncrw-rw-rw-  1 root root 195,   0 Dec 12 10:16 nvidia0\n```\n\n\u671f\u5f85\u901a\u308a\u3001\u6e21\u3057\u305f GPU \u3060\u3051\u304c\u898b\u3048\u307e\u3057\u305f\u3002\n\n\u304a\u308f\u308a\n"}