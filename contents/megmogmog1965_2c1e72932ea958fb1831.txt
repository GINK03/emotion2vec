{"context": " More than 1 year has passed since last update.\u8a66\u3057\u305f\u3053\u3068\u30e1\u30e2.\n\n\u6982\u8981\ndocker-consul \u3092\u4f7f\u3063\u3066DNS\u30b5\u30fc\u30d0\u30fc\u3068\u3057\u3066\u3001\u4ed6Docker\u30b3\u30f3\u30c6\u30ca\u304b\u3089\u53c2\u7167\u3057\u305f\u3044.\n\nsudo\u3068\u304b\u7701\u7565\u3057\u3066\u307e\u3059.\n\n\n\u624b\u9806\ndocker-consul \u3092Pull\u3057\u3066\n$ docker pull progrium/consul\n\nRun\u3059\u308b\n$ docker run -d -p 8400:8400 -p 8500:8500 -p 8600:53/udp -h node1 --name consul progrium/consul -server -bootstrap -ui-dir /ui\n\nIP\u3092\u53d6\u3063\u3066\u304a\u304f.\n$ DNS_IP=\"$(docker inspect -f '{{.NetworkSettings.IPAddress}}' consul)\"\n\nConsul\u306b\u4f55\u304b\u9069\u5f53\u306aService\u3092\u767b\u9332\u3057\u3066\u307f\u308b. \u4ee5\u4e0b\u306e\u5185\u5bb9\u3067 entity.json \u30d5\u30a1\u30a4\u30eb\u3092\u7528\u610f\u3059\u308b.\n\nConsul - /v1/catalog/register \u304b\u3089\u6301\u3063\u3066\u304d\u305f.\n\n\nentity.json\n{\n  \"Datacenter\": \"dc1\",\n  \"Node\": \"foobar\",\n  \"Address\": \"192.168.10.10\",\n  \"Service\": {\n    \"ID\": \"redis1\",\n    \"Service\": \"redis\",\n    \"Tags\": [\n      \"master\",\n      \"v1\"\n    ],\n    \"Port\": 8000\n  },\n  \"Check\": {\n    \"Node\": \"foobar\",\n    \"CheckID\": \"service:redis1\",\n    \"Name\": \"Redis health check\",\n    \"Notes\": \"Script based health check\",\n    \"Status\": \"passing\",\n    \"ServiceID\": \"redis1\"\n  }\n}\n\n\nHTTP PUT \u3067\u767b\u9332\u3059\u308b.\n$ curl -v -H \"Content-Type: application/json\" -X PUT -d @entity.json http://${DNS_IP}:8500/v1/catalog/register\n\nConsul-container\u3092DNS\u306b\u6307\u5b9a\u3057\u3066\u3001Docker\u306b\u5165\u3063\u3066\u307f\u308b.\n$ docker run -it --name consul_dns_test --dns ${DNS_IP} centos /bin/bash\n\nping\u3057\u3066\u307f\u308b. \u3061\u3083\u3093\u3068 redis \u3092Host\u540d\u3068\u3057\u3066\u8a8d\u8b58\u3057\u3066\u3044\u308b\u306e\u304c\u5206\u304b\u308b.\n$ ping redis\nPING redis.service.consul (192.168.10.10) 56(84) bytes of data.\n...\n\n\n\u53c2\u8003\u306b\u3057\u305f\u30b5\u30a4\u30c8\n\ndocker-consul\nConsul - /v1/catalog/register\n\n\n\u8a66\u3057\u305f\u3053\u3068\u30e1\u30e2.\n\n# \u6982\u8981\n\n[docker-consul] \u3092\u4f7f\u3063\u3066DNS\u30b5\u30fc\u30d0\u30fc\u3068\u3057\u3066\u3001\u4ed6Docker\u30b3\u30f3\u30c6\u30ca\u304b\u3089\u53c2\u7167\u3057\u305f\u3044.\n\n> sudo\u3068\u304b\u7701\u7565\u3057\u3066\u307e\u3059.\n\n# \u624b\u9806\n\n[docker-consul] \u3092Pull\u3057\u3066\n\n```\n$ docker pull progrium/consul\n```\n\nRun\u3059\u308b\n\n```\n$ docker run -d -p 8400:8400 -p 8500:8500 -p 8600:53/udp -h node1 --name consul progrium/consul -server -bootstrap -ui-dir /ui\n```\n\nIP\u3092\u53d6\u3063\u3066\u304a\u304f.\n\n```\n$ DNS_IP=\"$(docker inspect -f '{{.NetworkSettings.IPAddress}}' consul)\"\n```\n\nConsul\u306b\u4f55\u304b\u9069\u5f53\u306aService\u3092\u767b\u9332\u3057\u3066\u307f\u308b. \u4ee5\u4e0b\u306e\u5185\u5bb9\u3067 ```entity.json``` \u30d5\u30a1\u30a4\u30eb\u3092\u7528\u610f\u3059\u308b.\n\n> [Consul - /v1/catalog/register] \u304b\u3089\u6301\u3063\u3066\u304d\u305f.\n\n```json:entity.json\n{\n  \"Datacenter\": \"dc1\",\n  \"Node\": \"foobar\",\n  \"Address\": \"192.168.10.10\",\n  \"Service\": {\n    \"ID\": \"redis1\",\n    \"Service\": \"redis\",\n    \"Tags\": [\n      \"master\",\n      \"v1\"\n    ],\n    \"Port\": 8000\n  },\n  \"Check\": {\n    \"Node\": \"foobar\",\n    \"CheckID\": \"service:redis1\",\n    \"Name\": \"Redis health check\",\n    \"Notes\": \"Script based health check\",\n    \"Status\": \"passing\",\n    \"ServiceID\": \"redis1\"\n  }\n}\n```\n\nHTTP PUT \u3067\u767b\u9332\u3059\u308b.\n\n```\n$ curl -v -H \"Content-Type: application/json\" -X PUT -d @entity.json http://${DNS_IP}:8500/v1/catalog/register\n```\n\nConsul-container\u3092DNS\u306b\u6307\u5b9a\u3057\u3066\u3001Docker\u306b\u5165\u3063\u3066\u307f\u308b.\n\n```\n$ docker run -it --name consul_dns_test --dns ${DNS_IP} centos /bin/bash\n```\n\nping\u3057\u3066\u307f\u308b. \u3061\u3083\u3093\u3068 ```redis``` \u3092Host\u540d\u3068\u3057\u3066\u8a8d\u8b58\u3057\u3066\u3044\u308b\u306e\u304c\u5206\u304b\u308b.\n\n```\n$ ping redis\nPING redis.service.consul (192.168.10.10) 56(84) bytes of data.\n...\n```\n\n# \u53c2\u8003\u306b\u3057\u305f\u30b5\u30a4\u30c8\n\n* [docker-consul]\n* [Consul - /v1/catalog/register]\n\n\n[docker-consul]:https://github.com/progrium/docker-consul\n[Consul - /v1/catalog/register]:http://www.consul.io/docs/agent/http.html#_v1_catalog_register\n", "tags": ["consul", "docker"]}