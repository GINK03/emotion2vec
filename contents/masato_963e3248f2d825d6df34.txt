{"context": " More than 1 year has passed since last update.\u30b3\u30cd\u30af\u30c6\u30c3\u30c9\u30c7\u30d0\u30a4\u30b9\u5411\u3051\u306eMQTT\u30d6\u30ed\u30fc\u30ab\u30fc\u306bMosca\u3092\u4f7f\u3063\u3066\u3044\u307e\u3057\u305f\u304c\u3001\u30d6\u30ed\u30fc\u30ab\u30fc\u306bMQTT\u4ee5\u5916\u306e\u30d7\u30ed\u30c8\u30b3\u30eb\u3082\u4f7f\u3048\u308b\u3068\u4fbf\u5229\u3067\u3059\u3002\u30de\u30eb\u30c1\u30d7\u30ed\u30c8\u30b3\u30eb\u3092\u30b5\u30dd\u30fc\u30c8\u3057\u3066\u3044\u3066MQTT\u306b\u306fMosca\u3092\u4f7f\u3063\u3066\u3044\u308bPonte\u3068\u3044\u3046\u30d6\u30ed\u30fc\u30ab\u30fc\u304c\u3042\u308b\u306e\u3067\u3053\u3061\u3089\u3092\u8a66\u3057\u3066\u307f\u307e\u3059\u3002Ponte\u306fEclipse Foundation\u306eIoT Working Group\u3001iot.eclipse.org\u914d\u4e0b\u306e\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u3067\u3059\u3002\u30d7\u30ed\u30c8\u30b3\u30eb\u306bHTTP\u3001MQTT\u3001CoAP\u306e3\u3064\u3092\u30b5\u30dd\u30fc\u30c8\u3057\u3066\u3044\u308b\u306e\u304c\u7279\u5fb4\u3067\u3059\u3002HTTP\u3067publish\u3057\u3066MQTT\u3067subscribe\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\nPonte\u306eSSL/TLS\u30b5\u30dd\u30fc\u30c8\nSSL/TLS\u306e\u30b5\u30dd\u30fc\u30c8\u306f\u76f4\u63a5\u3055\u308c\u3066\u3044\u307e\u305b\u3093\u304c\u3001MQTT\u306fMosca\u306econfig\u3067\u30d7\u30ed\u30c8\u30b3\u30eb\u3092\u6307\u5b9a\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002HTTP\u306f\u5225\u9014Nginx\u3067SSL Termination\u3092\u3059\u308b\u4e88\u5b9a\u3067\u3059\u3002\u4eca\u56de\u306fMQTT over SSL/TLS\u306e\u8a2d\u5b9a\u3092\u884c\u3044\u307e\u3059\u3002\n\nBroker\u30b3\u30f3\u30c6\u30ca\nBroker\u30b3\u30f3\u30c6\u30ca\u306eDocker\u30a4\u30e1\u30fc\u30b8\u7528\u306e\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n$ mkdir -p ~/docker_apps/ponte\n$ cd !$\n\n\nDockerfile\nTLS\u3067\u4f7f\u3046\u8a3c\u660e\u66f8\u306f\u3068\u308a\u3042\u3048\u305a\u6697\u53f7\u5316\u3067\u304d\u308c\u3070\u826f\u3044\u306e\u3067\u3001\u30aa\u30ec\u30aa\u30ec\u8a3c\u660e\u66f8\u3092\u4f5c\u308a\u307e\u3059\u3002\u307e\u305fDocker\u30d9\u30fc\u30b9\u30a4\u30e1\u30fc\u30b8\u306fgoogle/nodejs\u3092\u4f7f\u3044\u307e\u3059\u3002\n\n~/docker_apps/ponte/Dockerfile\nFROM google/nodejs\n\nRUN apt-get update && apt-get install -y libzmq-dev\n\nWORKDIR /app\nONBUILD ADD package.json /app/\nONBUILD RUN npm install\nONBUILD ADD . /app\n\nRUN npm install --unsafe-perm -g ponte bunyan\nRUN mkdir -p /opt/nginx/certs \\\n && cd /opt/nginx/certs \\\n && openssl genrsa  -out server.key 4096 \\\n && openssl req -new -batch -key server.key -out server.csr \\\n && openssl x509 -req -days 3650 -in server.csr -signkey server.key -out server.crt\n\nADD config.js /app/\nENTRYPOINT [\"ponte\", \"-c\",\"/app/config.js\",\"-v\", \"| bunyan\"]\nEXPOSE 8443 3000 5683\nRUN apt-get clean && rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*\n\n\n\nnpm\u306e\u30b0\u30ed\u30fc\u30d0\u30eb\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\u901a\u5e38Node.js\u306e\u30d1\u30c3\u30b1\u30fc\u30b8\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u306fpackage.json\u306b\u6307\u5b9a\u3057\u3066npm install\u3057\u307e\u3059\u304c\u3001\u30b0\u30ed\u30fc\u30d0\u30eb\u306b\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3088\u3046\u3068\u3059\u308b\u3068\u3044\u308d\u3044\u308d\u3068\u554f\u984c\u304c\u3042\u308a\u307e\u3059\u3002\u305d\u306e\u305f\u3081package.json\u306b\u306f\u6307\u5b9a\u305b\u305aDockerfile\u306b\u8a18\u8ff0\u3057\u307e\u3059\u3002\n\n~/docker_apps/ponte/package.json\n{\n  \"name\": \"ponte\",\n  \"description\": \"ponte test app\",\n  \"version\": \"0.0.1\",\n  \"private\": true\n}\n\n\n\u307e\u305fgyp WARN EACCES user \"undefined\" does not have permission\u306e\u8b66\u544a\u304c\u3067\u3066\u3057\u307e\u3046\u305f\u3081\u3001--unsafe-perm\u30d5\u30e9\u30b0\u3092\u4ed8\u3051\u307e\u3059\u3002\nRUN npm install --unsafe-perm -g ponte bunyan\n\n\nPonte\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\nPonte\u8d77\u52d5\u6642\u306bJS\u30d5\u30a1\u30a4\u30eb\u3067\u5404\u30d7\u30ed\u30c8\u30b3\u30eb\u306e\u8a2d\u5b9a\u3092\u6e21\u3059\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002MQTT\u306b\u306f\u30aa\u30ec\u30aa\u30ec\u8a3c\u660e\u66f8\u3068\u79d8\u5bc6\u9375\u306e\u30d1\u30b9\u3092\u6307\u5b9a\u3057\u307e\u3059\u3002\n\n~/docker_apps/ponte/config.js\nmodule.exports = {\n  logger: {\n    level: \"info\",\n  },\n  persistence: {\n    type: 'level',\n    path: './db'\n  },\n  mqtt: {\n    secure : {\n      port: 8443,\n      keyPath:\"/opt/nginx/certs/server.key\",\n      certPath:\"/opt/nginx/certs/server.crt\"\n    }\n  }\n}\n\n\n\nPonte\u306e\u8d77\u52d5\nDocker\u30a4\u30e1\u30fc\u30b8\u306e\u30d3\u30eb\u30c9\u3068\u30b3\u30f3\u30c6\u30ca\u306e\u8d77\u52d5\u3092\u3057\u307e\u3059\u3002MQTT\u4ee5\u5916\u306b\u3082HTTP\u3068CoAP\u306e\u30dd\u30fc\u30c8\u3082Docker\u30db\u30b9\u30c8\u306b\u30de\u30c3\u30d7\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n$ docker pull google/nodejs\n$ docker build -t ponte .\n$ docker run -d  --name ponte  \\\n  -p 8443:8443  \\\n  -p 3000:3000  \\\n  -p 5683:5683  \\\n  -it  ponte\n\n\u30ed\u30b0\u3092\u898b\u308b\u30683\u3064\u306e\u30d7\u30ed\u30c8\u30b3\u30eb\u3067\u8d77\u52d5\u3057\u305f\u3053\u3068\u304c\u308f\u304b\u308a\u307e\u3059\u3002\n$ docker logs -f ponte\n{\"name\":\"ponte\",\"hostname\":\"17e232fd73f8\",\"pid\":1,\"service\":\"MQTT\",\"level\":30,\"mqtts\":8443,\"msg\":\"server started\",\"time\":\"2015-03-08T04:57:26.910Z\",\"v\":0}\n{\"name\":\"ponte\",\"hostname\":\"17e232fd73f8\",\"pid\":1,\"service\":\"HTTP\",\"level\":30,\"port\":3000,\"msg\":\"server started\",\"time\":\"2015-03-08T04:57:26.918Z\",\"v\":0}\n{\"name\":\"ponte\",\"hostname\":\"17e232fd73f8\",\"pid\":1,\"service\":\"CoAP\",\"level\":30,\"port\":5683,\"msg\":\"server started\",\"time\":\"2015-03-08T04:57:26.919Z\",\"v\":0}\n\n\nPub/Sub\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u306e\u30b3\u30f3\u30c6\u30ca\nPub/Sub\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u306eDocker\u30a4\u30e1\u30fc\u30b8\u3092\u4f5c\u6210\u3059\u308b\u305f\u3081\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n$ mkdir -p ~/docker_apps/ponte-pubsub\n$ cd !$\n\n\nDockerfile\nNode.js\u306e\u30d1\u30c3\u30b1\u30fc\u30b8\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u305f\u3081package.json\u3092\u7528\u610f\u3057\u307e\u3059\u3002\u65e5\u4ed8\u51e6\u7406\u306b\u4fbf\u5229\u306aMoment.js\u3082\u8ffd\u52a0\u3057\u307e\u3057\u305f\u3002\n\n~/docker_apps/ponte-pubsub/package.json\n{\n  \"name\": \"ponte-pubsub\",\n  \"description\": \"ponte-pubsub test app\",\n  \"version\": \"0.0.1\",\n  \"private\": true,\n  \"dependencies\": {\n    \"mqtt\": \"1.1.0\",\n    \"moment\": \"2.9.0\",\n    \"moment-timezone\": \"0.3.0\"\n  },\n  \"scripts\": {\"start\": \"node app.js\"}\n}\n\n\nNode.js\u306e\u30e1\u30a4\u30f3\u30d7\u30ed\u30b0\u30e9\u30e0\u3067\u3059\u30023\u79d2\u9593\u9694\u3067Publish\u3092\u3057\u3066\u540c\u3058MQTT\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u3092\u4f7f\u3063\u3066Subscribe\u3057\u307e\u3059\u3002\n\n~/docker_apps/ponte-pubsub/app.js\nvar mqtt = require('mqtt'),\n    moment = require('moment-timezone');\n\nvar options = {\n  protocol: \"mqtts\",\n  port: process.env.MQTT_PORT,\n  host: process.env.MQTT_HOST,\n  username: process.env.MQTT_USERNAME,\n  password: process.env.MQTT_PASSWORD,\n  clientId: \"secure-\".concat(Math.floor(65535 * Math.random())),\n  rejectUnauthorized : false\n};\n\nvar client = mqtt.connect(options);\n\nclient.on('connect', function() {\n  console.log('client connected');\n});\n\nclient.subscribe('hello');\nclient.on('message',function(topic, data) {\n  console.log(\"Message on \" + topic + \": \" + data);\n});\n\nsetInterval(function() {\n  var now = moment().tz(\"Asia/Tokyo\").format(\"YYYY-MM-DD HH:mm:ssZ\");\n  client.publish('hello', now);\n  console.log('Message Published');\n}, 3000);\n\n\n\n\u30b3\u30f3\u30c6\u30ca\u3092\u4f7f\u3063\u3066Pub/Sub\u306e\u30c6\u30b9\u30c8\nDockerfile\u3092\u4f5c\u6210\u3057\u3066\u30a4\u30e1\u30fc\u30b8\u3092\u30d3\u30eb\u30c9\u3057\u307e\u3059\u3002\n$ echo FROM google/nodejs-runtime > Dockerfile\n$ docker pull google/nodejs-runtime\n$ docker build -t ponte-pubsub .\n\n\u4f7f\u3044\u6368\u3066\u306e\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3057\u3066Pub/Sub\u306e\u30c6\u30b9\u30c8\u3092\u3057\u307e\u3059\u3002\u3067MQTT\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u306e\u8a2d\u5b9a\u3092\u74b0\u5883\u5909\u6570\u306b\u6e21\u3057\u307e\u3059\u3002\n$ docker run --rm --name ponte-pubsub \\\n  -e MQTT_HOST=10.3.0.230  \\\n  -e MQTT_PORT=8443 \\\n  -e MQTT_USERNAME=admin \\\n  -e MQTT_PASSWORD=password \\\n  ponte-pubsub\n\n> ponte-pubsub@0.0.1 start /app\n> node app.js\n\nsecure-46408\nclient connected\nMessage Published\nMessage on hello: 2015-03-08 13:47:58+09:00\n\nPonte\u30b3\u30f3\u30c6\u30ca\u306e\u30ed\u30b0\u306b\u3082hello\u30c8\u30d4\u30c3\u30af\u306esubscribe\u306e\u69d8\u5b50\u304c\u51fa\u529b\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n$ docker logs -f ponte\n...\n{\"name\":\"ponte\",\"hostname\":\"17e232fd73f8\",\"pid\":1,\"service\":\"MQTT\",\"client\":\"secure-58538\",\"level\":30,\"msg\":\"client connected\",\"time\":\"2015-03-08T08:23:29.734Z\",\"v\":0}\n{\"name\":\"ponte\",\"hostname\":\"17e232fd73f8\",\"pid\":1,\"service\":\"MQTT\",\"client\":\"secure-58538\",\"level\":30,\"topic\":\"hello\",\"qos\":0,\"msg\":\"subscribed to topic\",\"time\":\"2015-03-08T08:23:29.742Z\",\"v\":0}\n{\"name\":\"ponte\",\"hostname\":\"17e232fd73f8\",\"pid\":1,\"service\":\"MQTT\",\"client\":\"secure-58538\",\"level\":30,\"topic\":\"hello\",\"msg\":\"unsubscribed\",\"time\":\"2015-03-08T08:23:36.788Z\",\"v\":0}\n{\"name\":\"ponte\",\"hostname\":\"17e232fd73f8\",\"pid\":1,\"service\":\"MQTT\",\"client\":\"secure-58538\",\"level\":30,\"msg\":\"closed\",\"time\":\"2015-03-08T08:23:36.793Z\",\"v\":0}\n\n\u30b3\u30cd\u30af\u30c6\u30c3\u30c9\u30c7\u30d0\u30a4\u30b9\u5411\u3051\u306eMQTT\u30d6\u30ed\u30fc\u30ab\u30fc\u306b[Mosca](https://github.com/mcollina/mosca)\u3092\u4f7f\u3063\u3066\u3044\u307e\u3057\u305f\u304c\u3001\u30d6\u30ed\u30fc\u30ab\u30fc\u306bMQTT\u4ee5\u5916\u306e\u30d7\u30ed\u30c8\u30b3\u30eb\u3082\u4f7f\u3048\u308b\u3068\u4fbf\u5229\u3067\u3059\u3002\u30de\u30eb\u30c1\u30d7\u30ed\u30c8\u30b3\u30eb\u3092\u30b5\u30dd\u30fc\u30c8\u3057\u3066\u3044\u3066MQTT\u306b\u306fMosca\u3092\u4f7f\u3063\u3066\u3044\u308bPonte\u3068\u3044\u3046\u30d6\u30ed\u30fc\u30ab\u30fc\u304c\u3042\u308b\u306e\u3067\u3053\u3061\u3089\u3092\u8a66\u3057\u3066\u307f\u307e\u3059\u3002[Ponte](http://eclipse.org/ponte/)\u306f[Eclipse Foundation](http://www.eclipse.org/)\u306eIoT Working Group\u3001[iot.eclipse.org](http://iot.eclipse.org/)\u914d\u4e0b\u306e\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u3067\u3059\u3002\u30d7\u30ed\u30c8\u30b3\u30eb\u306bHTTP\u3001MQTT\u3001[CoAP](http://en.wikipedia.org/wiki/Constrained_Application_Protocol)\u306e3\u3064\u3092\u30b5\u30dd\u30fc\u30c8\u3057\u3066\u3044\u308b\u306e\u304c\u7279\u5fb4\u3067\u3059\u3002HTTP\u3067publish\u3057\u3066MQTT\u3067subscribe\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\n## Ponte\u306eSSL/TLS\u30b5\u30dd\u30fc\u30c8\n\nSSL/TLS\u306e\u30b5\u30dd\u30fc\u30c8\u306f\u76f4\u63a5\u3055\u308c\u3066\u3044\u307e\u305b\u3093\u304c\u3001MQTT\u306fMosca\u306econfig\u3067\u30d7\u30ed\u30c8\u30b3\u30eb\u3092\u6307\u5b9a\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002HTTP\u306f\u5225\u9014Nginx\u3067SSL Termination\u3092\u3059\u308b\u4e88\u5b9a\u3067\u3059\u3002\u4eca\u56de\u306fMQTT over SSL/TLS\u306e\u8a2d\u5b9a\u3092\u884c\u3044\u307e\u3059\u3002\n\n## Broker\u30b3\u30f3\u30c6\u30ca\n\nBroker\u30b3\u30f3\u30c6\u30ca\u306eDocker\u30a4\u30e1\u30fc\u30b8\u7528\u306e\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n``` bash\n$ mkdir -p ~/docker_apps/ponte\n$ cd !$\n```\n\n### Dockerfile\n\nTLS\u3067\u4f7f\u3046\u8a3c\u660e\u66f8\u306f\u3068\u308a\u3042\u3048\u305a\u6697\u53f7\u5316\u3067\u304d\u308c\u3070\u826f\u3044\u306e\u3067\u3001\u30aa\u30ec\u30aa\u30ec\u8a3c\u660e\u66f8\u3092\u4f5c\u308a\u307e\u3059\u3002\u307e\u305fDocker\u30d9\u30fc\u30b9\u30a4\u30e1\u30fc\u30b8\u306f[google/nodejs](https://registry.hub.docker.com/u/google/nodejs/)\u3092\u4f7f\u3044\u307e\u3059\u3002\n\n``` bash:~/docker_apps/ponte/Dockerfile\nFROM google/nodejs\n\nRUN apt-get update && apt-get install -y libzmq-dev\n\nWORKDIR /app\nONBUILD ADD package.json /app/\nONBUILD RUN npm install\nONBUILD ADD . /app\n\nRUN npm install --unsafe-perm -g ponte bunyan\nRUN mkdir -p /opt/nginx/certs \\\n && cd /opt/nginx/certs \\\n && openssl genrsa  -out server.key 4096 \\\n && openssl req -new -batch -key server.key -out server.csr \\\n && openssl x509 -req -days 3650 -in server.csr -signkey server.key -out server.crt\n\nADD config.js /app/\nENTRYPOINT [\"ponte\", \"-c\",\"/app/config.js\",\"-v\", \"| bunyan\"]\nEXPOSE 8443 3000 5683\nRUN apt-get clean && rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*\n```\n\n### npm\u306e\u30b0\u30ed\u30fc\u30d0\u30eb\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n\u901a\u5e38Node.js\u306e\u30d1\u30c3\u30b1\u30fc\u30b8\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u306fpackage.json\u306b\u6307\u5b9a\u3057\u3066`npm install`\u3057\u307e\u3059\u304c\u3001\u30b0\u30ed\u30fc\u30d0\u30eb\u306b\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3088\u3046\u3068\u3059\u308b\u3068\u3044\u308d\u3044\u308d\u3068\u554f\u984c\u304c\u3042\u308a\u307e\u3059\u3002\u305d\u306e\u305f\u3081package.json\u306b\u306f\u6307\u5b9a\u305b\u305aDockerfile\u306b\u8a18\u8ff0\u3057\u307e\u3059\u3002\n\n``` json:~/docker_apps/ponte/package.json\n{\n  \"name\": \"ponte\",\n  \"description\": \"ponte test app\",\n  \"version\": \"0.0.1\",\n  \"private\": true\n}\n```\n\n\u307e\u305f`gyp WARN EACCES user \"undefined\" does not have permission`\u306e\u8b66\u544a\u304c\u3067\u3066\u3057\u307e\u3046\u305f\u3081\u3001`--unsafe-perm`\u30d5\u30e9\u30b0\u3092\u4ed8\u3051\u307e\u3059\u3002\n\n``` bash\nRUN npm install --unsafe-perm -g ponte bunyan\n```\n\n### Ponte\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\n\nPonte\u8d77\u52d5\u6642\u306bJS\u30d5\u30a1\u30a4\u30eb\u3067\u5404\u30d7\u30ed\u30c8\u30b3\u30eb\u306e\u8a2d\u5b9a\u3092\u6e21\u3059\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002MQTT\u306b\u306f\u30aa\u30ec\u30aa\u30ec\u8a3c\u660e\u66f8\u3068\u79d8\u5bc6\u9375\u306e\u30d1\u30b9\u3092\u6307\u5b9a\u3057\u307e\u3059\u3002\n\n``` js:~/docker_apps/ponte/config.js\nmodule.exports = {\n  logger: {\n    level: \"info\",\n  },\n  persistence: {\n    type: 'level',\n    path: './db'\n  },\n  mqtt: {\n    secure : {\n      port: 8443,\n      keyPath:\"/opt/nginx/certs/server.key\",\n      certPath:\"/opt/nginx/certs/server.crt\"\n    }\n  }\n}\n```\n\n### Ponte\u306e\u8d77\u52d5\n\nDocker\u30a4\u30e1\u30fc\u30b8\u306e\u30d3\u30eb\u30c9\u3068\u30b3\u30f3\u30c6\u30ca\u306e\u8d77\u52d5\u3092\u3057\u307e\u3059\u3002MQTT\u4ee5\u5916\u306b\u3082HTTP\u3068CoAP\u306e\u30dd\u30fc\u30c8\u3082Docker\u30db\u30b9\u30c8\u306b\u30de\u30c3\u30d7\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\n``` bash\n$ docker pull google/nodejs\n$ docker build -t ponte .\n$ docker run -d  --name ponte  \\\n  -p 8443:8443  \\\n  -p 3000:3000  \\\n  -p 5683:5683  \\\n  -it  ponte\n```\n\n\u30ed\u30b0\u3092\u898b\u308b\u30683\u3064\u306e\u30d7\u30ed\u30c8\u30b3\u30eb\u3067\u8d77\u52d5\u3057\u305f\u3053\u3068\u304c\u308f\u304b\u308a\u307e\u3059\u3002\n\n``` bash\n$ docker logs -f ponte\n{\"name\":\"ponte\",\"hostname\":\"17e232fd73f8\",\"pid\":1,\"service\":\"MQTT\",\"level\":30,\"mqtts\":8443,\"msg\":\"server started\",\"time\":\"2015-03-08T04:57:26.910Z\",\"v\":0}\n{\"name\":\"ponte\",\"hostname\":\"17e232fd73f8\",\"pid\":1,\"service\":\"HTTP\",\"level\":30,\"port\":3000,\"msg\":\"server started\",\"time\":\"2015-03-08T04:57:26.918Z\",\"v\":0}\n{\"name\":\"ponte\",\"hostname\":\"17e232fd73f8\",\"pid\":1,\"service\":\"CoAP\",\"level\":30,\"port\":5683,\"msg\":\"server started\",\"time\":\"2015-03-08T04:57:26.919Z\",\"v\":0}\n```\n\n## Pub/Sub\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u306e\u30b3\u30f3\u30c6\u30ca\n\nPub/Sub\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u306eDocker\u30a4\u30e1\u30fc\u30b8\u3092\u4f5c\u6210\u3059\u308b\u305f\u3081\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n``` bash\n$ mkdir -p ~/docker_apps/ponte-pubsub\n$ cd !$\n```\n\n### Dockerfile\n\nNode.js\u306e\u30d1\u30c3\u30b1\u30fc\u30b8\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u305f\u3081package.json\u3092\u7528\u610f\u3057\u307e\u3059\u3002\u65e5\u4ed8\u51e6\u7406\u306b\u4fbf\u5229\u306a[Moment.js](http://momentjs.com/)\u3082\u8ffd\u52a0\u3057\u307e\u3057\u305f\u3002\n \n``` json:~/docker_apps/ponte-pubsub/package.json\n{\n  \"name\": \"ponte-pubsub\",\n  \"description\": \"ponte-pubsub test app\",\n  \"version\": \"0.0.1\",\n  \"private\": true,\n  \"dependencies\": {\n    \"mqtt\": \"1.1.0\",\n    \"moment\": \"2.9.0\",\n    \"moment-timezone\": \"0.3.0\"\n  },\n  \"scripts\": {\"start\": \"node app.js\"}\n}\n```\n\nNode.js\u306e\u30e1\u30a4\u30f3\u30d7\u30ed\u30b0\u30e9\u30e0\u3067\u3059\u30023\u79d2\u9593\u9694\u3067Publish\u3092\u3057\u3066\u540c\u3058MQTT\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u3092\u4f7f\u3063\u3066Subscribe\u3057\u307e\u3059\u3002\n\n``` js:~/docker_apps/ponte-pubsub/app.js\nvar mqtt = require('mqtt'),\n    moment = require('moment-timezone');\n\nvar options = {\n  protocol: \"mqtts\",\n  port: process.env.MQTT_PORT,\n  host: process.env.MQTT_HOST,\n  username: process.env.MQTT_USERNAME,\n  password: process.env.MQTT_PASSWORD,\n  clientId: \"secure-\".concat(Math.floor(65535 * Math.random())),\n  rejectUnauthorized : false\n};\n\nvar client = mqtt.connect(options);\n\nclient.on('connect', function() {\n  console.log('client connected');\n});\n\nclient.subscribe('hello');\nclient.on('message',function(topic, data) {\n  console.log(\"Message on \" + topic + \": \" + data);\n});\n\nsetInterval(function() {\n  var now = moment().tz(\"Asia/Tokyo\").format(\"YYYY-MM-DD HH:mm:ssZ\");\n  client.publish('hello', now);\n  console.log('Message Published');\n}, 3000);\n```\n\n### \u30b3\u30f3\u30c6\u30ca\u3092\u4f7f\u3063\u3066Pub/Sub\u306e\u30c6\u30b9\u30c8\n\nDockerfile\u3092\u4f5c\u6210\u3057\u3066\u30a4\u30e1\u30fc\u30b8\u3092\u30d3\u30eb\u30c9\u3057\u307e\u3059\u3002\n\n``` bash\n$ echo FROM google/nodejs-runtime > Dockerfile\n$ docker pull google/nodejs-runtime\n$ docker build -t ponte-pubsub .\n```\n\n\u4f7f\u3044\u6368\u3066\u306e\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3057\u3066Pub/Sub\u306e\u30c6\u30b9\u30c8\u3092\u3057\u307e\u3059\u3002\u3067MQTT\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u306e\u8a2d\u5b9a\u3092\u74b0\u5883\u5909\u6570\u306b\u6e21\u3057\u307e\u3059\u3002\n\n``` bash\n$ docker run --rm --name ponte-pubsub \\\n  -e MQTT_HOST=10.3.0.230  \\\n  -e MQTT_PORT=8443 \\\n  -e MQTT_USERNAME=admin \\\n  -e MQTT_PASSWORD=password \\\n  ponte-pubsub\n\n> ponte-pubsub@0.0.1 start /app\n> node app.js\n\nsecure-46408\nclient connected\nMessage Published\nMessage on hello: 2015-03-08 13:47:58+09:00\n```\n\nPonte\u30b3\u30f3\u30c6\u30ca\u306e\u30ed\u30b0\u306b\u3082hello\u30c8\u30d4\u30c3\u30af\u306esubscribe\u306e\u69d8\u5b50\u304c\u51fa\u529b\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n\n``` bash\n$ docker logs -f ponte\n...\n{\"name\":\"ponte\",\"hostname\":\"17e232fd73f8\",\"pid\":1,\"service\":\"MQTT\",\"client\":\"secure-58538\",\"level\":30,\"msg\":\"client connected\",\"time\":\"2015-03-08T08:23:29.734Z\",\"v\":0}\n{\"name\":\"ponte\",\"hostname\":\"17e232fd73f8\",\"pid\":1,\"service\":\"MQTT\",\"client\":\"secure-58538\",\"level\":30,\"topic\":\"hello\",\"qos\":0,\"msg\":\"subscribed to topic\",\"time\":\"2015-03-08T08:23:29.742Z\",\"v\":0}\n{\"name\":\"ponte\",\"hostname\":\"17e232fd73f8\",\"pid\":1,\"service\":\"MQTT\",\"client\":\"secure-58538\",\"level\":30,\"topic\":\"hello\",\"msg\":\"unsubscribed\",\"time\":\"2015-03-08T08:23:36.788Z\",\"v\":0}\n{\"name\":\"ponte\",\"hostname\":\"17e232fd73f8\",\"pid\":1,\"service\":\"MQTT\",\"client\":\"secure-58538\",\"level\":30,\"msg\":\"closed\",\"time\":\"2015-03-08T08:23:36.793Z\",\"v\":0}\n```\n", "tags": ["Ponte0.0.13", "mqtt", "mosca0.28.1", "Node.js0.10.33"]}