{"context": "Lambda\u95a2\u6570\u3092\u4f5c\u6210\u3057\u3066\u3001slack\u306eIncoming Webhooks\u306b\u6295\u7a3f\u3057\u3066\u307f\u307e\u3059\u3002\n\u4eca\u56de\u306f\u3001CloudWatch Events\u3067\u5b9a\u671f\u5b9f\u884c\u3067\u304d\u308b\u3088\u3046\u306b\u3001\u30c7\u30fc\u30bf\u306f\u95a2\u6570\u306e\u5185\u90e8\u3067\u6301\u305f\u305b\u307e\u3059\u3002\n\n\u524d\u63d0\u6761\u4ef6\n\nLambda\u3078\u306e\u6a29\u9650\nLambda\u306b\u5bfe\u3057\u3066\u30d5\u30eb\u6a29\u9650\u304c\u3042\u308b\u3053\u3068\u3002\n\nAWS CLI\n\u4ee5\u4e0b\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u3067\u52d5\u4f5c\u78ba\u8a8d\u6e08\n\nAWS CLI 1.10.17\n\n\n\u30b3\u30de\u30f3\u30c9\naws --version\n\n\n\u7d50\u679c(\u4f8b):\n  aws-cli/1.10.6 Python/2.7.5 Darwin/13.4.0 botocore/1.3.28\n\n\nIAM Role\n'lambdaBasicExecution'\u30ed\u30fc\u30eb\u304c\u5b58\u5728\u3059\u308b\u3053\u3068\u3002\n\n\u5909\u6570\u306e\u8a2d\u5b9a\nIAM_ROLE_NAME='lambdaBasicExecution'\n\n\n\n\u30b3\u30de\u30f3\u30c9\naws iam get-role \\\n         --role-name ${IAM_ROLE_NAME}\n\n\n\n\u7d50\u679c(\u4f8b)\n      {\n        \"Role\": {\n          \"AssumeRolePolicyDocument\": {\n              \"Version\": \"2012-10-17\",\n              \"Statement\": [\n                  {\n                      \"Action\": \"sts:AssumeRole\",\n                      \"Principal\": {\n                          \"Service\": \"lambda.amazonaws.com\"\n                      },\n                      \"Effect\": \"Allow\",\n                      \"Sid\": \"\"\n                  }\n              ]\n          },\n          \"RoleId\": \"AROAI2DMAFJEPZE7RBSUG\",\n          \"CreateDate\": \"2015-10-26T01:55:54Z\",\n          \"RoleName\": \"lambdaBasicExecution\",\n          \"Path\": \"/\",\n          \"Arn\": \"arn:aws:iam::XXXXXXXXXXXX:role/lambdaBasicExecution\"\n        }\n      }\n\n\n\u5b58\u5728\u3057\u306a\u3044\u5834\u5408\u306f\u3001\u4ee5\u4e0b\u306e\u624b\u9806\u3092\u5b9f\u65bd\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\nIAM\u30ed\u30fc\u30eb\u306e\u4f5c\u6210 (Lambda: Basic execution): http://qiita.com/tcsh/items/6353876a5c4fef63b4d8\n\n\n\n0. \u6e96\u5099\n\n0.1. \u5909\u6570\u306e\u78ba\u8a8d\n\u30d7\u30ed\u30d5\u30a1\u30a4\u30eb\u304c\u60f3\u5b9a\u306e\u3082\u306e\u306b\u306a\u3063\u3066\u3044\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n\u5909\u6570\u306e\u78ba\u8a8d\naws configure list\n\n\n\n\u7d50\u679c(\u4f8b)\n            Name                    Value             Type    Location\n            ----                    -----             ----    --------\n         profile       administrator-prjz-mbp13        env    AWS_DEFAULT_PROFILE\n      access_key     ****************XXXX shared-credentials-file\n      secret_key     ****************XXXX shared-credentials-file\n          region                ap-northeast-1        env    AWS_DEFAULT_REGION\n\n\n\u30d7\u30ed\u30d5\u30a1\u30a4\u30eb\u304c\u60f3\u5b9a\u306e\u3082\u306e\u306b\u306a\u3063\u3066\u3044\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n0.2. IAM Role\u306eARN\u53d6\u5f97\n\n\u5909\u6570\u306e\u8a2d\u5b9a\nIAM_ROLE_NAME='lambdaBasicExecution'\n\n\n\n\u30b3\u30de\u30f3\u30c9\nIAM_ROLE_ARN=$( \\\n        aws iam get-role \\\n          --role-name ${IAM_ROLE_NAME} \\\n          --query 'Role.Arn' \\\n          --output text \\\n      ) \\\n        && echo ${IAM_ROLE_ARN}\n\n\n\n\u7d50\u679c(\u4f8b)\n      arn:aws:iam::XXXXXXXXXXXX:role/lambdaBasicExecution'\n\n\n\n1. \u4e8b\u524d\u4f5c\u696d\n\n1.1. Lambda\u95a2\u6570\u540d\u306e\u6c7a\u5b9a\n\n\u5909\u6570\u306e\u8a2d\u5b9a\nLAMBDA_FUNC_NAME='good_morning_lambda'\n\n\n\u540c\u540d\u306eLambda\u95a2\u6570\u306e\u4e0d\u5b58\u5728\u78ba\u8a8d\n\n\u30b3\u30de\u30f3\u30c9\naws lambda get-function \\\n        --function-name ${LAMBDA_FUNC_NAME}\n\n\n\n\u7d50\u679c(\u4f8b)\n      A client error (ResourceNotFoundException) occurred when calling the GetFunction operation: Function not found: arn:aws:lambda:ap-northeast-1:XXXXXXXXXXXX:function:good_morning_lambda\n\n\n\n1.2. Slack\u95a2\u9023\u306e\u8a2d\u5b9a\n\n\u5909\u6570\u306e\u8a2d\u5b9a\nURL_SLACK_IN=<slack\u306eIncoming WebHook\u306eURL>\nCHANNEL_SLACK='20160411'\nUSERNAME_SLACK='\u304a\u306f\u3088\u3046Lambda'\nICON_EMOJI_SLACK='sunrise'\nTEXT_SLACK=\"Good Morning\\!\\`\\`\\`\\'\u304a\u306f\u3088\u3046\\!\\'\\`\\`\\`\"\n\n\n\n1.3. Lambda\u95a2\u6570\n\n\u5909\u6570\u306e\u8a2d\u5b9a\nFILE_LAMBDA_FUNC=\"${LAMBDA_FUNC_NAME}.js\"\n\n\n\n\u5909\u6570\u306e\u78ba\u8a8d\ncat << ETX\n\n  FILE_LAMBDA_FUNC: ${FILE_LAMBDA_FUNC}\n\n  URL_SLACK_IN:     ${URL_SLACK_IN}\n  CHANNEL_SLACK:    ${CHANNEL_SLACK}\n  USERNAME_SLACK:   ${USERNAME_SLACK}\n  ICON_EMOJI_SLACK: ${ICON_EMOJI_SLACK}\n  TEXT_SLACK:       ${TEXT_SLACK}\n\nETX\n\n\n\n\u30b3\u30de\u30f3\u30c9\ncat << EOF > ${FILE_LAMBDA_FUNC}\nvar Slack = require('slack-node');\nconsole.log('Loading function');\n\nexports.handler = function(event, context) {\n  slack = new Slack();\n  slack.setWebhook('${URL_SLACK_IN}');\n\n  slack.webhook({\n    channel:    \"#\" + \"${CHANNEL_SLACK}\",\n    username:   \"${USERNAME_SLACK}\",\n    icon_emoji: \":\" + \"${ICON_EMOJI_SLACK}\" + \":\",\n    text:       \"${TEXT_SLACK}\"\n  }, function(err, response) {\n    console.log(response);\n    context.succeed(response);\n  });\n};\nEOF\n\ncat ${FILE_LAMBDA_FUNC}\n\n\n\n\u30b3\u30de\u30f3\u30c9(\u4efb\u610f)\neslint ${FILE_LAMBDA_FUNC}\n\n\n\n\u30b3\u30de\u30f3\u30c9\nnpm install slack-node\n\n\n\n\u7d50\u679c(\u4f8b)\nslack-node@0.2.0 node_modules/slack-node\n\u2514\u2500\u2500 requestretry@1.6.0 (when@3.7.7, fg-lodash@0.0.2, request@2.69.0)\n\n\n\n\u30b3\u30de\u30f3\u30c9\nzip -r ${LAMBDA_FUNC_NAME}.zip ${FILE_LAMBDA_FUNC} node_modules \\\n  && ls -l ${LAMBDA_FUNC_NAME}.zip\n\n\n\n\u7d50\u679c(\u4f8b)\n-rw-r--r--  1 lab-office  staff  3122259  4 10 19:42 good_morning_lambda.zip\n\n\n\n2. Lambda\u95a2\u6570\u306e\u4f5c\u6210\n\n\u5909\u6570\u306e\u8a2d\u5b9a\nLAMBDA_FUNC_DESC='AWS Lambda function for post slack incoming webhook.'\nLAMBDA_RUNTIME='nodejs'\nLAMBDA_HANDLER=\"${LAMBDA_FUNC_NAME}.handler\"\nFILE_LAMBDA_ZIP=\"${LAMBDA_FUNC_NAME}.zip\"\n\n\n\n\u5909\u6570\u306e\u78ba\u8a8d\ncat << ETX\n\n        LAMBDA_FUNC_NAME:  ${LAMBDA_FUNC_NAME}\n        LAMBDA_FUNC_DESC:  \"${LAMBDA_FUNC_DESC}\"\n        LAMBDA_RUNTIME:    ${LAMBDA_RUNTIME}\n        FILE_LAMBDA_ZIP    ${FILE_LAMBDA_ZIP}\n        IAM_ROLE_ARN:      ${IAM_ROLE_ARN}\n        LAMBDA_HANDLER:    ${LAMBDA_HANDLER}\n\nETX\n\n\n\n\u30b3\u30de\u30f3\u30c9\naws lambda create-function \\\n        --function-name ${LAMBDA_FUNC_NAME} \\\n        --description \"${LAMBDA_FUNC_DESC}\" \\\n        --zip-file fileb://${FILE_LAMBDA_ZIP} \\\n        --runtime ${LAMBDA_RUNTIME} \\\n        --role ${IAM_ROLE_ARN} \\\n        --handler ${LAMBDA_HANDLER}\n\n\n\n\u7d50\u679c(\u4f8b)\n{\n    \"CodeSha256\": \"8fI549wlUY+qm7LHTh5XmV/CdCkqabpBTbCOfiFJf3o=\",\n    \"FunctionName\": \"good_morning_lambda\",\n    \"CodeSize\": 1978932,\n    \"MemorySize\": 128,\n    \"FunctionArn\": \"arn:aws:lambda:ap-northeast-1:XXXXXXXXXXXX:function:good_morning_lambda\",\n    \"Version\": \"$LATEST\",\n    \"Role\": \"arn:aws:iam::XXXXXXXXXXXX:role/lambdaBasicExecution\",\n    \"Timeout\": 3,\n    \"LastModified\": \"2016-02-22T08:44:48.274+0000\",\n    \"Handler\": \"good_morning_lambda.handler\",\n    \"Runtime\": \"nodejs\",\n    \"Description\": \"AWS Lambda function for post slack incoming webhook.\"\n}\n\n\n\n\u30b3\u30de\u30f3\u30c9\naws lambda get-function \\\n        --function-name ${LAMBDA_FUNC_NAME}\n\n\n\n\u7d50\u679c(\u4f8b)\n{\n    \"Code\": {\n        \"RepositoryType\": \"S3\",\n        \"Location\": \"https://awslambda-ap-ne-1-tasks.s3-ap-northeast-1.amazonaws.com/snapshots/XXXXXXXXXXXX/good_morning_lambda-ac0802dc-9a1e-4d0d-a7c8-e88bfd13fc88?x-amz-security-token=AQoDYXdzECka4AO2NeNXdEJ0XHeft0nvNiPkug4SqexqnBLBZj%2FkpT%2FleFIDbSUva%2BunE48A4%2BxVrfprD2Qg6UIusixkHBTdA%2BvFzwVDD%2FRVcSqXXK5IDPejbVP39tR%2BlVz6FvLPbQgXJ90budQsNfGGxKuN0KG5PrjNAP%2BwLXIHfgI9ZW%2BBzPRGFNMp6KZN8GyoDl2SPrmazbLXwFbmF9RNNAyQ76yJCwKWgRL1J9tEBI34U6tGJLOfiTlG4ES5e1IHGALJRCxakodS7dhE3UpVO7%2BbTbAK%2F5DdkCb2H4iENiIs0VoVwBvm2J%2FMhLHjXwa9fibMHji4zaX81qr9PN4saIT%2FwnVf3nljCJv5oKM5cC3Wzh%2Bcb6CAh4AJppjI9nNDqozQzXnvDrEvp6vzP%2Boti52FHXG%2Bp5Y4zXTrpiu35vOca19DOPD8Gc%2FxaycrXujULkXQpe8%2F%2BGjmMIw8yZGJQNfzKkg7DothBPRVvgNZe%2FvwyiXEllSft%2BrfDhWkMAk1mq24e%2FWxRQ4TGr8oBJ1yM2nsD0yx7406px1uXXPyTCOy%2FI2lH3K%2BVhJ391gJ6vdgugk4oWuTE5XK%2BHiyS17cYgWDciISf%2B0FpWufVWcQYFgV%2Bu4csHnnh6tYHiqe8McHzuvKe4UAli0goPyqtgU%3D&AWSAccessKeyId=ASIAXXXXXXXXXXXXXXXXX&Expires=1456131365&Signature=Na9a83GZbmR6cL2XnvZOOafGCN8%3D\"\n    },\n    \"Configuration\": {\n        \"Version\": \"$LATEST\",\n        \"CodeSha256\": \"8fI549wlUY+qm7LHTh5Xmx/CdCkqabpBTbCOfiFJx3o=\",\n        \"FunctionName\": \"good_morning_lambda\",\n        \"MemorySize\": 128,\n        \"CodeSize\": 1978932,\n        \"FunctionArn\": \"arn:aws:lambda:ap-northeast-1:XXXXXXXXXXXX:function:good_morning_lambda\",\n        \"Handler\": \"good_morning_lambda.handler\",\n        \"Role\": \"arn:aws:iam::XXXXXXXXXXXX:role/lambdaBasicExecution\",\n        \"Timeout\": 3,\n        \"LastModified\": \"2016-02-22T08:44:48.274+0000\",\n        \"Runtime\": \"nodejs\",\n        \"Description\": \"AWS Lambda function for post slack incoming webhook.\"\n    }\n}\n\n\n\n3. Lambda\u95a2\u6570\u306e\u52d5\u4f5c\u78ba\u8a8d\n\n3.1. lambda\u95a2\u6570\u306e\u624b\u52d5\u5b9f\u884c\n\n\u5909\u6570\u306e\u8a2d\u5b9a\nFILE_OUTPUT_LAMBDA=\"${LAMBDA_FUNC_NAME}-out.txt\" \\\n        && echo ${FILE_OUTPUT_LAMBDA}\n\n\n\n\u5909\u6570\u306e\u78ba\u8a8d\ncat << ETX\n\n        LAMBDA_FUNC_NAME:   ${LAMBDA_FUNC_NAME}\n        FILE_OUTPUT_LAMBDA: ${FILE_OUTPUT_LAMBDA}\n\nETX\n\n\n\n\u30b3\u30de\u30f3\u30c9\nFILE_LOG_LAMBDA=\"${LAMBDA_FUNC_NAME}-$(date +%Y%m%d%H%M%S).log\" \\\n        && echo ${FILE_LOG_LAMBDA}\n\naws lambda invoke \\\n        --function-name ${LAMBDA_FUNC_NAME} \\\n        --log-type Tail \\\n        ${FILE_OUTPUT_LAMBDA} \\\n        > ${FILE_LOG_LAMBDA} \\\n\ncat ${FILE_LOG_LAMBDA} \\\n   | jp.py 'StatusCode'\n\n\n\n\u7d50\u679c(\u4f8b)\n      200\n\n\n\n3.2. lambda\u95a2\u6570\u306e\u5b9f\u884c\u7d50\u679c\u306e\u78ba\u8a8d\n\n\u30b3\u30de\u30f3\u30c9\ncat ${FILE_OUTPUT_LAMBDA}\n\n\n\n\u7d50\u679c\n{\"status\":\"ok\",\"statusCode\":200,\"headers\":{\"content-type\":\"text/html\",\"content-length\":\"2\",\"connection\":\"keep-alive\",\"access-control-allow-origin\":\"*\",\"content-security-policy\":\"referrer no-referrer;\",\"date\":\"Mon, 22 Feb 2016 08:50:33 GMT\",\"server\":\"Apache\",\"strict-transport-security\":\"max-age=31536000; includeSubDomains; preload\",\"x-frame-options\":\"SAMEORIGIN\",\"x-cache\":\"Miss from cloudfront\",\"via\":\"1.1 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx.cloudfront.net (CloudFront)\",\"x-amz-cf-id\":\"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx==\"},\"response\":\"ok\"}\n\n\n\n3.3. lambda\u95a2\u6570\u306e\u30ed\u30b0\u306e\u78ba\u8a8d\n\n\u30b3\u30de\u30f3\u30c9\ncat ${FILE_LOG_LAMBDA} \\\n  | jp.py 'LogResult' \\\n  | sed 's/\"//' \\\n  | base64 --decode\n\n\n\n\u7d50\u679c\nSTART RequestId: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx Version: $LATEST\n2016-04-10T04:38:22.476Z    xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx    { status: 'ok',\n  statusCode: 200,\n  headers: \n   { 'content-type': 'text/html',\n     'transfer-encoding': 'chunked',\n     connection: 'keep-alive',\n     'access-control-allow-origin': '*',\n     'content-security-policy': 'referrer no-referrer;',\n     date: 'Sun, 10 Apr 2016 04:38:22 GMT',\n     server: 'Apache',\n     'strict-transport-security': 'max-age=31536000; includeSubDomains; preload',\n     vary: 'Accept-Encoding',\n     'x-frame-options': 'SAMEORIGIN',\n     'x-cache': 'Miss from cloudfront',\n     via: '1.1 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx.cloudfront.net (CloudFront)',\n     'x-amz-cf-id': 'xxxxxxxxxxxxxxxxxxx_xx_xxxxxxxxxxxxxxxxxxxxxxxxxxxxx_x==' },\n  response: 'ok' }\nEND RequestId: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx\nREPORT RequestId: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx  Duration: 998.63 ms Billed Duration: 1000 ms    Memory Size: 128 MB Max Memory Used: 41 MB  \n\n\n\n4. permission\u306e\u8ffd\u52a0\n\n4.1. \u30ed\u30fc\u30ebARN\u306e\u53d6\u5f97\n\n\u5909\u6570\u306e\u8a2d\u5b9a\nLAMBDA_RULE_ROLE_ARN=$( \\\naws iam list-roles \\\n  --query \"Roles[?contains(RoleName, \\`${IAM_ROLE_NAME}\\`)].Arn\" \\\n  --output text \\\n) \\\n  && echo ${LAMBDA_RULE_ROLE_ARN}\n\n\n\n4.2. Lambda\u5b9f\u884c\u6a29\u9650\u306e\u4ed8\u4e0e\n\n\u5909\u6570\u306e\u8a2d\u5b9a\nLAMBDA_STAT_ID='AllowScheduledEvents'\nLAMBDA_PERMIT_ACTION='lambda:InvokeFunction'\nLAMBDA_PERMIT_PRINCIPAL='events.amazonaws.com'\n\n\n\n\u5909\u6570\u306e\u78ba\u8a8d\ncat << ETX\n\n  LAMBDA_FUNC_NAME:        ${LAMBDA_FUNC_NAME}\n  LAMBDA_STAT_ID:         \"${LAMBDA_STAT_ID}\"\n  LAMBDA_PERMIT_ACTION:    ${LAMBDA_PERMIT_ACTION}\n  LAMBDA_PERMIT_PRINCIPAL: ${LAMBDA_PERMIT_PRINCIPAL}\n  LAMBDA_RULE_ROLE_ARN:    ${LAMBDA_RULE_ROLE_ARN}\n\nETX\n\n\n\n\u30b3\u30de\u30f3\u30c9\naws lambda add-permission \\\n  --function-name ${LAMBDA_FUNC_NAME} \\\n  --statement-id \"${LAMBDA_STAT_ID}\" \\\n  --action ${LAMBDA_PERMIT_ACTION} \\\n  --principal ${LAMBDA_PERMIT_PRINCIPAL} \\\n  --role ${LAMBDA_RULE_ROLE_ARN}\n\n\n\n\u7d50\u679c(\u4f8b)\n{\n    \"Statement\": \"{\\\"Action\\\":[\\\"lambda:InvokeFunction\\\"],\\\"Resource\\\":\\\"arn:aws:lambda:us-west-2:XXXXXXXXXXXX:function:good_morning_lambda\\\",\\\"Effect\\\":\\\"Allow\\\",\\\"Principal\\\":{\\\"Service\\\":\\\"events.amazonaws.com\\\"},\\\"Sid\\\":\\\"AllowScheduledEvents\\\"}\"\n}\n\n\n\n\u5b8c\u4e86\nLambda\u95a2\u6570\u3092\u4f5c\u6210\u3057\u3066\u3001slack\u306eIncoming Webhooks\u306b\u6295\u7a3f\u3057\u3066\u307f\u307e\u3059\u3002\n\n\u4eca\u56de\u306f\u3001CloudWatch Events\u3067\u5b9a\u671f\u5b9f\u884c\u3067\u304d\u308b\u3088\u3046\u306b\u3001\u30c7\u30fc\u30bf\u306f\u95a2\u6570\u306e\u5185\u90e8\u3067\u6301\u305f\u305b\u307e\u3059\u3002\n\n\n\u524d\u63d0\u6761\u4ef6\n========\n\nLambda\u3078\u306e\u6a29\u9650\n--------------\n\nLambda\u306b\u5bfe\u3057\u3066\u30d5\u30eb\u6a29\u9650\u304c\u3042\u308b\u3053\u3068\u3002\n\n\nAWS CLI\n-------\n\n\u4ee5\u4e0b\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u3067\u52d5\u4f5c\u78ba\u8a8d\u6e08\n\n* AWS CLI 1.10.17\n\n```bash:\u30b3\u30de\u30f3\u30c9:\naws --version\n```\n\n\u7d50\u679c(\u4f8b):\n\n      aws-cli/1.10.6 Python/2.7.5 Darwin/13.4.0 botocore/1.3.28\n\n\nIAM Role\n--------\n\n'lambdaBasicExecution'\u30ed\u30fc\u30eb\u304c\u5b58\u5728\u3059\u308b\u3053\u3068\u3002\n\n```bash:\u5909\u6570\u306e\u8a2d\u5b9a:\nIAM_ROLE_NAME='lambdaBasicExecution'\n```\n\n```bash:\u30b3\u30de\u30f3\u30c9:\naws iam get-role \\\n         --role-name ${IAM_ROLE_NAME}\n```\n\n```json:\u7d50\u679c(\u4f8b):\n      {\n        \"Role\": {\n          \"AssumeRolePolicyDocument\": {\n              \"Version\": \"2012-10-17\",\n              \"Statement\": [\n                  {\n                      \"Action\": \"sts:AssumeRole\",\n                      \"Principal\": {\n                          \"Service\": \"lambda.amazonaws.com\"\n                      },\n                      \"Effect\": \"Allow\",\n                      \"Sid\": \"\"\n                  }\n              ]\n          },\n          \"RoleId\": \"AROAI2DMAFJEPZE7RBSUG\",\n          \"CreateDate\": \"2015-10-26T01:55:54Z\",\n          \"RoleName\": \"lambdaBasicExecution\",\n          \"Path\": \"/\",\n          \"Arn\": \"arn:aws:iam::XXXXXXXXXXXX:role/lambdaBasicExecution\"\n        }\n      }\n```\n\u5b58\u5728\u3057\u306a\u3044\u5834\u5408\u306f\u3001\u4ee5\u4e0b\u306e\u624b\u9806\u3092\u5b9f\u65bd\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n- IAM\u30ed\u30fc\u30eb\u306e\u4f5c\u6210 (Lambda: Basic execution): http://qiita.com/tcsh/items/6353876a5c4fef63b4d8\n\n\n0. \u6e96\u5099\n=======\n\n\n0.1. \u5909\u6570\u306e\u78ba\u8a8d\n---------------\n\n\u30d7\u30ed\u30d5\u30a1\u30a4\u30eb\u304c\u60f3\u5b9a\u306e\u3082\u306e\u306b\u306a\u3063\u3066\u3044\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n```bash:\u5909\u6570\u306e\u78ba\u8a8d:\naws configure list\n```\n\n```text:\u7d50\u679c(\u4f8b):\n            Name                    Value             Type    Location\n            ----                    -----             ----    --------\n         profile       administrator-prjz-mbp13        env    AWS_DEFAULT_PROFILE\n      access_key     ****************XXXX shared-credentials-file\n      secret_key     ****************XXXX shared-credentials-file\n          region                ap-northeast-1        env    AWS_DEFAULT_REGION\n```\n\n\u30d7\u30ed\u30d5\u30a1\u30a4\u30eb\u304c\u60f3\u5b9a\u306e\u3082\u306e\u306b\u306a\u3063\u3066\u3044\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n\n0.2. IAM Role\u306eARN\u53d6\u5f97\n----------------------\n\n```bash:\u5909\u6570\u306e\u8a2d\u5b9a:\nIAM_ROLE_NAME='lambdaBasicExecution'\n```\n\n```bash:\u30b3\u30de\u30f3\u30c9:\nIAM_ROLE_ARN=$( \\\n        aws iam get-role \\\n          --role-name ${IAM_ROLE_NAME} \\\n          --query 'Role.Arn' \\\n          --output text \\\n      ) \\\n        && echo ${IAM_ROLE_ARN}\n```\n\n```text:\u7d50\u679c(\u4f8b):\n      arn:aws:iam::XXXXXXXXXXXX:role/lambdaBasicExecution'\n```\n\n\n1. \u4e8b\u524d\u4f5c\u696d\n===========\n\n\n1.1. Lambda\u95a2\u6570\u540d\u306e\u6c7a\u5b9a\n-----------------------\n\n```bash:\u5909\u6570\u306e\u8a2d\u5b9a:\nLAMBDA_FUNC_NAME='good_morning_lambda'\n```\n\n\u540c\u540d\u306eLambda\u95a2\u6570\u306e\u4e0d\u5b58\u5728\u78ba\u8a8d\n\n```bash:\u30b3\u30de\u30f3\u30c9:\naws lambda get-function \\\n        --function-name ${LAMBDA_FUNC_NAME}\n```\n\n```text:\u7d50\u679c(\u4f8b):\n      A client error (ResourceNotFoundException) occurred when calling the GetFunction operation: Function not found: arn:aws:lambda:ap-northeast-1:XXXXXXXXXXXX:function:good_morning_lambda\n```\n\n1.2. Slack\u95a2\u9023\u306e\u8a2d\u5b9a\n---------------\n\n```bash:\u5909\u6570\u306e\u8a2d\u5b9a:\nURL_SLACK_IN=<slack\u306eIncoming WebHook\u306eURL>\nCHANNEL_SLACK='20160411'\nUSERNAME_SLACK='\u304a\u306f\u3088\u3046Lambda'\nICON_EMOJI_SLACK='sunrise'\nTEXT_SLACK=\"Good Morning\\!\\`\\`\\`\\'\u304a\u306f\u3088\u3046\\!\\'\\`\\`\\`\"\n```\n\n\n1.3. Lambda\u95a2\u6570\n---------------\n\n```bash:\u5909\u6570\u306e\u8a2d\u5b9a:\nFILE_LAMBDA_FUNC=\"${LAMBDA_FUNC_NAME}.js\"\n```\n\n```bash:\u5909\u6570\u306e\u78ba\u8a8d:\ncat << ETX\n\n  FILE_LAMBDA_FUNC: ${FILE_LAMBDA_FUNC}\n\n  URL_SLACK_IN:     ${URL_SLACK_IN}\n  CHANNEL_SLACK:    ${CHANNEL_SLACK}\n  USERNAME_SLACK:   ${USERNAME_SLACK}\n  ICON_EMOJI_SLACK: ${ICON_EMOJI_SLACK}\n  TEXT_SLACK:       ${TEXT_SLACK}\n\nETX\n```\n\n```bash:\u30b3\u30de\u30f3\u30c9:\ncat << EOF > ${FILE_LAMBDA_FUNC}\nvar Slack = require('slack-node');\nconsole.log('Loading function');\n\nexports.handler = function(event, context) {\n  slack = new Slack();\n  slack.setWebhook('${URL_SLACK_IN}');\n\n  slack.webhook({\n    channel:    \"#\" + \"${CHANNEL_SLACK}\",\n    username:   \"${USERNAME_SLACK}\",\n    icon_emoji: \":\" + \"${ICON_EMOJI_SLACK}\" + \":\",\n    text:       \"${TEXT_SLACK}\"\n  }, function(err, response) {\n    console.log(response);\n    context.succeed(response);\n  });\n};\nEOF\n\ncat ${FILE_LAMBDA_FUNC}\n```\n\n```bash:\u30b3\u30de\u30f3\u30c9(\u4efb\u610f):\neslint ${FILE_LAMBDA_FUNC}\n```\n\n```bash:\u30b3\u30de\u30f3\u30c9:\nnpm install slack-node\n```\n\n```text:\u7d50\u679c(\u4f8b)\nslack-node@0.2.0 node_modules/slack-node\n\u2514\u2500\u2500 requestretry@1.6.0 (when@3.7.7, fg-lodash@0.0.2, request@2.69.0)\n```\n\n```bash:\u30b3\u30de\u30f3\u30c9:\nzip -r ${LAMBDA_FUNC_NAME}.zip ${FILE_LAMBDA_FUNC} node_modules \\\n  && ls -l ${LAMBDA_FUNC_NAME}.zip\n```\n\n```text:\u7d50\u679c(\u4f8b)\n-rw-r--r--  1 lab-office  staff  3122259  4 10 19:42 good_morning_lambda.zip\n```\n\n2. Lambda\u95a2\u6570\u306e\u4f5c\u6210\n===================\n\n```bash:\u5909\u6570\u306e\u8a2d\u5b9a:\nLAMBDA_FUNC_DESC='AWS Lambda function for post slack incoming webhook.'\nLAMBDA_RUNTIME='nodejs'\nLAMBDA_HANDLER=\"${LAMBDA_FUNC_NAME}.handler\"\nFILE_LAMBDA_ZIP=\"${LAMBDA_FUNC_NAME}.zip\"\n```\n\n```bash:\u5909\u6570\u306e\u78ba\u8a8d:\ncat << ETX\n\n        LAMBDA_FUNC_NAME:  ${LAMBDA_FUNC_NAME}\n        LAMBDA_FUNC_DESC:  \"${LAMBDA_FUNC_DESC}\"\n        LAMBDA_RUNTIME:    ${LAMBDA_RUNTIME}\n        FILE_LAMBDA_ZIP    ${FILE_LAMBDA_ZIP}\n        IAM_ROLE_ARN:      ${IAM_ROLE_ARN}\n        LAMBDA_HANDLER:    ${LAMBDA_HANDLER}\n\nETX\n```\n\n```bash:\u30b3\u30de\u30f3\u30c9:\naws lambda create-function \\\n        --function-name ${LAMBDA_FUNC_NAME} \\\n        --description \"${LAMBDA_FUNC_DESC}\" \\\n        --zip-file fileb://${FILE_LAMBDA_ZIP} \\\n        --runtime ${LAMBDA_RUNTIME} \\\n        --role ${IAM_ROLE_ARN} \\\n        --handler ${LAMBDA_HANDLER}\n```\n\n```json:\u7d50\u679c(\u4f8b):\n{\n    \"CodeSha256\": \"8fI549wlUY+qm7LHTh5XmV/CdCkqabpBTbCOfiFJf3o=\",\n    \"FunctionName\": \"good_morning_lambda\",\n    \"CodeSize\": 1978932,\n    \"MemorySize\": 128,\n    \"FunctionArn\": \"arn:aws:lambda:ap-northeast-1:XXXXXXXXXXXX:function:good_morning_lambda\",\n    \"Version\": \"$LATEST\",\n    \"Role\": \"arn:aws:iam::XXXXXXXXXXXX:role/lambdaBasicExecution\",\n    \"Timeout\": 3,\n    \"LastModified\": \"2016-02-22T08:44:48.274+0000\",\n    \"Handler\": \"good_morning_lambda.handler\",\n    \"Runtime\": \"nodejs\",\n    \"Description\": \"AWS Lambda function for post slack incoming webhook.\"\n}\n```\n\n```bash:\u30b3\u30de\u30f3\u30c9:\naws lambda get-function \\\n        --function-name ${LAMBDA_FUNC_NAME}\n```\n\n```json:\u7d50\u679c(\u4f8b):\n{\n    \"Code\": {\n        \"RepositoryType\": \"S3\",\n        \"Location\": \"https://awslambda-ap-ne-1-tasks.s3-ap-northeast-1.amazonaws.com/snapshots/XXXXXXXXXXXX/good_morning_lambda-ac0802dc-9a1e-4d0d-a7c8-e88bfd13fc88?x-amz-security-token=AQoDYXdzECka4AO2NeNXdEJ0XHeft0nvNiPkug4SqexqnBLBZj%2FkpT%2FleFIDbSUva%2BunE48A4%2BxVrfprD2Qg6UIusixkHBTdA%2BvFzwVDD%2FRVcSqXXK5IDPejbVP39tR%2BlVz6FvLPbQgXJ90budQsNfGGxKuN0KG5PrjNAP%2BwLXIHfgI9ZW%2BBzPRGFNMp6KZN8GyoDl2SPrmazbLXwFbmF9RNNAyQ76yJCwKWgRL1J9tEBI34U6tGJLOfiTlG4ES5e1IHGALJRCxakodS7dhE3UpVO7%2BbTbAK%2F5DdkCb2H4iENiIs0VoVwBvm2J%2FMhLHjXwa9fibMHji4zaX81qr9PN4saIT%2FwnVf3nljCJv5oKM5cC3Wzh%2Bcb6CAh4AJppjI9nNDqozQzXnvDrEvp6vzP%2Boti52FHXG%2Bp5Y4zXTrpiu35vOca19DOPD8Gc%2FxaycrXujULkXQpe8%2F%2BGjmMIw8yZGJQNfzKkg7DothBPRVvgNZe%2FvwyiXEllSft%2BrfDhWkMAk1mq24e%2FWxRQ4TGr8oBJ1yM2nsD0yx7406px1uXXPyTCOy%2FI2lH3K%2BVhJ391gJ6vdgugk4oWuTE5XK%2BHiyS17cYgWDciISf%2B0FpWufVWcQYFgV%2Bu4csHnnh6tYHiqe8McHzuvKe4UAli0goPyqtgU%3D&AWSAccessKeyId=ASIAXXXXXXXXXXXXXXXXX&Expires=1456131365&Signature=Na9a83GZbmR6cL2XnvZOOafGCN8%3D\"\n    },\n    \"Configuration\": {\n        \"Version\": \"$LATEST\",\n        \"CodeSha256\": \"8fI549wlUY+qm7LHTh5Xmx/CdCkqabpBTbCOfiFJx3o=\",\n        \"FunctionName\": \"good_morning_lambda\",\n        \"MemorySize\": 128,\n        \"CodeSize\": 1978932,\n        \"FunctionArn\": \"arn:aws:lambda:ap-northeast-1:XXXXXXXXXXXX:function:good_morning_lambda\",\n        \"Handler\": \"good_morning_lambda.handler\",\n        \"Role\": \"arn:aws:iam::XXXXXXXXXXXX:role/lambdaBasicExecution\",\n        \"Timeout\": 3,\n        \"LastModified\": \"2016-02-22T08:44:48.274+0000\",\n        \"Runtime\": \"nodejs\",\n        \"Description\": \"AWS Lambda function for post slack incoming webhook.\"\n    }\n}\n```\n\n\n3. Lambda\u95a2\u6570\u306e\u52d5\u4f5c\u78ba\u8a8d\n=======================\n\n\n\n3.1. lambda\u95a2\u6570\u306e\u624b\u52d5\u5b9f\u884c\n-------------------------\n\n```bash:\u5909\u6570\u306e\u8a2d\u5b9a\nFILE_OUTPUT_LAMBDA=\"${LAMBDA_FUNC_NAME}-out.txt\" \\\n        && echo ${FILE_OUTPUT_LAMBDA}\n```\n\n\n```bash:\u5909\u6570\u306e\u78ba\u8a8d:\ncat << ETX\n\n        LAMBDA_FUNC_NAME:   ${LAMBDA_FUNC_NAME}\n        FILE_OUTPUT_LAMBDA: ${FILE_OUTPUT_LAMBDA}\n\nETX\n```\n\n```bash:\u30b3\u30de\u30f3\u30c9:\nFILE_LOG_LAMBDA=\"${LAMBDA_FUNC_NAME}-$(date +%Y%m%d%H%M%S).log\" \\\n        && echo ${FILE_LOG_LAMBDA}\n\naws lambda invoke \\\n        --function-name ${LAMBDA_FUNC_NAME} \\\n        --log-type Tail \\\n        ${FILE_OUTPUT_LAMBDA} \\\n        > ${FILE_LOG_LAMBDA} \\\n\ncat ${FILE_LOG_LAMBDA} \\\n   | jp.py 'StatusCode'\n```\n\n```text:\u7d50\u679c(\u4f8b):\n      200\n```\n\n\n3.2. lambda\u95a2\u6570\u306e\u5b9f\u884c\u7d50\u679c\u306e\u78ba\u8a8d\n-------------------------------\n\n```bash:\u30b3\u30de\u30f3\u30c9:\ncat ${FILE_OUTPUT_LAMBDA}\n```\n\n```text:\u7d50\u679c:\n{\"status\":\"ok\",\"statusCode\":200,\"headers\":{\"content-type\":\"text/html\",\"content-length\":\"2\",\"connection\":\"keep-alive\",\"access-control-allow-origin\":\"*\",\"content-security-policy\":\"referrer no-referrer;\",\"date\":\"Mon, 22 Feb 2016 08:50:33 GMT\",\"server\":\"Apache\",\"strict-transport-security\":\"max-age=31536000; includeSubDomains; preload\",\"x-frame-options\":\"SAMEORIGIN\",\"x-cache\":\"Miss from cloudfront\",\"via\":\"1.1 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx.cloudfront.net (CloudFront)\",\"x-amz-cf-id\":\"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx==\"},\"response\":\"ok\"}\n```\n\n\n3.3. lambda\u95a2\u6570\u306e\u30ed\u30b0\u306e\u78ba\u8a8d\n---------------------------\n\n```bash:\u30b3\u30de\u30f3\u30c9:\ncat ${FILE_LOG_LAMBDA} \\\n  | jp.py 'LogResult' \\\n  | sed 's/\"//' \\\n  | base64 --decode\n```\n\n```text:\u7d50\u679c:\nSTART RequestId: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx Version: $LATEST\n2016-04-10T04:38:22.476Z\txxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx\t{ status: 'ok',\n  statusCode: 200,\n  headers: \n   { 'content-type': 'text/html',\n     'transfer-encoding': 'chunked',\n     connection: 'keep-alive',\n     'access-control-allow-origin': '*',\n     'content-security-policy': 'referrer no-referrer;',\n     date: 'Sun, 10 Apr 2016 04:38:22 GMT',\n     server: 'Apache',\n     'strict-transport-security': 'max-age=31536000; includeSubDomains; preload',\n     vary: 'Accept-Encoding',\n     'x-frame-options': 'SAMEORIGIN',\n     'x-cache': 'Miss from cloudfront',\n     via: '1.1 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx.cloudfront.net (CloudFront)',\n     'x-amz-cf-id': 'xxxxxxxxxxxxxxxxxxx_xx_xxxxxxxxxxxxxxxxxxxxxxxxxxxxx_x==' },\n  response: 'ok' }\nEND RequestId: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx\nREPORT RequestId: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx\tDuration: 998.63 ms\tBilled Duration: 1000 ms \tMemory Size: 128 MB\tMax Memory Used: 41 MB\t\n```\n\n\n\n4. permission\u306e\u8ffd\u52a0\n======================\n\n4.1. \u30ed\u30fc\u30ebARN\u306e\u53d6\u5f97\n-----------------------\n\n```bash:\u5909\u6570\u306e\u8a2d\u5b9a\nLAMBDA_RULE_ROLE_ARN=$( \\\naws iam list-roles \\\n  --query \"Roles[?contains(RoleName, \\`${IAM_ROLE_NAME}\\`)].Arn\" \\\n  --output text \\\n) \\\n  && echo ${LAMBDA_RULE_ROLE_ARN}\n```\n\n\n4.2. Lambda\u5b9f\u884c\u6a29\u9650\u306e\u4ed8\u4e0e\n---------------------------\n\n```bash:\u5909\u6570\u306e\u8a2d\u5b9a\nLAMBDA_STAT_ID='AllowScheduledEvents'\nLAMBDA_PERMIT_ACTION='lambda:InvokeFunction'\nLAMBDA_PERMIT_PRINCIPAL='events.amazonaws.com'\n```\n\n```bash:\u5909\u6570\u306e\u78ba\u8a8d\ncat << ETX\n\n  LAMBDA_FUNC_NAME:        ${LAMBDA_FUNC_NAME}\n  LAMBDA_STAT_ID:         \"${LAMBDA_STAT_ID}\"\n  LAMBDA_PERMIT_ACTION:    ${LAMBDA_PERMIT_ACTION}\n  LAMBDA_PERMIT_PRINCIPAL: ${LAMBDA_PERMIT_PRINCIPAL}\n  LAMBDA_RULE_ROLE_ARN:    ${LAMBDA_RULE_ROLE_ARN}\n\nETX\n```\n\n```bash:\u30b3\u30de\u30f3\u30c9:\naws lambda add-permission \\\n  --function-name ${LAMBDA_FUNC_NAME} \\\n  --statement-id \"${LAMBDA_STAT_ID}\" \\\n  --action ${LAMBDA_PERMIT_ACTION} \\\n  --principal ${LAMBDA_PERMIT_PRINCIPAL} \\\n  --role ${LAMBDA_RULE_ROLE_ARN}\n```\n\n```json:\u7d50\u679c(\u4f8b)\n{\n    \"Statement\": \"{\\\"Action\\\":[\\\"lambda:InvokeFunction\\\"],\\\"Resource\\\":\\\"arn:aws:lambda:us-west-2:XXXXXXXXXXXX:function:good_morning_lambda\\\",\\\"Effect\\\":\\\"Allow\\\",\\\"Principal\\\":{\\\"Service\\\":\\\"events.amazonaws.com\\\"},\\\"Sid\\\":\\\"AllowScheduledEvents\\\"}\"\n}\n```\n\n\u5b8c\u4e86\n====\n", "tags": ["AWS", "aws-cli", "lambda"]}