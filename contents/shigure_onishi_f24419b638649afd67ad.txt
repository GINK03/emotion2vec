{"context": " More than 1 year has passed since last update.\n\nEC2 + CoreOS + Docker\u3067\u30b3\u30f3\u30c6\u30ca\u4f5c\u6210\u304b\u3089\u30c7\u30d7\u30ed\u30a4\u307e\u3067\n\n\u3053\u306e\u8a18\u4e8b\u3067\u3084\u3063\u3066\u3044\u308b\u3053\u3068\n\n\u30b3\u30f3\u30c6\u30ca\u3092\u4f5c\u3063\u3066HTTP\u3067\u30a2\u30af\u30bb\u30b9\u78ba\u8a8d\u3059\u308b\nDocker Hub\u306bPush\u3059\u308b\n\u5225\u306e\u4eee\u60f3\u74b0\u5883\u3067\u5148\u307b\u3069\u306e\u30a4\u30e1\u30fc\u30b8\u3092\u30c6\u30b9\u30c8\u3059\u308b\netcd + fleet\u3092\u4f7f\u7528\u3057\u3066EC2\u3067\u8d77\u52d5\nfleet\u3092\u4f7f\u7528\u3057\u3066Docker\u8d77\u52d5\n\u30a4\u30e1\u30fc\u30b8\u3092\u66f4\u65b0\u3059\u308b\nfleet\u3092\u4f7f\u3063\u3066EC2\u306e\u30b3\u30f3\u30c6\u30ca\u3092\u66f4\u65b0\u3059\u308b\n\n\n\u30b3\u30f3\u30c6\u30ca\u3092\u4f5c\u3063\u3066HTTP\u3067\u30a2\u30af\u30bb\u30b9\u78ba\u8a8d\u3059\u308b\n\u307e\u305a\u306f\u958b\u767a\u74b0\u5883\u3067\u30b3\u30f3\u30c6\u30ca\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n\u4f5c\u696d\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306e\u4f5c\u6210\n\n$ sudo mkdir /var/docker\n$ sudo chown core:core /var/docker\n$ cd /var/docker\n\n\nDockerfile\u3067nginx\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3066index.html\u3092\u4f5c\u6210\n\n\nDockerfile\nFROM ubuntu\n\nMAINTAINER onishi <-----@gmail.com>\n\nRUN apt-get install -y nginx\nRUN echo \"hogehoge\" > /usr/share/nginx/html/index.html\n\n\n\nbuild\n\n$ docker build -t [username]/hogehoge_nginx ./\n\n\ndocker\u8d77\u52d5\u3068\u30c6\u30b9\u30c8\n\n$ docker run -d -p 49100:80 --name hogehoge_nginx [username]/hogehoge_nginx /usr/sbin/nginx -g 'daemon off;' -c /etc/nginx/nginx.conf\n\n$ curl http://127.0.0.1:49100\nhogehoge\n\n\n\u78ba\u8a8d\u3067\u304d\u305f\u306e\u3067stop\u3057\u3066\u304a\u304f\n\ndocker stop hogehoge_nginx\n\n\nDocker Hub\u306bPush\u3059\u308b\n\nDocker Hub\u306e\u30a2\u30ab\u30a6\u30f3\u30c8\u60c5\u5831\u3092\u5165\u529b\u3057\u3066Push\u3059\u308b\n\n$ docker push [username]/hogehoge_nginx\nThe push refers to a repository [username/hogehoge_nginx] (len: 1)\nSending image list\n\nPlease login prior to push:\nUsername: [username]\nPassword:\nEmail: -------@gmail.com\nLogin Succeeded\n\n\nDocker Hub\u3067\u30ea\u30dd\u30b8\u30c8\u30ea\u3067\u304d\u3066\u3044\u308b\u306e\u3092\u78ba\u8a8d\u3067\u304d\u305f\u3089\u5b8c\u4e86\n\n\n\u5225\u306e\u4eee\u60f3\u74b0\u5883\u3067\u5148\u307b\u3069\u306e\u30a4\u30e1\u30fc\u30b8\u3092\u30c6\u30b9\u30c8\u3059\u308b\n\u5148\u307b\u3069\u306e\u74b0\u5883\u3068\u306f\u5225\u306b\u65b0\u3057\u3044\u30b5\u30fc\u30d0\u5185\u3067\u5b9f\u884c\u3059\u308b\u3053\u3068\n\n\u30a4\u30e1\u30fc\u30b8\u306e\u691c\u7d22\n\n\n\u5148\u307b\u3069\u767b\u9332\u3057\u305f\u30a4\u30e1\u30fc\u30b8\u304c\u5f15\u3063\u304b\u304b\u308b\n\n\n\n$ docker search hogehoge_nginx\nNAME                       DESCRIPTION   STARS     OFFICIAL   AUTOMATED\n[username]/hogehoge_nginx                 0\n\n\n\u30a4\u30e1\u30fc\u30b8\u3092\u6301\u3063\u3066\u304f\u308b\n\n$ docker pull [username]/hogehoge_nginx\n\n\n\u30b3\u30f3\u30c6\u30ca\u8d77\u52d5\n\n$ docker run -d -p 49100:80 --name hogehoge_nginx [username]/hogehoge_nginx /usr/sbin/nginx -g 'daemon off;' -c /etc/nginx/nginx.conf\n\n$ curl http://127.0.0.1:49100\nhogehoge\n\n\u30a2\u30af\u30bb\u30b9\u3067\u304d\u308b\u306e\u304c\u78ba\u8a8d\u3067\u304d\u305f\n\netcd + fleet\u3092\u4f7f\u7528\u3057\u3066EC2\u3067\u8d77\u52d5\n\netcd\u306fdiscovery.etcd.io\u3092\u4f7f\u3046\n\n$ curl -w \"\\n\" https://discovery.etcd.io/new\nhttps://discovery.etcd.io/[\u767a\u884c\u3055\u308c\u305ftoken]\n\n\n\nCoreOS\u306e\u30a4\u30e1\u30fc\u30b8\u306f\u3053\u3053\u304b\u3089\u9078\u3076\n\nhttps://coreos.com/docs/running-coreos/cloud-providers/ec2/\n\n\n\u666e\u6bb5\u7acb\u3061\u4e0a\u3052\u308b\u306e\u3068\u307b\u307c\u540c\u3058\u3060\u304c2\u70b9\u5909\u66f4\u3059\u308b\u3068\u3053\u308d\u304c\u3042\u308b\n\nSecurity Group\u306eInbound\u306b\u6240\u5c5e\u3059\u308bSecurity Group\u304b\u3089\u306e4001\u30687001\u3092\u958b\u3051\u308b\n\nsg-12345678\u3060\u3063\u305f\u5834\u5408\u306fsg-12345678\u304b\u3089\u306e4001\u30687001\u3092\u958b\u3051\u3066\u304a\u304f\n\n\netcd\u3067\u4f7f\u7528\u3059\u308b\n\n\n\n\nuser-data\u3092\u5909\u66f4\u3059\u308b\n\n\nuser-data\n#cloud-config\n\ncoreos:\n  etcd:\n    discovery: https://discovery.etcd.io/[\u767a\u884c\u3055\u308c\u305ftoken]\n    addr: $private_ipv4:4001\n    peer-addr: $private_ipv4:7001\n  units:\n    - name: etcd.service\n      command: start\n    - name: fleet.service\n      command: start\n    - name: docker.service\n      command: start\n\n\n\nfleet\u3092\u4f7f\u7528\u3057\u3066Docker\u8d77\u52d5\n\nec2\u306b\u30ed\u30b0\u30a4\u30f3\u3057\u3066fleet\u304c\u6b63\u5e38\u306b\u52d5\u3044\u3066\u3044\u308b\u304b\u78ba\u8a8d\n\n$ ssh core@54.64.109.XXX\nCoreOS (stable)\ncore@ip-XXX-XXX-XXX-XXX ~ $\n\n$ fleetctl list-machines\nMACHINE     IP      METADATA\n125eXXXX... XXX-XXX-XXX-XXX -\n\n\nhogehoge_nginx\u3092\u8d77\u52d5\u3059\u308b\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u66f8\u304f\n\n\nhogehoge_nginx.service\n[Unit]\nDescription=My hogehoge nginx\nAfter=docker.service\nRequires=docker.service\n\n[Service]\nExecStartPre=/usr/bin/docker pull [username]/hogehoge_nginx\nExecStart=/usr/bin/docker run --rm=false --name hogehoge_nginx -p 49100:80 [username]/hogehoge_nginx /usr/sbin/nginx -g 'daemon off;' -c /etc/nginx/nginx.conf\nExecStop=/usr/bin/docker stop hogehoge_nginx ; /usr/bin/docker rm hogehoge_nginx\n\n\n\nfleet\u306b\u30b9\u30af\u30ea\u30d7\u30c8\u767b\u9332\u3057\u3066\u958b\u59cb\u3059\u308b\n\n$ fleetctl submit ./hogehoge_nginx.service\n$ fleetctl start hogehoge_nginx.service\n$ curl http://localhost:49100\nhogehoge\n\n\n\u505c\u6b62\u3059\u308b\u6642\n\nfleetctl stop hogehoge_nginx.service\n\n\n\u30a4\u30e1\u30fc\u30b8\u3092\u66f4\u65b0\u3059\u308b\n\n\u65b0\u3057\u3044Dockerfile\n\n\nDockerfile\nFROM [\u30e6\u30fc\u30b6\u30fc\u540d]/hogehoge_nginx\n\nMAINTAINER onishi <-----@gmail.com>\n\nRUN apt-get install -y nginx\nRUN echo \"fugafuga\" >> /usr/share/nginx/html/index.html\n\n\n\nbuild\n\n$ docker build -t [username]/hogehoge_nginx ./\n\n\npush\n\n$ docker push [username]/hogehoge_nginx\n\n\nfleet\u3092\u4f7f\u3063\u3066EC2\u306e\u30b3\u30f3\u30c6\u30ca\u3092\u66f4\u65b0\u3059\u308b\n\n\u3055\u304d\u307b\u3069\u306ehogehoge_nginx.service\u3092\u4f7f\u3046\n\n$ fleetctl start hogehoge_nginx.service\n$ curl http://localhost:49100\nhogehoge\nfugafuga\n\n\n\u307e\u3068\u3081\n\n\u30c7\u30d7\u30ed\u30a4\u65b9\u6cd5\u306f\u691c\u8a0e\u3059\u308b\u5fc5\u8981\u3042\u308a\n\u6b21\u56de\u3042\u305f\u308a\u3067X-Fleet\u306b\u89e6\u308c\u305f\u3044\n\n# EC2 + CoreOS + Docker\u3067\u30b3\u30f3\u30c6\u30ca\u4f5c\u6210\u304b\u3089\u30c7\u30d7\u30ed\u30a4\u307e\u3067\n\n## \u3053\u306e\u8a18\u4e8b\u3067\u3084\u3063\u3066\u3044\u308b\u3053\u3068\n- \u30b3\u30f3\u30c6\u30ca\u3092\u4f5c\u3063\u3066HTTP\u3067\u30a2\u30af\u30bb\u30b9\u78ba\u8a8d\u3059\u308b\n- Docker Hub\u306bPush\u3059\u308b\n- \u5225\u306e\u4eee\u60f3\u74b0\u5883\u3067\u5148\u307b\u3069\u306e\u30a4\u30e1\u30fc\u30b8\u3092\u30c6\u30b9\u30c8\u3059\u308b\n- etcd + fleet\u3092\u4f7f\u7528\u3057\u3066EC2\u3067\u8d77\u52d5\n- fleet\u3092\u4f7f\u7528\u3057\u3066Docker\u8d77\u52d5\n- \u30a4\u30e1\u30fc\u30b8\u3092\u66f4\u65b0\u3059\u308b\n- fleet\u3092\u4f7f\u3063\u3066EC2\u306e\u30b3\u30f3\u30c6\u30ca\u3092\u66f4\u65b0\u3059\u308b\n\n## \u30b3\u30f3\u30c6\u30ca\u3092\u4f5c\u3063\u3066HTTP\u3067\u30a2\u30af\u30bb\u30b9\u78ba\u8a8d\u3059\u308b\n\u307e\u305a\u306f\u958b\u767a\u74b0\u5883\u3067\u30b3\u30f3\u30c6\u30ca\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n- \u4f5c\u696d\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306e\u4f5c\u6210\n\n```bash:\n$ sudo mkdir /var/docker\n$ sudo chown core:core /var/docker\n$ cd /var/docker\n```\n\n- Dockerfile\u3067nginx\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3066index.html\u3092\u4f5c\u6210\n\n```bash:Dockerfile\nFROM ubuntu\n\nMAINTAINER onishi <-----@gmail.com>\n\nRUN apt-get install -y nginx\nRUN echo \"hogehoge\" > /usr/share/nginx/html/index.html\n```\n\n- build\n\n```\n$ docker build -t [username]/hogehoge_nginx ./\n```\n\n- docker\u8d77\u52d5\u3068\u30c6\u30b9\u30c8\n\n```\n$ docker run -d -p 49100:80 --name hogehoge_nginx [username]/hogehoge_nginx /usr/sbin/nginx -g 'daemon off;' -c /etc/nginx/nginx.conf\n\n$ curl http://127.0.0.1:49100\nhogehoge\n```\n\n- \u78ba\u8a8d\u3067\u304d\u305f\u306e\u3067stop\u3057\u3066\u304a\u304f\n\n```bash:\ndocker stop hogehoge_nginx\n```\n\n## Docker Hub\u306bPush\u3059\u308b\n- Docker Hub\u306e\u30a2\u30ab\u30a6\u30f3\u30c8\u60c5\u5831\u3092\u5165\u529b\u3057\u3066Push\u3059\u308b\n\n```bash:\n$ docker push [username]/hogehoge_nginx\nThe push refers to a repository [username/hogehoge_nginx] (len: 1)\nSending image list\n\nPlease login prior to push:\nUsername: [username]\nPassword:\nEmail: -------@gmail.com\nLogin Succeeded\n```\n\n- Docker Hub\u3067\u30ea\u30dd\u30b8\u30c8\u30ea\u3067\u304d\u3066\u3044\u308b\u306e\u3092\u78ba\u8a8d\u3067\u304d\u305f\u3089\u5b8c\u4e86\n\n## \u5225\u306e\u4eee\u60f3\u74b0\u5883\u3067\u5148\u307b\u3069\u306e\u30a4\u30e1\u30fc\u30b8\u3092\u30c6\u30b9\u30c8\u3059\u308b\n\u5148\u307b\u3069\u306e\u74b0\u5883\u3068\u306f\u5225\u306b\u65b0\u3057\u3044\u30b5\u30fc\u30d0\u5185\u3067\u5b9f\u884c\u3059\u308b\u3053\u3068\n\n- \u30a4\u30e1\u30fc\u30b8\u306e\u691c\u7d22\n\t- \u5148\u307b\u3069\u767b\u9332\u3057\u305f\u30a4\u30e1\u30fc\u30b8\u304c\u5f15\u3063\u304b\u304b\u308b\n\n```bash:\n$ docker search hogehoge_nginx\nNAME                       DESCRIPTION   STARS     OFFICIAL   AUTOMATED\n[username]/hogehoge_nginx                 0\n```\n\n- \u30a4\u30e1\u30fc\u30b8\u3092\u6301\u3063\u3066\u304f\u308b\n\n```\n$ docker pull [username]/hogehoge_nginx\n```\n\n- \u30b3\u30f3\u30c6\u30ca\u8d77\u52d5\n\n```bash:\n$ docker run -d -p 49100:80 --name hogehoge_nginx [username]/hogehoge_nginx /usr/sbin/nginx -g 'daemon off;' -c /etc/nginx/nginx.conf\n\n$ curl http://127.0.0.1:49100\nhogehoge\n```\n\n\u30a2\u30af\u30bb\u30b9\u3067\u304d\u308b\u306e\u304c\u78ba\u8a8d\u3067\u304d\u305f\n\n## etcd + fleet\u3092\u4f7f\u7528\u3057\u3066EC2\u3067\u8d77\u52d5\n- etcd\u306fdiscovery.etcd.io\u3092\u4f7f\u3046\n\n```bash:\n$ curl -w \"\\n\" https://discovery.etcd.io/new\nhttps://discovery.etcd.io/[\u767a\u884c\u3055\u308c\u305ftoken]\n```\n\n- CoreOS\u306e\u30a4\u30e1\u30fc\u30b8\u306f\u3053\u3053\u304b\u3089\u9078\u3076\n> https://coreos.com/docs/running-coreos/cloud-providers/ec2/\n\n- \u666e\u6bb5\u7acb\u3061\u4e0a\u3052\u308b\u306e\u3068\u307b\u307c\u540c\u3058\u3060\u304c2\u70b9\u5909\u66f4\u3059\u308b\u3068\u3053\u308d\u304c\u3042\u308b\n\n- Security Group\u306eInbound\u306b\u6240\u5c5e\u3059\u308bSecurity Group\u304b\u3089\u306e4001\u30687001\u3092\u958b\u3051\u308b\n\t- sg-12345678\u3060\u3063\u305f\u5834\u5408\u306fsg-12345678\u304b\u3089\u306e4001\u30687001\u3092\u958b\u3051\u3066\u304a\u304f\n\t\t- etcd\u3067\u4f7f\u7528\u3059\u308b\n\n- user-data\u3092\u5909\u66f4\u3059\u308b\n\n```bash:user-data\n#cloud-config\n\ncoreos:\n  etcd:\n    discovery: https://discovery.etcd.io/[\u767a\u884c\u3055\u308c\u305ftoken]\n    addr: $private_ipv4:4001\n    peer-addr: $private_ipv4:7001\n  units:\n    - name: etcd.service\n      command: start\n    - name: fleet.service\n      command: start\n    - name: docker.service\n      command: start\n```\n\n## fleet\u3092\u4f7f\u7528\u3057\u3066Docker\u8d77\u52d5\n\n- ec2\u306b\u30ed\u30b0\u30a4\u30f3\u3057\u3066fleet\u304c\u6b63\u5e38\u306b\u52d5\u3044\u3066\u3044\u308b\u304b\u78ba\u8a8d\n\n```bash:\n$ ssh core@54.64.109.XXX\nCoreOS (stable)\ncore@ip-XXX-XXX-XXX-XXX ~ $\n\n$ fleetctl list-machines\nMACHINE\t\tIP\t\tMETADATA\n125eXXXX...\tXXX-XXX-XXX-XXX\t-\n```\n\n- hogehoge_nginx\u3092\u8d77\u52d5\u3059\u308b\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u66f8\u304f\n\n```bash:hogehoge_nginx.service\n[Unit]\nDescription=My hogehoge nginx\nAfter=docker.service\nRequires=docker.service\n\n[Service]\nExecStartPre=/usr/bin/docker pull [username]/hogehoge_nginx\nExecStart=/usr/bin/docker run --rm=false --name hogehoge_nginx -p 49100:80 [username]/hogehoge_nginx /usr/sbin/nginx -g 'daemon off;' -c /etc/nginx/nginx.conf\nExecStop=/usr/bin/docker stop hogehoge_nginx ; /usr/bin/docker rm hogehoge_nginx\n```\n\n- fleet\u306b\u30b9\u30af\u30ea\u30d7\u30c8\u767b\u9332\u3057\u3066\u958b\u59cb\u3059\u308b\n\n```bash:\n$ fleetctl submit ./hogehoge_nginx.service\n$ fleetctl start hogehoge_nginx.service\n$ curl http://localhost:49100\nhogehoge\n```\n\n- \u505c\u6b62\u3059\u308b\u6642\n\n```bash:\nfleetctl stop hogehoge_nginx.service\n```\n\n## \u30a4\u30e1\u30fc\u30b8\u3092\u66f4\u65b0\u3059\u308b\n- \u65b0\u3057\u3044Dockerfile\n\n```bash:Dockerfile\nFROM [\u30e6\u30fc\u30b6\u30fc\u540d]/hogehoge_nginx\n\nMAINTAINER onishi <-----@gmail.com>\n\nRUN apt-get install -y nginx\nRUN echo \"fugafuga\" >> /usr/share/nginx/html/index.html\n```\n\n- build\n\n```bash:\n$ docker build -t [username]/hogehoge_nginx ./\n```\n\n- push\n\n```bash:\n$ docker push [username]/hogehoge_nginx\n```\n\n## fleet\u3092\u4f7f\u3063\u3066EC2\u306e\u30b3\u30f3\u30c6\u30ca\u3092\u66f4\u65b0\u3059\u308b\n\n- \u3055\u304d\u307b\u3069\u306ehogehoge_nginx.service\u3092\u4f7f\u3046\n\n```bash:\n$ fleetctl start hogehoge_nginx.service\n$ curl http://localhost:49100\nhogehoge\nfugafuga\n```\n\n## \u307e\u3068\u3081\n- \u30c7\u30d7\u30ed\u30a4\u65b9\u6cd5\u306f\u691c\u8a0e\u3059\u308b\u5fc5\u8981\u3042\u308a\n- \u6b21\u56de\u3042\u305f\u308a\u3067X-Fleet\u306b\u89e6\u308c\u305f\u3044\n", "tags": ["docker", "CoreOS"]}