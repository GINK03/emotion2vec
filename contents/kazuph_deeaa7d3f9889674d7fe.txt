{"context": " More than 1 year has passed since last update.\n\n\u6226\u7565\n\nRails\u306e\u3053\u3068\u306f\u5fd8\u308c\u308b(\u305d\u3046\u3044\u3046\u3053\u3068\u3082\u3042\u308b\u3088)\ncap\u3092\u30b5\u30fc\u30d0\u30fc\u306bssh\u3067\u30b3\u30de\u30f3\u30c9\u3092\u9001\u308a\u8fbc\u3080rake task\u306e\u584a\u3068\u898b\u308b\n\u300c\u3068\u3042\u308b\u5f79\u5272\u306e\u30b5\u30fc\u30d0\u30fc\u300d\u306b\u5bfe\u3057\u3066\u300c\u3068\u3042\u308b\u51e6\u7406\u300d\u3092\u5b9f\u884c\u3057\u3066\u56de\u308a\u305f\u3044\u3001\u3068\u3044\u3046\u5834\u5408\u3092\u60f3\u5b9a\n\n\n\u5358\u306brestart\u3060\u3051\u5207\u308a\u51fa\u3057\u3066\u5b9f\u884c\u3059\u308b\u3068\u304b\u3001\u3042\u308b\u30b3\u30de\u30f3\u30c9\u306e\u7d50\u679c\u3060\u3051\u624b\u306b\u5165\u308c\u308b\u3068\u304b\n\n\n\u500b\u4eba\u7684\u306b\u306fansible\u3067\u3082\u3067\u304d\u308b\u3068\u601d\u3063\u305f\u3051\u3069ruby\u30e1\u30f3\u30d0\u30fc\u306b\u5f37\u8981\u3067\u304d\u306a\u3044\u3057\u3001\u5c0f\u56de\u308a\u52b9\u304b\u305b\u305f\u3044\n\n\n\u6e96\u5099\n$ bundle init\n$ echo gem \"capistrano\" >> Gemfile\n$ bundle install\n$ cap install\n\n\u3061\u306a\u307f\u306bversion\u306f\u3001\n$ cap -V\nCapistrano Version: 3.2.1 (Rake Version: 10.3.2)\n\n\u3053\u3053\u307e\u3067\u3084\u308b\u3068\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u69cb\u6210\u306b\u306a\u308b\n$ tree\n.\n\u251c\u2500\u2500 Capfile\n\u251c\u2500\u2500 Gemfile\n\u251c\u2500\u2500 Gemfile.lock\n\u251c\u2500\u2500 config\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 deploy\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 production.rb\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2514\u2500\u2500 staging.rb\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 deploy.rb\n\u2514\u2500\u2500 lib\n    \u2514\u2500\u2500 capistrano\n            \u2514\u2500\u2500 tasks\n\n\u3061\u3087\u3063\u3068\u3057\u305f\u89e3\u8aac\n\nCapfile\u306frequire\u306a\u3069\u306e\u8a2d\u5b9a\u3068lib\u4ee5\u4e0b\u306etask\u306e\u8aad\u307f\u8fbc\u307f\u306b\u4f7f\u3046\nconfig/deploy.rb\u306b\u306f\u5168\u30b9\u30c6\u30fc\u30b8\u5171\u901a\u306e\u8a2d\u5b9a\u3092\u66f8\u304f\nproduction.rb\u3068\u304bstating.rb\u306b\u5404\u30b9\u30c6\u30fc\u30b8\u306e\u8a2d\u5b9a\u3092\u66f8\u304f\n\n\n\u30b5\u30fc\u30d0\u30fc\u306eIP\u3084\u3001\u5c02\u7528task\u3068\u304b\n\n\nlib/capistrano/tasks\u306e\u4e0b\u306b\u306f\u30aa\u30ea\u30b8\u30ca\u30eb\u306etask\u3092\u8ffd\u52a0\u3057\u305f\u3044\u3068\u304d\u306b\u4f7f\u3046\n\n\ndeploy.rb\u3092\u6700\u4f4e\u9650\u306e\u8a2d\u5b9a\u306b\u3059\u308b\n\nconfig/deploy.rb\nlock '3.2.1'\n# set :pty, true\n\n\n\u672c\u5f53\u306b\u5168\u90e8\u6d88\u3057\u3066\u3068\u308a\u307e\u3053\u308c\u3060\u3051\u306b\u3057\u3066\u307f\u305f\u3002\n\u203b\u5f8c\u8ff0\u3059\u308b\u3051\u3069sudo\u4f7f\u3044\u305f\u3044\u306a\u3089pty\u3092\u6709\u52b9\u306b\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\n\n\u30b9\u30c6\u30fc\u30b8\u3092\u5897\u3084\u3059\n\u4eca\u56de\u8a66\u3059\u5834\u6240\u304c\u958b\u767a\u30b5\u30fc\u30d0\u30fc\u306a\u306e\u3067\u3001dev.rb\u3092\u306f\u3084\u3057\u3066\u307f\u308b\u3002development\u3067\u3082\u3044\u3044\u3068\u601d\u3046\u3002\n\u2514\u2500- config\n   \u2514\u2500\u2500 deploy\n       \u251c\u2500\u2500 production.rb\n       \u251c\u2500\u2500 staging.rb\n       \u2514\u2500\u2500 dev.rb\n\n\nconfig/deploy/dev.rb\nrole :app,  %w{hoge@example.com}\n\n\n\u3053\u308c\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u30b9\u30c6\u30fc\u30b8\u3092\u6307\u5b9a\u3067\u304d\u308b\u3053\u3068\u3092\u610f\u5473\u3059\u308b\u3002\n$ cap dev YOUR_TASK_NAME\n\n\n\u30aa\u30ea\u30b8\u30ca\u30eb\u30bf\u30b9\u30af\u3092\u8ffd\u52a0\u3057\u3066\u307f\u308b\n\u30df\u30cb\u30de\u30e0\u3067\u8a66\u3059\u306a\u3089\u3001\u305d\u306e\u307e\u307edev.rb\u306b\u66f8\u3044\u3066\u3057\u307e\u3046\u3002\n\nconfig/deploy/dev.rb\nrole :app, %w{hoge@example.com}\ntask :ls do\n  on roles(:app) do\n    execute \"ls\"\n  end\nend\n\n\n\u3053\u308c\u3067\u3001\n\n\nhoge@example.com\u3067\u30ed\u30b0\u30a4\u30f3\u3067\u304d\u308bapp\u3068\u3044\u3046\u5f79\u5272\u306e\u30b5\u30fc\u30d0\u30fc\u3092\u5b9a\u7fa9\n\n\n(\u8907\u6570\u66f8\u304f\u306a\u3089\u30b9\u30da\u30fc\u30b9\u533a\u5207\u308a\u3067\u5897\u3084\u305b\u3070\u3044\u3044)\n\n\napp\u306b\u5bfe\u3057\u3066\u306e\u307fls\u3092\u5b9f\u884c\u3059\u308b:ls\u3068\u3044\u3046\u30bf\u30b9\u30af\u3092\u5b9a\u7fa9\n\n\u3057\u305f\u3053\u3068\u306b\u306a\u308b\u3002\n\u5b9f\u884c\u3057\u3066\u307f\u308b\u3002\n$ bundle exec cap dev ls\n\nINFO[6a60919c] Running /usr/bin/env ls on example.com\nDEBUG[6a60919c] Command: /usr/bin/env ls\nDEBUG[6a60919c]         <<\u3053\u3053\u306b\u30d5\u30a1\u30a4\u30eb\u4e00\u89a7\u304c\u8868\u793a\u3055\u308c\u308b>>\nINFO[6a60919c] Finished in 1.851 seconds with exit status 0 (successful).\n\n\u30bf\u30b9\u30af\u3092\u5897\u3084\u3059\u306a\u3089namespace\u3092\u4ed8\u3051\u305f\u65b9\u304c\u3042\u3068\u3042\u3068\u898b\u901a\u3057\u304c\u826f\u304f\u306a\u308b\u3002\n\nconfig/deploy/dev.rb\nnamespace :utils do\n  task :ls do\n    on roles(:app) do\n      execute \"ls\"\n    end\n  end\n  task :perl_version do\n    on roles(:app) do\n      execute %[perl -v]\n    end\n  end\nend\n\n\n\u5b9f\u884c\u3057\u3066\u307f\u308b\u3002namespace:task_name\u3068\u3044\u3046\u3088\u3046\u306b\u8a18\u8ff0\u3059\u308b\u3002\n$ bundle exec cap dev utils:perl_version\n\nINFO[444094bb] Running /usr/bin/env perl -v on +HFOWFLWKEJF+WLEHF\nDEBUG[444094bb] Command: perl -v\nDEBUG[444094bb]\nDEBUG[444094bb]         This is perl, v5.10.1 (*) built for x86_64-linux-thread-multi\nDEBUG[444094bb]\nDEBUG[444094bb]         Copyright 1987-2009, Larry Wall\nDEBUG[444094bb]\nDEBUG[444094bb]         Perl may be copied only under the terms of either the Artistic License or the\nDEBUG[444094bb]         GNU General Public License, which may be found in the Perl 5 source kit.\nDEBUG[444094bb]\nDEBUG[444094bb]         Complete documentation for Perl, including FAQ lists, should be found on\nDEBUG[444094bb]         this system using \"man perl\" or \"perldoc perl\".  If you have access to the\nDEBUG[444094bb]         Internet, point your browser at http://www.perl.org/, the Perl Home Page.\nDEBUG[444094bb]\nINFO[444094bb] Finished in 1.874 seconds with exit status 0 (successful).\n\n\n\u6c7a\u307e\u3063\u305f\u584a\u3067lib\u4ee5\u4e0b\u306b\u79fb\u3059\n\u5927\u304d\u304f\u306a\u3063\u305f\u3089lib/capistrano/tasks\u306b\u79fb\u305b\u3070\u3044\u3044\nlib/capistrano/tasks/utils.rake\u3068\u3044\u3046\u306e\u3092\u3064\u304f\u3063\u3066\u307f\u308b\u3002\n\nlib/capistrano/tasks/utils.rake\nnamespace :utils do\n  task :ls do\n    on roles(:app) do\n      execute \"ls\"\n    end\n  end\n  task :perl_version do\n    on roles(:app) do\n      execute %[perl -v]\n    end\n  end\nend\n\n\nnamespace\u306e\u30d6\u30ed\u30c3\u30af\u3092\u307e\u308b\u3054\u3068\u30b3\u30d4\u30da\u3067\u3044\u3044\u3002\u5b9f\u884c\u306e\u3084\u308a\u304b\u305f\u3082\u5909\u308f\u3089\u306a\u3044\u3002\n$ bundle exec cap dev utils:perl_version\n\nINFO[444094bb] Running /usr/bin/env perl -v on LHFWLKEFJWEFJ\nDEBUG[444094bb] Command: perl -v\nDEBUG[444094bb]\nDEBUG[444094bb]         This is perl, v5.10.1 (*) built for x86_64-linux-thread-multi\nDEBUG[444094bb]\nDEBUG[444094bb]         Copyright 1987-2009, Larry Wall\nDEBUG[444094bb]\nDEBUG[444094bb]         Perl may be copied only under the terms of either the Artistic License or the\nDEBUG[444094bb]         GNU General Public License, which may be found in the Perl 5 source kit.\nDEBUG[444094bb]\nDEBUG[444094bb]         Complete documentation for Perl, including FAQ lists, should be found on\nDEBUG[444094bb]         this system using \"man perl\" or \"perldoc perl\".  If you have access to the\nDEBUG[444094bb]         Internet, point your browser at http://www.perl.org/, the Perl Home Page.\nDEBUG[444094bb]\nINFO[444094bb] Finished in 1.874 seconds with exit status 0 (successful).\n\n\u3053\u308c\u3067dev.rb\u306e\u4e2d\u306b\u306f\u30b5\u30fc\u30d0\u30fc\u306e\u60c5\u5831\u3060\u3051\u8a18\u8ff0\u3055\u308c\u308b\u3060\u3051\u306b\u306a\u308b\u306e\u3067\u3001\u30b7\u30f3\u30d7\u30eb\u306b\u306a\u308b\u3002\n\n\u74b0\u5883\u5909\u6570\u3092\u6e21\u3057\u3066\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3059\u308b\nbundle exec cap dev utils:echo user_name=kazuph\n\n\u3068\u304b\u3084\u3063\u3066\u3001\u5916\u304b\u3089\u81ea\u7531\u306b\u5024\u3092\u6e21\u305b\u308b\u3002\n\nlib/capistrano/tasks/utils.rake\n...\n  task :echo do\n    set :user_name, ENV[\"user_name\"] || raise(\"\u30e6\u30fc\u30b6\u30fc\u540d\u5fc5\u9808\")\n    on roles(:app) do\n      execute \"echo #{fetch(:user_name)}\"\n    end\n  end\n\n\nENV\u3067\u53d7\u3051\u53d6\u3063\u3066\u3001set\u3059\u308c\u3070fetch\u3067\u53d6\u308c\u308b(\u4f7f\u308f\u306a\u3044\u3067\u305d\u306e\u307e\u307eENV\u3064\u3063\u3053\u3093\u3067\u3082\u3044\u3044)\u3002\n\n\u5b9f\u884c\u6642\u306b\u30e6\u30fc\u30b6\u30fc\u306b\u5165\u529b\u3055\u305b\u308b\n\u5bfe\u8a71\u5f0f\u3067\u5165\u529b\u3055\u305b\u3066\u3082\u3044\u3044\u3002\n\nlib/capistrano/tasks/utils.rake\n...\n\n  task :echo do\n    ask(:user_name, nil) ## \u3053\u3053\u3067\u805e\u3044\u3066\u308b\n    on roles(:app) do\n      execute \"echo #{fetch(:user_name) || raise(\"\u30e6\u30fc\u30b6\u30fc\u540d\u306f\u5fc5\u9808\u3060\u3088\u3093\u2606\")}\"\n    end\n  end\n\n\n\u5b9f\u884c\u3059\u308b\u3002\n$ bundle exec cap dev utils:echo\nPlease enter user_name (): kazuph\nINFO[62046886] Running /usr/bin/env echo kazuph on example.com\nDEBUG[62046886] Command: echo kazuph\nINFO[62046886] Finished in 2.086 seconds with exit status 0 (successful).\nDEBUG[62046886]         kazuph\nINFO[62046886] Finished in 2.086 seconds with exit status 0 (successful).\n\nask\u306e\u30c7\u30d5\u30a9\u5024\u3092\u7b2c\u4e8c\u5f15\u6570\u3067nil\u306b\u3059\u308b\u3053\u3068\u306b\u3088\u3063\u3066\u3001fetch\u306e\u8fd4\u308a\u5024\u304cnil\u306a\u306e\u3067\u3001raise\u3059\u308b\u3068\u3044\u3046\u4ed5\u7d44\u307f\u3002\u3082\u3063\u3068\u3044\u3044\u65b9\u6cd5\u304c\u3042\u3063\u305f\u3089\u6559\u3048\u3066\u304f\u3060\u3055\u3044\u3002\n\n\u4ed6\u306e\u30bf\u30b9\u30af\u3092\u307e\u3068\u3081\u3066\u5b9f\u884c\u3059\u308b\ninvoke\u3067\u3067\u304d\u308b\u3002namespace\u306f\u5fc5\u9808\u3002\nrestart\u3068\u304b\u304c\u308f\u304b\u308a\u3084\u3059\u3044\u3067\u3059\u304b\u306d\u3002\n\nlib/capistrano/tasks/utils.rake\n...\n  task :restart do\n    on roles(:app) do\n      invoke \"utils:restart_nginx\"\n      invoke \"utils:restart_app\"\n      invoke \"utils:restart_mysql\"\n    end\n  end\n  task :restart_nginx do\n    on roles(:app) do\n      execute \"sudo /etc/init.d/nginx restart\"\n    end\n  end\n  task :restart_app do\n    on roles(:app) do\n      execute \"sudo supervisorctl restart all\"\n    end\n  end\n  task :restart_mysql do\n    on roles(:app) do\n      execute \"sudo /etc/init.d/mysql restart\"\n    end\n  end\n\n\n\u203b\u3061\u306a\u307f\u306bsudo\u304c\u5931\u6557\u3059\u308b\u3068\u304d\u306e\u3053\u3068\u306f\u5f8c\u8ff0\n\n\u9023\u9396\u7684\u306b\u30bf\u30b9\u30af\u3092\u5b9f\u884c\u3059\u308b\n\u25ef\u25ef\u306e\u51e6\u7406\u306e\u3042\u3068\u306b\u25ef\u25ef\u3001\u307f\u305f\u3044\u306a\u3068\u304d\u3002\n:add_user\u306e\u3042\u3068\u306b:enable_ssh_login\u3092\u3084\u3063\u3066\u308b\u3051\u3069\u3001:enable_ssh_login\u3082\u5358\u4f53\u3067\u5b9f\u884c\u3059\u308b\u3053\u3068\u3092\u8003\u616e\u3059\u308b\u3068\u3053\u3046\u306a\u308b\u3002\n\nlib/capistrano/tasks/utils.rake\n  task :add_user do\n    fetch(:user_name) || ask(:user_name, nil)\n    on roles(:app) do\n      user_name = fetch(:user_name) || raise(\"\u30e6\u30fc\u30b6\u30fc\u540d\u306f\u5fc5\u9808\")\n      execute %[useradd {user_name}]\n      invoke \"utils:enable_ssh_login\"\n    end\n  end\n  task :enable_ssh_login do\n    fetch(:user_name) || ask(:user_name, nil)\n    on roles(:app) do\n      user_name = fetch(:user_name) || raise(\"\u30e6\u30fc\u30b6\u30fc\u540d\u306f\u5fc5\u9808\")\n      execute %[mkdir -p /home/#{user_name}/.ssh]\n      execute %[cp /root/.ssh/authorized_keys /home/#{user_name}/.ssh/]\n      execute %[chmod 700 /home/#{user_name}/.ssh]\n      execute %[chmod 600 /home/#{user_name}/.ssh/authorized_keys]\n      execute %[chown -R #{user_name}.#{user_name} /home/#{user_name}/.ssh]\n    end\n  end\n\n\n\u307e\u305afetch\u3057\u3066nil\u306a\u3089ask\u3059\u308b\u3002\u3053\u308c\u306a\u3089\u3001invoke\u5148\u306eask\u306f\u5b9f\u884c\u3055\u308c\u306a\u3044\u4ed5\u7d44\u307f\u3002\u4fbf\u5229\u3002\n\nsudo\u304c\u5931\u6557\u3059\u308b\nINFO[29ab7cc8] Running /usr/bin/env sudo whoami on +LHKFlkL+FHLEWJF\nDEBUG[29ab7cc8] Command: sudo whoami\nDEBUG[29ab7cc8]         sudo\nDEBUG[29ab7cc8]         :\nDEBUG[29ab7cc8]         sudo \u3092\u5b9f\u884c\u3059\u308b\u306b\u306f tty \u304c\u306a\u3051\u308c\u3070\u3044\u3051\u307e\u305b\u3093\u3002\u3059\u307f\u307e\u305b\u3093\nDEBUG[29ab7cc8]\ncap aborted!\n\n\u306a\u3093\u304b\u8b1d\u3089\u308c\u305f\u3051\u3069\u3001tty\u304c\u306a\u3044\u3068\u3060\u3081\u3068\u306e\u3053\u3068\u3002\ncap3\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u3059\u308b\u3068\u8a2d\u5b9a\u3067\u304d\u308b\u3002\n\nconfig/deploy.rb\nlock '3.2.1'\nset :pty, true\n\n\n\u3053\u308c\u3067OK\u3002\n\nsshkit\u3092\u4f7f\u3044\u3053\u306a\u3059\ncap\u306eDSL\u306eon\u3068\u304b\u306e\u90e8\u5206\u3063\u3066\u5b9f\u306fsshkit\u305d\u306e\u3082\u306e\u3002\n\u3053\u308c\u304c\u30ad\u30e2\u3002\n\u8a73\u3057\u304f\u306f\u4ee5\u4e0b\u3092\u53c2\u7167\u3068\u3046\u3044\u611f\u3058\u306a\u306e\u3067\u3059\u304c\u3001\u6b63\u76f4\u3053\u308c\u3092\u77e5\u308b\u3068\u77e5\u3089\u306a\u3044\u3068\u3067\u306f\u30b3\u30de\u30f3\u30c9\u5b9f\u884c\u306e\u30d0\u30ea\u30a8\u30fc\u30b7\u30e7\u30f3\u306b\u5927\u304d\u306a\u5f71\u97ff\u304c\u51fa\u308b\u3002\n\ncapistrano/sshkit\n\n\nhttps://github.com/capistrano/sshkit\n\n\nsshkit/EXAMPLES.md at master \u00b7 capistrano/sshkit\n\n\nhttps://github.com/capistrano/sshkit/blob/master/EXAMPLES.md\n\n\nCapistrano 3\u3078\u306e\u624b\u5f15\u304d - \u4eca\u65e5\u306e\u3054\u306f\u3093\u306f\u7d20\u9eba\u3067\u3059\n\n\nhttp://takkkun.hatenablog.com/entry/2013/10/12/Capistrano_3%E3%81%B8%E3%81%AE%E6%89%8B%E5%BC%95%E3%81%8D\n\n\n\n\u3061\u3087\u3063\u3068\u89e6\u3063\u3066\u307f\u308b\u3002\n\nlib/capistrano/tasks/utils.rake\n  task :other_whoami do\n    on roles(:app) do\n      execute :whoami\n      as :fuga do\n        execute :whoami\n      end\n    end\n  end\n\n\n\u3053\u3046\u3059\u308b\u3068\u4e00\u3064\u76ee\u306eexecute\u3060\u3068hoge, \uff12\u3064\u76ee\u306eexecute\u3067fuga\u3068\u8868\u793a\u3055\u308c\u308b\u3002\n\u3061\u306a\u307f\u306b\u5b9f\u969b\u306b\u4f7f\u7528\u3055\u308c\u308b\u30b3\u30de\u30f3\u30c9\u304c\u305d\u308c\u305e\u308c\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u308b\u3002\n# \u6700\u521d\u306eexecute\n/usr/bin/env whoami\n\n# \uff12\u3064\u76ee\u306eexecute\n/usr/bin/env if ! sudo -u fuga whoami > /dev/null; then echo \"You cannot switch to user 'fuga' using sudo, please check the sudoers file\" 1>&2; false; fi on example.com\n\n\u52c9\u5f37\u306b\u306a\u308a\u307e\u3059\u306d\u3002\n\u3042\u3068\u5b9f\u884c\u3059\u308b\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u9650\u5b9a\u3059\u308bwithin\u3068\u304b\u3001\u8907\u6570\u30db\u30b9\u30c8\u30d1\u30e9\u30ec\u30eb\u5b9f\u884c\u3059\u308b\u304b\u3001\u30b7\u30fc\u30b1\u30f3\u30b7\u30e3\u30eb\u306b\u5b9f\u884c\u3059\u308b\u304b\u3001\u9593\u9694\u3092\u4f55\u79d2\u3042\u3051\u3066\u5b9f\u884c\u3059\u308b\u3068\u304b\u3001execute\u6642\u306e\u30b3\u30de\u30f3\u30c9\u3092\u72ec\u81ea\u306b\u5b9a\u7fa9\u3059\u308b\u3068\u304b\u30a8\u30ed\u30a8\u30ed\u3067\u304d\u308b\u306e\u3067\u8a66\u3057\u3066\u307f\u308b\u3068\u3044\u3044\u3067\u3059\u3002\n\ndownload & upload\n\u5b9f\u306f\u3053\u308c\u3082sshkit\u81ea\u4f53\u306e\u6a5f\u80fd\u3067\u5b9f\u73fe\u3067\u304d\u308b\u3002\n\u307e\u305a\u306fdownload\u3002\nmaillog\u3092download\u3057\u305f\u304f\u3066\u3001\u4e00\u5ea6if\u3067\u30d5\u30a1\u30a4\u30eb\u304c\u3042\u308b\u304b\u3069\u3046\u304b\u78ba\u8a8d\u3057\u3066\u304b\u3089\u5b9f\u884c\u3057\u3066\u308b\u3002\u3053\u306e\u4f8b\u3060\u3068\u30ab\u30ec\u30f3\u30c8\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306b\u305d\u306e\u307e\u307e\u843d\u3068\u3057\u3066\u304d\u3066\u308b\u3002\n\nlib/capistrano/tasks/utils.rake\n  task :download_maillog do\n    on roles(:app) do\n      file_name = \"/var/log/maillog\"\n      if test \"[ -f #{file_name} ]\"\n        download! file_name, '.'\n      end\n    end\n  end\n\n\n\u6b21\u306fupload\u3002\n\nlib/capistrano/tasks/utils.rake\n  task :upload_dir do\n    on roles(:app) do\n      execute :mkdir, '-p', '/home/hoge/cap_sample'\n      upload! \"./Gemfile\", '/home/hoge/cap_sample/Gemfile'\n      execute :ls, '/home/hoge/cap_sample'\n    end\n  end\n\n\n\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3054\u3068upload\u3082\u3067\u304d\u308b\u3002\n\nlib/capistrano/tasks/utils.rake\n  task :upload_dir_all do\n    on roles(:app) do\n      execute :mkdir, '-p', '/home/hoge/cap_sample'\n      upload! '.', '/home/hoge/cap_sample', recursive: true\n      execute :tree, '-L 2 /home/hoge/cap_sample'\n    end\n  end\n\n\n\u697d\u3061\u3093\u266a\n\n\u307e\u3068\u3081\n\u958b\u767a\u3067\u4e00\u6642\u7684\u306b\u4f7f\u3046\u30b5\u30fc\u30d0\u30fc\u306e\u5834\u5408\u306f\u3001\u30d7\u30ed\u30d3\u30b8\u30e7\u30cb\u30f3\u30b0\u3059\u308b\u3064\u3082\u308a\u307e\u3067\u306f\u306a\u3044\u304c\u3001\u3075\u3068\u3057\u305f\u30bf\u30a4\u30df\u30f3\u30b0\u3067\u5165\u308c\u305f\u3044\u30c4\u30fc\u30eb\u3068\u304b\u3001\u4e00\u5ea6\u3060\u3051\u5b9f\u884c\u3057\u305f\u3044\u30b3\u30de\u30f3\u30c9\u304c\u3042\u308b\u3068\u304b\u3001\u305d\u3046\u3044\u3046\u3053\u3068\u306f\u305f\u304f\u3055\u3093\u3042\u308a\u305d\u3046\u3002\nansible\u306a\u3069\u306e\u30c4\u30fc\u30eb\u3092\u4f7f\u3063\u3066\u3082\u3044\u3044\u3051\u3069\u3001\u305d\u306e\u305f\u3081\u306b\u30ed\u30fc\u30eb\u3092\u66f8\u304f\u306e\u3082\u3060\u308b\u3044\u3002\u624b\u5143\u306bRuby\u306e\u74b0\u5883\u304c\u3042\u308c\u3070\u3044\u3044\u3060\u3051\u306a\u306e\u3067\u3001\u30c7\u30d7\u30ed\u30a4\u307e\u3067\u3044\u304b\u305a\u3068\u3082shell\u3067\u3084\u308a\u305f\u304f\u3082\u306a\u3044\u3053\u3068\u3092\u8a18\u8ff0\u3059\u308b\u306a\u3089cap\u306f\u3061\u3087\u3046\u3069\u3044\u3044DSL\u304b\u3082\u3057\u308c\u306a\u3044\u3002\n(\u3042\u3001\u3067\u3082ansible\u306einlinefile\u307f\u305f\u3044\u306a\u3084\u3064\u8d85\u4fbf\u5229\u3060\u306a\u3041\u2026)\n## \u6226\u7565\n\n- Rails\u306e\u3053\u3068\u306f\u5fd8\u308c\u308b(\u305d\u3046\u3044\u3046\u3053\u3068\u3082\u3042\u308b\u3088)\n- cap\u3092\u30b5\u30fc\u30d0\u30fc\u306bssh\u3067\u30b3\u30de\u30f3\u30c9\u3092\u9001\u308a\u8fbc\u3080rake task\u306e\u584a\u3068\u898b\u308b\n- \u300c\u3068\u3042\u308b\u5f79\u5272\u306e\u30b5\u30fc\u30d0\u30fc\u300d\u306b\u5bfe\u3057\u3066\u300c\u3068\u3042\u308b\u51e6\u7406\u300d\u3092\u5b9f\u884c\u3057\u3066\u56de\u308a\u305f\u3044\u3001\u3068\u3044\u3046\u5834\u5408\u3092\u60f3\u5b9a\n    - \u5358\u306brestart\u3060\u3051\u5207\u308a\u51fa\u3057\u3066\u5b9f\u884c\u3059\u308b\u3068\u304b\u3001\u3042\u308b\u30b3\u30de\u30f3\u30c9\u306e\u7d50\u679c\u3060\u3051\u624b\u306b\u5165\u308c\u308b\u3068\u304b\n- \u500b\u4eba\u7684\u306b\u306fansible\u3067\u3082\u3067\u304d\u308b\u3068\u601d\u3063\u305f\u3051\u3069ruby\u30e1\u30f3\u30d0\u30fc\u306b\u5f37\u8981\u3067\u304d\u306a\u3044\u3057\u3001\u5c0f\u56de\u308a\u52b9\u304b\u305b\u305f\u3044\n\n## \u6e96\u5099\n\n```shell-session\n$ bundle init\n$ echo gem \"capistrano\" >> Gemfile\n$ bundle install\n$ cap install\n```\n\n\u3061\u306a\u307f\u306bversion\u306f\u3001\n\n```shell-session\n$ cap -V\nCapistrano Version: 3.2.1 (Rake Version: 10.3.2)\n```\n\n\u3053\u3053\u307e\u3067\u3084\u308b\u3068\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u69cb\u6210\u306b\u306a\u308b\n\n```shell-session\n$ tree\n.\n\u251c\u2500\u2500 Capfile\n\u251c\u2500\u2500 Gemfile\n\u251c\u2500\u2500 Gemfile.lock\n\u251c\u2500\u2500 config\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 deploy\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 production.rb\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2514\u2500\u2500 staging.rb\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 deploy.rb\n\u2514\u2500\u2500 lib\n    \u2514\u2500\u2500 capistrano\n            \u2514\u2500\u2500 tasks\n```\n\n\u3061\u3087\u3063\u3068\u3057\u305f\u89e3\u8aac\n\n- Capfile\u306frequire\u306a\u3069\u306e\u8a2d\u5b9a\u3068lib\u4ee5\u4e0b\u306etask\u306e\u8aad\u307f\u8fbc\u307f\u306b\u4f7f\u3046\n- config/deploy.rb\u306b\u306f\u5168\u30b9\u30c6\u30fc\u30b8\u5171\u901a\u306e\u8a2d\u5b9a\u3092\u66f8\u304f\n- production.rb\u3068\u304bstating.rb\u306b\u5404\u30b9\u30c6\u30fc\u30b8\u306e\u8a2d\u5b9a\u3092\u66f8\u304f\n    - \u30b5\u30fc\u30d0\u30fc\u306eIP\u3084\u3001\u5c02\u7528task\u3068\u304b\n- lib/capistrano/tasks\u306e\u4e0b\u306b\u306f\u30aa\u30ea\u30b8\u30ca\u30eb\u306etask\u3092\u8ffd\u52a0\u3057\u305f\u3044\u3068\u304d\u306b\u4f7f\u3046\n\n## deploy.rb\u3092\u6700\u4f4e\u9650\u306e\u8a2d\u5b9a\u306b\u3059\u308b\n\n```ruby:config/deploy.rb\nlock '3.2.1'\n# set :pty, true\n```\n\n\u672c\u5f53\u306b\u5168\u90e8\u6d88\u3057\u3066\u3068\u308a\u307e\u3053\u308c\u3060\u3051\u306b\u3057\u3066\u307f\u305f\u3002\n\n\u203b\u5f8c\u8ff0\u3059\u308b\u3051\u3069sudo\u4f7f\u3044\u305f\u3044\u306a\u3089pty\u3092\u6709\u52b9\u306b\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\n\n## \u30b9\u30c6\u30fc\u30b8\u3092\u5897\u3084\u3059\n\n\u4eca\u56de\u8a66\u3059\u5834\u6240\u304c\u958b\u767a\u30b5\u30fc\u30d0\u30fc\u306a\u306e\u3067\u3001dev.rb\u3092\u306f\u3084\u3057\u3066\u307f\u308b\u3002development\u3067\u3082\u3044\u3044\u3068\u601d\u3046\u3002\n\n```\n\u2514\u2500- config\n   \u2514\u2500\u2500 deploy\n       \u251c\u2500\u2500 production.rb\n       \u251c\u2500\u2500 staging.rb\n       \u2514\u2500\u2500 dev.rb\n```\n\n```ruby:config/deploy/dev.rb\nrole :app,  %w{hoge@example.com}\n```\n\n\u3053\u308c\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u30b9\u30c6\u30fc\u30b8\u3092\u6307\u5b9a\u3067\u304d\u308b\u3053\u3068\u3092\u610f\u5473\u3059\u308b\u3002\n\n```shell-session\n$ cap dev YOUR_TASK_NAME\n```\n\n## \u30aa\u30ea\u30b8\u30ca\u30eb\u30bf\u30b9\u30af\u3092\u8ffd\u52a0\u3057\u3066\u307f\u308b\n\n\u30df\u30cb\u30de\u30e0\u3067\u8a66\u3059\u306a\u3089\u3001\u305d\u306e\u307e\u307edev.rb\u306b\u66f8\u3044\u3066\u3057\u307e\u3046\u3002\n\n```ruby:config/deploy/dev.rb\nrole :app, %w{hoge@example.com}\ntask :ls do\n  on roles(:app) do\n    execute \"ls\"\n  end\nend\n```\n\n\u3053\u308c\u3067\u3001\n\n- hoge@example.com\u3067\u30ed\u30b0\u30a4\u30f3\u3067\u304d\u308bapp\u3068\u3044\u3046\u5f79\u5272\u306e\u30b5\u30fc\u30d0\u30fc\u3092\u5b9a\u7fa9\n    - (\u8907\u6570\u66f8\u304f\u306a\u3089\u30b9\u30da\u30fc\u30b9\u533a\u5207\u308a\u3067\u5897\u3084\u305b\u3070\u3044\u3044)\n- app\u306b\u5bfe\u3057\u3066\u306e\u307fls\u3092\u5b9f\u884c\u3059\u308b`:ls`\u3068\u3044\u3046\u30bf\u30b9\u30af\u3092\u5b9a\u7fa9\n\n\u3057\u305f\u3053\u3068\u306b\u306a\u308b\u3002\n\n\u5b9f\u884c\u3057\u3066\u307f\u308b\u3002\n\n```shell-session\n$ bundle exec cap dev ls\n\nINFO[6a60919c] Running /usr/bin/env ls on example.com\nDEBUG[6a60919c] Command: /usr/bin/env ls\nDEBUG[6a60919c]         <<\u3053\u3053\u306b\u30d5\u30a1\u30a4\u30eb\u4e00\u89a7\u304c\u8868\u793a\u3055\u308c\u308b>>\nINFO[6a60919c] Finished in 1.851 seconds with exit status 0 (successful).\n```\n\n\u30bf\u30b9\u30af\u3092\u5897\u3084\u3059\u306a\u3089namespace\u3092\u4ed8\u3051\u305f\u65b9\u304c\u3042\u3068\u3042\u3068\u898b\u901a\u3057\u304c\u826f\u304f\u306a\u308b\u3002\n\n```ruby:config/deploy/dev.rb\nnamespace :utils do\n  task :ls do\n    on roles(:app) do\n      execute \"ls\"\n    end\n  end\n  task :perl_version do\n    on roles(:app) do\n      execute %[perl -v]\n    end\n  end\nend\n```\n\n\u5b9f\u884c\u3057\u3066\u307f\u308b\u3002`namespace:task_name`\u3068\u3044\u3046\u3088\u3046\u306b\u8a18\u8ff0\u3059\u308b\u3002\n\n```shell-session\n$ bundle exec cap dev utils:perl_version\n\nINFO[444094bb] Running /usr/bin/env perl -v on +HFOWFLWKEJF+WLEHF\nDEBUG[444094bb] Command: perl -v\nDEBUG[444094bb]\nDEBUG[444094bb]         This is perl, v5.10.1 (*) built for x86_64-linux-thread-multi\nDEBUG[444094bb]\nDEBUG[444094bb]         Copyright 1987-2009, Larry Wall\nDEBUG[444094bb]\nDEBUG[444094bb]         Perl may be copied only under the terms of either the Artistic License or the\nDEBUG[444094bb]         GNU General Public License, which may be found in the Perl 5 source kit.\nDEBUG[444094bb]\nDEBUG[444094bb]         Complete documentation for Perl, including FAQ lists, should be found on\nDEBUG[444094bb]         this system using \"man perl\" or \"perldoc perl\".  If you have access to the\nDEBUG[444094bb]         Internet, point your browser at http://www.perl.org/, the Perl Home Page.\nDEBUG[444094bb]\nINFO[444094bb] Finished in 1.874 seconds with exit status 0 (successful).\n```\n\n## \u6c7a\u307e\u3063\u305f\u584a\u3067lib\u4ee5\u4e0b\u306b\u79fb\u3059\n\n\u5927\u304d\u304f\u306a\u3063\u305f\u3089lib/capistrano/tasks\u306b\u79fb\u305b\u3070\u3044\u3044\n\n`lib/capistrano/tasks/utils.rake`\u3068\u3044\u3046\u306e\u3092\u3064\u304f\u3063\u3066\u307f\u308b\u3002\n\n```ruby:lib/capistrano/tasks/utils.rake\nnamespace :utils do\n  task :ls do\n    on roles(:app) do\n      execute \"ls\"\n    end\n  end\n  task :perl_version do\n    on roles(:app) do\n      execute %[perl -v]\n    end\n  end\nend\n```\n\nnamespace\u306e\u30d6\u30ed\u30c3\u30af\u3092\u307e\u308b\u3054\u3068\u30b3\u30d4\u30da\u3067\u3044\u3044\u3002\u5b9f\u884c\u306e\u3084\u308a\u304b\u305f\u3082\u5909\u308f\u3089\u306a\u3044\u3002\n\n```shell-session\n$ bundle exec cap dev utils:perl_version\n\nINFO[444094bb] Running /usr/bin/env perl -v on LHFWLKEFJWEFJ\nDEBUG[444094bb] Command: perl -v\nDEBUG[444094bb]\nDEBUG[444094bb]         This is perl, v5.10.1 (*) built for x86_64-linux-thread-multi\nDEBUG[444094bb]\nDEBUG[444094bb]         Copyright 1987-2009, Larry Wall\nDEBUG[444094bb]\nDEBUG[444094bb]         Perl may be copied only under the terms of either the Artistic License or the\nDEBUG[444094bb]         GNU General Public License, which may be found in the Perl 5 source kit.\nDEBUG[444094bb]\nDEBUG[444094bb]         Complete documentation for Perl, including FAQ lists, should be found on\nDEBUG[444094bb]         this system using \"man perl\" or \"perldoc perl\".  If you have access to the\nDEBUG[444094bb]         Internet, point your browser at http://www.perl.org/, the Perl Home Page.\nDEBUG[444094bb]\nINFO[444094bb] Finished in 1.874 seconds with exit status 0 (successful).\n```\n\n\u3053\u308c\u3067dev.rb\u306e\u4e2d\u306b\u306f\u30b5\u30fc\u30d0\u30fc\u306e\u60c5\u5831\u3060\u3051\u8a18\u8ff0\u3055\u308c\u308b\u3060\u3051\u306b\u306a\u308b\u306e\u3067\u3001\u30b7\u30f3\u30d7\u30eb\u306b\u306a\u308b\u3002\n\n## \u74b0\u5883\u5909\u6570\u3092\u6e21\u3057\u3066\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3059\u308b\n\n```\nbundle exec cap dev utils:echo user_name=kazuph\n```\n\n\u3068\u304b\u3084\u3063\u3066\u3001\u5916\u304b\u3089\u81ea\u7531\u306b\u5024\u3092\u6e21\u305b\u308b\u3002\n\n```ruby:lib/capistrano/tasks/utils.rake\n...\n  task :echo do\n    set :user_name, ENV[\"user_name\"] || raise(\"\u30e6\u30fc\u30b6\u30fc\u540d\u5fc5\u9808\")\n    on roles(:app) do\n      execute \"echo #{fetch(:user_name)}\"\n    end\n  end\n```\n\nENV\u3067\u53d7\u3051\u53d6\u3063\u3066\u3001set\u3059\u308c\u3070fetch\u3067\u53d6\u308c\u308b(\u4f7f\u308f\u306a\u3044\u3067\u305d\u306e\u307e\u307eENV\u3064\u3063\u3053\u3093\u3067\u3082\u3044\u3044)\u3002\n\n\n## \u5b9f\u884c\u6642\u306b\u30e6\u30fc\u30b6\u30fc\u306b\u5165\u529b\u3055\u305b\u308b\n\n\u5bfe\u8a71\u5f0f\u3067\u5165\u529b\u3055\u305b\u3066\u3082\u3044\u3044\u3002\n\n```ruby:lib/capistrano/tasks/utils.rake\n...\n\n  task :echo do\n    ask(:user_name, nil) ## \u3053\u3053\u3067\u805e\u3044\u3066\u308b\n    on roles(:app) do\n      execute \"echo #{fetch(:user_name) || raise(\"\u30e6\u30fc\u30b6\u30fc\u540d\u306f\u5fc5\u9808\u3060\u3088\u3093\u2606\")}\"\n    end\n  end\n```\n\n\u5b9f\u884c\u3059\u308b\u3002\n\n```shell-session\n$ bundle exec cap dev utils:echo\nPlease enter user_name (): kazuph\nINFO[62046886] Running /usr/bin/env echo kazuph on example.com\nDEBUG[62046886] Command: echo kazuph\nINFO[62046886] Finished in 2.086 seconds with exit status 0 (successful).\nDEBUG[62046886]         kazuph\nINFO[62046886] Finished in 2.086 seconds with exit status 0 (successful).\n```\n\nask\u306e\u30c7\u30d5\u30a9\u5024\u3092\u7b2c\u4e8c\u5f15\u6570\u3067nil\u306b\u3059\u308b\u3053\u3068\u306b\u3088\u3063\u3066\u3001fetch\u306e\u8fd4\u308a\u5024\u304cnil\u306a\u306e\u3067\u3001raise\u3059\u308b\u3068\u3044\u3046\u4ed5\u7d44\u307f\u3002\u3082\u3063\u3068\u3044\u3044\u65b9\u6cd5\u304c\u3042\u3063\u305f\u3089\u6559\u3048\u3066\u304f\u3060\u3055\u3044\u3002\n\n## \u4ed6\u306e\u30bf\u30b9\u30af\u3092\u307e\u3068\u3081\u3066\u5b9f\u884c\u3059\u308b\n\ninvoke\u3067\u3067\u304d\u308b\u3002namespace\u306f\u5fc5\u9808\u3002\n\nrestart\u3068\u304b\u304c\u308f\u304b\u308a\u3084\u3059\u3044\u3067\u3059\u304b\u306d\u3002\n\n```ruby:lib/capistrano/tasks/utils.rake\n...\n  task :restart do\n    on roles(:app) do\n      invoke \"utils:restart_nginx\"\n      invoke \"utils:restart_app\"\n      invoke \"utils:restart_mysql\"\n    end\n  end\n  task :restart_nginx do\n    on roles(:app) do\n      execute \"sudo /etc/init.d/nginx restart\"\n    end\n  end\n  task :restart_app do\n    on roles(:app) do\n      execute \"sudo supervisorctl restart all\"\n    end\n  end\n  task :restart_mysql do\n    on roles(:app) do\n      execute \"sudo /etc/init.d/mysql restart\"\n    end\n  end\n```\n\n\u203b\u3061\u306a\u307f\u306bsudo\u304c\u5931\u6557\u3059\u308b\u3068\u304d\u306e\u3053\u3068\u306f\u5f8c\u8ff0\n\n## \u9023\u9396\u7684\u306b\u30bf\u30b9\u30af\u3092\u5b9f\u884c\u3059\u308b\n\n\u25ef\u25ef\u306e\u51e6\u7406\u306e\u3042\u3068\u306b\u25ef\u25ef\u3001\u307f\u305f\u3044\u306a\u3068\u304d\u3002\n\n`:add_user`\u306e\u3042\u3068\u306b`:enable_ssh_login`\u3092\u3084\u3063\u3066\u308b\u3051\u3069\u3001`:enable_ssh_login`\u3082\u5358\u4f53\u3067\u5b9f\u884c\u3059\u308b\u3053\u3068\u3092\u8003\u616e\u3059\u308b\u3068\u3053\u3046\u306a\u308b\u3002\n\n```ruby:lib/capistrano/tasks/utils.rake\n  task :add_user do\n    fetch(:user_name) || ask(:user_name, nil)\n    on roles(:app) do\n      user_name = fetch(:user_name) || raise(\"\u30e6\u30fc\u30b6\u30fc\u540d\u306f\u5fc5\u9808\")\n      execute %[useradd {user_name}]\n      invoke \"utils:enable_ssh_login\"\n    end\n  end\n  task :enable_ssh_login do\n    fetch(:user_name) || ask(:user_name, nil)\n    on roles(:app) do\n      user_name = fetch(:user_name) || raise(\"\u30e6\u30fc\u30b6\u30fc\u540d\u306f\u5fc5\u9808\")\n      execute %[mkdir -p /home/#{user_name}/.ssh]\n      execute %[cp /root/.ssh/authorized_keys /home/#{user_name}/.ssh/]\n      execute %[chmod 700 /home/#{user_name}/.ssh]\n      execute %[chmod 600 /home/#{user_name}/.ssh/authorized_keys]\n      execute %[chown -R #{user_name}.#{user_name} /home/#{user_name}/.ssh]\n    end\n  end\n```\n\n\u307e\u305afetch\u3057\u3066nil\u306a\u3089ask\u3059\u308b\u3002\u3053\u308c\u306a\u3089\u3001invoke\u5148\u306eask\u306f\u5b9f\u884c\u3055\u308c\u306a\u3044\u4ed5\u7d44\u307f\u3002\u4fbf\u5229\u3002\n\n\n## sudo\u304c\u5931\u6557\u3059\u308b\n\n```\nINFO[29ab7cc8] Running /usr/bin/env sudo whoami on +LHKFlkL+FHLEWJF\nDEBUG[29ab7cc8] Command: sudo whoami\nDEBUG[29ab7cc8]         sudo\nDEBUG[29ab7cc8]         :\nDEBUG[29ab7cc8]         sudo \u3092\u5b9f\u884c\u3059\u308b\u306b\u306f tty \u304c\u306a\u3051\u308c\u3070\u3044\u3051\u307e\u305b\u3093\u3002\u3059\u307f\u307e\u305b\u3093\nDEBUG[29ab7cc8]\ncap aborted!\n```\n\n\u306a\u3093\u304b\u8b1d\u3089\u308c\u305f\u3051\u3069\u3001tty\u304c\u306a\u3044\u3068\u3060\u3081\u3068\u306e\u3053\u3068\u3002\n\ncap3\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u3059\u308b\u3068\u8a2d\u5b9a\u3067\u304d\u308b\u3002\n\n```ruby:config/deploy.rb\nlock '3.2.1'\nset :pty, true\n```\n\n\u3053\u308c\u3067OK\u3002\n\n## sshkit\u3092\u4f7f\u3044\u3053\u306a\u3059\n\ncap\u306eDSL\u306eon\u3068\u304b\u306e\u90e8\u5206\u3063\u3066\u5b9f\u306fsshkit\u305d\u306e\u3082\u306e\u3002\n\n\u3053\u308c\u304c\u30ad\u30e2\u3002\n\n\u8a73\u3057\u304f\u306f\u4ee5\u4e0b\u3092\u53c2\u7167\u3068\u3046\u3044\u611f\u3058\u306a\u306e\u3067\u3059\u304c\u3001\u6b63\u76f4\u3053\u308c\u3092\u77e5\u308b\u3068\u77e5\u3089\u306a\u3044\u3068\u3067\u306f\u30b3\u30de\u30f3\u30c9\u5b9f\u884c\u306e\u30d0\u30ea\u30a8\u30fc\u30b7\u30e7\u30f3\u306b\u5927\u304d\u306a\u5f71\u97ff\u304c\u51fa\u308b\u3002\n\n- capistrano/sshkit\n    - https://github.com/capistrano/sshkit\n- sshkit/EXAMPLES.md at master \u00b7 capistrano/sshkit\n    - https://github.com/capistrano/sshkit/blob/master/EXAMPLES.md\n- Capistrano 3\u3078\u306e\u624b\u5f15\u304d - \u4eca\u65e5\u306e\u3054\u306f\u3093\u306f\u7d20\u9eba\u3067\u3059\n    - http://takkkun.hatenablog.com/entry/2013/10/12/Capistrano_3%E3%81%B8%E3%81%AE%E6%89%8B%E5%BC%95%E3%81%8D\n\n\u3061\u3087\u3063\u3068\u89e6\u3063\u3066\u307f\u308b\u3002\n\n```ruby:lib/capistrano/tasks/utils.rake\n  task :other_whoami do\n    on roles(:app) do\n      execute :whoami\n      as :fuga do\n        execute :whoami\n      end\n    end\n  end\n```\n\n\u3053\u3046\u3059\u308b\u3068\u4e00\u3064\u76ee\u306eexecute\u3060\u3068hoge, \uff12\u3064\u76ee\u306eexecute\u3067fuga\u3068\u8868\u793a\u3055\u308c\u308b\u3002\n\n\u3061\u306a\u307f\u306b\u5b9f\u969b\u306b\u4f7f\u7528\u3055\u308c\u308b\u30b3\u30de\u30f3\u30c9\u304c\u305d\u308c\u305e\u308c\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u308b\u3002\n\n```shell-session\n# \u6700\u521d\u306eexecute\n/usr/bin/env whoami\n\n# \uff12\u3064\u76ee\u306eexecute\n/usr/bin/env if ! sudo -u fuga whoami > /dev/null; then echo \"You cannot switch to user 'fuga' using sudo, please check the sudoers file\" 1>&2; false; fi on example.com\n```\n\n\u52c9\u5f37\u306b\u306a\u308a\u307e\u3059\u306d\u3002\n\n\u3042\u3068\u5b9f\u884c\u3059\u308b\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u9650\u5b9a\u3059\u308bwithin\u3068\u304b\u3001\u8907\u6570\u30db\u30b9\u30c8\u30d1\u30e9\u30ec\u30eb\u5b9f\u884c\u3059\u308b\u304b\u3001\u30b7\u30fc\u30b1\u30f3\u30b7\u30e3\u30eb\u306b\u5b9f\u884c\u3059\u308b\u304b\u3001\u9593\u9694\u3092\u4f55\u79d2\u3042\u3051\u3066\u5b9f\u884c\u3059\u308b\u3068\u304b\u3001execute\u6642\u306e\u30b3\u30de\u30f3\u30c9\u3092\u72ec\u81ea\u306b\u5b9a\u7fa9\u3059\u308b\u3068\u304b\u30a8\u30ed\u30a8\u30ed\u3067\u304d\u308b\u306e\u3067\u8a66\u3057\u3066\u307f\u308b\u3068\u3044\u3044\u3067\u3059\u3002\n\n## download & upload\n\n\u5b9f\u306f\u3053\u308c\u3082sshkit\u81ea\u4f53\u306e\u6a5f\u80fd\u3067\u5b9f\u73fe\u3067\u304d\u308b\u3002\n\n\u307e\u305a\u306fdownload\u3002\n\nmaillog\u3092download\u3057\u305f\u304f\u3066\u3001\u4e00\u5ea6if\u3067\u30d5\u30a1\u30a4\u30eb\u304c\u3042\u308b\u304b\u3069\u3046\u304b\u78ba\u8a8d\u3057\u3066\u304b\u3089\u5b9f\u884c\u3057\u3066\u308b\u3002\u3053\u306e\u4f8b\u3060\u3068\u30ab\u30ec\u30f3\u30c8\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306b\u305d\u306e\u307e\u307e\u843d\u3068\u3057\u3066\u304d\u3066\u308b\u3002\n\n```ruby:lib/capistrano/tasks/utils.rake\n  task :download_maillog do\n    on roles(:app) do\n      file_name = \"/var/log/maillog\"\n      if test \"[ -f #{file_name} ]\"\n        download! file_name, '.'\n      end\n    end\n  end\n```\n\n\u6b21\u306fupload\u3002\n\n```ruby:lib/capistrano/tasks/utils.rake\n  task :upload_dir do\n    on roles(:app) do\n      execute :mkdir, '-p', '/home/hoge/cap_sample'\n      upload! \"./Gemfile\", '/home/hoge/cap_sample/Gemfile'\n      execute :ls, '/home/hoge/cap_sample'\n    end\n  end\n```\n\n\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3054\u3068upload\u3082\u3067\u304d\u308b\u3002\n\n\n```ruby:lib/capistrano/tasks/utils.rake\n  task :upload_dir_all do\n    on roles(:app) do\n      execute :mkdir, '-p', '/home/hoge/cap_sample'\n      upload! '.', '/home/hoge/cap_sample', recursive: true\n      execute :tree, '-L 2 /home/hoge/cap_sample'\n    end\n  end\n```\n\n\u697d\u3061\u3093\u266a\n\n## \u307e\u3068\u3081\n\n\u958b\u767a\u3067\u4e00\u6642\u7684\u306b\u4f7f\u3046\u30b5\u30fc\u30d0\u30fc\u306e\u5834\u5408\u306f\u3001\u30d7\u30ed\u30d3\u30b8\u30e7\u30cb\u30f3\u30b0\u3059\u308b\u3064\u3082\u308a\u307e\u3067\u306f\u306a\u3044\u304c\u3001\u3075\u3068\u3057\u305f\u30bf\u30a4\u30df\u30f3\u30b0\u3067\u5165\u308c\u305f\u3044\u30c4\u30fc\u30eb\u3068\u304b\u3001\u4e00\u5ea6\u3060\u3051\u5b9f\u884c\u3057\u305f\u3044\u30b3\u30de\u30f3\u30c9\u304c\u3042\u308b\u3068\u304b\u3001\u305d\u3046\u3044\u3046\u3053\u3068\u306f\u305f\u304f\u3055\u3093\u3042\u308a\u305d\u3046\u3002\n\nansible\u306a\u3069\u306e\u30c4\u30fc\u30eb\u3092\u4f7f\u3063\u3066\u3082\u3044\u3044\u3051\u3069\u3001\u305d\u306e\u305f\u3081\u306b\u30ed\u30fc\u30eb\u3092\u66f8\u304f\u306e\u3082\u3060\u308b\u3044\u3002\u624b\u5143\u306bRuby\u306e\u74b0\u5883\u304c\u3042\u308c\u3070\u3044\u3044\u3060\u3051\u306a\u306e\u3067\u3001\u30c7\u30d7\u30ed\u30a4\u307e\u3067\u3044\u304b\u305a\u3068\u3082shell\u3067\u3084\u308a\u305f\u304f\u3082\u306a\u3044\u3053\u3068\u3092\u8a18\u8ff0\u3059\u308b\u306a\u3089cap\u306f\u3061\u3087\u3046\u3069\u3044\u3044DSL\u304b\u3082\u3057\u308c\u306a\u3044\u3002\n\n(\u3042\u3001\u3067\u3082ansible\u306einlinefile\u307f\u305f\u3044\u306a\u3084\u3064\u8d85\u4fbf\u5229\u3060\u306a\u3041\u2026)\n", "tags": ["capistrano3.2.1"]}