{"context": " More than 1 year has passed since last update. ActiveRecord\u3067\u591a\u968e\u5c64\u30ab\u30c6\u30b4\u30ea \u3068\u3044\u3046\u6295\u7a3f\u3092\u3057\u305f\u3068\u3053\u308d\u3001 @jnchito \u3055\u3093\u306b Ancestry \u306a\u308bgem\u3092\u6559\u3048\u3066\u3044\u305f\u3060\u304d\u307e\u3057\u305f\u3002\n stefankroes/ancestry\nOrganise ActiveRecord model into a tree structure\n\n \u6e96\u5099\n$ rails g model category name:string\n\n$ rake db:migrate\n\nmysql> desc categories;\n+------------+--------------+------+-----+---------+----------------+\n| Field      | Type         | Null | Key | Default | Extra          |\n+------------+--------------+------+-----+---------+----------------+\n| id         | int(11)      | NO   | PRI | NULL    | auto_increment |\n| name       | varchar(255) | YES  |     | NULL    |                |\n| created_at | datetime     | YES  |     | NULL    |                |\n| updated_at | datetime     | YES  |     | NULL    |                |\n+------------+--------------+------+-----+---------+----------------+\n\n\n Ancestry\nREADME\u901a\u308a\u306b\u9032\u3081\u307e\u3059\u3002\n$ rails g migration add_ancestry_to_category ancestry:string\n\n# db/migrate/20141229064909_add_ancestry_to_category.rb\n\nclass AddAncestryToCategory < ActiveRecord::Migration\n  def change\n    add_column :categories, :ancestry, :string\n    add_index :categories, :ancestry\n  end\n\n  def down\n    remove_index :categories, :ancestry\n    remove_column :categories, :ancestry\n  end\nend\n\n$ rake db:migrate\n\nmysql> desc categories;\n+------------+--------------+------+-----+---------+----------------+\n| Field      | Type         | Null | Key | Default | Extra          |\n+------------+--------------+------+-----+---------+----------------+\n| id         | int(11)      | NO   | PRI | NULL    | auto_increment |\n| name       | varchar(255) | YES  |     | NULL    |                |\n| created_at | datetime     | YES  |     | NULL    |                |\n| updated_at | datetime     | YES  |     | NULL    |                |\n| ancestry   | varchar(255) | YES  | MUL | NULL    |                |\n+------------+--------------+------+-----+---------+----------------+\n\n# app/models/category.rb\n\nclass Category < ActiveRecord::Base\n  has_ancestry\nend\n\n\n \u30ab\u30c6\u30b4\u30ea\u306e\u767b\u9332\n# db/seed.rb\n\nmetal, jazz = Category.create([{name: \"metal\"}, {name: \"jazz\"}])\n\nmelodic, black = metal.children.create([{name: \"melodic\"}, {name: \"black\"}])\nmelodic.children.create([{name: \"melodic-death\"}, {name: \"melodic-speed\"}])\nblack.children.create([{name: \"symphonic-black\"}, {name: \"melodic-black\"}])\n\nswing, modern = jazz.children.create([{name: \"swing\"}, {name: \"modern\"}])\n\n$ rake db:seed\n\nmysql> select * from categories;\n+----+-----------------+---------------------+---------------------+----------+\n| id | name            | created_at          | updated_at          | ancestry |\n+----+-----------------+---------------------+---------------------+----------+\n|  1 | metal           | 2014-12-30 06:48:28 | 2014-12-30 06:48:28 | NULL     |\n|  2 | jazz            | 2014-12-30 06:48:28 | 2014-12-30 06:48:28 | NULL     |\n|  3 | melodic         | 2014-12-30 06:48:28 | 2014-12-30 06:48:28 | 1        |\n|  4 | black           | 2014-12-30 06:48:28 | 2014-12-30 06:48:28 | 1        |\n|  5 | melodic-death   | 2014-12-30 06:48:28 | 2014-12-30 06:48:28 | 1/3      |\n|  6 | melodic-speed   | 2014-12-30 06:48:28 | 2014-12-30 06:48:28 | 1/3      |\n|  7 | symphonic-black | 2014-12-30 06:48:28 | 2014-12-30 06:48:28 | 1/4      |\n|  8 | melodic-black   | 2014-12-30 06:48:28 | 2014-12-30 06:48:28 | 1/4      |\n|  9 | swing           | 2014-12-30 06:48:28 | 2014-12-30 06:48:28 | 2        |\n| 10 | modern          | 2014-12-30 06:48:28 | 2014-12-30 06:48:28 | 2        |\n+----+-----------------+---------------------+---------------------+----------+\n\n\n \u30ab\u30c6\u30b4\u30ea\u306e\u53d6\u5f97\n$ rails console\n> metal = Category.find_by name: \"metal\"\n> Category.children_of metal\n  Category Load (0.3ms)  SELECT `categories`.* FROM `categories`  WHERE `categories`.`ancestry` = '1'\n=> #<ActiveRecord::Relation [#<Category id: 3, name: \"melodic\", created_at: \"2014-12-30 06:48:28\", updated_at: \"2014-12-30 06:48:28\", ancestry: \"1\">, #<Category id: 4, name: \"black\", created_at: \"2014-12-30 06:48:28\", updated_at: \"2014-12-30 06:48:28\", ancestry: \"1\">]>\n\n\u7c21\u5358\uff01\nAncestry \u3067\u306f\u3001\u968e\u5c64\u69cb\u9020\u306e\u30d1\u30b9\u3092\u30ab\u30e9\u30e0(\u30c7\u30d5\u30a9\u30eb\u30c8\u306fancestry)\u306b\u4fdd\u6301\u3057\u3066\u3044\u307e\u3059\u3002\n\u3053\u308c\u306f\u3001 SQL\u30a2\u30f3\u30c1\u30d1\u30bf\u30fc\u30f3 \u306e\n2\u7ae0 \u30ca\u30a4\u30fc\u30d6\u30c4\u30ea\u30fc\u3067\u7d39\u4ecb\u3055\u308c\u3066\u3044\u308b \u7d4c\u8def\u5217\u6319(Path Enumeration) \u306e\u624b\u6cd5\u3067\u3059\u3002\n\u306a\u306e\u3067\u3001\u7279\u5b9a\u306e\u30ab\u30c6\u30b4\u30ea\u914d\u4e0b\u3092\u518d\u5e30\u7684\u306b\u53d6\u5f97\u3059\u308b\u306e\u3082\u4e0b\u8a18\u306e\u3088\u3046\u306b\u30b5\u30af\u30c3\u3068\u3067\u304d\u307e\u3059\u3002\n> metal.subtree\n  Category Load (0.4ms)  SELECT `categories`.* FROM `categories`  WHERE (((`categories`.`id` = 1 OR `categories`.`ancestry` LIKE '1/%') OR `categories`.`ancestry` = '1'))\n=> #<ActiveRecord::Relation [\n#<Category id: 1, name: \"metal\", created_at: \"2014-12-30 06:48:28\", updated_at: \"2014-12-30 06:48:28\", ancestry: nil>, \n#<Category id: 3, name: \"melodic\", created_at: \"2014-12-30 06:48:28\", updated_at: \"2014-12-30 06:48:28\", ancestry: \"1\">, \n#<Category id: 4, name: \"black\", created_at: \"2014-12-30 06:48:28\", updated_at: \"2014-12-30 06:48:28\", ancestry: \"1\">, \n#<Category id: 5, name: \"melodic-death\", created_at: \"2014-12-30 06:48:28\", updated_at: \"2014-12-30 06:48:28\", ancestry: \"1/3\">, \n#<Category id: 6, name: \"melodic-speed\", created_at: \"2014-12-30 06:48:28\", updated_at: \"2014-12-30 06:48:28\", ancestry: \"1/3\">, \n#<Category id: 7, name: \"symphonic-black\", created_at: \"2014-12-30 06:48:28\", updated_at: \"2014-12-30 06:48:28\", ancestry: \"1/4\">, \n#<Category id: 8, name: \"melodic-black\", created_at: \"2014-12-30 06:48:28\", updated_at: \"2014-12-30 06:48:28\", ancestry: \"1/4\">\n]>\n\nparent_id \u3092\u4f7f\u3063\u305f\u65e2\u5b58\u306e\u30c7\u30fc\u30bf\u304b\u3089 Ancestry \u306b\u79fb\u884c\u3059\u308b\u6a5f\u80fd\u3082\u3042\u308b\u307f\u305f\u3044\u3067\u3059\u3002\n\u4fbf\u5229\u3067\u3059\u306d\u3002\n\n<i class=\"fa fa-file-text-o\" style=\"font-size:1em;\"></i> [ActiveRecord\u3067\u591a\u968e\u5c64\u30ab\u30c6\u30b4\u30ea](http://qiita.com/NAKANO_Akihito/items/9cfc87403e5a4e473eb8) \u3068\u3044\u3046\u6295\u7a3f\u3092\u3057\u305f\u3068\u3053\u308d\u3001 [@jnchito](http://qiita.com/jnchito) \u3055\u3093\u306b `Ancestry` \u306a\u308bgem\u3092\u6559\u3048\u3066\u3044\u305f\u3060\u304d\u307e\u3057\u305f\u3002\n\n<i class=\"fa fa-github\" style=\"font-size:1em;\"></i> [stefankroes/ancestry](https://github.com/stefankroes/ancestry)\nOrganise ActiveRecord model into a tree structure\n\n\n### <i class=\"fa fa-wrench\"></i> \u6e96\u5099\n\n```\n$ rails g model category name:string\n\n$ rake db:migrate\n\nmysql> desc categories;\n+------------+--------------+------+-----+---------+----------------+\n| Field      | Type         | Null | Key | Default | Extra          |\n+------------+--------------+------+-----+---------+----------------+\n| id         | int(11)      | NO   | PRI | NULL    | auto_increment |\n| name       | varchar(255) | YES  |     | NULL    |                |\n| created_at | datetime     | YES  |     | NULL    |                |\n| updated_at | datetime     | YES  |     | NULL    |                |\n+------------+--------------+------+-----+---------+----------------+\n```\n\n### <i class=\"fa fa-tree\"></i> Ancestry \n\nREADME\u901a\u308a\u306b\u9032\u3081\u307e\u3059\u3002\n\n```\n$ rails g migration add_ancestry_to_category ancestry:string\n```\n\n```ruby\n# db/migrate/20141229064909_add_ancestry_to_category.rb\n\nclass AddAncestryToCategory < ActiveRecord::Migration\n  def change\n    add_column :categories, :ancestry, :string\n    add_index :categories, :ancestry\n  end\n\n  def down\n    remove_index :categories, :ancestry\n    remove_column :categories, :ancestry\n  end\nend\n```\n\n```\n$ rake db:migrate\n\nmysql> desc categories;\n+------------+--------------+------+-----+---------+----------------+\n| Field      | Type         | Null | Key | Default | Extra          |\n+------------+--------------+------+-----+---------+----------------+\n| id         | int(11)      | NO   | PRI | NULL    | auto_increment |\n| name       | varchar(255) | YES  |     | NULL    |                |\n| created_at | datetime     | YES  |     | NULL    |                |\n| updated_at | datetime     | YES  |     | NULL    |                |\n| ancestry   | varchar(255) | YES  | MUL | NULL    |                |\n+------------+--------------+------+-----+---------+----------------+\n```\n\n```ruby\n# app/models/category.rb\n\nclass Category < ActiveRecord::Base\n  has_ancestry\nend\n```\n\n### <i class=\"fa fa-ticket\"></i> \u30ab\u30c6\u30b4\u30ea\u306e\u767b\u9332\n\n```ruby\n# db/seed.rb\n\nmetal, jazz = Category.create([{name: \"metal\"}, {name: \"jazz\"}])\n\nmelodic, black = metal.children.create([{name: \"melodic\"}, {name: \"black\"}])\nmelodic.children.create([{name: \"melodic-death\"}, {name: \"melodic-speed\"}])\nblack.children.create([{name: \"symphonic-black\"}, {name: \"melodic-black\"}])\n\nswing, modern = jazz.children.create([{name: \"swing\"}, {name: \"modern\"}])\n```\n\n```\n$ rake db:seed\n\nmysql> select * from categories;\n+----+-----------------+---------------------+---------------------+----------+\n| id | name            | created_at          | updated_at          | ancestry |\n+----+-----------------+---------------------+---------------------+----------+\n|  1 | metal           | 2014-12-30 06:48:28 | 2014-12-30 06:48:28 | NULL     |\n|  2 | jazz            | 2014-12-30 06:48:28 | 2014-12-30 06:48:28 | NULL     |\n|  3 | melodic         | 2014-12-30 06:48:28 | 2014-12-30 06:48:28 | 1        |\n|  4 | black           | 2014-12-30 06:48:28 | 2014-12-30 06:48:28 | 1        |\n|  5 | melodic-death   | 2014-12-30 06:48:28 | 2014-12-30 06:48:28 | 1/3      |\n|  6 | melodic-speed   | 2014-12-30 06:48:28 | 2014-12-30 06:48:28 | 1/3      |\n|  7 | symphonic-black | 2014-12-30 06:48:28 | 2014-12-30 06:48:28 | 1/4      |\n|  8 | melodic-black   | 2014-12-30 06:48:28 | 2014-12-30 06:48:28 | 1/4      |\n|  9 | swing           | 2014-12-30 06:48:28 | 2014-12-30 06:48:28 | 2        |\n| 10 | modern          | 2014-12-30 06:48:28 | 2014-12-30 06:48:28 | 2        |\n+----+-----------------+---------------------+---------------------+----------+\n```\n\n### <i class=\"fa fa-code\"></i> \u30ab\u30c6\u30b4\u30ea\u306e\u53d6\u5f97\n\n```\n$ rails console\n> metal = Category.find_by name: \"metal\"\n> Category.children_of metal\n  Category Load (0.3ms)  SELECT `categories`.* FROM `categories`  WHERE `categories`.`ancestry` = '1'\n=> #<ActiveRecord::Relation [#<Category id: 3, name: \"melodic\", created_at: \"2014-12-30 06:48:28\", updated_at: \"2014-12-30 06:48:28\", ancestry: \"1\">, #<Category id: 4, name: \"black\", created_at: \"2014-12-30 06:48:28\", updated_at: \"2014-12-30 06:48:28\", ancestry: \"1\">]>\n```\n\n\u7c21\u5358\uff01\n\nAncestry \u3067\u306f\u3001\u968e\u5c64\u69cb\u9020\u306e\u30d1\u30b9\u3092\u30ab\u30e9\u30e0(\u30c7\u30d5\u30a9\u30eb\u30c8\u306fancestry)\u306b\u4fdd\u6301\u3057\u3066\u3044\u307e\u3059\u3002\n\u3053\u308c\u306f\u3001<i class=\"fa fa-book\" style=\"font-size:1em;\"></i> [SQL\u30a2\u30f3\u30c1\u30d1\u30bf\u30fc\u30f3](http://www.oreilly.co.jp/books/9784873115894/) \u306e\n2\u7ae0 \u30ca\u30a4\u30fc\u30d6\u30c4\u30ea\u30fc\u3067\u7d39\u4ecb\u3055\u308c\u3066\u3044\u308b `\u7d4c\u8def\u5217\u6319(Path Enumeration)` \u306e\u624b\u6cd5\u3067\u3059\u3002\n\n\u306a\u306e\u3067\u3001\u7279\u5b9a\u306e\u30ab\u30c6\u30b4\u30ea\u914d\u4e0b\u3092\u518d\u5e30\u7684\u306b\u53d6\u5f97\u3059\u308b\u306e\u3082\u4e0b\u8a18\u306e\u3088\u3046\u306b\u30b5\u30af\u30c3\u3068\u3067\u304d\u307e\u3059\u3002\n\n```\n> metal.subtree\n  Category Load (0.4ms)  SELECT `categories`.* FROM `categories`  WHERE (((`categories`.`id` = 1 OR `categories`.`ancestry` LIKE '1/%') OR `categories`.`ancestry` = '1'))\n=> #<ActiveRecord::Relation [\n#<Category id: 1, name: \"metal\", created_at: \"2014-12-30 06:48:28\", updated_at: \"2014-12-30 06:48:28\", ancestry: nil>, \n#<Category id: 3, name: \"melodic\", created_at: \"2014-12-30 06:48:28\", updated_at: \"2014-12-30 06:48:28\", ancestry: \"1\">, \n#<Category id: 4, name: \"black\", created_at: \"2014-12-30 06:48:28\", updated_at: \"2014-12-30 06:48:28\", ancestry: \"1\">, \n#<Category id: 5, name: \"melodic-death\", created_at: \"2014-12-30 06:48:28\", updated_at: \"2014-12-30 06:48:28\", ancestry: \"1/3\">, \n#<Category id: 6, name: \"melodic-speed\", created_at: \"2014-12-30 06:48:28\", updated_at: \"2014-12-30 06:48:28\", ancestry: \"1/3\">, \n#<Category id: 7, name: \"symphonic-black\", created_at: \"2014-12-30 06:48:28\", updated_at: \"2014-12-30 06:48:28\", ancestry: \"1/4\">, \n#<Category id: 8, name: \"melodic-black\", created_at: \"2014-12-30 06:48:28\", updated_at: \"2014-12-30 06:48:28\", ancestry: \"1/4\">\n]>\n```\n\nparent_id \u3092\u4f7f\u3063\u305f\u65e2\u5b58\u306e\u30c7\u30fc\u30bf\u304b\u3089 Ancestry \u306b\u79fb\u884c\u3059\u308b\u6a5f\u80fd\u3082\u3042\u308b\u307f\u305f\u3044\u3067\u3059\u3002\n\u4fbf\u5229\u3067\u3059\u306d\u3002\n\n\n\n\n", "tags": ["Rails", "ActiveRecord", "Ruby"]}