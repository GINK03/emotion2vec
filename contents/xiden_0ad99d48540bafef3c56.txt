{"context": "\u306e\u3063\u3074\u304d\u306a\u3089\u306a\u3044\u4e8b\u60c5\u306b\u3088\u308aUnity5\u3067\u72ec\u81ea\u30c7\u30fc\u30bf\u4fdd\u5b58\u3057\u305f\u304f\u306a\u3063\u305f\u3002\njson\u5f62\u5f0f\u3067\u3082\u3044\u3044\u304b\u3068\u601d\u3063\u305f\u304c\u901f\u5ea6\uff06\u30b5\u30a4\u30ba\u3092\u8003\u3048\u3066MsgPack\u3067\u30d0\u30a4\u30ca\u30ea\u4fdd\u5b58\u3057\u3066\u307f\u308b\u3002\nUnity\u30d0\u30fc\u30b8\u30e7\u30f3\u306f5.3.5f1\u4ee5\u4e0a\u3092\u60f3\u5b9a\u3002\n\n\u4f5c\u6210\u30d7\u30ed\u30b0\u30e9\u30e0\u6982\u7565\n\n\u30de\u30a6\u30b9\u5de6\u53f3\u30dc\u30bf\u30f3\u62bc\u4e0b\u3067\u30de\u30a6\u30b9\u30ab\u30fc\u30bd\u30eb\u4f4d\u7f6e\u306bGameObject\u751f\u6210\n\u30de\u30a6\u30b9\u4e2d\u30dc\u30bf\u30f3\u3067\u751f\u6210\u3057\u305fGameObject\u5168\u524a\u9664\n\u30d7\u30ed\u30b0\u30e9\u30e0\u7d42\u4e86\u6642\u306b\u72b6\u614b\u4fdd\u5b58\u3057\u3001\u6b21\u56de\u8d77\u52d5\u6642\u306b\u305d\u306e\u72b6\u614b\u3092\u5fa9\u5143\u3059\u308b\n\n\n\uff11\uff0eUnity\u65b0\u898f\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u4f5c\u6210\n\u9069\u5f53\u306bUnityDataSaveTest\u306a\u3069\u540d\u524d\u3064\u3051\u3066\u65b0\u898f\u4f5c\u6210\u3059\u308b\u3002\n\u4e00\u5fdc\u51fa\u6765\u4e0a\u304c\u3063\u305f\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u306f\u3053\u3053\u306b\u7f6e\u3044\u3066\u304a\u3044\u305f\u3002\n\n\uff12\uff0e\u300c.NET 2.0\u300d\u4f7f\u3046\u3088\u3046\u306b\u8a2d\u5b9a\n\nUnity\u30c7\u30d5\u30a9\u30eb\u30c8\u3060\u3068\u300c.NET 2.0 subset\u300d\u4f7f\u3046\u8a2d\u5b9a\u306b\u306a\u3063\u3066\u3044\u308b\u304c\u3053\u308c\u3060\u3068MsgPack\u4f7f\u7528\u6642\u30a8\u30e9\u30fc\u51fa\u308b\u306e\u3067\u5909\u66f4\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u3002\n\u30e1\u30cb\u30e5\u30fc\u306e\u300cEdit\u300d\u21d2\u300cProject Settings\u300d\u21d2\u300cPlayer\u300d\u3092\u9078\u629e\u3059\u308b\u3068\u753b\u9762\u53f3\u5074\u300cInspector\u300d\u5185\u304c\u5207\u308a\u66ff\u308f\u308b\u306e\u3067\u305d\u3053\u306e\u300cApi Compatibility Level\u300d\u3067\u300c.NET 2.0\u300d\u306b\u5909\u66f4\u3059\u308b\u3002\n\n\n\n\n\uff13\uff0ePlugins\u30d5\u30a9\u30eb\u30c0\u4f5c\u6210\u3057\u3066\u5916\u90e8DLL\u53d7\u3051\u5165\u308c\u6e96\u5099\n\u300cAssets\u300d\u30d5\u30a9\u30eb\u30c0\u76f4\u4e0b\u306b\u300cPlugins\u300d\u30d5\u30a9\u30eb\u30c0\u3092\u4f5c\u6210\u3059\u308b\u3002\nUnity\u306f\u3053\u306e\u4e2d\u306b\u5165\u308c\u305fDLL\u3092\u81ea\u52d5\u7684\u306b\u53c2\u7167\u8ffd\u52a0\u3059\u308b\u3089\u3057\u3044\u3002\n\n\uff14\uff0eMsgPack\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u3066Plugins\u30d5\u30a9\u30eb\u30c0\u306b\u30b3\u30d4\u30fc\n\nhttps://github.com/msgpack/msgpack-cli/releases/\n\u304b\u3089\u73fe\u6642\u70b9\u3067\u306e\u5b89\u5b9a\u30d0\u30fc\u30b8\u30e7\u30f3\u300cMsgPack.Cli.0.6.8.zip\u300d\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3002\n\u89e3\u51cd\u3057\u305f\u30d5\u30a9\u30eb\u30c0\u5185\u306e\u300cunity3d-full/MsgPack.dll\u300d\u3092\u3055\u3063\u304d\u4f5c\u3063\u305f\u300cPlugins\u300d\u30d5\u30a9\u30eb\u30c0\u3078\u30b3\u30d4\u30fc\u3059\u308b\u3002  \n\n\u3053\u308c\u3067\u3068\u308a\u3042\u3048\u305aMsgPack\u4f7f\u3046\u6e96\u5099\u304c\u6574\u3063\u305f\u3002\n\n\uff15\uff0e\u57fa\u672c\u7684\u306aMsgPack\u4f7f\u3044\u65b9\u306b\u3064\u3044\u3066\n\u30b5\u30f3\u30d7\u30eb\u3092\u898b\u308b\u3068\u4ee5\u4e0b\u306e\u69d8\u306a\u611f\u3058\u3067\u4f7f\u3046\u3089\u3057\u3044\u3002\n\u307e\u305a\u30af\u30e9\u30b9\u5b9a\u7fa9\u3002\n\npublic class PhotoEntry {\n    public long Id { get; set; }\n    public string Title { get; set; }\n    public DateTime Date { get; set; }\n    public string Comment { get; set; }\n    public byte[] Image { get; set; }\n    private readonly List<string> _tags = new List<string>();\n    public IList<string> Tags { get { return this._tags; } }\n}\n\n\n\u305d\u3057\u3066\u3001\u30b7\u30ea\u30a2\u30e9\u30a4\u30ba\uff06\u30c7\u30b7\u30ea\u30a2\u30e9\u30a4\u30ba\u3002\n\n// They are object for just description. \nvar targetObject =\n    new PhotoEntry {\n        Id = 123,\n        Title = \"My photo\",\n        Date = DateTime.Now,\n        Image = new byte[] { 1, 2, 3, 4 },\n        Comment = \"This is test object to be serialize/deserialize using MsgPack.\"\n    };\ntargetObject.Tags.Add(\"Sample\");\ntargetObject.Tags.Add(\"Excellent\");\nvar stream = new MemoryStream();\n// 1. Create serializer instance.\nvar serializer = MessagePackSerializer.Get<PhotoEntry>();\n// 2. Serialize object to the specified stream.\nserializer.Pack(stream, targetObject);\n// Set position to head of the stream to demonstrate deserialization.\nstream.Position = 0;\n// 3. Deserialize object from the specified stream.\n// 1. Create serializer instance.\nvar serializer = MessagePackSerializer.Get<PhotoEntry>();\n// 2. Serialize object to the specified stream.\nserializer.Pack(stream, targetObject);\n// Set position to head of the stream to demonstrate deserialization.\nstream.Position = 0;\n// 3. Deserialize object from the specified stream.\nvar deserializedObject = serializer.Unpack(stream);\n\n\n\u4e0a\u8a18\u306e\u69d8\u306b\u30b3\u30f3\u30d1\u30a4\u30eb\u6642\u306b\u308f\u304b\u3063\u3066\u308b\u578b\u306a\u3089\u3068\u3066\u3082\u7c21\u5358\u3002\n\n\uff16\uff0eMsgPack\u3067\u306e\u6d3e\u751f\u30af\u30e9\u30b9\u306e\u6271\u3044\u306b\u3064\u3044\u3066\n\u4ee5\u4e0b\u306e\u69d8\u306b\u6d3e\u751f\u3055\u305b\u305f\u30af\u30e9\u30b9\u3092\u6271\u3046\u5834\u5408Data.Values\u306b\u306fB\u307e\u305f\u306fC\u306e\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u5165\u308c\u308b\u3053\u3068\u304c\u3067\u304d\u308b\u3002\n\u304c\u3001\u5b9f\u969b\u306b\u30b7\u30ea\u30a2\u30e9\u30a4\u30ba\u3055\u308c\u305f\u306e\u306fA.ValueA\u3060\u3051\u3060\u3063\u305f\u3002\n\u3069\u3046\u3084\u3089\u76f4\u63a5\u6307\u5b9a\u3057\u305f\u30af\u30e9\u30b9\u306e\u30e1\u30f3\u30d0\u306e\u307f\u30b7\u30ea\u30a2\u30e9\u30a4\u30ba\u3055\u308c\u308b\u69d8\u3060\u3002\npublic class A {\n    public int ValueA;\n}\npublic class B : A {\n    public int ValueB;\n}\npublic class C : A {\n    public int ValueC;\n}\npublic class Data {\n    public List<A> Values;\n}\n\n\n\uff17\uff0e\u6d3e\u751f\u30af\u30e9\u30b9\u306e\u30b7\u30ea\u30a2\u30e9\u30a4\u30ba\u3092\u81ea\u5206\u3067\u306a\u3093\u3068\u304b\u3059\u308b\n\n\u4ee5\u4e0b\u306e\u69d8\u306b\u57fa\u672c\u30af\u30e9\u30b9(BaseClass)\u4f5c\u6210\u3057\u3001\u6d3e\u751f\u5148\u306e\u81ea\u4f5c\u30af\u30e9\u30b9ID\u4e00\u89a7\u3068\u305d\u308c\u306b\u5bfe\u5fdc\u3059\u308b\u6d3e\u751f\u30af\u30e9\u30b9\u3092\u4f5c\u6210\u3059\u308b\u3002\n\n\nClassSerializer.cs\n/// <summary>\n/// MessagePack\u3067\u30b7\u30ea\u30a2\u30e9\u30a4\u30ba\u3059\u308b\u30af\u30e9\u30b9ID\u4e00\u89a7\n/// </summary>\npublic enum ClassId {\n    Unknown,\n\n    /// <summary>\n    /// \u3072\u3088\u3053\u30c7\u30fc\u30bf\u30af\u30e9\u30b9ID\n    /// </summary>\n    HiyokoData,\n}\n\n/// <summary>\n/// MessagePack\u3067\u30b7\u30ea\u30a2\u30e9\u30a4\u30ba\u3059\u308b\u57fa\u672c\u30af\u30e9\u30b9\n/// </summary>\npublic abstract class BaseClass {\n    /// <summary>\n    /// \u30d5\u30a3\u30fc\u30eb\u30c9\u6570\u3001\u6d3e\u751f\u5148\u30af\u30e9\u30b9\u3067\u4e0a\u66f8\u304d\u3059\u308b\n    /// </summary>\n    protected const int FieldCount = 1;\n\n    /// <summary>\n    /// \u30af\u30e9\u30b9ID\n    /// </summary>\n    public ClassId ClassId;\n\n    /// <summary>\n    /// \u30c7\u30d5\u30a9\u30eb\u30c8\u30b3\u30f3\u30b9\u30c8\u30e9\u30af\u30bf\u3001MessagePack\u304c\u3053\u3044\u3064\u3092\u5fc5\u8981\u3068\u3057\u3066\u3044\u308b\n    /// </summary>\n    BaseClass() {\n    }\n\n    /// <summary>\n    /// \u30b3\u30f3\u30b9\u30c8\u30e9\u30af\u30bf\n    /// </summary>\n    /// <param name=\"id\">\u6d3e\u751f\u5148\u30af\u30e9\u30b9ID</param>\n    public BaseClass(ClassId id) {\n        this.ClassId = id;\n    }\n\n    /// <summary>\n    /// \u30d1\u30c3\u30ad\u30f3\u30b0\n    /// </summary>\n    /// <param name=\"packer\">\u30d1\u30c3\u30ad\u30f3\u30b0\u5148</param>\n    public abstract void PackToCore(Packer packer);\n\n    /// <summary>\n    /// \u30a2\u30f3\u30d1\u30c3\u30ad\u30f3\u30b0\n    /// </summary>\n    /// <param name=\"unpacker\">\u30a2\u30f3\u30d1\u30c3\u30ad\u30f3\u30b0\u5143</param>\n    public abstract void UnpackFromCore(Unpacker unpacker);\n\n    /// <summary>\n    /// \u30b7\u30ea\u30a2\u30e9\u30a4\u30ba\u3059\u308b\u5408\u8a08\u30d5\u30a3\u30fc\u30eb\u30c9\u6570\u306e\u53d6\u5f97\n    /// </summary>\n    public abstract int GetFieldCount();\n}\n\n/// <summary>\n/// \u3072\u3088\u3053\u4fdd\u5b58\u7528\u30c7\u30fc\u30bf\n/// </summary>\npublic class HiyokoData : BaseClass {\n    protected new const int FieldCount = BaseClass.FieldCount + 4; // \u5408\u8a08\u30d5\u30a3\u30fc\u30eb\u30c9\u6570\u3092\u30aa\u30fc\u30d0\u30fc\u30ed\u30fc\u30c9\n\n    public int Kind;\n    public float X, Y, Angle;\n\n    public HiyokoData() : base(ClassId.HiyokoData) {\n    }\n\n    public override void PackToCore(Packer packer) {\n        packer.Pack(this.Kind);\n        packer.Pack(this.X);\n        packer.Pack(this.Y);\n        packer.Pack(this.Angle);\n    }\n    public override void UnpackFromCore(Unpacker unpacker) {\n        unpacker.ReadInt32(out this.Kind);\n        unpacker.ReadSingle(out this.X);\n        unpacker.ReadSingle(out this.Y);\n        unpacker.ReadSingle(out this.Angle);\n    }\n    public override int GetFieldCount() {\n        return FieldCount;\n    }\n}\n\n\n\n\u305d\u3057\u3066\u4ee5\u4e0b\u306e\u69d8\u306bBaseClass\u7528\u306e\u51e6\u7406\u3092\u30aa\u30fc\u30d0\u30fc\u30e9\u30a4\u30c9\u3055\u305b\u308b\u30b7\u30ea\u30a2\u30e9\u30a4\u30b6\u30af\u30e9\u30b9\u3082\u4f5c\u6210\u3002\n\u3084\u3063\u3066\u308b\u3053\u3068\u306fMsgPack\u914d\u5217\u306e\u5148\u982d\u8981\u7d20\u3092\u30af\u30e9\u30b9ID\u3068\u3057\u3066\u6271\u3044\u3001ID\u306b\u5bfe\u5fdc\u3057\u305f\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u751f\u6210\u3057\u3066\u308b\u3002\n\u4f7f\u3046\u6642\u306f\u3053\u306e\u30af\u30e9\u30b9\u5185\u306e\u30e1\u30bd\u30c3\u30c9ClassSerializer.Get()\u3067\u3084\u3063\u3066\u308b\u69d8\u306b\u767b\u9332\u3057\u3066context\u306b\u6e21\u3057\u3066MsgPack\u30b7\u30ea\u30a2\u30e9\u30a4\u30b6\u53d6\u5f97\u3002\n\n\nClassSerializer.cs\n/// <summary>\n/// \u72ec\u81ea\u30af\u30e9\u30b9\u51e6\u7406\u30aa\u30fc\u30d0\u30fc\u30e9\u30a4\u30c9\u3055\u305b\u308b\u30b7\u30ea\u30a2\u30e9\u30a4\u30b6\n/// </summary>\npublic class ClassSerializer : MessagePackSerializer<BaseClass> {\n    static Dictionary<ClassId, Type> _Types; // \u30b7\u30ea\u30a2\u30e9\u30a4\u30ba\u53ef\u80fd\u578b\u4e00\u89a7\n\n    /// <summary>\n    /// \u9759\u7684\u30b3\u30f3\u30b9\u30c8\u30e9\u30af\u30bf\u3067\u30b7\u30ea\u30a2\u30e9\u30a4\u30ba\u53ef\u80fd\u306a\u578b\u4e00\u89a7\u3092\u521d\u671f\u5316\u3059\u308b\n    /// </summary>\n    static ClassSerializer() {\n        _Types = new Dictionary<ClassId, Type>();\n        _Types[ClassId.HiyokoData] = typeof(HiyokoData);\n    }\n\n    /// <summary>\n    /// \u30b3\u30f3\u30b9\u30c8\u30e9\u30af\u30bf\n    /// </summary>\n    public ClassSerializer(SerializationContext ownerContext)\n        : base(ownerContext) {\n    }\n\n    /// <summary>\n    /// \u72ec\u81ea\u30af\u30e9\u30b9\u51e6\u7406\u30aa\u30fc\u30d0\u30fc\u30e9\u30a4\u30c9\u3055\u308c\u305f\u30b7\u30ea\u30a2\u30e9\u30a4\u30b6\u3092\u53d6\u5f97\u3059\u308b\n    /// </summary>\n    /// <typeparam name=\"T\">\u30eb\u30fc\u30c8\u30af\u30e9\u30b9\u30c7\u30fc\u30bf\u578b</typeparam>\n    /// <returns>\u30b7\u30ea\u30a2\u30e9\u30a4\u30b6</returns>\n    public static MessagePackSerializer<T> Get<T>() {\n        var context = new SerializationContext();\n        context.Serializers.RegisterOverride(new ClassSerializer(context));\n        return MessagePackSerializer.Get<T>(context);\n    }\n\n    /// <summary>\n    /// \u30d1\u30c3\u30ad\u30f3\u30b0\u51e6\u7406\u3092\u30aa\u30fc\u30d0\u30fc\u30e9\u30a4\u30c9\u3001\u81ea\u4f5c\u30af\u30e9\u30b9\u3092MsgPack\u306e\u914d\u5217\u578b\u3068\u3057\u3066\u30d1\u30c3\u30ad\u30f3\u30b0\u3059\u308b\n    /// </summary>\n    /// <param name=\"packer\">\u30d1\u30c3\u30ad\u30f3\u30b0\u5148</param>\n    /// <param name=\"objectTree\">\u30d1\u30c3\u30ad\u30f3\u30b0\u3057\u305f\u3044\u30aa\u30d6\u30b8\u30a7\u30af\u30c8</param>\n    protected override void PackToCore(Packer packer, BaseClass objectTree) {\n        packer.PackArrayHeader(objectTree.GetFieldCount()); // \u914d\u5217\u306e\u8981\u7d20\u6570\u30bb\u30c3\u30c8\n        packer.Pack((UInt32)objectTree.ClassId); // \u5148\u982d\u8981\u7d20\u3068\u3057\u3066\u30af\u30e9\u30b9ID\u30bb\u30c3\u30c8\n        objectTree.PackToCore(packer); // \u5f8c\u306f\u6d3e\u751f\u5148\u30af\u30e9\u30b9\u306b\u4efb\u305b\u308b\n    }\n\n    /// <summary>\n    /// \u30a2\u30f3\u30d1\u30c3\u30ad\u30f3\u30b0\u51e6\u7406\u3092\u30aa\u30fc\u30d0\u30fc\u30e9\u30a4\u30c9\u3001\u81ea\u4f5c\u30af\u30e9\u30b9\u3092MsgPack\u306e\u914d\u5217\u578b\u3068\u3057\u3066\u30a2\u30f3\u30d1\u30c3\u30ad\u30f3\u30b0\u3059\u308b\n    /// </summary>\n    /// <param name=\"unpacker\">\u30a2\u30f3\u30d1\u30c3\u30ad\u30f3\u30b0\u5143</param>\n    /// <returns>\u751f\u6210\u3057\u305f\u30aa\u30d6\u30b8\u30a7\u30af\u30c8</returns>\n    protected override BaseClass UnpackFromCore(Unpacker unpacker) {\n        // \u73fe\u5728\u4f4d\u7f6e\u306f\u914d\u5217\u306e\u5148\u982d\u3067\u306a\u3051\u308c\u3070\u306a\u3089\u306a\u3044\n        if (!unpacker.IsArrayHeader)\n            throw SerializationExceptions.NewIsNotArrayHeader();\n\n        // \u65e2\u306b\u8aad\u307f\u8fbc\u307e\u308c\u3066\u3044\u308b\u914d\u5217\u8981\u7d20\u6570\u53d6\u5f97\n        var length = unpacker.LastReadData.AsInt32();\n\n        // \u914d\u5217\u306e\u5148\u982d\u8981\u7d20\u3092\u30af\u30e9\u30b9ID\u3068\u3057\u3066\u6271\u3046\n        UInt32 i;\n        unpacker.ReadUInt32(out i);\n        var id = (ClassId)i;\n\n        // \u30af\u30e9\u30b9ID\u306b\u5bfe\u5fdc\u3059\u308b\u578b\u60c5\u5831\u53d6\u5f97\n        Type type;\n        if (!_Types.TryGetValue(id, out type))\n            throw new MsgPack.MessageTypeException(i.ToString() + \" is not ClassId\");\n\n        // \u578b\u60c5\u5831\u304b\u3089\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u751f\u6210\n        BaseClass o = Activator.CreateInstance(type) as BaseClass;\n        if (o.GetFieldCount() != length)\n            throw new MsgPack.UnpackException(o.GetType() + \" field count mismatch \" + length);\n\n        // \u5f8c\u306f\u751f\u6210\u3055\u308c\u305f\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u306b\u4efb\u305b\u308b\n        o.UnpackFromCore(unpacker);\n\n        return o;\n    }\n\n\n\n\uff18\uff0e\u4fdd\u5b58\u306e\u30eb\u30fc\u30c8\u3068\u306a\u308b\u30c7\u30fc\u30bf\u30af\u30e9\u30b9\u4f5c\u6210\n\u4ee5\u4e0b\u306e\u69d8\u306a\u30af\u30e9\u30b9\u3092\u4f5c\u6210\u3059\u308b\u3002\n\u3084\u3063\u3066\u308b\u3053\u3068\u306f\u4ee5\u4e0b\u306e\uff12\u3064\u3060\u3051\u3002\n\n\u30b7\u30fc\u30f3\u5185\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u81ea\u5206\u306b\u53d6\u308a\u8fbc\u3080\u3002\n\u53d6\u308a\u8fbc\u307e\u308c\u3066\u3044\u308b\u306e\u3092\u30b7\u30fc\u30f3\u306b\u5fa9\u5143\u3059\u308b\u3002\n\n\nGameData.cs\n/// <summary>\n/// \u6c38\u7d9a\u5316\u3055\u308c\u308b\u30b2\u30fc\u30e0\u30c7\u30fc\u30bf\n/// </summary>\npublic class GameData {\n    static string _filePath = Application.persistentDataPath + \"/data.dat\";\n\n    /// <summary>\n    /// \u30b2\u30fc\u30e0\u30c7\u30fc\u30bf\u4fdd\u5b58\u5148\u30d1\u30b9\u540d\u3001\u5b9f\u884c\u74b0\u5883\u7528\u306e\u30d1\u30b9\u304c\u8fd4\u308b\n    /// </summary>\n    public static string FilePath {\n        get {\n            return _filePath;\n        }\n    }\n\n    /// <summary>\n    /// \u3072\u3088\u3053\u30c7\u30fc\u30bf\u4e00\u89a7\u3000\u4fdd\u5b58\uff06\u8aad\u307f\u8fbc\u307f\u6642\u306e\u307f\u4f7f\u7528\u3059\u308b\n    /// </summary>\n    public List<HiyokoData> Hiyokos;\n\n    /// <summary>\n    /// \u30b2\u30fc\u30e0\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u306e\u30c7\u30fc\u30bf\u3092\u5185\u90e8\u306b\u53d6\u308a\u8fbc\u3080\n    /// </summary>\n    public void StoreGameObjects() {\n        this.Hiyokos = new List<HiyokoData>();\n        foreach (var obj in GameObject.FindObjectsOfType<GameObject>()) {\n            var h = obj.GetComponent<Hiyoko>();\n            if (h != null) {\n                this.Hiyokos.Add(h.Store());\n            }\n        }\n    }\n\n    /// <summary>\n    /// \u30b2\u30fc\u30e0\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u5fa9\u5143\u3059\u308b\n    /// </summary>\n    public void RestoreGameObjects() {\n        foreach (var hd in this.Hiyokos) {\n            Hiyoko.Restore(hd);\n        }\n        this.Hiyokos = null;\n    }\n}\n\n\n\n\uff19\uff0e\u30b2\u30fc\u30e0\u5168\u4f53\u306e\u7ba1\u7406\u30af\u30e9\u30b9\u4f5c\u6210\n\u4ee5\u4e0b\u306e\u69d8\u306a\u30b2\u30fc\u30e0\u5168\u4f53\u7ba1\u7406\u3059\u308b\u30af\u30e9\u30b9\u3092\u4f5c\u6210\u3059\u308b\u3001\u3053\u3044\u3064\u304c\u4fdd\u5b58\u3068\u8aad\u307f\u8fbc\u307f\u3092\u884c\u3046\u3002\n\u3053\u308c\u3092\u30b7\u30fc\u30f3\u5185\u306e\u9069\u5f53\u306a\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u306b\u30a2\u30bf\u30c3\u30c1\u3059\u308b\u3002\n\nGameManager.cs\n/// <summary>\n/// \u30b2\u30fc\u30e0\u5168\u4f53\u306e\u7ba1\u7406\u3092\u884c\u3046\n/// </summary>\npublic class GameManager : MonoBehaviour {\n    static GameObject _hiyo, _matsuhiyo;\n\n    /// <summary>\n    /// \u3072\u3088\u3053\u30d7\u30ec\u30d5\u30a1\u30d6\u53d6\u5f97\n    /// </summary>\n    public static GameObject Hiyo {\n        get {\n            return _hiyo = _hiyo ?? (GameObject)Resources.Load(\"Prefabs/Hiyoko\");\n        }\n    }\n\n    /// <summary>\n    /// \u796d\u308a\u3072\u3088\u3053\u30d7\u30ec\u30d5\u30a1\u30d6\u53d6\u5f97\n    /// </summary>\n    public static GameObject MatsuHiyo {\n        get {\n            return _matsuhiyo = _matsuhiyo ?? (GameObject)Resources.Load(\"Prefabs/MatsuHiyo\");\n        }\n    }\n\n    /// <summary>\n    /// \u521d\u671f\u5316\u6642\u306b\u4fdd\u5b58\u3057\u3066\u3042\u308b\u30b2\u30fc\u30e0\u30c7\u30fc\u30bf\u304b\u3089\u5fa9\u5143\n    /// </summary>\n    void Awake() {\n        Debug.Log(\"Start load game data from \" + GameData.FilePath);\n        var gd = ClassSerializer.LoadObject<GameData>(GameData.FilePath, new GameData());\n        gd.RestoreGameObjects();\n        Debug.Log(\"End load game data\");\n    }\n\n    /// <summary>\n    /// \u30a2\u30d7\u30ea\u7d42\u4e86\u6642\u306b\u4fdd\u5b58\n    /// </summary>\n    void OnApplicationQuit() {\n        Debug.Log(\"Start save game data to \" + GameData.FilePath);\n        var gd = new GameData();\n        gd.StoreGameObjects();\n        ClassSerializer.SaveObject<GameData>(GameData.FilePath, gd);\n        Debug.Log(\"End save game data\");\n    }\n}\n\n\n\n\uff11\uff10\uff0e\u30b2\u30fc\u30e0\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u21d4\u4fdd\u5b58\u30c7\u30fc\u30bf\u306e\u3084\u308a\u53d6\u308a\u30af\u30e9\u30b9\u4f5c\u6210\n\u4ee5\u4e0b\u306e\u69d8\u306b\u4e00\u65e6\u4fdd\u5b58\u7528\u30c7\u30fc\u30bf\u3092\u4ecb\u3057\u3066\u304b\u3089\u6c38\u7d9a\u5316\u3059\u308b\u69d8\u306b\u3057\u3066\u307f\u308b\u3002\n\u3053\u308c\u3092\u30b2\u30fc\u30e0\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u306b\u30a2\u30bf\u30c3\u30c1\u3059\u308b\u3053\u3068\u3067\u5fc5\u8981\u30c7\u30fc\u30bf\u306e\u307f\u304c\u6c38\u7d9a\u5316\u3055\u308c\u308b\u3002\n\nHiyoko.cs\n/// <summary>\n/// \u3072\u3088\u3053\u3061\u3083\u3093\n/// </summary>\npublic class Hiyoko : MonoBehaviour {\n    /// <summary>\n    /// \u30b2\u30fc\u30e0\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u304b\u3089\u4fdd\u5b58\u3059\u308b\u30c7\u30fc\u30bf\u3092\u53d6\u5f97\u3059\u308b\n    /// </summary>\n    public HiyokoData Store() {\n        var t = this.transform;\n        var p = t.position;\n        HiyokoData hd = new HiyokoData();\n        hd.Kind = t.tag == \"Hiyoko\" ? 0 : 1;\n        hd.X = p.x;\n        hd.Y = p.y;\n        hd.Angle = t.localEulerAngles.z;\n        return hd;\n    }\n\n    /// <summary>\n    /// \u4fdd\u5b58\u3057\u3066\u3042\u308b\u30c7\u30fc\u30bf\u304b\u3089\u30b2\u30fc\u30e0\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u5fa9\u5143\u3059\u308b\n    /// </summary>\n    public static void Restore(HiyokoData hd) {\n        GameObject.Instantiate(\n            hd.Kind == 0 ? GameManager.Hiyo : GameManager.MatsuHiyo,\n            new Vector3(hd.X, hd.Y, 0), Quaternion.Euler(0, 0, hd.Angle));\n    }\n}\n\n\n\n\uff11\uff11\uff0e\u30de\u30a6\u30b9\u64cd\u4f5c\u3067\u30b2\u30fc\u30e0\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u751f\u6210\u3059\u308b\u30af\u30e9\u30b9\n\u30da\u30a4\u30f3\u30c8\u3059\u308b\u3088\u3046\u306b\u30b2\u30fc\u30e0\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u751f\u6210\u3057\u3066\u307f\u308b\u3002\n\nPainter.cs\n/// <summary>\n/// \u30da\u30a4\u30f3\u30c8\u3059\u308b\u69d8\u306b\u30b2\u30fc\u30e0\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u751f\u6210\u3059\u308b\n/// </summary>\npublic class Painter : MonoBehaviour {\n    static float _angle;\n\n    void FixedUpdate() {\n        var mpos = Input.mousePosition;\n        var position = Camera.main.ScreenToWorldPoint(mpos);\n        position.z = 0;\n\n        // \u30de\u30a6\u30b9\u5de6\u30dc\u30bf\u30f3\u62bc\u3057\u305f\u3089\u3072\u3088\u3053\u751f\u6210\n        if (Input.GetMouseButton(0)) {\n            Instantiate(GameManager.Hiyo, position, Quaternion.Euler(0, 0, _angle));\n            _angle += 2;\n        }\n\n        // \u30de\u30a6\u30b9\u53f3\u30dc\u30bf\u30f3\u62bc\u3057\u305f\u3089\u796d\u308a\u3072\u3088\u3053\u751f\u6210\n        if (Input.GetMouseButton(1)) {\n            Instantiate(GameManager.MatsuHiyo, position, Quaternion.Euler(0, 0, _angle));\n            _angle += 2;\n        }\n\n        // \u30de\u30a6\u30b9\u4e2d\u30dc\u30bf\u30f3\u62bc\u3055\u308c\u305f\u3089\u5168\u3072\u3088\u3053\u524a\u9664\n        if (Input.GetMouseButtonDown(2)) {\n            foreach (var obj in GameObject.FindObjectsOfType<GameObject>()) {\n                var h = obj.GetComponent<Hiyoko>();\n                if (h != null) {\n                    GameObject.Destroy(obj);\n                }\n            }\n        }\n    }\n}\n\n\n\n\u7d42\u4e86\u3057\u3066\u518d\u8d77\u52d5\u3059\u308b\u3068\u5fa9\u5143\u3055\u308c\u308b\u3002\n\u8d77\u52d5\u3059\u308b\u5ea6\u306b\u63cf\u753b\u9806\u304c\u9006\u306b\u306a\u308b\u3051\u3069\u307e\u3041\u3088\u3057\u3068\u3057\u3088\u3046\u3002\n\n\uff11\uff12\uff0e\u6700\u5f8c\u306b\u30b5\u30f3\u30d7\u30eb\u30d7\u30ed\u30b0\u30e9\u30e0\u306e\u5f8c\u59cb\u672b\u306b\u3064\u3044\u3066\n\u81ea\u5206\u306eWindows\u74b0\u5883\u3060\u3068\u300cC:\\Users\\\u30e6\u30fc\u30b6\u30fc\u540d\\AppData\\LocalLow\\xiden\u300d\u306b\u4fdd\u5b58\u3055\u308c\u305f\u30d5\u30a1\u30a4\u30eb\u304c\u3067\u304d\u308b\u3002\n\u3053\u306e\u30d5\u30a9\u30eb\u30c0\u6d88\u305b\u3070\u5f8c\u59cb\u672b\u5b8c\u4e86\u3002\n\u4f46\u3057\u3053\u308c\u306f\u74b0\u5883\u306b\u3088\u3063\u3066\u7570\u306a\u308b\u3089\u3057\u3044\u306e\u3067\u30ed\u30b0\u306b\u51fa\u529b\u3055\u308c\u305f\u30d1\u30b9\u3067\u5224\u65ad\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\u306e\u3063\u3074\u304d\u306a\u3089\u306a\u3044\u4e8b\u60c5\u306b\u3088\u308aUnity5\u3067\u72ec\u81ea\u30c7\u30fc\u30bf\u4fdd\u5b58\u3057\u305f\u304f\u306a\u3063\u305f\u3002\njson\u5f62\u5f0f\u3067\u3082\u3044\u3044\u304b\u3068\u601d\u3063\u305f\u304c\u901f\u5ea6\uff06\u30b5\u30a4\u30ba\u3092\u8003\u3048\u3066MsgPack\u3067\u30d0\u30a4\u30ca\u30ea\u4fdd\u5b58\u3057\u3066\u307f\u308b\u3002\nUnity\u30d0\u30fc\u30b8\u30e7\u30f3\u306f5.3.5f1\u4ee5\u4e0a\u3092\u60f3\u5b9a\u3002\n\n# \u4f5c\u6210\u30d7\u30ed\u30b0\u30e9\u30e0\u6982\u7565\n- \u30de\u30a6\u30b9\u5de6\u53f3\u30dc\u30bf\u30f3\u62bc\u4e0b\u3067\u30de\u30a6\u30b9\u30ab\u30fc\u30bd\u30eb\u4f4d\u7f6e\u306bGameObject\u751f\u6210\n- \u30de\u30a6\u30b9\u4e2d\u30dc\u30bf\u30f3\u3067\u751f\u6210\u3057\u305fGameObject\u5168\u524a\u9664\n- \u30d7\u30ed\u30b0\u30e9\u30e0\u7d42\u4e86\u6642\u306b\u72b6\u614b\u4fdd\u5b58\u3057\u3001\u6b21\u56de\u8d77\u52d5\u6642\u306b\u305d\u306e\u72b6\u614b\u3092\u5fa9\u5143\u3059\u308b\n\n# \uff11\uff0eUnity\u65b0\u898f\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u4f5c\u6210\n\u9069\u5f53\u306b**UnityDataSaveTest**\u306a\u3069\u540d\u524d\u3064\u3051\u3066\u65b0\u898f\u4f5c\u6210\u3059\u308b\u3002\n\u4e00\u5fdc\u51fa\u6765\u4e0a\u304c\u3063\u305f\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u306f**[\u3053\u3053](https://github.com/xiden/UnityDataSaveTest)**\u306b\u7f6e\u3044\u3066\u304a\u3044\u305f\u3002\n\n# \uff12\uff0e\u300c.NET 2.0\u300d\u4f7f\u3046\u3088\u3046\u306b\u8a2d\u5b9a\n- Unity\u30c7\u30d5\u30a9\u30eb\u30c8\u3060\u3068**\u300c.NET 2.0 subset\u300d**\u4f7f\u3046\u8a2d\u5b9a\u306b\u306a\u3063\u3066\u3044\u308b\u304c\u3053\u308c\u3060\u3068MsgPack\u4f7f\u7528\u6642\u30a8\u30e9\u30fc\u51fa\u308b\u306e\u3067\u5909\u66f4\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u3002\n- \u30e1\u30cb\u30e5\u30fc\u306e**\u300cEdit\u300d**\u21d2**\u300cProject Settings\u300d**\u21d2**\u300cPlayer\u300d**\u3092\u9078\u629e\u3059\u308b\u3068\u753b\u9762\u53f3\u5074**\u300cInspector\u300d**\u5185\u304c\u5207\u308a\u66ff\u308f\u308b\u306e\u3067\u305d\u3053\u306e**\u300cApi Compatibility Level\u300d**\u3067**\u300c.NET 2.0\u300d**\u306b\u5909\u66f4\u3059\u308b\u3002\n![NET20.png](https://qiita-image-store.s3.amazonaws.com/0/124409/7b07b2ae-7d1e-e64d-0e39-e642856764bb.png)\n\n# \uff13\uff0ePlugins\u30d5\u30a9\u30eb\u30c0\u4f5c\u6210\u3057\u3066\u5916\u90e8DLL\u53d7\u3051\u5165\u308c\u6e96\u5099\n**\u300cAssets\u300d**\u30d5\u30a9\u30eb\u30c0\u76f4\u4e0b\u306b**\u300cPlugins\u300d**\u30d5\u30a9\u30eb\u30c0\u3092\u4f5c\u6210\u3059\u308b\u3002\nUnity\u306f\u3053\u306e\u4e2d\u306b\u5165\u308c\u305fDLL\u3092\u81ea\u52d5\u7684\u306b\u53c2\u7167\u8ffd\u52a0\u3059\u308b\u3089\u3057\u3044\u3002\n\n# \uff14\uff0eMsgPack\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u3066Plugins\u30d5\u30a9\u30eb\u30c0\u306b\u30b3\u30d4\u30fc\n- **[https://github.com/msgpack/msgpack-cli/releases/](https://github.com/msgpack/msgpack-cli/releases/)**\n\u304b\u3089\u73fe\u6642\u70b9\u3067\u306e\u5b89\u5b9a\u30d0\u30fc\u30b8\u30e7\u30f3**\u300cMsgPack.Cli.0.6.8.zip\u300d**\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3002\n\n- \u89e3\u51cd\u3057\u305f\u30d5\u30a9\u30eb\u30c0\u5185\u306e**\u300cunity3d-full/MsgPack.dll\u300d**\u3092\u3055\u3063\u304d\u4f5c\u3063\u305f**\u300cPlugins\u300d**\u30d5\u30a9\u30eb\u30c0\u3078\u30b3\u30d4\u30fc\u3059\u308b\u3002  \n\n\u3053\u308c\u3067\u3068\u308a\u3042\u3048\u305aMsgPack\u4f7f\u3046\u6e96\u5099\u304c\u6574\u3063\u305f\u3002\n\n# \uff15\uff0e\u57fa\u672c\u7684\u306aMsgPack\u4f7f\u3044\u65b9\u306b\u3064\u3044\u3066\n\u30b5\u30f3\u30d7\u30eb\u3092\u898b\u308b\u3068\u4ee5\u4e0b\u306e\u69d8\u306a\u611f\u3058\u3067\u4f7f\u3046\u3089\u3057\u3044\u3002\n\u307e\u305a\u30af\u30e9\u30b9\u5b9a\u7fa9\u3002\n\n>```csharp\npublic class PhotoEntry {\n\tpublic long Id { get; set; }\n\tpublic string Title { get; set; }\n\tpublic DateTime Date { get; set; }\n\tpublic string Comment { get; set; }\n\tpublic byte[] Image { get; set; }\n\tprivate readonly List<string> _tags = new List<string>();\n\tpublic IList<string> Tags { get { return this._tags; } }\n}\n```\n\n\u305d\u3057\u3066\u3001\u30b7\u30ea\u30a2\u30e9\u30a4\u30ba\uff06\u30c7\u30b7\u30ea\u30a2\u30e9\u30a4\u30ba\u3002\n\n>```csharp\n// They are object for just description. \nvar targetObject =\n\tnew PhotoEntry {\n\t\tId = 123,\n\t\tTitle = \"My photo\",\n\t\tDate = DateTime.Now,\n\t\tImage = new byte[] { 1, 2, 3, 4 },\n\t\tComment = \"This is test object to be serialize/deserialize using MsgPack.\"\n\t};\ntargetObject.Tags.Add(\"Sample\");\ntargetObject.Tags.Add(\"Excellent\");\nvar stream = new MemoryStream();\n// 1. Create serializer instance.\nvar serializer = MessagePackSerializer.Get<PhotoEntry>();\n// 2. Serialize object to the specified stream.\nserializer.Pack(stream, targetObject);\n// Set position to head of the stream to demonstrate deserialization.\nstream.Position = 0;\n// 3. Deserialize object from the specified stream.\n// 1. Create serializer instance.\nvar serializer = MessagePackSerializer.Get<PhotoEntry>();\n// 2. Serialize object to the specified stream.\nserializer.Pack(stream, targetObject);\n// Set position to head of the stream to demonstrate deserialization.\nstream.Position = 0;\n// 3. Deserialize object from the specified stream.\nvar deserializedObject = serializer.Unpack(stream);\n```\n\n\u4e0a\u8a18\u306e\u69d8\u306b\u30b3\u30f3\u30d1\u30a4\u30eb\u6642\u306b\u308f\u304b\u3063\u3066\u308b\u578b\u306a\u3089\u3068\u3066\u3082\u7c21\u5358\u3002\n\n# \uff16\uff0eMsgPack\u3067\u306e\u6d3e\u751f\u30af\u30e9\u30b9\u306e\u6271\u3044\u306b\u3064\u3044\u3066\n\u4ee5\u4e0b\u306e\u69d8\u306b\u6d3e\u751f\u3055\u305b\u305f\u30af\u30e9\u30b9\u3092\u6271\u3046\u5834\u5408**Data.Values**\u306b\u306f**B**\u307e\u305f\u306f**C**\u306e\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u5165\u308c\u308b\u3053\u3068\u304c\u3067\u304d\u308b\u3002\n\u304c\u3001\u5b9f\u969b\u306b\u30b7\u30ea\u30a2\u30e9\u30a4\u30ba\u3055\u308c\u305f\u306e\u306f**A.ValueA**\u3060\u3051\u3060\u3063\u305f\u3002\n\u3069\u3046\u3084\u3089\u76f4\u63a5\u6307\u5b9a\u3057\u305f\u30af\u30e9\u30b9\u306e\u30e1\u30f3\u30d0\u306e\u307f\u30b7\u30ea\u30a2\u30e9\u30a4\u30ba\u3055\u308c\u308b\u69d8\u3060\u3002\n\n```csharp\npublic class A {\n\tpublic int ValueA;\n}\npublic class B : A {\n\tpublic int ValueB;\n}\npublic class C : A {\n\tpublic int ValueC;\n}\npublic class Data {\n\tpublic List<A> Values;\n}\n```\n\n# \uff17\uff0e\u6d3e\u751f\u30af\u30e9\u30b9\u306e\u30b7\u30ea\u30a2\u30e9\u30a4\u30ba\u3092\u81ea\u5206\u3067\u306a\u3093\u3068\u304b\u3059\u308b\n- \u4ee5\u4e0b\u306e\u69d8\u306b\u57fa\u672c\u30af\u30e9\u30b9(**BaseClass**)\u4f5c\u6210\u3057\u3001\u6d3e\u751f\u5148\u306e\u81ea\u4f5c\u30af\u30e9\u30b9ID\u4e00\u89a7\u3068\u305d\u308c\u306b\u5bfe\u5fdc\u3059\u308b\u6d3e\u751f\u30af\u30e9\u30b9\u3092\u4f5c\u6210\u3059\u308b\u3002\n\n```csharp:ClassSerializer.cs\n/// <summary>\n/// MessagePack\u3067\u30b7\u30ea\u30a2\u30e9\u30a4\u30ba\u3059\u308b\u30af\u30e9\u30b9ID\u4e00\u89a7\n/// </summary>\npublic enum ClassId {\n\tUnknown,\n\n\t/// <summary>\n\t/// \u3072\u3088\u3053\u30c7\u30fc\u30bf\u30af\u30e9\u30b9ID\n\t/// </summary>\n\tHiyokoData,\n}\n\n/// <summary>\n/// MessagePack\u3067\u30b7\u30ea\u30a2\u30e9\u30a4\u30ba\u3059\u308b\u57fa\u672c\u30af\u30e9\u30b9\n/// </summary>\npublic abstract class BaseClass {\n\t/// <summary>\n\t/// \u30d5\u30a3\u30fc\u30eb\u30c9\u6570\u3001\u6d3e\u751f\u5148\u30af\u30e9\u30b9\u3067\u4e0a\u66f8\u304d\u3059\u308b\n\t/// </summary>\n\tprotected const int FieldCount = 1;\n\n\t/// <summary>\n\t/// \u30af\u30e9\u30b9ID\n\t/// </summary>\n\tpublic ClassId ClassId;\n\n\t/// <summary>\n\t/// \u30c7\u30d5\u30a9\u30eb\u30c8\u30b3\u30f3\u30b9\u30c8\u30e9\u30af\u30bf\u3001MessagePack\u304c\u3053\u3044\u3064\u3092\u5fc5\u8981\u3068\u3057\u3066\u3044\u308b\n\t/// </summary>\n\tBaseClass() {\n\t}\n\n\t/// <summary>\n\t/// \u30b3\u30f3\u30b9\u30c8\u30e9\u30af\u30bf\n\t/// </summary>\n\t/// <param name=\"id\">\u6d3e\u751f\u5148\u30af\u30e9\u30b9ID</param>\n\tpublic BaseClass(ClassId id) {\n\t\tthis.ClassId = id;\n\t}\n\n\t/// <summary>\n\t/// \u30d1\u30c3\u30ad\u30f3\u30b0\n\t/// </summary>\n\t/// <param name=\"packer\">\u30d1\u30c3\u30ad\u30f3\u30b0\u5148</param>\n\tpublic abstract void PackToCore(Packer packer);\n\n\t/// <summary>\n\t/// \u30a2\u30f3\u30d1\u30c3\u30ad\u30f3\u30b0\n\t/// </summary>\n\t/// <param name=\"unpacker\">\u30a2\u30f3\u30d1\u30c3\u30ad\u30f3\u30b0\u5143</param>\n\tpublic abstract void UnpackFromCore(Unpacker unpacker);\n\n\t/// <summary>\n\t/// \u30b7\u30ea\u30a2\u30e9\u30a4\u30ba\u3059\u308b\u5408\u8a08\u30d5\u30a3\u30fc\u30eb\u30c9\u6570\u306e\u53d6\u5f97\n\t/// </summary>\n\tpublic abstract int GetFieldCount();\n}\n\n/// <summary>\n/// \u3072\u3088\u3053\u4fdd\u5b58\u7528\u30c7\u30fc\u30bf\n/// </summary>\npublic class HiyokoData : BaseClass {\n\tprotected new const int FieldCount = BaseClass.FieldCount + 4; // \u5408\u8a08\u30d5\u30a3\u30fc\u30eb\u30c9\u6570\u3092\u30aa\u30fc\u30d0\u30fc\u30ed\u30fc\u30c9\n\n\tpublic int Kind;\n\tpublic float X, Y, Angle;\n\n\tpublic HiyokoData() : base(ClassId.HiyokoData) {\n\t}\n\n\tpublic override void PackToCore(Packer packer) {\n\t\tpacker.Pack(this.Kind);\n\t\tpacker.Pack(this.X);\n\t\tpacker.Pack(this.Y);\n\t\tpacker.Pack(this.Angle);\n\t}\n\tpublic override void UnpackFromCore(Unpacker unpacker) {\n\t\tunpacker.ReadInt32(out this.Kind);\n\t\tunpacker.ReadSingle(out this.X);\n\t\tunpacker.ReadSingle(out this.Y);\n\t\tunpacker.ReadSingle(out this.Angle);\n\t}\n\tpublic override int GetFieldCount() {\n\t\treturn FieldCount;\n\t}\n}\n```\n\n- \u305d\u3057\u3066\u4ee5\u4e0b\u306e\u69d8\u306b**BaseClass**\u7528\u306e\u51e6\u7406\u3092\u30aa\u30fc\u30d0\u30fc\u30e9\u30a4\u30c9\u3055\u305b\u308b\u30b7\u30ea\u30a2\u30e9\u30a4\u30b6\u30af\u30e9\u30b9\u3082\u4f5c\u6210\u3002\n- \u3084\u3063\u3066\u308b\u3053\u3068\u306fMsgPack\u914d\u5217\u306e\u5148\u982d\u8981\u7d20\u3092\u30af\u30e9\u30b9ID\u3068\u3057\u3066\u6271\u3044\u3001ID\u306b\u5bfe\u5fdc\u3057\u305f\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u751f\u6210\u3057\u3066\u308b\u3002\n- \u4f7f\u3046\u6642\u306f\u3053\u306e\u30af\u30e9\u30b9\u5185\u306e\u30e1\u30bd\u30c3\u30c9**ClassSerializer.Get<T>()**\u3067\u3084\u3063\u3066\u308b\u69d8\u306b\u767b\u9332\u3057\u3066**context**\u306b\u6e21\u3057\u3066MsgPack\u30b7\u30ea\u30a2\u30e9\u30a4\u30b6\u53d6\u5f97\u3002\n\n```csharp:ClassSerializer.cs\n/// <summary>\n/// \u72ec\u81ea\u30af\u30e9\u30b9\u51e6\u7406\u30aa\u30fc\u30d0\u30fc\u30e9\u30a4\u30c9\u3055\u305b\u308b\u30b7\u30ea\u30a2\u30e9\u30a4\u30b6\n/// </summary>\npublic class ClassSerializer : MessagePackSerializer<BaseClass> {\n\tstatic Dictionary<ClassId, Type> _Types; // \u30b7\u30ea\u30a2\u30e9\u30a4\u30ba\u53ef\u80fd\u578b\u4e00\u89a7\n\n\t/// <summary>\n\t/// \u9759\u7684\u30b3\u30f3\u30b9\u30c8\u30e9\u30af\u30bf\u3067\u30b7\u30ea\u30a2\u30e9\u30a4\u30ba\u53ef\u80fd\u306a\u578b\u4e00\u89a7\u3092\u521d\u671f\u5316\u3059\u308b\n\t/// </summary>\n\tstatic ClassSerializer() {\n\t\t_Types = new Dictionary<ClassId, Type>();\n\t\t_Types[ClassId.HiyokoData] = typeof(HiyokoData);\n\t}\n\n\t/// <summary>\n\t/// \u30b3\u30f3\u30b9\u30c8\u30e9\u30af\u30bf\n\t/// </summary>\n\tpublic ClassSerializer(SerializationContext ownerContext)\n\t\t: base(ownerContext) {\n\t}\n\n\t/// <summary>\n\t/// \u72ec\u81ea\u30af\u30e9\u30b9\u51e6\u7406\u30aa\u30fc\u30d0\u30fc\u30e9\u30a4\u30c9\u3055\u308c\u305f\u30b7\u30ea\u30a2\u30e9\u30a4\u30b6\u3092\u53d6\u5f97\u3059\u308b\n\t/// </summary>\n\t/// <typeparam name=\"T\">\u30eb\u30fc\u30c8\u30af\u30e9\u30b9\u30c7\u30fc\u30bf\u578b</typeparam>\n\t/// <returns>\u30b7\u30ea\u30a2\u30e9\u30a4\u30b6</returns>\n\tpublic static MessagePackSerializer<T> Get<T>() {\n\t\tvar context = new SerializationContext();\n\t\tcontext.Serializers.RegisterOverride(new ClassSerializer(context));\n\t\treturn MessagePackSerializer.Get<T>(context);\n\t}\n\n\t/// <summary>\n\t/// \u30d1\u30c3\u30ad\u30f3\u30b0\u51e6\u7406\u3092\u30aa\u30fc\u30d0\u30fc\u30e9\u30a4\u30c9\u3001\u81ea\u4f5c\u30af\u30e9\u30b9\u3092MsgPack\u306e\u914d\u5217\u578b\u3068\u3057\u3066\u30d1\u30c3\u30ad\u30f3\u30b0\u3059\u308b\n\t/// </summary>\n\t/// <param name=\"packer\">\u30d1\u30c3\u30ad\u30f3\u30b0\u5148</param>\n\t/// <param name=\"objectTree\">\u30d1\u30c3\u30ad\u30f3\u30b0\u3057\u305f\u3044\u30aa\u30d6\u30b8\u30a7\u30af\u30c8</param>\n\tprotected override void PackToCore(Packer packer, BaseClass objectTree) {\n\t\tpacker.PackArrayHeader(objectTree.GetFieldCount()); // \u914d\u5217\u306e\u8981\u7d20\u6570\u30bb\u30c3\u30c8\n\t\tpacker.Pack((UInt32)objectTree.ClassId); // \u5148\u982d\u8981\u7d20\u3068\u3057\u3066\u30af\u30e9\u30b9ID\u30bb\u30c3\u30c8\n\t\tobjectTree.PackToCore(packer); // \u5f8c\u306f\u6d3e\u751f\u5148\u30af\u30e9\u30b9\u306b\u4efb\u305b\u308b\n\t}\n\n\t/// <summary>\n\t/// \u30a2\u30f3\u30d1\u30c3\u30ad\u30f3\u30b0\u51e6\u7406\u3092\u30aa\u30fc\u30d0\u30fc\u30e9\u30a4\u30c9\u3001\u81ea\u4f5c\u30af\u30e9\u30b9\u3092MsgPack\u306e\u914d\u5217\u578b\u3068\u3057\u3066\u30a2\u30f3\u30d1\u30c3\u30ad\u30f3\u30b0\u3059\u308b\n\t/// </summary>\n\t/// <param name=\"unpacker\">\u30a2\u30f3\u30d1\u30c3\u30ad\u30f3\u30b0\u5143</param>\n\t/// <returns>\u751f\u6210\u3057\u305f\u30aa\u30d6\u30b8\u30a7\u30af\u30c8</returns>\n\tprotected override BaseClass UnpackFromCore(Unpacker unpacker) {\n\t\t// \u73fe\u5728\u4f4d\u7f6e\u306f\u914d\u5217\u306e\u5148\u982d\u3067\u306a\u3051\u308c\u3070\u306a\u3089\u306a\u3044\n\t\tif (!unpacker.IsArrayHeader)\n\t\t\tthrow SerializationExceptions.NewIsNotArrayHeader();\n\n\t\t// \u65e2\u306b\u8aad\u307f\u8fbc\u307e\u308c\u3066\u3044\u308b\u914d\u5217\u8981\u7d20\u6570\u53d6\u5f97\n\t\tvar length = unpacker.LastReadData.AsInt32();\n\n\t\t// \u914d\u5217\u306e\u5148\u982d\u8981\u7d20\u3092\u30af\u30e9\u30b9ID\u3068\u3057\u3066\u6271\u3046\n\t\tUInt32 i;\n\t\tunpacker.ReadUInt32(out i);\n\t\tvar id = (ClassId)i;\n\n\t\t// \u30af\u30e9\u30b9ID\u306b\u5bfe\u5fdc\u3059\u308b\u578b\u60c5\u5831\u53d6\u5f97\n\t\tType type;\n\t\tif (!_Types.TryGetValue(id, out type))\n\t\t\tthrow new MsgPack.MessageTypeException(i.ToString() + \" is not ClassId\");\n\n\t\t// \u578b\u60c5\u5831\u304b\u3089\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u751f\u6210\n\t\tBaseClass o = Activator.CreateInstance(type) as BaseClass;\n\t\tif (o.GetFieldCount() != length)\n\t\t\tthrow new MsgPack.UnpackException(o.GetType() + \" field count mismatch \" + length);\n\n\t\t// \u5f8c\u306f\u751f\u6210\u3055\u308c\u305f\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u306b\u4efb\u305b\u308b\n\t\to.UnpackFromCore(unpacker);\n\n\t\treturn o;\n\t}\n```\n\n# \uff18\uff0e\u4fdd\u5b58\u306e\u30eb\u30fc\u30c8\u3068\u306a\u308b\u30c7\u30fc\u30bf\u30af\u30e9\u30b9\u4f5c\u6210\n\u4ee5\u4e0b\u306e\u69d8\u306a\u30af\u30e9\u30b9\u3092\u4f5c\u6210\u3059\u308b\u3002\n\u3084\u3063\u3066\u308b\u3053\u3068\u306f\u4ee5\u4e0b\u306e\uff12\u3064\u3060\u3051\u3002\n\n- \u30b7\u30fc\u30f3\u5185\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u81ea\u5206\u306b\u53d6\u308a\u8fbc\u3080\u3002\n- \u53d6\u308a\u8fbc\u307e\u308c\u3066\u3044\u308b\u306e\u3092\u30b7\u30fc\u30f3\u306b\u5fa9\u5143\u3059\u308b\u3002\n\n```csharp:GameData.cs\n/// <summary>\n/// \u6c38\u7d9a\u5316\u3055\u308c\u308b\u30b2\u30fc\u30e0\u30c7\u30fc\u30bf\n/// </summary>\npublic class GameData {\n\tstatic string _filePath = Application.persistentDataPath + \"/data.dat\";\n\n\t/// <summary>\n\t/// \u30b2\u30fc\u30e0\u30c7\u30fc\u30bf\u4fdd\u5b58\u5148\u30d1\u30b9\u540d\u3001\u5b9f\u884c\u74b0\u5883\u7528\u306e\u30d1\u30b9\u304c\u8fd4\u308b\n\t/// </summary>\n\tpublic static string FilePath {\n\t\tget {\n\t\t\treturn _filePath;\n\t\t}\n\t}\n\n\t/// <summary>\n\t/// \u3072\u3088\u3053\u30c7\u30fc\u30bf\u4e00\u89a7\u3000\u4fdd\u5b58\uff06\u8aad\u307f\u8fbc\u307f\u6642\u306e\u307f\u4f7f\u7528\u3059\u308b\n\t/// </summary>\n\tpublic List<HiyokoData> Hiyokos;\n\n\t/// <summary>\n\t/// \u30b2\u30fc\u30e0\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u306e\u30c7\u30fc\u30bf\u3092\u5185\u90e8\u306b\u53d6\u308a\u8fbc\u3080\n\t/// </summary>\n\tpublic void StoreGameObjects() {\n\t\tthis.Hiyokos = new List<HiyokoData>();\n\t\tforeach (var obj in GameObject.FindObjectsOfType<GameObject>()) {\n\t\t\tvar h = obj.GetComponent<Hiyoko>();\n\t\t\tif (h != null) {\n\t\t\t\tthis.Hiyokos.Add(h.Store());\n\t\t\t}\n\t\t}\n\t}\n\n\t/// <summary>\n\t/// \u30b2\u30fc\u30e0\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u5fa9\u5143\u3059\u308b\n\t/// </summary>\n\tpublic void RestoreGameObjects() {\n\t\tforeach (var hd in this.Hiyokos) {\n\t\t\tHiyoko.Restore(hd);\n\t\t}\n\t\tthis.Hiyokos = null;\n\t}\n}\n```\n\n# \uff19\uff0e\u30b2\u30fc\u30e0\u5168\u4f53\u306e\u7ba1\u7406\u30af\u30e9\u30b9\u4f5c\u6210\n\u4ee5\u4e0b\u306e\u69d8\u306a\u30b2\u30fc\u30e0\u5168\u4f53\u7ba1\u7406\u3059\u308b\u30af\u30e9\u30b9\u3092\u4f5c\u6210\u3059\u308b\u3001\u3053\u3044\u3064\u304c\u4fdd\u5b58\u3068\u8aad\u307f\u8fbc\u307f\u3092\u884c\u3046\u3002\n\u3053\u308c\u3092\u30b7\u30fc\u30f3\u5185\u306e\u9069\u5f53\u306a\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u306b\u30a2\u30bf\u30c3\u30c1\u3059\u308b\u3002\n\n```csharp:GameManager.cs\n/// <summary>\n/// \u30b2\u30fc\u30e0\u5168\u4f53\u306e\u7ba1\u7406\u3092\u884c\u3046\n/// </summary>\npublic class GameManager : MonoBehaviour {\n\tstatic GameObject _hiyo, _matsuhiyo;\n\n\t/// <summary>\n\t/// \u3072\u3088\u3053\u30d7\u30ec\u30d5\u30a1\u30d6\u53d6\u5f97\n\t/// </summary>\n\tpublic static GameObject Hiyo {\n\t\tget {\n\t\t\treturn _hiyo = _hiyo ?? (GameObject)Resources.Load(\"Prefabs/Hiyoko\");\n\t\t}\n\t}\n\n\t/// <summary>\n\t/// \u796d\u308a\u3072\u3088\u3053\u30d7\u30ec\u30d5\u30a1\u30d6\u53d6\u5f97\n\t/// </summary>\n\tpublic static GameObject MatsuHiyo {\n\t\tget {\n\t\t\treturn _matsuhiyo = _matsuhiyo ?? (GameObject)Resources.Load(\"Prefabs/MatsuHiyo\");\n\t\t}\n\t}\n\n\t/// <summary>\n\t/// \u521d\u671f\u5316\u6642\u306b\u4fdd\u5b58\u3057\u3066\u3042\u308b\u30b2\u30fc\u30e0\u30c7\u30fc\u30bf\u304b\u3089\u5fa9\u5143\n\t/// </summary>\n\tvoid Awake() {\n\t\tDebug.Log(\"Start load game data from \" + GameData.FilePath);\n\t\tvar gd = ClassSerializer.LoadObject<GameData>(GameData.FilePath, new GameData());\n\t\tgd.RestoreGameObjects();\n\t\tDebug.Log(\"End load game data\");\n\t}\n\n\t/// <summary>\n\t/// \u30a2\u30d7\u30ea\u7d42\u4e86\u6642\u306b\u4fdd\u5b58\n\t/// </summary>\n\tvoid OnApplicationQuit() {\n\t\tDebug.Log(\"Start save game data to \" + GameData.FilePath);\n\t\tvar gd = new GameData();\n\t\tgd.StoreGameObjects();\n\t\tClassSerializer.SaveObject<GameData>(GameData.FilePath, gd);\n\t\tDebug.Log(\"End save game data\");\n\t}\n}\n```\n\n# \uff11\uff10\uff0e\u30b2\u30fc\u30e0\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u21d4\u4fdd\u5b58\u30c7\u30fc\u30bf\u306e\u3084\u308a\u53d6\u308a\u30af\u30e9\u30b9\u4f5c\u6210\n\u4ee5\u4e0b\u306e\u69d8\u306b\u4e00\u65e6\u4fdd\u5b58\u7528\u30c7\u30fc\u30bf\u3092\u4ecb\u3057\u3066\u304b\u3089\u6c38\u7d9a\u5316\u3059\u308b\u69d8\u306b\u3057\u3066\u307f\u308b\u3002\n\u3053\u308c\u3092\u30b2\u30fc\u30e0\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u306b\u30a2\u30bf\u30c3\u30c1\u3059\u308b\u3053\u3068\u3067\u5fc5\u8981\u30c7\u30fc\u30bf\u306e\u307f\u304c\u6c38\u7d9a\u5316\u3055\u308c\u308b\u3002\n\n```csharp:Hiyoko.cs\n/// <summary>\n/// \u3072\u3088\u3053\u3061\u3083\u3093\n/// </summary>\npublic class Hiyoko : MonoBehaviour {\n\t/// <summary>\n\t/// \u30b2\u30fc\u30e0\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u304b\u3089\u4fdd\u5b58\u3059\u308b\u30c7\u30fc\u30bf\u3092\u53d6\u5f97\u3059\u308b\n\t/// </summary>\n\tpublic HiyokoData Store() {\n\t\tvar t = this.transform;\n\t\tvar p = t.position;\n\t\tHiyokoData hd = new HiyokoData();\n\t\thd.Kind = t.tag == \"Hiyoko\" ? 0 : 1;\n\t\thd.X = p.x;\n\t\thd.Y = p.y;\n\t\thd.Angle = t.localEulerAngles.z;\n\t\treturn hd;\n\t}\n\n\t/// <summary>\n\t/// \u4fdd\u5b58\u3057\u3066\u3042\u308b\u30c7\u30fc\u30bf\u304b\u3089\u30b2\u30fc\u30e0\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u5fa9\u5143\u3059\u308b\n\t/// </summary>\n\tpublic static void Restore(HiyokoData hd) {\n\t\tGameObject.Instantiate(\n\t\t\thd.Kind == 0 ? GameManager.Hiyo : GameManager.MatsuHiyo,\n\t\t\tnew Vector3(hd.X, hd.Y, 0), Quaternion.Euler(0, 0, hd.Angle));\n\t}\n}\n```\n\n# \uff11\uff11\uff0e\u30de\u30a6\u30b9\u64cd\u4f5c\u3067\u30b2\u30fc\u30e0\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u751f\u6210\u3059\u308b\u30af\u30e9\u30b9\n\u30da\u30a4\u30f3\u30c8\u3059\u308b\u3088\u3046\u306b\u30b2\u30fc\u30e0\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u751f\u6210\u3057\u3066\u307f\u308b\u3002\n\n```csharp:Painter.cs\n/// <summary>\n/// \u30da\u30a4\u30f3\u30c8\u3059\u308b\u69d8\u306b\u30b2\u30fc\u30e0\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u751f\u6210\u3059\u308b\n/// </summary>\npublic class Painter : MonoBehaviour {\n\tstatic float _angle;\n\n\tvoid FixedUpdate() {\n\t\tvar mpos = Input.mousePosition;\n\t\tvar position = Camera.main.ScreenToWorldPoint(mpos);\n\t\tposition.z = 0;\n\n\t\t// \u30de\u30a6\u30b9\u5de6\u30dc\u30bf\u30f3\u62bc\u3057\u305f\u3089\u3072\u3088\u3053\u751f\u6210\n\t\tif (Input.GetMouseButton(0)) {\n\t\t\tInstantiate(GameManager.Hiyo, position, Quaternion.Euler(0, 0, _angle));\n\t\t\t_angle += 2;\n\t\t}\n\n\t\t// \u30de\u30a6\u30b9\u53f3\u30dc\u30bf\u30f3\u62bc\u3057\u305f\u3089\u796d\u308a\u3072\u3088\u3053\u751f\u6210\n\t\tif (Input.GetMouseButton(1)) {\n\t\t\tInstantiate(GameManager.MatsuHiyo, position, Quaternion.Euler(0, 0, _angle));\n\t\t\t_angle += 2;\n\t\t}\n\n\t\t// \u30de\u30a6\u30b9\u4e2d\u30dc\u30bf\u30f3\u62bc\u3055\u308c\u305f\u3089\u5168\u3072\u3088\u3053\u524a\u9664\n\t\tif (Input.GetMouseButtonDown(2)) {\n\t\t\tforeach (var obj in GameObject.FindObjectsOfType<GameObject>()) {\n\t\t\t\tvar h = obj.GetComponent<Hiyoko>();\n\t\t\t\tif (h != null) {\n\t\t\t\t\tGameObject.Destroy(obj);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n}\n```\n\n![ss.png](https://qiita-image-store.s3.amazonaws.com/0/124409/e8301366-664d-4f56-b002-712b85782773.png)\n\n\u7d42\u4e86\u3057\u3066\u518d\u8d77\u52d5\u3059\u308b\u3068\u5fa9\u5143\u3055\u308c\u308b\u3002\n\u8d77\u52d5\u3059\u308b\u5ea6\u306b\u63cf\u753b\u9806\u304c\u9006\u306b\u306a\u308b\u3051\u3069\u307e\u3041\u3088\u3057\u3068\u3057\u3088\u3046\u3002\n\n# \uff11\uff12\uff0e\u6700\u5f8c\u306b\u30b5\u30f3\u30d7\u30eb\u30d7\u30ed\u30b0\u30e9\u30e0\u306e\u5f8c\u59cb\u672b\u306b\u3064\u3044\u3066\n\u81ea\u5206\u306eWindows\u74b0\u5883\u3060\u3068**\u300cC:\\Users\\\u30e6\u30fc\u30b6\u30fc\u540d\\AppData\\LocalLow\\xiden\u300d**\u306b\u4fdd\u5b58\u3055\u308c\u305f\u30d5\u30a1\u30a4\u30eb\u304c\u3067\u304d\u308b\u3002\n\u3053\u306e\u30d5\u30a9\u30eb\u30c0\u6d88\u305b\u3070\u5f8c\u59cb\u672b\u5b8c\u4e86\u3002\n\u4f46\u3057\u3053\u308c\u306f\u74b0\u5883\u306b\u3088\u3063\u3066\u7570\u306a\u308b\u3089\u3057\u3044\u306e\u3067\u30ed\u30b0\u306b\u51fa\u529b\u3055\u308c\u305f\u30d1\u30b9\u3067\u5224\u65ad\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n", "tags": ["unity5", "msgpack", "MessagePack", "\u72ec\u81ea\u30c7\u30fc\u30bf\u4fdd\u5b58", "\u6d3e\u751f\u30af\u30e9\u30b9"]}