{"context": " More than 1 year has passed since last update.\n\n\u53c2\u8003URL\nhttp://qiita.com/zembutsu/items/3efb7ebc1d8dba521d3c\nhttp://pocketstudio.jp/log3/2014/05/01/consul_with_dnsmasq_name_resolution/\nhttp://pocketstudio.jp/log3/2014/04/18/what_is_consul/\n\n\u69cb\u6210\n\nconsul01 (server)\n\n\n192.168.50.101\n\n\nconsul02 (client)\n\n\n192.168.50.102\n\n\nconsul03 (client)\n\n\n192.168.50.103\n\n\n\n\nInstall\nwget https://dl.bintray.com/mitchellh/consul/0.4.1_linux_amd64.zip\nunzip 0.4.1_linux_amd64.zip\nmv consul /usr/local/sbin/\nconsul -v\nConsul v0.4.1\nConsul Protocol: 2 (Understands back to: 1)\n\n\nweb-ui(optional)\nwget https://dl.bintray.com/mitchellh/consul/0.4.1_web_ui.zip\nunzip 0.4.1_web_ui.zip\nmkdir -p /opt/consul\nmv dist/ /opt/consul/webui\n\n\n\u8d77\u52d5\n# 1\u53f0\u76ee[server]\n\nconsul agent -server -bootstrap -client=192.168.50.101 -dc=local -node=consul01 -data-dir=/tmp/consul -bind=192.168.50.101 [-ui-dir=/opt/consul/webui/]\n\n# 2\u53f0\u76ee\u4ee5\u964d\nconsul agent -dc=local -node=consul02 -data-dir=/tmp/consul -bind=192.168.50.102 -join=192.168.50.101\n\n\u3053\u3046\u306a\u308b\nconsul members -rpc-addr=192.168.50.101:8400\nNode      Address              Status  Type    Build  Protocol\nconsul01  192.168.50.101:8301  alive   server  0.4.1  2\nconsul02  192.168.50.102:8301  alive   client  0.4.1  2\nconsul03  192.168.50.103:8301  alive   client  0.4.1  2\n\n\ncatalog\n\n\u767b\u9332\ncurl -X PUT -d '{\"Node\":\"master-node\", \"Address\":\"192.168.50.101\"}' http://192.168.50.101:8500/v1/catalog/register\n\n\n\u53c2\u7167\ncurl http://192.168.50.101:8500/v1/catalog/nodes | jq .\n[\n  {\n    \"Address\": \"192.168.50.101\",\n    \"Node\": \"consul01\"\n  },\n  {\n    \"Address\": \"192.168.50.102\",\n    \"Node\": \"consul02\"\n  },\n  {\n    \"Address\": \"192.168.50.103\",\n    \"Node\": \"consul03\"\n  },\n  {\n    \"Address\": \"192.168.50.101\",\n    \"Node\": \"master-node\"\n  }\n]\n\n\nDNS\u30d9\u30fc\u30b9\u306e\u53c2\u7167\ndig @192.168.50.101 -p 8600 master-node.node.local.consul\n\n; <<>> DiG 9.8.2rc1-RedHat-9.8.2-0.30.rc1.el6 <<>> @192.168.50.101 -p 8600 master-node.node.local.consul\n; (1 server found)\n;; global options: +cmd\n;; Got answer:\n;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 4608\n;; flags: qr aa rd; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 0\n;; WARNING: recursion requested but not available\n\n;; QUESTION SECTION:\n;master-node.node.local.consul. IN  A\n\n;; ANSWER SECTION:\nmaster-node.node.local.consul. 0 IN A   192.168.50.101\n\n;; Query time: 1 msec\n;; SERVER: 192.168.50.101#8600(192.168.50.101)\n;; WHEN: Tue Dec  9 23:33:08 2014\n;; MSG SIZE  rcvd: 92\n\n\n\u524a\u9664\ncurl -X PUT -d '{\"Node\":\"master-node\"}' http://192.168.50.101:8500/v1/catalog/deregister\n\n\ndnsmasq\u3067\u540d\u524d\u89e3\u6c7a\u3067\u304d\u308b\u3088\u3046\u306b\u3059\u308b\n\nInstall\nyum install dnsmasq\n\n\n\u8a2d\u5b9a\n\u3053\u3046\u3044\u3046\u3053\u3068\u306a\u306e\u3067\n\n/etc/dnsmasq.conf\n# Add other name servers here, with domain specs if they are for\n# non-public domains.\n#server=/localnet/192.168.0.1\n\n# Example of routing PTR queries to nameservers: this will send all\n# address->name queries for 192.168.3/24 to nameserver 10.1.2.3\n#server=/3.168.192.in-addr.arpa/10.1.2.3\n\n\n\u3053\u3046\u8a2d\u5b9a\u3059\u308b\n\n/etc/dnsmasq.conf\nserver=/consul/192.168.50.101#8600\n\n\n\u3055\u3089\u306b/etc/resolv.conf\u306e\u9806\u5e8f\u3092\u5f37\u5236\u3059\u308b\u305f\u3081\u306b\u4e0b\u8a18\u8a2d\u5b9a\u3082\u3059\u308b\n\n/etc/dnsmasq.conf\nstrict-order\n\n\n/etc/resolv.conf\u3067dnsmasq\u4f7f\u3046\u3088\u3046\u306b\n\n/etc/resolv.conf\nnameserver 127.0.0.1\nnameserver 8.8.8.8\nnameserver 8.8.4.4\n\n\n\u8d77\u52d5\nchkconfig dnsmasq on\nservice dnsmasq start\n\n\n\u7d50\u679c\n\u540d\u524d\u89e3\u6c7a\u3067\u304d\u305f\ndig master-node.node.local.consul\n\n; <<>> DiG 9.8.2rc1-RedHat-9.8.2-0.30.rc1.el6 <<>> master-node.node.local.consul\n;; global options: +cmd\n;; Got answer:\n;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 61303\n;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 0\n\n;; QUESTION SECTION:\n;master-node.node.local.consul. IN  A\n\n;; ANSWER SECTION:\nmaster-node.node.local.consul. 0 IN A   192.168.50.101\n\n;; Query time: 1 msec\n;; SERVER: 127.0.0.1#53(127.0.0.1)\n;; WHEN: Wed Dec 10 00:34:42 2014\n;; MSG SIZE  rcvd: 92\n\n\nTTL\u3082\u8a2d\u5b9a\u3057\u3066\u307f\u308b\n\n/etc/consul.d/dns_config.json\n{\n    \"dns_config\": {\n        \"node_ttl\": \"5s\",\n        \"allow_stale\": false ,\n        \"max_stale\": \"5s\"\n    }\n}\n\n\nconsul agent -server -bootstrap -client=192.168.50.101 -dc=local -node=consul01 -data-dir=/tmp/consul -bind=192.168.50.101 -ui-dir=/opt/consul/webui/ -config-dir=/etc/consul.d/\n\n\n\u5b9f\u9a13\n\n\u3053\u3046\u3044\u3046\u3053\u3068\u3057\u3066\u3082\u4f4e\u8ca0\u8377\u30671msec\u3067\u5fdc\u7b54\u3057\u7d9a\u3051\u305f\u3002\n\nwhile true ; do dig @192.168.50.101 -p 8600 master-node.node.local.consul;done\n\nTTL0\u3067\u3082\u3044\u3051\u308b\u304c\u30015\u79d2\u306b\u3059\u308b\u3060\u3051\u3067consul\u306e\u8ca0\u8377\u304c\u307b\u307c\u306a\u304f\u306a\u308a\u3001\u307b\u307cbash(\u30eb\u30fc\u30d7\u51e6\u7406)\u306e\u8ca0\u8377\u3002\n\n\u540c\u3058key\u3067\u4e0a\u66f8\u304d\u767b\u9332\u3067\u304d\u305f\n\ncurl -X PUT -d '{\"Node\":\"master-node\", \"Address\":\"192.168.50.101\"}' http://192.168.50.101:8500/v1/catalog/register\ntrue\n\ncurl http://192.168.50.101:8500/v1/catalog/nodes | jq .[3]\n{\n  \"Address\": \"192.168.50.101\",\n  \"Node\": \"master-node\"\n}\n\ncurl -X PUT -d '{\"Node\":\"master-node\", \"Address\":\"192.168.50.102\"}' http://192.168.50.101:8500/v1/catalog/register\ntrue\n\ncurl http://192.168.50.101:8500/v1/catalog/nodes | jq .[3]\n{\n  \"Address\": \"192.168.50.102\",\n  \"Node\": \"master-node\"\n}\n\n\n## \u53c2\u8003URL\nhttp://qiita.com/zembutsu/items/3efb7ebc1d8dba521d3c\nhttp://pocketstudio.jp/log3/2014/05/01/consul_with_dnsmasq_name_resolution/\nhttp://pocketstudio.jp/log3/2014/04/18/what_is_consul/\n\n## \u69cb\u6210\n\n- consul01 (server)\n\t- 192.168.50.101\n- consul02 (client)\n\t- 192.168.50.102\n- consul03 (client)\n\t- 192.168.50.103\n\n\n## Install\n\n```\nwget https://dl.bintray.com/mitchellh/consul/0.4.1_linux_amd64.zip\nunzip 0.4.1_linux_amd64.zip\nmv consul /usr/local/sbin/\nconsul -v\nConsul v0.4.1\nConsul Protocol: 2 (Understands back to: 1)\n```\n\n### web-ui(optional)\n\n```\nwget https://dl.bintray.com/mitchellh/consul/0.4.1_web_ui.zip\nunzip 0.4.1_web_ui.zip\nmkdir -p /opt/consul\nmv dist/ /opt/consul/webui\n```\n\n## \u8d77\u52d5\n\n```\n# 1\u53f0\u76ee[server]\n\nconsul agent -server -bootstrap -client=192.168.50.101 -dc=local -node=consul01 -data-dir=/tmp/consul -bind=192.168.50.101 [-ui-dir=/opt/consul/webui/]\n\n# 2\u53f0\u76ee\u4ee5\u964d\nconsul agent -dc=local -node=consul02 -data-dir=/tmp/consul -bind=192.168.50.102 -join=192.168.50.101\n```\n\n\u3053\u3046\u306a\u308b\n\n```\nconsul members -rpc-addr=192.168.50.101:8400\nNode      Address              Status  Type    Build  Protocol\nconsul01  192.168.50.101:8301  alive   server  0.4.1  2\nconsul02  192.168.50.102:8301  alive   client  0.4.1  2\nconsul03  192.168.50.103:8301  alive   client  0.4.1  2\n```\n\n## catalog\n\n### \u767b\u9332\n\n```\ncurl -X PUT -d '{\"Node\":\"master-node\", \"Address\":\"192.168.50.101\"}' http://192.168.50.101:8500/v1/catalog/register\n```\n\n### \u53c2\u7167\n\n```\ncurl http://192.168.50.101:8500/v1/catalog/nodes | jq .\n[\n  {\n    \"Address\": \"192.168.50.101\",\n    \"Node\": \"consul01\"\n  },\n  {\n    \"Address\": \"192.168.50.102\",\n    \"Node\": \"consul02\"\n  },\n  {\n    \"Address\": \"192.168.50.103\",\n    \"Node\": \"consul03\"\n  },\n  {\n    \"Address\": \"192.168.50.101\",\n    \"Node\": \"master-node\"\n  }\n]\n```\n\n### DNS\u30d9\u30fc\u30b9\u306e\u53c2\u7167\n\n```\ndig @192.168.50.101 -p 8600 master-node.node.local.consul\n\n; <<>> DiG 9.8.2rc1-RedHat-9.8.2-0.30.rc1.el6 <<>> @192.168.50.101 -p 8600 master-node.node.local.consul\n; (1 server found)\n;; global options: +cmd\n;; Got answer:\n;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 4608\n;; flags: qr aa rd; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 0\n;; WARNING: recursion requested but not available\n\n;; QUESTION SECTION:\n;master-node.node.local.consul.\tIN\tA\n\n;; ANSWER SECTION:\nmaster-node.node.local.consul. 0 IN\tA\t192.168.50.101\n\n;; Query time: 1 msec\n;; SERVER: 192.168.50.101#8600(192.168.50.101)\n;; WHEN: Tue Dec  9 23:33:08 2014\n;; MSG SIZE  rcvd: 92\n```\n\n### \u524a\u9664\n\n```\ncurl -X PUT -d '{\"Node\":\"master-node\"}' http://192.168.50.101:8500/v1/catalog/deregister\n```\n\n## dnsmasq\u3067\u540d\u524d\u89e3\u6c7a\u3067\u304d\u308b\u3088\u3046\u306b\u3059\u308b\n\n### Install\n\n```\nyum install dnsmasq\n```\n\n### \u8a2d\u5b9a\n\n\u3053\u3046\u3044\u3046\u3053\u3068\u306a\u306e\u3067\n\n``` /etc/dnsmasq.conf\n# Add other name servers here, with domain specs if they are for\n# non-public domains.\n#server=/localnet/192.168.0.1\n\n# Example of routing PTR queries to nameservers: this will send all\n# address->name queries for 192.168.3/24 to nameserver 10.1.2.3\n#server=/3.168.192.in-addr.arpa/10.1.2.3\n```\n\n\u3053\u3046\u8a2d\u5b9a\u3059\u308b\n\n``` /etc/dnsmasq.conf\nserver=/consul/192.168.50.101#8600\n```\n\n\u3055\u3089\u306b`/etc/resolv.conf`\u306e\u9806\u5e8f\u3092\u5f37\u5236\u3059\u308b\u305f\u3081\u306b\u4e0b\u8a18\u8a2d\u5b9a\u3082\u3059\u308b\n\n``` /etc/dnsmasq.conf\nstrict-order\n```\n\n`/etc/resolv.conf`\u3067dnsmasq\u4f7f\u3046\u3088\u3046\u306b\n\n``` /etc/resolv.conf\nnameserver 127.0.0.1\nnameserver 8.8.8.8\nnameserver 8.8.4.4\n```\n\n\u8d77\u52d5\n\n```\nchkconfig dnsmasq on\nservice dnsmasq start\n```\n\n### \u7d50\u679c\n\n\u540d\u524d\u89e3\u6c7a\u3067\u304d\u305f\n\n```\ndig master-node.node.local.consul\n\n; <<>> DiG 9.8.2rc1-RedHat-9.8.2-0.30.rc1.el6 <<>> master-node.node.local.consul\n;; global options: +cmd\n;; Got answer:\n;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 61303\n;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 0\n\n;; QUESTION SECTION:\n;master-node.node.local.consul.\tIN\tA\n\n;; ANSWER SECTION:\nmaster-node.node.local.consul. 0 IN\tA\t192.168.50.101\n\n;; Query time: 1 msec\n;; SERVER: 127.0.0.1#53(127.0.0.1)\n;; WHEN: Wed Dec 10 00:34:42 2014\n;; MSG SIZE  rcvd: 92\n```\n\n### TTL\u3082\u8a2d\u5b9a\u3057\u3066\u307f\u308b\n\n``` /etc/consul.d/dns_config.json\n{\n\t\"dns_config\": {\n\t\t\"node_ttl\": \"5s\",\n\t\t\"allow_stale\": false ,\n\t\t\"max_stale\": \"5s\"\n\t}\n}\n```\n\n```\nconsul agent -server -bootstrap -client=192.168.50.101 -dc=local -node=consul01 -data-dir=/tmp/consul -bind=192.168.50.101 -ui-dir=/opt/consul/webui/ -config-dir=/etc/consul.d/\n```\n\n## \u5b9f\u9a13\n\n- \u3053\u3046\u3044\u3046\u3053\u3068\u3057\u3066\u3082\u4f4e\u8ca0\u8377\u30671msec\u3067\u5fdc\u7b54\u3057\u7d9a\u3051\u305f\u3002\n\n```\nwhile true ; do dig @192.168.50.101 -p 8600 master-node.node.local.consul;done\n```\n\nTTL0\u3067\u3082\u3044\u3051\u308b\u304c\u30015\u79d2\u306b\u3059\u308b\u3060\u3051\u3067consul\u306e\u8ca0\u8377\u304c\u307b\u307c\u306a\u304f\u306a\u308a\u3001\u307b\u307cbash(\u30eb\u30fc\u30d7\u51e6\u7406)\u306e\u8ca0\u8377\u3002\n\n- \u540c\u3058key\u3067\u4e0a\u66f8\u304d\u767b\u9332\u3067\u304d\u305f\n\n```\ncurl -X PUT -d '{\"Node\":\"master-node\", \"Address\":\"192.168.50.101\"}' http://192.168.50.101:8500/v1/catalog/register\ntrue\n\ncurl http://192.168.50.101:8500/v1/catalog/nodes | jq .[3]\n{\n  \"Address\": \"192.168.50.101\",\n  \"Node\": \"master-node\"\n}\n\ncurl -X PUT -d '{\"Node\":\"master-node\", \"Address\":\"192.168.50.102\"}' http://192.168.50.101:8500/v1/catalog/register\ntrue\n\ncurl http://192.168.50.101:8500/v1/catalog/nodes | jq .[3]\n{\n  \"Address\": \"192.168.50.102\",\n  \"Node\": \"master-node\"\n}\n```\n\n", "tags": ["consul", "\u521d\u5fc3\u8005"]}