{"context": "\n\n1 \u306f\u3058\u3081\u306b\n\u3053\u308c\u306f\u3001OpenCV Advent Calendar 2016 7\u65e5\u76ee\u306e\u8a18\u4e8b\u3067\u3059\u3002\u95a2\u9023\u8a18\u4e8b\u306f\u76ee\u6b21\u306b\u307e\u3068\u3081\u3089\u308c\u3066\u3044\u307e\u3059\u3002\n\u672c\u8a18\u4e8b\u306f\u3001\u30a4\u30f3\u30bf\u30d5\u30a7\u30fc\u30b9\u3084\u3001\u904b\u8ee2\u652f\u63f4\u3067\u306e\u30c9\u30e9\u30a4\u30d0\u30fc\u306e\u30e2\u30cb\u30bf\u30fc\u306a\u3069\u306b\u6709\u52b9\u3068\u3055\u308c\u3066\u3044\u308b\u9854\u5411\u304d\u63a8\u5b9a\u3092OpenCV\u3067\u884c\u3046\u305f\u3081\u306e\u8a18\u4e8b\u3067\u3059\u3002\n\u30bf\u30a4\u30c8\u30eb\u306bOpenCV\u3092\u4f7f\u7528\u3057\u305f\u9854\u5411\u304d\u63a8\u5b9a\u3068\u66f8\u3044\u3066\u3044\u307e\u3059\u304c\u3001\u6b8b\u5ff5\u306a\u304c\u3089OpenCV\u3060\u3051\u3067\u306f\u3001\u9854\u5411\u304d\u63a8\u5b9a\u3092\u884c\u3046\u306b\u306f\u7121\u7406\u304c\u3042\u308a\u307e\u3059\u3002\u7279\u306b\u9854\u306e\u7279\u5fb4\u70b9\u306e\u691c\u51fa\u306b\u306f\u3001\u73fe\u5728\u624b\u8efd\u3055\u3068\u305d\u306e\u7cbe\u5ea6\u306b\u304a\u3044\u3066\u3001\u5225\u306eCV\u30e9\u30a4\u30d6\u30e9\u30ea\u3067\u3042\u308bDlib\u3092\u7528\u3044\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\u307e\u305f\u3001\u9854\u306e\uff13\u6b21\u5143\u30e2\u30c7\u30eb\u4e0a\u3067\u306e\u7279\u5fb4\u70b9\u306e\uff13\u6b21\u5ea7\u6a19\u60c5\u5831\u306f\u5fc5\u9808\u3067\u3042\u308a\u3001\u63a8\u5b9a\u7cbe\u5ea6\u5411\u4e0a\u306e\u305f\u3081\u306b\u306f\u3001\u64ae\u5f71\u306b\u4f7f\u7528\u3057\u305f\u30ab\u30e1\u30e9\u306e\u5185\u90e8\u30d1\u30e9\u30e1\u30fc\u30bf\u3082\u5fc5\u8981\u306b\u306a\u308a\u307e\u3059\u3002\u4eca\u56de\u306f\u3001\u9854\u3092\u7279\u5fb4\u70b9\u3068\uff13\u6b21\u5143\u30e2\u30c7\u30eb\u60c5\u5831\u3092\u5165\u624b\u3067\u304d\u3066\u3044\u308b\u3053\u3068\u3092\u524d\u63d0\u3068\u3057\u3001\u8a71\u3092\u9032\u3081\u307e\u3059\u3002\n\u4eca\u56de\u306e\u5143\u8a18\u4e8b\u306f\u3053\u3061\u3089\u3067\u3059\u3002\u672c\u8a18\u4e8b\u3067\u306f\u3001\u30d7\u30ed\u30b0\u30e9\u30e0\u306e\u5b9f\u884c\u306b\u5fc5\u8981\u306a\u9805\u76ee\u306b\u7d5e\u308a\u8a18\u8f09\u3057\u3066\u3044\u308b\u305f\u3081\u3001\u8a73\u7d30\u306a\u8aac\u660e\u304c\u5fc5\u8981\u306a\u5834\u5408\u306f\u3001\u5143\u8a18\u4e8b\u3092\u53c2\u7167\u3057\u3066\u307b\u3057\u3044\u3002Dlib\u3092\u4f7f\u7528\u3059\u308b\u3053\u3068\u3067\u3001\u30ab\u30e1\u30e9\u753b\u50cf\u304b\u3089\u306e\u753b\u50cf\u306b\u5bfe\u3057\u30ea\u30a2\u30eb\u30bf\u30a4\u30e0\u3067\u9854\u5411\u304d\u63a8\u5b9a\u3092\u884c\u3046\u3053\u3068\u304c\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\n\nCV\u306b\u304a\u3051\u308b\u9854\u5411\u304d\u63a8\u5b9a\n\u6b63\u3057\u304f\u306f\u3001\u982d\u90e8\u59ff\u52e2\u63a8\u5b9a\uff08Head Pose Estimation\uff09\u3067\u3059\u304c\u3001\u308f\u304b\u308a\u3084\u3059\u304f\u9854\u5411\u304d\u63a8\u5b9a\u3068\u3057\u3066\u3044\u307e\u3059\u3002CV\u3067\u306f\u3001\u30ab\u30e1\u30e9\u306b\u5bfe\u3057\u982d\u90e8\u306e\u76f8\u5bfe\u7684\u306a\u79fb\u52d5\uff08\u5e73\u884c\u79fb\u52d5\u3068\u56de\u8ee2\u79fb\u52d5\uff09\u3092\u610f\u5473\u3057\u3066\u304a\u308a\u3001\u982d\u90e8\u306e\u79fb\u52d5\u3001\u3042\u308b\u3044\u306f\u3001\u30ab\u30e1\u30e9\u306e\u79fb\u52d5\u306b\u3088\u308a\u6c42\u3081\u308b\u6570\u5b57\u306f\u5909\u5316\u3057\u307e\u3059\u3002\n\u5e73\u884c\u79fb\u52d5\u306f\uff13\u6b21\u5143\u5ea7\u6a19\u5185\u3067\u306e\u3001\u5ea7\u6a19\u306eX,Y,Z\u8ef8\u3067\u306e\u79fb\u52d5\u3067\u3042\u308b\u3002\u56de\u8ee2\u79fb\u52d5\u306f\u3001\u982d\u90e8\u306b\u5bfe\u3057Yow,Pitch,Law\u3068\u547c\u3070\u308c\u308b\u8ef8\u3092\u8a2d\u3051\u3001\u305d\u306e\u8ef8\u3092\u4e2d\u5fc3\u3068\u3057\u305f\u3001\u56de\u8ee2\u3092\u610f\u5473\u3057\u307e\u3059\u3002\u8aac\u660e\u56f3\u306f\u3053\u3061\u3089\u3067\u3059\u3002\n\n\u9854\u306e\u7279\u5fb4\u70b9\u691c\u51fa\n\u9854\u306e\u7279\u5fb4\u70b9\u306f\u3001\u82f1\u8a9e\u3067\u306f\u3001facial landmark\u3068\u547c\u3070\u308c\u3066\u3044\u307e\u3059\u3002OpenCV\u306b\u306f\u3001\u76ee\u3001\u9f3b\u3001\u53e3\u306e\u7279\u5fb4\u70b9\uff08\u6b63\u3057\u304f\u306f\u9818\u57df\uff09\u306e\u691c\u51fa\u7528\u306b\u3001\u306e\u5c02\u7528\u8f9e\u66f8\u304c\u6e96\u5099\u3055\u308c\u3066\u3044\u307e\u3059\u3002\u305d\u308c\u3089\u3092\u4f7f\u7528\u3059\u308b\u3053\u3068\u3067\uff14\u70b9\uff08\u5de6\u76ee\u306e\u4e2d\u5fc3\u70b9\u3001\u53f3\u76ee\u306e\u4e2d\u5fc3\u70b9\u3001\u9f3b\u306e\u4e2d\u5fc3\u70b9\u3001\u53e3\u306e\u4e2d\u5fc3\u70b9\uff09\u306e\u5ea7\u6a19\u3057\u304b\u5f97\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u305b\u3093\u3002\u3042\u3068\u3067\u8ff0\u3079\u307e\u3059\u304c\u3001\u5fc5\u8981\u3068\u3059\u308b\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u63a8\u5b9a\u3059\u308b\u305f\u3081\u306b\u306f\u3001\u6700\u4f4e6\u70b9\u306e\u5ea7\u6a19\u304c\u5fc5\u8981\u3068\u306a\u308b\u305f\u3081\u3001OpneCV\u3067\u306f\u3001\u5c02\u7528\u306b\u8f9e\u66f8\u3092\u4f5c\u6210\u3057\u306a\u3044\u9650\u308a\u30016\u70b9\u306e\u5ea7\u6a19\u3092\u5f97\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u305b\u3093\u3002Dlib\u306f\u3001\u9854\u306e\u7279\u5fb4\u70b9\u3092\u691c\u51fa\u3059\u308b\u305f\u3081\u306e\u5c02\u7528\u306e\u8f9e\u66f8\u3092\u30b5\u30f3\u30d7\u30eb\u30d7\u30ed\u30b0\u30e9\u30e0\u304c\u6e96\u5099\u3055\u308c\u3066\u304a\u308a\u3001\u305d\u308c\u3089\u3092\u4f7f\u7528\u3059\u308b\u3053\u3068\u3067\u5fc5\u8981\u3068\u3059\u308b6\u70b9\u306e\u5ea7\u6a19\u3092\u5f97\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u304c\u3001OpenCV\u3068\u306f\u95a2\u4fc2\u306a\u3044\u305f\u3081\u8aac\u660e\u3092\u7701\u7565\u3057\u307e\u3059\u3002\n\n2 \u8a08\u7b97\u4ed5\u65b9\n\uff13\u6b21\u5143\u304b\u3089\uff12\u6b21\u5143\u3078\u306e\u5c04\u5f71\u5909\u63db\u304c\u57fa\u672c\u3068\u306a\u308a\u3001VR\u3084AR\u3067\u306f\u99b4\u67d3\u307f\u306eDLT\uff08Direct Linear Transform\uff09\u304c\u51fa\u3066\u304d\u307e\u3059\u304c\u3001\u8a73\u3057\u304f\u306a\u3044\u306e\u3067\u8aac\u660e\u306f\u7701\u304d\u307e\u3059\u3002\n\u5e73\u884c\u79fb\u52d5\u3068\u56de\u8ee2\u79fb\u52d5\u306e\uff16\u3064\u306e\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u6c42\u3081\u308b\u305f\u3081\u306b\u3001\u6700\u4f4e\u3067\u3082\uff16\u70b9\u306e\u70b9\u304c\u5fc5\u8981\u306b\u306a\u308a\u307e\u3059\u3002\u4eca\u56de\u306f\u3001\u5de6\u76ee\u7aef\u70b9\u3001\u53f3\u76ee\u7aef\u70b9\u3001\u9f3b\u9802\u70b9\u3001\u53e3\u5de6\u7aef\u3001\u53e3\u53f3\u7aef\u3001\u984e\u306e\u5148\u306e\uff16\u3064\u306e\u70b9\u3092\u4f7f\u7528\u3057\u307e\u3059\u3002\u5177\u4f53\u7684\u306e\u3069\u3053\u306e\u5834\u6240\u304b\u306f\u3001\u539f\u6587\u306e\u8aac\u660e\u56f3\u3092\u898b\u3066\u304f\u3060\u3055\u3044\u3002\n\u3053\u308c\u3089\u306e\uff16\u70b9\u306e\uff13\u6b21\u5143\u5ea7\u6a19\u4e0a\u3067\u306e\u5ea7\u6a19\u3068\uff12\u6b21\u5143\u4e0a\u3067\u306e\u5ea7\u6a19\u3068\u30ab\u30e1\u30e9\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u5f15\u6570\u3068\u3057\u3001\u304a\u306a\u3058\u307f\u306ecv::solvePnP \u95a2\u6570\u3092\u4f7f\u7528\u3057\u3001\u56de\u8ee2\u30d9\u30af\u30c8\u30eb\u3068\u3001\u5e73\u884c\u79fb\u52d5\u30d9\u30af\u30c8\u30eb\u3092\u6c42\u3081\u308b\u307e\u3059\u3002\n\n2.1 \u539f\u6587\u306ec++\u30b5\u30f3\u30d7\u30eb\u306e\u7c21\u5358\u89e3\u8aac\n\u539f\u6587\u3067\u306e\u30b5\u30f3\u30d7\u30eb\u30d7\u30ed\u30b0\u30e9\u30e0\u306e\u30dd\u30a4\u30f3\u30c8\u306e\u307f\u8aac\u660e\u3057\u307e\u3059\u3002\n\u30fbstd::vector cv::Point2d image_points\u3000\u306b\u3000\uff12\u6b21\u5143\u753b\u50cf\u4e0a\uff16\u70b9\uff08Dlib\u3067\u53d6\u5f97\uff09\u306e\u5ea7\u6a19\u3092\u8a2d\u5b9a\u3057\u3066\u3044\u307e\u3059\n    image_points.push_back( cv::Point2d(359, 391) );  // \u9f3b\u5148\n    image_points.push_back( cv::Point2d(399, 561) );  // \u984e\n    image_points.push_back( cv::Point2d(337, 297) );\u3000// \u5de6\u76ee\u7aef\u70b9\n    image_points.push_back( cv::Point2d(513, 301) );  // \u53f3\u76ee\u7aef\u70b9\n    image_points.push_back( cv::Point2d(345, 465) );  // \u53e3\u5de6\u7aef\n    image_points.push_back( cv::Point2d(453, 469) );  // \u53e3\u53f3\u7aef\n\n\u30fbstd::vector cv::Point3d model_points\u3000\u306b\u3000\uff13\u6b21\u5143\u30e2\u30c7\u30eb\u306e\uff16\u70b9\u306e\u5ea7\u6a19\u3092\u8a2d\u5b9a\u3057\u3066\u3044\u307e\u3059\n    model_points.push_back(cv::Point3d(0.0f, 0.0f, 0.0f));               // \u9f3b\u5148\n    model_points.push_back(cv::Point3d(0.0f, -330.0f, -65.0f));          // \u984e\n    model_points.push_back(cv::Point3d(-225.0f, 170.0f, -135.0f));       // \u5de6\u76ee\u7aef\u70b9\n    model_points.push_back(cv::Point3d(225.0f, 170.0f, -135.0f));        // \u53f3\u76ee\u7aef\u70b9\n    model_points.push_back(cv::Point3d(-150.0f, -150.0f, -125.0f));      // \u53e3\u5de6\u7aef\n    model_points.push_back(cv::Point3d(150.0f, -150.0f, -125.0f));       // \u53e3\u53f3\u7aef\n\n\u30fb\u30ab\u30e1\u30e9\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u8a2d\u5b9a\u3002\u6b63\u3057\u3044\u30d1\u30e9\u30e1\u30fc\u30bf\u3067\u306f\u306a\u304f\u3001\u3072\u305a\u307f\u306e\u306a\u3044\u7406\u60f3\u30e2\u30c7\u30eb\u3092\u8a2d\u5b9a\u3057\u3066\u3044\u307e\u3059\u3002\n    double focal_length = im.cols;\n    Point2d center = cv::Point2d(im.cols/2,im.rows/2);\n    cv::Mat camera_matrix = (cv::Mat_<double>(3,3) << focal_length, 0, center.x, 0 , focal_length, center.y, 0, 0, 1);\n    cv::Mat dist_coeffs = cv::Mat::zeros(4,1,cv::DataType<double>::type); // \u6b6a\u306a\u3057\n\n\u30fbcv::solvePnP\u306b\u3088\u308b\u63a8\u5b9a\n\u3000\u7d50\u679c\u306f\u3001cv::Mat rotation_vector\u3068translation_vector\u306b\u683c\u7d0d\u3055\u308c\u307e\u3059\n    cv::solvePnP(model_points, image_points, camera_matrix, dist_coeffs, rotation_vector, translation_vector);\n\n\u30fb\u9f3b\u306e\u6cd5\u7dda\u306e\u7aef\u70b9\u3092\uff12\u6b21\u5143\u4e0a\u306b\u5c04\u5f71\u3057\u305f\u5ea7\u6a19\u3092\u8a08\u7b97\n    projectPoints(nose_end_point3D, rotation_vector, translation_vector, camera_matrix, dist_coeffs, nose_end_point2D);\n\n\u30fb\u9854\u5411\u304d\u3092\u610f\u5473\u3059\u308b\u76f4\u7dda\u3092\u63cf\u753b\n    cv::line(im,image_points[0], nose_end_point2D[0], cv::Scalar(255,0,0), 2);\n\n\n3 \u56de\u8ee2\u89d2\u5ea6\u306e\u53d6\u5f97\nYaw, Pitch , Roll \u305d\u308c\u305e\u308c\u4f55\u5ea6\u56de\u8ee2\u3057\u3066\u3044\u308b\u306e\u304b\u53d6\u5f97\u3059\u308b\u306b\u306f\u3001\u4ee5\u4e0b\u306e\u51e6\u7406\u3092\u8ffd\u52a0\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\n3.1 \u56de\u8ee2\u30d9\u30af\u30c8\u30eb\u304b\u3089\u56de\u8ee2\u884c\u5217\u3078\u306e\u5909\u63db\nRodrigues\u3092\u4f7f\u7528\u3057\u307e\u3059\u3002\u3053\u308c\u306b\u3088\u308a3x1\u306e\u30d9\u30af\u30c8\u30eb\u304b\u30893x3\u306e\u884c\u5217\u306b\u5909\u63db\u3055\u308c\u307e\u3059\u3002\n    cv::Rodrigues(rotation_vector, rotation_matrix);\n\n\n3.2 \u884c\u5217\u306e\u62e1\u5927 3x3\u304b\u3089 3x4\u306b\n    double* _r = rotCamerMatrix.ptr<double>();\n    double projMatrix[12] = {_r[0],_r[1],_r[2],0,_r[3],_r[4],_r[5],0,_r[6],_r[7],_r[8],0};\n    projMat = cv::Mat(3,4,CV_64FC1,projMatrix);\n\n\n3.3 \u30aa\u30a4\u30e9\u30fc\u89d2\u3078\u306e\u5909\u63db\ndecomposeProjectionMatrix\u3092\u4f7f\u7528\u3057\u307e\u3059\u3002\u6700\u5f8c\u306eeulerAngles\u306b\u5fc5\u8981\u3068\u3059\u308b\u89d2\u5ea6\u60c5\u5831\u304c\u683c\u7d0d\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n    decomposeProjectionMatrix(projMat, cameraMatrix, rotation_matrix, translation_vector, \n    rotMatrixX, rotMatrixY, rotMatrixZ, eulerAngles)\n\n\u6c42\u3081\u308b\u89d2\u5ea6\u306f\u3001\u4ee5\u4e0b\u306e\u7528\u306b\u306a\u308a\u307e\u3059\u3002index\u306e\u756a\u53f7\u306e\u4e26\u3073\u306b\u6ce8\u610f\n    yaw   = eulerAngles[1]; \n    pitch = eulerAngles[0];\n    roll  = eulerAngles[2];\n\n\n3.4 \u52d5\u4f5c\u7d50\u679c\n\u3000\u52d5\u4f5c\u74b0\u5883\u3000Windows7 64bit + OpenCV 2.4.13.1\n\u3000\u4f7f\u7528\u3057\u305f\u753b\u50cf\u306f\u3001\u539f\u6587\u3067\u7528\u3044\u3089\u308c\u3066\u3044\u308b\u3082\u306e\u3067\u3059\u3002\u30b5\u30f3\u30d7\u30eb\u540c\u69d8\u306b\u7279\u5fb4\u70b9\u3068\u30ac\u30a4\u30c9\u7dda\u3092\u63cf\u753b\u3057\u3066\u3044\u307e\u3059\u3002\n\u3000\u30b3\u30f3\u30bd\u30fc\u30eb\u306b\u3001\u89d2\u5ea6\u306e\u5024\u3092\u8868\u793a\u3057\u3066\u3044\u308b\u306e\u306f\u3001\u30b5\u30f3\u30d7\u30eb\u306b\u8ffd\u52a0\u3057\u305f\u90e8\u5206\u3067\u3059\u3002\n\u3000\u3000\n\n4 \u304a\u308f\u308a\u306b\n\u624b\u629c\u304d\u611f\u6e80\u8f09\u306e\u8a18\u4e8b\u306b\u307e\u308a\u307e\u3057\u305f\u3002\u5b9f\u306f\u3001rotation_vector\u304b\u3089\u89d2\u5ea6\u306e\u8a08\u7b97\u306e\u4ed5\u65b9\u304c\u308f\u304b\u3089\u305a\u3001\u82e6\u3057\u307f\u307e\u3057\u305f\u3002OpenCV\u3067\u9854\u5411\u304d\u63a8\u5b9a\u3092\u884c\u3046\u3084\u308a\u65b9\u3092\u898b\u3064\u3051\u305f\u306e\u306f\u3001\u6570\u6642\u9593\u524d\u3067\u3042\u3063\u305f\u305f\u3081\u6025\u3044\u3067\u6587\u7ae0\u3092\u66f8\u304d\u307e\u3057\u305f\u3002\u30b5\u30f3\u30d7\u30eb\u30d7\u30ed\u30b0\u30e9\u30e0\u306f\u3001\u52d5\u4f5c\u3057\u3066\u3044\u307e\u3059\u304c\u3001\u672c\u5f53\u306e\u5024(ground truth)\u304c\u308f\u304b\u3089\u306a\u3044\u305f\u3081\u3001\u6b63\u3057\u3044\u5024\u304c\u5f97\u3089\u308c\u3066\u3044\u308b\u304b\u4eca\u3072\u3068\u3064\u78ba\u8a3c\u304c\u5f97\u3089\u308c\u3066\u3044\u307e\u305b\u3093\u3002\u3044\u305a\u308c\u8ffd\u52a0\u306e\u60c5\u5831\u3092Blog\u306b\u8a18\u8f09\u3059\u308b\u4e88\u5b9a\u3067\u3059\u3002\n\u660e\u65e5\u306f\u3001negi111111\u3055\u3093\u306eOpenCV DNN\u306eiOS\u3067\u306e\u5229\u7528\u3068\u305d\u306e\u6bd4\u8f03\u306b\u3064\u3044\u3066\u3067\u3059\u3002\n\u4ee5\u4e0a  \n#1 \u306f\u3058\u3081\u306b\n\u3053\u308c\u306f\u3001OpenCV Advent Calendar 2016 7\u65e5\u76ee\u306e\u8a18\u4e8b\u3067\u3059\u3002\u95a2\u9023\u8a18\u4e8b\u306f[\u76ee\u6b21](http://qiita.com/advent-calendar/2016/opencv)\u306b\u307e\u3068\u3081\u3089\u308c\u3066\u3044\u307e\u3059\u3002\n\n\u672c\u8a18\u4e8b\u306f\u3001\u30a4\u30f3\u30bf\u30d5\u30a7\u30fc\u30b9\u3084\u3001[\u904b\u8ee2\u652f\u63f4\u3067\u306e\u30c9\u30e9\u30a4\u30d0\u30fc\u306e\u30e2\u30cb\u30bf\u30fc](http://www.automobilemag.com/news/volvo-driver-state-estimation-monitoring-sensors/)\u306a\u3069\u306b\u6709\u52b9\u3068\u3055\u308c\u3066\u3044\u308b\u9854\u5411\u304d\u63a8\u5b9a\u3092OpenCV\u3067\u884c\u3046\u305f\u3081\u306e\u8a18\u4e8b\u3067\u3059\u3002\n\n\u30bf\u30a4\u30c8\u30eb\u306bOpenCV\u3092\u4f7f\u7528\u3057\u305f\u9854\u5411\u304d\u63a8\u5b9a\u3068\u66f8\u3044\u3066\u3044\u307e\u3059\u304c\u3001\u6b8b\u5ff5\u306a\u304c\u3089OpenCV\u3060\u3051\u3067\u306f\u3001\u9854\u5411\u304d\u63a8\u5b9a\u3092\u884c\u3046\u306b\u306f\u7121\u7406\u304c\u3042\u308a\u307e\u3059\u3002\u7279\u306b\u9854\u306e\u7279\u5fb4\u70b9\u306e\u691c\u51fa\u306b\u306f\u3001\u73fe\u5728\u624b\u8efd\u3055\u3068\u305d\u306e\u7cbe\u5ea6\u306b\u304a\u3044\u3066\u3001\u5225\u306eCV\u30e9\u30a4\u30d6\u30e9\u30ea\u3067\u3042\u308b[Dlib](http://dlib.net/)\u3092\u7528\u3044\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\u307e\u305f\u3001\u9854\u306e\uff13\u6b21\u5143\u30e2\u30c7\u30eb\u4e0a\u3067\u306e\u7279\u5fb4\u70b9\u306e\uff13\u6b21\u5ea7\u6a19\u60c5\u5831\u306f\u5fc5\u9808\u3067\u3042\u308a\u3001\u63a8\u5b9a\u7cbe\u5ea6\u5411\u4e0a\u306e\u305f\u3081\u306b\u306f\u3001\u64ae\u5f71\u306b\u4f7f\u7528\u3057\u305f\u30ab\u30e1\u30e9\u306e\u5185\u90e8\u30d1\u30e9\u30e1\u30fc\u30bf\u3082\u5fc5\u8981\u306b\u306a\u308a\u307e\u3059\u3002\u4eca\u56de\u306f\u3001\u9854\u3092\u7279\u5fb4\u70b9\u3068\uff13\u6b21\u5143\u30e2\u30c7\u30eb\u60c5\u5831\u3092\u5165\u624b\u3067\u304d\u3066\u3044\u308b\u3053\u3068\u3092\u524d\u63d0\u3068\u3057\u3001\u8a71\u3092\u9032\u3081\u307e\u3059\u3002\n\n\u4eca\u56de\u306e[\u5143\u8a18\u4e8b\u306f\u3053\u3061\u3089](http://www.learnopencv.com/head-pose-estimation-using-opencv-and-dlib/)\u3067\u3059\u3002\u672c\u8a18\u4e8b\u3067\u306f\u3001\u30d7\u30ed\u30b0\u30e9\u30e0\u306e\u5b9f\u884c\u306b\u5fc5\u8981\u306a\u9805\u76ee\u306b\u7d5e\u308a\u8a18\u8f09\u3057\u3066\u3044\u308b\u305f\u3081\u3001\u8a73\u7d30\u306a\u8aac\u660e\u304c\u5fc5\u8981\u306a\u5834\u5408\u306f\u3001\u5143\u8a18\u4e8b\u3092\u53c2\u7167\u3057\u3066\u307b\u3057\u3044\u3002Dlib\u3092\u4f7f\u7528\u3059\u308b\u3053\u3068\u3067\u3001\u30ab\u30e1\u30e9\u753b\u50cf\u304b\u3089\u306e\u753b\u50cf\u306b\u5bfe\u3057[\u30ea\u30a2\u30eb\u30bf\u30a4\u30e0\u3067\u9854\u5411\u304d\u63a8\u5b9a](https://www.youtube.com/watch?v=NIgKWr4OxoE)\u3092\u884c\u3046\u3053\u3068\u304c\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\n\n### CV\u306b\u304a\u3051\u308b\u9854\u5411\u304d\u63a8\u5b9a\n\u6b63\u3057\u304f\u306f\u3001\u982d\u90e8\u59ff\u52e2\u63a8\u5b9a\uff08Head Pose Estimation\uff09\u3067\u3059\u304c\u3001\u308f\u304b\u308a\u3084\u3059\u304f\u9854\u5411\u304d\u63a8\u5b9a\u3068\u3057\u3066\u3044\u307e\u3059\u3002CV\u3067\u306f\u3001\u30ab\u30e1\u30e9\u306b\u5bfe\u3057\u982d\u90e8\u306e\u76f8\u5bfe\u7684\u306a\u79fb\u52d5\uff08\u5e73\u884c\u79fb\u52d5\u3068\u56de\u8ee2\u79fb\u52d5\uff09\u3092\u610f\u5473\u3057\u3066\u304a\u308a\u3001\u982d\u90e8\u306e\u79fb\u52d5\u3001\u3042\u308b\u3044\u306f\u3001\u30ab\u30e1\u30e9\u306e\u79fb\u52d5\u306b\u3088\u308a\u6c42\u3081\u308b\u6570\u5b57\u306f\u5909\u5316\u3057\u307e\u3059\u3002\n\n\u5e73\u884c\u79fb\u52d5\u306f\uff13\u6b21\u5143\u5ea7\u6a19\u5185\u3067\u306e\u3001\u5ea7\u6a19\u306eX,Y,Z\u8ef8\u3067\u306e\u79fb\u52d5\u3067\u3042\u308b\u3002\u56de\u8ee2\u79fb\u52d5\u306f\u3001\u982d\u90e8\u306b\u5bfe\u3057Yow,Pitch,Law\u3068\u547c\u3070\u308c\u308b\u8ef8\u3092\u8a2d\u3051\u3001\u305d\u306e\u8ef8\u3092\u4e2d\u5fc3\u3068\u3057\u305f\u3001\u56de\u8ee2\u3092\u610f\u5473\u3057\u307e\u3059\u3002[\u8aac\u660e\u56f3](https://www.researchgate.net/figure/279291928_fig1_Fig-1-Orientation-of-the-head-in-terms-of-pitch-roll-and-yaw-movements-describing)\u306f\u3053\u3061\u3089\u3067\u3059\u3002\n\n### \u9854\u306e\u7279\u5fb4\u70b9\u691c\u51fa\n\u9854\u306e\u7279\u5fb4\u70b9\u306f\u3001\u82f1\u8a9e\u3067\u306f\u3001facial landmark\u3068\u547c\u3070\u308c\u3066\u3044\u307e\u3059\u3002OpenCV\u306b\u306f\u3001\u76ee\u3001\u9f3b\u3001\u53e3\u306e\u7279\u5fb4\u70b9\uff08\u6b63\u3057\u304f\u306f\u9818\u57df\uff09\u306e\u691c\u51fa\u7528\u306b\u3001\u306e\u5c02\u7528\u8f9e\u66f8\u304c\u6e96\u5099\u3055\u308c\u3066\u3044\u307e\u3059\u3002\u305d\u308c\u3089\u3092\u4f7f\u7528\u3059\u308b\u3053\u3068\u3067\uff14\u70b9\uff08\u5de6\u76ee\u306e\u4e2d\u5fc3\u70b9\u3001\u53f3\u76ee\u306e\u4e2d\u5fc3\u70b9\u3001\u9f3b\u306e\u4e2d\u5fc3\u70b9\u3001\u53e3\u306e\u4e2d\u5fc3\u70b9\uff09\u306e\u5ea7\u6a19\u3057\u304b\u5f97\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u305b\u3093\u3002\u3042\u3068\u3067\u8ff0\u3079\u307e\u3059\u304c\u3001\u5fc5\u8981\u3068\u3059\u308b\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u63a8\u5b9a\u3059\u308b\u305f\u3081\u306b\u306f\u3001\u6700\u4f4e6\u70b9\u306e\u5ea7\u6a19\u304c\u5fc5\u8981\u3068\u306a\u308b\u305f\u3081\u3001OpneCV\u3067\u306f\u3001\u5c02\u7528\u306b\u8f9e\u66f8\u3092\u4f5c\u6210\u3057\u306a\u3044\u9650\u308a\u30016\u70b9\u306e\u5ea7\u6a19\u3092\u5f97\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u305b\u3093\u3002Dlib\u306f\u3001\u9854\u306e\u7279\u5fb4\u70b9\u3092\u691c\u51fa\u3059\u308b\u305f\u3081\u306e\u5c02\u7528\u306e\u8f9e\u66f8\u3092\u30b5\u30f3\u30d7\u30eb\u30d7\u30ed\u30b0\u30e9\u30e0\u304c\u6e96\u5099\u3055\u308c\u3066\u304a\u308a\u3001\u305d\u308c\u3089\u3092\u4f7f\u7528\u3059\u308b\u3053\u3068\u3067\u5fc5\u8981\u3068\u3059\u308b6\u70b9\u306e\u5ea7\u6a19\u3092\u5f97\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u304c\u3001OpenCV\u3068\u306f\u95a2\u4fc2\u306a\u3044\u305f\u3081\u8aac\u660e\u3092\u7701\u7565\u3057\u307e\u3059\u3002\n\n# 2 \u8a08\u7b97\u4ed5\u65b9\n\uff13\u6b21\u5143\u304b\u3089\uff12\u6b21\u5143\u3078\u306e\u5c04\u5f71\u5909\u63db\u304c\u57fa\u672c\u3068\u306a\u308a\u3001VR\u3084AR\u3067\u306f\u99b4\u67d3\u307f\u306eDLT\uff08Direct Linear Transform\uff09\u304c\u51fa\u3066\u304d\u307e\u3059\u304c\u3001\u8a73\u3057\u304f\u306a\u3044\u306e\u3067\u8aac\u660e\u306f\u7701\u304d\u307e\u3059\u3002\n\n\u5e73\u884c\u79fb\u52d5\u3068\u56de\u8ee2\u79fb\u52d5\u306e\uff16\u3064\u306e\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u6c42\u3081\u308b\u305f\u3081\u306b\u3001\u6700\u4f4e\u3067\u3082\uff16\u70b9\u306e\u70b9\u304c\u5fc5\u8981\u306b\u306a\u308a\u307e\u3059\u3002\u4eca\u56de\u306f\u3001\u5de6\u76ee\u7aef\u70b9\u3001\u53f3\u76ee\u7aef\u70b9\u3001\u9f3b\u9802\u70b9\u3001\u53e3\u5de6\u7aef\u3001\u53e3\u53f3\u7aef\u3001\u984e\u306e\u5148\u306e\uff16\u3064\u306e\u70b9\u3092\u4f7f\u7528\u3057\u307e\u3059\u3002\u5177\u4f53\u7684\u306e\u3069\u3053\u306e\u5834\u6240\u304b\u306f\u3001[\u539f\u6587\u306e\u8aac\u660e\u56f3](http://www.learnopencv.com/wp-content/uploads/2016/09/pose-estimation-requirements-opencv.jpg)\u3092\u898b\u3066\u304f\u3060\u3055\u3044\u3002\n\n\u3053\u308c\u3089\u306e\uff16\u70b9\u306e\uff13\u6b21\u5143\u5ea7\u6a19\u4e0a\u3067\u306e\u5ea7\u6a19\u3068\uff12\u6b21\u5143\u4e0a\u3067\u306e\u5ea7\u6a19\u3068\u30ab\u30e1\u30e9\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u5f15\u6570\u3068\u3057\u3001\u304a\u306a\u3058\u307f\u306ecv::solvePnP \u95a2\u6570\u3092\u4f7f\u7528\u3057\u3001\u56de\u8ee2\u30d9\u30af\u30c8\u30eb\u3068\u3001\u5e73\u884c\u79fb\u52d5\u30d9\u30af\u30c8\u30eb\u3092\u6c42\u3081\u308b\u307e\u3059\u3002\n\n## 2.1 \u539f\u6587\u306ec++\u30b5\u30f3\u30d7\u30eb\u306e\u7c21\u5358\u89e3\u8aac\n\u539f\u6587\u3067\u306e\u30b5\u30f3\u30d7\u30eb\u30d7\u30ed\u30b0\u30e9\u30e0\u306e\u30dd\u30a4\u30f3\u30c8\u306e\u307f\u8aac\u660e\u3057\u307e\u3059\u3002\n\n\u30fbstd::vector <cv::Point2d> image_points\u3000\u306b\u3000\uff12\u6b21\u5143\u753b\u50cf\u4e0a\uff16\u70b9\uff08Dlib\u3067\u53d6\u5f97\uff09\u306e\u5ea7\u6a19\u3092\u8a2d\u5b9a\u3057\u3066\u3044\u307e\u3059\n\n```\n    image_points.push_back( cv::Point2d(359, 391) );  // \u9f3b\u5148\n    image_points.push_back( cv::Point2d(399, 561) );  // \u984e\n    image_points.push_back( cv::Point2d(337, 297) );\u3000// \u5de6\u76ee\u7aef\u70b9\n    image_points.push_back( cv::Point2d(513, 301) );  // \u53f3\u76ee\u7aef\u70b9\n    image_points.push_back( cv::Point2d(345, 465) );  // \u53e3\u5de6\u7aef\n    image_points.push_back( cv::Point2d(453, 469) );  // \u53e3\u53f3\u7aef\n```\n\n\u30fbstd::vector <cv::Point3d> model_points\u3000\u306b\u3000\uff13\u6b21\u5143\u30e2\u30c7\u30eb\u306e\uff16\u70b9\u306e\u5ea7\u6a19\u3092\u8a2d\u5b9a\u3057\u3066\u3044\u307e\u3059\n\n```\n    model_points.push_back(cv::Point3d(0.0f, 0.0f, 0.0f));               // \u9f3b\u5148\n    model_points.push_back(cv::Point3d(0.0f, -330.0f, -65.0f));          // \u984e\n    model_points.push_back(cv::Point3d(-225.0f, 170.0f, -135.0f));       // \u5de6\u76ee\u7aef\u70b9\n    model_points.push_back(cv::Point3d(225.0f, 170.0f, -135.0f));        // \u53f3\u76ee\u7aef\u70b9\n    model_points.push_back(cv::Point3d(-150.0f, -150.0f, -125.0f));      // \u53e3\u5de6\u7aef\n    model_points.push_back(cv::Point3d(150.0f, -150.0f, -125.0f));       // \u53e3\u53f3\u7aef\n```\n\n\u30fb\u30ab\u30e1\u30e9\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u8a2d\u5b9a\u3002\u6b63\u3057\u3044\u30d1\u30e9\u30e1\u30fc\u30bf\u3067\u306f\u306a\u304f\u3001\u3072\u305a\u307f\u306e\u306a\u3044\u7406\u60f3\u30e2\u30c7\u30eb\u3092\u8a2d\u5b9a\u3057\u3066\u3044\u307e\u3059\u3002\n\n```\n    double focal_length = im.cols;\n    Point2d center = cv::Point2d(im.cols/2,im.rows/2);\n    cv::Mat camera_matrix = (cv::Mat_<double>(3,3) << focal_length, 0, center.x, 0 , focal_length, center.y, 0, 0, 1);\n    cv::Mat dist_coeffs = cv::Mat::zeros(4,1,cv::DataType<double>::type); // \u6b6a\u306a\u3057\n```\n\n\u30fbcv::solvePnP\u306b\u3088\u308b\u63a8\u5b9a\n\u3000\u7d50\u679c\u306f\u3001cv::Mat rotation_vector\u3068translation_vector\u306b\u683c\u7d0d\u3055\u308c\u307e\u3059\n\n```\n    cv::solvePnP(model_points, image_points, camera_matrix, dist_coeffs, rotation_vector, translation_vector);\n```\n\u30fb\u9f3b\u306e\u6cd5\u7dda\u306e\u7aef\u70b9\u3092\uff12\u6b21\u5143\u4e0a\u306b\u5c04\u5f71\u3057\u305f\u5ea7\u6a19\u3092\u8a08\u7b97\n\n```\n    projectPoints(nose_end_point3D, rotation_vector, translation_vector, camera_matrix, dist_coeffs, nose_end_point2D);\n```\n\n\n\u30fb\u9854\u5411\u304d\u3092\u610f\u5473\u3059\u308b\u76f4\u7dda\u3092\u63cf\u753b\n\n```\n    cv::line(im,image_points[0], nose_end_point2D[0], cv::Scalar(255,0,0), 2);\n```\n\n# 3 \u56de\u8ee2\u89d2\u5ea6\u306e\u53d6\u5f97\nYaw, Pitch , Roll \u305d\u308c\u305e\u308c\u4f55\u5ea6\u56de\u8ee2\u3057\u3066\u3044\u308b\u306e\u304b\u53d6\u5f97\u3059\u308b\u306b\u306f\u3001\u4ee5\u4e0b\u306e\u51e6\u7406\u3092\u8ffd\u52a0\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\n### 3.1 \u56de\u8ee2\u30d9\u30af\u30c8\u30eb\u304b\u3089\u56de\u8ee2\u884c\u5217\u3078\u306e\u5909\u63db\n[Rodrigues](http://docs.opencv.org/2.4/modules/calib3d/doc/camera_calibration_and_3d_reconstruction.html#rodrigues)\u3092\u4f7f\u7528\u3057\u307e\u3059\u3002\u3053\u308c\u306b\u3088\u308a3x1\u306e\u30d9\u30af\u30c8\u30eb\u304b\u30893x3\u306e\u884c\u5217\u306b\u5909\u63db\u3055\u308c\u307e\u3059\u3002\n\n```\n    cv::Rodrigues(rotation_vector, rotation_matrix);\n```\n### 3.2 \u884c\u5217\u306e\u62e1\u5927 3x3\u304b\u3089 3x4\u306b\n\n```\n    double* _r = rotCamerMatrix.ptr<double>();\n    double projMatrix[12] = {_r[0],_r[1],_r[2],0,_r[3],_r[4],_r[5],0,_r[6],_r[7],_r[8],0};\n    projMat = cv::Mat(3,4,CV_64FC1,projMatrix);\n```\n### 3.3 \u30aa\u30a4\u30e9\u30fc\u89d2\u3078\u306e\u5909\u63db\n[decomposeProjectionMatrix](http://docs.opencv.org/2.4/modules/calib3d/doc/camera_calibration_and_3d_reconstruction.html#decomposeprojectionmatrix)\u3092\u4f7f\u7528\u3057\u307e\u3059\u3002\u6700\u5f8c\u306eeulerAngles\u306b\u5fc5\u8981\u3068\u3059\u308b\u89d2\u5ea6\u60c5\u5831\u304c\u683c\u7d0d\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n\n\n```\n\tdecomposeProjectionMatrix(projMat, cameraMatrix, rotation_matrix, translation_vector, \n\trotMatrixX, rotMatrixY, rotMatrixZ, eulerAngles)\n```\n\u6c42\u3081\u308b\u89d2\u5ea6\u306f\u3001\u4ee5\u4e0b\u306e\u7528\u306b\u306a\u308a\u307e\u3059\u3002index\u306e\u756a\u53f7\u306e\u4e26\u3073\u306b\u6ce8\u610f\n\n```\n    yaw   = eulerAngles[1]; \n    pitch = eulerAngles[0];\n    roll  = eulerAngles[2];\n```\n###3.4 \u52d5\u4f5c\u7d50\u679c\n\u3000\u52d5\u4f5c\u74b0\u5883\u3000Windows7 64bit + OpenCV 2.4.13.1\n\u3000[\u4f7f\u7528\u3057\u305f\u753b\u50cf](http://www.learnopencv.com/wp-content/uploads/2016/09/headPose.jpg)\u306f\u3001\u539f\u6587\u3067\u7528\u3044\u3089\u308c\u3066\u3044\u308b\u3082\u306e\u3067\u3059\u3002\u30b5\u30f3\u30d7\u30eb\u540c\u69d8\u306b\u7279\u5fb4\u70b9\u3068\u30ac\u30a4\u30c9\u7dda\u3092\u63cf\u753b\u3057\u3066\u3044\u307e\u3059\u3002\n\u3000\u30b3\u30f3\u30bd\u30fc\u30eb\u306b\u3001\u89d2\u5ea6\u306e\u5024\u3092\u8868\u793a\u3057\u3066\u3044\u308b\u306e\u306f\u3001\u30b5\u30f3\u30d7\u30eb\u306b\u8ffd\u52a0\u3057\u305f\u90e8\u5206\u3067\u3059\u3002\n\t\n\u3000\u3000![adpic.PNG](https://qiita-image-store.s3.amazonaws.com/0/105738/d5617a03-dab0-d518-95d6-2b8fc676b0b0.png)\n\n# 4 \u304a\u308f\u308a\u306b\n\u624b\u629c\u304d\u611f\u6e80\u8f09\u306e\u8a18\u4e8b\u306b\u307e\u308a\u307e\u3057\u305f\u3002\u5b9f\u306f\u3001rotation_vector\u304b\u3089\u89d2\u5ea6\u306e\u8a08\u7b97\u306e\u4ed5\u65b9\u304c\u308f\u304b\u3089\u305a\u3001\u82e6\u3057\u307f\u307e\u3057\u305f\u3002OpenCV\u3067\u9854\u5411\u304d\u63a8\u5b9a\u3092\u884c\u3046\u3084\u308a\u65b9\u3092\u898b\u3064\u3051\u305f\u306e\u306f\u3001\u6570\u6642\u9593\u524d\u3067\u3042\u3063\u305f\u305f\u3081\u6025\u3044\u3067\u6587\u7ae0\u3092\u66f8\u304d\u307e\u3057\u305f\u3002\u30b5\u30f3\u30d7\u30eb\u30d7\u30ed\u30b0\u30e9\u30e0\u306f\u3001\u52d5\u4f5c\u3057\u3066\u3044\u307e\u3059\u304c\u3001\u672c\u5f53\u306e\u5024(ground truth)\u304c\u308f\u304b\u3089\u306a\u3044\u305f\u3081\u3001\u6b63\u3057\u3044\u5024\u304c\u5f97\u3089\u308c\u3066\u3044\u308b\u304b\u4eca\u3072\u3068\u3064\u78ba\u8a3c\u304c\u5f97\u3089\u308c\u3066\u3044\u307e\u305b\u3093\u3002\u3044\u305a\u308c\u8ffd\u52a0\u306e\u60c5\u5831\u3092[Blog](https://iwaki2009.blogspot.jp/)\u306b\u8a18\u8f09\u3059\u308b\u4e88\u5b9a\u3067\u3059\u3002\n\n\u660e\u65e5\u306f\u3001negi111111\u3055\u3093\u306eOpenCV DNN\u306eiOS\u3067\u306e\u5229\u7528\u3068\u305d\u306e\u6bd4\u8f03\u306b\u3064\u3044\u3066\u3067\u3059\u3002\n\n\u4ee5\u4e0a\t\n", "tags": ["\u753b\u50cf\u51e6\u7406", "OpenCV", "\u753b\u50cf\u8a8d\u8b58"]}