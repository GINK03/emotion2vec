{"context": " More than 1 year has passed since last update.\u975e\u540c\u671fHTTP\u30af\u30e9\u30a4\u30a2\u30f3\u30c8em-http-request\u3092\u7528\u3044\u3066\u8907\u6570\u306e\u30b5\u30fc\u30d0\u30fc\u306b\u540c\u6642\u30ea\u30af\u30a8\u30b9\u30c8\u3067\u304d\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\n\nem-http-client.rb\nrequire 'eventmachine'\nrequire 'em-http'\n\n# \u30db\u30b9\u30c8\uff1a\u30dd\u30fc\u30c8\u751f\u6210\ndef host(i)\n  \"http://localhost:#{9292 + i}/\"\nend\n\nEM.run do\n  # 3\u3064\u306e\u30ea\u30af\u30a8\u30b9\u30c8\u3092\u4f5c\u6210\u3002\n  # localhost\u306e\u30dd\u30fc\u30c89292, 9293, 9294\u3067\u8907\u6570\u306e\u30b5\u30fc\u30d0\u30fc\u304c\u52d5\u3044\u3066\u3044\u308b\u3053\u3068\u3092\u60f3\u5b9a\u3002\n  # duration\u3068\u3044\u3046\u30d1\u30e9\u30e1\u30fc\u30bf(\u5f8c\u8ff0)\u306b\u9069\u5f53\u306a\u6574\u6570\u3092\u6e21\u3057\u3066\u3044\u308b\u3002\n  requests = Array.new(3) do |i|\n    EM::HttpRequest.new(host(i)).get :query => {'duration' => (3 + i)}\n  end\n  # \u975e\u540c\u671f\u30ea\u30af\u30a8\u30b9\u30c8\u306e\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u767b\u9332\n  requests.each do |request|\n    request.callback do\n      puts request.response\n    end\n    request.errback do\n      puts \"Error: #{request.error}\"\n    end\n  end\nend\n\n\n\n\u30c0\u30df\u30fc\u30b5\u30fc\u30d0\u30fc\n\n\u5bdd\u308b\u3060\u3051\u306eRack\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\n\u6574\u6570\u30d1\u30e9\u30e1\u30fc\u30bfduration\u306b\u6307\u5b9a\u3055\u308c\u305f\u79d2\u6570\u3060\u3051\u5bdd\u305f\u5f8c\u3067\u9069\u5f53\u306aJSON\u3092\u8fd4\u3059\u7c21\u5358\u306aRack\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3092\u4f5c\u308a\u307e\u3059\u3002\n\nsleeper.ru\nrequire 'rack/response'\nrequire 'json'\n\nclass Sleeper\n  def call(env)\n    req = Rack::Request.new(env)\n    t = req[\"duration\"].to_i\n    puts \"Going to sleep for #{t} seconds...\"\n    sleep t\n    Rack::Response.new.finish do |res|\n      j = {pid: $$, duration: t}.to_json\n      res.write j\n    end\n  end\nend\n\nrun Sleeper.new\n\n\n\nWEBrick\u30b5\u30fc\u30d0\u30fc\u8d77\u52d5\n\u4e0a\u8a18Rack\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3092\u5b9f\u884c\u3057\u307e\u3059\u3002\u30b3\u30de\u30f3\u30c9\u30e9\u30a4\u30f3\u304b\u3089\u6574\u6570\u5f15\u6570\u3092\u53d7\u3051\u53d6\u308a\u3001\u30dd\u30fc\u30c8\u756a\u53f7\u306b\u52a0\u3048\u3001Rack\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3092WEBrick\u30b5\u30fc\u30d0\u30fc\u4e0a\u3067\u5b9f\u884c\u3057\u307e\u3059\u3002\u30dd\u30fc\u30c8\u756a\u53f7\u3092\u53ef\u5909\u306b\u3057\u3066\u3044\u308b\u306e\u306f\u5f8c\u3067\u3053\u306e\u30b5\u30fc\u30d0\u30fc\u3092\u5225\u3005\u306e\u30dd\u30fc\u30c8\u3067\u8907\u6570\u8d77\u52d5\u3059\u308b\u305f\u3081\u3067\u3059\u3002\n(\u8d70\u308a\u3063\u3071\u306a\u3057\u3067kill\u3057\u5fd8\u308c\u308b\u306e\u304c\u5acc\u306a\u306e\u3067EM.defer\u3092\u4f7f\u7528\u3057\u306630\u79d2\u5f8c\u306b\u81ea\u5206\u81ea\u8eab\u306bSIGINT\u3092\u9001\u4fe1\u3057\u3066\u3044\u307e\u3059\u3002Rack::Server\u3067\u306ftrap(:INT)\u3067\u30b5\u30fc\u30d0\u30fc\u3092shutdown\u3057\u3066\u3044\u307e\u3059\u3002)\n\nspawn_sleeper.rb\nrequire 'rack'\nrequire 'eventmachine'\nEM.run do\n  # 30\u79d2\u5f8c\u306b\u7d42\u4e86\u3002\n  EM.defer do\n    sleep 30\n    puts \"Stopping server ...\"\n    Process.kill :INT, $$\n  end\n  puts \"Starting server ...\"\n  # \u4e0a\u8a18\u306esleeper.ru\u3092\u6307\u5b9a\u3057\u3066\u30b5\u30fc\u30d0\u30fc\u958b\u59cb\u3002\n  Rack::Server.start server: \"webrick\", Port: (9292 + ARGV[0].to_i), config: \"sleeper.ru\"\n  puts \"Bye.\"\n  EM.stop\nend\n\n\n\n\u52d5\u4f5c\u78ba\u8a8d\n\u4e0b\u8a18\u52d5\u4f5c\u78ba\u8a8d\u306fMac OS X\u3067\u884c\u3063\u3066\u3044\u307e\u3059\u304c\u3001Linux\u3067\u3082\u540c\u69d8\u306e\u306f\u305a\u3067\u3059\u3002\nshell\u306fbash\u3092\u60f3\u5b9a\u3057\u3066\u3044\u307e\u3059\u3002\n\n\u30c0\u30df\u30fc\u30b5\u30fc\u30d0\u30fc\u8d77\u52d5\n# \u30dd\u30fc\u30c89292, 9293, 9294\u3067\u30b5\u30fc\u30d0\u30fc\u3092\u30d0\u30c3\u30af\u30b0\u30e9\u30a6\u30f3\u30c9\u5b9f\u884c\u3002\nfor i in `seq 0 2`\ndo\n  ruby spawn_sleeper.rb $i &\ndone\n\n\n\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u8d77\u52d5\nruby em-http-client.rb\n\n\u5404\u30b5\u30fc\u30d0\u30fc\u304b\u3089\u306e\u30ec\u30b9\u30dd\u30f3\u30b9\u304c3, 4, 5\u79d2\u5f8c\u306b\u51fa\u529b\u3055\u308c\u307e\u3059\u3002\n\u975e\u540c\u671f\u8907\u6570\u30ea\u30af\u30a8\u30b9\u30c8\u306a\u306e\u3067\u7d045\u79d2\u5f8c\u306b\u306f\u3059\u3079\u3066\u30ec\u30b9\u30dd\u30f3\u30b9\u304c\u5f97\u3089\u308c\u307e\u3059\u3002\u9010\u6b21\u540c\u671f\u7684\u306b\u5b9f\u884c\u3057\u3066\u3044\u305f\u3089\u304a\u3088\u305d3 + 4 + 5 = 12\u79d2\u5f8c\u3068\u306a\u3063\u3066\u3044\u305f\u3067\u3057\u3087\u3046\u3002\nGoing to sleep for 4 seconds...\nGoing to sleep for 3 seconds...\nGoing to sleep for 5 seconds...\nlocalhost.localdomain - - [13/Dec/2014:13:58:18 JST] \"GET /?duration=3 HTTP/1.1\" 200 26\n- -> /?duration=3\n{\"pid\":92341,\"duration\":3}\nlocalhost.localdomain - - [13/Dec/2014:13:58:18 JST] \"GET /?duration=4 HTTP/1.1\" 200 26\n- -> /?duration=4\n{\"pid\":92342,\"duration\":4}\nlocalhost.localdomain - - [13/Dec/2014:13:58:18 JST] \"GET /?duration=5 HTTP/1.1\" 200 26\n- -> /?duration=5\n{\"pid\":92343,\"duration\":5}\n\n\n\u305d\u306e\u4ed6\nem-synchrony\u3082\u8a66\u3057\u3066\u307f\u305f\u3044\u3067\u3059\u3002\n\u4ee5\u4e0a\u3002\n\u975e\u540c\u671fHTTP\u30af\u30e9\u30a4\u30a2\u30f3\u30c8em-http-request\u3092\u7528\u3044\u3066\u8907\u6570\u306e\u30b5\u30fc\u30d0\u30fc\u306b\u540c\u6642\u30ea\u30af\u30a8\u30b9\u30c8\u3067\u304d\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n# \u30af\u30e9\u30a4\u30a2\u30f3\u30c8\n\n```em-http-client.rb\nrequire 'eventmachine'\nrequire 'em-http'\n\n# \u30db\u30b9\u30c8\uff1a\u30dd\u30fc\u30c8\u751f\u6210\ndef host(i)\n  \"http://localhost:#{9292 + i}/\"\nend\n\nEM.run do\n  # 3\u3064\u306e\u30ea\u30af\u30a8\u30b9\u30c8\u3092\u4f5c\u6210\u3002\n  # localhost\u306e\u30dd\u30fc\u30c89292, 9293, 9294\u3067\u8907\u6570\u306e\u30b5\u30fc\u30d0\u30fc\u304c\u52d5\u3044\u3066\u3044\u308b\u3053\u3068\u3092\u60f3\u5b9a\u3002\n  # duration\u3068\u3044\u3046\u30d1\u30e9\u30e1\u30fc\u30bf(\u5f8c\u8ff0)\u306b\u9069\u5f53\u306a\u6574\u6570\u3092\u6e21\u3057\u3066\u3044\u308b\u3002\n  requests = Array.new(3) do |i|\n    EM::HttpRequest.new(host(i)).get :query => {'duration' => (3 + i)}\n  end\n  # \u975e\u540c\u671f\u30ea\u30af\u30a8\u30b9\u30c8\u306e\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u767b\u9332\n  requests.each do |request|\n    request.callback do\n      puts request.response\n    end\n    request.errback do\n      puts \"Error: #{request.error}\"\n    end\n  end\nend\n```\n\n# \u30c0\u30df\u30fc\u30b5\u30fc\u30d0\u30fc\n\n### \u5bdd\u308b\u3060\u3051\u306eRack\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\n\n\u6574\u6570\u30d1\u30e9\u30e1\u30fc\u30bf`duration`\u306b\u6307\u5b9a\u3055\u308c\u305f\u79d2\u6570\u3060\u3051\u5bdd\u305f\u5f8c\u3067\u9069\u5f53\u306aJSON\u3092\u8fd4\u3059\u7c21\u5358\u306aRack\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3092\u4f5c\u308a\u307e\u3059\u3002\n\n```sleeper.ru\nrequire 'rack/response'\nrequire 'json'\n\nclass Sleeper\n  def call(env)\n    req = Rack::Request.new(env)\n    t = req[\"duration\"].to_i\n    puts \"Going to sleep for #{t} seconds...\"\n    sleep t\n    Rack::Response.new.finish do |res|\n      j = {pid: $$, duration: t}.to_json\n      res.write j\n    end\n  end\nend\n\nrun Sleeper.new\n```\n\n### WEBrick\u30b5\u30fc\u30d0\u30fc\u8d77\u52d5\n\n\u4e0a\u8a18Rack\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3092\u5b9f\u884c\u3057\u307e\u3059\u3002\u30b3\u30de\u30f3\u30c9\u30e9\u30a4\u30f3\u304b\u3089\u6574\u6570\u5f15\u6570\u3092\u53d7\u3051\u53d6\u308a\u3001\u30dd\u30fc\u30c8\u756a\u53f7\u306b\u52a0\u3048\u3001Rack\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3092WEBrick\u30b5\u30fc\u30d0\u30fc\u4e0a\u3067\u5b9f\u884c\u3057\u307e\u3059\u3002\u30dd\u30fc\u30c8\u756a\u53f7\u3092\u53ef\u5909\u306b\u3057\u3066\u3044\u308b\u306e\u306f\u5f8c\u3067\u3053\u306e\u30b5\u30fc\u30d0\u30fc\u3092\u5225\u3005\u306e\u30dd\u30fc\u30c8\u3067\u8907\u6570\u8d77\u52d5\u3059\u308b\u305f\u3081\u3067\u3059\u3002\n(\u8d70\u308a\u3063\u3071\u306a\u3057\u3067kill\u3057\u5fd8\u308c\u308b\u306e\u304c\u5acc\u306a\u306e\u3067`EM.defer`\u3092\u4f7f\u7528\u3057\u306630\u79d2\u5f8c\u306b\u81ea\u5206\u81ea\u8eab\u306bSIGINT\u3092\u9001\u4fe1\u3057\u3066\u3044\u307e\u3059\u3002`Rack::Server`\u3067\u306f`trap(:INT)`\u3067\u30b5\u30fc\u30d0\u30fc\u3092`shutdown`\u3057\u3066\u3044\u307e\u3059\u3002)\n\n```spawn_sleeper.rb\nrequire 'rack'\nrequire 'eventmachine'\nEM.run do\n  # 30\u79d2\u5f8c\u306b\u7d42\u4e86\u3002\n  EM.defer do\n    sleep 30\n    puts \"Stopping server ...\"\n    Process.kill :INT, $$\n  end\n  puts \"Starting server ...\"\n  # \u4e0a\u8a18\u306esleeper.ru\u3092\u6307\u5b9a\u3057\u3066\u30b5\u30fc\u30d0\u30fc\u958b\u59cb\u3002\n  Rack::Server.start server: \"webrick\", Port: (9292 + ARGV[0].to_i), config: \"sleeper.ru\"\n  puts \"Bye.\"\n  EM.stop\nend\n```\n\n# \u52d5\u4f5c\u78ba\u8a8d\n\n\u4e0b\u8a18\u52d5\u4f5c\u78ba\u8a8d\u306fMac OS X\u3067\u884c\u3063\u3066\u3044\u307e\u3059\u304c\u3001Linux\u3067\u3082\u540c\u69d8\u306e\u306f\u305a\u3067\u3059\u3002\nshell\u306fbash\u3092\u60f3\u5b9a\u3057\u3066\u3044\u307e\u3059\u3002\n\n### \u30c0\u30df\u30fc\u30b5\u30fc\u30d0\u30fc\u8d77\u52d5\n\n```bash\n# \u30dd\u30fc\u30c89292, 9293, 9294\u3067\u30b5\u30fc\u30d0\u30fc\u3092\u30d0\u30c3\u30af\u30b0\u30e9\u30a6\u30f3\u30c9\u5b9f\u884c\u3002\nfor i in `seq 0 2`\ndo\n  ruby spawn_sleeper.rb $i &\ndone\n```\n\n### \u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u8d77\u52d5\n\n```bash\nruby em-http-client.rb\n```\n\n\u5404\u30b5\u30fc\u30d0\u30fc\u304b\u3089\u306e\u30ec\u30b9\u30dd\u30f3\u30b9\u304c3, 4, 5\u79d2\u5f8c\u306b\u51fa\u529b\u3055\u308c\u307e\u3059\u3002\n\u975e\u540c\u671f\u8907\u6570\u30ea\u30af\u30a8\u30b9\u30c8\u306a\u306e\u3067\u7d045\u79d2\u5f8c\u306b\u306f\u3059\u3079\u3066\u30ec\u30b9\u30dd\u30f3\u30b9\u304c\u5f97\u3089\u308c\u307e\u3059\u3002\u9010\u6b21\u540c\u671f\u7684\u306b\u5b9f\u884c\u3057\u3066\u3044\u305f\u3089\u304a\u3088\u305d3 + 4 + 5 = 12\u79d2\u5f8c\u3068\u306a\u3063\u3066\u3044\u305f\u3067\u3057\u3087\u3046\u3002\n\n```\nGoing to sleep for 4 seconds...\nGoing to sleep for 3 seconds...\nGoing to sleep for 5 seconds...\nlocalhost.localdomain - - [13/Dec/2014:13:58:18 JST] \"GET /?duration=3 HTTP/1.1\" 200 26\n- -> /?duration=3\n{\"pid\":92341,\"duration\":3}\nlocalhost.localdomain - - [13/Dec/2014:13:58:18 JST] \"GET /?duration=4 HTTP/1.1\" 200 26\n- -> /?duration=4\n{\"pid\":92342,\"duration\":4}\nlocalhost.localdomain - - [13/Dec/2014:13:58:18 JST] \"GET /?duration=5 HTTP/1.1\" 200 26\n- -> /?duration=5\n{\"pid\":92343,\"duration\":5}\n```\n\n# \u305d\u306e\u4ed6\n\nem-synchrony\u3082\u8a66\u3057\u3066\u307f\u305f\u3044\u3067\u3059\u3002\n\n\u4ee5\u4e0a\u3002\n", "tags": ["Ruby2.0.0", "rubygems", "HTTP", "WebAPI", "\u975e\u540c\u671f\u51e6\u7406"]}