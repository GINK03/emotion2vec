{"context": "\u5148\u65e5(vQFX10000 \u3092 KVM+GNS3 \u3067\u52d5\u304b\u3059)\u3001Juniper vQFX10000(\u4ee5\u964d vQFX) \u306e DL \u6a29\u9650\u3092\u500b\u4eba\u3067\u5f97\u3066 GNS3 \u3067\u8efd\u304f\u52d5\u4f5c\u78ba\u8a8d\u3092\u3068\u308a\u3001\u524d\u56de(vQFX10000 \u3067 VXLAN+EVPN (L2 over L3 \u7de8))\u3001\u4eee\u60f3\u7248\u3067\u3082 L2VPN \u6a5f\u80fd\u304c\u52d5\u304f\u3053\u3068\u3092\u78ba\u8a8d\u3057\u307e\u3057\u305f\u3002\nQFX10000\u7cfb\u3067\u306f EVPN NLRI Type5 Route (\u53c2\u8003\u8cc7\u6599\u306e draft \u53c2\u7167)\u3067 Symmetric \u306a evpn-inter-subnet-forwarding \u304c\u3067\u304d\u308b\u3088\u3046\u306a\u306e\u3067\u3001\u4eca\u56de\u306f vQFX \u3067\u305d\u308c\u3092\u8a66\u3057\u307e\u3059\u3002(\u3042\u3089\u3059\u3058\u304c\u9577\u3044...)\n\n\u6700\u521d\u306b\n\n\u672c\u9805\u3067\u3084\u308b\u3053\u3068\n\nvQFX \u3067 VXLAN \u306e Control Plane \u3068\u3057\u3066 EVPN \u3092\u52d5\u304b\u3059\nEVPN NLRI Type5(EVPN Prefix Advertisement) \u3092\u4f7f\u3063\u3066 evpn-inter-subnet-forwarding (Symmetric)\u3092\u52d5\u304b\u3059\n\u524d\u56de\u306e NLRI Type2+3 \u3092\u4f7f\u3063\u305f L2 over L3 \u3082\u4f75\u7528\u3067\u304d\u308b\u304b\u78ba\u8a8d\u3059\u308b\n\n\n\u4e0b\u56f3\u306e\u8d64\u3044\u70b9\u7dda\u90e8\u5206\nType5 \u3092\u4f7f\u3063\u3066 VRFtoVRF \u3057\u3066\u3044\u308b\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u3067\u306f\u300c\u30bb\u30b0\u30e1\u30f3\u30c8\u304c\u5358\u4e00\u30b5\u30a4\u30c8(/\u90e8\u5c4b)\u306b\u9589\u3058\u308b\u5834\u5408\u306b\u306f\u300d\u3068\u3044\u3046\u6587\u8a00\u304c\u3042\u3063\u305f\u308a\u3059\u308b\u3051\u308c\u3069\n\n\n\n\n\n\u6982\u8981\u69cb\u6210\u56f3\n\u524d\u56de\u306b\u5f15\u304d\u7d9a\u304d\u3001\u4e0b\u56f3\u306e\u611f\u3058\u3067\u3002\n\n\u4f59\u8ac7\u3002\n\u672c\u74b0\u5883\u306e GNS3 1.5.2 \u3067\u30d1\u30b1\u30c3\u30c8\u30ad\u30e3\u30d7\u30c1\u30e3\u3059\u308b\u305f\u3081\u306b\u3001qemu \u540c\u58eb\u3092\u76f4\u7d50\u305b\u305a\u306b\u3001\u9593\u306b GNS3 \u306e Ethernet Switch \u3092\u631f\u3080\u69cb\u6210\u306b\u3057\u3066\u307e\u3059\u3002\u304c\u3001\u300cpelican@ainoniwa.net / GNS3 2.0\u304b\u3089\u306fKVM\u9593\u306e\u30d1\u30b1\u30c3\u30c8\u30ad\u30e3\u30d7\u30c1\u30e3\u3082\u53d6\u308c\u308b\u3088\u3046\u306b\u306a\u308b\u305e\u3044\u300d\u306e\u3088\u3046\u306b GNS3 2.0(2017/01/04 \u6642\u70b9\u3067\u306f beta \u7248)\u3092\u4f7f\u3048\u3070\u3001\u3053\u308c\u304c\u4e0d\u8981\u306b\u306a\u308b\u3088\u3046\u3067\u3059\u3002\u3084\u3063\u305f\u305c\uff01\n\n\u53c2\u8003\u8cc7\u6599\n\n\u524d\u56de\u306e\u53c2\u8003\u8cc7\u6599 \u5168\u822c\nEVPN \u6a19\u6e96\n\n\n\ndraft-ietf-bess-evpn-prefix-advertisement-03 (IP Prefix Advertisement in EVPN)\n\nEVPN NLRI Type5 \u3092\u4f7f\u3063\u3066 IP-VRF to IP-VRF \u3067 IP Prefix Advertise \u3057\u3088\u3046\u3068\u3044\u3046\u304a\u8a71\n\n\n\ndraft-ietf-bess-evpn-inter-subnet-forwarding-01 (Integrated Routing and Bridging in EVPN)\n\nL3 \u5168\u822c\n\nAsymmetric \u3068 Symmetric \u306b\u95a2\u3059\u308b\u8a71\u306f\u3053\u308c\u3092\u8aad\u3080\u3068\u308f\u304b\u308b\n\n\n\n\nJUNOS \u3067\u306e VXLAN+EVPN inter-subnet-forwarding \u5b9f\u88c5\u30fb\u8a2d\u5b9a\u5468\u308a\n\n\n\nJuniper\u516c\u5f0f / ip-prefix-routes \u30b3\u30de\u30f3\u30c9 at JUNOS15.1\n\n\nStatement introduced in Junos OS Release 15.1x53-D60 for QFX10000 Series switches. \u3060\u305d\u3046\u306a\n\u3093\u3067 vQFX(15.1X53-D60.4)\u3067\u3082\u8a2d\u5b9a\u53ef\u80fd\n\n\n\u5c11\u3057\u524d\u306e\u5b9f\u88c5\n\n\n\nJuniper\u516c\u5f0f / ip-prefix-support \u30b3\u30de\u30f3\u30c9 at JUNOS15.1\n\n\nStatement introduced in Junos OS Release 15.1x53-D30 on QFX10002 switches. \u3060\u305d\u3046\u3067\n\nThis statement is deprecated starting with Junos OS Release 15.1x53-D60 and has been replaced with ip-prefix-routes. \u3063\u3066\u3053\u3068\u3089\u3057\u304f\u3001\u30d0\u30fc\u30b8\u30e7\u30f3\u3092\u3042\u3052\u308b\u3068\u81ea\u52d5\u7684\u306b ip-prefix-routes \u306b\u306a\u308b\u3089\u3057\u3044\u306e\u3067\nvQFX(15.1X53-D60.4)\u3067\u306f\u8a2d\u5b9a\u4e0d\u53ef\n\n\n\nJuniper\u516c\u5f0f / Configuring EVPN Type 5 for QFX10000 Series Switches / Configuration Example\n\n\u4e0a\u8a18\u3092\u7528\u3044\u305f\u5206\u304b\u308a\u3084\u3059\u3044\u30b5\u30f3\u30d7\u30eb\n\n\n\n\n\nNetOne \u30b3\u30e9\u30e0 / EVPN \u3067\u5909\u308f\u308b\u30fb\u5909\u3048\u3089\u308c\u308b\u30c7\u30fc\u30bf\u30bb\u30f3\u30bf\u30fc\u30cd\u30c3\u30c8\u30ef\u30fc\u30af1\n\nJuniper MX \u3092\u4f7f\u3063\u305f L2 + L3 \u306e\u5177\u4f53\u7684\u306a\u4f8b(2016/03 \u6642\u70b9\u306e\u3082\u306e\u307f\u305f\u3044)\n\u591a\u5206\u3053\u308c\u306f Asymmetric \u306a\u3084\u3064\n\u65e5\u672c\u8a9e\u3067\u5699\u307f\u7815\u3044\u305f\u8aac\u660e\n\n\n\n\n\u305d\u306e\u4ed6\n\n\n\nCisco \u767a\u8868\u8cc7\u6599(20160120) / VXLAN\u30c1\u30e5\u30fc\u30c8\u30ea\u30a2\u30eb\n\n\u30b9\u30e9\u30a4\u30c9 16-25 \u306b Asymmetric \u3068 Symmetric \u306e\u565b\u307f\u7815\u3044\u3060\u65e5\u672c\u8a9e\u56f3\u89e3\u3042\u308a\n\u3053\u306e\u6642\u70b9\u3067\u306f\u300cJuniper \u306e\u306f Asymmetric \u5b9f\u88c5\u30fbCisco \u306e\u306f Symmetric \u5b9f\u88c5\u300d\u3068\u7d39\u4ecb\u3055\u308c\u3066\u3044\u308b\u304c\n2017/01\u73fe\u5728\u306f Juniper \u306b\u3082 Symmetric \u5b9f\u88c5\u304c\u3042\u308b\u3088\u3001\u3068\u3044\u3046\u306e\u3092\u672c\u9805\u3067\u6271\u3046\n\n\n\n\n\n\n\u69cb\u7bc9\uff5e\u52d5\u4f5c\u78ba\u8a8d\n\nGNS3 \u3067\u30c7\u30d7\u30ed\u30a4\n\u524d\u56de\u306e\u74b0\u5883\u3092\u5f15\u304d\u7d9a\u304d\u4f7f\u3044\u307e\u3059\u3002\u5148\u306b\u3042\u3052\u305f\u6982\u8981\u69cb\u6210\u56f3\u306e\u901a\u308a\u3002\n\n\u758e\u901a\u78ba\u8a8d\u7528 node \u8a2d\u5b9a\n\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u611f\u3058\u3067\nkotetsu@node11:~$ ip a show dev ens4\n3: ens4: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000\n    link/ether 00:37:c4:e2:60:01 brd ff:ff:ff:ff:ff:ff\n    inet 192.168.1.1/24 brd 192.168.1.255 scope global ens4\n       valid_lft forever preferred_lft forever\n    inet6 fe80::237:c4ff:fee2:6001/64 scope link\n       valid_lft forever preferred_lft forever\n\nkotetsu@node11:~$ ip route show dev ens4\n192.168.0.0/16 via 192.168.1.254\n192.168.1.0/24  proto kernel  scope link  src 192.168.1.1\n\nkotetsu@node21:~$ ip a show dev ens4\n3: ens4: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000\n    link/ether 00:37:c4:46:d8:01 brd ff:ff:ff:ff:ff:ff\n    inet 192.168.1.2/24 brd 192.168.1.255 scope global ens4\n       valid_lft forever preferred_lft forever\n    inet6 fe80::237:c4ff:fe46:d801/64 scope link\n       valid_lft forever preferred_lft forever\n\nkotetsu@node21:~$ ip route show dev ens4\n192.168.0.0/16 via 192.168.1.254\n192.168.1.0/24  proto kernel  scope link  src 192.168.1.2\n\nkotetsu@node22:~$ ip a show dev ens4\n3: ens4: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000\n    link/ether 00:37:c4:3d:e0:01 brd ff:ff:ff:ff:ff:ff\n    inet 192.168.2.2/24 brd 192.168.2.255 scope global ens4\n       valid_lft forever preferred_lft forever\n    inet6 fe80::237:c4ff:fe3d:e001/64 scope link\n       valid_lft forever preferred_lft forever\n\nkotetsu@node22:~$ ip route show dev ens4\n192.168.0.0/16 via 192.168.2.254\n192.168.2.0/24  proto kernel  scope link  src 192.168.2.2\n\nkotetsu@node13:~$ ip a show dev ens4\n3: ens4: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000\n    link/ether 00:37:c4:0d:a8:01 brd ff:ff:ff:ff:ff:ff\n    inet 192.168.3.1/24 brd 192.168.3.255 scope global ens4\n       valid_lft forever preferred_lft forever\n    inet6 fe80::237:c4ff:fe0d:a801/64 scope link\n       valid_lft forever preferred_lft forever\n\nkotetsu@node13:~$ ip route show dev ens4\n192.168.0.0/16 via 192.168.3.254\n192.168.3.0/24  proto kernel  scope link  src 192.168.3.1\n\n\nvQFX \u57fa\u672c\u8a2d\u5b9a\u3061\u3087\u3044\u305f\u3057\nEVPN \u306b\u3053\u3093\u306a\u8a2d\u5b9a\u3092\u3057\u3066 /var/log/evpn.log \u3067\u8ffd\u3048\u308b\u3088\u3046\u306b\u3057\u3068\u304d\u307e\u3057\u305f\u3002flag all \u306b\u3057\u305f\u3089\u3061\u3087\u3063\u3068\u8ffd\u3044\u304d\u308c\u306a\u3044\u60c5\u5831\u91cf\u306b\u306a\u3063\u305f\u306e\u3067\u3001\u305d\u3053\u306f\u304a\u597d\u307f\u3067...\u3002\nset protocols evpn traceoptions file evpn.log\nset protocols evpn traceoptions file size 10k\nset protocols evpn traceoptions file files 30\nset protocols evpn traceoptions flag all\n\n\nvQFX Inter Subnet Forwarding \u8a2d\u5b9a\uff5e\u78ba\u8a8d\n\nInter Subnet Forwarding \u8a2d\u5b9a\n\nspine11\n\u524d\u56de\u3053\u3093\u306a\u611f\u3058\u306e\u8a2d\u5b9a\u3092\u5165\u308c\u3066\u3042\u3063\u305f\u306e\u3067\n{master:0}[edit]\nkotetsu@spine11# show vlans | display set\nset vlans VLAN0100 vlan-id 100\nset vlans VLAN0100 vxlan vni 10100\nset vlans VLAN0100 vxlan ingress-node-replication\nset vlans VLAN0300 vlan-id 300\nset vlans VLAN0300 vxlan vni 10300\nset vlans VLAN0300 vxlan ingress-node-replication\nset vlans default vlan-id 1\n\n\u4ee5\u4e0b\u3067\u3000IRB\u3000\u4f5c\u6210\u3000\uff5e\u3000VRF \u4f5c\u6210\nset interfaces irb unit 100 family inet address 192.168.1.254/24\nset interfaces irb unit 100 proxy-macip-advertisement\n\nset interfaces irb unit 300 family inet address 192.168.3.254/24\nset interfaces irb unit 300 proxy-macip-advertisement\n\nset vlans VLAN0100 l3-interface irb.100\nset vlans VLAN0300 l3-interface irb.300\n\n\nset interfaces lo0 unit 1 family inet address 198.18.1.11/32\n\nset routing-instances VRF001 instance-type vrf\nset routing-instances VRF001 interface irb.100\nset routing-instances VRF001 interface irb.300\nset routing-instances VRF001 interface lo0.1\nset routing-instances VRF001 route-distinguisher 50001:11\nset routing-instances VRF001 vrf-target target:64512:50001\nset routing-instances VRF001 protocols evpn ip-prefix-routes advertise direct-nexthop\nset routing-instances VRF001 protocols evpn ip-prefix-routes encapsulation vxlan\nset routing-instances VRF001 protocols evpn ip-prefix-routes vni 50001\n\n\u30dd\u30a4\u30f3\u30c8\u306f protocols evpn ip-prefix-routes \u5468\u308a\u306e\u8a2d\u5b9a\u3067\u3059\u306d\u3002\n\u3053\u308c\u3067 VRF to VRF \u3067 EVPN NLRI Type5 \u3067 IP Prefix \u3084\u81ea\u5206\u306e MAC \u30a2\u30c9\u30ec\u30b9(Router's MAC) \u3092\u9001\u4fe1\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u308b\u306f\u305a\u3002 \nJuniper\u516c\u5f0f / ReleaseNotes Junos 15.1X53-D60 for QFX10000 Switches \u306e 19 \u30da\u30fc\u30b8\u306b\u3088\u308b\u3068\n\nBest practice for EVPN-VXLAN configuration (QFX10000 switches)\u2014Starting with\nJunos OS Release 15.1X53-D60, in an EVPN-VXLAN configuration on QFX10000\nswitches, you no longer need to configure vxlan ingress-node-replication.\n\n\u3060\u305d\u3046\u306a\u3002\u306a\u3093\u3067\u3060\u308d\u3002\u3068\u306b\u304b\u304f Best Practice \u306a\u3089\u5f93\u3063\u3066\u304a\u304f\u306e\u304c\u3088\u304b\u308d\u3046\u3068\u3044\u3046\u3053\u3068\u3067\u3002\ndelete vlans VLAN0100 vxlan ingress-node-replication\ndelete vlans VLAN0300 vxlan ingress-node-replication\n\n\u3053\u308c\u3092\u6d88\u3055\u305a\u306b\u30c6\u30b9\u30c8\u3057\u3066\u3044\u305f\u6642\u3001\u306a\u3093\u304b EVPN NLRI Type3 \u3092\u9001\u3063\u3066\u304d\u3066\u3044\u306a\u3044 Remote VTEP \u3068 VNI \u306e\u7d44\u307f\u5408\u308f\u305b\u306b\u5bfe\u3057\u3066 BUM \u3092 ingress replication \u8ee2\u9001\u3057\u3066\u305f\u3093\u3060\u3088\u306a...\u3068\u3044\u3046\u3053\u3068\u3067\u6d88\u3059\u306e\u304c\u6b63\u89e3\u3068\u601d\u3044\u307e\u3059\u3002\n\u3042\u3068\u81ea\u5206\u306e\u74b0\u5883\u8d77\u56e0\u304b\u3082\u3067\u3059\u304c\u3001\u3053\u306e\u8fba\u306e\u8a2d\u5b9a\u8ffd\u52a0\u30fb\u5909\u66f4\u3057\u3066 commit \u3057\u305f\u6642\u306b\u3001bb01 \u3068 spine[12]1 \u306e\u9593\u3067 LLDP \u3084 BGP \u304c\u30d5\u30e9\u30c3\u30d4\u30f3\u30b0\u3057\u59cb\u3081\u308b\u3053\u3068\u304c\u3042\u308a\u307e\u3057\u305f\u3002\u3061\u3083\u3093\u3068\u8ffd\u3063\u3066\u306a\u3044\u3067\u3059\u304c\u3001\u305d\u3093\u306a\u6642\u306b\u306f\u304a\u3068\u306a\u3057\u304f request system reboot \u3057\u3066\u843d\u3061\u7740\u304b\u305b\u307e\u3057\u305f\u3002(\u96d1)\n\nspine21\nspine11 \u3068\u307b\u3068\u3093\u3069\u4e00\u7dd2\u3067\u3059\u3002\n\u524d\u56de\u3053\u3093\u306a\u611f\u3058\u306e\u8a2d\u5b9a\u3092\u5165\u308c\u3066\u3042\u3063\u305f\u306e\u3067\n{master:0}[edit]\nkotetsu@spine21# show vlans | display set\nset vlans VLAN0100 vlan-id 100\nset vlans VLAN0100 vxlan vni 10100\nset vlans VLAN0100 vxlan ingress-node-replication\nset vlans VLAN0200 vlan-id 200\nset vlans VLAN0200 vxlan vni 10200\nset vlans VLAN0200 vxlan ingress-node-replication\nset vlans default vlan-id 1\n\n\u4ee5\u4e0b\u3067\u3000IRB\u3000\u4f5c\u6210\u3000\uff5e\u3000VRF \u4f5c\u6210\nset interfaces irb unit 100 family inet address 192.168.1.254/24\nset interfaces irb unit 100 proxy-macip-advertisement\nset interfaces irb unit 200 family inet address 192.168.2.254/24\nset interfaces irb unit 200 proxy-macip-advertisement\n\nset vlans VLAN0100 l3-interface irb.100\nset vlans VLAN0200 l3-interface irb.200\n\nset interfaces lo0 unit 1 family inet address 198.18.1.21/32\n\nset routing-instances VRF001 instance-type vrf\nset routing-instances VRF001 interface irb.100\nset routing-instances VRF001 interface irb.200\nset routing-instances VRF001 interface lo0.1\nset routing-instances VRF001 route-distinguisher 50001:21\nset routing-instances VRF001 vrf-target target:64512:50001\nset routing-instances VRF001 protocols evpn ip-prefix-routes advertise direct-nexthop\nset routing-instances VRF001 protocols evpn ip-prefix-routes encapsulation vxlan\nset routing-instances VRF001 protocols evpn ip-prefix-routes vni 50001\n\n\u524d\u8ff0\u306e\u901a\u308a Best Practice \u306b\u5f93\u3063\u3066\u304a\u304f\u3002\ndelete vlans VLAN0100 vxlan ingress-node-replication\ndelete vlans VLAN0200 vxlan ingress-node-replication\n\n\n\u52d5\u4f5c\u78ba\u8a8d\n\nIP\u30a2\u30c9\u30ec\u30b9\u30fbMAC\u30a2\u30c9\u30ec\u30b9\u60c5\u5831 \u6574\u7406\n\u3061\u3087\u3063\u3068\u30ce\u30fc\u30c9\u6570\u304c\u5897\u3048\u3066\u304d\u305f\u306e\u3067\u3001\u307e\u3068\u3081\u3068\u304d\u307e\u3059\u3002\n\n\n\nVLAN\nIP\u30a2\u30c9\u30ec\u30b9\nMAC\u30a2\u30c9\u30ec\u30b9\n\u30ce\u30fc\u30c9\n\u30a4\u30f3\u30bf\u30fc\u30d5\u30a7\u30fc\u30b9\n\u5099\u8003\n\n\n\n\n100\n192.168.1.1/24\n00:37:c4:e2:60:01\nnode11\nens4\n\nspine11 \u914d\u4e0b\n\n\n100\n192.168.1.2/24\n00:37:c4:46:d8:01\nnode21\nens4\n\nspine21 \u914d\u4e0b\n\n\n100\n192.168.1.254/24\n02:05:86:71:3c:00\nspine11\nirb\n\n\n\n100\n192.168.1.254/24\n02:05:86:71:d8:00\nspine21\nirb\n\n\n\n200\n192.168.2.2/24\n00:37:c4:3d:e0:01\nnode22\nens4\n\nspine21 \u914d\u4e0b\n\n\n200\n192.168.2.254/24\n02:05:86:71:d8:00\nspine21\nirb\n\n\n\n300\n192.168.3.1/24\n00:37:c4:0d:a8:01\nnode13\nens4\n\nspine11 \u914d\u4e0b\n\n\n300\n192.168.3.254/24\n02:05:86:71:3c:00\nspine11\nirb\n\n\n\n-\n192.0.2.1/30\n02:05:86:71:21:03\nbb01\nxe-0/0/0\n\nspine21 \u5074\n\n\n-\n192.0.2.2/30\n02:05:86:71:3c:03\nspine11\nxe-0/0/0\n\nbb01 \u5074\n\n\n-\n192.0.2.5/30\n02:05:86:71:21:07\nbb01\nxe-0/0/1\n\nspine21 \u5074\n\n\n-\n192.0.2.6/30\n02:05:86:71:d8:03\nspine21\nxe-0/0/0\n\nbb01 \u5074\n\n\n\nspine11 \u3068 spine21 \u306e IRB MAC \u30a2\u30c9\u30ec\u30b9 at VLAN100 \u306f\u5404\u7269\u7406\u306e\u3082\u306e\u306b\u306a\u3063\u3066\u3044\u3066\u3001\u5171\u6709\u7528\u306e\u4eee\u60f3 MAC \u3092\u8a2d\u5b9a\u3057\u305f\u308a\u306f\u3057\u3066\u3044\u306a\u3044\u3067\u3059\u3002\nspine11 \u914d\u4e0b\u306e node11 \u306f spine11 \u306e IRB MAC\u30a2\u30c9\u30ec\u30b9\u3092\u30b2\u30fc\u30c8\u30a6\u30a7\u30a4\u3068\u3057\u3066\u4f7f\u3044\u3001spine21 \u914d\u4e0b\u306e node21 \u306f spine21 \u306e IRB MAC\u30a2\u30c9\u30ec\u30b9\u3092\u30b2\u30fc\u30c8\u30a6\u30a7\u30a4\u3068\u3057\u3066\u4f7f\u3046...\u3063\u3066\u306a\u52d5\u304d\u306b\u306a\u308b\u306e\u304b\u3001\u3092\u898b\u3088\u3046\u3068\u3044\u3046\u4e3b\u65e8\u3002\n\nnode\u9593\u758e\u901a\u78ba\u8a8d\uff5eARP\u30c6\u30fc\u30d6\u30eb\u78ba\u8a8d\n4 \u53f0\u306e node \u9593\u3092\u30d5\u30eb\u30e1\u30c3\u30b7\u30e5\u306b ping \u7c21\u6613\u758e\u901a\u78ba\u8a8d\u3001\u3068\u308a\u3042\u3048\u305a\u758e\u901a\u30aa\u30fc\u30eb\u304a\u3063\u3051\u30fc\u3002\n\u76f4\u5f8c ARP \u30c6\u30fc\u30d6\u30eb\u78ba\u8a8d\n\nnode11(192.168.1.1/24)\n\nkotetsu@node11:~$ ip n show dev ens4\n192.168.1.254 lladdr 02:05:86:71:3c:00 REACHABLE  ## spine11 IRB \u306e MACaddr\n192.168.1.2 lladdr 00:37:c4:46:d8:01 STALE\n\n\nnode21(192.168.1.2/24)\n\nkotetsu@node21:~$ ip n show dev ens4\n192.168.1.254 lladdr 02:05:86:71:d8:00 REACHABLE  ## spine21 IRB \u306e MACaddr\n192.168.1.1 lladdr 00:37:c4:e2:60:01 REACHABLE\n\n\nnode13(192.168.3.1/24)\n\nkotetsu@node13:~$ ip n show dev ens4\n192.168.3.254 lladdr 02:05:86:71:3c:00 STALE  ## spine11 IRB \u306e MACaddr\n\n\nnode22(192.168.2.2/24)\n\nkotetsu@node22:~$ ip n show dev ens4\n192.168.2.254 lladdr 02:05:86:71:d8:00 REACHABLE  ## spine21 IRB \u306e MACaddr\n\n\u3061\u306a\u307f\u306b spine11 \u3084 spine12 \u304b\u3089 ping \u3092\u5b9f\u884c\u3057\u3088\u3046\u3068\u3057\u305f\u3089\u3001\u81ea\u767a\u30d1\u30b1\u30c3\u30c8\u3092 EVPN \u65b9\u9762\u306b\u306f\u6d41\u3089\u308c\u306a\u3044\u3063\u307d\u3044\u3067\u3059\u3002\u305d\u308a\u3083\u3042\u305d\u3046\u304b\u3002\n{master:0}\nkotetsu@spine21> ping routing-instance VRF001 192.168.1.2\nPING 192.168.1.2 (192.168.1.2): 56 data bytes\n64 bytes from 192.168.1.2: icmp_seq=0 ttl=64 time=6.448 ms\n64 bytes from 192.168.1.2: icmp_seq=1 ttl=64 time=5.700 ms\n\n{master:0}\nkotetsu@spine21> ping routing-instance VRF001 192.168.3.1\nPING 192.168.3.1 (192.168.3.1): 56 data bytes\nping: sendto: Operation not supported\nping: sendto: Operation not supported\n\n\n{master:0}\nkotetsu@spine21> show route table VRF001.inet.0 192.168.3.0/24\n\nVRF001.inet.0: 8 destinations, 9 routes (8 active, 0 holddown, 0 hidden)\n+ = Active Route, - = Last Active, * = Both\n\n192.168.3.0/24     *[EVPN/170] 20:55:03\n                    > to 192.0.2.5 via xe-0/0/0.0\n\n\n\u30d1\u30c3\u3068\u898b\u306f\u5de7\u3044\u3053\u3068\u901a\u4fe1\u3067\u304d\u3066\u3044\u308b\u3088\u3046\u3067\u3059\u304c...\u3061\u3087\u3063\u3068\u4e2d\u8eab\u3092\u8ffd\u3063\u3066\u3044\u304d\u307e\u3059\u3002\n\nvQFX\u30c6\u30fc\u30d6\u30eb\u78ba\u8a8d\n\nEVPN\n\u4e21\u65b9\u306e spine \u306b\u3064\u304f\u3063\u3066\u3044\u308b VLAN100(VNI 10100)\u306e MAC \u60c5\u5831\u3060\u3051\u304c Remote \u304b\u3089\u5b66\u7fd2\u3057\u305f\u3082\u306e\u306b\u542b\u307e\u308c...\u3063\u3066\u3084\u306f\u308a Router's MAC \u3068\u3057\u3066 192.168.1.254 \u306e\u5b9f MAC 2 \u53f0\u5206\u3092\u5b66\u7fd2\u3057\u3066\u3044\u308b\u3002\n{master:0}\nkotetsu@spine11> show evpn database\nInstance: default-switch\nVLAN  VNI  MAC address        Active source                  Timestamp        IP address\n      10100 00:37:c4:46:d8:01  172.16.2.1                     Jan 08 21:35:56\n      10100 00:37:c4:e2:60:01  xe-0/0/1.0                     Jan 08 01:30:42  192.168.1.1\n      10100 02:05:86:71:3c:00  irb.100                        Jan 08 12:50:23  192.168.1.254\n      10100 02:05:86:71:d8:00  172.16.2.1                     Jan 08 12:50:38  192.168.1.254\n      10300 00:37:c4:0d:a8:01  xe-0/0/1.0                     Jan 08 01:30:41  192.168.3.1\n      10300 02:05:86:71:3c:00  irb.300                        Jan 08 01:27:27  192.168.3.254\n\n{master:0}\nkotetsu@spine21> show evpn database\nInstance: default-switch\nVLAN  VNI  MAC address        Active source                  Timestamp        IP address\n      10100 00:37:c4:46:d8:01  xe-0/0/1.0                     Jan 08 01:30:41  192.168.1.2\n      10100 00:37:c4:e2:60:01  172.16.1.1                     Jan 08 21:42:10  192.168.1.1\n      10100 02:05:86:71:3c:00  172.16.1.1                     Jan 08 12:53:48  192.168.1.254\n      10100 02:05:86:71:d8:00  irb.100                        Jan 08 12:54:02  192.168.1.254\n      10200 00:37:c4:3d:e0:01  xe-0/0/1.0                     Jan 08 01:30:41  192.168.2.2\n      10200 02:05:86:71:d8:00  irb.200                        Jan 08 01:16:21  192.168.2.254\n\n\u81ea\u5206\u304c\u5410\u3044\u3066\u3044\u308b Type5 \u60c5\u5831\u30b5\u30de\u30ea\n{master:0}\nkotetsu@spine11> show evpn l3-context\nL3 context                      Type  Adv      Encap  VNI/Label  Router MAC/GW intf\nVRF001                          Cfg   Direct   VXLAN  50001      02:05:86:71:3c:00\n\n{master:0}\nkotetsu@spine21> show evpn l3-context\nL3 context                      Type  Adv      Encap  VNI/Label  Router MAC/GW intf\nVRF001                          Cfg   Direct   VXLAN  50001      02:05:86:71:d8:00\n\nRemote \u304b\u3089 Type 5 \u3067\u5b66\u7fd2\u3057\u305f Router's MAC \u3092\u78ba\u8a8d\u3057\u3066\n{master:0}\nkotetsu@spine11> show evpn ip-prefix-database\nL3 context: VRF001\n\nIPv4->EVPN Exported Prefixes\nPrefix                                       EVPN route status\n192.168.1.0/24                               Created\n192.168.3.0/24                               Created\n\nEVPN->IPv4 Imported Prefixes\nPrefix                                       Etag      IP route status\n192.168.1.0/24                               0         Created\n  Route distinguisher    St  VNI/Label  Router MAC         Nexthop/Overlay GW/ESI\n  50001:21               A   50001      02:05:86:71:d8:00  172.16.2.1\n192.168.2.0/24                               0         Created\n  Route distinguisher    St  VNI/Label  Router MAC         Nexthop/Overlay GW/ESI\n  50001:21               A   50001      02:05:86:71:d8:00  172.16.2.1\n\n\n{master:0}\nkotetsu@spine21> show evpn ip-prefix-database\nL3 context: VRF001\n\nIPv4->EVPN Exported Prefixes\nPrefix                                       EVPN route status\n192.168.1.0/24                               Created\n192.168.2.0/24                               Created\n\nEVPN->IPv4 Imported Prefixes\nPrefix                                       Etag      IP route status\n192.168.1.0/24                               0         Created\n  Route distinguisher    St  VNI/Label  Router MAC         Nexthop/Overlay GW/ESI\n  50001:11               A   50001      02:05:86:71:3c:00  172.16.1.1\n192.168.3.0/24                               0         Created\n  Route distinguisher    St  VNI/Label  Router MAC         Nexthop/Overlay GW/ESI\n  50001:11               A   50001      02:05:86:71:3c:00  172.16.1.1\n\n\n\nRouting Table\n\u5f53\u8a72 VRF \u306e Routing Table \u30b5\u30de\u30ea\u30fc\u3092\u898b\u3066\n{master:0}\nkotetsu@spine11> show route instance VRF001 extensive\nVRF001:\n  Router ID: 198.18.1.11\n  Type: vrf               State: Active\n  Interfaces:\n    irb.100\n    irb.300\n    lo0.1\n  Route-distinguisher: 50001:11\n  Vrf-import: [ __vrf-import-VRF001-internal__ ]\n  Vrf-export: [ __vrf-export-VRF001-internal__ ]\n  Vrf-import-target: [ target:64512:50001 ]\n  Vrf-export-target: [ target:64512:50001 ]\n  Fast-reroute-priority: low\n  Tables:\n    VRF001.inet.0          : 9 routes (8 active, 0 holddown, 0 hidden)\n    VRF001.inet.3          : 0 routes (0 active, 0 holddown, 0 hidden)\n    VRF001.iso.0           : 0 routes (0 active, 0 holddown, 0 hidden)\n    VRF001.inet6.0         : 0 routes (0 active, 0 holddown, 0 hidden)\n    VRF001.inet6.3         : 0 routes (0 active, 0 holddown, 0 hidden)\n    VRF001.mdt.0           : 0 routes (0 active, 0 holddown, 0 hidden)\n    VRF001.evpn.0          : 4 routes (4 active, 0 holddown, 0 hidden)\n\n{master:0}\nkotetsu@spine21> show route instance VRF001 extensive\nVRF001:\n  Router ID: 198.18.1.21\n  Type: vrf               State: Active\n  Interfaces:\n    irb.100\n    irb.200\n    lo0.1\n  Route-distinguisher: 50001:21\n  Vrf-import: [ __vrf-import-VRF001-internal__ ]\n  Vrf-export: [ __vrf-export-VRF001-internal__ ]\n  Vrf-import-target: [ target:64512:50001 ]\n  Vrf-export-target: [ target:64512:50001 ]\n  Fast-reroute-priority: low\n  Tables:\n    VRF001.inet.0          : 9 routes (8 active, 0 holddown, 0 hidden)\n    VRF001.inet.3          : 0 routes (0 active, 0 holddown, 0 hidden)\n    VRF001.iso.0           : 0 routes (0 active, 0 holddown, 0 hidden)\n    VRF001.inet6.0         : 0 routes (0 active, 0 holddown, 0 hidden)\n    VRF001.inet6.3         : 0 routes (0 active, 0 holddown, 0 hidden)\n    VRF001.mdt.0           : 0 routes (0 active, 0 holddown, 0 hidden)\n    VRF001.evpn.0          : 4 routes (4 active, 0 holddown, 0 hidden)\n\n\u4e2d\u8eab\u306e\u30b5\u30de\u30ea\u3092\u307f\u308b\u3002\u307e\u305a\u306f\u300cbgp.evpn.0 = Junos OS \u30eb\u30fc\u30c6\u30a3\u30f3\u30b0 \u30d7\u30ed\u30c8\u30b3\u30eb \u30d7\u30ed\u30bb\u30b9\uff08RPD\uff09\u5185\u306e\u30b0\u30ed\u30fc\u30d0\u30eb EVPN \u30eb\u30fc\u30c6\u30a3\u30f3\u30b0 \u30c6\u30fc\u30d6\u30eb\u300d\u3092\n{master:0}\nkotetsu@spine11> show route table bgp.evpn.0\n\nbgp.evpn.0: 9 destinations, 9 routes (9 active, 0 holddown, 0 hidden)\n+ = Active Route, - = Last Active, * = Both\n\n1:172.16.2.1:0::050000fdea0000277400::FFFF:FFFF/304\n                   *[BGP/170] 21:18:16, localpref 100, from 172.31.0.1\n                      AS path: I, validation-state: unverified\n                    > to 192.0.2.1 via xe-0/0/0.0\n1:172.16.2.1:0::050000fdea000027d800::FFFF:FFFF/304\n                   *[BGP/170] 21:18:16, localpref 100, from 172.31.0.1\n                      AS path: I, validation-state: unverified\n                    > to 192.0.2.1 via xe-0/0/0.0\n2:64512:21::10100::00:37:c4:46:d8:01/304\n                   *[BGP/170] 19:24:02, localpref 100, from 172.31.0.1\n                      AS path: I, validation-state: unverified\n                    > to 192.0.2.1 via xe-0/0/0.0\n2:64512:21::10100::02:05:86:71:d8:00/304\n                   *[BGP/170] 09:57:37, localpref 100, from 172.31.0.1\n                      AS path: I, validation-state: unverified\n                    > to 192.0.2.1 via xe-0/0/0.0\n2:64512:21::10100::00:37:c4:46:d8:01::192.168.1.2/304\n                   *[BGP/170] 09:36:35, localpref 100, from 172.31.0.1\n                      AS path: I, validation-state: unverified\n                    > to 192.0.2.1 via xe-0/0/0.0\n2:64512:21::10100::00:37:c4:46:d8:01::192.168.1.2/304\n                   *[BGP/170] 09:36:35, localpref 100, from 172.31.0.1\n                      AS path: I, validation-state: unverified\n                    > to 192.0.2.1 via xe-0/0/0.0\n2:64512:21::10100::02:05:86:71:d8:00::192.168.1.254/304\n                   *[BGP/170] 09:57:37, localpref 100, from 172.31.0.1\n                      AS path: I, validation-state: unverified\n                    > to 192.0.2.1 via xe-0/0/0.0\n3:64512:21::10100::172.16.2.1/304\n                   *[BGP/170] 19:24:02, localpref 100, from 172.31.0.1\n                      AS path: I, validation-state: unverified\n                    > to 192.0.2.1 via xe-0/0/0.0\n5:50001:21::0::192.168.1.0::24/304\n                   *[BGP/170] 21:18:16, localpref 100, from 172.31.0.1\n                      AS path: I, validation-state: unverified\n                    > to 192.0.2.1 via xe-0/0/0.0\n5:50001:21::0::192.168.2.0::24/304\n                   *[BGP/170] 21:18:16, localpref 100, from 172.31.0.1\n                      AS path: I, validation-state: unverified\n                    > to 192.0.2.1 via xe-0/0/0.0\n\n{master:0}\nkotetsu@spine21> show route table bgp.evpn.0\n\nbgp.evpn.0: 9 destinations, 9 routes (9 active, 0 holddown, 0 hidden)\n+ = Active Route, - = Last Active, * = Both\n\n1:172.16.1.1:0::050000fde90000277400::FFFF:FFFF/304\n                   *[BGP/170] 10:02:28, localpref 100, from 172.31.0.1\n                      AS path: I, validation-state: unverified\n                    > to 192.0.2.5 via xe-0/0/0.0\n1:172.16.1.1:0::050000fde90000283c00::FFFF:FFFF/304\n                   *[BGP/170] 21:26:18, localpref 100, from 172.31.0.1\n                      AS path: I, validation-state: unverified\n                    > to 192.0.2.5 via xe-0/0/0.0\n2:64512:11::10100::00:37:c4:e2:60:01/304\n                   *[BGP/170] 19:32:22, localpref 100, from 172.31.0.1\n                      AS path: I, validation-state: unverified\n                    > to 192.0.2.5 via xe-0/0/0.0\n2:64512:11::10100::02:05:86:71:3c:00/304\n                   *[BGP/170] 10:02:28, localpref 100, from 172.31.0.1\n                      AS path: I, validation-state: unverified\n                    > to 192.0.2.5 via xe-0/0/0.0\n2:64512:11::10100::00:37:c4:e2:60:01::192.168.1.1/304\n                   *[BGP/170] 10:01:04, localpref 100, from 172.31.0.1\n                      AS path: I, validation-state: unverified\n                    > to 192.0.2.5 via xe-0/0/0.0\n2:64512:11::10100::02:05:86:71:3c:00::192.168.1.254/304\n                   *[BGP/170] 10:02:28, localpref 100, from 172.31.0.1\n                      AS path: I, validation-state: unverified\n                    > to 192.0.2.5 via xe-0/0/0.0\n3:64512:11::10100::172.16.1.1/304\n                   *[BGP/170] 19:32:21, localpref 100, from 172.31.0.1\n                      AS path: I, validation-state: unverified\n                    > to 192.0.2.5 via xe-0/0/0.0\n5:50001:11::0::192.168.1.0::24/304\n                   *[BGP/170] 10:02:29, localpref 100, from 172.31.0.1\n                      AS path: I, validation-state: unverified\n                    > to 192.0.2.5 via xe-0/0/0.0\n5:50001:11::0::192.168.3.0::24/304\n                   *[BGP/170] 21:26:18, localpref 100, from 172.31.0.1\n                      AS path: I, validation-state: unverified\n                    > to 192.0.2.5 via xe-0/0/0.0\n\n\u6b21\u306b\u5f53\u8a72 VRF \u306e\u3055\u307e\u308a\u30fc\n{master:0}\nkotetsu@spine11> show route table VRF001.evpn.0\n\nVRF001.evpn.0: 4 destinations, 4 routes (4 active, 0 holddown, 0 hidden)\n+ = Active Route, - = Last Active, * = Both\n\n5:50001:11::0::192.168.1.0::24/304\n                   *[EVPN/170] 10:15:34\n                      Indirect\n5:50001:11::0::192.168.3.0::24/304\n                   *[EVPN/170] 21:36:19\n                      Indirect\n5:50001:21::0::192.168.1.0::24/304\n                   *[BGP/170] 21:35:58, localpref 100, from 172.31.0.1\n                      AS path: I, validation-state: unverified\n                    > to 192.0.2.1 via xe-0/0/0.0\n5:50001:21::0::192.168.2.0::24/304\n                   *[BGP/170] 21:35:58, localpref 100, from 172.31.0.1\n                      AS path: I, validation-state: unverified\n                    > to 192.0.2.1 via xe-0/0/0.0\n\n\n{master:0}\nkotetsu@spine11> show route table VRF001.inet.0\n\nVRF001.inet.0: 8 destinations, 9 routes (8 active, 0 holddown, 0 hidden)\n+ = Active Route, - = Last Active, * = Both\n\n192.168.1.0/24     *[Direct/0] 10:11:26\n                    > via irb.100\n                    [EVPN/170] 21:31:50\n                    > to 192.0.2.1 via xe-0/0/0.0\n192.168.1.1/32     *[EVPN/7] 10:10:01\n                    > via irb.100\n192.168.1.254/32   *[Local/0] 10:11:27\n                      Local via irb.100\n192.168.2.0/24     *[EVPN/170] 21:31:50\n                    > to 192.0.2.1 via xe-0/0/0.0\n192.168.3.0/24     *[Direct/0] 21:32:11\n                    > via irb.300\n192.168.3.1/32     *[EVPN/7] 21:31:06\n                    > via irb.300\n192.168.3.254/32   *[Local/0] 21:34:23\n                      Local via irb.300\n198.18.1.11/32     *[Direct/0] 21:34:23\n                    > via lo0.1\n\n{master:0}\nkotetsu@spine21> show route table VRF001.evpn.0\n\nVRF001.evpn.0: 4 destinations, 4 routes (4 active, 0 holddown, 0 hidden)\n+ = Active Route, - = Last Active, * = Both\n\n5:50001:11::0::192.168.1.0::24/304\n                   *[BGP/170] 10:19:12, localpref 100, from 172.31.0.1\n                      AS path: I, validation-state: unverified\n                    > to 192.0.2.5 via xe-0/0/0.0\n5:50001:11::0::192.168.3.0::24/304\n                   *[BGP/170] 21:43:01, localpref 100, from 172.31.0.1\n                      AS path: I, validation-state: unverified\n                    > to 192.0.2.5 via xe-0/0/0.0\n5:50001:21::0::192.168.1.0::24/304\n                   *[EVPN/170] 10:18:58\n                      Indirect\n5:50001:21::0::192.168.2.0::24/304\n                   *[EVPN/170] 21:54:15\n                      Indirect\n\n\n{master:0}\nkotetsu@spine21> show route table VRF001.inet.0\n\nVRF001.inet.0: 8 destinations, 9 routes (8 active, 0 holddown, 0 hidden)\n+ = Active Route, - = Last Active, * = Both\n\n192.168.1.0/24     *[Direct/0] 10:16:27\n                    > via irb.100\n                    [EVPN/170] 10:16:41\n                    > to 192.0.2.5 via xe-0/0/0.0\n192.168.1.2/32     *[EVPN/7] 10:16:10\n                    > via irb.100\n192.168.1.254/32   *[Local/0] 10:16:27\n                      Local via irb.100\n192.168.2.0/24     *[Direct/0] 21:51:44\n                    > via irb.200\n192.168.2.2/32     *[EVPN/7] 21:39:37\n                    > via irb.200\n192.168.2.254/32   *[Local/0] 21:54:08\n                      Local via irb.200\n192.168.3.0/24     *[EVPN/170] 21:40:30\n                    > to 192.0.2.5 via xe-0/0/0.0\n198.18.1.21/32     *[Direct/0] 21:54:08\n                    > via lo0.1\n\n\u6700\u5f8c\u306b Type 5 route \u306e\u8a73\u7d30\u3092\u898b\u3066\u304a\u304f\u3002\u3053\u3044\u3064\u3089\u306f VRF001.evpn.0 \u306b\u3082\u30ed\u30fc\u30c9\u3055\u308c\u3066\u3044\u308b\u3002\n{master:0}\nkotetsu@spine11> show route table bgp.evpn.0 extensive\n\n...\n\n5:50001:21::0::192.168.1.0::24/304 (1 entry, 0 announced)\n        *BGP    Preference: 170/-101\n                Route Distinguisher: 50001:21\n                Next hop type: Indirect, Next hop index: 0\n                Address: 0xaa605f0\n                Next-hop reference count: 18\n                Source: 172.31.0.1\n                Protocol next hop: 172.16.2.1\n                Indirect next hop: 0x2 no-forward INH Session ID: 0x0\n                State: <Active Int Ext>\n                Local AS: 65001 Peer AS: 64512\n                Age: 21:25:33   Metric2: 0\n                Validation State: unverified\n                Task: BGP_64512_64512.172.31.0.1\n                AS path: I (Originator)\n                Cluster list:  172.31.0.1\n                Originator ID: 172.16.2.1\n                Communities: target:64512:50001 encapsulation0:0:0:0:vxlan router-mac:02:05:86:71:d8:00\n                Import Accepted\n                Route Label: 50001\n                Overlay gateway address: 0.0.0.0\n                ESI 00:00:00:00:00:00:00:00:00:00\n                Localpref: 100\n                Router ID: 172.31.0.1\n                Secondary Tables: VRF001.evpn.0\n                Indirect next hops: 1\n                        Protocol next hop: 172.16.2.1\n                        Indirect next hop: 0x2 no-forward INH Session ID: 0x0\n                        Indirect path forwarding next hops: 1\n                                Next hop type: Router\n                                Next hop: 192.0.2.1 via xe-0/0/0.0\n                                Session Id: 0x0\n                        172.16.2.1/32 Originating RIB: inet.0\n                          Node path count: 1\n                          Forwarding nexthops: 1\n                                Nexthop: 192.0.2.1 via xe-0/0/0.0\n\n5:50001:21::0::192.168.2.0::24/304 (1 entry, 0 announced)\n        *BGP    Preference: 170/-101\n                Route Distinguisher: 50001:21\n                Next hop type: Indirect, Next hop index: 0\n                Address: 0xaa605f0\n                Next-hop reference count: 18\n                Source: 172.31.0.1\n                Protocol next hop: 172.16.2.1\n                Indirect next hop: 0x2 no-forward INH Session ID: 0x0\n                State: <Active Int Ext>\n                Local AS: 65001 Peer AS: 64512\n                Age: 21:25:33   Metric2: 0\n                Validation State: unverified\n                Task: BGP_64512_64512.172.31.0.1\n                AS path: I (Originator)\n                Cluster list:  172.31.0.1\n                Originator ID: 172.16.2.1\n                Communities: target:64512:50001 encapsulation0:0:0:0:vxlan router-mac:02:05:86:71:d8:00\n                Import Accepted\n                Route Label: 50001\n                Overlay gateway address: 0.0.0.0\n                ESI 00:00:00:00:00:00:00:00:00:00\n                Localpref: 100\n                Router ID: 172.31.0.1\n                Secondary Tables: VRF001.evpn.0\n                Indirect next hops: 1\n                        Protocol next hop: 172.16.2.1\n                        Indirect next hop: 0x2 no-forward INH Session ID: 0x0\n                        Indirect path forwarding next hops: 1\n                                Next hop type: Router\n                                Next hop: 192.0.2.1 via xe-0/0/0.0\n                                Session Id: 0x0\n                        172.16.2.1/32 Originating RIB: inet.0\n                          Node path count: 1\n                          Forwarding nexthops: 1\n                                Nexthop: 192.0.2.1 via xe-0/0/0.0\n\n{master:0}\nkotetsu@spine21> show route table bgp.evpn.0 extensive\n\n...\n\n5:50001:11::0::192.168.1.0::24/304 (1 entry, 0 announced)\n        *BGP    Preference: 170/-101\n                Route Distinguisher: 50001:11\n                Next hop type: Indirect, Next hop index: 0\n                Address: 0xaa60170\n                Next-hop reference count: 18\n                Source: 172.31.0.1\n                Protocol next hop: 172.16.1.1\n                Indirect next hop: 0x2 no-forward INH Session ID: 0x0\n                State: <Active Int Ext>\n                Local AS: 65002 Peer AS: 64512\n                Age: 10:04:02   Metric2: 0\n                Validation State: unverified\n                Task: BGP_64512_64512.172.31.0.1\n                AS path: I (Originator)\n                Cluster list:  172.31.0.1\n                Originator ID: 172.16.1.1\n                Communities: target:64512:50001 encapsulation0:0:0:0:vxlan router-mac:02:05:86:71:3c:00\n                Import Accepted\n                Route Label: 50001\n                Overlay gateway address: 0.0.0.0\n                ESI 00:00:00:00:00:00:00:00:00:00\n                Localpref: 100\n                Router ID: 172.31.0.1\n                Secondary Tables: VRF001.evpn.0\n                Indirect next hops: 1\n                        Protocol next hop: 172.16.1.1\n                        Indirect next hop: 0x2 no-forward INH Session ID: 0x0\n                        Indirect path forwarding next hops: 1\n                                Next hop type: Router\n                                Next hop: 192.0.2.5 via xe-0/0/0.0\n                                Session Id: 0x0\n                        172.16.1.1/32 Originating RIB: inet.0\n                          Node path count: 1\n                          Forwarding nexthops: 1\n                                Nexthop: 192.0.2.5 via xe-0/0/0.0\n\n5:50001:11::0::192.168.3.0::24/304 (1 entry, 0 announced)\n        *BGP    Preference: 170/-101\n                Route Distinguisher: 50001:11\n                Next hop type: Indirect, Next hop index: 0\n                Address: 0xaa60170\n                Next-hop reference count: 18\n                Source: 172.31.0.1\n                Protocol next hop: 172.16.1.1\n                Indirect next hop: 0x2 no-forward INH Session ID: 0x0\n                State: <Active Int Ext>\n                Local AS: 65002 Peer AS: 64512\n                Age: 21:27:51   Metric2: 0\n                Validation State: unverified\n                Task: BGP_64512_64512.172.31.0.1\n                AS path: I (Originator)\n                Cluster list:  172.31.0.1\n                Originator ID: 172.16.1.1\n                Communities: target:64512:50001 encapsulation0:0:0:0:vxlan router-mac:02:05:86:71:3c:00\n                Import Accepted\n                Route Label: 50001\n                Overlay gateway address: 0.0.0.0\n                ESI 00:00:00:00:00:00:00:00:00:00\n                Localpref: 100\n                Router ID: 172.31.0.1\n                Secondary Tables: VRF001.evpn.0\n                Indirect next hops: 1\n                        Protocol next hop: 172.16.1.1\n                        Indirect next hop: 0x2 no-forward INH Session ID: 0x0\n                        Indirect path forwarding next hops: 1\n                                Next hop type: Router\n                                Next hop: 192.0.2.5 via xe-0/0/0.0\n                                Session Id: 0x0\n                        172.16.1.1/32 Originating RIB: inet.0\n                          Node path count: 1\n                          Forwarding nexthops: 1\n                                Nexthop: 192.0.2.5 via xe-0/0/0.0\n\n\nMAC \u30a2\u30c9\u30ec\u30b9\u30c6\u30fc\u30d6\u30eb\nType 2 \u304b\u3089\u5b66\u7fd2\u3057\u3066\u3044\u308b\u306e\u306f\u3001\u4e21\u65b9\u306e VTEP \u306b\u304f\u3063\u3064\u3051\u3066\u3044\u308b VLAN 100 = VNI 10100 \u306e\u307f\n{master:0}\nkotetsu@spine11> show ethernet-switching table\n\nMAC flags (S - static MAC, D - dynamic MAC, L - locally learned, P - Persistent static\n           SE - statistics enabled, NM - non configured MAC, R - remote PE MAC, O - ovsdb MAC)\n\n\nEthernet switching table : 4 entries, 4 learned\nRouting instance : default-switch\n   Vlan                MAC                 MAC      Logical                Active\n   name                address             flags    interface              source\n   VLAN0100            00:37:c4:46:d8:01   D        vtep.32769             172.16.2.1\n   VLAN0100            00:37:c4:e2:60:01   D        xe-0/0/1.0\n   VLAN0100            02:05:86:71:d8:00   D        vtep.32769             172.16.2.1\n   VLAN0300            00:37:c4:0d:a8:01   D        xe-0/0/1.0\n\n{master:0}\nkotetsu@spine21> show ethernet-switching table\n\nMAC flags (S - static MAC, D - dynamic MAC, L - locally learned, P - Persistent static\n           SE - statistics enabled, NM - non configured MAC, R - remote PE MAC, O - ovsdb MAC)\n\n\nEthernet switching table : 4 entries, 4 learned\nRouting instance : default-switch\n   Vlan                MAC                 MAC      Logical                Active\n   name                address             flags    interface              source\n   VLAN0100            00:37:c4:46:d8:01   D        xe-0/0/1.0\n   VLAN0100            00:37:c4:e2:60:01   D        vtep.32769             172.16.1.1\n   VLAN0100            02:05:86:71:3c:00   D        vtep.32769             172.16.1.1\n   VLAN0200            00:37:c4:3d:e0:01   D        xe-0/0/1.0\n\n\n\u901a\u4fe1\u78ba\u8a8d\u8a73\u7d30(DataPlane)\n\u5404\u901a\u4fe1\u306e\u69d8\u5b50\u3092\u898b\u3066\u3044\u304d\u307e\u3059\u3002\u305d\u308c\u305e\u308c\u3001\u5b9f\u884c\u524d\u306b sudo ip n flush dev ens4 \u3068\u304b\u3057\u3066\u307e\u3059\u3002\n\nL3 Symmetric\nnode22(192.168.2.2/24) \u304b\u3089 node13(192.168.3.1/24) \u3078 ping\n\u4ee5\u4e0b\u3001ICMP Echo request \u3092 spine21 \u3068 bb01 \u9593\u3067\u62fe\u3063\u305f\u3082\u306e\u3002\nVXLAN\u30ab\u30d7\u30bb\u30eb\u5185\u306e Eth \u30d8\u30c3\u30c0\u3092\u898b\u308b\u3068\u3001Type5\u3067\u5b66\u7fd2\u3057\u305f spine11 \u306e irb MAC \u30a2\u30c9\u30ec\u30b9\u3092 Dst \u306b\u6307\u5b9a\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n\n\u306a\u304a\u3001ICMP Echo Reply \u3082\u540c\u3058\u611f\u3058\u3067\u3059\u3002\n\nL2 over L3\nnode21(192.168.1.2/24) \u304b\u3089 node11(192.168.1.1/24) \u3078 ping\n\u3053\u308c\u306f\u524d\u56de\u3068\u540c\u69d8\u306b\u3001\u5358\u7d14\u306b VNI 10100 \u3067\u30ab\u30d7\u30bb\u30eb\u5316\u3055\u308c\u3066\u901a\u4fe1\u3057\u3066\u3044\u308b\u3060\u3051\u3002\n\n\nL3 \u5f80\u8def Symmetric \u5fa9\u8def Asymmetric\nnode11(192.168.1.1/24) \u304b\u3089 node22(192.168.2.2/24) \u3078 ping\n\u3053\u306e\u30b1\u30fc\u30b9\u304c\u3001\u3069\u3046\u52d5\u304f\u306e\u304b\u30a4\u30de\u30a4\u30c1\u4e88\u6e2c\u3067\u304d\u306a\u304b\u3063\u305f\u3068\u3053\u308d\u3067\u3059\u3002\n\n\u5f80\u8def node11 \u304c\u30b2\u30fc\u30c8\u30a6\u30a7\u30a4IP\u30a2\u30c9\u30ec\u30b9(192.168.1.254) ARP \u89e3\u6c7a\u3092\u8a66\u307f\u308b\n\u5f80\u8def spine11 \u304c node11 \u306b \u81ea\u8eab\u306e irb MAC \u30a2\u30c9\u30ec\u30b9\u3092\u7b54\u3048\u308b (\u3053\u306e\u6642\u300c\u81ea\u5206\u304c\u5fdc\u7b54\u3057\u305f\u306e\u3067 ARP request \u3092 VNI 10100 \u65b9\u9762\u306b\u306f\u8ee2\u9001\u3057\u306a\u3044\u300d\u3068\u3044\u3046\u52d5\u4f5c\u306b\u306a\u3063\u3066\u304f\u308c\u308b\u306e\u304b\u5426\u304b\u304c\u4e88\u60f3\u3067\u304d\u306a\u304b\u3063\u305f & \u78ba\u8a8d\u3057\u305f\u304b\u3063\u305f)\n\u5f80\u8def spine11 \u306f node11 \u304b\u3089\u306e Dst IP(192.168.2.2/24) \u306a ICMP Echo request \u30d1\u30b1\u30c3\u30c8\u3092\u53d7\u4fe1\u3057\u3001Type5 \u3067\u5f97\u305f\u60c5\u5831\u306b\u5f93\u3044 VNI 50001 \u3067\u30ab\u30d7\u30bb\u30eb\u5316\u3057\u3066 spine21 \u306b\u6295\u3052\u308b (Symmetric)\n\u5f80\u8def spine21 \u306f\u81ea\u5206\u306e irb direct \u914d\u4e0b\u306b\u3044\u308b node22 \u306b\u30d5\u30a9\u30ef\u30fc\u30c9\u3059\u308b\u3060\u3051\n\u5fa9\u8def node22 \u306f\u30b2\u30fc\u30c8\u30a6\u30a7\u30a4IP\u30a2\u30c9\u30ec\u30b9(192.168.2.254)\u306e ARP \u89e3\u6c7a\u3092\u3057\u3066\u3001spine21 \u306e irb MAC \u306b ICMP Echo Reply \u6295\u3052\u308b\n\u5fa9\u8def spine21 \u306f node22 \u304b\u3089\u306e Dst IP(192.168.1.1/24) \u306a ICMP Echo Reply \u30d1\u30b1\u30c3\u30c8\u3092\u53d7\u4fe1\u3057\u3001Type2 \u3067\u5f97\u305f\u60c5\u5831\u306b\u5f93\u3044 VNI 10100 \u3067\u30ab\u30d7\u30bb\u30eb\u5316\u3057\u3066 spine11 \u306b\u6295\u3052\u308b (Asymmetric)\n\u5fa9\u8def spine11 \u306f\u81ea\u5206\u306e irb direct \u914d\u4e0b\u306b\u3044\u308b node11 \u306b\u30d5\u30a9\u30ef\u30fc\u30c9\u3059\u308b\u3060\u3051\n\n\u3068\u3044\u3046\u611f\u3058\u306b\u4e88\u6e2c\u3057\u3066\u3001\u884c\u304d\u3068\u623b\u308a\u306e VNI \u304c\u7570\u306a\u308b\u8ad6\u7406\u7684\u306b\u975e\u5bfe\u79f0\u306a\u901a\u4fe1\u3067\u3061\u3083\u3093\u3068\u6210\u308a\u7acb\u3063\u3066\u3044\u308b\u306e\u304b\u3001\u3063\u3066\u3044\u3046\u306e\u3068\u592a\u5b57\u7b87\u6240\u3092\u898b\u3066\u3044\u304d\u307e\u3059\u3002\u3044\u3084\u307e\u3042\u758e\u901a\u306f\u78ba\u8a8d\u6e08\u306a\u3093\u3067\u3059\u304c\u3002\n\u307e\u305a node11 \u3067\u62fe\u3063\u305f\u30d1\u30b1\u30c3\u30c8\u3092\u898b\u308b\u3068...\u306f\u3044\u3001\u4e0a\u8a18\u306e\u592a\u5b57\u7b87\u6240\u306f\u671f\u5f85\u3057\u305f\u52d5\u4f5c\u306b\u306a\u3063\u3066\u3044\u306a\u3044\u3067\u3059\u306d\u3002\nspine11 \u3068 spine21 \u53cc\u65b9\u306e irb \u304b\u3089 ARP Reply \u304c\u6765\u3066\u3044\u3066(\u30d1\u30b1\u30c3\u30c8No.2\u30684)\u3001\u305f\u307e\u305f\u307e node \u306e\u4ed5\u69d8\u7684\u306b\u5148\u306b\u8fd4\u3063\u3066\u304d\u305f spine11 \u5074\u306e MAC \u30a2\u30c9\u30ec\u30b9\u3092\u4f7f\u3063\u3066\u3044\u305f\u306b\u904e\u304e\u306a\u3044\u3088\u3046\u3067\u3059\u3002\n\n\u4e0a\u8a18\u306e\u52d5\u4f5c\u3092\u3001\u4eca\u5ea6\u306f spine11 \u3068 bb01 \u9593\u3067\u62fe\u3063\u305f\u30d1\u30b1\u30c3\u30c8\u3067\u8ffd\u3063\u3066\u307f\u307e\u3059\u3002\n\u3053\u306e\u30d1\u30b1\u30c3\u30c8No.16 \u304c\u300c\u81ea\u5206\u304c node11 \u306b ARP Reply \u3057\u305f\u76f4\u5f8c\u3001ARP Request \u3092 VNI 10100 \u3067 spine21 \u65b9\u9762\u306b Ingress Replication \u3057\u3066\u3044\u308b\u300d\u3084\u3064\u3067\u3059\u3002\n\n\u5f53\u7136\u3001spine21 \u5074\u306f\u901a\u5e38\u901a\u308a ARP Reply \u3092\u8fd4\u3057\u3066\u304f\u308c\u308b\u3057\u3001\u305d\u308c\u306f\u5148\u307b\u3069 node11 \u5074\u3067\u898b\u305f\u901a\u308a node11 \u306b\u3082\u4f1d\u642c\u3055\u308c\u307e\u3059\u3002\n\n\u3068\u3044\u3046\u3053\u3068\u3067\u3001ARP Request \u306b\u5bfe\u3059\u308b Reply \u306e\u52d5\u4f5c\u78ba\u8a8d\u306f\u3001\u81ea\u5206\u304c\u671f\u5f85\u3057\u3066\u3044\u305f\u306e\u3068\u9055\u3046\u52d5\u304d\u306e\u3088\u3046\u3067\u3059\u3002\n\u69cb\u6210\u3084\u8a2d\u5b9a\u3067\u3069\u3046\u306b\u304b\u5de7\u3044\u3053\u3068\u306a\u3089\u306a\u3044\u304b...\u3063\u3066\u3068\u3053\u308d\u306f\u6df1\u8ffd\u3044\u3057\u3066\u3044\u307e\u305b\u3093\u3002\n(\u8a66\u3057\u306b spine[12]1 \u53cc\u65b9\u3067 set interfaces irb unit 100 mac 00:00:5e:00:53:99 \u3068\u304b\u3057\u3066\u540c\u3058 MAC \u30a2\u30c9\u30ec\u30b9\u3092\u6301\u305f\u305b\u3066\u307f\u305f\u308a\u306f\u3057\u307e\u3057\u305f\u304c...\u305d\u308c\u3067\u3082\u901a\u4fe1\u306f\u53ef\u80fd\u3060\u3051\u308c\u3069\u3001\u7279\u306b\u4ee3\u8868\u52d5\u4f5c\u3068\u304b\u3092\u3057\u306a\u3044IP/MAC\u91cd\u8907\u72b6\u614b\u306a\u306e\u3067\u3001\u5065\u5168\u306a\u72b6\u614b\u3068\u306f\u8a00\u3048\u306a\u3044\u304b\u3068\u3002)\n\u3042\u3001\u5f80\u8def VNI 50001, \u5fa9\u8def VNI 10100 \u306b\u95a2\u3057\u3066\u306f\u3001\u60f3\u5b9a\u901a\u308a\u306e\u52d5\u304d\u3067\u3057\u305f\u3002\n\n\n\n\u30d1\u30b1\u30c3\u30c8\u30ad\u30e3\u30d7\u30c1\u30e3(ControlPlane)\nEVPN NLRI Type5 \u306e UPDATE \u3068 WithDrawn \u3092\u8efd\u304f\u898b\u3066\u304a\u304d\u307e\u3059\u3002\n\u307e\u305a\u306f WithDrawn \u3092 spine21 \u304b\u3089\u5410\u304b\u305b\u305f\u6642(\u96d1\u306b deactivate routing-instance VRF001 \u3068\u304b\u3067)\n\n\nUPDATE \u3092 spine21 \u304b\u3089\u5410\u304b\u305b\u305f\u6642(\u96d1\u306b rollback 1 \u3068\u304b\u3067)\n\n\n\u304a\u3057\u307e\u3044\n\nJuniper vQFX10000 \u3067\u3082 EVPN NLRI Type5 \u304c\u52d5\u304f\u3053\u3068\u3092\u78ba\u8a8d\u3067\u304d\u307e\u3057\u305f\nVRF to VRF \u52d5\u4f5c\u3068 L2VPN \u3092\u4f75\u7528\u3059\u308b\u5834\u5408\u3001\u4f55\u3089\u304b\u306e\u5de5\u592b\u304c\u5fc5\u8981\u305d\u3046\u3060\u3068\u3044\u3046\u3053\u3068\u306f\u5206\u304b\u308a\u307e\u3057\u305f\n\n\n\nL3 \u5f80\u8def Symmetric \u5fa9\u8def Asymmetric \u3067\u30a6\u30c0\u30a6\u30c0\u66f8\u3044\u305f\u901a\u308a\n\u305d\u3082\u305d\u3082 MX \u3092\u4f7f\u3063\u3066 MAC VRF \u4f7f\u3046\u3001\u306e\u304c\u5e38\u9053\u306a\u306e\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u304c\n\n\n\n[\u5148\u65e5(vQFX10000 \u3092 KVM+GNS3 \u3067\u52d5\u304b\u3059)](http://qiita.com/kakkotetsu/items/af579a52b02aa2e4b65e)\u3001Juniper vQFX10000(\u4ee5\u964d vQFX) \u306e DL \u6a29\u9650\u3092\u500b\u4eba\u3067\u5f97\u3066 GNS3 \u3067\u8efd\u304f\u52d5\u4f5c\u78ba\u8a8d\u3092\u3068\u308a\u3001[\u524d\u56de(vQFX10000 \u3067 VXLAN+EVPN (L2 over L3 \u7de8))](http://qiita.com/kakkotetsu/items/e061283d7e312f808c98)\u3001\u4eee\u60f3\u7248\u3067\u3082 L2VPN \u6a5f\u80fd\u304c\u52d5\u304f\u3053\u3068\u3092\u78ba\u8a8d\u3057\u307e\u3057\u305f\u3002\nQFX10000\u7cfb\u3067\u306f EVPN NLRI Type5 Route (\u53c2\u8003\u8cc7\u6599\u306e draft \u53c2\u7167)\u3067 Symmetric \u306a evpn-inter-subnet-forwarding \u304c\u3067\u304d\u308b\u3088\u3046\u306a\u306e\u3067\u3001\u4eca\u56de\u306f vQFX \u3067\u305d\u308c\u3092\u8a66\u3057\u307e\u3059\u3002(\u3042\u3089\u3059\u3058\u304c\u9577\u3044...)\n\n# \u6700\u521d\u306b\n\n## \u672c\u9805\u3067\u3084\u308b\u3053\u3068\n\n- vQFX \u3067 VXLAN \u306e Control Plane \u3068\u3057\u3066 EVPN \u3092\u52d5\u304b\u3059\n- EVPN NLRI Type5(EVPN Prefix Advertisement) \u3092\u4f7f\u3063\u3066 evpn-inter-subnet-forwarding (Symmetric)\u3092\u52d5\u304b\u3059\n- \u524d\u56de\u306e NLRI Type2+3 \u3092\u4f7f\u3063\u305f L2 over L3 \u3082\u4f75\u7528\u3067\u304d\u308b\u304b\u78ba\u8a8d\u3059\u308b\n    - \u4e0b\u56f3\u306e\u8d64\u3044\u70b9\u7dda\u90e8\u5206\n    - Type5 \u3092\u4f7f\u3063\u3066 VRFtoVRF \u3057\u3066\u3044\u308b\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u3067\u306f\u300c\u30bb\u30b0\u30e1\u30f3\u30c8\u304c\u5358\u4e00\u30b5\u30a4\u30c8(/\u90e8\u5c4b)\u306b\u9589\u3058\u308b\u5834\u5408\u306b\u306f\u300d\u3068\u3044\u3046\u6587\u8a00\u304c\u3042\u3063\u305f\u308a\u3059\u308b\u3051\u308c\u3069\n\n![03_00.png](https://qiita-image-store.s3.amazonaws.com/0/60456/4729531b-be8e-ff43-48bb-7ede09d15d1e.png)\n\n\n\n## \u6982\u8981\u69cb\u6210\u56f3\n\n[\u524d\u56de](http://qiita.com/kakkotetsu/items/af579a52b02aa2e4b65e)\u306b\u5f15\u304d\u7d9a\u304d\u3001\u4e0b\u56f3\u306e\u611f\u3058\u3067\u3002\n\n\n![03_01.png](https://qiita-image-store.s3.amazonaws.com/0/60456/8a672c5b-7b7b-05b7-5943-83b29adca9f9.png)\n\n\u4f59\u8ac7\u3002\n\u672c\u74b0\u5883\u306e `GNS3 1.5.2` \u3067\u30d1\u30b1\u30c3\u30c8\u30ad\u30e3\u30d7\u30c1\u30e3\u3059\u308b\u305f\u3081\u306b\u3001qemu \u540c\u58eb\u3092\u76f4\u7d50\u305b\u305a\u306b\u3001\u9593\u306b GNS3 \u306e Ethernet Switch \u3092\u631f\u3080\u69cb\u6210\u306b\u3057\u3066\u307e\u3059\u3002\u304c\u3001\u300c[pelican@ainoniwa.net / GNS3 2.0\u304b\u3089\u306fKVM\u9593\u306e\u30d1\u30b1\u30c3\u30c8\u30ad\u30e3\u30d7\u30c1\u30e3\u3082\u53d6\u308c\u308b\u3088\u3046\u306b\u306a\u308b\u305e\u3044](https://www.ainoniwa.net/pelican/2017/0104a.html)\u300d\u306e\u3088\u3046\u306b `GNS3 2.0`(2017/01/04 \u6642\u70b9\u3067\u306f beta \u7248)\u3092\u4f7f\u3048\u3070\u3001\u3053\u308c\u304c\u4e0d\u8981\u306b\u306a\u308b\u3088\u3046\u3067\u3059\u3002\u3084\u3063\u305f\u305c\uff01\n\n\n## \u53c2\u8003\u8cc7\u6599\n\n- [\u524d\u56de\u306e\u53c2\u8003\u8cc7\u6599 \u5168\u822c](http://qiita.com/kakkotetsu/items/e061283d7e312f808c98#%E5%8F%82%E8%80%83%E8%B3%87%E6%96%99)\n- EVPN \u6a19\u6e96\n    - [draft-ietf-bess-evpn-prefix-advertisement-03 (IP Prefix Advertisement in EVPN)](https://tools.ietf.org/html/draft-ietf-bess-evpn-prefix-advertisement-03)\n        - EVPN NLRI Type5 \u3092\u4f7f\u3063\u3066 IP-VRF to IP-VRF \u3067 IP Prefix Advertise \u3057\u3088\u3046\u3068\u3044\u3046\u304a\u8a71\n    - [draft-ietf-bess-evpn-inter-subnet-forwarding-01 (Integrated Routing and Bridging in EVPN)](https://tools.ietf.org/html/draft-ietf-bess-evpn-inter-subnet-forwarding-01)\n        - L3 \u5168\u822c\n        - `Asymmetric` \u3068 `Symmetric` \u306b\u95a2\u3059\u308b\u8a71\u306f\u3053\u308c\u3092\u8aad\u3080\u3068\u308f\u304b\u308b\n- JUNOS \u3067\u306e VXLAN+EVPN inter-subnet-forwarding \u5b9f\u88c5\u30fb\u8a2d\u5b9a\u5468\u308a\n    - [Juniper\u516c\u5f0f / ip-prefix-routes \u30b3\u30de\u30f3\u30c9 at JUNOS15.1](https://www.juniper.net/techpubs/en_US/junos15.1/topics/reference/configuration-statement/ip-prefix-routes-edit-routing-instances-protocols-evpn.html)\n        - `Statement introduced in Junos OS Release 15.1x53-D60 for QFX10000 Series switches.` \u3060\u305d\u3046\u306a\n        - \u3093\u3067 vQFX(`15.1X53-D60.4`)\u3067\u3082\u8a2d\u5b9a\u53ef\u80fd\n    - \u5c11\u3057\u524d\u306e\u5b9f\u88c5\n        - [Juniper\u516c\u5f0f / ip-prefix-support \u30b3\u30de\u30f3\u30c9 at JUNOS15.1](https://www.juniper.net/techpubs/en_US/junos15.1/topics/reference/configuration-statement/ip-prefix-support-edit-routing-instances.html)\n            - `Statement introduced in Junos OS Release 15.1x53-D30 on QFX10002 switches.` \u3060\u305d\u3046\u3067\n            - `This statement is deprecated starting with Junos OS Release 15.1x53-D60 and has been replaced with ip-prefix-routes.` \u3063\u3066\u3053\u3068\u3089\u3057\u304f\u3001\u30d0\u30fc\u30b8\u30e7\u30f3\u3092\u3042\u3052\u308b\u3068\u81ea\u52d5\u7684\u306b `ip-prefix-routes` \u306b\u306a\u308b\u3089\u3057\u3044\u306e\u3067\n            - vQFX(`15.1X53-D60.4`)\u3067\u306f\u8a2d\u5b9a\u4e0d\u53ef\n        - [Juniper\u516c\u5f0f / Configuring EVPN Type 5 for QFX10000 Series Switches / Configuration Example](https://www.juniper.net/techpubs/en_US/release-independent/solutions/information-products/pathway-pages/solutions/evpn-type5-configuring.pdf)\n            - \u4e0a\u8a18\u3092\u7528\u3044\u305f\u5206\u304b\u308a\u3084\u3059\u3044\u30b5\u30f3\u30d7\u30eb\n    - [NetOne \u30b3\u30e9\u30e0 / EVPN \u3067\u5909\u308f\u308b\u30fb\u5909\u3048\u3089\u308c\u308b\u30c7\u30fc\u30bf\u30bb\u30f3\u30bf\u30fc\u30cd\u30c3\u30c8\u30ef\u30fc\u30af1](http://www.netone.co.jp/report/column/20160308.html)\n        - Juniper MX \u3092\u4f7f\u3063\u305f L2 + L3 \u306e\u5177\u4f53\u7684\u306a\u4f8b(2016/03 \u6642\u70b9\u306e\u3082\u306e\u307f\u305f\u3044)\n        - \u591a\u5206\u3053\u308c\u306f `Asymmetric` \u306a\u3084\u3064\n        - \u65e5\u672c\u8a9e\u3067\u5699\u307f\u7815\u3044\u305f\u8aac\u660e\n- \u305d\u306e\u4ed6\n    - [Cisco \u767a\u8868\u8cc7\u6599(20160120) / VXLAN\u30c1\u30e5\u30fc\u30c8\u30ea\u30a2\u30eb](https://www.janog.gr.jp/meeting/janog37/download_file/view/169/226)\n        - \u30b9\u30e9\u30a4\u30c9 16-25 \u306b `Asymmetric` \u3068 `Symmetric` \u306e\u565b\u307f\u7815\u3044\u3060\u65e5\u672c\u8a9e\u56f3\u89e3\u3042\u308a\n        - \u3053\u306e\u6642\u70b9\u3067\u306f\u300cJuniper \u306e\u306f `Asymmetric` \u5b9f\u88c5\u30fbCisco \u306e\u306f `Symmetric` \u5b9f\u88c5\u300d\u3068\u7d39\u4ecb\u3055\u308c\u3066\u3044\u308b\u304c\n        - 2017/01\u73fe\u5728\u306f Juniper \u306b\u3082 `Symmetric` \u5b9f\u88c5\u304c\u3042\u308b\u3088\u3001\u3068\u3044\u3046\u306e\u3092\u672c\u9805\u3067\u6271\u3046\n\n\n\n# \u69cb\u7bc9\uff5e\u52d5\u4f5c\u78ba\u8a8d\n\n## GNS3 \u3067\u30c7\u30d7\u30ed\u30a4\n\n\u524d\u56de\u306e\u74b0\u5883\u3092\u5f15\u304d\u7d9a\u304d\u4f7f\u3044\u307e\u3059\u3002\u5148\u306b\u3042\u3052\u305f\u6982\u8981\u69cb\u6210\u56f3\u306e\u901a\u308a\u3002\n\n## \u758e\u901a\u78ba\u8a8d\u7528 node \u8a2d\u5b9a\n\n\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u611f\u3058\u3067\n\n```bash\nkotetsu@node11:~$ ip a show dev ens4\n3: ens4: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000\n    link/ether 00:37:c4:e2:60:01 brd ff:ff:ff:ff:ff:ff\n    inet 192.168.1.1/24 brd 192.168.1.255 scope global ens4\n       valid_lft forever preferred_lft forever\n    inet6 fe80::237:c4ff:fee2:6001/64 scope link\n       valid_lft forever preferred_lft forever\n\nkotetsu@node11:~$ ip route show dev ens4\n192.168.0.0/16 via 192.168.1.254\n192.168.1.0/24  proto kernel  scope link  src 192.168.1.1\n```\n\n```bash\nkotetsu@node21:~$ ip a show dev ens4\n3: ens4: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000\n    link/ether 00:37:c4:46:d8:01 brd ff:ff:ff:ff:ff:ff\n    inet 192.168.1.2/24 brd 192.168.1.255 scope global ens4\n       valid_lft forever preferred_lft forever\n    inet6 fe80::237:c4ff:fe46:d801/64 scope link\n       valid_lft forever preferred_lft forever\n\nkotetsu@node21:~$ ip route show dev ens4\n192.168.0.0/16 via 192.168.1.254\n192.168.1.0/24  proto kernel  scope link  src 192.168.1.2\n```\n\n```bash\nkotetsu@node22:~$ ip a show dev ens4\n3: ens4: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000\n    link/ether 00:37:c4:3d:e0:01 brd ff:ff:ff:ff:ff:ff\n    inet 192.168.2.2/24 brd 192.168.2.255 scope global ens4\n       valid_lft forever preferred_lft forever\n    inet6 fe80::237:c4ff:fe3d:e001/64 scope link\n       valid_lft forever preferred_lft forever\n\nkotetsu@node22:~$ ip route show dev ens4\n192.168.0.0/16 via 192.168.2.254\n192.168.2.0/24  proto kernel  scope link  src 192.168.2.2\n```\n\n```bash\nkotetsu@node13:~$ ip a show dev ens4\n3: ens4: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000\n    link/ether 00:37:c4:0d:a8:01 brd ff:ff:ff:ff:ff:ff\n    inet 192.168.3.1/24 brd 192.168.3.255 scope global ens4\n       valid_lft forever preferred_lft forever\n    inet6 fe80::237:c4ff:fe0d:a801/64 scope link\n       valid_lft forever preferred_lft forever\n\nkotetsu@node13:~$ ip route show dev ens4\n192.168.0.0/16 via 192.168.3.254\n192.168.3.0/24  proto kernel  scope link  src 192.168.3.1\n```\n\n\n## vQFX \u57fa\u672c\u8a2d\u5b9a\u3061\u3087\u3044\u305f\u3057\n\nEVPN \u306b\u3053\u3093\u306a\u8a2d\u5b9a\u3092\u3057\u3066 `/var/log/evpn.log` \u3067\u8ffd\u3048\u308b\u3088\u3046\u306b\u3057\u3068\u304d\u307e\u3057\u305f\u3002`flag all` \u306b\u3057\u305f\u3089\u3061\u3087\u3063\u3068\u8ffd\u3044\u304d\u308c\u306a\u3044\u60c5\u5831\u91cf\u306b\u306a\u3063\u305f\u306e\u3067\u3001\u305d\u3053\u306f\u304a\u597d\u307f\u3067...\u3002\n\n```\nset protocols evpn traceoptions file evpn.log\nset protocols evpn traceoptions file size 10k\nset protocols evpn traceoptions file files 30\nset protocols evpn traceoptions flag all\n```\n\n## vQFX Inter Subnet Forwarding \u8a2d\u5b9a\uff5e\u78ba\u8a8d\n\n### Inter Subnet Forwarding \u8a2d\u5b9a\n\n#### spine11\n\n\u524d\u56de\u3053\u3093\u306a\u611f\u3058\u306e\u8a2d\u5b9a\u3092\u5165\u308c\u3066\u3042\u3063\u305f\u306e\u3067\n\n```\n{master:0}[edit]\nkotetsu@spine11# show vlans | display set\nset vlans VLAN0100 vlan-id 100\nset vlans VLAN0100 vxlan vni 10100\nset vlans VLAN0100 vxlan ingress-node-replication\nset vlans VLAN0300 vlan-id 300\nset vlans VLAN0300 vxlan vni 10300\nset vlans VLAN0300 vxlan ingress-node-replication\nset vlans default vlan-id 1\n```\n\n\u4ee5\u4e0b\u3067\u3000IRB\u3000\u4f5c\u6210\u3000\uff5e\u3000VRF \u4f5c\u6210\n\n```\nset interfaces irb unit 100 family inet address 192.168.1.254/24\nset interfaces irb unit 100 proxy-macip-advertisement\n\nset interfaces irb unit 300 family inet address 192.168.3.254/24\nset interfaces irb unit 300 proxy-macip-advertisement\n\nset vlans VLAN0100 l3-interface irb.100\nset vlans VLAN0300 l3-interface irb.300\n\n\nset interfaces lo0 unit 1 family inet address 198.18.1.11/32\n\nset routing-instances VRF001 instance-type vrf\nset routing-instances VRF001 interface irb.100\nset routing-instances VRF001 interface irb.300\nset routing-instances VRF001 interface lo0.1\nset routing-instances VRF001 route-distinguisher 50001:11\nset routing-instances VRF001 vrf-target target:64512:50001\nset routing-instances VRF001 protocols evpn ip-prefix-routes advertise direct-nexthop\nset routing-instances VRF001 protocols evpn ip-prefix-routes encapsulation vxlan\nset routing-instances VRF001 protocols evpn ip-prefix-routes vni 50001\n```\n\n\u30dd\u30a4\u30f3\u30c8\u306f `protocols evpn ip-prefix-routes` \u5468\u308a\u306e\u8a2d\u5b9a\u3067\u3059\u306d\u3002\n\u3053\u308c\u3067 VRF to VRF \u3067 EVPN NLRI Type5 \u3067 IP Prefix \u3084\u81ea\u5206\u306e MAC \u30a2\u30c9\u30ec\u30b9(Router's MAC) \u3092\u9001\u4fe1\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u308b\u306f\u305a\u3002 \n\n\n[Juniper\u516c\u5f0f / ReleaseNotes Junos 15.1X53-D60 for QFX10000 Switches](http://www.juniper.net/techpubs/en_US/junos15.1/information-products/topic-collections/qfx-series/release-notes/qfx-series-junos-release-notes-15.1X53-D60.pdf) \u306e 19 \u30da\u30fc\u30b8\u306b\u3088\u308b\u3068\n\n> Best practice for EVPN-VXLAN configuration (QFX10000 switches)\u2014Starting with\n> Junos OS Release 15.1X53-D60, in an EVPN-VXLAN configuration on QFX10000\n> switches, you no longer need to configure vxlan ingress-node-replication.\n\n\u3060\u305d\u3046\u306a\u3002\u306a\u3093\u3067\u3060\u308d\u3002\u3068\u306b\u304b\u304f Best Practice \u306a\u3089\u5f93\u3063\u3066\u304a\u304f\u306e\u304c\u3088\u304b\u308d\u3046\u3068\u3044\u3046\u3053\u3068\u3067\u3002\n\n```\ndelete vlans VLAN0100 vxlan ingress-node-replication\ndelete vlans VLAN0300 vxlan ingress-node-replication\n```\n\n\u3053\u308c\u3092\u6d88\u3055\u305a\u306b\u30c6\u30b9\u30c8\u3057\u3066\u3044\u305f\u6642\u3001\u306a\u3093\u304b EVPN NLRI Type3 \u3092\u9001\u3063\u3066\u304d\u3066\u3044\u306a\u3044 Remote VTEP \u3068 VNI \u306e\u7d44\u307f\u5408\u308f\u305b\u306b\u5bfe\u3057\u3066 BUM \u3092 ingress replication \u8ee2\u9001\u3057\u3066\u305f\u3093\u3060\u3088\u306a...\u3068\u3044\u3046\u3053\u3068\u3067\u6d88\u3059\u306e\u304c\u6b63\u89e3\u3068\u601d\u3044\u307e\u3059\u3002\n\n\u3042\u3068\u81ea\u5206\u306e\u74b0\u5883\u8d77\u56e0\u304b\u3082\u3067\u3059\u304c\u3001\u3053\u306e\u8fba\u306e\u8a2d\u5b9a\u8ffd\u52a0\u30fb\u5909\u66f4\u3057\u3066 commit \u3057\u305f\u6642\u306b\u3001bb01 \u3068 spine[12]1 \u306e\u9593\u3067 LLDP \u3084 BGP \u304c\u30d5\u30e9\u30c3\u30d4\u30f3\u30b0\u3057\u59cb\u3081\u308b\u3053\u3068\u304c\u3042\u308a\u307e\u3057\u305f\u3002\u3061\u3083\u3093\u3068\u8ffd\u3063\u3066\u306a\u3044\u3067\u3059\u304c\u3001\u305d\u3093\u306a\u6642\u306b\u306f\u304a\u3068\u306a\u3057\u304f `request system reboot` \u3057\u3066\u843d\u3061\u7740\u304b\u305b\u307e\u3057\u305f\u3002(\u96d1)\n\n#### spine21\n\nspine11 \u3068\u307b\u3068\u3093\u3069\u4e00\u7dd2\u3067\u3059\u3002\n\n\u524d\u56de\u3053\u3093\u306a\u611f\u3058\u306e\u8a2d\u5b9a\u3092\u5165\u308c\u3066\u3042\u3063\u305f\u306e\u3067\n\n```\n{master:0}[edit]\nkotetsu@spine21# show vlans | display set\nset vlans VLAN0100 vlan-id 100\nset vlans VLAN0100 vxlan vni 10100\nset vlans VLAN0100 vxlan ingress-node-replication\nset vlans VLAN0200 vlan-id 200\nset vlans VLAN0200 vxlan vni 10200\nset vlans VLAN0200 vxlan ingress-node-replication\nset vlans default vlan-id 1\n```\n\n\u4ee5\u4e0b\u3067\u3000IRB\u3000\u4f5c\u6210\u3000\uff5e\u3000VRF \u4f5c\u6210\n\n```\nset interfaces irb unit 100 family inet address 192.168.1.254/24\nset interfaces irb unit 100 proxy-macip-advertisement\nset interfaces irb unit 200 family inet address 192.168.2.254/24\nset interfaces irb unit 200 proxy-macip-advertisement\n\nset vlans VLAN0100 l3-interface irb.100\nset vlans VLAN0200 l3-interface irb.200\n\nset interfaces lo0 unit 1 family inet address 198.18.1.21/32\n\nset routing-instances VRF001 instance-type vrf\nset routing-instances VRF001 interface irb.100\nset routing-instances VRF001 interface irb.200\nset routing-instances VRF001 interface lo0.1\nset routing-instances VRF001 route-distinguisher 50001:21\nset routing-instances VRF001 vrf-target target:64512:50001\nset routing-instances VRF001 protocols evpn ip-prefix-routes advertise direct-nexthop\nset routing-instances VRF001 protocols evpn ip-prefix-routes encapsulation vxlan\nset routing-instances VRF001 protocols evpn ip-prefix-routes vni 50001\n```\n\n\u524d\u8ff0\u306e\u901a\u308a Best Practice \u306b\u5f93\u3063\u3066\u304a\u304f\u3002\n\n```\ndelete vlans VLAN0100 vxlan ingress-node-replication\ndelete vlans VLAN0200 vxlan ingress-node-replication\n```\n\n\n## \u52d5\u4f5c\u78ba\u8a8d\n\n### IP\u30a2\u30c9\u30ec\u30b9\u30fbMAC\u30a2\u30c9\u30ec\u30b9\u60c5\u5831 \u6574\u7406\n\n\u3061\u3087\u3063\u3068\u30ce\u30fc\u30c9\u6570\u304c\u5897\u3048\u3066\u304d\u305f\u306e\u3067\u3001\u307e\u3068\u3081\u3068\u304d\u307e\u3059\u3002\n\n| VLAN | IP\u30a2\u30c9\u30ec\u30b9 | MAC\u30a2\u30c9\u30ec\u30b9 | \u30ce\u30fc\u30c9 | \u30a4\u30f3\u30bf\u30fc\u30d5\u30a7\u30fc\u30b9 | \u5099\u8003 |\n|-----|---------|-----------|------|-----------|------|\n| 100 | `192.168.1.1/24` | `00:37:c4:e2:60:01` | `node11` | `ens4` | `spine11` \u914d\u4e0b |\n| 100 | `192.168.1.2/24` | `00:37:c4:46:d8:01` | `node21` | `ens4` | `spine21` \u914d\u4e0b  |\n| 100 | `192.168.1.254/24` | `02:05:86:71:3c:00` | `spine11` | `irb` |   |\n| 100 | `192.168.1.254/24` | `02:05:86:71:d8:00` | `spine21` | `irb` |   |\n| 200 | `192.168.2.2/24` | `00:37:c4:3d:e0:01` | `node22` | `ens4` | `spine21` \u914d\u4e0b  |\n| 200 | `192.168.2.254/24` | `02:05:86:71:d8:00` | `spine21` | `irb` |   |\n| 300 | `192.168.3.1/24` | `00:37:c4:0d:a8:01` | `node13` | `ens4` | `spine11` \u914d\u4e0b  |\n| 300 | `192.168.3.254/24` | `02:05:86:71:3c:00` | `spine11` | `irb` |   |\n| -   | `192.0.2.1/30`     | `02:05:86:71:21:03` | `bb01` | `xe-0/0/0` | `spine21` \u5074 |\n| -   | `192.0.2.2/30`     | `02:05:86:71:3c:03` | `spine11` | `xe-0/0/0` | `bb01` \u5074 |\n| -   | `192.0.2.5/30`     | `02:05:86:71:21:07` | `bb01` | `xe-0/0/1` | `spine21` \u5074 |\n| -   | `192.0.2.6/30`     | `02:05:86:71:d8:03` | `spine21` | `xe-0/0/0` | `bb01` \u5074 |\n\nspine11 \u3068 spine21 \u306e IRB MAC \u30a2\u30c9\u30ec\u30b9 at VLAN100 \u306f\u5404\u7269\u7406\u306e\u3082\u306e\u306b\u306a\u3063\u3066\u3044\u3066\u3001\u5171\u6709\u7528\u306e\u4eee\u60f3 MAC \u3092\u8a2d\u5b9a\u3057\u305f\u308a\u306f\u3057\u3066\u3044\u306a\u3044\u3067\u3059\u3002\nspine11 \u914d\u4e0b\u306e node11 \u306f spine11 \u306e IRB MAC\u30a2\u30c9\u30ec\u30b9\u3092\u30b2\u30fc\u30c8\u30a6\u30a7\u30a4\u3068\u3057\u3066\u4f7f\u3044\u3001spine21 \u914d\u4e0b\u306e node21 \u306f spine21 \u306e IRB MAC\u30a2\u30c9\u30ec\u30b9\u3092\u30b2\u30fc\u30c8\u30a6\u30a7\u30a4\u3068\u3057\u3066\u4f7f\u3046...\u3063\u3066\u306a\u52d5\u304d\u306b\u306a\u308b\u306e\u304b\u3001\u3092\u898b\u3088\u3046\u3068\u3044\u3046\u4e3b\u65e8\u3002\n\n\n\n### node\u9593\u758e\u901a\u78ba\u8a8d\uff5eARP\u30c6\u30fc\u30d6\u30eb\u78ba\u8a8d\n\n4 \u53f0\u306e node \u9593\u3092\u30d5\u30eb\u30e1\u30c3\u30b7\u30e5\u306b ping \u7c21\u6613\u758e\u901a\u78ba\u8a8d\u3001\u3068\u308a\u3042\u3048\u305a\u758e\u901a\u30aa\u30fc\u30eb\u304a\u3063\u3051\u30fc\u3002\n\u76f4\u5f8c ARP \u30c6\u30fc\u30d6\u30eb\u78ba\u8a8d\n\n- node11(192.168.1.1/24)\n\n```bash\nkotetsu@node11:~$ ip n show dev ens4\n192.168.1.254 lladdr 02:05:86:71:3c:00 REACHABLE  ## spine11 IRB \u306e MACaddr\n192.168.1.2 lladdr 00:37:c4:46:d8:01 STALE\n```\n\n- node21(192.168.1.2/24)\n\n```bash\nkotetsu@node21:~$ ip n show dev ens4\n192.168.1.254 lladdr 02:05:86:71:d8:00 REACHABLE  ## spine21 IRB \u306e MACaddr\n192.168.1.1 lladdr 00:37:c4:e2:60:01 REACHABLE\n```\n\n- node13(192.168.3.1/24)\n\n```bash\nkotetsu@node13:~$ ip n show dev ens4\n192.168.3.254 lladdr 02:05:86:71:3c:00 STALE  ## spine11 IRB \u306e MACaddr\n```\n\n- node22(192.168.2.2/24)\n\n```bash\nkotetsu@node22:~$ ip n show dev ens4\n192.168.2.254 lladdr 02:05:86:71:d8:00 REACHABLE  ## spine21 IRB \u306e MACaddr\n```\n\n\u3061\u306a\u307f\u306b spine11 \u3084 spine12 \u304b\u3089 ping \u3092\u5b9f\u884c\u3057\u3088\u3046\u3068\u3057\u305f\u3089\u3001\u81ea\u767a\u30d1\u30b1\u30c3\u30c8\u3092 EVPN \u65b9\u9762\u306b\u306f\u6d41\u3089\u308c\u306a\u3044\u3063\u307d\u3044\u3067\u3059\u3002\u305d\u308a\u3083\u3042\u305d\u3046\u304b\u3002\n\n```\n{master:0}\nkotetsu@spine21> ping routing-instance VRF001 192.168.1.2\nPING 192.168.1.2 (192.168.1.2): 56 data bytes\n64 bytes from 192.168.1.2: icmp_seq=0 ttl=64 time=6.448 ms\n64 bytes from 192.168.1.2: icmp_seq=1 ttl=64 time=5.700 ms\n\n{master:0}\nkotetsu@spine21> ping routing-instance VRF001 192.168.3.1\nPING 192.168.3.1 (192.168.3.1): 56 data bytes\nping: sendto: Operation not supported\nping: sendto: Operation not supported\n\n\n{master:0}\nkotetsu@spine21> show route table VRF001.inet.0 192.168.3.0/24\n\nVRF001.inet.0: 8 destinations, 9 routes (8 active, 0 holddown, 0 hidden)\n+ = Active Route, - = Last Active, * = Both\n\n192.168.3.0/24     *[EVPN/170] 20:55:03\n                    > to 192.0.2.5 via xe-0/0/0.0\n\n```\n\n\u30d1\u30c3\u3068\u898b\u306f\u5de7\u3044\u3053\u3068\u901a\u4fe1\u3067\u304d\u3066\u3044\u308b\u3088\u3046\u3067\u3059\u304c...\u3061\u3087\u3063\u3068\u4e2d\u8eab\u3092\u8ffd\u3063\u3066\u3044\u304d\u307e\u3059\u3002\n\n\n### vQFX\u30c6\u30fc\u30d6\u30eb\u78ba\u8a8d\n\n#### EVPN\n\n\u4e21\u65b9\u306e spine \u306b\u3064\u304f\u3063\u3066\u3044\u308b VLAN100(VNI 10100)\u306e MAC \u60c5\u5831\u3060\u3051\u304c Remote \u304b\u3089\u5b66\u7fd2\u3057\u305f\u3082\u306e\u306b\u542b\u307e\u308c...\u3063\u3066\u3084\u306f\u308a `Router's MAC` \u3068\u3057\u3066 `192.168.1.254` \u306e\u5b9f MAC 2 \u53f0\u5206\u3092\u5b66\u7fd2\u3057\u3066\u3044\u308b\u3002\n\n```\n{master:0}\nkotetsu@spine11> show evpn database\nInstance: default-switch\nVLAN  VNI  MAC address        Active source                  Timestamp        IP address\n      10100 00:37:c4:46:d8:01  172.16.2.1                     Jan 08 21:35:56\n      10100 00:37:c4:e2:60:01  xe-0/0/1.0                     Jan 08 01:30:42  192.168.1.1\n      10100 02:05:86:71:3c:00  irb.100                        Jan 08 12:50:23  192.168.1.254\n      10100 02:05:86:71:d8:00  172.16.2.1                     Jan 08 12:50:38  192.168.1.254\n      10300 00:37:c4:0d:a8:01  xe-0/0/1.0                     Jan 08 01:30:41  192.168.3.1\n      10300 02:05:86:71:3c:00  irb.300                        Jan 08 01:27:27  192.168.3.254\n```\n\n```\n{master:0}\nkotetsu@spine21> show evpn database\nInstance: default-switch\nVLAN  VNI  MAC address        Active source                  Timestamp        IP address\n      10100 00:37:c4:46:d8:01  xe-0/0/1.0                     Jan 08 01:30:41  192.168.1.2\n      10100 00:37:c4:e2:60:01  172.16.1.1                     Jan 08 21:42:10  192.168.1.1\n      10100 02:05:86:71:3c:00  172.16.1.1                     Jan 08 12:53:48  192.168.1.254\n      10100 02:05:86:71:d8:00  irb.100                        Jan 08 12:54:02  192.168.1.254\n      10200 00:37:c4:3d:e0:01  xe-0/0/1.0                     Jan 08 01:30:41  192.168.2.2\n      10200 02:05:86:71:d8:00  irb.200                        Jan 08 01:16:21  192.168.2.254\n```\n\n\u81ea\u5206\u304c\u5410\u3044\u3066\u3044\u308b Type5 \u60c5\u5831\u30b5\u30de\u30ea\n\n```\n{master:0}\nkotetsu@spine11> show evpn l3-context\nL3 context                      Type  Adv      Encap  VNI/Label  Router MAC/GW intf\nVRF001                          Cfg   Direct   VXLAN  50001      02:05:86:71:3c:00\n```\n\n```\n{master:0}\nkotetsu@spine21> show evpn l3-context\nL3 context                      Type  Adv      Encap  VNI/Label  Router MAC/GW intf\nVRF001                          Cfg   Direct   VXLAN  50001      02:05:86:71:d8:00\n```\n\nRemote \u304b\u3089 Type 5 \u3067\u5b66\u7fd2\u3057\u305f Router's MAC \u3092\u78ba\u8a8d\u3057\u3066\n\n```\n{master:0}\nkotetsu@spine11> show evpn ip-prefix-database\nL3 context: VRF001\n\nIPv4->EVPN Exported Prefixes\nPrefix                                       EVPN route status\n192.168.1.0/24                               Created\n192.168.3.0/24                               Created\n\nEVPN->IPv4 Imported Prefixes\nPrefix                                       Etag      IP route status\n192.168.1.0/24                               0         Created\n  Route distinguisher    St  VNI/Label  Router MAC         Nexthop/Overlay GW/ESI\n  50001:21               A   50001      02:05:86:71:d8:00  172.16.2.1\n192.168.2.0/24                               0         Created\n  Route distinguisher    St  VNI/Label  Router MAC         Nexthop/Overlay GW/ESI\n  50001:21               A   50001      02:05:86:71:d8:00  172.16.2.1\n\n```\n\n```\n{master:0}\nkotetsu@spine21> show evpn ip-prefix-database\nL3 context: VRF001\n\nIPv4->EVPN Exported Prefixes\nPrefix                                       EVPN route status\n192.168.1.0/24                               Created\n192.168.2.0/24                               Created\n\nEVPN->IPv4 Imported Prefixes\nPrefix                                       Etag      IP route status\n192.168.1.0/24                               0         Created\n  Route distinguisher    St  VNI/Label  Router MAC         Nexthop/Overlay GW/ESI\n  50001:11               A   50001      02:05:86:71:3c:00  172.16.1.1\n192.168.3.0/24                               0         Created\n  Route distinguisher    St  VNI/Label  Router MAC         Nexthop/Overlay GW/ESI\n  50001:11               A   50001      02:05:86:71:3c:00  172.16.1.1\n\n```\n\n#### Routing Table\n\n\u5f53\u8a72 VRF \u306e Routing Table \u30b5\u30de\u30ea\u30fc\u3092\u898b\u3066\n\n```\n{master:0}\nkotetsu@spine11> show route instance VRF001 extensive\nVRF001:\n  Router ID: 198.18.1.11\n  Type: vrf               State: Active\n  Interfaces:\n    irb.100\n    irb.300\n    lo0.1\n  Route-distinguisher: 50001:11\n  Vrf-import: [ __vrf-import-VRF001-internal__ ]\n  Vrf-export: [ __vrf-export-VRF001-internal__ ]\n  Vrf-import-target: [ target:64512:50001 ]\n  Vrf-export-target: [ target:64512:50001 ]\n  Fast-reroute-priority: low\n  Tables:\n    VRF001.inet.0          : 9 routes (8 active, 0 holddown, 0 hidden)\n    VRF001.inet.3          : 0 routes (0 active, 0 holddown, 0 hidden)\n    VRF001.iso.0           : 0 routes (0 active, 0 holddown, 0 hidden)\n    VRF001.inet6.0         : 0 routes (0 active, 0 holddown, 0 hidden)\n    VRF001.inet6.3         : 0 routes (0 active, 0 holddown, 0 hidden)\n    VRF001.mdt.0           : 0 routes (0 active, 0 holddown, 0 hidden)\n    VRF001.evpn.0          : 4 routes (4 active, 0 holddown, 0 hidden)\n```\n\n```\n{master:0}\nkotetsu@spine21> show route instance VRF001 extensive\nVRF001:\n  Router ID: 198.18.1.21\n  Type: vrf               State: Active\n  Interfaces:\n    irb.100\n    irb.200\n    lo0.1\n  Route-distinguisher: 50001:21\n  Vrf-import: [ __vrf-import-VRF001-internal__ ]\n  Vrf-export: [ __vrf-export-VRF001-internal__ ]\n  Vrf-import-target: [ target:64512:50001 ]\n  Vrf-export-target: [ target:64512:50001 ]\n  Fast-reroute-priority: low\n  Tables:\n    VRF001.inet.0          : 9 routes (8 active, 0 holddown, 0 hidden)\n    VRF001.inet.3          : 0 routes (0 active, 0 holddown, 0 hidden)\n    VRF001.iso.0           : 0 routes (0 active, 0 holddown, 0 hidden)\n    VRF001.inet6.0         : 0 routes (0 active, 0 holddown, 0 hidden)\n    VRF001.inet6.3         : 0 routes (0 active, 0 holddown, 0 hidden)\n    VRF001.mdt.0           : 0 routes (0 active, 0 holddown, 0 hidden)\n    VRF001.evpn.0          : 4 routes (4 active, 0 holddown, 0 hidden)\n```\n\n\u4e2d\u8eab\u306e\u30b5\u30de\u30ea\u3092\u307f\u308b\u3002\u307e\u305a\u306f\u300cbgp.evpn.0 = Junos OS \u30eb\u30fc\u30c6\u30a3\u30f3\u30b0 \u30d7\u30ed\u30c8\u30b3\u30eb \u30d7\u30ed\u30bb\u30b9\uff08RPD\uff09\u5185\u306e\u30b0\u30ed\u30fc\u30d0\u30eb EVPN \u30eb\u30fc\u30c6\u30a3\u30f3\u30b0 \u30c6\u30fc\u30d6\u30eb\u300d\u3092\n\n```\n{master:0}\nkotetsu@spine11> show route table bgp.evpn.0\n\nbgp.evpn.0: 9 destinations, 9 routes (9 active, 0 holddown, 0 hidden)\n+ = Active Route, - = Last Active, * = Both\n\n1:172.16.2.1:0::050000fdea0000277400::FFFF:FFFF/304\n                   *[BGP/170] 21:18:16, localpref 100, from 172.31.0.1\n                      AS path: I, validation-state: unverified\n                    > to 192.0.2.1 via xe-0/0/0.0\n1:172.16.2.1:0::050000fdea000027d800::FFFF:FFFF/304\n                   *[BGP/170] 21:18:16, localpref 100, from 172.31.0.1\n                      AS path: I, validation-state: unverified\n                    > to 192.0.2.1 via xe-0/0/0.0\n2:64512:21::10100::00:37:c4:46:d8:01/304\n                   *[BGP/170] 19:24:02, localpref 100, from 172.31.0.1\n                      AS path: I, validation-state: unverified\n                    > to 192.0.2.1 via xe-0/0/0.0\n2:64512:21::10100::02:05:86:71:d8:00/304\n                   *[BGP/170] 09:57:37, localpref 100, from 172.31.0.1\n                      AS path: I, validation-state: unverified\n                    > to 192.0.2.1 via xe-0/0/0.0\n2:64512:21::10100::00:37:c4:46:d8:01::192.168.1.2/304\n                   *[BGP/170] 09:36:35, localpref 100, from 172.31.0.1\n                      AS path: I, validation-state: unverified\n                    > to 192.0.2.1 via xe-0/0/0.0\n2:64512:21::10100::00:37:c4:46:d8:01::192.168.1.2/304\n                   *[BGP/170] 09:36:35, localpref 100, from 172.31.0.1\n                      AS path: I, validation-state: unverified\n                    > to 192.0.2.1 via xe-0/0/0.0\n2:64512:21::10100::02:05:86:71:d8:00::192.168.1.254/304\n                   *[BGP/170] 09:57:37, localpref 100, from 172.31.0.1\n                      AS path: I, validation-state: unverified\n                    > to 192.0.2.1 via xe-0/0/0.0\n3:64512:21::10100::172.16.2.1/304\n                   *[BGP/170] 19:24:02, localpref 100, from 172.31.0.1\n                      AS path: I, validation-state: unverified\n                    > to 192.0.2.1 via xe-0/0/0.0\n5:50001:21::0::192.168.1.0::24/304\n                   *[BGP/170] 21:18:16, localpref 100, from 172.31.0.1\n                      AS path: I, validation-state: unverified\n                    > to 192.0.2.1 via xe-0/0/0.0\n5:50001:21::0::192.168.2.0::24/304\n                   *[BGP/170] 21:18:16, localpref 100, from 172.31.0.1\n                      AS path: I, validation-state: unverified\n                    > to 192.0.2.1 via xe-0/0/0.0\n```\n\n```\n{master:0}\nkotetsu@spine21> show route table bgp.evpn.0\n\nbgp.evpn.0: 9 destinations, 9 routes (9 active, 0 holddown, 0 hidden)\n+ = Active Route, - = Last Active, * = Both\n\n1:172.16.1.1:0::050000fde90000277400::FFFF:FFFF/304\n                   *[BGP/170] 10:02:28, localpref 100, from 172.31.0.1\n                      AS path: I, validation-state: unverified\n                    > to 192.0.2.5 via xe-0/0/0.0\n1:172.16.1.1:0::050000fde90000283c00::FFFF:FFFF/304\n                   *[BGP/170] 21:26:18, localpref 100, from 172.31.0.1\n                      AS path: I, validation-state: unverified\n                    > to 192.0.2.5 via xe-0/0/0.0\n2:64512:11::10100::00:37:c4:e2:60:01/304\n                   *[BGP/170] 19:32:22, localpref 100, from 172.31.0.1\n                      AS path: I, validation-state: unverified\n                    > to 192.0.2.5 via xe-0/0/0.0\n2:64512:11::10100::02:05:86:71:3c:00/304\n                   *[BGP/170] 10:02:28, localpref 100, from 172.31.0.1\n                      AS path: I, validation-state: unverified\n                    > to 192.0.2.5 via xe-0/0/0.0\n2:64512:11::10100::00:37:c4:e2:60:01::192.168.1.1/304\n                   *[BGP/170] 10:01:04, localpref 100, from 172.31.0.1\n                      AS path: I, validation-state: unverified\n                    > to 192.0.2.5 via xe-0/0/0.0\n2:64512:11::10100::02:05:86:71:3c:00::192.168.1.254/304\n                   *[BGP/170] 10:02:28, localpref 100, from 172.31.0.1\n                      AS path: I, validation-state: unverified\n                    > to 192.0.2.5 via xe-0/0/0.0\n3:64512:11::10100::172.16.1.1/304\n                   *[BGP/170] 19:32:21, localpref 100, from 172.31.0.1\n                      AS path: I, validation-state: unverified\n                    > to 192.0.2.5 via xe-0/0/0.0\n5:50001:11::0::192.168.1.0::24/304\n                   *[BGP/170] 10:02:29, localpref 100, from 172.31.0.1\n                      AS path: I, validation-state: unverified\n                    > to 192.0.2.5 via xe-0/0/0.0\n5:50001:11::0::192.168.3.0::24/304\n                   *[BGP/170] 21:26:18, localpref 100, from 172.31.0.1\n                      AS path: I, validation-state: unverified\n                    > to 192.0.2.5 via xe-0/0/0.0\n```\n\n\u6b21\u306b\u5f53\u8a72 VRF \u306e\u3055\u307e\u308a\u30fc\n\n```\n{master:0}\nkotetsu@spine11> show route table VRF001.evpn.0\n\nVRF001.evpn.0: 4 destinations, 4 routes (4 active, 0 holddown, 0 hidden)\n+ = Active Route, - = Last Active, * = Both\n\n5:50001:11::0::192.168.1.0::24/304\n                   *[EVPN/170] 10:15:34\n                      Indirect\n5:50001:11::0::192.168.3.0::24/304\n                   *[EVPN/170] 21:36:19\n                      Indirect\n5:50001:21::0::192.168.1.0::24/304\n                   *[BGP/170] 21:35:58, localpref 100, from 172.31.0.1\n                      AS path: I, validation-state: unverified\n                    > to 192.0.2.1 via xe-0/0/0.0\n5:50001:21::0::192.168.2.0::24/304\n                   *[BGP/170] 21:35:58, localpref 100, from 172.31.0.1\n                      AS path: I, validation-state: unverified\n                    > to 192.0.2.1 via xe-0/0/0.0\n\n\n{master:0}\nkotetsu@spine11> show route table VRF001.inet.0\n\nVRF001.inet.0: 8 destinations, 9 routes (8 active, 0 holddown, 0 hidden)\n+ = Active Route, - = Last Active, * = Both\n\n192.168.1.0/24     *[Direct/0] 10:11:26\n                    > via irb.100\n                    [EVPN/170] 21:31:50\n                    > to 192.0.2.1 via xe-0/0/0.0\n192.168.1.1/32     *[EVPN/7] 10:10:01\n                    > via irb.100\n192.168.1.254/32   *[Local/0] 10:11:27\n                      Local via irb.100\n192.168.2.0/24     *[EVPN/170] 21:31:50\n                    > to 192.0.2.1 via xe-0/0/0.0\n192.168.3.0/24     *[Direct/0] 21:32:11\n                    > via irb.300\n192.168.3.1/32     *[EVPN/7] 21:31:06\n                    > via irb.300\n192.168.3.254/32   *[Local/0] 21:34:23\n                      Local via irb.300\n198.18.1.11/32     *[Direct/0] 21:34:23\n                    > via lo0.1\n```\n\n```\n{master:0}\nkotetsu@spine21> show route table VRF001.evpn.0\n\nVRF001.evpn.0: 4 destinations, 4 routes (4 active, 0 holddown, 0 hidden)\n+ = Active Route, - = Last Active, * = Both\n\n5:50001:11::0::192.168.1.0::24/304\n                   *[BGP/170] 10:19:12, localpref 100, from 172.31.0.1\n                      AS path: I, validation-state: unverified\n                    > to 192.0.2.5 via xe-0/0/0.0\n5:50001:11::0::192.168.3.0::24/304\n                   *[BGP/170] 21:43:01, localpref 100, from 172.31.0.1\n                      AS path: I, validation-state: unverified\n                    > to 192.0.2.5 via xe-0/0/0.0\n5:50001:21::0::192.168.1.0::24/304\n                   *[EVPN/170] 10:18:58\n                      Indirect\n5:50001:21::0::192.168.2.0::24/304\n                   *[EVPN/170] 21:54:15\n                      Indirect\n\n\n{master:0}\nkotetsu@spine21> show route table VRF001.inet.0\n\nVRF001.inet.0: 8 destinations, 9 routes (8 active, 0 holddown, 0 hidden)\n+ = Active Route, - = Last Active, * = Both\n\n192.168.1.0/24     *[Direct/0] 10:16:27\n                    > via irb.100\n                    [EVPN/170] 10:16:41\n                    > to 192.0.2.5 via xe-0/0/0.0\n192.168.1.2/32     *[EVPN/7] 10:16:10\n                    > via irb.100\n192.168.1.254/32   *[Local/0] 10:16:27\n                      Local via irb.100\n192.168.2.0/24     *[Direct/0] 21:51:44\n                    > via irb.200\n192.168.2.2/32     *[EVPN/7] 21:39:37\n                    > via irb.200\n192.168.2.254/32   *[Local/0] 21:54:08\n                      Local via irb.200\n192.168.3.0/24     *[EVPN/170] 21:40:30\n                    > to 192.0.2.5 via xe-0/0/0.0\n198.18.1.21/32     *[Direct/0] 21:54:08\n                    > via lo0.1\n```\n\n\u6700\u5f8c\u306b Type 5 route \u306e\u8a73\u7d30\u3092\u898b\u3066\u304a\u304f\u3002\u3053\u3044\u3064\u3089\u306f `VRF001.evpn.0` \u306b\u3082\u30ed\u30fc\u30c9\u3055\u308c\u3066\u3044\u308b\u3002\n\n```\n{master:0}\nkotetsu@spine11> show route table bgp.evpn.0 extensive\n\n...\n\n5:50001:21::0::192.168.1.0::24/304 (1 entry, 0 announced)\n        *BGP    Preference: 170/-101\n                Route Distinguisher: 50001:21\n                Next hop type: Indirect, Next hop index: 0\n                Address: 0xaa605f0\n                Next-hop reference count: 18\n                Source: 172.31.0.1\n                Protocol next hop: 172.16.2.1\n                Indirect next hop: 0x2 no-forward INH Session ID: 0x0\n                State: <Active Int Ext>\n                Local AS: 65001 Peer AS: 64512\n                Age: 21:25:33   Metric2: 0\n                Validation State: unverified\n                Task: BGP_64512_64512.172.31.0.1\n                AS path: I (Originator)\n                Cluster list:  172.31.0.1\n                Originator ID: 172.16.2.1\n                Communities: target:64512:50001 encapsulation0:0:0:0:vxlan router-mac:02:05:86:71:d8:00\n                Import Accepted\n                Route Label: 50001\n                Overlay gateway address: 0.0.0.0\n                ESI 00:00:00:00:00:00:00:00:00:00\n                Localpref: 100\n                Router ID: 172.31.0.1\n                Secondary Tables: VRF001.evpn.0\n                Indirect next hops: 1\n                        Protocol next hop: 172.16.2.1\n                        Indirect next hop: 0x2 no-forward INH Session ID: 0x0\n                        Indirect path forwarding next hops: 1\n                                Next hop type: Router\n                                Next hop: 192.0.2.1 via xe-0/0/0.0\n                                Session Id: 0x0\n                        172.16.2.1/32 Originating RIB: inet.0\n                          Node path count: 1\n                          Forwarding nexthops: 1\n                                Nexthop: 192.0.2.1 via xe-0/0/0.0\n\n5:50001:21::0::192.168.2.0::24/304 (1 entry, 0 announced)\n        *BGP    Preference: 170/-101\n                Route Distinguisher: 50001:21\n                Next hop type: Indirect, Next hop index: 0\n                Address: 0xaa605f0\n                Next-hop reference count: 18\n                Source: 172.31.0.1\n                Protocol next hop: 172.16.2.1\n                Indirect next hop: 0x2 no-forward INH Session ID: 0x0\n                State: <Active Int Ext>\n                Local AS: 65001 Peer AS: 64512\n                Age: 21:25:33   Metric2: 0\n                Validation State: unverified\n                Task: BGP_64512_64512.172.31.0.1\n                AS path: I (Originator)\n                Cluster list:  172.31.0.1\n                Originator ID: 172.16.2.1\n                Communities: target:64512:50001 encapsulation0:0:0:0:vxlan router-mac:02:05:86:71:d8:00\n                Import Accepted\n                Route Label: 50001\n                Overlay gateway address: 0.0.0.0\n                ESI 00:00:00:00:00:00:00:00:00:00\n                Localpref: 100\n                Router ID: 172.31.0.1\n                Secondary Tables: VRF001.evpn.0\n                Indirect next hops: 1\n                        Protocol next hop: 172.16.2.1\n                        Indirect next hop: 0x2 no-forward INH Session ID: 0x0\n                        Indirect path forwarding next hops: 1\n                                Next hop type: Router\n                                Next hop: 192.0.2.1 via xe-0/0/0.0\n                                Session Id: 0x0\n                        172.16.2.1/32 Originating RIB: inet.0\n                          Node path count: 1\n                          Forwarding nexthops: 1\n                                Nexthop: 192.0.2.1 via xe-0/0/0.0\n```\n\n```\n{master:0}\nkotetsu@spine21> show route table bgp.evpn.0 extensive\n\n...\n\n5:50001:11::0::192.168.1.0::24/304 (1 entry, 0 announced)\n        *BGP    Preference: 170/-101\n                Route Distinguisher: 50001:11\n                Next hop type: Indirect, Next hop index: 0\n                Address: 0xaa60170\n                Next-hop reference count: 18\n                Source: 172.31.0.1\n                Protocol next hop: 172.16.1.1\n                Indirect next hop: 0x2 no-forward INH Session ID: 0x0\n                State: <Active Int Ext>\n                Local AS: 65002 Peer AS: 64512\n                Age: 10:04:02   Metric2: 0\n                Validation State: unverified\n                Task: BGP_64512_64512.172.31.0.1\n                AS path: I (Originator)\n                Cluster list:  172.31.0.1\n                Originator ID: 172.16.1.1\n                Communities: target:64512:50001 encapsulation0:0:0:0:vxlan router-mac:02:05:86:71:3c:00\n                Import Accepted\n                Route Label: 50001\n                Overlay gateway address: 0.0.0.0\n                ESI 00:00:00:00:00:00:00:00:00:00\n                Localpref: 100\n                Router ID: 172.31.0.1\n                Secondary Tables: VRF001.evpn.0\n                Indirect next hops: 1\n                        Protocol next hop: 172.16.1.1\n                        Indirect next hop: 0x2 no-forward INH Session ID: 0x0\n                        Indirect path forwarding next hops: 1\n                                Next hop type: Router\n                                Next hop: 192.0.2.5 via xe-0/0/0.0\n                                Session Id: 0x0\n                        172.16.1.1/32 Originating RIB: inet.0\n                          Node path count: 1\n                          Forwarding nexthops: 1\n                                Nexthop: 192.0.2.5 via xe-0/0/0.0\n\n5:50001:11::0::192.168.3.0::24/304 (1 entry, 0 announced)\n        *BGP    Preference: 170/-101\n                Route Distinguisher: 50001:11\n                Next hop type: Indirect, Next hop index: 0\n                Address: 0xaa60170\n                Next-hop reference count: 18\n                Source: 172.31.0.1\n                Protocol next hop: 172.16.1.1\n                Indirect next hop: 0x2 no-forward INH Session ID: 0x0\n                State: <Active Int Ext>\n                Local AS: 65002 Peer AS: 64512\n                Age: 21:27:51   Metric2: 0\n                Validation State: unverified\n                Task: BGP_64512_64512.172.31.0.1\n                AS path: I (Originator)\n                Cluster list:  172.31.0.1\n                Originator ID: 172.16.1.1\n                Communities: target:64512:50001 encapsulation0:0:0:0:vxlan router-mac:02:05:86:71:3c:00\n                Import Accepted\n                Route Label: 50001\n                Overlay gateway address: 0.0.0.0\n                ESI 00:00:00:00:00:00:00:00:00:00\n                Localpref: 100\n                Router ID: 172.31.0.1\n                Secondary Tables: VRF001.evpn.0\n                Indirect next hops: 1\n                        Protocol next hop: 172.16.1.1\n                        Indirect next hop: 0x2 no-forward INH Session ID: 0x0\n                        Indirect path forwarding next hops: 1\n                                Next hop type: Router\n                                Next hop: 192.0.2.5 via xe-0/0/0.0\n                                Session Id: 0x0\n                        172.16.1.1/32 Originating RIB: inet.0\n                          Node path count: 1\n                          Forwarding nexthops: 1\n                                Nexthop: 192.0.2.5 via xe-0/0/0.0\n```\n\n#### MAC \u30a2\u30c9\u30ec\u30b9\u30c6\u30fc\u30d6\u30eb\n\nType 2 \u304b\u3089\u5b66\u7fd2\u3057\u3066\u3044\u308b\u306e\u306f\u3001\u4e21\u65b9\u306e VTEP \u306b\u304f\u3063\u3064\u3051\u3066\u3044\u308b VLAN 100 = VNI 10100 \u306e\u307f\n\n```\n{master:0}\nkotetsu@spine11> show ethernet-switching table\n\nMAC flags (S - static MAC, D - dynamic MAC, L - locally learned, P - Persistent static\n           SE - statistics enabled, NM - non configured MAC, R - remote PE MAC, O - ovsdb MAC)\n\n\nEthernet switching table : 4 entries, 4 learned\nRouting instance : default-switch\n   Vlan                MAC                 MAC      Logical                Active\n   name                address             flags    interface              source\n   VLAN0100            00:37:c4:46:d8:01   D        vtep.32769             172.16.2.1\n   VLAN0100            00:37:c4:e2:60:01   D        xe-0/0/1.0\n   VLAN0100            02:05:86:71:d8:00   D        vtep.32769             172.16.2.1\n   VLAN0300            00:37:c4:0d:a8:01   D        xe-0/0/1.0\n```\n\n```\n{master:0}\nkotetsu@spine21> show ethernet-switching table\n\nMAC flags (S - static MAC, D - dynamic MAC, L - locally learned, P - Persistent static\n           SE - statistics enabled, NM - non configured MAC, R - remote PE MAC, O - ovsdb MAC)\n\n\nEthernet switching table : 4 entries, 4 learned\nRouting instance : default-switch\n   Vlan                MAC                 MAC      Logical                Active\n   name                address             flags    interface              source\n   VLAN0100            00:37:c4:46:d8:01   D        xe-0/0/1.0\n   VLAN0100            00:37:c4:e2:60:01   D        vtep.32769             172.16.1.1\n   VLAN0100            02:05:86:71:3c:00   D        vtep.32769             172.16.1.1\n   VLAN0200            00:37:c4:3d:e0:01   D        xe-0/0/1.0\n```\n\n### \u901a\u4fe1\u78ba\u8a8d\u8a73\u7d30(DataPlane)\n\n\u5404\u901a\u4fe1\u306e\u69d8\u5b50\u3092\u898b\u3066\u3044\u304d\u307e\u3059\u3002\u305d\u308c\u305e\u308c\u3001\u5b9f\u884c\u524d\u306b `sudo ip n flush dev ens4` \u3068\u304b\u3057\u3066\u307e\u3059\u3002\n\n#### L3 Symmetric\n\nnode22(192.168.2.2/24) \u304b\u3089 node13(192.168.3.1/24) \u3078 ping\n\n\u4ee5\u4e0b\u3001ICMP Echo request \u3092 spine21 \u3068 bb01 \u9593\u3067\u62fe\u3063\u305f\u3082\u306e\u3002\nVXLAN\u30ab\u30d7\u30bb\u30eb\u5185\u306e Eth \u30d8\u30c3\u30c0\u3092\u898b\u308b\u3068\u3001Type5\u3067\u5b66\u7fd2\u3057\u305f spine11 \u306e irb MAC \u30a2\u30c9\u30ec\u30b9\u3092 Dst \u306b\u6307\u5b9a\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n![03_10_01_200to300_ICMPreq_VNI50001.png](https://qiita-image-store.s3.amazonaws.com/0/60456/3e683fcc-c30f-32c5-9c43-e826f809d213.png)\n\n\u306a\u304a\u3001ICMP Echo Reply \u3082\u540c\u3058\u611f\u3058\u3067\u3059\u3002\n\n#### L2 over L3\n\nnode21(192.168.1.2/24) \u304b\u3089 node11(192.168.1.1/24) \u3078 ping\n\n\u3053\u308c\u306f\u524d\u56de\u3068\u540c\u69d8\u306b\u3001\u5358\u7d14\u306b VNI 10100 \u3067\u30ab\u30d7\u30bb\u30eb\u5316\u3055\u308c\u3066\u901a\u4fe1\u3057\u3066\u3044\u308b\u3060\u3051\u3002\n![03_11_01_100to100_ICMPreq.png](https://qiita-image-store.s3.amazonaws.com/0/60456/56665843-0bca-8dd4-d77a-93fd531e1492.png)\n\n\n#### L3 \u5f80\u8def Symmetric \u5fa9\u8def Asymmetric\n\nnode11(192.168.1.1/24) \u304b\u3089 node22(192.168.2.2/24) \u3078 ping\n\n\u3053\u306e\u30b1\u30fc\u30b9\u304c\u3001\u3069\u3046\u52d5\u304f\u306e\u304b\u30a4\u30de\u30a4\u30c1\u4e88\u6e2c\u3067\u304d\u306a\u304b\u3063\u305f\u3068\u3053\u308d\u3067\u3059\u3002\n\n1. \u5f80\u8def node11 \u304c\u30b2\u30fc\u30c8\u30a6\u30a7\u30a4IP\u30a2\u30c9\u30ec\u30b9(192.168.1.254) ARP \u89e3\u6c7a\u3092\u8a66\u307f\u308b\n2. \u5f80\u8def spine11 \u304c node11 \u306b \u81ea\u8eab\u306e irb MAC \u30a2\u30c9\u30ec\u30b9\u3092\u7b54\u3048\u308b (**\u3053\u306e\u6642\u300c\u81ea\u5206\u304c\u5fdc\u7b54\u3057\u305f\u306e\u3067 ARP request \u3092 VNI 10100 \u65b9\u9762\u306b\u306f\u8ee2\u9001\u3057\u306a\u3044\u300d\u3068\u3044\u3046\u52d5\u4f5c\u306b\u306a\u3063\u3066\u304f\u308c\u308b\u306e\u304b\u5426\u304b\u304c\u4e88\u60f3\u3067\u304d\u306a\u304b\u3063\u305f & \u78ba\u8a8d\u3057\u305f\u304b\u3063\u305f**)\n2. \u5f80\u8def spine11 \u306f node11 \u304b\u3089\u306e Dst IP(192.168.2.2/24) \u306a ICMP Echo request \u30d1\u30b1\u30c3\u30c8\u3092\u53d7\u4fe1\u3057\u3001Type5 \u3067\u5f97\u305f\u60c5\u5831\u306b\u5f93\u3044 VNI 50001 \u3067\u30ab\u30d7\u30bb\u30eb\u5316\u3057\u3066 spine21 \u306b\u6295\u3052\u308b (Symmetric)\n3. \u5f80\u8def spine21 \u306f\u81ea\u5206\u306e irb direct \u914d\u4e0b\u306b\u3044\u308b node22 \u306b\u30d5\u30a9\u30ef\u30fc\u30c9\u3059\u308b\u3060\u3051\n4. \u5fa9\u8def node22 \u306f\u30b2\u30fc\u30c8\u30a6\u30a7\u30a4IP\u30a2\u30c9\u30ec\u30b9(192.168.2.254)\u306e ARP \u89e3\u6c7a\u3092\u3057\u3066\u3001spine21 \u306e irb MAC \u306b ICMP Echo Reply \u6295\u3052\u308b\n5. \u5fa9\u8def spine21 \u306f node22 \u304b\u3089\u306e Dst IP(192.168.1.1/24) \u306a ICMP Echo Reply \u30d1\u30b1\u30c3\u30c8\u3092\u53d7\u4fe1\u3057\u3001Type2 \u3067\u5f97\u305f\u60c5\u5831\u306b\u5f93\u3044 VNI 10100 \u3067\u30ab\u30d7\u30bb\u30eb\u5316\u3057\u3066 spine11 \u306b\u6295\u3052\u308b (Asymmetric)\n6. \u5fa9\u8def spine11 \u306f\u81ea\u5206\u306e irb direct \u914d\u4e0b\u306b\u3044\u308b node11 \u306b\u30d5\u30a9\u30ef\u30fc\u30c9\u3059\u308b\u3060\u3051\n\n\n\u3068\u3044\u3046\u611f\u3058\u306b\u4e88\u6e2c\u3057\u3066\u3001\u884c\u304d\u3068\u623b\u308a\u306e VNI \u304c\u7570\u306a\u308b\u8ad6\u7406\u7684\u306b\u975e\u5bfe\u79f0\u306a\u901a\u4fe1\u3067\u3061\u3083\u3093\u3068\u6210\u308a\u7acb\u3063\u3066\u3044\u308b\u306e\u304b\u3001\u3063\u3066\u3044\u3046\u306e\u3068\u592a\u5b57\u7b87\u6240\u3092\u898b\u3066\u3044\u304d\u307e\u3059\u3002\u3044\u3084\u307e\u3042\u758e\u901a\u306f\u78ba\u8a8d\u6e08\u306a\u3093\u3067\u3059\u304c\u3002\n\n\u307e\u305a node11 \u3067\u62fe\u3063\u305f\u30d1\u30b1\u30c3\u30c8\u3092\u898b\u308b\u3068...\u306f\u3044\u3001\u4e0a\u8a18\u306e\u592a\u5b57\u7b87\u6240\u306f\u671f\u5f85\u3057\u305f\u52d5\u4f5c\u306b\u306a\u3063\u3066\u3044\u306a\u3044\u3067\u3059\u306d\u3002\nspine11 \u3068 spine21 \u53cc\u65b9\u306e irb \u304b\u3089 ARP Reply \u304c\u6765\u3066\u3044\u3066(\u30d1\u30b1\u30c3\u30c8No.2\u30684)\u3001\u305f\u307e\u305f\u307e node \u306e\u4ed5\u69d8\u7684\u306b\u5148\u306b\u8fd4\u3063\u3066\u304d\u305f spine11 \u5074\u306e MAC \u30a2\u30c9\u30ec\u30b9\u3092\u4f7f\u3063\u3066\u3044\u305f\u306b\u904e\u304e\u306a\u3044\u3088\u3046\u3067\u3059\u3002\n![03_12_01_100to200_ARPreply_dup.png](https://qiita-image-store.s3.amazonaws.com/0/60456/38dc04e8-9023-a769-a370-2d8a3e52c51c.png)\n\n\u4e0a\u8a18\u306e\u52d5\u4f5c\u3092\u3001\u4eca\u5ea6\u306f spine11 \u3068 bb01 \u9593\u3067\u62fe\u3063\u305f\u30d1\u30b1\u30c3\u30c8\u3067\u8ffd\u3063\u3066\u307f\u307e\u3059\u3002\n\u3053\u306e\u30d1\u30b1\u30c3\u30c8No.16 \u304c\u300c\u81ea\u5206\u304c node11 \u306b ARP Reply \u3057\u305f\u76f4\u5f8c\u3001ARP Request \u3092 VNI 10100 \u3067 spine21 \u65b9\u9762\u306b Ingress Replication \u3057\u3066\u3044\u308b\u300d\u3084\u3064\u3067\u3059\u3002\n![03_12_02_100to200_ARPrequest_ingress_replication.png](https://qiita-image-store.s3.amazonaws.com/0/60456/8882dd3b-ecf2-471b-6560-b4f38daf34d7.png)\n\n\u5f53\u7136\u3001spine21 \u5074\u306f\u901a\u5e38\u901a\u308a ARP Reply \u3092\u8fd4\u3057\u3066\u304f\u308c\u308b\u3057\u3001\u305d\u308c\u306f\u5148\u307b\u3069 node11 \u5074\u3067\u898b\u305f\u901a\u308a node11 \u306b\u3082\u4f1d\u642c\u3055\u308c\u307e\u3059\u3002\n![03_12_03_100to200_ARPreply_from_spine21.png](https://qiita-image-store.s3.amazonaws.com/0/60456/03808ed8-2655-58fd-a2ad-42bc351cbe21.png)\n\n\u3068\u3044\u3046\u3053\u3068\u3067\u3001ARP Request \u306b\u5bfe\u3059\u308b Reply \u306e\u52d5\u4f5c\u78ba\u8a8d\u306f\u3001\u81ea\u5206\u304c\u671f\u5f85\u3057\u3066\u3044\u305f\u306e\u3068\u9055\u3046\u52d5\u304d\u306e\u3088\u3046\u3067\u3059\u3002\n\u69cb\u6210\u3084\u8a2d\u5b9a\u3067\u3069\u3046\u306b\u304b\u5de7\u3044\u3053\u3068\u306a\u3089\u306a\u3044\u304b...\u3063\u3066\u3068\u3053\u308d\u306f\u6df1\u8ffd\u3044\u3057\u3066\u3044\u307e\u305b\u3093\u3002\n(\u8a66\u3057\u306b spine[12]1 \u53cc\u65b9\u3067 `set interfaces irb unit 100 mac 00:00:5e:00:53:99` \u3068\u304b\u3057\u3066\u540c\u3058 MAC \u30a2\u30c9\u30ec\u30b9\u3092\u6301\u305f\u305b\u3066\u307f\u305f\u308a\u306f\u3057\u307e\u3057\u305f\u304c...\u305d\u308c\u3067\u3082\u901a\u4fe1\u306f\u53ef\u80fd\u3060\u3051\u308c\u3069\u3001\u7279\u306b\u4ee3\u8868\u52d5\u4f5c\u3068\u304b\u3092\u3057\u306a\u3044IP/MAC\u91cd\u8907\u72b6\u614b\u306a\u306e\u3067\u3001\u5065\u5168\u306a\u72b6\u614b\u3068\u306f\u8a00\u3048\u306a\u3044\u304b\u3068\u3002)\n\n\u3042\u3001\u5f80\u8def VNI 50001, \u5fa9\u8def VNI 10100 \u306b\u95a2\u3057\u3066\u306f\u3001\u60f3\u5b9a\u901a\u308a\u306e\u52d5\u304d\u3067\u3057\u305f\u3002\n![03_12_04_100to200_ICMPrequest_VNI50001.png](https://qiita-image-store.s3.amazonaws.com/0/60456/7f133105-94fb-4034-6ac5-83a44eb569f6.png)\n![03_12_05_100to200_ICMPreply_VNI10100.png](https://qiita-image-store.s3.amazonaws.com/0/60456/be65181a-facc-7a49-dec5-f28ae080ccb1.png)\n\n\n### \u30d1\u30b1\u30c3\u30c8\u30ad\u30e3\u30d7\u30c1\u30e3(ControlPlane)\n\nEVPN NLRI Type5 \u306e UPDATE \u3068 WithDrawn \u3092\u8efd\u304f\u898b\u3066\u304a\u304d\u307e\u3059\u3002\n\n\u307e\u305a\u306f WithDrawn \u3092 spine21 \u304b\u3089\u5410\u304b\u305b\u305f\u6642(\u96d1\u306b `deactivate routing-instance VRF001` \u3068\u304b\u3067)\n![03_21_01_Type5_WithDrawn.png](https://qiita-image-store.s3.amazonaws.com/0/60456/246c548b-aa17-870d-91c1-e1e3ccb7360a.png)\n![03_21_02_Type5_WithDrawn.png](https://qiita-image-store.s3.amazonaws.com/0/60456/f3948f87-eb6b-987f-5609-fc26138bf297.png)\n\nUPDATE \u3092 spine21 \u304b\u3089\u5410\u304b\u305b\u305f\u6642(\u96d1\u306b `rollback 1` \u3068\u304b\u3067)\n![03_22_01_Type5_UPDATE.png](https://qiita-image-store.s3.amazonaws.com/0/60456/0fdd333d-53fd-8b0e-e24a-b552cec44b28.png)\n\n\n# \u304a\u3057\u307e\u3044\n\n- Juniper vQFX10000 \u3067\u3082 EVPN NLRI Type5 \u304c\u52d5\u304f\u3053\u3068\u3092\u78ba\u8a8d\u3067\u304d\u307e\u3057\u305f\n- VRF to VRF \u52d5\u4f5c\u3068 L2VPN \u3092\u4f75\u7528\u3059\u308b\u5834\u5408\u3001\u4f55\u3089\u304b\u306e\u5de5\u592b\u304c\u5fc5\u8981\u305d\u3046\u3060\u3068\u3044\u3046\u3053\u3068\u306f\u5206\u304b\u308a\u307e\u3057\u305f\n    - [L3 \u5f80\u8def Symmetric \u5fa9\u8def Asymmetric](http://qiita.com/kakkotetsu/items/fcca7052d407f557023a#l3-%E5%BE%80%E8%B7%AF-symmetric-%E5%BE%A9%E8%B7%AF-asymmetric) \u3067\u30a6\u30c0\u30a6\u30c0\u66f8\u3044\u305f\u901a\u308a\n    - \u305d\u3082\u305d\u3082 MX \u3092\u4f7f\u3063\u3066 MAC VRF \u4f7f\u3046\u3001\u306e\u304c\u5e38\u9053\u306a\u306e\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u304c\n", "tags": ["juniper", "junos15.1X53-D60", "GNS31.5.2", "E-VPN", "vxlan"]}