{"context": "\n\n\u306f\u3058\u3081\u306b\nLJ\u306eSIMD\u5316\u306e\u8a66\u307f\u3002\u4eca\u56de\u306f\u30bd\u30d5\u30c8\u30a6\u30a7\u30a2\u30d1\u30a4\u30d7\u30e9\u30a4\u30cb\u30f3\u30b0\u3057\u305f\u30b3\u30fc\u30c9\u3092\uff14\u500d\u5c55\u958b\u3059\u308b\u3002\n\n\n\u305d\u306e0 \n\u305d\u306e1\n\n\u305d\u306e2 \n\n\u305d\u306e3 \u2190\u30a4\u30de\u30b3\u30b3\n\u305d\u306e3.5\n\u305d\u306e4\n\u305d\u306e5\n\u305d\u306e6\n\n\u30b3\u30fc\u30c9\u306f\nhttps://github.com/kaityo256/lj_simdstep\n\u306b\u304a\u3044\u3066\u3042\u308b\u3002\n\u203b \u3063\u3066\u3044\u3046\u304b\u30bf\u30b0\u306bAVX2\u3068\u304b\u66f8\u3044\u3066\u3042\u308b\u306e\u306b\u3001\u3053\u3053\u307e\u3067AVX2\u547d\u4ee4\u3092\u3061\u3063\u3068\u3082\u4f7f\u3063\u3066\u306a\u3044\u306e\u304c\u8a50\u6b3a\u3063\u307d\u3044\u3002\n\n4\u500d\u5c55\u958b\n\u30eb\u30fc\u30d7\u3092\u30bd\u30d5\u30c8\u30a6\u30a7\u30a2\u30d1\u30a4\u30d7\u30e9\u30a4\u30cb\u30f3\u30b0\u3067\u304d\u305f\u306e\u3067\u3001\u3053\u308c\u3092\u99ac\u9e7fSIMD\u5316\u306e\u305f\u3081\u306b4\u500d\u5c55\u958b\u3059\u308b\u3002\u305f\u3060\u3057\u3001\u30bd\u30d5\u30c8\u30a6\u30a7\u30a2\u30d1\u30a4\u30d7\u30e9\u30a4\u30cb\u30f3\u30b0\u3057\u3066\u3044\u308b\u306e\u3067\u7aef\u306e\u51e6\u7406\u9762\u5012\u306b\u306a\u308b\u3002\u771f\u9762\u76ee\u306b\u3084\u308b\u306a\u3089\u30eb\u30fc\u30d7\u5185\u3067\u8a08\u7b97\u3057\u305f\u7d50\u679c\u3092\u30eb\u30fc\u30d7\u5916\u3067\u3061\u3083\u3093\u3068\u4f7f\u3063\u3066\u304b\u3089\u3001\u30b4\u30df\u306e\u51e6\u7406\u3092\u3057\u306a\u3051\u308c\u3070\u306a\u3089\u306a\u3044\u304c\u3001\u9762\u5012\u306a\u306e\u3067\u4e00\u756a\u7aef\u306f\u5148\u8aad\u307f\u3057\u305f\u7d50\u679c\u3092\u6368\u3066\u3066\u3001\u518d\u5ea6\u8a08\u7b97\u3057\u3066\u3057\u307e\u304a\u3046\u3002\u3069\u3046\u305b\u30eb\u30fc\u30d7\u9577\u304c\u3059\u3054\u304f\u9577\u3044(\u4eca\u56de\u306e\u30b1\u30fc\u30b9\u30677839886\u56de\u8ee2)\u306e\u3067\u3001\u305d\u306e\u30b3\u30b9\u30c8\u306f\u7121\u8996\u3067\u304d\u308b\u3002\n\u305d\u3046\u3044\u3063\u305f\u65b9\u91dd\u3067\u4f5c\u3063\u305f4\u500d\u5c55\u958b\u306e\u30b3\u30fc\u30c9\u306f\u3053\u3061\u3089\u3002\u3053\u308c\u304b\u3089SIMD\u5316\u3059\u308b\u305f\u3081\u3001\u540d\u524d\u3092force_pair_swp_intrin\u3068\u3057\u3066\u3042\u308b\u3002\nvoid\nforce_pair_swp_intrin(void){\n  int k = 0;\n  int i_a1 = i_particles[k];\n  int j_a1 = j_particles[k];\n  int i_a2 = i_particles[k+1];\n  int j_a2 = j_particles[k+1];\n  int i_a3 = i_particles[k+2];\n  int j_a3 = j_particles[k+2];\n  int i_a4 = i_particles[k+3];\n  int j_a4 = j_particles[k+3];\n  double dx_b1 = q[j_a1][X] - q[i_a1][X];\n  double dy_b1 = q[j_a1][Y] - q[i_a1][Y];\n  double dz_b1 = q[j_a1][Z] - q[i_a1][Z];\n  double dx_b2 = q[j_a2][X] - q[i_a2][X];\n  double dy_b2 = q[j_a2][Y] - q[i_a2][Y];\n  double dz_b2 = q[j_a2][Z] - q[i_a2][Z];\n  double dx_b3 = q[j_a3][X] - q[i_a3][X];\n  double dy_b3 = q[j_a3][Y] - q[i_a3][Y];\n  double dz_b3 = q[j_a3][Z] - q[i_a3][Z];\n  double dx_b4 = q[j_a4][X] - q[i_a4][X];\n  double dy_b4 = q[j_a4][Y] - q[i_a4][Y];\n  double dz_b4 = q[j_a4][Z] - q[i_a4][Z];\n  double dx_a1,dy_a1,dz_a1;\n  double dx_a2,dy_a2,dz_a2;\n  double dx_a3,dy_a3,dz_a3;\n  double dx_a4,dy_a4,dz_a4;\n  int i_b1, j_b1;\n  int i_b2, j_b2;\n  int i_b3, j_b3;\n  int i_b4, j_b4;\n  double df_1,df_2,df_3,df_4;\n  for(k=4;k<(number_of_pairs)/4*4;k+=4){\n    dx_a1 = dx_b1; \n    dy_a1 = dy_b1; \n    dz_a1 = dz_b1; \n    dx_a2 = dx_b2; \n    dy_a2 = dy_b2; \n    dz_a2 = dz_b2; \n    dx_a3 = dx_b3; \n    dy_a3 = dy_b3; \n    dz_a3 = dz_b3; \n    dx_a4 = dx_b4; \n    dy_a4 = dy_b4; \n    dz_a4 = dz_b4; \n\n    i_b1 = i_particles[k];\n    j_b1 = j_particles[k];\n    i_b2 = i_particles[k+1];\n    j_b2 = j_particles[k+1];\n    i_b3 = i_particles[k+2];\n    j_b3 = j_particles[k+2];\n    i_b4 = i_particles[k+3];\n    j_b4 = j_particles[k+3];\n\n    dx_b1 = q[j_b1][X] - q[i_b1][X];\n    dy_b1 = q[j_b1][Y] - q[i_b1][Y];\n    dz_b1 = q[j_b1][Z] - q[i_b1][Z];\n    dx_b2 = q[j_b2][X] - q[i_b2][X];\n    dy_b2 = q[j_b2][Y] - q[i_b2][Y];\n    dz_b2 = q[j_b2][Z] - q[i_b2][Z];\n    dx_b3 = q[j_b3][X] - q[i_b3][X];\n    dy_b3 = q[j_b3][Y] - q[i_b3][Y];\n    dz_b3 = q[j_b3][Z] - q[i_b3][Z];\n    dx_b4 = q[j_b4][X] - q[i_b4][X];\n    dy_b4 = q[j_b4][Y] - q[i_b4][Y];\n    dz_b4 = q[j_b4][Z] - q[i_b4][Z];\n\n    const double r2_1 = (dx_a1 * dx_a1 + dy_a1 * dy_a1 + dz_a1 * dz_a1);\n    const double r2_2 = (dx_a2 * dx_a2 + dy_a2 * dy_a2 + dz_a2 * dz_a2);\n    const double r2_3 = (dx_a3 * dx_a3 + dy_a3 * dy_a3 + dz_a3 * dz_a3);\n    const double r2_4 = (dx_a4 * dx_a4 + dy_a4 * dy_a4 + dz_a4 * dz_a4);\n    const double r6_1 = r2_1 * r2_1 * r2_1;\n    const double r6_2 = r2_2 * r2_2 * r2_2;\n    const double r6_3 = r2_3 * r2_3 * r2_3;\n    const double r6_4 = r2_4 * r2_4 * r2_4;\n    df_1 = ((24.0 * r6_1 - 48.0) / (r6_1 * r6_1 * r2_1)) * dt;\n    df_2 = ((24.0 * r6_2 - 48.0) / (r6_2 * r6_2 * r2_2)) * dt;\n    df_3 = ((24.0 * r6_3 - 48.0) / (r6_3 * r6_3 * r2_3)) * dt;\n    df_4 = ((24.0 * r6_4 - 48.0) / (r6_4 * r6_4 * r2_4)) * dt;\n\n    if (r2_1 > CL2) df_1=0.0;\n    if (r2_2 > CL2) df_2=0.0;\n    if (r2_3 > CL2) df_3=0.0;\n    if (r2_4 > CL2) df_4=0.0;\n    p[i_a1][X] += df_1 * dx_a1;\n    p[i_a1][Y] += df_1 * dy_a1;\n    p[i_a1][Z] += df_1 * dz_a1;\n    p[j_a1][X] -= df_1 * dx_a1;\n    p[j_a1][Y] -= df_1 * dy_a1;\n    p[j_a1][Z] -= df_1 * dz_a1;\n\n    p[i_a2][X] += df_2 * dx_a2;\n    p[i_a2][Y] += df_2 * dy_a2;\n    p[i_a2][Z] += df_2 * dz_a2;\n    p[j_a2][X] -= df_2 * dx_a2;\n    p[j_a2][Y] -= df_2 * dy_a2;\n    p[j_a2][Z] -= df_2 * dz_a2;\n\n    p[i_a3][X] += df_3 * dx_a3;\n    p[i_a3][Y] += df_3 * dy_a3;\n    p[i_a3][Z] += df_3 * dz_a3;\n    p[j_a3][X] -= df_3 * dx_a3;\n    p[j_a3][Y] -= df_3 * dy_a3;\n    p[j_a3][Z] -= df_3 * dz_a3;\n\n    p[i_a4][X] += df_4 * dx_a4;\n    p[i_a4][Y] += df_4 * dy_a4;\n    p[i_a4][Z] += df_4 * dz_a4;\n    p[j_a4][X] -= df_4 * dx_a4;\n    p[j_a4][Y] -= df_4 * dy_a4;\n    p[j_a4][Z] -= df_4 * dz_a4;\n\n    i_a1 = i_b1;\n    j_a1 = j_b1;\n    i_a2 = i_b2;\n    j_a2 = j_b2;\n    i_a3 = i_b3;\n    j_a3 = j_b3;\n    i_a4 = i_b4;\n    j_a4 = j_b4;\n  }\n  for(k=(number_of_pairs)/4*4-4;k<number_of_pairs;k++){ //\u2605\n    const int i = i_particles[k];\n    const int j = j_particles[k];\n    double dx = q[j][X] - q[i][X];\n    double dy = q[j][Y] - q[i][Y];\n    double dz = q[j][Z] - q[i][Z];\n    double r2 = (dx * dx + dy * dy + dz * dz);\n    if (r2 > CL2) continue;\n    double r6 = r2 * r2 * r2;\n    double df = ((24.0 * r6 - 48.0) / (r6 * r6 * r2)) * dt;\n    p[i][X] += df * dx;\n    p[i][Y] += df * dy;\n    p[i][Z] += df * dz;\n    p[j][X] -= df * dx;\n    p[j][Y] -= df * dy;\n    p[j][Z] -= df * dz;\n  }\n}\n\n\u30a2\u30db\u307f\u305f\u3044\u306b\u9577\u304f\u306a\u308a\u307e\u3059\u306d\u3002\u3053\u308c\u3001\u5f8c\u3067\u5909\u6570\u306e\u4ed8\u3051\u65b9\u304c\u60aa\u3044\u3053\u3068\u304c\u308f\u304b\u3063\u305f\u306e\u3067\u3001\u5f8c\u30674\u500d\u5c55\u958b\u3059\u308b\u6642\u306b\u306f\u5225\u306e\u547d\u540d\u6cd5\u3092\u63a1\u7528\u3057\u307e\u3059(\u4e88\u544a)\u3002\u7aef\u306e\u51e6\u7406\u3092\u624b\u629c\u304d\u3057\u305f\u306e\u304c\u3001\u6700\u5f8c\u306e\n  for(k=(number_of_pairs)/4*4-4;k<number_of_pairs;k++){//\u2605\n\n\u306b\u3042\u3089\u308f\u308c\u3066\u3044\u308b\u3002\u672c\u6765\u306f-4\u306f\u4e0d\u8981\u306a\u306e\u3060\u304c\u3001\u5148\u8aad\u307f\u3057\u305f\u7d50\u679c\u3092\u6368\u3066\u3066\u518d\u8a08\u7b97\u3057\u3066\u3044\u308b\u3002\u5148\u306b\u8ff0\u3079\u305f\u3088\u3046\u306b\u3001\u3053\u308c\u306f\u4eca\u56de\u306f\u554f\u984c\u306b\u306f\u306a\u3089\u306a\u3044\u3002\n\n\u7d50\u679c\n\n\n\n\u8a08\u7b97\u624b\u6cd5\n\u5b9f\u884c\u6642\u9593[sec]\n\u5099\u8003\n\n\n\n\npair\n8.176446\n\u30da\u30a2\u3054\u3068\u306b\u30eb\u30fc\u30d7\u3092\u307e\u308f\u3057\u305f\u3082\u306e\n\n\npair_swp\n6.995374\n\u4e0a\u8a18\u3092\u30bd\u30d5\u30c8\u30a6\u30a7\u30a2\u30d1\u30a4\u30d7\u30e9\u30a4\u30cb\u30f3\u30b0\u3057\u305f\u3082\u306e\n\n\npair_swp_intrin\n8.332802\n\u4e0a\u8a18\u30924\u500d\u5c55\u958b\u3057\u305f\u3082\u306e\n\n\n\n\u306a\u3093\u304b\u5b9f\u884c\u6642\u9593\u304c\u3084\u3051\u306b\u9577\u304f\u306a\u3063\u3066\u308b\u3051\u3069\u3001\u6c17\u306b\u3057\u306a\u3044\u3067\u3053\u308c\u3092SIMD\u5316\u3059\u308b\u3053\u3068\u306b\u3057\u3088\u3046\u3002\n\u3053\u3053\u307e\u3067\u306e\u30b3\u30fc\u30c9\u306f\u4ee5\u4e0b\u306b\u304a\u3044\u3066\u3042\u308b\u3002\nhttps://github.com/kaityo256/lj_simdstep/tree/master/step3\n\u6b21\u56de\u3078\u7d9a\u304f\u3002\n# \u306f\u3058\u3081\u306b\n\nLJ\u306eSIMD\u5316\u306e\u8a66\u307f\u3002\u4eca\u56de\u306f\u30bd\u30d5\u30c8\u30a6\u30a7\u30a2\u30d1\u30a4\u30d7\u30e9\u30a4\u30cb\u30f3\u30b0\u3057\u305f\u30b3\u30fc\u30c9\u3092\uff14\u500d\u5c55\u958b\u3059\u308b\u3002\n\n* [\u305d\u306e0](http://qiita.com/kaityo256/items/5be3ce71a6ff9522a0e6) \n* [\u305d\u306e1](http://qiita.com/kaityo256/items/4d34bf144122b78fcf49)\n* [\u305d\u306e2](http://qiita.com/kaityo256/items/e6c41b94c5cc5189c5cc) \n* [\u305d\u306e3](http://qiita.com/kaityo256/items/7f16ab7f2281bb03e83e) \u2190\u30a4\u30de\u30b3\u30b3\n* [\u305d\u306e3.5](http://qiita.com/kaityo256/items/b145b2d83becccd0aa53)\n* [\u305d\u306e4](http://qiita.com/kaityo256/items/636c5a407f5a6c61bb21)\n* [\u305d\u306e5](http://qiita.com/kaityo256/items/dacbe5a16abbc83eb107)\n* [\u305d\u306e6](http://qiita.com/kaityo256/items/34c371c6d040be1bdc30)\n\n\u30b3\u30fc\u30c9\u306f\nhttps://github.com/kaityo256/lj_simdstep\n\u306b\u304a\u3044\u3066\u3042\u308b\u3002\n\n\u203b \u3063\u3066\u3044\u3046\u304b\u30bf\u30b0\u306bAVX2\u3068\u304b\u66f8\u3044\u3066\u3042\u308b\u306e\u306b\u3001\u3053\u3053\u307e\u3067AVX2\u547d\u4ee4\u3092\u3061\u3063\u3068\u3082\u4f7f\u3063\u3066\u306a\u3044\u306e\u304c\u8a50\u6b3a\u3063\u307d\u3044\u3002\n\n# 4\u500d\u5c55\u958b\n\n\u30eb\u30fc\u30d7\u3092\u30bd\u30d5\u30c8\u30a6\u30a7\u30a2\u30d1\u30a4\u30d7\u30e9\u30a4\u30cb\u30f3\u30b0\u3067\u304d\u305f\u306e\u3067\u3001\u3053\u308c\u3092\u99ac\u9e7fSIMD\u5316\u306e\u305f\u3081\u306b4\u500d\u5c55\u958b\u3059\u308b\u3002\u305f\u3060\u3057\u3001\u30bd\u30d5\u30c8\u30a6\u30a7\u30a2\u30d1\u30a4\u30d7\u30e9\u30a4\u30cb\u30f3\u30b0\u3057\u3066\u3044\u308b\u306e\u3067\u7aef\u306e\u51e6\u7406\u9762\u5012\u306b\u306a\u308b\u3002\u771f\u9762\u76ee\u306b\u3084\u308b\u306a\u3089\u30eb\u30fc\u30d7\u5185\u3067\u8a08\u7b97\u3057\u305f\u7d50\u679c\u3092\u30eb\u30fc\u30d7\u5916\u3067\u3061\u3083\u3093\u3068\u4f7f\u3063\u3066\u304b\u3089\u3001\u30b4\u30df\u306e\u51e6\u7406\u3092\u3057\u306a\u3051\u308c\u3070\u306a\u3089\u306a\u3044\u304c\u3001\u9762\u5012\u306a\u306e\u3067\u4e00\u756a\u7aef\u306f\u5148\u8aad\u307f\u3057\u305f\u7d50\u679c\u3092\u6368\u3066\u3066\u3001\u518d\u5ea6\u8a08\u7b97\u3057\u3066\u3057\u307e\u304a\u3046\u3002\u3069\u3046\u305b\u30eb\u30fc\u30d7\u9577\u304c\u3059\u3054\u304f\u9577\u3044(\u4eca\u56de\u306e\u30b1\u30fc\u30b9\u30677839886\u56de\u8ee2)\u306e\u3067\u3001\u305d\u306e\u30b3\u30b9\u30c8\u306f\u7121\u8996\u3067\u304d\u308b\u3002\n\n\u305d\u3046\u3044\u3063\u305f\u65b9\u91dd\u3067\u4f5c\u3063\u305f4\u500d\u5c55\u958b\u306e\u30b3\u30fc\u30c9\u306f\u3053\u3061\u3089\u3002\u3053\u308c\u304b\u3089SIMD\u5316\u3059\u308b\u305f\u3081\u3001\u540d\u524d\u3092force_pair_swp_intrin\u3068\u3057\u3066\u3042\u308b\u3002\n\n```cpp\nvoid\nforce_pair_swp_intrin(void){\n  int k = 0;\n  int i_a1 = i_particles[k];\n  int j_a1 = j_particles[k];\n  int i_a2 = i_particles[k+1];\n  int j_a2 = j_particles[k+1];\n  int i_a3 = i_particles[k+2];\n  int j_a3 = j_particles[k+2];\n  int i_a4 = i_particles[k+3];\n  int j_a4 = j_particles[k+3];\n  double dx_b1 = q[j_a1][X] - q[i_a1][X];\n  double dy_b1 = q[j_a1][Y] - q[i_a1][Y];\n  double dz_b1 = q[j_a1][Z] - q[i_a1][Z];\n  double dx_b2 = q[j_a2][X] - q[i_a2][X];\n  double dy_b2 = q[j_a2][Y] - q[i_a2][Y];\n  double dz_b2 = q[j_a2][Z] - q[i_a2][Z];\n  double dx_b3 = q[j_a3][X] - q[i_a3][X];\n  double dy_b3 = q[j_a3][Y] - q[i_a3][Y];\n  double dz_b3 = q[j_a3][Z] - q[i_a3][Z];\n  double dx_b4 = q[j_a4][X] - q[i_a4][X];\n  double dy_b4 = q[j_a4][Y] - q[i_a4][Y];\n  double dz_b4 = q[j_a4][Z] - q[i_a4][Z];\n  double dx_a1,dy_a1,dz_a1;\n  double dx_a2,dy_a2,dz_a2;\n  double dx_a3,dy_a3,dz_a3;\n  double dx_a4,dy_a4,dz_a4;\n  int i_b1, j_b1;\n  int i_b2, j_b2;\n  int i_b3, j_b3;\n  int i_b4, j_b4;\n  double df_1,df_2,df_3,df_4;\n  for(k=4;k<(number_of_pairs)/4*4;k+=4){\n    dx_a1 = dx_b1; \n    dy_a1 = dy_b1; \n    dz_a1 = dz_b1; \n    dx_a2 = dx_b2; \n    dy_a2 = dy_b2; \n    dz_a2 = dz_b2; \n    dx_a3 = dx_b3; \n    dy_a3 = dy_b3; \n    dz_a3 = dz_b3; \n    dx_a4 = dx_b4; \n    dy_a4 = dy_b4; \n    dz_a4 = dz_b4; \n\n    i_b1 = i_particles[k];\n    j_b1 = j_particles[k];\n    i_b2 = i_particles[k+1];\n    j_b2 = j_particles[k+1];\n    i_b3 = i_particles[k+2];\n    j_b3 = j_particles[k+2];\n    i_b4 = i_particles[k+3];\n    j_b4 = j_particles[k+3];\n\n    dx_b1 = q[j_b1][X] - q[i_b1][X];\n    dy_b1 = q[j_b1][Y] - q[i_b1][Y];\n    dz_b1 = q[j_b1][Z] - q[i_b1][Z];\n    dx_b2 = q[j_b2][X] - q[i_b2][X];\n    dy_b2 = q[j_b2][Y] - q[i_b2][Y];\n    dz_b2 = q[j_b2][Z] - q[i_b2][Z];\n    dx_b3 = q[j_b3][X] - q[i_b3][X];\n    dy_b3 = q[j_b3][Y] - q[i_b3][Y];\n    dz_b3 = q[j_b3][Z] - q[i_b3][Z];\n    dx_b4 = q[j_b4][X] - q[i_b4][X];\n    dy_b4 = q[j_b4][Y] - q[i_b4][Y];\n    dz_b4 = q[j_b4][Z] - q[i_b4][Z];\n\n    const double r2_1 = (dx_a1 * dx_a1 + dy_a1 * dy_a1 + dz_a1 * dz_a1);\n    const double r2_2 = (dx_a2 * dx_a2 + dy_a2 * dy_a2 + dz_a2 * dz_a2);\n    const double r2_3 = (dx_a3 * dx_a3 + dy_a3 * dy_a3 + dz_a3 * dz_a3);\n    const double r2_4 = (dx_a4 * dx_a4 + dy_a4 * dy_a4 + dz_a4 * dz_a4);\n    const double r6_1 = r2_1 * r2_1 * r2_1;\n    const double r6_2 = r2_2 * r2_2 * r2_2;\n    const double r6_3 = r2_3 * r2_3 * r2_3;\n    const double r6_4 = r2_4 * r2_4 * r2_4;\n    df_1 = ((24.0 * r6_1 - 48.0) / (r6_1 * r6_1 * r2_1)) * dt;\n    df_2 = ((24.0 * r6_2 - 48.0) / (r6_2 * r6_2 * r2_2)) * dt;\n    df_3 = ((24.0 * r6_3 - 48.0) / (r6_3 * r6_3 * r2_3)) * dt;\n    df_4 = ((24.0 * r6_4 - 48.0) / (r6_4 * r6_4 * r2_4)) * dt;\n\n    if (r2_1 > CL2) df_1=0.0;\n    if (r2_2 > CL2) df_2=0.0;\n    if (r2_3 > CL2) df_3=0.0;\n    if (r2_4 > CL2) df_4=0.0;\n    p[i_a1][X] += df_1 * dx_a1;\n    p[i_a1][Y] += df_1 * dy_a1;\n    p[i_a1][Z] += df_1 * dz_a1;\n    p[j_a1][X] -= df_1 * dx_a1;\n    p[j_a1][Y] -= df_1 * dy_a1;\n    p[j_a1][Z] -= df_1 * dz_a1;\n\n    p[i_a2][X] += df_2 * dx_a2;\n    p[i_a2][Y] += df_2 * dy_a2;\n    p[i_a2][Z] += df_2 * dz_a2;\n    p[j_a2][X] -= df_2 * dx_a2;\n    p[j_a2][Y] -= df_2 * dy_a2;\n    p[j_a2][Z] -= df_2 * dz_a2;\n\n    p[i_a3][X] += df_3 * dx_a3;\n    p[i_a3][Y] += df_3 * dy_a3;\n    p[i_a3][Z] += df_3 * dz_a3;\n    p[j_a3][X] -= df_3 * dx_a3;\n    p[j_a3][Y] -= df_3 * dy_a3;\n    p[j_a3][Z] -= df_3 * dz_a3;\n\n    p[i_a4][X] += df_4 * dx_a4;\n    p[i_a4][Y] += df_4 * dy_a4;\n    p[i_a4][Z] += df_4 * dz_a4;\n    p[j_a4][X] -= df_4 * dx_a4;\n    p[j_a4][Y] -= df_4 * dy_a4;\n    p[j_a4][Z] -= df_4 * dz_a4;\n\n    i_a1 = i_b1;\n    j_a1 = j_b1;\n    i_a2 = i_b2;\n    j_a2 = j_b2;\n    i_a3 = i_b3;\n    j_a3 = j_b3;\n    i_a4 = i_b4;\n    j_a4 = j_b4;\n  }\n  for(k=(number_of_pairs)/4*4-4;k<number_of_pairs;k++){ //\u2605\n    const int i = i_particles[k];\n    const int j = j_particles[k];\n    double dx = q[j][X] - q[i][X];\n    double dy = q[j][Y] - q[i][Y];\n    double dz = q[j][Z] - q[i][Z];\n    double r2 = (dx * dx + dy * dy + dz * dz);\n    if (r2 > CL2) continue;\n    double r6 = r2 * r2 * r2;\n    double df = ((24.0 * r6 - 48.0) / (r6 * r6 * r2)) * dt;\n    p[i][X] += df * dx;\n    p[i][Y] += df * dy;\n    p[i][Z] += df * dz;\n    p[j][X] -= df * dx;\n    p[j][Y] -= df * dy;\n    p[j][Z] -= df * dz;\n  }\n}\n```\n\n\u30a2\u30db\u307f\u305f\u3044\u306b\u9577\u304f\u306a\u308a\u307e\u3059\u306d\u3002\u3053\u308c\u3001\u5f8c\u3067\u5909\u6570\u306e\u4ed8\u3051\u65b9\u304c\u60aa\u3044\u3053\u3068\u304c\u308f\u304b\u3063\u305f\u306e\u3067\u3001\u5f8c\u30674\u500d\u5c55\u958b\u3059\u308b\u6642\u306b\u306f\u5225\u306e\u547d\u540d\u6cd5\u3092\u63a1\u7528\u3057\u307e\u3059(\u4e88\u544a)\u3002\u7aef\u306e\u51e6\u7406\u3092\u624b\u629c\u304d\u3057\u305f\u306e\u304c\u3001\u6700\u5f8c\u306e\n\n```cpp\n  for(k=(number_of_pairs)/4*4-4;k<number_of_pairs;k++){//\u2605\n```\n\u306b\u3042\u3089\u308f\u308c\u3066\u3044\u308b\u3002\u672c\u6765\u306f`-4`\u306f\u4e0d\u8981\u306a\u306e\u3060\u304c\u3001\u5148\u8aad\u307f\u3057\u305f\u7d50\u679c\u3092\u6368\u3066\u3066\u518d\u8a08\u7b97\u3057\u3066\u3044\u308b\u3002\u5148\u306b\u8ff0\u3079\u305f\u3088\u3046\u306b\u3001\u3053\u308c\u306f\u4eca\u56de\u306f\u554f\u984c\u306b\u306f\u306a\u3089\u306a\u3044\u3002\n\n# \u7d50\u679c\n\n| \u8a08\u7b97\u624b\u6cd5 | \u5b9f\u884c\u6642\u9593[sec] |\u5099\u8003 |\n|:-:|:-:|:-:|\n| pair  | 8.176446  |  \u30da\u30a2\u3054\u3068\u306b\u30eb\u30fc\u30d7\u3092\u307e\u308f\u3057\u305f\u3082\u306e |\n| pair_swp  | 6.995374  |  \u4e0a\u8a18\u3092\u30bd\u30d5\u30c8\u30a6\u30a7\u30a2\u30d1\u30a4\u30d7\u30e9\u30a4\u30cb\u30f3\u30b0\u3057\u305f\u3082\u306e |\n| pair_swp_intrin  | 8.332802  |  \u4e0a\u8a18\u30924\u500d\u5c55\u958b\u3057\u305f\u3082\u306e |\n\n\u306a\u3093\u304b\u5b9f\u884c\u6642\u9593\u304c\u3084\u3051\u306b\u9577\u304f\u306a\u3063\u3066\u308b\u3051\u3069\u3001\u6c17\u306b\u3057\u306a\u3044\u3067\u3053\u308c\u3092SIMD\u5316\u3059\u308b\u3053\u3068\u306b\u3057\u3088\u3046\u3002\n\n\u3053\u3053\u307e\u3067\u306e\u30b3\u30fc\u30c9\u306f\u4ee5\u4e0b\u306b\u304a\u3044\u3066\u3042\u308b\u3002\nhttps://github.com/kaityo256/lj_simdstep/tree/master/step3\n\n[\u6b21\u56de\u3078\u7d9a\u304f](http://qiita.com/kaityo256/items/b145b2d83becccd0aa53)\u3002\n\n\n", "tags": ["AVX2", "AVX", "C++"]}