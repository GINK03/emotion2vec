{"tags": ["pacemaker", "corosync", "drbd"], "context": " More than 1 year has passed since last update.\n\n\u53c2\u8003\n\n\n@takehironet\u3055\u3093\u306eCentOS 6\u3067Pacemaker 1.1\u3092\u3064\u304b\u3046 - Qiita\n\nLinux-HA Japan\u306e\u3059\u3050\u306b\u59cb\u3081\u3089\u308c\u308b\uff01\u6700\u65b0\u306ePacemaker\u3067\u59cb\u3081\u308b\u9ad8\u53ef\u7528\u30af\u30e9\u30b9\u30bf\u5165\u9580\n\n\n\n\u53e4\u3044\u60c5\u5831\u304c\u591a\u3059\u304e\u305f\u306e\u3067\u691c\u7d22\u6642\u3001\u4ee5\u4e0b\u306b\u6ce8\u610f\u3057\u305f\u3002\n\nheartbeat\u3092\u4f7f\u3046\u306e\u306f\u53e4\u3044\nmember\u3067\u66f8\u3044\u3066\u3044\u308b\u306e\u306f\u53e4\u3044\u3002nodelist\u3092\u4f7f\u3046\u3002\n\nservice corosync start\u306f\u53e4\u3044\u3002initctl start pacemaker.combined\u3092\u4f7f\u3046\u3002\n\n\n\u4eca\u56de\u306e\u69cb\u6210\n\nIP\n\n\n192.168.100.199 (drbd1.local)\n192.168.100.200 (drbd2.local)\n\n\n\n\nselinux\u3092disabled\n\n/etc/sysconfig/selinux\n- SELINUX=enforcing\n+ SELINUX=disabled\n\n\n\niptables\u3092off\nservice iptables stop\nchkconfig iptables off\n\n\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u624b\u9806\n\n\u30d1\u30c3\u30b1\u30fc\u30b8\u304c\u7af6\u5408\u3059\u308b\u306e\u3067\u9664\u5916\n\n/etc/yum.repos.d/CentOS-Base.repo\n  [base]\n+ exclude=pacemaker pacemaker-libs corosync cluster-glue heartbeat resource-agents\n\n  [updates]\n+ exclude=pacemaker pacemaker-libs corosync cluster-glue heartbeat resource-agents\n\n...\n\n\n\nLinux-HA\u306e\u30d1\u30c3\u30b1\u30fc\u30b8\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n\u30d1\u30c3\u30b1\u30fc\u30b8 [1-01] Pacemaker\u30ea\u30dd\u30b8\u30c8\u30ea\u30d1\u30c3\u30b1\u30fc\u30b8 (RHEL6) - Linux-HA Japan - SourceForge.JP\n\nrpm -ivh pacemaker-repo-1.1.12-1.1.el6.x86_64.rpm\n\n\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\nyum install {corosync,pacemaker}.x86_64 crmsh\n\n\ncorosync.conf\n\n/etc/corosync/corosync.conf\ntotem {\n        version: 2\n        crypto_cipher: none\n        crypto_hash: none\n        interface {\n                ringnumber: 0\n                bindnetaddr: 192.168.100.0\n                mcastport: 5405\n                ttl: 1\n        }\n        transport: udpu\n}\nlogging {\n        fileline: off\n        to_logfile: yes\n        to_syslog: no\n        logfile: /var/log/cluster/corosync.log\n        debug: off\n        timestamp: on\n        logger_subsys {\n                subsys: QUORUM\n                debug: off\n        }\n}\nnodelist {\n        node {\n                ring0_addr: 192.168.100.199\n                nodeid: 1\n        }\n        node {\n                ring0_addr: 192.168.100.200\n                nodeid: 2\n        }\n}\nquorum {\n        provider: corosync_votequorum\n        expected_votes: 2\n        two_node: 1\n}\n\n\n\ncorosync\u8d77\u52d5\ninitctl start pacemaker.combined\n\n\npacemaker\u3067\u30af\u30e9\u30b9\u30bf\u72b6\u614b\u78ba\u8a8d\ncrm_mon -A\n\n\n\u901a\u4fe1\u72b6\u6cc1\u306e\u78ba\u8a8d\n# tcpdump -s 0 udp and port 5405\ntcpdump: verbose output suppressed, use -v or -vv for full protocol decode\nlistening on eth0, link-type EN10MB (Ethernet), capture size 65535 bytes\n07:49:07.672750 IP 192.168.100.199.netsupport > 192.168.100.200.netsupport: UDP, length 74\n07:49:07.672990 IP 192.168.100.200.netsupport > 192.168.100.199.netsupport: UDP, length 74\n...\n\n\n\n\u4ee5\u4e0bpacemaker - 2\u53f0\u3067HA\u69cb\u7bc9 (CentOS5.11) - Qiita\u3092\u30d9\u30fc\u30b9\u306b\u8a18\u8ff0\n\n5.2. STONITH\u7121\u52b9\u5316\n# /usr/sbin/crm_verify -L -V\n   error: unpack_resources:     Resource start-up disabled since no STONITH resources have been defined\n   error: unpack_resources:     Either configure some or disable STONITH with the stonith-enabled option\n   error: unpack_resources:     NOTE: Clusters with shared data need STONITH to ensure data integrity\nErrors found during check: config not valid\n\ncrm configure property stonith-enabled=false\n\n\n5.3. \u4eee\u60f3IP\u306e\u8a2d\u5b9a\ncrm configure \\\n  primitive \\\n  ClusterIP \\\n  ocf:heartbeat:IPaddr2 \\\n  params \\\n  ip=192.168.100.198 \\\n  cidr_netmask=24 \\\n  nic=eth0 \\\n  iflabel=0 \\\n  op \\\n  monitor \\\n  interval=30s \\\n  nic=eth0 \\\n  iflabel=:0\n\n\n5.4. quorum\u7121\u52b9\u5316\ncrm configure property no-quorum-policy=ignore\n\n\n\u30ce\u30fc\u30c9\u5fa9\u5e30\u6642\u306b\u81ea\u52d5\u3067\u30ea\u30bd\u30fc\u30b9\u3092\u5143\u306e\u30ce\u30fc\u30c9\u4e0a\u306b\u79fb\u305d\u3046\u3068\u3059\u308b\u306e\u3092\u6b62\u3081\u308b\ncrm configure rsc_defaults resource-stickiness=100\n\n\n\n6. DRBD\n\n6.1. \u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\nrpm --import https://www.elrepo.org/RPM-GPG-KEY-elrepo.org\nrpm -Uvh http://www.elrepo.org/elrepo-release-6-6.el6.elrepo.noarch.rpm\nyum install -y drbd84-utils kmod-drbd84\n\nchkconfig drbd off\nreboot\n\n\n6.2. \u8a2d\u5b9a\n\n/etc/drbd.conf\nresource mysqldata {\n    volume 0 {\n        device /dev/drbd0;\n        disk /dev/vdb1;\n        meta-disk internal;\n    }\n    on drbd1.local {\n        address 192.168.100.199:7788;\n    }\n    on drbd2.local {\n        address 192.168.100.200:7788;\n    }\n}\n\n\n\n6.3. hosts\u306b\u3066\u540d\u524d\u89e3\u6c7a\n\n\u540c\u3058\n\n\n6.4. create-md\n\n\u540c\u3058\n\n\n6.5. DRBD\u30c7\u30d0\u30a4\u30b9\u306e\u72b6\u614b\u78ba\u8a8d\n\n\u540c\u3058\n\n\n6.6. DRBD\u30c7\u30d0\u30a4\u30b9\u306e\u521d\u671f\u5316\n\n\u540c\u3058\n\n\n7. crm (pacemaker)\n\u4eca\u5ea6\u6311\u6226\u3059\u308b\u3002\u4e0a\u624b\u304f\u884c\u304b\u306a\u304b\u3063\u305f\u3002\n\ncrm_mon\u00a0-A\nLast updated: Tue Mar 17 11:27:39 2015\nLast change: Tue Mar 17 11:25:38 2015\nStack: corosync\nCurrent DC: drbd1.local (1) - partition with quorum\nVersion: 1.1.12-561c4cf\n2 Nodes configured\n4 Resources configured\n\n\nOnline: [ drbd1.local drbd2.local ]\n\n\nNode Attributes:\n* Node drbd1.local:\n* Node drbd2.local:\n\nFailed actions:\n    MySQLData_monitor_0 on drbd2.local 'not installed' (5): call=5, status=Not installed, last-rc-change='Tue Mar 17 11:26:36 2015', queued=0ms, exec=1ms\n    MySQLData_monitor_0 on drbd2.local 'not installed' (5): call=5, status=Not installed, last-rc-change='Tue Mar 17 11:26:36 2015', queued=0ms, exec=1ms\n    MySQLFS_start_0 on drbd2.local 'not installed' (5): call=18, status=complete, last-rc-change='Tue Mar 17 11:26:36 2015', queued=0ms, exec=24ms\n    MySQLData_monitor_0 on drbd1.local 'not installed' (5): call=5, status=Not installed, last-rc-change='Tue Mar 17 11:26:35 2015', queued=0ms, exec=6ms\n    MySQLData_monitor_0 on drbd1.local 'not installed' (5): call=5, status=Not installed, last-rc-change='Tue Mar 17 11:26:35 2015', queued=0ms, exec=6ms\n    MySQLFS_start_0 on drbd1.local 'not installed' (5): call=18, status=complete, last-rc-change='Tue Mar 17 11:26:36 2015', queued=0ms, exec=41ms\n\n\n\ncrm configure edit\n\n\ncrm show\u306e\u4e2d\u8eab\u3092\u7de8\u96c6\u3067\u304d\u308b\u3002\n\ncrm configure edit\n\ncrm configure commit\n\n## \u53c2\u8003\n\n* @takehironet\u3055\u3093\u306e[CentOS 6\u3067Pacemaker 1.1\u3092\u3064\u304b\u3046 - Qiita](http://qiita.com/takehironet/items/ee6a50f7f9b349abd085)\n* Linux-HA Japan\u306e[\u3059\u3050\u306b\u59cb\u3081\u3089\u308c\u308b\uff01\u6700\u65b0\u306ePacemaker\u3067\u59cb\u3081\u308b\u9ad8\u53ef\u7528\u30af\u30e9\u30b9\u30bf\u5165\u9580](http://linux-ha.sourceforge.jp/wp/wp-content/uploads/OSC-Tokyo2014Fall.pdf)\n\n## \u53e4\u3044\u60c5\u5831\u304c\u591a\u3059\u304e\u305f\u306e\u3067\u691c\u7d22\u6642\u3001\u4ee5\u4e0b\u306b\u6ce8\u610f\u3057\u305f\u3002\n\n* heartbeat\u3092\u4f7f\u3046\u306e\u306f\u53e4\u3044\n* member\u3067\u66f8\u3044\u3066\u3044\u308b\u306e\u306f\u53e4\u3044\u3002nodelist\u3092\u4f7f\u3046\u3002\n* `service corosync start`\u306f\u53e4\u3044\u3002`initctl start pacemaker.combined`\u3092\u4f7f\u3046\u3002\n\n\n# \u4eca\u56de\u306e\u69cb\u6210\n\n* IP\n  * 192.168.100.199 (drbd1.local)\n  * 192.168.100.200 (drbd2.local)\n\n## selinux\u3092disabled\n\n```diff:/etc/sysconfig/selinux\n- SELINUX=enforcing\n+ SELINUX=disabled\n```\n\n## iptables\u3092off\n\n\n```bash:\nservice iptables stop\nchkconfig iptables off\n```\n\n# \u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u624b\u9806\n\n## \u30d1\u30c3\u30b1\u30fc\u30b8\u304c\u7af6\u5408\u3059\u308b\u306e\u3067\u9664\u5916\n\n```diff:/etc/yum.repos.d/CentOS-Base.repo\n  [base]\n+ exclude=pacemaker pacemaker-libs corosync cluster-glue heartbeat resource-agents\n  \n  [updates]\n+ exclude=pacemaker pacemaker-libs corosync cluster-glue heartbeat resource-agents\n\n...\n```\n\n\n## Linux-HA\u306e\u30d1\u30c3\u30b1\u30fc\u30b8\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n* [\u30d1\u30c3\u30b1\u30fc\u30b8 [1-01] Pacemaker\u30ea\u30dd\u30b8\u30c8\u30ea\u30d1\u30c3\u30b1\u30fc\u30b8 (RHEL6) - Linux-HA Japan - SourceForge.JP](http://sourceforge.jp/projects/linux-ha/releases/p12469)\n\n```bash:\nrpm -ivh pacemaker-repo-1.1.12-1.1.el6.x86_64.rpm\n```\n\n\n## \u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n```bash:\nyum install {corosync,pacemaker}.x86_64 crmsh\n```\n\n## corosync.conf\n\n```c:/etc/corosync/corosync.conf\ntotem {\n        version: 2\n        crypto_cipher: none\n        crypto_hash: none\n        interface {\n                ringnumber: 0\n                bindnetaddr: 192.168.100.0\n                mcastport: 5405\n                ttl: 1\n        }\n        transport: udpu\n}\nlogging {\n        fileline: off\n        to_logfile: yes\n        to_syslog: no\n        logfile: /var/log/cluster/corosync.log\n        debug: off\n        timestamp: on\n        logger_subsys {\n                subsys: QUORUM\n                debug: off\n        }\n}\nnodelist {\n        node {\n                ring0_addr: 192.168.100.199\n                nodeid: 1\n        }\n        node {\n                ring0_addr: 192.168.100.200\n                nodeid: 2\n        }\n}\nquorum {\n        provider: corosync_votequorum\n        expected_votes: 2\n        two_node: 1\n}\n```\n\n# corosync\u8d77\u52d5\n\n```bash:\ninitctl start pacemaker.combined\n```\n\n# pacemaker\u3067\u30af\u30e9\u30b9\u30bf\u72b6\u614b\u78ba\u8a8d\n\n```bash:\ncrm_mon -A\n```\n\n## \u901a\u4fe1\u72b6\u6cc1\u306e\u78ba\u8a8d\n\n```bash:\n# tcpdump -s 0 udp and port 5405\ntcpdump: verbose output suppressed, use -v or -vv for full protocol decode\nlistening on eth0, link-type EN10MB (Ethernet), capture size 65535 bytes\n07:49:07.672750 IP 192.168.100.199.netsupport > 192.168.100.200.netsupport: UDP, length 74\n07:49:07.672990 IP 192.168.100.200.netsupport > 192.168.100.199.netsupport: UDP, length 74\n...\n```\n\n\n----\n\n# \u4ee5\u4e0b[pacemaker - 2\u53f0\u3067HA\u69cb\u7bc9 (CentOS5.11) - Qiita](http://qiita.com/tukiyo3/items/00c73c45d015e55ab4fc)\u3092\u30d9\u30fc\u30b9\u306b\u8a18\u8ff0\n\n\n## 5.2. STONITH\u7121\u52b9\u5316\n\n```bash:\n# /usr/sbin/crm_verify -L -V\n   error: unpack_resources: \tResource start-up disabled since no STONITH resources have been defined\n   error: unpack_resources: \tEither configure some or disable STONITH with the stonith-enabled option\n   error: unpack_resources: \tNOTE: Clusters with shared data need STONITH to ensure data integrity\nErrors found during check: config not valid\n```\n\n```bash:\ncrm configure property stonith-enabled=false\n```\n\n## 5.3. \u4eee\u60f3IP\u306e\u8a2d\u5b9a\n\n```bash:\ncrm configure \\\n  primitive \\\n  ClusterIP \\\n  ocf:heartbeat:IPaddr2 \\\n  params \\\n  ip=192.168.100.198 \\\n  cidr_netmask=24 \\\n  nic=eth0 \\\n  iflabel=0 \\\n  op \\\n  monitor \\\n  interval=30s \\\n  nic=eth0 \\\n  iflabel=:0\n```\n\n## 5.4. quorum\u7121\u52b9\u5316\n\n```bash:\ncrm configure property no-quorum-policy=ignore\n```\n\n```bash:\u30ce\u30fc\u30c9\u5fa9\u5e30\u6642\u306b\u81ea\u52d5\u3067\u30ea\u30bd\u30fc\u30b9\u3092\u5143\u306e\u30ce\u30fc\u30c9\u4e0a\u306b\u79fb\u305d\u3046\u3068\u3059\u308b\u306e\u3092\u6b62\u3081\u308b\ncrm configure rsc_defaults resource-stickiness=100\n```\n\n# 6. DRBD\n\n## 6.1. \u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n```bash:\nrpm --import https://www.elrepo.org/RPM-GPG-KEY-elrepo.org\nrpm -Uvh http://www.elrepo.org/elrepo-release-6-6.el6.elrepo.noarch.rpm\nyum install -y drbd84-utils kmod-drbd84\n```\n\n```bash:\nchkconfig drbd off\nreboot\n```\n\n## 6.2. \u8a2d\u5b9a\n\n```ruby:/etc/drbd.conf\nresource mysqldata {\n    volume 0 {\n        device /dev/drbd0;\n        disk /dev/vdb1;\n        meta-disk internal;\n    }\n    on drbd1.local {\n        address 192.168.100.199:7788;\n    }\n    on drbd2.local {\n        address 192.168.100.200:7788;\n    }\n}\n```\n\n## 6.3. hosts\u306b\u3066\u540d\u524d\u89e3\u6c7a\n\n* \u540c\u3058\n\n## 6.4. create-md\n\n* \u540c\u3058\n\n## 6.5. DRBD\u30c7\u30d0\u30a4\u30b9\u306e\u72b6\u614b\u78ba\u8a8d\n\n* \u540c\u3058\n\n## 6.6. DRBD\u30c7\u30d0\u30a4\u30b9\u306e\u521d\u671f\u5316\n\n* \u540c\u3058\n\n\n\n# 7. crm (pacemaker)\n\n\u4eca\u5ea6\u6311\u6226\u3059\u308b\u3002\u4e0a\u624b\u304f\u884c\u304b\u306a\u304b\u3063\u305f\u3002\n\n```bash:crm_mon&nbsp;-A\nLast updated: Tue Mar 17 11:27:39 2015\nLast change: Tue Mar 17 11:25:38 2015\nStack: corosync\nCurrent DC: drbd1.local (1) - partition with quorum\nVersion: 1.1.12-561c4cf\n2 Nodes configured\n4 Resources configured\n\n\nOnline: [ drbd1.local drbd2.local ]\n\n\nNode Attributes:\n* Node drbd1.local:\n* Node drbd2.local:\n\nFailed actions:\n    MySQLData_monitor_0 on drbd2.local 'not installed' (5): call=5, status=Not installed, last-rc-change='Tue Mar 17 11:26:36 2015', queued=0ms, exec=1ms\n    MySQLData_monitor_0 on drbd2.local 'not installed' (5): call=5, status=Not installed, last-rc-change='Tue Mar 17 11:26:36 2015', queued=0ms, exec=1ms\n    MySQLFS_start_0 on drbd2.local 'not installed' (5): call=18, status=complete, last-rc-change='Tue Mar 17 11:26:36 2015', queued=0ms, exec=24ms\n    MySQLData_monitor_0 on drbd1.local 'not installed' (5): call=5, status=Not installed, last-rc-change='Tue Mar 17 11:26:35 2015', queued=0ms, exec=6ms\n    MySQLData_monitor_0 on drbd1.local 'not installed' (5): call=5, status=Not installed, last-rc-change='Tue Mar 17 11:26:35 2015', queued=0ms, exec=6ms\n    MySQLFS_start_0 on drbd1.local 'not installed' (5): call=18, status=complete, last-rc-change='Tue Mar 17 11:26:36 2015', queued=0ms, exec=41ms\n```\n\n# crm configure edit\n\n* `crm show`\u306e\u4e2d\u8eab\u3092\u7de8\u96c6\u3067\u304d\u308b\u3002\n\n```bash:\ncrm configure edit\n```\n\n```bash:\ncrm configure commit\n```\n"}