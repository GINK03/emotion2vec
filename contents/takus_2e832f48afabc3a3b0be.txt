{"tags": ["hive", "AWS", "Cloudtrail", "EMR"], "context": " More than 1 year has passed since last update.\u4f7f\u308f\u308c\u3066\u306a\u3055\u305d\u3046\u306a\u30a2\u30af\u30bb\u30b9\u30ad\u30fc\u3092\u524a\u9664\u3057\u305f\u3044\u3051\u3069\u3001\u307b\u3093\u3068\u306b\u4f7f\u308f\u308c\u3066\u306a\u3044\u306e\u304b\u81ea\u4fe1\u306a\u3044\u306e\u3067\u3001CloudTrail \u306e\u30ed\u30b0\u3092\u96c6\u8a08\u3057\u3088\u3046\u304b\u306a\u3068\u601d\u3063\u3066\u8abf\u3079\u305f\u3089\u3001Hive \u306e\u795e SerDe \u3092\u898b\u3064\u3051\u305f\u306e\u3067\u30e1\u30e2\u3002\u3053\u306e\u30d6\u30ed\u30b0\u306b\u66f8\u3044\u3066\u3042\u308b\u3053\u3068\u3092\u3084\u3063\u3066\u308b\u3060\u3051\u3002\nhive> CREATE EXTERNAL TABLE IF NOT EXISTS cloud_trail_20150120\n  ROW FORMAT SERDE 'com.amazon.emr.hive.serde.CloudTrailLogDeserializer'\n  STORED AS INPUTFORMAT 'com.amazon.emr.cloudtrail.CloudTrailInputFormat'\n  OUTPUTFORMAT 'org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat'\n  LOCATION 's3://cloudtrail/AWSLogs/xxxxxxxxxxxx/CloudTrail/ap-northeast-1/2015/01/20/'\n;\n\nhive> DESC cloud_trail_20150120;\nOK\neventversion            string                  from deserializer\nuseridentity            struct<type:string,principalid:string,arn:string,accountid:string,invokedby:string,accesskeyid:string,sessioncontext:struct<attributes:struct<mfaauthenticated:string,creationdate:string>>> from deserializer\neventtime               string                  from deserializer\neventsource             string                  from deserializer\neventname               string                  from deserializer\nawsregion               string                  from deserializer\nsourceipaddress         string                  from deserializer\nuseragent               string                  from deserializer\nrequestid               string                  from deserializer\neventid                 string                  from deserializer\nTime taken: 0.047 seconds, Fetched: 10 row(s)\n\nhive> SELECT useridentity.accesskeyid, count(*)\n  FROM cloud_trail_20150120\n  GROUP BY useridentity.accesskeyid\n  ORDER BY useridentity.accesskeyid\n;\nXXXXXXXXXXXXXXXXXXXX    2\nXXXXXXXXXXXXXXXXXXXX    1777\n\nhive> SELECT useragent, count(*)\n  FROM cloud_trail_20150120\n  GROUP BY useragent\n  ORDER BY useragent\n;\nAmazon CLI/ElasticLoadBalancing 1.0.17.0 API 2012-06-01 2\nBoto/2.25.0 Python/2.6.9 Linux/3.4.76-65.111.amzn1.x86_64       1777\n...\n\n\n\u4f7f\u308f\u308c\u3066\u306a\u3055\u305d\u3046\u306a\u30a2\u30af\u30bb\u30b9\u30ad\u30fc\u3092\u524a\u9664\u3057\u305f\u3044\u3051\u3069\u3001\u307b\u3093\u3068\u306b\u4f7f\u308f\u308c\u3066\u306a\u3044\u306e\u304b\u81ea\u4fe1\u306a\u3044\u306e\u3067\u3001CloudTrail \u306e\u30ed\u30b0\u3092\u96c6\u8a08\u3057\u3088\u3046\u304b\u306a\u3068\u601d\u3063\u3066\u8abf\u3079\u305f\u3089\u3001Hive \u306e\u795e SerDe \u3092\u898b\u3064\u3051\u305f\u306e\u3067\u30e1\u30e2\u3002[\u3053\u306e\u30d6\u30ed\u30b0](http://blog.fzakaria.com/2014/10/analyzing-cloudtrail-logs-using-hivehadoop/)\u306b\u66f8\u3044\u3066\u3042\u308b\u3053\u3068\u3092\u3084\u3063\u3066\u308b\u3060\u3051\u3002\n\n```\nhive> CREATE EXTERNAL TABLE IF NOT EXISTS cloud_trail_20150120\n  ROW FORMAT SERDE 'com.amazon.emr.hive.serde.CloudTrailLogDeserializer'\n  STORED AS INPUTFORMAT 'com.amazon.emr.cloudtrail.CloudTrailInputFormat'\n  OUTPUTFORMAT 'org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat'\n  LOCATION 's3://cloudtrail/AWSLogs/xxxxxxxxxxxx/CloudTrail/ap-northeast-1/2015/01/20/'\n;\n\nhive> DESC cloud_trail_20150120;\nOK\neventversion            string                  from deserializer\nuseridentity            struct<type:string,principalid:string,arn:string,accountid:string,invokedby:string,accesskeyid:string,sessioncontext:struct<attributes:struct<mfaauthenticated:string,creationdate:string>>> from deserializer\neventtime               string                  from deserializer\neventsource             string                  from deserializer\neventname               string                  from deserializer\nawsregion               string                  from deserializer\nsourceipaddress         string                  from deserializer\nuseragent               string                  from deserializer\nrequestid               string                  from deserializer\neventid                 string                  from deserializer\nTime taken: 0.047 seconds, Fetched: 10 row(s)\n\nhive> SELECT useridentity.accesskeyid, count(*)\n  FROM cloud_trail_20150120\n  GROUP BY useridentity.accesskeyid\n  ORDER BY useridentity.accesskeyid\n;\nXXXXXXXXXXXXXXXXXXXX    2\nXXXXXXXXXXXXXXXXXXXX    1777\n\nhive> SELECT useragent, count(*)\n  FROM cloud_trail_20150120\n  GROUP BY useragent\n  ORDER BY useragent\n;\nAmazon CLI/ElasticLoadBalancing 1.0.17.0 API 2012-06-01 2\nBoto/2.25.0 Python/2.6.9 Linux/3.4.76-65.111.amzn1.x86_64       1777\n...\n"}