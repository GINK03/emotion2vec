{"context": "Google Compute Engine\u4e0a\u3067Ubuntu\u306eLighttpd\u306bLet's Encrypt\u306e\u8a3c\u660e\u66f8\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3066https\u3092\u6709\u52b9\u306b\u3057\u3066\u307f\u307e\u3059\u3002\u57fa\u672c\u7684\u306b\u81ea\u5206\u7528\u306e\u5099\u5fd8\u9332\u3067\u3059\u3002\n\n\u74b0\u5883\n\nGoogle Cloud Platform\n\nUbuntu LTS 14.04 LTS\nLighttpd\n\n\nGCE\u306eVM\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u8d77\u52d5\nMachine type\u306f\u3068\u308a\u3042\u3048\u305af1-micro\u3092\u9078\u629e\u3001OS\u306fubuntu-14-04\u3092\u9078\u629e\u3001Firewall\u306e\u8a2d\u5b9a\u306eAllow HTTP traffic\u3068Allow HTTPS traffic\u3092\u30c1\u30a7\u30c3\u30af\u3057\u3066\u8d77\u52d5\u3057\u307e\u3059\u3002\n\nLighttpd\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n$ sudo timedatectl set-timezone America/Los_Angeles\n$ sudo apt-get update\n$ sudo apt-get install git\n$ sudo apt-get install lighttpd\n\n\u3053\u306e\u6642\u70b9\u3067\u306f\u3001\u30d6\u30e9\u30a6\u30b6\u304b\u3089http\u3067\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3068\u30c7\u30d5\u30a9\u30eb\u30c8\u306e\u30da\u30fc\u30b8\u304c\u8868\u793a\u3055\u308c\u307e\u3059\u304c\u3001https\u3067\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3068\u63a5\u7d9a\u3067\u304d\u307e\u305b\u3093\u3002\n\nLet's Encrypt\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n$ git clone https://github.com/letsencrypt/letsencrypt\nCloning into 'letsencrypt'...\nremote: Counting objects: 31405, done.\nremote: Compressing objects: 100% (255/255), done.\nremote: Total 31405 (delta 159), reused 0 (delta 0), pack-reused 31150\nReceiving objects: 100% (31405/31405), 8.28 MiB | 15.55 MiB/s, done.\nResolving deltas: 100% (22200/22200), done.\nChecking connectivity... done.\n$ cd letsencrypt\n$ ./letsencrypt-auto --help\nBootstrapping dependencies for Debian-based OSes...\n...\n\nletsencrypt-auto\u306e\u521d\u56de\u8d77\u52d5\u6642\u306f\u5fc5\u8981\u306a\u30d1\u30c3\u30b1\u30fc\u30b8\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u306e\u306b\u5c11\u3057\u6642\u9593\u304c\u304b\u304b\u308a\u307e\u3059\u3002\n\nLet's Encrypt\u304b\u3089\u8a3c\u660e\u66f8\u3092\u53d6\u5f97\n\u4ee5\u4e0b\u3001\u81ea\u5206\u306e\u30c9\u30e1\u30a4\u30f3\u3092https.example.com\u3068\u3057\u307e\u3059\u3002\nLet's Encrypt\u306eTechnology Overview\u306b\u3042\u308b\u3088\u3046\u306b\u3001\u8a3c\u660e\u66f8\u3092\u767a\u884c\u3059\u308b\u524d\u306bDomain Validation\u3092\u884c\u3044\u307e\u3059\u3002\u3053\u308c\u306f\u3001https.example.com\u306e\u8a3c\u660e\u66f8\u3092\u30ea\u30af\u30a8\u30b9\u30c8\u3059\u308bLet's Encrypt\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u304c\u305d\u306e\u30c9\u30e1\u30a4\u30f3\u3092\u7ba1\u7406\u3057\u3066\u3044\u308b\u3053\u3068\u3092\u8a3c\u660e\u3057\u306a\u3051\u308c\u3070\u306a\u308a\u307e\u305b\u3093\u3002Let's Encrypt\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u306e\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u306ePlugins\u306e\u3068\u3053\u308d\u306b\u3044\u304f\u3064\u304b\u65b9\u6cd5\u304c\u3042\u308a\u307e\u3059\u304c\u3001Lighttpd\u306e\u5834\u5408\u306fwebroot\u304c\u7c21\u5358\u305d\u3046\u3067\u3059\u3002\n$ ./letsencrypt-auto certonly --agree-tos --email z80@example.com --webroot --webroot-path /var/www -d https.example.com\nChecking for new version...\nRequesting root privileges to run letsencrypt...\n   sudo /home/z80/.local/share/letsencrypt/bin/letsencrypt --no-self-upgrade certonly --agree-tos --email z80@example.com --webroot --webroot-path /var/www -\nd https.example.com\nIMPORTANT NOTES:\n - Congratulations! Your certificate and chain have been saved at\n   /etc/letsencrypt/live/https.example.com/fullchain.pem. Your cert\n   will expire on 2016-05-14. To obtain a new version of the\n   certificate in the future, simply run Let's Encrypt again.\n\n\u3053\u308c\u3067\u3001/etc/letsencrypt/live/https.example.com/\u306bcert.pem, chain.pem, fullchain.pem, privkey.pem\u304c\u751f\u6210\u3055\u308c\u307e\u3057\u305f\u3002\n\nLighttpd\u306eSSL\u306e\u8a2d\u5b9a\n\u8a3c\u660e\u66f8\u306f\u3069\u3053\u306b\u7f6e\u3044\u3066\u3082\u3044\u3044\u306e\u3067\u3059\u304c\u3001\u3053\u3053\u3067\u306f/etc/lighttpd/ssl\u306b\u7f6e\u304f\u3053\u3068\u306b\u3057\u307e\u3059\u3002Lighttpd SSL Documentation\u306ePermissions\u306b\u3088\u308b\u3068\n\nLighttpd reads all pemfiles at startup, before dropping privileges. It is therefore best to make the pem file owned by root and readable by root only\n\n\u3068\u3044\u3046\u3053\u3068\u306a\u306e\u3067\u3001root\u3060\u3051\u304c\u8aad\u3081\u308b\u3088\u3046\u306b\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n$ sudo mkdir /etc/lighttpd/ssl\n$ sudo chmod 700 /etc/lighttpd/ssl\n$ sudo sh -c \"cat /etc/letsencrypt/live/https.example.com/privkey.pem /etc/letsencrypt/live/https.example.com/cert.pem > /etc/lighttpd/ssl/combined.pem\"\n$ sudo sh -c \"cat /etc/letsencrypt/live/https.example.com/chain.pem > /etc/lighttpd/ssl/chain.pem\"\n\nLighttpd\u306eSSL\u306e\u8a2d\u5b9a\u3092\u5909\u66f4\u3057\u307e\u3059\u3002\n\n/etc/lighttpd/conf-available/10-ssl.conf\n# /usr/share/doc/lighttpd/ssl.txt\n\n$SERVER[\"socket\"] == \"0.0.0.0:443\" {\n        ssl.engine  = \"enable\"\n        ssl.pemfile = \"/etc/lighttpd/ssl/combined.pem\"  # \u5909\u66f4\n        ssl.ca-file = \"/etc/lighttpd/ssl/chain.pem\"     # \u8ffd\u52a0\n\n        ssl.cipher-list = \"ECDHE-RSA-AES256-SHA384:AES256-SHA256:RC4:HIGH:!MD5:!aNULL:!EDH:!AESGCM\"\n        ssl.honor-cipher-order = \"enable\"\n}\n\n\nSSL\u3092\u6709\u52b9\u306b\u3057\u3066Lighttpd\u3092\u518d\u8d77\u52d5\u3057\u307e\u3059\u3002\n$ sudo lighttpd-enable-mod ssl\nEnabling ssl: ok\nRun /etc/init.d/lighttpd force-reload to enable changes\n$ sudo service lighttpd force-reload\n * Reloading web server configuration lighttpd                           [ OK ] \n\n\u30d6\u30e9\u30a6\u30b6\u304b\u3089https\u3067\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3068(\u7d30\u304b\u3044\u554f\u984c\u306f\u3042\u308a\u307e\u3059\u304c)\u6709\u52b9\u306b\u306a\u3063\u3066\u3044\u308b\u3088\u3046\u3067\u3059\u3002\n\n\u8a66\u3057\u306bQualys SSL Labs\u306eSSL Server Test\u3092\u3084\u3063\u3066\u307f\u307e\u3059\u3002\n\n\u30c7\u30d5\u30a9\u30eb\u30c8\u3067\u306fOverall Rating\u304cC\u3068\u3001\u305d\u308c\u307b\u3069\u30bb\u30ad\u30e5\u30a2\u3067\u306f\u306a\u3055\u305d\u3046\u3067\u3059\u3002\n\nLighttpd\u306e\u30bb\u30ad\u30e5\u30a2\u306aSSL\u306e\u8a2d\u5b9a\nStong SSL Security on lighttpd\u3092\u53c2\u8003\u306b\u8a2d\u5b9a\u3092\u3044\u3058\u308a\u307e\u3059\u3002\n\n/etc/lighttpd/conf-available/10-ssl.conf\n# /usr/share/doc/lighttpd/ssl.txt\n\n$SERVER[\"socket\"] == \"0.0.0.0:443\" {\n        ssl.engine  = \"enable\"\n        ssl.pemfile = \"/etc/lighttpd/ssl/combined.pem\"\n        ssl.ca-file = \"/etc/lighttpd/ssl/chain.pem\"\n\n        ssl.cipher-list = \"EECDH+AESGCM:EDH+AESGCM:AES128+EECDH:AES128+EDH\"  # \u5909\u66f4\n        ssl.honor-cipher-order = \"enable\"\n        ssl.use-sslv2          = \"disable\"  # \u8ffd\u52a0\n        ssl.use-sslv3          = \"disable\"  # \u8ffd\u52a0\n}\n\n\n\u3053\u306e\u74b0\u5883\u3067\u306fSSL Compression\u306f\u7121\u52b9\u5316\u3055\u308c\u3066\u3044\u308b\u306e\u3088\u3046\u306a\u306e\u3067\u3001ssl.use-compression    = \"disable\"\u306f\u5fc5\u8981\u3042\u308a\u307e\u305b\u3093(\u3042\u3063\u3066\u3082\u3001WARNING: unknown config-key: ssl.use-compression (ignored)\u3068\u30ed\u30b0\u306b\u6b8b\u308b\u3060\u3051\u3067\u7279\u306b\u554f\u984c\u306a\u3055\u305d\u3046\u3067\u3059)\u3002\n\n\u3053\u308c\u3067Overall Rating\u304cB\u306b\u306a\u308a\u307e\u3057\u305f\u3002\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u898b\u308b\u3068\u3001Diffie-Hellman (DH) key exchange parameters\u306e\u305b\u3044\u3067B\u6b62\u307e\u308a\u306b\u306a\u3063\u3066\u3044\u308b\u3088\u3046\u306a\u306e\u3067\u3001\u3053\u308c\u3082\u8a2d\u5b9a\u3057\u3066\u307f\u307e\u3059\u3002\n$ sudo openssl dhparam -out /etc/lighttpd/ssl/dhparams.pem 4096\nGenerating DH parameters, 4096 bit long safe prime, generator 2\nThis is going to take a long time\n...\n$ sudo chmod 600 /etc/lighttpd/ssl/dhparams.pem\n\n\n/etc/lighttpd/conf-available/10-ssl.conf\n# /usr/share/doc/lighttpd/ssl.txt\n\n$SERVER[\"socket\"] == \"0.0.0.0:443\" {\n        ssl.engine  = \"enable\"\n        ssl.pemfile = \"/etc/lighttpd/ssl/combined.pem\"\n        ssl.ca-file = \"/etc/lighttpd/ssl/chain.pem\"\n        ssl.dh-file = \"/etc/lighttpd/ssl/dhparams.pem\"  # \u8ffd\u52a0\n        ssl.ec-curve = \"secp384r1\"                      # \u8ffd\u52a0\n\n        ssl.cipher-list = \"EECDH+AESGCM:EDH+AESGCM:AES128+EECDH:AES128+EDH\"\n        ssl.honor-cipher-order = \"enable\"\n        ssl.use-sslv2          = \"disable\"\n        ssl.use-sslv3          = \"disable\"\n}\n\n\n\n\u3053\u308c\u3067Overall Rating\u304cA\u306b\u306a\u308a\u307e\u3057\u305f\u3002\n\u3082\u3046\u4e00\u3064\u3001HTTP Strict Transport Security\u3082HTTP Strict Transport Security for Apache, NGINX and Lighttpd\u3092\u53c2\u8003\u306b\u6709\u52b9\u306b\u3057\u3066\u307f\u307e\u3059\u3002\u305d\u306e\u30da\u30fc\u30b8\u306b\u3042\u308b\u3088\u3046\u306b\u3001\u3064\u3044\u3067\u306bX-Frame-Options header\u3082\u8db3\u3057\u3066\u304a\u304f\u3068\u826f\u3055\u305d\u3046\u3067\u3059\u3002\u6b21\u306e\u9805\u76ee\u3092/etc/lighttpd/lighttpd.conf\u306b\u8db3\u3057\u307e\u3059(X-Frame-Options\u306f\u5fc5\u8981\u306b\u5fdc\u3058\u3066DENY, SAMEORIGIN, ALLOW-FROM uri\u306e\u3044\u305a\u308c\u304b\u306b\u8a2d\u5b9a\u3057\u307e\u3059)\u3002\n\n/etc/lighttpd/lighttpd.conf\n...\nserver.modules += ( \"mod_setenv\" )\n$HTTP[\"scheme\"] == \"https\" {\n    setenv.add-response-header  = ( \"Strict-Transport-Security\" => \"max-age=63072000; includeSubdomains; preload\")\n    setenv.add-response-header  += ( \"X-Frame-Options\" => \"DENY\")\n}\n\n\n\n\u3053\u308c\u3067Overall Rating\u304cA+\u306b\u306a\u308a\u307e\u3057\u305f\u3002\n\nLet's Encrypt\u306e\u8a3c\u660e\u66f8\u306e\u66f4\u65b0\nLet's Encrypt\u306e\u8a3c\u660e\u66f8\u306f90\u65e5\u3067\u5931\u52b9\u3059\u308b\u306e\u30671\u3001\u5b9a\u671f\u7684\u306b\u66f4\u65b0\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\u8a3c\u660e\u66f8\u306e\u53d6\u5f97\u306fletsencrypt-auto certonly\u30b3\u30de\u30f3\u30c9\u3067\u884c\u3044\u307e\u3057\u305f\u304c\u3001\u66f4\u65b0\u306fletsencrypt-auto renew\u30b3\u30de\u30f3\u30c9\u3067\u884c\u3044\u307e\u3059\u3002letsencrypt-auto\u306fcertonly\u3068renew\u3092\u5b9f\u884c\u3057\u305f\u969b\u306b\u8a2d\u5b9a\u3092/etc/letsencrypt/renewal/https.example.com.conf\u306b\u4fdd\u5b58\u3057\u3066\u3044\u3066\u3001\u30aa\u30d7\u30b7\u30e7\u30f3\u3092\u7701\u7565\u3059\u308b\u3068\u524d\u56de\u3068\u540c\u3058\u8a2d\u5b9a\u3067\u5b9f\u884c\u3057\u3066\u304f\u308c\u307e\u3059\u3002\n\u8a66\u3057\u306b--dry-run\u3067\u66f4\u65b0\u306e\u30c6\u30b9\u30c8\u3092\u3084\u3063\u3066\u307f\u307e\u3059\u3002\n$ ./letsencrypt-auto renew --agree-tos --email z80@example.com --dry-run\nChecking for new version...\nRequesting root privileges to run letsencrypt...\n   sudo /home/z80/.local/share/letsencrypt/bin/letsencrypt --no-self-upgrade renew --agree-tos --email \nz80@example.com --dry-run\nProcessing /etc/letsencrypt/renewal/https.example.com.conf\n** DRY RUN: simulating 'letsencrypt renew' close to cert expiry\n**          (The test certificates below have not been saved.)\nCongratulations, all renewals succeeded. The following certs have been renewed:\n  /etc/letsencrypt/live/https.example.com/fullchain.pem (success)\n** DRY RUN: simulating 'letsencrypt renew' close to cert expiry\n**          (The test certificates above have not been saved.)\n\n\u3069\u3046\u3084\u3089\u554f\u984c\u306a\u3055\u305d\u3046\u3067\u3059\u3002\u3042\u3068\u306f\u3001\u5b9a\u671f\u7684\u306b\u8a3c\u660e\u66f8\u3092\u66f4\u65b0\u3057\u3066\u3044\u3051\u3070OK\u3067\u3057\u3087\u3046\u3002cron\u306e\u8a2d\u5b9a\u306f\u3053\u3093\u306a\u611f\u3058\u306b\u3057\u3066\u307f\u307e\u3059\u3002\n\n/home/z80/letsencrypt-renew.sh\n#!/bin/sh\n\nDOMAIN=\"https.example.com\"\nEMAIL=\"z80@example.com\"\n\nif /home/z80/letsencrypt/letsencrypt-auto renew --agree-tos --email $EMAIL ; \nthen\n  echo \"Let's encrypt renewal succeeded.\"\n  sudo sh -c \"cat /etc/letsencrypt/live/$DOMAIN/privkey.pem /etc/letsencrypt/live/$DOMAIN/cert.pem > /etc/lighttpd/ssl/c\nombined.pem\"\n  sudo sh -c \"cat /etc/letsencrypt/live/$DOMAIN/chain.pem > /etc/lighttpd/ssl/chain.pem\"\n  sudo service lighttpd force-reload\nelse\n  echo \"Let's encrypt renewal failed.\"\n  exit 1\nfi\n\n\n\ncrontab\nMAILTO=z80@example.com\n0 0 1 * * /home/z80/letsencrypt-renew.sh 2>&1\n\n\n\u3061\u306a\u307f\u306b\u3001Google Compute Engine\u4e0a\u3067\u306f\u3001crontab\u3067MAILTO\u3092\u4f7f\u3046\u5834\u5408\u3001Sending Email from an Instance\u306b\u5f93\u3063\u3066\u3054\u306b\u3087\u3054\u306b\u3087\u8a2d\u5b9a\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\n\u307e\u3068\u3081\nLighttpd\u306bLet's Encrypt\u306e\u8a3c\u660e\u66f8\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3066https\u3092\u6709\u52b9\u306b\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3057\u305f\u3002\u672c\u5f53\u306f\u3082\u3046\u5c11\u3057\u3061\u3083\u3093\u3068\u8abf\u3079\u3066\u7406\u89e3\u3057\u3066\u304b\u3089\u8a2d\u5b9a\u3059\u308b\u3079\u304d\u3082\u306e\u306a\u3093\u3067\u3057\u3087\u3046\u304c\u3001Qualys SSL Labs\u306eSSL Server Test\u306e\u304a\u304b\u3052\u3067\u30b5\u30af\u30c3\u3068\u554f\u984c\u70b9\u3084\u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u306e\u5f37\u5ea6\u3092\u78ba\u8a8d\u3067\u304d\u308b\u306e\u306f\u975e\u5e38\u306b\u52a9\u304b\u308a\u307e\u3057\u305f\u3002\n\n\u53c2\u8003\nLet's Encrypt\u306b\u3064\u3044\u3066\n\nhttps://letsencrypt.org/\nhttps://github.com/letsencrypt/letsencrypt\nhttps://letsencrypt.readthedocs.org\nLet's Encrypt \u3092\u652f\u3048\u308b ACME \u30d7\u30ed\u30c8\u30b3\u30eb\n\nLighttpd\u306eSSL\u306b\u3064\u3044\u3066\n\nLighttpd SSL Documentation\nStong SSL Security on lighttpd\nGuide to Deploying Diffie-Hellman for TLS\n\nLighttpd\u3068Let's Encrypt\u306b\u3064\u3044\u3066\n\nSetting Up Let's Encrypt With Lighttpd\nSetting up LetsEncrypt with Lighttpd\n\n\n\n\n\nWhy ninety-day lifetimes for certificates? \u00a0\u21a9\n\n\n\nGoogle [Compute Engine](https://cloud.google.com/compute/)\u4e0a\u3067[Ubuntu](http://www.ubuntu.com/)\u306e[Lighttpd](https://www.lighttpd.net/)\u306b[Let's Encrypt](https://letsencrypt.org/)\u306e\u8a3c\u660e\u66f8\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3066https\u3092\u6709\u52b9\u306b\u3057\u3066\u307f\u307e\u3059\u3002\u57fa\u672c\u7684\u306b\u81ea\u5206\u7528\u306e\u5099\u5fd8\u9332\u3067\u3059\u3002\n\n# \u74b0\u5883\n\n- [Google Cloud Platform](https://cloud.google.com/)\n- [Ubuntu LTS](https://wiki.ubuntu.com/LTS) 14.04 LTS\n- [Lighttpd](https://www.lighttpd.net/)\n\n# GCE\u306eVM\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u8d77\u52d5\n\n[Machine type](https://cloud.google.com/compute/docs/machine-types)\u306f\u3068\u308a\u3042\u3048\u305a`f1-micro`\u3092\u9078\u629e\u3001[OS](https://cloud.google.com/compute/docs/operating-systems/)\u306f`ubuntu-14-04`\u3092\u9078\u629e\u3001Firewall\u306e\u8a2d\u5b9a\u306eAllow HTTP traffic\u3068Allow HTTPS traffic\u3092\u30c1\u30a7\u30c3\u30af\u3057\u3066\u8d77\u52d5\u3057\u307e\u3059\u3002\n\n# Lighttpd\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n```bash\n$ sudo timedatectl set-timezone America/Los_Angeles\n$ sudo apt-get update\n$ sudo apt-get install git\n$ sudo apt-get install lighttpd\n```\n\n\u3053\u306e\u6642\u70b9\u3067\u306f\u3001\u30d6\u30e9\u30a6\u30b6\u304b\u3089http\u3067\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3068\u30c7\u30d5\u30a9\u30eb\u30c8\u306e\u30da\u30fc\u30b8\u304c\u8868\u793a\u3055\u308c\u307e\u3059\u304c\u3001https\u3067\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3068\u63a5\u7d9a\u3067\u304d\u307e\u305b\u3093\u3002\n\n# Let's Encrypt\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n```bash\n$ git clone https://github.com/letsencrypt/letsencrypt\nCloning into 'letsencrypt'...\nremote: Counting objects: 31405, done.\nremote: Compressing objects: 100% (255/255), done.\nremote: Total 31405 (delta 159), reused 0 (delta 0), pack-reused 31150\nReceiving objects: 100% (31405/31405), 8.28 MiB | 15.55 MiB/s, done.\nResolving deltas: 100% (22200/22200), done.\nChecking connectivity... done.\n$ cd letsencrypt\n$ ./letsencrypt-auto --help\nBootstrapping dependencies for Debian-based OSes...\n...\n```\n\n`letsencrypt-auto`\u306e\u521d\u56de\u8d77\u52d5\u6642\u306f\u5fc5\u8981\u306a\u30d1\u30c3\u30b1\u30fc\u30b8\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u306e\u306b\u5c11\u3057\u6642\u9593\u304c\u304b\u304b\u308a\u307e\u3059\u3002\n\n# Let's Encrypt\u304b\u3089\u8a3c\u660e\u66f8\u3092\u53d6\u5f97\n\n\u4ee5\u4e0b\u3001\u81ea\u5206\u306e\u30c9\u30e1\u30a4\u30f3\u3092https.example.com\u3068\u3057\u307e\u3059\u3002\n\nLet's Encrypt\u306e[Technology Overview](https://letsencrypt.org/howitworks/technology/)\u306b\u3042\u308b\u3088\u3046\u306b\u3001\u8a3c\u660e\u66f8\u3092\u767a\u884c\u3059\u308b\u524d\u306bDomain Validation\u3092\u884c\u3044\u307e\u3059\u3002\u3053\u308c\u306f\u3001https.example.com\u306e\u8a3c\u660e\u66f8\u3092\u30ea\u30af\u30a8\u30b9\u30c8\u3059\u308bLet's Encrypt\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u304c\u305d\u306e\u30c9\u30e1\u30a4\u30f3\u3092\u7ba1\u7406\u3057\u3066\u3044\u308b\u3053\u3068\u3092\u8a3c\u660e\u3057\u306a\u3051\u308c\u3070\u306a\u308a\u307e\u305b\u3093\u3002[Let's Encrypt\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u306e\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8](https://letsencrypt.readthedocs.org)\u306e[Plugins](https://letsencrypt.readthedocs.org/en/latest/using.html#plugins)\u306e\u3068\u3053\u308d\u306b\u3044\u304f\u3064\u304b\u65b9\u6cd5\u304c\u3042\u308a\u307e\u3059\u304c\u3001Lighttpd\u306e\u5834\u5408\u306fwebroot\u304c\u7c21\u5358\u305d\u3046\u3067\u3059\u3002\n\n```bash\n$ ./letsencrypt-auto certonly --agree-tos --email z80@example.com --webroot --webroot-path /var/www -d https.example.com\nChecking for new version...\nRequesting root privileges to run letsencrypt...\n   sudo /home/z80/.local/share/letsencrypt/bin/letsencrypt --no-self-upgrade certonly --agree-tos --email z80@example.com --webroot --webroot-path /var/www -\nd https.example.com\nIMPORTANT NOTES:\n - Congratulations! Your certificate and chain have been saved at\n   /etc/letsencrypt/live/https.example.com/fullchain.pem. Your cert\n   will expire on 2016-05-14. To obtain a new version of the\n   certificate in the future, simply run Let's Encrypt again.\n```\n\n\u3053\u308c\u3067\u3001`/etc/letsencrypt/live/https.example.com/`\u306b`cert.pem`, `chain.pem`, `fullchain.pem`, `privkey.pem`\u304c\u751f\u6210\u3055\u308c\u307e\u3057\u305f\u3002\n\n# Lighttpd\u306eSSL\u306e\u8a2d\u5b9a\n\n\u8a3c\u660e\u66f8\u306f\u3069\u3053\u306b\u7f6e\u3044\u3066\u3082\u3044\u3044\u306e\u3067\u3059\u304c\u3001\u3053\u3053\u3067\u306f`/etc/lighttpd/ssl`\u306b\u7f6e\u304f\u3053\u3068\u306b\u3057\u307e\u3059\u3002[Lighttpd SSL Documentation\u306ePermissions](https://redmine.lighttpd.net/projects/lighttpd/wiki/Docs_SSL#Permissions)\u306b\u3088\u308b\u3068\n\n> Lighttpd reads all pemfiles at startup, before dropping privileges. It is therefore best to make the pem file owned by root and readable by root only\n\n\u3068\u3044\u3046\u3053\u3068\u306a\u306e\u3067\u3001root\u3060\u3051\u304c\u8aad\u3081\u308b\u3088\u3046\u306b\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\n```bash\n$ sudo mkdir /etc/lighttpd/ssl\n$ sudo chmod 700 /etc/lighttpd/ssl\n$ sudo sh -c \"cat /etc/letsencrypt/live/https.example.com/privkey.pem /etc/letsencrypt/live/https.example.com/cert.pem > /etc/lighttpd/ssl/combined.pem\"\n$ sudo sh -c \"cat /etc/letsencrypt/live/https.example.com/chain.pem > /etc/lighttpd/ssl/chain.pem\"\n```\n\nLighttpd\u306eSSL\u306e\u8a2d\u5b9a\u3092\u5909\u66f4\u3057\u307e\u3059\u3002\n\n```:/etc/lighttpd/conf-available/10-ssl.conf\n# /usr/share/doc/lighttpd/ssl.txt\n\n$SERVER[\"socket\"] == \"0.0.0.0:443\" {\n        ssl.engine  = \"enable\"\n        ssl.pemfile = \"/etc/lighttpd/ssl/combined.pem\"  # \u5909\u66f4\n        ssl.ca-file = \"/etc/lighttpd/ssl/chain.pem\"     # \u8ffd\u52a0\n\n        ssl.cipher-list = \"ECDHE-RSA-AES256-SHA384:AES256-SHA256:RC4:HIGH:!MD5:!aNULL:!EDH:!AESGCM\"\n        ssl.honor-cipher-order = \"enable\"\n}\n```\n\nSSL\u3092\u6709\u52b9\u306b\u3057\u3066Lighttpd\u3092\u518d\u8d77\u52d5\u3057\u307e\u3059\u3002\n\n```bash\n$ sudo lighttpd-enable-mod ssl\nEnabling ssl: ok\nRun /etc/init.d/lighttpd force-reload to enable changes\n$ sudo service lighttpd force-reload\n * Reloading web server configuration lighttpd                           [ OK ] \n```\n\n\u30d6\u30e9\u30a6\u30b6\u304b\u3089https\u3067\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3068(\u7d30\u304b\u3044\u554f\u984c\u306f\u3042\u308a\u307e\u3059\u304c)\u6709\u52b9\u306b\u306a\u3063\u3066\u3044\u308b\u3088\u3046\u3067\u3059\u3002\n\n![HTTPS0.jpg](https://qiita-image-store.s3.amazonaws.com/0/109559/40be5c86-83d0-1efc-842f-e3e7b6fea49f.jpeg)\n\n\u8a66\u3057\u306bQualys SSL Labs\u306e[SSL Server Test](https://www.ssllabs.com/ssltest/)\u3092\u3084\u3063\u3066\u307f\u307e\u3059\u3002\n\n![HTTPS1.jpg](https://qiita-image-store.s3.amazonaws.com/0/109559/8b10d8bb-f020-c1b8-f431-2c6c49192f96.jpeg)\n\n\u30c7\u30d5\u30a9\u30eb\u30c8\u3067\u306fOverall Rating\u304cC\u3068\u3001\u305d\u308c\u307b\u3069\u30bb\u30ad\u30e5\u30a2\u3067\u306f\u306a\u3055\u305d\u3046\u3067\u3059\u3002\n\n# Lighttpd\u306e\u30bb\u30ad\u30e5\u30a2\u306aSSL\u306e\u8a2d\u5b9a\n\n[Stong SSL Security on lighttpd](https://raymii.org/s/tutorials/Strong_SSL_Security_On_lighttpd.html)\u3092\u53c2\u8003\u306b\u8a2d\u5b9a\u3092\u3044\u3058\u308a\u307e\u3059\u3002\n\n```:/etc/lighttpd/conf-available/10-ssl.conf\n# /usr/share/doc/lighttpd/ssl.txt\n\n$SERVER[\"socket\"] == \"0.0.0.0:443\" {\n        ssl.engine  = \"enable\"\n        ssl.pemfile = \"/etc/lighttpd/ssl/combined.pem\"\n        ssl.ca-file = \"/etc/lighttpd/ssl/chain.pem\"\n\n        ssl.cipher-list = \"EECDH+AESGCM:EDH+AESGCM:AES128+EECDH:AES128+EDH\"  # \u5909\u66f4\n        ssl.honor-cipher-order = \"enable\"\n        ssl.use-sslv2          = \"disable\"  # \u8ffd\u52a0\n        ssl.use-sslv3          = \"disable\"  # \u8ffd\u52a0\n}\n```\n\n\u3053\u306e\u74b0\u5883\u3067\u306fSSL Compression\u306f\u7121\u52b9\u5316\u3055\u308c\u3066\u3044\u308b\u306e\u3088\u3046\u306a\u306e\u3067\u3001`ssl.use-compression    = \"disable\"`\u306f\u5fc5\u8981\u3042\u308a\u307e\u305b\u3093(\u3042\u3063\u3066\u3082\u3001`WARNING: unknown config-key: ssl.use-compression (ignored)`\u3068\u30ed\u30b0\u306b\u6b8b\u308b\u3060\u3051\u3067\u7279\u306b\u554f\u984c\u306a\u3055\u305d\u3046\u3067\u3059)\u3002\n\n![HTTPS2.jpg](https://qiita-image-store.s3.amazonaws.com/0/109559/53f6029e-29cb-5157-93f6-fbb6b706422e.jpeg)\n\n\u3053\u308c\u3067Overall Rating\u304cB\u306b\u306a\u308a\u307e\u3057\u305f\u3002\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u898b\u308b\u3068\u3001Diffie-Hellman (DH) key exchange parameters\u306e\u305b\u3044\u3067B\u6b62\u307e\u308a\u306b\u306a\u3063\u3066\u3044\u308b\u3088\u3046\u306a\u306e\u3067\u3001\u3053\u308c\u3082\u8a2d\u5b9a\u3057\u3066\u307f\u307e\u3059\u3002\n\n```bash\n$ sudo openssl dhparam -out /etc/lighttpd/ssl/dhparams.pem 4096\nGenerating DH parameters, 4096 bit long safe prime, generator 2\nThis is going to take a long time\n...\n$ sudo chmod 600 /etc/lighttpd/ssl/dhparams.pem\n```\n\n```:/etc/lighttpd/conf-available/10-ssl.conf\n# /usr/share/doc/lighttpd/ssl.txt\n\n$SERVER[\"socket\"] == \"0.0.0.0:443\" {\n        ssl.engine  = \"enable\"\n        ssl.pemfile = \"/etc/lighttpd/ssl/combined.pem\"\n        ssl.ca-file = \"/etc/lighttpd/ssl/chain.pem\"\n        ssl.dh-file = \"/etc/lighttpd/ssl/dhparams.pem\"  # \u8ffd\u52a0\n        ssl.ec-curve = \"secp384r1\"                      # \u8ffd\u52a0\n\n        ssl.cipher-list = \"EECDH+AESGCM:EDH+AESGCM:AES128+EECDH:AES128+EDH\"\n        ssl.honor-cipher-order = \"enable\"\n        ssl.use-sslv2          = \"disable\"\n        ssl.use-sslv3          = \"disable\"\n}\n```\n\n![HTTPS3.jpg](https://qiita-image-store.s3.amazonaws.com/0/109559/51eb57d3-44ce-196b-be9e-da8d2b7f7a8a.jpeg)\n\n\u3053\u308c\u3067Overall Rating\u304cA\u306b\u306a\u308a\u307e\u3057\u305f\u3002\n\n\u3082\u3046\u4e00\u3064\u3001HTTP Strict Transport Security\u3082[HTTP Strict Transport Security for Apache, NGINX and Lighttpd](https://raymii.org/s/tutorials/HTTP_Strict_Transport_Security_for_Apache_NGINX_and_Lighttpd.html)\u3092\u53c2\u8003\u306b\u6709\u52b9\u306b\u3057\u3066\u307f\u307e\u3059\u3002\u305d\u306e\u30da\u30fc\u30b8\u306b\u3042\u308b\u3088\u3046\u306b\u3001\u3064\u3044\u3067\u306bX-Frame-Options header\u3082\u8db3\u3057\u3066\u304a\u304f\u3068\u826f\u3055\u305d\u3046\u3067\u3059\u3002\u6b21\u306e\u9805\u76ee\u3092`/etc/lighttpd/lighttpd.conf`\u306b\u8db3\u3057\u307e\u3059(X-Frame-Options\u306f\u5fc5\u8981\u306b\u5fdc\u3058\u3066DENY, SAMEORIGIN, ALLOW-FROM uri\u306e\u3044\u305a\u308c\u304b\u306b\u8a2d\u5b9a\u3057\u307e\u3059)\u3002\n\n```:/etc/lighttpd/lighttpd.conf\n...\nserver.modules += ( \"mod_setenv\" )\n$HTTP[\"scheme\"] == \"https\" {\n    setenv.add-response-header  = ( \"Strict-Transport-Security\" => \"max-age=63072000; includeSubdomains; preload\")\n    setenv.add-response-header  += ( \"X-Frame-Options\" => \"DENY\")\n}\n```\n\n![HTTPS4.jpg](https://qiita-image-store.s3.amazonaws.com/0/109559/3e4d5588-5cab-b574-084a-2793977d9ae6.jpeg)\n\n\u3053\u308c\u3067Overall Rating\u304cA+\u306b\u306a\u308a\u307e\u3057\u305f\u3002\n\n# Let's Encrypt\u306e\u8a3c\u660e\u66f8\u306e\u66f4\u65b0\n\nLet's Encrypt\u306e\u8a3c\u660e\u66f8\u306f90\u65e5\u3067\u5931\u52b9\u3059\u308b\u306e\u3067[^1]\u3001\u5b9a\u671f\u7684\u306b\u66f4\u65b0\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\u8a3c\u660e\u66f8\u306e\u53d6\u5f97\u306f`letsencrypt-auto certonly`\u30b3\u30de\u30f3\u30c9\u3067\u884c\u3044\u307e\u3057\u305f\u304c\u3001\u66f4\u65b0\u306f`letsencrypt-auto renew`\u30b3\u30de\u30f3\u30c9\u3067\u884c\u3044\u307e\u3059\u3002`letsencrypt-auto`\u306f`certonly`\u3068`renew`\u3092\u5b9f\u884c\u3057\u305f\u969b\u306b\u8a2d\u5b9a\u3092`/etc/letsencrypt/renewal/https.example.com.conf`\u306b\u4fdd\u5b58\u3057\u3066\u3044\u3066\u3001\u30aa\u30d7\u30b7\u30e7\u30f3\u3092\u7701\u7565\u3059\u308b\u3068\u524d\u56de\u3068\u540c\u3058\u8a2d\u5b9a\u3067\u5b9f\u884c\u3057\u3066\u304f\u308c\u307e\u3059\u3002\n\u8a66\u3057\u306b`--dry-run`\u3067\u66f4\u65b0\u306e\u30c6\u30b9\u30c8\u3092\u3084\u3063\u3066\u307f\u307e\u3059\u3002\n\n[^1]: [Why ninety-day lifetimes for certificates?](https://letsencrypt.org//2015/11/09/why-90-days.html) \n\n```bash\n$ ./letsencrypt-auto renew --agree-tos --email z80@example.com --dry-run\nChecking for new version...\nRequesting root privileges to run letsencrypt...\n   sudo /home/z80/.local/share/letsencrypt/bin/letsencrypt --no-self-upgrade renew --agree-tos --email \nz80@example.com --dry-run\nProcessing /etc/letsencrypt/renewal/https.example.com.conf\n** DRY RUN: simulating 'letsencrypt renew' close to cert expiry\n**          (The test certificates below have not been saved.)\nCongratulations, all renewals succeeded. The following certs have been renewed:\n  /etc/letsencrypt/live/https.example.com/fullchain.pem (success)\n** DRY RUN: simulating 'letsencrypt renew' close to cert expiry\n**          (The test certificates above have not been saved.)\n```\n\n\u3069\u3046\u3084\u3089\u554f\u984c\u306a\u3055\u305d\u3046\u3067\u3059\u3002\u3042\u3068\u306f\u3001\u5b9a\u671f\u7684\u306b\u8a3c\u660e\u66f8\u3092\u66f4\u65b0\u3057\u3066\u3044\u3051\u3070OK\u3067\u3057\u3087\u3046\u3002cron\u306e\u8a2d\u5b9a\u306f\u3053\u3093\u306a\u611f\u3058\u306b\u3057\u3066\u307f\u307e\u3059\u3002\n\n```bash:/home/z80/letsencrypt-renew.sh\n#!/bin/sh\n\nDOMAIN=\"https.example.com\"\nEMAIL=\"z80@example.com\"\n\nif /home/z80/letsencrypt/letsencrypt-auto renew --agree-tos --email $EMAIL ; \nthen\n  echo \"Let's encrypt renewal succeeded.\"\n  sudo sh -c \"cat /etc/letsencrypt/live/$DOMAIN/privkey.pem /etc/letsencrypt/live/$DOMAIN/cert.pem > /etc/lighttpd/ssl/c\nombined.pem\"\n  sudo sh -c \"cat /etc/letsencrypt/live/$DOMAIN/chain.pem > /etc/lighttpd/ssl/chain.pem\"\n  sudo service lighttpd force-reload\nelse\n  echo \"Let's encrypt renewal failed.\"\n  exit 1\nfi\n```\n\n```:crontab\nMAILTO=z80@example.com\n0 0 1 * * /home/z80/letsencrypt-renew.sh 2>&1\n```\n\n\u3061\u306a\u307f\u306b\u3001Google Compute Engine\u4e0a\u3067\u306f\u3001`crontab`\u3067`MAILTO`\u3092\u4f7f\u3046\u5834\u5408\u3001[Sending Email from an Instance](https://cloud.google.com/compute/docs/tutorials/sending-mail/)\u306b\u5f93\u3063\u3066\u3054\u306b\u3087\u3054\u306b\u3087\u8a2d\u5b9a\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\n# \u307e\u3068\u3081\n\nLighttpd\u306bLet's Encrypt\u306e\u8a3c\u660e\u66f8\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3066https\u3092\u6709\u52b9\u306b\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3057\u305f\u3002\u672c\u5f53\u306f\u3082\u3046\u5c11\u3057\u3061\u3083\u3093\u3068\u8abf\u3079\u3066\u7406\u89e3\u3057\u3066\u304b\u3089\u8a2d\u5b9a\u3059\u308b\u3079\u304d\u3082\u306e\u306a\u3093\u3067\u3057\u3087\u3046\u304c\u3001Qualys SSL Labs\u306eSSL Server Test\u306e\u304a\u304b\u3052\u3067\u30b5\u30af\u30c3\u3068\u554f\u984c\u70b9\u3084\u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u306e\u5f37\u5ea6\u3092\u78ba\u8a8d\u3067\u304d\u308b\u306e\u306f\u975e\u5e38\u306b\u52a9\u304b\u308a\u307e\u3057\u305f\u3002\n\n# \u53c2\u8003\n\nLet's Encrypt\u306b\u3064\u3044\u3066\n\n- https://letsencrypt.org/\n- https://github.com/letsencrypt/letsencrypt\n- https://letsencrypt.readthedocs.org\n- [Let's Encrypt \u3092\u652f\u3048\u308b ACME \u30d7\u30ed\u30c8\u30b3\u30eb](http://jxck.hatenablog.com/entry/letsencrypt-acme)\n\nLighttpd\u306eSSL\u306b\u3064\u3044\u3066\n\n- [Lighttpd SSL Documentation](https://redmine.lighttpd.net/projects/1/wiki/Docs_SSL)\n- [Stong SSL Security on lighttpd](https://raymii.org/s/tutorials/Strong_SSL_Security_On_lighttpd.html)\n- [Guide to Deploying Diffie-Hellman for TLS](https://weakdh.org/sysadmin.html)\n\nLighttpd\u3068Let's Encrypt\u306b\u3064\u3044\u3066\n\n- [Setting Up Let's Encrypt With Lighttpd](https://www.mikeshultz.com/systems/2015/12/04/lets-encrypt-beta-with-lighttpd.html)\n- [Setting up LetsEncrypt with Lighttpd](https://nwgat.ninja/setting-up-letsencrypt-with-lighttpd/)\n", "tags": ["letsencrypt", "lighttpd", "HTTPS", "Ubuntu14.04", "GoogleCloudPlatform"]}