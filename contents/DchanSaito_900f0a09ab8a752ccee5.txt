{"context": "\n\n\u80cc\u666f\nRails\u3067CSV\u3092\u8fd4\u3059\u6642\u300110\u4e07\u30c7\u30fc\u30bf\u304f\u3089\u3044\u306e\u3082\u306e\u3092\u666e\u901a\u306b\u51e6\u7406\u3059\u308b\u3068\u30e1\u30e2\u30ea\u3092\u98df\u3044\u6f70\u3057\u305f\u308a\u3001\u51e6\u7406\u304c\u9045\u304b\u3063\u305f\u308a\u3059\u308b\u3002\n\u305d\u3053\u3067\u89e3\u6c7a\u7b56\u3092\u63a2\u3057\u3066\u3044\u305f\u3089\u3001Rust\u3067Rails\u306e\u4ee3\u308f\u308a\u306bCSV\u3092\u4f5c\u308b\u3068\u3044\u3046\u7d20\u6674\u3089\u3057\u3044\u8a18\u4e8b\u306b\u51fa\u4f1a\u3063\u305f\u3002\n\u3053\u306e\u8a18\u4e8b\u306fPostgres\u3084Nginx\u3092\u4f7f\u3063\u3066\u305f\u304c\u3001\u79c1\u306fMySQL\u3092\u4f7f\u3063\u3066\u304a\u308a\u3001Rails\u306e\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u5185\u3067\u5b8c\u7d50\u3057\u305f\u304b\u3063\u305f\u306e\u3067\u3001\u53c2\u8003\u306b\u3057\u306a\u304c\u3089\u8a66\u9a13\u7684\u306b\u4f5c\u3063\u3066\u898b\u305f\u3002\n\n\u304a\u65ad\u308a\nRails\u3092\u3059\u3067\u306b\u7406\u89e3\u3057\u3066\u3044\u308b\u3053\u3068\u3092\u524d\u63d0\u306b\u9032\u3081\u307e\u3059\u3002\n\u521d\u5fc3\u8005\u306e\u65b9\u3078\u74b0\u5883\u69cb\u7bc9\u5468\u308a\u3092\u6700\u5f8c\u306e\u65b9\u306b\u304a\u307e\u3051\u3068\u3057\u3066\u66f8\u3044\u3066\u304a\u304d\u307e\u3059\u306e\u3067\u53c2\u8003\u306b\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\u7b46\u8005\u306fRust\u521d\u5fc3\u8005\u3067\u3059\u306e\u3067\u30a2\u30c9\u30d0\u30a4\u30b9\u3092\u9802\u3051\u308b\u3068\u3068\u3066\u3082\u52a9\u304b\u308a\u307e\u3059\u3002\n\n\u74b0\u5883\n\nRuby 2.3.3\nRust 1.14.0\nRails 5.0.1\n\nGemfile\u306f\u57fa\u672c\u30c7\u30d5\u30a9\u30eb\u30c8\n\nGemfile\nsource 'https://rubygems.org'\n\ngit_source(:github) do |repo_name|\n  repo_name = \"#{repo_name}/#{repo_name}\" unless repo_name.include?(\"/\")\n  \"https://github.com/#{repo_name}.git\"\nend\n\n\ngem 'rails', '~> 5.0.1'\ngem 'mysql2', '>= 0.3.18', '< 0.5'\ngem 'puma', '~> 3.0'\ngem 'sass-rails', '~> 5.0'\ngem 'uglifier', '>= 1.3.0'\ngem 'coffee-rails', '~> 4.2'\n\ngem 'jquery-rails'\ngem 'turbolinks', '~> 5'\ngem 'jbuilder', '~> 2.5'\n\ngem 'ffi'\n\ngroup :development, :test do\n  gem 'byebug', platform: :mri\nend\n\ngroup :development do\n  gem 'web-console', '>= 3.3.0'\n  gem 'listen', '~> 3.0.5'\n  gem 'spring'\n  gem 'spring-watcher-listen', '~> 2.0.0'\nend\n\ngem 'tzinfo-data', platforms: [:mingw, :mswin, :x64_mingw, :jruby]\n\n\ncargo\u306e\u8a2d\u5b9a\u306f\u4ee5\u4e0b\u306e\u901a\u308a\uff08CSV\u30af\u30ec\u30fc\u30c8\u3092\u4f7f\u3063\u305f\u30d0\u30fc\u30b8\u30e7\u30f3\u306f\u6700\u5f8c\u306e\u65b9\u306b\u3042\u308b\u8ffd\u8a18\u3092\u53c2\u8003\u306b\u3057\u3066\u304f\u3060\u3055\u3044)\n\nCargo.toml\n[dependencies]\nmysql = \"9.0.1\"\nlibc = \"0.2.0\"\n\n[lib]\nname = \"csv\"\ncrate-type = [\"dylib\"]\n\n\n\nRails\u5074\u306e\u8a2d\u5b9a\nbundle exec rails new . -BTf -d mysql \u3067new\u3057\u305f\u6642\u306e\u8a2d\u5b9a\u3068\u3059\u308b\u3002\n\n\u30c7\u30fc\u30bf\u306e\u4f5c\u6210\nbundle exec rails g model csv_tests \u3067Model\u3092\u4f5c\u6210\u3002\nmigration\u30d5\u30a1\u30a4\u30eb\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u3059\u308b\u3002\n\n2017__create_csv_tests.rb\nclass CreateCsvTests < ActiveRecord::Migration[5.0]\n  def change\n    create_table :csv_tests do |t|\n      t.string :name\n      t.string :hoge\n      t.string :foo\n      t.string :hogefoo\n      t.string :hogehoge\n      t.string :foofoo\n      t.string :namehoge\n      t.string :namefoo\n      t.string :namehogefoo\n      t.string :namehogehoge\n      t.string :namefoofoo\n\n      t.timestamps\n    end\n  end\nend\n\n\n\u30c7\u30fc\u30bf\u3092\u5165\u308c\u308b\u305f\u3081\u3002seeds.rb\u30d5\u30a1\u30a4\u30eb\u3092\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u3059\u308b\u3002\n\ndb/seeds.rb\n500_000.times do |i|\n  t = CsvTest.new\n  t.name = (1...100).map{ (65 + rand(26)).chr }.join\n  t.hoge = (1...100).map{ (65 + rand(26)).chr }.join\n  t.foo = (1...100).map{ (65 + rand(26)).chr }.join\n  t.hogefoo = (1...100).map{ (65 + rand(26)).chr }.join\n  t.hogehoge = (1...100).map{ (65 + rand(26)).chr }.join\n  t.foofoo = (1...100).map{ (65 + rand(26)).chr }.join\n  t.namehoge = (1...100).map{ (65 + rand(26)).chr }.join\n  t.namefoo = (1...100).map{ (65 + rand(26)).chr }.join\n  t.namehogefoo = (1...100).map{ (65 + rand(26)).chr }.join\n  t.namehogehoge = (1...100).map{ (65 + rand(26)).chr }.join\n  t.namefoofoo = (1...100).map{ (65 + rand(26)).chr }.join\n  t.save!\n  if(i % 1000 == 0)\n    puts \"#{i}\u500b\u4fdd\u5b58\u5b8c\u4e86\"\n  end\nend\n\n\n\u30e9\u30f3\u30c0\u30e0\u306a\u6587\u5b57\u5217\u3092\u4f5c\u308b\u969b\u3001Ruby\u3067\u30e9\u30f3\u30c0\u30e0\u306a\u6587\u5b57\u5217\u3092\u751f\u6210\u3059\u308b\u65b9\u6cd5\u3092\u53c2\u8003\u306b\u3057\u307e\u3057\u305f\u3002\n\u6700\u5f8c\u306bDB\u306e\u63a5\u7d9a\u8a2d\u5b9a\u3092\u4fee\u6b63\u3059\u308b\u3002\n\nconfig/database.yml\ndefault: &default\n  adapter: mysql2\n  encoding: utf8\n  pool: 5\n  username: root\n  password:\n  socket: /tmp/mysql.sock\n\ndevelopment:\n  <<: *default\n  database: csv_test_development\n\n\n\u3053\u3053\u307e\u3067\u8a2d\u5b9a\u3057\u305f\u3089\u4ee5\u4e0b\u306e\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3059\u308b\u3002\n$ bundle exec rails db:create\n$ bundle exec rails db:migrate\n$ bundle exec rails db:seed\n# seed\u306f50\u4e07\u4ef6\u306e\u30c7\u30fc\u30bf\u3092\u5165\u308c\u8fbc\u3080\u306e\u3067\u304b\u306a\u308a\u6642\u9593\u304c\u304b\u304b\u308b\n\n\n\u30eb\u30fc\u30c6\u30a3\u30f3\u30b0\u304b\u3089\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u306e\u8a2d\u5b9a\n\u30eb\u30fc\u30c6\u30a3\u30f3\u30b0\u306e\u8a2d\u5b9a\u306f\n\nconfig/routes.rb\nRails.application.routes.draw do\n  root to: 'csv#index'\n  get :ruby, to: 'csv#ruby'\n  get :rust, to: 'csv#rust'\nend\n\n\n\u6b21\u306b\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u306e\u8a2d\u5b9a\u3092\u3059\u308b\u3002\n\napp/controllers/csv_controller.rb\nrequire 'csv'\nrequire 'ffi'\n\nclass CsvController < ApplicationController\n  def index\n  end\n\n  def ruby\n    start_time = Time.now\n\n    ruby_csv = CSV.generate do |csv|\n      data_column = CsvTest.column_names\n      data_column.delete(\"created_at\")\n      data_column.delete(\"updated_at\")\n      csv << data_column\n      CsvTest.all.each do |data|\n        csv << data.attributes.values_at(*data_column)\n      end\n    end\n\n    puts '------------------------------------------------------------'\n    puts '\u51e6\u7406\u306b\u304b\u304b\u3063\u305f\u6642\u9593'\n    puts Time.now - start_time\n    puts '------------------------------------------------------------'\n\n    respond_to do |format|\n      format.csv { send_data ruby_csv }\n    end\n  end\n\n  module CSVmaker\n    extend FFI::Library\n    ffi_lib Rails.root + 'rust/target/release/libcsv.dylib'\n    attach_function :make_csv, [], :string\n  end\n\n  def rust\n    start_time = Time.now\n\n    rust_csv = CSVmaker.make_csv\n\n    puts '------------------------------------------------------------'\n    puts '\u51e6\u7406\u306b\u304b\u304b\u3063\u305f\u6642\u9593'\n    puts Time.now - start_time\n    puts '------------------------------------------------------------'\n\n    respond_to do |format|\n      format.csv { send_data rust_csv }\n    end\n  end\nend\n\n\n\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u5185\u3067require\u3084module\u3092\u5b9a\u7fa9\u3059\u308b\u306e\u306f\u30ca\u30f3\u30bb\u30f3\u30b9\u3060\u304c\u3001\u5b9f\u9a13\u3067\u4f5c\u3063\u3066\u3044\u308b\u306e\u3067\u4eca\u56de\u306f\u3053\u306e\u3088\u3046\u306b\u3057\u305f\u3002\n\u4eca\u56de\u306e\u3088\u3046\u306a\u5358\u7d14\u306a\u6e2c\u5b9a\u3060\u3068CPU\u72b6\u614b\u3068\u304b\u306b\u51e6\u7406\u6642\u9593\u304c\u4f9d\u5b58\u3057\u305f\u308a\u3059\u308b\u306e\u3067\u3042\u307e\u308a\u826f\u304f\u306f\u306a\u3044\u304c\u3001\u51e6\u7406\u6642\u9593\u306e\u5dee\u306f\u304b\u306a\u308a\u306e\u5dee\u306b\u306a\u308b\u3068\u601d\u3063\u305f\u306e\u3067\u5358\u7d14\u306a\u6e2c\u5b9a\u306b\u3057\u3066\u3044\u308b\u3002\nmodule CSVmaker \u306f\u5f8c\u3005\u4f5c\u308bRust\u306e\u95a2\u6570\u3092\u4f7f\u3046\u3082\u306e\u3060\u3068\u8003\u3048\u3066\u304f\u308c\u308c\u3070\u826f\u3044(\u8a73\u3057\u304f\u306fRuby ffi\u3078)\u3002\nlibcsv.dylib \u3053\u308c\u306fOS\u306b\u3088\u3063\u3066\u7570\u306a\u308b\u3068\u601d\u3046\u3002\u3053\u308c\u306b\u95a2\u3057\u3066\u306fRust\u5074\u306e\u8aac\u660e\u306e\u6642\u306b\u89e6\u308c\u308b\u3002\n\nView\u306e\u8a2d\u5b9a\nCSV\u5468\u308a\u306e\u6a5f\u80fd\u306a\u3069\u306f\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u306b\u3082\u305f\u305b\u305f\u306e\u3067\u307b\u3068\u3093\u3069\u3084\u308b\u3053\u3068\u306f\u306a\u3044\u3002\n\napp/views/csv/index.html.erb\n<%= link_to 'csv download(ver: ruby)', ruby_path(format: :csv) %>\n<%= link_to 'csv download(ver: rust)', rust_path(format: :csv) %>\n\n\n\u3053\u308c\u3067Rails\u5074\u306e\u8a2d\u5b9a\u306f\u5b8c\u4e86\u3002\n\nRust\u5074\nRails\u306e\u30eb\u30fc\u30c8\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3067 cargo new rust \u3068\u3059\u308b\u3002\n\u305d\u3057\u3066\u751f\u6210\u3055\u308c\u305f\u30c7\u30a3\u30ec\u30af\u30c8\u306ecargo.toml\u3092\u6b21\u306e\u3088\u3046\u306b\u4fee\u6b63\u3059\u308b\u3002\n\nrust/Cargo.toml\n[package]\n\u3053\u3053\u306f\u7279\u306b\u3044\u3058\u3089\u306a\u3044\n\n[dependencies]\nmysql = \"9.0.1\"\nlibc = \"0.2.0\"\n\n[lib]\nname = \"csv\"\ncrate-type = [\"dylib\"]\n\n\n\u6b21\u306b rust/src/lib.rs \u3092\u6b21\u306e\u3088\u3046\u306b\u3059\u308b\u3002\n\nrust/src/lib.rs\nextern crate mysql;\nextern crate libc;\n\nuse libc::*;\nuse std::ffi::{CString};\n\npub struct CsvTest {\n    id: i32,\n    name: String,\n    hoge: String,\n    foo: String,\n    hogefoo: String,\n    hogehoge: String,\n    foofoo: String,\n    namehoge: String,\n    namefoo: String,\n    namehogefoo: String,\n    namehogehoge: String,\n    namefoofoo: String,\n}\n\n#[no_mangle]\npub extern fn make_csv() -> *const c_char {\n    // DB\u306e\u63a5\u7d9a\n    let pool = mysql::Pool::new(\"mysql://root@localhost:3306/csv_test_development\").unwrap();\n\n    // SELECT\u30af\u30a8\u30ea\n    let select_all: Vec<CsvTest> =\n        pool.prep_exec(\"SELECT id, name, hoge, foo, hogefoo, hogehoge, foofoo, namehoge, namefoo, namehogefoo, namehogehoge, namefoofoo from csv_tests\", ())\n        .map(|result| {\n            result.map(|x| x.unwrap()).map(|row| {\n                let (id, name, hoge, foo, hogefoo, hogehoge, foofoo, namehoge, namefoo, namehogefoo, namehogehoge, namefoofoo) = mysql::from_row(row);\n                CsvTest {\n                    id: id,\n                    name: name,\n                    hoge: hoge,\n                    foo: foo,\n                    hogefoo: hogefoo,\n                    hogehoge: hogehoge,\n                    foofoo: foofoo,\n                    namehoge: namehoge,\n                    namefoo: namefoo,\n                    namehogefoo: namehogefoo,\n                    namehogehoge: namehogehoge,\n                    namefoofoo: namefoofoo,\n                }\n            }).collect()\n        }).unwrap();\n\n    // CSV\u306e\u4f5c\u6210\n    let mut rust_csv: String;\n    rust_csv = format!(\"\\\"id\\\",\\\"name\\\",\\\"hoge\\\",\\\"foo\\\",\\\"hogefoo\\\",\\\"hogehoge\\\",\\\"foofoo\\\",\\\"namehoge\\\",\\\"namefoo\\\",\\\"namehogefoo\\\",\\\"namehogehoge\\\",\\\"namefoofoo\\\"\\n\");\n    for i in &select_all {\n        let record: String = format!(\"\\\"{}\\\",\\\"{}\\\",\\\"{}\\\",\\\"{}\\\",\\\"{}\\\",\\\"{}\\\",\\\"{}\\\",\\\"{}\\\",\\\"{}\\\",\\\"{}\\\",\\\"{}\\\",\\\"{}\\\"\\n\",\n                                     i.id.to_string(),\n                                     i.name,\n                                     i.hoge,\n                                     i.foo,\n                                     i.hogefoo,\n                                     i.hogehoge,\n                                     i.foofoo,\n                                     i.namehoge,\n                                     i.namefoo,\n                                     i.namehogefoo,\n                                     i.namehogehoge,\n                                     i.namefoofoo\n        );\n\n        rust_csv.push_str(&record);\n    }\n\n    CString::new(rust_csv).unwrap().into_raw()\n}\n\n\nstruct\u306f\u69cb\u9020\u4f53\u306a\u306e\u3067\u8aac\u660e\u306fRust\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u306b\u304a\u9858\u3044\u3059\u308b\u3002\nmake_csv\u95a2\u6570\u306b\u3064\u3044\u3066\n\nlet pool = mysql::Pool::new(\"mysql://root@localhost:3306/csv_test_development\").unwrap();\n\n\u3053\u308c\u306fDB\u3078\u306e\u63a5\u7d9a\u3092\u884c\u3046\u3002\u74b0\u5883\u306b\u3088\u3063\u3066\u306f\u30d1\u30b9\u30ef\u30fc\u30c9\u304c\u5fc5\u8981\u306b\u306a\u3063\u305f\u308a\u306a\u3069\u3042\u308b\u3068\u601d\u3046\u306e\u3067new\u4ee5\u4e0b\u3092\u500b\u4eba\u306e\u8a2d\u5b9a\u306b\u5408\u308f\u305b\u3066\u4fee\u6b63\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u3002\n\nlet select_all = ...\n\n\u3053\u3053\u306f\u516c\u5f0f\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u3092\u307b\u307c\u771f\u4f3c\u3066\u3044\u308b\u3002\n\u8a73\u3057\u304f\u306f http://blackbeam.org/doc/mysql/index.html\n\n// CSV\u306e\u4f5c\u6210 \u4ee5\u4e0b\n\n\u3053\u3061\u3089\u306fCSV\u306e\u30d5\u30a9\u30fc\u30de\u30c3\u30c8\u306b\u5408\u308f\u3057\u3066\u6587\u5b57\u5217\u3092\u751f\u6210\u3057\u3066\u3044\u308b\u3002\n\nCString::new(rust_csv).unwrap().into_raw()\n\n\u3053\u3061\u3089\u306fC\u306e\u6587\u5b57\u5217\u306b\u4fee\u6b63\u3057\u3066Ruby\u306b\u6e21\u3059\u305f\u3081\u306e\u3082\u306e\u3067\u3042\u308b\u3002\npub extern fn make_csv() -> *const c_char\n\u3053\u308c\u306e\u8fd4\u308a\u5024\u306e\u578b\u3092string\u306b\u3059\u308b\u3068Ruby\u3067\u547c\u3073\u51fa\u3057\u305f\u6642\u30bb\u30b0\u30e1\u30f3\u30c8\u30d5\u30a9\u30eb\u30c8\u3068\u306a\u308b\u3002\n\nbuild\nrust\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3067 cargo build --release \u3068\u3059\u308b\u3002\n\u5b8c\u4e86\u3057\u305f\u3089 ls target/release \u3068\u3057\u3066 libcsv.dylib \u306e\u3088\u3046\u306a\u30d5\u30a1\u30a4\u30eb\u304c\u3042\u308b\u304b\u78ba\u8a8d\u3092\u3059\u308b\u3002\n\u305f\u3060\u3057\u3001\u3053\u308c\u306fOS\u306b\u3088\u3063\u3066\u62e1\u5f35\u5b50\u304c\u9055\u3063\u305f\u308a\u3059\u308b\u3068\u601d\u3046\u3002\nMac\u3067\u306flibcsv.dylib\u3060\u3063\u305f\u3002\n\u3053\u308c\u3092\u3055\u304d\u307b\u3069Rails\u306e\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u5185\u306b\u5b9a\u7fa9\u3057\u3066module\u3067\u8aad\u307f\u8fbc\u3080\u3002\n\nmodule CSVmaker\n    extend FFI::Library\n    ffi_lib Rails.root + 'rust/target/release/libcsv.dylib'\n    attach_function :make_csv, [], :string\n  end\n\n\u3053\u3046\u3059\u308b\u3053\u3068\u3067Rust\u306e\u95a2\u6570\u3092Ruby\u3067\u4f7f\u7528\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u308b\u3002\n\n\u5b9f\u9a13\n\u4ee5\u4e0a\u3067\u8a2d\u5b9a\u306f\u5b8c\u4e86\u3057\u305f\u306e\u3067 bundle exec rails s \u3068\u3057\u3066\u3001\u30b5\u30fc\u30d0\u3092\u7acb\u3061\u4e0a\u3052\u308b\u3002\n\n\u3053\u306e\u3088\u3046\u306a\u753b\u9762\u304c\u51fa\u3066\u304f\u308b\u306e\u3067\u5f8c\u306f\u30ea\u30f3\u30af\u3092\u62bc\u3059\u3002\n\u7121\u4e8bCSV\u304c\u30c0\u30f3\u30ed\u30fc\u30c9\u3067\u304d\u305f\u3089Rails\u3092\u7acb\u3061\u4e0a\u3052\u305f\u30bf\u30fc\u30df\u30ca\u30eb\u306b\u884c\u304f\u3068\u4f55\u79d2\u304b\u304b\u3063\u305f\u304b\u3092\u898b\u308b\u4e8b\u304c\u3067\u304d\u308b\u3002\n------------------------------------------------------------\n\u51e6\u7406\u306b\u304b\u304b\u3063\u305f\u6642\u9593\n10.226519\n------------------------------------------------------------\n\n\n------------------------------------------------------------\n\u51e6\u7406\u306b\u304b\u304b\u3063\u305f\u6642\u9593\n146.68222\n------------------------------------------------------------\n\n\u4e0a\u304cRust\u306e\u51e6\u7406\u3067\u4e0b\u304cRuby\u306e\u51e6\u7406\u3002\n\n\u307e\u3068\u3081\nRuby\u306750\u4e07\u30ec\u30b3\u30fc\u30c9\u3067\u306eCSV\u51e6\u7406\u3092\u3057\u305f\u6642\u30e1\u30e2\u30ea\u3092\u30d0\u30ab\u98df\u3044\u3057\u3066\u3044\u305f\u306e\u3067\u5927\u304d\u3044\u30c7\u30fc\u30bf\u306b\u5bfe\u3057\u3066\u306f\u6975\u529bRuby\u3092\u907f\u3051\u305f\u307b\u3046\u304c\u3044\u3044\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u3002\n\u4eca\u56de\u306f\u5b9f\u9a13\u7684\u306b\u4f5c\u3063\u3066\u307f\u307e\u3057\u305f\u304c\u3001\u672c\u683c\u7684\u306b\u4f5c\u308c\u3070\u4e00\u90e8\u306e\u51e6\u7406\u3092Rust\u306b\u4efb\u305b\u308b\u306e\u306f\u3042\u308a\u3060\u3068\u601d\u3044\u307e\u3057\u305f\u3002\n\n\u304a\u307e\u3051(Rails\u306e\u74b0\u5883\u69cb\u7bc9)\n\u307e\u305a\u3001rbenv\u306a\u3069\u3067ruby2.3.3\u3092\u5165\u308c\u307e\u3059\u3002\n\u6b21\u306b gem install bundle \u3068\u3057\u307e\u3059\u3002\n\u304a\u597d\u304d\u306a\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3067\n\nGemfile\nsource 'https://rubygems.org'\n\ngem 'rails', '~> 5.0.1'\n\n\n\u3092\u4f5c\u308a\u307e\u3059\u3002\nbundle install --path vendor/bundle \u3068\u3057\u307e\u3059\u3002\npath\u3092\u6307\u5b9a\u3057\u305f\u969b\u3001gitignore\u3067 vendor/bundle \u3068\u3057\u3066\u304b\u3089Git\u306b\u5165\u308c\u307e\u3057\u3087\u3046\u3002\nbundle exec rails new . -BTf -d mysql \u3068\u3059\u308c\u3070\u4eca\u56de\u4f7f\u3046\u74b0\u5883\u306e\u51fa\u6765\u4e0a\u304c\u308a\u3067\u3059\u3002\n\nbundle\u306f gem install \u3068\u306f\u7570\u306a\u308b\u306e\u3067 rails s \u306a\u3069\u306e\u3088\u3046\u306a\u30b3\u30de\u30f3\u30c9\u3092\u6253\u3064\u6642\u306f\u982d\u306b bundle exec \u3068\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\n\n\u8ffd\u8a182017/01/30 19:00\nCSV\u306e\u3068\u3053\u308d\u3092Ruby\u3067\u306f\u6a19\u6e96\u30e9\u30a4\u30d6\u30e9\u30ea\u3092\u4f7f\u3063\u3066\u3044\u305f\u304c\u3001Rust\u3067\u306f\u72ec\u81ea\u306b\u51e6\u7406\u3057\u305f\u5f62\u3068\u306a\u3063\u3066\u3044\u308b\u306e\u3067Ruby\u306e\u65b9\u3092Rust\u306b\u5408\u308f\u305b\u3066\u307f\u305f\u3002\n\napp/controllers/csv_controller.rb\n    ruby_csv = \"\\\"id\\\",\\\"name\\\",\\\"hoge\\\",\\\"foo\\\",\\\"hogefoo\\\",\\\"hogehoge\\\",\\\"foofoo\\\",\\\"namehoge\\\",\\\"namefoo\\\",\\\"namehogefoo\\\",\\\"namehogehoge\\\",\\\"namefoofoo\\\"\\n\"\n    CsvTest.all.each do |data|\n      ruby_csv << \"\\\"#{data.id}\\\",\\\"#{data.name}\\\",\\\"#{data.hoge}\\\",\\\"#{data.foo}\\\",\\\"#{data.hogefoo}\\\",\\\"#{data.hogehoge}\\\",\\\"#{data.foofoo}\\\",\\\"#{data.namehoge}\\\",\\\"#{data.namefoo}\\\",\\\"#{data.namehogefoo}\\\",\\\"#{data.namehogehoge}\\\",\\\"#{data.namefoofoo}\\\"\\n\"\n    end\n\n\nCSV.generate \u306e\u90e8\u5206\u3092\u4e0a\u8a18\u306e\u3088\u3046\u306b\u7f6e\u304d\u63db\u3048\u307e\u3057\u305f\u3002\n\u3053\u3061\u3089\u3067\u5b9f\u9a13\u3057\u305f\u3068\u3053\u308d\n------------------------------------------------------------\n\u51e6\u7406\u306b\u304b\u304b\u3063\u305f\u6642\u9593\n73.224735\n------------------------------------------------------------\n\n\u3068\u306a\u308a\u307e\u3057\u305f\u3002\n\u516c\u5f0fCSV\u30e9\u30a4\u30d6\u30e9\u30ea\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u306b\u66f8\u3044\u3066\u3042\u308b\n\n\u4e0d\u6b63\u306a CSV \u30c7\u30fc\u30bf\u3092\u4e0e\u3048\u305f\u304f\u306a\u3044\u3002\u3042\u308b\u30d5\u30a3\u30fc\u30eb\u30c9\u304c\u4e0d\u6b63\u3067\u3042\u308b\u3053\u3068\u304c\u78ba\u5b9a\u3059 \u308b\u306e\u306f\u30d5\u30a1\u30a4\u30eb\u3092\u5168\u3066\u8aad\u307f\u8fbc\u3093\u3060\u5f8c\u3067\u3059\u3002\u3053\u308c\u306f\u591a\u304f\u306e\u6642\u9593\u3084\u30e1\u30e2\u30ea\u3092\u6d88\u8cbb\u3057 \u307e\u3059\u3002\n\n\u3053\u3053\u306e\u90e8\u5206\u306e\u51e6\u7406\u306e\u305f\u3081\u30e1\u30e2\u30ea\u3084\u51e6\u7406\u6642\u9593\u3092\u6d88\u8cbb\u3057\u3066\u3044\u305f\u307f\u305f\u3044\u3067\u3059\u3002\n\n\u8ffd\u8a182017/02/02 14:00\n\n\u3054\u6307\u6458\u3044\u305f\u3060\u3044\u305fCSV\u30af\u30ec\u30fc\u30c8\u3092\u7528\u3044\u3066\u306e\u51e6\u7406ver\n\nRails\u5074\u306e\u5909\u66f4\u70b9\u306f\u3042\u308a\u307e\u305b\u3093\u3002\n\nCargo.toml\u306b\u8ffd\u8a18\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u306e\u3067\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u8a2d\u5b9a\u3057\u307e\u3059\u3002 \n\nCargo.toml\n[dependencies]\nmysql = \"9.0.1\"\nlibc = \"0.2.0\"\ncsv = \"0.14\"\nrustc-serialize = \"0.3.22\"\n\n[lib]\nname = \"csv\"\ncrate-type = [\"dylib\"]\n\n\n\u6b21\u306b rust/src/lib.rs \u306e\u4fee\u6b63\u3092\u3057\u307e\u3059\u3002\n\nrust/src/lib.rs\nextern crate mysql;\nextern crate libc;\nextern crate csv;\nextern crate rustc_serialize;\n\nuse libc::*;\nuse std::ffi::{CString};\n\n#[derive(RustcEncodable)]\npub struct CsvTest {\n    id: i32,\n    name: String,\n    hoge: String,\n    foo: String,\n    hogefoo: String,\n    hogehoge: String,\n    foofoo: String,\n    namehoge: String,\n    namefoo: String,\n    namehogefoo: String,\n    namehogehoge: String,\n    namefoofoo: String,\n}\n\n#[no_mangle]\npub extern fn make_csv() -> *const c_char {\n    // DB\u306e\u63a5\u7d9a\n    let pool = mysql::Pool::new(\"mysql://root@localhost:3306/csv_test_development\").unwrap();\n\n    // SELECT\n    let select_all: Vec<CsvTest> =\n        pool.prep_exec(\"SELECT id, name, hoge, foo, hogefoo, hogehoge, foofoo, namehoge, namefoo, namehogefoo, namehogehoge, namefoofoo from csv_tests\", ())\n        .map(|result| {\n            result.map(|x| x.unwrap()).map(|row| {\n                let (id, name, hoge, foo, hogefoo, hogehoge, foofoo, namehoge, namefoo, namehogefoo, namehogehoge, namefoofoo) = mysql::from_row(row);\n                CsvTest {\n                    id: id,\n                    name: name,\n                    hoge: hoge,\n                    foo: foo,\n                    hogefoo: hogefoo,\n                    hogehoge: hogehoge,\n                    foofoo: foofoo,\n                    namehoge: namehoge,\n                    namefoo: namefoo,\n                    namehogefoo: namehogefoo,\n                    namehogehoge: namehogehoge,\n                    namefoofoo: namefoofoo,\n                }\n            }).collect()\n        }).unwrap();\n\n    // CSV\u306e\u4f5c\u6210\n    let mut rust_csv = csv::Writer::from_memory();\n    let header = (\"id\", \"name\", \"hoge\", \"foo\", \"hogefoo\", \"hogehoge\", \"foofoo\", \"namehoge\", \"namefoo\", \"namehogefoo\", \"namehogehoge\", \"namefoofoo\");\n    rust_csv.encode(header);\n    for i in &select_all {\n        rust_csv.encode(i);\n    }\n\n    CString::new(rust_csv.as_string()).unwrap().into_raw()\n}\n\n\n\u4e3b\u306a\u5909\u66f4\u70b9\u306fCSV\u306e\u4f5c\u6210\u306e\u3068\u3053\u308d\u3067\u3059\u3002\nCSV\u30af\u30ec\u30fc\u30c8\u3092\u4f7f\u3046\u305f\u3081\u306b\nextern crate csv;\nextern crate rustc_serialize;\n\n\u3068\u30d5\u30a1\u30a4\u30eb\u306e\u5148\u982d\u306b\u66f8\u304d\u3001\u69cb\u9020\u4f53\u306e\u4e0a\u306b #[derive(RustcEncodable)] \u3092\u3064\u3051\u307e\u3059\u3002\n\u3042\u3068\u306f CSV\u30af\u30ec\u30fc\u30c8\u306e\u516c\u5f0f\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8 \u3092\u53c2\u8003\u306b\u3057\u306a\u304c\u3089CSV\u306e\u4f5c\u6210\u90e8\u5206\u3092\u5909\u66f4\u3057\u307e\u3057\u305f\u3002\n\u4fee\u6b63\u304c\u5b8c\u4e86\u3057\u307e\u3057\u305f\u3089 rust \u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3067 $ cargo build --release \u3068\u3057\u3066 Rails \u30b5\u30fc\u30d0\u3092\u7acb\u3061\u4e0a\u3052\u308b\u3060\u3051\u3067\u3059\u3002\n\u3053\u3061\u3089\u3067CSV\u3092\u843d\u3068\u3057\u305f\u3068\u3053\u308d\n------------------------------------------------------------\n\u51e6\u7406\u306b\u304b\u304b\u3063\u305f\u6642\u9593\n10.199653\n------------------------------------------------------------\n\n\u3068\u306a\u308a\u307e\u3057\u305f\u3002\n\u4eca\u56de\u306e\u6e2c\u5b9a\u6cd5\u304cCPU\u306e\u72b6\u614b\u306a\u3069\u306b\u8a08\u6e2c\u6642\u9593\u304c\u4f9d\u5b58\u3057\u3066\u3044\u308b\u3053\u3068\u3092\u8003\u616e\u3057\u3066\u3082\u5341\u5206\u306b\u65e9\u304fCSV\u51e6\u7406\u304c\u51fa\u6765\u3066\u3044\u308b\u3068\u8003\u3048\u3089\u308c\u307e\u3059\u3002\nRails\u3067\u30dc\u30c8\u30eb\u30cd\u30c3\u30af\u306b\u306a\u308a\u3084\u3059\u3044\u30d3\u30b8\u30cd\u30b9\u30ed\u30b8\u30c3\u30af\u90e8\u5206\u3092Rust\u306b\u4efb\u305b\u3066\u307f\u308b\u3068\u826f\u3055\u305d\u3046\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u3002\n## \u80cc\u666f\nRails\u3067CSV\u3092\u8fd4\u3059\u6642\u300110\u4e07\u30c7\u30fc\u30bf\u304f\u3089\u3044\u306e\u3082\u306e\u3092\u666e\u901a\u306b\u51e6\u7406\u3059\u308b\u3068\u30e1\u30e2\u30ea\u3092\u98df\u3044\u6f70\u3057\u305f\u308a\u3001\u51e6\u7406\u304c\u9045\u304b\u3063\u305f\u308a\u3059\u308b\u3002\n\u305d\u3053\u3067\u89e3\u6c7a\u7b56\u3092\u63a2\u3057\u3066\u3044\u305f\u3089\u3001[Rust\u3067Rails\u306e\u4ee3\u308f\u308a\u306bCSV\u3092\u4f5c\u308b](http://qiita.com/aoyagikouhei/items/4100867427e58a6d5a33)\u3068\u3044\u3046\u7d20\u6674\u3089\u3057\u3044\u8a18\u4e8b\u306b\u51fa\u4f1a\u3063\u305f\u3002\n\u3053\u306e\u8a18\u4e8b\u306fPostgres\u3084Nginx\u3092\u4f7f\u3063\u3066\u305f\u304c\u3001\u79c1\u306fMySQL\u3092\u4f7f\u3063\u3066\u304a\u308a\u3001Rails\u306e\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u5185\u3067\u5b8c\u7d50\u3057\u305f\u304b\u3063\u305f\u306e\u3067\u3001\u53c2\u8003\u306b\u3057\u306a\u304c\u3089\u8a66\u9a13\u7684\u306b\u4f5c\u3063\u3066\u898b\u305f\u3002\n\n## \u304a\u65ad\u308a\nRails\u3092\u3059\u3067\u306b\u7406\u89e3\u3057\u3066\u3044\u308b\u3053\u3068\u3092\u524d\u63d0\u306b\u9032\u3081\u307e\u3059\u3002\n\u521d\u5fc3\u8005\u306e\u65b9\u3078\u74b0\u5883\u69cb\u7bc9\u5468\u308a\u3092\u6700\u5f8c\u306e\u65b9\u306b\u304a\u307e\u3051\u3068\u3057\u3066\u66f8\u3044\u3066\u304a\u304d\u307e\u3059\u306e\u3067\u53c2\u8003\u306b\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\u7b46\u8005\u306fRust\u521d\u5fc3\u8005\u3067\u3059\u306e\u3067\u30a2\u30c9\u30d0\u30a4\u30b9\u3092\u9802\u3051\u308b\u3068\u3068\u3066\u3082\u52a9\u304b\u308a\u307e\u3059\u3002\n\n## \u74b0\u5883\n- Ruby 2.3.3\n- Rust 1.14.0\n- Rails 5.0.1\n\nGemfile\u306f\u57fa\u672c\u30c7\u30d5\u30a9\u30eb\u30c8\n\n```ruby:Gemfile\nsource 'https://rubygems.org'\n\ngit_source(:github) do |repo_name|\n  repo_name = \"#{repo_name}/#{repo_name}\" unless repo_name.include?(\"/\")\n  \"https://github.com/#{repo_name}.git\"\nend\n\n\ngem 'rails', '~> 5.0.1'\ngem 'mysql2', '>= 0.3.18', '< 0.5'\ngem 'puma', '~> 3.0'\ngem 'sass-rails', '~> 5.0'\ngem 'uglifier', '>= 1.3.0'\ngem 'coffee-rails', '~> 4.2'\n\ngem 'jquery-rails'\ngem 'turbolinks', '~> 5'\ngem 'jbuilder', '~> 2.5'\n\ngem 'ffi'\n\ngroup :development, :test do\n  gem 'byebug', platform: :mri\nend\n\ngroup :development do\n  gem 'web-console', '>= 3.3.0'\n  gem 'listen', '~> 3.0.5'\n  gem 'spring'\n  gem 'spring-watcher-listen', '~> 2.0.0'\nend\n\ngem 'tzinfo-data', platforms: [:mingw, :mswin, :x64_mingw, :jruby]\n```\n\ncargo\u306e\u8a2d\u5b9a\u306f\u4ee5\u4e0b\u306e\u901a\u308a\uff08CSV\u30af\u30ec\u30fc\u30c8\u3092\u4f7f\u3063\u305f\u30d0\u30fc\u30b8\u30e7\u30f3\u306f\u6700\u5f8c\u306e\u65b9\u306b\u3042\u308b\u8ffd\u8a18\u3092\u53c2\u8003\u306b\u3057\u3066\u304f\u3060\u3055\u3044)\n\n```Cargo.toml\n[dependencies]\nmysql = \"9.0.1\"\nlibc = \"0.2.0\"\n\n[lib]\nname = \"csv\"\ncrate-type = [\"dylib\"]\n```\n\n## Rails\u5074\u306e\u8a2d\u5b9a\n`bundle exec rails new . -BTf -d mysql` \u3067new\u3057\u305f\u6642\u306e\u8a2d\u5b9a\u3068\u3059\u308b\u3002\n\n### \u30c7\u30fc\u30bf\u306e\u4f5c\u6210\n`bundle exec rails g model csv_tests` \u3067Model\u3092\u4f5c\u6210\u3002\nmigration\u30d5\u30a1\u30a4\u30eb\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u3059\u308b\u3002\n\n```2017__create_csv_tests.rb\nclass CreateCsvTests < ActiveRecord::Migration[5.0]\n  def change\n    create_table :csv_tests do |t|\n      t.string :name\n      t.string :hoge\n      t.string :foo\n      t.string :hogefoo\n      t.string :hogehoge\n      t.string :foofoo\n      t.string :namehoge\n      t.string :namefoo\n      t.string :namehogefoo\n      t.string :namehogehoge\n      t.string :namefoofoo\n\n      t.timestamps\n    end\n  end\nend\n```\n\n\u30c7\u30fc\u30bf\u3092\u5165\u308c\u308b\u305f\u3081\u3002seeds.rb\u30d5\u30a1\u30a4\u30eb\u3092\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u3059\u308b\u3002\n\n```db/seeds.rb\n500_000.times do |i|\n  t = CsvTest.new\n  t.name = (1...100).map{ (65 + rand(26)).chr }.join\n  t.hoge = (1...100).map{ (65 + rand(26)).chr }.join\n  t.foo = (1...100).map{ (65 + rand(26)).chr }.join\n  t.hogefoo = (1...100).map{ (65 + rand(26)).chr }.join\n  t.hogehoge = (1...100).map{ (65 + rand(26)).chr }.join\n  t.foofoo = (1...100).map{ (65 + rand(26)).chr }.join\n  t.namehoge = (1...100).map{ (65 + rand(26)).chr }.join\n  t.namefoo = (1...100).map{ (65 + rand(26)).chr }.join\n  t.namehogefoo = (1...100).map{ (65 + rand(26)).chr }.join\n  t.namehogehoge = (1...100).map{ (65 + rand(26)).chr }.join\n  t.namefoofoo = (1...100).map{ (65 + rand(26)).chr }.join\n  t.save!\n  if(i % 1000 == 0)\n    puts \"#{i}\u500b\u4fdd\u5b58\u5b8c\u4e86\"\n  end\nend\n```\n\n\u30e9\u30f3\u30c0\u30e0\u306a\u6587\u5b57\u5217\u3092\u4f5c\u308b\u969b\u3001[Ruby\u3067\u30e9\u30f3\u30c0\u30e0\u306a\u6587\u5b57\u5217\u3092\u751f\u6210\u3059\u308b\u65b9\u6cd5](https://www.xmisao.com/2014/02/15/how-to-generate-a-random-string-in-ruby.html)\u3092\u53c2\u8003\u306b\u3057\u307e\u3057\u305f\u3002\n\n\u6700\u5f8c\u306bDB\u306e\u63a5\u7d9a\u8a2d\u5b9a\u3092\u4fee\u6b63\u3059\u308b\u3002\n\n```config/database.yml\ndefault: &default\n  adapter: mysql2\n  encoding: utf8\n  pool: 5\n  username: root\n  password:\n  socket: /tmp/mysql.sock\n\ndevelopment:\n  <<: *default\n  database: csv_test_development\n```\n\n\u3053\u3053\u307e\u3067\u8a2d\u5b9a\u3057\u305f\u3089\u4ee5\u4e0b\u306e\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3059\u308b\u3002\n\n```\n$ bundle exec rails db:create\n$ bundle exec rails db:migrate\n$ bundle exec rails db:seed\n# seed\u306f50\u4e07\u4ef6\u306e\u30c7\u30fc\u30bf\u3092\u5165\u308c\u8fbc\u3080\u306e\u3067\u304b\u306a\u308a\u6642\u9593\u304c\u304b\u304b\u308b\n```\n\n### \u30eb\u30fc\u30c6\u30a3\u30f3\u30b0\u304b\u3089\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u306e\u8a2d\u5b9a\n\u30eb\u30fc\u30c6\u30a3\u30f3\u30b0\u306e\u8a2d\u5b9a\u306f\n\n```ruby:config/routes.rb\nRails.application.routes.draw do\n  root to: 'csv#index'\n  get :ruby, to: 'csv#ruby'\n  get :rust, to: 'csv#rust'\nend\n```\n\n\u6b21\u306b\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u306e\u8a2d\u5b9a\u3092\u3059\u308b\u3002\n\n```ruby:app/controllers/csv_controller.rb\nrequire 'csv'\nrequire 'ffi'\n\nclass CsvController < ApplicationController\n  def index\n  end\n\n  def ruby\n    start_time = Time.now\n\n    ruby_csv = CSV.generate do |csv|\n      data_column = CsvTest.column_names\n      data_column.delete(\"created_at\")\n      data_column.delete(\"updated_at\")\n      csv << data_column\n      CsvTest.all.each do |data|\n        csv << data.attributes.values_at(*data_column)\n      end\n    end\n\n    puts '------------------------------------------------------------'\n    puts '\u51e6\u7406\u306b\u304b\u304b\u3063\u305f\u6642\u9593'\n    puts Time.now - start_time\n    puts '------------------------------------------------------------'\n\n    respond_to do |format|\n      format.csv { send_data ruby_csv }\n    end\n  end\n\n  module CSVmaker\n    extend FFI::Library\n    ffi_lib Rails.root + 'rust/target/release/libcsv.dylib'\n    attach_function :make_csv, [], :string\n  end\n\n  def rust\n    start_time = Time.now\n\n    rust_csv = CSVmaker.make_csv\n\n    puts '------------------------------------------------------------'\n    puts '\u51e6\u7406\u306b\u304b\u304b\u3063\u305f\u6642\u9593'\n    puts Time.now - start_time\n    puts '------------------------------------------------------------'\n\n    respond_to do |format|\n      format.csv { send_data rust_csv }\n    end\n  end\nend\n```\n\n\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u5185\u3067require\u3084module\u3092\u5b9a\u7fa9\u3059\u308b\u306e\u306f\u30ca\u30f3\u30bb\u30f3\u30b9\u3060\u304c\u3001\u5b9f\u9a13\u3067\u4f5c\u3063\u3066\u3044\u308b\u306e\u3067\u4eca\u56de\u306f\u3053\u306e\u3088\u3046\u306b\u3057\u305f\u3002\n\n\u4eca\u56de\u306e\u3088\u3046\u306a\u5358\u7d14\u306a\u6e2c\u5b9a\u3060\u3068CPU\u72b6\u614b\u3068\u304b\u306b\u51e6\u7406\u6642\u9593\u304c\u4f9d\u5b58\u3057\u305f\u308a\u3059\u308b\u306e\u3067\u3042\u307e\u308a\u826f\u304f\u306f\u306a\u3044\u304c\u3001\u51e6\u7406\u6642\u9593\u306e\u5dee\u306f\u304b\u306a\u308a\u306e\u5dee\u306b\u306a\u308b\u3068\u601d\u3063\u305f\u306e\u3067\u5358\u7d14\u306a\u6e2c\u5b9a\u306b\u3057\u3066\u3044\u308b\u3002\n\n`module CSVmaker` \u306f\u5f8c\u3005\u4f5c\u308bRust\u306e\u95a2\u6570\u3092\u4f7f\u3046\u3082\u306e\u3060\u3068\u8003\u3048\u3066\u304f\u308c\u308c\u3070\u826f\u3044(\u8a73\u3057\u304f\u306f[Ruby ffi](https://github.com/ffi/ffi)\u3078)\u3002\n\n`libcsv.dylib` \u3053\u308c\u306fOS\u306b\u3088\u3063\u3066\u7570\u306a\u308b\u3068\u601d\u3046\u3002\u3053\u308c\u306b\u95a2\u3057\u3066\u306fRust\u5074\u306e\u8aac\u660e\u306e\u6642\u306b\u89e6\u308c\u308b\u3002\n\n### View\u306e\u8a2d\u5b9a\nCSV\u5468\u308a\u306e\u6a5f\u80fd\u306a\u3069\u306f\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u306b\u3082\u305f\u305b\u305f\u306e\u3067\u307b\u3068\u3093\u3069\u3084\u308b\u3053\u3068\u306f\u306a\u3044\u3002\n\n```ruby:app/views/csv/index.html.erb\n<%= link_to 'csv download(ver: ruby)', ruby_path(format: :csv) %>\n<%= link_to 'csv download(ver: rust)', rust_path(format: :csv) %>\n```\n\n\u3053\u308c\u3067Rails\u5074\u306e\u8a2d\u5b9a\u306f\u5b8c\u4e86\u3002\n\n## Rust\u5074\nRails\u306e\u30eb\u30fc\u30c8\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3067 `cargo new rust` \u3068\u3059\u308b\u3002\n\u305d\u3057\u3066\u751f\u6210\u3055\u308c\u305f\u30c7\u30a3\u30ec\u30af\u30c8\u306ecargo.toml\u3092\u6b21\u306e\u3088\u3046\u306b\u4fee\u6b63\u3059\u308b\u3002\n\n```rust/Cargo.toml\n[package]\n\u3053\u3053\u306f\u7279\u306b\u3044\u3058\u3089\u306a\u3044\n\n[dependencies]\nmysql = \"9.0.1\"\nlibc = \"0.2.0\"\n\n[lib]\nname = \"csv\"\ncrate-type = [\"dylib\"]\n```\n\n\u6b21\u306b `rust/src/lib.rs` \u3092\u6b21\u306e\u3088\u3046\u306b\u3059\u308b\u3002\n\n```rust:rust/src/lib.rs\nextern crate mysql;\nextern crate libc;\n\nuse libc::*;\nuse std::ffi::{CString};\n\npub struct CsvTest {\n    id: i32,\n    name: String,\n    hoge: String,\n    foo: String,\n    hogefoo: String,\n    hogehoge: String,\n    foofoo: String,\n    namehoge: String,\n    namefoo: String,\n    namehogefoo: String,\n    namehogehoge: String,\n    namefoofoo: String,\n}\n\n#[no_mangle]\npub extern fn make_csv() -> *const c_char {\n    // DB\u306e\u63a5\u7d9a\n    let pool = mysql::Pool::new(\"mysql://root@localhost:3306/csv_test_development\").unwrap();\n\n    // SELECT\u30af\u30a8\u30ea\n    let select_all: Vec<CsvTest> =\n        pool.prep_exec(\"SELECT id, name, hoge, foo, hogefoo, hogehoge, foofoo, namehoge, namefoo, namehogefoo, namehogehoge, namefoofoo from csv_tests\", ())\n        .map(|result| {\n            result.map(|x| x.unwrap()).map(|row| {\n                let (id, name, hoge, foo, hogefoo, hogehoge, foofoo, namehoge, namefoo, namehogefoo, namehogehoge, namefoofoo) = mysql::from_row(row);\n                CsvTest {\n                    id: id,\n                    name: name,\n                    hoge: hoge,\n                    foo: foo,\n                    hogefoo: hogefoo,\n                    hogehoge: hogehoge,\n                    foofoo: foofoo,\n                    namehoge: namehoge,\n                    namefoo: namefoo,\n                    namehogefoo: namehogefoo,\n                    namehogehoge: namehogehoge,\n                    namefoofoo: namefoofoo,\n                }\n            }).collect()\n        }).unwrap();\n\n    // CSV\u306e\u4f5c\u6210\n    let mut rust_csv: String;\n    rust_csv = format!(\"\\\"id\\\",\\\"name\\\",\\\"hoge\\\",\\\"foo\\\",\\\"hogefoo\\\",\\\"hogehoge\\\",\\\"foofoo\\\",\\\"namehoge\\\",\\\"namefoo\\\",\\\"namehogefoo\\\",\\\"namehogehoge\\\",\\\"namefoofoo\\\"\\n\");\n    for i in &select_all {\n        let record: String = format!(\"\\\"{}\\\",\\\"{}\\\",\\\"{}\\\",\\\"{}\\\",\\\"{}\\\",\\\"{}\\\",\\\"{}\\\",\\\"{}\\\",\\\"{}\\\",\\\"{}\\\",\\\"{}\\\",\\\"{}\\\"\\n\",\n                                     i.id.to_string(),\n                                     i.name,\n                                     i.hoge,\n                                     i.foo,\n                                     i.hogefoo,\n                                     i.hogehoge,\n                                     i.foofoo,\n                                     i.namehoge,\n                                     i.namefoo,\n                                     i.namehogefoo,\n                                     i.namehogehoge,\n                                     i.namefoofoo\n        );\n\n        rust_csv.push_str(&record);\n    }\n\n    CString::new(rust_csv).unwrap().into_raw()\n}\n```\n\nstruct\u306f\u69cb\u9020\u4f53\u306a\u306e\u3067\u8aac\u660e\u306fRust\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u306b\u304a\u9858\u3044\u3059\u308b\u3002\n\nmake_csv\u95a2\u6570\u306b\u3064\u3044\u3066\n\n> let pool = mysql::Pool::new(\"mysql://root@localhost:3306/csv_test_development\").unwrap();\n\n\u3053\u308c\u306fDB\u3078\u306e\u63a5\u7d9a\u3092\u884c\u3046\u3002\u74b0\u5883\u306b\u3088\u3063\u3066\u306f\u30d1\u30b9\u30ef\u30fc\u30c9\u304c\u5fc5\u8981\u306b\u306a\u3063\u305f\u308a\u306a\u3069\u3042\u308b\u3068\u601d\u3046\u306e\u3067new\u4ee5\u4e0b\u3092\u500b\u4eba\u306e\u8a2d\u5b9a\u306b\u5408\u308f\u305b\u3066\u4fee\u6b63\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u3002\n\n> let select_all = ...\n\n\u3053\u3053\u306f\u516c\u5f0f\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u3092\u307b\u307c\u771f\u4f3c\u3066\u3044\u308b\u3002\n\u8a73\u3057\u304f\u306f http://blackbeam.org/doc/mysql/index.html\n\n> // CSV\u306e\u4f5c\u6210 \u4ee5\u4e0b\n\n\u3053\u3061\u3089\u306fCSV\u306e\u30d5\u30a9\u30fc\u30de\u30c3\u30c8\u306b\u5408\u308f\u3057\u3066\u6587\u5b57\u5217\u3092\u751f\u6210\u3057\u3066\u3044\u308b\u3002\n\n> CString::new(rust_csv).unwrap().into_raw()\n\n\u3053\u3061\u3089\u306fC\u306e\u6587\u5b57\u5217\u306b\u4fee\u6b63\u3057\u3066Ruby\u306b\u6e21\u3059\u305f\u3081\u306e\u3082\u306e\u3067\u3042\u308b\u3002\n`pub extern fn make_csv() -> *const c_char`\n\u3053\u308c\u306e\u8fd4\u308a\u5024\u306e\u578b\u3092string\u306b\u3059\u308b\u3068Ruby\u3067\u547c\u3073\u51fa\u3057\u305f\u6642\u30bb\u30b0\u30e1\u30f3\u30c8\u30d5\u30a9\u30eb\u30c8\u3068\u306a\u308b\u3002\n\n### build\n\nrust\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3067 `cargo build --release` \u3068\u3059\u308b\u3002\n\u5b8c\u4e86\u3057\u305f\u3089 `ls target/release` \u3068\u3057\u3066 `libcsv.dylib` \u306e\u3088\u3046\u306a\u30d5\u30a1\u30a4\u30eb\u304c\u3042\u308b\u304b\u78ba\u8a8d\u3092\u3059\u308b\u3002\n\u305f\u3060\u3057\u3001\u3053\u308c\u306fOS\u306b\u3088\u3063\u3066\u62e1\u5f35\u5b50\u304c\u9055\u3063\u305f\u308a\u3059\u308b\u3068\u601d\u3046\u3002\nMac\u3067\u306flibcsv.dylib\u3060\u3063\u305f\u3002\n\n\u3053\u308c\u3092\u3055\u304d\u307b\u3069Rails\u306e\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u5185\u306b\u5b9a\u7fa9\u3057\u3066module\u3067\u8aad\u307f\u8fbc\u3080\u3002\n\n>   module CSVmaker\n    extend FFI::Library\n    ffi_lib Rails.root + 'rust/target/release/libcsv.dylib'\n    attach_function :make_csv, [], :string\n  end\n  \n\u3053\u3046\u3059\u308b\u3053\u3068\u3067Rust\u306e\u95a2\u6570\u3092Ruby\u3067\u4f7f\u7528\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u308b\u3002\n\n## \u5b9f\u9a13\n\u4ee5\u4e0a\u3067\u8a2d\u5b9a\u306f\u5b8c\u4e86\u3057\u305f\u306e\u3067 `bundle exec rails s` \u3068\u3057\u3066\u3001\u30b5\u30fc\u30d0\u3092\u7acb\u3061\u4e0a\u3052\u308b\u3002\n\n![\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2017-01-30 13.47.46.png](https://qiita-image-store.s3.amazonaws.com/0/101588/4fd85e74-8ac1-3e57-4f15-f7008c35bfe4.png \"\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2017-01-30 13.47.46.png\")\n\n\u3053\u306e\u3088\u3046\u306a\u753b\u9762\u304c\u51fa\u3066\u304f\u308b\u306e\u3067\u5f8c\u306f\u30ea\u30f3\u30af\u3092\u62bc\u3059\u3002\n\u7121\u4e8bCSV\u304c\u30c0\u30f3\u30ed\u30fc\u30c9\u3067\u304d\u305f\u3089Rails\u3092\u7acb\u3061\u4e0a\u3052\u305f\u30bf\u30fc\u30df\u30ca\u30eb\u306b\u884c\u304f\u3068\u4f55\u79d2\u304b\u304b\u3063\u305f\u304b\u3092\u898b\u308b\u4e8b\u304c\u3067\u304d\u308b\u3002\n\n```\n------------------------------------------------------------\n\u51e6\u7406\u306b\u304b\u304b\u3063\u305f\u6642\u9593\n10.226519\n------------------------------------------------------------\n\n```\n\n```\n------------------------------------------------------------\n\u51e6\u7406\u306b\u304b\u304b\u3063\u305f\u6642\u9593\n146.68222\n------------------------------------------------------------\n```\n\n\u4e0a\u304cRust\u306e\u51e6\u7406\u3067\u4e0b\u304cRuby\u306e\u51e6\u7406\u3002\n\n\n## \u307e\u3068\u3081\nRuby\u306750\u4e07\u30ec\u30b3\u30fc\u30c9\u3067\u306eCSV\u51e6\u7406\u3092\u3057\u305f\u6642\u30e1\u30e2\u30ea\u3092\u30d0\u30ab\u98df\u3044\u3057\u3066\u3044\u305f\u306e\u3067\u5927\u304d\u3044\u30c7\u30fc\u30bf\u306b\u5bfe\u3057\u3066\u306f\u6975\u529bRuby\u3092\u907f\u3051\u305f\u307b\u3046\u304c\u3044\u3044\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u3002\n\u4eca\u56de\u306f\u5b9f\u9a13\u7684\u306b\u4f5c\u3063\u3066\u307f\u307e\u3057\u305f\u304c\u3001\u672c\u683c\u7684\u306b\u4f5c\u308c\u3070\u4e00\u90e8\u306e\u51e6\u7406\u3092Rust\u306b\u4efb\u305b\u308b\u306e\u306f\u3042\u308a\u3060\u3068\u601d\u3044\u307e\u3057\u305f\u3002\n\n## \u304a\u307e\u3051(Rails\u306e\u74b0\u5883\u69cb\u7bc9)\n\u307e\u305a\u3001rbenv\u306a\u3069\u3067ruby2.3.3\u3092\u5165\u308c\u307e\u3059\u3002\n\u6b21\u306b `gem install bundle` \u3068\u3057\u307e\u3059\u3002\n\n\u304a\u597d\u304d\u306a\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3067\n\n```ruby:Gemfile\nsource 'https://rubygems.org'\n\ngem 'rails', '~> 5.0.1'\n```\n\n\u3092\u4f5c\u308a\u307e\u3059\u3002\n`bundle install --path vendor/bundle` \u3068\u3057\u307e\u3059\u3002\npath\u3092\u6307\u5b9a\u3057\u305f\u969b\u3001gitignore\u3067 `vendor/bundle` \u3068\u3057\u3066\u304b\u3089Git\u306b\u5165\u308c\u307e\u3057\u3087\u3046\u3002\n\n`bundle exec rails new . -BTf -d mysql` \u3068\u3059\u308c\u3070\u4eca\u56de\u4f7f\u3046\u74b0\u5883\u306e\u51fa\u6765\u4e0a\u304c\u308a\u3067\u3059\u3002\n\n> bundle\u306f `gem install` \u3068\u306f\u7570\u306a\u308b\u306e\u3067 `rails s` \u306a\u3069\u306e\u3088\u3046\u306a\u30b3\u30de\u30f3\u30c9\u3092\u6253\u3064\u6642\u306f\u982d\u306b `bundle exec` \u3068\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\n## \u8ffd\u8a182017/01/30 19:00\nCSV\u306e\u3068\u3053\u308d\u3092Ruby\u3067\u306f\u6a19\u6e96\u30e9\u30a4\u30d6\u30e9\u30ea\u3092\u4f7f\u3063\u3066\u3044\u305f\u304c\u3001Rust\u3067\u306f\u72ec\u81ea\u306b\u51e6\u7406\u3057\u305f\u5f62\u3068\u306a\u3063\u3066\u3044\u308b\u306e\u3067Ruby\u306e\u65b9\u3092Rust\u306b\u5408\u308f\u305b\u3066\u307f\u305f\u3002\n\n```ruby:app/controllers/csv_controller.rb\n    ruby_csv = \"\\\"id\\\",\\\"name\\\",\\\"hoge\\\",\\\"foo\\\",\\\"hogefoo\\\",\\\"hogehoge\\\",\\\"foofoo\\\",\\\"namehoge\\\",\\\"namefoo\\\",\\\"namehogefoo\\\",\\\"namehogehoge\\\",\\\"namefoofoo\\\"\\n\"\n    CsvTest.all.each do |data|\n      ruby_csv << \"\\\"#{data.id}\\\",\\\"#{data.name}\\\",\\\"#{data.hoge}\\\",\\\"#{data.foo}\\\",\\\"#{data.hogefoo}\\\",\\\"#{data.hogehoge}\\\",\\\"#{data.foofoo}\\\",\\\"#{data.namehoge}\\\",\\\"#{data.namefoo}\\\",\\\"#{data.namehogefoo}\\\",\\\"#{data.namehogehoge}\\\",\\\"#{data.namefoofoo}\\\"\\n\"\n    end\n```\n\n`CSV.generate` \u306e\u90e8\u5206\u3092\u4e0a\u8a18\u306e\u3088\u3046\u306b\u7f6e\u304d\u63db\u3048\u307e\u3057\u305f\u3002\n\u3053\u3061\u3089\u3067\u5b9f\u9a13\u3057\u305f\u3068\u3053\u308d\n\n```\n------------------------------------------------------------\n\u51e6\u7406\u306b\u304b\u304b\u3063\u305f\u6642\u9593\n73.224735\n------------------------------------------------------------\n```\n\n\u3068\u306a\u308a\u307e\u3057\u305f\u3002\n\n[\u516c\u5f0fCSV\u30e9\u30a4\u30d6\u30e9\u30ea\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8](https://docs.ruby-lang.org/ja/latest/library/csv.html)\u306b\u66f8\u3044\u3066\u3042\u308b\n\n> \u4e0d\u6b63\u306a CSV \u30c7\u30fc\u30bf\u3092\u4e0e\u3048\u305f\u304f\u306a\u3044\u3002\u3042\u308b\u30d5\u30a3\u30fc\u30eb\u30c9\u304c\u4e0d\u6b63\u3067\u3042\u308b\u3053\u3068\u304c\u78ba\u5b9a\u3059 \u308b\u306e\u306f\u30d5\u30a1\u30a4\u30eb\u3092\u5168\u3066\u8aad\u307f\u8fbc\u3093\u3060\u5f8c\u3067\u3059\u3002\u3053\u308c\u306f\u591a\u304f\u306e\u6642\u9593\u3084\u30e1\u30e2\u30ea\u3092\u6d88\u8cbb\u3057 \u307e\u3059\u3002\n\n\u3053\u3053\u306e\u90e8\u5206\u306e\u51e6\u7406\u306e\u305f\u3081\u30e1\u30e2\u30ea\u3084\u51e6\u7406\u6642\u9593\u3092\u6d88\u8cbb\u3057\u3066\u3044\u305f\u307f\u305f\u3044\u3067\u3059\u3002\n\n## \u8ffd\u8a182017/02/02 14:00\n### \u3054\u6307\u6458\u3044\u305f\u3060\u3044\u305fCSV\u30af\u30ec\u30fc\u30c8\u3092\u7528\u3044\u3066\u306e\u51e6\u7406ver\n> Rails\u5074\u306e\u5909\u66f4\u70b9\u306f\u3042\u308a\u307e\u305b\u3093\u3002\n\nCargo.toml\u306b\u8ffd\u8a18\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u306e\u3067\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u8a2d\u5b9a\u3057\u307e\u3059\u3002 \n\n```Cargo.toml\n[dependencies]\nmysql = \"9.0.1\"\nlibc = \"0.2.0\"\ncsv = \"0.14\"\nrustc-serialize = \"0.3.22\"\n\n[lib]\nname = \"csv\"\ncrate-type = [\"dylib\"]\n```\n\n\u6b21\u306b `rust/src/lib.rs` \u306e\u4fee\u6b63\u3092\u3057\u307e\u3059\u3002\n\n```rust:rust/src/lib.rs\nextern crate mysql;\nextern crate libc;\nextern crate csv;\nextern crate rustc_serialize;\n\nuse libc::*;\nuse std::ffi::{CString};\n\n#[derive(RustcEncodable)]\npub struct CsvTest {\n    id: i32,\n    name: String,\n    hoge: String,\n    foo: String,\n    hogefoo: String,\n    hogehoge: String,\n    foofoo: String,\n    namehoge: String,\n    namefoo: String,\n    namehogefoo: String,\n    namehogehoge: String,\n    namefoofoo: String,\n}\n\n#[no_mangle]\npub extern fn make_csv() -> *const c_char {\n    // DB\u306e\u63a5\u7d9a\n    let pool = mysql::Pool::new(\"mysql://root@localhost:3306/csv_test_development\").unwrap();\n\n    // SELECT\n    let select_all: Vec<CsvTest> =\n        pool.prep_exec(\"SELECT id, name, hoge, foo, hogefoo, hogehoge, foofoo, namehoge, namefoo, namehogefoo, namehogehoge, namefoofoo from csv_tests\", ())\n        .map(|result| {\n            result.map(|x| x.unwrap()).map(|row| {\n                let (id, name, hoge, foo, hogefoo, hogehoge, foofoo, namehoge, namefoo, namehogefoo, namehogehoge, namefoofoo) = mysql::from_row(row);\n                CsvTest {\n                    id: id,\n                    name: name,\n                    hoge: hoge,\n                    foo: foo,\n                    hogefoo: hogefoo,\n                    hogehoge: hogehoge,\n                    foofoo: foofoo,\n                    namehoge: namehoge,\n                    namefoo: namefoo,\n                    namehogefoo: namehogefoo,\n                    namehogehoge: namehogehoge,\n                    namefoofoo: namefoofoo,\n                }\n            }).collect()\n        }).unwrap();\n\n    // CSV\u306e\u4f5c\u6210\n    let mut rust_csv = csv::Writer::from_memory();\n    let header = (\"id\", \"name\", \"hoge\", \"foo\", \"hogefoo\", \"hogehoge\", \"foofoo\", \"namehoge\", \"namefoo\", \"namehogefoo\", \"namehogehoge\", \"namefoofoo\");\n    rust_csv.encode(header);\n    for i in &select_all {\n        rust_csv.encode(i);\n    }\n\n    CString::new(rust_csv.as_string()).unwrap().into_raw()\n}\n```\n\n\u4e3b\u306a\u5909\u66f4\u70b9\u306fCSV\u306e\u4f5c\u6210\u306e\u3068\u3053\u308d\u3067\u3059\u3002\nCSV\u30af\u30ec\u30fc\u30c8\u3092\u4f7f\u3046\u305f\u3081\u306b\n\n```\nextern crate csv;\nextern crate rustc_serialize;\n```\n\n\u3068\u30d5\u30a1\u30a4\u30eb\u306e\u5148\u982d\u306b\u66f8\u304d\u3001\u69cb\u9020\u4f53\u306e\u4e0a\u306b `#[derive(RustcEncodable)]` \u3092\u3064\u3051\u307e\u3059\u3002\n\u3042\u3068\u306f [CSV\u30af\u30ec\u30fc\u30c8\u306e\u516c\u5f0f\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8](http://burntsushi.net/rustdoc/csv/struct.Writer.html) \u3092\u53c2\u8003\u306b\u3057\u306a\u304c\u3089CSV\u306e\u4f5c\u6210\u90e8\u5206\u3092\u5909\u66f4\u3057\u307e\u3057\u305f\u3002\n\n\u4fee\u6b63\u304c\u5b8c\u4e86\u3057\u307e\u3057\u305f\u3089 `rust` \u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3067 `$ cargo build --release` \u3068\u3057\u3066 Rails \u30b5\u30fc\u30d0\u3092\u7acb\u3061\u4e0a\u3052\u308b\u3060\u3051\u3067\u3059\u3002\n\n\u3053\u3061\u3089\u3067CSV\u3092\u843d\u3068\u3057\u305f\u3068\u3053\u308d\n\n```\n------------------------------------------------------------\n\u51e6\u7406\u306b\u304b\u304b\u3063\u305f\u6642\u9593\n10.199653\n------------------------------------------------------------\n```\n\n\u3068\u306a\u308a\u307e\u3057\u305f\u3002\n\n\u4eca\u56de\u306e\u6e2c\u5b9a\u6cd5\u304cCPU\u306e\u72b6\u614b\u306a\u3069\u306b\u8a08\u6e2c\u6642\u9593\u304c\u4f9d\u5b58\u3057\u3066\u3044\u308b\u3053\u3068\u3092\u8003\u616e\u3057\u3066\u3082\u5341\u5206\u306b\u65e9\u304fCSV\u51e6\u7406\u304c\u51fa\u6765\u3066\u3044\u308b\u3068\u8003\u3048\u3089\u308c\u307e\u3059\u3002\nRails\u3067\u30dc\u30c8\u30eb\u30cd\u30c3\u30af\u306b\u306a\u308a\u3084\u3059\u3044\u30d3\u30b8\u30cd\u30b9\u30ed\u30b8\u30c3\u30af\u90e8\u5206\u3092Rust\u306b\u4efb\u305b\u3066\u307f\u308b\u3068\u826f\u3055\u305d\u3046\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u3002\n", "tags": ["Ruby", "rust", "Rails"]}