{"tags": ["SoftLayer", "openstack"], "context": " More than 1 year has passed since last update.\u524d\u56de\u306f\u3053\u3061\u3089 - \u6b21\u56de\u306f\u3053\u3061\u3089\n\n\n\u3053\u308c\u306f\u306a\u306b\n\u300cOpenStack\u30af\u30e9\u30a6\u30c9\u30a4\u30f3\u30c6\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3 \u30aa\u30fc\u30d7\u30f3\u30bd\u30fc\u30b9\u30af\u30e9\u30a6\u30c9\u306b\u3088\u308b\u30b5\u30fc\u30d3\u30b9\u69cb\u7bc9\u5165\u9580\u300d\u306e\u5b9f\u7fd2\u3092SoftLayer\u306e\u7121\u6599\u30d9\u30a2\u30e1\u30bf\u30eb\u3067\u884c\u3046\u8a18\u9332\u3067\u3042\u308b\u3002\n\n\n\u7b2c7\u7ae0 \u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u8ca0\u8377\u5206\u6563\n\u7b2c5\u7ae0\u304b\u3089\u7b2c10\u7ae0\u307e\u3067\u306e\u652f\u63f4\u30d5\u30a1\u30a4\u30eb\u306f\u3053\u3061\u3089\u3002\u307e\u3068\u3081\u3066git\u3067\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3067\u304d\u308b\u3002\nhttps://github.com/josug-book1-materials/chapter05-10\n\u7b2c7\u7ae0\u306e\u652f\u63f4\u30d5\u30a1\u30a4\u30eb\u306f\u3053\u3061\u3089\u3067\u3042\u308b\u3002\nhttps://github.com/josug-book1-materials/chapter05-10/tree/master/07\n\u524d\u56de\u3068\u540c\u69d8\u306b\u7b2c7\u7ae0\u306e\u3059\u3079\u3066\u306e\u30b9\u30c6\u30c3\u30d7\u3092\u307e\u3068\u3081\u3066\u884c\u3046\u30b9\u30af\u30ea\u30d7\u30c8\u3082\u7528\u610f\u3055\u308c\u3066\u3044\u308b\u3002\nhttps://github.com/josug-book1-materials/chapter05-10/blob/master/07/build_chap07.sh\n\n7.1 \u8ca0\u8377\u5206\u6563\u51e6\u7406\u306e\u6d41\u308c\n\u3053\u306e\u7ae0\u3067\u306f\u7b2c6\u7ae0\u3067\u69cb\u7bc9\u3057\u305f3\u5c64\u306eSNS\u30a2\u30d7\u30ea\u306e\u30d5\u30ed\u30f3\u30c8\u306b\u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b5\u30fc\u3092\u7acb\u3066\u3001Web\u30b5\u30fc\u30d0\u30fc\u3092\u5897\u8a2d\u3057\u3066\u305d\u306e\u914d\u4e0b\u306b\u52a0\u3048\u308b\u3002\u6700\u5f8c\u306b\u516c\u958b\u30a2\u30c9\u30ec\u30b9\u3067\u3042\u308bweb01\u306b\u3064\u3051\u3066\u3044\u305fFloting IP\u3092\u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b5\u30fc\u306b\u4ed8\u3051\u66ff\u3048\u308b\u3002\n\n7.2 \u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b5\u30fc\u306e\u69cb\u7bc9\n\u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b5\u30fclbs01\u3092\u69cb\u7bc9\u3057\u63a5\u7d9a\u306fweb01\u306b\u8ee2\u9001\u3059\u308b\u8a2d\u5b9a\u3092\u3059\u308b\u3002\n\n7.2.1 userdata\u30d5\u30a1\u30a4\u30eb\u306e\u4f5c\u6210\n\u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b5\u30fc\u306b\u306fnginx\u3092\u5229\u7528\u3059\u308b\u3002\nuserdata\u306f\u3053\u3061\u3089\u3002nginx\u306e\u5c0e\u5165\u3068\u81ea\u52d5\u8d77\u52d5\u304c\u8a2d\u5b9a\u3055\u308c\u3066\u3044\u308b\u3002\n\n7.2.2 \u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b5\u30fc\u306e\u8d77\u52d5\n\u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b5\u30fc\u306fdmz-net\u306b\u63a5\u7d9a\u3055\u308c\u308b\u306e\u3067\u3001dmz-net\u306eUUID\u3092\u53d6\u5f97\u3057\u300cnova boot\u300d\u306b\u6307\u5b9a\u3057\u3066\u3044\u308b\u3002\n[root@step-server 07]# function get_uuid () { cat - | grep \" id \" | awk '{print $4}'; }\n[root@step-server 07]# export MY_DMZ_NET=`neutron net-show dmz-net | get_uuid`\n[root@step-server 07]# nova boot --flavor standard.xsmall --image \"centos-base\" \\\n> --key-name key-for-internal --user-data userdata_lbs.txt \\\n> --security-groups sg-all-from-console,sg-web-from-internet \\\n> --availability-zone az1 \\\n> --nic net-id=${MY_DMZ_NET} \\\n> lbs01\n+--------------------------------------+----------------------------------------------------+\n| Property                             | Value                                              |\n+--------------------------------------+----------------------------------------------------+\n| OS-DCF:diskConfig                    | MANUAL                                             |\n| OS-EXT-AZ:availability_zone          | nova                                               |\n| OS-EXT-STS:power_state               | 0                                                  |\n| OS-EXT-STS:task_state                | scheduling                                         |\n| OS-EXT-STS:vm_state                  | building                                           |\n| OS-SRV-USG:launched_at               | -                                                  |\n| OS-SRV-USG:terminated_at             | -                                                  |\n| accessIPv4                           |                                                    |\n| accessIPv6                           |                                                    |\n| adminPass                            | FLZDfBC57nW9                                       |\n| config_drive                         |                                                    |\n| created                              | 2015-03-24T05:40:19Z                               |\n| flavor                               | standard.xsmall (100)                              |\n| hostId                               |                                                    |\n| id                                   | 37cbd237-9fd9-4f95-b4e3-caafeaf67454               |\n| image                                | centos-base (098f948e-e80b-4b1a-8a46-f8d2dd57e149) |\n| key_name                             | key-for-internal                                   |\n| metadata                             | {}                                                 |\n| name                                 | lbs01                                              |\n| os-extended-volumes:volumes_attached | []                                                 |\n| progress                             | 0                                                  |\n| security_groups                      | sg-all-from-console, sg-web-from-internet          |\n| status                               | BUILD                                              |\n| tenant_id                            | 106e169743964758bcad1f06cc69c472                   |\n| updated                              | 2015-03-24T05:40:20Z                               |\n| user_id                              | 98dd78b670884b64b879568215777c53                   |\n+--------------------------------------+----------------------------------------------------+\n\nlbs01\u306b\u306f\u300cdmz-net=192.168.0.5\u300d\u304c\u5272\u308a\u632f\u3089\u308c\u305f\u3002\n[root@step-server 07]# nova list --field name,networks\n+--------------------------------------+-------------+---------------------------------------------------------------+\n| ID                                   | Name        | Networks                                                      |\n+--------------------------------------+-------------+---------------------------------------------------------------+\n| 35d338e5-6e8a-4cee-9be1-9a37b431bf38 | app01       | dmz-net=192.168.0.3; app-net=172.16.10.3; dbs-net=172.16.20.1 |\n| edf1b599-de4f-4b2c-be90-17ab1252728f | dbs01       | dmz-net=192.168.0.4; dbs-net=172.16.20.3                      |\n| 37cbd237-9fd9-4f95-b4e3-caafeaf67454 | lbs01       | dmz-net=192.168.0.5                                           |\n| 65d3400d-3467-4563-9ff5-9c0e30c7157e | step-server | work-net=10.0.0.1, 192.168.100.131                            |\n| ca755522-3eb2-475a-8e37-7fe23398b1d9 | web01       | dmz-net=192.168.0.1, 192.168.100.133; app-net=172.16.10.1     |\n+--------------------------------------+-------------+---------------------------------------------------------------+\n\nlbs01\u306eIP\u30a2\u30c9\u30ec\u30b9\u3092\u74b0\u5883\u5909\u6570$MY_LBS_IP\u306b\u30bb\u30c3\u30c8\u3057\u3066\u304a\u304f\u3002\n[root@step-server 07]# export MY_LBS_IP=`nova show lbs01 | grep \" dmz-net\" | awk '{print $5}'`\n[root@step-server 07]# echo $MY_LBS_IP\n192.168.0.5\n\nnginx\u304c\u8d77\u52d5\u3057\u3066\u3044\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3059\u308b\u3002\n[root@step-server 07]# curl http://${MY_LBS_IP}\n<!DOCTYPE html>\n<html>\n<head>\n<title>Welcome to nginx!</title>\n<style>\n    body {\n\uff5e\uff5e\uff5e\uff5e\uff5e\uff5e\uff5e\uff5e\n\n\n7.2.3 Nginx\u306e\u8a2d\u5b9a\nlbs01\u306b\u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b5\u30fc\u7528\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3059\u308b\u3002\n\u307e\u305a\u3001lbs01\u306b\u30ed\u30b0\u30a4\u30f3\u3059\u308b\u3002\n[root@step-server ~]# ssh -i key-for-internal.pem root@${MY_LBS_IP}\n[root@lbs01 ~]#\n\n\u69cb\u6210\u30d5\u30a1\u30a4\u30eb/etc/nginx/conf.d/lbs.conf\u3092\u3001\u4e0b\u8a18\u306e\u3088\u3046\u306b\u4f5c\u6210\u3059\u308b\u3002server\u306eIP\u300c192.168.0.1\u300d\u306f\u3001web01\u306e\u300cdmz-net=192.168.0.1\u300d\u306e\u5272\u308a\u632f\u308a\u3067\u3042\u308b\u3002\n[root@lbs01 ~]# cat /etc/nginx/conf.d/lbs.conf\nupstream web-server {\n  server 192.168.0.1:80;\n}\n\nserver {\n  listen 80 default_server;\n  server_name _;\n\n  location / {\n    proxy_pass http://web-server/;\n  }\n}\n\n\u69cb\u6210\u3092\u78ba\u8a8d\u3057\u3066\u518d\u8d77\u52d5\u3059\u308b\u3002\n[root@lbs01 ~]# service nginx configtest\nnginx: the configuration file /etc/nginx/nginx.conf syntax is ok\nnginx: configuration file /etc/nginx/nginx.conf test is successful\n[root@lbs01 ~]# service nginx restart\nStopping nginx:                                            [  OK  ]\nStarting nginx:                                            [  OK  ]\n\n\n7.2.4 \u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b5\u30fc\u7d4c\u7531\u3067\u306e\u30a2\u30af\u30bb\u30b9\u78ba\u8a8d\n\u8e0f\u307f\u53f0\u30b5\u30fc\u30d0\u30fc\u306b\u623b\u308a\u3001lbs01\u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3002\n\u5148\u307b\u3069\u306f\u300cWelcome to nginx!\u300d\u3060\u3063\u305f\u304c\u3001\u4eca\u56de\u306f\u7b2c6\u7ae0\u306e\u52d5\u4f5c\u78ba\u8a8d\u3067\u66f8\u304d\u8fbc\u3093\u3060\u300c6\u7ae0\u306e\u7d42\u4e86\u300d\u304c\u8868\u793a\u3055\u308c\u3066\u3044\u308b\u3002\u30a2\u30d7\u30ea\u306b\u63a5\u7d9a\u3067\u304d\u3066\u3044\u308b\u3088\u3046\u3067\u3042\u308b\u3002\n[root@step-server ~]# curl http://${MY_LBS_IP}\n<!doctype html>\n<html>\n  <head>\n    <meta http-equiv=\"Content-Type\" content=\"text/html; charset=UTF-8\">\n    <title></title>\n  </head>\n  <body>\n    <form method=\"POST\" action=\"/\">\n      <label for=\"text\">Please write something and hit enter</label> <input id=\"text\" name=\"text\" type=\"text\" value=\"\">\n    </form>\n    <br/>\n            <table class=\"contents\">\n                    <tr>\n                        <td>2015-03-24 13:12:57</td>\n                        <td>6\u7ae0\u306e\u7d42\u4e86</td>\n                    </tr>\n            </table>\n  </body>\n</html>\n\n\n7.3 Web\u30b5\u30fc\u30d0\u30fc\u306e\u30c7\u30d7\u30ed\u30a4\n\n7.3.1 WEB\u30b5\u30fc\u30d0\u30fc\u69cb\u7bc9\u65b9\u6cd5\u306e\u6574\u7406\n\u3053\u306e\u7bc0\u3067\u5b9f\u884c\u3059\u308bWEB\u30b5\u30fc\u30d0\u30fc\u69cb\u7bc9\u65b9\u6cd5\u306e\u6574\u7406\u3067\u3042\u308b\u3002\nweb01\u306fgit\u304b\u3089\u30a2\u30d7\u30ea\u3092\u5c0e\u5165\u5f8c\u3001(1)endpoint.conf\u306bapp\u30b5\u30fc\u30d0\u30fc\u306eIP\u3092\u6307\u5b9a\u3057\u3001(2)web.init.sh\u306e\u5b9f\u884c\u3067\u30a2\u30d7\u30ea\u3092\u8d77\u52d5\u3057\u305f\u3002\n\u3053\u3053\u3067\u306f(1)\u306f\u74b0\u5883\u6bce\u306b\u8a2d\u5b9a\u304c\u7570\u306a\u308b\u9805\u76ee\u3067\u3042\u308b\u3001\u3053\u306e\u65b9\u6cd5\u3068\u3057\u3066\u4e0b\u8a18\u306e\u3075\u305f\u3064\u306e\u65b9\u6cd5\u3092\u8a66\u3059\u3002\n\nendpoint.conf\u306b\u73fe\u884capp\u30b5\u30fc\u30d0\u30fc\u306eIP\u3092\u6307\u5b9a\u3057\u305f\u30b5\u30fc\u30d0\u30fc\u3092\u69cb\u7bc9\u3057\u30b9\u30ca\u30c3\u30d7\u30b7\u30e7\u30c3\u30c8\u3092\u3001\u8ffd\u52a0web\u30b5\u30fc\u30d0\u30fc\u306e\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u3068\u3059\u308b\u3002\nmetadata\u6a5f\u80fd\u3092\u4f7f\u3063\u3066\u30c7\u30d7\u30ed\u30a4\u6642\u306bapp\u30b5\u30fc\u30d0\u30fc\u306eIP\u3092\u53d6\u5f97\u3057\u3001\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092\u66f4\u65b0\u3059\u308b\u3002\n\n\n7.3.2 \u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u3068\u306a\u308bweb02\u306e\u69cb\u7bc9\n\u69cb\u7bc9\u624b\u9806\u306fweb01\u3068\u540c\u69d8\u3067\u3042\u308b\u3002\u9055\u3046\u3068\u3053\u308d\u306f\u540d\u524d\u304cweb02\u3002\n[root@step-server 06]# function get_uuid () { cat - | grep \" id \" | awk '{print $4}'; }\n[root@step-server 06]# export MY_DMZ_NET=`neutron net-show dmz-net | get_uuid`\n[root@step-server 06]# export MY_APP_NET=`neutron net-show app-net | get_uuid``\n[root@step-server 06]# nova boot --flavor standard.xsmall --image \"centos-base\" \\\n> --key-name key-for-internal --user-data userdata_web.txt \\\n> --security-groups sg-all-from-console,sg-web-from-internet,sg-all-from-app-net \\\n> --availability-zone az1 \\\n> --nic net-id=${MY_DMZ_NET} --nic net-id=${MY_APP_NET} \\\n> web02\n+--------------------------------------+----------------------------------------------------------------+\n| Property                             | Value                                                          |\n+--------------------------------------+----------------------------------------------------------------+\n| OS-DCF:diskConfig                    | MANUAL                                                         |\n| OS-EXT-AZ:availability_zone          | nova                                                           |\n| OS-EXT-STS:power_state               | 0                                                              |\n| OS-EXT-STS:task_state                | scheduling                                                     |\n| OS-EXT-STS:vm_state                  | building                                                       |\n| OS-SRV-USG:launched_at               | -                                                              |\n| OS-SRV-USG:terminated_at             | -                                                              |\n| accessIPv4                           |                                                                |\n| accessIPv6                           |                                                                |\n| adminPass                            | QmG6wRJZywdB                                                   |\n| config_drive                         |                                                                |\n| created                              | 2015-03-24T06:33:36Z                                           |\n| flavor                               | standard.xsmall (100)                                          |\n| hostId                               |                                                                |\n| id                                   | d0ce0d2a-f4fa-448d-bb9b-b605af386b9f                           |\n| image                                | centos-base (098f948e-e80b-4b1a-8a46-f8d2dd57e149)             |\n| key_name                             | key-for-internal                                               |\n| metadata                             | {}                                                             |\n| name                                 | web02                                                          |\n| os-extended-volumes:volumes_attached | []                                                             |\n| progress                             | 0                                                              |\n| security_groups                      | sg-all-from-console, sg-web-from-internet, sg-all-from-app-net |\n| status                               | BUILD                                                          |\n| tenant_id                            | 106e169743964758bcad1f06cc69c472                               |\n| updated                              | 2015-03-24T06:33:36Z                                           |\n| user_id                              | 98dd78b670884b64b879568215777c53                               |\n+--------------------------------------+----------------------------------------------------------------+\n\n\u300cdmz-net=192.168.0.6\u300d\u304c\u5272\u308a\u632f\u3089\u308c\u305f\u3002\n[root@step-server 06]# nova list --field name,networks | grep web02\n| d0ce0d2a-f4fa-448d-bb9b-b605af386b9f | web02       | dmz-net=192.168.0.6; app-net=172.16.10.4                      |\n\nweb02\u306b\u30ed\u30b0\u30a4\u30f3\u3057endpoint.conf\u3092\u4fee\u6b63\u3059\u308b\u3002\u4eca\u56de\u306e\u74b0\u5883\u3067\u306fapp01\u306b\u306f\u300capp-net=172.16.10.3\u300d\u304c\u5272\u308a\u632f\u3089\u308c\u3066\u3044\u308b\u306e\u3067rest_host\u306b\u6307\u5b9a\u3059\u308b\u3002web01\u306e\u6642\u3068\u540c\u3058\u3067\u3042\u308b\u3002\n[root@step-server ~]# ssh -i key-for-internal.pem root@192.168.0.6\n[root@web02 ~]#\n\n[root@web02 ~]# cat /root/sample-app/endpoint.conf\n[rest-server]\nrest_host = 172.16.10.3\nrest_endpoint = http://%(rest_host)s:5555/bbs\n\n[db-server]\ndb_host = localhost\ndb_endpoint = mysql://user:password@%(db_host)s/sample_bbs?charset=utf8\n\n\u30b9\u30ca\u30c3\u30d7\u30b7\u30e7\u30c3\u30c8\u3092\u53d6\u308b\u305f\u3081\u306bshutdown\u3059\u308b\u3002\n\u5b8c\u4e86\u3092\u78ba\u8a8d\u3057\u300cnova image-create\u300d\u3067\u30b9\u30ca\u30c3\u30d7\u30b7\u30e7\u30c3\u30c8\u3092\u4f5c\u6210\u3059\u308b\u3002\u300cnova list\u300d\u3067\u5b8c\u4e86\u3092\u5f85\u3064\u3002\n[root@web02 ~]# shutdown -h now\n[root@web02 ~]#\nBroadcast message from root@web02\n        (/dev/pts/0) at 15:48 ...\n\nThe system is going down for halt NOW!\nConnection to 192.168.0.6 closed by remote host.\nConnection to 192.168.0.6 closed.\n\n[root@step-server ~]# nova list --name web02 --field name,power_state\n+--------------------------------------+-------+-------------+\n| ID                                   | Name  | Power State |\n+--------------------------------------+-------+-------------+\n| d0ce0d2a-f4fa-448d-bb9b-b605af386b9f | web02 | Shutdown    |\n+--------------------------------------+-------+-------------+\n\n[root@step-server ~]# nova image-create web02 web-base-v1.0\n\n[root@step-server ~]# nova list --name web02 --field name,task_state\n+--------------------------------------+-------+----------------------+\n| ID                                   | Name  | Task State           |\n+--------------------------------------+-------+----------------------+\n| d0ce0d2a-f4fa-448d-bb9b-b605af386b9f | web02 | image_pending_upload |\n+--------------------------------------+-------+----------------------+\n\n[root@step-server ~]# nova list --name web02 --field name,task_state\n+--------------------------------------+-------+------------+\n| ID                                   | Name  | Task State |\n+--------------------------------------+-------+------------+\n| d0ce0d2a-f4fa-448d-bb9b-b605af386b9f | web02 | None       |\n+--------------------------------------+-------+------------+\n\nglance\u306b\u30a4\u30e1\u30fc\u30b8web-base-v1.0\u304c\u8ffd\u52a0\u3055\u308c\u3066\u3044\u308b\u3002\n[root@step-server ~]# glance image-list\n+--------------------------------------+--------------------------+-------------+------------------+------------+--------+\n| ID                                   | Name                     | Disk Format | Container Format | Size       | Status |\n+--------------------------------------+--------------------------+-------------+------------------+------------+--------+\n| 098f948e-e80b-4b1a-8a46-f8d2dd57e149 | centos-base              | qcow2       | bare             | 633235456  | active |\n| 39fb3a6e-e543-4bfe-8ff7-a948acd1c7a3 | cirros-0.3.3-x86_64-disk | qcow2       | bare             | 13200896   | active |\n| 362ae42a-1e46-4de4-afd9-af57965f1b3f | web-base-v1.0            | qcow2       | bare             | 1799749632 | active |\n+--------------------------------------+--------------------------+-------------+------------------+------------+--------+\n\nweb02\u3092\u8d77\u52d5\u3057\u3001\u305d\u306e\u4e2d\u306e\u30a2\u30d7\u30ea\u3082\u958b\u59cb\u3057\u3066\u304a\u304f\u3002\n[root@step-server ~]# nova start web02\n[root@step-server ~]# ssh -i key-for-internal.pem root@192.168.0.6\n\n[root@web02 ~]# sh /root/sample-app/server-setup/web.init.sh start\nStarting web.py                                            [  OK  ]\n[root@web02 ~]# exit\nlogout\nConnection to 192.168.0.6 closed.\n\n\n7.3.3 \u30b9\u30ca\u30c3\u30d7\u30b7\u30e7\u30c3\u30c8\u304b\u3089\u306e\u4eee\u60f3\u30de\u30b7\u30f3\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u8d77\u52d5\nweb-base-v1.0\u304b\u3089web03\u3092\u8d77\u52d5\u3059\u308b\u3002\n\u5c0e\u5165\u3084\u8a2d\u5b9a\u306f\u5b8c\u4e86\u3057\u3066\u3044\u308b\u306e\u3067\u3001userdata\u306e\u4e2d\u8eab\u306f\u3001\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u8d77\u52d5\u306e\u307f\u3002\n\u4f5c\u6210\u30b9\u30af\u30ea\u30d7\u30c8\u306f\u3053\u3061\u3089\u306b\u7528\u610f\u3055\u308c\u3066\u3044\u308b\u304c\u300c\"\u300d\u3067\u56f2\u308f\u308c\u3066\u3044\u305f\u306e\u3067\u6b63\u5e38\u306b\u52d5\u4f5c\u3057\u306a\u304b\u3063\u305f\u3002\u672c\u6587\u306b\u306f\u300c'\u300d\u3067\u8a18\u8f09\u3055\u308c\u3066\u3044\u308b\u306e\u3067\u3001\u305d\u308c\u306b\u5f93\u3046\u3002\n\u3082\u3061\u308d\u3093\u4e8b\u524d\u306b\u7528\u610f\u3082\u3055\u308c\u3066\u3044\u308b\u3002\n[root@step-server ~]# echo '#!/bin/bash' > userdata_web03.txt\n[root@step-server ~]# echo 'sh /root/sample-app/server-setup/web.init.sh start' >> userdata_web03.txt\n\n\u300c--image \"web-base-v1.0\"\u300d\u3067\u30b9\u30ca\u30c3\u30d7\u30b7\u30e7\u30c3\u30c8\u304b\u3089\u8d77\u52d5\u3059\u308b\u3002\n[root@step-server 07]# nova boot --flavor standard.xsmall --image \"web-base-v1.0\" \\\n> --key-name key-for-internal --user-data userdata_web03.txt \\\n> --security-groups sg-all-from-console,sg-web-from-internet,sg-all-from-app-net \\\n> --availability-zone az1 \\\n> --nic net-id=${MY_DMZ_NET} --nic net-id=${MY_APP_NET} \\\n> web03\n+--------------------------------------+----------------------------------------------------------------+\n| Property                             | Value                                                          |\n+--------------------------------------+----------------------------------------------------------------+\n| OS-DCF:diskConfig                    | MANUAL                                                         |\n| OS-EXT-AZ:availability_zone          | nova                                                           |\n| OS-EXT-STS:power_state               | 0                                                              |\n| OS-EXT-STS:task_state                | scheduling                                                     |\n| OS-EXT-STS:vm_state                  | building                                                       |\n| OS-SRV-USG:launched_at               | -                                                              |\n| OS-SRV-USG:terminated_at             | -                                                              |\n| accessIPv4                           |                                                                |\n| accessIPv6                           |                                                                |\n| adminPass                            | Psxv5AkAVm4L                                                   |\n| config_drive                         |                                                                |\n| created                              | 2015-03-24T07:14:27Z                                           |\n| flavor                               | standard.xsmall (100)                                          |\n| hostId                               |                                                                |\n| id                                   | 5e8fb496-f248-42e4-a6d9-997fd6307402                           |\n| image                                | web-base-v1.0 (362ae42a-1e46-4de4-afd9-af57965f1b3f)           |\n| key_name                             | key-for-internal                                               |\n| metadata                             | {}                                                             |\n| name                                 | web03                                                          |\n| os-extended-volumes:volumes_attached | []                                                             |\n| progress                             | 0                                                              |\n| security_groups                      | sg-all-from-console, sg-web-from-internet, sg-all-from-app-net |\n| status                               | BUILD                                                          |\n| tenant_id                            | 106e169743964758bcad1f06cc69c472                               |\n| updated                              | 2015-03-24T07:14:28Z                                           |\n| user_id                              | 98dd78b670884b64b879568215777c53                               |\n+--------------------------------------+----------------------------------------------------------------+\n\nweb03\u304c\u8d77\u52d5\u3057\u3066\u304d\u305f\u3002\n[root@step-server 07]# nova list --field name,networks\n+--------------------------------------+-------------+---------------------------------------------------------------+\n| ID                                   | Name        | Networks                                                      |\n+--------------------------------------+-------------+---------------------------------------------------------------+\n| 35d338e5-6e8a-4cee-9be1-9a37b431bf38 | app01       | dmz-net=192.168.0.3; app-net=172.16.10.3; dbs-net=172.16.20.1 |\n| edf1b599-de4f-4b2c-be90-17ab1252728f | dbs01       | dmz-net=192.168.0.4; dbs-net=172.16.20.3                      |\n| 37cbd237-9fd9-4f95-b4e3-caafeaf67454 | lbs01       | dmz-net=192.168.0.5                                           |\n| 65d3400d-3467-4563-9ff5-9c0e30c7157e | step-server | work-net=10.0.0.1, 192.168.100.131                            |\n| ca755522-3eb2-475a-8e37-7fe23398b1d9 | web01       | dmz-net=192.168.0.1, 192.168.100.133; app-net=172.16.10.1     |\n| d0ce0d2a-f4fa-448d-bb9b-b605af386b9f | web02       | dmz-net=192.168.0.6; app-net=172.16.10.4                      |\n| 5e8fb496-f248-42e4-a6d9-997fd6307402 | web03       | dmz-net=192.168.0.7; app-net=172.16.10.5                      |\n+--------------------------------------+-------------+---------------------------------------------------------------+\n\n\n7.3.4 metadata\u3092\u5229\u7528\u3057\u305f\u8a2d\u5b9a\n\u307e\u305a\u306fmetadata\u30b5\u30fc\u30d0\u30fc\u300chttp://169.254.169.254\u300d\u306b\u3064\u3044\u3066\u3002\n\u3053\u308c\u307e\u3067\u300cnova boot\u300d\u3059\u308b\u6642\u306b\u300c--user-data\u300d\u3067\u8d77\u52d5\u5f8c\u306e\u5b9f\u884c\u5185\u5bb9\u3092\u30b7\u30a7\u30eb\u3067\u66f8\u3044\u3066\u6e21\u3057\u3066\u6765\u305f\u3002\n\u4eee\u60f3\u30de\u30b7\u30f3\u306f\u3001\u8d77\u52d5\u5f8c\u306b\u7279\u5225\u306a\u30a2\u30c9\u30ec\u30b9\u300chttp://169.254.169.254/latest/user-data/\u300d\u306b\u30a2\u30af\u30bb\u30b9\u3057\u3066\u3001\u3053\u308c\u3092\u53d6\u308a\u51fa\u3059\u3089\u3057\u3044\u3002\n\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u7528\u306b\u4f5c\u3063\u305fweb02\u3067\u78ba\u8a8d\u3059\u308b\u3002web01/02\u7528\u306euserdata\u304c\u78ba\u8a8d\u3067\u304d\u308b\u3002\n[root@web02 ~]#  curl http://169.254.169.254/openstack/latest/user_data\n#!/bin/bash\ncp /usr/share/zoneinfo/Asia/Tokyo /etc/localtime\ncd /root\ngit clone -q https://github.com/josug-book1-materials/sample-app.git\ncd sample-app\ngit checkout -b v1.0 remotes/origin/v1.0\nsh /root/sample-app/server-setup/install_web.sh\n\nweb03\u306f\u30b9\u30ca\u30c3\u30d7\u30b7\u30e7\u30c3\u30c8\u304b\u3089\u306e\u8d77\u52d5\u306e\u305f\u3081\u30a2\u30d7\u30ea\u306e\u958b\u59cb\u3060\u3051\u3092userdata\u306b\u6307\u5b9a\u3057\u305f\u3002\u540c\u3058URL\u306b\u3082\u304b\u304b\u308f\u3089\u305aweb03\u5c02\u7528\u306euserdata\u304c\u53d6\u5f97\u3055\u308c\u305f\u3002\n[root@step-server ~]# ssh -i key-for-internal.pem root@192.168.0.7\n[root@web03 ~]# curl http://169.254.169.254/openstack/latest/user_data\n#!/bin/bash\nsh /root/sample-app/server-setup/web.init.sh start\n\nmetadata\u306e\u5834\u5408\u306f\u300cnova boot\u300d\u306b\u300c--mata key=value\u300d\u306e\u5f62\u5f0f\u3067\u6307\u5b9a\u3059\u308b\u3002\u3053\u306e\u5834\u5408\u3001\u4e0b\u8a18\u306e\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3068json\u5f62\u5f0f\u3067\u4eee\u60f3\u30de\u30b7\u30f3\u5074\u304b\u3089\u30a2\u30af\u30bb\u30b9\u3067\u304d\u308b\u3089\u3057\u3044\u3002\nhttp://169.254.169.254/openstack/latest/meta_data.json\n\u4f55\u3082\u6307\u5b9a\u3057\u306a\u304b\u3063\u305fweb03\u3067\u3082\u3053\u306e\u3088\u3046\u306a\u3082\u306e\u304c\u53d6\u5f97\u3055\u308c\u305f(\u8aad\u307f\u3084\u3059\u3044\u3088\u3046\u306b\u6539\u884c\u6e08\u307f)\u3002\n[root@web03 ~]# curl http://169.254.169.254/openstack/latest/meta_data.json\n{\n \"random_seed\": \"QXM9bT4Sm3tkoCADO (\u4e2d\u7565) TOgIJWKjLbLdrUR3mVKoU=\",\n \"uuid\": \"5e8fb496-f248-42e4-a6d9-997fd6307402\",\n \"availability_zone\": \"az1\",\n \"hostname\": \"web03.novalocal\",\n \"launch_index\": 0,\n \"public_keys\": \n  {\n   \"key-for-internal\": \"ssh-rsa AAAAB3NzaC1y (\u4e2d\u7565) XiIII1yd2MrwXcCn Generated-by-Nova\\n\"\n  },\n \"name\": \"web03\"\n}\n\n\u4eca\u56de\u3001\u5b9f\u884c\u3055\u308c\u308b\u306e\u306f\u4e0b\u8a18\u306e\u3068\u304a\u308a\u3067\u3042\u308b\u3002\n\n\u300cnova boot\u300d\u306b\u300c--meta rest-ip=${MY_REST_IP}\u300d\u306e\u3088\u3046\u306b\u6307\u5b9a\u3059\u308b\u3002\n\u4eee\u60f3\u30de\u30b7\u30f3\u3067\u306fuserdata\u306e\u5b9f\u884c\u4e2d\u306bhttp://169.254.169.254/openstack/latest/meta_data.json\u306b\u30a2\u30af\u30bb\u30b9\u3057\u3001\u5024\u3092json\u3067\u53d6\u5f97\u3059\u308b\u3002\njson\u304b\u3089\u30ad\u30fc\u300crest-ip\u300d\u306e\u5024\u3092\u53d6\u308a\u51fa\u3059\u3002\nsed\u3067endpoint.conf\u306e127.0.0.1\u3092\u3053\u306e\u5024\u306b\u66f8\u304d\u63db\u3048\u308b\u3002\n\n\u3053\u308c\u3092\u5b9f\u73fe\u3059\u308buserdata\u306fuserdata_web_auto_setting.txt\u306e\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u308b\u3002\n\u307e\u305a\u3001\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u306eUUID\u3084App\u30b5\u30fc\u30d0\u30fc\u306eIP\u3092\u53d6\u5f97\u3059\u308b\u3002\n[root@step-server ~]# function get_uuid () { cat - | grep \" id \" | awk '{print $4}'; }\n[root@step-server ~]# export MY_DMZ_NET=`neutron net-show dmz-net | get_uuid`\n[root@step-server ~]# export MY_APP_NET=`neutron net-show app-net | get_uuid`\n[root@step-server ~]# export MY_REST_IP=`nova show app01 |grep \" app-net\" |awk '{print $5}'`\n[root@step-server ~]# env | grep MY_\nMY_APP_NET=7d3828af-2da1-4e10-a904-f9e03b28e181\nMY_DMZ_NET=35e4baac-7230-4232-9644-856874dfe8af\nMY_REST_IP=172.16.10.3\n\n\u300c--meta rest_ip=${MY_REST_IP}\u300d\u3092\u4ed8\u3051\u3066\u300cnova boot\u300d\u3059\u308b\u3002\n[root@step-server 07]# nova boot --flavor standard.xsmall --image \"centos-base\" \\\n> --key-name key-for-internal --user-data userdata_web_auto_setting.txt \\\n> --security-groups sg-all-from-console,sg-web-from-internet,sg-all-from-app-net \\\n> --availability-zone az1 \\\n> --nic net-id=${MY_DMZ_NET} --nic net-id=${MY_APP_NET} \\\n> --meta rest_ip=${MY_REST_IP} \\\n> web04\n+--------------------------------------+----------------------------------------------------------------+\n| Property                             | Value                                                          |\n+--------------------------------------+----------------------------------------------------------------+\n| OS-DCF:diskConfig                    | MANUAL                                                         |\n| OS-EXT-AZ:availability_zone          | nova                                                           |\n| OS-EXT-STS:power_state               | 0                                                              |\n| OS-EXT-STS:task_state                | scheduling                                                     |\n| OS-EXT-STS:vm_state                  | building                                                       |\n| OS-SRV-USG:launched_at               | -                                                              |\n| OS-SRV-USG:terminated_at             | -                                                              |\n| accessIPv4                           |                                                                |\n| accessIPv6                           |                                                                |\n| adminPass                            | bBUeoqUWWH88                                                   |\n| config_drive                         |                                                                |\n| created                              | 2015-03-25T05:07:24Z                                           |\n| flavor                               | standard.xsmall (100)                                          |\n| hostId                               |                                                                |\n| id                                   | 1955e438-626f-4582-8d15-bfe13b97a084                           |\n| image                                | centos-base (098f948e-e80b-4b1a-8a46-f8d2dd57e149)             |\n| key_name                             | key-for-internal                                               |\n| metadata                             | {\"rest_ip\": \"172.16.10.3\"}                                     |\n| name                                 | web04                                                          |\n| os-extended-volumes:volumes_attached | []                                                             |\n| progress                             | 0                                                              |\n| security_groups                      | sg-all-from-console, sg-web-from-internet, sg-all-from-app-net |\n| status                               | BUILD                                                          |\n| tenant_id                            | 106e169743964758bcad1f06cc69c472                               |\n| updated                              | 2015-03-25T05:07:25Z                                           |\n| user_id                              | 98dd78b670884b64b879568215777c53                               |\n+--------------------------------------+----------------------------------------------------------------+\n\n\u3053\u308c\u3067\u3001web\u30b5\u30fc\u30d0\u30fc\u306f4\u3064\u3067\u304d\u305f\u3002\n[root@step-server 07]# nova list --name web* --field name,networks\n+--------------------------------------+-------+-----------------------------------------------------------+\n| ID                                   | Name  | Networks                                                  |\n+--------------------------------------+-------+-----------------------------------------------------------+\n| ca755522-3eb2-475a-8e37-7fe23398b1d9 | web01 | dmz-net=192.168.0.1, 192.168.100.133; app-net=172.16.10.1 |\n| d0ce0d2a-f4fa-448d-bb9b-b605af386b9f | web02 | dmz-net=192.168.0.6; app-net=172.16.10.4                  |\n| 5e8fb496-f248-42e4-a6d9-997fd6307402 | web03 | dmz-net=192.168.0.7; app-net=172.16.10.5                  |\n| 1955e438-626f-4582-8d15-bfe13b97a084 | web04 | dmz-net=192.168.0.8; app-net=172.16.10.6                  |\n+--------------------------------------+-------+-----------------------------------------------------------+\n\nweb04\u306b\u5165\u3063\u3066\u6e21\u3055\u308c\u305fuserdata\u306e\u78ba\u8a8d\u3002\n[root@step-server ~]# ssh -i key-for-internal.pem root@192.168.0.8\n[root@web04 ~]# curl http://169.254.169.254/openstack/latest/user_data\n#!/bin/bash\ncp /usr/share/zoneinfo/Asia/Tokyo /etc/localtime\ncd /root\ngit clone https://github.com/josug-book1-materials/sample-app.git\ncd sample-app\ngit checkout -b v1.0 remotes/origin/v1.0\nsh /root/sample-app/server-setup/install_web.sh\n\nMY_REST_IP=`curl -S -s http://169.254.169.254/openstack/latest/meta_data.json \\\n| python -c \\\n\"import json,sys; print json.load(sys.stdin).get('meta').get('rest_ip')\"`\n\nsed -i -e \"s/rest_host = 127.0.0.1/rest_host = ${MY_REST_IP:?}/\" \\\n/root/sample-app/endpoint.conf\n\nsh /root/sample-app/server-setup/web.init.sh start\n\nmata_data.json\u306e\u78ba\u8a8d\u3002\u300cmeta\u300d\u306e\u300crest_ip\u300d\u306bapp01\u306e\u30a2\u30c9\u30ec\u30b9\u304c\u6e21\u3063\u3066\u3044\u308b\u3002\n[root@web04 ~]# curl http://169.254.169.254/openstack/latest/meta_data.json\n{\n  \"random_seed\": \"9isqFeB5tivwrp5xof (\u4e2d\u7565) CTWF4xuBlNkh4HScfdDLI=\", \n  \"uuid\": \"1955e438-626f-4582-8d15-bfe13b97a084\", \n  \"availability_zone\": \"az1\", \n  \"hostname\": \"web04.novalocal\", \n  \"launch_index\": 0, \n  \"meta\": \n  {\n    \"rest_ip\": \"172.16.10.3\"\n  }, \n  \"public_keys\": \n  {\n    \"key-for-internal\": \"ssh-rsa AAAAB3NzaC1yc2Cg (\u4e2d\u7565) 5Hyd2MrwXcCn Generated-by-Nova\\n\"\n  }, \n  \"name\": \"web04\"}\n\n\u5148\u307b\u3069\u306euserdata_web_auto_setting.txt\u3067\u306f\u3001curl\u3067\u3053\u306ejson\u3092\u53d6\u308a\u51fa\u3057\u3001python\u3067json\u304b\u3089rest_ip\u306e\u5024\u3092\u53d6\u308a\u51fa\u3057\u3001sed\u3067rest_host\u306e\u884c\u3092\u7f6e\u304d\u63db\u3048\u3066\u3044\u308b\u3002\n\n7.4 \u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b5\u30fc\u3078\u306e\u30a8\u30f3\u30c8\u30ea\u30fc\u306e\u8ffd\u52a0\nlbs01\u306b\u30ed\u30b0\u30a4\u30f3\u3057\u3066web02-04\u3092\u8ffd\u52a0\u3057\u3001nginx \u3092\u518d\u8d77\u52d5\u3059\u308b\u3002\n[root@lbs01 ~]# cat /etc/nginx/conf.d/lbs.conf\nupstream web-server {\n  server 192.168.0.1:80;\n  server 192.168.0.6:80;\n  server 192.168.0.7:80;\n  server 192.168.0.8:80;\n}\n\nserver {\n  listen 80 default_server;\n  server_name _;\n\n  location / {\n    proxy_pass http://web-server/;\n  }\n}\n\n[root@lbs01 ~]# service nginx restart\nStopping nginx:                                            [  OK  ]\nStarting nginx:                                            [  OK  ]\n\nlbs01\u30678\u56de\u306e\u30ea\u30af\u30a8\u30b9\u30c8\u3092\u5b9f\u65bd\u3002\u4e0d\u7cbe\u3092\u3057\u3066lbs01\u4e0a\u3067127.0.0.1\u3067\u30a2\u30af\u30bb\u30b9\u3002\n[root@lbs01 ~]# for i in {1..8}; do curl http://127.0.0.1/; sleep 2; done\n\n\u672c\u65e5\u4ed8\u3051\u3067\u5404\u30b5\u30fc\u30d0\u30fc\u306b2\u56de\u3065\u3064\u306e\u30a2\u30af\u30bb\u30b9\u304c\u78ba\u8a8d\u3067\u304d\u308b\u3002\n[root@step-server ~]# ssh -i key-for-internal.pem root@192.168.0.1\n[root@web01 ~]# tail sample-app/web.log\n127.0.0.1 - - [24/Mar/2015 12:14:32] \"GET / HTTP/1.1\" 200 -\n192.168.100.1 - - [24/Mar/2015 13:10:14] \"GET / HTTP/1.1\" 200 -\n192.168.100.1 - - [24/Mar/2015 13:12:27] \"GET / HTTP/1.0\" 200 -\n192.168.100.1 - - [24/Mar/2015 13:12:27] \"GET /favicon.ico HTTP/1.0\" 404 -\n192.168.100.1 - - [24/Mar/2015 13:12:58] \"POST / HTTP/1.0\" 302 -\n192.168.100.1 - - [24/Mar/2015 13:12:58] \"GET / HTTP/1.0\" 200 -\n192.168.100.1 - - [24/Mar/2015 13:21:24] \"GET / HTTP/1.0\" 200 -\n192.168.0.5 - - [24/Mar/2015 15:07:02] \"GET / HTTP/1.0\" 200 -\n192.168.0.5 - - [25/Mar/2015 14:39:34] \"GET / HTTP/1.0\" 200 -\n192.168.0.5 - - [25/Mar/2015 14:39:43] \"GET / HTTP/1.0\" 200 -\n[root@web01 ~]# exit\nlogout\nConnection to 192.168.0.1 closed.\n\n[root@step-server ~]# ssh -i key-for-internal.pem root@192.168.0.6\n[root@web02 ~]# tail sample-app/web.log\n * Running on http://0.0.0.0:80/ (Press CTRL+C to quit)\n * Restarting with stat\n192.168.0.5 - - [25/Mar/2015 14:39:36] \"GET / HTTP/1.0\" 200 -\n192.168.0.5 - - [25/Mar/2015 14:39:44] \"GET / HTTP/1.0\" 200 -\n[root@web02 ~]# exit\nlogout\nConnection to 192.168.0.6 closed.\n\n[root@step-server ~]# ssh -i key-for-internal.pem root@192.168.0.7\n[root@web03 ~]# tail sample-app/web.log\n * Running on http://0.0.0.0:80/ (Press CTRL+C to quit)\n * Restarting with stat\n192.168.0.5 - - [25/Mar/2015 14:39:38] \"GET / HTTP/1.0\" 200 -\n192.168.0.5 - - [25/Mar/2015 14:39:46] \"GET / HTTP/1.0\" 200 -\n[root@web03 ~]# exit\nlogout\nConnection to 192.168.0.7 closed.\n\n[root@step-server ~]# ssh -i key-for-internal.pem root@192.168.0.8\n[root@web04 ~]# tail sample-app/web.log\n * Running on http://0.0.0.0:80/ (Press CTRL+C to quit)\n * Restarting with stat\n192.168.0.5 - - [25/Mar/2015 14:39:40] \"GET / HTTP/1.0\" 200 -\n192.168.0.5 - - [25/Mar/2015 14:39:48] \"GET / HTTP/1.0\" 200 -\n[root@web04 ~]# exit\nlogout\nConnection to 192.168.0.8 closed.\n\n\n7.5 Floating IP\u306e\u4ed8\u3051\u66ff\u3048\n\u516c\u958b\u7528\u306bweb01\u306b\u632f\u3089\u308c\u3066\u3044\u305fFloating IP\u300c192.168.100.133\u300d\u3092lbs01\u306b\u4ed8\u3051\u66ff\u3048\u308b\u3002\n[root@step-server ~]# nova list --name web01 --field name,networks\n+--------------------------------------+-------+-----------------------------------------------------------+\n| ID                                   | Name  | Networks                                                  |\n+--------------------------------------+-------+-----------------------------------------------------------+\n| ca755522-3eb2-475a-8e37-7fe23398b1d9 | web01 | dmz-net=192.168.0.1, 192.168.100.133; app-net=172.16.10.1 |\n+--------------------------------------+-------+-----------------------------------------------------------+\n\n[root@step-server ~]# nova floating-ip-disassociate web01 192.168.100.133\n[root@step-server ~]# nova floating-ip-associate lbs01 192.168.100.133\n\n[root@step-server ~]# nova list --name lbs01 --field name,networks\n+--------------------------------------+-------+--------------------------------------+\n| ID                                   | Name  | Networks                             |\n+--------------------------------------+-------+--------------------------------------+\n| 37cbd237-9fd9-4f95-b4e3-caafeaf67454 | lbs01 | dmz-net=192.168.0.5, 192.168.100.133 |\n+--------------------------------------+-------+--------------------------------------+\n\n\u516c\u958bIP\u306f\u5909\u66f4\u3055\u308c\u3066\u3044\u306a\u3044\u306e\u3067\u30016\u7ae0\u306e\u6700\u5f8c\u306b\u4f5c\u3063\u305fReverse Proxy\u7d4c\u7531\u3067\u306e\u30a2\u30af\u30bb\u30b9\u306f\u5909\u66f4\u3059\u308b\u5fc5\u8981\u306f\u306a\u3044\u3002\u305d\u306e\u307e\u307e\u306e\u69cb\u6210\u3067\u30a2\u30af\u30bb\u30b9\u3067\u304d\u308b\u3002\n\nlbs\u3067nginx\u306e\u30a2\u30af\u30bb\u30b9\u30ed\u30b0\u3092\u78ba\u8a8d\u3059\u308b\u3068\u3001\u3053\u3061\u3089\u3078\u306e\u30a2\u30af\u30bb\u30b9\u304c\u78ba\u8a8d\u3067\u304d\u308b\u3002\n[root@step-server ~]# ssh -i key-for-internal.pem root@192.168.0.5\n[root@lbs01 ~]# tail /var/log/nginx/access.log\n\n\n\u7b2c7\u7ae0\u304c\u5b8c\u4e86\u3057\u305f\u3002\n\n\u524d\u56de\u306f\u3053\u3061\u3089 - \u6b21\u56de\u306f\u3053\u3061\u3089\n[\u524d\u56de\u306f\u3053\u3061\u3089](http://qiita.com/orz/items/5b68ecc57e2afb936330) - [\u6b21\u56de\u306f\u3053\u3061\u3089](http://qiita.com/orz/items/b257046fd336850c52dc)\n***\n#\u3053\u308c\u306f\u306a\u306b\n[\u300cOpenStack\u30af\u30e9\u30a6\u30c9\u30a4\u30f3\u30c6\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3 \u30aa\u30fc\u30d7\u30f3\u30bd\u30fc\u30b9\u30af\u30e9\u30a6\u30c9\u306b\u3088\u308b\u30b5\u30fc\u30d3\u30b9\u69cb\u7bc9\u5165\u9580\u300d](http://www.shoeisha.co.jp/book/detail/9784798139784)\u306e\u5b9f\u7fd2\u3092SoftLayer\u306e\u7121\u6599\u30d9\u30a2\u30e1\u30bf\u30eb\u3067\u884c\u3046\u8a18\u9332\u3067\u3042\u308b\u3002\n![OpenStack\u30af\u30e9\u30a6\u30c9\u30a4\u30f3\u30c6\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3 \u30aa\u30fc\u30d7\u30f3\u30bd\u30fc\u30b9\u30af\u30e9\u30a6\u30c9\u306b\u3088\u308b\u30b5\u30fc\u30d3\u30b9\u69cb\u7bc9\u5165\u9580](http://www.seshop.com/static/images/product/17681/L.png)\n\n# \u7b2c7\u7ae0 \u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u8ca0\u8377\u5206\u6563\n\n\u7b2c5\u7ae0\u304b\u3089\u7b2c10\u7ae0\u307e\u3067\u306e\u652f\u63f4\u30d5\u30a1\u30a4\u30eb\u306f\u3053\u3061\u3089\u3002\u307e\u3068\u3081\u3066git\u3067\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3067\u304d\u308b\u3002\nhttps://github.com/josug-book1-materials/chapter05-10\n<br/>\u7b2c7\u7ae0\u306e\u652f\u63f4\u30d5\u30a1\u30a4\u30eb\u306f\u3053\u3061\u3089\u3067\u3042\u308b\u3002\nhttps://github.com/josug-book1-materials/chapter05-10/tree/master/07\n<br/>\u524d\u56de\u3068\u540c\u69d8\u306b\u7b2c7\u7ae0\u306e\u3059\u3079\u3066\u306e\u30b9\u30c6\u30c3\u30d7\u3092\u307e\u3068\u3081\u3066\u884c\u3046\u30b9\u30af\u30ea\u30d7\u30c8\u3082\u7528\u610f\u3055\u308c\u3066\u3044\u308b\u3002\nhttps://github.com/josug-book1-materials/chapter05-10/blob/master/07/build_chap07.sh\n\n\n## 7.1 \u8ca0\u8377\u5206\u6563\u51e6\u7406\u306e\u6d41\u308c\n\u3053\u306e\u7ae0\u3067\u306f[\u7b2c6\u7ae0](http://qiita.com/orz/items/5b68ecc57e2afb936330)\u3067\u69cb\u7bc9\u3057\u305f3\u5c64\u306eSNS\u30a2\u30d7\u30ea\u306e\u30d5\u30ed\u30f3\u30c8\u306b\u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b5\u30fc\u3092\u7acb\u3066\u3001Web\u30b5\u30fc\u30d0\u30fc\u3092\u5897\u8a2d\u3057\u3066\u305d\u306e\u914d\u4e0b\u306b\u52a0\u3048\u308b\u3002\u6700\u5f8c\u306b\u516c\u958b\u30a2\u30c9\u30ec\u30b9\u3067\u3042\u308bweb01\u306b\u3064\u3051\u3066\u3044\u305fFloting IP\u3092\u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b5\u30fc\u306b\u4ed8\u3051\u66ff\u3048\u308b\u3002\n\n## 7.2 \u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b5\u30fc\u306e\u69cb\u7bc9\n\n\u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b5\u30fclbs01\u3092\u69cb\u7bc9\u3057\u63a5\u7d9a\u306fweb01\u306b\u8ee2\u9001\u3059\u308b\u8a2d\u5b9a\u3092\u3059\u308b\u3002\n\n### 7.2.1 userdata\u30d5\u30a1\u30a4\u30eb\u306e\u4f5c\u6210\n\n\u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b5\u30fc\u306b\u306fnginx\u3092\u5229\u7528\u3059\u308b\u3002\n[userdata\u306f\u3053\u3061\u3089](https://github.com/josug-book1-materials/chapter05-10/blob/master/07/userdata_lbs.txt)\u3002nginx\u306e\u5c0e\u5165\u3068\u81ea\u52d5\u8d77\u52d5\u304c\u8a2d\u5b9a\u3055\u308c\u3066\u3044\u308b\u3002\n\n### 7.2.2 \u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b5\u30fc\u306e\u8d77\u52d5\n\n\u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b5\u30fc\u306fdmz-net\u306b\u63a5\u7d9a\u3055\u308c\u308b\u306e\u3067\u3001dmz-net\u306eUUID\u3092\u53d6\u5f97\u3057\u300cnova boot\u300d\u306b\u6307\u5b9a\u3057\u3066\u3044\u308b\u3002\n\n<pre>\n[root@step-server 07]# function get_uuid () { cat - | grep \" id \" | awk '{print $4}'; }\n[root@step-server 07]# export MY_DMZ_NET=`neutron net-show dmz-net | get_uuid`\n[root@step-server 07]# nova boot --flavor standard.xsmall --image \"centos-base\" \\\n> --key-name key-for-internal --user-data userdata_lbs.txt \\\n> --security-groups sg-all-from-console,sg-web-from-internet \\\n> --availability-zone az1 \\\n> --nic net-id=${MY_DMZ_NET} \\\n> lbs01\n+--------------------------------------+----------------------------------------------------+\n| Property                             | Value                                              |\n+--------------------------------------+----------------------------------------------------+\n| OS-DCF:diskConfig                    | MANUAL                                             |\n| OS-EXT-AZ:availability_zone          | nova                                               |\n| OS-EXT-STS:power_state               | 0                                                  |\n| OS-EXT-STS:task_state                | scheduling                                         |\n| OS-EXT-STS:vm_state                  | building                                           |\n| OS-SRV-USG:launched_at               | -                                                  |\n| OS-SRV-USG:terminated_at             | -                                                  |\n| accessIPv4                           |                                                    |\n| accessIPv6                           |                                                    |\n| adminPass                            | FLZDfBC57nW9                                       |\n| config_drive                         |                                                    |\n| created                              | 2015-03-24T05:40:19Z                               |\n| flavor                               | standard.xsmall (100)                              |\n| hostId                               |                                                    |\n| id                                   | 37cbd237-9fd9-4f95-b4e3-caafeaf67454               |\n| image                                | centos-base (098f948e-e80b-4b1a-8a46-f8d2dd57e149) |\n| key_name                             | key-for-internal                                   |\n| metadata                             | {}                                                 |\n| name                                 | lbs01                                              |\n| os-extended-volumes:volumes_attached | []                                                 |\n| progress                             | 0                                                  |\n| security_groups                      | sg-all-from-console, sg-web-from-internet          |\n| status                               | BUILD                                              |\n| tenant_id                            | 106e169743964758bcad1f06cc69c472                   |\n| updated                              | 2015-03-24T05:40:20Z                               |\n| user_id                              | 98dd78b670884b64b879568215777c53                   |\n+--------------------------------------+----------------------------------------------------+\n</pre>\n\nlbs01\u306b\u306f\u300cdmz-net=192.168.0.5\u300d\u304c\u5272\u308a\u632f\u3089\u308c\u305f\u3002\n\n<pre>\n[root@step-server 07]# nova list --field name,networks\n+--------------------------------------+-------------+---------------------------------------------------------------+\n| ID                                   | Name        | Networks                                                      |\n+--------------------------------------+-------------+---------------------------------------------------------------+\n| 35d338e5-6e8a-4cee-9be1-9a37b431bf38 | app01       | dmz-net=192.168.0.3; app-net=172.16.10.3; dbs-net=172.16.20.1 |\n| edf1b599-de4f-4b2c-be90-17ab1252728f | dbs01       | dmz-net=192.168.0.4; dbs-net=172.16.20.3                      |\n| 37cbd237-9fd9-4f95-b4e3-caafeaf67454 | lbs01       | dmz-net=192.168.0.5                                           |\n| 65d3400d-3467-4563-9ff5-9c0e30c7157e | step-server | work-net=10.0.0.1, 192.168.100.131                            |\n| ca755522-3eb2-475a-8e37-7fe23398b1d9 | web01       | dmz-net=192.168.0.1, 192.168.100.133; app-net=172.16.10.1     |\n+--------------------------------------+-------------+---------------------------------------------------------------+\n</pre>\n\nlbs01\u306eIP\u30a2\u30c9\u30ec\u30b9\u3092\u74b0\u5883\u5909\u6570$MY_LBS_IP\u306b\u30bb\u30c3\u30c8\u3057\u3066\u304a\u304f\u3002\n\n<pre>\n[root@step-server 07]# export MY_LBS_IP=`nova show lbs01 | grep \" dmz-net\" | awk '{print $5}'`\n[root@step-server 07]# echo $MY_LBS_IP\n192.168.0.5\n</pre>\n\nnginx\u304c\u8d77\u52d5\u3057\u3066\u3044\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3059\u308b\u3002\n\n```\n[root@step-server 07]# curl http://${MY_LBS_IP}\n<!DOCTYPE html>\n<html>\n<head>\n<title>Welcome to nginx!</title>\n<style>\n    body {\n\uff5e\uff5e\uff5e\uff5e\uff5e\uff5e\uff5e\uff5e\n```\n\n### 7.2.3 Nginx\u306e\u8a2d\u5b9a\n\nlbs01\u306b\u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b5\u30fc\u7528\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3059\u308b\u3002\n\u307e\u305a\u3001lbs01\u306b\u30ed\u30b0\u30a4\u30f3\u3059\u308b\u3002\n\n```\n[root@step-server ~]# ssh -i key-for-internal.pem root@${MY_LBS_IP}\n[root@lbs01 ~]#\n```\n\n\u69cb\u6210\u30d5\u30a1\u30a4\u30eb/etc/nginx/conf.d/lbs.conf\u3092\u3001\u4e0b\u8a18\u306e\u3088\u3046\u306b\u4f5c\u6210\u3059\u308b\u3002server\u306eIP\u300c192.168.0.1\u300d\u306f\u3001web01\u306e\u300cdmz-net=192.168.0.1\u300d\u306e\u5272\u308a\u632f\u308a\u3067\u3042\u308b\u3002\n\n```\n[root@lbs01 ~]# cat /etc/nginx/conf.d/lbs.conf\nupstream web-server {\n  server 192.168.0.1:80;\n}\n\nserver {\n  listen 80 default_server;\n  server_name _;\n\n  location / {\n    proxy_pass http://web-server/;\n  }\n}\n```\n\n\u69cb\u6210\u3092\u78ba\u8a8d\u3057\u3066\u518d\u8d77\u52d5\u3059\u308b\u3002\n\n```\n[root@lbs01 ~]# service nginx configtest\nnginx: the configuration file /etc/nginx/nginx.conf syntax is ok\nnginx: configuration file /etc/nginx/nginx.conf test is successful\n[root@lbs01 ~]# service nginx restart\nStopping nginx:                                            [  OK  ]\nStarting nginx:                                            [  OK  ]\n```\n\n### 7.2.4 \u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b5\u30fc\u7d4c\u7531\u3067\u306e\u30a2\u30af\u30bb\u30b9\u78ba\u8a8d\n\n\u8e0f\u307f\u53f0\u30b5\u30fc\u30d0\u30fc\u306b\u623b\u308a\u3001lbs01\u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3002\n\u5148\u307b\u3069\u306f\u300cWelcome to nginx!\u300d\u3060\u3063\u305f\u304c\u3001\u4eca\u56de\u306f\u7b2c6\u7ae0\u306e\u52d5\u4f5c\u78ba\u8a8d\u3067\u66f8\u304d\u8fbc\u3093\u3060\u300c6\u7ae0\u306e\u7d42\u4e86\u300d\u304c\u8868\u793a\u3055\u308c\u3066\u3044\u308b\u3002\u30a2\u30d7\u30ea\u306b\u63a5\u7d9a\u3067\u304d\u3066\u3044\u308b\u3088\u3046\u3067\u3042\u308b\u3002\n\n```\n[root@step-server ~]# curl http://${MY_LBS_IP}\n<!doctype html>\n<html>\n  <head>\n    <meta http-equiv=\"Content-Type\" content=\"text/html; charset=UTF-8\">\n    <title></title>\n  </head>\n  <body>\n    <form method=\"POST\" action=\"/\">\n      <label for=\"text\">Please write something and hit enter</label> <input id=\"text\" name=\"text\" type=\"text\" value=\"\">\n    </form>\n    <br/>\n            <table class=\"contents\">\n                    <tr>\n                        <td>2015-03-24 13:12:57</td>\n                        <td>6\u7ae0\u306e\u7d42\u4e86</td>\n                    </tr>\n            </table>\n  </body>\n</html>\n```\n\n## 7.3 Web\u30b5\u30fc\u30d0\u30fc\u306e\u30c7\u30d7\u30ed\u30a4\n\n### 7.3.1 WEB\u30b5\u30fc\u30d0\u30fc\u69cb\u7bc9\u65b9\u6cd5\u306e\u6574\u7406\n\n\u3053\u306e\u7bc0\u3067\u5b9f\u884c\u3059\u308bWEB\u30b5\u30fc\u30d0\u30fc\u69cb\u7bc9\u65b9\u6cd5\u306e\u6574\u7406\u3067\u3042\u308b\u3002\nweb01\u306fgit\u304b\u3089\u30a2\u30d7\u30ea\u3092\u5c0e\u5165\u5f8c\u3001(1)endpoint.conf\u306bapp\u30b5\u30fc\u30d0\u30fc\u306eIP\u3092\u6307\u5b9a\u3057\u3001(2)web.init.sh\u306e\u5b9f\u884c\u3067\u30a2\u30d7\u30ea\u3092\u8d77\u52d5\u3057\u305f\u3002\n\u3053\u3053\u3067\u306f(1)\u306f\u74b0\u5883\u6bce\u306b\u8a2d\u5b9a\u304c\u7570\u306a\u308b\u9805\u76ee\u3067\u3042\u308b\u3001\u3053\u306e\u65b9\u6cd5\u3068\u3057\u3066\u4e0b\u8a18\u306e\u3075\u305f\u3064\u306e\u65b9\u6cd5\u3092\u8a66\u3059\u3002\n\n0. endpoint.conf\u306b\u73fe\u884capp\u30b5\u30fc\u30d0\u30fc\u306eIP\u3092\u6307\u5b9a\u3057\u305f\u30b5\u30fc\u30d0\u30fc\u3092\u69cb\u7bc9\u3057\u30b9\u30ca\u30c3\u30d7\u30b7\u30e7\u30c3\u30c8\u3092\u3001\u8ffd\u52a0web\u30b5\u30fc\u30d0\u30fc\u306e\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u3068\u3059\u308b\u3002\n0. metadata\u6a5f\u80fd\u3092\u4f7f\u3063\u3066\u30c7\u30d7\u30ed\u30a4\u6642\u306bapp\u30b5\u30fc\u30d0\u30fc\u306eIP\u3092\u53d6\u5f97\u3057\u3001\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092\u66f4\u65b0\u3059\u308b\u3002\n\n### 7.3.2 \u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u3068\u306a\u308bweb02\u306e\u69cb\u7bc9\n\n\u69cb\u7bc9\u624b\u9806\u306fweb01\u3068\u540c\u69d8\u3067\u3042\u308b\u3002\u9055\u3046\u3068\u3053\u308d\u306f\u540d\u524d\u304cweb02\u3002\n\n<pre>\n[root@step-server 06]# function get_uuid () { cat - | grep \" id \" | awk '{print $4}'; }\n[root@step-server 06]# export MY_DMZ_NET=`neutron net-show dmz-net | get_uuid`\n[root@step-server 06]# export MY_APP_NET=`neutron net-show app-net | get_uuid``\n[root@step-server 06]# nova boot --flavor standard.xsmall --image \"centos-base\" \\\n> --key-name key-for-internal --user-data userdata_web.txt \\\n> --security-groups sg-all-from-console,sg-web-from-internet,sg-all-from-app-net \\\n> --availability-zone az1 \\\n> --nic net-id=${MY_DMZ_NET} --nic net-id=${MY_APP_NET} \\\n> web02\n+--------------------------------------+----------------------------------------------------------------+\n| Property                             | Value                                                          |\n+--------------------------------------+----------------------------------------------------------------+\n| OS-DCF:diskConfig                    | MANUAL                                                         |\n| OS-EXT-AZ:availability_zone          | nova                                                           |\n| OS-EXT-STS:power_state               | 0                                                              |\n| OS-EXT-STS:task_state                | scheduling                                                     |\n| OS-EXT-STS:vm_state                  | building                                                       |\n| OS-SRV-USG:launched_at               | -                                                              |\n| OS-SRV-USG:terminated_at             | -                                                              |\n| accessIPv4                           |                                                                |\n| accessIPv6                           |                                                                |\n| adminPass                            | QmG6wRJZywdB                                                   |\n| config_drive                         |                                                                |\n| created                              | 2015-03-24T06:33:36Z                                           |\n| flavor                               | standard.xsmall (100)                                          |\n| hostId                               |                                                                |\n| id                                   | d0ce0d2a-f4fa-448d-bb9b-b605af386b9f                           |\n| image                                | centos-base (098f948e-e80b-4b1a-8a46-f8d2dd57e149)             |\n| key_name                             | key-for-internal                                               |\n| metadata                             | {}                                                             |\n| name                                 | web02                                                          |\n| os-extended-volumes:volumes_attached | []                                                             |\n| progress                             | 0                                                              |\n| security_groups                      | sg-all-from-console, sg-web-from-internet, sg-all-from-app-net |\n| status                               | BUILD                                                          |\n| tenant_id                            | 106e169743964758bcad1f06cc69c472                               |\n| updated                              | 2015-03-24T06:33:36Z                                           |\n| user_id                              | 98dd78b670884b64b879568215777c53                               |\n+--------------------------------------+----------------------------------------------------------------+\n</pre>\n\n\u300cdmz-net=192.168.0.6\u300d\u304c\u5272\u308a\u632f\u3089\u308c\u305f\u3002\n\n<pre>\n[root@step-server 06]# nova list --field name,networks | grep web02\n| d0ce0d2a-f4fa-448d-bb9b-b605af386b9f | web02       | dmz-net=192.168.0.6; app-net=172.16.10.4                      |\n</pre>\n\nweb02\u306b\u30ed\u30b0\u30a4\u30f3\u3057endpoint.conf\u3092\u4fee\u6b63\u3059\u308b\u3002\u4eca\u56de\u306e\u74b0\u5883\u3067\u306fapp01\u306b\u306f\u300capp-net=172.16.10.3\u300d\u304c\u5272\u308a\u632f\u3089\u308c\u3066\u3044\u308b\u306e\u3067rest_host\u306b\u6307\u5b9a\u3059\u308b\u3002web01\u306e\u6642\u3068\u540c\u3058\u3067\u3042\u308b\u3002\n\n<pre>\n[root@step-server ~]# ssh -i key-for-internal.pem root@192.168.0.6\n[root@web02 ~]#\n\n[root@web02 ~]# cat /root/sample-app/endpoint.conf\n[rest-server]\nrest_host = 172.16.10.3\nrest_endpoint = http://%(rest_host)s:5555/bbs\n\n[db-server]\ndb_host = localhost\ndb_endpoint = mysql://user:password@%(db_host)s/sample_bbs?charset=utf8\n</pre>\n\n\u30b9\u30ca\u30c3\u30d7\u30b7\u30e7\u30c3\u30c8\u3092\u53d6\u308b\u305f\u3081\u306bshutdown\u3059\u308b\u3002\n\u5b8c\u4e86\u3092\u78ba\u8a8d\u3057\u300cnova image-create\u300d\u3067\u30b9\u30ca\u30c3\u30d7\u30b7\u30e7\u30c3\u30c8\u3092\u4f5c\u6210\u3059\u308b\u3002\u300cnova list\u300d\u3067\u5b8c\u4e86\u3092\u5f85\u3064\u3002\n\n<pre>\n[root@web02 ~]# shutdown -h now\n[root@web02 ~]#\nBroadcast message from root@web02\n        (/dev/pts/0) at 15:48 ...\n\nThe system is going down for halt NOW!\nConnection to 192.168.0.6 closed by remote host.\nConnection to 192.168.0.6 closed.\n\n[root@step-server ~]# nova list --name web02 --field name,power_state\n+--------------------------------------+-------+-------------+\n| ID                                   | Name  | Power State |\n+--------------------------------------+-------+-------------+\n| d0ce0d2a-f4fa-448d-bb9b-b605af386b9f | web02 | Shutdown    |\n+--------------------------------------+-------+-------------+\n\n[root@step-server ~]# nova image-create web02 web-base-v1.0\n\n[root@step-server ~]# nova list --name web02 --field name,task_state\n+--------------------------------------+-------+----------------------+\n| ID                                   | Name  | Task State           |\n+--------------------------------------+-------+----------------------+\n| d0ce0d2a-f4fa-448d-bb9b-b605af386b9f | web02 | image_pending_upload |\n+--------------------------------------+-------+----------------------+\n\n[root@step-server ~]# nova list --name web02 --field name,task_state\n+--------------------------------------+-------+------------+\n| ID                                   | Name  | Task State |\n+--------------------------------------+-------+------------+\n| d0ce0d2a-f4fa-448d-bb9b-b605af386b9f | web02 | None       |\n+--------------------------------------+-------+------------+\n</pre>\n\nglance\u306b\u30a4\u30e1\u30fc\u30b8web-base-v1.0\u304c\u8ffd\u52a0\u3055\u308c\u3066\u3044\u308b\u3002\n\n<pre>\n[root@step-server ~]# glance image-list\n+--------------------------------------+--------------------------+-------------+------------------+------------+--------+\n| ID                                   | Name                     | Disk Format | Container Format | Size       | Status |\n+--------------------------------------+--------------------------+-------------+------------------+------------+--------+\n| 098f948e-e80b-4b1a-8a46-f8d2dd57e149 | centos-base              | qcow2       | bare             | 633235456  | active |\n| 39fb3a6e-e543-4bfe-8ff7-a948acd1c7a3 | cirros-0.3.3-x86_64-disk | qcow2       | bare             | 13200896   | active |\n| 362ae42a-1e46-4de4-afd9-af57965f1b3f | web-base-v1.0            | qcow2       | bare             | 1799749632 | active |\n+--------------------------------------+--------------------------+-------------+------------------+------------+--------+\n</pre>\n\nweb02\u3092\u8d77\u52d5\u3057\u3001\u305d\u306e\u4e2d\u306e\u30a2\u30d7\u30ea\u3082\u958b\u59cb\u3057\u3066\u304a\u304f\u3002\n\n```\n[root@step-server ~]# nova start web02\n[root@step-server ~]# ssh -i key-for-internal.pem root@192.168.0.6\n\n[root@web02 ~]# sh /root/sample-app/server-setup/web.init.sh start\nStarting web.py                                            [  OK  ]\n[root@web02 ~]# exit\nlogout\nConnection to 192.168.0.6 closed.\n```\n\n### 7.3.3 \u30b9\u30ca\u30c3\u30d7\u30b7\u30e7\u30c3\u30c8\u304b\u3089\u306e\u4eee\u60f3\u30de\u30b7\u30f3\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u8d77\u52d5\n\nweb-base-v1.0\u304b\u3089web03\u3092\u8d77\u52d5\u3059\u308b\u3002\n\n\u5c0e\u5165\u3084\u8a2d\u5b9a\u306f\u5b8c\u4e86\u3057\u3066\u3044\u308b\u306e\u3067\u3001userdata\u306e\u4e2d\u8eab\u306f\u3001\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u8d77\u52d5\u306e\u307f\u3002\n\u4f5c\u6210\u30b9\u30af\u30ea\u30d7\u30c8\u306f[\u3053\u3061\u3089\u306b\u7528\u610f\u3055\u308c\u3066\u3044\u308b](https://github.com/josug-book1-materials/chapter05-10/blob/master/07/03_create_web03.sh)\u304c\u300c\"\u300d\u3067\u56f2\u308f\u308c\u3066\u3044\u305f\u306e\u3067\u6b63\u5e38\u306b\u52d5\u4f5c\u3057\u306a\u304b\u3063\u305f\u3002\u672c\u6587\u306b\u306f\u300c'\u300d\u3067\u8a18\u8f09\u3055\u308c\u3066\u3044\u308b\u306e\u3067\u3001\u305d\u308c\u306b\u5f93\u3046\u3002\n\u3082\u3061\u308d\u3093[\u4e8b\u524d\u306b\u7528\u610f](https://github.com/josug-book1-materials/chapter05-10/blob/master/07/userdata_web03.txt)\u3082\u3055\u308c\u3066\u3044\u308b\u3002\n\n```\n[root@step-server ~]# echo '#!/bin/bash' > userdata_web03.txt\n[root@step-server ~]# echo 'sh /root/sample-app/server-setup/web.init.sh start' >> userdata_web03.txt\n```\n\n\u300c--image \"web-base-v1.0\"\u300d\u3067\u30b9\u30ca\u30c3\u30d7\u30b7\u30e7\u30c3\u30c8\u304b\u3089\u8d77\u52d5\u3059\u308b\u3002\n\n<pre>\n[root@step-server 07]# nova boot --flavor standard.xsmall --image \"web-base-v1.0\" \\\n> --key-name key-for-internal --user-data userdata_web03.txt \\\n> --security-groups sg-all-from-console,sg-web-from-internet,sg-all-from-app-net \\\n> --availability-zone az1 \\\n> --nic net-id=${MY_DMZ_NET} --nic net-id=${MY_APP_NET} \\\n> web03\n+--------------------------------------+----------------------------------------------------------------+\n| Property                             | Value                                                          |\n+--------------------------------------+----------------------------------------------------------------+\n| OS-DCF:diskConfig                    | MANUAL                                                         |\n| OS-EXT-AZ:availability_zone          | nova                                                           |\n| OS-EXT-STS:power_state               | 0                                                              |\n| OS-EXT-STS:task_state                | scheduling                                                     |\n| OS-EXT-STS:vm_state                  | building                                                       |\n| OS-SRV-USG:launched_at               | -                                                              |\n| OS-SRV-USG:terminated_at             | -                                                              |\n| accessIPv4                           |                                                                |\n| accessIPv6                           |                                                                |\n| adminPass                            | Psxv5AkAVm4L                                                   |\n| config_drive                         |                                                                |\n| created                              | 2015-03-24T07:14:27Z                                           |\n| flavor                               | standard.xsmall (100)                                          |\n| hostId                               |                                                                |\n| id                                   | 5e8fb496-f248-42e4-a6d9-997fd6307402                           |\n| image                                | web-base-v1.0 (362ae42a-1e46-4de4-afd9-af57965f1b3f)           |\n| key_name                             | key-for-internal                                               |\n| metadata                             | {}                                                             |\n| name                                 | web03                                                          |\n| os-extended-volumes:volumes_attached | []                                                             |\n| progress                             | 0                                                              |\n| security_groups                      | sg-all-from-console, sg-web-from-internet, sg-all-from-app-net |\n| status                               | BUILD                                                          |\n| tenant_id                            | 106e169743964758bcad1f06cc69c472                               |\n| updated                              | 2015-03-24T07:14:28Z                                           |\n| user_id                              | 98dd78b670884b64b879568215777c53                               |\n+--------------------------------------+----------------------------------------------------------------+\n</pre>\nweb03\u304c\u8d77\u52d5\u3057\u3066\u304d\u305f\u3002\n\n<pre>\n[root@step-server 07]# nova list --field name,networks\n+--------------------------------------+-------------+---------------------------------------------------------------+\n| ID                                   | Name        | Networks                                                      |\n+--------------------------------------+-------------+---------------------------------------------------------------+\n| 35d338e5-6e8a-4cee-9be1-9a37b431bf38 | app01       | dmz-net=192.168.0.3; app-net=172.16.10.3; dbs-net=172.16.20.1 |\n| edf1b599-de4f-4b2c-be90-17ab1252728f | dbs01       | dmz-net=192.168.0.4; dbs-net=172.16.20.3                      |\n| 37cbd237-9fd9-4f95-b4e3-caafeaf67454 | lbs01       | dmz-net=192.168.0.5                                           |\n| 65d3400d-3467-4563-9ff5-9c0e30c7157e | step-server | work-net=10.0.0.1, 192.168.100.131                            |\n| ca755522-3eb2-475a-8e37-7fe23398b1d9 | web01       | dmz-net=192.168.0.1, 192.168.100.133; app-net=172.16.10.1     |\n| d0ce0d2a-f4fa-448d-bb9b-b605af386b9f | web02       | dmz-net=192.168.0.6; app-net=172.16.10.4                      |\n| 5e8fb496-f248-42e4-a6d9-997fd6307402 | web03       | dmz-net=192.168.0.7; app-net=172.16.10.5                      |\n+--------------------------------------+-------------+---------------------------------------------------------------+\n</pre>\n\n### 7.3.4 metadata\u3092\u5229\u7528\u3057\u305f\u8a2d\u5b9a\n\n\u307e\u305a\u306fmetadata\u30b5\u30fc\u30d0\u30fc\u300c[http://169.254.169.254](http://169.254.169.254)\u300d\u306b\u3064\u3044\u3066\u3002\n\u3053\u308c\u307e\u3067\u300cnova boot\u300d\u3059\u308b\u6642\u306b\u300c--user-data\u300d\u3067\u8d77\u52d5\u5f8c\u306e\u5b9f\u884c\u5185\u5bb9\u3092\u30b7\u30a7\u30eb\u3067\u66f8\u3044\u3066\u6e21\u3057\u3066\u6765\u305f\u3002\n\u4eee\u60f3\u30de\u30b7\u30f3\u306f\u3001\u8d77\u52d5\u5f8c\u306b\u7279\u5225\u306a\u30a2\u30c9\u30ec\u30b9\u300c[http://169.254.169.254/latest/user-data/](http://169.254.169.254/latest/user-data/)\u300d\u306b\u30a2\u30af\u30bb\u30b9\u3057\u3066\u3001\u3053\u308c\u3092\u53d6\u308a\u51fa\u3059\u3089\u3057\u3044\u3002\n\n\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u7528\u306b\u4f5c\u3063\u305fweb02\u3067\u78ba\u8a8d\u3059\u308b\u3002web01/02\u7528\u306euserdata\u304c\u78ba\u8a8d\u3067\u304d\u308b\u3002\n\n```\n[root@web02 ~]#  curl http://169.254.169.254/openstack/latest/user_data\n#!/bin/bash\ncp /usr/share/zoneinfo/Asia/Tokyo /etc/localtime\ncd /root\ngit clone -q https://github.com/josug-book1-materials/sample-app.git\ncd sample-app\ngit checkout -b v1.0 remotes/origin/v1.0\nsh /root/sample-app/server-setup/install_web.sh\n```\n\nweb03\u306f\u30b9\u30ca\u30c3\u30d7\u30b7\u30e7\u30c3\u30c8\u304b\u3089\u306e\u8d77\u52d5\u306e\u305f\u3081\u30a2\u30d7\u30ea\u306e\u958b\u59cb\u3060\u3051\u3092userdata\u306b\u6307\u5b9a\u3057\u305f\u3002*\u540c\u3058URL*\u306b\u3082\u304b\u304b\u308f\u3089\u305aweb03\u5c02\u7528\u306euserdata\u304c\u53d6\u5f97\u3055\u308c\u305f\u3002\n\n```\n[root@step-server ~]# ssh -i key-for-internal.pem root@192.168.0.7\n[root@web03 ~]# curl http://169.254.169.254/openstack/latest/user_data\n#!/bin/bash\nsh /root/sample-app/server-setup/web.init.sh start\n```\n\nmetadata\u306e\u5834\u5408\u306f\u300cnova boot\u300d\u306b\u300c--mata key=value\u300d\u306e\u5f62\u5f0f\u3067\u6307\u5b9a\u3059\u308b\u3002\u3053\u306e\u5834\u5408\u3001\u4e0b\u8a18\u306e\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3068json\u5f62\u5f0f\u3067\u4eee\u60f3\u30de\u30b7\u30f3\u5074\u304b\u3089\u30a2\u30af\u30bb\u30b9\u3067\u304d\u308b\u3089\u3057\u3044\u3002\n\n[http://169.254.169.254/openstack/latest/meta_data.json](http://169.254.169.254/openstack/latest/meta_data.json)\n\n\u4f55\u3082\u6307\u5b9a\u3057\u306a\u304b\u3063\u305fweb03\u3067\u3082\u3053\u306e\u3088\u3046\u306a\u3082\u306e\u304c\u53d6\u5f97\u3055\u308c\u305f(\u8aad\u307f\u3084\u3059\u3044\u3088\u3046\u306b\u6539\u884c\u6e08\u307f)\u3002\n\n```\n[root@web03 ~]# curl http://169.254.169.254/openstack/latest/meta_data.json\n{\n \"random_seed\": \"QXM9bT4Sm3tkoCADO (\u4e2d\u7565) TOgIJWKjLbLdrUR3mVKoU=\",\n \"uuid\": \"5e8fb496-f248-42e4-a6d9-997fd6307402\",\n \"availability_zone\": \"az1\",\n \"hostname\": \"web03.novalocal\",\n \"launch_index\": 0,\n \"public_keys\": \n  {\n   \"key-for-internal\": \"ssh-rsa AAAAB3NzaC1y (\u4e2d\u7565) XiIII1yd2MrwXcCn Generated-by-Nova\\n\"\n  },\n \"name\": \"web03\"\n}\n```\n\n\u4eca\u56de\u3001\u5b9f\u884c\u3055\u308c\u308b\u306e\u306f\u4e0b\u8a18\u306e\u3068\u304a\u308a\u3067\u3042\u308b\u3002\n\n0. \u300cnova boot\u300d\u306b\u300c--meta rest-ip=${MY_REST_IP}\u300d\u306e\u3088\u3046\u306b\u6307\u5b9a\u3059\u308b\u3002\n0. \u4eee\u60f3\u30de\u30b7\u30f3\u3067\u306fuserdata\u306e\u5b9f\u884c\u4e2d\u306b[http://169.254.169.254/openstack/latest/meta_data.json](http://169.254.169.254/openstack/latest/meta_data.json)\u306b\u30a2\u30af\u30bb\u30b9\u3057\u3001\u5024\u3092json\u3067\u53d6\u5f97\u3059\u308b\u3002\n0. json\u304b\u3089\u30ad\u30fc\u300crest-ip\u300d\u306e\u5024\u3092\u53d6\u308a\u51fa\u3059\u3002\n0. sed\u3067endpoint.conf\u306e127.0.0.1\u3092\u3053\u306e\u5024\u306b\u66f8\u304d\u63db\u3048\u308b\u3002\n\n\u3053\u308c\u3092\u5b9f\u73fe\u3059\u308buserdata\u306f[userdata_web_auto_setting.txt](https://github.com/josug-book1-materials/chapter05-10/blob/master/07/userdata_web_auto_setting.txt)\u306e\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u308b\u3002\n\n\u307e\u305a\u3001\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u306eUUID\u3084App\u30b5\u30fc\u30d0\u30fc\u306eIP\u3092\u53d6\u5f97\u3059\u308b\u3002\n\n<pre>\n[root@step-server ~]# function get_uuid () { cat - | grep \" id \" | awk '{print $4}'; }\n[root@step-server ~]# export MY_DMZ_NET=`neutron net-show dmz-net | get_uuid`\n[root@step-server ~]# export MY_APP_NET=`neutron net-show app-net | get_uuid`\n[root@step-server ~]# export MY_REST_IP=`nova show app01 |grep \" app-net\" |awk '{print $5}'`\n[root@step-server ~]# env | grep MY_\nMY_APP_NET=7d3828af-2da1-4e10-a904-f9e03b28e181\nMY_DMZ_NET=35e4baac-7230-4232-9644-856874dfe8af\nMY_REST_IP=172.16.10.3\n</pre>\n\n\u300c--meta rest_ip=${MY_REST_IP}\u300d\u3092\u4ed8\u3051\u3066\u300cnova boot\u300d\u3059\u308b\u3002\n\n<pre>\n[root@step-server 07]# nova boot --flavor standard.xsmall --image \"centos-base\" \\\n> --key-name key-for-internal --user-data userdata_web_auto_setting.txt \\\n> --security-groups sg-all-from-console,sg-web-from-internet,sg-all-from-app-net \\\n> --availability-zone az1 \\\n> --nic net-id=${MY_DMZ_NET} --nic net-id=${MY_APP_NET} \\\n> --meta rest_ip=${MY_REST_IP} \\\n> web04\n+--------------------------------------+----------------------------------------------------------------+\n| Property                             | Value                                                          |\n+--------------------------------------+----------------------------------------------------------------+\n| OS-DCF:diskConfig                    | MANUAL                                                         |\n| OS-EXT-AZ:availability_zone          | nova                                                           |\n| OS-EXT-STS:power_state               | 0                                                              |\n| OS-EXT-STS:task_state                | scheduling                                                     |\n| OS-EXT-STS:vm_state                  | building                                                       |\n| OS-SRV-USG:launched_at               | -                                                              |\n| OS-SRV-USG:terminated_at             | -                                                              |\n| accessIPv4                           |                                                                |\n| accessIPv6                           |                                                                |\n| adminPass                            | bBUeoqUWWH88                                                   |\n| config_drive                         |                                                                |\n| created                              | 2015-03-25T05:07:24Z                                           |\n| flavor                               | standard.xsmall (100)                                          |\n| hostId                               |                                                                |\n| id                                   | 1955e438-626f-4582-8d15-bfe13b97a084                           |\n| image                                | centos-base (098f948e-e80b-4b1a-8a46-f8d2dd57e149)             |\n| key_name                             | key-for-internal                                               |\n| metadata                             | {\"rest_ip\": \"172.16.10.3\"}                                     |\n| name                                 | web04                                                          |\n| os-extended-volumes:volumes_attached | []                                                             |\n| progress                             | 0                                                              |\n| security_groups                      | sg-all-from-console, sg-web-from-internet, sg-all-from-app-net |\n| status                               | BUILD                                                          |\n| tenant_id                            | 106e169743964758bcad1f06cc69c472                               |\n| updated                              | 2015-03-25T05:07:25Z                                           |\n| user_id                              | 98dd78b670884b64b879568215777c53                               |\n+--------------------------------------+----------------------------------------------------------------+\n</pre>\n\n\u3053\u308c\u3067\u3001web\u30b5\u30fc\u30d0\u30fc\u306f4\u3064\u3067\u304d\u305f\u3002\n\n<pre>\n[root@step-server 07]# nova list --name web* --field name,networks\n+--------------------------------------+-------+-----------------------------------------------------------+\n| ID                                   | Name  | Networks                                                  |\n+--------------------------------------+-------+-----------------------------------------------------------+\n| ca755522-3eb2-475a-8e37-7fe23398b1d9 | web01 | dmz-net=192.168.0.1, 192.168.100.133; app-net=172.16.10.1 |\n| d0ce0d2a-f4fa-448d-bb9b-b605af386b9f | web02 | dmz-net=192.168.0.6; app-net=172.16.10.4                  |\n| 5e8fb496-f248-42e4-a6d9-997fd6307402 | web03 | dmz-net=192.168.0.7; app-net=172.16.10.5                  |\n| 1955e438-626f-4582-8d15-bfe13b97a084 | web04 | dmz-net=192.168.0.8; app-net=172.16.10.6                  |\n+--------------------------------------+-------+-----------------------------------------------------------+\n</pre>\n\nweb04\u306b\u5165\u3063\u3066\u6e21\u3055\u308c\u305fuserdata\u306e\u78ba\u8a8d\u3002\n\n```\n[root@step-server ~]# ssh -i key-for-internal.pem root@192.168.0.8\n[root@web04 ~]# curl http://169.254.169.254/openstack/latest/user_data\n#!/bin/bash\ncp /usr/share/zoneinfo/Asia/Tokyo /etc/localtime\ncd /root\ngit clone https://github.com/josug-book1-materials/sample-app.git\ncd sample-app\ngit checkout -b v1.0 remotes/origin/v1.0\nsh /root/sample-app/server-setup/install_web.sh\n\nMY_REST_IP=`curl -S -s http://169.254.169.254/openstack/latest/meta_data.json \\\n| python -c \\\n\"import json,sys; print json.load(sys.stdin).get('meta').get('rest_ip')\"`\n\nsed -i -e \"s/rest_host = 127.0.0.1/rest_host = ${MY_REST_IP:?}/\" \\\n/root/sample-app/endpoint.conf\n\nsh /root/sample-app/server-setup/web.init.sh start\n```\n\nmata_data.json\u306e\u78ba\u8a8d\u3002\u300cmeta\u300d\u306e\u300crest_ip\u300d\u306bapp01\u306e\u30a2\u30c9\u30ec\u30b9\u304c\u6e21\u3063\u3066\u3044\u308b\u3002\n\n```\n[root@web04 ~]# curl http://169.254.169.254/openstack/latest/meta_data.json\n{\n  \"random_seed\": \"9isqFeB5tivwrp5xof (\u4e2d\u7565) CTWF4xuBlNkh4HScfdDLI=\", \n  \"uuid\": \"1955e438-626f-4582-8d15-bfe13b97a084\", \n  \"availability_zone\": \"az1\", \n  \"hostname\": \"web04.novalocal\", \n  \"launch_index\": 0, \n  \"meta\": \n  {\n    \"rest_ip\": \"172.16.10.3\"\n  }, \n  \"public_keys\": \n  {\n    \"key-for-internal\": \"ssh-rsa AAAAB3NzaC1yc2Cg (\u4e2d\u7565) 5Hyd2MrwXcCn Generated-by-Nova\\n\"\n  }, \n  \"name\": \"web04\"}\n```\n\n\u5148\u307b\u3069\u306e[userdata_web_auto_setting.txt](https://github.com/josug-book1-materials/chapter05-10/blob/master/07/userdata_web_auto_setting.txt)\u3067\u306f\u3001curl\u3067\u3053\u306ejson\u3092\u53d6\u308a\u51fa\u3057\u3001python\u3067json\u304b\u3089rest_ip\u306e\u5024\u3092\u53d6\u308a\u51fa\u3057\u3001sed\u3067rest_host\u306e\u884c\u3092\u7f6e\u304d\u63db\u3048\u3066\u3044\u308b\u3002\n\n## 7.4 \u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b5\u30fc\u3078\u306e\u30a8\u30f3\u30c8\u30ea\u30fc\u306e\u8ffd\u52a0\n\nlbs01\u306b\u30ed\u30b0\u30a4\u30f3\u3057\u3066web02-04\u3092\u8ffd\u52a0\u3057\u3001nginx \u3092\u518d\u8d77\u52d5\u3059\u308b\u3002\n\n```\n[root@lbs01 ~]# cat /etc/nginx/conf.d/lbs.conf\nupstream web-server {\n  server 192.168.0.1:80;\n  server 192.168.0.6:80;\n  server 192.168.0.7:80;\n  server 192.168.0.8:80;\n}\n\nserver {\n  listen 80 default_server;\n  server_name _;\n\n  location / {\n    proxy_pass http://web-server/;\n  }\n}\n\n[root@lbs01 ~]# service nginx restart\nStopping nginx:                                            [  OK  ]\nStarting nginx:                                            [  OK  ]\n```\n\nlbs01\u30678\u56de\u306e\u30ea\u30af\u30a8\u30b9\u30c8\u3092\u5b9f\u65bd\u3002\u4e0d\u7cbe\u3092\u3057\u3066lbs01\u4e0a\u3067127.0.0.1\u3067\u30a2\u30af\u30bb\u30b9\u3002\n\n```\n[root@lbs01 ~]# for i in {1..8}; do curl http://127.0.0.1/; sleep 2; done\n```\n\n\u672c\u65e5\u4ed8\u3051\u3067\u5404\u30b5\u30fc\u30d0\u30fc\u306b2\u56de\u3065\u3064\u306e\u30a2\u30af\u30bb\u30b9\u304c\u78ba\u8a8d\u3067\u304d\u308b\u3002\n\n```\n[root@step-server ~]# ssh -i key-for-internal.pem root@192.168.0.1\n[root@web01 ~]# tail sample-app/web.log\n127.0.0.1 - - [24/Mar/2015 12:14:32] \"GET / HTTP/1.1\" 200 -\n192.168.100.1 - - [24/Mar/2015 13:10:14] \"GET / HTTP/1.1\" 200 -\n192.168.100.1 - - [24/Mar/2015 13:12:27] \"GET / HTTP/1.0\" 200 -\n192.168.100.1 - - [24/Mar/2015 13:12:27] \"GET /favicon.ico HTTP/1.0\" 404 -\n192.168.100.1 - - [24/Mar/2015 13:12:58] \"POST / HTTP/1.0\" 302 -\n192.168.100.1 - - [24/Mar/2015 13:12:58] \"GET / HTTP/1.0\" 200 -\n192.168.100.1 - - [24/Mar/2015 13:21:24] \"GET / HTTP/1.0\" 200 -\n192.168.0.5 - - [24/Mar/2015 15:07:02] \"GET / HTTP/1.0\" 200 -\n192.168.0.5 - - [25/Mar/2015 14:39:34] \"GET / HTTP/1.0\" 200 -\n192.168.0.5 - - [25/Mar/2015 14:39:43] \"GET / HTTP/1.0\" 200 -\n[root@web01 ~]# exit\nlogout\nConnection to 192.168.0.1 closed.\n\n[root@step-server ~]# ssh -i key-for-internal.pem root@192.168.0.6\n[root@web02 ~]# tail sample-app/web.log\n * Running on http://0.0.0.0:80/ (Press CTRL+C to quit)\n * Restarting with stat\n192.168.0.5 - - [25/Mar/2015 14:39:36] \"GET / HTTP/1.0\" 200 -\n192.168.0.5 - - [25/Mar/2015 14:39:44] \"GET / HTTP/1.0\" 200 -\n[root@web02 ~]# exit\nlogout\nConnection to 192.168.0.6 closed.\n\n[root@step-server ~]# ssh -i key-for-internal.pem root@192.168.0.7\n[root@web03 ~]# tail sample-app/web.log\n * Running on http://0.0.0.0:80/ (Press CTRL+C to quit)\n * Restarting with stat\n192.168.0.5 - - [25/Mar/2015 14:39:38] \"GET / HTTP/1.0\" 200 -\n192.168.0.5 - - [25/Mar/2015 14:39:46] \"GET / HTTP/1.0\" 200 -\n[root@web03 ~]# exit\nlogout\nConnection to 192.168.0.7 closed.\n\n[root@step-server ~]# ssh -i key-for-internal.pem root@192.168.0.8\n[root@web04 ~]# tail sample-app/web.log\n * Running on http://0.0.0.0:80/ (Press CTRL+C to quit)\n * Restarting with stat\n192.168.0.5 - - [25/Mar/2015 14:39:40] \"GET / HTTP/1.0\" 200 -\n192.168.0.5 - - [25/Mar/2015 14:39:48] \"GET / HTTP/1.0\" 200 -\n[root@web04 ~]# exit\nlogout\nConnection to 192.168.0.8 closed.\n```\n\n## 7.5 Floating IP\u306e\u4ed8\u3051\u66ff\u3048\n\n\u516c\u958b\u7528\u306bweb01\u306b\u632f\u3089\u308c\u3066\u3044\u305fFloating IP\u300c192.168.100.133\u300d\u3092lbs01\u306b\u4ed8\u3051\u66ff\u3048\u308b\u3002\n\n<pre>\n[root@step-server ~]# nova list --name web01 --field name,networks\n+--------------------------------------+-------+-----------------------------------------------------------+\n| ID                                   | Name  | Networks                                                  |\n+--------------------------------------+-------+-----------------------------------------------------------+\n| ca755522-3eb2-475a-8e37-7fe23398b1d9 | web01 | dmz-net=192.168.0.1, 192.168.100.133; app-net=172.16.10.1 |\n+--------------------------------------+-------+-----------------------------------------------------------+\n\n[root@step-server ~]# nova floating-ip-disassociate web01 192.168.100.133\n[root@step-server ~]# nova floating-ip-associate lbs01 192.168.100.133\n\n[root@step-server ~]# nova list --name lbs01 --field name,networks\n+--------------------------------------+-------+--------------------------------------+\n| ID                                   | Name  | Networks                             |\n+--------------------------------------+-------+--------------------------------------+\n| 37cbd237-9fd9-4f95-b4e3-caafeaf67454 | lbs01 | dmz-net=192.168.0.5, 192.168.100.133 |\n+--------------------------------------+-------+--------------------------------------+\n</pre>\n\n\u516c\u958bIP\u306f\u5909\u66f4\u3055\u308c\u3066\u3044\u306a\u3044\u306e\u3067\u3001[6\u7ae0\u306e\u6700\u5f8c\u306b\u4f5c\u3063\u305fReverse Proxy\u7d4c\u7531\u3067\u306e\u30a2\u30af\u30bb\u30b9](http://qiita.com/orz/items/5b68ecc57e2afb936330#65-%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AE%E3%83%AA%E3%83%AA%E3%83%BC%E3%82%B9)\u306f\u5909\u66f4\u3059\u308b\u5fc5\u8981\u306f\u306a\u3044\u3002\u305d\u306e\u307e\u307e\u306e\u69cb\u6210\u3067\u30a2\u30af\u30bb\u30b9\u3067\u304d\u308b\u3002\n\n![Reverse Proxy\u7d4c\u7531\u306e\u30a2\u30af\u30bb\u30b9](https://qiita-image-store.s3.amazonaws.com/0/71995/2a9368e5-9621-f1e1-68c7-8633cfa05ae2.png)\n\nlbs\u3067nginx\u306e\u30a2\u30af\u30bb\u30b9\u30ed\u30b0\u3092\u78ba\u8a8d\u3059\u308b\u3068\u3001\u3053\u3061\u3089\u3078\u306e\u30a2\u30af\u30bb\u30b9\u304c\u78ba\u8a8d\u3067\u304d\u308b\u3002\n\n```\n[root@step-server ~]# ssh -i key-for-internal.pem root@192.168.0.5\n[root@lbs01 ~]# tail /var/log/nginx/access.log\n```\n\n***\n\u7b2c7\u7ae0\u304c\u5b8c\u4e86\u3057\u305f\u3002\n***\n\n[\u524d\u56de\u306f\u3053\u3061\u3089](http://qiita.com/orz/items/5b68ecc57e2afb936330) - [\u6b21\u56de\u306f\u3053\u3061\u3089](http://qiita.com/orz/items/b257046fd336850c52dc)\n"}