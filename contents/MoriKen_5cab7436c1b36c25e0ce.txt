{"tags": ["ROS"], "context": "\n\n\u76ee\u6b21\n\n\n\u30ed\u30dc\u30c3\u30c8\u30e2\u30c7\u30eb\u306e\u5b9a\u7fa9\u3068\u767b\u9332\n\n\nURDF\u3067\u30ed\u30dc\u30c3\u30c8\u30e2\u30c7\u30eb\u3092\u5b9a\u7fa9\u3059\u308b\n\nHardwareInterface\u306e\u5b58\u5728\u610f\u7fa9\n\nURDF\u3067Gazebo\u306e\u8a2d\u5b9a\u3092\u3059\u308b\n\u30ed\u30dc\u30c3\u30c8\u30e2\u30c7\u30eb\u3092\u30d1\u30e9\u30e1\u30fc\u30bf\u30b5\u30fc\u30d0\u306b\u767b\u9332\u3059\u308b\n\n\n\nRobotHWSim\u306e\u30d7\u30e9\u30b0\u30a4\u30f3\u306b\u3064\u3044\u3066\u3000\u2190\u3000\u30a4\u30de\u30b3\u30b3\n\n\n\u30d7\u30e9\u30b0\u30a4\u30f3\u306e\u5b9a\u7fa9\n\u30d7\u30e9\u30b0\u30a4\u30f3\u3067\u5b9a\u7fa9\u3055\u308c\u305f\u51e6\u7406\u304c\u5b9f\u884c\u3055\u308c\u308b\u5834\u6240\n\nRobotHWSin\u3068RobotHW\u3068\u306e\u5bfe\u6bd4\n\u30d7\u30e9\u30b0\u30a4\u30f3\u3068\u3057\u3066\u4f7f\u3048\u308b\u3088\u3046\u306b\u3059\u308b \n\nDefaultRobotHWSim\u306b\u3064\u3044\u3066\n\n\n\nController\u306b\u3064\u3044\u3066\n\n\nGazebo\u306b\u30ed\u30dc\u30c3\u30c8\u30e2\u30c7\u30eb\u3092Spawn\u3059\u308b\n\nController\u3092\u8d77\u52d5\u3059\u308b\n\nControllerManager\u3068HardwareInterface\u3068\u306e\u30de\u30c3\u30d4\u30f3\u30b0\n\n\n\n\n\u304a\u984c\n\n\u66f8\u7c4d\n\n\n\nLearning ROS for Robotics Programming - Second Edition Chapter 10: Manipulation with MoveIt!\n\n\n\n\n\n\u30ea\u30dd\u30b8\u30c8\u30ea\n\n\ngithub: AaronMR/Learning_ROS_for_Robotics_Programming_2nd_edition\n\n\n\n\n\u306f\u3058\u3081\u306b\n\u300c1. \u30ed\u30dc\u30c3\u30c8\u30e2\u30c7\u30eb\u306e\u5b9a\u7fa9\u3068\u767b\u9332\u300d\u306e\u8aac\u660e\u306b\u304a\u3044\u3066\uff0cgazebo.urdf.xacro\u3067rosbook_arm_hardware_gazebo/ROSBookArmHardwareGazebo\u3068\u3044\u3046\u30ab\u30b9\u30bf\u30e0\u30d7\u30e9\u30b0\u30a4\u30f3\u3092\u6307\u5b9a\u3057\u305f\u7b87\u6240\u304c\u3042\u308a\u307e\u3057\u305f\uff0e\u3053\u306e\u6b63\u4f53\u3092\u68da\u4e0a\u3052\u306b\u3057\u3066\u3044\u305f\u306e\u3067\uff0c\u3053\u3053\u3067\u7406\u89e3\u3092\u6df1\u3081\u308b\u3053\u3068\u306b\u3057\u307e\u3059\uff0e\n\u672c\u5bb6\u30b5\u30a4\u30c8\u306e\u56f3\u306b\u304a\u3044\u3066\uff0c\u4e0b\u8a18\u30d4\u30f3\u30af\u3067\u56f2\u3063\u305f\u7b87\u6240\u3067\u3059\uff0e\n\n\u672c\u8a18\u4e8b\u7528\u306e\u307e\u3068\u3081\u306e\u56f3\u306b\u304a\u3044\u3066\u306f\uff0c\u4e0b\u8a18\u306e\u7dd1\u3067\u56f2\u3063\u305f\u7b87\u6240\u3067\u3059\uff0e\n\n\n\u30d7\u30e9\u30b0\u30a4\u30f3\u306e\u5b9a\u7fa9\n\u3053\u306e\u30ab\u30b9\u30bf\u30e0\u30d7\u30e9\u30b0\u30a4\u30f3\u306e\u5b9f\u4f53\u306f\uff0crosbook_arm_hardware_gazebo\u30d1\u30c3\u30b1\u30fc\u30b8\u306e\u4e2d\u306b\u3042\u308a\uff0cC++\u3067\u5b9f\u88c5\u3055\u308c\u3066\u3044\u307e\u3059\uff0e\u5927\u4e8b\u306a\u3068\u3053\u308d\u3060\u3051\u8997\u3044\u3066\u307f\u307e\u3059\uff0e\n\nrosbook_arm_hardware_gazebo/include/rosbook_arm_hardware_gazebo/rosbook_arm_hardware_gazebo.h\n  // \u7701\u7565\n#include <hardware_interface/robot_hw.h>\n  // \u7701\u7565\n#include <gazebo_ros_control/robot_hw_sim.h>\n  // \u7701\u7565\nnamespace rosbook_arm_hardware_gazebo\n{\n\nclass ROSBookArmHardwareGazebo : public gazebo_ros_control::RobotHWSim\n{\npublic:\n\n  ROSBookArmHardwareGazebo();\n\n  bool initSim(const std::string& robot_namespace,\n      ros::NodeHandle model_nh,\n      gazebo::physics::ModelPtr parent_model,\n      const urdf::Model* const urdf_model,\n      std::vector<transmission_interface::TransmissionInfo> transmissions);\n\n  void readSim(ros::Time time, ros::Duration period);\n\n  void writeSim(ros::Time time, ros::Duration period);\n  // \u7701\u7565\nprivate:\n  // \u7701\u7565\n  std::vector<double> jnt_pos_;\n  std::vector<double> jnt_vel_;\n  std::vector<double> jnt_eff_;\n\n  std::vector<double> jnt_pos_cmd_;\n\n  std::vector<gazebo::physics::JointPtr> sim_joints_;\n\n  // Hardware interface: joints\n  hardware_interface::JointStateInterface    jnt_state_interface_;\n  hardware_interface::PositionJointInterface jnt_pos_cmd_interface_;\n  // \u7701\u7565\n};\n\n} // namespace rosbook_arm_hardware_gazebo\n\n#endif // ROSBOOK_ARM_HARDWARE_GAZEBO_H\n\n\n\ninitSim(), readSim(), writeSim() \u30e1\u30bd\u30c3\u30c9\u304c\u91cd\u8981\u3067\u3059\uff0eHardwareInterface\u3068Controller\u3068\u306e\u3084\u308a\u3068\u308a\u3084\uff0cHardwareInterface\u3068Gazebo\u3068\u306e\u3084\u308a\u3068\u308a\u3092\u5b9f\u73fe\u3059\u308b\u90e8\u5206\u3067\u3059\uff0e\u3053\u308c\u3089\u306e\u30e1\u30bd\u30c3\u30c9\u306f\uff0cgazebo_ros_control::RobotHWSim\u30af\u30e9\u30b9\u3067\u7d14\u7c8b\u4eee\u60f3\u30e1\u30bd\u30c3\u30c9\u3068\u3057\u3066\u5ba3\u8a00\u3055\u308c\u3066\u3044\u308b\u306e\u3067\uff0c\u30ab\u30b9\u30bf\u30de\u30a4\u30ba\u3057\u305f\u30e1\u30bd\u30c3\u30c9\u3067\u30aa\u30fc\u30d0\u30fc\u30e9\u30a4\u30c9\u3057\u3066\u3042\u3052\u307e\u3059\uff0e\u5b9a\u7fa9\u306b\u3064\u3044\u3066\u306f\uff0c\u4e0b\u8a18\u306e\u30b3\u30fc\u30c9\u3067\u898b\u3066\u307f\u307e\u3057\u3087\u3046\uff0e\n\nrosbook_arm_hardware_gazebo/src/rosbook_arm_hardware_gazebo.cpp\n  // \u7701\u7565\n#include <rosbook_arm_hardware_gazebo/rosbook_arm_hardware_gazebo.h>\n\nnamespace rosbook_arm_hardware_gazebo\n{\n  using namespace hardware_interface;\n  // \u7701\u7565\n  bool ROSBookArmHardwareGazebo::initSim(const std::string& robot_namespace,\n      ros::NodeHandle nh,\n      gazebo::physics::ModelPtr model,\n      const urdf::Model* const urdf_model,\n      std::vector<transmission_interface::TransmissionInfo> transmissions)\n  {\n    using gazebo::physics::JointPtr;\n\n    // Cleanup\n    sim_joints_.clear();\n    jnt_pos_.clear();\n    jnt_vel_.clear();\n    jnt_eff_.clear();\n    jnt_pos_cmd_.clear();\n\n    // Simulation joints\n    sim_joints_ = model->GetJoints();\n    n_dof_ = sim_joints_.size();\n\n    std::vector<std::string> jnt_names;\n    for (size_t i = 0; i < n_dof_; ++i)\n    {\n      jnt_names.push_back(sim_joints_[i]->GetName());\n    }\n\n    // Raw data\n    jnt_pos_.resize(n_dof_);\n    jnt_vel_.resize(n_dof_);\n    jnt_eff_.resize(n_dof_);\n    jnt_pos_cmd_.resize(n_dof_);\n\n    // Hardware interfaces\n    for (size_t i = 0; i < n_dof_; ++i)\n    {\n      jnt_state_interface_.registerHandle(\n          JointStateHandle(jnt_names[i], &jnt_pos_[i], &jnt_vel_[i], &jnt_eff_[i]));\n\n      jnt_pos_cmd_interface_.registerHandle(\n          JointHandle(jnt_state_interface_.getHandle(jnt_names[i]), &jnt_pos_cmd_[i]));\n\n      ROS_DEBUG_STREAM(\"Registered joint '\" << jnt_names[i] << \"' in the PositionJointInterface.\");\n    }\n\n    registerInterface(&jnt_state_interface_);\n    registerInterface(&jnt_pos_cmd_interface_);\n\n  // \u7701\u7565\n    }\n  // \u7701\u7565\n    return true;\n  }\n\n  void ROSBookArmHardwareGazebo::readSim(ros::Time time, ros::Duration period)\n  {\n    for (size_t i = 0; i < n_dof_; ++i)\n    {\n      jnt_pos_[i] += angles::shortest_angular_distance\n          (jnt_pos_[i], sim_joints_[i]->GetAngle(0u).Radian());\n      jnt_vel_[i] = sim_joints_[i]->GetVelocity(0u);\n      jnt_eff_[i] = sim_joints_[i]->GetForce(0u);\n    }\n  }\n\n  void ROSBookArmHardwareGazebo::writeSim(ros::Time time, ros::Duration period)\n  {\n    // Enforce joint limits\n    jnt_limits_interface_.enforceLimits(period);\n\n    // Compute and send commands\n    for (size_t i = 0; i < n_dof_; ++i)\n    {\n      const double error = jnt_pos_cmd_[i] - jnt_pos_[i];\n      const double effort = pids_[i].computeCommand(error, period);\n\n      sim_joints_[i]->SetForce(0u, effort);\n    }\n  }\n\n} // namespace rosbook_hardware_gazebo\n\nPLUGINLIB_EXPORT_CLASS(rosbook_arm_hardware_gazebo::ROSBookArmHardwareGazebo, gazebo_ros_control::RobotHWSim)\n\n\n\u91cd\u8981\u306a\u4e09\u3064\u306e\u30e1\u30bd\u30c3\u30c9\u304c\u30aa\u30fc\u30d0\u30fc\u30e9\u30a4\u30c9\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u304c\u78ba\u8a8d\u3067\u304d\u307e\u3059\uff0e\u6982\u8981\u306f\u4e0b\u8a18\u306e\u3068\u304a\u308a\u3067\u3059\uff0e\n\ninitSim()\n\n\n\u30d1\u30e9\u30e1\u30fc\u30bf\u30b5\u30fc\u30d0\u306b\u767b\u9332\u3055\u308c\u305f\u30ed\u30dc\u30c3\u30c8\u30e2\u30c7\u30eb\u304b\u3089\uff0cjoint \u540d\u3092\u53d6\u5f97\u3057\u307e\u3059\uff0e\n\u53d6\u5f97\u3057\u305fjoint \u540d\u3067JointState\u306e\u30cf\u30f3\u30c9\u30eb\u3092\u4f5c\u6210\u3057\uff0cHardware Resource Interface\u3092\u30a4\u30f3\u30bf\u30fc\u30d5\u30a7\u30fc\u30b9\u3068\u3057\u3066\u767b\u9332\u3057\u307e\u3059\uff0e\u72b6\u614b\u306e\u8aad\u307f\u51fa\u3057\u306b\u4f7f\u3046\u306e\u304chardware_interface::JointStateInterface jnt_state_interface_\u3067\uff0c\u6307\u4ee4\u306b\u66f8\u304d\u8fbc\u307f\u306b\u4f7f\u3046\u306e\u304chardware_interface::PositionJointInterface jnt_pos_cmd_interface_\u3067\u3059\uff0e\uff08\u3053\u308c\u3089\u306f\u3044\u305a\u308c\u3082hardware_interface::HardwareResourceManager\u30af\u30e9\u30b9\u306e\u30b5\u30d6\u30af\u30e9\u30b9\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3067\u3059\uff0e\uff09\n\u5f8c\u3005Controller\u304cHardwareInterface\u3092\u4ecb\u3057\u3066\u3084\u308a\u3068\u308a\u3067\u304d\u308b\u3088\u3046\u306b\uff0cJointStateInterface\u3084PositionJointInterface\u306e\u30cf\u30f3\u30c9\u30eb\u4f5c\u6210\u6642\u306b\uff0cjoint \u306b\u307e\u3064\u308f\u308b\u30e1\u30f3\u30d0\u5909\u6570\uff08jnt_pos_, jnt_vel_, jnt_eff_, jnt_pos_cmd_\uff09\u306e\u30dd\u30a4\u30f3\u30bf\u3092\u767b\u9332\u3057\u3066\u3044\u307e\u3059\uff0e\n\n\nreadSim()\n\n\n\u73fe\u5728\u306eGazebo\u306b\u304a\u3051\u308b\u30ed\u30dc\u30c3\u30c8\u30e2\u30c7\u30eb\u306ejoint \u306e\u72b6\u614b\uff08\u4f4d\u7f6e\uff0c\u901f\u5ea6\uff0c\u30c8\u30eb\u30af\uff09\u3092\u53d6\u5f97\u3057\u3066\uff0c\u5148\u307b\u3069initSim()\u3067\u6e21\u3057\u305f\u30e1\u30f3\u30d0\u5909\u6570\u3092\u4ecb\u3057\u3066HardwareInterface\u306b\u53d6\u5f97\u3057\u305f\u60c5\u5831\u3092\u6559\u3048\u3066\u3042\u3052\u307e\u3059\uff0e\n\n\nwriteSim()\n\n\n\nGazebo\u306b\u304a\u3051\u308b\u30ed\u30dc\u30c3\u30c8\u30e2\u30c7\u30eb\u306ejoint \u306b\u6307\u4ee4\u5024\u3092\u9001\u308a\u307e\u3059\uff0e\u4eca\u56de\u306e\u30b5\u30f3\u30d7\u30eb\u306e\u5834\u5408\uff0chardware_interface::PositionJointInterface jnt_pos_cmd_interface_\u3067\u53d6\u5f97\u3057\u305f\u4f4d\u7f6e\u6307\u4ee4\u304b\u3089\u529b\u6307\u4ee4\u3092\u8a08\u7b97\u3057\uff0cGazebo\u306b\u9001\u308a\u307e\u3059\uff0e\n\n\n\n\u4e0a\u8ff0\u306e\u30a4\u30e1\u30fc\u30b8\u3092\u56f3\u3067\u8868\u3059\u3068\uff0c\u4e0b\u56f3\u306e\u3088\u3046\u306b\u306a\u308a\u307e\u3059\uff0e\n\n\u3053\u3053\u307e\u3067\u898b\u308c\u3070\uff0c\u3053\u306e3\u3064\u306e\u30e1\u30bd\u30c3\u30c9\u304c\uff0c\u30d7\u30e9\u30b0\u30a4\u30f3\u306e\u52d5\u4f5c\u3092\u6c7a\u5b9a\u3065\u3051\u308b\u91cd\u8981\u9805\u76ee\u3067\u3042\u308b\u3053\u3068\u304c\u7406\u89e3\u3067\u304d\u307e\u3059\uff0e\n\n\u30d7\u30e9\u30b0\u30a4\u30f3\u3067\u5b9a\u7fa9\u3055\u308c\u305f\u51e6\u7406\u304c\u5b9f\u884c\u3055\u308c\u308b\u5834\u6240\n\u3067\u306f\uff0c\u3053\u308c\u3089\u306e\u30e1\u30bd\u30c3\u30c9\u306f\u3044\u3064\u547c\u3070\u308c\u308b\u306e\u3067\u3057\u3087\u3046\u304b\uff1f\nROS\u3068Gazebo\u3092\u9023\u643a\u3055\u305b\u308b\u3068\uff0cGazeboRosControlPlugin\u3068\u3044\u3046\uff0cGazebo\u306e\u30d7\u30e9\u30b0\u30a4\u30f3\u3068ROS\u9593\u306e\u30a4\u30f3\u30bf\u30fc\u30d5\u30a7\u30fc\u30b9\u3092\u5236\u5fa1\u3059\u308b\u305f\u3081\u306e\u30af\u30e9\u30b9\u304c\u50cd\u3044\u3066\u304f\u308c\u307e\u3059\uff0e\u30ed\u30dc\u30c3\u30c8\u30e2\u30c7\u30eb\u3092Spawn\u3059\u308b\u969b\u306b\uff0crobot_description\u306e\u60c5\u5831\u304c\u6e21\u3055\u308c\u307e\u3059\uff0e\u4f7f\u7528\u3059\u308b\u30d7\u30e9\u30b0\u30a4\u30f3\u306e\u60c5\u5831\u304c\u305d\u306e\u4e2d\u306b\u7d44\u307f\u8fbc\u307e\u308c\u3066\u3044\u308b\u306e\u3067\uff0cGazeboRosControlPlugin\u306f\u3069\u306e\u30d7\u30e9\u30b0\u30a4\u30f3\u3092\u4f7f\u3048\u3070\u826f\u3044\u306e\u304b\u3092\u77e5\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\uff0e\n\u3067\u306f\uff0c\u4e0a\u8a18\u30d7\u30e9\u30b0\u30a4\u30f3\u306e\u30e1\u30bd\u30c3\u30c9\u304c\u5b9f\u969b\u306b\u547c\u3070\u308c\u308b\u5834\u6240\u304c\u3069\u3053\u306b\u306a\u308b\u306e\u304b\u304c\u6c17\u306b\u306a\u308a\u307e\u3059\uff0e\u8abf\u3079\u308b\u3068\uff0c\u4e0b\u8a18\u306e\u30ea\u30dd\u30b8\u30c8\u30ea\u306b\u3042\u308a\u307e\u3057\u305f\uff0e\ngithub: ros-controls/gazebo_ros_control\n\ngazebo_ros_control/src/gazebo_ros_control_plugin.cpp\n  // \u7701\u7565\n// Called by the world update start event\nvoid GazeboRosControlPlugin::Update()\n{\n  // Get the simulation time and period\n  gazebo::common::Time gz_time_now = parent_model_->GetWorld()->GetSimTime();\n  ros::Time sim_time_ros(gz_time_now.sec, gz_time_now.nsec);\n  ros::Duration sim_period = sim_time_ros - last_update_sim_time_ros_;\n\n  robot_hw_sim_->eStopActive(e_stop_active_);\n\n  // Check if we should update the controllers\n  if(sim_period >= control_period_) {\n    // Store this simulation time\n    last_update_sim_time_ros_ = sim_time_ros;\n\n    // Update the robot simulation with the state of the gazebo model\n    robot_hw_sim_->readSim(sim_time_ros, sim_period);\n\n    // Compute the controller commands\n  // \u7701\u7565\n    controller_manager_->update(sim_time_ros, sim_period, reset_ctrlrs);\n  }\n\n  // Update the gazebo model with the result of the controller\n  // computation\n  robot_hw_sim_->writeSim(sim_time_ros, sim_time_ros - last_write_sim_time_ros_);\n  last_write_sim_time_ros_ = sim_time_ros;\n}\n  // \u7701\u7565\n\n\n\u672cUpdate()\u30e1\u30bd\u30c3\u30c9\u306f\u30b7\u30df\u30e5\u30ec\u30fc\u30b7\u30e7\u30f3\u5468\u671f\u6bce\u306b\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u3055\u308c\u307e\u3059\uff0e\u672c\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u95a2\u6570\u306e\u767b\u9332\u306f\u540c\u30af\u30e9\u30b9\u306e\u30e1\u30bd\u30c3\u30c9\u3067\u3042\u308bLoad()\u3067\u884c\u308f\u308c\u3066\u3044\u307e\u3059\uff0e\n\ngazebo_ros_control/src/gazebo_ros_control_plugin.cpp\n// Overloaded Gazebo entry point\nvoid GazeboRosControlPlugin::Load(gazebo::physics::ModelPtr parent, sdf::ElementPtr sdf)\n{\n  // \u7701\u7565\n    // Listen to the update event. This event is broadcast every simulation iteration.\n    update_connection_ =\n      gazebo::event::Events::ConnectWorldUpdateBegin\n      (boost::bind(&GazeboRosControlPlugin::Update, this));\n  // \u7701\u7565\n}\n\n\nLoad()\u306f\uff0c\u30d7\u30e9\u30b0\u30a4\u30f3\u306e\u30a8\u30f3\u30c8\u30ea\u30dd\u30a4\u30f3\u30c8\u3067\u3042\u308a\uff0c\u672c\u30e1\u30bd\u30c3\u30c9\u5185\u3067Gazebo\u3068ROS\u3092\u9023\u643a\u3059\u308b\u305f\u3081\u306e\u69d8\u3005\u306a\u521d\u671f\u5316\u304c\u884c\u308f\u308c\u3066\u3044\u307e\u3059\uff0e\n\n\u8ffd\u8a18\n\n\n\nGazebo\u304b\u3089\u3069\u306e\u3088\u3046\u306b\u3053\u306eLoad()\u3092\u547c\u3093\u3067\u3044\u308b\u304b\u306b\u3064\u3044\u3066\u306f\uff0cGazebo \u304b\u3089 ROS \u306e\u30d7\u30e9\u30b0\u30a4\u30f3\u3092\u547c\u3076\u51e6\u7406\u306e\u4ed5\u7d44\u307f\uff082. \u30ed\u30dc\u30c3\u30c8\u30e2\u30c7\u30eb\u767b\u9332\u6642\u306eModelPlugin\u306e\u8aad\u8fbc\u307f\uff09\u306b\u3066\u6271\u3044\u307e\u3057\u305f\uff0e\n\n\n\n\u3055\u3066\uff0c\u8a71\u3092\u623b\u3057\u3066\uff0c\u809d\u5fc3\u306eUpdate()\u30e1\u30bd\u30c3\u30c9\u306e\u5927\u304d\u306a\u6d41\u308c\u306f\u6b21\u306e\u901a\u308a\u3067\u3059\uff0e\n\n\u30b7\u30df\u30e5\u30ec\u30fc\u30b7\u30e7\u30f3\u5468\u671f\u3068\u5236\u5fa1\u5468\u671f\u3092\u6bd4\u8f03\u3057\u307e\u3059\n\n\n\u5236\u5fa1\u5468\u671f\u5206\u6642\u9593\u304c\u9032\u3093\u3067\u3044\u305f\u3089\uff0cController\u306e\u72b6\u614b\u3092\u66f4\u65b0\u3059\u308b\u305f\u3081\uff0c\u4ee5\u964d\u306e\u51e6\u7406\u306b\u79fb\u308a\u307e\u3059\uff0e\n\n\n\nGazebo\u30e2\u30c7\u30eb\u306e\u72b6\u614b\u3092\u53d6\u5f97\u3057\uff0cController\u3067\u4f7f\u7528\u3059\u308b\u30ed\u30dc\u30c3\u30c8\u30e2\u30c7\u30eb\u306e\u72b6\u614b\u3092\u66f4\u65b0\u3057\u307e\u3059\uff0e\n\n\n\u3053\u3053\u3067\uff0cRobotHWSim::readSim()\u306e\u767b\u5834\u3067\u3059\uff0e\u30d7\u30e9\u30b0\u30a4\u30f3\u306e\u30b3\u30fc\u30c9\u3067\u30aa\u30fc\u30d0\u30e9\u30a4\u30c9\u3057\u305f\u30e1\u30bd\u30c3\u30c9\u304c\u3053\u3053\u3067\u8d70\u308a\u307e\u3059\uff0e\n\u5177\u4f53\u7684\u306b\u306f\uff0c\u524d\u8ff0\u3057\u305f\u901a\u308a\uff0cjnt_pos_, jnt_vel_, jnt_eff_\u3092\u66f4\u65b0\u3057\u307e\u3059\uff0e\n\n\n\u66f4\u65b0\u3057\u305f\u30ed\u30dc\u30c3\u30c8\u30e2\u30c7\u30eb\u306e\u60c5\u5831\u3092\u5143\u306b\uff0cController\u306b\u3088\u308b\u5236\u5fa1\u5247\u306e\u8a08\u7b97\u3092\u5b9f\u884c\u3057\u307e\u3059\uff0e\n\n\n\ncontroller_manager_->update(sim_time_ros, sim_period, reset_ctrlrs); \u306e\u90e8\u5206\u3067\u3059\uff0econtroller_manager_\u306f\uff0ccontroller_manager::ControllerManager\u30af\u30e9\u30b9\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3067\u3059\uff0e\n\u672c\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306f\u81ea\u5206\u304c\u7ba1\u7406\u3059\u3079\u304dController\u3092\u5168\u3066\u77e5\u3063\u3066\u3044\u308b\u306e\u3067\uff0cControllerManager::update()\u30e1\u30bd\u30c3\u30c9\u4e00\u3064\u3067\u5168\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u3092\u66f4\u65b0\u3067\u304d\u307e\u3059\uff0e\n\u4f8b\u3048\u3070\uff0cController\u304cJointTrajectoryController\u3067\u3042\u308c\u3070\uff0c\u524d\u8ff0\u3057\u305fjnt_pos_cmd_\u304c\u66f4\u65b0\u3055\u308c\u308b\u306e\u304c\u3053\u3053\u3067\u3059\uff0e\n\n\n\nController\u3067\u7b97\u51fa\u3057\u305f\u7d50\u679c\u3092\uff0cGazebo\u30e2\u30c7\u30eb\u5074\u306b\u53cd\u6620\u3055\u305b\u307e\u3059\uff0e\n\n\n\u3053\u3053\u3067\uff0cRobotHWSim::writeSim()\u304c\u767b\u5834\u3057\u307e\u3059\uff0e\n\u4eca\u56de\u306e\u4f8b\u3067\u306f\uff0c\u4f4d\u7f6e\u6307\u4ee4\u3067\u3042\u308bjnt_pos_cmd_\u3092\u5143\u306b\u529b\u6307\u4ee4\u3092\u8a08\u7b97\u3057\u3066\uff0cGazebo\u5074\u306b\u66f8\u304d\u8fbc\u3093\u3067\u3044\u307e\u3059\uff0e\n\n\n\n\nRobotHWSin\u3068RobotHW\u3068\u306e\u5bfe\u6bd4\n\u53c2\u8003\u3068\u3057\u3066\uff0cGazebo\u5229\u7528\u6642\u306b\u4f7f\u308f\u308c\u308bRobotHWSim\u3092\uff0c\u5b9f\u6a5f\u9069\u7528\u6642\u306b\u4f7f\u308f\u308c\u308bRobotHW\u3068\u5bfe\u6bd4\u3055\u305b\u307e\u3059\uff0eRobotHW\u306eWiki\u306b\u8a18\u8f09\u3055\u308c\u305fmain()\u306e\u8a18\u8ff0\u3092\u898b\u308c\u3070\uff0c\u30b7\u30df\u30e5\u30ec\u30fc\u30bf\u5074\u3068\u306e\u9055\u3044\u3092\u6bd4\u8f03\u3067\u304d\uff0c\u7406\u89e3\u304c\u6df1\u307e\u308b\u3068\u601d\u3044\u307e\u3059\uff0e\n\ndeclaration_of_MyRobot\n#include <hardware_interface/joint_command_interface.h>\n#include <hardware_interface/joint_state_interface.h>\n#include <hardware_interface/robot_hw.h>\n\nclass MyRobot : public hardware_interface::RobotHW\n{\n // \u7701\u7565\n};\n\n\nhardware_interface::RobotHW\u3092\u7d99\u627f\u3057\u3066\uff0cMyRobot\u3068\u3044\u3046\u30aa\u30ea\u30b8\u30ca\u30eb\u30ed\u30dc\u30c3\u30c8\u7528\u306e\u30b5\u30d6\u30af\u30e9\u30b9\u3092\u4f5c\u6210\u3057\u3066\u3044\u307e\u3059\uff0e\n\u3053\u308c\u3092\u3069\u3046\u4f7f\u3046\u306e\u304b\uff0emain()\u3092\u898b\u3066\u307f\u307e\u3059\uff0e\n\nmain_routine\nmain()\n{\n  MyRobot robot;\n  controller_manager::ControllerManager cm(&robot);\n\n  while (true)\n  {\n     robot.read();\n     cm.update(robot.get_time(), robot.get_period());\n     robot.write();\n     sleep();\n  }\n}\n\n\nread()\u3068write()\u306f\uff0c\u524d\u8ff0\u3057\u305freadSim()\u3068writeSim()\u3068\u5bfe\u5fdc\u3057\u307e\u3059\uff0e\u305f\u3060\u3057\uff0c\u5b9f\u969b\u306e\u30ed\u30dc\u30c3\u30c8\u306e\u30cf\u30fc\u30c9\u30a6\u30a7\u30a2\u306e\u4ed5\u69d8\uff08read()\u306a\u3089\u30a8\u30f3\u30b3\u30fc\u30c0\u7b49\uff0cwrite()\u306a\u3089\u30a2\u30af\u30c1\u30e5\u30a8\u30fc\u30bf\u7b49\uff09\u306b\u5408\u308f\u305b\u3066\uff0c\u81ea\u5206\u3067\u30c9\u30e9\u30a4\u30d0\u90e8\u5206\u3092\u5b9f\u88c5\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\uff0e\ncm.update()\u306f\uff0c\u307e\u3055\u306b\u524d\u8ff0\u306econtroller_manager_->update()\u3068\u540c\u3058\u5f79\u5272\u3067\u3059\uff0ecm\u306e\u5ba3\u8a00\u306e\u90e8\u5206\u3092\u898b\u308b\u3068\uff0ccontroller_manager::ControllerManager\u306e\u30b3\u30f3\u30b9\u30c8\u30e9\u30af\u30bf\u306e\u5f15\u6570\u306bMyRobot robot\u306e\u30dd\u30a4\u30f3\u30bf\u3092\u6e21\u3057\u3066\u3044\u307e\u3059\uff0ecm\u306f\uff0crobot\u306e\u60c5\u5831\u3092\u5168\u90e8\u77e5\u3063\u3066\u3044\u308b\u3053\u3068\u306b\u306a\u308a\u307e\u3059\uff0e\n\u5b9f\u306f\uff0c\u3053\u3053\u304c\u91cd\u8981\u3067\u3059\uff0e\u8a73\u7d30\u306a\u6319\u52d5\u306f\u5f8c\u8ff0\u3057\u307e\u3059\u304c\uff0cControllerManager\u5074\u306f\uff0cRobotHW\u307e\u305f\u306fRobotHWSim\u306e\u60c5\u5831\u3092\u77e5\u3089\u306a\u3044\u3068\uff0c\u306b\u3063\u3061\u3082\u3055\u3063\u3061\u3082\u3044\u304b\u306a\u3044\u3053\u3068\u306b\u306a\u308b\u306e\u3067\u3059\uff0e\u5b9f\u969b\uff0c\u5148\u307b\u3069\u306egazebo_ros_control_plugin.cpp\u306e\u4e2d\u3067\u3082\uff0cControllerManager\u306e\u521d\u671f\u5316\u306fLoad()\u30e1\u30bd\u30c3\u30c9\u5185\u3067\u4e0b\u8a18\u306e\u3088\u3046\u306b\u884c\u308f\u308c\u3066\u3044\u307e\u3059\uff0e\n\ngazebo_ros_control/src/gazebo_ros_control_plugin.cpp\n// Overloaded Gazebo entry point\nvoid GazeboRosControlPlugin::Load(gazebo::physics::ModelPtr parent, sdf::ElementPtr sdf)\n{\n // \u7701\u7565\n    // Create the controller manager\n    ROS_DEBUG_STREAM_NAMED(\"ros_control_plugin\",\"Loading controller_manager\");\n    controller_manager_.reset\n      (new controller_manager::ControllerManager(robot_hw_sim_.get(), model_nh_));\n // \u7701\u7565\n}\n\n\nRobotHW\u3068RobotHWSim\u3067\u306f\uff0c\u4e0b\u8a18\u306e\u3088\u3046\u306a\u9055\u3044\u304c\u6709\u308a\u307e\u3059\uff0e\n\n\nRobotHW\u3092\u4f7f\u3063\u305f\u5148\u307b\u3069\u306e\u30b5\u30f3\u30d7\u30eb\u3067\u306f\uff0cControllerManager\u306e\u521d\u671f\u5316\u6642\u306b\u30b3\u30f3\u30b9\u30c8\u30e9\u30af\u30bf\u3067RobotHW\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u30dd\u30a4\u30f3\u30bf\u6e21\u3057\u3066\u3044\u307e\u3057\u305f\uff0e\n\nGazeboRosControlPlugin\u3067\u306f\uff0creset()\u3068\u3044\u3046\u30e1\u30bd\u30c3\u30c9\u3067RobotHWSim\u306e\u60c5\u5831\u3092ControllerManager\u306b\u6e21\u3057\u3066\u3044\u307e\u3059\uff0e\n\n\n\u30b3\u30f3\u30b9\u30c8\u30e9\u30af\u30bf\u306e\u6bb5\u968e\u3067\uff0c\u3069\u3093\u306a\u30ed\u30dc\u30c3\u30c8\u304c\u3084\u3063\u3066\u304f\u308b\u306e\u304b\uff0cGazeboRosControlPlugin\u3067\u306f\u77e5\u3063\u305f\u3053\u3063\u3061\u3083\u3042\u308a\u307e\u305b\u3093\uff0e\n\u5165\u308c\u7269\u3060\u3051\u4f5c\u3063\u3066\uff0c\u5f8c\u3067\u30ed\u30dc\u30c3\u30c8\u306e\u60c5\u5831\u3092\u4e0a\u66f8\u304d\u3057\u3066\u3042\u3052\u308b\u30a4\u30e1\u30fc\u30b8\u3067\u3059\uff0e\n\n\n\n\n\u3044\u305a\u308c\u306b\u3057\u308d\uff0cControllerManager\u306b\u30ed\u30dc\u30c3\u30c8\u30e2\u30c7\u30eb\u306e\u60c5\u5831\u3092\u6e21\u3057\u3066\u3044\u308b\u3053\u3068\u306f\uff0c\u5171\u901a\u3057\u3066\u3044\u308b\u3088\u3046\u3067\u3059\uff0e\n\u4ee5\u4e0a\u304c\uff0c\u30d7\u30e9\u30b0\u30a4\u30f3\u306e\u52d5\u4f5c\u306e\u7406\u89e3\u3092\u6df1\u3081\u308b\u305f\u3081\u306b\u89e3\u6790\u3057\u305f\u5185\u5bb9\u3067\u3059\uff0e\n\u305f\u3060\uff0c\u4e0a\u8ff0\u3057\u305f\u8aac\u660e\u3067\u306fRobotHW\u306e\u5177\u4f53\u7684\u306a\u5b9f\u88c5\u306f\u7701\u7565\u3055\u308c\u3066\u3044\u307e\u3059\uff0e\u305d\u3053\u3067\uff0c\u672c\u7bc0\u306e\u6700\u5f8c\u306bRobotHW\u306e\u826f\u3044\u30b5\u30f3\u30d7\u30eb\u306b\u3064\u3044\u3066\u3054\u7d39\u4ecb\u3057\u307e\u3059\uff0e\n\n\nminimum_ros_control(Github: yoneken/minimum_ros_control)\n\n\n\nRobotHW\u306e\u30b5\u30f3\u30d7\u30eb\u3068\u3057\u3066\u306f\uff0cyoneken\u3055\u3093\u306b\u3088\u308bminimum_ros_control\u3068\u3044\u3046\u30ea\u30dd\u30b8\u30c8\u30ea\u304c\u6709\u7528\u3067\u3059\u306e\u3067\uff0c\u3053\u3053\u3067\u3054\u7d39\u4ecb\u3055\u305b\u3066\u3044\u305f\u3060\u304d\u307e\u3059\uff0e\n\u3053\u306e\u30b5\u30f3\u30d7\u30eb\u3067\u306f\uff0cRobotHW\u3092\u4f7f\u3046\u4e0a\u3067\u5fc5\u8981\u3068\u306a\u308b\u6700\u4f4e\u9650\u306e\u8981\u7d20\u3067\u69cb\u6210\u3055\u308c\u305f\uff0c\u975e\u5e38\u306b\u30b7\u30f3\u30d7\u30eb\u306a\u30ed\u30dc\u30c3\u30c8\u304c\u6271\u308f\u308c\u3066\u3044\u308b\uff0c\u6975\u3081\u3066\u898b\u901a\u3057\u306e\u826f\u3044\u7d20\u6674\u3089\u3057\u3044\u30b5\u30f3\u30d7\u30eb\u3067\u3059\uff0eRobotHW\u306e\u7406\u89e3\u3092\u6df1\u3081\u308b\u4e0a\u3067\uff0c\u305c\u3072\u4e00\u8aad\u3059\u308b\u3053\u3068\u3092\u30aa\u30b9\u30b9\u30e1\u3057\u307e\u3059\uff0e\n\u5b9f\u6a5f\u3092\u7d44\u3080\u3068\u304d\u306b\u306f\u3053\u306eminimum_ros_control\u3092\u30d9\u30fc\u30b9\u306b\u30ab\u30b9\u30bf\u30de\u30a4\u30ba\u3057\u3066\u3044\u304f\u3068\uff0c\u52b9\u7387\u7684\u306b\u958b\u767a\u304c\u3067\u304d\u308b\u3068\u601d\u3044\u307e\u3059\uff0e\n\n\n\n\u3053\u3053\u3067\uff0cgazebo_ros_pkg\u3067Gazebo\u5185\u306e\u30ed\u30dc\u30c3\u30c8\u3092\u5236\u5fa1\u3059\u308b\u5834\u5408\u3068\uff0cminimum_ros_control\u3067\u5b9f\u6a5f\u3092\u5236\u5fa1\u3059\u308b\u5834\u5408\u306e\u30bd\u30d5\u30c8\u30a6\u30a7\u30a2\u69cb\u6210\u56f3\u3092\u6bd4\u8f03\u3057\u3066\u307f\u307e\u3059\uff0e\n\n\n\n\n\n\n\n\u30e2\u30b8\u30e5\u30fc\u30eb\u3068\u3057\u3066\u7570\u306a\u308b\u90e8\u5206\u306f\uff0c\u4e0a\u8a18\u56f3\u4e2d\u306b\u304a\u3044\u3066\u7dd1\u306e\u77e2\u5370\u3067\u793a\u3057\u305f\u90e8\u5206\u3067\u3059\u304c\uff0c\u672c\u8cea\u7684\u306b\u306f\u5168\u304f\u540c\u4e00\u306e\u69cb\u6210\u3092\u53d6\u3063\u3066\u3044\u308b\u3053\u3068\u304c\u5206\u304b\u308a\u307e\u3059\uff0e\n\u4f7f\u7528\u3059\u308b\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u304c\uff0cJointTrajectoryController\u3068JointPositionController\u3067\u7570\u306a\u3063\u3066\u3044\u307e\u3059\u304c\uff0c\u3053\u308c\u306f\u8a2d\u5b9a\u3068\u3044\u3046\u304b\u30ed\u30dc\u30c3\u30c8\u306e\u5236\u5fa1\u306e\u4ed5\u65b9\u306e\u9055\u3044\u3068\u3044\u3046\u30ec\u30d9\u30eb\u3067\uff0cGazebo\u3060\u308d\u3046\u304cReal Robot\u3060\u308d\u3046\u304c\u5171\u901a\u3067\u5165\u308c\u66ff\u3048\u3067\u304d\u308b\u90e8\u5206\u3067\u3059\uff0e\u305f\u3060\uff0c\u5468\u671f\u3084\u30b2\u30a4\u30f3\u306e\u8a2d\u5b9a\u304c\u3042\u308b\u5834\u5408\u306b\u306f\uff0c\u30b7\u30df\u30e5\u30ec\u30fc\u30b7\u30e7\u30f3\u304b\u5b9f\u6a5f\u304b\u3067\u8a2d\u5b9a\u5024\u3092\u5207\u308a\u66ff\u3048\u308b\u306e\u304c\u5b9f\u7528\u7684\u3067\u3057\u3087\u3046\uff0e\u3053\u306e\u8fba\u308a\u306e\u8a71\u306f\uff0c\n\u6b21\u306e\u30a8\u30f3\u30c8\u30ea\u3067\u3082\u89e6\u308c\u307e\u3059\uff0e\n\n\u30d7\u30e9\u30b0\u30a4\u30f3\u3068\u3057\u3066\u4f7f\u3048\u308b\u3088\u3046\u306b\u3059\u308b\n\u3053\u3053\u307e\u3067\uff0c\u30d7\u30e9\u30b0\u30a4\u30f3\u306e\u5b9a\u7fa9\u65b9\u6cd5\u3068\u305d\u306e\u4ed5\u7d44\u307f\u306b\u3064\u3044\u3066\u8ff0\u3079\u307e\u3057\u305f\uff0e\u3057\u304b\u3057\uff0c\u5b9f\u306f\u3053\u308c\u307e\u3067\u306e\u4f5c\u696d\u3060\u3051\u3067\u306f\u307e\u3060\u4f7f\u3048\u308b\u72b6\u614b\u306b\u306f\u3042\u308a\u307e\u305b\u3093\uff0eROS\u30b7\u30b9\u30c6\u30e0\u5074\u306b\u5bfe\u3057\u3066\uff0c\u30d7\u30e9\u30b0\u30a4\u30f3\u3092\u6709\u52b9\u306b\u3059\u308b\u305f\u3081\u306e\u60c5\u5831\u3092\u6559\u3048\u3066\u3042\u3052\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\uff0e\n\u305d\u3053\u3067\uff0cpluginlib\u306e\u4ed5\u7d44\u307f\u3092\u4f7f\u3063\u3066\uff0c\u4e0a\u8a18\u30b3\u30fc\u30c9\u3092\u6b63\u5f0f\u306b\u30d7\u30e9\u30b0\u30a4\u30f3\u5316\u3057\u307e\u3059\uff0e\n\n\u30d7\u30e9\u30b0\u30a4\u30f3\u3068\u3057\u3066\u51fa\u529b\u3059\u308b\u305f\u3081\u306e\u8a2d\u5b9a\n\n\n\u30d7\u30e9\u30b0\u30a4\u30f3\u7528\u306e\u30d5\u30a1\u30a4\u30eb\u3068\u3057\u3066\u51fa\u529b\u3055\u308c\u308b\u3088\u3046\u306b\uff0c\u30b3\u30fc\u30c9\u5074\u306b\u8ffd\u8a18\u304c\u5fc5\u8981\u3067\u3059\uff0e\n\u30b3\u30fc\u30c9\u5185\u306e\u3069\u3053\u3067\u3082\u3088\u3044\u306e\u3067\uff0cPLUGINLIB_EXPORT_CLASS(\u767b\u9332\u5bfe\u8c61\u306e\u30af\u30e9\u30b9\u540d, \u767b\u9332\u5bfe\u8c61\u306e\u30af\u30e9\u30b9\u306e\u89aa\u30af\u30e9\u30b9\u540d)\u306e\u30de\u30af\u30ed\u3092\u66f8\u304d\u307e\u3059\uff0e\n\u5148\u307b\u3069\u306e\u4f8b\u3067\u306f\uff0c\u6700\u7d42\u884c\u306b\u66f8\u3044\u3066\u3042\u308a\u307e\u3057\u305f\uff0e\u3053\u308c\u304c\u4e00\u822c\u7684\u306a\u3084\u308a\u65b9\u3068\u306e\u3053\u3068\u3067\u3059\uff0e\n\n\n\n\nrosbook_arm_hardware_gazebo/src/rosbook_arm_hardware_gazebo.cpp\n// \u305c\u30fc\u3093\u3076\u7701\u7565\u3057\u3066\uff0c\u6700\u7d42\u884c\u306e\u307f\nPLUGINLIB_EXPORT_CLASS(rosbook_arm_hardware_gazebo::ROSBookArmHardwareGazebo, gazebo_ros_control::RobotHWSim)\n\n\n\n\u30d7\u30e9\u30b0\u30a4\u30f3\u8aac\u660e\u30d5\u30a1\u30a4\u30eb\u306e\u767b\u9332\n\n\n\u4e0a\u8a18\u30de\u30af\u30ed\u3067\u306f\u66f8\u304d\u304d\u308c\u306a\u3044\u60c5\u5831\u3092\u767b\u9332\u3057\u307e\u3059\uff0e\u30d7\u30e9\u30b0\u30a4\u30f3\u306e\u4ed5\u69d8\u3068\u304b\u306f\u3053\u3061\u3089\u3067\u3059\uff0e\nROS\u30b7\u30b9\u30c6\u30e0\u304c\u3053\u306e\u30d7\u30e9\u30b0\u30a4\u30f3\u3092\u81ea\u52d5\u3067\u691c\u51fa\u30fb\u8aad\u8fbc\u3067\u304d\u308b\u3088\u3046\u306b\u3059\u308b\u305f\u3081\u306b\u5fc5\u8981\u3068\u306e\u3053\u3068\u3067\u3059\uff0e\n\nrosbook_arm_hardware_gazebo/ROSBookArmHardwareGazebo\u306e\u4f8b\u3067\u306f\u4e0b\u8a18\u306e\u3068\u304a\u308a\u3067\u3059\uff0e\n\n\n\n\nrosbook_arm_hardware_gazebo/rosbook_arm_hardware_gazebo_plugins.xml\n<library path=\"lib/librosbook_arm_hardware_gazebo\">\n  <class\n    name=\"rosbook_arm_hardware_gazebo/ROSBookArmHardwareGazebo\"\n    type=\"rosbook_arm_hardware_gazebo::ROSBookArmHardwareGazebo\"\n    base_class_type=\"gazebo_ros_control::RobotHWSim\">\n    <description>\n      ROS Book arm simulation interface.\n    </description>\n  </class>\n</library>\n\n\n\n\nROS\u30d1\u30c3\u30b1\u30fc\u30b8\u30b7\u30b9\u30c6\u30e0\u3078\u306e\u30d7\u30e9\u30b0\u30a4\u30f3\u306e\u767b\u9332\n\n\n\nROS\u30b7\u30b9\u30c6\u30e0\u5168\u4f53\u3067\u3053\u306e\u30d7\u30e9\u30b0\u30a4\u30f3\u3092\u4f7f\u3048\u308b\u3088\u3046\u306b\u3059\u308b\u305f\u3081\u306e\u8a2d\u5b9a\u3092\u3057\u307e\u3059\uff0e\n\npackage.xml\u306b<export>\u30bf\u30b0\u3092\u8ffd\u52a0\u3057\u307e\u3059\uff0e\n\nrosbook_arm_hardware_gazebo/ROSBookArmHardwareGazebo\u306e\u4f8b\u3067\u306f\u4e0b\u8a18\u306e\u3068\u304a\u308a\u3067\u3059\uff0e\n\n\n\n\nrosbook_arm_hardware_gazebo/package.xml\n  <export>\n    <gazebo_ros_control plugin=\"${prefix}/rosbook_arm_hardware_gazebo_plugins.xml\"/>\n  </export>\n\n\n\u30d5\u30a1\u30a4\u30eb\u3068\u3057\u3066\u306e\u8a2d\u5b9a\u306f\u4ee5\u4e0a\u3067\u3059\uff0e\u4ee5\u964d\u306e\u51e6\u7406\u306fpluginlib\u3092\u53c2\u8003\u306b\u9032\u3081\u308c\u3070OK\u3067\u3059\uff0e\n\nDefaultRobotHWSim\u306b\u3064\u3044\u3066\n\u4f5c\u6210\u3057\u305fROSBookArmHardwareGazebo\u3067\u306f\uff0cJointStateInterface\u3084PositionJointInterface\u3092\u81ea\u5206\u3067\u5ba3\u8a00\u3057\u307e\u3057\u305f\u304c\uff0cDefaultRobotHWSim\u3067\u306f\u3069\u3046\u3057\u3066\u3044\u308b\u306e\u3067\u3057\u3087\u3046\u304b\uff1f\u30c7\u30d5\u30a9\u30eb\u30c8\u3067\u7528\u610f\u3055\u308c\u305f\u30d7\u30e9\u30b0\u30a4\u30f3\u3092\u4f7f\u3046\u5834\u5408\uff0c\u79c1\u9054\u304c\u7de8\u96c6\u3092\u3059\u308b\u4f59\u5730\u306f\u3042\u308a\u307e\u305b\u3093\uff0e\n\u3061\u3087\u3063\u3068\u30b3\u30fc\u30c9\u3092\u8997\u3044\u3066\u307f\u307e\u3059\uff0e\n\ngazebo_ros_control/include/gazebo_ros_control/default_robot_hw_sim.h\n// \u7701\u7565\nnamespace gazebo_ros_control\n{\nclass DefaultRobotHWSim : public gazebo_ros_control::RobotHWSim\n// \u7701\u7565\n{\n// \u7701\u7565\n  hardware_interface::JointStateInterface    js_interface_;\n  hardware_interface::EffortJointInterface   ej_interface_;\n  hardware_interface::PositionJointInterface pj_interface_;\n  hardware_interface::VelocityJointInterface vj_interface_;\n// \u7701\u7565\n}\n// \u7701\u7565\n}\n\n\nJointStateInterface\uff0cEffortJointInterface\uff0cPositionJointInterface\uff4d\uff0cVelocityJointInterface\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u5ba3\u8a00\u304c\u30aa\u30f3\u30d1\u30ec\u30fc\u30c9\u3067\u3059\uff0e\n\u30e6\u30fc\u30b6\u5b9a\u7fa9\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u304b\u3089\u3069\u3093\u306a\u30a4\u30f3\u30bf\u30fc\u30d5\u30a7\u30fc\u30b9\u304c\u964d\u3063\u3066\u304f\u308b\u304b\u306a\u3069\uff0cDefaultRobotHWSim\u304b\u3089\u3057\u305f\u3089\u5206\u304b\u3089\u306a\u3044\u3053\u3068\u306a\u306e\u3067\uff0c\u4ee3\u8868\u7684\u306a\u30a4\u30f3\u30bf\u30fc\u30d5\u30a7\u30fc\u30b9\u306b\u3064\u3044\u3066\u306f\u4e88\u3081\u571f\u53f0\u3092\u4f5c\u3063\u3066\u304a\u304f\u3088\u3046\u3067\u3059\uff0e\u3053\u308c\u3092\u3069\u3046\u6271\u3046\u306e\u304b\uff0cinitSim()\u3092\u898b\u3066\u307f\u307e\u3059\uff0e\n\ngazebo_ros_control/src/default_robot_hw_sim.cpp\n// \u7701\u7565\nnamespace gazebo_ros_control\n{\n// \u7701\u7565\nbool DefaultRobotHWSim::initSim(\n  const std::string& robot_namespace,\n  ros::NodeHandle model_nh,\n  gazebo::physics::ModelPtr parent_model,\n  const urdf::Model *const urdf_model,\n  std::vector<transmission_interface::TransmissionInfo> transmissions)\n{\n// \u7701\u7565\n  n_dof_ = transmissions.size(); \n// \u7701\u7565\n  // Initialize values \n  for(unsigned int j=0; j < n_dof_; j++) \n  { \n// \u7701\u7565\n    std::vector<std::string> joint_interfaces = transmissions[j].joints_[0].hardware_interfaces_;\n// \u7701\u7565\n    const std::string& hardware_interface = joint_interfaces.front();\n// \u7701\u7565\n    // Add data from transmission\n    joint_names_[j] = transmissions[j].joints_[0].name_;\n// \u7701\u7565\n    if(hardware_interface == \"EffortJointInterface\")\n    {\n      // Create effort joint interface\n      joint_control_methods_[j] = EFFORT;\n      joint_handle = hardware_interface::JointHandle(js_interface_.getHandle(joint_names_[j]),\n                                                     &joint_effort_command_[j]);\n      ej_interface_.registerHandle(joint_handle);\n    }\n    else if(hardware_interface == \"PositionJointInterface\")\n    {\n      // Create position joint interface\n      joint_control_methods_[j] = POSITION;\n      joint_handle = hardware_interface::JointHandle(js_interface_.getHandle(joint_names_[j]),\n                                                     &joint_position_command_[j]);\n      pj_interface_.registerHandle(joint_handle);\n    }\n    else if(hardware_interface == \"VelocityJointInterface\")\n    {\n      // Create velocity joint interface\n      joint_control_methods_[j] = VELOCITY;\n      joint_handle = hardware_interface::JointHandle(js_interface_.getHandle(joint_names_[j]),\n                                                     &joint_velocity_command_[j]);\n      vj_interface_.registerHandle(joint_handle);\n    }\n// \u7701\u7565\n  }\n// \u7701\u7565\n}\n// \u7701\u7565\n}\n\n\nURDF\u306e<transmission>\u30bf\u30b0\u5185\u306e<hardwareInterface>\u30bf\u30b0\u3067\u6307\u5b9a\u3057\u305f\u30a4\u30f3\u30bf\u30fc\u30d5\u30a7\u30fc\u30b9\u7a2e\u5225\u3092\u8aad\u307f\u3060\u3057\u3066\uff0c\u305d\u306e\u7a2e\u5225\u306b\u5fdc\u3058\u3066\u767b\u9332\u5bfe\u8c61\u306e\u30a4\u30f3\u30bf\u30fc\u30d5\u30a7\u30fc\u30b9\u3092\u5207\u308a\u66ff\u3048\u3066\u3044\u307e\u3059\uff0e\u3060\u304b\u3089\uff0cGazebo\u3092\u4f7f\u3046\u3068\u304d\u306b\u306f\uff0c<transmission>\u306e\u8a2d\u5b9a\u3067HardwareInterface\u306e\u7a2e\u5225\u3092\u5165\u529b\u3059\u308b\u5fc5\u8981\u304c\u3042\u3063\u305f\u306e\u3067\u3059\uff0e\n\n\u304a\u308f\u308a\u306b\n\u4eca\u56de\u306f\uff0cRobotHWSim\u306e\u52d5\u4f5c\u306b\u30d5\u30a9\u30fc\u30ab\u30b9\u3092\u5f53\u3066\u3066\u89e3\u6790\u3092\u884c\u3044\u307e\u3057\u305f\uff0e\u30d7\u30e9\u30b0\u30a4\u30f3\u306e\u4f5c\u6210\u65b9\u6cd5\u3068\u7d61\u3081\u306a\u304c\u3089\uff0c\u5468\u8fba\u306e\u30e2\u30b8\u30e5\u30fc\u30eb\u3068\u3069\u306e\u3088\u3046\u306b\u95a2\u308f\u3063\u3066\u3044\u308b\u304b\u3082\u5c11\u3057\u7406\u89e3\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3057\u305f\uff0e\n\u6b21\u56de\u306f\uff0c\u300c3. Controller\u306b\u3064\u3044\u3066\u300d\u8aac\u660e\u3057\u307e\u3059\uff0e\u3053\u3053\u307e\u3067\u5206\u304b\u308c\u3070\uff0cGazebo\u3068ROS\u306e\u9023\u643a\u306b\u95a2\u3059\u308b\uff0c\u4e00\u901a\u308a\u306e\u6d41\u308c\u304c\u3064\u304b\u3081\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3059\uff0e\n\n# \u76ee\u6b21\n1. [\u30ed\u30dc\u30c3\u30c8\u30e2\u30c7\u30eb\u306e\u5b9a\u7fa9\u3068\u767b\u9332](http://qiita.com/MoriKen/items/613635b90f3a98042dc5)\n 1. `URDF`\u3067\u30ed\u30dc\u30c3\u30c8\u30e2\u30c7\u30eb\u3092\u5b9a\u7fa9\u3059\u308b\n 1. `HardwareInterface`\u306e\u5b58\u5728\u610f\u7fa9\n 1. `URDF`\u3067`Gazebo`\u306e\u8a2d\u5b9a\u3092\u3059\u308b\n 1. \u30ed\u30dc\u30c3\u30c8\u30e2\u30c7\u30eb\u3092\u30d1\u30e9\u30e1\u30fc\u30bf\u30b5\u30fc\u30d0\u306b\u767b\u9332\u3059\u308b\n1. [`RobotHWSim`\u306e\u30d7\u30e9\u30b0\u30a4\u30f3\u306b\u3064\u3044\u3066](http://qiita.com/MoriKen/items/5cab7436c1b36c25e0ce)\u3000\u2190\u3000\u30a4\u30de\u30b3\u30b3\n 1. \u30d7\u30e9\u30b0\u30a4\u30f3\u306e\u5b9a\u7fa9\n 1. \u30d7\u30e9\u30b0\u30a4\u30f3\u3067\u5b9a\u7fa9\u3055\u308c\u305f\u51e6\u7406\u304c\u5b9f\u884c\u3055\u308c\u308b\u5834\u6240\n 1. `RobotHWSin`\u3068`RobotHW`\u3068\u306e\u5bfe\u6bd4\n 1. \u30d7\u30e9\u30b0\u30a4\u30f3\u3068\u3057\u3066\u4f7f\u3048\u308b\u3088\u3046\u306b\u3059\u308b \n 1. `DefaultRobotHWSim`\u306b\u3064\u3044\u3066\n1. [`Controller`\u306b\u3064\u3044\u3066](http://qiita.com/MoriKen/items/c29f653d03baffe5f0e2)\n 1. `Gazebo`\u306b\u30ed\u30dc\u30c3\u30c8\u30e2\u30c7\u30eb\u3092Spawn\u3059\u308b\n 1. `Controller`\u3092\u8d77\u52d5\u3059\u308b\n 1. `ControllerManager`\u3068`HardwareInterface`\u3068\u306e\u30de\u30c3\u30d4\u30f3\u30b0\n\n# \u304a\u984c\n- \u66f8\u7c4d\n - [Learning ROS for Robotics Programming - Second Edition](http://www.amazon.co.jp/Learning-ROS-Robotics-Programming-Edition-ebook/dp/B00YSIL6VM) `Chapter 10: Manipulation with MoveIt!`<br/>\n<img src=\"https://qiita-image-store.s3.amazonaws.com/0/110138/92e03e5e-dce8-008b-19a2-00ecafd6fbec.jpeg\" data-canonical-src=\"http://www.amazon.co.jp/Learning-ROS-Robotics-Programming-Edition-ebook/dp/B00YSIL6VM\" width=\"20%\" />\n<br /><br />\n- \u30ea\u30dd\u30b8\u30c8\u30ea\n - [github: AaronMR/Learning_ROS_for_Robotics_Programming_2nd_edition](https://github.com/AaronMR/Learning_ROS_for_Robotics_Programming_2nd_edition)\n\n# \u306f\u3058\u3081\u306b\n\u300c[1. \u30ed\u30dc\u30c3\u30c8\u30e2\u30c7\u30eb\u306e\u5b9a\u7fa9\u3068\u767b\u9332](http://qiita.com/MoriKen/items/613635b90f3a98042dc5)\u300d\u306e\u8aac\u660e\u306b\u304a\u3044\u3066\uff0c`gazebo.urdf.xacro`\u3067`rosbook_arm_hardware_gazebo/ROSBookArmHardwareGazebo`\u3068\u3044\u3046\u30ab\u30b9\u30bf\u30e0\u30d7\u30e9\u30b0\u30a4\u30f3\u3092\u6307\u5b9a\u3057\u305f\u7b87\u6240\u304c\u3042\u308a\u307e\u3057\u305f\uff0e\u3053\u306e\u6b63\u4f53\u3092\u68da\u4e0a\u3052\u306b\u3057\u3066\u3044\u305f\u306e\u3067\uff0c\u3053\u3053\u3067\u7406\u89e3\u3092\u6df1\u3081\u308b\u3053\u3068\u306b\u3057\u307e\u3059\uff0e\n\n\u672c\u5bb6\u30b5\u30a4\u30c8\u306e\u56f3\u306b\u304a\u3044\u3066\uff0c\u4e0b\u8a18\u30d4\u30f3\u30af\u3067\u56f2\u3063\u305f\u7b87\u6240\u3067\u3059\uff0e\n![gazebo_plugin.png](https://qiita-image-store.s3.amazonaws.com/0/110138/59cb1a64-54cd-410a-7e20-0cfe5ed62f63.png)\n\n\u672c\u8a18\u4e8b\u7528\u306e\u307e\u3068\u3081\u306e\u56f3\u306b\u304a\u3044\u3066\u306f\uff0c\u4e0b\u8a18\u306e\u7dd1\u3067\u56f2\u3063\u305f\u7b87\u6240\u3067\u3059\uff0e\n![2.summary.png](https://qiita-image-store.s3.amazonaws.com/0/110138/b5066445-fe50-eede-9977-ee2ebde25198.png)\n\n\n# \u30d7\u30e9\u30b0\u30a4\u30f3\u306e\u5b9a\u7fa9\n\u3053\u306e\u30ab\u30b9\u30bf\u30e0\u30d7\u30e9\u30b0\u30a4\u30f3\u306e\u5b9f\u4f53\u306f\uff0c`rosbook_arm_hardware_gazebo`\u30d1\u30c3\u30b1\u30fc\u30b8\u306e\u4e2d\u306b\u3042\u308a\uff0cC++\u3067\u5b9f\u88c5\u3055\u308c\u3066\u3044\u307e\u3059\uff0e\u5927\u4e8b\u306a\u3068\u3053\u308d\u3060\u3051\u8997\u3044\u3066\u307f\u307e\u3059\uff0e\n\n```cpp:rosbook_arm_hardware_gazebo/include/rosbook_arm_hardware_gazebo/rosbook_arm_hardware_gazebo.h\n  // \u7701\u7565\n#include <hardware_interface/robot_hw.h>\n  // \u7701\u7565\n#include <gazebo_ros_control/robot_hw_sim.h>\n  // \u7701\u7565\nnamespace rosbook_arm_hardware_gazebo\n{\n\nclass ROSBookArmHardwareGazebo : public gazebo_ros_control::RobotHWSim\n{\npublic:\n\n  ROSBookArmHardwareGazebo();\n\n  bool initSim(const std::string& robot_namespace,\n      ros::NodeHandle model_nh,\n      gazebo::physics::ModelPtr parent_model,\n      const urdf::Model* const urdf_model,\n      std::vector<transmission_interface::TransmissionInfo> transmissions);\n\n  void readSim(ros::Time time, ros::Duration period);\n\n  void writeSim(ros::Time time, ros::Duration period);\n  // \u7701\u7565\nprivate:\n  // \u7701\u7565\n  std::vector<double> jnt_pos_;\n  std::vector<double> jnt_vel_;\n  std::vector<double> jnt_eff_;\n\n  std::vector<double> jnt_pos_cmd_;\n\n  std::vector<gazebo::physics::JointPtr> sim_joints_;\n\n  // Hardware interface: joints\n  hardware_interface::JointStateInterface    jnt_state_interface_;\n  hardware_interface::PositionJointInterface jnt_pos_cmd_interface_;\n  // \u7701\u7565\n};\n\n} // namespace rosbook_arm_hardware_gazebo\n\n#endif // ROSBOOK_ARM_HARDWARE_GAZEBO_H\n```\n![ROSBookArmHardwareGazebo2.png](https://qiita-image-store.s3.amazonaws.com/0/110138/b2f83ab7-caad-8d8c-e5ec-ec6f6d4fee5c.png)\n\n\ninitSim(), readSim(), writeSim() \u30e1\u30bd\u30c3\u30c9\u304c\u91cd\u8981\u3067\u3059\uff0e`HardwareInterface`\u3068`Controller`\u3068\u306e\u3084\u308a\u3068\u308a\u3084\uff0c`HardwareInterface`\u3068`Gazebo`\u3068\u306e\u3084\u308a\u3068\u308a\u3092\u5b9f\u73fe\u3059\u308b\u90e8\u5206\u3067\u3059\uff0e\u3053\u308c\u3089\u306e\u30e1\u30bd\u30c3\u30c9\u306f\uff0c`gazebo_ros_control::RobotHWSim`\u30af\u30e9\u30b9\u3067\u7d14\u7c8b\u4eee\u60f3\u30e1\u30bd\u30c3\u30c9\u3068\u3057\u3066\u5ba3\u8a00\u3055\u308c\u3066\u3044\u308b\u306e\u3067\uff0c\u30ab\u30b9\u30bf\u30de\u30a4\u30ba\u3057\u305f\u30e1\u30bd\u30c3\u30c9\u3067\u30aa\u30fc\u30d0\u30fc\u30e9\u30a4\u30c9\u3057\u3066\u3042\u3052\u307e\u3059\uff0e\u5b9a\u7fa9\u306b\u3064\u3044\u3066\u306f\uff0c\u4e0b\u8a18\u306e\u30b3\u30fc\u30c9\u3067\u898b\u3066\u307f\u307e\u3057\u3087\u3046\uff0e\n\n```cpp:rosbook_arm_hardware_gazebo/src/rosbook_arm_hardware_gazebo.cpp\n  // \u7701\u7565\n#include <rosbook_arm_hardware_gazebo/rosbook_arm_hardware_gazebo.h>\n\nnamespace rosbook_arm_hardware_gazebo\n{\n  using namespace hardware_interface;\n  // \u7701\u7565\n  bool ROSBookArmHardwareGazebo::initSim(const std::string& robot_namespace,\n      ros::NodeHandle nh,\n      gazebo::physics::ModelPtr model,\n      const urdf::Model* const urdf_model,\n      std::vector<transmission_interface::TransmissionInfo> transmissions)\n  {\n    using gazebo::physics::JointPtr;\n\n    // Cleanup\n    sim_joints_.clear();\n    jnt_pos_.clear();\n    jnt_vel_.clear();\n    jnt_eff_.clear();\n    jnt_pos_cmd_.clear();\n\n    // Simulation joints\n    sim_joints_ = model->GetJoints();\n    n_dof_ = sim_joints_.size();\n\n    std::vector<std::string> jnt_names;\n    for (size_t i = 0; i < n_dof_; ++i)\n    {\n      jnt_names.push_back(sim_joints_[i]->GetName());\n    }\n\n    // Raw data\n    jnt_pos_.resize(n_dof_);\n    jnt_vel_.resize(n_dof_);\n    jnt_eff_.resize(n_dof_);\n    jnt_pos_cmd_.resize(n_dof_);\n\n    // Hardware interfaces\n    for (size_t i = 0; i < n_dof_; ++i)\n    {\n      jnt_state_interface_.registerHandle(\n          JointStateHandle(jnt_names[i], &jnt_pos_[i], &jnt_vel_[i], &jnt_eff_[i]));\n\n      jnt_pos_cmd_interface_.registerHandle(\n          JointHandle(jnt_state_interface_.getHandle(jnt_names[i]), &jnt_pos_cmd_[i]));\n\n      ROS_DEBUG_STREAM(\"Registered joint '\" << jnt_names[i] << \"' in the PositionJointInterface.\");\n    }\n\n    registerInterface(&jnt_state_interface_);\n    registerInterface(&jnt_pos_cmd_interface_);\n\n  // \u7701\u7565\n    }\n  // \u7701\u7565\n    return true;\n  }\n\n  void ROSBookArmHardwareGazebo::readSim(ros::Time time, ros::Duration period)\n  {\n    for (size_t i = 0; i < n_dof_; ++i)\n    {\n      jnt_pos_[i] += angles::shortest_angular_distance\n          (jnt_pos_[i], sim_joints_[i]->GetAngle(0u).Radian());\n      jnt_vel_[i] = sim_joints_[i]->GetVelocity(0u);\n      jnt_eff_[i] = sim_joints_[i]->GetForce(0u);\n    }\n  }\n\n  void ROSBookArmHardwareGazebo::writeSim(ros::Time time, ros::Duration period)\n  {\n    // Enforce joint limits\n    jnt_limits_interface_.enforceLimits(period);\n\n    // Compute and send commands\n    for (size_t i = 0; i < n_dof_; ++i)\n    {\n      const double error = jnt_pos_cmd_[i] - jnt_pos_[i];\n      const double effort = pids_[i].computeCommand(error, period);\n\n      sim_joints_[i]->SetForce(0u, effort);\n    }\n  }\n\n} // namespace rosbook_hardware_gazebo\n\nPLUGINLIB_EXPORT_CLASS(rosbook_arm_hardware_gazebo::ROSBookArmHardwareGazebo, gazebo_ros_control::RobotHWSim)\n```\n\n\u91cd\u8981\u306a\u4e09\u3064\u306e\u30e1\u30bd\u30c3\u30c9\u304c\u30aa\u30fc\u30d0\u30fc\u30e9\u30a4\u30c9\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u304c\u78ba\u8a8d\u3067\u304d\u307e\u3059\uff0e\u6982\u8981\u306f\u4e0b\u8a18\u306e\u3068\u304a\u308a\u3067\u3059\uff0e\n\n- initSim()\n - \u30d1\u30e9\u30e1\u30fc\u30bf\u30b5\u30fc\u30d0\u306b\u767b\u9332\u3055\u308c\u305f\u30ed\u30dc\u30c3\u30c8\u30e2\u30c7\u30eb\u304b\u3089\uff0cjoint \u540d\u3092\u53d6\u5f97\u3057\u307e\u3059\uff0e\n - \u53d6\u5f97\u3057\u305fjoint \u540d\u3067`JointState`\u306e\u30cf\u30f3\u30c9\u30eb\u3092\u4f5c\u6210\u3057\uff0c`Hardware Resource Interface`\u3092\u30a4\u30f3\u30bf\u30fc\u30d5\u30a7\u30fc\u30b9\u3068\u3057\u3066\u767b\u9332\u3057\u307e\u3059\uff0e\u72b6\u614b\u306e\u8aad\u307f\u51fa\u3057\u306b\u4f7f\u3046\u306e\u304c`hardware_interface::JointStateInterface jnt_state_interface_`\u3067\uff0c\u6307\u4ee4\u306b\u66f8\u304d\u8fbc\u307f\u306b\u4f7f\u3046\u306e\u304c`hardware_interface::PositionJointInterface jnt_pos_cmd_interface_`\u3067\u3059\uff0e\uff08\u3053\u308c\u3089\u306f\u3044\u305a\u308c\u3082`hardware_interface::HardwareResourceManager`\u30af\u30e9\u30b9\u306e\u30b5\u30d6\u30af\u30e9\u30b9\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3067\u3059\uff0e\uff09\n - \u5f8c\u3005`Controller`\u304c`HardwareInterface`\u3092\u4ecb\u3057\u3066\u3084\u308a\u3068\u308a\u3067\u304d\u308b\u3088\u3046\u306b\uff0c`JointStateInterface`\u3084`PositionJointInterface`\u306e\u30cf\u30f3\u30c9\u30eb\u4f5c\u6210\u6642\u306b\uff0cjoint \u306b\u307e\u3064\u308f\u308b\u30e1\u30f3\u30d0\u5909\u6570\uff08`jnt_pos_`, `jnt_vel_`, `jnt_eff_`, `jnt_pos_cmd_`\uff09\u306e\u30dd\u30a4\u30f3\u30bf\u3092\u767b\u9332\u3057\u3066\u3044\u307e\u3059\uff0e\n- readSim()\n - \u73fe\u5728\u306e`Gazebo`\u306b\u304a\u3051\u308b\u30ed\u30dc\u30c3\u30c8\u30e2\u30c7\u30eb\u306ejoint \u306e\u72b6\u614b\uff08\u4f4d\u7f6e\uff0c\u901f\u5ea6\uff0c\u30c8\u30eb\u30af\uff09\u3092\u53d6\u5f97\u3057\u3066\uff0c\u5148\u307b\u3069initSim()\u3067\u6e21\u3057\u305f\u30e1\u30f3\u30d0\u5909\u6570\u3092\u4ecb\u3057\u3066`HardwareInterface`\u306b\u53d6\u5f97\u3057\u305f\u60c5\u5831\u3092\u6559\u3048\u3066\u3042\u3052\u307e\u3059\uff0e\n- writeSim()\n - `Gazebo`\u306b\u304a\u3051\u308b\u30ed\u30dc\u30c3\u30c8\u30e2\u30c7\u30eb\u306ejoint \u306b\u6307\u4ee4\u5024\u3092\u9001\u308a\u307e\u3059\uff0e\u4eca\u56de\u306e\u30b5\u30f3\u30d7\u30eb\u306e\u5834\u5408\uff0c`hardware_interface::PositionJointInterface jnt_pos_cmd_interface_`\u3067\u53d6\u5f97\u3057\u305f\u4f4d\u7f6e\u6307\u4ee4\u304b\u3089\u529b\u6307\u4ee4\u3092\u8a08\u7b97\u3057\uff0c`Gazebo`\u306b\u9001\u308a\u307e\u3059\uff0e\n\n\u4e0a\u8ff0\u306e\u30a4\u30e1\u30fc\u30b8\u3092\u56f3\u3067\u8868\u3059\u3068\uff0c\u4e0b\u56f3\u306e\u3088\u3046\u306b\u306a\u308a\u307e\u3059\uff0e<br/>\n![RobotHWSim_HardwareInterface.png](https://qiita-image-store.s3.amazonaws.com/0/110138/398a087e-7e08-9c28-6add-d0461b2ae953.png)\n\n\u3053\u3053\u307e\u3067\u898b\u308c\u3070\uff0c\u3053\u306e3\u3064\u306e\u30e1\u30bd\u30c3\u30c9\u304c\uff0c\u30d7\u30e9\u30b0\u30a4\u30f3\u306e\u52d5\u4f5c\u3092\u6c7a\u5b9a\u3065\u3051\u308b\u91cd\u8981\u9805\u76ee\u3067\u3042\u308b\u3053\u3068\u304c\u7406\u89e3\u3067\u304d\u307e\u3059\uff0e\n\n# \u30d7\u30e9\u30b0\u30a4\u30f3\u3067\u5b9a\u7fa9\u3055\u308c\u305f\u51e6\u7406\u304c\u5b9f\u884c\u3055\u308c\u308b\u5834\u6240\n\u3067\u306f\uff0c\u3053\u308c\u3089\u306e\u30e1\u30bd\u30c3\u30c9\u306f\u3044\u3064\u547c\u3070\u308c\u308b\u306e\u3067\u3057\u3087\u3046\u304b\uff1f\n\n`ROS`\u3068`Gazebo`\u3092\u9023\u643a\u3055\u305b\u308b\u3068\uff0c`GazeboRosControlPlugin`\u3068\u3044\u3046\uff0c`Gazebo`\u306e\u30d7\u30e9\u30b0\u30a4\u30f3\u3068`ROS`\u9593\u306e\u30a4\u30f3\u30bf\u30fc\u30d5\u30a7\u30fc\u30b9\u3092\u5236\u5fa1\u3059\u308b\u305f\u3081\u306e\u30af\u30e9\u30b9\u304c\u50cd\u3044\u3066\u304f\u308c\u307e\u3059\uff0e\u30ed\u30dc\u30c3\u30c8\u30e2\u30c7\u30eb\u3092Spawn\u3059\u308b\u969b\u306b\uff0c`robot_description`\u306e\u60c5\u5831\u304c\u6e21\u3055\u308c\u307e\u3059\uff0e\u4f7f\u7528\u3059\u308b\u30d7\u30e9\u30b0\u30a4\u30f3\u306e\u60c5\u5831\u304c\u305d\u306e\u4e2d\u306b\u7d44\u307f\u8fbc\u307e\u308c\u3066\u3044\u308b\u306e\u3067\uff0c`GazeboRosControlPlugin`\u306f\u3069\u306e\u30d7\u30e9\u30b0\u30a4\u30f3\u3092\u4f7f\u3048\u3070\u826f\u3044\u306e\u304b\u3092\u77e5\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\uff0e\n\n\u3067\u306f\uff0c\u4e0a\u8a18\u30d7\u30e9\u30b0\u30a4\u30f3\u306e\u30e1\u30bd\u30c3\u30c9\u304c\u5b9f\u969b\u306b\u547c\u3070\u308c\u308b\u5834\u6240\u304c\u3069\u3053\u306b\u306a\u308b\u306e\u304b\u304c\u6c17\u306b\u306a\u308a\u307e\u3059\uff0e\u8abf\u3079\u308b\u3068\uff0c\u4e0b\u8a18\u306e\u30ea\u30dd\u30b8\u30c8\u30ea\u306b\u3042\u308a\u307e\u3057\u305f\uff0e\n[github: ros-controls/gazebo_ros_control](https://github.com/ros-controls/gazebo_ros_control)\n\n```cpp:gazebo_ros_control/src/gazebo_ros_control_plugin.cpp\n  // \u7701\u7565\n// Called by the world update start event\nvoid GazeboRosControlPlugin::Update()\n{\n  // Get the simulation time and period\n  gazebo::common::Time gz_time_now = parent_model_->GetWorld()->GetSimTime();\n  ros::Time sim_time_ros(gz_time_now.sec, gz_time_now.nsec);\n  ros::Duration sim_period = sim_time_ros - last_update_sim_time_ros_;\n\n  robot_hw_sim_->eStopActive(e_stop_active_);\n\n  // Check if we should update the controllers\n  if(sim_period >= control_period_) {\n    // Store this simulation time\n    last_update_sim_time_ros_ = sim_time_ros;\n\n    // Update the robot simulation with the state of the gazebo model\n    robot_hw_sim_->readSim(sim_time_ros, sim_period);\n\n    // Compute the controller commands\n  // \u7701\u7565\n    controller_manager_->update(sim_time_ros, sim_period, reset_ctrlrs);\n  }\n\n  // Update the gazebo model with the result of the controller\n  // computation\n  robot_hw_sim_->writeSim(sim_time_ros, sim_time_ros - last_write_sim_time_ros_);\n  last_write_sim_time_ros_ = sim_time_ros;\n}\n  // \u7701\u7565\n```\n\n\u672c`Update()`\u30e1\u30bd\u30c3\u30c9\u306f\u30b7\u30df\u30e5\u30ec\u30fc\u30b7\u30e7\u30f3\u5468\u671f\u6bce\u306b\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u3055\u308c\u307e\u3059\uff0e\u672c\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u95a2\u6570\u306e\u767b\u9332\u306f\u540c\u30af\u30e9\u30b9\u306e\u30e1\u30bd\u30c3\u30c9\u3067\u3042\u308b`Load()`\u3067\u884c\u308f\u308c\u3066\u3044\u307e\u3059\uff0e\n\n```cpp:gazebo_ros_control/src/gazebo_ros_control_plugin.cpp\n// Overloaded Gazebo entry point\nvoid GazeboRosControlPlugin::Load(gazebo::physics::ModelPtr parent, sdf::ElementPtr sdf)\n{\n  // \u7701\u7565\n    // Listen to the update event. This event is broadcast every simulation iteration.\n    update_connection_ =\n      gazebo::event::Events::ConnectWorldUpdateBegin\n      (boost::bind(&GazeboRosControlPlugin::Update, this));\n  // \u7701\u7565\n}\n```\n`Load()`\u306f\uff0c\u30d7\u30e9\u30b0\u30a4\u30f3\u306e\u30a8\u30f3\u30c8\u30ea\u30dd\u30a4\u30f3\u30c8\u3067\u3042\u308a\uff0c\u672c\u30e1\u30bd\u30c3\u30c9\u5185\u3067`Gazebo`\u3068`ROS`\u3092\u9023\u643a\u3059\u308b\u305f\u3081\u306e\u69d8\u3005\u306a\u521d\u671f\u5316\u304c\u884c\u308f\u308c\u3066\u3044\u307e\u3059\uff0e\n\n- \u8ffd\u8a18\n - `Gazebo`\u304b\u3089\u3069\u306e\u3088\u3046\u306b\u3053\u306e`Load()`\u3092\u547c\u3093\u3067\u3044\u308b\u304b\u306b\u3064\u3044\u3066\u306f\uff0c[Gazebo \u304b\u3089 ROS \u306e\u30d7\u30e9\u30b0\u30a4\u30f3\u3092\u547c\u3076\u51e6\u7406\u306e\u4ed5\u7d44\u307f\uff082. \u30ed\u30dc\u30c3\u30c8\u30e2\u30c7\u30eb\u767b\u9332\u6642\u306eModelPlugin\u306e\u8aad\u8fbc\u307f\uff09](http://qiita.com/MoriKen/items/86289224696756388df4)\u306b\u3066\u6271\u3044\u307e\u3057\u305f\uff0e\n\n\u3055\u3066\uff0c\u8a71\u3092\u623b\u3057\u3066\uff0c\u809d\u5fc3\u306e`Update()`\u30e1\u30bd\u30c3\u30c9\u306e\u5927\u304d\u306a\u6d41\u308c\u306f\u6b21\u306e\u901a\u308a\u3067\u3059\uff0e\n\n1. \u30b7\u30df\u30e5\u30ec\u30fc\u30b7\u30e7\u30f3\u5468\u671f\u3068\u5236\u5fa1\u5468\u671f\u3092\u6bd4\u8f03\u3057\u307e\u3059\n - \u5236\u5fa1\u5468\u671f\u5206\u6642\u9593\u304c\u9032\u3093\u3067\u3044\u305f\u3089\uff0c`Controller`\u306e\u72b6\u614b\u3092\u66f4\u65b0\u3059\u308b\u305f\u3081\uff0c\u4ee5\u964d\u306e\u51e6\u7406\u306b\u79fb\u308a\u307e\u3059\uff0e\n1. `Gazebo`\u30e2\u30c7\u30eb\u306e\u72b6\u614b\u3092\u53d6\u5f97\u3057\uff0c`Controller`\u3067\u4f7f\u7528\u3059\u308b\u30ed\u30dc\u30c3\u30c8\u30e2\u30c7\u30eb\u306e\u72b6\u614b\u3092\u66f4\u65b0\u3057\u307e\u3059\uff0e\n - \u3053\u3053\u3067\uff0c`RobotHWSim::readSim()`\u306e\u767b\u5834\u3067\u3059\uff0e\u30d7\u30e9\u30b0\u30a4\u30f3\u306e\u30b3\u30fc\u30c9\u3067\u30aa\u30fc\u30d0\u30e9\u30a4\u30c9\u3057\u305f\u30e1\u30bd\u30c3\u30c9\u304c\u3053\u3053\u3067\u8d70\u308a\u307e\u3059\uff0e\n - \u5177\u4f53\u7684\u306b\u306f\uff0c\u524d\u8ff0\u3057\u305f\u901a\u308a\uff0c`jnt_pos_`, `jnt_vel_`, `jnt_eff_`\u3092\u66f4\u65b0\u3057\u307e\u3059\uff0e\n1. \u66f4\u65b0\u3057\u305f\u30ed\u30dc\u30c3\u30c8\u30e2\u30c7\u30eb\u306e\u60c5\u5831\u3092\u5143\u306b\uff0c`Controller`\u306b\u3088\u308b\u5236\u5fa1\u5247\u306e\u8a08\u7b97\u3092\u5b9f\u884c\u3057\u307e\u3059\uff0e\n - `controller_manager_->update(sim_time_ros, sim_period, reset_ctrlrs);` \u306e\u90e8\u5206\u3067\u3059\uff0e`controller_manager_`\u306f\uff0c`controller_manager::ControllerManager`\u30af\u30e9\u30b9\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3067\u3059\uff0e\n - \u672c\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306f\u81ea\u5206\u304c\u7ba1\u7406\u3059\u3079\u304d`Controller`\u3092\u5168\u3066\u77e5\u3063\u3066\u3044\u308b\u306e\u3067\uff0c`ControllerManager::update()`\u30e1\u30bd\u30c3\u30c9\u4e00\u3064\u3067\u5168\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u3092\u66f4\u65b0\u3067\u304d\u307e\u3059\uff0e\n - \u4f8b\u3048\u3070\uff0c`Controller`\u304c`JointTrajectoryController`\u3067\u3042\u308c\u3070\uff0c\u524d\u8ff0\u3057\u305f`jnt_pos_cmd_`\u304c\u66f4\u65b0\u3055\u308c\u308b\u306e\u304c\u3053\u3053\u3067\u3059\uff0e\n1. `Controller`\u3067\u7b97\u51fa\u3057\u305f\u7d50\u679c\u3092\uff0c`Gazebo`\u30e2\u30c7\u30eb\u5074\u306b\u53cd\u6620\u3055\u305b\u307e\u3059\uff0e\n - \u3053\u3053\u3067\uff0c`RobotHWSim::writeSim()`\u304c\u767b\u5834\u3057\u307e\u3059\uff0e\n - \u4eca\u56de\u306e\u4f8b\u3067\u306f\uff0c\u4f4d\u7f6e\u6307\u4ee4\u3067\u3042\u308b`jnt_pos_cmd_`\u3092\u5143\u306b\u529b\u6307\u4ee4\u3092\u8a08\u7b97\u3057\u3066\uff0c`Gazebo`\u5074\u306b\u66f8\u304d\u8fbc\u3093\u3067\u3044\u307e\u3059\uff0e\n\n# `RobotHWSin`\u3068`RobotHW`\u3068\u306e\u5bfe\u6bd4\n\u53c2\u8003\u3068\u3057\u3066\uff0c`Gazebo`\u5229\u7528\u6642\u306b\u4f7f\u308f\u308c\u308b`RobotHWSim`\u3092\uff0c\u5b9f\u6a5f\u9069\u7528\u6642\u306b\u4f7f\u308f\u308c\u308b`RobotHW`\u3068\u5bfe\u6bd4\u3055\u305b\u307e\u3059\uff0e[`RobotHW`\u306eWiki](\nhttps://github.com/ros-controls/ros_control/wiki/hardware_interface)\u306b\u8a18\u8f09\u3055\u308c\u305f`main()`\u306e\u8a18\u8ff0\u3092\u898b\u308c\u3070\uff0c\u30b7\u30df\u30e5\u30ec\u30fc\u30bf\u5074\u3068\u306e\u9055\u3044\u3092\u6bd4\u8f03\u3067\u304d\uff0c\u7406\u89e3\u304c\u6df1\u307e\u308b\u3068\u601d\u3044\u307e\u3059\uff0e\n\n```cpp:declaration_of_MyRobot\n#include <hardware_interface/joint_command_interface.h>\n#include <hardware_interface/joint_state_interface.h>\n#include <hardware_interface/robot_hw.h>\n\nclass MyRobot : public hardware_interface::RobotHW\n{\n // \u7701\u7565\n};\n```\n`hardware_interface::RobotHW`\u3092\u7d99\u627f\u3057\u3066\uff0c`MyRobot`\u3068\u3044\u3046\u30aa\u30ea\u30b8\u30ca\u30eb\u30ed\u30dc\u30c3\u30c8\u7528\u306e\u30b5\u30d6\u30af\u30e9\u30b9\u3092\u4f5c\u6210\u3057\u3066\u3044\u307e\u3059\uff0e\n\u3053\u308c\u3092\u3069\u3046\u4f7f\u3046\u306e\u304b\uff0e`main()`\u3092\u898b\u3066\u307f\u307e\u3059\uff0e\n\n```cpp:main_routine\nmain()\n{\n  MyRobot robot;\n  controller_manager::ControllerManager cm(&robot);\n\n  while (true)\n  {\n     robot.read();\n     cm.update(robot.get_time(), robot.get_period());\n     robot.write();\n     sleep();\n  }\n}\n```\n`read()`\u3068`write()`\u306f\uff0c\u524d\u8ff0\u3057\u305f`readSim()`\u3068`writeSim()`\u3068\u5bfe\u5fdc\u3057\u307e\u3059\uff0e\u305f\u3060\u3057\uff0c\u5b9f\u969b\u306e\u30ed\u30dc\u30c3\u30c8\u306e\u30cf\u30fc\u30c9\u30a6\u30a7\u30a2\u306e\u4ed5\u69d8\uff08`read()`\u306a\u3089\u30a8\u30f3\u30b3\u30fc\u30c0\u7b49\uff0c`write()`\u306a\u3089\u30a2\u30af\u30c1\u30e5\u30a8\u30fc\u30bf\u7b49\uff09\u306b\u5408\u308f\u305b\u3066\uff0c\u81ea\u5206\u3067\u30c9\u30e9\u30a4\u30d0\u90e8\u5206\u3092\u5b9f\u88c5\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\uff0e\n`cm.update()`\u306f\uff0c\u307e\u3055\u306b\u524d\u8ff0\u306e`controller_manager_->update()`\u3068\u540c\u3058\u5f79\u5272\u3067\u3059\uff0e`cm`\u306e\u5ba3\u8a00\u306e\u90e8\u5206\u3092\u898b\u308b\u3068\uff0c`controller_manager::ControllerManager`\u306e\u30b3\u30f3\u30b9\u30c8\u30e9\u30af\u30bf\u306e\u5f15\u6570\u306b`MyRobot robot`\u306e\u30dd\u30a4\u30f3\u30bf\u3092\u6e21\u3057\u3066\u3044\u307e\u3059\uff0e`cm`\u306f\uff0c`robot`\u306e\u60c5\u5831\u3092\u5168\u90e8\u77e5\u3063\u3066\u3044\u308b\u3053\u3068\u306b\u306a\u308a\u307e\u3059\uff0e\n\n\u5b9f\u306f\uff0c\u3053\u3053\u304c\u91cd\u8981\u3067\u3059\uff0e\u8a73\u7d30\u306a\u6319\u52d5\u306f\u5f8c\u8ff0\u3057\u307e\u3059\u304c\uff0c`ControllerManager`\u5074\u306f\uff0c`RobotHW`\u307e\u305f\u306f`RobotHWSim`\u306e\u60c5\u5831\u3092\u77e5\u3089\u306a\u3044\u3068\uff0c\u306b\u3063\u3061\u3082\u3055\u3063\u3061\u3082\u3044\u304b\u306a\u3044\u3053\u3068\u306b\u306a\u308b\u306e\u3067\u3059\uff0e\u5b9f\u969b\uff0c\u5148\u307b\u3069\u306e`gazebo_ros_control_plugin.cpp`\u306e\u4e2d\u3067\u3082\uff0c`ControllerManager`\u306e\u521d\u671f\u5316\u306f`Load()`\u30e1\u30bd\u30c3\u30c9\u5185\u3067\u4e0b\u8a18\u306e\u3088\u3046\u306b\u884c\u308f\u308c\u3066\u3044\u307e\u3059\uff0e\n\n```cpp:gazebo_ros_control/src/gazebo_ros_control_plugin.cpp\n// Overloaded Gazebo entry point\nvoid GazeboRosControlPlugin::Load(gazebo::physics::ModelPtr parent, sdf::ElementPtr sdf)\n{\n // \u7701\u7565\n    // Create the controller manager\n    ROS_DEBUG_STREAM_NAMED(\"ros_control_plugin\",\"Loading controller_manager\");\n    controller_manager_.reset\n      (new controller_manager::ControllerManager(robot_hw_sim_.get(), model_nh_));\n // \u7701\u7565\n}\n```\n`RobotHW`\u3068`RobotHWSim`\u3067\u306f\uff0c\u4e0b\u8a18\u306e\u3088\u3046\u306a\u9055\u3044\u304c\u6709\u308a\u307e\u3059\uff0e\n\n- `RobotHW`\u3092\u4f7f\u3063\u305f\u5148\u307b\u3069\u306e\u30b5\u30f3\u30d7\u30eb\u3067\u306f\uff0c`ControllerManager`\u306e\u521d\u671f\u5316\u6642\u306b\u30b3\u30f3\u30b9\u30c8\u30e9\u30af\u30bf\u3067`RobotHW`\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u30dd\u30a4\u30f3\u30bf\u6e21\u3057\u3066\u3044\u307e\u3057\u305f\uff0e\n- `GazeboRosControlPlugin`\u3067\u306f\uff0c`reset()`\u3068\u3044\u3046\u30e1\u30bd\u30c3\u30c9\u3067`RobotHWSim`\u306e\u60c5\u5831\u3092`ControllerManager`\u306b\u6e21\u3057\u3066\u3044\u307e\u3059\uff0e\n - \u30b3\u30f3\u30b9\u30c8\u30e9\u30af\u30bf\u306e\u6bb5\u968e\u3067\uff0c\u3069\u3093\u306a\u30ed\u30dc\u30c3\u30c8\u304c\u3084\u3063\u3066\u304f\u308b\u306e\u304b\uff0c`GazeboRosControlPlugin`\u3067\u306f\u77e5\u3063\u305f\u3053\u3063\u3061\u3083\u3042\u308a\u307e\u305b\u3093\uff0e\n - \u5165\u308c\u7269\u3060\u3051\u4f5c\u3063\u3066\uff0c\u5f8c\u3067\u30ed\u30dc\u30c3\u30c8\u306e\u60c5\u5831\u3092\u4e0a\u66f8\u304d\u3057\u3066\u3042\u3052\u308b\u30a4\u30e1\u30fc\u30b8\u3067\u3059\uff0e\n\n![robothw_robothwsim_controllermanger_init.png](https://qiita-image-store.s3.amazonaws.com/0/110138/01a6ceeb-1e11-4298-2b84-c93686353e03.png)\n\n\u3044\u305a\u308c\u306b\u3057\u308d\uff0c`ControllerManager`\u306b\u30ed\u30dc\u30c3\u30c8\u30e2\u30c7\u30eb\u306e\u60c5\u5831\u3092\u6e21\u3057\u3066\u3044\u308b\u3053\u3068\u306f\uff0c\u5171\u901a\u3057\u3066\u3044\u308b\u3088\u3046\u3067\u3059\uff0e\n\n\u4ee5\u4e0a\u304c\uff0c\u30d7\u30e9\u30b0\u30a4\u30f3\u306e\u52d5\u4f5c\u306e\u7406\u89e3\u3092\u6df1\u3081\u308b\u305f\u3081\u306b\u89e3\u6790\u3057\u305f\u5185\u5bb9\u3067\u3059\uff0e\n\n\u305f\u3060\uff0c\u4e0a\u8ff0\u3057\u305f\u8aac\u660e\u3067\u306f`RobotHW`\u306e\u5177\u4f53\u7684\u306a\u5b9f\u88c5\u306f\u7701\u7565\u3055\u308c\u3066\u3044\u307e\u3059\uff0e\u305d\u3053\u3067\uff0c\u672c\u7bc0\u306e\u6700\u5f8c\u306b`RobotHW`\u306e\u826f\u3044\u30b5\u30f3\u30d7\u30eb\u306b\u3064\u3044\u3066\u3054\u7d39\u4ecb\u3057\u307e\u3059\uff0e\n\n- `minimum_ros_control`([Github: yoneken/minimum_ros_control](https://github.com/yoneken/minimum_ros_control))\n - `RobotHW`\u306e\u30b5\u30f3\u30d7\u30eb\u3068\u3057\u3066\u306f\uff0c[yoneken](http://qiita.com/yoneken)\u3055\u3093\u306b\u3088\u308b`minimum_ros_control`\u3068\u3044\u3046\u30ea\u30dd\u30b8\u30c8\u30ea\u304c\u6709\u7528\u3067\u3059\u306e\u3067\uff0c\u3053\u3053\u3067\u3054\u7d39\u4ecb\u3055\u305b\u3066\u3044\u305f\u3060\u304d\u307e\u3059\uff0e\n - \u3053\u306e\u30b5\u30f3\u30d7\u30eb\u3067\u306f\uff0c`RobotHW`\u3092\u4f7f\u3046\u4e0a\u3067\u5fc5\u8981\u3068\u306a\u308b\u6700\u4f4e\u9650\u306e\u8981\u7d20\u3067\u69cb\u6210\u3055\u308c\u305f\uff0c\u975e\u5e38\u306b\u30b7\u30f3\u30d7\u30eb\u306a\u30ed\u30dc\u30c3\u30c8\u304c\u6271\u308f\u308c\u3066\u3044\u308b\uff0c\u6975\u3081\u3066\u898b\u901a\u3057\u306e\u826f\u3044\u7d20\u6674\u3089\u3057\u3044\u30b5\u30f3\u30d7\u30eb\u3067\u3059\uff0e`RobotHW`\u306e\u7406\u89e3\u3092\u6df1\u3081\u308b\u4e0a\u3067\uff0c\u305c\u3072\u4e00\u8aad\u3059\u308b\u3053\u3068\u3092\u30aa\u30b9\u30b9\u30e1\u3057\u307e\u3059\uff0e\n - \u5b9f\u6a5f\u3092\u7d44\u3080\u3068\u304d\u306b\u306f\u3053\u306e`minimum_ros_control`\u3092\u30d9\u30fc\u30b9\u306b\u30ab\u30b9\u30bf\u30de\u30a4\u30ba\u3057\u3066\u3044\u304f\u3068\uff0c\u52b9\u7387\u7684\u306b\u958b\u767a\u304c\u3067\u304d\u308b\u3068\u601d\u3044\u307e\u3059\uff0e\n\n\u3053\u3053\u3067\uff0c`gazebo_ros_pkg`\u3067`Gazebo`\u5185\u306e\u30ed\u30dc\u30c3\u30c8\u3092\u5236\u5fa1\u3059\u308b\u5834\u5408\u3068\uff0c`minimum_ros_control`\u3067\u5b9f\u6a5f\u3092\u5236\u5fa1\u3059\u308b\u5834\u5408\u306e\u30bd\u30d5\u30c8\u30a6\u30a7\u30a2\u69cb\u6210\u56f3\u3092\u6bd4\u8f03\u3057\u3066\u307f\u307e\u3059\uff0e\n\n---\n![gazebo_summary.png](https://qiita-image-store.s3.amazonaws.com/0/110138/6801a022-6ff3-4361-6e4f-978be26d62dd.png)\n---\n![real_robot_sammary.png](https://qiita-image-store.s3.amazonaws.com/0/110138/3d5230c9-6225-ab84-d6cd-232f6e0e125b.png)\n---\n\u30e2\u30b8\u30e5\u30fc\u30eb\u3068\u3057\u3066\u7570\u306a\u308b\u90e8\u5206\u306f\uff0c\u4e0a\u8a18\u56f3\u4e2d\u306b\u304a\u3044\u3066\u7dd1\u306e\u77e2\u5370\u3067\u793a\u3057\u305f\u90e8\u5206\u3067\u3059\u304c\uff0c\u672c\u8cea\u7684\u306b\u306f\u5168\u304f\u540c\u4e00\u306e\u69cb\u6210\u3092\u53d6\u3063\u3066\u3044\u308b\u3053\u3068\u304c\u5206\u304b\u308a\u307e\u3059\uff0e\n\u4f7f\u7528\u3059\u308b\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u304c\uff0c`JointTrajectoryController`\u3068`JointPositionController`\u3067\u7570\u306a\u3063\u3066\u3044\u307e\u3059\u304c\uff0c\u3053\u308c\u306f\u8a2d\u5b9a\u3068\u3044\u3046\u304b\u30ed\u30dc\u30c3\u30c8\u306e\u5236\u5fa1\u306e\u4ed5\u65b9\u306e\u9055\u3044\u3068\u3044\u3046\u30ec\u30d9\u30eb\u3067\uff0c`Gazebo`\u3060\u308d\u3046\u304c`Real Robot`\u3060\u308d\u3046\u304c\u5171\u901a\u3067\u5165\u308c\u66ff\u3048\u3067\u304d\u308b\u90e8\u5206\u3067\u3059\uff0e\u305f\u3060\uff0c\u5468\u671f\u3084\u30b2\u30a4\u30f3\u306e\u8a2d\u5b9a\u304c\u3042\u308b\u5834\u5408\u306b\u306f\uff0c\u30b7\u30df\u30e5\u30ec\u30fc\u30b7\u30e7\u30f3\u304b\u5b9f\u6a5f\u304b\u3067\u8a2d\u5b9a\u5024\u3092\u5207\u308a\u66ff\u3048\u308b\u306e\u304c\u5b9f\u7528\u7684\u3067\u3057\u3087\u3046\uff0e\u3053\u306e\u8fba\u308a\u306e\u8a71\u306f\uff0c\n[\u6b21\u306e\u30a8\u30f3\u30c8\u30ea](http://qiita.com/MoriKen/items/c29f653d03baffe5f0e2#gazebo%E3%81%AB%E3%83%AD%E3%83%9C%E3%83%83%E3%83%88%E3%83%A2%E3%83%87%E3%83%AB%E3%82%92spawn-%E3%81%99%E3%82%8B)\u3067\u3082\u89e6\u308c\u307e\u3059\uff0e\n\n# \u30d7\u30e9\u30b0\u30a4\u30f3\u3068\u3057\u3066\u4f7f\u3048\u308b\u3088\u3046\u306b\u3059\u308b\n\u3053\u3053\u307e\u3067\uff0c\u30d7\u30e9\u30b0\u30a4\u30f3\u306e\u5b9a\u7fa9\u65b9\u6cd5\u3068\u305d\u306e\u4ed5\u7d44\u307f\u306b\u3064\u3044\u3066\u8ff0\u3079\u307e\u3057\u305f\uff0e\u3057\u304b\u3057\uff0c\u5b9f\u306f\u3053\u308c\u307e\u3067\u306e\u4f5c\u696d\u3060\u3051\u3067\u306f\u307e\u3060\u4f7f\u3048\u308b\u72b6\u614b\u306b\u306f\u3042\u308a\u307e\u305b\u3093\uff0e`ROS`\u30b7\u30b9\u30c6\u30e0\u5074\u306b\u5bfe\u3057\u3066\uff0c\u30d7\u30e9\u30b0\u30a4\u30f3\u3092\u6709\u52b9\u306b\u3059\u308b\u305f\u3081\u306e\u60c5\u5831\u3092\u6559\u3048\u3066\u3042\u3052\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\uff0e\n\u305d\u3053\u3067\uff0c[pluginlib](http://wiki.ros.org/pluginlib)\u306e\u4ed5\u7d44\u307f\u3092\u4f7f\u3063\u3066\uff0c\u4e0a\u8a18\u30b3\u30fc\u30c9\u3092\u6b63\u5f0f\u306b\u30d7\u30e9\u30b0\u30a4\u30f3\u5316\u3057\u307e\u3059\uff0e\n\n- \u30d7\u30e9\u30b0\u30a4\u30f3\u3068\u3057\u3066\u51fa\u529b\u3059\u308b\u305f\u3081\u306e\u8a2d\u5b9a\n - \u30d7\u30e9\u30b0\u30a4\u30f3\u7528\u306e\u30d5\u30a1\u30a4\u30eb\u3068\u3057\u3066\u51fa\u529b\u3055\u308c\u308b\u3088\u3046\u306b\uff0c\u30b3\u30fc\u30c9\u5074\u306b\u8ffd\u8a18\u304c\u5fc5\u8981\u3067\u3059\uff0e\n - \u30b3\u30fc\u30c9\u5185\u306e\u3069\u3053\u3067\u3082\u3088\u3044\u306e\u3067\uff0c`PLUGINLIB_EXPORT_CLASS(\u767b\u9332\u5bfe\u8c61\u306e\u30af\u30e9\u30b9\u540d, \u767b\u9332\u5bfe\u8c61\u306e\u30af\u30e9\u30b9\u306e\u89aa\u30af\u30e9\u30b9\u540d)`\u306e\u30de\u30af\u30ed\u3092\u66f8\u304d\u307e\u3059\uff0e\n - \u5148\u307b\u3069\u306e\u4f8b\u3067\u306f\uff0c\u6700\u7d42\u884c\u306b\u66f8\u3044\u3066\u3042\u308a\u307e\u3057\u305f\uff0e\u3053\u308c\u304c\u4e00\u822c\u7684\u306a\u3084\u308a\u65b9\u3068\u306e\u3053\u3068\u3067\u3059\uff0e\n\n```cpp:rosbook_arm_hardware_gazebo/src/rosbook_arm_hardware_gazebo.cpp\n// \u305c\u30fc\u3093\u3076\u7701\u7565\u3057\u3066\uff0c\u6700\u7d42\u884c\u306e\u307f\nPLUGINLIB_EXPORT_CLASS(rosbook_arm_hardware_gazebo::ROSBookArmHardwareGazebo, gazebo_ros_control::RobotHWSim)\n```\n\n- \u30d7\u30e9\u30b0\u30a4\u30f3\u8aac\u660e\u30d5\u30a1\u30a4\u30eb\u306e\u767b\u9332\n - \u4e0a\u8a18\u30de\u30af\u30ed\u3067\u306f\u66f8\u304d\u304d\u308c\u306a\u3044\u60c5\u5831\u3092\u767b\u9332\u3057\u307e\u3059\uff0e\u30d7\u30e9\u30b0\u30a4\u30f3\u306e\u4ed5\u69d8\u3068\u304b\u306f\u3053\u3061\u3089\u3067\u3059\uff0e\n - ROS\u30b7\u30b9\u30c6\u30e0\u304c\u3053\u306e\u30d7\u30e9\u30b0\u30a4\u30f3\u3092\u81ea\u52d5\u3067\u691c\u51fa\u30fb\u8aad\u8fbc\u3067\u304d\u308b\u3088\u3046\u306b\u3059\u308b\u305f\u3081\u306b\u5fc5\u8981\u3068\u306e\u3053\u3068\u3067\u3059\uff0e\n - `rosbook_arm_hardware_gazebo/ROSBookArmHardwareGazebo`\u306e\u4f8b\u3067\u306f\u4e0b\u8a18\u306e\u3068\u304a\u308a\u3067\u3059\uff0e\n\n```xml:rosbook_arm_hardware_gazebo/rosbook_arm_hardware_gazebo_plugins.xml\n<library path=\"lib/librosbook_arm_hardware_gazebo\">\n  <class\n    name=\"rosbook_arm_hardware_gazebo/ROSBookArmHardwareGazebo\"\n    type=\"rosbook_arm_hardware_gazebo::ROSBookArmHardwareGazebo\"\n    base_class_type=\"gazebo_ros_control::RobotHWSim\">\n    <description>\n      ROS Book arm simulation interface.\n    </description>\n  </class>\n</library>\n```\n\n- `ROS`\u30d1\u30c3\u30b1\u30fc\u30b8\u30b7\u30b9\u30c6\u30e0\u3078\u306e\u30d7\u30e9\u30b0\u30a4\u30f3\u306e\u767b\u9332\n - `ROS`\u30b7\u30b9\u30c6\u30e0\u5168\u4f53\u3067\u3053\u306e\u30d7\u30e9\u30b0\u30a4\u30f3\u3092\u4f7f\u3048\u308b\u3088\u3046\u306b\u3059\u308b\u305f\u3081\u306e\u8a2d\u5b9a\u3092\u3057\u307e\u3059\uff0e\n - `package.xml`\u306b`<export>`\u30bf\u30b0\u3092\u8ffd\u52a0\u3057\u307e\u3059\uff0e\n - `rosbook_arm_hardware_gazebo/ROSBookArmHardwareGazebo`\u306e\u4f8b\u3067\u306f\u4e0b\u8a18\u306e\u3068\u304a\u308a\u3067\u3059\uff0e\n\n```xml:rosbook_arm_hardware_gazebo/package.xml\n  <export>\n    <gazebo_ros_control plugin=\"${prefix}/rosbook_arm_hardware_gazebo_plugins.xml\"/>\n  </export>\n```\n\n\u30d5\u30a1\u30a4\u30eb\u3068\u3057\u3066\u306e\u8a2d\u5b9a\u306f\u4ee5\u4e0a\u3067\u3059\uff0e\u4ee5\u964d\u306e\u51e6\u7406\u306f[pluginlib](http://wiki.ros.org/pluginlib)\u3092\u53c2\u8003\u306b\u9032\u3081\u308c\u3070OK\u3067\u3059\uff0e\n\n# `DefaultRobotHWSim`\u306b\u3064\u3044\u3066\n\u4f5c\u6210\u3057\u305f`ROSBookArmHardwareGazebo`\u3067\u306f\uff0c`JointStateInterface`\u3084`PositionJointInterface`\u3092\u81ea\u5206\u3067\u5ba3\u8a00\u3057\u307e\u3057\u305f\u304c\uff0c`DefaultRobotHWSim`\u3067\u306f\u3069\u3046\u3057\u3066\u3044\u308b\u306e\u3067\u3057\u3087\u3046\u304b\uff1f\u30c7\u30d5\u30a9\u30eb\u30c8\u3067\u7528\u610f\u3055\u308c\u305f\u30d7\u30e9\u30b0\u30a4\u30f3\u3092\u4f7f\u3046\u5834\u5408\uff0c\u79c1\u9054\u304c\u7de8\u96c6\u3092\u3059\u308b\u4f59\u5730\u306f\u3042\u308a\u307e\u305b\u3093\uff0e\n\u3061\u3087\u3063\u3068\u30b3\u30fc\u30c9\u3092\u8997\u3044\u3066\u307f\u307e\u3059\uff0e\n\n```cpp:gazebo_ros_control/include/gazebo_ros_control/default_robot_hw_sim.h\n// \u7701\u7565\nnamespace gazebo_ros_control\n{\nclass DefaultRobotHWSim : public gazebo_ros_control::RobotHWSim\n// \u7701\u7565\n{\n// \u7701\u7565\n  hardware_interface::JointStateInterface    js_interface_;\n  hardware_interface::EffortJointInterface   ej_interface_;\n  hardware_interface::PositionJointInterface pj_interface_;\n  hardware_interface::VelocityJointInterface vj_interface_;\n// \u7701\u7565\n}\n// \u7701\u7565\n}\n```\n`JointStateInterface`\uff0c`EffortJointInterface`\uff0c`PositionJointInterface\uff4d`\uff0c`VelocityJointInterface`\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u5ba3\u8a00\u304c\u30aa\u30f3\u30d1\u30ec\u30fc\u30c9\u3067\u3059\uff0e\n\u30e6\u30fc\u30b6\u5b9a\u7fa9\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u304b\u3089\u3069\u3093\u306a\u30a4\u30f3\u30bf\u30fc\u30d5\u30a7\u30fc\u30b9\u304c\u964d\u3063\u3066\u304f\u308b\u304b\u306a\u3069\uff0c`DefaultRobotHWSim`\u304b\u3089\u3057\u305f\u3089\u5206\u304b\u3089\u306a\u3044\u3053\u3068\u306a\u306e\u3067\uff0c\u4ee3\u8868\u7684\u306a\u30a4\u30f3\u30bf\u30fc\u30d5\u30a7\u30fc\u30b9\u306b\u3064\u3044\u3066\u306f\u4e88\u3081\u571f\u53f0\u3092\u4f5c\u3063\u3066\u304a\u304f\u3088\u3046\u3067\u3059\uff0e\u3053\u308c\u3092\u3069\u3046\u6271\u3046\u306e\u304b\uff0c`initSim()`\u3092\u898b\u3066\u307f\u307e\u3059\uff0e\n\n```cpp:gazebo_ros_control/src/default_robot_hw_sim.cpp\n// \u7701\u7565\nnamespace gazebo_ros_control\n{\n// \u7701\u7565\nbool DefaultRobotHWSim::initSim(\n  const std::string& robot_namespace,\n  ros::NodeHandle model_nh,\n  gazebo::physics::ModelPtr parent_model,\n  const urdf::Model *const urdf_model,\n  std::vector<transmission_interface::TransmissionInfo> transmissions)\n{\n// \u7701\u7565\n  n_dof_ = transmissions.size(); \n// \u7701\u7565\n  // Initialize values \n  for(unsigned int j=0; j < n_dof_; j++) \n  { \n// \u7701\u7565\n    std::vector<std::string> joint_interfaces = transmissions[j].joints_[0].hardware_interfaces_;\n// \u7701\u7565\n    const std::string& hardware_interface = joint_interfaces.front();\n// \u7701\u7565\n    // Add data from transmission\n    joint_names_[j] = transmissions[j].joints_[0].name_;\n// \u7701\u7565\n    if(hardware_interface == \"EffortJointInterface\")\n    {\n      // Create effort joint interface\n      joint_control_methods_[j] = EFFORT;\n      joint_handle = hardware_interface::JointHandle(js_interface_.getHandle(joint_names_[j]),\n                                                     &joint_effort_command_[j]);\n      ej_interface_.registerHandle(joint_handle);\n    }\n    else if(hardware_interface == \"PositionJointInterface\")\n    {\n      // Create position joint interface\n      joint_control_methods_[j] = POSITION;\n      joint_handle = hardware_interface::JointHandle(js_interface_.getHandle(joint_names_[j]),\n                                                     &joint_position_command_[j]);\n      pj_interface_.registerHandle(joint_handle);\n    }\n    else if(hardware_interface == \"VelocityJointInterface\")\n    {\n      // Create velocity joint interface\n      joint_control_methods_[j] = VELOCITY;\n      joint_handle = hardware_interface::JointHandle(js_interface_.getHandle(joint_names_[j]),\n                                                     &joint_velocity_command_[j]);\n      vj_interface_.registerHandle(joint_handle);\n    }\n// \u7701\u7565\n  }\n// \u7701\u7565\n}\n// \u7701\u7565\n}\n```\n`URDF`\u306e`<transmission>`\u30bf\u30b0\u5185\u306e`<hardwareInterface>`\u30bf\u30b0\u3067\u6307\u5b9a\u3057\u305f\u30a4\u30f3\u30bf\u30fc\u30d5\u30a7\u30fc\u30b9\u7a2e\u5225\u3092\u8aad\u307f\u3060\u3057\u3066\uff0c\u305d\u306e\u7a2e\u5225\u306b\u5fdc\u3058\u3066\u767b\u9332\u5bfe\u8c61\u306e\u30a4\u30f3\u30bf\u30fc\u30d5\u30a7\u30fc\u30b9\u3092\u5207\u308a\u66ff\u3048\u3066\u3044\u307e\u3059\uff0e\u3060\u304b\u3089\uff0c`Gazebo`\u3092\u4f7f\u3046\u3068\u304d\u306b\u306f\uff0c`<transmission>`\u306e\u8a2d\u5b9a\u3067`HardwareInterface`\u306e\u7a2e\u5225\u3092\u5165\u529b\u3059\u308b\u5fc5\u8981\u304c\u3042\u3063\u305f\u306e\u3067\u3059\uff0e\n\n# \u304a\u308f\u308a\u306b\n\u4eca\u56de\u306f\uff0c`RobotHWSim`\u306e\u52d5\u4f5c\u306b\u30d5\u30a9\u30fc\u30ab\u30b9\u3092\u5f53\u3066\u3066\u89e3\u6790\u3092\u884c\u3044\u307e\u3057\u305f\uff0e\u30d7\u30e9\u30b0\u30a4\u30f3\u306e\u4f5c\u6210\u65b9\u6cd5\u3068\u7d61\u3081\u306a\u304c\u3089\uff0c\u5468\u8fba\u306e\u30e2\u30b8\u30e5\u30fc\u30eb\u3068\u3069\u306e\u3088\u3046\u306b\u95a2\u308f\u3063\u3066\u3044\u308b\u304b\u3082\u5c11\u3057\u7406\u89e3\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3057\u305f\uff0e\n\n\u6b21\u56de\u306f\uff0c\u300c[3. `Controller`\u306b\u3064\u3044\u3066](http://qiita.com/MoriKen/items/c29f653d03baffe5f0e2)\u300d\u8aac\u660e\u3057\u307e\u3059\uff0e\u3053\u3053\u307e\u3067\u5206\u304b\u308c\u3070\uff0c`Gazebo`\u3068`ROS`\u306e\u9023\u643a\u306b\u95a2\u3059\u308b\uff0c\u4e00\u901a\u308a\u306e\u6d41\u308c\u304c\u3064\u304b\u3081\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3059\uff0e\n"}