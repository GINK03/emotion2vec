{"context": " More than 1 year has passed since last update.Raspberry Pi Advent Calendar 2015\u306e\u6295\u7a3f\u8a18\u4e8b\u3067\u3059\u3002\u5148\u65e5PyVideoCore\u3068\u3044\u3046Raspberry Pi\u3067GPGPU\u3092\u884c\u3046\u70ba\u306ePython\u30e9\u30a4\u30d6\u30e9\u30ea\u3092\u958b\u767a\u3057\u307e\u3057\u305f\u3002\u3053\u308c\u3092\u4f7f\u3063\u3066\u5358\u7cbe\u5ea6\u306e\u884c\u5217\u4e57\u7b97(sgemm)\u3092\u984c\u6750\u306b\u3001GPGPU\u306e\u30c1\u30e5\u30fc\u30c8\u30ea\u30a2\u30eb\u3092\u66f8\u3053\u3046\u3068\u601d\u3044\u307e\u3059\u3002\u81ea\u5206\u7528\u306e\u8a18\u9332\u3082\u517c\u306d\u3066\u3044\u308b\u306e\u3067\u7121\u99c4\u306b\u9577\u3044\u3067\u3059\u3002\u3059\u307f\u307e\u305b\u3093\u3002\n\n\u304d\u3063\u304b\u3051\nRaspi\u306eGPU\u306b\u3064\u3044\u3066\u8abf\u3079\u3066\u3044\u305f\u3068\u304d\u306b\u4ed6\u306e\u65b9\u304c\u66f8\u3044\u305fsgemm\u5b9f\u88c5\u3092\u898b\u3064\u3051\u307e\u3057\u305f\u3002\n\nhttps://github.com/jetpacapp/pi-gemm/\n\n\u3053\u308c\u306e\u30b5\u30f3\u30d7\u30eb\u3092\u8a66\u3057\u3066\u307f\u305f\u3068\u3053\u308d\u300196x363\u884c\u5217\u3068363x3025\u884c\u5217\u306e\u7a4d\u304c\u5927\u4f530.27\u79d2\u307b\u3069\u3068\u306e\u7d50\u679c\u304c\u51fa\u307e\u3059\u3002\u3053\u306e\u8a08\u7b97\u3067\u306f\u7d042\u5104\u56de\u306e\u6d6e\u52d5\u5c0f\u6570\u70b9\u6570\u6f14\u7b97(105996000\u56de\u306e\u4e57\u7b97\u3068105415200\u56de\u306e\u52a0\u7b97)\u304c\u884c\u308f\u308c\u308b\u306e\u3067\u3001783Mflops\u304f\u3089\u3044\u306e\u6027\u80fd\u3068\u306a\u308a\u307e\u3059\u3002CBLAS\u306esgemm\u3067\u540c\u3058\u8a08\u7b97\u3092\u3059\u308b\u306815.4\u79d2\u304f\u3089\u3044\u3068\u306e\u7d50\u679c\u304c\u51fa\u3066\u3001\u3053\u3061\u3089\u306f13.7Mflops\u3067\u3059\u304b\u308960\u500d\u8fd1\u304f\u306e\u9ad8\u901f\u5316\u3092\u9054\u6210\u3057\u3066\u3044\u308b\u3068\u3044\u3046\u3053\u3068\u306b\u306a\u308a\u307e\u3059\u3002\n\u3053\u306e\u7d50\u679c\u306f\u4e00\u898b\u3059\u3054\u305d\u3046\u3067\u3059\u304c\u3001Raspi GPU\u306e\u7406\u8ad6\u6027\u80fd\u306f24Gflops\u3067\u3059\u304b\u3089\u5b9f\u306f\u7406\u8ad6\u6027\u80fd\u306e3%\u3057\u304b\u51fa\u305b\u3066\u3044\u307e\u305b\u3093\u3002\u4ed6\u306e\u4eba\u304c\u66f8\u3044\u305fFFT(\u516c\u5f0f\u30b5\u30f3\u30d7\u30eb\u3068\u3057\u3066raspbian\u306b\u53ce\u9332)\u3084\u307e\u305f\u5225\u306e\u4eba\u304c\u66f8\u3044\u305fSHA256\u3068\u304b\u3082\u898b\u305f\u3093\u3067\u3059\u304c\u3069\u308c\u3082\u5168\u7136\u6027\u80fd\u304c\u51fa\u3066\u3044\u307e\u305b\u3093\u3067\u3057\u305f\u3002\u73fe\u72b6Rasperry Pi\u3068GPGPU\u3067\u691c\u7d22\u3059\u308b\u3068\u3053\u308c\u3089\u306e\u60c5\u5831\u6e90\u3057\u304b\u30d2\u30c3\u30c8\u3057\u306a\u3044\u306e\u3067\u3001\u3053\u308c\u306f\u307e\u305a\u3044\u3068\u601d\u3044\u672c\u8a18\u4e8b\u3092\u66f8\u304f\u3053\u3068\u306b\u3057\u307e\u3057\u305f\u3002\n\u884c\u5217\u4e57\u7b97\u304c\u65e9\u304f\u306a\u3063\u3066\u4f55\u304c\u5b09\u3057\u3044\u306e\u304b\u3068\u601d\u3046\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u304c\u3001\u4f8b\u3048\u3070\u4e0a\u306e\u4eba\u306fpi-gemm\u3092\u4f7f\u3063\u3066DeepBeliefNetwork\u3068\u3044\u3046\u30e2\u30c7\u30eb\u3092\u4f7f\u3063\u3066\u306e\u7269\u4f53\u8a8d\u8b58\u306e\u9ad8\u901f\u5316\u3092\u3057\u3066\u3044\u307e\u3059\u3002\n\nhttp://petewarden.com/2014/08/07/how-to-optimize-raspberry-pi-code-using-its-gpu/\n\n\u3053\u308c\u306f\u3001\u5165\u529b\u753b\u50cf\u306b\u4f55\u304c\u5199\u3063\u3066\u3044\u308b\u304b\u3092\u8b58\u5225\u3059\u308b\u3082\u306e\u3067\u3059\u304c\u3001sgemm\u3092GPU\u5316\u3059\u308b\u3053\u3068\u30673.3\u79d2\u3067\u8b58\u5225\u304c\u51fa\u6765\u308b\u3088\u3046\u306b\u306a\u3063\u305f\u305d\u3046\u3067\u3059(\u4e0a\u3067\u8a00\u3063\u305f\u3088\u3046\u306b\u3053\u308c\u306f\u307e\u3060\u307e\u3060\u901f\u304f\u51fa\u6765\u308b\u306f\u305a\u3067\u3059)\u3002\u4ed6\u306b\u3082gemm\u304c\u901f\u304f\u306a\u308b\u3068\u5b09\u3057\u3044\u5fdc\u7528\u304c\u305f\u304f\u3055\u3093\u3042\u308a\u307e\u3059\u3002\n  \u2192  \n\n\u5b66\u751f\u306b\u304a\u52e7\u3081\nRaspberry Pi\u306eGPU\u306fVideoCore IV\u3068\u3044\u3046\u3082\u306e\u3067\u3059\u3002nVidia\u306eGPU\u306e\u30b3\u30fc\u30c9\u3092\u30a2\u30bb\u30f3\u30d6\u30ea\u3067\u66f8\u3044\u305f\u4e8b\u306e\u3042\u308b\u4eba\u306f\u305d\u3093\u306a\u306b\u3044\u306a\u3044\u3068\u601d\u3044\u307e\u3059\u304c\u3001VideoCore\u306e\u5834\u5408\u306f\u30a2\u30bb\u30f3\u30d6\u30ea\u3067\u66f8\u304b\u306a\u3051\u308c\u3070\u306a\u3089\u306a\u3044\u66f8\u304f\u3053\u3068\u304c\u51fa\u6765\u307e\u3059\u3002\u3069\u306e\u4f1a\u793e\u306eGPU\u3082\u57fa\u672c\u7684\u306a\u8003\u3048\u65b9\u306f\u540c\u3058\u3067\u3059\u3057\u3001VideoCore\u306f\u5b8c\u5168\u306a\u30ea\u30d5\u30a1\u30ec\u30f3\u30b9\u30ac\u30a4\u30c9\u304c\u516c\u958b\u3055\u308c\u3066\u3044\u308b\u3057\u3001\u30dc\u30fc\u30c9\u304c\u5b89\u3044\u3067\u3059\u3057\u3001\u60c5\u5831\u7cfb\u5b66\u751f\u306e\u4fee\u884c\u7528\u306bRaspi\u7d50\u69cb\u826f\u3044\u3093\u3058\u3083\u306a\u3044\u3067\u3057\u3087\u3046\u304b\u3002\n\n\u30ea\u30d5\u30a1\u30ec\u30f3\u30b9\u30ac\u30a4\u30c9\nVideoCore\u306f16-way\u306eSIMD\u30d7\u30ed\u30bb\u30c3\u30b5(QPU)12\u500b\u304b\u3089\u306a\u308a\u307e\u3059\u3002\u3042\u3068\u306f\u8aac\u660e\u3092\u7701\u7565\u3057\u307e\u3059\u306e\u3067\u3001\u4ee5\u4e0b\u306e\u30ea\u30d5\u30a1\u30ec\u30f3\u30b9\u30ac\u30a4\u30c9\u3092\u8aad\u3093\u3067\u304f\u3060\u3055\u3044\u3002\u7a74\u304c\u958b\u304f\u307b\u3069\u8aad\u3093\u3067\u304f\u3060\u3055\u3044\u3002\n\nhttp://www.broadcom.com/docs/support/videocore/VideoCoreIV-AG100-R.pdf\n\n\n\u4eca\u56de\u4f5c\u308b\u3082\u306e\u3002\n\u4e0e\u3048\u3089\u308c\u305fp\u00d7qp\\times q \u884c\u5217 AA, q\u00d7rq\\times r \u884c\u5217 BB, p\u00d7rp\\times r \u884c\u5217 CC, \u30b9\u30ab\u30e9 \u03b1,\u03b2\\alpha,\\beta\u306b\u5bfe\u3057\u3066\n\u03b1AB+\u03b2C\\alpha AB + \\beta C \n\u3092\u8a08\u7b97\u3059\u308b\u3068\u3044\u3046\u3082\u306e\u3092\u4f5c\u308a\u307e\u3059\u3002 \u7d50\u679c\u306fCC\u306b\u4e0a\u66f8\u304d\u3057\u307e\u3059\u3002\n\u3044\u308f\u3086\u308bsgemm\u3067\u3059\u304c\u3001\u4eca\u56de\u306f\u5927\u5206\u5358\u7d14\u5316\u3057\u305f\u3082\u306e\u3092\u4f5c\u308a\u307e\u3059\u3002\n\n\u884c\u5217\u306e\u8ee2\u7f6e\u7b49\u306e\u30aa\u30d7\u30b7\u30e7\u30f3\u306f\u4f5c\u308a\u307e\u305b\u3093\u3002\nRow-major\u306e\u5834\u5408\u306e\u307f\u3092\u8003\u3048\u307e\u3059\u3002\nGPU\u5074\u3067\u306fpp\u304c16\u306e\u500d\u6570\u3001rr\u304c64\u306e\u500d\u6570\u3067\u3042\u308b\u4e8b\u3001\u3092\u8981\u8acb\u3057\u7aef\u6570\u51e6\u7406\u3092\u7701\u304d\u307e\u3059\u3002Host\u5074\u3067\u5171\u6709\u30e1\u30e2\u30ea\u306b\u884c\u5217\u3092\u914d\u7f6e\u3059\u308b\u969b\u306b\u3001\u7aef\u6570\u90e8\u5206\u306e\u8abf\u6574\u3092\u3059\u308b\u4e8b\u306b\u3057\u307e\u3059\u3002\nqq\u306f2\u4ee5\u4e0a\u3067\u3042\u308b\u3053\u3068\u3092\u8981\u8acb\u3057\u307e\u3059\u3002\n\n\n\u901f\u304f\u3059\u308b\u70ba\u306b\u5fc5\u8981\u306a\u4e8b\n\u6027\u80fd\u3092\u51fa\u3059\u3068\u3044\u3046\u554f\u984c\u306f\u3001\u3064\u307e\u308a\u5982\u4f55\u306b\u6f14\u7b97\u5668\u3092\u4f11\u307e\u305b\u305a\u306b\u8d70\u3089\u305b\u7d9a\u3051\u3089\u308c\u308b\u304b\uff1f\u3068\u3044\u3046\u554f\u984c\u3067\u3059\u3002\u305d\u306e\u70ba\u306b\u306f\u3001\u51fa\u6765\u308b\u3060\u3051\u6f14\u7b97\u5668\u3092\u6570\u5024\u8a08\u7b97\u306e\u70ba\u306b\u4f7f\u3046\u4e8b\u3001\u30e1\u30e2\u30ea\u30a2\u30af\u30bb\u30b9\u3001\u6761\u4ef6\u5206\u5c90\u3001\u540c\u671f\u51e6\u7406\u306a\u3069\u3067\u306e\u5f85\u3061\u6642\u9593\u3092\u6e1b\u3089\u3059\u4e8b\u3001\u5f85\u3061\u6642\u9593\u304c\u767a\u751f\u3059\u308b\u5834\u5408\u306b\u306f\u30d1\u30a4\u30d7\u30e9\u30a4\u30f3\u5316\u3084\u30b9\u30ec\u30c3\u30c9\u5316\u3067\u305d\u308c\u3092\u96a0\u853d\u3059\u308b\u4e8b\u306a\u3069\u304c\u91cd\u8981\u306b\u306a\u308a\u307e\u3059\u3002\npi-gemm\u306e\u30a2\u30eb\u30b4\u30ea\u30ba\u30e0\u3092\u4f8b\u306b\u3053\u308c\u3092\u898b\u3066\u307f\u307e\u3057\u3087\u3046\u3002pi-gemm\u3067\u306f\u5185\u7a4d\u8a08\u7b97\u306e\u90e8\u5206(\u4ee5\u4e0b\u306ek-loop)\u3092SIMD\u3067\u30d9\u30af\u30c8\u30eb\u5316\u3059\u308b\u3068\u3044\u3046\u65b9\u6cd5\u3092\u63a1\u3063\u3066\u3044\u307e\u3059\u3002CUDA\u306e\u30c1\u30e5\u30fc\u30c8\u30ea\u30a2\u30eb\u3068\u304b\u3067\u3082\u540c\u69d8\u306e\u30b5\u30f3\u30d7\u30eb\u3092\u898b\u304b\u3051\u308b\u4e8b\u304c\u3042\u308a\u307e\u3059\u3002\nfor i=0..p-1 {\n   for j=0..r-1 {\n      v = 0\n      for k=0..q-1 {\n         v += A[i, k]*B[k, j]\n      }\n      C[i, j] = \u03b1 * v + \u03b2 * C[i, j]\n   }\n}\n\n\u3053\u306e\u5834\u5408\n\n\u9577\u305516\u306e\u30d9\u30af\u30c8\u30eb2\u3064A[i,k:k+16], B[k:k+16, j]\u3092load\u3059\u308b\u3002\n2\u3064\u306e\u30d9\u30af\u30c8\u30eb\u3092\u639b\u3051\u3066\u3001\u30a2\u30ad\u30e5\u30e0\u30ec\u30fc\u30bf\u306b\u8db3\u3057\u8fbc\u3080\u3002\n\n\u3068\u3044\u3046\u8a08\u7b97\u3092\u7e70\u308a\u8fd4\u3059\u4e8b\u306b\u306a\u308a\u307e\u3059\u3002(\u3044\u308d\u3044\u308d\u5de5\u592b\u3067\u304d\u307e\u3059\u304c)\u3053\u308c\u306f\u3042\u307e\u308a\u826f\u304f\u306a\u3044\u65b9\u6cd5\u3060\u3068\u601d\u3044\u307e\u3059\u3002\nRaspi\u306eGPU\u306f\u52a0\u7b97\u3068\u4e57\u7b97\u3092\u540c\u6642\u306b\u5b9f\u884c\u3067\u304d\u308b\u306e\u3067\u30b9\u30c6\u30c3\u30d72\u306f\u5b9f\u8cea1\u547d\u4ee4\u3067\u7d42\u308f\u308a\u307e\u3059\u3002\u30b9\u30c6\u30c3\u30d71\u306f\u3053\u308c\u3088\u308a\u305a\u3063\u3068\u9577\u3044\u6642\u9593\u304c\u639b\u304b\u308a\u307e\u3059\u3002\u3053\u306e\u9593\u6f14\u7b97\u5668\u306f\u4f11\u3093\u3067\u3044\u307e\u3059\u3002\u307e\u305f\u3001\u305f\u3063\u305f16\u500b\u306e\u6570\u5024\u3092\u6f14\u7b97\u3059\u308b\u6bce\u306b\u6761\u4ef6\u5206\u5c90\u304c\u3042\u308a\u307e\u3059\u3002\u3053\u3053\u3067\u3082\u6f14\u7b97\u5668\u306f\u4f11\u3093\u3067\u3044\u307e\u3059\u3002\n\u5b9f\u969b\u306e\u30b3\u30fc\u30c9\u3092\u5f15\u7528\u3059\u308b\u3068\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002main_loop_l\u5185\u90e8\u3067\u5b9f\u969b\u306e\u6570\u5024\u8a08\u7b97\u3092\u884c\u3063\u3066\u3044\u308b\u3068\u3053\u308d\u306ffmul\u3068fadd1\u56de\u305a\u3064\u306e\u307f\u3067\u3059\u3002\u540c\u6642\u5b9f\u884c\u3067\u304d\u308b\u304b\u3089\u5b9f\u8cea1\u547d\u4ee4\u5206\u3067\u3059\u3002\u305d\u306e\u4ed6\u306f\u3059\u3079\u3066\u30a2\u30c9\u30ec\u30b9\u3084\u30ab\u30a6\u30f3\u30bf\u306e\u8a08\u7b97\u3067\u3059\u3002\u30eb\u30fc\u30d7\u518514\u547d\u4ee4\u306e\u5185\u3001\u6570\u5024\u6f14\u7b97\u306e\u70ba\u306b\u306f\u6f14\u7b97\u5668\u3092\u4e00\u56de\u3057\u304b\u4f7f\u3048\u3066\u3044\u307e\u305b\u3093\u30021/14=7.1%\u3067\u3059\u304b\u3089\u3001\u5148\u307b\u3069\u306e3%\u7a0b\u5ea6\u3068\u3044\u3046\u6570\u5b57\u306b\u306a\u308a\u307e\u3059\u3002\nmain_loop_l:\n\n# We read a pending A result from the queue, and then immediately fire off the\n# next memory fetch, to get the maximum concurrency.\nor.ldtmu0 ra39, ra39, ra39; nop\nadd raTmu0S, rCurrentA, rAccum1; nop\nor rA0to15, r4, 0; nop\n\n# Now we pull the values from B, and fire off the next fetch.\nadd.ldtmu1 rCurrentA, rCurrentA, rAccum2; nop\nadd raTmu1S, rCurrentB, rAccum1; nop\nadd rCurrentB, rCurrentB, rAccum2; fmul rAccum0, rA0to15, r4\nfadd rTotal, rTotal, rAccum0; nop\n\nsub rL, rL, -16; nop\n\nsub rAccum0, rK, 15; nop\nsub ra39, rL, rAccum0; nop\nbrr.ns ra39, main_loop_l\nNOP\nNOP\nNOP\n\n\u6f14\u7b97\u5668\u3060\u3051\u3067\u306a\u304f\u30d9\u30af\u30c8\u30eb\u30ec\u30b8\u30b9\u30bf\u3092\u4e0a\u624b\u304f\u4f7f\u3046\u3068\u3044\u3046\u4e8b\u3082\u5927\u5207\u3067\u3059\u3002\u30ec\u30b8\u30b9\u30bf\u3092\u4e0a\u624b\u304f\u4f7f\u308f\u306a\u3044\u3068\u3001\u5fc5\u7136\u7684\u306b\u30e1\u30e2\u30ea\u306b\u7f6e\u304f\u30c7\u30fc\u30bf\u304c\u5897\u3048\u307e\u3059\u3002\u30e1\u30e2\u30ea\u306f\u30ec\u30b8\u30b9\u30bf\u3088\u308a\u5727\u5012\u7684\u306b\u9045\u3044\u3067\u3059\u3002\n\u30d9\u30af\u30c8\u30eb\u8a08\u7b97\u6a5f\u306f\u30ec\u30b8\u30b9\u30bf\u3092\u6ca2\u5c71\u642d\u8f09\u3057\u3066\u3044\u308b\u306e\u304c\u7279\u5fb4\u3067\u3001VideoCore\u306e\u5834\u5408\u306f\u5404QPU\u6bce\u306b\u9577\u305516\u306e\u30ec\u30b8\u30b9\u30bf\u304c64\u672c\u3042\u308a\u307e\u3059\u3002\u3064\u307e\u308a\u3001\u5404QPU\u4e0a\u306b\u6700\u592716x64\u306e\u884c\u5217(1024\u6210\u5206)\u3092\u7f6e\u304f\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002QPU\u306f12\u500b\u3042\u308b\u306e\u3067\u5168\u4f53\u3067\u306f\u6700\u592712288\u500b\u306e\u5b9f\u6570\u5024\u3092\u540c\u6642\u306b\u30ec\u30b8\u30b9\u30bf\u4e0a\u306b\u7f6e\u304f\u4e8b\u304c\u51fa\u6765\u307e\u3059\u3002pi-gemm\u306e\u30b3\u30fc\u30c9\u3092\u898b\u3066\u307f\u308b\u306864\u672c\u4e2d1\u672c\u3060\u3051(rTotal)\u304c\u5b9f\u6570\u5024\u7528\u3067\u4ed6\u306f\u30a2\u30c9\u30ec\u30b9\u3068\u304b\u30eb\u30fc\u30d7\u306e\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u7528\u3067\u3059\u3002\u3053\u308c\u306f\u975e\u5e38\u306b\u3082\u3063\u305f\u3044\u306a\u3044\u3067\u3059\u3002\n64\u672c\u306e\u30ec\u30b8\u30b9\u30bf(ra0,ra1,...,ra31\u3068rb0,rb1,...,rb31)\u306e\u4ed6\u306b\u3001\u66f4\u306b\u9ad8\u901f\u306a\u30a2\u30ad\u30e5\u30e0\u30ec\u30fc\u30bf\u304c4\u672c(r0,r1,r2,r3)\u3042\u308a\u307e\u3059\u3002\u30ec\u30b8\u30b9\u30bf\u3078\u66f8\u304d\u8fbc\u307e\u308c\u305f\u5024\u306f\u6b21\u306e\u6b21\u306e\u547d\u4ee4\u307e\u3067\u8aad\u3081\u307e\u305b\u3093\u304c\u3001\u30a2\u30ad\u30e5\u30e0\u30ec\u30fc\u30bf\u3060\u3068\u6b21\u306e\u547d\u4ee4\u3067\u8aad\u3081\u307e\u3059\u30024\u672c\u3057\u304b\u306a\u3044\u306e\u3067\u7121\u99c4\u9063\u3044\u3057\u306a\u3044\u3088\u3046\u306b\u3057\u307e\u3057\u3087\u3046\u3002\n   mov(ra0, 1)       # \u3053\u3053\u3067\u306e\u66f8\u304d\u8fbc\u307e\u308c\u305f\u5024\u306f\n   nop()\n   iadd(ra0, ra0, 2) # \u3053\u3053\u3067\u521d\u3081\u3066\u8aad\u3081\u308b\n\n   mov(r0, 1)        # \u30a2\u30ad\u30e5\u30e0\u30ec\u30fc\u30bf\u3060\u3068\n   isub(r0, r0, 1)   # \u6b21\u306e\u547d\u4ee4\u3067\u8aad\u3081\u308b\n\n\u4ee5\u5f8c\u3001\u3053\u308c\u3089\u306e\u4e8b\u306b\u6c17\u3092\u4ed8\u3051\u306a\u304c\u3089\u30013\u91cd\u30eb\u30fc\u30d7\u306e\u4e00\u756a\u5185\u5074\u306e\u30b3\u30fc\u30c9\u3092\u66f8\u3044\u3066\u3044\u304d\u307e\u3059\u3002\u7d9a\u304d\u306f\u6b21\u56de\u3067\u3059\u3002\n\u6700\u5185\u30eb\u30fc\u30d7\u306f\u6700\u3082\u5b9f\u884c\u3055\u308c\u308b\u56de\u6570\u304c\u591a\u3044\u306e\u3067\u3001\u6f14\u7b97\u306e\u5bc6\u5ea6\u304c\u91cd\u8981\u3067\u3059\u3002\n\n\u4eca\u56de\u306e\u65b9\u91dd\n64\u672c\u306e\u30ec\u30b8\u30b9\u30bf\u5168\u90e8\u3092\u884c\u5217\u3092\u683c\u7d0d\u3059\u308b\u70ba\u306b\u4f7f\u3044\u307e\u3059\u3002\u884c\u5217\u306e\u30a2\u30c9\u30ec\u30b9\u3001\u30e1\u30e2\u30ea\u30a2\u30af\u30bb\u30b9\u306e\u30b9\u30c8\u30e9\u30a4\u30c9\u3001\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u3001\u884c\u5217\u306e\u30b5\u30a4\u30bap,q,rp,q,r\u7b49\u306e\u30c7\u30fc\u30bf\u3092\u7f6e\u304f\u30ec\u30b8\u30b9\u30bf\u304c\u7121\u304f\u306a\u308a\u307e\u3059\u304c\u9811\u5f35\u308c\u3070\u4f55\u3068\u304b\u306a\u308a\u307e\u3059\u3002\n\u4e0a\u3067\u8aac\u660e\u3057\u305f\u69d8\u306b\u30012\u3064\u306e\u30d9\u30af\u30c8\u30eba,b\\mathbf{a},\\mathbf{b}\u3092load\u3057\u305f\u6642\u306b\u5982\u4f55\u306b\u305f\u304f\u3055\u3093\u306e\u6709\u52b9\u306a\u6f14\u7b97\u3092\u884c\u3048\u308b\u304b\u304c\u30dd\u30a4\u30f3\u30c8\u3067\u3059\u3002\u9577\u3055nn\u306e\u30d9\u30af\u30c8\u30eb\u306e\u5185\u7a4d\naTb=a0b0+a1b1+\u22ef+an\u22121bn\u22121 \\mathbf{a}^T\\mathbf{b}=a_0b_0+a_1b_1+\\cdots+a_{n-1}b_{n-1} \n\u3067\u306f\u30012n\u30ef\u30fc\u30c9\u306eload\u306b\u5bfe\u3057\u3066nn\u56de\u306e\u4e57\u7b97\u3068n\u22121n-1\u56de\u306e\u52a0\u7b97\u3068\u3053\u308c\u3092\u6b21\u3005\u8db3\u3057\u3053\u3080\u70ba\u306e\u52a0\u7b97\u304c1\u56de\u3067\u8a082n2n\u56de\u3057\u304b\u6f14\u7b97\u304c\u3067\u304d\u307e\u305b\u3093\u3002\u305d\u3053\u3067\u5185\u7a4d\u3067\u306f\u306a\u304f\u9577\u3055mm\u306e\u30d9\u30af\u30c8\u30eb\u3068nn\u306e\u30d9\u30af\u30c8\u30eb\u306e\u76f4\u7a4d\n\\mathbf{a}\\mathbf{b}^T = \\begin{pmatrix}\na_0b_0 & a_0b_1 & \\cdots & a_0b_{n-1} \\\\\na_1b_0 & a_1b_1 & \\cdots & a_1b_{n-1} \\\\\n\\vdots & \\vdots & \\ddots & \\vdots \\\\\na_{m-1}b_0 & a_{m-1}b_1 & \\cdots & a_{m-1}b_{n-1}\n\\end{pmatrix}\nabT=(a0b0a0b1\u22efa0bn\u22121a1b0a1b1\u22efa1bn\u22121\u22ee\u22ee\u22f1\u22eeam\u22121b0am\u22121b1\u22efam\u22121bn\u22121){\\mathbf{a}\\mathbf{b}^T = \\begin{pmatrix}\na_0b_0 & a_0b_1 & \\cdots & a_0b_{n-1} \\\\\na_1b_0 & a_1b_1 & \\cdots & a_1b_{n-1} \\\\\n\\vdots & \\vdots & \\ddots & \\vdots \\\\\na_{m-1}b_0 & a_{m-1}b_1 & \\cdots & a_{m-1}b_{n-1}\n\\end{pmatrix}\n}\n\u304c\u8a08\u7b97\u5358\u4f4d\u3068\u306a\u308b\u3088\u3046\u306b\u30a2\u30eb\u30b4\u30ea\u30ba\u30e0\u3092\u4f5c\u308a\u307e\u3059\u3002\u3053\u3061\u3089\u3067\u306fm+nm+n\u30ef\u30fc\u30c9\u306eload\u306b\u5bfe\u3057\u3066\u3001mnmn\u56de\u306e\u4e57\u7b97\u3068\u8db3\u3057\u3053\u307f\u306e\u70ba\u306e\u52a0\u7b97\u304cmnmn\u56de\u3001\u8a082mn2mn\u56de\u306e\u6f14\u7b97\u304c\u53ef\u80fd\u3067\u3059\u3002\n64\u500b\u306e\u30ec\u30b8\u30b9\u30bf\u306e\u4f7f\u3044\u65b9\u3067\u3059\u304c\u3001\u4e0b\u56f3\u306e\u3088\u3046\u306b16x64\u306e\u884c\u5217\u3092\u5358\u4f4d\u306b\u3057\u3066\u3001\u4e57\u7b97\u7d50\u679c\u306e\u5404\u5217\u30d9\u30af\u30c8\u30eb\u3092\u30ec\u30b8\u30b9\u30bf\u306b\u683c\u7d0d\u3059\u308b\u4e8b\u306b\u3057\u307e\u3059\u300232x32\u3068\u304b64x16\u306b\u3057\u306a\u304b\u3063\u305f\u7406\u7531\u306f\u5f8c\u3067\u8aac\u660e\u3057\u307e\u3059\u3002\n \n\n\u3053\u306e\u639b\u3051\u7b97\u3092\u3069\u3046\u306b\u304b\u3057\u3066\u3084\u3063\u3066\u3001\u6b21\u3005\u8db3\u3057\u3053\u3093\u3067\u3044\u3051\u3070\u4e0b\u56f3\u306e\u90e8\u5206\u884c\u5217\u306e\u7a4d\u304c\u8a08\u7b97\u3067\u304d\u307e\u3059\u3002\n\n\u3053\u308c\u306f\u4f1d\u7d71\u7684\u306a\u65b9\u6cd5\u3067\u3001\u753b\u50cf\u51e6\u7406\u5c02\u7528\u306eGPU\u3067\u306f\u03b1\u30d6\u30ec\u30f3\u30c9\u3068\u52a0\u7b97\u5408\u6210\u3092\u4f7f\u3063\u3066\u8a08\u7b97\u3057\u3066\u3044\u305f\u307f\u305f\u3044\u3067\u3059\u3002\n\n\u30e1\u30e2\u30ea\n\u4e0b\u56f3\u306fVideoCore\u306e\u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3\u56f3\u3067\u3059\u3002Uniform Cache\u304bTexture and Memory Lookup Unit(TMU)\u304bVertex Pipe Memory(VPM)\u3092\u4f7f\u3063\u3066Host-GPU\u9593\u3067\u30c7\u30fc\u30bf\u3092\u3084\u308a\u53d6\u308a\u3057\u307e\u3059\u3002\n\n\nVideoCore IV 3D Architecture Reference Guide\u3088\u308a\u5f15\u7528\n\nUniform\u3068TMU\u306f\u8aad\u307f\u8fbc\u307f\u5c02\u7528\u3067\u3059\u3002\u3053\u308c\u3089\u306fVPM\u3088\u308aload\u304c\u901f\u305d\u3046\u3067\u3059\u3002\u30d9\u30f3\u30c1\u30de\u30fc\u30af\u306f\u3068\u3063\u3066\u3044\u306a\u3044\u306e\u3067\u5177\u4f53\u7684\u306a\u30d1\u30e9\u30e1\u30fc\u30bf\u306f\u307e\u3060\u5206\u304b\u308a\u307e\u305b\u3093\u3002\nUniform\u306f32bit\u306e\u30c7\u30fc\u30bf\u3092\u30b7\u30fc\u30b1\u30f3\u30b7\u30e3\u30eb\u306b\u8aad\u3080\u70ba\u306b\u4f7f\u3044\u307e\u3059\u300216\u500b\u306e\u6210\u5206\u5168\u3066\u306b\u540c\u3058\u5024\u304c\u8aad\u307f\u8fbc\u307e\u308c\u307e\u3059\u3002\u3064\u307e\u308a\u30b9\u30ab\u30e9\u30fc\u306eload\u306b\u9069\u3057\u3066\u3044\u307e\u3059\u3002TMU\u304b\u3089\u306f\u4e00\u56de\u306eload\u306732bit\u306e\u30c7\u30fc\u30bf16\u500b\u3092\u53d6\u308a\u8fbc\u3080\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\u3064\u307e\u308a\u30d9\u30af\u30c8\u30eb\u306eload\u306b\u9069\u3057\u3066\u3044\u307e\u3059\u3002(\u5404\u30b9\u30e9\u30a4\u30b9\u4e8b\u306b\u6700\u59272\u3064\u306eTMU\u3001TMU0\u3068TMU1\u3092\u7f6e\u304f\u3053\u3068\u304c\u51fa\u6765\u307e\u3059\u3002)\n\u5f93\u3044\u307e\u3057\u3066\u3001\u4ee5\u4e0b\u306e\u76f4\u7a4d\u3092\u8a08\u7b97\u3059\u308b\u306b\u306f\u30d9\u30af\u30c8\u30eba\\mathbf{a}\u306fTMU0\u3067load\u3057\u3001\u30b9\u30ab\u30e9\u30fcbib_i\u306fUniform Cache\u3067load\u3059\u308b\u3088\u3046\u306b\u3059\u308b\u306e\u304c\u826f\u3044\u3060\u308d\u3046\u3068\u3044\u3046\u4e8b\u306b\u306a\u308a\u307e\u3059\u3002Row-major\u3067\u3059\u304b\u3089b0,b1,\u2026,b63b_0,b_1,\\ldots,b_{63}\u306f\u9023\u7d9a\u30a2\u30c9\u30ec\u30b9\u306b\u914d\u7f6e\u3055\u308c\u3066\u304a\u308a\u3001Uniform cache\u3067\u6b21\u3005load\u3059\u308b\u4e8b\u304c\u51fa\u6765\u307e\u3059\u3002\u5148\u307b\u306916x64\u306b\u3057\u305f\u306e\u306f\u3053\u306e\u30b7\u30fc\u30b1\u30f3\u30b7\u30e3\u30eb\u306aload\u3092\u51fa\u6765\u308b\u3060\u3051\u9577\u304f\u53d6\u308a\u305f\u304b\u3063\u305f\u304b\u3089\u3067\u3059\u3002\nabT=(b0a,b1a,\u2026,b63a)\\mathbf{a}\\mathbf{b}^T = (b_0\\mathbf{a}, b_1\\mathbf{a}, \\ldots, b_{63}\\mathbf{a})\n\n\u6700\u5185\u30eb\u30fc\u30d7\u306e\u5b9f\u88c5\n\u3053\u3053\u307e\u3067\u306e\u8a08\u7b97\u3092\u5b9f\u969b\u306b\u30b3\u30fc\u30c9\u306b\u3057\u3066\u307f\u307e\u3059\u3002\u307e\u305a\u7d20\u6734\u306b\u66f8\u304f\u3068\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\u5b9f\u6570\u5024\u4ee5\u5916\u306e\u5909\u6570(A_cur\u3084A_base\u306a\u3069)\u3092\u3069\u3053\u306b\u7f6e\u304f\u304b\u306f\u4e00\u65e6\u8003\u3048\u307e\u305b\u3093\u3002\n    # \u5404\u5217\u30d9\u30af\u30c8\u30eb\u30920\u3067\u521d\u671f\u5316\n    mov(ra0, 0.0)\n    mov(rb0, 0.0)\n    ... # \u7701\u7565\n    mov(rb31, 0.0)\n\n    iadd(A_cur, A_base, A_offs)     # \u30d9\u30af\u30c8\u30eba\u306e\u30a2\u30c9\u30ec\u30b9\u3092\u521d\u671f\u5316\n    mov(B_cur, B_base)              # \u30d9\u30af\u30c8\u30ebb\u306e\u30a2\u30c9\u30ec\u30b9\u3092\u521d\u671f\u5316\n    mov(k, q)                       # \u30eb\u30fc\u30d7\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u3092\u521d\u671f\u5316\n\n    L.k_loop\n\n    mov(tmu0_s, A_cur)              # \u30d9\u30af\u30c8\u30eba\u306e\u5404\u6210\u5206\u306e\u30a2\u30c9\u30ec\u30b9\u3092\u30bb\u30c3\u30c8\n    mov(uniforms_address, B_cur)    # \u30d9\u30af\u30c8\u30ebb\u306e\u5148\u982d\u30a2\u30c9\u30ec\u30b9\u3092\u30bb\u30c3\u30c8\n    iadd(A_cur, A_cur, 4)           # \u30a2\u30c9\u30ec\u30b9\u3092\u30a4\u30f3\u30af\u30ea\u30e1\u30f3\u30c8\n    iadd(B_cur, B_cur, B_stride)    # \u30a2\u30c9\u30ec\u30b9\u3092\u30a4\u30f3\u30af\u30ea\u30e1\u30f3\u30c8\n\n    nop(sig='load tmu0')    # TMU0\u304b\u3089\u30d9\u30af\u30c8\u30eba\u3092load(\u7d50\u679c\u306f\u30ec\u30b8\u30b9\u30bfr4\u306b\u5165\u308b)\n\n    fmul(r0, r4, uniform)   # uniform\u304b\u3089b[0]\u3092load\u3057\u3001a\u3068\u639b\u3051\u308b\n    fadd(ra0, ra0, r0)      # \u7b2c0\u5217\u306b\u8db3\u3057\u3053\u3080\n\n    fmul(r0, r4, uniform)   # uniform\u304b\u3089b[1]\u3092load\u3057\u3001a\u3068\u639b\u3051\u308b\n    fadd(rb0, rb0, r0)      # \u7b2c1\u5217\u306b\u8db3\u3057\u3053\u3080\n\n    fmul(r0, r4, uniform)   # uniform\u304b\u3089b[2]\u3092load\u3057\u3001a\u3068\u639b\u3051\u308b\n    fadd(ra1, ra1, r0)      # \u7b2c2\u5217\u306b\u8db3\u3057\u3053\u3080\n\n    ... # \u7701\u7565\n\n    fmul(r0, r4, uniform)   # uniform\u304b\u3089b[62]\u3092load\u3057\u3001a\u3068\u639b\u3051\u308b\n    fadd(ra31, ra31, r0)    # \u7b2c62\u5217\u306b\u8db3\u3057\u3053\u3080\n\n    fmul(r0, r4, uniform)   # uniform\u304b\u3089b[63]\u3092load\u3057\u3001a\u3068\u639b\u3051\u308b\n    fadd(rb31, rb31, r0)    # \u7b2c63\u5217\u306b\u8db3\u3057\u3053\u3080\n\n    isub(k, k, 1)           # \u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u30921\u6e1b\u3089\u3059\n    jzc(L.k_loop)           # 0\u3058\u3083\u306a\u3044\u306a\u3089\u3070\u30eb\u30fc\u30d7\u6700\u521d\u306b\u623b\u308b(Jump if Z-flags are Clear)\n    nop()                   # delay slot\n    nop()                   # delay slot\n    nop()                   # delay slot\n\n\u3053\u306e\u6642\u70b9\u3067\u306floop body\u304c138\u547d\u4ee4\u3067\u3001\u5b9f\u8cea64\u547d\u4ee4\u5206\u306e\u6570\u5024\u8a08\u7b97\u3092\u3057\u3066\u3044\u308b\u306e\u306764/138=46.4%\u306e\u52b9\u7387\u3067\u6f14\u7b97\u5668\u3092\u4f7f\u3063\u3066\u3044\u307e\u3059\u3002\u69d8\u3005\u306a\u30c6\u30af\u30cb\u30c3\u30af\u3092\u4f7f\u3063\u3066\u3053\u308c\u3092\u6700\u9069\u5316\u3057\u3066\u3044\u304d\u307e\u3059\u3002\n\u307e\u305a\u3001\u540c\u6642\u306b\u5b9f\u884c\u3067\u304d\u308b\u52a0\u7b97\u3068\u4e57\u7b97\u3092\u8a70\u3081\u3066\u3044\u304d\u307e\u3059\u3002\n    L.k_loop\n\n    mov(tmu0_s, A_cur)              # \u30d9\u30af\u30c8\u30eba\u306e\u5404\u6210\u5206\u306e\u30a2\u30c9\u30ec\u30b9\u3092\u30bb\u30c3\u30c8\n    mov(uniforms_address, B_cur)    # \u30d9\u30af\u30c8\u30ebb\u306e\u5148\u982d\u30a2\u30c9\u30ec\u30b9\u3092\u30bb\u30c3\u30c8\n    iadd(A_cur, A_cur, 4)           # \u30a2\u30c9\u30ec\u30b9\u3092\u30a4\u30f3\u30af\u30ea\u30e1\u30f3\u30c8\n    iadd(B_cur, B_cur, B_stride)    # \u30a2\u30c9\u30ec\u30b9\u3092\u30a4\u30f3\u30af\u30ea\u30e1\u30f3\u30c8\n\n    nop(sig='load tmu0')    # TMU0\u304b\u3089\u30d9\u30af\u30c8\u30eba\u3092load(\u7d50\u679c\u306f\u30ec\u30b8\u30b9\u30bfr4\u306b\u5165\u308b)\n\n    fmul(r0, r4, uniform)\n    fadd(ra0, ra0, r0).fmul(r0, r4, uniform)\n    fadd(rb0, rb0, r0).fmul(r0, r4, uniform)\n    fadd(ra1, ra1, r0).fmul(r0, r4, uniform)\n\n    ... # \u7701\u7565\n\n    fadd(rb30, rb30, r0).fmul(r0, r4, uniform)\n    fadd(ra31, ra31, r0).fmul(r0, r4, uniform)\n    fadd(rb31, rb31, r0)\n\n    isub(k, k, 1)           # \u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u30921\u6e1b\u3089\u3059\n    jzc(L.k_loop)           # 0\u3058\u3083\u306a\u3044\u306a\u3089\u3070\u30eb\u30fc\u30d7\u6700\u521d\u306b\u623b\u308b(Jump if Z-flags are Clear)\n    nop()                   # delay slot\n    nop()                   # delay slot\n    nop()                   # delay slot\n\n\u6761\u4ef6\u5206\u5c90jzc\u306e\u5f8c\u306e3\u547d\u4ee4\u306fdelay slot\u3068\u3044\u3063\u3066\u3001jzc\u3092\u767a\u884c\u3057\u3066\u304b\u3089\u5b9f\u969b\u306e\u30b8\u30e3\u30f3\u30d7\u304c\u884c\u308f\u308c\u308b\u307e\u3067\u306b\u4f59\u5206\u306a3\u547d\u4ee4\u304c\u5fc5\u305a\u5b9f\u884c\u3055\u308c\u307e\u3059\u3002\u3053\u3053\u3067\u3082\u6f14\u7b97\u3092\u884c\u3046\u4e8b\u304c\u51fa\u6765\u307e\u3059\u3002\n    L.k_loop\n\n    mov(tmu0_s, A_cur)              # \u30d9\u30af\u30c8\u30eba\u306e\u5404\u6210\u5206\u306e\u30a2\u30c9\u30ec\u30b9\u3092\u30bb\u30c3\u30c8\n    mov(uniforms_address, B_cur)    # \u30d9\u30af\u30c8\u30ebb\u306e\u5148\u982d\u30a2\u30c9\u30ec\u30b9\u3092\u30bb\u30c3\u30c8\n    iadd(A_cur, A_cur, 4)           # \u30a2\u30c9\u30ec\u30b9\u3092\u30a4\u30f3\u30af\u30ea\u30e1\u30f3\u30c8\n    iadd(B_cur, B_cur, B_stride)    # \u30a2\u30c9\u30ec\u30b9\u3092\u30a4\u30f3\u30af\u30ea\u30e1\u30f3\u30c8\n\n    nop(sig='load tmu0')    # TMU0\u304b\u3089\u30d9\u30af\u30c8\u30eba\u3092load(\u7d50\u679c\u306f\u30ec\u30b8\u30b9\u30bfr4\u306b\u5165\u308b)\n\n    fmul(r0, r4, uniform)\n    fadd(ra0, ra0, r0).fmul(r0, r4, uniform)\n    fadd(rb0, rb0, r0).fmul(r0, r4, uniform)\n    fadd(ra1, ra1, r0).fmul(r0, r4, uniform)\n\n    ... # \u7701\u7565\n\n    fadd(ra30, ra30, r0).fmul(r0, r4, uniform)\n\n    isub(k, k, 1)           # \u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u30921\u6e1b\u3089\u3059\n    jzc(L.k_loop)           # 0\u3058\u3083\u306a\u3044\u306a\u3089\u3070\u30eb\u30fc\u30d7\u6700\u521d\u306b\u623b\u308b(Jump if Z-flags are Clear)\n    fadd(rb30, rb30, r0).fmul(r0, r4, uniform) # delay slot\u3067\u5b9f\u884c\n    fadd(ra31, ra31, r0).fmul(r0, r4, uniform) # delay slot\u3067\u5b9f\u884c\n    fadd(rb31, rb31, r0)                       # delay slot\u3067\u5b9f\u884c\n\n\u3053\u3053\u307e\u3067\u3067\u30eb\u30fc\u30d7\u5185\u90e872\u547d\u4ee4\u4e2d\u300164\u547d\u4ee4\u5206\u3092\u6570\u5024\u6f14\u7b97\u3067\u57cb\u3081\u308b\u4e8b\u304c\u51fa\u6765\u307e\u3057\u305f\u306e\u306764/72=88.9%\u306e\u52b9\u7387\u3067\u6f14\u7b97\u5668\u3092\u4f7f\u3048\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3057\u305f\u3002\n\u30a2\u30c9\u30ec\u30b9\u8a08\u7b97\u306e\u30b3\u30fc\u30c9\u3082\u6700\u9069\u5316\u3057\u307e\u3059\u3002\u3053\u3053\u306f\u3044\u308d\u3044\u308d\u3068\u5236\u7d04\u304c\u3042\u308a\u96e3\u3057\u3044\u3067\u3059\u3002\u307e\u305a\u3001\n\nuniforms_address\u3078\u306e\u66f8\u304d\u8fbc\u307f\u5f8c2\u547d\u4ee4\u306funiform\u306b\u30a2\u30af\u30bb\u30b9\u3057\u3066\u306f\u306a\u3089\u306a\u3044(\u30ea\u30d5\u30a1\u30ec\u30f3\u30b9\u30ac\u30a4\u30c9P22)\n\n\u3068\u3044\u3046\u306e\u304c\u3042\u308a\u307e\u3059\u3002\u307e\u305f\n\n\ntmu0_s\u3092\u30bb\u30c3\u30c8\n\n'load tmu0'\u30b7\u30b0\u30ca\u30eb\u3092\u767a\u884c\n\nr4\u3092read\n\n\u3068\u3044\u3046\u9806\u756a\u3092\u5d29\u3059\u4e8b\u306f\u51fa\u6765\u307e\u305b\u3093\u3002A_cur\u306e\u66f4\u65b0\u3068tmu0_s\u3078\u306e\u66f8\u304d\u8fbc\u307f\u306f\u540c\u6642\u306b\u306f\u884c\u3048\u307e\u305b\u3093\u3002\u30b7\u30b0\u30ca\u30eb\u306e\u767a\u884c\u306f\u4ed6\u306e\u6f14\u7b97\u306e\u3064\u3044\u3067\u306b\u767a\u884c\u3059\u308b\u4e8b\u304c\u51fa\u6765\u307e\u3059\u3002\u3053\u308c\u3089\u306e\u5236\u7d04\u3092\u5b88\u308a\u3064\u3064\u30d1\u30a4\u30d7\u30e9\u30a4\u30f3\u5316\u3057\u3066\u8a70\u3081\u8fbc\u307f\u307e\u3059\u3002\n\n    mov(uniforms_address, B_cur)    # \u6700\u521d\u306e\u4e00\u56de\u5206\u306f\u30eb\u30fc\u30d7\u306b\u5165\u308b\u524d\u306b\u3084\u308b\n    mov(tmu0_s, A_cur)\n    iadd(A_cur, A_cur, 4)\n    nop(sig='load tmu0')\n\n    L.k_loop\n\n    mov(tmu0_s, A_cur)\n    iadd(B_cur, B_cur, B_stride)\n\n    iadd(A_cur, A_cur, 4).fmul(r0, r4, uniform)\n    fadd(ra0, ra0, r0).fmul(r0, r4, uniform)\n    fadd(rb0, rb0, r0).fmul(r0, r4, uniform)\n    fadd(ra1, ra1, r0).fmul(r0, r4, uniform)\n\n    ... # \u7701\u7565\n\n    fadd(ra30, ra30, r0).fmul(r0, r4, uniform)\n\n    isub(k, k, 1)\n    jzc(L.k_loop)\n    fadd(rb30, rb30, r0).fmul(r0, r4, uniform)\n    fadd(ra31, ra31, r0).fmul(r0, r4, uniform)         # <- \u6700\u5f8c\u306euniform,r4\u3078\u306e\u30a2\u30af\u30bb\u30b9\n    fadd(rb31, rb31, r0, sig='load tmu0').mov(uniforms_address, B_cur)  # <- \u6b21\u306e\u30a4\u30c6\u30ec\u30fc\u30b7\u30e7\u30f3\u3092\u6e96\u5099\n\n\u3053\u3053\u3067\u3001\u3061\u3087\u3063\u3068\u30c8\u30ea\u30c3\u30ad\u30fc\u306a\u6700\u9069\u5316\u3092\u884c\u3063\u3066isub(k, k, 1)\u3092\u6d88\u3057\u307e\u3059\u3002\u5909\u6570k\u306f\u30eb\u30fc\u30d7\u306e\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u3067\u3059\u304b\u3089\u30b9\u30ab\u30e9\u30fc\u3067\u3059\u3002\u305d\u308c\u304b\u3089B_cur\u306funiforms cache\u306e\u30d9\u30fc\u30b9\u30a2\u30c9\u30ec\u30b9\u3067\u3053\u308c\u3082\u30b9\u30ab\u30e9\u30fc\u3067\u3059\u3002\u5f93\u3063\u3066\u3001\u3053\u308c\u3089\u3092\u4e00\u3064\u306e\u30d9\u30af\u30c8\u30eb\u8a70\u3081\u8fbc\u3093\u3067\u3057\u307e\u3046\u4e8b\u304c\u51fa\u6765\u307e\u3059\u3002\u5177\u4f53\u7684\u306b\u306f\u3001\u30d9\u30af\u30c8\u30ebb\\mathbf{b}\u306e\u30a2\u30c9\u30ec\u30b9\u3092B_cur[0]\u306b\u3001k\u3092B_cur[1]\u306b\u5165\u308c\u3001B_stride[0]\u306b\u30b9\u30c8\u30e9\u30a4\u30c9\u3001B_stride[1]\u306b-1\u3092\u5165\u308c\u307e\u3059\u3002\u3059\u308b\u3068iadd(B_cur, B_cur, B_stride)\u3067isub(k, k, 1)\u306e\u8a08\u7b97\u3082\u3067\u304d\u307e\u3059\u3002\n\u7279\u5b9a\u306e\u6210\u5206\u3078\u3060\u3051\u4ee3\u5165\u3092\u884c\u3046\u306b\u306f\u3001\u5404\u6210\u5206\u306b\u7570\u306a\u308b2bit\u5373\u5024\u3092\u4ee3\u5165\u51fa\u6765\u308bper-element load immediates\u547d\u4ee4\u3067\u30d5\u30e9\u30b0\u3092\u30bb\u30c3\u30c8\u3057\u3066\u3001\u6761\u4ef6\u3092\u6e80\u305f\u3059\u6210\u5206\u306e\u307f\u306b\u8a08\u7b97\u7d50\u679c\u3092\u4ee3\u5165\u3059\u308bconditional\u547d\u4ee4\u3092\u4f7f\u3044\u307e\u3059\u3002\u4ee5\u4e0b\u306fB_stride[1]\u306b\u3060\u3051-1\u3092\u4ee3\u5165\u3059\u308b\u4f8b\u3067\u3059\u3002\n    ldi(null, [1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1], set_flags=True)\n    mov(B_stride, -1, cond='zs') # move if Z-flag is Set\n\nUniform Cache\u306e\u30d9\u30fc\u30b9\u30a2\u30c9\u30ec\u30b9\u306b\u4ee3\u5165\u3059\u308b\u90e8\u5206\u3067\u306f\u3001\u7b2c0\u6210\u5206\u306e\u5024\u304c\u4f7f\u308f\u308c\u308b\u3068\u6c7a\u3081\u3089\u308c\u3066\u3044\u308b(\u30ea\u30d5\u30a1\u30ec\u30f3\u30b9\u30ac\u30a4\u30c9P22)\u306e\u3067\u3001\u7279\u5225\u306a\u51e6\u7406\u306f\u4e0d\u8981\u3067\u3059\u3002\n    mov(uniforms_address, B_cur)  # B_cur[0]\u304c\u30bb\u30c3\u30c8\u3055\u308c\u308b\n\njzc\u306f16\u500b\u306e\u6210\u5206\u5168\u3066\u304c0\u3058\u3083\u306a\u3044\u3068\u304d\u306b\u30b8\u30e3\u30f3\u30d7\u3059\u308b\u3068\u3044\u3046\u547d\u4ee4\u3067\u3059\u3002jzc\u304ciadd(B_cur, B_cur, B_stride)\u3067\u30bb\u30c3\u30c8\u3055\u308c\u305f\u30d5\u30e9\u30b0\u3092\u53c2\u7167\u3067\u304d\u308b\u3088\u3046\u306b\u3001\u9593\u306e\u8a08\u7b97\u3067\u306f\u30d5\u30e9\u30b0\u3092\u30bb\u30c3\u30c8\u3057\u306a\u3044\u69d8\u306b\u3057\u307e\u3059\u3002\u5b9f\u969b\u306e\u30b3\u30fc\u30c9\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\n\n    # B_cur, B_stride\u3092\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u3059\u308b\u90e8\u5206\u306f\u7701\u7565\n\n    mov(uniforms_address, B_cur)    # \u6700\u521d\u306e\u4e00\u56de\u5206\u306f\u30eb\u30fc\u30d7\u306b\u5165\u308b\u524d\u306b\u3084\u308b\n    mov(tmu0_s, A_cur)\n    iadd(A_cur, A_cur, 4)\n    nop(sig='load tmu0')\n\n    L.k_loop\n\n    mov(tmu0_s, A_cur)\n    iadd(B_cur, B_cur, B_stride)\n\n    iadd(A_cur, A_cur, 4, set_flags=False).fmul(r0, r4, uniform)\n    fadd(ra0, ra0, r0, set_flags=False).fmul(r0, r4, uniform)\n    fadd(rb0, rb0, r0, set_flags=False).fmul(r0, r4, uniform)\n    fadd(ra1, ra1, r0, set_flags=False).fmul(r0, r4, uniform)\n\n    ... # \u7701\u7565\n\n    fadd(ra30, ra30, r0, set_flags=False).fmul(r0, r4, uniform)\n\n    jzc(L.k_loop)\n    fadd(rb30, rb30, r0).fmul(r0, r4, uniform)\n    fadd(ra31, ra31, r0).fmul(r0, r4, uniform)         # <- \u6700\u5f8c\u306euniform,r4\u3078\u306e\u30a2\u30af\u30bb\u30b9\n    fadd(rb31, rb31, r0, sig='load tmu0').mov(uniforms_address, B_cur)  # <- \u6b21\u306e\u30a4\u30c6\u30ec\u30fc\u30b7\u30e7\u30f3\u3092\u6e96\u5099\n\n\u3053\u3053\u307e\u3067\u3067\u30eb\u30fc\u30d7\u5185\u90e8\u304c68\u547d\u4ee4\u307e\u3067\u524a\u308c\u307e\u3057\u305f\u306e\u3067\u3001\u6f14\u7b97\u5668\u306e\u4f7f\u7528\u52b9\u7387\u306f64/68=94.1%\u3067\u3059\u3002\n\u6700\u5f8c\u306b2\u547d\u4ee4\u4f7f\u3063\u3066\u3044\u308b\n    mov(tmu0_s, A_cur)\n    iadd(B_cur, B_cur, B_stride)\n\n\u3092\n    iadd(B_cur, B_cur, B_stride).mov(tmu0_s, A_cur)\n\n\u306b\u3057\u3066\u3082\u3046\u4e00\u547d\u4ee4\u524a\u308a\u305f\u3044\u3093\u3067\u3059\u304c\u3001\n\nuniforms_address\u3078\u306e\u66f8\u304d\u8fbc\u307f\u5f8c2\u547d\u4ee4\u306funiform\u306b\u30a2\u30af\u30bb\u30b9\u3057\u3066\u306f\u306a\u3089\u306a\u3044(\u30ea\u30d5\u30a1\u30ec\u30f3\u30b9\u30ac\u30a4\u30c9P22)\n\n\u306b\u5f15\u3063\u304b\u304b\u3063\u3066\u3057\u307e\u3044\u307e\u3059\u3002\u9014\u4e2d\u306bjump\u304c\u5165\u308b\u306e\u3067\u6c17\u306b\u3057\u306a\u304f\u3066\u3082\u826f\u3044\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u304c\u3001\u5ff5\u306e\u305f\u3081\u3053\u306e\u554f\u984c\u3092\u89e3\u6c7a\u3057\u307e\u3059\u3002\n    L.k_loop\n\n    iadd(B_cur, B_cur, B_stride).mov(tmu0_s, A_cur)\n    iadd(A_cur, A_cur, 4, set_flags=False).fmul(r0, r4, uniform) # \u3053\u3053\u307e\u3067\u306e\u9593\u306b2\u547d\u4ee4\u5fc5\u8981\n\n    fadd(ra0, ra0, r0, set_flags=False).fmul(r0, r4, uniform)\n\n    ... # \u7701\u7565\n\n    fadd(ra30, ra30, r0).fmul(r0, r4, uniform)\n\n    jzc(L.k_loop)\n    fadd(rb30, rb30, r0).fmul(r0, r4, uniform)\n    fadd(ra31, ra31, r0).fmul(r0, r4, uniform)\n    fadd(rb31, rb31, r0, sig='load tmu0').mov(uniforms_address, B_cur)  #\u3000\u3053\u3053\u304b\u3089\n\n\u8db3\u308a\u306a\u30441\u547d\u4ee4\u3092jzc\u3067\u88dc\u3044\u307e\u3059\u3002\u305d\u306e\u70ba\u306b\u30bd\u30d5\u30c8\u30a6\u30a7\u30a2\u30d1\u30a4\u30d7\u30e9\u30a4\u30cb\u30f3\u30b0\u3092\u3057\u3066\u3001\u30eb\u30fc\u30d7\u5168\u4f53\u30924\u547d\u4ee4\u305a\u3089\u3057\u307e\u3059\u3002(\u30ea\u30d5\u30a1\u30ec\u30f3\u30b9\u30ac\u30a4\u30c9\u3067\u306f\u8a18\u8ff0\u304c\u898b\u3064\u304b\u3089\u306a\u304b\u3063\u305f\u3093\u3067\u3059\u304c\u3001delay slot\u5185\u3067mov(tmu0_s, A_cur)\u3092\u5b9f\u884c\u3059\u308b\u3068\u6b63\u3057\u304f\u52d5\u304b\u306a\u304b\u3063\u305f\u70ba\u30013\u547d\u4ee4\u3067\u306f\u306a\u304f4\u547d\u4ee4\u305a\u3089\u3057\u3066\u3044\u307e\u3059\u3002)\n    iadd(B_cur, B_cur, B_stride).mov(tmu0_s, A_cur)\n    iadd(A_cur, A_cur, 4, set_flags=False).fmul(r0, r4, uniform)\n    fadd(ra0, ra0, r0).fmul(r0, r4, uniform)\n    fadd(rb0, rb0, r0).fmul(r0, r4, uniform)\n\n    # \u2191\u306f\u307f\u51fa\u305f\u5206\n\n    L.k_loop\n\n    fadd(ra1, ra1, r0).fmul(r0, r4, uniform)\n\n    ... # \u7701\u7565\n\n    fadd(rb30, rb30, r0).fmul(r0, r4, uniform)\n    fadd(ra31, ra31, r0).fmul(r0, r4, uniform)\n    fadd(rb31, rb31, r0, sig='load tmu0').mov(uniforms_address, B_cur)  #\u3000\u3053\u3053\u304b\u3089\n    iadd(B_cur, B_cur, B_stride).mov(tmu0_s, A_cur)\n    jzc(L.k_loop)                                                # <- \u3053\u3044\u3064\u30671\u547d\u4ee4\u3092\u88dc\u3046\n    iadd(A_cur, A_cur, 4).fmul(r0, r4, uniform) # \u3053\u3053\u307e\u3067\u306e\u9593\u306b2\u547d\u4ee4\u5fc5\u8981\n    fadd(ra0, ra0, r0).fmul(r0, r4, uniform)\n    fadd(rb0, rb0, r0).fmul(r0, r4, uniform)\n\n    # \u2193\u306f\u307f\u51fa\u305f\u5206(\u3053\u3053\u3067\u30eb\u30fc\u30d7\u3092\u629c\u3051\u308b)\n\n    fadd(ra1, ra1, r0).fmul(r0, r4, uniform)\n\n    ... # \u7701\u7565\n\n    fadd(ra31, ra31, r0).fmul(r0, r4, uniform)\n    fadd(rb31, rb31, r0)\n\n\n\u4f55\u3092\u3084\u3063\u3066\u3044\u308b\u304b\u5206\u304b\u308a\u306b\u304f\u3044\u3068\u601d\u3046\u306e\u3067\u7d75\u3092\u63cf\u3044\u3066\u307f\u307e\u3057\u305f\u3002\n\n\u3053\u306e\u5909\u63db\u3092\u3059\u308b\u3068\u5c11\u306a\u304f\u3068\u30822\u30a4\u30c6\u30ec\u30fc\u30b7\u30e7\u30f3\u8d70\u3063\u3066\u3057\u307e\u3046\u306e\u3067q\u22652q\\geq 2\u3067\u3042\u308b\u4e8b\u3092\u4e0a\u3067\u8981\u8acb\u3057\u3066\u3044\u307e\u3059\u3002\n\u307e\u305f\u3001\u3053\u306e\u5909\u63db\u306b\u3088\u3063\u3066iadd(B_cur, B_cur, B_stride)\u306e\u30bf\u30a4\u30df\u30f3\u30b0\u304c1\u30a4\u30c6\u30ec\u30fc\u30b7\u30e7\u30f3\u5206\u305a\u308c\u308b\u306e\u3067k\u306e\u521d\u671f\u5024\u30921\u3064\u305a\u3089\u3059\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\u4ee5\u4e0a\u3067\u6700\u5185\u30eb\u30fc\u30d7\u306f\u6982\u306d\u5b8c\u6210\u3067\u3059\u3002\u9014\u4e2d\u3092\u7701\u7565\u3057\u306a\u3044\u3067Loop body\u66f8\u3044\u3066\u307f\u308b\u3068\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u611f\u3058\u3067\u3059\u3002\u975e\u5e38\u306b\u9ad8\u3044\u5bc6\u5ea6\u3067\u6f14\u7b97\u5668\u3092\u4f7f\u3048\u3066\u3044\u308b\u4e8b\u304c\u5206\u304b\u308b\u3068\u601d\u3044\u307e\u3059\u3002\n    L.k_loop\n\n    fadd(ra1,  ra1,  r0).fmul(r0, r4, uniform)\n    fadd(rb1,  rb1,  r0).fmul(r0, r4, uniform)\n    fadd(ra2,  ra2,  r0).fmul(r0, r4, uniform)\n    fadd(rb2,  rb2,  r0).fmul(r0, r4, uniform)\n    fadd(ra3,  ra3,  r0).fmul(r0, r4, uniform)\n    fadd(rb3,  rb3,  r0).fmul(r0, r4, uniform)\n    fadd(ra4,  ra4,  r0).fmul(r0, r4, uniform)\n    fadd(rb4,  rb4,  r0).fmul(r0, r4, uniform)\n    fadd(ra5,  ra5,  r0).fmul(r0, r4, uniform)\n    fadd(rb5,  rb5,  r0).fmul(r0, r4, uniform)\n    fadd(ra6,  ra6,  r0).fmul(r0, r4, uniform)\n    fadd(rb6,  rb6,  r0).fmul(r0, r4, uniform)\n    fadd(ra7,  ra7,  r0).fmul(r0, r4, uniform)\n    fadd(rb7,  rb7,  r0).fmul(r0, r4, uniform)\n    fadd(ra8,  ra8,  r0).fmul(r0, r4, uniform)\n    fadd(rb8,  rb8,  r0).fmul(r0, r4, uniform)\n    fadd(ra9,  ra9,  r0).fmul(r0, r4, uniform)\n    fadd(rb9,  rb9,  r0).fmul(r0, r4, uniform)\n    fadd(ra10, ra10, r0).fmul(r0, r4, uniform)\n    fadd(rb10, rb10, r0).fmul(r0, r4, uniform)\n    fadd(ra11, ra11, r0).fmul(r0, r4, uniform)\n    fadd(rb11, rb11, r0).fmul(r0, r4, uniform)\n    fadd(ra12, ra12, r0).fmul(r0, r4, uniform)\n    fadd(rb12, rb12, r0).fmul(r0, r4, uniform)\n    fadd(ra13, ra13, r0).fmul(r0, r4, uniform)\n    fadd(rb13, rb13, r0).fmul(r0, r4, uniform)\n    fadd(ra14, ra14, r0).fmul(r0, r4, uniform)\n    fadd(rb14, rb14, r0).fmul(r0, r4, uniform)\n    fadd(ra15, ra15, r0).fmul(r0, r4, uniform)\n    fadd(rb15, rb15, r0).fmul(r0, r4, uniform)\n    fadd(ra16, ra16, r0).fmul(r0, r4, uniform)\n    fadd(rb16, rb16, r0).fmul(r0, r4, uniform)\n    fadd(ra17, ra17, r0).fmul(r0, r4, uniform)\n    fadd(rb17, rb17, r0).fmul(r0, r4, uniform)\n    fadd(ra18, ra18, r0).fmul(r0, r4, uniform)\n    fadd(rb18, rb18, r0).fmul(r0, r4, uniform)\n    fadd(ra19, ra19, r0).fmul(r0, r4, uniform)\n    fadd(rb19, rb19, r0).fmul(r0, r4, uniform)\n    fadd(ra20, ra20, r0).fmul(r0, r4, uniform)\n    fadd(rb20, rb20, r0).fmul(r0, r4, uniform)\n    fadd(ra21, ra21, r0).fmul(r0, r4, uniform)\n    fadd(rb21, rb21, r0).fmul(r0, r4, uniform)\n    fadd(ra22, ra22, r0).fmul(r0, r4, uniform)\n    fadd(rb22, rb22, r0).fmul(r0, r4, uniform)\n    fadd(ra23, ra23, r0).fmul(r0, r4, uniform)\n    fadd(rb23, rb23, r0).fmul(r0, r4, uniform)\n    fadd(ra24, ra24, r0).fmul(r0, r4, uniform)\n    fadd(rb24, rb24, r0).fmul(r0, r4, uniform)\n    fadd(ra25, ra25, r0).fmul(r0, r4, uniform)\n    fadd(rb25, rb25, r0).fmul(r0, r4, uniform)\n    fadd(ra26, ra26, r0).fmul(r0, r4, uniform)\n    fadd(rb26, rb26, r0).fmul(r0, r4, uniform)\n    fadd(ra27, ra27, r0).fmul(r0, r4, uniform)\n    fadd(rb27, rb27, r0).fmul(r0, r4, uniform)\n    fadd(ra28, ra28, r0).fmul(r0, r4, uniform)\n    fadd(rb28, rb28, r0).fmul(r0, r4, uniform)\n    fadd(ra29, ra29, r0).fmul(r0, r4, uniform)\n    fadd(rb29, rb29, r0).fmul(r0, r4, uniform)\n    fadd(ra30, ra30, r0).fmul(r0, r4, uniform)\n    fadd(rb30, rb30, r0).fmul(r0, r4, uniform)\n    fadd(ra31, ra31, r0).fmul(r0, r4, uniform)\n    fadd(rb31, rb31, r0, sig='load tmu0').mov(uniforms_address, r2)\n    iadd(r2, r2, r3).mov(tmu0_s, r1)\n    jzc(L.k_loop)\n    iadd(r1, r1, 4).fmul(r0, r4, uniform)      # delay slot\n    fadd(ra0,  ra0,  r0).fmul(r0, r4, uniform) # delay slot\n    fadd(rb0,  rb0,  r0).fmul(r0, r4, uniform) # delay slot\n\n\u307e\u3068\u3081\u308b\u306816x64\u306e\u90e8\u5206\u884c\u5217\u3092SIMD\u3067\u8a08\u7b97\u3059\u308b\u30b3\u30fc\u30c9\u3092\u300167\u547d\u4ee4\u4e2d\u306e64\u547d\u4ee4(95.5%)\u304c\u5b9f\u6570\u5024\u6f14\u7b97\u3001\u30ec\u30b8\u30b9\u30bf\u30d5\u30a1\u30a4\u30eb\u306e100%\u304c\u5b9f\u6570\u5024\u7528\u3068\u3044\u3046\u9ad8\u3044\u52b9\u7387\u3067\u66f8\u304f\u3053\u3068\u304c\u51fa\u6765\u307e\u3057\u305f\u3002Uniform Cache\u304c\u5341\u5206\u306b\u901f\u3051\u308c\u3070\u826f\u3044\u6027\u80fd\u304c\u51fa\u308b\u3093\u3067\u306f\u306a\u3044\u304b\u3068\u601d\u3044\u307e\u3059\u3002\n\n\u884c\u5217\u6210\u5206\u4ee5\u5916\u3092\u3069\u3053\u306b\u7f6e\u304f\u304b\uff1f\n\u30ec\u30b8\u30b9\u30bf\u30d5\u30a1\u30a4\u30eb\u3092\u4f7f\u3044\u5207\u3063\u305f\u306e\u3067\u3001\u305d\u306e\u4ed6\u306e\u5909\u6570\u3092\u3069\u3053\u306b\u7f6e\u304f\u306e\u304b\u3068\u3044\u3046\u554f\u984c\u304c\u307e\u3060\u6b8b\u3063\u3066\u3044\u307e\u3059\u304c\u5927\u4e08\u592b\u3067\u3059\u3002\u6700\u5185\u30eb\u30fc\u30d7\u3067\u306f\u30a2\u30ad\u30e5\u30e0\u30ec\u30fc\u30bfr0,r1,r2,r3\u306e\u3046\u3061r1,r2,r3\u304c\u672a\u4f7f\u7528\u3067\u3059\u304b\u3089\n\n\nA_cur\u3092r1\u306b\n\nB_cur\u3092r2\u306b\n\nB_stride\u3092r3\u306b\n\n\u5272\u308a\u5f53\u3066\u308b\u4e8b\u304c\u51fa\u6765\u307e\u3059\u3002\u5148\u307b\u3069\u306eisub(k, k, 1)\u306e\u524a\u9664\u306f\u3053\u306e\u70ba\u306b\u3082\u5fc5\u8981\u3067\u3057\u305f\u3002\n\u307e\u305f\u3001A_cur\u306f16\u6210\u5206\u3092\u4f7f\u3044\u5207\u3063\u3066\u3044\u307e\u3059\u304c\u3001B_cur\u3068B_stride\u306f\u307e\u30602\u6210\u5206\u3057\u304b\u4f7f\u3063\u3066\u3044\u307e\u305b\u3093\u3002\u7a7a\u3044\u3066\u3044\u308b28\u30ef\u30fc\u30c9\u306b\u884c\u5217\u306e\u30a2\u30c9\u30ec\u30b9\u3068\u304b\u30b5\u30a4\u30ba\u3068\u304b\u305d\u3046\u3044\u3063\u305f\u5024\u3092\u7f6e\u304f\u3053\u3068\u304c\u51fa\u6765\u307e\u3059\u3002\u4eca\u56de\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u914d\u7f6e\u3057\u307e\u3057\u305f\u3002\u03b1\\alpha\u3068\u03b2\\beta\u306f\u30a2\u30c9\u30ec\u30b9coef_addr\u306b\u7f6e\u304d\u307e\u3057\u305f\u3002Uniforms Cache\u3092\u4f7f\u3063\u3066\u8aad\u3080\u3053\u3068\u304c\u51fa\u6765\u307e\u3059\u3002\n\nk-loop\u3067\u306fiadd(r2, r2, r3)\u306eZ\u30d5\u30e9\u30b0\u3092\u30c1\u30a7\u30c3\u30af\u3059\u308b\u306e\u3067\u3001\u7b2c1\u6210\u5206\u4ee5\u5916\u304c0\u306b\u306a\u308b\u3053\u3068\u306e\u306a\u3044\u69d8\u306b\u6ce8\u610f\u3057\u307e\u3059\u3002(\u5148\u65e5\u306f\u8aa4\u3063\u3066\u03b1\\alpha\u3068\u03b2\\beta\u3092\u76f4\u306b\u7f6e\u3044\u3066\u3057\u307e\u3044\u3001\u03b1=0.0\\alpha=0.0\u3082\u3057\u304f\u306f\u03b2=0.0\\beta=0.0\u306e\u6642\u306bk-loop\u304c\u6b63\u3057\u304f\u56de\u3089\u306a\u3044\u3068\u3044\u3046\u30d0\u30b0\u3092\u57cb\u3081\u8fbc\u3093\u3067\u3057\u307e\u3044\u307e\u3057\u305f\u3002)\n\u30ec\u30b8\u30b9\u30bf\u30d5\u30a1\u30a4\u30ebB\u306e\u30a2\u30c9\u30ec\u30b937(\u79c1\u306e\u30e9\u30a4\u30d6\u30e9\u30ea\u3067\u306fbroadcast\u3068\u3044\u3046\u540d\u524d)\u306b\u5024\u3092\u66f8\u304d\u8fbc\u3080\u3068\u6210\u52060\u306e\u5024\u304c16\u6210\u5206\u3059\u3079\u3066\u306bbroadcast\u3055\u308c\u307e\u3059(\u30ea\u30d5\u30a1\u30ec\u30f3\u30b9\u30ac\u30a4\u30c9P38)\u3002\u3053\u308c\u3068\u6210\u5206\u3092\u56de\u8ee2\u3055\u305b\u308bvector rotation\u547d\u4ee4\u3092\u4f7f\u3046\u3068\u7279\u5b9a\u306e\u6210\u5206\u3060\u3051\u30921\u547d\u4ee4(\u3057\u304b\u3082\u4e57\u7b97\u5668\u306e\u307f)\u3067\u53d6\u308a\u51fa\u3059\u4e8b\u304c\u51fa\u6765\u307e\u3059\u306e\u3067\u3001\u3053\u306e\u683c\u7d0d\u65b9\u6cd5\u306b\u3088\u308b\u30da\u30ca\u30eb\u30c6\u30a3\u306f\u5c0f\u3055\u3044\u3067\u3059\u3002\n\u4f8b\u3048\u3070\u3001r2\u306e5\u756a\u76ee\u306e\u6210\u5206\u3092\u53d6\u308a\u51fa\u3057\u305f\u3051\u308c\u3070\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u3057\u307e\u3059\u3002\n    ...                        # \u4e00\u3064\u524d\u306e\u547d\u4ee4\u3067\u306fr2\u306b\u30a2\u30af\u30bb\u30b9\u3057\u3066\u306f\u3044\u3051\u306a\u3044\n    rotate(broadcast, r2, -5)\n    mov(r0, r5)                # \u7d50\u679c\u306f\u7279\u6b8a\u30a2\u30ad\u30e5\u30e0\u30ec\u30fc\u30bfr5\u306b\u5165\u308b\u3002\n\nvector rotation\u306f\u30a4\u30ec\u30ae\u30e5\u30e9\u30fc\u306a\u9806\u756a\u3067\u30d1\u30a4\u30d7\u30e9\u30a4\u30f3\u306b\u30a2\u30af\u30bb\u30b9\u3057\u307e\u3059\u304b\u3089\u3001\u4ed6\u306e\u547d\u4ee4\u3068\u7570\u306a\u308arotate\u306e\u524d\u306b\u5f85\u3061\u6642\u9593\u304c\u5fc5\u8981\u3067\u3059\u3002\n\u30d9\u30af\u30c8\u30eb\u30ec\u30b8\u30b9\u30bf\u306b\u8a70\u3081\u8fbc\u3080\u4ee5\u5916\u3060\u3068\n\n\u4e0a\u3067\u3084\u3063\u305f\u3088\u3046\u306bUniforms Cache\u306eBase Address\u3060\u3051\u8a18\u61b6\u3057\u3066\u304a\u304d\u3001\u5fc5\u8981\u306b\u306a\u3063\u305f\u6642\u306buniform\u304b\u3089\u8aad\u3080\u3002\n\u30d7\u30ed\u30b0\u30e9\u30e0\u3092\u5b9f\u884c\u524d\u306b\u66f8\u304d\u63db\u3048\u3066\u3001\u547d\u4ee4\u306e\u5373\u5024\u90e8\u5206\u306b\u57cb\u3081\u8fbc\u3093\u3067\u3057\u307e\u3046\u3002\n\u8a08\u7b97\u3057\u3066\u4f5c\u308c\u308b\u3082\u306e\u306f\u305d\u3046\u3059\u308b\u3002\n\n\u306a\u3069\u306e\u5de5\u592b\u304c\u51fa\u6765\u307e\u3059\u3002\u305f\u307e\u306b\u3057\u304b\u4f7f\u7528\u3057\u306a\u3044\u5024\u306e\u70ba\u306b\u30ec\u30b8\u30b9\u30bf\u3092\u4f7f\u3046\u306e\u306f\u3082\u3063\u305f\u3044\u306a\u3044\u306e\u3067\u3001\u3053\u3046\u3044\u3063\u305f\u52aa\u529b\u3092\u3057\u307e\u3057\u3087\u3046\u3002\n\n\u884c\u5217C\u3078\u306e\u8db3\u3057\u3053\u307f\n\u03b1AB+\u03b2C\\alpha AB + \\beta C \u306eABAB\u306e\u90e8\u5206\u306e\u8a08\u7b97\u304c\u51fa\u6765\u308b\u3088\u3046\u306b\u306a\u3063\u305f\u306e\u3067\u3001\u6b21\u306f\u03b1(\u22ef)+\u03b2C\\alpha(\\cdots)+\\beta C\u306e\u90e8\u5206\u306e\u8a08\u7b97\u3067\u3059\u3002Host\u306b\u66f8\u304d\u623b\u3059\u5fc5\u8981\u304c\u3042\u308b\u306e\u3067VPM\u306b\u7f6e\u304f\u3053\u3068\u306b\u3057\u307e\u3059\u3002(TMU\u3067load\u3057\u3001VPM\u306b\u66f8\u304d\u8fbc\u3080\u3068\u3044\u3046\u624b\u3082\u3042\u308a\u305d\u3046\u3067\u3059\u3002\u3069\u3063\u3061\u304c\u826f\u3044\u304b\u306f\u307e\u3060\u5206\u304b\u308a\u307e\u305b\u3093\u3002)\nVPM\u306e\u30b5\u30a4\u30ba\u306f64x16\u3067\u3059\u3002\u3001\u4e0a\u3067\u8a08\u7b97\u3057\u305f\u3082\u306e\u304c\u3061\u3087\u3046\u3069\u53ce\u307e\u308a\u307e\u3059\u3002\nHost memory\u3001VPM\u9593\u306fDMA\u3067\u8ee2\u9001\u3057\u307e\u3059\u3002\u4e00\u5ea6\u306b16\u672c\u306e\u30d9\u30af\u30c8\u30eb\u3092\u8ee2\u9001\u3067\u304d\u308b\u306e\u306716x16\u306e\u30d6\u30ed\u30c3\u30af\u306b\u5206\u3051\u30664\u56de\u8ee2\u9001\u3057\u307e\u3059\u3002\n\u884c\u5217\u306fHost memory\u306b\u306fRow-major\u3067\u683c\u7d0d\u3055\u308c\u3066\u3044\u307e\u3059\u304b\u3089\u3001Horizontal mode\u3067\u8ee2\u9001\u3057\u305f\u65b9\u304c\u3001\u591a\u5206\u901f\u3044\u3093\u3058\u3083\u306a\u3044\u304b\u3068\u601d\u3044\u307e\u3059\u3002\u30db\u30f3\u30c8\u304b\u3069\u3046\u304b\u306f\u77e5\u308a\u307e\u305b\u3093\u3002\u4e00\u65b9\u3001QPU\u3067\u306f\u5217\u30d9\u30af\u30c8\u30eb\u5358\u4f4d\u3067\u30c7\u30fc\u30bf\u3092\u6301\u3063\u3066\u3044\u307e\u3059\u304b\u3089\u3001VPM, QPU\u9593\u306fVertical mode\u3067\u3084\u308a\u53d6\u308a\u3057\u307e\u3059\u3002\n\nDMA\u306f\u304b\u306a\u308a\u6642\u9593\u304c\u639b\u304b\u308b\u306f\u305a\u306a\u306e\u3067\u3001\u5f85\u3061\u6642\u9593\u3092\u7121\u99c4\u306b\u3057\u306a\u3044\u3088\u3046\u306b1\u3064\u3081\u306e\u30d6\u30ed\u30c3\u30af\u306e\u8ee2\u9001\u306f\u5148\u307b\u3069\u30bd\u30d5\u30c8\u30a6\u30a7\u30a2\u30d1\u30a4\u30d7\u30e9\u30a4\u30cb\u30f3\u30b0\u3092\u3057\u3066\u306f\u307f\u51fa\u3057\u305f\u6240\u3068\u91cd\u306d\u307e\u3059\u300263\u547d\u4ee4(=252\u30af\u30ed\u30c3\u30af)\u5206\u306e\u5f85\u3061\u6642\u9593\u3092\u6709\u52b9\u306b\u4f7f\u3048\u307e\u3059\u3002\n    # \u884c\u5217C\u306eload\u7528\u30b9\u30c8\u30e9\u30a4\u30c9\u3092\u30bb\u30c3\u30c8\u3002\u3053\u308c\u306f\u5b9a\u6570\u306a\u306e\u3067\u30d7\u30ed\u30b0\u30e9\u30e0\u306e\u4e00\u756a\u6700\u521d\u306b\u4e00\u56de\u3060\u3051\u3084\u308c\u3070\u3088\u3044\u3002\n    rotate(broadcast, r2, -C_STRIDE_IDX)\n    setup_dma_load_stride(r5, tmp_reg=r1)\n\n    # \u884c\u5217C\u306estore\u7528\u30b9\u30c8\u30e9\u30a4\u30c9\u3092\u30bb\u30c3\u30c8\u3002\u3053\u308c\u3082\u30d7\u30ed\u30b0\u30e9\u30e0\u306e\u4e00\u756a\u6700\u521d\u306b\u4e00\u56de\u3084\u308c\u3070\u3088\u3044\u3002\n    ldi(r1, 4*16)\n    isub(r1, r5, r1) # \u3053\u306e\u5f15\u304d\u7b97\u304c\u5fc5\u8981\u306a\u7406\u7531\u306f\u30ea\u30d5\u30a1\u30ec\u30f3\u30b9\u30ac\u30a4\u30c9\u306eTable35\u3092\u53c2\u7167\u3002\n    setup_dma_store_stride(r1)\n\n    ... \u7701\u7565\n\n    # (\u5148\u307b\u3069\u306e\u30eb\u30fc\u30d7(k-loop)\u3092\u629c\u3051\u305f\u6240\u3002)\n\n    # \u6700\u521d\u306e\u30d6\u30ed\u30c3\u30af\u306eload\u3092\u767a\u884c\n    setup_dma_load(mode='32bit horizontal', Y=0, nrows=16, mpitch=0)\n    rotate(broadcast, r2, -C_BASE_IDX)\n    start_dma_load(r5).mov(r3, r5)          # C\u306e\u30d9\u30fc\u30b9\u30a2\u30c9\u30ec\u30b9\u3092\u899a\u3048\u3066\u304a\u304f\u3002\n\n    # \u2193 \u30bd\u30d5\u30c8\u30a6\u30a7\u30a2\u30d1\u30a4\u30d7\u30e9\u30a4\u30cb\u30f3\u30b0\u306b\u3088\u3063\u3066k-loop\u304b\u3089\u306f\u307f\u51fa\u3057\u305f\u8a08\u7b97\u3067\u3001\u901a\u4fe1\u3092\u51fa\u6765\u308b\u3060\u3051\u96a0\u853d\u3059\u308b\u3002\n\n    fadd(ra1,  ra1,  r0).fmul(r0, r4, uniform)\n    fadd(rb1,  rb1,  r0).fmul(r0, r4, uniform)\n\n    ... # \u7701\u7565\n\n    fadd(ra31, ra31, r0).fmul(r0, r4, uniform)\n    fadd(rb31, rb31, r0)\n\n    wait_dma_load() # \u3053\u3053\u3067DMA\u306e\u5b8c\u4e86\u3092\u5f85\u3064\u3002\n\n\n\u8ee2\u9001\u6642\u9593\u3092\u96a0\u853d\u3059\u308b\u306b\u306f\u3082\u3046\u4e00\u3064\u65b9\u6cd5\u304c\u3042\u308a\u307e\u3059\u3002\u5404QPU\u306f2\u3064\u306e\u30cf\u30fc\u30c9\u30a6\u30a7\u30a2\u30b9\u30ec\u30c3\u30c9\u3092\u8d70\u3089\u305b\u308b\u4e8b\u304c\u51fa\u6765\u308b\u306e\u3067\u3001\u4ea4\u4e92\u306b\u4e0a\u624b\u304f\u5207\u308a\u66ff\u3048\u308c\u3070\u901a\u4fe1\u3092\u96a0\u853d\u3057\u3066\u6f14\u7b97\u5668\u3092\u30d5\u30eb\u7a3c\u50cd\u3055\u305b\u308b\u4e8b\u304c\u51fa\u6765\u307e\u3059\u3002\n\n\u3044\u308d\u3044\u308d\u306a\u30d1\u30e9\u30e1\u30fc\u30bf\u304c\u307e\u3060\u4e0d\u660e\u306a\u72b6\u614b\u3067\u3084\u3063\u3066\u3044\u308b\u306e\u3067\u3001\u3069\u3046\u3059\u308b\u306e\u304c\u30d9\u30b9\u30c8\u304b\u306f\u5b9f\u9a13\u3057\u3066\u307f\u306a\u3051\u308c\u3070\u5206\u304b\u308a\u307e\u305b\u3093\u3002\u305f\u3060\u3001\u30b9\u30ec\u30c3\u30c9\u5316\u3059\u308b\u3068\u5404\u30b9\u30ec\u30c3\u30c9\u304c\u4f7f\u3048\u308b\u30ec\u30b8\u30b9\u30bf\u306f\u534a\u5206\u306b\u6e1b\u308a\u3001\u6700\u5185\u30eb\u30fc\u30d7\u306e\u52b9\u7387\u304c\u5c11\u3057\u4e0b\u304c\u308a\u307e\u3059\u3002\u30b9\u30ec\u30c3\u30c9\u5207\u308a\u66ff\u3048\u306e\u30aa\u30fc\u30d0\u30fc\u30d8\u30c3\u30c9\u3082\u3042\u308a\u307e\u3059\u304b\u3089\u3001\u30b7\u30f3\u30b0\u30eb\u30b9\u30ec\u30c3\u30c9\u3067\u4e0a\u624b\u304f\u3084\u308c\u308b\u306a\u3089\u3070\u305d\u306e\u65b9\u304c\u826f\u3044\u306f\u305a\u3067\u3059\u3002\n1\u30d6\u30ed\u30c3\u30af\u3092load\u3057\u305f\u3089\u3001\u6b21\u306e\u30d6\u30ed\u30c3\u30af\u306eload\u3092\u5148\u306b\u767a\u884c\u3057\u3066\u304b\u3089\u03b1(\u22ef)+\u03b2C\\alpha(\\cdots)+\\beta C\u306e\u8a08\u7b97\u3092\u884c\u3044\u307e\u3059\u3002\u639b\u3051\u7b97\u304c2\u56de\u3067\u8db3\u3057\u7b97\u304c1\u56de\u3067\u3059\u304b\u3089\u3001\u52a0\u7b97\u5668\u304c1\u56de\u5206\u4f59\u308a\u307e\u3059\u3002\u3053\u306e\u9699\u9593\u306b\u6b21\u306e\u30a4\u30c6\u30ec\u30fc\u30b7\u30e7\u30f3\u306e\u70ba\u306b\u5217\u30d9\u30af\u30c8\u30eb\u30920\u521d\u671f\u5316\u3059\u308b\u51e6\u7406\u3092\u7a81\u3063\u8fbc\u307f\u307e\u3059\u3002\n    # alpha, beta\u3092\u8aad\u3080\u70ba\u306buniforms cache\u3092\u8a2d\u5b9a\n    rotate(r0, r2, -COEF_ADDR_IDX)\n    mov(uniforms_address, r0)\n\n    # 2\u3064\u3081\u306e\u30d6\u30ed\u30c3\u30af\u306e\u30ed\u30fc\u30c9\u3092\u767a\u884c\n    setup_dma_load(mode='32bit horizontal', Y=16, X=0, nrows=16, mpitch=0)\n    ldi(r0, 4*16)\n    iadd(vpm_ld_addr, r3, r0)\n\n    # 1\u3064\u3081\u306e\u30d6\u30ed\u30c3\u30af\u306b\u5bfe\u3059\u308bVPM\u30a2\u30af\u30bb\u30b9\u3092\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\n    setup_vpm_read(mode='32bit vertical', Y=0, X=0, nrows=16)\n    setup_vpm_write(mode='32bit vertical', Y=0, X=0)\n\n    # alpha, beta\u3092\u53d6\u308a\u51fa\u3059\u3002\n    mov(r1, uniform)        # r1=alpha\n    mov(broadcast, uniform) # r5=beta\n\n    # 1\u3064\u3081\u306e\u30d6\u30ed\u30c3\u30af\u306e\u8db3\u3057\u3053\u307f\n    fmul(ra0, ra0, r1)                    # AB\u306e\u4e00\u5217\u306balpha\u3092\u639b\u3051\u308b\u3002\n    fmul(r0, vpm, r5)                     # C\u306e\u4e00\u5217\u306bbeta\u3092\u639b\u3051\u308b\u3002\n    fadd(vpm, ra0, r0).fmul(rb0, rb0, r1) # \u5de6: \u8db3\u3057\u3066vpm\u306b\u66f8\u304d\u623b\u3059\u3002  \u53f3: \u6b21\u306e\u5217\u306e\u8a08\u7b97\n    mov(ra0, 0.0)     .fmul(r0, vpm, r5)  # \u5de6: \u6b21\u306e\u30a4\u30c6\u30ec\u30fc\u30b7\u30e7\u30f3\u306e\u70ba\u306bra0\u3092\u521d\u671f\u5316\u3002 \u53f3: \u6b21\u306e\u5217\u306e\u8a08\u7b97\n    ... # \u7701\u7565\n\n\n\u3053\u3093\u306a\u611f\u3058\u3067\u8a08\u7b97\u3068\u8ee2\u9001\u3092\u4ea4\u4e92\u306b\u8a70\u3081\u8fbc\u307f\u307e\u3059\u3002\n\u4ee5\u4e0a\u3067\u300116x64\u306e\u90e8\u5206\u884c\u5217\u306e\u8a08\u7b97\u304c\u5b8c\u4e86\u3057\u307e\u3057\u305f\u3002\n\n\u6b21\u56de\u306b\u7d9a\u304f\u3002\n\u3059\u3054\u304f\u9577\u304f\u306a\u3063\u3066\u3057\u307e\u3063\u305f\u306e\u3067\u3001Advent Calendar\u3092\u3082\u3046\u4e00\u65e5\u4f7f\u308f\u305b\u3066\u3082\u3089\u3063\u3066\u7d9a\u304d\u3092\u66f8\u304d\u307e\u3059\u3002\n\u6b21\u306f\n\n\u5916\u5074\u306ei-\u30eb\u30fc\u30d7,j-\u30eb\u30fc\u30d7\u3092\u66f8\u304d\u307e\u3059\u3002\n12\u500b\u306eQPU\u3092\u4f7f\u3063\u3066\u4e26\u5217\u5b9f\u884c\u3057\u307e\u3059\u3002\n\u3053\u306e\u969b\u306e\u540c\u671f\u51e6\u7406\u306b\u3064\u3044\u3066\u8aac\u660e\u3057\u307e\u3059\u3002\n\u30d9\u30f3\u30c1\u30de\u30fc\u30af\u3092\u53d6\u308a\u307e\u3059\u3002\u901f\u304f\u306a\u3063\u3066\u3044\u308b\u3068\u826f\u3044\u306a\uff5e\u3002\n\n[Raspberry Pi Advent Calendar 2015](http://qiita.com/advent-calendar/2015/raspberrypi)\u306e\u6295\u7a3f\u8a18\u4e8b\u3067\u3059\u3002\u5148\u65e5[PyVideoCore](https://github.com/nineties/py-videocore)\u3068\u3044\u3046Raspberry Pi\u3067GPGPU\u3092\u884c\u3046\u70ba\u306ePython\u30e9\u30a4\u30d6\u30e9\u30ea\u3092\u958b\u767a\u3057\u307e\u3057\u305f\u3002\u3053\u308c\u3092\u4f7f\u3063\u3066\u5358\u7cbe\u5ea6\u306e\u884c\u5217\u4e57\u7b97(sgemm)\u3092\u984c\u6750\u306b\u3001GPGPU\u306e\u30c1\u30e5\u30fc\u30c8\u30ea\u30a2\u30eb\u3092\u66f8\u3053\u3046\u3068\u601d\u3044\u307e\u3059\u3002\u81ea\u5206\u7528\u306e\u8a18\u9332\u3082\u517c\u306d\u3066\u3044\u308b\u306e\u3067\u7121\u99c4\u306b\u9577\u3044\u3067\u3059\u3002\u3059\u307f\u307e\u305b\u3093\u3002\n\n# \u304d\u3063\u304b\u3051\nRaspi\u306eGPU\u306b\u3064\u3044\u3066\u8abf\u3079\u3066\u3044\u305f\u3068\u304d\u306b\u4ed6\u306e\u65b9\u304c\u66f8\u3044\u305fsgemm\u5b9f\u88c5\u3092\u898b\u3064\u3051\u307e\u3057\u305f\u3002\n\n- https://github.com/jetpacapp/pi-gemm/\n\n\u3053\u308c\u306e\u30b5\u30f3\u30d7\u30eb\u3092\u8a66\u3057\u3066\u307f\u305f\u3068\u3053\u308d\u300196x363\u884c\u5217\u3068363x3025\u884c\u5217\u306e\u7a4d\u304c\u5927\u4f530.27\u79d2\u307b\u3069\u3068\u306e\u7d50\u679c\u304c\u51fa\u307e\u3059\u3002\u3053\u306e\u8a08\u7b97\u3067\u306f\u7d042\u5104\u56de\u306e\u6d6e\u52d5\u5c0f\u6570\u70b9\u6570\u6f14\u7b97(105996000\u56de\u306e\u4e57\u7b97\u3068105415200\u56de\u306e\u52a0\u7b97)\u304c\u884c\u308f\u308c\u308b\u306e\u3067\u3001783Mflops\u304f\u3089\u3044\u306e\u6027\u80fd\u3068\u306a\u308a\u307e\u3059\u3002CBLAS\u306esgemm\u3067\u540c\u3058\u8a08\u7b97\u3092\u3059\u308b\u306815.4\u79d2\u304f\u3089\u3044\u3068\u306e\u7d50\u679c\u304c\u51fa\u3066\u3001\u3053\u3061\u3089\u306f13.7Mflops\u3067\u3059\u304b\u308960\u500d\u8fd1\u304f\u306e\u9ad8\u901f\u5316\u3092\u9054\u6210\u3057\u3066\u3044\u308b\u3068\u3044\u3046\u3053\u3068\u306b\u306a\u308a\u307e\u3059\u3002\n\n\u3053\u306e\u7d50\u679c\u306f\u4e00\u898b\u3059\u3054\u305d\u3046\u3067\u3059\u304c\u3001[Raspi GPU\u306e\u7406\u8ad6\u6027\u80fd\u306f24Gflops](http://qiita.com/9_ties/items/2e85318989170f967e4b)\u3067\u3059\u304b\u3089\u5b9f\u306f**\u7406\u8ad6\u6027\u80fd\u306e3%**\u3057\u304b\u51fa\u305b\u3066\u3044\u307e\u305b\u3093\u3002\u4ed6\u306e\u4eba\u304c\u66f8\u3044\u305fFFT(\u516c\u5f0f\u30b5\u30f3\u30d7\u30eb\u3068\u3057\u3066raspbian\u306b\u53ce\u9332)\u3084\u307e\u305f\u5225\u306e\u4eba\u304c\u66f8\u3044\u305fSHA256\u3068\u304b\u3082\u898b\u305f\u3093\u3067\u3059\u304c\u3069\u308c\u3082\u5168\u7136\u6027\u80fd\u304c\u51fa\u3066\u3044\u307e\u305b\u3093\u3067\u3057\u305f\u3002\u73fe\u72b6Rasperry Pi\u3068GPGPU\u3067\u691c\u7d22\u3059\u308b\u3068\u3053\u308c\u3089\u306e\u60c5\u5831\u6e90\u3057\u304b\u30d2\u30c3\u30c8\u3057\u306a\u3044\u306e\u3067\u3001\u3053\u308c\u306f\u307e\u305a\u3044\u3068\u601d\u3044\u672c\u8a18\u4e8b\u3092\u66f8\u304f\u3053\u3068\u306b\u3057\u307e\u3057\u305f\u3002\n\n\u884c\u5217\u4e57\u7b97\u304c\u65e9\u304f\u306a\u3063\u3066\u4f55\u304c\u5b09\u3057\u3044\u306e\u304b\u3068\u601d\u3046\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u304c\u3001\u4f8b\u3048\u3070\u4e0a\u306e\u4eba\u306fpi-gemm\u3092\u4f7f\u3063\u3066DeepBeliefNetwork\u3068\u3044\u3046\u30e2\u30c7\u30eb\u3092\u4f7f\u3063\u3066\u306e\u7269\u4f53\u8a8d\u8b58\u306e\u9ad8\u901f\u5316\u3092\u3057\u3066\u3044\u307e\u3059\u3002\n\n- http://petewarden.com/2014/08/07/how-to-optimize-raspberry-pi-code-using-its-gpu/\n\n\u3053\u308c\u306f\u3001\u5165\u529b\u753b\u50cf\u306b\u4f55\u304c\u5199\u3063\u3066\u3044\u308b\u304b\u3092\u8b58\u5225\u3059\u308b\u3082\u306e\u3067\u3059\u304c\u3001sgemm\u3092GPU\u5316\u3059\u308b\u3053\u3068\u30673.3\u79d2\u3067\u8b58\u5225\u304c\u51fa\u6765\u308b\u3088\u3046\u306b\u306a\u3063\u305f\u305d\u3046\u3067\u3059(\u4e0a\u3067\u8a00\u3063\u305f\u3088\u3046\u306b\u3053\u308c\u306f\u307e\u3060\u307e\u3060\u901f\u304f\u51fa\u6765\u308b\u306f\u305a\u3067\u3059)\u3002\u4ed6\u306b\u3082gemm\u304c\u901f\u304f\u306a\u308b\u3068\u5b09\u3057\u3044\u5fdc\u7528\u304c\u305f\u304f\u3055\u3093\u3042\u308a\u307e\u3059\u3002\n\n<img src=\"https://github.com/jetpacapp/DeepBeliefSDK/blob/gh-pages/source/data/dog.jpg?raw=true\" height=\"200px\">  \u2192  <img src=\"http://petewarden.files.wordpress.com/2014/08/screen-shot-2014-08-07-at-1-49-33-pm.png\" height=\"200px\">\n\n# \u5b66\u751f\u306b\u304a\u52e7\u3081\n\nRaspberry Pi\u306eGPU\u306fVideoCore IV\u3068\u3044\u3046\u3082\u306e\u3067\u3059\u3002nVidia\u306eGPU\u306e\u30b3\u30fc\u30c9\u3092\u30a2\u30bb\u30f3\u30d6\u30ea\u3067\u66f8\u3044\u305f\u4e8b\u306e\u3042\u308b\u4eba\u306f\u305d\u3093\u306a\u306b\u3044\u306a\u3044\u3068\u601d\u3044\u307e\u3059\u304c\u3001VideoCore\u306e\u5834\u5408\u306f\u30a2\u30bb\u30f3\u30d6\u30ea\u3067<s>\u66f8\u304b\u306a\u3051\u308c\u3070\u306a\u3089\u306a\u3044</s>\u66f8\u304f\u3053\u3068\u304c\u51fa\u6765\u307e\u3059\u3002\u3069\u306e\u4f1a\u793e\u306eGPU\u3082\u57fa\u672c\u7684\u306a\u8003\u3048\u65b9\u306f\u540c\u3058\u3067\u3059\u3057\u3001VideoCore\u306f\u5b8c\u5168\u306a\u30ea\u30d5\u30a1\u30ec\u30f3\u30b9\u30ac\u30a4\u30c9\u304c\u516c\u958b\u3055\u308c\u3066\u3044\u308b\u3057\u3001\u30dc\u30fc\u30c9\u304c\u5b89\u3044\u3067\u3059\u3057\u3001\u60c5\u5831\u7cfb\u5b66\u751f\u306e\u4fee\u884c\u7528\u306bRaspi\u7d50\u69cb\u826f\u3044\u3093\u3058\u3083\u306a\u3044\u3067\u3057\u3087\u3046\u304b\u3002\n\n# \u30ea\u30d5\u30a1\u30ec\u30f3\u30b9\u30ac\u30a4\u30c9\n\nVideoCore\u306f16-way\u306eSIMD\u30d7\u30ed\u30bb\u30c3\u30b5(QPU)12\u500b\u304b\u3089\u306a\u308a\u307e\u3059\u3002\u3042\u3068\u306f\u8aac\u660e\u3092\u7701\u7565\u3057\u307e\u3059\u306e\u3067\u3001\u4ee5\u4e0b\u306e\u30ea\u30d5\u30a1\u30ec\u30f3\u30b9\u30ac\u30a4\u30c9\u3092\u8aad\u3093\u3067\u304f\u3060\u3055\u3044\u3002\u7a74\u304c\u958b\u304f\u307b\u3069\u8aad\u3093\u3067\u304f\u3060\u3055\u3044\u3002\n\n- http://www.broadcom.com/docs/support/videocore/VideoCoreIV-AG100-R.pdf\n\n\n# \u4eca\u56de\u4f5c\u308b\u3082\u306e\u3002\n\u4e0e\u3048\u3089\u308c\u305f$p\\times q$ \u884c\u5217 $A$, $q\\times r$ \u884c\u5217 $B$, $p\\times r$ \u884c\u5217 $C$, \u30b9\u30ab\u30e9 $\\alpha,\\beta$\u306b\u5bfe\u3057\u3066\n\n$\\alpha AB + \\beta C$ \n\n\u3092\u8a08\u7b97\u3059\u308b\u3068\u3044\u3046\u3082\u306e\u3092\u4f5c\u308a\u307e\u3059\u3002 \u7d50\u679c\u306f$C$\u306b\u4e0a\u66f8\u304d\u3057\u307e\u3059\u3002\n\n\u3044\u308f\u3086\u308bsgemm\u3067\u3059\u304c\u3001\u4eca\u56de\u306f\u5927\u5206\u5358\u7d14\u5316\u3057\u305f\u3082\u306e\u3092\u4f5c\u308a\u307e\u3059\u3002\n\n- \u884c\u5217\u306e\u8ee2\u7f6e\u7b49\u306e\u30aa\u30d7\u30b7\u30e7\u30f3\u306f\u4f5c\u308a\u307e\u305b\u3093\u3002\n- Row-major\u306e\u5834\u5408\u306e\u307f\u3092\u8003\u3048\u307e\u3059\u3002\n- GPU\u5074\u3067\u306f$p$\u304c16\u306e\u500d\u6570\u3001$r$\u304c64\u306e\u500d\u6570\u3067\u3042\u308b\u4e8b\u3001\u3092\u8981\u8acb\u3057\u7aef\u6570\u51e6\u7406\u3092\u7701\u304d\u307e\u3059\u3002Host\u5074\u3067\u5171\u6709\u30e1\u30e2\u30ea\u306b\u884c\u5217\u3092\u914d\u7f6e\u3059\u308b\u969b\u306b\u3001\u7aef\u6570\u90e8\u5206\u306e\u8abf\u6574\u3092\u3059\u308b\u4e8b\u306b\u3057\u307e\u3059\u3002\n- $q$\u306f2\u4ee5\u4e0a\u3067\u3042\u308b\u3053\u3068\u3092\u8981\u8acb\u3057\u307e\u3059\u3002\n\n# \u901f\u304f\u3059\u308b\u70ba\u306b\u5fc5\u8981\u306a\u4e8b\n\u6027\u80fd\u3092\u51fa\u3059\u3068\u3044\u3046\u554f\u984c\u306f\u3001\u3064\u307e\u308a**\u5982\u4f55\u306b\u6f14\u7b97\u5668\u3092\u4f11\u307e\u305b\u305a\u306b\u8d70\u3089\u305b\u7d9a\u3051\u3089\u308c\u308b\u304b\uff1f**\u3068\u3044\u3046\u554f\u984c\u3067\u3059\u3002\u305d\u306e\u70ba\u306b\u306f\u3001\u51fa\u6765\u308b\u3060\u3051\u6f14\u7b97\u5668\u3092\u6570\u5024\u8a08\u7b97\u306e\u70ba\u306b\u4f7f\u3046\u4e8b\u3001\u30e1\u30e2\u30ea\u30a2\u30af\u30bb\u30b9\u3001\u6761\u4ef6\u5206\u5c90\u3001\u540c\u671f\u51e6\u7406\u306a\u3069\u3067\u306e\u5f85\u3061\u6642\u9593\u3092\u6e1b\u3089\u3059\u4e8b\u3001\u5f85\u3061\u6642\u9593\u304c\u767a\u751f\u3059\u308b\u5834\u5408\u306b\u306f\u30d1\u30a4\u30d7\u30e9\u30a4\u30f3\u5316\u3084\u30b9\u30ec\u30c3\u30c9\u5316\u3067\u305d\u308c\u3092\u96a0\u853d\u3059\u308b\u4e8b\u306a\u3069\u304c\u91cd\u8981\u306b\u306a\u308a\u307e\u3059\u3002\n\npi-gemm\u306e\u30a2\u30eb\u30b4\u30ea\u30ba\u30e0\u3092\u4f8b\u306b\u3053\u308c\u3092\u898b\u3066\u307f\u307e\u3057\u3087\u3046\u3002pi-gemm\u3067\u306f\u5185\u7a4d\u8a08\u7b97\u306e\u90e8\u5206(\u4ee5\u4e0b\u306ek-loop)\u3092SIMD\u3067\u30d9\u30af\u30c8\u30eb\u5316\u3059\u308b\u3068\u3044\u3046\u65b9\u6cd5\u3092\u63a1\u3063\u3066\u3044\u307e\u3059\u3002CUDA\u306e\u30c1\u30e5\u30fc\u30c8\u30ea\u30a2\u30eb\u3068\u304b\u3067\u3082\u540c\u69d8\u306e\u30b5\u30f3\u30d7\u30eb\u3092\u898b\u304b\u3051\u308b\u4e8b\u304c\u3042\u308a\u307e\u3059\u3002\n\n```\nfor i=0..p-1 {\n   for j=0..r-1 {\n      v = 0\n      for k=0..q-1 {\n         v += A[i, k]*B[k, j]\n      }\n      C[i, j] = \u03b1 * v + \u03b2 * C[i, j]\n   }\n}\n```\n\n\u3053\u306e\u5834\u5408\n\n1. \u9577\u305516\u306e\u30d9\u30af\u30c8\u30eb2\u3064A[i,k:k+16], B[k:k+16, j]\u3092load\u3059\u308b\u3002\n2. 2\u3064\u306e\u30d9\u30af\u30c8\u30eb\u3092\u639b\u3051\u3066\u3001\u30a2\u30ad\u30e5\u30e0\u30ec\u30fc\u30bf\u306b\u8db3\u3057\u8fbc\u3080\u3002\n\n\u3068\u3044\u3046\u8a08\u7b97\u3092\u7e70\u308a\u8fd4\u3059\u4e8b\u306b\u306a\u308a\u307e\u3059\u3002(\u3044\u308d\u3044\u308d\u5de5\u592b\u3067\u304d\u307e\u3059\u304c)\u3053\u308c\u306f\u3042\u307e\u308a\u826f\u304f\u306a\u3044\u65b9\u6cd5\u3060\u3068\u601d\u3044\u307e\u3059\u3002\nRaspi\u306eGPU\u306f\u52a0\u7b97\u3068\u4e57\u7b97\u3092\u540c\u6642\u306b\u5b9f\u884c\u3067\u304d\u308b\u306e\u3067\u30b9\u30c6\u30c3\u30d72\u306f\u5b9f\u8cea1\u547d\u4ee4\u3067\u7d42\u308f\u308a\u307e\u3059\u3002\u30b9\u30c6\u30c3\u30d71\u306f\u3053\u308c\u3088\u308a\u305a\u3063\u3068\u9577\u3044\u6642\u9593\u304c\u639b\u304b\u308a\u307e\u3059\u3002\u3053\u306e\u9593\u6f14\u7b97\u5668\u306f\u4f11\u3093\u3067\u3044\u307e\u3059\u3002\u307e\u305f\u3001\u305f\u3063\u305f16\u500b\u306e\u6570\u5024\u3092\u6f14\u7b97\u3059\u308b\u6bce\u306b\u6761\u4ef6\u5206\u5c90\u304c\u3042\u308a\u307e\u3059\u3002\u3053\u3053\u3067\u3082\u6f14\u7b97\u5668\u306f\u4f11\u3093\u3067\u3044\u307e\u3059\u3002\n\n\u5b9f\u969b\u306e\u30b3\u30fc\u30c9\u3092\u5f15\u7528\u3059\u308b\u3068\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002main_loop_l\u5185\u90e8\u3067\u5b9f\u969b\u306e\u6570\u5024\u8a08\u7b97\u3092\u884c\u3063\u3066\u3044\u308b\u3068\u3053\u308d\u306ffmul\u3068fadd1\u56de\u305a\u3064\u306e\u307f\u3067\u3059\u3002\u540c\u6642\u5b9f\u884c\u3067\u304d\u308b\u304b\u3089\u5b9f\u8cea1\u547d\u4ee4\u5206\u3067\u3059\u3002\u305d\u306e\u4ed6\u306f\u3059\u3079\u3066\u30a2\u30c9\u30ec\u30b9\u3084\u30ab\u30a6\u30f3\u30bf\u306e\u8a08\u7b97\u3067\u3059\u3002\u30eb\u30fc\u30d7\u518514\u547d\u4ee4\u306e\u5185\u3001\u6570\u5024\u6f14\u7b97\u306e\u70ba\u306b\u306f\u6f14\u7b97\u5668\u3092\u4e00\u56de\u3057\u304b\u4f7f\u3048\u3066\u3044\u307e\u305b\u3093\u30021/14=7.1%\u3067\u3059\u304b\u3089\u3001\u5148\u307b\u3069\u306e3%\u7a0b\u5ea6\u3068\u3044\u3046\u6570\u5b57\u306b\u306a\u308a\u307e\u3059\u3002\n\n```\nmain_loop_l:\n\n# We read a pending A result from the queue, and then immediately fire off the\n# next memory fetch, to get the maximum concurrency.\nor.ldtmu0 ra39, ra39, ra39; nop\nadd raTmu0S, rCurrentA, rAccum1; nop\nor rA0to15, r4, 0; nop\n\n# Now we pull the values from B, and fire off the next fetch.\nadd.ldtmu1 rCurrentA, rCurrentA, rAccum2; nop\nadd raTmu1S, rCurrentB, rAccum1; nop\nadd rCurrentB, rCurrentB, rAccum2; fmul rAccum0, rA0to15, r4\nfadd rTotal, rTotal, rAccum0; nop\n\nsub rL, rL, -16; nop\n\nsub rAccum0, rK, 15; nop\nsub ra39, rL, rAccum0; nop\nbrr.ns ra39, main_loop_l\nNOP\nNOP\nNOP\n```\n\n\n\n\n\n\u6f14\u7b97\u5668\u3060\u3051\u3067\u306a\u304f\u30d9\u30af\u30c8\u30eb\u30ec\u30b8\u30b9\u30bf\u3092\u4e0a\u624b\u304f\u4f7f\u3046\u3068\u3044\u3046\u4e8b\u3082\u5927\u5207\u3067\u3059\u3002\u30ec\u30b8\u30b9\u30bf\u3092\u4e0a\u624b\u304f\u4f7f\u308f\u306a\u3044\u3068\u3001\u5fc5\u7136\u7684\u306b\u30e1\u30e2\u30ea\u306b\u7f6e\u304f\u30c7\u30fc\u30bf\u304c\u5897\u3048\u307e\u3059\u3002\u30e1\u30e2\u30ea\u306f\u30ec\u30b8\u30b9\u30bf\u3088\u308a\u5727\u5012\u7684\u306b\u9045\u3044\u3067\u3059\u3002\n\n\u30d9\u30af\u30c8\u30eb\u8a08\u7b97\u6a5f\u306f\u30ec\u30b8\u30b9\u30bf\u3092\u6ca2\u5c71\u642d\u8f09\u3057\u3066\u3044\u308b\u306e\u304c\u7279\u5fb4\u3067\u3001VideoCore\u306e\u5834\u5408\u306f\u5404QPU\u6bce\u306b\u9577\u305516\u306e\u30ec\u30b8\u30b9\u30bf\u304c64\u672c\u3042\u308a\u307e\u3059\u3002\u3064\u307e\u308a\u3001\u5404QPU\u4e0a\u306b\u6700\u592716x64\u306e\u884c\u5217(1024\u6210\u5206)\u3092\u7f6e\u304f\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002QPU\u306f12\u500b\u3042\u308b\u306e\u3067\u5168\u4f53\u3067\u306f\u6700\u592712288\u500b\u306e\u5b9f\u6570\u5024\u3092\u540c\u6642\u306b\u30ec\u30b8\u30b9\u30bf\u4e0a\u306b\u7f6e\u304f\u4e8b\u304c\u51fa\u6765\u307e\u3059\u3002pi-gemm\u306e\u30b3\u30fc\u30c9\u3092\u898b\u3066\u307f\u308b\u306864\u672c\u4e2d1\u672c\u3060\u3051(`rTotal`)\u304c\u5b9f\u6570\u5024\u7528\u3067\u4ed6\u306f\u30a2\u30c9\u30ec\u30b9\u3068\u304b\u30eb\u30fc\u30d7\u306e\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u7528\u3067\u3059\u3002\u3053\u308c\u306f\u975e\u5e38\u306b\u3082\u3063\u305f\u3044\u306a\u3044\u3067\u3059\u3002\n\n64\u672c\u306e\u30ec\u30b8\u30b9\u30bf(ra0,ra1,...,ra31\u3068rb0,rb1,...,rb31)\u306e\u4ed6\u306b\u3001\u66f4\u306b\u9ad8\u901f\u306a\u30a2\u30ad\u30e5\u30e0\u30ec\u30fc\u30bf\u304c4\u672c(r0,r1,r2,r3)\u3042\u308a\u307e\u3059\u3002\u30ec\u30b8\u30b9\u30bf\u3078\u66f8\u304d\u8fbc\u307e\u308c\u305f\u5024\u306f\u6b21\u306e\u6b21\u306e\u547d\u4ee4\u307e\u3067\u8aad\u3081\u307e\u305b\u3093\u304c\u3001\u30a2\u30ad\u30e5\u30e0\u30ec\u30fc\u30bf\u3060\u3068\u6b21\u306e\u547d\u4ee4\u3067\u8aad\u3081\u307e\u3059\u30024\u672c\u3057\u304b\u306a\u3044\u306e\u3067\u7121\u99c4\u9063\u3044\u3057\u306a\u3044\u3088\u3046\u306b\u3057\u307e\u3057\u3087\u3046\u3002\n\n```py\n   mov(ra0, 1)       # \u3053\u3053\u3067\u306e\u66f8\u304d\u8fbc\u307e\u308c\u305f\u5024\u306f\n   nop()\n   iadd(ra0, ra0, 2) # \u3053\u3053\u3067\u521d\u3081\u3066\u8aad\u3081\u308b\n   \n   mov(r0, 1)        # \u30a2\u30ad\u30e5\u30e0\u30ec\u30fc\u30bf\u3060\u3068\n   isub(r0, r0, 1)   # \u6b21\u306e\u547d\u4ee4\u3067\u8aad\u3081\u308b\n```\n\n\u4ee5\u5f8c\u3001\u3053\u308c\u3089\u306e\u4e8b\u306b\u6c17\u3092\u4ed8\u3051\u306a\u304c\u3089\u30013\u91cd\u30eb\u30fc\u30d7\u306e\u4e00\u756a\u5185\u5074\u306e\u30b3\u30fc\u30c9\u3092\u66f8\u3044\u3066\u3044\u304d\u307e\u3059\u3002\u7d9a\u304d\u306f\u6b21\u56de\u3067\u3059\u3002\n\u6700\u5185\u30eb\u30fc\u30d7\u306f\u6700\u3082\u5b9f\u884c\u3055\u308c\u308b\u56de\u6570\u304c\u591a\u3044\u306e\u3067\u3001\u6f14\u7b97\u306e\u5bc6\u5ea6\u304c\u91cd\u8981\u3067\u3059\u3002\n\n# \u4eca\u56de\u306e\u65b9\u91dd\n**64\u672c\u306e\u30ec\u30b8\u30b9\u30bf\u5168\u90e8**\u3092\u884c\u5217\u3092\u683c\u7d0d\u3059\u308b\u70ba\u306b\u4f7f\u3044\u307e\u3059\u3002\u884c\u5217\u306e\u30a2\u30c9\u30ec\u30b9\u3001\u30e1\u30e2\u30ea\u30a2\u30af\u30bb\u30b9\u306e\u30b9\u30c8\u30e9\u30a4\u30c9\u3001\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u3001\u884c\u5217\u306e\u30b5\u30a4\u30ba$p,q,r$\u7b49\u306e\u30c7\u30fc\u30bf\u3092\u7f6e\u304f\u30ec\u30b8\u30b9\u30bf\u304c\u7121\u304f\u306a\u308a\u307e\u3059\u304c\u9811\u5f35\u308c\u3070\u4f55\u3068\u304b\u306a\u308a\u307e\u3059\u3002\n\n\u4e0a\u3067\u8aac\u660e\u3057\u305f\u69d8\u306b\u30012\u3064\u306e\u30d9\u30af\u30c8\u30eb$\\mathbf{a},\\mathbf{b}$\u3092load\u3057\u305f\u6642\u306b\u5982\u4f55\u306b\u305f\u304f\u3055\u3093\u306e\u6709\u52b9\u306a\u6f14\u7b97\u3092\u884c\u3048\u308b\u304b\u304c\u30dd\u30a4\u30f3\u30c8\u3067\u3059\u3002\u9577\u3055$n$\u306e\u30d9\u30af\u30c8\u30eb\u306e\u5185\u7a4d\n\n$$ \\mathbf{a}^T\\mathbf{b}=a_0b_0+a_1b_1+\\cdots+a_{n-1}b_{n-1} $$\n\n\u3067\u306f\u30012n\u30ef\u30fc\u30c9\u306eload\u306b\u5bfe\u3057\u3066$n$\u56de\u306e\u4e57\u7b97\u3068$n-1$\u56de\u306e\u52a0\u7b97\u3068\u3053\u308c\u3092\u6b21\u3005\u8db3\u3057\u3053\u3080\u70ba\u306e\u52a0\u7b97\u304c1\u56de\u3067\u8a08$2n$\u56de\u3057\u304b\u6f14\u7b97\u304c\u3067\u304d\u307e\u305b\u3093\u3002\u305d\u3053\u3067\u5185\u7a4d\u3067\u306f\u306a\u304f\u9577\u3055$m$\u306e\u30d9\u30af\u30c8\u30eb\u3068$n$\u306e\u30d9\u30af\u30c8\u30eb\u306e\u76f4\u7a4d\n\n```math\n\\mathbf{a}\\mathbf{b}^T = \\begin{pmatrix}\na_0b_0 & a_0b_1 & \\cdots & a_0b_{n-1} \\\\\na_1b_0 & a_1b_1 & \\cdots & a_1b_{n-1} \\\\\n\\vdots & \\vdots & \\ddots & \\vdots \\\\\na_{m-1}b_0 & a_{m-1}b_1 & \\cdots & a_{m-1}b_{n-1}\n\\end{pmatrix}\n```\n\n\u304c\u8a08\u7b97\u5358\u4f4d\u3068\u306a\u308b\u3088\u3046\u306b\u30a2\u30eb\u30b4\u30ea\u30ba\u30e0\u3092\u4f5c\u308a\u307e\u3059\u3002\u3053\u3061\u3089\u3067\u306f$m+n$\u30ef\u30fc\u30c9\u306eload\u306b\u5bfe\u3057\u3066\u3001$mn$\u56de\u306e\u4e57\u7b97\u3068\u8db3\u3057\u3053\u307f\u306e\u70ba\u306e\u52a0\u7b97\u304c$mn$\u56de\u3001\u8a08$2mn$\u56de\u306e\u6f14\u7b97\u304c\u53ef\u80fd\u3067\u3059\u3002\n\n64\u500b\u306e\u30ec\u30b8\u30b9\u30bf\u306e\u4f7f\u3044\u65b9\u3067\u3059\u304c\u3001\u4e0b\u56f3\u306e\u3088\u3046\u306b16x64\u306e\u884c\u5217\u3092\u5358\u4f4d\u306b\u3057\u3066\u3001\u4e57\u7b97\u7d50\u679c\u306e\u5404\u5217\u30d9\u30af\u30c8\u30eb\u3092\u30ec\u30b8\u30b9\u30bf\u306b\u683c\u7d0d\u3059\u308b\u4e8b\u306b\u3057\u307e\u3059\u300232x32\u3068\u304b64x16\u306b\u3057\u306a\u304b\u3063\u305f\u7406\u7531\u306f\u5f8c\u3067\u8aac\u660e\u3057\u307e\u3059\u3002\n<div align=\"center\"> <img src=\"https://qiita-image-store.s3.amazonaws.com/0/83682/30acef75-932f-4401-5521-d9578e0188a1.png\"></div>\n\n\u3053\u306e\u639b\u3051\u7b97\u3092\u3069\u3046\u306b\u304b\u3057\u3066\u3084\u3063\u3066\u3001\u6b21\u3005\u8db3\u3057\u3053\u3093\u3067\u3044\u3051\u3070\u4e0b\u56f3\u306e\u90e8\u5206\u884c\u5217\u306e\u7a4d\u304c\u8a08\u7b97\u3067\u304d\u307e\u3059\u3002\n\n<div align=\"center\"><img src=\"https://qiita-image-store.s3.amazonaws.com/0/83682/d2c007ab-f036-0c53-51c7-d763c7c84c31.png\"></div>\n\n\u3053\u308c\u306f\u4f1d\u7d71\u7684\u306a\u65b9\u6cd5\u3067\u3001\u753b\u50cf\u51e6\u7406\u5c02\u7528\u306eGPU\u3067\u306f\u03b1\u30d6\u30ec\u30f3\u30c9\u3068\u52a0\u7b97\u5408\u6210\u3092\u4f7f\u3063\u3066\u8a08\u7b97\u3057\u3066\u3044\u305f\u307f\u305f\u3044\u3067\u3059\u3002\n\n# \u30e1\u30e2\u30ea\n\n\u4e0b\u56f3\u306fVideoCore\u306e\u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3\u56f3\u3067\u3059\u3002Uniform Cache\u304bTexture and Memory Lookup Unit(TMU)\u304bVertex Pipe Memory(VPM)\u3092\u4f7f\u3063\u3066Host-GPU\u9593\u3067\u30c7\u30fc\u30bf\u3092\u3084\u308a\u53d6\u308a\u3057\u307e\u3059\u3002\n> <img width=\"506\" alt=\"VideoCoreArch.png\" src=\"https://qiita-image-store.s3.amazonaws.com/0/83682/932c00c7-7225-53b0-c391-2f42de566117.png\">\n[VideoCore IV 3D Architecture Reference Guide\u3088\u308a\u5f15\u7528](https://www.broadcom.com/docs/support/videocore/VideoCoreIV-AG100-R.pdf)\n\nUniform\u3068TMU\u306f\u8aad\u307f\u8fbc\u307f\u5c02\u7528\u3067\u3059\u3002\u3053\u308c\u3089\u306fVPM\u3088\u308aload\u304c\u901f\u305d\u3046\u3067\u3059\u3002\u30d9\u30f3\u30c1\u30de\u30fc\u30af\u306f\u3068\u3063\u3066\u3044\u306a\u3044\u306e\u3067\u5177\u4f53\u7684\u306a\u30d1\u30e9\u30e1\u30fc\u30bf\u306f\u307e\u3060\u5206\u304b\u308a\u307e\u305b\u3093\u3002\n\nUniform\u306f32bit\u306e\u30c7\u30fc\u30bf\u3092\u30b7\u30fc\u30b1\u30f3\u30b7\u30e3\u30eb\u306b\u8aad\u3080\u70ba\u306b\u4f7f\u3044\u307e\u3059\u300216\u500b\u306e\u6210\u5206\u5168\u3066\u306b\u540c\u3058\u5024\u304c\u8aad\u307f\u8fbc\u307e\u308c\u307e\u3059\u3002\u3064\u307e\u308a\u30b9\u30ab\u30e9\u30fc\u306eload\u306b\u9069\u3057\u3066\u3044\u307e\u3059\u3002TMU\u304b\u3089\u306f\u4e00\u56de\u306eload\u306732bit\u306e\u30c7\u30fc\u30bf16\u500b\u3092\u53d6\u308a\u8fbc\u3080\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\u3064\u307e\u308a\u30d9\u30af\u30c8\u30eb\u306eload\u306b\u9069\u3057\u3066\u3044\u307e\u3059\u3002(\u5404\u30b9\u30e9\u30a4\u30b9\u4e8b\u306b\u6700\u59272\u3064\u306eTMU\u3001TMU0\u3068TMU1\u3092\u7f6e\u304f\u3053\u3068\u304c\u51fa\u6765\u307e\u3059\u3002)\n\n\u5f93\u3044\u307e\u3057\u3066\u3001\u4ee5\u4e0b\u306e\u76f4\u7a4d\u3092\u8a08\u7b97\u3059\u308b\u306b\u306f\u30d9\u30af\u30c8\u30eb$\\mathbf{a}$\u306fTMU0\u3067load\u3057\u3001\u30b9\u30ab\u30e9\u30fc$b_i$\u306fUniform Cache\u3067load\u3059\u308b\u3088\u3046\u306b\u3059\u308b\u306e\u304c\u826f\u3044\u3060\u308d\u3046\u3068\u3044\u3046\u4e8b\u306b\u306a\u308a\u307e\u3059\u3002Row-major\u3067\u3059\u304b\u3089$b_0,b_1,\\ldots,b_{63}$\u306f\u9023\u7d9a\u30a2\u30c9\u30ec\u30b9\u306b\u914d\u7f6e\u3055\u308c\u3066\u304a\u308a\u3001Uniform cache\u3067\u6b21\u3005load\u3059\u308b\u4e8b\u304c\u51fa\u6765\u307e\u3059\u3002\u5148\u307b\u306916x64\u306b\u3057\u305f\u306e\u306f\u3053\u306e\u30b7\u30fc\u30b1\u30f3\u30b7\u30e3\u30eb\u306aload\u3092\u51fa\u6765\u308b\u3060\u3051\u9577\u304f\u53d6\u308a\u305f\u304b\u3063\u305f\u304b\u3089\u3067\u3059\u3002\n\n$$\\mathbf{a}\\mathbf{b}^T = (b_0\\mathbf{a}, b_1\\mathbf{a}, \\ldots, b_{63}\\mathbf{a})$$\n\n# \u6700\u5185\u30eb\u30fc\u30d7\u306e\u5b9f\u88c5\n\n\u3053\u3053\u307e\u3067\u306e\u8a08\u7b97\u3092\u5b9f\u969b\u306b\u30b3\u30fc\u30c9\u306b\u3057\u3066\u307f\u307e\u3059\u3002\u307e\u305a\u7d20\u6734\u306b\u66f8\u304f\u3068\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\u5b9f\u6570\u5024\u4ee5\u5916\u306e\u5909\u6570(A_cur\u3084A_base\u306a\u3069)\u3092\u3069\u3053\u306b\u7f6e\u304f\u304b\u306f\u4e00\u65e6\u8003\u3048\u307e\u305b\u3093\u3002\n\n```py\n    # \u5404\u5217\u30d9\u30af\u30c8\u30eb\u30920\u3067\u521d\u671f\u5316\n    mov(ra0, 0.0)\n    mov(rb0, 0.0)\n    ... # \u7701\u7565\n    mov(rb31, 0.0)\n\n    iadd(A_cur, A_base, A_offs)     # \u30d9\u30af\u30c8\u30eba\u306e\u30a2\u30c9\u30ec\u30b9\u3092\u521d\u671f\u5316\n    mov(B_cur, B_base)              # \u30d9\u30af\u30c8\u30ebb\u306e\u30a2\u30c9\u30ec\u30b9\u3092\u521d\u671f\u5316\n    mov(k, q)                       # \u30eb\u30fc\u30d7\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u3092\u521d\u671f\u5316\n\n    L.k_loop\n\n    mov(tmu0_s, A_cur)              # \u30d9\u30af\u30c8\u30eba\u306e\u5404\u6210\u5206\u306e\u30a2\u30c9\u30ec\u30b9\u3092\u30bb\u30c3\u30c8\n    mov(uniforms_address, B_cur)    # \u30d9\u30af\u30c8\u30ebb\u306e\u5148\u982d\u30a2\u30c9\u30ec\u30b9\u3092\u30bb\u30c3\u30c8\n    iadd(A_cur, A_cur, 4)           # \u30a2\u30c9\u30ec\u30b9\u3092\u30a4\u30f3\u30af\u30ea\u30e1\u30f3\u30c8\n    iadd(B_cur, B_cur, B_stride)    # \u30a2\u30c9\u30ec\u30b9\u3092\u30a4\u30f3\u30af\u30ea\u30e1\u30f3\u30c8\n\n    nop(sig='load tmu0')    # TMU0\u304b\u3089\u30d9\u30af\u30c8\u30eba\u3092load(\u7d50\u679c\u306f\u30ec\u30b8\u30b9\u30bfr4\u306b\u5165\u308b)\n\n    fmul(r0, r4, uniform)   # uniform\u304b\u3089b[0]\u3092load\u3057\u3001a\u3068\u639b\u3051\u308b\n    fadd(ra0, ra0, r0)      # \u7b2c0\u5217\u306b\u8db3\u3057\u3053\u3080\n\n    fmul(r0, r4, uniform)   # uniform\u304b\u3089b[1]\u3092load\u3057\u3001a\u3068\u639b\u3051\u308b\n    fadd(rb0, rb0, r0)      # \u7b2c1\u5217\u306b\u8db3\u3057\u3053\u3080\n\n    fmul(r0, r4, uniform)   # uniform\u304b\u3089b[2]\u3092load\u3057\u3001a\u3068\u639b\u3051\u308b\n    fadd(ra1, ra1, r0)      # \u7b2c2\u5217\u306b\u8db3\u3057\u3053\u3080\n\n    ... # \u7701\u7565\n\n    fmul(r0, r4, uniform)   # uniform\u304b\u3089b[62]\u3092load\u3057\u3001a\u3068\u639b\u3051\u308b\n    fadd(ra31, ra31, r0)    # \u7b2c62\u5217\u306b\u8db3\u3057\u3053\u3080\n\n    fmul(r0, r4, uniform)   # uniform\u304b\u3089b[63]\u3092load\u3057\u3001a\u3068\u639b\u3051\u308b\n    fadd(rb31, rb31, r0)    # \u7b2c63\u5217\u306b\u8db3\u3057\u3053\u3080\n\n    isub(k, k, 1)           # \u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u30921\u6e1b\u3089\u3059\n    jzc(L.k_loop)           # 0\u3058\u3083\u306a\u3044\u306a\u3089\u3070\u30eb\u30fc\u30d7\u6700\u521d\u306b\u623b\u308b(Jump if Z-flags are Clear)\n    nop()                   # delay slot\n    nop()                   # delay slot\n    nop()                   # delay slot\n```\n\u3053\u306e\u6642\u70b9\u3067\u306floop body\u304c138\u547d\u4ee4\u3067\u3001\u5b9f\u8cea64\u547d\u4ee4\u5206\u306e\u6570\u5024\u8a08\u7b97\u3092\u3057\u3066\u3044\u308b\u306e\u306764/138=46.4%\u306e\u52b9\u7387\u3067\u6f14\u7b97\u5668\u3092\u4f7f\u3063\u3066\u3044\u307e\u3059\u3002\u69d8\u3005\u306a\u30c6\u30af\u30cb\u30c3\u30af\u3092\u4f7f\u3063\u3066\u3053\u308c\u3092\u6700\u9069\u5316\u3057\u3066\u3044\u304d\u307e\u3059\u3002\n\n\u307e\u305a\u3001\u540c\u6642\u306b\u5b9f\u884c\u3067\u304d\u308b\u52a0\u7b97\u3068\u4e57\u7b97\u3092\u8a70\u3081\u3066\u3044\u304d\u307e\u3059\u3002\n\n```py\n    L.k_loop\n\n    mov(tmu0_s, A_cur)              # \u30d9\u30af\u30c8\u30eba\u306e\u5404\u6210\u5206\u306e\u30a2\u30c9\u30ec\u30b9\u3092\u30bb\u30c3\u30c8\n    mov(uniforms_address, B_cur)    # \u30d9\u30af\u30c8\u30ebb\u306e\u5148\u982d\u30a2\u30c9\u30ec\u30b9\u3092\u30bb\u30c3\u30c8\n    iadd(A_cur, A_cur, 4)           # \u30a2\u30c9\u30ec\u30b9\u3092\u30a4\u30f3\u30af\u30ea\u30e1\u30f3\u30c8\n    iadd(B_cur, B_cur, B_stride)    # \u30a2\u30c9\u30ec\u30b9\u3092\u30a4\u30f3\u30af\u30ea\u30e1\u30f3\u30c8\n\n    nop(sig='load tmu0')    # TMU0\u304b\u3089\u30d9\u30af\u30c8\u30eba\u3092load(\u7d50\u679c\u306f\u30ec\u30b8\u30b9\u30bfr4\u306b\u5165\u308b)\n\n    fmul(r0, r4, uniform)\n    fadd(ra0, ra0, r0).fmul(r0, r4, uniform)\n    fadd(rb0, rb0, r0).fmul(r0, r4, uniform)\n    fadd(ra1, ra1, r0).fmul(r0, r4, uniform)\n\n    ... # \u7701\u7565\n\n    fadd(rb30, rb30, r0).fmul(r0, r4, uniform)\n    fadd(ra31, ra31, r0).fmul(r0, r4, uniform)\n    fadd(rb31, rb31, r0)\n\n    isub(k, k, 1)           # \u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u30921\u6e1b\u3089\u3059\n    jzc(L.k_loop)           # 0\u3058\u3083\u306a\u3044\u306a\u3089\u3070\u30eb\u30fc\u30d7\u6700\u521d\u306b\u623b\u308b(Jump if Z-flags are Clear)\n    nop()                   # delay slot\n    nop()                   # delay slot\n    nop()                   # delay slot\n```\n\n\u6761\u4ef6\u5206\u5c90`jzc`\u306e\u5f8c\u306e3\u547d\u4ee4\u306fdelay slot\u3068\u3044\u3063\u3066\u3001`jzc`\u3092\u767a\u884c\u3057\u3066\u304b\u3089\u5b9f\u969b\u306e\u30b8\u30e3\u30f3\u30d7\u304c\u884c\u308f\u308c\u308b\u307e\u3067\u306b\u4f59\u5206\u306a3\u547d\u4ee4\u304c\u5fc5\u305a\u5b9f\u884c\u3055\u308c\u307e\u3059\u3002\u3053\u3053\u3067\u3082\u6f14\u7b97\u3092\u884c\u3046\u4e8b\u304c\u51fa\u6765\u307e\u3059\u3002\n\n```py\n    L.k_loop\n\n    mov(tmu0_s, A_cur)              # \u30d9\u30af\u30c8\u30eba\u306e\u5404\u6210\u5206\u306e\u30a2\u30c9\u30ec\u30b9\u3092\u30bb\u30c3\u30c8\n    mov(uniforms_address, B_cur)    # \u30d9\u30af\u30c8\u30ebb\u306e\u5148\u982d\u30a2\u30c9\u30ec\u30b9\u3092\u30bb\u30c3\u30c8\n    iadd(A_cur, A_cur, 4)           # \u30a2\u30c9\u30ec\u30b9\u3092\u30a4\u30f3\u30af\u30ea\u30e1\u30f3\u30c8\n    iadd(B_cur, B_cur, B_stride)    # \u30a2\u30c9\u30ec\u30b9\u3092\u30a4\u30f3\u30af\u30ea\u30e1\u30f3\u30c8\n\n    nop(sig='load tmu0')    # TMU0\u304b\u3089\u30d9\u30af\u30c8\u30eba\u3092load(\u7d50\u679c\u306f\u30ec\u30b8\u30b9\u30bfr4\u306b\u5165\u308b)\n\n    fmul(r0, r4, uniform)\n    fadd(ra0, ra0, r0).fmul(r0, r4, uniform)\n    fadd(rb0, rb0, r0).fmul(r0, r4, uniform)\n    fadd(ra1, ra1, r0).fmul(r0, r4, uniform)\n\n    ... # \u7701\u7565\n\n    fadd(ra30, ra30, r0).fmul(r0, r4, uniform)\n\n    isub(k, k, 1)           # \u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u30921\u6e1b\u3089\u3059\n    jzc(L.k_loop)           # 0\u3058\u3083\u306a\u3044\u306a\u3089\u3070\u30eb\u30fc\u30d7\u6700\u521d\u306b\u623b\u308b(Jump if Z-flags are Clear)\n    fadd(rb30, rb30, r0).fmul(r0, r4, uniform) # delay slot\u3067\u5b9f\u884c\n    fadd(ra31, ra31, r0).fmul(r0, r4, uniform) # delay slot\u3067\u5b9f\u884c\n    fadd(rb31, rb31, r0)                       # delay slot\u3067\u5b9f\u884c\n```\n\u3053\u3053\u307e\u3067\u3067\u30eb\u30fc\u30d7\u5185\u90e872\u547d\u4ee4\u4e2d\u300164\u547d\u4ee4\u5206\u3092\u6570\u5024\u6f14\u7b97\u3067\u57cb\u3081\u308b\u4e8b\u304c\u51fa\u6765\u307e\u3057\u305f\u306e\u306764/72=88.9%\u306e\u52b9\u7387\u3067\u6f14\u7b97\u5668\u3092\u4f7f\u3048\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3057\u305f\u3002\n\n\u30a2\u30c9\u30ec\u30b9\u8a08\u7b97\u306e\u30b3\u30fc\u30c9\u3082\u6700\u9069\u5316\u3057\u307e\u3059\u3002\u3053\u3053\u306f\u3044\u308d\u3044\u308d\u3068\u5236\u7d04\u304c\u3042\u308a\u96e3\u3057\u3044\u3067\u3059\u3002\u307e\u305a\u3001\n\n> `uniforms_address`\u3078\u306e\u66f8\u304d\u8fbc\u307f\u5f8c2\u547d\u4ee4\u306f`uniform`\u306b\u30a2\u30af\u30bb\u30b9\u3057\u3066\u306f\u306a\u3089\u306a\u3044(\u30ea\u30d5\u30a1\u30ec\u30f3\u30b9\u30ac\u30a4\u30c9P22)\n\n\u3068\u3044\u3046\u306e\u304c\u3042\u308a\u307e\u3059\u3002\u307e\u305f\n\n1. `tmu0_s`\u3092\u30bb\u30c3\u30c8\n2. `'load tmu0`'\u30b7\u30b0\u30ca\u30eb\u3092\u767a\u884c\n3. `r4`\u3092read\n\n\u3068\u3044\u3046\u9806\u756a\u3092\u5d29\u3059\u4e8b\u306f\u51fa\u6765\u307e\u305b\u3093\u3002`A_cur`\u306e\u66f4\u65b0\u3068`tmu0_s`\u3078\u306e\u66f8\u304d\u8fbc\u307f\u306f\u540c\u6642\u306b\u306f\u884c\u3048\u307e\u305b\u3093\u3002\u30b7\u30b0\u30ca\u30eb\u306e\u767a\u884c\u306f\u4ed6\u306e\u6f14\u7b97\u306e\u3064\u3044\u3067\u306b\u767a\u884c\u3059\u308b\u4e8b\u304c\u51fa\u6765\u307e\u3059\u3002\u3053\u308c\u3089\u306e\u5236\u7d04\u3092\u5b88\u308a\u3064\u3064\u30d1\u30a4\u30d7\u30e9\u30a4\u30f3\u5316\u3057\u3066\u8a70\u3081\u8fbc\u307f\u307e\u3059\u3002\n\n```py\n\n    mov(uniforms_address, B_cur)    # \u6700\u521d\u306e\u4e00\u56de\u5206\u306f\u30eb\u30fc\u30d7\u306b\u5165\u308b\u524d\u306b\u3084\u308b\n    mov(tmu0_s, A_cur)\n    iadd(A_cur, A_cur, 4)\n    nop(sig='load tmu0')\n\n    L.k_loop\n\n    mov(tmu0_s, A_cur)\n    iadd(B_cur, B_cur, B_stride)\n\n    iadd(A_cur, A_cur, 4).fmul(r0, r4, uniform)\n    fadd(ra0, ra0, r0).fmul(r0, r4, uniform)\n    fadd(rb0, rb0, r0).fmul(r0, r4, uniform)\n    fadd(ra1, ra1, r0).fmul(r0, r4, uniform)\n\n    ... # \u7701\u7565\n\n    fadd(ra30, ra30, r0).fmul(r0, r4, uniform)\n\n    isub(k, k, 1)\n    jzc(L.k_loop)\n    fadd(rb30, rb30, r0).fmul(r0, r4, uniform)\n    fadd(ra31, ra31, r0).fmul(r0, r4, uniform)         # <- \u6700\u5f8c\u306euniform,r4\u3078\u306e\u30a2\u30af\u30bb\u30b9\n    fadd(rb31, rb31, r0, sig='load tmu0').mov(uniforms_address, B_cur)  # <- \u6b21\u306e\u30a4\u30c6\u30ec\u30fc\u30b7\u30e7\u30f3\u3092\u6e96\u5099\n```\n\n\u3053\u3053\u3067\u3001\u3061\u3087\u3063\u3068\u30c8\u30ea\u30c3\u30ad\u30fc\u306a\u6700\u9069\u5316\u3092\u884c\u3063\u3066`isub(k, k, 1)`\u3092\u6d88\u3057\u307e\u3059\u3002\u5909\u6570`k`\u306f\u30eb\u30fc\u30d7\u306e\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u3067\u3059\u304b\u3089\u30b9\u30ab\u30e9\u30fc\u3067\u3059\u3002\u305d\u308c\u304b\u3089`B_cur`\u306funiforms cache\u306e\u30d9\u30fc\u30b9\u30a2\u30c9\u30ec\u30b9\u3067\u3053\u308c\u3082\u30b9\u30ab\u30e9\u30fc\u3067\u3059\u3002\u5f93\u3063\u3066\u3001\u3053\u308c\u3089\u3092\u4e00\u3064\u306e\u30d9\u30af\u30c8\u30eb\u8a70\u3081\u8fbc\u3093\u3067\u3057\u307e\u3046\u4e8b\u304c\u51fa\u6765\u307e\u3059\u3002\u5177\u4f53\u7684\u306b\u306f\u3001\u30d9\u30af\u30c8\u30eb$\\mathbf{b}$\u306e\u30a2\u30c9\u30ec\u30b9\u3092`B_cur[0]`\u306b\u3001`k`\u3092`B_cur[1]`\u306b\u5165\u308c\u3001`B_stride[0]`\u306b\u30b9\u30c8\u30e9\u30a4\u30c9\u3001`B_stride[1]`\u306b`-1`\u3092\u5165\u308c\u307e\u3059\u3002\u3059\u308b\u3068`iadd(B_cur, B_cur, B_stride)`\u3067`isub(k, k, 1)`\u306e\u8a08\u7b97\u3082\u3067\u304d\u307e\u3059\u3002\n\n\u7279\u5b9a\u306e\u6210\u5206\u3078\u3060\u3051\u4ee3\u5165\u3092\u884c\u3046\u306b\u306f\u3001\u5404\u6210\u5206\u306b\u7570\u306a\u308b2bit\u5373\u5024\u3092\u4ee3\u5165\u51fa\u6765\u308bper-element load immediates\u547d\u4ee4\u3067\u30d5\u30e9\u30b0\u3092\u30bb\u30c3\u30c8\u3057\u3066\u3001\u6761\u4ef6\u3092\u6e80\u305f\u3059\u6210\u5206\u306e\u307f\u306b\u8a08\u7b97\u7d50\u679c\u3092\u4ee3\u5165\u3059\u308bconditional\u547d\u4ee4\u3092\u4f7f\u3044\u307e\u3059\u3002\u4ee5\u4e0b\u306f`B_stride[1]`\u306b\u3060\u3051-1\u3092\u4ee3\u5165\u3059\u308b\u4f8b\u3067\u3059\u3002\n\n```\n    ldi(null, [1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1], set_flags=True)\n    mov(B_stride, -1, cond='zs') # move if Z-flag is Set\n```\n\nUniform Cache\u306e\u30d9\u30fc\u30b9\u30a2\u30c9\u30ec\u30b9\u306b\u4ee3\u5165\u3059\u308b\u90e8\u5206\u3067\u306f\u3001\u7b2c0\u6210\u5206\u306e\u5024\u304c\u4f7f\u308f\u308c\u308b\u3068\u6c7a\u3081\u3089\u308c\u3066\u3044\u308b(\u30ea\u30d5\u30a1\u30ec\u30f3\u30b9\u30ac\u30a4\u30c9P22)\u306e\u3067\u3001\u7279\u5225\u306a\u51e6\u7406\u306f\u4e0d\u8981\u3067\u3059\u3002\n\n\n```\n    mov(uniforms_address, B_cur)  # B_cur[0]\u304c\u30bb\u30c3\u30c8\u3055\u308c\u308b\n```\n\n`jzc`\u306f16\u500b\u306e\u6210\u5206\u5168\u3066\u304c0\u3058\u3083\u306a\u3044\u3068\u304d\u306b\u30b8\u30e3\u30f3\u30d7\u3059\u308b\u3068\u3044\u3046\u547d\u4ee4\u3067\u3059\u3002`jzc`\u304c`iadd(B_cur, B_cur, B_stride)`\u3067\u30bb\u30c3\u30c8\u3055\u308c\u305f\u30d5\u30e9\u30b0\u3092\u53c2\u7167\u3067\u304d\u308b\u3088\u3046\u306b\u3001\u9593\u306e\u8a08\u7b97\u3067\u306f\u30d5\u30e9\u30b0\u3092\u30bb\u30c3\u30c8\u3057\u306a\u3044\u69d8\u306b\u3057\u307e\u3059\u3002\u5b9f\u969b\u306e\u30b3\u30fc\u30c9\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\n\n```py\n\n    # B_cur, B_stride\u3092\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u3059\u308b\u90e8\u5206\u306f\u7701\u7565\n\n    mov(uniforms_address, B_cur)    # \u6700\u521d\u306e\u4e00\u56de\u5206\u306f\u30eb\u30fc\u30d7\u306b\u5165\u308b\u524d\u306b\u3084\u308b\n    mov(tmu0_s, A_cur)\n    iadd(A_cur, A_cur, 4)\n    nop(sig='load tmu0')\n\n    L.k_loop\n\n    mov(tmu0_s, A_cur)\n    iadd(B_cur, B_cur, B_stride)\n\n    iadd(A_cur, A_cur, 4, set_flags=False).fmul(r0, r4, uniform)\n    fadd(ra0, ra0, r0, set_flags=False).fmul(r0, r4, uniform)\n    fadd(rb0, rb0, r0, set_flags=False).fmul(r0, r4, uniform)\n    fadd(ra1, ra1, r0, set_flags=False).fmul(r0, r4, uniform)\n\n    ... # \u7701\u7565\n\n    fadd(ra30, ra30, r0, set_flags=False).fmul(r0, r4, uniform)\n\n    jzc(L.k_loop)\n    fadd(rb30, rb30, r0).fmul(r0, r4, uniform)\n    fadd(ra31, ra31, r0).fmul(r0, r4, uniform)         # <- \u6700\u5f8c\u306euniform,r4\u3078\u306e\u30a2\u30af\u30bb\u30b9\n    fadd(rb31, rb31, r0, sig='load tmu0').mov(uniforms_address, B_cur)  # <- \u6b21\u306e\u30a4\u30c6\u30ec\u30fc\u30b7\u30e7\u30f3\u3092\u6e96\u5099\n```\n\n\u3053\u3053\u307e\u3067\u3067\u30eb\u30fc\u30d7\u5185\u90e8\u304c68\u547d\u4ee4\u307e\u3067\u524a\u308c\u307e\u3057\u305f\u306e\u3067\u3001\u6f14\u7b97\u5668\u306e\u4f7f\u7528\u52b9\u7387\u306f64/68=94.1%\u3067\u3059\u3002\n\n\u6700\u5f8c\u306b2\u547d\u4ee4\u4f7f\u3063\u3066\u3044\u308b\n\n```py\n    mov(tmu0_s, A_cur)\n    iadd(B_cur, B_cur, B_stride)\n```\n\n\u3092\n\n```py\n    iadd(B_cur, B_cur, B_stride).mov(tmu0_s, A_cur)\n```\n\n\u306b\u3057\u3066\u3082\u3046\u4e00\u547d\u4ee4\u524a\u308a\u305f\u3044\u3093\u3067\u3059\u304c\u3001\n\n> `uniforms_address`\u3078\u306e\u66f8\u304d\u8fbc\u307f\u5f8c2\u547d\u4ee4\u306f`uniform`\u306b\u30a2\u30af\u30bb\u30b9\u3057\u3066\u306f\u306a\u3089\u306a\u3044(\u30ea\u30d5\u30a1\u30ec\u30f3\u30b9\u30ac\u30a4\u30c9P22)\n\n\u306b\u5f15\u3063\u304b\u304b\u3063\u3066\u3057\u307e\u3044\u307e\u3059\u3002\u9014\u4e2d\u306bjump\u304c\u5165\u308b\u306e\u3067\u6c17\u306b\u3057\u306a\u304f\u3066\u3082\u826f\u3044\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u304c\u3001\u5ff5\u306e\u305f\u3081\u3053\u306e\u554f\u984c\u3092\u89e3\u6c7a\u3057\u307e\u3059\u3002\n\n```\n    L.k_loop\n\n    iadd(B_cur, B_cur, B_stride).mov(tmu0_s, A_cur)\n    iadd(A_cur, A_cur, 4, set_flags=False).fmul(r0, r4, uniform) # \u3053\u3053\u307e\u3067\u306e\u9593\u306b2\u547d\u4ee4\u5fc5\u8981\n\n    fadd(ra0, ra0, r0, set_flags=False).fmul(r0, r4, uniform)\n\n    ... # \u7701\u7565\n\n    fadd(ra30, ra30, r0).fmul(r0, r4, uniform)\n\n    jzc(L.k_loop)\n    fadd(rb30, rb30, r0).fmul(r0, r4, uniform)\n    fadd(ra31, ra31, r0).fmul(r0, r4, uniform)\n    fadd(rb31, rb31, r0, sig='load tmu0').mov(uniforms_address, B_cur)  #\u3000\u3053\u3053\u304b\u3089\n```\n\n\u8db3\u308a\u306a\u30441\u547d\u4ee4\u3092`jzc`\u3067\u88dc\u3044\u307e\u3059\u3002\u305d\u306e\u70ba\u306b**\u30bd\u30d5\u30c8\u30a6\u30a7\u30a2\u30d1\u30a4\u30d7\u30e9\u30a4\u30cb\u30f3\u30b0**\u3092\u3057\u3066\u3001\u30eb\u30fc\u30d7\u5168\u4f53\u30924\u547d\u4ee4\u305a\u3089\u3057\u307e\u3059\u3002(\u30ea\u30d5\u30a1\u30ec\u30f3\u30b9\u30ac\u30a4\u30c9\u3067\u306f\u8a18\u8ff0\u304c\u898b\u3064\u304b\u3089\u306a\u304b\u3063\u305f\u3093\u3067\u3059\u304c\u3001delay slot\u5185\u3067`mov(tmu0_s, A_cur)`\u3092\u5b9f\u884c\u3059\u308b\u3068\u6b63\u3057\u304f\u52d5\u304b\u306a\u304b\u3063\u305f\u70ba\u30013\u547d\u4ee4\u3067\u306f\u306a\u304f4\u547d\u4ee4\u305a\u3089\u3057\u3066\u3044\u307e\u3059\u3002)\n\n```\n    iadd(B_cur, B_cur, B_stride).mov(tmu0_s, A_cur)\n    iadd(A_cur, A_cur, 4, set_flags=False).fmul(r0, r4, uniform)\n    fadd(ra0, ra0, r0).fmul(r0, r4, uniform)\n    fadd(rb0, rb0, r0).fmul(r0, r4, uniform)\n\n    # \u2191\u306f\u307f\u51fa\u305f\u5206\n\n    L.k_loop\n\n    fadd(ra1, ra1, r0).fmul(r0, r4, uniform)\n\n    ... # \u7701\u7565\n\n    fadd(rb30, rb30, r0).fmul(r0, r4, uniform)\n    fadd(ra31, ra31, r0).fmul(r0, r4, uniform)\n    fadd(rb31, rb31, r0, sig='load tmu0').mov(uniforms_address, B_cur)  #\u3000\u3053\u3053\u304b\u3089\n    iadd(B_cur, B_cur, B_stride).mov(tmu0_s, A_cur)\n    jzc(L.k_loop)                                                # <- \u3053\u3044\u3064\u30671\u547d\u4ee4\u3092\u88dc\u3046\n    iadd(A_cur, A_cur, 4).fmul(r0, r4, uniform) # \u3053\u3053\u307e\u3067\u306e\u9593\u306b2\u547d\u4ee4\u5fc5\u8981\n    fadd(ra0, ra0, r0).fmul(r0, r4, uniform)\n    fadd(rb0, rb0, r0).fmul(r0, r4, uniform)\n\n    # \u2193\u306f\u307f\u51fa\u305f\u5206(\u3053\u3053\u3067\u30eb\u30fc\u30d7\u3092\u629c\u3051\u308b)\n\n    fadd(ra1, ra1, r0).fmul(r0, r4, uniform)\n    \n    ... # \u7701\u7565\n\n    fadd(ra31, ra31, r0).fmul(r0, r4, uniform)\n    fadd(rb31, rb31, r0)\n\n```\n\n\u4f55\u3092\u3084\u3063\u3066\u3044\u308b\u304b\u5206\u304b\u308a\u306b\u304f\u3044\u3068\u601d\u3046\u306e\u3067\u7d75\u3092\u63cf\u3044\u3066\u307f\u307e\u3057\u305f\u3002\n\n![path17806.png](https://qiita-image-store.s3.amazonaws.com/0/83682/81da5382-67cc-ac0a-5c2b-3e94a066c585.png)\n\n\n\u3053\u306e\u5909\u63db\u3092\u3059\u308b\u3068\u5c11\u306a\u304f\u3068\u30822\u30a4\u30c6\u30ec\u30fc\u30b7\u30e7\u30f3\u8d70\u3063\u3066\u3057\u307e\u3046\u306e\u3067$q\\geq 2$\u3067\u3042\u308b\u4e8b\u3092\u4e0a\u3067\u8981\u8acb\u3057\u3066\u3044\u307e\u3059\u3002\n\u307e\u305f\u3001\u3053\u306e\u5909\u63db\u306b\u3088\u3063\u3066`iadd(B_cur, B_cur, B_stride)`\u306e\u30bf\u30a4\u30df\u30f3\u30b0\u304c1\u30a4\u30c6\u30ec\u30fc\u30b7\u30e7\u30f3\u5206\u305a\u308c\u308b\u306e\u3067`k`\u306e\u521d\u671f\u5024\u30921\u3064\u305a\u3089\u3059\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\n\u4ee5\u4e0a\u3067\u6700\u5185\u30eb\u30fc\u30d7\u306f\u6982\u306d\u5b8c\u6210\u3067\u3059\u3002\u9014\u4e2d\u3092\u7701\u7565\u3057\u306a\u3044\u3067Loop body\u66f8\u3044\u3066\u307f\u308b\u3068\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u611f\u3058\u3067\u3059\u3002\u975e\u5e38\u306b\u9ad8\u3044\u5bc6\u5ea6\u3067\u6f14\u7b97\u5668\u3092\u4f7f\u3048\u3066\u3044\u308b\u4e8b\u304c\u5206\u304b\u308b\u3068\u601d\u3044\u307e\u3059\u3002\n\n```\n    L.k_loop\n\n    fadd(ra1,  ra1,  r0).fmul(r0, r4, uniform)\n    fadd(rb1,  rb1,  r0).fmul(r0, r4, uniform)\n    fadd(ra2,  ra2,  r0).fmul(r0, r4, uniform)\n    fadd(rb2,  rb2,  r0).fmul(r0, r4, uniform)\n    fadd(ra3,  ra3,  r0).fmul(r0, r4, uniform)\n    fadd(rb3,  rb3,  r0).fmul(r0, r4, uniform)\n    fadd(ra4,  ra4,  r0).fmul(r0, r4, uniform)\n    fadd(rb4,  rb4,  r0).fmul(r0, r4, uniform)\n    fadd(ra5,  ra5,  r0).fmul(r0, r4, uniform)\n    fadd(rb5,  rb5,  r0).fmul(r0, r4, uniform)\n    fadd(ra6,  ra6,  r0).fmul(r0, r4, uniform)\n    fadd(rb6,  rb6,  r0).fmul(r0, r4, uniform)\n    fadd(ra7,  ra7,  r0).fmul(r0, r4, uniform)\n    fadd(rb7,  rb7,  r0).fmul(r0, r4, uniform)\n    fadd(ra8,  ra8,  r0).fmul(r0, r4, uniform)\n    fadd(rb8,  rb8,  r0).fmul(r0, r4, uniform)\n    fadd(ra9,  ra9,  r0).fmul(r0, r4, uniform)\n    fadd(rb9,  rb9,  r0).fmul(r0, r4, uniform)\n    fadd(ra10, ra10, r0).fmul(r0, r4, uniform)\n    fadd(rb10, rb10, r0).fmul(r0, r4, uniform)\n    fadd(ra11, ra11, r0).fmul(r0, r4, uniform)\n    fadd(rb11, rb11, r0).fmul(r0, r4, uniform)\n    fadd(ra12, ra12, r0).fmul(r0, r4, uniform)\n    fadd(rb12, rb12, r0).fmul(r0, r4, uniform)\n    fadd(ra13, ra13, r0).fmul(r0, r4, uniform)\n    fadd(rb13, rb13, r0).fmul(r0, r4, uniform)\n    fadd(ra14, ra14, r0).fmul(r0, r4, uniform)\n    fadd(rb14, rb14, r0).fmul(r0, r4, uniform)\n    fadd(ra15, ra15, r0).fmul(r0, r4, uniform)\n    fadd(rb15, rb15, r0).fmul(r0, r4, uniform)\n    fadd(ra16, ra16, r0).fmul(r0, r4, uniform)\n    fadd(rb16, rb16, r0).fmul(r0, r4, uniform)\n    fadd(ra17, ra17, r0).fmul(r0, r4, uniform)\n    fadd(rb17, rb17, r0).fmul(r0, r4, uniform)\n    fadd(ra18, ra18, r0).fmul(r0, r4, uniform)\n    fadd(rb18, rb18, r0).fmul(r0, r4, uniform)\n    fadd(ra19, ra19, r0).fmul(r0, r4, uniform)\n    fadd(rb19, rb19, r0).fmul(r0, r4, uniform)\n    fadd(ra20, ra20, r0).fmul(r0, r4, uniform)\n    fadd(rb20, rb20, r0).fmul(r0, r4, uniform)\n    fadd(ra21, ra21, r0).fmul(r0, r4, uniform)\n    fadd(rb21, rb21, r0).fmul(r0, r4, uniform)\n    fadd(ra22, ra22, r0).fmul(r0, r4, uniform)\n    fadd(rb22, rb22, r0).fmul(r0, r4, uniform)\n    fadd(ra23, ra23, r0).fmul(r0, r4, uniform)\n    fadd(rb23, rb23, r0).fmul(r0, r4, uniform)\n    fadd(ra24, ra24, r0).fmul(r0, r4, uniform)\n    fadd(rb24, rb24, r0).fmul(r0, r4, uniform)\n    fadd(ra25, ra25, r0).fmul(r0, r4, uniform)\n    fadd(rb25, rb25, r0).fmul(r0, r4, uniform)\n    fadd(ra26, ra26, r0).fmul(r0, r4, uniform)\n    fadd(rb26, rb26, r0).fmul(r0, r4, uniform)\n    fadd(ra27, ra27, r0).fmul(r0, r4, uniform)\n    fadd(rb27, rb27, r0).fmul(r0, r4, uniform)\n    fadd(ra28, ra28, r0).fmul(r0, r4, uniform)\n    fadd(rb28, rb28, r0).fmul(r0, r4, uniform)\n    fadd(ra29, ra29, r0).fmul(r0, r4, uniform)\n    fadd(rb29, rb29, r0).fmul(r0, r4, uniform)\n    fadd(ra30, ra30, r0).fmul(r0, r4, uniform)\n    fadd(rb30, rb30, r0).fmul(r0, r4, uniform)\n    fadd(ra31, ra31, r0).fmul(r0, r4, uniform)\n    fadd(rb31, rb31, r0, sig='load tmu0').mov(uniforms_address, r2)\n    iadd(r2, r2, r3).mov(tmu0_s, r1)\n    jzc(L.k_loop)\n    iadd(r1, r1, 4).fmul(r0, r4, uniform)      # delay slot\n    fadd(ra0,  ra0,  r0).fmul(r0, r4, uniform) # delay slot\n    fadd(rb0,  rb0,  r0).fmul(r0, r4, uniform) # delay slot\n```\n\n\u307e\u3068\u3081\u308b\u306816x64\u306e\u90e8\u5206\u884c\u5217\u3092SIMD\u3067\u8a08\u7b97\u3059\u308b\u30b3\u30fc\u30c9\u3092\u300167\u547d\u4ee4\u4e2d\u306e64\u547d\u4ee4(95.5%)\u304c\u5b9f\u6570\u5024\u6f14\u7b97\u3001\u30ec\u30b8\u30b9\u30bf\u30d5\u30a1\u30a4\u30eb\u306e100%\u304c\u5b9f\u6570\u5024\u7528\u3068\u3044\u3046\u9ad8\u3044\u52b9\u7387\u3067\u66f8\u304f\u3053\u3068\u304c\u51fa\u6765\u307e\u3057\u305f\u3002Uniform Cache\u304c\u5341\u5206\u306b\u901f\u3051\u308c\u3070\u826f\u3044\u6027\u80fd\u304c\u51fa\u308b\u3093\u3067\u306f\u306a\u3044\u304b\u3068\u601d\u3044\u307e\u3059\u3002\n\n# \u884c\u5217\u6210\u5206\u4ee5\u5916\u3092\u3069\u3053\u306b\u7f6e\u304f\u304b\uff1f\n\n\u30ec\u30b8\u30b9\u30bf\u30d5\u30a1\u30a4\u30eb\u3092\u4f7f\u3044\u5207\u3063\u305f\u306e\u3067\u3001\u305d\u306e\u4ed6\u306e\u5909\u6570\u3092\u3069\u3053\u306b\u7f6e\u304f\u306e\u304b\u3068\u3044\u3046\u554f\u984c\u304c\u307e\u3060\u6b8b\u3063\u3066\u3044\u307e\u3059\u304c\u5927\u4e08\u592b\u3067\u3059\u3002\u6700\u5185\u30eb\u30fc\u30d7\u3067\u306f\u30a2\u30ad\u30e5\u30e0\u30ec\u30fc\u30bf`r0,r1,r2,r3`\u306e\u3046\u3061`r1,r2,r3`\u304c\u672a\u4f7f\u7528\u3067\u3059\u304b\u3089\n\n- `A_cur`\u3092`r1`\u306b\n- `B_cur`\u3092`r2`\u306b\n- `B_stride`\u3092`r3`\u306b\n\n\u5272\u308a\u5f53\u3066\u308b\u4e8b\u304c\u51fa\u6765\u307e\u3059\u3002\u5148\u307b\u3069\u306e`isub(k, k, 1)`\u306e\u524a\u9664\u306f\u3053\u306e\u70ba\u306b\u3082\u5fc5\u8981\u3067\u3057\u305f\u3002\n\n\u307e\u305f\u3001`A_cur`\u306f16\u6210\u5206\u3092\u4f7f\u3044\u5207\u3063\u3066\u3044\u307e\u3059\u304c\u3001`B_cur`\u3068`B_stride`\u306f\u307e\u30602\u6210\u5206\u3057\u304b\u4f7f\u3063\u3066\u3044\u307e\u305b\u3093\u3002\u7a7a\u3044\u3066\u3044\u308b28\u30ef\u30fc\u30c9\u306b\u884c\u5217\u306e\u30a2\u30c9\u30ec\u30b9\u3068\u304b\u30b5\u30a4\u30ba\u3068\u304b\u305d\u3046\u3044\u3063\u305f\u5024\u3092\u7f6e\u304f\u3053\u3068\u304c\u51fa\u6765\u307e\u3059\u3002\u4eca\u56de\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u914d\u7f6e\u3057\u307e\u3057\u305f\u3002$\\alpha$\u3068$\\beta$\u306f\u30a2\u30c9\u30ec\u30b9`coef_addr`\u306b\u7f6e\u304d\u307e\u3057\u305f\u3002Uniforms Cache\u3092\u4f7f\u3063\u3066\u8aad\u3080\u3053\u3068\u304c\u51fa\u6765\u307e\u3059\u3002\n\n![image](https://qiita-image-store.s3.amazonaws.com/0/83682/cb21d192-6703-1989-379e-4ac5a2994b14.png)\n\nk-loop\u3067\u306f`iadd(r2, r2, r3)`\u306eZ\u30d5\u30e9\u30b0\u3092\u30c1\u30a7\u30c3\u30af\u3059\u308b\u306e\u3067\u3001\u7b2c1\u6210\u5206\u4ee5\u5916\u304c0\u306b\u306a\u308b\u3053\u3068\u306e\u306a\u3044\u69d8\u306b\u6ce8\u610f\u3057\u307e\u3059\u3002(\u5148\u65e5\u306f\u8aa4\u3063\u3066$\\alpha$\u3068$\\beta$\u3092\u76f4\u306b\u7f6e\u3044\u3066\u3057\u307e\u3044\u3001$\\alpha=0.0$\u3082\u3057\u304f\u306f$\\beta=0.0$\u306e\u6642\u306bk-loop\u304c\u6b63\u3057\u304f\u56de\u3089\u306a\u3044\u3068\u3044\u3046\u30d0\u30b0\u3092\u57cb\u3081\u8fbc\u3093\u3067\u3057\u307e\u3044\u307e\u3057\u305f\u3002)\n\n\u30ec\u30b8\u30b9\u30bf\u30d5\u30a1\u30a4\u30ebB\u306e\u30a2\u30c9\u30ec\u30b937(\u79c1\u306e\u30e9\u30a4\u30d6\u30e9\u30ea\u3067\u306fbroadcast\u3068\u3044\u3046\u540d\u524d)\u306b\u5024\u3092\u66f8\u304d\u8fbc\u3080\u3068\u6210\u52060\u306e\u5024\u304c16\u6210\u5206\u3059\u3079\u3066\u306bbroadcast\u3055\u308c\u307e\u3059(\u30ea\u30d5\u30a1\u30ec\u30f3\u30b9\u30ac\u30a4\u30c9P38)\u3002\u3053\u308c\u3068\u6210\u5206\u3092\u56de\u8ee2\u3055\u305b\u308bvector rotation\u547d\u4ee4\u3092\u4f7f\u3046\u3068\u7279\u5b9a\u306e\u6210\u5206\u3060\u3051\u30921\u547d\u4ee4(\u3057\u304b\u3082\u4e57\u7b97\u5668\u306e\u307f)\u3067\u53d6\u308a\u51fa\u3059\u4e8b\u304c\u51fa\u6765\u307e\u3059\u306e\u3067\u3001\u3053\u306e\u683c\u7d0d\u65b9\u6cd5\u306b\u3088\u308b\u30da\u30ca\u30eb\u30c6\u30a3\u306f\u5c0f\u3055\u3044\u3067\u3059\u3002\n\n\u4f8b\u3048\u3070\u3001`r2`\u306e5\u756a\u76ee\u306e\u6210\u5206\u3092\u53d6\u308a\u51fa\u3057\u305f\u3051\u308c\u3070\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u3057\u307e\u3059\u3002\n\n```py\n    ...                        # \u4e00\u3064\u524d\u306e\u547d\u4ee4\u3067\u306fr2\u306b\u30a2\u30af\u30bb\u30b9\u3057\u3066\u306f\u3044\u3051\u306a\u3044\n    rotate(broadcast, r2, -5)\n    mov(r0, r5)                # \u7d50\u679c\u306f\u7279\u6b8a\u30a2\u30ad\u30e5\u30e0\u30ec\u30fc\u30bfr5\u306b\u5165\u308b\u3002\n```\n\nvector rotation\u306f\u30a4\u30ec\u30ae\u30e5\u30e9\u30fc\u306a\u9806\u756a\u3067\u30d1\u30a4\u30d7\u30e9\u30a4\u30f3\u306b\u30a2\u30af\u30bb\u30b9\u3057\u307e\u3059\u304b\u3089\u3001\u4ed6\u306e\u547d\u4ee4\u3068\u7570\u306a\u308arotate\u306e**\u524d**\u306b\u5f85\u3061\u6642\u9593\u304c\u5fc5\u8981\u3067\u3059\u3002\n\n\u30d9\u30af\u30c8\u30eb\u30ec\u30b8\u30b9\u30bf\u306b\u8a70\u3081\u8fbc\u3080\u4ee5\u5916\u3060\u3068\n\n- \u4e0a\u3067\u3084\u3063\u305f\u3088\u3046\u306bUniforms Cache\u306eBase Address\u3060\u3051\u8a18\u61b6\u3057\u3066\u304a\u304d\u3001\u5fc5\u8981\u306b\u306a\u3063\u305f\u6642\u306buniform\u304b\u3089\u8aad\u3080\u3002\n- \u30d7\u30ed\u30b0\u30e9\u30e0\u3092\u5b9f\u884c\u524d\u306b\u66f8\u304d\u63db\u3048\u3066\u3001\u547d\u4ee4\u306e\u5373\u5024\u90e8\u5206\u306b\u57cb\u3081\u8fbc\u3093\u3067\u3057\u307e\u3046\u3002\n- \u8a08\u7b97\u3057\u3066\u4f5c\u308c\u308b\u3082\u306e\u306f\u305d\u3046\u3059\u308b\u3002\n\n\u306a\u3069\u306e\u5de5\u592b\u304c\u51fa\u6765\u307e\u3059\u3002\u305f\u307e\u306b\u3057\u304b\u4f7f\u7528\u3057\u306a\u3044\u5024\u306e\u70ba\u306b\u30ec\u30b8\u30b9\u30bf\u3092\u4f7f\u3046\u306e\u306f\u3082\u3063\u305f\u3044\u306a\u3044\u306e\u3067\u3001\u3053\u3046\u3044\u3063\u305f\u52aa\u529b\u3092\u3057\u307e\u3057\u3087\u3046\u3002\n\n# \u884c\u5217C\u3078\u306e\u8db3\u3057\u3053\u307f\n\n$\\alpha AB + \\beta C$ \u306e$AB$\u306e\u90e8\u5206\u306e\u8a08\u7b97\u304c\u51fa\u6765\u308b\u3088\u3046\u306b\u306a\u3063\u305f\u306e\u3067\u3001\u6b21\u306f$\\alpha(\\cdots)+\\beta C$\u306e\u90e8\u5206\u306e\u8a08\u7b97\u3067\u3059\u3002Host\u306b\u66f8\u304d\u623b\u3059\u5fc5\u8981\u304c\u3042\u308b\u306e\u3067VPM\u306b\u7f6e\u304f\u3053\u3068\u306b\u3057\u307e\u3059\u3002(TMU\u3067load\u3057\u3001VPM\u306b\u66f8\u304d\u8fbc\u3080\u3068\u3044\u3046\u624b\u3082\u3042\u308a\u305d\u3046\u3067\u3059\u3002\u3069\u3063\u3061\u304c\u826f\u3044\u304b\u306f\u307e\u3060\u5206\u304b\u308a\u307e\u305b\u3093\u3002)\n\nVPM\u306e\u30b5\u30a4\u30ba\u306f64x16\u3067\u3059\u3002\u3001\u4e0a\u3067\u8a08\u7b97\u3057\u305f\u3082\u306e\u304c\u3061\u3087\u3046\u3069\u53ce\u307e\u308a\u307e\u3059\u3002\nHost memory\u3001VPM\u9593\u306fDMA\u3067\u8ee2\u9001\u3057\u307e\u3059\u3002\u4e00\u5ea6\u306b16\u672c\u306e\u30d9\u30af\u30c8\u30eb\u3092\u8ee2\u9001\u3067\u304d\u308b\u306e\u306716x16\u306e\u30d6\u30ed\u30c3\u30af\u306b\u5206\u3051\u30664\u56de\u8ee2\u9001\u3057\u307e\u3059\u3002\n\n\u884c\u5217\u306fHost memory\u306b\u306fRow-major\u3067\u683c\u7d0d\u3055\u308c\u3066\u3044\u307e\u3059\u304b\u3089\u3001Horizontal mode\u3067\u8ee2\u9001\u3057\u305f\u65b9\u304c\u3001\u591a\u5206\u901f\u3044\u3093\u3058\u3083\u306a\u3044\u304b\u3068\u601d\u3044\u307e\u3059\u3002\u30db\u30f3\u30c8\u304b\u3069\u3046\u304b\u306f\u77e5\u308a\u307e\u305b\u3093\u3002\u4e00\u65b9\u3001QPU\u3067\u306f\u5217\u30d9\u30af\u30c8\u30eb\u5358\u4f4d\u3067\u30c7\u30fc\u30bf\u3092\u6301\u3063\u3066\u3044\u307e\u3059\u304b\u3089\u3001VPM, QPU\u9593\u306fVertical mode\u3067\u3084\u308a\u53d6\u308a\u3057\u307e\u3059\u3002\n\n![equation_04.png](https://qiita-image-store.s3.amazonaws.com/0/83682/a0ad7823-f957-a25a-c060-77222286886c.png)\n\nDMA\u306f\u304b\u306a\u308a\u6642\u9593\u304c\u639b\u304b\u308b\u306f\u305a\u306a\u306e\u3067\u3001\u5f85\u3061\u6642\u9593\u3092\u7121\u99c4\u306b\u3057\u306a\u3044\u3088\u3046\u306b1\u3064\u3081\u306e\u30d6\u30ed\u30c3\u30af\u306e\u8ee2\u9001\u306f\u5148\u307b\u3069\u30bd\u30d5\u30c8\u30a6\u30a7\u30a2\u30d1\u30a4\u30d7\u30e9\u30a4\u30cb\u30f3\u30b0\u3092\u3057\u3066\u306f\u307f\u51fa\u3057\u305f\u6240\u3068\u91cd\u306d\u307e\u3059\u300263\u547d\u4ee4(=252\u30af\u30ed\u30c3\u30af)\u5206\u306e\u5f85\u3061\u6642\u9593\u3092\u6709\u52b9\u306b\u4f7f\u3048\u307e\u3059\u3002\n\n```py\n    # \u884c\u5217C\u306eload\u7528\u30b9\u30c8\u30e9\u30a4\u30c9\u3092\u30bb\u30c3\u30c8\u3002\u3053\u308c\u306f\u5b9a\u6570\u306a\u306e\u3067\u30d7\u30ed\u30b0\u30e9\u30e0\u306e\u4e00\u756a\u6700\u521d\u306b\u4e00\u56de\u3060\u3051\u3084\u308c\u3070\u3088\u3044\u3002\n    rotate(broadcast, r2, -C_STRIDE_IDX)\n    setup_dma_load_stride(r5, tmp_reg=r1)\n\n    # \u884c\u5217C\u306estore\u7528\u30b9\u30c8\u30e9\u30a4\u30c9\u3092\u30bb\u30c3\u30c8\u3002\u3053\u308c\u3082\u30d7\u30ed\u30b0\u30e9\u30e0\u306e\u4e00\u756a\u6700\u521d\u306b\u4e00\u56de\u3084\u308c\u3070\u3088\u3044\u3002\n    ldi(r1, 4*16)\n    isub(r1, r5, r1) # \u3053\u306e\u5f15\u304d\u7b97\u304c\u5fc5\u8981\u306a\u7406\u7531\u306f\u30ea\u30d5\u30a1\u30ec\u30f3\u30b9\u30ac\u30a4\u30c9\u306eTable35\u3092\u53c2\u7167\u3002\n    setup_dma_store_stride(r1)\n\n    ... \u7701\u7565\n\n    # (\u5148\u307b\u3069\u306e\u30eb\u30fc\u30d7(k-loop)\u3092\u629c\u3051\u305f\u6240\u3002)\n\n    # \u6700\u521d\u306e\u30d6\u30ed\u30c3\u30af\u306eload\u3092\u767a\u884c\n    setup_dma_load(mode='32bit horizontal', Y=0, nrows=16, mpitch=0)\n    rotate(broadcast, r2, -C_BASE_IDX)\n    start_dma_load(r5).mov(r3, r5)          # C\u306e\u30d9\u30fc\u30b9\u30a2\u30c9\u30ec\u30b9\u3092\u899a\u3048\u3066\u304a\u304f\u3002\n\n    # \u2193 \u30bd\u30d5\u30c8\u30a6\u30a7\u30a2\u30d1\u30a4\u30d7\u30e9\u30a4\u30cb\u30f3\u30b0\u306b\u3088\u3063\u3066k-loop\u304b\u3089\u306f\u307f\u51fa\u3057\u305f\u8a08\u7b97\u3067\u3001\u901a\u4fe1\u3092\u51fa\u6765\u308b\u3060\u3051\u96a0\u853d\u3059\u308b\u3002\n\n    fadd(ra1,  ra1,  r0).fmul(r0, r4, uniform)\n    fadd(rb1,  rb1,  r0).fmul(r0, r4, uniform)\n\n    ... # \u7701\u7565\n\n    fadd(ra31, ra31, r0).fmul(r0, r4, uniform)\n    fadd(rb31, rb31, r0)\n\n    wait_dma_load() # \u3053\u3053\u3067DMA\u306e\u5b8c\u4e86\u3092\u5f85\u3064\u3002\n\n```\n\n\u8ee2\u9001\u6642\u9593\u3092\u96a0\u853d\u3059\u308b\u306b\u306f\u3082\u3046\u4e00\u3064\u65b9\u6cd5\u304c\u3042\u308a\u307e\u3059\u3002\u5404QPU\u306f2\u3064\u306e\u30cf\u30fc\u30c9\u30a6\u30a7\u30a2\u30b9\u30ec\u30c3\u30c9\u3092\u8d70\u3089\u305b\u308b\u4e8b\u304c\u51fa\u6765\u308b\u306e\u3067\u3001\u4ea4\u4e92\u306b\u4e0a\u624b\u304f\u5207\u308a\u66ff\u3048\u308c\u3070\u901a\u4fe1\u3092\u96a0\u853d\u3057\u3066\u6f14\u7b97\u5668\u3092\u30d5\u30eb\u7a3c\u50cd\u3055\u305b\u308b\u4e8b\u304c\u51fa\u6765\u307e\u3059\u3002\n\n![path21629.png](https://qiita-image-store.s3.amazonaws.com/0/83682/85fa09d1-19dd-5efb-8177-750c74590912.png)\n\n\u3044\u308d\u3044\u308d\u306a\u30d1\u30e9\u30e1\u30fc\u30bf\u304c\u307e\u3060\u4e0d\u660e\u306a\u72b6\u614b\u3067\u3084\u3063\u3066\u3044\u308b\u306e\u3067\u3001\u3069\u3046\u3059\u308b\u306e\u304c\u30d9\u30b9\u30c8\u304b\u306f\u5b9f\u9a13\u3057\u3066\u307f\u306a\u3051\u308c\u3070\u5206\u304b\u308a\u307e\u305b\u3093\u3002\u305f\u3060\u3001\u30b9\u30ec\u30c3\u30c9\u5316\u3059\u308b\u3068\u5404\u30b9\u30ec\u30c3\u30c9\u304c\u4f7f\u3048\u308b\u30ec\u30b8\u30b9\u30bf\u306f\u534a\u5206\u306b\u6e1b\u308a\u3001\u6700\u5185\u30eb\u30fc\u30d7\u306e\u52b9\u7387\u304c\u5c11\u3057\u4e0b\u304c\u308a\u307e\u3059\u3002\u30b9\u30ec\u30c3\u30c9\u5207\u308a\u66ff\u3048\u306e\u30aa\u30fc\u30d0\u30fc\u30d8\u30c3\u30c9\u3082\u3042\u308a\u307e\u3059\u304b\u3089\u3001\u30b7\u30f3\u30b0\u30eb\u30b9\u30ec\u30c3\u30c9\u3067\u4e0a\u624b\u304f\u3084\u308c\u308b\u306a\u3089\u3070\u305d\u306e\u65b9\u304c\u826f\u3044\u306f\u305a\u3067\u3059\u3002\n\n1\u30d6\u30ed\u30c3\u30af\u3092load\u3057\u305f\u3089\u3001\u6b21\u306e\u30d6\u30ed\u30c3\u30af\u306eload\u3092\u5148\u306b\u767a\u884c\u3057\u3066\u304b\u3089$\\alpha(\\cdots)+\\beta C$\u306e\u8a08\u7b97\u3092\u884c\u3044\u307e\u3059\u3002\u639b\u3051\u7b97\u304c2\u56de\u3067\u8db3\u3057\u7b97\u304c1\u56de\u3067\u3059\u304b\u3089\u3001\u52a0\u7b97\u5668\u304c1\u56de\u5206\u4f59\u308a\u307e\u3059\u3002\u3053\u306e\u9699\u9593\u306b\u6b21\u306e\u30a4\u30c6\u30ec\u30fc\u30b7\u30e7\u30f3\u306e\u70ba\u306b\u5217\u30d9\u30af\u30c8\u30eb\u30920\u521d\u671f\u5316\u3059\u308b\u51e6\u7406\u3092\u7a81\u3063\u8fbc\u307f\u307e\u3059\u3002\n\n```py\n    # alpha, beta\u3092\u8aad\u3080\u70ba\u306buniforms cache\u3092\u8a2d\u5b9a\n    rotate(r0, r2, -COEF_ADDR_IDX)\n    mov(uniforms_address, r0)\n\n    # 2\u3064\u3081\u306e\u30d6\u30ed\u30c3\u30af\u306e\u30ed\u30fc\u30c9\u3092\u767a\u884c\n    setup_dma_load(mode='32bit horizontal', Y=16, X=0, nrows=16, mpitch=0)\n    ldi(r0, 4*16)\n    iadd(vpm_ld_addr, r3, r0)\n\n    # 1\u3064\u3081\u306e\u30d6\u30ed\u30c3\u30af\u306b\u5bfe\u3059\u308bVPM\u30a2\u30af\u30bb\u30b9\u3092\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\n    setup_vpm_read(mode='32bit vertical', Y=0, X=0, nrows=16)\n    setup_vpm_write(mode='32bit vertical', Y=0, X=0)\n\n    # alpha, beta\u3092\u53d6\u308a\u51fa\u3059\u3002\n    mov(r1, uniform)        # r1=alpha\n    mov(broadcast, uniform) # r5=beta\n\n    # 1\u3064\u3081\u306e\u30d6\u30ed\u30c3\u30af\u306e\u8db3\u3057\u3053\u307f\n    fmul(ra0, ra0, r1)                    # AB\u306e\u4e00\u5217\u306balpha\u3092\u639b\u3051\u308b\u3002\n    fmul(r0, vpm, r5)                     # C\u306e\u4e00\u5217\u306bbeta\u3092\u639b\u3051\u308b\u3002\n    fadd(vpm, ra0, r0).fmul(rb0, rb0, r1) # \u5de6: \u8db3\u3057\u3066vpm\u306b\u66f8\u304d\u623b\u3059\u3002  \u53f3: \u6b21\u306e\u5217\u306e\u8a08\u7b97\n    mov(ra0, 0.0)     .fmul(r0, vpm, r5)  # \u5de6: \u6b21\u306e\u30a4\u30c6\u30ec\u30fc\u30b7\u30e7\u30f3\u306e\u70ba\u306bra0\u3092\u521d\u671f\u5316\u3002 \u53f3: \u6b21\u306e\u5217\u306e\u8a08\u7b97\n    ... # \u7701\u7565\n\n```\n\n\u3053\u3093\u306a\u611f\u3058\u3067\u8a08\u7b97\u3068\u8ee2\u9001\u3092\u4ea4\u4e92\u306b\u8a70\u3081\u8fbc\u307f\u307e\u3059\u3002\n\u4ee5\u4e0a\u3067\u300116x64\u306e\u90e8\u5206\u884c\u5217\u306e\u8a08\u7b97\u304c\u5b8c\u4e86\u3057\u307e\u3057\u305f\u3002\n\n# \u6b21\u56de\u306b\u7d9a\u304f\u3002\n\n\u3059\u3054\u304f\u9577\u304f\u306a\u3063\u3066\u3057\u307e\u3063\u305f\u306e\u3067\u3001Advent Calendar\u3092\u3082\u3046\u4e00\u65e5\u4f7f\u308f\u305b\u3066\u3082\u3089\u3063\u3066\u7d9a\u304d\u3092\u66f8\u304d\u307e\u3059\u3002\n\u6b21\u306f\n\n- \u5916\u5074\u306ei-\u30eb\u30fc\u30d7,j-\u30eb\u30fc\u30d7\u3092\u66f8\u304d\u307e\u3059\u3002\n- 12\u500b\u306eQPU\u3092\u4f7f\u3063\u3066\u4e26\u5217\u5b9f\u884c\u3057\u307e\u3059\u3002\n- \u3053\u306e\u969b\u306e\u540c\u671f\u51e6\u7406\u306b\u3064\u3044\u3066\u8aac\u660e\u3057\u307e\u3059\u3002\n- \u30d9\u30f3\u30c1\u30de\u30fc\u30af\u3092\u53d6\u308a\u307e\u3059\u3002\u901f\u304f\u306a\u3063\u3066\u3044\u308b\u3068\u826f\u3044\u306a\uff5e\u3002\n", "tags": ["RaspberryPi", "GPGPU", "Python"]}