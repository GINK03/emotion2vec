{"context": "\n\nCisco N9K Guest Shell\u306bChef Client\u3092\u5c0e\u5165\n\nUSB\u306bRPM\u30d5\u30a1\u30a4\u30eb\u3092\u683c\u7d0d\u3057\u3001\u7269\u7406\u7684\u306bNexus\u306b\u5dee\u3057\u307e\u3057\u305f\u3002\n\n\n\u30b5\u30fc\u30d0\u306bRPM\u30d5\u30a1\u30a4\u30eb\u3092\u7f6e\u3044\u3066\u304a\u304dSCP\u3057\u3066\u3082OK\u3067\u3059\u3002\n\n\nNexus\u304b\u3089USB\u304c\u898b\u3048\u306a\u304f\u306a\u3063\u305f\u304c\u30d5\u30a9\u30fc\u30de\u30c3\u30c8\u3057\u305f\u3089\u8a8d\u8b58\u3057\u307e\u3057\u305f\u3002\n\n\n\u30d5\u30a1\u30a4\u30eb\u304c\u5168\u524a\u9664\u3055\u308c\u308b\u306e\u3067\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u8981\u3002\n\n\nChef Client\u3092Cisco\u306e\u30b5\u30a4\u30c8\u304b\u3089\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3059\u308b\u3068\u53e4\u3044\u30d0\u30fc\u30b8\u30e7\u30f3\u3092\u5165\u308c\u3055\u305b\u3089\u308c\u308b\u3088\u3046\u3067\u3059\u3002\u3002\u3002\n\u65b0\u3057\u3044Chef Client\u306fChef\u306e\u30b5\u30a4\u30c8\u3067\u5165\u624b\u3057\u307e\u3057\u3087\u3046\u3002\u305f\u3060\u3057\u3001\u6700\u65b0Ver(\u73fe\u6642\u70b9\u306712.19.36)\u3067\u306fCisco NX-OS\u304c\u63d0\u4f9b\u3055\u308c\u3066\u3044\u307e\u305b\u3093\u3002\u3002\u3002\n\nswitch# format ?\n  bootflash:  Format bootflash:\n  usb1:       Format usb1:\n  usb2:       Format usb2:\n\nThis command is going to erase the contents of your usb1:.\nDo you want to continue? (yes/no)  [y] y\n/etc/rc.d/include/probe_bootdev: line 106: /boot_dev: Permission denied\nFormatting usb1:\nFormatting completed\nswitch# switch# format usb1:2:\nThis command is going to erase the contents of your usb2:.\nDo you want to continue? (yes/no)  [y] y\n/etc/rc.d/include/probe_bootdev: line 106: /boot_dev: Permission denied\nFormatting usb2:\nCannot format usb2: Make sure the drive is inserted.\n\nswitch# dir usswitch# dir us\nusb1:  usb2:  \n\nswitch# switch# dir usb1:\n   41373894    Feb 27 15:22:12 2017  chef-12.4.1.cisco+20150826000706-1.nexus5.x\n86_64.rpm\n   43783906    Mar 01 14:59:30 2017  chef-12.4.1.cisco+20150826204615-1.el7.x86_\n64.rpm\n\nUsage for usb1://sup-local\n   85172224 bytes used\n16256557056 bytes free\n16341729280 bytes total\n\n\n\nUSB\u306b\u683c\u7d0d\u3057\u305frpm\u3092bootflash\u306b\u30b3\u30d4\u30fc\u3002\n\nswitch# switch# copy usb1:///chef-12.4.1.cisco+20150826usb1:///chef-12.4.1.cisco+201508?\n  usb1:///chef-12.4.1.cisco+20150826000706-1.nexus5.x86_64.rpm  \n  usb1:///chef-12.4.1.cisco+20150826204615-1.el7.x86_64.rpm     \n\nswitch# copy usb1:///chef-12.4.1.cisco+20150826204615-1.el7.x86_64.rpm bootflash:\n\nCopy progress 1% 442KBCopy progress 2% 884KBCopy progress 3% 1327KBCopy progress 4% 1753KBCopy progress 5% 2195KBCopy progress 6% 2637KBCopy progress 7% 3080KBCopy progress 8% 3506KBCopy progress 9% 3948KBCopy progress 10% 4390KBCopy progress 11% 4816KBCopy progress 12% 5259KBCopy progress 13% 5701KBCopy progress 14% 6144KBCopy progress 15% 6569KBCopy progress 16% 7012KBCopy progress 17% 7454KBCopy progress 18% 7897KBCopy progress 19% 8323KBCopy progress 20% 8765KBCopy progress 21% 9207KBCopy progress 22% 9633KBCopy progress 23% 10076KBCopy progress 24% 10518KBCopy progress 25% 10960KBCopy progress 26% 11386KBCopy progress 27% 11829KBCopy progress 28% 12271KBCopy progress 29% 12697KBCopy progress 30% 13139KBCopy progress 31% 13582KBCopy progress 32% 14024KBCopy progress 33% 14450KBCopy progress 34% 14893KBCopy progress 35% 15335KBCopy progress 36% 15777KBCopy progress 37% 16203KBCopy progress 38% 16646KBCopy progress 39% 17088KBCopy progress 40% 17514KBCopy progress 41% 17956KBCopy progress 42% 18399KBCopy progress 43% 18841KBCopy progress 44% 19267KBCopy progress 45% 19709KBCopy progress 46% 20152KBCopy progress 47% 20594KBCopy progress 48% 21020KBCopy progress 49% 21463KBCopy progress 50% 21905KBCopy progress 51% 22331KBCopy progress 52% 22773KBCopy progress 53% 23216KBCopy progress 54% 23658KBCopy progress 55% 24084KBCopy progress 56% 24526KBCopy progress 57% 24969KBCopy progress 58% 25395KBCopy progress 59% 25837KBCopy progress 60% 26279KBCopy progress 61% 26722KBCopy progress 62% 27148KBCopy progress 63% 27590KBCopy progress 64% 28033KBCopy progress 65% 28475KBCopy progress 66% 28901KBCopy progress 67% 29343KBCopy progress 68% 29786KBCopy progress 69% 30212KBCopy progress 70% 30654KBCopy progress 71% 31096KBCopy progress 72% 31539KBCopy progress 73% 31965KBCopy progress 74% 32407KBCopy progress 75% 32849KBCopy progress 76% 33275KBCopy progress 77% 33718KBCopy progress 78% 34160KBCopy progress 79% 34603KBCopy progress 80% 35028KBCopy progress 81% 35471KBCopy progress 82% 35913KBCopy progress 83% 36356KBCopy progress 84% 36782KBCopy progress 85% 37224KBCopy progress 86% 37666KBCopy progress 87% 38092KBCopy progress 88% 38535KBCopy progress 89% 38977KBCopy progress 90% 39419KBCopy progress 91% 39845KBCopy progress 92% 40288KBCopy progress 93% 40730KBCopy progress 94% 41172KBCopy progress 95% 41598KBCopy progress 96% 42041KBCopy progress 97% 42483KBCopy progress 98% 42909KBCopy progress 99% 43352KBCopy progress 100% 43783KB\nCopy complete, now saving to disk (please wait)...\n\n\nguestshell \u30b3\u30de\u30f3\u30c9\u306b\u3088\u308a N9K \u5185\u306eLinux\u306b\u30a2\u30af\u30bb\u30b9\u53ef\u80fd\u3002\n\nswitch# guestshell\n[guestshell@chefn9k ~]$\n\n\nBootflash\u306brpm\u304c\u898b\u3048\u308b\u3002\n\n[guestshell@chefn9k ~]$ dir /bootflash/\n20170227_061436_poap_15827_init.log                lxc\nCpuUsage.Log                                       mem_log.txt.old.gz\nMemoryLog.65%_usage                                nxos.7.0.3.I4.5.bin\naci-n9000-dk9.11.3.1g.bin                          platform-sdk.cmd\naci-n9000-dk9.12.0.1m.bin                          scripts\nauto-s                                             urib_api_log.txt\nbios_bootup_scratch_not_cleared                    virt_strg_pool_bf_vdc_1\nchef-12.4.1.cisco+20150826204615-1.el7.x86_64.rpm  virtual-instance\ndisk_log.txt                                       virtual-instance.conf\nlost+found\n\n\nBootflash\u304b\u3089guestshell\u4e0a\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306brpm\u30d5\u30a1\u30a4\u30eb\u3092\u79fb\u52d5\u3002\n\n[root@chefn9k ~]# mkdir /usr/tmp/repo/chef/Packages\n[root@chefn9k ~]# cd /usr/tmp/repo/chef/Packages\n[root@chefn9k Packages]# cp /bootflash// chef-12.4.1.cisco+20150826204615-1.el7.x8 6_64.rpm /usr/tmp/repo/chef/Packages/\n[guestshell@chefn9k ~]$ ls -la /usr/tmp/repo/chef/Packages/\ntotal 42760\ndrwxr-xr-x 2 root root       60 Mar  1 07:18 .\ndrwxr-xr-x 3 root root       60 Mar  1 07:18 ..\n-rw-r--r-- 1 root root 43783906 Mar  1 07:18 chef-12.4.1.cisco+20150826204615-1.el7.x86_64.rpm\n\n\n\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3002\n\n[root@chefn9k Packages]# rpm -ivh chef-12.4.1.cisco+20150826204615-1.el7.x86_64. rpm\nPreparing...                                                            (100%)#                                 (100%)##                                (100%)###                               (100%)####                              (100%)#####                             (100%)######                            (100%)#######                           (100%)########                          (100%)#########                         (100%)##########                        (100%)###########                       (100%)############                      (100%)#############                     (100%)##############                    (100%)###############                   (100%)################                  (100%)#################                 (100%)##################                (100%)###################               (100%)####################              (100%)#####################             (100%)######################            (100%)#######################           (100%)########################          (100%)#########################         (100%)##########################        (100%)###########################       (100%)############################      (100%)#############################     (100%)##############################    (100%)###############################   (100%)################################  (100%)################################# (100%)################################# [100%]\nUpdating / installing...\n   1:chef-12.4.1.cisco+20150826204615-                                  (  1%)#                                 (  4%)##                                (  7%)###                               ( 10%)####                              ( 13%)#####                             ( 16%)######                            ( 19%)#######                           ( 22%)########                          ( 25%)#########                         ( 28%)##########                        ( 31%)###########                       ( 34%)############                      ( 37%)#############                     ( 40%)##############                    ( 43%)###############                   ( 46%)################                  ( 49%)#################                 ( 51%)##################                ( 54%)###################               ( 57%)####################              ( 60%)#####################             ( 63%)######################            ( 66%)#######################           ( 69%)########################          ( 72%)#########################         ( 75%)##########################        ( 78%)###########################       ( 81%)############################      ( 84%)#############################     ( 87%)##############################    ( 90%)###############################   ( 93%)################################  ( 96%)################################# ( 99%)################################# [100%]\nThank you for installing Chef!\n\n\n\u30e6\u30fc\u30b6\u8a2d\u5b9a\n\nChef Node(Chef Client) \u3067\u3042\u308b Cisco N9K \u306b\u30e6\u30fc\u30b6\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\u3053\u306e\u30e6\u30fc\u30b6\u306f Chef Workstation \u304b\u3089 Chef Node \u306b SSH \u3067\u30ed\u30b0\u30a4\u30f3\u3059\u308b\u969b\u306b\u4f7f\u7528\u3057\u307e\u3059\u3002\n\n[guestshell@chefn9k ~]$ sudo useradd chefuser01\n[guestshell@chefn9k ~]$ sudo passwd chefuser01\nChanging password for user chefuser01.\nNew password:\nBAD PASSWORD: The password fails the dictionary check - it is based on a dictionary word\nRetype new password:\npasswd: all authentication tokens updated successfully.\n\n\nchefuser01 \u306b sudo \u7d4c\u7531\u3067 root \u3092\u4f7f\u3046\u6a29\u9650\u3092\u4ed8\u4e0e\u3057\u307e\u3059\u3002\n\n\nchefuser01 \u306e2\u884c\u3092\u8ffd\u52a0\u3002\n\n\n\n## Allow root to run any commands anywhere\nroot    ALL=(ALL)       ALL\nchefuser01 ALL=(ALL) ALL\nchefuser01 ALL=(ALL) NOPASSWD: ALL\n\n[\u53c2\u8003]\u3053\u306e\u624b\u9806\u3068\u540c\u3058\nhttp://qiita.com/inoko/items/09b9a15cb1a5c83fed34\n\nBootstrap\n\n\u4e88\u3081\u3001Chef Node \u306b\u3066 Chef Workstation(ino-ubuntu) \u306e\u540d\u524d\u89e3\u6c7a\u304c\u3067\u304d\u308b\u3088\u3046\u306b\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\n\n172.22.150.100 \u3092\u8ffd\u52a0\u3002\n\n\n\n[guestshell@chefn9k ~]$ cat /etc/hosts\n127.0.0.1 localhost guestshell\n172.22.150.100 ino-ubuntsu.iselab.local ino-ubuntu\n[guestshell@chefn9k ~]$\n\n\n\u6012\u3089\u308c\u307e\u3057\u305f\u3002\n\ninohana@ino-ubuntu:~/repo/.chef$ knife bootstrap ino-ubuntu.iselab.local -x chefuser01 --sudo\nDoing old-style registration with the validation key at /home/inohana/repo/.chef/ise-validator.pem...\nDelete your validation key in order to use your user credentials instead\n\nConnecting to ino-ubuntu.iselab.local\nERROR: Errno::EACCES: Permission denied @ rb_sysopen - /home/inohana/repo/.chef/ise-validator.pem\n\ninohana@ino-ubuntu:~/repo/.chef$ ls -l\ntotal 16\n-rw------- 1 root root 1678 Mar  2 04:53 inohana.pem\n-rw------- 1 root root 1678 Mar  2 04:53 ise-validator.pem\n-rw-r--r-- 1 root root  667 Mar  2 05:01 knife.rb\ndrwxr-xr-x 2 root root 4096 Mar  2 05:01 trusted_certs\n\n\nise-validator.pem \u306e\u6a29\u9650\u3092\u5909\u66f4\u3002\n\ninohana@ino-ubuntu:~/repo/.chef$ sudo chown -R inohana *\n[sudo] password for inohana:\ninohana@ino-ubuntu:~/repo/.chef$ ls -l\ntotal 16\n-rw------- 1 inohana root 1678 Mar  2 04:53 inohana.pem\n-rw------- 1 inohana root 1678 Mar  2 04:53 ise-validator.pem\n-rw-r--r-- 1 inohana root  667 Mar  2 05:01 knife.rb\ndrwxr-xr-x 2 inohana root 4096 Mar  2 05:01 trusted_certs\n\n\nWorkstation \u306e Hosts \u306b\u66f8\u3044\u3066\u3044\u308b\u306e\u306f N9K \u30b9\u30a4\u30c3\u30c1\u306e IP \u30a2\u30c9\u30ec\u30b9\u3067\u3042\u308b\u305f\u3081\u3001\u30a2\u30af\u30bb\u30b9\u3067\u304d\u306a\u3044\u6a21\u69d8\u3067\u3059\u3002\n\ninohana@ino-ubuntu:~/repo/.chef$ knife bootstrap ino-ubuntu.iselab.local -x chefuser01 --sudo\nDoing old-style registration with the validation key at /home/inohana/repo/.chef/ise-validator.pem...\nDelete your validation key in order to use your user credentials instead\n\nConnecting to ino-ubuntu.iselab.local\nchefuser01@ino-ubuntu.iselab.local's password:\nchefuser01@ino-ubuntu.iselab.local's password:\nchefuser01@ino-ubuntu.iselab.local's password:\nFailed to authenticate chefuser01 - trying password auth\n\n# \u5165\u308c\u307e\u305b\u3093\uff01\n\nERROR: Net::SSH::AuthenticationFailed: Authentication failed for user \n\n\n\n\u4ee5\u4e0b\u30ea\u30f3\u30af\u306e\u300cPre-Configured SSHD Service\u300d\u3092\u307f\u3066\u304f\u3060\u3055\u3044\u3002\n\n\n\u53c2\u8003\uff1aCisco Nexus 9000 Series NX-OS Programmability Guide, Release 7.x\n\u30de\u30cb\u30e5\u30a2\u30eb\u306b\u3061\u3087\u3063\u3068\u8aa4\u690d\u304c\u3042\u308b\u306e\u3067\u6ce8\u610f\u3002\n\n\n\n\n\n/usr/lib/systemd/system/sshd/service \u30d5\u30a1\u30a4\u30eb\u3092\u30b3\u30d4\u30fc\u3002\n\n\n\u30b3\u30d4\u30fc\u3057\u305f\u30d5\u30a1\u30a4\u30eb sshd-mgmt.service \u3092\u7de8\u96c6\u3002\n\n\n\n\n[guestshell@chefn9k system]$ pwd\n/usr/lib/systemd/system\n\n[guestshell@chefn9k system]$ sudo cp sshd.service sshd-mgmt.service\n\n[guestshell@chefn9k system]$ ls -la sshd-*\n-rw-r--r-- 1 root root 375 Feb 27 06:13 sshd-cisco.service\n-rw-r--r-- 1 root root 307 Feb 27 06:13 sshd-keygen.service\n-rw-r--r-- 1 root root 316 Mar 10 02:01 sshd-mgmt.service\n\n[guestshell@chefn9k system]$ cat sshd-mgmt.service\n[Unit]\nDescription=OpenSSH server daemon\nAfter=network.target sshd-keygen.service\nWants=sshd-keygen.service\n\n[Service]\nEnvironmentFile=/etc/sysconfig/sshd\nExecStart=/usr/sbin/sshd -D $OPTIONS\nExecReload=/bin/kill -HUP $MAINPID\nKillMode=process\nRestart=on-failure\nRestartSec=42s\n\n[Install]\nWantedBy=multi-user.target\n\n# \u4ee5\u4e0b\u306e\u3088\u3046\u306b\u30d5\u30a1\u30a4\u30eb\u3092\u7de8\u96c6\u3057\u307e\u3059\u3002\n\n[guestshell@chefn9k system]$ cat sshd-mgmt.service\n[Unit]\nDescription=OpenSSH server daemon\nAfter=network.target sshd-keygen.service\nWants=sshd-keygen.service\n\n[Service]\nEnvironmentFile=/etc/sysconfig/sshd\nExecStartPre=/usr/sbin/sshd-keygen\nExecStart=/sbin/ip netns exec management /usr/sbin/sshd -f /etc/ssh/sshd-mgmt_config -D $OPTIONS\n#ExecStart=/usr/sbin/sshd -D $OPTIONS\nExecReload=/bin/kill -HUP $MAINPID\nKillMode=process\nRestart=on-failure\nRestartSec=42s\n\n[Install]\nWantedBy=multi-user.target\n\n\n/etc/ssh/sshd_config \u30d5\u30a1\u30a4\u30eb\u3092\u30b3\u30d4\u30fc\u3002\n\n\n\u30b3\u30d4\u30fc\u3057\u305f\u30d5\u30a1\u30a4\u30eb sshd-mgmt_config \u3092\u7de8\u96c6\u3002\n\n\n\n[guestshell@chefn9k system]$ cd /etc/ssh\n[guestshell@chefn9k ssh]$ ls -la\ntotal 275\ndrwxr-xr-x  2 root root       1024 Mar  2 03:22 .\ndrwxr-xr-x 56 root root       5120 Mar  3 06:51 ..\n-rw-r--r--  1 root root     242153 Feb 27 06:13 moduli\n-rw-r--r--  1 root root       2208 Feb 27 06:13 ssh_config\n-rw-r-----  1 root ssh_keys    227 Feb 27 06:13 ssh_host_ecdsa_key\n-rw-r--r--  1 root root        162 Feb 27 06:13 ssh_host_ecdsa_key.pub\n-rw-r-----  1 root ssh_keys    387 Feb 27 06:13 ssh_host_ed25519_key\n-rw-r--r--  1 root root         82 Feb 27 06:13 ssh_host_ed25519_key.pub\n-rw-r-----  1 root ssh_keys   1679 Feb 27 06:13 ssh_host_rsa_key\n-rw-r--r--  1 root root        382 Feb 27 06:13 ssh_host_rsa_key.pub\n-rw-------  1 root root       4496 Feb 27 06:13 sshd_config\n-rw-------  1 root root       4492 Feb 27 06:13 sshd_config-cisco\n\n[guestshell@chefn9k ssh]$ sudo cp sshd_config sshd-mgmt_config\n\n# \u4ee5\u4e0b\u306e\u884c\u3092\u8ffd\u52a0\u3057\u307e\u3059\u3002\n\nPort 2222\nListenAddress 172.22.90.104\n\n\n\n\u6b21\u306e\u30b3\u30de\u30f3\u30c9\u3092\u5165\u529b\u3057\u307e\u3059\u3002\n\n\nsudo systemctl daemon-reload\nsudo systemctl start sshd-mgmt.service\nsudo systemctl status sshd-mgmt.service -l\n\n\n\n[guestshell@chefn9k ssh]$ sudo systemctl daemon-reload\n[guestshell@chefn9k ssh]$ sudo systemctl start sshd-mgmt.service\n[guestshell@chefn9k ssh]$ sudo systemctl status sshd-mgmt.service -l\nsshd-mgmt.service - OpenSSH server daemon\n   Loaded: loaded (/usr/lib/systemd/system/sshd-mgmt.service; disabled)\n   Active: active (running) since Fri 2017-03-10 02:17:28 UTC; 2s ago\n  Process: 1447 ExecStartPre=/usr/sbin/sshd-keygen (code=exited, status=0/SUCCESS)\n Main PID: 1449 (sshd)\n   CGroup: /system.slice/sshd-mgmt.service\n           \u2514\u25001449 /usr/sbin/sshd -f /etc/ssh/sshd-mgmt_config -D\n\nMar 10 02:17:28 chefn9k sshd-keygen[1447]: Executing: /usr/sbin/sshd-keygen\nMar 10 02:17:28 chefn9k ip[1449]: Executing: /sbin/ip netns exec management /usr/sbin/sshd -f /etc/ssh/sshd-mgmt_config -\nMar 10 02:17:28 chefn9k sshd[1449]: Server listening on 172.22.90.104 port 2222.\n\n# Port 2222 \u304c\u898b\u3048\u307e\u3057\u305f\u3002\n\n[guestshell@chefn9k ssh]$ ss -tnldp | grep 2222\ntcp    LISTEN     0      128        172.22.90.104:2222                  *:*\n\n\n\n\u4f59\u8ac7\uff1aN9K\u306eGuest Shell\u304b\u3089Cisco\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\n\n\u30b3\u30de\u30f3\u30c9\u306e\u5148\u982d\u306b\u3001\"sudo ip netns exec management\" \u307e\u305f\u306f \u30b7\u30e7\u30fc\u30c8\u30ab\u30c3\u30c8\u30b3\u30de\u30f3\u30c9 \"chvrf management\" \u3092\u3064\u3051\u308c\u3070OK\u3067\u3059\u3002\n\n\nN9K\u304b\u3089Chef Server\u306bPing\u3092\u5b9f\u884c\u3002\n\n\n\n[guestshell@chefn9k ssh]$ sudo ip netns exec management ping 172.22.150.100\nPING 172.22.150.100 (172.22.150.100) 56(84) bytes of data.\n64 bytes from 172.22.150.100: icmp_seq=1 ttl=64 time=0.338 ms\n64 bytes from 172.22.150.100: icmp_seq=2 ttl=64 time=0.310 ms\n64 bytes from 172.22.150.100: icmp_seq=3 ttl=64 time=0.368 ms\n64 bytes from 172.22.150.100: icmp_seq=4 ttl=64 time=0.330 ms\n\n[guestshell@chefn9k ssh]$ chvrf management ping 172.22.150.100\nPING 172.22.150.100 (172.22.150.100) 56(84) bytes of data.\n64 bytes from 172.22.150.100: icmp_seq=1 ttl=64 time=0.404 ms\n64 bytes from 172.22.150.100: icmp_seq=2 ttl=64 time=0.380 ms\n64 bytes from 172.22.150.100: icmp_seq=3 ttl=64 time=0.406 ms\n\n\nChef Workstation\u304b\u3089Chefuser01\u3067N9K\u306bSSH\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3057\u305f\u3002\n\ninohana@ino-ubuntu:~$ ssh -p 2222 chefuser01@172.22.90.104\nThe authenticity of host '[172.22.90.104]:2222 ([172.22.90.104]:2222)' can't be established.\nECDSA key fingerprint is b3:41:cd:e7:7a:5b:10:3a:8d:73:b5:18:4f:a4:41:bd.\nAre you sure you want to continue connecting (yes/no)? yes\nWarning: Permanently added '[172.22.90.104]:2222' (ECDSA) to the list of known hosts.\nchefuser01@172.22.90.104's password:\n[chefuser01@chefn9k ~]$\n\n\nChef Workstation\u306eHosts\u3092\u7de8\u96c6\u3057\u307e\u3059\u3002\n\n\nchefn9k\u3092\u8ffd\u52a0\u3002\n\n\n\ninohana@ino-ubuntu:~$ sudo vi /etc/hosts\ninohana@ino-ubuntu:~$ cat  /etc/hosts\n127.0.0.1       localhost\n172.29.150.100  ino-ubuntu.iselab.local ino-ubuntu\n172.22.90.104   chefn9k\n\n# The following lines are desirable for IPv6 capable hosts\n::1     localhost ip6-localhost ip6-loopback\nff02::1 ip6-allnodes\nff02::2 ip6-allrouters\n\n\nBootstrap\n\n\nChef Workstation\u304b\u3089Chef Node\u306b\u5bfe\u3057\u3066Bootstrap\u3057\u307e\u3059\u3002\n\nChef Node \u3068\u3057\u3066 Chef Server \u306b\u767b\u9332\u3002\n\n\n\n\u6012\u3089\u308c\u307e\u3057\u305f\u3002\n\nknife\u30b3\u30de\u30f3\u30c9\u306fchef-repo\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u914d\u4e0b\u3067\u306a\u3044\u3068\u4f7f\u3048\u307e\u305b\u3093\u3002\n\n\n\ninohana@ino-ubuntu:~$ knife bootstrap chefn9k -x chefuser01 --sudo -p 2222\nWARNING: No knife configuration file found\nERROR: You must pass a node name with -N when bootstrapping with user credentials\n\ninohana@ino-ubuntu:~$ knife bootstrap chefn9k -x chefuser01 --sudo -p 2222 -N chefn9k\nWARNING: No knife configuration file found\nWARN: Failed to read the private key /etc/chef/client.pem: #<Errno::ENOENT: No such file or directory @ rb_sysopen - /etc/chef/client.pem>\nERROR: Your private key could not be loaded from /etc/chef/client.pem\nCheck your configuration file and ensure that your private key is readable\n\ninohana@ino-ubuntu:~/chef-repo$ ls -la\ntotal 28\ndrwxrwxr-x 5 inohana inohana 4096 Mar 10 04:44 .\ndrwxr-xr-x 8 root    root    4096 Mar 10 05:09 ..\ndrwxr-xr-x 3 inohana root    4096 Mar  2 05:01 .chef\ndrwxrwxr-x 9 inohana inohana 4096 Mar 10 04:57 cookbooks\n-rw-rw-r-- 1 inohana inohana  486 Mar 10 04:43 .kitchen.yml\n-rw-rw-r-- 1 inohana inohana   57 Mar 10 04:43 README.md\ndrwxrwxr-x 3 inohana inohana 4096 Mar 10 04:43 test\n\n# knife.rb \u5b9a\u7fa9\u306f/chef-repo/.chef \u306e\u4e2d\u306b\u3042\u308a\u307e\u3059\u3002\n\ninohana@ino-ubuntu:~/chef-repo$ cd .chef\ninohana@ino-ubuntu:~/chef-repo/.chef$ ls\ninohana.pem  ise-validator.pem  knife.rb  trusted_certs\ninohana@ino-ubuntu:~/chef-repo/.chef$ ls -la\ntotal 24\ndrwxr-xr-x 3 inohana root    4096 Mar  2 05:01 .\ndrwxrwxr-x 5 inohana inohana 4096 Mar 10 04:44 ..\n-rw------- 1 inohana root    1678 Mar  2 04:53 inohana.pem\n-rw------- 1 inohana root    1678 Mar  2 04:53 ise-validator.pem\n-rw-r--r-- 1 inohana root     667 Mar  2 05:01 knife.rb\ndrwxr-xr-x 2 inohana root    4096 Mar  2 05:01 trusted_certs\n\n\nknife\u30b3\u30de\u30f3\u30c9\u6210\u529f\u3057\u307e\u3057\u305f\u3002\n\n\nN9K\u306eguestshell\u306b\u306f\u540cIP\u30a2\u30c9\u30ec\u30b9\u3001\u30dd\u30fc\u30c82222\u3067\u30a2\u30af\u30bb\u30b9\u53ef\u80fd\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002\n\n\n\ninohana@ino-ubuntu:~/repo$ knife bootstrap chefn9k -x chefuser01 --sudo -p 2222\nDoing old-style registration with the validation key at /home/inohana/repo/.chef/ise-validator.pem...\nDelete your validation key in order to use your user credentials instead\n\nConnecting to chefn9k\nchefuser01@chefn9k's password:\nchefn9k -----> Existing Chef installation detected\nchefn9k Starting the first Chef Client run...\nchefn9k [2017-03-10T02:38:10+00:00] WARN: Please install an English UTF-8 locale for Chef to use, falling back to C locale and disabling UTF-8 support.\nchefn9k Starting Chef Client, version 12.4.1\nchefn9k Creating a new client identity for chefn9k using the validator key.\nchefn9k resolving cookbooks for run list: []\nchefn9k Synchronizing Cookbooks:\nchefn9k Compiling Cookbooks...\nchefn9k [2017-03-10T02:38:15+00:00] WARN: Node chefn9k has an empty run list.\nchefn9k Converging 0 resources\nchefn9k\nchefn9k Running handlers:\nchefn9k Running handlers complete\nchefn9k Chef Client finished, 0/0 resources updated in 4.148158817 seconds\n\n\n\u4e8b\u524d\u306bHosts\u30d5\u30a1\u30a4\u30eb\u3092\u7de8\u96c6\u3057\u3001Chef Node\u306e\u540d\u524d\u89e3\u6c7a\u3067\u304d\u308b\u3088\u3046\u306b\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\ninohana@ino-ubuntu:~$ cat  /etc/hosts\n127.0.0.1       localhost\n172.29.150.100  ino-ubuntu.iselab.local ino-ubuntu\n172.22.90.104   chefn9k\n\n# The following lines are desirable for IPv6 capable hosts\n::1     localhost ip6-localhost ip6-loopback\nff02::1 ip6-allnodes\nff02::2 ip6-allrouters\n\n\n## Cisco N9K Guest Shell\u306bChef Client\u3092\u5c0e\u5165\n\n- USB\u306bRPM\u30d5\u30a1\u30a4\u30eb\u3092\u683c\u7d0d\u3057\u3001\u7269\u7406\u7684\u306bNexus\u306b\u5dee\u3057\u307e\u3057\u305f\u3002\n    - \u30b5\u30fc\u30d0\u306bRPM\u30d5\u30a1\u30a4\u30eb\u3092\u7f6e\u3044\u3066\u304a\u304dSCP\u3057\u3066\u3082OK\u3067\u3059\u3002\n- Nexus\u304b\u3089USB\u304c\u898b\u3048\u306a\u304f\u306a\u3063\u305f\u304c\u30d5\u30a9\u30fc\u30de\u30c3\u30c8\u3057\u305f\u3089\u8a8d\u8b58\u3057\u307e\u3057\u305f\u3002\n    - \u30d5\u30a1\u30a4\u30eb\u304c\u5168\u524a\u9664\u3055\u308c\u308b\u306e\u3067\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u8981\u3002\n- Chef Client\u3092[Cisco\u306e\u30b5\u30a4\u30c8](http://www.cisco.com/c/en/us/td/docs/switches/datacenter/nexus9000/sw/7-x/programmability/guide/b_Cisco_Nexus_9000_Series_NX-OS_Programmability_Guide_7x/b_Cisco_Nexus_9000_Series_NX-OS_Programmability_Guide_7x_chapter_01110.html)\u304b\u3089\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3059\u308b\u3068\u53e4\u3044\u30d0\u30fc\u30b8\u30e7\u30f3\u3092\u5165\u308c\u3055\u305b\u3089\u308c\u308b\u3088\u3046\u3067\u3059\u3002\u3002\u3002\n- \u65b0\u3057\u3044Chef Client\u306f[Chef\u306e\u30b5\u30a4\u30c8](https://downloads.chef.io/chef/stable/12.19.33#nexus)\u3067\u5165\u624b\u3057\u307e\u3057\u3087\u3046\u3002\u305f\u3060\u3057\u3001\u6700\u65b0Ver(\u73fe\u6642\u70b9\u306712.19.36)\u3067\u306fCisco NX-OS\u304c\u63d0\u4f9b\u3055\u308c\u3066\u3044\u307e\u305b\u3093\u3002\u3002\u3002\n\n\n```\nswitch# format ?\n  bootflash:  Format bootflash:\n  usb1:       Format usb1:\n  usb2:       Format usb2:\n\nThis command is going to erase the contents of your usb1:.\nDo you want to continue? (yes/no)  [y] y\n/etc/rc.d/include/probe_bootdev: line 106: /boot_dev: Permission denied\nFormatting usb1:\nFormatting completed\nswitch# switch# format usb1:2:\nThis command is going to erase the contents of your usb2:.\nDo you want to continue? (yes/no)  [y] y\n/etc/rc.d/include/probe_bootdev: line 106: /boot_dev: Permission denied\nFormatting usb2:\nCannot format usb2: Make sure the drive is inserted.\n\nswitch# dir usswitch# dir us\nusb1:  usb2:  \n\nswitch# switch# dir usb1:\n   41373894    Feb 27 15:22:12 2017  chef-12.4.1.cisco+20150826000706-1.nexus5.x\n86_64.rpm\n   43783906    Mar 01 14:59:30 2017  chef-12.4.1.cisco+20150826204615-1.el7.x86_\n64.rpm\n\nUsage for usb1://sup-local\n   85172224 bytes used\n16256557056 bytes free\n16341729280 bytes total\n\n```\n- USB\u306b\u683c\u7d0d\u3057\u305frpm\u3092bootflash\u306b\u30b3\u30d4\u30fc\u3002\n\n```\nswitch# switch# copy usb1:///chef-12.4.1.cisco+20150826usb1:///chef-12.4.1.cisco+201508?\n  usb1:///chef-12.4.1.cisco+20150826000706-1.nexus5.x86_64.rpm  \n  usb1:///chef-12.4.1.cisco+20150826204615-1.el7.x86_64.rpm     \n\nswitch# copy usb1:///chef-12.4.1.cisco+20150826204615-1.el7.x86_64.rpm bootflash:\n\nCopy progress 1% 442KBCopy progress 2% 884KBCopy progress 3% 1327KBCopy progress 4% 1753KBCopy progress 5% 2195KBCopy progress 6% 2637KBCopy progress 7% 3080KBCopy progress 8% 3506KBCopy progress 9% 3948KBCopy progress 10% 4390KBCopy progress 11% 4816KBCopy progress 12% 5259KBCopy progress 13% 5701KBCopy progress 14% 6144KBCopy progress 15% 6569KBCopy progress 16% 7012KBCopy progress 17% 7454KBCopy progress 18% 7897KBCopy progress 19% 8323KBCopy progress 20% 8765KBCopy progress 21% 9207KBCopy progress 22% 9633KBCopy progress 23% 10076KBCopy progress 24% 10518KBCopy progress 25% 10960KBCopy progress 26% 11386KBCopy progress 27% 11829KBCopy progress 28% 12271KBCopy progress 29% 12697KBCopy progress 30% 13139KBCopy progress 31% 13582KBCopy progress 32% 14024KBCopy progress 33% 14450KBCopy progress 34% 14893KBCopy progress 35% 15335KBCopy progress 36% 15777KBCopy progress 37% 16203KBCopy progress 38% 16646KBCopy progress 39% 17088KBCopy progress 40% 17514KBCopy progress 41% 17956KBCopy progress 42% 18399KBCopy progress 43% 18841KBCopy progress 44% 19267KBCopy progress 45% 19709KBCopy progress 46% 20152KBCopy progress 47% 20594KBCopy progress 48% 21020KBCopy progress 49% 21463KBCopy progress 50% 21905KBCopy progress 51% 22331KBCopy progress 52% 22773KBCopy progress 53% 23216KBCopy progress 54% 23658KBCopy progress 55% 24084KBCopy progress 56% 24526KBCopy progress 57% 24969KBCopy progress 58% 25395KBCopy progress 59% 25837KBCopy progress 60% 26279KBCopy progress 61% 26722KBCopy progress 62% 27148KBCopy progress 63% 27590KBCopy progress 64% 28033KBCopy progress 65% 28475KBCopy progress 66% 28901KBCopy progress 67% 29343KBCopy progress 68% 29786KBCopy progress 69% 30212KBCopy progress 70% 30654KBCopy progress 71% 31096KBCopy progress 72% 31539KBCopy progress 73% 31965KBCopy progress 74% 32407KBCopy progress 75% 32849KBCopy progress 76% 33275KBCopy progress 77% 33718KBCopy progress 78% 34160KBCopy progress 79% 34603KBCopy progress 80% 35028KBCopy progress 81% 35471KBCopy progress 82% 35913KBCopy progress 83% 36356KBCopy progress 84% 36782KBCopy progress 85% 37224KBCopy progress 86% 37666KBCopy progress 87% 38092KBCopy progress 88% 38535KBCopy progress 89% 38977KBCopy progress 90% 39419KBCopy progress 91% 39845KBCopy progress 92% 40288KBCopy progress 93% 40730KBCopy progress 94% 41172KBCopy progress 95% 41598KBCopy progress 96% 42041KBCopy progress 97% 42483KBCopy progress 98% 42909KBCopy progress 99% 43352KBCopy progress 100% 43783KB\nCopy complete, now saving to disk (please wait)...\n```\n\n- guestshell \u30b3\u30de\u30f3\u30c9\u306b\u3088\u308a N9K \u5185\u306eLinux\u306b\u30a2\u30af\u30bb\u30b9\u53ef\u80fd\u3002\n\n```\nswitch# guestshell\n[guestshell@chefn9k ~]$\n```\n\n- Bootflash\u306brpm\u304c\u898b\u3048\u308b\u3002\n\n```\n[guestshell@chefn9k ~]$ dir /bootflash/\n20170227_061436_poap_15827_init.log                lxc\nCpuUsage.Log                                       mem_log.txt.old.gz\nMemoryLog.65%_usage                                nxos.7.0.3.I4.5.bin\naci-n9000-dk9.11.3.1g.bin                          platform-sdk.cmd\naci-n9000-dk9.12.0.1m.bin                          scripts\nauto-s                                             urib_api_log.txt\nbios_bootup_scratch_not_cleared                    virt_strg_pool_bf_vdc_1\nchef-12.4.1.cisco+20150826204615-1.el7.x86_64.rpm  virtual-instance\ndisk_log.txt                                       virtual-instance.conf\nlost+found\n```\n- Bootflash\u304b\u3089guestshell\u4e0a\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306brpm\u30d5\u30a1\u30a4\u30eb\u3092\u79fb\u52d5\u3002\n\n```\n[root@chefn9k ~]# mkdir /usr/tmp/repo/chef/Packages\n[root@chefn9k ~]# cd /usr/tmp/repo/chef/Packages\n[root@chefn9k Packages]# cp /bootflash// chef-12.4.1.cisco+20150826204615-1.el7.x8 6_64.rpm /usr/tmp/repo/chef/Packages/\n[guestshell@chefn9k ~]$ ls -la /usr/tmp/repo/chef/Packages/\ntotal 42760\ndrwxr-xr-x 2 root root       60 Mar  1 07:18 .\ndrwxr-xr-x 3 root root       60 Mar  1 07:18 ..\n-rw-r--r-- 1 root root 43783906 Mar  1 07:18 chef-12.4.1.cisco+20150826204615-1.el7.x86_64.rpm\n\n```\n\n- \u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3002\n\n```\n[root@chefn9k Packages]# rpm -ivh chef-12.4.1.cisco+20150826204615-1.el7.x86_64. rpm\nPreparing...                                                            (100%)#                                 (100%)##                                (100%)###                               (100%)####                              (100%)#####                             (100%)######                            (100%)#######                           (100%)########                          (100%)#########                         (100%)##########                        (100%)###########                       (100%)############                      (100%)#############                     (100%)##############                    (100%)###############                   (100%)################                  (100%)#################                 (100%)##################                (100%)###################               (100%)####################              (100%)#####################             (100%)######################            (100%)#######################           (100%)########################          (100%)#########################         (100%)##########################        (100%)###########################       (100%)############################      (100%)#############################     (100%)##############################    (100%)###############################   (100%)################################  (100%)################################# (100%)################################# [100%]\nUpdating / installing...\n   1:chef-12.4.1.cisco+20150826204615-                                  (  1%)#                                 (  4%)##                                (  7%)###                               ( 10%)####                              ( 13%)#####                             ( 16%)######                            ( 19%)#######                           ( 22%)########                          ( 25%)#########                         ( 28%)##########                        ( 31%)###########                       ( 34%)############                      ( 37%)#############                     ( 40%)##############                    ( 43%)###############                   ( 46%)################                  ( 49%)#################                 ( 51%)##################                ( 54%)###################               ( 57%)####################              ( 60%)#####################             ( 63%)######################            ( 66%)#######################           ( 69%)########################          ( 72%)#########################         ( 75%)##########################        ( 78%)###########################       ( 81%)############################      ( 84%)#############################     ( 87%)##############################    ( 90%)###############################   ( 93%)################################  ( 96%)################################# ( 99%)################################# [100%]\nThank you for installing Chef!\n```\n\n## \u30e6\u30fc\u30b6\u8a2d\u5b9a\n\n- Chef Node(Chef Client) \u3067\u3042\u308b Cisco N9K \u306b\u30e6\u30fc\u30b6\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\u3053\u306e\u30e6\u30fc\u30b6\u306f Chef Workstation \u304b\u3089 Chef Node \u306b SSH \u3067\u30ed\u30b0\u30a4\u30f3\u3059\u308b\u969b\u306b\u4f7f\u7528\u3057\u307e\u3059\u3002\n\n```\n[guestshell@chefn9k ~]$ sudo useradd chefuser01\n[guestshell@chefn9k ~]$ sudo passwd chefuser01\nChanging password for user chefuser01.\nNew password:\nBAD PASSWORD: The password fails the dictionary check - it is based on a dictionary word\nRetype new password:\npasswd: all authentication tokens updated successfully.\n```\n\n- chefuser01 \u306b sudo \u7d4c\u7531\u3067 root \u3092\u4f7f\u3046\u6a29\u9650\u3092\u4ed8\u4e0e\u3057\u307e\u3059\u3002\n    - chefuser01 \u306e2\u884c\u3092\u8ffd\u52a0\u3002\n\n```\n## Allow root to run any commands anywhere\nroot    ALL=(ALL)       ALL\nchefuser01 ALL=(ALL) ALL\nchefuser01 ALL=(ALL) NOPASSWD: ALL\n```\n\n[\u53c2\u8003]\u3053\u306e\u624b\u9806\u3068\u540c\u3058\nhttp://qiita.com/inoko/items/09b9a15cb1a5c83fed34\n\n## Bootstrap\n\n- \u4e88\u3081\u3001Chef Node \u306b\u3066 Chef Workstation(ino-ubuntu) \u306e\u540d\u524d\u89e3\u6c7a\u304c\u3067\u304d\u308b\u3088\u3046\u306b\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n    - 172.22.150.100 \u3092\u8ffd\u52a0\u3002\n\n```\n[guestshell@chefn9k ~]$ cat /etc/hosts\n127.0.0.1 localhost guestshell\n172.22.150.100 ino-ubuntsu.iselab.local ino-ubuntu\n[guestshell@chefn9k ~]$\n```\n\n- \u6012\u3089\u308c\u307e\u3057\u305f\u3002\n\n```\ninohana@ino-ubuntu:~/repo/.chef$ knife bootstrap ino-ubuntu.iselab.local -x chefuser01 --sudo\nDoing old-style registration with the validation key at /home/inohana/repo/.chef/ise-validator.pem...\nDelete your validation key in order to use your user credentials instead\n\nConnecting to ino-ubuntu.iselab.local\nERROR: Errno::EACCES: Permission denied @ rb_sysopen - /home/inohana/repo/.chef/ise-validator.pem\n\ninohana@ino-ubuntu:~/repo/.chef$ ls -l\ntotal 16\n-rw------- 1 root root 1678 Mar  2 04:53 inohana.pem\n-rw------- 1 root root 1678 Mar  2 04:53 ise-validator.pem\n-rw-r--r-- 1 root root  667 Mar  2 05:01 knife.rb\ndrwxr-xr-x 2 root root 4096 Mar  2 05:01 trusted_certs\n```\n- ise-validator.pem \u306e\u6a29\u9650\u3092\u5909\u66f4\u3002\n\n```\ninohana@ino-ubuntu:~/repo/.chef$ sudo chown -R inohana *\n[sudo] password for inohana:\ninohana@ino-ubuntu:~/repo/.chef$ ls -l\ntotal 16\n-rw------- 1 inohana root 1678 Mar  2 04:53 inohana.pem\n-rw------- 1 inohana root 1678 Mar  2 04:53 ise-validator.pem\n-rw-r--r-- 1 inohana root  667 Mar  2 05:01 knife.rb\ndrwxr-xr-x 2 inohana root 4096 Mar  2 05:01 trusted_certs\n```\n\n- Workstation \u306e Hosts \u306b\u66f8\u3044\u3066\u3044\u308b\u306e\u306f N9K \u30b9\u30a4\u30c3\u30c1\u306e IP \u30a2\u30c9\u30ec\u30b9\u3067\u3042\u308b\u305f\u3081\u3001\u30a2\u30af\u30bb\u30b9\u3067\u304d\u306a\u3044\u6a21\u69d8\u3067\u3059\u3002\n\n```\ninohana@ino-ubuntu:~/repo/.chef$ knife bootstrap ino-ubuntu.iselab.local -x chefuser01 --sudo\nDoing old-style registration with the validation key at /home/inohana/repo/.chef/ise-validator.pem...\nDelete your validation key in order to use your user credentials instead\n\nConnecting to ino-ubuntu.iselab.local\nchefuser01@ino-ubuntu.iselab.local's password:\nchefuser01@ino-ubuntu.iselab.local's password:\nchefuser01@ino-ubuntu.iselab.local's password:\nFailed to authenticate chefuser01 - trying password auth\n\n# \u5165\u308c\u307e\u305b\u3093\uff01\n\nERROR: Net::SSH::AuthenticationFailed: Authentication failed for user \n```\n\n----------------------------------\n- \u4ee5\u4e0b\u30ea\u30f3\u30af\u306e\u300cPre-Configured SSHD Service\u300d\u3092\u307f\u3066\u304f\u3060\u3055\u3044\u3002\n    - [\u53c2\u8003\uff1aCisco Nexus 9000 Series NX-OS Programmability Guide, Release 7.x](\nhttp://www.cisco.com/c/en/us/td/docs/switches/datacenter/nexus9000/sw/7-x/programmability/guide/b_Cisco_Nexus_9000_Series_NX-OS_Programmability_Guide_7x/b_Cisco_Nexus_9000_Series_NX-OS_Programmability_Guide_7x_chapter_01100.html#task_7BC990F49E094646850F160AB0014D6A)\n    - \u30de\u30cb\u30e5\u30a2\u30eb\u306b\u3061\u3087\u3063\u3068\u8aa4\u690d\u304c\u3042\u308b\u306e\u3067\u6ce8\u610f\u3002\n \n----------------------------------\n\n- /usr/lib/systemd/system/sshd/service \u30d5\u30a1\u30a4\u30eb\u3092\u30b3\u30d4\u30fc\u3002\n    - \u30b3\u30d4\u30fc\u3057\u305f\u30d5\u30a1\u30a4\u30eb sshd-mgmt.service \u3092\u7de8\u96c6\u3002\n\n```\n\n[guestshell@chefn9k system]$ pwd\n/usr/lib/systemd/system\n\n[guestshell@chefn9k system]$ sudo cp sshd.service sshd-mgmt.service\n\n[guestshell@chefn9k system]$ ls -la sshd-*\n-rw-r--r-- 1 root root 375 Feb 27 06:13 sshd-cisco.service\n-rw-r--r-- 1 root root 307 Feb 27 06:13 sshd-keygen.service\n-rw-r--r-- 1 root root 316 Mar 10 02:01 sshd-mgmt.service\n\n[guestshell@chefn9k system]$ cat sshd-mgmt.service\n[Unit]\nDescription=OpenSSH server daemon\nAfter=network.target sshd-keygen.service\nWants=sshd-keygen.service\n\n[Service]\nEnvironmentFile=/etc/sysconfig/sshd\nExecStart=/usr/sbin/sshd -D $OPTIONS\nExecReload=/bin/kill -HUP $MAINPID\nKillMode=process\nRestart=on-failure\nRestartSec=42s\n\n[Install]\nWantedBy=multi-user.target\n\n# \u4ee5\u4e0b\u306e\u3088\u3046\u306b\u30d5\u30a1\u30a4\u30eb\u3092\u7de8\u96c6\u3057\u307e\u3059\u3002\n\n[guestshell@chefn9k system]$ cat sshd-mgmt.service\n[Unit]\nDescription=OpenSSH server daemon\nAfter=network.target sshd-keygen.service\nWants=sshd-keygen.service\n\n[Service]\nEnvironmentFile=/etc/sysconfig/sshd\nExecStartPre=/usr/sbin/sshd-keygen\nExecStart=/sbin/ip netns exec management /usr/sbin/sshd -f /etc/ssh/sshd-mgmt_config -D $OPTIONS\n#ExecStart=/usr/sbin/sshd -D $OPTIONS\nExecReload=/bin/kill -HUP $MAINPID\nKillMode=process\nRestart=on-failure\nRestartSec=42s\n\n[Install]\nWantedBy=multi-user.target\n```\n- /etc/ssh/sshd_config \u30d5\u30a1\u30a4\u30eb\u3092\u30b3\u30d4\u30fc\u3002\n    - \u30b3\u30d4\u30fc\u3057\u305f\u30d5\u30a1\u30a4\u30eb sshd-mgmt_config \u3092\u7de8\u96c6\u3002\n\n```\n[guestshell@chefn9k system]$ cd /etc/ssh\n[guestshell@chefn9k ssh]$ ls -la\ntotal 275\ndrwxr-xr-x  2 root root       1024 Mar  2 03:22 .\ndrwxr-xr-x 56 root root       5120 Mar  3 06:51 ..\n-rw-r--r--  1 root root     242153 Feb 27 06:13 moduli\n-rw-r--r--  1 root root       2208 Feb 27 06:13 ssh_config\n-rw-r-----  1 root ssh_keys    227 Feb 27 06:13 ssh_host_ecdsa_key\n-rw-r--r--  1 root root        162 Feb 27 06:13 ssh_host_ecdsa_key.pub\n-rw-r-----  1 root ssh_keys    387 Feb 27 06:13 ssh_host_ed25519_key\n-rw-r--r--  1 root root         82 Feb 27 06:13 ssh_host_ed25519_key.pub\n-rw-r-----  1 root ssh_keys   1679 Feb 27 06:13 ssh_host_rsa_key\n-rw-r--r--  1 root root        382 Feb 27 06:13 ssh_host_rsa_key.pub\n-rw-------  1 root root       4496 Feb 27 06:13 sshd_config\n-rw-------  1 root root       4492 Feb 27 06:13 sshd_config-cisco\n\n[guestshell@chefn9k ssh]$ sudo cp sshd_config sshd-mgmt_config\n\n# \u4ee5\u4e0b\u306e\u884c\u3092\u8ffd\u52a0\u3057\u307e\u3059\u3002\n  \nPort 2222\nListenAddress 172.22.90.104\n\n```\n\n- \u6b21\u306e\u30b3\u30de\u30f3\u30c9\u3092\u5165\u529b\u3057\u307e\u3059\u3002\n    - sudo systemctl daemon-reload\n    - sudo systemctl start sshd-mgmt.service\n    - sudo systemctl status sshd-mgmt.service -l\n    \n```\n[guestshell@chefn9k ssh]$ sudo systemctl daemon-reload\n[guestshell@chefn9k ssh]$ sudo systemctl start sshd-mgmt.service\n[guestshell@chefn9k ssh]$ sudo systemctl status sshd-mgmt.service -l\nsshd-mgmt.service - OpenSSH server daemon\n   Loaded: loaded (/usr/lib/systemd/system/sshd-mgmt.service; disabled)\n   Active: active (running) since Fri 2017-03-10 02:17:28 UTC; 2s ago\n  Process: 1447 ExecStartPre=/usr/sbin/sshd-keygen (code=exited, status=0/SUCCESS)\n Main PID: 1449 (sshd)\n   CGroup: /system.slice/sshd-mgmt.service\n           \u2514\u25001449 /usr/sbin/sshd -f /etc/ssh/sshd-mgmt_config -D\n\nMar 10 02:17:28 chefn9k sshd-keygen[1447]: Executing: /usr/sbin/sshd-keygen\nMar 10 02:17:28 chefn9k ip[1449]: Executing: /sbin/ip netns exec management /usr/sbin/sshd -f /etc/ssh/sshd-mgmt_config -\nMar 10 02:17:28 chefn9k sshd[1449]: Server listening on 172.22.90.104 port 2222.\n\n# Port 2222 \u304c\u898b\u3048\u307e\u3057\u305f\u3002\n\n[guestshell@chefn9k ssh]$ ss -tnldp | grep 2222\ntcp    LISTEN     0      128        172.22.90.104:2222                  *:*\n\n```\n\n### \u4f59\u8ac7\uff1aN9K\u306eGuest Shell\u304b\u3089Cisco\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\n- \u30b3\u30de\u30f3\u30c9\u306e\u5148\u982d\u306b\u3001\"sudo ip netns exec management\" \u307e\u305f\u306f \u30b7\u30e7\u30fc\u30c8\u30ab\u30c3\u30c8\u30b3\u30de\u30f3\u30c9 \"chvrf management\" \u3092\u3064\u3051\u308c\u3070OK\u3067\u3059\u3002\n    - N9K\u304b\u3089Chef Server\u306bPing\u3092\u5b9f\u884c\u3002\n\n```\n[guestshell@chefn9k ssh]$ sudo ip netns exec management ping 172.22.150.100\nPING 172.22.150.100 (172.22.150.100) 56(84) bytes of data.\n64 bytes from 172.22.150.100: icmp_seq=1 ttl=64 time=0.338 ms\n64 bytes from 172.22.150.100: icmp_seq=2 ttl=64 time=0.310 ms\n64 bytes from 172.22.150.100: icmp_seq=3 ttl=64 time=0.368 ms\n64 bytes from 172.22.150.100: icmp_seq=4 ttl=64 time=0.330 ms\n\n[guestshell@chefn9k ssh]$ chvrf management ping 172.22.150.100\nPING 172.22.150.100 (172.22.150.100) 56(84) bytes of data.\n64 bytes from 172.22.150.100: icmp_seq=1 ttl=64 time=0.404 ms\n64 bytes from 172.22.150.100: icmp_seq=2 ttl=64 time=0.380 ms\n64 bytes from 172.22.150.100: icmp_seq=3 ttl=64 time=0.406 ms\n```\n- Chef Workstation\u304b\u3089Chefuser01\u3067N9K\u306bSSH\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3057\u305f\u3002\n\n```\ninohana@ino-ubuntu:~$ ssh -p 2222 chefuser01@172.22.90.104\nThe authenticity of host '[172.22.90.104]:2222 ([172.22.90.104]:2222)' can't be established.\nECDSA key fingerprint is b3:41:cd:e7:7a:5b:10:3a:8d:73:b5:18:4f:a4:41:bd.\nAre you sure you want to continue connecting (yes/no)? yes\nWarning: Permanently added '[172.22.90.104]:2222' (ECDSA) to the list of known hosts.\nchefuser01@172.22.90.104's password:\n[chefuser01@chefn9k ~]$\n```\n\n- Chef Workstation\u306eHosts\u3092\u7de8\u96c6\u3057\u307e\u3059\u3002\n    - chefn9k\u3092\u8ffd\u52a0\u3002\n\n```\ninohana@ino-ubuntu:~$ sudo vi /etc/hosts\ninohana@ino-ubuntu:~$ cat  /etc/hosts\n127.0.0.1       localhost\n172.29.150.100  ino-ubuntu.iselab.local ino-ubuntu\n172.22.90.104   chefn9k\n\n# The following lines are desirable for IPv6 capable hosts\n::1     localhost ip6-localhost ip6-loopback\nff02::1 ip6-allnodes\nff02::2 ip6-allrouters\n```\n\n## Bootstrap\n\n- Chef Workstation\u304b\u3089Chef Node\u306b\u5bfe\u3057\u3066Bootstrap\u3057\u307e\u3059\u3002\n    - Chef Node \u3068\u3057\u3066 Chef Server \u306b\u767b\u9332\u3002\n\n- \u6012\u3089\u308c\u307e\u3057\u305f\u3002\n    - knife\u30b3\u30de\u30f3\u30c9\u306fchef-repo\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u914d\u4e0b\u3067\u306a\u3044\u3068\u4f7f\u3048\u307e\u305b\u3093\u3002\n\n```\ninohana@ino-ubuntu:~$ knife bootstrap chefn9k -x chefuser01 --sudo -p 2222\nWARNING: No knife configuration file found\nERROR: You must pass a node name with -N when bootstrapping with user credentials\n\ninohana@ino-ubuntu:~$ knife bootstrap chefn9k -x chefuser01 --sudo -p 2222 -N chefn9k\nWARNING: No knife configuration file found\nWARN: Failed to read the private key /etc/chef/client.pem: #<Errno::ENOENT: No such file or directory @ rb_sysopen - /etc/chef/client.pem>\nERROR: Your private key could not be loaded from /etc/chef/client.pem\nCheck your configuration file and ensure that your private key is readable\n```\n\n```\ninohana@ino-ubuntu:~/chef-repo$ ls -la\ntotal 28\ndrwxrwxr-x 5 inohana inohana 4096 Mar 10 04:44 .\ndrwxr-xr-x 8 root    root    4096 Mar 10 05:09 ..\ndrwxr-xr-x 3 inohana root    4096 Mar  2 05:01 .chef\ndrwxrwxr-x 9 inohana inohana 4096 Mar 10 04:57 cookbooks\n-rw-rw-r-- 1 inohana inohana  486 Mar 10 04:43 .kitchen.yml\n-rw-rw-r-- 1 inohana inohana   57 Mar 10 04:43 README.md\ndrwxrwxr-x 3 inohana inohana 4096 Mar 10 04:43 test\n\n# knife.rb \u5b9a\u7fa9\u306f/chef-repo/.chef \u306e\u4e2d\u306b\u3042\u308a\u307e\u3059\u3002\n\ninohana@ino-ubuntu:~/chef-repo$ cd .chef\ninohana@ino-ubuntu:~/chef-repo/.chef$ ls\ninohana.pem  ise-validator.pem  knife.rb  trusted_certs\ninohana@ino-ubuntu:~/chef-repo/.chef$ ls -la\ntotal 24\ndrwxr-xr-x 3 inohana root    4096 Mar  2 05:01 .\ndrwxrwxr-x 5 inohana inohana 4096 Mar 10 04:44 ..\n-rw------- 1 inohana root    1678 Mar  2 04:53 inohana.pem\n-rw------- 1 inohana root    1678 Mar  2 04:53 ise-validator.pem\n-rw-r--r-- 1 inohana root     667 Mar  2 05:01 knife.rb\ndrwxr-xr-x 2 inohana root    4096 Mar  2 05:01 trusted_certs\n```\n\n- knife\u30b3\u30de\u30f3\u30c9\u6210\u529f\u3057\u307e\u3057\u305f\u3002\n    - N9K\u306eguestshell\u306b\u306f\u540cIP\u30a2\u30c9\u30ec\u30b9\u3001\u30dd\u30fc\u30c82222\u3067\u30a2\u30af\u30bb\u30b9\u53ef\u80fd\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002\n\n```\ninohana@ino-ubuntu:~/repo$ knife bootstrap chefn9k -x chefuser01 --sudo -p 2222\nDoing old-style registration with the validation key at /home/inohana/repo/.chef/ise-validator.pem...\nDelete your validation key in order to use your user credentials instead\n\nConnecting to chefn9k\nchefuser01@chefn9k's password:\nchefn9k -----> Existing Chef installation detected\nchefn9k Starting the first Chef Client run...\nchefn9k [2017-03-10T02:38:10+00:00] WARN: Please install an English UTF-8 locale for Chef to use, falling back to C locale and disabling UTF-8 support.\nchefn9k Starting Chef Client, version 12.4.1\nchefn9k Creating a new client identity for chefn9k using the validator key.\nchefn9k resolving cookbooks for run list: []\nchefn9k Synchronizing Cookbooks:\nchefn9k Compiling Cookbooks...\nchefn9k [2017-03-10T02:38:15+00:00] WARN: Node chefn9k has an empty run list.\nchefn9k Converging 0 resources\nchefn9k\nchefn9k Running handlers:\nchefn9k Running handlers complete\nchefn9k Chef Client finished, 0/0 resources updated in 4.148158817 seconds\n```\n- \u4e8b\u524d\u306bHosts\u30d5\u30a1\u30a4\u30eb\u3092\u7de8\u96c6\u3057\u3001Chef Node\u306e\u540d\u524d\u89e3\u6c7a\u3067\u304d\u308b\u3088\u3046\u306b\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\n```\ninohana@ino-ubuntu:~$ cat  /etc/hosts\n127.0.0.1       localhost\n172.29.150.100  ino-ubuntu.iselab.local ino-ubuntu\n172.22.90.104   chefn9k\n\n# The following lines are desirable for IPv6 capable hosts\n::1     localhost ip6-localhost ip6-loopback\nff02::1 ip6-allnodes\nff02::2 ip6-allrouters\n\n```\n", "tags": ["chef", "Nexus", "Cisco"]}