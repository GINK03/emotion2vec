{"context": "\n\n\u306f\u3058\u3081\u306b\n\u304a\u3068\u3068\u3044\u304f\u3089\u3044\u307e\u3067\uff0c\u4eca\u65e5\u306e\u8a18\u4e8b\u306e\u4e88\u5b9a\u306f\u300cBhyve \u306e\u4e0a\u3067 BitVisor \u306f\u52d5\u304f\u306e\u304b?\u300d\u306b\u306a\u3063\u3066\u3044\u305f\u3068\u601d\u3044\u307e\u3059\uff0e\n\u304c\uff0c\u3088\u304f\u3088\u304f\u8003\u3048\u305f\u3089\uff0cBhyve \u306f Nested Virtualization \u5bfe\u5fdc\u3057\u3066\u306a\u3044\u306e\u3067\uff0c\u81ea\u5206\u3067 Bhyve \u3092\u6539\u9020\u3057\u3066 Nested Virtualization \u5bfe\u5fdc\u3055\u305b\u3067\u3082\u3057\u306a\u3044\u9650\u308a\uff0c\u52d5\u304f\u308f\u3051\u306a\u3044\u3058\u3083\u3093...\u3068\u3044\u3046\u3053\u3068\u306b\u4e00\u6628\u65e5\u6c17\u3065\u3044\u305f\u306e\u3067\u5909\u3048\u307e\u3057\u305f\uff0e\n\u4e88\u7d04\u3057\u305f\u3068\u304d\u306e\u50d5\u306f\u5bdd\u307c\u3051\u3066\u3044\u305f\u306e\u304b\uff0c\u306f\u305f\u307e\u305f\u9154\u3063\u3066\u3044\u305f\u306e\u304b...\n\u3068\u3044\u3046\u308f\u3051\u3067\uff0c\u4eca\u65e5\u306e\u8a18\u4e8b\u306f HyperV \u4e0a\u3067 BitVisor \u304c\u52d5\u304f\u304b\u3069\u3046\u304b\u8a66\u3057\u3066\u307f\u305f\u3068\u3044\u3046\u8a18\u4e8b\u3067\u3059\uff0e\n\n\u5148\u306b\u7d50\u8ad6\u3092\u8a00\u3046\u3068\n\u52d5\u304b\u306a\u304b\u3063\u305f...\n\n\u691c\u8a3c\u74b0\u5883\n\u50d5\u306e\u691c\u8a3c\u74b0\u5883\u306f\uff0c\u4ee5\u4e0b\u306e\u901a\u308a\u3067\u3059\uff0e\n\n\u30de\u30b7\u30f3: Thinkpad X220\nWindows: Windows 10 Pro Insider Preview Build 14931\nL2 Guest: Ubuntu Server 16.04.1 \n\n\n\u6e96\u5099\n\nWindows \u306e\u7528\u610f\nHyper-V \u306f Windows \u306b\u7d44\u307f\u8fbc\u307e\u308c\u3066\u3044\u308b\u4eee\u60f3\u30de\u30b7\u30f3\u30e2\u30cb\u30bf\u3067\u3059\uff0e\nLinux \u3067\u3044\u3046\u3068\u3053\u308d\u306e\uff0cQEMU/KVM \u7684\u306a\u7acb\u3061\u4f4d\u7f6e\u3060\u3068\u601d\u3044\u307e\u3059\uff0e\n\u305d\u3046\u3044\u3046\u308f\u3051\u306a\u306e\u3067\uff0c\u307e\u305a\u306f Windows \u304c\u5fc5\u8981\u3067\u3059\uff0e\n\u305f\u3060\u3057\uff0cWindows \u3067\u3082 Home \u30a8\u30c7\u30a3\u30b7\u30e7\u30f3\u306f\u30c0\u30e1\u3067\uff0cWindows Server 2008 \u4ee5\u964d\u3068\u304b Windows 8 \u4ee5\u964d\u306e Pro \u3068\u304b Enterprise \u3068\u304b Education \u3068\u304b\u304c\u5fc5\u8981\u3067\u3059\uff0e\n\u5bfe\u5fdc\u30d0\u30fc\u30b8\u30e7\u30f3\u306e\u516c\u5f0f\u60c5\u5831\u304c\u3069\u3053\u306b\u3042\u308b\u306e\u304b\u3088\u304f\u308f\u304b\u308a\u307e\u305b\u3093... (Wikipedia \u306b\u306f\u66f8\u3044\u3066\u3042\u3063\u305f\u304c\u51fa\u5178\u306a\u3044\u3057...)\n\nHyper-V \u3092\u6709\u52b9\u5316\n\u300cWindows \u306e\u6a5f\u80fd\u306e\u6709\u52b9\u5316\u307e\u305f\u306f\u7121\u52b9\u5316\u300d\u306b\u3042\u308b\u300cHyper-V\u300d\u3063\u307d\u3044\u3082\u306e\u3092\u30c1\u30a7\u30c3\u30af\uff0e\nWindows \u306e\u518d\u8d77\u52d5\u304c\u5fc5\u8981\u3060\u3063\u305f\u304b\u3082\u3057\u308c\u306a\u3044\u3067\u3059(\u899a\u3048\u3066\u306a\u3044)\n\nVM \u306e\u4f5c\u6210\n\u306a\u3093\u304b\u9069\u5f53\u306b\u3084\u3063\u305f\u3089\u3067\u304d\u305f\u306e\u3067\uff0c\u9069\u5f53\u306b\u3084\u308a\u307e\u3057\u3087\u3046\uff0e\n\u308f\u304b\u3089\u306a\u304b\u3063\u305f\u3089\u304d\u3063\u3068\u3050\u30fc\u3050\u308b\u5148\u751f\u304c\u6559\u3048\u3066\u304f\u308c\u307e\u3059\uff0e\nUEFI \u30d6\u30fc\u30c8\u306b\u3059\u308b\u304b\uff0cBIOS \u30d6\u30fc\u30c8\u306b\u3059\u308b\u304b\u9078\u3076\u3068\u3053\u308d\u304c\u3042\u308a\u307e\u3059\u304c\uff0c\u4eca\u56de\u306f BIOS \u30d6\u30fc\u30c8\u306b\u3057\u307e\u3057\u305f\uff0e\nVM \u306b\u306f Ubuntu Server 16.04.1 \u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3066\uff0cHyper-V \u306e VM \u306f\u3067\u304d\u3042\u304c\u308a\uff0e\n\nNested Virtualization \u306e\u6709\u52b9\u5316\nhttp://www.altaro.com/hyper-v/nested-virtualization-hyper-v-windows-server-2016/\u3000\n\u306e\u30da\u30fc\u30b8\u306e\u4e2d\u3054\u308d\u306b\u3042\u308b\u30d3\u30c7\u30aa\u901a\u308a\u306b\u3084\u308c\u3070\u3044\u3051\u308b\u3068\u601d\u3044\u307e\u3059\uff0e\nVM \u306f\u4e00\u5ea6\u505c\u6b62\u3057\u306a\u3044\u3068\u8a2d\u5b9a\u5909\u66f4\u3067\u304d\u306a\u3044\u306e\u3067\uff0c\u4e00\u5ea6\u505c\u6b62\u3057\u307e\u3057\u3087\u3046\uff0e\n\nBitVisor \u30d3\u30eb\u30c9\n\u7279\u306b\u5909\u308f\u3063\u305f\u3053\u3068\u306f\u3057\u3066\u306a\u3044\u306e\u3067\uff0c\u3056\u3063\u304f\u308a\u66f8\u304f\uff0e\n\nVM \u306b\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u305f Ubuntu \u306b Mercurial, Make, GCC, build-essential \u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\nBitBucket \u306e\u30ea\u30dd\u30b8\u30c8\u30ea\u3092\u30af\u30ed\u30fc\u30f3\nmake config \u3067\u8981\u3089\u306a\u3055\u305d\u3046\u306a\u30aa\u30d7\u30b7\u30e7\u30f3\u3092\u5916\u3059\nmake \n/boot/ \u306b bitvisor.elf \u3092\u30b3\u30d4\u30fc\ngrub \u306e\u30a8\u30f3\u30c8\u30ea\u30fc\u3092\u8ffd\u52a0\nupdate-grub2,\nreboot\n\n\nLet's Try\n\u3068\u308a\u3042\u3048\u305a\uff0c\u52d5\u304b\u3057\u3066\u307f\u308b\uff0e\n\u3070\u3070\u30fc\u3093\n\n... \u666e\u901a\u306b\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u305f\u3060\u3051\u3058\u3083\u52d5\u304b\u306a\u3044\u3063\u307d\u3044...\n\n\u3069\u3053\u3067\u6b62\u307e\u3063\u305f\u306e\u304b\n\u30a8\u30e9\u30fc\u30e1\u30c3\u30bb\u30fc\u30b8\u304b\u3089\uff0c\u8d77\u52d5\u306e\u304b\u306a\u308a\u521d\u671f\u306e\u6bb5\u968e\u3067\u6b62\u307e\u3063\u305f\u3053\u3068\u304c\u5bdf\u305b\u3089\u308c\u307e\u3059\uff0e\ndbgsh \u3082\u7acb\u3061\u4e0a\u304c\u3089\u306a\u3044\u306e\u3067\uff0c\u8d77\u52d5\u51e6\u7406\u306e\u9014\u4e2d\u306b while (1) \u5165\u308c\u3066 panic \u3059\u308b\u304b\u7121\u9650\u30eb\u30fc\u30d7\u3067\u6b62\u307e\u308b\u304b\u306e Try & Error \u3092\u3084\u308a\u307e\u304f\u308b\uff0e\n(Hyper-V \u306e\u30c7\u30d0\u30c3\u30b0\u6a5f\u80fd\u304b\u4f55\u304b\u3042\u308b\u3093\u3067\u3059\u304b\u306d? \u50d5\u306f\u3088\u304f\u77e5\u3089\u306a\u3044\u306e\u3067\u4eca\u56de\u306f\u305d\u3046\u3044\u3046\u306e\u4e00\u5207\u4f7f\u3063\u3066\u306a\u3044\u3067\u3059...)\n\u3067\uff0c30\u56de\u304f\u3089\u3044\u30b3\u30f3\u30d1\u30a4\u30eb\u3068\u518d\u8d77\u52d5\u3092\u7e70\u308a\u8fd4\u3057\u305f\u7d50\u679c\uff0cIA32_STAR \u3068\u3044\u3046 MSR \u306b\u4f55\u304b\u66f8\u3053\u3046\u3068\u3057\u3066\u3044\u308b\u3068\u3053\u308d\u3067\u6b7b\u3093\u3067\u308b\u3063\u307d\u3044\u3053\u3068\u304c\u5206\u304b\u3063\u305f\uff0e\nhttps://bitbucket.org/bitvisor/bitvisor/src/76db0ae4260b398f939486faedbd6dedb3e79b5f/core/process.c?at=default&fileviewer=file-view-default#process.c-140\nIA32_STAR \u306f 64 bit \u30b7\u30b9\u30c6\u30e0\u3067\u30e2\u30c0\u30f3\u306a\u30b7\u30b9\u30c6\u30e0\u30b3\u30fc\u30eb\u547c\u3073\u51fa\u3057\u6a5f\u69cb\u3092\u4f7f\u3046\u306e\u306b\u5fc5\u8981\uff0e\n\u3057\u304b\u3057\uff0c\u4eca\u306f\u3068\u308a\u3042\u3048\u305a\u52d5\u3044\u3066\u307b\u3057\u3044\u306e\u3067\uff0c32 bit \u3067\u30b3\u30f3\u30d1\u30a4\u30eb\u3057\u3066\u307f\u308b\uff0e\n\n32bit BitVisor \u3092\u30d3\u30eb\u30c9\n\u518d\u5ea6\uff0cmake config\uff0c64-bit \u30aa\u30d7\u30b7\u30e7\u30f3\u3092\u5916\u3059\uff0e\n\u3053\u308c\u3067\uff0c\u30d3\u30eb\u30c9\u3059\u308b\u3068\uff0c\u306a\u3093\u3068\u30d3\u30eb\u30c9\u304c\u901a\u3089\u306a\u3044\uff0e\n\u4ee5\u4e0b\u306e\u30d1\u30c3\u30c1\u3092\u5f53\u3066\u308b\u3068\u30d3\u30eb\u30c9\u304c\u901a\u308b\uff0e\ndiff --git a/core/cpu_interpreter.c b/core/cpu_interpreter.c\n--- a/core/cpu_interpreter.c\n+++ b/core/cpu_interpreter.c\n@@ -2507,8 +2507,8 @@\n             : \"=&rm\" (newflags) \\\n             , \"=&rm\" (dst) \\\n             : \"i\" (~flagmask) \\\n-            , \"r\" (flags & flagmask) \\\n-            , \"r\" (src) \\\n+            , \"q\" (flags & flagmask) \\\n+            , \"q\" (src) \\\n             , \"1\" (dst) \\\n             : \"cc\"); \\\n        newflags = (flags & ~flagmask) | (newflags & flagmask); \\\n\n\nLet't Try (32 bit \u7248)\n\u3070\u3070\u30fc\u3093\n\n\u3084\u3063\u3071\u308a\u52d5\u304b\u306a\u3044\u305e...\n\u3051\u3069\uff0c64bit \u306e BitVisor \u3088\u308a\u306f\u51e6\u7406\u304c\u9032\u3093\u3060\u307f\u305f\u3044.\n\"VM entry failed. Error 8.\" \u306e\u610f\u5473\u3092\u8abf\u3079\u3066\u307f\u308b\uff0e\nIntel SDM \u306b\u3088\u308b\u3068\uff0cError 8 \u306f \"VM entry with invalid host-state field(s)\" \u3063\u3066\u3053\u3068\u3089\u3057\u3044...\nhost-state \u3063\u3066\u3044\u3063\u305f\u3044\u4f55\u500b\u3042\u308b\u3068\u601d\u3063\u3066\u308b\u306d\u3093...\n\u3081\u3052\u305a\u306b\u8abf\u3079\u308b\u305f\u3081\u306b\uff0c\u30c7\u30d0\u30c3\u30b0\u7528\u306e\u30b7\u30a7\u30eb\u306b\u5165\u308d\u3046\u3068\u30ad\u30fc\u30dc\u30fc\u30c9\u306e s \u62bc\u3057\u3066\u3082\u53cd\u5fdc\u304c\u306a\u3044...\n\u4f59\u8ac7:\n\u3042\u3068\u3067\uff0cUbuntu \u304b\u3089\u6319\u52d5\u3092\u898b\u308b\u9650\u308a\uff0c\u3069\u3046\u3082 PS/2 \u3067\u3082 USB \u3067\u3082\u306a\u3044\uff0c\u4e0d\u601d\u8b70\u306a\u529b\u3067\u30ad\u30fc\u5165\u529b\u304c\u30b2\u30b9\u30c8\u306b\u914d\u9001\u3055\u308c\u3066\u3044\u308b\u3063\u307d\u3044\u6319\u52d5\u3092\u3057\u3066\u3044\u308b\uff0e\n($ cat /proc/interrupts \u3057\u3066\u307f\u308b\u3068\uff0cHypervisor callback interrupt \u3068\u304b\u8a00\u3046\u306e\u304c\u5165\u3063\u3066\u3044\u3066\uff0c\u305f\u3076\u3093\u3053\u308c\u3058\u3083\u306a\u3044\u304b\u3068\u601d\u3046) \n\n\u30ed\u30b0\u304c\u898b\u305f\u3044\u306e\u3067\uff0cCOM \u30dd\u30fc\u30c8\u3092\u3064\u306a\u3054\u3046\n\u4f55\u306f\u3068\u3082\u3042\u308c\uff0c\u3053\u308c\u3067\u306f\u4e0d\u4fbf\u306a\u306e\u3067\uff0cCOM\u30dd\u30fc\u30c8(\u30b7\u30ea\u30a2\u30eb\u30dd\u30fc\u30c8)\u7d4c\u7531\u3067 BitVisor \u306e\u30ed\u30b0\u3092\u51fa\u3059\uff0e\n\nBitVisor\u5074\n\n\nmake config \u3057\u3066 TTY_SERIAL \u3092\u6709\u52b9\u306b\u3057\u3066\u304a\u304f\n\u3064\u3044\u3067\u306b\uff0c\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u30c7\u30d0\u30c3\u30b0\u30d7\u30ea\u30f3\u30c8\u3092\u8db3\u3057\u3066\u307f\u305f\uff0e\n\n\n\ndiff --git a/core/vt_main.c b/core/vt_main.c\n--- a/core/vt_main.c\n+++ b/core/vt_main.c\n@@ -389,12 +389,47 @@\n    return VT__VMEXIT;\n }\n\n+#define DBG(i) do { \\\n+           ulong tmp; \\\n+           asm_vmread (i, &tmp);\\\n+           printf ( #i \"==0x%lx\\n\", tmp);\\\n+       } while(0)\n+\n+static void\n+debug_print_host_state ()\n+{\n+   DBG (VMCS_HOST_ES_SEL);\n+   DBG (VMCS_HOST_CS_SEL);\n+   DBG (VMCS_HOST_SS_SEL);\n+   DBG (VMCS_HOST_DS_SEL);\n+   DBG (VMCS_HOST_FS_SEL);\n+   DBG (VMCS_HOST_GS_SEL);\n+   DBG (VMCS_HOST_TR_SEL);\n+   DBG (VMCS_HOST_IA32_PAT);\n+   DBG (VMCS_HOST_IA32_PAT_HIGH);\n+   DBG (VMCS_HOST_IA32_EFER);\n+   DBG (VMCS_HOST_IA32_EFER_HIGH);\n+   DBG (VMCS_HOST_IA32_SYSENTER_CS);\n+   DBG (VMCS_HOST_CR0);\n+   DBG (VMCS_HOST_CR3);\n+   DBG (VMCS_HOST_CR4);\n+   DBG (VMCS_HOST_FS_BASE);\n+   DBG (VMCS_HOST_GS_BASE);\n+   DBG (VMCS_HOST_TR_BASE);\n+   DBG (VMCS_HOST_GDTR_BASE);\n+   DBG (VMCS_HOST_IDTR_BASE);\n+   DBG (VMCS_HOST_IA32_SYSENTER_ESP);\n+   DBG (VMCS_HOST_IA32_SYSENTER_EIP);\n+   DBG (VMCS_HOST_RSP);\n+   DBG (VMCS_HOST_RIP);\n+}\n static void\n vt__vm_run_first (void)\n {\n    enum vt__status status;\n    ulong errnum;\n\n+   debug_print_host_state ();\n    status = call_vt__vmlaunch ();\n    if (status != VT__VMEXIT) {\n        asm_vmread (VMCS_VM_INSTRUCTION_ERR, &errnum);\n@@ -845,6 +880,7 @@\n    ulong exit_reason;\n\n    asm_vmread (VMCS_EXIT_REASON, &exit_reason);\n+   printexitreason (exit_reason);\n    if (exit_reason & EXIT_REASON_VMENTRY_FAILURE_BIT)\n        panic (\"Fatal error: VM Entry failure.\");\n    switch (exit_reason & EXIT_REASON_MASK) {\n\n\nHyper-V \u5074\n\n\nHyper-V \u306e VM \u8a2d\u5b9a\u3067\uff0cCOM \u3092\u8a2d\u5b9a\n\u540d\u524d\u4ed8\u304d\u30d1\u30a4\u30d7\u3068\u3084\u3089\u306b\u540d\u524d\u3092\u4ed8\u3051\u308b\uff0e\n\u9069\u5f53\u306b\uff0cbitvisor \u3068\u304b\u540d\u524d\u3092\u4ed8\u3051\u308b\uff0e\nTeraTerm \u3092 \"\u7ba1\u7406\u8005\u3068\u3057\u3066\u5b9f\u884c\"\n\u30db\u30b9\u30c8\u306e\u3068\u3053\u308d\u306b\uff0c\\.\\pipe\\bitvisor \u3068\u5165\u529b\n\n\n\n\n\n\n\u30ed\u30b0\u51fa\u3057\u3066\u307f\u305f\n> log\nStarting BitVisor...\nCopyright (c) 2007, 2008 University of Tsukuba\nAll rights reserved.\n1073282048 bytes (1023 MiB) RAM available.\nVMM will use 0x37C00000-0x3FC00000 (128 MiB).\nACPI DMAR not found.\nFACS address 0x3FFFF000\nModule not found.\nProcessor 0 (BSP)\nProcessor 1 (AP)\n..................................................                                                  oooooooooooooooooooooooooooooooooooooooooooooooooo                                                  OOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOO\nDisable \\_SB_.PCI0.SBRG.UAR2._DIS\nDisable \\_SB_.PCI0.SBRG.UAR1._DIS\nUsing VMX.\nProcessor 0 2497709136 Hz\nProcessor 1 2497717520 Hz\nLoading drivers.\nPCI device concealer registered\nPCI device monitor registered\nPCI: finding devices...\nPCI: 5 devices found\nStarting a virtual machine.\nVMCS_HOST_ES_SEL==0x10\nVMCS_HOST_ES_SEL==0x10\nVMCS_HOST_CS_SEL==0x8\nVMCS_HOST_CS_SEL==0x8\nVMCS_HOST_SS_SEL==0x10\nVMCS_HOST_SS_SEL==0x10\nVMCS_HOST_DS_SEL==0x10\nVMCS_HOST_DS_SEL==0x10\nVMCS_HOST_FS_SEL==0x10\nVMCS_HOST_FS_SEL==0x10\nVMCS_HOST_GS_SEL==0x40\nVMCS_HOST_GS_SEL==0x40\nVMCS_HOST_TR_SEL==0x60\nVMCS_HOST_TR_SEL==0x60\nVMCS_HOST_IA32_PAT==0x289\nVMCS_HOST_IA32_PAT==0xec8348e5\nVMCS_HOST_IA32_PAT_HIGH==0x850fc085\nVMCS_HOST_IA32_PAT_HIGH==0x8b486510\nVMCS_HOST_IA32_EFER==0x0\nVMCS_HOST_IA32_EFER==0x0\nVMCS_HOST_IA32_EFER_HIGH==0x0\nVMCS_HOST_IA32_EFER_HIGH==0x0\nVMCS_HOST_IA32_SYSENTER_CS==0x8\nVMCS_HOST_IA32_SYSENTER_CS==0x8\nVMCS_HOST_CR0==0x80000039\nVMCS_HOST_CR0==0x80000039\nVMCS_HOST_CR3==0x38009000\nVMCS_HOST_CR3==0x37fed000\nVMCS_HOST_CR4==0x20a0\nVMCS_HOST_CR4==0x20a0\nVMCS_HOST_FS_BASE==0x0\nVMCS_HOST_FS_BASE==0x0\nVMCS_HOST_GS_BASE==0x402adde0\nVMCS_HOST_GS_BASE==0x403ee300\nVMCS_HOST_TR_BASE==0x402adf24\nVMCS_HOST_TR_BASE==0x403f6504\nVMCS_HOST_GDTR_BASE==0x402ade24\nVMCS_HOST_GDTR_BASE==0x403f6404\nVMCS_HOST_IDTR_BASE==0x401bc600\nVMCS_HOST_IDTR_BASE==0x401bc600\nVMCS_HOST_IA32_SYSENTER_ESP==0x402adde0\nVMCS_HOST_IA32_SYSENTER_ESP==0x403f8000\nVMCS_HOST_IA32_SYSENTER_EIP==0x40136000\nVMCS_HOST_IA32_SYSENTER_EIP==0x40136000\nVMCS_HOST_RSP==0xdeadbeef\nVMCS_HOST_RSP==0xdeadbeef\nVMCS_HOST_RIP==0xdeadbeef\npanic(CPU0): Fatal error: VM entry failed. Error 8\nVMCS_HOST_RIP==0xdeadbeef\nCR0 80000039    CR2 00000000    CR3 37FED000    CR4 000020A0\nRFLAGS 00200006  GDTR 402ADE24+000000FF  IDTR 401BC600+00000800\nstackdump: 40145564 40145564 8005AC1 401BC600 0 402AE164 D 40124162 D 403FFE7C 40125B6A 40135C7B 401241BF 40135C90 D 402AE164 0 0 4011D47C 401241BF 4012415B 403FFF08 40125B8B 402A81A0 400 401470AB 40124965 4012415B 401241BF 403FFF08 40124BDE 402A81A0\nbacktrace: 40124162 40125B6A 40135C7B 401241BF 40135C90 4011D47C 401241BF 4012415B 40125B8B 40124965 4012415B 401241BF 40124BDE 40124D00 40132702 40132564 40125B2D 401310D7 40130DB5 4013253D 4011D68F 40125AC1 4011D68F 40125B0A 4012C8B5 40125B2D 4012E1AD 4011E7A3 4011B6EF 4011E59C 4010D87C\nGuest state and registers of cpu 0 ------------\nRAX 00000001    RCX 00000000    RDX 00000000    RBX 00000000\nRSP 00004FC0    RBP 00000000    RSI 00000000    RDI 00000000\nR8  00000000    R9  00000000    R10 00000000    R11 00000000\nR12 00000000    R13 00000000    R14 00000000    R15 00000000\nCR0 00000030    CR2 00000000    CR3 00000000    CR4 00000000\nACR   ES 000000F3 CS 000000F3 SS 000000F3 DS 000000F3 FS 000000F3 GS 000000F3\nLIMIT ES 0000FFFF CS 0000FFFF SS 0000FFFF DS 0000FFFF FS 0000FFFF GS 0000FFFF\nBASE  ES 00000000 CS 00000000 SS 00000000 DS 00000000 FS 00000000 GS 00000000\nSEL   ES 00000000 CS 00000000 SS 00000000 DS 00000000 FS 00000000 GS 00000000\nRIP 00005016  RFLAGS 00000002  GDTR 402ADE24+000000FF  IDTR 00000000+000003FF\nEFER 00000000\nExit reason: -1958193920=0x8B485500 (unknown error)  VM entry failure\nExit qualification 00E82878  VM exit interrupt information C0314507\nVM entry interruption-information 00000000  errcode 00000000  instlen 00000000\nVM exit errcode 0000DFB9  VMCS IDTR 00000000+00000000   VMCS RFLAGS 00020002\nre=1 pg=0 sw:en=0x0 es=0x0 cs=0x0 ss=0x0 ds=0x0 fs=0x0 gs=0x0\n------------------------------------------------\npanic(CPU1): Fatal error: VM entry failed. Error 8\nCR0 80000039    CR2 00000000    CR3 38009000    CR4 000020A0\nRFLAGS 00200002  GDTR 403F6404+000000FF  IDTR 401BC600+00000800\nstackdump: 40145564 40145564 8005AC1 401BC600 1 403F6744 D 40124162 40407EEC 40407E5C 1 40135C7B 401241BF 40135C90 D 403F6744 1 1 4011D47C 401241BF 4012415B 40407EE8 40125B2D 4014570E 40407E98 402A7DD3 40124965 4012415B 401241BF 40407EE8 40124BB9 4014570E\nbacktrace: 40124162 40135C7B 401241BF 40135C90 4011D47C 401241BF 4012415B 40125B2D 40124965 4012415B 401241BF 40124BB9 40124D00 40132702 40132564 40125B2D 401310D7 40130DB5 4013253D 4011F560 4013332E 4011F51F 4011F560 4013332E 40130939 4011E7A3 4011B6EF 4011E55C 4011E57A 4011E55C 4010D4D5\nGuest state and registers of cpu 1 ------------\nRAX 00000000    RCX 00000000    RDX 00000000    RBX 00000000\nRSP 00000000    RBP 00000000    RSI 00000000    RDI 00000000\nR8  00000000    R9  00000000    R10 00000000    R11 00000000\nR12 00000000    R13 00000000    R14 00000000    R15 00000000\nCR0 00000030    CR2 00000000    CR3 00000000    CR4 00000000\nACR   ES 000000F3 CS 000000F3 SS 000000F3 DS 000000F3 FS 000000F3 GS 000000F3\nLIMIT ES 0000FFFF CS 0000FFFF SS 0000FFFF DS 0000FFFF FS 0000FFFF GS 0000FFFF\nBASE  ES 00000000 CS 00000000 SS 00000000 DS 00000000 FS 00000000 GS 00000000\nSEL   ES 00000000 CS 00000000 SS 00000000 DS 00000000 FS 00000000 GS 00000000\nRIP 00000000  RFLAGS 00000002  GDTR 403F6404+000000FF  IDTR 00000000+000003FF\nEFER 00000000\nExit reason: -1924530177=0x8D49FFFF (unknown error)  VM entry failure\nExit qualification 00E80000  VM exit interrupt information 0002208D\nVM entry interruption-information 00000000  errcode 00000000  instlen 00000000\nVM exit errcode 4CF63100  VMCS IDTR 00000000+00000000   VMCS RFLAGS 00020002\nre=1 pg=0 sw:en=0x0 es=0x0 cs=0x0 ss=0x0 ds=0x0 fs=0x0 gs=0x0\n------------------------------------------------\npanic(CPU0): Fatal error: VM entry failed. Error 8\n\nVMCS_HOST_* \u304c\u54042\u884c\u305a\u3064\u51fa\u3066\u308b\u306e\u306f\uff0c\u4eee\u60f3CPU\u30922\u3064\u5272\u308a\u5f53\u3066\u3066\u308b\u304b\u3089\uff0e\n\n\u529b\u5c3d\u304d\u305f\n\u306e\u3067\uff0c\u3042\u3068\u306f\u8ab0\u304b\u9811\u5f35\u3063\u3066\u307f\u3066\u304f\u3060\u3055\u3044\uff0e\n\u6642\u9593\u304c\u3042\u308c\u3070\u30ea\u30d9\u30f3\u30b8\u3059\u308b\u304b\u3082\uff0e\n32bit \u30d3\u30eb\u30c9\u3057\u305f\u308a\u30c7\u30d0\u30c3\u30b0\u30d7\u30ea\u30f3\u30bf\u8db3\u3057\u305f\u30b3\u30fc\u30c9\u3092\uff0chttps://bitbucket.org/ftakaaki/bitvisor-try-to-run-on-hyperv \u306b\u7f6e\u3044\u305f\u306e\u3067\uff0c\u898b\u305f\u3044\u4eba\u306f\u3069\u3046\u305e\uff0e\n\n\u304a\u307e\u3051: 64bit \u30b2\u30b9\u30c8 OS \u306f\u52d5\u304b\u306a\u3044?\nBitVisor \u306f\u52d5\u304b\u306a\u304b\u3063\u305f\u3051\u3069\uff0cVMWare \u3092\u52d5\u304b\u3057\u305f\u4eba\u306f\u3044\u308b\u3089\u3057\u3044\uff0e\n\u4ee5\u4e0b\u306e\u30d5\u30a9\u30fc\u30e9\u30e0\u306e\u3084\u308a\u53d6\u308a\u304b\u3089\u5bdf\u3059\u308b\u306b\uff0c64bit \u30b2\u30b9\u30c8\u306f\u52d5\u304b\u306a\u3044\u3089\u3057\u3044\uff0e\n\u8a66\u3057\u3066\u307f\u305f\u3044\u4eba\u306f\uff0c32 bit \u30b2\u30b9\u30c8\u3067\u6311\u6226\u3057\u305f\u65b9\u304c\u3044\u3044\u304b\u3082\uff0e\nhttps://social.technet.microsoft.com/Forums/systemcenter/en-US/aa10f817-5a46-4c5d-b041-b11abd3c46a8/does-hyper-v-support-nested-vm?forum=virtualmachingmgrhyperv\n\n\u304a\u308f\u308a\u306b\nBitVisor \u306f\uff0cHyper-V \u306e\u4e0a\u3067\uff0c\u52d5\u304b\u306a\u304b\u3063\u305f\uff0e\n# \u306f\u3058\u3081\u306b\n\u304a\u3068\u3068\u3044\u304f\u3089\u3044\u307e\u3067\uff0c\u4eca\u65e5\u306e\u8a18\u4e8b\u306e\u4e88\u5b9a\u306f\u300cBhyve \u306e\u4e0a\u3067 BitVisor \u306f\u52d5\u304f\u306e\u304b?\u300d\u306b\u306a\u3063\u3066\u3044\u305f\u3068\u601d\u3044\u307e\u3059\uff0e\n\u304c\uff0c\u3088\u304f\u3088\u304f\u8003\u3048\u305f\u3089\uff0cBhyve \u306f Nested Virtualization \u5bfe\u5fdc\u3057\u3066\u306a\u3044\u306e\u3067\uff0c\u81ea\u5206\u3067 Bhyve \u3092\u6539\u9020\u3057\u3066 Nested Virtualization \u5bfe\u5fdc\u3055\u305b\u3067\u3082\u3057\u306a\u3044\u9650\u308a\uff0c\u52d5\u304f\u308f\u3051\u306a\u3044\u3058\u3083\u3093...\u3068\u3044\u3046\u3053\u3068\u306b\u4e00\u6628\u65e5\u6c17\u3065\u3044\u305f\u306e\u3067\u5909\u3048\u307e\u3057\u305f\uff0e\n\u4e88\u7d04\u3057\u305f\u3068\u304d\u306e\u50d5\u306f\u5bdd\u307c\u3051\u3066\u3044\u305f\u306e\u304b\uff0c\u306f\u305f\u307e\u305f\u9154\u3063\u3066\u3044\u305f\u306e\u304b...\n\n\u3068\u3044\u3046\u308f\u3051\u3067\uff0c\u4eca\u65e5\u306e\u8a18\u4e8b\u306f HyperV \u4e0a\u3067 BitVisor \u304c\u52d5\u304f\u304b\u3069\u3046\u304b\u8a66\u3057\u3066\u307f\u305f\u3068\u3044\u3046\u8a18\u4e8b\u3067\u3059\uff0e\n\n# \u5148\u306b\u7d50\u8ad6\u3092\u8a00\u3046\u3068\n\u52d5\u304b\u306a\u304b\u3063\u305f...\n\n# \u691c\u8a3c\u74b0\u5883\n\n\u50d5\u306e\u691c\u8a3c\u74b0\u5883\u306f\uff0c\u4ee5\u4e0b\u306e\u901a\u308a\u3067\u3059\uff0e\n\n* \u30de\u30b7\u30f3: Thinkpad X220\n* Windows: Windows 10 Pro Insider Preview Build 14931\n* L2 Guest: Ubuntu Server 16.04.1 \n\n# \u6e96\u5099\n## Windows \u306e\u7528\u610f\nHyper-V \u306f Windows \u306b\u7d44\u307f\u8fbc\u307e\u308c\u3066\u3044\u308b\u4eee\u60f3\u30de\u30b7\u30f3\u30e2\u30cb\u30bf\u3067\u3059\uff0e\nLinux \u3067\u3044\u3046\u3068\u3053\u308d\u306e\uff0cQEMU/KVM \u7684\u306a\u7acb\u3061\u4f4d\u7f6e\u3060\u3068\u601d\u3044\u307e\u3059\uff0e\n\u305d\u3046\u3044\u3046\u308f\u3051\u306a\u306e\u3067\uff0c\u307e\u305a\u306f Windows \u304c\u5fc5\u8981\u3067\u3059\uff0e\n\u305f\u3060\u3057\uff0cWindows \u3067\u3082 Home \u30a8\u30c7\u30a3\u30b7\u30e7\u30f3\u306f\u30c0\u30e1\u3067\uff0cWindows Server 2008 \u4ee5\u964d\u3068\u304b Windows 8 \u4ee5\u964d\u306e Pro \u3068\u304b Enterprise \u3068\u304b Education \u3068\u304b\u304c\u5fc5\u8981\u3067\u3059\uff0e\n\u5bfe\u5fdc\u30d0\u30fc\u30b8\u30e7\u30f3\u306e\u516c\u5f0f\u60c5\u5831\u304c\u3069\u3053\u306b\u3042\u308b\u306e\u304b\u3088\u304f\u308f\u304b\u308a\u307e\u305b\u3093... (Wikipedia \u306b\u306f\u66f8\u3044\u3066\u3042\u3063\u305f\u304c\u51fa\u5178\u306a\u3044\u3057...)\n\n\n## Hyper-V \u3092\u6709\u52b9\u5316\n\u300cWindows \u306e\u6a5f\u80fd\u306e\u6709\u52b9\u5316\u307e\u305f\u306f\u7121\u52b9\u5316\u300d\u306b\u3042\u308b\u300cHyper-V\u300d\u3063\u307d\u3044\u3082\u306e\u3092\u30c1\u30a7\u30c3\u30af\uff0e\nWindows \u306e\u518d\u8d77\u52d5\u304c\u5fc5\u8981\u3060\u3063\u305f\u304b\u3082\u3057\u308c\u306a\u3044\u3067\u3059(\u899a\u3048\u3066\u306a\u3044)\n\n## VM \u306e\u4f5c\u6210\n\u306a\u3093\u304b\u9069\u5f53\u306b\u3084\u3063\u305f\u3089\u3067\u304d\u305f\u306e\u3067\uff0c\u9069\u5f53\u306b\u3084\u308a\u307e\u3057\u3087\u3046\uff0e\n\u308f\u304b\u3089\u306a\u304b\u3063\u305f\u3089\u304d\u3063\u3068\u3050\u30fc\u3050\u308b\u5148\u751f\u304c\u6559\u3048\u3066\u304f\u308c\u307e\u3059\uff0e\n\nUEFI \u30d6\u30fc\u30c8\u306b\u3059\u308b\u304b\uff0cBIOS \u30d6\u30fc\u30c8\u306b\u3059\u308b\u304b\u9078\u3076\u3068\u3053\u308d\u304c\u3042\u308a\u307e\u3059\u304c\uff0c\u4eca\u56de\u306f BIOS \u30d6\u30fc\u30c8\u306b\u3057\u307e\u3057\u305f\uff0e\n\nVM \u306b\u306f Ubuntu Server 16.04.1 \u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3066\uff0cHyper-V \u306e VM \u306f\u3067\u304d\u3042\u304c\u308a\uff0e\n\n## Nested Virtualization \u306e\u6709\u52b9\u5316\nhttp://www.altaro.com/hyper-v/nested-virtualization-hyper-v-windows-server-2016/\u3000\n\n\u306e\u30da\u30fc\u30b8\u306e\u4e2d\u3054\u308d\u306b\u3042\u308b\u30d3\u30c7\u30aa\u901a\u308a\u306b\u3084\u308c\u3070\u3044\u3051\u308b\u3068\u601d\u3044\u307e\u3059\uff0e\nVM \u306f\u4e00\u5ea6\u505c\u6b62\u3057\u306a\u3044\u3068\u8a2d\u5b9a\u5909\u66f4\u3067\u304d\u306a\u3044\u306e\u3067\uff0c\u4e00\u5ea6\u505c\u6b62\u3057\u307e\u3057\u3087\u3046\uff0e\n\n## BitVisor \u30d3\u30eb\u30c9\n\u7279\u306b\u5909\u308f\u3063\u305f\u3053\u3068\u306f\u3057\u3066\u306a\u3044\u306e\u3067\uff0c\u3056\u3063\u304f\u308a\u66f8\u304f\uff0e\n\n1. VM \u306b\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u305f Ubuntu \u306b Mercurial, Make, GCC, build-essential \u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n2. BitBucket \u306e\u30ea\u30dd\u30b8\u30c8\u30ea\u3092\u30af\u30ed\u30fc\u30f3\n3. make config \u3067\u8981\u3089\u306a\u3055\u305d\u3046\u306a\u30aa\u30d7\u30b7\u30e7\u30f3\u3092\u5916\u3059\n4. make \n5. /boot/ \u306b bitvisor.elf \u3092\u30b3\u30d4\u30fc\n6. grub \u306e\u30a8\u30f3\u30c8\u30ea\u30fc\u3092\u8ffd\u52a0\n7. update-grub2,\n8. reboot\n\n# Let's Try\n\u3068\u308a\u3042\u3048\u305a\uff0c\u52d5\u304b\u3057\u3066\u307f\u308b\uff0e\n\u3070\u3070\u30fc\u3093\n\n![image](https://qiita-image-store.s3.amazonaws.com/0/59503/914b0d30-f122-b5bb-007e-45836dceb6ea.png)\n\n... \u666e\u901a\u306b\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u305f\u3060\u3051\u3058\u3083\u52d5\u304b\u306a\u3044\u3063\u307d\u3044...\n\n## \u3069\u3053\u3067\u6b62\u307e\u3063\u305f\u306e\u304b\n\n\u30a8\u30e9\u30fc\u30e1\u30c3\u30bb\u30fc\u30b8\u304b\u3089\uff0c\u8d77\u52d5\u306e\u304b\u306a\u308a\u521d\u671f\u306e\u6bb5\u968e\u3067\u6b62\u307e\u3063\u305f\u3053\u3068\u304c\u5bdf\u305b\u3089\u308c\u307e\u3059\uff0e\ndbgsh \u3082\u7acb\u3061\u4e0a\u304c\u3089\u306a\u3044\u306e\u3067\uff0c\u8d77\u52d5\u51e6\u7406\u306e\u9014\u4e2d\u306b while (1) \u5165\u308c\u3066 panic \u3059\u308b\u304b\u7121\u9650\u30eb\u30fc\u30d7\u3067\u6b62\u307e\u308b\u304b\u306e Try & Error \u3092\u3084\u308a\u307e\u304f\u308b\uff0e\n(Hyper-V \u306e\u30c7\u30d0\u30c3\u30b0\u6a5f\u80fd\u304b\u4f55\u304b\u3042\u308b\u3093\u3067\u3059\u304b\u306d? \u50d5\u306f\u3088\u304f\u77e5\u3089\u306a\u3044\u306e\u3067\u4eca\u56de\u306f\u305d\u3046\u3044\u3046\u306e\u4e00\u5207\u4f7f\u3063\u3066\u306a\u3044\u3067\u3059...)\n\u3067\uff0c30\u56de\u304f\u3089\u3044\u30b3\u30f3\u30d1\u30a4\u30eb\u3068\u518d\u8d77\u52d5\u3092\u7e70\u308a\u8fd4\u3057\u305f\u7d50\u679c\uff0cIA32_STAR \u3068\u3044\u3046 MSR \u306b\u4f55\u304b\u66f8\u3053\u3046\u3068\u3057\u3066\u3044\u308b\u3068\u3053\u308d\u3067\u6b7b\u3093\u3067\u308b\u3063\u307d\u3044\u3053\u3068\u304c\u5206\u304b\u3063\u305f\uff0e\n\nhttps://bitbucket.org/bitvisor/bitvisor/src/76db0ae4260b398f939486faedbd6dedb3e79b5f/core/process.c?at=default&fileviewer=file-view-default#process.c-140\n\n\nIA32_STAR \u306f 64 bit \u30b7\u30b9\u30c6\u30e0\u3067\u30e2\u30c0\u30f3\u306a\u30b7\u30b9\u30c6\u30e0\u30b3\u30fc\u30eb\u547c\u3073\u51fa\u3057\u6a5f\u69cb\u3092\u4f7f\u3046\u306e\u306b\u5fc5\u8981\uff0e\n\u3057\u304b\u3057\uff0c\u4eca\u306f\u3068\u308a\u3042\u3048\u305a\u52d5\u3044\u3066\u307b\u3057\u3044\u306e\u3067\uff0c32 bit \u3067\u30b3\u30f3\u30d1\u30a4\u30eb\u3057\u3066\u307f\u308b\uff0e\n\n\n## 32bit BitVisor \u3092\u30d3\u30eb\u30c9\n\u518d\u5ea6\uff0cmake config\uff0c64-bit \u30aa\u30d7\u30b7\u30e7\u30f3\u3092\u5916\u3059\uff0e\n\u3053\u308c\u3067\uff0c\u30d3\u30eb\u30c9\u3059\u308b\u3068\uff0c\u306a\u3093\u3068\u30d3\u30eb\u30c9\u304c\u901a\u3089\u306a\u3044\uff0e\n\u4ee5\u4e0b\u306e\u30d1\u30c3\u30c1\u3092\u5f53\u3066\u308b\u3068\u30d3\u30eb\u30c9\u304c\u901a\u308b\uff0e\n\n``` diff\ndiff --git a/core/cpu_interpreter.c b/core/cpu_interpreter.c\n--- a/core/cpu_interpreter.c\n+++ b/core/cpu_interpreter.c\n@@ -2507,8 +2507,8 @@\n \t\t     : \"=&rm\" (newflags) \\\n \t\t     , \"=&rm\" (dst) \\\n \t\t     : \"i\" (~flagmask) \\\n-\t\t     , \"r\" (flags & flagmask) \\\n-\t\t     , \"r\" (src) \\\n+\t\t     , \"q\" (flags & flagmask) \\\n+\t\t     , \"q\" (src) \\\n \t\t     , \"1\" (dst) \\\n \t\t     : \"cc\"); \\\n \t\tnewflags = (flags & ~flagmask) | (newflags & flagmask); \\\n```\n\n# Let't Try (32 bit \u7248)\n\u3070\u3070\u30fc\u3093\n\n![image](https://qiita-image-store.s3.amazonaws.com/0/59503/8b293f11-75d3-c7c6-bfc0-46aaad26681d.png)\n\n\u3084\u3063\u3071\u308a\u52d5\u304b\u306a\u3044\u305e...\n\u3051\u3069\uff0c64bit \u306e BitVisor \u3088\u308a\u306f\u51e6\u7406\u304c\u9032\u3093\u3060\u307f\u305f\u3044.\n\n\"VM entry failed. Error 8.\" \u306e\u610f\u5473\u3092\u8abf\u3079\u3066\u307f\u308b\uff0e\nIntel SDM \u306b\u3088\u308b\u3068\uff0cError 8 \u306f \"VM entry with invalid host-state field(s)\" \u3063\u3066\u3053\u3068\u3089\u3057\u3044...\nhost-state \u3063\u3066\u3044\u3063\u305f\u3044\u4f55\u500b\u3042\u308b\u3068\u601d\u3063\u3066\u308b\u306d\u3093...\n\n\u3081\u3052\u305a\u306b\u8abf\u3079\u308b\u305f\u3081\u306b\uff0c\u30c7\u30d0\u30c3\u30b0\u7528\u306e\u30b7\u30a7\u30eb\u306b\u5165\u308d\u3046\u3068\u30ad\u30fc\u30dc\u30fc\u30c9\u306e s \u62bc\u3057\u3066\u3082\u53cd\u5fdc\u304c\u306a\u3044...\n\n\u4f59\u8ac7:\n\u3042\u3068\u3067\uff0cUbuntu \u304b\u3089\u6319\u52d5\u3092\u898b\u308b\u9650\u308a\uff0c\u3069\u3046\u3082 PS/2 \u3067\u3082 USB \u3067\u3082\u306a\u3044\uff0c\u4e0d\u601d\u8b70\u306a\u529b\u3067\u30ad\u30fc\u5165\u529b\u304c\u30b2\u30b9\u30c8\u306b\u914d\u9001\u3055\u308c\u3066\u3044\u308b\u3063\u307d\u3044\u6319\u52d5\u3092\u3057\u3066\u3044\u308b\uff0e\n(`$ cat /proc/interrupts` \u3057\u3066\u307f\u308b\u3068\uff0cHypervisor callback interrupt \u3068\u304b\u8a00\u3046\u306e\u304c\u5165\u3063\u3066\u3044\u3066\uff0c\u305f\u3076\u3093\u3053\u308c\u3058\u3083\u306a\u3044\u304b\u3068\u601d\u3046) \n\n## \u30ed\u30b0\u304c\u898b\u305f\u3044\u306e\u3067\uff0cCOM \u30dd\u30fc\u30c8\u3092\u3064\u306a\u3054\u3046\n\u4f55\u306f\u3068\u3082\u3042\u308c\uff0c\u3053\u308c\u3067\u306f\u4e0d\u4fbf\u306a\u306e\u3067\uff0cCOM\u30dd\u30fc\u30c8(\u30b7\u30ea\u30a2\u30eb\u30dd\u30fc\u30c8)\u7d4c\u7531\u3067 BitVisor \u306e\u30ed\u30b0\u3092\u51fa\u3059\uff0e\n\n* BitVisor\u5074\n    * make config \u3057\u3066 TTY_SERIAL \u3092\u6709\u52b9\u306b\u3057\u3066\u304a\u304f\n    * \u3064\u3044\u3067\u306b\uff0c\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u30c7\u30d0\u30c3\u30b0\u30d7\u30ea\u30f3\u30c8\u3092\u8db3\u3057\u3066\u307f\u305f\uff0e\n\n``` diff\ndiff --git a/core/vt_main.c b/core/vt_main.c\n--- a/core/vt_main.c\n+++ b/core/vt_main.c\n@@ -389,12 +389,47 @@\n \treturn VT__VMEXIT;\n }\n \n+#define DBG(i)\tdo { \\\n+\t\t\tulong tmp; \\\n+\t\t\tasm_vmread (i, &tmp);\\\n+\t\t\tprintf ( #i \"==0x%lx\\n\", tmp);\\\n+\t\t} while(0)\n+\n+static void\n+debug_print_host_state ()\n+{\n+\tDBG (VMCS_HOST_ES_SEL);\n+\tDBG (VMCS_HOST_CS_SEL);\n+\tDBG (VMCS_HOST_SS_SEL);\n+\tDBG (VMCS_HOST_DS_SEL);\n+\tDBG (VMCS_HOST_FS_SEL);\n+\tDBG (VMCS_HOST_GS_SEL);\n+\tDBG (VMCS_HOST_TR_SEL);\n+\tDBG (VMCS_HOST_IA32_PAT);\n+\tDBG (VMCS_HOST_IA32_PAT_HIGH);\n+\tDBG (VMCS_HOST_IA32_EFER);\n+\tDBG (VMCS_HOST_IA32_EFER_HIGH);\n+\tDBG (VMCS_HOST_IA32_SYSENTER_CS);\n+\tDBG (VMCS_HOST_CR0);\n+\tDBG (VMCS_HOST_CR3);\n+\tDBG (VMCS_HOST_CR4);\n+\tDBG (VMCS_HOST_FS_BASE);\n+\tDBG (VMCS_HOST_GS_BASE);\n+\tDBG (VMCS_HOST_TR_BASE);\n+\tDBG (VMCS_HOST_GDTR_BASE);\n+\tDBG (VMCS_HOST_IDTR_BASE);\n+\tDBG (VMCS_HOST_IA32_SYSENTER_ESP);\n+\tDBG (VMCS_HOST_IA32_SYSENTER_EIP);\n+\tDBG (VMCS_HOST_RSP);\n+\tDBG (VMCS_HOST_RIP);\n+}\n static void\n vt__vm_run_first (void)\n {\n \tenum vt__status status;\n \tulong errnum;\n \n+\tdebug_print_host_state ();\n \tstatus = call_vt__vmlaunch ();\n \tif (status != VT__VMEXIT) {\n \t\tasm_vmread (VMCS_VM_INSTRUCTION_ERR, &errnum);\n@@ -845,6 +880,7 @@\n \tulong exit_reason;\n \n \tasm_vmread (VMCS_EXIT_REASON, &exit_reason);\n+\tprintexitreason (exit_reason);\n \tif (exit_reason & EXIT_REASON_VMENTRY_FAILURE_BIT)\n \t\tpanic (\"Fatal error: VM Entry failure.\");\n \tswitch (exit_reason & EXIT_REASON_MASK) {\n```\n\n\n* Hyper-V \u5074\n    * Hyper-V \u306e VM \u8a2d\u5b9a\u3067\uff0cCOM \u3092\u8a2d\u5b9a\n    * \u540d\u524d\u4ed8\u304d\u30d1\u30a4\u30d7\u3068\u3084\u3089\u306b\u540d\u524d\u3092\u4ed8\u3051\u308b\uff0e\n    * \u9069\u5f53\u306b\uff0cbitvisor \u3068\u304b\u540d\u524d\u3092\u4ed8\u3051\u308b\uff0e\n    * TeraTerm \u3092 \"\u7ba1\u7406\u8005\u3068\u3057\u3066\u5b9f\u884c\"\n    * \u30db\u30b9\u30c8\u306e\u3068\u3053\u308d\u306b\uff0c\\\\.\\pipe\\bitvisor \u3068\u5165\u529b\n\n\n![com-setting.PNG](https://qiita-image-store.s3.amazonaws.com/0/59503/8af97fe1-42c8-e38d-090a-52b60e806f67.png)\n\n![image](https://qiita-image-store.s3.amazonaws.com/0/59503/e329c776-bced-fa99-3074-3550d2e0230f.png)\n\n\n## \u30ed\u30b0\u51fa\u3057\u3066\u307f\u305f\n\n```\n> log\nStarting BitVisor...\nCopyright (c) 2007, 2008 University of Tsukuba\nAll rights reserved.\n1073282048 bytes (1023 MiB) RAM available.\nVMM will use 0x37C00000-0x3FC00000 (128 MiB).\nACPI DMAR not found.\nFACS address 0x3FFFF000\nModule not found.\nProcessor 0 (BSP)\nProcessor 1 (AP)\n..................................................                                                  oooooooooooooooooooooooooooooooooooooooooooooooooo                                                  OOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOO\nDisable \\_SB_.PCI0.SBRG.UAR2._DIS\nDisable \\_SB_.PCI0.SBRG.UAR1._DIS\nUsing VMX.\nProcessor 0 2497709136 Hz\nProcessor 1 2497717520 Hz\nLoading drivers.\nPCI device concealer registered\nPCI device monitor registered\nPCI: finding devices...\nPCI: 5 devices found\nStarting a virtual machine.\nVMCS_HOST_ES_SEL==0x10\nVMCS_HOST_ES_SEL==0x10\nVMCS_HOST_CS_SEL==0x8\nVMCS_HOST_CS_SEL==0x8\nVMCS_HOST_SS_SEL==0x10\nVMCS_HOST_SS_SEL==0x10\nVMCS_HOST_DS_SEL==0x10\nVMCS_HOST_DS_SEL==0x10\nVMCS_HOST_FS_SEL==0x10\nVMCS_HOST_FS_SEL==0x10\nVMCS_HOST_GS_SEL==0x40\nVMCS_HOST_GS_SEL==0x40\nVMCS_HOST_TR_SEL==0x60\nVMCS_HOST_TR_SEL==0x60\nVMCS_HOST_IA32_PAT==0x289\nVMCS_HOST_IA32_PAT==0xec8348e5\nVMCS_HOST_IA32_PAT_HIGH==0x850fc085\nVMCS_HOST_IA32_PAT_HIGH==0x8b486510\nVMCS_HOST_IA32_EFER==0x0\nVMCS_HOST_IA32_EFER==0x0\nVMCS_HOST_IA32_EFER_HIGH==0x0\nVMCS_HOST_IA32_EFER_HIGH==0x0\nVMCS_HOST_IA32_SYSENTER_CS==0x8\nVMCS_HOST_IA32_SYSENTER_CS==0x8\nVMCS_HOST_CR0==0x80000039\nVMCS_HOST_CR0==0x80000039\nVMCS_HOST_CR3==0x38009000\nVMCS_HOST_CR3==0x37fed000\nVMCS_HOST_CR4==0x20a0\nVMCS_HOST_CR4==0x20a0\nVMCS_HOST_FS_BASE==0x0\nVMCS_HOST_FS_BASE==0x0\nVMCS_HOST_GS_BASE==0x402adde0\nVMCS_HOST_GS_BASE==0x403ee300\nVMCS_HOST_TR_BASE==0x402adf24\nVMCS_HOST_TR_BASE==0x403f6504\nVMCS_HOST_GDTR_BASE==0x402ade24\nVMCS_HOST_GDTR_BASE==0x403f6404\nVMCS_HOST_IDTR_BASE==0x401bc600\nVMCS_HOST_IDTR_BASE==0x401bc600\nVMCS_HOST_IA32_SYSENTER_ESP==0x402adde0\nVMCS_HOST_IA32_SYSENTER_ESP==0x403f8000\nVMCS_HOST_IA32_SYSENTER_EIP==0x40136000\nVMCS_HOST_IA32_SYSENTER_EIP==0x40136000\nVMCS_HOST_RSP==0xdeadbeef\nVMCS_HOST_RSP==0xdeadbeef\nVMCS_HOST_RIP==0xdeadbeef\npanic(CPU0): Fatal error: VM entry failed. Error 8\nVMCS_HOST_RIP==0xdeadbeef\nCR0 80000039    CR2 00000000    CR3 37FED000    CR4 000020A0\nRFLAGS 00200006  GDTR 402ADE24+000000FF  IDTR 401BC600+00000800\nstackdump: 40145564 40145564 8005AC1 401BC600 0 402AE164 D 40124162 D 403FFE7C 40125B6A 40135C7B 401241BF 40135C90 D 402AE164 0 0 4011D47C 401241BF 4012415B 403FFF08 40125B8B 402A81A0 400 401470AB 40124965 4012415B 401241BF 403FFF08 40124BDE 402A81A0\nbacktrace: 40124162 40125B6A 40135C7B 401241BF 40135C90 4011D47C 401241BF 4012415B 40125B8B 40124965 4012415B 401241BF 40124BDE 40124D00 40132702 40132564 40125B2D 401310D7 40130DB5 4013253D 4011D68F 40125AC1 4011D68F 40125B0A 4012C8B5 40125B2D 4012E1AD 4011E7A3 4011B6EF 4011E59C 4010D87C\nGuest state and registers of cpu 0 ------------\nRAX 00000001    RCX 00000000    RDX 00000000    RBX 00000000\nRSP 00004FC0    RBP 00000000    RSI 00000000    RDI 00000000\nR8  00000000    R9  00000000    R10 00000000    R11 00000000\nR12 00000000    R13 00000000    R14 00000000    R15 00000000\nCR0 00000030    CR2 00000000    CR3 00000000    CR4 00000000\nACR   ES 000000F3 CS 000000F3 SS 000000F3 DS 000000F3 FS 000000F3 GS 000000F3\nLIMIT ES 0000FFFF CS 0000FFFF SS 0000FFFF DS 0000FFFF FS 0000FFFF GS 0000FFFF\nBASE  ES 00000000 CS 00000000 SS 00000000 DS 00000000 FS 00000000 GS 00000000\nSEL   ES 00000000 CS 00000000 SS 00000000 DS 00000000 FS 00000000 GS 00000000\nRIP 00005016  RFLAGS 00000002  GDTR 402ADE24+000000FF  IDTR 00000000+000003FF\nEFER 00000000\nExit reason: -1958193920=0x8B485500 (unknown error)  VM entry failure\nExit qualification 00E82878  VM exit interrupt information C0314507\nVM entry interruption-information 00000000  errcode 00000000  instlen 00000000\nVM exit errcode 0000DFB9  VMCS IDTR 00000000+00000000   VMCS RFLAGS 00020002\nre=1 pg=0 sw:en=0x0 es=0x0 cs=0x0 ss=0x0 ds=0x0 fs=0x0 gs=0x0\n------------------------------------------------\npanic(CPU1): Fatal error: VM entry failed. Error 8\nCR0 80000039    CR2 00000000    CR3 38009000    CR4 000020A0\nRFLAGS 00200002  GDTR 403F6404+000000FF  IDTR 401BC600+00000800\nstackdump: 40145564 40145564 8005AC1 401BC600 1 403F6744 D 40124162 40407EEC 40407E5C 1 40135C7B 401241BF 40135C90 D 403F6744 1 1 4011D47C 401241BF 4012415B 40407EE8 40125B2D 4014570E 40407E98 402A7DD3 40124965 4012415B 401241BF 40407EE8 40124BB9 4014570E\nbacktrace: 40124162 40135C7B 401241BF 40135C90 4011D47C 401241BF 4012415B 40125B2D 40124965 4012415B 401241BF 40124BB9 40124D00 40132702 40132564 40125B2D 401310D7 40130DB5 4013253D 4011F560 4013332E 4011F51F 4011F560 4013332E 40130939 4011E7A3 4011B6EF 4011E55C 4011E57A 4011E55C 4010D4D5\nGuest state and registers of cpu 1 ------------\nRAX 00000000    RCX 00000000    RDX 00000000    RBX 00000000\nRSP 00000000    RBP 00000000    RSI 00000000    RDI 00000000\nR8  00000000    R9  00000000    R10 00000000    R11 00000000\nR12 00000000    R13 00000000    R14 00000000    R15 00000000\nCR0 00000030    CR2 00000000    CR3 00000000    CR4 00000000\nACR   ES 000000F3 CS 000000F3 SS 000000F3 DS 000000F3 FS 000000F3 GS 000000F3\nLIMIT ES 0000FFFF CS 0000FFFF SS 0000FFFF DS 0000FFFF FS 0000FFFF GS 0000FFFF\nBASE  ES 00000000 CS 00000000 SS 00000000 DS 00000000 FS 00000000 GS 00000000\nSEL   ES 00000000 CS 00000000 SS 00000000 DS 00000000 FS 00000000 GS 00000000\nRIP 00000000  RFLAGS 00000002  GDTR 403F6404+000000FF  IDTR 00000000+000003FF\nEFER 00000000\nExit reason: -1924530177=0x8D49FFFF (unknown error)  VM entry failure\nExit qualification 00E80000  VM exit interrupt information 0002208D\nVM entry interruption-information 00000000  errcode 00000000  instlen 00000000\nVM exit errcode 4CF63100  VMCS IDTR 00000000+00000000   VMCS RFLAGS 00020002\nre=1 pg=0 sw:en=0x0 es=0x0 cs=0x0 ss=0x0 ds=0x0 fs=0x0 gs=0x0\n------------------------------------------------\npanic(CPU0): Fatal error: VM entry failed. Error 8\n```\n\nVMCS_HOST_* \u304c\u54042\u884c\u305a\u3064\u51fa\u3066\u308b\u306e\u306f\uff0c\u4eee\u60f3CPU\u30922\u3064\u5272\u308a\u5f53\u3066\u3066\u308b\u304b\u3089\uff0e\n\n# \u529b\u5c3d\u304d\u305f\n\u306e\u3067\uff0c\u3042\u3068\u306f\u8ab0\u304b\u9811\u5f35\u3063\u3066\u307f\u3066\u304f\u3060\u3055\u3044\uff0e\n\u6642\u9593\u304c\u3042\u308c\u3070\u30ea\u30d9\u30f3\u30b8\u3059\u308b\u304b\u3082\uff0e\n32bit \u30d3\u30eb\u30c9\u3057\u305f\u308a\u30c7\u30d0\u30c3\u30b0\u30d7\u30ea\u30f3\u30bf\u8db3\u3057\u305f\u30b3\u30fc\u30c9\u3092\uff0chttps://bitbucket.org/ftakaaki/bitvisor-try-to-run-on-hyperv \u306b\u7f6e\u3044\u305f\u306e\u3067\uff0c\u898b\u305f\u3044\u4eba\u306f\u3069\u3046\u305e\uff0e\n\n# \u304a\u307e\u3051: 64bit \u30b2\u30b9\u30c8 OS \u306f\u52d5\u304b\u306a\u3044?\nBitVisor \u306f\u52d5\u304b\u306a\u304b\u3063\u305f\u3051\u3069\uff0cVMWare \u3092\u52d5\u304b\u3057\u305f\u4eba\u306f\u3044\u308b\u3089\u3057\u3044\uff0e\n\u4ee5\u4e0b\u306e\u30d5\u30a9\u30fc\u30e9\u30e0\u306e\u3084\u308a\u53d6\u308a\u304b\u3089\u5bdf\u3059\u308b\u306b\uff0c64bit \u30b2\u30b9\u30c8\u306f\u52d5\u304b\u306a\u3044\u3089\u3057\u3044\uff0e\n\u8a66\u3057\u3066\u307f\u305f\u3044\u4eba\u306f\uff0c32 bit \u30b2\u30b9\u30c8\u3067\u6311\u6226\u3057\u305f\u65b9\u304c\u3044\u3044\u304b\u3082\uff0e\nhttps://social.technet.microsoft.com/Forums/systemcenter/en-US/aa10f817-5a46-4c5d-b041-b11abd3c46a8/does-hyper-v-support-nested-vm?forum=virtualmachingmgrhyperv\n\n# \u304a\u308f\u308a\u306b\nBitVisor \u306f\uff0cHyper-V \u306e\u4e0a\u3067\uff0c\u52d5\u304b\u306a\u304b\u3063\u305f\uff0e\n", "tags": ["BitVisor", "Hyper-V"]}