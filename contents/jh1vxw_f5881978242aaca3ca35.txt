{"tags": ["OpenVSwitch", "nf_conntrack"], "context": " \u3053\u306e\u8a18\u4e8b\u306f\u6700\u7d42\u66f4\u65b0\u65e5\u304b\u30891\u5e74\u4ee5\u4e0a\u304c\u7d4c\u904e\u3057\u3066\u3044\u307e\u3059\u3002\n\n\u6b63\u76f4\u30b3\u30cd\u30af\u30b7\u30e7\u30f3\u30c8\u30e9\u30c3\u30ad\u30f3\u30b0\u3068\u304b\u3057\u305f\u304f\u306a\u3044\u3067\u3059\uff57\n\u30bb\u30c3\u30b7\u30e7\u30f3\u30c6\u30fc\u30d6\u30eb\u304c\u6ea2\u308c\u3066\u3072\u3069\u3044\u3053\u3068\u306b\u306a\u308b\u306e\u304c\u76ee\u306b\u898b\u3048\u3066\u3044\u308b\u3058\u3083\u306a\u3044\u3067\u3059\u304borz\n\u53e4\u304f\u306f2000\u5e74\u3054\u308d\u304b\u3089\u30eb\u30fc\u30bf\u306eCAM\u304c\u6ea2\u308c\u308b\u554f\u984c\u3067\u82e6\u3057\u3093\u3060\u308a\u3001\u6700\u8fd1\u3067\u3082\u53e4\u3044Open vSwitch\u3067Data Path\u306e\u30d5\u30ed\u30fc\u30c6\u30fc\u30d6\u30eb\u304c\u6ea2\u308c\u308b\u4e8b\u8c61\u3067\u82e6\u3057\u3093\u3060\u308a(\u203b)\u3001\u306a\u3093\u306815\u5e74\u4ee5\u4e0a\u3082\u540c\u3058\u554f\u984c\u3067\u5730\u7344\u3092\u898b\u7d9a\u3051\u3066\u3044\u308b\u308f\u3051\u3067\u3059\u3002\n\u203b \u88dc\u8db3: Open vSwitch\u306f\u3001\u30d0\u30fc\u30b8\u30e7\u30f32.3\u3042\u305f\u308a\u304b\u3089\u65b0\u898f\u30d5\u30ed\u30fc\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u6027\u80fd\u304c\u3082\u306e\u3059\u3054\u304f\u6539\u5584\u3057\u3066\u304a\u308a\u3001\u3053\u306e\u554f\u984c\u306f\u73fe\u72b6\u30af\u30ea\u30a2\u3055\u308c\u3066\u3044\u307e\u3059(DoS\u306b\u3082\u3060\u3044\u3076\u5f37\u304f\u306a\u308a\u307e\u3057\u305f)\u3002\n\n\u3068\u3044\u3046\u3053\u3068\u3067\u4eca\u56de\u306f\u3001\nconntrack\u30c6\u30fc\u30d6\u30eb\u304c\u6ea2\u308c\u305f\u6642\u306e\u5b89\u5b9a\u6027\u3082\u542b\u3081\u3066\u3001\u6027\u80fd\u9762\u306e\u8a55\u4fa1\u3082\u3084\u3063\u3066\u307f\u3088\u3046\u3068\u601d\u3044\u307e\u3059\u3002\n\u524d\u56de\u307e\u3067\u306b\u3001conntrack\u30a4\u30f3\u30c6\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u6a5f\u80fd\u3092\u30b5\u30dd\u30fc\u30c8\u3057\u305fOpen vSwitch\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u304b\u3089\u3001\u6700\u5c0f\u69cb\u6210\u3067\u306e\u30b9\u30c6\u30fc\u30c8\u30d5\u30eb\u30a4\u30f3\u30b9\u30da\u30af\u30b7\u30e7\u30f3\u306e\u5b9f\u88c5\u307e\u3067\u3084\u3063\u3066\u307f\u307e\u3057\u305f\u3002\n\nOpen vSwitch\u306econntrack\u9023\u643a\u3092\u8a66\u3057\u3066\u307f\u305f(\u305d\u306e1)\nOpen vSwitch\u306econntrack\u9023\u643a\u3092\u8a66\u3057\u3066\u307f\u305f(\u305d\u306e2)\n\n\u4eca\u56de\u306f\u3001\u4eee\u60f3\u30b5\u30fc\u30d0\u30db\u30b9\u30c6\u30a3\u30f3\u30b0\u306b\u3042\u308a\u304c\u3061\u306a\u30de\u30eb\u30c1\u30c6\u30ca\u30f3\u30c8\u69cb\u6210\u3067\u306e\u5b9f\u88c5\u3092\u884c\u3063\u3066\u307f\u307e\u3059\u3002\n\n\u30c6\u30b9\u30c8\u69cb\u6210\n\u524d\u56de\u540c\u69d8\u30012\u3064\u306eVM\u3092Open vSwitch\u306b\u63a5\u7d9a\u3057\u3001eth2\u3092\u4ecb\u3057\u3066\u5916\u90e8\u30ce\u30fc\u30c9\u3092\u63a5\u7d9a\u3057\u307e\u3059(\u30a4\u30f3\u30bf\u30fc\u30cd\u30c3\u30c8\u4e0a\u306e\u30db\u30b9\u30c8\u3092\u60f3\u5b9a)\u3002\n\n\u3053\u3053\u3067\u306f\u3001\u4ee5\u4e0b\u306e\u30dd\u30ea\u30b7\u30fc\u3092\u5b9f\u88c5\u3057\u307e\u3059\u3002\n\nVM1, VM2\u304c\u767a\u4fe1\u3059\u308b\u30d1\u30b1\u30c3\u30c8\u306b\u5bfe\u3057\u3001MAC\u30b9\u30d7\u30fc\u30d5\u30a3\u30f3\u30b0\u3001ARP\u30b9\u30d7\u30fc\u30d5\u30a3\u30f3\u30b0\u3001IP\u30b9\u30d7\u30fc\u30d5\u30a3\u30f3\u30b0(\u203b)\u3092\u9632\u6b62\u3059\u308b\u30d5\u30a3\u30eb\u30bf\u3092\u8a2d\u5b9a\nVM1\u304c\u7740\u4fe1\u3059\u308b\u30d1\u30b1\u30c3\u30c8\u306e\u3046\u3061\u3001TCP 22\u756a\u30dd\u30fc\u30c8\u5b9b\u306e\u307f\u8a31\u53ef\u3057\u3001\u305d\u308c\u4ee5\u5916\u306f\u8a31\u53ef\u3057\u306a\u3044\nVM2\u304c\u7740\u4fe1\u3059\u308b\u30d1\u30b1\u30c3\u30c8\u306e\u3046\u3061\u3001TCP 80\u756a\u30dd\u30fc\u30c8\u5b9b\u306e\u307f\u8a31\u53ef\u3057\u3001\u305d\u308c\u4ee5\u5916\u306f\u8a31\u53ef\u3057\u306a\u3044\nVM1, VM2\u3044\u305a\u308c\u3082\u3001\u81ea\u8eab\u304c\u767a\u3057\u305f\u901a\u4fe1\u306e\u623b\u308a\u30d1\u30b1\u30c3\u30c8\u3092\u81ea\u52d5\u7684\u306b\u8a31\u53ef\u3059\u308b(\u3053\u3053\u3067conntrack\u30a4\u30f3\u30c6\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u6a5f\u80fd\u3092\u6d3b\u7528\u3057\u3001\u30b9\u30c6\u30fc\u30c8\u30d5\u30eb\u30a4\u30f3\u30b9\u30da\u30af\u30b7\u30e7\u30f3\u3092\u5b9f\u88c5)\n\n\u203b \u30b9\u30d7\u30fc\u30d5\u30a3\u30f3\u30b0\u3068\u306f\u3001\u4ed6\u8005\u306e\u30a2\u30c9\u30ec\u30b9\u3092\u507d\u88c5\u3057\u305f\u30d1\u30b1\u30c3\u30c8\u3092\u9001\u4fe1\u3059\u308b\u884c\u70ba\u3067\u3059\u3002\u5171\u6709\u30db\u30b9\u30c6\u30a3\u30f3\u30b0\u3067\u306f\u5bfe\u7b56\u304c\u5fc5\u9808\u3068\u306a\u308a\u307e\u3059\u3002\n\nStep1. Open vSwitch\u306e\u30d5\u30ed\u30fc\u30a8\u30f3\u30c8\u30ea\u3092\u8a2d\u5b9a\nconntrack\u306e\u6c17\u6301\u3061\u306b\u306a\u3063\u30663\u6642\u9593\u307b\u3069\u60a9\u307f\u307e\u304f\u3063\u305f\u7d50\u679c\u3001\u4ee5\u4e0b\u306e\u8a2d\u5b9a\u3092\u7de8\u307f\u51fa\u3057\u307e\u3057\u305f\u3002\n\u203b \u3082\u3063\u3068\u30b9\u30de\u30fc\u30c8\u306a\u65b9\u6cd5\u304c\u3042\u3063\u305f\u3089\u6559\u3048\u3066\u4e0b\u3055\u3044 m(__)m\n$ cat a.flow\n# conntrack\npriority=9900,ip,ct_state=-trk actions=ct(table=0)\npriority=9800,ip,ct_state=+trk+est actions=normal\npriority=9700,ip,ct_state=+trk+rel actions=normal\n\n# packet filter to vm1\npriority=6900,dl_dst=52:54:00:60:84:ff,tcp,tp_dst=22 actions=ct(commit),normal\npriority=6800,dl_dst=52:54:00:60:84:ff,ip actions=drop\n\n# packet filter to vm2\npriority=5900,dl_dst=52:54:00:99:90:78,tcp,tp_dst=80 actions=ct(commit),normal\npriority=5800,dl_dst=52:54:00:99:90:78,ip actions=drop\n\n# in_port=2 (from vm1)\npriority=2900,in_port=2,dl_src=52:54:00:60:84:ff,arp,arp_spa=192.168.0.1 actions=normal\npriority=2800,in_port=2,dl_dst=01:00:00:00:00:00/01:00:00:00:00:00 actions=drop\npriority=2700,in_port=2,dl_src=52:54:00:60:84:ff,ip,nw_src=192.168.0.1 actions=ct(commit),normal\n\n# in_port=3 (from vm2)\npriority=1900,in_port=3,dl_src=52:54:00:99:90:78,arp,arp_spa=192.168.0.2 actions=normal\npriority=1800,in_port=3,dl_dst=01:00:00:00:00:00/01:00:00:00:00:00 actions=drop\npriority=1700,in_port=3,dl_src=52:54:00:99:90:78,ip,nw_src=192.168.0.2 actions=ct(commit),normal\n\n# default allow\npriority=0 actions=normal\n\n$ ovs-ofctl add-flows br0 a.flow\n\nin_port\u306ftap\u30a4\u30f3\u30bf\u30fc\u30d5\u30a7\u30a4\u30b9\u306eofport\u756a\u53f7\u3092\u6307\u5b9a\u3057\u307e\u3059\u3002\u3053\u306e\u74b0\u5883\u3067\u306f2\u30683\u304c\u5272\u308a\u5f53\u3066\u3089\u308c\u3066\u3044\u307e\u3057\u305f\u3002\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u78ba\u8a8d\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n$ ovs-vsctl get interface tap2 ofport   <= VM1\u5074\n2\n$ ovs-vsctl get interface tap4 ofport   <= VM2\u5074\n3\n\n\u6b63\u3057\u304f\u8a2d\u5b9a\u3067\u304d\u308b\u3068\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\n[root@sl67-r3 ~]# ovs-ofctl dump-flows br0\nNXST_FLOW reply (xid=0x4):\n cookie=0x0, duration=4.116s, table=0, n_packets=0, n_bytes=0, idle_age=4, priority=9900,ct_state=-trk,ip actions=ct(table=0)\n cookie=0x0, duration=4.115s, table=0, n_packets=0, n_bytes=0, idle_age=4, priority=9800,ct_state=+est+trk,ip actions=NORMAL\n cookie=0x0, duration=4.115s, table=0, n_packets=0, n_bytes=0, idle_age=4, priority=9700,ct_state=+rel+trk,ip actions=NORMAL\n cookie=0x0, duration=4.115s, table=0, n_packets=0, n_bytes=0, idle_age=4, priority=6900,tcp,dl_dst=52:54:00:60:84:ff,tp_dst=22 actions=ct(commit),NORMAL\n cookie=0x0, duration=4.114s, table=0, n_packets=0, n_bytes=0, idle_age=4, priority=5900,tcp,dl_dst=52:54:00:99:90:78,tp_dst=80 actions=ct(commit),NORMAL\n cookie=0x0, duration=4.115s, table=0, n_packets=0, n_bytes=0, idle_age=4, priority=6800,ip,dl_dst=52:54:00:60:84:ff actions=drop\n cookie=0x0, duration=4.114s, table=0, n_packets=0, n_bytes=0, idle_age=4, priority=5800,ip,dl_dst=52:54:00:99:90:78 actions=drop\n cookie=0x0, duration=4.114s, table=0, n_packets=0, n_bytes=0, idle_age=4, priority=2900,arp,in_port=2,dl_src=52:54:00:60:84:ff,arp_spa=192.168.0.1 actions=NORMAL\n cookie=0x0, duration=4.114s, table=0, n_packets=0, n_bytes=0, idle_age=4, priority=2700,ip,in_port=2,dl_src=52:54:00:60:84:ff,nw_src=192.168.0.1 actions=ct(commit),NORMAL\n cookie=0x0, duration=4.114s, table=0, n_packets=0, n_bytes=0, idle_age=4, priority=1900,arp,in_port=3,dl_src=52:54:00:99:90:78,arp_spa=192.168.0.2 actions=NORMAL\n cookie=0x0, duration=4.113s, table=0, n_packets=0, n_bytes=0, idle_age=4, priority=1700,ip,in_port=3,dl_src=52:54:00:99:90:78,nw_src=192.168.0.2 actions=ct(commit),NORMAL\n cookie=0x0, duration=4.114s, table=0, n_packets=0, n_bytes=0, idle_age=4, priority=2800,in_port=2,dl_dst=01:00:00:00:00:00/01:00:00:00:00:00 actions=drop\n cookie=0x0, duration=4.113s, table=0, n_packets=0, n_bytes=0, idle_age=4, priority=1800,in_port=3,dl_dst=01:00:00:00:00:00/01:00:00:00:00:00 actions=drop\n cookie=0x0, duration=4.113s, table=0, n_packets=0, n_bytes=0, idle_age=4, priority=0 actions=NORMAL\n\n\u8a2d\u5b9a\u306e\u610f\u5473\u306f\u4ee5\u4e0b\u306e\u3068\u304a\u308a\u3067\u3059\u3002\n\npriority=9900: \u6700\u521d\u306b\u5168\u3066\u306eIP\u30d1\u30b1\u30c3\u30c8\u3092conntrack\u30a4\u30f3\u30c6\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u6a5f\u80fd\u306e\u51e6\u7406\u306b\u56de\u3057\u3001\u81ea\u30c6\u30fc\u30d6\u30eb(table=0)\u3092\u518d\u8a55\u4fa1\u3057\u307e\u3059\u30022\u56de\u76ee\u306e\u8a55\u4fa1\u3067\u306ftrk\u30d5\u30e9\u30b0\u304c\u4ed8\u3044\u3066\u3044\u308b\u306e\u3067\u3001\u672c\u30eb\u30fc\u30eb(ct_state=-trk)\u306b\u306f\u30de\u30c3\u30c1\u305b\u305a\u3001\u4ee5\u964d\u306e\u30eb\u30fc\u30eb\u306e\u8a55\u4fa1\u306b\u9032\u307f\u307e\u3059\u3002\npriority=9800,9870: conntrack\u306b\u8f09\u3063\u3066\u3044\u308b\u30bb\u30c3\u30b7\u30e7\u30f3\u306b\u30de\u30c3\u30c1\u3059\u308b\u30d1\u30b1\u30c3\u30c8\u3092\u901a\u3057\u3061\u3083\u3044\u307e\u3059\u3002\npriority=6900: VM1\u5b9b\u3066\u306e22\u756a\u30dd\u30fc\u30c8\u3092\u8a31\u53ef\u3057conntrack\u3057\u307e\u3059\u3002\u95a2\u9023\u3059\u308b\u901a\u4fe1\u306f\u524d\u306e\u30eb\u30fc\u30eb(9800,9870)\u3067\u8a31\u53ef\u3055\u308c\u307e\u3059\u3002\npriority=6800: \u305d\u306e\u4ed6\u306eVM1\u5b9b\u306e\u30d1\u30b1\u30c3\u30c8\u3092\u7834\u68c4\u3057\u307e\u3059\u3002\npriority=5900,5800: VM1\u3068\u540c\u69d8\u3001VM2\u5b9b\u3066\u30d1\u30b1\u30c3\u30c8\u306e\u51e6\u7406\u3067\u3059\u3002\npriority=2900,2800: VM1\u304c\u767a\u3059\u308bARP\u30d1\u30b1\u30c3\u30c8\u3092\u30bd\u30fc\u30b9MAC\u30a2\u30c9\u30ec\u30b9\u3001\u30bd\u30fc\u30b9IP\u30a2\u30c9\u30ec\u30b9\u6307\u5b9a\u3067\u8a31\u53ef\u3057\u3001\u305d\u306e\u4ed6\u306e\u30d6\u30ed\u30fc\u30c9\u30ad\u30e3\u30b9\u30c8\u3001\u30de\u30eb\u30c1\u30ad\u30e3\u30b9\u30c8\u3092\u7834\u68c4\u3057\u307e\u3059\u3002\npriority=2700: VM1\u304c\u767a\u3059\u308bIP\u30d1\u30b1\u30c3\u30c8\u3092\u30bd\u30fc\u30b9MAC\u30a2\u30c9\u30ec\u30b9\u3001\u30bd\u30fc\u30b9IP\u30a2\u30c9\u30ec\u30b9\u6307\u5b9a\u3067\u8a31\u53ef\u3057\u3001conntrack\u3057\u307e\u3059\u3002\npriority=1900-1700: VM1\u3068\u540c\u69d8\u3001VM2\u304c\u767a\u3059\u308b\u30d1\u30b1\u30c3\u30c8\u306e\u51e6\u7406\u3067\u3059\u3002\n\n\nStep2. \u901a\u4fe1\u78ba\u8a8d\n\u4ee5\u4e0b\u306e\u30d1\u30bf\u30fc\u30f3\u3067\u901a\u4fe1\u30c6\u30b9\u30c8\u3092\u3057\u3001\u901a\u4fe1\u6210\u7acb(\u25cb)\u3001\u4e0d\u6210\u7acb(\u00d7)\u304c\u671f\u5f85\u901a\u308a\u306b\u306a\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3067\u304d\u307e\u3057\u305f\u3002\u3044\u3044\u611f\u3058\u3067\u3059\u3002\n\n\n\nFrom\nTo\n\u901a\u4fe1\u5185\u5bb9\n\u7d50\u679c\n\n\n\n\nVM1\nEXT\n\u5168\u3066\n\u25cb\n\n\nVM1\nVM2\nTCP 80\u756a\u30dd\u30fc\u30c8\u5b9b\u3066\n\u25cb\n\n\nVM1\nVM2\n\u4e0a\u8a18\u4ee5\u5916\n\u00d7\n\n\nVM2\nEXT\n\u5168\u3066\n\u25cb\n\n\nVM2\nVM1\nTCP 22\u756a\u30dd\u30fc\u30c8\u5b9b\u3066\n\u25cb\n\n\nVM2\nVM1\n\u4e0a\u8a18\u4ee5\u5916\n\u00d7\n\n\nEXT\nVM1\nTCP 22\u756a\u30dd\u30fc\u30c8\u5b9b\u3066\n\u25cb\n\n\nEXT\nVM1\n\u4e0a\u8a18\u4ee5\u5916\n\u00d7\n\n\nEXT\nVM2\nTCP 80\u756a\u30dd\u30fc\u30c8\u5b9b\u3066\n\u25cb\n\n\nEXT\nVM2\n\u4e0a\u8a18\u4ee5\u5916\n\u00d7\n\n\n\n\u307e\u305f\u3001VM1,VM2\u306b\u304a\u3044\u3066MAC\u30a2\u30c9\u30ec\u30b9\u3001IP\u30a2\u30c9\u30ec\u30b9\u3092\u5225\u306e\u3082\u306e\u306b\u5909\u66f4(\u30b9\u30d7\u30fc\u30d5\u30a3\u30f3\u30b0)\u3057\u305f\u5834\u5408\u306b\u3001\u901a\u4fe1\u304c\u3067\u304d\u306a\u304f\u306a\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3057\u307e\u3057\u305f\u3002\n\nStep3. \u6027\u80fd\u6e2c\u5b9a\nOpen vSwitch\u3092\u7d4c\u7531\u3059\u308b\u901a\u4fe1\u3092conntrack\u3059\u308b\u5834\u5408\u3068\u3057\u306a\u3044\u5834\u5408\u3067\u3001\u3069\u308c\u307b\u3069\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u306e\u5dee\u304c\u3067\u308b\u304b\u3092\u6e2c\u5b9a\u3057\u307e\u3059\u3002\u3053\u3053\u3067\u306f\u3001conntrack\u30c6\u30fc\u30d6\u30eb\u30b5\u30a4\u30ba\u30922,000\u4e07\u306b\u62e1\u5f35\u3057\u307e\u3057\u305f\u3002\n/etc/modprobe.d/conntrack.conf\noptions nf_conntrack hashsize=2500000\n\n\u307e\u305f\u3001\u4eca\u56deUDP\u30d1\u30b1\u30c3\u30c8\u3092\u7528\u3044\u3066conntrack\u30c6\u30fc\u30d6\u30eb\u3092\u57cb\u3081\u5c3d\u304f\u3059\u8a66\u9a13\u3092\u3059\u308b\u305f\u3081\u3001\u30bb\u30c3\u30b7\u30e7\u30f3\u304c\u6e9c\u307e\u308b\u3088\u3046\u306btimeout\u309230\u79d2\u304b\u30893,000\u79d2\u306b\u5ef6\u9577\u3057\u3066\u304a\u304d\u307e\u3057\u305f\u3002sysctl -a\u3067\u78ba\u8a8d\u3059\u308b\u3068\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\nnet.netfilter.nf_conntrack_buckets = 2500096\nnet.netfilter.nf_conntrack_max = 20000000\nnet.netfilter.nf_conntrack_udp_timeout = 3000\n\n\u3053\u308c\u3067\u6e96\u5099\u304c\u3067\u304d\u307e\u3057\u305f\u3002\n\u3044\u3064\u3082\u3053\u306e\u3088\u3046\u306a\u30c6\u30b9\u30c8\u3092\u3059\u308b\u969b\u3001\u30d1\u30b1\u30c3\u30c8\u30b8\u30a7\u30cd\u30ec\u30fc\u30bf\u3068\u3057\u3066mz\u30b3\u30de\u30f3\u30c9\u3092\u4f7f\u3063\u3066\u307e\u3059\u3002VM1\u306b\u3066\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u5b9f\u884c\u3057\u3001VM2\u306b\u5411\u3051\u3066UDP\u30d1\u30b1\u30c3\u30c8\u3092\u30d0\u30f3\u30d0\u30f3\u9001\u4fe1\u3057\u307e\u3059\u3002\n$ mz -c0 -A 192.168.0.1 -B 192.168.0.2 -t udp \"sp=1-65535,dp=1-65535\"\n\nsp\u3068dp\u306f\u9001\u4fe1\u5143\u30dd\u30fc\u30c8\u756a\u53f7\u3068\u5b9b\u5148\u30dd\u30fc\u30c8\u756a\u53f7\u306e\u7bc4\u56f2\u3067\u3059\u3002\u305d\u308c\u305e\u308c\u30a4\u30f3\u30af\u30ea\u30e1\u30f3\u30c8\u3057\u306a\u304c\u3089\u30d1\u30b1\u30c3\u30c8\u3092\u9001\u51fa\u3059\u308b\u305f\u3081\u3001\u5168\u3066\u306e\u30d1\u30b1\u30c3\u30c8\u304cconntrack\u7684\u306b\u65b0\u898f\u30bb\u30c3\u30b7\u30e7\u30f3\u6271\u3044\u3068\u306a\u308a\u307e\u3059\u3002\n\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u3001VM2\u306b\u3066\u53d7\u4fe1\u30d1\u30b1\u30c3\u30c8\u30ec\u30fc\u30c8\u306e\u63a8\u79fb\u3092vnstat\u30b3\u30de\u30f3\u30c9\u3067\u78ba\u8a8d\u3057\u307e\u3059\u3002\n$ vnstat -i eth1 -l\nMonitoring eth1...    (press CTRL-C to stop)\n\n   rx:    24.68 Mbit/s 75200 p/s          tx:        0 kbit/s     1 p/s\n\nconntrack\u3057\u306a\u3044\u5834\u5408\u3068\u3001conntrack\u3059\u308b\u5834\u5408\u306e\u6027\u80fd\u5dee\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u308a\u307e\u3057\u305f\u3002\n\nconntrack\u3057\u306a\u3044\u5834\u5408\u306b\u6bd4\u3079\u3001conntrack\u3059\u308b\u5834\u5408\u306f\u5373\u5ea7\u306b42%\u7a0b\u5ea6\u307e\u3067\u6027\u80fd\u4f4e\u4e0b\u3057\u307e\u3059\u3002\n\u307e\u305f\u3001\u30bb\u30c3\u30b7\u30e7\u30f3\u6570\u304c\u5897\u3048\u308b\u306b\u5f93\u3044conntrack\u30c6\u30fc\u30d6\u30eb\u306e\u66f4\u65b0/\u691c\u7d22\u30b3\u30b9\u30c8\u304c\u4e0a\u304c\u308b\u305f\u3081\u30012,000\u4e07\u30a8\u30f3\u30c8\u30ea\u6642\u306b\u306f22%\u7a0b\u5ea6\u307e\u3067\u4f4e\u4e0b\u3059\u308b\u3053\u3068\u304c\u308f\u304b\u308a\u307e\u3057\u305f\u3002\n\n\u307e\u3068\u3081\n\u672c\u6a5f\u80fd\u3092\u7528\u3044\u308b\u3053\u3068\u3067\u5b9f\u73fe\u3057\u305f\u3044\u3053\u3068\u304c\u5b9f\u88c5\u3067\u304d\u308b\u3053\u3068\u304c\u308f\u304b\u308a\u3001\u6a5f\u80fd\u8a55\u4fa1\u3068\u3057\u3066\u306f\u6e80\u8db3\u306e\u3044\u304f\u7d50\u679c\u3068\u306a\u308a\u307e\u3057\u305f\u3002\u307e\u305f\u3001\u30a8\u30fc\u30b8\u30f3\u30b0(\u8ca0\u8377\u3092\u7d99\u7d9a\u7684\u306b\u304b\u3051\u3066\u4e0d\u5b89\u5b9a\u306b\u306a\u3089\u306a\u3044\u304b)\u3082\u884c\u3044\u307e\u3057\u305f\u304c\u3001\u4eca\u306e\u3068\u3053\u308d\u554f\u984c\u306a\u3044\u3088\u3046\u3067\u3057\u305f\u3002\n\u3057\u304b\u3057\u306a\u304c\u3089\u3001\u6027\u80fd\u4f4e\u4e0b\u304c\u3060\u3044\u3076\u53b3\u3057\u3044\u3067\u3059\u3002\u5f0a\u793e\u306e\u30af\u30e9\u30a6\u30c9\u3067\u306f\u3001\u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b5\u3084\u30eb\u30fc\u30bf\u30a2\u30d7\u30e9\u30a4\u30a2\u30f3\u30b9\u306e\u6027\u80fd\u76ee\u5b89\u3092\u516c\u958b\u3057\u3066\u3044\u307e\u3059\u304c\u3001\u3053\u308c\u3089\u306f\u5168\u3066\u4eee\u60f3\u30a2\u30d7\u30e9\u30a4\u30a2\u30f3\u30b9\u3067\u306f\u306a\u304f\u3001\u4eee\u60f3\u30b9\u30a4\u30c3\u30c1(Open vSwitch)\u306e\u30dc\u30c8\u30eb\u30cd\u30c3\u30af\u306b\u3088\u308b\u3082\u306e\u3067\u3059\u3002\nOpen vSwitch\u306e\u9650\u754c\u6027\u80fd\u3092\u3082\u3068\u306b\u3001\u30de\u30eb\u30c1\u30c6\u30ca\u30f3\u30c8\u3057\u305f\u5834\u5408\u306b1\u30e6\u30fc\u30b6\u3042\u305f\u308a\u3053\u308c\u304f\u3089\u3044\u306f\u5927\u4e08\u592b\u3060\u308d\u3046\u7684\u306a\u3001\u30ae\u30ea\u30ae\u30ea\u306e\u5024\u3092\u7d5e\u308a\u51fa\u3057\u3066\u3044\u307e\u3059\u3002conntrack\u3059\u308b\u5834\u5408\u306f\u3001\u3053\u308c\u3089\u306e\u5024\u306e\u898b\u76f4\u3057\u304c\u5fc5\u8981\u305d\u3046\u3067\u3059(\u6d99)\n\u3042\u3068\u3082\u3046\u4e00\u3064\u3001conntrack\u3067\u306fL2\u306e\u60c5\u5831\u304c\u6301\u3066\u305a\u3001L3\u4ee5\u4e0a\u306e\u60c5\u5831(IP\u30a2\u30c9\u30ec\u30b9\u3084\u30dd\u30fc\u30c8\u756a\u53f7)\u3057\u304b\u4fdd\u6301\u3067\u304d\u306a\u3044\u305f\u3081\u6ce8\u610f\u304c\u5fc5\u8981\u3067\u3059\u3002\u5177\u4f53\u7684\u306b\u306f\u3001\u7570\u306a\u308b\u30e6\u30fc\u30b6\u304c\u7570\u306a\u308bVLAN\u4e0a\u3067\u540c\u3058IP\u30a2\u30c9\u30ec\u30b9\u5e2f(192.168.0.0/24\u306a\u3069)\u3092\u4f7f\u7528\u3057\u3066\u3044\u305f\u5834\u5408\u3001\u3042\u308b\u30e6\u30fc\u30b6\u306e\u901a\u4fe1\u306b\u3088\u3063\u3066\u751f\u6210\u3055\u308c\u305fconntrack\u30a8\u30f3\u30c8\u30ea\u306b\u3088\u3063\u3066\u3001\u5225\u306e\u30e6\u30fc\u30b6\u306e\u901a\u4fe1\u304c\u610f\u56f3\u305b\u305a\u8a31\u53ef\u3055\u308c\u3066\u3057\u307e\u3046\u53ef\u80fd\u6027\u304c\u3042\u308a\u307e\u3059\u3002\u3053\u308c\u306b\u3064\u3044\u3066\u306f\u3001zone\u3092\u6307\u5b9a\u3059\u308b\u3053\u3068\u3067\u89e3\u6c7a\u3067\u304d\u305d\u3046\u306a\u306e\u3067\u3001\u6298\u3092\u307f\u3066\u8a66\u3057\u3066\u307f\u3088\u3046\u3068\u601d\u3044\u307e\u3059\u3002\nhttp://openvswitch.org/support/dist-docs/ovs-ofctl.8.html\n       ct_zone=zone\n              Matches  the  given  16-bit connection zone exactly. This repre-\n              sents the most recent connection tracking context  that  ct  was\n              executed  in.  Each  zone  is an independent connection tracking\n              context, so if you wish to track the  same  packet  in  multiple\n              contexts  then you must use the ct action multiple times. Intro-\n              duced in Open vSwitch 2.5.\n\n\u9577\u3005\u3068\u6700\u5f8c\u307e\u3067\u304a\u4ed8\u304d\u5408\u3044\u3044\u305f\u3060\u304d\u307e\u3057\u3066\u3042\u308a\u304c\u3068\u3046\u3054\u3056\u3044\u307e\u3057\u305f\uff57\n# \u6b63\u76f4\u30b3\u30cd\u30af\u30b7\u30e7\u30f3\u30c8\u30e9\u30c3\u30ad\u30f3\u30b0\u3068\u304b\u3057\u305f\u304f\u306a\u3044\u3067\u3059\uff57\n\n\u30bb\u30c3\u30b7\u30e7\u30f3\u30c6\u30fc\u30d6\u30eb\u304c\u6ea2\u308c\u3066\u3072\u3069\u3044\u3053\u3068\u306b\u306a\u308b\u306e\u304c\u76ee\u306b\u898b\u3048\u3066\u3044\u308b\u3058\u3083\u306a\u3044\u3067\u3059\u304borz\n\n\u53e4\u304f\u306f2000\u5e74\u3054\u308d\u304b\u3089[\u30eb\u30fc\u30bf\u306eCAM\u304c\u6ea2\u308c\u308b\u554f\u984c\u3067\u82e6\u3057\u3093\u3060\u308a](http://www.janog.gr.jp/meeting/janog10/pdf/network-tanaka.pdf)\u3001\u6700\u8fd1\u3067\u3082[\u53e4\u3044Open vSwitch\u3067Data Path\u306e\u30d5\u30ed\u30fc\u30c6\u30fc\u30d6\u30eb\u304c\u6ea2\u308c\u308b\u4e8b\u8c61\u3067\u82e6\u3057\u3093\u3060\u308a](http://research.sakura.ad.jp/2011/10/11/hbstudy27/)(\u203b)\u3001\u306a\u3093\u306815\u5e74\u4ee5\u4e0a\u3082\u540c\u3058\u554f\u984c\u3067\u5730\u7344\u3092\u898b\u7d9a\u3051\u3066\u3044\u308b\u308f\u3051\u3067\u3059\u3002\n\n\u203b \u88dc\u8db3: Open vSwitch\u306f\u3001\u30d0\u30fc\u30b8\u30e7\u30f32.3\u3042\u305f\u308a\u304b\u3089\u65b0\u898f\u30d5\u30ed\u30fc\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u6027\u80fd\u304c\u3082\u306e\u3059\u3054\u304f\u6539\u5584\u3057\u3066\u304a\u308a\u3001\u3053\u306e\u554f\u984c\u306f\u73fe\u72b6\u30af\u30ea\u30a2\u3055\u308c\u3066\u3044\u307e\u3059(DoS\u306b\u3082\u3060\u3044\u3076\u5f37\u304f\u306a\u308a\u307e\u3057\u305f)\u3002\n\n# \u3068\u3044\u3046\u3053\u3068\u3067\u4eca\u56de\u306f\u3001\n\nconntrack\u30c6\u30fc\u30d6\u30eb\u304c\u6ea2\u308c\u305f\u6642\u306e\u5b89\u5b9a\u6027\u3082\u542b\u3081\u3066\u3001\u6027\u80fd\u9762\u306e\u8a55\u4fa1\u3082\u3084\u3063\u3066\u307f\u3088\u3046\u3068\u601d\u3044\u307e\u3059\u3002\n\n\u524d\u56de\u307e\u3067\u306b\u3001conntrack\u30a4\u30f3\u30c6\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u6a5f\u80fd\u3092\u30b5\u30dd\u30fc\u30c8\u3057\u305fOpen vSwitch\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u304b\u3089\u3001\u6700\u5c0f\u69cb\u6210\u3067\u306e\u30b9\u30c6\u30fc\u30c8\u30d5\u30eb\u30a4\u30f3\u30b9\u30da\u30af\u30b7\u30e7\u30f3\u306e\u5b9f\u88c5\u307e\u3067\u3084\u3063\u3066\u307f\u307e\u3057\u305f\u3002\n\n- [Open vSwitch\u306econntrack\u9023\u643a\u3092\u8a66\u3057\u3066\u307f\u305f(\u305d\u306e1)](http://qiita.com/jh1vxw/items/0d0e370fb1b374ab0c93)\n- [Open vSwitch\u306econntrack\u9023\u643a\u3092\u8a66\u3057\u3066\u307f\u305f(\u305d\u306e2)](http://qiita.com/jh1vxw/items/bfc3bb3d18a923990190)\n\n\u4eca\u56de\u306f\u3001\u4eee\u60f3\u30b5\u30fc\u30d0\u30db\u30b9\u30c6\u30a3\u30f3\u30b0\u306b\u3042\u308a\u304c\u3061\u306a\u30de\u30eb\u30c1\u30c6\u30ca\u30f3\u30c8\u69cb\u6210\u3067\u306e\u5b9f\u88c5\u3092\u884c\u3063\u3066\u307f\u307e\u3059\u3002\n\n# \u30c6\u30b9\u30c8\u69cb\u6210\n\n\u524d\u56de\u540c\u69d8\u30012\u3064\u306eVM\u3092Open vSwitch\u306b\u63a5\u7d9a\u3057\u3001eth2\u3092\u4ecb\u3057\u3066\u5916\u90e8\u30ce\u30fc\u30c9\u3092\u63a5\u7d9a\u3057\u307e\u3059(\u30a4\u30f3\u30bf\u30fc\u30cd\u30c3\u30c8\u4e0a\u306e\u30db\u30b9\u30c8\u3092\u60f3\u5b9a)\u3002\n\n![a.png](https://qiita-image-store.s3.amazonaws.com/0/108990/40cd153d-e00d-850f-2318-d5874bb66b6e.png)\n\n\u3053\u3053\u3067\u306f\u3001\u4ee5\u4e0b\u306e\u30dd\u30ea\u30b7\u30fc\u3092\u5b9f\u88c5\u3057\u307e\u3059\u3002\n\n- VM1, VM2\u304c\u767a\u4fe1\u3059\u308b\u30d1\u30b1\u30c3\u30c8\u306b\u5bfe\u3057\u3001MAC\u30b9\u30d7\u30fc\u30d5\u30a3\u30f3\u30b0\u3001ARP\u30b9\u30d7\u30fc\u30d5\u30a3\u30f3\u30b0\u3001IP\u30b9\u30d7\u30fc\u30d5\u30a3\u30f3\u30b0(\u203b)\u3092\u9632\u6b62\u3059\u308b\u30d5\u30a3\u30eb\u30bf\u3092\u8a2d\u5b9a\n- VM1\u304c\u7740\u4fe1\u3059\u308b\u30d1\u30b1\u30c3\u30c8\u306e\u3046\u3061\u3001TCP 22\u756a\u30dd\u30fc\u30c8\u5b9b\u306e\u307f\u8a31\u53ef\u3057\u3001\u305d\u308c\u4ee5\u5916\u306f\u8a31\u53ef\u3057\u306a\u3044\n- VM2\u304c\u7740\u4fe1\u3059\u308b\u30d1\u30b1\u30c3\u30c8\u306e\u3046\u3061\u3001TCP 80\u756a\u30dd\u30fc\u30c8\u5b9b\u306e\u307f\u8a31\u53ef\u3057\u3001\u305d\u308c\u4ee5\u5916\u306f\u8a31\u53ef\u3057\u306a\u3044\n- VM1, VM2\u3044\u305a\u308c\u3082\u3001\u81ea\u8eab\u304c\u767a\u3057\u305f\u901a\u4fe1\u306e\u623b\u308a\u30d1\u30b1\u30c3\u30c8\u3092\u81ea\u52d5\u7684\u306b\u8a31\u53ef\u3059\u308b(\u3053\u3053\u3067conntrack\u30a4\u30f3\u30c6\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u6a5f\u80fd\u3092\u6d3b\u7528\u3057\u3001\u30b9\u30c6\u30fc\u30c8\u30d5\u30eb\u30a4\u30f3\u30b9\u30da\u30af\u30b7\u30e7\u30f3\u3092\u5b9f\u88c5)\n\n\u203b \u30b9\u30d7\u30fc\u30d5\u30a3\u30f3\u30b0\u3068\u306f\u3001\u4ed6\u8005\u306e\u30a2\u30c9\u30ec\u30b9\u3092\u507d\u88c5\u3057\u305f\u30d1\u30b1\u30c3\u30c8\u3092\u9001\u4fe1\u3059\u308b\u884c\u70ba\u3067\u3059\u3002[\u5171\u6709\u30db\u30b9\u30c6\u30a3\u30f3\u30b0\u3067\u306f\u5bfe\u7b56\u304c\u5fc5\u9808\u3068\u306a\u308a\u307e\u3059](http://irs.ietf.to/past/docs_20080808/)\u3002\n\n# Step1. Open vSwitch\u306e\u30d5\u30ed\u30fc\u30a8\u30f3\u30c8\u30ea\u3092\u8a2d\u5b9a\n\nconntrack\u306e\u6c17\u6301\u3061\u306b\u306a\u3063\u30663\u6642\u9593\u307b\u3069\u60a9\u307f\u307e\u304f\u3063\u305f\u7d50\u679c\u3001\u4ee5\u4e0b\u306e\u8a2d\u5b9a\u3092\u7de8\u307f\u51fa\u3057\u307e\u3057\u305f\u3002\n\u203b \u3082\u3063\u3068\u30b9\u30de\u30fc\u30c8\u306a\u65b9\u6cd5\u304c\u3042\u3063\u305f\u3089\u6559\u3048\u3066\u4e0b\u3055\u3044 m(__)m\n\n```\n$ cat a.flow\n# conntrack\npriority=9900,ip,ct_state=-trk actions=ct(table=0)\npriority=9800,ip,ct_state=+trk+est actions=normal\npriority=9700,ip,ct_state=+trk+rel actions=normal\n\n# packet filter to vm1\npriority=6900,dl_dst=52:54:00:60:84:ff,tcp,tp_dst=22 actions=ct(commit),normal\npriority=6800,dl_dst=52:54:00:60:84:ff,ip actions=drop\n\n# packet filter to vm2\npriority=5900,dl_dst=52:54:00:99:90:78,tcp,tp_dst=80 actions=ct(commit),normal\npriority=5800,dl_dst=52:54:00:99:90:78,ip actions=drop\n\n# in_port=2 (from vm1)\npriority=2900,in_port=2,dl_src=52:54:00:60:84:ff,arp,arp_spa=192.168.0.1 actions=normal\npriority=2800,in_port=2,dl_dst=01:00:00:00:00:00/01:00:00:00:00:00 actions=drop\npriority=2700,in_port=2,dl_src=52:54:00:60:84:ff,ip,nw_src=192.168.0.1 actions=ct(commit),normal\n\n# in_port=3 (from vm2)\npriority=1900,in_port=3,dl_src=52:54:00:99:90:78,arp,arp_spa=192.168.0.2 actions=normal\npriority=1800,in_port=3,dl_dst=01:00:00:00:00:00/01:00:00:00:00:00 actions=drop\npriority=1700,in_port=3,dl_src=52:54:00:99:90:78,ip,nw_src=192.168.0.2 actions=ct(commit),normal\n\n# default allow\npriority=0 actions=normal\n\n$ ovs-ofctl add-flows br0 a.flow\n```\n\nin_port\u306ftap\u30a4\u30f3\u30bf\u30fc\u30d5\u30a7\u30a4\u30b9\u306eofport\u756a\u53f7\u3092\u6307\u5b9a\u3057\u307e\u3059\u3002\u3053\u306e\u74b0\u5883\u3067\u306f2\u30683\u304c\u5272\u308a\u5f53\u3066\u3089\u308c\u3066\u3044\u307e\u3057\u305f\u3002\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u78ba\u8a8d\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\n```\n$ ovs-vsctl get interface tap2 ofport   <= VM1\u5074\n2\n$ ovs-vsctl get interface tap4 ofport   <= VM2\u5074\n3\n```\n\n\u6b63\u3057\u304f\u8a2d\u5b9a\u3067\u304d\u308b\u3068\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\n\n```\n[root@sl67-r3 ~]# ovs-ofctl dump-flows br0\nNXST_FLOW reply (xid=0x4):\n cookie=0x0, duration=4.116s, table=0, n_packets=0, n_bytes=0, idle_age=4, priority=9900,ct_state=-trk,ip actions=ct(table=0)\n cookie=0x0, duration=4.115s, table=0, n_packets=0, n_bytes=0, idle_age=4, priority=9800,ct_state=+est+trk,ip actions=NORMAL\n cookie=0x0, duration=4.115s, table=0, n_packets=0, n_bytes=0, idle_age=4, priority=9700,ct_state=+rel+trk,ip actions=NORMAL\n cookie=0x0, duration=4.115s, table=0, n_packets=0, n_bytes=0, idle_age=4, priority=6900,tcp,dl_dst=52:54:00:60:84:ff,tp_dst=22 actions=ct(commit),NORMAL\n cookie=0x0, duration=4.114s, table=0, n_packets=0, n_bytes=0, idle_age=4, priority=5900,tcp,dl_dst=52:54:00:99:90:78,tp_dst=80 actions=ct(commit),NORMAL\n cookie=0x0, duration=4.115s, table=0, n_packets=0, n_bytes=0, idle_age=4, priority=6800,ip,dl_dst=52:54:00:60:84:ff actions=drop\n cookie=0x0, duration=4.114s, table=0, n_packets=0, n_bytes=0, idle_age=4, priority=5800,ip,dl_dst=52:54:00:99:90:78 actions=drop\n cookie=0x0, duration=4.114s, table=0, n_packets=0, n_bytes=0, idle_age=4, priority=2900,arp,in_port=2,dl_src=52:54:00:60:84:ff,arp_spa=192.168.0.1 actions=NORMAL\n cookie=0x0, duration=4.114s, table=0, n_packets=0, n_bytes=0, idle_age=4, priority=2700,ip,in_port=2,dl_src=52:54:00:60:84:ff,nw_src=192.168.0.1 actions=ct(commit),NORMAL\n cookie=0x0, duration=4.114s, table=0, n_packets=0, n_bytes=0, idle_age=4, priority=1900,arp,in_port=3,dl_src=52:54:00:99:90:78,arp_spa=192.168.0.2 actions=NORMAL\n cookie=0x0, duration=4.113s, table=0, n_packets=0, n_bytes=0, idle_age=4, priority=1700,ip,in_port=3,dl_src=52:54:00:99:90:78,nw_src=192.168.0.2 actions=ct(commit),NORMAL\n cookie=0x0, duration=4.114s, table=0, n_packets=0, n_bytes=0, idle_age=4, priority=2800,in_port=2,dl_dst=01:00:00:00:00:00/01:00:00:00:00:00 actions=drop\n cookie=0x0, duration=4.113s, table=0, n_packets=0, n_bytes=0, idle_age=4, priority=1800,in_port=3,dl_dst=01:00:00:00:00:00/01:00:00:00:00:00 actions=drop\n cookie=0x0, duration=4.113s, table=0, n_packets=0, n_bytes=0, idle_age=4, priority=0 actions=NORMAL\n```\n\n\u8a2d\u5b9a\u306e\u610f\u5473\u306f\u4ee5\u4e0b\u306e\u3068\u304a\u308a\u3067\u3059\u3002\n\n- priority=9900: \u6700\u521d\u306b\u5168\u3066\u306eIP\u30d1\u30b1\u30c3\u30c8\u3092conntrack\u30a4\u30f3\u30c6\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u6a5f\u80fd\u306e\u51e6\u7406\u306b\u56de\u3057\u3001\u81ea\u30c6\u30fc\u30d6\u30eb(table=0)\u3092\u518d\u8a55\u4fa1\u3057\u307e\u3059\u30022\u56de\u76ee\u306e\u8a55\u4fa1\u3067\u306ftrk\u30d5\u30e9\u30b0\u304c\u4ed8\u3044\u3066\u3044\u308b\u306e\u3067\u3001\u672c\u30eb\u30fc\u30eb(ct_state=-trk)\u306b\u306f\u30de\u30c3\u30c1\u305b\u305a\u3001\u4ee5\u964d\u306e\u30eb\u30fc\u30eb\u306e\u8a55\u4fa1\u306b\u9032\u307f\u307e\u3059\u3002\n- priority=9800,9870: conntrack\u306b\u8f09\u3063\u3066\u3044\u308b\u30bb\u30c3\u30b7\u30e7\u30f3\u306b\u30de\u30c3\u30c1\u3059\u308b\u30d1\u30b1\u30c3\u30c8\u3092\u901a\u3057\u3061\u3083\u3044\u307e\u3059\u3002\n- priority=6900: VM1\u5b9b\u3066\u306e22\u756a\u30dd\u30fc\u30c8\u3092\u8a31\u53ef\u3057conntrack\u3057\u307e\u3059\u3002\u95a2\u9023\u3059\u308b\u901a\u4fe1\u306f\u524d\u306e\u30eb\u30fc\u30eb(9800,9870)\u3067\u8a31\u53ef\u3055\u308c\u307e\u3059\u3002\n- priority=6800: \u305d\u306e\u4ed6\u306eVM1\u5b9b\u306e\u30d1\u30b1\u30c3\u30c8\u3092\u7834\u68c4\u3057\u307e\u3059\u3002\n- priority=5900,5800: VM1\u3068\u540c\u69d8\u3001VM2\u5b9b\u3066\u30d1\u30b1\u30c3\u30c8\u306e\u51e6\u7406\u3067\u3059\u3002\n- priority=2900,2800: VM1\u304c\u767a\u3059\u308bARP\u30d1\u30b1\u30c3\u30c8\u3092\u30bd\u30fc\u30b9MAC\u30a2\u30c9\u30ec\u30b9\u3001\u30bd\u30fc\u30b9IP\u30a2\u30c9\u30ec\u30b9\u6307\u5b9a\u3067\u8a31\u53ef\u3057\u3001\u305d\u306e\u4ed6\u306e\u30d6\u30ed\u30fc\u30c9\u30ad\u30e3\u30b9\u30c8\u3001\u30de\u30eb\u30c1\u30ad\u30e3\u30b9\u30c8\u3092\u7834\u68c4\u3057\u307e\u3059\u3002\n- priority=2700: VM1\u304c\u767a\u3059\u308bIP\u30d1\u30b1\u30c3\u30c8\u3092\u30bd\u30fc\u30b9MAC\u30a2\u30c9\u30ec\u30b9\u3001\u30bd\u30fc\u30b9IP\u30a2\u30c9\u30ec\u30b9\u6307\u5b9a\u3067\u8a31\u53ef\u3057\u3001conntrack\u3057\u307e\u3059\u3002\n- priority=1900-1700: VM1\u3068\u540c\u69d8\u3001VM2\u304c\u767a\u3059\u308b\u30d1\u30b1\u30c3\u30c8\u306e\u51e6\u7406\u3067\u3059\u3002\n\n# Step2. \u901a\u4fe1\u78ba\u8a8d\n\n\u4ee5\u4e0b\u306e\u30d1\u30bf\u30fc\u30f3\u3067\u901a\u4fe1\u30c6\u30b9\u30c8\u3092\u3057\u3001\u901a\u4fe1\u6210\u7acb(\u25cb)\u3001\u4e0d\u6210\u7acb(\u00d7)\u304c\u671f\u5f85\u901a\u308a\u306b\u306a\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3067\u304d\u307e\u3057\u305f\u3002\u3044\u3044\u611f\u3058\u3067\u3059\u3002\n\n| From        | To           | \u901a\u4fe1\u5185\u5bb9          | \u7d50\u679c |\n|:-----------:|:------------:|:----------------:|:----:|\n| VM1         | EXT          | \u5168\u3066              | \u25cb |\n| VM1         | VM2          | TCP 80\u756a\u30dd\u30fc\u30c8\u5b9b\u3066 | \u25cb |\n| VM1         | VM2          | \u4e0a\u8a18\u4ee5\u5916          | \u00d7 |\n| VM2         | EXT          | \u5168\u3066              | \u25cb |\n| VM2         | VM1          | TCP 22\u756a\u30dd\u30fc\u30c8\u5b9b\u3066 | \u25cb |\n| VM2         | VM1          | \u4e0a\u8a18\u4ee5\u5916           | \u00d7 |\n| EXT         | VM1          | TCP 22\u756a\u30dd\u30fc\u30c8\u5b9b\u3066 | \u25cb |\n| EXT         | VM1          | \u4e0a\u8a18\u4ee5\u5916           | \u00d7 |\n| EXT         | VM2          | TCP 80\u756a\u30dd\u30fc\u30c8\u5b9b\u3066 | \u25cb |\n| EXT         | VM2          | \u4e0a\u8a18\u4ee5\u5916           | \u00d7 |\n\n\u307e\u305f\u3001VM1,VM2\u306b\u304a\u3044\u3066MAC\u30a2\u30c9\u30ec\u30b9\u3001IP\u30a2\u30c9\u30ec\u30b9\u3092\u5225\u306e\u3082\u306e\u306b\u5909\u66f4(\u30b9\u30d7\u30fc\u30d5\u30a3\u30f3\u30b0)\u3057\u305f\u5834\u5408\u306b\u3001\u901a\u4fe1\u304c\u3067\u304d\u306a\u304f\u306a\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3057\u307e\u3057\u305f\u3002\n\n# Step3. \u6027\u80fd\u6e2c\u5b9a\n\nOpen vSwitch\u3092\u7d4c\u7531\u3059\u308b\u901a\u4fe1\u3092conntrack\u3059\u308b\u5834\u5408\u3068\u3057\u306a\u3044\u5834\u5408\u3067\u3001\u3069\u308c\u307b\u3069\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u306e\u5dee\u304c\u3067\u308b\u304b\u3092\u6e2c\u5b9a\u3057\u307e\u3059\u3002\u3053\u3053\u3067\u306f\u3001conntrack\u30c6\u30fc\u30d6\u30eb\u30b5\u30a4\u30ba\u30922,000\u4e07\u306b\u62e1\u5f35\u3057\u307e\u3057\u305f\u3002\n\n/etc/modprobe.d/conntrack.conf\n\n```\noptions nf_conntrack hashsize=2500000\n```\n\n\u307e\u305f\u3001\u4eca\u56deUDP\u30d1\u30b1\u30c3\u30c8\u3092\u7528\u3044\u3066conntrack\u30c6\u30fc\u30d6\u30eb\u3092\u57cb\u3081\u5c3d\u304f\u3059\u8a66\u9a13\u3092\u3059\u308b\u305f\u3081\u3001\u30bb\u30c3\u30b7\u30e7\u30f3\u304c\u6e9c\u307e\u308b\u3088\u3046\u306btimeout\u309230\u79d2\u304b\u30893,000\u79d2\u306b\u5ef6\u9577\u3057\u3066\u304a\u304d\u307e\u3057\u305f\u3002sysctl -a\u3067\u78ba\u8a8d\u3059\u308b\u3068\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\n\n```\nnet.netfilter.nf_conntrack_buckets = 2500096\nnet.netfilter.nf_conntrack_max = 20000000\nnet.netfilter.nf_conntrack_udp_timeout = 3000\n```\n\n\u3053\u308c\u3067\u6e96\u5099\u304c\u3067\u304d\u307e\u3057\u305f\u3002\n\n\u3044\u3064\u3082\u3053\u306e\u3088\u3046\u306a\u30c6\u30b9\u30c8\u3092\u3059\u308b\u969b\u3001\u30d1\u30b1\u30c3\u30c8\u30b8\u30a7\u30cd\u30ec\u30fc\u30bf\u3068\u3057\u3066[mz\u30b3\u30de\u30f3\u30c9](http://www.perihel.at/sec/mz/)\u3092\u4f7f\u3063\u3066\u307e\u3059\u3002VM1\u306b\u3066\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u5b9f\u884c\u3057\u3001VM2\u306b\u5411\u3051\u3066UDP\u30d1\u30b1\u30c3\u30c8\u3092\u30d0\u30f3\u30d0\u30f3\u9001\u4fe1\u3057\u307e\u3059\u3002\n\n```\n$ mz -c0 -A 192.168.0.1 -B 192.168.0.2 -t udp \"sp=1-65535,dp=1-65535\"\n```\n\nsp\u3068dp\u306f\u9001\u4fe1\u5143\u30dd\u30fc\u30c8\u756a\u53f7\u3068\u5b9b\u5148\u30dd\u30fc\u30c8\u756a\u53f7\u306e\u7bc4\u56f2\u3067\u3059\u3002\u305d\u308c\u305e\u308c\u30a4\u30f3\u30af\u30ea\u30e1\u30f3\u30c8\u3057\u306a\u304c\u3089\u30d1\u30b1\u30c3\u30c8\u3092\u9001\u51fa\u3059\u308b\u305f\u3081\u3001\u5168\u3066\u306e\u30d1\u30b1\u30c3\u30c8\u304cconntrack\u7684\u306b\u65b0\u898f\u30bb\u30c3\u30b7\u30e7\u30f3\u6271\u3044\u3068\u306a\u308a\u307e\u3059\u3002\n\n\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u3001VM2\u306b\u3066\u53d7\u4fe1\u30d1\u30b1\u30c3\u30c8\u30ec\u30fc\u30c8\u306e\u63a8\u79fb\u3092vnstat\u30b3\u30de\u30f3\u30c9\u3067\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n```\n$ vnstat -i eth1 -l\nMonitoring eth1...    (press CTRL-C to stop)\n\n   rx:    24.68 Mbit/s 75200 p/s          tx:        0 kbit/s     1 p/s\n```\n\nconntrack\u3057\u306a\u3044\u5834\u5408\u3068\u3001conntrack\u3059\u308b\u5834\u5408\u306e\u6027\u80fd\u5dee\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u308a\u307e\u3057\u305f\u3002\n\n![b.png](https://qiita-image-store.s3.amazonaws.com/0/108990/53110a91-23eb-27f9-30af-4aba248ce05c.png)\n\nconntrack\u3057\u306a\u3044\u5834\u5408\u306b\u6bd4\u3079\u3001conntrack\u3059\u308b\u5834\u5408\u306f\u5373\u5ea7\u306b42%\u7a0b\u5ea6\u307e\u3067\u6027\u80fd\u4f4e\u4e0b\u3057\u307e\u3059\u3002\n\u307e\u305f\u3001\u30bb\u30c3\u30b7\u30e7\u30f3\u6570\u304c\u5897\u3048\u308b\u306b\u5f93\u3044conntrack\u30c6\u30fc\u30d6\u30eb\u306e\u66f4\u65b0/\u691c\u7d22\u30b3\u30b9\u30c8\u304c\u4e0a\u304c\u308b\u305f\u3081\u30012,000\u4e07\u30a8\u30f3\u30c8\u30ea\u6642\u306b\u306f22%\u7a0b\u5ea6\u307e\u3067\u4f4e\u4e0b\u3059\u308b\u3053\u3068\u304c\u308f\u304b\u308a\u307e\u3057\u305f\u3002\n\n# \u307e\u3068\u3081\n\n\u672c\u6a5f\u80fd\u3092\u7528\u3044\u308b\u3053\u3068\u3067\u5b9f\u73fe\u3057\u305f\u3044\u3053\u3068\u304c\u5b9f\u88c5\u3067\u304d\u308b\u3053\u3068\u304c\u308f\u304b\u308a\u3001\u6a5f\u80fd\u8a55\u4fa1\u3068\u3057\u3066\u306f\u6e80\u8db3\u306e\u3044\u304f\u7d50\u679c\u3068\u306a\u308a\u307e\u3057\u305f\u3002\u307e\u305f\u3001\u30a8\u30fc\u30b8\u30f3\u30b0(\u8ca0\u8377\u3092\u7d99\u7d9a\u7684\u306b\u304b\u3051\u3066\u4e0d\u5b89\u5b9a\u306b\u306a\u3089\u306a\u3044\u304b)\u3082\u884c\u3044\u307e\u3057\u305f\u304c\u3001\u4eca\u306e\u3068\u3053\u308d\u554f\u984c\u306a\u3044\u3088\u3046\u3067\u3057\u305f\u3002\n\n\u3057\u304b\u3057\u306a\u304c\u3089\u3001\u6027\u80fd\u4f4e\u4e0b\u304c\u3060\u3044\u3076\u53b3\u3057\u3044\u3067\u3059\u3002[\u5f0a\u793e\u306e\u30af\u30e9\u30a6\u30c9](http://cloud.sakura.ad.jp/)\u3067\u306f\u3001[\u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b5](http://cloud-news.sakura.ad.jp/load-balancer/)\u3084[\u30eb\u30fc\u30bf\u30a2\u30d7\u30e9\u30a4\u30a2\u30f3\u30b9](http://cloud-news.sakura.ad.jp/vpc-router/)\u306e\u6027\u80fd\u76ee\u5b89\u3092\u516c\u958b\u3057\u3066\u3044\u307e\u3059\u304c\u3001\u3053\u308c\u3089\u306f\u5168\u3066\u4eee\u60f3\u30a2\u30d7\u30e9\u30a4\u30a2\u30f3\u30b9\u3067\u306f\u306a\u304f\u3001\u4eee\u60f3\u30b9\u30a4\u30c3\u30c1(Open vSwitch)\u306e\u30dc\u30c8\u30eb\u30cd\u30c3\u30af\u306b\u3088\u308b\u3082\u306e\u3067\u3059\u3002\n\nOpen vSwitch\u306e\u9650\u754c\u6027\u80fd\u3092\u3082\u3068\u306b\u3001\u30de\u30eb\u30c1\u30c6\u30ca\u30f3\u30c8\u3057\u305f\u5834\u5408\u306b1\u30e6\u30fc\u30b6\u3042\u305f\u308a\u3053\u308c\u304f\u3089\u3044\u306f\u5927\u4e08\u592b\u3060\u308d\u3046\u7684\u306a\u3001\u30ae\u30ea\u30ae\u30ea\u306e\u5024\u3092\u7d5e\u308a\u51fa\u3057\u3066\u3044\u307e\u3059\u3002conntrack\u3059\u308b\u5834\u5408\u306f\u3001\u3053\u308c\u3089\u306e\u5024\u306e\u898b\u76f4\u3057\u304c\u5fc5\u8981\u305d\u3046\u3067\u3059(\u6d99)\n\n\u3042\u3068\u3082\u3046\u4e00\u3064\u3001conntrack\u3067\u306fL2\u306e\u60c5\u5831\u304c\u6301\u3066\u305a\u3001L3\u4ee5\u4e0a\u306e\u60c5\u5831(IP\u30a2\u30c9\u30ec\u30b9\u3084\u30dd\u30fc\u30c8\u756a\u53f7)\u3057\u304b\u4fdd\u6301\u3067\u304d\u306a\u3044\u305f\u3081\u6ce8\u610f\u304c\u5fc5\u8981\u3067\u3059\u3002\u5177\u4f53\u7684\u306b\u306f\u3001\u7570\u306a\u308b\u30e6\u30fc\u30b6\u304c\u7570\u306a\u308bVLAN\u4e0a\u3067\u540c\u3058IP\u30a2\u30c9\u30ec\u30b9\u5e2f(192.168.0.0/24\u306a\u3069)\u3092\u4f7f\u7528\u3057\u3066\u3044\u305f\u5834\u5408\u3001\u3042\u308b\u30e6\u30fc\u30b6\u306e\u901a\u4fe1\u306b\u3088\u3063\u3066\u751f\u6210\u3055\u308c\u305fconntrack\u30a8\u30f3\u30c8\u30ea\u306b\u3088\u3063\u3066\u3001\u5225\u306e\u30e6\u30fc\u30b6\u306e\u901a\u4fe1\u304c\u610f\u56f3\u305b\u305a\u8a31\u53ef\u3055\u308c\u3066\u3057\u307e\u3046\u53ef\u80fd\u6027\u304c\u3042\u308a\u307e\u3059\u3002\u3053\u308c\u306b\u3064\u3044\u3066\u306f\u3001zone\u3092\u6307\u5b9a\u3059\u308b\u3053\u3068\u3067\u89e3\u6c7a\u3067\u304d\u305d\u3046\u306a\u306e\u3067\u3001\u6298\u3092\u307f\u3066\u8a66\u3057\u3066\u307f\u3088\u3046\u3068\u601d\u3044\u307e\u3059\u3002\n\nhttp://openvswitch.org/support/dist-docs/ovs-ofctl.8.html\n\n```\n       ct_zone=zone\n              Matches  the  given  16-bit connection zone exactly. This repre-\n              sents the most recent connection tracking context  that  ct  was\n              executed  in.  Each  zone  is an independent connection tracking\n              context, so if you wish to track the  same  packet  in  multiple\n              contexts  then you must use the ct action multiple times. Intro-\n              duced in Open vSwitch 2.5.\n```\n\n\u9577\u3005\u3068\u6700\u5f8c\u307e\u3067\u304a\u4ed8\u304d\u5408\u3044\u3044\u305f\u3060\u304d\u307e\u3057\u3066\u3042\u308a\u304c\u3068\u3046\u3054\u3056\u3044\u307e\u3057\u305f\uff57\n"}