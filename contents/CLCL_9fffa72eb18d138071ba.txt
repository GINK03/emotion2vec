{"tags": ["fluentd0.12", "td-agent22.2.0", "Apache2.2"], "context": " More than 1 year has passed since last update.Apache\u306e\u30a2\u30af\u30bb\u30b9\u30ed\u30b0\u306e\u66f8\u5f0f\u3001\u305d\u308c\u3092fluentd\u7b49\u306e\u4ed6\u306e\u30ed\u30b0\u53ce\u96c6\u30b7\u30b9\u30c6\u30e0\u306b\u6301\u3063\u3066\u3044\u304f\u3068\u304d\u306e\u554f\u984c\u3067\u3059\u3002\n\nApache\u30ed\u30b0 \"%U%q\" \u306e\u30d1\u30b9\u51fa\u529b\u306f\"%r\"\u3068\u4e92\u63db\u6027\u304c\u7121\u3044\nApache\u306emod_rewrite\u306b\u3088\u308b\u5185\u90e8\u30ea\u30c0\u30a4\u30ec\u30af\u30c8\u898f\u5247\u3092\u9069\u7528\u3059\u308b\u5834\u5408\u3001\u4f8b\u3048\u3070\u4e0b\u8a18\u306e\u3088\u3046\u306a\n\n.htaccess\n<IfModule mod_rewrite.c>\n    RewriteEngine On\n    RewriteCond %{REQUEST_FILENAME} !-d\n    RewriteCond %{REQUEST_FILENAME} !-f\n    RewriteRule ^(.*)$ index.php?url=$1 [QSA,L]\n</IfModule>\n\n\n\u3068\u3044\u3046\u8a2d\u5b9a\u3092\u4f7f\u3046\u5834\u5408\u3001\u4f8b\u3048\u3070 http://example.com/top/ \u3068\u3044\u3046URL\u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3068\u3001Apache\u306e\u30ab\u30b9\u30bf\u30e0\u30ed\u30b0\u30d5\u30a9\u30fc\u30de\u30c3\u30c8\u3067\u3044\u3046\u3068\u3001\n%r: GET /top/ HTTP/1.1\n\n%U: /top/\n%q: ?url=top/\n\n\u3068\u306a\u308a\u3001\n%U%q: /top/?url=top/\n\n\u3068\u306a\u308a\u307e\u3059\u3002/top/ \u306b\u306a\u3063\u3066\u307b\u3057\u3044\u306e\u306b\u3001\u5185\u90e8rewrite\u51e6\u7406\u3067\u751f\u6210\u3055\u308c\u305f?url=top \u304c\u4ed8\u3044\u3066\u3057\u307e\u3046\u306e\u3067\u3059\u3002\u305d\u306e\u6642\u306eredirect_log\u306f\u3053\u3093\u306a\u611f\u3058\u3002\n\nredirect_log\n(3) [perdir /var/www/html/] add path info postfix: /var/www/html/top -> /var/www/html/top/\n(3) [perdir /var/www/html/] strip per-dir prefix: /var/www/html/top/ -> top/\n(3) [perdir /var/www/html/] applying pattern '^(.*)$' to uri 'top/'\n(4) [perdir /var/www/html/] RewriteCond: input='/var/www/html/top' pattern='!-d' => matched\n(4) [perdir /var/www/html/] RewriteCond: input='/var/www/html/top' pattern='!-f' => matched\n(2) [perdir /var/www/html/] rewrite 'top/' -> 'index.php?url=top/'\n(3) split uri=index.php?url=top/ -> uri=index.php, args=url=top/\n(3) [perdir /var/www/html/] add per-dir prefix: index.php -> /var/www/html/index.php\n(2) [perdir /var/www/html/] trying to replace prefix /var/www/html/ with /\n(5) strip matching prefix: /var/www/html/index.php -> index.php\n(4) add subst prefix: index.php -> /index.php\n(1) [perdir /var/www/html/] internal redirect with /index.php [INTERNAL REDIRECT]\n\n\nfluentd\u306e\u30ed\u30b0\u8ee2\u9001\u3067\u4f7f\u3046LTSV\u30d5\u30a9\u30fc\u30de\u30c3\u30c8\u6307\u5b9a\u3067\u3001\u30d1\u30b9\u306e\u8868\u8a18\u306b%U%q\u3067\u6307\u5b9a\u3057\u3066\u3044\u308b\u4f8b\u304c\u591a\u3044\u306e\u3067\u3001\u3053\u306e\u307e\u307e\u3060\u3068\u901a\u5e38\u306eApache\u30ed\u30b0\u3068fluentd\u3067\u53ce\u96c6\u3057\u305fLTSV\u8868\u8a18Apache\u30ed\u30b0\u3067\u30d1\u30b9\u8868\u8a18\u304c\u98df\u3044\u9055\u3046\u3053\u3068\u306b\u2026\u2026\n\n\u3053\u3053\u3067\u5510\u7a81\u306bApache CustomLog\u66f8\u5f0f\u306e\u78ba\u8a8d\nhttp://httpd.apache.org/docs/2.2/ja/mod/mod_log_config.html\n\n\n\n\u30d5\u30a9\u30fc\u30de\u30c3\u30c8\u6587\u5b57\u5217\n\u8aac\u660e\n\n\n\n\n%q\n\u554f\u3044\u5408\u305b\u6587\u5b57\u5217 (\u5b58\u5728\u3059\u308b\u5834\u5408\u306f\u524d\u306b ? \u304c\u8ffd\u52a0\u3055\u308c\u308b\u3002 \u305d\u3046\u3067\u306a\u3044\u5834\u5408\u306f\u7a7a\u6587\u5b57\u5217)\n\n\n%r\n\u30ea\u30af\u30a8\u30b9\u30c8\u306e\u6700\u521d\u306e\u884c\n\n\n%U\n\u30ea\u30af\u30a8\u30b9\u30c8\u3055\u308c\u305f URL \u30d1\u30b9\u3002\u30af\u30a8\u30ea\u6587\u5b57\u5217\u306f\u542b\u307e\u306a\u3044\n\n\n\n\n\u4fee\u98fe\u5b50\n\uff08\u7565\uff09\n\u4fee\u98fe\u5b50 \"<\" \u3068 \">\" \u306f\u5185\u90e8\u30ea\u30c0\u30a4\u30ec\u30af\u30c8\u3055\u308c\u305f\u30ea\u30af\u30a8\u30b9\u30c8\u306e\u30ed\u30b0\u306b \u5143\u306e\u30ea\u30af\u30a8\u30b9\u30c8\u304b\u6700\u7d42\u7684\u306a\u30ea\u30af\u30a8\u30b9\u30c8\u306e\u3069\u3061\u3089\u3092\u4f7f\u7528\u3059\u308b\u304b\u3092 \u6307\u5b9a\u3059\u308b\u305f\u3081\u306b\u4f7f\u3044\u307e\u3059\u3002\u30c7\u30d5\u30a9\u30eb\u30c8\u3067\u306f\u3001% \u30c7\u30a3\u30ec\u30af\u30c6\u30a3\u30d6\u306e %s, %U, %T, %D, %r \u306f\u5143\u306e\u30ea\u30af\u30a8\u30b9\u30c8\u3092\u3001\u4ed6\u306f\u6700\u7d42\u7684\u306a\u30ea\u30af\u30a8\u30b9\u30c8\u3092 \u4f7f\u7528\u3057\u307e\u3059\u3002\u4f8b\u3048\u3070\u3001\u30ea\u30af\u30a8\u30b9\u30c8\u306e\u6700\u7d42\u30b9\u30c6\u30fc\u30bf\u30b9\u3092\u8a18\u9332\u3059\u308b\u306b\u306f %>s \u3092\u3001\u5185\u90e8\u7684\u306b\u8a8d\u8a3c\u3055\u308c\u3066\u3044\u306a\u3044\u30ea\u30bd\u30fc\u30b9\u3078\u30ea\u30c0\u30a4\u30ec\u30af\u30c8\u3055\u308c\u305f \u30ea\u30af\u30a8\u30b9\u30c8\u3067\u5143\u306e\u30ea\u30af\u30a8\u30b9\u30c8\u3067\u8a8d\u8a3c\u3055\u308c\u305f\u30e6\u30fc\u30b6\u3092\u8a18\u9332\u3059\u308b\u305f\u3081\u306b\u306f %<u \u3092\u4f7f\u3046\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\n\nLogFormat\u3067%U%<q\u3059\u308c\u3070\u3044\u3044\u3058\u3083\u306a\u3044\n\u52b9\u304b\u306a\u3044\u3093\u3060\u306a\u30fc\u3053\u308c\u304c\n\n\u89e3\u6c7a\u6cd5\n\ntd-agent.conf\n## Apache \u62e1\u5f35ltsv\u30ed\u30b0\u7528\n# LogFormat \"domain:%V\\thost:%h\\tserver:%A\\tuser:%u\\t\n#time:%{%d/%b/%Y:%H:%M:%S %z}t\\tmethod:%m\\tpath:%U%q\\tprotocol:%H\\tcode:%>s\n#\\tsize:%b\\treferer:%{Referer}i\\tagent:%{User-Agent}i\\tresponse_time:%D\\t\n#cookie:%{cookie}i\\tset_cookie:%{Set-Cookie}o\\tcountry:%{GEOIP_COUNTRY_CODE}e\\t\n#requestFirstLine:\\\"%r\\\"\" combined_ltsv\n\n<source>\n  type         tail\n  path         /var/log/httpd/ltsv_access_log\n  pos_file     /var/log/td-agent/apache_access.pos\n  format       ltsv\n  time_key     time\n  time_format  %d/%b/%Y:%H:%M:%S %z\n  tag          apache.access.addHostname.fixPath\n  types        code:integer,size:integer,response_time:integer\n</source>\n\n## record_transformer\u30d7\u30e9\u30b0\u30a4\u30f3\u3067\u3001\u30db\u30b9\u30c8\u3092\u8ffd\u52a0\u3059\u308b\n<filter **.addHostname>\n  @type record_transformer\n  <record>\n    hostname ${hostname}\n  </record>\n</filter>\n\n## record_transformer\u30d7\u30e9\u30b0\u30a4\u30f3\u3067\u3001requestFirstLine\u304b\u3089path\u3092\u5206\u96e2\u3057\u3001\u8ffd\u52a0\u3059\u308b\n<filter **.fixPath>\n  @type record_transformer\n  enable_ruby true\n  <record>\n    path     ${requestFirstLine.split(/ /)[1]}\n  </record>\n  remove_keys  requestFirstLine\n</filter>\n\n\n# Apache\u95a2\u9023\u306e\u30ed\u30b0\u3092\u8ee2\u9001\n<match apache.**>\n  type copy\n\n  # \u30c7\u30d0\u30c3\u30b0\u7528\n  #<store>\n  #  type stdout\n  #</store>\n\n  # fluentd\u30b5\u30fc\u30d0\u306b\u9001\u4fe1\n  <store>\n    type forward\n    flush_interval 30s\n    <server>\n      host fluentd-server.example.com\n      port 24224\n    </server>\n  </store>\n\n</match>\n\n\n\u306a\u3069\u3001apache\u306e\u65b9\u3067%r\u3067requestFirstLine\u3092\u8ffd\u52a0\u3001record_transformer\u30d7\u30e9\u30b0\u30a4\u30f3\u3067requestFirstLine\u304b\u3089path\u90e8\u3092\u5206\u96e2\u3057\u3001path\u3068\u3057\u3066\u8ffd\u52a0\u3059\u308b\u65b9\u6cd5\u3092\u63a1\u7528\u3057\u307e\u3057\u305f\u3002\nfilter\u3084record_transformer\u304c\u4f7f\u3048\u308b\u3001fluentd v0.12\u4ee5\u964d\uff08td-agent2\u306a\u30892015/4/6\u306etd-agent v2.2.0\u4ee5\u964d\uff09\u304c\u5fc5\u8981\u3002\n[http://cl.hatenablog.com/entry/apache-customlog \u3088\u308a\u52a0\u7b46]\nApache\u306e\u30a2\u30af\u30bb\u30b9\u30ed\u30b0\u306e\u66f8\u5f0f\u3001\u305d\u308c\u3092fluentd\u7b49\u306e\u4ed6\u306e\u30ed\u30b0\u53ce\u96c6\u30b7\u30b9\u30c6\u30e0\u306b\u6301\u3063\u3066\u3044\u304f\u3068\u304d\u306e\u554f\u984c\u3067\u3059\u3002\n\n# Apache\u30ed\u30b0 \"%U%q\" \u306e\u30d1\u30b9\u51fa\u529b\u306f\"%r\"\u3068\u4e92\u63db\u6027\u304c\u7121\u3044\n\nApache\u306emod_rewrite\u306b\u3088\u308b\u5185\u90e8\u30ea\u30c0\u30a4\u30ec\u30af\u30c8\u898f\u5247\u3092\u9069\u7528\u3059\u308b\u5834\u5408\u3001\u4f8b\u3048\u3070\u4e0b\u8a18\u306e\u3088\u3046\u306a\n\n```sh:.htaccess\n<IfModule mod_rewrite.c>\n    RewriteEngine On\n    RewriteCond %{REQUEST_FILENAME} !-d\n    RewriteCond %{REQUEST_FILENAME} !-f\n    RewriteRule ^(.*)$ index.php?url=$1 [QSA,L]\n</IfModule>\n```\n\n\u3068\u3044\u3046\u8a2d\u5b9a\u3092\u4f7f\u3046\u5834\u5408\u3001\u4f8b\u3048\u3070 http://example.com/top/ \u3068\u3044\u3046URL\u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3068\u3001Apache\u306e\u30ab\u30b9\u30bf\u30e0\u30ed\u30b0\u30d5\u30a9\u30fc\u30de\u30c3\u30c8\u3067\u3044\u3046\u3068\u3001\n\n```\n%r: GET /top/ HTTP/1.1\n\n%U: /top/\n%q: ?url=top/\n```\n\n\u3068\u306a\u308a\u3001\n\n```\n%U%q: /top/?url=top/\n```\n\n\u3068\u306a\u308a\u307e\u3059\u3002``/top/`` \u306b\u306a\u3063\u3066\u307b\u3057\u3044\u306e\u306b\u3001\u5185\u90e8rewrite\u51e6\u7406\u3067\u751f\u6210\u3055\u308c\u305f``?url=top`` \u304c\u4ed8\u3044\u3066\u3057\u307e\u3046\u306e\u3067\u3059\u3002\u305d\u306e\u6642\u306eredirect_log\u306f\u3053\u3093\u306a\u611f\u3058\u3002\n\n```sh:redirect_log\n(3) [perdir /var/www/html/] add path info postfix: /var/www/html/top -> /var/www/html/top/\n(3) [perdir /var/www/html/] strip per-dir prefix: /var/www/html/top/ -> top/\n(3) [perdir /var/www/html/] applying pattern '^(.*)$' to uri 'top/'\n(4) [perdir /var/www/html/] RewriteCond: input='/var/www/html/top' pattern='!-d' => matched\n(4) [perdir /var/www/html/] RewriteCond: input='/var/www/html/top' pattern='!-f' => matched\n(2) [perdir /var/www/html/] rewrite 'top/' -> 'index.php?url=top/'\n(3) split uri=index.php?url=top/ -> uri=index.php, args=url=top/\n(3) [perdir /var/www/html/] add per-dir prefix: index.php -> /var/www/html/index.php\n(2) [perdir /var/www/html/] trying to replace prefix /var/www/html/ with /\n(5) strip matching prefix: /var/www/html/index.php -> index.php\n(4) add subst prefix: index.php -> /index.php\n(1) [perdir /var/www/html/] internal redirect with /index.php [INTERNAL REDIRECT]\n```\n\nfluentd\u306e\u30ed\u30b0\u8ee2\u9001\u3067\u4f7f\u3046LTSV\u30d5\u30a9\u30fc\u30de\u30c3\u30c8\u6307\u5b9a\u3067\u3001\u30d1\u30b9\u306e\u8868\u8a18\u306b``%U%q``\u3067\u6307\u5b9a\u3057\u3066\u3044\u308b\u4f8b\u304c\u591a\u3044\u306e\u3067\u3001\u3053\u306e\u307e\u307e\u3060\u3068**\u901a\u5e38\u306eApache\u30ed\u30b0\u3068fluentd\u3067\u53ce\u96c6\u3057\u305fLTSV\u8868\u8a18Apache\u30ed\u30b0\u3067\u30d1\u30b9\u8868\u8a18\u304c\u98df\u3044\u9055\u3046**\u3053\u3068\u306b\u2026\u2026\n\n# \u3053\u3053\u3067\u5510\u7a81\u306bApache CustomLog\u66f8\u5f0f\u306e\u78ba\u8a8d\n\n[http://httpd.apache.org/docs/2.2/ja/mod/mod_log_config.html](http://httpd.apache.org/docs/2.2/ja/mod/mod_log_config.html)\n\n|\u30d5\u30a9\u30fc\u30de\u30c3\u30c8\u6587\u5b57\u5217|\u8aac\u660e|\n|:--|:--|\n|%q|\u554f\u3044\u5408\u305b\u6587\u5b57\u5217 (\u5b58\u5728\u3059\u308b\u5834\u5408\u306f\u524d\u306b ? \u304c\u8ffd\u52a0\u3055\u308c\u308b\u3002 \u305d\u3046\u3067\u306a\u3044\u5834\u5408\u306f\u7a7a\u6587\u5b57\u5217)|\n|%r|\u30ea\u30af\u30a8\u30b9\u30c8\u306e\u6700\u521d\u306e\u884c|\n|%U|\u30ea\u30af\u30a8\u30b9\u30c8\u3055\u308c\u305f URL \u30d1\u30b9\u3002\u30af\u30a8\u30ea\u6587\u5b57\u5217\u306f\u542b\u307e\u306a\u3044|\n\n> \u4fee\u98fe\u5b50\n>\uff08\u7565\uff09\n>\u4fee\u98fe\u5b50 \"<\" \u3068 \">\" \u306f\u5185\u90e8\u30ea\u30c0\u30a4\u30ec\u30af\u30c8\u3055\u308c\u305f\u30ea\u30af\u30a8\u30b9\u30c8\u306e\u30ed\u30b0\u306b \u5143\u306e\u30ea\u30af\u30a8\u30b9\u30c8\u304b\u6700\u7d42\u7684\u306a\u30ea\u30af\u30a8\u30b9\u30c8\u306e\u3069\u3061\u3089\u3092\u4f7f\u7528\u3059\u308b\u304b\u3092 \u6307\u5b9a\u3059\u308b\u305f\u3081\u306b\u4f7f\u3044\u307e\u3059\u3002\u30c7\u30d5\u30a9\u30eb\u30c8\u3067\u306f\u3001% \u30c7\u30a3\u30ec\u30af\u30c6\u30a3\u30d6\u306e %s, %U, %T, %D, %r \u306f\u5143\u306e\u30ea\u30af\u30a8\u30b9\u30c8\u3092\u3001\u4ed6\u306f\u6700\u7d42\u7684\u306a\u30ea\u30af\u30a8\u30b9\u30c8\u3092 \u4f7f\u7528\u3057\u307e\u3059\u3002\u4f8b\u3048\u3070\u3001\u30ea\u30af\u30a8\u30b9\u30c8\u306e\u6700\u7d42\u30b9\u30c6\u30fc\u30bf\u30b9\u3092\u8a18\u9332\u3059\u308b\u306b\u306f %>s \u3092\u3001\u5185\u90e8\u7684\u306b\u8a8d\u8a3c\u3055\u308c\u3066\u3044\u306a\u3044\u30ea\u30bd\u30fc\u30b9\u3078\u30ea\u30c0\u30a4\u30ec\u30af\u30c8\u3055\u308c\u305f \u30ea\u30af\u30a8\u30b9\u30c8\u3067\u5143\u306e\u30ea\u30af\u30a8\u30b9\u30c8\u3067\u8a8d\u8a3c\u3055\u308c\u305f\u30e6\u30fc\u30b6\u3092\u8a18\u9332\u3059\u308b\u305f\u3081\u306b\u306f %<u \u3092\u4f7f\u3046\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\n# LogFormat\u3067%U%<q\u3059\u308c\u3070\u3044\u3044\u3058\u3083\u306a\u3044\n\n\u52b9\u304b\u306a\u3044\u3093\u3060\u306a\u30fc\u3053\u308c\u304c\n\n# \u89e3\u6c7a\u6cd5\n\n```sh:td-agent.conf\n## Apache \u62e1\u5f35ltsv\u30ed\u30b0\u7528\n# LogFormat \"domain:%V\\thost:%h\\tserver:%A\\tuser:%u\\t\n#time:%{%d/%b/%Y:%H:%M:%S %z}t\\tmethod:%m\\tpath:%U%q\\tprotocol:%H\\tcode:%>s\n#\\tsize:%b\\treferer:%{Referer}i\\tagent:%{User-Agent}i\\tresponse_time:%D\\t\n#cookie:%{cookie}i\\tset_cookie:%{Set-Cookie}o\\tcountry:%{GEOIP_COUNTRY_CODE}e\\t\n#requestFirstLine:\\\"%r\\\"\" combined_ltsv\n\n<source>\n  type         tail\n  path         /var/log/httpd/ltsv_access_log\n  pos_file     /var/log/td-agent/apache_access.pos\n  format       ltsv\n  time_key     time\n  time_format  %d/%b/%Y:%H:%M:%S %z\n  tag          apache.access.addHostname.fixPath\n  types        code:integer,size:integer,response_time:integer\n</source>\n\n## record_transformer\u30d7\u30e9\u30b0\u30a4\u30f3\u3067\u3001\u30db\u30b9\u30c8\u3092\u8ffd\u52a0\u3059\u308b\n<filter **.addHostname>\n  @type record_transformer\n  <record>\n    hostname ${hostname}\n  </record>\n</filter>\n\n## record_transformer\u30d7\u30e9\u30b0\u30a4\u30f3\u3067\u3001requestFirstLine\u304b\u3089path\u3092\u5206\u96e2\u3057\u3001\u8ffd\u52a0\u3059\u308b\n<filter **.fixPath>\n  @type record_transformer\n  enable_ruby true\n  <record>\n    path     ${requestFirstLine.split(/ /)[1]}\n  </record>\n  remove_keys  requestFirstLine\n</filter>\n\n\n# Apache\u95a2\u9023\u306e\u30ed\u30b0\u3092\u8ee2\u9001\n<match apache.**>\n  type copy\n\n  # \u30c7\u30d0\u30c3\u30b0\u7528\n  #<store>\n  #  type stdout\n  #</store>\n\n  # fluentd\u30b5\u30fc\u30d0\u306b\u9001\u4fe1\n  <store>\n    type forward\n    flush_interval 30s\n    <server>\n      host fluentd-server.example.com\n      port 24224\n    </server>\n  </store>\n\n</match>\n```\n\n\u306a\u3069\u3001apache\u306e\u65b9\u3067%r\u3067requestFirstLine\u3092\u8ffd\u52a0\u3001record_transformer\u30d7\u30e9\u30b0\u30a4\u30f3\u3067requestFirstLine\u304b\u3089path\u90e8\u3092\u5206\u96e2\u3057\u3001path\u3068\u3057\u3066\u8ffd\u52a0\u3059\u308b\u65b9\u6cd5\u3092\u63a1\u7528\u3057\u307e\u3057\u305f\u3002\n\nfilter\u3084record_transformer\u304c\u4f7f\u3048\u308b\u3001fluentd v0.12\u4ee5\u964d\uff08td-agent2\u306a\u30892015/4/6\u306etd-agent v2.2.0\u4ee5\u964d\uff09\u304c\u5fc5\u8981\u3002\n\n[http://cl.hatenablog.com/entry/apache-customlog \u3088\u308a\u52a0\u7b46]\n"}