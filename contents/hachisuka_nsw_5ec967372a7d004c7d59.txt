{"context": "Linux\u7248\u306eScratch1.4\u3067\u65e5\u672c\u8a9e\u5165\u529b\u65e5\u672c\u8a9e\u5165\u529b\u3092\u3067\u304d\u308b\u3088\u3046\u306b\u3057\u305f\u6642\u306e\u30e1\u30e2\u3067\u3059\u3002Ubuntu12\u3068Raspberry Pi\u3067\u52d5\u304fRaspbian\u3067\u52d5\u304f\u3053\u3068\u3092\u78ba\u8a8d\u3057\u3066\u3044\u307e\u3059\u3002\u203bRaspbian\u306b\u3064\u3044\u3066\u306fQEMU\u4e0a\u3067\u691c\u8a3c\u306a\u306e\u3067\u5b9f\u6a5f\u3067\u306f\u691c\u8a3c\u3057\u3066\u3044\u306a\u3044\u306e\u3067\u3059\u304c\u3001\u5b9f\u6a5f\u3067\u3082\u3067\u304d\u305f\u3068\u3044\u3046\u3088\u3046\u306a\u8a71\u306f\u805e\u3044\u3066\u3044\u307e\u3059\u3002\n\n\u3069\u3046\u3084\u3063\u3066\u5b9f\u73fe\u3059\u308b\uff1f\nScratch\u306f\u30bd\u30fc\u30b9\u30b3\u30fc\u30c9\u306fScratch 1.4 Source Code\u3067\u516c\u958b\u3055\u308c\u3066\u3044\u307e\u3059\u304cScratch\u3068\u3044\u3046\u540d\u524d\u3084\u30ed\u30b4\u304c\u4f7f\u3048\u306a\u304b\u3063\u305f\u308a\u3001Scratch\u306e\u30b5\u30a4\u30c8\u306b\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u3067\u304d\u306a\u3044\u306a\u3069\u306e\u6761\u4ef6\u304c\u3042\u308a\u307e\u3059\u306e\u3067\u3001\u4eca\u56de\u306fScratch\u81ea\u4f53\u306b\u5909\u66f4\u3092\u52a0\u3048\u308b\u306e\u3067\u306f\u306a\u304fVM\u306e\u65b9\u306b\u5909\u66f4\u3092\u52a0\u3048\u3066\u307f\u3088\u3046\u3068\u601d\u3044\u307e\u3059\u3002\n\u4ee5\u524d\u3069\u3053\u304b\u306eML\u3067Scratch\u306futf32\u3092\u671f\u5f85\u3057\u3066\u3044\u308b\u3068\u3044\u3046\u306e\u3092\u8aad\u3093\u3060\u4e8b\u304c\u3042\u308a\u307e\u3059\u306e\u3067\u3001Scratch\u306e\u671f\u5f85\u3059\u308butf32\u3092VM\u304cScratch\u306b\u6e21\u3057\u3066\u3042\u3052\u308b\u3088\u3046\u306b\u5909\u66f4\u3057\u3066\u307f\u307e\u3059\u3002\n\nScratch\u306e\u8a2d\u5b9a\u3068\u8d77\u52d5\n\u307e\u305a\u306fScratch\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u307e\u3059\u3002\n$ sudo apt-get install scratch\n\n\u7d20\u306e\u307e\u307e\u3067\u306fIME\u304c\u8d77\u52d5\u3059\u3089\u3057\u307e\u305b\u3093\u306e\u3067\u3001Scratch\u306e\u8d77\u52d5\u30d5\u30a1\u30a4\u30eb\u4e2d\u306eVMOPTIONS\u306b-compositioninput\u3092\u8ffd\u52a0\u3057\u307e\u3059\u3002\n$ sudo vi /usr/bin/scratch\n\n@@ -7,7 +7,7 @@\n VM_VERSION=`find /usr/lib/squeak/ -name \"squeakvm\" -type f|cut -f5 -d\"/\"`\n SQ_DIR=/usr/lib/squeak/$VM_VERSION\n VM=\"$SQ_DIR/squeakvm\"\n-VMOPTIONS=\"-encoding UTF-8 -vm-display-x11 -plugins /usr/lib/scratch/plugins/:$SQ_DIR/\"\n+VMOPTIONS=\"-encoding UTF-8 -vm-display-x11 -plugins /usr/lib/scratch/plugins/:$SQ_DIR/ -compositioninput\"\n IMAGE=\"/usr/share/scratch/Scratch.image\"\n IMOPTIONS=\"\"\n DOCUMENT=\"\"\n\nScratch\u306f\u3092\u8d77\u52d5\u3057\u3066\u307f\u307e\u3059\u3002-compositioninput\u30aa\u30d7\u30b7\u30e7\u30f3\u3092\u6307\u5b9a\u3057\u305f\u3053\u3068\u306b\u3088\u3063\u3066IME\u304c\u4f7f\u3048\u308b\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u306e\u3067\u8a66\u3057\u306b\u300c\u3042\u3044\u3046\u3048\u304a\u300d\u3068\u65e5\u672c\u8a9e\u3092\u5165\u529b\u3057\u3066\u307f\u307e\u3059\u3002\n\n\u3081\u3067\u305f\u304f\uff1f\u5316\u3051\u6587\u5b57\u304c\u5165\u529b\u3067\u304d\u307e\u3057\u305f\uff01\u300c0081\u300d\u300c0082\u300d\u3042\u305f\u308a\u304b\u3089utf8\u3089\u3057\u3044\u4e8b\u304c\u5206\u304b\u308a\u307e\u3059\u3002\u3053\u3053\u3067utf8\u307d\u3044\u96f0\u56f2\u6c17\u304c\u78ba\u8a8d\u3067\u304d\u306a\u3044\u3068\u5927\u5909\u305d\u3046\u3060\u3063\u305f\u3093\u3067\u3059\u304c\u3001\u3061\u3087\u3063\u3068\u3072\u3068\u5b89\u5fc3\u3067\u3059\u3002\n\nVM\u306e\u5909\u66f4\n\u307e\u305a\u306fVM\u306e\u30b3\u30f3\u30d1\u30a4\u30eb\u306b\u5fc5\u8981\u306a\u30d1\u30c3\u30b1\u30fc\u30b8\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u307e\u3059\u3002\n$ sudo apt-get install cmake g++ xorg-dev\n\n\u3064\u3065\u3051\u3066VM\u306e\u30bd\u30fc\u30b9\u30b3\u30fc\u30c9\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3059\u308b\u305f\u3081\u306b\u4eca\u4f7f\u3063\u3066\u3044\u308bVM\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u3092\u8abf\u3079\u307e\u3059\u3002\u30d0\u30fc\u30b8\u30e7\u30f3\u3092\u8abf\u3079\u308b\u306b\u306fls -Al /usr/lib/squeak/\u3092\u5b9f\u884c\u3057\u307e\u3059\u3002\u79c1\u306e\u74b0\u5883\u3067\u306f4.4.7-2357\u3067\u3042\u308b\u4e8b\u304c\u5206\u304b\u308a\u307e\u3059\u3002\n$ ls -Al /usr/lib/squeak/\ntotal 4\ndrwxr-xr-x 2 root root 4096  6\u6708  8 21:26 4.4.7-2357\n\nhttps://packages.debian.org/ja/wheezy/squeak-vm \u3084 http://ftp.de.debian.org/debian/pool/main/s/squeak-vm/ \u3042\u305f\u308a\u304b\u3089\u8fd1\u3044\u30d0\u30fc\u30b8\u30e7\u30f3\u3092\u63a2\u3057\u307e\u3059\u3002\u4eca\u56de\u306f\u540c\u3058\u30d0\u30fc\u30b8\u30e7\u30f3\u304c\u3042\u308a\u307e\u3057\u305f\u306e\u3067squeak-vm_4.4.7.2357.orig.tar.gz\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u307e\u3059\u304c\u3001\u3082\u3057\u540c\u3058\u30d0\u30fc\u30b8\u30e7\u30f3\u304c\u306a\u3044\u5834\u5408\u306f\u8fd1\u3044\u3082\u306e\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u3066\u8a66\u3057\u3066\u307f\u308b\u3068\u3044\u3046\u4e8b\u306b\u306a\u308a\u307e\u3059\u3002\n\u89e3\u51cd\u3057\u307e\u3059\u3002\n$ tar xvfz squeak-vm_4.4.7.2357.orig.tar.gz\n\n\u30bd\u30fc\u30b9\u30b3\u30fc\u30c9\u3092\u5909\u66f4\u3057\u307e\u3059\u3002\u691c\u8a3c\u30b3\u30fc\u30c9\u3068\u3044\u3046\u4e8b\u3067\u529b\u6280\u3067\u66f8\u3044\u305f\u306e\u3067\u9577\u3044\u30b3\u30fc\u30c9\u306b\u306a\u3063\u3066\u3057\u307e\u3044\u307e\u3057\u305f\u304c\u3001\u4e2d\u8eab\u306futf8\u3092utf32\u306b\u5909\u63db\u3059\u308b\u3060\u3051\u306e\u3082\u306e\u3067\u3059\u3002\u63a2\u305b\u3070\u666e\u901a\u306b\u95a2\u6570\u3068\u304b\u3042\u308b\u306e\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u2026\n$ cd squeak-vm-4.4.7.2357.orig\n$ vi unix/vm-display-X11/sqUnixX11.c\n\n\nunix/vm-display-X11/sqUnixX11.c\n@@ -1699,29 +1699,64 @@ static unsigned char *lookupKeys(int (*l\n\n static int recordPendingKeys(void)\n {\n-  if (inputCount > 0)\n-    {\n-      int i= iebOut - iebIn;\n-      for (i= (i > 0 ? i : IEB_SIZE + i) / 4; i > 0; -- i)\n-   {\n-# if defined(DEBUG_XIM)\n-     fprintf(stderr, \"%3d pending key %2d=0x%02x\\n\", inputCount, i, *pendingKey);\n-# endif\n-     recordKeyboardEvent(*pendingKey, EventKeyDown, modifierState, 0);\n-     recordKeyboardEvent(*pendingKey, EventKeyChar, modifierState, 0);\n-     recordKeystroke(*pendingKey);  /* DEPRECATED */\n-     ++pendingKey;\n-     if (--inputCount == 0) break;\n-   }\n-      return 1;\n-    }\n-  /* inputBuf is allocated by lookupKeys */\n-  if (inputBuf != inputString)\n-    {\n+  if (inputCount <= 0) {\n+    if (inputBuf != inputString) {\n       free(inputBuf);\n       inputBuf= inputString;\n     }\n-  return 0;\n+    return 0;\n+  }\n+\n+  int utf32 = 0;\n+  while (inputCount > 0) {\n+   //110x xxxx 10xx xxxx\n+   if(inputCount >= 2 &&\n+      pendingKey[0] >= 0xc0 && pendingKey[0] <= 0xdf && \n+      pendingKey[1] >= 0x80 && pendingKey[1] <= 0xbf)\n+       {\n+       utf32 = ((pendingKey[0] & 0x1f) << 6) | \n+            (pendingKey[1] & 0x3f);\n+           recordKeyboardEvent(0, EventKeyDown, modifierState, utf32);\n+           recordKeyboardEvent(0, EventKeyChar, modifierState, utf32);\n+       pendingKey+=2;\n+       inputCount-=2;\n+   //1110 xxxx 10xx xxxx 10xx xxxx\n+   } else if(inputCount >= 3 &&\n+         pendingKey[0] >= 0xe0 && pendingKey[0] <= 0xef && \n+         pendingKey[1] >= 0x80 && pendingKey[1] <= 0xbf && \n+         pendingKey[2] >= 0x80 && pendingKey[2] <= 0xbf)\n+       {\n+       utf32 = ((pendingKey[0]  & 0x0f) << 12) | \n+           ((pendingKey[1] & 0x3f) << 6) | \n+            (pendingKey[2] & 0x3f);\n+           recordKeyboardEvent(0, EventKeyDown, modifierState, utf32);\n+           recordKeyboardEvent(0, EventKeyChar, modifierState, utf32);\n+       pendingKey+=3;\n+       inputCount-=3;\n+   //1111 0xxx 10xx xxxx 10xx xxxx 10xx xxxx\n+   } else if(inputCount >= 4 &&\n+         pendingKey[0] >= 0xf0 && pendingKey[0] <= 0xf7 && \n+         pendingKey[1] >= 0x80 && pendingKey[1] <= 0xbf && \n+         pendingKey[2] >= 0x80 && pendingKey[2] <= 0xbf && \n+         pendingKey[3] >= 0x80 && pendingKey[3] <= 0xbf)\n+       {\n+       utf32 = ((pendingKey[0] & 0x07) << 18) | \n+           ((pendingKey[1] & 0x3f) << 12) |\n+           ((pendingKey[2] & 0x3f) << 6) |\n+            (pendingKey[3] & 0x3f);\n+           recordKeyboardEvent(0, EventKeyDown, modifierState, utf32);\n+           recordKeyboardEvent(0, EventKeyChar, modifierState, utf32);\n+       pendingKey+=4;\n+       inputCount-=4;\n+   } else {\n+           recordKeyboardEvent(*pendingKey, EventKeyDown, modifierState, 0);\n+           recordKeyboardEvent(*pendingKey, EventKeyChar, modifierState, 0);\n+           recordKeystroke(*pendingKey); /* DEPRECATED */\n+       pendingKey++;\n+       inputCount--;\n+   }\n+  }\n+  return 1;\n }\n\n static int xkeysym2ucs4(KeySym keysym);\n\n\n\u30b3\u30f3\u30d1\u30a4\u30eb\u3057\u307e\u3059\u3002PC\u304c\u3086\u3063\u304f\u308a\u76ee\u306a\u306e\u3067\u3001\u4eca\u56de\u306fvm-display-X11\u306e\u307f\u3092\u30b3\u30f3\u30d1\u30a4\u30eb\u3057\u3066\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3066\u307f\u307e\u3059\u3002\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u306f\u3061\u3087\u3063\u3068\u5f37\u5f15\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u304c\u65e2\u5b58\u306eso.vm-display-X11\u3092\u65b0\u3057\u3044so.vm-display-X11\u306b\u5dee\u3057\u66ff\u3048\u308b\u4e8b\u3067\u884c\u3044\u307e\u3059\u3002\n$ mkdir bld\n$ cd bld\n$ ../unix/cmake/configure\n$ make vm-display-X11\n$ sudo mv /usr/lib/squeak/4.4.7-2357/so.vm-display-X11 /usr/lib/squeak/4.4.7-2357/so.vm-display-X11.orig\n$ sudo cp vm-display-X11/so.vm-display-X11 /usr/lib/squeak/4.4.7-2357/\n\n\u30aa\u30ea\u30b8\u30ca\u30eb\u306eso.vm-display-X11\u3068\u65b0\u3057\u3044fileso.vm-display-X11\u3092\u6bd4\u8f03\u3059\u308b\u3068\u304b\u306a\u308a\u5927\u304d\u304f\u306a\u3063\u3066\u3057\u307e\u3044\u307e\u3057\u305f\u304c\u3001\u3068\u308a\u3042\u3048\u305a\u306f\u6c17\u306b\u3057\u306a\u3044\u3067\u304a\u304d\u307e\u3059\u3002\n$ ls -Al /usr/lib/squeak/4.4.7-2357/so.vm-display-X11*\n-rwxr-xr-x 1 root root 279934  7\u6708  2 12:26 so.vm-display-X11\n-rw-r--r-- 1 root root  96860  4\u6708 25  2012 so.vm-display-X11.orig\n\nScratch\u3092\u8d77\u52d5\u3057\u3066\u65e5\u672c\u8a9e\u304c\u5165\u529b\u3067\u304d\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\nLinux\u7248\u306eScratch1.4\u3067\u65e5\u672c\u8a9e\u5165\u529b\u65e5\u672c\u8a9e\u5165\u529b\u3092\u3067\u304d\u308b\u3088\u3046\u306b\u3057\u305f\u6642\u306e\u30e1\u30e2\u3067\u3059\u3002Ubuntu12\u3068Raspberry Pi\u3067\u52d5\u304f[Raspbian](http://www.raspbian.org/)\u3067\u52d5\u304f\u3053\u3068\u3092\u78ba\u8a8d\u3057\u3066\u3044\u307e\u3059\u3002\u203bRaspbian\u306b\u3064\u3044\u3066\u306fQEMU\u4e0a\u3067\u691c\u8a3c\u306a\u306e\u3067\u5b9f\u6a5f\u3067\u306f\u691c\u8a3c\u3057\u3066\u3044\u306a\u3044\u306e\u3067\u3059\u304c\u3001\u5b9f\u6a5f\u3067\u3082\u3067\u304d\u305f\u3068\u3044\u3046\u3088\u3046\u306a\u8a71\u306f\u805e\u3044\u3066\u3044\u307e\u3059\u3002\n\n## \u3069\u3046\u3084\u3063\u3066\u5b9f\u73fe\u3059\u308b\uff1f\nScratch\u306f\u30bd\u30fc\u30b9\u30b3\u30fc\u30c9\u306f[Scratch 1.4 Source Code](https://wiki.scratch.mit.edu/wiki/Scratch_1.4_Source_Code)\u3067\u516c\u958b\u3055\u308c\u3066\u3044\u307e\u3059\u304cScratch\u3068\u3044\u3046\u540d\u524d\u3084\u30ed\u30b4\u304c\u4f7f\u3048\u306a\u304b\u3063\u305f\u308a\u3001Scratch\u306e\u30b5\u30a4\u30c8\u306b\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u3067\u304d\u306a\u3044\u306a\u3069\u306e\u6761\u4ef6\u304c\u3042\u308a\u307e\u3059\u306e\u3067\u3001\u4eca\u56de\u306fScratch\u81ea\u4f53\u306b\u5909\u66f4\u3092\u52a0\u3048\u308b\u306e\u3067\u306f\u306a\u304fVM\u306e\u65b9\u306b\u5909\u66f4\u3092\u52a0\u3048\u3066\u307f\u3088\u3046\u3068\u601d\u3044\u307e\u3059\u3002\n\n\u4ee5\u524d\u3069\u3053\u304b\u306eML\u3067Scratch\u306futf32\u3092\u671f\u5f85\u3057\u3066\u3044\u308b\u3068\u3044\u3046\u306e\u3092\u8aad\u3093\u3060\u4e8b\u304c\u3042\u308a\u307e\u3059\u306e\u3067\u3001Scratch\u306e\u671f\u5f85\u3059\u308butf32\u3092VM\u304cScratch\u306b\u6e21\u3057\u3066\u3042\u3052\u308b\u3088\u3046\u306b\u5909\u66f4\u3057\u3066\u307f\u307e\u3059\u3002\n\n## Scratch\u306e\u8a2d\u5b9a\u3068\u8d77\u52d5\n\u307e\u305a\u306fScratch\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u307e\u3059\u3002\n\n```console\n$ sudo apt-get install scratch\n```\n\n\u7d20\u306e\u307e\u307e\u3067\u306fIME\u304c\u8d77\u52d5\u3059\u3089\u3057\u307e\u305b\u3093\u306e\u3067\u3001Scratch\u306e\u8d77\u52d5\u30d5\u30a1\u30a4\u30eb\u4e2d\u306e`VMOPTIONS`\u306b`-compositioninput`\u3092\u8ffd\u52a0\u3057\u307e\u3059\u3002\n\n```console\n$ sudo vi /usr/bin/scratch\n```\n```diff\n@@ -7,7 +7,7 @@\n VM_VERSION=`find /usr/lib/squeak/ -name \"squeakvm\" -type f|cut -f5 -d\"/\"`\n SQ_DIR=/usr/lib/squeak/$VM_VERSION\n VM=\"$SQ_DIR/squeakvm\"\n-VMOPTIONS=\"-encoding UTF-8 -vm-display-x11 -plugins /usr/lib/scratch/plugins/:$SQ_DIR/\"\n+VMOPTIONS=\"-encoding UTF-8 -vm-display-x11 -plugins /usr/lib/scratch/plugins/:$SQ_DIR/ -compositioninput\"\n IMAGE=\"/usr/share/scratch/Scratch.image\"\n IMOPTIONS=\"\"\n DOCUMENT=\"\"\n```\n\nScratch\u306f\u3092\u8d77\u52d5\u3057\u3066\u307f\u307e\u3059\u3002`-compositioninput`\u30aa\u30d7\u30b7\u30e7\u30f3\u3092\u6307\u5b9a\u3057\u305f\u3053\u3068\u306b\u3088\u3063\u3066IME\u304c\u4f7f\u3048\u308b\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u306e\u3067\u8a66\u3057\u306b\u300c\u3042\u3044\u3046\u3048\u304a\u300d\u3068\u65e5\u672c\u8a9e\u3092\u5165\u529b\u3057\u3066\u307f\u307e\u3059\u3002\n\n![16-06-30 scratch.png](https://qiita-image-store.s3.amazonaws.com/0/128670/0019d9a7-a27e-0c4e-316c-435a2d2e0de2.png)\n\n\u3081\u3067\u305f\u304f\uff1f\u5316\u3051\u6587\u5b57\u304c\u5165\u529b\u3067\u304d\u307e\u3057\u305f\uff01\u300c0081\u300d\u300c0082\u300d\u3042\u305f\u308a\u304b\u3089utf8\u3089\u3057\u3044\u4e8b\u304c\u5206\u304b\u308a\u307e\u3059\u3002\u3053\u3053\u3067utf8\u307d\u3044\u96f0\u56f2\u6c17\u304c\u78ba\u8a8d\u3067\u304d\u306a\u3044\u3068\u5927\u5909\u305d\u3046\u3060\u3063\u305f\u3093\u3067\u3059\u304c\u3001\u3061\u3087\u3063\u3068\u3072\u3068\u5b89\u5fc3\u3067\u3059\u3002\n\n## VM\u306e\u5909\u66f4\n\u307e\u305a\u306fVM\u306e\u30b3\u30f3\u30d1\u30a4\u30eb\u306b\u5fc5\u8981\u306a\u30d1\u30c3\u30b1\u30fc\u30b8\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u307e\u3059\u3002\n\n```console\n$ sudo apt-get install cmake g++ xorg-dev\n```\n\n\u3064\u3065\u3051\u3066VM\u306e\u30bd\u30fc\u30b9\u30b3\u30fc\u30c9\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3059\u308b\u305f\u3081\u306b\u4eca\u4f7f\u3063\u3066\u3044\u308bVM\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u3092\u8abf\u3079\u307e\u3059\u3002\u30d0\u30fc\u30b8\u30e7\u30f3\u3092\u8abf\u3079\u308b\u306b\u306f`ls -Al /usr/lib/squeak/`\u3092\u5b9f\u884c\u3057\u307e\u3059\u3002\u79c1\u306e\u74b0\u5883\u3067\u306f4.4.7-2357\u3067\u3042\u308b\u4e8b\u304c\u5206\u304b\u308a\u307e\u3059\u3002\n\n```console\n$ ls -Al /usr/lib/squeak/\ntotal 4\ndrwxr-xr-x 2 root root 4096  6\u6708  8 21:26 4.4.7-2357\n```\n\nhttps://packages.debian.org/ja/wheezy/squeak-vm \u3084 http://ftp.de.debian.org/debian/pool/main/s/squeak-vm/ \u3042\u305f\u308a\u304b\u3089\u8fd1\u3044\u30d0\u30fc\u30b8\u30e7\u30f3\u3092\u63a2\u3057\u307e\u3059\u3002\u4eca\u56de\u306f\u540c\u3058\u30d0\u30fc\u30b8\u30e7\u30f3\u304c\u3042\u308a\u307e\u3057\u305f\u306e\u3067`squeak-vm_4.4.7.2357.orig.tar.gz`\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u307e\u3059\u304c\u3001\u3082\u3057\u540c\u3058\u30d0\u30fc\u30b8\u30e7\u30f3\u304c\u306a\u3044\u5834\u5408\u306f\u8fd1\u3044\u3082\u306e\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u3066\u8a66\u3057\u3066\u307f\u308b\u3068\u3044\u3046\u4e8b\u306b\u306a\u308a\u307e\u3059\u3002\n\n\u89e3\u51cd\u3057\u307e\u3059\u3002\n\n```console\n$ tar xvfz squeak-vm_4.4.7.2357.orig.tar.gz\n```\n\n\u30bd\u30fc\u30b9\u30b3\u30fc\u30c9\u3092\u5909\u66f4\u3057\u307e\u3059\u3002\u691c\u8a3c\u30b3\u30fc\u30c9\u3068\u3044\u3046\u4e8b\u3067\u529b\u6280\u3067\u66f8\u3044\u305f\u306e\u3067\u9577\u3044\u30b3\u30fc\u30c9\u306b\u306a\u3063\u3066\u3057\u307e\u3044\u307e\u3057\u305f\u304c\u3001\u4e2d\u8eab\u306futf8\u3092utf32\u306b\u5909\u63db\u3059\u308b\u3060\u3051\u306e\u3082\u306e\u3067\u3059\u3002\u63a2\u305b\u3070\u666e\u901a\u306b\u95a2\u6570\u3068\u304b\u3042\u308b\u306e\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u2026\n\n```console\n$ cd squeak-vm-4.4.7.2357.orig\n$ vi unix/vm-display-X11/sqUnixX11.c\n```\n\n```diff:unix/vm-display-X11/sqUnixX11.c\n@@ -1699,29 +1699,64 @@ static unsigned char *lookupKeys(int (*l\n \n static int recordPendingKeys(void)\n {\n-  if (inputCount > 0)\n-    {\n-      int i= iebOut - iebIn;\n-      for (i= (i > 0 ? i : IEB_SIZE + i) / 4; i > 0; -- i)\n-\t{\n-# if defined(DEBUG_XIM)\n-\t  fprintf(stderr, \"%3d pending key %2d=0x%02x\\n\", inputCount, i, *pendingKey);\n-# endif\n-\t  recordKeyboardEvent(*pendingKey, EventKeyDown, modifierState, 0);\n-\t  recordKeyboardEvent(*pendingKey, EventKeyChar, modifierState, 0);\n-\t  recordKeystroke(*pendingKey);  /* DEPRECATED */\n-\t  ++pendingKey;\n-\t  if (--inputCount == 0) break;\n-\t}\n-      return 1;\n-    }\n-  /* inputBuf is allocated by lookupKeys */\n-  if (inputBuf != inputString)\n-    {\n+  if (inputCount <= 0) {\n+    if (inputBuf != inputString) {\n       free(inputBuf);\n       inputBuf= inputString;\n     }\n-  return 0;\n+    return 0;\n+  }\n+\n+  int utf32 = 0;\n+  while (inputCount > 0) {\n+\t//110x xxxx 10xx xxxx\n+\tif(inputCount >= 2 &&\n+\t   pendingKey[0] >= 0xc0 && pendingKey[0] <= 0xdf && \n+\t   pendingKey[1] >= 0x80 && pendingKey[1] <= 0xbf)\n+\t\t{\n+\t\tutf32 = ((pendingKey[0] & 0x1f) << 6) | \n+\t\t\t (pendingKey[1] & 0x3f);\n+\t        recordKeyboardEvent(0, EventKeyDown, modifierState, utf32);\n+\t        recordKeyboardEvent(0, EventKeyChar, modifierState, utf32);\n+\t\tpendingKey+=2;\n+\t\tinputCount-=2;\n+\t//1110 xxxx 10xx xxxx 10xx xxxx\n+\t} else if(inputCount >= 3 &&\n+\t\t  pendingKey[0] >= 0xe0 && pendingKey[0] <= 0xef && \n+\t\t  pendingKey[1] >= 0x80 && pendingKey[1] <= 0xbf && \n+\t\t  pendingKey[2] >= 0x80 && pendingKey[2] <= 0xbf)\n+\t\t{\n+\t\tutf32 = ((pendingKey[0]  & 0x0f) << 12) | \n+\t\t\t((pendingKey[1] & 0x3f) << 6) | \n+\t\t\t (pendingKey[2] & 0x3f);\n+\t        recordKeyboardEvent(0, EventKeyDown, modifierState, utf32);\n+\t        recordKeyboardEvent(0, EventKeyChar, modifierState, utf32);\n+\t\tpendingKey+=3;\n+\t\tinputCount-=3;\n+\t//1111 0xxx 10xx xxxx 10xx xxxx 10xx xxxx\n+\t} else if(inputCount >= 4 &&\n+\t\t  pendingKey[0] >= 0xf0 && pendingKey[0] <= 0xf7 && \n+\t\t  pendingKey[1] >= 0x80 && pendingKey[1] <= 0xbf && \n+\t\t  pendingKey[2] >= 0x80 && pendingKey[2] <= 0xbf && \n+\t\t  pendingKey[3] >= 0x80 && pendingKey[3] <= 0xbf)\n+\t\t{\n+\t\tutf32 =\t((pendingKey[0] & 0x07) << 18) | \n+\t\t\t((pendingKey[1] & 0x3f) << 12) |\n+\t\t\t((pendingKey[2] & 0x3f) << 6) |\n+\t\t\t (pendingKey[3] & 0x3f);\n+\t        recordKeyboardEvent(0, EventKeyDown, modifierState, utf32);\n+\t        recordKeyboardEvent(0, EventKeyChar, modifierState, utf32);\n+\t\tpendingKey+=4;\n+\t\tinputCount-=4;\n+\t} else {\n+\t        recordKeyboardEvent(*pendingKey, EventKeyDown, modifierState, 0);\n+\t        recordKeyboardEvent(*pendingKey, EventKeyChar, modifierState, 0);\n+\t        recordKeystroke(*pendingKey); /* DEPRECATED */\n+\t\tpendingKey++;\n+\t\tinputCount--;\n+\t}\n+  }\n+  return 1;\n }\n \n static int xkeysym2ucs4(KeySym keysym);\n```\n\n\u30b3\u30f3\u30d1\u30a4\u30eb\u3057\u307e\u3059\u3002PC\u304c\u3086\u3063\u304f\u308a\u76ee\u306a\u306e\u3067\u3001\u4eca\u56de\u306fvm-display-X11\u306e\u307f\u3092\u30b3\u30f3\u30d1\u30a4\u30eb\u3057\u3066\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3066\u307f\u307e\u3059\u3002\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u306f\u3061\u3087\u3063\u3068\u5f37\u5f15\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u304c\u65e2\u5b58\u306eso.vm-display-X11\u3092\u65b0\u3057\u3044so.vm-display-X11\u306b\u5dee\u3057\u66ff\u3048\u308b\u4e8b\u3067\u884c\u3044\u307e\u3059\u3002\n\n```console\n$ mkdir bld\n$ cd bld\n$ ../unix/cmake/configure\n$ make vm-display-X11\n$ sudo mv /usr/lib/squeak/4.4.7-2357/so.vm-display-X11 /usr/lib/squeak/4.4.7-2357/so.vm-display-X11.orig\n$ sudo cp vm-display-X11/so.vm-display-X11 /usr/lib/squeak/4.4.7-2357/\n```\n\n\u30aa\u30ea\u30b8\u30ca\u30eb\u306eso.vm-display-X11\u3068\u65b0\u3057\u3044fileso.vm-display-X11\u3092\u6bd4\u8f03\u3059\u308b\u3068\u304b\u306a\u308a\u5927\u304d\u304f\u306a\u3063\u3066\u3057\u307e\u3044\u307e\u3057\u305f\u304c\u3001\u3068\u308a\u3042\u3048\u305a\u306f\u6c17\u306b\u3057\u306a\u3044\u3067\u304a\u304d\u307e\u3059\u3002\n\n```console\n$ ls -Al /usr/lib/squeak/4.4.7-2357/so.vm-display-X11*\n-rwxr-xr-x 1 root root 279934  7\u6708  2 12:26 so.vm-display-X11\n-rw-r--r-- 1 root root  96860  4\u6708 25  2012 so.vm-display-X11.orig\n```\n\nScratch\u3092\u8d77\u52d5\u3057\u3066\u65e5\u672c\u8a9e\u304c\u5165\u529b\u3067\u304d\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n", "tags": ["RaspberryPi", "Scratch", "Linux", "Ubuntu12.04"]}