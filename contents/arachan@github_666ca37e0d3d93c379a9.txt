{"tags": ["iPXE", "dnsmasq", "proxydhcp", "Debian", "English"], "context": "I want to try chainloading.\ntftp is very slow and to transfer a little data.\nhttp is fast and to able to transfer more heavy data.\nIt is underline figure that chainloading.\nLAN Boot > dhcp-boot > undionly.kpxe from tftpd > boot_menu.ipxe from local httpd > global httpd boot\n\n\n\nEnvironment\nI'm not Network Administrator.\nI cannot change DHCP-Server Setting.\nSo, I use Proxy DHCP.\n\nThe proxyDHCP server providing TFTP server IP address and name of the NBP only to PXE identified booting clients. 1\n\nTo use proxyDHCP Major software is Dnsmasq.\nDnsmasq provides network infrastructure.\nDnsmasq provides network boot and proxy-dhcp,too.\nI use only network boot and proxy-dhcp.\nDnsmasq can install to use yum or apt-get.\n\nServer\n\n\nDebian Wheezy (Linux pxeserver 3.2.0-4-amd64 #1 SMP Debian 3.2.78-1 x86_64 GNU/Linux)\nECS 945GCT-M\nIntel(R) Pentium(R) Dual CPU E2160 @1.80GHz\nDnsmasq 2.62-3+deb7u3\nProxy DHCP\niPXE (undionly.kpxe)\n\n\nClilent\n\n\nDesktop PC\nECS G45T-M5\nRealtec PCIe GBE Family Controller\nIntel UNDI,PXE-2.0 (bulid 082)\nRealtek RTL8139(A/B/C)/RTL8130 PCI Fast Ethernet Controller v2.11\n\n\nNetwork\n\n\n172.20.0.0/16\nGW\n172.20.0.254\nDHCP-Server\n172.20.0.70\n\n\n\n\nSetup\n\ndnsmasq install\ndnsmasq config Setting\niPXE Source Get from git\niPXE Build to undionly.kpxe\ndeploy undionly.kpxe\nweb boot ipxe menu\nLet's try boot.\n\n\nDnsmasq\nAt First,\nI install dnsmasq.\nI often use debian and ubuntu.\nCentOS/RedHat's dnsmasq is same package name and same configuration file destination.\n\ninstall\nDebian/Ubuntu\n$ sudo apt-get install dnsmasq\n\n\nRedhat/CentOS\n$ sudo yum install dnsmasq\n\n\nSettings\nDebian/Ubuntu/CentOS/Redhat\n\ndnsmasq.conf\n$ cat /etc/dnsmasq.conf | grep -v -e ^# -e ^$\ndhcp-range=172.20.0.0,proxy\ndhcp-boot=tag:!ipxe,undionly.kpxe,172.20.0.225\ndhcp-match=set:ipxe,175 # gPXE/iPXE sends a 175 option.\ndhcp-boot=tag:!ipxe,undionly.kpxe\ndhcp-boot=http://172.20.0.225/a.ipxe,172.20.0.225,172.20.0.225\npxe-service=tag:!ipxe,x86PC,\"splash\",undionly.kpxe\nenable-tftp\ntftp-root=/var/ftpd\nlog-queries\nconf-dir=/etc/dnsmasq.d\n\n\n\niPXE\nIt is easy to download from undionly.kpxe.\nBut I want to build source over one years age.\nundionly.kpxe to build\u3000from source show parent code,\nwhen chainloading.\nI want to check parent hash code.\nI want to check fix date from parent hash code.\nSo, I get source form git repository and build it.\n\nGet Source\nI need to install git.\nI install git-core As described below\n$ sudo apt-get install git-core\n\n\nI need underline package to build iPXE.\n\ngcc\nbinutils\nmake\nperl\nsyslinux\nliblzma\nxz\n\nI install underline.\n$ sudo apt-get install gcc,binutils,make,perl\n$ sudo apt-get install syslinux,lzma-dev,liblzma5\n\nI get ipxe source to my current directory from git repository.\nI execute git as underline.\n$ cd ~\n$ git clone git://git.ipxe.org/ipxe.git\n\n\n\nBuild\nIt is ipxe direcotry in current directory.\nI enter into ipxe direcotry as underline and build undionly.kpxe.\n$ cd ~/ipxe/source\n$ make bin/undionly.kpxe\n\n\ndeploy\n$ cd ~/ipxe/source\n$ mv bin/undionly.kpxe /var/ftpd\n\n\n\nhttpd\nI prepare apache2.\nYou may prepare httpd that you like nginx, perl's or python's simple one liner web server...etc.\n\nInstall\n$ sudo apt-get install apache2\n\n\n\nDocumentRoot\nDebian and Ubuntu's apache2 is virtual host default on.\nDefault DocumentRoot is /var/www.\nCheck virtual hosts\n$ cat /etc/apache2/apache2.conf | grep sites-enabled\n#       `-- sites-enabled\n# * Configuration files in the mods-enabled/ and sites-enabled/ directories\nInclude sites-enabled/\n\n\nCheck DocumentRoot\n$ cat /etc/apache2/sites-enabled/000-default | grep DocumentRoot\n        DocumentRoot /var/www\n\n\nBoot Menu\nI move web deploy folder, /var/www/.\nI make boot.ipxe to use Editor.\nPlease,show underline.\n$ sudo cd /var/www\n$ sudo vi boot.ipxe\n#!ipxe\nmenu install menu\nitem ubuntu Ubuntu installation\nitem centos7 Centos7 installation\nitem --gap\nitem back install menu\nchoose --timeout 20000 --default back target && goto ${target} || goto menu\n\n:ubuntu\nset ubuntu http://archive.ubuntu.com/ubuntu/dists/trusty/main/installer-amd64/current/images/netboot/ubuntu-installer/amd64\ninitrd ${ubuntu}/initrd.gz\nkernel ${ubuntu}/linux tasks=standard vga=788 -- quiet\nboot\n\n:centos7\nset centos7 http://mirror.centos.org/centos/7/os/x86_64\ninitrd ${centos7}/image/pxeboot/initrd.img\nkernel ${centos7}/image/pxeboot/vmlinuz vga=788 repo=${centos7}\nboot\n\n:back\nexit\n\n\nand Save boot.ipxe.\n\nPXE Boot\nPrepared OK!\nI switch on Client PC.\nFirst, BIOS show up.\nshow underline.\nI want to show BBS(BIOS Boot Screen).\nSo,soon I press F11 Key when PC boot.\nAmerican\nMegatrends\n\nAMIBIOS(C) 2008 American Megatrends. Inc.\nG43T-M5 BIOS Release 09/28/2009 for MCJ\nCPU : Intel(R) Celeron(R) CPU E3300 @ 2.5GHz\n\nPress DEL to run Setup\nPress F11 for BBS POPUP\nThe MCH is operation with DDR2 800\nDRAM Timing: Tcl:6/Tras:18/Trcd:6/Twr:6/Trfc:52/Twtr:3/Trrd:3/Trtp:3\nSingle Chanel Mode\n2048MB OK (64MB Shared Memory SIze Used)\nAuto-Detecting Pri Slave...IDE Hard Disk\nAuto-Detecting 3rd Master..ATAPI CDROM\nPri Slave : SAMSUNG HD252HJ 1AC01118\n            Ultra DMA Mode-5, S.M.A.R.T. Capable and Status OK\n3rd Master: HL-DT-ST DVDDAM GH24NS50 XP01\n            Ultra DMA Mode-5\n\nclient show BIOS Boot Screen.\nI select Realtec Boot Agent and press Enter Key.\nPress select boot device:\n---------------------------\n   SAMSUNG HD252HJ\n   HL-DT-ST DVDRAM GH24NS50\n   Genetic USB SD Reader\n   Genetic USB CF Reader\n   Genetic USB SM Reader\n   Genetic USB MS Reader\n-> Realtec Boot Agent\n\n---------------------------\n^ and ^ to menu selection\nENTER to select boot device\nESC to boot using defaults\n\n\nClient change display.\nRealtec RTL8111B/8111C Gigabit Boot Agent\nPress Shift-F10 to configure ..........\n\nStart PXE Boot Conlose.\nIntel UNDI. PXE-2.1 (build 002)\nCopyright (C) 1997-2000 Intel Corporation\n\nFor RealTek RTL8111B/8111C Gigabyte Ethernet Controller v2.14(000225)\n\nCLIENT MAC ADDR: 00 25 11 CB 41 1B GUID 00020003-0004-0005-0006-00700080009\nCLIENT IP: 172.20.10.83 MASK 255.255.0.0\nDHCP IP: 172.20.0.70 PROXY IP:172.20.0.225\nGATEWAY IP: 172.20.0.254\n\nAuto-Select:\n     splash\n\nBOOT SERVER IP : 172.20.0.225\n\nPXE-EB: !PXE at 9C3E:0070,entry point at 9C3E:0109\n             UNDI code segment 9C3E:1A7A, data segment 923D:A010 (584-632kB)\n             UNID device is PCI 02:00.0, type DIX+802.3\n             584kB free base memory after PXE unload\niPXE initialising devices...ok\n\niPXE 1.0.0+ (55e4) -- Open Source Network Boot Firmware -- http://ipxe.org\nFeatures: DNS HTTP iSCSI TFTP AoE ELF MBOOT PXE bzImage Menu PXEXT\n\nPress Ctrl+B for the iPXE command line...\n\nBoot Menu from Web Server.\nSelect Ubuntu installation or CentOS7 installation and Press Enter key.\nLinux Installer boot from internet resource.\n            Install Menu\n\nUbuntu installation\nCentOS7 installation\n\n\n\n\nReferences\n\n\nDnsmasq\n\nPackage Software for PXE and proxyDHCP\n\n\n\niPXE chainloading\n\nHow to use iPXE chainloading\n\n\n\niPXE Download\n\nHow to build iPXE from source code in Source code Section.\n\n\n\nPreboot_Execution_Environment\n\nExplain Preboot eXecution Environment(PXE)\nIntegration section expain proxyDHCP for us.\n\n\n\nHow To Install Git on Debian 8\n\nTo get ipxe source from git\n\n\n\niPXE - The Versatile Boot Loader\n\nEasy iPXE Boot Menu\n\n\n\n\n\n\n\nPreboot_Execution_Environment Integration Section\u00a0\u21a9\n\n\n\nI want to try chainloading.\n\ntftp is very slow and to transfer a little data.\n\nhttp is fast and to able to transfer more heavy data.\n\nIt is underline figure that chainloading.\n\n```\nLAN Boot > dhcp-boot > undionly.kpxe from tftpd > boot_menu.ipxe from local httpd > global httpd boot\n\n```\n\n## Environment\nI'm not Network Administrator.\n\nI cannot change DHCP-Server Setting.\n\nSo, I use Proxy DHCP.\n\n\n> The proxyDHCP server providing TFTP server IP address and name of the NBP only to PXE identified booting clients. [^1]\n\n\nTo use proxyDHCP Major software is Dnsmasq.\n\nDnsmasq provides network infrastructure.\n\nDnsmasq provides network boot and proxy-dhcp,too.\n\nI use only network boot and proxy-dhcp.\n\nDnsmasq can install to use yum or apt-get.\n\n- Server\n  - Debian Wheezy (Linux pxeserver 3.2.0-4-amd64 #1 SMP Debian 3.2.78-1 x86_64 GNU/Linux)\n  - ECS 945GCT-M\n  - Intel(R) Pentium(R) Dual CPU E2160 @1.80GHz\n  - Dnsmasq 2.62-3+deb7u3\n  - Proxy DHCP\n  - iPXE (undionly.kpxe)\n- Clilent\n  - Desktop PC\n  - ECS G45T-M5\n  - Realtec PCIe GBE Family Controller\n  - Intel UNDI,PXE-2.0 (bulid 082)\n  - Realtek RTL8139(A/B/C)/RTL8130 PCI Fast Ethernet Controller v2.11\n- Network\n  - 172.20.0.0/16\n  - GW\n    - 172.20.0.254\n  - DHCP-Server\n    - 172.20.0.70\n\n\n## Setup\n\n1. dnsmasq install\n2. dnsmasq config Setting\n3. iPXE Source Get from git\n4. iPXE Build to undionly.kpxe\n5. deploy undionly.kpxe\n6. web boot ipxe menu\n7. Let's try boot.\n\n### Dnsmasq\n\nAt First,\nI install dnsmasq.\nI often use debian and ubuntu.\nCentOS/RedHat's dnsmasq is same package name and same configuration file destination.\n\n#### install\n\nDebian/Ubuntu\n\n```bash\n$ sudo apt-get install dnsmasq\n\n```\n\nRedhat/CentOS\n\n```bash\n$ sudo yum install dnsmasq\n```\n\n#### Settings\n\nDebian/Ubuntu/CentOS/Redhat\n\n```bash:dnsmasq.conf\n$ cat /etc/dnsmasq.conf | grep -v -e ^# -e ^$\ndhcp-range=172.20.0.0,proxy\ndhcp-boot=tag:!ipxe,undionly.kpxe,172.20.0.225\ndhcp-match=set:ipxe,175 # gPXE/iPXE sends a 175 option.\ndhcp-boot=tag:!ipxe,undionly.kpxe\ndhcp-boot=http://172.20.0.225/a.ipxe,172.20.0.225,172.20.0.225\npxe-service=tag:!ipxe,x86PC,\"splash\",undionly.kpxe\nenable-tftp\ntftp-root=/var/ftpd\nlog-queries\nconf-dir=/etc/dnsmasq.d\n```\n\n### iPXE\n\nIt is easy to download from [undionly.kpxe](http://boot.ipxe.org/undionly.kpxe).\n\nBut I want to build source over one years age.\n\nundionly.kpxe to build\u3000from source show parent code,\nwhen chainloading.\n\nI want to check parent hash code.\n\nI want to check fix date from parent hash code.\n\nSo, I get source form [git repository](http://git.ipxe.org/ipxe.git) and build it.\n\n#### Get Source\n\nI need to install git.\nI install git-core As described below\n\n```bash\n$ sudo apt-get install git-core\n\n```\n\nI need underline package to build iPXE.\n\n- gcc\n- binutils\n- make\n- perl\n- syslinux\n- liblzma\n- xz\n\nI install underline.\n\n```bash\n$ sudo apt-get install gcc,binutils,make,perl\n$ sudo apt-get install syslinux,lzma-dev,liblzma5\n```\n\nI get ipxe source to my current directory from git repository.\n\nI execute git as underline.\n\n```bash\n$ cd ~\n$ git clone git://git.ipxe.org/ipxe.git\n\n```\n\n#### Build\n\nIt is ipxe direcotry in current directory.\n\nI enter into ipxe direcotry as underline and build undionly.kpxe.\n\n```bash\n$ cd ~/ipxe/source\n$ make bin/undionly.kpxe\n```\n\n## deploy\n\n```bash\n$ cd ~/ipxe/source\n$ mv bin/undionly.kpxe /var/ftpd\n\n```\n\n## httpd\nI prepare apache2.\n\nYou may prepare httpd that you like nginx, perl's or python's simple one liner web server...etc.\n\n### Install\n\n```bash\n$ sudo apt-get install apache2\n\n```\n\n### DocumentRoot\n\nDebian and Ubuntu's apache2 is virtual host default on.\nDefault DocumentRoot is /var/www.\n\nCheck virtual hosts\n\n```bash\n$ cat /etc/apache2/apache2.conf | grep sites-enabled\n#       `-- sites-enabled\n# * Configuration files in the mods-enabled/ and sites-enabled/ directories\nInclude sites-enabled/\n\n```\n\nCheck DocumentRoot\n\n```bash\n$ cat /etc/apache2/sites-enabled/000-default | grep DocumentRoot\n        DocumentRoot /var/www\n```\n\n### Boot Menu\n\nI move web deploy folder, /var/www/.\n\nI make boot.ipxe to use Editor.\n\nPlease,show underline.\n\n```bash\n$ sudo cd /var/www\n$ sudo vi boot.ipxe\n#!ipxe\nmenu install menu\nitem ubuntu Ubuntu installation\nitem centos7 Centos7 installation\nitem --gap\nitem back install menu\nchoose --timeout 20000 --default back target && goto ${target} || goto menu\n\n:ubuntu\nset ubuntu http://archive.ubuntu.com/ubuntu/dists/trusty/main/installer-amd64/current/images/netboot/ubuntu-installer/amd64\ninitrd ${ubuntu}/initrd.gz\nkernel ${ubuntu}/linux tasks=standard vga=788 -- quiet\nboot\n\n:centos7\nset centos7 http://mirror.centos.org/centos/7/os/x86_64\ninitrd ${centos7}/image/pxeboot/initrd.img\nkernel ${centos7}/image/pxeboot/vmlinuz vga=788 repo=${centos7}\nboot\n\n:back\nexit\n\n```\nand Save boot.ipxe.\n\n## PXE Boot\n\nPrepared OK!\n\nI switch on Client PC.\n\nFirst, BIOS show up.\n\nshow underline.\n\nI want to show BBS(BIOS Boot Screen).\n\nSo,soon I press F11 Key when PC boot.\n\n```\nAmerican\nMegatrends\n\nAMIBIOS(C) 2008 American Megatrends. Inc.\nG43T-M5 BIOS Release 09/28/2009 for MCJ\nCPU : Intel(R) Celeron(R) CPU E3300 @ 2.5GHz\n\nPress DEL to run Setup\nPress F11 for BBS POPUP\nThe MCH is operation with DDR2 800\nDRAM Timing: Tcl:6/Tras:18/Trcd:6/Twr:6/Trfc:52/Twtr:3/Trrd:3/Trtp:3\nSingle Chanel Mode\n2048MB OK (64MB Shared Memory SIze Used)\nAuto-Detecting Pri Slave...IDE Hard Disk\nAuto-Detecting 3rd Master..ATAPI CDROM\nPri Slave : SAMSUNG HD252HJ 1AC01118\n            Ultra DMA Mode-5, S.M.A.R.T. Capable and Status OK\n3rd Master: HL-DT-ST DVDDAM GH24NS50 XP01\n            Ultra DMA Mode-5\n```\nclient show BIOS Boot Screen.\n\nI select Realtec Boot Agent and press Enter Key.\n\n```\nPress select boot device:\n---------------------------\n   SAMSUNG HD252HJ\n   HL-DT-ST DVDRAM GH24NS50\n   Genetic USB SD Reader\n   Genetic USB CF Reader\n   Genetic USB SM Reader\n   Genetic USB MS Reader\n-> Realtec Boot Agent\n\n---------------------------\n^ and ^ to menu selection\nENTER to select boot device\nESC to boot using defaults\n\n```\n\nClient change display.\n\n```\nRealtec RTL8111B/8111C Gigabit Boot Agent\nPress Shift-F10 to configure ..........\n```\n\nStart PXE Boot Conlose.\n\n```\nIntel UNDI. PXE-2.1 (build 002)\nCopyright (C) 1997-2000 Intel Corporation\n\nFor RealTek RTL8111B/8111C Gigabyte Ethernet Controller v2.14(000225)\n\nCLIENT MAC ADDR: 00 25 11 CB 41 1B GUID 00020003-0004-0005-0006-00700080009\nCLIENT IP: 172.20.10.83 MASK 255.255.0.0\nDHCP IP: 172.20.0.70 PROXY IP:172.20.0.225\nGATEWAY IP: 172.20.0.254\n\nAuto-Select:\n     splash\n\nBOOT SERVER IP : 172.20.0.225\n\nPXE-EB: !PXE at 9C3E:0070,entry point at 9C3E:0109\n             UNDI code segment 9C3E:1A7A, data segment 923D:A010 (584-632kB)\n             UNID device is PCI 02:00.0, type DIX+802.3\n             584kB free base memory after PXE unload\niPXE initialising devices...ok\n\niPXE 1.0.0+ (55e4) -- Open Source Network Boot Firmware -- http://ipxe.org\nFeatures: DNS HTTP iSCSI TFTP AoE ELF MBOOT PXE bzImage Menu PXEXT\n\nPress Ctrl+B for the iPXE command line...\n```\n\nBoot Menu from Web Server.\n\nSelect Ubuntu installation or CentOS7 installation and Press Enter key.\n\nLinux Installer boot from internet resource.\n\n```\n            Install Menu\n\nUbuntu installation\nCentOS7 installation\n\n\n```\n\n\n\n## References\n\n- [Dnsmasq](http://www.thekelleys.org.uk/dnsmasq/doc.html)\n  - Package Software for PXE and proxyDHCP\n- [iPXE chainloading](http://ipxe.org/howto/chainloading)\n  - How to use iPXE chainloading\n- [iPXE Download](http://ipxe.org/download)\n  - How to build iPXE from source code in Source code Section.\n- [Preboot_Execution_Environment](https://en.wikipedia.org/wiki/Preboot_Execution_Environment)\n  - Explain Preboot eXecution Environment(PXE)\n  - Integration section expain proxyDHCP for us.\n- [How To Install Git on Debian 8](https://www.digitalocean.com/community/tutorials/how-to-install-git-on-debian-8)\n  - To get ipxe source from git\n- [iPXE - The Versatile Boot Loader](http://blog.schlomo.schapiro.org/2014/07/ipxe-versatile-boot-loader.html)\n  - Easy iPXE Boot Menu\n\n\n\n[^1]: [Preboot_Execution_Environment](https://en.wikipedia.org/wiki/Preboot_Execution_Environment) Integration Section\n"}