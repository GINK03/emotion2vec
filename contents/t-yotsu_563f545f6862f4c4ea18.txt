{"context": "Docker,GKE\u3092\u5229\u7528\u3057\u3066GCP\u306e\u30b3\u30b9\u30c8\u3092BigQuery\u306b\u683c\u7d0d\u3057\u3066\u3044\u308b\u306e\u3067\u3001\u305d\u306e\u65b9\u6cd5\u306b\u3064\u3044\u3066\u8a18\u8f09\u3059\u308b\u3002\n\u5b9f\u65bd\u624b\u9806\u306e\u6d41\u308c\u306f\u4ee5\u4e0b\u306e\u3068\u304a\u308a\u3002\u306a\u304a1\u53ca\u30732\u306b\u95a2\u3057\u3066\u306f\u4ee5\u4e0b\u306e\u30da\u30fc\u30b8\u3092\u53c2\u7167\u3057\u3066\u5b9f\u65bd\u3002\nhttp://qiita.com/noralife/items/dbeea7084b927319d0f6\n\n1. \u65e5\u6bce\u306eBilling\u60c5\u5831\u3092GCS\u306bExport\nBilling\u306e\u30da\u30fc\u30b8\u304b\u3089\u300c\u8ab2\u91d1\u30c7\u30fc\u30bf\u306e\u30a8\u30af\u30b9\u30dd\u30fc\u30c8\u300d\u3092\u9078\u629e\u3057\u3001\u3069\u306e\u30d0\u30b1\u30c3\u30c8\u306bBilling\u60c5\u5831\u3092Export\u3059\u308b\u304b\u8a2d\u5b9a\u3059\u308b\u3002\n\n2. GCS\u306bExport\u3055\u308c\u305fBilling\u60c5\u5831\u3092\u53d6\u5f97\u3057\u3001BigQuery\u306bLoad\u3059\u308b\u30b9\u30af\u30ea\u30d7\u30c8\u306e\u4f5c\u6210\n\u4ee5\u4e0b\u306e3\u3064\u306e\u30d5\u30a1\u30a4\u30eb\u3092\u7528\u610f\n- schema.json\n- formatter.py\n- bq-load.sh\nSchema\u30d5\u30a1\u30a4\u30eb\u3068formatter.py\u306f\u4e0b\u8a18GitHub\u304b\u3089\u53d6\u5f97\u3002Schema\u306f\u73fe\u6642\u70b9\uff0820160815)\u306e\u3082\u306e\u3068\u9055\u3063\u3066\u3044\u305f\u305f\u3081\u4e00\u90e8\u4fee\u6b63\u3002\nhttps://github.com/noralife/gcp-export-billing-bq\n\n3. Docker Container\u5316\nGitHub\u306e\u30a2\u30ab\u30a6\u30f3\u30c8\u3001Token\u306fARG\u3067docker build\u6642\u306b\u6e21\u3057\u3001gcloud\u306e\u8a8d\u8a3c\u306f\u30b5\u30fc\u30d3\u30b9\u30a2\u30ab\u30a6\u30f3\u30c8\u306e\u9375\u3092\u4f7f\u7528\u3057\u3066\u8a8d\u8a3c\u3092\u3068\u304a\u3059\u3002\u9375\u306fbuild\u6642\u306b\u30db\u30b9\u30c8\u304b\u3089\u30b3\u30d4\u30fc\u3059\u308b\u3053\u3068\u306b\u3057\u305f\u3002\n\u203b\u3053\u3053\u3067\u306fCloud PubSub\u304b\u3089\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u53d6\u5f97\u3059\u308b\u3068GCS\u304b\u3089\u30b3\u30b9\u30c8\u306e\u30d5\u30a1\u30a4\u30eb\u3092\u53d6\u5f97\u3057\u3001BigQuery\u306b\u30ed\u30fc\u30c9\u3059\u308b\u51e6\u7406\u3092\u30b9\u30af\u30ea\u30d7\u30c8\u5316\u3057\u305f\u3082\u306e\u3092\u30b3\u30f3\u30c6\u30ca\u3067\u5b9f\u884c\u3059\u308b\u3088\u3046\u306b\u3059\u308b\u3002\n\nDockerfile\u306e\u4f5c\u6210\nFROM ubuntu:14.04\nARG GITHUB_ACCOUNT\nARG GITHUB_CREDENTIAL\nARG SERVICE_ACCOUNT\n\nRUN apt-get update && apt-get install -y \\\n    curl \\\n    git \\\n    python \\\n    python-pip \\\n    unzip \\\n    wget \\\n && apt-get clean \\\n && rm -rf /var/lib/apt/lists/*\n\n# Deploy application\nRUN git clone -b develop https://$GITHUB_ACCOUNT:$GITHUB_CREDENTIAL@github.com/XXX/YYY.git\n\nRUN pip install -r XXX/gcp-cost/requirements.txt\n\n# Install the Google Cloud SDK.\nENV HOME /\nENV CLOUDSDK_PYTHON_SITEPACKAGES 1\nRUN wget https://dl.google.com/dl/cloudsdk/channels/rapid/google-cloud-sdk.zip && unzip google-cloud-sdk.zip && rm google-cloud-sdk.zip\nRUN google-cloud-sdk/install.sh --usage-reporting=true --path-update=true --bash-completion=true --rc-path=/.bashrc --additional-components alpha beta \nENV PATH /google-cloud-sdk/bin:$PATH\nRUN google-cloud-sdk/bin/gcloud config set --installation component_manager/disable_update_check true\n\nCOPY ./cert/sa-key.json /root/\nRUN gcloud auth activate-service-account $SERVICE_ACCOUNT --key-file /root/sa-key.json --project {Project Name}\n\nENV PATH /gcp-cost/:$PATH\nWORKDIR /gcp-cost\nCMD [\"/bin/bash\",\"chk_pubsub_msg.sh\"]\n\n\n\u30b3\u30f3\u30c6\u30ca\u306e\u30d3\u30eb\u30c9\n\u4ee5\u4e0b\u306e\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3002\nsudo docker build --no-cache=true --build-arg GITHUB_ACCOUNT={GitHub\u30a2\u30ab\u30a6\u30f3\u30c8} --build-arg GITHUB_CREDENTIAL=\uff5b\u30c8\u30fc\u30af\u30f3\uff5d --build-arg SERVICE_ACCOUNT=\uff5b\u30b5\u30fc\u30d3\u30b9\u30a2\u30ab\u30a6\u30f3\u30c8\u540d\uff5d -t gcr.io/\uff5b\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\uff5d/gcp-cost:0.1 gcp-cost\n\n\n4. GKE(k8s)\u3078\u306e\u30c7\u30d7\u30ed\u30a4\n\n\u30b3\u30f3\u30c6\u30ca\u30af\u30e9\u30b9\u30bf\u306e\u4f5c\u6210\nGUI\u3067\u4f5c\u6210\u3002\n\u4ee5\u4e0b\u306e\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3057\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u3059\u308b\u3002\n$ sudo gcloud components update kubectl\n$ gcloud config set compute/zone ZONE\n$ gcloud config set container/cluster CLUSTER_NAME\n$ gcloud container clusters get-credentials \uff5b\u30af\u30e9\u30b9\u30bf\u540d\uff5d\n\n\nContainer Registry\u3078\u306e\u767b\u9332\n\u4ee5\u4e0b\u306e\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3057Container Registry\u3078\u30b3\u30f3\u30c6\u30ca\u30a4\u30e1\u30fc\u30b8\u3092\u30d7\u30c3\u30b7\u30e5\u3059\u308b\u3002\nsudo gcloud docker push gcr.io/{\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u540d}/gcp-cost:0.1\n\n\ndeployment.yaml\u306e\u4f5c\u6210\nPod\u3092\u30c7\u30d7\u30ed\u30a4\u3059\u308b\u305f\u3081\u306e\u5b9a\u7fa9\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3059\u308b\u3002\n\ndeployment.yaml\napiVersion: extensions/v1beta1\nkind: Deployment\nmetadata:\n  name: gcp-cost\nspec:\n  replicas: 1\n  template:\n    metadata:\n      labels:\n        name: gcp-cost-pods\n    spec:\n      containers:\n      - name: gcp-cost-container\n        image: gcr.io/{\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u540d}/gcp-cost:0.1\n\n\n\nPod\u306e\u9069\u7528\n\u4ee5\u4e0b\u306e\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3057\u3001\u30af\u30e9\u30b9\u30bf\u3078Pod\u3092\u30af\u30e9\u30b9\u30bf\u3078\u9069\u7528\u3059\u308b\u3002\n$ export PATH=/usr/lib/google-cloud-sdk/bin/:$PATH\n$ kubectl apply -f gcp-cost/deployment.yaml \ndeployment \"gcp-cost\" created\n\n$ kubectl get deployments\nNAME       DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE\ngcp-cost   1         1         1            0           1m\n\n$ kubectl get pods\nNAME                                READY     STATUS    RESTARTS   AGE\ngcp-cost-XXXXXXXXXXXXXXXX           1/1       Running   0          1m\n\n\u3046\u307e\u304fRunning\u306b\u306a\u3089\u306a\u3044\u3068\u304d\u306f\u3001\"kube describe pod\"\u3084\"kubectl logs\"\u306a\u3069\u3067\u30c7\u30d0\u30c3\u30b0\u3092\u3059\u308b\u3002\nDocker,GKE\u3092\u5229\u7528\u3057\u3066GCP\u306e\u30b3\u30b9\u30c8\u3092BigQuery\u306b\u683c\u7d0d\u3057\u3066\u3044\u308b\u306e\u3067\u3001\u305d\u306e\u65b9\u6cd5\u306b\u3064\u3044\u3066\u8a18\u8f09\u3059\u308b\u3002\n\n\u5b9f\u65bd\u624b\u9806\u306e\u6d41\u308c\u306f\u4ee5\u4e0b\u306e\u3068\u304a\u308a\u3002\u306a\u304a1\u53ca\u30732\u306b\u95a2\u3057\u3066\u306f\u4ee5\u4e0b\u306e\u30da\u30fc\u30b8\u3092\u53c2\u7167\u3057\u3066\u5b9f\u65bd\u3002\nhttp://qiita.com/noralife/items/dbeea7084b927319d0f6\n\n# 1. \u65e5\u6bce\u306eBilling\u60c5\u5831\u3092GCS\u306bExport\nBilling\u306e\u30da\u30fc\u30b8\u304b\u3089\u300c\u8ab2\u91d1\u30c7\u30fc\u30bf\u306e\u30a8\u30af\u30b9\u30dd\u30fc\u30c8\u300d\u3092\u9078\u629e\u3057\u3001\u3069\u306e\u30d0\u30b1\u30c3\u30c8\u306bBilling\u60c5\u5831\u3092Export\u3059\u308b\u304b\u8a2d\u5b9a\u3059\u308b\u3002\n\n# 2. GCS\u306bExport\u3055\u308c\u305fBilling\u60c5\u5831\u3092\u53d6\u5f97\u3057\u3001BigQuery\u306bLoad\u3059\u308b\u30b9\u30af\u30ea\u30d7\u30c8\u306e\u4f5c\u6210\n\u4ee5\u4e0b\u306e3\u3064\u306e\u30d5\u30a1\u30a4\u30eb\u3092\u7528\u610f\n- schema.json\n- formatter.py\n- bq-load.sh\n\nSchema\u30d5\u30a1\u30a4\u30eb\u3068formatter.py\u306f\u4e0b\u8a18GitHub\u304b\u3089\u53d6\u5f97\u3002Schema\u306f\u73fe\u6642\u70b9\uff0820160815)\u306e\u3082\u306e\u3068\u9055\u3063\u3066\u3044\u305f\u305f\u3081\u4e00\u90e8\u4fee\u6b63\u3002\nhttps://github.com/noralife/gcp-export-billing-bq\n\n# 3. Docker Container\u5316\nGitHub\u306e\u30a2\u30ab\u30a6\u30f3\u30c8\u3001Token\u306fARG\u3067docker build\u6642\u306b\u6e21\u3057\u3001gcloud\u306e\u8a8d\u8a3c\u306f\u30b5\u30fc\u30d3\u30b9\u30a2\u30ab\u30a6\u30f3\u30c8\u306e\u9375\u3092\u4f7f\u7528\u3057\u3066\u8a8d\u8a3c\u3092\u3068\u304a\u3059\u3002\u9375\u306fbuild\u6642\u306b\u30db\u30b9\u30c8\u304b\u3089\u30b3\u30d4\u30fc\u3059\u308b\u3053\u3068\u306b\u3057\u305f\u3002\n\u203b\u3053\u3053\u3067\u306fCloud PubSub\u304b\u3089\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u53d6\u5f97\u3059\u308b\u3068GCS\u304b\u3089\u30b3\u30b9\u30c8\u306e\u30d5\u30a1\u30a4\u30eb\u3092\u53d6\u5f97\u3057\u3001BigQuery\u306b\u30ed\u30fc\u30c9\u3059\u308b\u51e6\u7406\u3092\u30b9\u30af\u30ea\u30d7\u30c8\u5316\u3057\u305f\u3082\u306e\u3092\u30b3\u30f3\u30c6\u30ca\u3067\u5b9f\u884c\u3059\u308b\u3088\u3046\u306b\u3059\u308b\u3002\n\n#### Dockerfile\u306e\u4f5c\u6210\n\n```Dockerfile\nFROM ubuntu:14.04\nARG GITHUB_ACCOUNT\nARG GITHUB_CREDENTIAL\nARG SERVICE_ACCOUNT\n\nRUN apt-get update && apt-get install -y \\\n    curl \\\n    git \\\n    python \\\n    python-pip \\\n    unzip \\\n    wget \\\n && apt-get clean \\\n && rm -rf /var/lib/apt/lists/*\n\n# Deploy application\nRUN git clone -b develop https://$GITHUB_ACCOUNT:$GITHUB_CREDENTIAL@github.com/XXX/YYY.git\n\nRUN pip install -r XXX/gcp-cost/requirements.txt\n\n# Install the Google Cloud SDK.\nENV HOME /\nENV CLOUDSDK_PYTHON_SITEPACKAGES 1\nRUN wget https://dl.google.com/dl/cloudsdk/channels/rapid/google-cloud-sdk.zip && unzip google-cloud-sdk.zip && rm google-cloud-sdk.zip\nRUN google-cloud-sdk/install.sh --usage-reporting=true --path-update=true --bash-completion=true --rc-path=/.bashrc --additional-components alpha beta \nENV PATH /google-cloud-sdk/bin:$PATH\nRUN google-cloud-sdk/bin/gcloud config set --installation component_manager/disable_update_check true\n\nCOPY ./cert/sa-key.json /root/\nRUN gcloud auth activate-service-account $SERVICE_ACCOUNT --key-file /root/sa-key.json --project {Project Name}\n\nENV PATH /gcp-cost/:$PATH\nWORKDIR /gcp-cost\nCMD [\"/bin/bash\",\"chk_pubsub_msg.sh\"]\n```\n\n#### \u30b3\u30f3\u30c6\u30ca\u306e\u30d3\u30eb\u30c9\n\u4ee5\u4e0b\u306e\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3002\n\n```\nsudo docker build --no-cache=true --build-arg GITHUB_ACCOUNT={GitHub\u30a2\u30ab\u30a6\u30f3\u30c8} --build-arg GITHUB_CREDENTIAL=\uff5b\u30c8\u30fc\u30af\u30f3\uff5d --build-arg SERVICE_ACCOUNT=\uff5b\u30b5\u30fc\u30d3\u30b9\u30a2\u30ab\u30a6\u30f3\u30c8\u540d\uff5d -t gcr.io/\uff5b\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\uff5d/gcp-cost:0.1 gcp-cost\n```\n\n# 4. GKE(k8s)\u3078\u306e\u30c7\u30d7\u30ed\u30a4\n#### \u30b3\u30f3\u30c6\u30ca\u30af\u30e9\u30b9\u30bf\u306e\u4f5c\u6210\nGUI\u3067\u4f5c\u6210\u3002\n\u4ee5\u4e0b\u306e\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3057\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u3059\u308b\u3002\n\n```\n$ sudo gcloud components update kubectl\n$ gcloud config set compute/zone ZONE\n$ gcloud config set container/cluster CLUSTER_NAME\n$ gcloud container clusters get-credentials \uff5b\u30af\u30e9\u30b9\u30bf\u540d\uff5d\n```\n\n#### Container Registry\u3078\u306e\u767b\u9332\n\u4ee5\u4e0b\u306e\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3057Container Registry\u3078\u30b3\u30f3\u30c6\u30ca\u30a4\u30e1\u30fc\u30b8\u3092\u30d7\u30c3\u30b7\u30e5\u3059\u308b\u3002\n\n```\nsudo gcloud docker push gcr.io/{\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u540d}/gcp-cost:0.1\n```\n\n#### deployment.yaml\u306e\u4f5c\u6210\nPod\u3092\u30c7\u30d7\u30ed\u30a4\u3059\u308b\u305f\u3081\u306e\u5b9a\u7fa9\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3059\u308b\u3002\n\n```deployment.yaml\napiVersion: extensions/v1beta1\nkind: Deployment\nmetadata:\n  name: gcp-cost\nspec:\n  replicas: 1\n  template:\n    metadata:\n      labels:\n        name: gcp-cost-pods\n    spec:\n      containers:\n      - name: gcp-cost-container\n        image: gcr.io/{\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u540d}/gcp-cost:0.1\n```\n\n#### Pod\u306e\u9069\u7528\n\u4ee5\u4e0b\u306e\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3057\u3001\u30af\u30e9\u30b9\u30bf\u3078Pod\u3092\u30af\u30e9\u30b9\u30bf\u3078\u9069\u7528\u3059\u308b\u3002\n\n```\n$ export PATH=/usr/lib/google-cloud-sdk/bin/:$PATH\n$ kubectl apply -f gcp-cost/deployment.yaml \ndeployment \"gcp-cost\" created\n```\n\n```\n$ kubectl get deployments\nNAME       DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE\ngcp-cost   1         1         1            0           1m\n```\n\n```\n$ kubectl get pods\nNAME                                READY     STATUS    RESTARTS   AGE\ngcp-cost-XXXXXXXXXXXXXXXX           1/1       Running   0          1m\n```\n\n\u3046\u307e\u304fRunning\u306b\u306a\u3089\u306a\u3044\u3068\u304d\u306f\u3001\"kube describe pod\"\u3084\"kubectl logs\"\u306a\u3069\u3067\u30c7\u30d0\u30c3\u30b0\u3092\u3059\u308b\u3002\n\n\n\n\n", "tags": ["docker", "GoogleContainerEngine", "gcp", "bigquery"]}