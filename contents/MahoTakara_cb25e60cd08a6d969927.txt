{"context": " More than 1 year has passed since last update.\n\nSoftLayer\u30af\u30c3\u30ad\u30f3\u30b0LABO\n\n\n\u3053\u306e\u30ec\u30b7\u30d4\u3067\u51fa\u6765\u308b\u3053\u3068\n\u4f7f\u3044\u6163\u308c\u305fLinux\u306e\u30d0\u30fc\u30b8\u30e7\u30f3(CentOS6/7,Ubuntu14)\u306b\u6700\u65b0\u7248\u306eMySQL5.6.27\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u30ec\u30b7\u30d4\u3067\u3059\u3002 \u3053\u306e\u30ec\u30b7\u30d4\u306e\u4e2d\u3067\u306f\u3001\u30bf\u30fc\u30b2\u30c3\u30c8\u306e\u30b5\u30fc\u30d0\u30fc\u304b\u3089\u30aa\u30e9\u30af\u30eb\u306e\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u30b5\u30a4\u30c8\u306b\u30a2\u30af\u30bb\u30b9\u3057\u3066\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u7528tar\u30d5\u30a1\u30a4\u30eb\u3092\u5165\u624b\u3057\u307e\u3059\u3002\n\n\u30ec\u30b7\u30d4\u306e\u8981\u7d04\n\u3053\u306e mysql01 \u30ec\u30b7\u30d4\u306f\u3001\u7b87\u6761\u66f8\u304d\u306e\u51e6\u7406\u3092\u5b9f\u884c\u3057\u307e\u3059\u3002\n\n\u524d\u63d0\u30d1\u30c3\u30b1\u30fc\u30b8\u306e\u5c0e\u5165\nMySQL tar\u30d5\u30a1\u30a4\u30eb\u306e\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3068\u5c55\u958b\nMySQL\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\nMySQL\u306e\u81ea\u52d5\u8d77\u52d5\u8a2d\u5b9a\n\u30b3\u30f3\u30c6\u30ca\u9818\u57df\u3092/data1\u306b\u4f5c\u6210\nAppArmor(\u30a2\u30d7\u30ea\u30a2\u30fc\u30de\u30fc\u306e\u8a2d\u5b9a Ubuntu\u306e\u307f)\n\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u306e\u7f6e\u304d\u5834\u6240\u4f5c\u6210 (CentOS\u306e\u307f)\nMySQL\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u306e\u914d\u7f6e\n/usr/bin/mysql_install_db \u30b3\u30f3\u30c6\u30ca\u9818\u57df\u4f5c\u6210\n\u30bb\u30ad\u30e5\u30a2\u30fb\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u306e\u30b9\u30af\u30ea\u30d7\u30c8\u5b9f\u884c\n\u30a2\u30d7\u30ea\u7528\u306e\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306e\u4f5c\u6210\n\u30a2\u30d7\u30ea\u7528\u306e\u30e6\u30fc\u30b6\u30fc\u4f5c\u6210\n\n\n\u30ec\u30b7\u30d4\u306e\u8aac\u660e\n\u3053\u306e\u30ec\u30b7\u30d4\u3092\u5229\u7528\u3059\u308b\u306b\u3042\u305f\u308a\u5fc5\u8981\u306a\u4e8b\u3068\u3057\u3066\u3001minimal \u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u306e CentOS,Ubuntu \u3092\u5bfe\u8c61\u306b\u3057\u3066\u304a\u308a\u3001MySQL\u304c\u5c0e\u5165\u3055\u308c\u3066\u3044\u308b\u30b1\u30fc\u30b9\u3092\u5bfe\u8c61\u306b\u3057\u3066\u3044\u307e\u305b\u3093\u3002\n\n\u30ec\u30b7\u30d4\u306e\u30d5\u30a1\u30a4\u30eb\n\u30af\u30c3\u30af\u30d6\u30c3\u30af\u306e\u4e2d\u3067\u8a2d\u5b9a\u3059\u308b\u306e\u306f\u3001\u4e0b\u8a18\u306e\uff13\u7a2e\u985e\u3067\u3059\u3002\nchef@ChefWs:~/chef-repo/site-cookbooks$ tree mysql01/\nmysql01/\n\u251c\u2500\u2500 CHANGELOG.md\n\u251c\u2500\u2500 README.md\n\u251c\u2500\u2500 attributes\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 default.rb    (1) \u30a2\u30c8\u30ea\u30d3\u30e5\u30fc\u30c8\u8a2d\u5b9a \n\u251c\u2500\u2500 definitions\n\u251c\u2500\u2500 files\n\u251c\u2500\u2500 libraries\n\u251c\u2500\u2500 metadata.rb\n\u251c\u2500\u2500 providers\n\u251c\u2500\u2500 recipes\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 default.rb   (2) \u30ec\u30b7\u30d4\u672c\u4f53\n\u251c\u2500\u2500 resources\n\u2514\u2500\u2500 templates\n    \u2514\u2500\u2500 default  (3) MySQL\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\n        \u251c\u2500\u2500 character-set.cnf.erb\n        \u251c\u2500\u2500 create_db.sql.erb\n        \u251c\u2500\u2500 create_user.sql.erb\n        \u251c\u2500\u2500 engine.cnf.erb\n        \u251c\u2500\u2500 my.cnf.erb\n        \u251c\u2500\u2500 mysqld_safe_syslog.cnf.erb\n        \u251c\u2500\u2500 secure_install.sql.erb\n        \u2514\u2500\u2500 usr.sbin.mysqld.erb\n\n\n(1) \u30a2\u30c8\u30ea\u30d3\u30e5\u30fc\u30c8\u8a2d\u5b9a\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308bMySQL\u306e\u30eb\u30fc\u30c8\u30d1\u30b9\u30ef\u30fc\u30c9\u3001\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u3001\u30a2\u30d7\u30ea\u30e6\u30fc\u30b6\u30fc\u3068\u30d1\u30b9\u30ef\u30fc\u30c9\u3092\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\u6700\u5f8c\u306e\uff15\u756a\u76ee\u306f\u3001\"service\" \u3068\u3059\u308c\u3070\u3001MySQL\u306e\u8a2d\u5b9a\u3092\u5b9f\u884c\u3057\u307e\u3059\u3002 stanby \u3068\u3059\u308b\u308c\u3070\u3001\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u307e\u3067\u306b\u3057\u3066\u3001MySQL\u306e\u30b3\u30f3\u30c6\u30ca\u9818\u57df\u306e\u4f5c\u6210\u3084\u8a2d\u5b9a\u3092\u5b9f\u65bd\u3057\u307e\u305b\u3093\u3002\u3053\u308c\u306f\u3001\u30a2\u30af\u30c6\u30a3\u30d6\u30fb\u30b9\u30bf\u30f3\u30d0\u30a4\u306e\u69cb\u6210\u3092\u7d44\u3080\u5834\u5408\u306e\u30b9\u30bf\u30f3\u30d0\u30a4\u6a5f\u3092\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u3059\u308b\u305f\u3081\u306b\u5229\u7528\u3057\u307e\u3059\u3002\ndefault[\"mysql\"][\"root_password\"] = 'passw0rd'    (1)\u30eb\u30fc\u30c8\u30d1\u30b9\u30ef\u30fc\u30c9\ndefault[\"mysql\"][\"db_name\"] = 'testdb'  (2)\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u540d\ndefault[\"mysql\"][\"user\"][\"name\"] = 'wordpress' (3)\u30a2\u30d7\u30ea\u30e6\u30fc\u30b6\u30fc\ndefault[\"mysql\"][\"user\"][\"password\"] = 'wordpress' (4)\u30a2\u30d7\u30ea\u30e6\u30fc\u30b6\u30fc\u306e\u30d1\u30b9\u30ef\u30fc\u30c9\ndefault[\"mysql\"][\"node\"] = 'service' (5) service \u307e\u305f\u306f\u3001\u305d\u308c\u4ee5\u5916\u3067\u8a2d\u5b9a\n\n\n(2) \u30ec\u30b7\u30d4\u672c\u4f53\n\u3053\u306e\u30ec\u30b7\u30d4\u306f\u3001CentOS/RedHat 6\u30687, Ubuntu \u306e\u30b1\u30fc\u30b9\u3067\u5206\u5c90\u3092\u6301\u305f\u305b\u3001\u305d\u308c\u305e\u308c\u306e\u74b0\u5883\u306b\u5408\u308f\u305b\u3066\u5bfe\u5fdc\u3059\u308b\u69d8\u306b\u3057\u3066\u3044\u307e\u3059\u3002 MySQL\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u306f\u3001\u30a2\u30c8\u30ea\u30d3\u30e5\u30fc\u30c8\u306b\u51fa\u3059\u306e\u3067\u306f\u306a\u304f\u3001\u3053\u306e\u30ec\u30b7\u30d4\u306e\u4e2d\u306b\u30d9\u30bf\u66f8\u304d\u3057\u3066\u3044\u308b\u306e\u3067\u3001\u5229\u7528\u3057\u305f\u3044\u30d0\u30fc\u30b8\u30e7\u30f3\u306b\u66f8\u304d\u66ff\u3048\u3066\u5bfe\u5fdc\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\nSoftLayer\u306e CentOS \u306e SELinux \u306f\u3067\u30c7\u30d5\u30a9\u30eb\u30c8\u3067\u7121\u52b9\u306b\u306a\u3063\u3066\u304a\u308a\u3001\u305d\u306e\u307e\u307e\u3001\u5229\u7528\u3057\u307e\u3059\u3002\u3057\u304b\u3057\u3001Ubuntu \u306e SELinux \u306b\u76f8\u5f53\u3059\u308b AppArmor\u306f\u3001\u6709\u52b9\u5316\u3055\u308c\u3066\u304a\u308a\u3001MySQL\u306e\u30b3\u30f3\u30c6\u30ca\u9818\u57df\u3092/data1\u306b\u79fb\u52d5\u3059\u308b\u3060\u3051\u3067\u306f\u3001\u52d5\u4f5c\u3057\u307e\u305b\u3093\u3002 \u3053\u306e\u70ba\u3001AppArmor \u306e aa \u30b3\u30de\u30f3\u30c9\u3092\u5229\u7528\u3057\u3066\u3001MySQL\u304c /data1 \u3092\u5229\u7528\u3067\u304d\u308b\u69d8\u306b\u8a2d\u5b9a\u5909\u66f4\u3057\u3066\u3044\u307e\u3059\u3002\nchef@ChefWs:~/chef-repo/site-cookbooks/mysql01/recipes$ cat default.rb \n# -*- coding: utf-8 -*-\n#\n# Cookbook Name:: mysql01\n# Recipe:: default\n# \n# MySQL 5.6 \u30b3\u30df\u30e5\u30cb\u30c6\u30a3\u30fb\u30a8\u30c7\u30a3\u30b7\u30e7\u30f3\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\n# \u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\uff06\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u3059\u308b\u30ec\u30b7\u30d4\n#\n\nwork_dir = '/root/mysql'\nconf_dir = '/etc/mysql'\n\n#\n# \u30d1\u30c3\u30b1\u30fc\u30b8\u5c0e\u5165 Ubuntu,CentOS/Redhat\n#\ncase node['platform']\n\nwhen 'ubuntu'\n  execute 'apt-get update' do\n    command 'apt-get update'\n  end\n\n  # \u524d\u63d0\u30d1\u30c3\u30b1\u30fc\u30b8\n  package 'apparmor-utils'\n  package 'libaio1'\n\n  # https://dev.mysql.com/downloads/mysql/ \u306e\u30b5\u30a4\u30c8\u304b\u3089MySQL\u306etar\u30d5\u30a1\u30a4\u30eb\u306eURL\u3092\u62fe\u3063\u3066\u6307\u5b9a\n  tar_url = 'http://dev.mysql.com/get/Downloads/MySQL-5.6/mysql-server_5.6.27-1ubuntu14.04_amd64.deb-bundle.tar'\n\nwhen 'centos','redhat'\n  execute 'yum update' do\n    command 'yum update -y'\n    action :run\n  end\n\n  # \u524d\u63d0\u30d1\u30c3\u30b1\u30fc\u30b8\n  package 'wget'\n  package 'libaio'\n\n  # https://dev.mysql.com/downloads/mysql/ \u306e\u30b5\u30a4\u30c8\u304b\u3089MySQL\u306etar\u30d5\u30a1\u30a4\u30eb\u306eURL\u3092\u62fe\u3063\u3066\u6307\u5b9a\n  case node['platform_version'].to_i\n    when 6\n      tar_url = 'http://dev.mysql.com/get/Downloads/MySQL-5.6/MySQL-5.6.27-1.el6.x86_64.rpm-bundle.tar'    \n    when 7\n      package 'net-tools'\n\n      tar_url = 'http://dev.mysql.com/get/Downloads/MySQL-5.6/MySQL-5.6.27-1.el7.x86_64.rpm-bundle.tar'\n  end\nend\n\n#\n# MySQL tar\u30d5\u30a1\u30a4\u30eb\u306e\u53d6\u5f97\u3068\u5c55\u958b\n#\nscript \"install_mysql\" do\n  interpreter \"bash\"\n  user        \"root\"\n  code <<-EOL\n     # rm -fr /etc/my.cnf /etc/my.cnf.d #{conf_dir}\n     mkdir #{conf_dir}\n     mkdir #{work_dir}\n     wget -P #{work_dir} #{tar_url}\n     cd #{work_dir}\n     tar xvf `ls *.tar`\n  EOL\n  action :run\nend\n\n\n#\n# MySQL Server\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n#\ncase node['platform']\nwhen 'ubuntu'\n  dpkg_package \"#{work_dir}/mysql-common_5.6.27-1ubuntu14.04_amd64.deb\"\n  dpkg_package \"#{work_dir}/mysql-community-server_5.6.27-1ubuntu14.04_amd64.deb\"\n  dpkg_package \"#{work_dir}/mysql-community-client_5.6.27-1ubuntu14.04_amd64.deb\"\nwhen 'centos','redhat'\n  case node['platform_version'].to_i\n    when 6\n      # \u4f9d\u5b58\u95a2\u4fc2\u306e\u3042\u308b\u30e2\u30b8\u30e5\u30fc\u30eb postfix\u4ee5\u4e0b\u306e\u30b3\u30de\u30f3\u30c9\u306f\u5b9f\u884c\u3067\u304d\u306a\u3044\u3002\n      #rpm_package \"mysql-libs-5.1.73-5.el6_6.x86_64\" do\n      #  action :remove\n      #end\n      execute \"delete mysql-libs-5.1.73-5.el6_6.x86_64\" do\n        command \"rpm -e --nodeps mysql-libs-5.1.73-5.el6_6.x86_64\"\n        action :run\n        ignore_failure true\n      end\n\n      rpm_package \"#{work_dir}/MySQL-shared-5.6.27-1.el6.x86_64.rpm\" \n      rpm_package \"#{work_dir}/MySQL-shared-compat-5.6.27-1.el6.x86_64.rpm\" \n      rpm_package \"#{work_dir}/MySQL-server-5.6.27-1.el6.x86_64.rpm\"\n      rpm_package \"#{work_dir}/MySQL-client-5.6.27-1.el6.x86_64.rpm\"\n\n    when 7\n      # \u4f9d\u5b58\u95a2\u4fc2\u306e\u3042\u308b\u30e2\u30b8\u30e5\u30fc\u30eb postfix\u4ee5\u4e0b\u306e\u30b3\u30de\u30f3\u30c9\u306f\u5b9f\u884c\u3067\u304d\u306a\u3044\u3002\n      #rpm_package \"mariadb-libs-5.5.44-1.el7_1.x86_64\" do\n      #  action :remove\n      #end\n      execute \"delete mariadb-libs-5.5.44-1.el7_1.x86_64\" do\n        command \"rpm -e --nodeps mariadb-libs-5.5.44-1.el7_1.x86_64\"\n        action :run\n        ignore_failure true\n      end\n\n      rpm_package \"#{work_dir}/MySQL-shared-5.6.27-1.el7.x86_64.rpm\" \n      rpm_package \"#{work_dir}/MySQL-shared-compat-5.6.27-1.el7.x86_64.rpm\"\n      rpm_package \"#{work_dir}/MySQL-server-5.6.27-1.el7.x86_64.rpm\"\n      rpm_package \"#{work_dir}/MySQL-client-5.6.27-1.el7.x86_64.rpm\"\n  end\nend\n\n\n#\n# MySQL\u306e\u81ea\u52d5\u8d77\u52d5\u3068\u505c\u6b62\u3092\u8a2d\u5b9a\n#\nservice \"mysql\" do\n  supports :start => true, :stop => true\n  action [ :enable, :stop]\nend\n\n\n#\n# \u30b3\u30f3\u30c6\u30ca\u9818\u57df\u3092\u65b0\u898f\u4f5c\u6210\n#  iSCSI\u3068\u7d44\u307f\u5408\u308f\u305b\u3066\u3001\u5916\u90e8\u5171\u7528\u30c7\u30a3\u30b9\u30af\u306e\u30de\u30a6\u30f3\u30c8\u30fb\u30dd\u30a4\u30f3\u30c8\u3068\u3057\u3066\n#  \u5229\u7528\u3067\u304d\u308b\u69d8\u306b\u3059\u308b\n#\ndirectory \"/data1\" do\n  owner 'mysql'\n  group 'mysql'\n  mode '0755'\n  action :create\n  notifies :stop, \"service[mysql]\", :immediately\nend\n\n\ncase node['platform']\n#\n# Ubuntu \u306e AppArmor \u30a2\u30d7\u30ea \u30a2\u30fc\u30de\u30fc\u306e\u8a2d\u5b9a\n#\nwhen 'ubuntu','debian'\n  execute \"aa-disable_usr.bin.mysqld\" do\n    command \"aa-disable usr.sbin.mysqld\"\n    ignore_failure true\n    action :run\n  end\n  execute \"aa-enforce_usr.bin.mysqld\" do\n    command \"aa-enforce usr.sbin.mysqld\"\n    ignore_failure true\n    action :nothing\n  end\n  template \"/etc/apparmor.d/usr.sbin.mysqld\" do\n    source \"usr.sbin.mysqld.erb\"\n    owner \"root\"\n    group \"root\"\n    mode 0644\n    notifies :run, \"execute[aa-enforce_usr.bin.mysqld]\"\n  end\n\n\n#\n# CentOS/RedHat \u306f\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u306e\u7f6e\u304d\u5834\u4f5c\u6210\n#\nwhen 'centos','redhat'\n  directory \"/etc/mysql\" do\n    owner \"root\"\n    group \"root\"\n    mode '0755'\n    action :create\n  end\n  directory \"/etc/mysql/conf.d\" do\n    owner \"root\"\n    group \"root\"\n    mode '0755'\n    action :create\n  end\n  directory \"/var/log/mysql\" do\n    owner \"mysql\"\n    group \"mysql\"\n    mode '0755'\n    action :create\n  end\n\nend # case\n\n\n#\n# MySQL\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u306e\u914d\u7f6e\n#\ntemplate \"/etc/mysql/my.cnf\" do\n  source \"my.cnf.erb\"\n  owner \"root\"\n  group \"root\"\n  mode 0644\nend\ntemplate \"/etc/mysql/conf.d/character-set.cnf\" do\n  source \"character-set.cnf.erb\"\n  owner \"root\"\n  group \"root\"\n  mode 0644\nend\ntemplate \"/etc/mysql/conf.d/engine.cnf\" do\n  source \"engine.cnf.erb\"\n  owner \"root\"\n  group \"root\"\n  mode 0644\nend\ntemplate \"/etc/mysql/conf.d/mysqld_safe_syslog.cnf\" do\n  source \"mysqld_safe_syslog.cnf.erb\"\n  owner \"root\"\n  group \"root\"\n  mode 0644\nend\n\n\n#\n# \u5148\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u304c\u6307\u3059\u30b3\u30f3\u30c6\u30ca\u9818\u57df\u306b\n# MySQL\u306e\u30b3\u30f3\u30c6\u30ca\u3001\u30ed\u30b0\u7b49\u3092\u4f5c\u6210\u3059\u308b\n#\n# \u5171\u6709\u30c7\u30a3\u30b9\u30af\u306b\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u3059\u308b\u4e8b\u3092\u60f3\u5b9a\u3057\u3066\n# \u3053\u306e\u8a2d\u5b9a\u304c\u52d5\u4f5c\u3059\u308b\u306e\u306f\u3001service \u30ce\u30fc\u30c9\u306e\u5834\u5408\u306e\u307f\u3067\n# standby \u30ce\u30fc\u30c9\u306e\u5834\u5408\u306b\u306f\u3001\u5b9f\u884c\u3057\u306a\u3044\u3002\n# \nexecute \"mysqL_install_db\" do\n  command \"/usr/bin/mysql_install_db\"\n  action :run\n  only_if {node[\"mysql\"][\"node\"] == 'service'}\n  notifies :start, \"service[mysql]\", :immediately\nend\n\n#\n# secure_install.sql \u3092\u5b9f\u884c\u3057\u3066\u30d1\u30b9\u30ef\u30fc\u30c9\u3092\u8a2d\u5b9a\n#\nroot_password = node[\"mysql\"][\"root_password\"]\ntemplate \"#{Chef::Config[:file_cache_path]}/secure_install.sql\" do\n  owner \"root\"\n  group \"root\"\n  mode 0644\n  source \"secure_install.sql.erb\"\n  variables({\n    :root_password => root_password,\n  })\n  only_if {node[\"mysql\"][\"node\"] == 'service'}\n  action :create\nend\n\n\nexecute \"secure_install\" do\n  command \"/usr/bin/mysql -u root < #{Chef::Config[:file_cache_path]}/secure_install.sql\"\n  # \u533f\u540d\u30e6\u30fc\u30b6\u30fc\u306e\u524a\u9664\u3067\u5b58\u5728\u3057\u306a\u3044\u3068\u30a8\u30e9\u30fc\u3068\u306a\u308b\u306e\u3067\u8ffd\u52a0\n  ignore_failure true\n  only_if \"/usr/bin/mysql -u root -e 'show databases;'\"\n  only_if {node[\"mysql\"][\"node\"] == 'service'}\n  action :run\nend\n\n\n#\n# \u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u3092\u4f5c\u6210\n# \ndb_name = node[\"mysql\"][\"db_name\"]\ntemplate \"#{Chef::Config[:file_cache_path]}/create_db.sql\" do\n  owner \"root\"\n  group \"root\"\n  mode 0644\n  source \"create_db.sql.erb\"\n  variables({\n    :db_name => db_name,\n  })\n  only_if {node[\"mysql\"][\"node\"] == 'service'}\n  action :create\nend\nexecute \"create_db\" do\n  command \"/usr/bin/mysql -u root -p#{root_password} < #{Chef::Config[:file_cache_path]}/create_db.sql\"\n  not_if \"/usr/bin/mysql -u root -p#{root_password} -D #{db_name}\"\n  only_if {node[\"mysql\"][\"node\"] == 'service'}\n  action :run\nend\n\n\n#\n# \u30e6\u30fc\u30b6\u30fc\u3092\u8ffd\u52a0\n#\nuser_name     = node[\"mysql\"][\"user\"][\"name\"]\nuser_password = node[\"mysql\"][\"user\"][\"password\"]\n\ntemplate \"#{Chef::Config[:file_cache_path]}/create_user.sql\" do\n  owner \"root\"\n  group \"root\"\n  mode 0644\n  source \"create_user.sql.erb\"\n  variables({\n    :db_name => db_name,\n    :username => user_name,\n    :password => user_password,\n  })\n  only_if {node[\"mysql\"][\"node\"] == 'service'}\n  action :create\nend\nexecute \"create_user\" do\n  command \"/usr/bin/mysql -u root -p#{root_password} < #{Chef::Config[:file_cache_path]}/create_user.sql\"\n  not_if \"/usr/bin/mysql -u #{user_name} -p#{user_password} -D #{db_name}\"\n  only_if {node[\"mysql\"][\"node\"] == 'service'}\n  action :run\nend\n\n\n(3) MySQL\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\nMySQL\u306e\u30d5\u30a1\u30a4\u30eb\u306f\u3001\u3053\u3053\u3067\u89e3\u8aac\u3059\u308b\u3088\u308a\u3082\u3001GitHub\u306b\u767b\u9332\u3057\u305f\u73fe\u7269\u3092\u307f\u308b\u306e\u304c\u826f\u3044\u3068\u601d\u3044\u307e\u3059\u306e\u3067\u3001\u3053\u3053\u3067\u306f\u3001\u305d\u308c\u305e\u308c\u306e\u30d5\u30a1\u30a4\u30eb\u306e\u76ee\u7684\u3092\u8a18\u8f09\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\ncharacter-set.cnf.erb        utf-8 \u8a2d\u5b9a\ncreate_db.sql.erb            utf-8 \u3067\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u4f5c\u6210\ncreate_user.sql.erb          \u30a2\u30d7\u30ea\u30e6\u30fc\u30b6\u30fc\u767b\u9332 \u4efb\u610f\u30db\u30b9\u30c8\u304b\u3089\u8a31\u53ef\nengine.cnf.erb               InnoDB\u6307\u5b9a\nmy.cnf.erb                   MySQL\u8a2d\u5b9a\u672c\u4f53 \uff08\u307b\u3068\u3093\u3069\u30c7\u30d5\u30a9\u30eb\u30c8\uff09\nmysqld_safe_syslog.cnf.erb   Syslog \u30b5\u30fc\u30d3\u30b9\u6307\u5b9a\nsecure_install.sql.erb       \u533f\u540d\u30e6\u30fc\u30b6\u30fc\u306e\u524a\u9664\u3001root\u63a5\u7d9a\u3092\u8a31\u53ef\u3059\u308b\u30db\u30b9\u30c8\u8a2d\u5b9a\nusr.sbin.mysqld.erb          AppArmor\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\n\n\n\u30ec\u30b7\u30d4\u306e\u9069\u7528\u624b\u9806\n\u8d77\u52d5\u3057\u3066\u304d\u305f\u4eee\u60f3\u30b5\u30fc\u30d0\u30fc\u3084\u7269\u7406\u30b5\u30fc\u30d0\u30fc\u306b\u5bfe\u3057\u3066\u3001\u4ee5\u4e0b\u306e\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3059\u308b\u3060\u3051\u3067\u3059\u3002 \u30b5\u30fc\u30d0\u30fc\u306eOS\u306b\u3088\u308b\u9055\u3044\u306f\u3001\u30ec\u30b7\u30d4\u306e\u4e2d\u3067\u5207\u66ff\u3048\u3066\u52d5\u4f5c\u3059\u308b\u306e\u3067\u3001\u30aa\u30d7\u30b7\u30e7\u30f3\u7b49\u3092\u5909\u66f4\u3059\u308b\u5fc5\u8981\u306f\u3042\u308a\u307e\u305b\u3093\u3002\n\u65e2\u306bCHEF Solo \u3092\u5229\u7528\u3057\u3066\u3044\u308b\u65b9\u306f\u3054\u5b58\u77e5\u3068\u601d\u3044\u307e\u3059\u304c\u3001\u30ea\u30dd\u30b8\u30c8\u30ea chef-repo \u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u30ab\u30ec\u30f3\u30c8\u306b\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\nchef@ChefWs:~/chef-repo$ knife solo bootstrap 10.132.253.30 -x root -r 'recipe[mysql01]' -i ~/key/chefkey\n\n\u65e2\u306bchef-client\u304c\u5c0e\u5165\u3055\u308c\u3066\u3044\u308b\u5834\u5408\u306f\u3001bootstrap \u306e\u90e8\u5206\u3092 cook \u306b\u5909\u3048\u3066\u5b9f\u884c\u3057\u307e\u3059\u3002\n\n\u3053\u306e\u30ec\u30b7\u30d4\u3067\u4f5c\u6210\u3057\u305fMySQL\u30b5\u30fc\u30d0\u30fc\u306b\u30ed\u30b0\u30a4\u30f3\n\u4ee5\u4e0b\u306f\u3001\u30a2\u30c8\u30ea\u30d3\u30e5\u30fc\u30c8\u306b\u8a2d\u5b9a\u3057\u3066\u3042\u308b \u30e6\u30fc\u30b6\u30fc\u540d\u3001\u30d1\u30b9\u30ef\u30fc\u30c9\u3001\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u540d\u3067\u30ed\u30b0\u30a4\u30f3\u3057\u3066\u307f\u305f\u7d50\u679c\u3067\u3059\u3002\nchef@ChefWs:~$ ssh root@10.132.253.30 -i ~/key/chefkey\nLast login: Thu Oct 15 21:05:10 2015 from 10.132.253.38\n[root@server3 ~]# mysql -u wordpress -pwordpress testdb\nWarning: Using a password on the command line interface can be insecure.\nWelcome to the MySQL monitor.  Commands end with ; or \\g.\nYour MySQL connection id is 7\nServer version: 5.6.27 MySQL Community Server (GPL)\n\nCopyright (c) 2000, 2015, Oracle and/or its affiliates. All rights reserved.\n\nOracle is a registered trademark of Oracle Corporation and/or its\naffiliates. Other names may be trademarks of their respective\nowners.\n\nType 'help;' or '\\h' for help. Type '\\c' to clear the current input statement.\n\nmysql> \\s\n--------------\nmysql  Ver 14.14 Distrib 5.6.27, for Linux (x86_64) using  EditLine wrapper\n\nConnection id:      7\nCurrent database:   testdb\nCurrent user:       wordpress@localhost\nSSL:            Not in use\nCurrent pager:      stdout\nUsing outfile:      ''\nUsing delimiter:    ;\nServer version:     5.6.27 MySQL Community Server (GPL)\nProtocol version:   10\nConnection:     Localhost via UNIX socket\nServer characterset:    utf8\nDb     characterset:    utf8\nClient characterset:    utf8\nConn.  characterset:    utf8\nUNIX socket:        /var/run/mysqld/mysqld.sock\nUptime:         2 hours 3 min 6 sec\n\nThreads: 1  Questions: 26  Slow queries: 0  Opens: 68  Flush tables: 1  Open tables: 61  Queries per second avg: 0.003\n--------------\n\nmysql> \n\n\n\u30c6\u30b9\u30c8\u6e08\u307f\u306eLinux\u30c7\u30a3\u30b9\u30c8\u30ea\u30d3\u30e5\u30fc\u30b7\u30e7\u30f3\nSoftLayer\u3067\u30b5\u30fc\u30d0\u30fc\u30aa\u30fc\u30c0\u30fc\u6642\u306b\u9078\u629e\u3067\u304d\u308bOS\u306e\u4e2d\u304b\u3089\u3001\u78ba\u8a8d\u3067\u304d\u305f\u3082\u306e\u306e\u30ea\u30b9\u30c8\u3067\u3059\u3002\n\nUbuntu 14.04 64bit minimal install\nCentOS 7.1 64bit minimal install\nCentOS 6.7 64bit minimal install\n\n\n\u30ec\u30b7\u30d4\u306e\u7f6e\u304d\u5834\u6240\n\u6700\u65b0\u7248\u306e\u30ec\u30b7\u30d4\u306fGitHub\u306b\u3042\u308a\u307e\u3059\u3002\n- GitHub takara9/chef-repo/ iscsiStorage01  https://github.com/takara9/chef-repo/tree/master/site-cookbooks/mysql01\n\nChef \u95a2\u9023\u30de\u30cb\u30e5\u30a2\u30eb\n\u3053\u306e\u30ec\u30b7\u30d4\u3092\u4f5c\u308b\u306b\u3042\u305f\u3063\u3066\u53c2\u7167\u3057\u305fCHEF\u30de\u30cb\u30e5\u30a2\u30eb\u306e\u30ea\u30f3\u30af\u3067\u3059\u3002\n- script  (https://docs.chef.io/resource_script.html )\n- execute (https://docs.chef.io/resource_execute.html )\n- package (https://docs.chef.io/resource_package.html )\n- template (https://docs.chef.io/resource_template.html)\n- file (https://docs.chef.io/resource_file.html)\n- directory (https://docs.chef.io/resource_directory.html)\n\n\u53c2\u8003\u8cc7\u6599\n\nhttps://dev.mysql.com/doc/refman/5.6/en/binary-installation.html\n\n#[SoftLayer\u30af\u30c3\u30ad\u30f3\u30b0LABO] (http://qiita.com/MahoTakara/items/464da29ccf932698b753)\n\n# \u3053\u306e\u30ec\u30b7\u30d4\u3067\u51fa\u6765\u308b\u3053\u3068\n\u4f7f\u3044\u6163\u308c\u305fLinux\u306e\u30d0\u30fc\u30b8\u30e7\u30f3(CentOS6/7,Ubuntu14)\u306b\u6700\u65b0\u7248\u306eMySQL5.6.27\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u30ec\u30b7\u30d4\u3067\u3059\u3002 \u3053\u306e\u30ec\u30b7\u30d4\u306e\u4e2d\u3067\u306f\u3001\u30bf\u30fc\u30b2\u30c3\u30c8\u306e\u30b5\u30fc\u30d0\u30fc\u304b\u3089\u30aa\u30e9\u30af\u30eb\u306e\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u30b5\u30a4\u30c8\u306b\u30a2\u30af\u30bb\u30b9\u3057\u3066\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u7528tar\u30d5\u30a1\u30a4\u30eb\u3092\u5165\u624b\u3057\u307e\u3059\u3002\n\n\n# \u30ec\u30b7\u30d4\u306e\u8981\u7d04\n\u3053\u306e mysql01 \u30ec\u30b7\u30d4\u306f\u3001\u7b87\u6761\u66f8\u304d\u306e\u51e6\u7406\u3092\u5b9f\u884c\u3057\u307e\u3059\u3002\n\n- \u524d\u63d0\u30d1\u30c3\u30b1\u30fc\u30b8\u306e\u5c0e\u5165\n- MySQL tar\u30d5\u30a1\u30a4\u30eb\u306e\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3068\u5c55\u958b\n- MySQL\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n- MySQL\u306e\u81ea\u52d5\u8d77\u52d5\u8a2d\u5b9a\n- \u30b3\u30f3\u30c6\u30ca\u9818\u57df\u3092/data1\u306b\u4f5c\u6210\n- AppArmor(\u30a2\u30d7\u30ea\u30a2\u30fc\u30de\u30fc\u306e\u8a2d\u5b9a Ubuntu\u306e\u307f)\n- \u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u306e\u7f6e\u304d\u5834\u6240\u4f5c\u6210 (CentOS\u306e\u307f)\n- MySQL\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u306e\u914d\u7f6e\n- /usr/bin/mysql_install_db \u30b3\u30f3\u30c6\u30ca\u9818\u57df\u4f5c\u6210\n- \u30bb\u30ad\u30e5\u30a2\u30fb\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u306e\u30b9\u30af\u30ea\u30d7\u30c8\u5b9f\u884c\n- \u30a2\u30d7\u30ea\u7528\u306e\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306e\u4f5c\u6210\n- \u30a2\u30d7\u30ea\u7528\u306e\u30e6\u30fc\u30b6\u30fc\u4f5c\u6210\n\n# \u30ec\u30b7\u30d4\u306e\u8aac\u660e\n\u3053\u306e\u30ec\u30b7\u30d4\u3092\u5229\u7528\u3059\u308b\u306b\u3042\u305f\u308a\u5fc5\u8981\u306a\u4e8b\u3068\u3057\u3066\u3001minimal \u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u306e CentOS,Ubuntu \u3092\u5bfe\u8c61\u306b\u3057\u3066\u304a\u308a\u3001MySQL\u304c\u5c0e\u5165\u3055\u308c\u3066\u3044\u308b\u30b1\u30fc\u30b9\u3092\u5bfe\u8c61\u306b\u3057\u3066\u3044\u307e\u305b\u3093\u3002\n\n\n## \u30ec\u30b7\u30d4\u306e\u30d5\u30a1\u30a4\u30eb\n\n\u30af\u30c3\u30af\u30d6\u30c3\u30af\u306e\u4e2d\u3067\u8a2d\u5b9a\u3059\u308b\u306e\u306f\u3001\u4e0b\u8a18\u306e\uff13\u7a2e\u985e\u3067\u3059\u3002\n\n```\nchef@ChefWs:~/chef-repo/site-cookbooks$ tree mysql01/\nmysql01/\n\u251c\u2500\u2500 CHANGELOG.md\n\u251c\u2500\u2500 README.md\n\u251c\u2500\u2500 attributes\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 default.rb    (1) \u30a2\u30c8\u30ea\u30d3\u30e5\u30fc\u30c8\u8a2d\u5b9a \n\u251c\u2500\u2500 definitions\n\u251c\u2500\u2500 files\n\u251c\u2500\u2500 libraries\n\u251c\u2500\u2500 metadata.rb\n\u251c\u2500\u2500 providers\n\u251c\u2500\u2500 recipes\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 default.rb   (2) \u30ec\u30b7\u30d4\u672c\u4f53\n\u251c\u2500\u2500 resources\n\u2514\u2500\u2500 templates\n    \u2514\u2500\u2500 default  (3) MySQL\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\n        \u251c\u2500\u2500 character-set.cnf.erb\n        \u251c\u2500\u2500 create_db.sql.erb\n        \u251c\u2500\u2500 create_user.sql.erb\n        \u251c\u2500\u2500 engine.cnf.erb\n        \u251c\u2500\u2500 my.cnf.erb\n        \u251c\u2500\u2500 mysqld_safe_syslog.cnf.erb\n        \u251c\u2500\u2500 secure_install.sql.erb\n        \u2514\u2500\u2500 usr.sbin.mysqld.erb\n```\n\n## (1) \u30a2\u30c8\u30ea\u30d3\u30e5\u30fc\u30c8\u8a2d\u5b9a\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308bMySQL\u306e\u30eb\u30fc\u30c8\u30d1\u30b9\u30ef\u30fc\u30c9\u3001\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u3001\u30a2\u30d7\u30ea\u30e6\u30fc\u30b6\u30fc\u3068\u30d1\u30b9\u30ef\u30fc\u30c9\u3092\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\u6700\u5f8c\u306e\uff15\u756a\u76ee\u306f\u3001\"service\" \u3068\u3059\u308c\u3070\u3001MySQL\u306e\u8a2d\u5b9a\u3092\u5b9f\u884c\u3057\u307e\u3059\u3002 stanby \u3068\u3059\u308b\u308c\u3070\u3001\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u307e\u3067\u306b\u3057\u3066\u3001MySQL\u306e\u30b3\u30f3\u30c6\u30ca\u9818\u57df\u306e\u4f5c\u6210\u3084\u8a2d\u5b9a\u3092\u5b9f\u65bd\u3057\u307e\u305b\u3093\u3002\u3053\u308c\u306f\u3001\u30a2\u30af\u30c6\u30a3\u30d6\u30fb\u30b9\u30bf\u30f3\u30d0\u30a4\u306e\u69cb\u6210\u3092\u7d44\u3080\u5834\u5408\u306e\u30b9\u30bf\u30f3\u30d0\u30a4\u6a5f\u3092\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u3059\u308b\u305f\u3081\u306b\u5229\u7528\u3057\u307e\u3059\u3002\n\n```\ndefault[\"mysql\"][\"root_password\"] = 'passw0rd'    (1)\u30eb\u30fc\u30c8\u30d1\u30b9\u30ef\u30fc\u30c9\ndefault[\"mysql\"][\"db_name\"] = 'testdb'  (2)\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u540d\ndefault[\"mysql\"][\"user\"][\"name\"] = 'wordpress' (3)\u30a2\u30d7\u30ea\u30e6\u30fc\u30b6\u30fc\ndefault[\"mysql\"][\"user\"][\"password\"] = 'wordpress' (4)\u30a2\u30d7\u30ea\u30e6\u30fc\u30b6\u30fc\u306e\u30d1\u30b9\u30ef\u30fc\u30c9\ndefault[\"mysql\"][\"node\"] = 'service' (5) service \u307e\u305f\u306f\u3001\u305d\u308c\u4ee5\u5916\u3067\u8a2d\u5b9a\n```\n\n## (2) \u30ec\u30b7\u30d4\u672c\u4f53\n\n\u3053\u306e\u30ec\u30b7\u30d4\u306f\u3001CentOS/RedHat 6\u30687, Ubuntu \u306e\u30b1\u30fc\u30b9\u3067\u5206\u5c90\u3092\u6301\u305f\u305b\u3001\u305d\u308c\u305e\u308c\u306e\u74b0\u5883\u306b\u5408\u308f\u305b\u3066\u5bfe\u5fdc\u3059\u308b\u69d8\u306b\u3057\u3066\u3044\u307e\u3059\u3002 MySQL\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u306f\u3001\u30a2\u30c8\u30ea\u30d3\u30e5\u30fc\u30c8\u306b\u51fa\u3059\u306e\u3067\u306f\u306a\u304f\u3001\u3053\u306e\u30ec\u30b7\u30d4\u306e\u4e2d\u306b\u30d9\u30bf\u66f8\u304d\u3057\u3066\u3044\u308b\u306e\u3067\u3001\u5229\u7528\u3057\u305f\u3044\u30d0\u30fc\u30b8\u30e7\u30f3\u306b\u66f8\u304d\u66ff\u3048\u3066\u5bfe\u5fdc\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\nSoftLayer\u306e CentOS \u306e SELinux \u306f\u3067\u30c7\u30d5\u30a9\u30eb\u30c8\u3067\u7121\u52b9\u306b\u306a\u3063\u3066\u304a\u308a\u3001\u305d\u306e\u307e\u307e\u3001\u5229\u7528\u3057\u307e\u3059\u3002\u3057\u304b\u3057\u3001Ubuntu \u306e SELinux \u306b\u76f8\u5f53\u3059\u308b AppArmor\u306f\u3001\u6709\u52b9\u5316\u3055\u308c\u3066\u304a\u308a\u3001MySQL\u306e\u30b3\u30f3\u30c6\u30ca\u9818\u57df\u3092/data1\u306b\u79fb\u52d5\u3059\u308b\u3060\u3051\u3067\u306f\u3001\u52d5\u4f5c\u3057\u307e\u305b\u3093\u3002 \u3053\u306e\u70ba\u3001AppArmor \u306e aa \u30b3\u30de\u30f3\u30c9\u3092\u5229\u7528\u3057\u3066\u3001MySQL\u304c /data1 \u3092\u5229\u7528\u3067\u304d\u308b\u69d8\u306b\u8a2d\u5b9a\u5909\u66f4\u3057\u3066\u3044\u307e\u3059\u3002\n\n```\nchef@ChefWs:~/chef-repo/site-cookbooks/mysql01/recipes$ cat default.rb \n# -*- coding: utf-8 -*-\n#\n# Cookbook Name:: mysql01\n# Recipe:: default\n# \n# MySQL 5.6 \u30b3\u30df\u30e5\u30cb\u30c6\u30a3\u30fb\u30a8\u30c7\u30a3\u30b7\u30e7\u30f3\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\n# \u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\uff06\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u3059\u308b\u30ec\u30b7\u30d4\n#\n\nwork_dir = '/root/mysql'\nconf_dir = '/etc/mysql'\n\n#\n# \u30d1\u30c3\u30b1\u30fc\u30b8\u5c0e\u5165 Ubuntu,CentOS/Redhat\n#\ncase node['platform']\n\nwhen 'ubuntu'\n  execute 'apt-get update' do\n    command 'apt-get update'\n  end\n\n  # \u524d\u63d0\u30d1\u30c3\u30b1\u30fc\u30b8\n  package 'apparmor-utils'\n  package 'libaio1'\n\n  # https://dev.mysql.com/downloads/mysql/ \u306e\u30b5\u30a4\u30c8\u304b\u3089MySQL\u306etar\u30d5\u30a1\u30a4\u30eb\u306eURL\u3092\u62fe\u3063\u3066\u6307\u5b9a\n  tar_url = 'http://dev.mysql.com/get/Downloads/MySQL-5.6/mysql-server_5.6.27-1ubuntu14.04_amd64.deb-bundle.tar'\n\nwhen 'centos','redhat'\n  execute 'yum update' do\n    command 'yum update -y'\n    action :run\n  end\n\n  # \u524d\u63d0\u30d1\u30c3\u30b1\u30fc\u30b8\n  package 'wget'\n  package 'libaio'\n\n  # https://dev.mysql.com/downloads/mysql/ \u306e\u30b5\u30a4\u30c8\u304b\u3089MySQL\u306etar\u30d5\u30a1\u30a4\u30eb\u306eURL\u3092\u62fe\u3063\u3066\u6307\u5b9a\n  case node['platform_version'].to_i\n    when 6\n      tar_url = 'http://dev.mysql.com/get/Downloads/MySQL-5.6/MySQL-5.6.27-1.el6.x86_64.rpm-bundle.tar'    \n    when 7\n      package 'net-tools'\n\n      tar_url = 'http://dev.mysql.com/get/Downloads/MySQL-5.6/MySQL-5.6.27-1.el7.x86_64.rpm-bundle.tar'\n  end\nend\n\n#\n# MySQL tar\u30d5\u30a1\u30a4\u30eb\u306e\u53d6\u5f97\u3068\u5c55\u958b\n#\nscript \"install_mysql\" do\n  interpreter \"bash\"\n  user        \"root\"\n  code <<-EOL\n     # rm -fr /etc/my.cnf /etc/my.cnf.d #{conf_dir}\n     mkdir #{conf_dir}\n     mkdir #{work_dir}\n     wget -P #{work_dir} #{tar_url}\n     cd #{work_dir}\n     tar xvf `ls *.tar`\n  EOL\n  action :run\nend\n\n\n#\n# MySQL Server\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n#\ncase node['platform']\nwhen 'ubuntu'\n  dpkg_package \"#{work_dir}/mysql-common_5.6.27-1ubuntu14.04_amd64.deb\"\n  dpkg_package \"#{work_dir}/mysql-community-server_5.6.27-1ubuntu14.04_amd64.deb\"\n  dpkg_package \"#{work_dir}/mysql-community-client_5.6.27-1ubuntu14.04_amd64.deb\"\nwhen 'centos','redhat'\n  case node['platform_version'].to_i\n    when 6\n      # \u4f9d\u5b58\u95a2\u4fc2\u306e\u3042\u308b\u30e2\u30b8\u30e5\u30fc\u30eb postfix\u4ee5\u4e0b\u306e\u30b3\u30de\u30f3\u30c9\u306f\u5b9f\u884c\u3067\u304d\u306a\u3044\u3002\n      #rpm_package \"mysql-libs-5.1.73-5.el6_6.x86_64\" do\n      #  action :remove\n      #end\n      execute \"delete mysql-libs-5.1.73-5.el6_6.x86_64\" do\n        command \"rpm -e --nodeps mysql-libs-5.1.73-5.el6_6.x86_64\"\n        action :run\n        ignore_failure true\n      end\n\n      rpm_package \"#{work_dir}/MySQL-shared-5.6.27-1.el6.x86_64.rpm\" \n      rpm_package \"#{work_dir}/MySQL-shared-compat-5.6.27-1.el6.x86_64.rpm\" \n      rpm_package \"#{work_dir}/MySQL-server-5.6.27-1.el6.x86_64.rpm\"\n      rpm_package \"#{work_dir}/MySQL-client-5.6.27-1.el6.x86_64.rpm\"\n\n    when 7\n      # \u4f9d\u5b58\u95a2\u4fc2\u306e\u3042\u308b\u30e2\u30b8\u30e5\u30fc\u30eb postfix\u4ee5\u4e0b\u306e\u30b3\u30de\u30f3\u30c9\u306f\u5b9f\u884c\u3067\u304d\u306a\u3044\u3002\n      #rpm_package \"mariadb-libs-5.5.44-1.el7_1.x86_64\" do\n      #  action :remove\n      #end\n      execute \"delete mariadb-libs-5.5.44-1.el7_1.x86_64\" do\n        command \"rpm -e --nodeps mariadb-libs-5.5.44-1.el7_1.x86_64\"\n        action :run\n        ignore_failure true\n      end\n\n      rpm_package \"#{work_dir}/MySQL-shared-5.6.27-1.el7.x86_64.rpm\" \n      rpm_package \"#{work_dir}/MySQL-shared-compat-5.6.27-1.el7.x86_64.rpm\"\n      rpm_package \"#{work_dir}/MySQL-server-5.6.27-1.el7.x86_64.rpm\"\n      rpm_package \"#{work_dir}/MySQL-client-5.6.27-1.el7.x86_64.rpm\"\n  end\nend\n\n\n#\n# MySQL\u306e\u81ea\u52d5\u8d77\u52d5\u3068\u505c\u6b62\u3092\u8a2d\u5b9a\n#\nservice \"mysql\" do\n  supports :start => true, :stop => true\n  action [ :enable, :stop]\nend\n\n\n#\n# \u30b3\u30f3\u30c6\u30ca\u9818\u57df\u3092\u65b0\u898f\u4f5c\u6210\n#  iSCSI\u3068\u7d44\u307f\u5408\u308f\u305b\u3066\u3001\u5916\u90e8\u5171\u7528\u30c7\u30a3\u30b9\u30af\u306e\u30de\u30a6\u30f3\u30c8\u30fb\u30dd\u30a4\u30f3\u30c8\u3068\u3057\u3066\n#  \u5229\u7528\u3067\u304d\u308b\u69d8\u306b\u3059\u308b\n#\ndirectory \"/data1\" do\n  owner 'mysql'\n  group 'mysql'\n  mode '0755'\n  action :create\n  notifies :stop, \"service[mysql]\", :immediately\nend\n\n\ncase node['platform']\n#\n# Ubuntu \u306e AppArmor \u30a2\u30d7\u30ea \u30a2\u30fc\u30de\u30fc\u306e\u8a2d\u5b9a\n#\nwhen 'ubuntu','debian'\n  execute \"aa-disable_usr.bin.mysqld\" do\n    command \"aa-disable usr.sbin.mysqld\"\n    ignore_failure true\n    action :run\n  end\n  execute \"aa-enforce_usr.bin.mysqld\" do\n    command \"aa-enforce usr.sbin.mysqld\"\n    ignore_failure true\n    action :nothing\n  end\n  template \"/etc/apparmor.d/usr.sbin.mysqld\" do\n    source \"usr.sbin.mysqld.erb\"\n    owner \"root\"\n    group \"root\"\n    mode 0644\n    notifies :run, \"execute[aa-enforce_usr.bin.mysqld]\"\n  end\n\n\n#\n# CentOS/RedHat \u306f\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u306e\u7f6e\u304d\u5834\u4f5c\u6210\n#\nwhen 'centos','redhat'\n  directory \"/etc/mysql\" do\n    owner \"root\"\n    group \"root\"\n    mode '0755'\n    action :create\n  end\n  directory \"/etc/mysql/conf.d\" do\n    owner \"root\"\n    group \"root\"\n    mode '0755'\n    action :create\n  end\n  directory \"/var/log/mysql\" do\n    owner \"mysql\"\n    group \"mysql\"\n    mode '0755'\n    action :create\n  end\n\nend # case\n\n\n#\n# MySQL\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u306e\u914d\u7f6e\n#\ntemplate \"/etc/mysql/my.cnf\" do\n  source \"my.cnf.erb\"\n  owner \"root\"\n  group \"root\"\n  mode 0644\nend\ntemplate \"/etc/mysql/conf.d/character-set.cnf\" do\n  source \"character-set.cnf.erb\"\n  owner \"root\"\n  group \"root\"\n  mode 0644\nend\ntemplate \"/etc/mysql/conf.d/engine.cnf\" do\n  source \"engine.cnf.erb\"\n  owner \"root\"\n  group \"root\"\n  mode 0644\nend\ntemplate \"/etc/mysql/conf.d/mysqld_safe_syslog.cnf\" do\n  source \"mysqld_safe_syslog.cnf.erb\"\n  owner \"root\"\n  group \"root\"\n  mode 0644\nend\n\n\n#\n# \u5148\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u304c\u6307\u3059\u30b3\u30f3\u30c6\u30ca\u9818\u57df\u306b\n# MySQL\u306e\u30b3\u30f3\u30c6\u30ca\u3001\u30ed\u30b0\u7b49\u3092\u4f5c\u6210\u3059\u308b\n#\n# \u5171\u6709\u30c7\u30a3\u30b9\u30af\u306b\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u3059\u308b\u4e8b\u3092\u60f3\u5b9a\u3057\u3066\n# \u3053\u306e\u8a2d\u5b9a\u304c\u52d5\u4f5c\u3059\u308b\u306e\u306f\u3001service \u30ce\u30fc\u30c9\u306e\u5834\u5408\u306e\u307f\u3067\n# standby \u30ce\u30fc\u30c9\u306e\u5834\u5408\u306b\u306f\u3001\u5b9f\u884c\u3057\u306a\u3044\u3002\n# \nexecute \"mysqL_install_db\" do\n  command \"/usr/bin/mysql_install_db\"\n  action :run\n  only_if {node[\"mysql\"][\"node\"] == 'service'}\n  notifies :start, \"service[mysql]\", :immediately\nend\n\n#\n# secure_install.sql \u3092\u5b9f\u884c\u3057\u3066\u30d1\u30b9\u30ef\u30fc\u30c9\u3092\u8a2d\u5b9a\n#\nroot_password = node[\"mysql\"][\"root_password\"]\ntemplate \"#{Chef::Config[:file_cache_path]}/secure_install.sql\" do\n  owner \"root\"\n  group \"root\"\n  mode 0644\n  source \"secure_install.sql.erb\"\n  variables({\n    :root_password => root_password,\n  })\n  only_if {node[\"mysql\"][\"node\"] == 'service'}\n  action :create\nend\n\n\nexecute \"secure_install\" do\n  command \"/usr/bin/mysql -u root < #{Chef::Config[:file_cache_path]}/secure_install.sql\"\n  # \u533f\u540d\u30e6\u30fc\u30b6\u30fc\u306e\u524a\u9664\u3067\u5b58\u5728\u3057\u306a\u3044\u3068\u30a8\u30e9\u30fc\u3068\u306a\u308b\u306e\u3067\u8ffd\u52a0\n  ignore_failure true\n  only_if \"/usr/bin/mysql -u root -e 'show databases;'\"\n  only_if {node[\"mysql\"][\"node\"] == 'service'}\n  action :run\nend\n\n\n#\n# \u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u3092\u4f5c\u6210\n# \ndb_name = node[\"mysql\"][\"db_name\"]\ntemplate \"#{Chef::Config[:file_cache_path]}/create_db.sql\" do\n  owner \"root\"\n  group \"root\"\n  mode 0644\n  source \"create_db.sql.erb\"\n  variables({\n    :db_name => db_name,\n  })\n  only_if {node[\"mysql\"][\"node\"] == 'service'}\n  action :create\nend\nexecute \"create_db\" do\n  command \"/usr/bin/mysql -u root -p#{root_password} < #{Chef::Config[:file_cache_path]}/create_db.sql\"\n  not_if \"/usr/bin/mysql -u root -p#{root_password} -D #{db_name}\"\n  only_if {node[\"mysql\"][\"node\"] == 'service'}\n  action :run\nend\n\n\n#\n# \u30e6\u30fc\u30b6\u30fc\u3092\u8ffd\u52a0\n#\nuser_name     = node[\"mysql\"][\"user\"][\"name\"]\nuser_password = node[\"mysql\"][\"user\"][\"password\"]\n\ntemplate \"#{Chef::Config[:file_cache_path]}/create_user.sql\" do\n  owner \"root\"\n  group \"root\"\n  mode 0644\n  source \"create_user.sql.erb\"\n  variables({\n    :db_name => db_name,\n    :username => user_name,\n    :password => user_password,\n  })\n  only_if {node[\"mysql\"][\"node\"] == 'service'}\n  action :create\nend\nexecute \"create_user\" do\n  command \"/usr/bin/mysql -u root -p#{root_password} < #{Chef::Config[:file_cache_path]}/create_user.sql\"\n  not_if \"/usr/bin/mysql -u #{user_name} -p#{user_password} -D #{db_name}\"\n  only_if {node[\"mysql\"][\"node\"] == 'service'}\n  action :run\nend\n```\n\n## (3) MySQL\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\n\nMySQL\u306e\u30d5\u30a1\u30a4\u30eb\u306f\u3001\u3053\u3053\u3067\u89e3\u8aac\u3059\u308b\u3088\u308a\u3082\u3001GitHub\u306b\u767b\u9332\u3057\u305f\u73fe\u7269\u3092\u307f\u308b\u306e\u304c\u826f\u3044\u3068\u601d\u3044\u307e\u3059\u306e\u3067\u3001\u3053\u3053\u3067\u306f\u3001\u305d\u308c\u305e\u308c\u306e\u30d5\u30a1\u30a4\u30eb\u306e\u76ee\u7684\u3092\u8a18\u8f09\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\n \n- character-set.cnf.erb        utf-8 \u8a2d\u5b9a\n- create_db.sql.erb            utf-8 \u3067\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u4f5c\u6210\n- create_user.sql.erb          \u30a2\u30d7\u30ea\u30e6\u30fc\u30b6\u30fc\u767b\u9332 \u4efb\u610f\u30db\u30b9\u30c8\u304b\u3089\u8a31\u53ef\n- engine.cnf.erb               InnoDB\u6307\u5b9a\n- my.cnf.erb                   MySQL\u8a2d\u5b9a\u672c\u4f53 \uff08\u307b\u3068\u3093\u3069\u30c7\u30d5\u30a9\u30eb\u30c8\uff09\n- mysqld_safe_syslog.cnf.erb   Syslog \u30b5\u30fc\u30d3\u30b9\u6307\u5b9a\n- secure_install.sql.erb       \u533f\u540d\u30e6\u30fc\u30b6\u30fc\u306e\u524a\u9664\u3001root\u63a5\u7d9a\u3092\u8a31\u53ef\u3059\u308b\u30db\u30b9\u30c8\u8a2d\u5b9a\n- usr.sbin.mysqld.erb          AppArmor\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\n\n\n#\u30ec\u30b7\u30d4\u306e\u9069\u7528\u624b\u9806\n\u8d77\u52d5\u3057\u3066\u304d\u305f\u4eee\u60f3\u30b5\u30fc\u30d0\u30fc\u3084\u7269\u7406\u30b5\u30fc\u30d0\u30fc\u306b\u5bfe\u3057\u3066\u3001\u4ee5\u4e0b\u306e\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3059\u308b\u3060\u3051\u3067\u3059\u3002 \u30b5\u30fc\u30d0\u30fc\u306eOS\u306b\u3088\u308b\u9055\u3044\u306f\u3001\u30ec\u30b7\u30d4\u306e\u4e2d\u3067\u5207\u66ff\u3048\u3066\u52d5\u4f5c\u3059\u308b\u306e\u3067\u3001\u30aa\u30d7\u30b7\u30e7\u30f3\u7b49\u3092\u5909\u66f4\u3059\u308b\u5fc5\u8981\u306f\u3042\u308a\u307e\u305b\u3093\u3002\n\u65e2\u306bCHEF Solo \u3092\u5229\u7528\u3057\u3066\u3044\u308b\u65b9\u306f\u3054\u5b58\u77e5\u3068\u601d\u3044\u307e\u3059\u304c\u3001\u30ea\u30dd\u30b8\u30c8\u30ea chef-repo \u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u30ab\u30ec\u30f3\u30c8\u306b\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\n```\nchef@ChefWs:~/chef-repo$ knife solo bootstrap 10.132.253.30 -x root -r 'recipe[mysql01]' -i ~/key/chefkey\n```\n\u65e2\u306bchef-client\u304c\u5c0e\u5165\u3055\u308c\u3066\u3044\u308b\u5834\u5408\u306f\u3001bootstrap \u306e\u90e8\u5206\u3092 cook \u306b\u5909\u3048\u3066\u5b9f\u884c\u3057\u307e\u3059\u3002\n\n## \u3053\u306e\u30ec\u30b7\u30d4\u3067\u4f5c\u6210\u3057\u305fMySQL\u30b5\u30fc\u30d0\u30fc\u306b\u30ed\u30b0\u30a4\u30f3\n\u4ee5\u4e0b\u306f\u3001\u30a2\u30c8\u30ea\u30d3\u30e5\u30fc\u30c8\u306b\u8a2d\u5b9a\u3057\u3066\u3042\u308b \u30e6\u30fc\u30b6\u30fc\u540d\u3001\u30d1\u30b9\u30ef\u30fc\u30c9\u3001\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u540d\u3067\u30ed\u30b0\u30a4\u30f3\u3057\u3066\u307f\u305f\u7d50\u679c\u3067\u3059\u3002\n\n```\nchef@ChefWs:~$ ssh root@10.132.253.30 -i ~/key/chefkey\nLast login: Thu Oct 15 21:05:10 2015 from 10.132.253.38\n[root@server3 ~]# mysql -u wordpress -pwordpress testdb\nWarning: Using a password on the command line interface can be insecure.\nWelcome to the MySQL monitor.  Commands end with ; or \\g.\nYour MySQL connection id is 7\nServer version: 5.6.27 MySQL Community Server (GPL)\n\nCopyright (c) 2000, 2015, Oracle and/or its affiliates. All rights reserved.\n\nOracle is a registered trademark of Oracle Corporation and/or its\naffiliates. Other names may be trademarks of their respective\nowners.\n\nType 'help;' or '\\h' for help. Type '\\c' to clear the current input statement.\n\nmysql> \\s\n--------------\nmysql  Ver 14.14 Distrib 5.6.27, for Linux (x86_64) using  EditLine wrapper\n\nConnection id:\t\t7\nCurrent database:\ttestdb\nCurrent user:\t\twordpress@localhost\nSSL:\t\t\tNot in use\nCurrent pager:\t\tstdout\nUsing outfile:\t\t''\nUsing delimiter:\t;\nServer version:\t\t5.6.27 MySQL Community Server (GPL)\nProtocol version:\t10\nConnection:\t\tLocalhost via UNIX socket\nServer characterset:\tutf8\nDb     characterset:\tutf8\nClient characterset:\tutf8\nConn.  characterset:\tutf8\nUNIX socket:\t\t/var/run/mysqld/mysqld.sock\nUptime:\t\t\t2 hours 3 min 6 sec\n\nThreads: 1  Questions: 26  Slow queries: 0  Opens: 68  Flush tables: 1  Open tables: 61  Queries per second avg: 0.003\n--------------\n\nmysql> \n```\n\n\n# \u30c6\u30b9\u30c8\u6e08\u307f\u306eLinux\u30c7\u30a3\u30b9\u30c8\u30ea\u30d3\u30e5\u30fc\u30b7\u30e7\u30f3\nSoftLayer\u3067\u30b5\u30fc\u30d0\u30fc\u30aa\u30fc\u30c0\u30fc\u6642\u306b\u9078\u629e\u3067\u304d\u308bOS\u306e\u4e2d\u304b\u3089\u3001\u78ba\u8a8d\u3067\u304d\u305f\u3082\u306e\u306e\u30ea\u30b9\u30c8\u3067\u3059\u3002\n\n- Ubuntu 14.04 64bit minimal install\n- CentOS 7.1 64bit minimal install\n- CentOS 6.7 64bit minimal install\n\n\n# \u30ec\u30b7\u30d4\u306e\u7f6e\u304d\u5834\u6240\n\u6700\u65b0\u7248\u306e\u30ec\u30b7\u30d4\u306fGitHub\u306b\u3042\u308a\u307e\u3059\u3002\n- GitHub takara9/chef-repo/ iscsiStorage01  https://github.com/takara9/chef-repo/tree/master/site-cookbooks/mysql01\n\n\n# Chef \u95a2\u9023\u30de\u30cb\u30e5\u30a2\u30eb\n\u3053\u306e\u30ec\u30b7\u30d4\u3092\u4f5c\u308b\u306b\u3042\u305f\u3063\u3066\u53c2\u7167\u3057\u305fCHEF\u30de\u30cb\u30e5\u30a2\u30eb\u306e\u30ea\u30f3\u30af\u3067\u3059\u3002\n- script  (https://docs.chef.io/resource_script.html )\n- execute (https://docs.chef.io/resource_execute.html )\n- package (https://docs.chef.io/resource_package.html )\n- template (https://docs.chef.io/resource_template.html)\n- file (https://docs.chef.io/resource_file.html)\n- directory (https://docs.chef.io/resource_directory.html)\n\n\n\n# \u53c2\u8003\u8cc7\u6599\n- https://dev.mysql.com/doc/refman/5.6/en/binary-installation.html\n", "tags": ["SoftLayer", "MySQL", "CentOS", "Ubuntu", "chef"]}