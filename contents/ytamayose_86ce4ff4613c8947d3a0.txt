{"tags": ["Facebook", "Bluemix", "Node.js", "bot"], "context": "Messenger\u3000Platform/Getting\u3000Started\nFacebook\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u3068Qiita\u306e\u8a18\u4e8b\u3092\u53c2\u8003\u306b\u30aa\u30a6\u30e0\u8fd4\u3057Bot\u3092\u4f5c\u6210\u3057\u307e\u3057\u305f\u3002\n\u3064\u304e\u306f\u304e\u3067\u3059\u304c\u3001\u4e00\u5fdc\u52d5\u304f\u306f\u305a\u3002\u3002\n\n\u6d41\u308c\n\nBluemix\u306e\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\nFacebook Messenger Platform\u306e\u8a2d\u5b9a\n\n\nBluemix\u306e\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\n\nIBM SDK for Node.js\u3000\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3092\u4f5c\u6210\n\u30b9\u30bf\u30fc\u30bf\u30fc\u30b3\u30fc\u30c9\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\n\u4ee5\u4e0b\u306e\u30d5\u30a1\u30a4\u30eb\u3092\u5909\u66f4\nBluemix\u3078Push\n\n\napp.js\nvar express = require('express');\nvar request = require('request');\n\nvar app = express();\nvar bodyParser = require('body-parser');\napp.use(bodyParser.urlencoded({ extended: true }));\napp.use(bodyParser.json());\n\nvar token = \"<YOUR TOKEN>\";\n\nfunction sendTextMessage(sender, text) {\n  messageData = {\n    text:text\n  }\n\n var options = {\n    url: 'https://graph.facebook.com/v2.6/me/messages',\n    qs: {access_token:token},\n    method: 'POST',\n    json: {\n      recipient: {id:sender},\n      message: messageData,\n    }\n  }\n\n  request.post(options, function(error, response, body){\n    if (!error && response.statusCode == 200) {\n      console.log(body.name);\n    } else {\n      console.log('error: '+ response.statusCode);\n    }\n  });\n}\n\napp.get('/webhook/', function (req, res) {\n  if (req.query['hub.verify_token'] === '<VALIDATION TOKEN>') {\n    res.send(req.query['hub.challenge']);\n  }\n  res.send('Error, wrong validation token');\n})\n\napp.post('/webhook/', function (req, res) {\n  messaging_events = req.body.entry[0].messaging;\n  for (i = 0; i < messaging_events.length; i++) {\n    event = req.body.entry[0].messaging[i];\n    sender = event.sender.id;\n    if (event.message && event.message.text) {\n      text = event.message.text;\n      sendTextMessage(sender, \"Text received, echo: \"+ text.substring(0, 200));\n    }\n  }\n  res.sendStatus(200);\n});\n\nvar server = app.listen(process.env.PORT || 3000, function() {\n  console.log('Listening on port %d', server.address().port);\n});\n\n\n\nmanifest.yml\napplications:\n- disk_quota: 1024M\n  host: <YOUR HOST>\n  name: HelloWorld\n  command: node app.js\n  path: .\n  domain: <YOUR DOMAIN>\n  instances: 1\n  memory: 256M\n\n\n\n\npackage.json\n{\n  \"name\": \"cloudant_boilerplate_nodejs\",\n  \"version\": \"0.0.2\",\n  \"private\": true,\n  \"scripts\": {\n    \"start\": \"node app.js\"\n  },\n  \"dependencies\": {\n    \"express\": \"4.13.x\",\n    \"ejs\": \"2.4.x\",\n    \"cloudant\": \"1.4.x\",\n    \"body-parser\": \"1.14.x\",\n    \"method-override\": \"2.3.x\",\n    \"morgan\": \"1.6.x\",\n    \"errorhandler\": \"1.4.x\",\n    \"connect-multiparty\": \"2.0.x\",\n    \"request\": \"2.71.x\" //<-\u8ffd\u52a0\u884c\n  },\n  \"repository\": {},\n  \"engines\": {\n    \"node\": \"4.2.x\"\n  }\n}\n\n\n\n\nFacebook Messenger\u3000Platform\u306e\u8a2d\u5b9a\n\nFacebook\u30da\u30fc\u30b8\u306e\u4f5c\u6210\nMessenger -> Webhook\u3092\u8a2d\u5b9a\n\u30a2\u30af\u30bb\u30b9\u30c8\u30fc\u30af\u30f3\u767a\u884c -> app.js\u306b\u30a2\u30af\u30bb\u30b9\u30c8\u30fc\u30af\u30f3\u3092\u8a2d\u5b9a\u3057\u3066\u518d\u5ea6Bluemix\u306bPush\n\u30a2\u30d7\u30ea\u7533\u8acb -> curl -ik -X POST \"https://graph.facebook.com/v2.6/me/subscribed_apps?access_token=<token>\"\n\nFacebook\u4e0a\u3067Bot\u306e\u52d5\u4f5c\u78ba\u8a8d\n\n\u3053\u3061\u3089\u306e\u8a18\u4e8b\u3092\u53c2\u8003\u306b\u3055\u305b\u3066\u3044\u305f\u3060\u304d\u307e\u3057\u305f\u3002\nMessenger\u3067\u7c21\u5358\u306aBot\u3064\u304f\u308b(Facebook Messenger Platform from F8)\n[Messenger\u3000Platform/Getting\u3000Started](https://developers.facebook.com/docs/messenger-platform/quickstart)\nFacebook\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u3068Qiita\u306e\u8a18\u4e8b\u3092\u53c2\u8003\u306b\u30aa\u30a6\u30e0\u8fd4\u3057Bot\u3092\u4f5c\u6210\u3057\u307e\u3057\u305f\u3002\n\u3064\u304e\u306f\u304e\u3067\u3059\u304c\u3001\u4e00\u5fdc\u52d5\u304f\u306f\u305a\u3002\u3002\n\n#\u6d41\u308c\n1. Bluemix\u306e\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\n2. Facebook Messenger Platform\u306e\u8a2d\u5b9a\n\n#Bluemix\u306e\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\n1. IBM SDK for Node.js\u3000\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3092\u4f5c\u6210\n2. \u30b9\u30bf\u30fc\u30bf\u30fc\u30b3\u30fc\u30c9\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\n3. \u4ee5\u4e0b\u306e\u30d5\u30a1\u30a4\u30eb\u3092\u5909\u66f4\n4. Bluemix\u3078Push\n\n\n```js:app.js\nvar express = require('express');\nvar request = require('request');\n\nvar app = express();\nvar bodyParser = require('body-parser');\napp.use(bodyParser.urlencoded({ extended: true }));\napp.use(bodyParser.json());\n\nvar token = \"<YOUR TOKEN>\";\n\nfunction sendTextMessage(sender, text) {\n  messageData = {\n    text:text\n  }\n \n var options = {\n    url: 'https://graph.facebook.com/v2.6/me/messages',\n    qs: {access_token:token},\n    method: 'POST',\n    json: {\n      recipient: {id:sender},\n      message: messageData,\n    }\n  }\n\n  request.post(options, function(error, response, body){\n    if (!error && response.statusCode == 200) {\n      console.log(body.name);\n    } else {\n      console.log('error: '+ response.statusCode);\n    }\n  });\n}\n\napp.get('/webhook/', function (req, res) {\n  if (req.query['hub.verify_token'] === '<VALIDATION TOKEN>') {\n    res.send(req.query['hub.challenge']);\n  }\n  res.send('Error, wrong validation token');\n})\n\napp.post('/webhook/', function (req, res) {\n  messaging_events = req.body.entry[0].messaging;\n  for (i = 0; i < messaging_events.length; i++) {\n    event = req.body.entry[0].messaging[i];\n    sender = event.sender.id;\n    if (event.message && event.message.text) {\n      text = event.message.text;\n      sendTextMessage(sender, \"Text received, echo: \"+ text.substring(0, 200));\n    }\n  }\n  res.sendStatus(200);\n});\n\nvar server = app.listen(process.env.PORT || 3000, function() {\n  console.log('Listening on port %d', server.address().port);\n});\n```\n\n\n```yaml:manifest.yml\napplications:\n- disk_quota: 1024M\n  host: <YOUR HOST>\n  name: HelloWorld\n  command: node app.js\n  path: .\n  domain: <YOUR DOMAIN>\n  instances: 1\n  memory: 256M\n\n```\n\n```json:package.json\n{\n  \"name\": \"cloudant_boilerplate_nodejs\",\n  \"version\": \"0.0.2\",\n  \"private\": true,\n  \"scripts\": {\n    \"start\": \"node app.js\"\n  },\n  \"dependencies\": {\n    \"express\": \"4.13.x\",\n    \"ejs\": \"2.4.x\",\n    \"cloudant\": \"1.4.x\",\n    \"body-parser\": \"1.14.x\",\n    \"method-override\": \"2.3.x\",\n    \"morgan\": \"1.6.x\",\n    \"errorhandler\": \"1.4.x\",\n    \"connect-multiparty\": \"2.0.x\",\n    \"request\": \"2.71.x\" //<-\u8ffd\u52a0\u884c\n  },\n  \"repository\": {},\n  \"engines\": {\n  \t\"node\": \"4.2.x\"\n  }\n}\n\n```\n\n\n#Facebook Messenger\u3000Platform\u306e\u8a2d\u5b9a\n1. Facebook\u30da\u30fc\u30b8\u306e\u4f5c\u6210\n2. Messenger -> Webhook\u3092\u8a2d\u5b9a\n3. \u30a2\u30af\u30bb\u30b9\u30c8\u30fc\u30af\u30f3\u767a\u884c -> app.js\u306b\u30a2\u30af\u30bb\u30b9\u30c8\u30fc\u30af\u30f3\u3092\u8a2d\u5b9a\u3057\u3066\u518d\u5ea6Bluemix\u306bPush\n4. \u30a2\u30d7\u30ea\u7533\u8acb -> `curl -ik -X POST \"https://graph.facebook.com/v2.6/me/subscribed_apps?access_token=<token>\"`\n5. Facebook\u4e0a\u3067Bot\u306e\u52d5\u4f5c\u78ba\u8a8d\n\n\u3053\u3061\u3089\u306e\u8a18\u4e8b\u3092\u53c2\u8003\u306b\u3055\u305b\u3066\u3044\u305f\u3060\u304d\u307e\u3057\u305f\u3002\n[Messenger\u3067\u7c21\u5358\u306aBot\u3064\u304f\u308b(Facebook Messenger Platform from F8)](http://qiita.com/pochi-sato/items/f3f5598e36c1fa92d840)\n"}