{"context": "\n\nAPI Gateway + Lambda \u3067 slack app\n\nslack app\nslack app\u3068\u306fbot\u3084commands\u306a\u3069\u306e\u96c6\u5408\u4f53\u3067\u3001\u3053\u308c\u3092\u767b\u9332\u3059\u308c\u3070\u3001app\u306b\u542b\u307e\u308c\u3066\u3044\u308bbot\u3084commands\u304c\u4f7f\u3048\u308b\u3088\u3046\u306b\u306a\u308b\u3082\u306e\u3067\u3059\u3002\ntoken\u304c\u4e00\u610f\u3067\u6e08\u3080\u306e\u3068\u3001interactive message\nhttps://api.slack.com/docs/message-buttons\n\u3092\u4f7f\u3046\u3053\u3068\u304c\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\u3053\u308c\u3092\u4f7f\u3046\u3053\u3068\u3067\u3001interactive\u306b\u64cd\u4f5c\u3092\u9032\u3081\u308b\u3053\u3068\u304c\u53ef\u80fd\u3067\u3059\u3002\nslack app\u306b\u3064\u3044\u3066\u8a73\u3057\u304f\u306f\u4e0b\u8a18\u3092\u53c2\u7167\u3057\u3066\u304f\u3060\u3055\u3044\u3002\nhttps://api.slack.com/slack-apps\n\u4f5c\u6210\u3057\u305fslack app\u306f\u5168\u4f53\u306b\u516c\u958b\u3059\u308b\u3053\u3068\u3082\u3067\u304d\u307e\u3059\u3002\u304c\u3001\u4eca\u56de\u306f\u5b8c\u5168\u306bprivate\u76ee\u7684\u306a\u306e\u3067\u81ea\u30c1\u30fc\u30e0\u306b\u3060\u3051\u767b\u9332\u3057\u3066\u5229\u7528\u3057\u307e\u3059\u3002\n\napi gateway + Lambda\nAPI Gateway + Lambda\u3068\u3059\u308b\u306e\u306f\u3001\u5e38\u306b\u8d77\u52d5\u3057\u3066\u3044\u308b\u5fc5\u8981\u304c\u306a\u3044\u304b\u3089\u30b5\u30fc\u30d0\u304c\u3044\u3089\u306a\u3044\u69cb\u6210\u306b\u3057\u305f\u3044\u305f\u3081\u3067\u3059\u3002\n\u3055\u3089\u306bslash commands\u3092\u4f7f\u3046\u5834\u5408\u3001bot\u3068\u9055\u3063\u3066slash commands\u3092\u5b9f\u884c\u3057\u305f\u6642\u3060\u3051\u547c\u3073\u51fa\u3055\u308c\u308b\u305f\u3081\u3001\u6599\u91d1\u7684\u306b\u3082\u5b89\u5fc3\u3067\u3059\u3002\n\n\u5fc5\u8981\u306a\u3082\u306e\n\napex\n\nhttp://apex.run/\nlambda\u306e\u30c7\u30d7\u30ed\u30a4\u306b\u4f7f\u3044\u307e\u3059\u3002invoke\u3068logs\u304c\u4fbf\u5229\u3067\u3059\u3002\nterraform\u3068\u3082\u9023\u643a\u3067\u304d\u307e\u3059\u304c\u3001terraform\u3068api gateway + lambda\u306e\u9023\u643a\u304c\u3064\u3089\u3044\u306e\u3067\u4eca\u56de\u306f\u898b\u9001\u308a\u307e\u3057\u305f\u3002\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u306f\u3053\u308c\u3060\u3051\u3067\u3059\u3002\ncurl https://raw.githubusercontent.com/apex/apex/master/install.sh | sh\n\n\naws credentials\n\naws configure \u3067\u30a2\u30af\u30bb\u30b9\u30ad\u30fc\u3068\u30b7\u30fc\u30af\u30ec\u30c3\u30c8\u30a2\u30af\u30bb\u30b9\u30ad\u30fc\u3092\u8a2d\u5b9a\u3057\u3066\u304a\u304d\u307e\u3059\u3002\napex\u304c\u30c7\u30d5\u30a9\u30eb\u30c8\u3060\u3068iam\u3082\u914d\u7f6e\u3059\u308b\u306e\u3067\u3001lambda\u3068iam\u95a2\u4fc2\u306e\u6a29\u9650\u304c\u306a\u3051\u308c\u3070\u306a\u308a\u307e\u305b\u3093\u3002\n\u307e\u305f\u3001token\u306a\u3069\u306e\u4fdd\u6301\u306bkms\u3092\u5229\u7528\u3059\u308b\u306e\u3067\u305d\u306e\u6a29\u9650\u3082\u5fc5\u8981\u3067\u3059\u3002\n\u8907\u6570credential\u3092\u6301\u3063\u3066\u3044\u308b\u5834\u5408\u306f\u3001apex\u306e\u8a2d\u5b9a\u304b\u3089profile\u6307\u5b9a\u3082\u3067\u304d\u307e\u3059\u3002\u8a73\u3057\u304f\u306f\u516c\u5f0f\u30da\u30fc\u30b8\u306b\u3002\n\nslack\n\n\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\napex\u3067lambda\u306e\u914d\u7f6e\n\u307e\u305a\u306f\u7a7a\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3067\napex init\n\n\u3092\u3059\u308b\u3053\u3068\u3067\u3001apex\u306e\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u30d5\u30a1\u30a4\u30eb\u3001apex\u304c\u5229\u7528\u3059\u308bIAM\u306e\u4f5c\u6210\u304c\u884c\u308f\u308c\u307e\u3059\u3002\nproject name\u306f\u3053\u3053\u3067\u306fcommands\u3068\u3057\u3066\u304a\u304d\u307e\u3059\u3002\napex\u306b\u6163\u308c\u3066\u304a\u304d\u305f\u3044\u5834\u5408\u306b\u306f\u516c\u5f0f\u306eGetting started\u306b\u3057\u305f\u304c\u3063\u3066\u3001hello\u3092\u914d\u7f6e\u3057\u3066\u307f\u308b\u3068\u3044\u3044\u3067\u3057\u3087\u3046\u3002\n\noauth callback\u306e\u4f5c\u6210\nslack app\u306e\u767b\u9332\u306boauth\u306ecallback\u304c\u5fc5\u8981\u3067\u3059\u3002\u624b\u3067\u3084\u308c\u306a\u3044\u3053\u3068\u3082\u306a\u3044\u3067\u3059\u304c\u3001\u305b\u3063\u304b\u304f\u306a\u306e\u3067\u3053\u308c\u3082api gateway + lambda\u3067\u51e6\u7406\u3057\u3066\u307f\u307e\u3059\u3002\n\nslack app\u306e\u4f5c\u6210\nhttps://api.slack.com/apps\n[Create New App] \u304b\u3089\u65b0\u3057\u3044App\u3092\u4f5c\u308a\u307e\u3059\u3002 I plan to submit this app the Slack App Directory \u306f\u3053\u306e\u30a2\u30d7\u30ea\u3092\u516c\u958b\u3059\u308b\u5834\u5408\u306a\u306e\u3067\u4eca\u56de\u306f\u30c1\u30a7\u30c3\u30af\u306f\u4e0d\u8981\u3067\u3059\u3002\n\n\u4f5c\u6210\u5f8c\u306b\u8868\u793a\u3055\u308c\u308bBasic Infomation\u306b\u3042\u308bclient_id\u3068client_secret\u3092\u63a7\u3048\u3066\u304a\u304d\u307e\u3059\u3002\n\u307e\u305f\u3001\u3053\u3053\u3067\u5909\u66f4\u3067\u304d\u308bicon\u306f\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3057\u305f\u6642\u306b\u8868\u793a\u3055\u308c\u308b\u3082\u306e\u306a\u306e\u3067\u3001\u76ee\u7684\u306b\u5fdc\u3058\u305f\u3082\u306e\u306b\u5909\u3048\u308b\u3068\u3044\u3044\u3067\u3057\u3087\u3046\u3002\n\nKMS\n\u79d8\u5bc6\u306b\u3057\u306a\u3051\u308c\u3070\u306a\u3089\u306a\u3044client_secret\u306a\u3069\u3092\u8f09\u305b\u308b\u3088\u3046\u306b\u306a\u308b\u306e\u3067\u3001github\u306b\u4e0a\u3052\u308b\u3053\u3068\u3092\u8003\u3048\u3066\u3001KMS\u3067\u6697\u53f7\u5316\u3057\u307e\u3059\u3002\n\nIAM\u304b\u3089[\u6697\u53f7\u5316\u30ad\u30fc]\u306e[\u30ad\u30fc\u306e\u4f5c\u6210]\n\u30a8\u30a4\u30ea\u30a2\u30b9\u540d\u306b\u9069\u5f53\u306a\u540d\u524d\uff08\u4eca\u56de\u306f slack \u3068\u3057\u307e\u3059\uff09\u3092\u4e0e\u3048\u3066\u300c\u6b21\u306e\u30b9\u30c6\u30c3\u30d7\u300d\n\u30ad\u30fc\u7ba1\u7406\u30a2\u30af\u30bb\u30b9\u8a31\u53ef\u306b\u3001\u30b3\u30de\u30f3\u30c9\u30e9\u30a4\u30f3\u3067\u4f7f\u3063\u3066\u3044\u308bcredential\u306e\u3082\u306e\u3092\u9078\u629e\u3057\u3066\u300c\u6b21\u306e\u30b9\u30c6\u30c3\u30d7\n\u30ad\u30fc\u306e\u4f7f\u7528\u30a2\u30af\u30bb\u30b9\u8a31\u53ef\u306f\u4e00\u65e6\u98db\u3070\u3057\u3066\u300c\u6b21\u306e\u30b9\u30c6\u30c3\u30d7\u300d\n\u300c\u5b8c\u4e86\u300d\n\n\u30b3\u30f3\u30bd\u30fc\u30eb\u304caws credentials\u304c\u4f5c\u6210\u3057\u305fKMS\u306b\u30a2\u30af\u30bb\u30b9\u3067\u304d\u308b\u3082\u306e\u306a\u3089\u3001\u4e0b\u8a18\u306e\u30b3\u30de\u30f3\u30c9\u3067\u6697\u53f7\u5316\u3055\u308c\u305f\u30c6\u30ad\u30b9\u30c8\u304c\u53d6\u5f97\u3067\u304d\u308b\u306f\u305a\u3067\u3059\u3002\naws kms encrypt --key-id alias/slack --plaintext \"\u6697\u53f7\u5316\u3057\u305f\u3044\u30c6\u30ad\u30b9\u30c8\" --query CiphertextBlob --output text\n\n\u3053\u308c\u3067client_id\u3068client_secret\u306e\u6697\u53f7\u5316\u30c6\u30ad\u30b9\u30c8\u3092\u4f5c\u308a\u307e\u3059\u3002\nlambda function\u304ckms\u306e\u30ad\u30fc\u3092\u8aad\u307f\u53d6\u308c\u306a\u3044\u3068\u3044\u3051\u306a\u3044\u306e\u3067\u3001\u4f5c\u6210\u3055\u308c\u305fIAM\u306e\u30dd\u30ea\u30b7\u30fc\u306bkms:Decrypt\u3092\u8ffd\u52a0\u3057\u307e\u3059\u3002apex\u3067\u767b\u9332\u3057\u305flambda\u304c\u4f7f\u3046IAM\u306fproject.json\u306b\u8a18\u8f09\u3055\u308c\u3066\u3044\u307e\u3059\u3002\nfunction\u3054\u3068\u306bIAM\u3092\u5909\u3048\u3089\u308c\u308b\u306e\u3067\u6a29\u9650\u3092\u7d5e\u308c\u307e\u3059\u304c\u3001\u3069\u3046\u305b\u5168\u4f53\u3067\u4f7f\u3046\u306e\u3067\u624b\u629c\u304d\u3067\u3059\u3002\n\u3055\u3089\u306b\u3001key\u3092\u9650\u5b9a\u3057\u305f\u3044\u5834\u5408\u306fResouce\u3092\u3061\u3083\u3093\u3068\u6307\u5b9a\u3057\u307e\u3057\u3087\u3046\u3002\n{\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [\n        {\n            \"Action\": [\n                \"logs:*\"\n            ],\n            \"Effect\": \"Allow\",\n            \"Resource\": \"*\"\n        },\n        {\n            \"Effect\": \"Allow\",\n            \"Action\": [\n                \"kms:Decrypt\"\n            ],\n            \"Resource\": \"*\"\n        }\n    ]\n}\n\n\nlambda\u306e\u914d\u7f6e\n\u6697\u53f7\u5316\u3057\u305f\u30c6\u30ad\u30b9\u30c8\u306f\u4e0b\u8a18\u306e\u3088\u3046\u306bproject.json\u306e\u74b0\u5883\u306b\u3044\u308c\u3066\u3057\u307e\u3044\u307e\u3059\u3002\u3053\u308c\u3092lambda\u306e\u30b3\u30fc\u30c9\u306e\u306a\u304b\u3067kms\u3092\u547c\u3093\u3067\u5fa9\u53f7\u3059\u308c\u3070\u3082\u3068\u306eclient_id\u3068client_secret\u304c\u547c\u51fa\u305b\u307e\u3059\u3002\n\nproject.json\n{\n  \"name\": \"commands\",\n  \"description\": \"slack commands\",\n  \"memory\": 128,\n  \"timeout\": 5,\n  \"role\": \"arn:aws:iam::account-id:role/slack-commands_lambda_function\",\n  \"environment\": {\n    \"ENCRYPTED_CLIENT_ID\": \"\u6697\u53f7\u5316\u3057\u305fclient_id\",\n    \"ENCRYPTED_CLIENT_SECRET\": \"\u6697\u53f7\u5316\u3057\u305fclient_secret\"\n  }\n}\n\n\nlambda\u306e\u51e6\u7406\u306f\u3001javascript\u82e6\u624b\u3067node\u304c\u3055\u3063\u3071\u308a\u306a\u306e\u3067\u5168\u90e8python\u3067\u884c\u304d\u307e\u3059\u3002\nfunctions/callback/ \u3092\u4f5c\u6210\u3057\u3066\u3001main.py\u3092\u914d\u7f6e\u3057\u307e\u3059\u3002\u4e00\u5fdc\u5168\u4f53\u516c\u958b\u3055\u308c\u308b\u306e\u3067\u4f59\u8a08\u306aexception\u3092\u8fd4\u3055\u306a\u3044\u3053\u3068\u3092\u76ee\u7684\u3068\u3057\u3066\u307e\u3059\u3002\nGET\u3055\u308c\u305f\u6587\u5b57\u5217\u306f\u30de\u30c3\u30d4\u30f3\u30b0\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u306b\u5f93\u3063\u3066\u3001event\u306eparams->querystring\u5185\u306b\u5165\u3063\u3066\u3044\u308b\u306e\u3067\u305d\u3053\u304b\u3089\u5024\u3092\u53d6\u308a\u51fa\u3057\u307e\u3059\u3002\nslack\u304c\u9001\u3063\u3066\u304f\u308bquery\u306b\u3064\u3044\u3066\u306f\u4e0b\u8a18\u3092\u53c2\u7167\u3057\u3066\u304f\u3060\u3055\u3044\u3002\nhttps://api.slack.com/docs/oauth\n\nmain.py\nimport logging\nimport json\nimport os\nimport boto3\nimport requests\nfrom base64 import b64decode\n\nlogger = logging.getLogger()\nlogger.setLevel(logging.INFO)\n\ndef handle(event, context):\n    try:\n        kms = boto3.client('kms')\n        client_id = kms.decrypt(CiphertextBlob = b64decode(os.environ[\"ENCRYPTED_CLIENT_ID\"]))['Plaintext']\n        client_secret = kms.decrypt(CiphertextBlob = b64decode(os.environ[\"ENCRYPTED_CLIENT_SECRET\"]))['Plaintext']\n    except:\n        logger.error(\"required environments not found\")\n        return {\"text\": \"error\"}\n\n    try:\n        code = event['params']['querystring']['code']\n    except:\n        logger.error(\"code not found\")\n        return {\"text\": \"error\"}\n\n    try:\n        response = requests.get(\n          'https://slack.com/api/oauth.access',\n          params={'client_id': client_id, 'client_secret': client_secret, 'code': code})\n    except:\n        logger.error(\"oauth request error. response: %s\", response.json())\n        return {\"text\": \"error\"}\n    logger.info(response.json())\n    return { \"text\": \"ok\" }\n\n\n\u307e\u305f\u3001python\u3092apex\u3067\u30c7\u30d7\u30ed\u30a4\u3059\u308b\u5834\u5408\u306b\u306f\u3001requirements.txt\u3067\u5fc5\u8981\u306amodule\u3092\u8a18\u8f09\u3057\u3001function.json\u306ehook\u3067\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3066\u3084\u308a\u307e\u3059\u3002\u3064\u3044\u3067\u306b.apexignore\u3067\u4f59\u5206\u306a\u30d5\u30a1\u30a4\u30eb\u3092\u914d\u7f6e\u3057\u306a\u3044\u3088\u3046\u306b\u3067\u304d\u307e\u3059\u3002\n\nfunctions/callback/requirements.txt\nboto3\nrequests\n\n\n\nfunctions/callback/function.json\n{\n  \"description\": \"oauth callback\",\n  \"hooks\":{\n    \"build\": \"pip install -r requirements.txt -t .\"\n  }\n}\n\n\n\nfunctions/callback/.apexignore\n*.dist-info/\n\n\n\u6700\u5f8c\u306bcallback\u3092\u30c7\u30d7\u30ed\u30a4\u3057\u307e\u3059\u3002\napex deploy callback\n\n\u3059\u308b\u3068lambda\u306bcommands_callback\u304c\u914d\u7f6e\u3055\u308c\u308b\u306f\u305a\u3067\u3059\u3002\n\nIAM \u3067 KMS\u306e\u6a29\u9650\u3092\u8ffd\u52a0\nlambda\u304cKMS\u306e\u30ad\u30fc\u3092\u8aad\u307f\u53d6\u308b\u5fc5\u8981\u304c\u3042\u308b\u306e\u3067\u6a29\u9650\u3092\u8ffd\u52a0\u3057\u307e\u3059\u3002\n\u518d\u5ea6IAM\u306e[\u6697\u53f7\u5316\u30ad\u30fc]\u753b\u9762\u304b\u3089\u30ad\u30fc\u30e6\u30fc\u30b6\u306e[\u8ffd\u52a0]\n\nlambda\u304c\u4f7f\u3063\u3066\u3044\u308bIAM\u306e\u30ed\u30fc\u30eb(\u4eca\u56de\u306fcommands_lambda_function)\u3092\u9078\u629e\u3057\u3066[\u8ffd\u52a0]\n\n\u3053\u308c\u3067lambda\u304c\u3053\u306ekms\u306e\u30ad\u30fc\u3092\u8aad\u307f\u53d6\u308c\u307e\u3059\u3002\n\u4eca\u56de\u306f\u30d7\u30e9\u30a4\u30d9\u30fc\u30c8\u3067\u3057\u304b\u4f7f\u308f\u306a\u3044\u306e\u3067\u3084\u3063\u3066\u3044\u307e\u305b\u3093\u304c\u3001lambda\u306efunction\u3054\u3068\u306b\u7570\u306a\u308bIAM\u3092\u8a2d\u5b9a\u3059\u308b\u3053\u3068\u306f\u53ef\u80fd\u3067\u3059\u3002\u5404function\u306efunction.json\u3067role\u3092\u6307\u5b9a\u3067\u304d\u307e\u3059\u3002\n\napi gateway\n\n\u65b0\u898f\u306a\u3089[\u4eca\u3059\u3050\u59cb\u3081\u308b]\u3001\u65e2\u306b\u4f7f\u3063\u3066\u3044\u308b\u306a\u3089\u4e00\u89a7\u753b\u9762\u304b\u3089[API\u306e\u4f5c\u6210]\n\n\n\nAPI\u540d\u306b\u9069\u5f53\u306a\u540d\u524d\u3092\u3044\u308c\u3066(\u3053\u3053\u3067\u306fcommands)\u3001[API\u306e\u4f5c\u6210]\n\n\n\n[\u30a2\u30af\u30b7\u30e7\u30f3] -> [\u30ea\u30bd\u30fc\u30b9\u306e\u4f5c\u6210]\n\n\n\n\u30ea\u30bd\u30fc\u30b9\u540d\u306b callback \u3092\u3044\u308c\u3066 [\u30ea\u30bd\u30fc\u30b9\u306e\u4f5c\u6210]\n\n\n\n[\u30a2\u30af\u30b7\u30e7\u30f3] -> [\u30e1\u30bd\u30c3\u30c9\u306e\u4f5c\u6210] -> GET\u3092\u9078\u3093\u3067\u30c1\u30a7\u30c3\u30af\u3092\u30af\u30ea\u30c3\u30af\n\n\n\n\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u753b\u9762\u306b\u306a\u308b\u306e\u3067\u3001\u5148\u307b\u3069\u4f5c\u6210\u3057\u305flambda\u3092\u9078\u3093\u3067[\u4fdd\u5b58]\n\n\n\n\u6a29\u9650\u8a31\u53ef\u78ba\u8a8d\u753b\u9762\u304c\u3067\u308b\u306e\u3067[OK]\n\n\n\n\u30e1\u30bd\u30c3\u30c9\u306e\u5b9f\u884c\u753b\u9762\u3067[\u7d71\u5408\u30ea\u30af\u30a8\u30b9\u30c8]\u3092\u9078\u629e\n\n\n\n[\u672c\u6587\u30de\u30c3\u30d4\u30f3\u30b0\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8]\u3092\u30af\u30ea\u30c3\u30af\u3057\u3066\u8a73\u7d30\u3092\u51fa\u3057\u3066\u304b\u3089\u3001[\u30de\u30c3\u30d4\u30f3\u30b0\u30c6\u30f3\u30d7\u30ec\u30fc\u3068\u306e\u8ffd\u52a0] -> application/json \u3092\u5165\u529b\u3057\u3066\u30c1\u30a7\u30c3\u30af\u3092\u30af\u30ea\u30c3\u30af\n\n\n\n\u30d1\u30b9\u30b9\u30eb\u30fc\u52d5\u4f5c\u306e\u5909\u66f4\u753b\u9762\u304c\u3067\u308b\u306e\u3067 [\u306f\u3044\u3001\u3053\u306e\u7d71\u5408\u3092\u4fdd\u8b77\u3057\u307e\u3059]\n\n\n\nGET\u306e\u4e2d\u8eab\u304c\u6b32\u3057\u3044\u3060\u3051\u306a\u306e\u3067\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u306e\u751f\u6210:\u3067[\u30e1\u30bd\u30c3\u30c9\u30ea\u30af\u30a8\u30b9\u30c8\u306e\u30d1\u30b9\u30b9\u30eb\u30fc]\u3092\u9078\u3093\u3067[\u4fdd\u5b58]\n\n\n\nAPI gateway\u306f\u30c7\u30d7\u30ed\u30a4\u3057\u306a\u3044\u3068\u53cd\u6620\u3055\u308c\u306a\u3044\u306e\u3067[\u30a2\u30af\u30b7\u30e7\u30f3] -> [API\u306e\u30c7\u30d7\u30ed\u30a4] -> API\u306e\u30c7\u30d7\u30ed\u30a4\u30a6\u30a3\u30f3\u30c9\u30a6\u304c\u3067\u308b\u306e\u3067\u3001\u30c7\u30d7\u30ed\u30a4\u3055\u308c\u308b\u30b9\u30c6\u30fc\u30b8\u304b\u3089[\u65b0\u3057\u3044\u30b9\u30c6\u30fc\u30b8]\u3001\u30b9\u30c6\u30fc\u30b8\u540d\u3092\u9069\u5f53\u306b\uff08\u3053\u308c\u306fAPI gateway\u306eURL\u306b\u542b\u307e\u308c\u307e\u3059\u3002\u3053\u3053\u3067\u306fprod\uff09\u3044\u308c\u3066[\u30c7\u30d7\u30ed\u30a4]\n\n\n\u30b9\u30c6\u30fc\u30b8\u3067URL\u306e\u547c\u3073\u51fa\u3057:\u3067\u793a\u3055\u308c\u308bURL\u3092\u53d6\u3063\u3066\u304a\u304d\u307e\u3059\u3002\n\n\noauth\n\u307e\u305a\u306f\u3001slack app\u306e\u30da\u30fc\u30b8\u306e[OAuth & Permissions] \u753b\u9762\u3067\u3001RedirectURL\u306bAPI Gateway\u3067\u4f5c\u3063\u305f\u547c\u3073\u51fa\u3057\u306eURL\u3092\u5165\u308c[Save Changes]\u3057\u307e\u3059\u3002\n\n\u305d\u306e\u5f8c\u3001\u30d6\u30e9\u30a6\u30b6\u3067\u3044\u3044\u306e\u3067\u4e0b\u8a18\u3092\u958b\u304d\u307e\u3059\u3002\nhttps://slack.com/oauth/authorize?scope=commands&client_id=\u30af\u30e9\u30a4\u30a2\u30f3\u30c8ID\nscope\u306f\u5fc5\u8981\u306a\u6a29\u9650\u3092\u5165\u308c\u3066\u304f\u3060\u3055\u3044\u3002\u3053\u3053\u3067\u306f\u3001\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3067\u304d\u308bcommands\u3092\u8a31\u53ef\u3057\u3066\u307e\u3059\u3002\noauth\u306escope\u4e00\u89a7\u306f\u4e0b\u8a18\u3067\u3059\u3002\nhttps://api.slack.com/docs/oauth-scopes\n\u30af\u30e9\u30a4\u30a2\u30f3\u30c8ID\u306fslack app\u753b\u9762\u306eclient_id\u3068\u3057\u3066\u3001\u3053\u306eURL\u3092\u30d6\u30e9\u30a6\u30b6\u3067\u3044\u3044\u306e\u3067\u76f4\u63a5\u9077\u79fb\u3059\u308b\u3068\u4e0b\u8a18\u306e\u3088\u3046\u306a\u753b\u9762\u306b\u884c\u304f\u306f\u305a\u3067\u3059\u3002\n\n[Authorize]\u3059\u308b\u3068\u3001\u5148\u307b\u3069\u306ecallback URL\u306b\u9077\u79fb\u3057\u307e\u3059\u3002\u3046\u307e\u304f\u3044\u3063\u3066\u3044\u308c\u3070\n{\"text\":\"ok\"} \u3068\u3060\u3051\u8868\u793a\u3055\u308c\u308b\u306f\u305a\u3067\u3059\u3002\napex logs callback\n\n\u3092\u53e9\u3044\u3066\u30ed\u30b0\u78ba\u8a8d\u3057\u307e\u3059\u3002\u5931\u6557\u3057\u3066\u3044\u308b\u5834\u5408\u3067\u3082\u3053\u308c\u3067\u306a\u305c\u5931\u6557\u3057\u305f\u304b\u3092\u78ba\u8a8d\u3057\u3066\u4fee\u6b63\u3057\u307e\u3059\u3002\n\u305d\u3082\u305d\u3082\u30ed\u30b0\u3067\u3066\u3044\u306a\u3044\u5834\u5408\u3001API Gateway\u304b\u3089lambda\u304c\u547c\u3070\u308c\u3066\u3044\u306a\u3044\u306e\u3067API Gateway\u306e\u8a2d\u5b9a\u3092\u898b\u76f4\u3057\u307e\u3057\u3087\u3046\u3002\n\u3046\u307e\u304f\u3044\u3063\u3066\u3044\u308c\u3070\u3001\u30ed\u30b0\u304b\u3089access_token\u304c\u3082\u3089\u3048\u3066\u3044\u308b\u306f\u305a\u3067\u3059\u3002bot\u3084incoming-webhook\u3092\u6709\u52b9\u306b\u3057\u3066\u3044\u308c\u3070\u305d\u308c\u3089\u3082\u542b\u307e\u308c\u3066\u3044\u307e\u3059\u3002\n\u3053\u308c\u3089\u3082\u6697\u53f7\u5316\u3057\u3066project.json\u306b\u653e\u308a\u8fbc\u307f\u307e\u3059\u3002\n\u4ed6\u306eslack\u30c1\u30fc\u30e0\u3067\u4f7f\u3046\u308f\u3051\u3067\u3082\u306a\u3044\u5834\u5408\u306f\u3001callback\u3092API Gateway\u304b\u3089\u524a\u9664\u3057\u3066\u3057\u307e\u3063\u3066\u3082\u3044\u3044\u3067\u3057\u3087\u3046\u3002\n\u3053\u308c\u3067slack app\u306e\u767b\u9332\u306e\u5b8c\u4e86\u3067\u3059\u3002\n\u6b21\u3067slash command\u3068interactive message\u3092\u767b\u9332\u3057\u307e\u3059\u3002\n\nTIPS\n\nincoming-webhook\u306ekms\nincoming-webhook\u3092\u4f7f\u3046\u5834\u5408\u3001\u4f7f\u3046\u6587\u5b57\u5217\u306f https:// \u3067\u59cb\u307e\u308a\u307e\u3059\u304c\u3001aws\u30b3\u30de\u30f3\u30c9\u3067file:// \u3084 http:// \u306a\u3069\u3067\u59cb\u307e\u308b\u6587\u5b57\u5217\u306e\u5834\u5408\u306f\u554f\u7b54\u7121\u7528\u3067\u3001\u305d\u306e\u30d5\u30a1\u30a4\u30eb\u3084URL\u3092\u53c2\u7167\u3057\u306b\u3044\u304f\u306e\u3067\u3001\u4e00\u65e6\u30d5\u30a1\u30a4\u30eb\u306b\u30c6\u30ad\u30b9\u30c8\u3092\u4fdd\u5b58\u3057\u3066\u6697\u53f7\u5316\u3057\u307e\u3059\u3002\n\u30ab\u30ec\u30f3\u30c8\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306etmp\u306b\u30c6\u30ad\u30b9\u30c8\u3092\u5165\u308c\u305f\u3068\u3057\u3066\n\naws kms encrypt --key-id alias/slack --plaintex file://./tmp\n\n\n.gitignore\nroot\u306b\u8a00\u8a9e\u306e.gitignore\u3001python\u306e\u5834\u5408\u306f\u53d6\u5f97\u3057\u305f\u30e2\u30b8\u30e5\u30fc\u30eb\u304c\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306b\u7f6e\u304b\u308c\u308b\u306e\u3067function\u3054\u3068\u306b.gitignore\u3057\u3066\u307e\u3059\u3002\n\n.gitignore\n.Python\nbuild/\ndevelop-eggs/\ndist/\neggs/\n.eggs/\nparts/\nsdist/\n*.egg-info/\n*.dist-info/\n.installed.cfg\n*.egg\n\n\n\nfunctions/callback/.gitignore\nboto3/\nbotocore/\ns3transfer/\nrequests/\njmespath/\ndocutils/\ndateutil/\nsix.py\n\n\n# API Gateway + Lambda \u3067 slack app\n\n## slack app\n\nslack app\u3068\u306fbot\u3084commands\u306a\u3069\u306e\u96c6\u5408\u4f53\u3067\u3001\u3053\u308c\u3092\u767b\u9332\u3059\u308c\u3070\u3001app\u306b\u542b\u307e\u308c\u3066\u3044\u308bbot\u3084commands\u304c\u4f7f\u3048\u308b\u3088\u3046\u306b\u306a\u308b\u3082\u306e\u3067\u3059\u3002\n\ntoken\u304c\u4e00\u610f\u3067\u6e08\u3080\u306e\u3068\u3001interactive message\n\nhttps://api.slack.com/docs/message-buttons\n\n\u3092\u4f7f\u3046\u3053\u3068\u304c\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\u3053\u308c\u3092\u4f7f\u3046\u3053\u3068\u3067\u3001interactive\u306b\u64cd\u4f5c\u3092\u9032\u3081\u308b\u3053\u3068\u304c\u53ef\u80fd\u3067\u3059\u3002\nslack app\u306b\u3064\u3044\u3066\u8a73\u3057\u304f\u306f\u4e0b\u8a18\u3092\u53c2\u7167\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\nhttps://api.slack.com/slack-apps\n\n\u4f5c\u6210\u3057\u305fslack app\u306f\u5168\u4f53\u306b\u516c\u958b\u3059\u308b\u3053\u3068\u3082\u3067\u304d\u307e\u3059\u3002\u304c\u3001\u4eca\u56de\u306f\u5b8c\u5168\u306bprivate\u76ee\u7684\u306a\u306e\u3067\u81ea\u30c1\u30fc\u30e0\u306b\u3060\u3051\u767b\u9332\u3057\u3066\u5229\u7528\u3057\u307e\u3059\u3002\n\n## api gateway + Lambda\n\nAPI Gateway + Lambda\u3068\u3059\u308b\u306e\u306f\u3001\u5e38\u306b\u8d77\u52d5\u3057\u3066\u3044\u308b\u5fc5\u8981\u304c\u306a\u3044\u304b\u3089\u30b5\u30fc\u30d0\u304c\u3044\u3089\u306a\u3044\u69cb\u6210\u306b\u3057\u305f\u3044\u305f\u3081\u3067\u3059\u3002\n\n\u3055\u3089\u306bslash commands\u3092\u4f7f\u3046\u5834\u5408\u3001bot\u3068\u9055\u3063\u3066slash commands\u3092\u5b9f\u884c\u3057\u305f\u6642\u3060\u3051\u547c\u3073\u51fa\u3055\u308c\u308b\u305f\u3081\u3001\u6599\u91d1\u7684\u306b\u3082\u5b89\u5fc3\u3067\u3059\u3002\n\n\n# \u5fc5\u8981\u306a\u3082\u306e\n\n* apex\n\nhttp://apex.run/\n\n\nlambda\u306e\u30c7\u30d7\u30ed\u30a4\u306b\u4f7f\u3044\u307e\u3059\u3002invoke\u3068logs\u304c\u4fbf\u5229\u3067\u3059\u3002\nterraform\u3068\u3082\u9023\u643a\u3067\u304d\u307e\u3059\u304c\u3001terraform\u3068api gateway + lambda\u306e\u9023\u643a\u304c\u3064\u3089\u3044\u306e\u3067\u4eca\u56de\u306f\u898b\u9001\u308a\u307e\u3057\u305f\u3002\n\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u306f\u3053\u308c\u3060\u3051\u3067\u3059\u3002\n\n```\ncurl https://raw.githubusercontent.com/apex/apex/master/install.sh | sh\n```\n\n* aws credentials\n\n`aws configure` \u3067\u30a2\u30af\u30bb\u30b9\u30ad\u30fc\u3068\u30b7\u30fc\u30af\u30ec\u30c3\u30c8\u30a2\u30af\u30bb\u30b9\u30ad\u30fc\u3092\u8a2d\u5b9a\u3057\u3066\u304a\u304d\u307e\u3059\u3002\napex\u304c\u30c7\u30d5\u30a9\u30eb\u30c8\u3060\u3068iam\u3082\u914d\u7f6e\u3059\u308b\u306e\u3067\u3001lambda\u3068iam\u95a2\u4fc2\u306e\u6a29\u9650\u304c\u306a\u3051\u308c\u3070\u306a\u308a\u307e\u305b\u3093\u3002\n\u307e\u305f\u3001token\u306a\u3069\u306e\u4fdd\u6301\u306bkms\u3092\u5229\u7528\u3059\u308b\u306e\u3067\u305d\u306e\u6a29\u9650\u3082\u5fc5\u8981\u3067\u3059\u3002\n\n\u8907\u6570credential\u3092\u6301\u3063\u3066\u3044\u308b\u5834\u5408\u306f\u3001apex\u306e\u8a2d\u5b9a\u304b\u3089profile\u6307\u5b9a\u3082\u3067\u304d\u307e\u3059\u3002\u8a73\u3057\u304f\u306f\u516c\u5f0f\u30da\u30fc\u30b8\u306b\u3002\n\n\n\n* slack\n\n\n# \u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n## apex\u3067lambda\u306e\u914d\u7f6e\n\n\u307e\u305a\u306f\u7a7a\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3067\n\n```\napex init\n```\n\u3092\u3059\u308b\u3053\u3068\u3067\u3001apex\u306e\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u30d5\u30a1\u30a4\u30eb\u3001apex\u304c\u5229\u7528\u3059\u308bIAM\u306e\u4f5c\u6210\u304c\u884c\u308f\u308c\u307e\u3059\u3002\nproject name\u306f\u3053\u3053\u3067\u306f`commands`\u3068\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\napex\u306b\u6163\u308c\u3066\u304a\u304d\u305f\u3044\u5834\u5408\u306b\u306f\u516c\u5f0f\u306eGetting started\u306b\u3057\u305f\u304c\u3063\u3066\u3001hello\u3092\u914d\u7f6e\u3057\u3066\u307f\u308b\u3068\u3044\u3044\u3067\u3057\u3087\u3046\u3002\n\n## oauth callback\u306e\u4f5c\u6210\n\nslack app\u306e\u767b\u9332\u306boauth\u306ecallback\u304c\u5fc5\u8981\u3067\u3059\u3002\u624b\u3067\u3084\u308c\u306a\u3044\u3053\u3068\u3082\u306a\u3044\u3067\u3059\u304c\u3001\u305b\u3063\u304b\u304f\u306a\u306e\u3067\u3053\u308c\u3082api gateway + lambda\u3067\u51e6\u7406\u3057\u3066\u307f\u307e\u3059\u3002\n\n\n## slack app\u306e\u4f5c\u6210\n\nhttps://api.slack.com/apps\n\n[Create New App] \u304b\u3089\u65b0\u3057\u3044App\u3092\u4f5c\u308a\u307e\u3059\u3002 `I plan to submit this app the Slack App Directory` \u306f\u3053\u306e\u30a2\u30d7\u30ea\u3092\u516c\u958b\u3059\u308b\u5834\u5408\u306a\u306e\u3067\u4eca\u56de\u306f\u30c1\u30a7\u30c3\u30af\u306f\u4e0d\u8981\u3067\u3059\u3002\n\n![Slack_API__Applications___Slack.png](https://qiita-image-store.s3.amazonaws.com/0/63168/5d786a0c-7538-7a8d-115a-02802ba9139f.png)\n\n\u4f5c\u6210\u5f8c\u306b\u8868\u793a\u3055\u308c\u308bBasic Infomation\u306b\u3042\u308b`client_id`\u3068`client_secret`\u3092\u63a7\u3048\u3066\u304a\u304d\u307e\u3059\u3002\n\u307e\u305f\u3001\u3053\u3053\u3067\u5909\u66f4\u3067\u304d\u308bicon\u306f\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3057\u305f\u6642\u306b\u8868\u793a\u3055\u308c\u308b\u3082\u306e\u306a\u306e\u3067\u3001\u76ee\u7684\u306b\u5fdc\u3058\u305f\u3082\u306e\u306b\u5909\u3048\u308b\u3068\u3044\u3044\u3067\u3057\u3087\u3046\u3002\n\n## KMS\n\n\u79d8\u5bc6\u306b\u3057\u306a\u3051\u308c\u3070\u306a\u3089\u306a\u3044client_secret\u306a\u3069\u3092\u8f09\u305b\u308b\u3088\u3046\u306b\u306a\u308b\u306e\u3067\u3001github\u306b\u4e0a\u3052\u308b\u3053\u3068\u3092\u8003\u3048\u3066\u3001KMS\u3067\u6697\u53f7\u5316\u3057\u307e\u3059\u3002\n\n1. IAM\u304b\u3089[\u6697\u53f7\u5316\u30ad\u30fc]\u306e[\u30ad\u30fc\u306e\u4f5c\u6210]\n2. \u30a8\u30a4\u30ea\u30a2\u30b9\u540d\u306b\u9069\u5f53\u306a\u540d\u524d\uff08\u4eca\u56de\u306f `slack` \u3068\u3057\u307e\u3059\uff09\u3092\u4e0e\u3048\u3066\u300c\u6b21\u306e\u30b9\u30c6\u30c3\u30d7\u300d\n3. \u30ad\u30fc\u7ba1\u7406\u30a2\u30af\u30bb\u30b9\u8a31\u53ef\u306b\u3001\u30b3\u30de\u30f3\u30c9\u30e9\u30a4\u30f3\u3067\u4f7f\u3063\u3066\u3044\u308bcredential\u306e\u3082\u306e\u3092\u9078\u629e\u3057\u3066\u300c\u6b21\u306e\u30b9\u30c6\u30c3\u30d7\n4. \u30ad\u30fc\u306e\u4f7f\u7528\u30a2\u30af\u30bb\u30b9\u8a31\u53ef\u306f\u4e00\u65e6\u98db\u3070\u3057\u3066\u300c\u6b21\u306e\u30b9\u30c6\u30c3\u30d7\u300d\n5. \u300c\u5b8c\u4e86\u300d\n\n\u30b3\u30f3\u30bd\u30fc\u30eb\u304caws credentials\u304c\u4f5c\u6210\u3057\u305fKMS\u306b\u30a2\u30af\u30bb\u30b9\u3067\u304d\u308b\u3082\u306e\u306a\u3089\u3001\u4e0b\u8a18\u306e\u30b3\u30de\u30f3\u30c9\u3067\u6697\u53f7\u5316\u3055\u308c\u305f\u30c6\u30ad\u30b9\u30c8\u304c\u53d6\u5f97\u3067\u304d\u308b\u306f\u305a\u3067\u3059\u3002\n\n```\naws kms encrypt --key-id alias/slack --plaintext \"\u6697\u53f7\u5316\u3057\u305f\u3044\u30c6\u30ad\u30b9\u30c8\" --query CiphertextBlob --output text\n```\n\n\u3053\u308c\u3067`client_id`\u3068`client_secret`\u306e\u6697\u53f7\u5316\u30c6\u30ad\u30b9\u30c8\u3092\u4f5c\u308a\u307e\u3059\u3002\n\nlambda function\u304ckms\u306e\u30ad\u30fc\u3092\u8aad\u307f\u53d6\u308c\u306a\u3044\u3068\u3044\u3051\u306a\u3044\u306e\u3067\u3001\u4f5c\u6210\u3055\u308c\u305fIAM\u306e\u30dd\u30ea\u30b7\u30fc\u306b`kms:Decrypt`\u3092\u8ffd\u52a0\u3057\u307e\u3059\u3002apex\u3067\u767b\u9332\u3057\u305flambda\u304c\u4f7f\u3046IAM\u306f`project.json`\u306b\u8a18\u8f09\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n\nfunction\u3054\u3068\u306bIAM\u3092\u5909\u3048\u3089\u308c\u308b\u306e\u3067\u6a29\u9650\u3092\u7d5e\u308c\u307e\u3059\u304c\u3001\u3069\u3046\u305b\u5168\u4f53\u3067\u4f7f\u3046\u306e\u3067\u624b\u629c\u304d\u3067\u3059\u3002\n\u3055\u3089\u306b\u3001key\u3092\u9650\u5b9a\u3057\u305f\u3044\u5834\u5408\u306f`Resouce`\u3092\u3061\u3083\u3093\u3068\u6307\u5b9a\u3057\u307e\u3057\u3087\u3046\u3002\n\n```json\n{\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [\n        {\n            \"Action\": [\n                \"logs:*\"\n            ],\n            \"Effect\": \"Allow\",\n            \"Resource\": \"*\"\n        },\n        {\n            \"Effect\": \"Allow\",\n            \"Action\": [\n                \"kms:Decrypt\"\n            ],\n            \"Resource\": \"*\"\n        }\n    ]\n}\n```\n\n## lambda\u306e\u914d\u7f6e\n\n\u6697\u53f7\u5316\u3057\u305f\u30c6\u30ad\u30b9\u30c8\u306f\u4e0b\u8a18\u306e\u3088\u3046\u306bproject.json\u306e\u74b0\u5883\u306b\u3044\u308c\u3066\u3057\u307e\u3044\u307e\u3059\u3002\u3053\u308c\u3092lambda\u306e\u30b3\u30fc\u30c9\u306e\u306a\u304b\u3067kms\u3092\u547c\u3093\u3067\u5fa9\u53f7\u3059\u308c\u3070\u3082\u3068\u306e`client_id`\u3068`client_secret`\u304c\u547c\u51fa\u305b\u307e\u3059\u3002\n\n```json:project.json\n{\n  \"name\": \"commands\",\n  \"description\": \"slack commands\",\n  \"memory\": 128,\n  \"timeout\": 5,\n  \"role\": \"arn:aws:iam::account-id:role/slack-commands_lambda_function\",\n  \"environment\": {\n    \"ENCRYPTED_CLIENT_ID\": \"\u6697\u53f7\u5316\u3057\u305fclient_id\",\n    \"ENCRYPTED_CLIENT_SECRET\": \"\u6697\u53f7\u5316\u3057\u305fclient_secret\"\n  }\n}\n```\n\nlambda\u306e\u51e6\u7406\u306f\u3001javascript\u82e6\u624b\u3067node\u304c\u3055\u3063\u3071\u308a\u306a\u306e\u3067\u5168\u90e8python\u3067\u884c\u304d\u307e\u3059\u3002\n\n\n`functions/callback/` \u3092\u4f5c\u6210\u3057\u3066\u3001`main.py`\u3092\u914d\u7f6e\u3057\u307e\u3059\u3002\u4e00\u5fdc\u5168\u4f53\u516c\u958b\u3055\u308c\u308b\u306e\u3067\u4f59\u8a08\u306aexception\u3092\u8fd4\u3055\u306a\u3044\u3053\u3068\u3092\u76ee\u7684\u3068\u3057\u3066\u307e\u3059\u3002\n\nGET\u3055\u308c\u305f\u6587\u5b57\u5217\u306f\u30de\u30c3\u30d4\u30f3\u30b0\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u306b\u5f93\u3063\u3066\u3001`event`\u306e`params`->`querystring`\u5185\u306b\u5165\u3063\u3066\u3044\u308b\u306e\u3067\u305d\u3053\u304b\u3089\u5024\u3092\u53d6\u308a\u51fa\u3057\u307e\u3059\u3002\n\nslack\u304c\u9001\u3063\u3066\u304f\u308bquery\u306b\u3064\u3044\u3066\u306f\u4e0b\u8a18\u3092\u53c2\u7167\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\nhttps://api.slack.com/docs/oauth\n\n\n\n```python:main.py\nimport logging\nimport json\nimport os\nimport boto3\nimport requests\nfrom base64 import b64decode\n\nlogger = logging.getLogger()\nlogger.setLevel(logging.INFO)\n\ndef handle(event, context):\n    try:\n        kms = boto3.client('kms')\n        client_id = kms.decrypt(CiphertextBlob = b64decode(os.environ[\"ENCRYPTED_CLIENT_ID\"]))['Plaintext']\n        client_secret = kms.decrypt(CiphertextBlob = b64decode(os.environ[\"ENCRYPTED_CLIENT_SECRET\"]))['Plaintext']\n    except:\n        logger.error(\"required environments not found\")\n        return {\"text\": \"error\"}\n\n    try:\n        code = event['params']['querystring']['code']\n    except:\n        logger.error(\"code not found\")\n        return {\"text\": \"error\"}\n\n    try:\n        response = requests.get(\n          'https://slack.com/api/oauth.access',\n          params={'client_id': client_id, 'client_secret': client_secret, 'code': code})\n    except:\n        logger.error(\"oauth request error. response: %s\", response.json())\n        return {\"text\": \"error\"}\n    logger.info(response.json())\n    return { \"text\": \"ok\" }\n```\n\n\u307e\u305f\u3001python\u3092apex\u3067\u30c7\u30d7\u30ed\u30a4\u3059\u308b\u5834\u5408\u306b\u306f\u3001`requirements.txt`\u3067\u5fc5\u8981\u306amodule\u3092\u8a18\u8f09\u3057\u3001`function.json`\u306ehook\u3067\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3066\u3084\u308a\u307e\u3059\u3002\u3064\u3044\u3067\u306b`.apexignore`\u3067\u4f59\u5206\u306a\u30d5\u30a1\u30a4\u30eb\u3092\u914d\u7f6e\u3057\u306a\u3044\u3088\u3046\u306b\u3067\u304d\u307e\u3059\u3002\n\n```:functions/callback/requirements.txt\nboto3\nrequests\n```\n```json:functions/callback/function.json\n{\n  \"description\": \"oauth callback\",\n  \"hooks\":{\n    \"build\": \"pip install -r requirements.txt -t .\"\n  }\n}\n```\n```:functions/callback/.apexignore\n*.dist-info/\n```\n\n\u6700\u5f8c\u306bcallback\u3092\u30c7\u30d7\u30ed\u30a4\u3057\u307e\u3059\u3002\n\n```\napex deploy callback\n```\n\u3059\u308b\u3068lambda\u306b`commands_callback`\u304c\u914d\u7f6e\u3055\u308c\u308b\u306f\u305a\u3067\u3059\u3002\n\n\n## IAM \u3067 KMS\u306e\u6a29\u9650\u3092\u8ffd\u52a0\n\nlambda\u304cKMS\u306e\u30ad\u30fc\u3092\u8aad\u307f\u53d6\u308b\u5fc5\u8981\u304c\u3042\u308b\u306e\u3067\u6a29\u9650\u3092\u8ffd\u52a0\u3057\u307e\u3059\u3002\n\u518d\u5ea6IAM\u306e[\u6697\u53f7\u5316\u30ad\u30fc]\u753b\u9762\u304b\u3089\u30ad\u30fc\u30e6\u30fc\u30b6\u306e[\u8ffd\u52a0]\n\n![IAM_Management_Console.png](https://qiita-image-store.s3.amazonaws.com/0/63168/7228eba5-9a21-7eee-8156-6c4da1a8a26a.png)\n\nlambda\u304c\u4f7f\u3063\u3066\u3044\u308bIAM\u306e\u30ed\u30fc\u30eb(\u4eca\u56de\u306fcommands_lambda_function)\u3092\u9078\u629e\u3057\u3066[\u8ffd\u52a0]\n\n![IAM_Management_Console.png](https://qiita-image-store.s3.amazonaws.com/0/63168/96429812-fa84-c41c-8bf9-cb86c7ea538b.png)\n\n\u3053\u308c\u3067lambda\u304c\u3053\u306ekms\u306e\u30ad\u30fc\u3092\u8aad\u307f\u53d6\u308c\u307e\u3059\u3002\n\n\u4eca\u56de\u306f\u30d7\u30e9\u30a4\u30d9\u30fc\u30c8\u3067\u3057\u304b\u4f7f\u308f\u306a\u3044\u306e\u3067\u3084\u3063\u3066\u3044\u307e\u305b\u3093\u304c\u3001lambda\u306efunction\u3054\u3068\u306b\u7570\u306a\u308bIAM\u3092\u8a2d\u5b9a\u3059\u308b\u3053\u3068\u306f\u53ef\u80fd\u3067\u3059\u3002\u5404function\u306e`function.json`\u3067`role`\u3092\u6307\u5b9a\u3067\u304d\u307e\u3059\u3002\n\n## api gateway\n\n* \u65b0\u898f\u306a\u3089[\u4eca\u3059\u3050\u59cb\u3081\u308b]\u3001\u65e2\u306b\u4f7f\u3063\u3066\u3044\u308b\u306a\u3089\u4e00\u89a7\u753b\u9762\u304b\u3089[API\u306e\u4f5c\u6210]\n\n![API_Gateway.png](https://qiita-image-store.s3.amazonaws.com/0/63168/134d30bf-b0a2-b6f3-898e-40ea8aa2cfa3.png)\n\n* API\u540d\u306b\u9069\u5f53\u306a\u540d\u524d\u3092\u3044\u308c\u3066(\u3053\u3053\u3067\u306fcommands)\u3001[API\u306e\u4f5c\u6210]\n\n![API_Gateway_new.png](https://qiita-image-store.s3.amazonaws.com/0/63168/c30fd6a7-88f7-8cd9-e953-640e0d3c78eb.png)\n\n\n* [\u30a2\u30af\u30b7\u30e7\u30f3] -> [\u30ea\u30bd\u30fc\u30b9\u306e\u4f5c\u6210]\n\n![API_Gateway_new_method.png](https://qiita-image-store.s3.amazonaws.com/0/63168/80131f73-5668-9440-c463-8da760bd3c92.png)\n\n\n* \u30ea\u30bd\u30fc\u30b9\u540d\u306b `callback` \u3092\u3044\u308c\u3066 [\u30ea\u30bd\u30fc\u30b9\u306e\u4f5c\u6210]\n\n![API_Gateway_resource.png](https://qiita-image-store.s3.amazonaws.com/0/63168/7bbec1e0-5b53-24c2-700e-dc97bdc7dc1f.png)\n\n* [\u30a2\u30af\u30b7\u30e7\u30f3] -> [\u30e1\u30bd\u30c3\u30c9\u306e\u4f5c\u6210] -> GET\u3092\u9078\u3093\u3067\u30c1\u30a7\u30c3\u30af\u3092\u30af\u30ea\u30c3\u30af\n\n![API_Gateway_method_get.png](https://qiita-image-store.s3.amazonaws.com/0/63168/3a5452d3-5db2-b5df-ae10-df3f4e990a61.png)\n\n\n* \u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u753b\u9762\u306b\u306a\u308b\u306e\u3067\u3001\u5148\u307b\u3069\u4f5c\u6210\u3057\u305flambda\u3092\u9078\u3093\u3067[\u4fdd\u5b58]\n\n![API_Gateway_newmethod.png](https://qiita-image-store.s3.amazonaws.com/0/63168/99f717f3-b5bf-5f1e-afac-20e2bc494c4e.png)\n\n\n* \u6a29\u9650\u8a31\u53ef\u78ba\u8a8d\u753b\u9762\u304c\u3067\u308b\u306e\u3067[OK]\n\n![API_Gateway_resource3.png](https://qiita-image-store.s3.amazonaws.com/0/63168/acbf967f-dec5-685e-2f07-331968ebbde8.png)\n\n\n* \u30e1\u30bd\u30c3\u30c9\u306e\u5b9f\u884c\u753b\u9762\u3067[\u7d71\u5408\u30ea\u30af\u30a8\u30b9\u30c8]\u3092\u9078\u629e\n\n![API_Gateway_method_ex.png](https://qiita-image-store.s3.amazonaws.com/0/63168/d93b2a19-49cd-d8e0-fc8b-c24c0c9eab94.png)\n\n\n* [\u672c\u6587\u30de\u30c3\u30d4\u30f3\u30b0\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8]\u3092\u30af\u30ea\u30c3\u30af\u3057\u3066\u8a73\u7d30\u3092\u51fa\u3057\u3066\u304b\u3089\u3001[\u30de\u30c3\u30d4\u30f3\u30b0\u30c6\u30f3\u30d7\u30ec\u30fc\u3068\u306e\u8ffd\u52a0] -> `application/json` \u3092\u5165\u529b\u3057\u3066\u30c1\u30a7\u30c3\u30af\u3092\u30af\u30ea\u30c3\u30af\n\n![API_Gateway_mapping_template.png](https://qiita-image-store.s3.amazonaws.com/0/63168/89002ef8-ef7f-2f78-6069-f728b613138f.png)\n\n\n* \u30d1\u30b9\u30b9\u30eb\u30fc\u52d5\u4f5c\u306e\u5909\u66f4\u753b\u9762\u304c\u3067\u308b\u306e\u3067 [\u306f\u3044\u3001\u3053\u306e\u7d71\u5408\u3092\u4fdd\u8b77\u3057\u307e\u3059]\n\n![API_Gateway_paththrough.png](https://qiita-image-store.s3.amazonaws.com/0/63168/c0f2e97a-c8d8-74e0-da21-a6401aae4f59.png)\n\n* GET\u306e\u4e2d\u8eab\u304c\u6b32\u3057\u3044\u3060\u3051\u306a\u306e\u3067`\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u306e\u751f\u6210:`\u3067[\u30e1\u30bd\u30c3\u30c9\u30ea\u30af\u30a8\u30b9\u30c8\u306e\u30d1\u30b9\u30b9\u30eb\u30fc]\u3092\u9078\u3093\u3067[\u4fdd\u5b58]\n\n![API_Gateway_mappingtemplate2.png](https://qiita-image-store.s3.amazonaws.com/0/63168/364dd51c-3117-dbce-cbbf-2a2f00f221df.png)\n\n* API gateway\u306f\u30c7\u30d7\u30ed\u30a4\u3057\u306a\u3044\u3068\u53cd\u6620\u3055\u308c\u306a\u3044\u306e\u3067[\u30a2\u30af\u30b7\u30e7\u30f3] -> [API\u306e\u30c7\u30d7\u30ed\u30a4] -> API\u306e\u30c7\u30d7\u30ed\u30a4\u30a6\u30a3\u30f3\u30c9\u30a6\u304c\u3067\u308b\u306e\u3067\u3001`\u30c7\u30d7\u30ed\u30a4\u3055\u308c\u308b\u30b9\u30c6\u30fc\u30b8`\u304b\u3089[\u65b0\u3057\u3044\u30b9\u30c6\u30fc\u30b8]\u3001\u30b9\u30c6\u30fc\u30b8\u540d\u3092\u9069\u5f53\u306b\uff08\u3053\u308c\u306fAPI gateway\u306eURL\u306b\u542b\u307e\u308c\u307e\u3059\u3002\u3053\u3053\u3067\u306f`prod`\uff09\u3044\u308c\u3066[\u30c7\u30d7\u30ed\u30a4]\n\n![API_Gateway_deploy.png](https://qiita-image-store.s3.amazonaws.com/0/63168/c3a018a7-95ef-a2cc-554a-54d321f1e1c9.png)\n\n\u30b9\u30c6\u30fc\u30b8\u3067`URL\u306e\u547c\u3073\u51fa\u3057:`\u3067\u793a\u3055\u308c\u308bURL\u3092\u53d6\u3063\u3066\u304a\u304d\u307e\u3059\u3002\n\n![API_Gateway_callback.png](https://qiita-image-store.s3.amazonaws.com/0/63168/742a11e6-c913-dd13-88a1-356aa1924c33.png)\n\n\n## oauth\n\n\u307e\u305a\u306f\u3001slack app\u306e\u30da\u30fc\u30b8\u306e[OAuth & Permissions] \u753b\u9762\u3067\u3001RedirectURL\u306bAPI Gateway\u3067\u4f5c\u3063\u305f\u547c\u3073\u51fa\u3057\u306eURL\u3092\u5165\u308c[Save Changes]\u3057\u307e\u3059\u3002\n\n![Slack_API__Applications___wacul_Slack.png](https://qiita-image-store.s3.amazonaws.com/0/63168/3187572a-329f-1669-4b63-757deca8fd58.png)\n\n\u305d\u306e\u5f8c\u3001\u30d6\u30e9\u30a6\u30b6\u3067\u3044\u3044\u306e\u3067\u4e0b\u8a18\u3092\u958b\u304d\u307e\u3059\u3002\n\nhttps://slack.com/oauth/authorize?scope=commands&client_id=\u30af\u30e9\u30a4\u30a2\u30f3\u30c8ID\n\nscope\u306f\u5fc5\u8981\u306a\u6a29\u9650\u3092\u5165\u308c\u3066\u304f\u3060\u3055\u3044\u3002\u3053\u3053\u3067\u306f\u3001\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3067\u304d\u308b`commands`\u3092\u8a31\u53ef\u3057\u3066\u307e\u3059\u3002\noauth\u306escope\u4e00\u89a7\u306f\u4e0b\u8a18\u3067\u3059\u3002\n\nhttps://api.slack.com/docs/oauth-scopes\n\n`\u30af\u30e9\u30a4\u30a2\u30f3\u30c8ID`\u306fslack app\u753b\u9762\u306eclient_id\u3068\u3057\u3066\u3001\u3053\u306eURL\u3092\u30d6\u30e9\u30a6\u30b6\u3067\u3044\u3044\u306e\u3067\u76f4\u63a5\u9077\u79fb\u3059\u308b\u3068\u4e0b\u8a18\u306e\u3088\u3046\u306a\u753b\u9762\u306b\u884c\u304f\u306f\u305a\u3067\u3059\u3002\n\n\n![Authorize_access_to_your_account___wacul_Slack.png](https://qiita-image-store.s3.amazonaws.com/0/63168/26805a97-62d0-017f-a547-aee6cf9c7b95.png)\n\n[Authorize]\u3059\u308b\u3068\u3001\u5148\u307b\u3069\u306ecallback URL\u306b\u9077\u79fb\u3057\u307e\u3059\u3002\u3046\u307e\u304f\u3044\u3063\u3066\u3044\u308c\u3070\n\n`{\"text\":\"ok\"}` \u3068\u3060\u3051\u8868\u793a\u3055\u308c\u308b\u306f\u305a\u3067\u3059\u3002\n\n\n```\napex logs callback\n```\n\n\u3092\u53e9\u3044\u3066\u30ed\u30b0\u78ba\u8a8d\u3057\u307e\u3059\u3002\u5931\u6557\u3057\u3066\u3044\u308b\u5834\u5408\u3067\u3082\u3053\u308c\u3067\u306a\u305c\u5931\u6557\u3057\u305f\u304b\u3092\u78ba\u8a8d\u3057\u3066\u4fee\u6b63\u3057\u307e\u3059\u3002\n\u305d\u3082\u305d\u3082\u30ed\u30b0\u3067\u3066\u3044\u306a\u3044\u5834\u5408\u3001API Gateway\u304b\u3089lambda\u304c\u547c\u3070\u308c\u3066\u3044\u306a\u3044\u306e\u3067API Gateway\u306e\u8a2d\u5b9a\u3092\u898b\u76f4\u3057\u307e\u3057\u3087\u3046\u3002\n\n\u3046\u307e\u304f\u3044\u3063\u3066\u3044\u308c\u3070\u3001\u30ed\u30b0\u304b\u3089`access_token`\u304c\u3082\u3089\u3048\u3066\u3044\u308b\u306f\u305a\u3067\u3059\u3002`bot`\u3084`incoming-webhook`\u3092\u6709\u52b9\u306b\u3057\u3066\u3044\u308c\u3070\u305d\u308c\u3089\u3082\u542b\u307e\u308c\u3066\u3044\u307e\u3059\u3002\n\n\u3053\u308c\u3089\u3082\u6697\u53f7\u5316\u3057\u3066`project.json`\u306b\u653e\u308a\u8fbc\u307f\u307e\u3059\u3002\n\n\u4ed6\u306eslack\u30c1\u30fc\u30e0\u3067\u4f7f\u3046\u308f\u3051\u3067\u3082\u306a\u3044\u5834\u5408\u306f\u3001`callback`\u3092API Gateway\u304b\u3089\u524a\u9664\u3057\u3066\u3057\u307e\u3063\u3066\u3082\u3044\u3044\u3067\u3057\u3087\u3046\u3002\n\n\u3053\u308c\u3067slack app\u306e\u767b\u9332\u306e\u5b8c\u4e86\u3067\u3059\u3002\n\n\u6b21\u3067slash command\u3068interactive message\u3092\u767b\u9332\u3057\u307e\u3059\u3002\n\n# TIPS\n\n## incoming-webhook\u306ekms\n\nincoming-webhook\u3092\u4f7f\u3046\u5834\u5408\u3001\u4f7f\u3046\u6587\u5b57\u5217\u306f `https://` \u3067\u59cb\u307e\u308a\u307e\u3059\u304c\u3001aws\u30b3\u30de\u30f3\u30c9\u3067`file://` \u3084 `http://` \u306a\u3069\u3067\u59cb\u307e\u308b\u6587\u5b57\u5217\u306e\u5834\u5408\u306f\u554f\u7b54\u7121\u7528\u3067\u3001\u305d\u306e\u30d5\u30a1\u30a4\u30eb\u3084URL\u3092\u53c2\u7167\u3057\u306b\u3044\u304f\u306e\u3067\u3001\u4e00\u65e6\u30d5\u30a1\u30a4\u30eb\u306b\u30c6\u30ad\u30b9\u30c8\u3092\u4fdd\u5b58\u3057\u3066\u6697\u53f7\u5316\u3057\u307e\u3059\u3002\n\u30ab\u30ec\u30f3\u30c8\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306e`tmp`\u306b\u30c6\u30ad\u30b9\u30c8\u3092\u5165\u308c\u305f\u3068\u3057\u3066\n```\naws kms encrypt --key-id alias/slack --plaintex file://./tmp\n```\n\n## .gitignore\n\nroot\u306b\u8a00\u8a9e\u306e.gitignore\u3001python\u306e\u5834\u5408\u306f\u53d6\u5f97\u3057\u305f\u30e2\u30b8\u30e5\u30fc\u30eb\u304c\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306b\u7f6e\u304b\u308c\u308b\u306e\u3067function\u3054\u3068\u306b.gitignore\u3057\u3066\u307e\u3059\u3002\n\n```:.gitignore\n.Python\nbuild/\ndevelop-eggs/\ndist/\neggs/\n.eggs/\nparts/\nsdist/\n*.egg-info/\n*.dist-info/\n.installed.cfg\n*.egg\n```\n\n```:functions/callback/.gitignore\nboto3/\nbotocore/\ns3transfer/\nrequests/\njmespath/\ndocutils/\ndateutil/\nsix.py\n```\n\n", "tags": ["AWS", "AWSAPIGateway", "AWSLambda", "Slack"]}