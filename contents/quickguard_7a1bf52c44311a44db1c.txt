{"tags": ["centos7", "CloudStack", "cloud-init"], "context": "\n\n\u6982\u8981\nCloudStack \u3067 cloud-init \u3092\u4f7f\u7528\u3059\u308b\u969b\u306e\u69cb\u7bc9\u624b\u9806\u3068\u30e1\u30e2\u3002\nIDCF\u30af\u30e9\u30a6\u30c9\u6a19\u6e96\uff1f\uff08\u304a\u3059\u3059\u3081\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\uff09\u306e CentOS 7.2 \u3067\u306f cloud-init \u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u305f\u3060\u3051\u3067\u306f\u3001\u6b63\u5e38\u52d5\u4f5c\u3057\u306a\u304b\u3063\u305f\u203b\u306e\u3067\u69cb\u7bc9\u624b\u9806\u3092\u8a18\u9332\u3057\u3066\u304a\u304f\u3002\n\u203bcloud-init \u304b\u3089 META DATA \u30b5\u30fc\u30d0\u306b\u30a2\u30af\u30bb\u30b9\u3067\u304d\u306a\u3044\u30a8\u30e9\u30fc\u304c\u767a\u751f\n\u539f\u56e0\nCloudStack \u3067\u306f VR \u304c dpcp, META DATA \u30b5\u30fc\u30d0\u306e\u5f79\u5272\u3082\u6301\u3063\u3066\u304a\u308a\u3001cloud-init \u304c user_data \u3092\u53d6\u5f97\u3059\u308b\u969b\u306b\u3001/var/lib/dhclient/dhclient-eth0.leases \u30d5\u30a1\u30a4\u30eb\u304b\u3089 META DATA \u30b5\u30fc\u30d0\u306e\u30a2\u30c9\u30ec\u30b9\u3092\u53d6\u5f97\u3057\u3066\u3044\u308b\u3002\nIDCF\u30af\u30e9\u30a6\u30c9\u6a19\u6e96\u306e CentOS 7.2 \u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u3067\u306f\u3001NetworkManager \u304c\u6709\u52b9\u306b\u306a\u3063\u3066\u304a\u308a\u3001NetworkManager \u3067\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u3055\u308c\u305f\u5834\u5408\u4e0a\u8a18\u30d5\u30a1\u30a4\u30eb\u304c\u4f5c\u6210\u3055\u308c\u306a\u3044\u305f\u3081\u3001cloud-init \u304c META DATA \u30b5\u30fc\u30d0\u306e\u60c5\u5831\u53d6\u5f97\u51fa\u6765\u305a\u306b\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3057\u3066\u3044\u305f\u3002\n\n\u74b0\u5883\n\nCloudStack 4.3.0.3 (IDCF\u30af\u30e9\u30a6\u30c9)\nCentOS 7.2 64-bit\n\n\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u624b\u9806\ncloud-init \u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n# yum install cloud-init\n\ncloud-init datasource \u8a2d\u5b9a\n\u4ee5\u4e0b\u306e\u30d5\u30a1\u30a4\u30eb\u3092\u65b0\u898f\u4f5c\u6210\n\n/etc/cloud/cloud.cfg.d/99_cloudstack.cfg\ndatasource:\n  CloudStack: {}\n  None: {}\ndatasource_list:\n  - CloudStack\n\n\ncloud-init \u6709\u52b9\u5316\n# systemctl enable cloud-config\n# systemctl enable cloud-init\n# systemctl enable cloud-final\n\n\nInterface \u8a2d\u5b9a\nIF \u540d\u306e\u5909\u66f4\nGRUB_CMDLINE_LINUX \u306e\u30aa\u30d7\u30b7\u30e7\u30f3\u306b net.ifnames=0 \u3092\u8ffd\u8a18\n\n/etc/default/grub\nGRUB_CMDLINE_LINUX=\"rd.lvm.lv=centos/swap vconsole.font=latarcyrhebsun16 vconsole.keymap=jp106 rd.lvm.lv=centos/root crashkernel=auto net.ifnames=0 rhgb quiet\"\n\n\ngrub \u3078\u53cd\u6620\n# grub2-mkconfig -o /boot/grub2/grub.cfg \n\nIF \u8a2d\u5b9a\n\u4ee5\u4e0b\u30d5\u30a1\u30a4\u30eb\u3092\u65b0\u898f\u4f5c\u6210\n\n/etc/sysconfig/network-scripts/ifcfg-eth0\nDEVICE=\"eth0\"\nBOOTPROTO=\"dhcp\"\nIPV6INIT=\"yes\"\nMTU=\"1500\"\nNM_CONTROLLED=\"no\"\nONBOOT=\"yes\"\nTYPE=\"Ethernet\"\n\n\nNetworkManager \u524a\u9664\n# yum -y remove NetworkManager\n\nnetwork service \u6709\u52b9\u5316\n# chkconfig network on\n\n\u518d\u8d77\u52d5\n# reboot\n\n\u4ee5\u4e0a\n\nIDCF \u30b3\u30df\u30e5\u30cb\u30c6\u30a3\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\n\u6bce\u56de\u3084\u308b\u306e\u306f\u9762\u5012\u306a\u306e\u3067\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u5316 + \u516c\u958b\u3057\u3066\u307f\u305f\n\n\n\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u540d\uff1a CentOS 7.2 64bit with cloud-init\n\n\u4f7f\u7528\u4e0a\u306e\u6ce8\u610f\u70b9\n\u4ee5\u4e0b\u306e\u5236\u7d04\u304c\u3042\u308a\u3001user_data \u3078\u5f15\u304d\u6e21\u3059\u30c7\u30fc\u30bf\u30b5\u30a4\u30ba\u306f\u56fa\u5b9a\u306b\u306a\u308b\u305f\u3081\u3001\u7279\u5b9a\u306e\u74b0\u5883\u4e0b\u3067\u3057\u304b\u4f7f\u3048\u306a\u3044\u3002\n(\u30db\u30b9\u30c8\u540d\u3068\u304b\u6587\u5b57\u6570\u304c\u5909\u308f\u308b\u74b0\u5883\u4e0b\u3067\u306f\u3001\u6bce\u56de\u6539\u884c\u306e\u8ffd\u52a0\u30fb\u524a\u9664\u7b49\u3067\u30d0\u30a4\u30c8\u6570\u3092\u8abf\u6574\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u3002)\n\nBase64\u30a8\u30f3\u30b3\u30fc\u30c9\u524d\u306e\u30c7\u30fc\u30bf\u306e\u30d0\u30a4\u30c8\u6570\u304c3\u306e\u500d\u6570\u3067\u306f\u306a\u3044\u5834\u5408\u3001\u6b63\u5e38\u306b\u8a8d\u8b58\u3067\u304d\u306a\u3044\n\nIDCF\u30af\u30e9\u30a6\u30c9\u516c\u5f0f\u30d6\u30ed\u30b0\u8a18\u4e8b \u3088\u308a\u3002\n\u3061\u306a\u307f\u306b terraform \u3067\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u4f5c\u6210\u3057\u3088\u3046\u3068\u3057\u305f\u3068\u304d\u306f\u4ee5\u4e0b\u306e\u30a8\u30e9\u30fc\u3068\u306a\u308b\u3002\nError applying plan:\n\n1 error(s) occurred:\n\n* cloudstack_instance.default: Error creating the new instance test-01: CloudStack API error 400 (CSExceptionErrorCode: 9999): deployVirtualMachine accepts only userdata which size is multiples of 3 bytes before base64 encoding.\n\nuser_data \u3092 Base64\u30a8\u30f3\u30b3\u30fc\u30c9\u3057\u305f\u969b\u306e\u30d1\u30c7\u30a3\u30f3\u30b0\uff08 \u30b1\u30c4\u306b = \u304c\u542b\u307e\u308c\u308b\u3068\u30c0\u30e1\uff09\u304c\u5f71\u97ff\u3057\u3066\u3044\u308b\u3068\u601d\u308f\u308c\u308b\u304c\u3001\u6b63\u76f4\u4f7f\u3044\u7269\u306b\u306a\u3089\u306a\u3044\u306e\u3067\u306a\u3093\u3068\u304b\u3057\u3066\u6b32\u3057\u3044\u3002\n\nOK\u30d1\u30bf\u30fc\u30f3\n$ base64 default.yml | tr -d \"\\n\" ;echo \"\"\nI2Nsb3VkLWNvbmZpZwoKd3JpdGVfZmlsZXM6CiAgLSBwYXRoOiAvZXRjL3N5c2NvbmZpZy9tYWNrZXJlbC1hZ2VudAogICAgY29udGVudDogfAogICAgICBPVEhFUl9PUFRTPSItcm9sZT1zaG93cm9vbToke3NoYXJkfSIKICAgICAgQVVUT19SRVRJUkVNRU5UPTEKCgpydW5jbWQ6CiAgLSBzZXJ2aWNlIG1hY2tlcmVsLWFnZW50IHJlc3RhcnQK\n\n\n\nNG\u30d1\u30bf\u30fc\u30f3\n$ base64 cloud-config.yml | tr -d \"\\n\" ;echo \"\"\nI2Nsb3VkLWNvbmZpZwoKd3JpdGVfZmlsZXM6CiAgLSBwYXRoOiAvZXRjL3N5c2NvbmZpZy9tYWNrZXJlbC1hZ2VudAogICAgY29udGVudDogfAogICAgICBPVEhFUl9PUFRTPSItcm9sZT1zaG93cm9vbToke3NoYXJkfSIKICAgICAgQVVUT19SRVRJUkVNRU5UPTEKCnJ1bmNtZDoKICAtIHNlcnZpY2UgbWFja2VyZWwtYWdlbnQgcmVzdGFydAo=\n\n\n\n# \u6982\u8981\n\nCloudStack \u3067 cloud-init \u3092\u4f7f\u7528\u3059\u308b\u969b\u306e\u69cb\u7bc9\u624b\u9806\u3068\u30e1\u30e2\u3002\n\nIDCF\u30af\u30e9\u30a6\u30c9\u6a19\u6e96\uff1f\uff08\u304a\u3059\u3059\u3081\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\uff09\u306e CentOS 7.2 \u3067\u306f cloud-init \u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u305f\u3060\u3051\u3067\u306f\u3001\u6b63\u5e38\u52d5\u4f5c\u3057\u306a\u304b\u3063\u305f\u203b\u306e\u3067\u69cb\u7bc9\u624b\u9806\u3092\u8a18\u9332\u3057\u3066\u304a\u304f\u3002\n\n\u203bcloud-init \u304b\u3089 META DATA \u30b5\u30fc\u30d0\u306b\u30a2\u30af\u30bb\u30b9\u3067\u304d\u306a\u3044\u30a8\u30e9\u30fc\u304c\u767a\u751f\n\n**\u539f\u56e0**\nCloudStack \u3067\u306f VR \u304c dpcp, META DATA \u30b5\u30fc\u30d0\u306e\u5f79\u5272\u3082\u6301\u3063\u3066\u304a\u308a\u3001cloud-init \u304c user_data \u3092\u53d6\u5f97\u3059\u308b\u969b\u306b\u3001`/var/lib/dhclient/dhclient-eth0.leases` \u30d5\u30a1\u30a4\u30eb\u304b\u3089 META DATA \u30b5\u30fc\u30d0\u306e\u30a2\u30c9\u30ec\u30b9\u3092\u53d6\u5f97\u3057\u3066\u3044\u308b\u3002\n\nIDCF\u30af\u30e9\u30a6\u30c9\u6a19\u6e96\u306e CentOS 7.2 \u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u3067\u306f\u3001NetworkManager \u304c\u6709\u52b9\u306b\u306a\u3063\u3066\u304a\u308a\u3001NetworkManager \u3067\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u3055\u308c\u305f\u5834\u5408\u4e0a\u8a18\u30d5\u30a1\u30a4\u30eb\u304c\u4f5c\u6210\u3055\u308c\u306a\u3044\u305f\u3081\u3001cloud-init \u304c META DATA \u30b5\u30fc\u30d0\u306e\u60c5\u5831\u53d6\u5f97\u51fa\u6765\u305a\u306b\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3057\u3066\u3044\u305f\u3002\n\n# \u74b0\u5883\n - CloudStack 4.3.0.3 (IDCF\u30af\u30e9\u30a6\u30c9)\n - CentOS 7.2 64-bit\n\n# \u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u624b\u9806\n\n**cloud-init \u30a4\u30f3\u30b9\u30c8\u30fc\u30eb**\n\n```\n# yum install cloud-init\n```\n\n**cloud-init datasource \u8a2d\u5b9a**\n\u4ee5\u4e0b\u306e\u30d5\u30a1\u30a4\u30eb\u3092\u65b0\u898f\u4f5c\u6210\n\n```:/etc/cloud/cloud.cfg.d/99_cloudstack.cfg\ndatasource:\n  CloudStack: {}\n  None: {}\ndatasource_list:\n  - CloudStack\n```\n\n**cloud-init \u6709\u52b9\u5316**\n\n```\n# systemctl enable cloud-config\n# systemctl enable cloud-init\n# systemctl enable cloud-final\n```\n\n# Interface \u8a2d\u5b9a\n\n**IF \u540d\u306e\u5909\u66f4**\nGRUB_CMDLINE_LINUX \u306e\u30aa\u30d7\u30b7\u30e7\u30f3\u306b net.ifnames=0 \u3092\u8ffd\u8a18\n\n```:/etc/default/grub\nGRUB_CMDLINE_LINUX=\"rd.lvm.lv=centos/swap vconsole.font=latarcyrhebsun16 vconsole.keymap=jp106 rd.lvm.lv=centos/root crashkernel=auto net.ifnames=0 rhgb quiet\"\n```\n\n**grub \u3078\u53cd\u6620**\n\n```\n# grub2-mkconfig -o /boot/grub2/grub.cfg \n```\n\n**IF \u8a2d\u5b9a**\n\u4ee5\u4e0b\u30d5\u30a1\u30a4\u30eb\u3092\u65b0\u898f\u4f5c\u6210\n\n```:/etc/sysconfig/network-scripts/ifcfg-eth0\nDEVICE=\"eth0\"\nBOOTPROTO=\"dhcp\"\nIPV6INIT=\"yes\"\nMTU=\"1500\"\nNM_CONTROLLED=\"no\"\nONBOOT=\"yes\"\nTYPE=\"Ethernet\"\n```\n\n**NetworkManager \u524a\u9664**\n\n```\n# yum -y remove NetworkManager\n```\n\n**network service \u6709\u52b9\u5316**\n\n```\n# chkconfig network on\n```\n\n**\u518d\u8d77\u52d5**\n\n```\n# reboot\n```\n\n\u4ee5\u4e0a\n\n\n# IDCF \u30b3\u30df\u30e5\u30cb\u30c6\u30a3\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\n\n\u6bce\u56de\u3084\u308b\u306e\u306f\u9762\u5012\u306a\u306e\u3067\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u5316 + \u516c\u958b\u3057\u3066\u307f\u305f\n![01.png](https://qiita-image-store.s3.amazonaws.com/0/105824/714fcff6-130b-eb31-81b5-46ec8876419a.png)\n\n\n- \u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u540d\uff1a CentOS 7.2 64bit with cloud-init\n\n**\u4f7f\u7528\u4e0a\u306e\u6ce8\u610f\u70b9**\n\u4ee5\u4e0b\u306e\u5236\u7d04\u304c\u3042\u308a\u3001user_data \u3078\u5f15\u304d\u6e21\u3059\u30c7\u30fc\u30bf\u30b5\u30a4\u30ba\u306f\u56fa\u5b9a\u306b\u306a\u308b\u305f\u3081\u3001\u7279\u5b9a\u306e\u74b0\u5883\u4e0b\u3067\u3057\u304b\u4f7f\u3048\u306a\u3044\u3002\n(\u30db\u30b9\u30c8\u540d\u3068\u304b\u6587\u5b57\u6570\u304c\u5909\u308f\u308b\u74b0\u5883\u4e0b\u3067\u306f\u3001\u6bce\u56de\u6539\u884c\u306e\u8ffd\u52a0\u30fb\u524a\u9664\u7b49\u3067\u30d0\u30a4\u30c8\u6570\u3092\u8abf\u6574\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u3002)\n\n> **Base64\u30a8\u30f3\u30b3\u30fc\u30c9\u524d\u306e\u30c7\u30fc\u30bf\u306e\u30d0\u30a4\u30c8\u6570\u304c3\u306e\u500d\u6570\u3067\u306f\u306a\u3044\u5834\u5408\u3001\u6b63\u5e38\u306b\u8a8d\u8b58\u3067\u304d\u306a\u3044**\n\n[IDCF\u30af\u30e9\u30a6\u30c9\u516c\u5f0f\u30d6\u30ed\u30b0\u8a18\u4e8b](http://blog.idcf.jp/entry/cloud/coreos/) \u3088\u308a\u3002\n\n\u3061\u306a\u307f\u306b terraform \u3067\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u4f5c\u6210\u3057\u3088\u3046\u3068\u3057\u305f\u3068\u304d\u306f\u4ee5\u4e0b\u306e\u30a8\u30e9\u30fc\u3068\u306a\u308b\u3002\n\n```\nError applying plan:\n\n1 error(s) occurred:\n\n* cloudstack_instance.default: Error creating the new instance test-01: CloudStack API error 400 (CSExceptionErrorCode: 9999): deployVirtualMachine accepts only userdata which size is multiples of 3 bytes before base64 encoding.\n```\n\nuser_data \u3092 Base64\u30a8\u30f3\u30b3\u30fc\u30c9\u3057\u305f\u969b\u306e\u30d1\u30c7\u30a3\u30f3\u30b0\uff08 \u30b1\u30c4\u306b `=` \u304c\u542b\u307e\u308c\u308b\u3068\u30c0\u30e1\uff09\u304c\u5f71\u97ff\u3057\u3066\u3044\u308b\u3068\u601d\u308f\u308c\u308b\u304c\u3001\u6b63\u76f4\u4f7f\u3044\u7269\u306b\u306a\u3089\u306a\u3044\u306e\u3067\u306a\u3093\u3068\u304b\u3057\u3066\u6b32\u3057\u3044\u3002\n\n\n```:OK\u30d1\u30bf\u30fc\u30f3\n$ base64 default.yml | tr -d \"\\n\" ;echo \"\"\nI2Nsb3VkLWNvbmZpZwoKd3JpdGVfZmlsZXM6CiAgLSBwYXRoOiAvZXRjL3N5c2NvbmZpZy9tYWNrZXJlbC1hZ2VudAogICAgY29udGVudDogfAogICAgICBPVEhFUl9PUFRTPSItcm9sZT1zaG93cm9vbToke3NoYXJkfSIKICAgICAgQVVUT19SRVRJUkVNRU5UPTEKCgpydW5jbWQ6CiAgLSBzZXJ2aWNlIG1hY2tlcmVsLWFnZW50IHJlc3RhcnQK\n```\n\n```:NG\u30d1\u30bf\u30fc\u30f3\n$ base64 cloud-config.yml | tr -d \"\\n\" ;echo \"\"\nI2Nsb3VkLWNvbmZpZwoKd3JpdGVfZmlsZXM6CiAgLSBwYXRoOiAvZXRjL3N5c2NvbmZpZy9tYWNrZXJlbC1hZ2VudAogICAgY29udGVudDogfAogICAgICBPVEhFUl9PUFRTPSItcm9sZT1zaG93cm9vbToke3NoYXJkfSIKICAgICAgQVVUT19SRVRJUkVNRU5UPTEKCnJ1bmNtZDoKICAtIHNlcnZpY2UgbWFja2VyZWwtYWdlbnQgcmVzdGFydAo=\n```\n"}