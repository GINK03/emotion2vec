{"context": " More than 1 year has passed since last update.Ruby on Rails\u3067Dev\u74b0\u5883\u306f\u4f7f\u3063\u305f\u3053\u3068\u3042\u308b\u3051\u3069\u3001test\u30fbprod\u74b0\u5883\u3092\u8003\u616e\u3057\u305f\u74b0\u5883\u69cb\u7bc9\u3092\u3057\u305f\u3053\u3068\u304c\u306a\u3044\u4eba\u306b\u304a\u52e7\u3081\u306e\u5185\u5bb9\u3067\u3059\u3002\n\n\u30b5\u30fc\u30d0\u30fc\u69cb\u6210\u56f3\n\n\n\u30b5\u30fc\u30d0\u30fc\u306e\u5f79\u5272\n\n\u30ea\u30d0\u30fc\u30b9\u30d7\u30ed\u30ad\u30b7\u30b5\u30fc\u30d0\u30fc(\u30db\u30b9\u30c8\u540d\uff1arp01\uff09\n\n\u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b5\u6a5f\u80fd\u3092\u4f7f\u3063\u3066WEB\u30b5\u30fc\u30d0\u4e8c\u53f0\u306b\u51e6\u7406\u3092\u632f\u308a\u5206\u3051\u3001\u30a2\u30af\u30bb\u30b9\u3092\uff11\u53f0\u306e\u30b5\u30fc\u30d0\u30fc\u306b\u96c6\u4e2d\u3055\u305b\u306a\u3044\nWEB\u30b5\u30fc\u30d0\u30fc\u3092\u5916\u90e8\u304b\u3089\u96a0\u305b\u308b\u3053\u3068\u3067\u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u9762\u306e\u5411\u4e0a\n\n\nWEB\u30b5\u30fc\u30d0\u30fc\uff08web01\u3001web02\uff09\n\nweb\u30b5\u30fc\u30d0\u30fc\u3092\uff12\u53f0\u7528\u610f\u3059\u308b\u3053\u3068\u3067\u30a2\u30af\u30bb\u30b9\u304c\uff11\u3064\u306e\u30b5\u30fc\u30d0\u30fc\u306b\u96c6\u4e2d\u3057\u306a\u3044\u305f\u3081\u3001\u30ec\u30b9\u30dd\u30f3\u30b9\u3092\u65e9\u304f\u3067\u304d\u308b\n\n\n\u30de\u30b9\u30bf\u30fcDB\u30b5\u30fc\u30d0\u30fc\uff08db01m\uff09\n\nDB\u5185\u5bb9\u3092\u3082\u3046\uff11\u53f0\u306eDB\u30b5\u30fc\u30d0\u30fc\uff08\u30b9\u30ec\u30fc\u30d6\uff09\u3078\u30ea\u30a2\u30eb\u30bf\u30a4\u30e0\u306b\u30b3\u30d4\u30fc\u3057\u3001\u969c\u5bb3\u3067\u30de\u30b9\u30bf\u30fc\u304c\u505c\u6b62\u3057\u305f\u3068\u304d\u306f\u30b9\u30ec\u30fc\u30d6\u306b\u5207\u308a\u66ff\u3048\u308b\n\n\n\u30b9\u30ec\u30fc\u30d6DB\u30b5\u30fc\u30d0\u30fc\uff08db01s\uff09\n\n\u8aad\u307f\u8fbc\u307f\u5c02\u7528\u306e\u30b5\u30fc\u30d0\u30fc\u3002\u66f8\u304d\u8fbc\u307f\u3092\u3057\u306a\u3044\u5206\u30ec\u30b9\u30dd\u30f3\u30b9\u304c\u65e9\u304f\u306a\u308b\n\u30de\u30b9\u30bf\u30fc\u306e\u5185\u5bb9\u3092\u5e38\u306b\u30b3\u30d4\u30fc\u3059\u308b\uff08\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3068\u3044\u3046\uff09\n\n\n\u958b\u767a\u74b0\u5883\uff08dev01\uff09\n\n\u958b\u767a\u306f\u3053\u306e\u74b0\u5883\u3060\u3051\u3067\u884c\u3044\u3001\u5b8c\u6210\u7269\u3092WEB\u30b5\u30fc\u30d0\u30fc\u306b\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u3059\u308b\uff08\u30c7\u30d7\u30ed\u30a4\u3068\u3044\u3046\uff09\n\n\nDNS\uff08rp01\uff09\n\n\u5404\u30b5\u30fc\u30d0\u30fc\u306e\u30db\u30b9\u30c8\u540d\u3092\u7ba1\u7406\u3059\u308bDNS\u3002\u30ea\u30d0\u30fc\u30b9\u30d7\u30ed\u30ad\u30b7\u3068\u540c\u3058\u30b5\u30fc\u30d0\u30fc\u5185\u3067\u52d5\u4f5c\u3055\u305b\u308b\n\n\n\u6e96\u5099\n\nVPS\u7b49\u3067\u30b5\u30fc\u30d0\u30fc\u30925\u53f0\u501f\u308a\u3066\u304a\u304f\uff08rp01\u3001web01\u3001web02\u3001db01m\u3001db01s\uff09\n\u30ea\u30d0\u30fc\u30b9\u30d7\u30ed\u30ad\u30b7\u306f\u30b0\u30ed\u30fc\u30d0\u30ebIP\u5fc5\u9808\n\u958b\u767a\u74b0\u5883\uff08\u624b\u6301\u3061\u306bMac\u3084Unix\u74b0\u5883\u304c\u306a\u3044\u306a\u3089vps\u3067\u501f\u308a\u308b\uff09\n\n\n\u30b5\u30fc\u30d0\u30fc\u4ed5\u69d8\n\nWEB\u30b5\u30fc\u30d0\u30fc\u30fb\u30ea\u30d0\u30fc\u30b9\u30d7\u30ed\u30ad\u30b7\n\nApache/2.2.15 (Unix)\n\n\n\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\n\nMySQL Server 5.1.71\n\n\nDNS\n\nmydns 1.2.8.31\n\n\nRuby\n\nruby-2.0.0-p353\n\n\nRuby on Rails\n\nRails 4.0.2\n\n\n\u5168\u30b5\u30fc\u30d0\u30fc\u306b\u5171\u901a\u3059\u308b\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\n\n\u30ed\u30b0\u30a4\u30f3\u30e6\u30fc\u30b6\u30fc\u306e\u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u8a2d\u5b9a\u7de8\n\u521d\u671f\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3055\u308c\u305f\u30d1\u30c3\u30b1\u30fc\u30b8\u3092\u30a2\u30c3\u30d7\u30c7\u30fc\u30c8\n$ sudo yum update\n\u30ed\u30b0\u30a4\u30f3\u30e6\u30fc\u30b6\u30fc\uff08deploy01\uff09\u306e\u4f5c\u6210\n$ useradd deploy01\n$ passwd  deploy01\n\ndeploy01\u3092sudo\u6a29\u9650\u304c\u4f7f\u3048\u308b\u30b0\u30eb\u30fc\u30d7\u306b\u6240\u5c5e\u3055\u305b\u308b\n$ usermod \u2013G wheel deploy01\n\nwheel\u30b0\u30eb\u30fc\u30d7\u4ee5\u5916\u306fsudo\u6a29\u9650\u3092\u4e0e\u3048\u306a\u3044\u8a2d\u5b9a\u3002\n\u4e0b\u8a18\u884c\u306e\u30b3\u30e1\u30f3\u30c8\u3092\u5916\u3059\u3002\n\n/etc/pam.d/su\n#auth  required pam_wheel.so use_uid\n\n\nwheel\u30b0\u30eb\u30fc\u30d7\u306e\u307froot\u30e6\u30fc\u30b6\u30fc\u306b\u30ed\u30b0\u30a4\u30f3\u53ef\u80fd\u306b\u3059\u308b\u3002\n\u4e0b\u8a18\u884c\u3092\u8ffd\u52a0\n\n/etc/login.defs\nSU_WHEEL_ONLY yes\n\n\nwheel\u30b0\u30eb\u30fc\u30d7\u306e\u30e6\u30fc\u30b6\u30fc\u306e\u307f sudo\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u8a31\u53ef\u3002\n\u4e0b\u8a18\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3059\u308b\u3002\n$ visudo\n\n\u3059\u308b\u3068\u3001\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u304c\u958b\u304f\u306e\u3067\u4e0b\u8a18\u884c\u306e\u30b3\u30e1\u30f3\u30c8\u3092\u5916\u3059\n# %wheel ALL=(ALL) ALL\n\nroot\u30e6\u30fc\u30b6\u30fc\u3067\u306essh\u30ed\u30b0\u30a4\u30f3\u3092\u7981\u6b62\u3059\u308b\u3002\n\u4e0b\u8a18\u884c\u3092\u30b3\u30e1\u30f3\u30c8\u5316\u3059\u308b\n\n/etc/ssh/sshd_config\nPermitRootLogin no\n\n\nSSH\u306e\u30dd\u30fc\u30c8\u3092\u72d9\u3063\u305f\u653b\u6483\u3092\u56de\u907f\u3059\u308b\u305f\u3081\u3001\u30dd\u30fc\u30c8\u756a\u53f7\u3092\u5909\u66f4\u3059\u308b\u3002\nPort\u306e\u5f8c\u308d\u306b\u5909\u66f4\u3057\u305f\u3044\u30dd\u30fc\u30c8\u756a\u53f7\u3092\u5165\u308c\u308b\n\n/etc/ssh/sshd_config\nPort 3243\n\n\nSSH\u306e\u5909\u66f4\u3092\u6709\u52b9\u306b\u3059\u308b\u305f\u3081\u3001SSH\u3092\u518d\u8d77\u52d5\u3059\u308b\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\n$ /etc/init.d/sshd restart\n\n\u30d5\u30a1\u30a4\u30a2\u30a6\u30a9\u30fc\u30eb\u7de8\n\u4e0b\u8a18\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3059\u308b\u3068\u30d5\u30a1\u30a4\u30a2\u30a6\u30a9\u30fc\u30eb\u306e\u8a2d\u5b9a\u60c5\u5831\u3092\u78ba\u8a8d\u3067\u304d\u308b\n$ /sbin/iptables -L --line-number\n\nChain INPUT (policy ACCEPT)\nnum  target     prot opt source               destination         \n\nChain FORWARD (policy ACCEPT)\nnum  target     prot opt source               destination         \n\nChain OUTPUT (policy ACCEPT)\nnum  target     prot opt source               destination\n\n\n\u4e0a\u8a18\u3068\u540c\u3058\u8868\u793a\u306e\u5834\u5408\u3001\u3059\u3079\u3066\u306e\u901a\u4fe1\u3092\u8a31\u53ef\u3057\u3066\u3044\u308b\u305f\u3081\u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u4e0a\u554f\u984c\u304c\u3042\u308b\u3002\n\u5404\u30b5\u30fc\u30d0\u30fc\u3054\u3068\u306b\u30d5\u30a1\u30a4\u30a2\u30a6\u30a9\u30fc\u30eb\u3092\u8a2d\u5b9a\u3059\u308b\u3002\n\n\u30ea\u30d0\u30fc\u30b9\u30d7\u30ed\u30ad\u30b7\uff08rp01\uff09\u306e\u30d5\u30a1\u30a4\u30a2\u30a6\u30a9\u30fc\u30eb\u8a2d\u5b9a\n\u5916\u90e8\u30d1\u30b1\u30c3\u30c8\u304b\u3089\u5165\u3063\u3066\u304f\u308b\u30d1\u30b1\u30c3\u30c8\u306e\u3046\u3061\nhttp\u3001https\u3001ssh\uff08\u30dd\u30fc\u30c8\u306f3824\uff09\u3001DNS\u306e\u307f\u8a31\u53ef\u3059\u308b\u3002\n\n/etc/sysconfig/iptables\n*filter\n:INPUT DROP [0:0]\n:FORWARD DROP [0:0]\n:OUTPUT ACCEPT [0:0]\n-A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT\n## allow well-known port ##\n-A INPUT -p icmp -j ACCEPT\n-A INPUT -i lo -j ACCEPT\n## allow port(SSH,http,https,DNS) ##\n-A INPUT -m state --state NEW -m tcp -p tcp --dport 3824 -j ACCEPT\n-A INPUT -m state --state NEW -m tcp -p tcp --dport 80   -j ACCEPT\n-A INPUT -m state --state NEW -m tcp -p tcp --dport 443  -j ACCEPT\n-A INPUT -m state --state NEW -m udp -p udp --dport 53   -j ACCEPT\nCOMMIT\n\n\n\nWEB\u30b5\u30fc\u30d0\u30fc\uff08web01\u3001web02\uff09\u306e\u8a2d\u5b9a\n\u203bIP\u30a2\u30c9\u30ec\u30b9\u3092\u30db\u30b9\u30c8\u540d\u306b\u7f6e\u304d\u63db\u3048\u3066\u307e\u3059\u3002\n\n/etc/sysconfig/iptables\n*filter\n:INPUT DROP [0:0]\n:FORWARD DROP [0:0]\n:OUTPUT ACCEPT [0:0]\n-A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT\n#------------------------------------------------------\n# ping\u3001\u30eb\u30fc\u30d7\u30d0\u30c3\u30af\u30a2\u30c9\u30ec\u30b9\u3092\u8a31\u53ef\n#------------------------------------------------------\n-A INPUT -p icmp -j ACCEPT\n-A INPUT -i lo -j ACCEPT\n#------------------------------------------------------\n# RP\u306e\u307f\u3001web\u30b5\u30fc\u30d0\u30fc\u3078\u306e\u901a\u4fe1\u3092\u8a31\u53ef\n# 80\u306f\u672c\u756a\u74b0\u5883\uff08prod\uff09\u306e\u30b5\u30a4\u30c8\u8868\u793a\n# 8000\u306f\u30c6\u30b9\u30c8\u74b0\u5883\uff08test\uff09\u306e\u30b5\u30a4\u30c8\u8868\u793a\n#------------------------------------------------------\n-A INPUT -s rp01 -p tcp --dport 80   -j ACCEPT\n-A INPUT -s rp01 -p tcp --dport 8000 -j ACCEPT\n#------------------------------------------------------\n# SSH\u3092\u8a31\u53ef\n#------------------------------------------------------\n-A INPUT -m state --state NEW -m tcp -p tcp --dport 3843 -j ACCEPT\nCOMMIT\n\n\n\nDB\u30b5\u30fc\u30d0\u30fc\uff08db01m\uff09\u306e\u8a2d\u5b9a\n\u203bIP\u30a2\u30c9\u30ec\u30b9\u3092\u30db\u30b9\u30c8\u540d\u306b\u7f6e\u304d\u63db\u3048\u3066\u307e\u3059\u3002\n*filter\n#------------------------------------------------------\n# \u30e1\u30f3\u30c6\u30ca\u30f3\u30b9\u53ef\u80fd\u30ea\u30b9\u30c8\n# web01\n# web02\n# db01s\n#------------------------------------------------------\n#------------------------------------------------------\n# \u30dd\u30ea\u30b7\u30fc\uff1a\u5168\u3066\u306e\u9001\u53d7\u4fe1\u30d1\u30b1\u30c3\u30c8\u3092\u7834\u68c4\u3002\u5fc5\u8981\u306a\u7528\u9014\u306b\u5fdc\u3058\u3066\u958b\u3051\u3066\u3044\u304f\u3002\n#------------------------------------------------------\n:INPUT DROP [0:0]\n:FORWARD DROP [0:0]\n:OUTPUT DROP [0:0]\n#------------------------------------------------------\n# ping\u3068\u30eb\u30fc\u30d7\u30d0\u30c3\u30af\u30a2\u30c9\u30ec\u30b9\uff08\u81ea\u5206\u81ea\u8eab\u306eIP\uff09\u304b\u3089\u306e\u9001\u53d7\u4fe1\u3092\u8a31\u53ef\n#------------------------------------------------------\n-A INPUT -i lo -j ACCEPT\n-A OUTPUT -o lo -j ACCEPT\n-A INPUT  -p icmp -j ACCEPT\n-A OUTPUT -p icmp -j ACCEPT\n#------------------------------------------------------\n# \u5185\u90e8\u304b\u3089\u306eDNS\u9001\u4fe1\u3092\u8a31\u53ef\n#------------------------------------------------------\n-A OUTPUT -m state --state NEW -m udp -p udp --dport 53   -j ACCEPT\n#------------------------------------------------------\n# \u5185\u90e8\u304b\u3089\u306ehttp\u9001\u4fe1\u3092\u8a31\u53ef\uff08yum\u7b49\uff09\n#------------------------------------------------------\n-A OUTPUT -m state --state NEW -m tcp -p tcp --dport 80   -j ACCEPT\n#------------------------------------------------------\n# \u30e1\u30f3\u30c6\u30ca\u30f3\u30b9\u306e\u307fSSH\u63a5\u7d9a\u3092\u8a31\u53ef\n#------------------------------------------------------\n-A INPUT  -s web01 -p tcp --dport 3843 -j ACCEPT\n-A OUTPUT -d web01 -p tcp --sport 3843 -j ACCEPT\n-A INPUT  -s web02 -p tcp --dport 3843 -j ACCEPT\n-A OUTPUT -d web02 -p tcp --sport 3843 -j ACCEPT\n-A INPUT  -s db01s -p tcp --dport 3843 -j ACCEPT\n-A OUTPUT -d db01s -p tcp --sport 3843 -j ACCEPT\n#------------------------------------------------------\n# \u30e1\u30f3\u30c6\u30ca\u30f3\u30b9\u306e\u307fMySQL\u63a5\u7d9a\u3092\u8a31\u53ef\n#------------------------------------------------------\n-A INPUT  -s web01 -p tcp --dport 3306 -j ACCEPT\n-A OUTPUT -d web01 -p tcp --sport 3306 -j ACCEPT\n-A INPUT  -s web02 -p tcp --dport 3306 -j ACCEPT\n-A OUTPUT -d web02 -p tcp --sport 3306 -j ACCEPT\n-A INPUT  -s db01s -p tcp --dport 3306 -j ACCEPT\n-A OUTPUT -d db01s -p tcp --sport 3306 -j ACCEPT\n#------------------------------------------------------\n# \u63a5\u7d9a\u6e08\u307f\u30d1\u30b1\u30c3\u30c8\u306e\u9001\u53d7\u4fe1\u3092\u8a31\u53ef\n#------------------------------------------------------\n-A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT\n-A OUTPUT -m state --state ESTABLISHED,RELATED -j ACCEPT\nCOMMIT\n\n\nDB\u30b5\u30fc\u30d0\u30fc\uff08db01s\uff09\u306e\u8a2d\u5b9a\n\u203bIP\u30a2\u30c9\u30ec\u30b9\u3092\u30db\u30b9\u30c8\u540d\u306b\u7f6e\u304d\u63db\u3048\u3066\u307e\u3059\u3002\n*filter\n#------------------------------------------------------\n# \u30e1\u30f3\u30c6\u30ca\u30f3\u30b9\u53ef\u80fd\u30ea\u30b9\u30c8\n# web01\n# web02\n# db01m\n#------------------------------------------------------\n#------------------------------------------------------\n# \u30dd\u30ea\u30b7\u30fc\uff1a\u5168\u3066\u306e\u9001\u53d7\u4fe1\u30d1\u30b1\u30c3\u30c8\u3092\u7834\u68c4\u3002\u5fc5\u8981\u306a\u7528\u9014\u306b\u5fdc\u3058\u3066\u958b\u3051\u3066\u3044\u304f\u3002\n#------------------------------------------------------\n:INPUT DROP [0:0]\n:FORWARD DROP [0:0]\n:OUTPUT DROP [0:0]\n#------------------------------------------------------\n# ping\u3068\u30eb\u30fc\u30d7\u30d0\u30c3\u30af\u30a2\u30c9\u30ec\u30b9\uff08\u81ea\u5206\u81ea\u8eab\u306eIP\uff09\u304b\u3089\u306e\u9001\u53d7\u4fe1\u3092\u8a31\u53ef\n#------------------------------------------------------\n-A INPUT -i lo -j ACCEPT\n-A OUTPUT -o lo -j ACCEPT\n-A INPUT  -p icmp -j ACCEPT\n-A OUTPUT -p icmp -j ACCEPT\n#------------------------------------------------------\n# \u5185\u90e8\u304b\u3089\u306eDNS\u9001\u4fe1\u3092\u8a31\u53ef\n#------------------------------------------------------\n-A OUTPUT -m state --state NEW -m udp -p udp --dport 53   -j ACCEPT\n#------------------------------------------------------\n# \u5185\u90e8\u304b\u3089\u306ehttp\u9001\u4fe1\u3092\u8a31\u53ef\uff08yum\u7b49\uff09\n#------------------------------------------------------\n-A OUTPUT -m state --state NEW -m tcp -p tcp --dport 80   -j ACCEPT\n#------------------------------------------------------\n# \u30e1\u30f3\u30c6\u30ca\u30f3\u30b9\u306e\u307fSSH\u63a5\u7d9a\u3092\u8a31\u53ef\n#------------------------------------------------------\n-A INPUT  -s web01 -p tcp --dport 3843 -j ACCEPT\n-A OUTPUT -d web01 -p tcp --sport 3843 -j ACCEPT\n-A INPUT  -s web02 -p tcp --dport 3843 -j ACCEPT\n-A OUTPUT -d web02 -p tcp --sport 3843 -j ACCEPT\n-A INPUT  -s db01m -p tcp --dport 3843 -j ACCEPT\n-A OUTPUT -d db01m -p tcp --sport 3843 -j ACCEPT\n#------------------------------------------------------\n# \u30e1\u30f3\u30c6\u30ca\u30f3\u30b9\u306e\u307fMySQL\u63a5\u7d9a\u3092\u8a31\u53ef\n#------------------------------------------------------\n-A INPUT  -s web01 -p tcp --dport 3306 -j ACCEPT\n-A OUTPUT -d web01 -p tcp --sport 3306 -j ACCEPT\n-A INPUT  -s web02 -p tcp --dport 3306 -j ACCEPT\n-A OUTPUT -d web02 -p tcp --sport 3306 -j ACCEPT\n-A INPUT  -s db01m -p tcp --dport 3306 -j ACCEPT\n-A OUTPUT -d db01m -p tcp --sport 3306 -j ACCEPT\n#------------------------------------------------------\n# \u63a5\u7d9a\u6e08\u307f\u30d1\u30b1\u30c3\u30c8\u306e\u9001\u53d7\u4fe1\u3092\u8a31\u53ef\n#------------------------------------------------------\n-A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT\n-A OUTPUT -m state --state ESTABLISHED,RELATED -j ACCEPT\nCOMMIT\n\n\u3059\u3079\u3066\u306e\u8a2d\u5b9a\u3092\u66f8\u304d\u7d42\u3048\u305f\u3089iptables\u3092\u518d\u8d77\u52d5\u3057\u3066\u30d5\u30a1\u30a4\u30a2\u30a6\u30a9\u30fc\u30eb\u3092\u6709\u52b9\u5316\n$ service iptables restart\n\n\u30d5\u30a1\u30a4\u30a2\u30a6\u30a9\u30fc\u30eb\u306e\u8a2d\u5b9a\u306f\u4ee5\u4e0a\u3002\n\u958b\u767a\u74b0\u5883\u306e\u30d5\u30a1\u30a4\u30a2\u30a6\u30a9\u30fc\u30eb\u306f\u4efb\u610f\u3067\u8a2d\u5b9a\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\nMySQL\uff08\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u30b5\u30fc\u30d0\u30fc\uff09\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\nMysql\u306e\u30d1\u30c3\u30b1\u30fc\u30b8\u306b\u3064\u3044\u3066\nmysql\u306e\u30d1\u30c3\u30b1\u30fc\u30b8\u306b\u306f\u5927\u304d\u304f\u5206\u3051\u3066\uff13\u7a2e\u985e\u3042\u308b\n\nmysql\uff1aclient\u7528\nmysql-server\uff1aserver\u7528\nmysql-devel\uff1a\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3068\u306e\u9023\u643a\u7528\n\n\u305d\u306e\u305f\u3081\u3001\u7528\u9014\u306b\u3088\u3063\u3066\u306f\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u30d1\u30c3\u30b1\u30fc\u30b8\u3092\u7d5e\u308b\u3053\u3068\u304c\u53ef\u80fd\nterminal\u304b\u3089mysql\u306b\u63a5\u7d9a\u3059\u308b\n\nmysql\n\nrails\u3084mydns\u7b49\u306e\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u304b\u3089mysql\u30b5\u30fc\u30d0\u30fc\u306b\u63a5\u7d9a\n\nmysql\u3001mysql-devel\n\n\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u904b\u7528\n\nmysql-server\n\n\u4eca\u56de\u306f\u30b5\u30fc\u30d0\u30fc\u3054\u3068\u306b\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u30d1\u30c3\u30b1\u30fc\u30b8\u3092\u5909\u3048\u308b\n\nMySQL\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\nrp01\uff08DNS\u30b5\u30fc\u30d0\u30fc\u7528\u3068\u3057\u3066\u4f7f\u3046\uff09\n$ yum install mysql mysql-devel mysql-server\nweb01\u3001web02\uff08rails\u7528\u306b\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\uff09\n$ yum install mysql mysql-devel\ndb01m\u3001db01s\uff08mysql\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u7528\uff09\n$ yum install mysql mysql-server\n\nmysql\u306e\u8a2d\u5b9a\n\u4ee5\u4e0b\u3092\u30b5\u30fc\u30d0\u30fc5\u53f0\u5168\u3066\u306b\u8a2d\u5b9a\u3059\u308b\nmysql\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u3059\u308b\n$ sudo cp /etc/my.cnf /etc/my.cnf.org\nMySQL\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\n$ sudo cp /etc/my.cnf /etc/my.cnf.org\nMySQL\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092\u4e0b\u8a18\u306e\u3088\u3046\u306b\u8a2d\u5b9a\n\n/etc/my.cnf\n\n[mysqld]\ncharacter-set-server = utf8\nskip-character-set-client-handshake\ndatadir=/var/lib/mysql\nsocket=/var/lib/mysql/mysql.sock\nuser=mysql\nsymbolic-links=0\n\ninnodb_buffer_pool_size = 512MB # \u30b5\u30fc\u30d0\u306e\u30e1\u30e2\u30ea70\u301c80%\ninnodb_log_file_size = 100MB # 100-500MB\u7a0b\u5ea6\ninnodb_flush_log_at_trx_commit = 2\n\n[mysqld_safe]\nlog-error=/var/log/mysqld.log\npid-file=/var/run/mysqld/mysqld.pid          \n\n\nroot\u306e\u30d1\u30b9\u30ef\u30fc\u30c9\u8a2d\u5b9a\n$ sudo mysqladmin -u root password '\u30d1\u30b9\u30ef\u30fc\u30c9'\n\nmysql-server\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3066\u3044\u308b\nrp01\u3068db01m\u3001db02m\u306e\u307fMySQL\u306e\u81ea\u52d5\u8d77\u52d5\u3092ON\u306b\u3059\u308b\n$ sudo service mysqld start\n$ sudo chkconfig mysqld on\n\nMySQL\u306b\u30ed\u30b0\u30a4\u30f3\u3057\u3001\u4e0d\u8981\u306a\u30e6\u30fc\u30b6\u30fc\u3068\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u3092\u524a\u9664\u3059\u308b\n$ mysql -u root -p ****\n\nmysql \uff1e use mysql;\nmysql \uff1e select user,password, host from user;\n+------+-------------------------------------------+-------------------------+\n| user | password                                  | host                    |\n+------+-------------------------------------------+-------------------------+\n| root | *hogehogehogehogehogehogehogehogehogehoge | localhost               |\n| root |                                           | hogehogehogehogeh.ne.jp |\n| root |                                           | 127.0.0.1               |\n|      |                                           | localhost               |\n|      |                                           | hogehogehogehogeh.ne.jp |\n+------+-------------------------------------------+-------------------------+\nmysql\u3000\uff1e DELETE FROM user WHERE user = '' OR ( user = 'root' AND host != 'localhost' );\nQuery OK, 4 rows affected (0.00 sec)\n\nmysql\u3000\uff1e select user,password, host from user;\n+------+-------------------------------------------+-----------+\n| user | password                                  | host      |\n+------+-------------------------------------------+-----------+\n| root | *hogehogehogehogehogehogehogehogehogehoge | localhost |\n+------+-------------------------------------------+-----------+\n1 row in set (0.00 sec)\n\n\u7d9a\u3044\u3066\u3001\u4e0d\u8981\u306a\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u3092\u524a\u9664\nmysql \uff1e show databases;\n+--------------------+\n| Database           |\n+--------------------+\n| information_schema |\n| mysql              |\n| test               |\n+--------------------+\n3 rows in set (0.00 sec)\n\nmysql\uff1e DROP DATABASE test;\nQuery OK, 0 rows affected (0.00 sec)\n\n\n\u6587\u5b57\u30bb\u30c3\u30c8\u306e\u78ba\u8a8d\nshow variables like 'character_set%';\n# \u2193 \u306e\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u308c\u3070\u6210\u529f\n+--------------------------+----------------------------+\n| Variable_name            | Value                      |\n+--------------------------+----------------------------+\n| character_set_client     | utf8                       |\n| character_set_connection | utf8                       |\n| character_set_database   | utf8                       |\n| character_set_filesystem | binary                     |\n| character_set_results    | utf8                       |\n| character_set_server     | utf8                       |\n| character_set_system     | utf8                       |\n| character_sets_dir       | /usr/share/mysql/charsets/ |\n+--------------------------+----------------------------+\n8 rows in set (0.00 sec)\n\n\nrails\u7528\u306e\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u3092\u4f5c\u6210\nmysql > create database app;\nmysql > create database app_test;\nmysql > create database app_dev;\n\n\nmydns\uff08DNS\u30b5\u30fc\u30d0\u30fc\uff09\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\nmydns\u3068\u306f\uff1f\nMySQL\u306e\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u3092\u4f7f\u3063\u3066\u3001\u30db\u30b9\u30c8\u540d\u306e\u7ba1\u7406\u304c\u3067\u304d\u308b\u3002\n\u30db\u30b9\u30c8\u3092\u8ffd\u52a0\u3059\u308b\u3068\u304d\u306finsert\u6587\u3092\uff11\u3064\u6253\u3064\u3060\u3051\u3067\u8a2d\u5b9a\u53ef\u80fd\u306a\u306e\u3067\u7ba1\u7406\u304c\u697d\u3002\n\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u306b\u3064\u3044\u3066\nMyDNS\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u306f\u4efb\u610f\u3002\nSSH\u63a5\u7d9a\u3084iptables\u3001apache\u8a2d\u5b9a\u3067ip\u3092\u4f7f\u308f\u305a\u30db\u30b9\u30c8\u540d\u3092\u4f7f\u3044\u305f\u3044\u4eba\u306f\n\u8a2d\u5b9a\u3057\u3066\u304f\u3060\u3055\u3044\u3002\uff08\u3053\u306e\u8a18\u4e8b\u306f\u5168\u3066\u30db\u30b9\u30c8\u540d\u306b\u306a\u3063\u3066\u3044\u307e\u3059\uff09\n\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u65b9\u6cd5\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u306frp01\u3067\u884c\u3044\u307e\u3059\u3002\nmydns\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3059\u308b\u305f\u3081\u306e\u30ea\u30dd\u30b8\u30c8\u30ea\u3092\u8ffd\u52a0\nrpm -Uvh http://dl.fedoraproject.org/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm\n\nmydns\u30d1\u30c3\u30b1\u30fc\u30b8\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n$ yum install mydns\n$ yum install mydns-mysql\n\nmysql\u306b\u30ed\u30b0\u30a4\u30f3\u3057\u3001mydns\u7528\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u3092\u4f5c\u6210\nmysql > create database mydns;\n\n\u30bf\u30fc\u30df\u30ca\u30eb\u304b\u3089\u4e0b\u8a18\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\n$ mydns --create-tables | mysql -u root -p mydns\nmysql\u306b\u30ed\u30b0\u30a4\u30f3\u3057\u3001mydns\u7528\u306e\u30c6\u30fc\u30d6\u30eb\u304c\u3067\u304d\u3066\u3044\u308b\u304b\u78ba\u8a8d\nmysql > use mydns;\n\nDatabase changed\nmysql> show tables;\n+-----------------+\n| Tables_in_mydns |\n+-----------------+\n| rr              |\n| soa             |\n+-----------------+\n\nmydns\u7528\u306e\u30e6\u30fc\u30b6\u30fc\u3092\u4f5c\u6210\u3059\u308b\u3002\n\u203b\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9mydns\u306b\u5bfe\u3057\u3066\u3001\u5168\u3066\u306e\u6a29\u9650\u3092\u6301\u3063\u305f\u30e6\u30fc\u30b6\u30fc\uff08\u5168\u3066\u306e\u30db\u30b9\u30c8\u304b\u3089\u306e\u30a2\u30af\u30bb\u30b9\u8a31\u53ef\uff09\nGRANT ALL ON mydns.* TO 'mydns'@'%' IDENTIFIED BY 'mydns';\nQuery OK, 0 rows affected (0.01 sec)\n\nDNS\u30be\u30fc\u30f3\u3068\u30ec\u30b3\u30fc\u30c9\u306e\u4f5c\u6210\n\u203b\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u3092xxx.local\u306b\u3059\u308b\n\u203bxxx.xxx.xxx.xxx\u306fIP\u30a2\u30c9\u30ec\u30b9\u3067\u3059\nmysql> insert into soa (origin, ns) values ('local.', 'ns.local');\nQuery OK, 1 row affected, 1 warning (0.00 sec)\n\nmysql> insert into rr (zone, name, type, data) values(1, 'web01', 'A', \u2018xxx.xxx.xxx.xxx\u2019);\nQuery OK, 1 row affected, 1 warning (0.00 sec)\n\nmysql> insert into rr (zone, name, type, data) values(1, 'web02', 'A', 'xxx.xxx.xxx.xxx\u2019);\nQuery OK, 1 row affected, 1 warning (0.00 sec)\n\nmysql> insert into rr (zone, name, type, data) values(1, 'db01m', 'A', 'xxx.xxx.xxx.xxx\u2019);\nQuery OK, 1 row affected, 1 warning (0.00 sec)\n\nmysql> insert into rr (zone, name, type, data) values(1, 'db01s', 'A', 'xxx.xxx.xxx.xxx\u2019);\nQuery OK, 1 row affected, 1 warning (0.00 sec)\n\nmysql> insert into rr (zone, name, type, data) values(1, \u2018rp01,   'A', 'xxx.xxx.xxx.xxx\u2019);\nQuery OK, 1 row affected, 1 warning (0.00 sec)\n\nmysql> insert into rr (zone, name, type, data) values(1, \u2018dev01\u2019, 'A', 'xxx.xxx.xxx.xxx\u2019);\nQuery OK, 1 row affected, 1 warning (0.00 sec)\n\nmysql> select * from rr;\n+----+------+-------+------------------+-----+-------+------+\n| id | zone | name  | data             | aux | ttl   | type |\n+----+------+-------+------------------+-----+-------+------+\n|  1 |    1 | web01 | xxx.xxx.xxx.xxx  |   0 | 86400 | A    |\n|  2 |    1 | web02 | xxx.xxx.xxx.xxx  |   0 | 86400 | A    |\n|  3 |    1 | db01m | xxx.xxx.xxx.xxx  |   0 | 86400 | A    |\n|  4 |    1 | db01s | xxx.xxx.xxx.xxx  |   0 | 86400 | A    |\n|  5 |    1 | rp01  | xxx.xxx.xxx.xxx  |   0 | 86400 | A    |\n|  6 |    1 | dev01 | xxx.xxx.xxx.xxx  |   0 | 86400 | A    |\n+----+------+-------+------------------+-----+-------+------+\n\nmysql > select * from soa;\n+----+--------+----------+------+--------+---------+-------+--------+---------+-------+\n| id | origin | ns       | mbox | serial | refresh | retry | expire | minimum | ttl   |\n+----+--------+----------+------+--------+---------+-------+--------+---------+-------+\n|  1 | local. | ns.local |      |      1 |   28800 |  7200 | 604800 |   86400 | 86400 |\n+----+--------+----------+------+--------+---------+-------+--------+---------+-------+\n1 row in set (0.00 sec)\n\n\nDNS\u306e\u8a2d\u5b9a\u3068mydns\u306e\u8d77\u52d5\n\u30db\u30b9\u30c8\u540d\u3067\u901a\u4fe1\u3057\u305f\u3044\u3059\u3079\u3066\u306e\u30b5\u30fc\u30d0\u30fc\u3067\u4e0b\u8a18\u3092\u8a2d\u5b9a\nxxx.xxx.xxx.xxx\u306frp01\u306e\u30b0\u30ed\u30fc\u30d0\u30ebIP\u30a2\u30c9\u30ec\u30b9\n\n/etc/resolv.conf\nsearch local\nnameserver xxx.xxx.xxx.xxx\n\n\nmydns\u3092\u8d77\u52d5\n$ service mydns start\n\n\u8a2d\u5b9a\u3057\u305f\u30db\u30b9\u30c8\u540d\u3067ping\u304c\u901a\u308b\u304b\u78ba\u8a8d\nping web01\n\n\n\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u8a2d\u5b9a\n\n\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3068\u306f\n\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306e\u5185\u5bb9\u3092\u5225\u306e\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306b\u30ea\u30a2\u30eb\u30bf\u30a4\u30e0\u3067\u540c\u671f\u3055\u305b\u308b\u3002\n\u30b3\u30d4\u5143\u3092\u30de\u30b9\u30bf\u30fc\u3001\u30b3\u30d4\u30fc\u5148\u3092\u30b9\u30ec\u30fc\u30d6\u3068\u3044\u3046\u3002\n\n\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u8a2d\u5b9a\u65b9\u6cd5\n\u30de\u30b9\u30bf\u30fc\u306edb01m\u306emy.cnf\u3092\u4e0b\u8a18\u306e\u3088\u3046\u306b\u8a2d\u5b9a\n\n/etc/my.cnf\n[mysqld]\nlog-bin=mysql-bin\nserver-id=1001\n\n\n\u30b9\u30ec\u30fc\u30d6\u306edb01s\u306b\u30de\u30b9\u30bf\u30fc\u306b\u63a5\u7d9a\u3059\u308bmysql\u30e6\u30fc\u30b6\u30fc\u3092\u4f5c\u6210\u3059\u308b\u305f\u3081\u3001\ndb01s\u306emysql\u306b\u30ed\u30b0\u30a4\u30f3\u3057\u3066\u3001\u4e0b\u8a18\u3092\u5b9f\u884c\n\u203bxxx.xxx.xxx.xxx\u306fmaster\u306eip\u30a2\u30c9\u30ec\u30b9\nGRANT REPLICATION SLAVE ON *.* TO 'repl\u2019@\u2018xxx.xxx.xxx.xxx\u2019 IDENTIFIED BY 'slavepass';\n\n\u30b9\u30ec\u30fc\u30d6\u306emy.cnf\u30d5\u30a1\u30a4\u30eb\u5185\u3067\u4ee5\u4e0b\u306e\u901a\u308a\u8a2d\u5b9a\n\n/etc/my.cnf\n[mysqld]\nserver-id=1002\n\n\n\u30de\u30b9\u30bf\u30fc\u5074\u306eposition\u3092\u78ba\u8a8d\nmysql>  SHOW MASTER STATUS;\n+------------------+----------+--------------+------------------+\n| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB |\n+------------------+----------+--------------+------------------+\n| mysql-bin.000002 |      379 |              |                  |\n+------------------+----------+--------------+------------------+\n1 row in set (0.00 sec)\n\n\u305d\u308c\u305e\u308c\u306e\u610f\u5473\nFile        : \u30d0\u30a4\u30ca\u30ea\u30ed\u30b0\u540d\nPosition  : \u30d5\u30a1\u30a4\u30eb\u5185\u306e\u30aa\u30d5\u30bb\u30c3\u30c8\uff08\u73fe\u5728\u4f4d\u7f6e\uff09\nPosition\u3068\u30d5\u30a1\u30a4\u30eb\u540d\u3092\u30e1\u30e2\u3057\u3066\u304a\u304d\u3001\u30de\u30b9\u30bf\u30fc\u306e\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306e\u30c6\u30fc\u30d6\u30eb\u3092\u30ed\u30c3\u30af\u3057\u3066\u304a\u304f\nmysql > FLUSH TABLES WITH READ LOCK\n\n\u30de\u30b9\u30bf\u30fc\u306e\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306e\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u3092\u53d6\u308b\n$ mysqldump -u root -p --all-databases --lock-all-tables > /tmp/dbdump.db\n\u30b9\u30ec\u30fc\u30d6\u5074\u3067SCP\u30b3\u30de\u30f3\u30c9\u3092\u4f7f\u3063\u3066\u3001\u30de\u30b9\u30bf\u30fc\u306edb\u30d5\u30a1\u30a4\u30eb\u3092\u53d6\u5f97\n$ scp -P ssh\u306e\u30dd\u30fc\u30c8\u756a\u53f7 deploy01@db01m :/tmp/dbdump.db /tmp/\n\u30b9\u30ec\u30fc\u30d6\u306e\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306b\u30de\u30b9\u30bf\u30fc\u306e\u5185\u5bb9\u3092\u53cd\u6620\n# mysql -u root -p /tmp/dbdump.db\n\u30b9\u30ec\u30fc\u30d6\u5074\u3067\u30de\u30b9\u30bf\u30fc\u60c5\u5831\u3092\u767b\u9332\nxxx.xxx.xxx.xxx\u306b\u306f\u30de\u30b9\u30bf\u30fc\u306eip\u30a2\u30c9\u30ec\u30b9\u3092\u5165\u308c\u308b\nmysql > CHANGE MASTER TO\n           MASTER_HOST=\u2018xxx.xxx.xxx.xxx\u2019,\n           MASTER_USER='repl',\n           MASTER_PASSWORD='XXXXXX',\n           MASTER_LOG_FILE='mysql-bin.000002',\n           MASTER_LOG_POS=379;\n\n\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u958b\u59cb\u3059\u308b\u305f\u3081\u3001\u30b9\u30ec\u30fc\u30d6\u5074\u3067\u4e0b\u8a18\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\nmysql > START SLAVE;\n\n\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u304c\u958b\u59cb\u3055\u308c\u3066\u3044\u308b\u304b\u78ba\u8a8d\nshow slave status;\n\nmysql> show slave status \\G\n*************************** 1. row ***************************\n               Slave_IO_State: Waiting for master to send event\n                  Master_Host: xxx.xxx.xxx.xxx\n                  Master_User: repl\n                  Master_Port: 3306\n                Connect_Retry: 60\n              Master_Log_File: mysql-bin.000002\n          Read_Master_Log_Pos: 450\n               Relay_Log_File: mysqld-relay-bin.000003\n                Relay_Log_Pos: 251\n        Relay_Master_Log_File: mysql-bin.000002\n             Slave_IO_Running: Yes\n            Slave_SQL_Running: Yes\n\n\u4e0b\u8a18\u3092\u78ba\u8a8d\u3067\u304d\u308c\u3070DB\u306e\u540c\u671f\u304c\u53d6\u308c\u3066\u3044\u308b\nSlave_IO_Running: Yes\nSlave_SQL_Running: Yes\n\n\nRuby\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\u4f5c\u696d\u306fweb01\u3068web02\u3067\u884c\u3046\nroot\u30e6\u30fc\u30b6\u30fc\u3067\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u3068\u3001root\u6a29\u9650\u304c\u5fc5\u8981\u306a\u3068\u304d\u304c\u3042\u308b\u305f\u3081\ndeploy01\u30e6\u30fc\u30b6\u30fc\u306b\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3092\u884c\u3046\u3002\uff08\u30b7\u30f3\u30b0\u30eb\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\uff09\n\nrvm\u3092\u4f7f\u3063\u305fRuby\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\nrvm\u306fRuby\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u7ba1\u7406\u3092\u5bb9\u6613\u306b\u884c\u3048\u308b\u3002\n\u30b3\u30de\u30f3\u30c9\uff11\u3064\u3067\u30d0\u30fc\u30b8\u30e7\u30f3\u3092\u5207\u308a\u66ff\u3048\u305f\u308a\u3001\u30d0\u30fc\u30b8\u30e7\u30f3\u3054\u3068\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u304c\u53ef\u80fd\n\u5fc5\u8981\u306a\u30d1\u30c3\u30b1\u30fc\u30b8\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n$ sudo yum -y install curl curl-devel gcc gcc-c++ httpd-devel readline-devel tk-devel make zlib-devel libffi-devel\n\nrvm\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n$ bash -s stable < <(curl -s https://raw.github.com/wayneeseguin/rvm/master/binscripts/rvm-installer )\n$ echo \"source $HOME/.rvm/scripts/rvm\" >> ~/.bash_profile\n$ source ~/.bash_profile\n\nRuby\u306ever 2.0.0\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n$ rvm install 2.0.0\n\nRVM\u306e\u8a2d\u5b9a\u78ba\u8a8d\n$ rvm list\n=* ruby-2.0.0-p247 [ x86_64 ] # \n\n\nrails\u306e\u5c0e\u5165\nrails\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\uff08RDoc\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u90e8\u5206\u3067\u7d50\u69cb\u6642\u9593\u304b\u304b\u308b\uff09\n$ gem install rails\n\nRDoc\u304c\u4e0d\u8981\u306a\u5834\u5408\u306f\u4e0b\u8a18\u3067\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\n$ gem install rails \u2013no-ri \u2013no-rdoc\n\npassanger\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3092\u884c\u3046\n$ gem install passenger\n$ passenger-install-apache2-module\n\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u5b8c\u4e86\u5f8c\u3001\u4e0b\u8a18\u306e\u3088\u3046\u306a\u8868\u793a\u304c\u51fa\u308b\u306e\u3067\u30b3\u30d4\u30fc\nLoadModule passenger_module /usr/lib64/ruby/gems/1.8/gems/passenger-4.0.19/buildout/apache2/mod_passenger.so\nPassengerRoot /usr/lib64/ruby/gems/1.8/gems/passenger-4.0.19\nPassengerDefaultRuby /usr/bin/ruby\n\npassenger.conf\u306b\u4e0a\u8a18\u8a2d\u5b9a\u3068\u30aa\u30d7\u30b7\u30e7\u30f3\u3092\u8a18\u5165\n\n/etc/httpd/conf.d/passnger.conf\n# Passenger\u306e\u57fa\u672c\u8a2d\u5b9a\nLoadModule passenger_module /usr/local/rvm/gems/ruby-2.0.0-p247@global/gems/passenger-4.0.18/buildout/apache2/mod_passenger.so\nPassengerRoot /usr/local/rvm/gems/ruby-2.0.0-p247@global/gems/passenger-4.0.18\nPassengerDefaultRuby /usr/local/rvm/wrappers/ruby-2.0.0-p247@global/ruby\n\n# Passenger\u304c\u8ffd\u52a0\u3059\u308bHTTP\u30d8\u30c3\u30c0\u3092\u524a\u9664\u3059\u308b\u305f\u3081\u306e\u8a2d\u5b9a\nHeader always unset \"X-Powered-By\"\nHeader always unset \"X-Rack-Cache\"\nHeader always unset \"X-Content-Digest\"\nHeader always unset \"X-Runtime\"\n\n# \u5fc5\u8981\u306b\u5fdc\u3058\u3066Passenger\u306e\u30c1\u30e5\u30fc\u30cb\u30f3\u30b0\u306e\u305f\u3081\u306e\u8a2d\u5b9a\u3092\u8ffd\u52a0\nPassengerMaxPoolSize 20\nPassengerMaxInstancesPerApp 4\nPassengerPoolIdleTime 3600\nPassengerHighPerformance on\nPassengerStatThrottleRate 10\nRailsSpawnMethod smart\nRailsAppSpawnerIdleTime 86400\nPassengerMaxPreloaderIdleTime 0\n\n\n\n\u30c7\u30d7\u30ed\u30a4\u7528\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u4f5c\u6210\ntest\u74b0\u5883\u3068prod\u74b0\u5883\u306e\uff12\u3064\u3092\u7528\u610f\u3059\u308b\n$ sudo mkdir /var/www/deploy01/\n$ sudo chown deploy01:deploy01 /var/www/deploy01/\n$ chmod 775 /var/www/deploy01/\n$ mkdir /var/www/deploy01/prod/\n$ mkdir /var/www/deploy01/test/\n\n\n\u958b\u767a\u74b0\u5883\u5074\u306e\u8a2d\u5b9a\n\u958b\u767a\u74b0\u5883\u5074\uff08dev01\uff09\u306fapp\u3068\u3044\u3046\u30a2\u30d7\u30ea\u304c\u51fa\u6765\u3066\u3044\u308b\u72b6\u6cc1\u3068\u3057\u307e\u3059\u3002\ndatabase.yml\u306bslave\u3068master\u306edb\u60c5\u5831\u3092\u8a2d\u5b9a\u3059\u308b\n\nconfig/database.yml\ndevelopment:\n  adapter: mysql2\n  encoding: utf8\n  database: app_dev\n  pool: 5\n  username: root\n  password: xxxx\n  host: localhost\n\ntest_slave_database:\n  adapter: mysql2\n  encoding: utf8\n  database: app_test\n  pool: 5\n  username: root\n  password: xxx\n  host: db01s\n\ntest:\n  adapter: mysql2\n  encoding: utf8\n  database: app_test\n  pool: 5\n  username: root\n  password: xxx\n  host: db01m\n\nproduction_slave_database:\n  adapter: mysql2\n  encoding: utf8\n  database: app\n  pool: 5\n  username: root\n  password: xxx\n  host: db01s\n\nproduction:\n  adapter: mysql2\n  encoding: utf8\n  database: app\n  pool: 5\n  username: root\n  password: xxx\n  host: db01m\n\n\nGemfile\u306b\u4e0b\u8a18\u30d1\u30c3\u30b1\u30fc\u30b8\u3092\u8a18\u8f09\u3059\u308b\n\nGemlife\ngem 'multi_db'\n\n\n\n\u30c7\u30d7\u30ed\u30a4\u30c4\u30fc\u30eb\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\nweb01\u3068web02\u306bgit\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n$ sudo yum install git\n\napp\u30a2\u30d7\u30ea\u914d\u4e0b\u3067\u4e0b\u8a18\u3092\u5b9f\u884c\n$ gem install capistrano\n\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u304c\u5b8c\u4e86\u3057\u305f\u3089capify\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\ncapify .\n> [add] writing './Capfile'\n> [add] writing './config/deploy.rb'\n> [done] capified!\n\ntest\u74b0\u5883\u3068prod\u74b0\u5883\u7528\u306eCapistrano\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\n$ mkdir config/deploy\n$ touch config/deploy/test.rb\n$ touch config/deploy/production.rb\n\n\u5171\u901a\u306e\u30c7\u30d7\u30ed\u30a4\u60c5\u5831\u3092deploy.rb\u306b\u8a18\u5165\nip\u30a2\u30c9\u30ec\u30b9\u3092\u30db\u30b9\u30c8\u540d\u306b\u5909\u3048\u3066\u307e\u3059\u3002\n\napp/config/deploy.rb\n# -*- coding: utf-8 -*-\nset :default_stage, \"production\"\n\n# \u8907\u6570\u74b0\u5883\u306b\u30c7\u30d7\u30ed\u30a4\u3067\u304d\u308b\u3088\u3046\u306b\u3059\u308b\nrequire \"capistrano/ext/multistage\"\n\n# capistrano\u306e\u51fa\u529b\u3092\u30ab\u30e9\u30fc\u306b\nrequire 'capistrano_colors'\n\n# cap deploy\u6642\u306b\u81ea\u52d5\u3067 bundle install\u3092\u5b9f\u884c\nrequire \"bundler/capistrano\"\n\n# RVM\nrequire \"rvm/capistrano\"\nset :rvm_ruby_string, \u20182.0.0-p353\u2019\nset :rvm_type, :user\n\n# git\u30ea\u30dd\u30b8\u30c8\u30ea\u306e\u8a2d\u5b9a\n#### git\u30ea\u30dd\u30b8\u30c8\u30ea\u3092\u30bb\u30c3\u30c8 ####\nset :repository,  \u201cgit\u306e\u30ea\u30dd\u30b8\u30c8\u30ea\u201d\nset :scm, :git\nset :deploy_via, :remote_cache\n\n# SSH\nset :use_sudo, false\nset :default_run_options, :pty => true\nssh_options[:port] = 22\nssh_options[:forward_agent] = true\n\nset :normalize_asset_timestamps, false\n# \u904e\u53bb\u306e\u30c7\u30d7\u30ed\u30a4\u3057\u305f\u30d5\u30a9\u30eb\u30c0\u3092\u5c65\u6b74\u3068\u3057\u3066\u4fdd\u6301\u3059\u308b\u6570\nset :keep_releases, 5\n\n# \u30c7\u30d7\u30ed\u30a4\u5148\u306e\u30b5\u30fc\u30d0\u306e\u8a2d\u5b9a\nserver \u201cweb01:3843\", :app, :web, :db, :primary => true\nserver \u201cweb02:3843\", :app, :web, :db, :primary => true\n\n# bundle install\u6761\u4ef6\nset :bundle_flags, \"--no-deployment --without test development\"\n\n# SSH\nset :user, \"deploy01\"\nset :user_group, \"deploy01\"\nset :password, \u201cSSH\u306e\u30ed\u30b0\u30a4\u30f3\u30d1\u30b9\u30ef\u30fc\u30c9\u201d\n\n# RVM\nset :rvm_path, '/home/deploy01/.rvm/'\nset :rvm_bin_path, \u201capp/bin\"\nset :rvm_lib_path, \u201capp/lib\"\n\n# assets:precompile\nnamespace :assets do\n  task :precompile, :roles => :web do\n    run \"cd #{current_path} && RAILS_ENV=#{rails_env} bundle exec rake assets:precompile\"\n  end\nend\n\n# \u30e1\u30f3\u30c6\u30ca\u30f3\u30b9\u30e2\u30fc\u30c9\nnamespace :maintenance do\n  desc \"Maintenance start\"\n  task :on, :roles => :web do\n    on_rollback { run \"rm #{current_path}/tmp/maintenance.yml\" }\n    page = File.read(\"config/maintenance.yml\")\n    put page, \"#{current_path}/tmp/maintenance.yml\", :mode => 0644\n  end\n\n  desc \"Maintenance stop\"\n  task :off, :roles => :web do\n    run \"rm #{release_path}/tmp/maintenance.yml\"\n  end\nend\n\nnamespace :deploy do\n  # Passenger\u306e\u5b9f\u884c\u30e6\u30fc\u30b6\u30fc/Group\u3092\u30bb\u30c3\u30c8\n  task :set_file_process_owner do\n    sudo \"chown -R #{user}:#{user_group} #{deploy_to}\"\n  end\n\n  #### sitemap_generator\u3092\u4f7f\u3063\u3066\u306a\u3044\u5834\u5408\u306f\u524a\u9664 ####\n  desc \"sitemap\u306e\u66f4\u65b0\"\n  task :refresh_sitemaps do\n    run \"cd #{latest_release} && RAILS_ENV=#{rails_env} bundle exec rake sitemap:refresh\"\n  end\n\n  # \u672c\u756a\u30b5\u30fc\u30d0\u3067Passenger\u4ee5\u5916\u3092\u4f7f\u3063\u3066\u3044\u308b\u5834\u5408\u306f\u9069\u5b9c\u5909\u66f4\u3057\u3066\u4e0b\u3055\u3044\u3002\n  desc \"Passenger\u7528\u306b\u8d77\u52d5/\u505c\u6b62\u30bf\u30b9\u30af\u3092\u5909\u66f4\"\n  task :restart, :roles => :web do\n    run \"touch #{current_path}/tmp/restart.txt\"\n  end\n\n  # page_cache\u3092\u4f7f\u7528\u3057\u3066\u3044\u306a\u3044\u5834\u5408\u306f\u4e0d\u8981\n  desc \"\u30ad\u30e3\u30c3\u30b7\u30e5html\u306e\u524a\u9664(deploy\u4e2d\u306b\u4e0d\u5b8c\u5168\u306ahtml\u3092\u751f\u6210\u3057\u306a\u3044\u305f\u3081\u306e\u5bfe\u7b56)\"\n  task :remove_caches, :roles => :web do\n    run \"rm -rf #{current_path}/public/index.html\"\n  end\n\n  #### Whenever\u3092\u4f7f\u3063\u3066\u3044\u306a\u3044\u5834\u5408\u306f\u524a\u9664\n  desc \"whenever\u306e\u30a2\u30c3\u30d7\u30c7\u30fc\u30c8\"\n  task :whenever_update do\n    run \"cd #{latest_release} && RAILS_ENV=#{rails_env} bundle exec whenever --update-crontab #{application} -f config/schedule_#{rails_env}.rb\"\n  end\nend\nbefore :deploy, \"deploy:set_file_process_owner\"\n\n\nprod\u7528\u306e\u8a2d\u5b9a\n\napp/config/deploy/production.rb\n#### \u30c7\u30d7\u30ed\u30a4\u5148\u306e\u30d5\u30a9\u30eb\u30c0\u3092\u8a2d\u5b9a\u3000####\nset :deploy_to, \"/var/www/deploy01/prod/app\u201d\nset :rails_env, \"production\"\n\n# deploy ==========================\nafter :deploy, \"maintenance:on\"\nafter :deploy, \"assets:precompile\"\nafter :deploy, \"deploy:migrate\"\nafter :deploy, \"deploy:restart\"\nafter :deploy, \"deploy:remove_caches\"\nafter :deploy, \"maintenance:off\"\nafter :deploy, \"deploy:cleanup\"\n\n\ntest\u7528\u306e\u8a2d\u5b9a\n\napp/config/deploy/test.rb\n#### \u30c7\u30d7\u30ed\u30a4\u5148\u306e\u30d5\u30a9\u30eb\u30c0\u3092\u8a2d\u5b9a\u3000####\nset :deploy_to, \"/var/www/deploy01/test/app\u201d\nset :rails_env, \u201ctest\u201d\n\n# deploy ==========================\nafter :deploy, \"assets:precompile\"\nafter :deploy, \"deploy:migrate\"\nafter :deploy, \"deploy:restart\"\nafter :deploy, \"deploy:remove_caches\"\nafter :deploy, \"deploy:cleanup\"\n\n\n\u30e1\u30f3\u30c6\u30ca\u30f3\u30b9\u753b\u9762\u8868\u793a\u7528\u306bconfig/maintenance.yml\u3092\u8ffd\u52a0\u3002 \n---\nreason: \u30e1\u30f3\u30c6\u30ca\u30f3\u30b9\u4e2d\u3067\u3059\nallowed_paths:\n- ^/help\n- ^/contact_us\nallowed_ips:\n- 127.0.0.1\n- 192.168.0.0/24\n\n\u30ea\u30dd\u30b8\u30c8\u30ea\u3078\u306e\u30d1\u30b9\u30d5\u30ec\u30fc\u30ba\u5165\u529b\u3092\u7701\u7565\u3059\u308b\u305f\u3081\u3001ssh-agent\u306e\u8ffd\u52a0\u3092\u3059\u308b\n\u203b\u9375\u306b\u306fgit\u30ea\u30dd\u30b8\u30c8\u30ea\u306e\u79d8\u5bc6\u9375\u3092\u6307\u5b9a\n# ssh-agent zsh\n# ssh-agent ~/.ssh/id_rsa\n\n\u30c7\u30d7\u30ed\u30a4\u304c\u3067\u304d\u308b\u304b\u306e\u30c6\u30b9\u30c8\uff08\u521d\u56de\u306e\u307f\uff09\ncap deploy:check\n\n\u30c7\u30d7\u30ed\u30a4\u30b3\u30de\u30f3\u30c9\u4e00\u89a7\n\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\uff08\u521d\u56de\u306b\u5b9f\u884c\uff09\n$ cap production deploy:setup\n$ cap test deploy:setup\n\n\u30c7\u30d7\u30ed\u30a4\u3092\u5b9f\u884c\n$ cap production deploy:cold\n$ cap test deploy:cold\n\n\u4ee5\u524d\u306e\u72b6\u614b\u306b\u623b\u3059\n$ cap production deploy:rollback\n$ cap test deploy:rollback\n\n\u4ee5\u524d\u306e\u72b6\u614b\u306e\u30bd\u30fc\u30b9\u30b3\u30fc\u30c9\u3092\u524a\u9664\n$ cap production deploy:cleanup\n$ cap test deploy:cleanup\n\n\nApache\u306e\u8a2d\u5b9a\ndeploy\u304c\u5b8c\u4e86\u3057\u305f\u3089web01\u3068web02\u306ehttpd.conf\u306brails\u30a2\u30d7\u30ea\u306e\u8a2d\u5b9a\u3092\u884c\u3046\nxxx.xxx.xxx.xxx\u306b\u306fweb01\u306a\u3089web01\u306eIP\u3092\u8a18\u5165\n\n/etc/httpd/conf/httpd.conf\n# prod\n<VirtualHost *:80>\n  ServerName xxx.xxx.xxx.xxx\n  DocumentRoot /var/www/deploy01/prod/app/current/public/\n  ErrorLog  /var/log/httpd/prod_app_error.log\n  CustomLog /var/log/httpd/prod_app_access.log combined\n  <Directory \"/var/www/deploy01/prod/app/current/public\">\n        Options -MultiViews\n        AllowOverride All\n        Order allow,deny\n        Allow from all\n  </Directory>\n</VirtualHost>\n\n# test\n<VirtualHost *:8000>\n  RailsEnv test\n  ServerName xxx.xxx.xxx.xxx\n  DocumentRoot /var/www/deploy01/test/app/current/public/\n  ErrorLog  /var/log/httpd/test_app_error.log\n  CustomLog /var/log/httpd/test_app_access.log combined\n  <Directory \"/var/www/deploy01/test/app/current/public\">\n        Options -MultiViews\n        AllowOverride All\n        Order allow,deny\n        Allow from all\n  </Directory>\n</VirtualHost>\n\n\nserverName\u3067virtualhost\u3092\u5206\u3051\u308b\u8a2d\u5b9a\u3092ON\u306b\u3059\u308b\u305f\u3081\n\u4e0b\u8a18\u884c\u306e\u30b3\u30e1\u30f3\u30c8\u3092\u5916\u3059\n\n/etc/httpd/conf/httpd.conf\n#NameVirtualHost *:80\n\n\nweb01\u3068web02\u306eapache\u3092\u518d\u8d77\u52d5\n$ sudo service httpd restart\n\niptables\u3092\u505c\u6b62\u3057\u3066\u3001test\u3068prod\u74b0\u5883\u306b\u30a2\u30af\u30bb\u30b9\u3067\u304d\u308b\u304b\u78ba\u8a8d\nhttp://xxx.xxx.xxx.xxx:80/\nhttp://xxx.xxx.xxx.xxx:8000/\n\ntest\u3068prod\u74b0\u5883\u304c\u52d5\u3044\u3066\u3044\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3067\u304d\u305f\u3089iptables\u3092\u518d\u30b9\u30bf\u30fc\u30c8\u3059\u308b\n$ sudo service iptables start\n\n\n\u30ea\u30d0\u30fc\u30b9\u30d7\u30ed\u30ad\u30b7\u306e\u8a2d\u5b9a\nrp01\u306ehttp.conf\u30d5\u30a1\u30a4\u30eb\u306b\u4e0b\u8a18\u30e2\u30b8\u30e5\u30fc\u30eb\u3092\u8a2d\u5b9a\n\n/etc/httpd/conf/httpd.conf\nLoadModule proxy_module modules/mod_proxy.so\nLoadModule proxy_balancer_module modules/mod_proxy_balancer.so\nLoadModule proxy_ftp_module modules/mod_proxy_ftp.so\nLoadModule proxy_http_module modules/mod_proxy_http.so\nLoadModule proxy_ajp_module modules/mod_proxy_ajp.so\nLoadModule proxy_connect_module modules/mod_proxy_connect.so\n\n\n\u3055\u3089\u306b\u3001rp01\u306ehttp.conf\u306b\u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b5\u306e\u51e6\u7406\u3092\u8ffd\u52a0\n\u203bip\u30a2\u30c9\u30ec\u30b9\u3092\u30db\u30b9\u30c8\u540d\u306b\u7f6e\u304d\u63db\u3048\u3066\u307e\u3059\n#prod\u74b0\u5883\u3078\u306e\u30a2\u30af\u30bb\u30b9\u3092\u300cxxx.com\u300d\n#test\u74b0\u5883\u3078\u306e\u30a2\u30af\u30bb\u30b9\u3092\u300ctest.xxx.com\u300d\u306e\u30b5\u30d6\u30c9\u30e1\u30a4\u30f3\u306b\u3057\u305f\u5834\u5408\u306e\u8a2d\u5b9a\n\n#prod\u8a2d\u5b9a\n<VirtualHost *:80>\n  ServerName xxx.com:80\n\n  ProxyPass /balancer-manager !\n  <Location /balancer-manager>\n          SetHandler balancer-manager\n  </Location>\n\n  ProxyPass / balancer://rp01/\n  ProxyPassReverse / balancer://rp01/\n\n  <Proxy balancer://rp01/>\n          BalancerMember http://web01:80 loadfactor=5\n          BalancerMember http://web02:80 loadfactor=5\n  </Proxy>\n</VirtualHost>\n\n#test\u8a2d\u5b9a\n<VirtualHost *:80>\n  ServerName test.xxx.com:80\n\n  ProxyPass /balancer-manager !\n  <Location /balancer-manager>\n          SetHandler balancer-manager\n  </Location>\n\n  ProxyPass / balancer://test-rp01/ \n  ProxyPassReverse / balancer://test-rp01/\n\n  <Proxy balancer://test-rp01/>\n          BalancerMember http://web01:8000 loadfactor=5\n          BalancerMember http://web02:8000 loadfactor=5\n  </Proxy>\n</VirtualHost>\n\nloadfactor\u306e\u6570\u5b57\u3092\u5927\u304d\u304f\u3059\u308b\u3068\u3001\u4f7f\u7528\u983b\u5ea6\u304c\u5927\u304d\u304f\u306a\u308a\u307e\u3059\u3002\nweb01\u30fbweb02\u306eapache\u3092\u4ea4\u4e92\u306b\u505c\u6b62\u3057\u3066\u3001xxx.com\u306b\u30a2\u30af\u30bb\u30b9\u3067\u304d\u305f\u3089\u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b5\u306e\u8a2d\u5b9a\u304c\u5b8c\u4e86\u3057\u3066\u3044\u308b\u3002\n\n\u4f59\u8ac7\nDTI\u306eVPS\u3092\u501f\u308a\u308c\u3070\u3001\u6708420\u5186 * 5\u53f0 = 2100\u5186\u3067\u5b9f\u73fe\u53ef\u80fd\u3067\u3059\u3002\nDTI\u306e\u5834\u5408\u3001aaa.bbb.ccc.1\u3068aaa.bbb.ccc.2\u306e\u3088\u3046\u306b\u3001\u30b0\u30ed\u30fc\u30d0\u30ebIP\u306e\uff14\u6841\u76ee\u4ee5\u5916\u304c\u540c\u3058\u306e\u5834\u5408\u306f\n\u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u4e0a\u3001\u901a\u4fe1\u304c\u51fa\u6765\u306a\u3044\u3088\u3046\u3067\u3059(T_T)\n\nRuby on Rails\u3067Dev\u74b0\u5883\u306f\u4f7f\u3063\u305f\u3053\u3068\u3042\u308b\u3051\u3069\u3001test\u30fbprod\u74b0\u5883\u3092\u8003\u616e\u3057\u305f\u74b0\u5883\u69cb\u7bc9\u3092\u3057\u305f\u3053\u3068\u304c\u306a\u3044\u4eba\u306b\u304a\u52e7\u3081\u306e\u5185\u5bb9\u3067\u3059\u3002\n\n##\u30b5\u30fc\u30d0\u30fc\u69cb\u6210\u56f3\n\n![\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2014-01-11 12.15.17.png](https://qiita-image-store.s3.amazonaws.com/0/29861/b3ec75c8-91cb-f9cc-8968-90525852d7ec.png \"\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2014-01-11 12.15.17.png\")\n\n##\u30b5\u30fc\u30d0\u30fc\u306e\u5f79\u5272\n###\u30ea\u30d0\u30fc\u30b9\u30d7\u30ed\u30ad\u30b7\u30b5\u30fc\u30d0\u30fc(\u30db\u30b9\u30c8\u540d\uff1arp01\uff09\n* \u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b5\u6a5f\u80fd\u3092\u4f7f\u3063\u3066WEB\u30b5\u30fc\u30d0\u4e8c\u53f0\u306b\u51e6\u7406\u3092\u632f\u308a\u5206\u3051\u3001\u30a2\u30af\u30bb\u30b9\u3092\uff11\u53f0\u306e\u30b5\u30fc\u30d0\u30fc\u306b\u96c6\u4e2d\u3055\u305b\u306a\u3044\n* WEB\u30b5\u30fc\u30d0\u30fc\u3092\u5916\u90e8\u304b\u3089\u96a0\u305b\u308b\u3053\u3068\u3067\u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u9762\u306e\u5411\u4e0a\n\n###WEB\u30b5\u30fc\u30d0\u30fc\uff08web01\u3001web02\uff09\n* web\u30b5\u30fc\u30d0\u30fc\u3092\uff12\u53f0\u7528\u610f\u3059\u308b\u3053\u3068\u3067\u30a2\u30af\u30bb\u30b9\u304c\uff11\u3064\u306e\u30b5\u30fc\u30d0\u30fc\u306b\u96c6\u4e2d\u3057\u306a\u3044\u305f\u3081\u3001\u30ec\u30b9\u30dd\u30f3\u30b9\u3092\u65e9\u304f\u3067\u304d\u308b\n\n###\u30de\u30b9\u30bf\u30fcDB\u30b5\u30fc\u30d0\u30fc\uff08db01m\uff09\n* DB\u5185\u5bb9\u3092\u3082\u3046\uff11\u53f0\u306eDB\u30b5\u30fc\u30d0\u30fc\uff08\u30b9\u30ec\u30fc\u30d6\uff09\u3078\u30ea\u30a2\u30eb\u30bf\u30a4\u30e0\u306b\u30b3\u30d4\u30fc\u3057\u3001\u969c\u5bb3\u3067\u30de\u30b9\u30bf\u30fc\u304c\u505c\u6b62\u3057\u305f\u3068\u304d\u306f\u30b9\u30ec\u30fc\u30d6\u306b\u5207\u308a\u66ff\u3048\u308b\n\n###\u30b9\u30ec\u30fc\u30d6DB\u30b5\u30fc\u30d0\u30fc\uff08db01s\uff09\n* \u8aad\u307f\u8fbc\u307f\u5c02\u7528\u306e\u30b5\u30fc\u30d0\u30fc\u3002\u66f8\u304d\u8fbc\u307f\u3092\u3057\u306a\u3044\u5206\u30ec\u30b9\u30dd\u30f3\u30b9\u304c\u65e9\u304f\u306a\u308b\n* \u30de\u30b9\u30bf\u30fc\u306e\u5185\u5bb9\u3092\u5e38\u306b\u30b3\u30d4\u30fc\u3059\u308b\uff08\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3068\u3044\u3046\uff09\n\n###\u958b\u767a\u74b0\u5883\uff08dev01\uff09\n* \u958b\u767a\u306f\u3053\u306e\u74b0\u5883\u3060\u3051\u3067\u884c\u3044\u3001\u5b8c\u6210\u7269\u3092WEB\u30b5\u30fc\u30d0\u30fc\u306b\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u3059\u308b\uff08\u30c7\u30d7\u30ed\u30a4\u3068\u3044\u3046\uff09\n\n###DNS\uff08rp01\uff09\n* \u5404\u30b5\u30fc\u30d0\u30fc\u306e\u30db\u30b9\u30c8\u540d\u3092\u7ba1\u7406\u3059\u308bDNS\u3002\u30ea\u30d0\u30fc\u30b9\u30d7\u30ed\u30ad\u30b7\u3068\u540c\u3058\u30b5\u30fc\u30d0\u30fc\u5185\u3067\u52d5\u4f5c\u3055\u305b\u308b\n\n##\u6e96\u5099\n\n* VPS\u7b49\u3067\u30b5\u30fc\u30d0\u30fc\u30925\u53f0\u501f\u308a\u3066\u304a\u304f\uff08rp01\u3001web01\u3001web02\u3001db01m\u3001db01s\uff09\n* \u30ea\u30d0\u30fc\u30b9\u30d7\u30ed\u30ad\u30b7\u306f\u30b0\u30ed\u30fc\u30d0\u30ebIP\u5fc5\u9808\n* \u958b\u767a\u74b0\u5883\uff08\u624b\u6301\u3061\u306bMac\u3084Unix\u74b0\u5883\u304c\u306a\u3044\u306a\u3089vps\u3067\u501f\u308a\u308b\uff09\n\n##\u30b5\u30fc\u30d0\u30fc\u4ed5\u69d8\n\n###WEB\u30b5\u30fc\u30d0\u30fc\u30fb\u30ea\u30d0\u30fc\u30b9\u30d7\u30ed\u30ad\u30b7\n* Apache/2.2.15 (Unix)\n\n###\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\n* MySQL Server 5.1.71\n\n###DNS\n* mydns 1.2.8.31\n\n###Ruby\n* ruby-2.0.0-p353\n\n###Ruby on Rails\n* Rails 4.0.2\n\n##\u5168\u30b5\u30fc\u30d0\u30fc\u306b\u5171\u901a\u3059\u308b\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\n\n###\u30ed\u30b0\u30a4\u30f3\u30e6\u30fc\u30b6\u30fc\u306e\u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u8a2d\u5b9a\u7de8\n\n\u521d\u671f\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3055\u308c\u305f\u30d1\u30c3\u30b1\u30fc\u30b8\u3092\u30a2\u30c3\u30d7\u30c7\u30fc\u30c8\n\n`$ sudo yum update`\n\n\u30ed\u30b0\u30a4\u30f3\u30e6\u30fc\u30b6\u30fc\uff08deploy01\uff09\u306e\u4f5c\u6210\n\n```\n$ useradd deploy01\n$ passwd  deploy01\n```\n\ndeploy01\u3092sudo\u6a29\u9650\u304c\u4f7f\u3048\u308b\u30b0\u30eb\u30fc\u30d7\u306b\u6240\u5c5e\u3055\u305b\u308b\n\n```\n$ usermod \u2013G wheel deploy01\n```\n\nwheel\u30b0\u30eb\u30fc\u30d7\u4ee5\u5916\u306fsudo\u6a29\u9650\u3092\u4e0e\u3048\u306a\u3044\u8a2d\u5b9a\u3002\n\u4e0b\u8a18\u884c\u306e\u30b3\u30e1\u30f3\u30c8\u3092\u5916\u3059\u3002\n\n```zsh:/etc/pam.d/su\n#auth  required pam_wheel.so use_uid\n```\n\nwheel\u30b0\u30eb\u30fc\u30d7\u306e\u307froot\u30e6\u30fc\u30b6\u30fc\u306b\u30ed\u30b0\u30a4\u30f3\u53ef\u80fd\u306b\u3059\u308b\u3002\n\u4e0b\u8a18\u884c\u3092\u8ffd\u52a0\n\n```vim:/etc/login.defs\nSU_WHEEL_ONLY yes\n```\n\nwheel\u30b0\u30eb\u30fc\u30d7\u306e\u30e6\u30fc\u30b6\u30fc\u306e\u307f sudo\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u8a31\u53ef\u3002\n\u4e0b\u8a18\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3059\u308b\u3002\n\n```\n$ visudo\n```\n\n\u3059\u308b\u3068\u3001\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u304c\u958b\u304f\u306e\u3067\u4e0b\u8a18\u884c\u306e\u30b3\u30e1\u30f3\u30c8\u3092\u5916\u3059\n\n```\n# %wheel ALL=(ALL) ALL\n```\n\nroot\u30e6\u30fc\u30b6\u30fc\u3067\u306essh\u30ed\u30b0\u30a4\u30f3\u3092\u7981\u6b62\u3059\u308b\u3002\n\u4e0b\u8a18\u884c\u3092\u30b3\u30e1\u30f3\u30c8\u5316\u3059\u308b\n\n```vim:/etc/ssh/sshd_config\nPermitRootLogin no\n```\n\nSSH\u306e\u30dd\u30fc\u30c8\u3092\u72d9\u3063\u305f\u653b\u6483\u3092\u56de\u907f\u3059\u308b\u305f\u3081\u3001\u30dd\u30fc\u30c8\u756a\u53f7\u3092\u5909\u66f4\u3059\u308b\u3002\nPort\u306e\u5f8c\u308d\u306b\u5909\u66f4\u3057\u305f\u3044\u30dd\u30fc\u30c8\u756a\u53f7\u3092\u5165\u308c\u308b\n\n```vim:/etc/ssh/sshd_config\nPort 3243\n```\n\nSSH\u306e\u5909\u66f4\u3092\u6709\u52b9\u306b\u3059\u308b\u305f\u3081\u3001SSH\u3092\u518d\u8d77\u52d5\u3059\u308b\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\n\n`$ /etc/init.d/sshd restart`\n\n###\u30d5\u30a1\u30a4\u30a2\u30a6\u30a9\u30fc\u30eb\u7de8\n\n\u4e0b\u8a18\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3059\u308b\u3068\u30d5\u30a1\u30a4\u30a2\u30a6\u30a9\u30fc\u30eb\u306e\u8a2d\u5b9a\u60c5\u5831\u3092\u78ba\u8a8d\u3067\u304d\u308b\n\n```\n$ /sbin/iptables -L --line-number\n\nChain INPUT (policy ACCEPT)\nnum  target     prot opt source               destination         \n\nChain FORWARD (policy ACCEPT)\nnum  target     prot opt source               destination         \n\nChain OUTPUT (policy ACCEPT)\nnum  target     prot opt source               destination\n\n```\n\n\u4e0a\u8a18\u3068\u540c\u3058\u8868\u793a\u306e\u5834\u5408\u3001\u3059\u3079\u3066\u306e\u901a\u4fe1\u3092\u8a31\u53ef\u3057\u3066\u3044\u308b\u305f\u3081\u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u4e0a\u554f\u984c\u304c\u3042\u308b\u3002\n\u5404\u30b5\u30fc\u30d0\u30fc\u3054\u3068\u306b\u30d5\u30a1\u30a4\u30a2\u30a6\u30a9\u30fc\u30eb\u3092\u8a2d\u5b9a\u3059\u308b\u3002\n\n#### \u30ea\u30d0\u30fc\u30b9\u30d7\u30ed\u30ad\u30b7\uff08rp01\uff09\u306e\u30d5\u30a1\u30a4\u30a2\u30a6\u30a9\u30fc\u30eb\u8a2d\u5b9a\n\n\u5916\u90e8\u30d1\u30b1\u30c3\u30c8\u304b\u3089\u5165\u3063\u3066\u304f\u308b\u30d1\u30b1\u30c3\u30c8\u306e\u3046\u3061\nhttp\u3001https\u3001ssh\uff08\u30dd\u30fc\u30c8\u306f3824\uff09\u3001DNS\u306e\u307f\u8a31\u53ef\u3059\u308b\u3002\n\n```vim:/etc/sysconfig/iptables\n*filter\n:INPUT DROP [0:0]\n:FORWARD DROP [0:0]\n:OUTPUT ACCEPT [0:0]\n-A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT\n## allow well-known port ##\n-A INPUT -p icmp -j ACCEPT\n-A INPUT -i lo -j ACCEPT\n## allow port(SSH,http,https,DNS) ##\n-A INPUT -m state --state NEW -m tcp -p tcp --dport 3824 -j ACCEPT\n-A INPUT -m state --state NEW -m tcp -p tcp --dport 80   -j ACCEPT\n-A INPUT -m state --state NEW -m tcp -p tcp --dport 443  -j ACCEPT\n-A INPUT -m state --state NEW -m udp -p udp --dport 53   -j ACCEPT\nCOMMIT\n```\n\n#### WEB\u30b5\u30fc\u30d0\u30fc\uff08web01\u3001web02\uff09\u306e\u8a2d\u5b9a\n\n\u203bIP\u30a2\u30c9\u30ec\u30b9\u3092\u30db\u30b9\u30c8\u540d\u306b\u7f6e\u304d\u63db\u3048\u3066\u307e\u3059\u3002\n\n```vim:/etc/sysconfig/iptables\n*filter\n:INPUT DROP [0:0]\n:FORWARD DROP [0:0]\n:OUTPUT ACCEPT [0:0]\n-A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT\n#------------------------------------------------------\n# ping\u3001\u30eb\u30fc\u30d7\u30d0\u30c3\u30af\u30a2\u30c9\u30ec\u30b9\u3092\u8a31\u53ef\n#------------------------------------------------------\n-A INPUT -p icmp -j ACCEPT\n-A INPUT -i lo -j ACCEPT\n#------------------------------------------------------\n# RP\u306e\u307f\u3001web\u30b5\u30fc\u30d0\u30fc\u3078\u306e\u901a\u4fe1\u3092\u8a31\u53ef\n# 80\u306f\u672c\u756a\u74b0\u5883\uff08prod\uff09\u306e\u30b5\u30a4\u30c8\u8868\u793a\n# 8000\u306f\u30c6\u30b9\u30c8\u74b0\u5883\uff08test\uff09\u306e\u30b5\u30a4\u30c8\u8868\u793a\n#------------------------------------------------------\n-A INPUT -s rp01 -p tcp --dport 80   -j ACCEPT\n-A INPUT -s rp01 -p tcp --dport 8000 -j ACCEPT\n#------------------------------------------------------\n# SSH\u3092\u8a31\u53ef\n#------------------------------------------------------\n-A INPUT -m state --state NEW -m tcp -p tcp --dport 3843 -j ACCEPT\nCOMMIT\n```\n\n#### DB\u30b5\u30fc\u30d0\u30fc\uff08db01m\uff09\u306e\u8a2d\u5b9a\n\n\u203bIP\u30a2\u30c9\u30ec\u30b9\u3092\u30db\u30b9\u30c8\u540d\u306b\u7f6e\u304d\u63db\u3048\u3066\u307e\u3059\u3002\n\n```\n*filter\n#------------------------------------------------------\n# \u30e1\u30f3\u30c6\u30ca\u30f3\u30b9\u53ef\u80fd\u30ea\u30b9\u30c8\n# web01\n# web02\n# db01s\n#------------------------------------------------------\n#------------------------------------------------------\n# \u30dd\u30ea\u30b7\u30fc\uff1a\u5168\u3066\u306e\u9001\u53d7\u4fe1\u30d1\u30b1\u30c3\u30c8\u3092\u7834\u68c4\u3002\u5fc5\u8981\u306a\u7528\u9014\u306b\u5fdc\u3058\u3066\u958b\u3051\u3066\u3044\u304f\u3002\n#------------------------------------------------------\n:INPUT DROP [0:0]\n:FORWARD DROP [0:0]\n:OUTPUT DROP [0:0]\n#------------------------------------------------------\n# ping\u3068\u30eb\u30fc\u30d7\u30d0\u30c3\u30af\u30a2\u30c9\u30ec\u30b9\uff08\u81ea\u5206\u81ea\u8eab\u306eIP\uff09\u304b\u3089\u306e\u9001\u53d7\u4fe1\u3092\u8a31\u53ef\n#------------------------------------------------------\n-A INPUT -i lo -j ACCEPT\n-A OUTPUT -o lo -j ACCEPT\n-A INPUT  -p icmp -j ACCEPT\n-A OUTPUT -p icmp -j ACCEPT\n#------------------------------------------------------\n# \u5185\u90e8\u304b\u3089\u306eDNS\u9001\u4fe1\u3092\u8a31\u53ef\n#------------------------------------------------------\n-A OUTPUT -m state --state NEW -m udp -p udp --dport 53   -j ACCEPT\n#------------------------------------------------------\n# \u5185\u90e8\u304b\u3089\u306ehttp\u9001\u4fe1\u3092\u8a31\u53ef\uff08yum\u7b49\uff09\n#------------------------------------------------------\n-A OUTPUT -m state --state NEW -m tcp -p tcp --dport 80   -j ACCEPT\n#------------------------------------------------------\n# \u30e1\u30f3\u30c6\u30ca\u30f3\u30b9\u306e\u307fSSH\u63a5\u7d9a\u3092\u8a31\u53ef\n#------------------------------------------------------\n-A INPUT  -s web01 -p tcp --dport 3843 -j ACCEPT\n-A OUTPUT -d web01 -p tcp --sport 3843 -j ACCEPT\n-A INPUT  -s web02 -p tcp --dport 3843 -j ACCEPT\n-A OUTPUT -d web02 -p tcp --sport 3843 -j ACCEPT\n-A INPUT  -s db01s -p tcp --dport 3843 -j ACCEPT\n-A OUTPUT -d db01s -p tcp --sport 3843 -j ACCEPT\n#------------------------------------------------------\n# \u30e1\u30f3\u30c6\u30ca\u30f3\u30b9\u306e\u307fMySQL\u63a5\u7d9a\u3092\u8a31\u53ef\n#------------------------------------------------------\n-A INPUT  -s web01 -p tcp --dport 3306 -j ACCEPT\n-A OUTPUT -d web01 -p tcp --sport 3306 -j ACCEPT\n-A INPUT  -s web02 -p tcp --dport 3306 -j ACCEPT\n-A OUTPUT -d web02 -p tcp --sport 3306 -j ACCEPT\n-A INPUT  -s db01s -p tcp --dport 3306 -j ACCEPT\n-A OUTPUT -d db01s -p tcp --sport 3306 -j ACCEPT\n#------------------------------------------------------\n# \u63a5\u7d9a\u6e08\u307f\u30d1\u30b1\u30c3\u30c8\u306e\u9001\u53d7\u4fe1\u3092\u8a31\u53ef\n#------------------------------------------------------\n-A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT\n-A OUTPUT -m state --state ESTABLISHED,RELATED -j ACCEPT\nCOMMIT\n```\n\n\n#### DB\u30b5\u30fc\u30d0\u30fc\uff08db01s\uff09\u306e\u8a2d\u5b9a\n\n\u203bIP\u30a2\u30c9\u30ec\u30b9\u3092\u30db\u30b9\u30c8\u540d\u306b\u7f6e\u304d\u63db\u3048\u3066\u307e\u3059\u3002\n\n```\n*filter\n#------------------------------------------------------\n# \u30e1\u30f3\u30c6\u30ca\u30f3\u30b9\u53ef\u80fd\u30ea\u30b9\u30c8\n# web01\n# web02\n# db01m\n#------------------------------------------------------\n#------------------------------------------------------\n# \u30dd\u30ea\u30b7\u30fc\uff1a\u5168\u3066\u306e\u9001\u53d7\u4fe1\u30d1\u30b1\u30c3\u30c8\u3092\u7834\u68c4\u3002\u5fc5\u8981\u306a\u7528\u9014\u306b\u5fdc\u3058\u3066\u958b\u3051\u3066\u3044\u304f\u3002\n#------------------------------------------------------\n:INPUT DROP [0:0]\n:FORWARD DROP [0:0]\n:OUTPUT DROP [0:0]\n#------------------------------------------------------\n# ping\u3068\u30eb\u30fc\u30d7\u30d0\u30c3\u30af\u30a2\u30c9\u30ec\u30b9\uff08\u81ea\u5206\u81ea\u8eab\u306eIP\uff09\u304b\u3089\u306e\u9001\u53d7\u4fe1\u3092\u8a31\u53ef\n#------------------------------------------------------\n-A INPUT -i lo -j ACCEPT\n-A OUTPUT -o lo -j ACCEPT\n-A INPUT  -p icmp -j ACCEPT\n-A OUTPUT -p icmp -j ACCEPT\n#------------------------------------------------------\n# \u5185\u90e8\u304b\u3089\u306eDNS\u9001\u4fe1\u3092\u8a31\u53ef\n#------------------------------------------------------\n-A OUTPUT -m state --state NEW -m udp -p udp --dport 53   -j ACCEPT\n#------------------------------------------------------\n# \u5185\u90e8\u304b\u3089\u306ehttp\u9001\u4fe1\u3092\u8a31\u53ef\uff08yum\u7b49\uff09\n#------------------------------------------------------\n-A OUTPUT -m state --state NEW -m tcp -p tcp --dport 80   -j ACCEPT\n#------------------------------------------------------\n# \u30e1\u30f3\u30c6\u30ca\u30f3\u30b9\u306e\u307fSSH\u63a5\u7d9a\u3092\u8a31\u53ef\n#------------------------------------------------------\n-A INPUT  -s web01 -p tcp --dport 3843 -j ACCEPT\n-A OUTPUT -d web01 -p tcp --sport 3843 -j ACCEPT\n-A INPUT  -s web02 -p tcp --dport 3843 -j ACCEPT\n-A OUTPUT -d web02 -p tcp --sport 3843 -j ACCEPT\n-A INPUT  -s db01m -p tcp --dport 3843 -j ACCEPT\n-A OUTPUT -d db01m -p tcp --sport 3843 -j ACCEPT\n#------------------------------------------------------\n# \u30e1\u30f3\u30c6\u30ca\u30f3\u30b9\u306e\u307fMySQL\u63a5\u7d9a\u3092\u8a31\u53ef\n#------------------------------------------------------\n-A INPUT  -s web01 -p tcp --dport 3306 -j ACCEPT\n-A OUTPUT -d web01 -p tcp --sport 3306 -j ACCEPT\n-A INPUT  -s web02 -p tcp --dport 3306 -j ACCEPT\n-A OUTPUT -d web02 -p tcp --sport 3306 -j ACCEPT\n-A INPUT  -s db01m -p tcp --dport 3306 -j ACCEPT\n-A OUTPUT -d db01m -p tcp --sport 3306 -j ACCEPT\n#------------------------------------------------------\n# \u63a5\u7d9a\u6e08\u307f\u30d1\u30b1\u30c3\u30c8\u306e\u9001\u53d7\u4fe1\u3092\u8a31\u53ef\n#------------------------------------------------------\n-A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT\n-A OUTPUT -m state --state ESTABLISHED,RELATED -j ACCEPT\nCOMMIT\n```\n\n\u3059\u3079\u3066\u306e\u8a2d\u5b9a\u3092\u66f8\u304d\u7d42\u3048\u305f\u3089iptables\u3092\u518d\u8d77\u52d5\u3057\u3066\u30d5\u30a1\u30a4\u30a2\u30a6\u30a9\u30fc\u30eb\u3092\u6709\u52b9\u5316\n\n```\n$ service iptables restart\n```\n\n\u30d5\u30a1\u30a4\u30a2\u30a6\u30a9\u30fc\u30eb\u306e\u8a2d\u5b9a\u306f\u4ee5\u4e0a\u3002\n\u958b\u767a\u74b0\u5883\u306e\u30d5\u30a1\u30a4\u30a2\u30a6\u30a9\u30fc\u30eb\u306f\u4efb\u610f\u3067\u8a2d\u5b9a\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n## MySQL\uff08\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u30b5\u30fc\u30d0\u30fc\uff09\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n### Mysql\u306e\u30d1\u30c3\u30b1\u30fc\u30b8\u306b\u3064\u3044\u3066\n\nmysql\u306e\u30d1\u30c3\u30b1\u30fc\u30b8\u306b\u306f\u5927\u304d\u304f\u5206\u3051\u3066\uff13\u7a2e\u985e\u3042\u308b\n\n* mysql\uff1aclient\u7528\n* mysql-server\uff1aserver\u7528\n* mysql-devel\uff1a\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3068\u306e\u9023\u643a\u7528\n\n\u305d\u306e\u305f\u3081\u3001\u7528\u9014\u306b\u3088\u3063\u3066\u306f\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u30d1\u30c3\u30b1\u30fc\u30b8\u3092\u7d5e\u308b\u3053\u3068\u304c\u53ef\u80fd\n\nterminal\u304b\u3089mysql\u306b\u63a5\u7d9a\u3059\u308b\n\n* mysql\n\nrails\u3084mydns\u7b49\u306e\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u304b\u3089mysql\u30b5\u30fc\u30d0\u30fc\u306b\u63a5\u7d9a\n\n* mysql\u3001mysql-devel\n\n\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u904b\u7528\n\n* mysql-server\n\n\n\u4eca\u56de\u306f\u30b5\u30fc\u30d0\u30fc\u3054\u3068\u306b\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u30d1\u30c3\u30b1\u30fc\u30b8\u3092\u5909\u3048\u308b\n\n### MySQL\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\nrp01\uff08DNS\u30b5\u30fc\u30d0\u30fc\u7528\u3068\u3057\u3066\u4f7f\u3046\uff09\n\n`$ yum install mysql mysql-devel mysql-server`\n\nweb01\u3001web02\uff08rails\u7528\u306b\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\uff09\n\n`$ yum install mysql mysql-devel`\n\ndb01m\u3001db01s\uff08mysql\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u7528\uff09\n\n`$ yum install mysql mysql-server`\n\n### mysql\u306e\u8a2d\u5b9a\n\n\u4ee5\u4e0b\u3092\u30b5\u30fc\u30d0\u30fc5\u53f0\u5168\u3066\u306b\u8a2d\u5b9a\u3059\u308b\n\nmysql\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u3059\u308b\n\n`$ sudo cp /etc/my.cnf /etc/my.cnf.org`\n\nMySQL\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\n\n`$ sudo cp /etc/my.cnf /etc/my.cnf.org`\n\nMySQL\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092\u4e0b\u8a18\u306e\u3088\u3046\u306b\u8a2d\u5b9a\n\n```vim:/etc/my.cnf\n\n[mysqld]\ncharacter-set-server = utf8\nskip-character-set-client-handshake\ndatadir=/var/lib/mysql\nsocket=/var/lib/mysql/mysql.sock\nuser=mysql\nsymbolic-links=0\n\ninnodb_buffer_pool_size = 512MB # \u30b5\u30fc\u30d0\u306e\u30e1\u30e2\u30ea70\u301c80%\ninnodb_log_file_size = 100MB # 100-500MB\u7a0b\u5ea6\ninnodb_flush_log_at_trx_commit = 2\n\n[mysqld_safe]\nlog-error=/var/log/mysqld.log\npid-file=/var/run/mysqld/mysqld.pid          \n```\n\nroot\u306e\u30d1\u30b9\u30ef\u30fc\u30c9\u8a2d\u5b9a\n\n```\n$ sudo mysqladmin -u root password '\u30d1\u30b9\u30ef\u30fc\u30c9'\n```\n\nmysql-server\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3066\u3044\u308b\nrp01\u3068db01m\u3001db02m\u306e\u307fMySQL\u306e\u81ea\u52d5\u8d77\u52d5\u3092ON\u306b\u3059\u308b\n\n```\n$ sudo service mysqld start\n$ sudo chkconfig mysqld on\n```\n\nMySQL\u306b\u30ed\u30b0\u30a4\u30f3\u3057\u3001\u4e0d\u8981\u306a\u30e6\u30fc\u30b6\u30fc\u3068\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u3092\u524a\u9664\u3059\u308b\n\n```\n$ mysql -u root -p ****\n\nmysql \uff1e use mysql;\nmysql \uff1e select user,password, host from user;\n+------+-------------------------------------------+-------------------------+\n| user | password                                  | host                    |\n+------+-------------------------------------------+-------------------------+\n| root | *hogehogehogehogehogehogehogehogehogehoge | localhost               |\n| root |                                           | hogehogehogehogeh.ne.jp |\n| root |                                           | 127.0.0.1               |\n|      |                                           | localhost               |\n|      |                                           | hogehogehogehogeh.ne.jp |\n+------+-------------------------------------------+-------------------------+\nmysql\u3000\uff1e DELETE FROM user WHERE user = '' OR ( user = 'root' AND host != 'localhost' );\nQuery OK, 4 rows affected (0.00 sec)\n\nmysql\u3000\uff1e select user,password, host from user;\n+------+-------------------------------------------+-----------+\n| user | password                                  | host      |\n+------+-------------------------------------------+-----------+\n| root | *hogehogehogehogehogehogehogehogehogehoge | localhost |\n+------+-------------------------------------------+-----------+\n1 row in set (0.00 sec)\n```\n\n\u7d9a\u3044\u3066\u3001\u4e0d\u8981\u306a\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u3092\u524a\u9664\n\n```\nmysql \uff1e show databases;\n+--------------------+\n| Database           |\n+--------------------+\n| information_schema |\n| mysql              |\n| test               |\n+--------------------+\n3 rows in set (0.00 sec)\n\nmysql\uff1e DROP DATABASE test;\nQuery OK, 0 rows affected (0.00 sec)\n\n```\n\n\u6587\u5b57\u30bb\u30c3\u30c8\u306e\u78ba\u8a8d\n\n```\nshow variables like 'character_set%';\n# \u2193 \u306e\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u308c\u3070\u6210\u529f\n+--------------------------+----------------------------+\n| Variable_name            | Value                      |\n+--------------------------+----------------------------+\n| character_set_client     | utf8                       |\n| character_set_connection | utf8                       |\n| character_set_database   | utf8                       |\n| character_set_filesystem | binary                     |\n| character_set_results    | utf8                       |\n| character_set_server     | utf8                       |\n| character_set_system     | utf8                       |\n| character_sets_dir       | /usr/share/mysql/charsets/ |\n+--------------------------+----------------------------+\n8 rows in set (0.00 sec)\n```\n\n### rails\u7528\u306e\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u3092\u4f5c\u6210\n\n```\nmysql > create database app;\nmysql > create database app_test;\nmysql > create database app_dev;\n```\n\n## mydns\uff08DNS\u30b5\u30fc\u30d0\u30fc\uff09\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n### mydns\u3068\u306f\uff1f\n\nMySQL\u306e\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u3092\u4f7f\u3063\u3066\u3001\u30db\u30b9\u30c8\u540d\u306e\u7ba1\u7406\u304c\u3067\u304d\u308b\u3002\n\u30db\u30b9\u30c8\u3092\u8ffd\u52a0\u3059\u308b\u3068\u304d\u306finsert\u6587\u3092\uff11\u3064\u6253\u3064\u3060\u3051\u3067\u8a2d\u5b9a\u53ef\u80fd\u306a\u306e\u3067\u7ba1\u7406\u304c\u697d\u3002\n\n### \u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u306b\u3064\u3044\u3066\n\nMyDNS\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u306f\u4efb\u610f\u3002\nSSH\u63a5\u7d9a\u3084iptables\u3001apache\u8a2d\u5b9a\u3067ip\u3092\u4f7f\u308f\u305a\u30db\u30b9\u30c8\u540d\u3092\u4f7f\u3044\u305f\u3044\u4eba\u306f\n\u8a2d\u5b9a\u3057\u3066\u304f\u3060\u3055\u3044\u3002\uff08\u3053\u306e\u8a18\u4e8b\u306f\u5168\u3066\u30db\u30b9\u30c8\u540d\u306b\u306a\u3063\u3066\u3044\u307e\u3059\uff09\n\n### \u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u65b9\u6cd5\n\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u306frp01\u3067\u884c\u3044\u307e\u3059\u3002\n\nmydns\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3059\u308b\u305f\u3081\u306e\u30ea\u30dd\u30b8\u30c8\u30ea\u3092\u8ffd\u52a0\n\n```\nrpm -Uvh http://dl.fedoraproject.org/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm\n```\n\nmydns\u30d1\u30c3\u30b1\u30fc\u30b8\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n```\n$ yum install mydns\n$ yum install mydns-mysql\n```\n\nmysql\u306b\u30ed\u30b0\u30a4\u30f3\u3057\u3001mydns\u7528\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u3092\u4f5c\u6210\n\n```\nmysql > create database mydns;\n```\n\n\u30bf\u30fc\u30df\u30ca\u30eb\u304b\u3089\u4e0b\u8a18\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\n\n`$ mydns --create-tables | mysql -u root -p mydns`\n\nmysql\u306b\u30ed\u30b0\u30a4\u30f3\u3057\u3001mydns\u7528\u306e\u30c6\u30fc\u30d6\u30eb\u304c\u3067\u304d\u3066\u3044\u308b\u304b\u78ba\u8a8d\n\n```\nmysql > use mydns;\n\nDatabase changed\nmysql> show tables;\n+-----------------+\n| Tables_in_mydns |\n+-----------------+\n| rr              |\n| soa             |\n+-----------------+\n```\n\nmydns\u7528\u306e\u30e6\u30fc\u30b6\u30fc\u3092\u4f5c\u6210\u3059\u308b\u3002\n\u203b\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9mydns\u306b\u5bfe\u3057\u3066\u3001\u5168\u3066\u306e\u6a29\u9650\u3092\u6301\u3063\u305f\u30e6\u30fc\u30b6\u30fc\uff08\u5168\u3066\u306e\u30db\u30b9\u30c8\u304b\u3089\u306e\u30a2\u30af\u30bb\u30b9\u8a31\u53ef\uff09\n\n```\nGRANT ALL ON mydns.* TO 'mydns'@'%' IDENTIFIED BY 'mydns';\nQuery OK, 0 rows affected (0.01 sec)\n```\n\nDNS\u30be\u30fc\u30f3\u3068\u30ec\u30b3\u30fc\u30c9\u306e\u4f5c\u6210\n\n\u203b\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u3092xxx.local\u306b\u3059\u308b\n\u203bxxx.xxx.xxx.xxx\u306fIP\u30a2\u30c9\u30ec\u30b9\u3067\u3059\n\n```\nmysql> insert into soa (origin, ns) values ('local.', 'ns.local');\nQuery OK, 1 row affected, 1 warning (0.00 sec)\n\nmysql> insert into rr (zone, name, type, data) values(1, 'web01', 'A', \u2018xxx.xxx.xxx.xxx\u2019);\nQuery OK, 1 row affected, 1 warning (0.00 sec)\n\nmysql> insert into rr (zone, name, type, data) values(1, 'web02', 'A', 'xxx.xxx.xxx.xxx\u2019);\nQuery OK, 1 row affected, 1 warning (0.00 sec)\n\nmysql> insert into rr (zone, name, type, data) values(1, 'db01m', 'A', 'xxx.xxx.xxx.xxx\u2019);\nQuery OK, 1 row affected, 1 warning (0.00 sec)\n\nmysql> insert into rr (zone, name, type, data) values(1, 'db01s', 'A', 'xxx.xxx.xxx.xxx\u2019);\nQuery OK, 1 row affected, 1 warning (0.00 sec)\n\nmysql> insert into rr (zone, name, type, data) values(1, \u2018rp01,   'A', 'xxx.xxx.xxx.xxx\u2019);\nQuery OK, 1 row affected, 1 warning (0.00 sec)\n\nmysql> insert into rr (zone, name, type, data) values(1, \u2018dev01\u2019, 'A', 'xxx.xxx.xxx.xxx\u2019);\nQuery OK, 1 row affected, 1 warning (0.00 sec)\n\nmysql> select * from rr;\n+----+------+-------+------------------+-----+-------+------+\n| id | zone | name  | data             | aux | ttl   | type |\n+----+------+-------+------------------+-----+-------+------+\n|  1 |    1 | web01 | xxx.xxx.xxx.xxx  |   0 | 86400 | A    |\n|  2 |    1 | web02 | xxx.xxx.xxx.xxx  |   0 | 86400 | A    |\n|  3 |    1 | db01m | xxx.xxx.xxx.xxx  |   0 | 86400 | A    |\n|  4 |    1 | db01s | xxx.xxx.xxx.xxx  |   0 | 86400 | A    |\n|  5 |    1 | rp01  | xxx.xxx.xxx.xxx  |   0 | 86400 | A    |\n|  6 |    1 | dev01 | xxx.xxx.xxx.xxx  |   0 | 86400 | A    |\n+----+------+-------+------------------+-----+-------+------+\n\nmysql > select * from soa;\n+----+--------+----------+------+--------+---------+-------+--------+---------+-------+\n| id | origin | ns       | mbox | serial | refresh | retry | expire | minimum | ttl   |\n+----+--------+----------+------+--------+---------+-------+--------+---------+-------+\n|  1 | local. | ns.local |      |      1 |   28800 |  7200 | 604800 |   86400 | 86400 |\n+----+--------+----------+------+--------+---------+-------+--------+---------+-------+\n1 row in set (0.00 sec)\n```\n\n###DNS\u306e\u8a2d\u5b9a\u3068mydns\u306e\u8d77\u52d5\n\n\u30db\u30b9\u30c8\u540d\u3067\u901a\u4fe1\u3057\u305f\u3044\u3059\u3079\u3066\u306e\u30b5\u30fc\u30d0\u30fc\u3067\u4e0b\u8a18\u3092\u8a2d\u5b9a\n\nxxx.xxx.xxx.xxx\u306frp01\u306e\u30b0\u30ed\u30fc\u30d0\u30ebIP\u30a2\u30c9\u30ec\u30b9\n\n```vim:/etc/resolv.conf\nsearch local\nnameserver xxx.xxx.xxx.xxx\n```\n\nmydns\u3092\u8d77\u52d5\n\n```\n$ service mydns start\n```\n\n\u8a2d\u5b9a\u3057\u305f\u30db\u30b9\u30c8\u540d\u3067ping\u304c\u901a\u308b\u304b\u78ba\u8a8d\n\n```\nping web01\n```\n\n##\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u8a2d\u5b9a\n\n### \u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3068\u306f\n\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306e\u5185\u5bb9\u3092\u5225\u306e\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306b\u30ea\u30a2\u30eb\u30bf\u30a4\u30e0\u3067\u540c\u671f\u3055\u305b\u308b\u3002\n\u30b3\u30d4\u5143\u3092\u30de\u30b9\u30bf\u30fc\u3001\u30b3\u30d4\u30fc\u5148\u3092\u30b9\u30ec\u30fc\u30d6\u3068\u3044\u3046\u3002\n\n### \u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u8a2d\u5b9a\u65b9\u6cd5\n\n\u30de\u30b9\u30bf\u30fc\u306edb01m\u306emy.cnf\u3092\u4e0b\u8a18\u306e\u3088\u3046\u306b\u8a2d\u5b9a\n\n```vim:/etc/my.cnf\n[mysqld]\nlog-bin=mysql-bin\nserver-id=1001\n```\n\n\u30b9\u30ec\u30fc\u30d6\u306edb01s\u306b\u30de\u30b9\u30bf\u30fc\u306b\u63a5\u7d9a\u3059\u308bmysql\u30e6\u30fc\u30b6\u30fc\u3092\u4f5c\u6210\u3059\u308b\u305f\u3081\u3001\ndb01s\u306emysql\u306b\u30ed\u30b0\u30a4\u30f3\u3057\u3066\u3001\u4e0b\u8a18\u3092\u5b9f\u884c\n\u203bxxx.xxx.xxx.xxx\u306fmaster\u306eip\u30a2\u30c9\u30ec\u30b9\n\n```\nGRANT REPLICATION SLAVE ON *.* TO 'repl\u2019@\u2018xxx.xxx.xxx.xxx\u2019 IDENTIFIED BY 'slavepass';\n```\n\n\u30b9\u30ec\u30fc\u30d6\u306emy.cnf\u30d5\u30a1\u30a4\u30eb\u5185\u3067\u4ee5\u4e0b\u306e\u901a\u308a\u8a2d\u5b9a\n\n```vim:/etc/my.cnf\n[mysqld]\nserver-id=1002\n```\n\n\u30de\u30b9\u30bf\u30fc\u5074\u306eposition\u3092\u78ba\u8a8d\n\n```\nmysql>  SHOW MASTER STATUS;\n+------------------+----------+--------------+------------------+\n| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB |\n+------------------+----------+--------------+------------------+\n| mysql-bin.000002 |      379 |              |                  |\n+------------------+----------+--------------+------------------+\n1 row in set (0.00 sec)\n```\n\n\u305d\u308c\u305e\u308c\u306e\u610f\u5473\n\nFile        : \u30d0\u30a4\u30ca\u30ea\u30ed\u30b0\u540d\nPosition  : \u30d5\u30a1\u30a4\u30eb\u5185\u306e\u30aa\u30d5\u30bb\u30c3\u30c8\uff08\u73fe\u5728\u4f4d\u7f6e\uff09\n\nPosition\u3068\u30d5\u30a1\u30a4\u30eb\u540d\u3092\u30e1\u30e2\u3057\u3066\u304a\u304d\u3001\u30de\u30b9\u30bf\u30fc\u306e\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306e\u30c6\u30fc\u30d6\u30eb\u3092\u30ed\u30c3\u30af\u3057\u3066\u304a\u304f\n\n```\nmysql > FLUSH TABLES WITH READ LOCK\n```\n\n\u30de\u30b9\u30bf\u30fc\u306e\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306e\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u3092\u53d6\u308b\n\n`$ mysqldump -u root -p --all-databases --lock-all-tables > /tmp/dbdump.db`\n\n\n\u30b9\u30ec\u30fc\u30d6\u5074\u3067SCP\u30b3\u30de\u30f3\u30c9\u3092\u4f7f\u3063\u3066\u3001\u30de\u30b9\u30bf\u30fc\u306edb\u30d5\u30a1\u30a4\u30eb\u3092\u53d6\u5f97\n\n`$ scp -P ssh\u306e\u30dd\u30fc\u30c8\u756a\u53f7 deploy01@db01m :/tmp/dbdump.db /tmp/`\n\n\u30b9\u30ec\u30fc\u30d6\u306e\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306b\u30de\u30b9\u30bf\u30fc\u306e\u5185\u5bb9\u3092\u53cd\u6620\n\n`# mysql -u root -p /tmp/dbdump.db `\n\n\n\u30b9\u30ec\u30fc\u30d6\u5074\u3067\u30de\u30b9\u30bf\u30fc\u60c5\u5831\u3092\u767b\u9332\n\nxxx.xxx.xxx.xxx\u306b\u306f\u30de\u30b9\u30bf\u30fc\u306eip\u30a2\u30c9\u30ec\u30b9\u3092\u5165\u308c\u308b\n\n```\nmysql > CHANGE MASTER TO\n           MASTER_HOST=\u2018xxx.xxx.xxx.xxx\u2019,\n           MASTER_USER='repl',\n           MASTER_PASSWORD='XXXXXX',\n           MASTER_LOG_FILE='mysql-bin.000002',\n           MASTER_LOG_POS=379;\n```\n\n\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u958b\u59cb\u3059\u308b\u305f\u3081\u3001\u30b9\u30ec\u30fc\u30d6\u5074\u3067\u4e0b\u8a18\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\n\n```\nmysql > START SLAVE;\n```\n\n\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u304c\u958b\u59cb\u3055\u308c\u3066\u3044\u308b\u304b\u78ba\u8a8d\n\n```\nshow slave status;\n\nmysql> show slave status \\G\n*************************** 1. row ***************************\n               Slave_IO_State: Waiting for master to send event\n                  Master_Host: xxx.xxx.xxx.xxx\n                  Master_User: repl\n                  Master_Port: 3306\n                Connect_Retry: 60\n              Master_Log_File: mysql-bin.000002\n          Read_Master_Log_Pos: 450\n               Relay_Log_File: mysqld-relay-bin.000003\n                Relay_Log_Pos: 251\n        Relay_Master_Log_File: mysql-bin.000002\n             Slave_IO_Running: Yes\n            Slave_SQL_Running: Yes\n```\n\n\u4e0b\u8a18\u3092\u78ba\u8a8d\u3067\u304d\u308c\u3070DB\u306e\u540c\u671f\u304c\u53d6\u308c\u3066\u3044\u308b\n\n```\nSlave_IO_Running: Yes\nSlave_SQL_Running: Yes\n```\n\n## Ruby\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n\u4f5c\u696d\u306fweb01\u3068web02\u3067\u884c\u3046\n\nroot\u30e6\u30fc\u30b6\u30fc\u3067\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u3068\u3001root\u6a29\u9650\u304c\u5fc5\u8981\u306a\u3068\u304d\u304c\u3042\u308b\u305f\u3081\ndeploy01\u30e6\u30fc\u30b6\u30fc\u306b\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3092\u884c\u3046\u3002\uff08\u30b7\u30f3\u30b0\u30eb\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\uff09\n\n### rvm\u3092\u4f7f\u3063\u305fRuby\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\nrvm\u306fRuby\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u7ba1\u7406\u3092\u5bb9\u6613\u306b\u884c\u3048\u308b\u3002\n\u30b3\u30de\u30f3\u30c9\uff11\u3064\u3067\u30d0\u30fc\u30b8\u30e7\u30f3\u3092\u5207\u308a\u66ff\u3048\u305f\u308a\u3001\u30d0\u30fc\u30b8\u30e7\u30f3\u3054\u3068\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u304c\u53ef\u80fd\n\n\u5fc5\u8981\u306a\u30d1\u30c3\u30b1\u30fc\u30b8\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n```\n$ sudo yum -y install curl curl-devel gcc gcc-c++ httpd-devel readline-devel tk-devel make zlib-devel libffi-devel\n```\n\nrvm\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n```\n$ bash -s stable < <(curl -s https://raw.github.com/wayneeseguin/rvm/master/binscripts/rvm-installer )\n$ echo \"source $HOME/.rvm/scripts/rvm\" >> ~/.bash_profile\n$ source ~/.bash_profile\n```\n\n\nRuby\u306ever 2.0.0\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n```\n$ rvm install 2.0.0\n```\n\nRVM\u306e\u8a2d\u5b9a\u78ba\u8a8d\n\n```\n$ rvm list\n=* ruby-2.0.0-p247 [ x86_64 ] # \n```\n\n### rails\u306e\u5c0e\u5165\n\nrails\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\uff08RDoc\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u90e8\u5206\u3067\u7d50\u69cb\u6642\u9593\u304b\u304b\u308b\uff09\n\n```\n$ gem install rails\n```\n\nRDoc\u304c\u4e0d\u8981\u306a\u5834\u5408\u306f\u4e0b\u8a18\u3067\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\n\n```\n$ gem install rails \u2013no-ri \u2013no-rdoc\n```\n\n\npassanger\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3092\u884c\u3046\n\n```\n$ gem install passenger\n$ passenger-install-apache2-module\n```\n\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u5b8c\u4e86\u5f8c\u3001\u4e0b\u8a18\u306e\u3088\u3046\u306a\u8868\u793a\u304c\u51fa\u308b\u306e\u3067\u30b3\u30d4\u30fc\n\n```\nLoadModule passenger_module /usr/lib64/ruby/gems/1.8/gems/passenger-4.0.19/buildout/apache2/mod_passenger.so\nPassengerRoot /usr/lib64/ruby/gems/1.8/gems/passenger-4.0.19\nPassengerDefaultRuby /usr/bin/ruby\n```\n\npassenger.conf\u306b\u4e0a\u8a18\u8a2d\u5b9a\u3068\u30aa\u30d7\u30b7\u30e7\u30f3\u3092\u8a18\u5165\n\n```vim:/etc/httpd/conf.d/passnger.conf\n# Passenger\u306e\u57fa\u672c\u8a2d\u5b9a\nLoadModule passenger_module /usr/local/rvm/gems/ruby-2.0.0-p247@global/gems/passenger-4.0.18/buildout/apache2/mod_passenger.so\nPassengerRoot /usr/local/rvm/gems/ruby-2.0.0-p247@global/gems/passenger-4.0.18\nPassengerDefaultRuby /usr/local/rvm/wrappers/ruby-2.0.0-p247@global/ruby\n\n# Passenger\u304c\u8ffd\u52a0\u3059\u308bHTTP\u30d8\u30c3\u30c0\u3092\u524a\u9664\u3059\u308b\u305f\u3081\u306e\u8a2d\u5b9a\nHeader always unset \"X-Powered-By\"\nHeader always unset \"X-Rack-Cache\"\nHeader always unset \"X-Content-Digest\"\nHeader always unset \"X-Runtime\"\n\n# \u5fc5\u8981\u306b\u5fdc\u3058\u3066Passenger\u306e\u30c1\u30e5\u30fc\u30cb\u30f3\u30b0\u306e\u305f\u3081\u306e\u8a2d\u5b9a\u3092\u8ffd\u52a0\nPassengerMaxPoolSize 20\nPassengerMaxInstancesPerApp 4\nPassengerPoolIdleTime 3600\nPassengerHighPerformance on\nPassengerStatThrottleRate 10\nRailsSpawnMethod smart\nRailsAppSpawnerIdleTime 86400\nPassengerMaxPreloaderIdleTime 0\n```\n\n### \u30c7\u30d7\u30ed\u30a4\u7528\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u4f5c\u6210\n\ntest\u74b0\u5883\u3068prod\u74b0\u5883\u306e\uff12\u3064\u3092\u7528\u610f\u3059\u308b\n\n```\n$ sudo mkdir /var/www/deploy01/\n$ sudo chown deploy01:deploy01 /var/www/deploy01/\n$ chmod 775 /var/www/deploy01/\n$ mkdir /var/www/deploy01/prod/\n$ mkdir /var/www/deploy01/test/\n```\n\n### \u958b\u767a\u74b0\u5883\u5074\u306e\u8a2d\u5b9a\n\n\u958b\u767a\u74b0\u5883\u5074\uff08dev01\uff09\u306fapp\u3068\u3044\u3046\u30a2\u30d7\u30ea\u304c\u51fa\u6765\u3066\u3044\u308b\u72b6\u6cc1\u3068\u3057\u307e\u3059\u3002\n\ndatabase.yml\u306bslave\u3068master\u306edb\u60c5\u5831\u3092\u8a2d\u5b9a\u3059\u308b\n\n```ruby:config/database.yml\ndevelopment:\n  adapter: mysql2\n  encoding: utf8\n  database: app_dev\n  pool: 5\n  username: root\n  password: xxxx\n  host: localhost\n\ntest_slave_database:\n  adapter: mysql2\n  encoding: utf8\n  database: app_test\n  pool: 5\n  username: root\n  password: xxx\n  host: db01s\n\ntest:\n  adapter: mysql2\n  encoding: utf8\n  database: app_test\n  pool: 5\n  username: root\n  password: xxx\n  host: db01m\n\nproduction_slave_database:\n  adapter: mysql2\n  encoding: utf8\n  database: app\n  pool: 5\n  username: root\n  password: xxx\n  host: db01s\n\nproduction:\n  adapter: mysql2\n  encoding: utf8\n  database: app\n  pool: 5\n  username: root\n  password: xxx\n  host: db01m\n```\n\nGemfile\u306b\u4e0b\u8a18\u30d1\u30c3\u30b1\u30fc\u30b8\u3092\u8a18\u8f09\u3059\u308b\n\n```ruby:Gemlife\ngem 'multi_db'\n```\n\n#### \u30c7\u30d7\u30ed\u30a4\u30c4\u30fc\u30eb\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\nweb01\u3068web02\u306bgit\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n```\n$ sudo yum install git\n```\n\napp\u30a2\u30d7\u30ea\u914d\u4e0b\u3067\u4e0b\u8a18\u3092\u5b9f\u884c\n\n```\n$ gem install capistrano\n```\n\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u304c\u5b8c\u4e86\u3057\u305f\u3089capify\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\n\n```\ncapify .\n> [add] writing './Capfile'\n> [add] writing './config/deploy.rb'\n> [done] capified!\n```\n\ntest\u74b0\u5883\u3068prod\u74b0\u5883\u7528\u306eCapistrano\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\n\n```\n$ mkdir config/deploy\n$ touch config/deploy/test.rb\n$ touch config/deploy/production.rb\n```\n\n\u5171\u901a\u306e\u30c7\u30d7\u30ed\u30a4\u60c5\u5831\u3092deploy.rb\u306b\u8a18\u5165\n\nip\u30a2\u30c9\u30ec\u30b9\u3092\u30db\u30b9\u30c8\u540d\u306b\u5909\u3048\u3066\u307e\u3059\u3002\n\n```ruby:app/config/deploy.rb\n# -*- coding: utf-8 -*-\nset :default_stage, \"production\"\n\n# \u8907\u6570\u74b0\u5883\u306b\u30c7\u30d7\u30ed\u30a4\u3067\u304d\u308b\u3088\u3046\u306b\u3059\u308b\nrequire \"capistrano/ext/multistage\"\n\n# capistrano\u306e\u51fa\u529b\u3092\u30ab\u30e9\u30fc\u306b\nrequire 'capistrano_colors'\n\n# cap deploy\u6642\u306b\u81ea\u52d5\u3067 bundle install\u3092\u5b9f\u884c\nrequire \"bundler/capistrano\"\n\n# RVM\nrequire \"rvm/capistrano\"\nset :rvm_ruby_string, \u20182.0.0-p353\u2019\nset :rvm_type, :user\n\n# git\u30ea\u30dd\u30b8\u30c8\u30ea\u306e\u8a2d\u5b9a\n#### git\u30ea\u30dd\u30b8\u30c8\u30ea\u3092\u30bb\u30c3\u30c8 ####\nset :repository,  \u201cgit\u306e\u30ea\u30dd\u30b8\u30c8\u30ea\u201d\nset :scm, :git\nset :deploy_via, :remote_cache\n\n# SSH\nset :use_sudo, false\nset :default_run_options, :pty => true\nssh_options[:port] = 22\nssh_options[:forward_agent] = true\n\nset :normalize_asset_timestamps, false\n# \u904e\u53bb\u306e\u30c7\u30d7\u30ed\u30a4\u3057\u305f\u30d5\u30a9\u30eb\u30c0\u3092\u5c65\u6b74\u3068\u3057\u3066\u4fdd\u6301\u3059\u308b\u6570\nset :keep_releases, 5\n\n# \u30c7\u30d7\u30ed\u30a4\u5148\u306e\u30b5\u30fc\u30d0\u306e\u8a2d\u5b9a\nserver \u201cweb01:3843\", :app, :web, :db, :primary => true\nserver \u201cweb02:3843\", :app, :web, :db, :primary => true\n\n# bundle install\u6761\u4ef6\nset :bundle_flags, \"--no-deployment --without test development\"\n\n# SSH\nset :user, \"deploy01\"\nset :user_group, \"deploy01\"\nset :password, \u201cSSH\u306e\u30ed\u30b0\u30a4\u30f3\u30d1\u30b9\u30ef\u30fc\u30c9\u201d\n\n# RVM\nset :rvm_path, '/home/deploy01/.rvm/'\nset :rvm_bin_path, \u201capp/bin\"\nset :rvm_lib_path, \u201capp/lib\"\n\n# assets:precompile\nnamespace :assets do\n  task :precompile, :roles => :web do\n    run \"cd #{current_path} && RAILS_ENV=#{rails_env} bundle exec rake assets:precompile\"\n  end\nend\n\n# \u30e1\u30f3\u30c6\u30ca\u30f3\u30b9\u30e2\u30fc\u30c9\nnamespace :maintenance do\n  desc \"Maintenance start\"\n  task :on, :roles => :web do\n    on_rollback { run \"rm #{current_path}/tmp/maintenance.yml\" }\n    page = File.read(\"config/maintenance.yml\")\n    put page, \"#{current_path}/tmp/maintenance.yml\", :mode => 0644\n  end\n\n  desc \"Maintenance stop\"\n  task :off, :roles => :web do\n    run \"rm #{release_path}/tmp/maintenance.yml\"\n  end\nend\n\nnamespace :deploy do\n  # Passenger\u306e\u5b9f\u884c\u30e6\u30fc\u30b6\u30fc/Group\u3092\u30bb\u30c3\u30c8\n  task :set_file_process_owner do\n    sudo \"chown -R #{user}:#{user_group} #{deploy_to}\"\n  end\n\n  #### sitemap_generator\u3092\u4f7f\u3063\u3066\u306a\u3044\u5834\u5408\u306f\u524a\u9664 ####\n  desc \"sitemap\u306e\u66f4\u65b0\"\n  task :refresh_sitemaps do\n    run \"cd #{latest_release} && RAILS_ENV=#{rails_env} bundle exec rake sitemap:refresh\"\n  end\n\n  # \u672c\u756a\u30b5\u30fc\u30d0\u3067Passenger\u4ee5\u5916\u3092\u4f7f\u3063\u3066\u3044\u308b\u5834\u5408\u306f\u9069\u5b9c\u5909\u66f4\u3057\u3066\u4e0b\u3055\u3044\u3002\n  desc \"Passenger\u7528\u306b\u8d77\u52d5/\u505c\u6b62\u30bf\u30b9\u30af\u3092\u5909\u66f4\"\n  task :restart, :roles => :web do\n    run \"touch #{current_path}/tmp/restart.txt\"\n  end\n\n  # page_cache\u3092\u4f7f\u7528\u3057\u3066\u3044\u306a\u3044\u5834\u5408\u306f\u4e0d\u8981\n  desc \"\u30ad\u30e3\u30c3\u30b7\u30e5html\u306e\u524a\u9664(deploy\u4e2d\u306b\u4e0d\u5b8c\u5168\u306ahtml\u3092\u751f\u6210\u3057\u306a\u3044\u305f\u3081\u306e\u5bfe\u7b56)\"\n  task :remove_caches, :roles => :web do\n    run \"rm -rf #{current_path}/public/index.html\"\n  end\n\n  #### Whenever\u3092\u4f7f\u3063\u3066\u3044\u306a\u3044\u5834\u5408\u306f\u524a\u9664\n  desc \"whenever\u306e\u30a2\u30c3\u30d7\u30c7\u30fc\u30c8\"\n  task :whenever_update do\n    run \"cd #{latest_release} && RAILS_ENV=#{rails_env} bundle exec whenever --update-crontab #{application} -f config/schedule_#{rails_env}.rb\"\n  end\nend\nbefore :deploy, \"deploy:set_file_process_owner\"\n```\n\nprod\u7528\u306e\u8a2d\u5b9a\n\n```ruby:app/config/deploy/production.rb\n#### \u30c7\u30d7\u30ed\u30a4\u5148\u306e\u30d5\u30a9\u30eb\u30c0\u3092\u8a2d\u5b9a\u3000####\nset :deploy_to, \"/var/www/deploy01/prod/app\u201d\nset :rails_env, \"production\"\n\n# deploy ==========================\nafter :deploy, \"maintenance:on\"\nafter :deploy, \"assets:precompile\"\nafter :deploy, \"deploy:migrate\"\nafter :deploy, \"deploy:restart\"\nafter :deploy, \"deploy:remove_caches\"\nafter :deploy, \"maintenance:off\"\nafter :deploy, \"deploy:cleanup\"\n```\n\n\ntest\u7528\u306e\u8a2d\u5b9a\n\n```ruby:app/config/deploy/test.rb\n#### \u30c7\u30d7\u30ed\u30a4\u5148\u306e\u30d5\u30a9\u30eb\u30c0\u3092\u8a2d\u5b9a\u3000####\nset :deploy_to, \"/var/www/deploy01/test/app\u201d\nset :rails_env, \u201ctest\u201d\n\n# deploy ==========================\nafter :deploy, \"assets:precompile\"\nafter :deploy, \"deploy:migrate\"\nafter :deploy, \"deploy:restart\"\nafter :deploy, \"deploy:remove_caches\"\nafter :deploy, \"deploy:cleanup\"\n```\n\n\u30e1\u30f3\u30c6\u30ca\u30f3\u30b9\u753b\u9762\u8868\u793a\u7528\u306bconfig/maintenance.yml\u3092\u8ffd\u52a0\u3002 \n\n```\n---\nreason: \u30e1\u30f3\u30c6\u30ca\u30f3\u30b9\u4e2d\u3067\u3059\nallowed_paths:\n- ^/help\n- ^/contact_us\nallowed_ips:\n- 127.0.0.1\n- 192.168.0.0/24\n```\n\n\u30ea\u30dd\u30b8\u30c8\u30ea\u3078\u306e\u30d1\u30b9\u30d5\u30ec\u30fc\u30ba\u5165\u529b\u3092\u7701\u7565\u3059\u308b\u305f\u3081\u3001ssh-agent\u306e\u8ffd\u52a0\u3092\u3059\u308b\n\u203b\u9375\u306b\u306fgit\u30ea\u30dd\u30b8\u30c8\u30ea\u306e\u79d8\u5bc6\u9375\u3092\u6307\u5b9a\n\n```\n# ssh-agent zsh\n# ssh-agent ~/.ssh/id_rsa\n```\n\n\u30c7\u30d7\u30ed\u30a4\u304c\u3067\u304d\u308b\u304b\u306e\u30c6\u30b9\u30c8\uff08\u521d\u56de\u306e\u307f\uff09\n\n```\ncap deploy:check\n```\n\n\u30c7\u30d7\u30ed\u30a4\u30b3\u30de\u30f3\u30c9\u4e00\u89a7\n\n```\n\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\uff08\u521d\u56de\u306b\u5b9f\u884c\uff09\n$ cap production deploy:setup\n$ cap test deploy:setup\n\n\u30c7\u30d7\u30ed\u30a4\u3092\u5b9f\u884c\n$ cap production deploy:cold\n$ cap test deploy:cold\n\n\u4ee5\u524d\u306e\u72b6\u614b\u306b\u623b\u3059\n$ cap production deploy:rollback\n$ cap test deploy:rollback\n\n\u4ee5\u524d\u306e\u72b6\u614b\u306e\u30bd\u30fc\u30b9\u30b3\u30fc\u30c9\u3092\u524a\u9664\n$ cap production deploy:cleanup\n$ cap test deploy:cleanup\n```\n\n### Apache\u306e\u8a2d\u5b9a\ndeploy\u304c\u5b8c\u4e86\u3057\u305f\u3089web01\u3068web02\u306ehttpd.conf\u306brails\u30a2\u30d7\u30ea\u306e\u8a2d\u5b9a\u3092\u884c\u3046\n\nxxx.xxx.xxx.xxx\u306b\u306fweb01\u306a\u3089web01\u306eIP\u3092\u8a18\u5165\n\n```vim:/etc/httpd/conf/httpd.conf \n# prod\n<VirtualHost *:80>\n  ServerName xxx.xxx.xxx.xxx\n  DocumentRoot /var/www/deploy01/prod/app/current/public/\n  ErrorLog  /var/log/httpd/prod_app_error.log\n  CustomLog /var/log/httpd/prod_app_access.log combined\n  <Directory \"/var/www/deploy01/prod/app/current/public\">\n        Options -MultiViews\n        AllowOverride All\n        Order allow,deny\n        Allow from all\n  </Directory>\n</VirtualHost>\n\n# test\n<VirtualHost *:8000>\n  RailsEnv test\n  ServerName xxx.xxx.xxx.xxx\n  DocumentRoot /var/www/deploy01/test/app/current/public/\n  ErrorLog  /var/log/httpd/test_app_error.log\n  CustomLog /var/log/httpd/test_app_access.log combined\n  <Directory \"/var/www/deploy01/test/app/current/public\">\n        Options -MultiViews\n        AllowOverride All\n        Order allow,deny\n        Allow from all\n  </Directory>\n</VirtualHost>\n```\n\nserverName\u3067virtualhost\u3092\u5206\u3051\u308b\u8a2d\u5b9a\u3092ON\u306b\u3059\u308b\u305f\u3081\n\u4e0b\u8a18\u884c\u306e\u30b3\u30e1\u30f3\u30c8\u3092\u5916\u3059\n\n```vim:/etc/httpd/conf/httpd.conf\n#NameVirtualHost *:80\n```\n\nweb01\u3068web02\u306eapache\u3092\u518d\u8d77\u52d5\n\n```\n$ sudo service httpd restart\n```\n\niptables\u3092\u505c\u6b62\u3057\u3066\u3001test\u3068prod\u74b0\u5883\u306b\u30a2\u30af\u30bb\u30b9\u3067\u304d\u308b\u304b\u78ba\u8a8d\n\n```\nhttp://xxx.xxx.xxx.xxx:80/\nhttp://xxx.xxx.xxx.xxx:8000/\n```\n\ntest\u3068prod\u74b0\u5883\u304c\u52d5\u3044\u3066\u3044\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3067\u304d\u305f\u3089iptables\u3092\u518d\u30b9\u30bf\u30fc\u30c8\u3059\u308b\n\n```\n$ sudo service iptables start\n```\n\n## \u30ea\u30d0\u30fc\u30b9\u30d7\u30ed\u30ad\u30b7\u306e\u8a2d\u5b9a\n\nrp01\u306ehttp.conf\u30d5\u30a1\u30a4\u30eb\u306b\u4e0b\u8a18\u30e2\u30b8\u30e5\u30fc\u30eb\u3092\u8a2d\u5b9a\n\n```vim:/etc/httpd/conf/httpd.conf\nLoadModule proxy_module modules/mod_proxy.so\nLoadModule proxy_balancer_module modules/mod_proxy_balancer.so\nLoadModule proxy_ftp_module modules/mod_proxy_ftp.so\nLoadModule proxy_http_module modules/mod_proxy_http.so\nLoadModule proxy_ajp_module modules/mod_proxy_ajp.so\nLoadModule proxy_connect_module modules/mod_proxy_connect.so\n```\n\n\u3055\u3089\u306b\u3001rp01\u306ehttp.conf\u306b\u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b5\u306e\u51e6\u7406\u3092\u8ffd\u52a0\n\n\u203bip\u30a2\u30c9\u30ec\u30b9\u3092\u30db\u30b9\u30c8\u540d\u306b\u7f6e\u304d\u63db\u3048\u3066\u307e\u3059\n\n```\n#prod\u74b0\u5883\u3078\u306e\u30a2\u30af\u30bb\u30b9\u3092\u300cxxx.com\u300d\n#test\u74b0\u5883\u3078\u306e\u30a2\u30af\u30bb\u30b9\u3092\u300ctest.xxx.com\u300d\u306e\u30b5\u30d6\u30c9\u30e1\u30a4\u30f3\u306b\u3057\u305f\u5834\u5408\u306e\u8a2d\u5b9a\n\n#prod\u8a2d\u5b9a\n<VirtualHost *:80>\n  ServerName xxx.com:80\n\n  ProxyPass /balancer-manager !\n  <Location /balancer-manager>\n          SetHandler balancer-manager\n  </Location>\n\n  ProxyPass / balancer://rp01/\n  ProxyPassReverse / balancer://rp01/\n\n  <Proxy balancer://rp01/>\n          BalancerMember http://web01:80 loadfactor=5\n          BalancerMember http://web02:80 loadfactor=5\n  </Proxy>\n</VirtualHost>\n\n#test\u8a2d\u5b9a\n<VirtualHost *:80>\n  ServerName test.xxx.com:80\n\n  ProxyPass /balancer-manager !\n  <Location /balancer-manager>\n          SetHandler balancer-manager\n  </Location>\n\n  ProxyPass / balancer://test-rp01/ \n  ProxyPassReverse / balancer://test-rp01/\n\n  <Proxy balancer://test-rp01/>\n          BalancerMember http://web01:8000 loadfactor=5\n          BalancerMember http://web02:8000 loadfactor=5\n  </Proxy>\n</VirtualHost>\n```\n\nloadfactor\u306e\u6570\u5b57\u3092\u5927\u304d\u304f\u3059\u308b\u3068\u3001\u4f7f\u7528\u983b\u5ea6\u304c\u5927\u304d\u304f\u306a\u308a\u307e\u3059\u3002\n\nweb01\u30fbweb02\u306eapache\u3092\u4ea4\u4e92\u306b\u505c\u6b62\u3057\u3066\u3001xxx.com\u306b\u30a2\u30af\u30bb\u30b9\u3067\u304d\u305f\u3089\u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b5\u306e\u8a2d\u5b9a\u304c\u5b8c\u4e86\u3057\u3066\u3044\u308b\u3002\n\n## \u4f59\u8ac7\n\nDTI\u306eVPS\u3092\u501f\u308a\u308c\u3070\u3001\u6708420\u5186 * 5\u53f0 = 2100\u5186\u3067\u5b9f\u73fe\u53ef\u80fd\u3067\u3059\u3002\nDTI\u306e\u5834\u5408\u3001aaa.bbb.ccc.1\u3068aaa.bbb.ccc.2\u306e\u3088\u3046\u306b\u3001\u30b0\u30ed\u30fc\u30d0\u30ebIP\u306e\uff14\u6841\u76ee\u4ee5\u5916\u304c\u540c\u3058\u306e\u5834\u5408\u306f\n\u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u4e0a\u3001\u901a\u4fe1\u304c\u51fa\u6765\u306a\u3044\u3088\u3046\u3067\u3059(T_T)", "tags": ["Rails", "deploy", "\u30b5\u30fc\u30d0\u30fc\u69cb\u7bc9", "proxy", "mydns"]}