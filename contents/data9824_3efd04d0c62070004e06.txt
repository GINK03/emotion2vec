{"tags": ["R", "\u6570\u5024\u8a08\u7b97"], "context": " More than 1 year has passed since last update.\u3053\u308c\u306a\u3089\u5206\u304b\u308b\u6700\u9069\u5316\u6570\u5b66 3.3 \u306b\u8a18\u8f09\u306e\u901a\u308a\u3001\u5171\u5f79\u52fe\u914d\u6cd5\u3092\u7528\u3044\u3066\u3001\u95a2\u6570\u306b\u6700\u5927\u5024\u30fb\u6700\u5c0f\u5024\u3092\u53d6\u3089\u305b\u308b\u5909\u6570\u306e\u5024\u3092\u6c42\u3081\u307e\u3059\u3002\u4ee5\u4e0b\u306e\u4f8b\u3067\u306f\u6700\u5927\u5024\u3092\u53d6\u308b\u70b9\u3092\u6c42\u3081\u3066\u3044\u307e\u3059\u3002\n\u306a\u304a\u3001\u63a2\u7d22\u76f4\u7dda\u306f\u3001\u524d\u56de\u306e\u63a2\u7d22\u76f4\u7dda\u306e\u65b9\u5411\u3068\u30d8\u30c3\u30bb\u884c\u5217\u306b\u95a2\u3057\u3066\u5171\u5f79\u306a\u65b9\u5411\u3092\u5411\u3044\u3066\u3044\u307e\u3059\u3002if\u6587\u306b\u3088\u308b\u5207\u308a\u66ff\u3048\u3067\u3001Polak-Ribiere\u306e\u5f0f\u306b\u3088\u308b\u8fd1\u4f3c\u3092\u7528\u3044\u305f\u65b9\u5411\u3092\u5411\u304b\u305b\u308b\u3053\u3068\u3082\u3067\u304d\u307e\u3059\u3002\n\u307e\u305f\u3001\u63a2\u7d22\u76f4\u7dda\u4e0a\u3067\u306f\u3001\u4e0e\u3048\u3089\u308c\u305f\u95a2\u6570\u306b\u5bfe\u3057\u3066\u901a\u5e38\u306e\u52fe\u914d\u6cd5\u306b\u3088\u308b\u63a2\u7d22\u3092\u884c\u3063\u3066\u3044\u307e\u3059\u3002\u4f8b\u984c3.5\u306e\u3088\u3046\u306b\u30012\u6b21\u8fd1\u4f3c\u3092\u7528\u3044\u3066\u89e3\u6790\u7684\u306b\u63a2\u7d22\u76f4\u7dda\u4e0a\u306e\u89e3\u3092\u6c42\u3081\u308b\u3053\u3068\u306f\u3057\u3066\u3044\u307e\u305b\u3093\u3002\n\nframe()\npar(mfcol=c(1, 2))\npar(mar=c(2, 2, 1, 0.1))\npar(mgp=c(1, 0.2, 0))\n\nsearch <- function(x0, delta, f, df) {\n\n    x <- x0\n    h <- 0.7\n    eps <- 1e-6\n    i <- 1\n    # \u89e3\u306e\u79fb\u52d5\u91cf\u304c\u5341\u5206\u5c0f\u3055\u304f\u306a\u308b\u307e\u3067\u7e70\u308a\u8fd4\u3059\u3002\n    repeat {\n        oldx <- x\n        # df(x)\u306e\u7b26\u53f7\u306b\u3088\u3063\u3066\u3001\u9032\u3080\u65b9\u5411\u3092\u6c7a\u3081\u308b\u3002\n        h <- sign(df(x)) * abs(h)\n        newx <- x + h * delta\n        if (f(x) < f(newx)) {\n            # \u95a2\u6570\u5024\u304c\u5897\u5927\u3059\u308b\u9650\u308a\u3001\u30b9\u30c6\u30c3\u30d7\u5e45\u3092\u500d\u306b\u3057\u3066\u3044\u304f\u3002\n            repeat {\n                h <- 2 * h\n                x <- newx\n                newx <- x + h * delta\n                if (f(x) >= f(newx)) {\n                    break\n                }\n            }\n            h <- h / 2\n        } else {\n            # \u95a2\u6570\u5024\u304c\u6e1b\u5c11\u3057\u3066\u3057\u307e\u3046\u3068\u304d\u306f\u3001\u30b9\u30c6\u30c3\u30d7\u5e45\u3092\u534a\u5206\u306b\u3057\u3066\u3044\u304d\u3001\n            # \u95a2\u6570\u5024\u304c\u5897\u5927\u3059\u308b\u4f4d\u7f6e\u3092\u898b\u3064\u3051\u308b\u3002\n            repeat {\n                h <- h / 2\n                newx <- x + h * delta\n                if (f(x) <= f(newx)) {\n                    break\n                }\n            }\n            x <- newx\n            h <- 2 * h\n        }\n        cat(\"search i=\", i, \"x=\" , x, \"f(x)=\", f(x), \"df(x)=\", df(x), \"h=\", h, \"\\n\")\n        if (abs(h) < eps) {\n            break\n        }\n        i <- i + 1\n    }\n    x\n}\n\nconjugatedescent <- function(x0, f, df, dxdx, dxdy, dydx, dydy) {\n\n    x <- x0\n    eps <- 1e-12\n    i <- 1\n    m <- rep(0, length(x0))\n    repeat {\n        oldx <- x\n        oldm <- m\n        # \u52fe\u914d\u2207f\u3092\u6c42\u3081\u308b\u3002\n        gradientf <- c(dx(x), dy(x))\n        # \u5171\u5f79\u52fe\u914dm\u3092\u6c42\u3081\u308b\u3002\n        if (i == 1) {\n            # \u6700\u521d\u306f\u2207f\u306e\u65b9\u5411\u306b\u63a2\u7d22\u3059\u308b\u3002\n            alpha <- 0\n        } else {\n            if (T) {\n                # alpha\u306e\u5b9a\u7fa9\u901a\u308a\u30d8\u30c3\u30bb\u884c\u5217\u3092\u4f7f\u7528\n                H <- matrix(c(dxdx(x), dxdy(x), dydx(x), dydy(x)), 2, byrow=T)\n                alpha <- -(oldm %*% (H %*% gradientf)) / (oldm %*% (H %*% oldm))\n            } else {\n                # alpha\u3092Polak-Ribiere\u306e\u5f0f\u3067\u8fd1\u4f3c\n                alpha <- (gradientf %*% (gradientf - oldgradientf)) / (oldgradientf %*% oldgradientf)\n            }\n        }\n        m <- gradientf + alpha * oldm\n        cat(\"conjugatedescent i=\", i, \"x=\" , x, \"f(x)=\", f(x), \"m=\", m, \"\\n\")\n        # \u63a2\u7d22\u76f4\u7dda\u4e0a\u306e\u95a2\u6570F(t)=f(x(t))\u306b\u3064\u3044\u3066\u30011\u968e\u5fae\u5206dF/dt=\u2207f^T * \u2207m\u3092\u6c42\u3081\u308b\u3002\n        df <- function(x) { as.numeric(c(dx(x), dy(x)) %*% m) }\n        # \u63a2\u7d22\u76f4\u7dda\u306e\u65b9\u5411\u30d9\u30af\u30c8\u30eb\u3092\u6b63\u898f\u5316\u3059\u308b\u3002\n        delta <- scale(m, center=F)\n        # \u76f4\u7dda\u63a2\u7d22\u3059\u308b\u3002\n        x <- search(x, delta, f, df)\n        # \u8ecc\u8de1\u3092\u63cf\u753b\u3059\u308b\u3002\n        xy <- cbind(oldx, x)\n        lines(xy[1, ], xy[2, ], type=\"o\", col=1)\n        diff = x - oldx\n        # ||\u0394x||^2 \u304c\u5341\u5206\u5c0f\u3055\u304f\u306a\u308b\u307e\u3067\u7e70\u308a\u8fd4\u3059\u3002\n        if (sum(diff * diff) < eps) {\n            break\n        }\n        oldgradientf <- gradientf\n        i <- i + 1\n    }\n    x\n}\n\ndraw <- function() {\n    xgrid <- seq(-3, 3, 0.1)\n    ygrid <- seq(-3, 3, 0.1)\n    zgrid <- outer(xgrid, ygrid, Vectorize(function(x, y){ f(c(x, y)) }))\n    image(xgrid, ygrid, zgrid, xlim=range(xgrid), ylim=range(ygrid), xlab=\"x[1]\", ylab=\"x[2]\", main=\"f(x)\", col=rainbow(450)[256:1])\n    contour(xgrid, ygrid, zgrid, xlim=range(xgrid), ylim=range(ygrid), add=T)\n    conjugatedescent(c(1, 0.5), f, dx, dxdx, dxdy, dydx, dydy)\n}\n\nf <- function(x){ -x[1] ^ 2 - 4 * x[2] ^ 2 + 5 * x[1] }\ndx <- function(x){ -2 * x[1] + 5 }\ndy <- function(x){ - 8 * x[2] }\ndxdx <- function(x){ -2 }\ndxdy <- function(x){ 0 }\ndydx <- function(x){ 0 }\ndydy <- function(x){ -8 }\ndraw()\n\nf <- function(x){ cos(x[1]) + cos(x[2]) }\ndx <- function(x){ -sin(x[1]) }\ndy <- function(x){ -sin(x[2]) }\ndxdx <- function(x){ -cos(x[1]) }\ndxdy <- function(x){ 0 }\ndydx <- function(x){ 0 }\ndydy <- function(x){ -cos(x[2]) }\ndraw()\n\n# f <- function(x){ -(x[1] ^ 3 + x[2] ^ 3 - 9 * x[1] * x[2] + 27) }\n# dx <- function(x){ -(3 * x[1] ^ 2 - 9 * x[2]) }\n# dy <- function(x){ -(3 * x[2] ^ 2 - 9 * x[1]) }\n# dxdx <- function(x){ -6 * x[1] }\n# dxdy <- function(x){ 9 }\n# dydx <- function(x){ 9 }\n# dydy <- function(x){ -6 * x[2] }\n# draw()\n\n[\u3053\u308c\u306a\u3089\u5206\u304b\u308b\u6700\u9069\u5316\u6570\u5b66](http://www.amazon.co.jp/dp/4320017862) 3.3 \u306b\u8a18\u8f09\u306e\u901a\u308a\u3001\u5171\u5f79\u52fe\u914d\u6cd5\u3092\u7528\u3044\u3066\u3001\u95a2\u6570\u306b\u6700\u5927\u5024\u30fb\u6700\u5c0f\u5024\u3092\u53d6\u3089\u305b\u308b\u5909\u6570\u306e\u5024\u3092\u6c42\u3081\u307e\u3059\u3002\u4ee5\u4e0b\u306e\u4f8b\u3067\u306f\u6700\u5927\u5024\u3092\u53d6\u308b\u70b9\u3092\u6c42\u3081\u3066\u3044\u307e\u3059\u3002\n\n\u306a\u304a\u3001\u63a2\u7d22\u76f4\u7dda\u306f\u3001\u524d\u56de\u306e\u63a2\u7d22\u76f4\u7dda\u306e\u65b9\u5411\u3068\u30d8\u30c3\u30bb\u884c\u5217\u306b\u95a2\u3057\u3066\u5171\u5f79\u306a\u65b9\u5411\u3092\u5411\u3044\u3066\u3044\u307e\u3059\u3002if\u6587\u306b\u3088\u308b\u5207\u308a\u66ff\u3048\u3067\u3001Polak-Ribiere\u306e\u5f0f\u306b\u3088\u308b\u8fd1\u4f3c\u3092\u7528\u3044\u305f\u65b9\u5411\u3092\u5411\u304b\u305b\u308b\u3053\u3068\u3082\u3067\u304d\u307e\u3059\u3002\n\n\u307e\u305f\u3001\u63a2\u7d22\u76f4\u7dda\u4e0a\u3067\u306f\u3001\u4e0e\u3048\u3089\u308c\u305f\u95a2\u6570\u306b\u5bfe\u3057\u3066\u901a\u5e38\u306e\u52fe\u914d\u6cd5\u306b\u3088\u308b\u63a2\u7d22\u3092\u884c\u3063\u3066\u3044\u307e\u3059\u3002\u4f8b\u984c3.5\u306e\u3088\u3046\u306b\u30012\u6b21\u8fd1\u4f3c\u3092\u7528\u3044\u3066\u89e3\u6790\u7684\u306b\u63a2\u7d22\u76f4\u7dda\u4e0a\u306e\u89e3\u3092\u6c42\u3081\u308b\u3053\u3068\u306f\u3057\u3066\u3044\u307e\u305b\u3093\u3002\n\n![OPT5.ConjugateGradient.png](https://qiita-image-store.s3.amazonaws.com/0/12670/daf5235d-65e6-e890-a2bf-9a9fc1239bf4.png)\n\n```r\nframe()\npar(mfcol=c(1, 2))\npar(mar=c(2, 2, 1, 0.1))\npar(mgp=c(1, 0.2, 0))\n\nsearch <- function(x0, delta, f, df) {\n\t\n\tx <- x0\n\th <- 0.7\n\teps <- 1e-6\n\ti <- 1\n\t# \u89e3\u306e\u79fb\u52d5\u91cf\u304c\u5341\u5206\u5c0f\u3055\u304f\u306a\u308b\u307e\u3067\u7e70\u308a\u8fd4\u3059\u3002\n\trepeat {\n\t\toldx <- x\n\t\t# df(x)\u306e\u7b26\u53f7\u306b\u3088\u3063\u3066\u3001\u9032\u3080\u65b9\u5411\u3092\u6c7a\u3081\u308b\u3002\n\t\th <- sign(df(x)) * abs(h)\n\t\tnewx <- x + h * delta\n\t\tif (f(x) < f(newx)) {\n\t\t\t# \u95a2\u6570\u5024\u304c\u5897\u5927\u3059\u308b\u9650\u308a\u3001\u30b9\u30c6\u30c3\u30d7\u5e45\u3092\u500d\u306b\u3057\u3066\u3044\u304f\u3002\n\t\t\trepeat {\n\t\t\t\th <- 2 * h\n\t\t\t\tx <- newx\n\t\t\t\tnewx <- x + h * delta\n\t\t\t\tif (f(x) >= f(newx)) {\n\t\t\t\t\tbreak\n\t\t\t\t}\n\t\t\t}\n\t\t\th <- h / 2\n\t\t} else {\n\t\t\t# \u95a2\u6570\u5024\u304c\u6e1b\u5c11\u3057\u3066\u3057\u307e\u3046\u3068\u304d\u306f\u3001\u30b9\u30c6\u30c3\u30d7\u5e45\u3092\u534a\u5206\u306b\u3057\u3066\u3044\u304d\u3001\n\t\t\t# \u95a2\u6570\u5024\u304c\u5897\u5927\u3059\u308b\u4f4d\u7f6e\u3092\u898b\u3064\u3051\u308b\u3002\n\t\t\trepeat {\n\t\t\t\th <- h / 2\n\t\t\t\tnewx <- x + h * delta\n\t\t\t\tif (f(x) <= f(newx)) {\n\t\t\t\t\tbreak\n\t\t\t\t}\n\t\t\t}\n\t\t\tx <- newx\n\t\t\th <- 2 * h\n\t\t}\n\t\tcat(\"search i=\", i, \"x=\" , x, \"f(x)=\", f(x), \"df(x)=\", df(x), \"h=\", h, \"\\n\")\n\t\tif (abs(h) < eps) {\n\t\t\tbreak\n\t\t}\n\t\ti <- i + 1\n\t}\n\tx\n}\n\nconjugatedescent <- function(x0, f, df, dxdx, dxdy, dydx, dydy) {\n\t\n\tx <- x0\n\teps <- 1e-12\n\ti <- 1\n\tm <- rep(0, length(x0))\n\trepeat {\n\t\toldx <- x\n\t\toldm <- m\n\t\t# \u52fe\u914d\u2207f\u3092\u6c42\u3081\u308b\u3002\n\t\tgradientf <- c(dx(x), dy(x))\n\t\t# \u5171\u5f79\u52fe\u914dm\u3092\u6c42\u3081\u308b\u3002\n\t\tif (i == 1) {\n\t\t\t# \u6700\u521d\u306f\u2207f\u306e\u65b9\u5411\u306b\u63a2\u7d22\u3059\u308b\u3002\n\t\t\talpha <- 0\n\t\t} else {\n\t\t\tif (T) {\n\t\t\t\t# alpha\u306e\u5b9a\u7fa9\u901a\u308a\u30d8\u30c3\u30bb\u884c\u5217\u3092\u4f7f\u7528\n\t\t\t\tH <- matrix(c(dxdx(x), dxdy(x), dydx(x), dydy(x)), 2, byrow=T)\n\t\t\t\talpha <- -(oldm %*% (H %*% gradientf)) / (oldm %*% (H %*% oldm))\n\t\t\t} else {\n\t\t\t\t# alpha\u3092Polak-Ribiere\u306e\u5f0f\u3067\u8fd1\u4f3c\n\t\t\t\talpha <- (gradientf %*% (gradientf - oldgradientf)) / (oldgradientf %*% oldgradientf)\n\t\t\t}\n\t\t}\n\t\tm <- gradientf + alpha * oldm\n\t\tcat(\"conjugatedescent i=\", i, \"x=\" , x, \"f(x)=\", f(x), \"m=\", m, \"\\n\")\n\t\t# \u63a2\u7d22\u76f4\u7dda\u4e0a\u306e\u95a2\u6570F(t)=f(x(t))\u306b\u3064\u3044\u3066\u30011\u968e\u5fae\u5206dF/dt=\u2207f^T * \u2207m\u3092\u6c42\u3081\u308b\u3002\n\t\tdf <- function(x) { as.numeric(c(dx(x), dy(x)) %*% m) }\n\t\t# \u63a2\u7d22\u76f4\u7dda\u306e\u65b9\u5411\u30d9\u30af\u30c8\u30eb\u3092\u6b63\u898f\u5316\u3059\u308b\u3002\n\t\tdelta <- scale(m, center=F)\n\t\t# \u76f4\u7dda\u63a2\u7d22\u3059\u308b\u3002\n\t\tx <- search(x, delta, f, df)\n\t\t# \u8ecc\u8de1\u3092\u63cf\u753b\u3059\u308b\u3002\n\t\txy <- cbind(oldx, x)\n\t\tlines(xy[1, ], xy[2, ], type=\"o\", col=1)\n\t\tdiff = x - oldx\n\t\t# ||\u0394x||^2 \u304c\u5341\u5206\u5c0f\u3055\u304f\u306a\u308b\u307e\u3067\u7e70\u308a\u8fd4\u3059\u3002\n\t\tif (sum(diff * diff) < eps) {\n\t\t\tbreak\n\t\t}\n\t\toldgradientf <- gradientf\n\t\ti <- i + 1\n\t}\n\tx\n}\n\ndraw <- function() {\n\txgrid <- seq(-3, 3, 0.1)\n\tygrid <- seq(-3, 3, 0.1)\n\tzgrid <- outer(xgrid, ygrid, Vectorize(function(x, y){ f(c(x, y)) }))\n\timage(xgrid, ygrid, zgrid, xlim=range(xgrid), ylim=range(ygrid), xlab=\"x[1]\", ylab=\"x[2]\", main=\"f(x)\", col=rainbow(450)[256:1])\n\tcontour(xgrid, ygrid, zgrid, xlim=range(xgrid), ylim=range(ygrid), add=T)\n\tconjugatedescent(c(1, 0.5), f, dx, dxdx, dxdy, dydx, dydy)\n}\n\nf <- function(x){ -x[1] ^ 2 - 4 * x[2] ^ 2 + 5 * x[1] }\ndx <- function(x){ -2 * x[1] + 5 }\ndy <- function(x){ - 8 * x[2] }\ndxdx <- function(x){ -2 }\ndxdy <- function(x){ 0 }\ndydx <- function(x){ 0 }\ndydy <- function(x){ -8 }\ndraw()\n\nf <- function(x){ cos(x[1]) + cos(x[2]) }\ndx <- function(x){ -sin(x[1]) }\ndy <- function(x){ -sin(x[2]) }\ndxdx <- function(x){ -cos(x[1]) }\ndxdy <- function(x){ 0 }\ndydx <- function(x){ 0 }\ndydy <- function(x){ -cos(x[2]) }\ndraw()\n\n# f <- function(x){ -(x[1] ^ 3 + x[2] ^ 3 - 9 * x[1] * x[2] + 27) }\n# dx <- function(x){ -(3 * x[1] ^ 2 - 9 * x[2]) }\n# dy <- function(x){ -(3 * x[2] ^ 2 - 9 * x[1]) }\n# dxdx <- function(x){ -6 * x[1] }\n# dxdy <- function(x){ 9 }\n# dydx <- function(x){ 9 }\n# dydy <- function(x){ -6 * x[2] }\n# draw()\n```\n"}