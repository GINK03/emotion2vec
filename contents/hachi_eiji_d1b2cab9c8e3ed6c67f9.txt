{"context": "CircleCI\u304b\u3089DodeDeploy\u3092\u5b9f\u884c\u3059\u308b\u3068\u304d\u306b30\u5206\u4ee5\u4e0a\u304b\u304b\u308b\u3068 watch_application_deployment \u3067\u30a8\u30e9\u30fc\u306b\u306a\u308b\u3002\n\u30b5\u30dd\u30fc\u30c8\u306b\u554f\u3044\u5408\u308f\u305b\u3066\u3082\u3044\u3044\u56de\u7b54\u5f97\u3089\u308c\u306a\u304b\u3063\u305f\u306e\u3067\u81ea\u5206\u3067\u30b7\u30a7\u30eb\u4f5c\u3063\u305f\n#!/bin/bash\n\nset -eu\n\nusage()\n{\n    cat <<EOF\n$(basename ${0}) is deploy tool on CodeDeploy\n\nUsage:\n    $(basename ${0}) <parameters>\n\nParameters:\n    --application-name      application name\n    --deployment-group-name deployment group\n    --bucket                bucket name\n    --key                   file key\n    --region                aws region (default: ap-northeast-1)\n    --debug                 debug\nOptions:\n    --help, -h print this\nEOF\n}\n\nwatch_deployment()\n{\n    deployment_id=\"$1\"\n    region=\"$2\"\n    deploy_info=`aws deploy get-deployment --region ${region} --deployment-id \"$deployment_id\"`\n    deploy_status=`ruby -e \"require 'json'; d = JSON.parse('$deploy_info'); puts d['deploymentInfo']['status']\"`\n\n    case \"$deploy_status\" in\n        Succeeded)\n            echo \"status is Succeeded\"\n            exit 0\n            ;;\n        Created|Queued|InProgress)\n            ruby -e \"require 'json'; d = JSON.parse('$deploy_info'); puts Time.now.strftime('%Y-%m-%d %H:%M:%S') + ' ' + d['deploymentInfo']['deploymentOverview'].to_s\"\n            sleep 5\n            watch_deployment $deployment_id $region\n            ;;\n        Failed)\n            echo \"status is Failed\"\n            exit 1\n            ;;\n        *)\n            echo \"get unknown status ${deploy_status}\"\n            exit 1\n            ;;\n    esac\n}\n\n\nAPP_NAME=''\nBUCKET=''\nDEPLOYMENT_GROUP_NAME=''\nKEY=''\nREGION='ap-northeast-1'\nDEBUG=''\n\nwhile [ $# -gt 0 ];\ndo\n    case ${1} in\n        --application-name)\n            APP_NAME=${2}\n            shift\n        ;;\n        --bucket)\n            BUCKET=\"${2}\"\n            shift\n        ;;\n        --key)\n            KEY=\"${2}\"\n            shift\n        ;;\n        --deployment-group-name)\n            DEPLOYMENT_GROUP_NAME=\"${2}\"\n            shift\n        ;;\n        --region)\n            REGION=\"${2}\"\n            shift\n        ;;\n        --debug)\n            DEBUG='--debug'\n        ;;\n        --help|-h)\n            usage\n            exit 0\n        ;;\n        *)\n            echo \"[ERROR] invalid option ${1}\"\n            usage\n            exit 1\n        ;;\n    esac\n    shift\ndone\n\n# \u30c7\u30d7\u30ed\u30a4\u5b9f\u884c&\u30b9\u30c6\u30fc\u30bf\u30b9\u3092\u78ba\u8a8d\u3059\u308b\nif [ -z \"$APP_NAME\" -o -z \"$BUCKET\" -o -z \"${KEY}\" -o -z \"$DEPLOYMENT_GROUP_NAME\" ]; then\n    echo \"[ERROR] parameter invalid\"\n    usage\n    exit 1\nfi\n\nS3_LOCATION=\"${BUCKET}/${KEY}\"\necho \"${APP_NAME} deploy to ${S3_LOCATION}\"\n\naws deploy push ${DEBUG} --ignore-hidden-files \\\n    --region ${REGION} \\\n    --application-name ${APP_NAME} \\\n    --s3-location s3://${S3_LOCATION}\n\nresponse=`aws deploy create-deployment ${DEBUG} \\\n    --region ${REGION} \\\n    --application-name ${APP_NAME} \\\n    --deployment-group-name ${DEPLOYMENT_GROUP_NAME} \\\n    --s3-location bucket=${BUCKET},bundleType=zip,key=${KEY}`\ndeployment_id=`ruby -e \"require 'json'; d = JSON.parse('$response'); puts d['deploymentId']\"`\n\nwatch_deployment $deployment_id $REGION\n\n\n\nCircleCI\u304b\u3089DodeDeploy\u3092\u5b9f\u884c\u3059\u308b\u3068\u304d\u306b30\u5206\u4ee5\u4e0a\u304b\u304b\u308b\u3068 `watch_application_deployment` \u3067\u30a8\u30e9\u30fc\u306b\u306a\u308b\u3002\n\u30b5\u30dd\u30fc\u30c8\u306b\u554f\u3044\u5408\u308f\u305b\u3066\u3082\u3044\u3044\u56de\u7b54\u5f97\u3089\u308c\u306a\u304b\u3063\u305f\u306e\u3067\u81ea\u5206\u3067\u30b7\u30a7\u30eb\u4f5c\u3063\u305f\n\n```bash\n#!/bin/bash\n\nset -eu\n\nusage()\n{\n\tcat <<EOF\n$(basename ${0}) is deploy tool on CodeDeploy\n\nUsage:\n\t$(basename ${0}) <parameters>\n\nParameters:\n\t--application-name\t\tapplication name\n\t--deployment-group-name\tdeployment group\n\t--bucket\t\t\t\tbucket name\n\t--key\t\t\t\t\tfile key\n\t--region\t\t\t\taws region (default: ap-northeast-1)\n\t--debug\t\t\t\t\tdebug\nOptions:\n\t--help, -h print this\nEOF\n}\n\nwatch_deployment()\n{\n\tdeployment_id=\"$1\"\n\tregion=\"$2\"\n\tdeploy_info=`aws deploy get-deployment --region ${region} --deployment-id \"$deployment_id\"`\n\tdeploy_status=`ruby -e \"require 'json'; d = JSON.parse('$deploy_info'); puts d['deploymentInfo']['status']\"`\n\n\tcase \"$deploy_status\" in\n\t\tSucceeded)\n\t\t\techo \"status is Succeeded\"\n\t\t\texit 0\n\t\t\t;;\n\t\tCreated|Queued|InProgress)\n\t\t\truby -e \"require 'json'; d = JSON.parse('$deploy_info'); puts Time.now.strftime('%Y-%m-%d %H:%M:%S') + ' ' + d['deploymentInfo']['deploymentOverview'].to_s\"\n\t\t\tsleep 5\n\t\t\twatch_deployment $deployment_id $region\n\t\t\t;;\n\t\tFailed)\n\t\t\techo \"status is Failed\"\n\t\t\texit 1\n\t\t\t;;\n\t\t*)\n\t\t\techo \"get unknown status ${deploy_status}\"\n\t\t\texit 1\n\t\t\t;;\n\tesac\n}\n\n\nAPP_NAME=''\nBUCKET=''\nDEPLOYMENT_GROUP_NAME=''\nKEY=''\nREGION='ap-northeast-1'\nDEBUG=''\n\nwhile [ $# -gt 0 ];\ndo\n\tcase ${1} in\n\t\t--application-name)\n\t\t\tAPP_NAME=${2}\n\t\t\tshift\n\t\t;;\n\t\t--bucket)\n\t\t\tBUCKET=\"${2}\"\n\t\t\tshift\n\t\t;;\n\t\t--key)\n\t\t\tKEY=\"${2}\"\n\t\t\tshift\n\t\t;;\n\t\t--deployment-group-name)\n\t\t\tDEPLOYMENT_GROUP_NAME=\"${2}\"\n\t\t\tshift\n\t\t;;\n\t\t--region)\n\t\t\tREGION=\"${2}\"\n\t\t\tshift\n\t\t;;\n\t\t--debug)\n\t\t\tDEBUG='--debug'\n\t\t;;\n\t\t--help|-h)\n\t\t\tusage\n\t\t\texit 0\n\t\t;;\n\t\t*)\n\t\t\techo \"[ERROR] invalid option ${1}\"\n\t\t\tusage\n\t\t\texit 1\n\t\t;;\n\tesac\n\tshift\ndone\n\n# \u30c7\u30d7\u30ed\u30a4\u5b9f\u884c&\u30b9\u30c6\u30fc\u30bf\u30b9\u3092\u78ba\u8a8d\u3059\u308b\nif [ -z \"$APP_NAME\" -o -z \"$BUCKET\" -o -z \"${KEY}\" -o -z \"$DEPLOYMENT_GROUP_NAME\" ]; then\n\techo \"[ERROR] parameter invalid\"\n\tusage\n\texit 1\nfi\n\nS3_LOCATION=\"${BUCKET}/${KEY}\"\necho \"${APP_NAME} deploy to ${S3_LOCATION}\"\n\naws deploy push ${DEBUG} --ignore-hidden-files \\\n\t--region ${REGION} \\\n\t--application-name ${APP_NAME} \\\n\t--s3-location s3://${S3_LOCATION}\n\nresponse=`aws deploy create-deployment ${DEBUG} \\\n\t--region ${REGION} \\\n\t--application-name ${APP_NAME} \\\n\t--deployment-group-name ${DEPLOYMENT_GROUP_NAME} \\\n\t--s3-location bucket=${BUCKET},bundleType=zip,key=${KEY}`\ndeployment_id=`ruby -e \"require 'json'; d = JSON.parse('$response'); puts d['deploymentId']\"`\n\nwatch_deployment $deployment_id $REGION\n\n```\n", "tags": ["CodeDeploy", "CircleCI"]}