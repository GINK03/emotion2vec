{"context": "\u3053\u3061\u3089\u304b\u3089\u306e\u8ee2\u8f09\u3067\u3059\u3002\n\n\u6700\u8fd1\n\u30ae\u30e7\u30fc\u30e0\u3067 S3 \u30d0\u30b1\u30c3\u30c8\u3092\u66f4\u65b0\u3059\u308b\u4f5c\u696d\u304c\u3042\u3063\u305f\u306e\u3067\u3001\u307b\u306e\u307c\u306e Rake \u30bf\u30b9\u30af\u3067\u6c4e\u7528\u7684\u306b\u7ba1\u7406\u51fa\u6765\u308b\u611f\u3058\u306b\u3057\u3066\u307f\u307e\u3057\u305f\u3002\n\n\u30bf\u30b9\u30af\n\nRakefile\nrequire 'aws-sdk'\nrequire 'diffy'\nrequire 'json'\n\nPOLICY_DIR='policies/'\n\ndef s3\n  Aws.config[:credentials] = Aws::SharedCredentials.new(profile_name: '\u3042\u306a\u305f\u306e\u30d7\u30ed\u30d5\u30a1\u30a4\u30eb')\n  Aws::S3::Client.new(region: 'ap-northeast-1')\nend\n\ndef get_bucket_policy(bucket)\n  begin\n    resp = s3.get_bucket_policy({\n      bucket: bucket\n    })\n    JSON.parse(resp.policy.read)\n  rescue JSON::ParserError => e\n    puts e\n  end\nend\n\ndef open_policy_document(path)\n  begin\n    File.open(POLICY_DIR + path) do |file|\n      JSON.load(file)\n    end\n  rescue JSON::ParserError => e\n    puts e\n  end\nend\n\ndef valid_json?(json)\n  begin\n    JSON.parse(json)\n    return true\n  rescue JSON::ParserError => e\n    return false\n  end\nend\n\nnamespace :s3 do\n\n  namespace :policy do\n\n    desc \"S3 \u30d0\u30b1\u30c3\u30c8 policy \u3092\u53d6\u5f97\u3059\u308b\"\n    task :export, :bucket do |task, args|\n      puts \"#{args[:bucket]} \u306e policy \u3092\u53d6\u5f97\u3057\u307e\u3059...\"\n      hash = get_bucket_policy(args[:bucket])\n      puts JSON.pretty_generate(hash)\n      File.open(POLICY_DIR + args[:bucket], \"w\") do |f| \n        f.puts(JSON.pretty_generate(hash))\n      end\n    end\n\n    desc \"S3 \u30d0\u30b1\u30c3\u30c8 policy \u3092\u8868\u793a\u3059\u308b\"\n    task :view, :bucket do |task, args|\n      puts \"#{args[:bucket]} \u306e policy \u3092\u8868\u793a\u3057\u307e\u3059...\"\n      hash = get_bucket_policy(args[:bucket])\n      puts JSON.pretty_generate(hash)\n    end\n\n    targets = []\n    Dir.glob(POLICY_DIR + '*').each do |file|\n      target = File.basename(file)\n      target = \"_#{target}\" if target == \"default\"\n      targets << target\n    end\n\n    targets.each do |target|\n      namespace target.to_sym do\n        desc \"S3 \u30d0\u30b1\u30c3\u30c8 #{target} \u306e policy \u3092\u5909\u66f4\u3059\u308b\"\n        task :update do\n          resp = s3.put_bucket_policy({\n            bucket: \"#{target}\",\n            policy: open_policy_document(target).to_json\n          })\n          puts resp\n        end\n\n        desc \"S3 \u30d0\u30b1\u30c3\u30c8 #{target} \u306b\u9069\u7528\u3059\u308b policy \u3068\u65e2\u5b58\u306e\u30dd\u30ea\u30b7\u30fc\u3092\u6bd4\u8f03\u3059\u308b\"\n        task :diff do\n          hash = get_bucket_policy(target)\n          old = JSON.pretty_generate(hash)\n          new = JSON.pretty_generate(open_policy_document(target))\n          puts Diffy::Diff.new(old, new).to_s(:color)\n        end\n\n      end\n    end\n  end\nend\n\n\n\u4f7f\u3044\u65b9\n\n\u521d\u671f\u72b6\u614b\u306e tasks\n\n$ bundle exec rake -T\nrake s3:policy:export[bucket]          # S3 \u30d0\u30b1\u30c3\u30c8 policy \u3092\u53d6\u5f97\u3059\u308b\nrake s3:policy:view[bucket]            # S3 \u30d0\u30b1\u30c3\u30c8 policy \u3092\u8868\u793a\u3059\u308b\n\n\n\u30d0\u30b1\u30c3\u30c8\u30dd\u30ea\u30b7\u30fc\u3092 export \u3057\u307e\u3057\u3087\u3046\n\n$ mkdir policies\n$ bundle exec rake \"s3:policy:export[hage.inokara.com]\"\n\n\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u51fa\u529b\u3055\u308c\u307e\u3059\u3002\nhage.inokara.com \u306e policy \u3092\u53d6\u5f97\u3057\u307e\u3059...\n{\n  \"Version\": \"2008-10-17\",\n  \"Statement\": [\n    {\n      \"Sid\": \"AllowPublicRead\",\n      \"Effect\": \"Allow\",\n      \"Principal\": {\n        \"AWS\": \"*\"\n      },\n      \"Action\": \"s3:GetObject\",\n      \"Resource\": \"arn:aws:s3:::hage.inokara.com/*\"\n    }\n  ]\n}\n\n\u30c7\u30d5\u30a9\u30eb\u30c8\u3067\u306f\u30ab\u30ec\u30f3\u30c8\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306e policies \u3068\u3044\u3046\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u4ee5\u4e0b\u306b\u30d0\u30b1\u30c3\u30c8\u540d\u3068\u540c\u3058\u540d\u524d\u306e\u30dd\u30ea\u30b7\u30fc\u30d5\u30a1\u30a4\u30eb\u304c\u4f5c\u6210\u3055\u308c\u3066\u3044\u307e\u3059\u3002\nbash-3.2$ ls -l policies/\ntotal 8\n-rw-r--r--  1 syorou  staff  253 Nov 23 11:58 hage.inokara.com\n\ntasks \u3082\u78ba\u8a8d\u3057\u307e\u3057\u3087\u3046\u3002\nbash-3.2$ bundle exec rake -T\nrake s3:policy:hage.inokara.com:diff    # S3 \u30d0\u30b1\u30c3\u30c8 hage.inokara.com \u306b\u9069\u7528\u3059\u308b policy \u3068\u65e2\u5b58\u306e\u30dd\u30ea\u30b7\u30fc\u3092\u6bd4\u8f03\u3059\u308b\nrake s3:policy:hage.inokara.com:update  # S3 \u30d0\u30b1\u30c3\u30c8 hage.inokara.com \u306e policy \u3092\u5909\u66f4\u3059\u308b\nrake s3:policy:export[bucket]          # S3 \u30d0\u30b1\u30c3\u30c8 policy \u3092\u53d6\u5f97\u3059\u308b\nrake s3:policy:view[bucket]            # S3 \u30d0\u30b1\u30c3\u30c8 policy \u3092\u8868\u793a\u3059\u308b\n\n\n\u30d0\u30b1\u30c3\u30c8\u30dd\u30ea\u30b7\u30fc\u3092\u4fee\u6b63\u3057\u307e\u3057\u3087\u3046\n\nbash-3.2$ vim policies/hage.inokara.com\n\n\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u3092\u53c2\u8003\u306b IP \u30a2\u30c9\u30ec\u30b9\u5236\u9650\u3092\u304b\u3051\u3066\u307f\u307e\u3057\u305f\u3002\n{\n  \"Version\": \"2008-10-17\",\n  \"Statement\": [\n    {\n      \"Sid\": \"AllowPublicRead\",\n      \"Effect\": \"Allow\",\n      \"Principal\": {\n        \"AWS\": \"*\"\n      },\n      \"Action\": \"s3:GetObject\",\n      \"Resource\": \"arn:aws:s3:::hage.inokara.com/*\",\n      \"Condition\": {\n         \"IpAddress\": {\"aws:SourceIp\": \"54.240.143.0/24\"},\n         \"NotIpAddress\": {\"aws:SourceIp\": \"54.240.143.188/32\"}\n      }\n    }\n  ]\n}\n\n\n\u5dee\u5206\u3092\u78ba\u8a8d\u3057\u307e\u3057\u3087\u3046\n\nbash-3.2$ bundle exec rake s3:policy:hage.inokara.com:diff\n {\n   \"Version\": \"2008-10-17\",\n   \"Statement\": [\n     {\n       \"Sid\": \"AllowPublicRead\",\n       \"Effect\": \"Allow\",\n       \"Principal\": {\n         \"AWS\": \"*\"\n       },\n       \"Action\": \"s3:GetObject\",\n-      \"Resource\": \"arn:aws:s3:::hage.inokara.com/*\"\n+      \"Resource\": \"arn:aws:s3:::hage.inokara.com/*\",\n+      \"Condition\": {\n+        \"IpAddress\": {\n+          \"aws:SourceIp\": \"54.240.143.0/24\"\n+        },\n+        \"NotIpAddress\": {\n+          \"aws:SourceIp\": \"54.240.143.188/32\"\n+        }\n+      }\n     }\n   ]\n }\n\\ No newline at end of file\n\n\u3061\u3083\u3093\u3068\u65e2\u5b58\u306e\u8a2d\u5b9a\u3068\u306e\u5dee\u5206\u3092\u8868\u793a\u3057\u3066\u304f\u308c\u307e\u3059\u3002\u3042\u308a\u304c\u305f\u3044\u3002\n\n\u30d0\u30b1\u30c3\u30c8\u30dd\u30ea\u30b7\u30fc\u3092\u30c4\u30c3\u30b3\u30df\u307e\u3057\u3087\u3046\n\nbash-3.2$ bundle exec rake s3:policy:hage.inokara.com:update\n#<struct Aws::S3::Types::EmptyStructure>\n\n\n\u9069\u7528\u3057\u305f\u30dd\u30ea\u30b7\u30fc\u3092\u898b\u3066\u307f\u307e\u3057\u3087\u3046\n\nbash-3.2$ bundle exec rake s3:policy:view[hage.inokara.com]\nhage.inokara.com \u306e policy \u3092\u8868\u793a\u3057\u307e\u3059...\n{\n  \"Version\": \"2008-10-17\",\n  \"Statement\": [\n    {\n      \"Sid\": \"AllowPublicRead\",\n      \"Effect\": \"Allow\",\n      \"Principal\": {\n        \"AWS\": \"*\"\n      },\n      \"Action\": \"s3:GetObject\",\n      \"Resource\": \"arn:aws:s3:::hage.inokara.com/*\",\n      \"Condition\": {\n        \"NotIpAddress\": {\n          \"aws:SourceIp\": \"54.240.143.188/32\"\n        },\n        \"IpAddress\": {\n          \"aws:SourceIp\": \"54.240.143.0/24\"\n        }\n      }\n    }\n  ]\n}\n\n\n\u6700\u5f8c\u306b\n\n\u30d0\u30b1\u30e9\u30c3\u30bf\n\u3053\u306e Rake \u30bf\u30b9\u30af\u3092\u66f8\u304d\u7d42\u308f\u3063\u305f\u5f8c\u306b\u6c17\u3065\u304d\u307e\u3057\u305f\u304c\u3001\u65e2\u306b Codenize.tools \u306e Bukelatta \u3068\u3044\u3046\u30c4\u30fc\u30eb\u304c\u3042\u308a\u307e\u3059\u306e\u3067\u3001\u4eca\u5f8c\u306f\u30d0\u30b1\u30e9\u30c3\u30bf\u3092\u4f7f\u3063\u3066\u3044\u304d\u305f\u3044\u3068\u601d\u3044\u307e\u3059\u3002\n[https://github.com/winebarrel/bukelatta:embed:cite]\n\nRake \u3063\u3066\n\u697d\u3057\u3044\u3067\u3059\u306d\u3002\n[\u3053\u3061\u3089](http://inokara.hateblo.jp/entry/2016/11/23/110251)\u304b\u3089\u306e\u8ee2\u8f09\u3067\u3059\u3002\n\n## \u6700\u8fd1\n\n\u30ae\u30e7\u30fc\u30e0\u3067 S3 \u30d0\u30b1\u30c3\u30c8\u3092\u66f4\u65b0\u3059\u308b\u4f5c\u696d\u304c\u3042\u3063\u305f\u306e\u3067\u3001\u307b\u306e\u307c\u306e Rake \u30bf\u30b9\u30af\u3067\u6c4e\u7528\u7684\u306b\u7ba1\u7406\u51fa\u6765\u308b\u611f\u3058\u306b\u3057\u3066\u307f\u307e\u3057\u305f\u3002\n\n## \u30bf\u30b9\u30af\n\n### Rakefile\n\n```ruby\nrequire 'aws-sdk'\nrequire 'diffy'\nrequire 'json'\n\nPOLICY_DIR='policies/'\n\ndef s3\n  Aws.config[:credentials] = Aws::SharedCredentials.new(profile_name: '\u3042\u306a\u305f\u306e\u30d7\u30ed\u30d5\u30a1\u30a4\u30eb')\n  Aws::S3::Client.new(region: 'ap-northeast-1')\nend\n\ndef get_bucket_policy(bucket)\n  begin\n    resp = s3.get_bucket_policy({\n      bucket: bucket\n    })\n    JSON.parse(resp.policy.read)\n  rescue JSON::ParserError => e\n    puts e\n  end\nend\n\ndef open_policy_document(path)\n  begin\n    File.open(POLICY_DIR + path) do |file|\n      JSON.load(file)\n    end\n  rescue JSON::ParserError => e\n    puts e\n  end\nend\n\ndef valid_json?(json)\n  begin\n    JSON.parse(json)\n    return true\n  rescue JSON::ParserError => e\n    return false\n  end\nend\n\nnamespace :s3 do\n\n  namespace :policy do\n\n    desc \"S3 \u30d0\u30b1\u30c3\u30c8 policy \u3092\u53d6\u5f97\u3059\u308b\"\n    task :export, :bucket do |task, args|\n      puts \"#{args[:bucket]} \u306e policy \u3092\u53d6\u5f97\u3057\u307e\u3059...\"\n      hash = get_bucket_policy(args[:bucket])\n      puts JSON.pretty_generate(hash)\n      File.open(POLICY_DIR + args[:bucket], \"w\") do |f| \n        f.puts(JSON.pretty_generate(hash))\n      end\n    end\n\n    desc \"S3 \u30d0\u30b1\u30c3\u30c8 policy \u3092\u8868\u793a\u3059\u308b\"\n    task :view, :bucket do |task, args|\n      puts \"#{args[:bucket]} \u306e policy \u3092\u8868\u793a\u3057\u307e\u3059...\"\n      hash = get_bucket_policy(args[:bucket])\n      puts JSON.pretty_generate(hash)\n    end\n\n    targets = []\n    Dir.glob(POLICY_DIR + '*').each do |file|\n      target = File.basename(file)\n      target = \"_#{target}\" if target == \"default\"\n      targets << target\n    end\n\n    targets.each do |target|\n      namespace target.to_sym do\n        desc \"S3 \u30d0\u30b1\u30c3\u30c8 #{target} \u306e policy \u3092\u5909\u66f4\u3059\u308b\"\n        task :update do\n          resp = s3.put_bucket_policy({\n            bucket: \"#{target}\",\n            policy: open_policy_document(target).to_json\n          })\n          puts resp\n        end\n\n        desc \"S3 \u30d0\u30b1\u30c3\u30c8 #{target} \u306b\u9069\u7528\u3059\u308b policy \u3068\u65e2\u5b58\u306e\u30dd\u30ea\u30b7\u30fc\u3092\u6bd4\u8f03\u3059\u308b\"\n        task :diff do\n          hash = get_bucket_policy(target)\n          old = JSON.pretty_generate(hash)\n          new = JSON.pretty_generate(open_policy_document(target))\n          puts Diffy::Diff.new(old, new).to_s(:color)\n        end\n\n      end\n    end\n  end\nend\n```\n\n### \u4f7f\u3044\u65b9\n\n- \u521d\u671f\u72b6\u614b\u306e tasks\n\n```sh\n$ bundle exec rake -T\nrake s3:policy:export[bucket]          # S3 \u30d0\u30b1\u30c3\u30c8 policy \u3092\u53d6\u5f97\u3059\u308b\nrake s3:policy:view[bucket]            # S3 \u30d0\u30b1\u30c3\u30c8 policy \u3092\u8868\u793a\u3059\u308b\n```\n\n- \u30d0\u30b1\u30c3\u30c8\u30dd\u30ea\u30b7\u30fc\u3092 export \u3057\u307e\u3057\u3087\u3046\n\n```sh\n$ mkdir policies\n$ bundle exec rake \"s3:policy:export[hage.inokara.com]\"\n```\n\n\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u51fa\u529b\u3055\u308c\u307e\u3059\u3002\n\n```sh\nhage.inokara.com \u306e policy \u3092\u53d6\u5f97\u3057\u307e\u3059...\n{\n  \"Version\": \"2008-10-17\",\n  \"Statement\": [\n    {\n      \"Sid\": \"AllowPublicRead\",\n      \"Effect\": \"Allow\",\n      \"Principal\": {\n        \"AWS\": \"*\"\n      },\n      \"Action\": \"s3:GetObject\",\n      \"Resource\": \"arn:aws:s3:::hage.inokara.com/*\"\n    }\n  ]\n}\n```\n\n\u30c7\u30d5\u30a9\u30eb\u30c8\u3067\u306f\u30ab\u30ec\u30f3\u30c8\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306e policies \u3068\u3044\u3046\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u4ee5\u4e0b\u306b\u30d0\u30b1\u30c3\u30c8\u540d\u3068\u540c\u3058\u540d\u524d\u306e\u30dd\u30ea\u30b7\u30fc\u30d5\u30a1\u30a4\u30eb\u304c\u4f5c\u6210\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n\n```sh\nbash-3.2$ ls -l policies/\ntotal 8\n-rw-r--r--  1 syorou  staff  253 Nov 23 11:58 hage.inokara.com\n```\n\ntasks \u3082\u78ba\u8a8d\u3057\u307e\u3057\u3087\u3046\u3002\n\n```sh\nbash-3.2$ bundle exec rake -T\nrake s3:policy:hage.inokara.com:diff    # S3 \u30d0\u30b1\u30c3\u30c8 hage.inokara.com \u306b\u9069\u7528\u3059\u308b policy \u3068\u65e2\u5b58\u306e\u30dd\u30ea\u30b7\u30fc\u3092\u6bd4\u8f03\u3059\u308b\nrake s3:policy:hage.inokara.com:update  # S3 \u30d0\u30b1\u30c3\u30c8 hage.inokara.com \u306e policy \u3092\u5909\u66f4\u3059\u308b\nrake s3:policy:export[bucket]          # S3 \u30d0\u30b1\u30c3\u30c8 policy \u3092\u53d6\u5f97\u3059\u308b\nrake s3:policy:view[bucket]            # S3 \u30d0\u30b1\u30c3\u30c8 policy \u3092\u8868\u793a\u3059\u308b\n```\n\n- \u30d0\u30b1\u30c3\u30c8\u30dd\u30ea\u30b7\u30fc\u3092\u4fee\u6b63\u3057\u307e\u3057\u3087\u3046\n\n```sh\nbash-3.2$ vim policies/hage.inokara.com\n```\n\n[\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8](https://docs.aws.amazon.com/ja_jp/AmazonS3/latest/dev/example-bucket-policies.html)\u3092\u53c2\u8003\u306b IP \u30a2\u30c9\u30ec\u30b9\u5236\u9650\u3092\u304b\u3051\u3066\u307f\u307e\u3057\u305f\u3002\n\n```json\n{\n  \"Version\": \"2008-10-17\",\n  \"Statement\": [\n    {\n      \"Sid\": \"AllowPublicRead\",\n      \"Effect\": \"Allow\",\n      \"Principal\": {\n        \"AWS\": \"*\"\n      },\n      \"Action\": \"s3:GetObject\",\n      \"Resource\": \"arn:aws:s3:::hage.inokara.com/*\",\n      \"Condition\": {\n         \"IpAddress\": {\"aws:SourceIp\": \"54.240.143.0/24\"},\n         \"NotIpAddress\": {\"aws:SourceIp\": \"54.240.143.188/32\"}\n      }\n    }\n  ]\n}\n```\n\n- \u5dee\u5206\u3092\u78ba\u8a8d\u3057\u307e\u3057\u3087\u3046\n\n```sh\nbash-3.2$ bundle exec rake s3:policy:hage.inokara.com:diff\n {\n   \"Version\": \"2008-10-17\",\n   \"Statement\": [\n     {\n       \"Sid\": \"AllowPublicRead\",\n       \"Effect\": \"Allow\",\n       \"Principal\": {\n         \"AWS\": \"*\"\n       },\n       \"Action\": \"s3:GetObject\",\n-      \"Resource\": \"arn:aws:s3:::hage.inokara.com/*\"\n+      \"Resource\": \"arn:aws:s3:::hage.inokara.com/*\",\n+      \"Condition\": {\n+        \"IpAddress\": {\n+          \"aws:SourceIp\": \"54.240.143.0/24\"\n+        },\n+        \"NotIpAddress\": {\n+          \"aws:SourceIp\": \"54.240.143.188/32\"\n+        }\n+      }\n     }\n   ]\n }\n\\ No newline at end of file\n```\n\n\u3061\u3083\u3093\u3068\u65e2\u5b58\u306e\u8a2d\u5b9a\u3068\u306e\u5dee\u5206\u3092\u8868\u793a\u3057\u3066\u304f\u308c\u307e\u3059\u3002\u3042\u308a\u304c\u305f\u3044\u3002\n\n- \u30d0\u30b1\u30c3\u30c8\u30dd\u30ea\u30b7\u30fc\u3092\u30c4\u30c3\u30b3\u30df\u307e\u3057\u3087\u3046\n\n```sh\nbash-3.2$ bundle exec rake s3:policy:hage.inokara.com:update\n#<struct Aws::S3::Types::EmptyStructure>\n```\n\n- \u9069\u7528\u3057\u305f\u30dd\u30ea\u30b7\u30fc\u3092\u898b\u3066\u307f\u307e\u3057\u3087\u3046\n\n```sh\nbash-3.2$ bundle exec rake s3:policy:view[hage.inokara.com]\nhage.inokara.com \u306e policy \u3092\u8868\u793a\u3057\u307e\u3059...\n{\n  \"Version\": \"2008-10-17\",\n  \"Statement\": [\n    {\n      \"Sid\": \"AllowPublicRead\",\n      \"Effect\": \"Allow\",\n      \"Principal\": {\n        \"AWS\": \"*\"\n      },\n      \"Action\": \"s3:GetObject\",\n      \"Resource\": \"arn:aws:s3:::hage.inokara.com/*\",\n      \"Condition\": {\n        \"NotIpAddress\": {\n          \"aws:SourceIp\": \"54.240.143.188/32\"\n        },\n        \"IpAddress\": {\n          \"aws:SourceIp\": \"54.240.143.0/24\"\n        }\n      }\n    }\n  ]\n}\n```\n\n## \u6700\u5f8c\u306b\n\n### \u30d0\u30b1\u30e9\u30c3\u30bf\n\n\u3053\u306e Rake \u30bf\u30b9\u30af\u3092\u66f8\u304d\u7d42\u308f\u3063\u305f\u5f8c\u306b\u6c17\u3065\u304d\u307e\u3057\u305f\u304c\u3001\u65e2\u306b Codenize.tools \u306e Bukelatta \u3068\u3044\u3046\u30c4\u30fc\u30eb\u304c\u3042\u308a\u307e\u3059\u306e\u3067\u3001\u4eca\u5f8c\u306f\u30d0\u30b1\u30e9\u30c3\u30bf\u3092\u4f7f\u3063\u3066\u3044\u304d\u305f\u3044\u3068\u601d\u3044\u307e\u3059\u3002\n\n[https://github.com/winebarrel/bukelatta:embed:cite]\n\n### Rake \u3063\u3066\n\n\u697d\u3057\u3044\u3067\u3059\u306d\u3002\n", "tags": ["rake", "Ruby", "AWS", "S3"]}