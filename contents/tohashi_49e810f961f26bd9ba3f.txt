{"context": "Koa v1.2.1\u3067\u66f8\u304b\u308c\u305f\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3092Koa v2.0.0\u306b\u30a2\u30c3\u30d7\u30c7\u30fc\u30c8\u3057\u305f\u306e\u3067\u305d\u306e\u30ed\u30b0\u7684\u306a\u3082\u306e\u3067\u3059\u3002\nv1\u304b\u3089\u306e\u5927\u304d\u306a\u5909\u66f4\u70b9\u3068\u3057\u3066\u3001middleware\u306e\u30a4\u30f3\u30bf\u30fc\u30d5\u30a7\u30fc\u30b9\u304cgenerator function\u304b\u3089async/await\u3078\u3068\u5909\u308f\u3063\u3066\u3044\u307e\u3059\u3002\n\n\u74b0\u5883\u306e\u7528\u610f\nKoa v2\u3067\u306fasync/await\u304c\u4f7f\u3048\u308b\u74b0\u5883\u304c\u5fc5\u8981\u3068\u306a\u308a\u307e\u3059\u3002\u73fe\u72b6Node.js\u3067async/await\u3092\u4f7f\u3046\u305f\u3081\u306b\u306f\u4e3b\u306b\n\nNode.js v7\u7cfb\u3092\u4f7f\u3044 --harmony-async-await \u30aa\u30d7\u30b7\u30e7\u30f3\u3092\u3064\u3051\u3066\u8d77\u52d5\nBabel\u3067\u30c8\u30e9\u30f3\u30b9\u30d1\u30a4\u30eb&polyfill\n\n\u3068\u3044\u3046\u4e8c\u7a2e\u985e\u306e\u65b9\u6cd5\u304c\u3042\u308a\u307e\u3059\u304c\u3001\u3053\u3053\u3067\u306f\u5f8c\u8005\u306eBabel\u3092\u4f7f\u3046\u65b9\u6cd5\u3067\u9032\u3081\u3066\u3044\u304d\u307e\u3059\u3002\n\nplugin\u3068polyfill\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n$ npm install babel-polyfill babel-plugin-transform-async-to-generator\n\n\n\u65e2\u306b\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u5074\u3067Babel\u3092\u4f7f\u7528\u3057\u3066\u3044\u3066\u3001preset\u3084plugins\u306e\u8a2d\u5b9a\u3092\u5206\u3051\u305f\u3044\u5834\u5408\u306fenv\u3092\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\n.babelrc\n{\n  \"env\": {\n    \"client\": {\n      \"presets\": [ \"es2015\", \"react\" ],\n      \"plugins\": [\n        \"add-module-exports\",\n        \"transform-class-properties\",\n        \"transform-object-rest-spread\",\n        \"transform-export-extensions\"\n      ]\n    },\n    \"server\": {\n      \"presets\": [ \"es2015\" ],\n      \"plugins\": [\n        \"transform-async-to-generator\"\n      ]\n    }\n  }\n}\n\n\nBABEL_ENV\u3092\u6307\u5b9a\u3057\u305f\u4e0a\u3067babel-node\u3092\u4f7f\u3063\u3066\u52d5\u304b\u3057\u307e\u3059\u3002\n\nscripts\u306b\u8ffd\u52a0\n\"start\": \"BABEL_ENV=server babel-node index.js\"\n\n\n\u306a\u304a\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u306a\u3069\u306e\u554f\u984c\u304b\u3089\u3001production\u3067\u306fbabel-node\u3067\u306f\u306a\u304f\u30d5\u30ed\u30f3\u30c8\u306e\u30b3\u30fc\u30c9\u540c\u69d8\u30c8\u30e9\u30f3\u30b9\u30d1\u30a4\u30eb\u3057\u305f\u3082\u306e\u3092\u4f7f\u7528\u3059\u308b\u3053\u3068\u304c\u63a8\u5968\u3055\u308c\u3066\u3044\u307e\u3059\u3002\nbabel/example-node-server\n\nproduction\u7528\u306b\u30c8\u30e9\u30f3\u30b9\u30d1\u30a4\u30eb\n\"build\": \"BABEL_ENV=server babel index.js --out-file bundle.js\",\n\"start:production\": \"node bundle.js\"\n\n\n\nKoa v2\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n$ npm i koa@2\n\nv2\u3067\u306f\u30af\u30e9\u30b9\u30b3\u30f3\u30b9\u30c8\u30e9\u30af\u30bf\u3092\u8fd4\u3059\u3088\u3046\u306b\u306a\u3063\u305f\u306e\u3067\u5bfe\u5fdc\u3057\u307e\u3059\u3002\n\nbefore\nimport koa from 'koa';\nconst app = koa();\n\n\n\nafter\nimport Koa from 'koa';\nconst app = new Koa();\n\n\n\nmigration\n\ngenerator -> async/await or Promise\ngenerator function\u3092async/await\u306b\u66f8\u304d\u63db\u3048\u3066\u3044\u304d\u307e\u3059\u3002\n\nbefore\napp.use(function *(next) {\n  try {\n    yield next;\n  } catch (err) {\n    if (401 == err.status) {\n      this.status = 401;\n      this.set('WWW-Authenticate', 'Basic');\n      this.body = 'authorization required';\n    } else {\n      this.throw(err);\n    }\n  }\n});\n\n\n\nasync/await\napp.use(async (ctx, next) => {\n  try {\n    await next;\n  } catch (err) {\n    if (401 == err.status) {\n      ctx.status = 401;\n      ctx.set('WWW-Authenticate', 'Basic');\n      ctx.body = 'authorization required';\n    } else {\n      ctx.throw(err);\n    }\n  }\n});\n\n\n\u3042\u308b\u3044\u306fPromise\u3067\u66f8\u304f\u3053\u3068\u3082\u3067\u304d\u307e\u3059\u3002\n\npromise\napp.use((ctx, next) => {\n  next().catch((err) => {\n    if (401 == err.status) {\n      ctx.status = 401;\n      ctx.set('WWW-Authenticate', 'Basic');\n      ctx.body = 'authorization required';\n    } else {\n      ctx.throw(err);\n    }\n  });\n});\n\n\n\nkoa-convert\n\u672a\u5bfe\u5fdc\u306emiddleware\u306f\u3001koa-convert\u3092\u4f7f\u3063\u3066generator function\u3092Promise\u3092\u4f7f\u7528\u3057\u305f\u3082\u306e\u306b\u5909\u63db\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\nbefore\nimport logger from 'koa-logger';\nimport serve from 'koa-static';\n\napp.use(logger());\napp.use(serve('.'));\n\n\n\nafter\nimport logger from 'koa-logger';\nimport serve from 'koa-static';\nimport convert from 'koa-convert';\n\napp.use(convert(logger()));\napp.use(convert(serve('.')));\n\n\n\n\u3055\u3044\u3054\u306b\n\u3068\u308a\u3042\u3048\u305aconvert\u3067\u56f2\u3063\u3066\u3057\u307e\u3048\u3070\u3069\u3046\u306b\u304b\u306a\u308b\u306e\u306f\u697d\u3067\u3044\u3044\u3067\u3059\u306d\u3002\nasync/await\u306e\u305f\u3081\u3060\u3051\u306b\u30b5\u30fc\u30d0\u30fc\u30b5\u30a4\u30c9\u3067Babel\u3092\u4f7f\u7528\u3059\u308b\u306e\u306f\u3001\u30d3\u30eb\u30c9\u30d7\u30ed\u30bb\u30b9\u3082\u8907\u96d1\u306b\u306a\u308b\u3057\u6b63\u76f4\u3042\u307e\u308a\u7b4b\u306e\u3044\u3044\u65b9\u6cd5\u3068\u306f\u8a00\u3048\u306a\u3044\u306e\u3067Node.js v7\u5165\u308c\u3089\u308c\u308b\u306a\u3089\u305d\u3061\u3089\u306e\u65b9\u304c\u826f\u3044\u3067\u3057\u3087\u3046\u3002\n\u3061\u306a\u307f\u306bKoa v2\u306e\u6b63\u5f0f\u30ea\u30ea\u30fc\u30b9\u306fNode.js\u4e0a\u3067stable\u306aasync/await\u304c\u5b9f\u88c5\u3055\u308c\u305f\u3089\u3068\u306e\u3053\u3068\u306a\u306e\u3067\u3001Node.js v8\u304c\u51fa\u308b\u9803\u306b\u306f\u51fa\u305d\u3046\u3067\u3059\u306d\n\nFYI: \u30d5\u30ec\u30fc\u30e0\u30ef\u30fc\u30afDL\u6570\u6bd4\u8f03\nKoa\u3088\u308ahapi,restify\u306e\u65b9\u304c\u591a\u3044\u3088\u3046\u3067\u3059\u3002\u3002\u30021 \n\n\n\n\nlast month(2016/12/17)\n\n\n\n\nexpress\n7,942,528\n\n\nrestify\n258,329\n\n\nhapi\n246,358\n\n\nKoa\n156,030\n\n\nsails\n67,201\n\n\nTrails\n10,423\n\n\n\nNode.js Advent Calendar 2016 17\u65e5\u76ee\u306e\u8a18\u4e8b\u3067\u3057\u305f\u3002\n\n\n\n\nMeteor\u306fnpm\u3067\u5165\u3089\u306a\u3044\u305f\u3081DL\u6570\u5224\u3089\u305a\u00a0\u21a9\n\n\n\nKoa v1.2.1\u3067\u66f8\u304b\u308c\u305f\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3092Koa v2.0.0\u306b\u30a2\u30c3\u30d7\u30c7\u30fc\u30c8\u3057\u305f\u306e\u3067\u305d\u306e\u30ed\u30b0\u7684\u306a\u3082\u306e\u3067\u3059\u3002\n\nv1\u304b\u3089\u306e\u5927\u304d\u306a\u5909\u66f4\u70b9\u3068\u3057\u3066\u3001middleware\u306e\u30a4\u30f3\u30bf\u30fc\u30d5\u30a7\u30fc\u30b9\u304cgenerator function\u304b\u3089async/await\u3078\u3068\u5909\u308f\u3063\u3066\u3044\u307e\u3059\u3002\n\n# \u74b0\u5883\u306e\u7528\u610f\n\nKoa v2\u3067\u306fasync/await\u304c\u4f7f\u3048\u308b\u74b0\u5883\u304c\u5fc5\u8981\u3068\u306a\u308a\u307e\u3059\u3002\u73fe\u72b6Node.js\u3067async/await\u3092\u4f7f\u3046\u305f\u3081\u306b\u306f\u4e3b\u306b\n\n- Node.js v7\u7cfb\u3092\u4f7f\u3044 `--harmony-async-await` \u30aa\u30d7\u30b7\u30e7\u30f3\u3092\u3064\u3051\u3066\u8d77\u52d5\n- Babel\u3067\u30c8\u30e9\u30f3\u30b9\u30d1\u30a4\u30eb&polyfill\n\n\u3068\u3044\u3046\u4e8c\u7a2e\u985e\u306e\u65b9\u6cd5\u304c\u3042\u308a\u307e\u3059\u304c\u3001\u3053\u3053\u3067\u306f\u5f8c\u8005\u306eBabel\u3092\u4f7f\u3046\u65b9\u6cd5\u3067\u9032\u3081\u3066\u3044\u304d\u307e\u3059\u3002\n\n```sh:plugin\u3068polyfill\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n$ npm install babel-polyfill babel-plugin-transform-async-to-generator\n```\n\n\u65e2\u306b\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u5074\u3067Babel\u3092\u4f7f\u7528\u3057\u3066\u3044\u3066\u3001preset\u3084plugins\u306e\u8a2d\u5b9a\u3092\u5206\u3051\u305f\u3044\u5834\u5408\u306f[env\u3092\u8a2d\u5b9a](https://babeljs.io/docs/usage/babelrc/#env-option)\u3057\u307e\u3059\u3002\n\n```json:.babelrc\n{\n  \"env\": {\n    \"client\": {\n      \"presets\": [ \"es2015\", \"react\" ],\n      \"plugins\": [\n        \"add-module-exports\",\n        \"transform-class-properties\",\n        \"transform-object-rest-spread\",\n        \"transform-export-extensions\"\n      ]\n    },\n    \"server\": {\n      \"presets\": [ \"es2015\" ],\n      \"plugins\": [\n        \"transform-async-to-generator\"\n      ]\n    }\n  }\n}\n```\n\n`BABEL_ENV`\u3092\u6307\u5b9a\u3057\u305f\u4e0a\u3067[babel-node](https://babeljs.io/docs/usage/cli/#babel-node)\u3092\u4f7f\u3063\u3066\u52d5\u304b\u3057\u307e\u3059\u3002\n\n```:scripts\u306b\u8ffd\u52a0\n\"start\": \"BABEL_ENV=server babel-node index.js\"\n```\n\n\u306a\u304a\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u306a\u3069\u306e\u554f\u984c\u304b\u3089\u3001production\u3067\u306fbabel-node\u3067\u306f\u306a\u304f\u30d5\u30ed\u30f3\u30c8\u306e\u30b3\u30fc\u30c9\u540c\u69d8\u30c8\u30e9\u30f3\u30b9\u30d1\u30a4\u30eb\u3057\u305f\u3082\u306e\u3092\u4f7f\u7528\u3059\u308b\u3053\u3068\u304c\u63a8\u5968\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n\n[babel/example-node-server](https://github.com/babel/example-node-server)\n\n```:production\u7528\u306b\u30c8\u30e9\u30f3\u30b9\u30d1\u30a4\u30eb\n\"build\": \"BABEL_ENV=server babel index.js --out-file bundle.js\",\n\"start:production\": \"node bundle.js\"\n```\n\n# Koa v2\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n```shell-session\n$ npm i koa@2\n```\n\nv2\u3067\u306f\u30af\u30e9\u30b9\u30b3\u30f3\u30b9\u30c8\u30e9\u30af\u30bf\u3092\u8fd4\u3059\u3088\u3046\u306b\u306a\u3063\u305f\u306e\u3067\u5bfe\u5fdc\u3057\u307e\u3059\u3002\n\n```js:before\nimport koa from 'koa';\nconst app = koa();\n```\n\n```js:after\nimport Koa from 'koa';\nconst app = new Koa();\n```\n\n# migration\n\n## generator -> async/await or Promise\n\ngenerator function\u3092async/await\u306b\u66f8\u304d\u63db\u3048\u3066\u3044\u304d\u307e\u3059\u3002\n\n```js:before\napp.use(function *(next) {\n  try {\n    yield next;\n  } catch (err) {\n    if (401 == err.status) {\n      this.status = 401;\n      this.set('WWW-Authenticate', 'Basic');\n      this.body = 'authorization required';\n    } else {\n      this.throw(err);\n    }\n  }\n});\n```\n\n```js:async/await\napp.use(async (ctx, next) => {\n  try {\n    await next;\n  } catch (err) {\n    if (401 == err.status) {\n      ctx.status = 401;\n      ctx.set('WWW-Authenticate', 'Basic');\n      ctx.body = 'authorization required';\n    } else {\n      ctx.throw(err);\n    }\n  }\n});\n```\n\n\u3042\u308b\u3044\u306fPromise\u3067\u66f8\u304f\u3053\u3068\u3082\u3067\u304d\u307e\u3059\u3002\n\n```js:promise\napp.use((ctx, next) => {\n  next().catch((err) => {\n    if (401 == err.status) {\n      ctx.status = 401;\n      ctx.set('WWW-Authenticate', 'Basic');\n      ctx.body = 'authorization required';\n    } else {\n      ctx.throw(err);\n    }\n  });\n});\n```\n\n## koa-convert\n\n\u672a\u5bfe\u5fdc\u306emiddleware\u306f\u3001[koa-convert](https://github.com/koajs/convert)\u3092\u4f7f\u3063\u3066generator function\u3092Promise\u3092\u4f7f\u7528\u3057\u305f\u3082\u306e\u306b\u5909\u63db\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\n```js:before\nimport logger from 'koa-logger';\nimport serve from 'koa-static';\n\napp.use(logger());\napp.use(serve('.'));\n```\n\n```js:after\nimport logger from 'koa-logger';\nimport serve from 'koa-static';\nimport convert from 'koa-convert';\n\napp.use(convert(logger()));\napp.use(convert(serve('.')));\n```\n\n# \u3055\u3044\u3054\u306b\n\n\u3068\u308a\u3042\u3048\u305aconvert\u3067\u56f2\u3063\u3066\u3057\u307e\u3048\u3070\u3069\u3046\u306b\u304b\u306a\u308b\u306e\u306f\u697d\u3067\u3044\u3044\u3067\u3059\u306d\u3002\n\nasync/await\u306e\u305f\u3081\u3060\u3051\u306b\u30b5\u30fc\u30d0\u30fc\u30b5\u30a4\u30c9\u3067Babel\u3092\u4f7f\u7528\u3059\u308b\u306e\u306f\u3001\u30d3\u30eb\u30c9\u30d7\u30ed\u30bb\u30b9\u3082\u8907\u96d1\u306b\u306a\u308b\u3057\u6b63\u76f4\u3042\u307e\u308a\u7b4b\u306e\u3044\u3044\u65b9\u6cd5\u3068\u306f\u8a00\u3048\u306a\u3044\u306e\u3067Node.js v7\u5165\u308c\u3089\u308c\u308b\u306a\u3089\u305d\u3061\u3089\u306e\u65b9\u304c\u826f\u3044\u3067\u3057\u3087\u3046\u3002\n\n\u3061\u306a\u307f\u306bKoa v2\u306e\u6b63\u5f0f\u30ea\u30ea\u30fc\u30b9\u306fNode.js\u4e0a\u3067stable\u306aasync/await\u304c\u5b9f\u88c5\u3055\u308c\u305f\u3089\u3068\u306e\u3053\u3068\u306a\u306e\u3067\u3001Node.js v8\u304c\u51fa\u308b\u9803\u306b\u306f\u51fa\u305d\u3046\u3067\u3059\u306d:smiley:\n\n# FYI: \u30d5\u30ec\u30fc\u30e0\u30ef\u30fc\u30afDL\u6570\u6bd4\u8f03\n\nKoa\u3088\u308ahapi,restify\u306e\u65b9\u304c\u591a\u3044\u3088\u3046\u3067\u3059\u3002\u3002\u3002[^1] \n\n[^1]: Meteor\u306fnpm\u3067\u5165\u3089\u306a\u3044\u305f\u3081DL\u6570\u5224\u3089\u305a\n\n|  | last month(2016/12/17) |\n|:-:|--:|\n|[express](https://www.npmjs.com/package/express)   |7,942,528   |\n|[restify](https://www.npmjs.com/package/restify) | 258,329 |\n|[hapi](https://www.npmjs.com/package/hapi)   |246,358    |\n|[Koa](https://www.npmjs.com/package/koa)   |156,030   |\n|[sails](https://www.npmjs.com/package/sails)   |67,201   |\n|[Trails](https://www.npmjs.com/package/trails) |10,423 |\n\n[Node.js Advent Calendar 2016](http://qiita.com/advent-calendar/2016/nodejs) 17\u65e5\u76ee\u306e\u8a18\u4e8b\u3067\u3057\u305f\u3002\n", "tags": ["Koa", "Node.js", "migration"]}