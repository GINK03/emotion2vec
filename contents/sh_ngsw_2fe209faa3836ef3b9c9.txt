{"tags": ["AWS", "aws-cli", "Security", "waf"], "context": "\n\n\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u3092\u7528\u3044\u305fAccess Controll List\u306e\u4f5c\u6210\nAWS WAF\u306e\u82f1\u8a9e\u7248\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u306b\u516c\u958b\u3055\u308c\u3066\u3044\u308bURL\u3092\u6307\u5b9a\u3057\u3066CloudFormation\u306estack\u3092\u4f5c\u6210\u3059\u308b\u3068\u3001WAF\u306bACL\u306e\u30b5\u30f3\u30d7\u30eb\u3092\u4f5c\u6210\u3067\u304d\u308b\u3002\nTutorial: Quickly Setting Up AWS WAF Protection Against Common Attacks\n\nOn the Select Template page, choose Specify an Amazon S3 template URL. For the template URL, enter https://s3.amazonaws.com/cloudformation-examples/community/common-attacks.json\n\n\u4f5c\u6210\u3055\u308c\u308bRule\u3068Condition\u306f\u4ee5\u4e0b\u306e\u901a\u308a\u3002\n\nACL: CommonAttackProtection\n\n\nCommonAttackProtectionSqliRule\n\nURI contains SQL injection threat after decoding as URL. \nQuery string contains SQL injection threat after decoding as URL. \nQuery string contains SQL injection threat after decoding as HTML tags. \nBody contains SQL injection threat after decoding as URL.\nBody contains SQL injection threat after decoding as HTML tags.\n\n\n\nCommonAttackProtectionManualIPBlockRule\n\nThere are no IP addresses in this IP match condition.\n\n\n\nCommonAttackProtectionXssRule\n\nBody contains a cross-site scripting threat after decoding as URL.\nQuery string contains a cross-site scripting threat after decoding as URL.\nBody contains a cross-site scripting threat after decoding as HTML tags.\nQuery string contains a cross-site scripting threat after decoding as HTML tags.\nURI contains a cross-site scripting threat after decoding as URL.\n\n\n\nCommonAttackProtectionLargeBodyMatchRule\n\nThe length of the Body is greater than 8192.\n\n\n\n\u524a\u9664\u3059\u308b\u5834\u5408\u306f\u3001stack\u3092delete\u3059\u308c\u3070ACL\u4ee5\u4e0b\u306e\u3059\u3079\u3066\u306e\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u304c\u307e\u3068\u3081\u3066\u524a\u9664\u3055\u308c\u308b\u3002\n\n\u8cbb\u7528\n\u3053\u306eACL\u3067\u767a\u751f\u3059\u308b\u8cbb\u7528\u306f 9USD / Month\n(ACL 5USD \u00d7 1) + (Rule 1USD \u00d7 4) = 9USD\n\u6599\u91d1 - AWS WAF | AWS - Amazon Web Services\n\nAWS CLI\n\u3053\u3053\u304b\u3089\u5148\u306fAWS CLI\u3067\u767b\u9332\u3059\u308b\u624b\u9806\u3002\n\u307e\u305a\u3001\u516c\u5f0f\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u306b\u3042\u308bStack\u3092\u4f5c\u6210\u3059\u308b\u305f\u3081\u306e\u30b5\u30f3\u30d7\u30eb\u30dd\u30ea\u30b7\u30fc\u3092json\u3067\u4fdd\u5b58\u3059\u308b\u304b\u3001\u81ea\u4f5c\u3067Policy Document\u3092\u4f5c\u6210\u3059\u308b\u3002\nAWS Identity and Access Management \u306b\u3088\u308b\u30a2\u30af\u30bb\u30b9\u306e\u5236\u5fa1\n\u4eca\u56de\u306f\u4ee5\u4e0b\u306e\u81ea\u4f5c\u306ePolicy Document\u3092\u5229\u7528\u3059\u308b\u3002\n\ncloudformation_fullaccess_policy.json\n{\n    \"Version\":\"2016-09-20\",\n    \"Statement\":[{\n        \"Effect\":\"Allow\",\n        \"Action\":[\n            \"cloudformation:*\"\n        ],\n        \"Resource\":\"*\"\n    }]\n}\n\n\nIAM\u306e\u30dd\u30ea\u30b7\u30fc\u304c\u30a2\u30bf\u30c3\u30c1\u3055\u308c\u305f\u30e6\u30fc\u30b6\u30fc\u3067stack\u4f5c\u6210\u7528\u306e\u30dd\u30ea\u30b7\u30fc\u3092\u4f5c\u6210\u3059\u308b\u3002\ncreate-policy\u30e1\u30bd\u30c3\u30c9\u3067--policy-document\u306b\u5148\u307b\u3069\u306ejson\u3092\u6307\u5b9a\u3059\u308b\u3002\n\u540c\u6642\u306b\u4f5c\u6210\u3057\u305f\u30dd\u30ea\u30b7\u30fc\u306eARN\u3092\u53d6\u5f97\u3057\u3066\u304a\u304f\u3002\n$ CF_POLICY_ARN=$( \\\n$   aws iam create-policy \\\n$     --policy-name AmazonCloudFormationFullAccess \\\n$     --policy-document file://cloudformation_fullaccess_policy.json \\\n$     --query 'Policy.Arn' \\\n$     --output text \\\n$ )\n$ echo $CF_POLICY_ARN\n\n\u4e0a\u8a18\u306e\u30dd\u30ea\u30b7\u30fc\u3092\u30e6\u30fc\u30b6\u30fc\u306b\u30a2\u30bf\u30c3\u30c1\u3059\u308b\u3002\n$ aws iam attach-user-policy \\\n$   --user-name <USER_NAME> \\\n$   --policy-arn ${CF_POLICY_ARN}\n\n\u7d9a\u3044\u3066\u3001\u30e6\u30fc\u30b6\u30fc\u306bWAFFullAccess\u30dd\u30ea\u30b7\u30fc\u3092\u30a2\u30bf\u30c3\u30c1\u3059\u308b\u3002\n\u3042\u3089\u304b\u3058\u3081\u30a2\u30bf\u30c3\u30c1\u3057\u3066\u304a\u304b\u306a\u3044\u3068\u3001stack\u3092\u4f5c\u6210\u3059\u308b\u969b\u306bAccessDeniedException\u3067\u30a8\u30e9\u30fc\u306b\u306a\u308b\u306e\u3067\u6ce8\u610f\u3002\n$ aws iam attach-user-policy \\\n$   --user-name <USER_NAME> \\\n$   --policy-arn 'arn:aws:iam::aws:policy/AWSWAFFullAccess'\n\nstack\u3092\u4f5c\u6210\u3059\u308b\u3002\n10\u5206\u307b\u3069\u6642\u9593\u304c\u304b\u304b\u308b\u306e\u3067\u653e\u7f6e\u3002\n$ aws cloudformation create-stack \\\n$   --stack-name 'commonattackprotection' \\\n$   --template-url 'https://s3.amazonaws.com/cloudformation-examples/community/common-attacks.json'\n\n\u4ee5\u4e0b\u3001\u4f5c\u6210\u3055\u308c\u305fWAF\u306e\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u78ba\u8a8d\u3059\u308b\u30b3\u30de\u30f3\u30c9\u306e\u4e00\u89a7\u3002\n# \u5168\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\n$ aws cloudformation list-stack-resources\n$ aws cloudformation describe-stack-resources\n# ACL\n$ aws waf list-web-acls\n# Rule\n$ aws waf list-rules\n# Condition\n$ aws waf list-byte-match-sets\n$ aws waf list-size-constraint-sets\n$ aws waf list-xss-match-sets\n$ aws waf list-ip-sets\n$ aws waf list-sql-injection-match-sets\n\n\u4e0d\u8981\u306b\u306a\u3063\u305f\u3089stack\u3092delete\u3059\u308b\u3002\n$ aws cloudformation delete-stack --stack-name 'commonattackprotection'\n\n# \u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u3092\u7528\u3044\u305fAccess Controll List\u306e\u4f5c\u6210\nAWS WAF\u306e\u82f1\u8a9e\u7248\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u306b\u516c\u958b\u3055\u308c\u3066\u3044\u308bURL\u3092\u6307\u5b9a\u3057\u3066CloudFormation\u306estack\u3092\u4f5c\u6210\u3059\u308b\u3068\u3001WAF\u306bACL\u306e\u30b5\u30f3\u30d7\u30eb\u3092\u4f5c\u6210\u3067\u304d\u308b\u3002\n[Tutorial: Quickly Setting Up AWS WAF Protection Against Common Attacks](http://docs.aws.amazon.com/waf/latest/developerguide/tutorials-common-attacks.html)\n\n> On the Select Template page, choose Specify an Amazon S3 template URL. For the template URL, enter https://s3.amazonaws.com/cloudformation-examples/community/common-attacks.json\n\n\u4f5c\u6210\u3055\u308c\u308bRule\u3068Condition\u306f\u4ee5\u4e0b\u306e\u901a\u308a\u3002\n\n### ACL: CommonAttackProtection\n\n  - CommonAttackProtectionSqliRule\n    - URI contains SQL injection threat after decoding as URL. \n    - Query string contains SQL injection threat after decoding as URL. \n    - Query string contains SQL injection threat after decoding as HTML tags. \n    - Body contains SQL injection threat after decoding as URL.\n    - Body contains SQL injection threat after decoding as HTML tags.\n\n  - CommonAttackProtectionManualIPBlockRule\n    - There are no IP addresses in this IP match condition.\n\n  - CommonAttackProtectionXssRule\n    - Body contains a cross-site scripting threat after decoding as URL.\n    - Query string contains a cross-site scripting threat after decoding as URL.\n    - Body contains a cross-site scripting threat after decoding as HTML tags.\n    - Query string contains a cross-site scripting threat after decoding as HTML tags.\n    - URI contains a cross-site scripting threat after decoding as URL.\n\n  - CommonAttackProtectionLargeBodyMatchRule\n    - The length of the Body is greater than 8192.\n\n\u524a\u9664\u3059\u308b\u5834\u5408\u306f\u3001stack\u3092delete\u3059\u308c\u3070ACL\u4ee5\u4e0b\u306e\u3059\u3079\u3066\u306e\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u304c\u307e\u3068\u3081\u3066\u524a\u9664\u3055\u308c\u308b\u3002\n\n## \u8cbb\u7528\n\u3053\u306eACL\u3067\u767a\u751f\u3059\u308b\u8cbb\u7528\u306f **9USD / Month**\n(ACL 5USD \u00d7 1) + (Rule 1USD \u00d7 4) = 9USD\n[\u6599\u91d1 - AWS WAF | AWS - Amazon Web Services](https://aws.amazon.com/jp/waf/pricing/)\n\n# AWS CLI\n\u3053\u3053\u304b\u3089\u5148\u306fAWS CLI\u3067\u767b\u9332\u3059\u308b\u624b\u9806\u3002\n\n\u307e\u305a\u3001\u516c\u5f0f\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u306b\u3042\u308bStack\u3092\u4f5c\u6210\u3059\u308b\u305f\u3081\u306e\u30b5\u30f3\u30d7\u30eb\u30dd\u30ea\u30b7\u30fc\u3092json\u3067\u4fdd\u5b58\u3059\u308b\u304b\u3001\u81ea\u4f5c\u3067Policy Document\u3092\u4f5c\u6210\u3059\u308b\u3002\n[AWS Identity and Access Management \u306b\u3088\u308b\u30a2\u30af\u30bb\u30b9\u306e\u5236\u5fa1](http://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/using-iam-template.html)\n\u4eca\u56de\u306f\u4ee5\u4e0b\u306e\u81ea\u4f5c\u306ePolicy Document\u3092\u5229\u7528\u3059\u308b\u3002\n\n```cloudformation_fullaccess_policy.json\n{\n    \"Version\":\"2016-09-20\",\n    \"Statement\":[{\n        \"Effect\":\"Allow\",\n        \"Action\":[\n            \"cloudformation:*\"\n        ],\n        \"Resource\":\"*\"\n    }]\n}\n```\n\nIAM\u306e\u30dd\u30ea\u30b7\u30fc\u304c\u30a2\u30bf\u30c3\u30c1\u3055\u308c\u305f\u30e6\u30fc\u30b6\u30fc\u3067stack\u4f5c\u6210\u7528\u306e\u30dd\u30ea\u30b7\u30fc\u3092\u4f5c\u6210\u3059\u308b\u3002\n`create-policy`\u30e1\u30bd\u30c3\u30c9\u3067`--policy-document`\u306b\u5148\u307b\u3069\u306ejson\u3092\u6307\u5b9a\u3059\u308b\u3002\n\u540c\u6642\u306b\u4f5c\u6210\u3057\u305f\u30dd\u30ea\u30b7\u30fc\u306eARN\u3092\u53d6\u5f97\u3057\u3066\u304a\u304f\u3002\n\n```bash\n$ CF_POLICY_ARN=$( \\\n$   aws iam create-policy \\\n$     --policy-name AmazonCloudFormationFullAccess \\\n$     --policy-document file://cloudformation_fullaccess_policy.json \\\n$     --query 'Policy.Arn' \\\n$     --output text \\\n$ )\n$ echo $CF_POLICY_ARN\n```\n\n\u4e0a\u8a18\u306e\u30dd\u30ea\u30b7\u30fc\u3092\u30e6\u30fc\u30b6\u30fc\u306b\u30a2\u30bf\u30c3\u30c1\u3059\u308b\u3002\n\n```bash\n$ aws iam attach-user-policy \\\n$   --user-name <USER_NAME> \\\n$   --policy-arn ${CF_POLICY_ARN}\n```\n\n\u7d9a\u3044\u3066\u3001\u30e6\u30fc\u30b6\u30fc\u306bWAFFullAccess\u30dd\u30ea\u30b7\u30fc\u3092\u30a2\u30bf\u30c3\u30c1\u3059\u308b\u3002\n\u3042\u3089\u304b\u3058\u3081\u30a2\u30bf\u30c3\u30c1\u3057\u3066\u304a\u304b\u306a\u3044\u3068\u3001stack\u3092\u4f5c\u6210\u3059\u308b\u969b\u306bAccessDeniedException\u3067\u30a8\u30e9\u30fc\u306b\u306a\u308b\u306e\u3067\u6ce8\u610f\u3002\n\n```bash\n$ aws iam attach-user-policy \\\n$   --user-name <USER_NAME> \\\n$   --policy-arn 'arn:aws:iam::aws:policy/AWSWAFFullAccess'\n```\n\nstack\u3092\u4f5c\u6210\u3059\u308b\u3002\n10\u5206\u307b\u3069\u6642\u9593\u304c\u304b\u304b\u308b\u306e\u3067\u653e\u7f6e\u3002\n\n```bash\n$ aws cloudformation create-stack \\\n$   --stack-name 'commonattackprotection' \\\n$   --template-url 'https://s3.amazonaws.com/cloudformation-examples/community/common-attacks.json'\n```\n\n\u4ee5\u4e0b\u3001\u4f5c\u6210\u3055\u308c\u305fWAF\u306e\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u78ba\u8a8d\u3059\u308b\u30b3\u30de\u30f3\u30c9\u306e\u4e00\u89a7\u3002\n\n```bash\n# \u5168\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\n$ aws cloudformation list-stack-resources\n$ aws cloudformation describe-stack-resources\n# ACL\n$ aws waf list-web-acls\n# Rule\n$ aws waf list-rules\n# Condition\n$ aws waf list-byte-match-sets\n$ aws waf list-size-constraint-sets\n$ aws waf list-xss-match-sets\n$ aws waf list-ip-sets\n$ aws waf list-sql-injection-match-sets\n```\n\n\u4e0d\u8981\u306b\u306a\u3063\u305f\u3089stack\u3092delete\u3059\u308b\u3002\n\n```bash\n$ aws cloudformation delete-stack --stack-name 'commonattackprotection'\n```\n"}