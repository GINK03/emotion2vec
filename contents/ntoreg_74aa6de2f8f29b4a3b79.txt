{"context": "\nKubernetes\u306f\u30b3\u30f3\u30c6\u30ca\u3092\u4f7f\u3063\u305f\u30b7\u30b9\u30c6\u30e0\u306e\u30e9\u30a4\u30d5\u30b5\u30a4\u30af\u30eb\u3092\u7ba1\u7406\u3059\u308b\u30aa\u30fc\u30d7\u30f3\u30bd\u30fc\u30b9\u3067\u3059\u3002\n\u5927\u4f53\u306e\u30a4\u30f3\u30d5\u30e91\u3067\u52d5\u304d\u307e\u3059\u304c\u3001\u4eca\u56de\u306fKubernetes\u306e\u74b0\u5883\u304c\u4e88\u3081\u7528\u610f\u3055\u308c\u3066\u3044\u308bGKE\u3092\u4f7f\u3063\u3066\u3001\u4f7f\u3046\u5074\u306e\u8996\u70b9\u3067\u5b66\u3073\u305f\u3044\u3068\u601d\u3044\u307e\u3059\u3002\n\n\u5927\u96d1\u628a\u306a\u7406\u89e3\n\u307e\u305a\u3001\u3056\u3063\u304f\u308a\u69cb\u6210\u3092\u628a\u63e1\u3059\u308b\u305f\u3081\u306b\u56f3\u3092\u898b\u3066\u307f\u307e\u3059\n\u3002\n\n\u56f3\uff1aKubernetes architecture\n\u5de6\u5074\u304cKubernetes\u306e\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u30fc\u3067\u3001\u53f3\u5074\u304c\u7ba1\u7406\u5bfe\u8c61\u306e\u30b3\u30f3\u30c6\u30ca\u3067\u3059\u3002\u4ee5\u4e0b\u306e\u5358\u8a9e\u3092\u7c21\u5358\u306b\u6291\u3048\u3066\u304a\u304d\u307e\u3059\u3002\n\nNode\u30fb\u30fbDocker\u304c\u52d5\u304f\u30de\u30b7\u30f3\u306e\u3053\u3068\u3002\nPod\u30fb\u30fb\u30b3\u30f3\u30c6\u30ca\u3092\u914d\u7f6e\u3059\u308b\u5165\u308c\u7269\u3002\u3053\u306e\u5358\u4f4d\u3067\u30b9\u30b1\u30fc\u30eb\u3055\u305b\u305f\u308a\u3057\u307e\u3059\u3002\nProxy\u30fb\u30fb\u30b3\u30f3\u30c6\u30ca\u3068\u306e\u901a\u4fe1\u3092\u7d4c\u7531\u3059\u308b\u30d7\u30ed\u30ad\u30b7\u3002\n\nAPI\u3084\u30b3\u30de\u30f3\u30c9\u30e9\u30a4\u30f3\u3067\u7ba1\u7406\u3059\u308b\u3068\u304d\u306b\u3001\u4ee5\u4e0b\u306e\u5358\u8a9e\u304c\u983b\u7e41\u306b\u51fa\u3066\u304f\u308b\u306e\u3067\u3056\u3063\u304f\u308a\u899a\u3048\u3066\u304a\u304d\u307e\u3059\u3002\n\nDeployments 2\u30fb\u30fbPod\uff08\u30b3\u30f3\u30c6\u30ca\uff09\u3092\u7ba1\u7406\u3059\u308b\u3082\u306e\nService 3\u30fb\u30fbPod\uff08\u30b3\u30f3\u30c6\u30ca\uff09\u3068\u901a\u4fe1\u3092\u7dad\u6301\u3059\u308b\u305f\u3081\u306e\u30dd\u30ea\u30b7\u30fc\u306a\u3069\u3092\u5b9a\u7fa9\u3059\u308b\u3082\u306e\n\n\n\u4f55\u3067\u5b66\u3076\uff1f\n\u4ee5\u4e0b\u306e\u30c1\u30e5\u30fc\u30c8\u30ea\u30a2\u30eb\u3092\u4f7f\u3063\u3066kubernetes\u3092\u7406\u89e3\u3057\u3066\u3044\u304d\u305f\u3044\u3068\u601d\u3044\u307e\u3059\u3002\n\nRedis \u3068 PHP \u3092\u4f7f\u7528\u3057\u305f\u30b2\u30b9\u30c8\u30d6\u30c3\u30af\u306e\u4f5c\u6210\n\n\u30c1\u30e5\u30fc\u30c8\u30ea\u30a2\u30eb\u306b\u8a18\u8f09\u3057\u3066\u3042\u308b\u60c5\u5831\u304c\u53e4\u3044(ReplicptionController\u306e\u4f5c\u6210\u304b\u3089Deployment\u306e\u4f5c\u6210\u306b\u5909\u308f\u3063\u3066\u3044\u308b)\u306e\u3067\u4ee5\u4e0b\u3082\u53c2\u8003\u306b\u3057\u306a\u304c\u3089\u9032\u3081\u307e\u3059\u3002\n\nGuestbook Example\n\n\u3053\u3093\u306a\u5f62\u306a\u3082\u306e\u3092\u4f5c\u308a\u307e\u3059\u3002\n                +--------------+\n                | LoadBalancer |\n                +--------------+\n                       |\n                +--------------+\n                |   frontend   |\n                +--------------+\n                   |        |\n        +--------------+ +--------------+\n        | redis-master | | redis-slave  |\n        +--------------+ +--------------+\n\n\n\u30b3\u30de\u30f3\u30c9\u74b0\u5883\u306e\u6e96\u5099\ngcloud \u30b3\u30de\u30f3\u30c9\u3068 kubectl \u30b3\u30de\u30f3\u30c9\u3092\u4ee5\u4e0b\u306e\u901a\u308a\u306b\u5f93\u3063\u3066\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u3057\u3066\u304a\u304d\u307e\u3059\u3002\nContainer Engine \u958b\u59cb\u65b9\u6cd5\n\u4f7f\u3046\u74b0\u5883\u3092\u30c7\u30d5\u30a9\u30eb\u30c8\u3067\u8a2d\u5b9a\u3057\u3066\u304a\u304f\u3002\u30b3\u30de\u30f3\u30c9\u3092\u6253\u3064\u5ea6\u306b\u6307\u5b9a\u3057\u306a\u304f\u3066\u3082\u6e08\u3080\u306e\u3067\u3002\n$ gcloud config set project PROJECT_ID # \u30d7\u30ed\u30b8\u30a7\u30af\u30c8ID\u306e\u6307\u5b9a\n\n$ gcloud config set compute/zone asia-northeast1-a # \u30be\u30fc\u30f3\u306e\u6307\u5b9a\n\n$ gcloud config list # \u73fe\u5728\u306e\u8a2d\u5b9a\u3092\u78ba\u8a8d\nYour active configuration is: [default]\n\n[compute]\nregion = asia-northeast1\nzone = asia-northeast1-a\n[core]\naccount = EMAIL_ADDRESS\ndisable_usage_reporting = False\nproject = PROJECT_ID\n\n\n\u30af\u30e9\u30b9\u30bf\uff08\u30ce\u30fc\u30c9\uff09\u306e\u4f5c\u6210\n\u6700\u521d\u306b\u3001\u30b3\u30f3\u30c6\u30ca\u3092\u914d\u7f6e\u3059\u308b\u30af\u30e9\u30b9\u30bf\uff08\u30ce\u30fc\u30c9\uff09\u3092\u4f5c\u6210\u3057\u3066\u304a\u304d\u307e\u3059\u3002\u30c7\u30d5\u30a9\u30eb\u30c8\u30673\u30ce\u30fc\u30c9\u6570\u4f5c\u6210\u3055\u308c\u307e\u3059\u304c\u3001\u4eca\u56de\u306f\u30ce\u30fc\u30c9\u6570\u30921\u306b\u6307\u5b9a\u3057\u3066\u4f5c\u6210\u3057\u307e\u3057\u305f\u3002\n$ gcloud container clusters create guestbook --num-nodes=1\nCreating cluster guestbook...done.                                                 \nCreated [https://container.googleapis.com/v1/projects/{PROJECT_ID}/zones/asia-northeast1-a/clusters/guestbook].\nkubeconfig entry generated for guestbook.\nNAME       ZONE               MASTER_VERSION  MASTER_IP        MACHINE_TYPE   NODE_VERSION  NUM_NODES  STATUS\nguestbook  asia-northeast1-a  1.4.7           104.198.127.169  n1-standard-1  1.4.7         1          RUNNING\n\n\u65e2\u306bKubernetes\u3082\u8d77\u52d5\u3057\u3066\u3044\u308b\u306e\u3067\u3001\u4ee5\u4e0b\u306e\u30b3\u30de\u30f3\u30c9\u3067\u30ed\u30fc\u30ab\u30eb\u30d7\u30ed\u30ad\u30b7\u3092\u8d77\u52d5\u3055\u305b\u3066\u307f\u307e\u3059\u3002\n$ kubectl proxy\nStarting to serve on 127.0.0.1:8001\n\nhttp://localhost:8001/ui/ \u3078\u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3068Kubernetes\u306e\u753b\u9762\u304c\u73fe\u308c\u307e\u3059\u3002\u898b\u305f\u76ee\u304c\u30a4\u30b1\u3066\u307e\u3059\u306d\u3002 \n\n\nRedis\u30de\u30b9\u30bf\u30fc\u306e\u4f5c\u6210\nDeployment\uff08Pod\u3068\u30b3\u30f3\u30c6\u30ca\uff09\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\nredis-master-deployment.yaml \u30d5\u30a1\u30a4\u30eb\n\n\nredis-master-deployment.yaml\napiVersion: extensions/v1beta1\nkind: Deployment\nmetadata:\n  name: redis-master # \u540d\u524d\u306e\u6307\u5b9a\uff08\u5fc5\u9808\uff09\nspec:\n  replicas: 1 # \u30b3\u30f3\u30c6\u30ca\u306e\u30ec\u30d7\u30ea\u30ab\u6570\u306e\u8a2d\u5b9a\n  template:\n    metadata:\n      labels: # \u30e9\u30d9\u30eb\u3092KV\u578b\u3067\u8a2d\u5b9a\n        app: redis\n        role: master\n        tier: backend\n    spec:\n      containers:\n      - name: master # \u30b3\u30f3\u30c6\u30ca\u306e\u540d\u524d\n        image: gcr.io/google_containers/redis:e2e # \u30b3\u30f3\u30c6\u30ca\u30a4\u30e1\u30fc\u30b8\u306e\u6307\u5b9a\uff08\u5fc5\u9808\uff09\n        resources:\n          requests:\n            cpu: 100m # CPU\u30920.1\u30b3\u30a2\u78ba\u4fdd\n            memory: 100Mi # \u30e1\u30e2\u30ea100MiB\u78ba\u4fdd\n        ports:\n        - containerPort: 6379 # \u30b3\u30f3\u30c6\u30ca\u30dd\u30fc\u30c8\u306e\u6307\u5b9a\n\n\n\n\nkube create\u3067\u3053\u306e\u30d5\u30a1\u30a4\u30eb\u3092\u8aad\u307e\u305b\u308b\u3068yaml\u306b\u8a18\u8f09\u3057\u305f\u3068\u304a\u308a\u306e\u30b3\u30f3\u30c6\u30ca\u3092\u4f5c\u6210\u3057\u3066\u304f\u308c\u307e\u3059\u3002\n\n$ kubectl create -f redis-master-deployment.yaml\ndeployment \"redis-master\" created\n\n- Deployment\u4e00\u89a7\u3092\u8868\u793a\u3059\u308b\n\n```bash\n$ kubectl get deployment\nNAME           DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE\nredis-master   1         1         1            1           2m\n\n\nPod\u4e00\u89a7\u3092\u8868\u793a\u3059\u308b\n\n$ kubectl get pod\nNAME                           READY     STATUS    RESTARTS   AGE\nredis-master-343230949-6dmjd   1/1       Running   0          2m\n\nRedis\u306e\u30b3\u30f3\u30c6\u30ca\u304c\u51fa\u6765\u307e\u3057\u305f  \n\n\u5bc4\u308a\u9053\uff08kubectl run \u30b3\u30de\u30f3\u30c9\uff09\nyaml\u3092\u4f5c\u6210\u3057\u306a\u304f\u3066\u3082\u3001kubectl run\u30b3\u30de\u30f3\u30c9\u3067\u540c\u3058\u304f\u4f5c\u6210\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\n\nkubeclt run \u30b3\u30de\u30f3\u30c9\n\n$ kubectl run redis-master \\\n> --image=gcr.io/google_containers/redis:e2e \\\n> --labels=\"app=redis,role=master,tier=backend\" \\\n> --requests=\"cpu=100m,memory=100Mi\" \\\n> --port=6379\ndeployment \"redis-master-run\" created\n\n\u5b9f\u306f\u3001\u3053\u308c\u3060\u3068\u30b3\u30f3\u30c6\u30ca\u540d(\u5b9f\u969b\u306e\u30b3\u30f3\u30c6\u30ca\u540d\u3067\u306f\u306a\u3044)\u304credis-master\uff08\u30c7\u30d5\u30a9\u30eb\u30c8\u3067Pod\u540d\uff09\u306b\u306a\u3063\u3066\u3057\u307e\u3044\u3001\u5b8c\u5168\u306b\u540c\u4e00\u3067\u306f\u3042\u308a\u307e\u305b\u3093\u3002\u30b3\u30f3\u30c6\u30ca\u540d\u3092\u8a2d\u5b9a\u3059\u308b\u30b3\u30de\u30f3\u30c9\u5f15\u65704\u304c\u898b\u3064\u304b\u3089\u306a\u304b\u3063\u305f\u306e\u3067\u3001--overrides\u30aa\u30d7\u30b7\u30e7\u30f3\u3067\u7121\u7406\u3084\u308a\u8a2d\u5b9a\u3057\u3066\u307f\u307e\u3057\u305f\u3002\n\n\n--overrides\u30aa\u30d7\u30b7\u30e7\u30f3\u3092\u3064\u3051\u3066kubectl run\n\n\n$ kubectl run redis-master \\\n> --image=gcr.io/google_containers/redis:e2e \\\n> --labels=\"app=redis,role=master,tier=backend\" \\\n> --overrides='{\"spec\":{\"template\":{\"spec\":{\"containers\":[{\"name\":\"master\",\"image\":\"gcr.io/google_containers/redis:e2e\",\"resources\":{\"requests\":{\"cpu\":\"100m\",\"memory\":\"100Mi\"}},\"ports\":[{\"containerPort\":6379}]}]}}}}'\ndeployment \"redis-master\" created\n\n\u203b --image\u30aa\u30d7\u30b7\u30e7\u30f3\u306f\u5fc5\u9808\u306a\u305f\u3081\u3001--overrides\u5185\u3068\u30b3\u30f3\u30c6\u30ca\u30a4\u30e1\u30fc\u30b8\u306e\u30ed\u30b1\u30fc\u30b7\u30e7\u30f3\u3092\u4e8c\u91cd\u3067\u8a18\u8f09\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\u3002  \u6b86\u3069\u306e\u90e8\u5206\u3092yaml\u304b\u3089json\u306b\u5909\u63db\u3057\u3066\u308b\u611f\u3058\u3067\u3061\u3087\u3063\u3068\u7121\u610f\u5473\u611f\u3002\u3002\n\u5ff5\u306e\u305f\u3081 kube describe pod <POD_NAME>\u306e\u5185\u5bb9\u3092\u6bd4\u8f03\u3057\u3066\u307f\u307e\u3059\u3002\n\ndescribe\u3057\u305f\u5185\u5bb9\u3092\u6bd4\u8f03\n$ diff -u redis-master.describe redis-master_run.describe \n--- redis-master.describe 2016-12-29 23:38:58.000000000 +0900\n+++ redis-master_run.describe 2016-12-29 23:41:49.000000000 +0900\n@@ -1,17 +1,17 @@\n-Name:    redis-master-343230949-6dmjd\n+Name:    redis-master-343230949-n0sxq\n Namespace: default\n Node:    gke-guestbook-default-pool-af5eb675-xszz/10.146.0.2\n-Start Time:  Thu, 29 Dec 2016 22:37:55 +0900\n+Start Time:  Thu, 29 Dec 2016 23:40:41 +0900\n Labels:    app=redis\n    pod-template-hash=343230949\n    role=master\n    tier=backend\n Status:    Running\n-IP:    10.52.0.11\n+IP:    10.52.0.15\n Controllers: ReplicaSet/redis-master-343230949\n Containers:\n   master:\n-    Container ID:  docker://2f57187ee653673df16d40532528086475aadbff9994540541147285600de612\n+    Container ID:  docker://49226c07f4a0ab49503cc46eea01c9382ffe3b62d9d27170ccd8b21f04500365\n     Image:   gcr.io/google_containers/redis:e2e\n     Image ID:    docker://sha256:e5e67996c442f903cda78dd983ea6e94bb4e542950fd2eba666b44cbd303df42\n     Port:    6379/TCP\n@@ -19,7 +19,7 @@\n       cpu:   100m\n       memory:    100Mi\n     State:   Running\n-      Started:   Thu, 29 Dec 2016 22:38:24 +0900\n+      Started:   Thu, 29 Dec 2016 23:40:42 +0900\n     Ready:   True\n     Restart Count: 0\n     Volume Mounts:\n\n\nIP\u30a2\u30c9\u30ec\u30b9\u3084\u65e5\u4ed8\u4ee5\u5916\u3067\u5909\u66f4\u70b9\u306f\u306a\u3044\u306e\u3067\u3001\u540c\u4e00\u306a\u8a2d\u5b9a\u3067\u4f5c\u6210\u3067\u304d\u3066\u3044\u308b\u3053\u3068\u304c\u5206\u304b\u308a\u307e\u3059  \n\n\u5bc4\u308a\u9053\uff08Deployment\uff09\nDeployment\u306f\u6bd4\u8f03\u7684\u65b0\u3057\u304f\u3001Pod\u306e\u4f5c\u6210\u3084\u30ed\u30fc\u30ea\u30f3\u30b0\u30a2\u30c3\u30d7\u30c7\u30fc\u30c8\u3084\u30ed\u30fc\u30eb\u30d0\u30c3\u30af\u306a\u3069\u3092\u7c21\u5358\u306b\u3057\u3066\u304f\u308c\u308b\u3082\u306e\u3067\u3059\u3002\nUsing Deployment objects with Kubernetes 1.2\n\u305d\u308c\u307e\u3067\u306f Replication Controller5\u304c\u305d\u306e\u8fba\u308a\u306e\u5f79\u5272\u3092\u62c5\u3063\u3066\u3044\u305f\u3053\u3068\u3082\u3042\u308a\u3001Tutorial\u3067\u306fReplication Controller \u3067 Pod \u3092\u4f5c\u6210\u3057\u3066\u8aac\u660e\u3057\u3066\u3044\u307e\u3059\u3002\u4eca\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\uff081.4.7\uff09\u3067\u306f\u3001Deployments\u3067Pod\u3092\u4f5c\u6210\u3059\u308b\u3068\u3001Replication Controller \u306e\u6b21\u4e16\u4ee3\u7248\u3067\u3042\u308b Replica Sets6 \u304c\u52d5\u304d\u51fa\u3057\u307e\u3059\u3002Replication Controller \u306f\u7121\u304f\u306a\u3063\u3066\u3057\u307e\u3046\u306e\u304b\u306a\u3041\u3002\u3002\n\u3061\u306a\u307f\u306b\u3001Kubernetes\u306e\u7ba1\u7406UI\u3067\u306f\u672a\u3060 Replication Controller \u304c\u30e1\u30a4\u30f3\u306b\u306a\u3063\u3066\u3044\u308b\u69d8\u3067\u3001UI\u304b\u3089Pod\u3092\u4f5c\u6210\u3059\u308b\u3068 Replication Controller \u304c\u4f5c\u6210\u3055\u308c\u307e\u3059\u3002\n\u8a66\u3057\u3066\u307f\u307e\u3059\u3002\n\n\u30b3\u30de\u30f3\u30c9\u30e9\u30a4\u30f3\u304b\u3089\u30b3\u30f3\u30c6\u30ca\uff08Pod\uff09\u3092\u4f5c\u6210\n\n$ kubectl run cli --image=gcr.io/google-samples/gb-frontend:v4\ndeployment \"cli\" created\n\n\u301c \u3053\u3053\u3067\u3001Kubernetes\u306eUI\u304b\u3089ui\u3068\u3044\u3046\u540d\u524d\u3067\u30b3\u30f3\u30c6\u30ca\u3092\u4f5c\u6210 \u301c\n\n2\u3064\u306ePod\u304c\u4f5c\u6210\u3055\u308c\u3066\u3044\u307e\u3059\n\n$ kubectl get pod\nNAME                   READY     STATUS    RESTARTS   AGE\ncli-2068554765-12stb   1/1       Running   0          1m\nui-sbpaz               1/1       Running   0          22s\n\n\nUI\u304b\u3089\u4f5c\u6210\u3057\u305f\u30b3\u30f3\u30c6\u30ca\u306f Replication Controller \u306b\u306a\u3063\u3066\u3044\u307e\u3059\n\n$ kubectl get replicationcontroller\nNAME      DESIRED   CURRENT   READY     AGE\nui        1         1         1         45s\n\n\n\u30b3\u30de\u30f3\u30c9\u30e9\u30a4\u30f3\u304b\u3089\u306fDeployment\u306b\u306a\u3063\u3066\u3044\u307e\u3059\n\n$ kubectl get deployment\nNAME      DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE\ncli       1         1         1            1           1m\n\nyaml\u306e\u8a2d\u5b9a\u81ea\u4f53\u306f\u6b86\u3069\u5909\u308f\u308a\u307e\u305b\u3093\u3002\u5f37\u3044\u3066\u6319\u3052\u308b\u3068\u3001metadata\u306e\u7b87\u6240\u3067labels\u3092\u7701\u7565\u3057\u3066\u3044\u308b\u6240\u3050\u3089\u3044\u3067\u3059\u3002\n\nTutorial\u306b\u3042\u308bRC\u7528\u3068Deployment\u7528yaml\u306e\u6bd4\u8f03\n--- legacy/redis-master-controller.yaml 2016-12-28 01:18:16.000000000 +0900\n+++ redis-master-deployment.yaml  2016-12-28 01:43:37.000000000 +0900\n@@ -1,13 +1,13 @@\n-apiVersion: v1\n-kind: ReplicationController\n+apiVersion: extensions/v1beta1\n+kind: Deployment\n metadata:\n   name: redis-master\n   # these labels can be applied automatically \n   # from the labels in the pod template if not set\n-  labels:\n-    app: redis\n-    role: master\n-    tier: backend\n+  # labels:\n+  #   app: redis\n+  #   role: master\n+  #   tier: backend\n spec:\n   # this replicas value is default\n   # modify it according to your case\n@@ -15,9 +15,10 @@\n   # selector can be applied automatically \n   # from the labels in the pod template if not set\n   # selector:\n-  #   app: guestbook\n-  #   role: master\n-  #   tier: backend\n+  #   matchLabels:\n+  #     app: guestbook\n+  #     role: master\n+  #     tier: backend\n   template:\n     metadata:\n       labels:\n\n\n\n\u5bc4\u308a\u9053\uff08\u30ce\u30fc\u30c9\u306bSSH\u30ed\u30b0\u30a4\u30f3\uff09\n\u30ce\u30fc\u30c9\u306bSSH\u30ed\u30b0\u30a4\u30f3\u3059\u308b\u3053\u3068\u3082\u3067\u304d\u307e\u3059\u3002\n\n\n-o wide\u3067Pod\u304c\u914d\u7f6e\u3055\u308c\u3066\u3044\u308b\u30ce\u30fc\u30c9ID\u3092\u8868\u793a\u3055\u305b\u307e\u3059\u3002\n\n$ kubectl get pod -o wide\nNAME                           READY     STATUS    RESTARTS   AGE       IP           NODE\nredis-master-343230949-n0sxq   1/1       Running   0          11m       10.52.0.15   gke-guestbook-default-pool-af5eb675-xszz\n\n\n\u4e0a\u8a18\u30ce\u30fc\u30c9\u3092\u6307\u5b9a\u3057\u3066SSH\u30ed\u30b0\u30a4\u30f3\u3057\u307e\u3059\u3002\n\n$ gcloud compute ssh gke-guestbook-default-pool-af5eb675-xszz\nWarning: Permanently added 'compute.7579721538501918346' (RSA) to the list of known hosts.\n\nWelcome to Kubernetes v1.4.7!\n\nYou can find documentation for Kubernetes at:\n  http://docs.kubernetes.io/\n\nThe source for this release can be found at:\n  /home/kubernetes/kubernetes-src.tar.gz\nOr you can download it at:\n  https://storage.googleapis.com/kubernetes-release/release/v1.4.7/kubernetes-src.tar.gz\n\nIt is based on the Kubernetes source at:\n  https://github.com/kubernetes/kubernetes/tree/v1.4.7\n\nFor Kubernetes copyright and licensing information, see:\n  /home/kubernetes/LICENSES\nuser@gke-guestbook-default-pool-af5eb675-xszz ~ $\n\n\n\u30ed\u30b0\u30a4\u30f3\u51fa\u6765\u305f\u306e\u3067\"docker ps\"\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3057\u3066\u307f\u307e\u3059\u3002kubernetes\u95a2\u9023\u306e\u30b3\u30f3\u30c6\u30ca\u304c\u6ca2\u5c71\u52d5\u3044\u3066\u307e\u3059\u306d\u3002\n\nuser@gke-guestbook-default-pool-af5eb675-xszz ~ $ docker ps\nCONTAINER ID        IMAGE                                                                  COMMAND                  CREATED             STATUS              PORTS               NAMES\n49226c07f4a0        gcr.io/google_containers/redis:e2e                                     \"redis-server /etc/re\"   12 minutes ago      Up 12 minutes                           k8s_master.b505b5b1_redis-master-343230949-n0sxq_default_c5e1c119-cdd4-11e6-9059-42010a920020_d5ed9c19\nf2e1a93483ef        gcr.io/google_containers/pause-amd64:3.0                               \"/pause\"                 12 minutes ago      Up 12 minutes                           k8s_POD.d8dbe16c_redis-master-343230949-n0sxq_default_c5e1c119-cdd4-11e6-9059-42010a920020_594d5d61\ned54277b3108        asia.gcr.io/google_containers/addon-resizer:1.6                        \"/pod_nanny --cpu=80m\"   2 hours ago         Up 2 hours                              k8s_heapster-nanny.55df2c69_heapster-v1.2.0-1847815531-zrkw6_kube-system_378ff7ba-cdc2-11e6-9059-42010a920020_84f3de55\n22a3bf8a8816        asia.gcr.io/google_containers/heapster:v1.2.0                          \"/heapster --source=k\"   2 hours ago         Up 2 hours                              k8s_heapster.d8c9b305_heapster-v1.2.0-1847815531-zrkw6_kube-system_378ff7ba-cdc2-11e6-9059-42010a920020_b3e26ab1\nb4bb94588700        gcr.io/google_containers/pause-amd64:3.0                               \"/pause\"                 2 hours ago         Up 2 hours                              k8s_POD.d8dbe16c_heapster-v1.2.0-1847815531-zrkw6_kube-system_378ff7ba-cdc2-11e6-9059-42010a920020_f00e16d7\n262de7613d9e        asia.gcr.io/google_containers/exechealthz-amd64:1.2                    \"/exechealthz '--cmd=\"   2 hours ago         Up 2 hours                              k8s_healthz.aaa6418e_kube-dns-v20-8uddr_kube-system_25491b5f-cdc2-11e6-9059-42010a920020_19442f61\n218ef4491c93        asia.gcr.io/google_containers/kube-dnsmasq-amd64:1.4                   \"/usr/sbin/dnsmasq --\"   2 hours ago         Up 2 hours                              k8s_dnsmasq.daf813d2_kube-dns-v20-8uddr_kube-system_25491b5f-cdc2-11e6-9059-42010a920020_da4ffbd1\n02b6c5abe863        asia.gcr.io/google_containers/kubedns-amd64:1.8                        \"/kube-dns --domain=c\"   2 hours ago         Up 2 hours                              k8s_kubedns.dc925936_kube-dns-v20-8uddr_kube-system_25491b5f-cdc2-11e6-9059-42010a920020_226b6b62\n9fc09d1f352d        asia.gcr.io/google_containers/defaultbackend:1.0                       \"/server\"                2 hours ago         Up 2 hours                              k8s_default-http-backend.8208ca2c_l7-default-backend-v1.0-shaxn_kube-system_251d5635-cdc2-11e6-9059-42010a920020_22aef95d\n61d5ea514139        asia.gcr.io/google_containers/kubernetes-dashboard-amd64:v1.4.0        \"/dashboard --port=90\"   2 hours ago         Up 2 hours                              k8s_kubernetes-dashboard.44adcd81_kubernetes-dashboard-v1.4.0-ev5z4_kube-system_2538ca75-cdc2-11e6-9059-42010a920020_3c45962e\nddc295bd5b86        asia.gcr.io/google_containers/fluentd-gcp:1.21                         \"/bin/sh -c 'rm /lib/\"   2 hours ago         Up 2 hours                              k8s_fluentd-cloud-logging.9d1761e_fluentd-cloud-logging-gke-guestbook-default-pool-af5eb675-xszz_kube-system_9d40f2ab7a284a2e847ba6ea821d674b_08346356\nb5a7f7a969fe        gcr.io/google_containers/pause-amd64:3.0                               \"/pause\"                 2 hours ago         Up 2 hours                              k8s_POD.d8dbe16c_kube-dns-v20-8uddr_kube-system_25491b5f-cdc2-11e6-9059-42010a920020_cfddc70c\n2625088adb2d        gcr.io/google_containers/pause-amd64:3.0                               \"/pause\"                 2 hours ago         Up 2 hours                              k8s_POD.d8dbe16c_l7-default-backend-v1.0-shaxn_kube-system_251d5635-cdc2-11e6-9059-42010a920020_2eb5e129\n6904e351db39        gcr.io/google_containers/pause-amd64:3.0                               \"/pause\"                 2 hours ago         Up 2 hours                              k8s_POD.d8dbe16c_kubernetes-dashboard-v1.4.0-ev5z4_kube-system_2538ca75-cdc2-11e6-9059-42010a920020_536e1b7b\n7672d253bc84        gcr.io/google_containers/pause-amd64:3.0                               \"/pause\"                 2 hours ago         Up 2 hours                              k8s_POD.d8dbe16c_fluentd-cloud-logging-gke-guestbook-default-pool-af5eb675-xszz_kube-system_9d40f2ab7a284a2e847ba6ea821d674b_85d10a63\n16bdffccc672        gcr.io/google_containers/kube-proxy:31be43b1cb619b7b0ab8fe01f997fe2f   \"/bin/sh -c 'kube-pro\"   2 hours ago         Up 2 hours                              k8s_kube-proxy.3ea31aa7_kube-proxy-gke-guestbook-default-pool-af5eb675-xszz_kube-system_0a4a2e1c974bec66debcc5815d60085a_0833b062\n9cacc1697cf5        gcr.io/google_containers/pause-amd64:3.0                               \"/pause\"                 2 hours ago         Up 2 hours                              k8s_POD.d8dbe16c_kube-proxy-gke-guestbook-default-pool-af5eb675-xszz_kube-system_0a4a2e1c974bec66debcc5815d60085a_20190c5a\n\n\n\u5bc4\u308a\u9053\uff08SSH\u30ed\u30b0\u30a4\u30f3\u30e6\u30fc\u30b6\u30fc\uff09\nSSH\u30ed\u30b0\u30a4\u30f3\u306e\u66f8\u5f0f\u306f\u3001gcloud compute ssh  [USER@]INSTANCE \u3067USER\u3092\u3064\u3051\u306a\u3044\u3068\u30ed\u30fc\u30ab\u30eb\u74b0\u5883\u306e\u30e6\u30fc\u30b6\u30fc\u540d\u3067\u63a5\u7d9a\u3057\u307e\u3059\uff08\u901a\u5e38\u306eSSH\u3068\u540c\u69d8\u306a\u52d5\u304d\uff09\u3002\u30e6\u30fc\u30b6\u30fc\u306f\u81ea\u52d5\u7684\u306b\u4f5c\u6210\u3055\u308cGCE\u5074\u3078\u767b\u9332\u3055\u308c\u307e\u3059\u3002\n\u767b\u9332\u3055\u308c\u3066\u3044\u308b\u30e6\u30fc\u30b6\u30fc\u3068SSH\u516c\u958b\u9375\u306f\u4ee5\u4e0b\u3067\u78ba\u8a8d\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\nhttps://console.cloud.google.com/compute/metadata/sshKeys\n\nRedis \u30de\u30b9\u30bf\u30fc\u306e\u30b5\u30fc\u30d3\u30b9\u306e\u4f5c\u6210\n\u30b3\u30f3\u30c6\u30ca\u3068\u901a\u4fe1\u3055\u305b\u308b\u305f\u3081\u306eService\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\nredis-master-service.yaml \u30d5\u30a1\u30a4\u30eb\n\n\nredis-master-service.yaml\napiVersion: v1\nkind: Service\nmetadata:\n  name: redis-master\n  labels:\n    app: redis\n    role: master\n    tier: backend\nspec:\n  ports:\n  - port: 6379\n    targetPort: 6379\n  selector:\n    app: redis\n    role: master\n    tier: backend\n\n\n\nyaml\u30d5\u30a1\u30a4\u30eb\u3092\u8aad\u307f\u8fbc\u3093\u3067\u30b5\u30fc\u30d3\u30b9\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n$ kubectl create -f redis-master-service.yaml\nservice \"redis-master\" created\n\n\n\u30b5\u30fc\u30d3\u30b9\u306e\u60c5\u5831\u3092\u8868\u793a\u3057\u307e\u3059\u3002\n\n$ kubectl get service redis-master\nNAME           CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE\nredis-master   10.55.246.114   <none>        6379/TCP   43s\n\n\n\u3082\u3061\u308d\u3093\u3001\u30b3\u30de\u30f3\u30c9\u30e9\u30a4\u30f3\u3067\u30b5\u30fc\u30d3\u30b9\u3092\u4f5c\u6210\u3059\u308b\u3053\u3068\u3082\u3067\u304d\u307e\u3059\u3002\n\n$ kubectl expose service redis-master \\\n> --labels=\"app=redis,role=master,tier=backend\" \\\n> --selector=\"app=redis,role=master,tier=backend\" \\\n> --port=6379 \\\n> --target-port=6379\n\n\nRedis \u30b9\u30ec\u30fc\u30d6\u306e\u30b3\u30f3\u30c6\u30ca\u3068\u30b5\u30fc\u30d3\u30b9\u4f5c\u6210\nRedis\u30de\u30b9\u30bf\u30fc\u3068\u540c\u69d8\u306b\u30b3\u30f3\u30c6\u30ca\u3068\u30b5\u30fc\u30d3\u30b9\u3092\u4f5c\u6210\u3057\u3066\u3044\u304d\u307e\u3059\u3002\n\nredis-slave-deployment.yaml \u30d5\u30a1\u30a4\u30eb\n\n\nredis-slave-deployment.yaml\napiVersion: extensions/v1beta1\nkind: Deployment\nmetadata:\n  name: redis-slave\nspec:\n  replicas: 2 # \u30ec\u30d7\u30ea\u30ab\u6570\u30922\u306b\u6307\u5b9a\n  template:\n    metadata:\n      labels:\n        app: redis\n        role: slave\n        tier: backend\n    spec:\n      containers:\n      - name: slave\n        image: gcr.io/google_samples/gb-redisslave:v1\n        resources:\n          requests:\n            cpu: 100m\n            memory: 100Mi\n        env:\n        - name: GET_HOSTS_FROM # \u74b0\u5883\u5909\u6570\u3092\u30bb\u30c3\u30c8\u3057\u3066\u3044\u307e\u3059\u3002PHP\u306e\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3067\u4f7f\u3044\u307e\u3059\u3002\n          value: dns\n        ports:\n        - containerPort: 6379\n\n\n\n\u30b3\u30f3\u30c6\u30ca\u3092\u4f5c\u6210\u3057\u3066Pod\u6570\u304c2\u306b\u306a\u3063\u3066\u3044\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n$ kubectl create -f redis-slave-deployment.yaml \ndeployment \"redis-slave\" created\n\n$ kubectl get deployment redis-slave\nNAME          DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE\nredis-slave   2         2         2            0           24s # 2\u306b\u306a\u3063\u3066\u3044\u308b\n\n$ kubectl get pod \nNAME                           READY     STATUS    RESTARTS   AGE\nredis-master-343230949-08kqi   1/1       Running   0          7m\nredis-slave-132015689-3x3qp    1/1       Running   0          48s # 1Pod\u76ee\nredis-slave-132015689-b6cha    1/1       Running   0          48s # 2Pod\u76ee\n\nredis-slave\u306ePod\u304c2\u3064\u3042\u308b\u306e\u304c\u5206\u304b\u308a\u307e\u3059\u3002\u6b21\u306b\u30b5\u30fc\u30d3\u30b9\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\nredis-slave-service.yaml \u30d5\u30a1\u30a4\u30eb\n\n\nredis-slave-service.yaml\napiVersion: v1\nkind: Service\nmetadata:\n  name: redis-slave\n  labels:\n    app: redis\n    role: slave\n    tier: backend\nspec:\n  ports:\n  - port: 6379\n  selector:\n    app: redis\n    role: slave\n    tier: backend\n\n\n\nredis-slave\u306e\u30b5\u30fc\u30d3\u30b9\u3092\u4f5c\u6210\u3057\u3066\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n$ kubectl create -f redis-slave-service.yaml\nservice \"redis-slave\" created\n\n$ kubectl get svc redis-slave # services\u3092\"svc\"\u3068\u7701\u7565\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\nNAME          CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE\nredis-slave   10.55.255.111   <none>        6379/TCP   18s\n\n\n\u30d5\u30ed\u30f3\u30c8\u30a8\u30f3\u30c9 \u30a6\u30a7\u30d6\u30b5\u30fc\u30d0\u30fc\u306e\u4f5c\u6210\n\u30d0\u30c3\u30af\u30a8\u30f3\u30c9\u5074\uff08redis\uff09\u306f\u4f5c\u6210\u3057\u305f\u306e\u3067\u3001\u6b21\u304b\u3089\u30d5\u30ed\u30f3\u30c8\u30a8\u30f3\u30c9\u3092\u4f5c\u6210\u3057\u3066\u3044\u304d\u307e\u3059\u3002\n\nfront-deployment.yaml \u30d5\u30a1\u30a4\u30eb\n\n\nfrontend-deployment.yaml\napiVersion: extensions/v1beta1\nkind: Deployment\nmetadata:\n  name: frontend\nspec:\n  replicas: 3\n  template:\n    metadata:\n      labels:\n        app: guestbook\n        tier: frontend\n    spec:\n      containers:\n      - name: php-redis\n        image: gcr.io/google-samples/gb-frontend:v4\n        resources:\n          requests:\n            cpu: 100m\n            memory: 100Mi\n        env:\n        - name: GET_HOSTS_FROM\n          value: dns\n        ports:\n        - containerPort: 80\n\n\n\nfrontend\u3092\u4f5c\u6210\u3057\u3066\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n$ kubectl create -f frontend-deployment.yaml\ndeployment \"frontend\" created\n\n kubectl get deployment frontend\nNAME       DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE\nfrontend   3         3         3            3           1m\n\n$ kubectl get pods\nNAME                           READY     STATUS    RESTARTS   AGE\nfrontend-88237173-cp3rn        1/1       Running   0          1m\nfrontend-88237173-kxlgh        1/1       Running   0          1m\nfrontend-88237173-tw65g        1/1       Running   0          1m\nredis-master-343230949-08kqi   1/1       Running   0          29m\nredis-slave-132015689-3x3qp    1/1       Running   0          22m\nredis-slave-132015689-b6cha    1/1       Running   0          22m\n\nfrontend\u7528\u306e\u30b5\u30fc\u30d3\u30b9\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002frontend\u306f\u8907\u6570\u53f0\u306e\u8ca0\u8377\u5206\u6563\u3092\u3057\u305f\u3044\u306e\u3067type: LoadBalancer\u3092\u6307\u5b9a\u3057\u3066\u3044\u307e\u3059\u3002\n\nfrontend-service.yaml \u30d5\u30a1\u30a4\u30eb\n\n\nfrontend-service.yaml\napiVersion: v1\nkind: Service\nmetadata:\n  name: frontend\n  labels:\n    app: guestbook\n    tier: frontend\nspec:\n  type: LoadBalancer\n  ports:\n  - port: 80\n  selector:\n    app: guestbook\n    tier: frontend\n\n\n$ kubectl create -f frontend-service.yaml \nservice \"frontend\" created\n\n$ kubectl get svc frontend\nNAME       CLUSTER-IP      EXTERNAL-IP     PORT(S)   AGE\nfrontend   10.55.254.255   104.198.125.6   80/TCP    3m\n\ntype: LoadBalancer \u3092\u6307\u5b9a\u3059\u308b\u3068\u5225\u9014GCE\u306e\u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b5\u30fc\u304c\u4f5c\u6210\u3055\u308c\u3066\u3044\u307e\u3059\u3002\u30c7\u30d5\u30a9\u30eb\u30c8\u3060\u3068\u30d8\u30eb\u30b9\u30c1\u30a7\u30c3\u30af\u306a\u3069\u306e\u8a2d\u5b9a\u304c\u3055\u308c\u3066\u306a\u3044\u306e\u3067\u5fc5\u8981\u306b\u5fdc\u3058\u3066\u5909\u66f4\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\nEXTERNAL_IP\u306b\u30d6\u30e9\u30a6\u30b6\u3067\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3068\u4ee5\u4e0b\u306e\u69d8\u306a\u753b\u9762\u304c\u307f\u308c\u307e\u3057\u305f\u3002\n\n\nPHP\u306e\u4e2d\u8eab\n\u3053\u306e\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306fPHP\u3067\u66f8\u304b\u308c\u3066\u3044\u308b\u306e\u3067\u4f55\u3092\u3057\u3066\u308b\u304b\u78ba\u8a8d\u3057\u3066\u307f\u305f\u3044\u3068\u601d\u3044\u307e\u3059\u3002\n\nguestbook.php\n<?php\n\nerror_reporting(E_ALL);\nini_set('display_errors', 1);\n\nrequire 'Predis/Autoloader.php';\n\nPredis\\Autoloader::register();\n\nif (isset($_GET['cmd']) === true) {\n  $host = 'redis-master';\n  if (getenv('GET_HOSTS_FROM') == 'env') {\n    $host = getenv('REDIS_MASTER_SERVICE_HOST');\n  }\n  header('Content-Type: application/json');\n  if ($_GET['cmd'] == 'set') {\n    $client = new Predis\\Client([\n      'scheme' => 'tcp',\n      'host'   => $host,\n      'port'   => 6379,\n    ]);\n\n    $client->set($_GET['key'], $_GET['value']);\n    print('{\"message\": \"Updated\"}');\n  } else {\n    $host = 'redis-slave';\n    if (getenv('GET_HOSTS_FROM') == 'env') {\n      $host = getenv('REDIS_SLAVE_SERVICE_HOST');\n    }\n    $client = new Predis\\Client([\n      'scheme' => 'tcp',\n      'host'   => $host,\n      'port'   => 6379,\n    ]);\n\n    $value = $client->get($_GET['key']);\n    print('{\"data\": \"' . $value . '\"}');\n  }\n} else {\n  phpinfo();\n} ?>\n\n\n\u66f8\u304d\u8fbc\u307f\u306a\u3089Redis\u306e\u30de\u30b9\u30bf\u30fc\u3078\u63a5\u7d9a\u3057\u3001\u8aad\u307f\u8fbc\u307f\u306a\u3089Redis\u306e\u30b9\u30ec\u30fc\u30d6\u3078\u63a5\u7d9a\u3059\u308b\u5236\u5fa1\u3092\u3057\u3066\u3044\u307e\u3059\u3002\nRedis\u306e\u30de\u30b9\u30bf\u30fc\u306e\u30db\u30b9\u30c8\u540d\u306fredis-master\u3067\u3001\u30b9\u30ec\u30fc\u30d6\u306fredis-slave\u3067\u63a5\u7d9a\u3057\u3066\u3044\u307e\u3059\u3002Redis\u306eDeployment\u3092\u4f5c\u6210\u3057\u305f\u3068\u304d\u306b\u6307\u5b9a\u3057\u305fname\u304c\u30b3\u30f3\u30c6\u30ca\u306eDNS\u7a7a\u9593\u306b\u53cd\u6620\u3055\u308c\u3066\u3044\u308b\u3068\u3044\u3046\u3053\u3068\u3067\u3059\u306d\u3002\n\u9006\u306bDNS\u3092\u4f7f\u308f\u306a\u3044\u5834\u5408\u3082\u3042\u308b\u306e\u3067\u3001\u305d\u306e\u5224\u5225if (getenv('GET_HOSTS_FROM') == 'env') {\u3092\u5165\u308c\u3066\u74b0\u5883\u5909\u6570\u3092\u4f7f\u3046\u4e8b\u3082\u51fa\u6765\u308b\u3088\u3046\u306b\u3057\u3066\u3044\u307e\u3059\u3002\nfrontend-deployment.yaml\u3067\u4ee5\u4e0b\u306e\u8a2d\u5b9a\u304c\u3055\u308c\u3066\u3044\u308b\u306e\u3067\u3001\u3053\u306ePHP\u3067\u306fDNS\u540d\u3092\u4f7f\u3063\u3066\u3044\u307e\u3059\u3002\n\nfrontend-deployment.yaml\n...\n        env:\n        - name: GET_HOSTS_FROM\n          value: dns            # env\u306b\u3059\u308b\u3068PHP\u304c\u74b0\u5883\u5909\u6570\u3092\u4f7f\u3046\u3088\u3046\u306b\u306a\u308b\n...\n\n\n\n\u30ec\u30d7\u30ea\u30ab\u6570\u3092\u5909\u66f4\u3057\u3066\u307f\u308b\n\u7c21\u5358\u306b\u9014\u4e2d\u3067\u30ec\u30d7\u30ea\u30ab\u6570\u3092\u5909\u66f4\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\n\u30ec\u30d7\u30ea\u30ab\u6570\u30925\u3078\u5909\u66f4\u3059\u308b\n\n$ kubectl scale deployment frontend --replicas=5\ndeployment \"frontend\" scaled\n\n\n5\u306b\u306a\u3063\u3066\u3044\u308b\u3053\u3068\u304c\u5206\u304b\u308a\u307e\u3059\u3002\n\n$ kubectl get deployment frontend\nNAME       DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE\nfrontend   5         5         5            5           51m\n\n\nPod\u3092\u898b\u308b\u3068\u5897\u3048\u3066\u3044\u308b\u306e\u304c\u5206\u304b\u308a\u307e\u3059\n\n$ kubectl get pods\nNAME                           READY     STATUS    RESTARTS   AGE\nfrontend-88237173-cp3rn        1/1       Running   0          26m\nfrontend-88237173-kuyzx        1/1       Running   0          6s   # \u5897\u3048\u305fPod\nfrontend-88237173-kxlgh        1/1       Running   0          26m\nfrontend-88237173-sljba        1/1       Running   0          6s   # \u5897\u3048\u305fPod\nfrontend-88237173-tw65g        1/1       Running   0          26m\nredis-master-343230949-08kqi   1/1       Running   0          53m\nredis-slave-132015689-3x3qp    1/1       Running   0          47m\nredis-slave-132015689-b6cha    1/1       Running   0          47m\n\n\n\u5bc4\u308a\u9053\uff08kube edit\uff09\nkube edit\u30b3\u30de\u30f3\u30c9\u3092\u4f7f\u3063\u3066\u30ec\u30d7\u30ea\u30ab\u6570\u3084\u305d\u306e\u4ed6\u306e\u8a2d\u5b9a\u3092\u5909\u66f4\u3059\u308b\u3053\u3068\u3082\u3067\u304d\u307e\u3059\u3002\n$ KUBE_EDITOR=vim kubectl edit deployment frontend # \u30c7\u30d5\u30a9\u30eb\u30c8\u30a8\u30c7\u30a3\u30bf\u306fvi\n\n\u4e0a\u8a18\u30b3\u30de\u30f3\u30c9\u3067\u3001\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\uff08yaml\uff09\u304c\u958b\u304f\u306e\u3067\u4fee\u6b63\u3057\u3066\u4fdd\u5b58\u3059\u308b\u3068\u8a2d\u5b9a\u3092\u5909\u66f4\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\n\u969c\u5bb3\u767a\u751f\u6642\u306ePod\u306e\u6319\u52d5\n\u30b3\u30de\u30f3\u30c9\u3067Pod\u3092\u524a\u9664\u3057\u3066\u3001\u969c\u5bb3\u767a\u751f\u3092\u30b7\u30df\u30e5\u30ec\u30fc\u30b7\u30e7\u30f3\u3057\u3066\u307f\u305f\u3044\u3068\u601d\u3044\u307e\u3059\u3002\n\n\u30b7\u30df\u30e5\u30ec\u30fc\u30b7\u30e7\u30f3\u3059\u308b\u524d\u306b\u72b6\u614b\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n$ kubectl get pods\nNAME                           READY     STATUS    RESTARTS   AGE\nfrontend-88237173-cp3rn        1/1       Running   0          53m\nfrontend-88237173-kxlgh        1/1       Running   0          53m\nfrontend-88237173-tw65g        1/1       Running   0          53m\nredis-master-343230949-08kqi   1/1       Running   0          1h\nredis-slave-132015689-3x3qp    1/1       Running   0          1h\nredis-slave-132015689-b6cha    1/1       Running   0          1h\n\n\nPod\u3092\u4e00\u3064\u524a\u9664\u3057\u307e\u3059\u3002\n\n$ kubectl delete pod frontend-88237173-cp3rn\npod \"frontend-88237173-cp3rn\" deleted\n\n\n\u5373\u5ea7\u306b\u65b0\u3057\u3044Pod\u304c\u4f5c\u6210\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n\n$ kubectl get pods\nNAME                           READY     STATUS    RESTARTS   AGE\nfrontend-88237173-0omu3        1/1       Running   0          3s   # \u76f4\u3050Pod\u304c\u4f5c\u6210\u3055\u308c\u305f\nfrontend-88237173-kxlgh        1/1       Running   0          54m\nfrontend-88237173-tw65g        1/1       Running   0          54m\nredis-master-343230949-08kqi   1/1       Running   0          1h\nredis-slave-132015689-3x3qp    1/1       Running   0          1h\nredis-slave-132015689-b6cha    1/1       Running   0          1h\n\n\u898b\u4e8b\u306b\u30ec\u30d7\u30ea\u30ab\u304c\u518d\u4f5c\u6210\u3055\u308c\u307e\u3057\u305f\u3002  \n\n\u30e9\u30d9\u30eb\u3092\u5909\u66f4\u3057\u3066\u307f\u308b\nKubernetes\u306f\u30e9\u30d9\u30eb\u3092\u307f\u3066\u30ec\u30d7\u30ea\u30ab\u6570\u3092\u30c1\u30a7\u30c3\u30af\u3057\u3066\u3044\u308b\u3068\u306e\u3053\u3068\u3067\u3001\u305d\u306e\u30e9\u30d9\u30eb\u306b\u5909\u66f4\u304c\u3042\u3063\u305f\u5834\u5408\u306e\u6319\u52d5\u3092\u78ba\u8a8d\u3057\u3066\u307f\u305f\u3044\u3068\u601d\u3044\u307e\u3059\u3002\n\n\u30e9\u30d9\u30eb\u304ctier=frontend \u306ePod\u3092\u8868\u793a\u3057\u307e\u3059\u3002\n\n$ kubectl get pod -l tier=frontend\nNAME                      READY     STATUS    RESTARTS   AGE\nfrontend-88237173-0omu3   1/1       Running   0          21m  # \u3053\u306ePod\u306e\u30e9\u30d9\u30eb\u3092\u5909\u66f4\u3059\u308b\nfrontend-88237173-fadzg   1/1       Running   0          1m\nfrontend-88237173-tw65g   1/1       Running   0          1h\n\n\n\u3072\u3068\u3064\u306ePod\u306e\u30e9\u30d9\u30eb\u3092\u5909\u66f4\u3057\u307e\u3059\u3002\n\n$ kubectl label --overwrite pods frontend-88237173-0omu3 tier=middle\npod \"frontend-88237173-0omu3\" labeled\n\n\n\u30e9\u30d9\u30eb\u304ctier=frontend\u306ePod\u3092\u8868\u793a\u3057\u307e\u3059\u3002\u65b0\u3057\u3044Pod\u306b\u5165\u308c\u66ff\u3063\u3066\u3044\u308b\u306e\u304c\u5206\u304b\u308a\u307e\u3059\u3002\n\n$ kubectl get pod -l tier=frontend\nNAME                      READY     STATUS    RESTARTS   AGE\nfrontend-88237173-fadzg   1/1       Running   0          2m\nfrontend-88237173-kkjpu   1/1       Running   0          4s   # \u65b0\u3057\u3044Pod\u306b\u5909\u308f\u3063\u3066\u3044\u308b\nfrontend-88237173-tw65g   1/1       Running   0          1h\n\n\nfrontend\u3068\u3057\u3066\u30ec\u30d7\u30ea\u30ab\u6570\u306f\u7dad\u6301\u3057\u3066\u3044\u307e\u3059\u3002\n\n$ kubectl get deployment frontend\nNAME       DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE\nfrontend   3         3         3            3           1h   # Pod\u306e\u6570\u306f\u5909\u308f\u3089\u306a\u3044\n\n\n\u5909\u66f4\u3057\u305fPod\u306fDeployment\u5916\u306b\u5b58\u5728\u3057\u3066\u3044\u307e\u3059\u3002\n\n$ kubectl get pod -l tier=middle\nNAME                      READY     STATUS    RESTARTS   AGE\nfrontend-88237173-0omu3   1/1       Running   0          22m # \u5909\u66f4\u3057\u305fPod\u306f\u5b58\u5728\u3057\u3066\u3044\u308b\n\n\u3053\u3061\u3089\u3082\u898b\u4e8b\u306b\u30ec\u30d7\u30ea\u30ab\u3092\u7dad\u6301\u3057\u3066\u304f\u308c\u3066\u3044\u307e\u3059\u3002  \n\n\u30af\u30ea\u30fc\u30f3\u30a2\u30c3\u30d7\n\u30ea\u30bd\u30fc\u30b9\u3092\u5168\u3066\u524a\u9664\u3057\u307e\u3059\u3002\n$ kubectl delete service,deployment --all\nservice \"frontend\" deleted\nservice \"kubernetes\" deleted\nservice \"redis-master\" deleted\nservice \"redis-slave\" deleted\ndeployment \"frontend\" deleted\ndeployment \"redis-master\" deleted\ndeployment \"redis-slave\" deleted\n\n$ gcloud container clusters delete guestbook\nThe following clusters will be deleted.\n - [guestbook] in [asia-northeast1-a]\n\nDo you want to continue (Y/n)?  Y\n\nDeleting cluster guestbook...done.                                                 \nDeleted [https://container.googleapis.com/v1/projects/{PROJECT_ID}/zones/asia-northeast1-a/clusters/guestbook].\n\n\n\u6700\u5f8c\u306b\n\u7c21\u5358\u306b\u30b3\u30f3\u30c6\u30ca\u306e\u904b\u7528\u304c\u3067\u304d\u308b\u3068\u5b9f\u611f\u3057\u307e\u3057\u305f\u3002\n\u30d7\u30ed\u30d3\u30b8\u30e7\u30cb\u30f3\u30b0\u3082\u7c21\u5358\u3067\u3059\u304c\u3001\u305d\u308c\u3088\u308a\u3082\u904b\u7528\u4e2d\u306e\u7ba1\u7406\u304c\u67d4\u8edf\u306b\u3067\u304d\u308b\u306e\u304c\u6700\u5927\u306a\u9b45\u529b\u3060\u3068\u601d\u3044\u307e\u3059\u3002\u4eca\u5ea6\u306f\u30ed\u30fc\u30ea\u30f3\u30b0\u30a2\u30c3\u30d7\u30c7\u30fc\u30c8\u306a\u3069\u3088\u308a\u5b9f\u8df5\u306b\u8fd1\u3044\u3053\u3068\u3092\u5b66\u3093\u3067\u3044\u304d\u305f\u3044\u3068\u601d\u3044\u307e\u3059\u3002\n\u305d\u308c\u3067\u306f  \n\n\n\n\nPicking the Right Solution - kubernetes.io\u00a0\u21a9\n\n\nDeployments - kubernetes.io\u00a0\u21a9\n\n\nServices - kubernetes.io\u00a0\u21a9\n\n\nkube run \u30b3\u30de\u30f3\u30c9\u30ea\u30d5\u30a1\u30ec\u30f3\u30b9\u00a0\u21a9\n\n\nReplication Controller - kubernetes.io\u00a0\u21a9\n\n\nReplica Sets - kubernetes.io\u00a0\u21a9\n\n\n\n![image](https://qiita-image-store.s3.amazonaws.com/0/142397/484fc8d3-4c22-ce4e-00eb-69d4d822d9c6.png)\n\n\n\nKubernetes\u306f\u30b3\u30f3\u30c6\u30ca\u3092\u4f7f\u3063\u305f\u30b7\u30b9\u30c6\u30e0\u306e\u30e9\u30a4\u30d5\u30b5\u30a4\u30af\u30eb\u3092\u7ba1\u7406\u3059\u308b\u30aa\u30fc\u30d7\u30f3\u30bd\u30fc\u30b9\u3067\u3059\u3002\n\u5927\u4f53\u306e\u30a4\u30f3\u30d5\u30e9[^1]\u3067\u52d5\u304d\u307e\u3059\u304c\u3001\u4eca\u56de\u306fKubernetes\u306e\u74b0\u5883\u304c\u4e88\u3081\u7528\u610f\u3055\u308c\u3066\u3044\u308bGKE\u3092\u4f7f\u3063\u3066\u3001\u4f7f\u3046\u5074\u306e\u8996\u70b9\u3067\u5b66\u3073\u305f\u3044\u3068\u601d\u3044\u307e\u3059\u3002\n\n[^1]: [Picking the Right Solution - kubernetes.io](http://kubernetes.io/docs/getting-started-guides/#custom-solutions)\n\n## \u5927\u96d1\u628a\u306a\u7406\u89e3\n\n\u307e\u305a\u3001\u3056\u3063\u304f\u308a\u69cb\u6210\u3092\u628a\u63e1\u3059\u308b\u305f\u3081\u306b\u56f3\u3092\u898b\u3066\u307f\u307e\u3059\n\u3002\n\n![image](https://qiita-image-store.s3.amazonaws.com/0/142397/3f47ca33-0e1f-e464-4787-3fb9732d658f.png)\n\u56f3\uff1a[Kubernetes architecture](https://github.com/kubernetes/kubernetes/blob/master/docs/design/architecture.md)\n\n\u5de6\u5074\u304cKubernetes\u306e\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u30fc\u3067\u3001\u53f3\u5074\u304c\u7ba1\u7406\u5bfe\u8c61\u306e\u30b3\u30f3\u30c6\u30ca\u3067\u3059\u3002\u4ee5\u4e0b\u306e\u5358\u8a9e\u3092\u7c21\u5358\u306b\u6291\u3048\u3066\u304a\u304d\u307e\u3059\u3002\n\n- Node\u30fb\u30fbDocker\u304c\u52d5\u304f\u30de\u30b7\u30f3\u306e\u3053\u3068\u3002\n- Pod\u30fb\u30fb\u30b3\u30f3\u30c6\u30ca\u3092\u914d\u7f6e\u3059\u308b\u5165\u308c\u7269\u3002\u3053\u306e\u5358\u4f4d\u3067\u30b9\u30b1\u30fc\u30eb\u3055\u305b\u305f\u308a\u3057\u307e\u3059\u3002\n- Proxy\u30fb\u30fb\u30b3\u30f3\u30c6\u30ca\u3068\u306e\u901a\u4fe1\u3092\u7d4c\u7531\u3059\u308b\u30d7\u30ed\u30ad\u30b7\u3002\n\nAPI\u3084\u30b3\u30de\u30f3\u30c9\u30e9\u30a4\u30f3\u3067\u7ba1\u7406\u3059\u308b\u3068\u304d\u306b\u3001\u4ee5\u4e0b\u306e\u5358\u8a9e\u304c\u983b\u7e41\u306b\u51fa\u3066\u304f\u308b\u306e\u3067\u3056\u3063\u304f\u308a\u899a\u3048\u3066\u304a\u304d\u307e\u3059\u3002\n\n- Deployments [^2]\u30fb\u30fbPod\uff08\u30b3\u30f3\u30c6\u30ca\uff09\u3092\u7ba1\u7406\u3059\u308b\u3082\u306e\n- Service [^3]\u30fb\u30fbPod\uff08\u30b3\u30f3\u30c6\u30ca\uff09\u3068\u901a\u4fe1\u3092\u7dad\u6301\u3059\u308b\u305f\u3081\u306e\u30dd\u30ea\u30b7\u30fc\u306a\u3069\u3092\u5b9a\u7fa9\u3059\u308b\u3082\u306e\n\n[^2]: [Deployments - kubernetes.io](http://kubernetes.io/docs/user-guide/deployments/)\n[^3]: [Services - kubernetes.io](http://kubernetes.io/docs/user-guide/services/)\n\n\n## \u4f55\u3067\u5b66\u3076\uff1f\n\n\u4ee5\u4e0b\u306e\u30c1\u30e5\u30fc\u30c8\u30ea\u30a2\u30eb\u3092\u4f7f\u3063\u3066kubernetes\u3092\u7406\u89e3\u3057\u3066\u3044\u304d\u305f\u3044\u3068\u601d\u3044\u307e\u3059\u3002\n\n- [Redis \u3068 PHP \u3092\u4f7f\u7528\u3057\u305f\u30b2\u30b9\u30c8\u30d6\u30c3\u30af\u306e\u4f5c\u6210][Tutorial]\n\n[Tutorial]:https://cloud.google.com/container-engine/docs/tutorials/guestbook)\n\n\u30c1\u30e5\u30fc\u30c8\u30ea\u30a2\u30eb\u306b\u8a18\u8f09\u3057\u3066\u3042\u308b\u60c5\u5831\u304c\u53e4\u3044(ReplicptionController\u306e\u4f5c\u6210\u304b\u3089Deployment\u306e\u4f5c\u6210\u306b\u5909\u308f\u3063\u3066\u3044\u308b)\u306e\u3067\u4ee5\u4e0b\u3082\u53c2\u8003\u306b\u3057\u306a\u304c\u3089\u9032\u3081\u307e\u3059\u3002\n\n- [Guestbook Example](https://github.com/kubernetes/kubernetes/blob/release-1.2/examples/guestbook/README.md)\n\n\n\u3053\u3093\u306a\u5f62\u306a\u3082\u306e\u3092\u4f5c\u308a\u307e\u3059\u3002\n\n```\n                +--------------+\n                | LoadBalancer |\n                +--------------+\n                       |\n                +--------------+\n                |   frontend   |\n                +--------------+\n                   |        |\n        +--------------+ +--------------+\n        | redis-master | | redis-slave  |\n        +--------------+ +--------------+\n```\n\n## \u30b3\u30de\u30f3\u30c9\u74b0\u5883\u306e\u6e96\u5099\n`gcloud` \u30b3\u30de\u30f3\u30c9\u3068 `kubectl` \u30b3\u30de\u30f3\u30c9\u3092\u4ee5\u4e0b\u306e\u901a\u308a\u306b\u5f93\u3063\u3066\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n[Container Engine \u958b\u59cb\u65b9\u6cd5](https://cloud.google.com/container-engine/docs/before-you-begin?authuser=1#install_the_gcloud_command_line_interface)\n\n\u4f7f\u3046\u74b0\u5883\u3092\u30c7\u30d5\u30a9\u30eb\u30c8\u3067\u8a2d\u5b9a\u3057\u3066\u304a\u304f\u3002\u30b3\u30de\u30f3\u30c9\u3092\u6253\u3064\u5ea6\u306b\u6307\u5b9a\u3057\u306a\u304f\u3066\u3082\u6e08\u3080\u306e\u3067\u3002\n\n```bash\n$ gcloud config set project PROJECT_ID # \u30d7\u30ed\u30b8\u30a7\u30af\u30c8ID\u306e\u6307\u5b9a\n\n$ gcloud config set compute/zone asia-northeast1-a # \u30be\u30fc\u30f3\u306e\u6307\u5b9a\n\n$ gcloud config list # \u73fe\u5728\u306e\u8a2d\u5b9a\u3092\u78ba\u8a8d\nYour active configuration is: [default]\n\n[compute]\nregion = asia-northeast1\nzone = asia-northeast1-a\n[core]\naccount = EMAIL_ADDRESS\ndisable_usage_reporting = False\nproject = PROJECT_ID\n```\n\n\n## \u30af\u30e9\u30b9\u30bf\uff08\u30ce\u30fc\u30c9\uff09\u306e\u4f5c\u6210\n\u6700\u521d\u306b\u3001\u30b3\u30f3\u30c6\u30ca\u3092\u914d\u7f6e\u3059\u308b\u30af\u30e9\u30b9\u30bf\uff08\u30ce\u30fc\u30c9\uff09\u3092\u4f5c\u6210\u3057\u3066\u304a\u304d\u307e\u3059\u3002\u30c7\u30d5\u30a9\u30eb\u30c8\u30673\u30ce\u30fc\u30c9\u6570\u4f5c\u6210\u3055\u308c\u307e\u3059\u304c\u3001\u4eca\u56de\u306f\u30ce\u30fc\u30c9\u6570\u30921\u306b\u6307\u5b9a\u3057\u3066\u4f5c\u6210\u3057\u307e\u3057\u305f\u3002\n\n```bash\n$ gcloud container clusters create guestbook --num-nodes=1\nCreating cluster guestbook...done.                                                 \nCreated [https://container.googleapis.com/v1/projects/{PROJECT_ID}/zones/asia-northeast1-a/clusters/guestbook].\nkubeconfig entry generated for guestbook.\nNAME       ZONE               MASTER_VERSION  MASTER_IP        MACHINE_TYPE   NODE_VERSION  NUM_NODES  STATUS\nguestbook  asia-northeast1-a  1.4.7           104.198.127.169  n1-standard-1  1.4.7         1          RUNNING\n```\n\n\u65e2\u306bKubernetes\u3082\u8d77\u52d5\u3057\u3066\u3044\u308b\u306e\u3067\u3001\u4ee5\u4e0b\u306e\u30b3\u30de\u30f3\u30c9\u3067\u30ed\u30fc\u30ab\u30eb\u30d7\u30ed\u30ad\u30b7\u3092\u8d77\u52d5\u3055\u305b\u3066\u307f\u307e\u3059\u3002\n\n\n```bash\n$ kubectl proxy\nStarting to serve on 127.0.0.1:8001\n```\n\nhttp://localhost:8001/ui/ \u3078\u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3068Kubernetes\u306e\u753b\u9762\u304c\u73fe\u308c\u307e\u3059\u3002\u898b\u305f\u76ee\u304c\u30a4\u30b1\u3066\u307e\u3059\u306d\u3002 :heart_eyes:\n\n\n![image](https://qiita-image-store.s3.amazonaws.com/0/142397/0733ca35-fff9-cc22-aa67-ccb41372dc94.png)\n\n\n## Redis\u30de\u30b9\u30bf\u30fc\u306e\u4f5c\u6210\nDeployment\uff08Pod\u3068\u30b3\u30f3\u30c6\u30ca\uff09\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n- redis-master-deployment.yaml \u30d5\u30a1\u30a4\u30eb\n\n```yaml:redis-master-deployment.yaml \napiVersion: extensions/v1beta1\nkind: Deployment\nmetadata:\n  name: redis-master # \u540d\u524d\u306e\u6307\u5b9a\uff08\u5fc5\u9808\uff09\nspec:\n  replicas: 1 # \u30b3\u30f3\u30c6\u30ca\u306e\u30ec\u30d7\u30ea\u30ab\u6570\u306e\u8a2d\u5b9a\n  template:\n    metadata:\n      labels: # \u30e9\u30d9\u30eb\u3092KV\u578b\u3067\u8a2d\u5b9a\n        app: redis\n        role: master\n        tier: backend\n    spec:\n      containers:\n      - name: master # \u30b3\u30f3\u30c6\u30ca\u306e\u540d\u524d\n        image: gcr.io/google_containers/redis:e2e # \u30b3\u30f3\u30c6\u30ca\u30a4\u30e1\u30fc\u30b8\u306e\u6307\u5b9a\uff08\u5fc5\u9808\uff09\n        resources:\n          requests:\n            cpu: 100m # CPU\u30920.1\u30b3\u30a2\u78ba\u4fdd\n            memory: 100Mi # \u30e1\u30e2\u30ea100MiB\u78ba\u4fdd\n        ports:\n        - containerPort: 6379 # \u30b3\u30f3\u30c6\u30ca\u30dd\u30fc\u30c8\u306e\u6307\u5b9a\n```\n\n- `kube create`\u3067\u3053\u306e\u30d5\u30a1\u30a4\u30eb\u3092\u8aad\u307e\u305b\u308b\u3068yaml\u306b\u8a18\u8f09\u3057\u305f\u3068\u304a\u308a\u306e\u30b3\u30f3\u30c6\u30ca\u3092\u4f5c\u6210\u3057\u3066\u304f\u308c\u307e\u3059\u3002\n\n```bash\n$ kubectl create -f redis-master-deployment.yaml\ndeployment \"redis-master\" created\n\n- Deployment\u4e00\u89a7\u3092\u8868\u793a\u3059\u308b\n\n```bash\n$ kubectl get deployment\nNAME           DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE\nredis-master   1         1         1            1           2m\n```\n\n- Pod\u4e00\u89a7\u3092\u8868\u793a\u3059\u308b\n\n```bash\n$ kubectl get pod\nNAME                           READY     STATUS    RESTARTS   AGE\nredis-master-343230949-6dmjd   1/1       Running   0          2m\n```\n\nRedis\u306e\u30b3\u30f3\u30c6\u30ca\u304c\u51fa\u6765\u307e\u3057\u305f :tada: \n\n### \u5bc4\u308a\u9053\uff08kubectl run \u30b3\u30de\u30f3\u30c9\uff09\nyaml\u3092\u4f5c\u6210\u3057\u306a\u304f\u3066\u3082\u3001`kubectl run`\u30b3\u30de\u30f3\u30c9\u3067\u540c\u3058\u304f\u4f5c\u6210\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\n- `kubeclt run` \u30b3\u30de\u30f3\u30c9\n\n```bash\n$ kubectl run redis-master \\\n> --image=gcr.io/google_containers/redis:e2e \\\n> --labels=\"app=redis,role=master,tier=backend\" \\\n> --requests=\"cpu=100m,memory=100Mi\" \\\n> --port=6379\ndeployment \"redis-master-run\" created\n```\n\n\u5b9f\u306f\u3001\u3053\u308c\u3060\u3068\u30b3\u30f3\u30c6\u30ca\u540d(\u5b9f\u969b\u306e\u30b3\u30f3\u30c6\u30ca\u540d\u3067\u306f\u306a\u3044)\u304c`redis-master`\uff08\u30c7\u30d5\u30a9\u30eb\u30c8\u3067Pod\u540d\uff09\u306b\u306a\u3063\u3066\u3057\u307e\u3044\u3001\u5b8c\u5168\u306b\u540c\u4e00\u3067\u306f\u3042\u308a\u307e\u305b\u3093\u3002\u30b3\u30f3\u30c6\u30ca\u540d\u3092\u8a2d\u5b9a\u3059\u308b\u30b3\u30de\u30f3\u30c9\u5f15\u6570[^4]\u304c\u898b\u3064\u304b\u3089\u306a\u304b\u3063\u305f\u306e\u3067\u3001`--overrides`\u30aa\u30d7\u30b7\u30e7\u30f3\u3067\u7121\u7406\u3084\u308a\u8a2d\u5b9a\u3057\u3066\u307f\u307e\u3057\u305f\u3002\n\n[^4]: [kube run \u30b3\u30de\u30f3\u30c9\u30ea\u30d5\u30a1\u30ec\u30f3\u30b9](http://kubernetes.io/docs/user-guide/kubectl/kubectl_run/)\n\n- `--overrides`\u30aa\u30d7\u30b7\u30e7\u30f3\u3092\u3064\u3051\u3066`kubectl run`\n\n```bash\n$ kubectl run redis-master \\\n> --image=gcr.io/google_containers/redis:e2e \\\n> --labels=\"app=redis,role=master,tier=backend\" \\\n> --overrides='{\"spec\":{\"template\":{\"spec\":{\"containers\":[{\"name\":\"master\",\"image\":\"gcr.io/google_containers/redis:e2e\",\"resources\":{\"requests\":{\"cpu\":\"100m\",\"memory\":\"100Mi\"}},\"ports\":[{\"containerPort\":6379}]}]}}}}'\ndeployment \"redis-master\" created\n```\n\n\u203b `--image`\u30aa\u30d7\u30b7\u30e7\u30f3\u306f\u5fc5\u9808\u306a\u305f\u3081\u3001`--overrides`\u5185\u3068\u30b3\u30f3\u30c6\u30ca\u30a4\u30e1\u30fc\u30b8\u306e\u30ed\u30b1\u30fc\u30b7\u30e7\u30f3\u3092\u4e8c\u91cd\u3067\u8a18\u8f09\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\u3002 :sweat_smile: \u6b86\u3069\u306e\u90e8\u5206\u3092yaml\u304b\u3089json\u306b\u5909\u63db\u3057\u3066\u308b\u611f\u3058\u3067\u3061\u3087\u3063\u3068\u7121\u610f\u5473\u611f\u3002\u3002\n\n\u5ff5\u306e\u305f\u3081 `kube describe pod <POD_NAME>`\u306e\u5185\u5bb9\u3092\u6bd4\u8f03\u3057\u3066\u307f\u307e\u3059\u3002\n\n```diff:describe\u3057\u305f\u5185\u5bb9\u3092\u6bd4\u8f03\n$ diff -u redis-master.describe redis-master_run.describe \n--- redis-master.describe 2016-12-29 23:38:58.000000000 +0900\n+++ redis-master_run.describe 2016-12-29 23:41:49.000000000 +0900\n@@ -1,17 +1,17 @@\n-Name:    redis-master-343230949-6dmjd\n+Name:    redis-master-343230949-n0sxq\n Namespace: default\n Node:    gke-guestbook-default-pool-af5eb675-xszz/10.146.0.2\n-Start Time:  Thu, 29 Dec 2016 22:37:55 +0900\n+Start Time:  Thu, 29 Dec 2016 23:40:41 +0900\n Labels:    app=redis\n    pod-template-hash=343230949\n    role=master\n    tier=backend\n Status:    Running\n-IP:    10.52.0.11\n+IP:    10.52.0.15\n Controllers: ReplicaSet/redis-master-343230949\n Containers:\n   master:\n-    Container ID:  docker://2f57187ee653673df16d40532528086475aadbff9994540541147285600de612\n+    Container ID:  docker://49226c07f4a0ab49503cc46eea01c9382ffe3b62d9d27170ccd8b21f04500365\n     Image:   gcr.io/google_containers/redis:e2e\n     Image ID:    docker://sha256:e5e67996c442f903cda78dd983ea6e94bb4e542950fd2eba666b44cbd303df42\n     Port:    6379/TCP\n@@ -19,7 +19,7 @@\n       cpu:   100m\n       memory:    100Mi\n     State:   Running\n-      Started:   Thu, 29 Dec 2016 22:38:24 +0900\n+      Started:   Thu, 29 Dec 2016 23:40:42 +0900\n     Ready:   True\n     Restart Count: 0\n     Volume Mounts:\n```\n\nIP\u30a2\u30c9\u30ec\u30b9\u3084\u65e5\u4ed8\u4ee5\u5916\u3067\u5909\u66f4\u70b9\u306f\u306a\u3044\u306e\u3067\u3001\u540c\u4e00\u306a\u8a2d\u5b9a\u3067\u4f5c\u6210\u3067\u304d\u3066\u3044\u308b\u3053\u3068\u304c\u5206\u304b\u308a\u307e\u3059 :tada: \n\n\n\n### \u5bc4\u308a\u9053\uff08Deployment\uff09\n\nDeployment\u306f\u6bd4\u8f03\u7684\u65b0\u3057\u304f\u3001Pod\u306e\u4f5c\u6210\u3084\u30ed\u30fc\u30ea\u30f3\u30b0\u30a2\u30c3\u30d7\u30c7\u30fc\u30c8\u3084\u30ed\u30fc\u30eb\u30d0\u30c3\u30af\u306a\u3069\u3092\u7c21\u5358\u306b\u3057\u3066\u304f\u308c\u308b\u3082\u306e\u3067\u3059\u3002\n[Using Deployment objects with Kubernetes 1.2](http://blog.kubernetes.io/2016/04/using-deployment-objects-with.html)\n\n\u305d\u308c\u307e\u3067\u306f Replication Controller[^5]\u304c\u305d\u306e\u8fba\u308a\u306e\u5f79\u5272\u3092\u62c5\u3063\u3066\u3044\u305f\u3053\u3068\u3082\u3042\u308a\u3001[Tutorial][]\u3067\u306fReplication Controller \u3067 Pod \u3092\u4f5c\u6210\u3057\u3066\u8aac\u660e\u3057\u3066\u3044\u307e\u3059\u3002\u4eca\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\uff081.4.7\uff09\u3067\u306f\u3001Deployments\u3067Pod\u3092\u4f5c\u6210\u3059\u308b\u3068\u3001Replication Controller \u306e\u6b21\u4e16\u4ee3\u7248\u3067\u3042\u308b `Replica Sets`[^6] \u304c\u52d5\u304d\u51fa\u3057\u307e\u3059\u3002Replication Controller \u306f\u7121\u304f\u306a\u3063\u3066\u3057\u307e\u3046\u306e\u304b\u306a\u3041\u3002\u3002\n\n[^5]: [Replication Controller - kubernetes.io](http://kubernetes.io/docs/user-guide/replication-controller/)\n[^6]: [Replica Sets - kubernetes.io](http://kubernetes.io/docs/user-guide/replicasets/)\n\n\n\u3061\u306a\u307f\u306b\u3001Kubernetes\u306e\u7ba1\u7406UI\u3067\u306f\u672a\u3060 Replication Controller \u304c\u30e1\u30a4\u30f3\u306b\u306a\u3063\u3066\u3044\u308b\u69d8\u3067\u3001UI\u304b\u3089Pod\u3092\u4f5c\u6210\u3059\u308b\u3068 Replication Controller \u304c\u4f5c\u6210\u3055\u308c\u307e\u3059\u3002\n\u8a66\u3057\u3066\u307f\u307e\u3059\u3002\n\n- \u30b3\u30de\u30f3\u30c9\u30e9\u30a4\u30f3\u304b\u3089\u30b3\u30f3\u30c6\u30ca\uff08Pod\uff09\u3092\u4f5c\u6210\n\n```bash\n$ kubectl run cli --image=gcr.io/google-samples/gb-frontend:v4\ndeployment \"cli\" created\n```\n\n\u301c \u3053\u3053\u3067\u3001Kubernetes\u306eUI\u304b\u3089`ui`\u3068\u3044\u3046\u540d\u524d\u3067\u30b3\u30f3\u30c6\u30ca\u3092\u4f5c\u6210 \u301c\n\n- 2\u3064\u306ePod\u304c\u4f5c\u6210\u3055\u308c\u3066\u3044\u307e\u3059\n\n```bash\n$ kubectl get pod\nNAME                   READY     STATUS    RESTARTS   AGE\ncli-2068554765-12stb   1/1       Running   0          1m\nui-sbpaz               1/1       Running   0          22s\n```\n\n- UI\u304b\u3089\u4f5c\u6210\u3057\u305f\u30b3\u30f3\u30c6\u30ca\u306f Replication Controller \u306b\u306a\u3063\u3066\u3044\u307e\u3059\n\n```bash\n$ kubectl get replicationcontroller\nNAME      DESIRED   CURRENT   READY     AGE\nui        1         1         1         45s\n```\n\n- \u30b3\u30de\u30f3\u30c9\u30e9\u30a4\u30f3\u304b\u3089\u306fDeployment\u306b\u306a\u3063\u3066\u3044\u307e\u3059\n\n```bash\n$ kubectl get deployment\nNAME      DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE\ncli       1         1         1            1           1m\n```\n\nyaml\u306e\u8a2d\u5b9a\u81ea\u4f53\u306f\u6b86\u3069\u5909\u308f\u308a\u307e\u305b\u3093\u3002\u5f37\u3044\u3066\u6319\u3052\u308b\u3068\u3001metadata\u306e\u7b87\u6240\u3067labels\u3092\u7701\u7565\u3057\u3066\u3044\u308b\u6240\u3050\u3089\u3044\u3067\u3059\u3002\n\n```diff:Tutorial\u306b\u3042\u308bRC\u7528\u3068Deployment\u7528yaml\u306e\u6bd4\u8f03\n--- legacy/redis-master-controller.yaml 2016-12-28 01:18:16.000000000 +0900\n+++ redis-master-deployment.yaml  2016-12-28 01:43:37.000000000 +0900\n@@ -1,13 +1,13 @@\n-apiVersion: v1\n-kind: ReplicationController\n+apiVersion: extensions/v1beta1\n+kind: Deployment\n metadata:\n   name: redis-master\n   # these labels can be applied automatically \n   # from the labels in the pod template if not set\n-  labels:\n-    app: redis\n-    role: master\n-    tier: backend\n+  # labels:\n+  #   app: redis\n+  #   role: master\n+  #   tier: backend\n spec:\n   # this replicas value is default\n   # modify it according to your case\n@@ -15,9 +15,10 @@\n   # selector can be applied automatically \n   # from the labels in the pod template if not set\n   # selector:\n-  #   app: guestbook\n-  #   role: master\n-  #   tier: backend\n+  #   matchLabels:\n+  #     app: guestbook\n+  #     role: master\n+  #     tier: backend\n   template:\n     metadata:\n       labels:\n```\n\n### \u5bc4\u308a\u9053\uff08\u30ce\u30fc\u30c9\u306bSSH\u30ed\u30b0\u30a4\u30f3\uff09\n\n\u30ce\u30fc\u30c9\u306bSSH\u30ed\u30b0\u30a4\u30f3\u3059\u308b\u3053\u3068\u3082\u3067\u304d\u307e\u3059\u3002\n\n- `-o wide`\u3067Pod\u304c\u914d\u7f6e\u3055\u308c\u3066\u3044\u308b\u30ce\u30fc\u30c9ID\u3092\u8868\u793a\u3055\u305b\u307e\u3059\u3002\n\n```bash\n$ kubectl get pod -o wide\nNAME                           READY     STATUS    RESTARTS   AGE       IP           NODE\nredis-master-343230949-n0sxq   1/1       Running   0          11m       10.52.0.15   gke-guestbook-default-pool-af5eb675-xszz\n```\n\n- \u4e0a\u8a18\u30ce\u30fc\u30c9\u3092\u6307\u5b9a\u3057\u3066SSH\u30ed\u30b0\u30a4\u30f3\u3057\u307e\u3059\u3002\n\n```bash\n$ gcloud compute ssh gke-guestbook-default-pool-af5eb675-xszz\nWarning: Permanently added 'compute.7579721538501918346' (RSA) to the list of known hosts.\n\nWelcome to Kubernetes v1.4.7!\n\nYou can find documentation for Kubernetes at:\n  http://docs.kubernetes.io/\n\nThe source for this release can be found at:\n  /home/kubernetes/kubernetes-src.tar.gz\nOr you can download it at:\n  https://storage.googleapis.com/kubernetes-release/release/v1.4.7/kubernetes-src.tar.gz\n\nIt is based on the Kubernetes source at:\n  https://github.com/kubernetes/kubernetes/tree/v1.4.7\n\nFor Kubernetes copyright and licensing information, see:\n  /home/kubernetes/LICENSES\nuser@gke-guestbook-default-pool-af5eb675-xszz ~ $\n```\n\n- \u30ed\u30b0\u30a4\u30f3\u51fa\u6765\u305f\u306e\u3067\"docker ps\"\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3057\u3066\u307f\u307e\u3059\u3002kubernetes\u95a2\u9023\u306e\u30b3\u30f3\u30c6\u30ca\u304c\u6ca2\u5c71\u52d5\u3044\u3066\u307e\u3059\u306d\u3002\n\n```bash\nuser@gke-guestbook-default-pool-af5eb675-xszz ~ $ docker ps\nCONTAINER ID        IMAGE                                                                  COMMAND                  CREATED             STATUS              PORTS               NAMES\n49226c07f4a0        gcr.io/google_containers/redis:e2e                                     \"redis-server /etc/re\"   12 minutes ago      Up 12 minutes                           k8s_master.b505b5b1_redis-master-343230949-n0sxq_default_c5e1c119-cdd4-11e6-9059-42010a920020_d5ed9c19\nf2e1a93483ef        gcr.io/google_containers/pause-amd64:3.0                               \"/pause\"                 12 minutes ago      Up 12 minutes                           k8s_POD.d8dbe16c_redis-master-343230949-n0sxq_default_c5e1c119-cdd4-11e6-9059-42010a920020_594d5d61\ned54277b3108        asia.gcr.io/google_containers/addon-resizer:1.6                        \"/pod_nanny --cpu=80m\"   2 hours ago         Up 2 hours                              k8s_heapster-nanny.55df2c69_heapster-v1.2.0-1847815531-zrkw6_kube-system_378ff7ba-cdc2-11e6-9059-42010a920020_84f3de55\n22a3bf8a8816        asia.gcr.io/google_containers/heapster:v1.2.0                          \"/heapster --source=k\"   2 hours ago         Up 2 hours                              k8s_heapster.d8c9b305_heapster-v1.2.0-1847815531-zrkw6_kube-system_378ff7ba-cdc2-11e6-9059-42010a920020_b3e26ab1\nb4bb94588700        gcr.io/google_containers/pause-amd64:3.0                               \"/pause\"                 2 hours ago         Up 2 hours                              k8s_POD.d8dbe16c_heapster-v1.2.0-1847815531-zrkw6_kube-system_378ff7ba-cdc2-11e6-9059-42010a920020_f00e16d7\n262de7613d9e        asia.gcr.io/google_containers/exechealthz-amd64:1.2                    \"/exechealthz '--cmd=\"   2 hours ago         Up 2 hours                              k8s_healthz.aaa6418e_kube-dns-v20-8uddr_kube-system_25491b5f-cdc2-11e6-9059-42010a920020_19442f61\n218ef4491c93        asia.gcr.io/google_containers/kube-dnsmasq-amd64:1.4                   \"/usr/sbin/dnsmasq --\"   2 hours ago         Up 2 hours                              k8s_dnsmasq.daf813d2_kube-dns-v20-8uddr_kube-system_25491b5f-cdc2-11e6-9059-42010a920020_da4ffbd1\n02b6c5abe863        asia.gcr.io/google_containers/kubedns-amd64:1.8                        \"/kube-dns --domain=c\"   2 hours ago         Up 2 hours                              k8s_kubedns.dc925936_kube-dns-v20-8uddr_kube-system_25491b5f-cdc2-11e6-9059-42010a920020_226b6b62\n9fc09d1f352d        asia.gcr.io/google_containers/defaultbackend:1.0                       \"/server\"                2 hours ago         Up 2 hours                              k8s_default-http-backend.8208ca2c_l7-default-backend-v1.0-shaxn_kube-system_251d5635-cdc2-11e6-9059-42010a920020_22aef95d\n61d5ea514139        asia.gcr.io/google_containers/kubernetes-dashboard-amd64:v1.4.0        \"/dashboard --port=90\"   2 hours ago         Up 2 hours                              k8s_kubernetes-dashboard.44adcd81_kubernetes-dashboard-v1.4.0-ev5z4_kube-system_2538ca75-cdc2-11e6-9059-42010a920020_3c45962e\nddc295bd5b86        asia.gcr.io/google_containers/fluentd-gcp:1.21                         \"/bin/sh -c 'rm /lib/\"   2 hours ago         Up 2 hours                              k8s_fluentd-cloud-logging.9d1761e_fluentd-cloud-logging-gke-guestbook-default-pool-af5eb675-xszz_kube-system_9d40f2ab7a284a2e847ba6ea821d674b_08346356\nb5a7f7a969fe        gcr.io/google_containers/pause-amd64:3.0                               \"/pause\"                 2 hours ago         Up 2 hours                              k8s_POD.d8dbe16c_kube-dns-v20-8uddr_kube-system_25491b5f-cdc2-11e6-9059-42010a920020_cfddc70c\n2625088adb2d        gcr.io/google_containers/pause-amd64:3.0                               \"/pause\"                 2 hours ago         Up 2 hours                              k8s_POD.d8dbe16c_l7-default-backend-v1.0-shaxn_kube-system_251d5635-cdc2-11e6-9059-42010a920020_2eb5e129\n6904e351db39        gcr.io/google_containers/pause-amd64:3.0                               \"/pause\"                 2 hours ago         Up 2 hours                              k8s_POD.d8dbe16c_kubernetes-dashboard-v1.4.0-ev5z4_kube-system_2538ca75-cdc2-11e6-9059-42010a920020_536e1b7b\n7672d253bc84        gcr.io/google_containers/pause-amd64:3.0                               \"/pause\"                 2 hours ago         Up 2 hours                              k8s_POD.d8dbe16c_fluentd-cloud-logging-gke-guestbook-default-pool-af5eb675-xszz_kube-system_9d40f2ab7a284a2e847ba6ea821d674b_85d10a63\n16bdffccc672        gcr.io/google_containers/kube-proxy:31be43b1cb619b7b0ab8fe01f997fe2f   \"/bin/sh -c 'kube-pro\"   2 hours ago         Up 2 hours                              k8s_kube-proxy.3ea31aa7_kube-proxy-gke-guestbook-default-pool-af5eb675-xszz_kube-system_0a4a2e1c974bec66debcc5815d60085a_0833b062\n9cacc1697cf5        gcr.io/google_containers/pause-amd64:3.0                               \"/pause\"                 2 hours ago         Up 2 hours                              k8s_POD.d8dbe16c_kube-proxy-gke-guestbook-default-pool-af5eb675-xszz_kube-system_0a4a2e1c974bec66debcc5815d60085a_20190c5a\n```\n\n### \u5bc4\u308a\u9053\uff08SSH\u30ed\u30b0\u30a4\u30f3\u30e6\u30fc\u30b6\u30fc\uff09\nSSH\u30ed\u30b0\u30a4\u30f3\u306e\u66f8\u5f0f\u306f\u3001`gcloud compute ssh  [USER@]INSTANCE` \u3067USER\u3092\u3064\u3051\u306a\u3044\u3068\u30ed\u30fc\u30ab\u30eb\u74b0\u5883\u306e\u30e6\u30fc\u30b6\u30fc\u540d\u3067\u63a5\u7d9a\u3057\u307e\u3059\uff08\u901a\u5e38\u306eSSH\u3068\u540c\u69d8\u306a\u52d5\u304d\uff09\u3002\u30e6\u30fc\u30b6\u30fc\u306f\u81ea\u52d5\u7684\u306b\u4f5c\u6210\u3055\u308cGCE\u5074\u3078\u767b\u9332\u3055\u308c\u307e\u3059\u3002\n\u767b\u9332\u3055\u308c\u3066\u3044\u308b\u30e6\u30fc\u30b6\u30fc\u3068SSH\u516c\u958b\u9375\u306f\u4ee5\u4e0b\u3067\u78ba\u8a8d\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\nhttps://console.cloud.google.com/compute/metadata/sshKeys\n\n\n## Redis \u30de\u30b9\u30bf\u30fc\u306e\u30b5\u30fc\u30d3\u30b9\u306e\u4f5c\u6210\n\n\u30b3\u30f3\u30c6\u30ca\u3068\u901a\u4fe1\u3055\u305b\u308b\u305f\u3081\u306eService\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n- redis-master-service.yaml \u30d5\u30a1\u30a4\u30eb\n\n```yaml:redis-master-service.yaml \napiVersion: v1\nkind: Service\nmetadata:\n  name: redis-master\n  labels:\n    app: redis\n    role: master\n    tier: backend\nspec:\n  ports:\n  - port: 6379\n    targetPort: 6379\n  selector:\n    app: redis\n    role: master\n    tier: backend\n```\n\n- yaml\u30d5\u30a1\u30a4\u30eb\u3092\u8aad\u307f\u8fbc\u3093\u3067\u30b5\u30fc\u30d3\u30b9\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n```bash\n$ kubectl create -f redis-master-service.yaml\nservice \"redis-master\" created\n```\n\n- \u30b5\u30fc\u30d3\u30b9\u306e\u60c5\u5831\u3092\u8868\u793a\u3057\u307e\u3059\u3002\n\n```bash\n$ kubectl get service redis-master\nNAME           CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE\nredis-master   10.55.246.114   <none>        6379/TCP   43s\n```\n\n- \u3082\u3061\u308d\u3093\u3001\u30b3\u30de\u30f3\u30c9\u30e9\u30a4\u30f3\u3067\u30b5\u30fc\u30d3\u30b9\u3092\u4f5c\u6210\u3059\u308b\u3053\u3068\u3082\u3067\u304d\u307e\u3059\u3002\n\n```bash\n$ kubectl expose service redis-master \\\n> --labels=\"app=redis,role=master,tier=backend\" \\\n> --selector=\"app=redis,role=master,tier=backend\" \\\n> --port=6379 \\\n> --target-port=6379\n```\n\n## Redis \u30b9\u30ec\u30fc\u30d6\u306e\u30b3\u30f3\u30c6\u30ca\u3068\u30b5\u30fc\u30d3\u30b9\u4f5c\u6210\n\nRedis\u30de\u30b9\u30bf\u30fc\u3068\u540c\u69d8\u306b\u30b3\u30f3\u30c6\u30ca\u3068\u30b5\u30fc\u30d3\u30b9\u3092\u4f5c\u6210\u3057\u3066\u3044\u304d\u307e\u3059\u3002\n\n- redis-slave-deployment.yaml \u30d5\u30a1\u30a4\u30eb\n\n```yaml:redis-slave-deployment.yaml \napiVersion: extensions/v1beta1\nkind: Deployment\nmetadata:\n  name: redis-slave\nspec:\n  replicas: 2 # \u30ec\u30d7\u30ea\u30ab\u6570\u30922\u306b\u6307\u5b9a\n  template:\n    metadata:\n      labels:\n        app: redis\n        role: slave\n        tier: backend\n    spec:\n      containers:\n      - name: slave\n        image: gcr.io/google_samples/gb-redisslave:v1\n        resources:\n          requests:\n            cpu: 100m\n            memory: 100Mi\n        env:\n        - name: GET_HOSTS_FROM # \u74b0\u5883\u5909\u6570\u3092\u30bb\u30c3\u30c8\u3057\u3066\u3044\u307e\u3059\u3002PHP\u306e\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3067\u4f7f\u3044\u307e\u3059\u3002\n          value: dns\n        ports:\n        - containerPort: 6379\n```\n\n- \u30b3\u30f3\u30c6\u30ca\u3092\u4f5c\u6210\u3057\u3066Pod\u6570\u304c2\u306b\u306a\u3063\u3066\u3044\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n```bash\n$ kubectl create -f redis-slave-deployment.yaml \ndeployment \"redis-slave\" created\n\n$ kubectl get deployment redis-slave\nNAME          DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE\nredis-slave   2         2         2            0           24s # 2\u306b\u306a\u3063\u3066\u3044\u308b\n\n$ kubectl get pod \nNAME                           READY     STATUS    RESTARTS   AGE\nredis-master-343230949-08kqi   1/1       Running   0          7m\nredis-slave-132015689-3x3qp    1/1       Running   0          48s # 1Pod\u76ee\nredis-slave-132015689-b6cha    1/1       Running   0          48s # 2Pod\u76ee\n```\n\nredis-slave\u306ePod\u304c2\u3064\u3042\u308b\u306e\u304c\u5206\u304b\u308a\u307e\u3059\u3002\u6b21\u306b\u30b5\u30fc\u30d3\u30b9\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n- redis-slave-service.yaml \u30d5\u30a1\u30a4\u30eb\n\n```yaml:redis-slave-service.yaml \napiVersion: v1\nkind: Service\nmetadata:\n  name: redis-slave\n  labels:\n    app: redis\n    role: slave\n    tier: backend\nspec:\n  ports:\n  - port: 6379\n  selector:\n    app: redis\n    role: slave\n    tier: backend\n```\n\n- redis-slave\u306e\u30b5\u30fc\u30d3\u30b9\u3092\u4f5c\u6210\u3057\u3066\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n```bash\n$ kubectl create -f redis-slave-service.yaml\nservice \"redis-slave\" created\n\n$ kubectl get svc redis-slave # services\u3092\"svc\"\u3068\u7701\u7565\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\nNAME          CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE\nredis-slave   10.55.255.111   <none>        6379/TCP   18s\n```\n\n## \u30d5\u30ed\u30f3\u30c8\u30a8\u30f3\u30c9 \u30a6\u30a7\u30d6\u30b5\u30fc\u30d0\u30fc\u306e\u4f5c\u6210\n\n\u30d0\u30c3\u30af\u30a8\u30f3\u30c9\u5074\uff08redis\uff09\u306f\u4f5c\u6210\u3057\u305f\u306e\u3067\u3001\u6b21\u304b\u3089\u30d5\u30ed\u30f3\u30c8\u30a8\u30f3\u30c9\u3092\u4f5c\u6210\u3057\u3066\u3044\u304d\u307e\u3059\u3002\n\n- front-deployment.yaml \u30d5\u30a1\u30a4\u30eb\n\n```yaml:frontend-deployment.yaml\napiVersion: extensions/v1beta1\nkind: Deployment\nmetadata:\n  name: frontend\nspec:\n  replicas: 3\n  template:\n    metadata:\n      labels:\n        app: guestbook\n        tier: frontend\n    spec:\n      containers:\n      - name: php-redis\n        image: gcr.io/google-samples/gb-frontend:v4\n        resources:\n          requests:\n            cpu: 100m\n            memory: 100Mi\n        env:\n        - name: GET_HOSTS_FROM\n          value: dns\n        ports:\n        - containerPort: 80\n```\n\n- frontend\u3092\u4f5c\u6210\u3057\u3066\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n```bash\n$ kubectl create -f frontend-deployment.yaml\ndeployment \"frontend\" created\n\n kubectl get deployment frontend\nNAME       DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE\nfrontend   3         3         3            3           1m\n\n$ kubectl get pods\nNAME                           READY     STATUS    RESTARTS   AGE\nfrontend-88237173-cp3rn        1/1       Running   0          1m\nfrontend-88237173-kxlgh        1/1       Running   0          1m\nfrontend-88237173-tw65g        1/1       Running   0          1m\nredis-master-343230949-08kqi   1/1       Running   0          29m\nredis-slave-132015689-3x3qp    1/1       Running   0          22m\nredis-slave-132015689-b6cha    1/1       Running   0          22m\n```\n\nfrontend\u7528\u306e\u30b5\u30fc\u30d3\u30b9\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002frontend\u306f\u8907\u6570\u53f0\u306e\u8ca0\u8377\u5206\u6563\u3092\u3057\u305f\u3044\u306e\u3067`type: LoadBalancer`\u3092\u6307\u5b9a\u3057\u3066\u3044\u307e\u3059\u3002\n\n- frontend-service.yaml \u30d5\u30a1\u30a4\u30eb\n\n```yaml:frontend-service.yaml \napiVersion: v1\nkind: Service\nmetadata:\n  name: frontend\n  labels:\n    app: guestbook\n    tier: frontend\nspec:\n  type: LoadBalancer\n  ports:\n  - port: 80\n  selector:\n    app: guestbook\n    tier: frontend\n```\n\n```bash\n$ kubectl create -f frontend-service.yaml \nservice \"frontend\" created\n\n$ kubectl get svc frontend\nNAME       CLUSTER-IP      EXTERNAL-IP     PORT(S)   AGE\nfrontend   10.55.254.255   104.198.125.6   80/TCP    3m\n```\n\n`type: LoadBalancer` \u3092\u6307\u5b9a\u3059\u308b\u3068\u5225\u9014GCE\u306e\u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b5\u30fc\u304c\u4f5c\u6210\u3055\u308c\u3066\u3044\u307e\u3059\u3002\u30c7\u30d5\u30a9\u30eb\u30c8\u3060\u3068\u30d8\u30eb\u30b9\u30c1\u30a7\u30c3\u30af\u306a\u3069\u306e\u8a2d\u5b9a\u304c\u3055\u308c\u3066\u306a\u3044\u306e\u3067\u5fc5\u8981\u306b\u5fdc\u3058\u3066\u5909\u66f4\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\n![image](https://qiita-image-store.s3.amazonaws.com/0/142397/dc9aa996-ced6-929f-6cf8-e66e539dc4e0.png)\n\n\n`EXTERNAL_IP`\u306b\u30d6\u30e9\u30a6\u30b6\u3067\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3068\u4ee5\u4e0b\u306e\u69d8\u306a\u753b\u9762\u304c\u307f\u308c\u307e\u3057\u305f\u3002\n\n![image](https://qiita-image-store.s3.amazonaws.com/0/142397/f85a577d-597b-cf84-08db-e4327b860f4a.png)\n\n\n## PHP\u306e\u4e2d\u8eab\n\u3053\u306e\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306fPHP\u3067\u66f8\u304b\u308c\u3066\u3044\u308b\u306e\u3067\u4f55\u3092\u3057\u3066\u308b\u304b\u78ba\u8a8d\u3057\u3066\u307f\u305f\u3044\u3068\u601d\u3044\u307e\u3059\u3002\n\n```guestbook.php\n<?php\n\nerror_reporting(E_ALL);\nini_set('display_errors', 1);\n\nrequire 'Predis/Autoloader.php';\n\nPredis\\Autoloader::register();\n\nif (isset($_GET['cmd']) === true) {\n  $host = 'redis-master';\n  if (getenv('GET_HOSTS_FROM') == 'env') {\n    $host = getenv('REDIS_MASTER_SERVICE_HOST');\n  }\n  header('Content-Type: application/json');\n  if ($_GET['cmd'] == 'set') {\n    $client = new Predis\\Client([\n      'scheme' => 'tcp',\n      'host'   => $host,\n      'port'   => 6379,\n    ]);\n\n    $client->set($_GET['key'], $_GET['value']);\n    print('{\"message\": \"Updated\"}');\n  } else {\n    $host = 'redis-slave';\n    if (getenv('GET_HOSTS_FROM') == 'env') {\n      $host = getenv('REDIS_SLAVE_SERVICE_HOST');\n    }\n    $client = new Predis\\Client([\n      'scheme' => 'tcp',\n      'host'   => $host,\n      'port'   => 6379,\n    ]);\n\n    $value = $client->get($_GET['key']);\n    print('{\"data\": \"' . $value . '\"}');\n  }\n} else {\n  phpinfo();\n} ?>\n```\n\n\u66f8\u304d\u8fbc\u307f\u306a\u3089Redis\u306e\u30de\u30b9\u30bf\u30fc\u3078\u63a5\u7d9a\u3057\u3001\u8aad\u307f\u8fbc\u307f\u306a\u3089Redis\u306e\u30b9\u30ec\u30fc\u30d6\u3078\u63a5\u7d9a\u3059\u308b\u5236\u5fa1\u3092\u3057\u3066\u3044\u307e\u3059\u3002\nRedis\u306e\u30de\u30b9\u30bf\u30fc\u306e\u30db\u30b9\u30c8\u540d\u306f`redis-master`\u3067\u3001\u30b9\u30ec\u30fc\u30d6\u306f`redis-slave`\u3067\u63a5\u7d9a\u3057\u3066\u3044\u307e\u3059\u3002Redis\b\u306eDeployment\u3092\u4f5c\u6210\u3057\u305f\u3068\u304d\u306b\u6307\u5b9a\u3057\u305f`name`\u304c\u30b3\u30f3\u30c6\u30ca\u306eDNS\u7a7a\u9593\u306b\u53cd\u6620\u3055\u308c\u3066\u3044\u308b\u3068\u3044\u3046\u3053\u3068\u3067\u3059\u306d\u3002\n\n\u9006\u306bDNS\u3092\u4f7f\u308f\u306a\u3044\u5834\u5408\u3082\u3042\u308b\u306e\u3067\u3001\u305d\u306e\u5224\u5225`if (getenv('GET_HOSTS_FROM') == 'env') {`\u3092\u5165\u308c\u3066\u74b0\u5883\u5909\u6570\u3092\u4f7f\u3046\u4e8b\u3082\u51fa\u6765\u308b\u3088\u3046\u306b\u3057\u3066\u3044\u307e\u3059\u3002\n\nfrontend-deployment.yaml\u3067\u4ee5\u4e0b\u306e\u8a2d\u5b9a\u304c\u3055\u308c\u3066\u3044\u308b\u306e\u3067\u3001\u3053\u306ePHP\u3067\u306fDNS\u540d\u3092\u4f7f\u3063\u3066\u3044\u307e\u3059\u3002\n\n```yaml:frontend-deployment.yaml\n...\n        env:\n        - name: GET_HOSTS_FROM\n          value: dns            # env\u306b\u3059\u308b\u3068PHP\u304c\u74b0\u5883\u5909\u6570\u3092\u4f7f\u3046\u3088\u3046\u306b\u306a\u308b\n...\n```\n\n\n\n## \u30ec\u30d7\u30ea\u30ab\u6570\u3092\u5909\u66f4\u3057\u3066\u307f\u308b\n\u7c21\u5358\u306b\u9014\u4e2d\u3067\u30ec\u30d7\u30ea\u30ab\u6570\u3092\u5909\u66f4\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\n- \u30ec\u30d7\u30ea\u30ab\u6570\u30925\u3078\u5909\u66f4\u3059\u308b\n\n```bash\n$ kubectl scale deployment frontend --replicas=5\ndeployment \"frontend\" scaled\n```\n\n- 5\u306b\u306a\u3063\u3066\u3044\u308b\u3053\u3068\u304c\u5206\u304b\u308a\u307e\u3059\u3002\n\n```bash\n$ kubectl get deployment frontend\nNAME       DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE\nfrontend   5         5         5            5           51m\n```\n\n- Pod\u3092\u898b\u308b\u3068\u5897\u3048\u3066\u3044\u308b\u306e\u304c\u5206\u304b\u308a\u307e\u3059\n\n```bash\n$ kubectl get pods\nNAME                           READY     STATUS    RESTARTS   AGE\nfrontend-88237173-cp3rn        1/1       Running   0          26m\nfrontend-88237173-kuyzx        1/1       Running   0          6s   # \u5897\u3048\u305fPod\nfrontend-88237173-kxlgh        1/1       Running   0          26m\nfrontend-88237173-sljba        1/1       Running   0          6s   # \u5897\u3048\u305fPod\nfrontend-88237173-tw65g        1/1       Running   0          26m\nredis-master-343230949-08kqi   1/1       Running   0          53m\nredis-slave-132015689-3x3qp    1/1       Running   0          47m\nredis-slave-132015689-b6cha    1/1       Running   0          47m\n```\n\n### \u5bc4\u308a\u9053\uff08kube edit\uff09\n\n`kube edit`\u30b3\u30de\u30f3\u30c9\u3092\u4f7f\u3063\u3066\u30ec\u30d7\u30ea\u30ab\u6570\u3084\u305d\u306e\u4ed6\u306e\u8a2d\u5b9a\u3092\u5909\u66f4\u3059\u308b\u3053\u3068\u3082\u3067\u304d\u307e\u3059\u3002\n\n```bash\n$ KUBE_EDITOR=vim kubectl edit deployment frontend # \u30c7\u30d5\u30a9\u30eb\u30c8\u30a8\u30c7\u30a3\u30bf\u306fvi\n```\n\n\u4e0a\u8a18\u30b3\u30de\u30f3\u30c9\u3067\u3001\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\uff08yaml\uff09\u304c\u958b\u304f\u306e\u3067\u4fee\u6b63\u3057\u3066\u4fdd\u5b58\u3059\u308b\u3068\u8a2d\u5b9a\u3092\u5909\u66f4\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\n\n## \u969c\u5bb3\u767a\u751f\u6642\u306ePod\u306e\u6319\u52d5\n\u30b3\u30de\u30f3\u30c9\u3067Pod\u3092\u524a\u9664\u3057\u3066\u3001\u969c\u5bb3\u767a\u751f\u3092\u30b7\u30df\u30e5\u30ec\u30fc\u30b7\u30e7\u30f3\u3057\u3066\u307f\u305f\u3044\u3068\u601d\u3044\u307e\u3059\u3002\n\n- \u30b7\u30df\u30e5\u30ec\u30fc\u30b7\u30e7\u30f3\u3059\u308b\u524d\u306b\u72b6\u614b\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n```bash\n$ kubectl get pods\nNAME                           READY     STATUS    RESTARTS   AGE\nfrontend-88237173-cp3rn        1/1       Running   0          53m\nfrontend-88237173-kxlgh        1/1       Running   0          53m\nfrontend-88237173-tw65g        1/1       Running   0          53m\nredis-master-343230949-08kqi   1/1       Running   0          1h\nredis-slave-132015689-3x3qp    1/1       Running   0          1h\nredis-slave-132015689-b6cha    1/1       Running   0          1h\n```\n\n- Pod\u3092\u4e00\u3064\u524a\u9664\u3057\u307e\u3059\u3002\n\n```bash\n$ kubectl delete pod frontend-88237173-cp3rn\npod \"frontend-88237173-cp3rn\" deleted\n```\n\n- \u5373\u5ea7\u306b\u65b0\u3057\u3044Pod\u304c\u4f5c\u6210\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n\n```bash\n$ kubectl get pods\nNAME                           READY     STATUS    RESTARTS   AGE\nfrontend-88237173-0omu3        1/1       Running   0          3s   # \u76f4\u3050Pod\u304c\u4f5c\u6210\u3055\u308c\u305f\nfrontend-88237173-kxlgh        1/1       Running   0          54m\nfrontend-88237173-tw65g        1/1       Running   0          54m\nredis-master-343230949-08kqi   1/1       Running   0          1h\nredis-slave-132015689-3x3qp    1/1       Running   0          1h\nredis-slave-132015689-b6cha    1/1       Running   0          1h\n```\n\n\u898b\u4e8b\u306b\u30ec\u30d7\u30ea\u30ab\u304c\u518d\u4f5c\u6210\u3055\u308c\u307e\u3057\u305f\u3002 :tada: \n\n\n## \u30e9\u30d9\u30eb\u3092\u5909\u66f4\u3057\u3066\u307f\u308b\nKubernetes\u306f\u30e9\u30d9\u30eb\u3092\u307f\u3066\u30ec\u30d7\u30ea\u30ab\u6570\u3092\u30c1\u30a7\u30c3\u30af\u3057\u3066\u3044\u308b\u3068\u306e\u3053\u3068\u3067\u3001\u305d\u306e\u30e9\u30d9\u30eb\u306b\u5909\u66f4\u304c\u3042\u3063\u305f\u5834\u5408\u306e\u6319\u52d5\u3092\u78ba\u8a8d\u3057\u3066\u307f\u305f\u3044\u3068\u601d\u3044\u307e\u3059\u3002\n\n- \u30e9\u30d9\u30eb\u304c`tier=frontend` \u306ePod\u3092\u8868\u793a\u3057\u307e\u3059\u3002\n\n```bash\n$ kubectl get pod -l tier=frontend\nNAME                      READY     STATUS    RESTARTS   AGE\nfrontend-88237173-0omu3   1/1       Running   0          21m  # \u3053\u306ePod\u306e\u30e9\u30d9\u30eb\u3092\u5909\u66f4\u3059\u308b\nfrontend-88237173-fadzg   1/1       Running   0          1m\nfrontend-88237173-tw65g   1/1       Running   0          1h\n```\n\n- \u3072\u3068\u3064\u306ePod\u306e\u30e9\u30d9\u30eb\u3092\u5909\u66f4\u3057\u307e\u3059\u3002\n\n```bash\n$ kubectl label --overwrite pods frontend-88237173-0omu3 tier=middle\npod \"frontend-88237173-0omu3\" labeled\n```\n\n- \u30e9\u30d9\u30eb\u304c`tier=frontend`\u306ePod\u3092\u8868\u793a\u3057\u307e\u3059\u3002\u65b0\u3057\u3044Pod\u306b\u5165\u308c\u66ff\u3063\u3066\u3044\u308b\u306e\u304c\u5206\u304b\u308a\u307e\u3059\u3002\n\n```bash\n$ kubectl get pod -l tier=frontend\nNAME                      READY     STATUS    RESTARTS   AGE\nfrontend-88237173-fadzg   1/1       Running   0          2m\nfrontend-88237173-kkjpu   1/1       Running   0          4s   # \u65b0\u3057\u3044Pod\u306b\u5909\u308f\u3063\u3066\u3044\u308b\nfrontend-88237173-tw65g   1/1       Running   0          1h\n```\n\n- frontend\u3068\u3057\u3066\u30ec\u30d7\u30ea\u30ab\u6570\u306f\u7dad\u6301\u3057\u3066\u3044\u307e\u3059\u3002\n\n```bash\n$ kubectl get deployment frontend\nNAME       DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE\nfrontend   3         3         3            3           1h   # Pod\u306e\u6570\u306f\u5909\u308f\u3089\u306a\u3044\n```\n\n- \u5909\u66f4\u3057\u305fPod\u306fDeployment\u5916\u306b\u5b58\u5728\u3057\u3066\u3044\u307e\u3059\u3002\n\n```bash\n$ kubectl get pod -l tier=middle\nNAME                      READY     STATUS    RESTARTS   AGE\nfrontend-88237173-0omu3   1/1       Running   0          22m # \u5909\u66f4\u3057\u305fPod\u306f\u5b58\u5728\u3057\u3066\u3044\u308b\n```\n\n\u3053\u3061\u3089\u3082\u898b\u4e8b\u306b\u30ec\u30d7\u30ea\u30ab\u3092\u7dad\u6301\u3057\u3066\u304f\u308c\u3066\u3044\u307e\u3059\u3002 :tada: \n\n## \u30af\u30ea\u30fc\u30f3\u30a2\u30c3\u30d7\n\u30ea\u30bd\u30fc\u30b9\u3092\u5168\u3066\u524a\u9664\u3057\u307e\u3059\u3002\n\n```bash\n$ kubectl delete service,deployment --all\nservice \"frontend\" deleted\nservice \"kubernetes\" deleted\nservice \"redis-master\" deleted\nservice \"redis-slave\" deleted\ndeployment \"frontend\" deleted\ndeployment \"redis-master\" deleted\ndeployment \"redis-slave\" deleted\n\n$ gcloud container clusters delete guestbook\nThe following clusters will be deleted.\n - [guestbook] in [asia-northeast1-a]\n\nDo you want to continue (Y/n)?  Y\n\nDeleting cluster guestbook...done.                                                 \nDeleted [https://container.googleapis.com/v1/projects/{PROJECT_ID}/zones/asia-northeast1-a/clusters/guestbook].\n```\n\n\n## \u6700\u5f8c\u306b\n\n\u7c21\u5358\u306b\u30b3\u30f3\u30c6\u30ca\u306e\u904b\u7528\u304c\u3067\u304d\u308b\u3068\u5b9f\u611f\u3057\u307e\u3057\u305f\u3002\n\u30d7\u30ed\u30d3\u30b8\u30e7\u30cb\u30f3\u30b0\u3082\u7c21\u5358\u3067\u3059\u304c\u3001\u305d\u308c\u3088\u308a\u3082\u904b\u7528\u4e2d\u306e\u7ba1\u7406\u304c\u67d4\u8edf\u306b\u3067\u304d\u308b\u306e\u304c\u6700\u5927\u306a\u9b45\u529b\u3060\u3068\u601d\u3044\u307e\u3059\u3002\u4eca\u5ea6\u306f\u30ed\u30fc\u30ea\u30f3\u30b0\u30a2\u30c3\u30d7\u30c7\u30fc\u30c8\u306a\u3069\u3088\u308a\u5b9f\u8df5\u306b\u8fd1\u3044\u3053\u3068\u3092\u5b66\u3093\u3067\u3044\u304d\u305f\u3044\u3068\u601d\u3044\u307e\u3059\u3002\n\n\u305d\u308c\u3067\u306f :smiley: \n", "tags": ["GKE", "GoogleCloudPlatform", "kubernetes"]}