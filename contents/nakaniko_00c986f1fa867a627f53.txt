{"context": " More than 1 year has passed since last update.\n\n\u8a18\u4e8b\u306e\u6982\u8981\n2015/6/13\u306e\u30aa\u30fc\u30d7\u30f3\u30bd\u30fc\u30b9\u30ab\u30f3\u30d5\u30a1\u30ec\u30f3\u30b92015 Hokkaido\u306e\u8b1b\u6f14PostgreSQL\u306e\u76e3\u8996\u904b\u7528\u3092\u697d\u306b\u3059\u308b\u30c4\u30fc\u30eb\u306e\u3054\u7d39\u4ecb \uff5e pg_monz \u3068 fluentd \uff5e\u3067\u7d39\u4ecb\u3057\u305f\u74b0\u5883\u3092\u69cb\u7bc9\u3059\u308b\u624b\u9806\u306e\u8aac\u660e\n\n\u69cb\u6210\u56f3\n\u4e0b\u56f3\u306e\u69d8\u306a\u74b0\u5883\u3092\u30db\u30b9\u30c8PC\u306b\u69cb\u7bc9\u3057\u307e\u3059\u3002\n\u30db\u30b9\u30c8PC\uff08\u7b46\u8005\u74b0\u5883\u306fMacOS10.10.3\uff09\u4e0a\u306eVirtualBox\u306bCentOS\u306eVM\u30926\u53f0\u8d77\u52d5\u3057\u307e\u3059\u3002\n\n\n\u30b5\u30fc\u30d0\u306e\u5f79\u5272\n\n\n\n\u30b5\u30fc\u30d0\u540d\nIP\u30a2\u30c9\u30ec\u30b9\n\u5f79\u5272\n\n\n\n\nzabbix\n192.168.1.20\nZabbix\u76e3\u8996\u30b5\u30fc\u30d0,PostgreSQL\u30ed\u30b0\u7ba1\u7406\u30b5\u30fc\u30d0\n\n\npgpool01\n192.168.1.11\npgpool-II\u7a3c\u50cd\u30b5\u30fc\u30d0\u3002Active\u7528\u306e\u4eee\u60f3IP\u5272\u5f53\u3066\u6e08\n\n\npqpool02\n192.168.1.12\npgpool-II\u7a3c\u50cd\u30b5\u30fc\u30d0(Standby)\n\n\npgsql01\n192.168.1.13\nPostgreSQL\u7a3c\u50cd\u30b5\u30fc\u30d0\u3002SR\u306eprimary\n\n\npgsql02\n192.168.1.14\nPostgreSQL\u7a3c\u50cd\u30b5\u30fc\u30d0\u3002SR\u306e\u540c\u671fStandby\n\n\npgsql03\n192.168.1.15\nPostgreSQL\u7a3c\u50cd\u30b5\u30fc\u30d0\u3002SR\u306e\u975e\u540c\u671fStandby\n\n\n\n\n\u7a3c\u50cd\u74b0\u5883\n\u4f7f\u7528\u3057\u3066\u3044\u308b\u30d7\u30ed\u30c0\u30af\u30c8\u3068\u7b46\u8005\u74b0\u5883\u3067\u52d5\u4f5c\u78ba\u8a8d\u3057\u3066\u3044\u308b\u30d0\u30fc\u30b8\u30e7\u30f3\u306f\u4ee5\u4e0b\u306e\u3068\u304a\u308a\u3067\u3059\u3002\n\n\u30db\u30b9\u30c8PC\n\n\n\n\u30d7\u30ed\u30c0\u30af\u30c8\u540d\n\u30d0\u30fc\u30b8\u30e7\u30f3\n\n\n\n\nVirtualBox\n4.3.26\n\n\nVagrant\n1.7.2\n\n\nAnsible\n1.9.0.1\n\n\n\n\n\u30b2\u30b9\u30c8OS\n\n\n\n\u30d7\u30ed\u30c0\u30af\u30c8\u540d\n\u30d0\u30fc\u30b8\u30e7\u30f3\n\n\n\n\nCentOS\n6.6\n\n\nPostgreSQL\n9.4.3\n\n\nZabbix\n2.4.5\n\n\nFluentd(td-agent)\n0.12.7(2.2.0)\n\n\nfluent-plugin-parser\n0.5.0\n\n\nfluent-plugin-record-reformer\n0.6.3\n\n\nfluent-plugin-pgjson\n0.0.7\n\n\n\n\n\u69cb\u7bc9\u624b\u9806\n\npgpool-II,PostgreSQL SR\u30af\u30e9\u30b9\u30bf\u306e\u69cb\u7bc9 (\u30db\u30b9\u30c8PC\u306e\u4f5c\u696d)\n\n\u30db\u30b9\u30c8PC\u306bVirtualBox,Vagrant,Ansible\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\uff08\u8a73\u7d30\u7701\u7565\uff09\nVagrant\u4f5c\u696d\u7528\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3001Vagrantfile\u3092\u751f\u6210\n\n$ mkdir PgMonzTest\n$ cd PgMonzTest\n$ vagrant init\n\n\nVagrantfile\u3092\u7de8\u96c6\n\nVagrant.configure(2) do |config|\n  config.vm.define :pgpool01 do |h1|\n    h1.vm.provider \"virtualbox\" do |v|\n      v.customize [\"modifyvm\", :id, \"--memory\", 512]\n    end\n    h1.vm.network :private_network, ip: \"192.168.1.11\"\n    h1.vm.box = \"chef/centos-6.6\"\n    h1.vm.hostname = \"pgpool01\"\n  end\n  config.vm.define :pgpool02 do |h1|\n    h1.vm.provider \"virtualbox\" do |v|\n      v.customize [\"modifyvm\", :id, \"--memory\", 512]\n    end\n    h1.vm.network :private_network, ip: \"192.168.1.12\"\n    h1.vm.box = \"chef/centos-6.6\"\n    h1.vm.hostname = \"pgpool02\"\n  end\n  config.vm.define :pgsql01 do |h1|\n    h1.vm.provider \"virtualbox\" do |v|\n      v.customize [\"modifyvm\", :id, \"--memory\", 512]\n    end\n    h1.vm.network :private_network, ip: \"192.168.1.13\"\n    h1.vm.box = \"chef/centos-6.6\"\n    h1.vm.hostname = \"pgsql01\"\n  end\n  config.vm.define :pgsql02 do |h1|\n    h1.vm.provider \"virtualbox\" do |v|\n      v.customize [\"modifyvm\", :id, \"--memory\", 512]\n    end\n    h1.vm.network :private_network, ip: \"192.168.1.14\"\n    h1.vm.box = \"chef/centos-6.6\"\n    h1.vm.hostname = \"pgsql02\"\n  end\n  config.vm.define :pgsql03 do |h1|\n    h1.vm.provider \"virtualbox\" do |v|\n      v.customize [\"modifyvm\", :id, \"--memory\", 512]\n    end\n    h1.vm.network :private_network, ip: \"192.168.1.15\"\n    h1.vm.box = \"chef/centos-6.6\"\n    h1.vm.hostname = \"pgsql03\"\n  end\n  config.vm.define :zabbix do |h1|\n    h1.vm.provider \"virtualbox\" do |v|\n      v.customize [\"modifyvm\", :id, \"--memory\", 512]\n    end\n    h1.vm.network :private_network, ip: \"192.168.1.20\"\n    h1.vm.box = \"chef/centos-6.6\"\n    h1.vm.hostname = \"zabbix\"\n  end\nend\n\n\nVM \u3092\u8d77\u52d5\n\n$ vagrant up\n$ vagrant status\nCurrent machine states:\n\npgpool01                  running (virtualbox)\npgpool02                  running (virtualbox)\npgsql01                   running (virtualbox)\npgsql02                   running (virtualbox)\npgsql03                   running (virtualbox)\nzabbix                    running (virtualbox)\n\n\npgpool-II,PostgreSQL SR\u30af\u30e9\u30b9\u30bf\u3092\u69cb\u7bc9\u3059\u308bAnsible Playbook\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\n\n$ git clone https://github.com/pg-monz/ansible-pgool-pgsql-cluster.git\n\n\ngroup_vars/all.yml\u3092\u7de8\u96c6\n\n# \u7de8\u96c6\u7b87\u6240\nsynchronous_standby_names: '192.168.1.14,192.168.1.15'\nvip: 192.168.1.100\npgpool_active_ip: 192.168.1.11\npgpool_standby_ip: 192.168.1.12\npgsql_primary_ip: 192.168.1.13\npgsql_standby01_ip: 192.168.1.14\npgsql_standby02_ip: 192.168.1.15\n\n\n\u305d\u306e\u307e\u307e\u3067\u306f\u3046\u307e\u304f\u52d5\u304b\u306a\u3044\u90e8\u5206\u304c\u3042\u3063\u305f\u306e\u3067Playbook\u3092\u4fee\u6b63\n\n# roles/spred_selinux_settings/tasks/main.yml\u3092\u65b0\u898f\u4f5c\u6210\n---\n- name: Check if selinux is installed\n  command: getenforce\n  register: command_result\n  ignore_errors: True\n\n- name: Install libselinux-python\n  yum: name={{ item }}\n  with_items:\n    - epel-release\n    - libselinux-python\n  when: command_result|success and command_result.stdout != 'Disabled'\n\n# prepare.yml\u306bspred_selinux_settings\u3092\u8ffd\u52a0\n---\n- hosts: all\n  sudo: yes\n  gather_facts: no\n  roles:\n   - spred_selinux_settings\n   - spred_ssh_settings\n   - spred_pgdg_rpms\n   - spred_pgpool_src\n   - spred_os_cmd\n\n\nPlaybook\u3092\u5b9f\u884c\n\n$ ansible-playbook --ask-pass --ask-sudo-pass -i hosts site.yml\n\n\nZabbix \u30b5\u30fc\u30d0\u306e\u69cb\u7bc9 (\u30b5\u30fc\u30d0zabbix\u306e\u4f5c\u696d)\n\n\u30b5\u30fc\u30d0 zabbix \u306b\u30ed\u30b0\u30a4\u30f3\u3002\u5f8c\u306e\u4f5c\u696d\u306f\u57fa\u672c\u7684\u306broot\u30e6\u30fc\u30b6\u3067\u5b9f\u884c\u3059\u308b\u3002\n\n$ vagrant ssh zabbix\n$ su\n\n\nPostgreSQL\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n$ wget http://yum.postgresql.org/9.4/redhat/rhel-6-x86_64/pgdg-centos94-9.4-1.noarch.rpm\n$ rpm -ivh pgdg-centos94-9.4-1.noarch.rpm\n$ yum install postgresql94 postgresql94-server postgresql94-contrib\n$ su - postgres\n$ cd /var/lib/pgsql/9.4/data\n$ /usr/pgsql-9.4/bin/initdb --encoding=UTF8 --no-locale\n# \u30e6\u30fc\u30b6\u3092 root \u306b\u623b\u3059\n$ service postgresql-9.4 start\n\n\nZabbix Server\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n$ wget http://repo.zabbix.com/zabbix/2.4/rhel/6/x86_64/zabbix-release-2.4-1.el6.noarch.rpm\n$ rpm -ivh zabbix-release-2.4-1.el6.noarch.rpm\n$ yum install zabbix zabbix-server-pgsql zabbix-server zabbix-sender zabbix-get\n$ yum install zabbix-web-pgsql zabbix-web zabbix-web-japanese\n\n\nzabbix\u3068\u3044\u3046\u540d\u524d\u306e\u30e6\u30fc\u30b6,\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u3092\u4f5c\u6210\n\n$ su - postgres\n$ psql\n\n# create user zabbix with encrypted password 'zabbix' nocreatedb nocreateuser;\n# create database zabbix owner zabbix;\n\n$ psql -U zabbix zabbix < /usr/share/doc/zabbix-server-pgsql-2.4.5/create/schema.sql\n$ psql -U zabbix zabbix < /usr/share/doc/zabbix-server-pgsql-2.4.5/create/images.sql\n$ psql -U zabbix zabbix < /usr/share/doc/zabbix-server-pgsql-2.4.5/create/data.sql\n\n\nZabbix\u30b5\u30fc\u30d0\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092\u7de8\u96c6\u3057\u3066\u8d77\u52d5\n\n$ vi /etc/zabbix/zabbix_server.conf\n\n\n\u203b\u7de8\u96c6\u7b87\u6240\nDBPort=5432\n\n$ vi /etc/php.ini\n\n\n\u203b\u7de8\u96c6\u7b87\u6240\ndate.timezone = Asia/Tokyo\n\n$ service zabbix-server start\n$ service httpd start\n\n\n\nZabbix Web\u30da\u30fc\u30b8\u306b\u30a2\u30af\u30bb\u30b9\u3057\u3001\u521d\u671f\u8a2d\u5b9a\u30a6\u30a3\u30b6\u30fc\u30c9\u3092\u8d77\u52d5\n\n\n3. Configure DB connection \u753b\u9762\u3067DB\u306e\u63a5\u7d9a\u60c5\u5831\u5165\u529b\n\n\n\n\nDatabase name : zabbix\nUser : zabbix\nPassword : zabbix\n\n\npg_monz \u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\n\n$ git clone https://github.com/pg-monz/pg_monz.git\n\n\ntemplate\u30d5\u30a9\u30eb\u30c0\u306e\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8(.xml)\u3092\u30a4\u30f3\u30dd\u30fc\u30c8\u3059\u308b\u3002\n\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8Template App PostgreSQL\u306e\u30de\u30af\u30ed\u3092\u7de8\u96c6\n\n\n{$PGLOGDIR} : /var/log/pgsql\n\n\n\u30db\u30b9\u30c8\u3092\u4f5c\u6210\u3057\u3001\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u3092\u5272\u308a\u5f53\u3066\u308b\u3002\n\n\n\n\n\u30db\u30b9\u30c8\u540d\n\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u540d\n\n\n\n\npgpool01,pgpool02\nTemplate App pgpool-II\n\n\npgsql01,pgsql02,pgsql03\nTemplate App PostgreSQL SR\n\n\nPostgreSQL Cluster\nTemplate App pgpool-II watchdog, Template App PostgreSQL SR Cluster\n\n\n\n\n\u30db\u30b9\u30c8\u30b0\u30eb\u30fc\u30d7\u3092\u4f5c\u6210\u3059\u308b\u3002\n\n\n\n\n\u30db\u30b9\u30c8\u30b0\u30eb\u30fc\u30d7\u540d\n\u30db\u30b9\u30c8\u540d\n\n\n\n\npgpool\npgpool01,pgpool02\n\n\nPostgreSQL\npgsql01,pgsql02,pgsql03\n\n\nPostgreSQL Cluster\nPostgreSQL Cluster\n\n\n\n\nZabbix \u30a8\u30fc\u30b8\u30a7\u30f3\u30c8\u306e\u5c0e\u5165\uff08\u30b5\u30fc\u30d0zabbix\u4ee5\u5916\u306e\u5168\u30b5\u30fc\u30d0\u3067\u306e\u4f5c\u696d\uff09\n\nZabbix\u30a8\u30fc\u30b8\u30a7\u30f3\u30c8\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n$ wget http://repo.zabbix.com/zabbix/2.4/rhel/6/x86_64/zabbix-release-2.4-1.el6.noarch.rpm\n$ rpm -ivh zabbix-release-2.4-1.el6.noarch.rpm\n$ yum install zabbix-agent zabbix-sender\n\n\nZabbix\u30a8\u30fc\u30b8\u30a7\u30f3\u30c8\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092\u7de8\u96c6\u3057\u3066\u8d77\u52d5\n\n$ vi /etc/zabbix/zabbix_agentd.conf\n\n\n\u203b\u7de8\u96c6\u7b87\u6240(Hostname\u306f\u5404\u30b5\u30fc\u30d0\u306e\u30db\u30b9\u30c8\u540d\u3092\u8a18\u8f09)\nServer=192.168.1.20\nServerActive=192.168.1.20\nHostname=pgpool01\nAllowRoot=1\n\n\npg_monz \u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3001\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u914d\u7f6e\u3057\u3001Zabbix\u30a8\u30fc\u30b8\u30a7\u30f3\u30c8\u3092\u8d77\u52d5\n\n$ git clone https://github.com/pg-monz/pg_monz.git\n$ cd pg_monz/pg_monz/\n$ cp usr-local-etc/* /usr/local/etc\n$ cp usr-local-bin/* /usr/local/bin\n$ chmod +x /usr/local/bin/*.sh\n$ cp zabbix_agentd.d/userparameter_pgsql.conf /etc/zabbix/zabbix_agentd.d/\n$ service zabbix-agent start\n\n\nFluentd \u306e\u5c0e\u5165\n\ntd-agent\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\uff08\u30b5\u30fc\u30d0zabbix,pgsql01,pgsql02,pgsql03\u3067\u306e\u4f5c\u696d\uff09\n\n$ curl -L https://td-toolbelt.herokuapp.com/sh/install-redhat-td-agent2.sh | sh\n\n\nfluentd\u30d7\u30e9\u30b0\u30a4\u30f3\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\uff08\u30b5\u30fc\u30d0pgsql01,pgsql02,pgsql03\uff09\n\n$ td-agent-gem install fluent-plugin-parser\n$ td-agent-gem install fluent-plugin-record-reformer\n\n\nfluentd\u30d7\u30e9\u30b0\u30a4\u30f3\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\uff08\u30b5\u30fc\u30d0zabbix\uff09 \n\n$ yum install gcc\n$ yum install postgresql9.4-devel\n$ export PATH=/usr/pgsql-9.4/bin:$PATH\n$ td-agent-gem install fluent-plugin-pgjson\n\n\nPostgreSQL\u306e\u30ed\u30b0\u8a2d\u5b9a\u3092\u5909\u66f4\n\n/var/lib/pgsql/9.4/data/postgresql.conf\u3092\u7de8\u96c6\u3057\u3001\u518d\u8aad\u307f\u8fbc\u307f\uff08\u30b5\u30fc\u30d0pgsql01,pgsql02,pgsql03\u3067\u306e\u4f5c\u696d\uff09\n\n\n\u203b\u7de8\u96c6\u7b87\u6240\nlog_destination = 'stderr,csvlog'\nlog_line_prefix = '[%t][%p][%c-%l][%x][%e]%q (%u, %d, %r, %a)'\nlog_filename = 'postgresql.log'\nlog_rotation_age = 0\nlog_min_duration_statement = '1s'\nlog_checkpoints = on\nlog_lock_waits = on\nlog_temp_files = 0\n\n$ service postgresql-9.4 reload\n\n\nFluentd\u306e\u8a2d\u5b9a\u3092\u5909\u66f4\n\n/etc/td-agent/td-agent.conf \u306b\u8a2d\u5b9a\u3092\u8ffd\u8a18\uff08\u30b5\u30fc\u30d0pgsql01,pgsql02,pgsql03\u3067\u306e\u4f5c\u696d\uff09\n\n<source>\n  type      tail\n  path      /var/log/pgsql/postgresql.csv\n  pos_file   /var/log/td-agent/postgresql.log.pos\n  tag       postgresql\n  format    multiline\n  format_firstline  /^\\d{4}-\\d{2}-\\d{2}/\n  format1   /^(?<time>[^\",]*),\"?(?<user_name>(?:[^\",]|\"\")*)\"?,\"?(?<database_name>(?:[^\",]|\"\")*)\"?,(?<process_id>[^\",]*),\"?(?<connection_from>(?:[^\",]|\"\")*)\"?,(?<session_id>[^\",]*),(?<session_line_num>[^\",]*),\"?(?<command_tag>(?:[^\",]|\"\")*)\"?,(?<session_start_time>[^\",]*),(?<virtual_transaction_id>[^\",]*),(?<transaction_id>[^\",]*),(?<error_severity>[^\",]*),(?<sql_state_code>[^\",]*),\"?(?<message>(?:[^\"]|\"\")*)\"?,(?<detail>[^\",]*),\"?(?<hint>(?:[^\",]|\"\")*)\"?,(?<internal_query>[^\",]*),(?<internal_query_pos>[^\",]*),(?<context>[^\",]*),\"?(?<query>(?:[^\"]|\"\")*)\"?,(?<query_pos>[^\",]*),(?<location>[^\",]*),\"?(?<application_name>(?:[^\",]|\"\")*)\"?$/\n</source>\n\n<match postgresql>\n  type rewrite_tag_filter\n  rewriterule1  message  ^duration:                             raw.postgresql.slow_query\n  rewriterule2  message  ^checkpoints\\sare\\soccurring\\stoo\\sfrequently                                                                                  postgresql.checkpoints.frequently\n  rewriterule3  message  ^checkpoint\\sstarting:                 postgresql.checkpoint.start\n  rewriterule4  message  ^checkpoint\\scomplete:                 postgresql.checkpoint.complete\n  rewriterule5  message  ^automatic                             postgresql.vacuum\n  rewriterule6  message  ^temporary file:                       postgresql.tempfiles\n  rewriterule7  message  ^process.*detected\\sdeadlock           postgresql.deadlock\n  rewriterule8  message  ^process.*(still waiting|acquired)     postgresql.lockwait\n  rewriterule9  message  .*                                     postgresql.others\n</match>\n\n<match raw.postgresql.slow_query>\n  type parser\n  remove_prefix raw\n  reserve_data  yes\n  key_name      message\n  format        /^duration: (?<duration>[0-9\\.]+) ms  statement: (?<statement>.+)$/\n</match>\n\n<match {postgresql.**}>\n  type record_reformer\n  renew_record false\n  enable_ruby true\n  tag pgsql.${tag_suffix[1]}\n  <record>\n    hostname ${hostname}\n  </record>\n</match>\n\n<match {pgsql.**}>\n  type forward\n  <server>\n    host 192.168.1.20\n    port 29680\n  </server>\n  flush_interval 10s\n</match>\n\n\n/etc/td-agent/td-agent.conf \u306b\u8a2d\u5b9a\u3092\u8ffd\u8a18\uff08\u30b5\u30fc\u30d0zabbix\u3067\u306e\u4f5c\u696d\uff09\n\n<source>\n  type forward\n  port 29680\n</source>\n\n<match {pgsql.**}>\n  type          pgjson\n  host          localhost\n  port          5432\n  sslmode       prefer\n  database      fluentd\n  table         fluentd\n  user          postgres\n  password      postgres\n  time_col      time\n  tag_col       tag\n  record_col    record\n</match>\n\n\n\u30ed\u30b0\u30c7\u30fc\u30bf\u683c\u7d0d\u7528\u30c6\u30fc\u30d6\u30eb\u3092\u4f5c\u6210\uff08Zabbix\u30b5\u30fc\u30d0\uff09\n$ su - postgres\n$ psql\n\n# CREATE DATABASE fluentd;\n# \u00a5c fluentd\n# CREATE TABLE fluentd (tag Text, time Timestamptz, record Jsonb);\n\n\nFluentd \u3092\u8d77\u52d5\uff08\u30b5\u30fc\u30d0zabbix,pgsql01,pgsql02,pgsql03\u3067\u306e\u4f5c\u696d\uff09\n$ service td-agent start\n\n\n\u30ed\u30b0\u30c7\u30fc\u30bf\u683c\u7d0d\u7528\u30c6\u30fc\u30d6\u30eb\u306b\u5bfe\u3059\u308bSQL\u30b5\u30f3\u30d7\u30eb\n\n\u30b9\u30ed\u30fc\u30af\u30a8\u30ea\u3092\u691c\u7d22\uff08\u6642\u9593\u304c\u9577\u304410\u4ef6\uff09\n# select time, record#>>'{hostname}' as host, record#>>'{user_name}' as user, record#>>'{database_name}' as db, record#>>'{duration}' as duration, record#>>'{statement}' as statement from fluentd where tag = 'pgsql.slow_query' ORDER BY (record#>'{duration}') desc LIMIT 10;\n\n# \u8a18\u4e8b\u306e\u6982\u8981\n2015/6/13\u306e\u30aa\u30fc\u30d7\u30f3\u30bd\u30fc\u30b9\u30ab\u30f3\u30d5\u30a1\u30ec\u30f3\u30b92015 Hokkaido\u306e\u8b1b\u6f14[PostgreSQL\u306e\u76e3\u8996\u904b\u7528\u3092\u697d\u306b\u3059\u308b\u30c4\u30fc\u30eb\u306e\u3054\u7d39\u4ecb \uff5e pg_monz \u3068 fluentd \uff5e](https://www.ospn.jp/osc2015-do/modules/eguide/event.php?eid=40)\u3067\u7d39\u4ecb\u3057\u305f\u74b0\u5883\u3092\u69cb\u7bc9\u3059\u308b\u624b\u9806\u306e\u8aac\u660e\n\n# \u69cb\u6210\u56f3\n\u4e0b\u56f3\u306e\u69d8\u306a\u74b0\u5883\u3092\u30db\u30b9\u30c8PC\u306b\u69cb\u7bc9\u3057\u307e\u3059\u3002\n\u30db\u30b9\u30c8PC\uff08\u7b46\u8005\u74b0\u5883\u306fMacOS10.10.3\uff09\u4e0a\u306eVirtualBox\u306bCentOS\u306eVM\u30926\u53f0\u8d77\u52d5\u3057\u307e\u3059\u3002\n![\u69cb\u6210\u56f3.png](https://qiita-image-store.s3.amazonaws.com/0/13485/31cb514f-5574-d0b0-aefe-2701e8893094.png \"\u69cb\u6210\u56f3.png\")\n\n# \u30b5\u30fc\u30d0\u306e\u5f79\u5272\n| \u30b5\u30fc\u30d0\u540d  | IP\u30a2\u30c9\u30ec\u30b9     | \u5f79\u5272 |\n|:---------|-------------:|:----|\n| zabbix   | 192.168.1.20 | Zabbix\u76e3\u8996\u30b5\u30fc\u30d0,PostgreSQL\u30ed\u30b0\u7ba1\u7406\u30b5\u30fc\u30d0 |\n| pgpool01 | 192.168.1.11 | pgpool-II\u7a3c\u50cd\u30b5\u30fc\u30d0\u3002Active\u7528\u306e\u4eee\u60f3IP\u5272\u5f53\u3066\u6e08 |\n| pqpool02 | 192.168.1.12 | pgpool-II\u7a3c\u50cd\u30b5\u30fc\u30d0(Standby) |\n| pgsql01  | 192.168.1.13 | PostgreSQL\u7a3c\u50cd\u30b5\u30fc\u30d0\u3002SR\u306eprimary |\n| pgsql02  | 192.168.1.14 | PostgreSQL\u7a3c\u50cd\u30b5\u30fc\u30d0\u3002SR\u306e\u540c\u671fStandby |\n| pgsql03  | 192.168.1.15 | PostgreSQL\u7a3c\u50cd\u30b5\u30fc\u30d0\u3002SR\u306e\u975e\u540c\u671fStandby |\n\n# \u7a3c\u50cd\u74b0\u5883\n\u4f7f\u7528\u3057\u3066\u3044\u308b\u30d7\u30ed\u30c0\u30af\u30c8\u3068\u7b46\u8005\u74b0\u5883\u3067\u52d5\u4f5c\u78ba\u8a8d\u3057\u3066\u3044\u308b\u30d0\u30fc\u30b8\u30e7\u30f3\u306f\u4ee5\u4e0b\u306e\u3068\u304a\u308a\u3067\u3059\u3002\n## \u30db\u30b9\u30c8PC\n| \u30d7\u30ed\u30c0\u30af\u30c8\u540d | \u30d0\u30fc\u30b8\u30e7\u30f3 |\n|:-----------|---------:|\n| VirtualBox |   4.3.26 |\n| Vagrant    |    1.7.2 |\n| Ansible    |  1.9.0.1 |\n## \u30b2\u30b9\u30c8OS\n| \u30d7\u30ed\u30c0\u30af\u30c8\u540d | \u30d0\u30fc\u30b8\u30e7\u30f3 |\n|:-----------|---------:|\n| CentOS     |      6.6 |\n| PostgreSQL |    9.4.3 |\n| Zabbix     |    2.4.5 |\n| Fluentd(td-agent) | 0.12.7(2.2.0) |\n| fluent-plugin-parser | 0.5.0 |\n| fluent-plugin-record-reformer | 0.6.3 |\n| fluent-plugin-pgjson | 0.0.7 |\n\n# \u69cb\u7bc9\u624b\u9806\n## pgpool-II,PostgreSQL SR\u30af\u30e9\u30b9\u30bf\u306e\u69cb\u7bc9 (\u30db\u30b9\u30c8PC\u306e\u4f5c\u696d)\n* \u30db\u30b9\u30c8PC\u306bVirtualBox,Vagrant,Ansible\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\uff08\u8a73\u7d30\u7701\u7565\uff09\n* Vagrant\u4f5c\u696d\u7528\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3001Vagrantfile\u3092\u751f\u6210\n\n```bash\n$ mkdir PgMonzTest\n$ cd PgMonzTest\n$ vagrant init\n``` \n\n* Vagrantfile\u3092\u7de8\u96c6\n\n```ruby\nVagrant.configure(2) do |config|\n  config.vm.define :pgpool01 do |h1|\n    h1.vm.provider \"virtualbox\" do |v|\n      v.customize [\"modifyvm\", :id, \"--memory\", 512]\n    end\n    h1.vm.network :private_network, ip: \"192.168.1.11\"\n    h1.vm.box = \"chef/centos-6.6\"\n    h1.vm.hostname = \"pgpool01\"\n  end\n  config.vm.define :pgpool02 do |h1|\n    h1.vm.provider \"virtualbox\" do |v|\n      v.customize [\"modifyvm\", :id, \"--memory\", 512]\n    end\n    h1.vm.network :private_network, ip: \"192.168.1.12\"\n    h1.vm.box = \"chef/centos-6.6\"\n    h1.vm.hostname = \"pgpool02\"\n  end\n  config.vm.define :pgsql01 do |h1|\n    h1.vm.provider \"virtualbox\" do |v|\n      v.customize [\"modifyvm\", :id, \"--memory\", 512]\n    end\n    h1.vm.network :private_network, ip: \"192.168.1.13\"\n    h1.vm.box = \"chef/centos-6.6\"\n    h1.vm.hostname = \"pgsql01\"\n  end\n  config.vm.define :pgsql02 do |h1|\n    h1.vm.provider \"virtualbox\" do |v|\n      v.customize [\"modifyvm\", :id, \"--memory\", 512]\n    end\n    h1.vm.network :private_network, ip: \"192.168.1.14\"\n    h1.vm.box = \"chef/centos-6.6\"\n    h1.vm.hostname = \"pgsql02\"\n  end\n  config.vm.define :pgsql03 do |h1|\n    h1.vm.provider \"virtualbox\" do |v|\n      v.customize [\"modifyvm\", :id, \"--memory\", 512]\n    end\n    h1.vm.network :private_network, ip: \"192.168.1.15\"\n    h1.vm.box = \"chef/centos-6.6\"\n    h1.vm.hostname = \"pgsql03\"\n  end\n  config.vm.define :zabbix do |h1|\n    h1.vm.provider \"virtualbox\" do |v|\n      v.customize [\"modifyvm\", :id, \"--memory\", 512]\n    end\n    h1.vm.network :private_network, ip: \"192.168.1.20\"\n    h1.vm.box = \"chef/centos-6.6\"\n    h1.vm.hostname = \"zabbix\"\n  end\nend\n``` \n\n* VM \u3092\u8d77\u52d5\n\n```bash\n$ vagrant up\n$ vagrant status\nCurrent machine states:\n\npgpool01                  running (virtualbox)\npgpool02                  running (virtualbox)\npgsql01                   running (virtualbox)\npgsql02                   running (virtualbox)\npgsql03                   running (virtualbox)\nzabbix                    running (virtualbox)\n``` \n\n* pgpool-II,PostgreSQL SR\u30af\u30e9\u30b9\u30bf\u3092\u69cb\u7bc9\u3059\u308bAnsible Playbook\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\n\n```bash\n$ git clone https://github.com/pg-monz/ansible-pgool-pgsql-cluster.git\n``` \n\n* group_vars/all.yml\u3092\u7de8\u96c6\n\n```Python\n# \u7de8\u96c6\u7b87\u6240\nsynchronous_standby_names: '192.168.1.14,192.168.1.15'\nvip: 192.168.1.100\npgpool_active_ip: 192.168.1.11\npgpool_standby_ip: 192.168.1.12\npgsql_primary_ip: 192.168.1.13\npgsql_standby01_ip: 192.168.1.14\npgsql_standby02_ip: 192.168.1.15\n```\n\n* \u305d\u306e\u307e\u307e\u3067\u306f\u3046\u307e\u304f\u52d5\u304b\u306a\u3044\u90e8\u5206\u304c\u3042\u3063\u305f\u306e\u3067Playbook\u3092\u4fee\u6b63\n\n```Python\n# roles/spred_selinux_settings/tasks/main.yml\u3092\u65b0\u898f\u4f5c\u6210\n---\n- name: Check if selinux is installed\n  command: getenforce\n  register: command_result\n  ignore_errors: True\n\n- name: Install libselinux-python\n  yum: name={{ item }}\n  with_items:\n    - epel-release\n    - libselinux-python\n  when: command_result|success and command_result.stdout != 'Disabled'\n```\n\n```Python\n# prepare.yml\u306bspred_selinux_settings\u3092\u8ffd\u52a0\n---\n- hosts: all\n  sudo: yes\n  gather_facts: no\n  roles:\n   - spred_selinux_settings\n   - spred_ssh_settings\n   - spred_pgdg_rpms\n   - spred_pgpool_src\n   - spred_os_cmd\n```\n\n* Playbook\u3092\u5b9f\u884c\n\n```bash\n$ ansible-playbook --ask-pass --ask-sudo-pass -i hosts site.yml\n```\n\n## Zabbix \u30b5\u30fc\u30d0\u306e\u69cb\u7bc9 (\u30b5\u30fc\u30d0zabbix\u306e\u4f5c\u696d)\n* \u30b5\u30fc\u30d0 zabbix \u306b\u30ed\u30b0\u30a4\u30f3\u3002\u5f8c\u306e\u4f5c\u696d\u306f\u57fa\u672c\u7684\u306broot\u30e6\u30fc\u30b6\u3067\u5b9f\u884c\u3059\u308b\u3002\n\n```bash\n$ vagrant ssh zabbix\n$ su\n```\n\n* PostgreSQL\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n```bash\n$ wget http://yum.postgresql.org/9.4/redhat/rhel-6-x86_64/pgdg-centos94-9.4-1.noarch.rpm\n$ rpm -ivh pgdg-centos94-9.4-1.noarch.rpm\n$ yum install postgresql94 postgresql94-server postgresql94-contrib\n$ su - postgres\n$ cd /var/lib/pgsql/9.4/data\n$ /usr/pgsql-9.4/bin/initdb --encoding=UTF8 --no-locale\n# \u30e6\u30fc\u30b6\u3092 root \u306b\u623b\u3059\n$ service postgresql-9.4 start\n```\n\n* Zabbix Server\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n```bash\n$ wget http://repo.zabbix.com/zabbix/2.4/rhel/6/x86_64/zabbix-release-2.4-1.el6.noarch.rpm\n$ rpm -ivh zabbix-release-2.4-1.el6.noarch.rpm\n$ yum install zabbix zabbix-server-pgsql zabbix-server zabbix-sender zabbix-get\n$ yum install zabbix-web-pgsql zabbix-web zabbix-web-japanese\n```\n\n* zabbix\u3068\u3044\u3046\u540d\u524d\u306e\u30e6\u30fc\u30b6,\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u3092\u4f5c\u6210\n\n```bash\n$ su - postgres\n$ psql\n```\n```SQL\n# create user zabbix with encrypted password 'zabbix' nocreatedb nocreateuser;\n# create database zabbix owner zabbix;\n```\n```bash\n$ psql -U zabbix zabbix < /usr/share/doc/zabbix-server-pgsql-2.4.5/create/schema.sql\n$ psql -U zabbix zabbix < /usr/share/doc/zabbix-server-pgsql-2.4.5/create/images.sql\n$ psql -U zabbix zabbix < /usr/share/doc/zabbix-server-pgsql-2.4.5/create/data.sql\n```\n\n* Zabbix\u30b5\u30fc\u30d0\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092\u7de8\u96c6\u3057\u3066\u8d77\u52d5\n\n```bash\n$ vi /etc/zabbix/zabbix_server.conf\n```\n\n> \u203b\u7de8\u96c6\u7b87\u6240\n> DBPort=5432\n\n```bash\n$ vi /etc/php.ini\n```\n\n> \u203b\u7de8\u96c6\u7b87\u6240\n> date.timezone = Asia/Tokyo\n\n```bash\n$ service zabbix-server start\n$ service httpd start\n```\n\n* [Zabbix Web\u30da\u30fc\u30b8](http://192.168.1.20/zabbix/)\u306b\u30a2\u30af\u30bb\u30b9\u3057\u3001\u521d\u671f\u8a2d\u5b9a\u30a6\u30a3\u30b6\u30fc\u30c9\u3092\u8d77\u52d5\n * 3. Configure DB connection \u753b\u9762\u3067DB\u306e\u63a5\u7d9a\u60c5\u5831\u5165\u529b\n\n> Database name : zabbix\nUser : zabbix\nPassword : zabbix\n\n* pg_monz \u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\n\n```bash\n$ git clone https://github.com/pg-monz/pg_monz.git\n```\n\n* template\u30d5\u30a9\u30eb\u30c0\u306e\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8(.xml)\u3092\u30a4\u30f3\u30dd\u30fc\u30c8\u3059\u308b\u3002\n\n* \u30c6\u30f3\u30d7\u30ec\u30fc\u30c8Template App PostgreSQL\u306e\u30de\u30af\u30ed\u3092\u7de8\u96c6\n\n> {$PGLOGDIR} : /var/log/pgsql\n\n* \u30db\u30b9\u30c8\u3092\u4f5c\u6210\u3057\u3001\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u3092\u5272\u308a\u5f53\u3066\u308b\u3002\n\n| \u30db\u30b9\u30c8\u540d | \u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u540d |\n|:-----------|:---------|\n| pgpool01,pgpool02 | Template App pgpool-II |\n| pgsql01,pgsql02,pgsql03 | Template App PostgreSQL SR |\n| PostgreSQL Cluster | Template App pgpool-II watchdog, Template App PostgreSQL SR Cluster |\n\n* \u30db\u30b9\u30c8\u30b0\u30eb\u30fc\u30d7\u3092\u4f5c\u6210\u3059\u308b\u3002\n\n| \u30db\u30b9\u30c8\u30b0\u30eb\u30fc\u30d7\u540d | \u30db\u30b9\u30c8\u540d |\n|:-----------|:---------|\n| pgpool | pgpool01,pgpool02 |\n| PostgreSQL | pgsql01,pgsql02,pgsql03 |\n| PostgreSQL Cluster | PostgreSQL Cluster |\n\n\n## Zabbix \u30a8\u30fc\u30b8\u30a7\u30f3\u30c8\u306e\u5c0e\u5165\uff08\u30b5\u30fc\u30d0zabbix\u4ee5\u5916\u306e\u5168\u30b5\u30fc\u30d0\u3067\u306e\u4f5c\u696d\uff09\n\n* Zabbix\u30a8\u30fc\u30b8\u30a7\u30f3\u30c8\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n```bash\n$ wget http://repo.zabbix.com/zabbix/2.4/rhel/6/x86_64/zabbix-release-2.4-1.el6.noarch.rpm\n$ rpm -ivh zabbix-release-2.4-1.el6.noarch.rpm\n$ yum install zabbix-agent zabbix-sender\n```\n\n* Zabbix\u30a8\u30fc\u30b8\u30a7\u30f3\u30c8\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092\u7de8\u96c6\u3057\u3066\u8d77\u52d5\n\n```bash\n$ vi /etc/zabbix/zabbix_agentd.conf\n```\n> \u203b\u7de8\u96c6\u7b87\u6240(Hostname\u306f\u5404\u30b5\u30fc\u30d0\u306e\u30db\u30b9\u30c8\u540d\u3092\u8a18\u8f09)\nServer=192.168.1.20\nServerActive=192.168.1.20\nHostname=pgpool01\nAllowRoot=1\n\n* pg_monz \u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3001\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u914d\u7f6e\u3057\u3001Zabbix\u30a8\u30fc\u30b8\u30a7\u30f3\u30c8\u3092\u8d77\u52d5\n\n```bash\n$ git clone https://github.com/pg-monz/pg_monz.git\n$ cd pg_monz/pg_monz/\n$ cp usr-local-etc/* /usr/local/etc\n$ cp usr-local-bin/* /usr/local/bin\n$ chmod +x /usr/local/bin/*.sh\n$ cp zabbix_agentd.d/userparameter_pgsql.conf /etc/zabbix/zabbix_agentd.d/\n$ service zabbix-agent start\n```\n\n## Fluentd \u306e\u5c0e\u5165\n\n* td-agent\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\uff08\u30b5\u30fc\u30d0zabbix,pgsql01,pgsql02,pgsql03\u3067\u306e\u4f5c\u696d\uff09\n\n```bash\n$ curl -L https://td-toolbelt.herokuapp.com/sh/install-redhat-td-agent2.sh | sh\n```\n\n* fluentd\u30d7\u30e9\u30b0\u30a4\u30f3\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\uff08\u30b5\u30fc\u30d0pgsql01,pgsql02,pgsql03\uff09\n\n```bash\n$ td-agent-gem install fluent-plugin-parser\n$ td-agent-gem install fluent-plugin-record-reformer\n```\n\n* fluentd\u30d7\u30e9\u30b0\u30a4\u30f3\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\uff08\u30b5\u30fc\u30d0zabbix\uff09 \n\n```bash\n$ yum install gcc\n$ yum install postgresql9.4-devel\n$ export PATH=/usr/pgsql-9.4/bin:$PATH\n$ td-agent-gem install fluent-plugin-pgjson\n```\n\n## PostgreSQL\u306e\u30ed\u30b0\u8a2d\u5b9a\u3092\u5909\u66f4\n\n* /var/lib/pgsql/9.4/data/postgresql.conf\u3092\u7de8\u96c6\u3057\u3001\u518d\u8aad\u307f\u8fbc\u307f\uff08\u30b5\u30fc\u30d0pgsql01,pgsql02,pgsql03\u3067\u306e\u4f5c\u696d\uff09\n\n> \u203b\u7de8\u96c6\u7b87\u6240\nlog_destination = 'stderr,csvlog'\nlog_line_prefix = '[%t][%p][%c-%l][%x][%e]%q (%u, %d, %r, %a)'\nlog_filename = 'postgresql.log'\nlog_rotation_age = 0\nlog_min_duration_statement = '1s'\nlog_checkpoints = on\nlog_lock_waits = on\nlog_temp_files = 0\n\n```bash\n$ service postgresql-9.4 reload\n```\n\n## Fluentd\u306e\u8a2d\u5b9a\u3092\u5909\u66f4\n\n* /etc/td-agent/td-agent.conf \u306b\u8a2d\u5b9a\u3092\u8ffd\u8a18\uff08\u30b5\u30fc\u30d0pgsql01,pgsql02,pgsql03\u3067\u306e\u4f5c\u696d\uff09\n\n```xml\n<source>\n  type      tail\n  path      /var/log/pgsql/postgresql.csv\n  pos_file   /var/log/td-agent/postgresql.log.pos\n  tag       postgresql\n  format    multiline\n  format_firstline  /^\\d{4}-\\d{2}-\\d{2}/\n  format1   /^(?<time>[^\",]*),\"?(?<user_name>(?:[^\",]|\"\")*)\"?,\"?(?<database_name>(?:[^\",]|\"\")*)\"?,(?<process_id>[^\",]*),\"?(?<connection_from>(?:[^\",]|\"\")*)\"?,(?<session_id>[^\",]*),(?<session_line_num>[^\",]*),\"?(?<command_tag>(?:[^\",]|\"\")*)\"?,(?<session_start_time>[^\",]*),(?<virtual_transaction_id>[^\",]*),(?<transaction_id>[^\",]*),(?<error_severity>[^\",]*),(?<sql_state_code>[^\",]*),\"?(?<message>(?:[^\"]|\"\")*)\"?,(?<detail>[^\",]*),\"?(?<hint>(?:[^\",]|\"\")*)\"?,(?<internal_query>[^\",]*),(?<internal_query_pos>[^\",]*),(?<context>[^\",]*),\"?(?<query>(?:[^\"]|\"\")*)\"?,(?<query_pos>[^\",]*),(?<location>[^\",]*),\"?(?<application_name>(?:[^\",]|\"\")*)\"?$/\n</source>\n\n<match postgresql>\n  type rewrite_tag_filter\n  rewriterule1  message  ^duration:                             raw.postgresql.slow_query\n  rewriterule2  message  ^checkpoints\\sare\\soccurring\\stoo\\sfrequently                                                                                  postgresql.checkpoints.frequently\n  rewriterule3  message  ^checkpoint\\sstarting:                 postgresql.checkpoint.start\n  rewriterule4  message  ^checkpoint\\scomplete:                 postgresql.checkpoint.complete\n  rewriterule5  message  ^automatic                             postgresql.vacuum\n  rewriterule6  message  ^temporary file:                       postgresql.tempfiles\n  rewriterule7  message  ^process.*detected\\sdeadlock           postgresql.deadlock\n  rewriterule8  message  ^process.*(still waiting|acquired)     postgresql.lockwait\n  rewriterule9  message  .*                                     postgresql.others\n</match>\n\n<match raw.postgresql.slow_query>\n  type parser\n  remove_prefix raw\n  reserve_data  yes\n  key_name      message\n  format        /^duration: (?<duration>[0-9\\.]+) ms  statement: (?<statement>.+)$/\n</match>\n\n<match {postgresql.**}>\n  type record_reformer\n  renew_record false\n  enable_ruby true\n  tag pgsql.${tag_suffix[1]}\n  <record>\n    hostname ${hostname}\n  </record>\n</match>\n\n<match {pgsql.**}>\n  type forward\n  <server>\n    host 192.168.1.20\n    port 29680\n  </server>\n  flush_interval 10s\n</match>\n```\n\n* /etc/td-agent/td-agent.conf \u306b\u8a2d\u5b9a\u3092\u8ffd\u8a18\uff08\u30b5\u30fc\u30d0zabbix\u3067\u306e\u4f5c\u696d\uff09\n\n```xml\n<source>\n  type forward\n  port 29680\n</source>\n\n<match {pgsql.**}>\n  type          pgjson\n  host          localhost\n  port          5432\n  sslmode       prefer\n  database      fluentd\n  table         fluentd\n  user          postgres\n  password      postgres\n  time_col      time\n  tag_col       tag\n  record_col    record\n</match>\n```\n\n## \u30ed\u30b0\u30c7\u30fc\u30bf\u683c\u7d0d\u7528\u30c6\u30fc\u30d6\u30eb\u3092\u4f5c\u6210\uff08Zabbix\u30b5\u30fc\u30d0\uff09\n\n```bash\n$ su - postgres\n$ psql\n```\n```SQL\n# CREATE DATABASE fluentd;\n# \u00a5c fluentd\n# CREATE TABLE fluentd (tag Text, time Timestamptz, record Jsonb);\n```\n\n## Fluentd \u3092\u8d77\u52d5\uff08\u30b5\u30fc\u30d0zabbix,pgsql01,pgsql02,pgsql03\u3067\u306e\u4f5c\u696d\uff09\n\n```bash\n$ service td-agent start\n```\n\n# \u30ed\u30b0\u30c7\u30fc\u30bf\u683c\u7d0d\u7528\u30c6\u30fc\u30d6\u30eb\u306b\u5bfe\u3059\u308bSQL\u30b5\u30f3\u30d7\u30eb\n\n## \u30b9\u30ed\u30fc\u30af\u30a8\u30ea\u3092\u691c\u7d22\uff08\u6642\u9593\u304c\u9577\u304410\u4ef6\uff09\n```SQL\n# select time, record#>>'{hostname}' as host, record#>>'{user_name}' as user, record#>>'{database_name}' as db, record#>>'{duration}' as duration, record#>>'{statement}' as statement from fluentd where tag = 'pgsql.slow_query' ORDER BY (record#>'{duration}') desc LIMIT 10;\n```\n", "tags": ["fluentd", "PostgreSQL", "pg_monz", "zabbix"]}