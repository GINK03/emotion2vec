{"tags": ["Java", "Selenium2", "\u30cb\u30b3\u30cb\u30b3\u52d5\u753b\u7d71\u8a08\u30b7\u30ea\u30fc\u30ba"], "context": " More than 1 year has passed since last update.\n\n\u6982\u8981\nUI\u30c6\u30b9\u30c8\u81ea\u52d5\u5316\u30c4\u30fc\u30eb\u300cSelenium WebDriver\u300d\u3092\n\u30cb\u30b3\u30cb\u30b3\u9759\u753b\u7528\u306e\u30af\u30ed\u30fc\u30e9\u30fc\u306b\u8ee2\u7528\u3057\u3066\u307f\u305f\u3002\n\u30bf\u30b0\u691c\u7d22\u7d50\u679c\u306e\u30a4\u30e9\u30b9\u30c8\u7fa4\uff08\u3082\u3061\u308d\u3093\u6625\u753b\u3082\uff01\uff09\u3092\n\u30b9\u30e9\u30a4\u30c9\u30b7\u30e7\u30fc\u306e\u3088\u3046\u306b\u8868\u793a\u3057\u306a\u304c\u3089\n\u4f5c\u54c1\u30c7\u30fc\u30bf\u3092\u53ce\u96c6\u3067\u304d\u305f\u3089\u3001\n\u305d\u308c\u306f\u3068\u3063\u3066\u3082\u7d20\u6575\u3060\u306a\u3063\u3066\u601d\u3063\u305f\u3002\n\n\u4f5c\u696d\n01.Firefox\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u3002\n02.Selenium WebDriver\u3092\u5916\u90e8\u53c2\u7167\u3059\u308bJava\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u3092\u4f5c\u308b\u3002\n\u3000\u3000 \u624b\u9806\u306f\u3053\u3061\u3089\u306e\u30b5\u30a4\u30c8\u3092\u53c2\u8003\u306b\u3055\u305b\u3066\u3044\u305f\u3060\u3044\u305f\u3002\n03.\u4e0b\u8a18\u30b3\u30fc\u30c9\u3092\u5b9f\u88c5\u3059\u308b\u3002\n\nNicoNicoSeigaCrawler.java\n/**\nNicoNicoSeigaCrawler\nCopyright (c) 2014 nezuq\nThis software is released under the MIT License.\nhttp://opensource.org/licenses/mit-license.php\n*/\n\nimport java.io.File;\nimport java.io.FileWriter;\nimport java.io.BufferedWriter;\nimport java.io.PrintWriter;\nimport java.io.IOException;\nimport java.util.*;\nimport java.text.*;\nimport org.openqa.selenium.WebDriver;\nimport org.openqa.selenium.WebElement;\nimport org.openqa.selenium.By;\nimport org.openqa.selenium.JavascriptExecutor;\nimport org.openqa.selenium.firefox.FirefoxDriver;\n\n\npublic class NicoNicoSeigaCrawler {\n\n    private static final int IndexMaxPage = 40; \n\n    public static void main(String[] args) {\n        // \u5b9f\u884c\u30d5\u30a1\u30a4\u30eb\u306e\u5f15\u6570\u3092\u53d7\u3051\u53d6\u308b\n        //  [0] \u691c\u7d22\u30ad\u30fc\u30ef\u30fc\u30c9\n        //  [1] \u30ed\u30b0\u30a4\u30f3\u7528\u30e1\u30fc\u30eb\u30a2\u30c9\u30ec\u30b9\n        //  [2] \u30ed\u30b0\u30a4\u30f3\u7528\u30d1\u30b9\u30ef\u30fc\u30c9\n        String keywords = \"<\u5b9f\u884c\u30d5\u30a1\u30a4\u30eb\u5f15\u65701>\";\n        String mail = \"<\u5b9f\u884c\u30d5\u30a1\u30a4\u30eb\u5f15\u65702>\";\n        String password = \"<\u5b9f\u884c\u30d5\u30a1\u30a4\u30eb\u5f15\u65703>\"; \n        if(0 < args.length){\n            keywords = args[0];\n            if(1 < args.length){\n                mail = args[1];\n                if(2 < args.length){\n                    password = args[2];\n                }\n            }\n        }\n        WebDriver driver = new FirefoxDriver();\n        driver.manage().window().maximize();\n        createSearchResultFile(driver, keywords, getSearchResult(driver, keywords, mail, password));\n        driver.quit();\n    }\n\n    private static SortedMap<String,NicoNicoSeigaInfo> getSearchResult(\n        WebDriver driver, \n        String keywords,\n        String mail,\n        String password\n            ){\n        SortedMap<String,NicoNicoSeigaInfo> results = new TreeMap<String,NicoNicoSeigaInfo>();\n        // \u30a4\u30e9\u30b9\u30c8\u60c5\u5831\u3092\u53d6\u5f97\u3059\u308b\n        NicoNicoSeigaInfo seigaInfo = getSeigaInfo(driver,keywords,mail,password);\n        while(! (seigaInfo == null)){\n            results.put(seigaInfo.getId(),seigaInfo);\n            seigaInfo = getSeigaInfo(driver,keywords,mail,password);\n        }\n        // \u30a4\u30e9\u30b9\u30c8\u60c5\u5831\u3092\u8fd4\u5374\u3059\u308b\n        return results;\n    }\n\n    private static int Indexseiga = -1;\n    private static NicoNicoSeigaInfo getSeigaInfo(\n        WebDriver driver,\n        String keywords,\n        String mail,\n        String password\n            ){\n        Indexseiga += 1;\n        int indexseigas = Indexseiga % IndexMaxPage;\n        if(Indexseiga == 0){\n            // \u30bf\u30b0\u691c\u7d22\u7d50\u679c\u4e00\u89a7\u753b\u9762 \u521d\u671f\u30da\u30fc\u30b8\u8868\u793a\u6642\n            // \u30bf\u30b0\u691c\u7d22\u7d50\u679c\u4e00\u89a7\u753b\u9762\u3078\u9077\u79fb\u3059\u308b\n            driver.get(\"http://seiga.nicovideo.jp/tag/\" + keywords + \"?sort=image_created&target=illust_all\");\n            waitAfterTransaction();\n            // \u30ed\u30b0\u30a4\u30f3\u6709\u7121\u3092\u5224\u5b9a\u3059\u308b\n            List<WebElement> elements = driver.findElements(By.cssSelector(\".siteHeaderLogin > a\"));\n            if(0 < elements.size()){\n                // \u30ed\u30b0\u30a4\u30f3\u7121\u3057\u6642\n                // \u30ed\u30b0\u30a4\u30f3\u753b\u9762\u3078\u9077\u79fb\u3059\u308b\n                elements.get(0).click();\n                waitAfterTransaction();\n                // \u30e1\u30fc\u30eb\u3092\u5165\u529b\u3059\u308b\n                simulateSendKeys(driver.findElements(By.id(\"mail\")).get(0),mail);\n                waitSimulateChangingFocus();\n                // \u30d1\u30b9\u30ef\u30fc\u30c9\u3092\u5165\u529b\u3059\u308b\n                simulateSendKeys(driver.findElements(By.id(\"password\")).get(0),password);\n                waitSimulateChangingFocus();\n                // \u30ed\u30b0\u30a4\u30f3\u30dc\u30bf\u30f3\u3092\u62bc\u3059\n                driver.findElements(By.cssSelector(\".login_button > input\")).get(0).click();\n                waitAfterTransaction();\n                // \u30bf\u30b0\u691c\u7d22\u7d50\u679c\u4e00\u89a7\u753b\u9762\u3078\u9077\u79fb\u3059\u308b\n                driver.get(\"http://seiga.nicovideo.jp/tag/\" + keywords + \"?sort=image_created&target=illust_all\");\n                waitAfterTransaction();\n            }\n        }else if(indexseigas == 0){\n            // \u30bf\u30b0\u691c\u7d22\u7d50\u679c\u4e00\u89a7\u753b\u9762 \u6b21\u30da\u30fc\u30b8\u8868\u793a\u6642\n            List<WebElement> nextButtons = driver.findElements(By.cssSelector(\".next > a\"));\n            if(nextButtons.isEmpty()){\n                // \u6b21\u30da\u30fc\u30b8\u30dc\u30bf\u30f3\u3092\u7121\u52b9\u306a\u6642\n                return null;\n            }else{\n                // \u6b21\u30da\u30fc\u30b8\u30dc\u30bf\u30f3\u3092\u6709\u52b9\u306a\u6642\n                // \u6b21\u30da\u30fc\u30b8\u30dc\u30bf\u30f3\u3092\u62bc\u3059\n                nextButtons.get(0).click();\n                waitAfterTransaction();\n            }\n        }\n\n        // \u30a4\u30e9\u30b9\u30c8\u3092\u9078\u3076\n        List<WebElement> seigas = driver.findElements(By.cssSelector(\".list_item > a\"));\n        if(! (indexseigas < seigas.size())){\n            // \u30a4\u30e9\u30b9\u30c8\u60c5\u5831\u53d6\u5f97\u5b8c\u4e86\u6642\n            return null;\n        }\n        waitSimulateChoosingSeiga();\n        // \u30a4\u30e9\u30b9\u30c8\u3092\u30af\u30ea\u30c3\u30af\u3059\u308b\n        seigas.get(indexseigas).click();\n        waitAfterTransaction();\n        List<WebElement> checkboxs = driver.findElements(By.name(\"skip\"));\n        if(0 < checkboxs.size()){\n            // \u6625\u753b\u30b3\u30f3\u30c6\u30f3\u30c4\u306e\u8b66\u544a\u753b\u9762\u8868\u793a\u6642\n            checkboxs.get(0).click();\n            waitSimulateChangingFocus();\n            driver.findElements(By.id(\"yes\")).get(0).click();\n            waitAfterTransaction();\n        }\n        //\u521d\u671f\u30a4\u30e9\u30b9\u30c8\u60c5\u5831\u3092\u7528\u610f\u3059\u308b\n        String[] urlParts = driver.getCurrentUrl().split(\"/\");\n        NicoNicoSeigaInfo seigaInfo = new NicoNicoSeigaInfo(\n            urlParts[urlParts.length - 1],\n            \"\",\n            \"\",\n            \"\",\n            (new String[0]),\n            (new Date(0)),\n            driver.getCurrentUrl());\n        List<WebElement> errtitles = driver.findElements(By.id(\"error_ttl\"));\n        if(0 < errtitles.size()){\n            // \u30a8\u30e9\u30fc\u753b\u9762\u8868\u793a\u6642\n            driver.navigate().back();\n            waitAfterTransaction();\n            return seigaInfo;\n        }\n\n        // \u6625\u753b\u30b3\u30f3\u30c6\u30f3\u30c4\u306e\u5224\u5b9a\u3092\u3059\u308b\n        boolean isR15 = 0 < driver.findElements(By.cssSelector(\".illust_type\")).size();\n\n        // \u30a4\u30e9\u30b9\u30c8\u3092\u898b\u308b\n        // img\u8981\u7d20(\u4e2d\u592e\u30a4\u30e9\u30b9\u30c8)\u306e\u53d6\u5f97\u306b\u307e\u308c\u306b\u5931\u6557\u3059\u308b\u3002\u6c17\u4f11\u3081\u306b0.5\u79d2\u505c\u6b62\u3059\u308b\u3002\n        wait(500);\n        scroll4WatchingSeiga(driver,driver.findElements(By.cssSelector(\"#illust_link > img\")).get(0).getLocation().y);\n        waitSimulateWatchingSeiga();\n        // \u30a4\u30e9\u30b9\u30c8\u60c5\u5831\u3092\u53d6\u5f97\u3059\u308b        \n        ArrayList<String> tagValues = new ArrayList<String>();\n        for(WebElement tag:(driver.findElements(By.cssSelector(\".tag\")))){\n            String tagValue = tag.getText();\n            if(0 < tagValue.length()){\n                // \u30bf\u30b0\u304c\u7a7a\u3067\u306a\u3044\u6642\n                tagValues.add(tagValue);\n            }\n        };\n\n        try{\n            seigaInfo = \n                new NicoNicoSeigaInfo( \n                    urlParts[urlParts.length - 1],\n                    driver.findElements(By.cssSelector(isR15 ? \".title_text\" : \".title\")).get(0).getText(),\n                    driver.findElements(By.cssSelector(\"#sg_pankuzu li:nth-child(2) > a > span\")).get(0).getText().replace(\" \u3055\u3093\u306e\u30a4\u30e9\u30b9\u30c8\", \"\"),\n                    driver.findElements(By.cssSelector(isR15 ? \".illust_user_exp\" : \".discription\")).get(0).getText(),\n                    (String[])tagValues.toArray(new String[tagValues.size()]),\n                    (new SimpleDateFormat(isR15 ? \"yyyy'\u5e74'MM'\u6708'dd'\u65e5 'HH':'mm':'ss\" : \"yyyy'\u5e74'MM'\u6708'dd'\u65e5 'HH':'mm\")).parse(\n                        driver.findElements(By.cssSelector(isR15 ? \".created_date\" : \".other_info > .date\")).get(0).getText().replace(\"&nbsp;\u6295\u7a3f\", \"\")),\n                    driver.getCurrentUrl()\n                        );\n        }catch(ParseException e){\n            e.printStackTrace();            \n        }\n        driver.navigate().back();\n        waitAfterTransaction();\n\n        return seigaInfo;\n    }\n\n    private static void simulateSendKeys(WebElement element, String keyword){\n        char[] keys = keyword.toCharArray();\n        for(char key:keys){\n            element.sendKeys();\n            element.sendKeys(String.valueOf(key));\n            waitSimulateInputingChar();\n        }\n    }\n\n    private static void waitAfterTransaction(){\n        int minWaitTime = 1000;\n        int maxWaitTime = 2000;\n        wait(getRandomInt(minWaitTime,maxWaitTime));\n    }\n\n    private static void waitSimulateChoosingSeiga(){\n        int minWaitTime = 1000;\n        int maxWaitTime = 2000;\n        wait(getRandomInt(minWaitTime,maxWaitTime));\n    }\n\n    private static void scroll4WatchingSeiga(WebDriver driver, int length){\n        int minScrollLength = 35;\n        int maxScrollLength = 45;\n        scroll(driver,0,length - getRandomInt(minScrollLength,maxScrollLength));\n    }\n\n    private static void waitSimulateWatchingSeiga(){\n        int minWaitTime = 4000;\n        int maxWaitTime = 5000;\n        wait(getRandomInt(minWaitTime,maxWaitTime));\n    }\n\n    private static void waitSimulateInputingChar(){\n        int minWaitTime = 50;\n        int maxWaitTime = 250;\n        wait(getRandomInt(minWaitTime,maxWaitTime));\n    }\n\n    private static void waitSimulateChangingFocus(){\n        int minWaitTime = 200;\n        int maxWaitTime = 500;\n        wait(getRandomInt(minWaitTime,maxWaitTime));\n    }\n\n    private static void wait(int millisecond) {\n        try {\n            Thread.sleep(millisecond);\n        } catch (InterruptedException e) {\n            e.printStackTrace();\n        }\n    }\n\n    private static void scroll(WebDriver driver, int scrollX, int scrollY){\n        ((JavascriptExecutor)driver).executeScript(\"scroll(\" + scrollX + \", \" + scrollY + \")\");\n    }\n\n    private static int getRandomInt(int minWaitTime, int maxWaitTime){\n        int sleepTime = -1;\n        while(! (minWaitTime <= sleepTime)){\n            sleepTime = (int)Math.round(Math.random() * maxWaitTime);\n        }\n        return sleepTime;\n    }\n\n    private static void createSearchResultFile(\n        WebDriver driver,\n        String keywords,\n        SortedMap<String,NicoNicoSeigaInfo> results\n            ){\n        Date now = new Date();\n        SimpleDateFormat sdf4fileName = new SimpleDateFormat(\"yyyyMMddHHmm\");\n        SimpleDateFormat sdf4created = new SimpleDateFormat(\"yyyy'-'MM'-'dd' 'HH':'mm':'ss\");\n        try{\n            // \u65b0\u898fXML\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u308b\n            File file = new File(keywords.replace(\" \", \"-\") + \"_\" + sdf4fileName.format(now) + \".XML\");\n            // \u30a4\u30e9\u30b9\u30c8\u60c5\u5831\u3092\u30d5\u30a1\u30a4\u30eb\u306b\u66f8\u304d\u8fbc\u3080\n            PrintWriter pw = new PrintWriter(new BufferedWriter(new FileWriter(file)));\n            pw.println(\"<?xml version=\\\"1.0\\\" encoding=\\\"UTF-8\\\"?>\");\n            pw.println(\"<response>\");\n            for(NicoNicoSeigaInfo seigaInfo:results.values()){\n                pw.println(\"  <image>\");\n                pw.println(\"    <id>\" + seigaInfo.getId() + \"</id>\");            \n                pw.println(\"    <title>\" + seigaInfo.getTitle() + \"</title>\");\n                pw.println(\"    <user_name>\" + seigaInfo.getUserName() + \"</user_name>\");            \n                pw.println(\"    <description>\" + seigaInfo.getDescription() + \"</description>\");            \n                pw.println(\"    <tag_list>\");\n                for(String tag:(seigaInfo.getTagList())){\n                    pw.println(\"      <tag>\");\n                    pw.println(\"        <name>\" + tag + \"</name>\");                \n                    pw.println(\"      </tag>\");\n                }\n                pw.println(\"    </tag_list>\");\n                pw.println(\"    <created>\" + sdf4created.format(seigaInfo.getCreated()) + \"</created>\"); \n                pw.println(\"    <original_url>\" + seigaInfo.getOriginalUrl() + \"</original_url>\");            \n                pw.println(\"  </image>\");\n            }\n            pw.println(\"</response>\");\n            pw.close();\n        }catch(IOException e){\n            e.printStackTrace();\n        }\n    }\n}\n\n\n\nNicoNicoSeigaInfo.java\n/**\nNicoNicoSeigaCrawler\nCopyright (c) 2014 nezuq\nThis software is released under the MIT License.\nhttp://opensource.org/licenses/mit-license.php\n*/\n\nimport java.util.*;\n\npublic class NicoNicoSeigaInfo {\n    private String id;\n    private String title;\n    private String user_name;\n    private String description;\n    private String[] tag_list;\n    private Date created;\n    private String original_url;\n\n    NicoNicoSeigaInfo(\n        String id,\n        String title,\n        String user_name,\n        String description,\n        String[] tag_list,\n        Date created,\n        String original_url\n            ){\n        this.id = id;\n        this.title = title;\n        this.user_name = user_name;\n        this.description = description;\n        this.tag_list = tag_list;\n        this.created = created;\n        this.original_url = original_url;\n    }\n\n    public String getId()\n    {\n        return this.id;\n    }\n\n    public String getTitle()\n    {\n        return this.title;\n    }\n\n    public String getUserName()\n    {\n        return this.user_name;\n    }\n\n    public String getDescription()\n    {\n        return this.description;\n    }\n\n    public String[] getTagList()\n    {\n        return this.tag_list;\n    }\n\n    public Date getCreated()\n    {\n        return this.created;\n    }\n\n    public String getOriginalUrl()\n    {\n        return this.original_url;\n    }\n\n}\n\n\n\nLICENSE.txt\nThe MIT License (MIT)\n\nCopyright (c) 2014 nezuq\n\nPermission is hereby granted, free of charge, to any person obtaining a copy\nof this software and associated documentation files (the \"Software\"), to deal\nin the Software without restriction, including without limitation the rights\nto use, copy, modify, merge, publish, distribute, sublicense, and/or sell\ncopies of the Software, and to permit persons to whom the Software is\nfurnished to do so, subject to the following conditions:\n\nThe above copyright notice and this permission notice shall be included in\nall copies or substantial portions of the Software.\n\nTHE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\nIMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\nFITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\nAUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\nLIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\nOUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\nTHE SOFTWARE.\n\n\n04.Jar\u30d5\u30a1\u30a4\u30eb\u3068\u3057\u3066\u51fa\u529b\u3059\u308b\u3002\n05.\u30b3\u30de\u30f3\u30c9\u30d7\u30ed\u30f3\u30d7\u30c8\uff08\u7aef\u672b\uff09\u304b\u3089\u5b9f\u884c\u3059\u308b\u3002\n\n\u30af\u30ed\u30fc\u30e9\u30fc(Firefox)\u3092\u8d77\u52d5\u3059\u308b\njava -jar ./NicoNicoSeigaCrawler.jar \"<\u691c\u7d22\u30bf\u30b0>(\u30b9\u30da\u30fc\u30b9\u533a\u5207\u308a\u3067\u8907\u6570\u6307\u5b9a\u53ef)\" \"<\u30cb\u30b3\u30cb\u30b3\u9759\u753b\u767b\u9332\u30e1\u30fc\u30eb\u30a2\u30c9\u30ec\u30b9>\" \"<\u30cb\u30b3\u30cb\u30b3\u9759\u753b\u767b\u9332\u30d1\u30b9\u30ef\u30fc\u30c9>\"\n\n\n\u306a\u304a\u3001\u51fa\u529b\u3055\u308c\u308b\u4f5c\u54c1\u30c7\u30fc\u30bf\u30d5\u30a1\u30a4\u30eb\u306f\u4ee5\u4e0b\u306e\u5f62\u5f0f\u306b\u306a\u308b\u3002\n\n\u691c\u7d22\u30bf\u30b01-\u691c\u7d22\u30bf\u30b02_yyyyMMddhhmmss.XML\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<response>\n  <image>\n    <id>im0000000</id>\n    <title>\u30a4\u30e9\u30b9\u30c8\u306e\u30bf\u30a4\u30c8\u30eb</title>\n    <user_name>\u30a2\u30ab\u30a6\u30f3\u30c8\u540d</user_name>\n    <description>\u30ad\u30e3\u30d7\u30b7\u30e7\u30f3</description>\n    <tag_list>\n      <tag>\n        <name>\u30bf\u30b01</name>\n      </tag>\n      <tag>\n        <name>\u30bf\u30b02</name>\n      </tag>\n      <tag>\n        <name>\u30bf\u30b0N</name>\n      </tag>\n    </tag_list>\n    <created>yyyy-MM-dd hh:mm:ss</created>\n    <original_url>http://seiga.nicovideo.jp/seiga/im0000000</original_url>\n  </image>\n</response>\n\n\n#\u6982\u8981\nUI\u30c6\u30b9\u30c8\u81ea\u52d5\u5316\u30c4\u30fc\u30eb\u300c[Selenium WebDriver](http://docs.seleniumhq.org/docs/03_webdriver.jsp)\u300d\u3092\n[\u30cb\u30b3\u30cb\u30b3\u9759\u753b](http://seiga.nicovideo.jp/?track=home)\u7528\u306e\u30af\u30ed\u30fc\u30e9\u30fc\u306b\u8ee2\u7528\u3057\u3066\u307f\u305f\u3002\n\n\u30bf\u30b0\u691c\u7d22\u7d50\u679c\u306e\u30a4\u30e9\u30b9\u30c8\u7fa4\uff08\u3082\u3061\u308d\u3093\u6625\u753b\u3082\uff01\uff09\u3092\n\u30b9\u30e9\u30a4\u30c9\u30b7\u30e7\u30fc\u306e\u3088\u3046\u306b\u8868\u793a\u3057\u306a\u304c\u3089\n\u4f5c\u54c1\u30c7\u30fc\u30bf\u3092\u53ce\u96c6\u3067\u304d\u305f\u3089\u3001\n\u305d\u308c\u306f\u3068\u3063\u3066\u3082\u7d20\u6575\u3060\u306a\u3063\u3066\u601d\u3063\u305f\u3002\n\n#\u4f5c\u696d\n01.Firefox\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u3002\n02.Selenium WebDriver\u3092\u5916\u90e8\u53c2\u7167\u3059\u308bJava\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u3092\u4f5c\u308b\u3002\n\u3000\u3000 \u624b\u9806\u306f[\u3053\u3061\u3089\u306e\u30b5\u30a4\u30c8](http://blog.asial.co.jp/1180)\u3092\u53c2\u8003\u306b\u3055\u305b\u3066\u3044\u305f\u3060\u3044\u305f\u3002\n03.\u4e0b\u8a18\u30b3\u30fc\u30c9\u3092\u5b9f\u88c5\u3059\u308b\u3002\n\n```java:NicoNicoSeigaCrawler.java\n/**\nNicoNicoSeigaCrawler\nCopyright (c) 2014 nezuq\nThis software is released under the MIT License.\nhttp://opensource.org/licenses/mit-license.php\n*/\n\nimport java.io.File;\nimport java.io.FileWriter;\nimport java.io.BufferedWriter;\nimport java.io.PrintWriter;\nimport java.io.IOException;\nimport java.util.*;\nimport java.text.*;\nimport org.openqa.selenium.WebDriver;\nimport org.openqa.selenium.WebElement;\nimport org.openqa.selenium.By;\nimport org.openqa.selenium.JavascriptExecutor;\nimport org.openqa.selenium.firefox.FirefoxDriver;\n \n \npublic class NicoNicoSeigaCrawler {\n\t\t\n    private static final int IndexMaxPage = 40; \n    \n    public static void main(String[] args) {\n    \t// \u5b9f\u884c\u30d5\u30a1\u30a4\u30eb\u306e\u5f15\u6570\u3092\u53d7\u3051\u53d6\u308b\n    \t//  [0] \u691c\u7d22\u30ad\u30fc\u30ef\u30fc\u30c9\n    \t//  [1] \u30ed\u30b0\u30a4\u30f3\u7528\u30e1\u30fc\u30eb\u30a2\u30c9\u30ec\u30b9\n    \t//  [2] \u30ed\u30b0\u30a4\u30f3\u7528\u30d1\u30b9\u30ef\u30fc\u30c9\n        String keywords = \"<\u5b9f\u884c\u30d5\u30a1\u30a4\u30eb\u5f15\u65701>\";\n        String mail = \"<\u5b9f\u884c\u30d5\u30a1\u30a4\u30eb\u5f15\u65702>\";\n        String password = \"<\u5b9f\u884c\u30d5\u30a1\u30a4\u30eb\u5f15\u65703>\"; \n        if(0 < args.length){\n        \tkeywords = args[0];\n            if(1 < args.length){\n            \tmail = args[1];\n                if(2 < args.length){\n                \tpassword = args[2];\n                }\n            }\n        }\n        WebDriver driver = new FirefoxDriver();\n        driver.manage().window().maximize();\n        createSearchResultFile(driver, keywords, getSearchResult(driver, keywords, mail, password));\n        driver.quit();\n    }\n    \n    private static SortedMap<String,NicoNicoSeigaInfo> getSearchResult(\n        WebDriver driver, \n        String keywords,\n        String mail,\n        String password\n            ){\n        SortedMap<String,NicoNicoSeigaInfo> results = new TreeMap<String,NicoNicoSeigaInfo>();\n        // \u30a4\u30e9\u30b9\u30c8\u60c5\u5831\u3092\u53d6\u5f97\u3059\u308b\n        NicoNicoSeigaInfo seigaInfo = getSeigaInfo(driver,keywords,mail,password);\n        while(! (seigaInfo == null)){\n            results.put(seigaInfo.getId(),seigaInfo);\n            seigaInfo = getSeigaInfo(driver,keywords,mail,password);\n        }\n        // \u30a4\u30e9\u30b9\u30c8\u60c5\u5831\u3092\u8fd4\u5374\u3059\u308b\n        return results;\n    }\n    \n    private static int Indexseiga = -1;\n    private static NicoNicoSeigaInfo getSeigaInfo(\n        WebDriver driver,\n        String keywords,\n    \tString mail,\n        String password\n            ){\n        Indexseiga += 1;\n        int indexseigas = Indexseiga % IndexMaxPage;\n        if(Indexseiga == 0){\n        \t// \u30bf\u30b0\u691c\u7d22\u7d50\u679c\u4e00\u89a7\u753b\u9762 \u521d\u671f\u30da\u30fc\u30b8\u8868\u793a\u6642\n        \t// \u30bf\u30b0\u691c\u7d22\u7d50\u679c\u4e00\u89a7\u753b\u9762\u3078\u9077\u79fb\u3059\u308b\n            driver.get(\"http://seiga.nicovideo.jp/tag/\" + keywords + \"?sort=image_created&target=illust_all\");\n            waitAfterTransaction();\n            // \u30ed\u30b0\u30a4\u30f3\u6709\u7121\u3092\u5224\u5b9a\u3059\u308b\n            List<WebElement> elements = driver.findElements(By.cssSelector(\".siteHeaderLogin > a\"));\n            if(0 < elements.size()){\n            \t// \u30ed\u30b0\u30a4\u30f3\u7121\u3057\u6642\n            \t// \u30ed\u30b0\u30a4\u30f3\u753b\u9762\u3078\u9077\u79fb\u3059\u308b\n            \telements.get(0).click();\n                waitAfterTransaction();\n            \t// \u30e1\u30fc\u30eb\u3092\u5165\u529b\u3059\u308b\n                simulateSendKeys(driver.findElements(By.id(\"mail\")).get(0),mail);\n                waitSimulateChangingFocus();\n            \t// \u30d1\u30b9\u30ef\u30fc\u30c9\u3092\u5165\u529b\u3059\u308b\n                simulateSendKeys(driver.findElements(By.id(\"password\")).get(0),password);\n                waitSimulateChangingFocus();\n            \t// \u30ed\u30b0\u30a4\u30f3\u30dc\u30bf\u30f3\u3092\u62bc\u3059\n                driver.findElements(By.cssSelector(\".login_button > input\")).get(0).click();\n                waitAfterTransaction();\n            \t// \u30bf\u30b0\u691c\u7d22\u7d50\u679c\u4e00\u89a7\u753b\u9762\u3078\u9077\u79fb\u3059\u308b\n                driver.get(\"http://seiga.nicovideo.jp/tag/\" + keywords + \"?sort=image_created&target=illust_all\");\n                waitAfterTransaction();\n            }\n        }else if(indexseigas == 0){\n        \t// \u30bf\u30b0\u691c\u7d22\u7d50\u679c\u4e00\u89a7\u753b\u9762 \u6b21\u30da\u30fc\u30b8\u8868\u793a\u6642\n            List<WebElement> nextButtons = driver.findElements(By.cssSelector(\".next > a\"));\n            if(nextButtons.isEmpty()){\n            \t// \u6b21\u30da\u30fc\u30b8\u30dc\u30bf\u30f3\u3092\u7121\u52b9\u306a\u6642\n                return null;\n            }else{\n            \t// \u6b21\u30da\u30fc\u30b8\u30dc\u30bf\u30f3\u3092\u6709\u52b9\u306a\u6642\n            \t// \u6b21\u30da\u30fc\u30b8\u30dc\u30bf\u30f3\u3092\u62bc\u3059\n                nextButtons.get(0).click();\n                waitAfterTransaction();\n            }\n        }\n        \n        // \u30a4\u30e9\u30b9\u30c8\u3092\u9078\u3076\n        List<WebElement> seigas = driver.findElements(By.cssSelector(\".list_item > a\"));\n        if(! (indexseigas < seigas.size())){\n        \t// \u30a4\u30e9\u30b9\u30c8\u60c5\u5831\u53d6\u5f97\u5b8c\u4e86\u6642\n            return null;\n        }\n        waitSimulateChoosingSeiga();\n        // \u30a4\u30e9\u30b9\u30c8\u3092\u30af\u30ea\u30c3\u30af\u3059\u308b\n    \tseigas.get(indexseigas).click();\n        waitAfterTransaction();\n        List<WebElement> checkboxs = driver.findElements(By.name(\"skip\"));\n        if(0 < checkboxs.size()){\n            // \u6625\u753b\u30b3\u30f3\u30c6\u30f3\u30c4\u306e\u8b66\u544a\u753b\u9762\u8868\u793a\u6642\n        \tcheckboxs.get(0).click();\n            waitSimulateChangingFocus();\n        \tdriver.findElements(By.id(\"yes\")).get(0).click();\n            waitAfterTransaction();\n        }\n        //\u521d\u671f\u30a4\u30e9\u30b9\u30c8\u60c5\u5831\u3092\u7528\u610f\u3059\u308b\n        String[] urlParts = driver.getCurrentUrl().split(\"/\");\n        NicoNicoSeigaInfo seigaInfo = new NicoNicoSeigaInfo(\n        \turlParts[urlParts.length - 1],\n        \t\"\",\n        \t\"\",\n        \t\"\",\n        \t(new String[0]),\n        \t(new Date(0)),\n        \tdriver.getCurrentUrl());\n        List<WebElement> errtitles = driver.findElements(By.id(\"error_ttl\"));\n        if(0 < errtitles.size()){\n            // \u30a8\u30e9\u30fc\u753b\u9762\u8868\u793a\u6642\n            driver.navigate().back();\n            waitAfterTransaction();\n        \treturn seigaInfo;\n        }\n        \n        // \u6625\u753b\u30b3\u30f3\u30c6\u30f3\u30c4\u306e\u5224\u5b9a\u3092\u3059\u308b\n        boolean isR15 = 0 < driver.findElements(By.cssSelector(\".illust_type\")).size();\n        \n        // \u30a4\u30e9\u30b9\u30c8\u3092\u898b\u308b\n        // img\u8981\u7d20(\u4e2d\u592e\u30a4\u30e9\u30b9\u30c8)\u306e\u53d6\u5f97\u306b\u307e\u308c\u306b\u5931\u6557\u3059\u308b\u3002\u6c17\u4f11\u3081\u306b0.5\u79d2\u505c\u6b62\u3059\u308b\u3002\n        wait(500);\n        scroll4WatchingSeiga(driver,driver.findElements(By.cssSelector(\"#illust_link > img\")).get(0).getLocation().y);\n        waitSimulateWatchingSeiga();\n        // \u30a4\u30e9\u30b9\u30c8\u60c5\u5831\u3092\u53d6\u5f97\u3059\u308b        \n        ArrayList<String> tagValues = new ArrayList<String>();\n        for(WebElement tag:(driver.findElements(By.cssSelector(\".tag\")))){\n        \tString tagValue = tag.getText();\n        \tif(0 < tagValue.length()){\n        \t\t// \u30bf\u30b0\u304c\u7a7a\u3067\u306a\u3044\u6642\n                tagValues.add(tagValue);\n        \t}\n        };\n        \n        try{\n            seigaInfo = \n                new NicoNicoSeigaInfo( \n                    urlParts[urlParts.length - 1],\n                    driver.findElements(By.cssSelector(isR15 ? \".title_text\" : \".title\")).get(0).getText(),\n                    driver.findElements(By.cssSelector(\"#sg_pankuzu li:nth-child(2) > a > span\")).get(0).getText().replace(\" \u3055\u3093\u306e\u30a4\u30e9\u30b9\u30c8\", \"\"),\n                    driver.findElements(By.cssSelector(isR15 ? \".illust_user_exp\" : \".discription\")).get(0).getText(),\n                    (String[])tagValues.toArray(new String[tagValues.size()]),\n                    (new SimpleDateFormat(isR15 ? \"yyyy'\u5e74'MM'\u6708'dd'\u65e5 'HH':'mm':'ss\" : \"yyyy'\u5e74'MM'\u6708'dd'\u65e5 'HH':'mm\")).parse(\n                        driver.findElements(By.cssSelector(isR15 ? \".created_date\" : \".other_info > .date\")).get(0).getText().replace(\"&nbsp;\u6295\u7a3f\", \"\")),\n                    driver.getCurrentUrl()\n                        );\n        }catch(ParseException e){\n            e.printStackTrace();            \n        }\n        driver.navigate().back();\n        waitAfterTransaction();\n        \n        return seigaInfo;\n    }\n    \n    private static void simulateSendKeys(WebElement element, String keyword){\n    \tchar[] keys = keyword.toCharArray();\n    \tfor(char key:keys){\n    \t\telement.sendKeys();\n        \telement.sendKeys(String.valueOf(key));\n        \twaitSimulateInputingChar();\n    \t}\n    }\n    \n    private static void waitAfterTransaction(){\n        int minWaitTime = 1000;\n        int maxWaitTime = 2000;\n        wait(getRandomInt(minWaitTime,maxWaitTime));\n    }\n    \n    private static void waitSimulateChoosingSeiga(){\n        int minWaitTime = 1000;\n        int maxWaitTime = 2000;\n        wait(getRandomInt(minWaitTime,maxWaitTime));\n    }\n    \n    private static void scroll4WatchingSeiga(WebDriver driver, int length){\n        int minScrollLength = 35;\n        int maxScrollLength = 45;\n        scroll(driver,0,length - getRandomInt(minScrollLength,maxScrollLength));\n    }\n    \n    private static void waitSimulateWatchingSeiga(){\n        int minWaitTime = 4000;\n        int maxWaitTime = 5000;\n        wait(getRandomInt(minWaitTime,maxWaitTime));\n    }\n    \n    private static void waitSimulateInputingChar(){\n        int minWaitTime = 50;\n        int maxWaitTime = 250;\n        wait(getRandomInt(minWaitTime,maxWaitTime));\n    }\n    \n    private static void waitSimulateChangingFocus(){\n        int minWaitTime = 200;\n        int maxWaitTime = 500;\n        wait(getRandomInt(minWaitTime,maxWaitTime));\n    }\n    \n    private static void wait(int millisecond) {\n        try {\n            Thread.sleep(millisecond);\n        } catch (InterruptedException e) {\n            e.printStackTrace();\n        }\n    }\n    \n    private static void scroll(WebDriver driver, int scrollX, int scrollY){\n        ((JavascriptExecutor)driver).executeScript(\"scroll(\" + scrollX + \", \" + scrollY + \")\");\n    }\n    \n\tprivate static int getRandomInt(int minWaitTime, int maxWaitTime){\n\t    int sleepTime = -1;\n\t    while(! (minWaitTime <= sleepTime)){\n\t        sleepTime = (int)Math.round(Math.random() * maxWaitTime);\n\t    }\n\t    return sleepTime;\n\t}\n    \n    private static void createSearchResultFile(\n        WebDriver driver,\n        String keywords,\n        SortedMap<String,NicoNicoSeigaInfo> results\n            ){\n        Date now = new Date();\n        SimpleDateFormat sdf4fileName = new SimpleDateFormat(\"yyyyMMddHHmm\");\n        SimpleDateFormat sdf4created = new SimpleDateFormat(\"yyyy'-'MM'-'dd' 'HH':'mm':'ss\");\n        try{\n        \t// \u65b0\u898fXML\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u308b\n            File file = new File(keywords.replace(\" \", \"-\") + \"_\" + sdf4fileName.format(now) + \".XML\");\n        \t// \u30a4\u30e9\u30b9\u30c8\u60c5\u5831\u3092\u30d5\u30a1\u30a4\u30eb\u306b\u66f8\u304d\u8fbc\u3080\n            PrintWriter pw = new PrintWriter(new BufferedWriter(new FileWriter(file)));\n            pw.println(\"<?xml version=\\\"1.0\\\" encoding=\\\"UTF-8\\\"?>\");\n            pw.println(\"<response>\");\n            for(NicoNicoSeigaInfo seigaInfo:results.values()){\n                pw.println(\"  <image>\");\n                pw.println(\"    <id>\" + seigaInfo.getId() + \"</id>\");            \n                pw.println(\"    <title>\" + seigaInfo.getTitle() + \"</title>\");\n                pw.println(\"    <user_name>\" + seigaInfo.getUserName() + \"</user_name>\");            \n                pw.println(\"    <description>\" + seigaInfo.getDescription() + \"</description>\");            \n                pw.println(\"    <tag_list>\");\n                for(String tag:(seigaInfo.getTagList())){\n                    pw.println(\"      <tag>\");\n                    pw.println(\"        <name>\" + tag + \"</name>\");                \n                    pw.println(\"      </tag>\");\n                }\n                pw.println(\"    </tag_list>\");\n                pw.println(\"    <created>\" + sdf4created.format(seigaInfo.getCreated()) + \"</created>\"); \n                pw.println(\"    <original_url>\" + seigaInfo.getOriginalUrl() + \"</original_url>\");            \n                pw.println(\"  </image>\");\n            }\n            pw.println(\"</response>\");\n            pw.close();\n        }catch(IOException e){\n            e.printStackTrace();\n        }\n    }\n}\n```\n\n```java:NicoNicoSeigaInfo.java\n/**\nNicoNicoSeigaCrawler\nCopyright (c) 2014 nezuq\nThis software is released under the MIT License.\nhttp://opensource.org/licenses/mit-license.php\n*/\n\nimport java.util.*;\n \npublic class NicoNicoSeigaInfo {\n    private String id;\n    private String title;\n    private String user_name;\n    private String description;\n    private String[] tag_list;\n    private Date created;\n    private String original_url;\n    \n    NicoNicoSeigaInfo(\n        String id,\n        String title,\n        String user_name,\n        String description,\n        String[] tag_list,\n        Date created,\n        String original_url\n            ){\n        this.id = id;\n        this.title = title;\n        this.user_name = user_name;\n        this.description = description;\n        this.tag_list = tag_list;\n        this.created = created;\n        this.original_url = original_url;\n    }\n    \n    public String getId()\n    {\n        return this.id;\n    }\n \n    public String getTitle()\n    {\n        return this.title;\n    }\n    \n    public String getUserName()\n    {\n        return this.user_name;\n    }\n    \n    public String getDescription()\n    {\n        return this.description;\n    }\n    \n    public String[] getTagList()\n    {\n        return this.tag_list;\n    }\n    \n    public Date getCreated()\n    {\n        return this.created;\n    }\n    \n    public String getOriginalUrl()\n    {\n        return this.original_url;\n    }\n        \n}\n```\n\n```txt:LICENSE.txt\nThe MIT License (MIT)\n\nCopyright (c) 2014 nezuq\n\nPermission is hereby granted, free of charge, to any person obtaining a copy\nof this software and associated documentation files (the \"Software\"), to deal\nin the Software without restriction, including without limitation the rights\nto use, copy, modify, merge, publish, distribute, sublicense, and/or sell\ncopies of the Software, and to permit persons to whom the Software is\nfurnished to do so, subject to the following conditions:\n\nThe above copyright notice and this permission notice shall be included in\nall copies or substantial portions of the Software.\n\nTHE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\nIMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\nFITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\nAUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\nLIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\nOUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\nTHE SOFTWARE.\n```\n\n04.Jar\u30d5\u30a1\u30a4\u30eb\u3068\u3057\u3066\u51fa\u529b\u3059\u308b\u3002\n05.\u30b3\u30de\u30f3\u30c9\u30d7\u30ed\u30f3\u30d7\u30c8\uff08\u7aef\u672b\uff09\u304b\u3089\u5b9f\u884c\u3059\u308b\u3002\n\n```bash:\u30af\u30ed\u30fc\u30e9\u30fc(Firefox)\u3092\u8d77\u52d5\u3059\u308b\njava -jar ./NicoNicoSeigaCrawler.jar \"<\u691c\u7d22\u30bf\u30b0>(\u30b9\u30da\u30fc\u30b9\u533a\u5207\u308a\u3067\u8907\u6570\u6307\u5b9a\u53ef)\" \"<\u30cb\u30b3\u30cb\u30b3\u9759\u753b\u767b\u9332\u30e1\u30fc\u30eb\u30a2\u30c9\u30ec\u30b9>\" \"<\u30cb\u30b3\u30cb\u30b3\u9759\u753b\u767b\u9332\u30d1\u30b9\u30ef\u30fc\u30c9>\"\n```\n\n\u306a\u304a\u3001\u51fa\u529b\u3055\u308c\u308b\u4f5c\u54c1\u30c7\u30fc\u30bf\u30d5\u30a1\u30a4\u30eb\u306f\u4ee5\u4e0b\u306e\u5f62\u5f0f\u306b\u306a\u308b\u3002\n\n```xml:\u691c\u7d22\u30bf\u30b01-\u691c\u7d22\u30bf\u30b02_yyyyMMddhhmmss.XML\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<response>\n  <image>\n    <id>im0000000</id>\n    <title>\u30a4\u30e9\u30b9\u30c8\u306e\u30bf\u30a4\u30c8\u30eb</title>\n    <user_name>\u30a2\u30ab\u30a6\u30f3\u30c8\u540d</user_name>\n    <description>\u30ad\u30e3\u30d7\u30b7\u30e7\u30f3</description>\n    <tag_list>\n      <tag>\n        <name>\u30bf\u30b01</name>\n      </tag>\n      <tag>\n        <name>\u30bf\u30b02</name>\n      </tag>\n      <tag>\n        <name>\u30bf\u30b0N</name>\n      </tag>\n    </tag_list>\n    <created>yyyy-MM-dd hh:mm:ss</created>\n    <original_url>http://seiga.nicovideo.jp/seiga/im0000000</original_url>\n  </image>\n</response>\n```\n"}