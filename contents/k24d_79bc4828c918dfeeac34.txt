{"tags": ["SQL", "hive", "Presto"], "context": " \u3053\u306e\u8a18\u4e8b\u306f\u6700\u7d42\u66f4\u65b0\u65e5\u304b\u30891\u5e74\u4ee5\u4e0a\u304c\u7d4c\u904e\u3057\u3066\u3044\u307e\u3059\u3002\u4e0b\u56f3\u306e\u3088\u3046\u306b\u3001\u300c\u7e26\u6301\u3061\u300d\u306e\u30c6\u30fc\u30d6\u30eb\u3092\u300c\u6a2a\u6301\u3061\u300d\u306b\u7f6e\u304d\u63db\u3048\u308b\u3053\u3068\u3092\u30d4\u30dc\u30c3\u30c8\uff08pivot\uff09\u3001\u9006\u306b\u300c\u6a2a\u6301\u3061\u300d\u306e\u30c6\u30fc\u30d6\u30eb\u3092\u300c\u7e26\u6301\u3061\u300d\u306b\u7f6e\u304d\u63db\u3048\u308b\u3053\u3068\u3092\u30a2\u30f3\u30d4\u30dc\u30c3\u30c8\uff08unpivot\uff09\u3068\u547c\u3073\u307e\u3059\u3002\u3053\u308c\u3089\u306e\u5909\u63db\u3092\u884c\u306a\u3046\u65b9\u6cd5\u3092\u307e\u3068\u3081\u307e\u3057\u305f\u3002\n\n\u6a19\u6e96SQL\nPresto\nHive\nPandas (Python)\n\n\n\n\n\u6a19\u6e96SQL\nSQL-like \u306a\u30af\u30a8\u30ea\u8a00\u8a9e\u306a\u3089\u3069\u3053\u3067\u3082\u4f7f\u3048\u308b\u66f8\u304d\u65b9\u3067\u3059\u3002\nPivot\nSELECT uid,\n       max(CASE WHEN key = 'c1' THEN value END) AS c1,\n       max(CASE WHEN key = 'c2' THEN value END) AS c2,\n       max(CASE WHEN key = 'c3' THEN value END) AS c3\nFROM vtable\nGROUP BY uid\n;\n\nuid  c1  c2  c3\n---  --  --  --\n101  11  12  13\n102  21  22  23\n\nUnpivot\nSELECT uid, 'c1' AS key, c1 AS value FROM htable\nUNION ALL\nSELECT uid, 'c2' AS key, c2 AS value FROM htable\nUNION ALL\nSELECT uid, 'c3' AS key, c3 AS value FROM htable\n;\n\nuid  key  value\n---  ---  -----\n101   c1     11\n102   c1     21\n101   c2     12\n102   c2     22\n101   c3     13\n102   c3     23\n\n\nPresto\n\u6a19\u6e96SQL\u306e\u65b9\u6cd5\u3067\u3082\u69cb\u3044\u307e\u305b\u3093\u304c\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u66f8\u304d\u65b9\u3082\u51fa\u6765\u307e\u3059\u3002\nPivot\nmap_agg \u95a2\u6570\u3067\u30de\u30c3\u30d7\u578b\u306e\u69cb\u9020\u3092\u4f5c\u3063\u3066\u304b\u3089\u53c2\u7167\u3059\u308b\u3084\u308a\u65b9\u3067\u3059\u3002\nSELECT\n  uid,\n  kv['c1'] AS c1,\n  kv['c2'] AS c2,\n  kv['c3'] AS c3\nFROM (\n  SELECT uid, map_agg(key, value) kv\n  FROM vtable\n  GROUP BY uid\n) t\n\nuid  c1  c2  c3\n---  --  --  --\n101  11  12  13\n102  21  22  23\n\nUnpivot\n\u30ab\u30e9\u30e0\u306e\u914d\u5217\u3092\u4f5c\u3063\u3066\u304b\u3089 CROSS JOIN unnest \u3067\u5c55\u958b\u3059\u308b\u3084\u308a\u65b9\u3067\u3059\u3002PostgreSQL \u3067\u3082\u4f7f\u3048\u307e\u3059\u3002\nSELECT t1.uid, t2.key, t2.value\nFROM htable t1\nCROSS JOIN unnest (\n  array['c1', 'c2', 'c3'],\n  array[c1, c2, c3]\n) t2 (key, value)\n\nuid  key  value\n---  ---  -----\n101   c1     11\n101   c2     12\n101   c3     13\n102   c1     21\n102   c2     22\n102   c3     23\n\n\nHive\nPivot\n\u6a19\u6e96\u306e Hive \u95a2\u6570\u3067\u306f\u3042\u308a\u307e\u305b\u3093\u304c\u3001Treasure Data \u306e Hive \u306b\u306f to_map UDAF \u304c\u7d44\u307f\u8fbc\u307e\u308c\u3066\u304a\u308a\u3001\u30de\u30c3\u30d7\u578b\u306e\u69cb\u9020\u3092\u4f5c\u3063\u3066\u304b\u3089\u53c2\u7167\u3059\u308b\u3053\u3068\u304c\u51fa\u6765\u307e\u3059\u3002\nSELECT\n  uid,\n  kv['c1'] AS c1,\n  kv['c2'] AS c2,\n  kv['c3'] AS c3\nFROM (\n  SELECT uid, to_map(key, value) kv\n  FROM vtable\n  GROUP BY uid\n) t\n\nuid  c1  c2  c3\n---  --  --  --\n101  11  12  13\n102  21  22  23\n\nUnpivot\nLATERAL VIEW explode \u3067\u5c55\u958b\u3059\u308b\u65b9\u6cd5\u304c\u3042\u308a\u307e\u3059\u3002\nSELECT t1.uid, t2.key, t2.value\nFROM htable t1\nLATERAL VIEW explode (map(\n  'c1', c1,\n  'c2', c2,\n  'c3', c3\n)) t2 as key, value\n\nuid  key  value\n---  ---  -----\n101   c1     11\n101   c2     12\n101   c3     13\n102   c1     21\n102   c2     22\n102   c3     23\n\n\nPandas\npivot \u3084 melt \u3068\u3044\u3063\u305f\u95a2\u6570\u304c\u4f7f\u3048\u307e\u3059\u3002\nPivot\nIn [1]: vtable.pivot('uid', 'key', 'value')\nOut[1]:\nkey  c1  c2  c3\nuid\n101  11  12  13\n102  21  22  23\n\nUnpivot\nIn [2]: pd.melt(htable, 'uid', var_name='key')\nOut[2]: \n  uid  key  value\n0 101   c1     11\n1 101   c2     12\n2 101   c3     13\n3 102   c1     21\n4 102   c2     22\n5 102   c3     23\n\n\u4e0b\u56f3\u306e\u3088\u3046\u306b\u3001\u300c\u7e26\u6301\u3061\u300d\u306e\u30c6\u30fc\u30d6\u30eb\u3092\u300c\u6a2a\u6301\u3061\u300d\u306b\u7f6e\u304d\u63db\u3048\u308b\u3053\u3068\u3092\u30d4\u30dc\u30c3\u30c8\uff08pivot\uff09\u3001\u9006\u306b\u300c\u6a2a\u6301\u3061\u300d\u306e\u30c6\u30fc\u30d6\u30eb\u3092\u300c\u7e26\u6301\u3061\u300d\u306b\u7f6e\u304d\u63db\u3048\u308b\u3053\u3068\u3092\u30a2\u30f3\u30d4\u30dc\u30c3\u30c8\uff08unpivot\uff09\u3068\u547c\u3073\u307e\u3059\u3002\u3053\u308c\u3089\u306e\u5909\u63db\u3092\u884c\u306a\u3046\u65b9\u6cd5\u3092\u307e\u3068\u3081\u307e\u3057\u305f\u3002\n\n* \u6a19\u6e96SQL\n* Presto\n* Hive\n* Pandas (Python)\n\n![vtable.png](https://qiita-image-store.s3.amazonaws.com/0/1324/89b243c4-1531-6286-fc87-5dca974a6bd8.png)\n\n![htable.png](https://qiita-image-store.s3.amazonaws.com/0/1324/4ecea281-eb8c-7fde-e905-df253e8616bd.png)\n\n# \u6a19\u6e96SQL\n\nSQL-like \u306a\u30af\u30a8\u30ea\u8a00\u8a9e\u306a\u3089\u3069\u3053\u3067\u3082\u4f7f\u3048\u308b\u66f8\u304d\u65b9\u3067\u3059\u3002\n\n**Pivot**\n\n```sql\nSELECT uid,\n       max(CASE WHEN key = 'c1' THEN value END) AS c1,\n       max(CASE WHEN key = 'c2' THEN value END) AS c2,\n       max(CASE WHEN key = 'c3' THEN value END) AS c3\nFROM vtable\nGROUP BY uid\n;\n```\n```\nuid  c1  c2  c3\n---  --  --  --\n101  11  12  13\n102  21  22  23\n```\n\n**Unpivot**\n\n```sql\nSELECT uid, 'c1' AS key, c1 AS value FROM htable\nUNION ALL\nSELECT uid, 'c2' AS key, c2 AS value FROM htable\nUNION ALL\nSELECT uid, 'c3' AS key, c3 AS value FROM htable\n;\n```\n```\nuid  key  value\n---  ---  -----\n101   c1     11\n102   c1     21\n101   c2     12\n102   c2     22\n101   c3     13\n102   c3     23\n```\n\n# Presto\n\n\u6a19\u6e96SQL\u306e\u65b9\u6cd5\u3067\u3082\u69cb\u3044\u307e\u305b\u3093\u304c\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u66f8\u304d\u65b9\u3082\u51fa\u6765\u307e\u3059\u3002\n\n**Pivot**\n``map_agg`` \u95a2\u6570\u3067\u30de\u30c3\u30d7\u578b\u306e\u69cb\u9020\u3092\u4f5c\u3063\u3066\u304b\u3089\u53c2\u7167\u3059\u308b\u3084\u308a\u65b9\u3067\u3059\u3002\n\n```sql\nSELECT\n  uid,\n  kv['c1'] AS c1,\n  kv['c2'] AS c2,\n  kv['c3'] AS c3\nFROM (\n  SELECT uid, map_agg(key, value) kv\n  FROM vtable\n  GROUP BY uid\n) t\n```\n```\nuid  c1  c2  c3\n---  --  --  --\n101  11  12  13\n102  21  22  23\n```\n\n**Unpivot**\n\u30ab\u30e9\u30e0\u306e\u914d\u5217\u3092\u4f5c\u3063\u3066\u304b\u3089 ``CROSS JOIN unnest`` \u3067\u5c55\u958b\u3059\u308b\u3084\u308a\u65b9\u3067\u3059\u3002PostgreSQL \u3067\u3082\u4f7f\u3048\u307e\u3059\u3002\n\n```sql\nSELECT t1.uid, t2.key, t2.value\nFROM htable t1\nCROSS JOIN unnest (\n  array['c1', 'c2', 'c3'],\n  array[c1, c2, c3]\n) t2 (key, value)\n```\n```\nuid  key  value\n---  ---  -----\n101   c1     11\n101   c2     12\n101   c3     13\n102   c1     21\n102   c2     22\n102   c3     23\n```\n\n# Hive\n\n**Pivot**\n\u6a19\u6e96\u306e Hive \u95a2\u6570\u3067\u306f\u3042\u308a\u307e\u305b\u3093\u304c\u3001Treasure Data \u306e Hive \u306b\u306f ``to_map`` UDAF \u304c\u7d44\u307f\u8fbc\u307e\u308c\u3066\u304a\u308a\u3001\u30de\u30c3\u30d7\u578b\u306e\u69cb\u9020\u3092\u4f5c\u3063\u3066\u304b\u3089\u53c2\u7167\u3059\u308b\u3053\u3068\u304c\u51fa\u6765\u307e\u3059\u3002\n\n```sql\nSELECT\n  uid,\n  kv['c1'] AS c1,\n  kv['c2'] AS c2,\n  kv['c3'] AS c3\nFROM (\n  SELECT uid, to_map(key, value) kv\n  FROM vtable\n  GROUP BY uid\n) t\n```\n```\nuid  c1  c2  c3\n---  --  --  --\n101  11  12  13\n102  21  22  23\n```\n\n**Unpivot**\n``LATERAL VIEW explode`` \u3067\u5c55\u958b\u3059\u308b\u65b9\u6cd5\u304c\u3042\u308a\u307e\u3059\u3002\n\n```sql\nSELECT t1.uid, t2.key, t2.value\nFROM htable t1\nLATERAL VIEW explode (map(\n  'c1', c1,\n  'c2', c2,\n  'c3', c3\n)) t2 as key, value\n```\n```\nuid  key  value\n---  ---  -----\n101   c1     11\n101   c2     12\n101   c3     13\n102   c1     21\n102   c2     22\n102   c3     23\n```\n\n# Pandas\n\n``pivot`` \u3084 ``melt`` \u3068\u3044\u3063\u305f\u95a2\u6570\u304c\u4f7f\u3048\u307e\u3059\u3002\n\n**Pivot**\n\n```py3\nIn [1]: vtable.pivot('uid', 'key', 'value')\nOut[1]:\nkey  c1  c2  c3\nuid\n101  11  12  13\n102  21  22  23\n```\n\n**Unpivot**\n\n```py3\nIn [2]: pd.melt(htable, 'uid', var_name='key')\nOut[2]: \n  uid  key  value\n0 101   c1     11\n1 101   c2     12\n2 101   c3     13\n3 102   c1     21\n4 102   c2     22\n5 102   c3     23\n```\n"}