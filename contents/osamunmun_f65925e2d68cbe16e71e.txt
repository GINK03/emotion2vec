{"context": "\n\n\u524d\u63d0\n\nClient -> ElasticBeanstalk(EC2) -> S3 \u3068\u3044\u3046\u69cb\u6210\nClient\u3068EB\u9593\u306bBasic\u8a8d\u8a3c\u3092\u304b\u3051\u308b\nEB\u3068S3\u9593\u306f\u3001Authorization Header\u3092\u4f7f\u3063\u305f\u8a8d\u8a3c\u3092\u304b\u3051\u308b\n\n\nhttps://docs.aws.amazon.com/ja_jp/AmazonS3/latest/dev/RESTAuthentication.html\n\n\nElasticBeanstalk\u3067\u306fnginx\u3092\u7528\u3044\u305f\n\n\n\u8981\u4ef6\n\n\u5b9f\u969b\u306f\u3053\u306eClient\u3068EB\u306e\u9593\u306bCloudFront\u3092\u306f\u3055\u307f\u307e\u3059\n\u7279\u5b9a\u306epath\u3060\u3051Basic\u8a8d\u8a3c\u3092\u304b\u3051\u305f\u3044\u3068\u3044\u3046\u8981\u671b\u304c\u3042\u308a\u3001\u57fa\u672c\u7684\u306b\u306fCF -> S3\u306a\u69cb\u6210\u306a\u306e\u3067\u3059\u304c\u3001\u4e00\u90e8EB\u3092\u7d4c\u7531\u3055\u305b\u3066\u3053\u3053\u3067Basic\u8a8d\u8a3c\u3092\u304b\u3051\u308b\u3068\u3044\u3046\u72d9\u3044(\u3053\u306e\u8a18\u4e8b\u3092\u66f8\u3044\u305f\u6642\u70b9\u3067\u306f\u3001CF\u3092\u4ecb\u3057\u3066\u306e\u691c\u8a3c\u306f\u3057\u3066\u306a\u3044\u3067\u3059\u304c\u3001CF\u3092\u4ecb\u3057\u305fBasic\u8a8d\u8a3c\u306e\u4e8b\u4f8b\u306f\u305f\u304f\u3055\u3093\u3042\u3063\u305f\u306e\u3067\u5927\u4e08\u592b\u3068\u3044\u3046\u60f3\u5b9a)\n\n\n\u8ab2\u984c\n\u6700\u521d\u306f\u5358\u7d14\u306b\u3001Basic\u8a8d\u8a3c\u3068S3\u306e\u8a8d\u8a3c\u3092\u305d\u308c\u305e\u308c\u30af\u30ea\u30a2\u3059\u308c\u3070\u3088\u3044\u3068\u601d\u3063\u3066\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u8a2d\u5b9a\u306b\u3057\u307e\u3057\u305f\u3002\ns3_auth.lua\u306e\u4e2d\u3067\u3001S3\u3078\u30a2\u30af\u30bb\u30b9\u3059\u308b\u305f\u3081\u306eAuthorization Header\u306e\u5024\u3092\u751f\u6210\u3057\u3066\u307e\u3059\u3002\n...\nlocation ~ ^/(.*)$ {\n      auth_basic \"Restricted\";\n      auth_basic_user_file /usr/local/nginx/conf/.htpasswd;\n      rewrite_by_lua_file '/usr/local/nginx/lua/s3_auth.lua';\n      proxy_hide_header x-amz-id-2;\n      proxy_hide_header x-amz-request-id;\n      proxy_intercept_errors on;\n      proxy_pass http://$bucket.s3.amazonaws.com/$1;\n    }\n...\n\n\u53c2\u8003\u307e\u3067\u306bs3_auth.lua\u306f\u3053\u3093\u306a\u611f\u3058\nlocal date = ngx.http_time(ngx.time())\nlocal string_to_sign = ngx.req.get_method() .. \"\\n\\n\\n\" .. date .. \"\\n/\" .. ngx.var.bucket .. \"/\" .. ngx.var.full_filename\nngx.req.set_header(\"Date\", date)\nlocal digest = ngx.hmac_sha1(ngx.var.secret_key, string_to_sign)\nlocal signature = ngx.encode_base64(digest)\nngx.req.set_header(\"Authorization\", \"AWS \" .. ngx.var.access_key .. \":\" .. signature)\nngx.req.clear_header(\"x-amz-cf-id\")\n\n\u3053\u308c\u3060\u3068\u3001S3\u7528\u306eAuthorization Header\u306b\u66f8\u304d\u63db\u3048\u3066\u3057\u307e\u3044Basic\u8a8d\u8a3c\u304c\u901a\u3089\u306a\u304f\u306a\u3063\u3066\u3057\u307e\u3046\u3068\u3044\u3046\u7f60\u306b\u30cf\u30de\u3063\u3066\u3057\u307e\u3044\u307e\u3057\u305f\u3002\n\u5185\u90e8\u7684\u306bproxy\u3055\u305b\u3066\u3042\u3052\u308b\u3053\u3068\u3067\u3001Basic\u8a8d\u8a3c\u3068S3\u3078\u306e\u8a8d\u8a3c\u3092\u5225\u3005\u306b\u6271\u3046\u3053\u3068\u304c\u3067\u304d\u307e\u3057\u305f\u3002\n...\n    location ~ ^/(.*)$ {\n      auth_basic \"Restricted\";\n      auth_basic_user_file /usr/local/nginx/conf/.htpasswd;\n      proxy_hide_header x-amz-id-2;\n      proxy_hide_header x-amz-request-id;\n      proxy_intercept_errors on;\n      proxy_pass http://127.0.0.1:8081/$1;\n    }\n  }\n\n  server {\n    listen 8081 default_server;\n    sendfile      on;\n    tcp_nopush    on;\n    send_timeout 120;\n    access_log off;\n\n    set_by_lua $bucket 'return os.getenv(\"BUCKET\")';\n    set_by_lua $access_key 'return os.getenv(\"AWS_ACCESS_KEY\")';\n    set_by_lua $secret_key 'return os.getenv(\"AWS_SECRET_KEY\")';\n\n\n    location ~ ^/(.+)$ {\n      set $full_filename $1;\n      rewrite_by_lua_file '/usr/local/nginx/lua/s3_auth.lua';\n      proxy_hide_header x-amz-id-2;\n      proxy_hide_header x-amz-request-id;\n      proxy_hide_header Cache-Control;\n      proxy_set_header Host $bucket.s3.amazonaws.com;\n      proxy_pass http://$bucket.s3.amazonaws.com/$1;\n      error_page 415 /50x.html;\n    }\n... \n\n### \u524d\u63d0\n- Client -> ElasticBeanstalk(EC2) -> S3 \u3068\u3044\u3046\u69cb\u6210\n- Client\u3068EB\u9593\u306bBasic\u8a8d\u8a3c\u3092\u304b\u3051\u308b\n- EB\u3068S3\u9593\u306f\u3001Authorization Header\u3092\u4f7f\u3063\u305f\u8a8d\u8a3c\u3092\u304b\u3051\u308b\n  - https://docs.aws.amazon.com/ja_jp/AmazonS3/latest/dev/RESTAuthentication.html\n- ElasticBeanstalk\u3067\u306fnginx\u3092\u7528\u3044\u305f\n\n### \u8981\u4ef6\n- \u5b9f\u969b\u306f\u3053\u306eClient\u3068EB\u306e\u9593\u306bCloudFront\u3092\u306f\u3055\u307f\u307e\u3059\n- \u7279\u5b9a\u306epath\u3060\u3051Basic\u8a8d\u8a3c\u3092\u304b\u3051\u305f\u3044\u3068\u3044\u3046\u8981\u671b\u304c\u3042\u308a\u3001\u57fa\u672c\u7684\u306b\u306fCF -> S3\u306a\u69cb\u6210\u306a\u306e\u3067\u3059\u304c\u3001\u4e00\u90e8EB\u3092\u7d4c\u7531\u3055\u305b\u3066\u3053\u3053\u3067Basic\u8a8d\u8a3c\u3092\u304b\u3051\u308b\u3068\u3044\u3046\u72d9\u3044(\u3053\u306e\u8a18\u4e8b\u3092\u66f8\u3044\u305f\u6642\u70b9\u3067\u306f\u3001CF\u3092\u4ecb\u3057\u3066\u306e\u691c\u8a3c\u306f\u3057\u3066\u306a\u3044\u3067\u3059\u304c\u3001CF\u3092\u4ecb\u3057\u305fBasic\u8a8d\u8a3c\u306e\u4e8b\u4f8b\u306f\u305f\u304f\u3055\u3093\u3042\u3063\u305f\u306e\u3067\u5927\u4e08\u592b\u3068\u3044\u3046\u60f3\u5b9a)\n\n### \u8ab2\u984c\n\u6700\u521d\u306f\u5358\u7d14\u306b\u3001Basic\u8a8d\u8a3c\u3068S3\u306e\u8a8d\u8a3c\u3092\u305d\u308c\u305e\u308c\u30af\u30ea\u30a2\u3059\u308c\u3070\u3088\u3044\u3068\u601d\u3063\u3066\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u8a2d\u5b9a\u306b\u3057\u307e\u3057\u305f\u3002\ns3_auth.lua\u306e\u4e2d\u3067\u3001S3\u3078\u30a2\u30af\u30bb\u30b9\u3059\u308b\u305f\u3081\u306eAuthorization Header\u306e\u5024\u3092\u751f\u6210\u3057\u3066\u307e\u3059\u3002\n\n```\n...\nlocation ~ ^/(.*)$ {\n      auth_basic \"Restricted\";\n      auth_basic_user_file /usr/local/nginx/conf/.htpasswd;\n      rewrite_by_lua_file '/usr/local/nginx/lua/s3_auth.lua';\n      proxy_hide_header x-amz-id-2;\n      proxy_hide_header x-amz-request-id;\n      proxy_intercept_errors on;\n      proxy_pass http://$bucket.s3.amazonaws.com/$1;\n    }\n...\n```\n\n\u53c2\u8003\u307e\u3067\u306bs3_auth.lua\u306f\u3053\u3093\u306a\u611f\u3058\n\n```\nlocal date = ngx.http_time(ngx.time())\nlocal string_to_sign = ngx.req.get_method() .. \"\\n\\n\\n\" .. date .. \"\\n/\" .. ngx.var.bucket .. \"/\" .. ngx.var.full_filename\nngx.req.set_header(\"Date\", date)\nlocal digest = ngx.hmac_sha1(ngx.var.secret_key, string_to_sign)\nlocal signature = ngx.encode_base64(digest)\nngx.req.set_header(\"Authorization\", \"AWS \" .. ngx.var.access_key .. \":\" .. signature)\nngx.req.clear_header(\"x-amz-cf-id\")\n```\n\n\u3053\u308c\u3060\u3068\u3001S3\u7528\u306eAuthorization Header\u306b\u66f8\u304d\u63db\u3048\u3066\u3057\u307e\u3044Basic\u8a8d\u8a3c\u304c\u901a\u3089\u306a\u304f\u306a\u3063\u3066\u3057\u307e\u3046\u3068\u3044\u3046\u7f60\u306b\u30cf\u30de\u3063\u3066\u3057\u307e\u3044\u307e\u3057\u305f\u3002\n\u5185\u90e8\u7684\u306bproxy\u3055\u305b\u3066\u3042\u3052\u308b\u3053\u3068\u3067\u3001Basic\u8a8d\u8a3c\u3068S3\u3078\u306e\u8a8d\u8a3c\u3092\u5225\u3005\u306b\u6271\u3046\u3053\u3068\u304c\u3067\u304d\u307e\u3057\u305f\u3002\n\n```\n...\n    location ~ ^/(.*)$ {\n      auth_basic \"Restricted\";\n      auth_basic_user_file /usr/local/nginx/conf/.htpasswd;\n      proxy_hide_header x-amz-id-2;\n      proxy_hide_header x-amz-request-id;\n      proxy_intercept_errors on;\n      proxy_pass http://127.0.0.1:8081/$1;\n    }\n  }\n\n  server {\n    listen 8081 default_server;\n    sendfile      on;\n    tcp_nopush    on;\n    send_timeout 120;\n    access_log off;\n\n    set_by_lua $bucket 'return os.getenv(\"BUCKET\")';\n    set_by_lua $access_key 'return os.getenv(\"AWS_ACCESS_KEY\")';\n    set_by_lua $secret_key 'return os.getenv(\"AWS_SECRET_KEY\")';\n\n \n    location ~ ^/(.+)$ {\n      set $full_filename $1;\n      rewrite_by_lua_file '/usr/local/nginx/lua/s3_auth.lua';\n      proxy_hide_header x-amz-id-2;\n      proxy_hide_header x-amz-request-id;\n      proxy_hide_header Cache-Control;\n      proxy_set_header Host $bucket.s3.amazonaws.com;\n      proxy_pass http://$bucket.s3.amazonaws.com/$1;\n      error_page 415 /50x.html;\n    }\n... \n```\n", "tags": ["AWS", "S3"]}