{"context": "sensu\u3092\u7c21\u5358\u306a\u8a2d\u5b9a\u3067\u52d5\u304b\u3059\u3068\u3053\u308d\u307e\u3067\u3002\n\nRabbitMQ\nvhost\u3092\u4f5c\u6210\u3059\u308b\nsudo rabbitmqctl add_vhost /sensu\n\nsensu\u7528\u306eRabbitMQ\u30e6\u30fc\u30b6\u30fc\u3092\u4f5c\u6210\u3059\u308b\nsudo rabbitmqctl add_user sensu secret\nsudo rabbitmqctl set_permissions -p /sensu sensu \".*\" \".*\" \".*\"\n\n\n\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\n/etc/sensu/config.json\u304b/etc/sensu/conf.d/\u306e\u4e0b\u306bJSON\u3067\u8a2d\u5b9a\u3092\u66f8\u304f\u3053\u3068\u304c\u3067\u304d\u308b\u3002\u30d5\u30a1\u30a4\u30eb\u3092\u7d30\u304b\u304f\u5206\u5272\u3059\u308b\u3053\u3068\u3082\u53ef\u80fd\u3002\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u305f\u6642\u306b/etc/sensu/config.json.example\u3068\u3044\u3046\u306e\u304c\u3042\u3063\u305f\u306e\u3067\u52d5\u304b\u3057\u3066\u307f\u308b\u3002\nmv /etc/sensu/config.json.example /etc/sensu/config.json\n\n\n/etc/sensu/config.json\n{\n  \"rabbitmq\": {\n    \"host\": \"localhost\",\n    \"port\": 5672,\n    \"user\": \"sensu\",\n    \"password\": \"sensu\",\n    \"vhost\": \"/sensu\"\n  },\n  \"redis\": {\n    \"host\": \"localhost\",\n    \"port\": 6379\n  },\n  \"api\": {\n    \"host\": \"localhost\",\n    \"port\": 4567\n  },\n  \"handlers\": {\n    \"default\": {\n      \"type\": \"set\",\n      \"handlers\": [\n        \"stdout\"\n      ]\n    },\n    \"stdout\": {\n      \"type\": \"pipe\",\n      \"command\": \"cat\"\n    }\n  },\n  \"checks\": {\n    \"test\": {\n      \"command\": \"echo -n OK\",\n      \"subscribers\": [\n        \"test\"\n      ],\n      \"interval\": 60\n    }\n  },\n  \"client\": {\n    \"name\": \"localhost\",\n    \"address\": \"127.0.0.1\",\n    \"subscriptions\": [\n      \"test\"\n    ]\n  }\n}\n\n\nsensu-server, sensu-client, sensu-api\u3092\u30ea\u30b9\u30bf\u30fc\u30c8\u3059\u308b\u3002\nsensu-api\u3092\u53e9\u3044\u3066\u52d5\u3044\u3066\u3044\u308b\u304b\u78ba\u8a8d\u3057\u307e\u3059\u3002\n$ curl http://localhost:4567/info | jq . \n\n{\n  \"sensu\": {\n    \"version\": \"0.25.5\"\n  },\n  \"transport\": {\n    \"keepalives\": {\n      \"messages\": 0,\n      \"consumers\": 1\n    },\n    \"results\": {\n      \"messages\": 0,\n      \"consumers\": 1\n    },\n    \"connected\": true\n  },\n  \"redis\": {\n    \"connected\": true\n  }\n}\n\n\u3061\u3083\u3093\u3068\u8fd4\u3063\u3066\u304d\u305f\u3002\n\u3042\u3068\u3001/var/log/sensu/sensu-client.log, /var/log/sensu/sensu-server.log\u3082\u3067\u3066\u305f\u3002\n\n/var/log/sensu-client.log\n{\"timestamp\":\"2016-07-23T18:08:26.828593+0000\",\"level\":\"info\",\"message\":\"received check request\",\"check\":{\"command\":\"echo -n OK\",\"name\":\"test\",\"issued\":1469297306}}\n{\"timestamp\":\"2016-07-23T18:08:26.830864+0000\",\"level\":\"info\",\"message\":\"publishing check result\",\"payload\":{\"client\":\"localhost\",\"check\":{\"command\":\"echo -n OK\",\"name\":\"test\",\"issued\":1469297306,\"subscribers\":[\"test\"],\"interval\":60,\"executed\":1469297306,\"duration\":0.001,\"output\":\"OK\",\"status\":0}}}\n\n\n\n\u76e3\u8996\u9805\u76ee\u3092\u8ffd\u52a0\u3059\u308b\nChecks\u3092\u8ffd\u52a0\u3057\u3066\u76e3\u8996\u9805\u76ee\u3092\u8a2d\u5b9a\u3059\u308b\u3002\nRails\u3067\u4f5c\u3063\u305f\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3092\u76e3\u8996\u3057\u3066\u307f\u308b\u3002\nrails new sample\ncd sample\nbundle exec rails s -b 0.0.0.0\n\nsensu-plugins-http\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u3002\nsensu-install -p http\n\n/etc/sensu/conf.d\u306bcheck-sensu-website.json\u3068\u3044\u3046\u65b0\u3057\u3044\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092\u8ffd\u52a0\u3059\u308b\u3002\nChecks\u3092\u8ffd\u52a0\u3057\u3066\u76e3\u8996\u3059\u308b\u8a2d\u5b9a\u3092\u66f8\u3044\u3066\u3044\u304f\u3002\n60\u79d2\u6bce\u306blocalhost:3000\u3092\u76e3\u8996\u3059\u308b\u3002\nsubscribers\u306fClient subscriptions\u3068\u5bfe\u5fdc\u3057\u3066\u3044\u306a\u3044\u3068\u30c0\u30e1\u3002/etc/sensu/config.json\u306eclient\u304ctest\u306a\u306e\u3067test\u306b\u3059\u308b\u3002\n\n/etc/sensu/conf.d/check-sensu-website.json\n{\n  \"checks\": {\n    \"sensu-website\": {\n      \"command\": \"check-http.rb -u http://localhost:3000\",\n      \"subscribers\": [\n        \"test\"\n      ],\n      \"interval\": 60\n    }\n  }\n}\n\n\nsensu\u3092\u30ea\u30b9\u30bf\u30fc\u30c8\u3059\u308b\nsudo service sensu-server restart\nsudo service sensu-client restart\nsudo service sensu-api restart\n\n/var/log/sensu-client.log\u3092\u898b\u3066\u307f\u308b\u3002\n\"name\":\"sensu-website\"\u306e\u30ed\u30b0\u304c\u51fa\u3066\u3044\u308b\u306e\u3092\u78ba\u8a8d\u3002\"status\":0\u306a\u306e\u3067Rails\u306f\u6b63\u5e38\u306b\u52d5\u3044\u3066\u3044\u308b\u3002\n\n/var/log/sensu-client.log\n{\"timestamp\":\"2016-07-23T18:07:02.436898+0000\",\"level\":\"info\",\"message\":\"received check request\",\"check\":{\"command\":\"check-http.rb -u http://localhost:3000\",\"name\":\"sensu-website\",\"issued\":1469297222}}\n{\"timestamp\":\"2016-07-23T18:07:02.641105+0000\",\"level\":\"info\",\"message\":\"publishing check result\",\"payload\":{\"client\":\"localhost\",\"check\":{\"command\":\"check-http.rb -u http://localhost:3000\",\"name\":\"sensu-website\",\"issued\":1469297222,\"subscribers\":[\"test\"],\"interval\":60,\"executed\":1469297222,\"duration\":0.203,\"output\":\"CheckHttp OK: 200, 14935 bytes\\n\",\"status\":0}}}\n\n\nRails\u3092\u6b62\u3081\u3066\u307f\u308b\u3002\n\u30ed\u30b0\u3092\u898b\u3066\u307f\u308b\u3068`\"status\":2\u3067output\u3082\"CheckHttp CRITICAL: Request error: Failed to open TCP connection to localhost:3000 (Connection refused - connect(2) for \\\"localhost\\\" port 3000)\\n\"\u306b\u306a\u3063\u3066localhost:3000\u306b\u30a2\u30af\u30bb\u30b9\u3067\u304d\u306a\u3044\u3053\u3068\u304c\u691c\u77e5\u3067\u304d\u3066\u308b\u3002\n\n/var/log/sensu-client.log\n{\"timestamp\":\"2016-07-23T18:29:03.132764+0000\",\"level\":\"info\",\"message\":\"received check request\",\"check\":{\"command\":\"check-http.rb -u http://localhost:3000\",\"name\":\"sensu-website\",\"issued\":1469298543}}\n{\"timestamp\":\"2016-07-23T18:29:03.331503+0000\",\"level\":\"info\",\"message\":\"publishing check result\",\"payload\":{\"client\":\"localhost\",\"check\":{\"command\":\"check-http.rb -u http://localhost:3000\",\"name\":\"sensu-website\",\"issued\":1469298543,\"subscribers\":[\"test\"],\"interval\":60,\"executed\":1469298543,\"duration\":0.198,\"output\":\"CheckHttp CRITICAL: Request error: Failed to open TCP connection to localhost:3000 (Connection refused - connect(2) for \\\"localhost\\\" port 3000)\\n\",\"status\":2}}}\n\n\n\u76e3\u8996\u3067\u304d\u305f\u3002\nsensu\u3092\u7c21\u5358\u306a\u8a2d\u5b9a\u3067\u52d5\u304b\u3059\u3068\u3053\u308d\u307e\u3067\u3002\n\n# RabbitMQ\n\nvhost\u3092\u4f5c\u6210\u3059\u308b\n\n``` \nsudo rabbitmqctl add_vhost /sensu\n```\n\nsensu\u7528\u306eRabbitMQ\u30e6\u30fc\u30b6\u30fc\u3092\u4f5c\u6210\u3059\u308b\n\n``` \nsudo rabbitmqctl add_user sensu secret\nsudo rabbitmqctl set_permissions -p /sensu sensu \".*\" \".*\" \".*\"\n```\n\n# \u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\n\n`/etc/sensu/config.json`\u304b`/etc/sensu/conf.d/`\u306e\u4e0b\u306bJSON\u3067\u8a2d\u5b9a\u3092\u66f8\u304f\u3053\u3068\u304c\u3067\u304d\u308b\u3002\u30d5\u30a1\u30a4\u30eb\u3092\u7d30\u304b\u304f\u5206\u5272\u3059\u308b\u3053\u3068\u3082\u53ef\u80fd\u3002\n\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u305f\u6642\u306b`/etc/sensu/config.json.example`\u3068\u3044\u3046\u306e\u304c\u3042\u3063\u305f\u306e\u3067\u52d5\u304b\u3057\u3066\u307f\u308b\u3002\n\n```\nmv /etc/sensu/config.json.example /etc/sensu/config.json\n```\n\n``` /etc/sensu/config.json\n{\n  \"rabbitmq\": {\n    \"host\": \"localhost\",\n    \"port\": 5672,\n    \"user\": \"sensu\",\n    \"password\": \"sensu\",\n    \"vhost\": \"/sensu\"\n  },\n  \"redis\": {\n    \"host\": \"localhost\",\n    \"port\": 6379\n  },\n  \"api\": {\n    \"host\": \"localhost\",\n    \"port\": 4567\n  },\n  \"handlers\": {\n    \"default\": {\n      \"type\": \"set\",\n      \"handlers\": [\n        \"stdout\"\n      ]\n    },\n    \"stdout\": {\n      \"type\": \"pipe\",\n      \"command\": \"cat\"\n    }\n  },\n  \"checks\": {\n    \"test\": {\n      \"command\": \"echo -n OK\",\n      \"subscribers\": [\n        \"test\"\n      ],\n      \"interval\": 60\n    }\n  },\n  \"client\": {\n    \"name\": \"localhost\",\n    \"address\": \"127.0.0.1\",\n    \"subscriptions\": [\n      \"test\"\n    ]\n  }\n}\n```\n\n`sensu-server`, `sensu-client`, `sensu-api`\u3092\u30ea\u30b9\u30bf\u30fc\u30c8\u3059\u308b\u3002\n\n`sensu-api`\u3092\u53e9\u3044\u3066\u52d5\u3044\u3066\u3044\u308b\u304b\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n```\n$ curl http://localhost:4567/info | jq . \n\n{\n  \"sensu\": {\n    \"version\": \"0.25.5\"\n  },\n  \"transport\": {\n    \"keepalives\": {\n      \"messages\": 0,\n      \"consumers\": 1\n    },\n    \"results\": {\n      \"messages\": 0,\n      \"consumers\": 1\n    },\n    \"connected\": true\n  },\n  \"redis\": {\n    \"connected\": true\n  }\n}\n```\n\n\u3061\u3083\u3093\u3068\u8fd4\u3063\u3066\u304d\u305f\u3002\n\u3042\u3068\u3001`/var/log/sensu/sensu-client.log`, `/var/log/sensu/sensu-server.log`\u3082\u3067\u3066\u305f\u3002\n\n```/var/log/sensu-client.log\n{\"timestamp\":\"2016-07-23T18:08:26.828593+0000\",\"level\":\"info\",\"message\":\"received check request\",\"check\":{\"command\":\"echo -n OK\",\"name\":\"test\",\"issued\":1469297306}}\n{\"timestamp\":\"2016-07-23T18:08:26.830864+0000\",\"level\":\"info\",\"message\":\"publishing check result\",\"payload\":{\"client\":\"localhost\",\"check\":{\"command\":\"echo -n OK\",\"name\":\"test\",\"issued\":1469297306,\"subscribers\":[\"test\"],\"interval\":60,\"executed\":1469297306,\"duration\":0.001,\"output\":\"OK\",\"status\":0}}}\n```\n\n# \u76e3\u8996\u9805\u76ee\u3092\u8ffd\u52a0\u3059\u308b\n\nChecks\u3092\u8ffd\u52a0\u3057\u3066\u76e3\u8996\u9805\u76ee\u3092\u8a2d\u5b9a\u3059\u308b\u3002\nRails\u3067\u4f5c\u3063\u305f\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3092\u76e3\u8996\u3057\u3066\u307f\u308b\u3002\n\n```\nrails new sample\ncd sample\nbundle exec rails s -b 0.0.0.0\n```\n\n[sensu-plugins-http](https://github.com/sensu-plugins/sensu-plugins-http)\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u3002\n\n\n```\nsensu-install -p http\n```\n\n`/etc/sensu/conf.d`\u306b`check-sensu-website.json`\u3068\u3044\u3046\u65b0\u3057\u3044\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092\u8ffd\u52a0\u3059\u308b\u3002\n\n[Checks](https://sensuapp.org/docs/0.25/reference/checks.html)\u3092\u8ffd\u52a0\u3057\u3066\u76e3\u8996\u3059\u308b\u8a2d\u5b9a\u3092\u66f8\u3044\u3066\u3044\u304f\u3002\n60\u79d2\u6bce\u306b`localhost:3000`\u3092\u76e3\u8996\u3059\u308b\u3002\n`subscribers`\u306f[Client subscriptions](https://sensuapp.org/docs/0.25/reference/clients.html#client-subscriptions)\u3068\u5bfe\u5fdc\u3057\u3066\u3044\u306a\u3044\u3068\u30c0\u30e1\u3002`/etc/sensu/config.json`\u306eclient\u304ctest\u306a\u306e\u3067test\u306b\u3059\u308b\u3002\n\n```/etc/sensu/conf.d/check-sensu-website.json\n{\n  \"checks\": {\n    \"sensu-website\": {\n      \"command\": \"check-http.rb -u http://localhost:3000\",\n      \"subscribers\": [\n        \"test\"\n      ],\n      \"interval\": 60\n    }\n  }\n}\n```\n\nsensu\u3092\u30ea\u30b9\u30bf\u30fc\u30c8\u3059\u308b\n\n```\nsudo service sensu-server restart\nsudo service sensu-client restart\nsudo service sensu-api restart\n```\n\n`/var/log/sensu-client.log`\u3092\u898b\u3066\u307f\u308b\u3002\n`\"name\":\"sensu-website\"`\u306e\u30ed\u30b0\u304c\u51fa\u3066\u3044\u308b\u306e\u3092\u78ba\u8a8d\u3002`\"status\":0`\u306a\u306e\u3067Rails\u306f\u6b63\u5e38\u306b\u52d5\u3044\u3066\u3044\u308b\u3002\n\n```/var/log/sensu-client.log\n{\"timestamp\":\"2016-07-23T18:07:02.436898+0000\",\"level\":\"info\",\"message\":\"received check request\",\"check\":{\"command\":\"check-http.rb -u http://localhost:3000\",\"name\":\"sensu-website\",\"issued\":1469297222}}\n{\"timestamp\":\"2016-07-23T18:07:02.641105+0000\",\"level\":\"info\",\"message\":\"publishing check result\",\"payload\":{\"client\":\"localhost\",\"check\":{\"command\":\"check-http.rb -u http://localhost:3000\",\"name\":\"sensu-website\",\"issued\":1469297222,\"subscribers\":[\"test\"],\"interval\":60,\"executed\":1469297222,\"duration\":0.203,\"output\":\"CheckHttp OK: 200, 14935 bytes\\n\",\"status\":0}}}\n```\n\nRails\u3092\u6b62\u3081\u3066\u307f\u308b\u3002\n\u30ed\u30b0\u3092\u898b\u3066\u307f\u308b\u3068``\"status\":2`\u3067`output`\u3082`\"CheckHttp CRITICAL: Request error: Failed to open TCP connection to localhost:3000 (Connection refused - connect(2) for \\\"localhost\\\" port 3000)\\n\"`\u306b\u306a\u3063\u3066`localhost:3000`\u306b\u30a2\u30af\u30bb\u30b9\u3067\u304d\u306a\u3044\u3053\u3068\u304c\u691c\u77e5\u3067\u304d\u3066\u308b\u3002\n\n```/var/log/sensu-client.log\n{\"timestamp\":\"2016-07-23T18:29:03.132764+0000\",\"level\":\"info\",\"message\":\"received check request\",\"check\":{\"command\":\"check-http.rb -u http://localhost:3000\",\"name\":\"sensu-website\",\"issued\":1469298543}}\n{\"timestamp\":\"2016-07-23T18:29:03.331503+0000\",\"level\":\"info\",\"message\":\"publishing check result\",\"payload\":{\"client\":\"localhost\",\"check\":{\"command\":\"check-http.rb -u http://localhost:3000\",\"name\":\"sensu-website\",\"issued\":1469298543,\"subscribers\":[\"test\"],\"interval\":60,\"executed\":1469298543,\"duration\":0.198,\"output\":\"CheckHttp CRITICAL: Request error: Failed to open TCP connection to localhost:3000 (Connection refused - connect(2) for \\\"localhost\\\" port 3000)\\n\",\"status\":2}}}\n```\n\n\u76e3\u8996\u3067\u304d\u305f\u3002\n", "tags": ["Sensu"]}