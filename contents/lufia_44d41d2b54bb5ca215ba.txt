{"context": "\u958b\u767a\u74b0\u5883\u3068\u3057\u3066\u3001CoreOS\u3092Mac OS X+QEMU\u306b\u5c0e\u5165\u3057\u305f\u306e\u3067\u30e1\u30e2\u66f8\u304d\u3002\n\n\u60c5\u5831\nQEMU stable 2.5.0\nCoreOS 835.13.0\n\nQEMU\n\u304a\u624b\u8efd\u306bHomebrew\u3067\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u307e\u3059\u3002\n$ brew install qemu\n\n\u6642\u9593\u304c\u304b\u304b\u308b\u306e\u3067\u3001\u5f85\u3061\u307e\u3057\u3087\u3046\u3002\n\nCoreOS\n\u516c\u5f0f\u60c5\u5831\u3092\u53c2\u8003\u306b\u30a4\u30e1\u30fc\u30b8\u3092\u53d6\u5f97\u3002\n$ mkdir coreos\n$ cd coreos\n$ curl -O http://stable.release.core-os.net/amd64-usr/current/coreos_production_qemu.sh\n$ curl -O http://stable.release.core-os.net/amd64-usr/current/coreos_production_qemu_image.img.bz2\n$ bzip2 -d coreos_production_qemu_image.img.bz2\n$ chmod +x coreos_production_qemu.sh\n\n\u4e0a\u8a18\u306f\u3001\u30b7\u30b0\u30cd\u30c1\u30e3\u306e\u691c\u8a3c\u3092\u3055\u307c\u3063\u3066\u307e\u3059\u3002\u516c\u5f0f\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u306b\u3042\u308b\u3088\u3046\u306b\u3001gpg\u3067\u691c\u8a3c\u3057\u305f\u65b9\u304c\u3044\u3044\u3067\u3059\u3002\n\n\u8d77\u52d5\u30b9\u30af\u30ea\u30d7\u30c8\u306e\u4fee\u6b63\ncoreos_production_qemu.sh\u306fLinux\u524d\u63d0\u306b\u306a\u3063\u3066\u3044\u308b\u306e\u3067\u3001\u66f8\u304d\u63db\u3048\u307e\u3059\u3002OS X\u306b\u306fprocfs\u304c\u7121\u3044\u306e\u3067\u3001CPU\u30b3\u30a2\u6570\u3092\u8fd4\u3059\u5225\u306e\u30b3\u30de\u30f3\u30c9\u3067\u4ee3\u7528\u3057\u307e\u3059\u3002\n-VM_NCPUS=\"`grep -c ^processor /proc/cpuinfo`\"\n+VM_NCPUS=\"`system_profiler SPHardwareDataType | awk '/Total Number of Cores/ { print $NF }'`\"\n\n\u540c\u69d8\u306b\u3001KVM\u3082\u7121\u3044\u306e\u3067\u3001KVM\u3092\u4f7f\u308f\u306a\u3044\u3088\u3046\u306b\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n-SAFE_ARGS=0\n+SAFE_ARGS=1\n\nOS X\u306emktemp\u306f\u3001-t\u30aa\u30d7\u30b7\u30e7\u30f3\u306e\u610f\u5473\u304cLinux\u3068\u306f\u7570\u306a\u308b\u306e\u3067\u3001\u30aa\u30d7\u30b7\u30e7\u30f3\u3092\u5916\u3057\u3066\u3057\u307e\u3044\u307e\u3057\u3087\u3046\u3002\n-CONFIG_DRIVE=$(mktemp -t -d coreos-configdrive.XXXXXXXXXX)\n+CONFIG_DRIVE=$(mktemp -d coreos-configdrive.XXXXXXXXXX)\n\n\u3053\u308c\u3067coreos_production_qemu.sh\u3092\u5b9f\u884c\u3059\u308b\u3068\u3001\n\nfsdev is not supported\n\n\u3068\u3044\u3063\u305f\u30a8\u30e9\u30fc\u3067\u5b9f\u884c\u3067\u304d\u307e\u305b\u3093\u3067\u3057\u305f\u3002\u3053\u308c\u306f9p\u3092\u4f7f\u3063\u3066\u3001\u30db\u30b9\u30c8\u306e\u30ea\u30bd\u30fc\u30b9\u3092CoreOS\u304b\u3089\u53c2\u7167\u3067\u304d\u308b\u3088\u3046\u306b\u3059\u308b\u305f\u3081\u306b\u5fc5\u8981\u3067\u3059\u3002CoreOS\u306f\u3001root\u306e\u30d1\u30b9\u30ef\u30fc\u30c9\u304c\u8a2d\u5b9a\u3055\u308c\u3066\u3044\u307e\u305b\u3093\u306e\u3067\u3001\u516c\u958b\u9375\u3092\u4f7f\u3063\u3066SSH\u63a5\u7d9a\u3055\u305b\u308b\u3057\u304b\u30ed\u30b0\u30a4\u30f3\u3059\u308b\u65b9\u6cd5\u304c\u3042\u308a\u307e\u305b\u3093\u304c\u30019p\u304c\u4f7f\u3048\u306a\u3044\u306e\u3067\u3001\u516c\u958b\u9375\u3092CoreOS\u306b\u6e21\u3059\u3053\u3068\u304c\u3067\u304d\u305a\u3001\u7d50\u5c40\u30ed\u30b0\u30a4\u30f3\u3067\u304d\u307e\u305b\u3093\u3002\n\u3069\u3046\u3057\u3088\u3046\u304b\u306a\u3068\u601d\u3044\u307e\u3057\u305f\u304c\u3001Config Drive\u3068\u3057\u3066cloud-config\u30d5\u30a1\u30a4\u30eb\u3092\u542b\u3080iso\u30a4\u30e1\u30fc\u30b8\u3092\u30de\u30a6\u30f3\u30c8\u3055\u305b\u308b\u65b9\u6cd5\u3067\u5bfe\u5fdc\u3067\u304d\u307e\u3057\u305f\u3002\n$ mkdir -p data/openstack/latest\n$ cat data/openstack/latest/user_data\n#cloud-config\n\nhostname: dev\nssh_authorized_keys:\n - \"ssh-rsa XXXXXXXXXX(SSH\u516c\u958b\u9375\u306e\u5185\u5bb9)\"\n$ hdiutil makehybrid -iso -joliet -default-volume-name config-2 -o config.iso data\n\n\u30a4\u30e1\u30fc\u30b8\u304c\u3067\u304d\u305f\u3089\u3001\u8d77\u52d5\u30b9\u30af\u30ea\u30d7\u30c8\u306b\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n-CONFIG_IMAGE=\"\"\n+CONFIG_IMAGE=\"config.iso\"\n\n(snip)\n\n-set -- -drive if=virtio,file=\"${CONFIG_IMAGE}\" \"$@\"\n+set -- -drive if=virtio,file=\"${CONFIG_IMAGE}\",media=cdrom \"$@\"\n\n\n\u30ed\u30b0\u30a4\u30f3\n\u4ee5\u4e0b\u30b3\u30de\u30f3\u30c9\u3067\u30ed\u30b0\u30a4\u30f3\u51fa\u6765\u307e\u3059\u3002\n$ ssh -l core -p 2222 localhost\n\n\n\u30db\u30b9\u30c8\u304b\u3089docker\u3092\u64cd\u4f5c\u3059\u308b\n\u8d77\u52d5\u30b9\u30af\u30ea\u30d7\u30c8\u3067\u3001\u30dd\u30fc\u30c8\u3092\u89e3\u653e\u3057\u307e\u3059\u3002\n+DOCKER_PORT=2375\n\n(snip)\n\nqemu-system-x86_64 \\\n    -name \"$VM_NAME\" \\\n    -m ${VM_MEMORY} \\\n    -net nic,vlan=0,model=virtio \\\n-   -net user,vlan=0,hostfwd=tcp::\"${SSH_PORT}\"-:22,hostname=\"${VM_NAME}\" \\\n+   -net user,vlan=0,hostfwd=tcp::\"${SSH_PORT}\"-:22,hostfwd=tcp::\"${DOCKER_PORT}\"-:2375,hostname=\"${VM_NAME}\" \\\n    \"$@\"\n\ncloud-config\u30d5\u30a1\u30a4\u30eb\u306b\u4ee5\u4e0b\u3092\u8ffd\u52a0\u3057\u3066\u3001TCP\u3067\u5f85\u3061\u53d7\u3051\u308b\u3088\u3046\u306b\u5909\u66f4\u3057\u307e\u3059\u3002\ncoreos:\n  units:\n    - name: docker.service\n      command: start\n      enable: true\n    - name: docker-tcp.socket\n      command: start\n      enable: true\n      content: |\n        [Unit]\n        Description=Docker Socket for the API\n\n        [Socket]\n        ListenStream=2375\n        BindIPv6Only=both\n        Service=docker.service\n\n        [Install]\n        WantedBy=sockets.target\n\n\n\u30c7\u30a3\u30b9\u30af\u5bb9\u91cf\u306e\u8ffd\u52a0\n\u3053\u308c\u3067\u53ef\u80fd\u307f\u305f\u3044\u3002\nqemu-img resize coreos_production_qemu_image.img +5G\n\n\u307e\u305f\u306f\u3001\u4e0d\u8981\u306a\u30dc\u30ea\u30e5\u30fc\u30e0\u3092\u524a\u9664\u3057\u307e\u3057\u3087\u3046\u3002\ndocker volume rm $(docker volume ls -f 'dangling=true' -q)\n\n\u958b\u767a\u74b0\u5883\u3068\u3057\u3066\u3001CoreOS\u3092Mac OS X+QEMU\u306b\u5c0e\u5165\u3057\u305f\u306e\u3067\u30e1\u30e2\u66f8\u304d\u3002\n\n## \u60c5\u5831\n\nQEMU stable 2.5.0\nCoreOS 835.13.0\n\n## QEMU\n\n\u304a\u624b\u8efd\u306bHomebrew\u3067\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u307e\u3059\u3002\n\n```\n$ brew install qemu\n```\n\n\u6642\u9593\u304c\u304b\u304b\u308b\u306e\u3067\u3001\u5f85\u3061\u307e\u3057\u3087\u3046\u3002\n\n## CoreOS\n\n[\u516c\u5f0f\u60c5\u5831](https://coreos.com/os/docs/latest/booting-with-qemu.html)\u3092\u53c2\u8003\u306b\u30a4\u30e1\u30fc\u30b8\u3092\u53d6\u5f97\u3002\n\n\t$ mkdir coreos\n\t$ cd coreos\n\t$ curl -O http://stable.release.core-os.net/amd64-usr/current/coreos_production_qemu.sh\n\t$ curl -O http://stable.release.core-os.net/amd64-usr/current/coreos_production_qemu_image.img.bz2\n\t$ bzip2 -d coreos_production_qemu_image.img.bz2\n\t$ chmod +x coreos_production_qemu.sh\n\n\u4e0a\u8a18\u306f\u3001\u30b7\u30b0\u30cd\u30c1\u30e3\u306e\u691c\u8a3c\u3092\u3055\u307c\u3063\u3066\u307e\u3059\u3002\u516c\u5f0f\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u306b\u3042\u308b\u3088\u3046\u306b\u3001gpg\u3067\u691c\u8a3c\u3057\u305f\u65b9\u304c\u3044\u3044\u3067\u3059\u3002\n\n### \u8d77\u52d5\u30b9\u30af\u30ea\u30d7\u30c8\u306e\u4fee\u6b63\n\ncoreos_production_qemu.sh\u306fLinux\u524d\u63d0\u306b\u306a\u3063\u3066\u3044\u308b\u306e\u3067\u3001\u66f8\u304d\u63db\u3048\u307e\u3059\u3002OS X\u306b\u306fprocfs\u304c\u7121\u3044\u306e\u3067\u3001CPU\u30b3\u30a2\u6570\u3092\u8fd4\u3059\u5225\u306e\u30b3\u30de\u30f3\u30c9\u3067\u4ee3\u7528\u3057\u307e\u3059\u3002\n\n\t-VM_NCPUS=\"`grep -c ^processor /proc/cpuinfo`\"\n\t+VM_NCPUS=\"`system_profiler SPHardwareDataType | awk '/Total Number of Cores/ { print $NF }'`\"\n\n\u540c\u69d8\u306b\u3001KVM\u3082\u7121\u3044\u306e\u3067\u3001KVM\u3092\u4f7f\u308f\u306a\u3044\u3088\u3046\u306b\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\n\t-SAFE_ARGS=0\n\t+SAFE_ARGS=1\n\nOS X\u306emktemp\u306f\u3001-t\u30aa\u30d7\u30b7\u30e7\u30f3\u306e\u610f\u5473\u304cLinux\u3068\u306f\u7570\u306a\u308b\u306e\u3067\u3001\u30aa\u30d7\u30b7\u30e7\u30f3\u3092\u5916\u3057\u3066\u3057\u307e\u3044\u307e\u3057\u3087\u3046\u3002\n\n\t-CONFIG_DRIVE=$(mktemp -t -d coreos-configdrive.XXXXXXXXXX)\n\t+CONFIG_DRIVE=$(mktemp -d coreos-configdrive.XXXXXXXXXX)\n\n\u3053\u308c\u3067coreos_production_qemu.sh\u3092\u5b9f\u884c\u3059\u308b\u3068\u3001\n\n> fsdev is not supported\n\n\u3068\u3044\u3063\u305f\u30a8\u30e9\u30fc\u3067\u5b9f\u884c\u3067\u304d\u307e\u305b\u3093\u3067\u3057\u305f\u3002\u3053\u308c\u306f9p\u3092\u4f7f\u3063\u3066\u3001\u30db\u30b9\u30c8\u306e\u30ea\u30bd\u30fc\u30b9\u3092CoreOS\u304b\u3089\u53c2\u7167\u3067\u304d\u308b\u3088\u3046\u306b\u3059\u308b\u305f\u3081\u306b\u5fc5\u8981\u3067\u3059\u3002CoreOS\u306f\u3001root\u306e\u30d1\u30b9\u30ef\u30fc\u30c9\u304c\u8a2d\u5b9a\u3055\u308c\u3066\u3044\u307e\u305b\u3093\u306e\u3067\u3001\u516c\u958b\u9375\u3092\u4f7f\u3063\u3066SSH\u63a5\u7d9a\u3055\u305b\u308b\u3057\u304b\u30ed\u30b0\u30a4\u30f3\u3059\u308b\u65b9\u6cd5\u304c\u3042\u308a\u307e\u305b\u3093\u304c\u30019p\u304c\u4f7f\u3048\u306a\u3044\u306e\u3067\u3001\u516c\u958b\u9375\u3092CoreOS\u306b\u6e21\u3059\u3053\u3068\u304c\u3067\u304d\u305a\u3001\u7d50\u5c40\u30ed\u30b0\u30a4\u30f3\u3067\u304d\u307e\u305b\u3093\u3002\n\n\u3069\u3046\u3057\u3088\u3046\u304b\u306a\u3068\u601d\u3044\u307e\u3057\u305f\u304c\u3001Config Drive\u3068\u3057\u3066[cloud-config\u30d5\u30a1\u30a4\u30eb\u3092\u542b\u3080iso\u30a4\u30e1\u30fc\u30b8\u3092\u30de\u30a6\u30f3\u30c8\u3055\u305b\u308b\u65b9\u6cd5](https://coreos.com/os/docs/latest/config-drive.html)\u3067\u5bfe\u5fdc\u3067\u304d\u307e\u3057\u305f\u3002\n\n\t$ mkdir -p data/openstack/latest\n\t$ cat data/openstack/latest/user_data\n\t#cloud-config\n\n\thostname: dev\n\tssh_authorized_keys:\n\t - \"ssh-rsa XXXXXXXXXX(SSH\u516c\u958b\u9375\u306e\u5185\u5bb9)\"\n\t$ hdiutil makehybrid -iso -joliet -default-volume-name config-2 -o config.iso data\n\n\u30a4\u30e1\u30fc\u30b8\u304c\u3067\u304d\u305f\u3089\u3001\u8d77\u52d5\u30b9\u30af\u30ea\u30d7\u30c8\u306b\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\n\t-CONFIG_IMAGE=\"\"\n\t+CONFIG_IMAGE=\"config.iso\"\n\n\t(snip)\n\n\t-set -- -drive if=virtio,file=\"${CONFIG_IMAGE}\" \"$@\"\n\t+set -- -drive if=virtio,file=\"${CONFIG_IMAGE}\",media=cdrom \"$@\"\n\n## \u30ed\u30b0\u30a4\u30f3\n\n\u4ee5\u4e0b\u30b3\u30de\u30f3\u30c9\u3067\u30ed\u30b0\u30a4\u30f3\u51fa\u6765\u307e\u3059\u3002\n\n\t$ ssh -l core -p 2222 localhost\n\n## \u30db\u30b9\u30c8\u304b\u3089docker\u3092\u64cd\u4f5c\u3059\u308b\n\n\u8d77\u52d5\u30b9\u30af\u30ea\u30d7\u30c8\u3067\u3001\u30dd\u30fc\u30c8\u3092\u89e3\u653e\u3057\u307e\u3059\u3002\n\n\t+DOCKER_PORT=2375\n\n\t(snip)\n\n\tqemu-system-x86_64 \\\n\t\t-name \"$VM_NAME\" \\\n\t\t-m ${VM_MEMORY} \\\n\t\t-net nic,vlan=0,model=virtio \\\n\t-\t-net user,vlan=0,hostfwd=tcp::\"${SSH_PORT}\"-:22,hostname=\"${VM_NAME}\" \\\n\t+\t-net user,vlan=0,hostfwd=tcp::\"${SSH_PORT}\"-:22,hostfwd=tcp::\"${DOCKER_PORT}\"-:2375,hostname=\"${VM_NAME}\" \\\n\t\t\"$@\"\n\ncloud-config\u30d5\u30a1\u30a4\u30eb\u306b\u4ee5\u4e0b\u3092\u8ffd\u52a0\u3057\u3066\u3001TCP\u3067\u5f85\u3061\u53d7\u3051\u308b\u3088\u3046\u306b\u5909\u66f4\u3057\u307e\u3059\u3002\n\n```\ncoreos:\n  units:\n    - name: docker.service\n      command: start\n      enable: true\n    - name: docker-tcp.socket\n      command: start\n      enable: true\n      content: |\n        [Unit]\n        Description=Docker Socket for the API\n\n        [Socket]\n        ListenStream=2375\n        BindIPv6Only=both\n        Service=docker.service\n\n        [Install]\n        WantedBy=sockets.target\n```\n\n## \u30c7\u30a3\u30b9\u30af\u5bb9\u91cf\u306e\u8ffd\u52a0\n\n\u3053\u308c\u3067\u53ef\u80fd\u307f\u305f\u3044\u3002\n\n\tqemu-img resize coreos_production_qemu_image.img +5G\n\n\u307e\u305f\u306f\u3001\u4e0d\u8981\u306a\u30dc\u30ea\u30e5\u30fc\u30e0\u3092\u524a\u9664\u3057\u307e\u3057\u3087\u3046\u3002\n\n\tdocker volume rm $(docker volume ls -f 'dangling=true' -q)\n", "tags": ["CoreOS", "OSX", "QEMU"]}