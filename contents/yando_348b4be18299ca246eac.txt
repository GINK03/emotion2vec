{"context": " More than 1 year has passed since last update.\n\nTarget\n\nBug #522 Deleting of related issue fails - CandyCane's CandyCane - CandyCane on Engine Yard Cloud\nhttps://github.com/yandod/candycane/commit/f9efce005b64b4ce25dc17d8214ade32018a5ca4#diff-d41d8cd98f00b204e9800998ecf8427e\n\n\nPrepare\nvagrant ssh\ncd /vagrant_data/\n/usr/bin/Xvfb :1 -screen 0 1024x768x8 > /tmp/xvfb.log 2> /tmp/xvfb.error &\nexport DISPLAY=:1.0\njava -jar /var/chef/cache/selenium-server-standalone-2.39.0.jar > /tmp/selenium.log 2> /tmp/selenium.error &\nmysql -u root -e \"drop database if exists test_candycane;create database test_candycane;\"\n./vendor/bin/phpunit app/Test/Case/Selenium/InstallerTest.php\n\n\nFirst Step\n<?php\n/**\n * Created by PhpStorm.\n * User: yandod\n * Date: 2014/08/22\n * Time: 11:01\n */\n\nclass IssueTest extends PHPUnit_Extensions_Selenium2TestCase {\n\n    protected function setUp()\n    {\n        $this->setHost('127.0.0.1');\n        $this->setBrowser('firefox');\n        $this->setBrowserUrl('http://127.0.0.1/');\n        //$this->setPort(80);\n    }\n\n    public function testCreateShowDestroy()\n    {\n\n        $this->url('http://127.0.0.1/projects/sampleproject');\n        $this->assertEquals('Overview - Sample Project - CandyCane', $this->title());\n        $link = $this->byLinkText('New Issue');\n    }\n\n    public function onNotSuccessfulTest(Exception $e)\n    {\n        file_put_contents('app/tmp/logs/screenshot.png',$this->currentScreenshot());\n        throw $e;\n    }\n} \n\n./vendor/bin/phpunit app/Test/Case/Selenium/IssueTest.php\n\n\n\nLogin\n  public function testCreateShowDestroy()\n    {\n\n        //login\n        $this->url('http://127.0.0.1/account/login');\n        $input = $this->byName('data[User][username]');\n        $input->clear();\n        $input->value('admin');\n        $input = $this->byName('data[User][password]');\n        $input->clear();\n        $input->value('admin');\n        $button = $this->byName('login');\n        $this->moveto($button);\n        $this->byId('UserLoginForm')->submit();\n\n        //navigate\n        $this->url('http://127.0.0.1/projects/sampleproject');\n        $this->assertEquals('Overview - Sample Project - CandyCane', $this->title());\n        $link = $this->byLinkText('New issue');\n        $this->moveto($link);\n        $this->click();\n\n        //new issue\n        $this->assertEquals('e', $this->title());\n        file_put_contents('app/tmp/logs/screenshot.png',$this->currentScreenshot());\n    }\n\n\n\nCreate Issue\n    public function testCreateShowDestroy()\n    {\n\n        //login\n        $this->url('http://127.0.0.1/account/login');\n        $input = $this->byName('data[User][username]');\n        $input->clear();\n        $input->value('admin');\n        $input = $this->byName('data[User][password]');\n        $input->clear();\n        $input->value('admin');\n        $button = $this->byName('login');\n        $this->moveto($button);\n        $this->byId('UserLoginForm')->submit();\n\n        //navigate\n        $this->url('http://127.0.0.1/projects/sampleproject');\n        $this->assertEquals('Overview - Sample Project - CandyCane', $this->title());\n        $link = $this->byLinkText('New issue');\n        $this->moveto($link);\n        $this->click();\n\n        //new issue\n        $input = $this->byId('IssueSubject');\n        $input->value('We are in Spain');\n        $input = $this->byId('description');\n        $input->value('Hola.');\n        $this->byId('IssueAddForm')->submit();\n\n        file_put_contents('app/tmp/logs/screenshot.png',$this->currentScreenshot());\n    }\n\n\n\nAdd Relate Issue\n    public function testCreateShowDestroy()\n    {\n\n        //login\n        $this->url('http://127.0.0.1/account/login');\n        $input = $this->byName('data[User][username]');\n        $input->clear();\n        $input->value('admin');\n        $input = $this->byName('data[User][password]');\n        $input->clear();\n        $input->value('admin');\n        $button = $this->byName('login');\n        $this->moveto($button);\n        $this->byId('UserLoginForm')->submit();\n\n        //navigate\n        $this->url('http://127.0.0.1/projects/sampleproject');\n        $this->assertEquals('Overview - Sample Project - CandyCane', $this->title());\n        $link = $this->byLinkText('New issue');\n        $this->moveto($link);\n        $this->click();\n\n        //new issue\n        $input = $this->byId('IssueSubject');\n        $input->value('We are in Spain');\n        $input = $this->byId('description');\n        $input->value('Hola.');\n        $this->byId('IssueAddForm')->submit();\n\n        //add more issue\n        $link = $this->byLinkText('New issue');\n        $this->moveto($link);\n        $this->click();\n        $input = $this->byId('IssueSubject');\n        $input->value('We are in Madrid');\n        $input = $this->byId('description');\n        $input->value('Madrid is center of Spain.');\n        $this->byId('IssueAddForm')->submit();\n\n        //link issue\n        $link = $this->byLinkText('Add');\n        $this->moveto($link);\n        $this->click();\n        $input = $this->byId('IssueRelationIssueToId');\n        $current_id = array_pop(explode('/',$this->url())) - 1;\n        $input->value($current_id);\n        $this->byId('new-relation-form')->submit();\n        $this->timeouts()->implicitWait(800);\n\n        file_put_contents('app/tmp/logs/screenshot.png',$this->currentScreenshot());\n    }\n\n\n\nClick delete relation.\nXPath!\n    public function testCreateShowDestroy()\n    {\n\n        //login\n        $this->url('http://127.0.0.1/account/login');\n        $input = $this->byName('data[User][username]');\n        $input->clear();\n        $input->value('admin');\n        $input = $this->byName('data[User][password]');\n        $input->clear();\n        $input->value('admin');\n        $button = $this->byName('login');\n        $this->moveto($button);\n        $this->byId('UserLoginForm')->submit();\n\n        //navigate\n        $this->url('http://127.0.0.1/projects/sampleproject');\n        $this->assertEquals('Overview - Sample Project - CandyCane', $this->title());\n        $link = $this->byLinkText('New issue');\n        $this->moveto($link);\n        $this->click();\n        $this->timeouts()->implicitWait(300);\n\n        //new issue\n        $input = $this->byId('IssueSubject');\n        $input->value('We are in Spain');\n        $input = $this->byId('description');\n        $input->value('Hola.');\n        $this->byId('IssueAddForm')->submit();\n\n        //add more issue\n        $link = $this->byLinkText('New issue');\n        $this->moveto($link);\n        $this->click();\n        $input = $this->byId('IssueSubject');\n        $input->value('We are in Madrid');\n        $input = $this->byId('description');\n        $input->value('Madrid is center of Spain.');\n        $this->byId('IssueAddForm')->submit();\n\n        //link issue\n        $link = $this->byLinkText('Add');\n        $this->moveto($link);\n        $this->click();\n        $input = $this->byId('IssueRelationIssueToId');\n        $current_id = array_pop(explode('/',$this->url())) - 1;\n        $input->value($current_id);\n        $this->byId('new-relation-form')->submit();\n        $this->timeouts()->implicitWait(800);\n\n        //delete relation\n        $link = $this->byXPath(\"//a[@title='Delete relation']\");\n        $this->moveto($link);\n        $this->click();\n        $this->timeouts()->implicitWait(300);\n\n        file_put_contents('app/tmp/logs/screenshot.png',$this->currentScreenshot());\n    }\n\n\n\nBug Fix!\n\nIssueReleationsController.php\n    function destroy($relation_id)\n    {\n        if ($this->request->is('ajax')) {\n            Configure::write('debug', 0);\n        }\n\n        $relation = $this->IssueRelation->read(null, $relation_id);\n        if ($relation) {\n            $this->IssueRelation->delete();\n        }\n\n        $this->redirect(array('controller' => 'issues', 'action' => 'show', $this->_issue['Issue']['id']));\n    }\n\n\n\nView/Elements/issues/relations.ctp\n  <?php if($this->Candy->authorize_for(array('controller'=>'issue_relations', 'action'=>'destroy'))) {\n    echo $this->Js->link($this->Html->image('delete.png'), \n      array('controller'=>'issue_relations', 'action'=>'destroy', 'issue_id'=>$issue['Issue']['id'], $relation['IssueRelation']['id']),\n      array('method'=>'post', 'title'=> __('Delete relation'), 'update'=>'relations', 'escape' => false));\n  }?>\n\n\n\n\n# Target\n\n- [Bug #522 Deleting of related issue fails - CandyCane's CandyCane - CandyCane on Engine Yard Cloud](http://my.candycane.jp/issues/show/522)\n- https://github.com/yandod/candycane/commit/f9efce005b64b4ce25dc17d8214ade32018a5ca4#diff-d41d8cd98f00b204e9800998ecf8427e\n\n## Prepare\n\n```\nvagrant ssh\ncd /vagrant_data/\n/usr/bin/Xvfb :1 -screen 0 1024x768x8 > /tmp/xvfb.log 2> /tmp/xvfb.error &\nexport DISPLAY=:1.0\njava -jar /var/chef/cache/selenium-server-standalone-2.39.0.jar > /tmp/selenium.log 2> /tmp/selenium.error &\nmysql -u root -e \"drop database if exists test_candycane;create database test_candycane;\"\n./vendor/bin/phpunit app/Test/Case/Selenium/InstallerTest.php\n```\n\n## First Step\n\n```\n<?php\n/**\n * Created by PhpStorm.\n * User: yandod\n * Date: 2014/08/22\n * Time: 11:01\n */\n\nclass IssueTest extends PHPUnit_Extensions_Selenium2TestCase {\n\n    protected function setUp()\n    {\n        $this->setHost('127.0.0.1');\n        $this->setBrowser('firefox');\n        $this->setBrowserUrl('http://127.0.0.1/');\n        //$this->setPort(80);\n    }\n\n    public function testCreateShowDestroy()\n    {\n\n        $this->url('http://127.0.0.1/projects/sampleproject');\n        $this->assertEquals('Overview - Sample Project - CandyCane', $this->title());\n        $link = $this->byLinkText('New Issue');\n    }\n\n    public function onNotSuccessfulTest(Exception $e)\n    {\n        file_put_contents('app/tmp/logs/screenshot.png',$this->currentScreenshot());\n\t\tthrow $e;\n    }\n} \n```\n\n```\n./vendor/bin/phpunit app/Test/Case/Selenium/IssueTest.php\n```\n\n![screenshot.png](https://qiita-image-store.s3.amazonaws.com/0/10032/c5dd50c0-4e93-f4f9-fb59-d5742b806b70.png \"screenshot.png\")\n\n## Login\n\n```\n  public function testCreateShowDestroy()\n    {\n\n        //login\n        $this->url('http://127.0.0.1/account/login');\n        $input = $this->byName('data[User][username]');\n        $input->clear();\n        $input->value('admin');\n        $input = $this->byName('data[User][password]');\n        $input->clear();\n        $input->value('admin');\n        $button = $this->byName('login');\n        $this->moveto($button);\n        $this->byId('UserLoginForm')->submit();\n\n        //navigate\n        $this->url('http://127.0.0.1/projects/sampleproject');\n        $this->assertEquals('Overview - Sample Project - CandyCane', $this->title());\n        $link = $this->byLinkText('New issue');\n        $this->moveto($link);\n        $this->click();\n\n        //new issue\n        $this->assertEquals('e', $this->title());\n        file_put_contents('app/tmp/logs/screenshot.png',$this->currentScreenshot());\n    }\n```\n\n![screenshot.png](https://qiita-image-store.s3.amazonaws.com/0/10032/22b66a1f-c24a-ddc0-cc77-2af16bb502b7.png \"screenshot.png\")\n\n## Create Issue\n\n```\n    public function testCreateShowDestroy()\n    {\n\n        //login\n        $this->url('http://127.0.0.1/account/login');\n        $input = $this->byName('data[User][username]');\n        $input->clear();\n        $input->value('admin');\n        $input = $this->byName('data[User][password]');\n        $input->clear();\n        $input->value('admin');\n        $button = $this->byName('login');\n        $this->moveto($button);\n        $this->byId('UserLoginForm')->submit();\n\n        //navigate\n        $this->url('http://127.0.0.1/projects/sampleproject');\n        $this->assertEquals('Overview - Sample Project - CandyCane', $this->title());\n        $link = $this->byLinkText('New issue');\n        $this->moveto($link);\n        $this->click();\n\n        //new issue\n        $input = $this->byId('IssueSubject');\n        $input->value('We are in Spain');\n        $input = $this->byId('description');\n        $input->value('Hola.');\n        $this->byId('IssueAddForm')->submit();\n\n        file_put_contents('app/tmp/logs/screenshot.png',$this->currentScreenshot());\n    }\n```\n\n![screenshot.png](https://qiita-image-store.s3.amazonaws.com/0/10032/0adc16cc-b745-76b7-ce8a-48578f26f466.png \"screenshot.png\")\n\n## Add Relate Issue\n\n```\n    public function testCreateShowDestroy()\n    {\n\n        //login\n        $this->url('http://127.0.0.1/account/login');\n        $input = $this->byName('data[User][username]');\n        $input->clear();\n        $input->value('admin');\n        $input = $this->byName('data[User][password]');\n        $input->clear();\n        $input->value('admin');\n        $button = $this->byName('login');\n        $this->moveto($button);\n        $this->byId('UserLoginForm')->submit();\n\n        //navigate\n        $this->url('http://127.0.0.1/projects/sampleproject');\n        $this->assertEquals('Overview - Sample Project - CandyCane', $this->title());\n        $link = $this->byLinkText('New issue');\n        $this->moveto($link);\n        $this->click();\n\n        //new issue\n        $input = $this->byId('IssueSubject');\n        $input->value('We are in Spain');\n        $input = $this->byId('description');\n        $input->value('Hola.');\n        $this->byId('IssueAddForm')->submit();\n\n        //add more issue\n        $link = $this->byLinkText('New issue');\n        $this->moveto($link);\n        $this->click();\n        $input = $this->byId('IssueSubject');\n        $input->value('We are in Madrid');\n        $input = $this->byId('description');\n        $input->value('Madrid is center of Spain.');\n        $this->byId('IssueAddForm')->submit();\n\n        //link issue\n        $link = $this->byLinkText('Add');\n        $this->moveto($link);\n        $this->click();\n        $input = $this->byId('IssueRelationIssueToId');\n        $current_id = array_pop(explode('/',$this->url())) - 1;\n        $input->value($current_id);\n        $this->byId('new-relation-form')->submit();\n        $this->timeouts()->implicitWait(800);\n\n        file_put_contents('app/tmp/logs/screenshot.png',$this->currentScreenshot());\n    }\n```\n\n![screenshot.png](https://qiita-image-store.s3.amazonaws.com/0/10032/57c3245c-ebf8-7584-1887-2b5492e43d4f.png \"screenshot.png\")\n\n## Click delete relation.\n\nXPath!\n\n```\n    public function testCreateShowDestroy()\n    {\n\n        //login\n        $this->url('http://127.0.0.1/account/login');\n        $input = $this->byName('data[User][username]');\n        $input->clear();\n        $input->value('admin');\n        $input = $this->byName('data[User][password]');\n        $input->clear();\n        $input->value('admin');\n        $button = $this->byName('login');\n        $this->moveto($button);\n        $this->byId('UserLoginForm')->submit();\n\n        //navigate\n        $this->url('http://127.0.0.1/projects/sampleproject');\n        $this->assertEquals('Overview - Sample Project - CandyCane', $this->title());\n        $link = $this->byLinkText('New issue');\n        $this->moveto($link);\n        $this->click();\n        $this->timeouts()->implicitWait(300);\n\n        //new issue\n        $input = $this->byId('IssueSubject');\n        $input->value('We are in Spain');\n        $input = $this->byId('description');\n        $input->value('Hola.');\n        $this->byId('IssueAddForm')->submit();\n\n        //add more issue\n        $link = $this->byLinkText('New issue');\n        $this->moveto($link);\n        $this->click();\n        $input = $this->byId('IssueSubject');\n        $input->value('We are in Madrid');\n        $input = $this->byId('description');\n        $input->value('Madrid is center of Spain.');\n        $this->byId('IssueAddForm')->submit();\n\n        //link issue\n        $link = $this->byLinkText('Add');\n        $this->moveto($link);\n        $this->click();\n        $input = $this->byId('IssueRelationIssueToId');\n        $current_id = array_pop(explode('/',$this->url())) - 1;\n        $input->value($current_id);\n        $this->byId('new-relation-form')->submit();\n        $this->timeouts()->implicitWait(800);\n\n        //delete relation\n        $link = $this->byXPath(\"//a[@title='Delete relation']\");\n        $this->moveto($link);\n        $this->click();\n        $this->timeouts()->implicitWait(300);\n\n        file_put_contents('app/tmp/logs/screenshot.png',$this->currentScreenshot());\n    }\n```\n\n![screenshot.png](https://qiita-image-store.s3.amazonaws.com/0/10032/06effb64-2dfb-e9e7-2cde-f27c45c267c5.png \"screenshot.png\")\n\n## Bug Fix!\n\n```php:IssueReleationsController.php\n    function destroy($relation_id)\n    {\n        if ($this->request->is('ajax')) {\n            Configure::write('debug', 0);\n        }\n\n        $relation = $this->IssueRelation->read(null, $relation_id);\n        if ($relation) {\n            $this->IssueRelation->delete();\n        }\n\n        $this->redirect(array('controller' => 'issues', 'action' => 'show', $this->_issue['Issue']['id']));\n    }\n```\n\n```php:View/Elements/issues/relations.ctp\n  <?php if($this->Candy->authorize_for(array('controller'=>'issue_relations', 'action'=>'destroy'))) {\n    echo $this->Js->link($this->Html->image('delete.png'), \n      array('controller'=>'issue_relations', 'action'=>'destroy', 'issue_id'=>$issue['Issue']['id'], $relation['IssueRelation']['id']),\n      array('method'=>'post', 'title'=> __('Delete relation'), 'update'=>'relations', 'escape' => false));\n  }?>\n```\n\n![screenshot.png](https://qiita-image-store.s3.amazonaws.com/0/10032/1360e433-e08b-2a5d-3a34-bcdef1337a63.png \"screenshot.png\")\n", "tags": ["CakePHP", "Selenium"]}