{"context": "\n\nlaravel-nested\u3068\u3084\u3089\u3092\u5229\u7528\ngithub: https://github.com/lazychaser/laravel-nestedset\n\u4ed6\u306bhttps://github.com/etrepat/baum \u304c\u540c\u3058\u3088\u3046\u306a\u30d7\u30e9\u30b0\u30a4\u30f3\u3060\u3063\u305f\u3051\u3069(\u30b9\u30bf\u30fc\u6570\u3082\u591a\u3044)\n\u958b\u767a\u304c\u7d42\u308f\u3063\u3066\u305d\u3046\u306a\u306e\u3067\u3084\u3081\u305f\u3002\nlaravel-nested\u306f\u3001v4\u3067laravel5.2 / 5.3\u3092\u8ffd\u3063\u304b\u3051\u3066\u308b\u306e\u3082\u597d\u5370\u8c61\u3002\n\u968e\u5c64\u69cb\u9020\u306e\u8868\u73fe\u306f\u5165\u308c\u5b50\u96c6\u5408\u3092\u4f7f\u3063\u3066\u3044\u308b\n(cake\u306etree behavior\u3082\u5165\u308c\u5b50\u96c6\u5408\u3089\u3057\u3044)\n\n\u74b0\u5883\nphp5.6.27\nlaravel5.1\u7cfb\n\u306a\u306e\u3067\u3001laravel-nested\u306ev3\u3092\u4f7f\u3063\u3066\u307f\u308b\u3002\n\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n$ php composer.phar require kalnoy/nestedset:3.1.3\n\n\nmigration\u4f5c\u6210\n\n\u968e\u5c64\u69cb\u9020\u3092\u3082\u3064\u30ab\u30c6\u30b4\u30ea\u30fc\u3092\u5b9f\u88c5\u3059\u308b\u3053\u3068\u306b\u3059\u308b\n\nmigration\u30d5\u30a1\u30a4\u30eb\u4f5c\u6210\n$ php artisan make:migration create_categories_table\n\n\n\u7de8\u96c6\n\n*_create_categories_table.php\n\nuse Illuminate\\Database\\Schema\\Blueprint;\nuse Illuminate\\Database\\Migrations\\Migration;\nuse Kalnoy\\Nestedset\\NestedSet;\n\nclass CreateCategoriesTable extends Migration\n{\n    /**\n     * Run the migrations.\n     *\n     * @return void\n     */\n    public function up()\n    {\n        Schema::create('categories', function (Blueprint $table) {\n            NestedSet::columns($table);\n        });\n    }\n\n    /**\n     * Reverse the migrations.\n     *\n     * @return void\n     */\n    public function down()\n    {\n        Schema::table('categories', function (Blueprint $table) {\n            NestedSet::dropColumns($table);\n        });\n    }\n}\n\n\n\nmigration\u5b9f\u884c\n$ php artisan migrate\n\n\n\u30c6\u30fc\u30d6\u30eb\u78ba\u8a8d\nmysql> show columns from categories;\n+-----------+------------------+------+-----+---------+-------+\n| Field     | Type             | Null | Key | Default | Extra |\n+-----------+------------------+------+-----+---------+-------+\n| _lft      | int(10) unsigned | NO   | MUL | NULL    |       |\n| _rgt      | int(10) unsigned | NO   |     | NULL    |       |\n| parent_id | int(10) unsigned | YES  |     | NULL    |       |\n+-----------+------------------+------+-----+---------+-------+\n\n\u5165\u308c\u5b50\u96c6\u5408\u306b\u6700\u4f4e\u9650\u5fc5\u8981\u306a\u90e8\u5206\u3057\u304b\u4f5c\u3063\u3066\u304f\u308c\u306a\u3044\u306e\u3067\u3084\u308a\u306a\u304a\u3057\nmigration\u8ffd\u52a0\n    /**\n     * Run the migrations.\n     *\n     * @return void\n     */\n    public function up()\n    {\n        Schema::table('categories', function (Blueprint $table) {\n            $table->increments('id');\n            $table->string('name', 100);\n            $table->timestamps();\n        });\n    }\n\nmigration\u5b9f\u884c\u3057\u3001\u3072\u3068\u307e\u305a\u3053\u3093\u306a\u611f\u3058\u3067\nmysql> show columns from categories;\n+------------+------------------+------+-----+---------------------+----------------+\n| Field      | Type             | Null | Key | Default             | Extra          |\n+------------+------------------+------+-----+---------------------+----------------+\n| id         | int(10) unsigned | NO   | PRI | NULL                | auto_increment |\n| name       | varchar(100)     | NO   |     | NULL                |                |\n| _lft       | int(10) unsigned | NO   | MUL | NULL                |                |\n| _rgt       | int(10) unsigned | NO   |     | NULL                |                |\n| parent_id  | int(10) unsigned | YES  |     | NULL                |                |\n| created_at | timestamp        | NO   |     | 0000-00-00 00:00:00 |                |\n| updated_at | timestamp        | NO   |     | 0000-00-00 00:00:00 |                |\n+------------+------------------+------+-----+---------------------+----------------+\n8 rows in set (0.00 sec)\n\n\n\u8a66\u3057\u306b\u4f7f\u3063\u3066\u307f\u308b\n\u30d3\u30e5\u30fc\u4f5c\u308b\u306e\u306f\u3081\u3093\u3069\u304f\u3055\u3044\u306e\u3067\u30b3\u30de\u30f3\u30c9\u3067\u898b\u3066\u3044\u304f\n$ php artisan make:console TestCommand --command=\"batchtest\"\n$ php artisan batchtest\n\n\u30b3\u30de\u30f3\u30c9\u306b\u540d\u524d\u4ed8\u3051\u3089\u308c\u308b\u3093\u3060\u3002\u3002\n\nCategory Model\nEloquentModel\u306f\u4f7f\u308f\u306a\u3044\u3002\n\napp/Models/Category.php\nuse Kalnoy\\Nestedset\\Node;\n\nclass Category extends Node\n{\n    /**\n     * \u30e2\u30c7\u30eb\u306b\u95a2\u9023\u4ed8\u3051\u308b\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306e\u30c6\u30fc\u30d6\u30eb\u3092\u6307\u5b9a\n     *\n     * @var string\n     */\n    protected $table = 'categories';\n\n    /**\n     * create\u30e1\u30bd\u30c3\u30c9\u5b9f\u884c\u6642\u306b\u3001\u5165\u529b\u3092\u8a31\u53ef\u3059\u308b\u30ab\u30e9\u30e0\u306e\u6307\u5b9a\n     *\n     * @var array\n     */\n    protected $fillable = array('name');\n}\n\n\n\n\u30d0\u30c3\u30c1\n\u3072\u3068\u307e\u305a\u30c7\u30fc\u30bf\u304c\u4fdd\u5b58\u3055\u308c\u308b\u306e\u304b\u968e\u5c64\u69cb\u9020\u3092\u4f5c\u3063\u3066\u4fdd\u5b58\u3057\u3066\u307f\u308b\n\napp/Console/Commands/TestCommand.php\n<?php\n\nnamespace App\\Console\\Commands;\n\nuse Illuminate\\Console\\Command;\nuse App\\Models\\Category;\n\nclass TestCommand extends Command\n{\n    /**\n     * The name and signature of the console command.\n     *\n     * @var string\n     */\n    protected $signature = 'batchtest';\n\n    /**\n     * The console command description.\n     *\n     * @var string\n     */\n    protected $description = 'Command description';\n\n    /**\n     * App\\Models\\Category\n     *\n     * @var string\n     */\n    protected $Category;\n\n    /**\n     * Create a new command instance.\n     *\n     * @return void\n     */\n    public function __construct()\n    {\n        parent::__construct();\n        $this->Category = new Category();\n    }\n\n    /**\n     * Execute the console command.\n     *\n     * @return mixed\n     */\n    public function handle()\n    {\n        //Foo - Bar - Baz\u306e\u968e\u5c64\u69cb\u9020\n        $node = Category::create([\n            'name' => 'Foo',\n\n            'children' => [\n                [\n                    'name' => 'Bar',\n\n                    'children' => [\n                        [ 'name' => 'Baz' ],\n                    ],\n                ],\n            ],\n        ]);\n    }\n}\n\n\n\n\u5b9f\u884c\n$ php artisan batchtest\n\nselect * from categories;\n\n+------+------+-----------+----+------+--------------------+---------------------+\n| _lft | _rgt | parent_id | id | name | created_at          | updated_at          |\n+------+------+-----------+----+------+--------------------+---------------------+\n|    1 |    6 |      NULL |  1 | Foo  | 2016-11-07 21:19:00 | 2016-11-07 21:19:00 |\n|    2 |    5 |         1 |  2 | Bar  | 2016-11-07 21:19:00 | 2016-11-07 21:19:00 |\n|    3 |    4 |         2 |  3 | Baz  | 2016-11-07 21:19:00 | 2016-11-07 21:19:00 |\n+------+------+-----------+----+------+----------+---------------------+----------+\n\n\u4fdd\u5b58\u3055\u308c\u3066\u308b\u3001\u8ce2\u3044\uff01\n\n\u4f7f\u3044\u65b9\u3092\u898b\u3066\u3044\u304f\n\n\u30ab\u30c6\u30b4\u30ea\u306e\u8ffd\u52a0\n/**\n * ex.)\n * $attributes = ['name' => 'hoge']\n */\n$this->Category->create($attributes);\n\n\n\u3042\u308b\u30ab\u30c6\u30b4\u30ea\u3092\u4e00\u756a\u4e0a\u306b\u5206\u985e\u3059\u308b\n//\u4e0a\u8a18\u306eid2\u306e\u30c7\u30fc\u30bf\u306b\u5bfe\u3057\u3066\u5b9f\u884c\n$node = $this->Category->find(2);\n$node->saveAsRoot();\n\n+------+------+-----------+----+------+---------------------+---------------------+\n| _lft | _rgt | parent_id | id | name |  created_at          | updated_at          |\n+------+------+-----------+----+------+----------------------+---------------------+\n|    1 |    2 |      NULL |  1 | Foo  |  2016-11-07 21:19:00 | 2016-11-07 21:19:00 |\n|    3 |    6 |      NULL |  2 | Bar  |  2016-11-07 21:19:00 | 2016-11-08 10:45:01 |\n|    4 |    5 |         2 |  3 | Baz  |  2016-11-07 21:19:00 | 2016-11-07 21:19:00 |\n+------+------+-----------+----+------+----------------------+---------------------+\n\nparent_id\u304cnull\u306b\u306a\u3063\u3066\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3067\u304d\u305f(\u89aa\u3092\u6301\u305f\u306a\u304f\u306a\u3063\u305f)\nid2\u304c\u6301\u3063\u3066\u3044\u305f\u5b50\u306e\u7d10\u3065\u3051\u3082\u7dad\u6301\u3055\u308c\u3066\u3044\u308b\n\n\n\u65e2\u5b58\u306e\u30ab\u30c6\u30b4\u30ea\u3092\u89aa\u30ab\u30c6\u30b4\u30ea\u306b\u7d10\u3065\u3051\u308b(Bar\u306e\u5b50\u30ab\u30c6\u30b4\u30ea\u306bFoo\u3092\u7d10\u3065\u3051\u308b)\n$parent = $this->Category->find(2); //Bar\n$children = $this->Category->find(1); //Foo\n\n$parent->appendNode($children);\n\n+------+------+-----------+----+------+---------------------+---------------------+\n| _lft | _rgt | parent_id | id | name | created_at          | updated_at          |\n+------+------+-----------+----+------+---------------------+---------------------+\n|    4 |    5 |         2 |  1 | Foo  | 2016-11-07 21:19:00 | 2016-11-08 11:13:39 |  //\u7d10\u3065\u3044\u305f\n|    1 |    6 |      NULL |  2 | Bar  | 2016-11-07 21:19:00 | 2016-11-08 10:45:01 |\n\n\u6319\u52d5\u306f\u540c\u3058\u3060\u3051\u3069\u5b50\u5074\u304b\u3089\u3084\u308b\u5834\u5408\u306f\u3053\u3046\n\u2460\n$parent = $this->Category->find(2);\n$children = $this->Category->find(1);\n\n$children->appendTo($parent)->save();\n\n\u2461\n$parent = $this->Category->find(2);\n$children = $this->Category->find(1);\n\n$children->parent_id = $parent->id;\n$children->save();\n\n\n\u89aa\u306b\u5b50\u3092\u8ffd\u52a0\n$parent = $this->Category->create(['name' => 'FUGA']);\n//\u5b50\u3092\u8ffd\u52a0\n$parent->children()->create(['name' => 'HOGE']);\n\n+------+------+-----------+----+------+---------------------+---------------------+\n| _lft | _rgt | parent_id | id | name | created_at          | updated_at          |\n+------+------+-----------+----+------+---------------------+---------------------+\n|    1 |    4 |      NULL |  1 | FUGA | 2016-11-08 11:27:08 | 2016-11-08 11:27:08 |\n|    2 |    3 |         1 |  2 | HOGE | 2016-11-08 11:27:08 | 2016-11-08 11:27:08 |\n+------+------+-----------+----+------+---------------------+---------------------+\n\n\n\u524a\u9664\n$node = $this->Category->find(2);\n\n$node->delete();\n\n\n\u968e\u5c64\u69cb\u9020\u3092\u51fa\u529b\ndata\n+------+------+-----------+----+---------------+---------------------+---------------------+\n| _lft | _rgt | parent_id | id | name          | created_at          | updated_at          |\n+------+------+-----------+----+---------------+---------------------+---------------------+\n|    1 |   16 |      NULL |  1 | HOGE          | 2016-11-08 11:44:51 | 2016-11-08 11:44:51 |\n|    2 |   13 |         1 |  2 | FUGA          | 2016-11-08 11:44:51 | 2016-11-08 11:44:51 |\n|   17 |   22 |      NULL |  3 | HOGE_2        | 2016-11-08 11:45:07 | 2016-11-08 11:45:07 |\n|   18 |   21 |         3 |  4 | FUGA_2        | 2016-11-08 11:45:07 | 2016-11-08 11:45:07 |\n|   19 |   20 |         4 |  5 | HOGEFUGA_2    | 2016-11-08 11:52:51 | 2016-11-08 11:52:51 |\n|    3 |    4 |         2 |  6 | HOGEFUGA      | 2016-11-08 12:29:33 | 2016-11-08 12:29:33 |\n|   14 |   15 |         1 | 11 | HOGE_children | 2016-11-08 12:44:28 | 2016-11-08 12:44:28 |\n+------+------+-----------+----+---------------+--------------------+---------------------+\n\n$results = $this->Category->get();\n$tree = $results->toTree();\n\n$traverse = function ($categories, $prefix = '-') use (&$traverse) {\n    foreach ($categories as $category) {\n        echo PHP_EOL.$prefix.' '.$category->name;\n\n        $traverse($category->children, $prefix.'-');\n    }\n};\n\n$traverse($tree);\n\nResult\n- HOGE\n-- FUGA\n--- HOGEFUGA\n-- HOGE_children\n- HOGE_2\n-- FUGA_2\n--- HOGEFUGA_2\n\n\u305d\u306e\u4ed6\u307e\u3060\u6a5f\u80fd\u3042\u308b\u307f\u305f\u3044\u3067\u3059\u304c\u6700\u4f4e\u9650\u3053\u308c\u304f\u3089\u3044\u77e5\u3063\u3068\u3051\u3070\u4f7f\u3048\u308b\u306e\u304b\u306a\n\u4fbf\u5229\u306a\u306e\u304c\u3042\u3063\u305f\u3089\u8ffd\u8a18\u3057\u3066\u3044\u304d\u307e\u3059\n\n\u8ffd\u8a18\n\ndata\n+----+--------------------------+-----------+------+------+\n| id | name                     | parent_id | _lft | _rgt |\n+----+--------------------------+-----------+------+------+\n|  1 | testA                    |      NULL |    1 |   10 |\n|  2 | testA_childA             |         1 |    2 |    9 |\n|  3 | testA_childA_grandChildA |         2 |    3 |    4 |\n|  5 | testA_childA_grandChildB |         2 |    5 |    6 |\n|  6 | testA_childA_grandChildC |         2 |    7 |    8 |\n+----+--------------------------+-----------+------+------+\n\n\n\u5b50\u306e\u53d6\u5f97\n$parent = $category->find(1);\n$parent->ancestors()->get();//\u5168\u3066\u306e\u5b50\u5b6b\u304c\u53d6\u5f97\u3055\u308c\u308b\u3002\u4e0a\u8a18\u306e\u4f8b\u3067\u3044\u3046\u3068id3,5,6\u306e\u5b6b\u3082\u542b\u307e\u308c\u308b\n\n\n\u89aa\u306e\u53d6\u5f97\n$grandchild = $category->find(3);\n$grandchild->descendants()->get();//\u5168\u3066\u306e\u89aa\u304c\u53d6\u5f97\u3055\u308c\u308b\u3002\n\n\n\u540c\u3058\u968e\u5c64\u306b\u3044\u308b\u30c7\u30fc\u30bf\u3092\u6301\u3063\u3066\u304f\u308b\n$grandchild = $category->find(3);\n$grandchild->siblings()->get(); //id 5,6\u306e\u30c7\u30fc\u30bf\u3092\u6301\u3063\u3066\u304f\u308b\n\n\n\u6df1\u3055\u306e\u30d7\u30ed\u30d1\u30c6\u30a3\u3092\u6301\u3064\u3088\u3046\u306b\u30c7\u30fc\u30bf\u3092\u53d6\u5f97\n$grandchild = $category->withDepth()->find(3);\ndd($grandchild->depth);  //2\n\n$parent = $category->withDepth()->find(1);\ndd($parent->depth);  //0\n\n\n\u7279\u5b9a\u306e\u6df1\u3055\u306b\u3044\u308b\u30c7\u30fc\u30bf\u3092\u53d6\u5f97\n$grandchildren = $category->withDepth()->having('depth', '=', 2)->get();\n\ndd($grandchildren); //id 3, 5, 6\n\n\n\u5fc5\u305a\u4fdd\u5b58\u3055\u308c\u3066\u3044\u308b\u5024\u306e_lft\u3067\u30bd\u30fc\u30c8\n$category->defaultOrder()->get();\n\n//inverse\n$category->reversed()->get();\n\n\ndelete\u306frecursive\u306b\u884c\u308f\u308c\u308b\n$category->delete()\n\n\u5b50\u3092\u6301\u3063\u3066\u3044\u308b\u5834\u5408\u306f\u524a\u9664\u3055\u308c\u308b\n\n\u73fe\u5728\u306e\u30ab\u30c6\u30b4\u30ea\u304c\u89aa\u30ab\u30c6\u30b4\u30ea\u304b\n$node->isRoot()\n\n\n\u89aa\u5b50\u95a2\u4fc2\u8981\u7d20\u3078\u306e\u30a2\u30af\u30bb\u30b9\n$node->children\n$node->parent\n\n## laravel-nested\u3068\u3084\u3089\u3092\u5229\u7528\ngithub: https://github.com/lazychaser/laravel-nestedset\n\u4ed6\u306bhttps://github.com/etrepat/baum \u304c\u540c\u3058\u3088\u3046\u306a\u30d7\u30e9\u30b0\u30a4\u30f3\u3060\u3063\u305f\u3051\u3069(\u30b9\u30bf\u30fc\u6570\u3082\u591a\u3044)\n\u958b\u767a\u304c\u7d42\u308f\u3063\u3066\u305d\u3046\u306a\u306e\u3067\u3084\u3081\u305f\u3002\nlaravel-nested\u306f\u3001v4\u3067laravel5.2 / 5.3\u3092\u8ffd\u3063\u304b\u3051\u3066\u308b\u306e\u3082\u597d\u5370\u8c61\u3002\n\n__\u968e\u5c64\u69cb\u9020\u306e\u8868\u73fe\u306f\u5165\u308c\u5b50\u96c6\u5408\u3092\u4f7f\u3063\u3066\u3044\u308b__\n(cake\u306etree behavior\u3082\u5165\u308c\u5b50\u96c6\u5408\u3089\u3057\u3044)\n\n## \u74b0\u5883\n__php5.6.27__\n__laravel5.1\u7cfb__\n\n\u306a\u306e\u3067\u3001laravel-nested\u306ev3\u3092\u4f7f\u3063\u3066\u307f\u308b\u3002\n\n## \u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n```bash\n$ php composer.phar require kalnoy/nestedset:3.1.3\n```\n\n## migration\u4f5c\u6210\n\n### \u968e\u5c64\u69cb\u9020\u3092\u3082\u3064\u30ab\u30c6\u30b4\u30ea\u30fc\u3092\u5b9f\u88c5\u3059\u308b\u3053\u3068\u306b\u3059\u308b\n\n### migration\u30d5\u30a1\u30a4\u30eb\u4f5c\u6210\n\n```bash\n$ php artisan make:migration create_categories_table\n```\n\n### \u7de8\u96c6\n\n```php:*_create_categories_table.php\n\nuse Illuminate\\Database\\Schema\\Blueprint;\nuse Illuminate\\Database\\Migrations\\Migration;\nuse Kalnoy\\Nestedset\\NestedSet;\n\nclass CreateCategoriesTable extends Migration\n{\n    /**\n     * Run the migrations.\n     *\n     * @return void\n     */\n    public function up()\n    {\n        Schema::create('categories', function (Blueprint $table) {\n            NestedSet::columns($table);\n        });\n    }\n\n    /**\n     * Reverse the migrations.\n     *\n     * @return void\n     */\n    public function down()\n    {\n        Schema::table('categories', function (Blueprint $table) {\n            NestedSet::dropColumns($table);\n        });\n    }\n}\n```\n\n### migration\u5b9f\u884c\n\n```bash\n$ php artisan migrate\n```\n\n### \u30c6\u30fc\u30d6\u30eb\u78ba\u8a8d\n\n```\nmysql> show columns from categories;\n+-----------+------------------+------+-----+---------+-------+\n| Field     | Type             | Null | Key | Default | Extra |\n+-----------+------------------+------+-----+---------+-------+\n| _lft      | int(10) unsigned | NO   | MUL | NULL    |       |\n| _rgt      | int(10) unsigned | NO   |     | NULL    |       |\n| parent_id | int(10) unsigned | YES  |     | NULL    |       |\n+-----------+------------------+------+-----+---------+-------+\n```\n\n\u5165\u308c\u5b50\u96c6\u5408\u306b\u6700\u4f4e\u9650\u5fc5\u8981\u306a\u90e8\u5206\u3057\u304b\u4f5c\u3063\u3066\u304f\u308c\u306a\u3044\u306e\u3067\u3084\u308a\u306a\u304a\u3057\nmigration\u8ffd\u52a0\n\n```php:\n    /**\n     * Run the migrations.\n     *\n     * @return void\n     */\n    public function up()\n    {\n        Schema::table('categories', function (Blueprint $table) {\n            $table->increments('id');\n            $table->string('name', 100);\n            $table->timestamps();\n        });\n    }\n```\n\nmigration\u5b9f\u884c\u3057\u3001\u3072\u3068\u307e\u305a\u3053\u3093\u306a\u611f\u3058\u3067\n\n```\nmysql> show columns from categories;\n+------------+------------------+------+-----+---------------------+----------------+\n| Field      | Type             | Null | Key | Default             | Extra          |\n+------------+------------------+------+-----+---------------------+----------------+\n| id         | int(10) unsigned | NO   | PRI | NULL                | auto_increment |\n| name       | varchar(100)     | NO   |     | NULL                |                |\n| _lft       | int(10) unsigned | NO   | MUL | NULL                |                |\n| _rgt       | int(10) unsigned | NO   |     | NULL                |                |\n| parent_id  | int(10) unsigned | YES  |     | NULL                |                |\n| created_at | timestamp        | NO   |     | 0000-00-00 00:00:00 |                |\n| updated_at | timestamp        | NO   |     | 0000-00-00 00:00:00 |                |\n+------------+------------------+------+-----+---------------------+----------------+\n8 rows in set (0.00 sec)\n```\n\n## \u8a66\u3057\u306b\u4f7f\u3063\u3066\u307f\u308b\n\n\u30d3\u30e5\u30fc\u4f5c\u308b\u306e\u306f\u3081\u3093\u3069\u304f\u3055\u3044\u306e\u3067\u30b3\u30de\u30f3\u30c9\u3067\u898b\u3066\u3044\u304f\n\n```bash\n$ php artisan make:console TestCommand --command=\"batchtest\"\n$ php artisan batchtest\n```\n\n\u30b3\u30de\u30f3\u30c9\u306b\u540d\u524d\u4ed8\u3051\u3089\u308c\u308b\u3093\u3060\u3002\u3002\n\n### Category Model\n\nEloquentModel\u306f\u4f7f\u308f\u306a\u3044\u3002\n\n```php:app/Models/Category.php\nuse Kalnoy\\Nestedset\\Node;\n\nclass Category extends Node\n{\n    /**\n     * \u30e2\u30c7\u30eb\u306b\u95a2\u9023\u4ed8\u3051\u308b\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306e\u30c6\u30fc\u30d6\u30eb\u3092\u6307\u5b9a\n     *\n     * @var string\n     */\n    protected $table = 'categories';\n\n    /**\n     * create\u30e1\u30bd\u30c3\u30c9\u5b9f\u884c\u6642\u306b\u3001\u5165\u529b\u3092\u8a31\u53ef\u3059\u308b\u30ab\u30e9\u30e0\u306e\u6307\u5b9a\n     *\n     * @var array\n     */\n    protected $fillable = array('name');\n}\n```\n\n### \u30d0\u30c3\u30c1\n\n\u3072\u3068\u307e\u305a\u30c7\u30fc\u30bf\u304c\u4fdd\u5b58\u3055\u308c\u308b\u306e\u304b\u968e\u5c64\u69cb\u9020\u3092\u4f5c\u3063\u3066\u4fdd\u5b58\u3057\u3066\u307f\u308b\n\n```php:app/Console/Commands/TestCommand.php\n<?php\n\nnamespace App\\Console\\Commands;\n\nuse Illuminate\\Console\\Command;\nuse App\\Models\\Category;\n\nclass TestCommand extends Command\n{\n    /**\n     * The name and signature of the console command.\n     *\n     * @var string\n     */\n    protected $signature = 'batchtest';\n\n    /**\n     * The console command description.\n     *\n     * @var string\n     */\n    protected $description = 'Command description';\n\n    /**\n     * App\\Models\\Category\n     *\n     * @var string\n     */\n    protected $Category;\n\n    /**\n     * Create a new command instance.\n     *\n     * @return void\n     */\n    public function __construct()\n    {\n        parent::__construct();\n        $this->Category = new Category();\n    }\n\n    /**\n     * Execute the console command.\n     *\n     * @return mixed\n     */\n    public function handle()\n    {\n        //Foo - Bar - Baz\u306e\u968e\u5c64\u69cb\u9020\n        $node = Category::create([\n            'name' => 'Foo',\n\n            'children' => [\n                [\n                    'name' => 'Bar',\n\n                    'children' => [\n                        [ 'name' => 'Baz' ],\n                    ],\n                ],\n            ],\n        ]);\n    }\n}\n```\n\n### \u5b9f\u884c\n\n```bash\n$ php artisan batchtest\n```\n\n```\nselect * from categories;\n\n+------+------+-----------+----+------+--------------------+---------------------+\n| _lft | _rgt | parent_id | id | name | created_at          | updated_at          |\n+------+------+-----------+----+------+--------------------+---------------------+\n|    1 |    6 |      NULL |  1 | Foo  | 2016-11-07 21:19:00 | 2016-11-07 21:19:00 |\n|    2 |    5 |         1 |  2 | Bar  | 2016-11-07 21:19:00 | 2016-11-07 21:19:00 |\n|    3 |    4 |         2 |  3 | Baz  | 2016-11-07 21:19:00 | 2016-11-07 21:19:00 |\n+------+------+-----------+----+------+----------+---------------------+----------+\n```\n\n\u4fdd\u5b58\u3055\u308c\u3066\u308b\u3001\u8ce2\u3044\uff01\n\n## \u4f7f\u3044\u65b9\u3092\u898b\u3066\u3044\u304f\n\n### \u30ab\u30c6\u30b4\u30ea\u306e\u8ffd\u52a0\n\n```php\n/**\n * ex.)\n * $attributes = ['name' => 'hoge']\n */\n$this->Category->create($attributes);\n```\n\n### \u3042\u308b\u30ab\u30c6\u30b4\u30ea\u3092\u4e00\u756a\u4e0a\u306b\u5206\u985e\u3059\u308b\n\n```php\n//\u4e0a\u8a18\u306eid2\u306e\u30c7\u30fc\u30bf\u306b\u5bfe\u3057\u3066\u5b9f\u884c\n$node = $this->Category->find(2);\n$node->saveAsRoot();\n```\n\n```\n+------+------+-----------+----+------+---------------------+---------------------+\n| _lft | _rgt | parent_id | id | name |  created_at          | updated_at          |\n+------+------+-----------+----+------+----------------------+---------------------+\n|    1 |    2 |      NULL |  1 | Foo  |  2016-11-07 21:19:00 | 2016-11-07 21:19:00 |\n|    3 |    6 |      NULL |  2 | Bar  |  2016-11-07 21:19:00 | 2016-11-08 10:45:01 |\n|    4 |    5 |         2 |  3 | Baz  |  2016-11-07 21:19:00 | 2016-11-07 21:19:00 |\n+------+------+-----------+----+------+----------------------+---------------------+\n\nparent_id\u304cnull\u306b\u306a\u3063\u3066\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3067\u304d\u305f(\u89aa\u3092\u6301\u305f\u306a\u304f\u306a\u3063\u305f)\nid2\u304c\u6301\u3063\u3066\u3044\u305f\u5b50\u306e\u7d10\u3065\u3051\u3082\u7dad\u6301\u3055\u308c\u3066\u3044\u308b\n```\n\n### \u65e2\u5b58\u306e\u30ab\u30c6\u30b4\u30ea\u3092\u89aa\u30ab\u30c6\u30b4\u30ea\u306b\u7d10\u3065\u3051\u308b(Bar\u306e\u5b50\u30ab\u30c6\u30b4\u30ea\u306bFoo\u3092\u7d10\u3065\u3051\u308b)\n\n```php\n$parent = $this->Category->find(2); //Bar\n$children = $this->Category->find(1); //Foo\n\n$parent->appendNode($children);\n```\n\n```\n+------+------+-----------+----+------+---------------------+---------------------+\n| _lft | _rgt | parent_id | id | name | created_at          | updated_at          |\n+------+------+-----------+----+------+---------------------+---------------------+\n|    4 |    5 |         2 |  1 | Foo  | 2016-11-07 21:19:00 | 2016-11-08 11:13:39 |  //\u7d10\u3065\u3044\u305f\n|    1 |    6 |      NULL |  2 | Bar  | 2016-11-07 21:19:00 | 2016-11-08 10:45:01 |\n```\n\n\u6319\u52d5\u306f\u540c\u3058\u3060\u3051\u3069\u5b50\u5074\u304b\u3089\u3084\u308b\u5834\u5408\u306f\u3053\u3046\n\n\u2460\n\n```php\n$parent = $this->Category->find(2);\n$children = $this->Category->find(1);\n\n$children->appendTo($parent)->save();\n```\n\n\u2461\n\n```php\n$parent = $this->Category->find(2);\n$children = $this->Category->find(1);\n\n$children->parent_id = $parent->id;\n$children->save();\n```\n\n### \u89aa\u306b\u5b50\u3092\u8ffd\u52a0\n\n```php\n$parent = $this->Category->create(['name' => 'FUGA']);\n//\u5b50\u3092\u8ffd\u52a0\n$parent->children()->create(['name' => 'HOGE']);\n```\n\n```\n+------+------+-----------+----+------+---------------------+---------------------+\n| _lft | _rgt | parent_id | id | name | created_at          | updated_at          |\n+------+------+-----------+----+------+---------------------+---------------------+\n|    1 |    4 |      NULL |  1 | FUGA | 2016-11-08 11:27:08 | 2016-11-08 11:27:08 |\n|    2 |    3 |         1 |  2 | HOGE | 2016-11-08 11:27:08 | 2016-11-08 11:27:08 |\n+------+------+-----------+----+------+---------------------+---------------------+\n```\n\n### \u524a\u9664\n\n```php\n$node = $this->Category->find(2);\n\n$node->delete();\n```\n\n### \u968e\u5c64\u69cb\u9020\u3092\u51fa\u529b\n\n__data__\n\n```\n+------+------+-----------+----+---------------+---------------------+---------------------+\n| _lft | _rgt | parent_id | id | name          | created_at          | updated_at          |\n+------+------+-----------+----+---------------+---------------------+---------------------+\n|    1 |   16 |      NULL |  1 | HOGE          | 2016-11-08 11:44:51 | 2016-11-08 11:44:51 |\n|    2 |   13 |         1 |  2 | FUGA          | 2016-11-08 11:44:51 | 2016-11-08 11:44:51 |\n|   17 |   22 |      NULL |  3 | HOGE_2        | 2016-11-08 11:45:07 | 2016-11-08 11:45:07 |\n|   18 |   21 |         3 |  4 | FUGA_2        | 2016-11-08 11:45:07 | 2016-11-08 11:45:07 |\n|   19 |   20 |         4 |  5 | HOGEFUGA_2    | 2016-11-08 11:52:51 | 2016-11-08 11:52:51 |\n|    3 |    4 |         2 |  6 | HOGEFUGA      | 2016-11-08 12:29:33 | 2016-11-08 12:29:33 |\n|   14 |   15 |         1 | 11 | HOGE_children | 2016-11-08 12:44:28 | 2016-11-08 12:44:28 |\n+------+------+-----------+----+---------------+--------------------+---------------------+\n```\n\n```php\n$results = $this->Category->get();\n$tree = $results->toTree();\n\n$traverse = function ($categories, $prefix = '-') use (&$traverse) {\n    foreach ($categories as $category) {\n        echo PHP_EOL.$prefix.' '.$category->name;\n\n        $traverse($category->children, $prefix.'-');\n    }\n};\n\n$traverse($tree);\n```\n\n__Result__\n\n```\n- HOGE\n-- FUGA\n--- HOGEFUGA\n-- HOGE_children\n- HOGE_2\n-- FUGA_2\n--- HOGEFUGA_2\n```\n\n\u305d\u306e\u4ed6\u307e\u3060\u6a5f\u80fd\u3042\u308b\u307f\u305f\u3044\u3067\u3059\u304c\u6700\u4f4e\u9650\u3053\u308c\u304f\u3089\u3044\u77e5\u3063\u3068\u3051\u3070\u4f7f\u3048\u308b\u306e\u304b\u306a\n\u4fbf\u5229\u306a\u306e\u304c\u3042\u3063\u305f\u3089\u8ffd\u8a18\u3057\u3066\u3044\u304d\u307e\u3059\n\n## \u8ffd\u8a18\n\n### data\n\n```\n+----+--------------------------+-----------+------+------+\n| id | name                     | parent_id | _lft | _rgt |\n+----+--------------------------+-----------+------+------+\n|  1 | testA                    |      NULL |    1 |   10 |\n|  2 | testA_childA             |         1 |    2 |    9 |\n|  3 | testA_childA_grandChildA |         2 |    3 |    4 |\n|  5 | testA_childA_grandChildB |         2 |    5 |    6 |\n|  6 | testA_childA_grandChildC |         2 |    7 |    8 |\n+----+--------------------------+-----------+------+------+\n```\n\n### \u5b50\u306e\u53d6\u5f97\n\n```php\n$parent = $category->find(1);\n$parent->ancestors()->get();//\u5168\u3066\u306e\u5b50\u5b6b\u304c\u53d6\u5f97\u3055\u308c\u308b\u3002\u4e0a\u8a18\u306e\u4f8b\u3067\u3044\u3046\u3068id3,5,6\u306e\u5b6b\u3082\u542b\u307e\u308c\u308b\n```\n\n### \u89aa\u306e\u53d6\u5f97\n\n```php\n$grandchild = $category->find(3);\n$grandchild->descendants()->get();//\u5168\u3066\u306e\u89aa\u304c\u53d6\u5f97\u3055\u308c\u308b\u3002\n```\n\n### \u540c\u3058\u968e\u5c64\u306b\u3044\u308b\u30c7\u30fc\u30bf\u3092\u6301\u3063\u3066\u304f\u308b\n\n```php\n$grandchild = $category->find(3);\n$grandchild->siblings()->get(); //id 5,6\u306e\u30c7\u30fc\u30bf\u3092\u6301\u3063\u3066\u304f\u308b\n```\n\n### \u6df1\u3055\u306e\u30d7\u30ed\u30d1\u30c6\u30a3\u3092\u6301\u3064\u3088\u3046\u306b\u30c7\u30fc\u30bf\u3092\u53d6\u5f97\n\n```php\n$grandchild = $category->withDepth()->find(3);\ndd($grandchild->depth);  //2\n\n$parent = $category->withDepth()->find(1);\ndd($parent->depth);  //0\n```\n\n### \u7279\u5b9a\u306e\u6df1\u3055\u306b\u3044\u308b\u30c7\u30fc\u30bf\u3092\u53d6\u5f97\n\n```php\n$grandchildren = $category->withDepth()->having('depth', '=', 2)->get();\n\ndd($grandchildren); //id 3, 5, 6\n```\n\n### \u5fc5\u305a\u4fdd\u5b58\u3055\u308c\u3066\u3044\u308b\u5024\u306e_lft\u3067\u30bd\u30fc\u30c8\n\n```php\n$category->defaultOrder()->get();\n\n//inverse\n$category->reversed()->get();\n```\n\n### delete\u306frecursive\u306b\u884c\u308f\u308c\u308b\n\n```php\n$category->delete()\n```\n\n\n\u5b50\u3092\u6301\u3063\u3066\u3044\u308b\u5834\u5408\u306f\u524a\u9664\u3055\u308c\u308b\n\n### \u73fe\u5728\u306e\u30ab\u30c6\u30b4\u30ea\u304c\u89aa\u30ab\u30c6\u30b4\u30ea\u304b\n\n```php\n$node->isRoot()\n```\n\n### \u89aa\u5b50\u95a2\u4fc2\u8981\u7d20\u3078\u306e\u30a2\u30af\u30bb\u30b9\n\n```php\n$node->children\n$node->parent\n```\n", "tags": ["laravel5.1", "laravel", "PHP"]}