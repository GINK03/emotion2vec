{"tags": ["fluentd", "AWS", "Elasticsearch", "kibana"], "context": " More than 1 year has passed since last update.ELB\u30ed\u30b0\u3092\u89e3\u6790\u3059\u308b\u6a5f\u4f1a\u304c\u591a\u304f\u306a\u308a\u307e\u3057\u305f\u3002\u3002\u3002\n$sed -e 's/:[0-9][0-9]\\.[0-9][0-9][0-9][0-9][0-9][0-9]Z//g' access.log |awk -F \" \" '{ print $1,$8; }'| sort | uniq -c\n\n\u306e\u3088\u3046\u306a\u30b3\u30de\u30f3\u30c9\u3092\u4f5c\u3063\u3066\u89e3\u6790\u3057\u3066\u3082\u826f\u3044\u306e\u3067\u3059\u304c\u3001\u8272\u3005\u9762\u5012\u306a\u306e\u3067\u3001\u3088\u304f\u3042\u308b\u30c4\u30fc\u30eb\u7fa4\u3092\u4f7f\u3063\u3066\u53ef\u8996\u5316\u3057\u307e\u3059\u3002\n\n\u69cb\u6210\n\nAmazon Linux AMI 2015.03 (HVM)(S3\u3078\u306eRead\u6a29\u9650\u3092\u6301\u3063\u305fIAMRole\u304c\u8a2d\u5b9a\u3055\u308c\u3066\u3044\u308b\u3053\u3068)\ntd-agent-2.2.0-0.x86_64\nElasticSearch-1.4.5\nnginx-1.6.2-1.23.amzn1.x86_64\nKibana3.1.2\n\n\u306a\u304a\u3001ELB\u306e\u30a2\u30af\u30bb\u30b9\u30ed\u30b0\u306f\u4e8b\u524d\u306b\u6709\u52b9\u306b\u3057\u3066\u304a\u304f\u3053\u3068\u3002\n\n\u53c2\u8003\n\nELB\u306e\u30a2\u30af\u30bb\u30b9\u30ed\u30b0\u3092fluent-plugin-elb-log\u3092\u4f7f\u3063\u3066kibana\u3067\u8868\u793a\u3059\u308b\nELB s3 Log + Fluentd + Elasticsearch + Kibana + Ubuntu 14.04 LTS PV + EC2 on AWS\n[\u6280\u8853\u30d6\u30ed\u30b0Vol.11] ELB\u306e\u30a2\u30af\u30bb\u30b9\u30ed\u30b0\u3092fluentd+Elasticsearch+kibana\u3067\u89e3\u6790\nfluent-plugin-elb-access-log\u3092\u4f5c\u3063\u305f\nfluentd-v2+elasticsearch+kibana3\u3092EC2\u4e0a\u3067\u5b9f\u65bd\u3059\u308b\n\n\nnginx\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3001\u30b5\u30fc\u30d3\u30b9\u8d77\u52d5\u3001\u81ea\u52d5\u8d77\u52d5\u8a2d\u5b9a\u3092\u3057\u307e\u3059\n$sudo yum install nginx\n$sudo service nginx start\n$sudo chkconfig --add nginx\n\n\nfluentd\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3001\u30b5\u30fc\u30d3\u30b9\u81ea\u52d5\u8d77\u52d5\u8a2d\u5b9a\n$curl -L http://toolbelt.treasuredata.com/sh/install-redhat-td-agent2.sh | sudo sh\n$sudo chkconfig --add td-agent\n\nELB\u306e\u30a2\u30af\u30bb\u30b9\u30ed\u30b0\u3092\u53d6\u5f97\u3059\u308b\u305f\u3081\u306bfluent-plugin-elb-access-log\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3001elastcisearch\u3078\u767b\u9332\u3059\u308b\u305f\u3081\u306bfluent-plugin-elasticsearch\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u307e\u3059\u3002\u307e\u305f\u3001\u4e8b\u524d\u306b\u5fc5\u8981\u306a\u30d1\u30c3\u30b1\u30fc\u30b8\u7fa4\u3082\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n$sudo yum groupinstall 'Development tools'\n$sudo yum install curl-devel\n$sudo /opt/td-agent/embedded/bin/fluent-gem install fluent-plugin-elasticsearch\n$sudo /opt/td-agent/embedded/bin/fluent-gem install fluent-plugin-elb-access-log\n\n\nElasticSearch\nGPG-KEY\u306e\u8ffd\u52a0\n$sudo rpm --import https://packages.elasticsearch.org/GPG-KEY-elasticsearch\n\n\u30ea\u30dd\u30b8\u30c8\u30ea\u306e\u8ffd\u52a0\u306e\u305f\u3081\u306b\u4e0b\u8a18\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3002\n\n/etc/yum.repos.d/elasticsearch.repo\n[elasticsearch-1.4]\nname=Elasticsearch repository for 1.4.x packages\nbaseurl=http://packages.elasticsearch.org/elasticsearch/1.4/centos\ngpgcheck=1\ngpgkey=http://packages.elasticsearch.org/GPG-KEY-elasticsearch\nenabled=0\n\n\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3001\u30b5\u30fc\u30d3\u30b9\u8d77\u52d5\u3001\u81ea\u52d5\u8d77\u52d5\u8a2d\u5b9a\n$sudo yum --enablerepo=elasticsearch-1.4 install elasticsearch\n$sudo chkconfig --add elasticsearch\n$sudo service elasticsearch start\n\n\u8d77\u52d5\u3057\u305f\u30af\u30e9\u30b9\u30bf\u3092\u78ba\u8a8d\n$curl -s -XGET http://localhost:9200/_cluster/health | jq .\n{\n  \"cluster_name\": \"elasticsearch\",\n  \"status\": \"green\",\n  \"timed_out\": false,\n  \"number_of_nodes\": 1,\n  \"number_of_data_nodes\": 1,\n  \"active_primary_shards\": 0,\n  \"active_shards\": 0,\n  \"relocating_shards\": 0,\n  \"initializing_shards\": 0,\n  \"unassigned_shards\": 0\n}\n\n\nELB\u306e\u30ed\u30b0\u3092fluentd\u3067\u53d6\u5f97\nfluent-plugin-elb-access-log\u3092\u4f7f\u3063\u3066\u3001ELB\u306e\u30ed\u30b0\u3092\u53d6\u5f97\u3057\u307e\u3059\u3002\n\n/etc/td-agent/td-agent.conf\n<source>\n  type elb_access_log\n  account_id 111111\n  region ap-northeast-1\n  s3_bucket toshihirock-elb-test\n  tag elb.access_log\n  debug true\n</source>\n\n<match **>\n  type stdout\n</match>\n\n\n\u5404\u8a2d\u5b9a\u306e\u8a73\u7d30\u53ca\u3073\u30aa\u30d7\u30b7\u30e7\u30f3\u306ffluent-plugin-elb-access-log\u306eREADME\u53c2\u7167\u306e\u3053\u3068\u3002\n\u78ba\u8a8d\u306e\u305f\u3081\u30c8\u30ec\u30fc\u30b9\u30e2\u30fc\u30c9\u3067\u8d77\u52d5\u3057\u307e\u3059\u3002\n$sudo td-agent -vv &\n\n\u3053\u306e\u72b6\u614b\u3067ELB\u306eURL\u306b\u30a2\u30af\u30bb\u30b9\u3057\u3001\u5c11\u3057\u5f85\u3061\u307e\u3059\u3002\n\u3046\u307e\u304f\u3044\u3063\u3066\u3044\u308b\u3068\u6a19\u6e96\u51fa\u529b\u306b\u30ed\u30b0\u304c\u8868\u793a\u3055\u308c\u308b\u306e\u304c\u78ba\u8a8d\u3067\u304d\u308b\u306e\u3067\u3059\u304c\u3001\u4ee5\u4e0b\u306e\u8a3c\u660e\u66f8\u30a8\u30e9\u30fc\u3068\u306a\u3063\u3066\u3057\u307e\u3044\u307e\u3057\u305f\u3002\u3002\u3002\nbefore_shutdown failed error=\"SSL_connect returned=1 errno=0 state=SSLv3 read server certificate B: certificate verify failed\"\n\n\u3053\u3061\u3089\u306e\u554f\u984c\u306e\u8abf\u67fb\u3001\u89e3\u6c7a\u65b9\u6cd5\u306f\u4ee5\u4e0b\u306b\u307e\u3068\u3081\u307e\u3057\u305f\u3002\nfluentd\u306e\u30d7\u30e9\u30b0\u30a4\u30f3\u3067certificate verify failed\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3057\u305f\u8a71\n\u8a73\u7d30\u306f\u4e0a\u8a18\u3092\u898b\u3066\u3044\u305f\u3060\u304f\u3068\u3044\u3046\u3053\u3068\u3067\u3053\u3061\u3089\u306f\u6700\u7d42\u7684\u306a\u5bfe\u5fdc\u65b9\u6cd5\u3067\u3042\u308b\u8a3c\u660e\u66f8\u306e\u5dee\u3057\u66ff\u3048\u306e\u307f\u884c\u3044\u307e\u3059\u3002\n# AmazonLinux\u306e\u8a3c\u660e\u66f8\u306e\u4f4d\u7f6e\u3092\u78ba\u8a8d\n$ruby -ropenssl -e 'puts OpenSSL::X509::DEFAULT_CERT_FILE'\n/etc/pki/tls/cert.pem\n# \u30d0\u30c3\u30af\u30a2\u30c3\u30d7\n$cp /opt/td-agent/embedded/ssl/cert.pem /opt/td-agent/embedded/ssl/cert.pem.original\n# \u5dee\u3057\u66ff\u3048\n$cp /etc/pki/tls/cert.pem /opt/td-agent/embedded/ssl/cert.pem\n\n\u4e00\u5ea6\u3001td-agent\u306e\u30d7\u30ed\u30bb\u30b9\u3092kill\u3057\u3066\u518d\u5ea6\u5b9f\u884c\u3057\u307e\u3059\u3002\n$ps aux|grep ruby|awk '{print $2;}'|sudo xargs kill -KILL\n$sudo td-agent -vv &\n\n\u518d\u5ea6ELB\u306e\u30b5\u30a4\u30c8\u306b\u30a2\u30af\u30bb\u30b9\u3057\u30015\u5206\u307b\u3069\u5f85\u3061\u307e\u3059\u3002\n\u554f\u984c\u306a\u304f\u89e3\u6790\u3067\u304d\u3066\u3044\u308c\u3070\u3001\u30ed\u30b0\u304c\u51fa\u529b\u3055\u308c\u307e\u3059\u3002\n2015-05-30 09:58:23 +0000 elb.access_log: {\"timestamp\":\"2015-05-30T09:58:23.682447Z\",\"elb\":\"LoadBlancer\",\"client_port\":3781,\"backend_port\":80,\"request_processing_time\":4.2e-05,\"backend_processing_time\":0.000791,\"response_processing_time\":2.7e-05,\"elb_status_code\":404,\"backend_status_code\":404,\"received_bytes\":0,\"sent_bytes\":3696,\"request\":\"GET http://fuga:80/manager/html HTTP/1.1\",\"client\":\"boyo\",\"backend\":\"hoge\",\"request.method\":\"GET\",\"request.uri\":\"http://hogefuga:80/manager/html\",\"request.http_version\":\"HTTP/1.1\",\"request.uri.scheme\":\"http\",\"request.uri.user\":null,\"request.uri.host\":\"abcd\",\"request.uri.port\":80,\"request.uri.path\":\"/manager/html\",\"request.uri.query\":null,\"request.uri.fragment\":null}\n\n\u78ba\u8a8d\u304c\u7d42\u308f\u3063\u305f\u306e\u3067\u30d7\u30ed\u30bb\u30b9\u306f\u7d42\u4e86\u3057\u307e\u3059\u3002\n$ps aux|grep ruby|awk '{print $2;}'|sudo xargs kill -KILL\n\n\nELB\u306e\u30ed\u30b0\u3092ElasticSearch\u306b\u4fdd\u5b58\u3059\u308b\nfluentd\u306e\u8a2d\u5b9a\u306belasticsearch\u306b\u95a2\u3059\u308b\u5185\u5bb9\u3092\u8ffd\u8a18\u3057\u3066\u3001ELB\u306e\u30ed\u30b0\u3092\u4fdd\u5b58\u3059\u308b\u3088\u3046\u306b\u3057\u307e\u3059\u3002\n\n/etc/td-agent/td-agent.conf\n<source>\n  type elb_access_log\n  account_id 11111111\n  region ap-northeast-1\n  s3_bucket toshihirock-elb-test\n  tag elb.access_log\n  debug true\n</source>\n\n<match elb.access_log>\n  type elasticsearch\n  type_name access_log\n  host localhost\n  port 9200\n  logstash_format true\n  include_tag_key true\n  tag_key @log_name\n</match>\n\n\n\u30b5\u30fc\u30d3\u30b9\u8d77\u52d5\u3002\n$sudo service td-agent start\n\nELB\u30b5\u30a4\u30c8\u306b\u30a2\u30af\u30bb\u30b9\u3057\u3001\u30ed\u30b0\u3092\u78ba\u8a8d\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n$tail -f  /var/log/td-agent.log\n\n\uff15\u5206\u3050\u3089\u3044\u7d4c\u904e\u3059\u308b\u3068\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u30ed\u30b0\u304c\u6d41\u308c\u307e\u3059\u3002\n2015-05-29 14:51:19 +0000 [info]: Connection opened to Elasticsearch cluster => {:host=>\"localhost\", :port=>9200, :scheme=>\"http\"}\n\nElastciSearch\u306b\u672c\u5f53\u306b\u767b\u9332\u3055\u308c\u3066\u3044\u308b\u304b\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\u307e\u305a\u3001\u73fe\u5728\u5b58\u5728\u3059\u308b\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u60c5\u5831\u4e00\u89a7\u3092\u53d6\u5f97\u3057\u307e\u3059\u3002\n$curl -XGET http://localhost:9200/_aliases?pretty\n\n\u7d50\u679c\u3002\n{\n  \"logstash-2015.05.29\" : {\n    \"aliases\" : { }\n  },\n  \"logstash-2015.05.30\" : {\n    \"aliases\" : { }\n  }\n}\n\n5\u670830\u65e5\u306e\u65b9\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\u3082\u3057jq\u3092\u4e8b\u524d\u306b\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3066\u3044\u306a\u3044\u5834\u5408\u3001sudo yum install jq\u3092\u5b9f\u65bd\u3059\u308b\u304b\u3001\u30d1\u30a4\u30d7\u4ee5\u964d\u306e\u30b3\u30de\u30f3\u30c9\u3092\u524a\u9664\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n$curl -XGET http://localhost:9200/logstash-2015.05.30/_search -d '\n{\n  \"query\": {\n    \"match_all\" : {}\n  }\n}' | jq .\n\n\u7d50\u679c\n\n  \"took\": 2,\n  \"timed_out\": false,\n  \"_shards\": {\n    \"total\": 5,\n    \"successful\": 5,\n    \"failed\": 0\n  },\n  \"hits\": {\n    \"total\": 18,\n    \"max_score\": 1,\n    \"hits\": [\n      {\n        \"_index\": \"logstash-2015.05.30\",\n        \"_type\": \"access_log\",\n        \"_id\": \"hogefuga\",\n        \"_score\": 1,\n        \"_source\": {\n          \"timestamp\": \"2015-05-30T10:34:08.552001Z\",\n          \"elb\": \"LoadBlancer\",\n          \"client_port\": 54931,\n          \"backend_port\": 80,\n          \"request_processing_time\": 5.1e-05,\n          \"backend_processing_time\": 0.00074,\n          \"response_processing_time\": 2.1e-05,\n          \"elb_status_code\": 304,\n          \"backend_status_code\": 304,\n          \"received_bytes\": 0,\n          \"sent_bytes\": 0,\n          \"request\": \"GET http://loadblancer-11111.ap-northeast-1.elb.amazonaws.com:80/ HTTP/1.1\",\n          \uff08\u4ee5\u4e0b\u7565)\n\n\u7121\u4e8b\u767b\u9332\u3055\u308c\u3066\u3044\u307e\u3057\u305f\u3002\n\nkibana\nkibana\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u53ca\u3073\u914d\u7f6e\u3002\n$wget https://download.elastic.co/kibana/kibana/kibana-3.1.2.tar.gz\n$tar -zxvf kibana-3.1.2.tar.gz\n$mv kibana-3.1.2 kibana\n$sudo mv kibana /usr/share/nginx/html\n\nelasticsearch1.4\u304b\u3089\u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u5411\u4e0a\u304c\u76ee\u7684\u3067\u8a2d\u5b9a\u304c\u8ffd\u52a0\u3067\u5fc5\u8981\u306b\u306a\u3063\u305f\u3088\u3046\u3067\u3001\u305d\u308c\u3092\u8ffd\u52a0\u3057\u307e\u3059\u3002\n$sudo vi /etc/elasticsearch/elasticsearch.yml \n\n\u4ee5\u4e0b\u3092\u672b\u5c3e\u306b\u8ffd\u52a0\n\n/etc/elasticsearch/elasticsearch.yml\nhttp.cors.allow-origin: \"/.*/\"\nhttp.cors.enabled: true\n\n\n\u307e\u305f\u3001SecurityGroup\u306780\u756a\u30689200\u756a\u306e\u30dd\u30fc\u30c8\u304c\u7a7a\u3044\u3066\u3044\u308b\u304b\u78ba\u8a8d\u3057\u307e\u3059\u30029200\u756a\u306fKibana \u304c\u691c\u7d22\u30af\u30a8\u30ea\u3092\u6295\u3052\u308b\u30dd\u30fc\u30c8\u306e\u3088\u3046\u3067\u3059\u3002\nelasticsearch,nginx\u306e\u518d\u8d77\u52d5\n$sudo service elasticsearch restart\n$sudo service nginx restart\n\n\u3053\u306e\u72b6\u614b\u3067 http://[hostname]/kibana/ \u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3053\u3068\u3067\u753b\u9762\u304c\u8868\u793a\u3055\u308c\u307e\u3057\u305f\u3002\nELB\u30ed\u30b0\u3092\u89e3\u6790\u3059\u308b\u6a5f\u4f1a\u304c\u591a\u304f\u306a\u308a\u307e\u3057\u305f\u3002\u3002\u3002\n\n```\n$sed -e 's/:[0-9][0-9]\\.[0-9][0-9][0-9][0-9][0-9][0-9]Z//g' access.log |awk -F \" \" '{ print $1,$8; }'| sort | uniq -c\n```\n\n\u306e\u3088\u3046\u306a\u30b3\u30de\u30f3\u30c9\u3092\u4f5c\u3063\u3066\u89e3\u6790\u3057\u3066\u3082\u826f\u3044\u306e\u3067\u3059\u304c\u3001\u8272\u3005\u9762\u5012\u306a\u306e\u3067\u3001\u3088\u304f\u3042\u308b\u30c4\u30fc\u30eb\u7fa4\u3092\u4f7f\u3063\u3066\u53ef\u8996\u5316\u3057\u307e\u3059\u3002\n\n\n# \u69cb\u6210\n\n+ Amazon Linux AMI 2015.03 (HVM)(S3\u3078\u306eRead\u6a29\u9650\u3092\u6301\u3063\u305fIAMRole\u304c\u8a2d\u5b9a\u3055\u308c\u3066\u3044\u308b\u3053\u3068)\n+ td-agent-2.2.0-0.x86_64\n+ ElasticSearch-1.4.5\n+ nginx-1.6.2-1.23.amzn1.x86_64\n+ Kibana3.1.2\n\n\u306a\u304a\u3001ELB\u306e\u30a2\u30af\u30bb\u30b9\u30ed\u30b0\u306f\u4e8b\u524d\u306b\u6709\u52b9\u306b\u3057\u3066\u304a\u304f\u3053\u3068\u3002\n\n# \u53c2\u8003\n\n+ [ELB\u306e\u30a2\u30af\u30bb\u30b9\u30ed\u30b0\u3092fluent-plugin-elb-log\u3092\u4f7f\u3063\u3066kibana\u3067\u8868\u793a\u3059\u308b](http://dev.classmethod.jp/cloud/aws/fluent-plugin-elb-log-to-kibana/)\n+ [ELB s3 Log + Fluentd + Elasticsearch + Kibana + Ubuntu 14.04 LTS PV + EC2 on AWS](http://qiita.com/kiyotaman/items/6021c0794185065dd0ca)\n+ [[\u6280\u8853\u30d6\u30ed\u30b0Vol.11] ELB\u306e\u30a2\u30af\u30bb\u30b9\u30ed\u30b0\u3092fluentd+Elasticsearch+kibana\u3067\u89e3\u6790](http://www.denet.ad.jp/technology/2014/04/vol11-elbfluentdelasticsearchkibana.html)\n+ [fluent-plugin-elb-access-log\u3092\u4f5c\u3063\u305f](http://so-wh.at/entry/2015/05/24/fluent-plugin-elb-access-log%E3%82%92%E4%BD%9C%E3%81%A3%E3%81%9F)\n+ [fluentd-v2+elasticsearch+kibana3\u3092EC2\u4e0a\u3067\u5b9f\u65bd\u3059\u308b](http://toshihirock.blogspot.jp/2015/04/fluentd-v2elasticsearchkibana3ec2.html)\n\n# nginx\n\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3001\u30b5\u30fc\u30d3\u30b9\u8d77\u52d5\u3001\u81ea\u52d5\u8d77\u52d5\u8a2d\u5b9a\u3092\u3057\u307e\u3059\n\n```\n$sudo yum install nginx\n$sudo service nginx start\n$sudo chkconfig --add nginx\n```\n\n# fluentd\n\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3001\u30b5\u30fc\u30d3\u30b9\u81ea\u52d5\u8d77\u52d5\u8a2d\u5b9a\n\n```\n$curl -L http://toolbelt.treasuredata.com/sh/install-redhat-td-agent2.sh | sudo sh\n$sudo chkconfig --add td-agent\n```\n\nELB\u306e\u30a2\u30af\u30bb\u30b9\u30ed\u30b0\u3092\u53d6\u5f97\u3059\u308b\u305f\u3081\u306b[fluent-plugin-elb-access-log](https://github.com/winebarrel/fluent-plugin-elb-access-log)\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3001elastcisearch\u3078\u767b\u9332\u3059\u308b\u305f\u3081\u306b[fluent-plugin-elasticsearch](https://github.com/uken/fluent-plugin-elasticsearch)\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u307e\u3059\u3002\u307e\u305f\u3001\u4e8b\u524d\u306b\u5fc5\u8981\u306a\u30d1\u30c3\u30b1\u30fc\u30b8\u7fa4\u3082\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\n\n```\n$sudo yum groupinstall 'Development tools'\n$sudo yum install curl-devel\n$sudo /opt/td-agent/embedded/bin/fluent-gem install fluent-plugin-elasticsearch\n$sudo /opt/td-agent/embedded/bin/fluent-gem install fluent-plugin-elb-access-log\n```\n\n# ElasticSearch\n\nGPG-KEY\u306e\u8ffd\u52a0\n\n```\n$sudo rpm --import https://packages.elasticsearch.org/GPG-KEY-elasticsearch\n```\n\n\u30ea\u30dd\u30b8\u30c8\u30ea\u306e\u8ffd\u52a0\u306e\u305f\u3081\u306b\u4e0b\u8a18\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3002\n\n```lang:/etc/yum.repos.d/elasticsearch.repo\n[elasticsearch-1.4]\nname=Elasticsearch repository for 1.4.x packages\nbaseurl=http://packages.elasticsearch.org/elasticsearch/1.4/centos\ngpgcheck=1\ngpgkey=http://packages.elasticsearch.org/GPG-KEY-elasticsearch\nenabled=0\n```\n\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3001\u30b5\u30fc\u30d3\u30b9\u8d77\u52d5\u3001\u81ea\u52d5\u8d77\u52d5\u8a2d\u5b9a\n\n```\n$sudo yum --enablerepo=elasticsearch-1.4 install elasticsearch\n$sudo chkconfig --add elasticsearch\n$sudo service elasticsearch start\n```\n\n\u8d77\u52d5\u3057\u305f\u30af\u30e9\u30b9\u30bf\u3092\u78ba\u8a8d\n\n```\n$curl -s -XGET http://localhost:9200/_cluster/health | jq .\n{\n  \"cluster_name\": \"elasticsearch\",\n  \"status\": \"green\",\n  \"timed_out\": false,\n  \"number_of_nodes\": 1,\n  \"number_of_data_nodes\": 1,\n  \"active_primary_shards\": 0,\n  \"active_shards\": 0,\n  \"relocating_shards\": 0,\n  \"initializing_shards\": 0,\n  \"unassigned_shards\": 0\n}\n```\n\n# ELB\u306e\u30ed\u30b0\u3092fluentd\u3067\u53d6\u5f97\n\n**fluent-plugin-elb-access-log**\u3092\u4f7f\u3063\u3066\u3001ELB\u306e\u30ed\u30b0\u3092\u53d6\u5f97\u3057\u307e\u3059\u3002\n\n```lang:/etc/td-agent/td-agent.conf\n<source>\n  type elb_access_log\n  account_id 111111\n  region ap-northeast-1\n  s3_bucket toshihirock-elb-test\n  tag elb.access_log\n  debug true\n</source>\n\n<match **>\n  type stdout\n</match>\n```\n\n\u5404\u8a2d\u5b9a\u306e\u8a73\u7d30\u53ca\u3073\u30aa\u30d7\u30b7\u30e7\u30f3\u306f[fluent-plugin-elb-access-log](https://github.com/winebarrel/fluent-plugin-elb-access-log)\u306eREADME\u53c2\u7167\u306e\u3053\u3068\u3002\n\n\u78ba\u8a8d\u306e\u305f\u3081\u30c8\u30ec\u30fc\u30b9\u30e2\u30fc\u30c9\u3067\u8d77\u52d5\u3057\u307e\u3059\u3002\n\n\n```\n$sudo td-agent -vv &\n```\n\n\u3053\u306e\u72b6\u614b\u3067ELB\u306eURL\u306b\u30a2\u30af\u30bb\u30b9\u3057\u3001\u5c11\u3057\u5f85\u3061\u307e\u3059\u3002\n\u3046\u307e\u304f\u3044\u3063\u3066\u3044\u308b\u3068\u6a19\u6e96\u51fa\u529b\u306b\u30ed\u30b0\u304c\u8868\u793a\u3055\u308c\u308b\u306e\u304c\u78ba\u8a8d\u3067\u304d\u308b\u306e\u3067\u3059\u304c\u3001\u4ee5\u4e0b\u306e\u8a3c\u660e\u66f8\u30a8\u30e9\u30fc\u3068\u306a\u3063\u3066\u3057\u307e\u3044\u307e\u3057\u305f\u3002\u3002\u3002\n\n```\nbefore_shutdown failed error=\"SSL_connect returned=1 errno=0 state=SSLv3 read server certificate B: certificate verify failed\"\n```\n\n\u3053\u3061\u3089\u306e\u554f\u984c\u306e\u8abf\u67fb\u3001\u89e3\u6c7a\u65b9\u6cd5\u306f\u4ee5\u4e0b\u306b\u307e\u3068\u3081\u307e\u3057\u305f\u3002\n\n[fluentd\u306e\u30d7\u30e9\u30b0\u30a4\u30f3\u3067certificate verify failed\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3057\u305f\u8a71](http://qiita.com/toshihirock/items/ce85c5b66b0236839ec0)\n\n\u8a73\u7d30\u306f\u4e0a\u8a18\u3092\u898b\u3066\u3044\u305f\u3060\u304f\u3068\u3044\u3046\u3053\u3068\u3067\u3053\u3061\u3089\u306f\u6700\u7d42\u7684\u306a\u5bfe\u5fdc\u65b9\u6cd5\u3067\u3042\u308b\u8a3c\u660e\u66f8\u306e\u5dee\u3057\u66ff\u3048\u306e\u307f\u884c\u3044\u307e\u3059\u3002\n\n```\n# AmazonLinux\u306e\u8a3c\u660e\u66f8\u306e\u4f4d\u7f6e\u3092\u78ba\u8a8d\n$ruby -ropenssl -e 'puts OpenSSL::X509::DEFAULT_CERT_FILE'\n/etc/pki/tls/cert.pem\n# \u30d0\u30c3\u30af\u30a2\u30c3\u30d7\n$cp /opt/td-agent/embedded/ssl/cert.pem /opt/td-agent/embedded/ssl/cert.pem.original\n# \u5dee\u3057\u66ff\u3048\n$cp /etc/pki/tls/cert.pem /opt/td-agent/embedded/ssl/cert.pem\n```\n\n\u4e00\u5ea6\u3001td-agent\u306e\u30d7\u30ed\u30bb\u30b9\u3092kill\u3057\u3066\u518d\u5ea6\u5b9f\u884c\u3057\u307e\u3059\u3002\n\n```\n$ps aux|grep ruby|awk '{print $2;}'|sudo xargs kill -KILL\n$sudo td-agent -vv &\n```\n\n\u518d\u5ea6ELB\u306e\u30b5\u30a4\u30c8\u306b\u30a2\u30af\u30bb\u30b9\u3057\u30015\u5206\u307b\u3069\u5f85\u3061\u307e\u3059\u3002\n\u554f\u984c\u306a\u304f\u89e3\u6790\u3067\u304d\u3066\u3044\u308c\u3070\u3001\u30ed\u30b0\u304c\u51fa\u529b\u3055\u308c\u307e\u3059\u3002\n\n```\n2015-05-30 09:58:23 +0000 elb.access_log: {\"timestamp\":\"2015-05-30T09:58:23.682447Z\",\"elb\":\"LoadBlancer\",\"client_port\":3781,\"backend_port\":80,\"request_processing_time\":4.2e-05,\"backend_processing_time\":0.000791,\"response_processing_time\":2.7e-05,\"elb_status_code\":404,\"backend_status_code\":404,\"received_bytes\":0,\"sent_bytes\":3696,\"request\":\"GET http://fuga:80/manager/html HTTP/1.1\",\"client\":\"boyo\",\"backend\":\"hoge\",\"request.method\":\"GET\",\"request.uri\":\"http://hogefuga:80/manager/html\",\"request.http_version\":\"HTTP/1.1\",\"request.uri.scheme\":\"http\",\"request.uri.user\":null,\"request.uri.host\":\"abcd\",\"request.uri.port\":80,\"request.uri.path\":\"/manager/html\",\"request.uri.query\":null,\"request.uri.fragment\":null}\n```\n\n\u78ba\u8a8d\u304c\u7d42\u308f\u3063\u305f\u306e\u3067\u30d7\u30ed\u30bb\u30b9\u306f\u7d42\u4e86\u3057\u307e\u3059\u3002\n\n```\n$ps aux|grep ruby|awk '{print $2;}'|sudo xargs kill -KILL\n```\n# ELB\u306e\u30ed\u30b0\u3092ElasticSearch\u306b\u4fdd\u5b58\u3059\u308b\n\nfluentd\u306e\u8a2d\u5b9a\u306belasticsearch\u306b\u95a2\u3059\u308b\u5185\u5bb9\u3092\u8ffd\u8a18\u3057\u3066\u3001ELB\u306e\u30ed\u30b0\u3092\u4fdd\u5b58\u3059\u308b\u3088\u3046\u306b\u3057\u307e\u3059\u3002\n\n```lang:/etc/td-agent/td-agent.conf\n<source>\n  type elb_access_log\n  account_id 11111111\n  region ap-northeast-1\n  s3_bucket toshihirock-elb-test\n  tag elb.access_log\n  debug true\n</source>\n\n<match elb.access_log>\n  type elasticsearch\n  type_name access_log\n  host localhost\n  port 9200\n  logstash_format true\n  include_tag_key true\n  tag_key @log_name\n</match>\n```\n\n\u30b5\u30fc\u30d3\u30b9\u8d77\u52d5\u3002\n\n```\n$sudo service td-agent start\n```\n\nELB\u30b5\u30a4\u30c8\u306b\u30a2\u30af\u30bb\u30b9\u3057\u3001\u30ed\u30b0\u3092\u78ba\u8a8d\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\n```\n$tail -f  /var/log/td-agent.log\n```\n\n\uff15\u5206\u3050\u3089\u3044\u7d4c\u904e\u3059\u308b\u3068\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u30ed\u30b0\u304c\u6d41\u308c\u307e\u3059\u3002\n\n```\n2015-05-29 14:51:19 +0000 [info]: Connection opened to Elasticsearch cluster => {:host=>\"localhost\", :port=>9200, :scheme=>\"http\"}\n```\n\nElastciSearch\u306b\u672c\u5f53\u306b\u767b\u9332\u3055\u308c\u3066\u3044\u308b\u304b\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\u307e\u305a\u3001\u73fe\u5728\u5b58\u5728\u3059\u308b\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u60c5\u5831\u4e00\u89a7\u3092\u53d6\u5f97\u3057\u307e\u3059\u3002\n\n```\n$curl -XGET http://localhost:9200/_aliases?pretty\n```\n\n\u7d50\u679c\u3002\n\n```\n{\n  \"logstash-2015.05.29\" : {\n    \"aliases\" : { }\n  },\n  \"logstash-2015.05.30\" : {\n    \"aliases\" : { }\n  }\n}\n```\n\n5\u670830\u65e5\u306e\u65b9\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\u3082\u3057jq\u3092\u4e8b\u524d\u306b\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3066\u3044\u306a\u3044\u5834\u5408\u3001`sudo yum install jq`\u3092\u5b9f\u65bd\u3059\u308b\u304b\u3001\u30d1\u30a4\u30d7\u4ee5\u964d\u306e\u30b3\u30de\u30f3\u30c9\u3092\u524a\u9664\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n```\n$curl -XGET http://localhost:9200/logstash-2015.05.30/_search -d '\n{\n  \"query\": {\n    \"match_all\" : {}\n  }\n}' | jq .\n```\n\n\u7d50\u679c\n\n```\n\n  \"took\": 2,\n  \"timed_out\": false,\n  \"_shards\": {\n    \"total\": 5,\n    \"successful\": 5,\n    \"failed\": 0\n  },\n  \"hits\": {\n    \"total\": 18,\n    \"max_score\": 1,\n    \"hits\": [\n      {\n        \"_index\": \"logstash-2015.05.30\",\n        \"_type\": \"access_log\",\n        \"_id\": \"hogefuga\",\n        \"_score\": 1,\n        \"_source\": {\n          \"timestamp\": \"2015-05-30T10:34:08.552001Z\",\n          \"elb\": \"LoadBlancer\",\n          \"client_port\": 54931,\n          \"backend_port\": 80,\n          \"request_processing_time\": 5.1e-05,\n          \"backend_processing_time\": 0.00074,\n          \"response_processing_time\": 2.1e-05,\n          \"elb_status_code\": 304,\n          \"backend_status_code\": 304,\n          \"received_bytes\": 0,\n          \"sent_bytes\": 0,\n          \"request\": \"GET http://loadblancer-11111.ap-northeast-1.elb.amazonaws.com:80/ HTTP/1.1\",\n          \uff08\u4ee5\u4e0b\u7565)\n```\n\n\u7121\u4e8b\u767b\u9332\u3055\u308c\u3066\u3044\u307e\u3057\u305f\u3002\n\n# kibana\n\nkibana\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u53ca\u3073\u914d\u7f6e\u3002\n\n```\n$wget https://download.elastic.co/kibana/kibana/kibana-3.1.2.tar.gz\n$tar -zxvf kibana-3.1.2.tar.gz\n$mv kibana-3.1.2 kibana\n$sudo mv kibana /usr/share/nginx/html\n```\n\nelasticsearch1.4\u304b\u3089\u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u5411\u4e0a\u304c\u76ee\u7684\u3067\u8a2d\u5b9a\u304c\u8ffd\u52a0\u3067\u5fc5\u8981\u306b\u306a\u3063\u305f\u3088\u3046\u3067\u3001\u305d\u308c\u3092\u8ffd\u52a0\u3057\u307e\u3059\u3002\n\n```\n$sudo vi /etc/elasticsearch/elasticsearch.yml \n```\n\n\u4ee5\u4e0b\u3092\u672b\u5c3e\u306b\u8ffd\u52a0\n\n```lang:/etc/elasticsearch/elasticsearch.yml\nhttp.cors.allow-origin: \"/.*/\"\nhttp.cors.enabled: true\n```\n\n\n\u307e\u305f\u3001SecurityGroup\u306780\u756a\u30689200\u756a\u306e\u30dd\u30fc\u30c8\u304c\u7a7a\u3044\u3066\u3044\u308b\u304b\u78ba\u8a8d\u3057\u307e\u3059\u30029200\u756a\u306fKibana \u304c\u691c\u7d22\u30af\u30a8\u30ea\u3092\u6295\u3052\u308b\u30dd\u30fc\u30c8\u306e\u3088\u3046\u3067\u3059\u3002\n\nelasticsearch,nginx\u306e\u518d\u8d77\u52d5\n\n```\n$sudo service elasticsearch restart\n$sudo service nginx restart\n```\n\n\u3053\u306e\u72b6\u614b\u3067 **http://[hostname]/kibana/** \u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3053\u3068\u3067\u753b\u9762\u304c\u8868\u793a\u3055\u308c\u307e\u3057\u305f\u3002\n"}