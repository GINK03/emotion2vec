{"context": "LetsEncrypt\u3092\u4f7f\u3063\u3066\u307f\u305f\u304b\u3063\u305f\u3002\nnginx\u3067HTTP\u30ea\u30af\u30a8\u30b9\u30c8\u3092\u53d7\u3051\u3066\u30ea\u30d0\u30fc\u30b9\u30d7\u30ed\u30ad\u30b7\u3067\u30b3\u30f3\u30c6\u30ca\u306eHTTP\u30b5\u30fc\u30d0\u306bproxy_pass\u3057\u3066\u3044\u308b\u72b6\u614b\u304b\u3089LetsEncrypt\u306eSSL\u8a3c\u660e\u66f8\u3092\u5229\u7528\u3057\u305f\u3044\u3002\n\n\u524d\u63d0\nCentOS 7.2(host)\ndocker 1.8\nnginx 1.9\n\u30b3\u30f3\u30c6\u30ca\u306fFROM centos:centos7\u3067Dockerfile\u3092\u4f7f\u3063\u3066\u7acb\u3066\u305f\u3082\u306e\u3002\n\n\u8ab2\u984c\n\u3059\u3067\u306b\u7acb\u3066\u3066\u3044\u308b\u30b3\u30f3\u30c6\u30ca\u306f80/tcp\u3057\u304b\u7a7a\u3051\u3066\u3044\u306a\u3044\u3002\n\u30b3\u30f3\u30c6\u30ca\u3092\u4f5c\u308a\u76f4\u3059\u306e\u306f\u5acc\u3060\u306a\u3042\u3001\u3068\u8003\u3048\u305f\u3002\n\n\u5b9f\u73fe\u65b9\u6cd5\n\u30d5\u30a9\u30eb\u30c0\u3092\u5171\u6709\u3059\u308b\u65b9\u6cd5\u3067\u3001\u30b3\u30f3\u30c6\u30ca\u306e\u9375\u30d5\u30a9\u30eb\u30c0\u3092\u30db\u30b9\u30c8\u5074\u306b\u5171\u6709\u3057\u3001\u30db\u30b9\u30c8\u5074\u3067\u898b\u3048\u305f\u9375\u3092nginx\u3067\u5229\u7528\u3059\u308b\u3002\n\n\u30db\u30b9\u30c8\u5074\u306e\u64cd\u4f5c\n\n\u5171\u6709\u7528\u306e\u30d5\u30a9\u30eb\u30c0\u3092\u4f5c\u6210\u3059\u308b\n$ sudo mkdir /etc/nginx/cert\n\n\u307e\u3042\u3001\u3069\u3053\u3067\u3082\u3044\u3044\u306e\u3060\u304c\u3001nginx\u306e\u3068\u3053\u308d\u306b\u4f5c\u3063\u305f\u3002\n\n\u30b3\u30f3\u30c6\u30ca\u306e\u30a8\u30af\u30b9\u30dd\u30fc\u30c8\u3068\u30a4\u30f3\u30dd\u30fc\u30c8\n$ sudo docker stop <container_id>\n$ sudo docker export <container_id> > container_name.tar\n$ sudo cat container_name.tar | docker import - <repository>:<tag>\n\n\u4e00\u65e6\u6b62\u3081\u3066\u30d5\u30a1\u30a4\u30eb\u306b\u66f8\u304d\u51fa\u3057\u3066\u3001\u30a4\u30e1\u30fc\u30b8\u3068\u3057\u3066\u30a4\u30f3\u30dd\u30fc\u30c8\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u3002\n\n\u30b3\u30f3\u30c6\u30ca\u306e\u8d77\u52d5\n$ sudo docker run --privileged -v /etc/nginx/cert:/etc/letsencrypt/ -d --name <new_container_name> -it -p 20080:80 <repository>:<tag>\n\n-v\u30aa\u30d7\u30b7\u30e7\u30f3\u3067\u30b3\u30f3\u30c6\u30ca\u306e/etc/letsencrypt/\u3092\u30db\u30b9\u30c8\u306e/etc/nginx/cert\u3068\u5171\u6709\u3059\u308b\u3088\u3046\u306b\u8a2d\u7f6e\u3057\u305f\u3002\n\nnginx\u306e\u8a2d\u5b9a\u3068\u518d\u8d77\u52d5\n\u3059\u3067\u306b\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3055\u308c\u3066\u3044\u308b\u524d\u63d0\u306a\u306e\u3067\u3001\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u306f\u7701\u7565\u3002\n\n/etc/nginx/conf.d/virtual.conf\nserver {\n    listen 80;\n    server_name www.hogehoge.com;\n    location / {\n        proxy_pass http://127.0.0.1:20080;\n    }\n}\n\n\nnginx\u3092\u518d\u8d77\u52d5\u3059\u308b\u3002\n$ sudo systemctl reload nginx\n\n\n\u30b3\u30f3\u30c6\u30ca\u306e\u64cd\u4f5c\n\n\u30b3\u30f3\u30c6\u30ca\u3067LetsEncrypt\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\n\u3059\u3067\u306b\u30b3\u30f3\u30c6\u30ca\u3067HTTP\u30b5\u30fc\u30d0\u304c\u8d77\u52d5\u3057\u3066\u3044\u308b\u524d\u63d0\u3002\n$ sudo su -\n$ cd ~\n# git clone https://github.com/letsencrypt/letsencrypt\n# cd letsencrypt/\n# ./letsencrypt-auto --help\n# ./letsencrypt-auto certonly --webroot --webroot-path /var/www/html -d www.hogehoge.com\n# exit\n\n\u5927\u4f53\u3046\u307e\u304f\u3086\u304f\u3002\n\n\u30b3\u30f3\u30c6\u30ca\u3067\u8a3c\u660e\u66f8\u3092\u66f4\u65b0\u3059\u308b\u305f\u3081\u306ecron\u3092\u8a2d\u5b9a\u3059\u308b\n$ sudo crontab -e\n\n00 03 01 * * /root/letsencrypt/letsencrypt-auto certonly --webroot --webroot-path /var/www/html -d www.hogehoge.com --renew-by-default\n\n\u6bce\u67081\u65e5\u306e\u5348\u524d3\u6642\u306bcron\u304c\u52d5\u3044\u3066\u3001\u8a3c\u660e\u66f8\u3092\u66f4\u65b0\u3059\u308b\u3002\n\n\u518d\u5ea6\u30db\u30b9\u30c8\u5074\u306e\u64cd\u4f5c\n\n\u8a3c\u660e\u66f8\u304c\u3042\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3059\u308b\n$ sudo ls -l /etc/nginx/cert/live/www.hogehoge.com/\n\u5408\u8a08 0\nlrwxrwxrwx 1 root root 34  3\u6708  6 00:10 cert.pem -> ../../archive/www.hogehoge.com/cert1.pem\nlrwxrwxrwx 1 root root 35  3\u6708  6 00:10 chain.pem -> ../../archive/www.hogehoge.com/chain1.pem\nlrwxrwxrwx 1 root root 39  3\u6708  6 00:10 fullchain.pem -> ../../archive/www.hogehoge.com/fullchain1.pem\nlrwxrwxrwx 1 root root 37  3\u6708  6 00:10 privkey.pem -> ../../archive/www.hogehoge.com/privkey1.pem\n\n\n\u30db\u30b9\u30c8\u3067nginx\u306e\u518d\u8a2d\u5b9a\u3068\u518d\u8d77\u52d5\nconf\u3092\u7de8\u96c6\u3059\u308b\u3002\n\n/etc/nginx/conf.d/virtual.conf\nserver {\n    listen 80;\n    server_name www.hogehoge.com;\n    location / {\n        return 301 https://$host$request_uri;\n    }\n}\nserver {\n    listen 443;\n    server_name www.hogehoge.com;\n\n    ssl on;\n    ssl_certificate     /etc/nginx/cert/live/www.hogehoge.com/fullchain.pem;\n    ssl_certificate_key /etc/nginx/cert/live/www.hogehoge.com/privkey.pem;\n\n    ssl_session_timeout  5m;\n    ssl_protocols  TLSv1 TLSv1.1 TLSv1.2;\n    ssl_ciphers  ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-GCM-SHA384:ECDH-RSA-AES256-GCM-SHA384:ECDH-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDH-RSA-AES128-GCM-SHA256:ECDH-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDH-RSA-AES256-SHA384:ECDH-ECDSA-AES256-SHA384:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDH-RSA-AES128-SHA256:ECDH-ECDSA-AES128-SHA256;\n    ssl_prefer_server_ciphers   on;\n    add_header Strict-Transport-Security 'max-age=31536000;includeSubDomains;';\n\n    location / {\n        proxy_pass http://127.0.0.1:20080;\n    }\n}\n\n\nnginx\u3092\u518d\u8d77\u52d5\u3059\u308b\u3002\n$ sudo systemctl reload nginx\n\n\n\u30db\u30b9\u30c8\u5074\u3067\u3082cron\u3092\u8d70\u3089\u305b\u308b\n$ sudo crontab -e\n\n00 04 01 * * /usr/bin/systemctl reload nginx\n\n\u6bce\u67081\u65e5\u306e\u5348\u524d4\u6642\u306bcron\u304c\u52d5\u3044\u3066\u3001nginx\u3092\u518d\u8d77\u52d5\u3059\u308b\u3002\n\u3053\u308c\u3067\u4f5c\u696d\u5b8c\u4e86\n\n\u88dc\u8db3\n\u30b3\u30f3\u30c6\u30ca\u306eDockerfile\u3067\u306f\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306bhttpd\u3068crond\u306e\u30b5\u30fc\u30d3\u30b9\u3092\u8d77\u52d5\u3059\u308b\u8a2d\u5b9a\u306b\u3057\u3066\u304a\u304f\u306e\u304c\u30b3\u30c4\u3002\n\nDockerfile\nFROM centos:centos7\nRUN systemctl enable httpd\nRUN systemctl enable crond\nEXPOSE 80\n\n\nLetsEncrypt\u3092\u4f7f\u3063\u3066\u307f\u305f\u304b\u3063\u305f\u3002\nnginx\u3067HTTP\u30ea\u30af\u30a8\u30b9\u30c8\u3092\u53d7\u3051\u3066\u30ea\u30d0\u30fc\u30b9\u30d7\u30ed\u30ad\u30b7\u3067\u30b3\u30f3\u30c6\u30ca\u306eHTTP\u30b5\u30fc\u30d0\u306bproxy_pass\u3057\u3066\u3044\u308b\u72b6\u614b\u304b\u3089LetsEncrypt\u306eSSL\u8a3c\u660e\u66f8\u3092\u5229\u7528\u3057\u305f\u3044\u3002\n\n# \u524d\u63d0\nCentOS 7.2(host)\ndocker 1.8\nnginx 1.9\n\u30b3\u30f3\u30c6\u30ca\u306f`FROM centos:centos7`\u3067Dockerfile\u3092\u4f7f\u3063\u3066\u7acb\u3066\u305f\u3082\u306e\u3002\n\n# \u8ab2\u984c\n\u3059\u3067\u306b\u7acb\u3066\u3066\u3044\u308b\u30b3\u30f3\u30c6\u30ca\u306f80/tcp\u3057\u304b\u7a7a\u3051\u3066\u3044\u306a\u3044\u3002\n\u30b3\u30f3\u30c6\u30ca\u3092\u4f5c\u308a\u76f4\u3059\u306e\u306f\u5acc\u3060\u306a\u3042\u3001\u3068\u8003\u3048\u305f\u3002\n\n# \u5b9f\u73fe\u65b9\u6cd5\n\u30d5\u30a9\u30eb\u30c0\u3092\u5171\u6709\u3059\u308b\u65b9\u6cd5\u3067\u3001\u30b3\u30f3\u30c6\u30ca\u306e\u9375\u30d5\u30a9\u30eb\u30c0\u3092\u30db\u30b9\u30c8\u5074\u306b\u5171\u6709\u3057\u3001\u30db\u30b9\u30c8\u5074\u3067\u898b\u3048\u305f\u9375\u3092nginx\u3067\u5229\u7528\u3059\u308b\u3002\n\n## \u30db\u30b9\u30c8\u5074\u306e\u64cd\u4f5c\n\n### \u5171\u6709\u7528\u306e\u30d5\u30a9\u30eb\u30c0\u3092\u4f5c\u6210\u3059\u308b\n\n```lang:\n$ sudo mkdir /etc/nginx/cert\n```\n\u307e\u3042\u3001\u3069\u3053\u3067\u3082\u3044\u3044\u306e\u3060\u304c\u3001nginx\u306e\u3068\u3053\u308d\u306b\u4f5c\u3063\u305f\u3002\n\n### \u30b3\u30f3\u30c6\u30ca\u306e\u30a8\u30af\u30b9\u30dd\u30fc\u30c8\u3068\u30a4\u30f3\u30dd\u30fc\u30c8\n\n```lang:\n$ sudo docker stop <container_id>\n$ sudo docker export <container_id> > container_name.tar\n$ sudo cat container_name.tar | docker import - <repository>:<tag>\n```\n\u4e00\u65e6\u6b62\u3081\u3066\u30d5\u30a1\u30a4\u30eb\u306b\u66f8\u304d\u51fa\u3057\u3066\u3001\u30a4\u30e1\u30fc\u30b8\u3068\u3057\u3066\u30a4\u30f3\u30dd\u30fc\u30c8\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u3002\n\n### \u30b3\u30f3\u30c6\u30ca\u306e\u8d77\u52d5\n\n```lang:\n$ sudo docker run --privileged -v /etc/nginx/cert:/etc/letsencrypt/ -d --name <new_container_name> -it -p 20080:80 <repository>:<tag>\n```\n`-v`\u30aa\u30d7\u30b7\u30e7\u30f3\u3067\u30b3\u30f3\u30c6\u30ca\u306e/etc/letsencrypt/\u3092\u30db\u30b9\u30c8\u306e/etc/nginx/cert\u3068\u5171\u6709\u3059\u308b\u3088\u3046\u306b\u8a2d\u7f6e\u3057\u305f\u3002\n\n### nginx\u306e\u8a2d\u5b9a\u3068\u518d\u8d77\u52d5\n\n\u3059\u3067\u306b\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3055\u308c\u3066\u3044\u308b\u524d\u63d0\u306a\u306e\u3067\u3001\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u306f\u7701\u7565\u3002\n\n```lang:/etc/nginx/conf.d/virtual.conf\nserver {\n    listen 80;\n    server_name www.hogehoge.com;\n    location / {\n        proxy_pass http://127.0.0.1:20080;\n    }\n}\n```\nnginx\u3092\u518d\u8d77\u52d5\u3059\u308b\u3002\n\n```lang:\n$ sudo systemctl reload nginx\n```\n\n## \u30b3\u30f3\u30c6\u30ca\u306e\u64cd\u4f5c\n\n### \u30b3\u30f3\u30c6\u30ca\u3067LetsEncrypt\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\n\n\u3059\u3067\u306b\u30b3\u30f3\u30c6\u30ca\u3067HTTP\u30b5\u30fc\u30d0\u304c\u8d77\u52d5\u3057\u3066\u3044\u308b\u524d\u63d0\u3002\n\n```lang:\n$ sudo su -\n$ cd ~\n# git clone https://github.com/letsencrypt/letsencrypt\n# cd letsencrypt/\n# ./letsencrypt-auto --help\n# ./letsencrypt-auto certonly --webroot --webroot-path /var/www/html -d www.hogehoge.com\n# exit\n```\n\u5927\u4f53\u3046\u307e\u304f\u3086\u304f\u3002\n\n### \u30b3\u30f3\u30c6\u30ca\u3067\u8a3c\u660e\u66f8\u3092\u66f4\u65b0\u3059\u308b\u305f\u3081\u306ecron\u3092\u8a2d\u5b9a\u3059\u308b\n\n```lang:\n$ sudo crontab -e\n```\n```lang:\n00 03 01 * * /root/letsencrypt/letsencrypt-auto certonly --webroot --webroot-path /var/www/html -d www.hogehoge.com --renew-by-default\n```\n\u6bce\u67081\u65e5\u306e\u5348\u524d3\u6642\u306bcron\u304c\u52d5\u3044\u3066\u3001\u8a3c\u660e\u66f8\u3092\u66f4\u65b0\u3059\u308b\u3002\n\n## \u518d\u5ea6\u30db\u30b9\u30c8\u5074\u306e\u64cd\u4f5c\n\n### \u8a3c\u660e\u66f8\u304c\u3042\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3059\u308b\n\n```lang:\n$ sudo ls -l /etc/nginx/cert/live/www.hogehoge.com/\n\u5408\u8a08 0\nlrwxrwxrwx 1 root root 34  3\u6708  6 00:10 cert.pem -> ../../archive/www.hogehoge.com/cert1.pem\nlrwxrwxrwx 1 root root 35  3\u6708  6 00:10 chain.pem -> ../../archive/www.hogehoge.com/chain1.pem\nlrwxrwxrwx 1 root root 39  3\u6708  6 00:10 fullchain.pem -> ../../archive/www.hogehoge.com/fullchain1.pem\nlrwxrwxrwx 1 root root 37  3\u6708  6 00:10 privkey.pem -> ../../archive/www.hogehoge.com/privkey1.pem\n```\n\n### \u30db\u30b9\u30c8\u3067nginx\u306e\u518d\u8a2d\u5b9a\u3068\u518d\u8d77\u52d5\nconf\u3092\u7de8\u96c6\u3059\u308b\u3002\n\n```lang:/etc/nginx/conf.d/virtual.conf\nserver {\n    listen 80;\n    server_name www.hogehoge.com;\n    location / {\n        return 301 https://$host$request_uri;\n    }\n}\nserver {\n    listen 443;\n    server_name www.hogehoge.com;\n\n    ssl on;\n    ssl_certificate     /etc/nginx/cert/live/www.hogehoge.com/fullchain.pem;\n    ssl_certificate_key /etc/nginx/cert/live/www.hogehoge.com/privkey.pem;\n\n    ssl_session_timeout  5m;\n    ssl_protocols  TLSv1 TLSv1.1 TLSv1.2;\n    ssl_ciphers  ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-GCM-SHA384:ECDH-RSA-AES256-GCM-SHA384:ECDH-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDH-RSA-AES128-GCM-SHA256:ECDH-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDH-RSA-AES256-SHA384:ECDH-ECDSA-AES256-SHA384:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDH-RSA-AES128-SHA256:ECDH-ECDSA-AES128-SHA256;\n    ssl_prefer_server_ciphers   on;\n    add_header Strict-Transport-Security 'max-age=31536000;includeSubDomains;';\n\n    location / {\n        proxy_pass http://127.0.0.1:20080;\n    }\n}\n```\nnginx\u3092\u518d\u8d77\u52d5\u3059\u308b\u3002\n\n```lang:\n$ sudo systemctl reload nginx\n```\n\n### \u30db\u30b9\u30c8\u5074\u3067\u3082cron\u3092\u8d70\u3089\u305b\u308b\n\n```lang:\n$ sudo crontab -e\n```\n```lang:\n00 04 01 * * /usr/bin/systemctl reload nginx\n```\n\u6bce\u67081\u65e5\u306e\u5348\u524d4\u6642\u306bcron\u304c\u52d5\u3044\u3066\u3001nginx\u3092\u518d\u8d77\u52d5\u3059\u308b\u3002\n\n\u3053\u308c\u3067\u4f5c\u696d\u5b8c\u4e86\n\n# \u88dc\u8db3\n\n\u30b3\u30f3\u30c6\u30ca\u306eDockerfile\u3067\u306f\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306bhttpd\u3068crond\u306e\u30b5\u30fc\u30d3\u30b9\u3092\u8d77\u52d5\u3059\u308b\u8a2d\u5b9a\u306b\u3057\u3066\u304a\u304f\u306e\u304c\u30b3\u30c4\u3002\n\n```lang:Dockerfile\nFROM centos:centos7\nRUN systemctl enable httpd\nRUN systemctl enable crond\nEXPOSE 80\n```\n", "tags": ["nginx", "docker", "letsencrypt", "centos7"]}