{"tags": ["bigquery"], "context": "embulk-output-bigquery \u306e Partitioned Table \u5bfe\u5fdc\u3067\u8abf\u3079\u3066\u305f\u306e\u3067\u3001\u305d\u306e\u6642\u306b\u8abf\u3079\u305f\u3082\u306e\u3092\u96d1\u306b\u307e\u3068\u3081\u3066\u304a\u304f\u3002API\u3092\u76f4\u63a5\u53e9\u3044\u3066\u5b9f\u88c5\u3057\u3066\u3044\u308b\u306e\u3067\u3001bq \u30b3\u30de\u30f3\u30c9\u3067\u306e\u4f7f\u3044\u65b9\u306b\u3064\u3044\u3066\u306f\u8abf\u3079\u3066\u3044\u306a\u3044\u3002\nReferences\n\nCreating and Updating Date-Partitioned Tables\nJobs: insert\n\n\nTL; DR\n\n\u57fa\u672c\u7684\u306b tableId \u306b partition decorator ($YYYYMMDD) \u3092\u6307\u5b9a\u3057\u3066\u64cd\u4f5c\u3059\u308b\nDAY\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u3057\u304b(\u4eca\u306e\u3068\u3053\u308d)\u5207\u308c\u306a\u3044\u3002\n\u7279\u5b9a\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u306e\u30c7\u30fc\u30bf\u3092\u7f6e\u304d\u63db\u3048\u305f\u3044\u5834\u5408\u306f\u3001\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u3092\u6307\u5b9a\u3057\u3066\u3001writeDisposition: 'WRITE_TRUNCATE'\u3068\u3057\u3066 load (\u307e\u305f\u306f copy)\u30b8\u30e7\u30d6\u3092\u767a\u884c\u3059\u308b\n\nDrop Partition \u306e\u64cd\u4f5c\u304c\u4eca\u306e\u6240\u306a\u3044\u306e\u3067\u3001\u6d88\u3057\u305f\u3044\u5834\u5408\u306f load job API \u3067\u7a7a\u30c7\u30fc\u30bf\u3092\u30ed\u30fc\u30c9\u3059\u308b? Tables: delete API \u3067 partition decorator \u3092\u6307\u5b9a\u3059\u308c\u3070\u6d88\u305b\u308b\n\u30b9\u30ad\u30fc\u30de\u5909\u66f4\u306f\u30ab\u30e9\u30e0\u8ffd\u52a0\u3001\u65e2\u5b58\u30ab\u30e9\u30e0\u3092NULLABLE\u306b\u3059\u308b\u3053\u3068\u306b\u3088\u308b\u64ec\u4f3c\u7684\u306a\u524a\u9664\u3001\u3050\u3089\u3044\u3057\u304b\u3067\u304d\u306a\u3044\n\u8ffd\u8a18: DML (update, delete, insert) \u306f(\u4eca\u306e\u3068\u3053\u308d)\u3067\u304d\u306a\u3044\n\n\nPartitioned Table \u306e\u4f5c\u308a\u65b9\nSee https://cloud.google.com/bigquery/docs/creating-partitioned-tables\nTables: insert API \u3092\u4f7f\u3063\u3066\u3001\u30c6\u30fc\u30d6\u30eb\u3092\u4f5c\u6210\u3059\u308b\u6642\u306b\n{\n  \"tableReference\": {\n    \"projectId\": \"myProject\",\n    \"tableId\": \"table2\",\n    \"datasetId\": \"mydataset\"\n  },\n  \"timePartitioning\": {\n    \"type\": \"DAY\",\n    \"expirationMs\": 259200000\n  }\n}\n\n\u306e\u3088\u3046\u306b timePartitioning \u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u8a2d\u5b9a\u3059\u308c\u3070\u826f\u3044\u3002\n\u7279\u8a18\u4e8b\u9805: \u73fe\u5728\u3001type \u306f DAY \u3057\u304b\u9078\u629e\u3067\u304d\u306a\u3044\u3002HOUR \u3084 MONTH \u3084\u6642\u9593\u4ee5\u5916\u306e\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u3092\u5207\u308b\u3053\u3068\u306f\u3067\u304d\u306a\u3044\u3002\n\n\u30b9\u30ad\u30fc\u30de\u6307\u5b9a\n\u4ee5\u4e0b\u306e\u3044\u305a\u308c\u304b\n\n\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u30c6\u30fc\u30d6\u30eb\u3092\u4f5c\u308b\u969b\u306b schema \u3092\u6307\u5b9a\u3059\u308b\n\u6700\u521d\u306e\u30c7\u30fc\u30bf\u6295\u5165\u6642\u306b schema \u3092\u6307\u5b9a\u3059\u308b\n\u6700\u521d\u306e\u30c7\u30fc\u30bf\u6295\u5165\u6642\u306b BigQuery \u306e\u6301\u3064\u81ea\u52d5\u30b9\u30ad\u30fc\u30de\u63a8\u5b9a\u6a5f\u80fd\u306b\u307e\u304b\u305b\u308b\n\n\u300c\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u30c6\u30fc\u30d6\u30eb\u3092\u4f5c\u308b\u969b\u306b BigQuery \u306e\u6301\u3064\u81ea\u52d5\u30b9\u30ad\u30fc\u30de\u63a8\u5b9a\u6a5f\u80fd\u306b\u307e\u304b\u305b\u308b\u300d\u306f\u3067\u304d\u306a\u3044(\u30c7\u30fc\u30bf\u304c\u306a\u3044\u306e\u3067)\u3002\n\u4e00\u5ea6\u6c7a\u3081\u308b\u3068\u3001\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u306e\u30c7\u30fc\u30bf\u3092\u7f6e\u304d\u63db\u3048\u3066\u3082\u30c6\u30fc\u30d6\u30eb\u306e\u30b9\u30ad\u30fc\u30de\u306f\u7f6e\u304d\u63db\u3048\u3089\u308c\u306a\u3044\u3002\n\u30c7\u30fc\u30bf\u306e\u30b9\u30ad\u30fc\u30de\u304c\u30c6\u30fc\u30d6\u30eb\u306e\u30b9\u30ad\u30fc\u30de\u306b\u5408\u308f\u306a\u3044\u5834\u5408\u306f\u30a8\u30e9\u30fc\u3068\u306a\u308b\u3002\n\n\u30b9\u30ad\u30fc\u30de\u5909\u66f4\nNULLABLE\u306a\u30ab\u30e9\u30e0\u8ffd\u52a0\u3068\u3001\u65e2\u5b58\u30ab\u30e9\u30e0\u306eNULLABLE\u3078\u306e\u5909\u66f4\u306e\u307f\u30b5\u30dd\u30fc\u30c8\u3055\u308c\u3066\u3044\u308b\u3002\nTables: patch \u3082\u3057\u304f\u306f Tables: update \u3092\u5229\u7528\u3059\u308b.\n\u307e\u305f\u306f load job\u3001 copy job\u3001query job \u306b schemaUpdateOptions \u3068\u3044\u3046\u30d1\u30e9\u30e1\u30fc\u30bf\u304c\u5897\u3048\u3066\u304a\u308a\u3001job \u306e\u526f\u4f5c\u7528\u3068\u3057\u3066\u3001\u30ab\u30e9\u30e0\u306e\u8ffd\u52a0(ALLOW_FIELD_ADDITION)\u3001\u3082\u3057\u304f\u306f\u65e2\u5b58\u30ab\u30e9\u30e0\u3092NULLABLE\u306b\u3059\u308b\u3053\u3068\u306b\u3088\u308b\u64ec\u4f3c\u7684\u306a\u30ab\u30e9\u30e0\u306e\u524a\u9664(ALLOW_FIELD_RELAXATION)\u3092\u884c\u3046\u3053\u3068\u304c\u3067\u304d\u308b\u3002\n{\n  \"configuration\": {\n    \"load\": {\n      \"destinationTable\": {\n        \"tableId\": \"table$20160929\"\n      },\n      \"writeDisposition\": \"WRITE_TRUNCATE\",\n      \"schemaUpdateOptions\": [\"ALLOW_FIELD_ADDITION\", \"ALLOW_FIELD_RELAXATION\"]\n    }\n  }\n}\n\n\u8ffd\u8a18: \u6b8b\u5ff5\u306a\u3053\u3068\u306b copy job \u306b\u306f schemaUpdateOptions \u30aa\u30d7\u30b7\u30e7\u30f3\u304c\u306a\u304b\u3063\u305f\u2026\uff01\n\nPartitioned Table (\u304b\u3089|\u3078)\u306e copy\nJobs: insert API\u3092\u4f7f\u3063\u3066\u3001copy \u3059\u308b\u969b\u306b table \u306b\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u30c7\u30b3\u30ec\u30fc\u30bf($YYYYMMDD)\u3092\u6307\u5b9a\u3059\u308c\u3070\u3088\u3044\u3002\n{\n  \"configuration\": {\n    \"copy\": {\n      \"sourceTable\": {\n        \"tableId\": \"from_table$20160929\"\n      },\n      \"destinationTable\": {\n        \"tableId\": \"to_table$20160929\"\n      },\n      \"writeDisposition\": \"WRITE_TRUNCATE\"\n    }\n  }\n}\n\n\u8a66\u3057\u305f\u6240\u3001\u4ee5\u4e0b\u306e\u3044\u305a\u308c\u306e\u30d1\u30bf\u30fc\u30f3\u3082\u52d5\u4f5c\u3057\u305f\u3002\n\ntable \u304b\u3089 partition\npartition \u304b\u3089 table\npartition \u304b\u3089 partition\n\n\u7279\u8a18\u4e8b\u9805: table \u3078\u306e\u30b3\u30d4\u30fc\u306e\u5834\u5408\u306f table \u304c\u81ea\u52d5\u3067\u4f5c\u3089\u308c\u308b\u304c\u3001partition \u3078\u306e\u30b3\u30d4\u30fc\u306e\u5834\u5408\u306f\u81ea\u52d5\u3067\u306f\u4f5c\u3089\u308c\u306a\u3044\u306e\u3067\u3001\u3042\u3089\u304b\u3058\u3081 create table \u3057\u3066\u304a\u304b\u306a\u3044\u3068\u3044\u3051\u306a\u3044\u3002embulk-output-bigquery \u3067\u306f auto_create_table\u30aa\u30d7\u30b7\u30e7\u30f3\u304c\u6709\u52b9\u306a\u5834\u5408\u306f\u3001\u81ea\u52d5\u3067\u4f5c\u308b\u3088\u3046\u306b\u3057\u3066\u304a\u3044\u305f\u3002\n\nPartitioned Table \u3078\u306e load\n\u3053\u3061\u3089\u3082 Jobs: insert API\u3092\u4f7f\u3063\u3066\u3001load \u3059\u308b\u969b\u306b table \u306b\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u30c7\u30b3\u30ec\u30fc\u30bf($YYYYMMDD)\u3092\u6307\u5b9a\u3059\u308c\u3070\u3088\u3044\u3002\n{\n  \"configuration\": {\n    \"load\": {\n      \"destinationTable\": {\n        \"tableId\": \"table$20160929\"\n      },\n      \"writeDisposition\": \"WRITE_TRUNCATE\"\n    }\n  }\n}\n\nwrite_disposition: 'WRITE_TRUNCATE' \u3068\u3059\u308c\u3070\u3001\u6307\u5b9a\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u3092 atomic \u306b\u7f6e\u304d\u63db\u3048\u3067\u304d\u308b\u3002\n\nDrop Partition\n\u306a\u3044\u3002load job \u3067\u7a7a\u30c7\u30fc\u30bf\u3092 write_disposition: 'WRITE_TRUNCATE' \u3068\u3057\u3066\u53d6\u308a\u8fbc\u3081\u3070\u3001\u6307\u5b9a\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u306e\u30c7\u30fc\u30bf\u306f\u6d88\u305b\u305d\u3046\u3002\nTables: delete API \u3067 partition decorator \u3092\u6307\u5b9a\u3059\u308c\u3070 partition \u3060\u3051\u6d88\u305b\u308b\n\nPartitioned Table \u3078\u306e\u5909\u63db\nbq \u30b3\u30de\u30f3\u30c9\u3067\u3067\u304d\u308b\u3002See https://cloud.google.com/bigquery/docs/creating-partitioned-tables\nbq partition mydataset.sharded_ mydataset.partitioned\n\n\u5185\u90e8\u7684\u306b\u306f table \u4e00\u89a7\u3092\u53d6\u3063\u3066\u3001copy job \u3067\u65e5\u4ed8 suffix \u3068\u5bfe\u5fdc\u3059\u308b\u65e5\u4ed8 partition \u306b\u30c7\u30fc\u30bf\u3092\u30b3\u30d4\u30fc\u3057\u3066\u3044\u308b\u3002\n\n\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u4e00\u89a7\u304a\u3088\u3073\u4f5c\u6210\u3001\u66f4\u65b0\u6642\u9593\u306e\u53d6\u5f97\nLegacy SQL \u3067\nSELECT partition_id,creation_time,last_modified_time from [mydataset.table1$__PARTITIONS_SUMMARY__];\n\n\nHint: TIMESTAMP\u578b\u306b\u5909\u66f4\u3057\u305f\u3051\u308c\u3070 MSEC_TO_TIMESTAMP(creation_time) \u306e\u3088\u3046\u306b\u3059\u308c\u3070\u3088\u3044\n\n\u30af\u30a8\u30ea\u5bfe\u8c61\u306e\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u3092\u7d5e\u308b\nSee https://cloud.google.com/bigquery/docs/querying-partitioned-tables\n_PARTITIONTIME\u7591\u4f3c\u30ab\u30e9\u30e0\u306b\u5bfe\u3057\u3066WHERE\u6761\u4ef6\u3092\u66f8\u304f\nSELECT\n  field1\nFROM\n  table2\nWHERE\n  _PARTITIONTIME BETWEEN TIMESTAMP('2016-01-01')\n  AND TIMESTAMP('2016-01-21');\n\nTABLE_DATE_RANGE\u306b\u3088\u308b\u30c6\u30fc\u30d6\u30eb\u691c\u7d22(\u3051\u3063\u3053\u3046\u9045\u3044)\u306e\u6642\u9593\u304c\u304b\u304b\u3089\u306a\u304f\u306a\u308b\u305f\u3081\u3001\u7d50\u679c\u304c\u8fd4\u3063\u3066\u304f\u308b\u306e\u304c\u901f\u304f\u306a\u308b\u3088\u3046\u3060\u3002\n\u8ffd\u8a18: custom quota \u6b8b\u91cf\u306b\u3064\u3044\u3066\n_PARTITIONTIME \u3067\u7d5e\u308a\u8fbc\u3093\u3060\u5834\u5408\u3067\u3082\u3001\u30c6\u30fc\u30d6\u30eb\u5168\u4f53\u306e\u5bb9\u91cf\u304c custom quota \u304b\u3089\u5dee\u3057\u5f15\u304b\u308c\u308b\u3002\u4f8b\u3048\u3070\u3001\u30c6\u30fc\u30d6\u30eb\u306e\u5bb9\u91cf\u304c1TB\u3067\u3001\u7d5e\u308a\u8fbc\u3093\u3060\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u304c100GB\u3067\u3082\u30011TB\u5dee\u3057\u5f15\u304b\u308c\u3066\u3057\u307e\u3046\u3002 ref. https://cloud.google.com/bigquery/cost-controls \"it currently ignores any _PARTITIONTIME or _TABLE_SUFFIX filters in the query\"\n\u3053\u308c\u3092\u9632\u3050\u306b\u306f\u3001table_name$YYYYMMDD \u306e\u3088\u3046\u306b partition decorator \u3067\u7279\u5b9a\u306e\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u3092\u6307\u5b9a\u3057\u3066\u30b9\u30ad\u30e3\u30f3\u3059\u308b\u3002\u3053\u306e\u5834\u5408\u306f\u3001\u305d\u306e\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u306e\u30c7\u30fc\u30bf\u91cf\u3060\u3051quota\u6b8b\u91cf\u304c\u6e1b\u308b\uff08\u30c6\u30fc\u30d6\u30eb\u5168\u4f53\u306e\u30b9\u30ad\u30e3\u30f3\u91cf\u3067\u306f\u306a\u304f\uff09\u3002\u305f\u3060\u3057\u3001Legacy SQL \u3067\u3057\u304b\u3053\u306e\u624b\u6cd5\u306f\u4f7f\u3048\u305a\u3001Standard SQL \u3067\u306f\u30a8\u30e9\u30fc\u3068\u306a\u308b\u3002ref. http://stackoverflow.com/questions/40638564/is-it-possible-to-access-a-bigquery-partition-in-standard-sql-using-the-deco\n\nPartitioned Table \u3078\u306e DML (update, delete, insert)\ncf. https://cloud.google.com/bigquery/docs/reference/standard-sql/data-manipulation-language\n\nDML statements that modify partitioned tables are not yet supported.\n\n\u3068\u306e\u3053\u3068\u3067\u307e\u3060\u5229\u7528\u3067\u304d\u306a\u3044(2017/03/09\u8abf\u3079)\n[embulk-output-bigquery](https://github.com/embulk/embulk-output-bigquery) \u306e Partitioned Table \u5bfe\u5fdc\u3067\u8abf\u3079\u3066\u305f\u306e\u3067\u3001\u305d\u306e\u6642\u306b\u8abf\u3079\u305f\u3082\u306e\u3092\u96d1\u306b\u307e\u3068\u3081\u3066\u304a\u304f\u3002API\u3092\u76f4\u63a5\u53e9\u3044\u3066\u5b9f\u88c5\u3057\u3066\u3044\u308b\u306e\u3067\u3001bq \u30b3\u30de\u30f3\u30c9\u3067\u306e\u4f7f\u3044\u65b9\u306b\u3064\u3044\u3066\u306f\u8abf\u3079\u3066\u3044\u306a\u3044\u3002\n\nReferences\n\n* [Creating and Updating Date-Partitioned Tables](https://cloud.google.com/bigquery/docs/creating-partitioned-tables)\n* [Jobs: insert](https://cloud.google.com/bigquery/docs/reference/v2/jobs)\n\n## TL; DR\n\n* \u57fa\u672c\u7684\u306b tableId \u306b partition decorator (`$YYYYMMDD`) \u3092\u6307\u5b9a\u3057\u3066\u64cd\u4f5c\u3059\u308b\n* DAY\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u3057\u304b(\u4eca\u306e\u3068\u3053\u308d)\u5207\u308c\u306a\u3044\u3002\n* \u7279\u5b9a\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u306e\u30c7\u30fc\u30bf\u3092\u7f6e\u304d\u63db\u3048\u305f\u3044\u5834\u5408\u306f\u3001\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u3092\u6307\u5b9a\u3057\u3066\u3001`writeDisposition: 'WRITE_TRUNCATE'`\u3068\u3057\u3066 load (\u307e\u305f\u306f copy)\u30b8\u30e7\u30d6\u3092\u767a\u884c\u3059\u308b\n* ~~Drop Partition \u306e\u64cd\u4f5c\u304c\u4eca\u306e\u6240\u306a\u3044\u306e\u3067\u3001\u6d88\u3057\u305f\u3044\u5834\u5408\u306f load job API \u3067\u7a7a\u30c7\u30fc\u30bf\u3092\u30ed\u30fc\u30c9\u3059\u308b?~~ [Tables: delete](https://cloud.google.com/bigquery/docs/reference/rest/v2/tables/delete) API \u3067 partition decorator \u3092\u6307\u5b9a\u3059\u308c\u3070\u6d88\u305b\u308b\n* \u30b9\u30ad\u30fc\u30de\u5909\u66f4\u306f\u30ab\u30e9\u30e0\u8ffd\u52a0\u3001\u65e2\u5b58\u30ab\u30e9\u30e0\u3092NULLABLE\u306b\u3059\u308b\u3053\u3068\u306b\u3088\u308b\u64ec\u4f3c\u7684\u306a\u524a\u9664\u3001\u3050\u3089\u3044\u3057\u304b\u3067\u304d\u306a\u3044\n* \u8ffd\u8a18: DML (update, delete, insert) \u306f(\u4eca\u306e\u3068\u3053\u308d)\u3067\u304d\u306a\u3044\n\n## Partitioned Table \u306e\u4f5c\u308a\u65b9\n\nSee https://cloud.google.com/bigquery/docs/creating-partitioned-tables\n\n[Tables: insert](https://cloud.google.com/bigquery/docs/reference/v2/tables/insert) API \u3092\u4f7f\u3063\u3066\u3001\u30c6\u30fc\u30d6\u30eb\u3092\u4f5c\u6210\u3059\u308b\u6642\u306b\n\n```json\n{\n  \"tableReference\": {\n    \"projectId\": \"myProject\",\n    \"tableId\": \"table2\",\n    \"datasetId\": \"mydataset\"\n  },\n  \"timePartitioning\": {\n    \"type\": \"DAY\",\n    \"expirationMs\": 259200000\n  }\n}\n```\n\n\u306e\u3088\u3046\u306b `timePartitioning` \u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u8a2d\u5b9a\u3059\u308c\u3070\u826f\u3044\u3002\n\n\u7279\u8a18\u4e8b\u9805: \u73fe\u5728\u3001`type` \u306f `DAY` \u3057\u304b\u9078\u629e\u3067\u304d\u306a\u3044\u3002HOUR \u3084 MONTH \u3084\u6642\u9593\u4ee5\u5916\u306e\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u3092\u5207\u308b\u3053\u3068\u306f\u3067\u304d\u306a\u3044\u3002\n\n## \u30b9\u30ad\u30fc\u30de\u6307\u5b9a\n\n\u4ee5\u4e0b\u306e\u3044\u305a\u308c\u304b\n\n1. \u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u30c6\u30fc\u30d6\u30eb\u3092\u4f5c\u308b\u969b\u306b schema \u3092\u6307\u5b9a\u3059\u308b\n2. \u6700\u521d\u306e\u30c7\u30fc\u30bf\u6295\u5165\u6642\u306b schema \u3092\u6307\u5b9a\u3059\u308b\n3. \u6700\u521d\u306e\u30c7\u30fc\u30bf\u6295\u5165\u6642\u306b BigQuery \u306e\u6301\u3064\u81ea\u52d5\u30b9\u30ad\u30fc\u30de\u63a8\u5b9a\u6a5f\u80fd\u306b\u307e\u304b\u305b\u308b\n\n\u300c\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u30c6\u30fc\u30d6\u30eb\u3092\u4f5c\u308b\u969b\u306b BigQuery \u306e\u6301\u3064\u81ea\u52d5\u30b9\u30ad\u30fc\u30de\u63a8\u5b9a\u6a5f\u80fd\u306b\u307e\u304b\u305b\u308b\u300d\u306f\u3067\u304d\u306a\u3044(\u30c7\u30fc\u30bf\u304c\u306a\u3044\u306e\u3067)\u3002\n\n\u4e00\u5ea6\u6c7a\u3081\u308b\u3068\u3001\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u306e\u30c7\u30fc\u30bf\u3092\u7f6e\u304d\u63db\u3048\u3066\u3082\u30c6\u30fc\u30d6\u30eb\u306e\u30b9\u30ad\u30fc\u30de\u306f\u7f6e\u304d\u63db\u3048\u3089\u308c\u306a\u3044\u3002\n\u30c7\u30fc\u30bf\u306e\u30b9\u30ad\u30fc\u30de\u304c\u30c6\u30fc\u30d6\u30eb\u306e\u30b9\u30ad\u30fc\u30de\u306b\u5408\u308f\u306a\u3044\u5834\u5408\u306f\u30a8\u30e9\u30fc\u3068\u306a\u308b\u3002\n\n## \u30b9\u30ad\u30fc\u30de\u5909\u66f4\n\nNULLABLE\u306a\u30ab\u30e9\u30e0\u8ffd\u52a0\u3068\u3001\u65e2\u5b58\u30ab\u30e9\u30e0\u306eNULLABLE\u3078\u306e\u5909\u66f4\u306e\u307f\u30b5\u30dd\u30fc\u30c8\u3055\u308c\u3066\u3044\u308b\u3002\n\n[Tables: patch](https://cloud.google.com/bigquery/docs/reference/v2/tables/patch) \u3082\u3057\u304f\u306f [Tables: update](https://cloud.google.com/bigquery/docs/reference/v2/tables/update) \u3092\u5229\u7528\u3059\u308b.\n\n\u307e\u305f\u306f load job\u3001 ~~copy job~~\u3001query job \u306b [schemaUpdateOptions](https://cloud.google.com/bigquery/docs/reference/v2/jobs#configuration.load.schemaUpdateOptions\n) \u3068\u3044\u3046\u30d1\u30e9\u30e1\u30fc\u30bf\u304c\u5897\u3048\u3066\u304a\u308a\u3001job \u306e\u526f\u4f5c\u7528\u3068\u3057\u3066\u3001\u30ab\u30e9\u30e0\u306e\u8ffd\u52a0(`ALLOW_FIELD_ADDITION`)\u3001\u3082\u3057\u304f\u306f\u65e2\u5b58\u30ab\u30e9\u30e0\u3092NULLABLE\u306b\u3059\u308b\u3053\u3068\u306b\u3088\u308b\u64ec\u4f3c\u7684\u306a\u30ab\u30e9\u30e0\u306e\u524a\u9664(`ALLOW_FIELD_RELAXATION`)\u3092\u884c\u3046\u3053\u3068\u304c\u3067\u304d\u308b\u3002\n\n```json\n{\n  \"configuration\": {\n    \"load\": {\n      \"destinationTable\": {\n        \"tableId\": \"table$20160929\"\n      },\n      \"writeDisposition\": \"WRITE_TRUNCATE\",\n      \"schemaUpdateOptions\": [\"ALLOW_FIELD_ADDITION\", \"ALLOW_FIELD_RELAXATION\"]\n    }\n  }\n}\n```\n\n\n\u8ffd\u8a18: \u6b8b\u5ff5\u306a\u3053\u3068\u306b copy job \u306b\u306f schemaUpdateOptions \u30aa\u30d7\u30b7\u30e7\u30f3\u304c\u306a\u304b\u3063\u305f\u2026\uff01\n\n## Partitioned Table (\u304b\u3089|\u3078)\u306e copy\n\n[Jobs: insert](https://cloud.google.com/bigquery/docs/reference/v2/jobs) API\u3092\u4f7f\u3063\u3066\u3001copy \u3059\u308b\u969b\u306b `table` \u306b\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u30c7\u30b3\u30ec\u30fc\u30bf(`$YYYYMMDD`)\u3092\u6307\u5b9a\u3059\u308c\u3070\u3088\u3044\u3002\n\n```json\n{\n  \"configuration\": {\n    \"copy\": {\n      \"sourceTable\": {\n        \"tableId\": \"from_table$20160929\"\n      },\n      \"destinationTable\": {\n        \"tableId\": \"to_table$20160929\"\n      },\n      \"writeDisposition\": \"WRITE_TRUNCATE\"\n    }\n  }\n}\n```\n\n\u8a66\u3057\u305f\u6240\u3001\u4ee5\u4e0b\u306e\u3044\u305a\u308c\u306e\u30d1\u30bf\u30fc\u30f3\u3082\u52d5\u4f5c\u3057\u305f\u3002\n\n* table \u304b\u3089 partition\n* partition \u304b\u3089 table\n* partition \u304b\u3089 partition\n\n\u7279\u8a18\u4e8b\u9805: table \u3078\u306e\u30b3\u30d4\u30fc\u306e\u5834\u5408\u306f table \u304c\u81ea\u52d5\u3067\u4f5c\u3089\u308c\u308b\u304c\u3001partition \u3078\u306e\u30b3\u30d4\u30fc\u306e\u5834\u5408\u306f\u81ea\u52d5\u3067\u306f\u4f5c\u3089\u308c\u306a\u3044\u306e\u3067\u3001\u3042\u3089\u304b\u3058\u3081 create table \u3057\u3066\u304a\u304b\u306a\u3044\u3068\u3044\u3051\u306a\u3044\u3002embulk-output-bigquery \u3067\u306f `auto_create_table`\u30aa\u30d7\u30b7\u30e7\u30f3\u304c\u6709\u52b9\u306a\u5834\u5408\u306f\u3001\u81ea\u52d5\u3067\u4f5c\u308b\u3088\u3046\u306b\u3057\u3066\u304a\u3044\u305f\u3002\n\n## Partitioned Table \u3078\u306e load\n\n\u3053\u3061\u3089\u3082 [Jobs: insert](https://cloud.google.com/bigquery/docs/reference/v2/jobs) API\u3092\u4f7f\u3063\u3066\u3001load \u3059\u308b\u969b\u306b `table` \u306b\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u30c7\u30b3\u30ec\u30fc\u30bf(`$YYYYMMDD`)\u3092\u6307\u5b9a\u3059\u308c\u3070\u3088\u3044\u3002\n\n```json\n{\n  \"configuration\": {\n    \"load\": {\n      \"destinationTable\": {\n        \"tableId\": \"table$20160929\"\n      },\n      \"writeDisposition\": \"WRITE_TRUNCATE\"\n    }\n  }\n}\n```\n\n`write_disposition: 'WRITE_TRUNCATE'` \u3068\u3059\u308c\u3070\u3001\u6307\u5b9a\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u3092 atomic \u306b\u7f6e\u304d\u63db\u3048\u3067\u304d\u308b\u3002\n\n## Drop Partition\n\n~~\u306a\u3044\u3002load job \u3067\u7a7a\u30c7\u30fc\u30bf\u3092 `write_disposition: 'WRITE_TRUNCATE'` \u3068\u3057\u3066\u53d6\u308a\u8fbc\u3081\u3070\u3001\u6307\u5b9a\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u306e\u30c7\u30fc\u30bf\u306f\u6d88\u305b\u305d\u3046\u3002~~\n\n[Tables: delete](https://cloud.google.com/bigquery/docs/reference/rest/v2/tables/delete) API \u3067 partition decorator \u3092\u6307\u5b9a\u3059\u308c\u3070 partition \u3060\u3051\u6d88\u305b\u308b\n\n## Partitioned Table \u3078\u306e\u5909\u63db\n\nbq \u30b3\u30de\u30f3\u30c9\u3067\u3067\u304d\u308b\u3002See https://cloud.google.com/bigquery/docs/creating-partitioned-tables\n\n```\nbq partition mydataset.sharded_ mydataset.partitioned\n```\n\n\u5185\u90e8\u7684\u306b\u306f table \u4e00\u89a7\u3092\u53d6\u3063\u3066\u3001copy job \u3067\u65e5\u4ed8 suffix \u3068\u5bfe\u5fdc\u3059\u308b\u65e5\u4ed8 partition \u306b\u30c7\u30fc\u30bf\u3092\u30b3\u30d4\u30fc\u3057\u3066\u3044\u308b\u3002\n\n## \u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u4e00\u89a7\u304a\u3088\u3073\u4f5c\u6210\u3001\u66f4\u65b0\u6642\u9593\u306e\u53d6\u5f97\n\n**Legacy SQL** \u3067\n\n```sql\nSELECT partition_id,creation_time,last_modified_time from [mydataset.table1$__PARTITIONS_SUMMARY__];\n```\n\n![image](https://qiita-image-store.s3.amazonaws.com/0/9641/6baf00ea-5ae8-0684-cc89-18303b8b3a60.png)\n\nHint: TIMESTAMP\u578b\u306b\u5909\u66f4\u3057\u305f\u3051\u308c\u3070 `MSEC_TO_TIMESTAMP(creation_time)` \u306e\u3088\u3046\u306b\u3059\u308c\u3070\u3088\u3044\n\n## \u30af\u30a8\u30ea\u5bfe\u8c61\u306e\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u3092\u7d5e\u308b\n\nSee https://cloud.google.com/bigquery/docs/querying-partitioned-tables\n\n`_PARTITIONTIME`\u7591\u4f3c\u30ab\u30e9\u30e0\u306b\u5bfe\u3057\u3066WHERE\u6761\u4ef6\u3092\u66f8\u304f\n\n```sql\nSELECT\n  field1\nFROM\n  table2\nWHERE\n  _PARTITIONTIME BETWEEN TIMESTAMP('2016-01-01')\n  AND TIMESTAMP('2016-01-21');\n```\n\nTABLE_DATE_RANGE\u306b\u3088\u308b\u30c6\u30fc\u30d6\u30eb\u691c\u7d22(\u3051\u3063\u3053\u3046\u9045\u3044)\u306e\u6642\u9593\u304c\u304b\u304b\u3089\u306a\u304f\u306a\u308b\u305f\u3081\u3001\u7d50\u679c\u304c\u8fd4\u3063\u3066\u304f\u308b\u306e\u304c\u901f\u304f\u306a\u308b\u3088\u3046\u3060\u3002\n\n\u8ffd\u8a18: custom quota \u6b8b\u91cf\u306b\u3064\u3044\u3066\n\n`_PARTITIONTIME` \u3067\u7d5e\u308a\u8fbc\u3093\u3060\u5834\u5408\u3067\u3082\u3001\u30c6\u30fc\u30d6\u30eb\u5168\u4f53\u306e\u5bb9\u91cf\u304c custom quota \u304b\u3089\u5dee\u3057\u5f15\u304b\u308c\u308b\u3002\u4f8b\u3048\u3070\u3001\u30c6\u30fc\u30d6\u30eb\u306e\u5bb9\u91cf\u304c1TB\u3067\u3001\u7d5e\u308a\u8fbc\u3093\u3060\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u304c100GB\u3067\u3082\u30011TB\u5dee\u3057\u5f15\u304b\u308c\u3066\u3057\u307e\u3046\u3002 ref. https://cloud.google.com/bigquery/cost-controls \"it currently ignores any _PARTITIONTIME or _TABLE_SUFFIX filters in the query\"\n\n\u3053\u308c\u3092\u9632\u3050\u306b\u306f\u3001`table_name$YYYYMMDD` \u306e\u3088\u3046\u306b partition decorator \u3067\u7279\u5b9a\u306e\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u3092\u6307\u5b9a\u3057\u3066\u30b9\u30ad\u30e3\u30f3\u3059\u308b\u3002\u3053\u306e\u5834\u5408\u306f\u3001\u305d\u306e\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u306e\u30c7\u30fc\u30bf\u91cf\u3060\u3051quota\u6b8b\u91cf\u304c\u6e1b\u308b\uff08\u30c6\u30fc\u30d6\u30eb\u5168\u4f53\u306e\u30b9\u30ad\u30e3\u30f3\u91cf\u3067\u306f\u306a\u304f\uff09\u3002\u305f\u3060\u3057\u3001Legacy SQL \u3067\u3057\u304b\u3053\u306e\u624b\u6cd5\u306f\u4f7f\u3048\u305a\u3001Standard SQL \u3067\u306f\u30a8\u30e9\u30fc\u3068\u306a\u308b\u3002ref. http://stackoverflow.com/questions/40638564/is-it-possible-to-access-a-bigquery-partition-in-standard-sql-using-the-deco\n\n## Partitioned Table \u3078\u306e DML (update, delete, insert)\n\ncf. https://cloud.google.com/bigquery/docs/reference/standard-sql/data-manipulation-language\n\n> DML statements that modify partitioned tables are not yet supported.\n\n\u3068\u306e\u3053\u3068\u3067\u307e\u3060\u5229\u7528\u3067\u304d\u306a\u3044(2017/03/09\u8abf\u3079)\n"}