{"context": "\n\n1. \u306f\u3058\u3081\u306b\n\u4eca\u56de\u306f\u3001VyOS\u3092\u4f7f\u3063\u3066Internet-VPN LAN\u9593\u63a5\u7d9a\u3092\u884c\u3044\u307e\u3059\u3002\u4f7f\u7528\u3059\u308b\u30d7\u30ed\u30c8\u30b3\u30eb\u306f\u3001\u3088\u304f\u5229\u7528\u3055\u308c\u3066\u3044\u308bIPsec\u3067\u3059\u3002\n\n2. IPSec\u306b\u3064\u3044\u3066\n\n2-1. VPN\u306e\u7a2e\u985e\nVPN\u306f\u3001\u30c8\u30f3\u30cd\u30ea\u30f3\u30b0\u30fb\u6697\u53f7\u5316\u306e\u6a5f\u80fd\u3067\u69cb\u6210\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n\u30c8\u30f3\u30cd\u30ea\u30f3\u30b0\u30d7\u30ed\u30c8\u30b3\u30eb\u306e\u7a2e\u985e\u306f\u3001PPTP, L2F, L2TP, GRE, IPsec \u304c\u3042\u308a\u3001\n\u6697\u53f7\u5316\u30d7\u30ed\u30c8\u30b3\u30eb\u306f\u3001IPsec\u3067\u3059\u3002\n\u3053\u306e2\u3064\u3092\u7d44\u307f\u5408\u308f\u305b\u3066\u3001VPN\u901a\u4fe1\u3092\u884c\u3063\u3066\u3044\u307e\u3059\u3002\n\u30c8\u30f3\u30cd\u30ea\u30f3\u30b0\u3092IPsec\u3001\u6697\u53f7\u5316\u3092IPsec\u3067\u884c\u3048\u3070\u3001IPsec\u3060\u3051\u3067\u5b8c\u7d50\u3059\u308b\u3068\u601d\u308f\u308c\u307e\u3059\u304c\u3001IPsec\u3067\u3067\u304d\u306a\u3044\u3068\u3053\u308d\u3092\u5225\u306e\u30c8\u30f3\u30cd\u30ea\u30f3\u30b0\u30d7\u30ed\u30c8\u30b3\u30eb\u3067\u30ab\u30d0\u30fc\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\u4f8b\u3048\u3070\u3001IPsec\u3067\u306f\u3067\u304d\u306a\u3044\u30de\u30eb\u30c1\u30ad\u30e3\u30b9\u30c8\u74b0\u5883\u306e\u5834\u5408\u3001\u30c8\u30f3\u30cd\u30ea\u30f3\u30b0\u3092GRE\u3001\u6697\u53f7\u5316\u3092IPsec\u306e\u7d44\u307f\u5408\u308f\u305b\u3067\u901a\u4fe1\u8a2d\u5b9a\u3092\u884c\u3044\u307e\u3059\u3002(GRE over IPsec)\n\n2-2. IPSec\u306e\u69cb\u6210\n\n2-2-1. IPSec\u306e\u30d7\u30ed\u30c8\u30b3\u30eb\nIPsec\u306fAH, ESP, IKE\u7b49\u306e\u30d7\u30ed\u30c8\u30b3\u30eb\u304b\u3089\u69cb\u6210\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n \u305f\u3060\u3001ESP\u306b\u306fAH\u306e\u6a5f\u80fd\u3067\u3042\u308b\u201d\u6539\u3056\u3093\u9632\u6b62\u201d\u6a5f\u80fd\u304c\u542b\u307e\u308c\u3066\u3044\u308b\u306e\u3067\u3001AH\u3092\u4f7f\u7528\u305b\u305a\u3001ESP\u3068IKE\u306e\u307f\u3067\u69cb\u6210\u3057\u307e\u3059\u3002\n\u30fbAH(Authentication Header)\n\u3000\u3000\u3000\u30d1\u30b1\u30c3\u30c8\u6539\u3056\u3093\u9632\u6b62\u306e\u305f\u3081\u306e\u8a8d\u8a3c\n\u30fbESP(Encapsulated Security Payload)\n\u3000\u3000\u3000\u30d1\u30b1\u30c3\u30c8\u6539\u3056\u3093\u9632\u6b62\u306e\u305f\u3081\u306e\u8a8d\u8a3c\n\u3000\u3000\u3000\u30da\u30fc\u30ed\u30fc\u30eb\u90e8\u5206(\u30e6\u30fc\u30b6\u30fc\u30c7\u30fc\u30bf)\u306e\u6697\u53f7\u5316\n\u30fbIKE(Internet Key Exchange)\n \u3000\u3000\u3000\u9375\u306e\u4ea4\u63db\u3092\u5b89\u5168\u306b\u884c\u3046\n\n2-2-2. IPSec\u306e\u901a\u4fe1\u30e2\u30fc\u30c9\n\u307b\u3068\u3093\u3069\u306e\u69cb\u6210\u306f\u3001\u30db\u30b9\u30c8\u305d\u308c\u305e\u308c\u306b\u8a2d\u5b9a\u3059\u308b\u5fc5\u8981\u306e\u306a\u3044\u30c8\u30f3\u30cd\u30eb\u30e2\u30fc\u30c9\u304c\u4f7f\u308f\u308c\u308b\u3002\n\u30fb\u30c8\u30e9\u30f3\u30b9\u30dd\u30fc\u30c8\u30e2\u30fc\u30c9 ---- \u30db\u30b9\u30c8\u9593\u3067\u306eIPsec-VPN\n\u30fb\u30c8\u30f3\u30cd\u30eb\u30e2\u30fc\u30c9 ---- VPN\u30b2\u30fc\u30c8\u30a6\u30a7\u30a4\u9593\u3067\u306eIPsec-VPN\n\n2-2-3. VPN\u30b2\u30fc\u30c8\u30a6\u30a7\u30a4\u9593\u3067\u306e\u30b3\u30cd\u30af\u30b7\u30e7\u30f3\nVPN\u30b2\u30fc\u30c8\u30a6\u30a7\u30a4\u9593\u306e\u63a5\u7d9a(\u30b3\u30cd\u30af\u30b7\u30e7\u30f3)\u3092SA\uff08Security Association)\u3068\u3044\u3044\u3001\u7247\u65b9\u901a\u884c\u306e\u30c8\u30f3\u30cd\u30eb\u3067\u9001\u7528\u3068\u53d7\u4fe1\u7528\u306eSA\u304c\u306e\u5408\u8a082\u3064\u4f5c\u3089\u308c\u307e\u3059\u3002\nSA\u306e\u4e2d\u8eab\u306fIPsec\u306e\u30d1\u30e9\u30e1\u30fc\u30bf\u3067\u3059\u3002\n\u30d1\u30e9\u30e1\u30fc\u30bf\u3068\u3057\u3066\u306f\u3001\u30d7\u30ed\u30c8\u30b3\u30eb\u3001IPsec\u901a\u4fe1\u30e2\u30fc\u30c9\u3001\u6697\u53f7\u5316\u65b9\u5f0f\u3001\u305d\u306e\u6697\u53f7\u9375\n\u8a8d\u8a3c\u3001\u8a8d\u8a3c\u9375\u306a\u3069\u304c\u3042\u308a\u307e\u3059\u3002\n \u3000SA\u306f\u3001IKE(\u9375\u4ea4\u63db\u30d7\u30ed\u30c8\u30b3\u30eb)\u3092\u4f7f\u7528\u3057\u3066\u751f\u6210\u3057\u307e\u3059\u3002\n\u751f\u6210\u306f\u30d5\u30a7\u30fc\u30ba1\u3068\u30d5\u30a7\u30fc\u30ba2\u306e\u30b9\u30c6\u30c3\u30d7\u304c\u3042\u308a\u307e\u3059\u3002\n\u30fbIKE\u30d5\u30a7\u30fc\u30ba1\uff1a\u5404\u7a2e\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u4ea4\u63db\u3057ISAKMP SA\u3092\u751f\u6210\u3002\n\u30fbIKE\u30d5\u30a7\u30fc\u30ba2\uff1aISAKMP SA\u4e0a\u3067\u5404\u7a2e\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u4ea4\u63db\u3057\u3066IPsec SA\u3092\u751f\u6210\u3002\n\n3. \u69cb\u6210\u306b\u3064\u3044\u3066\n\u3000SoftLayer\u306e\u6771\u4eac\u30ed\u30b1\u30fc\u30b7\u30e7\u30f3\u3068\u30b7\u30f3\u30ac\u30dd\u30fc\u30eb\u30ed\u30b1\u30fc\u30b7\u30e7\u30f3\u305d\u308c\u305e\u308c\u306bVyOS(IPsec\u7528)\u3068Windows2012R2\u3092\u69cb\u7bc9\u3057\u3001Windows\u306e\u30ea\u30e2\u30fc\u30c8\u30c7\u30b9\u30af\u30c8\u30c3\u30d7\u3067\u63a5\u7d9a\u78ba\u8a8d\u3092\u884c\u3044\u307e\u3059\u3002\n\n\n\n4. \u69cb\u7bc9\u624b\u9806\n\n\n5. \u69cb\u7bc9\n\n5-1. \u2460VLAN\u30b9\u30d1\u30cb\u30f3\u30b0\u3092OFF\nSoftLayer\u306e\u30dd\u30fc\u30bf\u30eb\u3067\u64cd\u4f5c\u3057\u307e\u3059\u3002\n\u300c\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u300d\u21d2\u300cIP\u7ba1\u7406\u300d\u21d2\u300cVLAN\u300d\n\n\u300c\u30b9\u30d1\u30f3\u300d \u3092\u30af\u30ea\u30c3\u30af\u3002\n\n\u300c\u30aa\u30d5\u300d \u3092\u30c1\u30a7\u30c3\u30af\u3002\n\u3053\u308c\u3067\u3001\u30b9\u30d1\u30f3\u30cb\u30f3\u30b0\u304c\u30aa\u30d5\u306b\u306a\u308a\u307e\u3057\u305f\u3002\n\u203b\u30c6\u30b9\u30c8\u7d42\u308f\u308a\u307e\u3057\u305f\u3089\u3001ON\u306b\u623b\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n5-2. \u2461 vyos-TOK(VyOS)\u306e\u57fa\u672c\u8a2d\u5b9a\nVyOS\u306e\u5c0e\u5165\u306f\u7701\u7565\u3057\u307e\u3059\u3002\n\n(\u53c2\u8003\u60c5\u5831)\u30fbVyOS\u5c0e\u5165\n \u300cSoftLayer\u4eee\u60f3\u30b5\u30fc\u30d0\u306bVyOS\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u307e\u3057\u305f\u300d\nhttp://qiita.com/Mitsu-Murakita/items/d793250566a8e9f3562b >\n\n(1) IP Address(Private\u3068Public)\n (2) SSH\n (3) Gateway Address\n (4) DNS\n (5) Domain Name\n (6) Host Name\n (7) Static route\n (8) Time Server\n (9) Time Zone\n \u3092\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\u203b\u8aac\u660e\u3057\u3084\u3059\u3044\u3088\u3046\u306b\u884c\u756a\u53f7(xxx)\u3092\u3064\u3051\u3066\u307e\u3059\u304c\u3001\u5b9f\u969b\u306b\u767b\u9332\u3059\u308b\u969b\u306f\u884c\u756a\u53f7\u3092\u5165\u529b\u3057\u306a\u3044\u3067\u304f\u3060\u3055\u3044\u3002\n\nvyos-TOK\u57fa\u672c\u8a2d\u5b9a\n(001)  interfaces {\n(002)      ethernet eth0 {\n(003)          address 10.132.52.225/26\n(004)          duplex auto\n(005)          hw-id 06:65:fa:44:1c:fb\n(006)          smp_affinity auto\n(007)          speed auto\n(008)      }\n(009)      ethernet eth1 {\n(010)          address 161.202.236.157/29\n(011)          duplex auto\n(012)          hw-id 06:b1:22:00:62:82\n(013)          smp_affinity auto\n(014)          speed auto\n(015)      }\n(016)      loopback lo {\n(017)      }\n(018)  }\n(019)  protocols {\n(020)      static {\n(021)          route 10.0.0.0/8 {\n(022)              next-hop 10.132.52.193 {\n(023)              }\n(024)          }\n(025)      }\n(026)  }\n(027)  service {\n(028)      ssh {\n(029)          port 22\n(030)      }\n(031)  }\n(032)  system {\n(033)      config-management {\n(034)          commit-revisions 20\n(035)      }\n(036)      console {\n(037)          device hvc0 {\n(038)              speed 9600\n(039)          }\n(040)          device ttyS0 {\n(041)              speed 9600\n(042)          }\n(043)      }\n(044)      domain-name softlayer.com\n(045)      gateway-address 161.202.236.153\n(046)      host-name vyos-TOK\n(047)      login {\n(048)          user vyos {\n(049)              authentication {\n(050)                  encrypted-password xxxxxxxxxxxxxxxxxxxxx\n(051)                  plaintext-password \"\"\n(052)              }\n(053)              level admin\n(054)          }\n(055)      }\n(056)      name-server 10.0.80.11\n(057)      name-server 10.0.80.12\n(058)      ntp {\n(059)          server time.service.networklayer.com {\n(060)          }\n(061)      }\n(062)      package {\n(063)          auto-sync 1\n(064)          repository community {\n(065)              components main\n(066)              distribution helium\n(067)              password \"\"\n(068)              url http://packages.vyos.net/vyos\n(069)              username \"\"\n(070)          }\n(071)      }\n(072)      syslog {\n(073)          global {\n(074)              facility all {\n(075)                  level notice\n(076)              }\n(077)              facility protocols {\n(078)                  level debug\n(079)              }\n(080)          }\n(081)      }\n(082)      time-zone Asia/Tokyo\n(083)  }\n\n\n\u25c6 (001)-(018) IP\u30a2\u30c9\u30ec\u30b9\u95a2\u9023\u306e\u8a2d\u5b9a\n \u30d7\u30e9\u30a4\u30d9\u30fc\u30c8\u30a2\u30c9\u30ec\u30b9\uff1aaddress 10.132.52.225/26\n \u30d1\u30d6\u30ea\u30c3\u30af\u30a2\u30c9\u30ec\u30b9\uff1aaddress 161.202.236.157/29\n eth0\u3068eth1\uff1aduplex auto\u3001smp_affinity auto\u3001speed auto\u3000\u3092\u8a2d\u5b9a\n\u25c6 (019)-(026) Static route\u306e\u8a2d\u5b9a\n\u30d7\u30e9\u30a4\u30d9\u30fc\u30c8\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u306e\u30b2\u30fc\u30c8\u30a6\u30a7\u30a410.132.52.193\u3092\u8a2d\u5b9a\n\u25c6 (027)-(031) SSH\u306e\u8a2d\u5b9a\n\u30dd\u30fc\u30c822\u3092\u8a2d\u5b9a\n\u25c6 (044)-(044) \u30c9\u30e1\u30a4\u30f3\u540d\u306e\u8a2d\u5b9a\n softlayer.com\u3092\u8a2d\u5b9a\n\u25c6 (045)-(045) Gateway Address\u306e\u8a2d\u5b9a\n\u30d1\u30d6\u30ea\u30c3\u30af\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u306e\u30b2\u30fc\u30c8\u30a6\u30a7\u30a4161.202.236.153\u3092\u8a2d\u5b9a\n\u25c6 (046)-(046) \u30db\u30b9\u30c8\u540d\u306e\u8a2d\u5b9a\n  \u30db\u30b9\u30c8\u540dvyos-TOK\u3092\u8a2d\u5b9a\n\u25c6 (056)-(057) DNS\u306e\u8a2d\u5b9a\n SoftLayer\u306eDNS 10.0.80.11\u300110.0.80.12\u3092\u8a2d\u5b9a\n\u25c6 (058)-(061) \u30bf\u30a4\u30e0\u30b5\u30fc\u30d0\u30fc\u306e\u8a2d\u5b9a\n SoftLayer\u306e\u30bf\u30a4\u30e0\u30b5\u30fc\u30d0\u30fctime.service.networklayer.com\u3092\u8a2d\u5b9a\n\u25c6 (081)-(083) \u30bf\u30a4\u30e0\u30be\u30fc\u30f3\u306e\u8a2d\u5b9a \n Asia/Tokyo\u3092\u8a2d\u5b9a\n\n5-3. \u2462 vyos-SNG(VyOS)\u306e\u57fa\u672c\u8a2d\u5b9a\nvyos-TOK01\u3068\u540c\u3058\u624b\u9806\u3067\u8a2d\u5b9a\u3057\u307e\u3059\u3002\u57fa\u672c\u8a2d\u5b9a\u3068\u9055\u3046\u7b87\u6240\u306f\u3001\n(003) address 10.132.52.225/26\n(005) hw-id 06:65:fa:44:1c:fb\n(010) address 161.202.236.157/29\n(012) hw-id 06:b1:22:00:62:82\n(022) next-hop 10.132.52.193 {\n(045) gateway-address 161.202.236.153\n(046) host-name vyos-TOK\n\u3067\u3059\u3002\u5c1a\u3001hw-id\u306f\u81ea\u52d5\u3067\u8a2d\u5b9a\u3055\u308c\u3066\u3044\u308b\u306f\u305a\u3067\u3059\u306e\u3067\u3001\u5b9f\u969b\u5909\u66f4\u3059\u308b\u306e\u306f\n(003-SNG) address 10.116.128.215/26\n(010-SNG) address 161.202.1.244/29\n(022-SNG) next-hop 10.116.128.193\n(045-SNG) gateway-address 161.202.1.241\n(046-SNG) host-name vyos-SNG\n\u3067\u3059\u3002\n\nvyos-SNG\u57fa\u672c\u8a2d\u5b9a\n(001-SNG)  interfaces {\n(002-SNG)      ethernet eth0 {\n(003-SNG)          address 10.116.128.215/26\n(004-SNG)          duplex auto\n(005-SNG)          hw-id 06:a7:8c:9d:4e:da\n(006-SNG)          smp_affinity auto\n(007-SNG)          speed auto\n(008-SNG)      }\n(009-SNG)      ethernet eth1 {\n(010-SNG)          address 161.202.1.244/29\n(011-SNG)          duplex auto\n(012-SNG)          hw-id 06:17:fe:9b:9b:3e\n(013-SNG)          smp_affinity auto\n(014-SNG)          speed auto\n(015-SNG)      }\n(016-SNG)      loopback lo {\n(017-SNG)      }\n(018-SNG)  }\n(019-SNG)  protocols {\n(020-SNG)      static {\n(021-SNG)          route 10.0.0.0/8 {\n(022-SNG)              next-hop 10.116.128.193 {\n(023-SNG)              }\n(024-SNG)          }\n(025-SNG)      }\n(026-SNG)  }\n(027-SNG)  service {\n(028-SNG)      ssh {\n(029-SNG)          port 22\n(030-SNG)      }\n(031-SNG)  }\n(032-SNG)  system {\n(033-SNG)      config-management {\n(034-SNG)          commit-revisions 20\n(035-SNG)      }\n(036-SNG)      console {\n(037-SNG)          device hvc0 {\n(038-SNG)              speed 9600\n(039-SNG)          }\n(040-SNG)          device ttyS0 {\n(041-SNG)              speed 9600\n(042-SNG)          }\n(043-SNG)      }\n(044-SNG)      domain-name softlayer.com\n(045-SNG)      gateway-address 161.202.1.241\n(046-SNG)      host-name vyos-SNG\n(047-SNG)      login {\n(048-SNG)          user vyos {\n(049-SNG)              authentication {\n(050-SNG)                  encrypted-password xxxxxxxxxxxxxxxxxxx\n(051-SNG)                  plaintext-password \"\"\n(052-SNG)              }\n(053-SNG)              level admin\n(054-SNG)          }\n(055-SNG)      }\n(056-SNG)      name-server 10.0.80.11\n(057-SNG)      name-server 10.0.80.12\n(058-SNG)      ntp {\n(059-SNG)          server time.service.networklayer.com {\n(060-SNG)          }\n(061-SNG)      }\n(062-SNG)      package {\n(063-SNG)          auto-sync 1\n(064-SNG)          repository community {\n(065-SNG)              components main\n(066-SNG)              distribution helium\n(067-SNG)              password \"\"\n(068-SNG)              url http://packages.vyos.net/vyos\n(069-SNG)              username \"\"\n(070-SNG)          }\n(071-SNG)      }\n(072-SNG)      syslog {\n(073-SNG)          global {\n(074-SNG)              facility all {\n(075-SNG)                  level notice\n(076-SNG)              }\n(077-SNG)              facility protocols {\n(078-SNG)                  level debug\n(079-SNG)              }\n(080-SNG)          }\n(081-SNG)      }\n(082-SNG)      time-zone Asia/Tokyo\n(083-SNG)  }\n\n\n\n5-4. \u2463 vyos-TOK(VyOS)\u306eIPsec\u8a2d\u5b9a\nIPsec\u63a5\u7d9a\u306b\u6700\u4f4e\u9650\u5fc5\u8981\u306a\u8a2d\u5b9a\u3092\u884c\u3044\u307e\u3059\u3002\n\u5c1a\u3001\u672a\u8a2d\u5b9a\u306e\u5024\u306b\u306f\u30c7\u30d5\u30a9\u30eb\u30c8\u5024\u304c\u4f7f\u7528\u3055\u308c\u307e\u3059\u3002\n\uff08\uff11\uff09\u30d1\u30d6\u30ea\u30c3\u30af\u30a4\u30f3\u30bf\u30fc\u30d5\u30a7\u30fc\u30b9eth1\u306eIPsecVPN\u6709\u52b9\u5316\n\uff08\uff12\uff09IKE\u3067\u5229\u7528\u3059\u308b\u6697\u53f7\u5316\u7528\u306e\u6697\u53f7\u5316\u30a2\u30eb\u30b4\u30ea\u30ba\u30e0\u3068\u8a8d\u8a3c\u7528\u30cf\u30c3\u30b7\u30e5\u30a2\u30eb\u30b4\u30ea\u30ba\u30e0\u306e\u5b9a\u7fa9\n\uff08\uff13\uff09ESP\u3067\u5229\u7528\u3059\u308b\u6697\u53f7\u5316\u7528\u306e\u6697\u53f7\u5316\u30a2\u30eb\u30b4\u30ea\u30ba\u30e0\u3068\u8a8d\u8a3c\u7528\u30cf\u30c3\u30b7\u30e5\u30a2\u30eb\u30b4\u30ea\u30ba\u30e0\u306e\u5b9a\u7fa9\n\uff08\uff14\uff09vyos-SNG\u3078\u306e\u63a5\u7d9a\u8a2d\u5b9a\n\n5-4-1. \uff08\uff11\uff09\u30d1\u30d6\u30ea\u30c3\u30af\u30a4\u30f3\u30bf\u30fc\u30d5\u30a7\u30fc\u30b9eth1\u306eIPsecVPN\u6709\u52b9\u5316\n\neth1\u306eIPsecVPN\u6709\u52b9\u5316\nset vpn ipsec ipsec-interface interface eth1\n\n\nIPsecVPN\u901a\u4fe1\u306b\u30d1\u30d6\u30ea\u30c3\u30af\u30a4\u30f3\u30bf\u30fc\u30d5\u30a7\u30fc\u30b9eth1\u306e\u3092\u4f7f\u7528\u3057\u307e\u3059\u3002\n\n5-4-2. \uff08\uff12\uff09IKE\u3067\u5229\u7528\u3059\u308b\u6697\u53f7\u5316\u7528\u306e\u6697\u53f7\u5316\u30a2\u30eb\u30b4\u30ea\u30ba\u30e0\u3068\u8a8d\u8a3c\u7528\u30cf\u30c3\u30b7\u30e5\u30a2\u30eb\u30b4\u30ea\u30ba\u30e0\u306e\u5b9a\u7fa9\n\nIKE\u306e\u8a2d\u5b9a\nset vpn ipsec ike-group IKE-TOK\nset vpn ipsec ike-group IKE-TOK proposal 1 encryption aes256\nset vpn ipsec ike-group IKE-TOK proposal 1 hash sha1\nset vpn ipsec ike-group IKE-TOK lifetime 3600\n\n\n\u6697\u53f7\u5316\u30a2\u30eb\u30b4\u30ea\u30ba\u30e0\u3084\u8a8d\u8a3c\u30a2\u30eb\u30b4\u30ea\u30ba\u30e0\u3092\u53cc\u65b9\u3067\u30cd\u30b4\u30b7\u30a8\u30fc\u30b7\u30e7\u30f3\u3059\u308b\u305f\u3081\u306b\u3001\u8907\u6570\u306e\u7d44\u307f\u5408\u308f\u305b\u3092\u5b9a\u7fa9\u3067\u304d\u307e\u3059\u304c\u3001\u3053\u3053\u3067\u306f\uff11\u3064(proposal 1)\u3060\u3051\u5b9a\u7fa9\u3057\u3066\u3044\u307e\u3059\u3002\n\u6697\u53f7\u5316\u3092AES256\u3001\u30cf\u30c3\u30b7\u30e5\u3092SHA1\u3068\u3057\u3001\u30e9\u30a4\u30d5\u30bf\u30a4\u30e0\u30923600\u3068\u3057\u307e\u3057\u305f\u3002\n\n5-4-3. \uff08\uff13\uff09ESP\u3067\u5229\u7528\u3059\u308b\u6697\u53f7\u5316\u7528\u306e\u6697\u53f7\u5316\u30a2\u30eb\u30b4\u30ea\u30ba\u30e0\u3068\u8a8d\u8a3c\u7528\u30cf\u30c3\u30b7\u30e5\u30a2\u30eb\u30b4\u30ea\u30ba\u30e0\u306e\u5b9a\u7fa9\n\nESP\u306e\u8a2d\u5b9a\nset vpn ipsec esp-group ESP-TOK\nset vpn ipsec esp-group ESP-TOK proposal 1 encryption aes256\nset vpn ipsec esp-group ESP-TOK proposal 1 hash sha1\nset vpn ipsec esp-group ESP-TOK lifetime 1800\n\n\n\u6697\u53f7\u5316\u30a2\u30eb\u30b4\u30ea\u30ba\u30e0\u3084\u8a8d\u8a3c\u30a2\u30eb\u30b4\u30ea\u30ba\u30e0\u3092\u53cc\u65b9\u3067\u30cd\u30b4\u30b7\u30a8\u30fc\u30b7\u30e7\u30f3\u3059\u308b\u305f\u3081\u306b\u3001\u8907\u6570\u306e\u7d44\u307f\u5408\u308f\u305b\u3092\u5b9a\u7fa9\u3067\u304d\u307e\u3059\u304c\u3001\u3053\u3053\u3067\u306f\uff11\u3064(proposal 1)\u3060\u3051\u5b9a\u7fa9\u3057\u3066\u3044\u307e\u3059\u3002\n\u6697\u53f7\u5316\u3092AES256\u3001\u30cf\u30c3\u30b7\u30e5\u3092SHA1\u3068\u3057\u3001\u30e9\u30a4\u30d5\u30bf\u30a4\u30e0\u30921800\u3068\u3057\u307e\u3057\u305f\u3002\n\n5-4-4. \uff08\uff14\uff09vyos-SNG\u3078\u306e\u63a5\u7d9a\u8a2d\u5b9a\n\nvyos-SNG\u3078\u306e\u63a5\u7d9a\u8a2d\u5b9a\nset vpn ipsec site-to-site peer 161.202.1.244\nset vpn ipsec site-to-site peer 161.202.1.244 authentication mode pre-shared-secret\nset vpn ipsec site-to-site peer 161.202.1.244 authentication pre-shared-secret test_key_1\nset vpn ipsec site-to-site peer 161.202.1.244 default-esp-group ESP-TOK\nset vpn ipsec site-to-site peer 161.202.1.244 ike-group IKE-TOK\nset vpn ipsec site-to-site peer 161.202.1.244 local-address 161.202.236.157\nset vpn ipsec site-to-site peer 161.202.1.244 tunnel 1 local prefix 10.132.52.192/26\nset vpn ipsec site-to-site peer 161.202.1.244 tunnel 1 remote prefix 10.116.128.192/26\n\n\nIKE\u30d5\u30a7\u30fc\u30ba1\u3067\u306evyos-SNG\u3068\u306e\u8a8d\u8a3c\u65b9\u5f0f\u3092\u300cPre-Shared Key\u300d\u3068\u3057\u3001\u30ad\u30fc\u3092\u201dtest_key_1\u201d\u3068\u3057\u307e\u3057\u305f\u3002\n\n5-4-5. vyos-TOK(VyOS)\u306e\u5168\u8a2d\u5b9a\n\nvyos-TOK\u306e\u5168\u8a2d\u5b9a\n interfaces {\n     ethernet eth0 {\n         address 10.132.52.225/26\n         duplex auto\n         hw-id 06:65:fa:44:1c:fb\n         smp_affinity auto\n         speed auto\n     }\n     ethernet eth1 {\n         address 161.202.236.157/29\n         duplex auto\n         hw-id 06:b1:22:00:62:82\n         smp_affinity auto\n         speed auto\n     }\n     loopback lo {\n     }\n }\n protocols {\n     static {\n         route 10.0.0.0/8 {\n             next-hop 10.132.52.193 {\n             }\n         }\n     }\n }\n service {\n     ssh {\n         port 22\n     }\n }\n system {\n     config-management {\n         commit-revisions 20\n     }\n     console {\n         device hvc0 {\n             speed 9600\n         }\n         device ttyS0 {\n             speed 9600\n         }\n     }\n     domain-name softlayer.com\n     gateway-address 161.202.236.153\n     host-name vyos-TOK\n     login {\n         user vyos {\n             authentication {\n                 encrypted-password xxxxxxxxxxxxxxxxxx\n                 plaintext-password \"\"\n             }\n             level admin\n         }\n     }\n     name-server 10.0.80.11\n     name-server 10.0.80.12\n     ntp {\n         server time.service.networklayer.com {\n         }\n     }\n     package {\n         auto-sync 1\n         repository community {\n             components main\n             distribution helium\n             password \"\"\n             url http://packages.vyos.net/vyos\n             username \"\"\n         }\n     }\n     syslog {\n         global {\n             facility all {\n                 level notice\n             }\n             facility protocols {\n                 level debug\n             }\n         }\n     }\n     time-zone Asia/Tokyo\n }\n vpn {\n     ipsec {\n         esp-group ESP-TOK {\n             compression disable\n             lifetime 1800\n             mode tunnel\n             pfs enable\n             proposal 1 {\n                 encryption aes256\n                 hash sha1\n             }\n         }\n         ike-group IKE-TOK {\n             ikev2-reauth no\n             key-exchange ikev1\n             lifetime 3600\n             proposal 1 {\n                 encryption aes256\n                 hash sha1\n             }\n         }\n         ipsec-interfaces {\n             interface eth1\n         }\n         site-to-site {\n             peer 161.202.1.244 {\n                 authentication {\n                     mode pre-shared-secret\n                     pre-shared-secret test_key_1\n                 }\n                 connection-type initiate\n                 default-esp-group ESP-TOK\n                 ike-group IKE-TOK\n                 ikev2-reauth inherit\n                 local-address 161.202.236.157\n                 tunnel 1 {\n                     allow-nat-networks disable\n                     allow-public-networks disable\n                     local {\n                         prefix 10.132.52.192/26\n                     }\n                     remote {\n                         prefix 10.116.128.192/26\n                     }\n                 }\n             }\n         }\n     }\n }\n\n\n\n5-5. \u2464 vyos-SNG(VyOS)\u306eIPsec\u8a2d\u5b9a\n\nvyos-SNGK\u306e\u5168\u8a2d\u5b9a\n interfaces {\n     ethernet eth0 {\n         address 10.116.128.215/26\n         duplex auto\n         hw-id 06:a7:8c:9d:4e:da\n         smp_affinity auto\n         speed auto\n     }\n     ethernet eth1 {\n         address 161.202.1.244/29\n         duplex auto\n         hw-id 06:17:fe:9b:9b:3e\n         smp_affinity auto\n         speed auto\n     }\n     loopback lo {\n     }\n }\n protocols {\n     static {\n         route 10.0.0.0/8 {\n             next-hop 10.116.128.193 {\n             }\n         }\n     }\n }\n service {\n     ssh {\n         port 22\n     }\n }\n system {\n     config-management {\n         commit-revisions 20\n     }\n     console {\n         device hvc0 {\n             speed 9600\n         }\n         device ttyS0 {\n             speed 9600\n         }\n     }\n     domain-name softlayer.com\n     gateway-address 161.202.1.241\n     host-name vyos-SNG\n     login {\n         user vyos {\n             authentication {\n                 encrypted-password xxxxxxxxxxxxxxxxxxxxx\n                 plaintext-password \"\"\n             }\n             level admin\n         }\n     }\n     name-server 10.0.80.11\n     name-server 10.0.80.12\n     ntp {\n         server time.service.networklayer.com {\n         }\n     }\n     package {\n         auto-sync 1\n         repository community {\n             components main\n             distribution helium\n             password \"\"\n             url http://packages.vyos.net/vyos\n             username \"\"\n         }\n     }\n     syslog {\n         global {\n             facility all {\n                 level notice\n             }\n             facility protocols {\n                 level debug\n             }\n         }\n     }\n     time-zone Asia/Tokyo\n }\n vpn {\n     ipsec {\n         esp-group ESP-SNG {\n             lifetime 1800\n             proposal 1 {\n                 encryption aes256\n                 hash sha1\n             }\n             proposal 2 {\n                 encryption 3des\n                 hash md5\n             }\n         }\n         ike-group IKE-SNG {\n             lifetime 3600\n             proposal 1 {\n                 encryption aes256\n                 hash sha1\n             }\n             proposal 2 {\n                 encryption aes128\n                 hash sha1\n             }\n         }\n         ipsec-interfaces {\n             interface eth1\n         }\n         site-to-site {\n             peer 161.202.236.157 {\n                 authentication {\n                     mode pre-shared-secret\n                     pre-shared-secret test_key_1\n                 }\n                 default-esp-group ESP-SNG\n                 ike-group IKE-SNG\n                 local-address 161.202.1.244\n                 tunnel 1 {\n                     local {\n                         prefix 10.116.128.192/26\n                     }\n                     remote {\n                         prefix 10.132.52.192/26\n                     }\n                 }\n             }\n         }\n     }\n }\n\n\n\n5-6. \u2465IPsec\u63a5\u7d9a\u78ba\u8a8d\nVyOS\u306eShow\u30b3\u30de\u30f3\u30c9\u3067\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\u201dshow vpn ike sa\"\n\u201dshow vpn ipsec sa\" \n\u3010vyos-TOK\u3011\n\n\u3010vyos-SNG\u3011\n\nsa\u306e\u30b9\u30c6\u30fc\u30bf\u30b9\u306f\"up\"\u3067\u3059\u306e\u3067\u3001IPsec-VPN\u306e\u901a\u4fe1\u306f\u78ba\u7acb\u3055\u308c\u3066\u3044\u308b\u306e\u304c\u78ba\u8a8d\u3067\u304d\u307e\u3057\u305f\u3002\n\n5-7. \u2466 W2012R2-TOK(Windows)\u306e\u8a2d\u5b9a\n\u30b7\u30f3\u30ac\u30dd\u30fc\u30ebDC\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u3078\u306e\u30b9\u30bf\u30c6\u30a3\u30c3\u30af\u30eb\u30fc\u30c8\u8a2d\u5b9a\n\nW2012R2-TOK\u3067\u306eStaticRoute\u8a2d\u5b9a\n> route add -p 10.116.128.192 mask 255.255.255.192 10.132.52.225\n\n\n\n5-8. \u2467 W2012R2-SNG(Windows)\u306e\u8a2d\u5b9a\n\u6771\u4eacDC\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u3078\u306e\u30b9\u30bf\u30c6\u30a3\u30c3\u30af\u30eb\u30fc\u30c8\u8a2d\u5b9a\n\nW2012R2-SNGK\u3067\u306eStaticRoute\u8a2d\u5b9a\n> route add -p 10.132.52.192 mask 255.255.255.192 10.116.128.215\n\n\n\n5-9. \u2468 Windows2012Server\u9593\u30ea\u30e2\u30fc\u30c8\u30c7\u30b9\u30af\u30c8\u30c3\u30d7\u63a5\u7d9a\u78ba\u8a8d\n\uff08\uff11\uff09W2012R2-TOK\u304b\u3089W2012R2-SNG\u3078\u30ea\u30e2\u30fc\u30c8\u30c7\u30b9\u30af\u30c8\u30c3\u30d7\u63a5\u7d9a\u3057\u307e\u3059\u3002\n\n\uff08\uff12\uff09W2012R2-SNG\u304b\u3089W2012R2-TOK\u3078\u30ea\u30e2\u30fc\u30c8\u30c7\u30b9\u30af\u30c8\u30c3\u30d7\u63a5\u7d9a\u3057\u307e\u3059\u3002\n\n\u30ea\u30e2\u30fc\u30c8\u30c7\u30b9\u30af\u30c8\u30c3\u30d7\u3067\u63a5\u7d9a\u304c\u78ba\u8a8d\u3067\u304d\u307e\u3057\u305f\u3002\n\n6. \u304a\u308f\u308a\u306b\n\u5f53\u6295\u7a3f\u306esite-to-site\u8a2d\u5b9a\u306f\u3001tunnel\u3067\u3059\u3002\n\u3082\u3057\u3001\u76f8\u624b\u5074\u306b\u8907\u6570\u306e\u30bb\u30b0\u30e1\u30f3\u30c8\u304c\u5b58\u5728\u3057\u3066\u30eb\u30fc\u30c6\u30a3\u30f3\u30b0\u3059\u308b\u5834\u5408\u3084tunnel\u3092\u8907\u6570\u305b\u3063\u3066\u3044\u3059\u308b\u5834\u5408\u306f\u3001tunnel\u8a2d\u5b9a\u3067\u306f\u306a\u304f\u3001vti (Virtual Tunnel Interface)\u3067\u8a2d\u5b9a\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\u4eca\u56de\u306fIPsec\u306e\u52c9\u5f37\u3067\u3059\u306e\u3067\u3001\u57fa\u672c\u7684\u306a\u8a2d\u5b9a\u3067\u3057\u305f\u3002\n\u4ed6\u306b\u3082\u8272\u3005\u306a\u8a2d\u5b9a\u304c\u3042\u308a\u307e\u3059\u306e\u3067\u3001\u304a\u8a66\u3057\u3060\u3055\u3044\u3002\n\nset vpn ipsec esp-group ESP-TOK mode tunnel\nset vpn ipsec esp-group ESP-TOK pfs enable\nset vpn ipsec nat-traversal enable\nset vpn ipsec site-to-site peer 161.202.1.244 connection-type initiate\nset vpn ipsec site-to-site peer 161.202.1.244 default-esp-group ESP-TOK\nset vpn ipsec site-to-site peer 161.202.1.244 tunnel 1 allow-nat-networks disable\nset vpn ipsec site-to-site peer 161.202.1.244 tunnel 1 allow-public-networks disable\nset vpn ipsec ike-group IKE-TOK dead-peer-detection action 'restart'\nset vpn ipsec ike-group IKE-TOK dead-peer-detection interval '30'\nset vpn ipsec ike-group IKE-TOK dead-peer-detection timeout '30'\nset vpn ipsec auto-update '60'\nset vpn ipsec site-to-site peer 161.202.1.244 authentication id @TOK\nset vpn ipsec site-to-site peer 161.202.1.244 authentication remote-id @SNG\n\n# 1. \u306f\u3058\u3081\u306b\n  \u4eca\u56de\u306f\u3001VyOS\u3092\u4f7f\u3063\u3066Internet-VPN LAN\u9593\u63a5\u7d9a\u3092\u884c\u3044\u307e\u3059\u3002\u4f7f\u7528\u3059\u308b\u30d7\u30ed\u30c8\u30b3\u30eb\u306f\u3001\u3088\u304f\u5229\u7528\u3055\u308c\u3066\u3044\u308bIPsec\u3067\u3059\u3002\n\n# 2. IPSec\u306b\u3064\u3044\u3066\n## 2-1. VPN\u306e\u7a2e\u985e\nVPN\u306f\u3001<font color=\"blue\"><strong>\u30c8\u30f3\u30cd\u30ea\u30f3\u30b0\u30fb\u6697\u53f7\u5316\u306e\u6a5f\u80fd</strong></font>\u3067\u69cb\u6210\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n\n\u30c8\u30f3\u30cd\u30ea\u30f3\u30b0\u30d7\u30ed\u30c8\u30b3\u30eb\u306e\u7a2e\u985e\u306f\u3001<strong>PPTP, L2F, L2TP, GRE, IPsec</strong> \u304c\u3042\u308a\u3001\n\u6697\u53f7\u5316\u30d7\u30ed\u30c8\u30b3\u30eb\u306f\u3001<strong>IPsec</strong>\u3067\u3059\u3002\n\u3053\u306e2\u3064\u3092\u7d44\u307f\u5408\u308f\u305b\u3066\u3001VPN\u901a\u4fe1\u3092\u884c\u3063\u3066\u3044\u307e\u3059\u3002\n\n\u30c8\u30f3\u30cd\u30ea\u30f3\u30b0\u3092IPsec\u3001\u6697\u53f7\u5316\u3092IPsec\u3067\u884c\u3048\u3070\u3001IPsec\u3060\u3051\u3067\u5b8c\u7d50\u3059\u308b\u3068\u601d\u308f\u308c\u307e\u3059\u304c\u3001IPsec\u3067\u3067\u304d\u306a\u3044\u3068\u3053\u308d\u3092\u5225\u306e\u30c8\u30f3\u30cd\u30ea\u30f3\u30b0\u30d7\u30ed\u30c8\u30b3\u30eb\u3067\u30ab\u30d0\u30fc\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\u4f8b\u3048\u3070\u3001IPsec\u3067\u306f\u3067\u304d\u306a\u3044\u30de\u30eb\u30c1\u30ad\u30e3\u30b9\u30c8\u74b0\u5883\u306e\u5834\u5408\u3001\u30c8\u30f3\u30cd\u30ea\u30f3\u30b0\u3092GRE\u3001\u6697\u53f7\u5316\u3092IPsec\u306e\u7d44\u307f\u5408\u308f\u305b\u3067\u901a\u4fe1\u8a2d\u5b9a\u3092\u884c\u3044\u307e\u3059\u3002(GRE over IPsec)\n\n## 2-2. IPSec\u306e\u69cb\u6210\n### 2-2-1. IPSec\u306e\u30d7\u30ed\u30c8\u30b3\u30eb\n IPsec\u306f<strong>AH, ESP, IKE</strong>\u7b49\u306e\u30d7\u30ed\u30c8\u30b3\u30eb\u304b\u3089\u69cb\u6210\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n \u305f\u3060\u3001ESP\u306b\u306fAH\u306e\u6a5f\u80fd\u3067\u3042\u308b\u201d\u6539\u3056\u3093\u9632\u6b62\u201d\u6a5f\u80fd\u304c\u542b\u307e\u308c\u3066\u3044\u308b\u306e\u3067\u3001AH\u3092\u4f7f\u7528\u305b\u305a\u3001ESP\u3068IKE\u306e\u307f\u3067\u69cb\u6210\u3057\u307e\u3059\u3002\n <font color=\"blue\"><strong>\u30fbAH(Authentication Header)</strong></font>\n\u3000\u3000\u3000\u30d1\u30b1\u30c3\u30c8\u6539\u3056\u3093\u9632\u6b62\u306e\u305f\u3081\u306e\u8a8d\u8a3c\n <font color=\"blue\"><strong>\u30fbESP(Encapsulated Security Payload)</strong></font>\n\u3000\u3000\u3000\u30d1\u30b1\u30c3\u30c8\u6539\u3056\u3093\u9632\u6b62\u306e\u305f\u3081\u306e\u8a8d\u8a3c\n\u3000\u3000\u3000\u30da\u30fc\u30ed\u30fc\u30eb\u90e8\u5206(\u30e6\u30fc\u30b6\u30fc\u30c7\u30fc\u30bf)\u306e\u6697\u53f7\u5316\n<font color=\"blue\"><strong>\u30fbIKE(Internet Key Exchange)</strong></font>\n \u3000\u3000\u3000\u9375\u306e\u4ea4\u63db\u3092\u5b89\u5168\u306b\u884c\u3046\n    \n### 2-2-2. IPSec\u306e\u901a\u4fe1\u30e2\u30fc\u30c9\n\u307b\u3068\u3093\u3069\u306e\u69cb\u6210\u306f\u3001\u30db\u30b9\u30c8\u305d\u308c\u305e\u308c\u306b\u8a2d\u5b9a\u3059\u308b\u5fc5\u8981\u306e\u306a\u3044\u30c8\u30f3\u30cd\u30eb\u30e2\u30fc\u30c9\u304c\u4f7f\u308f\u308c\u308b\u3002\n<font color=\"blue\"><strong>\u30fb\u30c8\u30e9\u30f3\u30b9\u30dd\u30fc\u30c8\u30e2\u30fc\u30c9</strong></font> ---- \u30db\u30b9\u30c8\u9593\u3067\u306eIPsec-VPN\n<font color=\"blue\"><strong>\u30fb\u30c8\u30f3\u30cd\u30eb\u30e2\u30fc\u30c9</strong></font> ---- VPN\u30b2\u30fc\u30c8\u30a6\u30a7\u30a4\u9593\u3067\u306eIPsec-VPN\n\n### 2-2-3. VPN\u30b2\u30fc\u30c8\u30a6\u30a7\u30a4\u9593\u3067\u306e\u30b3\u30cd\u30af\u30b7\u30e7\u30f3\nVPN\u30b2\u30fc\u30c8\u30a6\u30a7\u30a4\u9593\u306e\u63a5\u7d9a(\u30b3\u30cd\u30af\u30b7\u30e7\u30f3)\u3092<strong>SA</strong>\uff08Security Association)\u3068\u3044\u3044\u3001\u7247\u65b9\u901a\u884c\u306e\u30c8\u30f3\u30cd\u30eb\u3067\u9001\u7528\u3068\u53d7\u4fe1\u7528\u306eSA\u304c\u306e\u5408\u8a082\u3064\u4f5c\u3089\u308c\u307e\u3059\u3002\nSA\u306e\u4e2d\u8eab\u306fIPsec\u306e\u30d1\u30e9\u30e1\u30fc\u30bf\u3067\u3059\u3002\n\u30d1\u30e9\u30e1\u30fc\u30bf\u3068\u3057\u3066\u306f\u3001\u30d7\u30ed\u30c8\u30b3\u30eb\u3001IPsec\u901a\u4fe1\u30e2\u30fc\u30c9\u3001\u6697\u53f7\u5316\u65b9\u5f0f\u3001\u305d\u306e\u6697\u53f7\u9375\n\u8a8d\u8a3c\u3001\u8a8d\u8a3c\u9375\u306a\u3069\u304c\u3042\u308a\u307e\u3059\u3002\n \u3000SA\u306f\u3001IKE(\u9375\u4ea4\u63db\u30d7\u30ed\u30c8\u30b3\u30eb)\u3092\u4f7f\u7528\u3057\u3066\u751f\u6210\u3057\u307e\u3059\u3002\n\u751f\u6210\u306f\u30d5\u30a7\u30fc\u30ba1\u3068\u30d5\u30a7\u30fc\u30ba2\u306e\u30b9\u30c6\u30c3\u30d7\u304c\u3042\u308a\u307e\u3059\u3002\n<strong>\u30fbIKE\u30d5\u30a7\u30fc\u30ba1</strong>\uff1a\u5404\u7a2e\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u4ea4\u63db\u3057ISAKMP SA\u3092\u751f\u6210\u3002\n<strong>\u30fbIKE\u30d5\u30a7\u30fc\u30ba2</strong>\uff1aISAKMP SA\u4e0a\u3067\u5404\u7a2e\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u4ea4\u63db\u3057\u3066IPsec SA\u3092\u751f\u6210\u3002\n\n# 3. \u69cb\u6210\u306b\u3064\u3044\u3066\n\u3000SoftLayer\u306e\u6771\u4eac\u30ed\u30b1\u30fc\u30b7\u30e7\u30f3\u3068\u30b7\u30f3\u30ac\u30dd\u30fc\u30eb\u30ed\u30b1\u30fc\u30b7\u30e7\u30f3\u305d\u308c\u305e\u308c\u306bVyOS(IPsec\u7528)\u3068Windows2012R2\u3092\u69cb\u7bc9\u3057\u3001Windows\u306e\u30ea\u30e2\u30fc\u30c8\u30c7\u30b9\u30af\u30c8\u30c3\u30d7\u3067\u63a5\u7d9a\u78ba\u8a8d\u3092\u884c\u3044\u307e\u3059\u3002\n![01.png](http://www.seahorse-inc.com/QIITA/IPsec-Site2Site/01.png)\n![02.png](http://www.seahorse-inc.com/QIITA/IPsec-Site2Site/02.png)\n# 4. \u69cb\u7bc9\u624b\u9806\n![03.png](http://www.seahorse-inc.com/QIITA/IPsec-Site2Site/03.png)\n\n# 5. \u69cb\u7bc9\n## 5-1. \u2460VLAN\u30b9\u30d1\u30cb\u30f3\u30b0\u3092OFF\nSoftLayer\u306e\u30dd\u30fc\u30bf\u30eb\u3067\u64cd\u4f5c\u3057\u307e\u3059\u3002\n<font color=\"blue\">\u300c\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u300d\u21d2\u300cIP\u7ba1\u7406\u300d\u21d2\u300cVLAN\u300d</font>\n![04.png](http://www.seahorse-inc.com/QIITA/IPsec-Site2Site/04.png)\n<font color=\"blue\">\u300c\u30b9\u30d1\u30f3\u300d</font> \u3092\u30af\u30ea\u30c3\u30af\u3002\n![05.png](http://www.seahorse-inc.com/QIITA/IPsec-Site2Site/05.png)\n<font color=\"blue\">\u300c\u30aa\u30d5\u300d</font> \u3092\u30c1\u30a7\u30c3\u30af\u3002\n\u3053\u308c\u3067\u3001\u30b9\u30d1\u30f3\u30cb\u30f3\u30b0\u304c\u30aa\u30d5\u306b\u306a\u308a\u307e\u3057\u305f\u3002\n<font color=\"green\">\u203b\u30c6\u30b9\u30c8\u7d42\u308f\u308a\u307e\u3057\u305f\u3089\u3001ON\u306b\u623b\u3057\u3066\u304f\u3060\u3055\u3044\u3002</font>\n\n## 5-2. \u2461 vyos-TOK(VyOS)\u306e\u57fa\u672c\u8a2d\u5b9a\nVyOS\u306e\u5c0e\u5165\u306f\u7701\u7565\u3057\u307e\u3059\u3002\n>(\u53c2\u8003\u60c5\u5831)\u30fbVyOS\u5c0e\u5165\n \u300cSoftLayer\u4eee\u60f3\u30b5\u30fc\u30d0\u306bVyOS\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u307e\u3057\u305f\u300d\nhttp://qiita.com/Mitsu-Murakita/items/d793250566a8e9f3562b >\n\n (1) IP Address(Private\u3068Public)\n (2) SSH\n (3) Gateway Address\n (4) DNS\n (5) Domain Name\n (6) Host Name\n (7) Static route\n (8) Time Server\n (9) Time Zone\n \u3092\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n<font color=\"green\">\u203b\u8aac\u660e\u3057\u3084\u3059\u3044\u3088\u3046\u306b\u884c\u756a\u53f7(xxx)\u3092\u3064\u3051\u3066\u307e\u3059\u304c\u3001\u5b9f\u969b\u306b\u767b\u9332\u3059\u308b\u969b\u306f\u884c\u756a\u53f7\u3092\u5165\u529b\u3057\u306a\u3044\u3067\u304f\u3060\u3055\u3044\u3002</font>\n\n```Command:vyos-TOK\u57fa\u672c\u8a2d\u5b9a\n(001)  interfaces {\n(002)      ethernet eth0 {\n(003)          address 10.132.52.225/26\n(004)          duplex auto\n(005)          hw-id 06:65:fa:44:1c:fb\n(006)          smp_affinity auto\n(007)          speed auto\n(008)      }\n(009)      ethernet eth1 {\n(010)          address 161.202.236.157/29\n(011)          duplex auto\n(012)          hw-id 06:b1:22:00:62:82\n(013)          smp_affinity auto\n(014)          speed auto\n(015)      }\n(016)      loopback lo {\n(017)      }\n(018)  }\n(019)  protocols {\n(020)      static {\n(021)          route 10.0.0.0/8 {\n(022)              next-hop 10.132.52.193 {\n(023)              }\n(024)          }\n(025)      }\n(026)  }\n(027)  service {\n(028)      ssh {\n(029)          port 22\n(030)      }\n(031)  }\n(032)  system {\n(033)      config-management {\n(034)          commit-revisions 20\n(035)      }\n(036)      console {\n(037)          device hvc0 {\n(038)              speed 9600\n(039)          }\n(040)          device ttyS0 {\n(041)              speed 9600\n(042)          }\n(043)      }\n(044)      domain-name softlayer.com\n(045)      gateway-address 161.202.236.153\n(046)      host-name vyos-TOK\n(047)      login {\n(048)          user vyos {\n(049)              authentication {\n(050)                  encrypted-password xxxxxxxxxxxxxxxxxxxxx\n(051)                  plaintext-password \"\"\n(052)              }\n(053)              level admin\n(054)          }\n(055)      }\n(056)      name-server 10.0.80.11\n(057)      name-server 10.0.80.12\n(058)      ntp {\n(059)          server time.service.networklayer.com {\n(060)          }\n(061)      }\n(062)      package {\n(063)          auto-sync 1\n(064)          repository community {\n(065)              components main\n(066)              distribution helium\n(067)              password \"\"\n(068)              url http://packages.vyos.net/vyos\n(069)              username \"\"\n(070)          }\n(071)      }\n(072)      syslog {\n(073)          global {\n(074)              facility all {\n(075)                  level notice\n(076)              }\n(077)              facility protocols {\n(078)                  level debug\n(079)              }\n(080)          }\n(081)      }\n(082)      time-zone Asia/Tokyo\n(083)  }\n```\n<font color=\"blue\">\u25c6 (001)-(018) IP\u30a2\u30c9\u30ec\u30b9\u95a2\u9023\u306e\u8a2d\u5b9a</font>\n \u30d7\u30e9\u30a4\u30d9\u30fc\u30c8\u30a2\u30c9\u30ec\u30b9\uff1aaddress 10.132.52.225/26\n \u30d1\u30d6\u30ea\u30c3\u30af\u30a2\u30c9\u30ec\u30b9\uff1aaddress 161.202.236.157/29\n eth0\u3068eth1\uff1aduplex auto\u3001smp_affinity auto\u3001speed auto\u3000\u3092\u8a2d\u5b9a\n<font color=\"blue\">\u25c6 (019)-(026) Static route\u306e\u8a2d\u5b9a</font>\n\u30d7\u30e9\u30a4\u30d9\u30fc\u30c8\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u306e\u30b2\u30fc\u30c8\u30a6\u30a7\u30a410.132.52.193\u3092\u8a2d\u5b9a\n<font color=\"blue\">\u25c6 (027)-(031) SSH\u306e\u8a2d\u5b9a</font>\n\u30dd\u30fc\u30c822\u3092\u8a2d\u5b9a\n<font color=\"blue\">\u25c6 (044)-(044) \u30c9\u30e1\u30a4\u30f3\u540d\u306e\u8a2d\u5b9a</font>\n softlayer.com\u3092\u8a2d\u5b9a\n<font color=\"blue\">\u25c6 (045)-(045) Gateway Address\u306e\u8a2d\u5b9a</font>\n\u30d1\u30d6\u30ea\u30c3\u30af\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u306e\u30b2\u30fc\u30c8\u30a6\u30a7\u30a4161.202.236.153\u3092\u8a2d\u5b9a\n<font color=\"blue\">\u25c6 (046)-(046) \u30db\u30b9\u30c8\u540d\u306e\u8a2d\u5b9a</font>\n  \u30db\u30b9\u30c8\u540dvyos-TOK\u3092\u8a2d\u5b9a\n<font color=\"blue\">\u25c6 (056)-(057) DNS\u306e\u8a2d\u5b9a</font>\n SoftLayer\u306eDNS 10.0.80.11\u300110.0.80.12\u3092\u8a2d\u5b9a\n<font color=\"blue\">\u25c6 (058)-(061) \u30bf\u30a4\u30e0\u30b5\u30fc\u30d0\u30fc\u306e\u8a2d\u5b9a</font>\n SoftLayer\u306e\u30bf\u30a4\u30e0\u30b5\u30fc\u30d0\u30fctime.service.networklayer.com\u3092\u8a2d\u5b9a\n<font color=\"blue\">\u25c6 (081)-(083) \u30bf\u30a4\u30e0\u30be\u30fc\u30f3\u306e\u8a2d\u5b9a </font>\n Asia/Tokyo\u3092\u8a2d\u5b9a\n\n## 5-3. \u2462 vyos-SNG(VyOS)\u306e\u57fa\u672c\u8a2d\u5b9a\nvyos-TOK01\u3068\u540c\u3058\u624b\u9806\u3067\u8a2d\u5b9a\u3057\u307e\u3059\u3002\u57fa\u672c\u8a2d\u5b9a\u3068\u9055\u3046\u7b87\u6240\u306f\u3001\n(003) address 10.132.52.225/26\n(005) hw-id 06:65:fa:44:1c:fb\n(010) address 161.202.236.157/29\n(012) hw-id 06:b1:22:00:62:82\n(022) next-hop 10.132.52.193 {\n(045) gateway-address 161.202.236.153\n(046) host-name vyos-TOK\n\u3067\u3059\u3002\u5c1a\u3001hw-id\u306f\u81ea\u52d5\u3067\u8a2d\u5b9a\u3055\u308c\u3066\u3044\u308b\u306f\u305a\u3067\u3059\u306e\u3067\u3001\u5b9f\u969b\u5909\u66f4\u3059\u308b\u306e\u306f\n<font color=\"blue\">(003-SNG) address 10.116.128.215/26\n(010-SNG) address 161.202.1.244/29\n(022-SNG) next-hop 10.116.128.193\n(045-SNG) gateway-address 161.202.1.241\n(046-SNG) host-name vyos-SNG</font>\n\u3067\u3059\u3002\n\n```Command:vyos-SNG\u57fa\u672c\u8a2d\u5b9a\n(001-SNG)  interfaces {\n(002-SNG)      ethernet eth0 {\n(003-SNG)          address 10.116.128.215/26\n(004-SNG)          duplex auto\n(005-SNG)          hw-id 06:a7:8c:9d:4e:da\n(006-SNG)          smp_affinity auto\n(007-SNG)          speed auto\n(008-SNG)      }\n(009-SNG)      ethernet eth1 {\n(010-SNG)          address 161.202.1.244/29\n(011-SNG)          duplex auto\n(012-SNG)          hw-id 06:17:fe:9b:9b:3e\n(013-SNG)          smp_affinity auto\n(014-SNG)          speed auto\n(015-SNG)      }\n(016-SNG)      loopback lo {\n(017-SNG)      }\n(018-SNG)  }\n(019-SNG)  protocols {\n(020-SNG)      static {\n(021-SNG)          route 10.0.0.0/8 {\n(022-SNG)              next-hop 10.116.128.193 {\n(023-SNG)              }\n(024-SNG)          }\n(025-SNG)      }\n(026-SNG)  }\n(027-SNG)  service {\n(028-SNG)      ssh {\n(029-SNG)          port 22\n(030-SNG)      }\n(031-SNG)  }\n(032-SNG)  system {\n(033-SNG)      config-management {\n(034-SNG)          commit-revisions 20\n(035-SNG)      }\n(036-SNG)      console {\n(037-SNG)          device hvc0 {\n(038-SNG)              speed 9600\n(039-SNG)          }\n(040-SNG)          device ttyS0 {\n(041-SNG)              speed 9600\n(042-SNG)          }\n(043-SNG)      }\n(044-SNG)      domain-name softlayer.com\n(045-SNG)      gateway-address 161.202.1.241\n(046-SNG)      host-name vyos-SNG\n(047-SNG)      login {\n(048-SNG)          user vyos {\n(049-SNG)              authentication {\n(050-SNG)                  encrypted-password xxxxxxxxxxxxxxxxxxx\n(051-SNG)                  plaintext-password \"\"\n(052-SNG)              }\n(053-SNG)              level admin\n(054-SNG)          }\n(055-SNG)      }\n(056-SNG)      name-server 10.0.80.11\n(057-SNG)      name-server 10.0.80.12\n(058-SNG)      ntp {\n(059-SNG)          server time.service.networklayer.com {\n(060-SNG)          }\n(061-SNG)      }\n(062-SNG)      package {\n(063-SNG)          auto-sync 1\n(064-SNG)          repository community {\n(065-SNG)              components main\n(066-SNG)              distribution helium\n(067-SNG)              password \"\"\n(068-SNG)              url http://packages.vyos.net/vyos\n(069-SNG)              username \"\"\n(070-SNG)          }\n(071-SNG)      }\n(072-SNG)      syslog {\n(073-SNG)          global {\n(074-SNG)              facility all {\n(075-SNG)                  level notice\n(076-SNG)              }\n(077-SNG)              facility protocols {\n(078-SNG)                  level debug\n(079-SNG)              }\n(080-SNG)          }\n(081-SNG)      }\n(082-SNG)      time-zone Asia/Tokyo\n(083-SNG)  }\n```\n\n## 5-4. \u2463 vyos-TOK(VyOS)\u306eIPsec\u8a2d\u5b9a\nIPsec\u63a5\u7d9a\u306b\u6700\u4f4e\u9650\u5fc5\u8981\u306a\u8a2d\u5b9a\u3092\u884c\u3044\u307e\u3059\u3002\n\u5c1a\u3001\u672a\u8a2d\u5b9a\u306e\u5024\u306b\u306f\u30c7\u30d5\u30a9\u30eb\u30c8\u5024\u304c\u4f7f\u7528\u3055\u308c\u307e\u3059\u3002\n\n<strong>\uff08\uff11\uff09\u30d1\u30d6\u30ea\u30c3\u30af\u30a4\u30f3\u30bf\u30fc\u30d5\u30a7\u30fc\u30b9eth1\u306eIPsecVPN\u6709\u52b9\u5316\n\uff08\uff12\uff09IKE\u3067\u5229\u7528\u3059\u308b\u6697\u53f7\u5316\u7528\u306e\u6697\u53f7\u5316\u30a2\u30eb\u30b4\u30ea\u30ba\u30e0\u3068\u8a8d\u8a3c\u7528\u30cf\u30c3\u30b7\u30e5\u30a2\u30eb\u30b4\u30ea\u30ba\u30e0\u306e\u5b9a\u7fa9\n\uff08\uff13\uff09ESP\u3067\u5229\u7528\u3059\u308b\u6697\u53f7\u5316\u7528\u306e\u6697\u53f7\u5316\u30a2\u30eb\u30b4\u30ea\u30ba\u30e0\u3068\u8a8d\u8a3c\u7528\u30cf\u30c3\u30b7\u30e5\u30a2\u30eb\u30b4\u30ea\u30ba\u30e0\u306e\u5b9a\u7fa9\n\uff08\uff14\uff09vyos-SNG\u3078\u306e\u63a5\u7d9a\u8a2d\u5b9a</strong>\n\n### 5-4-1. \uff08\uff11\uff09\u30d1\u30d6\u30ea\u30c3\u30af\u30a4\u30f3\u30bf\u30fc\u30d5\u30a7\u30fc\u30b9eth1\u306eIPsecVPN\u6709\u52b9\u5316\n```Command:eth1\u306eIPsecVPN\u6709\u52b9\u5316\nset vpn ipsec ipsec-interface interface eth1\n```\nIPsecVPN\u901a\u4fe1\u306b\u30d1\u30d6\u30ea\u30c3\u30af\u30a4\u30f3\u30bf\u30fc\u30d5\u30a7\u30fc\u30b9eth1\u306e\u3092\u4f7f\u7528\u3057\u307e\u3059\u3002\n\n### 5-4-2. \uff08\uff12\uff09IKE\u3067\u5229\u7528\u3059\u308b\u6697\u53f7\u5316\u7528\u306e\u6697\u53f7\u5316\u30a2\u30eb\u30b4\u30ea\u30ba\u30e0\u3068\u8a8d\u8a3c\u7528\u30cf\u30c3\u30b7\u30e5\u30a2\u30eb\u30b4\u30ea\u30ba\u30e0\u306e\u5b9a\u7fa9\n```Command:IKE\u306e\u8a2d\u5b9a\nset vpn ipsec ike-group IKE-TOK\nset vpn ipsec ike-group IKE-TOK proposal 1 encryption aes256\nset vpn ipsec ike-group IKE-TOK proposal 1 hash sha1\nset vpn ipsec ike-group IKE-TOK lifetime 3600\n```\n\u6697\u53f7\u5316\u30a2\u30eb\u30b4\u30ea\u30ba\u30e0\u3084\u8a8d\u8a3c\u30a2\u30eb\u30b4\u30ea\u30ba\u30e0\u3092\u53cc\u65b9\u3067\u30cd\u30b4\u30b7\u30a8\u30fc\u30b7\u30e7\u30f3\u3059\u308b\u305f\u3081\u306b\u3001\u8907\u6570\u306e\u7d44\u307f\u5408\u308f\u305b\u3092\u5b9a\u7fa9\u3067\u304d\u307e\u3059\u304c\u3001\u3053\u3053\u3067\u306f\uff11\u3064(proposal 1)\u3060\u3051\u5b9a\u7fa9\u3057\u3066\u3044\u307e\u3059\u3002\n\u6697\u53f7\u5316\u3092AES256\u3001\u30cf\u30c3\u30b7\u30e5\u3092SHA1\u3068\u3057\u3001\u30e9\u30a4\u30d5\u30bf\u30a4\u30e0\u30923600\u3068\u3057\u307e\u3057\u305f\u3002\n\n### 5-4-3. \uff08\uff13\uff09ESP\u3067\u5229\u7528\u3059\u308b\u6697\u53f7\u5316\u7528\u306e\u6697\u53f7\u5316\u30a2\u30eb\u30b4\u30ea\u30ba\u30e0\u3068\u8a8d\u8a3c\u7528\u30cf\u30c3\u30b7\u30e5\u30a2\u30eb\u30b4\u30ea\u30ba\u30e0\u306e\u5b9a\u7fa9\n```Command:ESP\u306e\u8a2d\u5b9a\nset vpn ipsec esp-group ESP-TOK\nset vpn ipsec esp-group ESP-TOK proposal 1 encryption aes256\nset vpn ipsec esp-group ESP-TOK proposal 1 hash sha1\nset vpn ipsec esp-group ESP-TOK lifetime 1800\n```\n\u6697\u53f7\u5316\u30a2\u30eb\u30b4\u30ea\u30ba\u30e0\u3084\u8a8d\u8a3c\u30a2\u30eb\u30b4\u30ea\u30ba\u30e0\u3092\u53cc\u65b9\u3067\u30cd\u30b4\u30b7\u30a8\u30fc\u30b7\u30e7\u30f3\u3059\u308b\u305f\u3081\u306b\u3001\u8907\u6570\u306e\u7d44\u307f\u5408\u308f\u305b\u3092\u5b9a\u7fa9\u3067\u304d\u307e\u3059\u304c\u3001\u3053\u3053\u3067\u306f\uff11\u3064(proposal 1)\u3060\u3051\u5b9a\u7fa9\u3057\u3066\u3044\u307e\u3059\u3002\n\u6697\u53f7\u5316\u3092AES256\u3001\u30cf\u30c3\u30b7\u30e5\u3092SHA1\u3068\u3057\u3001\u30e9\u30a4\u30d5\u30bf\u30a4\u30e0\u30921800\u3068\u3057\u307e\u3057\u305f\u3002\n\n\n### 5-4-4. \uff08\uff14\uff09vyos-SNG\u3078\u306e\u63a5\u7d9a\u8a2d\u5b9a\n```Command:vyos-SNG\u3078\u306e\u63a5\u7d9a\u8a2d\u5b9a\nset vpn ipsec site-to-site peer 161.202.1.244\nset vpn ipsec site-to-site peer 161.202.1.244 authentication mode pre-shared-secret\nset vpn ipsec site-to-site peer 161.202.1.244 authentication pre-shared-secret test_key_1\nset vpn ipsec site-to-site peer 161.202.1.244 default-esp-group ESP-TOK\nset vpn ipsec site-to-site peer 161.202.1.244 ike-group IKE-TOK\nset vpn ipsec site-to-site peer 161.202.1.244 local-address 161.202.236.157\nset vpn ipsec site-to-site peer 161.202.1.244 tunnel 1 local prefix 10.132.52.192/26\nset vpn ipsec site-to-site peer 161.202.1.244 tunnel 1 remote prefix 10.116.128.192/26\n```\nIKE\u30d5\u30a7\u30fc\u30ba1\u3067\u306evyos-SNG\u3068\u306e\u8a8d\u8a3c\u65b9\u5f0f\u3092\u300cPre-Shared Key\u300d\u3068\u3057\u3001\u30ad\u30fc\u3092\u201dtest_key_1\u201d\u3068\u3057\u307e\u3057\u305f\u3002\n\n## 5-4-5. vyos-TOK(VyOS)\u306e\u5168\u8a2d\u5b9a\n```Command:vyos-TOK\u306e\u5168\u8a2d\u5b9a\n interfaces {\n     ethernet eth0 {\n         address 10.132.52.225/26\n         duplex auto\n         hw-id 06:65:fa:44:1c:fb\n         smp_affinity auto\n         speed auto\n     }\n     ethernet eth1 {\n         address 161.202.236.157/29\n         duplex auto\n         hw-id 06:b1:22:00:62:82\n         smp_affinity auto\n         speed auto\n     }\n     loopback lo {\n     }\n }\n protocols {\n     static {\n         route 10.0.0.0/8 {\n             next-hop 10.132.52.193 {\n             }\n         }\n     }\n }\n service {\n     ssh {\n         port 22\n     }\n }\n system {\n     config-management {\n         commit-revisions 20\n     }\n     console {\n         device hvc0 {\n             speed 9600\n         }\n         device ttyS0 {\n             speed 9600\n         }\n     }\n     domain-name softlayer.com\n     gateway-address 161.202.236.153\n     host-name vyos-TOK\n     login {\n         user vyos {\n             authentication {\n                 encrypted-password xxxxxxxxxxxxxxxxxx\n                 plaintext-password \"\"\n             }\n             level admin\n         }\n     }\n     name-server 10.0.80.11\n     name-server 10.0.80.12\n     ntp {\n         server time.service.networklayer.com {\n         }\n     }\n     package {\n         auto-sync 1\n         repository community {\n             components main\n             distribution helium\n             password \"\"\n             url http://packages.vyos.net/vyos\n             username \"\"\n         }\n     }\n     syslog {\n         global {\n             facility all {\n                 level notice\n             }\n             facility protocols {\n                 level debug\n             }\n         }\n     }\n     time-zone Asia/Tokyo\n }\n vpn {\n     ipsec {\n         esp-group ESP-TOK {\n             compression disable\n             lifetime 1800\n             mode tunnel\n             pfs enable\n             proposal 1 {\n                 encryption aes256\n                 hash sha1\n             }\n         }\n         ike-group IKE-TOK {\n             ikev2-reauth no\n             key-exchange ikev1\n             lifetime 3600\n             proposal 1 {\n                 encryption aes256\n                 hash sha1\n             }\n         }\n         ipsec-interfaces {\n             interface eth1\n         }\n         site-to-site {\n             peer 161.202.1.244 {\n                 authentication {\n                     mode pre-shared-secret\n                     pre-shared-secret test_key_1\n                 }\n                 connection-type initiate\n                 default-esp-group ESP-TOK\n                 ike-group IKE-TOK\n                 ikev2-reauth inherit\n                 local-address 161.202.236.157\n                 tunnel 1 {\n                     allow-nat-networks disable\n                     allow-public-networks disable\n                     local {\n                         prefix 10.132.52.192/26\n                     }\n                     remote {\n                         prefix 10.116.128.192/26\n                     }\n                 }\n             }\n         }\n     }\n }\n```\n\n## 5-5. \u2464 vyos-SNG(VyOS)\u306eIPsec\u8a2d\u5b9a\n```Command:vyos-SNGK\u306e\u5168\u8a2d\u5b9a\n interfaces {\n     ethernet eth0 {\n         address 10.116.128.215/26\n         duplex auto\n         hw-id 06:a7:8c:9d:4e:da\n         smp_affinity auto\n         speed auto\n     }\n     ethernet eth1 {\n         address 161.202.1.244/29\n         duplex auto\n         hw-id 06:17:fe:9b:9b:3e\n         smp_affinity auto\n         speed auto\n     }\n     loopback lo {\n     }\n }\n protocols {\n     static {\n         route 10.0.0.0/8 {\n             next-hop 10.116.128.193 {\n             }\n         }\n     }\n }\n service {\n     ssh {\n         port 22\n     }\n }\n system {\n     config-management {\n         commit-revisions 20\n     }\n     console {\n         device hvc0 {\n             speed 9600\n         }\n         device ttyS0 {\n             speed 9600\n         }\n     }\n     domain-name softlayer.com\n     gateway-address 161.202.1.241\n     host-name vyos-SNG\n     login {\n         user vyos {\n             authentication {\n                 encrypted-password xxxxxxxxxxxxxxxxxxxxx\n                 plaintext-password \"\"\n             }\n             level admin\n         }\n     }\n     name-server 10.0.80.11\n     name-server 10.0.80.12\n     ntp {\n         server time.service.networklayer.com {\n         }\n     }\n     package {\n         auto-sync 1\n         repository community {\n             components main\n             distribution helium\n             password \"\"\n             url http://packages.vyos.net/vyos\n             username \"\"\n         }\n     }\n     syslog {\n         global {\n             facility all {\n                 level notice\n             }\n             facility protocols {\n                 level debug\n             }\n         }\n     }\n     time-zone Asia/Tokyo\n }\n vpn {\n     ipsec {\n         esp-group ESP-SNG {\n             lifetime 1800\n             proposal 1 {\n                 encryption aes256\n                 hash sha1\n             }\n             proposal 2 {\n                 encryption 3des\n                 hash md5\n             }\n         }\n         ike-group IKE-SNG {\n             lifetime 3600\n             proposal 1 {\n                 encryption aes256\n                 hash sha1\n             }\n             proposal 2 {\n                 encryption aes128\n                 hash sha1\n             }\n         }\n         ipsec-interfaces {\n             interface eth1\n         }\n         site-to-site {\n             peer 161.202.236.157 {\n                 authentication {\n                     mode pre-shared-secret\n                     pre-shared-secret test_key_1\n                 }\n                 default-esp-group ESP-SNG\n                 ike-group IKE-SNG\n                 local-address 161.202.1.244\n                 tunnel 1 {\n                     local {\n                         prefix 10.116.128.192/26\n                     }\n                     remote {\n                         prefix 10.132.52.192/26\n                     }\n                 }\n             }\n         }\n     }\n }\n```\n\n## 5-6. \u2465IPsec\u63a5\u7d9a\u78ba\u8a8d\nVyOS\u306eShow\u30b3\u30de\u30f3\u30c9\u3067\u78ba\u8a8d\u3057\u307e\u3059\u3002\n<font color=\"blue\"><strong>\u201dshow vpn ike sa\"\n\u201dshow vpn ipsec sa\" </strong></font>\n\n<strong>\u3010vyos-TOK\u3011</strong>\n![06.png](http://www.seahorse-inc.com/QIITA/IPsec-Site2Site/06.png)\n\n<strong>\u3010vyos-SNG\u3011</strong>\n![07.png](http://www.seahorse-inc.com/QIITA/IPsec-Site2Site/07.png)\n\nsa\u306e\u30b9\u30c6\u30fc\u30bf\u30b9\u306f<font color=\"blue\"><strong>\"up\"</strong></font>\u3067\u3059\u306e\u3067\u3001IPsec-VPN\u306e\u901a\u4fe1\u306f\u78ba\u7acb\u3055\u308c\u3066\u3044\u308b\u306e\u304c\u78ba\u8a8d\u3067\u304d\u307e\u3057\u305f\u3002\n\n## 5-7. \u2466 W2012R2-TOK(Windows)\u306e\u8a2d\u5b9a\n\u30b7\u30f3\u30ac\u30dd\u30fc\u30ebDC\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u3078\u306e\u30b9\u30bf\u30c6\u30a3\u30c3\u30af\u30eb\u30fc\u30c8\u8a2d\u5b9a\n\n```Command:W2012R2-TOK\u3067\u306eStaticRoute\u8a2d\u5b9a\n> route add -p 10.116.128.192 mask 255.255.255.192 10.132.52.225\n```  \n\n## 5-8. \u2467 W2012R2-SNG(Windows)\u306e\u8a2d\u5b9a\n\u6771\u4eacDC\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u3078\u306e\u30b9\u30bf\u30c6\u30a3\u30c3\u30af\u30eb\u30fc\u30c8\u8a2d\u5b9a\n\n```Command:W2012R2-SNGK\u3067\u306eStaticRoute\u8a2d\u5b9a\n> route add -p 10.132.52.192 mask 255.255.255.192 10.116.128.215\n```  \n\n## 5-9. \u2468 Windows2012Server\u9593\u30ea\u30e2\u30fc\u30c8\u30c7\u30b9\u30af\u30c8\u30c3\u30d7\u63a5\u7d9a\u78ba\u8a8d\n\uff08\uff11\uff09W2012R2-TOK\u304b\u3089W2012R2-SNG\u3078\u30ea\u30e2\u30fc\u30c8\u30c7\u30b9\u30af\u30c8\u30c3\u30d7\u63a5\u7d9a\u3057\u307e\u3059\u3002\n![08.png](http://www.seahorse-inc.com/QIITA/IPsec-Site2Site/08.png)\n\n\uff08\uff12\uff09W2012R2-SNG\u304b\u3089W2012R2-TOK\u3078\u30ea\u30e2\u30fc\u30c8\u30c7\u30b9\u30af\u30c8\u30c3\u30d7\u63a5\u7d9a\u3057\u307e\u3059\u3002\n![09.png](http://www.seahorse-inc.com/QIITA/IPsec-Site2Site/09.png)\n\n\n\u30ea\u30e2\u30fc\u30c8\u30c7\u30b9\u30af\u30c8\u30c3\u30d7\u3067\u63a5\u7d9a\u304c\u78ba\u8a8d\u3067\u304d\u307e\u3057\u305f\u3002\n\n# 6. \u304a\u308f\u308a\u306b\n\u5f53\u6295\u7a3f\u306esite-to-site\u8a2d\u5b9a\u306f\u3001tunnel\u3067\u3059\u3002\n\u3082\u3057\u3001\u76f8\u624b\u5074\u306b\u8907\u6570\u306e\u30bb\u30b0\u30e1\u30f3\u30c8\u304c\u5b58\u5728\u3057\u3066\u30eb\u30fc\u30c6\u30a3\u30f3\u30b0\u3059\u308b\u5834\u5408\u3084tunnel\u3092\u8907\u6570\u305b\u3063\u3066\u3044\u3059\u308b\u5834\u5408\u306f\u3001tunnel\u8a2d\u5b9a\u3067\u306f\u306a\u304f\u3001vti (Virtual Tunnel Interface)\u3067\u8a2d\u5b9a\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n\u4eca\u56de\u306fIPsec\u306e\u52c9\u5f37\u3067\u3059\u306e\u3067\u3001\u57fa\u672c\u7684\u306a\u8a2d\u5b9a\u3067\u3057\u305f\u3002\n\u4ed6\u306b\u3082\u8272\u3005\u306a\u8a2d\u5b9a\u304c\u3042\u308a\u307e\u3059\u306e\u3067\u3001\u304a\u8a66\u3057\u3060\u3055\u3044\u3002\n> set vpn ipsec esp-group ESP-TOK mode tunnel\nset vpn ipsec esp-group ESP-TOK pfs enable\n>\nset vpn ipsec nat-traversal enable\n>\nset vpn ipsec site-to-site peer 161.202.1.244 connection-type initiate\nset vpn ipsec site-to-site peer 161.202.1.244 default-esp-group ESP-TOK\n>\nset vpn ipsec site-to-site peer 161.202.1.244 tunnel 1 allow-nat-networks disable\nset vpn ipsec site-to-site peer 161.202.1.244 tunnel 1 allow-public-networks disable\n>\nset vpn ipsec ike-group IKE-TOK dead-peer-detection action 'restart'\nset vpn ipsec ike-group IKE-TOK dead-peer-detection interval '30'\nset vpn ipsec ike-group IKE-TOK dead-peer-detection timeout '30'\nset vpn ipsec auto-update '60'\n>\nset vpn ipsec site-to-site peer 161.202.1.244 authentication id @TOK\nset vpn ipsec site-to-site peer 161.202.1.244 authentication remote-id @SNG\n>\n\n", "tags": ["SoftLayer", "VPN", "ipsec", "LAN\u9593\u63a5\u7d9a", "VyOS"]}