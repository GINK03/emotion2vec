{"context": " More than 1 year has passed since last update.\n\n\u8ffd\u8a18\nSails.js\u30920.11\u7cfb\u306b\u3059\u308b\u3068\u52d5\u304b\u306a\u304b\u3063\u305f\uff0b\u305f\u3076\u3093\u8272\u3005\u9593\u9055\u3063\u3066\u3044\u305f\u306e\u3067\u30b3\u30fc\u30c9\u3092\u4fee\u6b63\u30020.11\u7cfb\u304b\u3089(?)Middleware\u3067Pasport\u3092\u521d\u671f\u5316\u3057\u306a\u3044\u3068\u52d5\u304b\u306a\u3044\u3002\n\nconfig/http.js\nmodule.exports.http = {\n  middleware: {\n    order: [\n      'startRequestTimer',\n      'cookieParser',\n      'session',\n      // Customized Start\n      'passportInit',\n      'passportSession',\n      // Customized End\n      'bodyParser',\n      'handleBodyParserError',\n      'compress',\n      'methodOverride',\n      'poweredBy',\n      '$custom',\n      'router',\n      'www',\n      'favicon',\n      '404',\n      '500'\n    ],\n    passportInit: require('passport').initialize(),\n    passportSession: require('passport').session()\n  }\n}\n\n\n\u305d\u3057\u3066\u30ea\u30af\u30a8\u30b9\u30c8\u3092\u53d7\u3051\u308bController\u306f\u3053\u3093\u306a\u611f\u3058\u3002\n\napi/AuthController.js\n/**\n * AuthController\n *\n * @description :: Server-side logic for managing auths\n * @help        :: See http://links.sailsjs.org/docs/controllers\n */\n\nvar passport = require('passport');\nvar FacebookStrategy = require('passport-facebook').Strategy;\n\npassport.use(new FacebookStrategy({\n    clientID: process.env.FACEBOOK_CLIENT_ID || 'xxxxx',\n    clientSecret: process.env.FACEBOOK_CLIENT_SECRET || 'xxxxx',\n    callbackURL: '/auth/facebook/callback'\n},\nfunction(accessToken, refreshToken, profile, done) {\n    var id = profile.id;\n    var username = profile.displayName;\n    var iconPath = 'https://graph.facebook.com/' + id + '/picture?width=320&height=320';\n\n    UserService.signInOrSignUpFacebook({\n        facebookId: id,\n        name: username,\n        iconPath: iconPath,\n        accessToken: accessToken\n    }).then(function(user) {\n        return done(null, user);\n    }).catch(function(error) {\n        sails.log.error(error);\n        return done(error);\n    });\n}));\n\npassport.serializeUser(function(user, done) {\n    done(null, user.id);\n});\n\npassport.deserializeUser(function(userId, done) {\n    User.findOne({id: userId}).then(function(user) {\n        done(null, user);\n    }).catch(function(error) {\n        done(error);\n    });\n});\n\n\nmodule.exports = {\n    facebook: function(req, res, next) {\n        passport.authenticate('facebook', {})(req, res);\n    },\n    facebookCallback: function(req, res, next) {\n        passport.authenticate('facebook', {\n            failureRedirect: '/',\n        }, function(error, user) {\n            if (error) {\n                sails.log.error(error);\n                res.redirect(500);\n            }\n\n            req.login(user, function(error) {\n                res.redirect('/');\n            });\n\n        })(req, res);\n    }\n};\n\n\n\u30e6\u30fc\u30b6\u60c5\u5831\u306e\u53d6\u5f97API\n\napi/UserController.js\nmodule.exports = {\n    me: function(req, res) {\n        var user = req.user;\n\n        if (!user) {\n            return res.send(400);\n        }\n\n        res.send(user);\n    },\n}\n\n\n\nSails.js\u3092\u4f7f\u3063\u3066\u3001\u5c11\u3057\u3060\u3051\u62e1\u5f35\u6027\u3092\u8003\u3048\u305fFacebook\u30ed\u30b0\u30a4\u30f3\u65b9\u6cd5\u3092\u66f8\u3044\u3066\u3044\u307e\u3059\u3002\n\u30ec\u30dd\u30b8\u30c8\u30ea\u306b\u3082\u30b3\u30fc\u30c9\u3092\u7f6e\u3044\u3066\u3044\u307e\u3059\u306e\u3067\u3001\u30b3\u30c1\u30e9\u3082\u5408\u308f\u305b\u3066\u5fa1\u89a7\u304f\u3060\u3055\u3044\u3002\nhttps://github.com/KeitaMoromizato/sails-facebook-auth\nsails.js Advent Calendar 2014\u3001\u3082\u3046\u3053\u308c\u3067\u30cd\u30bf\u5207\u308c\u3067\u3059...\n\n\u6ce8\u610f\nnode.js\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u304c0.11\u7cfb\u3060\u3068(\u4eca\u306e\u3068\u3053\u308d)\u52d5\u304d\u307e\u305b\u3093\u3002\n\nFacebook App\u306e\u6e96\u5099\nFacebook Developer\u306b\u30a2\u30af\u30bb\u30b9\u3002[Apps] -> [Add a New App]\u304b\u3089\u30a6\u30a7\u30d6\u30b5\u30a4\u30c8\u3092\u9078\u629e\u3059\u308b\u3002\u30a2\u30d7\u30ea\u540d\u3092\u9078\u629e\u3057\u3066[Create New Facebook App ID]\u3002\u30ab\u30c6\u30b4\u30ea\u9078\u3079\u3068\u304b\u8a00\u308f\u308c\u308b\u3051\u3069\u9069\u5f53\u3067\u3044\u3044\u3067\u3059\u3002\n\n\u4eca\u56de\u306f\u30ed\u30fc\u30ab\u30eb\u3067\u52d5\u4f5c\u78ba\u8a8d\u3059\u308b\u306e\u3067\u3001\u30b5\u30a4\u30c8URL\u306flocalhost\u306b\u3002\n(\u203bURL\u306f\u30dd\u30fc\u30c8\u756a\u53f7\u307e\u3067\u542b\u3081\u305f\u3082\u306e[http://localhost:1337/]\u304c\u5fc5\u8981\u3067\u3057\u305f\u3002)\n\n\u6b21\u306e\u30b9\u30c6\u30c3\u30d7\u3067\u300c\u30ed\u30b0\u30a4\u30f3\u300d\u3092\u9078\u629e\u3002\n\n[Apps]\u304b\u3089\u5148\u307b\u3069\u4f5c\u6210\u3057\u305f\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3092\u9078\u629e\u3002\n\nApp ID\u3068App Secret\u3092\u5165\u624b\u3057\u307e\u3059(Secret\u306f[show]\u3092\u30af\u30ea\u30c3\u30af\u3059\u308b\u3068\u8868\u793a\u3055\u308c\u307e\u3059)\u3002\n\n\n\u5b9f\u88c5\nSails.js\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3092\u4f5c\u6210\u3057\u3001\u5fc5\u8981\u306a\u30e2\u30b8\u30e5\u30fc\u30eb\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3002\u4eca\u56de\u306fPassport.js\u3068\u3044\u3046\u8a8d\u8a3c\u3092\u8acb\u3051\u8ca0\u3063\u3066\u304f\u308c\u308b\u30e2\u30b8\u30e5\u30fc\u30eb\u3092\u4f7f\u3044\u307e\u3059\u3002Passport.js\u306fStrategy(\u8a8d\u8a3c\u65b9\u6cd5)\u3092\u8272\u3005\u306a\u3082\u306e\u306b\u5207\u308a\u66ff\u3048\u308b\u3053\u3068\u304c\u51fa\u6765\u307e\u3059\u3002\u4eca\u56de\u306fFacebookAuth\u3092\u4f7f\u3046\u306e\u3067\u3001passport-facebook\u3082\u4e00\u7dd2\u306b\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3002\n$ sails new facebook-auth-test\n$ cd facebook-auth-test\n$ npm install passport --save\n$ npm install passport-facebook --save\n\n\u305d\u308c\u305e\u308c\u5fc5\u8981\u306aController/Model\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n$ sails generate api user\n$ sails generate controller auth\n$ sails generate controller page\n\n\nFacebook\u30e2\u30b8\u30e5\u30fc\u30eb\n\u30ed\u30b0\u30a4\u30f3\u7528\u30e2\u30b8\u30e5\u30fc\u30eb\u3067\u3059\u3002\u6628\u4eca\u306e\u30b5\u30fc\u30d3\u30b9\u3060\u3068Facebook/twitter/google\u306a\u3069\u591a\u69d8\u306a\u30b5\u30fc\u30d3\u30b9\u3067\u30ed\u30b0\u30a4\u30f3\u3059\u308b\u3053\u3068\u304c\u51fa\u6765\u307e\u3059\u306d\u3002\u305d\u306e\u3088\u3046\u306a\u62e1\u5f35\u6027\u3082\u8003\u3048\u3001Signin\u3068\u3044\u3046\u30e2\u30b8\u30e5\u30fc\u30eb\u306bfacebook\u30ed\u30b0\u30a4\u30f3\u7528\u95a2\u6570\u3092\u66f8\u3044\u3066\u3044\u307e\u3059\u3002\n\napi/services/Signin.js\nmodule.exports = (function(){\n  var passport = require('passport');\n  var FacebookStrategy = require('passport-facebook').Strategy;\n\n  passport.use(new FacebookStrategy({\n      clientID : \"xxxxxxxxxxxxxxxxxxxxxxxx\",\n      clientSecret: \"xxxxxxxxxxxxxxxxxx\",\n      callbackURL: \"/auth/facebook/callback\"\n    },\n    function(accessToken, refreshToken, profile, done) {\n\n      var id = profile.id;\n      var username = profile.displayName;\n      var icon = 'https://graph.facebook.com/' + id + '/picture?width=320&height=320';\n\n      User.signinOrSignup(\"facebook\", id, {name: username, icon: icon}, function(err, user) {\n        return done(err, user);\n      });\n    })\n  );\n\n  var facebook = function(req, res, callback) {\n    passport.authenticate('facebook', {}, function(err, user) {\n      if (user) {\n        req.session.authenticated = true;\n        req.session.user_id = user.id;\n      }\n\n      callback(err, user);\n    })(req, res);\n  };\n\n  return {\n    facebook: facebook\n  };\n})();\n\n\n\u5730\u5473\u306b\u91cd\u8981\u306a\u3068\u3053\u308d\u304c\u3053\u3053\u3002\u8a8d\u8a3c\u6e08\u307f\u30d5\u30e9\u30b0\u3002\nreq.session.authenticated = true;\n\n\n\u30ed\u30b0\u30a4\u30f3API\n\u30ed\u30b0\u30a4\u30f3\u7528API\u3067\u3059\u3002\u7279\u306b\u8907\u96d1\u306a\u3053\u3068\u306f\u306a\u304f\u3001\u30ed\u30b0\u30a4\u30f3\u3067\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3057\u305f\u3089/login\u306b\u30ea\u30c0\u30a4\u30ec\u30af\u30c8\u3057\u3001\u6210\u529f\u3057\u305f\u5834\u5408\u306f\u30eb\u30fc\u30c8\u306b\u5165\u308b\u3002\n\napi/controllers/AuthController.js\nmodule.exports = {\n  facebook : function(req, res) {\n\n    SignIn.facebook(req, res, function(err, user) {\n      if (err) {\n        res.redirect('/login');\n      }\n      else {\n        res.redirect('/');\n       }\n    });\n  },\n  facebookCallback : function(req, res) {\n    passport.authenticate('facebook', {\n      successRedirect: '/',\n      failureRedirect: '/login' }\n    );\n  }\n};\n\n\n\nUser\u30e2\u30c7\u30eb\n\u30e6\u30fc\u30b6\u30e2\u30c7\u30eb\u3002attributes\u306e\u30dd\u30a4\u30f3\u30c8\u3068\u3057\u3066\u306f\u3001\u8a8d\u8a3c\u60c5\u5831(auth)\u3092\u914d\u5217\u3067\u6301\u3063\u3066\u3044\u308b\u4e8b\u3002\u5148\u307b\u3069\u3082\u5c11\u3057\u89e6\u308c\u305f\u3088\u3046\u306b\u3001\u5c06\u6765\u7684\u306b\u5225\u306e\u65b9\u6cd5\u3067\u3082\u30ed\u30b0\u30a4\u30f3\u51fa\u6765\u308b\u3088\u3046\u306b\u3068\u8003\u3048\u305f\u7d50\u679c\u3053\u3046\u306a\u308a\u307e\u3057\u305f\u3002signinOrSignup()\u306f\u9762\u5012\u306a\u306e\u3067\u767b\u9332/\u30ed\u30b0\u30a4\u30f3\u3092\u540c\u6642\u306b\u3057\u3061\u3083\u3063\u305f\u95a2\u6570\u3002\n\napi/models/User.js\nmodule.exports = {\n\n  attributes: {\n    auth: 'json',\n    name: {\n      type: 'string'\n    },\n    icon: {\n      type: 'string'\n    }\n  },\n  signinOrSignup : function(auth, id, data, callback) {\n    var query = {};\n    query[\"auth.\" + auth] = id;\n    User.findOne(query).exec(function(err, user) {\n      if (err) {\n        return callback(\"ERROR, find User\");\n      }\n\n      if (user) {\n        return callback(null, user);\n      }\n\n      // SignUp\n      data.auth = {};\n      data.auth[auth] = id;\n      User.create(data).exec(function(err, user) {\n\n        if (err) {\n          return callback(\"ERROR, create User\");\n        }\n\n        return callback(null, user);\n      });\n    });\n  }\n};\n\n\n\n\u516c\u958b/\u975e\u516c\u958b\u8a2d\u5b9a\n\u3069\u306e\u30da\u30fc\u30b8/API\u3092\u516c\u958b\u3059\u308b\u304b\u3068\u3044\u3046\u8a2d\u5b9a\u306fpolicies.js\u306b\u66f8\u304d\u307e\u3059\u3002\u4e00\u756a\u6700\u521d\u306b\u30ef\u30a4\u30eb\u30c9\u30ab\u30fc\u30c9\u3067\u3059\u3079\u3066\u8a8d\u8a3c\u5fc5\u9808\u306b\u3057\u3001\u305d\u306e\u5f8c\u306b\u30ed\u30b0\u30a4\u30f3\u7121\u3057\u3067\u3082\u516c\u958b\u3059\u308bController/Action\u306b\u3064\u3044\u3066true\u306b\u3057\u3066\u3044\u304d\u307e\u3059\u3002\n\u3061\u306a\u307f\u306b\u6700\u521d\u306b\u8a2d\u5b9a\u3057\u3066\u3044\u308bsessionAuth\u306f\u3001api/policies/sessionAuth.js\u3067\u3059\u3002\u3064\u307e\u308a\u3001API\u3054\u3068\u306b\u8a8d\u8a3c\u65b9\u6cd5\u3082\u5909\u3048\u3089\u308c\u308b\u3068\u3044\u3046\u308f\u3051\u3002\u3069\u3053\u3067\u4f7f\u3046\u304b\u306f\u308f\u304b\u308a\u307e\u305b\u3093\u3051\u3069\u3002\n\nconfig/policies.js\nmodule.exports.policies = {\n\n  '*' : 'sessionAuth',\n\n  PageController : {\n    login : true\n  },\n\n  AuthController : {\n    facebook : true\n  }\n};\n\n\n\n\u30da\u30fc\u30b8\u306e\u8868\u793a\n\u57fa\u672c\u7684\u306b\u30da\u30fc\u30b8\u3092\u8868\u793a\u3059\u308b\u3060\u3051\u306a\u3089\u5b9f\u88c5\u306f\u4f55\u3082\u3044\u3089\u306a\u3044\u306f\u305a\u3067\u3059\u304c\u3001policies\u306b\u3088\u308b\u30d5\u30a3\u30eb\u30bf\u3092\u304b\u3051\u308b\u3070\u3042\u3044\u3001Controller\u3092\u7d4c\u7531\u3057\u306a\u3044\u3068\u6b63\u5e38\u306b\u52d5\u304d\u307e\u305b\u3093\u3002(Controller\u3092\u901a\u3055\u305a\u306b\u51fa\u6765\u308b\u65b9\u6cd5\u3042\u308c\u3070\u6559\u3048\u3066\u4e0b\u3055\u3044!)\n\u306a\u306e\u3067\u30ed\u30b0\u30a4\u30f3\u30da\u30fc\u30b8\u3068\u30ed\u30b0\u30a4\u30f3\u5f8c\u30da\u30fc\u30b8\u3092\u8868\u793a\u3059\u308bAction\u3092\u8ffd\u52a0\u3002\u3064\u3044\u3067\u306b\u30ed\u30b0\u30a4\u30f3\u5f8c\u306b\u306fFacebook\u304b\u3089\u53d6\u3063\u3066\u304d\u305f\u30e6\u30fc\u30b6\u540d\u3068\u30a2\u30a4\u30b3\u30f3\u3092\u8868\u793a\u3057\u307e\u3057\u3087\u3046\u3002\n\napi/controllers/PageController.js\nmodule.exports = {\n  login: function(req, res) {\n    res.view('login');\n  },\n  index: function(req, res) {\n    var userId = req.session.user_id;\n\n    User.findOne(userId).exec(function(err, user) {\n      if (err) res.send(500);\n\n      res.view('index', {\n        user: user\n      });\n    });\n  }\n};\n\n\n\n\u5f8c\u306f\u7d30\u3005\u3057\u305f\u3082\u306e\u3092\n\nconfig/routes.js\n  'GET /': {\n    controller : 'Page',\n    action : 'index'\n  },\n\n  'GET /login' : {\n    controller : 'Page',\n    action : 'login'\n  },\n\n\n\nviews/index.ejs\n<div>\n  <h1><%= user.name %></h1>\n  <img src='<%= user.icon %>' />\n</div>\n\n\n\nviews.login.ejs\n<h2>Facebook Login</h2>\n<a href=\"/auth/facebook\">Login</a>\n\n\n\n\u52d5\u304b\u3057\u3066\u307f\u308b\n\u307e\u305a\u306flocalhost/\u306b\u30a2\u30af\u30bb\u30b9\u3057\u3066\u307f\u308b\u3068...\n\u306a\u3093\u304b\u967d\u6c17\u306aForbidden\u304c\u51fa\u307e\u3057\u305f\u3002\n\n\u305d\u308c\u306a\u3089\u3068localhost/login\u304b\u3089[Login]\u3092\u30af\u30ea\u30c3\u30af\u3059\u308b\u3068...\n\nFacebook\u306b\u9077\u79fb\u3057\u3066\u8a8d\u8a3c\u5f8c\u3001\u7121\u4e8blocalhost/\u304c\u8868\u793a\u3055\u308c\u307e\u3057\u305f!\n\n# \u8ffd\u8a18\nSails.js\u30920.11\u7cfb\u306b\u3059\u308b\u3068\u52d5\u304b\u306a\u304b\u3063\u305f\uff0b\u305f\u3076\u3093\u8272\u3005\u9593\u9055\u3063\u3066\u3044\u305f\u306e\u3067\u30b3\u30fc\u30c9\u3092\u4fee\u6b63\u30020.11\u7cfb\u304b\u3089(?)Middleware\u3067Pasport\u3092\u521d\u671f\u5316\u3057\u306a\u3044\u3068\u52d5\u304b\u306a\u3044\u3002\n\n``` config/http.js\nmodule.exports.http = {\n  middleware: {\n    order: [\n      'startRequestTimer',\n      'cookieParser',\n      'session',\n      // Customized Start\n      'passportInit',\n      'passportSession',\n      // Customized End\n      'bodyParser',\n      'handleBodyParserError',\n      'compress',\n      'methodOverride',\n      'poweredBy',\n      '$custom',\n      'router',\n      'www',\n      'favicon',\n      '404',\n      '500'\n    ],\n    passportInit: require('passport').initialize(),\n    passportSession: require('passport').session()\n  }\n}\n```\n\n\u305d\u3057\u3066\u30ea\u30af\u30a8\u30b9\u30c8\u3092\u53d7\u3051\u308bController\u306f\u3053\u3093\u306a\u611f\u3058\u3002\n\n``` api/AuthController.js\n/**\n * AuthController\n *\n * @description :: Server-side logic for managing auths\n * @help        :: See http://links.sailsjs.org/docs/controllers\n */\n\nvar passport = require('passport');\nvar FacebookStrategy = require('passport-facebook').Strategy;\n\npassport.use(new FacebookStrategy({\n\tclientID: process.env.FACEBOOK_CLIENT_ID || 'xxxxx',\n\tclientSecret: process.env.FACEBOOK_CLIENT_SECRET || 'xxxxx',\n\tcallbackURL: '/auth/facebook/callback'\n},\nfunction(accessToken, refreshToken, profile, done) {\n\tvar id = profile.id;\n\tvar username = profile.displayName;\n\tvar iconPath = 'https://graph.facebook.com/' + id + '/picture?width=320&height=320';\n\n\tUserService.signInOrSignUpFacebook({\n\t\tfacebookId: id,\n\t\tname: username,\n\t\ticonPath: iconPath,\n\t\taccessToken: accessToken\n\t}).then(function(user) {\n\t\treturn done(null, user);\n\t}).catch(function(error) {\n\t\tsails.log.error(error);\n\t\treturn done(error);\n\t});\n}));\n\npassport.serializeUser(function(user, done) {\n\tdone(null, user.id);\n});\n\npassport.deserializeUser(function(userId, done) {\n\tUser.findOne({id: userId}).then(function(user) {\n\t\tdone(null, user);\n\t}).catch(function(error) {\n\t\tdone(error);\n\t});\n});\n\n\nmodule.exports = {\n\tfacebook: function(req, res, next) {\n\t\tpassport.authenticate('facebook', {})(req, res);\n\t},\n\tfacebookCallback: function(req, res, next) {\n\t\tpassport.authenticate('facebook', {\n\t\t\tfailureRedirect: '/',\n\t\t}, function(error, user) {\n\t\t\tif (error) {\n\t\t\t\tsails.log.error(error);\n\t\t\t\tres.redirect(500);\n\t\t\t}\n\n\t\t\treq.login(user, function(error) {\n\t\t\t\tres.redirect('/');\n\t\t\t});\n\n\t\t})(req, res);\n\t}\n};\n```\n\n\u30e6\u30fc\u30b6\u60c5\u5831\u306e\u53d6\u5f97API\n\n``` api/UserController.js\nmodule.exports = {\n\tme: function(req, res) {\n\t\tvar user = req.user;\n\n\t\tif (!user) {\n\t\t\treturn res.send(400);\n\t\t}\n\n\t\tres.send(user);\n\t},\n}\n```\n\n---\n\nSails.js\u3092\u4f7f\u3063\u3066\u3001\u5c11\u3057\u3060\u3051\u62e1\u5f35\u6027\u3092\u8003\u3048\u305fFacebook\u30ed\u30b0\u30a4\u30f3\u65b9\u6cd5\u3092\u66f8\u3044\u3066\u3044\u307e\u3059\u3002\n\n\u30ec\u30dd\u30b8\u30c8\u30ea\u306b\u3082\u30b3\u30fc\u30c9\u3092\u7f6e\u3044\u3066\u3044\u307e\u3059\u306e\u3067\u3001\u30b3\u30c1\u30e9\u3082\u5408\u308f\u305b\u3066\u5fa1\u89a7\u304f\u3060\u3055\u3044\u3002\nhttps://github.com/KeitaMoromizato/sails-facebook-auth\n\n[sails.js Advent Calendar 2014](http://qiita.com/advent-calendar/2014/sailsjs)\u3001\u3082\u3046\u3053\u308c\u3067\u30cd\u30bf\u5207\u308c\u3067\u3059...\n\n\n## \u6ce8\u610f\nnode.js\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u304c0.11\u7cfb\u3060\u3068(\u4eca\u306e\u3068\u3053\u308d)\u52d5\u304d\u307e\u305b\u3093\u3002\n\n## Facebook App\u306e\u6e96\u5099\n[Facebook Developer](https://developers.facebook.com/)\u306b\u30a2\u30af\u30bb\u30b9\u3002[Apps] -> [Add a New App]\u304b\u3089\u30a6\u30a7\u30d6\u30b5\u30a4\u30c8\u3092\u9078\u629e\u3059\u308b\u3002\u30a2\u30d7\u30ea\u540d\u3092\u9078\u629e\u3057\u3066[Create New Facebook App ID]\u3002\u30ab\u30c6\u30b4\u30ea\u9078\u3079\u3068\u304b\u8a00\u308f\u308c\u308b\u3051\u3069\u9069\u5f53\u3067\u3044\u3044\u3067\u3059\u3002\n\n![1.png](https://qiita-image-store.s3.amazonaws.com/0/52054/1d00b7c4-2e54-8204-50bb-dcc924e3b0a7.png)\n\n\u4eca\u56de\u306f\u30ed\u30fc\u30ab\u30eb\u3067\u52d5\u4f5c\u78ba\u8a8d\u3059\u308b\u306e\u3067\u3001\u30b5\u30a4\u30c8URL\u306flocalhost\u306b\u3002\n(\u203bURL\u306f\u30dd\u30fc\u30c8\u756a\u53f7\u307e\u3067\u542b\u3081\u305f\u3082\u306e[http://localhost:1337/]\u304c\u5fc5\u8981\u3067\u3057\u305f\u3002)\n![2.png](https://qiita-image-store.s3.amazonaws.com/0/52054/f1b6a349-cf02-d99d-e8c9-ef19059e09d1.png)\n\n\u6b21\u306e\u30b9\u30c6\u30c3\u30d7\u3067\u300c\u30ed\u30b0\u30a4\u30f3\u300d\u3092\u9078\u629e\u3002\n\n![3.png](https://qiita-image-store.s3.amazonaws.com/0/52054/e81f2dc5-2cf7-fc49-85bb-28dd75038da7.png)\n\n[Apps]\u304b\u3089\u5148\u307b\u3069\u4f5c\u6210\u3057\u305f\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3092\u9078\u629e\u3002\n\n![4.png](https://qiita-image-store.s3.amazonaws.com/0/52054/3bb538cf-bfd2-95dd-23a8-ad80c7b8fc68.png)\n\nApp ID\u3068App Secret\u3092\u5165\u624b\u3057\u307e\u3059(Secret\u306f[show]\u3092\u30af\u30ea\u30c3\u30af\u3059\u308b\u3068\u8868\u793a\u3055\u308c\u307e\u3059)\u3002\n\n![6.png](https://qiita-image-store.s3.amazonaws.com/0/52054/ece2938e-e414-87c4-bdac-328f3f460c71.png)\n\n## \u5b9f\u88c5\nSails.js\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3092\u4f5c\u6210\u3057\u3001\u5fc5\u8981\u306a\u30e2\u30b8\u30e5\u30fc\u30eb\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3002\u4eca\u56de\u306f[Passport.js](http://passportjs.org/)\u3068\u3044\u3046\u8a8d\u8a3c\u3092\u8acb\u3051\u8ca0\u3063\u3066\u304f\u308c\u308b\u30e2\u30b8\u30e5\u30fc\u30eb\u3092\u4f7f\u3044\u307e\u3059\u3002Passport.js\u306fStrategy(\u8a8d\u8a3c\u65b9\u6cd5)\u3092\u8272\u3005\u306a\u3082\u306e\u306b\u5207\u308a\u66ff\u3048\u308b\u3053\u3068\u304c\u51fa\u6765\u307e\u3059\u3002\u4eca\u56de\u306fFacebookAuth\u3092\u4f7f\u3046\u306e\u3067\u3001passport-facebook\u3082\u4e00\u7dd2\u306b\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3002\n\n```\n$ sails new facebook-auth-test\n$ cd facebook-auth-test\n$ npm install passport --save\n$ npm install passport-facebook --save\n```\n\n\u305d\u308c\u305e\u308c\u5fc5\u8981\u306aController/Model\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n```\n$ sails generate api user\n$ sails generate controller auth\n$ sails generate controller page\n```\n\n### Facebook\u30e2\u30b8\u30e5\u30fc\u30eb\n\u30ed\u30b0\u30a4\u30f3\u7528\u30e2\u30b8\u30e5\u30fc\u30eb\u3067\u3059\u3002\u6628\u4eca\u306e\u30b5\u30fc\u30d3\u30b9\u3060\u3068Facebook/twitter/google\u306a\u3069\u591a\u69d8\u306a\u30b5\u30fc\u30d3\u30b9\u3067\u30ed\u30b0\u30a4\u30f3\u3059\u308b\u3053\u3068\u304c\u51fa\u6765\u307e\u3059\u306d\u3002\u305d\u306e\u3088\u3046\u306a\u62e1\u5f35\u6027\u3082\u8003\u3048\u3001Signin\u3068\u3044\u3046\u30e2\u30b8\u30e5\u30fc\u30eb\u306bfacebook\u30ed\u30b0\u30a4\u30f3\u7528\u95a2\u6570\u3092\u66f8\u3044\u3066\u3044\u307e\u3059\u3002\n\n``` api/services/Signin.js\nmodule.exports = (function(){\n  var passport = require('passport');\n  var FacebookStrategy = require('passport-facebook').Strategy;\n\n  passport.use(new FacebookStrategy({\n      clientID : \"xxxxxxxxxxxxxxxxxxxxxxxx\",\n      clientSecret: \"xxxxxxxxxxxxxxxxxx\",\n      callbackURL: \"/auth/facebook/callback\"\n    },\n    function(accessToken, refreshToken, profile, done) {\n\n      var id = profile.id;\n      var username = profile.displayName;\n      var icon = 'https://graph.facebook.com/' + id + '/picture?width=320&height=320';\n\n      User.signinOrSignup(\"facebook\", id, {name: username, icon: icon}, function(err, user) {\n        return done(err, user);\n      });\n    })\n  );\n\n  var facebook = function(req, res, callback) {\n    passport.authenticate('facebook', {}, function(err, user) {\n      if (user) {\n        req.session.authenticated = true;\n        req.session.user_id = user.id;\n      }\n\n      callback(err, user);\n    })(req, res);\n  };\n\n  return {\n    facebook: facebook\n  };\n})();\n```\n\n\u5730\u5473\u306b\u91cd\u8981\u306a\u3068\u3053\u308d\u304c\u3053\u3053\u3002\u8a8d\u8a3c\u6e08\u307f\u30d5\u30e9\u30b0\u3002\n\n```\nreq.session.authenticated = true;\n```\n\n### \u30ed\u30b0\u30a4\u30f3API\n\n\u30ed\u30b0\u30a4\u30f3\u7528API\u3067\u3059\u3002\u7279\u306b\u8907\u96d1\u306a\u3053\u3068\u306f\u306a\u304f\u3001\u30ed\u30b0\u30a4\u30f3\u3067\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3057\u305f\u3089/login\u306b\u30ea\u30c0\u30a4\u30ec\u30af\u30c8\u3057\u3001\u6210\u529f\u3057\u305f\u5834\u5408\u306f\u30eb\u30fc\u30c8\u306b\u5165\u308b\u3002\n\n``` api/controllers/AuthController.js\nmodule.exports = {\n  facebook : function(req, res) {\n\n    SignIn.facebook(req, res, function(err, user) {\n      if (err) {\n        res.redirect('/login');\n      }\n      else {\n        res.redirect('/');\n       }\n    });\n  },\n  facebookCallback : function(req, res) {\n    passport.authenticate('facebook', {\n      successRedirect: '/',\n      failureRedirect: '/login' }\n    );\n  }\n};\n```\n\n### User\u30e2\u30c7\u30eb\n\u30e6\u30fc\u30b6\u30e2\u30c7\u30eb\u3002attributes\u306e\u30dd\u30a4\u30f3\u30c8\u3068\u3057\u3066\u306f\u3001\u8a8d\u8a3c\u60c5\u5831(auth)\u3092\u914d\u5217\u3067\u6301\u3063\u3066\u3044\u308b\u4e8b\u3002\u5148\u307b\u3069\u3082\u5c11\u3057\u89e6\u308c\u305f\u3088\u3046\u306b\u3001\u5c06\u6765\u7684\u306b\u5225\u306e\u65b9\u6cd5\u3067\u3082\u30ed\u30b0\u30a4\u30f3\u51fa\u6765\u308b\u3088\u3046\u306b\u3068\u8003\u3048\u305f\u7d50\u679c\u3053\u3046\u306a\u308a\u307e\u3057\u305f\u3002`signinOrSignup()`\u306f\u9762\u5012\u306a\u306e\u3067\u767b\u9332/\u30ed\u30b0\u30a4\u30f3\u3092\u540c\u6642\u306b\u3057\u3061\u3083\u3063\u305f\u95a2\u6570\u3002\n\n``` api/models/User.js\nmodule.exports = {\n\n  attributes: {\n    auth: 'json',\n    name: {\n      type: 'string'\n    },\n    icon: {\n      type: 'string'\n    }\n  },\n  signinOrSignup : function(auth, id, data, callback) {\n    var query = {};\n    query[\"auth.\" + auth] = id;\n    User.findOne(query).exec(function(err, user) {\n      if (err) {\n        return callback(\"ERROR, find User\");\n      }\n\n      if (user) {\n        return callback(null, user);\n      }\n\n      // SignUp\n      data.auth = {};\n      data.auth[auth] = id;\n      User.create(data).exec(function(err, user) {\n\n        if (err) {\n          return callback(\"ERROR, create User\");\n        }\n\n        return callback(null, user);\n      });\n    });\n  }\n};\n```\n\n### \u516c\u958b/\u975e\u516c\u958b\u8a2d\u5b9a\n\u3069\u306e\u30da\u30fc\u30b8/API\u3092\u516c\u958b\u3059\u308b\u304b\u3068\u3044\u3046\u8a2d\u5b9a\u306fpolicies.js\u306b\u66f8\u304d\u307e\u3059\u3002\u4e00\u756a\u6700\u521d\u306b\u30ef\u30a4\u30eb\u30c9\u30ab\u30fc\u30c9\u3067\u3059\u3079\u3066\u8a8d\u8a3c\u5fc5\u9808\u306b\u3057\u3001\u305d\u306e\u5f8c\u306b\u30ed\u30b0\u30a4\u30f3\u7121\u3057\u3067\u3082\u516c\u958b\u3059\u308bController/Action\u306b\u3064\u3044\u3066true\u306b\u3057\u3066\u3044\u304d\u307e\u3059\u3002\n\u3061\u306a\u307f\u306b\u6700\u521d\u306b\u8a2d\u5b9a\u3057\u3066\u3044\u308b`sessionAuth`\u306f\u3001`api/policies/sessionAuth.js`\u3067\u3059\u3002\u3064\u307e\u308a\u3001API\u3054\u3068\u306b\u8a8d\u8a3c\u65b9\u6cd5\u3082\u5909\u3048\u3089\u308c\u308b\u3068\u3044\u3046\u308f\u3051\u3002\u3069\u3053\u3067\u4f7f\u3046\u304b\u306f\u308f\u304b\u308a\u307e\u305b\u3093\u3051\u3069\u3002\n\n``` config/policies.js\nmodule.exports.policies = {\n\n  '*' : 'sessionAuth',\n\n  PageController : {\n    login : true\n  },\n\n  AuthController : {\n    facebook : true\n  }\n};\n```\n\n### \u30da\u30fc\u30b8\u306e\u8868\u793a\n\u57fa\u672c\u7684\u306b\u30da\u30fc\u30b8\u3092\u8868\u793a\u3059\u308b\u3060\u3051\u306a\u3089\u5b9f\u88c5\u306f\u4f55\u3082\u3044\u3089\u306a\u3044\u306f\u305a\u3067\u3059\u304c\u3001policies\u306b\u3088\u308b\u30d5\u30a3\u30eb\u30bf\u3092\u304b\u3051\u308b\u3070\u3042\u3044\u3001Controller\u3092\u7d4c\u7531\u3057\u306a\u3044\u3068\u6b63\u5e38\u306b\u52d5\u304d\u307e\u305b\u3093\u3002(Controller\u3092\u901a\u3055\u305a\u306b\u51fa\u6765\u308b\u65b9\u6cd5\u3042\u308c\u3070\u6559\u3048\u3066\u4e0b\u3055\u3044!)\n\u306a\u306e\u3067\u30ed\u30b0\u30a4\u30f3\u30da\u30fc\u30b8\u3068\u30ed\u30b0\u30a4\u30f3\u5f8c\u30da\u30fc\u30b8\u3092\u8868\u793a\u3059\u308bAction\u3092\u8ffd\u52a0\u3002\u3064\u3044\u3067\u306b\u30ed\u30b0\u30a4\u30f3\u5f8c\u306b\u306fFacebook\u304b\u3089\u53d6\u3063\u3066\u304d\u305f\u30e6\u30fc\u30b6\u540d\u3068\u30a2\u30a4\u30b3\u30f3\u3092\u8868\u793a\u3057\u307e\u3057\u3087\u3046\u3002\n\n``` api/controllers/PageController.js\nmodule.exports = {\n  login: function(req, res) {\n    res.view('login');\n  },\n  index: function(req, res) {\n    var userId = req.session.user_id;\n\n    User.findOne(userId).exec(function(err, user) {\n      if (err) res.send(500);\n\n      res.view('index', {\n        user: user\n      });\n    });\n  }\n};\n```\n\n### \u5f8c\u306f\u7d30\u3005\u3057\u305f\u3082\u306e\u3092\n\n``` config/routes.js\n  'GET /': {\n    controller : 'Page',\n    action : 'index'\n  },\n\n  'GET /login' : {\n    controller : 'Page',\n    action : 'login'\n  },\n```\n\n``` views/index.ejs\n<div>\n  <h1><%= user.name %></h1>\n  <img src='<%= user.icon %>' />\n</div>\n```\n\n``` views.login.ejs\n<h2>Facebook Login</h2>\n<a href=\"/auth/facebook\">Login</a>\n```\n\n## \u52d5\u304b\u3057\u3066\u307f\u308b\n\u307e\u305a\u306flocalhost/\u306b\u30a2\u30af\u30bb\u30b9\u3057\u3066\u307f\u308b\u3068...\n\u306a\u3093\u304b\u967d\u6c17\u306aForbidden\u304c\u51fa\u307e\u3057\u305f\u3002\n\n![7.png](https://qiita-image-store.s3.amazonaws.com/0/52054/3c1347eb-d758-9d40-9f92-9b9b0a6bf0e0.png)\n\n\u305d\u308c\u306a\u3089\u3068localhost/login\u304b\u3089[Login]\u3092\u30af\u30ea\u30c3\u30af\u3059\u308b\u3068...\n\n![8.png](https://qiita-image-store.s3.amazonaws.com/0/52054/8d13c5e5-b825-2b48-975f-1ed0136727d4.png)\n\nFacebook\u306b\u9077\u79fb\u3057\u3066\u8a8d\u8a3c\u5f8c\u3001\u7121\u4e8blocalhost/\u304c\u8868\u793a\u3055\u308c\u307e\u3057\u305f!\n\n![9.png](https://qiita-image-store.s3.amazonaws.com/0/52054/a142cddb-90f9-2a6d-fba0-a809d46bb72c.png)\n", "tags": ["Sails.js"]}