{"context": "\u5b9f\u884c\u3059\u308b\u3068\u5168Web application\u306e\u30ef\u30fc\u30af\u30d5\u30ed\u30fc\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u72b6\u614b\u3092\u30bf\u30d6\u533a\u5207\u308a\u30c6\u30ad\u30b9\u30c8\u3067\u51fa\u529b\u3057\u307e\u3059\u3002\n\u6bce\u65e5\u30d0\u30c3\u30c1\u5b9f\u884c\u3068\u304b\u3057\u3066\u76e3\u8996\u5bfe\u8c61\u306b\u3059\u308b\u3068\u30a8\u30e9\u30fc\u306e\u30ad\u30e3\u30c3\u30c1\u30a2\u30c3\u30d7\u3084\u3001\u969c\u5bb3\u5206\u6790\u306b\u308f\u308a\u3068\u4fbf\u5229\u3002\n\nif((Get-PSSnapin Microsoft.SharePoint.Powershell) -eq $null)\n{\n    Add-PSSnapin Microsoft.SharePoint.Powershell\n}\n\n#####################  \u8a2d\u5b9a ########################################\n\n$ReportPath = \"C:\\\" #\u7d50\u679c\u3092\u4fdd\u5b58\u3057\u305f\u3044\u30d1\u30b9\u3092\u3044\u308c\u3068\u304f\n\n###################################################################\n\n\n\n\n$Reportname = \"Report_\" + (get-date -Format \"yyyyMMdd_HHmmss\") + '.log'\n$ReportFullPath = Join-Path $ReportPath $Reportname\n\n$arrHeader = @('WebURL','List URL','ListTitle','Item Title','Item ID','Item Last Modified','Item Last Editor','Workflow.ParentAssociation.Name','Workflow.StatusText','Workflow.StatusValue','Workflow.StatusUrl','Workflow.IsLocked','Workflow.IsCompleted','Workflow.InternalState','Workflow.Created','Workflow.Modified','Workflow.AuthorUser')\n\n$arrHeader -join \"`t\" | Out-File -FilePath $ReportFullPath -Append \n\nforeach ($wa in get-spwebapplication)\n{\n    #WebApp\n    foreach($oSites in $wa.Sites)\n    {\n        #sites\n        foreach($oWeb in $oSites.AllWebs)\n        {\n            #Web\n            foreach($oList in $oWeb.Lists)\n            {\n                #List\n                if($oList.WorkflowAssociations.Count -gt 0)\n                {\n                    foreach($oItem in $oList.Items)\n                    {\n                        #Item\n                        foreach($Workflow in $oItem.Workflows)\n                        {\n                            $Log = @($oWeb.Url ,$oList.DefaultViewUrl,$oList.Title , $oItem.Title, $oItem.ID,$oItem['Modified'],$oItem['Editor'],$Workflow.ParentAssociation.Name,$workflow.StatusText,$Workflow.StatusValue,(($oWeb.URL).Trim()+'/'+($Workflow.StatusUrl).Trim()),$Workflow.IsLocked,$Workflow.IsCompleted,$Workflow.InternalState,$Workflow.Created,$Workflow.Modified,$Workflow.AuthorUser)\n                            write-host ( $Log -join \"`t\" )\n                            $Log -join \"`t\" | Out-File -FilePath $ReportFullPath -Append \n                        }\n                    }\n                }\n            }\n        }\n    }\n}\n\n\u304a\u307e\u3051\n\u30ed\u30b0\u30ed\u30fc\u30c6\u30fc\u30b7\u30e7\u30f3\u3057\u305f\u3044\u3068\u304d\u306f\u3053\u3093\u306a\u611f\u3058\u306e\u95a2\u6570\u3092\u5b9a\u7fa9\u3057\u3068\u304f\nfunction RotateLog($LogFilePath , $RotateDays)\n{\n        $Logs = ls $LogFilePath -file -filter *.log | ? { ( (Get-Date) - ($_.LastWriteTime) ).Days -gt $RotateDays }\n        if($Logs.Count -gt 0){\n            try{\n                $Logs.Delete()\n                }catch [exception]{\n                    throw ($error[0])\n                }\n        }\n}\nRotateLog -LogFilePath $ReportPath -RotateDays 20 # \u30ed\u30b0\u30d5\u30a1\u30a4\u30eb\u306e\u30d1\u30b9\u3068\u30ed\u30fc\u30c6\u30fc\u30b7\u30e7\u30f3\u9593\u9694(\u65e5)\u3092\u6e21\u3059\n\n\n\u5b9f\u884c\u3059\u308b\u3068\u5168Web application\u306e\u30ef\u30fc\u30af\u30d5\u30ed\u30fc\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u72b6\u614b\u3092\u30bf\u30d6\u533a\u5207\u308a\u30c6\u30ad\u30b9\u30c8\u3067\u51fa\u529b\u3057\u307e\u3059\u3002\n\u6bce\u65e5\u30d0\u30c3\u30c1\u5b9f\u884c\u3068\u304b\u3057\u3066\u76e3\u8996\u5bfe\u8c61\u306b\u3059\u308b\u3068\u30a8\u30e9\u30fc\u306e\u30ad\u30e3\u30c3\u30c1\u30a2\u30c3\u30d7\u3084\u3001\u969c\u5bb3\u5206\u6790\u306b\u308f\u308a\u3068\u4fbf\u5229\u3002\n\n```\n\nif((Get-PSSnapin Microsoft.SharePoint.Powershell) -eq $null)\n{\n    Add-PSSnapin Microsoft.SharePoint.Powershell\n}\n\n#####################  \u8a2d\u5b9a ########################################\n\n$ReportPath = \"C:\\\" #\u7d50\u679c\u3092\u4fdd\u5b58\u3057\u305f\u3044\u30d1\u30b9\u3092\u3044\u308c\u3068\u304f\n\n###################################################################\n\n\n\n\n$Reportname = \"Report_\" + (get-date -Format \"yyyyMMdd_HHmmss\") + '.log'\n$ReportFullPath = Join-Path $ReportPath $Reportname\n\n$arrHeader = @('WebURL','List URL','ListTitle','Item Title','Item ID','Item Last Modified','Item Last Editor','Workflow.ParentAssociation.Name','Workflow.StatusText','Workflow.StatusValue','Workflow.StatusUrl','Workflow.IsLocked','Workflow.IsCompleted','Workflow.InternalState','Workflow.Created','Workflow.Modified','Workflow.AuthorUser')\n\n$arrHeader -join \"`t\" | Out-File -FilePath $ReportFullPath -Append \n\nforeach ($wa in get-spwebapplication)\n{\n    #WebApp\n    foreach($oSites in $wa.Sites)\n    {\n        #sites\n        foreach($oWeb in $oSites.AllWebs)\n        {\n            #Web\n            foreach($oList in $oWeb.Lists)\n            {\n                #List\n                if($oList.WorkflowAssociations.Count -gt 0)\n                {\n                    foreach($oItem in $oList.Items)\n                    {\n                        #Item\n                        foreach($Workflow in $oItem.Workflows)\n                        {\n                            $Log = @($oWeb.Url ,$oList.DefaultViewUrl,$oList.Title , $oItem.Title, $oItem.ID,$oItem['Modified'],$oItem['Editor'],$Workflow.ParentAssociation.Name,$workflow.StatusText,$Workflow.StatusValue,(($oWeb.URL).Trim()+'/'+($Workflow.StatusUrl).Trim()),$Workflow.IsLocked,$Workflow.IsCompleted,$Workflow.InternalState,$Workflow.Created,$Workflow.Modified,$Workflow.AuthorUser)\n                            write-host ( $Log -join \"`t\" )\n                            $Log -join \"`t\" | Out-File -FilePath $ReportFullPath -Append \n                        }\n                    }\n                }\n            }\n        }\n    }\n}\n```\n\n\u304a\u307e\u3051\n\u30ed\u30b0\u30ed\u30fc\u30c6\u30fc\u30b7\u30e7\u30f3\u3057\u305f\u3044\u3068\u304d\u306f\u3053\u3093\u306a\u611f\u3058\u306e\u95a2\u6570\u3092\u5b9a\u7fa9\u3057\u3068\u304f\n\n```\nfunction RotateLog($LogFilePath , $RotateDays)\n{\n        $Logs = ls $LogFilePath -file -filter *.log | ? { ( (Get-Date) - ($_.LastWriteTime) ).Days -gt $RotateDays }\n        if($Logs.Count -gt 0){\n            try{\n                $Logs.Delete()\n                }catch [exception]{\n                    throw ($error[0])\n                }\n        }\n}\nRotateLog -LogFilePath $ReportPath -RotateDays 20 # \u30ed\u30b0\u30d5\u30a1\u30a4\u30eb\u306e\u30d1\u30b9\u3068\u30ed\u30fc\u30c6\u30fc\u30b7\u30e7\u30f3\u9593\u9694(\u65e5)\u3092\u6e21\u3059\n```\n\n\n\n", "tags": ["SharePoint", "PowerShell"]}