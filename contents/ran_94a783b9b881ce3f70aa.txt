{"context": "LINE\u306eBOT API Trial Account \u5148\u774010,000\u540d\u69d8\u307e\u3067\u5148\u884c\u7533\u3057\u8fbc\u307f\u53d7\u4ed8\u4e2d\u3001\u3068\u3044\u3046\u8a00\u8449\u306b\u3064\u3089\u308c\u3066\u767b\u9332\u3057\u305f\u306e\u3067\u8a66\u3057\u3066\u307f\u307e\u3057\u305f\u3002\n\u57fa\u672c\u7684\u306b\u306fbot\u3068\u304a\u53cb\u9054\u306b\u306a\u3063\u3066\u3001bot\u306b\u4f55\u304b\u8a71\u3057\u304b\u3051\u305f\u3089\u7b54\u3048\u308b\u3001\u307f\u305f\u3044\u306a1\u5bfe1\u306e\u5bfe\u8a71\u304c\u60f3\u5b9a\u306e\u3088\u3046\u3067\u3001\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u53d7\u4fe1\u3057\u305f\u3089\u9001\u4fe1\u8005\u306b\u4f55\u304b\u3092\u9001\u308b\u3068\u3044\u3046\u6d41\u308c\u306e\u3088\u3046\u3067\u3059\u3002\n\u306a\u306e\u3067\u3001\u304a\u53cb\u9054\u5168\u54e1\u306b\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u4e00\u6589\u9001\u4fe1\u3001\u3068\u3044\u3046\u3053\u3068\u304c\u3057\u305f\u304b\u3063\u305f\u306e\u3067\u3059\u304c\u3001\u53cb\u9054\u306eID\u4e00\u89a7\u53d6\u5f97\u3001\u307f\u305f\u3044\u306e\u304c\u306a\u3044\u306e\u3067\u3001\u304a\u53cb\u9054\u306b\u306a\u3063\u305f\u6642(operation request\u3092\u53d7\u4fe1\u3057\u305f\u6642)\u306b\u4fdd\u5b58\u3057\u3066\u304a\u304f\u3088\u3046\u306b\u3057\u307e\u3057\u305f\u3002(\u914d\u5217\u3092json_encode\u3057\u3066\u30d5\u30a1\u30a4\u30eb\u306b\u4fdd\u5b58\u3057\u3066\u307e\u3059\u3002)\nLINE\u306eChannels\u7ba1\u7406\u753b\u9762\u307f\u305f\u3044\u306a\u306e\u3067\u81ea\u5206\u306eBOT\u306eChannel ID\u3068\u304bSecret\u3068\u304bMID\u3068\u304b\u3092\u78ba\u8a8d\u3057\u3066\u3001Callback URL \u306b https://myhost.mydomain.jp:443/linebot/rcv \u307f\u305f\u3044\u306b\u53d7\u4fe1\u3059\u308bURL\u3092\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\u8af8\u4e8b\u60c5\u306b\u3088\u308aCodeIgniter2\u3067\u66f8\u3044\u3066\u307e\u3059\u3002\n\ncontrollers/linebot.php\nclass Linebot extends CI_Controller {\n\n    private $_channel_id = '\u81ea\u5206\u306eBOT\u306eChannel ID';\n    private $_channel_secret = '\u81ea\u5206\u306eBOT\u306eChannel Secret';\n    private $_channel_mid = '\u81ea\u5206\u306eBOT\u306eMID';\n\n    private $_allow_ip = '\u30e1\u30c3\u30bb\u30fc\u30b8\u9001\u4fe1\u3092\u8a31\u53ef\u3059\u308bIP\u30a2\u30c9\u30ec\u30b9(\u81ea\u5206\u306eIP\u3068\u304b)';\n    private $_save_path;\n\n    public function __construct()\n    {\n        parent::__construct();\n        $this->_save_path = APPPATH . 'logs/line_friends';\n    }\n\n    public function rcv()\n    {\n        $input = file_get_contents('php://input');\n        log_message('debug', $input);\n        $json = json_decode($input);\n        if ( ! isset($json->result) OR ! is_array($json->result))\n        {\n            log_message('error', 'no result');\n            $this->output->set_status_header('400');\n            return;\n        }\n        foreach ($json->result as $result) {\n            if ( ! isset($result->content->opType))\n            {\n                // operation request\u3058\u3083\u306a\u3044(\u30e1\u30c3\u30bb\u30fc\u30b8\u3068\u304b\u304c\u9001\u3089\u308c\u3066\u304d\u305f)\u5834\u5408\u306f\u30b9\u30bf\u30f3\u30d7\u3092\u30e9\u30f3\u30c0\u30e0\u3067\u8fd4\u3059\n                $this->_send_sticker(rand(1, 17), 1, $result->content->from);\n                continue;\n            }\n            // operation request\u306e\u5834\u5408\n            switch ($result->content->opType)\n            {\n                case 4:\n                    // added as friend\n                    if ($this->_set_friend($result->content->params[0]) !== FALSE) {\n                        $this->_send_text('\u3088\u3046\u3053\u305d\uff01', $result->content->params[0]);\n                    }\n                    break;\n                case 8:\n                    // blocked account\n                    $this->_del_friend($result->content->params[0]);\n                    break;\n            }\n        }\n        $this->output->set_status_header('200');\n    }\n\n    public function snd($msg)\n    {\n        // \u6307\u5b9a\u3057\u305fIP\u304b\u3089\u306e\u30a2\u30af\u30bb\u30b9\u306e\u307f\u8a31\u53ef\u3059\u308b\n        $remote_addr = $this->input->server('HTTP_X_FORWARDED_FOR');\n        if ($remote_addr === FALSE)\n        {\n            $remote_addr = $this->input->server('REMOTE_ADDR');\n        }\n        if (empty($remote_addr))\n        {\n            log_message('error', 'no remote address');\n            show_error('no remote address');\n        }\n        if ($remote_addr !== $this->_allow_ip)\n        {\n            log_message('error', 'invalid access: ' . $remote_addr);\n            show_error('invalid access: ' . $remote_addr);\n        }\n        $this->_send_text(urldecode($msg));\n        $this->output->set_status_header('200');\n    }\n\n    private function _get_friends()\n    {\n        if ( ! file_exists($this->_save_path))\n        {\n            return array();\n        }\n        return json_decode(file_get_contents($this->_save_path));\n    }\n\n    private function _set_friend($mid)\n    {\n        $friends = $this->_get_friends();\n        if ( ! in_array($mid, $friends))\n        {\n            $friends[] = $mid;\n            return file_put_contents($this->_save_path, json_encode($friends));\n        }\n    }\n\n    private function _del_friend($mid)\n    {\n        $friends = $this->_get_friends();\n        if (($key = array_search($mid, $friends)) !== FALSE)\n        {\n            unset($friends[$key]);\n            return file_put_contents($this->_save_path, json_encode(array_values($friends)));\n        }\n    }\n\n    private function _send_text($message, $mid_arr = NULL)\n    {\n        $content = array(\n                'contentType' => 1,\n                'toType' => 1,\n                'text' => $message\n        );\n        return $this->_send_message($content, $mid_arr);\n    }\n\n    private function _send_sticker($stkid, $stkpkgid, $mid_arr = NULL)\n    {\n        $content = array(\n                'contentType' => 8,\n                'toType' => 1,\n                'contentMetadata' => array(\n                        'STKID' => (string)$stkid,\n                        'STKPKGID' => (string)$stkpkgid\n                )\n        );\n        return $this->_send_message($content, $mid_arr);\n    }\n\n    private function _send_message($content, $mid_arr = NULL)\n    {\n        if (is_string($mid_arr))\n        {\n            $mid_arr = array($mid_arr);\n        }\n        elseif (is_null($mid_arr)) {\n            $mid_arr = $this->_get_friends();\n        }\n        if (empty($mid_arr))\n        {\n            return FALSE;\n        }\n        $url = 'https://trialbot-api.line.me/v1/events';\n        $headers = array(\n                'Content-Type: application/json; charser=UTF-8',\n                'X-Line-ChannelID: ' . $this->_channel_id,\n                'X-Line-ChannelSecret: ' . $this->_channel_secret,\n                'X-Line-Trusted-User-With-ACL: ' . $this->_channel_mid\n        );\n        $post = array(\n                'to' => $mid_arr,\n                'toChannel' => 1383378250,\n                'eventType' => '138311608800106203',\n                'content' => $content\n        );\n\n        $ch = curl_init();\n        curl_setopt($ch, CURLOPT_URL, $url);\n        curl_setopt($ch, CURLOPT_POST, TRUE);\n        curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);\n        curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($post, JSON_UNESCAPED_UNICODE));\n        curl_setopt($ch, CURLOPT_RETURNTRANSFER, TRUE);\n        $ret = curl_exec($ch);\n        log_message('debug', $ret);\n        return $ret;\n    }\n}\n\n\n\u306a\u306b\u304b\u8a71\u3057\u304b\u3051\u3089\u308c\u305f\u6642\u306b\u4f55\u3082\u306a\u3044\u306e\u3082\u5bc2\u3057\u3044\u306e\u3067\u300117\u7a2e\u985e\u306e\u30b9\u30bf\u30f3\u30d7\u3092\u30e9\u30f3\u30c0\u30e0\u3067\u8fd4\u3059\u3088\u3046\u306b\u3057\u307e\u3057\u305f\u3002\n(\u30b9\u30bf\u30f3\u30d7\u306eID\u3068\u304b\u306f\u3001API reference\u306bsticker list\u306eExcel\u30d5\u30a1\u30a4\u30eb\u304c\u3042\u308a\u307e\u3059\u3002)\nhttps://myhost.mydomain.jp/linebot/snd/Hello\n\u3068\u304b\u3067\u300eHello\u300f\u3092BOT\u306e\u304a\u53cb\u9054\u5168\u54e1\u306b\u9001\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\u65e5\u672c\u8a9e\u3068\u304b\u8a18\u53f7\u306fURL\u30a8\u30f3\u30b3\u30fc\u30c9\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002(\u65e5\u672c\u8a9e\u306f\u30d6\u30e9\u30a6\u30b6\u304c\u3084\u3063\u3066\u304f\u308c\u308b\u304b\u3082)\ntoType\u304c\u300e1 = user\u300f\u3063\u3066\u66f8\u3044\u3066\u3042\u3063\u3066\u30011\u3057\u304b\u66f8\u3044\u3066\u306a\u3044\u3093\u3060\u3051\u3069\u3001\u4ed6\u306b\u3082\u9055\u3046\u30bf\u30a4\u30d7\u304c\u3042\u308b\u306e\u304b\u3001\u3053\u308c\u304b\u3089\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u308b\u306e\u304b\u2026\u3002\n\u30b0\u30eb\u30fc\u30d7\u306b\u3082\u9001\u4fe1\u3067\u304d\u308b\u3068\u3044\u3044\u3093\u3060\u3051\u3069\u306a\u30fc\u3002\nLINE\u306e[BOT API Trial Account \u5148\u774010,000\u540d\u69d8\u307e\u3067\u5148\u884c\u7533\u3057\u8fbc\u307f\u53d7\u4ed8\u4e2d](https://business.line.me/services/products/4/introduction)\u3001\u3068\u3044\u3046\u8a00\u8449\u306b\u3064\u3089\u308c\u3066\u767b\u9332\u3057\u305f\u306e\u3067\u8a66\u3057\u3066\u307f\u307e\u3057\u305f\u3002\n\n\u57fa\u672c\u7684\u306b\u306fbot\u3068\u304a\u53cb\u9054\u306b\u306a\u3063\u3066\u3001bot\u306b\u4f55\u304b\u8a71\u3057\u304b\u3051\u305f\u3089\u7b54\u3048\u308b\u3001\u307f\u305f\u3044\u306a1\u5bfe1\u306e\u5bfe\u8a71\u304c\u60f3\u5b9a\u306e\u3088\u3046\u3067\u3001\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u53d7\u4fe1\u3057\u305f\u3089\u9001\u4fe1\u8005\u306b\u4f55\u304b\u3092\u9001\u308b\u3068\u3044\u3046\u6d41\u308c\u306e\u3088\u3046\u3067\u3059\u3002\n\u306a\u306e\u3067\u3001\u304a\u53cb\u9054\u5168\u54e1\u306b\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u4e00\u6589\u9001\u4fe1\u3001\u3068\u3044\u3046\u3053\u3068\u304c\u3057\u305f\u304b\u3063\u305f\u306e\u3067\u3059\u304c\u3001\u53cb\u9054\u306eID\u4e00\u89a7\u53d6\u5f97\u3001\u307f\u305f\u3044\u306e\u304c\u306a\u3044\u306e\u3067\u3001\u304a\u53cb\u9054\u306b\u306a\u3063\u305f\u6642(operation request\u3092\u53d7\u4fe1\u3057\u305f\u6642)\u306b\u4fdd\u5b58\u3057\u3066\u304a\u304f\u3088\u3046\u306b\u3057\u307e\u3057\u305f\u3002(\u914d\u5217\u3092json_encode\u3057\u3066\u30d5\u30a1\u30a4\u30eb\u306b\u4fdd\u5b58\u3057\u3066\u307e\u3059\u3002)\n\n[LINE\u306eChannels\u7ba1\u7406\u753b\u9762\u307f\u305f\u3044\u306a\u306e](https://developers.line.me/channels/)\u3067\u81ea\u5206\u306eBOT\u306eChannel ID\u3068\u304bSecret\u3068\u304bMID\u3068\u304b\u3092\u78ba\u8a8d\u3057\u3066\u3001Callback URL \u306b `https://myhost.mydomain.jp:443/linebot/rcv` \u307f\u305f\u3044\u306b\u53d7\u4fe1\u3059\u308bURL\u3092\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\n\u8af8\u4e8b\u60c5\u306b\u3088\u308aCodeIgniter2\u3067\u66f8\u3044\u3066\u307e\u3059\u3002\n\n```php:controllers/linebot.php\nclass Linebot extends CI_Controller {\n\n\tprivate $_channel_id = '\u81ea\u5206\u306eBOT\u306eChannel ID';\n\tprivate $_channel_secret = '\u81ea\u5206\u306eBOT\u306eChannel Secret';\n\tprivate $_channel_mid = '\u81ea\u5206\u306eBOT\u306eMID';\n\n\tprivate $_allow_ip = '\u30e1\u30c3\u30bb\u30fc\u30b8\u9001\u4fe1\u3092\u8a31\u53ef\u3059\u308bIP\u30a2\u30c9\u30ec\u30b9(\u81ea\u5206\u306eIP\u3068\u304b)';\n\tprivate $_save_path;\n\n\tpublic function __construct()\n\t{\n\t\tparent::__construct();\n\t\t$this->_save_path = APPPATH . 'logs/line_friends';\n\t}\n\n\tpublic function rcv()\n\t{\n\t\t$input = file_get_contents('php://input');\n\t\tlog_message('debug', $input);\n\t\t$json = json_decode($input);\n\t\tif ( ! isset($json->result) OR ! is_array($json->result))\n\t\t{\n\t\t\tlog_message('error', 'no result');\n\t\t\t$this->output->set_status_header('400');\n\t\t\treturn;\n\t\t}\n\t\tforeach ($json->result as $result) {\n\t\t\tif ( ! isset($result->content->opType))\n\t\t\t{\n\t\t\t\t// operation request\u3058\u3083\u306a\u3044(\u30e1\u30c3\u30bb\u30fc\u30b8\u3068\u304b\u304c\u9001\u3089\u308c\u3066\u304d\u305f)\u5834\u5408\u306f\u30b9\u30bf\u30f3\u30d7\u3092\u30e9\u30f3\u30c0\u30e0\u3067\u8fd4\u3059\n\t\t\t\t$this->_send_sticker(rand(1, 17), 1, $result->content->from);\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\t// operation request\u306e\u5834\u5408\n\t\t\tswitch ($result->content->opType)\n\t\t\t{\n\t\t\t\tcase 4:\n\t\t\t\t\t// added as friend\n\t\t\t\t\tif ($this->_set_friend($result->content->params[0]) !== FALSE) {\n\t\t\t\t\t\t$this->_send_text('\u3088\u3046\u3053\u305d\uff01', $result->content->params[0]);\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\tcase 8:\n\t\t\t\t\t// blocked account\n\t\t\t\t\t$this->_del_friend($result->content->params[0]);\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t\t$this->output->set_status_header('200');\n\t}\n\n\tpublic function snd($msg)\n\t{\n\t\t// \u6307\u5b9a\u3057\u305fIP\u304b\u3089\u306e\u30a2\u30af\u30bb\u30b9\u306e\u307f\u8a31\u53ef\u3059\u308b\n\t\t$remote_addr = $this->input->server('HTTP_X_FORWARDED_FOR');\n\t\tif ($remote_addr === FALSE)\n\t\t{\n\t\t\t$remote_addr = $this->input->server('REMOTE_ADDR');\n\t\t}\n\t\tif (empty($remote_addr))\n\t\t{\n\t\t\tlog_message('error', 'no remote address');\n\t\t\tshow_error('no remote address');\n\t\t}\n\t\tif ($remote_addr !== $this->_allow_ip)\n\t\t{\n\t\t\tlog_message('error', 'invalid access: ' . $remote_addr);\n\t\t\tshow_error('invalid access: ' . $remote_addr);\n\t\t}\n\t\t$this->_send_text(urldecode($msg));\n\t\t$this->output->set_status_header('200');\n\t}\n\n\tprivate function _get_friends()\n\t{\n\t\tif ( ! file_exists($this->_save_path))\n\t\t{\n\t\t\treturn array();\n\t\t}\n\t\treturn json_decode(file_get_contents($this->_save_path));\n\t}\n\n\tprivate function _set_friend($mid)\n\t{\n\t\t$friends = $this->_get_friends();\n\t\tif ( ! in_array($mid, $friends))\n\t\t{\n\t\t\t$friends[] = $mid;\n\t\t\treturn file_put_contents($this->_save_path, json_encode($friends));\n\t\t}\n\t}\n\n\tprivate function _del_friend($mid)\n\t{\n\t\t$friends = $this->_get_friends();\n\t\tif (($key = array_search($mid, $friends)) !== FALSE)\n\t\t{\n\t\t\tunset($friends[$key]);\n\t\t\treturn file_put_contents($this->_save_path, json_encode(array_values($friends)));\n\t\t}\n\t}\n\n\tprivate function _send_text($message, $mid_arr = NULL)\n\t{\n\t\t$content = array(\n\t\t\t\t'contentType' => 1,\n\t\t\t\t'toType' => 1,\n\t\t\t\t'text' => $message\n\t\t);\n\t\treturn $this->_send_message($content, $mid_arr);\n\t}\n\n\tprivate function _send_sticker($stkid, $stkpkgid, $mid_arr = NULL)\n\t{\n\t\t$content = array(\n\t\t\t\t'contentType' => 8,\n\t\t\t\t'toType' => 1,\n\t\t\t\t'contentMetadata' => array(\n\t\t\t\t\t\t'STKID' => (string)$stkid,\n\t\t\t\t\t\t'STKPKGID' => (string)$stkpkgid\n\t\t\t\t)\n\t\t);\n\t\treturn $this->_send_message($content, $mid_arr);\n\t}\n\n\tprivate function _send_message($content, $mid_arr = NULL)\n\t{\n\t\tif (is_string($mid_arr))\n\t\t{\n\t\t\t$mid_arr = array($mid_arr);\n\t\t}\n\t\telseif (is_null($mid_arr)) {\n\t\t\t$mid_arr = $this->_get_friends();\n\t\t}\n\t\tif (empty($mid_arr))\n\t\t{\n\t\t\treturn FALSE;\n\t\t}\n\t\t$url = 'https://trialbot-api.line.me/v1/events';\n\t\t$headers = array(\n\t\t\t\t'Content-Type: application/json; charser=UTF-8',\n\t\t\t\t'X-Line-ChannelID: ' . $this->_channel_id,\n\t\t\t\t'X-Line-ChannelSecret: ' . $this->_channel_secret,\n\t\t\t\t'X-Line-Trusted-User-With-ACL: ' . $this->_channel_mid\n\t\t);\n\t\t$post = array(\n\t\t\t\t'to' => $mid_arr,\n\t\t\t\t'toChannel' => 1383378250,\n\t\t\t\t'eventType' => '138311608800106203',\n\t\t\t\t'content' => $content\n\t\t);\n\n\t\t$ch = curl_init();\n\t\tcurl_setopt($ch, CURLOPT_URL, $url);\n\t\tcurl_setopt($ch, CURLOPT_POST, TRUE);\n\t\tcurl_setopt($ch, CURLOPT_HTTPHEADER, $headers);\n\t\tcurl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($post, JSON_UNESCAPED_UNICODE));\n\t\tcurl_setopt($ch, CURLOPT_RETURNTRANSFER, TRUE);\n\t\t$ret = curl_exec($ch);\n\t\tlog_message('debug', $ret);\n\t\treturn $ret;\n\t}\n}\n```\n\n\u306a\u306b\u304b\u8a71\u3057\u304b\u3051\u3089\u308c\u305f\u6642\u306b\u4f55\u3082\u306a\u3044\u306e\u3082\u5bc2\u3057\u3044\u306e\u3067\u300117\u7a2e\u985e\u306e\u30b9\u30bf\u30f3\u30d7\u3092\u30e9\u30f3\u30c0\u30e0\u3067\u8fd4\u3059\u3088\u3046\u306b\u3057\u307e\u3057\u305f\u3002\n(\u30b9\u30bf\u30f3\u30d7\u306eID\u3068\u304b\u306f\u3001[API reference](https://developers.line.me/bot-api/api-reference)\u306bsticker list\u306eExcel\u30d5\u30a1\u30a4\u30eb\u304c\u3042\u308a\u307e\u3059\u3002)\n\n`https://myhost.mydomain.jp/linebot/snd/Hello`\n\u3068\u304b\u3067\u300eHello\u300f\u3092BOT\u306e\u304a\u53cb\u9054\u5168\u54e1\u306b\u9001\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\u65e5\u672c\u8a9e\u3068\u304b\u8a18\u53f7\u306fURL\u30a8\u30f3\u30b3\u30fc\u30c9\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002(\u65e5\u672c\u8a9e\u306f\u30d6\u30e9\u30a6\u30b6\u304c\u3084\u3063\u3066\u304f\u308c\u308b\u304b\u3082)\n\ntoType\u304c\u300e1 = user\u300f\u3063\u3066\u66f8\u3044\u3066\u3042\u3063\u3066\u30011\u3057\u304b\u66f8\u3044\u3066\u306a\u3044\u3093\u3060\u3051\u3069\u3001\u4ed6\u306b\u3082\u9055\u3046\u30bf\u30a4\u30d7\u304c\u3042\u308b\u306e\u304b\u3001\u3053\u308c\u304b\u3089\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u308b\u306e\u304b\u2026\u3002\n\u30b0\u30eb\u30fc\u30d7\u306b\u3082\u9001\u4fe1\u3067\u304d\u308b\u3068\u3044\u3044\u3093\u3060\u3051\u3069\u306a\u30fc\u3002\n", "tags": ["Line", "linebot", "api"]}