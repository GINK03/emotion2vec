{"tags": ["haproxy"], "context": "HAProxy\u306b\u3076\u3089\u4e0b\u304c\u308b\u30b5\u30fc\u30d0\u3084\u30b5\u30fc\u30d3\u30b9\u3092\u9ad8\u8ca0\u8377\u6642\u306b\u5b88\u308a\u305f\u3044\u5834\u5408\u3001be_sess_rate \u3068ACL\u3092\u9023\u643a\u3055\u305b\u308b\u3053\u3068\u306b\u3088\u3063\u3066\u3001\u95be\u5024\u3092\u8d85\u3048\u305f\u65b0\u898f\u30bb\u30c3\u30b7\u30e7\u30f3\u3092\u5225\u306e\u30d0\u30c3\u30af\u30a8\u30f3\u30c9\u306b\u6d41\u3059\u3001\u3068\u3044\u3046\u3053\u3068\u304c\u53ef\u80fd\u3067\u3059\u3002\n\u304b\u3093\u305f\u3093\u306b\u69cb\u6210\u3092\u66f8\u304f\u3068\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\u30d0\u30c3\u30af\u30a8\u30f3\u30c9\u306b\u306fNginx\u3092\u4f7f\u7528\u3057\u3066\u3044\u307e\u3059\u3002\n\n\u30b3\u30f3\u30d5\u30a3\u30b0\u306f\u4ee5\u4e0b\u306e\u901a\u308a\u3067\u3059\u3002\u79d2\u9593\u306e\u65b0\u898f\u30bb\u30c3\u30b7\u30e7\u30f3\u306e\u4e0a\u9650\u30921000\u3068\u3057\u3066\u3044\u307e\u3059\u3002\n# \u30d5\u30ed\u30f3\u30c8\u30a8\u30f3\u30c9\u306e\u8a2d\u5b9a\nfrontend frontend_001\n    bind   *:80\n\n    # \u30d0\u30c3\u30af\u30a8\u30f3\u30c9\u306e\u30bb\u30c3\u30b7\u30e7\u30f3\u304c1000\u3092\u8d85\u3048\u305f\u5834\u5408\u3001be_is_busy \u304c\u771f\u3068\u306a\u308b\n    acl be_is_busy be_sess_rate(backend_nginx) gt 1000\n\n    # be_is_busy \u304c\u771f\u306e\u5834\u5408\u306e\u307f\u3001busy\u7528\u30d0\u30c3\u30af\u30a8\u30f3\u30c9\u3092\u4f7f\u7528\u3059\u308b\n    use_backend backend_busy if be_is_busy\n\n    # \u901a\u5e38\u306f\u3001\u30c7\u30d5\u30a9\u30eb\u30c8\u7528\u30d0\u30c3\u30af\u30a8\u30f3\u30c9\u3092\u4f7f\u7528\u3059\u308b\n    default_backend backend_nginx\n\n# \u30c7\u30d5\u30a9\u30eb\u30c8\u7528\u306e\u30d0\u30c3\u30af\u30a8\u30f3\u30c9\nbackend backend_nginx\n    balance   roundrobin\n    server    nginx-001 192.168.100.101:80 \n    server    nginx-002 192.168.100.102:80 \n    server    nginx-003 192.168.100.103:80 \n\n# Busy\u7528\u30d0\u30c3\u30af\u30a8\u30f3\u30c9\nbackend backend_busy\n    balance   roundrobin\n    server    nginx-004 192.168.100.104:80 \n    server    nginx-005 192.168.100.105:80 \n\n\u306a\u304a\u3001be_sess_rate\u306b\u3064\u3044\u3066\u3001\u516c\u5f0f\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u306b\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u8f09\u3063\u3066\u3044\u307e\u3059\n\nbe_sess_rate([]) : integer\n  \u3000Returns an integer value corresponding to the sessions creation rate on the backend, in number of new sessions per second. This is used with ACLs to switch to an alternate backend when an expensive or fragile one reaches too high a session rate, or to limit abuse of service (eg. prevent sucking of an online dictionary). It can also be useful to add this element to logs using a log-format directive.\n\n\u3053\u306e\u4e2d\u306e\u3001\"sessions creation rate\" \u304c\u30d4\u30f3\u3068\u3053\u306a\u304b\u3063\u305f\u306e\u3067\u3059\u304c\u3001\u5b9f\u9a13\u306e\u7d50\u679c\u3001\u79d2\u9593\u306e\u30bb\u30c3\u30b7\u30e7\u30f3\u6570\u306f\u3001\u79d2\u9593\u306e\u30ea\u30af\u30a8\u30b9\u30c8\u6570\u3068\u307b\u307c\u540c\u3058\u3068\u3044\u3046\u3053\u3068\u304c\u308f\u304b\u308a\u307e\u3057\u305f\u3002\n\u306a\u304a\u3001\u30d0\u30c3\u30af\u30a8\u30f3\u30c9\u306eBusy\u7528\u30b5\u30fc\u30d0\u3092\u7528\u610f\u3057\u306a\u304f\u3066\u3082\u3001HAProxy\u81ea\u4f53\u304c\u9759\u7684\u30b3\u30f3\u30c6\u30f3\u30c4\u3092\u8fd4\u7b54\u3059\u308b\u3053\u3068\u3082\u53ef\u80fd\u3067\u3059\u3002\u305d\u306e\u969b\u306f\u3001\u30d0\u30c3\u30af\u30a8\u30f3\u30c9\u3092\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u3059\u308b\u3068\u826f\u3044\u3067\u3057\u3087\u3046\u3002\uff08\u6ce8\u610f\uff1a503\u4ee5\u5916\u306f\u4f7f\u7528\u3067\u304d\u307e\u305b\u3093\uff09\n# Busy\u30b3\u30f3\u30c6\u30f3\u30c4\u3092\u76f4\u63a5\u8fd4\u7b54\nbackend backend_busy\n    mode http\n    errorfile 503 /usr/share/haproxy/busy.http\n\n\u3053\u308c\u3067\u30011\u79d2\u5f53\u305f\u308a1000\u30ea\u30af\u30a8\u30b9\u30c8\u3092\u8d85\u3048\u305f\u3089\u3001\u305d\u306e\u5206\u306fBusy\u3092\u8fd4\u3059\u3001\u3068\u3044\u3046\u3053\u3068\u304c\u3067\u304d\u307e\u3057\u305f\u3002\nHAProxy\u306b\u3076\u3089\u4e0b\u304c\u308b\u30b5\u30fc\u30d0\u3084\u30b5\u30fc\u30d3\u30b9\u3092\u9ad8\u8ca0\u8377\u6642\u306b\u5b88\u308a\u305f\u3044\u5834\u5408\u3001`be_sess_rate` \u3068ACL\u3092\u9023\u643a\u3055\u305b\u308b\u3053\u3068\u306b\u3088\u3063\u3066\u3001\u95be\u5024\u3092\u8d85\u3048\u305f\u65b0\u898f\u30bb\u30c3\u30b7\u30e7\u30f3\u3092\u5225\u306e\u30d0\u30c3\u30af\u30a8\u30f3\u30c9\u306b\u6d41\u3059\u3001\u3068\u3044\u3046\u3053\u3068\u304c\u53ef\u80fd\u3067\u3059\u3002\n\n\u304b\u3093\u305f\u3093\u306b\u69cb\u6210\u3092\u66f8\u304f\u3068\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\u30d0\u30c3\u30af\u30a8\u30f3\u30c9\u306b\u306fNginx\u3092\u4f7f\u7528\u3057\u3066\u3044\u307e\u3059\u3002\n\n![busy.png](https://qiita-image-store.s3.amazonaws.com/0/130972/f37a1c7e-bbe1-c6a0-feaf-2317120b1fb6.png)\n\n\u30b3\u30f3\u30d5\u30a3\u30b0\u306f\u4ee5\u4e0b\u306e\u901a\u308a\u3067\u3059\u3002\u79d2\u9593\u306e\u65b0\u898f\u30bb\u30c3\u30b7\u30e7\u30f3\u306e\u4e0a\u9650\u30921000\u3068\u3057\u3066\u3044\u307e\u3059\u3002\n\n```\n# \u30d5\u30ed\u30f3\u30c8\u30a8\u30f3\u30c9\u306e\u8a2d\u5b9a\nfrontend frontend_001\n    bind   *:80\n\n    # \u30d0\u30c3\u30af\u30a8\u30f3\u30c9\u306e\u30bb\u30c3\u30b7\u30e7\u30f3\u304c1000\u3092\u8d85\u3048\u305f\u5834\u5408\u3001be_is_busy \u304c\u771f\u3068\u306a\u308b\n    acl be_is_busy be_sess_rate(backend_nginx) gt 1000\n\n    # be_is_busy \u304c\u771f\u306e\u5834\u5408\u306e\u307f\u3001busy\u7528\u30d0\u30c3\u30af\u30a8\u30f3\u30c9\u3092\u4f7f\u7528\u3059\u308b\n    use_backend backend_busy if be_is_busy\n\n    # \u901a\u5e38\u306f\u3001\u30c7\u30d5\u30a9\u30eb\u30c8\u7528\u30d0\u30c3\u30af\u30a8\u30f3\u30c9\u3092\u4f7f\u7528\u3059\u308b\n    default_backend backend_nginx\n\n# \u30c7\u30d5\u30a9\u30eb\u30c8\u7528\u306e\u30d0\u30c3\u30af\u30a8\u30f3\u30c9\nbackend backend_nginx\n    balance   roundrobin\n    server    nginx-001 192.168.100.101:80 \n    server    nginx-002 192.168.100.102:80 \n    server    nginx-003 192.168.100.103:80 \n\n# Busy\u7528\u30d0\u30c3\u30af\u30a8\u30f3\u30c9\nbackend backend_busy\n    balance   roundrobin\n    server    nginx-004 192.168.100.104:80 \n    server    nginx-005 192.168.100.105:80 \n```\n\n\u306a\u304a\u3001`be_sess_rate`\u306b\u3064\u3044\u3066\u3001[\u516c\u5f0f\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8](http://www.haproxy.org/download/1.5/doc/configuration.txt)\u306b\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u8f09\u3063\u3066\u3044\u307e\u3059\n\n> **be_sess_rate([<backend>]) : integer**\n  \u3000Returns an integer value corresponding to the sessions creation rate on the backend, in number of new sessions per second. This is used with ACLs to switch to an alternate backend when an expensive or fragile one reaches too high a session rate, or to limit abuse of service (eg. prevent sucking of an online dictionary). It can also be useful to add this element to logs using a log-format directive.\n\n\u3053\u306e\u4e2d\u306e\u3001\"sessions creation rate\" \u304c\u30d4\u30f3\u3068\u3053\u306a\u304b\u3063\u305f\u306e\u3067\u3059\u304c\u3001\u5b9f\u9a13\u306e\u7d50\u679c\u3001\u79d2\u9593\u306e\u30bb\u30c3\u30b7\u30e7\u30f3\u6570\u306f\u3001\u79d2\u9593\u306e\u30ea\u30af\u30a8\u30b9\u30c8\u6570\u3068\u307b\u307c\u540c\u3058\u3068\u3044\u3046\u3053\u3068\u304c\u308f\u304b\u308a\u307e\u3057\u305f\u3002\n\n\u306a\u304a\u3001\u30d0\u30c3\u30af\u30a8\u30f3\u30c9\u306eBusy\u7528\u30b5\u30fc\u30d0\u3092\u7528\u610f\u3057\u306a\u304f\u3066\u3082\u3001HAProxy\u81ea\u4f53\u304c\u9759\u7684\u30b3\u30f3\u30c6\u30f3\u30c4\u3092\u8fd4\u7b54\u3059\u308b\u3053\u3068\u3082\u53ef\u80fd\u3067\u3059\u3002\u305d\u306e\u969b\u306f\u3001\u30d0\u30c3\u30af\u30a8\u30f3\u30c9\u3092\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u3059\u308b\u3068\u826f\u3044\u3067\u3057\u3087\u3046\u3002\uff08\u6ce8\u610f\uff1a503\u4ee5\u5916\u306f\u4f7f\u7528\u3067\u304d\u307e\u305b\u3093\uff09\n\n```\n# Busy\u30b3\u30f3\u30c6\u30f3\u30c4\u3092\u76f4\u63a5\u8fd4\u7b54\nbackend backend_busy\n    mode http\n    errorfile 503 /usr/share/haproxy/busy.http\n```\n\n\u3053\u308c\u3067\u30011\u79d2\u5f53\u305f\u308a1000\u30ea\u30af\u30a8\u30b9\u30c8\u3092\u8d85\u3048\u305f\u3089\u3001\u305d\u306e\u5206\u306fBusy\u3092\u8fd4\u3059\u3001\u3068\u3044\u3046\u3053\u3068\u304c\u3067\u304d\u307e\u3057\u305f\u3002\n"}