{"context": " More than 1 year has passed since last update.\n\n\u53c2\u8003\n\nsql - Rails query through association limited to most recent record_ - Stack Overflow\n\nclass User < ActiveRecord::Base\n  has_many :stamps\n  has_one  :last_stamp, ->{ order(created_at: :desc) }, class_name: 'Stamp'\nend\n\nclass Stamp < ActiveRecord::Base\n  belongs_to :user\n\n  scope :_this_week, -> { where(created_at: Date.today.all_week) }\nend\n\n\u3068\u3044\u3046\u306e\u304c\u3042\u3063\u3066\u3001\u6700\u5f8c\u306eStamp\u304c\u4eca\u9031\u306b\u4f5c\u6210\u3055\u308c\u305fUser\u4e00\u89a7\u3092\u53d6\u5f97\u3057\u305f\u3044\u3068\u3044\u3046\u3068\u304d\nUser.joins(:last_stamp).merge(Stamp._this_week)\n\n\u3068\u66f8\u3044\u3066\u3082\nSELECT \"users\".* FROM \"users\" INNER JOIN \"stamps\" ON \"stamps\".\"user_id\" = \"users\".\"id\" WHERE (\"stamps\".\"created_at\" BETWEEN '2015-12-21' AND '2015-12-27')\n\n\u3068\u3044\u3046\u5177\u5408\u306b\u3001\u666e\u901a\u306bINNER JOIN\u3055\u308c\u3066\u6700\u5f8c\u306eStamp\u4ee5\u5916\u3082\u3072\u3063\u304b\u304b\u3063\u3066\u3057\u307e\u3046\u3002\n\u3053\u3046\u3059\u308b\u3068\u3046\u307e\u304f\u3044\u304f\nUser.joins(:stamps).where('stamps.created_at = (SELECT MAX(stamps.created_at) FROM stamps WHERE stamps.user_id = users.id)').merge(Stamp._this_week).group('users.id')\n\nSELECT \"users\".* FROM \"users\" INNER JOIN \"stamps\" ON \"stamps\".\"user_id\" = \"users\".\"id\" WHERE (stamps.created_at = (SELECT MAX(stamps.created_at) FROM stamps WHERE stamps.user_id = users.id)) AND (\"stamps\".\"created_at\" BETWEEN '2015-12-21' AND '2015-12-27') GROUP BY users.id\n\n### \u53c2\u8003\n+ [sql - Rails query through association limited to most recent record_ - Stack Overflow](http://stackoverflow.com/questions/5247886/rails-query-through-association-limited-to-most-recent-record)\n\n\n\n\n```rb\nclass User < ActiveRecord::Base\n  has_many :stamps\n  has_one  :last_stamp, ->{ order(created_at: :desc) }, class_name: 'Stamp'\nend\n```\n\n```rb\nclass Stamp < ActiveRecord::Base\n  belongs_to :user\n\n  scope :_this_week, -> { where(created_at: Date.today.all_week) }\nend\n```\n\n\u3068\u3044\u3046\u306e\u304c\u3042\u3063\u3066\u3001\u6700\u5f8c\u306eStamp\u304c\u4eca\u9031\u306b\u4f5c\u6210\u3055\u308c\u305fUser\u4e00\u89a7\u3092\u53d6\u5f97\u3057\u305f\u3044\u3068\u3044\u3046\u3068\u304d\n\n```rb\nUser.joins(:last_stamp).merge(Stamp._this_week)\n```\n\n\u3068\u66f8\u3044\u3066\u3082\n\n```sql\nSELECT \"users\".* FROM \"users\" INNER JOIN \"stamps\" ON \"stamps\".\"user_id\" = \"users\".\"id\" WHERE (\"stamps\".\"created_at\" BETWEEN '2015-12-21' AND '2015-12-27')\n```\n\n\u3068\u3044\u3046\u5177\u5408\u306b\u3001\u666e\u901a\u306bINNER JOIN\u3055\u308c\u3066\u6700\u5f8c\u306eStamp\u4ee5\u5916\u3082\u3072\u3063\u304b\u304b\u3063\u3066\u3057\u307e\u3046\u3002\n\n\u3053\u3046\u3059\u308b\u3068\u3046\u307e\u304f\u3044\u304f\n\n```rb\nUser.joins(:stamps).where('stamps.created_at = (SELECT MAX(stamps.created_at) FROM stamps WHERE stamps.user_id = users.id)').merge(Stamp._this_week).group('users.id')\n```\n\n```sql\nSELECT \"users\".* FROM \"users\" INNER JOIN \"stamps\" ON \"stamps\".\"user_id\" = \"users\".\"id\" WHERE (stamps.created_at = (SELECT MAX(stamps.created_at) FROM stamps WHERE stamps.user_id = users.id)) AND (\"stamps\".\"created_at\" BETWEEN '2015-12-21' AND '2015-12-27') GROUP BY users.id\n```\n", "tags": ["ActiveRecord", "Rails"]}