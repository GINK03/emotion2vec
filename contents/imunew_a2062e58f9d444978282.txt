{"tags": ["Symfony2", "doctrine"], "context": " More than 1 year has passed since last update.\n\n\u8981\u70b9\n\u5927\u91cf\u306e\u30c7\u30fc\u30bf\u3092Paginator->paginate() \u3057\u3066\u3044\u308b\u30da\u30fc\u30b8\u306e\u30ec\u30b9\u30dd\u30f3\u30b9\u304c\u3082\u306e\u3059\u3054\u304f\u9045\u3044\u3068\u304d\u306b\u3001\u5bfe\u7b56\u3057\u305f\u3053\u3068\u3092\u66f8\u304d\u307e\u3059\u3002\n\u7d50\u679c\u7684\u306b\uff15\u3064\u306e\u5bfe\u7b56\u3092\u5b9f\u65bd\u3057\u307e\u3057\u305f\u3002\n\nPaginator::paginate\u3067DQL(SQL)\u3092\u5b9f\u884c\u3055\u305b\u306a\u3044\nFORCE INDEX\u3067\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u3092\u5f37\u5236\u7684\u306b\u52b9\u304b\u305b\u308b\n\u4e0d\u5fc5\u8981\u306b\u5927\u304d\u3044\u30b5\u30a4\u30ba\u3092\u78ba\u4fdd\u3057\u3066\u3044\u308b\u30ab\u30e9\u30e0\u306f\u30b5\u30a4\u30ba\u3092\u5c0f\u3055\u304f\u3059\u308b\n\u6700\u5f8c\u306e1\u30da\u30fc\u30b8\u3067LIMIT\u3092\u6700\u5927\u4ef6\u6570\u3088\u308a\u591a\u304f\u8a2d\u5b9a\u3059\u308b\u3068\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u304c\u52b9\u304b\u306a\u3044\u306e\u3067\u4ef6\u6570\u3092\u88dc\u6b63\n\u306f\u3058\u3081\u306b\u4e3b\u30ad\u30fc\u3060\u3051\u3092\u691c\u7d22\u3057\u3066\u3001\u53d6\u5f97\u3057\u305f\u4e3b\u30ad\u30fc\u3067\u660e\u7d30\u3092\u53d6\u5f97\u3059\u308b\n\n\n\u74b0\u5883\n\u5b9f\u969b\u3001\u5bfe\u7b56\u3057\u305f\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u306e\u5404Bundle\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u306a\u3069\u306f\u4e0b\u8a18\u306e\u3068\u304a\u308a\u3067\u3059\u3002\n\uff08\u5168\u3066\u3067\u306f\u3042\u308a\u307e\u305b\u3093\u3002\uff09\nDB\u306fMySQL 5.5\u3092\u4f7f\u7528\u3057\u3066\u3044\u307e\u3059\u3002\n\ncomposer.json\n{\n    \"require\": {\n        \"php\": \">=5.3.3\",\n        \"symfony/symfony\": \"2.3.*\",\n        \"doctrine/orm\": \">=2.2.3,<2.4-dev\",\n        \"knplabs/knp-paginator-bundle\": \"dev-master\",\n    }\n}\n\n\n\nPaginator::paginate\u3067SQL\u3092\u5b9f\u884c\u3055\u305b\u306a\u3044\n\n\u6539\u5584\u3059\u308b\u524d\u306e\u72b6\u6cc1\n\nSomethingRespository.php\nuse Doctrine\\ORM\\EntityRepository;\nuse Knp\\Component\\Pager\\Paginator;\n\nclass SomethingRepository extends EntityRepository {\n\n    public function paginate (Paginator $paginator, $params = array()) {\n\n        $dql = 'SELECT s FROM something s WHERE s.param1 = :param1';\n        $parameters = array(':param1' => 'value1');\n\n        $em = $this->getEntityManager();\n        $query = $em->createQuery($dql);\n        $query->setParameters($binds);\n\n        $pagination = $paginator->paginate(\n            $query,\n            $params['page'] ?: 1,\n            100\n        );      \n\n        return $pagination;\n    }\n}\n\n\n\nsomething.html.twig\n<div class=\"navigation pagination-centered\">\n    {{ knp_pagination_render(pagination) }}\n</div>\n\n\nProfiler\u3067\u78ba\u8a8d\u3057\u3066\u3082\u3089\u3048\u308c\u3070\u3001\u5206\u304b\u308a\u307e\u3059\u304c\u3001$paginator->paginate\u3067\u5b9f\u884c\u3055\u308c\u308bSQL\u306f\u3001\u7121\u99c4\u304c\u591a\u304f\u901f\u5ea6\u3092\u6539\u5584\u3057\u3088\u3046\u3068\u601d\u3063\u3066\u3082\u3001\u5b9f\u88c5\u304c\u96a0\u853d\u3055\u308c\u3066\u3044\u308b\u306e\u3067\u3001\u629c\u672c\u7684\u306a\u89e3\u6c7a\u306f\u96e3\u3057\u3044\u3067\u3059\u3002\n\u3068\u306f\u3044\u3048\u3001twig\u3067knp_pagination_render\u3092\u4f7f\u3063\u3066\u3044\u308b\u5834\u5408\u306f\u3001pagination\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u6e21\u3055\u306a\u3051\u308c\u3070\u3044\u3051\u307e\u305b\u3093\u3002\n\n\u6539\u5584\u3057\u305f\u5f8c\u306e\u72b6\u6cc1\n\nSomethingRespository.php\nuse Doctrine\\ORM\\EntityRepository;\nuse Knp\\Component\\Pager\\Paginator;\nuse Knp\\Bundle\\PaginatorBundle\\Pagination\\SlidingPagination;\n\nclass SomethingRepository extends EntityRepository {\n\n    public function paginate (Paginator $paginator, $params = array()) {\n\n        $dql = 'SELECT s FROM something s WHERE s.param1 = :param1';\n        $parameters = array(':param1' => 'value1');\n\n        $em = $this->getEntityManager();\n\n        // \u5408\u8a08\u4ef6\u6570\u3092\u53d6\u5f97\n        $countDql = 'SELECT COUNT(s) FROM `something` s';\n        $countQuery = $em->createQuery($countDql);\n        $count = $countQuery->getSingleScalarResult();\n\n        // \u660e\u7d30\u3092\u53d6\u5f97\n        $query = $em->createQuery($dql);\n        $query->setParameters($parameters);\n\n        $query->setHint('knp_paginator.count', $count);\n        $page = $params['page'] ?: 1;\n        $query->setMaxResults(100);\n        $query->setFirstResult((($page - 1) * 100));\n        $items = $query->getResult();\n\n        // Pagination\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u30bb\u30c3\u30c8\n        $pagination = $paginator->paginate(array());\n        /* @var $pagination SlidingPagination */\n        $pagination->setCurrentPageNumber($page);\n        $pagination->setItemNumberPerPage(100);\n        $pagination->setTotalItemCount($count);\n        $pagination->setItems($items);\n\n        return $pagination;\n    }\n}\n\n\n\n\u6539\u5584\u30dd\u30a4\u30f3\u30c8\n\n\u5408\u8a08\u4ef6\u6570\u3068\u660e\u7d30\u3092\u305d\u308c\u305e\u308c\u53d6\u5f97\npaginator\u2212>paginate(array())\u3067\u3001\u7a7a\u306epaginator->paginate(array())\u3067\u3001\u7a7a\u306epagination\u3092\u53d6\u5f97\n\u7a7a\u306e$pagination\u306b\u3001setTotalItemCount\u3001setItems\u306a\u3069\u5fc5\u8981\u306a\u30c7\u30fc\u30bf\u3092\u30bb\u30c3\u30c8\u3059\u308b\n\n\n\u7d50\u679c\n\u30af\u30a8\u30ea\u81ea\u4f53\u306e\u898b\u76f4\u3057\u3082\u4e00\u90e8\u5b9f\u65bd\u3057\u30019\u79d2\u307b\u3069\u304b\u304b\u3063\u3066\u3044\u305f\u51e6\u7406\u304c\u30013\u79d2\u307b\u3069\u306b\u6539\u5584\u3057\u307e\u3057\u305f\u3002\n\n\u53c2\u8003\n\nKnpPaginatorBundle/manual_counting.md\n\n\nFORCE INDEX\u3067\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u3092\u5f37\u5236\u7684\u306b\u52b9\u304b\u305b\u308b\n\u6539\u5584\u3057\u305f\u3068\u306f\u3044\u3048\u3001\u307e\u30603\u79d2\u304b\u304b\u308b\u306e\u3067\u3001\u3082\u3046\u5c11\u3057\u9811\u5f35\u308a\u307e\u3059\u3002\nSQL\u306e\u5b9f\u884c\u8a08\u753b\u3092\u78ba\u8a8d\u3057\u3066\u3001\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u304c\u52b9\u3044\u3066\u3044\u306a\u3044\u3053\u3068\u304c\u5206\u304b\u308a\u307e\u3057\u305f\u3002\n\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u3092\u4f5c\u6210\u3057\u305f\u3060\u3051\u3067\u306f\u3001\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u304c\u52b9\u304b\u306a\u3044\u5834\u5408\u306b\u3001FORCE INDEX\u3067\u4f7f\u7528\u3059\u308b\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u3092\u5f37\u5236\u7684\u306b\u6307\u5b9a\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\nIndex Hint Syntax - MySQL\nhttp://dev.mysql.com/doc/refman/5.5/en/index-hints.html\n\u305f\u3060\u3001Doctrine\u306eDQL\u306b\u306f\u3001FORCE INDEX\u306f\u305d\u306e\u307e\u307e\u66f8\u3051\u306a\u3044\u306e\u3067\u3001CustomeOutputWalker\u3092\u4f7f\u3063\u3066\u3001FORCE INDEX\u3092\u52b9\u304b\u305b\u307e\u3059\u3002\n\uff08\u3082\u3046\u751fSQL\u3067\u3044\u3044\u3058\u3083\u3093\u3001\u3063\u3066\u6c17\u3082\u3057\u307e\u3059\u304c...\uff09\n\u4e0b\u8a18\u306egist\u3092\u53c2\u8003\u306b\u5b9f\u88c5\u3057\u3066\u3044\u304d\u307e\u3059\u3002\nUSE INDEX / FORCE INDEX in a Doctrine2 DQL query\n\nSqlWalker\u3092\u7d99\u627f\u3057\u3066\u3001UseIndexWalker\u3092\u4f5c\u6210\n\nMy/SomthingBundle/Query/UseIndexWalker.php\n\nnamespace My/SomthingBundle/Query;\n\nuse Doctrine\\ORM\\Query\\SqlWalker;\n\nclass UseIndexWalker extends SqlWalker\n{\n    const HINT_FORCE_INDEX = 'UseIndexWalker.ForceIndex';\n\n    public function walkFromClause($fromClause)\n    {\n        $result = parent::walkFromClause($fromClause);\n\n        if ($index = $this->getQuery()->getHint(self::HINT_FORCE_INDEX)) {\n            $result = preg_replace('#(\\bFROM\\s*\\w+\\s*\\w+)#', '\\1 FORCE INDEX (' . $index . ')', $result);\n        }\n\n        return $result;\n    }\n}\n\n\nDQL\u304b\u3089SQL\u3092\u751f\u6210\u3059\u308b\u969b\u306b\u3001walkFromClause\u95a2\u6570\u5185\u3067\u3001FROM\u53e5\u306e\u5185\u5bb9\u3092\u5909\u66f4\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\u53c2\u8003\uff09SqlWalker.php\n\n\u5f37\u5236\u7684\u306b\u52b9\u304b\u305b\u305f\u3044\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u3092\u6307\u5b9a\norder by\u3059\u308b\u3068\u304d\u306b\u3001Using filesort\u304c\u767a\u751f\u3057\u3066\u3044\u305f\u306e\u3067\u3001ORDER BY\u53e5\u3067\u6307\u5b9a\u3057\u3066\u3044\u308b\u30ad\u30fc\u3067\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u3092\u4f5c\u6210\u3057\u3001FORCE INDEX\u3067\u305d\u308c\u3092\u5f37\u5236\u7684\u306b\u52b9\u304b\u305b\u307e\u3059\u3002\n\u53c2\u8003\uff09ORDER BY Optimization\n$query->setHint(Query::HINT_CUSTOM_OUTPUT_WALKER, \"My\\\\SomethingBundle\\\\Query\\\\UseIndexWalker\");\n$query->setHint(UseIndexWalker::HINT_FORCE_INDEX, 'index_for_orderby');\n\n\n\u4e0d\u5fc5\u8981\u306b\u5927\u304d\u3044\u30b5\u30a4\u30ba\u3092\u78ba\u4fdd\u3057\u3066\u3044\u308b\u30ab\u30e9\u30e0\u306f\u30b5\u30a4\u30ba\u3092\u5c0f\u3055\u304f\u3059\u308b\n\u5c1a\u3001\u4eca\u56de\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u3092\u65b0\u305f\u306b\u4f5c\u6210\u3059\u308b\u306b\u3042\u305f\u308a\u3001\u4e0d\u5fc5\u8981\u306b\u5927\u304d\u306a\u30b5\u30a4\u30ba\u3092\u78ba\u4fdd\u3057\u3066\u3044\u308b\u30ab\u30e9\u30e0\u304c\u3042\u3063\u305f\u306e\u3067\u3001\u5fc5\u8981\u5341\u5206\u306a\u30b5\u30a4\u30ba\u306b\u5909\u66f4\u3057\u307e\u3057\u305f\u3002\n\u30b3\u30fc\u30c9\u5024\u304c255\u30d0\u30a4\u30c8\u3082\u53d6\u3089\u308c\u3066\u3044\u307e\u3057\u305f\u304c\u3001\u5b9f\u969b\u306b\u306f25\u30d0\u30a4\u30c8\u3067\u5341\u5206\u3067\u3057\u305f\u306e\u3067\u3001\u5909\u66f4\u3057\u3066\u3001\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n`code` varchar(255) NOT NULL DEFAULT ''\n\nALTER TABLE somethind \n    MODIFY code VARCHAR(25) NOT NULL DEFAULT '';\nCREATE INDEX index_for_orderby ON something (code, ...);\n\n\n\u6700\u5f8c\u306e1\u30da\u30fc\u30b8\u3067LIMIT\u3092\u6700\u5927\u4ef6\u6570\u3088\u308a\u591a\u304f\u8a2d\u5b9a\u3059\u308b\u3068\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u304c\u52b9\u304b\u306a\u3044\u306e\u3067\u4ef6\u6570\u3092\u88dc\u6b63\n\u3053\u3053\u307e\u3067\u3067\u3082\u6700\u521d\u306e\u72b6\u614b\u306b\u6bd4\u3079\u308c\u3070\u3060\u3044\u3076\u65e9\u304f\u306a\u3063\u305f\u306e\u3067\u3059\u304c\u3001\u5f8c\u306e\u307b\u3046\u306e\u30da\u30fc\u30b8\u306b\u306a\u308c\u3070\u306a\u308b\u307b\u3069\u9045\u304f\u306a\u308a\u3001100\u4ef6\u3054\u3068\u306e\u30da\u30fc\u30b8\u3067\u6700\u5f8c\u306e1,800\u30da\u30fc\u30b8\u76ee\uff08\u5408\u8a08179,980\u4ef6\uff09\u3067\u306f\u30013\u79d2\u4ee5\u4e0a\u304b\u304b\u308b\u7d50\u679c\u3068\u306a\u3063\u3066\u3044\u307e\u3057\u305f\u3002\n\u3053\u3053\u3067\u3001\u6700\u7d42\u30da\u30fc\u30b8\u306e\u30af\u30a8\u30ea\u3092EXPLAIN\u3059\u308b\u3068\u3001\u306a\u3093\u3068\u5f37\u5236\u7684\u306b\u52b9\u304b\u305b\u305f\u306f\u305a\u306e\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u304c\u52b9\u3044\u3066\u3044\u307e\u305b\u3093\u3002\nSELECT * FROM something FORCE INDEX (index_for_orderby) \nWHERE ...\nORDER BY ...\nLIMIT \n  100 OFFSET 179900\n\nid  select_type table   type    possible_keys   key key_len ref rows    Extra\n1   PRIMARY something   ALL NULL    NULL    NULL    NULL    179991  Using where; Using filesort\n\n\u3053\u3053\u3067\u304b\u306a\u308a\u6642\u9593\u304c\u53d6\u3089\u308c\u307e\u3057\u305f\u3002\n\u304c\u3001LIMIT\u53e5\u306e\u4ef6\u6570\u3092\u6b8b\u308a\u4ef6\u6570\u306b\u3042\u308f\u305b\u3066\u3042\u3052\u308b\u3068\u3001\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u304c\u52b9\u304f\u3088\u3046\u306b\u306a\u308b\u3053\u3068\u306b\u6c17\u4ed8\u304d\u307e\u3057\u305f\u3002\nSELECT * FROM something FORCE INDEX (index_for_orderby) \nWHERE ...\nORDER BY ...\nLIMIT \n  80 OFFSET 179900\n\nid  select_type table   type    possible_keys   key key_len ref rows    Extra\n1   PRIMARY a0_ index   NULL    index_for_orderby   106 NULL    179980  Using where\n\n\u3064\u307e\u308a\u306f\u30b3\u30fc\u30c9\u5074\u3067\u3001\u4e0b\u8a18\u306e\u3088\u3046\u306b\u5bfe\u51e6\u3057\u307e\u3059\u3002\n$page = $params['page'] ?: 1;\n$offset = (($page - 1) * 100);\n$limit = min([100, (int)$count - $offset]);\n$query->setMaxResults($limit);\n$query->setFirstResult($offset);\n\n\n\n\u306f\u3058\u3081\u306b\u4e3b\u30ad\u30fc\u3060\u3051\u3092\u691c\u7d22\u3057\u3066\u3001\u53d6\u5f97\u3057\u305f\u4e3b\u30ad\u30fc\u3067\u660e\u7d30\u3092\u53d6\u5f97\u3059\u308b\n\u6700\u5f8c\u306e1\u30da\u30fc\u30b8\u306b\u95a2\u3057\u3066\u306f\u6570100\u30df\u30ea\u79d2\u6539\u5584\u3057\u305f\u306e\u3067\u3059\u304c\u3001\u307e\u30603\u79d2\u53f0\u3060\u3063\u305f\u306e\u3067\u3001\u3082\u3046\u4e00\u8e0f\u3093\u5f35\u308a\u3057\u307e\u3059\u3002\n\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u30c6\u30b9\u30c8\u3057\u3066\u3044\u308b\u30a4\u30f3\u30d5\u30e9\u30a8\u30f3\u30b8\u30cb\u30a2\u304b\u3089\u4e0b\u8a18\u306e\u63d0\u6848\u304c\u3042\u308a\u307e\u3057\u305f\u3002\n\n\u4e3b\u30ad\u30fc\u3060\u3051\u306e\u691c\u7d22\u306f\u65e9\u3044\n\u5f53\u305f\u308a\u524d\u306a\u8a71\u3067\u306f\u3042\u308b\u306e\u3067\u3059\u304c\u3001\n\nSELECT\u53e5\u306b\u3066\u4e3b\u30ad\u30fc\u3060\u3051\u3092\u6307\u5b9a\u3059\u308b\u3068\u65e9\u304f\u306a\u308b\nWHERE\u53e5\u3067\u4e3b\u30ad\u30fc\u3060\u3051\u3092\u6307\u5b9a\u3059\u308b\u3068\u65e9\u304f\u306a\u308b\n\n\u306a\u306e\u3067\u3001\n\n\u3044\u3063\u305f\u3093\u4e3b\u30ad\u30fc\u3060\u3051\u3092\u691c\u7d22\u3057\n\u305d\u306e\u4e3b\u30ad\u30fc\u3092\u5143\u306b\u660e\u7d30\u3092\u53d6\u5f97\u3059\u308b\n\n\u3068\u30af\u30a8\u30ea\u3092\u5206\u3051\u3066\u306f\u3069\u3046\u304b\u3001\u3068\u3044\u3046\u63d0\u6848\u3067\u3059\u3002\n## \u4e3b\u30ad\u30fc\u3060\u3051\u691c\u7d22\nSELECT id FROM something FORCE INDEX (index_for_orderby) \nWHERE ...\nORDER BY ...\nLIMIT \n  80 OFFSET 179900\n\n## \u4e3b\u30ad\u30fc\u3092\u5143\u306b\u660e\u7d30\u3092\u53d6\u5f97\nSELECT * FROM something\nWHERE id IN (...)\n\n\u3061\u306a\u307f\u306b\u3001IN\u53e5\u3078\u306e\u30d1\u30e9\u30e1\u30fc\u30bf\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u30bb\u30c3\u30c8\u3057\u307e\u3059\u3002\n$query->setParameter('ids', $ids, Connection::PARAM_STR_ARRAY);\n\n\u305f\u3060\u3001\u3053\u308c\u3001Doctrine\u306e\u307b\u3046\u3067\u3082\u3053\u3046\u3044\u3046\u30af\u30a8\u30ea\u30fc\u3092\u5143\u3005\u4f5c\u3063\u3066\u304f\u308c\u3066\u3044\u305f\u6c17\u304c\u3057\u307e\u3059\u3002\u3002\n\u306a\u306e\u3067\u3001SQLWalker\u306a\u3069\u99c6\u4f7f\u3059\u308c\u3070\u3001\u6c4e\u7528\u7684\u306a\u90e8\u5206\u306e\u5b9f\u88c5\u3092\u96a0\u853d\u3057\u305f\u307e\u307e\u30c1\u30e5\u30fc\u30cb\u30f3\u30b0\u3067\u304d\u305f\u306e\u304b\u3082\u3057\u308c\u306a\u3044\u3002\u3002\u3002\uff08\u672a\u691c\u8a3c\uff09\n\n\u7d50\u679c\u3068\u307e\u3068\u3081\n\u6700\u7d42\u7684\u306a\u30bd\u30fc\u30b9\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u308a\u307e\u3057\u305f\u3002\n\nSomethingRespository.php\nuse Doctrine\\ORM\\EntityRepository;\nuse Doctrine\\ORM\\Query;\nuse Knp\\Component\\Pager\\Paginator;\nuse Knp\\Bundle\\PaginatorBundle\\Pagination\\SlidingPagination;\n\nclass SomethingRepository extends EntityRepository {\n\n    public function paginate (Paginator $paginator, $params = array()) {\n\n        $idsDql = 'SELECT s.id FROM something s WHERE s.param1 = :param1';\n        $itemDql = 'SELECT s FROM something s';\n        $parameters = array(':param1' => 'value1');\n\n        $em = $this->getEntityManager();\n\n        // \u5408\u8a08\u4ef6\u6570\u3092\u53d6\u5f97\n        $countDql = 'SELECT COUNT(s) FROM `something` s';\n        $countQuery = $em->createQuery($countDql);\n        $count = $countQuery->getSingleScalarResult();\n\n        // \u4e3b\u30ad\u30fc\u3092\u691c\u7d22\n        $idsQuery = $em->createQuery($idsDql);\n        $idsQuery->setParameters($parameters);\n\n        $idsQuery->setHint('knp_paginator.count', $count);\n        $page = $params['page'] ?: 1;\n        $offset = (($page - 1) * 100);\n        $limit = min([100, (int)$count - $offset]);\n        $idsQuery->setMaxResults($limit);\n        $idsQuery->setFirstResult($offset);\n        $idsQuery->setHint(Query::HINT_CUSTOM_OUTPUT_WALKER, \"My\\\\SomethingBundle\\\\Query\\\\UseIndexWalker\");\n        $idsQuery->setHint(UseIndexWalker::HINT_FORCE_INDEX, 'index_for_orderby');\n\n        $ids = $idsQuery->getArrayResult();\n\n        $items = array();\n        if (!empty($ids)) {\n            $itemDql .= ' WHERE s.id IN (:ids)';\n            $itemQuery = $em->createQuery($itemDql);\n            $itemQuery->setParameter('ids', $ids, Connection::PARAM_STR_ARRAY);\n            $items = $itemQuery->getResult();\n        }\n\n        //Pagination\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u30bb\u30c3\u30c8\n        $pagination = $paginator->paginate(array());\n        /* @var $pagination SlidingPagination */\n        $pagination->setCurrentPageNumber($page);\n        $pagination->setItemNumberPerPage(100);\n        $pagination->setTotalItemCount($count);\n        $pagination->setItems($items);\n\n        return $pagination;\n    }\n}\n\n\n\uff13\u79d2\u53f0\u304b\u30892\u79d2\u53f0\u3078\u306e\u58c1\u304c\u76f8\u5f53\u9ad8\u304b\u3063\u305f\u3067\u3059\u304c\u3001\u306a\u3093\u3068\u304b\u6539\u5584\u3067\u304d\u307e\u3057\u305f\u3002\n\u5f8c\u534a\u306f\u3001KnpPaginatorBundle \u3068\u3044\u3046\u3088\u308a\u3001Doctrine \u3068\u3044\u3046\u304b MySQL \u3068\u306e\u6226\u3044\u306b\u306a\u3063\u3066\u3057\u307e\u3044\u307e\u3057\u305f\u304c\u3001\u4f3c\u305f\u3088\u3046\u306a\u58c1\u306b\u3076\u3061\u3042\u305f\u3063\u305f\u3068\u304d\u306b\u53c2\u8003\u306b\u3057\u3066\u3044\u305f\u3060\u3051\u308b\u3068\u5e78\u3044\u3067\u3059\u3002\n\n## \u8981\u70b9\n\u5927\u91cf\u306e\u30c7\u30fc\u30bf\u3092[Paginator](https://github.com/KnpLabs/knp-components/blob/master/src/Knp/Component/Pager/Paginator.php)->paginate() \u3057\u3066\u3044\u308b\u30da\u30fc\u30b8\u306e\u30ec\u30b9\u30dd\u30f3\u30b9\u304c\u3082\u306e\u3059\u3054\u304f\u9045\u3044\u3068\u304d\u306b\u3001\u5bfe\u7b56\u3057\u305f\u3053\u3068\u3092\u66f8\u304d\u307e\u3059\u3002\n\u7d50\u679c\u7684\u306b\uff15\u3064\u306e\u5bfe\u7b56\u3092\u5b9f\u65bd\u3057\u307e\u3057\u305f\u3002\n\n- Paginator::paginate\u3067DQL(SQL)\u3092\u5b9f\u884c\u3055\u305b\u306a\u3044\n- FORCE INDEX\u3067\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u3092\u5f37\u5236\u7684\u306b\u52b9\u304b\u305b\u308b\n- \u4e0d\u5fc5\u8981\u306b\u5927\u304d\u3044\u30b5\u30a4\u30ba\u3092\u78ba\u4fdd\u3057\u3066\u3044\u308b\u30ab\u30e9\u30e0\u306f\u30b5\u30a4\u30ba\u3092\u5c0f\u3055\u304f\u3059\u308b\n- \u6700\u5f8c\u306e1\u30da\u30fc\u30b8\u3067LIMIT\u3092\u6700\u5927\u4ef6\u6570\u3088\u308a\u591a\u304f\u8a2d\u5b9a\u3059\u308b\u3068\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u304c\u52b9\u304b\u306a\u3044\u306e\u3067\u4ef6\u6570\u3092\u88dc\u6b63\n- \u306f\u3058\u3081\u306b\u4e3b\u30ad\u30fc\u3060\u3051\u3092\u691c\u7d22\u3057\u3066\u3001\u53d6\u5f97\u3057\u305f\u4e3b\u30ad\u30fc\u3067\u660e\u7d30\u3092\u53d6\u5f97\u3059\u308b\n\n\n## \u74b0\u5883\n\u5b9f\u969b\u3001\u5bfe\u7b56\u3057\u305f\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u306e\u5404Bundle\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u306a\u3069\u306f\u4e0b\u8a18\u306e\u3068\u304a\u308a\u3067\u3059\u3002\n\uff08\u5168\u3066\u3067\u306f\u3042\u308a\u307e\u305b\u3093\u3002\uff09\nDB\u306fMySQL 5.5\u3092\u4f7f\u7528\u3057\u3066\u3044\u307e\u3059\u3002\n\n~~~composer.json\n{\n\t\"require\": {\n\t\t\"php\": \">=5.3.3\",\n\t\t\"symfony/symfony\": \"2.3.*\",\n\t\t\"doctrine/orm\": \">=2.2.3,<2.4-dev\",\n\t\t\"knplabs/knp-paginator-bundle\": \"dev-master\",\n\t}\n}\n~~~\n\n## Paginator::paginate\u3067SQL\u3092\u5b9f\u884c\u3055\u305b\u306a\u3044\n### \u6539\u5584\u3059\u308b\u524d\u306e\u72b6\u6cc1\n\n~~~SomethingRespository.php\nuse Doctrine\\ORM\\EntityRepository;\nuse Knp\\Component\\Pager\\Paginator;\n\nclass SomethingRepository extends EntityRepository {\n\n\tpublic function paginate (Paginator $paginator, $params = array()) {\n\n\t\t$dql = 'SELECT s FROM something s WHERE s.param1 = :param1';\n\t\t$parameters = array(':param1' => 'value1');\n\t\t\n\t\t$em = $this->getEntityManager();\n\t\t$query = $em->createQuery($dql);\n\t\t$query->setParameters($binds);\n\n\t\t$pagination = $paginator->paginate(\n\t\t    $query,\n\t\t    $params['page'] ?: 1,\n\t\t    100\n\t\t);\t\t\n\t\t\n\t\treturn $pagination;\n\t}\n}\n~~~\n\n~~~something.html.twig\n<div class=\"navigation pagination-centered\">\n    {{ knp_pagination_render(pagination) }}\n</div>\n~~~\n\nProfiler\u3067\u78ba\u8a8d\u3057\u3066\u3082\u3089\u3048\u308c\u3070\u3001\u5206\u304b\u308a\u307e\u3059\u304c\u3001$paginator->paginate\u3067\u5b9f\u884c\u3055\u308c\u308bSQL\u306f\u3001\u7121\u99c4\u304c\u591a\u304f\u901f\u5ea6\u3092\u6539\u5584\u3057\u3088\u3046\u3068\u601d\u3063\u3066\u3082\u3001\u5b9f\u88c5\u304c\u96a0\u853d\u3055\u308c\u3066\u3044\u308b\u306e\u3067\u3001\u629c\u672c\u7684\u306a\u89e3\u6c7a\u306f\u96e3\u3057\u3044\u3067\u3059\u3002\n\u3068\u306f\u3044\u3048\u3001twig\u3067knp_pagination_render\u3092\u4f7f\u3063\u3066\u3044\u308b\u5834\u5408\u306f\u3001pagination\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u6e21\u3055\u306a\u3051\u308c\u3070\u3044\u3051\u307e\u305b\u3093\u3002\n\n\n### \u6539\u5584\u3057\u305f\u5f8c\u306e\u72b6\u6cc1\n\n~~~SomethingRespository.php\nuse Doctrine\\ORM\\EntityRepository;\nuse Knp\\Component\\Pager\\Paginator;\nuse Knp\\Bundle\\PaginatorBundle\\Pagination\\SlidingPagination;\n\nclass SomethingRepository extends EntityRepository {\n\n\tpublic function paginate (Paginator $paginator, $params = array()) {\n\n\t\t$dql = 'SELECT s FROM something s WHERE s.param1 = :param1';\n\t\t$parameters = array(':param1' => 'value1');\n\n\t\t$em = $this->getEntityManager();\n\n\t\t// \u5408\u8a08\u4ef6\u6570\u3092\u53d6\u5f97\n\t\t$countDql = 'SELECT COUNT(s) FROM `something` s';\n\t\t$countQuery = $em->createQuery($countDql);\n\t\t$count = $countQuery->getSingleScalarResult();\n\n\t\t// \u660e\u7d30\u3092\u53d6\u5f97\n\t\t$query = $em->createQuery($dql);\n\t\t$query->setParameters($parameters);\n\n\t\t$query->setHint('knp_paginator.count', $count);\n\t\t$page = $params['page'] ?: 1;\n\t\t$query->setMaxResults(100);\n\t\t$query->setFirstResult((($page - 1) * 100));\n\t\t$items = $query->getResult();\n\n\t\t// Pagination\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u30bb\u30c3\u30c8\n\t\t$pagination = $paginator->paginate(array());\n\t\t/* @var $pagination SlidingPagination */\n\t\t$pagination->setCurrentPageNumber($page);\n\t\t$pagination->setItemNumberPerPage(100);\n\t\t$pagination->setTotalItemCount($count);\n\t\t$pagination->setItems($items);\n\t\t\n\t\treturn $pagination;\n\t}\n}\n~~~\n\n### \u6539\u5584\u30dd\u30a4\u30f3\u30c8\n- \u5408\u8a08\u4ef6\u6570\u3068\u660e\u7d30\u3092\u305d\u308c\u305e\u308c\u53d6\u5f97\n- $paginator->paginate(array())\u3067\u3001\u7a7a\u306e$pagination\u3092\u53d6\u5f97\n- \u7a7a\u306e$pagination\u306b\u3001setTotalItemCount\u3001setItems\u306a\u3069\u5fc5\u8981\u306a\u30c7\u30fc\u30bf\u3092\u30bb\u30c3\u30c8\u3059\u308b\n\n### \u7d50\u679c\n\u30af\u30a8\u30ea\u81ea\u4f53\u306e\u898b\u76f4\u3057\u3082\u4e00\u90e8\u5b9f\u65bd\u3057\u30019\u79d2\u307b\u3069\u304b\u304b\u3063\u3066\u3044\u305f\u51e6\u7406\u304c\u30013\u79d2\u307b\u3069\u306b\u6539\u5584\u3057\u307e\u3057\u305f\u3002\n\n### \u53c2\u8003\n- [KnpPaginatorBundle/manual_counting.md](https://github.com/KnpLabs/KnpPaginatorBundle/blob/master/Resources/doc/manual_counting.md)\n\n\n## FORCE INDEX\u3067\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u3092\u5f37\u5236\u7684\u306b\u52b9\u304b\u305b\u308b\n\n\u6539\u5584\u3057\u305f\u3068\u306f\u3044\u3048\u3001\u307e\u30603\u79d2\u304b\u304b\u308b\u306e\u3067\u3001\u3082\u3046\u5c11\u3057\u9811\u5f35\u308a\u307e\u3059\u3002\n\nSQL\u306e\u5b9f\u884c\u8a08\u753b\u3092\u78ba\u8a8d\u3057\u3066\u3001\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u304c\u52b9\u3044\u3066\u3044\u306a\u3044\u3053\u3068\u304c\u5206\u304b\u308a\u307e\u3057\u305f\u3002\n\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u3092\u4f5c\u6210\u3057\u305f\u3060\u3051\u3067\u306f\u3001\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u304c\u52b9\u304b\u306a\u3044\u5834\u5408\u306b\u3001FORCE INDEX\u3067\u4f7f\u7528\u3059\u308b\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u3092\u5f37\u5236\u7684\u306b\u6307\u5b9a\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\nIndex Hint Syntax - MySQL\nhttp://dev.mysql.com/doc/refman/5.5/en/index-hints.html\n\n\u305f\u3060\u3001Doctrine\u306eDQL\u306b\u306f\u3001FORCE INDEX\u306f\u305d\u306e\u307e\u307e\u66f8\u3051\u306a\u3044\u306e\u3067\u3001CustomeOutputWalker\u3092\u4f7f\u3063\u3066\u3001FORCE INDEX\u3092\u52b9\u304b\u305b\u307e\u3059\u3002\n\uff08\u3082\u3046\u751fSQL\u3067\u3044\u3044\u3058\u3083\u3093\u3001\u3063\u3066\u6c17\u3082\u3057\u307e\u3059\u304c...\uff09\n\n\u4e0b\u8a18\u306egist\u3092\u53c2\u8003\u306b\u5b9f\u88c5\u3057\u3066\u3044\u304d\u307e\u3059\u3002\n\n[USE INDEX / FORCE INDEX in a Doctrine2 DQL query](https://gist.github.com/arnaud-lb/2704404)\n\n### SqlWalker\u3092\u7d99\u627f\u3057\u3066\u3001UseIndexWalker\u3092\u4f5c\u6210\n\n```My/SomthingBundle/Query/UseIndexWalker.php\n\nnamespace My/SomthingBundle/Query;\n\nuse Doctrine\\ORM\\Query\\SqlWalker;\n\nclass UseIndexWalker extends SqlWalker\n{\n    const HINT_FORCE_INDEX = 'UseIndexWalker.ForceIndex';\n \n    public function walkFromClause($fromClause)\n    {\n        $result = parent::walkFromClause($fromClause);\n \n        if ($index = $this->getQuery()->getHint(self::HINT_FORCE_INDEX)) {\n            $result = preg_replace('#(\\bFROM\\s*\\w+\\s*\\w+)#', '\\1 FORCE INDEX (' . $index . ')', $result);\n        }\n \n        return $result;\n    }\n}\n```\n\nDQL\u304b\u3089SQL\u3092\u751f\u6210\u3059\u308b\u969b\u306b\u3001walkFromClause\u95a2\u6570\u5185\u3067\u3001FROM\u53e5\u306e\u5185\u5bb9\u3092\u5909\u66f4\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\n[\u53c2\u8003\uff09SqlWalker.php](\nhttps://github.com/doctrine/doctrine2/blob/master/lib/Doctrine/ORM/Query/SqlWalker.php)\n\n### \u5f37\u5236\u7684\u306b\u52b9\u304b\u305b\u305f\u3044\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u3092\u6307\u5b9a\n\norder by\u3059\u308b\u3068\u304d\u306b\u3001Using filesort\u304c\u767a\u751f\u3057\u3066\u3044\u305f\u306e\u3067\u3001ORDER BY\u53e5\u3067\u6307\u5b9a\u3057\u3066\u3044\u308b\u30ad\u30fc\u3067\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u3092\u4f5c\u6210\u3057\u3001FORCE INDEX\u3067\u305d\u308c\u3092\u5f37\u5236\u7684\u306b\u52b9\u304b\u305b\u307e\u3059\u3002\n\n[\u53c2\u8003\uff09ORDER BY Optimization](\nhttp://dev.mysql.com/doc/refman/5.6/en/order-by-optimization.html)\n\n```\n$query->setHint(Query::HINT_CUSTOM_OUTPUT_WALKER, \"My\\\\SomethingBundle\\\\Query\\\\UseIndexWalker\");\n$query->setHint(UseIndexWalker::HINT_FORCE_INDEX, 'index_for_orderby');\n```\n\n## \u4e0d\u5fc5\u8981\u306b\u5927\u304d\u3044\u30b5\u30a4\u30ba\u3092\u78ba\u4fdd\u3057\u3066\u3044\u308b\u30ab\u30e9\u30e0\u306f\u30b5\u30a4\u30ba\u3092\u5c0f\u3055\u304f\u3059\u308b\n\n\u5c1a\u3001\u4eca\u56de\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u3092\u65b0\u305f\u306b\u4f5c\u6210\u3059\u308b\u306b\u3042\u305f\u308a\u3001\u4e0d\u5fc5\u8981\u306b\u5927\u304d\u306a\u30b5\u30a4\u30ba\u3092\u78ba\u4fdd\u3057\u3066\u3044\u308b\u30ab\u30e9\u30e0\u304c\u3042\u3063\u305f\u306e\u3067\u3001\u5fc5\u8981\u5341\u5206\u306a\u30b5\u30a4\u30ba\u306b\u5909\u66f4\u3057\u307e\u3057\u305f\u3002\n\u30b3\u30fc\u30c9\u5024\u304c255\u30d0\u30a4\u30c8\u3082\u53d6\u3089\u308c\u3066\u3044\u307e\u3057\u305f\u304c\u3001\u5b9f\u969b\u306b\u306f25\u30d0\u30a4\u30c8\u3067\u5341\u5206\u3067\u3057\u305f\u306e\u3067\u3001\u5909\u66f4\u3057\u3066\u3001\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n```\n`code` varchar(255) NOT NULL DEFAULT ''\n```\n\n```SQL\nALTER TABLE somethind \n\tMODIFY code VARCHAR(25) NOT NULL DEFAULT '';\nCREATE INDEX index_for_orderby ON something (code, ...);\n```\n\n## \u6700\u5f8c\u306e1\u30da\u30fc\u30b8\u3067LIMIT\u3092\u6700\u5927\u4ef6\u6570\u3088\u308a\u591a\u304f\u8a2d\u5b9a\u3059\u308b\u3068\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u304c\u52b9\u304b\u306a\u3044\u306e\u3067\u4ef6\u6570\u3092\u88dc\u6b63\n\n\u3053\u3053\u307e\u3067\u3067\u3082\u6700\u521d\u306e\u72b6\u614b\u306b\u6bd4\u3079\u308c\u3070\u3060\u3044\u3076\u65e9\u304f\u306a\u3063\u305f\u306e\u3067\u3059\u304c\u3001\u5f8c\u306e\u307b\u3046\u306e\u30da\u30fc\u30b8\u306b\u306a\u308c\u3070\u306a\u308b\u307b\u3069\u9045\u304f\u306a\u308a\u3001100\u4ef6\u3054\u3068\u306e\u30da\u30fc\u30b8\u3067\u6700\u5f8c\u306e1,800\u30da\u30fc\u30b8\u76ee\uff08\u5408\u8a08179,980\u4ef6\uff09\u3067\u306f\u30013\u79d2\u4ee5\u4e0a\u304b\u304b\u308b\u7d50\u679c\u3068\u306a\u3063\u3066\u3044\u307e\u3057\u305f\u3002\n\n\u3053\u3053\u3067\u3001\u6700\u7d42\u30da\u30fc\u30b8\u306e\u30af\u30a8\u30ea\u3092EXPLAIN\u3059\u308b\u3068\u3001\u306a\u3093\u3068\u5f37\u5236\u7684\u306b\u52b9\u304b\u305b\u305f\u306f\u305a\u306e\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u304c\u52b9\u3044\u3066\u3044\u307e\u305b\u3093\u3002\n\n```SQL\nSELECT * FROM something FORCE INDEX (index_for_orderby) \nWHERE ...\nORDER BY ...\nLIMIT \n  100 OFFSET 179900\n```\n\n```\nid\tselect_type\ttable\ttype\tpossible_keys\tkey\tkey_len\tref\trows\tExtra\n1\tPRIMARY\tsomething\tALL\tNULL\tNULL\tNULL\tNULL\t179991\tUsing where; Using filesort\n```\n\n\u3053\u3053\u3067\u304b\u306a\u308a\u6642\u9593\u304c\u53d6\u3089\u308c\u307e\u3057\u305f\u3002\n\u304c\u3001LIMIT\u53e5\u306e\u4ef6\u6570\u3092\u6b8b\u308a\u4ef6\u6570\u306b\u3042\u308f\u305b\u3066\u3042\u3052\u308b\u3068\u3001\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u304c\u52b9\u304f\u3088\u3046\u306b\u306a\u308b\u3053\u3068\u306b\u6c17\u4ed8\u304d\u307e\u3057\u305f\u3002\n\n```SQL\nSELECT * FROM something FORCE INDEX (index_for_orderby) \nWHERE ...\nORDER BY ...\nLIMIT \n  80 OFFSET 179900\n```\n\n```\nid\tselect_type\ttable\ttype\tpossible_keys\tkey\tkey_len\tref\trows\tExtra\n1\tPRIMARY\ta0_\tindex\tNULL\tindex_for_orderby\t106\tNULL\t179980\tUsing where\n```\n\n\u3064\u307e\u308a\u306f\u30b3\u30fc\u30c9\u5074\u3067\u3001\u4e0b\u8a18\u306e\u3088\u3046\u306b\u5bfe\u51e6\u3057\u307e\u3059\u3002\n\n```PHP\n$page = $params['page'] ?: 1;\n$offset = (($page - 1) * 100);\n$limit = min([100, (int)$count - $offset]);\n$query->setMaxResults($limit);\n$query->setFirstResult($offset);\n\n```\n\n## \u306f\u3058\u3081\u306b\u4e3b\u30ad\u30fc\u3060\u3051\u3092\u691c\u7d22\u3057\u3066\u3001\u53d6\u5f97\u3057\u305f\u4e3b\u30ad\u30fc\u3067\u660e\u7d30\u3092\u53d6\u5f97\u3059\u308b\n\n\u6700\u5f8c\u306e1\u30da\u30fc\u30b8\u306b\u95a2\u3057\u3066\u306f\u6570100\u30df\u30ea\u79d2\u6539\u5584\u3057\u305f\u306e\u3067\u3059\u304c\u3001\u307e\u30603\u79d2\u53f0\u3060\u3063\u305f\u306e\u3067\u3001\u3082\u3046\u4e00\u8e0f\u3093\u5f35\u308a\u3057\u307e\u3059\u3002\n\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u30c6\u30b9\u30c8\u3057\u3066\u3044\u308b\u30a4\u30f3\u30d5\u30e9\u30a8\u30f3\u30b8\u30cb\u30a2\u304b\u3089\u4e0b\u8a18\u306e\u63d0\u6848\u304c\u3042\u308a\u307e\u3057\u305f\u3002\n\n### \u4e3b\u30ad\u30fc\u3060\u3051\u306e\u691c\u7d22\u306f\u65e9\u3044\n\n\u5f53\u305f\u308a\u524d\u306a\u8a71\u3067\u306f\u3042\u308b\u306e\u3067\u3059\u304c\u3001\n\n- SELECT\u53e5\u306b\u3066\u4e3b\u30ad\u30fc\u3060\u3051\u3092\u6307\u5b9a\u3059\u308b\u3068\u65e9\u304f\u306a\u308b\n- WHERE\u53e5\u3067\u4e3b\u30ad\u30fc\u3060\u3051\u3092\u6307\u5b9a\u3059\u308b\u3068\u65e9\u304f\u306a\u308b\n\n\u306a\u306e\u3067\u3001\n\n- \u3044\u3063\u305f\u3093\u4e3b\u30ad\u30fc\u3060\u3051\u3092\u691c\u7d22\u3057\n- \u305d\u306e\u4e3b\u30ad\u30fc\u3092\u5143\u306b\u660e\u7d30\u3092\u53d6\u5f97\u3059\u308b\n\n\u3068\u30af\u30a8\u30ea\u3092\u5206\u3051\u3066\u306f\u3069\u3046\u304b\u3001\u3068\u3044\u3046\u63d0\u6848\u3067\u3059\u3002\n\n```SQL\n## \u4e3b\u30ad\u30fc\u3060\u3051\u691c\u7d22\nSELECT id FROM something FORCE INDEX (index_for_orderby) \nWHERE ...\nORDER BY ...\nLIMIT \n  80 OFFSET 179900\n\n## \u4e3b\u30ad\u30fc\u3092\u5143\u306b\u660e\u7d30\u3092\u53d6\u5f97\nSELECT * FROM something\nWHERE id IN (...)\n```\n\n\u3061\u306a\u307f\u306b\u3001IN\u53e5\u3078\u306e\u30d1\u30e9\u30e1\u30fc\u30bf\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u30bb\u30c3\u30c8\u3057\u307e\u3059\u3002\n\n```PHP\n$query->setParameter('ids', $ids, Connection::PARAM_STR_ARRAY);\n```\n\n\u305f\u3060\u3001\u3053\u308c\u3001Doctrine\u306e\u307b\u3046\u3067\u3082\u3053\u3046\u3044\u3046\u30af\u30a8\u30ea\u30fc\u3092\u5143\u3005\u4f5c\u3063\u3066\u304f\u308c\u3066\u3044\u305f\u6c17\u304c\u3057\u307e\u3059\u3002\u3002\n\u306a\u306e\u3067\u3001SQLWalker\u306a\u3069\u99c6\u4f7f\u3059\u308c\u3070\u3001\u6c4e\u7528\u7684\u306a\u90e8\u5206\u306e\u5b9f\u88c5\u3092\u96a0\u853d\u3057\u305f\u307e\u307e\u30c1\u30e5\u30fc\u30cb\u30f3\u30b0\u3067\u304d\u305f\u306e\u304b\u3082\u3057\u308c\u306a\u3044\u3002\u3002\u3002\uff08\u672a\u691c\u8a3c\uff09\n\n## \u7d50\u679c\u3068\u307e\u3068\u3081\n\n\u6700\u7d42\u7684\u306a\u30bd\u30fc\u30b9\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u308a\u307e\u3057\u305f\u3002\n\n~~~SomethingRespository.php\nuse Doctrine\\ORM\\EntityRepository;\nuse Doctrine\\ORM\\Query;\nuse Knp\\Component\\Pager\\Paginator;\nuse Knp\\Bundle\\PaginatorBundle\\Pagination\\SlidingPagination;\n\nclass SomethingRepository extends EntityRepository {\n\n    public function paginate (Paginator $paginator, $params = array()) {\n\n        $idsDql = 'SELECT s.id FROM something s WHERE s.param1 = :param1';\n        $itemDql = 'SELECT s FROM something s';\n        $parameters = array(':param1' => 'value1');\n\n        $em = $this->getEntityManager();\n\n        // \u5408\u8a08\u4ef6\u6570\u3092\u53d6\u5f97\n        $countDql = 'SELECT COUNT(s) FROM `something` s';\n        $countQuery = $em->createQuery($countDql);\n        $count = $countQuery->getSingleScalarResult();\n\n        // \u4e3b\u30ad\u30fc\u3092\u691c\u7d22\n        $idsQuery = $em->createQuery($idsDql);\n        $idsQuery->setParameters($parameters);\n\n        $idsQuery->setHint('knp_paginator.count', $count);\n        $page = $params['page'] ?: 1;\n        $offset = (($page - 1) * 100);\n        $limit = min([100, (int)$count - $offset]);\n        $idsQuery->setMaxResults($limit);\n        $idsQuery->setFirstResult($offset);\n        $idsQuery->setHint(Query::HINT_CUSTOM_OUTPUT_WALKER, \"My\\\\SomethingBundle\\\\Query\\\\UseIndexWalker\");\n        $idsQuery->setHint(UseIndexWalker::HINT_FORCE_INDEX, 'index_for_orderby');\n\n        $ids = $idsQuery->getArrayResult();\n\n        $items = array();\n        if (!empty($ids)) {\n            $itemDql .= ' WHERE s.id IN (:ids)';\n            $itemQuery = $em->createQuery($itemDql);\n            $itemQuery->setParameter('ids', $ids, Connection::PARAM_STR_ARRAY);\n            $items = $itemQuery->getResult();\n        }\n\n        //Pagination\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u30bb\u30c3\u30c8\n        $pagination = $paginator->paginate(array());\n        /* @var $pagination SlidingPagination */\n        $pagination->setCurrentPageNumber($page);\n        $pagination->setItemNumberPerPage(100);\n        $pagination->setTotalItemCount($count);\n        $pagination->setItems($items);\n\n        return $pagination;\n    }\n}\n~~~\n\n\uff13\u79d2\u53f0\u304b\u30892\u79d2\u53f0\u3078\u306e\u58c1\u304c\u76f8\u5f53\u9ad8\u304b\u3063\u305f\u3067\u3059\u304c\u3001\u306a\u3093\u3068\u304b\u6539\u5584\u3067\u304d\u307e\u3057\u305f\u3002\n\n\u5f8c\u534a\u306f\u3001KnpPaginatorBundle \u3068\u3044\u3046\u3088\u308a\u3001Doctrine \u3068\u3044\u3046\u304b MySQL \u3068\u306e\u6226\u3044\u306b\u306a\u3063\u3066\u3057\u307e\u3044\u307e\u3057\u305f\u304c\u3001\u4f3c\u305f\u3088\u3046\u306a\u58c1\u306b\u3076\u3061\u3042\u305f\u3063\u305f\u3068\u304d\u306b\u53c2\u8003\u306b\u3057\u3066\u3044\u305f\u3060\u3051\u308b\u3068\u5e78\u3044\u3067\u3059\u3002\n\n"}