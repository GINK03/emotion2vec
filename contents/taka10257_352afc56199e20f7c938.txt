{"tags": ["bigquery"], "context": "\n\n\u3068\u3042\u308b\u8208\u5473\u304b\u3089\u30b7\u30b9\u30c6\u30e0\u306e\u5229\u7528\u6642\u9593\u3092\u8abf\u3079\u305f\u304f\u306a\u3063\u305f\u306e\u3067\u8003\u3048\u305f\n\n\u30c6\u30b9\u30c8\u30c7\u30fc\u30bf\uff08\u5927\u91cf\u306e\u8a18\u9332\u3055\u308c\u305f\u6642\u9593\u30c7\u30fc\u30bf\u304c\u3042\u308b\u3068\u60f3\u5b9a\uff09\nSELECT\n *\nFROM\n (SELECT TIMESTAMP_TO_SEC(current_timestamp()) -650 AS time_at),\n (SELECT TIMESTAMP_TO_SEC(current_timestamp()) -600 AS time_at),\n (SELECT TIMESTAMP_TO_SEC(current_timestamp()) -200 AS time_at),\n (SELECT TIMESTAMP_TO_SEC(current_timestamp()) -150 AS time_at),\n (SELECT TIMESTAMP_TO_SEC(current_timestamp()) -50  AS time_at),\n (SELECT TIMESTAMP_TO_SEC(current_timestamp())      AS time_at)\n;\n\n\n\nLAG\u95a2\u6570\u3092\u4f7f\u3063\u30661\u3064\u524d\u306e\u6642\u9593\u3092\u53d6\u5f97\u3059\u308b\nSELECT\n time_at,\n LAG(time_at, 1) OVER (ORDER BY time_at asc) as before_time_at\nFROM\n (SELECT TIMESTAMP_TO_SEC(current_timestamp()) -650 AS time_at),\n (SELECT TIMESTAMP_TO_SEC(current_timestamp()) -600 AS time_at),\n (SELECT TIMESTAMP_TO_SEC(current_timestamp()) -200 AS time_at),\n (SELECT TIMESTAMP_TO_SEC(current_timestamp()) -150 AS time_at),\n (SELECT TIMESTAMP_TO_SEC(current_timestamp()) -50  AS time_at),\n (SELECT TIMESTAMP_TO_SEC(current_timestamp())      AS time_at)\n;\n\n\n\n1\u3064\u524d\u306e\u6642\u9593\u3068\u306e\u5dee\u5206\u3092\u8a08\u7b97\nSELECT\n time_at,\n before_time_at,\n (time_at - before_time_at) AS diff_sec\nFROM\n (\n\u3000SELECT\n\u3000 time_at,\n\u3000 LAG(time_at, 1) OVER (ORDER BY time_at asc) as before_time_at\n\u3000FROM\n\u3000 (SELECT TIMESTAMP_TO_SEC(current_timestamp()) -650 AS time_at),\n\u3000 (SELECT TIMESTAMP_TO_SEC(current_timestamp()) -600 AS time_at),\n\u3000 (SELECT TIMESTAMP_TO_SEC(current_timestamp()) -200 AS time_at),\n\u3000 (SELECT TIMESTAMP_TO_SEC(current_timestamp()) -150 AS time_at),\n\u3000 (SELECT TIMESTAMP_TO_SEC(current_timestamp()) -50  AS time_at),\n\u3000 (SELECT TIMESTAMP_TO_SEC(current_timestamp())      AS time_at)\n )\n;\n\n\n\n5\u5206\u4ee5\u4e0a\u306e\u672a\u64cd\u4f5c\u306f\u9664\u5916\u3057\u3066\u307f\u308b\nSELECT\n time_at,\n before_time_at,\n IF((time_at - before_time_at) > (5 * 60), null, (time_at - before_time_at)) AS diff_sec\nFROM\n (\n\u3000SELECT\n\u3000 time_at,\n\u3000 LAG(time_at, 1) OVER (ORDER BY time_at asc) as before_time_at\n\u3000FROM\n\u3000 (SELECT TIMESTAMP_TO_SEC(current_timestamp()) -650 AS time_at),\n\u3000 (SELECT TIMESTAMP_TO_SEC(current_timestamp()) -600 AS time_at),\n\u3000 (SELECT TIMESTAMP_TO_SEC(current_timestamp()) -200 AS time_at),\n\u3000 (SELECT TIMESTAMP_TO_SEC(current_timestamp()) -150 AS time_at),\n\u3000 (SELECT TIMESTAMP_TO_SEC(current_timestamp()) -50  AS time_at),\n\u3000 (SELECT TIMESTAMP_TO_SEC(current_timestamp())      AS time_at)\n )\n;\n\n\n\n\u5f8c\u306f\u96c6\u8a08\nSELECT\n SUM(diff_sec)\nFROM\n (\n SELECT\n  time_at,\n  before_time_at,\n  IF((time_at - before_time_at) > (5 * 60), null, (time_at - before_time_at)) AS diff_sec\n FROM\n  (\n \u3000SELECT\n \u3000 time_at,\n \u3000 LAG(time_at, 1) OVER (ORDER BY time_at asc) as before_time_at\n \u3000FROM\n \u3000 (SELECT TIMESTAMP_TO_SEC(current_timestamp()) -650 AS time_at),\n \u3000 (SELECT TIMESTAMP_TO_SEC(current_timestamp()) -600 AS time_at),\n \u3000 (SELECT TIMESTAMP_TO_SEC(current_timestamp()) -200 AS time_at),\n \u3000 (SELECT TIMESTAMP_TO_SEC(current_timestamp()) -150 AS time_at),\n \u3000 (SELECT TIMESTAMP_TO_SEC(current_timestamp()) -50  AS time_at),\n \u3000 (SELECT TIMESTAMP_TO_SEC(current_timestamp())      AS time_at)\n  )\n )\n;\n\n\n\n\n\u304a\u307e\u3051\nBigQuery\u3067\u65e5\u4ed8\u306e\u8a08\u7b97\u3059\u308b\u6642\u306f\u3001unixtime\u3067\u8a08\u7b97\u3057\u305f\u65b9\u304c\u826f\u3044\u305e\u3002\n\u7406\u7531\u306f\u5fd8\u308c\u305f\u304c\u3001\u5909\u306a\u52d5\u4f5c\u3057\u305f\u306f\u305a\u3002\n# \u3068\u3042\u308b\u8208\u5473\u304b\u3089\u30b7\u30b9\u30c6\u30e0\u306e\u5229\u7528\u6642\u9593\u3092\u8abf\u3079\u305f\u304f\u306a\u3063\u305f\u306e\u3067\u8003\u3048\u305f\n\n## \u30c6\u30b9\u30c8\u30c7\u30fc\u30bf\uff08\u5927\u91cf\u306e\u8a18\u9332\u3055\u308c\u305f\u6642\u9593\u30c7\u30fc\u30bf\u304c\u3042\u308b\u3068\u60f3\u5b9a\uff09\n\n```sql\nSELECT\n *\nFROM\n (SELECT TIMESTAMP_TO_SEC(current_timestamp()) -650 AS time_at),\n (SELECT TIMESTAMP_TO_SEC(current_timestamp()) -600 AS time_at),\n (SELECT TIMESTAMP_TO_SEC(current_timestamp()) -200 AS time_at),\n (SELECT TIMESTAMP_TO_SEC(current_timestamp()) -150 AS time_at),\n (SELECT TIMESTAMP_TO_SEC(current_timestamp()) -50  AS time_at),\n (SELECT TIMESTAMP_TO_SEC(current_timestamp())      AS time_at)\n;\n```\n\n![image](https://qiita-image-store.s3.amazonaws.com/0/147882/0f8caff6-25c2-711f-962e-9fbb36af18f9.png)\n\n\n## LAG\u95a2\u6570\u3092\u4f7f\u3063\u30661\u3064\u524d\u306e\u6642\u9593\u3092\u53d6\u5f97\u3059\u308b\n```sql\nSELECT\n time_at,\n LAG(time_at, 1) OVER (ORDER BY time_at asc) as before_time_at\nFROM\n (SELECT TIMESTAMP_TO_SEC(current_timestamp()) -650 AS time_at),\n (SELECT TIMESTAMP_TO_SEC(current_timestamp()) -600 AS time_at),\n (SELECT TIMESTAMP_TO_SEC(current_timestamp()) -200 AS time_at),\n (SELECT TIMESTAMP_TO_SEC(current_timestamp()) -150 AS time_at),\n (SELECT TIMESTAMP_TO_SEC(current_timestamp()) -50  AS time_at),\n (SELECT TIMESTAMP_TO_SEC(current_timestamp())      AS time_at)\n;\n```\n\n![image](https://qiita-image-store.s3.amazonaws.com/0/147882/72d1f04a-0a8c-636e-2caa-4f19a685da2d.png)\n\n\n## 1\u3064\u524d\u306e\u6642\u9593\u3068\u306e\u5dee\u5206\u3092\u8a08\u7b97\n```sql\nSELECT\n time_at,\n before_time_at,\n (time_at - before_time_at) AS diff_sec\nFROM\n (\n\u3000SELECT\n\u3000 time_at,\n\u3000 LAG(time_at, 1) OVER (ORDER BY time_at asc) as before_time_at\n\u3000FROM\n\u3000 (SELECT TIMESTAMP_TO_SEC(current_timestamp()) -650 AS time_at),\n\u3000 (SELECT TIMESTAMP_TO_SEC(current_timestamp()) -600 AS time_at),\n\u3000 (SELECT TIMESTAMP_TO_SEC(current_timestamp()) -200 AS time_at),\n\u3000 (SELECT TIMESTAMP_TO_SEC(current_timestamp()) -150 AS time_at),\n\u3000 (SELECT TIMESTAMP_TO_SEC(current_timestamp()) -50  AS time_at),\n\u3000 (SELECT TIMESTAMP_TO_SEC(current_timestamp())      AS time_at)\n )\n;\n```\n\n![image](https://qiita-image-store.s3.amazonaws.com/0/147882/5c70f8f1-90ec-3316-d4d7-fb376b87275e.png)\n\n\n## 5\u5206\u4ee5\u4e0a\u306e\u672a\u64cd\u4f5c\u306f\u9664\u5916\u3057\u3066\u307f\u308b\n```sql\nSELECT\n time_at,\n before_time_at,\n IF((time_at - before_time_at) > (5 * 60), null, (time_at - before_time_at)) AS diff_sec\nFROM\n (\n\u3000SELECT\n\u3000 time_at,\n\u3000 LAG(time_at, 1) OVER (ORDER BY time_at asc) as before_time_at\n\u3000FROM\n\u3000 (SELECT TIMESTAMP_TO_SEC(current_timestamp()) -650 AS time_at),\n\u3000 (SELECT TIMESTAMP_TO_SEC(current_timestamp()) -600 AS time_at),\n\u3000 (SELECT TIMESTAMP_TO_SEC(current_timestamp()) -200 AS time_at),\n\u3000 (SELECT TIMESTAMP_TO_SEC(current_timestamp()) -150 AS time_at),\n\u3000 (SELECT TIMESTAMP_TO_SEC(current_timestamp()) -50  AS time_at),\n\u3000 (SELECT TIMESTAMP_TO_SEC(current_timestamp())      AS time_at)\n )\n;\n```\n\n![image](https://qiita-image-store.s3.amazonaws.com/0/147882/f8cc4b76-70e9-9031-177d-5d9a8dd3c25d.png)\n\n\n## \u5f8c\u306f\u96c6\u8a08\n\n```sql\nSELECT\n SUM(diff_sec)\nFROM\n (\n SELECT\n  time_at,\n  before_time_at,\n  IF((time_at - before_time_at) > (5 * 60), null, (time_at - before_time_at)) AS diff_sec\n FROM\n  (\n \u3000SELECT\n \u3000 time_at,\n \u3000 LAG(time_at, 1) OVER (ORDER BY time_at asc) as before_time_at\n \u3000FROM\n \u3000 (SELECT TIMESTAMP_TO_SEC(current_timestamp()) -650 AS time_at),\n \u3000 (SELECT TIMESTAMP_TO_SEC(current_timestamp()) -600 AS time_at),\n \u3000 (SELECT TIMESTAMP_TO_SEC(current_timestamp()) -200 AS time_at),\n \u3000 (SELECT TIMESTAMP_TO_SEC(current_timestamp()) -150 AS time_at),\n \u3000 (SELECT TIMESTAMP_TO_SEC(current_timestamp()) -50  AS time_at),\n \u3000 (SELECT TIMESTAMP_TO_SEC(current_timestamp())      AS time_at)\n  )\n )\n;\n```\n\n![image](https://qiita-image-store.s3.amazonaws.com/0/147882/d082e101-1d7e-aaf7-ad88-6514bdf70bd6.png)\n\n---\n# \u304a\u307e\u3051\nBigQuery\u3067\u65e5\u4ed8\u306e\u8a08\u7b97\u3059\u308b\u6642\u306f\u3001unixtime\u3067\u8a08\u7b97\u3057\u305f\u65b9\u304c\u826f\u3044\u305e\u3002\n\u7406\u7531\u306f\u5fd8\u308c\u305f\u304c\u3001\u5909\u306a\u52d5\u4f5c\u3057\u305f\u306f\u305a\u3002\n\n\n\n"}