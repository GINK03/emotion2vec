{"tags": ["Rails", "Rails4", "capistrano", "unicorn", "nginx"], "context": " More than 1 year has passed since last update.\n\n\u30bd\u30fc\u30b9\u30ea\u30dd\u30b8\u30c8\u30ea\n\u30bd\u30fc\u30b9\u306f\u4ee5\u4e0b\u306e\u30ea\u30dd\u30b8\u30c8\u30ea\u3092\u53c2\u7167\u3057\u3066\u304f\u3060\u3055\u3044\u3002\nhttps://github.com/katsuhiko/sample_app_rails_4\n\n\u30d0\u30fc\u30b8\u30e7\u30f3\n\n\n\nversion\n\n\n\n\nrails 4.2.3\n\n\ncapistrano 3.4.0\n\n\ncapistrano-rails 1.1.3\n\n\ncapistrano-rbenv 2.0.3\n\n\ncapistrano3-unicorn 0.2.1\n\n\nunicorn 4.9.0\n\n\nunicorn-worker-killer 0.4.3\n\n\n\n\n\u6982\u8981\nAnsible \u3092\u4f7f\u3063\u3066 EC2 \u306b Rails\u30b5\u30fc\u30d0\u30fc\u3092\u7acb\u3061\u4e0a\u3052\u308b\n\u3067\u4f5c\u6210\u3057\u305f EC2 \u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306b\u5bfe\u3057\u3066 sample_app_rails_4 \u3092\u30c7\u30d7\u30ed\u30a4\u3057\u307e\u3059\u3002\n\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\nGemfile \u306b\u8ffd\u52a0\u3057\u307e\u3059\u3002\n\u8ffd\u52a0\u5206\u306e\u307f\u3092\u8a18\u8f09\u3057\u307e\u3059\u3002Gemfile \u5168\u4f53\u306f https://github.com/katsuhiko/sample_app_rails_4/blob/master/Gemfile \u3092\u53c2\u7167\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\nGemfile\n# Use Unicorn as the app server\ngem 'unicorn'\ngem 'unicorn-worker-killer'\n\ngroup :development do\n  # Use Capistrano for deployment\n  gem 'capistrano', '3.4.0'\n  gem 'capistrano-rails'\n  gem 'capistrano-rbenv'\n  gem 'capistrano-bundler'\n  gem 'capistrano3-unicorn'\nend\n\n\nbundle install \u3092\u5b9f\u65bd\u3057\u3001capistrano \u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u306e\u96db\u5f62\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n$ bundle install\n$ bundle exec cap install\n\n\n\u30c7\u30d7\u30ed\u30a4\u30d5\u30a1\u30a4\u30eb\u3068 unicorn \u95a2\u9023\u30d5\u30a1\u30a4\u30eb\n\nCapfile\n'capistrano/rails' \u3092\u8aad\u307f\u8fbc\u3081\u3070 'capistrano/bundler', 'capistrano/rails/assets', 'capistrano/rails/migrations' \u3092\u8aad\u307f\u8fbc\u3080\u5fc5\u8981\u306f\u3042\u308a\u307e\u305b\u3093\u3002\nunicorn \u3092\u4f7f\u3046\u305f\u3081\u306b 'capistrano3/unicorn' \u3092\u8aad\u307f\u8fbc\u307f\u307e\u3059\u3002\n\nCapfile\n# Load DSL and set up stages\nrequire 'capistrano/setup'\n\n# Include default deployment tasks\nrequire 'capistrano/deploy'\n\n# Include tasks from other gems included in your Gemfile\nrequire 'capistrano/rbenv'\nrequire 'capistrano/rails'\nrequire 'capistrano3/unicorn'\n\n# Load custom tasks from `lib/capistrano/tasks` if you have any defined\nDir.glob('lib/capistrano/tasks/*.rake').each { |r| import r }\n\n\n\ndeploy.rb\n\u3042\u308b\u7a0b\u5ea6\u3001\u74b0\u5883\u5909\u6570\u3067\u5207\u308a\u66ff\u3048\u308c\u308b\u3088\u3046\u306b\u3057\u3066\u3044\u307e\u3059\u3002\nAWS \u306e\u30bf\u30b0\u60c5\u5831\u3092\u5229\u7528\u3057\u30c7\u30d7\u30ed\u30a4\u3059\u308b\u305f\u3081\u3001aws_region, ssh_keys, tag_role \u3092\u7528\u610f\u3057\u3066\u3044\u307e\u3059\u3002\nrails_config \u3067\u74b0\u5883\u3092\u5207\u308a\u66ff\u3048\u308b\u305f\u3081\u3001linked_files \u306f database.yml \u3067\u306f\u306a\u304f production.yml \u3092\u6307\u5b9a\u3057\u3066\u3044\u307e\u3059\u3002\nrails_config \u306b\u3064\u3044\u3066\u306f\nRails4 rails_config \u3092\u4f7f\u3063\u3066\u74b0\u5883\u3054\u3068\u306e\u60c5\u5831\u3092\u5207\u308a\u66ff\u3048\u308b\n\u3092\u53c2\u7167\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\nconfig/deploy.rb\n# config valid only for current version of Capistrano\nlock '3.4.0'\n\nset :application, ENV['APPLICATION'] || 'sample_app_rails_4'\nset :repo_url, 'https://github.com/katsuhiko/sample_app_rails_4.git'\n\n# \u72ec\u81ea\u306e\u8a2d\u5b9a\u9805\u76ee\nset :aws_region, ENV['AWS_REGION'] || 'ap-northeast-1'\nset :aws_tag_role, ENV['AWS_TAG_ROLE'] || 'rails'\nset :deploy_user, ENV['DEPLOY_USER'] || 'ec2-user'\nset :deploy_ssh_keys, ENV['DEPLOY_SSH_KEYS'] || '~/.ssh/amazon.pem'\n\n# Default branch is :master\n# ask :branch, `git rev-parse --abbrev-ref HEAD`.chomp\nset :branch, ENV['BRANCH'] || 'master'\n\n# Default deploy_to directory is /var/www/my_app_name\n# set :deploy_to, '/var/www/my_app_name'\nset :deploy_to, \"/var/apps/#{fetch(:application)}\"\n\n# Default value for :scm is :git\n# set :scm, :git\n\n# Default value for :format is :pretty\n# set :format, :pretty\n\n# Default value for :log_level is :debug\n# set :log_level, :debug\n\n# Default value for :pty is false\n# set :pty, true\n\n# Default value for :linked_files is []\n# set :linked_files, fetch(:linked_files, []).push('config/database.yml', 'config/secrets.yml')\nset :linked_files, fetch(:linked_files, []).push('config/settings/production.yml')\n\n# Default value for linked_dirs is []\n# set :linked_dirs, fetch(:linked_dirs, []).push('log', 'tmp/pids', 'tmp/cache', 'tmp/sockets', 'vendor/bundle', 'public/system')\nset :linked_dirs, fetch(:linked_dirs, []).push('log', 'tmp/pids', 'tmp/cache', 'tmp/sockets', 'vendor/bundle')\n\n# Default value for default_env is {}\n# set :default_env, { path: \"/opt/ruby/bin:$PATH\" }\n\n# Default value for keep_releases is 5\n# set :keep_releases, 5\n\n# rbenv \u306e\u8a2d\u5b9a see: https://github.com/capistrano/rbenv/\nset :rbenv_type, :user # :system or :user\nset :rbenv_ruby, '2.2.2'\nset :rbenv_prefix, \"#{fetch(:rbenv_path)}/bin/rbenv exec\"\nset :rbenv_map_bins, %w(rake gem bundle ruby rails)\nset :rbenv_roles, :all # default value\n\n# Rails \u306e\u8a2d\u5b9a see: https://github.com/capistrano/rails/\nset :rails_env, 'production'\n\n# Unicorn \u306e\u8a2d\u5b9a see: https://github.com/tablexi/capistrano3-unicorn\n# shared_path \u304b\u3089\u53d6\u5f97\u3059\u308b\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u304c\u610f\u56f3\u3057\u305f\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306b\u306a\u3089\u306a\u3044\u305f\u3081\u4fee\u6b63\u3057\u307e\u3057\u305f\u3002\n# http://stackoverflow.com/questions/20789080/capistrano-3-wrong-path-in-the-shared-path-variable\n# set :unicorn_pid, \"#{shared_path}/tmp/pids/unicorn.pid\"\nset :unicorn_pid, -> { \"#{shared_path}/tmp/pids/unicorn.pid\" }\nset :unicorn_config_path, \"config/unicorn.rb\"\nset :unicorn_rack_env, 'deployment' # \"development\", \"deployment\", or \"none\"\n\nnamespace :deploy do\n\n  desc 'Restart application'\n  task :restart do\n    on roles(:app), in: :sequence, wait: 5 do\n      invoke 'unicorn:restart'\n    end\n  end\n\n  after :publishing, :restart\n\n  after :restart, :clear_cache do\n    on roles(:web), in: :groups, limit: 3, wait: 10 do\n      # Here we can do anything such as:\n      # within release_path do\n      #   execute :rake, 'cache:clear'\n      # end\n    end\n  end\n\nend\n\n\n/var/apps/ \u914d\u4e0b\u306b\u30c7\u30d7\u30ed\u30a4\u3057\u307e\u3059\u3002\nunicorn \u306e socket \u30d5\u30a1\u30a4\u30eb\u306f shared \u914d\u4e0b\u306b\u7f6e\u304d\u307e\u3059\u3002\n\u30a2\u30d7\u30ea\u306b\u95a2\u3059\u308b\u30d5\u30a1\u30a4\u30eb\u3059\u3079\u3066\u3092 /var/apps/ \u914d\u4e0b\u306b\u96c6\u4e2d\u3055\u305b\u305f\u3044\u3068\u8003\u3048\u3066\u3044\u308b\u304b\u3089\u3067\u3059\u3002\nnginx \u306e\u5b9f\u884c\u30e6\u30fc\u30b6\u30fc\u306f\u300cnginx\u300d\u3001unicorn \u306e\u5b9f\u884c\u30e6\u30fc\u30b6\u30fc\u306f\u300cec2-user\u300d\u3067 socket \u30d5\u30a1\u30a4\u30eb\u306f apps \u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u914d\u4e0b\u306b\u3042\u308b\u305f\u3081\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306b apps \u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306b other \u5b9f\u884c\u6a29\u3092\u4ed8\u4e0e\u3057\u307e\u3059\u3002\ndrwxr-xr-x  3 ec2-user ec2-user 4096 Jul 18 15:20 apps\n\n\nproduction.rb\nhttp://qiita.com/ShotaKameyama/items/c66d64551411897082a1\n\u3053\u3061\u3089\u3092\u53c2\u8003\u306b\u3057\u3001aws-sdk v2 \u3092\u5229\u7528\u3057\u305f\u30c7\u30d7\u30ed\u30a4\u3092\u884c\u3044\u307e\u3059\u3002\n\u4eca\u306f\u30ed\u30fc\u30ab\u30eb\u74b0\u5883\u304b\u3089\u30c7\u30d7\u30ed\u30a4\u3057\u3066\u3044\u308b\u305f\u3081 Public IP \u30a2\u30c9\u30ec\u30b9\u3092\u53d6\u5f97\u3057\u3066\u3044\u307e\u3059\u3002\n\u672c\u5f53\u306f\u3001\u30c7\u30d7\u30ed\u30a4\u3059\u308b EC2 \u306e VPC \u5185\u306b\u30c7\u30d7\u30ed\u30a4\u30b5\u30fc\u30d0\u30fc\u3092\u7acb\u3061\u4e0a\u3052\u3001Private IP \u30a2\u30c9\u30ec\u30b9\u7d4c\u7531\u3068\u3057\u305f\u307b\u3046\u304c\u826f\u3044\u3068\u601d\u3044\u307e\u3059\u3002\n\u4e0d\u8981\u306a SSH \u30dd\u30fc\u30c8\u306f\u89e3\u653e\u3057\u306a\u3044\u307b\u3046\u304c\u826f\u3044\u3068\u601d\u3044\u307e\u3059\u3002\n\u30c7\u30d7\u30ed\u30a4\u5bfe\u8c61\u3068\u306a\u308b\u30b5\u30fc\u30d0\u30fc\u3092\u52d5\u7684\u306b\u53d6\u5f97\u3057\u3066\u3044\u308b\u305f\u3081\u3001staging \u7b49\u306e\u74b0\u5883\u306b\u3088\u308b\u8a18\u8ff0\u5185\u5bb9\u306e\u9055\u3044\u306f\u7121\u304f\u306a\u3063\u3066\u3044\u307e\u3059\u3002\nproduction.rb \u306e\u5185\u5bb9\u306f deploy.rb \u306b\u79fb\u52d5\u3057\u3066\u3082\u826f\u3044\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u3002\n\nconfig/deploy/production.rb\nrequire 'aws-sdk-core'\n\n# Shared Credentials \u3092\u5229\u7528\u3059\u308b\u3002 see: http://muramasa64.fprog.org/diary/?date=20150217\nec2 = Aws::EC2::Client.new(region: fetch(:aws_region))\n\n# \u30bf\u30b0\u3068\u8d77\u52d5\u4e2d\u306e EC2 \u3067\u5bfe\u8c61\u3092\u7d5e\u308a\u8fbc\u3080\u3002\nec2_filtered = ec2.describe_instances(\n    filters:[\n        {name: \"tag:env\", values: [fetch(:rails_env)]},\n        {name: \"tag:role\", values: [fetch(:aws_tag_role)]},\n        {name: 'instance-state-name', values: ['running']}\n    ])\n\n# TODO deploy \u7528\u306e\u30b5\u30fc\u30d0\u30fc\u3092\u7528\u610f\u3057\u3001private_ip_address \u3092\u5229\u7528\u3057\u3066\u3001VPC\u5185\u304b\u3089 SSH \u3057\u305f\u307b\u3046\u304c\u826f\u3044\u3002\ninstances = ec2_filtered.reservations.map(&:instances).flatten.map(&:public_ip_address)\n\nrole :app, *instances\nrole :web, *instances\nrole :db, [instances.first]\nserver *instances,\n    user: fetch(:deploy_user),\n    ssh_options: {\n        forward_agent: true,\n        auth_methods: ['publickey'],\n        # if you want to debug capistrano set verbose to debug\n        # verbose: :debug,\n        keys: fetch(:deploy_ssh_keys)\n    }\n\n\n\nunicorn.rb\nhttp://unicorn.bogomips.org/examples/unicorn.conf.rb\nhttps://github.com/tablexi/capistrano3-unicorn/blob/master/examples/unicorn.rb\n\u4e0a\u8a18\u306e\uff12\u3064\u3092\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\uff0f\u53c2\u8003\u3068\u3057\u3066\u5229\u7528\u3057\u3066\u3044\u307e\u3059\u3002\nunicorn.sock, unicorn.pid \u3068\u3082\u306b shared \u914d\u4e0b\u306b\u6301\u3063\u3066\u3044\u304f\u3088\u3046\u306b\u3057\u3066\u3044\u307e\u3059\u3002\nENV['BUNDLE_GEMFILE'] \u306b\u5024\u3092\u8a2d\u5b9a\u3057\u3066\u3044\u308b\u7b87\u6240\u306f\u91cd\u8981\u3067\u3059\u3002\n\u3053\u306e\u8a2d\u5b9a\u304c\u306a\u3044\u5834\u5408\u3001Gemfile \u3092\u5909\u66f4\u3057\u3066\u3082 unicorn worker \u30d7\u30ed\u30bb\u30b9\u306b\u53cd\u6620\u3055\u308c\u306a\u307e\u305b\u3093\u3002\nwoker_processes \u6570\u304c\u6c17\u306b\u306a\u308b\u3068\u601d\u3044\u307e\u3059\u304c\u3001woker \u30d7\u30ed\u30bb\u30b9\u6570\u306f capistrano \u30bf\u30b9\u30af\u3067\u5897\u6e1b\u3055\u305b\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\u30c7\u30d7\u30ed\u30a4\u5f8c\u3001\u72b6\u6cc1\u306b\u5fdc\u3058\u3066\u8abf\u6574\u3057\u307e\u3059\u3002\n\nconfig/unicorn.rb\n# template: http://unicorn.bogomips.org/examples/unicorn.conf.rb\n# see: https://github.com/tablexi/capistrano3-unicorn/blob/master/examples/unicorn.rb\n\napp_path = File.dirname(File.dirname(Dir.pwd))\n\n# Sample verbose configuration file for Unicorn (not Rack)\n#\n# This configuration file documents many features of Unicorn\n# that may not be needed for some applications. See\n# http://unicorn.bogomips.org/examples/unicorn.conf.minimal.rb\n# for a much simpler configuration file.\n#\n# See http://unicorn.bogomips.org/Unicorn/Configurator.html for complete\n# documentation.\n\n# Use at least one worker per core if you're on a dedicated server,\n# more will usually help for _short_ waits on databases/caches.\n#worker_processes 4\nworker_processes 2\n\n# Since Unicorn is never exposed to outside clients, it does not need to\n# run on the standard HTTP port (80), there is no reason to start Unicorn\n# as root unless it's from system init scripts.\n# If running the master process as root and the workers as an unprivileged\n# user, do this to switch euid/egid in the workers (also chowns logs):\n# user \"unprivileged_user\", \"unprivileged_group\"\n\n# Help ensure your application will always spawn in the symlinked\n# \"current\" directory that Capistrano sets up.\n#working_directory \"/path/to/app/current\" # available in 0.94.0+\nworking_directory \"#{app_path}/current\"\n\n# listen on both a Unix domain socket and a TCP port,\n# we use a shorter backlog for quicker failover when busy\n#listen \"/path/to/.unicorn.sock\", :backlog => 64\n#listen 8080, :tcp_nopush => true\nlisten \"#{app_path}/shared/tmp/sockets/unicorn.sock\", :backlog => 64\n\n# nuke workers after 30 seconds instead of 60 seconds (the default)\n#timeout 30\ntimeout 60\n\n# feel free to point this anywhere accessible on the filesystem\n#pid \"/path/to/app/shared/pids/unicorn.pid\"\npid \"#{app_path}/shared/tmp/pids/unicorn.pid\"\n\n# By default, the Unicorn logger will write to stderr.\n# Additionally, ome applications/frameworks log to stderr or stdout,\n# so prevent them from going to /dev/null when daemonized here:\n#stderr_path \"/path/to/app/shared/log/unicorn.stderr.log\"\n#stdout_path \"/path/to/app/shared/log/unicorn.stdout.log\"\nstderr_path \"#{app_path}/shared/log/unicorn.stderr.log\"\nstdout_path \"#{app_path}/shared/log/unicorn.stdout.log\"\n\n# combine Ruby 2.0.0dev or REE with \"preload_app true\" for memory savings\n# http://rubyenterpriseedition.com/faq.html#adapt_apps_for_cow\npreload_app true\nGC.respond_to?(:copy_on_write_friendly=) and\n    GC.copy_on_write_friendly = true\n\n# Enable this flag to have unicorn test client connections by writing the\n# beginning of the HTTP headers before calling the application.  This\n# prevents calling the application for connections that have disconnected\n# while queued.  This is only guaranteed to detect clients on the same\n# host unicorn runs on, and unlikely to detect disconnects even on a\n# fast LAN.\ncheck_client_connection false\n\n# local variable to guard against running a hook multiple times\nrun_once = true\n\n# Gemfile \u3092\u5909\u66f4\u3057\u305f\u3068\u304d\u306b\u3082\u8aad\u307f\u8fbc\u307e\u308c\u308b\u3088\u3046\u306b\u3059\u308b\u3002 see: http://qiita.com/tachiba/items/7eef03cce6a917a957dc\nbefore_exec do |server|\n  ENV['BUNDLE_GEMFILE'] = \"#{app_path}/current/Gemfile\"\nend\n\nbefore_fork do |server, worker|\n  # the following is highly recomended for Rails + \"preload_app true\"\n  # as there's no need for the master process to hold a connection\n  defined?(ActiveRecord::Base) and\n      ActiveRecord::Base.connection.disconnect!\n\n  # Occasionally, it may be necessary to run non-idempotent code in the\n  # master before forking.  Keep in mind the above disconnect! example\n  # is idempotent and does not need a guard.\n  if run_once\n    # do_something_once_here ...\n    run_once = false # prevent from firing again\n  end\n\n  # The following is only recommended for memory/DB-constrained\n  # installations.  It is not needed if your system can house\n  # twice as many worker_processes as you have configured.\n  #\n  # # This allows a new master process to incrementally\n  # # phase out the old master process with SIGTTOU to avoid a\n  # # thundering herd (especially in the \"preload_app false\" case)\n  # # when doing a transparent upgrade.  The last worker spawned\n  # # will then kill off the old master process with a SIGQUIT.\n  # old_pid = \"#{server.config[:pid]}.oldbin\"\n  # if old_pid != server.pid\n  #   begin\n  #     sig = (worker.nr + 1) >= server.worker_processes ? :QUIT : :TTOU\n  #     Process.kill(sig, File.read(old_pid).to_i)\n  #   rescue Errno::ENOENT, Errno::ESRCH\n  #   end\n  # end\n  old_pid = \"#{server.config[:pid]}.oldbin\"\n  if File.exist?(old_pid) && server.pid != old_pid\n    begin\n      sig = (worker.nr + 1) >= server.worker_processes ? :QUIT : :TTOU\n      Process.kill(sig, File.read(old_pid).to_i)\n    rescue Errno::ENOENT, Errno::ESRCH => e\n      logger.error e\n    end\n  end\n  #\n  # Throttle the master from forking too quickly by sleeping.  Due\n  # to the implementation of standard Unix signal handlers, this\n  # helps (but does not completely) prevent identical, repeated signals\n  # from being lost when the receiving process is busy.\n  # sleep 1\nend\n\nafter_fork do |server, worker|\n  # per-process listener ports for debugging/admin/migrations\n  # addr = \"127.0.0.1:#{9293 + worker.nr}\"\n  # server.listen(addr, :tries => -1, :delay => 5, :tcp_nopush => true)\n\n  # the following is *required* for Rails + \"preload_app true\",\n  defined?(ActiveRecord::Base) and\n      ActiveRecord::Base.establish_connection\n\n  # if preload_app is true, then you may also want to check and\n  # restart any other shared sockets/descriptors such as Memcached,\n  # and Redis.  TokyoCabinet file handles are safe to reuse\n  # between any number of forked children (assuming your kernel\n  # correctly implements pread()/pwrite() system calls)\nend\n\n\n\nconfig.ru\nunicorn \u3092\u5b89\u5b9a\u7a3c\u50cd\u3055\u305b\u308b\u305f\u3081\u306b unicorn-worker-killer \u3092\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\nconfig.ru\n# This file is used by Rack-based servers to start the application.\n\nrequire ::File.expand_path('../config/environment', __FILE__)\n\n# Unicorn self-process killer\nrequire 'unicorn/worker_killer'\n\n# Max requests per worker\nmax_request_min =  3072\nmax_request_max =  4096\nuse Unicorn::WorkerKiller::MaxRequests, max_request_min, max_request_max\n\n# Max memory size (RSS) per worker\noom_min = (192 * (1024**2))\noom_max = (256 * (1024**2))\nuse Unicorn::WorkerKiller::Oom, oom_min, oom_max\n\nrun Rails.application\n\n\n\n\u30c7\u30d7\u30ed\u30a4\u30b5\u30fc\u30d0\u30fc\uff08or \u30ed\u30fc\u30ab\u30eb\u74b0\u5883\uff09\u306e\u30d5\u30a1\u30a4\u30eb\n\ncredentials\nAWS \u3078\u306e\u63a5\u7d9a\u306f Shared Credentials \u3092\u5229\u7528\u3057\u307e\u3059\u3002\n\u30c7\u30d7\u30ed\u30a4\u3059\u308b\u30b5\u30fc\u30d0\u30fc\u306b ~/.aws/credentials \u3092\u4f5c\u6210\u3057 Key \u60c5\u5831\u3092\u8a2d\u5b9a\u3057\u307e\u3059\u3002\nKey \u60c5\u5831\u3092\u4f5c\u6210\u3059\u308b\u306e\u306f\u4ee5\u4e0b\u30b5\u30a4\u30c8\u304c\u53c2\u8003\u306b\u306a\u308b\u3068\u601d\u3044\u307e\u3059\u3002\nhttp://dev.classmethod.jp/cloud/aws-cli-credential-config/\n\n~/.aws/credentials\n[default]\naws_access_key_id = XXXXXXXX\naws_secret_access_key = XXXXXXXX\n\n\n\namazon.pem\nSSH \u63a5\u7d9a\u3067\u304d\u308b\u3088\u3046\u306b pem \u30d5\u30a1\u30a4\u30eb\u3092\u7528\u610f\u3057\u3001deploy.rb \u306b\u6307\u5b9a\u3057\u305f\u5834\u6240\u306b\u914d\u7f6e\u3057\u307e\u3059\u3002\n\nEC2 \u30b5\u30fc\u30d0\u30fc\uff08Rails \u30b5\u30fc\u30d0\u30fc\uff09\u306e\u30d5\u30a1\u30a4\u30eb\n\n\u30bf\u30b0\u4f5c\u6210\nAWS \u30b3\u30f3\u30bd\u30fc\u30eb\u304b\u3089\u3001\u30c7\u30d7\u30ed\u30a4\u3059\u308b EC2 \u30b5\u30fc\u30d0\u30fc\u306b\u4ee5\u4e0b\u306e\u30bf\u30b0\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n\n\n\u30ad\u30fc\n\u5024\n\n\n\n\nenv\nproduction\n\n\nrole\nrails\n\n\n\n\nproduction.yml\nbundle exec cap production deploy:check \u3092\u5b9f\u65bd\u3057\u307e\u3059\u3002\nlinked_files \u3092\u7528\u610f\u3057\u3066\u3044\u306a\u3044\u305f\u3081\u30a8\u30e9\u30fc\u306f\u767a\u751f\u3057\u307e\u3059\u304c\u3001\u5fc5\u8981\u306a\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u4f5c\u6210\u3057\u3066\u304f\u308c\u307e\u3059\u3002\nsecret_key_base \u306f bundle exec rake secret\u3067\u751f\u6210\u3057\u305f\u5024\u3092\u8a2d\u5b9a\u3057\u307e\u3059\u3002\nDB\u306b\u3064\u3044\u3066\u306f\u3001\u5404\u74b0\u5883\u306b\u5408\u308f\u305b\u3066\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\n/var/apps/sample_app_rails_4/shared/config/settings/production.yml\nsecret:\n  secret_key_base: xxxxxxx\n\ndatabases:\n  pool: 5\n  host: endpoint\n  port: 3306\n  username: xxxxxxxx\n  password: xxxxxxxx\n  production:\n    database: sample_app_rails_4_production\n\n\n\nnginx.conf\n/var/apps/ \u914d\u4e0b\u306b\u30a2\u30d7\u30ea\u306b\u95a2\u3059\u308b\u30d5\u30a1\u30a4\u30eb\u3092\u3059\u3079\u3066\u6301\u3063\u3066\u304d\u305f\u3044\u305f\u3081\u3001nginx.conf \u3092 /var/apps/sample_app_rails_4/shared/config/ \u914d\u4e0b\u306b\u4f5c\u308a\u307e\u3059\u3002\n\u672c\u6765\u306f\u3001\u30b5\u30d6\u30c9\u30e1\u30a4\u30f3\u540d\u3067\u30d0\u30fc\u30c1\u30e3\u30eb\u30db\u30b9\u30c8\u3092\u5207\u308b\u306e\u3067\u3059\u306e\u304c\u3001\u4eca\u56de\u306f\u3001\u30dd\u30fc\u30c8\u756a\u53f7\u3067\u308f\u3051\u3066\u3044\u307e\u3059\u3002\n\n/var/apps/sample_app_rails_4/shared/config/nginx.conf\nupstream sample_app_rails_4 {\n  server unix:/var/apps/sample_app_rails_4/shared/tmp/sockets/unicorn.sock fail_timeout=0;\n}\n\n# redirect https from http\n#server {\n#  listen 80;\n#  server_name sample.example.com;\n#\n#  location / {\n#    return 301 https://$host$request_uri;\n#  }\n#}\n\nserver {\n  listen 443;\n  #server_name sample.example.com;\n\n  access_log /var/log/nginx/sample_app_rails_4.access.log;\n  error_log /var/log/nginx/sample_app_rails_4.error.log;\n\n  ssl on;\n  ssl_certificate /etc/nginx/certs/local-ssl.crt;\n  ssl_certificate_key /etc/nginx/certs/local-ssl.key;\n\n  root /var/apps/sample_app_rails_4/current/public;\n\n  proxy_connect_timeout 70;\n  proxy_read_timeout    70;\n  proxy_send_timeout    70;\n\n  location / {\n    proxy_set_header X-Real-IP $remote_addr;\n    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n    proxy_set_header Host $http_host;\n    proxy_redirect off;\n\n    if (!-f $request_filename) {\n      proxy_pass http://sample_app_rails_4;\n      break;\n    }\n  }\n}\n\n\n/etc/nginx/nginx.conf \u306b\u306f\u3001/var/apps/ \u914d\u4e0b\u306e confg \u3092\u8aad\u307f\u8fbc\u3080\u3088\u3046\u306b\u3057\u307e\u3059\u3002include \u90e8\u5206\u304c\u8a72\u5f53\u306e\u51e6\u7406\u3067\u3059\u3002\n\n/etc/nginx/nginx.conf\nuser  nginx;\nworker_processes  auto;\n\nerror_log  /var/log/nginx/error.log;\n#error_log  /var/log/nginx/error.log  notice;\n#error_log  /var/log/nginx/error.log  info;\n\npid        /var/run/nginx.pid;\n\n\nevents {\n    worker_connections  1024;\n}\n\n\nhttp {\n    include       /etc/nginx/mime.types;\n    default_type  application/octet-stream;\n\n    log_format  main  '$remote_addr - $remote_user [$time_local] \"$request\" '\n                      '$status $body_bytes_sent \"$http_referer\" '\n                      '\"$http_user_agent\" \"$http_x_forwarded_for\"';\n\n    access_log  /var/log/nginx/access.log  main;\n\n    #\n    server_tokens off;\n    #\n\n    sendfile        on;\n    #tcp_nopush     on;\n\n    #keepalive_timeout  0;\n    keepalive_timeout  65;\n\n    #gzip  on;\n\n    # Load modular configuration files from the /etc/nginx/conf.d directory.\n    # See http://nginx.org/en/docs/ngx_core_module.html#include\n    # for more information.\n    include /etc/nginx/conf.d/*.conf;\n    include /var/apps/*/shared/config/nginx.conf;\n\n    index   index.html index.htm;\n\n    server {\n        listen       80;\n        server_name  localhost;\n        root         /usr/share/nginx/html;\n\n        #charset koi8-r;\n\n        #access_log  /var/log/nginx/host.access.log  main;\n\n        location / {\n        }\n\n        # redirect server error pages to the static page /40x.html\n        #\n        error_page  404              /404.html;\n        location = /40x.html {\n        }\n\n        # redirect server error pages to the static page /50x.html\n        #\n        error_page   500 502 503 504  /50x.html;\n        location = /50x.html {\n        }\n    }\n}\n\n\n\u4f5c\u6210\u3057\u305f nginx.conf \u3092\u8aad\u307f\u8fbc\u3080\u305f\u3081\u306b nginx \u3092 restart \u3057\u307e\u3059\u3002\n$ sudo service nginx restart\n\n\n\u30c7\u30d7\u30ed\u30a4\u306e\u5b9f\u65bd\n\u3053\u308c\u3067\u30c7\u30d7\u30ed\u30a4\u306e\u6e96\u5099\u304c\u3067\u304d\u307e\u3057\u305f\u3002\n\u30c7\u30d7\u30ed\u30a4\u30b5\u30fc\u30d0\u30fc\uff08or \u30ed\u30fc\u30ab\u30eb\u74b0\u5883\uff09\u3067 sample_app_rails_4 \u3092 clone \u3057\u305f\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306b\u79fb\u52d5\u3057\u3001\u30c7\u30d7\u30ed\u30a4\u3092\u5b9f\u65bd\u3057\u307e\u3059\u3002\n$ bundle exec cap -t production deploy\n\n\u9577\u304b\u3063\u305f\u3067\u3059\u304c\u3001\u30c7\u30d7\u30ed\u30a4\u306b\u3064\u3044\u3066\u306f\u4ee5\u4e0a\u3067\u3059\u3002\nShared Credentials \u306e\u5185\u5bb9\u304c\u6b63\u3057\u3044\u306b\u3082\u95a2\u308f\u3089\u305a\u3001\u4ee5\u4e0b\u306e\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3059\u308b\u5834\u5408\u3001\u6642\u523b\u306b\u30ba\u30ec\u304c\u767a\u751f\u3057\u3066\u3044\u306a\u3044\u304b\u78ba\u8a8d\u3057\u3066\u304f\u3060\u3055\u3044\u3002\nAws::EC2::Errors::AuthFailure: AWS was not able to validate the provided access credentials\n\n\n\u3088\u304f\u4f7f\u3046 capistrano \u30bf\u30b9\u30af\n\u3088\u304f\u4f7f\u3046\u30bf\u30b9\u30af\u3092\u8f09\u305b\u307e\u3059\u3002\n\n\u30c7\u30d7\u30ed\u30a4\u3059\u308b\n-t (--trace) \u30aa\u30d7\u30b7\u30e7\u30f3\u3092\u3064\u3051\u3066\u3044\u307e\u3059\u3002\u3069\u3093\u306a\u9806\u756a\u3067\u30bf\u30b9\u30af\u304c\u51e6\u7406\u3055\u308c\u3066\u3044\u308b\u304b\u304c\u308f\u304b\u308b\u306e\u3067\u597d\u304d\u3067\u3059\u3002\n$ bundle exec cap -t production deploy\n\n\u74b0\u5883\u5909\u6570\u3092\u6e21\u3057\u305f\u3044\u5834\u5408\u3001\u5f8c\u308d\u306b\u6307\u5b9a\u3057\u3066\u3044\u307e\u3059\u3002\n$ bundle exec cap -t production deploy BRANCH=feature/new-actions\n\n\n\u30bf\u30b9\u30af\u3092\u78ba\u8a8d\u3059\u308b\n\u3069\u3093\u306a\u30bf\u30b9\u30af\u304c\u3042\u308b\u304b\u3092\u78ba\u8a8d\u3067\u304d\u307e\u3059\u3002\n$ bundle exec cap -T\n\n\nunicorn \u3092\u505c\u6b62\u3059\u308b\n\u8a2d\u5b9a\u3092\u53cd\u6620\u3055\u305b\u308b\u305f\u3081\u306b\u505c\u6b62\u3057\u305f\u3044\u5834\u5408\u3001\u4f7f\u3044\u307e\u3059\u3002\n\u500b\u5225\u306b kill \u3059\u308b\u3088\u308a\u4fbf\u5229\u3067\u3059\u3002\n$ bundle exec cap -t production unicorn:stop\n\n\nunicorn \u3092\u958b\u59cb\u3059\u308b\nunicorn \u3092\u958b\u59cb\u3059\u308b\u3068\u304d\u306b\u3082 capistrano \u306f\u4fbf\u5229\u3067\u3059\u3002\n$ bundle exec cap -t production unicorn:start\n\n\nunicorn worker \u30d7\u30ed\u30bb\u30b9\u3092\u5897\u3084\u3059\nunicorn worker \u30d7\u30ed\u30bb\u30b9\u6570\u3082 capistrano \u304b\u3089\u8abf\u6574\u3067\u304d\u307e\u3059\u3002\n$ bundle exec cap -t production unicorn:add_worker\n\n\nunicorn worker \u30d7\u30ed\u30bb\u30b9\u3092\u6e1b\u3089\u3059\n$ bundle exec cap -t production unicorn:remove_worker\n\n\n\u611f\u60f3\n\u60c5\u5831\u306f\u305f\u304f\u3055\u3093\u3042\u308b\u306e\u3067\u8abf\u67fb\u3057\u3084\u3059\u304b\u3063\u305f\u3067\u3059\u3002\n\u30bd\u30fc\u30b9\uff0f\u30c7\u30d7\u30ed\u30a4\u30b5\u30fc\u30d0\u30fc\uff0fEC2 \u30b5\u30fc\u30d0\u30fc\u3068\u305d\u308c\u305e\u308c\u306b\u8a18\u8f09\u3059\u308b\u3053\u3068\u304c\u3042\u308a\u3001\u5206\u304b\u308a\u3065\u3089\u304f\u306a\u3063\u3066\u3044\u307e\u3059\u3002\u8aad\u307f\u8fd4\u3057\u306a\u304c\u3089\u6574\u7406\u3057\u3066\u3044\u304f\u4e88\u5b9a\u3067\u3059\u3002\n\u30c7\u30d7\u30ed\u30a4\u30c4\u30fc\u30eb\uff0f\u69cb\u6210\u7ba1\u7406\u30c4\u30fc\u30eb\u3001\u305d\u308c\u305e\u308c\u3084\u308b\u3079\u304d\u3053\u3068\u304c\u3042\u308b\u3068\u601d\u3044\u307e\u3059\u3002\n\u3069\u3061\u3089\u304b\u4e00\u65b9\u306e\u307f\u3067\u306f\u306a\u304f\u3001\u4e0a\u624b\u306b\u4e21\u65b9\u3092\u4f7f\u3063\u3066\u3044\u304d\u305f\u3044\u3067\u3059\u3002\n# \u30bd\u30fc\u30b9\u30ea\u30dd\u30b8\u30c8\u30ea\n\n\u30bd\u30fc\u30b9\u306f\u4ee5\u4e0b\u306e\u30ea\u30dd\u30b8\u30c8\u30ea\u3092\u53c2\u7167\u3057\u3066\u304f\u3060\u3055\u3044\u3002\nhttps://github.com/katsuhiko/sample_app_rails_4\n\n\n# \u30d0\u30fc\u30b8\u30e7\u30f3\n\n| version | \n|:---|\n| rails 4.2.3 |\n| capistrano 3.4.0 |\n| capistrano-rails 1.1.3 |\n| capistrano-rbenv 2.0.3 |\n| capistrano3-unicorn 0.2.1 |\n| unicorn 4.9.0 |\n| unicorn-worker-killer 0.4.3 |\n\n\n# \u6982\u8981\n\n[Ansible \u3092\u4f7f\u3063\u3066 EC2 \u306b Rails\u30b5\u30fc\u30d0\u30fc\u3092\u7acb\u3061\u4e0a\u3052\u308b](http://qiita.com/katsuhiko/items/c84a282f3a56d71c404f)\n\u3067\u4f5c\u6210\u3057\u305f EC2 \u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306b\u5bfe\u3057\u3066 sample_app_rails_4 \u3092\u30c7\u30d7\u30ed\u30a4\u3057\u307e\u3059\u3002\n\n\n# \u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\nGemfile \u306b\u8ffd\u52a0\u3057\u307e\u3059\u3002\n\u8ffd\u52a0\u5206\u306e\u307f\u3092\u8a18\u8f09\u3057\u307e\u3059\u3002Gemfile \u5168\u4f53\u306f https://github.com/katsuhiko/sample_app_rails_4/blob/master/Gemfile \u3092\u53c2\u7167\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n```rb:Gemfile\n# Use Unicorn as the app server\ngem 'unicorn'\ngem 'unicorn-worker-killer'\n\ngroup :development do\n  # Use Capistrano for deployment\n  gem 'capistrano', '3.4.0'\n  gem 'capistrano-rails'\n  gem 'capistrano-rbenv'\n  gem 'capistrano-bundler'\n  gem 'capistrano3-unicorn'\nend\n```\n\n`bundle install` \u3092\u5b9f\u65bd\u3057\u3001capistrano \u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u306e\u96db\u5f62\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n```shell-session\n$ bundle install\n$ bundle exec cap install\n```\n\n# \u30c7\u30d7\u30ed\u30a4\u30d5\u30a1\u30a4\u30eb\u3068 unicorn \u95a2\u9023\u30d5\u30a1\u30a4\u30eb\n\n## Capfile\n\n`'capistrano/rails'` \u3092\u8aad\u307f\u8fbc\u3081\u3070 `'capistrano/bundler'`, `'capistrano/rails/assets'`, `'capistrano/rails/migrations'` \u3092\u8aad\u307f\u8fbc\u3080\u5fc5\u8981\u306f\u3042\u308a\u307e\u305b\u3093\u3002\n\nunicorn \u3092\u4f7f\u3046\u305f\u3081\u306b `'capistrano3/unicorn'` \u3092\u8aad\u307f\u8fbc\u307f\u307e\u3059\u3002\n\n```rb:Capfile\n# Load DSL and set up stages\nrequire 'capistrano/setup'\n\n# Include default deployment tasks\nrequire 'capistrano/deploy'\n\n# Include tasks from other gems included in your Gemfile\nrequire 'capistrano/rbenv'\nrequire 'capistrano/rails'\nrequire 'capistrano3/unicorn'\n\n# Load custom tasks from `lib/capistrano/tasks` if you have any defined\nDir.glob('lib/capistrano/tasks/*.rake').each { |r| import r }\n```\n\n## deploy.rb\n\n\u3042\u308b\u7a0b\u5ea6\u3001\u74b0\u5883\u5909\u6570\u3067\u5207\u308a\u66ff\u3048\u308c\u308b\u3088\u3046\u306b\u3057\u3066\u3044\u307e\u3059\u3002\nAWS \u306e\u30bf\u30b0\u60c5\u5831\u3092\u5229\u7528\u3057\u30c7\u30d7\u30ed\u30a4\u3059\u308b\u305f\u3081\u3001aws_region, ssh_keys, tag_role \u3092\u7528\u610f\u3057\u3066\u3044\u307e\u3059\u3002\n\nrails_config \u3067\u74b0\u5883\u3092\u5207\u308a\u66ff\u3048\u308b\u305f\u3081\u3001linked_files \u306f\b database.yml \u3067\u306f\u306a\u304f production.yml \u3092\u6307\u5b9a\u3057\u3066\u3044\u307e\u3059\u3002\n\nrails_config \u306b\u3064\u3044\u3066\u306f\n[Rails4 rails_config \u3092\u4f7f\u3063\u3066\u74b0\u5883\u3054\u3068\u306e\u60c5\u5831\u3092\u5207\u308a\u66ff\u3048\u308b](http://qiita.com/katsuhiko/items/302176f8b3eb35600951)\n\u3092\u53c2\u7167\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n```rb:config/deploy.rb\n# config valid only for current version of Capistrano\nlock '3.4.0'\n\nset :application, ENV['APPLICATION'] || 'sample_app_rails_4'\nset :repo_url, 'https://github.com/katsuhiko/sample_app_rails_4.git'\n\n# \u72ec\u81ea\u306e\u8a2d\u5b9a\u9805\u76ee\nset :aws_region, ENV['AWS_REGION'] || 'ap-northeast-1'\nset :aws_tag_role, ENV['AWS_TAG_ROLE'] || 'rails'\nset :deploy_user, ENV['DEPLOY_USER'] || 'ec2-user'\nset :deploy_ssh_keys, ENV['DEPLOY_SSH_KEYS'] || '~/.ssh/amazon.pem'\n\n# Default branch is :master\n# ask :branch, `git rev-parse --abbrev-ref HEAD`.chomp\nset :branch, ENV['BRANCH'] || 'master'\n\n# Default deploy_to directory is /var/www/my_app_name\n# set :deploy_to, '/var/www/my_app_name'\nset :deploy_to, \"/var/apps/#{fetch(:application)}\"\n\n# Default value for :scm is :git\n# set :scm, :git\n\n# Default value for :format is :pretty\n# set :format, :pretty\n\n# Default value for :log_level is :debug\n# set :log_level, :debug\n\n# Default value for :pty is false\n# set :pty, true\n\n# Default value for :linked_files is []\n# set :linked_files, fetch(:linked_files, []).push('config/database.yml', 'config/secrets.yml')\nset :linked_files, fetch(:linked_files, []).push('config/settings/production.yml')\n\n# Default value for linked_dirs is []\n# set :linked_dirs, fetch(:linked_dirs, []).push('log', 'tmp/pids', 'tmp/cache', 'tmp/sockets', 'vendor/bundle', 'public/system')\nset :linked_dirs, fetch(:linked_dirs, []).push('log', 'tmp/pids', 'tmp/cache', 'tmp/sockets', 'vendor/bundle')\n\n# Default value for default_env is {}\n# set :default_env, { path: \"/opt/ruby/bin:$PATH\" }\n\n# Default value for keep_releases is 5\n# set :keep_releases, 5\n\n# rbenv \u306e\u8a2d\u5b9a see: https://github.com/capistrano/rbenv/\nset :rbenv_type, :user # :system or :user\nset :rbenv_ruby, '2.2.2'\nset :rbenv_prefix, \"#{fetch(:rbenv_path)}/bin/rbenv exec\"\nset :rbenv_map_bins, %w(rake gem bundle ruby rails)\nset :rbenv_roles, :all # default value\n\n# Rails \u306e\u8a2d\u5b9a see: https://github.com/capistrano/rails/\nset :rails_env, 'production'\n\n# Unicorn \u306e\u8a2d\u5b9a see: https://github.com/tablexi/capistrano3-unicorn\n# shared_path \u304b\u3089\u53d6\u5f97\u3059\u308b\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u304c\u610f\u56f3\u3057\u305f\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306b\u306a\u3089\u306a\u3044\u305f\u3081\u4fee\u6b63\u3057\u307e\u3057\u305f\u3002\n# http://stackoverflow.com/questions/20789080/capistrano-3-wrong-path-in-the-shared-path-variable\n# set :unicorn_pid, \"#{shared_path}/tmp/pids/unicorn.pid\"\nset :unicorn_pid, -> { \"#{shared_path}/tmp/pids/unicorn.pid\" }\nset :unicorn_config_path, \"config/unicorn.rb\"\nset :unicorn_rack_env, 'deployment' # \"development\", \"deployment\", or \"none\"\n\nnamespace :deploy do\n\n  desc 'Restart application'\n  task :restart do\n    on roles(:app), in: :sequence, wait: 5 do\n      invoke 'unicorn:restart'\n    end\n  end\n\n  after :publishing, :restart\n\n  after :restart, :clear_cache do\n    on roles(:web), in: :groups, limit: 3, wait: 10 do\n      # Here we can do anything such as:\n      # within release_path do\n      #   execute :rake, 'cache:clear'\n      # end\n    end\n  end\n\nend\n```\n\n/var/apps/ \u914d\u4e0b\u306b\u30c7\u30d7\u30ed\u30a4\u3057\u307e\u3059\u3002\nunicorn \u306e socket \u30d5\u30a1\u30a4\u30eb\u306f shared \u914d\u4e0b\u306b\u7f6e\u304d\u307e\u3059\u3002\n\u30a2\u30d7\u30ea\u306b\u95a2\u3059\u308b\u30d5\u30a1\u30a4\u30eb\u3059\u3079\u3066\u3092 /var/apps/ \u914d\u4e0b\u306b\u96c6\u4e2d\u3055\u305b\u305f\u3044\u3068\u8003\u3048\u3066\u3044\u308b\u304b\u3089\u3067\u3059\u3002\nnginx \u306e\u5b9f\u884c\u30e6\u30fc\u30b6\u30fc\u306f\u300cnginx\u300d\u3001unicorn \u306e\u5b9f\u884c\u30e6\u30fc\u30b6\u30fc\u306f\u300cec2-user\u300d\u3067 socket \u30d5\u30a1\u30a4\u30eb\u306f apps \u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u914d\u4e0b\u306b\u3042\u308b\u305f\u3081\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306b apps \u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306b other \u5b9f\u884c\u6a29\u3092\u4ed8\u4e0e\u3057\u307e\u3059\u3002\n\n```\ndrwxr-xr-x  3 ec2-user ec2-user 4096 Jul 18 15:20 apps\n```\n\n## production.rb\n\nhttp://qiita.com/ShotaKameyama/items/c66d64551411897082a1\n\u3053\u3061\u3089\u3092\u53c2\u8003\u306b\u3057\u3001aws-sdk v2 \u3092\u5229\u7528\u3057\u305f\u30c7\u30d7\u30ed\u30a4\u3092\u884c\u3044\u307e\u3059\u3002\n\n\u4eca\u306f\u30ed\u30fc\u30ab\u30eb\u74b0\u5883\u304b\u3089\u30c7\u30d7\u30ed\u30a4\u3057\u3066\u3044\u308b\u305f\u3081 Public IP \u30a2\u30c9\u30ec\u30b9\u3092\u53d6\u5f97\u3057\u3066\u3044\u307e\u3059\u3002\n\u672c\u5f53\u306f\u3001\u30c7\u30d7\u30ed\u30a4\u3059\u308b EC2 \u306e VPC \u5185\u306b\u30c7\u30d7\u30ed\u30a4\u30b5\u30fc\u30d0\u30fc\u3092\u7acb\u3061\u4e0a\u3052\u3001Private IP \u30a2\u30c9\u30ec\u30b9\u7d4c\u7531\u3068\u3057\u305f\u307b\u3046\u304c\u826f\u3044\u3068\u601d\u3044\u307e\u3059\u3002\n\u4e0d\u8981\u306a SSH \u30dd\u30fc\u30c8\u306f\u89e3\u653e\u3057\u306a\u3044\u307b\u3046\u304c\u826f\u3044\u3068\u601d\u3044\u307e\u3059\u3002\n\n\u30c7\u30d7\u30ed\u30a4\u5bfe\u8c61\u3068\u306a\u308b\u30b5\u30fc\u30d0\u30fc\u3092\u52d5\u7684\u306b\u53d6\u5f97\u3057\u3066\u3044\u308b\u305f\u3081\u3001staging \u7b49\u306e\u74b0\u5883\u306b\u3088\u308b\u8a18\u8ff0\u5185\u5bb9\u306e\u9055\u3044\u306f\u7121\u304f\u306a\u3063\u3066\u3044\u307e\u3059\u3002\nproduction.rb \u306e\u5185\u5bb9\u306f deploy.rb \u306b\u79fb\u52d5\u3057\u3066\u3082\u826f\u3044\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u3002\n\n```rb:config/deploy/production.rb\nrequire 'aws-sdk-core'\n\n# Shared Credentials \u3092\u5229\u7528\u3059\u308b\u3002 see: http://muramasa64.fprog.org/diary/?date=20150217\nec2 = Aws::EC2::Client.new(region: fetch(:aws_region))\n\n# \u30bf\u30b0\u3068\u8d77\u52d5\u4e2d\u306e EC2 \u3067\u5bfe\u8c61\u3092\u7d5e\u308a\u8fbc\u3080\u3002\nec2_filtered = ec2.describe_instances(\n    filters:[\n        {name: \"tag:env\", values: [fetch(:rails_env)]},\n        {name: \"tag:role\", values: [fetch(:aws_tag_role)]},\n        {name: 'instance-state-name', values: ['running']}\n    ])\n\n# TODO deploy \u7528\u306e\u30b5\u30fc\u30d0\u30fc\u3092\u7528\u610f\u3057\u3001private_ip_address \u3092\u5229\u7528\u3057\u3066\u3001VPC\u5185\u304b\u3089 SSH \u3057\u305f\u307b\u3046\u304c\u826f\u3044\u3002\ninstances = ec2_filtered.reservations.map(&:instances).flatten.map(&:public_ip_address)\n\nrole :app, *instances\nrole :web, *instances\nrole :db, [instances.first]\nserver *instances,\n    user: fetch(:deploy_user),\n    ssh_options: {\n        forward_agent: true,\n        auth_methods: ['publickey'],\n        # if you want to debug capistrano set verbose to debug\n        # verbose: :debug,\n        keys: fetch(:deploy_ssh_keys)\n    }\n```\n\n## unicorn.rb\n\nhttp://unicorn.bogomips.org/examples/unicorn.conf.rb\nhttps://github.com/tablexi/capistrano3-unicorn/blob/master/examples/unicorn.rb\n\n\u4e0a\u8a18\u306e\uff12\u3064\u3092\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\uff0f\u53c2\u8003\u3068\u3057\u3066\u5229\u7528\u3057\u3066\u3044\u307e\u3059\u3002\n\nunicorn.sock, unicorn.pid \u3068\u3082\u306b shared \u914d\u4e0b\u306b\u6301\u3063\u3066\u3044\u304f\u3088\u3046\u306b\u3057\u3066\u3044\u307e\u3059\u3002\n\nENV['BUNDLE_GEMFILE'] \u306b\u5024\u3092\u8a2d\u5b9a\u3057\u3066\u3044\u308b\u7b87\u6240\u306f\u91cd\u8981\u3067\u3059\u3002\n\u3053\u306e\u8a2d\u5b9a\u304c\u306a\u3044\u5834\u5408\u3001Gemfile \u3092\u5909\u66f4\u3057\u3066\u3082 unicorn worker \u30d7\u30ed\u30bb\u30b9\u306b\u53cd\u6620\u3055\u308c\u306a\u307e\u305b\u3093\u3002\n\nwoker_processes \u6570\u304c\u6c17\u306b\u306a\u308b\u3068\u601d\u3044\u307e\u3059\u304c\u3001woker \u30d7\u30ed\u30bb\u30b9\u6570\u306f capistrano \u30bf\u30b9\u30af\u3067\u5897\u6e1b\u3055\u305b\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\u30c7\u30d7\u30ed\u30a4\u5f8c\u3001\u72b6\u6cc1\u306b\u5fdc\u3058\u3066\u8abf\u6574\u3057\u307e\u3059\u3002\n\n```rb:config/unicorn.rb\n# template: http://unicorn.bogomips.org/examples/unicorn.conf.rb\n# see: https://github.com/tablexi/capistrano3-unicorn/blob/master/examples/unicorn.rb\n\napp_path = File.dirname(File.dirname(Dir.pwd))\n\n# Sample verbose configuration file for Unicorn (not Rack)\n#\n# This configuration file documents many features of Unicorn\n# that may not be needed for some applications. See\n# http://unicorn.bogomips.org/examples/unicorn.conf.minimal.rb\n# for a much simpler configuration file.\n#\n# See http://unicorn.bogomips.org/Unicorn/Configurator.html for complete\n# documentation.\n\n# Use at least one worker per core if you're on a dedicated server,\n# more will usually help for _short_ waits on databases/caches.\n#worker_processes 4\nworker_processes 2\n\n# Since Unicorn is never exposed to outside clients, it does not need to\n# run on the standard HTTP port (80), there is no reason to start Unicorn\n# as root unless it's from system init scripts.\n# If running the master process as root and the workers as an unprivileged\n# user, do this to switch euid/egid in the workers (also chowns logs):\n# user \"unprivileged_user\", \"unprivileged_group\"\n\n# Help ensure your application will always spawn in the symlinked\n# \"current\" directory that Capistrano sets up.\n#working_directory \"/path/to/app/current\" # available in 0.94.0+\nworking_directory \"#{app_path}/current\"\n\n# listen on both a Unix domain socket and a TCP port,\n# we use a shorter backlog for quicker failover when busy\n#listen \"/path/to/.unicorn.sock\", :backlog => 64\n#listen 8080, :tcp_nopush => true\nlisten \"#{app_path}/shared/tmp/sockets/unicorn.sock\", :backlog => 64\n\n# nuke workers after 30 seconds instead of 60 seconds (the default)\n#timeout 30\ntimeout 60\n\n# feel free to point this anywhere accessible on the filesystem\n#pid \"/path/to/app/shared/pids/unicorn.pid\"\npid \"#{app_path}/shared/tmp/pids/unicorn.pid\"\n\n# By default, the Unicorn logger will write to stderr.\n# Additionally, ome applications/frameworks log to stderr or stdout,\n# so prevent them from going to /dev/null when daemonized here:\n#stderr_path \"/path/to/app/shared/log/unicorn.stderr.log\"\n#stdout_path \"/path/to/app/shared/log/unicorn.stdout.log\"\nstderr_path \"#{app_path}/shared/log/unicorn.stderr.log\"\nstdout_path \"#{app_path}/shared/log/unicorn.stdout.log\"\n\n# combine Ruby 2.0.0dev or REE with \"preload_app true\" for memory savings\n# http://rubyenterpriseedition.com/faq.html#adapt_apps_for_cow\npreload_app true\nGC.respond_to?(:copy_on_write_friendly=) and\n    GC.copy_on_write_friendly = true\n\n# Enable this flag to have unicorn test client connections by writing the\n# beginning of the HTTP headers before calling the application.  This\n# prevents calling the application for connections that have disconnected\n# while queued.  This is only guaranteed to detect clients on the same\n# host unicorn runs on, and unlikely to detect disconnects even on a\n# fast LAN.\ncheck_client_connection false\n\n# local variable to guard against running a hook multiple times\nrun_once = true\n\n# Gemfile \u3092\u5909\u66f4\u3057\u305f\u3068\u304d\u306b\u3082\u8aad\u307f\u8fbc\u307e\u308c\u308b\u3088\u3046\u306b\u3059\u308b\u3002 see: http://qiita.com/tachiba/items/7eef03cce6a917a957dc\nbefore_exec do |server|\n  ENV['BUNDLE_GEMFILE'] = \"#{app_path}/current/Gemfile\"\nend\n\nbefore_fork do |server, worker|\n  # the following is highly recomended for Rails + \"preload_app true\"\n  # as there's no need for the master process to hold a connection\n  defined?(ActiveRecord::Base) and\n      ActiveRecord::Base.connection.disconnect!\n\n  # Occasionally, it may be necessary to run non-idempotent code in the\n  # master before forking.  Keep in mind the above disconnect! example\n  # is idempotent and does not need a guard.\n  if run_once\n    # do_something_once_here ...\n    run_once = false # prevent from firing again\n  end\n\n  # The following is only recommended for memory/DB-constrained\n  # installations.  It is not needed if your system can house\n  # twice as many worker_processes as you have configured.\n  #\n  # # This allows a new master process to incrementally\n  # # phase out the old master process with SIGTTOU to avoid a\n  # # thundering herd (especially in the \"preload_app false\" case)\n  # # when doing a transparent upgrade.  The last worker spawned\n  # # will then kill off the old master process with a SIGQUIT.\n  # old_pid = \"#{server.config[:pid]}.oldbin\"\n  # if old_pid != server.pid\n  #   begin\n  #     sig = (worker.nr + 1) >= server.worker_processes ? :QUIT : :TTOU\n  #     Process.kill(sig, File.read(old_pid).to_i)\n  #   rescue Errno::ENOENT, Errno::ESRCH\n  #   end\n  # end\n  old_pid = \"#{server.config[:pid]}.oldbin\"\n  if File.exist?(old_pid) && server.pid != old_pid\n    begin\n      sig = (worker.nr + 1) >= server.worker_processes ? :QUIT : :TTOU\n      Process.kill(sig, File.read(old_pid).to_i)\n    rescue Errno::ENOENT, Errno::ESRCH => e\n      logger.error e\n    end\n  end\n  #\n  # Throttle the master from forking too quickly by sleeping.  Due\n  # to the implementation of standard Unix signal handlers, this\n  # helps (but does not completely) prevent identical, repeated signals\n  # from being lost when the receiving process is busy.\n  # sleep 1\nend\n\nafter_fork do |server, worker|\n  # per-process listener ports for debugging/admin/migrations\n  # addr = \"127.0.0.1:#{9293 + worker.nr}\"\n  # server.listen(addr, :tries => -1, :delay => 5, :tcp_nopush => true)\n\n  # the following is *required* for Rails + \"preload_app true\",\n  defined?(ActiveRecord::Base) and\n      ActiveRecord::Base.establish_connection\n\n  # if preload_app is true, then you may also want to check and\n  # restart any other shared sockets/descriptors such as Memcached,\n  # and Redis.  TokyoCabinet file handles are safe to reuse\n  # between any number of forked children (assuming your kernel\n  # correctly implements pread()/pwrite() system calls)\nend\n```\n\n## config.ru\n\nunicorn \u3092\u5b89\u5b9a\u7a3c\u50cd\u3055\u305b\u308b\u305f\u3081\u306b unicorn-worker-killer \u3092\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\n```rb:config.ru\n# This file is used by Rack-based servers to start the application.\n\nrequire ::File.expand_path('../config/environment', __FILE__)\n\n# Unicorn self-process killer\nrequire 'unicorn/worker_killer'\n\n# Max requests per worker\nmax_request_min =  3072\nmax_request_max =  4096\nuse Unicorn::WorkerKiller::MaxRequests, max_request_min, max_request_max\n\n# Max memory size (RSS) per worker\noom_min = (192 * (1024**2))\noom_max = (256 * (1024**2))\nuse Unicorn::WorkerKiller::Oom, oom_min, oom_max\n\nrun Rails.application\n```\n\n# \u30c7\u30d7\u30ed\u30a4\u30b5\u30fc\u30d0\u30fc\uff08or \u30ed\u30fc\u30ab\u30eb\u74b0\u5883\uff09\u306e\u30d5\u30a1\u30a4\u30eb\n\n## credentials\n\nAWS \u3078\u306e\u63a5\u7d9a\u306f Shared Credentials \u3092\u5229\u7528\u3057\u307e\u3059\u3002\n\u30c7\u30d7\u30ed\u30a4\u3059\u308b\u30b5\u30fc\u30d0\u30fc\u306b ~/.aws/credentials \u3092\u4f5c\u6210\u3057 Key \u60c5\u5831\u3092\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\nKey \u60c5\u5831\u3092\u4f5c\u6210\u3059\u308b\u306e\u306f\u4ee5\u4e0b\u30b5\u30a4\u30c8\u304c\u53c2\u8003\u306b\u306a\u308b\u3068\u601d\u3044\u307e\u3059\u3002\nhttp://dev.classmethod.jp/cloud/aws-cli-credential-config/\n\n```:~/.aws/credentials\n[default]\naws_access_key_id = XXXXXXXX\naws_secret_access_key = XXXXXXXX\n```\n\n## amazon.pem\n\nSSH \u63a5\u7d9a\u3067\u304d\u308b\u3088\u3046\u306b pem \u30d5\u30a1\u30a4\u30eb\u3092\u7528\u610f\u3057\u3001deploy.rb \u306b\u6307\u5b9a\u3057\u305f\u5834\u6240\u306b\u914d\u7f6e\u3057\u307e\u3059\u3002\n\n\n# EC2 \u30b5\u30fc\u30d0\u30fc\uff08Rails \u30b5\u30fc\u30d0\u30fc\uff09\u306e\u30d5\u30a1\u30a4\u30eb\n\n## \u30bf\u30b0\u4f5c\u6210\n\nAWS \u30b3\u30f3\u30bd\u30fc\u30eb\u304b\u3089\u3001\u30c7\u30d7\u30ed\u30a4\u3059\u308b EC2 \u30b5\u30fc\u30d0\u30fc\u306b\u4ee5\u4e0b\u306e\u30bf\u30b0\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n| \u30ad\u30fc  | \u5024 | \n|:---  |:---|\n| env  | production |\n| role | rails |\n\n\n## production.yml\n\n`bundle exec cap production deploy:check` \u3092\u5b9f\u65bd\u3057\u307e\u3059\u3002\nlinked_files \u3092\u7528\u610f\u3057\u3066\u3044\u306a\u3044\u305f\u3081\u30a8\u30e9\u30fc\u306f\u767a\u751f\u3057\u307e\u3059\u304c\u3001\u5fc5\u8981\u306a\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u4f5c\u6210\u3057\u3066\u304f\u308c\u307e\u3059\u3002\n\nsecret_key_base \u306f `bundle exec rake secret`\u3067\u751f\u6210\u3057\u305f\u5024\u3092\u8a2d\u5b9a\u3057\u307e\u3059\u3002\nDB\u306b\u3064\u3044\u3066\u306f\u3001\u5404\u74b0\u5883\u306b\u5408\u308f\u305b\u3066\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\n```yaml:/var/apps/sample_app_rails_4/shared/config/settings/production.yml\nsecret:\n  secret_key_base: xxxxxxx\n\ndatabases:\n  pool: 5\n  host: endpoint\n  port: 3306\n  username: xxxxxxxx\n  password: xxxxxxxx\n  production:\n    database: sample_app_rails_4_production\n```\n\n\n## nginx.conf\n\n/var/apps/ \u914d\u4e0b\u306b\u30a2\u30d7\u30ea\u306b\u95a2\u3059\u308b\u30d5\u30a1\u30a4\u30eb\u3092\u3059\u3079\u3066\u6301\u3063\u3066\u304d\u305f\u3044\u305f\u3081\u3001nginx.conf \u3092 /var/apps/sample_app_rails_4/shared/config/ \u914d\u4e0b\u306b\u4f5c\u308a\u307e\u3059\u3002\n\n\u672c\u6765\u306f\u3001\u30b5\u30d6\u30c9\u30e1\u30a4\u30f3\u540d\u3067\u30d0\u30fc\u30c1\u30e3\u30eb\u30db\u30b9\u30c8\u3092\u5207\u308b\u306e\u3067\u3059\u306e\u304c\u3001\u4eca\u56de\u306f\u3001\u30dd\u30fc\u30c8\u756a\u53f7\u3067\u308f\u3051\u3066\u3044\u307e\u3059\u3002\n\n```:/var/apps/sample_app_rails_4/shared/config/nginx.conf\nupstream sample_app_rails_4 {\n  server unix:/var/apps/sample_app_rails_4/shared/tmp/sockets/unicorn.sock fail_timeout=0;\n}\n\n# redirect https from http\n#server {\n#  listen 80;\n#  server_name sample.example.com;\n#\n#  location / {\n#    return 301 https://$host$request_uri;\n#  }\n#}\n\nserver {\n  listen 443;\n  #server_name sample.example.com;\n\n  access_log /var/log/nginx/sample_app_rails_4.access.log;\n  error_log /var/log/nginx/sample_app_rails_4.error.log;\n\n  ssl on;\n  ssl_certificate /etc/nginx/certs/local-ssl.crt;\n  ssl_certificate_key /etc/nginx/certs/local-ssl.key;\n\n  root /var/apps/sample_app_rails_4/current/public;\n\n  proxy_connect_timeout 70;\n  proxy_read_timeout    70;\n  proxy_send_timeout    70;\n\n  location / {\n    proxy_set_header X-Real-IP $remote_addr;\n    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n    proxy_set_header Host $http_host;\n    proxy_redirect off;\n\n    if (!-f $request_filename) {\n      proxy_pass http://sample_app_rails_4;\n      break;\n    }\n  }\n}\n```\n\n/etc/nginx/nginx.conf \u306b\u306f\u3001/var/apps/ \u914d\u4e0b\u306e confg \u3092\u8aad\u307f\u8fbc\u3080\u3088\u3046\u306b\u3057\u307e\u3059\u3002include \u90e8\u5206\u304c\u8a72\u5f53\u306e\u51e6\u7406\u3067\u3059\u3002\n\n```:/etc/nginx/nginx.conf\nuser  nginx;\nworker_processes  auto;\n\nerror_log  /var/log/nginx/error.log;\n#error_log  /var/log/nginx/error.log  notice;\n#error_log  /var/log/nginx/error.log  info;\n\npid        /var/run/nginx.pid;\n\n\nevents {\n    worker_connections  1024;\n}\n\n\nhttp {\n    include       /etc/nginx/mime.types;\n    default_type  application/octet-stream;\n\n    log_format  main  '$remote_addr - $remote_user [$time_local] \"$request\" '\n                      '$status $body_bytes_sent \"$http_referer\" '\n                      '\"$http_user_agent\" \"$http_x_forwarded_for\"';\n\n    access_log  /var/log/nginx/access.log  main;\n\n    #\n    server_tokens off;\n    #\n\n    sendfile        on;\n    #tcp_nopush     on;\n\n    #keepalive_timeout  0;\n    keepalive_timeout  65;\n\n    #gzip  on;\n\n    # Load modular configuration files from the /etc/nginx/conf.d directory.\n    # See http://nginx.org/en/docs/ngx_core_module.html#include\n    # for more information.\n    include /etc/nginx/conf.d/*.conf;\n    include /var/apps/*/shared/config/nginx.conf;\n\n    index   index.html index.htm;\n\n    server {\n        listen       80;\n        server_name  localhost;\n        root         /usr/share/nginx/html;\n\n        #charset koi8-r;\n\n        #access_log  /var/log/nginx/host.access.log  main;\n\n        location / {\n        }\n\n        # redirect server error pages to the static page /40x.html\n        #\n        error_page  404              /404.html;\n        location = /40x.html {\n        }\n\n        # redirect server error pages to the static page /50x.html\n        #\n        error_page   500 502 503 504  /50x.html;\n        location = /50x.html {\n        }\n    }\n}\n```\n\n\u4f5c\u6210\u3057\u305f nginx.conf \u3092\u8aad\u307f\u8fbc\u3080\u305f\u3081\u306b nginx \u3092 restart \u3057\u307e\u3059\u3002\n\n```shell-session\n$ sudo service nginx restart\n```\n\n# \u30c7\u30d7\u30ed\u30a4\u306e\u5b9f\u65bd\n\n\u3053\u308c\u3067\u30c7\u30d7\u30ed\u30a4\u306e\u6e96\u5099\u304c\u3067\u304d\u307e\u3057\u305f\u3002\n\n\u30c7\u30d7\u30ed\u30a4\u30b5\u30fc\u30d0\u30fc\uff08or \u30ed\u30fc\u30ab\u30eb\u74b0\u5883\uff09\u3067 sample_app_rails_4 \u3092 clone \u3057\u305f\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306b\u79fb\u52d5\u3057\u3001\u30c7\u30d7\u30ed\u30a4\u3092\u5b9f\u65bd\u3057\u307e\u3059\u3002\n\n```shell-session\n$ bundle exec cap -t production deploy\n```\n\n\u9577\u304b\u3063\u305f\u3067\u3059\u304c\u3001\u30c7\u30d7\u30ed\u30a4\u306b\u3064\u3044\u3066\u306f\u4ee5\u4e0a\u3067\u3059\u3002\n\nShared Credentials \u306e\u5185\u5bb9\u304c\u6b63\u3057\u3044\u306b\u3082\u95a2\u308f\u3089\u305a\u3001\u4ee5\u4e0b\u306e\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3059\u308b\u5834\u5408\u3001\u6642\u523b\u306b\u30ba\u30ec\u304c\u767a\u751f\u3057\u3066\u3044\u306a\u3044\u304b\u78ba\u8a8d\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n```\nAws::EC2::Errors::AuthFailure: AWS was not able to validate the provided access credentials\n```\n\n# \u3088\u304f\u4f7f\u3046 capistrano \u30bf\u30b9\u30af\n\n\u3088\u304f\u4f7f\u3046\u30bf\u30b9\u30af\u3092\u8f09\u305b\u307e\u3059\u3002\n\n## \u30c7\u30d7\u30ed\u30a4\u3059\u308b\n\n-t (--trace) \u30aa\u30d7\u30b7\u30e7\u30f3\u3092\u3064\u3051\u3066\u3044\u307e\u3059\u3002\u3069\u3093\u306a\u9806\u756a\u3067\u30bf\u30b9\u30af\u304c\u51e6\u7406\u3055\u308c\u3066\u3044\u308b\u304b\u304c\u308f\u304b\u308b\u306e\u3067\u597d\u304d\u3067\u3059\u3002\n\n```shell-session\n$ bundle exec cap -t production deploy\n```\n\n\u74b0\u5883\u5909\u6570\u3092\u6e21\u3057\u305f\u3044\u5834\u5408\u3001\u5f8c\u308d\u306b\u6307\u5b9a\u3057\u3066\u3044\u307e\u3059\u3002\n\n```shell-session\n$ bundle exec cap -t production deploy BRANCH=feature/new-actions\n```\n\n## \u30bf\u30b9\u30af\u3092\u78ba\u8a8d\u3059\u308b\n\n\u3069\u3093\u306a\u30bf\u30b9\u30af\u304c\u3042\u308b\u304b\u3092\u78ba\u8a8d\u3067\u304d\u307e\u3059\u3002\n\n```shell-session\n$ bundle exec cap -T\n```\n\n## unicorn \u3092\u505c\u6b62\u3059\u308b\n\n\u8a2d\u5b9a\u3092\u53cd\u6620\u3055\u305b\u308b\u305f\u3081\u306b\u505c\u6b62\u3057\u305f\u3044\u5834\u5408\u3001\u4f7f\u3044\u307e\u3059\u3002\n\u500b\u5225\u306b kill \u3059\u308b\u3088\u308a\u4fbf\u5229\u3067\u3059\u3002\n\n```shell-session\n$ bundle exec cap -t production unicorn:stop\n```\n\n## unicorn \u3092\u958b\u59cb\u3059\u308b\n\nunicorn \u3092\u958b\u59cb\u3059\u308b\u3068\u304d\u306b\u3082 capistrano \u306f\u4fbf\u5229\u3067\u3059\u3002\n\n```shell-session\n$ bundle exec cap -t production unicorn:start\n```\n\n## unicorn worker \u30d7\u30ed\u30bb\u30b9\u3092\u5897\u3084\u3059\n\nunicorn worker \u30d7\u30ed\u30bb\u30b9\u6570\u3082 capistrano \u304b\u3089\u8abf\u6574\u3067\u304d\u307e\u3059\u3002\n\n```shell-session\n$ bundle exec cap -t production unicorn:add_worker\n```\n\n## unicorn worker \u30d7\u30ed\u30bb\u30b9\u3092\u6e1b\u3089\u3059\n\n```shell-session\n$ bundle exec cap -t production unicorn:remove_worker\n```\n\n# \u611f\u60f3\n\n\u60c5\u5831\u306f\u305f\u304f\u3055\u3093\u3042\u308b\u306e\u3067\u8abf\u67fb\u3057\u3084\u3059\u304b\u3063\u305f\u3067\u3059\u3002\n\n\u30bd\u30fc\u30b9\uff0f\u30c7\u30d7\u30ed\u30a4\u30b5\u30fc\u30d0\u30fc\uff0fEC2 \u30b5\u30fc\u30d0\u30fc\u3068\u305d\u308c\u305e\u308c\u306b\u8a18\u8f09\u3059\u308b\u3053\u3068\u304c\u3042\u308a\u3001\u5206\u304b\u308a\u3065\u3089\u304f\u306a\u3063\u3066\u3044\u307e\u3059\u3002\u8aad\u307f\u8fd4\u3057\u306a\u304c\u3089\u6574\u7406\u3057\u3066\u3044\u304f\u4e88\u5b9a\u3067\u3059\u3002\n\n\u30c7\u30d7\u30ed\u30a4\u30c4\u30fc\u30eb\uff0f\u69cb\u6210\u7ba1\u7406\u30c4\u30fc\u30eb\u3001\u305d\u308c\u305e\u308c\u3084\u308b\u3079\u304d\u3053\u3068\u304c\u3042\u308b\u3068\u601d\u3044\u307e\u3059\u3002\n\u3069\u3061\u3089\u304b\u4e00\u65b9\u306e\u307f\u3067\u306f\u306a\u304f\u3001\u4e0a\u624b\u306b\u4e21\u65b9\u3092\u4f7f\u3063\u3066\u3044\u304d\u305f\u3044\u3067\u3059\u3002\n"}