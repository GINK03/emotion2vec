{"context": "\n\n\u3053\u306e\u8a18\u4e8b\u306e\u6982\u8981\n\u65e5\u672c\u3067\u6b63\u5f0f\u30ea\u30ea\u30fc\u30b9\u3055\u308c\u305fStripe\u3092Ruby on Rails\u306b\u5c0e\u5165\u3057\u3001\u30b5\u30d6\u30b9\u30af\u30ea\u30d7\u30b7\u30e7\u30f3\u578b\uff08\u6708\u984d\u5b9a\u671f\u8ab2\u91d1\uff09\u306e\u6c7a\u6e08\u30b7\u30b9\u30c6\u30e0\u3092\u7d44\u307f\u8fbc\u3080\u65b9\u6cd5\u3092\u8aac\u660e\u3057\u307e\u3059\u3002\n\u79c1\u304c\u958b\u767a\u3057\u3066\u3044\u308b formrun\uff08\u30d5\u30a9\u30fc\u30e0\u30fb\u30e9\u30f3\uff09 \u3068\u3044\u3046\u30b5\u30fc\u30d3\u30b9\u306b\u3066\u30012016\u6625\u9803\u304b\u3089\u5b9f\u969b\u306b\u30aa\u30fc\u30d7\u30f3\u03b2\u7248\u306eStripe\u3092\u5229\u7528\u3057\u3066\u304d\u305f\u7d4c\u9a13\u3092\u3082\u3068\u306b\u3001\u5177\u4f53\u7684\u306a\u30b3\u30fc\u30c9\u3068\u3068\u3082\u306b\u89e3\u8aac\u3057\u3066\u3044\u304d\u307e\u3059\u3002\n\u5b9f\u969b\u306e\u30b3\u30fc\u30c9\u3092\u4f7f\u3063\u305f\u30b5\u30d6\u30b9\u30af\u30ea\u30d7\u30b7\u30e7\u30f3\u578b\u6c7a\u6e08\u306e\u8aac\u660e\u306f\u4f8b\u304c\u5c11\u306a\u304f\u3001\u81ea\u5206\u3082\u5b9f\u88c5\u306b\u975e\u5e38\u306b\u82e6\u52b4\u3057\u307e\u3057\u305f\u3002\u3053\u308c\u3092\u53c2\u8003\u306b\u3057\u3066\u3044\u305f\u3060\u3044\u305f\u308a\u3001\u30c4\u30c3\u30b3\u30df\u3092\u3044\u305f\u3060\u3051\u308b\u3068\u5e78\u3044\u3067\u3059\u3002\n\n\u5bfe\u8c61\u8aad\u8005\n\nRuby on Rails\u306b\u30b5\u30d6\u30b9\u30af\u30ea\u30d7\u30b7\u30e7\u30f3\u578b\u306e\u6c7a\u6e08\u30b7\u30b9\u30c6\u30e0\u3092\u7d44\u307f\u8fbc\u307f\u305f\u3044\u30a8\u30f3\u30b8\u30cb\u30a2\n\n\nStripe\u3067\u51fa\u6765\u308b\u3053\u3068\n\n1\u56de\u9650\u308a\u306e\u6c7a\u6e08\uff08\u3053\u306e\u8a18\u4e8b\u306e\u5bfe\u8c61\u5916\uff09\n\u30b5\u30d6\u30b9\u30af\u30ea\u30d7\u30b7\u30e7\u30f3\u578b\u6c7a\u6e08\uff08\u3053\u306e\u8a18\u4e8b\u306e\u5bfe\u8c61\uff09\n\u30af\u30ec\u30b8\u30c3\u30c8\u30ab\u30fc\u30c9\u60c5\u5831\u306e\u4fdd\u6301\uff08\u4e0d\u53ef\u9006\u30c8\u30fc\u30af\u30f3\u5316\uff09\n\u30af\u30fc\u30dd\u30f3\u30b3\u30fc\u30c9\uff08\u5272\u5f15\uff09\u306e\u767a\u884c\u30fb\u9069\u7528\n\u8907\u6570\u901a\u8ca8\u5bfe\u5fdc\u30fb\u901a\u8ca8\u5909\u63db\n\u67d4\u8edf\u306aAPI/Webhook\n\n\nStripe\u306e\u6ce8\u610f\u70b9\n\n\u6c7a\u6e08\u624b\u6570\u6599\u304c\u6bd4\u8f03\u7684\u9ad8\u3044\n\u73fe\u5728\u306e\u3068\u3053\u308d\u3001\u65e5\u672c\u5229\u7528\u3067\u306f\u5229\u7528\u3067\u304d\u308b\u30ab\u30fc\u30c9\u30d6\u30e9\u30f3\u30c9\u304cVisa, Master, Amex\u306b\u9650\u3089\u308c\u308b\n\n\nWhich cards and payment types can I accept with Stripe?\n\n\n\n\n\u5404\u7a2e\u30b5\u30fc\u30d3\u30b9\u3068\u306e\u6bd4\u8f03\n\u3054\u304f\u6700\u8fd1\u306e\u6bd4\u8f03\u8868\u3092\u4f5c\u6210\u3057\u3066\u3044\u308b\u65b9\u304c\u3044\u3089\u3063\u3057\u3083\u308b\u306e\u3067\u30ea\u30f3\u30af\u3092\u5f35\u3063\u3066\u304a\u304d\u307e\u3059\u3002\n\n\u30aa\u30f3\u30e9\u30a4\u30f3\u6c7a\u6e08\u30b5\u30fc\u30d3\u30b9\u306e\u6bd4\u8f03\uff082016\u5e749\u6708\uff09\n\nStripe\u306f\u6c7a\u6e08\u624b\u6570\u6599(3.6%)\u304c\u7af6\u5408\u30b5\u30fc\u30d3\u30b9\u306b\u6bd4\u3079\u9ad8\u3044\u3067\u3059\u304c\u3001\u30e9\u30a4\u30d6\u30e9\u30ea\u3084StackOverflow\u306a\u3069\u3067\u306e\u30b3\u30df\u30e5\u30cb\u30c6\u30a3\u304c\u6d3b\u767a\u306a\u305f\u3081\u3001\u56f0\u3063\u305f\u3068\u304d\u306e\u30c8\u30e9\u30d6\u30eb\u30b7\u30e5\u30fc\u30c6\u30a3\u30f3\u30b0\u306f\u6bd4\u8f03\u7684\u5bb9\u6613\u3067\u3059\u3002\nhttps://github.com/stripe/stripe-ruby\nhttp://stackoverflow.com/questions/tagged/stripe-payments\n\u307e\u305f\u65e5\u672c\u6cd5\u4eba\u3082\u3042\u308b\u306e\u3067\u3001\u65e5\u672c\u8a9e\u3067\u306e\u30b5\u30dd\u30fc\u30c8\u3082\u67d4\u8edf\u306b\u5bfe\u5fdc\u3057\u3066\u304f\u308c\u308b\u3088\u3046\u3067\u3059\u3002\n\nStripe\u30a2\u30ab\u30a6\u30f3\u30c8\u4f5c\u6210\u304b\u3089\u5229\u7528\u307e\u3067\n\u9a5a\u304f\u3079\u304d\u3053\u3068\u306b\u3001Stripe\u3092\u4f7f\u3063\u3066\u672c\u756a\u30b5\u30fc\u30d3\u30b9\u3068\u3057\u3066\u63d0\u4f9b\u3059\u308b\u305f\u3081\u306b\u5be9\u67fb\u306f\u5fc5\u8981\u3042\u308a\u307e\u305b\u3093\u3002\uff08PAY.JP\u306a\u3069\u3082\u540c\u69d8\u306a\u3088\u3046\u3067\u3059\uff09\n\u672c\u756a\u5229\u7528\u958b\u59cb\u3068\u4e26\u884c\u3057\u3066\u3001\u30b5\u30fc\u30d3\u30b9\u63d0\u4f9b\u4e3b\u306e\u5be9\u67fb\u3092Web\u4e0a\u304b\u3089\u884c\u3046\u3053\u3068\u304c\u3067\u304d\u3001\u6570\u65e5\u4ee5\u5185\u306b\u5be9\u67fb\u304c\u5b8c\u4e86\u3057\u8a2d\u5b9a\u3057\u305f\u9280\u884c\u53e3\u5ea7\u306b\u632f\u308a\u8fbc\u307e\u308c\u307e\u3059\u3002\n\nRails\u30b5\u30fc\u30d3\u30b9\u306bStripe\u3092\u7d44\u307f\u8fbc\u3080\n\n\u30b5\u30fc\u30d3\u30b9\u306e\u4ed5\u69d8\nStripe\u306eAPI\u3092\u5229\u7528\u3059\u308b\u3053\u3068\u3067\u3001\u5dee\u984d\u306e\u6271\u3044\u3084\u6c7a\u6e08\u65e5\u306e\u8a2d\u5b9a\u306a\u3069\u69d8\u3005\u306a\u8a2d\u5b9a\u304c\u53ef\u80fd\u3067\u3059\u304c\u3001\u3053\u3053\u3067\u306f\u3001\u4e00\u756a\u30b7\u30f3\u30d7\u30eb\u306b\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u30b5\u30fc\u30d3\u30b9\u3068\u6c7a\u6e08\u306e\u4ed5\u69d8\u3092\u8003\u3048\u307e\u3059:\n\n\u30b5\u30fc\u30d3\u30b9\u306b\u306fUser\u3068Team\u304c\u3042\u308a\u3001Team\u6bce\u306b\u6c7a\u6e08\u3092\u8a2d\u5b9a\u3067\u304d\u308b\n\u30b5\u30d6\u30b9\u30af\u30ea\u30d7\u30b7\u30e7\u30f3\u578b\u306f\u524d\u6255\u3044\u306e\u6708\u984d\uff08monthly\uff09\u3067\u81ea\u52d5\u7684\u306b\u66f4\u65b0\u3059\u308b\n\u30b5\u30fc\u30d3\u30b9\u306b\u306f\u7121\u6599\u30d7\u30e9\u30f3\u3068\u6709\u6599\u30d7\u30e9\u30f3\u304c\u3042\u308a\u3001\u7121\u6599\u30d7\u30e9\u30f3\u306f\u30af\u30ec\u30b8\u30c3\u30c8\u30ab\u30fc\u30c9\u3092\u767b\u9332\u305b\u305a\u306b\u4f7f\u3048\u308b\n\u30e6\u30fc\u30b6\u30fc\u306f\u7121\u6599\u30d7\u30e9\u30f3\u3068\u6709\u6599\u30d7\u30e9\u30f3\u3092\u4efb\u610f\u306e\u30bf\u30a4\u30df\u30f3\u30b0\u3067\u5207\u308a\u66ff\u3048\u308b\u3053\u3068\u304c\u3067\u304d\u308b\n\n\n\u5dee\u984d\u306b\u3064\u3044\u3066\u306e\u4ed5\u69d8\nStripe\u304c\u30c7\u30d5\u30a9\u30eb\u30c8\u3067\u63a8\u5968\u3059\u308b\u5dee\u984d\u306e\u6271\u3044\u306f\u3001\u300c\u6c7a\u6e08\u65e5\u306f\u5909\u3048\u305a\u306b\u91d1\u984d\u306e\u5897\u6e1b\u3067\u5bfe\u5fdc\u3059\u308b\u300d\u3068\u3044\u3046\u30b3\u30f3\u30bb\u30d7\u30c8\u3067\u3059\u3002\n\u30d7\u30e9\u30f3\u5909\u66f4\u3068\u540c\u6642\u306b\u5dee\u984d\u3092\u8acb\u6c42\u30fb\u8fd4\u91d1\u3059\u308b\u3053\u3068\u3082\u3067\u304d\u307e\u3059\u304c\u3001\u305d\u306e\u305f\u3081\u306b\u306fAPI\u3084Webhook\u3092\u5229\u7528\u3057\u305f\u8ffd\u52a0\u958b\u767a\u304c\u5fc5\u8981\u3067\u3059\u3002\n\u3053\u3053\u3067\u306f\u3001Stripe\u306e\u63a8\u5968\u3059\u308b\u65b9\u5f0f\u3067\u5bfe\u5fdc\u3057\u3066\u307f\u307e\u3059\u3002\n\n\u30d1\u30bf\u30fc\u30f3A: \u30d7\u30e9\u30f3\u5909\u66f4\u6642\u306b\u4e0d\u8db3\u306e\u5dee\u984d\u304c\u767a\u751f\u3057\u305f\u5834\u5408\n\n\n\u6b21\u56de\u6c7a\u6e08\u6642\u306b\u4e0a\u4e57\u305b\u3057\u3066\u8acb\u6c42\u3059\u308b\n\n\n\u30d1\u30bf\u30fc\u30f3B: \u30d7\u30e9\u30f3\u5909\u66f4\u6642\u306b\u904e\u5270\u306e\u5dee\u984d\u304c\u767a\u751f\u3057\u305f\u5834\u5408\n\n\n\u6b21\u56de\u4ee5\u964d\u306e\u6c7a\u6e08\u304b\u3089\u76f8\u6bba\u3059\u308b\n\n\n\n\u5177\u4f53\u7684\u306b\u30011,000\u5186\u30684,000\u5186\u306e\u30d7\u30e9\u30f3\u304c\u3042\u308b\u6642\u306b\u3001\u3053\u308c\u3089\u306e\u9593\u3067\u30d7\u30e9\u30f3\u5909\u66f4\u3057\u305f\u3089\u3069\u3046\u306a\u308b\u304b\u56f3\u3067\u793a\u3057\u3066\u307f\u307e\u3059\u3002\n\n\u6ce8\u610f\u304c\u5fc5\u8981\u306a\u306e\u306f\u3001\u300c\u4f59\u5270\u6b8b\u9ad8\u300d\u304c\u767a\u751f\u3057\u305f\u72b6\u614b\u3067\u30e6\u30fc\u30b6\u30fc\u304c\u30a2\u30ab\u30a6\u30f3\u30c8\u524a\u9664\uff08\u9000\u4f1a\uff09\u3057\u3066\u3057\u307e\u3046\u3068\u3001\u305d\u306e\u6a29\u5229\u304c\u6d88\u6ec5\u3059\u308b\u3053\u3068\u306b\u306a\u308a\u307e\u3059\u3002\n\u8a73\u7d30\u306fStripe docs\u5185\u306e Upgrading and Downgrading Plans \u306b\u8a18\u8f09\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n\uff08\u56f3\u4e2d\u3067\u306f\u308f\u304b\u308a\u306b\u304f\u3044\u3067\u3059\u304c\u3001\u5dee\u984d\u306e\u8a08\u7b97\u306f\u300c\u79d2\u5358\u4f4d\u300d\u3067\u884c\u308f\u308c\u308b\u3088\u3046\u3067\u3059\uff09\n\nRails\u5074\u306e\u30e2\u30c7\u30eb\nRails\u5074\u306b\u306f\u3082\u3068\u3082\u3068\u5229\u7528\u8005\u3092\u8868\u3059User\u30e2\u30c7\u30eb\u3068\u3001User\u304c\u8907\u6570\u96c6\u307e\u308a\u7d44\u7e54\u3092\u8868\u3059Team\u30e2\u30c7\u30eb\u304c\u3042\u308b\u3068\u3057\u307e\u3059\u3002\n\u6c7a\u6e08\u306fTeam\u5358\u4f4d\u3067\u884c\u3046\u3068\u3057\u3001\u6c7a\u6e08\u306b\u95a2\u3059\u308b\u6a29\u9650\u306fTeam\u306b\u7d10\u3065\u304fUser\u304c\u884c\u3048\u308b\u3068\u3057\u307e\u3059\u3002\n\nUser\n\n\n\u30b5\u30fc\u30d3\u30b9\u306e\u5229\u7528\u30e6\u30fc\u30b6\u30fc\u3092\u8868\u3059\u30e2\u30c7\u30eb\n\n\nTeam\n\n\n\nUser\u3092\u675f\u306d\u308b\u7d44\u7e54\u3092\u8868\u3059\u30e2\u30c7\u30eb\n\n\nPlan\n\n\n\u6599\u91d1\u30d7\u30e9\u30f3\u3092\u8868\u3059\u30de\u30b9\u30bf\u30c7\u30fc\u30bf\n\u91d1\u984d\u304c\u542b\u307e\u308c\u308b\n\n\nInvoice\n\n\n\u8acb\u6c42\u60c5\u5831\n\u30b5\u30d6\u30b9\u30af\u30ea\u30d7\u30b7\u30e7\u30f3\u304c\u66f4\u65b0\u3055\u308c\u308b\u6bce\u306b\u4f5c\u6210\u3055\u308c\u308b\n\u3053\u306e\u30c7\u30fc\u30bf\u3092\u3082\u3068\u306b\u30b5\u30fc\u30d3\u30b9\u4e0a\u3084\u30e1\u30fc\u30eb\u3067\u306e\u8acb\u6c42\u66f8\u60c5\u5831\u3092\u751f\u6210\u3059\u308b \n\n\n\n\n\nStripe\u5074\u306e\u30e2\u30c7\u30eb\nStripe\u5074\u306b\u306f\u3001\u30b5\u30d6\u30b9\u30af\u30ea\u30d7\u30b7\u30e7\u30f3\u578b\u6c7a\u6e08\u306e\u305f\u3081\u306e\u3044\u304f\u3064\u304b\u306e\u30e2\u30c7\u30eb\u304c\u5b58\u5728\u3057\u3001\u3044\u304f\u3064\u304b\u306e\u30c7\u30fc\u30bf\u306fRails\u5074\u3068\u540c\u671f\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\nStripe\u306b\u306f\u5145\u5b9f\u3057\u305fAPI\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u304c\u3042\u308a\u307e\u3059\u304c\u3001\u30b5\u30d6\u30b9\u30af\u30ea\u30d7\u30b7\u30e7\u30f3\u578b\u6c7a\u6e08\u3092\u5b9f\u88c5\u3059\u308b\u3060\u3051\u306a\u3089\u3001\u4ee5\u4e0b\u306e\u30e2\u30c7\u30eb\u3060\u3051\u77e5\u3063\u3066\u304a\u3051\u3070\u5341\u5206\u3067\u3059\u3002\n\uff08\u4ee5\u964d\u3001Rails\u5074\u306e\u30e2\u30c7\u30eb\u3068\u533a\u5225\u3059\u308b\u305f\u3081\u306bStripe::\u3068\u3044\u3046prefix\u3092\u4ed8\u3051\u307e\u3059\uff09\n\nStripe::Plan\n\n\n\u30b5\u30d6\u30b9\u30af\u30ea\u30d7\u30b7\u30e7\u30f3\u306e\u6599\u91d1\u30d7\u30e9\u30f3\u3092\u8868\u3059\u30e2\u30c7\u30eb\n\u6c7a\u6e08\u5468\u671f\uff08monthly\uff09\u3084\u91d1\u984d\u3001\u901a\u8ca8\u3001\u7a0e\u984d\uff08\u6d88\u8cbb\u7a0e\u30fb\u4ed8\u52a0\u4fa1\u5024\u7a0e\uff09\u306a\u3069\nhttps://stripe.com/docs/api#plans\n\n\nStripe::Customer\n\n\n\u6c7a\u6e08\u30a2\u30ab\u30a6\u30f3\u30c8\u306b\u3042\u305f\u308b\u30e2\u30c7\u30eb\u3002Rails\u5074\u306eTeam\u30681\u5bfe1\u3067\u5bfe\u5fdc\n\u7121\u6599\u30d7\u30e9\u30f3\u3067\u3082\u5bfe\u5fdc\u3059\u308bStripe::Customer\u304c\u5b58\u5728\u3059\u308b\nhttps://stripe.com/docs/api#customers\n\n\nStripe::Token\n\n\n\u30af\u30ec\u30b8\u30c3\u30c8\u30ab\u30fc\u30c9\u60c5\u5831\u3092\u30c8\u30fc\u30af\u30f3\u5316\u3057\u305f\u30c7\u30fc\u30bf\n\u30d6\u30e9\u30a6\u30b6\u304b\u3089JavaScript\u3092\u4f7f\u3063\u3066\u30af\u30ec\u30b8\u30c3\u30c8\u30ab\u30fc\u30c9\u60c5\u5831\u3092Stripe\u306b\u9001\u308b\u3068\u53d6\u5f97\u3067\u304d\u308b\nRails\u5074\u306f\u3053\u306eStripe::Token\u3092\u4f7f\u3063\u3066\u3084\u308a\u53d6\u308a\u3059\u308b\u305f\u3081\u30ab\u30fc\u30c9\u60c5\u5831\u3092\u53d6\u5f97\u3059\u308b\u5fc5\u8981\u306f\u306a\u3044\nhttps://stripe.com/docs/api#tokens\n\n\nStripe::Card\n\n\n\u30c8\u30fc\u30af\u30f3\u5316\u3055\u308c\u305f\u30af\u30ec\u30b8\u30c3\u30c8\u30ab\u30fc\u30c9\u60c5\u5831\n\u4f4f\u6240\u3084\u30ab\u30fc\u30c9\u30d6\u30e9\u30f3\u30c9\u30fb\u30ab\u30fc\u30c9\u306e\u4e0b4\u6841\u306a\u3069\n\nStripe::Token\u3092\u4f7f\u3063\u3066\u3084\u308a\u53d6\u308a\u3059\u308b\nhttps://stripe.com/docs/api#cards\n\n\nStripe::Subscription\n\n\n\nStripe::Customer\u306e\u30d7\u30e9\u30f3\u72b6\u6cc1\u3084\u6b21\u306e\u6c7a\u6e08\u65e5\u306a\u3069\u306e\u60c5\u5831\u3092\u6301\u3064\n\nStripe::Customer\u3068Stripe::Plan\u306b\u7d10\u3065\u304f\nhttps://stripe.com/docs/api#subscriptions\n\n\nStripe::Invoice\n\n\n\u8acb\u6c42\u60c5\u5831\n\u30b5\u30d6\u30b9\u30af\u30ea\u30d7\u30b7\u30e7\u30f3\u306e\u66f4\u65b0\u6642\uff08monthly\u306e\u5834\u5408\u306f\u6bce\u67081\u56de\uff09\u306b\u4f5c\u6210\u3055\u308c\u308b\n\u5c0f\u8a08\u30fb\u7a0e\u984d\u30fb\u5408\u8a08\u91d1\u984d\u30fb\u8acb\u6c42\u306e\u30b9\u30c6\u30fc\u30bf\u30b9\u306a\u3069\u306e\u60c5\u5831\u3092\u6301\u3064\nhttps://stripe.com/docs/api#invoices\n\n\n\n\n\u6599\u91d1\u30d7\u30e9\u30f3\u3092Stripe\u306b\u540c\u671f\u3059\u308b\nStripe\u3067\u30b5\u30d6\u30b9\u30af\u30ea\u30d7\u30b7\u30e7\u30f3\u578b\u6c7a\u6e08\u3092\u5c0e\u5165\u3059\u308b\u305f\u3081\u306b\u306f\u3001\u6599\u91d1\u30d7\u30e9\u30f3\u60c5\u5831\u3092Stripe\u5074\u306b\u540c\u671f\u3057\u3066\u304a\u304f\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\nStripe\u306b\u306f\u516c\u5f0f\u306egem\u304c\u3042\u308b\u306e\u3067\u3001\u3053\u308c\u3092\u4f7f\u3063\u3066Stripe::Plan\u306e\u767b\u9332\u3057\u307e\u3057\u3087\u3046\u3002\nAPI\u30ad\u30fc\u306e\u8a2d\u5b9a\u306a\u3069\u306f\u4e8b\u524d\u306b\u6e08\u307e\u305b\u3066\u304a\u3044\u3066\u304f\u3060\u3055\u3044\u3002\n\nconfig/initializers/stripe.rb\nStripe.api_key = ENV.fetch('STRIPE_SECRET_KEY')\n\n\n\u307e\u305a\u3001Plan\u30e2\u30c7\u30eb\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u69cb\u9020\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002\n\napp/models/plan.rb\n# == Schema Information\n#\n# Table name: plans\n#\n#  id                        :integer          not null, primary key\n#  stripe_plan_id            :string(255)      not null\n#  name                      :string(255)      not null\n#  amount                    :integer          not null\n#  currency                  :integer          not null\n#  interval                  :string(255)      not null\n#  statement_descriptor      :string(22)       not null\n#\nclass Plan < ActiveRecord::Base\n  has_many   :teams\n\n  FREE_PLAN_ID = 1\n\n  ...\nend\n\n\nStripe::Plan\u306eid\u3092\u4fdd\u5b58\u3059\u308b\u305f\u3081\u306bstripe_plan_id \u3068\u3044\u3046\u30ab\u30e9\u30e0\u304c\u3042\u308a\u307e\u3059\u3002\n\u3053\u306ePlan\u30e2\u30c7\u30eb\u306b\u6599\u91d1\u30c7\u30fc\u30bf\u3092\u8ffd\u52a0\u3057\u3001Stripe::Plan\u306b\u540c\u671f\u3057\u307e\u3059\u3002\n\nsome-seed.rake\nPlan.create(\n    id: 1,\n    stripe_plan_id: 'start-plan',\n    name: 'Start Plan',\n    amount: 1000,\n    currency: :jpy,\n    interval: 'month',\n    statement_descriptor: 'Start Plan',\n)\n...\n\nPlan.find_each do |plan|\n  Stripe::Plan.create(\n    id:       plan.stripe_plan_id,\n    amount:   plan.amount, # e.g. 1000\n    currency: plan.currency, # e.g. 'jpy'\n    interval: plan.interval, # e.g. 'month\n    name:     plan.name,\n    statement_descriptor: plan.statement_descriptor\n  )\nend\n\n\n\u6b63\u5e38\u306b\u540c\u671f\u3055\u308c\u305f\u304b\u3069\u3046\u304b\u3001Stripe\u306e\u7ba1\u7406\u753b\u9762\u304b\u3089\u78ba\u8a8d\u3057\u3066\u307f\u307e\u3057\u3087\u3046\u3002\n\n\nStripe::Customer\u3092\u4f5c\u6210\u3059\u308b\n\u3053\u3053\u3067\u306f\u3001\u5148\u306b\u7121\u6599\u30d7\u30e9\u30f3\u306b\u306a\u3063\u3066\u30b5\u30fc\u30d3\u30b9\u3092\u4f53\u9a13\u3057\u3066\u3082\u3089\u3063\u3066\u304b\u3089\u6709\u6599\u30d7\u30e9\u30f3\u306b\u79fb\u884c\u3059\u308b\u3068\u3044\u3046\u30b7\u30ca\u30ea\u30aa\u3092\u8003\u3048\u3066\u307f\u307e\u3059\u3002\u76f4\u63a5\u6709\u6599\u30d7\u30e9\u30f3\u306b\u306a\u308b\u5834\u5408\u306f\u3001\u6b21\u306e\u30bb\u30af\u30b7\u30e7\u30f3\u3068\u4e00\u7dd2\u306b\u9032\u3081\u3066\u304f\u3060\u3055\u3044\u3002\nTeam\u4f5c\u6210\u6642\u306b\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u3067Stripe::Customer\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\nTeam\u306b\u306fStripe::Card\u3001Stripe::Customer\u3068Stripe::Subscription\u3092\u4fdd\u5b58\u3059\u308b\u305f\u3081\u306b\u3001stripe_card_id\u3001stripe_customer_id\u3001stripe_subscription_id\u304c\u3042\u308a\u307e\u3059\u3002\n\u307e\u305f\u3001\u30b5\u30d6\u30b9\u30af\u30ea\u30d7\u30b7\u30e7\u30f3\u306e\u66f4\u65b0\u65e5\u3068\u306a\u308b\u60c5\u5831\u3068\u3057\u3066active_until\u3092\u6301\u3061\u3001Stripe\u306e\u6c7a\u6e08\u304c\u6b63\u5e38\u306b\u5b8c\u4e86\u3057\u305f\u6642\u306b\u66f4\u65b0\u3055\u308c\u308b\u3088\u3046\u306b\u3059\u308b\u3002\n\napp/models/team.rb\n# == Schema Information\n#\n# Table name: teams\n#\n#  id                        :integer          not null, primary key\n#  plan_id            :integer\n#  stripe_card_id            :string(255)\n#  stripe_customer_id        :string(255)\n#  stripe_subscription_id        :string(255)\n#  active_until            :datetime         not null\n#\nclass Team < ActiveRecord::Base\n  belongs_to :owner,            class_name: 'User'\n  belongs_to :plan\n  before_validation :create_stripe_customer_and_subscription, if: :new_record?\n\n  private\n\n    # Team\u4f5c\u6210\u6642\u306bStripe::Customer, Stripe::Subscription\u3092\u4f5c\u6210\u3057\u3001\u3072\u3082\u4ed8\u3051\n    def create_stripe_customer_and_subscription\n      # Stripe::Customer \u4f5c\u6210\n      stripe_customer = Stripe::Customer.create(\n        email:       owner.email,\n        plan:        Plan::FREE_PLAN_ID,\n        tax_percent: 8.0,\n        metadata: {\n          owner_id: owner.id,\n          rails_env: Rails.env.to_s\n        } # \u30c7\u30d0\u30c3\u30b0\u3084\u7ba1\u7406\u306e\u305f\u3081metadata\u3092\u4efb\u610f\u306b\u8ffd\u52a0\u3067\u304d\u308b\n      )\n\n      self.plan = Plan.free_plan\n      self.stripe_customer_id = stripe_customer.id\n      stripe_subscription = stripe_customer.subscriptions.data.first\n      self.stripe_subscription_id = stripe_subscription.id\n      self.active_until = Time.zone.at(stripe_subscription.current_period_end),\n    end\nend\n\n\n\n\u6709\u6599\u30d7\u30e9\u30f3\u306b\u5909\u66f4\u3059\u308b\n\u6709\u6599\u30d7\u30e9\u30f3\u306b\u5909\u66f4\u3059\u308b\u305f\u3081\u306b\u306f\u3001\u30af\u30ec\u30b8\u30c3\u30c8\u30ab\u30fc\u30c9\u3092\u767b\u9332\u3057\u306a\u3044\u3068\u3044\u3051\u307e\u305b\u3093\u304c\u3001\u305d\u306e\u524d\u306b\u30af\u30ec\u30b8\u30c3\u30c8\u30ab\u30fc\u30c9\u306e\u30c8\u30fc\u30af\u30f3\u5316\u3092\u884c\u3046\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\nStripe\u306fStripe.js\u3068\u3044\u3046JavaScript\u306e\u30e9\u30a4\u30d6\u30e9\u30ea\u3092\u63d0\u4f9b\u3057\u3066\u3044\u3066\u3001\u3053\u308c\u3092\u5229\u7528\u3057\u3066Rails\u5074\u3068\u3084\u308a\u3068\u308a\u305b\u305a\u306b\u3001\u76f4\u63a5Stripe\u3068\u901a\u4fe1\u3057\u3066\u30af\u30ec\u30b8\u30c3\u30c8\u30ab\u30fc\u30c9\u60c5\u5831\u3092\u30c8\u30fc\u30af\u30f3\uff08Stripe::Token\uff09\u306b\u5909\u63db\u3057\u307e\u3059\u3002\n\u8a73\u7d30\u306fStripe\u306eDocs\u306e Creating a Custom Payment Form with Stripe.js \u306b\u3042\u308a\u307e\u3059\u306e\u3067\u3001\u3053\u3053\u3067\u306f\u6d41\u308c\u306e\u6982\u8981\u3092\u8aac\u660e\u3057\u307e\u3059\u3002\n\u307e\u305a\u3001\u30af\u30ec\u30b8\u30c3\u30c8\u30ab\u30fc\u30c9\u60c5\u5831\u3092\u5165\u529b\u3059\u308b\u30d5\u30a9\u30fc\u30e0\u3068Stripe.js\u3092\u8aad\u307f\u8fbc\u3080script\u30bf\u30b0\u3092\u8a2d\u7f6e\u3057\u307e\u3059\u3002\n<%= form_tag(subscription_path, method: 'post', id: 'payment-form') do %>\n  <%# Plan\u3092\u9078\u629e %>\n  <%= select_tag 'plan_id', Plan.all.map{|i| [i.name, i.id]} %>\n\n  <%# \u30ab\u30fc\u30c9\u60c5\u5831\u3092\u5165\u529b (Rails\u30b5\u30fc\u30d0\u306b\u306f\u9001\u4fe1\u3055\u308c\u306a\u3044) %>\n  Card Number: <input type=\"text\" size=\"20\" data-stripe=\"number\">\n  Expire: <input type=\"text\" size=\"2\" data-stripe=\"exp_month\">/<input type=\"text\" size=\"2\" data-stripe=\"exp_year\">  \n  CVC: <input type=\"text\" size=\"4\" data-stripe=\"cvc\">\n\n  <input type=\"submit\" class=\"submit\" value=\"Submit Payment\">\n</form>\n\n<script type=\"text/javascript\" src=\"https://js.stripe.com/v2/\"></script>\n\n\u3053\u306e\u6642\u306b\u5404\u30d5\u30a3\u30fc\u30eb\u30c9\u30bf\u30b0\u306bname\u5c5e\u6027\u3092\u6307\u5b9a\u3057\u306a\u3044\u306e\u304c\u30dd\u30a4\u30f3\u30c8\u3067\u3059\u3002\u305d\u308c\u306b\u3088\u3063\u3066\u3001\u30ab\u30fc\u30c9\u60c5\u5831\u304c\u30b5\u30fc\u30d0\u306b\u9001\u4fe1\u3055\u308c\u308b\u306e\u3092\u9632\u304e\u307e\u3059\u3002\n\u6b21\u306bJavaScript\u3067\u30ab\u30fc\u30c9\u60c5\u5831\u3092Stripe::Token\u306b\u5909\u63db\u3057\u307e\u3059\u3002\nStripe.card.createToken\u3068\u3044\u3046\u30e1\u30bd\u30c3\u30c9\u306bForm\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u6e21\u3059\u3068\u3001\u5fc5\u8981\u306a\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u53d6\u5f97\u3057\u3001\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u3067Stripe::Token\u3092\u8fd4\u3057\u3066\u304f\u308c\u307e\u3059\u3002\n<script type=\"text/javascript\">\n  Stripe.setPublishableKey('<\u3053\u3053\u306bAPI\u30ad\u30fc\u3092\u5165\u308c\u308b>');\n\n  var $form = $('#payment-form');\n\n  $form.submit(function(event) {\n    Stripe.card.createToken($form, function (status, response) {\n\n    // JSON\u30ec\u30b9\u30dd\u30f3\u30b9\u304b\u3089\u30c8\u30fc\u30af\u30f3\u3092\u53d6\u5f97\n    var token = response.id;\n\n    // \u30d5\u30a9\u30fc\u30e0\u306b\u30c8\u30fc\u30af\u30f3\u3092\u633f\u5165\n    $form.append($('<input type=\"hidden\" name=\"stripeToken\">').val(token));\n\n    // \u30d5\u30a9\u30fc\u30e0\u3092\u9001\u4fe1\n    $form.get(0).submit();\n    );\n  });\n};\n</script>\n\n\u30b5\u30fc\u30d0\u5074\u3067\u306fStripe::Token\u3092\u53d7\u3051\u53d6\u3063\u3066\u3001Stripe::Customer\u306b\u8a2d\u5b9a\u3001\u3055\u3089\u306b\u30d7\u30e9\u30f3\u5909\u66f4\u3092\u884c\u3044\u307e\u3059\u3002\n\nController\nstripe_customer = Stripe::Customer.retrieve(@team.stripe_customer_id)\nstripe_customer.source = params[:stripeToken] # Stripe.js\u3067\u5909\u63db\u3057\u305f\u30c8\u30fc\u30af\u30f3\u3092\u6e21\u3059\u3060\u3051\nstripe_customer.save\n\nstripe_subscription = Stripe::Subscription.retrieve(@team.stripe_subscription_id)\nstripe_subscription.plan = Plan.find(params[:plan_id])\nstripe_subscription.save\n\n\n\n\u6700\u521d\u306e\u6c7a\u6e08\u65e5\nStripe\u306fWebhook\u306e\u4ed5\u7d44\u307f\u3092\u6301\u3063\u3066\u3044\u308b\u306e\u3067\u3001\u6c7a\u6e08\u304c\u5b9f\u884c\u3055\u308c\u308b\u3068\u305d\u306e\u60c5\u5831\u3092Rails\u3067\u53d7\u3051\u53d6\u308b\u4e8b\u304c\u3067\u304d\u307e\u3059\u3002\n\u306a\u306e\u3067\u3001Rails\u5074\u306ecron\u306a\u3069\u306e\u4ed5\u7d44\u307f\u3092\u6301\u3064\u5fc5\u8981\u306f\u3042\u308a\u307e\u305b\u3093\u3002\n\u3053\u308c\u3092\u4f7f\u3063\u3066\u3001\u30b5\u30d6\u30b9\u30af\u30ea\u30d7\u30b7\u30e7\u30f3\u306e\u6709\u52b9\u671f\u9650\u3067\u3042\u308bTeam#active_until\u306e\u66f4\u65b0\u3092\u884c\u3044\u307e\u3059\u3002\u305d\u308c\u3068\u540c\u6642\u306b\u8acb\u6c42\u66f8\u306b\u5229\u7528\u3059\u308bInvoice\u60c5\u5831\u3092\u4fdd\u5b58\u3057\u307e\u3059\u3002\n\u307e\u305f\u3001\u6c7a\u6e08\u304c\u5931\u6557\u3057\u305f\u5834\u5408\u306b\u306f\u3001\u304a\u77e5\u3089\u305b\u30e1\u30fc\u30eb\u3092\u30e6\u30fc\u30b6\u30fc\u306b\u9001\u308b\u3053\u3068\u3082\u3067\u304d\u307e\u3059\u3002\n\nWebhookController\ndef create\n    event_json = JSON.parse(request.body.read)\n    event = Stripe::Event.retrieve(event_json['id'])\n\n    ActiveRecord::Base.transaction do\n      case event.type\n\n      # subscription\u306e\u66f4\u65b0\n      #   => Invoice\u60c5\u5831\u3092\u4fdd\u5b58\n      when 'customer.subscription.updated'\n        stripe_subscription = event.data.object\n\n        team = Team.find_by!(stripe_subscription_id: stripe_subscription.id)\n        team.update!(\n          active_until: Time.zone.at(stripe_subscription.current_period_end)\n        )\n\n      # \u6c7a\u6e08\u6210\u529f\n      #   => DB\u5185\u306e\u6709\u52b9\u671f\u9650\u3092\u5ef6\u9577\n      when 'invoice.payment_succeeded'\n        stripe_invoice = event.data.object\n\n        team = Team.find_by!(stripe_subscription_id: stripe_invoice.subscription)\n        stripe_subscription = stripe_invoice.lines.data.detect { |d| d.type == 'subscription' }\n\n        invoice = Invoice.find_or_initialize_by(stripe_invoice_id: stripe_invoice.id)\n        invoice.amount_due           = stripe_invoice.amount_due\n        invoice.stripe_invoice_id    = stripe_invoice.id\n        invoice.stripe_charge_id     = stripe_invoice.charge\n        invoice.closed               = stripe_invoice.closed\n        invoice.currency             = stripe_invoice.currency\n        invoice.payment_processed_at = Time.zone.at(stripe_invoice.date)\n        invoice.stripe_customer_id   = stripe_invoice.customer\n        invoice.next_payment_attempt = stripe_invoice.next_payment_attempt\n        invoice.paid                 = stripe_invoice.paid\n        invoice.subtotal             = stripe_invoice.subtotal\n        invoice.tax                  = stripe_invoice.tax || 0\n        invoice.tax_percent          = stripe_invoice.tax_percent || 0\n        invoice.total                = stripe_invoice.total\n        invoice.subscription_period_start_at = Time.zone.at(stripe_subscription.period.start)\n        invoice.subscription_period_end_at   = Time.zone.at(stripe_subscription.period.end)\n        invoice.starting_balance     = stripe_invoice.starting_balance\n        invoice.ending_balance       = stripe_invoice.ending_balance\n        invoice.save!\n\n      # \u6c7a\u6e08\u5931\u6557\n      #   => \u30e6\u30fc\u30b6\u30fc\u306b\u30e1\u30fc\u30eb\u3092\u9001\u308b\n      when 'invoice.payment_failed'\n        stripe_invoice = event.data.object\n\n        team = Team.find_by!(stripe_subscription_id: stripe_invoice.subscription)\n        PaymentMailer.payment_failed_email(team).deliver_now\n      end\n    end\n  end\nend\n\n\n\n\u30d7\u30e9\u30f3\u5909\u66f4\u3059\u308b\n\u65e2\u306b\u30af\u30ec\u30b8\u30c3\u30c8\u30ab\u30fc\u30c9\u60c5\u5831\u304cStripe::Customer\u306b\u7d10\u4ed8\u3044\u3066\u3044\u308c\u3070\u3001\u30d7\u30e9\u30f3\u5909\u66f4\u306f\u305d\u306e\u307e\u307e\u5b9f\u884c\u3067\u304d\u307e\u3059\u3002\n\nController\nstripe_subscription = Stripe::Subscription.retrieve(@team.subscription_id)\nstripe_subscription.plan = Plan.find(params[:plan_id])\nstripe_subscription.save\n\n\n\n\u30a2\u30ab\u30a6\u30f3\u30c8\u524a\u9664\u6642\u306bStripe::Subscription\u3082\u524a\u9664\u3059\u308b\n\u6b8b\u5ff5\u306a\u304c\u3089\u30b5\u30fc\u30d3\u30b9\u304b\u3089\u9000\u4f1a\u3055\u308c\u3066\u3057\u307e\u3046\u30e6\u30fc\u30b6\u30fc\u304c\u3044\u305f\u3068\u304d\u306b\u306f\u3001\u5bfe\u5fdc\u3059\u308b\u30b5\u30d6\u30b9\u30af\u30ea\u30d7\u30b7\u30e7\u30f3\u6c7a\u6e08\u3082\u524a\u9664\u3057\u306a\u3044\u3068\u3044\u3051\u307e\u305b\u3093\u3002\n\u3053\u308c\u306fTeam\u30e2\u30c7\u30eb\u306e\u524a\u9664\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u3067\u884c\u3044\u307e\u3057\u3087\u3046\u3002\n\napp/models/team.rb\nclass Team < ActiveRecord::Base\n  around_destroy :delete_stripe_subscription_before_destroy\n\n  private\n\n  # Team\u524a\u9664\u6642\u306bStripe::Subscription\u3082\u524a\u9664\n  def delete_stripe_subscription_before_destroy\n    ActiveRecord::Base.transaction do\n      deleting_stripe_subscription = Stripe::Subscription.retrieve(stripe_subscription_id)\n      yield\n      deleting_stripe_subscription.delete\n    end\n  end\nend\n\n\n\n\u307e\u3068\u3081\nStripe\u304c\u65e5\u672c\u306b\u4e0a\u9678\u3057\u305f\u3053\u3068\u3067\u3001\u6c7a\u6e08\u7cfb\u30b5\u30fc\u30d3\u30b9\u306e\u30d7\u30ec\u30fc\u30e4\u30fc\u304c\u51fa\u63c3\u3063\u305f\u611f\u3058\u304c\u3042\u308a\u307e\u3059\u3002\n\u30d6\u30ed\u30b0\u7b49\u3067\u500b\u4eba\u7684\u306b\u51fa\u54c1\u3059\u308b\u3088\u3046\u306a\u76ee\u7684\u3067\u306e\u6c7a\u6e08\u30b5\u30fc\u30d3\u30b9\u306b\u6bd4\u3079\u3001\u5546\u7528\u5229\u7528\u3067\u306e\u30b5\u30fc\u30d3\u30b9\u306b\u7d44\u307f\u8fbc\u3080\u305f\u3081\u306e\u6c7a\u6e08\u30b7\u30b9\u30c6\u30e0\u306b\u95a2\u3059\u308b\u60c5\u5831\u306f\u6975\u7aef\u306b\u5c11\u306a\u3044\u306e\u304c\u73fe\u72b6\u3067\u3059\u3002\n\u30ab\u30fc\u30c9\u30d6\u30e9\u30f3\u30c9\u3084\u6c7a\u6e08\u624b\u6570\u6599\u306a\u3069\u306e\u554f\u984c\u3067\u5fc5\u305a\u3057\u3082Stripe\u304c\u30d9\u30b9\u30c8\u306a\u9078\u629e\u80a2\u3067\u306f\u306a\u3044\u5834\u5408\u3082\u3042\u308a\u307e\u3059\u304c\u3001\u30e9\u30a4\u30d6\u30e9\u30ea\u3084\u30b3\u30df\u30e5\u30cb\u30c6\u30a3\u306e\u767a\u5c55\u3067\u5b89\u5fc3\u611f\u304c\u3042\u308b\u3068\u3044\u3046\u30dd\u30a4\u30f3\u30c8\u3082\u3042\u308a\u307e\u3059\u3002\n\u3068\u306f\u3044\u3046\u3082\u306e\u306e\u3001\u3053\u3053\u3067\u8aac\u660e\u3057\u305f\u5185\u5bb9\u306f\u3069\u3093\u306a\u6c7a\u6e08\u30b5\u30fc\u30d3\u30b9\u3092\u5229\u7528\u3057\u3066\u3082\u5fdc\u7528\u53ef\u80fd\u3060\u3068\u601d\u308f\u308c\u308b\u306e\u3067\u3001\u958b\u767a\u8005\u540c\u58eb\u306e\u30b3\u30df\u30e5\u30cb\u30b1\u30fc\u30b7\u30e7\u30f3\u304c\u6d3b\u767a\u306b\u306a\u308c\u3070\u3046\u308c\u3057\u3044\u3067\u3059\u3002\n\n\u53c2\u8003\n\n\u30c9\u30eb\u6c7a\u6e08\u30b5\u30fc\u30d3\u30b9Stripe\u306e\u5168\u5bb9\u3092\u3056\u3063\u304f\u308a\u628a\u63e1\u3059\u308b\n\n\nhttp://qiita.com/tanishi/items/877f0d6144c85e744ca5\n\n\n\u30aa\u30f3\u30e9\u30a4\u30f3\u6c7a\u6e08\u30b5\u30fc\u30d3\u30b9\u306e\u6bd4\u8f03\uff082016\u5e749\u6708\uff09\n\n\nhttp://qiita.com/Masaaki_Inaba/items/c2a5afd1481276f4c60f\n\n\n\u3010\u65e5\u672c\u4e0a\u9678\u3011\u30aa\u30f3\u30e9\u30a4\u30f3\u6c7a\u6e08\u30b5\u30fc\u30d3\u30b9Stripe\u306b\u3088\u308b\u5186\u6c7a\u6e08\u306e\u5b9f\u88c5 \u5165\u9580\n\n\nhttp://qiita.com/hayashier/items/02fd691e5896b9864298\n\n\n\n\n\u8ffd\u8a18\n\n2016-11-10\n\n\n\u30b3\u30fc\u30c9\u5185\u306e\u30cf\u30fc\u30c9\u30b3\u30fc\u30c9\u3055\u308c\u305f\u30b3\u30fc\u30c9\u3092\u6587\u8108\u306b\u5408\u3046\u3088\u3046\u306b\u4fee\u6b63\n\n\n\n\n\n# \u3053\u306e\u8a18\u4e8b\u306e\u6982\u8981\n\n\u65e5\u672c\u3067[\u6b63\u5f0f\u30ea\u30ea\u30fc\u30b9](https://stripe.com/blog/stripe-in-japan)\u3055\u308c\u305f[Stripe](https://stripe.com/)\u3092Ruby on Rails\u306b\u5c0e\u5165\u3057\u3001\u30b5\u30d6\u30b9\u30af\u30ea\u30d7\u30b7\u30e7\u30f3\u578b\uff08\u6708\u984d\u5b9a\u671f\u8ab2\u91d1\uff09\u306e\u6c7a\u6e08\u30b7\u30b9\u30c6\u30e0\u3092\u7d44\u307f\u8fbc\u3080\u65b9\u6cd5\u3092\u8aac\u660e\u3057\u307e\u3059\u3002\n\n\u79c1\u304c\u958b\u767a\u3057\u3066\u3044\u308b [formrun\uff08\u30d5\u30a9\u30fc\u30e0\u30fb\u30e9\u30f3\uff09](https://form.run/) \u3068\u3044\u3046\u30b5\u30fc\u30d3\u30b9\u306b\u3066\u30012016\u6625\u9803\u304b\u3089\u5b9f\u969b\u306b\u30aa\u30fc\u30d7\u30f3\u03b2\u7248\u306eStripe\u3092\u5229\u7528\u3057\u3066\u304d\u305f\u7d4c\u9a13\u3092\u3082\u3068\u306b\u3001\u5177\u4f53\u7684\u306a\u30b3\u30fc\u30c9\u3068\u3068\u3082\u306b\u89e3\u8aac\u3057\u3066\u3044\u304d\u307e\u3059\u3002\n\n\u5b9f\u969b\u306e\u30b3\u30fc\u30c9\u3092\u4f7f\u3063\u305f\u30b5\u30d6\u30b9\u30af\u30ea\u30d7\u30b7\u30e7\u30f3\u578b\u6c7a\u6e08\u306e\u8aac\u660e\u306f\u4f8b\u304c\u5c11\u306a\u304f\u3001\u81ea\u5206\u3082\u5b9f\u88c5\u306b\u975e\u5e38\u306b\u82e6\u52b4\u3057\u307e\u3057\u305f\u3002\u3053\u308c\u3092\u53c2\u8003\u306b\u3057\u3066\u3044\u305f\u3060\u3044\u305f\u308a\u3001\u30c4\u30c3\u30b3\u30df\u3092\u3044\u305f\u3060\u3051\u308b\u3068\u5e78\u3044\u3067\u3059\u3002\n\n\n# \u5bfe\u8c61\u8aad\u8005\n\n- Ruby on Rails\u306b\u30b5\u30d6\u30b9\u30af\u30ea\u30d7\u30b7\u30e7\u30f3\u578b\u306e\u6c7a\u6e08\u30b7\u30b9\u30c6\u30e0\u3092\u7d44\u307f\u8fbc\u307f\u305f\u3044\u30a8\u30f3\u30b8\u30cb\u30a2\n\n# Stripe\u3067\u51fa\u6765\u308b\u3053\u3068\n\n- 1\u56de\u9650\u308a\u306e\u6c7a\u6e08\uff08\u3053\u306e\u8a18\u4e8b\u306e\u5bfe\u8c61\u5916\uff09\n- \u30b5\u30d6\u30b9\u30af\u30ea\u30d7\u30b7\u30e7\u30f3\u578b\u6c7a\u6e08\uff08\u3053\u306e\u8a18\u4e8b\u306e\u5bfe\u8c61\uff09\n- \u30af\u30ec\u30b8\u30c3\u30c8\u30ab\u30fc\u30c9\u60c5\u5831\u306e\u4fdd\u6301\uff08\u4e0d\u53ef\u9006\u30c8\u30fc\u30af\u30f3\u5316\uff09\n- \u30af\u30fc\u30dd\u30f3\u30b3\u30fc\u30c9\uff08\u5272\u5f15\uff09\u306e\u767a\u884c\u30fb\u9069\u7528\n- \u8907\u6570\u901a\u8ca8\u5bfe\u5fdc\u30fb\u901a\u8ca8\u5909\u63db\n- \u67d4\u8edf\u306aAPI/Webhook\n\n# Stripe\u306e\u6ce8\u610f\u70b9\n\n- \u6c7a\u6e08\u624b\u6570\u6599\u304c\u6bd4\u8f03\u7684\u9ad8\u3044\n- \u73fe\u5728\u306e\u3068\u3053\u308d\u3001\u65e5\u672c\u5229\u7528\u3067\u306f\u5229\u7528\u3067\u304d\u308b\u30ab\u30fc\u30c9\u30d6\u30e9\u30f3\u30c9\u304cVisa, Master, Amex\u306b\u9650\u3089\u308c\u308b\n  - [Which cards and payment types can I accept with Stripe?](https://support.stripe.com/questions/which-cards-and-payment-types-can-i-accept-with-stripe)\n\n# \u5404\u7a2e\u30b5\u30fc\u30d3\u30b9\u3068\u306e\u6bd4\u8f03\n\n\u3054\u304f\u6700\u8fd1\u306e\u6bd4\u8f03\u8868\u3092\u4f5c\u6210\u3057\u3066\u3044\u308b\u65b9\u304c\u3044\u3089\u3063\u3057\u3083\u308b\u306e\u3067\u30ea\u30f3\u30af\u3092\u5f35\u3063\u3066\u304a\u304d\u307e\u3059\u3002\n\n- [\u30aa\u30f3\u30e9\u30a4\u30f3\u6c7a\u6e08\u30b5\u30fc\u30d3\u30b9\u306e\u6bd4\u8f03\uff082016\u5e749\u6708\uff09](http://qiita.com/Masaaki_Inaba/items/c2a5afd1481276f4c60f)\n\nStripe\u306f\u6c7a\u6e08\u624b\u6570\u6599(3.6%)\u304c\u7af6\u5408\u30b5\u30fc\u30d3\u30b9\u306b\u6bd4\u3079\u9ad8\u3044\u3067\u3059\u304c\u3001\u30e9\u30a4\u30d6\u30e9\u30ea\u3084StackOverflow\u306a\u3069\u3067\u306e\u30b3\u30df\u30e5\u30cb\u30c6\u30a3\u304c\u6d3b\u767a\u306a\u305f\u3081\u3001\u56f0\u3063\u305f\u3068\u304d\u306e\u30c8\u30e9\u30d6\u30eb\u30b7\u30e5\u30fc\u30c6\u30a3\u30f3\u30b0\u306f\u6bd4\u8f03\u7684\u5bb9\u6613\u3067\u3059\u3002\n\nhttps://github.com/stripe/stripe-ruby\nhttp://stackoverflow.com/questions/tagged/stripe-payments\n\n\u307e\u305f\u65e5\u672c\u6cd5\u4eba\u3082\u3042\u308b\u306e\u3067\u3001\u65e5\u672c\u8a9e\u3067\u306e\u30b5\u30dd\u30fc\u30c8\u3082\u67d4\u8edf\u306b\u5bfe\u5fdc\u3057\u3066\u304f\u308c\u308b\u3088\u3046\u3067\u3059\u3002\n\n# Stripe\u30a2\u30ab\u30a6\u30f3\u30c8\u4f5c\u6210\u304b\u3089\u5229\u7528\u307e\u3067\n\n\u9a5a\u304f\u3079\u304d\u3053\u3068\u306b\u3001Stripe\u3092\u4f7f\u3063\u3066\u672c\u756a\u30b5\u30fc\u30d3\u30b9\u3068\u3057\u3066\u63d0\u4f9b\u3059\u308b\u305f\u3081\u306b\u5be9\u67fb\u306f\u5fc5\u8981\u3042\u308a\u307e\u305b\u3093\u3002\uff08PAY.JP\u306a\u3069\u3082\u540c\u69d8\u306a\u3088\u3046\u3067\u3059\uff09\n\n\u672c\u756a\u5229\u7528\u958b\u59cb\u3068\u4e26\u884c\u3057\u3066\u3001\u30b5\u30fc\u30d3\u30b9\u63d0\u4f9b\u4e3b\u306e\u5be9\u67fb\u3092Web\u4e0a\u304b\u3089\u884c\u3046\u3053\u3068\u304c\u3067\u304d\u3001\u6570\u65e5\u4ee5\u5185\u306b\u5be9\u67fb\u304c\u5b8c\u4e86\u3057\u8a2d\u5b9a\u3057\u305f\u9280\u884c\u53e3\u5ea7\u306b\u632f\u308a\u8fbc\u307e\u308c\u307e\u3059\u3002\n\n\n# Rails\u30b5\u30fc\u30d3\u30b9\u306bStripe\u3092\u7d44\u307f\u8fbc\u3080\n\n## \u30b5\u30fc\u30d3\u30b9\u306e\u4ed5\u69d8\n\nStripe\u306eAPI\u3092\u5229\u7528\u3059\u308b\u3053\u3068\u3067\u3001\u5dee\u984d\u306e\u6271\u3044\u3084\u6c7a\u6e08\u65e5\u306e\u8a2d\u5b9a\u306a\u3069\u69d8\u3005\u306a\u8a2d\u5b9a\u304c\u53ef\u80fd\u3067\u3059\u304c\u3001\u3053\u3053\u3067\u306f\u3001\u4e00\u756a\u30b7\u30f3\u30d7\u30eb\u306b\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u30b5\u30fc\u30d3\u30b9\u3068\u6c7a\u6e08\u306e\u4ed5\u69d8\u3092\u8003\u3048\u307e\u3059:\n\n- \u30b5\u30fc\u30d3\u30b9\u306b\u306f`User`\u3068`Team`\u304c\u3042\u308a\u3001`Team`\u6bce\u306b\u6c7a\u6e08\u3092\u8a2d\u5b9a\u3067\u304d\u308b\n- \u30b5\u30d6\u30b9\u30af\u30ea\u30d7\u30b7\u30e7\u30f3\u578b\u306f\u524d\u6255\u3044\u306e\u6708\u984d\uff08monthly\uff09\u3067\u81ea\u52d5\u7684\u306b\u66f4\u65b0\u3059\u308b\n- \u30b5\u30fc\u30d3\u30b9\u306b\u306f\u7121\u6599\u30d7\u30e9\u30f3\u3068\u6709\u6599\u30d7\u30e9\u30f3\u304c\u3042\u308a\u3001\u7121\u6599\u30d7\u30e9\u30f3\u306f\u30af\u30ec\u30b8\u30c3\u30c8\u30ab\u30fc\u30c9\u3092\u767b\u9332\u305b\u305a\u306b\u4f7f\u3048\u308b\n- \u30e6\u30fc\u30b6\u30fc\u306f\u7121\u6599\u30d7\u30e9\u30f3\u3068\u6709\u6599\u30d7\u30e9\u30f3\u3092\u4efb\u610f\u306e\u30bf\u30a4\u30df\u30f3\u30b0\u3067\u5207\u308a\u66ff\u3048\u308b\u3053\u3068\u304c\u3067\u304d\u308b\n\n\n## \u5dee\u984d\u306b\u3064\u3044\u3066\u306e\u4ed5\u69d8\n\nStripe\u304c\u30c7\u30d5\u30a9\u30eb\u30c8\u3067\u63a8\u5968\u3059\u308b\u5dee\u984d\u306e\u6271\u3044\u306f\u3001\u300c\u6c7a\u6e08\u65e5\u306f\u5909\u3048\u305a\u306b\u91d1\u984d\u306e\u5897\u6e1b\u3067\u5bfe\u5fdc\u3059\u308b\u300d\u3068\u3044\u3046\u30b3\u30f3\u30bb\u30d7\u30c8\u3067\u3059\u3002\n\u30d7\u30e9\u30f3\u5909\u66f4\u3068\u540c\u6642\u306b\u5dee\u984d\u3092\u8acb\u6c42\u30fb\u8fd4\u91d1\u3059\u308b\u3053\u3068\u3082\u3067\u304d\u307e\u3059\u304c\u3001\u305d\u306e\u305f\u3081\u306b\u306fAPI\u3084Webhook\u3092\u5229\u7528\u3057\u305f\u8ffd\u52a0\u958b\u767a\u304c\u5fc5\u8981\u3067\u3059\u3002\n\u3053\u3053\u3067\u306f\u3001Stripe\u306e\u63a8\u5968\u3059\u308b\u65b9\u5f0f\u3067\u5bfe\u5fdc\u3057\u3066\u307f\u307e\u3059\u3002\n\n- \u30d1\u30bf\u30fc\u30f3A: \u30d7\u30e9\u30f3\u5909\u66f4\u6642\u306b\u4e0d\u8db3\u306e\u5dee\u984d\u304c\u767a\u751f\u3057\u305f\u5834\u5408\n  - \u6b21\u56de\u6c7a\u6e08\u6642\u306b\u4e0a\u4e57\u305b\u3057\u3066\u8acb\u6c42\u3059\u308b\n- \u30d1\u30bf\u30fc\u30f3B: \u30d7\u30e9\u30f3\u5909\u66f4\u6642\u306b\u904e\u5270\u306e\u5dee\u984d\u304c\u767a\u751f\u3057\u305f\u5834\u5408\n  - \u6b21\u56de**\u4ee5\u964d**\u306e\u6c7a\u6e08\u304b\u3089\u76f8\u6bba\u3059\u308b\n\n\u5177\u4f53\u7684\u306b\u30011,000\u5186\u30684,000\u5186\u306e\u30d7\u30e9\u30f3\u304c\u3042\u308b\u6642\u306b\u3001\u3053\u308c\u3089\u306e\u9593\u3067\u30d7\u30e9\u30f3\u5909\u66f4\u3057\u305f\u3089\u3069\u3046\u306a\u308b\u304b\u56f3\u3067\u793a\u3057\u3066\u307f\u307e\u3059\u3002\n\n![stripe.png](https://qiita-image-store.s3.amazonaws.com/0/10272/94bd4d0c-cc02-8f9d-186c-5e1593ad67b8.png)\n\n\u6ce8\u610f\u304c\u5fc5\u8981\u306a\u306e\u306f\u3001\u300c\u4f59\u5270\u6b8b\u9ad8\u300d\u304c\u767a\u751f\u3057\u305f\u72b6\u614b\u3067\u30e6\u30fc\u30b6\u30fc\u304c\u30a2\u30ab\u30a6\u30f3\u30c8\u524a\u9664\uff08\u9000\u4f1a\uff09\u3057\u3066\u3057\u307e\u3046\u3068\u3001\u305d\u306e\u6a29\u5229\u304c\u6d88\u6ec5\u3059\u308b\u3053\u3068\u306b\u306a\u308a\u307e\u3059\u3002\n\n\u8a73\u7d30\u306fStripe docs\u5185\u306e [Upgrading and Downgrading Plans](https://stripe.com/docs/subscriptions/upgrading-downgrading) \u306b\u8a18\u8f09\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n\n\uff08\u56f3\u4e2d\u3067\u306f\u308f\u304b\u308a\u306b\u304f\u3044\u3067\u3059\u304c\u3001\u5dee\u984d\u306e\u8a08\u7b97\u306f\u300c\u79d2\u5358\u4f4d\u300d\u3067\u884c\u308f\u308c\u308b\u3088\u3046\u3067\u3059\uff09\n\n## Rails\u5074\u306e\u30e2\u30c7\u30eb\n\nRails\u5074\u306b\u306f\u3082\u3068\u3082\u3068\u5229\u7528\u8005\u3092\u8868\u3059`User`\u30e2\u30c7\u30eb\u3068\u3001`User`\u304c\u8907\u6570\u96c6\u307e\u308a\u7d44\u7e54\u3092\u8868\u3059`Team`\u30e2\u30c7\u30eb\u304c\u3042\u308b\u3068\u3057\u307e\u3059\u3002\n\u6c7a\u6e08\u306f`Team`\u5358\u4f4d\u3067\u884c\u3046\u3068\u3057\u3001\u6c7a\u6e08\u306b\u95a2\u3059\u308b\u6a29\u9650\u306f`Team`\u306b\u7d10\u3065\u304f`User`\u304c\u884c\u3048\u308b\u3068\u3057\u307e\u3059\u3002\n\n- User\n  - \u30b5\u30fc\u30d3\u30b9\u306e\u5229\u7528\u30e6\u30fc\u30b6\u30fc\u3092\u8868\u3059\u30e2\u30c7\u30eb\n- Team\n  - `User`\u3092\u675f\u306d\u308b\u7d44\u7e54\u3092\u8868\u3059\u30e2\u30c7\u30eb\n- Plan\n  - \u6599\u91d1\u30d7\u30e9\u30f3\u3092\u8868\u3059\u30de\u30b9\u30bf\u30c7\u30fc\u30bf\n  - \u91d1\u984d\u304c\u542b\u307e\u308c\u308b\n- Invoice\n  - \u8acb\u6c42\u60c5\u5831\n  - \u30b5\u30d6\u30b9\u30af\u30ea\u30d7\u30b7\u30e7\u30f3\u304c\u66f4\u65b0\u3055\u308c\u308b\u6bce\u306b\u4f5c\u6210\u3055\u308c\u308b\n  - \u3053\u306e\u30c7\u30fc\u30bf\u3092\u3082\u3068\u306b\u30b5\u30fc\u30d3\u30b9\u4e0a\u3084\u30e1\u30fc\u30eb\u3067\u306e\u8acb\u6c42\u66f8\u60c5\u5831\u3092\u751f\u6210\u3059\u308b \n\n\n![20161005_Stripe.png](https://qiita-image-store.s3.amazonaws.com/0/10272/b665a05c-60dd-ccc6-9c13-f1e12d99d7e2.png)\n\n\n## Stripe\u5074\u306e\u30e2\u30c7\u30eb\n\nStripe\u5074\u306b\u306f\u3001\u30b5\u30d6\u30b9\u30af\u30ea\u30d7\u30b7\u30e7\u30f3\u578b\u6c7a\u6e08\u306e\u305f\u3081\u306e\u3044\u304f\u3064\u304b\u306e\u30e2\u30c7\u30eb\u304c\u5b58\u5728\u3057\u3001\u3044\u304f\u3064\u304b\u306e\u30c7\u30fc\u30bf\u306fRails\u5074\u3068\u540c\u671f\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\nStripe\u306b\u306f\u5145\u5b9f\u3057\u305f[API\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8](https://stripe.com/docs/api)\u304c\u3042\u308a\u307e\u3059\u304c\u3001\u30b5\u30d6\u30b9\u30af\u30ea\u30d7\u30b7\u30e7\u30f3\u578b\u6c7a\u6e08\u3092\u5b9f\u88c5\u3059\u308b\u3060\u3051\u306a\u3089\u3001\u4ee5\u4e0b\u306e\u30e2\u30c7\u30eb\u3060\u3051\u77e5\u3063\u3066\u304a\u3051\u3070\u5341\u5206\u3067\u3059\u3002\n\n\n\uff08\u4ee5\u964d\u3001Rails\u5074\u306e\u30e2\u30c7\u30eb\u3068\u533a\u5225\u3059\u308b\u305f\u3081\u306b`Stripe::`\u3068\u3044\u3046prefix\u3092\u4ed8\u3051\u307e\u3059\uff09\n\n- Stripe::Plan\n  - \u30b5\u30d6\u30b9\u30af\u30ea\u30d7\u30b7\u30e7\u30f3\u306e\u6599\u91d1\u30d7\u30e9\u30f3\u3092\u8868\u3059\u30e2\u30c7\u30eb\n  - \u6c7a\u6e08\u5468\u671f\uff08monthly\uff09\u3084\u91d1\u984d\u3001\u901a\u8ca8\u3001\u7a0e\u984d\uff08\u6d88\u8cbb\u7a0e\u30fb\u4ed8\u52a0\u4fa1\u5024\u7a0e\uff09\u306a\u3069\n  - https://stripe.com/docs/api#plans\n- Stripe::Customer\n  - \u6c7a\u6e08\u30a2\u30ab\u30a6\u30f3\u30c8\u306b\u3042\u305f\u308b\u30e2\u30c7\u30eb\u3002Rails\u5074\u306e`Team`\u30681\u5bfe1\u3067\u5bfe\u5fdc\n  - \u7121\u6599\u30d7\u30e9\u30f3\u3067\u3082\u5bfe\u5fdc\u3059\u308b`Stripe::Customer`\u304c\u5b58\u5728\u3059\u308b\n  - https://stripe.com/docs/api#customers\n- Stripe::Token\n  - \u30af\u30ec\u30b8\u30c3\u30c8\u30ab\u30fc\u30c9\u60c5\u5831\u3092\u30c8\u30fc\u30af\u30f3\u5316\u3057\u305f\u30c7\u30fc\u30bf\n  - \u30d6\u30e9\u30a6\u30b6\u304b\u3089JavaScript\u3092\u4f7f\u3063\u3066\u30af\u30ec\u30b8\u30c3\u30c8\u30ab\u30fc\u30c9\u60c5\u5831\u3092Stripe\u306b\u9001\u308b\u3068\u53d6\u5f97\u3067\u304d\u308b\n  - Rails\u5074\u306f\u3053\u306e`Stripe::Token`\u3092\u4f7f\u3063\u3066\u3084\u308a\u53d6\u308a\u3059\u308b\u305f\u3081\u30ab\u30fc\u30c9\u60c5\u5831\u3092\u53d6\u5f97\u3059\u308b\u5fc5\u8981\u306f\u306a\u3044\n  - https://stripe.com/docs/api#tokens\n- Stripe::Card\n  - \u30c8\u30fc\u30af\u30f3\u5316\u3055\u308c\u305f\u30af\u30ec\u30b8\u30c3\u30c8\u30ab\u30fc\u30c9\u60c5\u5831\n  - \u4f4f\u6240\u3084\u30ab\u30fc\u30c9\u30d6\u30e9\u30f3\u30c9\u30fb\u30ab\u30fc\u30c9\u306e\u4e0b4\u6841\u306a\u3069\n  - `Stripe::Token`\u3092\u4f7f\u3063\u3066\u3084\u308a\u53d6\u308a\u3059\u308b\n  - https://stripe.com/docs/api#cards\n- Stripe::Subscription\n  - `Stripe::Customer`\u306e\u30d7\u30e9\u30f3\u72b6\u6cc1\u3084\u6b21\u306e\u6c7a\u6e08\u65e5\u306a\u3069\u306e\u60c5\u5831\u3092\u6301\u3064\n  - `Stripe::Customer`\u3068`Stripe::Plan`\u306b\u7d10\u3065\u304f\n  - https://stripe.com/docs/api#subscriptions\n- Stripe::Invoice\n  - \u8acb\u6c42\u60c5\u5831\n  - \u30b5\u30d6\u30b9\u30af\u30ea\u30d7\u30b7\u30e7\u30f3\u306e\u66f4\u65b0\u6642\uff08monthly\u306e\u5834\u5408\u306f\u6bce\u67081\u56de\uff09\u306b\u4f5c\u6210\u3055\u308c\u308b\n  - \u5c0f\u8a08\u30fb\u7a0e\u984d\u30fb\u5408\u8a08\u91d1\u984d\u30fb\u8acb\u6c42\u306e\u30b9\u30c6\u30fc\u30bf\u30b9\u306a\u3069\u306e\u60c5\u5831\u3092\u6301\u3064\n  - https://stripe.com/docs/api#invoices\n\n\n## \u6599\u91d1\u30d7\u30e9\u30f3\u3092Stripe\u306b\u540c\u671f\u3059\u308b\n\nStripe\u3067\u30b5\u30d6\u30b9\u30af\u30ea\u30d7\u30b7\u30e7\u30f3\u578b\u6c7a\u6e08\u3092\u5c0e\u5165\u3059\u308b\u305f\u3081\u306b\u306f\u3001\u6599\u91d1\u30d7\u30e9\u30f3\u60c5\u5831\u3092Stripe\u5074\u306b\u540c\u671f\u3057\u3066\u304a\u304f\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\nStripe\u306b\u306f[\u516c\u5f0f\u306egem](https://github.com/stripe/stripe-ruby)\u304c\u3042\u308b\u306e\u3067\u3001\u3053\u308c\u3092\u4f7f\u3063\u3066`Stripe::Plan`\u306e\u767b\u9332\u3057\u307e\u3057\u3087\u3046\u3002\n\nAPI\u30ad\u30fc\u306e\u8a2d\u5b9a\u306a\u3069\u306f\u4e8b\u524d\u306b\u6e08\u307e\u305b\u3066\u304a\u3044\u3066\u304f\u3060\u3055\u3044\u3002\n\n```rb:config/initializers/stripe.rb\nStripe.api_key = ENV.fetch('STRIPE_SECRET_KEY')\n```\n\n\u307e\u305a\u3001`Plan`\u30e2\u30c7\u30eb\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u69cb\u9020\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002\n\n```rb:app/models/plan.rb\n# == Schema Information\n#\n# Table name: plans\n#\n#  id                        :integer          not null, primary key\n#  stripe_plan_id            :string(255)      not null\n#  name                      :string(255)      not null\n#  amount                    :integer          not null\n#  currency                  :integer          not null\n#  interval                  :string(255)      not null\n#  statement_descriptor      :string(22)       not null\n#\nclass Plan < ActiveRecord::Base\n  has_many   :teams\n  \n  FREE_PLAN_ID = 1\n  \n  ...\nend\n```\n\n`Stripe::Plan`\u306e`id`\u3092\u4fdd\u5b58\u3059\u308b\u305f\u3081\u306b`stripe_plan_id` \u3068\u3044\u3046\u30ab\u30e9\u30e0\u304c\u3042\u308a\u307e\u3059\u3002\n\n\u3053\u306e`Plan`\u30e2\u30c7\u30eb\u306b\u6599\u91d1\u30c7\u30fc\u30bf\u3092\u8ffd\u52a0\u3057\u3001`Stripe::Plan`\u306b\u540c\u671f\u3057\u307e\u3059\u3002\n\n```rb:some-seed.rake\nPlan.create(\n    id: 1,\n    stripe_plan_id: 'start-plan',\n    name: 'Start Plan',\n    amount: 1000,\n    currency: :jpy,\n    interval: 'month',\n    statement_descriptor: 'Start Plan',\n)\n...\n\nPlan.find_each do |plan|\n  Stripe::Plan.create(\n    id:       plan.stripe_plan_id,\n    amount:   plan.amount, # e.g. 1000\n    currency: plan.currency, # e.g. 'jpy'\n    interval: plan.interval, # e.g. 'month\n    name:     plan.name,\n    statement_descriptor: plan.statement_descriptor\n  )\nend\n```\n\n\u6b63\u5e38\u306b\u540c\u671f\u3055\u308c\u305f\u304b\u3069\u3046\u304b\u3001Stripe\u306e\u7ba1\u7406\u753b\u9762\u304b\u3089\u78ba\u8a8d\u3057\u3066\u307f\u307e\u3057\u3087\u3046\u3002\n\n![plan.png](https://qiita-image-store.s3.amazonaws.com/0/10272/b7f0bfa6-dbb1-954b-d127-7c9c4ddfa592.png)\n\n\n## Stripe::Customer\u3092\u4f5c\u6210\u3059\u308b\n\n\u3053\u3053\u3067\u306f\u3001\u5148\u306b\u7121\u6599\u30d7\u30e9\u30f3\u306b\u306a\u3063\u3066\u30b5\u30fc\u30d3\u30b9\u3092\u4f53\u9a13\u3057\u3066\u3082\u3089\u3063\u3066\u304b\u3089\u6709\u6599\u30d7\u30e9\u30f3\u306b\u79fb\u884c\u3059\u308b\u3068\u3044\u3046\u30b7\u30ca\u30ea\u30aa\u3092\u8003\u3048\u3066\u307f\u307e\u3059\u3002\u76f4\u63a5\u6709\u6599\u30d7\u30e9\u30f3\u306b\u306a\u308b\u5834\u5408\u306f\u3001\u6b21\u306e\u30bb\u30af\u30b7\u30e7\u30f3\u3068\u4e00\u7dd2\u306b\u9032\u3081\u3066\u304f\u3060\u3055\u3044\u3002\n\n`Team`\u4f5c\u6210\u6642\u306b\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u3067`Stripe::Customer`\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n`Team`\u306b\u306f`Stripe::Card`\u3001`Stripe::Customer`\u3068`Stripe::Subscription`\u3092\u4fdd\u5b58\u3059\u308b\u305f\u3081\u306b\u3001`stripe_card_id`\u3001`stripe_customer_id`\u3001`stripe_subscription_id`\u304c\u3042\u308a\u307e\u3059\u3002\n\n\u307e\u305f\u3001\u30b5\u30d6\u30b9\u30af\u30ea\u30d7\u30b7\u30e7\u30f3\u306e\u66f4\u65b0\u65e5\u3068\u306a\u308b\u60c5\u5831\u3068\u3057\u3066`active_until`\u3092\u6301\u3061\u3001Stripe\u306e\u6c7a\u6e08\u304c\u6b63\u5e38\u306b\u5b8c\u4e86\u3057\u305f\u6642\u306b\u66f4\u65b0\u3055\u308c\u308b\u3088\u3046\u306b\u3059\u308b\u3002\n\n```rb:app/models/team.rb\n# == Schema Information\n#\n# Table name: teams\n#\n#  id                        :integer          not null, primary key\n#  plan_id            :integer\n#  stripe_card_id            :string(255)\n#  stripe_customer_id        :string(255)\n#  stripe_subscription_id        :string(255)\n#  active_until            :datetime         not null\n#\nclass Team < ActiveRecord::Base\n  belongs_to :owner,            class_name: 'User'\n  belongs_to :plan\n  before_validation :create_stripe_customer_and_subscription, if: :new_record?\n  \n  private\n\n    # Team\u4f5c\u6210\u6642\u306bStripe::Customer, Stripe::Subscription\u3092\u4f5c\u6210\u3057\u3001\u3072\u3082\u4ed8\u3051\n    def create_stripe_customer_and_subscription\n      # Stripe::Customer \u4f5c\u6210\n      stripe_customer = Stripe::Customer.create(\n        email:       owner.email,\n        plan:        Plan::FREE_PLAN_ID,\n        tax_percent: 8.0,\n        metadata: {\n          owner_id: owner.id,\n          rails_env: Rails.env.to_s\n        } # \u30c7\u30d0\u30c3\u30b0\u3084\u7ba1\u7406\u306e\u305f\u3081metadata\u3092\u4efb\u610f\u306b\u8ffd\u52a0\u3067\u304d\u308b\n      )\n\n      self.plan = Plan.free_plan\n      self.stripe_customer_id = stripe_customer.id\n      stripe_subscription = stripe_customer.subscriptions.data.first\n      self.stripe_subscription_id = stripe_subscription.id\n      self.active_until = Time.zone.at(stripe_subscription.current_period_end),\n    end\nend\n```\n\n## \u6709\u6599\u30d7\u30e9\u30f3\u306b\u5909\u66f4\u3059\u308b\n\n\u6709\u6599\u30d7\u30e9\u30f3\u306b\u5909\u66f4\u3059\u308b\u305f\u3081\u306b\u306f\u3001\u30af\u30ec\u30b8\u30c3\u30c8\u30ab\u30fc\u30c9\u3092\u767b\u9332\u3057\u306a\u3044\u3068\u3044\u3051\u307e\u305b\u3093\u304c\u3001\u305d\u306e\u524d\u306b\u30af\u30ec\u30b8\u30c3\u30c8\u30ab\u30fc\u30c9\u306e\u30c8\u30fc\u30af\u30f3\u5316\u3092\u884c\u3046\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\nStripe\u306f`Stripe.js`\u3068\u3044\u3046JavaScript\u306e\u30e9\u30a4\u30d6\u30e9\u30ea\u3092\u63d0\u4f9b\u3057\u3066\u3044\u3066\u3001\u3053\u308c\u3092\u5229\u7528\u3057\u3066Rails\u5074\u3068\u3084\u308a\u3068\u308a\u305b\u305a\u306b\u3001\u76f4\u63a5Stripe\u3068\u901a\u4fe1\u3057\u3066\u30af\u30ec\u30b8\u30c3\u30c8\u30ab\u30fc\u30c9\u60c5\u5831\u3092\u30c8\u30fc\u30af\u30f3\uff08`Stripe::Token`\uff09\u306b\u5909\u63db\u3057\u307e\u3059\u3002\n\n\u8a73\u7d30\u306fStripe\u306eDocs\u306e [Creating a Custom Payment Form with Stripe.js](https://stripe.com/docs/custom-form) \u306b\u3042\u308a\u307e\u3059\u306e\u3067\u3001\u3053\u3053\u3067\u306f\u6d41\u308c\u306e\u6982\u8981\u3092\u8aac\u660e\u3057\u307e\u3059\u3002\n\n\u307e\u305a\u3001\u30af\u30ec\u30b8\u30c3\u30c8\u30ab\u30fc\u30c9\u60c5\u5831\u3092\u5165\u529b\u3059\u308b\u30d5\u30a9\u30fc\u30e0\u3068`Stripe.js`\u3092\u8aad\u307f\u8fbc\u3080script\u30bf\u30b0\u3092\u8a2d\u7f6e\u3057\u307e\u3059\u3002\n\n```erb\n<%= form_tag(subscription_path, method: 'post', id: 'payment-form') do %>\n  <%# Plan\u3092\u9078\u629e %>\n  <%= select_tag 'plan_id', Plan.all.map{|i| [i.name, i.id]} %>\n\n  <%# \u30ab\u30fc\u30c9\u60c5\u5831\u3092\u5165\u529b (Rails\u30b5\u30fc\u30d0\u306b\u306f\u9001\u4fe1\u3055\u308c\u306a\u3044) %>\n  Card Number: <input type=\"text\" size=\"20\" data-stripe=\"number\">\n  Expire: <input type=\"text\" size=\"2\" data-stripe=\"exp_month\">/<input type=\"text\" size=\"2\" data-stripe=\"exp_year\">  \n  CVC: <input type=\"text\" size=\"4\" data-stripe=\"cvc\">\n\n  <input type=\"submit\" class=\"submit\" value=\"Submit Payment\">\n</form>\n\n<script type=\"text/javascript\" src=\"https://js.stripe.com/v2/\"></script>\n```\n\n\u3053\u306e\u6642\u306b\u5404\u30d5\u30a3\u30fc\u30eb\u30c9\u30bf\u30b0\u306b`name\u5c5e\u6027`\u3092\u6307\u5b9a\u3057\u306a\u3044\u306e\u304c\u30dd\u30a4\u30f3\u30c8\u3067\u3059\u3002\u305d\u308c\u306b\u3088\u3063\u3066\u3001\u30ab\u30fc\u30c9\u60c5\u5831\u304c\u30b5\u30fc\u30d0\u306b\u9001\u4fe1\u3055\u308c\u308b\u306e\u3092\u9632\u304e\u307e\u3059\u3002\n\n\u6b21\u306bJavaScript\u3067\u30ab\u30fc\u30c9\u60c5\u5831\u3092`Stripe::Token`\u306b\u5909\u63db\u3057\u307e\u3059\u3002\n\n`Stripe.card.createToken`\u3068\u3044\u3046\u30e1\u30bd\u30c3\u30c9\u306bForm\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u6e21\u3059\u3068\u3001\u5fc5\u8981\u306a\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u53d6\u5f97\u3057\u3001\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u3067`Stripe::Token`\u3092\u8fd4\u3057\u3066\u304f\u308c\u307e\u3059\u3002\n\n```html\n<script type=\"text/javascript\">\n  Stripe.setPublishableKey('<\u3053\u3053\u306bAPI\u30ad\u30fc\u3092\u5165\u308c\u308b>');\n\n  var $form = $('#payment-form');\n  \n  $form.submit(function(event) {\n    Stripe.card.createToken($form, function (status, response) {\n\n    // JSON\u30ec\u30b9\u30dd\u30f3\u30b9\u304b\u3089\u30c8\u30fc\u30af\u30f3\u3092\u53d6\u5f97\n    var token = response.id;\n\n    // \u30d5\u30a9\u30fc\u30e0\u306b\u30c8\u30fc\u30af\u30f3\u3092\u633f\u5165\n    $form.append($('<input type=\"hidden\" name=\"stripeToken\">').val(token));\n\n    // \u30d5\u30a9\u30fc\u30e0\u3092\u9001\u4fe1\n    $form.get(0).submit();\n    );\n  });\n};\n</script>\n```\n\n\u30b5\u30fc\u30d0\u5074\u3067\u306f`Stripe::Token`\u3092\u53d7\u3051\u53d6\u3063\u3066\u3001`Stripe::Customer`\u306b\u8a2d\u5b9a\u3001\u3055\u3089\u306b\u30d7\u30e9\u30f3\u5909\u66f4\u3092\u884c\u3044\u307e\u3059\u3002\n\n```rb:Controller\nstripe_customer = Stripe::Customer.retrieve(@team.stripe_customer_id)\nstripe_customer.source = params[:stripeToken] # Stripe.js\u3067\u5909\u63db\u3057\u305f\u30c8\u30fc\u30af\u30f3\u3092\u6e21\u3059\u3060\u3051\nstripe_customer.save\n\nstripe_subscription = Stripe::Subscription.retrieve(@team.stripe_subscription_id)\nstripe_subscription.plan = Plan.find(params[:plan_id])\nstripe_subscription.save\n```\n\n\n## \u6700\u521d\u306e\u6c7a\u6e08\u65e5\n\nStripe\u306fWebhook\u306e\u4ed5\u7d44\u307f\u3092\u6301\u3063\u3066\u3044\u308b\u306e\u3067\u3001\u6c7a\u6e08\u304c\u5b9f\u884c\u3055\u308c\u308b\u3068\u305d\u306e\u60c5\u5831\u3092Rails\u3067\u53d7\u3051\u53d6\u308b\u4e8b\u304c\u3067\u304d\u307e\u3059\u3002\n\n\u306a\u306e\u3067\u3001Rails\u5074\u306ecron\u306a\u3069\u306e\u4ed5\u7d44\u307f\u3092\u6301\u3064\u5fc5\u8981\u306f\u3042\u308a\u307e\u305b\u3093\u3002\n\n\u3053\u308c\u3092\u4f7f\u3063\u3066\u3001\u30b5\u30d6\u30b9\u30af\u30ea\u30d7\u30b7\u30e7\u30f3\u306e\u6709\u52b9\u671f\u9650\u3067\u3042\u308b`Team#active_until`\u306e\u66f4\u65b0\u3092\u884c\u3044\u307e\u3059\u3002\u305d\u308c\u3068\u540c\u6642\u306b\u8acb\u6c42\u66f8\u306b\u5229\u7528\u3059\u308b`Invoice`\u60c5\u5831\u3092\u4fdd\u5b58\u3057\u307e\u3059\u3002\n\u307e\u305f\u3001\u6c7a\u6e08\u304c\u5931\u6557\u3057\u305f\u5834\u5408\u306b\u306f\u3001\u304a\u77e5\u3089\u305b\u30e1\u30fc\u30eb\u3092\u30e6\u30fc\u30b6\u30fc\u306b\u9001\u308b\u3053\u3068\u3082\u3067\u304d\u307e\u3059\u3002\n\n```rb:WebhookController\ndef create\n    event_json = JSON.parse(request.body.read)\n    event = Stripe::Event.retrieve(event_json['id'])\n\n    ActiveRecord::Base.transaction do\n      case event.type\n      \n      # subscription\u306e\u66f4\u65b0\n      #   => Invoice\u60c5\u5831\u3092\u4fdd\u5b58\n      when 'customer.subscription.updated'\n        stripe_subscription = event.data.object\n\n        team = Team.find_by!(stripe_subscription_id: stripe_subscription.id)\n        team.update!(\n          active_until: Time.zone.at(stripe_subscription.current_period_end)\n        )\n      \n      # \u6c7a\u6e08\u6210\u529f\n      #   => DB\u5185\u306e\u6709\u52b9\u671f\u9650\u3092\u5ef6\u9577\n      when 'invoice.payment_succeeded'\n        stripe_invoice = event.data.object\n\n        team = Team.find_by!(stripe_subscription_id: stripe_invoice.subscription)\n        stripe_subscription = stripe_invoice.lines.data.detect { |d| d.type == 'subscription' }\n\n        invoice = Invoice.find_or_initialize_by(stripe_invoice_id: stripe_invoice.id)\n        invoice.amount_due           = stripe_invoice.amount_due\n        invoice.stripe_invoice_id    = stripe_invoice.id\n        invoice.stripe_charge_id     = stripe_invoice.charge\n        invoice.closed               = stripe_invoice.closed\n        invoice.currency             = stripe_invoice.currency\n        invoice.payment_processed_at = Time.zone.at(stripe_invoice.date)\n        invoice.stripe_customer_id   = stripe_invoice.customer\n        invoice.next_payment_attempt = stripe_invoice.next_payment_attempt\n        invoice.paid                 = stripe_invoice.paid\n        invoice.subtotal             = stripe_invoice.subtotal\n        invoice.tax                  = stripe_invoice.tax || 0\n        invoice.tax_percent          = stripe_invoice.tax_percent || 0\n        invoice.total                = stripe_invoice.total\n        invoice.subscription_period_start_at = Time.zone.at(stripe_subscription.period.start)\n        invoice.subscription_period_end_at   = Time.zone.at(stripe_subscription.period.end)\n        invoice.starting_balance     = stripe_invoice.starting_balance\n        invoice.ending_balance       = stripe_invoice.ending_balance\n        invoice.save!\n\n      # \u6c7a\u6e08\u5931\u6557\n      #   => \u30e6\u30fc\u30b6\u30fc\u306b\u30e1\u30fc\u30eb\u3092\u9001\u308b\n      when 'invoice.payment_failed'\n        stripe_invoice = event.data.object\n\n        team = Team.find_by!(stripe_subscription_id: stripe_invoice.subscription)\n        PaymentMailer.payment_failed_email(team).deliver_now\n      end\n    end\n  end\nend\n```\n\n\n\n## \u30d7\u30e9\u30f3\u5909\u66f4\u3059\u308b\n\n\u65e2\u306b\u30af\u30ec\u30b8\u30c3\u30c8\u30ab\u30fc\u30c9\u60c5\u5831\u304c`Stripe::Customer`\u306b\u7d10\u4ed8\u3044\u3066\u3044\u308c\u3070\u3001\u30d7\u30e9\u30f3\u5909\u66f4\u306f\u305d\u306e\u307e\u307e\u5b9f\u884c\u3067\u304d\u307e\u3059\u3002\n\n```rb:Controller\nstripe_subscription = Stripe::Subscription.retrieve(@team.subscription_id)\nstripe_subscription.plan = Plan.find(params[:plan_id])\nstripe_subscription.save\n```\n\n\n## \u30a2\u30ab\u30a6\u30f3\u30c8\u524a\u9664\u6642\u306bStripe::Subscription\u3082\u524a\u9664\u3059\u308b\n\n\u6b8b\u5ff5\u306a\u304c\u3089\u30b5\u30fc\u30d3\u30b9\u304b\u3089\u9000\u4f1a\u3055\u308c\u3066\u3057\u307e\u3046\u30e6\u30fc\u30b6\u30fc\u304c\u3044\u305f\u3068\u304d\u306b\u306f\u3001\u5bfe\u5fdc\u3059\u308b\u30b5\u30d6\u30b9\u30af\u30ea\u30d7\u30b7\u30e7\u30f3\u6c7a\u6e08\u3082\u524a\u9664\u3057\u306a\u3044\u3068\u3044\u3051\u307e\u305b\u3093\u3002\n\n\u3053\u308c\u306f`Team`\u30e2\u30c7\u30eb\u306e\u524a\u9664\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u3067\u884c\u3044\u307e\u3057\u3087\u3046\u3002\n\n```rb:app/models/team.rb\nclass Team < ActiveRecord::Base\n  around_destroy :delete_stripe_subscription_before_destroy\n\n  private\n  \n  # Team\u524a\u9664\u6642\u306bStripe::Subscription\u3082\u524a\u9664\n  \u001fdef delete_stripe_subscription_before_destroy\n    ActiveRecord::Base.transaction do\n      deleting_stripe_subscription = Stripe::Subscription.retrieve(stripe_subscription_id)\n      yield\n      deleting_stripe_subscription.delete\n    end\n  end\nend\n```\n\n\n\n# \u307e\u3068\u3081\n\nStripe\u304c\u65e5\u672c\u306b\u4e0a\u9678\u3057\u305f\u3053\u3068\u3067\u3001\u6c7a\u6e08\u7cfb\u30b5\u30fc\u30d3\u30b9\u306e\u30d7\u30ec\u30fc\u30e4\u30fc\u304c\u51fa\u63c3\u3063\u305f\u611f\u3058\u304c\u3042\u308a\u307e\u3059\u3002\n\u30d6\u30ed\u30b0\u7b49\u3067\u500b\u4eba\u7684\u306b\u51fa\u54c1\u3059\u308b\u3088\u3046\u306a\u76ee\u7684\u3067\u306e\u6c7a\u6e08\u30b5\u30fc\u30d3\u30b9\u306b\u6bd4\u3079\u3001\u5546\u7528\u5229\u7528\u3067\u306e\u30b5\u30fc\u30d3\u30b9\u306b\u7d44\u307f\u8fbc\u3080\u305f\u3081\u306e\u6c7a\u6e08\u30b7\u30b9\u30c6\u30e0\u306b\u95a2\u3059\u308b\u60c5\u5831\u306f\u6975\u7aef\u306b\u5c11\u306a\u3044\u306e\u304c\u73fe\u72b6\u3067\u3059\u3002\n\u30ab\u30fc\u30c9\u30d6\u30e9\u30f3\u30c9\u3084\u6c7a\u6e08\u624b\u6570\u6599\u306a\u3069\u306e\u554f\u984c\u3067\u5fc5\u305a\u3057\u3082Stripe\u304c\u30d9\u30b9\u30c8\u306a\u9078\u629e\u80a2\u3067\u306f\u306a\u3044\u5834\u5408\u3082\u3042\u308a\u307e\u3059\u304c\u3001\u30e9\u30a4\u30d6\u30e9\u30ea\u3084\u30b3\u30df\u30e5\u30cb\u30c6\u30a3\u306e\u767a\u5c55\u3067\u5b89\u5fc3\u611f\u304c\u3042\u308b\u3068\u3044\u3046\u30dd\u30a4\u30f3\u30c8\u3082\u3042\u308a\u307e\u3059\u3002\n\u3068\u306f\u3044\u3046\u3082\u306e\u306e\u3001\u3053\u3053\u3067\u8aac\u660e\u3057\u305f\u5185\u5bb9\u306f\u3069\u3093\u306a\u6c7a\u6e08\u30b5\u30fc\u30d3\u30b9\u3092\u5229\u7528\u3057\u3066\u3082\u5fdc\u7528\u53ef\u80fd\u3060\u3068\u601d\u308f\u308c\u308b\u306e\u3067\u3001\u958b\u767a\u8005\u540c\u58eb\u306e\u30b3\u30df\u30e5\u30cb\u30b1\u30fc\u30b7\u30e7\u30f3\u304c\u6d3b\u767a\u306b\u306a\u308c\u3070\u3046\u308c\u3057\u3044\u3067\u3059\u3002\n\n\n\n# \u53c2\u8003\n\n- \u30c9\u30eb\u6c7a\u6e08\u30b5\u30fc\u30d3\u30b9Stripe\u306e\u5168\u5bb9\u3092\u3056\u3063\u304f\u308a\u628a\u63e1\u3059\u308b\n  - http://qiita.com/tanishi/items/877f0d6144c85e744ca5\n- \u30aa\u30f3\u30e9\u30a4\u30f3\u6c7a\u6e08\u30b5\u30fc\u30d3\u30b9\u306e\u6bd4\u8f03\uff082016\u5e749\u6708\uff09\n  - http://qiita.com/Masaaki_Inaba/items/c2a5afd1481276f4c60f\n- \u3010\u65e5\u672c\u4e0a\u9678\u3011\u30aa\u30f3\u30e9\u30a4\u30f3\u6c7a\u6e08\u30b5\u30fc\u30d3\u30b9Stripe\u306b\u3088\u308b\u5186\u6c7a\u6e08\u306e\u5b9f\u88c5 \u5165\u9580\n  - http://qiita.com/hayashier/items/02fd691e5896b9864298\n\n\n\n\n## \u8ffd\u8a18 \n\n- 2016-11-10\n  - \u30b3\u30fc\u30c9\u5185\u306e\u30cf\u30fc\u30c9\u30b3\u30fc\u30c9\u3055\u308c\u305f\u30b3\u30fc\u30c9\u3092\u6587\u8108\u306b\u5408\u3046\u3088\u3046\u306b\u4fee\u6b63\n", "tags": ["stripe", "Rails", "\u6c7a\u6e08"]}