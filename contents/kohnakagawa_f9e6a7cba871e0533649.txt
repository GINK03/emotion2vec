{"context": "\n\n\u306f\u3058\u3081\u306b\nHaswell\u304b\u3089vgather\u7cfb\u306e\u547d\u4ee4\u304c\u51fa\u3066\u304d\u305f\u8a33\u3067\u3059\u304c\u3001\u9045\u3044\u3089\u3057\u304f\"Will get improvement in Intel next generation CPU\"\u3068\u30a2\u30ca\u30a6\u30f3\u30b9\u3055\u308c\u305f\u307b\u3069\u3002\u7d44\u307f\u8fbc\u307f\u95a2\u6570\u3067\u66f8\u304b\u306a\u3044\u9650\u308a\u306fvgather\u547d\u4ee4\u306f\u51fa\u3066\u3053\u306a\u3044\u3068\u601d\u3063\u3066\u3044\u305f\u3089\u3001\u305d\u3046\u3067\u306f\u306a\u304b\u3063\u305f\u3068\u3044\u3046\u8a71\u3002\u30a2\u30bb\u30f3\u30d6\u30e9\u306fintel\u5f62\u5f0f\u3067\u3002\u30bd\u30fc\u30b9\u30b3\u30fc\u30c9\u306fgist\u306b\u3042\u308b\u3002\n\u30b3\u30f3\u30d1\u30a4\u30e9\u306ficpc (ICC) 16.0.4 20160811\u3067\u3001\u30b3\u30f3\u30d1\u30a4\u30eb\u306f\n$ icpc -S -O3 -xHOST -std=c++11 -masm=intel gather.cpp\n\n\u3067\u884c\u3046\u3002\u30b3\u30f3\u30d1\u30a4\u30eb\u3057\u3066\u3044\u308b\u74b0\u5883\u306fXeon(R) CPU E5-2680\u3067Haswell\u4e16\u4ee3\u306eXeon\u3067\u3042\u308b\u3002\n\n\u884c\u5217\u884c\u5217\u7a4d\n\u79d1\u5b66\u6280\u8853\u8a08\u7b97\u3067\u3088\u304f\u898b\u3089\u308c\u308b\u8a08\u7b97\u3002\u4ee5\u4e0b\u306e\u3088\u3046\u306a\uff13\u91cd\u30eb\u30fc\u30d7\u3067\u304b\u3051\u308b\u3002\u305f\u3060\u3057\u3001\u914d\u5217c\u306f0\u30af\u30ea\u30a2\u3055\u308c\u3066\u3044\u308b\u3068\u3059\u308b\u3002\nfor (int i = 0; i < N; i++) {\n  for (int j = 0; j < N; j++) {\n    for (int k = 0; k < N; k++) {\n      c[i][j] += a[i][k] * b[k][j];\n    }\n  }\n}\n\n(\u3082\u3061\u308d\u3093\u3001\u884c\u5217\u30b5\u30a4\u30ba\u304c\u5927\u304d\u3044\u5834\u5408\u306b\u306f\u3053\u3093\u306a\u624b\u3067\u66f8\u304b\u306a\u3044\u3067\u3001\u30e9\u30a4\u30d6\u30e9\u30ea\u3092\u4f7f\u3046\u3079\u304d)\n\u4e0a\u306e\u30b3\u30fc\u30c9\u3067\u306f\u30d9\u30af\u30c8\u30eb\u5316\u3055\u308c\u306a\u3044\u304c\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u66f8\u304d\u63db\u3048\u308b\u3068\u30d9\u30af\u30c8\u30eb\u5316\u3055\u308c\u308b\u3002\n  for (int i = 0; i < N; i++) {\n    for (int j = 0; j < N; j++) {\n      int sum = 0;\n      for (int k = 0; k < N; k++) {\n        sum += a[i][k] * b[k][j];\n      }\n      c[i][j] = sum;\n    }\n  }\n\n\u6700\u5185\u30eb\u30fc\u30d7\u306b\u76f8\u5f53\u3059\u308b\u30a2\u30bb\u30f3\u30d6\u30e9\u3092\u53d6\u308a\u51fa\u3057\u3066\u304f\u308b\u3068\u3053\u3093\u306a\u611f\u3058\u3002\n..B4.10:                        # Preds ..B4.10 ..B4.9\n        vmovdqa   ymm3, ymm0                                    #40.26\n        lea       rsi, QWORD PTR [rax+r12]                      #40.26\n        vpxor     ymm4, ymm4, ymm4                              #40.26\n        lea       rdi, QWORD PTR [16384+rax+r12]                #40.9\n        vpxor     ymm6, ymm6, ymm6                              #40.26\n        vpgatherdd ymm4, DWORD PTR [rsi+ymm1*8], ymm3           #40.26\n        vpmulld   ymm5, ymm4, YMMWORD PTR [r8+rdx*4]            #40.26\n        add       rax, 32768                                    #39.7\n        vpaddd    ymm7, ymm2, ymm5                              #40.9\n        vmovdqa   ymm2, ymm0                                    #40.26\n        vpgatherdd ymm6, DWORD PTR [rdi+ymm1*8], ymm2           #40.26\n        vpmulld   ymm8, ymm6, YMMWORD PTR [32+r8+rdx*4]         #40.26\n        add       rdx, 16                                       #39.7\n        vpaddd    ymm2, ymm7, ymm8                              #40.9\n        cmp       rdx, rcx                                      #39.7\n        jb        ..B4.10       # Prob 99%                      #39.7\n\n\nvpgatherdd\u3068\u3044\u3046vgather\u7cfb\u547d\u4ee4\u304c\u898b\u3089\u308c\u308b\u3002\nC\u8a00\u8a9e\u3067\u306e\u4e8c\u6b21\u5143\u914d\u5217\u306frow major order\u306a\u306e\u3067\u3001\u6700\u5185\u30eb\u30fc\u30d7\u3067\u914d\u5217a\u306findex k\u306b\u3064\u3044\u3066\u9023\u7d9a\u30a2\u30af\u30bb\u30b9\u306b\u306a\u308b\u304c\u3001\u914d\u5217b\u306findex k\u306b\u3064\u3044\u3066\u9023\u7d9a\u30a2\u30af\u30bb\u30b9\u306b\u306f\u306a\u3089\u306a\u3044\u3002\u305d\u3053\u3067\u3001\u4e0d\u9023\u7d9a\u306a\u30e1\u30e2\u30ea\u30a2\u30af\u30bb\u30b9\u306b\u306a\u308b\u914d\u5217b\u306e\u30c7\u30fc\u30bf\u30928\u500b\u53d6\u3063\u3066\u6765\u308b\u305f\u3081\u306bvgather\u3092\u4f7f\u3063\u3066\u3044\u308b\u3002\u30a2\u30bb\u30f3\u30d6\u30e9\u3092\u898b\u308b\u9650\u308a\u3067\u306f\u6700\u5185\u30eb\u30fc\u30d7\u30922\u500d\u30a2\u30f3\u30ed\u30fc\u30eb\u3057\u306616\u500b\u306eint\u30c7\u30fc\u30bf\u306b\u3064\u3044\u3066\u51e6\u7406\u3092\u3057\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002vpgatherdd\u304c2\u56de\u547c\u3070\u308c\u3066\u3044\u308b\u306e\u306f\u305d\u306e\u305f\u3081\u3002\n\u4eca\u3001\u914d\u5217a, b, c\u306e\u30c7\u30fc\u30bf\u3092int\u3068\u3057\u3066\u308b\u304c\u3001float\u306b\u3059\u308b\u3068\u3069\u3046\u306a\u308b\u304b\u3002\n\u540c\u3058\u3088\u3046\u306bvgather\u7cfb\u547d\u4ee4\u304c\u898b\u3089\u308c\u308b\u3002\n..B7.4:                         # Preds ..B7.4 ..B7.3                                                                                                         \n        vmovdqa   ymm11, ymm0                                   #58.26\n        lea       r15, QWORD PTR [r10+rbx]                      #58.26\n        vxorps    ymm12, ymm12, ymm12                           #58.26\n        vgatherdps ymm12, DWORD PTR [r15+ymm9*8], ymm11         #58.26\n        lea       r15, QWORD PTR [16384+rbx+r10]                #58.26\n        vxorps    ymm14, ymm14, ymm14                           #58.26\n        vmovdqa   ymm13, ymm0                                   #58.26\n        vgatherdps ymm14, DWORD PTR [r15+ymm9*8], ymm13         #58.26\n        lea       r15, QWORD PTR [32768+rbx+r10]                #58.26\n        vfmadd231ps ymm7, ymm12, YMMWORD PTR [r14+r11*4]        #58.9 \n        vfmadd231ps ymm1, ymm14, YMMWORD PTR [32+r14+r11*4]     #58.9 \n        vxorps    ymm11, ymm11, ymm11                           #58.26\n        vmovdqa   ymm15, ymm0                                   #58.26\n        vgatherdps ymm11, DWORD PTR [r15+ymm9*8], ymm15         #58.26\n        lea       r15, QWORD PTR [49152+rbx+r10]                #58.26\n        vxorps    ymm13, ymm13, ymm13                           #58.26\n        vmovdqa   ymm12, ymm0                                   #58.26\n        vgatherdps ymm13, DWORD PTR [r15+ymm9*8], ymm12         #58.26\n        lea       r15, QWORD PTR [65536+rbx+r10]                #58.26\n        vfmadd231ps ymm6, ymm11, YMMWORD PTR [64+r14+r11*4]     #58.9 \n        vfmadd231ps ymm5, ymm13, YMMWORD PTR [96+r14+r11*4]     #58.9 \n        vxorps    ymm11, ymm11, ymm11                           #58.26\n        vmovdqa   ymm14, ymm0                                   #58.26\n        vgatherdps ymm11, DWORD PTR [r15+ymm9*8], ymm14         #58.26\n        lea       r15, QWORD PTR [81920+rbx+r10]                #58.26\n        vxorps    ymm13, ymm13, ymm13                           #58.26\n        vmovdqa   ymm12, ymm0                                   #58.26\n        vgatherdps ymm13, DWORD PTR [r15+ymm9*8], ymm12         #58.26\n        lea       r15, QWORD PTR [98304+rbx+r10]                #58.26\n        vfmadd231ps ymm4, ymm11, YMMWORD PTR [128+r14+r11*4]    #58.9 \n        vfmadd231ps ymm3, ymm13, YMMWORD PTR [160+r14+r11*4]    #58.9 \n        vxorps    ymm11, ymm11, ymm11                           #58.26\n        vmovdqa   ymm15, ymm0                                   #58.26\n        vgatherdps ymm11, DWORD PTR [r15+ymm9*8], ymm15         #58.26\n        lea       r15, QWORD PTR [114688+rbx+r10]               #58.26\n        vxorps    ymm13, ymm13, ymm13                           #58.26\n        add       rbx, 131072                                   #57.7 \n        vmovdqa   ymm12, ymm0                                   #58.26\n        vgatherdps ymm13, DWORD PTR [r15+ymm9*8], ymm12         #58.26\n        vfmadd231ps ymm2, ymm11, YMMWORD PTR [192+r14+r11*4]    #58.9 \n        vfmadd231ps ymm10, ymm13, YMMWORD PTR [224+r14+r11*4]   #58.9 \n        add       r11, 64                                       #57.7\n        cmp       r11, 512                                      #57.7\n        jb        ..B7.4        # Prob 99%                      #57.7\n\n\u3057\u304b\u3057\u306a\u304c\u3089\u3001float\u304b\u3089double\u3084int64_t\u306b\u5909\u3048\u308b\u3068vgather\u306f\u898b\u3089\u308c\u306a\u304f\u306a\u308b\u3002\ndouble\u306e\u5834\u5408\n..B7.10:                        # Preds ..B7.10 ..B7.9                \n        vmovsd    xmm10, QWORD PTR [rcx+r9]                     #60.26\n        vmovsd    xmm11, QWORD PTR [8192+rcx+r9]                #60.26\n        vmovhpd   xmm12, xmm10, QWORD PTR [4096+rcx+r9]         #60.26\n        vmovhpd   xmm13, xmm11, QWORD PTR [12288+rcx+r9]        #60.26\n        vmovsd    xmm15, QWORD PTR [16384+rcx+r9]               #60.26\n        vmovsd    xmm10, QWORD PTR [24576+rcx+r9]               #60.26\n        vmovhpd   xmm11, xmm15, QWORD PTR [20480+rcx+r9]        #60.26\n        vmovsd    xmm15, QWORD PTR [40960+rcx+r9]               #60.26\n        vinsertf128 ymm14, ymm12, xmm13, 1                      #60.26\n        vfmadd231pd ymm8, ymm14, YMMWORD PTR [r10+rax*8]        #60.9 \n        vmovsd    xmm14, QWORD PTR [32768+rcx+r9]               #60.26\n        vmovhpd   xmm12, xmm10, QWORD PTR [28672+rcx+r9]        #60.26\n        vmovhpd   xmm10, xmm14, QWORD PTR [36864+rcx+r9]        #60.26\n        vmovsd    xmm14, QWORD PTR [57344+rcx+r9]               #60.26\n        vinsertf128 ymm13, ymm11, xmm12, 1                      #60.26\n        vmovhpd   xmm11, xmm15, QWORD PTR [45056+rcx+r9]        #60.26\n        vfmadd231pd ymm5, ymm13, YMMWORD PTR [32+r10+rax*8]     #60.9 \n        vmovsd    xmm13, QWORD PTR [49152+rcx+r9]               #60.26\n        vmovhpd   xmm15, xmm13, QWORD PTR [53248+rcx+r9]        #60.26\n        vmovsd    xmm13, QWORD PTR [73728+rcx+r9]               #60.26\n        vinsertf128 ymm12, ymm10, xmm11, 1                      #60.26\n        vfmadd231pd ymm4, ymm12, YMMWORD PTR [64+r10+rax*8]     #60.9 \n        vmovsd    xmm12, QWORD PTR [65536+rcx+r9]               #60.26\n        vmovhpd   xmm10, xmm14, QWORD PTR [61440+rcx+r9]        #60.26\n        vmovhpd   xmm14, xmm12, QWORD PTR [69632+rcx+r9]        #60.26\n        vmovsd    xmm12, QWORD PTR [81920+rcx+r9]               #60.26\n        vinsertf128 ymm11, ymm15, xmm10, 1                      #60.26\n        vmovhpd   xmm10, xmm13, QWORD PTR [77824+rcx+r9]        #60.26\n        vmovsd    xmm13, QWORD PTR [90112+rcx+r9]               #60.26\n        vmovhpd   xmm15, xmm12, QWORD PTR [86016+rcx+r9]        #60.26\n        vfmadd231pd ymm3, ymm11, YMMWORD PTR [96+r10+rax*8]     #60.9 \n        vmovsd    xmm12, QWORD PTR [98304+rcx+r9]               #60.26\n        vinsertf128 ymm11, ymm14, xmm10, 1                      #60.26\n        vmovhpd   xmm10, xmm13, QWORD PTR [94208+rcx+r9]        #60.26\n        vmovsd    xmm13, QWORD PTR [106496+rcx+r9]              #60.26\n        vmovhpd   xmm14, xmm12, QWORD PTR [102400+rcx+r9]       #60.26\n        vfmadd231pd ymm2, ymm11, YMMWORD PTR [128+r10+rax*8]    #60.9 \n        vmovsd    xmm12, QWORD PTR [114688+rcx+r9]              #60.26\n        vinsertf128 ymm11, ymm15, xmm10, 1                      #60.26\n        vmovhpd   xmm10, xmm13, QWORD PTR [110592+rcx+r9]       #60.26\n        vmovsd    xmm13, QWORD PTR [122880+rcx+r9]              #60.26\n        vmovhpd   xmm15, xmm12, QWORD PTR [118784+rcx+r9]       #60.26\n        vfmadd231pd ymm1, ymm11, YMMWORD PTR [160+r10+rax*8]    #60.9 \n        vinsertf128 ymm11, ymm14, xmm10, 1                      #60.26\n        vmovhpd   xmm10, xmm13, QWORD PTR [126976+rcx+r9]       #60.26\n        add       rcx, 131072                                   #59.7 \n        vfmadd231pd ymm0, ymm11, YMMWORD PTR [192+r10+rax*8]    #60.9 \n        vinsertf128 ymm11, ymm15, xmm10, 1                      #60.26\n        vfmadd231pd ymm6, ymm11, YMMWORD PTR [224+r10+rax*8]    #60.9 \n        add       rax, 32                                       #59.7 \n        cmp       rax, rdx                                      #59.7 \n        jb        ..B7.10       # Prob 99%                      #59.7 \n\n\u3069\u3046\u3084\u30894Byte\u30c7\u30fc\u30bf\u30928\u500b\u6301\u3063\u3066\u304f\u308b\u5834\u5408\u306b\u306fvgather\u547d\u4ee4\u304c\u7a4d\u6975\u7684\u306b\u4f7f\u308f\u308c\u308b\u3051\u3069\u30018Byte\u30c7\u30fc\u30bf\u30924\u500b\u6301\u3063\u3066\u304f\u308b\u5834\u5408\u306b\u306f\u4f7f\u308f\u308c\u306a\u3044\u307f\u305f\u3044\u3060\u3002\n\n\u30b9\u30c8\u30e9\u30a4\u30c9\u5e45\u304c\u4e00\u5b9a\u3067\u306f\u306a\u3044\u5834\u5408\n\u884c\u5217\u884c\u5217\u7a4d\u306e\u5834\u5408\u3060\u3068\u30b9\u30c8\u30e9\u30a4\u30c9\u5e45\u4e00\u5b9a\u306e\u30a2\u30af\u30bb\u30b9\u306b\u306a\u3063\u3066\u3044\u308b\u306e\u3067\u3001\u4e00\u5b9a\u3067\u306a\u3044\u5834\u5408\u306b\u3082vgather\u304c\u898b\u3089\u308c\u308b\u304b\u3069\u3046\u304b\u3092\u691c\u8a3c\u3057\u3066\u307f\u305f\u3002\u3072\u3068\u307e\u305a\u3001\u6b21\u306e\u3088\u3046\u306a\u30b3\u30fc\u30c9\u3092\u66f8\u3044\u3066vgather\u547d\u4ee4\u304c\u307f\u3089\u308c\u308b\u304b\u3069\u3046\u304b\u898b\u308b\u3002\ndouble sum = 0.0;\nfor (int i = 0; i < num; i++) {\n  const auto v = val[idx[i]];\n  sum += v;\n}\n\n\u98db\u3073\u98db\u3073\u3067\u30a2\u30af\u30bb\u30b9\u3057\u5024\u3092\u8aad\u307f\u8fbc\u307f\u3001\u8aad\u307f\u8fbc\u3093\u3060\u5024\u3092\u3059\u3079\u3066\u8db3\u3057\u3053\u3080\u3002\nidx\u306f\u5b9f\u884c\u6642\u306b\u5b9a\u307e\u308b\u5909\u6570\u3067\u3001\u30b3\u30f3\u30d1\u30a4\u30eb\u30bf\u30a4\u30e0\u306b\u306f\u5b9a\u307e\u3089\u306a\u3044\u5909\u6570\u3060\u3068\u3059\u308b\u3002\n\u3053\u306e\u6642\u3082\u540c\u3058\u3088\u3046\u306b4Byte\u30c7\u30fc\u30bf\u306e\u5834\u5408\u306b\u306fvgather\u304c\u4f7f\u308f\u308c\u308b\u304c\u30018Byte\u30c7\u30fc\u30bf\u306e\u5834\u5408\u306b\u306f\u4f7f\u308f\u308c\u306a\u3044\u3002\nint32_t\u306e\u5834\u5408\n..B3.13:                        # Preds ..B3.13 ..B3.12                                                                                                       \n        vmovdqu   ymm2, YMMWORD PTR [rdi+rax*4]                 #18.24                                                                                        \n        vpxor     ymm4, ymm4, ymm4                              #18.20                                                                                        \n        vpxor     ymm7, ymm7, ymm7                              #18.20                                                                                        \n        vmovdqa   ymm3, ymm0                                    #18.20                                                                                        \n        vpgatherdd ymm4, DWORD PTR [rcx+ymm2*4], ymm3           #18.20                                                                                        \n        vpaddd    ymm6, ymm1, ymm4                              #19.5                                                                                         \n        vmovdqu   ymm1, YMMWORD PTR [32+rdi+rax*4]              #18.24                                                                                        \n        vmovdqa   ymm5, ymm0                                    #18.20                                                                                        \n        add       rax, 16                                       #17.3                                                                                         \n        vpgatherdd ymm7, DWORD PTR [rcx+ymm1*4], ymm5           #18.20                                                                                        \n        vpaddd    ymm1, ymm6, ymm7                              #19.5                                                                                         \n        cmp       rax, rsi                                      #17.3                                                                                         \n        jb        ..B3.13       # Prob 82%                      #17.3\n\nint64_t\u306e\u5834\u5408\n..B3.4:                         # Preds ..B3.4 ..B3.3                                                                                                         \n        movsxd    r8, DWORD PTR [rdi+rax*4]                     #18.20                                                                                        \n        movsxd    r10, DWORD PTR [8+rdi+rax*4]                  #18.20                                                                                        \n        movsxd    r9, DWORD PTR [4+rdi+rax*4]                   #18.20                                                                                        \n        movsxd    r11, DWORD PTR [12+rdi+rax*4]                 #18.20                                                                                        \n        vmovq     xmm2, QWORD PTR [rsi+r8*8]                    #18.20                                                                                        \n        vmovq     xmm3, QWORD PTR [rsi+r10*8]                   #18.20                                                                                        \n        movsxd    r8, DWORD PTR [16+rdi+rax*4]                  #18.20                                                                                        \n        movsxd    r10, DWORD PTR [24+rdi+rax*4]                 #18.20                                                                                        \n        vpinsrq   xmm6, xmm2, QWORD PTR [rsi+r9*8], 1           #18.20                                                                                        \n        vpinsrq   xmm7, xmm3, QWORD PTR [rsi+r11*8], 1          #18.20                                                                                        \n        vmovq     xmm4, QWORD PTR [rsi+r8*8]                    #18.20                                                                                        \n        vmovq     xmm5, QWORD PTR [rsi+r10*8]                   #18.20                                                                                        \n        movsxd    r9, DWORD PTR [20+rdi+rax*4]                  #18.20                                                                                        \n        movsxd    r11, DWORD PTR [28+rdi+rax*4]                 #18.20                                                                                        \n        add       rax, 8                                        #17.3                                                                                         \n        vpinsrq   xmm9, xmm4, QWORD PTR [rsi+r9*8], 1           #18.20                                                                                        \n        vpinsrq   xmm10, xmm5, QWORD PTR [rsi+r11*8], 1         #18.20                                                                                        \n        vinserti128 ymm8, ymm6, xmm7, 1                         #18.20                                                                                        \n        vinserti128 ymm11, ymm9, xmm10, 1                       #18.20                                                                                        \n        vpaddq    ymm1, ymm1, ymm8                              #19.5                                                                                         \n        vpaddq    ymm0, ymm0, ymm11                             #19.5                                                                                         \n        cmp       rax, rdx                                      #17.3                                                                                         \n        jb        ..B3.4        # Prob 82%                      #17.3\n\nfloat\u306e\u5834\u5408\n..B3.13:                        # Preds ..B3.13 ..B3.12                                                                                                       \n        vmovups   ymm3, YMMWORD PTR [rdi+rax*4]                 #18.24                                                                                        \n        vmovups   ymm5, YMMWORD PTR [32+rdi+rax*4]              #18.24                                                                                        \n        vxorps    ymm7, ymm7, ymm7                              #18.20                                                                                        \n        add       rax, 16                                       #17.3                                                                                         \n        vmovdqa   ymm4, ymm0                                    #18.20                                                                                        \n        cmp       rax, rdx                                      #17.3                                                                                         \n        vxorps    ymm8, ymm8, ymm8                              #18.20                                                                                        \n        vmovdqa   ymm6, ymm0                                    #18.20                                                                                        \n        vgatherdps ymm7, DWORD PTR [rsi+ymm3*4], ymm4           #18.20                                                                                        \n        vgatherdps ymm8, DWORD PTR [rsi+ymm5*4], ymm6           #18.20                                                                                        \n        vaddps    ymm2, ymm2, ymm7                              #19.5                                                                                         \n        vaddps    ymm1, ymm1, ymm8                              #19.5                                                                                         \n        jb        ..B3.13       # Prob 82%                      #17.3\n\ndouble\u306e\u5834\u5408\n..B3.4:                         # Preds ..B3.4 ..B3.3                                                                                                         \n        movsxd    r9, DWORD PTR [rdi+rdx*4]                     #18.20                                                                                        \n        movsxd    r10, DWORD PTR [4+rdi+rdx*4]                  #18.20                                                                                        \n        movsxd    r11, DWORD PTR [8+rdi+rdx*4]                  #18.20                                                                                        \n        vmovsd    xmm2, QWORD PTR [rsi+r9*8]                    #18.20                                                                                        \n        movsxd    r9, DWORD PTR [12+rdi+rdx*4]                  #18.20                                                                                        \n        vmovhpd   xmm4, xmm2, QWORD PTR [rsi+r10*8]             #18.20                                                                                        \n        movsxd    r10, DWORD PTR [16+rdi+rdx*4]                 #18.20                                                                                        \n        vmovsd    xmm3, QWORD PTR [rsi+r11*8]                   #18.20                                                                                        \n        movsxd    r11, DWORD PTR [20+rdi+rdx*4]                 #18.20                                                                                        \n        vmovhpd   xmm5, xmm3, QWORD PTR [rsi+r9*8]              #18.20                                                                                        \n        movsxd    r9, DWORD PTR [24+rdi+rdx*4]                  #18.20                                                                                        \n        vmovsd    xmm6, QWORD PTR [rsi+r10*8]                   #18.20                                                                                        \n        movsxd    r10, DWORD PTR [28+rdi+rdx*4]                 #18.20                                                                                        \n        vmovhpd   xmm8, xmm6, QWORD PTR [rsi+r11*8]             #18.20                                                                                        \n        movsxd    r11, DWORD PTR [32+rdi+rdx*4]                 #18.20                                                                                        \n        vmovsd    xmm7, QWORD PTR [rsi+r9*8]                    #18.20                                                                                        \n        movsxd    r9, DWORD PTR [36+rdi+rdx*4]                  #18.20                                                                                        \n        vmovhpd   xmm9, xmm7, QWORD PTR [rsi+r10*8]             #18.20                                                                                        \n        movsxd    r10, DWORD PTR [40+rdi+rdx*4]                 #18.20                                                                                        \n        vinsertf128 ymm10, ymm4, xmm5, 1                        #18.20                                                                                        \n        vaddpd    ymm2, ymm1, ymm10                             #19.5                                                                                         \n        vmovsd    xmm1, QWORD PTR [rsi+r11*8]                   #18.20                                                                                        \n        vmovhpd   xmm12, xmm1, QWORD PTR [rsi+r9*8]             #18.20                                                                                        \n        movsxd    r11, DWORD PTR [44+rdi+rdx*4]                 #18.20                                                                                        \n        movsxd    r9, DWORD PTR [48+rdi+rdx*4]                  #18.20                                                                                        \n        vinsertf128 ymm11, ymm8, xmm9, 1                        #18.20                                                                                        \n        vaddpd    ymm3, ymm0, ymm11                             #19.5                                                                                         \n        vmovsd    xmm0, QWORD PTR [rsi+r10*8]                   #18.20                                                                                        \n        vmovhpd   xmm13, xmm0, QWORD PTR [rsi+r11*8]            #18.20                                                                                        \n        movsxd    r11, DWORD PTR [56+rdi+rdx*4]                 #18.20                                                                                        \n        movsxd    r10, DWORD PTR [52+rdi+rdx*4]                 #18.20                                                                                        \n        vmovsd    xmm14, QWORD PTR [rsi+r9*8]                   #18.20                                                                                        \n        movsxd    r9, DWORD PTR [60+rdi+rdx*4]                  #18.20                                                                                        \n        add       rdx, 16                                       #17.3                                                                                         \n        vmovsd    xmm15, QWORD PTR [rsi+r11*8]                  #18.20                                                                                        \n        vmovhpd   xmm1, xmm14, QWORD PTR [rsi+r10*8]            #18.20                                                                                        \n        vmovhpd   xmm14, xmm15, QWORD PTR [rsi+r9*8]            #18.20                                                                                        \n        vinsertf128 ymm0, ymm12, xmm13, 1                       #18.20                                                                                        \n        vinsertf128 ymm12, ymm1, xmm14, 1                       #18.20                                                                                        \n        vaddpd    ymm1, ymm0, ymm2                              #19.5                                                                                         \n        vaddpd    ymm0, ymm12, ymm3                             #19.5                                                                                         \n        cmp       rdx, rcx                                      #17.3\n        jb        ..B3.4        # Prob 82%                      #17.3\n\n\u547d\u4ee4\u3068\u3057\u3066vgatherqpd\u306a\u3069\u304c\u3042\u308b\u3051\u308c\u3069\u3082\u3001int64_t\u3084double\u306e\u5834\u5408\u306b\u306f\u3069\u3046\u3084\u3089\u4f7f\u308f\u308c\u306a\u3044\u307f\u305f\u3044\u3060\u3002\n\n\u307e\u3068\u3081\n\u81ea\u52d5\u30d9\u30af\u30c8\u30eb\u5316\u306e\u5834\u5408\u30018\u8981\u7d20\u306e\u5834\u5408\u306b\u306f\u304b\u306a\u308a\u7a4d\u6975\u7684\u306bvgather\u547d\u4ee4\u3092\u4f7f\u3063\u305f\u30d9\u30af\u30c8\u30eb\u5316\u3092\u3084\u308d\u3046\u3068\u8a66\u307f\u308b\u304c\u30014\u8981\u7d20\u306e\u5834\u5408\u306b\u306f\u5225\u306e\u3084\u308a\u65b9\u3092\u691c\u8a0e\u3059\u308b\u6a21\u69d8\u30024\u8981\u7d20\u306evgather\u306b\u3088\u308b\u30ed\u30fc\u30c9\u3092\u4f7f\u3046\u5834\u5408\u306f\u6027\u80fd\u3092\u51fa\u305b\u306a\u3044\u3053\u3068\u304c\u591a\u3044\u3068\u3044\u3046\u3053\u3068\u306a\u306e\u304b\uff1f\n\n\u8ffd\u8a18\n\u8abf\u3079\u3066\u3044\u305f\u3089VGATHER\u7cfb\u547d\u4ee4\u306e\u901f\u3055\u3042\u308b\u3044\u306f\u9045\u3055\u3068\u3044\u3046\u8a18\u4e8b\u3092\u898b\u3064\u3051\u305f\u3002intel\u306e\u6700\u9069\u5316\u30de\u30cb\u30e5\u30a2\u30eb\u306bvgather\u547d\u4ee4\u3092\u4f7f\u3046\u3079\u304d\u3068\u304d\u3068\u305d\u3046\u3067\u306a\u3044\u3068\u304d\u304c\u66f8\u3044\u3066\u3042\u308b\u307f\u305f\u3044\u3060\u3002\u305d\u308c\u306b\u3088\u308b\u3068\u4f7f\u3046\u3079\u304d\u3068\u304d\u306f\n\n4\u8981\u7d20\u4ee5\u4e0a\u3067\u56fa\u5b9a\u3067\u306a\u3044\u30de\u30b9\u30af \u2013 \u56fa\u5b9a\u3067\u306a\u3044\u30de\u30b9\u30af\u3092\u666e\u901a\u306e\u30ed\u30fc\u30c9\u3067\u884c\u304a\u3046\u3068\u3059\u308b\u3068\u3001\u5206\u5c90\u4e88\u6e2c\u304c\u5931\u6557\u3059\u308b\u3053\u3068\u306b\u3088\u308b\u6027\u80fd\u4f4e\u4e0b\u304c\u3042\u308b\n8\u8981\u7d20\u3067\u30d9\u30af\u30bf\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\uff08SIMD\u6f14\u7b97\u3057\u305f\u7d50\u679c\u304c\u305d\u306e\u307e\u307e\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u306b\u306a\u308b\uff09 \u2013 \u305d\u3082\u305d\u3082\u3053\u308c\u3053\u305d\u304cVGATHER\u306e\u76ee\u7684\u3068\u3059\u308b\u3068\u3053\u308d\u3067\u3042\u308b\n\n\u3068\u3042\u308b\u3089\u3057\u3044\u3002\u898b\u4e8b\u306b2\u306e\u30b1\u30fc\u30b9\u306b\u5f53\u3066\u306f\u307e\u308b\u5834\u5408\u306e\u307f\u81ea\u52d5\u30d9\u30af\u30c8\u30eb\u5316\u3055\u308c\u3066\u304a\u308a\u30014\u8981\u7d20\u306e2\u306e\u30b1\u30fc\u30b9\u306b\u5f53\u3066\u306f\u307e\u3089\u306a\u3044\u5834\u5408\u306b\u306f\u81ea\u52d5\u30d9\u30af\u30c8\u30eb\u5316\u3055\u308c\u3066\u3044\u306a\u3044\u3002\u306a\u308b\u307b\u3069\u3002\n#\u306f\u3058\u3081\u306b\nHaswell\u304b\u3089vgather\u7cfb\u306e\u547d\u4ee4\u304c\u51fa\u3066\u304d\u305f\u8a33\u3067\u3059\u304c\u3001\u9045\u3044\u3089\u3057\u304f\"Will get improvement in Intel next generation CPU\"\u3068\u30a2\u30ca\u30a6\u30f3\u30b9\u3055\u308c\u305f\u307b\u3069\u3002\u7d44\u307f\u8fbc\u307f\u95a2\u6570\u3067\u66f8\u304b\u306a\u3044\u9650\u308a\u306fvgather\u547d\u4ee4\u306f\u51fa\u3066\u3053\u306a\u3044\u3068\u601d\u3063\u3066\u3044\u305f\u3089\u3001\u305d\u3046\u3067\u306f\u306a\u304b\u3063\u305f\u3068\u3044\u3046\u8a71\u3002\u30a2\u30bb\u30f3\u30d6\u30e9\u306fintel\u5f62\u5f0f\u3067\u3002\u30bd\u30fc\u30b9\u30b3\u30fc\u30c9\u306f[gist](https://gist.github.com/kohnakagawa/e710fddbc3494beddb19c7b9adab7844)\u306b\u3042\u308b\u3002\n\n\u30b3\u30f3\u30d1\u30a4\u30e9\u306ficpc (ICC) 16.0.4 20160811\u3067\u3001\u30b3\u30f3\u30d1\u30a4\u30eb\u306f\n\n```bash\n$ icpc -S -O3 -xHOST -std=c++11 -masm=intel gather.cpp\n```\n\n\u3067\u884c\u3046\u3002\u30b3\u30f3\u30d1\u30a4\u30eb\u3057\u3066\u3044\u308b\u74b0\u5883\u306fXeon(R) CPU E5-2680\u3067Haswell\u4e16\u4ee3\u306eXeon\u3067\u3042\u308b\u3002\n\n#\u884c\u5217\u884c\u5217\u7a4d\n\u79d1\u5b66\u6280\u8853\u8a08\u7b97\u3067\u3088\u304f\u898b\u3089\u308c\u308b\u8a08\u7b97\u3002\u4ee5\u4e0b\u306e\u3088\u3046\u306a\uff13\u91cd\u30eb\u30fc\u30d7\u3067\u304b\u3051\u308b\u3002\u305f\u3060\u3057\u3001\u914d\u5217c\u306f0\u30af\u30ea\u30a2\u3055\u308c\u3066\u3044\u308b\u3068\u3059\u308b\u3002\n\n```c++\nfor (int i = 0; i < N; i++) {\n  for (int j = 0; j < N; j++) {\n    for (int k = 0; k < N; k++) {\n      c[i][j] += a[i][k] * b[k][j];\n    }\n  }\n}\n```\n\n(\u3082\u3061\u308d\u3093\u3001\u884c\u5217\u30b5\u30a4\u30ba\u304c\u5927\u304d\u3044\u5834\u5408\u306b\u306f\u3053\u3093\u306a\u624b\u3067\u66f8\u304b\u306a\u3044\u3067\u3001\u30e9\u30a4\u30d6\u30e9\u30ea\u3092\u4f7f\u3046\u3079\u304d)\n\n\u4e0a\u306e\u30b3\u30fc\u30c9\u3067\u306f\u30d9\u30af\u30c8\u30eb\u5316\u3055\u308c\u306a\u3044\u304c\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u66f8\u304d\u63db\u3048\u308b\u3068\u30d9\u30af\u30c8\u30eb\u5316\u3055\u308c\u308b\u3002\n\n```c++\n  for (int i = 0; i < N; i++) {\n    for (int j = 0; j < N; j++) {\n      int sum = 0;\n      for (int k = 0; k < N; k++) {\n        sum += a[i][k] * b[k][j];\n      }\n      c[i][j] = sum;\n    }\n  }\n```\n\n\u6700\u5185\u30eb\u30fc\u30d7\u306b\u76f8\u5f53\u3059\u308b\u30a2\u30bb\u30f3\u30d6\u30e9\u3092\u53d6\u308a\u51fa\u3057\u3066\u304f\u308b\u3068\u3053\u3093\u306a\u611f\u3058\u3002\n\n```nasm\n..B4.10:                        # Preds ..B4.10 ..B4.9\n        vmovdqa   ymm3, ymm0                                    #40.26\n        lea       rsi, QWORD PTR [rax+r12]                      #40.26\n        vpxor     ymm4, ymm4, ymm4                              #40.26\n        lea       rdi, QWORD PTR [16384+rax+r12]                #40.9\n        vpxor     ymm6, ymm6, ymm6                              #40.26\n        vpgatherdd ymm4, DWORD PTR [rsi+ymm1*8], ymm3           #40.26\n        vpmulld   ymm5, ymm4, YMMWORD PTR [r8+rdx*4]            #40.26\n        add       rax, 32768                                    #39.7\n        vpaddd    ymm7, ymm2, ymm5                              #40.9\n        vmovdqa   ymm2, ymm0                                    #40.26\n        vpgatherdd ymm6, DWORD PTR [rdi+ymm1*8], ymm2           #40.26\n        vpmulld   ymm8, ymm6, YMMWORD PTR [32+r8+rdx*4]         #40.26\n        add       rdx, 16                                       #39.7\n        vpaddd    ymm2, ymm7, ymm8                              #40.9\n        cmp       rdx, rcx                                      #39.7\n        jb        ..B4.10       # Prob 99%                      #39.7\n\n```\n\nvpgatherdd\u3068\u3044\u3046vgather\u7cfb\u547d\u4ee4\u304c\u898b\u3089\u308c\u308b\u3002\n\nC\u8a00\u8a9e\u3067\u306e\u4e8c\u6b21\u5143\u914d\u5217\u306frow major order\u306a\u306e\u3067\u3001\u6700\u5185\u30eb\u30fc\u30d7\u3067\u914d\u5217a\u306findex k\u306b\u3064\u3044\u3066\u9023\u7d9a\u30a2\u30af\u30bb\u30b9\u306b\u306a\u308b\u304c\u3001\u914d\u5217b\u306findex k\u306b\u3064\u3044\u3066\u9023\u7d9a\u30a2\u30af\u30bb\u30b9\u306b\u306f\u306a\u3089\u306a\u3044\u3002\u305d\u3053\u3067\u3001\u4e0d\u9023\u7d9a\u306a\u30e1\u30e2\u30ea\u30a2\u30af\u30bb\u30b9\u306b\u306a\u308b\u914d\u5217b\u306e\u30c7\u30fc\u30bf\u30928\u500b\u53d6\u3063\u3066\u6765\u308b\u305f\u3081\u306bvgather\u3092\u4f7f\u3063\u3066\u3044\u308b\u3002\u30a2\u30bb\u30f3\u30d6\u30e9\u3092\u898b\u308b\u9650\u308a\u3067\u306f\u6700\u5185\u30eb\u30fc\u30d7\u30922\u500d\u30a2\u30f3\u30ed\u30fc\u30eb\u3057\u306616\u500b\u306eint\u30c7\u30fc\u30bf\u306b\u3064\u3044\u3066\u51e6\u7406\u3092\u3057\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002vpgatherdd\u304c2\u56de\u547c\u3070\u308c\u3066\u3044\u308b\u306e\u306f\u305d\u306e\u305f\u3081\u3002\n\n\u4eca\u3001\u914d\u5217a, b, c\u306e\u30c7\u30fc\u30bf\u3092int\u3068\u3057\u3066\u308b\u304c\u3001float\u306b\u3059\u308b\u3068\u3069\u3046\u306a\u308b\u304b\u3002\n\u540c\u3058\u3088\u3046\u306bvgather\u7cfb\u547d\u4ee4\u304c\u898b\u3089\u308c\u308b\u3002\n\n```nasm\n..B7.4:                         # Preds ..B7.4 ..B7.3                                                                                                         \n        vmovdqa   ymm11, ymm0                                   #58.26\n        lea       r15, QWORD PTR [r10+rbx]                      #58.26\n        vxorps    ymm12, ymm12, ymm12                           #58.26\n        vgatherdps ymm12, DWORD PTR [r15+ymm9*8], ymm11         #58.26\n        lea       r15, QWORD PTR [16384+rbx+r10]                #58.26\n        vxorps    ymm14, ymm14, ymm14                           #58.26\n        vmovdqa   ymm13, ymm0                                   #58.26\n        vgatherdps ymm14, DWORD PTR [r15+ymm9*8], ymm13         #58.26\n        lea       r15, QWORD PTR [32768+rbx+r10]                #58.26\n        vfmadd231ps ymm7, ymm12, YMMWORD PTR [r14+r11*4]        #58.9 \n        vfmadd231ps ymm1, ymm14, YMMWORD PTR [32+r14+r11*4]     #58.9 \n        vxorps    ymm11, ymm11, ymm11                           #58.26\n        vmovdqa   ymm15, ymm0                                   #58.26\n        vgatherdps ymm11, DWORD PTR [r15+ymm9*8], ymm15         #58.26\n        lea       r15, QWORD PTR [49152+rbx+r10]                #58.26\n        vxorps    ymm13, ymm13, ymm13                           #58.26\n        vmovdqa   ymm12, ymm0                                   #58.26\n        vgatherdps ymm13, DWORD PTR [r15+ymm9*8], ymm12         #58.26\n        lea       r15, QWORD PTR [65536+rbx+r10]                #58.26\n        vfmadd231ps ymm6, ymm11, YMMWORD PTR [64+r14+r11*4]     #58.9 \n        vfmadd231ps ymm5, ymm13, YMMWORD PTR [96+r14+r11*4]     #58.9 \n        vxorps    ymm11, ymm11, ymm11                           #58.26\n        vmovdqa   ymm14, ymm0                                   #58.26\n        vgatherdps ymm11, DWORD PTR [r15+ymm9*8], ymm14         #58.26\n        lea       r15, QWORD PTR [81920+rbx+r10]                #58.26\n        vxorps    ymm13, ymm13, ymm13                           #58.26\n        vmovdqa   ymm12, ymm0                                   #58.26\n        vgatherdps ymm13, DWORD PTR [r15+ymm9*8], ymm12         #58.26\n        lea       r15, QWORD PTR [98304+rbx+r10]                #58.26\n        vfmadd231ps ymm4, ymm11, YMMWORD PTR [128+r14+r11*4]    #58.9 \n        vfmadd231ps ymm3, ymm13, YMMWORD PTR [160+r14+r11*4]    #58.9 \n        vxorps    ymm11, ymm11, ymm11                           #58.26\n        vmovdqa   ymm15, ymm0                                   #58.26\n        vgatherdps ymm11, DWORD PTR [r15+ymm9*8], ymm15         #58.26\n        lea       r15, QWORD PTR [114688+rbx+r10]               #58.26\n        vxorps    ymm13, ymm13, ymm13                           #58.26\n        add       rbx, 131072                                   #57.7 \n        vmovdqa   ymm12, ymm0                                   #58.26\n        vgatherdps ymm13, DWORD PTR [r15+ymm9*8], ymm12         #58.26\n        vfmadd231ps ymm2, ymm11, YMMWORD PTR [192+r14+r11*4]    #58.9 \n        vfmadd231ps ymm10, ymm13, YMMWORD PTR [224+r14+r11*4]   #58.9 \n        add       r11, 64                                       #57.7\n        cmp       r11, 512                                      #57.7\n        jb        ..B7.4        # Prob 99%                      #57.7\n```\n\n\u3057\u304b\u3057\u306a\u304c\u3089\u3001float\u304b\u3089double\u3084int64_t\u306b\u5909\u3048\u308b\u3068vgather\u306f\u898b\u3089\u308c\u306a\u304f\u306a\u308b\u3002\n\ndouble\u306e\u5834\u5408\n\n```nasm\n..B7.10:                        # Preds ..B7.10 ..B7.9                \n        vmovsd    xmm10, QWORD PTR [rcx+r9]                     #60.26\n        vmovsd    xmm11, QWORD PTR [8192+rcx+r9]                #60.26\n        vmovhpd   xmm12, xmm10, QWORD PTR [4096+rcx+r9]         #60.26\n        vmovhpd   xmm13, xmm11, QWORD PTR [12288+rcx+r9]        #60.26\n        vmovsd    xmm15, QWORD PTR [16384+rcx+r9]               #60.26\n        vmovsd    xmm10, QWORD PTR [24576+rcx+r9]               #60.26\n        vmovhpd   xmm11, xmm15, QWORD PTR [20480+rcx+r9]        #60.26\n        vmovsd    xmm15, QWORD PTR [40960+rcx+r9]               #60.26\n        vinsertf128 ymm14, ymm12, xmm13, 1                      #60.26\n        vfmadd231pd ymm8, ymm14, YMMWORD PTR [r10+rax*8]        #60.9 \n        vmovsd    xmm14, QWORD PTR [32768+rcx+r9]               #60.26\n        vmovhpd   xmm12, xmm10, QWORD PTR [28672+rcx+r9]        #60.26\n        vmovhpd   xmm10, xmm14, QWORD PTR [36864+rcx+r9]        #60.26\n        vmovsd    xmm14, QWORD PTR [57344+rcx+r9]               #60.26\n        vinsertf128 ymm13, ymm11, xmm12, 1                      #60.26\n        vmovhpd   xmm11, xmm15, QWORD PTR [45056+rcx+r9]        #60.26\n        vfmadd231pd ymm5, ymm13, YMMWORD PTR [32+r10+rax*8]     #60.9 \n        vmovsd    xmm13, QWORD PTR [49152+rcx+r9]               #60.26\n        vmovhpd   xmm15, xmm13, QWORD PTR [53248+rcx+r9]        #60.26\n        vmovsd    xmm13, QWORD PTR [73728+rcx+r9]               #60.26\n        vinsertf128 ymm12, ymm10, xmm11, 1                      #60.26\n        vfmadd231pd ymm4, ymm12, YMMWORD PTR [64+r10+rax*8]     #60.9 \n        vmovsd    xmm12, QWORD PTR [65536+rcx+r9]               #60.26\n        vmovhpd   xmm10, xmm14, QWORD PTR [61440+rcx+r9]        #60.26\n        vmovhpd   xmm14, xmm12, QWORD PTR [69632+rcx+r9]        #60.26\n        vmovsd    xmm12, QWORD PTR [81920+rcx+r9]               #60.26\n        vinsertf128 ymm11, ymm15, xmm10, 1                      #60.26\n        vmovhpd   xmm10, xmm13, QWORD PTR [77824+rcx+r9]        #60.26\n        vmovsd    xmm13, QWORD PTR [90112+rcx+r9]               #60.26\n        vmovhpd   xmm15, xmm12, QWORD PTR [86016+rcx+r9]        #60.26\n        vfmadd231pd ymm3, ymm11, YMMWORD PTR [96+r10+rax*8]     #60.9 \n        vmovsd    xmm12, QWORD PTR [98304+rcx+r9]               #60.26\n        vinsertf128 ymm11, ymm14, xmm10, 1                      #60.26\n        vmovhpd   xmm10, xmm13, QWORD PTR [94208+rcx+r9]        #60.26\n        vmovsd    xmm13, QWORD PTR [106496+rcx+r9]              #60.26\n        vmovhpd   xmm14, xmm12, QWORD PTR [102400+rcx+r9]       #60.26\n        vfmadd231pd ymm2, ymm11, YMMWORD PTR [128+r10+rax*8]    #60.9 \n        vmovsd    xmm12, QWORD PTR [114688+rcx+r9]              #60.26\n        vinsertf128 ymm11, ymm15, xmm10, 1                      #60.26\n        vmovhpd   xmm10, xmm13, QWORD PTR [110592+rcx+r9]       #60.26\n        vmovsd    xmm13, QWORD PTR [122880+rcx+r9]              #60.26\n        vmovhpd   xmm15, xmm12, QWORD PTR [118784+rcx+r9]       #60.26\n        vfmadd231pd ymm1, ymm11, YMMWORD PTR [160+r10+rax*8]    #60.9 \n        vinsertf128 ymm11, ymm14, xmm10, 1                      #60.26\n        vmovhpd   xmm10, xmm13, QWORD PTR [126976+rcx+r9]       #60.26\n        add       rcx, 131072                                   #59.7 \n        vfmadd231pd ymm0, ymm11, YMMWORD PTR [192+r10+rax*8]    #60.9 \n        vinsertf128 ymm11, ymm15, xmm10, 1                      #60.26\n        vfmadd231pd ymm6, ymm11, YMMWORD PTR [224+r10+rax*8]    #60.9 \n        add       rax, 32                                       #59.7 \n        cmp       rax, rdx                                      #59.7 \n        jb        ..B7.10       # Prob 99%                      #59.7 \n```\n\n\u3069\u3046\u3084\u30894Byte\u30c7\u30fc\u30bf\u30928\u500b\u6301\u3063\u3066\u304f\u308b\u5834\u5408\u306b\u306fvgather\u547d\u4ee4\u304c\u7a4d\u6975\u7684\u306b\u4f7f\u308f\u308c\u308b\u3051\u3069\u30018Byte\u30c7\u30fc\u30bf\u30924\u500b\u6301\u3063\u3066\u304f\u308b\u5834\u5408\u306b\u306f\u4f7f\u308f\u308c\u306a\u3044\u307f\u305f\u3044\u3060\u3002\n\n#\u30b9\u30c8\u30e9\u30a4\u30c9\u5e45\u304c\u4e00\u5b9a\u3067\u306f\u306a\u3044\u5834\u5408\n\u884c\u5217\u884c\u5217\u7a4d\u306e\u5834\u5408\u3060\u3068\u30b9\u30c8\u30e9\u30a4\u30c9\u5e45\u4e00\u5b9a\u306e\u30a2\u30af\u30bb\u30b9\u306b\u306a\u3063\u3066\u3044\u308b\u306e\u3067\u3001\u4e00\u5b9a\u3067\u306a\u3044\u5834\u5408\u306b\u3082vgather\u304c\u898b\u3089\u308c\u308b\u304b\u3069\u3046\u304b\u3092\u691c\u8a3c\u3057\u3066\u307f\u305f\u3002\u3072\u3068\u307e\u305a\u3001\u6b21\u306e\u3088\u3046\u306a\u30b3\u30fc\u30c9\u3092\u66f8\u3044\u3066vgather\u547d\u4ee4\u304c\u307f\u3089\u308c\u308b\u304b\u3069\u3046\u304b\u898b\u308b\u3002\n\n```c++\ndouble sum = 0.0;\nfor (int i = 0; i < num; i++) {\n  const auto v = val[idx[i]];\n  sum += v;\n}\n```\n\n\u98db\u3073\u98db\u3073\u3067\u30a2\u30af\u30bb\u30b9\u3057\u5024\u3092\u8aad\u307f\u8fbc\u307f\u3001\u8aad\u307f\u8fbc\u3093\u3060\u5024\u3092\u3059\u3079\u3066\u8db3\u3057\u3053\u3080\u3002\nidx\u306f\u5b9f\u884c\u6642\u306b\u5b9a\u307e\u308b\u5909\u6570\u3067\u3001\u30b3\u30f3\u30d1\u30a4\u30eb\u30bf\u30a4\u30e0\u306b\u306f\u5b9a\u307e\u3089\u306a\u3044\u5909\u6570\u3060\u3068\u3059\u308b\u3002\n\u3053\u306e\u6642\u3082\u540c\u3058\u3088\u3046\u306b4Byte\u30c7\u30fc\u30bf\u306e\u5834\u5408\u306b\u306fvgather\u304c\u4f7f\u308f\u308c\u308b\u304c\u30018Byte\u30c7\u30fc\u30bf\u306e\u5834\u5408\u306b\u306f\u4f7f\u308f\u308c\u306a\u3044\u3002\n\nint32_t\u306e\u5834\u5408\n\n```nasm\n..B3.13:                        # Preds ..B3.13 ..B3.12                                                                                                       \n        vmovdqu   ymm2, YMMWORD PTR [rdi+rax*4]                 #18.24                                                                                        \n        vpxor     ymm4, ymm4, ymm4                              #18.20                                                                                        \n        vpxor     ymm7, ymm7, ymm7                              #18.20                                                                                        \n        vmovdqa   ymm3, ymm0                                    #18.20                                                                                        \n        vpgatherdd ymm4, DWORD PTR [rcx+ymm2*4], ymm3           #18.20                                                                                        \n        vpaddd    ymm6, ymm1, ymm4                              #19.5                                                                                         \n        vmovdqu   ymm1, YMMWORD PTR [32+rdi+rax*4]              #18.24                                                                                        \n        vmovdqa   ymm5, ymm0                                    #18.20                                                                                        \n        add       rax, 16                                       #17.3                                                                                         \n        vpgatherdd ymm7, DWORD PTR [rcx+ymm1*4], ymm5           #18.20                                                                                        \n        vpaddd    ymm1, ymm6, ymm7                              #19.5                                                                                         \n        cmp       rax, rsi                                      #17.3                                                                                         \n        jb        ..B3.13       # Prob 82%                      #17.3\n```\n\nint64_t\u306e\u5834\u5408\n\n```nasm\n..B3.4:                         # Preds ..B3.4 ..B3.3                                                                                                         \n        movsxd    r8, DWORD PTR [rdi+rax*4]                     #18.20                                                                                        \n        movsxd    r10, DWORD PTR [8+rdi+rax*4]                  #18.20                                                                                        \n        movsxd    r9, DWORD PTR [4+rdi+rax*4]                   #18.20                                                                                        \n        movsxd    r11, DWORD PTR [12+rdi+rax*4]                 #18.20                                                                                        \n        vmovq     xmm2, QWORD PTR [rsi+r8*8]                    #18.20                                                                                        \n        vmovq     xmm3, QWORD PTR [rsi+r10*8]                   #18.20                                                                                        \n        movsxd    r8, DWORD PTR [16+rdi+rax*4]                  #18.20                                                                                        \n        movsxd    r10, DWORD PTR [24+rdi+rax*4]                 #18.20                                                                                        \n        vpinsrq   xmm6, xmm2, QWORD PTR [rsi+r9*8], 1           #18.20                                                                                        \n        vpinsrq   xmm7, xmm3, QWORD PTR [rsi+r11*8], 1          #18.20                                                                                        \n        vmovq     xmm4, QWORD PTR [rsi+r8*8]                    #18.20                                                                                        \n        vmovq     xmm5, QWORD PTR [rsi+r10*8]                   #18.20                                                                                        \n        movsxd    r9, DWORD PTR [20+rdi+rax*4]                  #18.20                                                                                        \n        movsxd    r11, DWORD PTR [28+rdi+rax*4]                 #18.20                                                                                        \n        add       rax, 8                                        #17.3                                                                                         \n        vpinsrq   xmm9, xmm4, QWORD PTR [rsi+r9*8], 1           #18.20                                                                                        \n        vpinsrq   xmm10, xmm5, QWORD PTR [rsi+r11*8], 1         #18.20                                                                                        \n        vinserti128 ymm8, ymm6, xmm7, 1                         #18.20                                                                                        \n        vinserti128 ymm11, ymm9, xmm10, 1                       #18.20                                                                                        \n        vpaddq    ymm1, ymm1, ymm8                              #19.5                                                                                         \n        vpaddq    ymm0, ymm0, ymm11                             #19.5                                                                                         \n        cmp       rax, rdx                                      #17.3                                                                                         \n        jb        ..B3.4        # Prob 82%                      #17.3\n```\n\nfloat\u306e\u5834\u5408\n\n```nasm\n..B3.13:                        # Preds ..B3.13 ..B3.12                                                                                                       \n        vmovups   ymm3, YMMWORD PTR [rdi+rax*4]                 #18.24                                                                                        \n        vmovups   ymm5, YMMWORD PTR [32+rdi+rax*4]              #18.24                                                                                        \n        vxorps    ymm7, ymm7, ymm7                              #18.20                                                                                        \n        add       rax, 16                                       #17.3                                                                                         \n        vmovdqa   ymm4, ymm0                                    #18.20                                                                                        \n        cmp       rax, rdx                                      #17.3                                                                                         \n        vxorps    ymm8, ymm8, ymm8                              #18.20                                                                                        \n        vmovdqa   ymm6, ymm0                                    #18.20                                                                                        \n        vgatherdps ymm7, DWORD PTR [rsi+ymm3*4], ymm4           #18.20                                                                                        \n        vgatherdps ymm8, DWORD PTR [rsi+ymm5*4], ymm6           #18.20                                                                                        \n        vaddps    ymm2, ymm2, ymm7                              #19.5                                                                                         \n        vaddps    ymm1, ymm1, ymm8                              #19.5                                                                                         \n        jb        ..B3.13       # Prob 82%                      #17.3\n```\n\ndouble\u306e\u5834\u5408\n\n```nasm\n..B3.4:                         # Preds ..B3.4 ..B3.3                                                                                                         \n        movsxd    r9, DWORD PTR [rdi+rdx*4]                     #18.20                                                                                        \n        movsxd    r10, DWORD PTR [4+rdi+rdx*4]                  #18.20                                                                                        \n        movsxd    r11, DWORD PTR [8+rdi+rdx*4]                  #18.20                                                                                        \n        vmovsd    xmm2, QWORD PTR [rsi+r9*8]                    #18.20                                                                                        \n        movsxd    r9, DWORD PTR [12+rdi+rdx*4]                  #18.20                                                                                        \n        vmovhpd   xmm4, xmm2, QWORD PTR [rsi+r10*8]             #18.20                                                                                        \n        movsxd    r10, DWORD PTR [16+rdi+rdx*4]                 #18.20                                                                                        \n        vmovsd    xmm3, QWORD PTR [rsi+r11*8]                   #18.20                                                                                        \n        movsxd    r11, DWORD PTR [20+rdi+rdx*4]                 #18.20                                                                                        \n        vmovhpd   xmm5, xmm3, QWORD PTR [rsi+r9*8]              #18.20                                                                                        \n        movsxd    r9, DWORD PTR [24+rdi+rdx*4]                  #18.20                                                                                        \n        vmovsd    xmm6, QWORD PTR [rsi+r10*8]                   #18.20                                                                                        \n        movsxd    r10, DWORD PTR [28+rdi+rdx*4]                 #18.20                                                                                        \n        vmovhpd   xmm8, xmm6, QWORD PTR [rsi+r11*8]             #18.20                                                                                        \n        movsxd    r11, DWORD PTR [32+rdi+rdx*4]                 #18.20                                                                                        \n        vmovsd    xmm7, QWORD PTR [rsi+r9*8]                    #18.20                                                                                        \n        movsxd    r9, DWORD PTR [36+rdi+rdx*4]                  #18.20                                                                                        \n        vmovhpd   xmm9, xmm7, QWORD PTR [rsi+r10*8]             #18.20                                                                                        \n        movsxd    r10, DWORD PTR [40+rdi+rdx*4]                 #18.20                                                                                        \n        vinsertf128 ymm10, ymm4, xmm5, 1                        #18.20                                                                                        \n        vaddpd    ymm2, ymm1, ymm10                             #19.5                                                                                         \n        vmovsd    xmm1, QWORD PTR [rsi+r11*8]                   #18.20                                                                                        \n        vmovhpd   xmm12, xmm1, QWORD PTR [rsi+r9*8]             #18.20                                                                                        \n        movsxd    r11, DWORD PTR [44+rdi+rdx*4]                 #18.20                                                                                        \n        movsxd    r9, DWORD PTR [48+rdi+rdx*4]                  #18.20                                                                                        \n        vinsertf128 ymm11, ymm8, xmm9, 1                        #18.20                                                                                        \n        vaddpd    ymm3, ymm0, ymm11                             #19.5                                                                                         \n        vmovsd    xmm0, QWORD PTR [rsi+r10*8]                   #18.20                                                                                        \n        vmovhpd   xmm13, xmm0, QWORD PTR [rsi+r11*8]            #18.20                                                                                        \n        movsxd    r11, DWORD PTR [56+rdi+rdx*4]                 #18.20                                                                                        \n        movsxd    r10, DWORD PTR [52+rdi+rdx*4]                 #18.20                                                                                        \n        vmovsd    xmm14, QWORD PTR [rsi+r9*8]                   #18.20                                                                                        \n        movsxd    r9, DWORD PTR [60+rdi+rdx*4]                  #18.20                                                                                        \n        add       rdx, 16                                       #17.3                                                                                         \n        vmovsd    xmm15, QWORD PTR [rsi+r11*8]                  #18.20                                                                                        \n        vmovhpd   xmm1, xmm14, QWORD PTR [rsi+r10*8]            #18.20                                                                                        \n        vmovhpd   xmm14, xmm15, QWORD PTR [rsi+r9*8]            #18.20                                                                                        \n        vinsertf128 ymm0, ymm12, xmm13, 1                       #18.20                                                                                        \n        vinsertf128 ymm12, ymm1, xmm14, 1                       #18.20                                                                                        \n        vaddpd    ymm1, ymm0, ymm2                              #19.5                                                                                         \n        vaddpd    ymm0, ymm12, ymm3                             #19.5                                                                                         \n        cmp       rdx, rcx                                      #17.3\n        jb        ..B3.4        # Prob 82%                      #17.3\n```\n\n\u547d\u4ee4\u3068\u3057\u3066vgatherqpd\u306a\u3069\u304c\u3042\u308b\u3051\u308c\u3069\u3082\u3001int64_t\u3084double\u306e\u5834\u5408\u306b\u306f\u3069\u3046\u3084\u3089\u4f7f\u308f\u308c\u306a\u3044\u307f\u305f\u3044\u3060\u3002\n#\u307e\u3068\u3081\n\u81ea\u52d5\u30d9\u30af\u30c8\u30eb\u5316\u306e\u5834\u5408\u30018\u8981\u7d20\u306e\u5834\u5408\u306b\u306f\u304b\u306a\u308a\u7a4d\u6975\u7684\u306bvgather\u547d\u4ee4\u3092\u4f7f\u3063\u305f\u30d9\u30af\u30c8\u30eb\u5316\u3092\u3084\u308d\u3046\u3068\u8a66\u307f\u308b\u304c\u30014\u8981\u7d20\u306e\u5834\u5408\u306b\u306f\u5225\u306e\u3084\u308a\u65b9\u3092\u691c\u8a0e\u3059\u308b\u6a21\u69d8\u30024\u8981\u7d20\u306evgather\u306b\u3088\u308b\u30ed\u30fc\u30c9\u3092\u4f7f\u3046\u5834\u5408\u306f\u6027\u80fd\u3092\u51fa\u305b\u306a\u3044\u3053\u3068\u304c\u591a\u3044\u3068\u3044\u3046\u3053\u3068\u306a\u306e\u304b\uff1f\n\n#\u8ffd\u8a18\n\u8abf\u3079\u3066\u3044\u305f\u3089[VGATHER\u7cfb\u547d\u4ee4\u306e\u901f\u3055\u3042\u308b\u3044\u306f\u9045\u3055](http://umezawa.dyndns.info/wordpress/?p=4266)\u3068\u3044\u3046\u8a18\u4e8b\u3092\u898b\u3064\u3051\u305f\u3002intel\u306e\u6700\u9069\u5316\u30de\u30cb\u30e5\u30a2\u30eb\u306bvgather\u547d\u4ee4\u3092\u4f7f\u3046\u3079\u304d\u3068\u304d\u3068\u305d\u3046\u3067\u306a\u3044\u3068\u304d\u304c\u66f8\u3044\u3066\u3042\u308b\u307f\u305f\u3044\u3060\u3002\u305d\u308c\u306b\u3088\u308b\u3068\u4f7f\u3046\u3079\u304d\u3068\u304d\u306f\n\n1. 4\u8981\u7d20\u4ee5\u4e0a\u3067\u56fa\u5b9a\u3067\u306a\u3044\u30de\u30b9\u30af \u2013 \u56fa\u5b9a\u3067\u306a\u3044\u30de\u30b9\u30af\u3092\u666e\u901a\u306e\u30ed\u30fc\u30c9\u3067\u884c\u304a\u3046\u3068\u3059\u308b\u3068\u3001\u5206\u5c90\u4e88\u6e2c\u304c\u5931\u6557\u3059\u308b\u3053\u3068\u306b\u3088\u308b\u6027\u80fd\u4f4e\u4e0b\u304c\u3042\u308b\n2. 8\u8981\u7d20\u3067\u30d9\u30af\u30bf\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\uff08SIMD\u6f14\u7b97\u3057\u305f\u7d50\u679c\u304c\u305d\u306e\u307e\u307e\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u306b\u306a\u308b\uff09 \u2013 \u305d\u3082\u305d\u3082\u3053\u308c\u3053\u305d\u304cVGATHER\u306e\u76ee\u7684\u3068\u3059\u308b\u3068\u3053\u308d\u3067\u3042\u308b\n\n\u3068\u3042\u308b\u3089\u3057\u3044\u3002\u898b\u4e8b\u306b2\u306e\u30b1\u30fc\u30b9\u306b\u5f53\u3066\u306f\u307e\u308b\u5834\u5408\u306e\u307f\u81ea\u52d5\u30d9\u30af\u30c8\u30eb\u5316\u3055\u308c\u3066\u304a\u308a\u30014\u8981\u7d20\u306e2\u306e\u30b1\u30fc\u30b9\u306b\u5f53\u3066\u306f\u307e\u3089\u306a\u3044\u5834\u5408\u306b\u306f\u81ea\u52d5\u30d9\u30af\u30c8\u30eb\u5316\u3055\u308c\u3066\u3044\u306a\u3044\u3002\u306a\u308b\u307b\u3069\u3002\n", "tags": ["AVX", "AVX2", "C++"]}