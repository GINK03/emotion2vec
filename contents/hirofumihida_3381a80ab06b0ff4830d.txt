{"context": "\n\nInstall nested devstack(stable/mitaka) on KVM\n\n\u672c\u66f8\u306e\u76ee\u7684\n\nKVM \u30db\u30b9\u30c8\u4e0a\u306b\u30cd\u30b9\u30c8\u306e devstack \u74b0\u5883\u3092\u69cb\u7bc9\u3059\u308b\u305f\u3081\u306e\u5099\u5fd8\u9332\n\u3068\u308a\u3042\u3048\u305a\u52d5\u304b\u3057\u306f\u3058\u3081\u308b\u3053\u3068\u3092\u76ee\u7684\u306b\u3057\u3066\u3044\u307e\u3059\n\n\n\u30ea\u30d5\u30a1\u30ec\u30f3\u30b9\n\nhttps://blog.davelindon.me/install-openstack-devstack-on-centos-7/\nhttp://docs.openstack.org/developer/devstack/guides/devstack-with-nested-kvm.html\nhttps://github.com/vagrant-libvirt/vagrant-libvirt\n\n\nSystem \u69cb\u6210\n\nKVM\n\nUbuntu 14.04.3 LTS\nqemu-kvm 2.0.0\nlibvirt 1.2.2\n\n\nVagrant\n\nVagrant 1.8.1\nvagrant-libvirt (0.0.32)\n\n\ndevstack\n\nMitaka\nCentOS7 box\n\n\n4GB memory\n4 cpus\n100G disk\ndevstack \u30db\u30b9\u30c8\u306f ubuntu \u3067\u3082\u826f\u304b\u3063\u305f\u306e\u3067\u3059\u304c libvirt \u7248\u306e\u516c\u5f0f ubuntu box \u304c\u7121\u3044\u306e\u3067 CentOS7 \u306b\u3057\u3066\u3044\u307e\u3059\n\n\n\n\nCheck Host Requirements\n~$ cat /sys/module/kvm_intel/parameters/nested\nY\n~$ modinfo kvm_intel | grep nested\nparm:           nested:bool\n\n\n\u69cb\u7bc9\u624b\u9806\n\n1. Vagrant \u30d5\u30a1\u30a4\u30eb\u306e\u4f5c\u6210\n~$ cd working-dir\n~$ mkdir -p vagrant/devstack\n~$ cd vagrant/devstack\n~$ vagrant box add centos/7\n~$ vagrant init centos/7\n~$ vagrant box update\n~$ mv -iv Vagrantfile Vagrantfile.org\n\n~$ cat << EOF > Vagrantfile\nVagrant.configure(2) do |config|\n  config.vm.define :vm1 do |vm1|\n    vm1.vm.box = \"centos/7\"\n    vm1.vm.network :private_network, :ip => \"192.168.25.100\"\n    vm1.vm.provider :libvirt do |domain|\n      domain.memory = 4096\n      domain.cpus = 4\n      domain.nested = true\n      domain.machine_virtual_size = 100\n    end\n  end\nend\nEOF\n\n~$ cat Vagrantfile\nVagrant.configure(2) do |config|\n  config.vm.define :vm1 do |vm1|\n    vm1.vm.box = \"centos/7\"\n    vm1.vm.network :private_network, :ip => \"192.168.25.100\"\n    vm1.vm.provider :libvirt do |domain|\n      domain.memory = 4096\n      domain.cpus = 4\n      domain.nested = true\n      domain.machine_virtual_size = 100\n    end\n  end\nend\n\n\n2. Nested Host \u306e\u8d77\u52d5\u3068\u30ed\u30b0\u30a4\u30f3\u78ba\u8a8d\n~$ vagrant up\n~$ vagrant ssh\n\n[vagrant@localhost ~]$\n[vagrant@localhost ~]$ exit\n\n~$ vagrant halt\n~$ virsh list --all | grep devstack\n -     devstack_vm1                   shut off\n\n\n3. VM\u2019s libvirt XML \u306e\u7de8\u96c6\n~$ virsh edit devstack_vm1\n\n\nbefore\n  <cpu mode='host-model'>\n    <model fallback='allow'/>\n    <feature policy='optional' name='vmx'/>\n    <feature policy='optional' name='svm'/>\n  </cpu>\n\n\n\nafter\n  <cpu mode='host-passthrough'>\n  </cpu>\n\n\n~$ vagrant up\n~$ virsh list --all | grep devstack\n 4     devstack_vm1                   running\n\n\n4. Host OS \u306e root \u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u62e1\u5f35 (If needed)\n~$ vagrant ssh\n\n[vagrant@localhost ~]$ sudo su -\n[root@localhost ~]# fdisk /dev/vda\n(snip)\nCommand (m for help): n\nPartition type:\n   p   primary (3 primary, 0 extended, 1 free)\n   e   extended\nSelect (default e): p\nSelected partition 4\nFirst sector (83886080-209715199, default 83886080):\nLast sector, +sectors or +size{K,M,G} (83886080-209715199, default 209715199):\n(snip)\nCommand (m for help): t\nHex code (type L to list all codes): 8e\n(snip)\nCommand (m for help): w\n(snip)\n[root@localhost ~]# partprobe\n\n[root@localhost ~]# pvcreate /dev/vda4\n[root@localhost ~]# pvdisplay\n[root@localhost ~]# vgextend VolGroup00 /dev/vda4\n[root@localhost ~]# lvextend -l +100%FREE /dev/VolGroup00/LogVol00\n[root@localhost ~]# lvdisplay /dev/VolGroup00/LogVol00\n\n[root@localhost ~]# resize2fs /dev/mapper/VolGroup00-LogVol00\n[root@localhost ~]# df -h\n\n\n5. devstack \u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n5-1. install git\n[root@localhost ~]# yum -y update\n[root@localhost ~]# yum install -y git yum-utils\n\n\n5-2. install pip\n\nhttp://www.liquidweb.com/kb/how-to-install-pip-on-centos-7/\nhttp://dl.fedoraproject.org/pub/epel/7/x86_64/e/\n\n[root@localhost ~]# rpm -iUvh http://dl.fedoraproject.org/pub/epel/7/x86_64/e/epel-release-7-6.noarch.rpm\n[root@localhost ~]# yum -y update\n[root@localhost ~]# yum -y install python-pip\n[root@localhost ~]# pip -V\npip 7.1.0 from /usr/lib/python2.7/site-packages (python 2.7)\n\n[root@localhost ~]# pip install -U os-testr\n\n\n5-3. git clone\n[root@localhost ~]# useradd -d /opt/stack -m -s /bin/bash stack\n[root@localhost ~]# echo \"stack ALL=(ALL) NOPASSWD: ALL\" >> /etc/sudoers\n[root@localhost ~]# su - stack\n[stack@localhost ~]$ git clone -b stable/mitaka https://git.openstack.org/openstack-dev/devstack\n[stack@localhost ~]$ cd devstack/\n[stack@localhost devstack]$ git branch\n* stable/mitaka\n\n\n5-4. create localrc\n[stack@localhost devstack]$ cat << EOF > localrc\nHOST_IP=192.168.25.100\nDEST=/opt/stack\n\nADMIN_PASSWORD=secret\nDATABASE_PASSWORD=\\$ADMIN_PASSWORD\nRABBIT_PASSWORD=\\$ADMIN_PASSWORD\nSERVICE_PASSWORD=\\$ADMIN_PASSWORD\nEOF\n\n[stack@localhost devstack]$ cat localrc\nHOST_IP=192.168.25.100\nDEST=/opt/stack\n\nADMIN_PASSWORD=secret\nDATABASE_PASSWORD=$ADMIN_PASSWORD\nRABBIT_PASSWORD=$ADMIN_PASSWORD\nSERVICE_PASSWORD=$ADMIN_PASSWORD\n\n\n5-5. exec stack.sh\n[stack@localhost devstack]$ ./stack.sh\n(snip)\n========================\nDevStack Components Timed\n========================\n\nrun_process - 46 secs\npip_install - 715 secs\nrestart_apache_server - 8 secs\nwait_for_service - 16 secs\nyum_install - 475 secs\ngit_timed - 301 secs\n\n\n\nThis is your host IP address: 192.168.25.100\nThis is your host IPv6 address: ::1\nHorizon is now available at http://192.168.25.100/dashboard\nKeystone is serving at http://192.168.25.100:5000/\nThe default users are: admin and demo\nThe password: secret\n2016-05-16 18:44:42.087 | stack.sh completed in 2603 seconds.\n[stack@localhost devstack]$\n\n\n6. \u52d5\u4f5c\u78ba\u8a8d\n[stack@localhost devstack]$ source openrc admin admin\nWARNING: setting legacy OS_TENANT_NAME to support cli tools.\n[stack@localhost devstack]$ nova list\n+----+------+--------+------------+-------------+----------+\n| ID | Name | Status | Task State | Power State | Networks |\n+----+------+--------+------------+-------------+----------+\n+----+------+--------+------------+-------------+----------+\n[stack@localhost devstack]$\n\n# Install nested devstack(stable/mitaka) on KVM\n\n## \u672c\u66f8\u306e\u76ee\u7684\n\n* KVM \u30db\u30b9\u30c8\u4e0a\u306b\u30cd\u30b9\u30c8\u306e devstack \u74b0\u5883\u3092\u69cb\u7bc9\u3059\u308b\u305f\u3081\u306e\u5099\u5fd8\u9332\n* \u3068\u308a\u3042\u3048\u305a\u52d5\u304b\u3057\u306f\u3058\u3081\u308b\u3053\u3068\u3092\u76ee\u7684\u306b\u3057\u3066\u3044\u307e\u3059\n\n## \u30ea\u30d5\u30a1\u30ec\u30f3\u30b9\n\n* https://blog.davelindon.me/install-openstack-devstack-on-centos-7/\n* http://docs.openstack.org/developer/devstack/guides/devstack-with-nested-kvm.html\n* https://github.com/vagrant-libvirt/vagrant-libvirt\n\n## System \u69cb\u6210\n\n### KVM\n\n* Ubuntu 14.04.3 LTS\n* qemu-kvm 2.0.0\n* libvirt 1.2.2\n\n### Vagrant\n\n* Vagrant 1.8.1\n* vagrant-libvirt (0.0.32)\n\n### devstack\n\n* Mitaka\n* CentOS7 box\n  * 4GB memory\n  * 4 cpus\n  * 100G disk\n  * devstack \u30db\u30b9\u30c8\u306f ubuntu \u3067\u3082\u826f\u304b\u3063\u305f\u306e\u3067\u3059\u304c libvirt \u7248\u306e\u516c\u5f0f ubuntu box \u304c\u7121\u3044\u306e\u3067 CentOS7 \u306b\u3057\u3066\u3044\u307e\u3059\n\n## Check Host Requirements\n\n```shell-session\n~$ cat /sys/module/kvm_intel/parameters/nested\nY\n~$ modinfo kvm_intel | grep nested\nparm:           nested:bool\n```\n\n## \u69cb\u7bc9\u624b\u9806\n\n### 1. Vagrant \u30d5\u30a1\u30a4\u30eb\u306e\u4f5c\u6210\n\n```shell-session\n~$ cd working-dir\n~$ mkdir -p vagrant/devstack\n~$ cd vagrant/devstack\n~$ vagrant box add centos/7\n~$ vagrant init centos/7\n~$ vagrant box update\n~$ mv -iv Vagrantfile Vagrantfile.org\n```\n```shell-session\n~$ cat << EOF > Vagrantfile\nVagrant.configure(2) do |config|\n  config.vm.define :vm1 do |vm1|\n    vm1.vm.box = \"centos/7\"\n    vm1.vm.network :private_network, :ip => \"192.168.25.100\"\n    vm1.vm.provider :libvirt do |domain|\n      domain.memory = 4096\n      domain.cpus = 4\n      domain.nested = true\n      domain.machine_virtual_size = 100\n    end\n  end\nend\nEOF\n```\n```shell-session\n~$ cat Vagrantfile\nVagrant.configure(2) do |config|\n  config.vm.define :vm1 do |vm1|\n    vm1.vm.box = \"centos/7\"\n    vm1.vm.network :private_network, :ip => \"192.168.25.100\"\n    vm1.vm.provider :libvirt do |domain|\n      domain.memory = 4096\n      domain.cpus = 4\n      domain.nested = true\n      domain.machine_virtual_size = 100\n    end\n  end\nend\n```\n\n### 2. Nested Host \u306e\u8d77\u52d5\u3068\u30ed\u30b0\u30a4\u30f3\u78ba\u8a8d\n\n```shell-session\n~$ vagrant up\n~$ vagrant ssh\n\n[vagrant@localhost ~]$\n[vagrant@localhost ~]$ exit\n\n~$ vagrant halt\n~$ virsh list --all | grep devstack\n -     devstack_vm1                   shut off\n```\n\n### 3. VM\u2019s libvirt XML \u306e\u7de8\u96c6\n\n```shell-session\n~$ virsh edit devstack_vm1\n```\n```shell-session:before\n  <cpu mode='host-model'>\n    <model fallback='allow'/>\n    <feature policy='optional' name='vmx'/>\n    <feature policy='optional' name='svm'/>\n  </cpu>\n```\n```shell-session:after\n  <cpu mode='host-passthrough'>\n  </cpu>\n```\n```shell-session\n~$ vagrant up\n~$ virsh list --all | grep devstack\n 4     devstack_vm1                   running\n```\n\n### 4. Host OS \u306e root \u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u62e1\u5f35 (If needed)\n\n```shell-session\n~$ vagrant ssh\n\n[vagrant@localhost ~]$ sudo su -\n[root@localhost ~]# fdisk /dev/vda\n(snip)\nCommand (m for help): n\nPartition type:\n   p   primary (3 primary, 0 extended, 1 free)\n   e   extended\nSelect (default e): p\nSelected partition 4\nFirst sector (83886080-209715199, default 83886080):\nLast sector, +sectors or +size{K,M,G} (83886080-209715199, default 209715199):\n(snip)\nCommand (m for help): t\nHex code (type L to list all codes): 8e\n(snip)\nCommand (m for help): w\n(snip)\n[root@localhost ~]# partprobe\n\n[root@localhost ~]# pvcreate /dev/vda4\n[root@localhost ~]# pvdisplay\n[root@localhost ~]# vgextend VolGroup00 /dev/vda4\n[root@localhost ~]# lvextend -l +100%FREE /dev/VolGroup00/LogVol00\n[root@localhost ~]# lvdisplay /dev/VolGroup00/LogVol00\n\n[root@localhost ~]# resize2fs /dev/mapper/VolGroup00-LogVol00\n[root@localhost ~]# df -h\n```\n\n### 5. devstack \u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n#### 5-1. install git\n\n```shell-session\n[root@localhost ~]# yum -y update\n[root@localhost ~]# yum install -y git yum-utils\n```\n\n#### 5-2. install pip\n\n* http://www.liquidweb.com/kb/how-to-install-pip-on-centos-7/\n* http://dl.fedoraproject.org/pub/epel/7/x86_64/e/\n\n```shell-session\n[root@localhost ~]# rpm -iUvh http://dl.fedoraproject.org/pub/epel/7/x86_64/e/epel-release-7-6.noarch.rpm\n[root@localhost ~]# yum -y update\n[root@localhost ~]# yum -y install python-pip\n[root@localhost ~]# pip -V\npip 7.1.0 from /usr/lib/python2.7/site-packages (python 2.7)\n\n[root@localhost ~]# pip install -U os-testr\n```\n\n#### 5-3. git clone\n\n```shell-session\n[root@localhost ~]# useradd -d /opt/stack -m -s /bin/bash stack\n[root@localhost ~]# echo \"stack ALL=(ALL) NOPASSWD: ALL\" >> /etc/sudoers\n[root@localhost ~]# su - stack\n[stack@localhost ~]$ git clone -b stable/mitaka https://git.openstack.org/openstack-dev/devstack\n[stack@localhost ~]$ cd devstack/\n[stack@localhost devstack]$ git branch\n* stable/mitaka\n```\n\n#### 5-4. create localrc\n\n```shell-session\n[stack@localhost devstack]$ cat << EOF > localrc\nHOST_IP=192.168.25.100\nDEST=/opt/stack\n\nADMIN_PASSWORD=secret\nDATABASE_PASSWORD=\\$ADMIN_PASSWORD\nRABBIT_PASSWORD=\\$ADMIN_PASSWORD\nSERVICE_PASSWORD=\\$ADMIN_PASSWORD\nEOF\n```\n```shell-session\n[stack@localhost devstack]$ cat localrc\nHOST_IP=192.168.25.100\nDEST=/opt/stack\n\nADMIN_PASSWORD=secret\nDATABASE_PASSWORD=$ADMIN_PASSWORD\nRABBIT_PASSWORD=$ADMIN_PASSWORD\nSERVICE_PASSWORD=$ADMIN_PASSWORD\n```\n\n#### 5-5. exec stack.sh\n\n```shell-session\n[stack@localhost devstack]$ ./stack.sh\n(snip)\n========================\nDevStack Components Timed\n========================\n\nrun_process - 46 secs\npip_install - 715 secs\nrestart_apache_server - 8 secs\nwait_for_service - 16 secs\nyum_install - 475 secs\ngit_timed - 301 secs\n\n\n\nThis is your host IP address: 192.168.25.100\nThis is your host IPv6 address: ::1\nHorizon is now available at http://192.168.25.100/dashboard\nKeystone is serving at http://192.168.25.100:5000/\nThe default users are: admin and demo\nThe password: secret\n2016-05-16 18:44:42.087 | stack.sh completed in 2603 seconds.\n[stack@localhost devstack]$\n```\n\n### 6. \u52d5\u4f5c\u78ba\u8a8d\n\n```shell-session\n[stack@localhost devstack]$ source openrc admin admin\nWARNING: setting legacy OS_TENANT_NAME to support cli tools.\n[stack@localhost devstack]$ nova list\n+----+------+--------+------------+-------------+----------+\n| ID | Name | Status | Task State | Power State | Networks |\n+----+------+--------+------------+-------------+----------+\n+----+------+--------+------------+-------------+----------+\n[stack@localhost devstack]$\n```\n", "tags": ["devstack", "openstack", "KVM", "vagrant", "centos7"]}