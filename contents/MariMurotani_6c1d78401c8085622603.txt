{"context": "\u3053\u3061\u3089\u306e\u8a18\u4e8b\u3092\u53c2\u8003\u306bActionCable\u3067\u30b7\u30f3\u30d7\u30eb\u306bSocket\u901a\u4fe1\u3092\u5229\u7528\u3057\u3066\u30c1\u30e3\u30c3\u30c8\u304c\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u308b\u307e\u3067\u3092\u5b9f\u88c5\u3057\u305f\u3044\u3068\u601d\u3044\u307e\u3059\u3002\n\u3082\u3068\u3082\u3068\u3042\u3063\u305f\u4ed6\u306e\u30a2\u30d7\u30ea\u306b\u3082websocket\u3067\u901a\u4fe1\u3059\u308b\u30b9\u30af\u30ea\u30d7\u30c8\u304c\u5165\u3063\u3066\u3057\u307e\u3063\u3066\u3001\u8868\u793a\u306e\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u306b\u5f71\u97ff\u304c\u3042\u3063\u305f\u306e\u3067\u65e2\u5b58\u306b\u7d44\u307f\u8fbc\u307f\u3088\u308a\u3082\u3001\u65b0\u898f\u306b\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u3092\u4f5c\u6210\u3059\u308b\u4e8b\u3092\u304a\u3059\u3059\u3081\u3057\u307e\u3059\u3002\n\u5bfe\u8c61\u30b3\u30df\u30c3\u30c8\u306f\u3053\u3061\u3089\n\u81ea\u5206\u7528\u306e\u30e1\u30e2\u3067\u3082\u3042\u308b\u306e\u3067\u30b3\u30df\u30c3\u30c8\u4e00\u89a7\u3082\u306f\u308a\u307e\u3059\u3002\n\u5168\u4f53\u7684\u306a\u6d41\u308c\u306f\u3001\n\u30da\u30fc\u30b8\u3092\u8868\u793a\u2192\u30a6\u30a7\u30d6\u30bd\u30b1\u30c3\u30c8\u3067JS\u304b\u3089\u30b5\u30fc\u30d0\u30fc\u306b\u63a5\u7d9a\n\u2192\u30d6\u30e9\u30a6\u30b6\u304b\u3089\u30c7\u30fc\u30bf\u3092\u9001\u4fe1\n\u2192\u30b5\u30fc\u30d0\u30fc\u5074\u3067\u53d7\u3051\u53d6\u308aRedis\u306b\u683c\u7d0d\n\u2192\u683c\u7d0d\u3057\u305f\u30c7\u30fc\u30bf\u3092Broadcast\n\u2192\u30b5\u30a4\u30c9\u30d6\u30e9\u30a6\u30b6\u3067\u53d7\u3051\u53d6\u308a\u8868\u793a\u3059\u308b\n\n1. Redis\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3068\u8d77\u52d5\n\u3068\u308a\u3042\u3048\u305a\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3066\u8d77\u52d5\u3057\u3066\u304a\u304d\u307e\u3059\u3002\nwget http://download.redis.io/releases/redis-3.2.3.tar.gz\ntar -xzvf redis-3.2.3.tar.gz\ncd redis-3.2.3\nmake\nmake install\n/usr/local/bin/redis-server\n\n\n2.\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u30fc\u3001\u30e2\u30c7\u30eb\u3001\u30c1\u30e3\u30f3\u30cd\u30eb\u3092\u4f5c\u6210\n\u5168\u3066\u30b3\u30de\u30f3\u30c9\u30e9\u30a4\u30f3\u3067\u4f5c\u6210\u3057\u307e\u3059\u3002\n1) \u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u30fc\n\nrails g controller rooms show\n\n2) \u30e2\u30c7\u30eb\n\nrails g model message content:text\nrails db:migrate\n\n3) \u30c1\u30e3\u30f3\u30cd\u30eb\n\nrails g channel room speak\n\n\n3. .rb\u306e\u7de8\u96c6\n\u3053\u3061\u3089\u306fActionCable\u3067Subscribe\u3059\u308b\u30c1\u30e3\u30f3\u30cd\u30eb\u306e\u30b3\u30fc\u30c9\u3067\u3059\u3002\n\napp/channels/room_channel.rb\n class RoomChannel < ApplicationCable::Channel\n   def subscribed\n     stream_from \"room_channel\"\n   end\n\n   def unsubscribed\n     # Any cleanup needed when channel is unsubscribed\n   end\n\n   def speak(data)\n     Message.create! content: data['message']\n     ActionCable.server.broadcast 'room_channel', message: data['message']\n   end\n end\n\n\n\u3053\u3061\u3089\u306f\u901a\u5e38\u306e\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u30fc\u3067\u30e2\u30c7\u30eb\u304b\u3089\u30c7\u30fc\u30bf\u3092\u53d6\u308a\u51fa\u3057\u3066\u8868\u793a\u3057\u3066\u3044\u308b\u3060\u3051\u3067\u3059\u3002\n\napp/controllers/rooms_controller.rb\nclass RoomsController < ApplicationController\n   def show\n       @messages = Message.all\n   end\n end\n\n\n\u30eb\u30fc\u30bf\u30fc\u306e\u8a2d\u5b9a\u3067\u3059\u3002mount ActionCable.server => '/cable'\u3068\u3044\u3046\u306e\u304c\u30dd\u30a4\u30f3\u30c8\u3067\u3001\u4eca\u5f8cws://192.168.10.5:28080/cable\u3068\u3044\u3046\u30a8\u30f3\u30c9\u30dd\u30a4\u30f3\u30c8\u306b\u5411\u304b\u3063\u3066JS\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u304c\u63a5\u7d9a\u3057\u307e\u3059\u3002\n\nconfig/routes.rb\nRails.application.routes.draw do\n   get 'rooms/show'\n\n   # mount /cable as ActionCable consumer endpoint\n   mount ActionCable.server => '/cable'\n  end\n\n\n\u4e0b\u8a18\u306e\u8a2d\u5b9a\u306fVirtualBox\u306b\u7acb\u3066\u305f\u30ed\u30fc\u30ab\u30eb\u30b5\u30fc\u30d0\u30fc\u3067\u52d5\u304b\u3057\u3066\u3044\u308b\u306e\u3067\u5fc5\u8981\u3067\u3057\u305f\u3002\n\nconfig/environments/development.rb\n# allow from all to websocket\nActionCable.server.config.disable_request_forgery_protection = true\n\n# allow form only internal network\nconfig.web_console.whitelisted_ips = '192.168.0.10/26'\n\n\n\n4. JavaScript\u306e\u4f5c\u6210\n\napp/assets/javascripts/cable.js\n //\n //= require action_cable\n //= require_self\n //= require_tree ./channels\n\n (function() {\n   this.App || (this.App = {});\n\n\n\napp/assets/javascripts/channels/room.js\n(function() {\n   App.room = App.cable.subscriptions.create(\"RoomChannel\", {\n     connected: function() {\n       return console.log('connected------');\n     },\n     disconnected: function() {\n       return console.log('disconnectd------');\n     },\n     received: function(data) {\n       alert('message!');\n       $('#messages').append(data['message']);\n       return console.log('received------');\n     },\n     speak: function(data) {\n       this.perform('speak',{message: data});\n     }\n   });\n\n }).call(this);\n\n //  start after document is ready\n $(document).ready(function(){\n     $(\"input\").keypress(function(event){\n       if ( event.which == 13 ) {\n          event.preventDefault();\n          App.room.speak(event.target.value);\n       }\n     });\n });\n\n\n\n5. HTML\u306e\u4f5c\u6210\n\napp/views/messages/_message.html.erb\n<div class=\"message\">\n   <p><%= message.content %></p>\n</div>\n\n\n\napp/views/rooms/show.html.erb\n<h1>Chat room</h1>\n\n <div id=\"messages\">\n   <%= render @messages %>\n </div>\n\n <form>\n   <label>Say something:</label><br>\n   <input type=\"text\" data-behavior=\"room_speaker\" style=\"background-color:silver\">\n </form>\n\n\n\n6. \u8d77\u52d5\n\u4e0a\u8a18\u306e\u30b3\u30fc\u30c9\u306fRailsServer\u3067\u52d5\u304f\u8a2d\u5b9a\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002\n192.168.10.5\u3067VirtualMachine\u3092\u52d5\u304b\u3057\u3066\u3044\u308b\u306e\u3067\u4e0b\u8a18\u306e\u30b3\u30de\u30f3\u30c9\u3067\u52d5\u304b\u3057\u307e\u3059\u3002\n\nrails server -b 192.168.10.5\n\n[\u3053\u3061\u3089](http://qiita.com/jnchito/items/aec75fab42804287d71b)\u306e\u8a18\u4e8b\u3092\u53c2\u8003\u306bActionCable\u3067\u30b7\u30f3\u30d7\u30eb\u306bSocket\u901a\u4fe1\u3092\u5229\u7528\u3057\u3066\u30c1\u30e3\u30c3\u30c8\u304c\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u308b\u307e\u3067\u3092\u5b9f\u88c5\u3057\u305f\u3044\u3068\u601d\u3044\u307e\u3059\u3002\n\u3082\u3068\u3082\u3068\u3042\u3063\u305f\u4ed6\u306e\u30a2\u30d7\u30ea\u306b\u3082websocket\u3067\u901a\u4fe1\u3059\u308b\u30b9\u30af\u30ea\u30d7\u30c8\u304c\u5165\u3063\u3066\u3057\u307e\u3063\u3066\u3001\u8868\u793a\u306e\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u306b\u5f71\u97ff\u304c\u3042\u3063\u305f\u306e\u3067\u65e2\u5b58\u306b\u7d44\u307f\u8fbc\u307f\u3088\u308a\u3082\u3001\u65b0\u898f\u306b\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u3092\u4f5c\u6210\u3059\u308b\u4e8b\u3092\u304a\u3059\u3059\u3081\u3057\u307e\u3059\u3002\n\n\u5bfe\u8c61\u30b3\u30df\u30c3\u30c8\u306f[\u3053\u3061\u3089](https://github.com/MariMurotani/my1stRails/commit/c0b554d11802024891c11ce51f2e9af5a9c1bd10)\n\u81ea\u5206\u7528\u306e\u30e1\u30e2\u3067\u3082\u3042\u308b\u306e\u3067[\u30b3\u30df\u30c3\u30c8\u4e00\u89a7](https://github.com/MariMurotani/my1stRails/pull/7)\u3082\u306f\u308a\u307e\u3059\u3002\n\n\n\u5168\u4f53\u7684\u306a\u6d41\u308c\u306f\u3001\n\u30da\u30fc\u30b8\u3092\u8868\u793a\u2192\u30a6\u30a7\u30d6\u30bd\u30b1\u30c3\u30c8\u3067JS\u304b\u3089\u30b5\u30fc\u30d0\u30fc\u306b\u63a5\u7d9a\n\u2192\u30d6\u30e9\u30a6\u30b6\u304b\u3089\u30c7\u30fc\u30bf\u3092\u9001\u4fe1\n\u2192\u30b5\u30fc\u30d0\u30fc\u5074\u3067\u53d7\u3051\u53d6\u308aRedis\u306b\u683c\u7d0d\n\u2192\u683c\u7d0d\u3057\u305f\u30c7\u30fc\u30bf\u3092Broadcast\n\u2192\u30b5\u30a4\u30c9\u30d6\u30e9\u30a6\u30b6\u3067\u53d7\u3051\u53d6\u308a\u8868\u793a\u3059\u308b\n\n#1. Redis\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3068\u8d77\u52d5\n\u3068\u308a\u3042\u3048\u305a\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3066\u8d77\u52d5\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\n```\nwget http://download.redis.io/releases/redis-3.2.3.tar.gz\ntar -xzvf redis-3.2.3.tar.gz\ncd redis-3.2.3\nmake\nmake install\n/usr/local/bin/redis-server\n```\n\n#2.\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u30fc\u3001\u30e2\u30c7\u30eb\u3001\u30c1\u30e3\u30f3\u30cd\u30eb\u3092\u4f5c\u6210\n\u5168\u3066\u30b3\u30de\u30f3\u30c9\u30e9\u30a4\u30f3\u3067\u4f5c\u6210\u3057\u307e\u3059\u3002\n1) \u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u30fc\n>rails g controller rooms show\n\n2) \u30e2\u30c7\u30eb\n>rails g model message content:text\n>rails db:migrate\n\n3) \u30c1\u30e3\u30f3\u30cd\u30eb\n>rails g channel room speak\n\n#3. .rb\u306e\u7de8\u96c6\n\u3053\u3061\u3089\u306fActionCable\u3067Subscribe\u3059\u308b\u30c1\u30e3\u30f3\u30cd\u30eb\u306e\u30b3\u30fc\u30c9\u3067\u3059\u3002\n\n```app/channels/room_channel.rb\n class RoomChannel < ApplicationCable::Channel\n   def subscribed\n     stream_from \"room_channel\"\n   end\n \n   def unsubscribed\n     # Any cleanup needed when channel is unsubscribed\n   end\n \n   def speak(data)\n     Message.create! content: data['message']\n     ActionCable.server.broadcast 'room_channel', message: data['message']\n   end\n end\n```\n\n\u3053\u3061\u3089\u306f\u901a\u5e38\u306e\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u30fc\u3067\u30e2\u30c7\u30eb\u304b\u3089\u30c7\u30fc\u30bf\u3092\u53d6\u308a\u51fa\u3057\u3066\u8868\u793a\u3057\u3066\u3044\u308b\u3060\u3051\u3067\u3059\u3002\n\n```rb:app/controllers/rooms_controller.rb\nclass RoomsController < ApplicationController\n   def show\n       @messages = Message.all\n   end\n end\n```\n\n\u30eb\u30fc\u30bf\u30fc\u306e\u8a2d\u5b9a\u3067\u3059\u3002mount ActionCable.server => '/cable'\u3068\u3044\u3046\u306e\u304c\u30dd\u30a4\u30f3\u30c8\u3067\u3001\u4eca\u5f8cws://192.168.10.5:28080/cable\u3068\u3044\u3046\u30a8\u30f3\u30c9\u30dd\u30a4\u30f3\u30c8\u306b\u5411\u304b\u3063\u3066JS\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u304c\u63a5\u7d9a\u3057\u307e\u3059\u3002\n\n```rb:config/routes.rb\nRails.application.routes.draw do\n   get 'rooms/show'\n \n   # mount /cable as ActionCable consumer endpoint\n   mount ActionCable.server => '/cable'\n  end\n```\n\n\u4e0b\u8a18\u306e\u8a2d\u5b9a\u306fVirtualBox\u306b\u7acb\u3066\u305f\u30ed\u30fc\u30ab\u30eb\u30b5\u30fc\u30d0\u30fc\u3067\u52d5\u304b\u3057\u3066\u3044\u308b\u306e\u3067\u5fc5\u8981\u3067\u3057\u305f\u3002\n\n```rb:config/environments/development.rb\n# allow from all to websocket\nActionCable.server.config.disable_request_forgery_protection = true\n \n# allow form only internal network\nconfig.web_console.whitelisted_ips = '192.168.0.10/26'\n```\n\n#4. JavaScript\u306e\u4f5c\u6210\n\n```js:app/assets/javascripts/cable.js\n //\n //= require action_cable\n //= require_self\n //= require_tree ./channels\n  \n (function() {\n   this.App || (this.App = {});\n```\n\n```js:app/assets/javascripts/channels/room.js\n(function() {\n   App.room = App.cable.subscriptions.create(\"RoomChannel\", {\n     connected: function() {\n       return console.log('connected------');\n     },\n     disconnected: function() {\n       return console.log('disconnectd------');\n     },\n     received: function(data) {\n       alert('message!');\n       $('#messages').append(data['message']);\n       return console.log('received------');\n     },\n     speak: function(data) {\n       this.perform('speak',{message: data});\n     }\n   });\n \n }).call(this);\n \n //  start after document is ready\n $(document).ready(function(){\n     $(\"input\").keypress(function(event){\n       if ( event.which == 13 ) {\n          event.preventDefault();\n          App.room.speak(event.target.value);\n       }\n     });\n });\n```\n\n#5. HTML\u306e\u4f5c\u6210\n```html:app/views/messages/_message.html.erb\n<div class=\"message\">\n   <p><%= message.content %></p>\n</div>\n```\n\n```html:app/views/rooms/show.html.erb\n<h1>Chat room</h1>\n \n <div id=\"messages\">\n   <%= render @messages %>\n </div>\n \n <form>\n   <label>Say something:</label><br>\n   <input type=\"text\" data-behavior=\"room_speaker\" style=\"background-color:silver\">\n </form>\n```\n\n#6. \u8d77\u52d5\n\u4e0a\u8a18\u306e\u30b3\u30fc\u30c9\u306fRailsServer\u3067\u52d5\u304f\u8a2d\u5b9a\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002\n192.168.10.5\u3067VirtualMachine\u3092\u52d5\u304b\u3057\u3066\u3044\u308b\u306e\u3067\u4e0b\u8a18\u306e\u30b3\u30de\u30f3\u30c9\u3067\u52d5\u304b\u3057\u307e\u3059\u3002\n>rails server -b 192.168.10.5\n", "tags": ["Ruby", "RubyOnRails", "websocket"]}