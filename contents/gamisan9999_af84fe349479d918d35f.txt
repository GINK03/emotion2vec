{"context": " More than 1 year has passed since last update.\u4ffa\u3067\u3059\u3002\nMHA\u3092EC2\u3067\u7a3c\u50cd\u3055\u305b\u308b\u306b\u3042\u305f\u308a\u3001Failover\u30b9\u30af\u30ea\u30d7\u30c8\u3092Go\u3067\u66f8\u304d\u307e\u3057\u305f\u3002\nkusocommit\u3068kusource\u3067\u3059\u304c\u3053\u3053\u306b\u3042\u3052\u3068\u304d\u307e\u3057\u305f\u3002\nmysqlfailgover\nMySQL Master\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306eVIP\u3092\u30eb\u30fc\u30c6\u30a3\u30f3\u30b0\u3059\u308bRouteTable\u3092\u66f8\u304d\u63db\u3048\u308b\u30b9\u30af\u30ea\u30d7\u30c8\u3067\u3059\u3002\n\u3068\u308a\u3042\u3048\u305aMySQL Master\u306emysqld\u30c0\u30a6\u30f3\u6642\u306bRouteTable\u306e\u8a2d\u5b9a\u304c\u65b0Master\u3078\u5909\u308f\u308b\u3053\u3068\u304c\u78ba\u8a8d\u3067\u304d\u307e\u3057\u305f\u3002\n\u4f7f\u3044\u65b9\u306e\u8a73\u7d30\u306f\u5f8c\u3067\u66f8\u304d\u307e\u3059\u3002\n\u5f15\u6570\u5224\u5b9a\u306bcli.go\u3092\u4f7f\u3044\u307e\u3057\u305f\u304c\u3001\nMHA on EC2\u3067\u306f\u672a\u4f7f\u7528\u306e\u5f15\u6570\u3082\u66f8\u3044\u3068\u304b\u306a\u3044\u3068\u884c\u3051\u306a\u3044\u306e\u304c\u3081\u3093\u3069\u3044(\u672a\u5b9a\u7fa9\u306e\u5f15\u6570\u3092\u7121\u8996\u3059\u308b\u65b9\u6cd5\u3063\u3066\u3042\u308b\u306e\u304b\u306a\u30fc)\n\nbuild\u65b9\u6cd5(\u5f8c\u3067\u66f8\u304f)\ngo get\u3068\u304b\u3067\u3082\u3067\u304d\u308b\u304b\u306a...\ngox\u3067\u30d3\u30eb\u30c9\u3057\u3066\u5b8c\u6210\u3057\u305f\u30d0\u30a4\u30ca\u30ea\u3092MHA\u30de\u30cd\u30fc\u30b8\u30e3\u30ce\u30fc\u30c9\u3078\u30dd\u30a4\u30fc\u3059\u308b\u3060\u3051\u3067\u3059\u3002\ngox\u3059\u3054\u304f\u4fbf\u5229\u3067\u3059\u306d\u30fc\u3002\n$ cd $GOPATH/src\n$ git clone https://github.com/gamisan9999/mysqlfailgover.git\n$ glide in\n$ gox --os=linux\n\n\nmha\u5b9f\u884c\u4f8b\n\n\u6b63\u5e38\u6642\n\n[root@ip-172-16-3-23 ~]# masterha_manager --conf=/etc/mha.conf\n[root@ip-172-16-3-23 ~]# masterha_manager --conf=/etc/mha.conf\nSat Jan  2 13:32:24 2016 - [warning] Global configuration file /etc/masterha_default.cnf not found. Skipping.\nSat Jan  2 13:32:24 2016 - [info] Reading application default configuration from /etc/mha.conf..\nSat Jan  2 13:32:24 2016 - [info] Reading server configuration from /etc/mha.conf..\nSat Jan  2 13:32:24 2016 - [info] MHA::MasterMonitor version 0.56.\nSat Jan  2 13:32:25 2016 - [info] GTID failover mode = 1\nSat Jan  2 13:32:25 2016 - [info] Dead Servers:\nSat Jan  2 13:32:25 2016 - [info] Alive Servers:\nSat Jan  2 13:32:25 2016 - [info]   172.16.3.207(172.16.3.207:3306)\nSat Jan  2 13:32:25 2016 - [info]   172.16.2.4(172.16.2.4:3306)\nSat Jan  2 13:32:25 2016 - [info]   172.16.3.99(172.16.3.99:3306)\nSat Jan  2 13:32:25 2016 - [info] Alive Slaves:\nSat Jan  2 13:32:25 2016 - [info]   172.16.3.207(172.16.3.207:3306)  Version=5.6.27-log (oldest major version between slaves) log-bin:enabled\nSat Jan  2 13:32:25 2016 - [info]     GTID ON\nSat Jan  2 13:32:25 2016 - [info]     Replicating from 172.16.2.4(172.16.2.4:3306)\nSat Jan  2 13:32:25 2016 - [info]   172.16.3.99(172.16.3.99:3306)  Version=5.6.27-log (oldest major version between slaves) log-bin:enabled\nSat Jan  2 13:32:25 2016 - [info]     GTID ON\nSat Jan  2 13:32:25 2016 - [info]     Replicating from 172.16.2.4(172.16.2.4:3306)\nSat Jan  2 13:32:25 2016 - [info] Current Alive Master: 172.16.2.4(172.16.2.4:3306)\nSat Jan  2 13:32:25 2016 - [info] Checking slave configurations..\nSat Jan  2 13:32:25 2016 - [info]  read_only=1 is not set on slave 172.16.3.207(172.16.3.207:3306).\nSat Jan  2 13:32:25 2016 - [info]  read_only=1 is not set on slave 172.16.3.99(172.16.3.99:3306).\n..\u7701\u7565..\nSat Jan  2 13:32:25 2016 - [info] HealthCheck: SSH to 172.16.2.4 is reachable.\nSat Jan  2 13:32:25 2016 - [info]\n172.16.2.4(172.16.2.4:3306) (current master)\n +--172.16.3.207(172.16.3.207:3306)\n +--172.16.3.99(172.16.3.99:3306)\n\nSat Jan  2 13:32:25 2016 - [info] Checking master_ip_failover_script status:\nSat Jan  2 13:32:25 2016 - [info]   /root/mysqlfailgover --mysql_master_vip=192.168.0.10/32 --command=status --ssh_user=root --orig_master_host=172.16.2.4 --orig_master_ip=172.16.2.4 --orig_master_port=3306\n8\norig_master_ip registration route table id:  rtb-764d3b13\nSat Jan  2 13:32:26 2016 - [info]  OK.\nSat Jan  2 13:32:26 2016 - [warning] shutdown_script is not defined.\nSat Jan  2 13:32:26 2016 - [info] Set master ping interval 3 seconds.\nSat Jan  2 13:32:26 2016 - [warning] secondary_check_script is not defined. It is highly recommended setting it to check master reachability from two or more routes.\nSat Jan  2 13:32:26 2016 - [info] Starting ping health check on 172.16.2.4(172.16.2.4:3306)..\nSat Jan  2 13:32:26 2016 - [info] Ping(SELECT) succeeded, waiting until MySQL doesn't respond..\n\n\nMaster\u306emysqld\u505c\u6b62\u6642\n\nSat Jan  2 13:32:50 2016 - [warning] Got error on MySQL select ping: 2013 (Lost connection to MySQL server during query)\nSat Jan  2 13:32:50 2016 - [info] Executing SSH check script: exit 0\nSat Jan  2 13:32:50 2016 - [info] HealthCheck: SSH to 172.16.2.4 is reachable.\nSat Jan  2 13:32:53 2016 - [warning] Got error on MySQL connect: 2003 (Can't connect to MySQL server on '172.16.2.4' (111))\nSat Jan  2 13:32:53 2016 - [warning] Connection failed 2 time(s)..\nSat Jan  2 13:32:56 2016 - [warning] Got error on MySQL connect: 2003 (Can't connect to MySQL server on '172.16.2.4' (111))\nSat Jan  2 13:32:56 2016 - [warning] Connection failed 3 time(s)..\nSat Jan  2 13:32:59 2016 - [warning] Got error on MySQL connect: 2003 (Can't connect to MySQL server on '172.16.2.4' (111))\nSat Jan  2 13:32:59 2016 - [warning] Connection failed 4 time(s)..\nSat Jan  2 13:32:59 2016 - [warning] Master is not reachable from health checker!\nSat Jan  2 13:32:59 2016 - [warning] Master 172.16.2.4(172.16.2.4:3306) is not reachable!\nSat Jan  2 13:32:59 2016 - [warning] SSH is reachable.\nSat Jan  2 13:32:59 2016 - [info] Connecting to a master server failed. Reading configuration file /etc/masterha_default.cnf and /etc/mha.conf again, and trying to connect to all servers to check server status..\nSat Jan  2 13:32:59 2016 - [warning] Global configuration file /etc/masterha_default.cnf not found. Skipping.\nSat Jan  2 13:32:59 2016 - [info] Reading application default configuration from /etc/mha.conf..\nSat Jan  2 13:32:59 2016 - [info] Reading server configuration from /etc/mha.conf..\nSat Jan  2 13:33:00 2016 - [info] GTID failover mode = 1\nSat Jan  2 13:33:00 2016 - [info] Dead Servers:\nSat Jan  2 13:33:00 2016 - [info]   172.16.2.4(172.16.2.4:3306)\nSat Jan  2 13:33:00 2016 - [info] Alive Servers:\nSat Jan  2 13:33:00 2016 - [info]   172.16.3.207(172.16.3.207:3306)\nSat Jan  2 13:33:00 2016 - [info]   172.16.3.99(172.16.3.99:3306)\nSat Jan  2 13:33:00 2016 - [info] Alive Slaves:\nSat Jan  2 13:33:00 2016 - [info]   172.16.3.207(172.16.3.207:3306)  Version=5.6.27-log (oldest major version between slaves) log-bin:enabled\nSat Jan  2 13:33:01 2016 - [info] Executing master IP deactivation script:\nSat Jan  2 13:33:01 2016 - [info]   /root/mysqlfailgover --mysql_master_vip=192.168.0.10/32 --orig_master_host=172.16.2.4 --orig_master_ip=172.16.2.4 --orig_master_port=3306 --command=stopssh --ssh_user=root\n8\n\u203bstopssh\u306f\u4f55\u3082\u5b9f\u884c\u3057\u306a\u3044\nSat Jan  2 13:33:01 2016 - [info]  done.\nSat Jan  2 13:33:01 2016 - [warning] shutdown_script is not set. Skipping explicit shutting down of the dead master.\nSat Jan  2 13:33:02 2016 - [info] * Phase 2: Dead Master Shutdown Phase completed.\nSat Jan  2 13:33:02 2016 - [info] * Phase 3.3: New Master Recovery Phase..\nSat Jan  2 13:33:02 2016 - [info]\nSat Jan  2 13:33:02 2016 - [info]  Waiting all logs to be applied..\nSat Jan  2 13:33:02 2016 - [info]   done.\nSat Jan  2 13:33:02 2016 - [info] Getting new master's binlog name and position..\nSat Jan  2 13:33:02 2016 - [info]  mysqld-bin.000014:489\nSat Jan  2 13:33:02 2016 - [info]  All other slaves should start replication from here. Statement should be: CHANGE MASTER TO MASTER_HOST='172.16.3.207', MASTER_PORT=3306, MASTER_AUTO_POSITION=1, MASTER_USER='repl', MASTER_PASSWORD='xx\nx';\nSat Jan  2 13:33:02 2016 - [info] Master Recovery succeeded. File:Pos:Exec_Gtid_Set: mysqld-bin.000014, 489, 8c410b0f-b114-11e5-903c-0a9edda6c5c3:12,\ndee4e0d2-a3d2-11e5-b9ca-0a9edda6c5c3:1-5,\ndee52e9c-a3d2-11e5-b9ca-0ae712148d43:1-3\nSat Jan  2 13:33:02 2016 - [info] Executing master IP activate script:\n\u203b\u30d5\u30a7\u30fc\u30ba3\u306efailover start\u6642\u306bMaster\u7528EC2\u306eRouteTable\u304c\u66f8\u304d\u63db\u308f\u308b\nSat Jan  2 13:33:02 2016 - [info]   /root/mysqlfailgover --mysql_master_vip=192.168.0.10/32 --command=start --ssh_user=root --orig_master_host=172.16.2.4 --orig_master_ip=172.16.2.4 --orig_master_port=3306 --new_master_host=172.16.3.20\n7 --new_master_ip=172.16.3.207 --new_master_port=3306 --new_master_user='mha' --new_master_password='mhapassword'\n13\nmysql master vip: 192.168.0.10/32\nmaster_host: 172.16.2.4\nmaster_host_ip:\n172.16.2.4 = i-3072a3bf\n172.16.3.207 = i-a574a52a\norig_master_ip registration route table id:  rtb-764d3b13\nroute table id rtb-764d3b13 ,replace destination instance  i-3072a3bf to i-a574a52a\nroute table, rtb-764d3b13 replaced.\nSat Jan  2 13:33:02 2016 - [info]  OK.\nSat Jan  2 13:33:02 2016 - [info] ** Finished master recovery successfully.\nSat Jan  2 13:33:02 2016 - [info] * Phase 3: Master Recovery Phase completed.\n..\u7701\u7565..\n\n\n\u5207\u308a\u66ff\u308f\u308a\u524d\u5f8c\u306emysql master host\n\nMHA Manager\u304b\u3089\u63a5\u7d9a\u78ba\u8a8d\u3057\u307e\u3057\u305f\n\u203b\u5207\u66ff\u524d\n[ec2-user@ip-172-16-3-23 ~]$ mysql -u root -h 192.168.0.10 -e \"show variables like 'hostname'\"\n+---------------+---------------+\n| Variable_name | Value         |\n+---------------+---------------+\n| hostname      | ip-172-16-2-4 |\n+---------------+---------------+\n\u203b\u3053\u3053\u3067\u30d5\u30a7\u30a4\u30eb\u30aa\u30fc\u30d0\u30fc\u304c\u767a\u751f\u3057\u3066172.16.2.4->172.16.3.207\u3078Master\u304c\u5207\u308a\u66ff\u308f\u308b\n[ec2-user@ip-172-16-3-23 ~]$ mysql -u root -h 192.168.0.10 -e \"show slave status\\G\"\n[ec2-user@ip-172-16-3-23 ~]$ mysql -u root -h 192.168.0.10 -e \"show variables like 'hostname'\"\n+---------------+-----------------+\n| Variable_name | Value           |\n+---------------+-----------------+\n| hostname      | ip-172-16-3-207 |\n+---------------+-----------------+\n\n\nmha.conf\n\u5b9a\u7fa9\u4f8b\n\n/etc/mha.conf\n\n[server default]\nuser=mha\npassword=mhapassword\nmanager_workdir=/var/lib/mha\nremote_workdir=/var/lib/mha\nrepl_user=repl\nrepl_password=repl\nssh_user=root\nmaster_ip_failover_script=\"/root/mysqlfailgover --mysql_master_vip=192.168.0.10/32\"\n\n\n[server1]\nhostname=172.16.3.207\n[server2]\nhostname=172.16.2.4\n[server3]\nhostname=172.16.3.99\n\n\n\u4ffa\u3067\u3059\u3002\nMHA\u3092EC2\u3067\u7a3c\u50cd\u3055\u305b\u308b\u306b\u3042\u305f\u308a\u3001Failover\u30b9\u30af\u30ea\u30d7\u30c8\u3092Go\u3067\u66f8\u304d\u307e\u3057\u305f\u3002\n\nkusocommit\u3068kusource\u3067\u3059\u304c\u3053\u3053\u306b\u3042\u3052\u3068\u304d\u307e\u3057\u305f\u3002\n\n[mysqlfailgover](https://github.com/gamisan9999/mysqlfailgover)\n\nMySQL Master\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306eVIP\u3092\u30eb\u30fc\u30c6\u30a3\u30f3\u30b0\u3059\u308bRouteTable\u3092\u66f8\u304d\u63db\u3048\u308b\u30b9\u30af\u30ea\u30d7\u30c8\u3067\u3059\u3002\n\n\u3068\u308a\u3042\u3048\u305aMySQL Master\u306emysqld\u30c0\u30a6\u30f3\u6642\u306bRouteTable\u306e\u8a2d\u5b9a\u304c\u65b0Master\u3078\u5909\u308f\u308b\u3053\u3068\u304c\u78ba\u8a8d\u3067\u304d\u307e\u3057\u305f\u3002\n\n\u4f7f\u3044\u65b9\u306e\u8a73\u7d30\u306f\u5f8c\u3067\u66f8\u304d\u307e\u3059\u3002\n\n\u5f15\u6570\u5224\u5b9a\u306bcli.go\u3092\u4f7f\u3044\u307e\u3057\u305f\u304c\u3001\nMHA on EC2\u3067\u306f\u672a\u4f7f\u7528\u306e\u5f15\u6570\u3082\u66f8\u3044\u3068\u304b\u306a\u3044\u3068\u884c\u3051\u306a\u3044\u306e\u304c\u3081\u3093\u3069\u3044(\u672a\u5b9a\u7fa9\u306e\u5f15\u6570\u3092\u7121\u8996\u3059\u308b\u65b9\u6cd5\u3063\u3066\u3042\u308b\u306e\u304b\u306a\u30fc)\n\n# build\u65b9\u6cd5(\u5f8c\u3067\u66f8\u304f)\n\ngo get\u3068\u304b\u3067\u3082\u3067\u304d\u308b\u304b\u306a...\n\ngox\u3067\u30d3\u30eb\u30c9\u3057\u3066\u5b8c\u6210\u3057\u305f\u30d0\u30a4\u30ca\u30ea\u3092MHA\u30de\u30cd\u30fc\u30b8\u30e3\u30ce\u30fc\u30c9\u3078\u30dd\u30a4\u30fc\u3059\u308b\u3060\u3051\u3067\u3059\u3002\n\ngox\u3059\u3054\u304f\u4fbf\u5229\u3067\u3059\u306d\u30fc\u3002\n\n```\n$ cd $GOPATH/src\n$ git clone https://github.com/gamisan9999/mysqlfailgover.git\n$ glide in\n$ gox --os=linux\n```\n\n# mha\u5b9f\u884c\u4f8b\n\n- \u6b63\u5e38\u6642\n\n```\n[root@ip-172-16-3-23 ~]# masterha_manager --conf=/etc/mha.conf\n[root@ip-172-16-3-23 ~]# masterha_manager --conf=/etc/mha.conf\nSat Jan  2 13:32:24 2016 - [warning] Global configuration file /etc/masterha_default.cnf not found. Skipping.\nSat Jan  2 13:32:24 2016 - [info] Reading application default configuration from /etc/mha.conf..\nSat Jan  2 13:32:24 2016 - [info] Reading server configuration from /etc/mha.conf..\nSat Jan  2 13:32:24 2016 - [info] MHA::MasterMonitor version 0.56.\nSat Jan  2 13:32:25 2016 - [info] GTID failover mode = 1\nSat Jan  2 13:32:25 2016 - [info] Dead Servers:\nSat Jan  2 13:32:25 2016 - [info] Alive Servers:\nSat Jan  2 13:32:25 2016 - [info]   172.16.3.207(172.16.3.207:3306)\nSat Jan  2 13:32:25 2016 - [info]   172.16.2.4(172.16.2.4:3306)\nSat Jan  2 13:32:25 2016 - [info]   172.16.3.99(172.16.3.99:3306)\nSat Jan  2 13:32:25 2016 - [info] Alive Slaves:\nSat Jan  2 13:32:25 2016 - [info]   172.16.3.207(172.16.3.207:3306)  Version=5.6.27-log (oldest major version between slaves) log-bin:enabled\nSat Jan  2 13:32:25 2016 - [info]     GTID ON\nSat Jan  2 13:32:25 2016 - [info]     Replicating from 172.16.2.4(172.16.2.4:3306)\nSat Jan  2 13:32:25 2016 - [info]   172.16.3.99(172.16.3.99:3306)  Version=5.6.27-log (oldest major version between slaves) log-bin:enabled\nSat Jan  2 13:32:25 2016 - [info]     GTID ON\nSat Jan  2 13:32:25 2016 - [info]     Replicating from 172.16.2.4(172.16.2.4:3306)\nSat Jan  2 13:32:25 2016 - [info] Current Alive Master: 172.16.2.4(172.16.2.4:3306)\nSat Jan  2 13:32:25 2016 - [info] Checking slave configurations..\nSat Jan  2 13:32:25 2016 - [info]  read_only=1 is not set on slave 172.16.3.207(172.16.3.207:3306).\nSat Jan  2 13:32:25 2016 - [info]  read_only=1 is not set on slave 172.16.3.99(172.16.3.99:3306).\n..\u7701\u7565..\nSat Jan  2 13:32:25 2016 - [info] HealthCheck: SSH to 172.16.2.4 is reachable.\nSat Jan  2 13:32:25 2016 - [info]\n172.16.2.4(172.16.2.4:3306) (current master)\n +--172.16.3.207(172.16.3.207:3306)\n +--172.16.3.99(172.16.3.99:3306)\n\nSat Jan  2 13:32:25 2016 - [info] Checking master_ip_failover_script status:\nSat Jan  2 13:32:25 2016 - [info]   /root/mysqlfailgover --mysql_master_vip=192.168.0.10/32 --command=status --ssh_user=root --orig_master_host=172.16.2.4 --orig_master_ip=172.16.2.4 --orig_master_port=3306\n8\norig_master_ip registration route table id:  rtb-764d3b13\nSat Jan  2 13:32:26 2016 - [info]  OK.\nSat Jan  2 13:32:26 2016 - [warning] shutdown_script is not defined.\nSat Jan  2 13:32:26 2016 - [info] Set master ping interval 3 seconds.\nSat Jan  2 13:32:26 2016 - [warning] secondary_check_script is not defined. It is highly recommended setting it to check master reachability from two or more routes.\nSat Jan  2 13:32:26 2016 - [info] Starting ping health check on 172.16.2.4(172.16.2.4:3306)..\nSat Jan  2 13:32:26 2016 - [info] Ping(SELECT) succeeded, waiting until MySQL doesn't respond..\n```\n\n- Master\u306emysqld\u505c\u6b62\u6642\n\n```\nSat Jan  2 13:32:50 2016 - [warning] Got error on MySQL select ping: 2013 (Lost connection to MySQL server during query)\nSat Jan  2 13:32:50 2016 - [info] Executing SSH check script: exit 0\nSat Jan  2 13:32:50 2016 - [info] HealthCheck: SSH to 172.16.2.4 is reachable.\nSat Jan  2 13:32:53 2016 - [warning] Got error on MySQL connect: 2003 (Can't connect to MySQL server on '172.16.2.4' (111))\nSat Jan  2 13:32:53 2016 - [warning] Connection failed 2 time(s)..\nSat Jan  2 13:32:56 2016 - [warning] Got error on MySQL connect: 2003 (Can't connect to MySQL server on '172.16.2.4' (111))\nSat Jan  2 13:32:56 2016 - [warning] Connection failed 3 time(s)..\nSat Jan  2 13:32:59 2016 - [warning] Got error on MySQL connect: 2003 (Can't connect to MySQL server on '172.16.2.4' (111))\nSat Jan  2 13:32:59 2016 - [warning] Connection failed 4 time(s)..\nSat Jan  2 13:32:59 2016 - [warning] Master is not reachable from health checker!\nSat Jan  2 13:32:59 2016 - [warning] Master 172.16.2.4(172.16.2.4:3306) is not reachable!\nSat Jan  2 13:32:59 2016 - [warning] SSH is reachable.\nSat Jan  2 13:32:59 2016 - [info] Connecting to a master server failed. Reading configuration file /etc/masterha_default.cnf and /etc/mha.conf again, and trying to connect to all servers to check server status..\nSat Jan  2 13:32:59 2016 - [warning] Global configuration file /etc/masterha_default.cnf not found. Skipping.\nSat Jan  2 13:32:59 2016 - [info] Reading application default configuration from /etc/mha.conf..\nSat Jan  2 13:32:59 2016 - [info] Reading server configuration from /etc/mha.conf..\nSat Jan  2 13:33:00 2016 - [info] GTID failover mode = 1\nSat Jan  2 13:33:00 2016 - [info] Dead Servers:\nSat Jan  2 13:33:00 2016 - [info]   172.16.2.4(172.16.2.4:3306)\nSat Jan  2 13:33:00 2016 - [info] Alive Servers:\nSat Jan  2 13:33:00 2016 - [info]   172.16.3.207(172.16.3.207:3306)\nSat Jan  2 13:33:00 2016 - [info]   172.16.3.99(172.16.3.99:3306)\nSat Jan  2 13:33:00 2016 - [info] Alive Slaves:\nSat Jan  2 13:33:00 2016 - [info]   172.16.3.207(172.16.3.207:3306)  Version=5.6.27-log (oldest major version between slaves) log-bin:enabled\nSat Jan  2 13:33:01 2016 - [info] Executing master IP deactivation script:\nSat Jan  2 13:33:01 2016 - [info]   /root/mysqlfailgover --mysql_master_vip=192.168.0.10/32 --orig_master_host=172.16.2.4 --orig_master_ip=172.16.2.4 --orig_master_port=3306 --command=stopssh --ssh_user=root\n8\n\u203bstopssh\u306f\u4f55\u3082\u5b9f\u884c\u3057\u306a\u3044\nSat Jan  2 13:33:01 2016 - [info]  done.\nSat Jan  2 13:33:01 2016 - [warning] shutdown_script is not set. Skipping explicit shutting down of the dead master.\nSat Jan  2 13:33:02 2016 - [info] * Phase 2: Dead Master Shutdown Phase completed.\nSat Jan  2 13:33:02 2016 - [info] * Phase 3.3: New Master Recovery Phase..\nSat Jan  2 13:33:02 2016 - [info]\nSat Jan  2 13:33:02 2016 - [info]  Waiting all logs to be applied..\nSat Jan  2 13:33:02 2016 - [info]   done.\nSat Jan  2 13:33:02 2016 - [info] Getting new master's binlog name and position..\nSat Jan  2 13:33:02 2016 - [info]  mysqld-bin.000014:489\nSat Jan  2 13:33:02 2016 - [info]  All other slaves should start replication from here. Statement should be: CHANGE MASTER TO MASTER_HOST='172.16.3.207', MASTER_PORT=3306, MASTER_AUTO_POSITION=1, MASTER_USER='repl', MASTER_PASSWORD='xx\nx';\nSat Jan  2 13:33:02 2016 - [info] Master Recovery succeeded. File:Pos:Exec_Gtid_Set: mysqld-bin.000014, 489, 8c410b0f-b114-11e5-903c-0a9edda6c5c3:12,\ndee4e0d2-a3d2-11e5-b9ca-0a9edda6c5c3:1-5,\ndee52e9c-a3d2-11e5-b9ca-0ae712148d43:1-3\nSat Jan  2 13:33:02 2016 - [info] Executing master IP activate script:\n\u203b\u30d5\u30a7\u30fc\u30ba3\u306efailover start\u6642\u306bMaster\u7528EC2\u306eRouteTable\u304c\u66f8\u304d\u63db\u308f\u308b\nSat Jan  2 13:33:02 2016 - [info]   /root/mysqlfailgover --mysql_master_vip=192.168.0.10/32 --command=start --ssh_user=root --orig_master_host=172.16.2.4 --orig_master_ip=172.16.2.4 --orig_master_port=3306 --new_master_host=172.16.3.20\n7 --new_master_ip=172.16.3.207 --new_master_port=3306 --new_master_user='mha' --new_master_password='mhapassword'\n13\nmysql master vip: 192.168.0.10/32\nmaster_host: 172.16.2.4\nmaster_host_ip:\n172.16.2.4 = i-3072a3bf\n172.16.3.207 = i-a574a52a\norig_master_ip registration route table id:  rtb-764d3b13\nroute table id rtb-764d3b13 ,replace destination instance  i-3072a3bf to i-a574a52a\nroute table, rtb-764d3b13 replaced.\nSat Jan  2 13:33:02 2016 - [info]  OK.\nSat Jan  2 13:33:02 2016 - [info] ** Finished master recovery successfully.\nSat Jan  2 13:33:02 2016 - [info] * Phase 3: Master Recovery Phase completed.\n..\u7701\u7565..\n```\n\n\n- \u5207\u308a\u66ff\u308f\u308a\u524d\u5f8c\u306emysql master host\n\nMHA Manager\u304b\u3089\u63a5\u7d9a\u78ba\u8a8d\u3057\u307e\u3057\u305f\n\n```\n\u203b\u5207\u66ff\u524d\n[ec2-user@ip-172-16-3-23 ~]$ mysql -u root -h 192.168.0.10 -e \"show variables like 'hostname'\"\n+---------------+---------------+\n| Variable_name | Value         |\n+---------------+---------------+\n| hostname      | ip-172-16-2-4 |\n+---------------+---------------+\n\u203b\u3053\u3053\u3067\u30d5\u30a7\u30a4\u30eb\u30aa\u30fc\u30d0\u30fc\u304c\u767a\u751f\u3057\u3066172.16.2.4->172.16.3.207\u3078Master\u304c\u5207\u308a\u66ff\u308f\u308b\n[ec2-user@ip-172-16-3-23 ~]$ mysql -u root -h 192.168.0.10 -e \"show slave status\\G\"\n[ec2-user@ip-172-16-3-23 ~]$ mysql -u root -h 192.168.0.10 -e \"show variables like 'hostname'\"\n+---------------+-----------------+\n| Variable_name | Value           |\n+---------------+-----------------+\n| hostname      | ip-172-16-3-207 |\n+---------------+-----------------+\n```\n\n## mha.conf\n\n\u5b9a\u7fa9\u4f8b\n\n- /etc/mha.conf\n\n```\n[server default]\nuser=mha\npassword=mhapassword\nmanager_workdir=/var/lib/mha\nremote_workdir=/var/lib/mha\nrepl_user=repl\nrepl_password=repl\nssh_user=root\nmaster_ip_failover_script=\"/root/mysqlfailgover --mysql_master_vip=192.168.0.10/32\"\n\n\n[server1]\nhostname=172.16.3.207\n[server2]\nhostname=172.16.2.4\n[server3]\nhostname=172.16.3.99\n```\n\n\n", "tags": ["AWS", "\u4ffa\u3067\u3082\u308f\u304b\u308b\u30b7\u30ea\u30fc\u30ba", "Go", "MySQL"]}