{"tags": ["Ansible", "Cisco", "Network"], "context": "\n\n1. \u306f\u3058\u3081\u306b\n\u305d\u3046\u3044\u3046\u6642\u304c\u3042\u308b\u304b\u3069\u3046\u304b\u306f\u5206\u304b\u308a\u307e\u305b\u3093\u304c\u3001\u591a\u6570\u306e\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u6a5f\u5668\u3092\u5c0e\u5165\u3057\u3066\u3044\u3066\u3001\u306a\u305c\u304b\u30db\u30b9\u30c8\u540d\u306e\u5927\u6587\u5b57\u5c0f\u6587\u5b57\u304c\u7d71\u4e00\u3055\u308c\u3066\u304a\u3089\u305a\u3001\u305d\u308c\u3092\u5927\u6587\u5b57\u306b\u7d71\u4e00\u3057\u3066\u8a2d\u5b9a\u3057\u305f\u3044\u3001\u3068\u3044\u3046\u3053\u3068\u306b\u3057\u307e\u3059\u3002\n1\u53f0\u305a\u3064\u624b\u4f5c\u696d\u3067\u518d\u8a2d\u5b9a\u3059\u308b\u306e\u306f\u5927\u5909\u306a\u306e\u3067\u3001TeraTerm\u30de\u30af\u30ed\u3067\u81ea\u52d5\u5316\u3057\u3066\u3082\u3088\u3044\u306e\u3067\u3059\u304c\u3001\u305b\u3063\u304b\u304fAnsible\u306b\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u6a5f\u5668\u5bfe\u5fdc\u306e\u30e2\u30b8\u30e5\u30fc\u30eb\u304c\u3042\u308b\u306e\u3067\u3001Ansible\u3067Cisco\u306e\u6a5f\u5668\u306b\u5bfe\u3057\u3066\u5927\u6587\u5b57\u7d71\u4e00\u5316\u3084\u3063\u3066\u307f\u308b\u3053\u3068\u306b\u3057\u307e\u3059\u3002\n\n2. Playbook\u306e\u4f5c\u6210\n\u4ee5\u4e0b\u306e\u3088\u3046\u306aPlaybook\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\u30dd\u30a4\u30f3\u30c8\u306f\u2605\u3067\u793a\u3057\u305f\u3001jinja2\u306e\u30d5\u30a3\u30eb\u30bf\u3067\u30b3\u30f3\u30d5\u30a3\u30b0\u304b\u3089hostname\u3092\u62bd\u51fa\u3057\u3066upper\u3067\u5927\u6587\u5b57\u306b\u5909\u63db\u3059\u308b\u3068\u3053\u308d\u3067\u3059\u3002\n\nupper_hostname.yml\n---\n- hosts: cisco  # \u30a4\u30f3\u30d9\u30f3\u30c8\u30ea\u30d5\u30a1\u30a4\u30eb\u3067 192.168.1.1\uff08\u3068\u308a\u3042\u3048\u305a1\u53f0\uff09\u3092[cisco]\u30b0\u30eb\u30fc\u30d7\u3067\u5b9a\u7fa9\u6e08\u307f\n  gather_facts: no\n  connection: local\n\n  tasks:\n    - name: show running-config   # runnning-config \u3092\u53d6\u5f97\u3059\u308b\u30bf\u30b9\u30af\n      ios_command:\n        commands:\n          - show running-config   # \u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\n        provider: \"{{ cli }}\"\n      register: result\n\n    - name: get hostname          # running-config\u304b\u3089\u30db\u30b9\u30c8\u540d\u3092\u53d6\u5f97\u3057\u3066\u5927\u6587\u5b57\u306b\u3057\u3066\u304b\u3089\u30d5\u30a1\u30af\u30c8\u306b\u4fdd\u5b58\u3057\u3066\u304a\u304f\n      set_fact: hostname_upper=\"{{ result.stdout[0] | regex_search('hostname (.+)', '\\\\1') | first | upper }}\"   # \u2605\n\n    - name: DEBUG                   # \u5927\u6587\u5b57\u5909\u63db\u3057\u305f\u30db\u30b9\u30c8\u540d\u3092\u30c7\u30d0\u30c3\u30b0\u8868\u793a\n      debug: var=hostname_upper\n\n    - name : set hostname to upper  # \u5927\u6587\u5b57\u5909\u63db\u3057\u305f\u30db\u30b9\u30c8\u540d\u3067\u518d\u8a2d\u5b9a\u3059\u308b\n      ios_config:\n        lines:\n          - hostname {{ hostname_upper }}\n        provider: \"{{ cli }}\"\n      notify: save config           # \u5909\u66f4\u304c\u3042\u3063\u305f\u3089\u4ee5\u4e0b\u3067\u5b9a\u7fa9\u3059\u308bhandler\u300csave config\u300d\u3092\u547c\u3073\u51fa\u3059\n      register: result\n\n    - name: DEBUG\n      debug: var=result\n\n  handlers:\n    - name: save config             # \u30b3\u30f3\u30d5\u30a3\u30b0\u3092\u4fdd\u5b58\u3059\u308b\n      ios_command:\n        commands:\n          - write memory\n        provider: \"{{ cli }}\"\n      register: result\n    - name: DEBUG\n      debug: var=result\n\n  vars:\n    cli:   # \u8a8d\u8a3c\u60c5\u5831\u3092\u5b9a\u7fa9\u3057\u3066\u304a\u304f\n      host:     \"{{ inventory_hostname }}\"\n      username: \"{{ ansible_user }}\"\n      password: \"{{ ansible_password }}\"\n      authorize: true\n      auth_pass: \"{{ cisco_enable_secret }}\"\n\n\n\n\n3.Playbook\u306e\u5b9f\u884c\n\n3.1. \u4e8b\u524d\u78ba\u8a8d\n\u5b9f\u884c\u524d\u306b\u73fe\u5728\u306e\u30db\u30b9\u30c8\u540d\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\u73fe\u5728\u306f\u5c0f\u6587\u5b57\u306e\u300cswitch-01\u300d\u3067\u3059\u3002\n\n\u4e8b\u524d\u78ba\u8a8d\nswitch-01#sh run | inc hostname\nhostname switch-01\n\n\n\n3.2 Playbook\u306e\u5b9f\u884c\nPlaybook\u3092\u5b9f\u884c\u3057\u307e\u3059\u3002\n\nPlaybook\u306e\u5b9f\u884c\nuser@ubuntu-vm:/etc/ansible$ ansible-playbook upper_hostname.yml\n\nPLAY [cisco] *******************************************************************\n\nTASK [show running-config] *****************************************************\nok: [192.168.1.1]\n\nTASK [get hostname] ************************************************************\nok: [192.168.1.1]\n\nTASK [DEBUG] *******************************************************************\nok: [192.168.1.1] => {\n    \"hostname_upper\": \"SWITCH-01\"         # \u5927\u6587\u5b57\u5909\u63db\u5f8c\u306e\u30db\u30b9\u30c8\u540d\n}\n\nTASK [set hostname to upper] ***************************************************\nchanged: [192.168.1.1]\n\nTASK [DEBUG] *******************************************************************\nok: [192.168.1.1] => {\n    \"result\": {\n        \"changed\": true,\n        \"responses\": [\n            \"\"\n        ],\n        \"updates\": [\n            \"hostname SWITCH-01\"          # \u5b9f\u884c\u3055\u308c\u305f\u30b3\u30de\u30f3\u30c9\n        ]\n    }\n}\n\nRUNNING HANDLER [save config] **************************************************\nok: [192.168.1.1]\n\nPLAY RECAP *********************************************************************\n192.168.1.1               : ok=6    changed=1    unreachable=0    failed=0\n\n\n\u6b63\u5e38\u306b\u5b9f\u884c\u3055\u308c\u305f\u3088\u3046\u3067\u3059\u3002\n\n3.3 \u4e8b\u5f8c\u78ba\u8a8d\n\u5b9f\u884c\u5f8c\u306e\u30db\u30b9\u30c8\u540d\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n\u4e8b\u5f8c\u78ba\u8a8d\nSWITCH-01#sh run | inc hostname\nhostname SWITCH-01\n\n\n\u7121\u4e8b\u306b\u5927\u6587\u5b57\u306b\u306a\u308a\u307e\u3057\u305f\u3002\n\u306a\u304a\u3001\u3053\u306e\u72b6\u614b\u3067\u3001\u3082\u3046\u4e00\u5ea6Playbook\u3092\u5b9f\u884c\u3059\u308b\u3068\u3001\u3059\u3067\u306b\u30db\u30b9\u30c8\u540d\u304c\u5927\u6587\u5b57\u306b\n\u306a\u3063\u3066\u3044\u308b\u305f\u3081\u3001hostname\u30b3\u30de\u30f3\u30c9\u306f\u5b9f\u884c\u3055\u308c\u305a\u3001\u30b3\u30f3\u30d5\u30a3\u30b0\u306e\u4fdd\u5b58\u30b3\u30de\u30f3\u30c9\u3082\n\u5b9f\u884c\u3055\u308c\u307e\u305b\u3093\n\n\u518d\u5b9f\u884c\u6642\u7d50\u679c\u306e\u629c\u7c8b\n(\u7701\u7565)\nPLAY RECAP *********************************************************************\n192.168.1.13               : ok=5    changed=0    unreachable=0    failed=0\n\n\n\n4. [\u5fdc\u7528] \u5c0f\u6587\u5b57\u306b\u7d71\u4e00\u3057\u305f\u3044\u5834\u5408\n\u5927\u6587\u5b57\u3067\u306f\u306a\u304f\u5c0f\u6587\u5b57\u306b\u7d71\u4e00\u3059\u308b\u5834\u5408\u306f\u3001Playbook\u4e2d\u306e\n| upper\u306e\u90e8\u5206\u3092| lower\u306b\u3057\u307e\u3059\u3002\n\n# 1. \u306f\u3058\u3081\u306b\n\u305d\u3046\u3044\u3046\u6642\u304c\u3042\u308b\u304b\u3069\u3046\u304b\u306f\u5206\u304b\u308a\u307e\u305b\u3093\u304c\u3001\u591a\u6570\u306e\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u6a5f\u5668\u3092\u5c0e\u5165\u3057\u3066\u3044\u3066\u3001\u306a\u305c\u304b\u30db\u30b9\u30c8\u540d\u306e\u5927\u6587\u5b57\u5c0f\u6587\u5b57\u304c\u7d71\u4e00\u3055\u308c\u3066\u304a\u3089\u305a\u3001\u305d\u308c\u3092\u5927\u6587\u5b57\u306b\u7d71\u4e00\u3057\u3066\u8a2d\u5b9a\u3057\u305f\u3044\u3001\u3068\u3044\u3046\u3053\u3068\u306b\u3057\u307e\u3059\u3002\n\n1\u53f0\u305a\u3064\u624b\u4f5c\u696d\u3067\u518d\u8a2d\u5b9a\u3059\u308b\u306e\u306f\u5927\u5909\u306a\u306e\u3067\u3001TeraTerm\u30de\u30af\u30ed\u3067\u81ea\u52d5\u5316\u3057\u3066\u3082\u3088\u3044\u306e\u3067\u3059\u304c\u3001\u305b\u3063\u304b\u304fAnsible\u306b\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u6a5f\u5668\u5bfe\u5fdc\u306e\u30e2\u30b8\u30e5\u30fc\u30eb\u304c\u3042\u308b\u306e\u3067\u3001Ansible\u3067Cisco\u306e\u6a5f\u5668\u306b\u5bfe\u3057\u3066\u5927\u6587\u5b57\u7d71\u4e00\u5316\u3084\u3063\u3066\u307f\u308b\u3053\u3068\u306b\u3057\u307e\u3059\u3002\n\n# 2. Playbook\u306e\u4f5c\u6210\n\u4ee5\u4e0b\u306e\u3088\u3046\u306aPlaybook\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\u30dd\u30a4\u30f3\u30c8\u306f\u2605\u3067\u793a\u3057\u305f\u3001jinja2\u306e\u30d5\u30a3\u30eb\u30bf\u3067\u30b3\u30f3\u30d5\u30a3\u30b0\u304b\u3089hostname\u3092\u62bd\u51fa\u3057\u3066`upper`\u3067\u5927\u6587\u5b57\u306b\u5909\u63db\u3059\u308b\u3068\u3053\u308d\u3067\u3059\u3002\n\n```yaml:upper_hostname.yml\n---\n- hosts: cisco  # \u30a4\u30f3\u30d9\u30f3\u30c8\u30ea\u30d5\u30a1\u30a4\u30eb\u3067 192.168.1.1\uff08\u3068\u308a\u3042\u3048\u305a1\u53f0\uff09\u3092[cisco]\u30b0\u30eb\u30fc\u30d7\u3067\u5b9a\u7fa9\u6e08\u307f\n  gather_facts: no\n  connection: local\n\n  tasks:\n    - name: show running-config   # runnning-config \u3092\u53d6\u5f97\u3059\u308b\u30bf\u30b9\u30af\n      ios_command:\n        commands:\n          - show running-config   # \u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\n        provider: \"{{ cli }}\"\n      register: result\n\n    - name: get hostname          # running-config\u304b\u3089\u30db\u30b9\u30c8\u540d\u3092\u53d6\u5f97\u3057\u3066\u5927\u6587\u5b57\u306b\u3057\u3066\u304b\u3089\u30d5\u30a1\u30af\u30c8\u306b\u4fdd\u5b58\u3057\u3066\u304a\u304f\n      set_fact: hostname_upper=\"{{ result.stdout[0] | regex_search('hostname (.+)', '\\\\1') | first | upper }}\"   # \u2605\n\n    - name: DEBUG                   # \u5927\u6587\u5b57\u5909\u63db\u3057\u305f\u30db\u30b9\u30c8\u540d\u3092\u30c7\u30d0\u30c3\u30b0\u8868\u793a\n      debug: var=hostname_upper\n\n    - name : set hostname to upper  # \u5927\u6587\u5b57\u5909\u63db\u3057\u305f\u30db\u30b9\u30c8\u540d\u3067\u518d\u8a2d\u5b9a\u3059\u308b\n      ios_config:\n        lines:\n          - hostname {{ hostname_upper }}\n        provider: \"{{ cli }}\"\n      notify: save config           # \u5909\u66f4\u304c\u3042\u3063\u305f\u3089\u4ee5\u4e0b\u3067\u5b9a\u7fa9\u3059\u308bhandler\u300csave config\u300d\u3092\u547c\u3073\u51fa\u3059\n      register: result\n\n    - name: DEBUG\n      debug: var=result\n\n  handlers:\n    - name: save config             # \u30b3\u30f3\u30d5\u30a3\u30b0\u3092\u4fdd\u5b58\u3059\u308b\n      ios_command:\n        commands:\n          - write memory\n        provider: \"{{ cli }}\"\n      register: result\n    - name: DEBUG\n      debug: var=result\n\n  vars:\n    cli:   # \u8a8d\u8a3c\u60c5\u5831\u3092\u5b9a\u7fa9\u3057\u3066\u304a\u304f\n      host:     \"{{ inventory_hostname }}\"\n      username: \"{{ ansible_user }}\"\n      password: \"{{ ansible_password }}\"\n      authorize: true\n      auth_pass: \"{{ cisco_enable_secret }}\"\n\n```\n\n\n# 3.Playbook\u306e\u5b9f\u884c\n## 3.1. \u4e8b\u524d\u78ba\u8a8d\n\u5b9f\u884c\u524d\u306b\u73fe\u5728\u306e\u30db\u30b9\u30c8\u540d\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\u73fe\u5728\u306f\u5c0f\u6587\u5b57\u306e\u300cswitch-01\u300d\u3067\u3059\u3002\n\n```text:\u4e8b\u524d\u78ba\u8a8d\nswitch-01#sh run | inc hostname\nhostname switch-01\n```\n\n## 3.2 Playbook\u306e\u5b9f\u884c\n\nPlaybook\u3092\u5b9f\u884c\u3057\u307e\u3059\u3002\n\n```text:Playbook\u306e\u5b9f\u884c\nuser@ubuntu-vm:/etc/ansible$ ansible-playbook upper_hostname.yml\n\nPLAY [cisco] *******************************************************************\n\nTASK [show running-config] *****************************************************\nok: [192.168.1.1]\n\nTASK [get hostname] ************************************************************\nok: [192.168.1.1]\n\nTASK [DEBUG] *******************************************************************\nok: [192.168.1.1] => {\n    \"hostname_upper\": \"SWITCH-01\"         # \u5927\u6587\u5b57\u5909\u63db\u5f8c\u306e\u30db\u30b9\u30c8\u540d\n}\n\nTASK [set hostname to upper] ***************************************************\nchanged: [192.168.1.1]\n\nTASK [DEBUG] *******************************************************************\nok: [192.168.1.1] => {\n    \"result\": {\n        \"changed\": true,\n        \"responses\": [\n            \"\"\n        ],\n        \"updates\": [\n            \"hostname SWITCH-01\"          # \u5b9f\u884c\u3055\u308c\u305f\u30b3\u30de\u30f3\u30c9\n        ]\n    }\n}\n\nRUNNING HANDLER [save config] **************************************************\nok: [192.168.1.1]\n\nPLAY RECAP *********************************************************************\n192.168.1.1               : ok=6    changed=1    unreachable=0    failed=0\n```\n\u6b63\u5e38\u306b\u5b9f\u884c\u3055\u308c\u305f\u3088\u3046\u3067\u3059\u3002\n\n## 3.3 \u4e8b\u5f8c\u78ba\u8a8d\n\u5b9f\u884c\u5f8c\u306e\u30db\u30b9\u30c8\u540d\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n```text:\u4e8b\u5f8c\u78ba\u8a8d\nSWITCH-01#sh run | inc hostname\nhostname SWITCH-01\n```\n\n\u7121\u4e8b\u306b\u5927\u6587\u5b57\u306b\u306a\u308a\u307e\u3057\u305f\u3002\n\u306a\u304a\u3001\u3053\u306e\u72b6\u614b\u3067\u3001\u3082\u3046\u4e00\u5ea6Playbook\u3092\u5b9f\u884c\u3059\u308b\u3068\u3001\u3059\u3067\u306b\u30db\u30b9\u30c8\u540d\u304c\u5927\u6587\u5b57\u306b\n\u306a\u3063\u3066\u3044\u308b\u305f\u3081\u3001`hostname`\u30b3\u30de\u30f3\u30c9\u306f\u5b9f\u884c\u3055\u308c\u305a\u3001\u30b3\u30f3\u30d5\u30a3\u30b0\u306e\u4fdd\u5b58\u30b3\u30de\u30f3\u30c9\u3082\n\u5b9f\u884c\u3055\u308c\u307e\u305b\u3093\n\n```text:\u518d\u5b9f\u884c\u6642\u7d50\u679c\u306e\u629c\u7c8b\n(\u7701\u7565)\nPLAY RECAP *********************************************************************\n192.168.1.13               : ok=5    changed=0    unreachable=0    failed=0\n```\n\n# 4. [\u5fdc\u7528] \u5c0f\u6587\u5b57\u306b\u7d71\u4e00\u3057\u305f\u3044\u5834\u5408\n\u5927\u6587\u5b57\u3067\u306f\u306a\u304f\u5c0f\u6587\u5b57\u306b\u7d71\u4e00\u3059\u308b\u5834\u5408\u306f\u3001Playbook\u4e2d\u306e\n`| upper `\u306e\u90e8\u5206\u3092`| lower `\u306b\u3057\u307e\u3059\u3002\n\n\n```\n"}