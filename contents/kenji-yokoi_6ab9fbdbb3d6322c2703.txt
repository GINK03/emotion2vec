{"context": "\n\nWireshark\u3067\u72ec\u81ea\u30d7\u30ed\u30c8\u30b3\u30eb\u3092\u89e3\u6790\u3059\u308b\n\n\u3044\u304d\u3055\u3064\nWireshark\u3067\u306fLua\u8a00\u8a9e\u3067\u8a18\u8ff0\u3057\u305f\u30d5\u30a1\u30a4\u30eb\u3092\u30d7\u30e9\u30b0\u30a4\u30f3\u3068\u3057\u3066\u6271\u3046\u3053\u3068\u304c\u51fa\u6765\u307e\u3059\u3002\n\u696d\u52d9\u3067\u7aef\u672b\u9593\u306e\u901a\u4fe1\u304c\u602a\u3057\u304b\u3063\u305f\u306e\u3067\u3001Wireshark\u3092\u4f7f\u3046\u3053\u3068\u306b\u306a\u308a\u307e\u3057\u305f\u304c\u3001\u5358\u306b\u30ad\u30e3\u30d7\u30c1\u30e3\u30fc\u3057\u305f\u3060\u3051\u3060\u3068\u30d0\u30a4\u30ca\u30ea\u3092\u8133\u5185\u89e3\u6790\u3059\u308b\u3053\u3068\u306b\u306a\u308a\u307e\u3059\u3002\u3061\u3087\u3063\u3068\u52d8\u5f01\u3068\u3044\u3046\u3053\u3068\u3067\u30d7\u30e9\u30b0\u30a4\u30f3\u3092\u4f5c\u308b\u3053\u3068\u306b\u3057\u307e\u3057\u305f\u3002Lua\u8a00\u8a9e\u3063\u3066\u306a\u3093\u3061\u3083\u3089\uff1f\u3068\u601d\u3046\u3051\u3069\u3001\u72ec\u81ea\u30d7\u30ed\u30c8\u30b3\u30eb\u3092\u89e3\u6790\u3059\u308b\u304f\u3089\u3044\u3067\u3042\u308c\u3070\u7c21\u5358\u306b\u4f5c\u308b\u3053\u3068\u304c\u51fa\u6765\u307e\u3057\u305f\u3002\n\n\u524d\u6e96\u5099\nWireshark\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u30d5\u30a9\u30eb\u30c0\u306b\u3042\u308b init.lua \u306e\u8a2d\u5b9a\u3092\u5909\u66f4\u3057\u307e\u3059\u3002\n\ndisable_lua\u3092false \u306b\u8a2d\u5b9a\nrun_user_scripts_when_superuser\u3092true\u306b\u8a2d\u5b9a\n\u30d5\u30a1\u30a4\u30eb\u306e\u6700\u7d42\u884c\u306b\u300cdofile(DATA_DIR..\"foo_protcol.lua\")\u300d\u3092\u8ffd\u8a18\n\n\ninit.lua\n-- Set disable_lua to true to disable Lua support.\ndisable_lua = false\n\nif disable_lua then\n    return\nend\n\n-- If set and we are running with special privileges this setting\n-- tells whether scripts other than this one are to be run.\nrun_user_scripts_when_superuser = true\n\n \uff1a\n \uff1a\n \uff1a\n\ndofile(DATA_DIR..\"console.lua\")\n--dofile(DATA_DIR..\"dtd_gen.lua\")\ndofile(DATA_DIR..\"foo_protcol.lua\")\n\n\n\nlua\u30d5\u30a1\u30a4\u30eb\u306e\u4f5c\u6210\nWireshark\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u30d5\u30a9\u30eb\u30c0\u306b\u3066\u300cfoo_protcol.lua\u300d\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\u901a\u4fe1\u96fb\u6587\u3068\u304b\u30dd\u30fc\u30c8\u756a\u53f7\u306f\u30d5\u30a3\u30af\u30b7\u30e7\u30f3\u3067\u3059\u3002\n\nle_uint() \u306f\u30ea\u30c8\u30eb\u30a8\u30f3\u30c7\u30a3\u30a2\u30f3\u3067\u5c55\u958b\u3057\u307e\u3059\u3002\nuint() \u306f\u30d3\u30c3\u30b0\u30a8\u30f3\u30c7\u30a3\u30a2\u30f3\u3067\u5c55\u958b\u3057\u307e\u3059\u3002\n\n\nfoo_protcol.lua\n-- foo protocol example\n-- \u30d7\u30ed\u30c8\u30b3\u30eb\u306e\u5b9a\u7fa9\nfoo_proto = Proto(\"foo\",\"Foo\",\"Foo protocol\")\n-- \u30d1\u30fc\u30b9\u7528\u306e\u95a2\u6570\u5b9a\u7fa9\nfunction foo_proto.dissector(buffer,pinfo,tree)\n    pinfo.cols.protocol = \"Foo\"\n    local subtree = tree:add(foo_proto,buffer(),\"Foo Protocol Data\")\n    subtree:add(buffer(0,1),\"cmd_id: \" .. buffer(0,1):le_uint())\n    subtree:add(buffer(1,1),\"req_id: \" .. buffer(1,1):le_uint())\n    subtree:add(buffer(2,6),\"date: \" .. buffer(2,1):le_uint() .. \"/\" .. buffer(3,1):le_uint() .. \"/\"  .. buffer(4,1):le_uint() .. \" \"  .. buffer(5,1):le_uint() .. \":\"  .. buffer(6,1):le_uint() .. \":\"  .. buffer(7,1):le_uint())\n    subtree:add(buffer(8,2),\"seq_no: \" .. buffer(8,2):le_uint())\n    subtree:add(buffer(10,1),\"rty_cnt: \" .. buffer(10,1):le_uint())\nend\n-- tcp.port\u30c6\u30fc\u30d6\u30eb\u306e\u30ed\u30fc\u30c9\ntcp_table = DissectorTable.get(\"tcp.port\")\n-- \u30dd\u30fc\u30c89999\u756a\u3068\u30d7\u30ed\u30c8\u30b3\u30eb\u306e\u7d10\u4ed8\u3051\u3092\u3059\u308b\ntcp_table:add(9999,foo_proto)\n\n\n\nWireshark\u3067\u72ec\u81ea\u30d7\u30ed\u30c8\u30b3\u30eb\u304c\u8868\u793a\u3055\u308c\u305f \n\nWireshark\u3092\u8d77\u52d5\u3057\u3066\u3001\u76ee\u7684\u306e\u901a\u4fe1\u5c65\u6b74\u306e\u8a73\u7d30\u3092\u8868\u793a\u3059\u308b\u3068\u72ec\u81ea\u30d7\u30ed\u30c8\u30b3\u30eb\u306e\u89e3\u6790\u304c\u8868\u793a\u3055\u308c\u307e\u3059\u3002\uff08\u753b\u50cf\u306f\u3058\u3083\u3063\u304b\u3093\u52a0\u5de5\u3057\u3066\u3044\u307e\u3059\uff09\n\n\n\u96fb\u6587\u30b5\u30a4\u30ba\u304c\u8db3\u3089\u306a\u3044\u5834\u5408\u3084\u5206\u5272\u30d1\u30b1\u30c3\u30c8\u306e\u5834\u5408\nTCP\u306e\u30d1\u30b1\u30c3\u30c8\u306f\u3001\u4e00\u3064\u306e\u30d1\u30b1\u30c3\u30c8\u3067\u8907\u6570\u306e\u96fb\u6587\u304c\u5165\u3063\u3066\u3044\u305f\u308a\u3001\u4e00\u56de\u3067\u5168\u3066\u306e\u96fb\u6587\u304c\u5230\u9054\u3057\u306a\u304b\u3063\u305f\u308a\u3057\u307e\u3059\u3002\u4e0a\u8a18\u306e foo_proto.dissector \u3067\u306f\u3001\u305d\u306e\u3042\u305f\u308a\u306e\u8003\u616e\u3092\u52a0\u3048\u307e\u3059\u3002\n\u307e\u305a\u306f\u96fb\u6587\u89e3\u6790\u81ea\u4f53\u306e\u30ed\u30b8\u30c3\u30af\u3092\u5206\u3051\u307e\u3059\u3002\nfunction disp_foo(buffer,pinfo,tree)\n    pinfo.cols.protocol = \"Foo\"\n    local subtree = tree:add(foo_proto,buffer(),\"Foo Protocol Data\")\n    subtree:add(buffer(0,1),\"cmd_id: \" .. buffer(0,1):le_uint())\n    subtree:add(buffer(1,1),\"req_id: \" .. buffer(1,1):le_uint())\n    subtree:add(buffer(2,6),\"date: \" .. buffer(2,1):le_uint() .. \"/\" .. buffer(3,1):le_uint() .. \"/\"  .. buffer(4,1):le_uint() .. \" \"  .. buffer(5,1):le_uint() .. \":\"  .. buffer(6,1):le_uint() .. \":\"  .. buffer(7,1):le_uint())\n    subtree:add(buffer(8,2),\"seq_no: \" .. buffer(8,2):le_uint())\n    subtree:add(buffer(10,1),\"rty_cnt: \" .. buffer(10,1):le_uint())\nend\n\ndissector\u81ea\u4f53\u3067\u306f\u3001\u53d7\u3051\u53d6\u3063\u305f\u30d0\u30c3\u30d5\u30a1\u30fc\u306e\u30b5\u30a4\u30ba\u3092\u898b\u3066\u3001\u5f8c\u7d9a\u306e\u30d1\u30b1\u30c3\u30c8\u3068\u30a2\u30da\u30f3\u30c9\u3057\u305f\u308a\u3001\u8907\u6570\u96fb\u6587\u3092\u51e6\u7406\u3059\u308b\u305f\u3081\u306e\u30eb\u30fc\u30d7\u3092\u884c\u3046\u3088\u3046\u306b\u3057\u307e\u3059\u3002\nfunction foo_proto.dissector(buffer,pinfo,tree)\n    local HEADDER_LENGTH = 17\n    if buffer:len() < HEADDER_LENGTH then\n        -- \u30d8\u30c3\u30c0\u90e8\u306b\u5fc5\u8981\u306a\u30c7\u30fc\u30bf\u9577\u304c\u7121\u3044\u306e\u3067\u3001\u5f8c\u7d9a\u306e\u30d1\u30b1\u30c3\u30c8\u306b\u30a2\u30da\u30f3\u30c9\u3059\u308b.\n        pinfo.desegment_len = DESEGMENT_ONE_MORE_SEGMENT\n        return buffer:len() - HEADDER_LENGTH\n    end\n\n    while buffer:len() > 0 do\n        local length = buffer(13,2):le_uint()\n        if (buffer:len() - HEADDER_LENGTH) < length then\n            -- \u30c7\u30fc\u30bf\u90e8\u306b\u5fc5\u8981\u306a\u30c7\u30fc\u30bf\u9577\u304c\u7121\u3044\u306e\u3067\u3001\u5f8c\u7d9a\u306e\u30d1\u30b1\u30c3\u30c8\u306b\u30a2\u30da\u30f3\u30c9\u3059\u308b.\n            pinfo.desegment_len = DESEGMENT_ONE_MORE_SEGMENT\n            return buffer:len() - length + HEADDER_LENGTH\n        end\n\n        disp_foo(buffer,pinfo,tree)\n        if (buffer:len() - (HEADDER_LENGTH + length)) == 0 then\n            break\n        end\n        buffer = buffer:range(HEADDER_LENGTH + length)\n    end\nend\n\n\u4e00\u3064\u306e\u30d1\u30b1\u30c3\u30c8\u306b\u8907\u6570\u306e\u96fb\u6587\u304c\u3042\u308b\u5834\u5408\u306f\u3053\u306e\u3088\u3046\u306b\u3002\n\n\u5206\u5272\u30d1\u30b1\u30c3\u30c8\u306e\u5834\u5408\u306f\u3053\u306e\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\n\n# Wireshark\u3067\u72ec\u81ea\u30d7\u30ed\u30c8\u30b3\u30eb\u3092\u89e3\u6790\u3059\u308b\n\n## \u3044\u304d\u3055\u3064\nWireshark\u3067\u306fLua\u8a00\u8a9e\u3067\u8a18\u8ff0\u3057\u305f\u30d5\u30a1\u30a4\u30eb\u3092\u30d7\u30e9\u30b0\u30a4\u30f3\u3068\u3057\u3066\u6271\u3046\u3053\u3068\u304c\u51fa\u6765\u307e\u3059\u3002\n\u696d\u52d9\u3067\u7aef\u672b\u9593\u306e\u901a\u4fe1\u304c\u602a\u3057\u304b\u3063\u305f\u306e\u3067\u3001Wireshark\u3092\u4f7f\u3046\u3053\u3068\u306b\u306a\u308a\u307e\u3057\u305f\u304c\u3001\u5358\u306b\u30ad\u30e3\u30d7\u30c1\u30e3\u30fc\u3057\u305f\u3060\u3051\u3060\u3068\u30d0\u30a4\u30ca\u30ea\u3092\u8133\u5185\u89e3\u6790\u3059\u308b\u3053\u3068\u306b\u306a\u308a\u307e\u3059\u3002\u3061\u3087\u3063\u3068\u52d8\u5f01\u3068\u3044\u3046\u3053\u3068\u3067\u30d7\u30e9\u30b0\u30a4\u30f3\u3092\u4f5c\u308b\u3053\u3068\u306b\u3057\u307e\u3057\u305f\u3002Lua\u8a00\u8a9e\u3063\u3066\u306a\u3093\u3061\u3083\u3089\uff1f\u3068\u601d\u3046\u3051\u3069\u3001\u72ec\u81ea\u30d7\u30ed\u30c8\u30b3\u30eb\u3092\u89e3\u6790\u3059\u308b\u304f\u3089\u3044\u3067\u3042\u308c\u3070\u7c21\u5358\u306b\u4f5c\u308b\u3053\u3068\u304c\u51fa\u6765\u307e\u3057\u305f\u3002\n\n## \u524d\u6e96\u5099\nWireshark\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u30d5\u30a9\u30eb\u30c0\u306b\u3042\u308b init.lua \u306e\u8a2d\u5b9a\u3092\u5909\u66f4\u3057\u307e\u3059\u3002\n\n* disable_lua\u3092false \u306b\u8a2d\u5b9a\n* run_user_scripts_when_superuser\u3092true\u306b\u8a2d\u5b9a\n* \u30d5\u30a1\u30a4\u30eb\u306e\u6700\u7d42\u884c\u306b\u300cdofile(DATA_DIR..\"foo_protcol.lua\")\u300d\u3092\u8ffd\u8a18\n\n```lua:init.lua\n-- Set disable_lua to true to disable Lua support.\ndisable_lua = false\n\nif disable_lua then\n    return\nend\n\n-- If set and we are running with special privileges this setting\n-- tells whether scripts other than this one are to be run.\nrun_user_scripts_when_superuser = true\n\n \uff1a\n \uff1a\n \uff1a\n\ndofile(DATA_DIR..\"console.lua\")\n--dofile(DATA_DIR..\"dtd_gen.lua\")\ndofile(DATA_DIR..\"foo_protcol.lua\")\n```\n\n## lua\u30d5\u30a1\u30a4\u30eb\u306e\u4f5c\u6210\nWireshark\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u30d5\u30a9\u30eb\u30c0\u306b\u3066\u300cfoo_protcol.lua\u300d\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\u901a\u4fe1\u96fb\u6587\u3068\u304b\u30dd\u30fc\u30c8\u756a\u53f7\u306f\u30d5\u30a3\u30af\u30b7\u30e7\u30f3\u3067\u3059\u3002\n\n* le_uint() \u306f\u30ea\u30c8\u30eb\u30a8\u30f3\u30c7\u30a3\u30a2\u30f3\u3067\u5c55\u958b\u3057\u307e\u3059\u3002\n* uint() \u306f\u30d3\u30c3\u30b0\u30a8\u30f3\u30c7\u30a3\u30a2\u30f3\u3067\u5c55\u958b\u3057\u307e\u3059\u3002\n\n```lua:foo_protcol.lua\n-- foo protocol example\n-- \u30d7\u30ed\u30c8\u30b3\u30eb\u306e\u5b9a\u7fa9\nfoo_proto = Proto(\"foo\",\"Foo\",\"Foo protocol\")\n-- \u30d1\u30fc\u30b9\u7528\u306e\u95a2\u6570\u5b9a\u7fa9\nfunction foo_proto.dissector(buffer,pinfo,tree)\n    pinfo.cols.protocol = \"Foo\"\n    local subtree = tree:add(foo_proto,buffer(),\"Foo Protocol Data\")\n    subtree:add(buffer(0,1),\"cmd_id: \" .. buffer(0,1):le_uint())\n    subtree:add(buffer(1,1),\"req_id: \" .. buffer(1,1):le_uint())\n    subtree:add(buffer(2,6),\"date: \" .. buffer(2,1):le_uint() .. \"/\" .. buffer(3,1):le_uint() .. \"/\"  .. buffer(4,1):le_uint() .. \" \"  .. buffer(5,1):le_uint() .. \":\"  .. buffer(6,1):le_uint() .. \":\"  .. buffer(7,1):le_uint())\n    subtree:add(buffer(8,2),\"seq_no: \" .. buffer(8,2):le_uint())\n    subtree:add(buffer(10,1),\"rty_cnt: \" .. buffer(10,1):le_uint())\nend\n-- tcp.port\u30c6\u30fc\u30d6\u30eb\u306e\u30ed\u30fc\u30c9\ntcp_table = DissectorTable.get(\"tcp.port\")\n-- \u30dd\u30fc\u30c89999\u756a\u3068\u30d7\u30ed\u30c8\u30b3\u30eb\u306e\u7d10\u4ed8\u3051\u3092\u3059\u308b\ntcp_table:add(9999,foo_proto)\n```\n\n## Wireshark\u3067\u72ec\u81ea\u30d7\u30ed\u30c8\u30b3\u30eb\u304c\u8868\u793a\u3055\u308c\u305f :blush:\n\nWireshark\u3092\u8d77\u52d5\u3057\u3066\u3001\u76ee\u7684\u306e\u901a\u4fe1\u5c65\u6b74\u306e\u8a73\u7d30\u3092\u8868\u793a\u3059\u308b\u3068\u72ec\u81ea\u30d7\u30ed\u30c8\u30b3\u30eb\u306e\u89e3\u6790\u304c\u8868\u793a\u3055\u308c\u307e\u3059\u3002\uff08\u753b\u50cf\u306f\u3058\u3083\u3063\u304b\u3093\u52a0\u5de5\u3057\u3066\u3044\u307e\u3059\uff09\n\n![foo_protocol.png](https://qiita-image-store.s3.amazonaws.com/0/114529/c106e070-087a-f9d5-a125-9f5cb4febda0.png)\n\n## \u96fb\u6587\u30b5\u30a4\u30ba\u304c\u8db3\u3089\u306a\u3044\u5834\u5408\u3084\u5206\u5272\u30d1\u30b1\u30c3\u30c8\u306e\u5834\u5408\n\nTCP\u306e\u30d1\u30b1\u30c3\u30c8\u306f\u3001\u4e00\u3064\u306e\u30d1\u30b1\u30c3\u30c8\u3067\u8907\u6570\u306e\u96fb\u6587\u304c\u5165\u3063\u3066\u3044\u305f\u308a\u3001\u4e00\u56de\u3067\u5168\u3066\u306e\u96fb\u6587\u304c\u5230\u9054\u3057\u306a\u304b\u3063\u305f\u308a\u3057\u307e\u3059\u3002\u4e0a\u8a18\u306e foo_proto.dissector \u3067\u306f\u3001\u305d\u306e\u3042\u305f\u308a\u306e\u8003\u616e\u3092\u52a0\u3048\u307e\u3059\u3002\n\n\u307e\u305a\u306f\u96fb\u6587\u89e3\u6790\u81ea\u4f53\u306e\u30ed\u30b8\u30c3\u30af\u3092\u5206\u3051\u307e\u3059\u3002\n\n```lua\nfunction disp_foo(buffer,pinfo,tree)\n    pinfo.cols.protocol = \"Foo\"\n    local subtree = tree:add(foo_proto,buffer(),\"Foo Protocol Data\")\n    subtree:add(buffer(0,1),\"cmd_id: \" .. buffer(0,1):le_uint())\n    subtree:add(buffer(1,1),\"req_id: \" .. buffer(1,1):le_uint())\n    subtree:add(buffer(2,6),\"date: \" .. buffer(2,1):le_uint() .. \"/\" .. buffer(3,1):le_uint() .. \"/\"  .. buffer(4,1):le_uint() .. \" \"  .. buffer(5,1):le_uint() .. \":\"  .. buffer(6,1):le_uint() .. \":\"  .. buffer(7,1):le_uint())\n    subtree:add(buffer(8,2),\"seq_no: \" .. buffer(8,2):le_uint())\n    subtree:add(buffer(10,1),\"rty_cnt: \" .. buffer(10,1):le_uint())\nend\n```\n\ndissector\u81ea\u4f53\u3067\u306f\u3001\u53d7\u3051\u53d6\u3063\u305f\u30d0\u30c3\u30d5\u30a1\u30fc\u306e\u30b5\u30a4\u30ba\u3092\u898b\u3066\u3001\u5f8c\u7d9a\u306e\u30d1\u30b1\u30c3\u30c8\u3068\u30a2\u30da\u30f3\u30c9\u3057\u305f\u308a\u3001\u8907\u6570\u96fb\u6587\u3092\u51e6\u7406\u3059\u308b\u305f\u3081\u306e\u30eb\u30fc\u30d7\u3092\u884c\u3046\u3088\u3046\u306b\u3057\u307e\u3059\u3002\n\n```lua\nfunction foo_proto.dissector(buffer,pinfo,tree)\n    local HEADDER_LENGTH = 17\n    if buffer:len() < HEADDER_LENGTH then\n        -- \u30d8\u30c3\u30c0\u90e8\u306b\u5fc5\u8981\u306a\u30c7\u30fc\u30bf\u9577\u304c\u7121\u3044\u306e\u3067\u3001\u5f8c\u7d9a\u306e\u30d1\u30b1\u30c3\u30c8\u306b\u30a2\u30da\u30f3\u30c9\u3059\u308b.\n        pinfo.desegment_len = DESEGMENT_ONE_MORE_SEGMENT\n        return buffer:len() - HEADDER_LENGTH\n    end\n\n    while buffer:len() > 0 do\n        local length = buffer(13,2):le_uint()\n        if (buffer:len() - HEADDER_LENGTH) < length then\n            -- \u30c7\u30fc\u30bf\u90e8\u306b\u5fc5\u8981\u306a\u30c7\u30fc\u30bf\u9577\u304c\u7121\u3044\u306e\u3067\u3001\u5f8c\u7d9a\u306e\u30d1\u30b1\u30c3\u30c8\u306b\u30a2\u30da\u30f3\u30c9\u3059\u308b.\n            pinfo.desegment_len = DESEGMENT_ONE_MORE_SEGMENT\n            return buffer:len() - length + HEADDER_LENGTH\n        end\n        \n        disp_foo(buffer,pinfo,tree)\n        if (buffer:len() - (HEADDER_LENGTH + length)) == 0 then\n            break\n        end\n        buffer = buffer:range(HEADDER_LENGTH + length)\n    end\nend\n```\n\n\u4e00\u3064\u306e\u30d1\u30b1\u30c3\u30c8\u306b\u8907\u6570\u306e\u96fb\u6587\u304c\u3042\u308b\u5834\u5408\u306f\u3053\u306e\u3088\u3046\u306b\u3002\n\n![packet1.png](https://qiita-image-store.s3.amazonaws.com/0/114529/844c1725-0a0e-9bfc-6798-aded2753c47e.png)\n\n\u5206\u5272\u30d1\u30b1\u30c3\u30c8\u306e\u5834\u5408\u306f\u3053\u306e\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\n\n![packet2.png](https://qiita-image-store.s3.amazonaws.com/0/114529/45e5821a-d7c8-2abd-bf1e-68e0ffccb223.png)\n\n", "tags": ["Wireshark", "Lua"]}