{"tags": ["chrome-extension", "JavaScript"], "context": " More than 1 year has passed since last update.\n\nBackground\nChrome Extension\u306eContent Script\u3067\u306fcontext\u304c\u30da\u30fc\u30b8\u4e0a\u3067\u5b9f\u884c\u3055\u308c\u3066\u3044\u308bJS\u3068\u306f\u9055\u3046\u305f\u3081window\u7d4c\u7531\u3067\u5909\u6570\u53d6\u5f97\u3084\u95a2\u6570\u5b9f\u884c\u304c\u3067\u304d\u307e\u305b\u3093\u3002\nwindow\u30b3\u30f3\u30c6\u30ad\u30b9\u30c8\u3067\u95a2\u6570\u3092\u5b9f\u884c\u3059\u308b\u65b9\u6cd5\u306f\nhttp://qiita.com/suin/items/5e1aa942e654bce442f7\n\u3084\nhttp://stackoverflow.com/questions/20499994/access-window-variable-from-content-script\n\u306a\u3069\u3044\u308d\u3044\u308d\u3042\u308a\u307e\u3059\u304c\u3001\u7d50\u679c\u3092\u53d6\u5f97\u3059\u308b\u4f8b\u306f\u898b\u3064\u304b\u3089\u306a\u304b\u3063\u305f\u306e\u3067\u81ea\u5206\u3067\u4f5c\u3063\u3066\u307f\u307e\u3057\u305f\u3002\n\nSolution\nGist: https://gist.github.com/dtaniwaki/b2b29a95b98f593ffd57\n\u95a2\u6570\u3092\u5b9f\u884c\u3057\u305f\u5f8c\u3067\u305d\u306e\u7d50\u679c\u3092\u633f\u5165\u3057\u305fscript\u30bf\u30b0\u306edataset\u306bJSON\u306b\u30b7\u30ea\u30a2\u30e9\u30a4\u30ba\u3057\u3066\u683c\u7d0d\u3057\u3001content script\u5074\u304b\u3089\u540c\u3058ID\u306escript\u3092\u63a2\u3057\u3066\u30c7\u30b7\u30ea\u30a2\u30e9\u30a4\u30ba\u3057\u3066\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u306b\u7d50\u679c\u3092\u6e21\u3057\u3066\u3044\u307e\u3059\u3002\n\nwindowContextRunner.js\n'use strict'\n\nlet waitScriptResult = function (id, timeout) {\n  return new Promise(function (resolve, reject) {\n    let timerId\n    timerId = setInterval(function () {\n      let elem = document.getElementById(id)\n      if (typeof elem !== 'undefined' && typeof elem.dataset.done !== 'undefined') {\n        clearInterval(timerId)\n        timerId = null\n        if (typeof elem.dataset.error !== 'undefined' && elem.dataset.error !== '') {\n          reject(Error(elem.dataset.error))\n        } else {\n          resolve(JSON.parse(elem.dataset.result))\n        }\n        document.body.removeChild(elem)\n      }\n    }, 100)\n    setTimeout(function () {\n      if (timerId) {\n        clearInterval(timerId)\n        reject(Error('The injected script was timeout'))\n      }\n    }, timeout || 5000)\n  })\n}\n\nlet injectScript = function (promise) {\n  let n = Math.floor(Math.random() * 1000000)\n  let id = `kzaex_run_in_page_${n}`\n  let s = document.createElement('script')\n  s.id = id\n  s.text = `\n    (function() {\n      var promise = ${promise.toString()};\n      var script = document.getElementById(\"${id}\");\n      promise.then(function(result, reject) {\n        script.dataset.result = JSON.stringify(result);\n        script.dataset.done = 'true';\n      }).catch(function(e) {\n        script.dataset.error = e.message;\n        script.dataset.done = 'true';\n      })\n    })();\n    `\n  document.body.appendChild(s)\n  return id\n}\n\nexport function run (script, timeout) {\n  let id = injectScript(`\n    new Promise(function(resolve, reject) {\n      try {\n        resolve((${script.toString()})());\n      } catch(e) {\n        reject(e);\n      }\n    });\n    `)\n  return waitScriptResult(id, timeout)\n}\n\nexport function runWithCallback (script, timeout) {\n  let id = injectScript(`\n    new Promise(function(resolve, reject) {\n      try {\n        (${script.toString()})(function(result) {\n          resolve(result);\n        });\n      } catch(e) {\n        reject(e);\n      }\n    });\n  `)\n  return waitScriptResult(id, timeout)\n}\n\n\n\u4f7f\u3044\u65b9\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\nimport * as windowContextRunner from './windowContextRunner.js'\n\nwindowContextRunner.run(function() {\n  // Do something and return the result\n  var result = 1;\n  return result;\n}).then(function(result) {\n  // Use the result of the function above\n  result == 1\n});\n\n\u30a8\u30e9\u30fc\u30cf\u30f3\u30c9\u30ea\u30f3\u30b0\u306a\u3069\u306f\u7279\u306b\u3053\u3053\u3067\u306f\u6df1\u304f\u5b9f\u88c5\u3057\u3066\u3044\u307e\u305b\u3093\u304c\u3001\u7c21\u5358\u306b\u8ffd\u52a0\u3067\u304d\u308b\u3068\u601d\u3046\u306e\u3067\u7528\u9014\u306b\u5fdc\u3058\u3066\u8ffd\u52a0\u3057\u3066\u304f\u3060\u3055\u3044\uff01\n# Background\n\nChrome Extension\u306eContent Script\u3067\u306fcontext\u304c\u30da\u30fc\u30b8\u4e0a\u3067\u5b9f\u884c\u3055\u308c\u3066\u3044\u308bJS\u3068\u306f\u9055\u3046\u305f\u3081`window`\u7d4c\u7531\u3067\u5909\u6570\u53d6\u5f97\u3084\u95a2\u6570\u5b9f\u884c\u304c\u3067\u304d\u307e\u305b\u3093\u3002\n\n`window`\u30b3\u30f3\u30c6\u30ad\u30b9\u30c8\u3067\u95a2\u6570\u3092\u5b9f\u884c\u3059\u308b\u65b9\u6cd5\u306f\n\nhttp://qiita.com/suin/items/5e1aa942e654bce442f7\n\u3084\nhttp://stackoverflow.com/questions/20499994/access-window-variable-from-content-script\n\n\u306a\u3069\u3044\u308d\u3044\u308d\u3042\u308a\u307e\u3059\u304c\u3001\u7d50\u679c\u3092\u53d6\u5f97\u3059\u308b\u4f8b\u306f\u898b\u3064\u304b\u3089\u306a\u304b\u3063\u305f\u306e\u3067\u81ea\u5206\u3067\u4f5c\u3063\u3066\u307f\u307e\u3057\u305f\u3002\n\n# Solution\n\nGist: https://gist.github.com/dtaniwaki/b2b29a95b98f593ffd57\n\n\u95a2\u6570\u3092\u5b9f\u884c\u3057\u305f\u5f8c\u3067\u305d\u306e\u7d50\u679c\u3092\u633f\u5165\u3057\u305f`script`\u30bf\u30b0\u306e`dataset`\u306bJSON\u306b\u30b7\u30ea\u30a2\u30e9\u30a4\u30ba\u3057\u3066\u683c\u7d0d\u3057\u3001content script\u5074\u304b\u3089\u540c\u3058ID\u306e`script`\u3092\u63a2\u3057\u3066\u30c7\u30b7\u30ea\u30a2\u30e9\u30a4\u30ba\u3057\u3066\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u306b\u7d50\u679c\u3092\u6e21\u3057\u3066\u3044\u307e\u3059\u3002\n\n```js:windowContextRunner.js\n'use strict'\n\nlet waitScriptResult = function (id, timeout) {\n  return new Promise(function (resolve, reject) {\n    let timerId\n    timerId = setInterval(function () {\n      let elem = document.getElementById(id)\n      if (typeof elem !== 'undefined' && typeof elem.dataset.done !== 'undefined') {\n        clearInterval(timerId)\n        timerId = null\n        if (typeof elem.dataset.error !== 'undefined' && elem.dataset.error !== '') {\n          reject(Error(elem.dataset.error))\n        } else {\n          resolve(JSON.parse(elem.dataset.result))\n        }\n        document.body.removeChild(elem)\n      }\n    }, 100)\n    setTimeout(function () {\n      if (timerId) {\n        clearInterval(timerId)\n        reject(Error('The injected script was timeout'))\n      }\n    }, timeout || 5000)\n  })\n}\n\nlet injectScript = function (promise) {\n  let n = Math.floor(Math.random() * 1000000)\n  let id = `kzaex_run_in_page_${n}`\n  let s = document.createElement('script')\n  s.id = id\n  s.text = `\n    (function() {\n      var promise = ${promise.toString()};\n      var script = document.getElementById(\"${id}\");\n      promise.then(function(result, reject) {\n        script.dataset.result = JSON.stringify(result);\n        script.dataset.done = 'true';\n      }).catch(function(e) {\n        script.dataset.error = e.message;\n        script.dataset.done = 'true';\n      })\n    })();\n    `\n  document.body.appendChild(s)\n  return id\n}\n\nexport function run (script, timeout) {\n  let id = injectScript(`\n    new Promise(function(resolve, reject) {\n      try {\n        resolve((${script.toString()})());\n      } catch(e) {\n        reject(e);\n      }\n    });\n    `)\n  return waitScriptResult(id, timeout)\n}\n\nexport function runWithCallback (script, timeout) {\n  let id = injectScript(`\n    new Promise(function(resolve, reject) {\n      try {\n        (${script.toString()})(function(result) {\n          resolve(result);\n        });\n      } catch(e) {\n        reject(e);\n      }\n    });\n  `)\n  return waitScriptResult(id, timeout)\n}\n```\n\n\u4f7f\u3044\u65b9\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\n\n```js\nimport * as windowContextRunner from './windowContextRunner.js'\n\nwindowContextRunner.run(function() {\n  // Do something and return the result\n  var result = 1;\n  return result;\n}).then(function(result) {\n  // Use the result of the function above\n  result == 1\n});\n```\n\n\u30a8\u30e9\u30fc\u30cf\u30f3\u30c9\u30ea\u30f3\u30b0\u306a\u3069\u306f\u7279\u306b\u3053\u3053\u3067\u306f\u6df1\u304f\u5b9f\u88c5\u3057\u3066\u3044\u307e\u305b\u3093\u304c\u3001\u7c21\u5358\u306b\u8ffd\u52a0\u3067\u304d\u308b\u3068\u601d\u3046\u306e\u3067\u7528\u9014\u306b\u5fdc\u3058\u3066\u8ffd\u52a0\u3057\u3066\u304f\u3060\u3055\u3044\uff01\n"}