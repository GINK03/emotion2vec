{"context": "\n\n\u3084\u308a\u305f\u3044\u3053\u3068\n\nCloudFormation\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u3092\u5b9f\u884c\u3059\u308b\u3060\u3051\u3067\u30c6\u30b9\u30c8\u30b7\u30ca\u30ea\u30aa\u3092\u5b9f\u884c\u3059\u308b\u305f\u3081\u306eMaster\uff08Windows\uff09\u3068Slave\uff08Amazon Linux\uff09\u304c\u69cb\u7bc9\u3055\u308c\u307e\u3059\u3002(\u5f8c\u3005CentOS\u306b\u5909\u308f\u308a\u307e\u3059w)\n\n\u305d\u306e\u305f\u3081 \u5358\u4e00\u306eJMeter\u30de\u30b7\u30f3\u3067\u306f\u304b\u3051\u3089\u308c\u306a\u3044\u3088\u3046\u306a\u8ca0\u8377\u3092\u7c21\u5358\u306b\u304b\u3051\u308b\u3053\u3068\u304c\u51fa\u6765\u307e\u3059\u3002\n\n\n\n\nclassmethod\u69d8\u306efullbok\u3092\u4f7f\u3046\nhttps://github.com/classmethod-aws/fullbok\n\n\u53c2\u8003\u8cc7\u6599\nhttp://dev.classmethod.jp/cloud/aws/aws-cfn-advent-calendar-2013-fullbok/\nhttp://dev.classmethod.jp/study_meeting/cm-regrowth-2014-fullbok/\n\n1.cloudformation\u6e96\u5099\n\ns3\u306b fullbok\u304b\u3089\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u3092\u8ffd\u52a0\n\n\n2.\u5b9f\u884c\u3059\u308bjenkins\u306e\u6e96\u5099\n\u5b9f\u884c\u3059\u308bjob\u3092\u4f5c\u6210\n## Jenkins shell\n#!/bin/bash -xv\n\nset -eu\n\n# power user\nexport AWS_ACCESS_KEY_ID=xxxxxxxxxxx\nexport AWS_SECRET_ACCESS_xxxxxxxxxxxxxxxxxx\n\nexport AWS_DEFAULT_REGION=ap-northeast-1\n\n\naws cloudformation create-stack --stack-name gozuqi-fullbok \\\n    --template-url https://s3-ap-northeast-1.amazonaws.com/fullbok/fullbok.template \\\n    --parameters \\\n    ParameterKey=AvailabilityZone,ParameterValue=ap-northeast-1a \\\n    ParameterKey=KeyName,ParameterValue=local.pem \\\n    ParameterKey=MasterInstanceAMI,ParameterValue=ami-ff435e91 \\\n    ParameterKey=MasterInstanceType,ParameterValue=t2.medium \\\n    ParameterKey=SlaveCapacity,ParameterValue=2 \\\n    ParameterKey=SlaveInstanceType,ParameterValue=c3.large \\\n    ParameterKey=SlaveSpotPrice,ParameterValue=0.5 \\\n    ParameterKey=SSHFrom,ParameterValue=0.0.0.0/0 \\\n    --capabilities CAPABILITY_IAM\n\naws cloudformation wait stack-create-complete --stack-name gozuqi-fullbok\n\n\n3.\u5b9f\u884c\n\u3093\uff1f \u52d5\u304b\u306a\u3044\u3002\u3002\u3002\u3002\nunbound\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u306b\u5931\u6557\u3057\u3066\u3044\u308b\u3088\u3046\u3060\u3002\u3002\u3002\n\u8abf\u3079\u3066\u307f\u308b\u3068\u3001\nhttp://kiq.biz/news/post175.html\n\u307f\u305f\u3044\u306a\u3088\u3046\u3060\u3002\n\u306a\u3089AmazonLinux\u3063\u3066CentOS\u3060\u3057CentOS\u3067\u52d5\u304f\u3088\u3046\u306b\u30ec\u30b7\u30d4\u3092\u4fee\u6b63\n\n\u3067\u304d\u3042\u304c\u3063\u305f\u30ec\u30b7\u30d4\u304c\u3053\u3061\u3089\n{\n  \"AWSTemplateFormatVersion\": \"2010-09-09\",\n  \"Description\" : \"fullbok - JMeter cluster CloudFormation template file.\",\n  \"Parameters\": {\n    \"KeyName\": {\n      \"Description\": \"Name of an existing EC2 KeyPair to enable SSH access to the instances\",\n      \"Type\": \"String\",\n      \"MinLength\": \"1\",\n      \"MaxLength\": \"64\",\n      \"AllowedPattern\": \"[-_ a-zA-Z0-9]*\",\n      \"ConstraintDescription\": \"can contain only alphanumeric characters, spaces, dashes and underscores.\"\n    },\n    \"AvailabilityZone\": {\n      \"Default\" : \"ap-northeast-1a\",\n      \"Description\" : \"Availability zone of Jmeter subnet.\",\n      \"Type\": \"String\",\n      \"MinLength\": \"1\",\n      \"MaxLength\": \"64\",\n      \"AllowedPattern\": \"[-_ a-zA-Z0-9]*\"\n    },\n    \"SSHFrom\" : {\n      \"Default\" : \"0.0.0.0/0\",\n      \"Description\" : \"Lockdown SSH/RDP access to the bastion host (default can be accessed from anywhere)\",\n      \"Type\" : \"String\",\n      \"MinLength\": \"9\",\n      \"MaxLength\": \"18\",\n      \"AllowedPattern\" : \"(\\\\d{1,3})\\\\.(\\\\d{1,3})\\\\.(\\\\d{1,3})\\\\.(\\\\d{1,3})/(\\\\d{1,2})\",\n      \"ConstraintDescription\" : \"must be a valid CIDR range of the form x.x.x.x/x.\"\n    },\n    \"MasterInstanceAMI\" : {\n      \"Description\" : \"AMI ID of Master instance (Microsoft Windows Server 2012 RTM 64-bit)\",\n      \"Type\" : \"String\",\n      \"MinLength\": \"12\",\n      \"MaxLength\": \"12\",\n      \"AllowedPattern\" : \"ami-[a-zA-Z0-9]*\"\n    },\n    \"MasterInstanceType\": {\n      \"Default\": \"m1.medium\",\n      \"Description\": \"JMeter master EC2 instance type\",\n      \"Type\": \"String\",\n      \"ConstraintDescription\": \"must be a valid EC2 instance type.\"\n    },\n    \"SlaveInstanceType\": {\n      \"Default\": \"m1.small\",\n      \"Description\": \"JMeter slave EC2 instance type\",\n      \"Type\": \"String\",\n      \"ConstraintDescription\": \"must be a valid EC2 instance type.\"\n    },\n    \"SlaveCapacity\" : {\n      \"Default\" : \"2\",\n      \"Description\" : \"Number of EC2 instances to launch for the jmeter slave.\",\n      \"Type\" : \"Number\",\n      \"MinValue\": \"1\"\n    },\n    \"SlaveSpotPrice\" : {\n      \"Default\" : \"0\",\n      \"Description\" : \"Spot price for the jmeter slave.\",\n      \"Type\" : \"Number\"\n    }\n  },\n  \"Mappings\": {\n    \"AWSAmazonLinuxAMI\": {\n      \"us-east-1\":      { \"name\":\"Virginia\",   \"64\": \"ami-35792c5c\" , \"64HVM\" : \"ami-69792c00\" },\n      \"us-west-2\":      { \"name\":\"Oregon\",     \"64\": \"ami-d03ea1e0\" , \"64HVM\" : \"ami-e43ea1d4\" },\n      \"us-west-1\":      { \"name\":\"California\", \"64\": \"ami-687b4f2d\" , \"64HVM\" : \"ami-4e7b4f0b\" },\n      \"eu-west-1\":      { \"name\":\"Ireland\",    \"64\": \"ami-149f7863\" , \"64HVM\" : \"ami-209f7857\" },\n      \"ap-southeast-1\": { \"name\":\"Singapole\",  \"64\": \"ami-14f2b946\" , \"64HVM\" : \"ami-6af2b938\" },\n      \"ap-southeast-2\": { \"name\":\"Sydney\",     \"64\": \"ami-a148d59b\" , \"64HVM\" : \"ami-a948d593\" },\n      \"ap-northeast-1\": { \"name\":\"Tokyo\",      \"64\": \"ami-507f9631\" , \"64HVM\" : \"ami-600ae001\" },\n      \"sa-east-1\":      { \"name\":\"SaoPaulo\",   \"64\": \"ami-9f6ec982\" , \"64HVM\" : \"ami-9d6ec980\" }\n    },\n    \"StackConfig\" : {\n      \"VPC\"               : { \"CIDR\" : \"10.0.0.0/16\" },\n      \"JMeterSubnet\"      : { \"CIDR\" : \"10.0.0.0/24\" },\n      \"JMeter\"            : { \"URL\": \"http://archive.apache.org/dist/jmeter/binaries/apache-jmeter-2.10.tgz\" }\n    },\n    \"SlaveInstanceSetting\": {\n        \"m3.medium\":     { \"type\": \"64HVM\" , \"HEAP\": \"-Xms2G -Xmx2G\"     ,\"NEW\": \"-XX:NewSize=512m -XX:MaxNewSize=1G\"   },\n        \"m3.large\":      { \"type\": \"64HVM\" , \"HEAP\": \"-Xms4G -Xmx4G\"     ,\"NEW\": \"-XX:NewSize=1G   -XX:MaxNewSize=2G\"   },\n        \"m3.xlarge\":     { \"type\": \"64HVM\" , \"HEAP\": \"-Xms4G -Xmx4G\"     ,\"NEW\": \"-XX:NewSize=1G   -XX:MaxNewSize=2G\"   },\n        \"m3.2xlarge\":    { \"type\": \"64HVM\" , \"HEAP\": \"-Xms4G -Xmx4G\"     ,\"NEW\": \"-XX:NewSize=1G   -XX:MaxNewSize=2G\"   },\n        \"r3.large\":      { \"type\": \"64HVM\" , \"HEAP\": \"-Xms4G -Xmx4G\"     ,\"NEW\": \"-XX:NewSize=1G   -XX:MaxNewSize=2G\"   },\n        \"r3.xlarge\":     { \"type\": \"64HVM\" , \"HEAP\": \"-Xms4G -Xmx4G\"     ,\"NEW\": \"-XX:NewSize=1G   -XX:MaxNewSize=2G\"   },\n        \"r3.2xlarge\":    { \"type\": \"64HVM\" , \"HEAP\": \"-Xms4G -Xmx4G\"     ,\"NEW\": \"-XX:NewSize=1G   -XX:MaxNewSize=2G\"   },\n        \"r3.4xlarge\":    { \"type\": \"64HVM\" , \"HEAP\": \"-Xms4G -Xmx4G\"     ,\"NEW\": \"-XX:NewSize=1G   -XX:MaxNewSize=2G\"   },\n        \"r3.8xlarge\":    { \"type\": \"64HVM\" , \"HEAP\": \"-Xms4G -Xmx4G\"     ,\"NEW\": \"-XX:NewSize=1G   -XX:MaxNewSize=2G\"   },\n        \"m1.small\":      { \"type\": \"64\"    , \"HEAP\": \"-Xms1G -Xmx1G\"     ,\"NEW\": \"-XX:NewSize=256m -XX:MaxNewSize=512m\" },\n        \"m1.medium\":     { \"type\": \"64\"    , \"HEAP\": \"-Xms2G -Xmx2G\"     ,\"NEW\": \"-XX:NewSize=512m -XX:MaxNewSize=1G\"   },\n        \"m1.large\":      { \"type\": \"64\"    , \"HEAP\": \"-Xms4G -Xmx4G\"     ,\"NEW\": \"-XX:NewSize=1G   -XX:MaxNewSize=2G\"   },\n        \"m1.xlarge\":     { \"type\": \"64\"    , \"HEAP\": \"-Xms4G -Xmx4G\"     ,\"NEW\": \"-XX:NewSize=1G   -XX:MaxNewSize=2G\"   },\n        \"c3.large\":      { \"type\": \"64HVM\" , \"HEAP\": \"-Xms2G -Xmx2G\"     ,\"NEW\": \"-XX:NewSize=512m -XX:MaxNewSize=1G\"   },\n        \"c3.xlarge\":     { \"type\": \"64HVM\" , \"HEAP\": \"-Xms4G -Xmx4G\"     ,\"NEW\": \"-XX:NewSize=1G   -XX:MaxNewSize=2G\"   },\n        \"c3.2xlarge\":    { \"type\": \"64HVM\" , \"HEAP\": \"-Xms4G -Xmx4G\"     ,\"NEW\": \"-XX:NewSize=1G   -XX:MaxNewSize=2G\"   },\n        \"c3.4xlarge\":    { \"type\": \"64HVM\" , \"HEAP\": \"-Xms4G -Xmx4G\"     ,\"NEW\": \"-XX:NewSize=1G   -XX:MaxNewSize=2G\"   },\n        \"c3.8xlarge\":    { \"type\": \"64HVM\" , \"HEAP\": \"-Xms4G -Xmx4G\"     ,\"NEW\": \"-XX:NewSize=1G   -XX:MaxNewSize=2G\"   },\n        \"c1.medium\":     { \"type\": \"64\"    , \"HEAP\": \"-Xms1G -Xmx1G\"     ,\"NEW\": \"-XX:NewSize=256m -XX:MaxNewSize=512m\" },\n        \"c1.xlarge\":     { \"type\": \"64\"    , \"HEAP\": \"-Xms4G -Xmx4G\"     ,\"NEW\": \"-XX:NewSize=1G   -XX:MaxNewSize=2G\"   },\n        \"cc2.8xlarge\":   { \"type\": \"64\"    , \"HEAP\": \"-Xms4G -Xmx4G\"     ,\"NEW\": \"-XX:NewSize=1G   -XX:MaxNewSize=2G\"   },\n        \"m2.xlarge\":     { \"type\": \"64\"    , \"HEAP\": \"-Xms4G -Xmx4G\"     ,\"NEW\": \"-XX:NewSize=1G   -XX:MaxNewSize=2G\"   },\n        \"m2.2xlarge\":    { \"type\": \"64\"    , \"HEAP\": \"-Xms4G -Xmx4G\"     ,\"NEW\": \"-XX:NewSize=1G   -XX:MaxNewSize=2G\"   },\n        \"m2.4xlarge\":    { \"type\": \"64\"    , \"HEAP\": \"-Xms4G -Xmx4G\"     ,\"NEW\": \"-XX:NewSize=1G   -XX:MaxNewSize=2G\"   },\n        \"cr1.8xlarge\":   { \"type\": \"64HVM\" , \"HEAP\": \"-Xms4G -Xmx4G\"     ,\"NEW\": \"-XX:NewSize=1G   -XX:MaxNewSize=2G\"   },\n        \"hi1.4xlarge\":   { \"type\": \"64HVM\" , \"HEAP\": \"-Xms4G -Xmx4G\"     ,\"NEW\": \"-XX:NewSize=1G   -XX:MaxNewSize=2G\"   },\n        \"hs1.8xlarge\":   { \"type\": \"64HVM\" , \"HEAP\": \"-Xms4G -Xmx4G\"     ,\"NEW\": \"-XX:NewSize=1G   -XX:MaxNewSize=2G\"   },\n        \"t1.micro\":      { \"type\": \"64\"    , \"HEAP\": \"-Xms256M -Xmx256M\" ,\"NEW\": \"-XX:NewSize=128m -XX:MaxNewSize=128m\" },\n        \"g2.2xlarge\":    { \"type\": \"64\"    , \"HEAP\": \"-Xms4G -Xmx4G\"     ,\"NEW\": \"-XX:NewSize=1G   -XX:MaxNewSize=2G\"   },\n        \"cg1.4xlarge\":   { \"type\": \"64\"    , \"HEAP\": \"-Xms4G -Xmx4G\"     ,\"NEW\": \"-XX:NewSize=1G   -XX:MaxNewSize=2G\"   }\n    }\n  },\n  \"Conditions\" : {\n    \"UseSpotInstance\" : { \"Fn::Not\": [ { \"Fn::Equals\" : [ {\"Ref\" : \"SlaveSpotPrice\"}, \"0\" ] } ] }\n  },\n  \"Resources\": {\n    \"PowerUserRole\" : {\n      \"Type\" : \"AWS::IAM::Role\",\n      \"Properties\" : {\n        \"AssumeRolePolicyDocument\" : {\n          \"Statement\": [ {\n            \"Effect\": \"Allow\",\n              \"Principal\": {\n                \"Service\": [ \"ec2.amazonaws.com\" ]\n              },\n              \"Action\": [ \"sts:AssumeRole\" ]\n          } ]\n        },\n        \"Path\" : \"/\",\n        \"Policies\" :[ {\n          \"PolicyName\" : \"PowerUserPolicy\",\n          \"PolicyDocument\" : {\n            \"Statement\": [ {\n              \"Sid\": \"PowerUserStmt\",\n              \"Effect\": \"Allow\",\n              \"NotAction\": \"iam:*\",\n              \"Resource\": \"*\"\n            } ]\n          }\n        }]\n      }\n    },\n    \"PowerUserProfile\" : {\n      \"Type\" : \"AWS::IAM::InstanceProfile\",\n      \"Properties\" : {\n        \"Path\": \"/\",\n        \"Roles\" : [ { \"Ref\" : \"PowerUserRole\" } ]\n      }\n    },\n\n    \"VPC\" : {\n      \"Type\" : \"AWS::EC2::VPC\",\n      \"Properties\" : {\n        \"CidrBlock\" : { \"Fn::FindInMap\" : [ \"StackConfig\", \"VPC\", \"CIDR\" ]},\n        \"EnableDnsHostnames\" : \"true\",\n        \"InstanceTenancy\" : \"default\",\n        \"Tags\" : [\n          {\"Key\" : \"Application\", \"Value\" : { \"Ref\" : \"AWS::StackId\" } },\n          {\"Key\" : \"Network\", \"Value\" : \"Public\" }\n        ]\n      }\n    },\n    \"InternetGateway\" : {\n      \"Type\" : \"AWS::EC2::InternetGateway\",\n      \"Properties\" : {\n        \"Tags\" : [\n          {\"Key\" : \"Application\", \"Value\" : { \"Ref\" : \"AWS::StackId\" } },\n          {\"Key\" : \"Network\", \"Value\" : \"Public\" }\n        ]\n      }\n    },\n    \"AttachGateway\" : {\n      \"Type\" : \"AWS::EC2::VPCGatewayAttachment\",\n      \"Properties\" : {\n        \"VpcId\" : {\"Ref\" : \"VPC\"},\n        \"InternetGatewayId\" : {\"Ref\" : \"InternetGateway\"}\n      }\n    },\n\n    \"PublicRouteTable\" : {\n      \"Type\" : \"AWS::EC2::RouteTable\",\n      \"DependsOn\" : \"AttachGateway\",\n      \"Properties\" : {\n        \"VpcId\" : { \"Ref\" : \"VPC\" },\n        \"Tags\" : [\n          {\"Key\" : \"Application\", \"Value\" : { \"Ref\" : \"AWS::StackId\"} },\n          {\"Key\" : \"Network\", \"Value\" : \"Public\" }\n        ]\n      }\n    },\n    \"PublicRoute\" : {\n      \"Type\" : \"AWS::EC2::Route\",\n      \"DependsOn\" : \"AttachGateway\",\n      \"Properties\" : {\n        \"RouteTableId\" : { \"Ref\" : \"PublicRouteTable\" },\n        \"DestinationCidrBlock\" : \"0.0.0.0/0\",\n        \"GatewayId\" : { \"Ref\" : \"InternetGateway\" }\n      }\n    },\n\n    \"JMeterSubnet\": {\n      \"Type\": \"AWS::EC2::Subnet\",\n      \"DependsOn\" : \"AttachGateway\",\n      \"Properties\": {\n        \"VpcId\": { \"Ref\": \"VPC\" },\n        \"AvailabilityZone\": { \"Ref\": \"AvailabilityZone\" },\n        \"CidrBlock\": { \"Fn::FindInMap\" : [ \"StackConfig\", \"JMeterSubnet\", \"CIDR\" ]},\n        \"Tags\" : [\n          {\"Key\" : \"Application\", \"Value\" : { \"Ref\" : \"AWS::StackId\" } },\n          {\"Key\" : \"Network\", \"Value\" : \"Public\" }\n        ]\n      }\n    },\n    \"JMeterSubnetRouteTableAssociation\" : {\n      \"Type\" : \"AWS::EC2::SubnetRouteTableAssociation\",\n      \"Properties\" : {\n        \"SubnetId\" : { \"Ref\" : \"JMeterSubnet\" },\n        \"RouteTableId\" : { \"Ref\" : \"PublicRouteTable\" }\n      }\n    },\n\n    \"VPCDefaultSecurityGroup\" : {\n      \"Type\" : \"AWS::EC2::SecurityGroup\",\n      \"Properties\" : {\n        \"VpcId\" : { \"Ref\" : \"VPC\" },\n        \"GroupDescription\" : \"Allow all communications in VPC\",\n        \"SecurityGroupIngress\" : [\n          { \"IpProtocol\" : \"tcp\", \"FromPort\" : \"0\", \"ToPort\" : \"65535\", \"CidrIp\" : { \"Fn::FindInMap\" : [ \"StackConfig\", \"VPC\", \"CIDR\" ]} },\n          { \"IpProtocol\" : \"udp\", \"FromPort\" : \"0\", \"ToPort\" : \"65535\", \"CidrIp\" : { \"Fn::FindInMap\" : [ \"StackConfig\", \"VPC\", \"CIDR\" ]} },\n          { \"IpProtocol\" : \"icmp\", \"FromPort\" : \"-1\", \"ToPort\" : \"-1\",  \"CidrIp\" : { \"Fn::FindInMap\" : [ \"StackConfig\", \"VPC\", \"CIDR\" ]} }\n        ]\n      }\n    },\n    \"SSHSecurityGroup\" : {\n      \"Type\" : \"AWS::EC2::SecurityGroup\",\n      \"Properties\" : {\n        \"VpcId\" : { \"Ref\" : \"VPC\" },\n        \"GroupDescription\" : \"Enable SSH access via port 22\",\n        \"SecurityGroupIngress\" : [\n          { \"IpProtocol\" : \"tcp\", \"FromPort\" : \"22\",  \"ToPort\" : \"22\",  \"CidrIp\" : { \"Ref\" : \"SSHFrom\" }}\n        ]\n      }\n    },\n    \"RDPSecurityGroup\" : {\n      \"Type\" : \"AWS::EC2::SecurityGroup\",\n      \"Properties\" : {\n        \"VpcId\" : { \"Ref\" : \"VPC\" },\n        \"GroupDescription\" : \"Enable RDP\",\n        \"SecurityGroupIngress\" : [\n          {\"IpProtocol\" : \"tcp\", \"FromPort\" : \"3389\", \"ToPort\" : \"3389\", \"CidrIp\" : { \"Ref\" : \"SSHFrom\" }}\n        ]\n      }\n    },\n\n    \"SlaveFleet\" : {\n      \"Type\" : \"AWS::AutoScaling::AutoScalingGroup\",\n      \"Properties\" : {\n        \"AvailabilityZones\" : [\n          { \"Ref\" : \"AvailabilityZone\" }\n        ],\n        \"VPCZoneIdentifier\" : [\n          { \"Ref\" : \"JMeterSubnet\" }\n        ],\n        \"LaunchConfigurationName\" : { \"Ref\" : \"SlaveInstanceLaunchConfig\"  },\n        \"MinSize\" : { \"Ref\" : \"SlaveCapacity\" },\n        \"MaxSize\" : { \"Ref\" : \"SlaveCapacity\" },\n        \"DesiredCapacity\" : { \"Ref\" : \"SlaveCapacity\" },\n        \"Tags\" : [\n          { \"Key\" : \"Name\", \"Value\" : \"JMeterSlave\", \"PropagateAtLaunch\" : \"true\" },\n          { \"Key\" : \"Network\", \"Value\" : \"Public\", \"PropagateAtLaunch\" : \"true\" }\n        ]\n      }\n    },\n    \"SlaveInstanceLaunchConfig\"  : {\n      \"Type\" : \"AWS::AutoScaling::LaunchConfiguration\",\n      \"Properties\" : {\n        \"InstanceType\": { \"Ref\" : \"SlaveInstanceType\" },\n        \"SpotPrice\" : { \"Fn::If\" : [ \"UseSpotInstance\", {\"Ref\" : \"SlaveSpotPrice\"},  { \"Ref\" : \"AWS::NoValue\" } ] },\n        \"KeyName\": { \"Ref\" : \"KeyName\" },\n        \"ImageId\": { \"Fn::FindInMap\": [ \"AWSAmazonLinuxAMI\", { \"Ref\": \"AWS::Region\" }, { \"Fn::FindInMap\": [ \"SlaveInstanceSetting\", { \"Ref\": \"SlaveInstanceType\" }, \"type\" ]} ]},\n        \"SecurityGroups\": [\n          { \"Ref\" : \"SSHSecurityGroup\" },\n          { \"Ref\" : \"VPCDefaultSecurityGroup\" }\n        ],\n        \"IamInstanceProfile\": { \"Ref\" : \"PowerUserProfile\" },\n        \"InstanceMonitoring\" : \"false\",\n        \"AssociatePublicIpAddress\" : \"true\",\n        \"UserData\" : { \"Fn::Base64\" : { \"Fn::Join\" : [\"\", [\n          \"#! /bin/bash -v\\n\",\n          \"yum update -y\\n\",\n          \"yum install -y epel-release python-pip wget gcc make zlib-devel openssl-devel\\n\",\n\n\n          \"python -V\\n\",\n          \"export PATH=$PATH:/opt/aws/bin\\n\",\n          \"export PATH\\n\",\n\n\n          \"# Install aws-cli\\n\",\n          \"pip install pystache\\n\",\n          \"pip install argparse\\n\",\n          \"pip install python-daemon\\n\",\n          \"pip install requests\\n\",\n          \"pip install awscli\\n\",\n          \"yum -y update\\n\",\n          \"cd /opt\\n\",\n          \"curl -O https://s3.amazonaws.com/cloudformation-examples/aws-cfn-bootstrap-latest.tar.gz\\n\",\n          \"tar -xvpf aws-cfn-bootstrap-latest.tar.gz\\n\",\n          \"cd aws-cfn-bootstrap-1.4/\\n\",\n          \"python setup.py build\\n\",\n          \"python setup.py install\\n\",\n          \"chmod 775 /opt/aws-cfn-bootstrap-1.4/bin/*\\n\",\n          \"cd /opt\\n\",\n          \"mkdir aws\\n\",\n          \"cd aws\\n\",\n          \"ln -s /opt/aws-cfn-bootstrap-1.4/bin /opt/aws/\\n\",\n\n\n          \"# Continuous Release Repository setting for unbound\\n\",\n          \"yum install -y java-1.7.0-openjdk\\n\",\n          \"yum install -y java-1.7.0-openjdk-devel\\n\", \n          \"# Install local dns resolver\\n\",\n          \"yum install -y unbound\\n\",\n          \"sed -i 's/val-permissive-mode: .*/val-permissive-mode: yes/g' /etc/unbound/unbound.conf\\n\",\n          \"echo -e 'forward-zone:\\n\\tname: \", { \"Ref\": \"AWS::Region\" } ,\".compute.internal\\n\\tforward-addr: 10.0.0.2' >> /etc/unbound/unbound.conf\\n\",\n          \"service unbound start\\n\",\n          \"chkconfig unbound on\\n\",\n          \"sed -i 's/PEERDNS=yes/PEERDNS=no/g' /etc/sysconfig/network-scripts/ifcfg-eth0\\n\",\n          \"sed -i 's/nameserver .*/nameserver 127.0.0.1/g' /etc/resolv.conf\\n\",\n\n          \"# Helper function\\n\",\n          \"function error_exit\\n\",\n          \"{\\n\",\n          \"  /opt/aws/bin/cfn-signal -e 1 -r \\\"$1\\\" '\", { \"Ref\" : \"SlaveWaitHandle\" }, \"'\\n\",\n          \"  exit 1\\n\",\n          \"}\\n\",\n\n          \"# Install packages\\n\",\n          \"/opt/aws/bin/cfn-init -v -s \", { \"Ref\" : \"AWS::StackId\" }, \" -r SlaveInstanceLaunchConfig \",\n          \"    --region \", { \"Ref\" : \"AWS::Region\" }, \"\\n\",\n\n          \"sysctl -p\\n\",\n\n          \"echo \\\"/opt/apache-jmeter-2.10/bin/jmeter-server | logger -p daemon.info &\\\" >>/etc/rc.local\\n\",\n          \"sh /opt/apache-jmeter-2.10/bin/jmeter -s -n &\",\n\n          \"# All is well so signal success\\n\",\n          \"/opt/aws/bin/cfn-signal -e $? -r \\\"SlaveInstanceLaunchConfig setup complete\\\" '\", { \"Ref\" : \"SlaveWaitHandle\" }, \"'\\n\"\n        ]]}}\n      },\n      \"Metadata\" : {\n        \"AWS::CloudFormation::Init\" : {\n          \"config\" : {\n            \"packages\" : {\n              \"yum\" : {\n              }\n            },\n            \"sources\" : {\n              \"/opt\" : { \"Fn::FindInMap\" : [ \"StackConfig\", \"JMeter\", \"URL\" ]}\n            },\n            \"files\" : {\n              \"/etc/security/limits.conf\" : {\n                \"content\" : { \"Fn::Join\" : [\"\", [\n                  \"# /etc/security/limits.conf\\n\",\n                  \"#\\n\",\n                  \"#Each line describes a limit for a user in the form:\\n\",\n                  \"#\\n\",\n                  \"#\\n\",\n                  \"#<domain>      <type>  <item>         <value>\\n\",\n                  \"#\\n\",\n                  \"\\n\",\n                  \"#*               soft    core            0\\n\",\n                  \"#*               hard    rss             10000\\n\",\n                  \"#@student        hard    nproc           20\\n\",\n                  \"#@faculty        soft    nproc           20\\n\",\n                  \"#@faculty        hard    nproc           50\\n\",\n                  \"#ftp             hard    nproc           0\\n\",\n                  \"#@student        -       maxlogins       4\\n\",\n                  \"\\n\",\n                  \"\\n\",\n                  \"*                hard   nofile           65536\\n\",\n                  \"*                soft   nofile           65536\\n\",\n                  \"*                hard   nproc            8192\\n\",\n                  \"*                soft   nproc            8192\\n\",\n                  \"\\n\",\n                  \"\\n\",\n                  \"\\n\",\n                  \"# End of file\\n\"\n                ]]},\n                \"mode\"  : \"000644\",\n                \"owner\" : \"root\",\n                \"group\" : \"root\"\n              }\n            },\n            \"commands\" : {\n              \"00-use_java7\" : {\n                \"command\" : \"alternatives --set java /usr/lib/jvm/jre-1.7.0-openjdk.x86_64/bin/java\"\n              },\n              \"01-create_hosts_entry-on_boot\" : {\n                \"command\" : \"echo \\\"`curl -s curl http://169.254.169.254/latest/meta-data/local-ipv4` `hostname`\\\" >>/etc/hosts\",\n                \"test\" : \"test ! -f .create_hosts_entry-semaphore\"\n              },\n              \"02-signal_startup_complete\" : {\n                \"command\" : \"touch .create_hosts_entry-semaphore\"\n              },\n              \"03-set_listen_address\" : {\n                \"command\" : { \"Fn::Join\" : [\"\", [\n                  \"sed -i -e \\\"s/^#RMI_HOST_DEF=-Djava.rmi.server.hostname=.*$/RMI_HOST_DEF=-Djava.rmi.server.hostname=$(curl -s http://169.254.169.254/latest/meta-data/local-hostname)/\\\" /opt/apache-jmeter-2.10/bin/jmeter-server\"\n                ]]}\n              },\n              \"03-set_heap\" : {\n                \"command\" : { \"Fn::Join\" : [\"\", [\n                  \"sed -i -e \\\"s/^HEAP/#HEAP/ \\\" -e \\\" /^#HEAP/i HEAP=\\\\\\\"\" , { \"Fn::FindInMap\": [ \"SlaveInstanceSetting\", { \"Ref\": \"SlaveInstanceType\" }, \"HEAP\" ]} , \"\\\\\\\" \\\" /opt/apache-jmeter-2.10/bin/jmeter\"\n                ]]}\n              },\n              \"03-set_new\" : {\n                \"command\" : { \"Fn::Join\" : [\"\", [\n                  \"sed -i -e \\\"s/^NEW/#NEW/ \\\" -e \\\" /^#NEW/i NEW=\\\\\\\"\" , { \"Fn::FindInMap\": [ \"SlaveInstanceSetting\", { \"Ref\": \"SlaveInstanceType\" }, \"NEW\" ]} , \"\\\\\\\" \\\" /opt/apache-jmeter-2.10/bin/jmeter\"\n                ]]}\n              },\n              \"03-add_disabling_dns_caching\" : {\n                \"command\" : \"sed -i -e \\\" /^java/i JVM_ARGS=\\\\\\\"\\\\$JVM_ARGS -Dsun.net.inetaddr.ttl=0\\\\\\\"\\\" /opt/apache-jmeter-2.10/bin/jmeter\"\n              },\n              \"04-tcp_param_tcp_tw_recycle\" : {\n                \"command\" : \"echo \\\"net.ipv4.tcp_tw_recycle = 1\\\" >> /etc/sysctl.conf\"\n              },\n              \"04-tcp_param_tcp_fin_timeout\" : {\n                \"command\" : \"echo \\\"net.ipv4.tcp_fin_timeout = 1\\\" >> /etc/sysctl.conf\"\n              },\n              \"05-nproc_limit\" : {\n                \"command\" : \"sed -i -e \\\"s/ nproc     1024/ nproc     8192/\\\" /etc/security/limits.d/90-nproc.conf\"\n              }\n            }\n          }\n        }\n      }\n    },\n    \"SlaveWaitHandle\" : {\n      \"Type\" : \"AWS::CloudFormation::WaitConditionHandle\"\n    },\n    \"SlaveWaitCondition\" : {\n      \"Type\" : \"AWS::CloudFormation::WaitCondition\",\n      \"DependsOn\" : \"SlaveFleet\",\n      \"Properties\" : {\n        \"Handle\" : {\"Ref\" : \"SlaveWaitHandle\"},\n        \"Timeout\" : \"3600\",\n        \"Count\"   : { \"Ref\" : \"SlaveCapacity\" }\n      }\n    },\n\n    \"MasterInstance\": {\n      \"Type\" : \"AWS::EC2::Instance\",\n      \"Properties\": {\n        \"InstanceType\" : { \"Ref\" : \"MasterInstanceType\" },\n        \"ImageId\" : { \"Ref\": \"MasterInstanceAMI\" },\n        \"NetworkInterfaces\": [{\n          \"DeviceIndex\" : \"0\",\n          \"AssociatePublicIpAddress\" : true,\n          \"DeleteOnTermination\" : true,\n          \"SubnetId\" : { \"Ref\" : \"JMeterSubnet\" },\n          \"GroupSet\" : [\n            { \"Ref\" : \"RDPSecurityGroup\" },\n            { \"Ref\" : \"VPCDefaultSecurityGroup\" }\n          ]\n        }],\n        \"KeyName\" : { \"Ref\" : \"KeyName\" },\n        \"IamInstanceProfile\": { \"Ref\" : \"PowerUserProfile\" },\n        \"Monitoring\" : \"false\",\n        \"Tags\" : [\n          { \"Key\" : \"Name\", \"Value\" : \"JMeterMaster\" },\n          { \"Key\" : \"Network\", \"Value\" : \"Public\" }\n        ],\n        \"UserData\" : { \"Fn::Base64\" : { \"Fn::Join\" : [\"\", [\n          \"<powershell>\\n\",\n          \"cfn-init.exe -v -s \", { \"Ref\" : \"AWS::StackId\" }, \" -r MasterInstance -c create --region \", { \"Ref\" : \"AWS::Region\" }, \"\\n\",\n          \"cfn-signal.exe -e $lastexitcode \", { \"Fn::Base64\" : { \"Ref\" : \"MasterWaitHandle\" }}, \"\\n\",\n          \"</powershell>\"\n        ]]}}\n      },\n      \"Metadata\" : {\n        \"AWS::CloudFormation::Init\" : {\n          \"configSets\" : {\n            \"create\" : [\n              \"setup_cfn_hup\",\n              \"place_scripts\",\n              \"install_jdk\",\n              \"disable_firewall\",\n              \"install_jmeter\",\n              \"setup_jmeter\"\n            ],\n            \"update\" : [\n              \"setup_jmeter\"\n            ]\n          },\n          \"setup_cfn_hup\" : {\n            \"files\" : {\n              \"c:\\\\cfn\\\\cfn-hup.conf\" : {\n                \"content\" : { \"Fn::Join\" : [\"\", [\n                  \"[main]\\n\",\n                  \"stack=\", { \"Ref\" : \"AWS::StackId\" }, \"\\n\",\n                  \"region=\", { \"Ref\" : \"AWS::Region\" }, \"\\n\"\n                ]]}\n              },\n              \"c:\\\\cfn\\\\hooks.d\\\\cfn-auto-reloader.conf\" : {\n                \"content\": { \"Fn::Join\" : [\"\", [\n                  \"[cfn-auto-reloader-hook]\\n\",\n                  \"triggers=post.update\\n\",\n                  \"path=Resources.MasterInstance.Metadata.AWS::CloudFormation::Init\\n\",\n                  \"action=cfn-init.exe -v -s \", { \"Ref\" : \"AWS::StackId\" }, \" -r MasterInstance -c update --region \", { \"Ref\" : \"AWS::Region\" }, \"\\n\"\n                ]]}\n              }\n            },\n            \"services\" : {\n              \"windows\" : {\n                \"cfn-hup\" : {\n                  \"enabled\" : \"true\",\n                  \"ensureRunning\" : \"true\",\n                  \"files\" : [\n                    \"c:\\\\cfn\\\\cfn-hup.conf\",\n                    \"c:\\\\cfn\\\\hooks.d\\\\cfn-auto-reloader.conf\"\n                  ]\n                }\n              }\n            }\n          },\n          \"place_scripts\" : {\n            \"files\" : {\n              \"c:\\\\install_jdk.ps1\" : {\n                \"content\": { \"Fn::Join\" : [\"\", [\n                  \"$client = new-object System.Net.WebClient\\n\",\n                  \"$client.Headers.add(\\\"Cookie\\\", \\\"oraclelicense=accept-securebackup-cookie\\\")\\n\",\n                  \"$client.DownloadFile(\\\"http://download.oracle.com/otn-pub/java/jdk/7u45-b18/jdk-7u45-windows-x64.exe\\\", \\\"C:\\\\Users\\\\Administrator\\\\jdk.exe\\\")\\n\",\n                  \"C:\\\\Users\\\\Administrator\\\\jdk.exe /s /lang=1041 INSTALLDIR=C:\\\\java\\\\jdk1.7.45\\n\",\n                  \"$env:PATH = $env:PATH + \\\";C:\\\\java\\\\jdk1.7.45\\\\bin\\\"\"\n                ]]}\n              },\n              \"c:\\\\create_shortcut.ps1\" : {\n                \"content\": { \"Fn::Join\" : [\"\", [\n                  \"$WshShell = New-Object -comObject WScript.Shell\\n\",\n                  \"$shortcut = $WshShell.CreateShortcut(\\\"C:\\\\Users\\\\Administrator\\\\Desktop\\\\JMeter.lnk\\\")\\n\",\n                  \"$shortcut.TargetPath = \\\"C:\\\\jmeter\\\\apache-jmeter-2.10\\\\bin\\\\jmeterw.cmd\\\"\\n\",\n                  \"$shortcut.WorkingDirectory = \\\"C:\\\\jmeter\\\\apache-jmeter-2.10\\\\bin\\\"\\n\",\n                  \"$shortcut.Save()\\n\"\n                ]]}\n              },\n              \"c:\\\\setupjmetercluster.ps1\" : {\n                \"content\": { \"Fn::Join\" : [\"\", [\n                  \"Set-DefaultAWSRegion \", { \"Ref\" : \"AWS::Region\" }, \"\\n\",\n                  \"$slaves = (Get-ASAutoScalingInstance\",\n                  \" | ? {$_.AutoScalingGroupName -eq \\\"\", { \"Ref\" : \"SlaveFleet\" }, \"\\\"}\",\n                  \" | select -ExpandProperty InstanceId\",\n                  \" | Get-EC2Instance\",\n                  \" | select -ExpandProperty RunningInstance\",\n                  \" | select -ExpandProperty PrivateIpAddress) -join ','\\n\",\n                  \"(Get-Content \\\"C:\\\\jmeter\\\\apache-jmeter-2.10\\\\bin\\\\jmeter.properties\\\")\",\n                  \" | Foreach-Object {$_ -replace '^remote_hosts=.*$', (\\\"remote_hosts=\\\" + $slaves)}\",\n                  \" | Set-Content \\\"C:\\\\jmeter\\\\apache-jmeter-2.10\\\\bin\\\\jmeter.properties\\\"\"\n                ]]}\n              },\n              \"c:\\\\updatejmeter.ps1\" : {\n                \"content\": { \"Fn::Join\" : [\"\", [\n                  \"(Get-Content \\\"C:\\\\jmeter\\\\apache-jmeter-2.10\\\\bin\\\\jmeter.bat\\\") \",\n                  \" | Foreach-Object {$_ -replace '^set HEAP=.*$', (\\\"set HEAP=\" , { \"Fn::FindInMap\": [ \"SlaveInstanceSetting\", { \"Ref\": \"SlaveInstanceType\" }, \"HEAP\" ]} , \"\\\")} \",\n                  \" | Foreach-Object {$_ -replace '^set NEW=.*$', (\\\"set NEW=\" , { \"Fn::FindInMap\": [ \"SlaveInstanceSetting\", { \"Ref\": \"SlaveInstanceType\" }, \"NEW\" ]} , \"\\\")} \",\n                  \" | Set-Content \\\"C:\\\\jmeter\\\\apache-jmeter-2.10\\\\bin\\\\jmeter.bat\\\"\"\n                ]]}\n              }\n            }\n          },\n          \"install_jdk\" : {\n            \"commands\" : {\n              \"install_jdk\" : {\n                \"command\" : \"powershell.exe -ExecutionPolicy Bypass -NoLogo -NonInteractive -NoProfile -WindowStyle Hidden -File c:\\\\install_jdk.ps1\"\n              }\n            }\n          },\n          \"disable_firewall\" : {\n            \"commands\" : {\n              \"disable_firewall\" : {\n                \"command\" : \"netsh advfirewall set allprofiles state off\"\n              }\n            }\n          },\n          \"install_jmeter\" : {\n            \"sources\" : {\n              \"c:\\\\jmeter\" : { \"Fn::FindInMap\" : [ \"StackConfig\", \"JMeter\", \"URL\" ]}\n            },\n            \"commands\" : {\n              \"create_shortcut\" : {\n                \"command\" : \"powershell.exe -ExecutionPolicy Bypass -NoLogo -NonInteractive -NoProfile -WindowStyle Hidden -File c:\\\\create_shortcut.ps1\"\n              }\n            }\n          },\n          \"setup_jmeter\" : {\n            \"commands\" : {\n              \"setup_jmeter_cluster\" : {\n                \"command\" : \"powershell.exe -ExecutionPolicy Bypass -NoLogo -NonInteractive -NoProfile -WindowStyle Hidden -File c:\\\\setupjmetercluster.ps1\"\n              }\n            }\n          },\n          \"setup_jmeter_jvm\" : {\n            \"commands\" : {\n              \"setup_jmeter_jvm_param\" : {\n                \"command\" : \"powershell.exe -ExecutionPolicy Bypass -NoLogo -NonInteractive -NoProfile -WindowStyle Hidden -File c:\\\\updatejmeter.ps1\"\n              }\n            }\n          }\n        }\n      }\n    },\n    \"MasterWaitHandle\" : {\n      \"Type\" : \"AWS::CloudFormation::WaitConditionHandle\"\n    },\n    \"MasterWaitCondition\" : {\n      \"Type\" : \"AWS::CloudFormation::WaitCondition\",\n      \"DependsOn\" : \"MasterInstance\",\n      \"Properties\" : {\n        \"Handle\" : {\"Ref\" : \"MasterWaitHandle\"},\n        \"Timeout\" : \"3600\"\n      }\n    }\n  },\n\n  \"Outputs\": {\n    \"SSHToSlaveInstances\": {\n      \"Value\": { \"Fn::Join\":[\"\", [\n        \"ssh -i /path/to/\", { \"Ref\": \"KeyName\" }, \".pem ec2-user@<ip/hostname>\"\n      ]]},\n      \"Description\": \"SSH command to connect to the JMeter slave instances.\"\n    },\n    \"RDPToMasterInstance\": {\n      \"Value\": { \"Fn::Join\":[\"\", [\n        \"remotedesktop://\", { \"Fn::GetAtt\" : [ \"MasterInstance\", \"PublicDnsName\" ]}\n      ]]},\n      \"Description\": \"RDP connection to the JMeter master.\"\n    }\n  }\n}\n\n\n\u518d\u5ea6\u5b9f\u884c\n\nStatus CREATE_COMPLETE\n\u51fa\u6765\u4e0a\u304c\u3063\u305f\u307f\u305f\u3044\u3067\u3059\u306d\u3002\n\n\n\u6e96\u5099\n\u81ea\u5206\u306fELB\u306b\u3076\u3089\u4e0b\u304c\u3063\u305f\u96c6\u56e3\u30ac\u30a4\u30eb\u306b\u5bfe\u3057\u3066\u8ca0\u8377\u3092\u304b\u3051\u305f\u304b\u3063\u305f\u306e\u3067ELB\u306e\u8a2d\u5b9a\u3002\nMaster\u306fwindows\u306a\u306e\u3067mac\u4f7f\u3063\u3066\u308b\u4eba\u306fRemoteDesctop\u304b\u306a\u3093\u304b\u3067\u30ed\u30b0\u30a4\u30f3\u3057\u3066\u30c6\u30b9\u30c8\u66f8\u3044\u3066\u5b9f\u884c\n\nTest\u5b9f\u884c\nwindows\u3067\u5b9f\u884c\nslave\u304b\u3089\u30c6\u30b9\u30c8\u30b5\u30fc\u30d0\u306b\u6d41\u308c\u3066\u308b\u304b\u78ba\u8a8d\u3059\u308b\n\n\u6383\u9664\u7528Jenkins\n\u74b0\u5883\u524a\u9664job\u3092\u4f5c\u6210\n#!/bin/bash -xv\nset -eu\nexport AWS_ACCESS_KEY_ID=xxxxxxxxxxxxx\nexport AWS_SECRET_ACCESS_KEY=xxxxxxxxxxxxxxxxxx\nexport AWS_DEFAULT_REGION=ap-northeast-1\naws cloudformation delete-stack --stack-name gozuqi-fullbok\naws cloudformation wait stack-delete-complete --stack-name gozuqi-fullbok\n\n\n## \u3084\u308a\u305f\u3044\u3053\u3068\n* CloudFormation\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u3092\u5b9f\u884c\u3059\u308b\u3060\u3051\u3067\u30c6\u30b9\u30c8\u30b7\u30ca\u30ea\u30aa\u3092\u5b9f\u884c\u3059\u308b\u305f\u3081\u306eMaster\uff08Windows\uff09\u3068Slave\uff08Amazon Linux\uff09\u304c\u69cb\u7bc9\u3055\u308c\u307e\u3059\u3002(\u5f8c\u3005CentOS\u306b\u5909\u308f\u308a\u307e\u3059w)  \n* \u305d\u306e\u305f\u3081 **\u5358\u4e00\u306eJMeter\u30de\u30b7\u30f3\u3067\u306f\u304b\u3051\u3089\u308c\u306a\u3044\u3088\u3046\u306a\u8ca0\u8377\u3092\u7c21\u5358\u306b\u304b\u3051\u308b\u3053\u3068\u304c\u51fa\u6765\u307e\u3059\u3002**\n\n\n![fullbok.001.jpeg](https://qiita-image-store.s3.amazonaws.com/0/97564/54edac42-34ec-7b6f-06ea-7da82c8415c7.jpeg)\n\n\n\n\n\n## classmethod\u69d8\u306efullbok\u3092\u4f7f\u3046\nhttps://github.com/classmethod-aws/fullbok\n\n## \u53c2\u8003\u8cc7\u6599\nhttp://dev.classmethod.jp/cloud/aws/aws-cfn-advent-calendar-2013-fullbok/\nhttp://dev.classmethod.jp/study_meeting/cm-regrowth-2014-fullbok/\n\n\n\n## 1.cloudformation\u6e96\u5099\n* s3\u306b [fullbok](https://github.com/classmethod-aws/fullbok)\u304b\u3089\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u3092\u8ffd\u52a0\n\n## 2.\u5b9f\u884c\u3059\u308bjenkins\u306e\u6e96\u5099\n\u5b9f\u884c\u3059\u308bjob\u3092\u4f5c\u6210\n\n```\n## Jenkins shell\n#!/bin/bash -xv\n\nset -eu\n\n# power user\nexport AWS_ACCESS_KEY_ID=xxxxxxxxxxx\nexport AWS_SECRET_ACCESS_xxxxxxxxxxxxxxxxxx\n\nexport AWS_DEFAULT_REGION=ap-northeast-1\n\n\naws cloudformation create-stack --stack-name gozuqi-fullbok \\\n\t--template-url https://s3-ap-northeast-1.amazonaws.com/fullbok/fullbok.template \\\n\t--parameters \\\n\tParameterKey=AvailabilityZone,ParameterValue=ap-northeast-1a \\\n\tParameterKey=KeyName,ParameterValue=local.pem \\\n\tParameterKey=MasterInstanceAMI,ParameterValue=ami-ff435e91 \\\n\tParameterKey=MasterInstanceType,ParameterValue=t2.medium \\\n\tParameterKey=SlaveCapacity,ParameterValue=2 \\\n\tParameterKey=SlaveInstanceType,ParameterValue=c3.large \\\n\tParameterKey=SlaveSpotPrice,ParameterValue=0.5 \\\n\tParameterKey=SSHFrom,ParameterValue=0.0.0.0/0 \\\n\t--capabilities CAPABILITY_IAM\n\naws cloudformation wait stack-create-complete --stack-name gozuqi-fullbok\n```\n\n## 3.\u5b9f\u884c\n\u3093\uff1f \u52d5\u304b\u306a\u3044\u3002\u3002\u3002\u3002\nunbound\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u306b\u5931\u6557\u3057\u3066\u3044\u308b\u3088\u3046\u3060\u3002\u3002\u3002\n\u8abf\u3079\u3066\u307f\u308b\u3068\u3001\nhttp://kiq.biz/news/post175.html\n\u307f\u305f\u3044\u306a\u3088\u3046\u3060\u3002\n\u306a\u3089AmazonLinux\u3063\u3066CentOS\u3060\u3057CentOS\u3067\u52d5\u304f\u3088\u3046\u306b\u30ec\u30b7\u30d4\u3092\u4fee\u6b63\n\n## \u3067\u304d\u3042\u304c\u3063\u305f\u30ec\u30b7\u30d4\u304c\u3053\u3061\u3089\n\n```\n{\n  \"AWSTemplateFormatVersion\": \"2010-09-09\",\n  \"Description\" : \"fullbok - JMeter cluster CloudFormation template file.\",\n  \"Parameters\": {\n    \"KeyName\": {\n      \"Description\": \"Name of an existing EC2 KeyPair to enable SSH access to the instances\",\n      \"Type\": \"String\",\n      \"MinLength\": \"1\",\n      \"MaxLength\": \"64\",\n      \"AllowedPattern\": \"[-_ a-zA-Z0-9]*\",\n      \"ConstraintDescription\": \"can contain only alphanumeric characters, spaces, dashes and underscores.\"\n    },\n    \"AvailabilityZone\": {\n      \"Default\" : \"ap-northeast-1a\",\n      \"Description\" : \"Availability zone of Jmeter subnet.\",\n      \"Type\": \"String\",\n      \"MinLength\": \"1\",\n      \"MaxLength\": \"64\",\n      \"AllowedPattern\": \"[-_ a-zA-Z0-9]*\"\n    },\n    \"SSHFrom\" : {\n      \"Default\" : \"0.0.0.0/0\",\n      \"Description\" : \"Lockdown SSH/RDP access to the bastion host (default can be accessed from anywhere)\",\n      \"Type\" : \"String\",\n      \"MinLength\": \"9\",\n      \"MaxLength\": \"18\",\n      \"AllowedPattern\" : \"(\\\\d{1,3})\\\\.(\\\\d{1,3})\\\\.(\\\\d{1,3})\\\\.(\\\\d{1,3})/(\\\\d{1,2})\",\n      \"ConstraintDescription\" : \"must be a valid CIDR range of the form x.x.x.x/x.\"\n    },\n    \"MasterInstanceAMI\" : {\n      \"Description\" : \"AMI ID of Master instance (Microsoft Windows Server 2012 RTM 64-bit)\",\n      \"Type\" : \"String\",\n      \"MinLength\": \"12\",\n      \"MaxLength\": \"12\",\n      \"AllowedPattern\" : \"ami-[a-zA-Z0-9]*\"\n    },\n    \"MasterInstanceType\": {\n      \"Default\": \"m1.medium\",\n      \"Description\": \"JMeter master EC2 instance type\",\n      \"Type\": \"String\",\n      \"ConstraintDescription\": \"must be a valid EC2 instance type.\"\n    },\n    \"SlaveInstanceType\": {\n      \"Default\": \"m1.small\",\n      \"Description\": \"JMeter slave EC2 instance type\",\n      \"Type\": \"String\",\n      \"ConstraintDescription\": \"must be a valid EC2 instance type.\"\n    },\n    \"SlaveCapacity\" : {\n      \"Default\" : \"2\",\n      \"Description\" : \"Number of EC2 instances to launch for the jmeter slave.\",\n      \"Type\" : \"Number\",\n      \"MinValue\": \"1\"\n    },\n    \"SlaveSpotPrice\" : {\n      \"Default\" : \"0\",\n      \"Description\" : \"Spot price for the jmeter slave.\",\n      \"Type\" : \"Number\"\n    }\n  },\n  \"Mappings\": {\n    \"AWSAmazonLinuxAMI\": {\n      \"us-east-1\":      { \"name\":\"Virginia\",   \"64\": \"ami-35792c5c\" , \"64HVM\" : \"ami-69792c00\" },\n      \"us-west-2\":      { \"name\":\"Oregon\",     \"64\": \"ami-d03ea1e0\" , \"64HVM\" : \"ami-e43ea1d4\" },\n      \"us-west-1\":      { \"name\":\"California\", \"64\": \"ami-687b4f2d\" , \"64HVM\" : \"ami-4e7b4f0b\" },\n      \"eu-west-1\":      { \"name\":\"Ireland\",    \"64\": \"ami-149f7863\" , \"64HVM\" : \"ami-209f7857\" },\n      \"ap-southeast-1\": { \"name\":\"Singapole\",  \"64\": \"ami-14f2b946\" , \"64HVM\" : \"ami-6af2b938\" },\n      \"ap-southeast-2\": { \"name\":\"Sydney\",     \"64\": \"ami-a148d59b\" , \"64HVM\" : \"ami-a948d593\" },\n      \"ap-northeast-1\": { \"name\":\"Tokyo\",      \"64\": \"ami-507f9631\" , \"64HVM\" : \"ami-600ae001\" },\n      \"sa-east-1\":      { \"name\":\"SaoPaulo\",   \"64\": \"ami-9f6ec982\" , \"64HVM\" : \"ami-9d6ec980\" }\n    },\n    \"StackConfig\" : {\n      \"VPC\"               : { \"CIDR\" : \"10.0.0.0/16\" },\n      \"JMeterSubnet\"      : { \"CIDR\" : \"10.0.0.0/24\" },\n      \"JMeter\"            : { \"URL\": \"http://archive.apache.org/dist/jmeter/binaries/apache-jmeter-2.10.tgz\" }\n    },\n    \"SlaveInstanceSetting\": {\n        \"m3.medium\":     { \"type\": \"64HVM\" , \"HEAP\": \"-Xms2G -Xmx2G\"     ,\"NEW\": \"-XX:NewSize=512m -XX:MaxNewSize=1G\"   },\n        \"m3.large\":      { \"type\": \"64HVM\" , \"HEAP\": \"-Xms4G -Xmx4G\"     ,\"NEW\": \"-XX:NewSize=1G   -XX:MaxNewSize=2G\"   },\n        \"m3.xlarge\":     { \"type\": \"64HVM\" , \"HEAP\": \"-Xms4G -Xmx4G\"     ,\"NEW\": \"-XX:NewSize=1G   -XX:MaxNewSize=2G\"   },\n        \"m3.2xlarge\":    { \"type\": \"64HVM\" , \"HEAP\": \"-Xms4G -Xmx4G\"     ,\"NEW\": \"-XX:NewSize=1G   -XX:MaxNewSize=2G\"   },\n        \"r3.large\":      { \"type\": \"64HVM\" , \"HEAP\": \"-Xms4G -Xmx4G\"     ,\"NEW\": \"-XX:NewSize=1G   -XX:MaxNewSize=2G\"   },\n        \"r3.xlarge\":     { \"type\": \"64HVM\" , \"HEAP\": \"-Xms4G -Xmx4G\"     ,\"NEW\": \"-XX:NewSize=1G   -XX:MaxNewSize=2G\"   },\n        \"r3.2xlarge\":    { \"type\": \"64HVM\" , \"HEAP\": \"-Xms4G -Xmx4G\"     ,\"NEW\": \"-XX:NewSize=1G   -XX:MaxNewSize=2G\"   },\n        \"r3.4xlarge\":    { \"type\": \"64HVM\" , \"HEAP\": \"-Xms4G -Xmx4G\"     ,\"NEW\": \"-XX:NewSize=1G   -XX:MaxNewSize=2G\"   },\n        \"r3.8xlarge\":    { \"type\": \"64HVM\" , \"HEAP\": \"-Xms4G -Xmx4G\"     ,\"NEW\": \"-XX:NewSize=1G   -XX:MaxNewSize=2G\"   },\n        \"m1.small\":      { \"type\": \"64\"    , \"HEAP\": \"-Xms1G -Xmx1G\"     ,\"NEW\": \"-XX:NewSize=256m -XX:MaxNewSize=512m\" },\n        \"m1.medium\":     { \"type\": \"64\"    , \"HEAP\": \"-Xms2G -Xmx2G\"     ,\"NEW\": \"-XX:NewSize=512m -XX:MaxNewSize=1G\"   },\n        \"m1.large\":      { \"type\": \"64\"    , \"HEAP\": \"-Xms4G -Xmx4G\"     ,\"NEW\": \"-XX:NewSize=1G   -XX:MaxNewSize=2G\"   },\n        \"m1.xlarge\":     { \"type\": \"64\"    , \"HEAP\": \"-Xms4G -Xmx4G\"     ,\"NEW\": \"-XX:NewSize=1G   -XX:MaxNewSize=2G\"   },\n        \"c3.large\":      { \"type\": \"64HVM\" , \"HEAP\": \"-Xms2G -Xmx2G\"     ,\"NEW\": \"-XX:NewSize=512m -XX:MaxNewSize=1G\"   },\n        \"c3.xlarge\":     { \"type\": \"64HVM\" , \"HEAP\": \"-Xms4G -Xmx4G\"     ,\"NEW\": \"-XX:NewSize=1G   -XX:MaxNewSize=2G\"   },\n        \"c3.2xlarge\":    { \"type\": \"64HVM\" , \"HEAP\": \"-Xms4G -Xmx4G\"     ,\"NEW\": \"-XX:NewSize=1G   -XX:MaxNewSize=2G\"   },\n        \"c3.4xlarge\":    { \"type\": \"64HVM\" , \"HEAP\": \"-Xms4G -Xmx4G\"     ,\"NEW\": \"-XX:NewSize=1G   -XX:MaxNewSize=2G\"   },\n        \"c3.8xlarge\":    { \"type\": \"64HVM\" , \"HEAP\": \"-Xms4G -Xmx4G\"     ,\"NEW\": \"-XX:NewSize=1G   -XX:MaxNewSize=2G\"   },\n        \"c1.medium\":     { \"type\": \"64\"    , \"HEAP\": \"-Xms1G -Xmx1G\"     ,\"NEW\": \"-XX:NewSize=256m -XX:MaxNewSize=512m\" },\n        \"c1.xlarge\":     { \"type\": \"64\"    , \"HEAP\": \"-Xms4G -Xmx4G\"     ,\"NEW\": \"-XX:NewSize=1G   -XX:MaxNewSize=2G\"   },\n        \"cc2.8xlarge\":   { \"type\": \"64\"    , \"HEAP\": \"-Xms4G -Xmx4G\"     ,\"NEW\": \"-XX:NewSize=1G   -XX:MaxNewSize=2G\"   },\n        \"m2.xlarge\":     { \"type\": \"64\"    , \"HEAP\": \"-Xms4G -Xmx4G\"     ,\"NEW\": \"-XX:NewSize=1G   -XX:MaxNewSize=2G\"   },\n        \"m2.2xlarge\":    { \"type\": \"64\"    , \"HEAP\": \"-Xms4G -Xmx4G\"     ,\"NEW\": \"-XX:NewSize=1G   -XX:MaxNewSize=2G\"   },\n        \"m2.4xlarge\":    { \"type\": \"64\"    , \"HEAP\": \"-Xms4G -Xmx4G\"     ,\"NEW\": \"-XX:NewSize=1G   -XX:MaxNewSize=2G\"   },\n        \"cr1.8xlarge\":   { \"type\": \"64HVM\" , \"HEAP\": \"-Xms4G -Xmx4G\"     ,\"NEW\": \"-XX:NewSize=1G   -XX:MaxNewSize=2G\"   },\n        \"hi1.4xlarge\":   { \"type\": \"64HVM\" , \"HEAP\": \"-Xms4G -Xmx4G\"     ,\"NEW\": \"-XX:NewSize=1G   -XX:MaxNewSize=2G\"   },\n        \"hs1.8xlarge\":   { \"type\": \"64HVM\" , \"HEAP\": \"-Xms4G -Xmx4G\"     ,\"NEW\": \"-XX:NewSize=1G   -XX:MaxNewSize=2G\"   },\n        \"t1.micro\":      { \"type\": \"64\"    , \"HEAP\": \"-Xms256M -Xmx256M\" ,\"NEW\": \"-XX:NewSize=128m -XX:MaxNewSize=128m\" },\n        \"g2.2xlarge\":    { \"type\": \"64\"    , \"HEAP\": \"-Xms4G -Xmx4G\"     ,\"NEW\": \"-XX:NewSize=1G   -XX:MaxNewSize=2G\"   },\n        \"cg1.4xlarge\":   { \"type\": \"64\"    , \"HEAP\": \"-Xms4G -Xmx4G\"     ,\"NEW\": \"-XX:NewSize=1G   -XX:MaxNewSize=2G\"   }\n    }\n  },\n  \"Conditions\" : {\n    \"UseSpotInstance\" : { \"Fn::Not\": [ { \"Fn::Equals\" : [ {\"Ref\" : \"SlaveSpotPrice\"}, \"0\" ] } ] }\n  },\n  \"Resources\": {\n    \"PowerUserRole\" : {\n      \"Type\" : \"AWS::IAM::Role\",\n      \"Properties\" : {\n        \"AssumeRolePolicyDocument\" : {\n          \"Statement\": [ {\n            \"Effect\": \"Allow\",\n              \"Principal\": {\n                \"Service\": [ \"ec2.amazonaws.com\" ]\n              },\n              \"Action\": [ \"sts:AssumeRole\" ]\n          } ]\n        },\n        \"Path\" : \"/\",\n        \"Policies\" :[ {\n          \"PolicyName\" : \"PowerUserPolicy\",\n          \"PolicyDocument\" : {\n            \"Statement\": [ {\n              \"Sid\": \"PowerUserStmt\",\n              \"Effect\": \"Allow\",\n              \"NotAction\": \"iam:*\",\n              \"Resource\": \"*\"\n            } ]\n          }\n        }]\n      }\n    },\n    \"PowerUserProfile\" : {\n      \"Type\" : \"AWS::IAM::InstanceProfile\",\n      \"Properties\" : {\n        \"Path\": \"/\",\n        \"Roles\" : [ { \"Ref\" : \"PowerUserRole\" } ]\n      }\n    },\n\n    \"VPC\" : {\n      \"Type\" : \"AWS::EC2::VPC\",\n      \"Properties\" : {\n        \"CidrBlock\" : { \"Fn::FindInMap\" : [ \"StackConfig\", \"VPC\", \"CIDR\" ]},\n        \"EnableDnsHostnames\" : \"true\",\n        \"InstanceTenancy\" : \"default\",\n        \"Tags\" : [\n          {\"Key\" : \"Application\", \"Value\" : { \"Ref\" : \"AWS::StackId\" } },\n          {\"Key\" : \"Network\", \"Value\" : \"Public\" }\n        ]\n      }\n    },\n    \"InternetGateway\" : {\n      \"Type\" : \"AWS::EC2::InternetGateway\",\n      \"Properties\" : {\n        \"Tags\" : [\n          {\"Key\" : \"Application\", \"Value\" : { \"Ref\" : \"AWS::StackId\" } },\n          {\"Key\" : \"Network\", \"Value\" : \"Public\" }\n        ]\n      }\n    },\n    \"AttachGateway\" : {\n      \"Type\" : \"AWS::EC2::VPCGatewayAttachment\",\n      \"Properties\" : {\n        \"VpcId\" : {\"Ref\" : \"VPC\"},\n        \"InternetGatewayId\" : {\"Ref\" : \"InternetGateway\"}\n      }\n    },\n\n    \"PublicRouteTable\" : {\n      \"Type\" : \"AWS::EC2::RouteTable\",\n      \"DependsOn\" : \"AttachGateway\",\n      \"Properties\" : {\n        \"VpcId\" : { \"Ref\" : \"VPC\" },\n        \"Tags\" : [\n          {\"Key\" : \"Application\", \"Value\" : { \"Ref\" : \"AWS::StackId\"} },\n          {\"Key\" : \"Network\", \"Value\" : \"Public\" }\n        ]\n      }\n    },\n    \"PublicRoute\" : {\n      \"Type\" : \"AWS::EC2::Route\",\n      \"DependsOn\" : \"AttachGateway\",\n      \"Properties\" : {\n        \"RouteTableId\" : { \"Ref\" : \"PublicRouteTable\" },\n        \"DestinationCidrBlock\" : \"0.0.0.0/0\",\n        \"GatewayId\" : { \"Ref\" : \"InternetGateway\" }\n      }\n    },\n\n    \"JMeterSubnet\": {\n      \"Type\": \"AWS::EC2::Subnet\",\n      \"DependsOn\" : \"AttachGateway\",\n      \"Properties\": {\n        \"VpcId\": { \"Ref\": \"VPC\" },\n        \"AvailabilityZone\": { \"Ref\": \"AvailabilityZone\" },\n        \"CidrBlock\": { \"Fn::FindInMap\" : [ \"StackConfig\", \"JMeterSubnet\", \"CIDR\" ]},\n        \"Tags\" : [\n          {\"Key\" : \"Application\", \"Value\" : { \"Ref\" : \"AWS::StackId\" } },\n          {\"Key\" : \"Network\", \"Value\" : \"Public\" }\n        ]\n      }\n    },\n    \"JMeterSubnetRouteTableAssociation\" : {\n      \"Type\" : \"AWS::EC2::SubnetRouteTableAssociation\",\n      \"Properties\" : {\n        \"SubnetId\" : { \"Ref\" : \"JMeterSubnet\" },\n        \"RouteTableId\" : { \"Ref\" : \"PublicRouteTable\" }\n      }\n    },\n\n    \"VPCDefaultSecurityGroup\" : {\n      \"Type\" : \"AWS::EC2::SecurityGroup\",\n      \"Properties\" : {\n        \"VpcId\" : { \"Ref\" : \"VPC\" },\n        \"GroupDescription\" : \"Allow all communications in VPC\",\n        \"SecurityGroupIngress\" : [\n          { \"IpProtocol\" : \"tcp\", \"FromPort\" : \"0\", \"ToPort\" : \"65535\", \"CidrIp\" : { \"Fn::FindInMap\" : [ \"StackConfig\", \"VPC\", \"CIDR\" ]} },\n          { \"IpProtocol\" : \"udp\", \"FromPort\" : \"0\", \"ToPort\" : \"65535\", \"CidrIp\" : { \"Fn::FindInMap\" : [ \"StackConfig\", \"VPC\", \"CIDR\" ]} },\n          { \"IpProtocol\" : \"icmp\", \"FromPort\" : \"-1\", \"ToPort\" : \"-1\",  \"CidrIp\" : { \"Fn::FindInMap\" : [ \"StackConfig\", \"VPC\", \"CIDR\" ]} }\n        ]\n      }\n    },\n    \"SSHSecurityGroup\" : {\n      \"Type\" : \"AWS::EC2::SecurityGroup\",\n      \"Properties\" : {\n        \"VpcId\" : { \"Ref\" : \"VPC\" },\n        \"GroupDescription\" : \"Enable SSH access via port 22\",\n        \"SecurityGroupIngress\" : [\n          { \"IpProtocol\" : \"tcp\", \"FromPort\" : \"22\",  \"ToPort\" : \"22\",  \"CidrIp\" : { \"Ref\" : \"SSHFrom\" }}\n        ]\n      }\n    },\n    \"RDPSecurityGroup\" : {\n      \"Type\" : \"AWS::EC2::SecurityGroup\",\n      \"Properties\" : {\n        \"VpcId\" : { \"Ref\" : \"VPC\" },\n        \"GroupDescription\" : \"Enable RDP\",\n        \"SecurityGroupIngress\" : [\n          {\"IpProtocol\" : \"tcp\", \"FromPort\" : \"3389\", \"ToPort\" : \"3389\", \"CidrIp\" : { \"Ref\" : \"SSHFrom\" }}\n        ]\n      }\n    },\n\n    \"SlaveFleet\" : {\n      \"Type\" : \"AWS::AutoScaling::AutoScalingGroup\",\n      \"Properties\" : {\n        \"AvailabilityZones\" : [\n          { \"Ref\" : \"AvailabilityZone\" }\n        ],\n        \"VPCZoneIdentifier\" : [\n          { \"Ref\" : \"JMeterSubnet\" }\n        ],\n        \"LaunchConfigurationName\" : { \"Ref\" : \"SlaveInstanceLaunchConfig\"  },\n        \"MinSize\" : { \"Ref\" : \"SlaveCapacity\" },\n        \"MaxSize\" : { \"Ref\" : \"SlaveCapacity\" },\n        \"DesiredCapacity\" : { \"Ref\" : \"SlaveCapacity\" },\n        \"Tags\" : [\n          { \"Key\" : \"Name\", \"Value\" : \"JMeterSlave\", \"PropagateAtLaunch\" : \"true\" },\n          { \"Key\" : \"Network\", \"Value\" : \"Public\", \"PropagateAtLaunch\" : \"true\" }\n        ]\n      }\n    },\n    \"SlaveInstanceLaunchConfig\"  : {\n      \"Type\" : \"AWS::AutoScaling::LaunchConfiguration\",\n      \"Properties\" : {\n        \"InstanceType\": { \"Ref\" : \"SlaveInstanceType\" },\n        \"SpotPrice\" : { \"Fn::If\" : [ \"UseSpotInstance\", {\"Ref\" : \"SlaveSpotPrice\"},  { \"Ref\" : \"AWS::NoValue\" } ] },\n        \"KeyName\": { \"Ref\" : \"KeyName\" },\n        \"ImageId\": { \"Fn::FindInMap\": [ \"AWSAmazonLinuxAMI\", { \"Ref\": \"AWS::Region\" }, { \"Fn::FindInMap\": [ \"SlaveInstanceSetting\", { \"Ref\": \"SlaveInstanceType\" }, \"type\" ]} ]},\n        \"SecurityGroups\": [\n          { \"Ref\" : \"SSHSecurityGroup\" },\n          { \"Ref\" : \"VPCDefaultSecurityGroup\" }\n        ],\n        \"IamInstanceProfile\": { \"Ref\" : \"PowerUserProfile\" },\n        \"InstanceMonitoring\" : \"false\",\n        \"AssociatePublicIpAddress\" : \"true\",\n        \"UserData\" : { \"Fn::Base64\" : { \"Fn::Join\" : [\"\", [\n          \"#! /bin/bash -v\\n\",\n          \"yum update -y\\n\",\n          \"yum install -y epel-release python-pip wget gcc make zlib-devel openssl-devel\\n\",\n          \n            \n          \"python -V\\n\",\n          \"export PATH=$PATH:/opt/aws/bin\\n\",\n          \"export PATH\\n\",\n          \n          \n          \"# Install aws-cli\\n\",\n          \"pip install pystache\\n\",\n          \"pip install argparse\\n\",\n          \"pip install python-daemon\\n\",\n          \"pip install requests\\n\",\n          \"pip install awscli\\n\",\n          \"yum -y update\\n\",\n          \"cd /opt\\n\",\n          \"curl -O https://s3.amazonaws.com/cloudformation-examples/aws-cfn-bootstrap-latest.tar.gz\\n\",\n          \"tar -xvpf aws-cfn-bootstrap-latest.tar.gz\\n\",\n          \"cd aws-cfn-bootstrap-1.4/\\n\",\n          \"python setup.py build\\n\",\n          \"python setup.py install\\n\",\n          \"chmod 775 /opt/aws-cfn-bootstrap-1.4/bin/*\\n\",\n          \"cd /opt\\n\",\n          \"mkdir aws\\n\",\n          \"cd aws\\n\",\n          \"ln -s /opt/aws-cfn-bootstrap-1.4/bin /opt/aws/\\n\",\n          \n          \n          \"# Continuous Release Repository setting for unbound\\n\",\n          \"yum install -y java-1.7.0-openjdk\\n\",\n          \"yum install -y java-1.7.0-openjdk-devel\\n\", \n          \"# Install local dns resolver\\n\",\n          \"yum install -y unbound\\n\",\n          \"sed -i 's/val-permissive-mode: .*/val-permissive-mode: yes/g' /etc/unbound/unbound.conf\\n\",\n          \"echo -e 'forward-zone:\\n\\tname: \", { \"Ref\": \"AWS::Region\" } ,\".compute.internal\\n\\tforward-addr: 10.0.0.2' >> /etc/unbound/unbound.conf\\n\",\n          \"service unbound start\\n\",\n          \"chkconfig unbound on\\n\",\n          \"sed -i 's/PEERDNS=yes/PEERDNS=no/g' /etc/sysconfig/network-scripts/ifcfg-eth0\\n\",\n          \"sed -i 's/nameserver .*/nameserver 127.0.0.1/g' /etc/resolv.conf\\n\",\n\n          \"# Helper function\\n\",\n          \"function error_exit\\n\",\n          \"{\\n\",\n          \"  /opt/aws/bin/cfn-signal -e 1 -r \\\"$1\\\" '\", { \"Ref\" : \"SlaveWaitHandle\" }, \"'\\n\",\n          \"  exit 1\\n\",\n          \"}\\n\",\n\n          \"# Install packages\\n\",\n          \"/opt/aws/bin/cfn-init -v -s \", { \"Ref\" : \"AWS::StackId\" }, \" -r SlaveInstanceLaunchConfig \",\n          \"    --region \", { \"Ref\" : \"AWS::Region\" }, \"\\n\",\n\n          \"sysctl -p\\n\",\n\n          \"echo \\\"/opt/apache-jmeter-2.10/bin/jmeter-server | logger -p daemon.info &\\\" >>/etc/rc.local\\n\",\n          \"sh /opt/apache-jmeter-2.10/bin/jmeter -s -n &\",\n\n          \"# All is well so signal success\\n\",\n          \"/opt/aws/bin/cfn-signal -e $? -r \\\"SlaveInstanceLaunchConfig setup complete\\\" '\", { \"Ref\" : \"SlaveWaitHandle\" }, \"'\\n\"\n        ]]}}\n      },\n      \"Metadata\" : {\n        \"AWS::CloudFormation::Init\" : {\n          \"config\" : {\n            \"packages\" : {\n              \"yum\" : {\n              }\n            },\n            \"sources\" : {\n              \"/opt\" : { \"Fn::FindInMap\" : [ \"StackConfig\", \"JMeter\", \"URL\" ]}\n            },\n            \"files\" : {\n              \"/etc/security/limits.conf\" : {\n                \"content\" : { \"Fn::Join\" : [\"\", [\n                  \"# /etc/security/limits.conf\\n\",\n                  \"#\\n\",\n                  \"#Each line describes a limit for a user in the form:\\n\",\n                  \"#\\n\",\n                  \"#\\n\",\n                  \"#<domain>      <type>  <item>         <value>\\n\",\n                  \"#\\n\",\n                  \"\\n\",\n                  \"#*               soft    core            0\\n\",\n                  \"#*               hard    rss             10000\\n\",\n                  \"#@student        hard    nproc           20\\n\",\n                  \"#@faculty        soft    nproc           20\\n\",\n                  \"#@faculty        hard    nproc           50\\n\",\n                  \"#ftp             hard    nproc           0\\n\",\n                  \"#@student        -       maxlogins       4\\n\",\n                  \"\\n\",\n                  \"\\n\",\n                  \"*                hard   nofile           65536\\n\",\n                  \"*                soft   nofile           65536\\n\",\n                  \"*                hard   nproc            8192\\n\",\n                  \"*                soft   nproc            8192\\n\",\n                  \"\\n\",\n                  \"\\n\",\n                  \"\\n\",\n                  \"# End of file\\n\"\n                ]]},\n                \"mode\"  : \"000644\",\n                \"owner\" : \"root\",\n                \"group\" : \"root\"\n              }\n            },\n            \"commands\" : {\n              \"00-use_java7\" : {\n                \"command\" : \"alternatives --set java /usr/lib/jvm/jre-1.7.0-openjdk.x86_64/bin/java\"\n              },\n              \"01-create_hosts_entry-on_boot\" : {\n                \"command\" : \"echo \\\"`curl -s curl http://169.254.169.254/latest/meta-data/local-ipv4` `hostname`\\\" >>/etc/hosts\",\n                \"test\" : \"test ! -f .create_hosts_entry-semaphore\"\n              },\n              \"02-signal_startup_complete\" : {\n                \"command\" : \"touch .create_hosts_entry-semaphore\"\n              },\n              \"03-set_listen_address\" : {\n                \"command\" : { \"Fn::Join\" : [\"\", [\n                  \"sed -i -e \\\"s/^#RMI_HOST_DEF=-Djava.rmi.server.hostname=.*$/RMI_HOST_DEF=-Djava.rmi.server.hostname=$(curl -s http://169.254.169.254/latest/meta-data/local-hostname)/\\\" /opt/apache-jmeter-2.10/bin/jmeter-server\"\n                ]]}\n              },\n              \"03-set_heap\" : {\n                \"command\" : { \"Fn::Join\" : [\"\", [\n                  \"sed -i -e \\\"s/^HEAP/#HEAP/ \\\" -e \\\" /^#HEAP/i HEAP=\\\\\\\"\" , { \"Fn::FindInMap\": [ \"SlaveInstanceSetting\", { \"Ref\": \"SlaveInstanceType\" }, \"HEAP\" ]} , \"\\\\\\\" \\\" /opt/apache-jmeter-2.10/bin/jmeter\"\n                ]]}\n              },\n              \"03-set_new\" : {\n                \"command\" : { \"Fn::Join\" : [\"\", [\n                  \"sed -i -e \\\"s/^NEW/#NEW/ \\\" -e \\\" /^#NEW/i NEW=\\\\\\\"\" , { \"Fn::FindInMap\": [ \"SlaveInstanceSetting\", { \"Ref\": \"SlaveInstanceType\" }, \"NEW\" ]} , \"\\\\\\\" \\\" /opt/apache-jmeter-2.10/bin/jmeter\"\n                ]]}\n              },\n              \"03-add_disabling_dns_caching\" : {\n                \"command\" : \"sed -i -e \\\" /^java/i JVM_ARGS=\\\\\\\"\\\\$JVM_ARGS -Dsun.net.inetaddr.ttl=0\\\\\\\"\\\" /opt/apache-jmeter-2.10/bin/jmeter\"\n              },\n              \"04-tcp_param_tcp_tw_recycle\" : {\n                \"command\" : \"echo \\\"net.ipv4.tcp_tw_recycle = 1\\\" >> /etc/sysctl.conf\"\n              },\n              \"04-tcp_param_tcp_fin_timeout\" : {\n                \"command\" : \"echo \\\"net.ipv4.tcp_fin_timeout = 1\\\" >> /etc/sysctl.conf\"\n              },\n              \"05-nproc_limit\" : {\n                \"command\" : \"sed -i -e \\\"s/ nproc     1024/ nproc     8192/\\\" /etc/security/limits.d/90-nproc.conf\"\n              }\n            }\n          }\n        }\n      }\n    },\n    \"SlaveWaitHandle\" : {\n      \"Type\" : \"AWS::CloudFormation::WaitConditionHandle\"\n    },\n    \"SlaveWaitCondition\" : {\n      \"Type\" : \"AWS::CloudFormation::WaitCondition\",\n      \"DependsOn\" : \"SlaveFleet\",\n      \"Properties\" : {\n        \"Handle\" : {\"Ref\" : \"SlaveWaitHandle\"},\n        \"Timeout\" : \"3600\",\n        \"Count\"   : { \"Ref\" : \"SlaveCapacity\" }\n      }\n    },\n\n    \"MasterInstance\": {\n      \"Type\" : \"AWS::EC2::Instance\",\n      \"Properties\": {\n        \"InstanceType\" : { \"Ref\" : \"MasterInstanceType\" },\n        \"ImageId\" : { \"Ref\": \"MasterInstanceAMI\" },\n        \"NetworkInterfaces\": [{\n          \"DeviceIndex\" : \"0\",\n          \"AssociatePublicIpAddress\" : true,\n          \"DeleteOnTermination\" : true,\n          \"SubnetId\" : { \"Ref\" : \"JMeterSubnet\" },\n          \"GroupSet\" : [\n            { \"Ref\" : \"RDPSecurityGroup\" },\n            { \"Ref\" : \"VPCDefaultSecurityGroup\" }\n          ]\n        }],\n        \"KeyName\" : { \"Ref\" : \"KeyName\" },\n        \"IamInstanceProfile\": { \"Ref\" : \"PowerUserProfile\" },\n        \"Monitoring\" : \"false\",\n        \"Tags\" : [\n          { \"Key\" : \"Name\", \"Value\" : \"JMeterMaster\" },\n          { \"Key\" : \"Network\", \"Value\" : \"Public\" }\n        ],\n        \"UserData\" : { \"Fn::Base64\" : { \"Fn::Join\" : [\"\", [\n          \"<powershell>\\n\",\n          \"cfn-init.exe -v -s \", { \"Ref\" : \"AWS::StackId\" }, \" -r MasterInstance -c create --region \", { \"Ref\" : \"AWS::Region\" }, \"\\n\",\n          \"cfn-signal.exe -e $lastexitcode \", { \"Fn::Base64\" : { \"Ref\" : \"MasterWaitHandle\" }}, \"\\n\",\n          \"</powershell>\"\n        ]]}}\n      },\n      \"Metadata\" : {\n        \"AWS::CloudFormation::Init\" : {\n          \"configSets\" : {\n            \"create\" : [\n              \"setup_cfn_hup\",\n              \"place_scripts\",\n              \"install_jdk\",\n              \"disable_firewall\",\n              \"install_jmeter\",\n              \"setup_jmeter\"\n            ],\n            \"update\" : [\n              \"setup_jmeter\"\n            ]\n          },\n          \"setup_cfn_hup\" : {\n            \"files\" : {\n              \"c:\\\\cfn\\\\cfn-hup.conf\" : {\n                \"content\" : { \"Fn::Join\" : [\"\", [\n                  \"[main]\\n\",\n                  \"stack=\", { \"Ref\" : \"AWS::StackId\" }, \"\\n\",\n                  \"region=\", { \"Ref\" : \"AWS::Region\" }, \"\\n\"\n                ]]}\n              },\n              \"c:\\\\cfn\\\\hooks.d\\\\cfn-auto-reloader.conf\" : {\n                \"content\": { \"Fn::Join\" : [\"\", [\n                  \"[cfn-auto-reloader-hook]\\n\",\n                  \"triggers=post.update\\n\",\n                  \"path=Resources.MasterInstance.Metadata.AWS::CloudFormation::Init\\n\",\n                  \"action=cfn-init.exe -v -s \", { \"Ref\" : \"AWS::StackId\" }, \" -r MasterInstance -c update --region \", { \"Ref\" : \"AWS::Region\" }, \"\\n\"\n                ]]}\n              }\n            },\n            \"services\" : {\n              \"windows\" : {\n                \"cfn-hup\" : {\n                  \"enabled\" : \"true\",\n                  \"ensureRunning\" : \"true\",\n                  \"files\" : [\n                    \"c:\\\\cfn\\\\cfn-hup.conf\",\n                    \"c:\\\\cfn\\\\hooks.d\\\\cfn-auto-reloader.conf\"\n                  ]\n                }\n              }\n            }\n          },\n          \"place_scripts\" : {\n            \"files\" : {\n              \"c:\\\\install_jdk.ps1\" : {\n                \"content\": { \"Fn::Join\" : [\"\", [\n                  \"$client = new-object System.Net.WebClient\\n\",\n                  \"$client.Headers.add(\\\"Cookie\\\", \\\"oraclelicense=accept-securebackup-cookie\\\")\\n\",\n                  \"$client.DownloadFile(\\\"http://download.oracle.com/otn-pub/java/jdk/7u45-b18/jdk-7u45-windows-x64.exe\\\", \\\"C:\\\\Users\\\\Administrator\\\\jdk.exe\\\")\\n\",\n                  \"C:\\\\Users\\\\Administrator\\\\jdk.exe /s /lang=1041 INSTALLDIR=C:\\\\java\\\\jdk1.7.45\\n\",\n                  \"$env:PATH = $env:PATH + \\\";C:\\\\java\\\\jdk1.7.45\\\\bin\\\"\"\n                ]]}\n              },\n              \"c:\\\\create_shortcut.ps1\" : {\n                \"content\": { \"Fn::Join\" : [\"\", [\n                  \"$WshShell = New-Object -comObject WScript.Shell\\n\",\n                  \"$shortcut = $WshShell.CreateShortcut(\\\"C:\\\\Users\\\\Administrator\\\\Desktop\\\\JMeter.lnk\\\")\\n\",\n                  \"$shortcut.TargetPath = \\\"C:\\\\jmeter\\\\apache-jmeter-2.10\\\\bin\\\\jmeterw.cmd\\\"\\n\",\n                  \"$shortcut.WorkingDirectory = \\\"C:\\\\jmeter\\\\apache-jmeter-2.10\\\\bin\\\"\\n\",\n                  \"$shortcut.Save()\\n\"\n                ]]}\n              },\n              \"c:\\\\setupjmetercluster.ps1\" : {\n                \"content\": { \"Fn::Join\" : [\"\", [\n                  \"Set-DefaultAWSRegion \", { \"Ref\" : \"AWS::Region\" }, \"\\n\",\n                  \"$slaves = (Get-ASAutoScalingInstance\",\n                  \" | ? {$_.AutoScalingGroupName -eq \\\"\", { \"Ref\" : \"SlaveFleet\" }, \"\\\"}\",\n                  \" | select -ExpandProperty InstanceId\",\n                  \" | Get-EC2Instance\",\n                  \" | select -ExpandProperty RunningInstance\",\n                  \" | select -ExpandProperty PrivateIpAddress) -join ','\\n\",\n                  \"(Get-Content \\\"C:\\\\jmeter\\\\apache-jmeter-2.10\\\\bin\\\\jmeter.properties\\\")\",\n                  \" | Foreach-Object {$_ -replace '^remote_hosts=.*$', (\\\"remote_hosts=\\\" + $slaves)}\",\n                  \" | Set-Content \\\"C:\\\\jmeter\\\\apache-jmeter-2.10\\\\bin\\\\jmeter.properties\\\"\"\n                ]]}\n              },\n              \"c:\\\\updatejmeter.ps1\" : {\n                \"content\": { \"Fn::Join\" : [\"\", [\n                  \"(Get-Content \\\"C:\\\\jmeter\\\\apache-jmeter-2.10\\\\bin\\\\jmeter.bat\\\") \",\n                  \" | Foreach-Object {$_ -replace '^set HEAP=.*$', (\\\"set HEAP=\" , { \"Fn::FindInMap\": [ \"SlaveInstanceSetting\", { \"Ref\": \"SlaveInstanceType\" }, \"HEAP\" ]} , \"\\\")} \",\n                  \" | Foreach-Object {$_ -replace '^set NEW=.*$', (\\\"set NEW=\" , { \"Fn::FindInMap\": [ \"SlaveInstanceSetting\", { \"Ref\": \"SlaveInstanceType\" }, \"NEW\" ]} , \"\\\")} \",\n                  \" | Set-Content \\\"C:\\\\jmeter\\\\apache-jmeter-2.10\\\\bin\\\\jmeter.bat\\\"\"\n                ]]}\n              }\n            }\n          },\n          \"install_jdk\" : {\n            \"commands\" : {\n              \"install_jdk\" : {\n                \"command\" : \"powershell.exe -ExecutionPolicy Bypass -NoLogo -NonInteractive -NoProfile -WindowStyle Hidden -File c:\\\\install_jdk.ps1\"\n              }\n            }\n          },\n          \"disable_firewall\" : {\n            \"commands\" : {\n              \"disable_firewall\" : {\n                \"command\" : \"netsh advfirewall set allprofiles state off\"\n              }\n            }\n          },\n          \"install_jmeter\" : {\n            \"sources\" : {\n              \"c:\\\\jmeter\" : { \"Fn::FindInMap\" : [ \"StackConfig\", \"JMeter\", \"URL\" ]}\n            },\n            \"commands\" : {\n              \"create_shortcut\" : {\n                \"command\" : \"powershell.exe -ExecutionPolicy Bypass -NoLogo -NonInteractive -NoProfile -WindowStyle Hidden -File c:\\\\create_shortcut.ps1\"\n              }\n            }\n          },\n          \"setup_jmeter\" : {\n            \"commands\" : {\n              \"setup_jmeter_cluster\" : {\n                \"command\" : \"powershell.exe -ExecutionPolicy Bypass -NoLogo -NonInteractive -NoProfile -WindowStyle Hidden -File c:\\\\setupjmetercluster.ps1\"\n              }\n            }\n          },\n          \"setup_jmeter_jvm\" : {\n            \"commands\" : {\n              \"setup_jmeter_jvm_param\" : {\n                \"command\" : \"powershell.exe -ExecutionPolicy Bypass -NoLogo -NonInteractive -NoProfile -WindowStyle Hidden -File c:\\\\updatejmeter.ps1\"\n              }\n            }\n          }\n        }\n      }\n    },\n    \"MasterWaitHandle\" : {\n      \"Type\" : \"AWS::CloudFormation::WaitConditionHandle\"\n    },\n    \"MasterWaitCondition\" : {\n      \"Type\" : \"AWS::CloudFormation::WaitCondition\",\n      \"DependsOn\" : \"MasterInstance\",\n      \"Properties\" : {\n        \"Handle\" : {\"Ref\" : \"MasterWaitHandle\"},\n        \"Timeout\" : \"3600\"\n      }\n    }\n  },\n\n  \"Outputs\": {\n    \"SSHToSlaveInstances\": {\n      \"Value\": { \"Fn::Join\":[\"\", [\n        \"ssh -i /path/to/\", { \"Ref\": \"KeyName\" }, \".pem ec2-user@<ip/hostname>\"\n      ]]},\n      \"Description\": \"SSH command to connect to the JMeter slave instances.\"\n    },\n    \"RDPToMasterInstance\": {\n      \"Value\": { \"Fn::Join\":[\"\", [\n        \"remotedesktop://\", { \"Fn::GetAtt\" : [ \"MasterInstance\", \"PublicDnsName\" ]}\n      ]]},\n      \"Description\": \"RDP connection to the JMeter master.\"\n    }\n  }\n}\n```\n\n## \u518d\u5ea6\u5b9f\u884c\n* Status CREATE_COMPLETE  \n\u51fa\u6765\u4e0a\u304c\u3063\u305f\u307f\u305f\u3044\u3067\u3059\u306d\u3002\n\n\n## \u6e96\u5099\n\u81ea\u5206\u306fELB\u306b\u3076\u3089\u4e0b\u304c\u3063\u305f\u96c6\u56e3\u30ac\u30a4\u30eb\u306b\u5bfe\u3057\u3066\u8ca0\u8377\u3092\u304b\u3051\u305f\u304b\u3063\u305f\u306e\u3067ELB\u306e\u8a2d\u5b9a\u3002\nMaster\u306fwindows\u306a\u306e\u3067mac\u4f7f\u3063\u3066\u308b\u4eba\u306fRemoteDesctop\u304b\u306a\u3093\u304b\u3067\u30ed\u30b0\u30a4\u30f3\u3057\u3066\u30c6\u30b9\u30c8\u66f8\u3044\u3066\u5b9f\u884c\n\n\n## Test\u5b9f\u884c\nwindows\u3067\u5b9f\u884c\nslave\u304b\u3089\u30c6\u30b9\u30c8\u30b5\u30fc\u30d0\u306b\u6d41\u308c\u3066\u308b\u304b\u78ba\u8a8d\u3059\u308b\n\n\n## \u6383\u9664\u7528Jenkins\n\u74b0\u5883\u524a\u9664job\u3092\u4f5c\u6210\n\n```\n#!/bin/bash -xv\nset -eu\nexport AWS_ACCESS_KEY_ID=xxxxxxxxxxxxx\nexport AWS_SECRET_ACCESS_KEY=xxxxxxxxxxxxxxxxxx\nexport AWS_DEFAULT_REGION=ap-northeast-1\naws cloudformation delete-stack --stack-name gozuqi-fullbok\naws cloudformation wait stack-delete-complete --stack-name gozuqi-fullbok\n\n```\n\n\n\n\n\n\n\n\n\n", "tags": ["fullbok", "JMeter", "\u8ca0\u8377\u8a66\u9a13", "CloudFormation", "Jenkins"]}