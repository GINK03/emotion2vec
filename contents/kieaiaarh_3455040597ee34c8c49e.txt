{"context": " More than 1 year has passed since last update.\n\n\u3084\u3063\u305f\u3053\u3068\n\u8868\u984c\u306e\u901a\u308a\u3067\u3059\u304c\u3001nginx\u3092\u4f7f\u3063\u3066\u3001\u30c7\u30d5\u30a9\u30eb\u30c8\u306e\u516c\u958b\u7528\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3067\u306a\u304f\u3001\n\u4e0b\u8a18\u306e\u3088\u3046\u306a\u30db\u30fc\u30e0\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306b\u7528\u610f\u3057\u305f\u3001public\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u516c\u958b\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306b\u3059\u308b\u3053\u3068\n\u203b\u30cf\u30de\u30c3\u305f\u306e\u3067\u3001\u8a18\u8f09\n\n\u524d\u63d0\n\nnginx\u30a4\u30f3\u30b9\u30c8\u6e08\u307f\n\n\nnginx\u5074\u306e\u8a2d\u5b9a\n\n/etc/nginx/conf.d/hogehoe.conf\nserver {\n    listen 80;\n    server_name hogehoge;\n    charset utf8;\n    root /var/www/hoge; # \u30b7\u30f3\u30dc\u30ea\u30c3\u30af\u30ea\u30f3\u30af\u6e08\u307f\u3000-> /home/hoge/project/public\n    #root /home/hoge/project/public;\n    index index.php;\n    client_max_body_size 128M;\n\n\n    location / {\n            if (!-e $request_filename) {\n                    rewrite ^/(.*)$ /index.php/$1 last;\n                    break;\n            }\n    }\n    location ~* \\.(gif|jpg|png)$ {\n      expires 30d;\n    }\n    location ~ [^/]\\.php(/|$) {\n            fastcgi_split_path_info ^(.+?\\.php)(/.*)$;\n            if (!-f $document_root$fastcgi_script_name) {\n                    return 404;\n            }\n            include fastcgi_params;\n            fastcgi_pass unix:/var/run/php-fpm/php-fpm.sock;\n            fastcgi_index index.php;\n            fastcgi_buffers 4 256k;\n            fastcgi_busy_buffers_size 256k;\n            fastcgi_temp_file_write_size 256k;\n            fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;\n            fastcgi_param PATH_INFO $fastcgi_path_info;\n            fastcgi_param REQUEST_FILENAME $request_filename;\n    }\n    error_page   500 502 503 504  /error.html;\n    location = /error.html {\n            root /usr/share/nginx/html;\n    }\n}\n\n\n\u3067\u3001nginx\u8d77\u52d5\n\n$ sudo service nginx start\n\n\u3068\u3059\u308b\u3068\u3001\n2015/08/16 22:27:27 [crit] 1917#0: *4 stat() \"/home/hoge/project/public\" failed (13: Permission denied), client: 192.168.33.1, server: hogehoge, request: \"GET / HTTP/1.1\", host: \"hogehoge\"\n\n\u3048\u3001\u30d1\u30fc\u30df\u30c3\u30b7\u30e7\u30f3\u30a8\u30e9\u30fc\u3060\u3068\u30fb\u30fb\u30fb\n\u78ba\u304b\u306b\u3001\n/home/hoge\n\n\u306bnginx\u30e6\u30fc\u30b6\u30fc\u3067\u30a2\u30af\u30bb\u30b9\u3059\u308b\u308f\u3051\u3060\u3057\u30fb\u30fb\u30fb\n\u3068\u3044\u3046\u3053\u3068\u3067\u3001\u30d1\u30fc\u30df\u30c3\u30b7\u30e7\u30f3\u5909\u66f4\u2026\n# chmod o+x -R /home/hoge \n# service nginx restart\n\n\u304c\u3001\n2015/08/16 22:27:27 [crit] 1917#0: *4 stat() \"/home/hoge/project/public\" failed (13: Permission denied), client: 192.168.33.1, server: hogehoge, request: \"GET / HTTP/1.1\", host: \"hogehoge\"\n\n\u5909\u308f\u3089\u305a\u30fb\u30fb\u30fb\n\u30db\u30fc\u30e0\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306e\u6240\u6709\u30b0\u30eb\u30fc\u30d7\u306bnginx\u30e6\u30fc\u30b6\u30fc\u3092\u8ffd\u52a0\u3082\u3084\u3063\u3066\u307f\u305f\u304c\u3001\u5909\u308f\u3089\u305a\u2026\n\u3067\u3001\u3082\u3046\u5c11\u3057\u8abf\u3079\u3066\u307f\u308b\u3068\u30fb\u30fb\u30fbSELinux might be blocking\u306a\u3093\u3058\u3083\u306a\u3044\u304b\u3068\u30fb\u30fb\u30fb\n\u307e\u305a\u306f\u3001\n# \u72b6\u614b\u78ba\u8a8d\n$ getenforce\nEnforcing\n\n\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u3057\u3066\u3001\u78ba\u8a8d\u3057\u3066\u3082\u3088\u3044\u304b\u3082\u3002\n\n$ setenforce 0 #selinux\u3092\u30aa\u30d5\u306b\u3059\u308b\n\n\u3067\u3001\u30d6\u30e9\u30a6\u30b6\u304b\u3089\u30a2\u30af\u30bb\u30b9\u3067\u304d\u308b\u304b\u3002\u3067\u304d\u305f\u3089\u3001selinux\u306e\u8a2d\u5b9a\u6f0f\u308c\u3002\n\u3067\u3001\u81ea\u5206\u306e\u30b1\u30fc\u30b9\u306b\u8a71\u3092\u623b\u3059\u3068\u3001\u78ba\u304b\u306b\u3001selinux\u304c\u6709\u52b9\u306b\u306a\u3063\u3066\u3044\u3066\u3001\u30d1\u30fc\u30df\u30c3\u30b7\u30e7\u30f3\u30a8\u30e9\u30fc\u306b\u306a\u3063\u305f\u30fb\u30fb\u30fb\n\u3066\u3053\u3068\u306f\u3001\u30dd\u30ea\u30b7\u30fc\u8a2d\u5b9a\u304c\u306a\u3044\u304b\u3089\uff1f\n\u3067\u3001\u3055\u3063\u305d\u304f\u78ba\u8a8d\u3002\n$ sudo cat /var/log/audit/audit.log | grep nginx | audit2allow -m nginx\nmodule nginx 1.0;\nrequire {\ntype httpd_t;\ntype user_home_t;\ntype usr_t;\nclass file { write open };\nclass dir { search open getattr };\n}\n#============= httpd_t ==============\n#!!!! This avc can be allowed using one of the these booleans:\n#     httpd_read_user_content, httpd_enable_homedirs\nallow httpd_t user_home_t:dir { search open getattr };\n#!!!! This avc can be allowed using the boolean 'httpd_read_user_content'\nallow httpd_t user_home_t:file open;\nallow httpd_t user_home_t:file { write open };\nallow httpd_t usr_t:file write;\n\n\u30dd\u30ea\u30b7\u30fc\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\n$ sudo cat /var/log/audit/audit.log | audit2allow -M nginx\n******************** IMPORTANT ***********************\nTo make this policy package active, execute:\n\nsemodule -i nginx.pp\n\n\u3057\u3066\u3001\u9069\u7528\n$ sudo semodule -i nginx.pp\n\n\u5b8c\u4e86\u5f8c\u3001\u518d\u5ea6\u30b5\u30a4\u30c8\u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3068\u4eca\u5ea6\u306f\u30b5\u30a4\u30c8\u304c\u8868\u793a\u3055\u308c\u307e\u3057\u305f\uff01\n\u304c\u3001SELinux\u304c\u3069\u3046\u3060\u3063\u305f\u304b\u3089\u4f55\u304c\u8d77\u304d\u3066\u3044\u3066\u3001\u30a2\u30af\u30bb\u30b9\u304c\u3067\u304d\u3066\u3044\u306a\u304b\u3063\u305f\u306e\u304b\u3001\u7406\u89e3\u304c\u3067\u304d\u3066\u3044\u306a\u3044\u30fb\u30fb\u30fb\u307e\u305a\u306f\u3001\u5099\u5fd8\u9332\u306b\u3057\u3068\u304d\u307e\u3059\u3002\n\u8ffd\u8a18\u2026\n\u3084\u306f\u308a\u3001selinux\u304c\u6709\u52b9\u306a\u306e\u306b\u3001\u30a2\u30af\u30bb\u30b9\u8a31\u53ef\u3059\u308b\u30dd\u30ea\u30b7\u30fc\u8a2d\u5b9a\u304c\u306a\u304b\u3063\u305f\u305f\u3081\u3001\u30a2\u30af\u30bb\u30b9\u5236\u5fa1\u306b\u5f15\u3063\u304b\u304b\u3063\u3066\u3057\u307e\u3063\u3066\u3044\u305f\u3068\u3046\u3053\u3068\u3067\u3057\u305f\u3002\n\u4eca\u56de\u306f\u4e0a\u8a18\u306e\u3088\u3046\u306b\u5bfe\u5fdc\u3057\u307e\u3057\u305f\u304c\u3001\u305d\u3082\u305d\u3082\u3001selinux\u306e\u30e2\u30fc\u30c9\u306f\u4e0b\u8a18\u306e\u901a\u308a\u3002\n\nenforce\npemissive\ndisabled\n\n\u7121\u52b9\u306b\u3059\u308b\u306a\u3089disabled\u3001selinux\u306f\u6709\u52b9\u306b\u3059\u308b\u304c\u30a2\u30af\u30bb\u30b9\u8a31\u53ef\u3057\u3001\u30ed\u30b0\u51fa\u529b\u306e\u307f\u306b\u3059\u308b\u306a\u3089\u3001pemissive\u3001\u30a2\u30af\u30bb\u30b9\u4e0d\u8a31\u53ef\u306a\u3089enforce\n\u3063\u3066\u3053\u3068\u3067\u3001pemissive\u30e2\u30fc\u30c9\u306b\u3057\u3066\u3082\u89e3\u6c7a\u3067\u3057\u305f\u3002\n\n\u53c2\u8003\n\nSELINUX + NGINX \u30dd\u30ea\u30b7\u30fc\u8a2d\u5b9a\nNginx: stat() failed (13: permission denied)\nselinux\u3068\u306f\n\n## \u3084\u3063\u305f\u3053\u3068\n\u8868\u984c\u306e\u901a\u308a\u3067\u3059\u304c\u3001nginx\u3092\u4f7f\u3063\u3066\u3001\u30c7\u30d5\u30a9\u30eb\u30c8\u306e\u516c\u958b\u7528\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3067\u306a\u304f\u3001\n\u4e0b\u8a18\u306e\u3088\u3046\u306a\u30db\u30fc\u30e0\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306b\u7528\u610f\u3057\u305f\u3001public\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u516c\u958b\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306b\u3059\u308b\u3053\u3068\n\u203b\u30cf\u30de\u30c3\u305f\u306e\u3067\u3001\u8a18\u8f09\n\n\n## \u524d\u63d0\n+ nginx\u30a4\u30f3\u30b9\u30c8\u6e08\u307f\n\n## nginx\u5074\u306e\u8a2d\u5b9a\n\n```lang:/etc/nginx/conf.d/hogehoe.conf\nserver {\n    listen 80;\n    server_name hogehoge;\n    charset utf8;\n    root /var/www/hoge; # \u30b7\u30f3\u30dc\u30ea\u30c3\u30af\u30ea\u30f3\u30af\u6e08\u307f\u3000-> /home/hoge/project/public\n    #root /home/hoge/project/public;\n    index index.php;\n    client_max_body_size 128M;\n\n\n    location / {\n            if (!-e $request_filename) {\n                    rewrite ^/(.*)$ /index.php/$1 last;\n                    break;\n            }\n    }\n    location ~* \\.(gif|jpg|png)$ {\n      expires 30d;\n    }\n    location ~ [^/]\\.php(/|$) {\n            fastcgi_split_path_info ^(.+?\\.php)(/.*)$;\n            if (!-f $document_root$fastcgi_script_name) {\n                    return 404;\n            }\n            include fastcgi_params;\n            fastcgi_pass unix:/var/run/php-fpm/php-fpm.sock;\n            fastcgi_index index.php;\n            fastcgi_buffers 4 256k;\n            fastcgi_busy_buffers_size 256k;\n            fastcgi_temp_file_write_size 256k;\n            fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;\n            fastcgi_param PATH_INFO $fastcgi_path_info;\n            fastcgi_param REQUEST_FILENAME $request_filename;\n    }\n    error_page   500 502 503 504  /error.html;\n    location = /error.html {\n            root /usr/share/nginx/html;\n    }\n}\n```\n\n\u3067\u3001nginx\u8d77\u52d5\n```\n$ sudo service nginx start\n```\n\u3068\u3059\u308b\u3068\u3001\n\n```\n2015/08/16 22:27:27 [crit] 1917#0: *4 stat() \"/home/hoge/project/public\" failed (13: Permission denied), client: 192.168.33.1, server: hogehoge, request: \"GET / HTTP/1.1\", host: \"hogehoge\"\n```\n\u3048\u3001\u30d1\u30fc\u30df\u30c3\u30b7\u30e7\u30f3\u30a8\u30e9\u30fc\u3060\u3068\u30fb\u30fb\u30fb\n\u78ba\u304b\u306b\u3001\n\n```\n/home/hoge\n```\n\u306bnginx\u30e6\u30fc\u30b6\u30fc\u3067\u30a2\u30af\u30bb\u30b9\u3059\u308b\u308f\u3051\u3060\u3057\u30fb\u30fb\u30fb\n\u3068\u3044\u3046\u3053\u3068\u3067\u3001\u30d1\u30fc\u30df\u30c3\u30b7\u30e7\u30f3\u5909\u66f4\u2026\n\n```\n# chmod o+x -R /home/hoge \n# service nginx restart\n```\n\n\u304c\u3001\n\n```\n2015/08/16 22:27:27 [crit] 1917#0: *4 stat() \"/home/hoge/project/public\" failed (13: Permission denied), client: 192.168.33.1, server: hogehoge, request: \"GET / HTTP/1.1\", host: \"hogehoge\"\n```\n\n\u5909\u308f\u3089\u305a\u30fb\u30fb\u30fb\n\u30db\u30fc\u30e0\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306e\u6240\u6709\u30b0\u30eb\u30fc\u30d7\u306bnginx\u30e6\u30fc\u30b6\u30fc\u3092\u8ffd\u52a0\u3082\u3084\u3063\u3066\u307f\u305f\u304c\u3001\u5909\u308f\u3089\u305a\u2026\n\u3067\u3001\u3082\u3046\u5c11\u3057\u8abf\u3079\u3066\u307f\u308b\u3068\u30fb\u30fb\u30fb[SELinux might be blocking](http://stackoverflow.com/questions/29775259/nginx-stat-failed-13-permission-denied-when-browsing)\u306a\u3093\u3058\u3083\u306a\u3044\u304b\u3068\u30fb\u30fb\u30fb\n\n\u307e\u305a\u306f\u3001\n\n```\n# \u72b6\u614b\u78ba\u8a8d\n$ getenforce\nEnforcing\n```\n\n\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u3057\u3066\u3001\u78ba\u8a8d\u3057\u3066\u3082\u3088\u3044\u304b\u3082\u3002\n```\n$ setenforce 0 #selinux\u3092\u30aa\u30d5\u306b\u3059\u308b\n```\n\u3067\u3001\u30d6\u30e9\u30a6\u30b6\u304b\u3089\u30a2\u30af\u30bb\u30b9\u3067\u304d\u308b\u304b\u3002\u3067\u304d\u305f\u3089\u3001selinux\u306e\u8a2d\u5b9a\u6f0f\u308c\u3002\n\n\n\u3067\u3001\u81ea\u5206\u306e\u30b1\u30fc\u30b9\u306b\u8a71\u3092\u623b\u3059\u3068\u3001\u78ba\u304b\u306b\u3001selinux\u304c\u6709\u52b9\u306b\u306a\u3063\u3066\u3044\u3066\u3001\u30d1\u30fc\u30df\u30c3\u30b7\u30e7\u30f3\u30a8\u30e9\u30fc\u306b\u306a\u3063\u305f\u30fb\u30fb\u30fb\n\u3066\u3053\u3068\u306f\u3001\u30dd\u30ea\u30b7\u30fc\u8a2d\u5b9a\u304c\u306a\u3044\u304b\u3089\uff1f\n\n\u3067\u3001\u3055\u3063\u305d\u304f\u78ba\u8a8d\u3002\n\n```\n$ sudo cat /var/log/audit/audit.log | grep nginx | audit2allow -m nginx\nmodule nginx 1.0;\nrequire {\ntype httpd_t;\ntype user_home_t;\ntype usr_t;\nclass file { write open };\nclass dir { search open getattr };\n}\n#============= httpd_t ==============\n#!!!! This avc can be allowed using one of the these booleans:\n#     httpd_read_user_content, httpd_enable_homedirs\nallow httpd_t user_home_t:dir { search open getattr };\n#!!!! This avc can be allowed using the boolean 'httpd_read_user_content'\nallow httpd_t user_home_t:file open;\nallow httpd_t user_home_t:file { write open };\nallow httpd_t usr_t:file write;\n```\n\n\u30dd\u30ea\u30b7\u30fc\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\n\n```\n$ sudo cat /var/log/audit/audit.log | audit2allow -M nginx\n******************** IMPORTANT ***********************\nTo make this policy package active, execute:\n \nsemodule -i nginx.pp\n```\n\n\u3057\u3066\u3001\u9069\u7528\n\n```\n$ sudo semodule -i nginx.pp\n```\n\n\u5b8c\u4e86\u5f8c\u3001\u518d\u5ea6\u30b5\u30a4\u30c8\u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3068\u4eca\u5ea6\u306f\u30b5\u30a4\u30c8\u304c\u8868\u793a\u3055\u308c\u307e\u3057\u305f\uff01\n\n\u304c\u3001SELinux\u304c\u3069\u3046\u3060\u3063\u305f\u304b\u3089\u4f55\u304c\u8d77\u304d\u3066\u3044\u3066\u3001\u30a2\u30af\u30bb\u30b9\u304c\u3067\u304d\u3066\u3044\u306a\u304b\u3063\u305f\u306e\u304b\u3001\u7406\u89e3\u304c\u3067\u304d\u3066\u3044\u306a\u3044\u30fb\u30fb\u30fb\u307e\u305a\u306f\u3001\u5099\u5fd8\u9332\u306b\u3057\u3068\u304d\u307e\u3059\u3002\n\n\u8ffd\u8a18\u2026\n\u3084\u306f\u308a\u3001selinux\u304c\u6709\u52b9\u306a\u306e\u306b\u3001\u30a2\u30af\u30bb\u30b9\u8a31\u53ef\u3059\u308b\u30dd\u30ea\u30b7\u30fc\u8a2d\u5b9a\u304c\u306a\u304b\u3063\u305f\u305f\u3081\u3001\u30a2\u30af\u30bb\u30b9\u5236\u5fa1\u306b\u5f15\u3063\u304b\u304b\u3063\u3066\u3057\u307e\u3063\u3066\u3044\u305f\u3068\u3046\u3053\u3068\u3067\u3057\u305f\u3002\n\n\n\u4eca\u56de\u306f\u4e0a\u8a18\u306e\u3088\u3046\u306b\u5bfe\u5fdc\u3057\u307e\u3057\u305f\u304c\u3001\u305d\u3082\u305d\u3082\u3001selinux\u306e\u30e2\u30fc\u30c9\u306f\u4e0b\u8a18\u306e\u901a\u308a\u3002\n\n* enforce\n* pemissive\n* disabled\n\n\u7121\u52b9\u306b\u3059\u308b\u306a\u3089disabled\u3001selinux\u306f\u6709\u52b9\u306b\u3059\u308b\u304c\u30a2\u30af\u30bb\u30b9\u8a31\u53ef\u3057\u3001\u30ed\u30b0\u51fa\u529b\u306e\u307f\u306b\u3059\u308b\u306a\u3089\u3001pemissive\u3001\u30a2\u30af\u30bb\u30b9\u4e0d\u8a31\u53ef\u306a\u3089enforce\n\n\u3063\u3066\u3053\u3068\u3067\u3001pemissive\u30e2\u30fc\u30c9\u306b\u3057\u3066\u3082\u89e3\u6c7a\u3067\u3057\u305f\u3002\n\n## \u53c2\u8003\n+ [SELINUX + NGINX \u30dd\u30ea\u30b7\u30fc\u8a2d\u5b9a](http://blog.higty.xyz/archives/242)\n+ [Nginx: stat() failed (13: permission denied)](http://stackoverflow.com/questions/25774999/nginx-stat-failed-13-permission-denied)\n+ [selinux\u3068\u306f](http://itpro.nikkeibp.co.jp/article/COLUMN/20060718/243512/?s2p)\n", "tags": ["nginx", "Linux", "SELinux", "php-fpm", "FuelPHP"]}