{"context": "\n\n\u80cc\u666f\nGCE -> CloudSQL\u3078\u306e\u63a5\u7d9a\u306bcloud_sql_proxy\u3092\u4f7f\u3063\u3066\u82e6\u52b4\u3057\u305f\u306e\u3067\u30e1\u30e2\u3002\nhttps://cloud.google.com/sql/docs/mysql-connect-proxy?hl=ja\n\n\u30b5\u30f3\u30d7\u30eb\n## mysql\u306e\u8a2d\u5b9a(\u5fc5\u8981\u306a\u3044\u306a\u3089\u30b9\u30ad\u30c3\u30d7)\n- name: add repo\n  command: rpm -ih http://dev.mysql.com/get/mysql57-community-release-el7-7.noarch.rpm creates=/etc/yum.repos.d/mysql-community.repo\n\n- name: install mysql-devel\n  yum: name=mysql-community-devel.x86_64 state=installed\n\n## \u3053\u3053\u304b\u3089cloud_sql_proxy\u306e\u8a2d\u5b9a\n- name: get cloud_sql_proxy file\n  stat: path=cloud_sql_proxy\n  register: proxy_file\n\n- name: download cloud_sql_proxy\n  when: proxy_file.stat.exists == false\n  get_url:\n    url: https://dl.google.com/cloudsql/cloud_sql_proxy.linux.amd64\n    dest: ./\n\n- name: mv gcs\n  when: proxy_file.stat.exists == false\n  command: mv cloud_sql_proxy.linux.amd64 cloud_sql_proxy\n\n- name: permission of gcs\n  when: proxy_file.stat.exists == false\n  file:\n    path: cloud_sql_proxy\n    owner: deployer\n    group: deployer\n    mode: 0775\n\n- name: run gcs\n  when: proxy_file.stat.exists == false\n  shell: ./cloud_sql_proxy -instances={{ cloud_sql_connect }}=tcp:3306  >& /var/log/cloud_sql_proxy.log &\n  args:\n    chdir: /home/deployer\n  async: 5\n  poll: 0\n\n\nMEMO\n\n\u5909\u6570\n\n\ncloud_sql_connect: cloud_sql\u306e\u63a5\u7d9a\u60c5\u5831(project_id:asia-norteast-1:instance_name\u307f\u305f\u3044\u306a\u3084\u3064)\n\nlogin_user: ssh\u30ed\u30b0\u30a4\u30f3\u30e6\u30fc\u30b6\u30fc\n\n\n\u306f\u307e\u3063\u305f\u3068\u3053\n\nchdir\u306blogin_user\u306e\u30db\u30fc\u30e0\u3092\u6307\u5b9a\u3057\u306a\u3044\u3068\u5b9f\u884c\u3067\u304d\u306a\u304b\u3063\u305f\n\n\n\nbecome: true \u3067\u5b9f\u884c\u3057\u3066\u305f\u306e\u3067root\u306e\u30db\u30fc\u30e0\u306b\u3044\u305f\u3063\u307d\u3044\n\n\n\u8d77\u52d5\u30b9\u30af\u30ea\u30d7\u30c8\u306b >& /log/output \u304c\u306a\u3044\u3068process\u306f\u8d77\u52d5\u3059\u308b\u3051\u3069\u3001\u63a5\u7d9a\u6642\u306b\u30d7\u30ed\u30bb\u30b9\u843d\u3061\u308b\n\n## \u80cc\u666f\nGCE -> CloudSQL\u3078\u306e\u63a5\u7d9a\u306bcloud_sql_proxy\u3092\u4f7f\u3063\u3066\u82e6\u52b4\u3057\u305f\u306e\u3067\u30e1\u30e2\u3002\n\nhttps://cloud.google.com/sql/docs/mysql-connect-proxy?hl=ja\n\n## \u30b5\u30f3\u30d7\u30eb\n\n```\n## mysql\u306e\u8a2d\u5b9a(\u5fc5\u8981\u306a\u3044\u306a\u3089\u30b9\u30ad\u30c3\u30d7)\n- name: add repo\n  command: rpm -ih http://dev.mysql.com/get/mysql57-community-release-el7-7.noarch.rpm creates=/etc/yum.repos.d/mysql-community.repo\n\n- name: install mysql-devel\n  yum: name=mysql-community-devel.x86_64 state=installed\n\n## \u3053\u3053\u304b\u3089cloud_sql_proxy\u306e\u8a2d\u5b9a\n- name: get cloud_sql_proxy file\n  stat: path=cloud_sql_proxy\n  register: proxy_file\n\n- name: download cloud_sql_proxy\n  when: proxy_file.stat.exists == false\n  get_url:\n    url: https://dl.google.com/cloudsql/cloud_sql_proxy.linux.amd64\n    dest: ./\n\n- name: mv gcs\n  when: proxy_file.stat.exists == false\n  command: mv cloud_sql_proxy.linux.amd64 cloud_sql_proxy\n\n- name: permission of gcs\n  when: proxy_file.stat.exists == false\n  file:\n    path: cloud_sql_proxy\n    owner: deployer\n    group: deployer\n    mode: 0775\n\n- name: run gcs\n  when: proxy_file.stat.exists == false\n  shell: ./cloud_sql_proxy -instances={{ cloud_sql_connect }}=tcp:3306  >& /var/log/cloud_sql_proxy.log &\n  args:\n    chdir: /home/deployer\n  async: 5\n  poll: 0\n```\n## MEMO\n### \u5909\u6570\n- `cloud_sql_connect`: cloud_sql\u306e\u63a5\u7d9a\u60c5\u5831(`project_id:asia-norteast-1:instance_name`\u307f\u305f\u3044\u306a\u3084\u3064)\n- `login_user`: ssh\u30ed\u30b0\u30a4\u30f3\u30e6\u30fc\u30b6\u30fc\n\n### \u306f\u307e\u3063\u305f\u3068\u3053\n  - chdir\u306blogin_user\u306e\u30db\u30fc\u30e0\u3092\u6307\u5b9a\u3057\u306a\u3044\u3068\u5b9f\u884c\u3067\u304d\u306a\u304b\u3063\u305f\n    - `become: true` \u3067\u5b9f\u884c\u3057\u3066\u305f\u306e\u3067root\u306e\u30db\u30fc\u30e0\u306b\u3044\u305f\u3063\u307d\u3044\n  - \u8d77\u52d5\u30b9\u30af\u30ea\u30d7\u30c8\u306b `>& /log/output` \u304c\u306a\u3044\u3068process\u306f\u8d77\u52d5\u3059\u308b\u3051\u3069\u3001\u63a5\u7d9a\u6642\u306b\u30d7\u30ed\u30bb\u30b9\u843d\u3061\u308b\n", "tags": ["GoogleCloudPlatform", "gcp", "Ansible"]}