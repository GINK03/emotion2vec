{"context": "Symfony Advent Calendar 2016 \u306e 13\u65e5\u76ee\u306e\u6295\u7a3f\u3067\u3059\u3002FOSOAuthServerBundle \u306e\u57fa\u672c\u7684\u306a\u5c0e\u5165\u3068\u5229\u7528\u306b\u3064\u3044\u3066\u65e5\u672c\u8a9e\u3067\u307e\u3068\u307e\u3063\u3066\u3044\u308b\u8a18\u4e8b\u304c\u306a\u304b\u3063\u305f\u306e\u3067\u66f8\u3044\u3066\u307f\u307e\u3057\u305f\u3002WEB API\u3001\u30e6\u30fc\u30b6\u30fc\u30b7\u30b9\u30c6\u30e0\u306e\u4e0b\u5730\u3068\u3057\u3066\u3001FOSRestBundle, FOSUserBunble \u3082\u5229\u7528\u3057\u3066\u3044\u307e\u3059\u3002\n\u4eca\u56de\u3001\u5b9f\u88c5\u3057\u305f\u30c7\u30e2\u7528\u306e\u30bd\u30fc\u30b9\u30b3\u30fc\u30c9\u306f\u4ee5\u4e0b\u306b\u7f6e\u3044\u3066\u7f6e\u3044\u3066\u3042\u308a\u307e\u3059  \n\nhttps://github.com/kseta/symfony-oauth-server\n\n\n\u6982\u8981\n\n\nFOSOAuthServerBundle \u3092\u5229\u7528\u3057\u3066\u30c8\u30fc\u30af\u30f3\u8a8d\u8a3c\u304c\u5fc5\u8981\u306a WEB API \u306e\u30c7\u30e2\u3092\u4f5c\u308a\u307e\u3057\u305f\u3002\nFOSOAuthServerBundle \u306b\u3088\u308b \u30c8\u30fc\u30af\u30f3\u767a\u884c\u3001\u30c8\u30fc\u30af\u30f3\u306e\u30ea\u30d5\u30ec\u30c3\u30b7\u30e5\u3001\u6709\u52b9\u671f\u9650\u304c\u5207\u308c\u305f\u30c8\u30fc\u30af\u30f3\u306e\u524a\u9664 \u306e\u65b9\u6cd5\u306b\u3064\u3044\u3066\u8aac\u660e\u3057\u307e\u3057\u305f\u3002\n\n\n1. \u74b0\u5883\n\n\nSymfony 2.8\nPHP 7.0.8\nMySQL\n\n\n2. \u30e6\u30fc\u30b6\u30fc\u30b7\u30b9\u30c6\u30e0\u3068\u30c7\u30e2 API \u3092\u4f5c\u6210\n\n\u3067\u306f\u3001\u3055\u3063\u305d\u304f\u53d6\u308a\u639b\u304b\u3063\u3066\u3044\u304d\u307e\u3059\u3002\n\u307e\u305a\u3001Symfony Installer \u3067\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u3092\u4f5c\u6210\u3057\u3001FOSRestBundle, FOSUserBundle \u3092\u8ffd\u52a0\u3057\u30e6\u30fc\u30b6\u30fc\u30b7\u30b9\u30c6\u30e0\u3068\u30c7\u30e2 API \u3092\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u3057\u3066\u3044\u304d\u307e\u3059\u3002\u624b\u9806\u306e\u8aac\u660e\u306f\u3001\u516c\u5f0f\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u306b\u8a18\u8f09\u304c\u3042\u308a\u307e\u3059\u306e\u3067\u4eca\u56de\u306f\u7701\u7565\u3057\u307e\u3059\u3002\u4ee5\u4e0b\u306e\u516c\u5f0f\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u3092\u53c2\u8003\u306b\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\nInstalling & Setting up the Symfony Framework\nGetting Started With FOSRestBundle\nGetting Started With FOSUserBundle\n\n\nSTEP 2.1 \u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u306e\u4f5c\u6210\n\n$ symfony new symfony-oauth-sever 2.8\n$ cd symfony-oauth-server\n\n\n\u53c2\u8003: Installing & Setting up the Symfony Framework\n\n\n\nSTEP 2.2 Bundle \u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n$ composer require friendsofsymfony/rest-bundle 1.3.*\n$ composer require friendsofsymfony/user-bundle\n$ composer require jms/serializer-bundle\n\n\napp/AppKernel.php\n...\n\nclass AppKernel extends Kernel\n{\n    public function registerBundles()\n    {\n        $bundles = array(\n            new Symfony\\Bundle\\FrameworkBundle\\FrameworkBundle(),\n            new Symfony\\Bundle\\SecurityBundle\\SecurityBundle(),\n            new Symfony\\Bundle\\TwigBundle\\TwigBundle(),\n            new Symfony\\Bundle\\MonologBundle\\MonologBundle(),\n            new Symfony\\Bundle\\SwiftmailerBundle\\SwiftmailerBundle(),\n            new Doctrine\\Bundle\\DoctrineBundle\\DoctrineBundle(),\n            new Sensio\\Bundle\\FrameworkExtraBundle\\SensioFrameworkExtraBundle(),\n            new AppBundle\\AppBundle(),\n\n            // \u8ffd\u52a0\n            new FOS\\RestBundle\\FOSRestBundle(),\n            new FOS\\UserBundle\\FOSUserBundle(),\n            new JMS\\SerializerBundle\\JMSSerializerBundle(),\n        );\n\n...\n\n}\n\n\n\nSTEP 2.3 Bundle \u306e\u8a2d\u5b9a\n\n\napp/config/config.yml\nfos_rest:\n    routing_loader:\n        default_format: json\n        include_format: false\n\nfos_user:\n    db_driver: orm\n    firewall_name: api\n    user_class: AppBundle\\Entity\\User\n\n\n\napp/config/security.yml\nsecurity:\n    encoders:\n        FOS\\UserBundle\\Model\\UserInterface: bcrypt\n\n\n\nSTEP 2.4 User Entity \u30af\u30e9\u30b9\u306e\u4f5c\u6210\n\n\nsrc/AppBundle/Entity/User.php\n<?php\n// src/AppBundle/Entity/User.php\n\nnamespace AppBundle\\Entity;\n\nuse FOS\\UserBundle\\Model\\User as BaseUser;\nuse Doctrine\\ORM\\Mapping as ORM;\n\n/**\n * @ORM\\Entity\n * @ORM\\Table(name=\"fos_user\")\n */\nclass User extends BaseUser\n{\n    /**\n     * @ORM\\Id\n     * @ORM\\Column(type=\"integer\")\n     * @ORM\\GeneratedValue(strategy=\"AUTO\")\n     */\n    protected $id;\n\n    public function __construct()\n    {\n        parent::__construct();\n        // your own logic\n    }\n}\n\n\n\nSTEP 2.5 \u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306e\u6e96\u5099\n\n$ php app/console doctrine:database:create\n$ php app/console doctrine:schema:update --force\n\nmysql> use symfony-oauth-server;\nmysql> show tables;\n+--------------------------------+\n| Tables_in_symfony-oauth-server |\n+--------------------------------+\n| fos_user                       |\n+--------------------------------+\n1 rows in set (0.00 sec)\n\n\nSTEP 2.6 \u30e6\u30fc\u30b6\u306e\u4f5c\u6210\n\n$ php app/console fos:user:create\n\nPlease choose a username:admin\nPlease choose an email:admin@example.com\nPlease choose a password:adminpass\nCreated user admin\n\nmysql> select * from fos_user;\n+----+----------+--------------------+-------------------+-------------------+---------+---------------------------------+--------------------------------------------------------------+------------+--------+---------+------------+--------------------+-----------------------+--------+---------------------+-----------------------+\n| id | username | username_canonical | email             | email_canonical   | enabled | salt                            | password                                                     | last_login | locked | expired | expires_at | confirmation_token | password_requested_at | roles  | credentials_expired | credentials_expire_at |\n+----+----------+--------------------+-------------------+-------------------+---------+---------------------------------+--------------------------------------------------------------+------------+--------+---------+------------+--------------------+-----------------------+--------+---------------------+-----------------------+\n|  1 | admin    | admin              | admin@example.com | admin@example.com |       1 | kjflxygblxcwccgkg4o4ooggkckgggw | $2y$13$kjflxygblxcwccgkg4o4oe34L7Y6Iorvaz4V5Sr9lg3nbSnHn.b.i | NULL       |      0 |       0 | NULL       | NULL               | NULL                  | a:0:{} |                   0 | NULL                  |\n+----+----------+--------------------+-------------------+-------------------+---------+---------------------------------+--------------------------------------------------------------+------------+--------+---------+------------+--------------------+-----------------------+--------+---------------------+-----------------------+\n1 row in set (0.01 sec)\n\n\nSTEP 2.7 API \u306e\u4f5c\u6210\n\n\napp/config/routing.yml\napi:\n    resource: \"@AppBundle/Controller/\"\n    prefix:   api\n    type:     rest\n\n\n\nsrc/AppBundle/Controller/WelcomeController.php\n<?php\n\nnamespace AppBundle\\Controller;\n\nuse FOS\\RestBundle\\Controller\\Annotations\\RouteResource;\nuse FOS\\RestBundle\\Controller\\FOSRestController;\n\n/**\n * @RouteResource(\"welcome\")\n */\nclass WelcomeController extends FOSRestController\n{\n    public function getAction()\n    {\n        return [\"welcome!\"];\n    }\n}\n\n\n\nSTEP 2.8 \u52d5\u4f5c\u78ba\u8a8d\n\nPHP \u306e build-in server \u3067\u52d5\u4f5c\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n$ php app/console server:start\n\nHTTP \u306e\u30ea\u30af\u30a8\u30b9\u30c8\u306b\u306f HTTPie \u3092\u5229\u7528\u3057\u3066\u3044\u307e\u3059\u3002\u30e6\u30fc\u30b6\u30fc\u30d5\u30ec\u30f3\u30c9\u30ea\u30fc\u306a\u30b7\u30f3\u30bf\u30c3\u30af\u30b9\u3084\u30cf\u30a4\u30e9\u30a4\u30c8\u3092\u63d0\u4f9b\u3057\u3066\u304f\u308c\u3066 JSON \u306b\u3082\u5bfe\u5fdc\u3057\u3066\u3044\u308b\u305f\u3081\u30aa\u30b9\u30b9\u30e1\u3067\u3059\u3002\n$ http GET http://localhost:8000/app_dev.php/api/welcome\n\nHTTP/1.1 200 OK\nCache-Control: no-cache\nContent-Type: application/json\n\n[\n    \"welcome!\"\n]\n\n\u30fb\u30fb\u30fb\u306f\u3044\u3001\u3055\u304f\u3063\u3068\u3067\u304d\u307e\u3057\u305f\u306d  \u65b0\u3057\u3044\u30d0\u30f3\u30c9\u30eb\u5c0e\u5165\u65b9\u6cd5\u306f\u3001\u591a\u304f\u306e\u30d0\u30f3\u30c9\u30eb\u3067\u540c\u3058\u6d41\u308c\u304c\u591a\u3044\u306e\u3067\u3044\u307e\u3044\u3061\u30d4\u30f3\u3068\u6765\u3066\u306a\u3044\u65b9\u306f\u518d\u5ea6\u304a\u3055\u3089\u3044\u3057\u3066\u304a\u304f\u3053\u3068\u3092\u30aa\u30b9\u30b9\u30e1\u3057\u307e\u3059  \n\n3. FOSOAuthServerBundle \u3092\u5c0e\u5165\u3059\u308b\n\n\u3067\u306f\u3001\u3053\u3053\u304b\u3089\u304c\u672c\u7de8\u3067\u3059\u3002FOSOAuthServerBundle \u3092\u4f7f\u3063\u3066\u3044\u304d\u307e\u3059\u3002\n\u307e\u305a\u306f\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u304b\u3089\u3002\n\nSTEP 3.1 \u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n$ composer require friendsofsymfony/oauth-server-bundle\n\n\napp/AppKernel.php\n...\n\nclass AppKernel extends Kernel\n{\n    public function registerBundles()\n    {\n        $bundles = array(\n            new Symfony\\Bundle\\FrameworkBundle\\FrameworkBundle(),\n            new Symfony\\Bundle\\SecurityBundle\\SecurityBundle(),\n            new Symfony\\Bundle\\TwigBundle\\TwigBundle(),\n            new Symfony\\Bundle\\MonologBundle\\MonologBundle(),\n            new Symfony\\Bundle\\SwiftmailerBundle\\SwiftmailerBundle(),\n            new Doctrine\\Bundle\\DoctrineBundle\\DoctrineBundle(),\n            new Sensio\\Bundle\\FrameworkExtraBundle\\SensioFrameworkExtraBundle(),\n            new AppBundle\\AppBundle(),\n\n            // \u8ffd\u52a0\n            new FOS\\OAuthServerBundle\\FOSOAuthServerBundle(),\n            new FOS\\RestBundle\\FOSRestBundle(),\n            new FOS\\UserBundle\\FOSUserBundle(),\n            new JMS\\SerializerBundle\\JMSSerializerBundle(),\n        );\n\n...\n\n}\n\n\n\nSTEP 3.2 Entity \u306e\u8ffd\u52a0\n\n\u6b21\u306b\u5229\u7528\u3059\u308b Entity \u3092\u8ffd\u52a0\u3057\u3066\u3044\u304d\u307e\u3059\u3002\u8ffd\u52a0\u3059\u308b Entity \u306f\u4ee5\u4e0b\u306e\uff14\u3064\u3067\u3059\u3002\n\n\n1) AccessToken.php\n\nsrc/AppBundle/Entity/AccessToken.php\n<?php\n\nnamespace AppBundle\\Entity;\n\nuse FOS\\OAuthServerBundle\\Entity\\AccessToken as BaseAccessToken;\nuse Doctrine\\ORM\\Mapping as ORM;\n\n/**\n * @ORM\\Entity\n */\nclass AccessToken extends BaseAccessToken\n{\n    /**\n     * @ORM\\Id\n     * @ORM\\Column(type=\"integer\")\n     * @ORM\\GeneratedValue(strategy=\"AUTO\")\n     */\n    protected $id;\n\n    /**\n     * @ORM\\ManyToOne(targetEntity=\"Client\")\n     * @ORM\\JoinColumn(nullable=false)\n     */\n    protected $client;\n\n    /**\n     * @ORM\\ManyToOne(targetEntity=\"AppBundle\\Entity\\User\")\n     */\n    protected $user;\n}\n\n\n\n\n2) AuthCode.php\n\nsrc/AppBundle/Entity/AuthCode.php\n<?php\n\nnamespace AppBundle\\Entity;\n\nuse FOS\\OAuthServerBundle\\Entity\\AuthCode as BaseAuthCode;\nuse Doctrine\\ORM\\Mapping as ORM;\n\n/**\n * @ORM\\Entity\n */\nclass AuthCode extends BaseAuthCode\n{\n    /**\n     * @ORM\\Id\n     * @ORM\\Column(type=\"integer\")\n     * @ORM\\GeneratedValue(strategy=\"AUTO\")\n     */\n    protected $id;\n\n    /**\n     * @ORM\\ManyToOne(targetEntity=\"Client\")\n     * @ORM\\JoinColumn(nullable=false)\n     */\n    protected $client;\n\n    /**\n     * @ORM\\ManyToOne(targetEntity=\"AppBundle\\Entity\\User\")\n     */\n    protected $user;\n}\n\n\n\n\n3) Client.php\n\nsrc/AppBundle/Entity/Client.php\n<?php\n\nnamespace AppBundle\\Entity;\n\nuse FOS\\OAuthServerBundle\\Entity\\Client as BaseClient;\nuse Doctrine\\ORM\\Mapping as ORM;\n\n/**\n * @ORM\\Entity\n */\nclass Client extends BaseClient\n{\n    /**\n     * @ORM\\Id\n     * @ORM\\Column(type=\"integer\")\n     * @ORM\\GeneratedValue(strategy=\"AUTO\")\n     */\n    protected $id;\n}\n\n\n\n\n4) RefreshToken.php\n\nsrc/AppBundle/Entity/RefreshToken.php\n<?php\n\nnamespace AppBundle\\Entity;\n\nuse FOS\\OAuthServerBundle\\Entity\\RefreshToken as BaseRefreshToken;\nuse Doctrine\\ORM\\Mapping as ORM;\n\n/**\n * @ORM\\Entity\n */\nclass RefreshToken extends BaseRefreshToken\n{\n    /**\n     * @ORM\\Id\n     * @ORM\\Column(type=\"integer\")\n     * @ORM\\GeneratedValue(strategy=\"AUTO\")\n     */\n    protected $id;\n\n    /**\n     * @ORM\\ManyToOne(targetEntity=\"Client\")\n     * @ORM\\JoinColumn(nullable=false)\n     */\n    protected $client;\n\n    /**\n     * @ORM\\ManyToOne(targetEntity=\"AppBundle\\Entity\\User\")\n     */\n    protected $user;\n}\n\n\n\n\n\nSTEP 3.3 \u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306e\u6e96\u5099\n\n$ php app/console doctrine:schema:update --force\n\n+--------------------------------+\n| Tables_in_symfony-oauth-server |\n+--------------------------------+\n| access_token                   |\n| auth_code                      |\n| client                         |\n| fos_user                       |\n| refresh_token                  |\n+--------------------------------+\n5 rows in set (0.00 sec)\n\n\nSTEP 3.4 \u8a2d\u5b9a\u306e\u8ffd\u52a0\n\nconfig.yml \u306b\u8a2d\u5b9a\u3092\u8ffd\u52a0\u3057\u3066\u3044\u304d\u307e\u3059\u3002\n\napp/config/config.yml\nfos_oauth_server:\n    db_driver: orm       # Drivers available: orm, mongodb, or propel\n    client_class:        AppBundle\\Entity\\Client\n    access_token_class:  AppBundle\\Entity\\AccessToken\n    refresh_token_class: AppBundle\\Entity\\RefreshToken\n    auth_code_class:     AppBundle\\Entity\\AuthCode\n    service:\n        user_provider: fos_user.user_provider.username\n\n\n\u30eb\u30fc\u30c6\u30a3\u30f3\u30b0\u3082\u8ffd\u52a0\u3057\u307e\u3059\u3002\n\napp/config/routing.yml\nfos_oauth_server_token:\n    resource: \"@FOSOAuthServerBundle/Resources/config/routing/token.xml\"\n\nfos_oauth_server_authorize:\n    resource: \"@FOSOAuthServerBundle/Resources/config/routing/authorize.xml\"\n\n\nserurity.yml \u306b\u8a8d\u8a3c\u306e\u8a2d\u5b9a\u3092\u8ffd\u52a0\u3057\u307e\u3057\u3087\u3046\u3002\n\napp/config/security.yml\n# To get started with security, check out the documentation:\n# http://symfony.com/doc/current/security.html\nsecurity:\n    encoders:\n        FOS\\UserBundle\\Model\\UserInterface: bcrypt\n\n    # http://symfony.com/doc/current/security.html#b-configuring-how-users-are-loaded\n    providers:\n        in_memory:\n            memory: ~\n\n    firewalls:\n        oauth_token:\n            pattern:    ^/oauth/v2/token\n            security:   false\n\n        api:\n            pattern:    ^/api\n            fos_oauth:  true\n            stateless:  true\n            anonymous:  false # can be omitted as its default value\n\n    access_control:\n        - { path: ^/api, roles: [ IS_AUTHENTICATED_FULLY ] }\n\n\n\u3053\u306e\u8a2d\u5b9a\u3067\u3001\u5168\u3066\u306e API \u306f\u30c8\u30fc\u30af\u30f3\u8a8d\u8a3c\u306a\u3057\u306b\u306f\u30a2\u30af\u30bb\u30b9\u3067\u304d\u306a\u308a\u307e\u3059\u3002\u3053\u3053\u307e\u3067\u9032\u3093\u3060\u3068\u3053\u308d\u3067\u3001\u5148\u7a0b\u4f5c\u6210\u3057\u305f Welcom API \u3092\u53e9\u3044\u3066\u30a2\u30af\u30bb\u30b9\u304c\u62d2\u5426\u3055\u308c\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3057\u3066\u307f\u307e\u3057\u3087\u3046\u3002\n$ http GET http://localhost:8000/app_dev.php/api/welcome\n\nHTTP/1.1 401 Unauthorized\nCache-Control: no-store, private\nContent-Type: application/json\nHost: localhost:8000\nPragma: no-cache\nWWW-Authenticate: Bearer realm=\"Service\", error=\"access_denied\", error_description=\"OAuth2 authentication required\"\n\n{\n    \"error\": \"access_denied\",\n    \"error_description\": \"OAuth2 authentication required\"\n}\n\n\u7121\u4e8b\u306b\u30a2\u30af\u30bb\u30b9\u304c\u62d2\u5426\u3055\u308c\u3066\u3044\u307e\u3059  \u3053\u3053\u304b\u3089\u306f\u3001\u3053\u306e API \u306b\u30c8\u30fc\u30af\u30f3\u8a8d\u8a3c\u3067\u30a2\u30af\u30bb\u30b9\u3067\u304d\u308b\u3088\u3046\u306b\u3057\u3066\u3044\u304d\u307e\u3059\u3002\n\n4. OAuth \u306b\u3088\u308b\u30c8\u30fc\u30af\u30f3\u8a8d\u8a3c\n\n\u306f\u3044\u3002\u3067\u306f\u3053\u3053\u304b\u3089 FOSOAuthServerBundle \u3067 OAuth \u306b\u3088\u308b\u30c8\u30fc\u30af\u30f3\u8a8d\u8a3c\u3092\u8a66\u3057\u3066\u3044\u304d\u307e\u3059\u3002\u4eca\u56de\u8a66\u3059 Grant Type \u306f Resource Owner Password Credentials \u3068\u3057\u307e\u3059\u3002\n\nSTEP 4.1 \u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u306e\u4f5c\u6210\n\n\u307e\u305a\u3001\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\u3050\u3050\u3063\u3066\u307f\u308b\u3068\u3001FOSOAuthServerBundle \u3067\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u3092\u767a\u884c\u3059\u308b\u306b\u306f\u3044\u304f\u3064\u304b\u307f\u3064\u304b\u308a\u307e\u3057\u305f\u3002\n\nSQL \u3067\u767b\u9332\nWEB \u30d5\u30a9\u30fc\u30e0\u304b\u3089\u767b\u9332\nSymfony Command \u3067\u767b\u9332\n\n\u305b\u3063\u304b\u304f\u306a\u306e\u3067\u3001Symfony Command \u3067\u4f5c\u3063\u3066\u307f\u307e\u3059  \n\u306a\u304a\u3001FOSOAuthServerBundle \u304c Symfony Command \u3092\u7528\u610f\u3057\u3066\u3044\u308b\u308f\u3051\u3067\u306f\u306a\u304f\u3001\u81ea\u524d\u3067\u5b9f\u88c5\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\nsrc/AppBundle/Command/CreateOAuthClientCommand.php\n<?php\n\nnamespace AppBundle\\Command;\n\nuse Symfony\\Bundle\\FrameworkBundle\\Command\\ContainerAwareCommand;\nuse Symfony\\Component\\Console\\Input\\InputArgument;\nuse Symfony\\Component\\Console\\Input\\InputInterface;\nuse Symfony\\Component\\Console\\Output\\OutputInterface;\n\nclass CreateOAuthClientCommand extends ContainerAwareCommand\n{\n    protected function configure()\n    {\n        $this\n            ->setName('app:oauth-client:create')\n            ->setDescription('Create OAuth Client.')\n            ->addArgument('redirectUri', InputArgument::REQUIRED, 'The redirect uri')\n            ->addArgument('grantType',   InputArgument::REQUIRED, 'The grant type')\n            ->setHelp(<<<EOT\nThe <info>app:oauth:create</info> command creates a OAuth Client:\n\n  <info>php app/console app:oauth:create</info>\n\nThis interactive shell will ask you for an client name, a redirect uri and then a grant type.\n\nEOT\n            );\n        ;\n    }\n\n    protected function execute(InputInterface $input, OutputInterface $output)\n    {\n        $redirectUri = $input->getArgument('redirectUri');\n        $grantType   = $input->getArgument('grantType');\n\n        $clientManager = $this->getContainer()->get('fos_oauth_server.client_manager.default');\n        $client = $clientManager->createClient();\n        $client->setRedirectUris([$redirectUri]);\n        $client->setAllowedGrantTypes([$grantType]);\n        $clientManager->updateClient($client);\n\n        $output->writeln(sprintf('Created OAuth Client'));\n\n        return;\n    }\n\n    protected function interact(InputInterface $input, OutputInterface $output)\n    {\n        if (!$input->getArgument('redirectUri')) {\n            $redirectUri = $this->getHelper('dialog')->askAndValidate(\n                $output,\n                'Please choose an Redirect Uri:',\n                function($redirectUri) {\n                    if (empty($redirectUri)) {\n                        throw new \\Exception('Redirect Uri can not be empty');\n                    }\n\n                    return $redirectUri;\n                }\n            );\n            $input->setArgument('redirectUri', $redirectUri);\n        }\n\n        if (!$input->getArgument('grantType')) {\n            $grantType = $this->getHelper('dialog')->askAndValidate(\n                $output,\n                'Please choose a Grant Type:',\n                function($grantType) {\n                    if (empty($grantType)) {\n                        throw new \\Exception('Grant Type can not be empty');\n                    }\n\n                    return $grantType;\n                }\n            );\n            $input->setArgument('grantType', $grantType);\n        }\n    }\n}\n\n\n\u3067\u306f\u3001\u3055\u3063\u305d\u304f\u4f7f\u3063\u3066\u307f\u307e\u3057\u3087\u3046\uff01 Grant Type \u306f Resource Owner Password Credentials \u3092\u5229\u7528\u3059\u308b\u305f\u3081\u306b password \u3068 refresh_token \u3092\u767b\u9332\u3057\u3066\u3044\u307e\u3059\u3002\n$ php app/console app:oauth-client:create\n\nPlease choose an Redirect Uri:http://example.com\nPlease choose a Grant Types (separate multiple grant type with a space):password refresh_token\nCreated OAuth Client\n\nmysql> select * from client;\n+----+----------------------------------------------------+--------------------------------------+----------------------------------------------------+---------------------------+\n| id | random_id                                          | redirect_uris                        | secret                                             | allowed_grant_types       |\n+----+----------------------------------------------------+--------------------------------------+----------------------------------------------------+---------------------------+\n|  1 | 1avth1a6t18kc4coc4o48wkogsww0c0o4oko0oc4wsgc4848c4 | a:1:{i:0;s:18:\"http://example.com\";} | 18u7clil6ww008480ko4occkkw80s4k4w0o0w8wgko44wwgkg0 | a:2:{i:0;s:8:\"password\";i:1;s:13:\"token_refresh\";} |\n+----+----------------------------------------------------+--------------------------------------+----------------------------------------------------+---------------------------+\n1 row in set (0.00 sec)\n\n\u7121\u4e8b\u306b\u767b\u9332\u3067\u304d\u307e\u3057\u305f\u306d \n\nSTEP 4.\uff12 \u30c8\u30fc\u30af\u30f3\u306e\u767a\u884c\n\n\u3067\u306f\u30c8\u30fc\u30af\u30f3\u3092\u767a\u884c\u3057\u3066\u3044\u304d\u307e\u3059\u3002\u524d\u8ff0\u306e\u901a\u308a\u3001FOSOAuthServerBundle \u306e\u30c8\u30fc\u30af\u30f3\u767a\u884c\u306e\u30a8\u30f3\u30c9\u30dd\u30a4\u30f3\u30c8\u306f\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u901a\u308a\u8a2d\u5b9a\u3059\u308b\u3068\u4ee5\u4e0b\u3067\u3059\u3002\n$ php app/console router:debug |grep token\n\nfos_oauth_server_token       GET|POST   ANY      ANY    /oauth/v2/token\n\nResource Owner Password Credentials \u306b\u3088\u308b\u30c8\u30fc\u30af\u30f3\u306e\u767a\u884c\u306b\u306f\u4ee5\u4e0b\u306e\u30c7\u30fc\u30bf\u3092\u9001\u4fe1\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\n\n\n\u540d\u524d\n\u5185\u5bb9\n\n\n\n\ngrant_type\nGrant Type \u3092\u6307\u5b9a\u3057\u307e\u3059\u3002 Resource Owner Password Credentials \u3068\u3059\u308b\u305f\u3081\u306b\u306f password \u3068\u3044\u3046\u6587\u5b57\u5217\u3092\u9001\u308a\u307e\u3059\n\n\nusername\n\u8a8d\u8a3c\u3059\u308b\u30e6\u30fc\u30b6\u30fc\u540d\n\n\npassword\n\u8a8d\u8a3c\u3059\u308b\u30d1\u30b9\u30ef\u30fc\u30c9\n\n\nscope\n\u30b9\u30b3\u30fc\u30d7\u304c\u3042\u308b\u5834\u5408\u306f\u8a2d\u5b9a\u3057\u307e\u3059\uff08\u4efb\u610f\uff09\n\n\n\n\u307e\u305f\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u8a8d\u8a3c\uff08Client Authentication\uff09\u306e\u305f\u3081\u306b\u30af\u30e9\u30a4\u30f3\u30c8\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u304c\u4f55\u3067\u3042\u308b\u304b\u3092\u7279\u5b9a\u3059\u308b\u305f\u3081\u306e\u30c7\u30fc\u30bf\u3092\u9001\u4fe1\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\u3053\u308c\u306f\u5148\u7a0b\u4f5c\u6210\u3057\u305f Client ID, Client Secret \u3092\u5229\u7528\u3057\u307e\u3059\u3002OAuth \u3067\u306f\u3001Authorization \u30d8\u30c3\u30c0\u306b\u767b\u9332\u3059\u308b\u65b9\u6cd5\u3068 client_id, client_secret \u3068\u3044\u3046\u540d\u524d\u3067\u30ea\u30af\u30a8\u30b9\u30c8\u30dc\u30c7\u30a3\u306b\u5165\u308c\u308b\u65b9\u6cd5\u304c\u3042\u308a\u307e\u3059\u3002\u30ea\u30af\u30a8\u30b9\u30c8\u30dc\u30c7\u30a3\u306b\u30c7\u30fc\u30bf\u3092\u8a2d\u5b9a\u3057\u3066\u30c8\u30fc\u30af\u30f3\u3092\u767a\u884c\u3057\u3066\u307f\u307e\u3059\u3002\n$ http POST http://localhost:8000/app_dev.php/oauth/v2/token \\\ngrant_type=password \\\nusername=admin \\\npassword=adminpass \\\nclient_id=1_1avth1a6t18kc4coc4o48wkogsww0c0o4oko0oc4wsgc4848c4 \\\nclient_secret=18u7clil6ww008480ko4occkkw80s4k4w0o0w8wgko44wwgkg0 \n\nHTTP/1.1 200 OK\nCache-Control: no-store, private\nContent-Type: application/json\nPragma: no-cache\n\n{\n    \"access_token\": \"OWRiNWU5OTJlMGIzOGE1OTRiNjQ2MGZkM2EwYTM1YWFjNjdjYzc3NWEwYjMxN2VlOWNjY2E4ZDE0ZDRlOTdjZg\",\n    \"expires_in\": 3600,\n    \"refresh_token\": \"MmMwODYwYjg1Y2VmZGQ4NTExYmQwOTE1NTg4YzhiOTY4N2EzZTcyZmI2MGI1MTVjMjA1NTMxMTE0Zjc0Zjg4MQ\",\n    \"scope\": null,\n    \"token_type\": \"bearer\"\n}\n\nAccessToken, RefeshToken \u304c\u30ec\u30b9\u30dd\u30f3\u30b9\u3068\u3057\u3066\u8fd4\u3063\u3066\u304d\u307e\u3057\u305f\u306d\u3002\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u3082\u78ba\u8a8d\u3057\u3066\u307f\u307e\u3057\u3087\u3046\u3002\nmysql> select * from access_token;\n+----+-----------+---------+----------------------------------------------------------------------------------------+------------+-------+\n| id | client_id | user_id | token                                                                                  | expires_at | scope |\n+----+-----------+---------+----------------------------------------------------------------------------------------+------------+-------+\n|  1 |         1 |       1 | OWRiNWU5OTJlMGIzOGE1OTRiNjQ2MGZkM2EwYTM1YWFjNjdjYzc3NWEwYjMxN2VlOWNjY2E4ZDE0ZDRlOTdjZg | 1481609172 | NULL  |\n+----+-----------+---------+----------------------------------------------------------------------------------------+------------+-------+\n1 row in set (0.00 sec)\n\nmysql> select * from refresh_token;\n+----+-----------+---------+----------------------------------------------------------------------------------------+------------+-------+\n| id | client_id | user_id | token                                                                                  | expires_at | scope |\n+----+-----------+---------+----------------------------------------------------------------------------------------+------------+-------+\n|  1 |         1 |       1 | MmMwODYwYjg1Y2VmZGQ4NTExYmQwOTE1NTg4YzhiOTY4N2EzZTcyZmI2MGI1MTVjMjA1NTMxMTE0Zjc0Zjg4MQ | 1482815172 | NULL  |\n+----+-----------+---------+----------------------------------------------------------------------------------------+------------+-------+\n1 row in set (0.00 sec)\n\n\u30c8\u30fc\u30af\u30f3\u3068\u30ea\u30d5\u30ec\u30c3\u30b7\u30e5\u30c8\u30fc\u30af\u30f3\u304c\u767b\u9332\u3055\u308c\u3066\u3044\u307e\u3059\u306d \n\nSTEP 4.3 \u30c8\u30fc\u30af\u30f3\u8a8d\u8a3c\u3092\u5229\u7528\u3057\u305f API \u3078\u306e\u30a2\u30af\u30bb\u30b9\n\n\u3067\u306f\u3001\u767a\u884c\u3057\u305f\u30c8\u30fc\u30af\u30f3\u3092\u5229\u7528\u3057\u3066 API \u306b\u30a2\u30af\u30bb\u30b9\u3057\u3066\u307f\u307e\u3059\u3002\n$ http GET http://localhost:8000/app_dev.php/api/welcome \\\n\"Authorization:Bearer OWRiNWU5OTJlMGIzOGE1OTRiNjQ2MGZkM2EwYTM1YWFjNjdjYzc3NWEwYjMxN2VlOWNjY2E4ZDE0ZDRlOTdjZg\"\n\nHTTP/1.1 200 OK\nCache-Control: no-cache\nContent-Type: application/json\n\n[\n    \"welcome!\"\n]\n\n\u7121\u4e8b\u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3057\u305f  OAuth 2.0 \u306e\u4ed5\u69d8\u306e\u3056\u3063\u304f\u308a\u628a\u63e1\u3067\u304d\u3066\u3044\u308c\u3070\u7279\u306b\u8ff7\u3046\u3053\u3068\u7121\u304f\u3055\u304f\u3063\u3068\u69cb\u7bc9\u3067\u304d\u307e\u3059\u306d\u3002\n\nSTEP 4.4 \u30c8\u30fc\u30af\u30f3\u306e\u30ea\u30d5\u30ec\u30c3\u30b7\u30e5\n\n\u8a8d\u8a3c\u3067\u5229\u7528\u3059\u308b\u30c8\u30fc\u30af\u30f3\u306e\u6709\u52b9\u671f\u9650\u304c\u5207\u308c\u305f\u5834\u5408\u306f\u30ea\u30d5\u30ec\u30c3\u30b7\u30e5\u3057\u307e\u3057\u3087\u3046\u3002\u6709\u52b9\u671f\u9650\u304c\u5207\u308c\u305f\u5834\u5408\u3001API \u306f\u4ee5\u4e0b\u306e\u30ec\u30b9\u30dd\u30f3\u30b9\u3092\u8fd4\u3057\u307e\u3059\u3002\n$ http GET http://localhost:8000/app_dev.php/api/welcome \\\n\"Authorization:Bearer OWRiNWU5OTJlMGIzOGE1OTRiNjQ2MGZkM2EwYTM1YWFjNjdjYzc3NWEwYjMxN2VlOWNjY2E4ZDE0ZDRlOTdjZg\"\n\nHTTP/1.1 401 Unauthorized\nCache-Control: no-store, private\nContent-Type: application/json\nPragma: no-cache\nWWW-Authenticate: Bearer realm=\"Service\", error=\"invalid_grant\", error_description=\"The access token provided has expired.\"\n\n{\n    \"error\": \"invalid_grant\",\n    \"error_description\": \"The access token provided has expired.\"\n}\n\n\u3067\u306f\u30c8\u30fc\u30af\u30f3\u3092\u30ea\u30d5\u30ec\u30c3\u30b7\u30e5\u3057\u3066\u307f\u307e\u3059\u3002\n$ http POST http://localhost:8000/app_dev.php/oauth/v2/token \\\ngrant_type=refresh_token \\\nrefresh_token=MmMwODYwYjg1Y2VmZGQ4NTExYmQwOTE1NTg4YzhiOTY4N2EzZTcyZmI2MGI1MTVjMjA1NTMxMTE0Zjc0Zjg4MQ \\ client_id=1_1avth1a6t18kc4coc4o48wkogsww0c0o4oko0oc4wsgc4848c4 \\\nclient_secret=18u7clil6ww008480ko4occkkw80s4k4w0o0w8wgko44wwgkg0\n\nHTTP/1.1 200 OK\nCache-Control: no-store, private\nContent-Type: application/json\nPragma: no-cache\n\n{\n    \"access_token\": \"MjhlZWNlMTFmNTA1ZmIwMWJkMzc0NDMyYmZmZWNkZDE1ZWZiNzYwM2I5MWU2MmNlMmY4YzQ1ZWJmZjYzMzQxMw\",\n    \"expires_in\": 3600,\n    \"refresh_token\": \"ZGU0YmQzYzA4MDY2MWI5NTU4YTE3NjU0NmUzN2I3MmM0MzEyZjMyNmMxZjhjOTkwZjY3YjRkNWM2YjE5NTU5Yg\",\n    \"scope\": null,\n    \"token_type\": \"bearer\"\n}\n\n\u7121\u4e8b\u306b\u30ea\u30d5\u30ec\u30c3\u30b7\u30e5\u306b\u6210\u529f\u3057\u305f\u6a21\u69d8\u3067\u3059  \u30ea\u30d5\u30ec\u30c3\u30b7\u30e5\u3067\u304d\u305f\u30a2\u30af\u30bb\u30b9\u30c8\u30fc\u30af\u30f3\u3067 API \u306b\u30a2\u30af\u30bb\u30b9\u3057\u3066\u307f\u307e\u3059\u3002\n$ http GET http://localhost:8000/app_dev.php/api/welcome \\\n\"Authorization:Bearer MjhlZWNlMTFmNTA1ZmIwMWJkMzc0NDMyYmZmZWNkZDE1ZWZiNzYwM2I5MWU2MmNlMmY4YzQ1ZWJmZjYzMzQxMw\"\n\nHTTP/1.1 200 OK\nCache-Control: no-cache\nContent-Type: application/json\n\n[\n    \"welcome!\"\n]\n\n\u30a2\u30af\u30bb\u30b9\u3067\u304d\u307e\u3057\u305f\u306d  \n\nSTEP 4.5 \u6709\u52b9\u671f\u9650\u304c\u5207\u308c\u305f\u30c8\u30fc\u30af\u30f3\u306e\u524a\u9664\n\n\u6700\u5f8c\u306b\u6709\u52b9\u671f\u9650\u304c\u5207\u308c\u305f\u30c8\u30fc\u30af\u30f3\u306e\u524a\u9664\u3092\u884c\u3044\u307e\u3059\u3002\u3053\u308c\u306f FOSOAuthServerBundle \u304c Symfony Command \u3092\u7528\u610f\u3057\u3066\u304f\u308c\u3066\u3044\u307e\u3059\u3002\u65e9\u901f\u3064\u304b\u3063\u3066\u307f\u307e\u3057\u3087\u3046\u3002\u524a\u9664\u3059\u308b\u524d\u306e\u30c7\u30fc\u30bf\u3067\u3059\u3002 id = 1 \u306e\u30ec\u30b3\u30fc\u30c9\u304c\u6709\u52b9\u671f\u9650\u5207\u308c\u306e\u30c8\u30fc\u30af\u30f3\u3067\u3059\u3002\nmysql> select * from access_token;\n+----+-----------+---------+----------------------------------------------------------------------------------------+------------+-------+\n| id | client_id | user_id | token                                                                                  | expires_at | scope |\n+----+-----------+---------+----------------------------------------------------------------------------------------+------------+-------+\n|  1 |         1 |       1 | OWRiNWU5OTJlMGIzOGE1OTRiNjQ2MGZkM2EwYTM1YWFjNjdjYzc3NWEwYjMxN2VlOWNjY2E4ZDE0ZDRlOTdjZg | 1481609172 | NULL  |\n|  2 |         1 |       1 | MjhlZWNlMTFmNTA1ZmIwMWJkMzc0NDMyYmZmZWNkZDE1ZWZiNzYwM2I5MWU2MmNlMmY4YzQ1ZWJmZjYzMzQxMw | 1481613560 | NULL  |\n+----+-----------+---------+----------------------------------------------------------------------------------------+------------+-------+\n2 rows in set (0.00 sec)\n\n\u3067\u306f\u3001Symfony Command \u3092\u5b9f\u884c\u3057\u307e\u3059\u3002\u30b3\u30de\u30f3\u30c9\u540d\u306f fos:oauth-server:clean \u3067\u3059\u3002\n$ php app/console fos:oauth-server:clean\n\nRemoved 1 items from Access token storage.\nRemoved 0 items from Refresh token storage.\nRemoved 0 items from Auth code storage.\n\nmysql> select * from access_token;\n+----+-----------+---------+----------------------------------------------------------------------------------------+------------+-------+\n| id | client_id | user_id | token                                                                                  | expires_at | scope |\n+----+-----------+---------+----------------------------------------------------------------------------------------+------------+-------+\n|  2 |         1 |       1 | MjhlZWNlMTFmNTA1ZmIwMWJkMzc0NDMyYmZmZWNkZDE1ZWZiNzYwM2I5MWU2MmNlMmY4YzQ1ZWJmZjYzMzQxMw | 1481613560 | NULL  |\n+----+-----------+---------+----------------------------------------------------------------------------------------+------------+-------+\n1 row in set (0.00 sec)\n\n\u7121\u4e8b\u306b\u524a\u9664\u3067\u304d\u307e\u3057\u305f \n\n\u307e\u3068\u3081\n\nFOSOAuthServerBundle \u306e\u57fa\u672c\u7684\u306a\u5c0e\u5165\u3068 Resource Owner Password Credentials \u3092\u5229\u7528\u3057\u305f\u8a8d\u8a3c\u306b\u3064\u3044\u3066\u7d39\u4ecb\u3057\u307e\u3057\u305f\u3002\u307e\u305f\u3001\u30c8\u30fc\u30af\u30f3\u306e\u30ea\u30d5\u30ec\u30c3\u30b7\u30e5\u3068\u524a\u9664\u306b\u3064\u3044\u3066\u3082\u89e6\u308c\u307e\u3057\u305f\u3002\u4fbf\u5229\u306a\u30d0\u30f3\u30c9\u30eb\u304c OSS \u3068\u3057\u3066\u305f\u304f\u3055\u3093\u516c\u958b\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u3082 Symfony \u306e\u9b45\u529b\u306e\u3072\u3068\u3064\u3067\u3059\u3088\u306d\u3002\u305c\u3072 FOSOAuthServerBundle \u3082\u4f7f\u3063\u3066\u307f\u3066\u304f\u3060\u3055\u3044\u3002\nSymfony Advent Calendar \u3082\u4eca\u65e5\u3067\u6298\u308a\u8fd4\u3057\u3067\u3059\u306d  \u660e\u65e5\u304b\u3089\u3082\u697d\u3057\u307f\u3067\u3059\u3002\n\n\u53c2\u8003URL\n\u4ee5\u4e0b\u3092\u53c2\u8003\u306b\u3057\u307e\u3057\u305f\u3002\u3042\u308a\u304c\u3068\u3046\u3054\u3056\u3044\u307e\u3059\u3002\n\nhttps://github.com/FriendsOfSymfony/FOSOAuthServerBundle\nhttp://symfony.com/doc/2.8/setup.html\nhttp://symfony.com/doc/current/bundles/FOSRestBundle/index.html\nhttp://symfony.com/doc/current/bundles/FOSUserBundle/index.html\nhttps://github.com/symfony/symfony-installer\nhttps://bitgandtter.wordpress.com/2015/09/10/symfony-a-restful-app-security-fosoauthserverbundle/\nhttp://symfony.com/doc/current/console/input.html\nhttps://bitgandtter.wordpress.com/2015/09/10/symfony-a-restful-app-security-fosoauthserverbundle/\nhttps://www.codevate.com/blog/12-securing-client-side-public-api-access-with-oauth-2-and-symfony\nhttp://stackoverflow.com/questions/21259190/how-to-implement-fosoauthserverbundle-to-secure-a-rest-api\nhttps://gist.github.com/tjamps/11d617a4b318d65ca583\n\n[Symfony Advent Calendar 2016][0] \u306e 13\u65e5\u76ee\u306e\u6295\u7a3f\u3067\u3059\u3002[FOSOAuthServerBundle][1] \u306e\u57fa\u672c\u7684\u306a\u5c0e\u5165\u3068\u5229\u7528\u306b\u3064\u3044\u3066\u65e5\u672c\u8a9e\u3067\u307e\u3068\u307e\u3063\u3066\u3044\u308b\u8a18\u4e8b\u304c\u306a\u304b\u3063\u305f\u306e\u3067\u66f8\u3044\u3066\u307f\u307e\u3057\u305f\u3002WEB API\u3001\u30e6\u30fc\u30b6\u30fc\u30b7\u30b9\u30c6\u30e0\u306e\u4e0b\u5730\u3068\u3057\u3066\u3001FOSRestBundle, FOSUserBunble \u3082\u5229\u7528\u3057\u3066\u3044\u307e\u3059\u3002\n\n\u4eca\u56de\u3001\u5b9f\u88c5\u3057\u305f\u30c7\u30e2\u7528\u306e\u30bd\u30fc\u30b9\u30b3\u30fc\u30c9\u306f\u4ee5\u4e0b\u306b\u7f6e\u3044\u3066\u7f6e\u3044\u3066\u3042\u308a\u307e\u3059 :smile_cat: \n\n- https://github.com/kseta/symfony-oauth-server\n\n**\u6982\u8981**\n===============\n\n- FOSOAuthServerBundle \u3092\u5229\u7528\u3057\u3066\u30c8\u30fc\u30af\u30f3\u8a8d\u8a3c\u304c\u5fc5\u8981\u306a WEB API \u306e\u30c7\u30e2\u3092\u4f5c\u308a\u307e\u3057\u305f\u3002\n- FOSOAuthServerBundle \u306b\u3088\u308b \u30c8\u30fc\u30af\u30f3\u767a\u884c\u3001\u30c8\u30fc\u30af\u30f3\u306e\u30ea\u30d5\u30ec\u30c3\u30b7\u30e5\u3001\u6709\u52b9\u671f\u9650\u304c\u5207\u308c\u305f\u30c8\u30fc\u30af\u30f3\u306e\u524a\u9664 \u306e\u65b9\u6cd5\u306b\u3064\u3044\u3066\u8aac\u660e\u3057\u307e\u3057\u305f\u3002\n\n**1. \u74b0\u5883**\n===============\n\n- Symfony 2.8\n- PHP 7.0.8\n- MySQL\n\n**2. \u30e6\u30fc\u30b6\u30fc\u30b7\u30b9\u30c6\u30e0\u3068\u30c7\u30e2 API \u3092\u4f5c\u6210**\n===============\n\n\u3067\u306f\u3001\u3055\u3063\u305d\u304f\u53d6\u308a\u639b\u304b\u3063\u3066\u3044\u304d\u307e\u3059\u3002\n\n\u307e\u305a\u3001[Symfony Installer][5] \u3067\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u3092\u4f5c\u6210\u3057\u3001FOSRestBundle, FOSUserBundle \u3092\u8ffd\u52a0\u3057\u30e6\u30fc\u30b6\u30fc\u30b7\u30b9\u30c6\u30e0\u3068\u30c7\u30e2 API \u3092\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u3057\u3066\u3044\u304d\u307e\u3059\u3002\u624b\u9806\u306e\u8aac\u660e\u306f\u3001\u516c\u5f0f\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u306b\u8a18\u8f09\u304c\u3042\u308a\u307e\u3059\u306e\u3067\u4eca\u56de\u306f\u7701\u7565\u3057\u307e\u3059\u3002\u4ee5\u4e0b\u306e\u516c\u5f0f\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u3092\u53c2\u8003\u306b\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n- [Installing & Setting up the Symfony Framework][2]\n- [Getting Started With FOSRestBundle][3]\n- [Getting Started With FOSUserBundle][4]\n\n### **STEP 2.1 \u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u306e\u4f5c\u6210**\n\n```bash\n$ symfony new symfony-oauth-sever 2.8\n$ cd symfony-oauth-server\n```\n- \u53c2\u8003: [Installing & Setting up the Symfony Framework][2]\n\n### **STEP 2.2 Bundle \u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb**\n\n```bash\n$ composer require friendsofsymfony/rest-bundle 1.3.*\n$ composer require friendsofsymfony/user-bundle\n$ composer require jms/serializer-bundle\n```\n```php:app/AppKernel.php\n...\n\nclass AppKernel extends Kernel\n{\n    public function registerBundles()\n    {\n        $bundles = array(\n            new Symfony\\Bundle\\FrameworkBundle\\FrameworkBundle(),\n            new Symfony\\Bundle\\SecurityBundle\\SecurityBundle(),\n            new Symfony\\Bundle\\TwigBundle\\TwigBundle(),\n            new Symfony\\Bundle\\MonologBundle\\MonologBundle(),\n            new Symfony\\Bundle\\SwiftmailerBundle\\SwiftmailerBundle(),\n            new Doctrine\\Bundle\\DoctrineBundle\\DoctrineBundle(),\n            new Sensio\\Bundle\\FrameworkExtraBundle\\SensioFrameworkExtraBundle(),\n            new AppBundle\\AppBundle(),\n\n            // \u8ffd\u52a0\n            new FOS\\RestBundle\\FOSRestBundle(),\n            new FOS\\UserBundle\\FOSUserBundle(),\n            new JMS\\SerializerBundle\\JMSSerializerBundle(),\n        );\n\n...\n\n}\n```\n\n### **STEP 2.3 Bundle \u306e\u8a2d\u5b9a**\n\n```yaml:app/config/config.yml\nfos_rest:\n    routing_loader:\n        default_format: json\n        include_format: false\n                             \nfos_user:\n    db_driver: orm\n    firewall_name: api\n    user_class: AppBundle\\Entity\\User\n```\n```yaml:app/config/security.yml\nsecurity:\n    encoders:\n        FOS\\UserBundle\\Model\\UserInterface: bcrypt\n```\n\n### **STEP 2.4 User Entity \u30af\u30e9\u30b9\u306e\u4f5c\u6210**\n\n```php:src/AppBundle/Entity/User.php\n<?php\n// src/AppBundle/Entity/User.php\n\nnamespace AppBundle\\Entity;\n\nuse FOS\\UserBundle\\Model\\User as BaseUser;\nuse Doctrine\\ORM\\Mapping as ORM;\n\n/**\n * @ORM\\Entity\n * @ORM\\Table(name=\"fos_user\")\n */\nclass User extends BaseUser\n{\n    /**\n     * @ORM\\Id\n     * @ORM\\Column(type=\"integer\")\n     * @ORM\\GeneratedValue(strategy=\"AUTO\")\n     */\n    protected $id;\n\n    public function __construct()\n    {\n        parent::__construct();\n        // your own logic\n    }\n}\n```\n\n### **STEP 2.5 \u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306e\u6e96\u5099**\n\n```bash\n$ php app/console doctrine:database:create\n$ php app/console doctrine:schema:update --force\n```\n```\nmysql> use symfony-oauth-server;\nmysql> show tables;\n+--------------------------------+\n| Tables_in_symfony-oauth-server |\n+--------------------------------+\n| fos_user                       |\n+--------------------------------+\n1 rows in set (0.00 sec)\n```\n\n### **STEP 2.6 \u30e6\u30fc\u30b6\u306e\u4f5c\u6210**\n\n```bash\n$ php app/console fos:user:create\n\nPlease choose a username:admin\nPlease choose an email:admin@example.com\nPlease choose a password:adminpass\nCreated user admin\n```\n\n```\nmysql> select * from fos_user;\n+----+----------+--------------------+-------------------+-------------------+---------+---------------------------------+--------------------------------------------------------------+------------+--------+---------+------------+--------------------+-----------------------+--------+---------------------+-----------------------+\n| id | username | username_canonical | email             | email_canonical   | enabled | salt                            | password                                                     | last_login | locked | expired | expires_at | confirmation_token | password_requested_at | roles  | credentials_expired | credentials_expire_at |\n+----+----------+--------------------+-------------------+-------------------+---------+---------------------------------+--------------------------------------------------------------+------------+--------+---------+------------+--------------------+-----------------------+--------+---------------------+-----------------------+\n|  1 | admin    | admin              | admin@example.com | admin@example.com |       1 | kjflxygblxcwccgkg4o4ooggkckgggw | $2y$13$kjflxygblxcwccgkg4o4oe34L7Y6Iorvaz4V5Sr9lg3nbSnHn.b.i | NULL       |      0 |       0 | NULL       | NULL               | NULL                  | a:0:{} |                   0 | NULL                  |\n+----+----------+--------------------+-------------------+-------------------+---------+---------------------------------+--------------------------------------------------------------+------------+--------+---------+------------+--------------------+-----------------------+--------+---------------------+-----------------------+\n1 row in set (0.01 sec)\n```\n\n\n\n### **STEP 2.7 API \u306e\u4f5c\u6210**\n\n```yaml:app/config/routing.yml\napi:\n    resource: \"@AppBundle/Controller/\"\n    prefix:   api\n    type:     rest\n```\n```php:src/AppBundle/Controller/WelcomeController.php\n<?php\n\nnamespace AppBundle\\Controller;\n\nuse FOS\\RestBundle\\Controller\\Annotations\\RouteResource;\nuse FOS\\RestBundle\\Controller\\FOSRestController;\n\n/**\n * @RouteResource(\"welcome\")\n */\nclass WelcomeController extends FOSRestController\n{\n    public function getAction()\n    {\n        return [\"welcome!\"];\n    }\n}\n```\n\n### **STEP 2.8 \u52d5\u4f5c\u78ba\u8a8d**\n\nPHP \u306e build-in server \u3067\u52d5\u4f5c\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n```bash\n$ php app/console server:start\n```\n\nHTTP \u306e\u30ea\u30af\u30a8\u30b9\u30c8\u306b\u306f [HTTPie][7] \u3092\u5229\u7528\u3057\u3066\u3044\u307e\u3059\u3002\u30e6\u30fc\u30b6\u30fc\u30d5\u30ec\u30f3\u30c9\u30ea\u30fc\u306a\u30b7\u30f3\u30bf\u30c3\u30af\u30b9\u3084\u30cf\u30a4\u30e9\u30a4\u30c8\u3092\u63d0\u4f9b\u3057\u3066\u304f\u308c\u3066 JSON \u306b\u3082\u5bfe\u5fdc\u3057\u3066\u3044\u308b\u305f\u3081\u30aa\u30b9\u30b9\u30e1\u3067\u3059\u3002\n\n```\n$ http GET http://localhost:8000/app_dev.php/api/welcome\n```\n```http\nHTTP/1.1 200 OK\nCache-Control: no-cache\nContent-Type: application/json\n\n[\n    \"welcome!\"\n]\n```\n\n\u30fb\u30fb\u30fb\u306f\u3044\u3001\u3055\u304f\u3063\u3068\u3067\u304d\u307e\u3057\u305f\u306d :smile_cat: \u65b0\u3057\u3044\u30d0\u30f3\u30c9\u30eb\u5c0e\u5165\u65b9\u6cd5\u306f\u3001\u591a\u304f\u306e\u30d0\u30f3\u30c9\u30eb\u3067\u540c\u3058\u6d41\u308c\u304c\u591a\u3044\u306e\u3067\u3044\u307e\u3044\u3061\u30d4\u30f3\u3068\u6765\u3066\u306a\u3044\u65b9\u306f\u518d\u5ea6\u304a\u3055\u3089\u3044\u3057\u3066\u304a\u304f\u3053\u3068\u3092\u30aa\u30b9\u30b9\u30e1\u3057\u307e\u3059 :smiley_cat: \n\n**3. FOSOAuthServerBundle \u3092\u5c0e\u5165\u3059\u308b**\n===============\n\n\u3067\u306f\u3001\u3053\u3053\u304b\u3089\u304c\u672c\u7de8\u3067\u3059\u3002FOSOAuthServerBundle \u3092\u4f7f\u3063\u3066\u3044\u304d\u307e\u3059\u3002\n\n\u307e\u305a\u306f\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u304b\u3089\u3002\n\n### **STEP 3.1 \u30a4\u30f3\u30b9\u30c8\u30fc\u30eb**\n\n```bash\n$ composer require friendsofsymfony/oauth-server-bundle\n```\n```php:app/AppKernel.php\n...\n\nclass AppKernel extends Kernel\n{\n    public function registerBundles()\n    {\n        $bundles = array(\n            new Symfony\\Bundle\\FrameworkBundle\\FrameworkBundle(),\n            new Symfony\\Bundle\\SecurityBundle\\SecurityBundle(),\n            new Symfony\\Bundle\\TwigBundle\\TwigBundle(),\n            new Symfony\\Bundle\\MonologBundle\\MonologBundle(),\n            new Symfony\\Bundle\\SwiftmailerBundle\\SwiftmailerBundle(),\n            new Doctrine\\Bundle\\DoctrineBundle\\DoctrineBundle(),\n            new Sensio\\Bundle\\FrameworkExtraBundle\\SensioFrameworkExtraBundle(),\n            new AppBundle\\AppBundle(),\n\n            // \u8ffd\u52a0\n            new FOS\\OAuthServerBundle\\FOSOAuthServerBundle(),\n            new FOS\\RestBundle\\FOSRestBundle(),\n            new FOS\\UserBundle\\FOSUserBundle(),\n            new JMS\\SerializerBundle\\JMSSerializerBundle(),\n        );\n\n...\n\n}\n```\n\n### **STEP 3.2 Entity \u306e\u8ffd\u52a0**\n\n\u6b21\u306b\u5229\u7528\u3059\u308b Entity \u3092\u8ffd\u52a0\u3057\u3066\u3044\u304d\u307e\u3059\u3002\u8ffd\u52a0\u3059\u308b Entity \u306f\u4ee5\u4e0b\u306e\uff14\u3064\u3067\u3059\u3002\n\n- **1) AccessToken.php**\n\n    ```php:src/AppBundle/Entity/AccessToken.php\n    <?php\n\n    namespace AppBundle\\Entity;\n\n    use FOS\\OAuthServerBundle\\Entity\\AccessToken as BaseAccessToken;\n    use Doctrine\\ORM\\Mapping as ORM;\n\n\n    /**\n     * @ORM\\Entity\n     */\n    class AccessToken extends BaseAccessToken\n    {\n        /**\n         * @ORM\\Id\n         * @ORM\\Column(type=\"integer\")\n         * @ORM\\GeneratedValue(strategy=\"AUTO\")\n         */\n        protected $id;\n\n        /**\n         * @ORM\\ManyToOne(targetEntity=\"Client\")\n         * @ORM\\JoinColumn(nullable=false)\n         */\n        protected $client;\n\n        /**\n         * @ORM\\ManyToOne(targetEntity=\"AppBundle\\Entity\\User\")\n         */\n        protected $user;\n    }\n    ```\n\n- **2) AuthCode.php**\n\n    ```php:src/AppBundle/Entity/AuthCode.php\n    <?php\n\n    namespace AppBundle\\Entity;\n\n    use FOS\\OAuthServerBundle\\Entity\\AuthCode as BaseAuthCode;\n    use Doctrine\\ORM\\Mapping as ORM;\n\n    /**\n     * @ORM\\Entity\n     */\n    class AuthCode extends BaseAuthCode\n    {\n        /**\n         * @ORM\\Id\n         * @ORM\\Column(type=\"integer\")\n         * @ORM\\GeneratedValue(strategy=\"AUTO\")\n         */\n        protected $id;\n\n        /**\n         * @ORM\\ManyToOne(targetEntity=\"Client\")\n         * @ORM\\JoinColumn(nullable=false)\n         */\n        protected $client;\n\n        /**\n         * @ORM\\ManyToOne(targetEntity=\"AppBundle\\Entity\\User\")\n         */\n        protected $user;\n    }\n    ```\n\n- **3) Client.php**\n\n    ```php:src/AppBundle/Entity/Client.php\n    <?php\n\n    namespace AppBundle\\Entity;\n\n    use FOS\\OAuthServerBundle\\Entity\\Client as BaseClient;\n    use Doctrine\\ORM\\Mapping as ORM;\n\n    /**\n     * @ORM\\Entity\n     */\n    class Client extends BaseClient\n    {\n        /**\n         * @ORM\\Id\n         * @ORM\\Column(type=\"integer\")\n         * @ORM\\GeneratedValue(strategy=\"AUTO\")\n         */\n        protected $id;\n    }\n    ```\n\n- **4) RefreshToken.php**\n\n    ```php:src/AppBundle/Entity/RefreshToken.php\n    <?php\n\n    namespace AppBundle\\Entity;\n\n    use FOS\\OAuthServerBundle\\Entity\\RefreshToken as BaseRefreshToken;\n    use Doctrine\\ORM\\Mapping as ORM;\n\n    /**\n     * @ORM\\Entity\n     */\n    class RefreshToken extends BaseRefreshToken\n    {\n        /**\n         * @ORM\\Id\n         * @ORM\\Column(type=\"integer\")\n         * @ORM\\GeneratedValue(strategy=\"AUTO\")\n         */\n        protected $id;\n\n        /**\n         * @ORM\\ManyToOne(targetEntity=\"Client\")\n         * @ORM\\JoinColumn(nullable=false)\n         */\n        protected $client;\n\n        /**\n         * @ORM\\ManyToOne(targetEntity=\"AppBundle\\Entity\\User\")\n         */\n        protected $user;\n    }\n    ```\n\n### **STEP 3.3 \u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306e\u6e96\u5099**\n\n```\n$ php app/console doctrine:schema:update --force\n```\n```\n+--------------------------------+\n| Tables_in_symfony-oauth-server |\n+--------------------------------+\n| access_token                   |\n| auth_code                      |\n| client                         |\n| fos_user                       |\n| refresh_token                  |\n+--------------------------------+\n5 rows in set (0.00 sec)\n```\n\n### **STEP 3.4 \u8a2d\u5b9a\u306e\u8ffd\u52a0**\n\nconfig.yml \u306b\u8a2d\u5b9a\u3092\u8ffd\u52a0\u3057\u3066\u3044\u304d\u307e\u3059\u3002\n\n```yaml:app/config/config.yml\nfos_oauth_server:\n    db_driver: orm       # Drivers available: orm, mongodb, or propel\n    client_class:        AppBundle\\Entity\\Client\n    access_token_class:  AppBundle\\Entity\\AccessToken\n    refresh_token_class: AppBundle\\Entity\\RefreshToken\n    auth_code_class:     AppBundle\\Entity\\AuthCode\n    service:\n        user_provider: fos_user.user_provider.username\n```\n\n\u30eb\u30fc\u30c6\u30a3\u30f3\u30b0\u3082\u8ffd\u52a0\u3057\u307e\u3059\u3002\n\n```yaml:app/config/routing.yml\nfos_oauth_server_token:\n    resource: \"@FOSOAuthServerBundle/Resources/config/routing/token.xml\"\n\nfos_oauth_server_authorize:\n    resource: \"@FOSOAuthServerBundle/Resources/config/routing/authorize.xml\"\n```\n\nserurity.yml \u306b\u8a8d\u8a3c\u306e\u8a2d\u5b9a\u3092\u8ffd\u52a0\u3057\u307e\u3057\u3087\u3046\u3002\n\n```yaml:app/config/security.yml\n# To get started with security, check out the documentation:\n# http://symfony.com/doc/current/security.html\nsecurity:\n    encoders:\n        FOS\\UserBundle\\Model\\UserInterface: bcrypt\n\n    # http://symfony.com/doc/current/security.html#b-configuring-how-users-are-loaded\n    providers:\n        in_memory:\n            memory: ~\n\n    firewalls:\n        oauth_token:\n            pattern:    ^/oauth/v2/token\n            security:   false\n\n        api:\n            pattern:    ^/api\n            fos_oauth:  true\n            stateless:  true\n            anonymous:  false # can be omitted as its default value\n\n    access_control:\n        - { path: ^/api, roles: [ IS_AUTHENTICATED_FULLY ] }\n```\n\n\u3053\u306e\u8a2d\u5b9a\u3067\u3001\u5168\u3066\u306e API \u306f\u30c8\u30fc\u30af\u30f3\u8a8d\u8a3c\u306a\u3057\u306b\u306f\u30a2\u30af\u30bb\u30b9\u3067\u304d\u306a\u308a\u307e\u3059\u3002\u3053\u3053\u307e\u3067\u9032\u3093\u3060\u3068\u3053\u308d\u3067\u3001\u5148\u7a0b\u4f5c\u6210\u3057\u305f Welcom API \u3092\u53e9\u3044\u3066\u30a2\u30af\u30bb\u30b9\u304c\u62d2\u5426\u3055\u308c\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3057\u3066\u307f\u307e\u3057\u3087\u3046\u3002\n\n```bash\n$ http GET http://localhost:8000/app_dev.php/api/welcome\n```\n```http\nHTTP/1.1 401 Unauthorized\nCache-Control: no-store, private\nContent-Type: application/json\nHost: localhost:8000\nPragma: no-cache\nWWW-Authenticate: Bearer realm=\"Service\", error=\"access_denied\", error_description=\"OAuth2 authentication required\"\n\n{\n    \"error\": \"access_denied\",\n    \"error_description\": \"OAuth2 authentication required\"\n}\n```\n\n\u7121\u4e8b\u306b\u30a2\u30af\u30bb\u30b9\u304c\u62d2\u5426\u3055\u308c\u3066\u3044\u307e\u3059 :smile_cat: \u3053\u3053\u304b\u3089\u306f\u3001\u3053\u306e API \u306b\u30c8\u30fc\u30af\u30f3\u8a8d\u8a3c\u3067\u30a2\u30af\u30bb\u30b9\u3067\u304d\u308b\u3088\u3046\u306b\u3057\u3066\u3044\u304d\u307e\u3059\u3002\n\n**4. OAuth \u306b\u3088\u308b\u30c8\u30fc\u30af\u30f3\u8a8d\u8a3c**\n===============\n\n\u306f\u3044\u3002\u3067\u306f\u3053\u3053\u304b\u3089 FOSOAuthServerBundle \u3067 OAuth \u306b\u3088\u308b\u30c8\u30fc\u30af\u30f3\u8a8d\u8a3c\u3092\u8a66\u3057\u3066\u3044\u304d\u307e\u3059\u3002\u4eca\u56de\u8a66\u3059 Grant Type \u306f Resource Owner Password Credentials \u3068\u3057\u307e\u3059\u3002\n\n### **STEP 4.1 \u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u306e\u4f5c\u6210**\n\n\u307e\u305a\u3001\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\u3050\u3050\u3063\u3066\u307f\u308b\u3068\u3001FOSOAuthServerBundle \u3067\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u3092\u767a\u884c\u3059\u308b\u306b\u306f\u3044\u304f\u3064\u304b\u307f\u3064\u304b\u308a\u307e\u3057\u305f\u3002\n\n- SQL \u3067\u767b\u9332\n- WEB \u30d5\u30a9\u30fc\u30e0\u304b\u3089\u767b\u9332\n- Symfony Command \u3067\u767b\u9332\n\n\u305b\u3063\u304b\u304f\u306a\u306e\u3067\u3001Symfony Command \u3067\u4f5c\u3063\u3066\u307f\u307e\u3059 :smiley: \n\u306a\u304a\u3001FOSOAuthServerBundle \u304c Symfony Command \u3092\u7528\u610f\u3057\u3066\u3044\u308b\u308f\u3051\u3067\u306f\u306a\u304f\u3001\u81ea\u524d\u3067\u5b9f\u88c5\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\n```php:src/AppBundle/Command/CreateOAuthClientCommand.php\n<?php\n\nnamespace AppBundle\\Command;\n\nuse Symfony\\Bundle\\FrameworkBundle\\Command\\ContainerAwareCommand;\nuse Symfony\\Component\\Console\\Input\\InputArgument;\nuse Symfony\\Component\\Console\\Input\\InputInterface;\nuse Symfony\\Component\\Console\\Output\\OutputInterface;\n\nclass CreateOAuthClientCommand extends ContainerAwareCommand\n{\n    protected function configure()\n    {\n        $this\n            ->setName('app:oauth-client:create')\n            ->setDescription('Create OAuth Client.')\n            ->addArgument('redirectUri', InputArgument::REQUIRED, 'The redirect uri')\n            ->addArgument('grantType',   InputArgument::REQUIRED, 'The grant type')\n            ->setHelp(<<<EOT\nThe <info>app:oauth:create</info> command creates a OAuth Client:\n\n  <info>php app/console app:oauth:create</info>\n\nThis interactive shell will ask you for an client name, a redirect uri and then a grant type.\n\nEOT\n            );\n        ;\n    }\n\n    protected function execute(InputInterface $input, OutputInterface $output)\n    {\n        $redirectUri = $input->getArgument('redirectUri');\n        $grantType   = $input->getArgument('grantType');\n\n        $clientManager = $this->getContainer()->get('fos_oauth_server.client_manager.default');\n        $client = $clientManager->createClient();\n        $client->setRedirectUris([$redirectUri]);\n        $client->setAllowedGrantTypes([$grantType]);\n        $clientManager->updateClient($client);\n\n        $output->writeln(sprintf('Created OAuth Client'));\n\n        return;\n    }\n\n    protected function interact(InputInterface $input, OutputInterface $output)\n    {\n        if (!$input->getArgument('redirectUri')) {\n            $redirectUri = $this->getHelper('dialog')->askAndValidate(\n                $output,\n                'Please choose an Redirect Uri:',\n                function($redirectUri) {\n                    if (empty($redirectUri)) {\n                        throw new \\Exception('Redirect Uri can not be empty');\n                    }\n\n                    return $redirectUri;\n                }\n            );\n            $input->setArgument('redirectUri', $redirectUri);\n        }\n\n        if (!$input->getArgument('grantType')) {\n            $grantType = $this->getHelper('dialog')->askAndValidate(\n                $output,\n                'Please choose a Grant Type:',\n                function($grantType) {\n                    if (empty($grantType)) {\n                        throw new \\Exception('Grant Type can not be empty');\n                    }\n\n                    return $grantType;\n                }\n            );\n            $input->setArgument('grantType', $grantType);\n        }\n    }\n}\n```\n\n\u3067\u306f\u3001\u3055\u3063\u305d\u304f\u4f7f\u3063\u3066\u307f\u307e\u3057\u3087\u3046\uff01 Grant Type \u306f Resource Owner Password Credentials \u3092\u5229\u7528\u3059\u308b\u305f\u3081\u306b `password` \u3068 `refresh_token` \u3092\u767b\u9332\u3057\u3066\u3044\u307e\u3059\u3002\n\n```bash\n$ php app/console app:oauth-client:create\n\nPlease choose an Redirect Uri:http://example.com\nPlease choose a Grant Types (separate multiple grant type with a space):password refresh_token\nCreated OAuth Client\n```\n```\nmysql> select * from client;\n+----+----------------------------------------------------+--------------------------------------+----------------------------------------------------+---------------------------+\n| id | random_id                                          | redirect_uris                        | secret                                             | allowed_grant_types       |\n+----+----------------------------------------------------+--------------------------------------+----------------------------------------------------+---------------------------+\n|  1 | 1avth1a6t18kc4coc4o48wkogsww0c0o4oko0oc4wsgc4848c4 | a:1:{i:0;s:18:\"http://example.com\";} | 18u7clil6ww008480ko4occkkw80s4k4w0o0w8wgko44wwgkg0 | a:2:{i:0;s:8:\"password\";i:1;s:13:\"token_refresh\";} |\n+----+----------------------------------------------------+--------------------------------------+----------------------------------------------------+---------------------------+\n1 row in set (0.00 sec)\n```\n\n\u7121\u4e8b\u306b\u767b\u9332\u3067\u304d\u307e\u3057\u305f\u306d :smile_cat:\n\n### **STEP 4.\uff12 \u30c8\u30fc\u30af\u30f3\u306e\u767a\u884c**\n\n\u3067\u306f\u30c8\u30fc\u30af\u30f3\u3092\u767a\u884c\u3057\u3066\u3044\u304d\u307e\u3059\u3002\u524d\u8ff0\u306e\u901a\u308a\u3001FOSOAuthServerBundle \u306e\u30c8\u30fc\u30af\u30f3\u767a\u884c\u306e\u30a8\u30f3\u30c9\u30dd\u30a4\u30f3\u30c8\u306f\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u901a\u308a\u8a2d\u5b9a\u3059\u308b\u3068\u4ee5\u4e0b\u3067\u3059\u3002\n\n```\n$ php app/console router:debug |grep token\n\nfos_oauth_server_token       GET|POST   ANY      ANY    /oauth/v2/token\n```\n\nResource Owner Password Credentials \u306b\u3088\u308b\u30c8\u30fc\u30af\u30f3\u306e\u767a\u884c\u306b\u306f\u4ee5\u4e0b\u306e\u30c7\u30fc\u30bf\u3092\u9001\u4fe1\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\n| \u540d\u524d | \u5185\u5bb9 |\n| :--- | :--- |\n| grant_type | Grant Type \u3092\u6307\u5b9a\u3057\u307e\u3059\u3002 Resource Owner Password Credentials \u3068\u3059\u308b\u305f\u3081\u306b\u306f password \u3068\u3044\u3046\u6587\u5b57\u5217\u3092\u9001\u308a\u307e\u3059 |\n| username | \u8a8d\u8a3c\u3059\u308b\u30e6\u30fc\u30b6\u30fc\u540d |\n| password | \u8a8d\u8a3c\u3059\u308b\u30d1\u30b9\u30ef\u30fc\u30c9 |\n| scope | \u30b9\u30b3\u30fc\u30d7\u304c\u3042\u308b\u5834\u5408\u306f\u8a2d\u5b9a\u3057\u307e\u3059\uff08\u4efb\u610f\uff09 |\n\n\u307e\u305f\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u8a8d\u8a3c\uff08Client Authentication\uff09\u306e\u305f\u3081\u306b\u30af\u30e9\u30a4\u30f3\u30c8\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u304c\u4f55\u3067\u3042\u308b\u304b\u3092\u7279\u5b9a\u3059\u308b\u305f\u3081\u306e\u30c7\u30fc\u30bf\u3092\u9001\u4fe1\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\u3053\u308c\u306f\u5148\u7a0b\u4f5c\u6210\u3057\u305f Client ID, Client Secret \u3092\u5229\u7528\u3057\u307e\u3059\u3002OAuth \u3067\u306f\u3001Authorization \u30d8\u30c3\u30c0\u306b\u767b\u9332\u3059\u308b\u65b9\u6cd5\u3068 `client_id`, `client_secret` \u3068\u3044\u3046\u540d\u524d\u3067\u30ea\u30af\u30a8\u30b9\u30c8\u30dc\u30c7\u30a3\u306b\u5165\u308c\u308b\u65b9\u6cd5\u304c\u3042\u308a\u307e\u3059\u3002\u30ea\u30af\u30a8\u30b9\u30c8\u30dc\u30c7\u30a3\u306b\u30c7\u30fc\u30bf\u3092\u8a2d\u5b9a\u3057\u3066\u30c8\u30fc\u30af\u30f3\u3092\u767a\u884c\u3057\u3066\u307f\u307e\u3059\u3002\n\n```bash\n$ http POST http://localhost:8000/app_dev.php/oauth/v2/token \\\ngrant_type=password \\\nusername=admin \\\npassword=adminpass \\\nclient_id=1_1avth1a6t18kc4coc4o48wkogsww0c0o4oko0oc4wsgc4848c4 \\\nclient_secret=18u7clil6ww008480ko4occkkw80s4k4w0o0w8wgko44wwgkg0 \n```\n```http\nHTTP/1.1 200 OK\nCache-Control: no-store, private\nContent-Type: application/json\nPragma: no-cache\n\n{\n    \"access_token\": \"OWRiNWU5OTJlMGIzOGE1OTRiNjQ2MGZkM2EwYTM1YWFjNjdjYzc3NWEwYjMxN2VlOWNjY2E4ZDE0ZDRlOTdjZg\",\n    \"expires_in\": 3600,\n    \"refresh_token\": \"MmMwODYwYjg1Y2VmZGQ4NTExYmQwOTE1NTg4YzhiOTY4N2EzZTcyZmI2MGI1MTVjMjA1NTMxMTE0Zjc0Zjg4MQ\",\n    \"scope\": null,\n    \"token_type\": \"bearer\"\n}\n```\n\nAccessToken, RefeshToken \u304c\u30ec\u30b9\u30dd\u30f3\u30b9\u3068\u3057\u3066\u8fd4\u3063\u3066\u304d\u307e\u3057\u305f\u306d\u3002\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u3082\u78ba\u8a8d\u3057\u3066\u307f\u307e\u3057\u3087\u3046\u3002\n\n```\nmysql> select * from access_token;\n+----+-----------+---------+----------------------------------------------------------------------------------------+------------+-------+\n| id | client_id | user_id | token                                                                                  | expires_at | scope |\n+----+-----------+---------+----------------------------------------------------------------------------------------+------------+-------+\n|  1 |         1 |       1 | OWRiNWU5OTJlMGIzOGE1OTRiNjQ2MGZkM2EwYTM1YWFjNjdjYzc3NWEwYjMxN2VlOWNjY2E4ZDE0ZDRlOTdjZg | 1481609172 | NULL  |\n+----+-----------+---------+----------------------------------------------------------------------------------------+------------+-------+\n1 row in set (0.00 sec)\n```\n```\nmysql> select * from refresh_token;\n+----+-----------+---------+----------------------------------------------------------------------------------------+------------+-------+\n| id | client_id | user_id | token                                                                                  | expires_at | scope |\n+----+-----------+---------+----------------------------------------------------------------------------------------+------------+-------+\n|  1 |         1 |       1 | MmMwODYwYjg1Y2VmZGQ4NTExYmQwOTE1NTg4YzhiOTY4N2EzZTcyZmI2MGI1MTVjMjA1NTMxMTE0Zjc0Zjg4MQ | 1482815172 | NULL  |\n+----+-----------+---------+----------------------------------------------------------------------------------------+------------+-------+\n1 row in set (0.00 sec)\n```\n\n\u30c8\u30fc\u30af\u30f3\u3068\u30ea\u30d5\u30ec\u30c3\u30b7\u30e5\u30c8\u30fc\u30af\u30f3\u304c\u767b\u9332\u3055\u308c\u3066\u3044\u307e\u3059\u306d :smile_cat:\n\n### **STEP 4.3 \u30c8\u30fc\u30af\u30f3\u8a8d\u8a3c\u3092\u5229\u7528\u3057\u305f API \u3078\u306e\u30a2\u30af\u30bb\u30b9**\n\n\u3067\u306f\u3001\u767a\u884c\u3057\u305f\u30c8\u30fc\u30af\u30f3\u3092\u5229\u7528\u3057\u3066 API \u306b\u30a2\u30af\u30bb\u30b9\u3057\u3066\u307f\u307e\u3059\u3002\n\n```\n$ http GET http://localhost:8000/app_dev.php/api/welcome \\\n\"Authorization:Bearer OWRiNWU5OTJlMGIzOGE1OTRiNjQ2MGZkM2EwYTM1YWFjNjdjYzc3NWEwYjMxN2VlOWNjY2E4ZDE0ZDRlOTdjZg\"\n```\n```http\nHTTP/1.1 200 OK\nCache-Control: no-cache\nContent-Type: application/json\n\n[\n    \"welcome!\"\n]\n```\n\n\u7121\u4e8b\u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3057\u305f :smile_cat: OAuth 2.0 \u306e\u4ed5\u69d8\u306e\u3056\u3063\u304f\u308a\u628a\u63e1\u3067\u304d\u3066\u3044\u308c\u3070\u7279\u306b\u8ff7\u3046\u3053\u3068\u7121\u304f\u3055\u304f\u3063\u3068\u69cb\u7bc9\u3067\u304d\u307e\u3059\u306d\u3002\n\n### **STEP 4.4 \u30c8\u30fc\u30af\u30f3\u306e\u30ea\u30d5\u30ec\u30c3\u30b7\u30e5**\n\n\u8a8d\u8a3c\u3067\u5229\u7528\u3059\u308b\u30c8\u30fc\u30af\u30f3\u306e\u6709\u52b9\u671f\u9650\u304c\u5207\u308c\u305f\u5834\u5408\u306f\u30ea\u30d5\u30ec\u30c3\u30b7\u30e5\u3057\u307e\u3057\u3087\u3046\u3002\u6709\u52b9\u671f\u9650\u304c\u5207\u308c\u305f\u5834\u5408\u3001API \u306f\u4ee5\u4e0b\u306e\u30ec\u30b9\u30dd\u30f3\u30b9\u3092\u8fd4\u3057\u307e\u3059\u3002\n\n```bash\n$ http GET http://localhost:8000/app_dev.php/api/welcome \\\n\"Authorization:Bearer OWRiNWU5OTJlMGIzOGE1OTRiNjQ2MGZkM2EwYTM1YWFjNjdjYzc3NWEwYjMxN2VlOWNjY2E4ZDE0ZDRlOTdjZg\"\n```\n```http\nHTTP/1.1 401 Unauthorized\nCache-Control: no-store, private\nContent-Type: application/json\nPragma: no-cache\nWWW-Authenticate: Bearer realm=\"Service\", error=\"invalid_grant\", error_description=\"The access token provided has expired.\"\n\n{\n    \"error\": \"invalid_grant\",\n    \"error_description\": \"The access token provided has expired.\"\n}\n```\n\n\u3067\u306f\u30c8\u30fc\u30af\u30f3\u3092\u30ea\u30d5\u30ec\u30c3\u30b7\u30e5\u3057\u3066\u307f\u307e\u3059\u3002\n\n```bash\n$ http POST http://localhost:8000/app_dev.php/oauth/v2/token \\\ngrant_type=refresh_token \\\nrefresh_token=MmMwODYwYjg1Y2VmZGQ4NTExYmQwOTE1NTg4YzhiOTY4N2EzZTcyZmI2MGI1MTVjMjA1NTMxMTE0Zjc0Zjg4MQ \\ client_id=1_1avth1a6t18kc4coc4o48wkogsww0c0o4oko0oc4wsgc4848c4 \\\nclient_secret=18u7clil6ww008480ko4occkkw80s4k4w0o0w8wgko44wwgkg0\n```\n```http\nHTTP/1.1 200 OK\nCache-Control: no-store, private\nContent-Type: application/json\nPragma: no-cache\n\n{\n    \"access_token\": \"MjhlZWNlMTFmNTA1ZmIwMWJkMzc0NDMyYmZmZWNkZDE1ZWZiNzYwM2I5MWU2MmNlMmY4YzQ1ZWJmZjYzMzQxMw\",\n    \"expires_in\": 3600,\n    \"refresh_token\": \"ZGU0YmQzYzA4MDY2MWI5NTU4YTE3NjU0NmUzN2I3MmM0MzEyZjMyNmMxZjhjOTkwZjY3YjRkNWM2YjE5NTU5Yg\",\n    \"scope\": null,\n    \"token_type\": \"bearer\"\n}\n```\n\n\u7121\u4e8b\u306b\u30ea\u30d5\u30ec\u30c3\u30b7\u30e5\u306b\u6210\u529f\u3057\u305f\u6a21\u69d8\u3067\u3059 :smiley_cat: \u30ea\u30d5\u30ec\u30c3\u30b7\u30e5\u3067\u304d\u305f\u30a2\u30af\u30bb\u30b9\u30c8\u30fc\u30af\u30f3\u3067 API \u306b\u30a2\u30af\u30bb\u30b9\u3057\u3066\u307f\u307e\u3059\u3002\n\n```bash\n$ http GET http://localhost:8000/app_dev.php/api/welcome \\\n\"Authorization:Bearer MjhlZWNlMTFmNTA1ZmIwMWJkMzc0NDMyYmZmZWNkZDE1ZWZiNzYwM2I5MWU2MmNlMmY4YzQ1ZWJmZjYzMzQxMw\"\n```\n```http\nHTTP/1.1 200 OK\nCache-Control: no-cache\nContent-Type: application/json\n\n[\n    \"welcome!\"\n]\n``` \n\n\u30a2\u30af\u30bb\u30b9\u3067\u304d\u307e\u3057\u305f\u306d :smile_cat: \n\n### **STEP 4.5 \u6709\u52b9\u671f\u9650\u304c\u5207\u308c\u305f\u30c8\u30fc\u30af\u30f3\u306e\u524a\u9664**\n\n\u6700\u5f8c\u306b\u6709\u52b9\u671f\u9650\u304c\u5207\u308c\u305f\u30c8\u30fc\u30af\u30f3\u306e\u524a\u9664\u3092\u884c\u3044\u307e\u3059\u3002\u3053\u308c\u306f FOSOAuthServerBundle \u304c Symfony Command \u3092\u7528\u610f\u3057\u3066\u304f\u308c\u3066\u3044\u307e\u3059\u3002\u65e9\u901f\u3064\u304b\u3063\u3066\u307f\u307e\u3057\u3087\u3046\u3002\u524a\u9664\u3059\u308b\u524d\u306e\u30c7\u30fc\u30bf\u3067\u3059\u3002 id = 1 \u306e\u30ec\u30b3\u30fc\u30c9\u304c\u6709\u52b9\u671f\u9650\u5207\u308c\u306e\u30c8\u30fc\u30af\u30f3\u3067\u3059\u3002\n\n```\nmysql> select * from access_token;\n+----+-----------+---------+----------------------------------------------------------------------------------------+------------+-------+\n| id | client_id | user_id | token                                                                                  | expires_at | scope |\n+----+-----------+---------+----------------------------------------------------------------------------------------+------------+-------+\n|  1 |         1 |       1 | OWRiNWU5OTJlMGIzOGE1OTRiNjQ2MGZkM2EwYTM1YWFjNjdjYzc3NWEwYjMxN2VlOWNjY2E4ZDE0ZDRlOTdjZg | 1481609172 | NULL  |\n|  2 |         1 |       1 | MjhlZWNlMTFmNTA1ZmIwMWJkMzc0NDMyYmZmZWNkZDE1ZWZiNzYwM2I5MWU2MmNlMmY4YzQ1ZWJmZjYzMzQxMw | 1481613560 | NULL  |\n+----+-----------+---------+----------------------------------------------------------------------------------------+------------+-------+\n2 rows in set (0.00 sec)\n```\n\n\u3067\u306f\u3001Symfony Command \u3092\u5b9f\u884c\u3057\u307e\u3059\u3002\u30b3\u30de\u30f3\u30c9\u540d\u306f `fos:oauth-server:clean` \u3067\u3059\u3002\n\n```\n$ php app/console fos:oauth-server:clean\n\nRemoved 1 items from Access token storage.\nRemoved 0 items from Refresh token storage.\nRemoved 0 items from Auth code storage.\n```\n\n```\nmysql> select * from access_token;\n+----+-----------+---------+----------------------------------------------------------------------------------------+------------+-------+\n| id | client_id | user_id | token                                                                                  | expires_at | scope |\n+----+-----------+---------+----------------------------------------------------------------------------------------+------------+-------+\n|  2 |         1 |       1 | MjhlZWNlMTFmNTA1ZmIwMWJkMzc0NDMyYmZmZWNkZDE1ZWZiNzYwM2I5MWU2MmNlMmY4YzQ1ZWJmZjYzMzQxMw | 1481613560 | NULL  |\n+----+-----------+---------+----------------------------------------------------------------------------------------+------------+-------+\n1 row in set (0.00 sec)\n```\n\n\u7121\u4e8b\u306b\u524a\u9664\u3067\u304d\u307e\u3057\u305f :smile_cat:\n\n**\u307e\u3068\u3081**\n===============\n\n[FOSOAuthServerBundle][1] \u306e\u57fa\u672c\u7684\u306a\u5c0e\u5165\u3068 Resource Owner Password Credentials \u3092\u5229\u7528\u3057\u305f\u8a8d\u8a3c\u306b\u3064\u3044\u3066\u7d39\u4ecb\u3057\u307e\u3057\u305f\u3002\u307e\u305f\u3001\u30c8\u30fc\u30af\u30f3\u306e\u30ea\u30d5\u30ec\u30c3\u30b7\u30e5\u3068\u524a\u9664\u306b\u3064\u3044\u3066\u3082\u89e6\u308c\u307e\u3057\u305f\u3002\u4fbf\u5229\u306a\u30d0\u30f3\u30c9\u30eb\u304c OSS \u3068\u3057\u3066\u305f\u304f\u3055\u3093\u516c\u958b\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u3082 Symfony \u306e\u9b45\u529b\u306e\u3072\u3068\u3064\u3067\u3059\u3088\u306d\u3002\u305c\u3072 FOSOAuthServerBundle \u3082\u4f7f\u3063\u3066\u307f\u3066\u304f\u3060\u3055\u3044\u3002\n\nSymfony Advent Calendar \u3082\u4eca\u65e5\u3067\u6298\u308a\u8fd4\u3057\u3067\u3059\u306d :smile_cat: \u660e\u65e5\u304b\u3089\u3082\u697d\u3057\u307f\u3067\u3059\u3002\n\n\u53c2\u8003URL\n===============\n\n\u4ee5\u4e0b\u3092\u53c2\u8003\u306b\u3057\u307e\u3057\u305f\u3002\u3042\u308a\u304c\u3068\u3046\u3054\u3056\u3044\u307e\u3059\u3002\n\n- https://github.com/FriendsOfSymfony/FOSOAuthServerBundle\n- http://symfony.com/doc/2.8/setup.html\n- http://symfony.com/doc/current/bundles/FOSRestBundle/index.html\n- http://symfony.com/doc/current/bundles/FOSUserBundle/index.html\n- https://github.com/symfony/symfony-installer\n- https://bitgandtter.wordpress.com/2015/09/10/symfony-a-restful-app-security-fosoauthserverbundle/\n- http://symfony.com/doc/current/console/input.html\n- https://bitgandtter.wordpress.com/2015/09/10/symfony-a-restful-app-security-fosoauthserverbundle/\n- https://www.codevate.com/blog/12-securing-client-side-public-api-access-with-oauth-2-and-symfony\n- http://stackoverflow.com/questions/21259190/how-to-implement-fosoauthserverbundle-to-secure-a-rest-api\n- https://gist.github.com/tjamps/11d617a4b318d65ca583\n\n[0]: http://qiita.com/advent-calendar/2016/symfony\n[1]: https://github.com/FriendsOfSymfony/FOSOAuthServerBundle\n[2]: http://symfony.com/doc/2.8/setup.html\n[3]: http://symfony.com/doc/current/bundles/FOSRestBundle/index.html\n[4]: http://symfony.com/doc/current/bundles/FOSUserBundle/index.html\n[5]: https://github.com/symfony/symfony-installer\n[6]: https://bitgandtter.wordpress.com/2015/09/10/symfony-a-restful-app-security-fosoauthserverbundle/\n[7]: https://httpie.org/\n\n", "tags": ["Symfony", "FOSOAuthServerBundle", "Symfony2", "OAuth2.0", "PHP"]}