{"context": "\n\n\u524d\u63d0\uff1a\nBluemix\u30a2\u30ab\u30a6\u30f3\u30c8\u6301\u3063\u3066\u3044\u308b\u4e8b\nJuzzhub\u3068\u3064\u306a\u3052\u3066\u3044\u308b\u4e8b\u2193\nhttps://www.ibm.com/developerworks/jp/cloud/library/cl-poseidon2-app/\nLINE Bot\u3092\u4f5c\u3063\u3066\u3044\u308b\u3053\u3068\nNode-red\u304c\u4f7f\u7528\u53ef\u80fd\u306a\u4e8b\n\n\u4e2d\u8eab\n\n\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u4fee\u6b63\n\uff08\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u4fee\u6b63\u306f\u3001JuzzHub\u3067\u3084\u308c\u3070\u30d6\u30e9\u30a6\u30b6\u30aa\u30f3\u30ea\u30fc\u3067\u30ab\u30f3\u30bf\u30f3\u3067\u3059\u3088\u3002\uff09\n\nbluemix-settings.js\n    functionGlobalContext: {\n        crypto: require( \"crypto\" ) \n        process: process\n    },\n\n\nhttp://stackoverflow.com/questions/37121402/how-to-get-user-defined-variables-in-node-red-app-in-bluemix\nhttp://qiita.com/joeartsea/items/b5e8e14498f3098990c3\n\u306b\u3088\u308b\u3068\u3001bluemix-settings.js\u306eGlobalcontext\u306b\u5165\u308c\u305f\u3082\u306e\u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u306b\u306f\u3001context.global\u306e\u4e0b\u307f\u308c\u3070\u826f\u3044\u3002\nHMAC\u3092\u4f7f\u3046\u305f\u3081\u306b\u306f\u3001crypto\u304c\u5fc5\u8981\u3067\u3059\u3002\n\u304b\u3064\u3001X-Line-Channel-Secret\u3092\u30bd\u30fc\u30b9\u30b3\u30fc\u30c9\u306b\u30d9\u30bf\u66f8\u304d\u3059\u308b\u306e\u304c\u5acc\u306a\u306e\u3067\u74b0\u5883\u5909\u6570\u306b\u5165\u308c\u3066\u4f7f\u3044\u305f\u3044\u306e\u3067\u3001process\u304c\u5fc5\u8981\u3067\u3059\u3002\uff08\u3053\u3053\u306f\u30d9\u30bf\u66f8\u304d\u6d3e\u306a\u4eba\u306f\u4e0d\u8981\uff09\n\n\u74b0\u5883\u5909\u6570\u306e\u8ffd\u52a0\n\u30c0\u30c3\u30b7\u30e5\u30dc\u30fc\u30c9\u306e\u74b0\u5883\u5909\u6570\u753b\u9762\u3067\u4ee5\u4e0b\u3092\u305d\u308c\u305e\u308c\u8ffd\u52a0\u3002\u5024\u306fLINE\u304b\u3089\u8cb0\u3063\u305f\u5185\u5bb9\u3092\u5165\u308c\u307e\u3057\u3087\u3046\u3002-\uff08\u30cf\u30a4\u30d5\u30f3\uff09\u304c\u5165\u308b\u3068\u547c\u3073\u51fa\u3059\u3068\u304d\u306b\u306a\u3093\u304b\u30c0\u30e1\u3060\u3063\u305f\u306e\u3067\u30cf\u30a4\u30d5\u30f3\u629c\u304d\u306b\u3057\u307e\u3057\u305f\u3002\uff08\u307e\u3060\u3053\u306e\u8fba\u306f\u4e0d\u6163\u308c\u3067\u3059\uff09\nXLineChannelID\nXLineChannelSecret\nXLineTrustedUserWithACL\n\n\nFunction Node\u4f5c\u6210\nhttp://dev.classmethod.jp/cloud/build-line-bot-api-using-lambda/\n\u2191\u3053\u308c\u795e\uff01msg.payload\u3092\u305d\u306e\u307e\u307ehmac.update\u3057\u3088\u3046\u3068\u3057\u3066\u3082\u7d50\u679c\u304c\u5168\u7136\u3061\u304c\u3063\u305f\u3002\u591a\u5206\u30c7\u30fc\u30bf\u53d6\u308a\u51fa\u3059\u3068\u304d\u306e\u5fae\u5999\u306a\u8a71\u3060\u308d\u3046\u3068\u601d\u3063\u3066\u6563\u3005\u8abf\u3079\u3066\u3001\u3053\u306e\u30b5\u30a4\u30c8\u307f\u3066\u540c\u3058\u3088\u3046\u306b\u3084\u3063\u305f\u3089\u52d5\u3044\u305f\u3002\u3053\u3053\u3067\u304b\u306a\u308a\u30cf\u30de\u3063\u305f\u3002\n\u7d50\u679c\u7684\u306b\u3001\u4ee5\u4e0b\u306e\u69d8\u306aFunctionNode\u3092\u8ffd\u52a0\u3057\u3066msg.validation\u306b\u5165\u308c\u305f\u5024\u3068msg.req.headers.x-line-channelsignature\u306e\u5024\u3092SwitchNode\u3068\u304b\u3067\u6bd4\u8f03\u3057\u305f\u3089Validation\u51fa\u6765\u307e\u3059\u3002\nconst hmac = context.global.crypto.createHmac( 'sha256' , context.global.process.env.XLineChannelSecret );\nhmac.update( Buffer(JSON.stringify(msg.payload), 'utf8') );\nvar calcResult = hmac.digest('base64');\n\nmsg.validation = calcResult;\n\n\u4ee5\u4e0a\u3067\u3059\u3002\n\u518d\u73fe\u7528\u306eJSON\u3092\u8cbc\u3063\u3066\u304a\u304d\u307e\u3059\u3002\n[{\"id\":\"abedd440.742ec\",\"type\":\"http in\",\"z\":\"7e7669e.258d498\",\"name\":\"Callback\",\"url\":\"/callback\",\"method\":\"post\",\"swaggerDoc\":\"\",\"x\":75,\"y\":112,\"wires\":[[\"943f3bcb.08ff6\",\"67c4fc9.4bf7704\"]]},{\"id\":\"943f3bcb.08ff6\",\"type\":\"debug\",\"z\":\"7e7669e.258d498\",\"name\":\"\",\"active\":true,\"console\":\"false\",\"complete\":\"req.headers.x-line-channelsignature\",\"x\":389,\"y\":165,\"wires\":[]},{\"id\":\"67c4fc9.4bf7704\",\"type\":\"function\",\"z\":\"7e7669e.258d498\",\"name\":\"validation\",\"func\":\"const hmac = context.global.crypto.createHmac( 'sha256' , context.global.process.env.XLineChannelSecret );\\nhmac.update( Buffer(JSON.stringify(msg.payload), 'utf8') );\\nvar calcResult = hmac.digest('base64');\\n\\nmsg.validation = calcResult;\\n\\nreturn msg;\",\"outputs\":1,\"noerr\":0,\"x\":260,\"y\":240,\"wires\":[[\"9175c10b.130798\"]]},{\"id\":\"9175c10b.130798\",\"type\":\"switch\",\"z\":\"7e7669e.258d498\",\"name\":\"validation switch\",\"property\":\"validation\",\"propertyType\":\"msg\",\"rules\":[{\"t\":\"eq\",\"v\":\"req.headers.x-line-channelsignature\",\"vt\":\"msg\"}],\"checkall\":\"true\",\"outputs\":1,\"x\":420,\"y\":240,\"wires\":[[\"a532532b.79b0e\"]]},{\"id\":\"a532532b.79b0e\",\"type\":\"debug\",\"z\":\"7e7669e.258d498\",\"name\":\"\",\"active\":true,\"console\":\"false\",\"complete\":\"validation\",\"x\":612,\"y\":245,\"wires\":[]}]\n\n\n\u305d\u306e\u4ed6\nhttp://qiita.com/yoichiro6642/items/6d4c7309210af20a5c8f\n\u3053\u3061\u3089\u306b\u66f8\u3044\u3066\u3042\u308b\u3001\u307e\u305aQueue\u306b\u5165\u308c\u308b\u3063\u3066\u306e\u3082\uff08\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u691c\u8a3c\u3057\u305f\u308f\u3051\u3058\u3083\u306a\u3044\u3067\u3059\u304c\uff09\u7d50\u69cb\u30ab\u30f3\u30bf\u30f3\u306b\u5b9f\u88c5\u51fa\u6765\u305f\u306e\u3067\u5225\u9014\u8a18\u4e8b\u3092\u4e0a\u3052\u307e\u3059\u3002\n#\u524d\u63d0\uff1a\nBluemix\u30a2\u30ab\u30a6\u30f3\u30c8\u6301\u3063\u3066\u3044\u308b\u4e8b\nJuzzhub\u3068\u3064\u306a\u3052\u3066\u3044\u308b\u4e8b\u2193\nhttps://www.ibm.com/developerworks/jp/cloud/library/cl-poseidon2-app/\nLINE Bot\u3092\u4f5c\u3063\u3066\u3044\u308b\u3053\u3068\nNode-red\u304c\u4f7f\u7528\u53ef\u80fd\u306a\u4e8b\n\n\n#\u4e2d\u8eab\n\n###\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u4fee\u6b63\n\uff08\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u4fee\u6b63\u306f\u3001JuzzHub\u3067\u3084\u308c\u3070\u30d6\u30e9\u30a6\u30b6\u30aa\u30f3\u30ea\u30fc\u3067\u30ab\u30f3\u30bf\u30f3\u3067\u3059\u3088\u3002\uff09\n\n```js:bluemix-settings.js\n    functionGlobalContext: {\n\t\tcrypto: require( \"crypto\" ) \n\t\tprocess: process\n    },\n```\n\nhttp://stackoverflow.com/questions/37121402/how-to-get-user-defined-variables-in-node-red-app-in-bluemix\nhttp://qiita.com/joeartsea/items/b5e8e14498f3098990c3\n\u306b\u3088\u308b\u3068\u3001bluemix-settings.js\u306eGlobalcontext\u306b\u5165\u308c\u305f\u3082\u306e\u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u306b\u306f\u3001context.global\u306e\u4e0b\u307f\u308c\u3070\u826f\u3044\u3002\nHMAC\u3092\u4f7f\u3046\u305f\u3081\u306b\u306f\u3001crypto\u304c\u5fc5\u8981\u3067\u3059\u3002\n\u304b\u3064\u3001X-Line-Channel-Secret\u3092\u30bd\u30fc\u30b9\u30b3\u30fc\u30c9\u306b\u30d9\u30bf\u66f8\u304d\u3059\u308b\u306e\u304c\u5acc\u306a\u306e\u3067\u74b0\u5883\u5909\u6570\u306b\u5165\u308c\u3066\u4f7f\u3044\u305f\u3044\u306e\u3067\u3001process\u304c\u5fc5\u8981\u3067\u3059\u3002\uff08\u3053\u3053\u306f\u30d9\u30bf\u66f8\u304d\u6d3e\u306a\u4eba\u306f\u4e0d\u8981\uff09\n\n\n###\u74b0\u5883\u5909\u6570\u306e\u8ffd\u52a0\n\u30c0\u30c3\u30b7\u30e5\u30dc\u30fc\u30c9\u306e\u74b0\u5883\u5909\u6570\u753b\u9762\u3067\u4ee5\u4e0b\u3092\u305d\u308c\u305e\u308c\u8ffd\u52a0\u3002\u5024\u306fLINE\u304b\u3089\u8cb0\u3063\u305f\u5185\u5bb9\u3092\u5165\u308c\u307e\u3057\u3087\u3046\u3002-\uff08\u30cf\u30a4\u30d5\u30f3\uff09\u304c\u5165\u308b\u3068\u547c\u3073\u51fa\u3059\u3068\u304d\u306b\u306a\u3093\u304b\u30c0\u30e1\u3060\u3063\u305f\u306e\u3067\u30cf\u30a4\u30d5\u30f3\u629c\u304d\u306b\u3057\u307e\u3057\u305f\u3002\uff08\u307e\u3060\u3053\u306e\u8fba\u306f\u4e0d\u6163\u308c\u3067\u3059\uff09\n\n```\nXLineChannelID\nXLineChannelSecret\nXLineTrustedUserWithACL\n```\n\n\n###Function Node\u4f5c\u6210\nhttp://dev.classmethod.jp/cloud/build-line-bot-api-using-lambda/\n\u2191\u3053\u308c\u795e\uff01`msg.payload`\u3092\u305d\u306e\u307e\u307e`hmac.update`\u3057\u3088\u3046\u3068\u3057\u3066\u3082\u7d50\u679c\u304c\u5168\u7136\u3061\u304c\u3063\u305f\u3002\u591a\u5206\u30c7\u30fc\u30bf\u53d6\u308a\u51fa\u3059\u3068\u304d\u306e\u5fae\u5999\u306a\u8a71\u3060\u308d\u3046\u3068\u601d\u3063\u3066\u6563\u3005\u8abf\u3079\u3066\u3001\u3053\u306e\u30b5\u30a4\u30c8\u307f\u3066\u540c\u3058\u3088\u3046\u306b\u3084\u3063\u305f\u3089\u52d5\u3044\u305f\u3002\u3053\u3053\u3067\u304b\u306a\u308a\u30cf\u30de\u3063\u305f\u3002\n\n\u7d50\u679c\u7684\u306b\u3001\u4ee5\u4e0b\u306e\u69d8\u306aFunctionNode\u3092\u8ffd\u52a0\u3057\u3066`msg.validation`\u306b\u5165\u308c\u305f\u5024\u3068`msg.req.headers.x-line-channelsignature`\u306e\u5024\u3092SwitchNode\u3068\u304b\u3067\u6bd4\u8f03\u3057\u305f\u3089Validation\u51fa\u6765\u307e\u3059\u3002\n\n```js\nconst hmac = context.global.crypto.createHmac( 'sha256' , context.global.process.env.XLineChannelSecret );\nhmac.update( Buffer(JSON.stringify(msg.payload), 'utf8') );\nvar calcResult = hmac.digest('base64');\n\nmsg.validation = calcResult;\n```\n\n\u4ee5\u4e0a\u3067\u3059\u3002\n\n\n\u518d\u73fe\u7528\u306eJSON\u3092\u8cbc\u3063\u3066\u304a\u304d\u307e\u3059\u3002\n\n```\n[{\"id\":\"abedd440.742ec\",\"type\":\"http in\",\"z\":\"7e7669e.258d498\",\"name\":\"Callback\",\"url\":\"/callback\",\"method\":\"post\",\"swaggerDoc\":\"\",\"x\":75,\"y\":112,\"wires\":[[\"943f3bcb.08ff6\",\"67c4fc9.4bf7704\"]]},{\"id\":\"943f3bcb.08ff6\",\"type\":\"debug\",\"z\":\"7e7669e.258d498\",\"name\":\"\",\"active\":true,\"console\":\"false\",\"complete\":\"req.headers.x-line-channelsignature\",\"x\":389,\"y\":165,\"wires\":[]},{\"id\":\"67c4fc9.4bf7704\",\"type\":\"function\",\"z\":\"7e7669e.258d498\",\"name\":\"validation\",\"func\":\"const hmac = context.global.crypto.createHmac( 'sha256' , context.global.process.env.XLineChannelSecret );\\nhmac.update( Buffer(JSON.stringify(msg.payload), 'utf8') );\\nvar calcResult = hmac.digest('base64');\\n\\nmsg.validation = calcResult;\\n\\nreturn msg;\",\"outputs\":1,\"noerr\":0,\"x\":260,\"y\":240,\"wires\":[[\"9175c10b.130798\"]]},{\"id\":\"9175c10b.130798\",\"type\":\"switch\",\"z\":\"7e7669e.258d498\",\"name\":\"validation switch\",\"property\":\"validation\",\"propertyType\":\"msg\",\"rules\":[{\"t\":\"eq\",\"v\":\"req.headers.x-line-channelsignature\",\"vt\":\"msg\"}],\"checkall\":\"true\",\"outputs\":1,\"x\":420,\"y\":240,\"wires\":[[\"a532532b.79b0e\"]]},{\"id\":\"a532532b.79b0e\",\"type\":\"debug\",\"z\":\"7e7669e.258d498\",\"name\":\"\",\"active\":true,\"console\":\"false\",\"complete\":\"validation\",\"x\":612,\"y\":245,\"wires\":[]}]\n```\n\n##\u305d\u306e\u4ed6\n\nhttp://qiita.com/yoichiro6642/items/6d4c7309210af20a5c8f\n\u3053\u3061\u3089\u306b\u66f8\u3044\u3066\u3042\u308b\u3001\u307e\u305aQueue\u306b\u5165\u308c\u308b\u3063\u3066\u306e\u3082\uff08\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u691c\u8a3c\u3057\u305f\u308f\u3051\u3058\u3083\u306a\u3044\u3067\u3059\u304c\uff09\u7d50\u69cb\u30ab\u30f3\u30bf\u30f3\u306b\u5b9f\u88c5\u51fa\u6765\u305f\u306e\u3067\u5225\u9014\u8a18\u4e8b\u3092\u4e0a\u3052\u307e\u3059\u3002\n\n\n\n\n\n", "tags": ["linebot", "node-red", "Bluemix", "Node.js"]}