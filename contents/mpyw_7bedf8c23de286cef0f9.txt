{"context": "\n\n\u6982\u8981\nTwitter\u304c140\u79d2\u307e\u3067\u306e\u52d5\u753b\u30c4\u30a4\u30fc\u30c8\u306b\u5bfe\u5fdc\u3057\u305f\u3068\u805e\u3044\u305f\u306e\u3067\uff0c\u4ee5\u524d\u304b\u3089\u3042\u308b\u30a8\u30f3\u30c9\u30dd\u30a4\u30f3\u30c8\u3082\u542b\u3081\u3066\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u7cfb\u306e\u3082\u306e\u3092\u307e\u3068\u3081\u3066\u307f\u307e\u3057\u305f\uff0e\n\u30b5\u30f3\u30d7\u30eb\u306b\u306f\u62d9\u4f5c\u306eTwistOAuth\u3092\u7528\u3044\u305f\u30b3\u30fc\u30c9\u3092\u63b2\u8f09\u3057\u307e\u3059\uff0e\n\nPOST statuses/update_with_media\n\n\u5358\u4e00\u306e\u753b\u50cf\u306e\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u306b\u4f7f\u3048\u307e\u3059\uff0e\necho \"Uploading and tweeting...\\n\";\n$to->postMultipart('statuses/update_with_media', [\n    'status' => 'hello',\n    '@media[]' => 'photo.jpg',\n]);\n\necho \"Done!\\n\";\n\n\n\u73fe\u5728\u975e\u63a8\u5968\n\n\u30b5\u30fc\u30d0\u3068\u306e\u901a\u4fe1\u304c1\u56de\u3067\u6e08\u3080\nmultipart/form-data\u304c\u5f37\u5236\u3055\u308c\u308b\n\n\n\u30a8\u30f3\u30c9\u30dd\u30a4\u30f3\u30c8\u56fa\u6709\u306e\u30d1\u30e9\u30e1\u30fc\u30bf\u306foauth_signature\u306e\u751f\u6210\u5bfe\u8c61\u306b\u542b\u307e\u308c\u306a\u3044\n\n\n\nmedia[]\u3068\u3044\u3046\u30d1\u30e9\u30e1\u30fc\u30bf\u540d\u3067\u3042\u308b\u306b\u3082\u95a2\u308f\u3089\u305a\uff0c\u5358\u4e00\u306e\u753b\u50cf\u3057\u304b\u53d7\u3051\u4ed8\u3051\u306a\u3044\n\n\nPOST media/upload (\u30b3\u30de\u30f3\u30c9\u7121\u3057)\n\n1\u679a\u4ee5\u4e0a\u306e\u753b\u50cf\u306e\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u306b\u4f7f\u3048\u307e\u3059\uff0e\n$media_ids = [];\n\necho \"Uploading A.jpg...\\n\";\n$media_ids[] = $to->postMultipart('media/upload', [\n    '@media' => 'A.jpg',\n])->media_id_string;\n\necho \"Uploading B.jpg...\\n\";\n$media_ids[] = $to->post('media/upload', [\n    '@media' => 'B.jpg', // \u81ea\u52d5\u7684\u306b\u30c7\u30fc\u30bf\u304cBase64\u30a8\u30f3\u30b3\u30fc\u30c9\u3055\u308c\u308b\n])->media_id_string;\n\necho \"Tweeting...\\n\";\n$to->post('statuses/update', [\n    'status' => 'hello',\n    'media_ids' => implode(',', $media_ids),\n]);\n\necho \"Done!\\n\";\n\n\n\u30b5\u30fc\u30d0\u3068\u306e\u901a\u4fe1\u304c2\u56de\u4ee5\u4e0a\u5fc5\u8981\nmultipart/form-data\u3068application/x-www-form-urlencoded\u304b\u3089\u9078\u3079\u308b\n\n\nmultipart/form-data\u306e\u5834\u5408\uff0c\u30a8\u30f3\u30c9\u30dd\u30a4\u30f3\u30c8\u56fa\u6709\u306e\u30d1\u30e9\u30e1\u30fc\u30bf\u306foauth_signature\u306e\u751f\u6210\u5bfe\u8c61\u306b\u542b\u307e\u308c\u306a\u3044\napplication/x-www-form-urlencoded\u306e\u5834\u5408\uff0c\u30e1\u30c7\u30a3\u30a2\u30c7\u30fc\u30bf\u306e\u307fBase64\u30a8\u30f3\u30b3\u30fc\u30c9\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\n\n\n\n\u30aa\u30fc\u30d0\u30fc\u30d8\u30c3\u30c9\u306e\u5c0f\u3055\u3044multipart/form-data\u3092\u63a8\u5968\u3057\u307e\u3059\uff0e\n\nPOST media/upload (\u30b3\u30de\u30f3\u30c9\u3042\u308a\u30fb\u540c\u671f)\n\u3044\u308d\u3044\u308d\u306a\u30c7\u30fc\u30bf\u306e\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u306b\u4f7f\u3048\u307e\u3059\uff0e\n\n1\u679a\u4ee5\u4e0a\u306e\u753b\u50cf\n1\u3064\u306e\u30a2\u30cb\u30e1GIF (0.5\u79d2\u301c30\u79d2)\n1\u3064\u306e\u52d5\u753b (0.5\u79d2\u301c30\u79d2)\n\n\u4ee5\u4e0b\u306e\u30b3\u30de\u30f3\u30c9\u3092\u9806\u756a\u306b\u30b3\u30fc\u30eb\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\uff0e\n\nINIT\nAPPEND\nFINALIZE\n\n$filename = 'small_video.mp4';\n\necho \"Initializing...\\n\";\n$info = $to->post('media/upload', [\n    'command' => 'INIT',\n    'media_type' => 'video/mp4',\n    'total_bytes' => filesize($filename),\n]);\n\necho \"Uploading video...\\n\";\n$to->postMultipart('media/upload', [\n    'command' => 'APPEND',\n    'media_id' => $info->media_id_string,\n    'segment_index' => 0,\n    '@media' => $filename,\n]);\n\necho \"Finalizing...\\n\";\n$to->post('media/upload', [\n    'command' => 'FINALIZE',\n    'media_id' => $info->media_id_string,\n]);\n\necho \"Tweeting...\\n\";\n$to->post('statuses/update', [\n    'status' => 'hello',\n    'media_ids' => $info->media_id_string,\n]);\n\necho \"Done!\\n\";\n\n\n\u30b5\u30fc\u30d0\u3068\u306e\u901a\u4fe1\u304c4\u56de\u4ee5\u4e0a\u5fc5\u8981\nmultipart/form-data\u3068application/x-www-form-urlencoded\u304b\u3089\u9078\u3079\u308b\n\n\nmultipart/form-data\u306e\u5834\u5408\uff0c\u30a8\u30f3\u30c9\u30dd\u30a4\u30f3\u30c8\u56fa\u6709\u306e\u30d1\u30e9\u30e1\u30fc\u30bf\u306foauth_signature\u306e\u751f\u6210\u5bfe\u8c61\u306b\u542b\u307e\u308c\u306a\u3044\napplication/x-www-form-urlencoded\u306e\u5834\u5408\uff0c\u30e1\u30c7\u30a3\u30a2\u30c7\u30fc\u30bf\u306e\u307fBase64\u30a8\u30f3\u30b3\u30fc\u30c9\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\n\n\n\n\u30aa\u30fc\u30d0\u30fc\u30d8\u30c3\u30c9\u306e\u5c0f\u3055\u3044multipart/form-data\u3092\u63a8\u5968\u3057\u307e\u3059\uff0e\n\nGET|POST media/upload (\u30b3\u30de\u30f3\u30c9\u3042\u308a\u30fb\u975e\u540c\u671f)\n\u3044\u308d\u3044\u308d\u306a\u30c7\u30fc\u30bf\u306e\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u306b\u4f7f\u3048\u307e\u3059\uff0e\u3053\u3061\u3089\u306f\u5927\u304d\u306a\u30c7\u30fc\u30bf\u3092\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u3059\u308b\u524d\u63d0\u306a\u306e\u3067\uff0c\u30c1\u30e3\u30f3\u30af\u5206\u5272\u3092\u5165\u308c\u307e\u3059\uff0e\u5206\u5272\u3092\u884c\u308f\u306a\u3044\u3068\uff0c413 Request Entity Too Large\u304c\u8fd4\u3055\u308c\u3066\u3057\u307e\u3046\u5834\u5408\u304c\u3042\u308a\u307e\u3059\uff0e\n\n1\u679a\u4ee5\u4e0a\u306e\u753b\u50cf\n\n\nmedia_category=tweet_image\n\n\n1\u3064\u306e\u30a2\u30cb\u30e1GIF (0.5\u79d2\u301c140\u79d2)\n\n\nmedia_category=tweet_gif\n\n\n1\u3064\u306e\u52d5\u753b (0.5\u79d2\u301c140\u79d2)\n\n\nmedia_category=tweet_video\n\n\n\n\u4ee5\u4e0b\u306e\u30b3\u30de\u30f3\u30c9\u3092\u9806\u756a\u306b\u30b3\u30fc\u30eb\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\uff0e\n\n\nINIT (media_category\u6307\u5b9a\u5fc5\u9808)\n\nAPPEND\nFINALIZE\nSTATUS\n\n$file = new \\SplFileObject('large_video.mp4', 'rb');\n$chunk_size = 262144; // \u9069\u5f53\u306b\u8abf\u7bc0\u3057\u3066\u304f\u3060\u3055\u3044\n\necho \"Initializing...\\n\";\n$info = $to->post('media/upload', [\n    'command' => 'INIT',\n    'media_type' => 'video/mp4',\n    'total_bytes' => $file->getSize(),\n    'media_category' => 'tweet_video', // \u3053\u308c\u3092\u5fd8\u308c\u308b\u3068\u975e\u540c\u671f\u306e\u307b\u3046\u306b\u306a\u3089\u306a\u3044\n]);\n\n$curls = [];\nfor ($i = 0; '' !== $buffer = $file->fread($chunk_size); ++$i) { // \u30c1\u30e3\u30f3\u30af\u30b5\u30a4\u30ba\u3054\u3068\u306b\u5206\u5272\n    $curls[] = $to->curlPostMultipart('media/upload', [\n        'command' => 'APPEND',\n        'media_id' => $info->media_id_string,\n        'segment_index' => $i,\n        '#media' => $buffer,\n    ]); // \u30ea\u30af\u30a8\u30b9\u30c8\u305b\u305a\u306b\u30ea\u30af\u30a8\u30b9\u30c8\u7528\u306ecURL\u30ea\u30bd\u30fc\u30b9\u3060\u3051\u3092\u7528\u610f\n}\n\necho \"Uploading chunks...\\n\";\n$to->curlMultiExec($curls, true); // 1\u30c1\u30e3\u30f3\u30af\u3054\u3068\u306b\u5f85\u3063\u3066\u308b\u3068\u6642\u9593\u304c\u304b\u304b\u308b\u306e\u3067\u4e26\u5217\u5316\n\necho \"Finalizing...\\n\";\n$info = $to->post('media/upload', [\n    'command' => 'FINALIZE',\n    'media_id' => $info->media_id_string,\n]);\n\necho \"Waiting for processing...\\n\";\nwhile ($info->processing_info->state === 'pending' || $info->processing_info->state === 'in_progress') { // \u7d42\u308f\u308b\u304b\u5931\u6557\u3059\u308b\u307e\u3067\u7e70\u308a\u8fd4\u3059\n    $percent = isset($info->processing_info->progress_percent) // \u5834\u5408\u306b\u3088\u3063\u3066\u306f\u30d1\u30fc\u30bb\u30f3\u30c8\u8868\u8a18\u304c\u8fd4\u3063\u3066\u304f\u308b\n        ? \"({$info->processing_info->progress_percent}%)\"\n        : ''\n    ;\n    echo \"State: {$info->processing_info->state} {$percent}\\n\"; \n    sleep($info->processing_info->check_after_secs); // \u5f85\u3064\u3088\u3046\u306b\u6307\u793a\u3055\u308c\u305f\u3076\u3093\u3060\u3051\u5f85\u3064\n    $info = $to->get('media/upload', [\n        'command' => 'STATUS',\n        'media_id' => $info->media_id_string,\n    ]); // \u60c5\u5831\u3092\u66f4\u65b0\n}\n\nif ($info->processing_info->state === 'failed') {\n    // \u5931\u6557\u6642\u306f\u4f8b\u5916\u3092\u30b9\u30ed\u30fc\n    throw new \\RuntimeException($info->processing_info->error->name);\n}\n\necho \"Tweeting...\\n\";\n$to->post('statuses/update', [\n    'status' => 'hello',\n    'media_ids' => $info->media_id_string,\n]);\n\necho \"Done!\\n\";\n\n\n\u30b5\u30fc\u30d0\u3068\u306e\u901a\u4fe1\u304c\u304b\u306a\u308a\u306e\u56de\u6570\u5fc5\u8981\nmultipart/form-data\u3068application/x-www-form-urlencoded\u304b\u3089\u9078\u3079\u308b\n\n\nmultipart/form-data\u306e\u5834\u5408\uff0c\u30a8\u30f3\u30c9\u30dd\u30a4\u30f3\u30c8\u56fa\u6709\u306e\u30d1\u30e9\u30e1\u30fc\u30bf\u306foauth_signature\u306e\u751f\u6210\u5bfe\u8c61\u306b\u542b\u307e\u308c\u306a\u3044\napplication/x-www-form-urlencoded\u306e\u5834\u5408\uff0c\u30e1\u30c7\u30a3\u30a2\u30c7\u30fc\u30bf\u306e\u307fBase64\u30a8\u30f3\u30b3\u30fc\u30c9\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\n\n\n\u5931\u6557\u3057\u305f\u6642\u306b$info->processing->state\u304c\"fail\"\u306b\u306a\u308b\u3053\u3068\u304c\u3042\u308b\n\n\n\u3057\u304b\u3057\uff0c\u305d\u306e\u3068\u304d\u306eHTTP\u30b9\u30c6\u30fc\u30bf\u30b9\u30b3\u30fc\u30c9\u306f200 OK\n\u30a8\u30e9\u30fc\u5185\u5bb9\u6b21\u7b2c\u3067\u306f\u5f93\u6765\u306e {\"errors\":[{\"code\":1,\"message\":\"xx\"}]}\u304c400 Bad Request\u3067\u6765\u308b\u3053\u3068\u3082\u3042\u308b\n\u5931\u6557\u3057\u305f\u30e1\u30c7\u30a3\u30a2\u3067statuses/update\u3057\u3088\u3046\u3068\u3059\u308b\u3068\u3057\u3063\u304b\u308a400 Bad Request\u306e\u30a8\u30e9\u30fc\u306b\u306a\u308b\u306e\u3067\uff0c\u5fc5\u305a\u3057\u3082\u3053\u306e\u30a8\u30e9\u30fc\u30cf\u30f3\u30c9\u30ea\u30f3\u30b0\u3092\u7279\u5225\u6271\u3044\u3057\u3066\u884c\u3046\u5fc5\u8981\u306f\u306a\u3044\n\n\n\n\u30aa\u30fc\u30d0\u30fc\u30d8\u30c3\u30c9\u306e\u5c0f\u3055\u3044multipart/form-data\u3092\u63a8\u5968\u3057\u307e\u3059\uff0e\n\u8ffd\u8a18: TwistOAuth\u306e\u5f8c\u7d99\u3067\u3042\u308bCowitter\u3067\u306f\uff0c\u9762\u5012\u306a\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u306e\u305f\u3081\u306e\u8a18\u8ff0\u3092\u4e38\u6295\u3052\u3067\u304d\u307e\u3059\n\nCowitter\u306e\u30e1\u30bd\u30c3\u30c9\u3092\u6d3b\u7528\u3059\u308b\u5834\u5408\nCo::wait(function () use ($client) {\n    $file = new \\SplFileObject('large_video.mp4', 'rb');\n\n    $on_uploading = function ($percent) {\n        echo \"Uploading ... ({$percent}%)\\n\";\n    };\n    $on_processing = function ($percent) {\n        echo \"Processing ... ({$percent}%)\\n\";\n    };\n\n    yield $client->postAsync('statuses/update', [\n        'status' => 'My video',\n        'media_ids' => (yield $client->uploadVideoAsync($file, $on_uploading, $on_processing))->media_id_string,\n    ]);\n\n    echo \"Done!\\n\";\n});\n\n\n\n# \u6982\u8981\n\nTwitter\u304c140\u79d2\u307e\u3067\u306e\u52d5\u753b\u30c4\u30a4\u30fc\u30c8\u306b\u5bfe\u5fdc\u3057\u305f\u3068\u805e\u3044\u305f\u306e\u3067\uff0c\u4ee5\u524d\u304b\u3089\u3042\u308b\u30a8\u30f3\u30c9\u30dd\u30a4\u30f3\u30c8\u3082\u542b\u3081\u3066\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u7cfb\u306e\u3082\u306e\u3092\u307e\u3068\u3081\u3066\u307f\u307e\u3057\u305f\uff0e\n\n\u30b5\u30f3\u30d7\u30eb\u306b\u306f\u62d9\u4f5c\u306e[TwistOAuth](https://github.com/mpyw/TwistOAuth)\u3092\u7528\u3044\u305f\u30b3\u30fc\u30c9\u3092\u63b2\u8f09\u3057\u307e\u3059\uff0e\n\n# [POST statuses/update_with_media](https://dev.twitter.com/rest/reference/post/statuses/update_with_media)\n\n\u5358\u4e00\u306e\u753b\u50cf\u306e\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u306b\u4f7f\u3048\u307e\u3059\uff0e\n\n```php\necho \"Uploading and tweeting...\\n\";\n$to->postMultipart('statuses/update_with_media', [\n    'status' => 'hello',\n    '@media[]' => 'photo.jpg',\n]);\n\necho \"Done!\\n\";\n```\n\n- \u73fe\u5728**\u975e\u63a8\u5968**\n- \u30b5\u30fc\u30d0\u3068\u306e\u901a\u4fe1\u304c1\u56de\u3067\u6e08\u3080\n- multipart/form-data\u304c\u5f37\u5236\u3055\u308c\u308b\n  - \u30a8\u30f3\u30c9\u30dd\u30a4\u30f3\u30c8\u56fa\u6709\u306e\u30d1\u30e9\u30e1\u30fc\u30bf\u306f`oauth_signature`\u306e\u751f\u6210\u5bfe\u8c61\u306b\u542b\u307e\u308c\u306a\u3044\n- `media[]`\u3068\u3044\u3046\u30d1\u30e9\u30e1\u30fc\u30bf\u540d\u3067\u3042\u308b\u306b\u3082\u95a2\u308f\u3089\u305a\uff0c\u5358\u4e00\u306e\u753b\u50cf\u3057\u304b\u53d7\u3051\u4ed8\u3051\u306a\u3044\n\n# [POST media/upload (\u30b3\u30de\u30f3\u30c9\u7121\u3057)](https://dev.twitter.com/rest/reference/post/media/upload)\n\n1\u679a\u4ee5\u4e0a\u306e\u753b\u50cf\u306e\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u306b\u4f7f\u3048\u307e\u3059\uff0e\n\n```php\n$media_ids = [];\n\necho \"Uploading A.jpg...\\n\";\n$media_ids[] = $to->postMultipart('media/upload', [\n    '@media' => 'A.jpg',\n])->media_id_string;\n\necho \"Uploading B.jpg...\\n\";\n$media_ids[] = $to->post('media/upload', [\n    '@media' => 'B.jpg', // \u81ea\u52d5\u7684\u306b\u30c7\u30fc\u30bf\u304cBase64\u30a8\u30f3\u30b3\u30fc\u30c9\u3055\u308c\u308b\n])->media_id_string;\n\necho \"Tweeting...\\n\";\n$to->post('statuses/update', [\n    'status' => 'hello',\n    'media_ids' => implode(',', $media_ids),\n]);\n\necho \"Done!\\n\";\n```\n\n- \u30b5\u30fc\u30d0\u3068\u306e\u901a\u4fe1\u304c2\u56de\u4ee5\u4e0a\u5fc5\u8981\n- multipart/form-data\u3068application/x-www-form-urlencoded\u304b\u3089\u9078\u3079\u308b\n  - multipart/form-data\u306e\u5834\u5408\uff0c\u30a8\u30f3\u30c9\u30dd\u30a4\u30f3\u30c8\u56fa\u6709\u306e\u30d1\u30e9\u30e1\u30fc\u30bf\u306f`oauth_signature`\u306e\u751f\u6210\u5bfe\u8c61\u306b\u542b\u307e\u308c\u306a\u3044\n  - application/x-www-form-urlencoded\u306e\u5834\u5408\uff0c\u30e1\u30c7\u30a3\u30a2\u30c7\u30fc\u30bf\u306e\u307fBase64\u30a8\u30f3\u30b3\u30fc\u30c9\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\n\n\u30aa\u30fc\u30d0\u30fc\u30d8\u30c3\u30c9\u306e\u5c0f\u3055\u3044multipart/form-data\u3092\u63a8\u5968\u3057\u307e\u3059\uff0e\n\n# POST media/upload (\u30b3\u30de\u30f3\u30c9\u3042\u308a\u30fb\u540c\u671f)\n\n\u3044\u308d\u3044\u308d\u306a\u30c7\u30fc\u30bf\u306e\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u306b\u4f7f\u3048\u307e\u3059\uff0e\n\n- 1\u679a\u4ee5\u4e0a\u306e\u753b\u50cf\n- 1\u3064\u306e\u30a2\u30cb\u30e1GIF (0.5\u79d2\u301c30\u79d2)\n- 1\u3064\u306e\u52d5\u753b (0.5\u79d2\u301c30\u79d2)\n\n\u4ee5\u4e0b\u306e\u30b3\u30de\u30f3\u30c9\u3092\u9806\u756a\u306b\u30b3\u30fc\u30eb\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\uff0e\n\n1. [INIT](https://dev.twitter.com/rest/reference/post/media/upload-init)\n2. [APPEND](https://dev.twitter.com/rest/reference/post/media/upload-append)\n3. [FINALIZE](https://dev.twitter.com/rest/reference/post/media/upload-finalize)\n\n```php\n$filename = 'small_video.mp4';\n\necho \"Initializing...\\n\";\n$info = $to->post('media/upload', [\n    'command' => 'INIT',\n    'media_type' => 'video/mp4',\n    'total_bytes' => filesize($filename),\n]);\n\necho \"Uploading video...\\n\";\n$to->postMultipart('media/upload', [\n    'command' => 'APPEND',\n    'media_id' => $info->media_id_string,\n    'segment_index' => 0,\n    '@media' => $filename,\n]);\n\necho \"Finalizing...\\n\";\n$to->post('media/upload', [\n    'command' => 'FINALIZE',\n    'media_id' => $info->media_id_string,\n]);\n\necho \"Tweeting...\\n\";\n$to->post('statuses/update', [\n    'status' => 'hello',\n    'media_ids' => $info->media_id_string,\n]);\n\necho \"Done!\\n\";\n```\n\n- \u30b5\u30fc\u30d0\u3068\u306e\u901a\u4fe1\u304c4\u56de\u4ee5\u4e0a\u5fc5\u8981\n- multipart/form-data\u3068application/x-www-form-urlencoded\u304b\u3089\u9078\u3079\u308b\n  - multipart/form-data\u306e\u5834\u5408\uff0c\u30a8\u30f3\u30c9\u30dd\u30a4\u30f3\u30c8\u56fa\u6709\u306e\u30d1\u30e9\u30e1\u30fc\u30bf\u306f`oauth_signature`\u306e\u751f\u6210\u5bfe\u8c61\u306b\u542b\u307e\u308c\u306a\u3044\n  - application/x-www-form-urlencoded\u306e\u5834\u5408\uff0c\u30e1\u30c7\u30a3\u30a2\u30c7\u30fc\u30bf\u306e\u307fBase64\u30a8\u30f3\u30b3\u30fc\u30c9\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\n\n\u30aa\u30fc\u30d0\u30fc\u30d8\u30c3\u30c9\u306e\u5c0f\u3055\u3044multipart/form-data\u3092\u63a8\u5968\u3057\u307e\u3059\uff0e\n\n# GET|POST media/upload (\u30b3\u30de\u30f3\u30c9\u3042\u308a\u30fb\u975e\u540c\u671f)\n\n\u3044\u308d\u3044\u308d\u306a\u30c7\u30fc\u30bf\u306e\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u306b\u4f7f\u3048\u307e\u3059\uff0e\u3053\u3061\u3089\u306f\u5927\u304d\u306a\u30c7\u30fc\u30bf\u3092\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u3059\u308b\u524d\u63d0\u306a\u306e\u3067\uff0c\u30c1\u30e3\u30f3\u30af\u5206\u5272\u3092\u5165\u308c\u307e\u3059\uff0e**\u5206\u5272\u3092\u884c\u308f\u306a\u3044\u3068\uff0c`413 Request Entity Too Large`\u304c\u8fd4\u3055\u308c\u3066\u3057\u307e\u3046\u5834\u5408\u304c\u3042\u308a\u307e\u3059\uff0e**\n\n- 1\u679a\u4ee5\u4e0a\u306e\u753b\u50cf\n  - **`media_category=tweet_image`**\n- 1\u3064\u306e\u30a2\u30cb\u30e1GIF (0.5\u79d2\u301c**140\u79d2**)\n  - **`media_category=tweet_gif`**\n- 1\u3064\u306e\u52d5\u753b (0.5\u79d2\u301c**140\u79d2**)\n  - **`media_category=tweet_video`**\n\n\u4ee5\u4e0b\u306e\u30b3\u30de\u30f3\u30c9\u3092\u9806\u756a\u306b\u30b3\u30fc\u30eb\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\uff0e\n\n1. [INIT](https://dev.twitter.com/rest/reference/post/media/upload-init) **(`media_category`\u6307\u5b9a\u5fc5\u9808)**\n2. [APPEND](https://dev.twitter.com/rest/reference/post/media/upload-append)\n3. [FINALIZE](https://dev.twitter.com/rest/reference/post/media/upload-finalize)\n4. [STATUS](https://dev.twitter.com/rest/reference/post/media/upload-status)\n\n```php\n$file = new \\SplFileObject('large_video.mp4', 'rb');\n$chunk_size = 262144; // \u9069\u5f53\u306b\u8abf\u7bc0\u3057\u3066\u304f\u3060\u3055\u3044\n\necho \"Initializing...\\n\";\n$info = $to->post('media/upload', [\n    'command' => 'INIT',\n    'media_type' => 'video/mp4',\n    'total_bytes' => $file->getSize(),\n    'media_category' => 'tweet_video', // \u3053\u308c\u3092\u5fd8\u308c\u308b\u3068\u975e\u540c\u671f\u306e\u307b\u3046\u306b\u306a\u3089\u306a\u3044\n]);\n\n$curls = [];\nfor ($i = 0; '' !== $buffer = $file->fread($chunk_size); ++$i) { // \u30c1\u30e3\u30f3\u30af\u30b5\u30a4\u30ba\u3054\u3068\u306b\u5206\u5272\n    $curls[] = $to->curlPostMultipart('media/upload', [\n        'command' => 'APPEND',\n        'media_id' => $info->media_id_string,\n        'segment_index' => $i,\n        '#media' => $buffer,\n    ]); // \u30ea\u30af\u30a8\u30b9\u30c8\u305b\u305a\u306b\u30ea\u30af\u30a8\u30b9\u30c8\u7528\u306ecURL\u30ea\u30bd\u30fc\u30b9\u3060\u3051\u3092\u7528\u610f\n}\n\necho \"Uploading chunks...\\n\";\n$to->curlMultiExec($curls, true); // 1\u30c1\u30e3\u30f3\u30af\u3054\u3068\u306b\u5f85\u3063\u3066\u308b\u3068\u6642\u9593\u304c\u304b\u304b\u308b\u306e\u3067\u4e26\u5217\u5316\n\necho \"Finalizing...\\n\";\n$info = $to->post('media/upload', [\n    'command' => 'FINALIZE',\n    'media_id' => $info->media_id_string,\n]);\n\necho \"Waiting for processing...\\n\";\nwhile ($info->processing_info->state === 'pending' || $info->processing_info->state === 'in_progress') { // \u7d42\u308f\u308b\u304b\u5931\u6557\u3059\u308b\u307e\u3067\u7e70\u308a\u8fd4\u3059\n    $percent = isset($info->processing_info->progress_percent) // \u5834\u5408\u306b\u3088\u3063\u3066\u306f\u30d1\u30fc\u30bb\u30f3\u30c8\u8868\u8a18\u304c\u8fd4\u3063\u3066\u304f\u308b\n        ? \"({$info->processing_info->progress_percent}%)\"\n        : ''\n    ;\n    echo \"State: {$info->processing_info->state} {$percent}\\n\"; \n    sleep($info->processing_info->check_after_secs); // \u5f85\u3064\u3088\u3046\u306b\u6307\u793a\u3055\u308c\u305f\u3076\u3093\u3060\u3051\u5f85\u3064\n    $info = $to->get('media/upload', [\n        'command' => 'STATUS',\n        'media_id' => $info->media_id_string,\n    ]); // \u60c5\u5831\u3092\u66f4\u65b0\n}\n\nif ($info->processing_info->state === 'failed') {\n    // \u5931\u6557\u6642\u306f\u4f8b\u5916\u3092\u30b9\u30ed\u30fc\n    throw new \\RuntimeException($info->processing_info->error->name);\n}\n\necho \"Tweeting...\\n\";\n$to->post('statuses/update', [\n    'status' => 'hello',\n    'media_ids' => $info->media_id_string,\n]);\n\necho \"Done!\\n\";\n```\n\n- \u30b5\u30fc\u30d0\u3068\u306e\u901a\u4fe1\u304c\u304b\u306a\u308a\u306e\u56de\u6570\u5fc5\u8981\n- multipart/form-data\u3068application/x-www-form-urlencoded\u304b\u3089\u9078\u3079\u308b\n  - multipart/form-data\u306e\u5834\u5408\uff0c\u30a8\u30f3\u30c9\u30dd\u30a4\u30f3\u30c8\u56fa\u6709\u306e\u30d1\u30e9\u30e1\u30fc\u30bf\u306f`oauth_signature`\u306e\u751f\u6210\u5bfe\u8c61\u306b\u542b\u307e\u308c\u306a\u3044\n  - application/x-www-form-urlencoded\u306e\u5834\u5408\uff0c\u30e1\u30c7\u30a3\u30a2\u30c7\u30fc\u30bf\u306e\u307fBase64\u30a8\u30f3\u30b3\u30fc\u30c9\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\n- \u5931\u6557\u3057\u305f\u6642\u306b`$info->processing->state`\u304c`\"fail\"`\u306b\u306a\u308b\u3053\u3068\u304c\u3042\u308b\n  - **\u3057\u304b\u3057\uff0c\u305d\u306e\u3068\u304d\u306eHTTP\u30b9\u30c6\u30fc\u30bf\u30b9\u30b3\u30fc\u30c9\u306f`200 OK`**\n  - \u30a8\u30e9\u30fc\u5185\u5bb9\u6b21\u7b2c\u3067\u306f\u5f93\u6765\u306e `{\"errors\":[{\"code\":1,\"message\":\"xx\"}]}`\u304c`400 Bad Request`\u3067\u6765\u308b\u3053\u3068\u3082\u3042\u308b\n  - \u5931\u6557\u3057\u305f\u30e1\u30c7\u30a3\u30a2\u3067`statuses/update`\u3057\u3088\u3046\u3068\u3059\u308b\u3068\u3057\u3063\u304b\u308a`400 Bad Request`\u306e\u30a8\u30e9\u30fc\u306b\u306a\u308b\u306e\u3067\uff0c\u5fc5\u305a\u3057\u3082\u3053\u306e\u30a8\u30e9\u30fc\u30cf\u30f3\u30c9\u30ea\u30f3\u30b0\u3092\u7279\u5225\u6271\u3044\u3057\u3066\u884c\u3046\u5fc5\u8981\u306f\u306a\u3044\n\n\u30aa\u30fc\u30d0\u30fc\u30d8\u30c3\u30c9\u306e\u5c0f\u3055\u3044multipart/form-data\u3092\u63a8\u5968\u3057\u307e\u3059\uff0e\n\n**\u8ffd\u8a18: TwistOAuth\u306e\u5f8c\u7d99\u3067\u3042\u308b[Cowitter](https://github.com/mpyw/cowitter)\u3067\u306f\uff0c\u9762\u5012\u306a\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u306e\u305f\u3081\u306e\u8a18\u8ff0\u3092\u4e38\u6295\u3052\u3067\u304d\u307e\u3059**\n\n```php:Cowitter\u306e\u30e1\u30bd\u30c3\u30c9\u3092\u6d3b\u7528\u3059\u308b\u5834\u5408\nCo::wait(function () use ($client) {\n    $file = new \\SplFileObject('large_video.mp4', 'rb');\n\n    $on_uploading = function ($percent) {\n        echo \"Uploading ... ({$percent}%)\\n\";\n    };\n    $on_processing = function ($percent) {\n        echo \"Processing ... ({$percent}%)\\n\";\n    };\n\n    yield $client->postAsync('statuses/update', [\n        'status' => 'My video',\n        'media_ids' => (yield $client->uploadVideoAsync($file, $on_uploading, $on_processing))->media_id_string,\n    ]);\n\n    echo \"Done!\\n\";\n});\n\n```\n\n\n", "tags": ["PHP", "Twitter", "TwitterAPI", "TwistOAuth"]}