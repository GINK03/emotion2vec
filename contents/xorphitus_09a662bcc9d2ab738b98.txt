{"context": " More than 1 year has passed since last update.\n\n\u3053\u306e\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u306b\u3064\u3044\u3066\ntwemproxy (nutcracker) \u304c\u4e00\u4f53\u4f55\u8005\u3067\u3042\u308a\u3001\u307e\u305f\u3001\u904b\u7528\u306b\u3042\u305f\u308a\u7406\u89e3\u304c\u5fc5\u8981\u3067\u3042\u308d\u3046\u7b87\u6240\u306b\u3064\u3044\u3066\u3001\u672c\u5bb6\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u3092\u96d1\u306b\u610f\u8a33\u3057\u305f\u3082\u306e\u3067\u3059\u3002\n\u4ed5\u4e8b\u4e0a\u306e\u30e1\u30e2\u3068\u3057\u3066\u4f5c\u6210\u3057\u305f\u306e\u3092\u305d\u306e\u307e\u307e\u516c\u958b\u3059\u308b\u306e\u3067\u65e5\u672c\u8a9e\u304c\u6b8b\u5ff5\u306a\u3068\u3053\u308d\u3082\u6b63\u76f4\u591a\u3005\u3042\u308b\u306e\u3067\u3059\u304c\u3001\u3053\u308c\u3092\u5b8c\u6210\u3055\u305b\u308b\u307e\u3067\u7720\u3089\u305b\u3066\u304a\u304f\u3088\u308a\u306f(\u3044\u3064\u306b\u306a\u308b\u3053\u3068\u3084\u3089)\u3055\u3063\u3055\u3068\u516c\u958b\u3057\u3066\u3001\u4eca twemproxy \u306e\u5c0e\u5165\u3092\u691c\u8a0e\u3057\u3066\u3044\u308b\u65b9\u3084\u3001\u904b\u7528\u3055\u308c\u3066\u3044\u308b\u65b9\u306e\u4f55\u304b\u3057\u3089\u306e\u529b\u306b\u306a\u308c\u3070\u3068\u601d\u3063\u3066\u3044\u307e\u3059\u3002\n\u7c97\u3044\u5185\u5bb9\u3067\u3059\u306e\u3067\u3001\u4f55\u304b\u3054\u3056\u3044\u307e\u3057\u305f\u3089\u7de8\u96c6\u30ea\u30af\u30a8\u30b9\u30c8\u3092\u9802\u3051\u308b\u3068\u5e78\u3044\u3067\u3059\u3002\n\nREADME.md\nhttps://github.com/twitter/twemproxy/blob/master/README.md \u306e\u3046\u3061 twemproxy \u306e\u7279\u6027\u306b\u3064\u3044\u3066\u7406\u89e3\u3057\u3066\u304a\u3044\u305f\u65b9\u304c\u3044\u3044\u3068\u3053\u308d\u3092\u304b\u3044\u3064\u307e\u3093\u3067\u8a33\u3057\u305f\u308a\u3059\u308b\u30b3\u30fc\u30ca\u30fc\u3002\n\ntwemproxy \u6982\u8981\ntwemproxy (\"two-em-proxy\" \u3068\u767a\u97f3) \u306f nutcracker \u3068\u3082\u547c\u3070\u308c\u308b\u3001\u9ad8\u901f\u3067\u8efd\u91cf\u306a\u3001memcached\u3001redis \u30d7\u30ed\u30c8\u30b3\u30eb\u306e\u30d7\u30ed\u30ad\u30b7\u3067\u3042\u308b\u3002\n\u6700\u5927\u306e\u76ee\u7684\u306f\u3001\u30d0\u30c3\u30af\u30a8\u30f3\u30c9\u306e\u30ad\u30e3\u30c3\u30b7\u30e5\u30b5\u30fc\u30d0\u306e\u63a5\u7d9a\u6570\u3092\u6e1b\u3089\u3059\u3053\u3068\u3067\u3042\u308b\u3002\n\u307e\u305f\u3001\u305d\u308c\u3068\u540c\u6642\u306b\u30d1\u30a4\u30d7\u30e9\u30a4\u30f3\u3084\u30b7\u30e3\u30fc\u30c7\u30a3\u30f3\u30b0\u3082\u5229\u7528\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u308b\u305f\u3081\u3001\u6c34\u5e73\u5206\u6563\u306b\u3088\u308b\u30b9\u30b1\u30fc\u30e9\u30d6\u30eb\u306a\u30ad\u30e3\u30c3\u30b7\u30e5\u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3\u306e\u5b9f\u73fe\u304c\u3067\u304d\u308b\u3002\n\n\u203b\u8a33\u8005\u30b3\u30e1\u30f3\u30c8\n\u4e0a\u8a18 README.md \u306e\u5192\u982d\u306e\u5185\u5bb9\u306a\u306e\u3067\u3059\u304c\u3001\u8a2d\u8a08\u4e0a\u91cd\u8981\u306a\u60c5\u5831\u304c\u542b\u307e\u308c\u3066\u3044\u308b\u306e\u3067\u30b3\u30e1\u30f3\u30c8\u3092\u631f\u307e\u305b\u3066\u9802\u304d\u307e\u3059\u3002\ntwemproxy \u306f\u300c\u30b7\u30e3\u30fc\u30c7\u30a3\u30f3\u30b0\u306b\u3088\u308b\u5bb9\u91cf\u306e\u30b9\u30b1\u30fc\u30eb\u30a2\u30a6\u30c8\u300d\u3092\u76ee\u7684\u3068\u3057\u3066\u304a\u3089\u305a\u3001\u3042\u304f\u307e\u3067\u30ad\u30e3\u30c3\u30b7\u30e5\u30b5\u30fc\u30d0\u306b\u5bfe\u3059\u308b\u5927\u91cf\u30a2\u30af\u30bb\u30b9\u306b\u3069\u3046\u5bfe\u51e6\u3059\u308b\u304b\u3068\u3044\u3046\u3068\u3053\u308d\u306b\u30d5\u30a9\u30fc\u30ab\u30b9\u3057\u3066\u4f5c\u3089\u308c\u305f\u3082\u306e\u3068\u306a\u3063\u3066\u3044\u307e\u3059\u3002\n\u305d\u308c\u3086\u3048\u304b\u3001\u30ea\u30b7\u30e3\u30fc\u30c7\u30a3\u30f3\u30b0\u306e\u6a5f\u80fd\u306f\u6301\u3063\u3066\u304a\u3089\u305a\u3001\u307e\u305f\u3001redis \u304c\u6c38\u7d9a\u5316\u30c7\u30fc\u30bf\u3092\u6271\u3046\u3088\u3046\u306a\u30b7\u30fc\u30f3\u3082\u60f3\u5b9a\u3055\u308c\u3066\u3044\u306a\u3044\u3088\u3046\u3067\u3059\u3002\n\n\u7279\u5fb4\n\n\u901f\u3044\n\u8efd\u3044\n\u63a5\u7d9a\u3092\u7dad\u6301\u3067\u304d\u308b\n\u30d0\u30c3\u30af\u30a8\u30f3\u30c9\u306e\u30ad\u30e3\u30c3\u30b7\u30e5\u30b5\u30fc\u30d0\u3078\u306e\u63a5\u7d9a\u6570\u3092\u4f4e\u304f\u4fdd\u3064\n\u30ea\u30af\u30a8\u30b9\u30c8\u3068\u30ec\u30b9\u30dd\u30f3\u30b9\u306e\u30d1\u30a4\u30d7\u304c\u3067\u304d\u308b\n\u8907\u6570\u30b5\u30fc\u30d0\u3078\u306e\u30d7\u30ed\u30ad\u30b7\u304c\u3067\u304d\u308b\n\u8907\u6570\u306e\u30b5\u30fc\u30d0\u30fb\u30d7\u30fc\u30eb\u3092\u540c\u6642\u306b\u6301\u3066\u308b\n\u8907\u6570\u30b5\u30fc\u30d0\u9593\u3067\u306e\u30b7\u30e3\u30fc\u30c7\u30a3\u30f3\u30b0\u3092\u81ea\u52d5\u3067\u3067\u304d\u308b\nmemcached (ascii) \u3068redis \u306e\u30d7\u30ed\u30c8\u30b3\u30eb\u306b\u5b8c\u5168\u5bfe\u5fdc\n\u30b5\u30fc\u30d0\u30fb\u30d7\u30fc\u30eb\u306e\u8a2d\u5b9a\u3092 YAML \u3067\u7c21\u5358\u306b\u3067\u304d\u308b\nconsistent hashing \u3068 distribution \u3092\u542b\u3080\u8907\u6570\u306e\u30cf\u30c3\u30b7\u30f3\u30b0\u30a2\u30eb\u30b4\u30ea\u30ba\u30e0\u306b\u5bfe\u5fdc\n\u6b7b\u3093\u3060\u30ce\u30fc\u30c9\u3092\u7121\u52b9\u5316\u3067\u304d\u308b\nstats \u304c\u5c02\u7528\u306e\u30dd\u30fc\u30c8\u304b\u3089\u53d6\u5f97\u3067\u304d\u3066\u76e3\u8996\u3057\u3084\u3059\u3044\nLinux, *BSD, OS X and Solaris (SmartOS) OS \u3067\u52d5\u304f\n\n\n\u30bc\u30ed\u30fb\u30b3\u30d4\u30fc\u306b\u3064\u3044\u3066\nnutcracker \u306b\u304a\u3044\u3066\u3001\u6d41\u5165\u30ea\u30af\u30a8\u30b9\u30c8\u3068\u3001\u6d41\u51fa\u30ec\u30b9\u30dd\u30f3\u30b9\u306b\u5bfe\u3059\u308b\u30e1\u30e2\u30ea\u306f\u5168\u3066\u3001mbuf \u5185\u306b\u30a2\u30ed\u30b1\u30fc\u30c8\u3055\u308c\u308b\u3002\nmbuf\u00a0\u306f zero-copy \u3092\u6709\u52b9\u306b\u3059\u308b\u3002\u306a\u305c\u306a\u3089\u3001\u540c\u3058\u30d0\u30c3\u30d5\u30a1\uff08\u305d\u306e\u4e0a\u3067\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u304b\u3089\u306e\u30ea\u30af\u30a8\u30b9\u30c8\u304c\u53d7\u4fe1\u3055\u308c\u308b\uff09\u306f\u305d\u306e\u30b5\u30fc\u30d0\u3078\u306e\u30d5\u30a9\u30ef\u30fc\u30c9\u306b\u3082\u4f7f\u308f\u308c\u308b\u305f\u3081\u3060\u3002\n\u3053\u308c\u3068\u8fd1\u3044\u5f62\u3067\u3001\u540c\u3058 mbuf \uff08\u305d\u306e\u4e0a\u3067\u30b5\u30fc\u30d0\u304b\u3089\u306e\u30ec\u30b9\u30dd\u30f3\u30b9\u304c\u53d7\u4fe1\u3055\u308c\u308b\uff09\u304c\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u3078\u306e\u30d5\u30a9\u30ef\u30fc\u30c9\u306b\u3082\u4f7f\u308f\u308c\u308b\u3002\n\u3055\u3089\u306b\u3001mbuf \u306b\u5272\u308a\u5f53\u3066\u3089\u308c\u305f\u30e1\u30e2\u30ea\u306f\u518d\u5229\u7528\u30d7\u30fc\u30eb\u3092\u4f7f\u3063\u3066\u7ba1\u7406\u3055\u308c\u308b\u3002\n\u3053\u308c\u304c\u610f\u5473\u3059\u308b\u3068\u3053\u308d\u306f\u3001\u4e00\u5ea6 mbuf \u304c\u30a2\u30ed\u30b1\u30fc\u30c8\u3055\u308c\u308b\u3068\u3001\u958b\u653e\u306f\u3055\u308c\u308c\u305a\u3001\u518d\u5229\u7528\u30d7\u30fc\u30eb\u306b\u623b\u3055\u308c\u308b\u3060\u3051\u3060\u3068\u3044\u3046\u3053\u3068\u3060\u3002\n\u30c7\u30d5\u30a9\u30eb\u30c8\u3067\u3001\u5404 mbuf \u306e\u30c1\u30e3\u30f3\u30af\u306f 16KB \u306b\u30bb\u30c3\u30c8\u3055\u308c\u308b\u3002\n\u3053\u308c\u306f mbuf \u306e\u30b5\u30a4\u30ba\u3068\u3001nutcracker \u306e\u5bfe\u51e6\u53ef\u80fd\u306a\u540c\u6642\u63a5\u7d9a\u6570\u306e\u3001\u30c8\u30ec\u30fc\u30c9\u30aa\u30d5\u3067\u3042\u308b\u3002\n\u5927\u304d\u306a mbuf \u306f\u8aad\u307f\u8fbc\u307f\u306e\u30b7\u30b9\u30c6\u30e0\u30b3\u30fc\u30eb\uff08nutcracker \u304c\u30ea\u30af\u30a8\u30b9\u30c8\u3084\u30ec\u30b9\u30dd\u30f3\u30b9\u3092\u8aad\u307f\u8fbc\u3080\u6642\u306e\u3082\u306e\uff09\u306e\u56de\u6570\u3092\u6e1b\u3089\u3059\u3053\u3068\u304c\u3067\u304d\u308b\u3002\n\u3057\u304b\u3057\u3001\u5927\u304d\u306a mbuf \u306f\u5168\u3066\u306e\u30a2\u30af\u30c6\u30a4\u30d6\u306a\u63a5\u7d9a\u306b\u5bfe\u3057\u3066 16KB \u4ee5\u4e0a\u306e\u30e1\u30e2\u30ea\u6d88\u8cbb\u3092\u3059\u308b\u305f\u3081\u3001nutcracker \u304c\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u304b\u3089\u5927\u91cf\u306e\u540c\u6642\u63a5\u7d9a\u3092\u53d7\u3051\u305f\u6642\u306b\u554f\u984c\u306b\u306a\u308b\u3060\u308d\u3046\u3002\nnutcracker \u306b\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u304b\u3089\u306e\u5927\u91cf\u540c\u6642\u63a5\u7d9a\u3092\u634c\u304b\u305b\u308b\u3068\u304d\u306f\u3001\u30c1\u30e3\u30f3\u30af\u30b5\u30a4\u30ba\u3092 512B \u306e\u3088\u3046\u306a\u5c0f\u3055\u306a\u5024\u3092\u3001-m\u307e\u305f\u306f-mbuf-size=N\u5f15\u6570\u3067\u8a2d\u5b9a\u3059\u308b\u3068\u3088\u3044\u3060\u308d\u3046\u3002\n\n\u3069\u3093\u306a\u8a2d\u5b9a\u304c\u3067\u304d\u308b\u306e\u304b\n\n\n\n\n        \u9805\u76ee\n      \n\n        \u8a2d\u5b9a\u5024\n      \n\n        \u610f\u5473\n      \n\n\n\n\n\n        listen\n\n        \\d+\n\n        \u30b5\u30fc\u30d0\u30d7\u30fc\u30eb\u306b\u5bfe\u3057\u3066 listen \u3059\u308b\u30a2\u30c9\u30ec\u30b9\u3068\u30dd\u30fc\u30c8\n\n\n\n        hash\n\n        *   one_at_a_time\n        *   md5\n        *   crc16\n        *   crc32\n        *   crc32a\n        *   fnv1_64\n        *   fnv1a_64\n        *   fnv1_32\n        *   fnv1a_32\n        *   hsieh\n        *   murmur\n        *   jenkins\n      \n\n        \u30cf\u30c3\u30b7\u30e5\u95a2\u6570\n        \u4f55\u306e\u30cf\u30c3\u30b7\u30e5\u5024\u3092\u8a08\u7b97\u3059\u308b\u306e\u306b\u4f7f\u3046\u306e\u3060\u308d\u3046\uff1f\u00a0\n\n\n\n        hash_tag\n\n        .. (regexp)\n\n        \u30cf\u30c3\u30b7\u30e5\u30bf\u30b0\u306e\u6307\u5b9a\u306b\u4f7f\u3046\n        \u30cf\u30c3\u30b7\u30e5\u30bf\u30b0\u306e\u9805\u76ee\u3092\u53c2\u7167\u00a0\n      \n\n\n\n        distribution\n\n        *   ketama\n        *   modula\n        *   random\n      \n\n        \u30ad\u30fc\u5206\u6563\u306e\u65b9\u6cd5\u3092\u6307\u5b9a\n\n\n\n        timeout\n\n        \\d+\n\n        \u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u3092 msec \u3067\u6307\u5b9a\u3059\u308b\n        \u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u306e\u9805\u76ee\u3092\u53c2\u7167\u00a0\n\n\n\n        backlog\n\n        \\d+\n\n        TCP\u306e\u30d0\u30c3\u30af\u30ed\u30b0\u306e\u5f15\u6570\n        \u30c7\u30d5\u30a9\u30eb\u30c8\u306f512\u00a0\n\n\n\n        preconnect\n\n        (true|false)\n\n        \u30d7\u30fc\u30eb\u4e2d\u306e\u5168\u30b5\u30fc\u30d0\u306b\u3001\u30d7\u30ed\u30bb\u30b9\u958b\u59cb\u524d\u306b\u7e4b\u304e\u306b\u3044\u304f\u304b\u3069\u3046\u304b\n        \u30c7\u30d5\u30a9\u30eb\u30c8\u306f false\u00a0\n\n\n\n        redis\n\n        (true|false)\n\n        \u30b5\u30fc\u30d0\u30d7\u30fc\u30eb\u304c redis \u304b memcached \u304b\u3092\u6307\u5b9a\u3059\u308b\u3068\u3053\u308d\n\n\n\n        redis_auth\n\n        \u00a0\n\n        redis \u306e\u8a8d\u8a3c\u60c5\u5831\n\n\n\n        server_connections\n\n        \u00a0\n\n        \u5404\u30b5\u30fc\u30d0\u306b\u5bfe\u3059\u308b\u6700\u5927\u540c\u6642\u63a5\u7d9a\u6570\n        \u30c7\u30d5\u30a9\u30eb\u30c8\u30671\n        server_connections: > 1 \u306e\u9805\u76ee\u3082\u53c2\u7167\u00a0\n\n\n\n        auto_eject_hosts\n\n        (true|false)\n\n        \u9023\u7d9a\u3057\u3066 server_failuer_limit \u306e\u56de\u6570\u5931\u6557\u3057\u305f\u6642\u306b\u3001\u4e00\u6642\u7684\u306a\u30b5\u30fc\u30d0\u5207\u308a\u96e2\u3057\u3092\u3059\u308b\u304b\u3069\u3046\u304b\n        Liveness \u306e\u9805\u76ee\u3082\u53c2\u7167\n\n\n\n        server_retry_timeout\n\n        \\d+\n\n        \u4e00\u6642\u7684\u306b\u5207\u308a\u96e2\u3055\u308c\u305f\u30b5\u30fc\u30d0\u306b\u5bfe\u3057\u3001\u3069\u306e\u304f\u3089\u3044\u306e\u6642\u9593\u518d\u63a5\u7d9a\u3092\u5f85\u3064\u304b msec \u3067\u6307\u5b9a\u3059\u308b\n        \u30c7\u30d5\u30a9\u30eb\u30c8\u306f 30000 msec\u00a0\n\n\n\n        server_failuer_limit\n\n        \\d+\n\n        \u30b5\u30fc\u30d0\u3078\u306e\u30ea\u30af\u30a8\u30b9\u30c8\u304c\u4f55\u56de\u9023\u7d9a\u3057\u3066\u5931\u6557\u3057\u305f\u3089\u4e00\u6642\u7684\u306a\u5207\u308a\u96e2\u3057\u3092\u3059\u308b\u304b\n        \u30c7\u30d5\u30a9\u30eb\u30c8\u306f 2\u00a0\n\n\n\n        servers\n\n        \u00a0\n\n        \u30b5\u30fc\u30d0\u30d7\u30fc\u30eb\u306b\u5bfe\u3059\u308b\u30b5\u30fc\u30d0\u30a2\u30c9\u30ec\u30b9\u3001\u30dd\u30fc\u30c8\u3001\u91cd\u307f\u306e\u30ea\u30b9\u30c8\n\n\n\n\n\u30d1\u30a4\u30d7\u30e9\u30a4\u30f3\nnutcracker \u306f\u8907\u6570\u306e\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u306e\u63a5\u7d9a\u3092\u3001\u6570\u53f0\u306e\u30b5\u30fc\u30d0\u63a5\u7d9a\u306b\u30d7\u30ed\u30ad\u30b7\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u308b\u3002\n\u3053\u306e\u69cb\u9020\u306f\u3001\u30e9\u30a6\u30f3\u30c9\u30c8\u30ea\u30c3\u30d7\u30bf\u30a4\u30e0\u3092\u6291\u3048\u308b\u76ee\u7684\u3067\u30ea\u30af\u30a8\u30b9\u30c8\u3084\u30ec\u30b9\u30dd\u30f3\u30b9\u3092\u30d1\u30a4\u30d7\u3059\u308b\u306e\u306b\u7406\u60f3\u7684\u3067\u3042\u308b\u3002\n\u4f8b\u3048\u3070 nutcracker \u304c3\u3064\u306e\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u304b\u3089\u306e\u63a5\u7d9a\u30921\u3064\u306e\u30b5\u30fc\u30d0\u306b\u5bfe\u3057\u3066\u30d7\u30ed\u30ad\u30b7\u3057\u3066\u304a\u308a\n\nget key\\r\\n\\\nset key 0 0 3\\r\\nval\\r\\n\ndelete key\\r\\n\n\n\u3068\u3044\u3046\u30ea\u30af\u30a8\u30b9\u30c8\u30923\u3064\u306e\u63a5\u7d9a\u304b\u3089\u305d\u308c\u305e\u308c\u53d7\u3051\u53d6\u3063\u305f\u5834\u5408\u3092\u8003\u3048\u308b\uff08\u3053\u308c\u306f redis \u3067\u306f\u306a\u304f memcached \u3092\u60f3\u5b9a\u3057\u305f\u30ea\u30af\u30a8\u30b9\u30c8\u5f62\u5f0f\u3067\u3042\u308b\uff09\u3002\nnutcracker \u306f\u3053\u306e\u6642\u3001\u3053\u308c\u3089\u306e\u30ea\u30af\u30a8\u30b9\u30c8\u3092\u9806\u6b21\u5b9f\u884c\u3055\u308c\u308b\u3088\u3046\u30011\u3064\u306e\u30e1\u30c3\u30bb\u30fc\u30b8get key\\r\\nset key 0 0 3\\r\\nval\\r\\ndelete key\\r\\n\u306b\u307e\u3068\u3081\u3066\u30b5\u30fc\u30d0\u3078\u9001\u4fe1\u3059\u308b\u3002\n\u30d1\u30a4\u30d7\u30e9\u30a4\u30f3\u306b\u3088\u3063\u3066 nutcracker \u306f\u30b9\u30eb\u30fc\u30d7\u30c3\u30c8\u3092\u5411\u4e0a\u3055\u305b\u3001\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u30fb\u30b5\u30fc\u30d0\u9593\u306e extra hop (\u8a33\u305b\u306a\u304b\u3063\u305f) \u3092\u3082\u305f\u3089\u3059\u3002\n\n\u30c7\u30d7\u30ed\u30a4\nnutcracker \u3092\u672c\u756a\u74b0\u5883\u306b\u30c7\u30d7\u30ed\u30a4\u3059\u308b\u306e\u3067\u3042\u308c\u3070\u3001https://github.com/twitter/twemproxy/blob/master/notes/recommendation.md \u3092\u8aad\u307f\u3001\u30c1\u30e5\u30fc\u30cb\u30f3\u30b0\u53ef\u80fd\u306a\u30d1\u30e9\u30e1\u30fc\u30bf\u306b\u3064\u3044\u3066\u7406\u89e3\u3057\u3001\u672c\u756a\u74b0\u5883\u4e0a\u3067\u52b9\u7387\u7684\u306b\u52d5\u4f5c\u3055\u305b\u308b\u3079\u304d\u3060\u3002\n\nrecommendation.md\nhttps://github.com/twitter/twemproxy/blob/master/notes/recommendation.md \u3092\u8a33\u3059\u30b3\u30fc\u30ca\u30fc\u3002\n\n\u30ed\u30b0\u30ec\u30d9\u30eb\n\u30c7\u30d5\u30a9\u30eb\u30c8\u3067\u306f\u3001\u30c7\u30d0\u30c3\u30b0\u30fb\u30ed\u30b0\u306f\u7121\u52b9\u306b\u306a\u3063\u3066\u3044\u308b\u3002\u3057\u304b\u3057\u3001nutcracker \u3092\u30c7\u30d0\u30c3\u30b0\u30fb\u30ed\u30b0\u3092\u6709\u52b9\u306b\u3057\u3066\u904b\u7528\u3059\u308b\u3053\u3068\u306f\u6709\u7528\u3067\u3042\u308a\u3001\u30ed\u30b0\u306e\u5197\u9577\u5ea6 (verbosity) \u306fLOG_INFO\u306b\u30bb\u30c3\u30c8\u3059\u308b\u3053\u3068\u3067\u6709\u52b9\u306b\u306a\u308b-v 6\u307e\u305f\u306f--verbose=6\u306e\u3088\u3046\u306b) \u3002\n\u3053\u308c\u306f\u5b9f\u969b\u306f\u3042\u307e\u308a\u5927\u304d\u306a\u30aa\u30fc\u30d0\u30fc\u30d8\u30c3\u30c9\u306b\u306a\u306a\u3089\u306a\u3044\u3002\u30ed\u30b0\u51fa\u529b\u306e\u969b\u3001i \u306e\u6761\u4ef6\u5206\u5c90\u306e\u30b3\u30b9\u30c8\u304c\u304b\u304b\u308b\u3088\u3046\u306b\u306a\u308b\u3060\u3051\u3060\u3002\nLOG_INFO\u306e\u30ec\u30d9\u30eb\u306b\u304a\u3044\u3066\u3001nutcracker \u306e\u30ed\u30b0\u306f\u5404\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u3068\u30b5\u30fc\u30d0\u306e\u63a5\u7d9a\u306e\u30e9\u30a4\u30d5\u30b5\u30a4\u30af\u30eb\u3068\u3001\u91cd\u8981\u306a\u30a4\u30d9\u30f3\u30c8\uff08\u30b5\u30fc\u30d0\u304c hash ring \u304b\u3089\u5916\u308c\u305f\u7b49\uff09\u3067\u51fa\u529b\u3055\u308c\u308b\u3002\n\u30ed\u30b0\u306e\u4f8b\u306f\u4ee5\u4e0b\u3002\n[Thu Aug  2 00:03:09 2012] nc_proxy.c:336 accepted c 7 on p 6 from '127.0.0.1:54009'\n[Thu Aug  2 00:03:09 2012] nc_server.c:528 connected on s 8 to server '127.0.0.1:11211:1'\n[Thu Aug  2 00:03:09 2012] nc_core.c:270 req 1 on s 8 timedout\n[Thu Aug  2 00:03:09 2012] nc_core.c:207 close s 8 '127.0.0.1:11211' on event 0004 eof 0 done 0 rb 0 sb 20: Connection timed out\n[Thu Aug  2 00:03:09 2012] nc_server.c:406 close s 8 schedule error for req 1 len 20 type 5 from c 7: Connection timed out\n[Thu Aug  2 00:03:09 2012] nc_server.c:281 update pool 0 'alpha' to delete server '127.0.0.1:11211:1' for next 2 secs\n[Thu Aug  2 00:03:10 2012] nc_connection.c:314 recv on sd 7 eof rb 20 sb 35\n[Thu Aug  2 00:03:10 2012] nc_request.c:334 c 7 is done\n[Thu Aug  2 00:03:10 2012] nc_core.c:207 close c 7 '127.0.0.1:54009' on event 0001 eof 1 done 1 rb 20 sb 35\n[Thu Aug  2 00:03:11 2012] nc_proxy.c:336 accepted c 7 on p 6 from '127.0.0.1:54011'\n[Thu Aug  2 00:03:11 2012] nc_server.c:528 connected on s 8 to server '127.0.0.1:11212:1'\n[Thu Aug  2 00:03:12 2012] nc_connection.c:314 recv on sd 7 eof rb 20 sb 8\n[Thu Aug  2 00:03:12 2012] nc_request.c:334 c 7 is done\n[Thu Aug  2 00:03:12 2012] nc_core.c:207 close c 7 '127.0.0.1:54011' on event 0001 eof 1 done 1 rb 20 sb 8\n\n\u30c7\u30d0\u30c3\u30b0\u30fb\u30ed\u30b0\u3092\u6709\u52b9\u306b\u3059\u308b\u306b\u306f\u3001nutcracker \u3092\u30b3\u30f3\u30d1\u30a4\u30eb\u3059\u308b\u6642\u306b--enable-debug=log\u3092configure\u306e\u30aa\u30d7\u30b7\u30e7\u30f3\u3067\u6307\u5b9a\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u3002\n\n\u53ef\u7528\u6027 (Liveness \u3092\u3053\u3046\u8a33\u3057\u3066\u307f\u305f)\n\u5931\u6557\u306f\u4eba\u751f\u306b\u3064\u304d\u3082\u306e\u3060\u3002\u7279\u306b\u3001\u7269\u4e8b\u304c\u62e1\u6563\u3055\u308c\u308b\u6642\u306b\u306f\u3002\n\u969c\u5bb3\u304b\u3089\u5fa9\u65e7\u3055\u305b\u308b\u6642\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u5404\u30b5\u30fc\u30d0\u306b\u8a2d\u5b9a\u3092\u3059\u308b\u3053\u3068\u3092\u63a8\u5968\u3059\u308b\u3002\nresilient_pool:\n  auto_eject_hosts: true\n  server_retry_timeout: 30000\n  server_failure_limit: 3\n\nauto_eject_hosts\u3092\u6709\u52b9\u306b\u3059\u308b\u3068\u6b7b\u3093\u3060\u30b5\u30fc\u30d0\u3092hash ring \u304b\u3089\u5207\u308a\u96e2\u305b\u308b\u3053\u3068\u3092\u4fdd\u8a3c\u3057\u3001server_failure_limit\u306f consecutive failures have been encountered on that said server \uff08\u8a33\u305b\u306a\u304b\u3063\u305f\u2026\uff09\u3002\nserver_retry_timeout\u304c 0 \u3067\u306a\u3044\u5834\u5408\u3001\u4e0d\u6b63\u306b\u30b5\u30fc\u30d0\u3092\u300c\u6c38\u9060\u306b\u6b7b\u3093\u3060\u300d\u3082\u306e\u3068\u3057\u3066\u30de\u30fc\u30ad\u30f3\u30b0\u3059\u308b\u3053\u3068\u304c\u306a\u3044\u3088\u3046\u4fdd\u8a3c\u3059\u308b\u3002\u7279\u306b\u3001\u77ac\u9593\u7684\u306a\u969c\u5bb3\u306e\u5834\u5408\u306b\u3060\u3002\nserver_retry_timeout\u3068serverfailuer_limit\u306e\u7d44\u307f\u5408\u308f\u305b\u306b\u3088\u308b\u5236\u5fa1\u306f\u3001\u6052\u4e45\u7684\u306a\u5fa9\u65e7\u3068\u3001\u77ac\u9593\u7684\u306a\u969c\u5bb3\u306e\u9593\u3067\u306e\u30c8\u30ec\u30fc\u30c9\u30aa\u30d5\u3068\u306a\u308b\u3002\n\u5207\u308a\u96e2\u3055\u308c\u305f\u30b5\u30fc\u30d0\u306f\u3001retry timeout\u304c\u7d4c\u904e\u3059\u308b\u307e\u3067\u306f\u3001\u3069\u3093\u306a\u30ea\u30af\u30a8\u30b9\u30c8\u306b\u5bfe\u3057\u3066\u3082 hash ring \u306b\u542b\u307e\u308c\u308b\u3053\u3068\u304c\u306a\u304f\u306a\u308b\u3002\n\u3053\u308c\u306f This will lead to data partitioning as keys originally on the ejected server will now be written to a server still in the pool \uff08\u8a33\u305b\u306a\u304b\u3063\u305f\u2026\uff09\u3002\n\u30b5\u30fc\u30d0\u5207\u308a\u96e2\u3057\u306b\u76f4\u9762\u3057\u305f\u969b\u306b\u30ea\u30af\u30a8\u30b9\u30c8\u304c\u5e38\u306b\u6210\u529f\u3059\u308b\u3053\u3068\u3092\u4fdd\u8a3c\u3059\u308b\u306b\u306f (auto_eject_hosts\u304c\u6709\u52b9\u306a\u5834\u5408\uff09\u3001nutcracker \u81ea\u4f53\u304c\u30ea\u30af\u30a8\u30b9\u30c8\u306e\u30ea\u30c8\u30e9\u30a4\u3092\u3057\u306a\u3044\u3082\u306e\u306e\u3001\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u5c64\u3067\u30ea\u30c8\u30e9\u30a4\u306e\u4ed5\u7d44\u307f\u304c\u5b9f\u88c5\u3055\u308c\u3066\u3044\u308b\u5fc5\u8981\u304c\u3042\u308b\u3002\n\u3053\u306e\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u5074\u306e\u30ea\u30c8\u30e9\u30a4\u6570\u306fserver_failuer_limit\u306e\u5024\u3088\u308a\u3082\u5927\u304d\u3044\u5fc5\u8981\u304c\u3042\u308a\u3001\u305d\u308c\u304c\u30aa\u30ea\u30b8\u30ca\u30eb\u306e\u30ea\u30af\u30a8\u30b9\u30c8\u304c\u751f\u5b58\u3057\u3066\u3044\u308b\u30b5\u30fc\u30d0\u306b\u63a5\u7d9a\u3055\u308c\u308b\u53ef\u80fd\u6027\u3092\u4fdd\u8a3c\u3059\u308b\u3002\n\n\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\ntimeout\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u8abf\u6574\u3059\u308b\u306e\u306f\u3001nutcracker \u306b\u304a\u3044\u3066\u6b63\u7fa9\u3060\u3002\u305d\u308c\u306f\u3069\u3093\u306a\u30b5\u30fc\u30d0\u30fb\u30d7\u30fc\u30eb\u306b\u5bfe\u3057\u3066\u3082\u3067\u3042\u3063\u3066\u3001\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u5074\u306e\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u3092\u4fe1\u7528\u3057\u3066\u3057\u307e\u3046\u3088\u308a\u3082\u3044\u3044\u3053\u3068\u3060\u3002\n\u8a2d\u5b9a\u4f8b\u306f\u4ee5\u4e0b\u3002\nresilient_pool_with_timeout:\n  auto_eject_hosts: true\n  server_retry_timeout: 30000\n  server_failure_limit: 3\n  timeout: 400\n\n\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u5074\u306e\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u3060\u3051\u3092\u4fe1\u7528\u3059\u308b\u3053\u3068\u306f\u3001\u30aa\u30ea\u30b8\u30ca\u30eb\u306a\u30ea\u30af\u30a8\u30b9\u30c8\u304c\u30af\u30e9\u30a4\u30a2\u30f3\u30c8~\u30d7\u30ed\u30ad\u30b7\u9593\u63a5\u7d9a\u3067\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u3057\u5834\u5408\u306b\u3001\u4e0d\u5229\u306a\u5f71\u97ff\u304c\u3042\u308b\u3002\n\u30d7\u30ed\u30ad\u30b7~\u30b5\u30fc\u30d0\u9593\u306e\u63a5\u7d9a\u306e\u554f\u984c\u306f\u4f9d\u7136\u3068\u3057\u3066\u8d77\u304d\u305f\u307e\u307e\u3068\u306a\u308b\u3002\n\u3053\u306e\u3053\u3068\u306f\u3001\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u304c\u30aa\u30ea\u30b8\u30ca\u30eb\u306e\u30ea\u30af\u30a8\u30b9\u30c8\u3092\u30ea\u30c8\u30e9\u30a4\u3059\u308b\u3068\u3055\u3089\u306b\u60aa\u5316\u3059\u308b\u3002\n\u30c7\u30d5\u30a9\u30eb\u30c8\u3067 nutcracker \u306f\u3001\u30b5\u30fc\u30d0\u3078\u9001\u3089\u308c\u308b\u3069\u3093\u306a\u30ea\u30af\u30a8\u30b9\u30c8\u306b\u5bfe\u3057\u3066\u3082\u3001\u6c38\u9060\u306b\u5f85\u3064\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u308b\u3002\n\u3057\u304b\u3057\u306a\u304c\u3089timeout\u30d1\u30e9\u30e1\u30fc\u30bf\u304c\u8a2d\u5b9a\u3055\u308c\u308b\u3068\u3001\u30b5\u30fc\u30d0\u304b\u3089\u306e\u30ec\u30b9\u30dd\u30f3\u30b9\u304c\u306a\u3044\u30ea\u30af\u30a8\u30b9\u30c8\u306f\u3001\u305d\u306e\u30d1\u30e9\u30e1\u30fc\u30bf\u3067\u8a2d\u5b9a\u3057\u305f\u6642\u9593 (\u5358\u4f4d\u306f msec\uff09\u3067\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u3057\u3001\u30a8\u30e9\u30fc\u30ec\u30b9\u30dd\u30f3\u30b9SERVER_ERROR timed out \\r\\n\u304c\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u306b\u8fd4\u3055\u308c\u308b\u3088\u3046\u306b\u306a\u308b\u3002\n\n\u30a8\u30e9\u30fc\u30fb\u30ec\u30b9\u30dd\u30f3\u30b9\n\u30b5\u30fc\u30d0\u969c\u5bb3\u6642\u306e\u30ea\u30af\u30a8\u30b9\u30c8\u3067\u306f\u5fc5\u305a\u3001\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u306b-ERR <errno description>\u3068\u3044\u3046\u30ec\u30b9\u30dd\u30f3\u30b9\u3092\u751f\u6210\u3057\u3066\u8fd4\u3059\uff08redis\u306e\u5834\u5408\u306e\u5f62\u5f0f\uff09\u3002\n-ERR\u3084SERVER_ERROR(\u3053\u3061\u3089\u306f memcached \u306e\u5834\u5408) \u3068\u3044\u3046\u30ec\u30b9\u30dd\u30f3\u30b9\u3092\u30c1\u30a7\u30c3\u30af\u3059\u308b\u3053\u3068\u3067\u3001\u77ac\u9593\u7684\u306a\u969c\u5bb3\u304c\u8d77\u304d\u305f\u5834\u5408\u306b\u3001\u30aa\u30ea\u30b8\u30ca\u30eb\u30fb\u30ea\u30af\u30a8\u30b9\u30c8\u3092\u3059\u308b\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u306f\u30ea\u30c8\u30e9\u30a4\u3092\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u308b\u3002\n\nread, writev and mbuf\n\uff08\u2191\u306e\u65b9\u306b\u66f8\u3044\u305f \u30bc\u30ed\u30fb\u30b3\u30d4\u30fc \u306e\u8a71\u3068\u540c\u3058\u3063\u307d\u3044\u306e\u3067\u8aad\u307f\u98db\u3070\u3057\u305f\uff09\n\nmbuf-size=N \u306e\u5f15\u6570\u306f\u3069\u3046\u8003\u3048\u305f\u3089\u3088\u3044\uff1f\n\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u304b\u3089\u306e\u63a5\u7d9a\u306f\u5168\u3066\u3001\u5c11\u306a\u304f\u3068\u30821\u3064\u306e mbuf \u3092\u6d88\u8cbb\u3059\u308b\u3002\n1\u3064\u306e\u30ea\u30af\u30a8\u30b9\u30c8\u306e\u53d7\u4ed8\u306b\u30012\u3064\u306e\u30b3\u30cd\u30af\u30b7\u30e7\u30f3\u3092\u5fc5\u8981\u3068\u3059\u308b\u30021\u3064\u306f\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u304b\u3089\u30d7\u30ed\u30ad\u30b7\u3001\u3082\u30461\u3064\u306f\u30d7\u30ed\u30ad\u30b7\u304b\u3089\u30b5\u30fc\u30d0\u3060\u3002\n\u65ad\u7247\u5316\u3059\u308b\u30ea\u30af\u30a8\u30b9\u30c8\u3001\u4f8b\u3048\u3070get foo bar\\r\\n\u306e\u3088\u3046\u306a\u3001\u306fget foo\\r\\n\u3068get bar \\r\\n\u306b\u65ad\u7247\u5316\u3057\u30012\u3064\u306e mbuf \u3092\u30ea\u30af\u30a8\u30b9\u30c8\u306b\u3001\u3055\u3089\u306b2\u3064\u306e mbuf \u3092\u30ec\u30b9\u30dd\u30f3\u30b9\u306b\u6d88\u8cbb\u3059\u308b\u3002\n\u3088\u3063\u3066N\u500b\u306b\u65ad\u7247\u5316\u3059\u308b\u30ea\u30af\u30a8\u30b9\u30c8\u306f 2N \u306e mbuf \u3092\u5fc5\u8981\u3068\u3059\u308b\u3002\nmbuf \u306b\u3064\u3044\u3066\u306f\u3001\u826f\u3044\u8a00\u3044\u65b9\u3092\u3059\u308c\u3070\u30e1\u30e2\u30ea\u306f\u518d\u5229\u7528\u30d7\u30fc\u30eb\u304b\u3089\u4e0e\u3048\u3089\u308c\u308b\u3002\u4e00\u5ea6 mbuf \u304c\u30a2\u30ed\u30b1\u30fc\u30c8\u3055\u308c\u308b\u3068\u3001\u4e8c\u5ea6\u3068\u958b\u653e\u3055\u308c\u308b\u3053\u3068\u306f\u306a\u304f\u3001\u518d\u5229\u7528\u30d7\u30fc\u30eb\u306b\u623b\u3055\u308c\u308b\u3002\n\u60aa\u3044\u8a00\u3044\u65b9\u3092\u3059\u308c\u3070\u3001\u4e00\u5ea6 mbuf \u304c\u30a2\u30ed\u30b1\u30fc\u30c8\u3055\u308c\u305f\u3089\u4e8c\u5ea6\u3068\u958b\u653e\u3055\u308c\u305a\u3001\u958b\u653e\u3055\u308c\u305f mbuf \u306f\u518d\u5229\u7528\u30d7\u30fc\u30eb\u306b\u5fc5\u305a\u623b\u3055\u308c\u3066\u3057\u307e\u3046\u3002\n\u3053\u308c\u306f\u3057\u304b\u3057\u306a\u304c\u3089\u3001\u518d\u5229\u7528\u30d7\u30fc\u30eb\u306e\u95be\u5024\u306e\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u4e0e\u3048\u308b\u3053\u3068\u3067\u3001\u7c21\u5358\u306b\u4fee\u6b63\u3067\u304d\u308b\u3002\n\u3088\u3063\u3066\u3082\u3057 nutcracker \u304c1000\u53f0\u306e\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u304b\u3089\u306e\u63a5\u7d9a\u3068\u3001100\u53f0\u306e\u30b5\u30fc\u30d0\u3078\u306e\u63a5\u7d9a\u3092\u6271\u3063\u3066\u3044\u308b\u306e\u3067\u3042\u308c\u3070\u3001\u6700\u5927\u3067 (max(1000, 100) * 2 * mbuf-size) \u5206\u306e\u30e1\u30e2\u30ea\u3092 mbuf \u306b\u6d88\u8cbb\u3059\u308b\u3002\n\u3082\u3057\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u304c\u30d1\u30a4\u30d7\u3055\u308c\u3066\u3044\u306a\u3044\u30ea\u30af\u30a8\u30b9\u30c8\u3092\u9001\u3063\u3066\u304d\u305f\u3068\u3059\u308b\u3068\u3001\u30c7\u30d5\u30a9\u30eb\u30c8\u306e mbuf-size \u3067\u3042\u308b 16K \u3067\u8a08\u7b97\u3057\u3066\u3001\u5408\u8a08\u3067 32M \u3092\u6d88\u8cbb\u3059\u308b\u3053\u3068\u306b\u306a\u308b\u3002\n\u3082\u3063\u3068\u8a00\u3046\u3068\u3001\u3082\u3057\u5e73\u5747\u3067\u5404\u30ea\u30af\u30a8\u30b9\u30c8\u304c10\u306e\u30d5\u30e9\u30b0\u30e1\u30f3\u30c8\uff08\u65ad\u7247\uff09\u304b\u3089\u6210\u3063\u3066\u3044\u308b\u3068\u3059\u308b\u3068\u3001\u30e1\u30e2\u30ea\u306e\u6d88\u8cbb\u306f 320M \u306b\u3082\u306a\u308b\u3002\n\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u63a5\u7d9a\u304c1000\u3067\u306f\u306a\u304f10000\u3060\u3063\u305f\u3089\u3001\u30e1\u30e2\u30ea\u6d88\u8cbb\u306f3.2G\u306b\u3082\u306a\u308b\u3060\u308d\u3046\u3002\nmbuf-size \u3092\u30c7\u30d5\u30a9\u30eb\u30c8\u306e16K\u3067\u306f\u306a\u304f 512bytes \u3068\u3059\u308c\u3070\u3001\u540c\u3058\u30b7\u30ca\u30ea\u30aa\u306e\u5834\u5408\u3067\u3082 10M \u7a0b\u5ea6\u307e\u3067\u30e1\u30e2\u30ea\u6d88\u8cbb\u91cf\u306f\u843d\u3061\u308b\u3002\n\u3053\u308c\u304c\u3001\u5927\u91cf\u306e\u30b3\u30cd\u30af\u30b7\u30e7\u30f3\u3084\u3001multi-get \u306e\u3088\u3046\u306a\u5e45\u5e83\u3044\u30ea\u30af\u30a8\u30b9\u30c8\u306b\u5bfe\u3057\u3066\u3001\u5c0f\u3055\u306a 512 \u306e\u3088\u3046\u306a\u5c0f\u3055\u306a mbuf-size \u3092\u5272\u308a\u5f53\u3066\u308b\u3079\u304d\u7406\u7531\u3067\u3042\u308b\u3002\n\n\u6700\u5927\u30ad\u30fc\u9577\nmemcached \u306e ascii \u30d7\u30ed\u30c8\u30b3\u30eb\u306e\u4ed5\u69d8\u3067\u306f\u3001\u30ad\u30fc\u306f\u6700\u5927\u3067250\u6587\u5b57\u3068\u306a\u3063\u3066\u3044\u308b\u3002\n\u30ad\u30fc\u306f\u7a7a\u767d\u3084\\r\u3001\\n\u3068\u3044\u3063\u305f\u6587\u5b57\u3082\u542b\u3092\u542b\u307e\u306a\u3044\u3002\nredis \u306b\u5bfe\u3057\u3066\u306f\u3001\u3053\u3046\u3057\u305f\u5236\u9650\u306f\u306a\u3044\u3002\n\u3057\u304b\u3057\u306a\u304c\u3089\u3001 nutcracker \u3067\u306f\u30e1\u30e2\u30ea\u306e\u96a3\u308a\u5408\u3063\u305f\u9818\u57df\u306b\u30ad\u30fc\u304c\u683c\u7d0d\u3055\u308c\u308b\u3002\nnutracker \u3067\u306f\u5168\u3066\u306e\u30ea\u30af\u30a8\u30b9\u30c8\u3068\u30ec\u30b9\u30dd\u30f3\u30b9\u304c mbuf \u306b\u683c\u7d0d\u3055\u308c\u308b\u305f\u3081\u3001redis \u306e\u30ad\u30fc\u9577\u306f mbuf \u5185\u3067\u30c7\u30fc\u30bf\u304c\u5c02\u6709\u53ef\u80fd\u306a\u6700\u5927\u30b5\u30a4\u30ba\u3067\u5236\u9650\u3055\u308c\u308b\uff08mbuf_data_size()\uff09\u3002\n\u3053\u308c\u306f\u3001\u3082\u3057 redis \u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u304c\u304a\u304a\u304d\u306a\u30ad\u30fc\u3092\u6271\u3046\u5834\u5408\u3001\u305d\u308c\u306b\u898b\u5408\u3046\u5927\u304d\u306a mbuf \u30b5\u30a4\u30ba\u3092-m\u307e\u305f\u306f--mbuf-size=N\u3067\u30b3\u30de\u30f3\u30c9\u30e9\u30a4\u30f3\u5f15\u6570\u3068\u3057\u3066\u6307\u5b9a\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u3002\n\nConsistent Hashing \u306e\u305f\u3081\u306e\u30ce\u30fc\u30c9\u540d\ntwemproxy \u306b\u304a\u3051\u308b\u30b5\u30fc\u30d0\u30fb\u30af\u30e9\u30b9\u30bf\u306f\u3001\u4ee5\u4e0b\u306e\u3069\u3061\u3089\u306e\u6587\u5b57\u5217\u30ea\u30b9\u30c8\u5f62\u5f0f\u3067\u3082\u8a18\u8ff0\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u308b\u3002\n\n  host:port:weight\n  host:port:weight name\n\n\u5177\u4f53\u7684\u306b\u306f\nservers:\n - 127.0.0.1:6379:1\n - 127.0.0.1:6380:1\n - 127.0.0.1:6381:1\n - 127.0.0.1:6382:1\n\n\u307e\u305f\u306f\nservers:\n - 127.0.0.1:6379:1 server1\n - 127.0.0.1:6380:1 server2\n - 127.0.0.1:6381:1 server3\n - 127.0.0.1:6382:1 server4\n\n\u524d\u8005\u306e\u8a2d\u5b9a\u3067\u306f\u3001\u30ad\u30fc\u306f\u76f4\u63a5 host:port:weight \u306e3\u3064\u7d44\u306b\u30de\u30c3\u30d4\u30f3\u30b0\u3055\u308c\u3001\u5f8c\u8005\u3067\u3067\u306f\u30ce\u30fc\u30c9\u540d\uff08\u3053\u306e\u6b21\u306b host:port \u306e\u7d44\u306b\u30de\u30c3\u30d4\u30f3\u30b0\u3055\u308c\u308b\uff09\u306b\u30de\u30c3\u30d4\u30f3\u30b0\u3055\u308c\u308b\u3002\n\u5f8c\u8005\u306e\u8a2d\u5b9a\u3067\u306f\u3001\u3053\u3068\u306a\u308b\u30b5\u30fc\u30d0\u306b\u30ce\u30fc\u30c9\u3092\u518d\u5272\u308a\u5f53\u3066\u3059\u308b\u3053\u3068\u304c\u81ea\u7531\u3067\u3042\u308a\u3001\u305d\u308c\u3092hash ring \u306e\u914d\u5e03\u306a\u3057\u306b\u884c\u3048\u308b\u3002\n\u305d\u308c\u3086\u3048\u3001auto_eject_hosts(\u30b5\u30fc\u30d0\u306e\u81ea\u52d5\u5207\u308a\u96e2\u3057\u306e\u3053\u3068\u3068\u601d\u308f\u308c\uff09\u3092\u7121\u52b9\u306b\u3057\u3066\u3044\u308b\u5834\u5408\u306f\u3001\u3053\u306e\u8a2d\u5b9a\u304c\u7406\u60f3\u7684\u3067\u3042\u308b\u3002\n\u8a73\u7d30\u306f https://github.com/twitter/twemproxy/issues/25 \u3092\u53c2\u7167\u3002\n\u3061\u306a\u307f\u306b\u3001\u30ce\u30fc\u30c9\u540d\u3092 consistent hashing \u3067\u4f7f\u3046\u6642\u306f\u3001twemproxy \u306f weight \u306e\u5024\u3092\u7121\u8996\u3059\u308b\u306e\u3067\u6c17\u3092\u3064\u3051\u3089\u308c\u305f\u3057\u3002\n\n\u30cf\u30c3\u30b7\u30e5\u30bf\u30b0\n\u30cf\u30c3\u30b7\u30e5\u30bf\u30b0 http://oldblog.antirez.com/post/redis-presharding.html \u306f\u3001\u30ad\u30fc\u306e\u4e00\u90e8\u3092\u4f7f\u3063\u3066\u30cf\u30c3\u30b7\u30e5\u5024\u3092\u8a08\u7b97\u3059\u308b\u306e\u306b\u4f7f\u308f\u308c\u308b\u3002\n\u30cf\u30c3\u30b7\u30e5\u30bf\u30b0\u304c\u5b58\u5728\u3057\u3066\u3044\u308b\u5834\u5408\u3001\u30bf\u30b0\u5185\u306b\u3042\u308b\u30ad\u30fc\u306e\u4e00\u90e8\u3092\u3001consitent hashing \u306e\u30ad\u30fc\u3068\u3057\u3066\u4f7f\u3046\u3002\n\u305d\u3046\u3067\u306a\u3044\u5834\u5408\u3001\u30ad\u30fc\u5168\u4f53\u3092\u540c\u3058\u7528\u9014\u3068\u3057\u3066\u7528\u3044\u308b\u3053\u3068\u306b\u306a\u308b\u3002\n\u30cf\u30c3\u30b7\u30e5\u30bf\u30b0\u306f\u3001\u30bf\u30b0\u5185\u306e\u30ad\u30fc\u304c\u540c\u3058\u9650\u308a\u306b\u304a\u3044\u3066\u3001\u7570\u306a\u308b\u30ad\u30fc\u3092\u540c\u3058\u30b5\u30fc\u30d0\u306b\u5272\u308a\u5f53\u3066\u308b\u3053\u3068\u3092\u53ef\u80fd\u306b\u3059\u308b \u3002\n\u4f8b\u3048\u3070\u3001\u30b5\u30fc\u30d0\u30fb\u30d7\u30fc\u30eb beta \u306e\u8a2d\u5b9a\u304c\u4ee5\u4e0b\u3067\u3042\u308b\u6642\u3001hash_tag \u306f2\u3064\u306e\u6587\u5b57 \"{}\" \u3067\u6307\u5b9a\u3055\u308c\u3066\u3044\u308b\u3002\n\u3053\u308c\u306f\u3001\u30ad\u30fcuser:{user1}:ids\u3068user:{user1}:tweets\u304c\u540c\u3058\u30b5\u30fc\u30d0\u306b\u30de\u30c3\u30d4\u30f3\u30b0\u3055\u308c\u308b\u3053\u3068\u306b\u306a\u308b\u3002\u306a\u305c\u306a\u3089\u3001\u30cf\u30c3\u30b7\u30e5\u5024\u306fuser1\u306b\u5bfe\u3057\u3066\u8a08\u7b97\u3055\u308c\u308b\u3053\u3068\u306b\u306a\u308b\u304b\u3089\u3060\u3002\n\u4e00\u65b9\u3067\u4f8b\u3048\u3070user:user1:ids\u306e\u3088\u3046\u306a\u30ad\u30fc\u3067\u3042\u308c\u3070\u3001\u3053\u306e\u6587\u5b57\u5217\u5168\u4f53\u3067\u30cf\u30c3\u30b7\u30e5\u5024\u3092\u8a08\u7b97\u3059\u308b\u3053\u3068\u306b\u306a\u308b\u3002\nbeta:\n  listen: 127.0.0.1:22122\n  hash: fnv1a_64\n  hash_tag: \"{}\"\n  distribution: ketama\n  auto_eject_hosts: false\n  timeout: 400\n  redis: true\n  servers:\n   - 127.0.0.1:6380:1 server1\n   - 127.0.0.1:6381:1 server2\n   - 127.0.0.1:6382:1 server3\n   - 127.0.0.1:6383:1 server4\n\n\n\u30ad\u30e3\u30c3\u30b7\u30e5\u30fb\u30d7\u30fc\u30eb\u306e\u72b6\u614b\u3092\u53ef\u8996\u5316\nnutcracker \u3092\u672c\u756a\u74b0\u5883\u3067\u904b\u7528\u3057\u3066\u3044\u308b\u6642\u3001\u751f\u304d\u3066\u3044\u308b\u30ce\u30fc\u30c9\u3068\u3001\u5207\u308a\u96e2\u3055\u308c\u305f\u30ce\u30fc\u30c9\u3092\u77e5\u308a\u305f\u304f\u306a\u308b\u3060\u308d\u3046\u3002\n\u3053\u306e\u554f\u3078\u306e\u7b54\u3048\u306f\u7c21\u5358\u3067\u3001\u751f\u304d\u3066\u3044\u308b\uff0f\u6b7b\u3093\u3067\u3044\u308b\u30b5\u30fc\u30d0\uff08\u4efb\u610f\u306e\u30ad\u30e3\u30c3\u30b7\u30e5\u30d7\u30fc\u30eb\u306e\u4e00\u90e8\uff09\u3092\u6642\u7cfb\u5217\u306e\u30b0\u30e9\u30d5\u3068\u3057\u3066\u751f\u6210\u3059\u308c\u3070\u3088\u3044\u3002\n\u3053\u308c\u3092\u3059\u308b\u305f\u3081\u306b\u306f\u3001\u30b0\u30e9\u30d5\u5316\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u304c\u4ee5\u4e0b\u306e\u60c5\u5831\u3092 nutcracker \u306e stats \u304b\u3089\u53d6\u5f97\u3059\u308b\u3002\n\n  server_eof: \u30b5\u30fc\u30d0\u306e\u63a5\u7d9a\u304c\u666e\u901a\u306b\u5207\u3089\u308c\u305f\u6570\u3002\u6c38\u7d9a\u7684\u306a\u63a5\u7d9a\u3092\u3057\u3066\u3044\u308b\u306e\u3067\u3001\u3053\u308c\u304c\u5897\u3048\u305f\u3089\u304a\u304b\u3057\u3044\n  server_timedout: \u30b5\u30fc\u30d0\u5074\u306e\u63a5\u7d9a\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u6570\u3002\u3053\u308c\u304c\u5897\u3048\u305f\u3089\u30e4\u30c0\n  server_err: \u305d\u306e\u4ed6\u3001\u30b5\u30fc\u30d0\u5074\u306e\u30a8\u30e9\u30fc\u6570\u3002\u3053\u308c\u304c\u5897\u3048\u305f\u3089\u30e4\u30c0\n\n\u3088\u3063\u3066\u3001\u4e0e\u3048\u3089\u308c\u305f\u30b5\u30fc\u30d0\u306b\u304a\u3044\u3066\u3001\u5207\u308a\u96e2\u3055\u308c\u305f\u6570\u306e\u7d2f\u7a4d\u306f\u4ee5\u4e0b\u3067\u8a08\u7b97\u3055\u308c\u308b\u3002\n(server_err + server_timedout + sever_eof) / server_failure_limit\n\n\u3048\u30fc\u3068\u3001\u4ee5\u4e0b\u3001\u8a33\u3059\u306e\u30c0\u30eb\u304f\u306a\u3063\u305f\u306e\u3067\u305d\u306e\u307e\u307e\u66f8\u304f\nA diff of the above value between two successive time intervals would generate a nice timeseries graph for ejected servers.\nYou can also graph the timestamp at which any given server was ejected by graphing server_ejected_at stat.\n\nserver_connections: > 1\ntwemproxy \u306f\u3001\u3044\u304f\u3064\u304b\u306e\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u540c\u6642\u63a5\u7d9a\u3068\u3001\u5c11\u306a\u3044\u30b5\u30fc\u30d0\u63a5\u7d9a\u304c\u3042\u308b\u3088\u3046\u306a\u72b6\u6cc1\u3092\u60f3\u5b9a\u3057\u3066\u3044\u308b\u3002\n\u91cd\u8981\u306a\u3053\u3068\u3068\u3057\u3066\u3001\u300cread my last write (\u4ffa\u306e\u6700\u5f8c\u306e\u66f8\u304d\u8fbc\u307f\u3092\u8aad\u3081\uff09\u300d\u3068\u3044\u3046\u5236\u7d04\u304c\u5fc5\u305a\u3057\u3082\u6210\u7acb\u3057\u306a\u3044\u5834\u5408\u304c\u3042\u308b\u3002\n\u305d\u308c\u306f twemproxy \u306b \u3068\u3044\u3046\u8a2d\u5b9a\u304c\u3055\u308c\u3066\u3044\u308b\u5834\u5408\u3067\u3042\u308b\u3002\nserver_connections: > 1\n\n\u3053\u308c\u3092\u8aac\u660e\u3059\u308b\u306b\u3042\u305f\u308a\u3001twemproxy \u304cserver_connections: 2\u3068\u8a2d\u5b9a\u3055\u308c\u3066\u3044\u308b\u72b6\u6cc1\u3092\u8003\u3048\u308b\u3002\n\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u304c\u30d1\u30a4\u30d7\u3055\u308c\u305f\u30ea\u30af\u30a8\u30b9\u30c8\u3092\u751f\u6210\u3057\u3001\u6700\u521d\u306e\u30ea\u30af\u30a8\u30b9\u30c8\u304c\u30d1\u30a4\u30d7\u30e9\u30a4\u30f3\u4e2d\u3067set foo 0 0 3 \\r\\nbar\\r\\n\uff08\u66f8\u304d\u8fbc\u307f\uff09\u3067\u3042\u308a\u30012\u3064\u76ee\u306e\u30ea\u30af\u30a8\u30b9\u30c8\u304cget foo \\r\\n\uff08\u8aad\u307f\u8fbc\u307f\uff09\u3067\u3042\u308b\u5834\u5408\u3001\u671f\u5f85\u3055\u308c\u308b foo \u306b\u5bfe\u3059\u308b\u5024\u306f bar \u3067\u3042\u308b\u3002\n\u3057\u304b\u3057\u306a\u304c\u3089\u30012\u3064\u306e\u30b5\u30fc\u30d0\u63a5\u7d9a\u306e\u8a2d\u5b9a\u304c\u3055\u308c\u3066\u3044\u308b\u3068\u3001write \u3068 read \u304c\u5225\u306e\u30b5\u30fc\u30d0\u306b\u9001\u3089\u308c\u308b\u53ef\u80fd\u6027\u304c\u3042\u308a\u3001\u671f\u5f85\u3059\u308b\u30ec\u30b9\u30dd\u30f3\u30b9\u304c\u8fd4\u3089\u306a\u3044\u3053\u3068\u304c\u3042\u308b\u3002\n\u8981\u7d04\u3059\u308b\u3068\u3001\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u304c\u300cread my last write\u300d\u306e\u5236\u7d04\u3092\u671f\u5f85\u3057\u3066\u3044\u308b\u5834\u5408\u306f\u3001server_connections: 1\u3092\u8a2d\u5b9a\u3059\u308b\u304b\u3001\u307e\u305f\u306f twemproxy \u306b\u5bfe\u3057\u3066\u540c\u671f\u7684\u306a\u30ea\u30af\u30a8\u30b9\u30c8\u3092\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u3002\n# \u3053\u306e\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u306b\u3064\u3044\u3066\n\ntwemproxy (nutcracker) \u304c\u4e00\u4f53\u4f55\u8005\u3067\u3042\u308a\u3001\u307e\u305f\u3001\u904b\u7528\u306b\u3042\u305f\u308a\u7406\u89e3\u304c\u5fc5\u8981\u3067\u3042\u308d\u3046\u7b87\u6240\u306b\u3064\u3044\u3066\u3001\u672c\u5bb6\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u3092*\u96d1\u306b*\u610f\u8a33\u3057\u305f\u3082\u306e\u3067\u3059\u3002\n\n\u4ed5\u4e8b\u4e0a\u306e\u30e1\u30e2\u3068\u3057\u3066\u4f5c\u6210\u3057\u305f\u306e\u3092\u305d\u306e\u307e\u307e\u516c\u958b\u3059\u308b\u306e\u3067\u65e5\u672c\u8a9e\u304c\u6b8b\u5ff5\u306a\u3068\u3053\u308d\u3082\u6b63\u76f4\u591a\u3005\u3042\u308b\u306e\u3067\u3059\u304c\u3001\u3053\u308c\u3092\u5b8c\u6210\u3055\u305b\u308b\u307e\u3067\u7720\u3089\u305b\u3066\u304a\u304f\u3088\u308a\u306f(\u3044\u3064\u306b\u306a\u308b\u3053\u3068\u3084\u3089)\u3055\u3063\u3055\u3068\u516c\u958b\u3057\u3066\u3001\u4eca twemproxy \u306e\u5c0e\u5165\u3092\u691c\u8a0e\u3057\u3066\u3044\u308b\u65b9\u3084\u3001\u904b\u7528\u3055\u308c\u3066\u3044\u308b\u65b9\u306e\u4f55\u304b\u3057\u3089\u306e\u529b\u306b\u306a\u308c\u3070\u3068\u601d\u3063\u3066\u3044\u307e\u3059\u3002\n\n\u7c97\u3044\u5185\u5bb9\u3067\u3059\u306e\u3067\u3001\u4f55\u304b\u3054\u3056\u3044\u307e\u3057\u305f\u3089\u7de8\u96c6\u30ea\u30af\u30a8\u30b9\u30c8\u3092\u9802\u3051\u308b\u3068\u5e78\u3044\u3067\u3059\u3002\n\n\n# README.md\n\n[https://github.com/twitter/twemproxy/blob/master/README.md](https://github.com/twitter/twemproxy/blob/master/README.md) \u306e\u3046\u3061 twemproxy \u306e\u7279\u6027\u306b\u3064\u3044\u3066\u7406\u89e3\u3057\u3066\u304a\u3044\u305f\u65b9\u304c\u3044\u3044\u3068\u3053\u308d\u3092\u304b\u3044\u3064\u307e\u3093\u3067\u8a33\u3057\u305f\u308a\u3059\u308b\u30b3\u30fc\u30ca\u30fc\u3002\n\n## twemproxy \u6982\u8981\n\ntwemproxy (\"two-em-proxy\" \u3068\u767a\u97f3) \u306f nutcracker \u3068\u3082\u547c\u3070\u308c\u308b\u3001\u9ad8\u901f\u3067\u8efd\u91cf\u306a\u3001memcached\u3001redis \u30d7\u30ed\u30c8\u30b3\u30eb\u306e\u30d7\u30ed\u30ad\u30b7\u3067\u3042\u308b\u3002\n\u6700\u5927\u306e\u76ee\u7684\u306f\u3001\u30d0\u30c3\u30af\u30a8\u30f3\u30c9\u306e\u30ad\u30e3\u30c3\u30b7\u30e5\u30b5\u30fc\u30d0\u306e\u63a5\u7d9a\u6570\u3092\u6e1b\u3089\u3059\u3053\u3068\u3067\u3042\u308b\u3002\n\u307e\u305f\u3001\u305d\u308c\u3068\u540c\u6642\u306b\u30d1\u30a4\u30d7\u30e9\u30a4\u30f3\u3084\u30b7\u30e3\u30fc\u30c7\u30a3\u30f3\u30b0\u3082\u5229\u7528\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u308b\u305f\u3081\u3001\u6c34\u5e73\u5206\u6563\u306b\u3088\u308b\u30b9\u30b1\u30fc\u30e9\u30d6\u30eb\u306a\u30ad\u30e3\u30c3\u30b7\u30e5\u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3\u306e\u5b9f\u73fe\u304c\u3067\u304d\u308b\u3002\n\n\n### \u203b\u8a33\u8005\u30b3\u30e1\u30f3\u30c8\n\n\u4e0a\u8a18 README.md \u306e\u5192\u982d\u306e\u5185\u5bb9\u306a\u306e\u3067\u3059\u304c\u3001\u8a2d\u8a08\u4e0a\u91cd\u8981\u306a\u60c5\u5831\u304c\u542b\u307e\u308c\u3066\u3044\u308b\u306e\u3067\u30b3\u30e1\u30f3\u30c8\u3092\u631f\u307e\u305b\u3066\u9802\u304d\u307e\u3059\u3002\n\ntwemproxy \u306f\u300c\u30b7\u30e3\u30fc\u30c7\u30a3\u30f3\u30b0\u306b\u3088\u308b\u5bb9\u91cf\u306e\u30b9\u30b1\u30fc\u30eb\u30a2\u30a6\u30c8\u300d\u3092\u76ee\u7684\u3068\u3057\u3066\u304a\u3089\u305a\u3001\u3042\u304f\u307e\u3067\u30ad\u30e3\u30c3\u30b7\u30e5\u30b5\u30fc\u30d0\u306b\u5bfe\u3059\u308b\u5927\u91cf\u30a2\u30af\u30bb\u30b9\u306b\u3069\u3046\u5bfe\u51e6\u3059\u308b\u304b\u3068\u3044\u3046\u3068\u3053\u308d\u306b\u30d5\u30a9\u30fc\u30ab\u30b9\u3057\u3066\u4f5c\u3089\u308c\u305f\u3082\u306e\u3068\u306a\u3063\u3066\u3044\u307e\u3059\u3002\n\u305d\u308c\u3086\u3048\u304b\u3001\u30ea\u30b7\u30e3\u30fc\u30c7\u30a3\u30f3\u30b0\u306e\u6a5f\u80fd\u306f\u6301\u3063\u3066\u304a\u3089\u305a\u3001\u307e\u305f\u3001redis \u304c\u6c38\u7d9a\u5316\u30c7\u30fc\u30bf\u3092\u6271\u3046\u3088\u3046\u306a\u30b7\u30fc\u30f3\u3082\u60f3\u5b9a\u3055\u308c\u3066\u3044\u306a\u3044\u3088\u3046\u3067\u3059\u3002\n## \u7279\u5fb4\n\n* \u901f\u3044\n* \u8efd\u3044\n* \u63a5\u7d9a\u3092\u7dad\u6301\u3067\u304d\u308b\n* \u30d0\u30c3\u30af\u30a8\u30f3\u30c9\u306e\u30ad\u30e3\u30c3\u30b7\u30e5\u30b5\u30fc\u30d0\u3078\u306e\u63a5\u7d9a\u6570\u3092\u4f4e\u304f\u4fdd\u3064\n* \u30ea\u30af\u30a8\u30b9\u30c8\u3068\u30ec\u30b9\u30dd\u30f3\u30b9\u306e\u30d1\u30a4\u30d7\u304c\u3067\u304d\u308b\n* \u8907\u6570\u30b5\u30fc\u30d0\u3078\u306e\u30d7\u30ed\u30ad\u30b7\u304c\u3067\u304d\u308b\n* \u8907\u6570\u306e\u30b5\u30fc\u30d0\u30fb\u30d7\u30fc\u30eb\u3092\u540c\u6642\u306b\u6301\u3066\u308b\n* \u8907\u6570\u30b5\u30fc\u30d0\u9593\u3067\u306e\u30b7\u30e3\u30fc\u30c7\u30a3\u30f3\u30b0\u3092\u81ea\u52d5\u3067\u3067\u304d\u308b\n* memcached (ascii) \u3068redis \u306e\u30d7\u30ed\u30c8\u30b3\u30eb\u306b\u5b8c\u5168\u5bfe\u5fdc\n* \u30b5\u30fc\u30d0\u30fb\u30d7\u30fc\u30eb\u306e\u8a2d\u5b9a\u3092 YAML \u3067\u7c21\u5358\u306b\u3067\u304d\u308b\n* consistent hashing \u3068 distribution \u3092\u542b\u3080\u8907\u6570\u306e\u30cf\u30c3\u30b7\u30f3\u30b0\u30a2\u30eb\u30b4\u30ea\u30ba\u30e0\u306b\u5bfe\u5fdc\n* \u6b7b\u3093\u3060\u30ce\u30fc\u30c9\u3092\u7121\u52b9\u5316\u3067\u304d\u308b\n* stats \u304c\u5c02\u7528\u306e\u30dd\u30fc\u30c8\u304b\u3089\u53d6\u5f97\u3067\u304d\u3066\u76e3\u8996\u3057\u3084\u3059\u3044\n* Linux, *BSD, OS X and Solaris (SmartOS) OS \u3067\u52d5\u304f\n\n\n## \u30bc\u30ed\u30fb\u30b3\u30d4\u30fc\u306b\u3064\u3044\u3066\n\nnutcracker \u306b\u304a\u3044\u3066\u3001\u6d41\u5165\u30ea\u30af\u30a8\u30b9\u30c8\u3068\u3001\u6d41\u51fa\u30ec\u30b9\u30dd\u30f3\u30b9\u306b\u5bfe\u3059\u308b\u30e1\u30e2\u30ea\u306f\u5168\u3066\u3001[mbuf](http://www.wdic.org/w/TECH/mbuf) \u5185\u306b\u30a2\u30ed\u30b1\u30fc\u30c8\u3055\u308c\u308b\u3002\n[mbuf](http://www.wdic.org/w/TECH/mbuf)&nbsp;\u306f zero-copy \u3092\u6709\u52b9\u306b\u3059\u308b\u3002\u306a\u305c\u306a\u3089\u3001\u540c\u3058\u30d0\u30c3\u30d5\u30a1\uff08\u305d\u306e\u4e0a\u3067\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u304b\u3089\u306e\u30ea\u30af\u30a8\u30b9\u30c8\u304c\u53d7\u4fe1\u3055\u308c\u308b\uff09\u306f\u305d\u306e\u30b5\u30fc\u30d0\u3078\u306e\u30d5\u30a9\u30ef\u30fc\u30c9\u306b\u3082\u4f7f\u308f\u308c\u308b\u305f\u3081\u3060\u3002\n\u3053\u308c\u3068\u8fd1\u3044\u5f62\u3067\u3001\u540c\u3058 [mbuf](http://www.wdic.org/w/TECH/mbuf) \uff08\u305d\u306e\u4e0a\u3067\u30b5\u30fc\u30d0\u304b\u3089\u306e\u30ec\u30b9\u30dd\u30f3\u30b9\u304c\u53d7\u4fe1\u3055\u308c\u308b\uff09\u304c\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u3078\u306e\u30d5\u30a9\u30ef\u30fc\u30c9\u306b\u3082\u4f7f\u308f\u308c\u308b\u3002\n\n\u3055\u3089\u306b\u3001mbuf \u306b\u5272\u308a\u5f53\u3066\u3089\u308c\u305f\u30e1\u30e2\u30ea\u306f\u518d\u5229\u7528\u30d7\u30fc\u30eb\u3092\u4f7f\u3063\u3066\u7ba1\u7406\u3055\u308c\u308b\u3002\n\u3053\u308c\u304c\u610f\u5473\u3059\u308b\u3068\u3053\u308d\u306f\u3001\u4e00\u5ea6 mbuf \u304c\u30a2\u30ed\u30b1\u30fc\u30c8\u3055\u308c\u308b\u3068\u3001\u958b\u653e\u306f\u3055\u308c\u308c\u305a\u3001\u518d\u5229\u7528\u30d7\u30fc\u30eb\u306b\u623b\u3055\u308c\u308b\u3060\u3051\u3060\u3068\u3044\u3046\u3053\u3068\u3060\u3002\n\u30c7\u30d5\u30a9\u30eb\u30c8\u3067\u3001\u5404 mbuf \u306e\u30c1\u30e3\u30f3\u30af\u306f 16KB \u306b\u30bb\u30c3\u30c8\u3055\u308c\u308b\u3002\n\u3053\u308c\u306f mbuf \u306e\u30b5\u30a4\u30ba\u3068\u3001nutcracker \u306e\u5bfe\u51e6\u53ef\u80fd\u306a\u540c\u6642\u63a5\u7d9a\u6570\u306e\u3001\u30c8\u30ec\u30fc\u30c9\u30aa\u30d5\u3067\u3042\u308b\u3002\n\u5927\u304d\u306a mbuf \u306f\u8aad\u307f\u8fbc\u307f\u306e\u30b7\u30b9\u30c6\u30e0\u30b3\u30fc\u30eb\uff08nutcracker \u304c\u30ea\u30af\u30a8\u30b9\u30c8\u3084\u30ec\u30b9\u30dd\u30f3\u30b9\u3092\u8aad\u307f\u8fbc\u3080\u6642\u306e\u3082\u306e\uff09\u306e\u56de\u6570\u3092\u6e1b\u3089\u3059\u3053\u3068\u304c\u3067\u304d\u308b\u3002\n\u3057\u304b\u3057\u3001\u5927\u304d\u306a mbuf \u306f\u5168\u3066\u306e\u30a2\u30af\u30c6\u30a4\u30d6\u306a\u63a5\u7d9a\u306b\u5bfe\u3057\u3066 16KB \u4ee5\u4e0a\u306e\u30e1\u30e2\u30ea\u6d88\u8cbb\u3092\u3059\u308b\u305f\u3081\u3001nutcracker \u304c\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u304b\u3089\u5927\u91cf\u306e\u540c\u6642\u63a5\u7d9a\u3092\u53d7\u3051\u305f\u6642\u306b\u554f\u984c\u306b\u306a\u308b\u3060\u308d\u3046\u3002\nnutcracker \u306b\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u304b\u3089\u306e\u5927\u91cf\u540c\u6642\u63a5\u7d9a\u3092\u634c\u304b\u305b\u308b\u3068\u304d\u306f\u3001\u30c1\u30e3\u30f3\u30af\u30b5\u30a4\u30ba\u3092 512B \u306e\u3088\u3046\u306a\u5c0f\u3055\u306a\u5024\u3092\u3001`-m`\u307e\u305f\u306f`-mbuf-size=N`\u5f15\u6570\u3067\u8a2d\u5b9a\u3059\u308b\u3068\u3088\u3044\u3060\u308d\u3046\u3002\n\n## \u3069\u3093\u306a\u8a2d\u5b9a\u304c\u3067\u304d\u308b\u306e\u304b\n\n<table>\n  <thead>\n    <tr>\n      <th>\n        \u9805\u76ee\n      </th>\n      <th>\n        \u8a2d\u5b9a\u5024\n      </th>\n      <th>\n        \u610f\u5473\n      </th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <td>\n        listen</td>\n      <td>\n        \\d+</td>\n      <td>\n        \u30b5\u30fc\u30d0\u30d7\u30fc\u30eb\u306b\u5bfe\u3057\u3066 listen \u3059\u308b\u30a2\u30c9\u30ec\u30b9\u3068\u30dd\u30fc\u30c8</td>\n    </tr>\n    <tr>\n      <td>\n        hash</td>\n      <td>\n        *   one_at_a_time\n        *   md5\n        *   crc16\n        *   crc32\n        *   crc32a\n        *   fnv1_64\n        *   fnv1a_64\n        *   fnv1_32\n        *   fnv1a_32\n        *   hsieh\n        *   murmur\n        *   jenkins\n      </td>\n      <td>\n        \u30cf\u30c3\u30b7\u30e5\u95a2\u6570\n        \u4f55\u306e\u30cf\u30c3\u30b7\u30e5\u5024\u3092\u8a08\u7b97\u3059\u308b\u306e\u306b\u4f7f\u3046\u306e\u3060\u308d\u3046\uff1f&nbsp;</td>\n    </tr>\n    <tr>\n      <td>\n        hash_tag</td>\n      <td>\n        .. (regexp)</td>\n      <td>\n        \u30cf\u30c3\u30b7\u30e5\u30bf\u30b0\u306e\u6307\u5b9a\u306b\u4f7f\u3046\n        \u30cf\u30c3\u30b7\u30e5\u30bf\u30b0\u306e\u9805\u76ee\u3092\u53c2\u7167&nbsp;\n      </td>\n    </tr>\n    <tr>\n      <td>\n        distribution</td>\n      <td>\n        *   ketama\n        *   modula\n        *   random\n      </td>\n      <td>\n        \u30ad\u30fc\u5206\u6563\u306e\u65b9\u6cd5\u3092\u6307\u5b9a</td>\n    </tr>\n    <tr>\n      <td>\n        timeout</td>\n      <td>\n        \\d+</td>\n      <td>\n        \u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u3092 msec \u3067\u6307\u5b9a\u3059\u308b\n        \u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u306e\u9805\u76ee\u3092\u53c2\u7167&nbsp;</td>\n    </tr>\n    <tr>\n      <td>\n        backlog</td>\n      <td>\n        \\d+</td>\n      <td>\n        TCP\u306e\u30d0\u30c3\u30af\u30ed\u30b0\u306e\u5f15\u6570\n        \u30c7\u30d5\u30a9\u30eb\u30c8\u306f512&nbsp;</td>\n    </tr>\n    <tr>\n      <td>\n        preconnect</td>\n      <td>\n        (true|false)</td>\n      <td>\n        \u30d7\u30fc\u30eb\u4e2d\u306e\u5168\u30b5\u30fc\u30d0\u306b\u3001\u30d7\u30ed\u30bb\u30b9\u958b\u59cb\u524d\u306b\u7e4b\u304e\u306b\u3044\u304f\u304b\u3069\u3046\u304b\n        \u30c7\u30d5\u30a9\u30eb\u30c8\u306f false&nbsp;</td>\n    </tr>\n    <tr>\n      <td>\n        redis</td>\n      <td>\n        (true|false)</td>\n      <td>\n        \u30b5\u30fc\u30d0\u30d7\u30fc\u30eb\u304c redis \u304b memcached \u304b\u3092\u6307\u5b9a\u3059\u308b\u3068\u3053\u308d</td>\n    </tr>\n    <tr>\n      <td>\n        redis_auth</td>\n      <td>\n        &nbsp;</td>\n      <td>\n        redis \u306e\u8a8d\u8a3c\u60c5\u5831</td>\n    </tr>\n    <tr>\n      <td>\n        server_connections</td>\n      <td>\n        &nbsp;</td>\n      <td>\n        \u5404\u30b5\u30fc\u30d0\u306b\u5bfe\u3059\u308b\u6700\u5927\u540c\u6642\u63a5\u7d9a\u6570\n        \u30c7\u30d5\u30a9\u30eb\u30c8\u30671\n        server_connections: &gt; 1 \u306e\u9805\u76ee\u3082\u53c2\u7167&nbsp;</td>\n    </tr>\n    <tr>\n      <td colspan=\"1\">\n        auto_eject_hosts</td>\n      <td colspan=\"1\">\n        (true|false)</td>\n      <td colspan=\"1\">\n        \u9023\u7d9a\u3057\u3066 server_failuer_limit \u306e\u56de\u6570\u5931\u6557\u3057\u305f\u6642\u306b\u3001\u4e00\u6642\u7684\u306a\u30b5\u30fc\u30d0\u5207\u308a\u96e2\u3057\u3092\u3059\u308b\u304b\u3069\u3046\u304b\n        Liveness \u306e\u9805\u76ee\u3082\u53c2\u7167</td>\n    </tr>\n    <tr>\n      <td colspan=\"1\">\n        server_retry_timeout</td>\n      <td colspan=\"1\">\n        \\d+</td>\n      <td colspan=\"1\">\n        \u4e00\u6642\u7684\u306b\u5207\u308a\u96e2\u3055\u308c\u305f\u30b5\u30fc\u30d0\u306b\u5bfe\u3057\u3001\u3069\u306e\u304f\u3089\u3044\u306e\u6642\u9593\u518d\u63a5\u7d9a\u3092\u5f85\u3064\u304b msec \u3067\u6307\u5b9a\u3059\u308b\n        \u30c7\u30d5\u30a9\u30eb\u30c8\u306f 30000 msec&nbsp;</td>\n    </tr>\n    <tr>\n      <td colspan=\"1\">\n        server_failuer_limit</td>\n      <td colspan=\"1\">\n        \\d+</td>\n      <td colspan=\"1\">\n        \u30b5\u30fc\u30d0\u3078\u306e\u30ea\u30af\u30a8\u30b9\u30c8\u304c\u4f55\u56de\u9023\u7d9a\u3057\u3066\u5931\u6557\u3057\u305f\u3089\u4e00\u6642\u7684\u306a\u5207\u308a\u96e2\u3057\u3092\u3059\u308b\u304b\n        \u30c7\u30d5\u30a9\u30eb\u30c8\u306f 2&nbsp;</td>\n    </tr>\n    <tr>\n      <td colspan=\"1\">\n        servers</td>\n      <td colspan=\"1\">\n        &nbsp;</td>\n      <td colspan=\"1\">\n        \u30b5\u30fc\u30d0\u30d7\u30fc\u30eb\u306b\u5bfe\u3059\u308b\u30b5\u30fc\u30d0\u30a2\u30c9\u30ec\u30b9\u3001\u30dd\u30fc\u30c8\u3001\u91cd\u307f\u306e\u30ea\u30b9\u30c8</td>\n    </tr>\n  </tbody>\n</table>\n\n## \u30d1\u30a4\u30d7\u30e9\u30a4\u30f3\n\nnutcracker \u306f\u8907\u6570\u306e\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u306e\u63a5\u7d9a\u3092\u3001\u6570\u53f0\u306e\u30b5\u30fc\u30d0\u63a5\u7d9a\u306b\u30d7\u30ed\u30ad\u30b7\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u308b\u3002\n\u3053\u306e\u69cb\u9020\u306f\u3001\u30e9\u30a6\u30f3\u30c9\u30c8\u30ea\u30c3\u30d7\u30bf\u30a4\u30e0\u3092\u6291\u3048\u308b\u76ee\u7684\u3067\u30ea\u30af\u30a8\u30b9\u30c8\u3084\u30ec\u30b9\u30dd\u30f3\u30b9\u3092\u30d1\u30a4\u30d7\u3059\u308b\u306e\u306b\u7406\u60f3\u7684\u3067\u3042\u308b\u3002\n\n\u4f8b\u3048\u3070 nutcracker \u304c3\u3064\u306e\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u304b\u3089\u306e\u63a5\u7d9a\u30921\u3064\u306e\u30b5\u30fc\u30d0\u306b\u5bfe\u3057\u3066\u30d7\u30ed\u30ad\u30b7\u3057\u3066\u304a\u308a\n\n* get key\\r\\n\\\n* set key 0 0 3\\r\\nval\\r\\n\n* delete key\\r\\n\n\n\u3068\u3044\u3046\u30ea\u30af\u30a8\u30b9\u30c8\u30923\u3064\u306e\u63a5\u7d9a\u304b\u3089\u305d\u308c\u305e\u308c\u53d7\u3051\u53d6\u3063\u305f\u5834\u5408\u3092\u8003\u3048\u308b\uff08\u3053\u308c\u306f redis \u3067\u306f\u306a\u304f memcached \u3092\u60f3\u5b9a\u3057\u305f\u30ea\u30af\u30a8\u30b9\u30c8\u5f62\u5f0f\u3067\u3042\u308b\uff09\u3002\nnutcracker \u306f\u3053\u306e\u6642\u3001\u3053\u308c\u3089\u306e\u30ea\u30af\u30a8\u30b9\u30c8\u3092\u9806\u6b21\u5b9f\u884c\u3055\u308c\u308b\u3088\u3046\u30011\u3064\u306e\u30e1\u30c3\u30bb\u30fc\u30b8`get key\\r\\nset key 0 0 3\\r\\nval\\r\\ndelete key\\r\\n`\u306b\u307e\u3068\u3081\u3066\u30b5\u30fc\u30d0\u3078\u9001\u4fe1\u3059\u308b\u3002\n\n\u30d1\u30a4\u30d7\u30e9\u30a4\u30f3\u306b\u3088\u3063\u3066 nutcracker \u306f\u30b9\u30eb\u30fc\u30d7\u30c3\u30c8\u3092\u5411\u4e0a\u3055\u305b\u3001\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u30fb\u30b5\u30fc\u30d0\u9593\u306e extra hop (\u8a33\u305b\u306a\u304b\u3063\u305f) \u3092\u3082\u305f\u3089\u3059\u3002\n\n## \u30c7\u30d7\u30ed\u30a4\n\nnutcracker \u3092\u672c\u756a\u74b0\u5883\u306b\u30c7\u30d7\u30ed\u30a4\u3059\u308b\u306e\u3067\u3042\u308c\u3070\u3001[https://github.com/twitter/twemproxy/blob/master/notes/recommendation.md](https://github.com/twitter/twemproxy/blob/master/notes/recommendation.md) \u3092\u8aad\u307f\u3001\u30c1\u30e5\u30fc\u30cb\u30f3\u30b0\u53ef\u80fd\u306a\u30d1\u30e9\u30e1\u30fc\u30bf\u306b\u3064\u3044\u3066\u7406\u89e3\u3057\u3001\u672c\u756a\u74b0\u5883\u4e0a\u3067\u52b9\u7387\u7684\u306b\u52d5\u4f5c\u3055\u305b\u308b\u3079\u304d\u3060\u3002\n\n# recommendation.md\n\n[https://github.com/twitter/twemproxy/blob/master/notes/recommendation.md](https://github.com/twitter/twemproxy/blob/master/notes/recommendation.md) \u3092\u8a33\u3059\u30b3\u30fc\u30ca\u30fc\u3002\n\n\n#### \u30ed\u30b0\u30ec\u30d9\u30eb\n\n\u30c7\u30d5\u30a9\u30eb\u30c8\u3067\u306f\u3001\u30c7\u30d0\u30c3\u30b0\u30fb\u30ed\u30b0\u306f\u7121\u52b9\u306b\u306a\u3063\u3066\u3044\u308b\u3002\u3057\u304b\u3057\u3001nutcracker \u3092\u30c7\u30d0\u30c3\u30b0\u30fb\u30ed\u30b0\u3092\u6709\u52b9\u306b\u3057\u3066\u904b\u7528\u3059\u308b\u3053\u3068\u306f\u6709\u7528\u3067\u3042\u308a\u3001\u30ed\u30b0\u306e\u5197\u9577\u5ea6 (verbosity) \u306f`LOG_INFO`\u306b\u30bb\u30c3\u30c8\u3059\u308b\u3053\u3068\u3067\u6709\u52b9\u306b\u306a\u308b`-v 6`\u307e\u305f\u306f`--verbose=6`\u306e\u3088\u3046\u306b) \u3002\n\u3053\u308c\u306f\u5b9f\u969b\u306f\u3042\u307e\u308a\u5927\u304d\u306a\u30aa\u30fc\u30d0\u30fc\u30d8\u30c3\u30c9\u306b\u306a\u306a\u3089\u306a\u3044\u3002\u30ed\u30b0\u51fa\u529b\u306e\u969b\u3001i \u306e\u6761\u4ef6\u5206\u5c90\u306e\u30b3\u30b9\u30c8\u304c\u304b\u304b\u308b\u3088\u3046\u306b\u306a\u308b\u3060\u3051\u3060\u3002\n\n`LOG_INFO`\u306e\u30ec\u30d9\u30eb\u306b\u304a\u3044\u3066\u3001nutcracker \u306e\u30ed\u30b0\u306f\u5404\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u3068\u30b5\u30fc\u30d0\u306e\u63a5\u7d9a\u306e\u30e9\u30a4\u30d5\u30b5\u30a4\u30af\u30eb\u3068\u3001\u91cd\u8981\u306a\u30a4\u30d9\u30f3\u30c8\uff08\u30b5\u30fc\u30d0\u304c hash ring \u304b\u3089\u5916\u308c\u305f\u7b49\uff09\u3067\u51fa\u529b\u3055\u308c\u308b\u3002\n\u30ed\u30b0\u306e\u4f8b\u306f\u4ee5\u4e0b\u3002\n\n```\n[Thu Aug  2 00:03:09 2012] nc_proxy.c:336 accepted c 7 on p 6 from '127.0.0.1:54009'\n[Thu Aug  2 00:03:09 2012] nc_server.c:528 connected on s 8 to server '127.0.0.1:11211:1'\n[Thu Aug  2 00:03:09 2012] nc_core.c:270 req 1 on s 8 timedout\n[Thu Aug  2 00:03:09 2012] nc_core.c:207 close s 8 '127.0.0.1:11211' on event 0004 eof 0 done 0 rb 0 sb 20: Connection timed out\n[Thu Aug  2 00:03:09 2012] nc_server.c:406 close s 8 schedule error for req 1 len 20 type 5 from c 7: Connection timed out\n[Thu Aug  2 00:03:09 2012] nc_server.c:281 update pool 0 'alpha' to delete server '127.0.0.1:11211:1' for next 2 secs\n[Thu Aug  2 00:03:10 2012] nc_connection.c:314 recv on sd 7 eof rb 20 sb 35\n[Thu Aug  2 00:03:10 2012] nc_request.c:334 c 7 is done\n[Thu Aug  2 00:03:10 2012] nc_core.c:207 close c 7 '127.0.0.1:54009' on event 0001 eof 1 done 1 rb 20 sb 35\n[Thu Aug  2 00:03:11 2012] nc_proxy.c:336 accepted c 7 on p 6 from '127.0.0.1:54011'\n[Thu Aug  2 00:03:11 2012] nc_server.c:528 connected on s 8 to server '127.0.0.1:11212:1'\n[Thu Aug  2 00:03:12 2012] nc_connection.c:314 recv on sd 7 eof rb 20 sb 8\n[Thu Aug  2 00:03:12 2012] nc_request.c:334 c 7 is done\n[Thu Aug  2 00:03:12 2012] nc_core.c:207 close c 7 '127.0.0.1:54011' on event 0001 eof 1 done 1 rb 20 sb 8\n```\n\n\u30c7\u30d0\u30c3\u30b0\u30fb\u30ed\u30b0\u3092\u6709\u52b9\u306b\u3059\u308b\u306b\u306f\u3001nutcracker \u3092\u30b3\u30f3\u30d1\u30a4\u30eb\u3059\u308b\u6642\u306b`--enable-debug=log`\u3092`configure`\u306e\u30aa\u30d7\u30b7\u30e7\u30f3\u3067\u6307\u5b9a\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u3002\n\n\n#### \u53ef\u7528\u6027 (Liveness \u3092\u3053\u3046\u8a33\u3057\u3066\u307f\u305f)\n\n\u5931\u6557\u306f\u4eba\u751f\u306b\u3064\u304d\u3082\u306e\u3060\u3002\u7279\u306b\u3001\u7269\u4e8b\u304c\u62e1\u6563\u3055\u308c\u308b\u6642\u306b\u306f\u3002\n\u969c\u5bb3\u304b\u3089\u5fa9\u65e7\u3055\u305b\u308b\u6642\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u5404\u30b5\u30fc\u30d0\u306b\u8a2d\u5b9a\u3092\u3059\u308b\u3053\u3068\u3092\u63a8\u5968\u3059\u308b\u3002\n\n```\nresilient_pool:\n  auto_eject_hosts: true\n  server_retry_timeout: 30000\n  server_failure_limit: 3\n```\n\n`auto_eject_hosts`\u3092\u6709\u52b9\u306b\u3059\u308b\u3068\u6b7b\u3093\u3060\u30b5\u30fc\u30d0\u3092hash ring \u304b\u3089\u5207\u308a\u96e2\u305b\u308b\u3053\u3068\u3092\u4fdd\u8a3c\u3057\u3001`server_failure_limit`\u306f consecutive failures have been encountered on that said server \uff08\u8a33\u305b\u306a\u304b\u3063\u305f\u2026\uff09\u3002\n`server_retry_timeout`\u304c 0 \u3067\u306a\u3044\u5834\u5408\u3001\u4e0d\u6b63\u306b\u30b5\u30fc\u30d0\u3092\u300c\u6c38\u9060\u306b\u6b7b\u3093\u3060\u300d\u3082\u306e\u3068\u3057\u3066\u30de\u30fc\u30ad\u30f3\u30b0\u3059\u308b\u3053\u3068\u304c\u306a\u3044\u3088\u3046\u4fdd\u8a3c\u3059\u308b\u3002\u7279\u306b\u3001\u77ac\u9593\u7684\u306a\u969c\u5bb3\u306e\u5834\u5408\u306b\u3060\u3002\n`server_retry_timeout`\u3068`serverfailuer_limit`\u306e\u7d44\u307f\u5408\u308f\u305b\u306b\u3088\u308b\u5236\u5fa1\u306f\u3001\u6052\u4e45\u7684\u306a\u5fa9\u65e7\u3068\u3001\u77ac\u9593\u7684\u306a\u969c\u5bb3\u306e\u9593\u3067\u306e\u30c8\u30ec\u30fc\u30c9\u30aa\u30d5\u3068\u306a\u308b\u3002\n\n\u5207\u308a\u96e2\u3055\u308c\u305f\u30b5\u30fc\u30d0\u306f\u3001`retry timeout`\u304c\u7d4c\u904e\u3059\u308b\u307e\u3067\u306f\u3001\u3069\u3093\u306a\u30ea\u30af\u30a8\u30b9\u30c8\u306b\u5bfe\u3057\u3066\u3082 hash ring \u306b\u542b\u307e\u308c\u308b\u3053\u3068\u304c\u306a\u304f\u306a\u308b\u3002\n\u3053\u308c\u306f <u>This will lead to data partitioning as keys originally on the ejected server will now be written to a server still in the pool \uff08\u8a33\u305b\u306a\u304b\u3063\u305f\u2026\uff09</u>\u3002\n\n\u30b5\u30fc\u30d0\u5207\u308a\u96e2\u3057\u306b\u76f4\u9762\u3057\u305f\u969b\u306b\u30ea\u30af\u30a8\u30b9\u30c8\u304c\u5e38\u306b\u6210\u529f\u3059\u308b\u3053\u3068\u3092\u4fdd\u8a3c\u3059\u308b\u306b\u306f (`auto_eject_hosts`\u304c\u6709\u52b9\u306a\u5834\u5408\uff09\u3001nutcracker \u81ea\u4f53\u304c\u30ea\u30af\u30a8\u30b9\u30c8\u306e\u30ea\u30c8\u30e9\u30a4\u3092\u3057\u306a\u3044\u3082\u306e\u306e\u3001\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u5c64\u3067\u30ea\u30c8\u30e9\u30a4\u306e\u4ed5\u7d44\u307f\u304c\u5b9f\u88c5\u3055\u308c\u3066\u3044\u308b\u5fc5\u8981\u304c\u3042\u308b\u3002\n\u3053\u306e\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u5074\u306e\u30ea\u30c8\u30e9\u30a4\u6570\u306f`server_failuer_limit`\u306e\u5024\u3088\u308a\u3082\u5927\u304d\u3044\u5fc5\u8981\u304c\u3042\u308a\u3001\u305d\u308c\u304c\u30aa\u30ea\u30b8\u30ca\u30eb\u306e\u30ea\u30af\u30a8\u30b9\u30c8\u304c\u751f\u5b58\u3057\u3066\u3044\u308b\u30b5\u30fc\u30d0\u306b\u63a5\u7d9a\u3055\u308c\u308b\u53ef\u80fd\u6027\u3092\u4fdd\u8a3c\u3059\u308b\u3002\n\n\n#### \u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\n\n`timeout`\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u8abf\u6574\u3059\u308b\u306e\u306f\u3001nutcracker \u306b\u304a\u3044\u3066\u6b63\u7fa9\u3060\u3002\u305d\u308c\u306f\u3069\u3093\u306a\u30b5\u30fc\u30d0\u30fb\u30d7\u30fc\u30eb\u306b\u5bfe\u3057\u3066\u3082\u3067\u3042\u3063\u3066\u3001\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u5074\u306e\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u3092\u4fe1\u7528\u3057\u3066\u3057\u307e\u3046\u3088\u308a\u3082\u3044\u3044\u3053\u3068\u3060\u3002\n\u8a2d\u5b9a\u4f8b\u306f\u4ee5\u4e0b\u3002\n\n```\nresilient_pool_with_timeout:\n  auto_eject_hosts: true\n  server_retry_timeout: 30000\n  server_failure_limit: 3\n  timeout: 400\n```\n\n\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u5074\u306e\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u3060\u3051\u3092\u4fe1\u7528\u3059\u308b\u3053\u3068\u306f\u3001\u30aa\u30ea\u30b8\u30ca\u30eb\u306a\u30ea\u30af\u30a8\u30b9\u30c8\u304c\u30af\u30e9\u30a4\u30a2\u30f3\u30c8~\u30d7\u30ed\u30ad\u30b7\u9593\u63a5\u7d9a\u3067\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u3057\u5834\u5408\u306b\u3001\u4e0d\u5229\u306a\u5f71\u97ff\u304c\u3042\u308b\u3002\n\u30d7\u30ed\u30ad\u30b7~\u30b5\u30fc\u30d0\u9593\u306e\u63a5\u7d9a\u306e\u554f\u984c\u306f\u4f9d\u7136\u3068\u3057\u3066\u8d77\u304d\u305f\u307e\u307e\u3068\u306a\u308b\u3002\n\u3053\u306e\u3053\u3068\u306f\u3001\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u304c\u30aa\u30ea\u30b8\u30ca\u30eb\u306e\u30ea\u30af\u30a8\u30b9\u30c8\u3092\u30ea\u30c8\u30e9\u30a4\u3059\u308b\u3068\u3055\u3089\u306b\u60aa\u5316\u3059\u308b\u3002\n\n\u30c7\u30d5\u30a9\u30eb\u30c8\u3067 nutcracker \u306f\u3001\u30b5\u30fc\u30d0\u3078\u9001\u3089\u308c\u308b\u3069\u3093\u306a\u30ea\u30af\u30a8\u30b9\u30c8\u306b\u5bfe\u3057\u3066\u3082\u3001\u6c38\u9060\u306b\u5f85\u3064\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u308b\u3002\n\u3057\u304b\u3057\u306a\u304c\u3089`timeout`\u30d1\u30e9\u30e1\u30fc\u30bf\u304c\u8a2d\u5b9a\u3055\u308c\u308b\u3068\u3001\u30b5\u30fc\u30d0\u304b\u3089\u306e\u30ec\u30b9\u30dd\u30f3\u30b9\u304c\u306a\u3044\u30ea\u30af\u30a8\u30b9\u30c8\u306f\u3001\u305d\u306e\u30d1\u30e9\u30e1\u30fc\u30bf\u3067\u8a2d\u5b9a\u3057\u305f\u6642\u9593 (\u5358\u4f4d\u306f msec\uff09\u3067\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u3057\u3001\u30a8\u30e9\u30fc\u30ec\u30b9\u30dd\u30f3\u30b9`SERVER_ERROR timed out \\r\\n`\u304c\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u306b\u8fd4\u3055\u308c\u308b\u3088\u3046\u306b\u306a\u308b\u3002\n\n\n#### \u30a8\u30e9\u30fc\u30fb\u30ec\u30b9\u30dd\u30f3\u30b9\n\n\u30b5\u30fc\u30d0\u969c\u5bb3\u6642\u306e\u30ea\u30af\u30a8\u30b9\u30c8\u3067\u306f**\u5fc5\u305a**\u3001\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u306b`-ERR <errno description>`\u3068\u3044\u3046\u30ec\u30b9\u30dd\u30f3\u30b9\u3092\u751f\u6210\u3057\u3066\u8fd4\u3059\uff08redis\u306e\u5834\u5408\u306e\u5f62\u5f0f\uff09\u3002\n\n`-ERR`\u3084`SERVER_ERROR`(\u3053\u3061\u3089\u306f memcached \u306e\u5834\u5408) \u3068\u3044\u3046\u30ec\u30b9\u30dd\u30f3\u30b9\u3092\u30c1\u30a7\u30c3\u30af\u3059\u308b\u3053\u3068\u3067\u3001\u77ac\u9593\u7684\u306a\u969c\u5bb3\u304c\u8d77\u304d\u305f\u5834\u5408\u306b\u3001\u30aa\u30ea\u30b8\u30ca\u30eb\u30fb\u30ea\u30af\u30a8\u30b9\u30c8\u3092\u3059\u308b\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u306f\u30ea\u30c8\u30e9\u30a4\u3092\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u308b\u3002\n\n\n#### read, writev and mbuf\n\n\uff08\u2191\u306e\u65b9\u306b\u66f8\u3044\u305f \u30bc\u30ed\u30fb\u30b3\u30d4\u30fc \u306e\u8a71\u3068\u540c\u3058\u3063\u307d\u3044\u306e\u3067\u8aad\u307f\u98db\u3070\u3057\u305f\uff09\n\n\n#### mbuf-size=N \u306e\u5f15\u6570\u306f\u3069\u3046\u8003\u3048\u305f\u3089\u3088\u3044\uff1f\n\n\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u304b\u3089\u306e\u63a5\u7d9a\u306f\u5168\u3066\u3001\u5c11\u306a\u304f\u3068\u30821\u3064\u306e mbuf \u3092\u6d88\u8cbb\u3059\u308b\u3002\n1\u3064\u306e\u30ea\u30af\u30a8\u30b9\u30c8\u306e\u53d7\u4ed8\u306b\u30012\u3064\u306e\u30b3\u30cd\u30af\u30b7\u30e7\u30f3\u3092\u5fc5\u8981\u3068\u3059\u308b\u30021\u3064\u306f\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u304b\u3089\u30d7\u30ed\u30ad\u30b7\u3001\u3082\u30461\u3064\u306f\u30d7\u30ed\u30ad\u30b7\u304b\u3089\u30b5\u30fc\u30d0\u3060\u3002\n\n\u65ad\u7247\u5316\u3059\u308b\u30ea\u30af\u30a8\u30b9\u30c8\u3001\u4f8b\u3048\u3070`get foo bar\\r\\n`\u306e\u3088\u3046\u306a\u3001\u306f`get foo\\r\\n`\u3068`get bar \\r\\n`\u306b\u65ad\u7247\u5316\u3057\u30012\u3064\u306e mbuf \u3092\u30ea\u30af\u30a8\u30b9\u30c8\u306b\u3001\u3055\u3089\u306b2\u3064\u306e mbuf \u3092\u30ec\u30b9\u30dd\u30f3\u30b9\u306b\u6d88\u8cbb\u3059\u308b\u3002\n\u3088\u3063\u3066N\u500b\u306b\u65ad\u7247\u5316\u3059\u308b\u30ea\u30af\u30a8\u30b9\u30c8\u306f 2N \u306e mbuf \u3092\u5fc5\u8981\u3068\u3059\u308b\u3002\nmbuf \u306b\u3064\u3044\u3066\u306f\u3001\u826f\u3044\u8a00\u3044\u65b9\u3092\u3059\u308c\u3070\u30e1\u30e2\u30ea\u306f\u518d\u5229\u7528\u30d7\u30fc\u30eb\u304b\u3089\u4e0e\u3048\u3089\u308c\u308b\u3002\u4e00\u5ea6 mbuf \u304c\u30a2\u30ed\u30b1\u30fc\u30c8\u3055\u308c\u308b\u3068\u3001\u4e8c\u5ea6\u3068\u958b\u653e\u3055\u308c\u308b\u3053\u3068\u306f\u306a\u304f\u3001\u518d\u5229\u7528\u30d7\u30fc\u30eb\u306b\u623b\u3055\u308c\u308b\u3002\n\u60aa\u3044\u8a00\u3044\u65b9\u3092\u3059\u308c\u3070\u3001\u4e00\u5ea6 mbuf \u304c\u30a2\u30ed\u30b1\u30fc\u30c8\u3055\u308c\u305f\u3089\u4e8c\u5ea6\u3068\u958b\u653e\u3055\u308c\u305a\u3001\u958b\u653e\u3055\u308c\u305f mbuf \u306f\u518d\u5229\u7528\u30d7\u30fc\u30eb\u306b\u5fc5\u305a\u623b\u3055\u308c\u3066\u3057\u307e\u3046\u3002\n\u3053\u308c\u306f\u3057\u304b\u3057\u306a\u304c\u3089\u3001\u518d\u5229\u7528\u30d7\u30fc\u30eb\u306e\u95be\u5024\u306e\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u4e0e\u3048\u308b\u3053\u3068\u3067\u3001\u7c21\u5358\u306b\u4fee\u6b63\u3067\u304d\u308b\u3002\n\n\u3088\u3063\u3066\u3082\u3057 nutcracker \u304c1000\u53f0\u306e\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u304b\u3089\u306e\u63a5\u7d9a\u3068\u3001100\u53f0\u306e\u30b5\u30fc\u30d0\u3078\u306e\u63a5\u7d9a\u3092\u6271\u3063\u3066\u3044\u308b\u306e\u3067\u3042\u308c\u3070\u3001\u6700\u5927\u3067 (max(1000, 100) * 2 * mbuf-size) \u5206\u306e\u30e1\u30e2\u30ea\u3092 mbuf \u306b\u6d88\u8cbb\u3059\u308b\u3002\n\u3082\u3057\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u304c\u30d1\u30a4\u30d7\u3055\u308c\u3066\u3044\u306a\u3044\u30ea\u30af\u30a8\u30b9\u30c8\u3092\u9001\u3063\u3066\u304d\u305f\u3068\u3059\u308b\u3068\u3001\u30c7\u30d5\u30a9\u30eb\u30c8\u306e mbuf-size \u3067\u3042\u308b 16K \u3067\u8a08\u7b97\u3057\u3066\u3001\u5408\u8a08\u3067 32M \u3092\u6d88\u8cbb\u3059\u308b\u3053\u3068\u306b\u306a\u308b\u3002\n\n\u3082\u3063\u3068\u8a00\u3046\u3068\u3001\u3082\u3057\u5e73\u5747\u3067\u5404\u30ea\u30af\u30a8\u30b9\u30c8\u304c10\u306e\u30d5\u30e9\u30b0\u30e1\u30f3\u30c8\uff08\u65ad\u7247\uff09\u304b\u3089\u6210\u3063\u3066\u3044\u308b\u3068\u3059\u308b\u3068\u3001\u30e1\u30e2\u30ea\u306e\u6d88\u8cbb\u306f 320M \u306b\u3082\u306a\u308b\u3002\n\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u63a5\u7d9a\u304c1000\u3067\u306f\u306a\u304f10000\u3060\u3063\u305f\u3089\u3001\u30e1\u30e2\u30ea\u6d88\u8cbb\u306f3.2G\u306b\u3082\u306a\u308b\u3060\u308d\u3046\u3002\nmbuf-size \u3092\u30c7\u30d5\u30a9\u30eb\u30c8\u306e16K\u3067\u306f\u306a\u304f 512bytes \u3068\u3059\u308c\u3070\u3001\u540c\u3058\u30b7\u30ca\u30ea\u30aa\u306e\u5834\u5408\u3067\u3082 10M \u7a0b\u5ea6\u307e\u3067\u30e1\u30e2\u30ea\u6d88\u8cbb\u91cf\u306f\u843d\u3061\u308b\u3002\n\n\u3053\u308c\u304c\u3001\u5927\u91cf\u306e\u30b3\u30cd\u30af\u30b7\u30e7\u30f3\u3084\u3001multi-get \u306e\u3088\u3046\u306a\u5e45\u5e83\u3044\u30ea\u30af\u30a8\u30b9\u30c8\u306b\u5bfe\u3057\u3066\u3001\u5c0f\u3055\u306a 512 \u306e\u3088\u3046\u306a\u5c0f\u3055\u306a mbuf-size \u3092\u5272\u308a\u5f53\u3066\u308b\u3079\u304d\u7406\u7531\u3067\u3042\u308b\u3002\n\n\n#### \u6700\u5927\u30ad\u30fc\u9577\n\nmemcached \u306e ascii \u30d7\u30ed\u30c8\u30b3\u30eb\u306e\u4ed5\u69d8\u3067\u306f\u3001\u30ad\u30fc\u306f\u6700\u5927\u3067250\u6587\u5b57\u3068\u306a\u3063\u3066\u3044\u308b\u3002\n\u30ad\u30fc\u306f\u7a7a\u767d\u3084`\\r`\u3001`\\n`\u3068\u3044\u3063\u305f\u6587\u5b57\u3082\u542b\u3092\u542b\u307e\u306a\u3044\u3002\nredis \u306b\u5bfe\u3057\u3066\u306f\u3001\u3053\u3046\u3057\u305f\u5236\u9650\u306f\u306a\u3044\u3002\n\u3057\u304b\u3057\u306a\u304c\u3089\u3001 nutcracker \u3067\u306f\u30e1\u30e2\u30ea\u306e\u96a3\u308a\u5408\u3063\u305f\u9818\u57df\u306b\u30ad\u30fc\u304c\u683c\u7d0d\u3055\u308c\u308b\u3002\nnutracker \u3067\u306f\u5168\u3066\u306e\u30ea\u30af\u30a8\u30b9\u30c8\u3068\u30ec\u30b9\u30dd\u30f3\u30b9\u304c mbuf \u306b\u683c\u7d0d\u3055\u308c\u308b\u305f\u3081\u3001redis \u306e\u30ad\u30fc\u9577\u306f mbuf \u5185\u3067\u30c7\u30fc\u30bf\u304c\u5c02\u6709\u53ef\u80fd\u306a\u6700\u5927\u30b5\u30a4\u30ba\u3067\u5236\u9650\u3055\u308c\u308b\uff08`mbuf_data_size()`\uff09\u3002\n\u3053\u308c\u306f\u3001\u3082\u3057 redis \u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u304c\u304a\u304a\u304d\u306a\u30ad\u30fc\u3092\u6271\u3046\u5834\u5408\u3001\u305d\u308c\u306b\u898b\u5408\u3046\u5927\u304d\u306a mbuf \u30b5\u30a4\u30ba\u3092`-m`\u307e\u305f\u306f`--mbuf-size=N`\u3067\u30b3\u30de\u30f3\u30c9\u30e9\u30a4\u30f3\u5f15\u6570\u3068\u3057\u3066\u6307\u5b9a\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u3002\n\n\n#### Consistent Hashing \u306e\u305f\u3081\u306e\u30ce\u30fc\u30c9\u540d\n\ntwemproxy \u306b\u304a\u3051\u308b\u30b5\u30fc\u30d0\u30fb\u30af\u30e9\u30b9\u30bf\u306f\u3001\u4ee5\u4e0b\u306e\u3069\u3061\u3089\u306e\u6587\u5b57\u5217\u30ea\u30b9\u30c8\u5f62\u5f0f\u3067\u3082\u8a18\u8ff0\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u308b\u3002\n\n*   host:port:weight\n*   host:port:weight name\n\n\u5177\u4f53\u7684\u306b\u306f\n\n```\nservers:\n - 127.0.0.1:6379:1\n - 127.0.0.1:6380:1\n - 127.0.0.1:6381:1\n - 127.0.0.1:6382:1\n```\n\n\u307e\u305f\u306f\n\n```\nservers:\n - 127.0.0.1:6379:1 server1\n - 127.0.0.1:6380:1 server2\n - 127.0.0.1:6381:1 server3\n - 127.0.0.1:6382:1 server4\n```\n\n\u524d\u8005\u306e\u8a2d\u5b9a\u3067\u306f\u3001\u30ad\u30fc\u306f\u76f4\u63a5 host:port:weight \u306e3\u3064\u7d44\u306b\u30de\u30c3\u30d4\u30f3\u30b0\u3055\u308c\u3001\u5f8c\u8005\u3067\u3067\u306f\u30ce\u30fc\u30c9\u540d\uff08\u3053\u306e\u6b21\u306b host:port \u306e\u7d44\u306b\u30de\u30c3\u30d4\u30f3\u30b0\u3055\u308c\u308b\uff09\u306b\u30de\u30c3\u30d4\u30f3\u30b0\u3055\u308c\u308b\u3002\n\u5f8c\u8005\u306e\u8a2d\u5b9a\u3067\u306f\u3001\u3053\u3068\u306a\u308b\u30b5\u30fc\u30d0\u306b\u30ce\u30fc\u30c9\u3092\u518d\u5272\u308a\u5f53\u3066\u3059\u308b\u3053\u3068\u304c\u81ea\u7531\u3067\u3042\u308a\u3001\u305d\u308c\u3092hash ring \u306e\u914d\u5e03\u306a\u3057\u306b\u884c\u3048\u308b\u3002\n\u305d\u308c\u3086\u3048\u3001`auto_eject_hosts`(\u30b5\u30fc\u30d0\u306e\u81ea\u52d5\u5207\u308a\u96e2\u3057\u306e\u3053\u3068\u3068\u601d\u308f\u308c\uff09\u3092\u7121\u52b9\u306b\u3057\u3066\u3044\u308b\u5834\u5408\u306f\u3001\u3053\u306e\u8a2d\u5b9a\u304c\u7406\u60f3\u7684\u3067\u3042\u308b\u3002\n\u8a73\u7d30\u306f [https://github.com/twitter/twemproxy/issues/25](https://github.com/twitter/twemproxy/issues/25) \u3092\u53c2\u7167\u3002\n\n\u3061\u306a\u307f\u306b\u3001\u30ce\u30fc\u30c9\u540d\u3092 consistent hashing \u3067\u4f7f\u3046\u6642\u306f\u3001twemproxy \u306f weight \u306e\u5024\u3092\u7121\u8996\u3059\u308b\u306e\u3067\u6c17\u3092\u3064\u3051\u3089\u308c\u305f\u3057\u3002\n\n\n#### \u30cf\u30c3\u30b7\u30e5\u30bf\u30b0\n\n\u30cf\u30c3\u30b7\u30e5\u30bf\u30b0 [http://oldblog.antirez.com/post/redis-presharding.html](http://oldblog.antirez.com/post/redis-presharding.html) \u306f\u3001\u30ad\u30fc\u306e\u4e00\u90e8\u3092\u4f7f\u3063\u3066\u30cf\u30c3\u30b7\u30e5\u5024\u3092\u8a08\u7b97\u3059\u308b\u306e\u306b\u4f7f\u308f\u308c\u308b\u3002\n\u30cf\u30c3\u30b7\u30e5\u30bf\u30b0\u304c\u5b58\u5728\u3057\u3066\u3044\u308b\u5834\u5408\u3001\u30bf\u30b0\u5185\u306b\u3042\u308b\u30ad\u30fc\u306e\u4e00\u90e8\u3092\u3001consitent hashing \u306e\u30ad\u30fc\u3068\u3057\u3066\u4f7f\u3046\u3002\n\u305d\u3046\u3067\u306a\u3044\u5834\u5408\u3001\u30ad\u30fc\u5168\u4f53\u3092\u540c\u3058\u7528\u9014\u3068\u3057\u3066\u7528\u3044\u308b\u3053\u3068\u306b\u306a\u308b\u3002\n\u30cf\u30c3\u30b7\u30e5\u30bf\u30b0\u306f\u3001\u30bf\u30b0\u5185\u306e\u30ad\u30fc\u304c\u540c\u3058\u9650\u308a\u306b\u304a\u3044\u3066\u3001\u7570\u306a\u308b\u30ad\u30fc\u3092\u540c\u3058\u30b5\u30fc\u30d0\u306b\u5272\u308a\u5f53\u3066\u308b\u3053\u3068\u3092\u53ef\u80fd\u306b\u3059\u308b \u3002\n\n\u4f8b\u3048\u3070\u3001\u30b5\u30fc\u30d0\u30fb\u30d7\u30fc\u30eb beta \u306e\u8a2d\u5b9a\u304c\u4ee5\u4e0b\u3067\u3042\u308b\u6642\u3001hash_tag \u306f2\u3064\u306e\u6587\u5b57 \"{}\" \u3067\u6307\u5b9a\u3055\u308c\u3066\u3044\u308b\u3002\n\u3053\u308c\u306f\u3001\u30ad\u30fc`user:{user1}:ids`\u3068`user:{user1}:tweets`\u304c\u540c\u3058\u30b5\u30fc\u30d0\u306b\u30de\u30c3\u30d4\u30f3\u30b0\u3055\u308c\u308b\u3053\u3068\u306b\u306a\u308b\u3002\u306a\u305c\u306a\u3089\u3001\u30cf\u30c3\u30b7\u30e5\u5024\u306f`user1`\u306b\u5bfe\u3057\u3066\u8a08\u7b97\u3055\u308c\u308b\u3053\u3068\u306b\u306a\u308b\u304b\u3089\u3060\u3002\n\u4e00\u65b9\u3067\u4f8b\u3048\u3070`user:user1:ids`\u306e\u3088\u3046\u306a\u30ad\u30fc\u3067\u3042\u308c\u3070\u3001\u3053\u306e\u6587\u5b57\u5217\u5168\u4f53\u3067\u30cf\u30c3\u30b7\u30e5\u5024\u3092\u8a08\u7b97\u3059\u308b\u3053\u3068\u306b\u306a\u308b\u3002\n\n```\nbeta:\n  listen: 127.0.0.1:22122\n  hash: fnv1a_64\n  hash_tag: \"{}\"\n  distribution: ketama\n  auto_eject_hosts: false\n  timeout: 400\n  redis: true\n  servers:\n   - 127.0.0.1:6380:1 server1\n   - 127.0.0.1:6381:1 server2\n   - 127.0.0.1:6382:1 server3\n   - 127.0.0.1:6383:1 server4\n```\n\n\n#### \u30ad\u30e3\u30c3\u30b7\u30e5\u30fb\u30d7\u30fc\u30eb\u306e\u72b6\u614b\u3092\u53ef\u8996\u5316\n\nnutcracker \u3092\u672c\u756a\u74b0\u5883\u3067\u904b\u7528\u3057\u3066\u3044\u308b\u6642\u3001\u751f\u304d\u3066\u3044\u308b\u30ce\u30fc\u30c9\u3068\u3001\u5207\u308a\u96e2\u3055\u308c\u305f\u30ce\u30fc\u30c9\u3092\u77e5\u308a\u305f\u304f\u306a\u308b\u3060\u308d\u3046\u3002\n\u3053\u306e\u554f\u3078\u306e\u7b54\u3048\u306f\u7c21\u5358\u3067\u3001\u751f\u304d\u3066\u3044\u308b\uff0f\u6b7b\u3093\u3067\u3044\u308b\u30b5\u30fc\u30d0\uff08\u4efb\u610f\u306e\u30ad\u30e3\u30c3\u30b7\u30e5\u30d7\u30fc\u30eb\u306e\u4e00\u90e8\uff09\u3092\u6642\u7cfb\u5217\u306e\u30b0\u30e9\u30d5\u3068\u3057\u3066\u751f\u6210\u3059\u308c\u3070\u3088\u3044\u3002\n\u3053\u308c\u3092\u3059\u308b\u305f\u3081\u306b\u306f\u3001\u30b0\u30e9\u30d5\u5316\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u304c\u4ee5\u4e0b\u306e\u60c5\u5831\u3092 nutcracker \u306e stats \u304b\u3089\u53d6\u5f97\u3059\u308b\u3002\n\n*   server_eof: \u30b5\u30fc\u30d0\u306e\u63a5\u7d9a\u304c\u666e\u901a\u306b\u5207\u3089\u308c\u305f\u6570\u3002\u6c38\u7d9a\u7684\u306a\u63a5\u7d9a\u3092\u3057\u3066\u3044\u308b\u306e\u3067\u3001\u3053\u308c\u304c\u5897\u3048\u305f\u3089\u304a\u304b\u3057\u3044\n*   server_timedout: \u30b5\u30fc\u30d0\u5074\u306e\u63a5\u7d9a\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u6570\u3002\u3053\u308c\u304c\u5897\u3048\u305f\u3089\u30e4\u30c0\n*   server_err: \u305d\u306e\u4ed6\u3001\u30b5\u30fc\u30d0\u5074\u306e\u30a8\u30e9\u30fc\u6570\u3002\u3053\u308c\u304c\u5897\u3048\u305f\u3089\u30e4\u30c0\n\n\u3088\u3063\u3066\u3001\u4e0e\u3048\u3089\u308c\u305f\u30b5\u30fc\u30d0\u306b\u304a\u3044\u3066\u3001\u5207\u308a\u96e2\u3055\u308c\u305f\u6570\u306e\u7d2f\u7a4d\u306f\u4ee5\u4e0b\u3067\u8a08\u7b97\u3055\u308c\u308b\u3002\n\n```\n(server_err + server_timedout + sever_eof) / server_failure_limit\n```\n\n\u3048\u30fc\u3068\u3001\u4ee5\u4e0b\u3001\u8a33\u3059\u306e\u30c0\u30eb\u304f\u306a\u3063\u305f\u306e\u3067\u305d\u306e\u307e\u307e\u66f8\u304f\n\nA diff of the above value between two successive time intervals would generate a nice timeseries graph for ejected servers.\n\nYou can also graph the timestamp at which any given server was ejected by graphing <u>server_ejected_at</u> stat.\n\n#### server_connections: > 1\n\ntwemproxy \u306f\u3001\u3044\u304f\u3064\u304b\u306e\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u540c\u6642\u63a5\u7d9a\u3068\u3001\u5c11\u306a\u3044\u30b5\u30fc\u30d0\u63a5\u7d9a\u304c\u3042\u308b\u3088\u3046\u306a\u72b6\u6cc1\u3092\u60f3\u5b9a\u3057\u3066\u3044\u308b\u3002\n\u91cd\u8981\u306a\u3053\u3068\u3068\u3057\u3066\u3001\u300cread my last write (\u4ffa\u306e\u6700\u5f8c\u306e\u66f8\u304d\u8fbc\u307f\u3092\u8aad\u3081\uff09\u300d\u3068\u3044\u3046\u5236\u7d04\u304c\u5fc5\u305a\u3057\u3082\u6210\u7acb\u3057\u306a\u3044\u5834\u5408\u304c\u3042\u308b\u3002\n\u305d\u308c\u306f twemproxy \u306b \u3068\u3044\u3046\u8a2d\u5b9a\u304c\u3055\u308c\u3066\u3044\u308b\u5834\u5408\u3067\u3042\u308b\u3002\n\n```\nserver_connections: > 1\n```\n\n\u3053\u308c\u3092\u8aac\u660e\u3059\u308b\u306b\u3042\u305f\u308a\u3001twemproxy \u304c`server_connections: 2`\u3068\u8a2d\u5b9a\u3055\u308c\u3066\u3044\u308b\u72b6\u6cc1\u3092\u8003\u3048\u308b\u3002\n\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u304c\u30d1\u30a4\u30d7\u3055\u308c\u305f\u30ea\u30af\u30a8\u30b9\u30c8\u3092\u751f\u6210\u3057\u3001\u6700\u521d\u306e\u30ea\u30af\u30a8\u30b9\u30c8\u304c\u30d1\u30a4\u30d7\u30e9\u30a4\u30f3\u4e2d\u3067`set foo 0 0 3 \\r\\nbar\\r\\n`\uff08\u66f8\u304d\u8fbc\u307f\uff09\u3067\u3042\u308a\u30012\u3064\u76ee\u306e\u30ea\u30af\u30a8\u30b9\u30c8\u304c`get foo \\r\\n`\uff08\u8aad\u307f\u8fbc\u307f\uff09\u3067\u3042\u308b\u5834\u5408\u3001\u671f\u5f85\u3055\u308c\u308b foo \u306b\u5bfe\u3059\u308b\u5024\u306f bar \u3067\u3042\u308b\u3002\n\u3057\u304b\u3057\u306a\u304c\u3089\u30012\u3064\u306e\u30b5\u30fc\u30d0\u63a5\u7d9a\u306e\u8a2d\u5b9a\u304c\u3055\u308c\u3066\u3044\u308b\u3068\u3001write \u3068 read \u304c\u5225\u306e\u30b5\u30fc\u30d0\u306b\u9001\u3089\u308c\u308b\u53ef\u80fd\u6027\u304c\u3042\u308a\u3001\u671f\u5f85\u3059\u308b\u30ec\u30b9\u30dd\u30f3\u30b9\u304c\u8fd4\u3089\u306a\u3044\u3053\u3068\u304c\u3042\u308b\u3002\n\u8981\u7d04\u3059\u308b\u3068\u3001\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u304c\u300cread my last write\u300d\u306e\u5236\u7d04\u3092\u671f\u5f85\u3057\u3066\u3044\u308b\u5834\u5408\u306f\u3001`server_connections: 1`\u3092\u8a2d\u5b9a\u3059\u308b\u304b\u3001\u307e\u305f\u306f twemproxy \u306b\u5bfe\u3057\u3066\u540c\u671f\u7684\u306a\u30ea\u30af\u30a8\u30b9\u30c8\u3092\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u3002\n", "tags": ["twemproxy", "Redis", "Memcached"]}