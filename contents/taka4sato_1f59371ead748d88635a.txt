{"context": "Docker\u521d\u5fc3\u8005\u306a\u306e\u3067\u3001Docker\u3092\u6d3b\u7528\u3059\u308b\u4e0a\u3067\u306eSupervisor\u306e\u4f7f\u3044\u65b9, Tips\u3092\u30c1\u30e9\u88cf\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\n\u305d\u3082\u305d\u3082Supervoisor\u3068\u306f\n\u3053\u306e\u8a18\u4e8b\u3068\u304b\u304c\u53c2\u8003\u306b\u306a\u308a\u307e\u3059\u304c\u3001\u305d\u3082\u305d\u3082\u306f\u30d7\u30ed\u30bb\u30b9\u306e\u7ba1\u7406\u3001Daemon\u5316\u3001\u6c38\u7d9a\u5316(\u30d7\u30ed\u30bb\u30b9\u304c\u4e0d\u6b63\u7d42\u4e86\u3057\u305f\u3089\u81ea\u52d5\u3067\u518d\u8d77\u52d5\u306a\u3069)\u306eTool\u3001\u3068\u8a00\u3046\u30a4\u30e1\u30fc\u30b8\u3067\u3059\u3002\nDocker\u8996\u70b9\u3067\u898b\u308b\u3068\u3001\u300eDocker Container\u4e0a\u3067\u306fProcess\u304cForeground\u3067\u52d5\u3044\u3066\u3044\u306a\u3044\u3068Container\u306f\u7d42\u4e86\u3059\u308b\u300f\u3068\u3044\u3046Container\u306e\u5236\u9650\u304c\u3042\u308b\u4e2d\u3067\u30011\u3064\u306eContainer\u4e0a\u3067\u8907\u6570\u306e\u30d7\u30ed\u30bb\u30b9 (\u4f8b\u3048\u3070Node + Mongo\u3084Fluentd + Elasticsearch\u306a\u3069)\u3092\u52d5\u304b\u3057\u305f\u3044\u3001\u6c38\u7d9a\u5316\u3055\u305b\u305f\u3044\u6642\u306b\u3053\u306eSupervisor\u3068\u3044\u3046Tool\u304c\u4f7f\u308f\u308c\u307e\u3059\u3002\nsupervisord.conf\u306eOption\u306f\u3001\u516c\u5f0f\u30da\u30fc\u30b8\u3092\u898b\u3066\u4e0b\u3055\u3044\u3002\n\n\u57fa\u672c\u7684\u306a\u4f7f\u3044\u65b9\nnginx\u3092supervisor\u4e0a\u3067\u52d5\u304b\u3057\u305f\u3044\u3001\u3068\u3044\u3046Case Study\u306e\u5834\u5408\u3001Dockerfile\u306f\u4ee5\u4e0b\u306e\u69d8\u306b\u306a\u308a\u307e\u3059\u3002\nFROM ubuntu:14.04\n\n#Install nginx\nRUN apt-get update && apt-get -y install nginx curl\nRUN echo \"daemon off;\" >> /etc/nginx/nginx.conf\n\n#Install Supervisor and config\nRUN apt-get install -y supervisor\nRUN touch /etc/supervisord.conf\nRUN echo '[supervisord]'  >> /etc/supervisord.conf\nRUN echo 'nodaemon=true'  >> /etc/supervisord.conf\nRUN echo '[program:nginx]' >> /etc/supervisord.conf\nRUN echo 'command=nginx'   >> /etc/supervisord.conf\n\nEXPOSE 80\nCMD /usr/bin/supervisord -c /etc/supervisord.conf\n\n[supervisord]\u3068nodaemon=true\u306e\u884c\u306f\u5fc5\u9808\u3067\u3001nodaemon=true\u3067supervisor\u81ea\u4f53\u304cforeground\u30d7\u30ed\u30bb\u30b9\u3068\u3057\u3066\u632f\u308b\u821e\u3044Docker container\u306e\u7d42\u4e86\u3092\u9632\u3050\u5f79\u5272\u3092\u679c\u305f\u3057\u307e\u3059\u3002command=\u306b\u306f\u3001Container\u4e0a\u3067nginx\u3092\u5358\u4f53\u3067\u52d5\u304b\u3057\u7d9a\u3051\u308b\u5834\u5408\u306b\u66f8\u3044\u3066\u304a\u304f\u3079\u304dcommand\u3092\u66f8\u3044\u3066\u304a\u304f\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\nDockerfile\u306f\u7c21\u6f54\u306b\u8a18\u8f09\u3057\u3066Config file\u306f\u5225file\u304c\u826f\u3044\u3001\u3068\u8a00\u3046\u65b9\u306f\u3001supervisord.conf\u3068\u3044\u3046file\u306b\u4ee5\u4e0b\u306e\u5185\u5bb9\u3092\u66f8\u3044\u3066\u7f6e\u3044\u3066\u3001/etc/\u4ee5\u4e0b\u306b\u914d\u7f6e\u3059\u308b\u3088\u3046\u306bDockerfile\u5074\u306b\u8a18\u8f09\u3057\u3066\u304a\u3051\u3070OK\u3067\u3059\u3002\n[supervisord]\nnodaemon=true\n\n[program:nginx]\ncommand=nginx\n\n\n\u8907\u6570\u306e\u30d7\u30ed\u30bb\u30b9\u3092\u52d5\u304b\u3059\u5834\u5408\u306e\u4f7f\u3044\u65b9\nElasticsearch + Fluentd\u3092supervisor\u4e0a\u3067\u52d5\u304b\u3057\u305f\u3044\u3001\u3068\u3044\u3046Case Study\u306e\u5834\u5408\u3001Dockerfile\u306f\u4ee5\u4e0b\u306e\u69d8\u306b\u306a\u308a\u307e\u3059\u3002\nFROM ubuntu:14.04\nRUN apt-get update -y\n\n#Install Elasticsearch\nENV ELASTICSEARCH_VERSION elasticsearch-1.4.4\nRUN apt-get install -y curl openjdk-7-jdk\nRUN mkdir /opt/elasticsearch\nRUN curl -sL \"https://download.elasticsearch.org/elasticsearch/elasticsearch/${ELASTICSEARCH_VERSION}.tar.gz\" | tar xz -C /opt/elasticsearch --strip=1\n\n#Install Fluentd and plugins\nRUN apt-get install -y libcurl4-openssl-dev git-core build-essential ruby-dev\nRUN curl -L http://toolbelt.treasuredata.com/sh/install-ubuntu-trusty-td-agent2.sh | sh\nCOPY td-agent.conf /etc/td-agent/td-agent.conf\nRUN ulimit -n 65536\n\n#Install Supervisor and config\nRUN apt-get install -y supervisor\nRUN touch /etc/supervisord.conf\nRUN echo '[supervisord]'  >> /etc/supervisord.conf\nRUN echo 'nodaemon=true'  >> /etc/supervisord.conf\nRUN echo '[program:elasticsearch]'             >> /etc/supervisord.conf\nRUN echo 'command=/opt/elasticsearch/bin/elasticsearch' >> /etc/supervisord.conf\nRUN echo '[program:td-agent]'             >> /etc/supervisord.conf\nRUN echo 'command=/usr/sbin/td-agent' >> /etc/supervisord.conf\n\n# expose port for elasticsearch\nEXPOSE 9200\n\n# expose port for fluentd\nEXPOSE 24224\n\nCMD /usr/bin/supervisord -c /etc/supervisord.conf\n\n\nSupervisor\u3067\u6c17\u3092\u3064\u3051\u308b\u3079\u304d\u8a2d\u5b9a\n\n\u5404\u30d7\u30ed\u30bb\u30b9\u306e\u6a19\u6e96\u51fa\u529b\u306b\u3064\u3044\u3066\nSupervisor\u306f Default\u8a2d\u5b9a\u3067\u306f \u3001\u5404\u30d7\u30ed\u30bb\u30b9\u304b\u3089\u306e\u6a19\u6e96\u51fa\u529b\u3092\u53d7\u3051\u53d6\u308afile\u306b\u66f8\u304d\u51fa\u3059\u8a2d\u5b9a\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002\u305d\u306e\u305f\u3081\u3001Supervisor\u3092\u7d4c\u7531\u3057\u3066\u5404\u30d7\u30ed\u30bb\u30b9\u3092\u52d5\u304b\u3059\u5834\u5408\u306b\u3001\u5404\u30d7\u30ed\u30bb\u30b9\u306e\u6a19\u6e96\u51fa\u529b\u306e\u5185\u5bb9\u3092\u898b\u308b\u4e8b\u304c\u51fa\u6765\u307e\u305b\u3093\u3002\nfile\u3067\u306f\u306a\u304f\u6a19\u6e96\u51fa\u529b\u306b\u66f8\u304d\u51fa\u3057\u305f\u3044\u5834\u5408\u306f\u3001stdout_logfile\u3092/dev/fd/1\u306b\u8a2d\u5b9a\u3057\u3066\u3042\u3052\u308b\u3068\u826f\u3044\u3067\u3059\u3002\u305f\u3068\u3048\u3070\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u8a2d\u5b9a\u3059\u308b\u3068\u3001td-agent\u306e\u30d7\u30ed\u30bb\u30b9\u304b\u3089\u51fa\u305f\u6a19\u6e96\u51fa\u529b\u306f\u3001(Supervisor\u3092\u7d4c\u7531\u3057\u3066)\u30b7\u30b9\u30c6\u30e0\u5168\u4f53\u306e\u6a19\u6e96\u51fa\u529b\u306bRoute\u3055\u308c\u307e\u3059\u3002\n[supervisord]\nnodaemon=true\n\n[program:elasticsearch]\ncommand=/opt/elasticsearch/bin/elasticsearch\n\n[program:td-agent]\ncommand=/usr/sbin/td-agent\nstdout_logfile=/dev/fd/1\nstdout_logfile_maxbytes=0\n\nDocker\u521d\u5fc3\u8005\u306a\u306e\u3067\u3001Docker\u3092\u6d3b\u7528\u3059\u308b\u4e0a\u3067\u306eSupervisor\u306e\u4f7f\u3044\u65b9, Tips\u3092\u30c1\u30e9\u88cf\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\n#\u305d\u3082\u305d\u3082Supervoisor\u3068\u306f\n[\u3053\u306e\u8a18\u4e8b](http://qiita.com/yushin/items/15f4f90c5663710dbd56)\u3068\u304b\u304c\u53c2\u8003\u306b\u306a\u308a\u307e\u3059\u304c\u3001\u305d\u3082\u305d\u3082\u306f\u30d7\u30ed\u30bb\u30b9\u306e\u7ba1\u7406\u3001Daemon\u5316\u3001\u6c38\u7d9a\u5316(\u30d7\u30ed\u30bb\u30b9\u304c\u4e0d\u6b63\u7d42\u4e86\u3057\u305f\u3089\u81ea\u52d5\u3067\u518d\u8d77\u52d5\u306a\u3069)\u306eTool\u3001\u3068\u8a00\u3046\u30a4\u30e1\u30fc\u30b8\u3067\u3059\u3002\n\nDocker\u8996\u70b9\u3067\u898b\u308b\u3068\u3001\u300eDocker Container\u4e0a\u3067\u306fProcess\u304cForeground\u3067\u52d5\u3044\u3066\u3044\u306a\u3044\u3068Container\u306f\u7d42\u4e86\u3059\u308b\u300f\u3068\u3044\u3046Container\u306e\u5236\u9650\u304c\u3042\u308b\u4e2d\u3067\u30011\u3064\u306eContainer\u4e0a\u3067\u8907\u6570\u306e\u30d7\u30ed\u30bb\u30b9 (\u4f8b\u3048\u3070`Node + Mongo`\u3084`Fluentd + Elasticsearch`\u306a\u3069)\u3092\u52d5\u304b\u3057\u305f\u3044\u3001\u6c38\u7d9a\u5316\u3055\u305b\u305f\u3044\u6642\u306b\u3053\u306eSupervisor\u3068\u3044\u3046Tool\u304c\u4f7f\u308f\u308c\u307e\u3059\u3002\n\nsupervisord.conf\u306eOption\u306f\u3001[\u516c\u5f0f\u30da\u30fc\u30b8](http://supervisord.org/configuration.html)\u3092\u898b\u3066\u4e0b\u3055\u3044\u3002\n\n#\u57fa\u672c\u7684\u306a\u4f7f\u3044\u65b9\nnginx\u3092supervisor\u4e0a\u3067\u52d5\u304b\u3057\u305f\u3044\u3001\u3068\u3044\u3046Case Study\u306e\u5834\u5408\u3001Dockerfile\u306f\u4ee5\u4e0b\u306e\u69d8\u306b\u306a\u308a\u307e\u3059\u3002\n\n```\nFROM ubuntu:14.04\n\n#Install nginx\nRUN apt-get update && apt-get -y install nginx curl\nRUN echo \"daemon off;\" >> /etc/nginx/nginx.conf\n\n#Install Supervisor and config\nRUN apt-get install -y supervisor\nRUN touch /etc/supervisord.conf\nRUN echo '[supervisord]'  >> /etc/supervisord.conf\nRUN echo 'nodaemon=true'  >> /etc/supervisord.conf\nRUN echo '[program:nginx]' >> /etc/supervisord.conf\nRUN echo 'command=nginx'   >> /etc/supervisord.conf\n\nEXPOSE 80\nCMD /usr/bin/supervisord -c /etc/supervisord.conf\n```\n\n`[supervisord]`\u3068`nodaemon=true`\u306e\u884c\u306f\u5fc5\u9808\u3067\u3001`nodaemon=true`\u3067supervisor\u81ea\u4f53\u304cforeground\u30d7\u30ed\u30bb\u30b9\u3068\u3057\u3066\u632f\u308b\u821e\u3044Docker container\u306e\u7d42\u4e86\u3092\u9632\u3050\u5f79\u5272\u3092\u679c\u305f\u3057\u307e\u3059\u3002`command=`\u306b\u306f\u3001Container\u4e0a\u3067nginx\u3092\u5358\u4f53\u3067\u52d5\u304b\u3057\u7d9a\u3051\u308b\u5834\u5408\u306b\u66f8\u3044\u3066\u304a\u304f\u3079\u304dcommand\u3092\u66f8\u3044\u3066\u304a\u304f\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\nDockerfile\u306f\u7c21\u6f54\u306b\u8a18\u8f09\u3057\u3066Config file\u306f\u5225file\u304c\u826f\u3044\u3001\u3068\u8a00\u3046\u65b9\u306f\u3001supervisord.conf\u3068\u3044\u3046file\u306b\u4ee5\u4e0b\u306e\u5185\u5bb9\u3092\u66f8\u3044\u3066\u7f6e\u3044\u3066\u3001`/etc/`\u4ee5\u4e0b\u306b\u914d\u7f6e\u3059\u308b\u3088\u3046\u306bDockerfile\u5074\u306b\u8a18\u8f09\u3057\u3066\u304a\u3051\u3070OK\u3067\u3059\u3002\n\n```\n[supervisord]\nnodaemon=true\n\n[program:nginx]\ncommand=nginx\n```\n\n\n\n\n#\u8907\u6570\u306e\u30d7\u30ed\u30bb\u30b9\u3092\u52d5\u304b\u3059\u5834\u5408\u306e\u4f7f\u3044\u65b9\nElasticsearch + Fluentd\u3092supervisor\u4e0a\u3067\u52d5\u304b\u3057\u305f\u3044\u3001\u3068\u3044\u3046Case Study\u306e\u5834\u5408\u3001Dockerfile\u306f\u4ee5\u4e0b\u306e\u69d8\u306b\u306a\u308a\u307e\u3059\u3002\n\n```\nFROM ubuntu:14.04\nRUN apt-get update -y\n\n#Install Elasticsearch\nENV ELASTICSEARCH_VERSION elasticsearch-1.4.4\nRUN apt-get install -y curl openjdk-7-jdk\nRUN mkdir /opt/elasticsearch\nRUN curl -sL \"https://download.elasticsearch.org/elasticsearch/elasticsearch/${ELASTICSEARCH_VERSION}.tar.gz\" | tar xz -C /opt/elasticsearch --strip=1\n\n#Install Fluentd and plugins\nRUN apt-get install -y libcurl4-openssl-dev git-core build-essential ruby-dev\nRUN curl -L http://toolbelt.treasuredata.com/sh/install-ubuntu-trusty-td-agent2.sh | sh\nCOPY td-agent.conf /etc/td-agent/td-agent.conf\nRUN ulimit -n 65536\n\n#Install Supervisor and config\nRUN apt-get install -y supervisor\nRUN touch /etc/supervisord.conf\nRUN echo '[supervisord]'  >> /etc/supervisord.conf\nRUN echo 'nodaemon=true'  >> /etc/supervisord.conf\nRUN echo '[program:elasticsearch]'             >> /etc/supervisord.conf\nRUN echo 'command=/opt/elasticsearch/bin/elasticsearch' >> /etc/supervisord.conf\nRUN echo '[program:td-agent]'             >> /etc/supervisord.conf\nRUN echo 'command=/usr/sbin/td-agent' >> /etc/supervisord.conf\n\n# expose port for elasticsearch\nEXPOSE 9200\n\n# expose port for fluentd\nEXPOSE 24224\n\nCMD /usr/bin/supervisord -c /etc/supervisord.conf\n```\n\n#Supervisor\u3067\u6c17\u3092\u3064\u3051\u308b\u3079\u304d\u8a2d\u5b9a\n###\u5404\u30d7\u30ed\u30bb\u30b9\u306e\u6a19\u6e96\u51fa\u529b\u306b\u3064\u3044\u3066\nSupervisor\u306f __Default\u8a2d\u5b9a\u3067\u306f__ \u3001\u5404\u30d7\u30ed\u30bb\u30b9\u304b\u3089\u306e\u6a19\u6e96\u51fa\u529b\u3092\u53d7\u3051\u53d6\u308afile\u306b\u66f8\u304d\u51fa\u3059\u8a2d\u5b9a\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002\u305d\u306e\u305f\u3081\u3001Supervisor\u3092\u7d4c\u7531\u3057\u3066\u5404\u30d7\u30ed\u30bb\u30b9\u3092\u52d5\u304b\u3059\u5834\u5408\u306b\u3001\u5404\u30d7\u30ed\u30bb\u30b9\u306e\u6a19\u6e96\u51fa\u529b\u306e\u5185\u5bb9\u3092\u898b\u308b\u4e8b\u304c\u51fa\u6765\u307e\u305b\u3093\u3002\n\nfile\u3067\u306f\u306a\u304f\u6a19\u6e96\u51fa\u529b\u306b\u66f8\u304d\u51fa\u3057\u305f\u3044\u5834\u5408\u306f\u3001`stdout_logfile`\u3092`/dev/fd/1`\u306b\u8a2d\u5b9a\u3057\u3066\u3042\u3052\u308b\u3068\u826f\u3044\u3067\u3059\u3002\u305f\u3068\u3048\u3070\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u8a2d\u5b9a\u3059\u308b\u3068\u3001td-agent\u306e\u30d7\u30ed\u30bb\u30b9\u304b\u3089\u51fa\u305f\u6a19\u6e96\u51fa\u529b\u306f\u3001(Supervisor\u3092\u7d4c\u7531\u3057\u3066)\u30b7\u30b9\u30c6\u30e0\u5168\u4f53\u306e\u6a19\u6e96\u51fa\u529b\u306bRoute\u3055\u308c\u307e\u3059\u3002\n\n```\n[supervisord]\nnodaemon=true\n\n[program:elasticsearch]\ncommand=/opt/elasticsearch/bin/elasticsearch\n\n[program:td-agent]\ncommand=/usr/sbin/td-agent\nstdout_logfile=/dev/fd/1\nstdout_logfile_maxbytes=0\n```\n", "tags": ["docker", "supervisor"]}