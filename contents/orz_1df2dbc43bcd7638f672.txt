{"tags": ["SoftLayer", "openstack"], "context": " More than 1 year has passed since last update.\u524d\u56de\u306f\u3053\u3061\u3089 - \u6b21\u56de\u306f\u3053\u3061\u3089\n\n\n\u3053\u308c\u306f\u306a\u306b\n\u300cOpenStack\u30af\u30e9\u30a6\u30c9\u30a4\u30f3\u30c6\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3 \u30aa\u30fc\u30d7\u30f3\u30bd\u30fc\u30b9\u30af\u30e9\u30a6\u30c9\u306b\u3088\u308b\u30b5\u30fc\u30d3\u30b9\u69cb\u7bc9\u5165\u9580\u300d\u306e\u5b9f\u7fd2\u3092SoftLayer\u306e\u7121\u6599\u30d9\u30a2\u30e1\u30bf\u30eb\u3067\u884c\u3046\u8a18\u9332\u3067\u3042\u308b\u3002\n\n\n\u7b2c11\u7ae0 Ansible\u3092\u5229\u7528\u3057\u305f\u69cb\u6210\u7ba1\u7406\u306e\u81ea\u52d5\u5316\n\u7b2c10\u7ae0\u307e\u3067\u306fOpenStack\u306e\u6a19\u6e96\u6a5f\u80fd\u306e\u5229\u7528\u3092\u5b66\u7fd2\u3057\u3066\u304d\u305f\u3002\u5f53\u7ae0\u3067\u306fAnsible\u3092\u5229\u7528\u3057\u3001OpenStack\u306e\u904b\u7528\u3092\u52b9\u7387\u5316\u3059\u308b\u3002\n\u5f53\u7ae0\u306e\u652f\u63f4\u30d5\u30a1\u30a4\u30eb\u306f\u3053\u3061\u3089\u3002\n\n11.1 \u30b9\u30c8\u30fc\u30ea\u30fc\u306e\u5c55\u958b\nAnsible\u3067\u904b\u7528\u3092\u6539\u5584\u3057\u3088\u3046\u3068\u3044\u3046\u7ae0\u306e\u30a4\u30f3\u30c8\u30ed\u3002\n\n11.2 Ansible\u306e\u5c0e\u5165\u3068\u8a2d\u5b9a\n\n11.2.1 Ansible\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\nOS\u304c\u63d0\u4f9b\u3059\u308b\u30d1\u30c3\u30b1\u30fc\u30b8\u3001pip\u3001\u30bd\u30fc\u30b9\u30b3\u30fc\u30c9\u304b\u3089\u30d3\u30eb\u30c9\u30683\u3064\u306e\u5c0e\u5165\u65b9\u6cd5\u304c\u3042\u308b\u3002\u305d\u306e3\u3064\u306e\u65b9\u6cd5\u306e\u8aac\u660e\u3002\n\u3060\u305f\u3057\u3001\u672c\u66f8\u306e\u8a18\u8ff0\u306f\u305d\u306e\u5148\u3067pip\u304b\u3089\u306e\u5c0e\u5165\u3092\u60f3\u5b9a\u3057\u3066\u3044\u308b\u306e\u3067\u3001\u305d\u308c\u306b\u3042\u308f\u305b\u308b\u3053\u3068\u3068\u3059\u308b\u3002\n\u30ac\u30a4\u30c9\u3055\u308c\u3066\u3044\u308b\u306e\u306f\u30d1\u30c3\u30b1\u30fc\u30b8\u30b0\u30eb\u30fc\u30d7\u300cDevelopment Tools\u300d\u3068\u30d1\u30c3\u30b1\u30fc\u30b8\u300cpython-virtualenv\u300d\u306e\u5c0e\u5165\u3002\n[root@step-server ~]# yum groupinstall -y \"Development Tools\"\n\uff5e\uff5e\uff5e\uff5e\uff5e\uff5e\uff5e\uff5e\nComplete!\n[root@step-server ~]# yum install -y python-virtualenv\n\uff5e\uff5e\uff5e\uff5e\uff5e\uff5e\uff5e\uff5e\nComplete!\n\n\u3053\u306e\u5f8c\u3001\u4e00\u822c\u30e6\u30fc\u30b6\u30fc\u304b\u3089\u4f5c\u696d\u3092\u3059\u308b\u3068\u3042\u308b\u306e\u3067\u3001\u4e00\u822c\u30e6\u30fc\u30b6\u30fc user01 \u3092\u4f5c\u6210\u3057\u5207\u308a\u66ff\u3048\u308b\u3002\n[root@step-server ~]# adduser user01\n[root@step-server ~]# su - user01\n\n\u4e00\u822c\u30e6\u30fc\u30b6\u30fc user01 \u3067python\u306e\u4eee\u60f3\u5b9f\u884c\u74b0\u5883\u306b\u5207\u308a\u66ff\u3048ansible\u3092\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u3002\n[user01@step-server ~]$ virtualenv venv\nNew python executable in venv/bin/python\nInstalling Setuptools..............................................................................................................................................................................................................................done.\nInstalling Pip.....................................................................................................................................................................................................................................................................................................................................done.\n[user01@step-server ~]$ source venv/bin/activate\n\n(venv)[user01@step-server ~]$ pip install jinja2 passlib pycrypto pyyaml\nDownloading/unpacking jinja2\n\uff5e\uff5e\uff5e\uff5e\uff5e\uff5e\uff5e\uff5e\nSuccessfully installed jinja2 passlib pycrypto pyyaml markupsafe\nCleaning up...\n\n(venv)[user01@step-server ~]$ pip install ansible\nDownloading/unpacking ansible\n  Downloading ansible-1.9.0.1.tar.gz (916kB): 916kB downloaded\n\uff5e\uff5e\uff5e\uff5e\uff5e\uff5e\uff5e\uff5e\nSuccessfully installed ansible paramiko ecdsa\nCleaning up...\n\n(venv)[user01@step-server ~]$ ansible --version\nansible 1.9.0.1\n  configured module search path = None\n\n1.9.0.1\u304c\u5c0e\u5165\u3055\u308c\u305f\u3002\u672c\u66f8\u3067\u306f1.8.2\u3067\u78ba\u8a8d\u3092\u3057\u3066\u3044\u308b\u3068\u3042\u308b\u3002\n\n11.2.2 Ansible\u306e\u57fa\u672c\u8a2d\u5b9a\n$HOME/.ansible.cfg\u306b\u57fa\u672c\u8a2d\u5b9a\u3092\u8a18\u8ff0\u3059\u308b\u3002\nlog\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u30fc\u3092\u4f5c\u308b\u3002\n(venv)[user01@step-server ~]$ mkdir $HOME/log\n\n$HOME/.ansible.cfg\u3092\u8a2d\u5b9a\u3059\u308b\u3002\n(venv)[user01@step-server ~]$ nano .ansible.cfg\n(venv)[user01@step-server ~]$ cat .ansible.cfg\n[defaults]\nforks                   = 10\nlog_path                = /home/user01/log/ansible.log\nhost_key_checking       = False\ngathering               = smart\ntransport               = smart\n\n\n11.2.3 Ansible\u306e\u52d5\u4f5c\u78ba\u8a8d\nAnsible\u3067localhost \u306bping\u3092\u6253\u3063\u3066\u307f\u308b\u3002\n(venv)[user01@step-server ~]$ cd\n(venv)[user01@step-server ~]$ pwd\n/home/user01\n(venv)[user01@step-server ~]$ echo \"localhost ansible_connection=local\" > ansible_hosts\n(venv)[user01@step-server ~]$ ansible all -i ansible_hosts -m ping\nlocalhost | success >> {\n    \"changed\": false,\n    \"ping\": \"pong\"\n}\n\nansible_hosts\u306b192.168.0.11\u3068192.168.0.21\u3092\u8db3\u3059\u3002192.168.0.11\u306e\u30db\u30b9\u30c8\u306f\u5b58\u5728\u3057\u306a\u3044\u3002192.168.0.21\u306f\u7b2c10\u7ae0\u3067\u751f\u304d\u6b8b\u3063\u305faz2-dbs01\u306e\u30a2\u30c9\u30ec\u30b9\u3067\u3042\u308b\u3002\n(venv)[user01@step-server ~]$ nano ansible_hosts\n(venv)[user01@step-server ~]$ cat ansible_hosts\nlocalhost ansible_connection=local\n192.168.0.11\n192.168.0.21\n\nAnsible\u306f\u3001\u57fa\u672c\u7684\u306bssh\u3067\u63a5\u7d9a\u3057\u3066\u64cd\u4f5c\u3059\u308b\u3002\nlocalhost\u306f\u300cansible_connection=local\u300d\u306a\u306e\u3067ssh\u63a5\u7d9a\u305b\u305a\u306b\u5b9f\u884c\u3057success\u3059\u308b\u3002\n192.168.0.21\u306f\u3001ssh\u3067TCP\u63a5\u7d9a\u306f\u3057\u305f\u304c\u30ed\u30b0\u30a4\u30f3\u3067\u304d\u306a\u304b\u3063\u305f\u305f\u3081\u306b\u30a8\u30e9\u30fc\u306b\u306a\u3063\u305f\u3002\n192.168.0.11\u306f\u3001\u3053\u306eIP\u3067\u30b5\u30fc\u30d0\u30fc\u304c\u8d77\u52d5\u3057\u3066\u3044\u306a\u3044\u306e\u3067ssh\u3067\u306eTCP\u63a5\u7d9a\u3067\u30a8\u30e9\u30fc\u306b\u306a\u3063\u305f\u3002\n(venv)[user01@step-server ~]$ ansible all -i ansible_hosts -m ping\nlocalhost | success >> {\n    \"changed\": false,\n    \"ping\": \"pong\"\n}\n\n192.168.0.21 | FAILED => SSH Error: Permission denied (publickey,gssapi-keyex,gssapi-with-mic).\n    while connecting to 192.168.0.21:22\nIt is sometimes useful to re-run the command using -vvvv, which prints SSH debug output to help diagnose the issue.\n192.168.0.11 | FAILED => SSH Error: ssh: connect to host 192.168.0.11 port 22: No route to host\n    while connecting to 192.168.0.11:22\nIt is sometimes useful to re-run the command using -vvvv, which prints SSH debug output to help diagnose the issue.\n\nssh\u3067192.168.0.21\u306b\u30ed\u30b0\u30a4\u30f3\u3067\u304d\u308b\u3088\u3046\u306b\u3059\u308b\u3002ssh\u306e\u79d8\u5bc6\u9375\u3092/home/user01/\u306b\u30b3\u30d4\u30fc\u3057\u3001\u30aa\u30fc\u30ca\u30fc\u3092user01\u306b\u3059\u308b\u3002\n[root@step-server ~]# cp key-for-internal.pem /home/user01/\n[root@step-server ~]# cd /home/user01\n[root@step-server user01]# chown user01 key-for-internal.pem\n[root@step-server user01]# ls -al key-for-internal.pem\n-rw------- 1 user01 root 1680 Mar 29 18:03 key-for-internal.pem\n\n.ansible.cfg\u306eprivate_key_file\u306b\u79d8\u5bc6\u9375\u3092\u30d5\u30eb\u30d1\u30b9\u3067\u8a2d\u5b9a\u3059\u308b\u3002\n(venv)[user01@step-server ~]$ cat .ansible.cfg\n[defaults]\nforks                   = 10\nlog_path                = /home/user01/log/ansible.log\nhost_key_checking       = False\ngathering               = smart\ntransport               = smart\nprivate_key_file        = /home/user01/key-for-internal.pem\n\nansible\u3092\u5b9f\u884c\u3059\u308b\u3068\u304d\u300c-u root\u300d\u3092\u6307\u5b9a\u3057\u3001\u76f8\u624b\u306broot\u3067\u5165\u308b\u4e8b\u3092\u5ba3\u8a00\u3059\u308b\u3002\n/home/user01/key-for-internal.pem\u3067root@192.168.0.21\u306b\u63a5\u7d9a\u3067\u304d\u3001ping\u304c\u6210\u529f\u3057\u305f\u3002\n192.168.0.11\u304c\u5931\u6557\u3059\u308b\u306e\u306f\u5f53\u7136\u3002\n(venv)[user01@step-server ~]$ ansible all -i ansible_hosts -m ping -u root\nlocalhost | success >> {\n    \"changed\": false,\n    \"ping\": \"pong\"\n}\n\n192.168.0.21 | success >> {\n    \"changed\": false,\n    \"ping\": \"pong\"\n}\n\n192.168.0.11 | FAILED => SSH Error: ssh: connect to host 192.168.0.11 port 22: No route to host\n    while connecting to 192.168.0.11:22\nIt is sometimes useful to re-run the command using -vvvv, which prints SSH debug output to help diagnose the issue.\n\n\u5bfe\u8c61\u3092\u300call:!192.168.0.11\u300d\u3068\u3059\u308b\u3002\u300c!\u300d\u3067192.168.0.11\u3092\u9664\u3044\u305f\u300call\u300d\u304c\u5bfe\u8c61\u3068\u306a\u308b\u3002\n192.168.0.11\u304c\u5bfe\u8c61\u304b\u3089\u9664\u5916\u3055\u308c\u305f\u306e\u3067\u3001\u5bfe\u8c61\u5168\u3066\u306b\u6b63\u5e38\u306bping\u5fdc\u7b54\u304c\u78ba\u8a8d\u3067\u304d\u305f\u3002\n(venv)[user01@step-server ~]$ ansible 'all:!192.168.0.11' -i ansible_hosts -m ping -u root\nlocalhost | success >> {\n    \"changed\": false,\n    \"ping\": \"pong\"\n}\n\n192.168.0.21 | success >> {\n    \"changed\": false,\n    \"ping\": \"pong\"\n}\n\n\n11.3 Ansible\u306e\u4ed5\u7d44\u307f\n\u7bc0\u306e\u30bf\u30a4\u30c8\u30eb\u306e\u3068\u304a\u308aAnsible\u306e\u4ed5\u7d44\u307f\u306e\u89e3\u8aac\u3067\u3042\u308b\u3002\n\u3053\u306e\u30db\u30b9\u30c8\u540d\u3092\u5909\u66f4\u3059\u308b\u30d7\u30ec\u30a4\u30d6\u30c3\u30af\u306e\u5b9f\u884c\u3067\u52d5\u4f5c\u3092\u78ba\u8a8d\u3059\u308b\u3002\n(venv)[user01@step-server samples]$ ansible-playbook -i ~/ansible_hosts -u root -e target=192.168.0.21 sample-11-1.yml\n\nPLAY [192.168.0.21] ***********************************************************\n\nGATHERING FACTS ***************************************************************\nok: [192.168.0.21]\n\nTASK: [get hostname] **********************************************************\nchanged: [192.168.0.21]\n\nTASK: [set hostname] **********************************************************\nchanged: [192.168.0.21]\n\nNOTIFIED: [show hostname] *****************************************************\nok: [192.168.0.21] => {\n    \"msg\": \"before=az2-dbs01 after=ansible-host1\"\n}\n\nPLAY RECAP ********************************************************************\n192.168.0.21               : ok=4    changed=2    unreachable=0    failed=0\n\n\naz2-dbs01 \u304b\u3089 ansible-host1 \u306b\u30db\u30b9\u30c8\u540d\u304c\u5909\u66f4\u3055\u308c\u305f\u3002\n\u3082\u3046\u4e00\u5ea6\u3001\u5b9f\u884c\u3059\u308b\u3002\n(venv)[user01@step-server samples]$ ansible-playbook -i ~/ansible_hosts -u root -e target=192.168.0.21 sample-11-1.yml\n\nPLAY [192.168.0.21] ***********************************************************\n\nGATHERING FACTS ***************************************************************\nok: [192.168.0.21]\n\nTASK: [get hostname] **********************************************************\nchanged: [192.168.0.21]\n\nTASK: [set hostname] **********************************************************\nok: [192.168.0.21]\n\nPLAY RECAP ********************************************************************\n192.168.0.21               : ok=3    changed=1    unreachable=0    failed=0\n\n\n\u3059\u3067\u306b\u30db\u30b9\u30c8\u540d\u304c\u5909\u66f4\u3055\u308c\u3066\u3044\u308b\u305f\u3081\u3001handlers\u306f\u547c\u3073\u51fa\u3055\u308c\u305a\u300cNOTIFIED: [show hostname]\u300d\u306f\u547c\u3073\u51fa\u3055\u308c\u306a\u3044\u3002\n\n14.4 Ansible\u306b\u3088\u308b\u57fa\u672c\u64cd\u4f5c\u306e\u81ea\u52d5\u5316\n\n14.4.1 CenrOS\u306e\u30d1\u30c3\u30b1\u30fc\u30b8\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb/\u30a2\u30c3\u30d7\u30c7\u30fc\u30c8\u3059\u308b\n\u30d1\u30c3\u30b1\u30fc\u30b8\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb/\u30a2\u30c3\u30d7\u30c7\u30fc\u30c8\u3059\u308b\u3002\u5229\u7528\u3059\u308b\u30d7\u30ec\u30a4\u30d6\u30c3\u30af\u306f\u3053\u3061\u3089\u3002\n(venv)[user01@step-server samples]$ ansible-playbook -i ~/ansible_hosts -u root -e target=192.168.0.21 sample-11-2.yml\n\nPLAY [192.168.0.21] ***********************************************************\n\nGATHERING FACTS ***************************************************************\nok: [192.168.0.21]\n\nTASK: [install or upgrade packages] *******************************************\nchanged: [192.168.0.21] => (item=bash,tcsh,zsh)\n\nPLAY RECAP ********************************************************************\n192.168.0.21               : ok=2    changed=1    unreachable=0    failed=0\n\n\n\n11.4.2 \u30e6\u30fc\u30b6\u30fc\u30a2\u30ab\u30a6\u30f3\u30c8\u3092\u4f5c\u6210\u3059\u308b\n\u5bfe\u8c61\u30db\u30b9\u30c8\u306b\u30e6\u30fc\u30b6\u30fcansible\u3092\u4f5c\u6210\u3059\u308b\u3002\u5229\u7528\u3059\u308b\u30d7\u30ec\u30a4\u30d6\u30c3\u30af\u306f\u3053\u3061\u3089\u3002\n(venv)[user01@step-server samples]$ ansible-playbook -i ~/ansible_hosts -u root -e target=192.168.0.21 sample-11-3.yml\nEnter a new user's password:\nconfirm Enter a new user's password:\n***** VALUES ENTERED DO NOT MATCH ****\nEnter a new user's password:\nconfirm Enter a new user's password:\n\nPLAY [192.168.0.21] ***********************************************************\n\nGATHERING FACTS ***************************************************************\nok: [192.168.0.21]\n\nTASK: [add a new user on target host] *****************************************\nchanged: [192.168.0.21]\n\nTASK: [add a publickey on localhost to authorized_keys on target host] ********\nfatal: [192.168.0.21] => could not locate file in lookup: /root/.ssh/id_rsa.pub\n\nFATAL: all hosts have already failed -- aborting\n\nPLAY RECAP ********************************************************************\n           to retry, use: --limit @/home/user01/sample-11-3.retry\n\n192.168.0.21               : ok=2    changed=1    unreachable=1    failed=0\n\n\n\u30d1\u30b9\u30ef\u30fc\u30c9\u306e\u518d\u5165\u529b\u3067\u30df\u30b9\u3057\u305f\u3089\u518d\u5ea6\u5165\u529b\u3092\u6c42\u3081\u3089\u308c\u305f\u3002\n\u300c/root/.ssh/id_rsa.pub\u300d\u3078\u306e\u30a2\u30af\u30bb\u30b9\u3067\u30a8\u30e9\u30fc\u306b\u306a\u3063\u3066\u3044\u308b\u3002\u672c\u66f8\u3092\u3001\u3088\u304f\u8aad\u3080\u3068\u3001\u4e8b\u524d\u306bssh-keygen\u3067\u4f5c\u6210\u3057\u3066\u304a\u3044\u305f\u516c\u958b\u9375\u3092\u6307\u5b9a\u3059\u308b\u3068\u3042\u308b\u3002\n\u300c/home/user01/.ssh/id_rsa.pub\u300d\u3092\u4f5c\u308b\u3002\n(venv)[user01@step-server samples]$ ssh-keygen -t rsa\nGenerating public/private rsa key pair.\nEnter file in which to save the key (/home/user01/.ssh/id_rsa):\nEnter passphrase (empty for no passphrase):\nEnter same passphrase again:\nYour identification has been saved in /home/user01/.ssh/id_rsa.\nYour public key has been saved in /home/user01/.ssh/id_rsa.pub.\nThe key fingerprint is:\n74:11:82:b0:f5:aa:c2:0f:cf:b8:45:f4:d6:26:44:7a user01@step-server\nThe key's randomart image is:\n+--[ RSA 2048]----+\n|    ..o.. o.     |\n|     =.. . .     |\n|    + E o .      |\n|   . + + .       |\n|    . = S        |\n| . . o o         |\n|  + o            |\n|   O             |\n|  o.+            |\n+-----------------+\n\n\u516c\u958b\u9375\u306e\u30d5\u30a1\u30a4\u30eb\u540d\u3092\u66f8\u304d\u63db\u3048\u308b\u3002\n    authorized_key:\n      user: \"{{ username }}\"\n      key: \"{{ lookup('file', '/home/user01/.ssh/id_rsa.pub') }}\"\n\n\u4eca\u5ea6\u306f\u6210\u529f\u3057\u305f\u3002\n(venv)[user01@step-server samples]$ ansible-playbook -i ~/ansible_hosts -u root -e target=192.168.0.21 sample-11-3.yml\nEnter a new user's password:\nconfirm Enter a new user's password:\n\nPLAY [192.168.0.21] ***********************************************************\n\nGATHERING FACTS ***************************************************************\nok: [192.168.0.21]\n\nTASK: [add a new user on target host] *****************************************\nchanged: [192.168.0.21]\n\nTASK: [add a publickey on localhost to authorized_keys on target host] ********\nchanged: [192.168.0.21]\n\nPLAY RECAP ********************************************************************\n192.168.0.21               : ok=3    changed=2    unreachable=0    failed=0\n\nssh\u30ed\u30b0\u30a4\u30f3\u304c\u53ef\u80fd\u306b\u306a\u3063\u3066\u3044\u308b\u3002\n(venv)[user01@step-server samples]$ ssh ansible@192.168.0.21\n[ansible@ansible-host1 ~]$ exit\nlogout\nConnection to 192.168.0.21 closed.\n\n\n11.4.3 sudo\u306e\u8a2d\u5b9a\u3092\u8ffd\u52a0\u3059\u308b\n\u300c/etc/sudoers\u300d\u306bansible\u304c\u6240\u5c5e\u3059\u308bwheel\u3092\u8ffd\u52a0\u3059\u308b\u3002\u8ffd\u52a0\u3059\u308b\u306e\u306f\u5b58\u5728\u3057\u306a\u3044\u5834\u5408\u3060\u3051\u3002\u5229\u7528\u3059\u308b\u30d7\u30ec\u30a4\u30d6\u30c3\u30af\u306f\u3053\u3061\u3089\u3002\n\u4e00\u5ea6\u76ee\u306f\u3001\u30a8\u30f3\u30c8\u30ea\u30fc\u304c\u7121\u3044\u306e\u3067\u300cTASK: [grant privileges to do the sudo command to the wheel group]\u300d\u304c\u300cchanged\u300d\u306b\u306a\u308b\u3002\n(venv)[user01@step-server samples]$ ansible-playbook -i ~/ansible_hosts -u root -e target=192.168.0.21 sample-11-4.yml\n\nPLAY [192.168.0.21] ***********************************************************\n\nGATHERING FACTS ***************************************************************\nok: [192.168.0.21]\n\nTASK: [grant privileges to do the sudo command to the wheel group] ************\nchanged: [192.168.0.21]\n\nPLAY RECAP ********************************************************************\n192.168.0.21               : ok=2    changed=1    unreachable=0    failed=0\n\n\u518d\u5ea6\u5b9f\u884c\u3059\u308b\u3068\u5b58\u5728\u3059\u308b\u306e\u3067\u300cok\u300d\u3068\u8868\u793a\u3055\u308c\u3001\u8ffd\u52a0\u306f\u884c\u308f\u308c\u306a\u3044\u3002\n(venv)[user01@step-server samples]$ ansible-playbook -i ~/ansible_hosts -u root -e target=192.168.0.21 sample-11-4.yml\n\nPLAY [192.168.0.21] ***********************************************************\n\nGATHERING FACTS ***************************************************************\nok: [192.168.0.21]\n\nTASK: [grant privileges to do the sudo command to the wheel group] ************\nok: [192.168.0.21]\n\nPLAY RECAP ********************************************************************\n192.168.0.21               : ok=2    changed=0    unreachable=0    failed=0\n\n\n11.4.4 \u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092\u914d\u7f6e\u3057\u3066\u30b5\u30fc\u30d3\u30b9\u3092\u30ea\u30b9\u30bf\u30fc\u30c8\u3059\u308b\u3002\n\u7528\u610f\u3057\u3066\u3042\u308bmy.cnf.j2\u3092/etc/my.cnf\u306b\u30b3\u30d4\u30fc\u3059\u308b\u3002\u30d5\u30a1\u30a4\u30eb\u306e\u7f6e\u304d\u63db\u3048\u304c\u767a\u751f\u3057\u305f\u3068\u304d\u3060\u3051\u3001MySQL\u3092\u30ea\u30b9\u30bf\u30fc\u30c8\u3059\u308b\u3002\u5229\u7528\u3059\u308b\u30d7\u30ec\u30a4\u30d6\u30c3\u30af\u306f\u3053\u3061\u3089\u3002\n\u4e00\u5ea6\u76ee\u306f[replace my.cnf]\u304cchanged\u3067\u3001[restart database]\u304c\u547c\u3073\u51fa\u3055\u308c\u3066\u3044\u308b\u3002\n(venv)[user01@step-server samples]$ ansible-playbook -i ~/ansible_hosts -u root -e target=192.168.0.21 sample-11-5.yml\n\nPLAY [192.168.0.21] ***********************************************************\n\nGATHERING FACTS ***************************************************************\nok: [192.168.0.21]\n\nTASK: [replace my.cnf] ********************************************************\nchanged: [192.168.0.21]\n\nNOTIFIED: [restart database] **************************************************\nchanged: [192.168.0.21]\n\nPLAY RECAP ********************************************************************\n192.168.0.21               : ok=3    changed=2    unreachable=0    failed=0\n\n2\u5ea6\u76ee\u306f[replace my.cnf]\u304cok\u3067\u3001[restart database]\u306f\u547c\u3073\u51fa\u3055\u306a\u3044\u3002\n(venv)[user01@step-server samples]$ ansible-playbook -i ~/ansible_hosts -u root -e target=192.168.0.21 sample-11-5.yml\n\nPLAY [192.168.0.21] ***********************************************************\n\nGATHERING FACTS ***************************************************************\nok: [192.168.0.21]\n\nTASK: [replace my.cnf] ********************************************************\nok: [192.168.0.21]\n\nPLAY RECAP ********************************************************************\n192.168.0.21               : ok=2    changed=0    unreachable=0    failed=0\n\n\n11.4.5 OS\u3092\u518d\u8d77\u52d5\u3057\u3066\u8d77\u52d5\u5b8c\u4e86\u3092\u78ba\u8a8d\u3059\u308b\u3002\n\u5bfe\u8c61\u3092reboot\u30572\u5206\u5f85\u3063\u3066\u304b\u308910\u79d2\u9593\u9694\u3067ssh\u63a5\u7d9a\u3067\u304d\u308b\u304b\u78ba\u8a8d\u3059\u308b\u3002\u5229\u7528\u3059\u308b\u30d7\u30ec\u30a4\u30d6\u30c3\u30af\u306f\u3053\u3061\u3089\u3002\npause\u30e2\u30b8\u30e5\u30fc\u30eb\u3067\u505c\u6b62\u4e2d\u306e\u5834\u5408\u300c(^C-c = continue early, ^C-a = abort)\u300d\u306e\u8868\u793a\u3067\u308f\u304b\u308b\u3088\u3046\u306b\u300cCtrl+C\u300d\u3067\u300cAction? (a)bort/(c)ontinue:\u300d\u306e\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u51fa\u3057\u4e2d\u6b62\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u308b\u3002\n(venv)[user01@step-server samples]$ ansible-playbook -i ~/ansible_hosts -u root -e target=192.168.0.21 sample-11-6.yml\n\nPLAY [192.168.0.21] ***********************************************************\n\nGATHERING FACTS ***************************************************************\nok: [192.168.0.21]\n\nTASK: [reboot server] *********************************************************\nchanged: [192.168.0.21]\n\nTASK: [wait for shutdown process] *********************************************\n(^C-c = continue early, ^C-a = abort)\n[192.168.0.21]\nPausing for 120 seconds\n^C\nAction? (a)bort/(c)ontinue:\nok: [192.168.0.21 -> 127.0.0.1]\n\nTASK: [check the server to start up] ******************************************\nok: [192.168.0.21 -> 127.0.0.1]\n\nPLAY RECAP ********************************************************************\n192.168.0.21               : ok=4    changed=1    unreachable=0    failed=0\n\npause\u30e2\u30b8\u30e5\u30fc\u30eb\u3067\u306e\u505c\u6b62\u4e2d\u3092\u5f85\u305f\u306a\u3044\u3067\u300cCtrl+C\u300d\u3092\u62bc\u3057\u305f\u3089\u3001\u7d42\u4e86\u3057\u3066\u3057\u307e\u3063\u305f\u3002\nTASK: [reboot server] *********************************************************\n^CERROR: interrupted\n(venv)[user01@step-server samples]$\n\n\n11.5 OpenStack\u7ba1\u7406\u4f5c\u696d\u306e\u81ea\u52d5\u5316\n\n11.5.1 \u4e8b\u524d\u6e96\u5099\u4f5c\u696d\n\u8e0f\u307f\u53f0\u30b5\u30fc\u30d0\u30fc\u3067\u30e6\u30fc\u30b6\u30fcansible\u3092\u4f5c\u6210\u3057\u3066\u5207\u308a\u66ff\u3048\u308b\u3002\n[root@step-server ~]# useradd ansible\n[root@step-server ~]# cp /root/openrc /home/ansible/\n[root@step-server ~]# chown ansible:ansible /home/ansible/openrc\n[root@step-server ~]# su - ansible\n[ansible@step-server ~]$\n\n\u30e6\u30fc\u30b6\u30fcansible\u3067ansible\u3092pip\u306b\u3088\u308b\u5c0e\u5165\u3059\u308b\u3002\n[ansible@step-server ~]$ virtualenv venv\nNew python executable in venv/bin/python\nInstalling Setuptools.............................................................................................done.\nInstalling Pip....................................................................................................................................done.\n\n[ansible@step-server ~]$ source venv/bin/activate\n\n(venv)[ansible@step-server ~]$ pip install jinja2 passlib pycrypto pyyaml\nDownloading/unpacking jinja2\n\uff5e\uff5e\uff5e\uff5e\uff5e\uff5e\uff5e\uff5e\nSuccessfully installed jinja2 passlib pycrypto pyyaml markupsafe\nCleaning up...\n\n(venv)[ansible@step-server ~]$ pip install ansible\nDownloading/unpacking ansible\n  Downloading ansible-1.9.0.1.tar.gz (916kB): 916kB downloaded\n\uff5e\uff5e\uff5e\uff5e\uff5e\uff5e\uff5e\uff5e\nSuccessfully installed ansible paramiko ecdsa\nCleaning up...\n\n\u672c\u66f8\u306e\u652f\u63f4\u30d5\u30a1\u30a4\u30eb\u3068python-novaclient\u3001python-novaclient\u3092\u5c0e\u5165\u3059\u308b\u3002\n(venv)[ansible@step-server ~]$ cd $HOME\n\n(venv)[ansible@step-server ~]$ git clone https://github.com/josug-book1-materials/chapter11.git\nInitialized empty Git repository in /home/ansible/chapter11/.git/\nremote: Counting objects: 218, done.\nremote: Total 218 (delta 0), reused 0 (delta 0), pack-reused 218\nReceiving objects: 100% (218/218), 32.98 KiB, done.\nResolving deltas: 100% (116/116), done.\n\n(venv)[ansible@step-server ~]$ pip install python-novaclient==2.16.0\nDownloading/unpacking python-novaclient==2.16.0\n  Downloading python-novaclient-2.16.0.tar.gz (227kB): 227kB downloaded\n\uff5e\uff5e\uff5e\uff5e\uff5e\uff5e\uff5e\uff5e\nSuccessfully installed python-novaclient pbr argparse iso8601 PrettyTable requests simplejson six Babel pytz\nCleaning up..\n\n(venv)[ansible@step-server ~]$ pip install python-neutronclient==2.3.4\nDownloading/unpacking python-neutronclient==2.3.4\n  Downloading python-neutronclient-2.3.4.tar.gz (105kB): 105kB downloaded\n\uff5e\uff5e\uff5e\uff5e\uff5e\uff5e\uff5e\uff5e\nSuccessfully installed python-neutronclient cliff httplib2 cmd2 pyparsing stevedore\nCleaning up...\n\noprnrc\u306b\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u306eUUID\u3092\u53d6\u5f97\u3059\u308b\u90e8\u5206\u3092\u52a0\u3048\u3053\u306e\u69d8\u306b\u3057\u3001\u5b9f\u884c\u3059\u308b\u3002\n(venv)[ansible@step-server ~]$ cat openrc\nexport OS_AUTH_URL=http://192.168.100.10:5000/v2.0/\nexport OS_REGION_NAME=RegionOne\nexport OS_TENANT_NAME=SNSApp\nexport OS_USERNAME=snsapp-infra-user\nexport OS_PASSWORD=passw0rd\n\nfunction get_uuid () { cat - | grep \" id \" | awk '{print $4}'; }\nexport OS_DMZ_NET=`neutron net-show dmz-net | get_uuid`\nexport OS_APP_NET=`neutron net-show app-net | get_uuid`\nexport OS_DBS_NET=`neutron net-show dbs-net | get_uuid`\n\n(venv)[ansible@step-server ~]$ source openrc\n\n\u30ad\u30fc\u30da\u30a2\u3092\u4f5c\u6210\u3057OpenStack\u306b\u767b\u9332\u3059\u308b\u3002\n(venv)[ansible@step-server ~]$ ssh-keygen -t rsa -b 2048 -N \"\"\nGenerating public/private rsa key pair.\nEnter file in which to save the key (/home/ansible/.ssh/id_rsa):\nCreated directory '/home/ansible/.ssh'.\nYour identification has been saved in /home/ansible/.ssh/id_rsa.\nYour public key has been saved in /home/ansible/.ssh/id_rsa.pub.\nThe key fingerprint is:\na1:49:c1:a2:6d:db:3b:bb:d9:91:50:88:0a:0d:53:1f ansible@step-server\nThe key's randomart image is:\n+--[ RSA 2048]----+\n|o.. E..          |\n| + ..o.o         |\n|. .oo.o o        |\n| ...o. + .       |\n|  .. o+ S        |\n|    . .. .       |\n|       .o        |\n|      oo .       |\n|      ++.        |\n+-----------------+\n\n(venv)[ansible@step-server ~]$ nova keypair-add --pub-key .ssh/id_rsa.pub key-for-ansible\n\n(venv)[ansible@step-server ~]$ nova keypair-list\n+---------------------+-------------------------------------------------+\n| Name                | Fingerprint                                     |\n+---------------------+-------------------------------------------------+\n| key-for-step-server | c6:a2:cd:b5:ee:0b:29:ae:19:61:27:f8:5d:28:5f:8b |\n| key-for-internal    | 9d:89:c8:a7:c6:4b:f1:23:8c:41:9f:3f:a8:bf:91:77 |\n| key-for-ansible     | a1:49:c1:a2:6d:db:3b:bb:d9:91:50:88:0a:0d:53:1f |\n+---------------------+-------------------------------------------------+\n\n\n11.5.2 \u4eee\u60f3\u30de\u30b7\u30f3\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u69cb\u7bc9\u306e\u81ea\u52d5\u5316\nweb\u3001app\u3001dbs\u3068\u5f79\u5272\u3092\u6307\u5b9a\u3059\u308b\u3068\u3001\u305d\u306e\u5f79\u5272\u306e\u4eee\u60f3\u30de\u30b7\u30f3\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u69cb\u7bc9\u3059\u308b\u3002\u30d7\u30ec\u30a4\u30d6\u30c3\u30af\u306f\u3053\u3061\u3089\u3002\n\u30d7\u30ec\u30a4\u30d6\u30c3\u30af\u3092\u30db\u30fc\u30e0\u306b\u30b3\u30d4\u30fc\u3057\u3001\u30ed\u30fc\u30ab\u30eb\u63a5\u7d9a\u306bssh\u3092\u4f7f\u308f\u306a\u3044\u3053\u3068\u3092\u5ba3\u8a00\u3059\u308b\u30fb\n(venv)[ansible@step-server ~]$ cd\n\n(venv)[ansible@step-server ~]$ cp chapter11/playbooks/book1/create_sample_vm.yml .\n\n(venv)[ansible@step-server ~]$ echo \"localhost ansible_connection=local\" > ansible_hosts\n\n\u300ctarget=web\u300d\u3092\u6307\u5b9a\u3057\u3066\u30d7\u30ec\u30a4\u30d6\u30c3\u30af\u3092\u5b9f\u884c\u3059\u308b\u3002\n(venv)[ansible@step-server ~]$ ansible-playbook -i ansible_hosts -e target=web create_sample_vm.yml\n\nPLAY [localhost] **************************************************************\n\nGATHERING FACTS ***************************************************************\nok: [localhost]\n\nTASK: [ansible_python_interpreter setup] **************************************\nok: [localhost]\n\nTASK: [get uuid for generate hostname] ****************************************\nchanged: [localhost]\n\nTASK: [create {{ target }}-server on nova-compute with floating_ip] ***********\nchanged: [localhost]\n\nTASK: [create {{ target }}-server on nova-compute without floating_ip] ********\nskipping: [localhost]\n\nPLAY RECAP ********************************************************************\nlocalhost                  : ok=4    changed=2    unreachable=0    failed=0\n\n\n\u30b5\u30fc\u30d0\u30fc\u304c\u4f5c\u6210\u3055\u308cFloating IP\u3082\u4ed8\u4e0e\u3055\u308c\u3066\u3044\u308b\u3002\n(venv)[ansible@step-server ~]$ nova list --name ^web- --field name,networks\n+--------------------------------------+------------------------------------------+-------------------------------------------------------------+\n| ID                                   | Name                                     | Networks                                                    |\n+--------------------------------------+------------------------------------------+-------------------------------------------------------------+\n| 0055b5ed-5180-4b06-8805-c8b6205040dd | web-520710f9-08d3-41cd-9d28-aa6cc4bfca66 | dmz-net=192.168.0.22, 192.168.100.135; app-net=172.16.10.15 |\n+--------------------------------------+------------------------------------------+-------------------------------------------------------------+\n\n(venv)[ansible@step-server ~]$ nova floating-ip-list\n+-----------------+-----------+--------------+---------+\n| Ip              | Server Id | Fixed Ip     | Pool    |\n+-----------------+-----------+--------------+---------+\n| 192.168.100.135 |           | 192.168.0.22 | Ext-Net |\n| 192.168.100.131 |           | 10.0.0.1     | Ext-Net |\n| 192.168.100.134 |           | 192.168.0.19 | Ext-Net |\n| 192.168.100.133 |           | 192.168.0.5  | Ext-Net |\n+-----------------+-----------+--------------+---------+\n\n\u300ctarget=app\u300d\u3067\u4f5c\u6210\u3002\n(venv)[ansible@step-server ~]$ ansible-playbook -i ansible_hosts -e target=app create_sample_vm.yml\n\nPLAY [localhost] **************************************************************\n\nGATHERING FACTS ***************************************************************\nok: [localhost]\n\nTASK: [ansible_python_interpreter setup] **************************************\nok: [localhost]\n\nTASK: [get uuid for generate hostname] ****************************************\nchanged: [localhost]\n\nTASK: [create {{ target }}-server on nova-compute with floating_ip] ***********\nskipping: [localhost]\n\nTASK: [create {{ target }}-server on nova-compute without floating_ip] ********\nchanged: [localhost]\n\nPLAY RECAP ********************************************************************\nlocalhost                  : ok=4    changed=2    unreachable=0    failed=0\n\n\u4f5c\u6210\u3055\u308c\u305f\u3002\n(venv)[ansible@step-server ~]$ nova list --name ^app- --field name,networks\n+--------------------------------------+------------------------------------------+-----------------------------------------------------------------+\n| ID                                   | Name                                     | Networks                                                        |\n+--------------------------------------+------------------------------------------+-----------------------------------------------------------------+\n| ab7c19c6-6f4f-438e-8cdf-012dbb7a4cc1 | app-18e1b380-a213-4518-a3ae-30ccad545014 | dmz-net=192.168.0.23; app-net=172.16.10.16; dbs-net=172.16.20.8 |\n+--------------------------------------+------------------------------------------+-----------------------------------------------------------------+\n\n\u300ctarget=dbs\u300d\u3067\u4f5c\u6210\u3002\n(venv)[ansible@step-server ~]$ ansible-playbook -i ansible_hosts -e target=dbs create_sample_vm.yml\n\nPLAY [localhost] **************************************************************\n\nGATHERING FACTS ***************************************************************\nok: [localhost]\n\nTASK: [ansible_python_interpreter setup] **************************************\nok: [localhost]\n\nTASK: [get uuid for generate hostname] ****************************************\nchanged: [localhost]\n\nTASK: [create {{ target }}-server on nova-compute with floating_ip] ***********\nskipping: [localhost]\n\nTASK: [create {{ target }}-server on nova-compute without floating_ip] ********\nchanged: [localhost]\n\nPLAY RECAP ********************************************************************\nlocalhost                  : ok=4    changed=2    unreachable=0    failed=0\n\n(venv)[ansible@step-server ~]$ nova list --name ^dbs- --field name,networks\n+--------------------------------------+------------------------------------------+-------------------------------------------+\n| ID                                   | Name                                     | Networks                                  |\n+--------------------------------------+------------------------------------------+-------------------------------------------+\n| 359d02ea-098e-4e03-966e-81bbc40da2c0 | dbs-968a948e-7e58-4089-a6c6-6b2a38bb71e6 | dmz-net=192.168.0.24; dbs-net=172.16.20.9 |\n+--------------------------------------+------------------------------------------+-------------------------------------------+\n\n\n11.5.3 \u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30c7\u30d7\u30ed\u30a4\u306e\u81ea\u52d5\u5316\n\u3053\u3053\u3067\u884c\u3046\u306e\u306f\u3001\u4e0b\u8a18\u306e4\u70b9\u3067\u3042\u308b\u3002\n\n\u30bf\u30a4\u30e0\u30be\u30fc\u30f3\u306e\u5909\u66f4\ngithub\u304b\u3089\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u30c1\u30a7\u30c3\u30af\u30a2\u30a6\u30c8\n\u5c0e\u5165\u30b9\u30af\u30ea\u30d7\u30c8\u306e\u5b9f\u884c\n\u30b5\u30fc\u30d0\u30fc\u9593\u306e\u9023\u643a\u3092\u3068\u308bendpoint.conf\u3092\u5185\u5bb9\u3092\u66f8\u304d\u63db\u3048\u306a\u304c\u3089\u8ee2\u9001\n\u30b5\u30fc\u30d3\u30b9\u306e\u958b\u59cb\n\n\u30d7\u30ec\u30a4\u30d6\u30c3\u30af\u306f\u3053\u3061\u3089\u3002\n\u307e\u305a\u3001ansible_hosts \u306b\u5bfe\u8c61\u30db\u30b9\u30c8\u306edmz-net\u306eIP\u3092\u8a18\u8ff0\u3059\u308b\u3002\u3053\u308c\u306f\u64cd\u4f5c\u7528\u3067\u3042\u308b\u3002\u307e\u305f\u3001endpoint.conf\u306e\u66f8\u304d\u63db\u3048\u7528\u306b\u3001web\u306b\u30bb\u30c3\u30c8\u3059\u308bapp\u306eapp-net\u306eIP\u3092\u3001app\u306b\u30bb\u30c3\u30c8\u3059\u308bdbs\u306edbs-net\u306eIP\u3092\u8a18\u8ff0\u3059\u308b\u3002\n(venv)[ansible@step-server ~]$ cat ansible_hosts\n[localhost]\nlocalhost ansible_connection=local\n\n[web]\n192.168.0.22\n\n[app]\n192.168.0.23\n\n[dbs]\n192.168.0.24\n\n[web:vars]\napp = 172.16.10.16\n\n[app:vars]\ndbs = 172.16.20.9\n\n\u30d7\u30ec\u30a4\u30d6\u30c3\u30af\u3068endpoint.conf\u306e\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u3092\u30db\u30fc\u30e0\u306b\u30b3\u30d4\u30fc\u3059\u308b\u3002\n(venv)[ansible@step-server ~]$ cd\n\n(venv)[ansible@step-server ~]$ cp chapter11/playbooks/book1/install_sample_app.yml .\n\n(venv)[ansible@step-server ~]$ cp chapter11/playbooks/book1/endpoint.conf.j2 .\n\n\u4f9d\u5b58\u95a2\u4fc2\u304c\u3042\u308b\u306e\u3067dbs\u3001app\u3001web\u306e\u9806\u306b\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u3002\n\u300ctarget=dbs\u300d\u3067\u5b9f\u884c\u3059\u308b\u3002\u30ed\u30b0\u30a4\u30f3\u3059\u308b\u306e\u3067\u300c-u root\u300d\u3082\u6307\u5b9a\u3057\u305f\u3002\u30a2\u30d7\u30ea\u3092github\u304b\u3089\u53d6\u5f97\u3059\u308b\u3068\u304d\u306b\u300c403 Forbidden\u300d\u304c\u51fa\u305f\u3002\n(venv)[ansible@step-server ~]$ ansible-playbook -i ansible_hosts -e target=dbs -u root install_sample_app.yml\n\nPLAY [dbs] ********************************************************************\n\nGATHERING FACTS ***************************************************************\nThe authenticity of host '192.168.0.24 (192.168.0.24)' can't be established.\nRSA key fingerprint is 9d:7e:70:8f:da:c2:b0:1f:9c:57:39:c1:a1:01:9a:a3.\nAre you sure you want to continue connecting (yes/no)? yes\nok: [192.168.0.24]\n\nTASK: [change the timezone] ***************************************************\nchanged: [192.168.0.24]\n\nTASK: [checkout app from github] **********************************************\nfailed: [192.168.0.24] => {\"cmd\": \"/usr/bin/git clone --origin origin --branch v1.0 https://github.com/josug-book1-materials/sample-app.git /root/sample-app\", \"failed\": true, \"rc\": 128}\nstderr: error: The requested URL returned error: 403 Forbidden while accessing https://github.com/josug-book1-materials/sample-app.git/info/refs\n\nfatal: HTTP request failed\n\nstdout: Initialized empty Git repository in /root/sample-app/.git/\n\nmsg: error: The requested URL returned error: 403 Forbidden while accessing https://github.com/josug-book1-materials/sample-app.git/info/refs\n\nfatal: HTTP request failed\n\nFATAL: all hosts have already failed -- aborting\n\nPLAY RECAP ********************************************************************\n           to retry, use: --limit @/home/ansible/install_sample_app.retry\n\n192.168.0.24               : ok=2    changed=1    unreachable=0    failed=1\n\n\u3068\u308a\u3042\u3048\u305a\u518d\u5b9f\u884c\u3057\u305f\u3002\u4eca\u5ea6\u306f\u6210\u529f\u3057\u305f\u3002\n(venv)[ansible@step-server ~]$ ansible-playbook -i ansible_hosts -e target=dbs -u root install_sample_app.yml\n\nPLAY [dbs] ********************************************************************\n\nGATHERING FACTS ***************************************************************\nok: [192.168.0.24]\n\nTASK: [change the timezone] ***************************************************\nchanged: [192.168.0.24]\n\nTASK: [checkout app from github] **********************************************\nchanged: [192.168.0.24]\n\nTASK: [execute install script] ************************************************\nok: [192.168.0.24]\n\nTASK: [copy endpoint.conf to web and app server] ******************************\nskipping: [192.168.0.24]\n\nPLAY RECAP ********************************************************************\n192.168.0.24               : ok=4    changed=2    unreachable=0    failed=0\n\n\u300ctarget=app\u300d\u3067\u5b9f\u884c\u3002\n(venv)[ansible@step-server ~]$ ansible-playbook -i ansible_hosts -e target=app -u root install_sample_app.yml\n\nPLAY [app] ********************************************************************\n\nGATHERING FACTS ***************************************************************\nThe authenticity of host '192.168.0.23 (192.168.0.23)' can't be established.\nRSA key fingerprint is 4d:8e:f4:7d:06:ca:85:c4:b7:23:27:30:67:3a:8b:13.\nAre you sure you want to continue connecting (yes/no)? yes\nok: [192.168.0.23]\n\nTASK: [change the timezone] ***************************************************\nchanged: [192.168.0.23]\n\nTASK: [checkout app from github] **********************************************\nchanged: [192.168.0.23]\n\nTASK: [execute install script] ************************************************\nok: [192.168.0.23]\n\nTASK: [copy endpoint.conf to web and app server] ******************************\nchanged: [192.168.0.23]\n\nNOTIFIED: [startup service] ***************************************************\nchanged: [192.168.0.23]\n\nPLAY RECAP ********************************************************************\n192.168.0.23               : ok=6    changed=4    unreachable=0    failed=0\n\n\u300ctarget=app\u300d\u3067\u5b9f\u884c\u3002\n(venv)[ansible@step-server ~]$ ansible-playbook -i ansible_hosts -e target=web -u root install_sample_app.yml\n\nPLAY [web] ********************************************************************\n\nGATHERING FACTS ***************************************************************\nThe authenticity of host '192.168.0.22 (192.168.0.22)' can't be established.\nRSA key fingerprint is 28:30:e0:72:bc:7e:d8:61:da:1d:cb:67:02:19:8b:5e.\nAre you sure you want to continue connecting (yes/no)? yes\nok: [192.168.0.22]\n\nTASK: [change the timezone] ***************************************************\nchanged: [192.168.0.22]\n\nTASK: [checkout app from github] **********************************************\nchanged: [192.168.0.22]\n\nTASK: [execute install script] ************************************************\nok: [192.168.0.22]\n\nTASK: [copy endpoint.conf to web and app server] ******************************\nchanged: [192.168.0.22]\n\nNOTIFIED: [startup service] ***************************************************\nchanged: [192.168.0.22]\n\nPLAY RECAP ********************************************************************\n192.168.0.22               : ok=6    changed=4    unreachable=0    failed=0\n\n\n11.5.4 \u30c0\u30a4\u30ca\u30df\u30c3\u30af\u30a4\u30f3\u30d9\u30f3\u30c8\u30ea\u30fc\u3067\u30db\u30b9\u30c8\u306e\u5897\u6e1b\u306b\u5bfe\u5fdc\n\u300c11.5.3 \u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30c7\u30d7\u30ed\u30a4\u306e\u81ea\u52d5\u5316\u300d\u3067\u306f\u5bfe\u8c61\u306eIP\u3092ansible_hosts\u306b\u8a18\u8ff0\u3057\u305f\u3002\u3057\u304b\u3057\u3001OpenStack\u3067\u306f\u57fa\u672c\u7684\u306b\u30c7\u30d7\u30ed\u30a4\u3059\u308b\u307e\u3067\u30a2\u30c9\u30ec\u30b9\u304c\u4e0d\u660e\u3067\u3042\u308b\u3002\nansible\u306b\u306f\u30a4\u30f3\u30d9\u30f3\u30c8\u30ea\u30fc\u60c5\u5831\u3092\u8fd4\u3059\u5916\u90e8\u30d7\u30ed\u30b0\u30e9\u30e0\u3092\u547c\u3073\u51fa\u3057\u3001\u305d\u308c\u3092\u5bfe\u8c61\u3068\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u308b\u3002\n\u5916\u90e8\u30d7\u30ed\u30b0\u30e9\u30e0\u306e\u6761\u4ef6\u306f\u3001\u4e0b\u8a18\u3068\u672c\u66f8\u306b\u3042\u308b\u3002\n\n\u5358\u4f53\u5b9f\u884c\u53ef\u80fd\n--list \u3092\u5f15\u6570\u3068\u3057\u305f\u5834\u5408\u3001\u30db\u30b9\u30c8\u30ea\u30b9\u30c8\u3092JSON\u3067\u8fd4\u3059\n--host \u304c\u5f15\u6570\u306e\u5834\u5408\u3001\u30db\u30b9\u30c8\u7528\u306e\u30d1\u30e9\u30e1\u30fc\u30bf\u30fc\u3092JSON\u3067\u8fd4\u3059\n\n\u5358\u7d14\u306b\u30db\u30b9\u30c8\u30ea\u30b9\u30c8\u3092\u8fd4\u3059\u30b7\u30a7\u30eb\u3067\u5b9f\u884c\u3092\u78ba\u8a8d\u3059\u308b\u3002\n(venv)[ansible@step-server ~]$ cat inventry.sh\n#!/bin/sh\n\nusage() {\n        echo \"Usage: invenrty.sh --list|--host hostname\"\n        exit 1\n}\n\ncase $1 in\n        \"--list\")\n                echo '{\"sns\":{\"hosts\":[\"192.168.0.22\",\"192.168.0.23\",\"192.168.0.24\"]}}'\n                ;;\n        \"--host\")\n                if [ \"x\"$2 == \"x\" ] || [ $# -ne 2 ]; then\n                        usage\n                fi\n                echo \"{}\"\n                ;;\n        *)\n                usage\n                ;;\nesac\n\nping\u30e2\u30b8\u30e5\u30fc\u30eb\u3067\u78ba\u8a8d\u3059\u308b\u3068\u3001\u3053\u3093\u306a\u30b7\u30a7\u30eb\u3067\u3082\u6a5f\u80fd\u3059\u308b\u3002\n(venv)[ansible@step-server ~]$ ansible sns -i inventry.sh -m ping -u root\n192.168.0.22 | success >> {\n    \"changed\": false,\n    \"ping\": \"pong\"\n}\n\n192.168.0.24 | success >> {\n    \"changed\": false,\n    \"ping\": \"pong\"\n}\n\n192.168.0.23 | success >> {\n    \"changed\": false,\n    \"ping\": \"pong\"\n}\n\n\u7528\u610f\u3055\u308c\u3066\u308bsample_app_inventory.py\u3068sample_app_inventory.ini\u3092\u30db\u30fc\u30e0\u306b\u30b3\u30d4\u30fc\u3059\u308b\u3002sample_app_inventory.py\u306b\u306f\u5b9f\u884c\u6a29\u3092\u3064\u3051\u308b\u3002\n(venv)[ansible@step-server ~]$ cd\n\n(venv)[ansible@step-server ~]$ cp chapter11/playbooks/sample_app_inventory.py .\n\n(venv)[ansible@step-server ~]$ cp chapter11/playbooks/sample_app_inventory.ini .\n\n(venv)[ansible@step-server ~]$ chmod u+x sample_app_inventory.py\n\n\nini\u30d5\u30a1\u30a4\u30eb\u306f\u3001\u3053\u306e\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u308b\u3002\n(venv)[ansible@step-server ~]$ cat sample_app_inventory.ini\n[DEFAULT]\n\n\n[stack]\napi_version    = 1.1\nos_username    = %OS_USERNAME%\nos_password    = %OS_PASSWORD%\nos_auth_url    = %AUTH_URL%\nos_region_name = %REGION_NAME%\nos_tenant_name = %TENANT_NAME%\n\n[sample_app]\nweb_hostname_prefix = web-\napp_hostname_prefix = app-\ndbs_hostname_prefix = dbs-\n\n\n##\n## [EOF]\n##\n\n\u4eca\u56de\u306e\u74b0\u5883\u306b\u5408\u308f\u305b\u3066\u66f8\u304d\u63db\u3048\u308b\u3002\n(venv)[ansible@step-server ~]$ cat sample_app_inventory.ini\n[DEFAULT]\n\n\n[stack]\napi_version    = 1.1\nos_username    = snsapp-infra-user\nos_password    = passw0rd\nos_auth_url    = http://192.168.100.10:5000/v2.0/\nos_region_name = RegionOne\nos_tenant_name = SNSApp\n\n[sample_app]\nweb_hostname_prefix = web-\napp_hostname_prefix = app-\ndbs_hostname_prefix = dbs-\n\n\n##\n## [EOF]\n##\n\n\u5b9f\u884c\u3059\u308b\u3068\n(venv)[ansible@step-server ~]$ ./sample_app_inventory.py --list\n{\n  \"_meta\": {\n    \"hostvars\": {\n      \"192.168.0.22\": {\n        \"app\": \"172.16.10.16\"\n      },\n      \"192.168.0.23\": {\n        \"dbs\": \"172.16.20.9\"\n      },\n      \"192.168.0.24\": {}\n    }\n  },\n  \"app\": {\n    \"hosts\": [\n      \"192.168.0.23\"\n    ],\n    \"vars\": {\n      \"dbs\": \"172.16.20.9\"\n    }\n  },\n  \"dbs\": {\n    \"hosts\": [\n      \"192.168.0.24\"\n    ],\n    \"vars\": {}\n  },\n  \"localhost\": {\n    \"hosts\": [\n      \"localhost\"\n    ],\n    \"vars\": {\n      \"ansible_connection\": \"local\"\n    }\n  },\n  \"web\": {\n    \"hosts\": [\n      \"192.168.0.22\"\n    ],\n    \"vars\": {\n      \"app\": \"172.16.10.16\"\n    }\n  }\n}\n\n\u3053\u306e\u7ae0\u3067\u4f5c\u3063\u305f\u30b5\u30fc\u30d0\u30fc\u3092\u3044\u3063\u305f\u3093\u524a\u9664\u3059\u308b\u3002\n(venv)[ansible@step-server ~]$ nova delete app-18e1b380-a213-4518-a3ae-30ccad545014\n(venv)[ansible@step-server ~]$ nova delete dbs-968a948e-7e58-4089-a6c6-6b2a38bb71e6\n(venv)[ansible@step-server ~]$ nova delete web-520710f9-08d3-41cd-9d28-aa6cc4bfca66\n\n\u65b0\u898f\u306b\u30b5\u30fc\u30d0\u30fc\u3092\u8d77\u52d5\u3059\u308b\u3002\n(venv)[ansible@step-server ~]$ echo \"localhost ansible_connection=local\" > ansible_hosts\n(venv)[ansible@step-server ~]$ ansible-playbook -i ansible_hosts -e target=web create_sample_vm.yml\n(venv)[ansible@step-server ~]$ ansible-playbook -i ansible_hosts -e target=app create_sample_vm.yml\n(venv)[ansible@step-server ~]$ ansible-playbook -i ansible_hosts -e target=dbs create_sample_vm.yml\n\ndbs\u306b\u5c0e\u5165\u3059\u308b\u3002\u5bfe\u8c61IP\u304c[192.168.0.27]\u306b\u306a\u3063\u3066\u3044\u308b\u3002\n(venv)[ansible@step-server ~]$ ansible-playbook -i sample_app_inventory.py -e target=dbs install_sample_app.yml\n\nPLAY [dbs] ********************************************************************\n\nGATHERING FACTS ***************************************************************\nThe authenticity of host '192.168.0.27 (192.168.0.27)' can't be established.\nRSA key fingerprint is a8:6a:42:e4:e2:19:2f:19:67:99:44:2e:8e:72:8b:40.\nAre you sure you want to continue connecting (yes/no)? yes\nok: [192.168.0.27]\n\nTASK: [change the timezone] ***************************************************\nchanged: [192.168.0.27]\n\nTASK: [checkout app from github] **********************************************\nchanged: [192.168.0.27]\n\nTASK: [execute install script] ************************************************\nok: [192.168.0.27]\n\nTASK: [copy endpoint.conf to web and app server] ******************************\nskipping: [192.168.0.27]\n\nPLAY RECAP ********************************************************************\n192.168.0.27               : ok=4    changed=2    unreachable=0    failed=0\n\napp\u306b\u5c0e\u5165\u3059\u308b\u3002\u5bfe\u8c61IP\u304c[192.168.0.26]\u306b\u306a\u3063\u3066\u3044\u308b\u3002\n(venv)[ansible@step-server ~]$ ansible-playbook -i sample_app_inventory.py -e target=app install_sample_app.yml\n\nPLAY [app] ********************************************************************\n\nGATHERING FACTS ***************************************************************\nThe authenticity of host '192.168.0.26 (192.168.0.26)' can't be established.\nRSA key fingerprint is 82:84:ad:c8:3e:fe:fd:a9:b0:43:cd:fc:9d:d0:43:b6.\nAre you sure you want to continue connecting (yes/no)? yes\nok: [192.168.0.26]\n\nTASK: [change the timezone] ***************************************************\nchanged: [192.168.0.26]\n\nTASK: [checkout app from github] **********************************************\nchanged: [192.168.0.26]\n\nTASK: [execute install script] ************************************************\nok: [192.168.0.26]\n\nTASK: [copy endpoint.conf to web and app server] ******************************\nchanged: [192.168.0.26]\n\nNOTIFIED: [startup service] ***************************************************\nchanged: [192.168.0.26]\n\nPLAY RECAP ********************************************************************\n192.168.0.26               : ok=6    changed=4    unreachable=0    failed=0\n\nweb\u306b\u5c0e\u5165\u3059\u308b\u3002\u5bfe\u8c61IP\u304c[192.168.0.25]\u306b\u306a\u3063\u3066\u3044\u308b\u3002\n(venv)[ansible@step-server ~]$ ansible-playbook -i sample_app_inventory.py -e target=web install_sample_app.yml\n\nPLAY [web] ********************************************************************\n\nGATHERING FACTS ***************************************************************\nThe authenticity of host '192.168.0.25 (192.168.0.25)' can't be established.\nRSA key fingerprint is b4:3c:b3:1c:bd:58:5f:4e:8c:72:6d:05:82:2e:a3:01.\nAre you sure you want to continue connecting (yes/no)? yes\nok: [192.168.0.25]\n\nTASK: [change the timezone] ***************************************************\nchanged: [192.168.0.25]\n\nTASK: [checkout app from github] **********************************************\nchanged: [192.168.0.25]\n\nTASK: [execute install script] ************************************************\nok: [192.168.0.25]\n\nTASK: [copy endpoint.conf to web and app server] ******************************\nchanged: [192.168.0.25]\n\nNOTIFIED: [startup service] ***************************************************\nchanged: [192.168.0.25]\n\nPLAY RECAP ********************************************************************\n192.168.0.25               : ok=6    changed=4    unreachable=0    failed=0\n\n\n11.5.5 \u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306e\u30d0\u30c3\u30af\u30a2\u30c3\u30d7/\u30ea\u30b9\u30c8\u30a2\u3092\u81ea\u52d5\u5316\ndbs\u3067\u30b9\u30ca\u30c3\u30d7\u30b7\u30e7\u30c3\u30c8\u306e\u53d6\u5f97\u3001app\u3067\u30b5\u30fc\u30d3\u30b9\u306e\u518d\u8d77\u52d5\u3001\u30b9\u30ca\u30c3\u30d7\u30b7\u30e7\u30c3\u30c8\u306e\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u306e\u81ea\u52d5\u5316\u3067\u3042\u308b\u3002\n3\u30b9\u30c6\u30c3\u30d7\u306e\u30d7\u30ec\u30a4\u30d6\u30c3\u30af\u306f\u3053\u3061\u3089\u3002\ncreate_snapshot.yml\u3001\nrestart_rest_service.yml\nbackup_snapshot.yml\n\u3053\u308c\u3092\u4e00\u6c17\u306b\u884c\u3046\u30d7\u30ec\u30a4\u30d6\u30c3\u30af\u306f\u3053\u3061\u3089\u3002\ndb_backup.yml\n\u3053\u308c\u3089\u306e\u30d7\u30ec\u30a4\u30d6\u30c3\u30af\u3092\u30db\u30fc\u30e0\u306b\u30b3\u30d4\u30fc\u3059\u308b\u3002\n(venv)[ansible@step-server ~]$ cp chapter11/playbooks/book2/create_snapshot.yml .\n(venv)[ansible@step-server ~]$ cp chapter11/playbooks/book2/restart_rest_service.yml .\n(venv)[ansible@step-server ~]$ cp chapter11/playbooks/book2/backup_snapshot.yml .\n(venv)[ansible@step-server ~]$ cp chapter11/playbooks/book2/db_backup.yml .\n\n\u4e00\u6c17\u306b\u884c\u3046db_backup.yml\u3092\u5b9f\u884c\u3057\u305f\u304c\u30a8\u30e9\u30fc\u306b\u306a\u308b\u3002\n(venv)[ansible@step-server ~]$ ansible-playbook -i sample_app_inventory.py -t snapshot,backup -u root db_backup.yml\n\nPLAY [dbs] ********************************************************************\n\nGATHERING FACTS ***************************************************************\nok: [192.168.0.27]\n\nTASK: [stop mysqld] ***********************************************************\nok: [192.168.0.27]\n\nTASK: [umount mysql_dir] ******************************************************\nok: [192.168.0.27]\n\nTASK: [create snapshot on lvm] ************************************************\nfailed: [192.168.0.27] => {\"changed\": true, \"cmd\": [\"lvcreate\", \"-s\", \"/dev/mysql_vg/mysql_vol01\", \"-L\", \"100m\", \"-n\", \"mysql_bk_snap01\"], \"delta\": \"0:00:00.009340\", \"end\": \"2015-03-30 17:32:52.913837\", \"rc\": 5, \"start\": \"2015-03-30 17:32:52.904497\", \"warnings\": []}\nstderr:   Volume group \"mysql_vg\" not found\n\nFATAL: all hosts have already failed -- aborting\n\nPLAY RECAP ********************************************************************\n           to retry, use: --limit @/home/ansible/db_backup.retry\n\n192.168.0.27               : ok=3    changed=0    unreachable=0    failed=1\n\n\nlvm\u306esnapshot\u3092\u4f5c\u6210\u3057\u3088\u3046\u3068\u3057\u3066\u3044\u308b\u3051\u3069\u3001\n\uff5e\uff5e\uff5e\uff5e\uff5e\uff5e\nmysql_dir: /var/lib/mysql\nmysql_vol: /dev/mysql_vg/mysql_vol01\nmysql_snap: mysql_bk_snap01\nmysql_snap_size: 100m\n\uff5e\uff5e\uff5e\uff5e\uff5e\uff5e\ncommand: lvcreate -s \"{{ mysql_vol }}\" -L \"{{ mysql_snap_size }}\" -n \"{{ mysql_snap }}\"\n\ndbs\u306blv\u306f\u7121\u3044\u3057\uff0e\uff0e\uff0e\n[root@dbs-e945fd19-f2ba-40a2-8470-ad1c6092eacf /]# lvdisplay\n  No volume groups found\n\n\u63a5\u7d9a\u3055\u308c\u3066\u3044\u308bdisk\u306fvda\u3068vdb\u3002\n[root@dbs-e945fd19-f2ba-40a2-8470-ad1c6092eacf /]# lsblk\nNAME                            MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT\nsr0                              11:0    1  410K  0 rom\nvda                             252:0    0   10G  0 disk\n\u2514\u2500vda1                          252:1    0   10G  0 part /\nvdb                             252:16   0   10G  0 disk /mnt\n\nbackup_snapshot.yml\u3067\u306f/dev/vdd1\u3092\u30de\u30a6\u30f3\u30c8\u3057\u3066\u3044\u308b\u306e\u3067\u3001vdc\u3068vdd\u304c\u63a5\u7d9a\u3055\u308c\u3066\u3044\u308b\u60f3\u5b9a\u306e\u3088\u3046\u3060\u3002\nSoftLayer\u306e\u7121\u6599\u30d9\u30a2\u30e1\u30bf\u30eb\u3067OpenStack\u306e\u5b66\u7fd2\u3092\u3059\u308b(10) - \u7b2c9\u7ae0\u300c\u30d6\u30ed\u30c3\u30af\u30dc\u30ea\u30e5\u30fc\u30e0\u3092\u6d3b\u7528\u3057\u305f\u30c7\u30fc\u30bf\u4fdd\u8b77\u300d(Cinder\u306e\u5229\u7528)\u306e\u624b\u9806\u3092\u5143\u306b\u3001\u30dc\u30ea\u30e5\u30fc\u30e0\u30922\u672c\u8ffd\u52a0\u3059\u308b\u3002\nvdc\u306bLVM\u3092\u3064\u304f\u308amysql\u306e\u30c7\u30fc\u30bf\u9818\u57df\u3068\u3059\u308b\u3002\nvdd\u306f\u901a\u5e38\u306eext4\u306e\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u3068\u3057\u3066\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u9818\u57df\u306b\u3059\u308b\u3002\ncinder\u3067\u30dc\u30ea\u30e5\u30fc\u30e0\u30922\u672c\u4f5c\u6210\u3059\u308b\u3002\n(venv)[ansible@step-server ~]$ cinder create --display-name dbs_vdc --availability-zone az1 10\n+---------------------+--------------------------------------+\n|       Property      |                Value                 |\n+---------------------+--------------------------------------+\n|     attachments     |                  []                  |\n|  availability_zone  |                 az1                  |\n|       bootable      |                false                 |\n|      created_at     |      2015-03-30T11:43:00.654349      |\n| display_description |                 None                 |\n|     display_name    |               dbs_vdc                |\n|      encrypted      |                False                 |\n|          id         | 5293f5c7-d386-4b36-9092-252f724eeafd |\n|       metadata      |                  {}                  |\n|         size        |                  10                  |\n|     snapshot_id     |                 None                 |\n|     source_volid    |                 None                 |\n|        status       |               creating               |\n|     volume_type     |                 None                 |\n+---------------------+--------------------------------------+\n\n(venv)[ansible@step-server ~]$ cinder create --display-name dbs_vdd --availability-zone az1 10\n+---------------------+--------------------------------------+\n|       Property      |                Value                 |\n+---------------------+--------------------------------------+\n|     attachments     |                  []                  |\n|  availability_zone  |                 az1                  |\n|       bootable      |                false                 |\n|      created_at     |      2015-03-30T11:43:13.524431      |\n| display_description |                 None                 |\n|     display_name    |               dbs_vdd                |\n|      encrypted      |                False                 |\n|          id         | e7f73a03-e9a3-4f27-9a33-a40c869d13cb |\n|       metadata      |                  {}                  |\n|         size        |                  10                  |\n|     snapshot_id     |                 None                 |\n|     source_volid    |                 None                 |\n|        status       |               creating               |\n|     volume_type     |                 None                 |\n+---------------------+--------------------------------------+\n\ndbs\u306b\u63a5\u7d9a\u3059\u308b\u3002\n(venv)[ansible@step-server ~]$ function get_uuid () { cat - | grep \" id \" | awk '{print $4}'; }\n\n(venv)[ansible@step-server ~]$ export MY_DBS_VDC=`cinder show dbs_vdc |get_uuid`\n\n(venv)[ansible@step-server ~]$ export MY_DBS_VDD=`cinder show dbs_vdd |get_uuid`\n\n(venv)[ansible@step-server ~]$ nova volume-attach dbs-e945fd19-f2ba-40a2-8470-ad1c6092eacf $MY_DBS_VDC\n+----------+--------------------------------------+\n| Property | Value                                |\n+----------+--------------------------------------+\n| device   | /dev/vdc                             |\n| id       | 5293f5c7-d386-4b36-9092-252f724eeafd |\n| serverId | e4908bd6-c862-4993-964c-44c7bf6c4ddf |\n| volumeId | 5293f5c7-d386-4b36-9092-252f724eeafd |\n+----------+--------------------------------------+\n\n(venv)[ansible@step-server ~]$ nova volume-attach dbs-e945fd19-f2ba-40a2-8470-ad1c6092eacf $MY_DBS_VDD\n+----------+--------------------------------------+\n| Property | Value                                |\n+----------+--------------------------------------+\n| device   | /dev/vdd                             |\n| id       | e7f73a03-e9a3-4f27-9a33-a40c869d13cb |\n| serverId | e4908bd6-c862-4993-964c-44c7bf6c4ddf |\n| volumeId | e7f73a03-e9a3-4f27-9a33-a40c869d13cb |\n+----------+--------------------------------------+\n\n\u63a5\u7d9a\u3055\u308c\u305f\u3002\n[root@dbs-e945fd19-f2ba-40a2-8470-ad1c6092eacf /]# lsblk\nNAME   MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT\nsr0     11:0    1  410K  0 rom\nvda    252:0    0   10G  0 disk\n\u2514\u2500vda1 252:1    0   10G  0 part /\nvdb    252:16   0   10G  0 disk /mnt\nvdc    252:32   0   10G  0 disk\nvdd    252:48   0   10G  0 disk\n\n\u300c/dev/mysql_vg/mysql_vol01\u300d\u306eLVM\u30b9\u30ca\u30c3\u30d7\u30b7\u30e7\u30c3\u30c8\u3092\u4f5c\u308b\u3053\u3068\u306b\u306a\u3063\u3066\u3044\u308b\u3002\n/dev/vdc\u306e\u30bf\u30a4\u30d7\u3092 8e (Linux LVM)\u306b\u3059\u308b\u3002\n[root@dbs-e945fd19-f2ba-40a2-8470-ad1c6092eacf /]# fdisk /dev/vdc\nDevice contains neither a valid DOS partition table, nor Sun, SGI or OSF disklabel\nBuilding a new DOS disklabel with disk identifier 0xed33b73b.\nChanges will remain in memory only, until you decide to write them.\nAfter that, of course, the previous content won't be recoverable.\n\nWarning: invalid flag 0x0000 of partition table 4 will be corrected by w(rite)\n\nWARNING: DOS-compatible mode is deprecated. It's strongly recommended to\n         switch off the mode (command 'c') and change display units to\n         sectors (command 'u').\n\nCommand (m for help): n\nCommand action\n   e   extended\n   p   primary partition (1-4)\np\nPartition number (1-4): 1\nFirst cylinder (1-20805, default 1):\nUsing default value 1\nLast cylinder, +cylinders or +size{K,M,G} (1-20805, default 20805):\nUsing default value 20805\n\nCommand (m for help): t\nSelected partition 1\nHex code (type L to list codes): 8e\nChanged system type of partition 1 to 8e (Linux LVM)\n\nCommand (m for help): p\n\nDisk /dev/vdc: 10.7 GB, 10737418240 bytes\n16 heads, 63 sectors/track, 20805 cylinders\nUnits = cylinders of 1008 * 512 = 516096 bytes\nSector size (logical/physical): 512 bytes / 512 bytes\nI/O size (minimum/optimal): 512 bytes / 512 bytes\nDisk identifier: 0xed33b73b\n\n   Device Boot      Start         End      Blocks   Id  System\n/dev/vdc1               1       20805    10485688+  8e  Linux LVM\n\nCommand (m for help): w\nThe partition table has been altered!\n\nCalling ioctl() to re-read partition table.\nSyncing disks.\n\n/dev/vdc1\u306bpv\u3092\u4f5c\u308a\u3001vg\u300cmysql_vg\u300d\u3001lv\u300cmysql_vol01\u300d\u3092\u4f5c\u308b\u3002\n[root@dbs-e945fd19-f2ba-40a2-8470-ad1c6092eacf /]# pvcreate /dev/vdc1\n  Physical volume \"/dev/vdc1\" successfully created\n\n[root@dbs-e945fd19-f2ba-40a2-8470-ad1c6092eacf /]# vgcreate mysql_vg /dev/vdc1\n  Volume group \"mysql_vg\" successfully created\n\n[root@dbs-e945fd19-f2ba-40a2-8470-ad1c6092eacf /]# lvcreate -L 5G -n mysql_vol01 mysql_vg\n  Logical volume \"mysql_vol01\" created\n\n/dev/mysql_vg/mysql_vol01 \u304c\u4f5c\u6210\u3055\u308c\u305f\u3002\n[root@dbs-e945fd19-f2ba-40a2-8470-ad1c6092eacf /]# lsblk\nNAME                            MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT\nsr0                              11:0    1  410K  0 rom\nvda                             252:0    0   10G  0 disk\n\u2514\u2500vda1                          252:1    0   10G  0 part /\nvdb                             252:16   0   10G  0 disk /mnt\nvdc                             252:32   0   10G  0 disk\n\u2514\u2500vdc1                          252:33   0   10G  0 part\n  \u2514\u2500mysql_vg-mysql_vol01 (dm-0) 253:0    0    5G  0 lvm\nvdd                             252:48   0   10G  0 disk\n\n[root@dbs-e945fd19-f2ba-40a2-8470-ad1c6092eacf /]# ls /dev/mysql_vg/mysql_vol01\n/dev/mysql_vg/mysql_vol01\n\next4\u306efs\u3092\u4f5c\u308a\u3001MySQL\u30c7\u30fc\u30bf\u3092\u79fb\u884c\u3057/var/lib/mysql\u306b\u30de\u30a6\u30f3\u30c8\u3059\u308b\u3002\n[root@dbs-e945fd19-f2ba-40a2-8470-ad1c6092eacf /]# mkfs.ext4 -L mysql_data /dev/mysql_vg/mysql_vol01\n\n[root@dbs-e945fd19-f2ba-40a2-8470-ad1c6092eacf /]# tune2fs -c 0 -i 0 -r 0 /dev/mysql_vg/mysql_vol01\n\n[root@dbs-e945fd19-f2ba-40a2-8470-ad1c6092eacf /]# mkdir /tmp/data\n\n[root@dbs-e945fd19-f2ba-40a2-8470-ad1c6092eacf /]# mount LABEL=mysql_data /tmp/data\n\n[root@dbs-e945fd19-f2ba-40a2-8470-ad1c6092eacf /]# chown -R mysql:mysql /tmp/data\n\n[root@dbs-e945fd19-f2ba-40a2-8470-ad1c6092eacf /]# service mysqld stop\n\n[root@dbs-e945fd19-f2ba-40a2-8470-ad1c6092eacf /]# mv /var/lib/mysql/* /tmp/data/\n\n\n[root@dbs-e945fd19-f2ba-40a2-8470-ad1c6092eacf /]# umount /tmp/data/\n\n[root@dbs-e945fd19-f2ba-40a2-8470-ad1c6092eacf /]# mount LABEL=mysql_data /var/lib/mysql\n\n[root@dbs-e945fd19-f2ba-40a2-8470-ad1c6092eacf /]# service mysqld start\n\nvdd\u306f\u300183 (Linux)\u306b\u3057\u3066ext4\u306efs\u3092\u4f5c\u6210\u3057\u3066\u304a\u304f\u3002\n[root@dbs-e945fd19-f2ba-40a2-8470-ad1c6092eacf /]# fdisk /dev/vdd\n\n[root@dbs-e945fd19-f2ba-40a2-8470-ad1c6092eacf /]# mkfs.ext4 -L mysql_backup /dev/vdd1\n\n[root@dbs-e945fd19-f2ba-40a2-8470-ad1c6092eacf /]# tune2fs -c 0 -i 0 -r 0 /dev/vdd1\n\n\u3053\u308c\u3067ansible\u3067\u306e\u81ea\u52d5\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u306b\u6210\u529f\u3057\u305f\u3002\n(venv)[ansible@step-server ~]$ ansible-playbook -i sample_app_inventory.py -t snapshot,backup -u root db_backup.yml\n\nPLAY [dbs] ********************************************************************\n\nGATHERING FACTS ***************************************************************\nok: [192.168.0.27]\n\nTASK: [stop mysqld] ***********************************************************\nchanged: [192.168.0.27]\n\nTASK: [umount mysql_dir] ******************************************************\nchanged: [192.168.0.27]\n\nTASK: [create snapshot on lvm] ************************************************\nchanged: [192.168.0.27]\n\nTASK: [mount mysql_dir] *******************************************************\nchanged: [192.168.0.27]\n\nTASK: [start mysqld] **********************************************************\nchanged: [192.168.0.27]\n\nPLAY [app] ********************************************************************\n\nGATHERING FACTS ***************************************************************\nok: [192.168.0.26]\n\nTASK: [restart rest app] ******************************************************\nchanged: [192.168.0.26]\n\nPLAY [dbs] ********************************************************************\n\nGATHERING FACTS ***************************************************************\nok: [192.168.0.27]\n\nTASK: [make directory] ********************************************************\nchanged: [192.168.0.27]\n\nTASK: [mount backup] **********************************************************\nchanged: [192.168.0.27]\n\nTASK: [mount snapshot] ********************************************************\nchanged: [192.168.0.27]\n\nTASK: [archive database files to \"{{ backup_mountpoint }}\"] *******************\nchanged: [192.168.0.27]\n\nTASK: [umount snapshot] *******************************************************\nchanged: [192.168.0.27]\n\nTASK: [umount backup] *********************************************************\nchanged: [192.168.0.27]\n\nTASK: [remove snapshot] *******************************************************\nchanged: [192.168.0.27]\n\nPLAY RECAP ********************************************************************\n192.168.0.26               : ok=2    changed=1    unreachable=0    failed=0\n192.168.0.27               : ok=14   changed=12   unreachable=0    failed=0\n\n\n\u7b2c11\u7ae0\u306e\u5b8c\u4e86\u3002\u306a\u3093\u3068\u304b\u306a\u3063\u305f\u3002\n\n\u524d\u56de\u306f\u3053\u3061\u3089 - \u6b21\u56de\u306f\u3053\u3061\u3089\n\n[\u524d\u56de\u306f\u3053\u3061\u3089](http://qiita.com/orz/items/957f15eabaedf312b1a4) - [\u6b21\u56de\u306f\u3053\u3061\u3089](http://qiita.com/orz/items/b303c0145f3b9be486bd)\n***\n#\u3053\u308c\u306f\u306a\u306b\n[\u300cOpenStack\u30af\u30e9\u30a6\u30c9\u30a4\u30f3\u30c6\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3 \u30aa\u30fc\u30d7\u30f3\u30bd\u30fc\u30b9\u30af\u30e9\u30a6\u30c9\u306b\u3088\u308b\u30b5\u30fc\u30d3\u30b9\u69cb\u7bc9\u5165\u9580\u300d](http://www.shoeisha.co.jp/book/detail/9784798139784)\u306e\u5b9f\u7fd2\u3092SoftLayer\u306e\u7121\u6599\u30d9\u30a2\u30e1\u30bf\u30eb\u3067\u884c\u3046\u8a18\u9332\u3067\u3042\u308b\u3002\n![OpenStack\u30af\u30e9\u30a6\u30c9\u30a4\u30f3\u30c6\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3 \u30aa\u30fc\u30d7\u30f3\u30bd\u30fc\u30b9\u30af\u30e9\u30a6\u30c9\u306b\u3088\u308b\u30b5\u30fc\u30d3\u30b9\u69cb\u7bc9\u5165\u9580](http://www.seshop.com/static/images/product/17681/L.png)\n\n# \u7b2c11\u7ae0 Ansible\u3092\u5229\u7528\u3057\u305f\u69cb\u6210\u7ba1\u7406\u306e\u81ea\u52d5\u5316\n\n\u7b2c10\u7ae0\u307e\u3067\u306fOpenStack\u306e\u6a19\u6e96\u6a5f\u80fd\u306e\u5229\u7528\u3092\u5b66\u7fd2\u3057\u3066\u304d\u305f\u3002\u5f53\u7ae0\u3067\u306fAnsible\u3092\u5229\u7528\u3057\u3001OpenStack\u306e\u904b\u7528\u3092\u52b9\u7387\u5316\u3059\u308b\u3002\n\n\u5f53\u7ae0\u306e\u652f\u63f4\u30d5\u30a1\u30a4\u30eb\u306f[\u3053\u3061\u3089](https://github.com/josug-book1-materials/chapter11)\u3002\n\n## 11.1 \u30b9\u30c8\u30fc\u30ea\u30fc\u306e\u5c55\u958b\n\nAnsible\u3067\u904b\u7528\u3092\u6539\u5584\u3057\u3088\u3046\u3068\u3044\u3046\u7ae0\u306e\u30a4\u30f3\u30c8\u30ed\u3002\n\n## 11.2 Ansible\u306e\u5c0e\u5165\u3068\u8a2d\u5b9a\n\n### 11.2.1 Ansible\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\nOS\u304c\u63d0\u4f9b\u3059\u308b\u30d1\u30c3\u30b1\u30fc\u30b8\u3001pip\u3001\u30bd\u30fc\u30b9\u30b3\u30fc\u30c9\u304b\u3089\u30d3\u30eb\u30c9\u30683\u3064\u306e\u5c0e\u5165\u65b9\u6cd5\u304c\u3042\u308b\u3002\u305d\u306e3\u3064\u306e\u65b9\u6cd5\u306e\u8aac\u660e\u3002\n\u3060\u305f\u3057\u3001\u672c\u66f8\u306e\u8a18\u8ff0\u306f\u305d\u306e\u5148\u3067pip\u304b\u3089\u306e\u5c0e\u5165\u3092\u60f3\u5b9a\u3057\u3066\u3044\u308b\u306e\u3067\u3001\u305d\u308c\u306b\u3042\u308f\u305b\u308b\u3053\u3068\u3068\u3059\u308b\u3002\n\n\u30ac\u30a4\u30c9\u3055\u308c\u3066\u3044\u308b\u306e\u306f\u30d1\u30c3\u30b1\u30fc\u30b8\u30b0\u30eb\u30fc\u30d7\u300cDevelopment Tools\u300d\u3068\u30d1\u30c3\u30b1\u30fc\u30b8\u300cpython-virtualenv\u300d\u306e\u5c0e\u5165\u3002\n\n```\n[root@step-server ~]# yum groupinstall -y \"Development Tools\"\n\uff5e\uff5e\uff5e\uff5e\uff5e\uff5e\uff5e\uff5e\nComplete!\n[root@step-server ~]# yum install -y python-virtualenv\n\uff5e\uff5e\uff5e\uff5e\uff5e\uff5e\uff5e\uff5e\nComplete!\n```\n\n\u3053\u306e\u5f8c\u3001\u4e00\u822c\u30e6\u30fc\u30b6\u30fc\u304b\u3089\u4f5c\u696d\u3092\u3059\u308b\u3068\u3042\u308b\u306e\u3067\u3001\u4e00\u822c\u30e6\u30fc\u30b6\u30fc user01 \u3092\u4f5c\u6210\u3057\u5207\u308a\u66ff\u3048\u308b\u3002\n\n```\n[root@step-server ~]# adduser user01\n[root@step-server ~]# su - user01\n```\n\n\u4e00\u822c\u30e6\u30fc\u30b6\u30fc user01 \u3067python\u306e\u4eee\u60f3\u5b9f\u884c\u74b0\u5883\u306b\u5207\u308a\u66ff\u3048ansible\u3092\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u3002\n\n```\n[user01@step-server ~]$ virtualenv venv\nNew python executable in venv/bin/python\nInstalling Setuptools..............................................................................................................................................................................................................................done.\nInstalling Pip.....................................................................................................................................................................................................................................................................................................................................done.\n[user01@step-server ~]$ source venv/bin/activate\n\n(venv)[user01@step-server ~]$ pip install jinja2 passlib pycrypto pyyaml\nDownloading/unpacking jinja2\n\uff5e\uff5e\uff5e\uff5e\uff5e\uff5e\uff5e\uff5e\nSuccessfully installed jinja2 passlib pycrypto pyyaml markupsafe\nCleaning up...\n\n(venv)[user01@step-server ~]$ pip install ansible\nDownloading/unpacking ansible\n  Downloading ansible-1.9.0.1.tar.gz (916kB): 916kB downloaded\n\uff5e\uff5e\uff5e\uff5e\uff5e\uff5e\uff5e\uff5e\nSuccessfully installed ansible paramiko ecdsa\nCleaning up...\n\n(venv)[user01@step-server ~]$ ansible --version\nansible 1.9.0.1\n  configured module search path = None\n```\n\n1.9.0.1\u304c\u5c0e\u5165\u3055\u308c\u305f\u3002\u672c\u66f8\u3067\u306f1.8.2\u3067\u78ba\u8a8d\u3092\u3057\u3066\u3044\u308b\u3068\u3042\u308b\u3002\n\n### 11.2.2 Ansible\u306e\u57fa\u672c\u8a2d\u5b9a\n\n$HOME/.ansible.cfg\u306b\u57fa\u672c\u8a2d\u5b9a\u3092\u8a18\u8ff0\u3059\u308b\u3002\n\nlog\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u30fc\u3092\u4f5c\u308b\u3002\n\n```\n(venv)[user01@step-server ~]$ mkdir $HOME/log\n```\n\n$HOME/.ansible.cfg\u3092\u8a2d\u5b9a\u3059\u308b\u3002\n\n```\n(venv)[user01@step-server ~]$ nano .ansible.cfg\n(venv)[user01@step-server ~]$ cat .ansible.cfg\n[defaults]\nforks                   = 10\nlog_path                = /home/user01/log/ansible.log\nhost_key_checking       = False\ngathering               = smart\ntransport               = smart\n```\n\n### 11.2.3 Ansible\u306e\u52d5\u4f5c\u78ba\u8a8d\n\nAnsible\u3067localhost \u306bping\u3092\u6253\u3063\u3066\u307f\u308b\u3002\n\n```\n(venv)[user01@step-server ~]$ cd\n(venv)[user01@step-server ~]$ pwd\n/home/user01\n(venv)[user01@step-server ~]$ echo \"localhost ansible_connection=local\" > ansible_hosts\n(venv)[user01@step-server ~]$ ansible all -i ansible_hosts -m ping\nlocalhost | success >> {\n    \"changed\": false,\n    \"ping\": \"pong\"\n}\n```\n\nansible_hosts\u306b192.168.0.11\u3068192.168.0.21\u3092\u8db3\u3059\u3002192.168.0.11\u306e\u30db\u30b9\u30c8\u306f\u5b58\u5728\u3057\u306a\u3044\u3002192.168.0.21\u306f\u7b2c10\u7ae0\u3067\u751f\u304d\u6b8b\u3063\u305faz2-dbs01\u306e\u30a2\u30c9\u30ec\u30b9\u3067\u3042\u308b\u3002\n\n```\n(venv)[user01@step-server ~]$ nano ansible_hosts\n(venv)[user01@step-server ~]$ cat ansible_hosts\nlocalhost ansible_connection=local\n192.168.0.11\n192.168.0.21\n```\n\n\nAnsible\u306f\u3001\u57fa\u672c\u7684\u306bssh\u3067\u63a5\u7d9a\u3057\u3066\u64cd\u4f5c\u3059\u308b\u3002\nlocalhost\u306f\u300cansible_connection=local\u300d\u306a\u306e\u3067ssh\u63a5\u7d9a\u305b\u305a\u306b\u5b9f\u884c\u3057success\u3059\u308b\u3002\n192.168.0.21\u306f\u3001ssh\u3067TCP\u63a5\u7d9a\u306f\u3057\u305f\u304c\u30ed\u30b0\u30a4\u30f3\u3067\u304d\u306a\u304b\u3063\u305f\u305f\u3081\u306b\u30a8\u30e9\u30fc\u306b\u306a\u3063\u305f\u3002\n192.168.0.11\u306f\u3001\u3053\u306eIP\u3067\u30b5\u30fc\u30d0\u30fc\u304c\u8d77\u52d5\u3057\u3066\u3044\u306a\u3044\u306e\u3067ssh\u3067\u306eTCP\u63a5\u7d9a\u3067\u30a8\u30e9\u30fc\u306b\u306a\u3063\u305f\u3002\n\n```\n(venv)[user01@step-server ~]$ ansible all -i ansible_hosts -m ping\nlocalhost | success >> {\n    \"changed\": false,\n    \"ping\": \"pong\"\n}\n\n192.168.0.21 | FAILED => SSH Error: Permission denied (publickey,gssapi-keyex,gssapi-with-mic).\n    while connecting to 192.168.0.21:22\nIt is sometimes useful to re-run the command using -vvvv, which prints SSH debug output to help diagnose the issue.\n192.168.0.11 | FAILED => SSH Error: ssh: connect to host 192.168.0.11 port 22: No route to host\n    while connecting to 192.168.0.11:22\nIt is sometimes useful to re-run the command using -vvvv, which prints SSH debug output to help diagnose the issue.\n```\n\nssh\u3067192.168.0.21\u306b\u30ed\u30b0\u30a4\u30f3\u3067\u304d\u308b\u3088\u3046\u306b\u3059\u308b\u3002ssh\u306e\u79d8\u5bc6\u9375\u3092/home/user01/\u306b\u30b3\u30d4\u30fc\u3057\u3001\u30aa\u30fc\u30ca\u30fc\u3092user01\u306b\u3059\u308b\u3002\n\n```\n[root@step-server ~]# cp key-for-internal.pem /home/user01/\n[root@step-server ~]# cd /home/user01\n[root@step-server user01]# chown user01 key-for-internal.pem\n[root@step-server user01]# ls -al key-for-internal.pem\n-rw------- 1 user01 root 1680 Mar 29 18:03 key-for-internal.pem\n```\n\n.ansible.cfg\u306eprivate_key_file\u306b\u79d8\u5bc6\u9375\u3092\u30d5\u30eb\u30d1\u30b9\u3067\u8a2d\u5b9a\u3059\u308b\u3002\n\n```\n(venv)[user01@step-server ~]$ cat .ansible.cfg\n[defaults]\nforks                   = 10\nlog_path                = /home/user01/log/ansible.log\nhost_key_checking       = False\ngathering               = smart\ntransport               = smart\nprivate_key_file        = /home/user01/key-for-internal.pem\n```\nansible\u3092\u5b9f\u884c\u3059\u308b\u3068\u304d\u300c-u root\u300d\u3092\u6307\u5b9a\u3057\u3001\u76f8\u624b\u306broot\u3067\u5165\u308b\u4e8b\u3092\u5ba3\u8a00\u3059\u308b\u3002\n/home/user01/key-for-internal.pem\u3067root@192.168.0.21\u306b\u63a5\u7d9a\u3067\u304d\u3001ping\u304c\u6210\u529f\u3057\u305f\u3002\n\n192.168.0.11\u304c\u5931\u6557\u3059\u308b\u306e\u306f\u5f53\u7136\u3002\n\n```\n(venv)[user01@step-server ~]$ ansible all -i ansible_hosts -m ping -u root\nlocalhost | success >> {\n    \"changed\": false,\n    \"ping\": \"pong\"\n}\n\n192.168.0.21 | success >> {\n    \"changed\": false,\n    \"ping\": \"pong\"\n}\n\n192.168.0.11 | FAILED => SSH Error: ssh: connect to host 192.168.0.11 port 22: No route to host\n    while connecting to 192.168.0.11:22\nIt is sometimes useful to re-run the command using -vvvv, which prints SSH debug output to help diagnose the issue.\n```\n\n\u5bfe\u8c61\u3092\u300call:**!**192.168.0.11\u300d\u3068\u3059\u308b\u3002\u300c**!**\u300d\u3067192.168.0.11\u3092\u9664\u3044\u305f\u300call\u300d\u304c\u5bfe\u8c61\u3068\u306a\u308b\u3002\n\n192.168.0.11\u304c\u5bfe\u8c61\u304b\u3089\u9664\u5916\u3055\u308c\u305f\u306e\u3067\u3001\u5bfe\u8c61\u5168\u3066\u306b\u6b63\u5e38\u306bping\u5fdc\u7b54\u304c\u78ba\u8a8d\u3067\u304d\u305f\u3002\n\n```\n(venv)[user01@step-server ~]$ ansible 'all:!192.168.0.11' -i ansible_hosts -m ping -u root\nlocalhost | success >> {\n    \"changed\": false,\n    \"ping\": \"pong\"\n}\n\n192.168.0.21 | success >> {\n    \"changed\": false,\n    \"ping\": \"pong\"\n}\n```\n\n## 11.3 Ansible\u306e\u4ed5\u7d44\u307f\n\n\u7bc0\u306e\u30bf\u30a4\u30c8\u30eb\u306e\u3068\u304a\u308aAnsible\u306e\u4ed5\u7d44\u307f\u306e\u89e3\u8aac\u3067\u3042\u308b\u3002\n\n\u3053\u306e\u30db\u30b9\u30c8\u540d\u3092\u5909\u66f4\u3059\u308b[\u30d7\u30ec\u30a4\u30d6\u30c3\u30af](https://github.com/josug-book1-materials/chapter11/blob/master/playbooks/samples/sample-11-1.yml)\u306e\u5b9f\u884c\u3067\u52d5\u4f5c\u3092\u78ba\u8a8d\u3059\u308b\u3002\n\n```\n(venv)[user01@step-server samples]$ ansible-playbook -i ~/ansible_hosts -u root -e target=192.168.0.21 sample-11-1.yml\n\nPLAY [192.168.0.21] ***********************************************************\n\nGATHERING FACTS ***************************************************************\nok: [192.168.0.21]\n\nTASK: [get hostname] **********************************************************\nchanged: [192.168.0.21]\n\nTASK: [set hostname] **********************************************************\nchanged: [192.168.0.21]\n\nNOTIFIED: [show hostname] *****************************************************\nok: [192.168.0.21] => {\n    \"msg\": \"before=az2-dbs01 after=ansible-host1\"\n}\n\nPLAY RECAP ********************************************************************\n192.168.0.21               : ok=4    changed=2    unreachable=0    failed=0\n\n```\n\naz2-dbs01 \u304b\u3089 ansible-host1 \u306b\u30db\u30b9\u30c8\u540d\u304c\u5909\u66f4\u3055\u308c\u305f\u3002\n\n\u3082\u3046\u4e00\u5ea6\u3001\u5b9f\u884c\u3059\u308b\u3002\n\n```\n(venv)[user01@step-server samples]$ ansible-playbook -i ~/ansible_hosts -u root -e target=192.168.0.21 sample-11-1.yml\n\nPLAY [192.168.0.21] ***********************************************************\n\nGATHERING FACTS ***************************************************************\nok: [192.168.0.21]\n\nTASK: [get hostname] **********************************************************\nchanged: [192.168.0.21]\n\nTASK: [set hostname] **********************************************************\nok: [192.168.0.21]\n\nPLAY RECAP ********************************************************************\n192.168.0.21               : ok=3    changed=1    unreachable=0    failed=0\n\n```\n\n\u3059\u3067\u306b\u30db\u30b9\u30c8\u540d\u304c\u5909\u66f4\u3055\u308c\u3066\u3044\u308b\u305f\u3081\u3001handlers\u306f\u547c\u3073\u51fa\u3055\u308c\u305a\u300cNOTIFIED: [show hostname]\u300d\u306f\u547c\u3073\u51fa\u3055\u308c\u306a\u3044\u3002\n\n## 14.4 Ansible\u306b\u3088\u308b\u57fa\u672c\u64cd\u4f5c\u306e\u81ea\u52d5\u5316\n\n### 14.4.1 CenrOS\u306e\u30d1\u30c3\u30b1\u30fc\u30b8\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb/\u30a2\u30c3\u30d7\u30c7\u30fc\u30c8\u3059\u308b\n\n\u30d1\u30c3\u30b1\u30fc\u30b8\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb/\u30a2\u30c3\u30d7\u30c7\u30fc\u30c8\u3059\u308b\u3002\u5229\u7528\u3059\u308b\u30d7\u30ec\u30a4\u30d6\u30c3\u30af\u306f[\u3053\u3061\u3089](https://github.com/josug-book1-materials/chapter11/blob/master/playbooks/samples/sample-11-2.yml)\u3002\n\n```\n(venv)[user01@step-server samples]$ ansible-playbook -i ~/ansible_hosts -u root -e target=192.168.0.21 sample-11-2.yml\n\nPLAY [192.168.0.21] ***********************************************************\n\nGATHERING FACTS ***************************************************************\nok: [192.168.0.21]\n\nTASK: [install or upgrade packages] *******************************************\nchanged: [192.168.0.21] => (item=bash,tcsh,zsh)\n\nPLAY RECAP ********************************************************************\n192.168.0.21               : ok=2    changed=1    unreachable=0    failed=0\n\n```\n\n### 11.4.2 \u30e6\u30fc\u30b6\u30fc\u30a2\u30ab\u30a6\u30f3\u30c8\u3092\u4f5c\u6210\u3059\u308b\n\n\u5bfe\u8c61\u30db\u30b9\u30c8\u306b\u30e6\u30fc\u30b6\u30fcansible\u3092\u4f5c\u6210\u3059\u308b\u3002\u5229\u7528\u3059\u308b\u30d7\u30ec\u30a4\u30d6\u30c3\u30af\u306f[\u3053\u3061\u3089](https://github.com/josug-book1-materials/chapter11/blob/master/playbooks/samples/sample-11-3.yml)\u3002\n\n```\n(venv)[user01@step-server samples]$ ansible-playbook -i ~/ansible_hosts -u root -e target=192.168.0.21 sample-11-3.yml\nEnter a new user's password:\nconfirm Enter a new user's password:\n***** VALUES ENTERED DO NOT MATCH ****\nEnter a new user's password:\nconfirm Enter a new user's password:\n\nPLAY [192.168.0.21] ***********************************************************\n\nGATHERING FACTS ***************************************************************\nok: [192.168.0.21]\n\nTASK: [add a new user on target host] *****************************************\nchanged: [192.168.0.21]\n\nTASK: [add a publickey on localhost to authorized_keys on target host] ********\nfatal: [192.168.0.21] => could not locate file in lookup: /root/.ssh/id_rsa.pub\n\nFATAL: all hosts have already failed -- aborting\n\nPLAY RECAP ********************************************************************\n           to retry, use: --limit @/home/user01/sample-11-3.retry\n\n192.168.0.21               : ok=2    changed=1    unreachable=1    failed=0\n\n```\n\n\u30d1\u30b9\u30ef\u30fc\u30c9\u306e\u518d\u5165\u529b\u3067\u30df\u30b9\u3057\u305f\u3089\u518d\u5ea6\u5165\u529b\u3092\u6c42\u3081\u3089\u308c\u305f\u3002\n\u300c/root/.ssh/id_rsa.pub\u300d\u3078\u306e\u30a2\u30af\u30bb\u30b9\u3067\u30a8\u30e9\u30fc\u306b\u306a\u3063\u3066\u3044\u308b\u3002\u672c\u66f8\u3092\u3001\u3088\u304f\u8aad\u3080\u3068\u3001\u4e8b\u524d\u306bssh-keygen\u3067\u4f5c\u6210\u3057\u3066\u304a\u3044\u305f\u516c\u958b\u9375\u3092\u6307\u5b9a\u3059\u308b\u3068\u3042\u308b\u3002\n\n\u300c/home/user01/.ssh/id_rsa.pub\u300d\u3092\u4f5c\u308b\u3002\n\n```\n(venv)[user01@step-server samples]$ ssh-keygen -t rsa\nGenerating public/private rsa key pair.\nEnter file in which to save the key (/home/user01/.ssh/id_rsa):\nEnter passphrase (empty for no passphrase):\nEnter same passphrase again:\nYour identification has been saved in /home/user01/.ssh/id_rsa.\nYour public key has been saved in /home/user01/.ssh/id_rsa.pub.\nThe key fingerprint is:\n74:11:82:b0:f5:aa:c2:0f:cf:b8:45:f4:d6:26:44:7a user01@step-server\nThe key's randomart image is:\n+--[ RSA 2048]----+\n|    ..o.. o.     |\n|     =.. . .     |\n|    + E o .      |\n|   . + + .       |\n|    . = S        |\n| . . o o         |\n|  + o            |\n|   O             |\n|  o.+            |\n+-----------------+\n```\n\n\u516c\u958b\u9375\u306e\u30d5\u30a1\u30a4\u30eb\u540d\u3092\u66f8\u304d\u63db\u3048\u308b\u3002\n\n```\n    authorized_key:\n      user: \"{{ username }}\"\n      key: \"{{ lookup('file', '/home/user01/.ssh/id_rsa.pub') }}\"\n```\n\n\u4eca\u5ea6\u306f\u6210\u529f\u3057\u305f\u3002\n\n```\n(venv)[user01@step-server samples]$ ansible-playbook -i ~/ansible_hosts -u root -e target=192.168.0.21 sample-11-3.yml\nEnter a new user's password:\nconfirm Enter a new user's password:\n\nPLAY [192.168.0.21] ***********************************************************\n\nGATHERING FACTS ***************************************************************\nok: [192.168.0.21]\n\nTASK: [add a new user on target host] *****************************************\nchanged: [192.168.0.21]\n\nTASK: [add a publickey on localhost to authorized_keys on target host] ********\nchanged: [192.168.0.21]\n\nPLAY RECAP ********************************************************************\n192.168.0.21               : ok=3    changed=2    unreachable=0    failed=0\n```\n\nssh\u30ed\u30b0\u30a4\u30f3\u304c\u53ef\u80fd\u306b\u306a\u3063\u3066\u3044\u308b\u3002\n\n```\n(venv)[user01@step-server samples]$ ssh ansible@192.168.0.21\n[ansible@ansible-host1 ~]$ exit\nlogout\nConnection to 192.168.0.21 closed.\n```\n\n### 11.4.3 sudo\u306e\u8a2d\u5b9a\u3092\u8ffd\u52a0\u3059\u308b\n\n\u300c/etc/sudoers\u300d\u306bansible\u304c\u6240\u5c5e\u3059\u308bwheel\u3092\u8ffd\u52a0\u3059\u308b\u3002\u8ffd\u52a0\u3059\u308b\u306e\u306f\u5b58\u5728\u3057\u306a\u3044\u5834\u5408\u3060\u3051\u3002\u5229\u7528\u3059\u308b\u30d7\u30ec\u30a4\u30d6\u30c3\u30af\u306f[\u3053\u3061\u3089](https://github.com/josug-book1-materials/chapter11/blob/master/playbooks/samples/sample-11-4.yml)\u3002\n\n\u4e00\u5ea6\u76ee\u306f\u3001\u30a8\u30f3\u30c8\u30ea\u30fc\u304c\u7121\u3044\u306e\u3067\u300cTASK: [grant privileges to do the sudo command to the wheel group]\u300d\u304c\u300cchanged\u300d\u306b\u306a\u308b\u3002\n\n```\n(venv)[user01@step-server samples]$ ansible-playbook -i ~/ansible_hosts -u root -e target=192.168.0.21 sample-11-4.yml\n\nPLAY [192.168.0.21] ***********************************************************\n\nGATHERING FACTS ***************************************************************\nok: [192.168.0.21]\n\nTASK: [grant privileges to do the sudo command to the wheel group] ************\nchanged: [192.168.0.21]\n\nPLAY RECAP ********************************************************************\n192.168.0.21               : ok=2    changed=1    unreachable=0    failed=0\n```\n\n\u518d\u5ea6\u5b9f\u884c\u3059\u308b\u3068\u5b58\u5728\u3059\u308b\u306e\u3067\u300cok\u300d\u3068\u8868\u793a\u3055\u308c\u3001\u8ffd\u52a0\u306f\u884c\u308f\u308c\u306a\u3044\u3002\n\n```\n(venv)[user01@step-server samples]$ ansible-playbook -i ~/ansible_hosts -u root -e target=192.168.0.21 sample-11-4.yml\n\nPLAY [192.168.0.21] ***********************************************************\n\nGATHERING FACTS ***************************************************************\nok: [192.168.0.21]\n\nTASK: [grant privileges to do the sudo command to the wheel group] ************\nok: [192.168.0.21]\n\nPLAY RECAP ********************************************************************\n192.168.0.21               : ok=2    changed=0    unreachable=0    failed=0\n```\n\n### 11.4.4 \u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092\u914d\u7f6e\u3057\u3066\u30b5\u30fc\u30d3\u30b9\u3092\u30ea\u30b9\u30bf\u30fc\u30c8\u3059\u308b\u3002\n\n\u7528\u610f\u3057\u3066\u3042\u308b[my.cnf.j2](https://github.com/josug-book1-materials/chapter11/blob/master/playbooks/samples/my.cnf.j2)\u3092/etc/my.cnf\u306b\u30b3\u30d4\u30fc\u3059\u308b\u3002\u30d5\u30a1\u30a4\u30eb\u306e\u7f6e\u304d\u63db\u3048\u304c\u767a\u751f\u3057\u305f\u3068\u304d\u3060\u3051\u3001MySQL\u3092\u30ea\u30b9\u30bf\u30fc\u30c8\u3059\u308b\u3002\u5229\u7528\u3059\u308b\u30d7\u30ec\u30a4\u30d6\u30c3\u30af\u306f[\u3053\u3061\u3089](https://github.com/josug-book1-materials/chapter11/blob/master/playbooks/samples/sample-11-5.yml)\u3002\n\n\u4e00\u5ea6\u76ee\u306f[replace my.cnf]\u304cchanged\u3067\u3001[restart database]\u304c\u547c\u3073\u51fa\u3055\u308c\u3066\u3044\u308b\u3002\n\n```\n(venv)[user01@step-server samples]$ ansible-playbook -i ~/ansible_hosts -u root -e target=192.168.0.21 sample-11-5.yml\n\nPLAY [192.168.0.21] ***********************************************************\n\nGATHERING FACTS ***************************************************************\nok: [192.168.0.21]\n\nTASK: [replace my.cnf] ********************************************************\nchanged: [192.168.0.21]\n\nNOTIFIED: [restart database] **************************************************\nchanged: [192.168.0.21]\n\nPLAY RECAP ********************************************************************\n192.168.0.21               : ok=3    changed=2    unreachable=0    failed=0\n```\n\n2\u5ea6\u76ee\u306f[replace my.cnf]\u304cok\u3067\u3001[restart database]\u306f\u547c\u3073\u51fa\u3055\u306a\u3044\u3002\n\n```\n(venv)[user01@step-server samples]$ ansible-playbook -i ~/ansible_hosts -u root -e target=192.168.0.21 sample-11-5.yml\n\nPLAY [192.168.0.21] ***********************************************************\n\nGATHERING FACTS ***************************************************************\nok: [192.168.0.21]\n\nTASK: [replace my.cnf] ********************************************************\nok: [192.168.0.21]\n\nPLAY RECAP ********************************************************************\n192.168.0.21               : ok=2    changed=0    unreachable=0    failed=0\n```\n\n### 11.4.5 OS\u3092\u518d\u8d77\u52d5\u3057\u3066\u8d77\u52d5\u5b8c\u4e86\u3092\u78ba\u8a8d\u3059\u308b\u3002\n\n\u5bfe\u8c61\u3092reboot\u30572\u5206\u5f85\u3063\u3066\u304b\u308910\u79d2\u9593\u9694\u3067ssh\u63a5\u7d9a\u3067\u304d\u308b\u304b\u78ba\u8a8d\u3059\u308b\u3002\u5229\u7528\u3059\u308b\u30d7\u30ec\u30a4\u30d6\u30c3\u30af\u306f[\u3053\u3061\u3089](https://github.com/josug-book1-materials/chapter11/blob/master/playbooks/samples/sample-11-6.yml)\u3002\n\npause\u30e2\u30b8\u30e5\u30fc\u30eb\u3067\u505c\u6b62\u4e2d\u306e\u5834\u5408\u300c(^C-c = continue early, ^C-a = abort)\u300d\u306e\u8868\u793a\u3067\u308f\u304b\u308b\u3088\u3046\u306b\u300cCtrl+C\u300d\u3067\u300cAction? (a)bort/(c)ontinue:\u300d\u306e\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u51fa\u3057\u4e2d\u6b62\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u308b\u3002\n\n```\n(venv)[user01@step-server samples]$ ansible-playbook -i ~/ansible_hosts -u root -e target=192.168.0.21 sample-11-6.yml\n\nPLAY [192.168.0.21] ***********************************************************\n\nGATHERING FACTS ***************************************************************\nok: [192.168.0.21]\n\nTASK: [reboot server] *********************************************************\nchanged: [192.168.0.21]\n\nTASK: [wait for shutdown process] *********************************************\n(^C-c = continue early, ^C-a = abort)\n[192.168.0.21]\nPausing for 120 seconds\n^C\nAction? (a)bort/(c)ontinue:\nok: [192.168.0.21 -> 127.0.0.1]\n\nTASK: [check the server to start up] ******************************************\nok: [192.168.0.21 -> 127.0.0.1]\n\nPLAY RECAP ********************************************************************\n192.168.0.21               : ok=4    changed=1    unreachable=0    failed=0\n```\n\npause\u30e2\u30b8\u30e5\u30fc\u30eb\u3067\u306e\u505c\u6b62\u4e2d\u3092\u5f85\u305f\u306a\u3044\u3067\u300cCtrl+C\u300d\u3092\u62bc\u3057\u305f\u3089\u3001\u7d42\u4e86\u3057\u3066\u3057\u307e\u3063\u305f\u3002\n\n```\nTASK: [reboot server] *********************************************************\n^CERROR: interrupted\n(venv)[user01@step-server samples]$\n```\n\n## 11.5 OpenStack\u7ba1\u7406\u4f5c\u696d\u306e\u81ea\u52d5\u5316\n\n### 11.5.1 \u4e8b\u524d\u6e96\u5099\u4f5c\u696d\n\n\u8e0f\u307f\u53f0\u30b5\u30fc\u30d0\u30fc\u3067\u30e6\u30fc\u30b6\u30fcansible\u3092\u4f5c\u6210\u3057\u3066\u5207\u308a\u66ff\u3048\u308b\u3002\n\n```\n[root@step-server ~]# useradd ansible\n[root@step-server ~]# cp /root/openrc /home/ansible/\n[root@step-server ~]# chown ansible:ansible /home/ansible/openrc\n[root@step-server ~]# su - ansible\n[ansible@step-server ~]$\n```\n\n\n\u30e6\u30fc\u30b6\u30fcansible\u3067ansible\u3092pip\u306b\u3088\u308b\u5c0e\u5165\u3059\u308b\u3002\n\n```\n[ansible@step-server ~]$ virtualenv venv\nNew python executable in venv/bin/python\nInstalling Setuptools.............................................................................................done.\nInstalling Pip....................................................................................................................................done.\n\n[ansible@step-server ~]$ source venv/bin/activate\n\n(venv)[ansible@step-server ~]$ pip install jinja2 passlib pycrypto pyyaml\nDownloading/unpacking jinja2\n\uff5e\uff5e\uff5e\uff5e\uff5e\uff5e\uff5e\uff5e\nSuccessfully installed jinja2 passlib pycrypto pyyaml markupsafe\nCleaning up...\n\n(venv)[ansible@step-server ~]$ pip install ansible\nDownloading/unpacking ansible\n  Downloading ansible-1.9.0.1.tar.gz (916kB): 916kB downloaded\n\uff5e\uff5e\uff5e\uff5e\uff5e\uff5e\uff5e\uff5e\nSuccessfully installed ansible paramiko ecdsa\nCleaning up...\n```\n\n\u672c\u66f8\u306e\u652f\u63f4\u30d5\u30a1\u30a4\u30eb\u3068python-novaclient\u3001python-novaclient\u3092\u5c0e\u5165\u3059\u308b\u3002\n\n```\n(venv)[ansible@step-server ~]$ cd $HOME\n\n(venv)[ansible@step-server ~]$ git clone https://github.com/josug-book1-materials/chapter11.git\nInitialized empty Git repository in /home/ansible/chapter11/.git/\nremote: Counting objects: 218, done.\nremote: Total 218 (delta 0), reused 0 (delta 0), pack-reused 218\nReceiving objects: 100% (218/218), 32.98 KiB, done.\nResolving deltas: 100% (116/116), done.\n\n(venv)[ansible@step-server ~]$ pip install python-novaclient==2.16.0\nDownloading/unpacking python-novaclient==2.16.0\n  Downloading python-novaclient-2.16.0.tar.gz (227kB): 227kB downloaded\n\uff5e\uff5e\uff5e\uff5e\uff5e\uff5e\uff5e\uff5e\nSuccessfully installed python-novaclient pbr argparse iso8601 PrettyTable requests simplejson six Babel pytz\nCleaning up..\n\n(venv)[ansible@step-server ~]$ pip install python-neutronclient==2.3.4\nDownloading/unpacking python-neutronclient==2.3.4\n  Downloading python-neutronclient-2.3.4.tar.gz (105kB): 105kB downloaded\n\uff5e\uff5e\uff5e\uff5e\uff5e\uff5e\uff5e\uff5e\nSuccessfully installed python-neutronclient cliff httplib2 cmd2 pyparsing stevedore\nCleaning up...\n```\n\noprnrc\u306b\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u306eUUID\u3092\u53d6\u5f97\u3059\u308b\u90e8\u5206\u3092\u52a0\u3048[\u3053\u306e\u69d8](https://github.com/josug-book1-materials/chapter11/blob/master/sample_openrc)\u306b\u3057\u3001\u5b9f\u884c\u3059\u308b\u3002\n\n```\n(venv)[ansible@step-server ~]$ cat openrc\nexport OS_AUTH_URL=http://192.168.100.10:5000/v2.0/\nexport OS_REGION_NAME=RegionOne\nexport OS_TENANT_NAME=SNSApp\nexport OS_USERNAME=snsapp-infra-user\nexport OS_PASSWORD=passw0rd\n\nfunction get_uuid () { cat - | grep \" id \" | awk '{print $4}'; }\nexport OS_DMZ_NET=`neutron net-show dmz-net | get_uuid`\nexport OS_APP_NET=`neutron net-show app-net | get_uuid`\nexport OS_DBS_NET=`neutron net-show dbs-net | get_uuid`\n\n(venv)[ansible@step-server ~]$ source openrc\n```\n\n\u30ad\u30fc\u30da\u30a2\u3092\u4f5c\u6210\u3057OpenStack\u306b\u767b\u9332\u3059\u308b\u3002\n\n<pre>\n(venv)[ansible@step-server ~]$ ssh-keygen -t rsa -b 2048 -N \"\"\nGenerating public/private rsa key pair.\nEnter file in which to save the key (/home/ansible/.ssh/id_rsa):\nCreated directory '/home/ansible/.ssh'.\nYour identification has been saved in /home/ansible/.ssh/id_rsa.\nYour public key has been saved in /home/ansible/.ssh/id_rsa.pub.\nThe key fingerprint is:\na1:49:c1:a2:6d:db:3b:bb:d9:91:50:88:0a:0d:53:1f ansible@step-server\nThe key's randomart image is:\n+--[ RSA 2048]----+\n|o.. E..          |\n| + ..o.o         |\n|. .oo.o o        |\n| ...o. + .       |\n|  .. o+ S        |\n|    . .. .       |\n|       .o        |\n|      oo .       |\n|      ++.        |\n+-----------------+\n\n(venv)[ansible@step-server ~]$ nova keypair-add --pub-key .ssh/id_rsa.pub key-for-ansible\n\n(venv)[ansible@step-server ~]$ nova keypair-list\n+---------------------+-------------------------------------------------+\n| Name                | Fingerprint                                     |\n+---------------------+-------------------------------------------------+\n| key-for-step-server | c6:a2:cd:b5:ee:0b:29:ae:19:61:27:f8:5d:28:5f:8b |\n| key-for-internal    | 9d:89:c8:a7:c6:4b:f1:23:8c:41:9f:3f:a8:bf:91:77 |\n| key-for-ansible     | a1:49:c1:a2:6d:db:3b:bb:d9:91:50:88:0a:0d:53:1f |\n+---------------------+-------------------------------------------------+\n</pre>\n\n### 11.5.2 \u4eee\u60f3\u30de\u30b7\u30f3\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u69cb\u7bc9\u306e\u81ea\u52d5\u5316\n\nweb\u3001app\u3001dbs\u3068\u5f79\u5272\u3092\u6307\u5b9a\u3059\u308b\u3068\u3001\u305d\u306e\u5f79\u5272\u306e\u4eee\u60f3\u30de\u30b7\u30f3\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u69cb\u7bc9\u3059\u308b\u3002\u30d7\u30ec\u30a4\u30d6\u30c3\u30af\u306f[\u3053\u3061\u3089](https://github.com/josug-book1-materials/chapter11/blob/master/playbooks/book1/create_sample_vm.yml)\u3002\n\n\n\u30d7\u30ec\u30a4\u30d6\u30c3\u30af\u3092\u30db\u30fc\u30e0\u306b\u30b3\u30d4\u30fc\u3057\u3001\u30ed\u30fc\u30ab\u30eb\u63a5\u7d9a\u306bssh\u3092\u4f7f\u308f\u306a\u3044\u3053\u3068\u3092\u5ba3\u8a00\u3059\u308b\u30fb\n\n```\n(venv)[ansible@step-server ~]$ cd\n\n(venv)[ansible@step-server ~]$ cp chapter11/playbooks/book1/create_sample_vm.yml .\n\n(venv)[ansible@step-server ~]$ echo \"localhost ansible_connection=local\" > ansible_hosts\n```\n\n\u300ctarget=web\u300d\u3092\u6307\u5b9a\u3057\u3066\u30d7\u30ec\u30a4\u30d6\u30c3\u30af\u3092\u5b9f\u884c\u3059\u308b\u3002\n\n```\n(venv)[ansible@step-server ~]$ ansible-playbook -i ansible_hosts -e target=web create_sample_vm.yml\n\nPLAY [localhost] **************************************************************\n\nGATHERING FACTS ***************************************************************\nok: [localhost]\n\nTASK: [ansible_python_interpreter setup] **************************************\nok: [localhost]\n\nTASK: [get uuid for generate hostname] ****************************************\nchanged: [localhost]\n\nTASK: [create {{ target }}-server on nova-compute with floating_ip] ***********\nchanged: [localhost]\n\nTASK: [create {{ target }}-server on nova-compute without floating_ip] ********\nskipping: [localhost]\n\nPLAY RECAP ********************************************************************\nlocalhost                  : ok=4    changed=2    unreachable=0    failed=0\n\n```\n\n\u30b5\u30fc\u30d0\u30fc\u304c\u4f5c\u6210\u3055\u308cFloating IP\u3082\u4ed8\u4e0e\u3055\u308c\u3066\u3044\u308b\u3002\n\n<pre>\n(venv)[ansible@step-server ~]$ nova list --name ^web- --field name,networks\n+--------------------------------------+------------------------------------------+-------------------------------------------------------------+\n| ID                                   | Name                                     | Networks                                                    |\n+--------------------------------------+------------------------------------------+-------------------------------------------------------------+\n| 0055b5ed-5180-4b06-8805-c8b6205040dd | web-520710f9-08d3-41cd-9d28-aa6cc4bfca66 | dmz-net=192.168.0.22, 192.168.100.135; app-net=172.16.10.15 |\n+--------------------------------------+------------------------------------------+-------------------------------------------------------------+\n\n(venv)[ansible@step-server ~]$ nova floating-ip-list\n+-----------------+-----------+--------------+---------+\n| Ip              | Server Id | Fixed Ip     | Pool    |\n+-----------------+-----------+--------------+---------+\n| 192.168.100.135 |           | 192.168.0.22 | Ext-Net |\n| 192.168.100.131 |           | 10.0.0.1     | Ext-Net |\n| 192.168.100.134 |           | 192.168.0.19 | Ext-Net |\n| 192.168.100.133 |           | 192.168.0.5  | Ext-Net |\n+-----------------+-----------+--------------+---------+\n</pre>\n\n\n\u300ctarget=app\u300d\u3067\u4f5c\u6210\u3002\n\n```\n(venv)[ansible@step-server ~]$ ansible-playbook -i ansible_hosts -e target=app create_sample_vm.yml\n\nPLAY [localhost] **************************************************************\n\nGATHERING FACTS ***************************************************************\nok: [localhost]\n\nTASK: [ansible_python_interpreter setup] **************************************\nok: [localhost]\n\nTASK: [get uuid for generate hostname] ****************************************\nchanged: [localhost]\n\nTASK: [create {{ target }}-server on nova-compute with floating_ip] ***********\nskipping: [localhost]\n\nTASK: [create {{ target }}-server on nova-compute without floating_ip] ********\nchanged: [localhost]\n\nPLAY RECAP ********************************************************************\nlocalhost                  : ok=4    changed=2    unreachable=0    failed=0\n```\n\n\u4f5c\u6210\u3055\u308c\u305f\u3002\n\n<pre>\n(venv)[ansible@step-server ~]$ nova list --name ^app- --field name,networks\n+--------------------------------------+------------------------------------------+-----------------------------------------------------------------+\n| ID                                   | Name                                     | Networks                                                        |\n+--------------------------------------+------------------------------------------+-----------------------------------------------------------------+\n| ab7c19c6-6f4f-438e-8cdf-012dbb7a4cc1 | app-18e1b380-a213-4518-a3ae-30ccad545014 | dmz-net=192.168.0.23; app-net=172.16.10.16; dbs-net=172.16.20.8 |\n+--------------------------------------+------------------------------------------+-----------------------------------------------------------------+\n</pre>\n\n\u300ctarget=dbs\u300d\u3067\u4f5c\u6210\u3002\n\n<pre>\n(venv)[ansible@step-server ~]$ ansible-playbook -i ansible_hosts -e target=dbs create_sample_vm.yml\n\nPLAY [localhost] **************************************************************\n\nGATHERING FACTS ***************************************************************\nok: [localhost]\n\nTASK: [ansible_python_interpreter setup] **************************************\nok: [localhost]\n\nTASK: [get uuid for generate hostname] ****************************************\nchanged: [localhost]\n\nTASK: [create {{ target }}-server on nova-compute with floating_ip] ***********\nskipping: [localhost]\n\nTASK: [create {{ target }}-server on nova-compute without floating_ip] ********\nchanged: [localhost]\n\nPLAY RECAP ********************************************************************\nlocalhost                  : ok=4    changed=2    unreachable=0    failed=0\n\n(venv)[ansible@step-server ~]$ nova list --name ^dbs- --field name,networks\n+--------------------------------------+------------------------------------------+-------------------------------------------+\n| ID                                   | Name                                     | Networks                                  |\n+--------------------------------------+------------------------------------------+-------------------------------------------+\n| 359d02ea-098e-4e03-966e-81bbc40da2c0 | dbs-968a948e-7e58-4089-a6c6-6b2a38bb71e6 | dmz-net=192.168.0.24; dbs-net=172.16.20.9 |\n+--------------------------------------+------------------------------------------+-------------------------------------------+\n</pre>\n\n\n### 11.5.3 \u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30c7\u30d7\u30ed\u30a4\u306e\u81ea\u52d5\u5316\n\n\u3053\u3053\u3067\u884c\u3046\u306e\u306f\u3001\u4e0b\u8a18\u306e4\u70b9\u3067\u3042\u308b\u3002\n\n0. \u30bf\u30a4\u30e0\u30be\u30fc\u30f3\u306e\u5909\u66f4\n1. github\u304b\u3089\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u30c1\u30a7\u30c3\u30af\u30a2\u30a6\u30c8\n2. \u5c0e\u5165\u30b9\u30af\u30ea\u30d7\u30c8\u306e\u5b9f\u884c\n3. \u30b5\u30fc\u30d0\u30fc\u9593\u306e\u9023\u643a\u3092\u3068\u308bendpoint.conf\u3092\u5185\u5bb9\u3092\u66f8\u304d\u63db\u3048\u306a\u304c\u3089\u8ee2\u9001\n4. \u30b5\u30fc\u30d3\u30b9\u306e\u958b\u59cb\n\n\u30d7\u30ec\u30a4\u30d6\u30c3\u30af\u306f[\u3053\u3061\u3089](https://github.com/josug-book1-materials/chapter11/blob/master/playbooks/book1/install_sample_app.yml)\u3002\n\n\u307e\u305a\u3001ansible_hosts \u306b\u5bfe\u8c61\u30db\u30b9\u30c8\u306edmz-net\u306eIP\u3092\u8a18\u8ff0\u3059\u308b\u3002\u3053\u308c\u306f\u64cd\u4f5c\u7528\u3067\u3042\u308b\u3002\u307e\u305f\u3001endpoint.conf\u306e\u66f8\u304d\u63db\u3048\u7528\u306b\u3001web\u306b\u30bb\u30c3\u30c8\u3059\u308bapp\u306eapp-net\u306eIP\u3092\u3001app\u306b\u30bb\u30c3\u30c8\u3059\u308bdbs\u306edbs-net\u306eIP\u3092\u8a18\u8ff0\u3059\u308b\u3002\n\n```\n(venv)[ansible@step-server ~]$ cat ansible_hosts\n[localhost]\nlocalhost ansible_connection=local\n\n[web]\n192.168.0.22\n\n[app]\n192.168.0.23\n\n[dbs]\n192.168.0.24\n\n[web:vars]\napp = 172.16.10.16\n\n[app:vars]\ndbs = 172.16.20.9\n```\n\n\u30d7\u30ec\u30a4\u30d6\u30c3\u30af\u3068endpoint.conf\u306e\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u3092\u30db\u30fc\u30e0\u306b\u30b3\u30d4\u30fc\u3059\u308b\u3002\n\n```\n(venv)[ansible@step-server ~]$ cd\n\n(venv)[ansible@step-server ~]$ cp chapter11/playbooks/book1/install_sample_app.yml .\n\n(venv)[ansible@step-server ~]$ cp chapter11/playbooks/book1/endpoint.conf.j2 .\n```\n\n\u4f9d\u5b58\u95a2\u4fc2\u304c\u3042\u308b\u306e\u3067dbs\u3001app\u3001web\u306e\u9806\u306b\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u3002\n\n\u300ctarget=dbs\u300d\u3067\u5b9f\u884c\u3059\u308b\u3002\u30ed\u30b0\u30a4\u30f3\u3059\u308b\u306e\u3067\u300c-u root\u300d\u3082\u6307\u5b9a\u3057\u305f\u3002\u30a2\u30d7\u30ea\u3092github\u304b\u3089\u53d6\u5f97\u3059\u308b\u3068\u304d\u306b\u300c403 Forbidden\u300d\u304c\u51fa\u305f\u3002\n\n```\n(venv)[ansible@step-server ~]$ ansible-playbook -i ansible_hosts -e target=dbs -u root install_sample_app.yml\n\nPLAY [dbs] ********************************************************************\n\nGATHERING FACTS ***************************************************************\nThe authenticity of host '192.168.0.24 (192.168.0.24)' can't be established.\nRSA key fingerprint is 9d:7e:70:8f:da:c2:b0:1f:9c:57:39:c1:a1:01:9a:a3.\nAre you sure you want to continue connecting (yes/no)? yes\nok: [192.168.0.24]\n\nTASK: [change the timezone] ***************************************************\nchanged: [192.168.0.24]\n\nTASK: [checkout app from github] **********************************************\nfailed: [192.168.0.24] => {\"cmd\": \"/usr/bin/git clone --origin origin --branch v1.0 https://github.com/josug-book1-materials/sample-app.git /root/sample-app\", \"failed\": true, \"rc\": 128}\nstderr: error: The requested URL returned error: 403 Forbidden while accessing https://github.com/josug-book1-materials/sample-app.git/info/refs\n\nfatal: HTTP request failed\n\nstdout: Initialized empty Git repository in /root/sample-app/.git/\n\nmsg: error: The requested URL returned error: 403 Forbidden while accessing https://github.com/josug-book1-materials/sample-app.git/info/refs\n\nfatal: HTTP request failed\n\nFATAL: all hosts have already failed -- aborting\n\nPLAY RECAP ********************************************************************\n           to retry, use: --limit @/home/ansible/install_sample_app.retry\n\n192.168.0.24               : ok=2    changed=1    unreachable=0    failed=1\n```\n\n\u3068\u308a\u3042\u3048\u305a\u518d\u5b9f\u884c\u3057\u305f\u3002\u4eca\u5ea6\u306f\u6210\u529f\u3057\u305f\u3002\n\n```\n(venv)[ansible@step-server ~]$ ansible-playbook -i ansible_hosts -e target=dbs -u root install_sample_app.yml\n\nPLAY [dbs] ********************************************************************\n\nGATHERING FACTS ***************************************************************\nok: [192.168.0.24]\n\nTASK: [change the timezone] ***************************************************\nchanged: [192.168.0.24]\n\nTASK: [checkout app from github] **********************************************\nchanged: [192.168.0.24]\n\nTASK: [execute install script] ************************************************\nok: [192.168.0.24]\n\nTASK: [copy endpoint.conf to web and app server] ******************************\nskipping: [192.168.0.24]\n\nPLAY RECAP ********************************************************************\n192.168.0.24               : ok=4    changed=2    unreachable=0    failed=0\n```\n\n\u300ctarget=app\u300d\u3067\u5b9f\u884c\u3002\n\n```\n(venv)[ansible@step-server ~]$ ansible-playbook -i ansible_hosts -e target=app -u root install_sample_app.yml\n\nPLAY [app] ********************************************************************\n\nGATHERING FACTS ***************************************************************\nThe authenticity of host '192.168.0.23 (192.168.0.23)' can't be established.\nRSA key fingerprint is 4d:8e:f4:7d:06:ca:85:c4:b7:23:27:30:67:3a:8b:13.\nAre you sure you want to continue connecting (yes/no)? yes\nok: [192.168.0.23]\n\nTASK: [change the timezone] ***************************************************\nchanged: [192.168.0.23]\n\nTASK: [checkout app from github] **********************************************\nchanged: [192.168.0.23]\n\nTASK: [execute install script] ************************************************\nok: [192.168.0.23]\n\nTASK: [copy endpoint.conf to web and app server] ******************************\nchanged: [192.168.0.23]\n\nNOTIFIED: [startup service] ***************************************************\nchanged: [192.168.0.23]\n\nPLAY RECAP ********************************************************************\n192.168.0.23               : ok=6    changed=4    unreachable=0    failed=0\n```\n\n\n\u300ctarget=app\u300d\u3067\u5b9f\u884c\u3002\n\n```\n(venv)[ansible@step-server ~]$ ansible-playbook -i ansible_hosts -e target=web -u root install_sample_app.yml\n\nPLAY [web] ********************************************************************\n\nGATHERING FACTS ***************************************************************\nThe authenticity of host '192.168.0.22 (192.168.0.22)' can't be established.\nRSA key fingerprint is 28:30:e0:72:bc:7e:d8:61:da:1d:cb:67:02:19:8b:5e.\nAre you sure you want to continue connecting (yes/no)? yes\nok: [192.168.0.22]\n\nTASK: [change the timezone] ***************************************************\nchanged: [192.168.0.22]\n\nTASK: [checkout app from github] **********************************************\nchanged: [192.168.0.22]\n\nTASK: [execute install script] ************************************************\nok: [192.168.0.22]\n\nTASK: [copy endpoint.conf to web and app server] ******************************\nchanged: [192.168.0.22]\n\nNOTIFIED: [startup service] ***************************************************\nchanged: [192.168.0.22]\n\nPLAY RECAP ********************************************************************\n192.168.0.22               : ok=6    changed=4    unreachable=0    failed=0\n```\n\n### 11.5.4 \u30c0\u30a4\u30ca\u30df\u30c3\u30af\u30a4\u30f3\u30d9\u30f3\u30c8\u30ea\u30fc\u3067\u30db\u30b9\u30c8\u306e\u5897\u6e1b\u306b\u5bfe\u5fdc\n\n\u300c11.5.3 \u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30c7\u30d7\u30ed\u30a4\u306e\u81ea\u52d5\u5316\u300d\u3067\u306f\u5bfe\u8c61\u306eIP\u3092ansible_hosts\u306b\u8a18\u8ff0\u3057\u305f\u3002\u3057\u304b\u3057\u3001OpenStack\u3067\u306f\u57fa\u672c\u7684\u306b\u30c7\u30d7\u30ed\u30a4\u3059\u308b\u307e\u3067\u30a2\u30c9\u30ec\u30b9\u304c\u4e0d\u660e\u3067\u3042\u308b\u3002\nansible\u306b\u306f\u30a4\u30f3\u30d9\u30f3\u30c8\u30ea\u30fc\u60c5\u5831\u3092\u8fd4\u3059\u5916\u90e8\u30d7\u30ed\u30b0\u30e9\u30e0\u3092\u547c\u3073\u51fa\u3057\u3001\u305d\u308c\u3092\u5bfe\u8c61\u3068\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u308b\u3002\n\n\u5916\u90e8\u30d7\u30ed\u30b0\u30e9\u30e0\u306e\u6761\u4ef6\u306f\u3001\u4e0b\u8a18\u3068\u672c\u66f8\u306b\u3042\u308b\u3002\n\n0. \u5358\u4f53\u5b9f\u884c\u53ef\u80fd\n1. --list \u3092\u5f15\u6570\u3068\u3057\u305f\u5834\u5408\u3001\u30db\u30b9\u30c8\u30ea\u30b9\u30c8\u3092JSON\u3067\u8fd4\u3059\n2. --host <hostname>\u304c\u5f15\u6570\u306e\u5834\u5408\u3001\u30db\u30b9\u30c8\u7528\u306e\u30d1\u30e9\u30e1\u30fc\u30bf\u30fc\u3092JSON\u3067\u8fd4\u3059\n\n\u5358\u7d14\u306b\u30db\u30b9\u30c8\u30ea\u30b9\u30c8\u3092\u8fd4\u3059\u30b7\u30a7\u30eb\u3067\u5b9f\u884c\u3092\u78ba\u8a8d\u3059\u308b\u3002\n\n```\n(venv)[ansible@step-server ~]$ cat inventry.sh\n#!/bin/sh\n\nusage() {\n        echo \"Usage: invenrty.sh --list|--host hostname\"\n        exit 1\n}\n\ncase $1 in\n        \"--list\")\n                echo '{\"sns\":{\"hosts\":[\"192.168.0.22\",\"192.168.0.23\",\"192.168.0.24\"]}}'\n                ;;\n        \"--host\")\n                if [ \"x\"$2 == \"x\" ] || [ $# -ne 2 ]; then\n                        usage\n                fi\n                echo \"{}\"\n                ;;\n        *)\n                usage\n                ;;\nesac\n```\n\nping\u30e2\u30b8\u30e5\u30fc\u30eb\u3067\u78ba\u8a8d\u3059\u308b\u3068\u3001\u3053\u3093\u306a\u30b7\u30a7\u30eb\u3067\u3082\u6a5f\u80fd\u3059\u308b\u3002\n\n```\n(venv)[ansible@step-server ~]$ ansible sns -i inventry.sh -m ping -u root\n192.168.0.22 | success >> {\n    \"changed\": false,\n    \"ping\": \"pong\"\n}\n\n192.168.0.24 | success >> {\n    \"changed\": false,\n    \"ping\": \"pong\"\n}\n\n192.168.0.23 | success >> {\n    \"changed\": false,\n    \"ping\": \"pong\"\n}\n```\n\n\u7528\u610f\u3055\u308c\u3066\u308b[sample_app_inventory.py](https://github.com/josug-book1-materials/chapter11/blob/master/playbooks/sample_app_inventory.py)\u3068[sample_app_inventory.ini](https://github.com/josug-book1-materials/chapter11/blob/master/playbooks/sample_app_inventory.ini)\u3092\u30db\u30fc\u30e0\u306b\u30b3\u30d4\u30fc\u3059\u308b\u3002[sample_app_inventory.py](https://github.com/josug-book1-materials/chapter11/blob/master/playbooks/sample_app_inventory.py)\u306b\u306f\u5b9f\u884c\u6a29\u3092\u3064\u3051\u308b\u3002\n\n```\n(venv)[ansible@step-server ~]$ cd\n\n(venv)[ansible@step-server ~]$ cp chapter11/playbooks/sample_app_inventory.py .\n\n(venv)[ansible@step-server ~]$ cp chapter11/playbooks/sample_app_inventory.ini .\n\n(venv)[ansible@step-server ~]$ chmod u+x sample_app_inventory.py\n\n```\n\nini\u30d5\u30a1\u30a4\u30eb\u306f\u3001\u3053\u306e\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u308b\u3002\n\n```\n(venv)[ansible@step-server ~]$ cat sample_app_inventory.ini\n[DEFAULT]\n\n\n[stack]\napi_version    = 1.1\nos_username    = %OS_USERNAME%\nos_password    = %OS_PASSWORD%\nos_auth_url    = %AUTH_URL%\nos_region_name = %REGION_NAME%\nos_tenant_name = %TENANT_NAME%\n\n[sample_app]\nweb_hostname_prefix = web-\napp_hostname_prefix = app-\ndbs_hostname_prefix = dbs-\n\n\n##\n## [EOF]\n##\n```\n\n\u4eca\u56de\u306e\u74b0\u5883\u306b\u5408\u308f\u305b\u3066\u66f8\u304d\u63db\u3048\u308b\u3002\n\n```\n(venv)[ansible@step-server ~]$ cat sample_app_inventory.ini\n[DEFAULT]\n\n\n[stack]\napi_version    = 1.1\nos_username    = snsapp-infra-user\nos_password    = passw0rd\nos_auth_url    = http://192.168.100.10:5000/v2.0/\nos_region_name = RegionOne\nos_tenant_name = SNSApp\n\n[sample_app]\nweb_hostname_prefix = web-\napp_hostname_prefix = app-\ndbs_hostname_prefix = dbs-\n\n\n##\n## [EOF]\n##\n```\n\n\u5b9f\u884c\u3059\u308b\u3068\n\n```\n(venv)[ansible@step-server ~]$ ./sample_app_inventory.py --list\n{\n  \"_meta\": {\n    \"hostvars\": {\n      \"192.168.0.22\": {\n        \"app\": \"172.16.10.16\"\n      },\n      \"192.168.0.23\": {\n        \"dbs\": \"172.16.20.9\"\n      },\n      \"192.168.0.24\": {}\n    }\n  },\n  \"app\": {\n    \"hosts\": [\n      \"192.168.0.23\"\n    ],\n    \"vars\": {\n      \"dbs\": \"172.16.20.9\"\n    }\n  },\n  \"dbs\": {\n    \"hosts\": [\n      \"192.168.0.24\"\n    ],\n    \"vars\": {}\n  },\n  \"localhost\": {\n    \"hosts\": [\n      \"localhost\"\n    ],\n    \"vars\": {\n      \"ansible_connection\": \"local\"\n    }\n  },\n  \"web\": {\n    \"hosts\": [\n      \"192.168.0.22\"\n    ],\n    \"vars\": {\n      \"app\": \"172.16.10.16\"\n    }\n  }\n}\n```\n\n\u3053\u306e\u7ae0\u3067\u4f5c\u3063\u305f\u30b5\u30fc\u30d0\u30fc\u3092\u3044\u3063\u305f\u3093\u524a\u9664\u3059\u308b\u3002\n\n```\n(venv)[ansible@step-server ~]$ nova delete app-18e1b380-a213-4518-a3ae-30ccad545014\n(venv)[ansible@step-server ~]$ nova delete dbs-968a948e-7e58-4089-a6c6-6b2a38bb71e6\n(venv)[ansible@step-server ~]$ nova delete web-520710f9-08d3-41cd-9d28-aa6cc4bfca66\n```\n\n\u65b0\u898f\u306b\u30b5\u30fc\u30d0\u30fc\u3092\u8d77\u52d5\u3059\u308b\u3002\n\n```\n(venv)[ansible@step-server ~]$ echo \"localhost ansible_connection=local\" > ansible_hosts\n(venv)[ansible@step-server ~]$ ansible-playbook -i ansible_hosts -e target=web create_sample_vm.yml\n(venv)[ansible@step-server ~]$ ansible-playbook -i ansible_hosts -e target=app create_sample_vm.yml\n(venv)[ansible@step-server ~]$ ansible-playbook -i ansible_hosts -e target=dbs create_sample_vm.yml\n```\n\ndbs\u306b\u5c0e\u5165\u3059\u308b\u3002\u5bfe\u8c61IP\u304c[192.168.0.27]\u306b\u306a\u3063\u3066\u3044\u308b\u3002\n\n```\n(venv)[ansible@step-server ~]$ ansible-playbook -i sample_app_inventory.py -e target=dbs install_sample_app.yml\n\nPLAY [dbs] ********************************************************************\n\nGATHERING FACTS ***************************************************************\nThe authenticity of host '192.168.0.27 (192.168.0.27)' can't be established.\nRSA key fingerprint is a8:6a:42:e4:e2:19:2f:19:67:99:44:2e:8e:72:8b:40.\nAre you sure you want to continue connecting (yes/no)? yes\nok: [192.168.0.27]\n\nTASK: [change the timezone] ***************************************************\nchanged: [192.168.0.27]\n\nTASK: [checkout app from github] **********************************************\nchanged: [192.168.0.27]\n\nTASK: [execute install script] ************************************************\nok: [192.168.0.27]\n\nTASK: [copy endpoint.conf to web and app server] ******************************\nskipping: [192.168.0.27]\n\nPLAY RECAP ********************************************************************\n192.168.0.27               : ok=4    changed=2    unreachable=0    failed=0\n```\n\napp\u306b\u5c0e\u5165\u3059\u308b\u3002\u5bfe\u8c61IP\u304c[192.168.0.26]\u306b\u306a\u3063\u3066\u3044\u308b\u3002\n\n```\n(venv)[ansible@step-server ~]$ ansible-playbook -i sample_app_inventory.py -e target=app install_sample_app.yml\n\nPLAY [app] ********************************************************************\n\nGATHERING FACTS ***************************************************************\nThe authenticity of host '192.168.0.26 (192.168.0.26)' can't be established.\nRSA key fingerprint is 82:84:ad:c8:3e:fe:fd:a9:b0:43:cd:fc:9d:d0:43:b6.\nAre you sure you want to continue connecting (yes/no)? yes\nok: [192.168.0.26]\n\nTASK: [change the timezone] ***************************************************\nchanged: [192.168.0.26]\n\nTASK: [checkout app from github] **********************************************\nchanged: [192.168.0.26]\n\nTASK: [execute install script] ************************************************\nok: [192.168.0.26]\n\nTASK: [copy endpoint.conf to web and app server] ******************************\nchanged: [192.168.0.26]\n\nNOTIFIED: [startup service] ***************************************************\nchanged: [192.168.0.26]\n\nPLAY RECAP ********************************************************************\n192.168.0.26               : ok=6    changed=4    unreachable=0    failed=0\n```\n\nweb\u306b\u5c0e\u5165\u3059\u308b\u3002\u5bfe\u8c61IP\u304c[192.168.0.25]\u306b\u306a\u3063\u3066\u3044\u308b\u3002\n\n```\n(venv)[ansible@step-server ~]$ ansible-playbook -i sample_app_inventory.py -e target=web install_sample_app.yml\n\nPLAY [web] ********************************************************************\n\nGATHERING FACTS ***************************************************************\nThe authenticity of host '192.168.0.25 (192.168.0.25)' can't be established.\nRSA key fingerprint is b4:3c:b3:1c:bd:58:5f:4e:8c:72:6d:05:82:2e:a3:01.\nAre you sure you want to continue connecting (yes/no)? yes\nok: [192.168.0.25]\n\nTASK: [change the timezone] ***************************************************\nchanged: [192.168.0.25]\n\nTASK: [checkout app from github] **********************************************\nchanged: [192.168.0.25]\n\nTASK: [execute install script] ************************************************\nok: [192.168.0.25]\n\nTASK: [copy endpoint.conf to web and app server] ******************************\nchanged: [192.168.0.25]\n\nNOTIFIED: [startup service] ***************************************************\nchanged: [192.168.0.25]\n\nPLAY RECAP ********************************************************************\n192.168.0.25               : ok=6    changed=4    unreachable=0    failed=0\n```\n\n### 11.5.5 \u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306e\u30d0\u30c3\u30af\u30a2\u30c3\u30d7/\u30ea\u30b9\u30c8\u30a2\u3092\u81ea\u52d5\u5316\n\ndbs\u3067\u30b9\u30ca\u30c3\u30d7\u30b7\u30e7\u30c3\u30c8\u306e\u53d6\u5f97\u3001app\u3067\u30b5\u30fc\u30d3\u30b9\u306e\u518d\u8d77\u52d5\u3001\u30b9\u30ca\u30c3\u30d7\u30b7\u30e7\u30c3\u30c8\u306e\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u306e\u81ea\u52d5\u5316\u3067\u3042\u308b\u3002\n\n3\u30b9\u30c6\u30c3\u30d7\u306e\u30d7\u30ec\u30a4\u30d6\u30c3\u30af\u306f\u3053\u3061\u3089\u3002\n\n[create_snapshot.yml](https://github.com/josug-book1-materials/chapter11/blob/master/playbooks/book2/create_snapshot.yml)\u3001\n[restart_rest_service.yml](https://github.com/josug-book1-materials/chapter11/blob/master/playbooks/book2/restart_rest_service.yml)\n[backup_snapshot.yml](https://github.com/josug-book1-materials/chapter11/blob/master/playbooks/book2/backup_snapshot.yml)\n\n\u3053\u308c\u3092\u4e00\u6c17\u306b\u884c\u3046\u30d7\u30ec\u30a4\u30d6\u30c3\u30af\u306f\u3053\u3061\u3089\u3002\n\n[db_backup.yml](https://github.com/josug-book1-materials/chapter11/blob/master/playbooks/book2/db_backup.yml)\n\n\u3053\u308c\u3089\u306e\u30d7\u30ec\u30a4\u30d6\u30c3\u30af\u3092\u30db\u30fc\u30e0\u306b\u30b3\u30d4\u30fc\u3059\u308b\u3002\n\n```\n(venv)[ansible@step-server ~]$ cp chapter11/playbooks/book2/create_snapshot.yml .\n(venv)[ansible@step-server ~]$ cp chapter11/playbooks/book2/restart_rest_service.yml .\n(venv)[ansible@step-server ~]$ cp chapter11/playbooks/book2/backup_snapshot.yml .\n(venv)[ansible@step-server ~]$ cp chapter11/playbooks/book2/db_backup.yml .\n```\n\n\u4e00\u6c17\u306b\u884c\u3046[db_backup.yml](https://github.com/josug-book1-materials/chapter11/blob/master/playbooks/book2/db_backup.yml)\u3092\u5b9f\u884c\u3057\u305f\u304c\u30a8\u30e9\u30fc\u306b\u306a\u308b\u3002\n\n```\n(venv)[ansible@step-server ~]$ ansible-playbook -i sample_app_inventory.py -t snapshot,backup -u root db_backup.yml\n\nPLAY [dbs] ********************************************************************\n\nGATHERING FACTS ***************************************************************\nok: [192.168.0.27]\n\nTASK: [stop mysqld] ***********************************************************\nok: [192.168.0.27]\n\nTASK: [umount mysql_dir] ******************************************************\nok: [192.168.0.27]\n\nTASK: [create snapshot on lvm] ************************************************\nfailed: [192.168.0.27] => {\"changed\": true, \"cmd\": [\"lvcreate\", \"-s\", \"/dev/mysql_vg/mysql_vol01\", \"-L\", \"100m\", \"-n\", \"mysql_bk_snap01\"], \"delta\": \"0:00:00.009340\", \"end\": \"2015-03-30 17:32:52.913837\", \"rc\": 5, \"start\": \"2015-03-30 17:32:52.904497\", \"warnings\": []}\nstderr:   Volume group \"mysql_vg\" not found\n\nFATAL: all hosts have already failed -- aborting\n\nPLAY RECAP ********************************************************************\n           to retry, use: --limit @/home/ansible/db_backup.retry\n\n192.168.0.27               : ok=3    changed=0    unreachable=0    failed=1\n\n```\n\nlvm\u306esnapshot\u3092\u4f5c\u6210\u3057\u3088\u3046\u3068\u3057\u3066\u3044\u308b\u3051\u3069\u3001\n\n```\n\uff5e\uff5e\uff5e\uff5e\uff5e\uff5e\nmysql_dir: /var/lib/mysql\nmysql_vol: /dev/mysql_vg/mysql_vol01\nmysql_snap: mysql_bk_snap01\nmysql_snap_size: 100m\n\uff5e\uff5e\uff5e\uff5e\uff5e\uff5e\ncommand: lvcreate -s \"{{ mysql_vol }}\" -L \"{{ mysql_snap_size }}\" -n \"{{ mysql_snap }}\"\n```\n\ndbs\u306blv\u306f\u7121\u3044\u3057\uff0e\uff0e\uff0e\n\n```\n[root@dbs-e945fd19-f2ba-40a2-8470-ad1c6092eacf /]# lvdisplay\n  No volume groups found\n```\n\n\u63a5\u7d9a\u3055\u308c\u3066\u3044\u308bdisk\u306fvda\u3068vdb\u3002\n\n```\n[root@dbs-e945fd19-f2ba-40a2-8470-ad1c6092eacf /]# lsblk\nNAME                            MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT\nsr0                              11:0    1  410K  0 rom\nvda                             252:0    0   10G  0 disk\n\u2514\u2500vda1                          252:1    0   10G  0 part /\nvdb                             252:16   0   10G  0 disk /mnt\n```\n\n[backup_snapshot.yml](https://github.com/josug-book1-materials/chapter11/blob/master/playbooks/book2/backup_snapshot.yml)\u3067\u306f/dev/vdd1\u3092\u30de\u30a6\u30f3\u30c8\u3057\u3066\u3044\u308b\u306e\u3067\u3001vdc\u3068vdd\u304c\u63a5\u7d9a\u3055\u308c\u3066\u3044\u308b\u60f3\u5b9a\u306e\u3088\u3046\u3060\u3002\n[SoftLayer\u306e\u7121\u6599\u30d9\u30a2\u30e1\u30bf\u30eb\u3067OpenStack\u306e\u5b66\u7fd2\u3092\u3059\u308b(10) - \u7b2c9\u7ae0\u300c\u30d6\u30ed\u30c3\u30af\u30dc\u30ea\u30e5\u30fc\u30e0\u3092\u6d3b\u7528\u3057\u305f\u30c7\u30fc\u30bf\u4fdd\u8b77\u300d(Cinder\u306e\u5229\u7528)](http://qiita.com/orz/items/db45139054ee42612179)\u306e\u624b\u9806\u3092\u5143\u306b\u3001\u30dc\u30ea\u30e5\u30fc\u30e0\u30922\u672c\u8ffd\u52a0\u3059\u308b\u3002\nvdc\u306bLVM\u3092\u3064\u304f\u308amysql\u306e\u30c7\u30fc\u30bf\u9818\u57df\u3068\u3059\u308b\u3002\nvdd\u306f\u901a\u5e38\u306eext4\u306e\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u3068\u3057\u3066\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u9818\u57df\u306b\u3059\u308b\u3002\n\ncinder\u3067\u30dc\u30ea\u30e5\u30fc\u30e0\u30922\u672c\u4f5c\u6210\u3059\u308b\u3002\n\n<pre>\n(venv)[ansible@step-server ~]$ cinder create --display-name dbs_vdc --availability-zone az1 10\n+---------------------+--------------------------------------+\n|       Property      |                Value                 |\n+---------------------+--------------------------------------+\n|     attachments     |                  []                  |\n|  availability_zone  |                 az1                  |\n|       bootable      |                false                 |\n|      created_at     |      2015-03-30T11:43:00.654349      |\n| display_description |                 None                 |\n|     display_name    |               dbs_vdc                |\n|      encrypted      |                False                 |\n|          id         | 5293f5c7-d386-4b36-9092-252f724eeafd |\n|       metadata      |                  {}                  |\n|         size        |                  10                  |\n|     snapshot_id     |                 None                 |\n|     source_volid    |                 None                 |\n|        status       |               creating               |\n|     volume_type     |                 None                 |\n+---------------------+--------------------------------------+\n\n(venv)[ansible@step-server ~]$ cinder create --display-name dbs_vdd --availability-zone az1 10\n+---------------------+--------------------------------------+\n|       Property      |                Value                 |\n+---------------------+--------------------------------------+\n|     attachments     |                  []                  |\n|  availability_zone  |                 az1                  |\n|       bootable      |                false                 |\n|      created_at     |      2015-03-30T11:43:13.524431      |\n| display_description |                 None                 |\n|     display_name    |               dbs_vdd                |\n|      encrypted      |                False                 |\n|          id         | e7f73a03-e9a3-4f27-9a33-a40c869d13cb |\n|       metadata      |                  {}                  |\n|         size        |                  10                  |\n|     snapshot_id     |                 None                 |\n|     source_volid    |                 None                 |\n|        status       |               creating               |\n|     volume_type     |                 None                 |\n+---------------------+--------------------------------------+\n</pre>\n\ndbs\u306b\u63a5\u7d9a\u3059\u308b\u3002\n\n<pre>\n(venv)[ansible@step-server ~]$ function get_uuid () { cat - | grep \" id \" | awk '{print $4}'; }\n\n(venv)[ansible@step-server ~]$ export MY_DBS_VDC=`cinder show dbs_vdc |get_uuid`\n\n(venv)[ansible@step-server ~]$ export MY_DBS_VDD=`cinder show dbs_vdd |get_uuid`\n\n(venv)[ansible@step-server ~]$ nova volume-attach dbs-e945fd19-f2ba-40a2-8470-ad1c6092eacf $MY_DBS_VDC\n+----------+--------------------------------------+\n| Property | Value                                |\n+----------+--------------------------------------+\n| device   | /dev/vdc                             |\n| id       | 5293f5c7-d386-4b36-9092-252f724eeafd |\n| serverId | e4908bd6-c862-4993-964c-44c7bf6c4ddf |\n| volumeId | 5293f5c7-d386-4b36-9092-252f724eeafd |\n+----------+--------------------------------------+\n\n(venv)[ansible@step-server ~]$ nova volume-attach dbs-e945fd19-f2ba-40a2-8470-ad1c6092eacf $MY_DBS_VDD\n+----------+--------------------------------------+\n| Property | Value                                |\n+----------+--------------------------------------+\n| device   | /dev/vdd                             |\n| id       | e7f73a03-e9a3-4f27-9a33-a40c869d13cb |\n| serverId | e4908bd6-c862-4993-964c-44c7bf6c4ddf |\n| volumeId | e7f73a03-e9a3-4f27-9a33-a40c869d13cb |\n+----------+--------------------------------------+\n</pre>\n\n\u63a5\u7d9a\u3055\u308c\u305f\u3002\n\n```\n[root@dbs-e945fd19-f2ba-40a2-8470-ad1c6092eacf /]# lsblk\nNAME   MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT\nsr0     11:0    1  410K  0 rom\nvda    252:0    0   10G  0 disk\n\u2514\u2500vda1 252:1    0   10G  0 part /\nvdb    252:16   0   10G  0 disk /mnt\nvdc    252:32   0   10G  0 disk\nvdd    252:48   0   10G  0 disk\n```\n\n\u300c/dev/mysql_vg/mysql_vol01\u300d\u306eLVM\u30b9\u30ca\u30c3\u30d7\u30b7\u30e7\u30c3\u30c8\u3092\u4f5c\u308b\u3053\u3068\u306b\u306a\u3063\u3066\u3044\u308b\u3002\n\n/dev/vdc\u306e\u30bf\u30a4\u30d7\u3092 8e (Linux LVM)\u306b\u3059\u308b\u3002\n\n```\n[root@dbs-e945fd19-f2ba-40a2-8470-ad1c6092eacf /]# fdisk /dev/vdc\nDevice contains neither a valid DOS partition table, nor Sun, SGI or OSF disklabel\nBuilding a new DOS disklabel with disk identifier 0xed33b73b.\nChanges will remain in memory only, until you decide to write them.\nAfter that, of course, the previous content won't be recoverable.\n\nWarning: invalid flag 0x0000 of partition table 4 will be corrected by w(rite)\n\nWARNING: DOS-compatible mode is deprecated. It's strongly recommended to\n         switch off the mode (command 'c') and change display units to\n         sectors (command 'u').\n\nCommand (m for help): n\nCommand action\n   e   extended\n   p   primary partition (1-4)\np\nPartition number (1-4): 1\nFirst cylinder (1-20805, default 1):\nUsing default value 1\nLast cylinder, +cylinders or +size{K,M,G} (1-20805, default 20805):\nUsing default value 20805\n\nCommand (m for help): t\nSelected partition 1\nHex code (type L to list codes): 8e\nChanged system type of partition 1 to 8e (Linux LVM)\n\nCommand (m for help): p\n\nDisk /dev/vdc: 10.7 GB, 10737418240 bytes\n16 heads, 63 sectors/track, 20805 cylinders\nUnits = cylinders of 1008 * 512 = 516096 bytes\nSector size (logical/physical): 512 bytes / 512 bytes\nI/O size (minimum/optimal): 512 bytes / 512 bytes\nDisk identifier: 0xed33b73b\n\n   Device Boot      Start         End      Blocks   Id  System\n/dev/vdc1               1       20805    10485688+  8e  Linux LVM\n\nCommand (m for help): w\nThe partition table has been altered!\n\nCalling ioctl() to re-read partition table.\nSyncing disks.\n```\n/dev/vdc1\u306bpv\u3092\u4f5c\u308a\u3001vg\u300cmysql_vg\u300d\u3001lv\u300cmysql_vol01\u300d\u3092\u4f5c\u308b\u3002\n\n```\n[root@dbs-e945fd19-f2ba-40a2-8470-ad1c6092eacf /]# pvcreate /dev/vdc1\n  Physical volume \"/dev/vdc1\" successfully created\n\n[root@dbs-e945fd19-f2ba-40a2-8470-ad1c6092eacf /]# vgcreate mysql_vg /dev/vdc1\n  Volume group \"mysql_vg\" successfully created\n\n[root@dbs-e945fd19-f2ba-40a2-8470-ad1c6092eacf /]# lvcreate -L 5G -n mysql_vol01 mysql_vg\n  Logical volume \"mysql_vol01\" created\n```\n\n/dev/mysql_vg/mysql_vol01 \u304c\u4f5c\u6210\u3055\u308c\u305f\u3002\n\n```\n[root@dbs-e945fd19-f2ba-40a2-8470-ad1c6092eacf /]# lsblk\nNAME                            MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT\nsr0                              11:0    1  410K  0 rom\nvda                             252:0    0   10G  0 disk\n\u2514\u2500vda1                          252:1    0   10G  0 part /\nvdb                             252:16   0   10G  0 disk /mnt\nvdc                             252:32   0   10G  0 disk\n\u2514\u2500vdc1                          252:33   0   10G  0 part\n  \u2514\u2500mysql_vg-mysql_vol01 (dm-0) 253:0    0    5G  0 lvm\nvdd                             252:48   0   10G  0 disk\n\n[root@dbs-e945fd19-f2ba-40a2-8470-ad1c6092eacf /]# ls /dev/mysql_vg/mysql_vol01\n/dev/mysql_vg/mysql_vol01\n```\next4\u306efs\u3092\u4f5c\u308a\u3001MySQL\u30c7\u30fc\u30bf\u3092\u79fb\u884c\u3057/var/lib/mysql\u306b\u30de\u30a6\u30f3\u30c8\u3059\u308b\u3002\n\n```\n[root@dbs-e945fd19-f2ba-40a2-8470-ad1c6092eacf /]# mkfs.ext4 -L mysql_data /dev/mysql_vg/mysql_vol01\n\n[root@dbs-e945fd19-f2ba-40a2-8470-ad1c6092eacf /]# tune2fs -c 0 -i 0 -r 0 /dev/mysql_vg/mysql_vol01\n\n[root@dbs-e945fd19-f2ba-40a2-8470-ad1c6092eacf /]# mkdir /tmp/data\n\n[root@dbs-e945fd19-f2ba-40a2-8470-ad1c6092eacf /]# mount LABEL=mysql_data /tmp/data\n\n[root@dbs-e945fd19-f2ba-40a2-8470-ad1c6092eacf /]# chown -R mysql:mysql /tmp/data\n\n[root@dbs-e945fd19-f2ba-40a2-8470-ad1c6092eacf /]# service mysqld stop\n\n[root@dbs-e945fd19-f2ba-40a2-8470-ad1c6092eacf /]# mv /var/lib/mysql/* /tmp/data/\n\n\n[root@dbs-e945fd19-f2ba-40a2-8470-ad1c6092eacf /]# umount /tmp/data/\n\n[root@dbs-e945fd19-f2ba-40a2-8470-ad1c6092eacf /]# mount LABEL=mysql_data /var/lib/mysql\n\n[root@dbs-e945fd19-f2ba-40a2-8470-ad1c6092eacf /]# service mysqld start\n```\n\nvdd\u306f\u300183 (Linux)\u306b\u3057\u3066ext4\u306efs\u3092\u4f5c\u6210\u3057\u3066\u304a\u304f\u3002\n\n```\n[root@dbs-e945fd19-f2ba-40a2-8470-ad1c6092eacf /]# fdisk /dev/vdd\n\n[root@dbs-e945fd19-f2ba-40a2-8470-ad1c6092eacf /]# mkfs.ext4 -L mysql_backup /dev/vdd1\n\n[root@dbs-e945fd19-f2ba-40a2-8470-ad1c6092eacf /]# tune2fs -c 0 -i 0 -r 0 /dev/vdd1\n```\n\n\u3053\u308c\u3067ansible\u3067\u306e\u81ea\u52d5\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u306b\u6210\u529f\u3057\u305f\u3002\n\n```\n(venv)[ansible@step-server ~]$ ansible-playbook -i sample_app_inventory.py -t snapshot,backup -u root db_backup.yml\n\nPLAY [dbs] ********************************************************************\n\nGATHERING FACTS ***************************************************************\nok: [192.168.0.27]\n\nTASK: [stop mysqld] ***********************************************************\nchanged: [192.168.0.27]\n\nTASK: [umount mysql_dir] ******************************************************\nchanged: [192.168.0.27]\n\nTASK: [create snapshot on lvm] ************************************************\nchanged: [192.168.0.27]\n\nTASK: [mount mysql_dir] *******************************************************\nchanged: [192.168.0.27]\n\nTASK: [start mysqld] **********************************************************\nchanged: [192.168.0.27]\n\nPLAY [app] ********************************************************************\n\nGATHERING FACTS ***************************************************************\nok: [192.168.0.26]\n\nTASK: [restart rest app] ******************************************************\nchanged: [192.168.0.26]\n\nPLAY [dbs] ********************************************************************\n\nGATHERING FACTS ***************************************************************\nok: [192.168.0.27]\n\nTASK: [make directory] ********************************************************\nchanged: [192.168.0.27]\n\nTASK: [mount backup] **********************************************************\nchanged: [192.168.0.27]\n\nTASK: [mount snapshot] ********************************************************\nchanged: [192.168.0.27]\n\nTASK: [archive database files to \"{{ backup_mountpoint }}\"] *******************\nchanged: [192.168.0.27]\n\nTASK: [umount snapshot] *******************************************************\nchanged: [192.168.0.27]\n\nTASK: [umount backup] *********************************************************\nchanged: [192.168.0.27]\n\nTASK: [remove snapshot] *******************************************************\nchanged: [192.168.0.27]\n\nPLAY RECAP ********************************************************************\n192.168.0.26               : ok=2    changed=1    unreachable=0    failed=0\n192.168.0.27               : ok=14   changed=12   unreachable=0    failed=0\n```\n\n***\n\u7b2c11\u7ae0\u306e\u5b8c\u4e86\u3002\u306a\u3093\u3068\u304b\u306a\u3063\u305f\u3002\n***\n[\u524d\u56de\u306f\u3053\u3061\u3089](http://qiita.com/orz/items/957f15eabaedf312b1a4) - [\u6b21\u56de\u306f\u3053\u3061\u3089](http://qiita.com/orz/items/b303c0145f3b9be486bd)\n"}