{"context": "\n\n\u307e\u3048\u304c\u304d\n\u3053\u306e\u524d\u3001BitVisor Summit 5\u3078\u904a\u3073\u306b\u884c\u3063\u305f\u3089\u30a2\u30c9\u30d9\u30f3\u30c8\u30ab\u30ec\u30f3\u30c0\u30fc\u306e\u52df\u96c6\u3092\u3084\u3063\u3066\u305f\u306e\u3067\u4e57\u3063\u304b\u308b\u3053\u3068\u306b\u3057\u305f\u3002\n\u809d\u5fc3\u306e\u30a2\u30c9\u30d9\u30f3\u30c8\u30ab\u30ec\u30f3\u30c0\u30fc\u306f\u3001\u3059\u3052\u3047\u4eba\u304c\u66f8\u304d\u307e\u304f\u3063\u3066\u3066\u4e2d\u3005\u306e\u30cf\u30fc\u30c9\u30eb\u306e\u9ad8\u3055\u3002\n\u521d\u53c2\u6226\u30fb\u521d\u5fc3\u8005\u304c\u66f8\u3044\u305f\u8a18\u4e8b\u306a\u306e\u3067\u3001\u304a\u624b\u67d4\u3089\u304b\u306b\u304a\u9858\u3044\u3057\u307e\u3059\u306d\uff01\n\u3067\u3001\u30b5\u30af\u30c3\u3068\u7c21\u5358\u306a\u3068\u3053\u308d\u3067\u30ec\u30ac\u30b7\u30fc\u306a\u30c7\u30d0\u30a4\u30b9\u3068lwIP\u3067\u904a\u3093\u3067\u307f\u305f\u3068\u3044\u3046\u5185\u5bb9\u3067\u66f8\u304f\u3053\u3068\u306b\u3059\u308b\u3002\n\n\u3053\u308c\u306f\u4f55?\n\u30b2\u30b9\u30c8OS\u304c\u30b7\u30ea\u30a2\u30eb\u30dd\u30fc\u30c8\u306b\u66f8\u3044\u305f\u30c7\u30fc\u30bf\u3092BitVisor\u306eTCP/IP\u3067\u6d41\u3059\u3068\u3044\u3046\u3082\u306e\u3002\nI/O mapped I/O\u3092\u4f7f\u3063\u305f\u30aa\u30f3\u30dc\u30fc\u30c9\u306e\u30b7\u30ea\u30a2\u30eb\u30dd\u30fc\u30c8\uff088250 UART\uff09\u306e\u30a2\u30af\u30bb\u30b9\u3092\u6a2a\u53d6\u308a\u3057\u3066\u4f5c\u3063\u3066\u307f\u305f\u3002\nTCP/IP\u306f\u3001\u6700\u8fd1\u6a5f\u80fd\u8ffd\u52a0\u3055\u308c\u305flwIP\u3092\u4f7f\u3063\u3066\u5b9f\u88c5\u3002\u901a\u4fe1\u306f\u3001BitVisor\u5074\u304c\u30b5\u30fc\u30d0\u306b\u306a\u308b\u3088\u3046\u306b\u3057\u3066\u3001\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u3068\u306e\u63a5\u7d9a\u3092\u78ba\u7acb\u3059\u308b\u3002\u78ba\u7acb\u3055\u308c\u305f\u5f8c\u306b\u30b7\u30ea\u30a2\u30eb\u30dd\u30fc\u30c8\u3078\u66f8\u304d\u8fbc\u307e\u308c\u305f\u30c7\u30fc\u30bf\u3092\u305d\u306e\u307e\u307e\u8ee2\u9001\u3059\u308b\u3068\u3044\u3046\u4ed5\u7d44\u307f\u3002\n\u306a\u304a\u3001\u30b7\u30ea\u30a2\u30eb\u30dd\u30fc\u30c8\u306e\u30a8\u30df\u30e5\u30ec\u30fc\u30b7\u30e7\u30f3\u6a5f\u80fd\u306f\u7121\u3044\u306e\u3067\u3001BitVisor\u3092\u52d5\u4f5c\u3055\u305b\u308bPC\u306b\u30b7\u30ea\u30a2\u30eb\u30dd\u30fc\u30c8\uff08COM1\uff09\u304c\u5b9f\u88c5\u3055\u308c\u3066\u3044\u306a\u3051\u308c\u3070\u4f7f\u7528\u3067\u304d\u306a\u3044\u306e\u3067\u6ce8\u610f\u3002\n\u3053\u306e\u70b9\u306fBitVisor\u3063\u307d\u3044\u6c17\u304c\u3059\u308b\u3001\u6a2a\u53d6\u308a\u3057\u3066\u5f8c\u306f\u5b9f\u30cf\u30fc\u30c9\u4efb\u305b\u3068\u3044\u3046\u611f\u3058\u304c\u3002\n\n\u66f8\u3044\u305f\u30d7\u30ed\u30b0\u30e9\u30e0\u306e\u8aac\u660e\n\u5168\u4f53\u306e\u6d41\u308c\u3068\u3057\u3066\u306f\u3001IO\u30d5\u30c3\u30af\u3057\u3066\u6349\u3048\u305f\u30c7\u30fc\u30bf\u3092TCP\u306b\u6d41\u3059\u3002\u305f\u3060\u305d\u308c\u3060\u3051\u3002\n\nIO\u306e\u30d5\u30c3\u30af\nBitVisor\u306b\u306f\u5143\u3005 core/serial.c \u306e serial_init_iohook \u306b\u30c7\u30d0\u30c3\u30b0\u30ed\u30b0\u3092\u30b7\u30ea\u30a2\u30eb\u30dd\u30fc\u30c8\u306b\u51fa\u529b\u3059\u308b\u305f\u3081\u306e\u30b3\u30fc\u30c9\u304c\u66f8\u3044\u3066\u3042\u308b\u3002\u305d\u306e\u4e2d\u306b TTY_SERIAL \u304c\u6709\u52b9\u306b\u306a\u3063\u3066\u3044\u308b\u6642\u306b\u3001OS\u304b\u3089\u306e\u30b7\u30ea\u30a2\u30eb\u30dd\u30fc\u30c8\u30a2\u30af\u30bb\u30b9\u3092\u6368\u3066\u308b\u3088\u3046\u306a\u51e6\u7406\u304c\u3042\u308b\u3002\u3053\u308c\u3092\u53c2\u8003\u306b\u3057\u3066\u6b21\u306b\u793a\u3059\u3088\u3046\u306b\u6539\u9020\u3059\u308b\u3002\ndiff -r 76db0ae4260b core/serial.c\n--- a/core/serial.c Mon Sep 12 20:01:54 2016 +0900\n+++ b/core/serial.c Sun Dec 11 18:25:20 2016 +0900\n@@ -165,13 +165,27 @@\n    serial_send (PORT, c);\n }\n\n+void hook_uart_putchar (int);\n+static enum ioact\n+hook_uart (enum iotype type, u32 port, void *data) // THR or RBR or DLL\n+{\n+   switch (type) {\n+   case IOTYPE_OUTB:\n+       if (!(port & 0x07))\n+           hook_uart_putchar (*(u8 *)data);\n+       break;\n+   default:\n+       break;\n+   }\n+   return do_iopass_default (type, port, data);\n+}\n+\n void\n serial_init_iohook (void)\n {\n    unsigned int i;\n\n    for (i = PORT; i < PORT + NUM_OF_PORT; i++)\n-       set_iofunc (i, do_io_nothing);\n+       set_iofunc (i, hook_uart);\n }\ndiff -r 76db0ae4260b core/io_iopass.c\n--- a/core/io_iopass.c  Mon Sep 12 20:01:54 2016 +0900\n+++ b/core/io_iopass.c  Sun Dec 11 18:25:20 2016 +0900\n@@ -38,6 +38,7 @@\n #include \"printf.h\"\n #include \"tty.h\"\n #include \"types.h\"\n+#include \"serial.h\"\n\n enum ioact\n do_iopass_default (enum iotype type, u32 port, void *data)\n@@ -76,8 +77,12 @@\n        return;\n    for (i = 0; i < NUM_OF_IOPORT; i++)\n        set_iofunc (i, do_iopass_default);\n+#ifndef TTY_SERIAL\n+   serial_init_iohook ();\n+#else\n    tty_init_iohook ();\n    debug_iohook ();\n+#endif\n    acpi_iohook ();\n }\n\n\u5143\u306f\u3001do_io_nothing\u3092\u767b\u9332\u3057\u3066\u3001\u30b2\u30b9\u30c8OS\u304cIO\u3092\u767a\u884c\u3057\u305f\u6642\u306b\u4f55\u3082\u3057\u306a\u3044\u3068\u3044\u3046\u52d5\u4f5c\u3092\u3059\u308b\u3002\u3053\u306e\u90e8\u5206\u3092\u5fc5\u8981\u306a\u90e8\u5206\u3060\u3051\u30d5\u30c3\u30af\u3001\u3042\u3068\u306f\u30d1\u30b9\u30b9\u30eb\u30fc\u3068\u3044\u3046\u52d5\u4f5c\u306b\u66f8\u304d\u63db\u3048\u305f\u3002hook_uart\u95a2\u6570\u304c\u305d\u308c\u3002\nhook_uart\u95a2\u6570\u306f\u3001\u30d9\u30fc\u30b9\u306eIO\u30dd\u30fc\u30c8+0 (0x3F8) \u3078\u306e\u66f8\u304d\u8fbc\u307f\u306e\u307f\u3092\u30d5\u30c3\u30af\u3057\u3066\u305d\u308c\u4ee5\u5916\u306f\u30d1\u30b9\u30b9\u30eb\u30fc\u3059\u308b\u3088\u3046\u306b\u4ed5\u5411\u3051\u308b\u3002\u30d1\u30b9\u30b9\u30eb\u30fc\u51e6\u7406\u306f\u81ea\u529b\u3067\u66f8\u3044\u3066\u3082\u826f\u3044\u304c\u3001do_iopass_default\u304c\u3042\u308b\u306e\u3067\u6d41\u7528\u3059\u308b\uff08\u3053\u306e\u8fba\u308a\u306e\u66f8\u304d\u65b9\u306f\u306a\u3093\u3068\u306a\u304fWINAPI\u306eWndProc\u3063\u307d\u3044\uff09\u3002\n0x3F8\u3078\u306e\u66f8\u8fbc\u307f\u306f\u30b7\u30ea\u30a2\u30eb\u30dd\u30fc\u30c8\u3078\u51fa\u529b\u3068\u306a\u3063\u3066\u3044\u308b\u306e\u3067\u3001\u3053\u308c\u3092\u6349\u3048\u308c\u3070\u66f8\u304d\u8fbc\u307e\u308c\u308b\u30c7\u30fc\u30bf\u304c\u308f\u304b\u308b\uff08\u5b9f\u969b\u306f\u3061\u3087\u3063\u3068\u9055\u3046\u304c\u9762\u5012\u306a\u306e\u3067\u3053\u308c\u3067\u3084\u308b\uff09\u3002\n\u66f8\u304d\u8fbc\u307e\u308c\u305f\u30c7\u30fc\u30bf\u306f\u3001\u6b21\u3067\u8aac\u660e\u3059\u308bTCP/IP\u306e\u30b5\u30fc\u30d0\u30d7\u30ed\u30b0\u30e9\u30e0\u306b\u6295\u3052\u308b\u3088\u3046\u306b\u3057\u3066\u304a\u304f\u3002\nserial_init_iohook\u3092\u66f8\u304d\u63db\u3048\u305f\u3060\u3051\u3067\u306f\u3001TTY_SERIAL\u304c\u5ba3\u8a00\u3055\u308c\u3066\u3044\u306a\u3044\u6642\u306b\u3001\u3053\u306e\u51e6\u7406\u3092\u901a\u306a\u3089\u304f\u306a\u308b\u306e\u3067\u3001iopass.c\u306b\u547c\u3073\u51fa\u3059\u30b3\u30fc\u30c9\u3092\u66f8\u304d\u52a0\u3048\u3066\u3044\u308b\u3002\n\u6ce8\u610f\u70b9\u306f\u3001\u30b7\u30ea\u30a2\u30eb\u30c7\u30d0\u30c3\u30b0\u6642\u306bBitVisor\u3068\u30b2\u30b9\u30c8OS\u306e\u30c7\u30fc\u30bf\u304c\u6df7\u308b\u3068\u3044\u3046\u554f\u984c\u304c\u767a\u751f\u3059\u308b\uff08\u305f\u3076\u3093\uff09\u3002\n\u4eca\u56de\u306f\u904a\u3093\u3067\u307f\u305f\u3060\u3051\u306a\u306e\u3067\u3001\u3053\u306e\u554f\u984c\u306f\u3042\u307e\u308a\u6c17\u306b\u3057\u306a\u3044\u3053\u3068\u306b\u3057\u3066\u304a\u304f\uff08\u521d\u671f\u5316\u51e6\u7406\u3092\u66f8\u304d\u63db\u3048\u305a\u306b\u5c02\u7528\u306e\u521d\u671f\u5316\u95a2\u6570\u306b\u4f5c\u3063\u3066\u304a\u3051\u3070\u826f\u304b\u3063\u305f\u6c17\u304c\u3059\u308b\u304c\u3001\u3084\u3063\u3066\u3057\u307e\u3063\u305f\u3082\u306e\u306f\u4ed5\u65b9\u306a\u3044\uff09\u3002\n\u3053\u3053\u307e\u3067\u3067\u30d5\u30c3\u30af\u51e6\u7406\u306f\u3067\u304d\u305f\u3002\u3042\u3068\u306fTCP\u3067\u9001\u308b\u3060\u3051\u3002\n\nTCP/IP\nlwIP\u3068\u3044\u3046\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u30b9\u30bf\u30c3\u30af\u304c\u5b9f\u88c5\u3055\u308c\u3066\u3044\u308b\u304c\u3001Linux\u3067\u3088\u304f\u3042\u308b\u30bd\u30b1\u30c3\u30c8\u30d7\u30ed\u30b0\u30e9\u30df\u30f3\u30b0\u3068\u5c11\u3057\u3060\u3051\u9055\u3046\u3002\nlwIP\u306f\u3001\u7d44\u8fbc\u30b7\u30b9\u30c6\u30e0\u5411\u3051\u306b\u4f5c\u3089\u308c\u3066\u3044\u308b\u3002\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u3092\u4f7f\u3063\u305f\u975e\u540c\u671f\u52d5\u4f5c\u3068\u601d\u3063\u3066\u304a\u3051\u3070\u554f\u984c\u7121\u3044\u3068\u601d\u3046\u3002\n\u5b9f\u969b\u306b\u4f5c\u308b\u6642\u306f\u3001ip\u30c7\u30a3\u30ec\u30c8\u30ea\u306e\u4e0b\u306b echo-server.c \u3068\u304b\u8272\u3005\u30b5\u30f3\u30d7\u30eb\u304c\u8ee2\u304c\u3063\u3066\u3044\u308b\u306e\u3067\u305d\u308c\u3092\u53c2\u8003\u306b\u4f5c\u308c\u3070\u3088\u3055\u3052\u3002\nBitVisor\u3067\u306e\u4f5c\u308a\u65b9\u306e\u6ce8\u610f\u3068\u3057\u3066\u306f\u3001core\u3068\u304b\u306b\u7f6e\u3044\u3066\u3057\u307e\u3046\u3068\u30d8\u30c3\u30c0\u30fc\u306e\u30d1\u30b9\u304c\u304b\u306a\u308a\u9055\u3046\u306e\u3067\u3001\u30b3\u30f3\u30d1\u30a4\u30eb\u304c\u3046\u307e\u304f\u3044\u304b\u306a\u3044\uff08\u3068\u3044\u3046\u304bMakefile\u306e\u66f8\u63db\u304c\u9762\u5012\uff09\u3002TCP/IP\u306e\u30d7\u30ed\u30b0\u30e9\u30e0\u3092\u66f8\u304f\u3068\u304d\u306f\u3001ip\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u914d\u4e0b\u306b\u4f5c\u308b\u65b9\u304c\u30c8\u30e9\u30d6\u30eb\u304c\u5c11\u306a\u3044\u3002\n\u3067\u3001\u66f8\u3044\u305f\u306e\u304c\u4ee5\u4e0b\u3002\ndiff -r 76db0ae4260b ip/Makefile\n--- a/ip/Makefile   Mon Sep 12 20:01:54 2016 +0900\n+++ b/ip/Makefile   Sun Dec 11 18:25:20 2016 +0900\n@@ -41,3 +41,4 @@\n objs-1 += ip_sys.o arch/sys_arch.o\n objs-1 += ip_main.o net_main.o\n objs-1 += echo-server.o echo-client.o echoctl.o\n+objs-1 += serial-tcp.o\ndiff -r 76db0ae4260b ip/ip_main.c\n--- a/ip/ip_main.c  Mon Sep 12 20:01:54 2016 +0900\n+++ b/ip/ip_main.c  Sun Dec 11 18:25:20 2016 +0900\n@@ -266,6 +266,8 @@\n\n    /* Configure and add network interface. */\n    tcpip_netif_conf (netif_arg, netif_num);\n+\n+   init_uart_tcp ();\n }\n\n void\ndiff -r 76db0ae4260b ip/serial-tcp.c\n--- /dev/null   Thu Jan 01 00:00:00 1970 +0000\n+++ b/ip/serial-tcp.c   Sun Dec 11 18:25:20 2016 +0900\n@@ -0,0 +1,95 @@\n+#include <core/spinlock.h>\n+#include <core/list.h>\n+#include \"lwip/tcp.h\"\n+\n+struct tcp_sock {\n+   LIST1_DEFINE (struct tcp_sock);\n+   struct tcp_pcb *pcb;\n+};\n+static LIST1_DEFINE_HEAD (struct tcp_sock, tcp_sock_list);\n+static spinlock_t tcp_sock_lock;\n+\n+static err_t uart_tcp_recv (void *arg, struct tcp_pcb *pcb, struct pbuf *pbuf, err_t err)\n+{\n+   struct tcp_sock *p = (struct tcp_sock *)arg;\n+   if (!pbuf) {\n+       tcp_close (pcb);\n+       printf (\"Disconnected\\n\");\n+\n+       spinlock_lock (&tcp_sock_lock);\n+       LIST1_DEL (tcp_sock_list, p);\n+       spinlock_unlock (&tcp_sock_lock);\n+       mem_free (p);\n+   }\n+\n+   return err;\n+}\n+\n+static err_t uart_tcp_accept (void *arg, struct tcp_pcb *newpcb, err_t err)\n+{\n+   struct tcp_sock *p;\n+\n+   LWIP_UNUSED_ARG(arg);\n+   LWIP_UNUSED_ARG(err);\n+\n+   spinlock_lock (&tcp_sock_lock);\n+   p = (struct tcp_sock *)mem_malloc (sizeof (struct tcp_sock));\n+   if (!p)\n+       panic (\"mem_malloc\");\n+   p->pcb = newpcb;\n+   LIST1_ADD (tcp_sock_list, p);\n+   spinlock_unlock (&tcp_sock_lock);\n+\n+   tcp_arg (newpcb, p);\n+   tcp_recv (newpcb, uart_tcp_recv);\n+\n+   printf (\"Connected!\\n\");\n+\n+   return ERR_OK;\n+}\n+\n+static bool initialized;\n+\n+void hook_uart_putchar (int ch)\n+{\n+   char str[1] = { ch };\n+   struct tcp_sock *p;\n+\n+   //printf (\"uart: putchar %02x\\n\", ch);\n+\n+   if (!initialized)\n+       return;\n+\n+   spinlock_lock (&tcp_sock_lock);\n+   LIST1_FOREACH (tcp_sock_list, p) {\n+       tcp_write (p->pcb, str, 1, 1);\n+   }\n+   spinlock_unlock (&tcp_sock_lock);\n+}\n+\n+void init_uart_tcp (void)\n+{\n+   struct tcp_pcb *pcb;\n+\n+   if (initialized)\n+       panic (\"already initialized!\");\n+\n+   spinlock_init (&tcp_sock_lock);\n+   LIST1_HEAD_INIT (tcp_sock_list);\n+\n+   pcb = tcp_new ();\n+   if (pcb) {\n+       err_t err;\n+       err = tcp_bind (pcb, IP_ADDR_ANY, 1234);\n+       if (err == ERR_OK) {\n+           pcb = tcp_listen (pcb);\n+           tcp_accept (pcb, uart_tcp_accept);\n+       } else {\n+           panic (\"tcp_bind\");\n+       }\n+   } else {\n+       panic (\"tcp_new\");\n+   }\n+\n+   initialized = true;\n+}\n\ninit_uart_tcp\u304c\u30b5\u30fc\u30d0\u306e\u521d\u671f\u5316\u51e6\u7406\u3002\u30bd\u30b1\u30c3\u30c8\u30d7\u30ed\u30b0\u30e9\u30df\u30f3\u30b0\u3067\u8a00\u3046\u3068\u3053\u308d\u306esocket -> bind -> listen -> accept\u306e\u9806\u3067\u521d\u671f\u5316\u3059\u308b\u51e6\u7406\u3092\u66f8\u3044\u3066\u3044\u308b\u3002\u9055\u3046\u3068\u3053\u308d\u3092\u6307\u6458\u3059\u308b\u306a\u3089\u3001accept\u304c\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u306b\u306a\u3063\u3066\u3044\u308b\u3068\u3053\u308d\u3002\u3053\u308c\u3067\u975e\u540c\u671f\u52d5\u4f5c\u306b\u306a\u308a\u3001init_uart_tcp\u306f\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u306e\u63a5\u7d9a\u3092\u5f85\u305f\u305a\u306b\u7d42\u4e86\u3059\u308b\u3002\n\u521d\u671f\u5316\u5b8c\u4e86\u5f8c\u306f\u30011234/tcp\u3067\u5f85\u6a5f\u3059\u308b\u306e\u3067telnet\u306a\u308anc\u306a\u308a\u3067\u63a5\u7d9a\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u308b\u3002\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u63a5\u7d9a\u6642\u306f\u3001uart_tcp_accept\u304c\u547c\u3073\u51fa\u3055\u308c\u3066\u3001\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u7528\u306e\u30bd\u30b1\u30c3\u30c8\u304c\u4f5c\u6210\u3055\u308c\u308b\u3002\u4f5c\u6210\u3055\u308c\u305f\u30bd\u30b1\u30c3\u30c8\u306f\u3001\u30ea\u30b9\u30c8\u306b\u8ffd\u52a0\u3057\u3066\u30b7\u30ea\u30a2\u30eb\u30dd\u30fc\u30c8\u51fa\u529b\u6642\uff08hook_uart_putchar\u304b\u3089\u547c\u51fa\u3057\uff09\u306b\u66f8\u304d\u8fbc\u307e\u308c\u308b\u3088\u3046\u306b\u3057\u3066\u304a\u304f\u3002\n\u53d7\u4fe1\u7528\u306e\u52d5\u4f5c\u3092uart_tcp_recv\u3067\u5b9a\u7fa9\u3057\u3066\u3044\u308b\u304c\u3001\u4eca\u56de\u306f\u53d7\u4fe1\u6a5f\u80fd\u3067\u306f\u306a\u304f\u7d42\u4e86\u30bf\u30a4\u30df\u30f3\u30b0\u3092\u53d6\u308b\u305f\u3081\u306b\u4f7f\u7528\u3057\u3066\u3044\u308b\u3002\ntcp_recv\u95a2\u6570\u3067\u767b\u9332\u3055\u308c\u305f\u95a2\u6570\u306f\u3001\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u304b\u3089\u30c7\u30fc\u30bf\u3092\u53d7\u4fe1\u3057\u305f\u6642\u4ee5\u5916\u306b\u3001\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u304b\u3089\u30bb\u30c3\u30b7\u30e7\u30f3\u30af\u30ed\u30fc\u30ba\u3057\u305f\u6642\u306b\u3082\u547c\u3073\u51fa\u3055\u308c\u308b\u3002\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u304b\u3089FIN\u304c\u9001\u4fe1\u3055\u308c\u3066\u304f\u308b\u3068pbuf==NULL\u3067\u547c\u3073\u51fa\u3055\u308c\u308b\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u308b\u306e\u3067\u3001\u305d\u308c\u3092\u6761\u4ef6\u3068\u3057\u3066\u30af\u30ea\u30fc\u30f3\u30ca\u30c3\u30d7\u3059\u308b\u3002\nhook_uart_putchar\u306f\u3001\u30ea\u30b9\u30c8\u3092\u8fbf\u308a\u5168\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u306btcp_write\u95a2\u6570\u3067\u30c7\u30fc\u30bf\u30921\u30d0\u30a4\u30c8\u305a\u3064\u9001\u308a\u4ed8\u3051\u3066\u3044\u308b\u3002\u30d7\u30ed\u30b0\u30e9\u30e0\u4e0a\u306f1\u30d0\u30a4\u30c8\u305a\u3064\u9001\u4fe1\u3059\u308b\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u308b\u304c\u3001\u5b9f\u969b\u306flwIP\u3067\u30d0\u30c3\u30d5\u30a1\u30ea\u30f3\u30b0\u3055\u308c15-20\u30d0\u30a4\u30c8\u304f\u3089\u3044\u3067\u9001\u3089\u308c\u3066\u3044\u305f\u3002\ninitialized\u5909\u6570\u306f\u3001\u521d\u671f\u5316\u3092\u7ba1\u7406\u3059\u308b\u30d5\u30e9\u30b0\u3060\u304c\u3001\u6050\u3089\u304f\u7121\u304f\u3066\u3082\u52d5\u304f\u3002\u4f5c\u308a\u59cb\u3081\u306f\u521d\u671f\u5316\u51e6\u7406\u3092serial_init_iohook\u306b\u66f8\u3044\u3066\u3044\u305f\u304c\u3001\u3053\u308c\u3067\u306flwIP\u304c\u521d\u671f\u5316\u3055\u308c\u308b\u524d\u306binit_uart_tcp\u304c\u547c\u3073\u51fa\u3055\u308c\u3066\u3057\u307e\u3046\u306e\u3067\u3001panic(\"tcp_new\");\u3067\u6b7b\u306c\u3068\u8a00\u3046\u554f\u984c\u304c\u767a\u751f\u3057\u3066\u3044\u305f\u3002\u4ed5\u65b9\u306a\u3044\u306e\u3067lwIP_init\u306e\u5f8c\u306b\u521d\u671f\u5316\u51e6\u7406\u3092\u57cb\u3081\u8fbc\u307f\u3001\u4f55\u3068\u304b\u52d5\u304f\u3088\u3046\u306b\u3057\u305f\u3002\u305d\u306e\u904e\u7a0b\u306e\u3069\u3053\u304b\u3067initialized\u5909\u6570\u3092\u4ed8\u3051\u305f\u306e\u3060\u304c\u3001\u305d\u306e\u540d\u6b8b\u3002\u306a\u305c\u4ed8\u3051\u305f\u304b\u306f\u826f\u304f\u899a\u3048\u3066\u3044\u306a\u3044\u3002\u3002\u3002\n\u3053\u308c\u3067\u5b8c\u6210\u3002\u5f8c\u306f\u30d3\u30eb\u30c9\u3057\u3066\u52d5\u3051\u3070OK\u3002\u52d5\u3051\u3070OK\u30fb\u30fb\u30fb\n\n\u4f7f\u3044\u65b9\nmake config\u3068defconfig\u3092\u30ab\u30b9\u30bf\u30de\u30a4\u30ba\u3057\u307e\u304f\u308b\u3060\u3051\u3002\nmake config \u6709\u52b9\u306b\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u306e\u306f\u4ee5\u4e0b\u3002\n- NET_DRIVER\n- NET_*(device)\n  - NET_PRO1000\u306a\u3069\u74b0\u5883\u306b\u5fdc\u3058\u3066\n- IP\n\u203bTTY_SERIAL\u306f\u7121\u52b9\u306b\u3057\u3066\u304a\u304f\ndefconfig\u306f\u3088\u3057\u306a\u306b\u3002pci,ip\u3092\u8a2d\u5b9a\u3059\u308c\u3070OK\u3002\nconfig.vmm.pci = \"slot=00:07.0,driver=conceal,and,device=pro1000,number=0,driver=pro1000,net=ip,tty=1\",\nconfig.ip = {\n    .ipaddr = { 192, 168, 0, 2 },\n    .netmask = { 255, 255, 255, 0 },\n    .gateway = { 192, 168, 0, 1 },\n}\n\n\u4f7f\u3063\u305f\u74b0\u5883\u306f\u3001PRO1000\u3002PCIe\u306e\u62e1\u5f35\u30dc\u30fc\u30c9\u3092\u4f7f\u3063\u305f\u306e\u3067\u3001\u30eb\u30fc\u30c8\u30d6\u30ea\u30c3\u30b8\u3092\u96a0\u3055\u306a\u3044\u3068panic\u3092\u8d77\u3053\u3059\u3002\u3053\u3053\u306f\u74b0\u5883\u4f9d\u5b58\u306a\u306e\u3067\u5b9f\u6a5f\u3092\u898b\u3066\u8abf\u6574\u3059\u308b\u3002\n\u8a73\u3057\u304f\u306f\u3053\u3053\u2192 http://www.bitvisor.org/archives/bitvisor-devel/2015-December/000071.html\n\u3042\u3068\u306fBitVisor\u3092\u30d3\u30eb\u30c9\u3057\u3066\u30c6\u30b9\u30c8\u6a5f\u3067\u8d77\u52d5\u3055\u305b\u3001\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u304bconfig.ip.ipaddr\u3067\u6307\u5b9a\u3057\u305f\u30a2\u30c9\u30ec\u30b9\u306b\u63a5\u7d9a\u3059\u308b\u3060\u3051\u3002\n\nClient\nnc 192.168.0.2 1234\n\n\nOS\u3067\u4f55\u304b\u3092\u66f8\u304d\u8fbc\u3081\u3070\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u5074\u306b\u51fa\u3066\u304f\u308b\u306f\u305a\u3002\n\nGuestOS\necho Hello > /etc/ttyS0\n\n\n\n\u53c2\u8003: \u30c6\u30b9\u30c8\u74b0\u5883\n\u8fd1\u5e74\u306f\u30b7\u30ea\u30a2\u30eb\u30dd\u30fc\u30c8\u4ed8\u304d\u306ePC\u304c\u5c11\u306a\u304f\u306a\u3063\u3066\u304d\u305f\u306e\u3067\u3001\u74b0\u5883\u3092\u7528\u610f\u3059\u308b\u306e\u304c\u96e3\u3057\u3044\u3002\u3057\u304b\u3082\u500b\u4eba\u30fb\u8da3\u5473\u3060\u3068\u8cc7\u91d1\u3082\u305d\u3093\u306a\u306b\u7121\u3044\u3002\n\u7d50\u5c40\u8272\u3005\u8a66\u3057\u305f\u7d50\u679c\u3001PC\u30b5\u30fc\u30d0\u3092\u4f7f\u3046\u306e\u65b9\u6cd5\u304c\u5272\u3068\u697d\u3060\u3068\u308f\u304b\u3063\u305f\u3002\u7279\u306bIPMI\u3001KVM over LAN\u304c\u3042\u308b\u306e\u3067\u30ea\u30e2\u30fc\u30c8\u3067\u3067\u304d\u308b\u3068\u3053\u308d\u304cGOOD\u3002\n\u8d77\u52d5\u306f\u3001PXE -> iPXE -> BitVisor -> CentOS (Local Disk) \u3068\u3057\u305f\u3002\n\n\u958b\u767aPC\n\n\n\u81ea\u4f5cPC\nIntel Core-i7 3770K\nDDR3 Non-ECC 8GB\nCentOS 7.2 x86_64\ngcc 4.8.5\n\n\n\u30c6\u30b9\u30c8PC\n\n\nDELL PowerEdge R610\nIntel Xeon X5650 (2 CPUs)\nDDR3 Registered-ECC 64GB\nBroadcom Corporation NetXtreme II BCM5709 Gigabit Ethernet\uff08\u30b2\u30b9\u30c8\u306eSSH\u3068PXE\u30d6\u30fc\u30c8\u7528\u3002\u3053\u308c\u306fbnx\u3067\u52d5\u304b\u306a\u304b\u3063\u305f\uff09\nIntel Corporation 82576 Gigabit Network Connection\uff08PRO1000\u3067\u52d5\u3044\u305f\uff09\nGuestOS: CentOS 7.2 x86_64\n\n\n\n\u3053\u306e\u74b0\u5883\u3067\u30c6\u30b9\u30c8\u3059\u308b\u6642\u306e\u6b8b\u5ff5\u306a\u3068\u3053\u308d\u306f\u3001POST\u304c\u9045\u3044\u3053\u3068\u30021\u8a66\u884c\u306b5\u5206\u304f\u3089\u3044\u304b\u304b\u308b\u3002Supermicro\u3060\u3068POST\u304c\u65e9\u304f\u3001\u4f53\u611f\u306730\u79d2\u672a\u6e80\u306a\u306e\u3067\u8a66\u3059\u3068\u304d\u306f\u3053\u3063\u3061\u304c\u826f\u3044\u304b\u3082\u3057\u308c\u306a\u3044\u3002\n\u3042\u3068\u3001Hyper Threading\u3092ON\u306b\u3057\u3066\u3044\u308b\u3068mm.c\u3067panic\u3057\u3066\u8d77\u52d5\u3057\u306a\u3044\u3002\u30b3\u30a2\u591a\u3059\u304e?HTT\u672a\u5bfe\u5fdc?\u3088\u304f\u308f\u304b\u3089\u3093\u3002\n\n\u3042\u3068\u304c\u304d\nBitVisor\u3067TCP/IP\u306f\u306a\u3093\u3068\u306a\u304f\u308f\u304b\u3063\u305f\u6c17\u306b\u306a\u3063\u305f\u3002\u4eca\u56de\u4f5c\u3063\u305f\u306e\u306f\u3001\u9001\u4fe1\u306e\u307f\u3060\u3051\u3060\u304c\u53d7\u4fe1\u3082\u5c11\u3057\u5de5\u592b\u3059\u308c\u3070\u3067\u304d\u308b\u6c17\u304c\u3059\u308b\u3002\n\u3042\u3068\u3001TCP/IP\u7528\u306b\u30b9\u30ec\u30c3\u30c9\u3092\u7acb\u3066\u308b\u5fc5\u8981\u304c\u3042\u308b\u304b\u3068\u601d\u3063\u305f\u304c\u3001net_main.c\u306b\u30b9\u30ec\u30c3\u30c9\u304c\u3042\u308b\u3088\u3046\u3067\u4f5c\u3089\u306a\u304f\u3066\u3082\u826f\u3044\u306e\u306f\u975e\u5e38\u306b\u697d\u3002\n\u30b7\u30ea\u30a2\u30eb\u30dd\u30fc\u30c8\u306e\u30d5\u30c3\u30af\u306f\u3001\u304b\u306a\u308a\u4e71\u66b4\u306b\u5b9f\u88c5\u3057\u305f\u306e\u3067\u74b0\u5883\u306b\u3088\u3063\u3066\u306f\u52d5\u4f5c\u3057\u306a\u3044\u304b\u3082\u3057\u308c\u306a\u3044\u3002FIFO\u30d0\u30c3\u30d5\u30a1\u304c\u8a70\u307e\u3063\u305f\u3089\u30cf\u30f3\u30b0\u3059\u308b\u6c17\u304c\u3059\u308b\u304c\u3001\u81ea\u5206\u306e\u74b0\u5883\u3067\u306f\u767a\u751f\u3057\u306a\u304b\u3063\u305f\u3002\n\u6700\u5f8c\u306b\u300c\u3053\u308c\u306f\u4f55\u306b\u4f7f\u3048\u308b\u306e\u304b\u300d\u3068\u3044\u3046\u58f0\u304c\u805e\u3053\u3048\u305d\u3046\u3060\u304c\u3001\u4eca\u306e\u5b9f\u88c5\u3067\u306f\u4f7f\u3048\u308b\u5834\u9762\u304c\u601d\u3044\u3064\u304b\u306a\u3044\u3002\u3082\u3057\u3001\u5165\u529b\u304c\u3042\u308c\u3070\u4eee\u60f3\u30b3\u30f3\u30bd\u30fc\u30eb (Serial-over-LAN\u307f\u305f\u3044\u306a\u3082\u306e) \u3068\u3057\u3066\u4f7f\u3048\u308b\u304b\u3082\u3057\u308c\u306a\u3044\u304c\u3001\u305d\u308c\u306f\u5185\u90e8\u7684\u306bIRQ\u3092\u767a\u751f\u3055\u305b\u308b\u5fc5\u8981\u304c\u3042\u3063\u3066\u3001PIC\u3084IO APIC\u306e\u51e6\u7406\u306b\u624b\u3092\u52a0\u3048\u308b\u5fc5\u8981\u304c\u3042\u308b\u3068\u601d\u3046\u2190\u9762\u5012\u304f\u3055\u3044\n\u307e\u305f\u6687\u3068\u3084\u308b\u6c17\u304c\u3042\u308c\u3070\u904a\u307c\u3046\u3002\n\n12/14 19:00\u8ffd\u8a18\n\u5165\u529b\u3092\u4f5c\u308d\u3046\u3068\u3059\u308b\u3068\u5272\u8fbc\u307f\u3092\u5236\u5fa1\u3057\u306a\u3051\u308c\u3070\u3044\u3051\u306a\u3044\u3068\u66f8\u3044\u305f\u304c\u3001\u3082\u3057\u304b\u3059\u308b\u3068\u30b7\u30ea\u30a2\u30eb\u30dd\u30fc\u30c8\u3092\u7269\u7406\u7684\u306b\u30eb\u30fc\u30d7\u30d0\u30c3\u30af\u63a5\u7d9a\u3057\u3066\u3084\u308b\u3068\u554f\u984c\u304c\u89e3\u6c7a\u3059\u308b\u304b\u3082\u3057\u308c\u306a\u3044\u3002\n\u8003\u3048\u305f\u3084\u308a\u65b9\u306f\u3001BitVisor\u3067\u30b2\u30b9\u30c8\u306e\u51fa\u529b\u3092\u30de\u30b9\u30af\u3057\u3001\u5b9f\u30c7\u30d0\u30a4\u30b9\u3078\u306e\u51e6\u7406\u3092\u59a8\u5bb3\u3055\u305b\u3001\u30b2\u30b9\u30c8\u3078\u306e\u5165\u529b\u3068\u3057\u3066\u4e0e\u3048\u308b\u30c7\u30fc\u30bf\u3092\u5b9f\u30c7\u30d0\u30a4\u30b9\u306b\u6295\u3052\u3064\u3051\u308b\u3002\u305d\u3046\u3059\u308b\u3068\u3001\u30ed\u30fc\u30ab\u30eb\u30a8\u30b3\u30fc\u3068\u306a\u308b\u306e\u3067\u30b2\u30b9\u30c8\u3078\u306e\u5165\u529b\u3068\u3057\u3066\u8a8d\u8b58\u3055\u308c\u308b\u306f\u305a\u3002\n\u305f\u3060\u3057\u3001\u51fa\u529b\u6642\u306b\u4f55\u3082\u3057\u306a\u3044\u6319\u52d5\u3068\u306a\u308b\u306e\u3067\u52d5\u304f\u304b\u306f\u672a\u77e5\u3002\n\u4eca\u3059\u3050\u3084\u3063\u3066\u307f\u305f\u3044\u3068\u3053\u308d\u3060\u304c\u3001\u30c6\u30b9\u30c8PC\u306f\u304b\u306a\u308a\u96e2\u308c\u305f\u5834\u6240\u306b\u8a2d\u7f6e\u3055\u308c\u3066\u3044\u3066\u3059\u3050\u306b\u306f\u691c\u8a3c\u4e0d\u53ef\u80fd\u3002\u307e\u305f\u4eca\u5ea6\u3001\u899a\u3048\u3066\u3044\u305f\u3089\u3084\u3063\u3066\u307f\u308b\u3002\n# \u307e\u3048\u304c\u304d\n\n\u3053\u306e\u524d\u3001BitVisor Summit 5\u3078\u904a\u3073\u306b\u884c\u3063\u305f\u3089\u30a2\u30c9\u30d9\u30f3\u30c8\u30ab\u30ec\u30f3\u30c0\u30fc\u306e\u52df\u96c6\u3092\u3084\u3063\u3066\u305f\u306e\u3067\u4e57\u3063\u304b\u308b\u3053\u3068\u306b\u3057\u305f\u3002\n\u809d\u5fc3\u306e\u30a2\u30c9\u30d9\u30f3\u30c8\u30ab\u30ec\u30f3\u30c0\u30fc\u306f\u3001\u3059\u3052\u3047\u4eba\u304c\u66f8\u304d\u307e\u304f\u3063\u3066\u3066\u4e2d\u3005\u306e\u30cf\u30fc\u30c9\u30eb\u306e\u9ad8\u3055\u3002\n\u521d\u53c2\u6226\u30fb\u521d\u5fc3\u8005\u304c\u66f8\u3044\u305f\u8a18\u4e8b\u306a\u306e\u3067\u3001\u304a\u624b\u67d4\u3089\u304b\u306b\u304a\u9858\u3044\u3057\u307e\u3059\u306d\uff01\n\n\u3067\u3001\u30b5\u30af\u30c3\u3068\u7c21\u5358\u306a\u3068\u3053\u308d\u3067\u30ec\u30ac\u30b7\u30fc\u306a\u30c7\u30d0\u30a4\u30b9\u3068lwIP\u3067\u904a\u3093\u3067\u307f\u305f\u3068\u3044\u3046\u5185\u5bb9\u3067\u66f8\u304f\u3053\u3068\u306b\u3059\u308b\u3002\n\n# \u3053\u308c\u306f\u4f55?\n\n\u30b2\u30b9\u30c8OS\u304c\u30b7\u30ea\u30a2\u30eb\u30dd\u30fc\u30c8\u306b\u66f8\u3044\u305f\u30c7\u30fc\u30bf\u3092BitVisor\u306eTCP/IP\u3067\u6d41\u3059\u3068\u3044\u3046\u3082\u306e\u3002\n\nI/O mapped I/O\u3092\u4f7f\u3063\u305f\u30aa\u30f3\u30dc\u30fc\u30c9\u306e\u30b7\u30ea\u30a2\u30eb\u30dd\u30fc\u30c8\uff088250 UART\uff09\u306e\u30a2\u30af\u30bb\u30b9\u3092\u6a2a\u53d6\u308a\u3057\u3066\u4f5c\u3063\u3066\u307f\u305f\u3002\nTCP/IP\u306f\u3001\u6700\u8fd1\u6a5f\u80fd\u8ffd\u52a0\u3055\u308c\u305flwIP\u3092\u4f7f\u3063\u3066\u5b9f\u88c5\u3002\u901a\u4fe1\u306f\u3001BitVisor\u5074\u304c\u30b5\u30fc\u30d0\u306b\u306a\u308b\u3088\u3046\u306b\u3057\u3066\u3001\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u3068\u306e\u63a5\u7d9a\u3092\u78ba\u7acb\u3059\u308b\u3002\u78ba\u7acb\u3055\u308c\u305f\u5f8c\u306b\u30b7\u30ea\u30a2\u30eb\u30dd\u30fc\u30c8\u3078\u66f8\u304d\u8fbc\u307e\u308c\u305f\u30c7\u30fc\u30bf\u3092\u305d\u306e\u307e\u307e\u8ee2\u9001\u3059\u308b\u3068\u3044\u3046\u4ed5\u7d44\u307f\u3002\n**\u306a\u304a\u3001\u30b7\u30ea\u30a2\u30eb\u30dd\u30fc\u30c8\u306e\u30a8\u30df\u30e5\u30ec\u30fc\u30b7\u30e7\u30f3\u6a5f\u80fd\u306f\u7121\u3044\u306e\u3067\u3001BitVisor\u3092\u52d5\u4f5c\u3055\u305b\u308bPC\u306b\u30b7\u30ea\u30a2\u30eb\u30dd\u30fc\u30c8\uff08COM1\uff09\u304c\u5b9f\u88c5\u3055\u308c\u3066\u3044\u306a\u3051\u308c\u3070\u4f7f\u7528\u3067\u304d\u306a\u3044\u306e\u3067\u6ce8\u610f\u3002**\n\u3053\u306e\u70b9\u306fBitVisor\u3063\u307d\u3044\u6c17\u304c\u3059\u308b\u3001\u6a2a\u53d6\u308a\u3057\u3066\u5f8c\u306f\u5b9f\u30cf\u30fc\u30c9\u4efb\u305b\u3068\u3044\u3046\u611f\u3058\u304c\u3002\n\n# \u66f8\u3044\u305f\u30d7\u30ed\u30b0\u30e9\u30e0\u306e\u8aac\u660e\n\n\u5168\u4f53\u306e\u6d41\u308c\u3068\u3057\u3066\u306f\u3001IO\u30d5\u30c3\u30af\u3057\u3066\u6349\u3048\u305f\u30c7\u30fc\u30bf\u3092TCP\u306b\u6d41\u3059\u3002\u305f\u3060\u305d\u308c\u3060\u3051\u3002\n\n## IO\u306e\u30d5\u30c3\u30af\n\nBitVisor\u306b\u306f\u5143\u3005 `core/serial.c` \u306e `serial_init_iohook` \u306b\u30c7\u30d0\u30c3\u30b0\u30ed\u30b0\u3092\u30b7\u30ea\u30a2\u30eb\u30dd\u30fc\u30c8\u306b\u51fa\u529b\u3059\u308b\u305f\u3081\u306e\u30b3\u30fc\u30c9\u304c\u66f8\u3044\u3066\u3042\u308b\u3002\u305d\u306e\u4e2d\u306b `TTY_SERIAL` \u304c\u6709\u52b9\u306b\u306a\u3063\u3066\u3044\u308b\u6642\u306b\u3001OS\u304b\u3089\u306e\u30b7\u30ea\u30a2\u30eb\u30dd\u30fc\u30c8\u30a2\u30af\u30bb\u30b9\u3092\u6368\u3066\u308b\u3088\u3046\u306a\u51e6\u7406\u304c\u3042\u308b\u3002\u3053\u308c\u3092\u53c2\u8003\u306b\u3057\u3066\u6b21\u306b\u793a\u3059\u3088\u3046\u306b\u6539\u9020\u3059\u308b\u3002\n\n```diff\ndiff -r 76db0ae4260b core/serial.c\n--- a/core/serial.c\tMon Sep 12 20:01:54 2016 +0900\n+++ b/core/serial.c\tSun Dec 11 18:25:20 2016 +0900\n@@ -165,13 +165,27 @@\n \tserial_send (PORT, c);\n }\n \n+void hook_uart_putchar (int);\n+static enum ioact\n+hook_uart (enum iotype type, u32 port, void *data) // THR or RBR or DLL\n+{\n+\tswitch (type) {\n+\tcase IOTYPE_OUTB:\n+\t\tif (!(port & 0x07))\n+\t\t\thook_uart_putchar (*(u8 *)data);\n+\t\tbreak;\n+\tdefault:\n+\t\tbreak;\n+\t}\n+\treturn do_iopass_default (type, port, data);\n+}\n+\n void\n serial_init_iohook (void)\n {\n \tunsigned int i;\n\n \tfor (i = PORT; i < PORT + NUM_OF_PORT; i++)\n-\t\tset_iofunc (i, do_io_nothing);\n+\t\tset_iofunc (i, hook_uart);\n }\ndiff -r 76db0ae4260b core/io_iopass.c\n--- a/core/io_iopass.c\tMon Sep 12 20:01:54 2016 +0900\n+++ b/core/io_iopass.c\tSun Dec 11 18:25:20 2016 +0900\n@@ -38,6 +38,7 @@\n #include \"printf.h\"\n #include \"tty.h\"\n #include \"types.h\"\n+#include \"serial.h\"\n \n enum ioact\n do_iopass_default (enum iotype type, u32 port, void *data)\n@@ -76,8 +77,12 @@\n \t\treturn;\n \tfor (i = 0; i < NUM_OF_IOPORT; i++)\n \t\tset_iofunc (i, do_iopass_default);\n+#ifndef TTY_SERIAL\n+\tserial_init_iohook ();\n+#else\n \ttty_init_iohook ();\n \tdebug_iohook ();\n+#endif\n \tacpi_iohook ();\n }\n ```\n\n\u5143\u306f\u3001`do_io_nothing`\u3092\u767b\u9332\u3057\u3066\u3001\u30b2\u30b9\u30c8OS\u304cIO\u3092\u767a\u884c\u3057\u305f\u6642\u306b\u4f55\u3082\u3057\u306a\u3044\u3068\u3044\u3046\u52d5\u4f5c\u3092\u3059\u308b\u3002\u3053\u306e\u90e8\u5206\u3092\u5fc5\u8981\u306a\u90e8\u5206\u3060\u3051\u30d5\u30c3\u30af\u3001\u3042\u3068\u306f\u30d1\u30b9\u30b9\u30eb\u30fc\u3068\u3044\u3046\u52d5\u4f5c\u306b\u66f8\u304d\u63db\u3048\u305f\u3002`hook_uart`\u95a2\u6570\u304c\u305d\u308c\u3002\n\n`hook_uart`\u95a2\u6570\u306f\u3001\u30d9\u30fc\u30b9\u306eIO\u30dd\u30fc\u30c8+0 (0x3F8) \u3078\u306e\u66f8\u304d\u8fbc\u307f\u306e\u307f\u3092\u30d5\u30c3\u30af\u3057\u3066\u305d\u308c\u4ee5\u5916\u306f\u30d1\u30b9\u30b9\u30eb\u30fc\u3059\u308b\u3088\u3046\u306b\u4ed5\u5411\u3051\u308b\u3002\u30d1\u30b9\u30b9\u30eb\u30fc\u51e6\u7406\u306f\u81ea\u529b\u3067\u66f8\u3044\u3066\u3082\u826f\u3044\u304c\u3001`do_iopass_default`\u304c\u3042\u308b\u306e\u3067\u6d41\u7528\u3059\u308b\uff08\u3053\u306e\u8fba\u308a\u306e\u66f8\u304d\u65b9\u306f\u306a\u3093\u3068\u306a\u304fWINAPI\u306eWndProc\u3063\u307d\u3044\uff09\u3002\n0x3F8\u3078\u306e\u66f8\u8fbc\u307f\u306f\u30b7\u30ea\u30a2\u30eb\u30dd\u30fc\u30c8\u3078\u51fa\u529b\u3068\u306a\u3063\u3066\u3044\u308b\u306e\u3067\u3001\u3053\u308c\u3092\u6349\u3048\u308c\u3070\u66f8\u304d\u8fbc\u307e\u308c\u308b\u30c7\u30fc\u30bf\u304c\u308f\u304b\u308b\uff08\u5b9f\u969b\u306f\u3061\u3087\u3063\u3068\u9055\u3046\u304c\u9762\u5012\u306a\u306e\u3067\u3053\u308c\u3067\u3084\u308b\uff09\u3002\n\u66f8\u304d\u8fbc\u307e\u308c\u305f\u30c7\u30fc\u30bf\u306f\u3001\u6b21\u3067\u8aac\u660e\u3059\u308bTCP/IP\u306e\u30b5\u30fc\u30d0\u30d7\u30ed\u30b0\u30e9\u30e0\u306b\u6295\u3052\u308b\u3088\u3046\u306b\u3057\u3066\u304a\u304f\u3002\n\n`serial_init_iohook`\u3092\u66f8\u304d\u63db\u3048\u305f\u3060\u3051\u3067\u306f\u3001`TTY_SERIAL`\u304c\u5ba3\u8a00\u3055\u308c\u3066\u3044\u306a\u3044\u6642\u306b\u3001\u3053\u306e\u51e6\u7406\u3092\u901a\u306a\u3089\u304f\u306a\u308b\u306e\u3067\u3001`iopass.c`\u306b\u547c\u3073\u51fa\u3059\u30b3\u30fc\u30c9\u3092\u66f8\u304d\u52a0\u3048\u3066\u3044\u308b\u3002\n\u6ce8\u610f\u70b9\u306f\u3001\u30b7\u30ea\u30a2\u30eb\u30c7\u30d0\u30c3\u30b0\u6642\u306bBitVisor\u3068\u30b2\u30b9\u30c8OS\u306e\u30c7\u30fc\u30bf\u304c\u6df7\u308b\u3068\u3044\u3046\u554f\u984c\u304c\u767a\u751f\u3059\u308b\uff08\u305f\u3076\u3093\uff09\u3002\n\u4eca\u56de\u306f\u904a\u3093\u3067\u307f\u305f\u3060\u3051\u306a\u306e\u3067\u3001\u3053\u306e\u554f\u984c\u306f\u3042\u307e\u308a\u6c17\u306b\u3057\u306a\u3044\u3053\u3068\u306b\u3057\u3066\u304a\u304f\uff08\u521d\u671f\u5316\u51e6\u7406\u3092\u66f8\u304d\u63db\u3048\u305a\u306b\u5c02\u7528\u306e\u521d\u671f\u5316\u95a2\u6570\u306b\u4f5c\u3063\u3066\u304a\u3051\u3070\u826f\u304b\u3063\u305f\u6c17\u304c\u3059\u308b\u304c\u3001\u3084\u3063\u3066\u3057\u307e\u3063\u305f\u3082\u306e\u306f\u4ed5\u65b9\u306a\u3044\uff09\u3002\n\n\u3053\u3053\u307e\u3067\u3067\u30d5\u30c3\u30af\u51e6\u7406\u306f\u3067\u304d\u305f\u3002\u3042\u3068\u306fTCP\u3067\u9001\u308b\u3060\u3051\u3002\n\n## TCP/IP\n\nlwIP\u3068\u3044\u3046\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u30b9\u30bf\u30c3\u30af\u304c\u5b9f\u88c5\u3055\u308c\u3066\u3044\u308b\u304c\u3001Linux\u3067\u3088\u304f\u3042\u308b\u30bd\u30b1\u30c3\u30c8\u30d7\u30ed\u30b0\u30e9\u30df\u30f3\u30b0\u3068\u5c11\u3057\u3060\u3051\u9055\u3046\u3002\nlwIP\u306f\u3001\u7d44\u8fbc\u30b7\u30b9\u30c6\u30e0\u5411\u3051\u306b\u4f5c\u3089\u308c\u3066\u3044\u308b\u3002\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u3092\u4f7f\u3063\u305f\u975e\u540c\u671f\u52d5\u4f5c\u3068\u601d\u3063\u3066\u304a\u3051\u3070\u554f\u984c\u7121\u3044\u3068\u601d\u3046\u3002\n\u5b9f\u969b\u306b\u4f5c\u308b\u6642\u306f\u3001`ip`\u30c7\u30a3\u30ec\u30c8\u30ea\u306e\u4e0b\u306b `echo-server.c` \u3068\u304b\u8272\u3005\u30b5\u30f3\u30d7\u30eb\u304c\u8ee2\u304c\u3063\u3066\u3044\u308b\u306e\u3067\u305d\u308c\u3092\u53c2\u8003\u306b\u4f5c\u308c\u3070\u3088\u3055\u3052\u3002\n\nBitVisor\u3067\u306e\u4f5c\u308a\u65b9\u306e\u6ce8\u610f\u3068\u3057\u3066\u306f\u3001`core`\u3068\u304b\u306b\u7f6e\u3044\u3066\u3057\u307e\u3046\u3068\u30d8\u30c3\u30c0\u30fc\u306e\u30d1\u30b9\u304c\u304b\u306a\u308a\u9055\u3046\u306e\u3067\u3001\u30b3\u30f3\u30d1\u30a4\u30eb\u304c\u3046\u307e\u304f\u3044\u304b\u306a\u3044\uff08\u3068\u3044\u3046\u304b`Makefile`\u306e\u66f8\u63db\u304c\u9762\u5012\uff09\u3002TCP/IP\u306e\u30d7\u30ed\u30b0\u30e9\u30e0\u3092\u66f8\u304f\u3068\u304d\u306f\u3001`ip`\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u914d\u4e0b\u306b\u4f5c\u308b\u65b9\u304c\u30c8\u30e9\u30d6\u30eb\u304c\u5c11\u306a\u3044\u3002\n\n\u3067\u3001\u66f8\u3044\u305f\u306e\u304c\u4ee5\u4e0b\u3002\n\n```diff\ndiff -r 76db0ae4260b ip/Makefile\n--- a/ip/Makefile\tMon Sep 12 20:01:54 2016 +0900\n+++ b/ip/Makefile\tSun Dec 11 18:25:20 2016 +0900\n@@ -41,3 +41,4 @@\n objs-1 += ip_sys.o arch/sys_arch.o\n objs-1 += ip_main.o net_main.o\n objs-1 += echo-server.o echo-client.o echoctl.o\n+objs-1 += serial-tcp.o\ndiff -r 76db0ae4260b ip/ip_main.c\n--- a/ip/ip_main.c\tMon Sep 12 20:01:54 2016 +0900\n+++ b/ip/ip_main.c\tSun Dec 11 18:25:20 2016 +0900\n@@ -266,6 +266,8 @@\n \n \t/* Configure and add network interface. */\n \ttcpip_netif_conf (netif_arg, netif_num);\n+\n+\tinit_uart_tcp ();\n }\n \n void\ndiff -r 76db0ae4260b ip/serial-tcp.c\n--- /dev/null\tThu Jan 01 00:00:00 1970 +0000\n+++ b/ip/serial-tcp.c\tSun Dec 11 18:25:20 2016 +0900\n@@ -0,0 +1,95 @@\n+#include <core/spinlock.h>\n+#include <core/list.h>\n+#include \"lwip/tcp.h\"\n+\n+struct tcp_sock {\n+\tLIST1_DEFINE (struct tcp_sock);\n+\tstruct tcp_pcb *pcb;\n+};\n+static LIST1_DEFINE_HEAD (struct tcp_sock, tcp_sock_list);\n+static spinlock_t tcp_sock_lock;\n+\n+static err_t uart_tcp_recv (void *arg, struct tcp_pcb *pcb, struct pbuf *pbuf, err_t err)\n+{\n+\tstruct tcp_sock *p = (struct tcp_sock *)arg;\n+\tif (!pbuf) {\n+\t\ttcp_close (pcb);\n+\t\tprintf (\"Disconnected\\n\");\n+\n+\t\tspinlock_lock (&tcp_sock_lock);\n+\t\tLIST1_DEL (tcp_sock_list, p);\n+\t\tspinlock_unlock (&tcp_sock_lock);\n+\t\tmem_free (p);\n+\t}\n+\n+\treturn err;\n+}\n+\n+static err_t uart_tcp_accept (void *arg, struct tcp_pcb *newpcb, err_t err)\n+{\n+\tstruct tcp_sock *p;\n+\n+\tLWIP_UNUSED_ARG(arg);\n+\tLWIP_UNUSED_ARG(err);\n+\n+\tspinlock_lock (&tcp_sock_lock);\n+\tp = (struct tcp_sock *)mem_malloc (sizeof (struct tcp_sock));\n+\tif (!p)\n+\t\tpanic (\"mem_malloc\");\n+\tp->pcb = newpcb;\n+\tLIST1_ADD (tcp_sock_list, p);\n+\tspinlock_unlock (&tcp_sock_lock);\n+\n+\ttcp_arg (newpcb, p);\n+\ttcp_recv (newpcb, uart_tcp_recv);\n+\n+\tprintf (\"Connected!\\n\");\n+\n+\treturn ERR_OK;\n+}\n+\n+static bool initialized;\n+\n+void hook_uart_putchar (int ch)\n+{\n+\tchar str[1] = { ch };\n+\tstruct tcp_sock *p;\n+\n+\t//printf (\"uart: putchar %02x\\n\", ch);\n+\n+\tif (!initialized)\n+\t\treturn;\n+\n+\tspinlock_lock (&tcp_sock_lock);\n+\tLIST1_FOREACH (tcp_sock_list, p) {\n+\t\ttcp_write (p->pcb, str, 1, 1);\n+\t}\n+\tspinlock_unlock (&tcp_sock_lock);\n+}\n+\n+void init_uart_tcp (void)\n+{\n+\tstruct tcp_pcb *pcb;\n+\n+\tif (initialized)\n+\t\tpanic (\"already initialized!\");\n+\n+\tspinlock_init (&tcp_sock_lock);\n+\tLIST1_HEAD_INIT (tcp_sock_list);\n+\n+\tpcb = tcp_new ();\n+\tif (pcb) {\n+\t\terr_t err;\n+\t\terr = tcp_bind (pcb, IP_ADDR_ANY, 1234);\n+\t\tif (err == ERR_OK) {\n+\t\t\tpcb = tcp_listen (pcb);\n+\t\t\ttcp_accept (pcb, uart_tcp_accept);\n+\t\t} else {\n+\t\t\tpanic (\"tcp_bind\");\n+\t\t}\n+\t} else {\n+\t\tpanic (\"tcp_new\");\n+\t}\n+\n+\tinitialized = true;\n+}\n```\n\n`init_uart_tcp`\u304c\u30b5\u30fc\u30d0\u306e\u521d\u671f\u5316\u51e6\u7406\u3002\u30bd\u30b1\u30c3\u30c8\u30d7\u30ed\u30b0\u30e9\u30df\u30f3\u30b0\u3067\u8a00\u3046\u3068\u3053\u308d\u306e`socket -> bind -> listen -> accept`\u306e\u9806\u3067\u521d\u671f\u5316\u3059\u308b\u51e6\u7406\u3092\u66f8\u3044\u3066\u3044\u308b\u3002\u9055\u3046\u3068\u3053\u308d\u3092\u6307\u6458\u3059\u308b\u306a\u3089\u3001accept\u304c\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u306b\u306a\u3063\u3066\u3044\u308b\u3068\u3053\u308d\u3002\u3053\u308c\u3067\u975e\u540c\u671f\u52d5\u4f5c\u306b\u306a\u308a\u3001`init_uart_tcp`\u306f\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u306e\u63a5\u7d9a\u3092\u5f85\u305f\u305a\u306b\u7d42\u4e86\u3059\u308b\u3002\n\n\u521d\u671f\u5316\u5b8c\u4e86\u5f8c\u306f\u30011234/tcp\u3067\u5f85\u6a5f\u3059\u308b\u306e\u3067telnet\u306a\u308anc\u306a\u308a\u3067\u63a5\u7d9a\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u308b\u3002\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u63a5\u7d9a\u6642\u306f\u3001`uart_tcp_accept`\u304c\u547c\u3073\u51fa\u3055\u308c\u3066\u3001\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u7528\u306e\u30bd\u30b1\u30c3\u30c8\u304c\u4f5c\u6210\u3055\u308c\u308b\u3002\u4f5c\u6210\u3055\u308c\u305f\u30bd\u30b1\u30c3\u30c8\u306f\u3001\u30ea\u30b9\u30c8\u306b\u8ffd\u52a0\u3057\u3066\u30b7\u30ea\u30a2\u30eb\u30dd\u30fc\u30c8\u51fa\u529b\u6642\uff08`hook_uart_putchar`\u304b\u3089\u547c\u51fa\u3057\uff09\u306b\u66f8\u304d\u8fbc\u307e\u308c\u308b\u3088\u3046\u306b\u3057\u3066\u304a\u304f\u3002\n\n\u53d7\u4fe1\u7528\u306e\u52d5\u4f5c\u3092`uart_tcp_recv`\u3067\u5b9a\u7fa9\u3057\u3066\u3044\u308b\u304c\u3001\u4eca\u56de\u306f\u53d7\u4fe1\u6a5f\u80fd\u3067\u306f\u306a\u304f\u7d42\u4e86\u30bf\u30a4\u30df\u30f3\u30b0\u3092\u53d6\u308b\u305f\u3081\u306b\u4f7f\u7528\u3057\u3066\u3044\u308b\u3002\n`tcp_recv`\u95a2\u6570\u3067\u767b\u9332\u3055\u308c\u305f\u95a2\u6570\u306f\u3001\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u304b\u3089\u30c7\u30fc\u30bf\u3092\u53d7\u4fe1\u3057\u305f\u6642\u4ee5\u5916\u306b\u3001\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u304b\u3089\u30bb\u30c3\u30b7\u30e7\u30f3\u30af\u30ed\u30fc\u30ba\u3057\u305f\u6642\u306b\u3082\u547c\u3073\u51fa\u3055\u308c\u308b\u3002\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u304b\u3089`FIN`\u304c\u9001\u4fe1\u3055\u308c\u3066\u304f\u308b\u3068`pbuf==NULL`\u3067\u547c\u3073\u51fa\u3055\u308c\u308b\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u308b\u306e\u3067\u3001\u305d\u308c\u3092\u6761\u4ef6\u3068\u3057\u3066\u30af\u30ea\u30fc\u30f3\u30ca\u30c3\u30d7\u3059\u308b\u3002\n\n`hook_uart_putchar`\u306f\u3001\u30ea\u30b9\u30c8\u3092\u8fbf\u308a\u5168\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u306b`tcp_write`\u95a2\u6570\u3067\u30c7\u30fc\u30bf\u30921\u30d0\u30a4\u30c8\u305a\u3064\u9001\u308a\u4ed8\u3051\u3066\u3044\u308b\u3002\u30d7\u30ed\u30b0\u30e9\u30e0\u4e0a\u306f1\u30d0\u30a4\u30c8\u305a\u3064\u9001\u4fe1\u3059\u308b\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u308b\u304c\u3001\u5b9f\u969b\u306flwIP\u3067\u30d0\u30c3\u30d5\u30a1\u30ea\u30f3\u30b0\u3055\u308c15-20\u30d0\u30a4\u30c8\u304f\u3089\u3044\u3067\u9001\u3089\u308c\u3066\u3044\u305f\u3002\n\n`initialized`\u5909\u6570\u306f\u3001\u521d\u671f\u5316\u3092\u7ba1\u7406\u3059\u308b\u30d5\u30e9\u30b0\u3060\u304c\u3001\u6050\u3089\u304f\u7121\u304f\u3066\u3082\u52d5\u304f\u3002\u4f5c\u308a\u59cb\u3081\u306f\u521d\u671f\u5316\u51e6\u7406\u3092`serial_init_iohook`\u306b\u66f8\u3044\u3066\u3044\u305f\u304c\u3001\u3053\u308c\u3067\u306flwIP\u304c\u521d\u671f\u5316\u3055\u308c\u308b\u524d\u306b`init_uart_tcp`\u304c\u547c\u3073\u51fa\u3055\u308c\u3066\u3057\u307e\u3046\u306e\u3067\u3001`panic(\"tcp_new\");`\u3067\u6b7b\u306c\u3068\u8a00\u3046\u554f\u984c\u304c\u767a\u751f\u3057\u3066\u3044\u305f\u3002\u4ed5\u65b9\u306a\u3044\u306e\u3067`lwIP_init`\u306e\u5f8c\u306b\u521d\u671f\u5316\u51e6\u7406\u3092\u57cb\u3081\u8fbc\u307f\u3001\u4f55\u3068\u304b\u52d5\u304f\u3088\u3046\u306b\u3057\u305f\u3002\u305d\u306e\u904e\u7a0b\u306e\u3069\u3053\u304b\u3067`initialized`\u5909\u6570\u3092\u4ed8\u3051\u305f\u306e\u3060\u304c\u3001\u305d\u306e\u540d\u6b8b\u3002\u306a\u305c\u4ed8\u3051\u305f\u304b\u306f\u826f\u304f\u899a\u3048\u3066\u3044\u306a\u3044\u3002\u3002\u3002\n\n\u3053\u308c\u3067\u5b8c\u6210\u3002\u5f8c\u306f\u30d3\u30eb\u30c9\u3057\u3066\u52d5\u3051\u3070OK\u3002\u52d5\u3051\u3070OK\u30fb\u30fb\u30fb\n\n## \u4f7f\u3044\u65b9\n\n`make config`\u3068`defconfig`\u3092\u30ab\u30b9\u30bf\u30de\u30a4\u30ba\u3057\u307e\u304f\u308b\u3060\u3051\u3002\n\n`make config` \u6709\u52b9\u306b\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u306e\u306f\u4ee5\u4e0b\u3002\n- NET_DRIVER\n- NET_*(device)\n  - NET_PRO1000\u306a\u3069\u74b0\u5883\u306b\u5fdc\u3058\u3066\n- IP\n\u203bTTY_SERIAL\u306f\u7121\u52b9\u306b\u3057\u3066\u304a\u304f\n\n`defconfig`\u306f\u3088\u3057\u306a\u306b\u3002`pci,ip`\u3092\u8a2d\u5b9a\u3059\u308c\u3070OK\u3002\n\n```C\nconfig.vmm.pci = \"slot=00:07.0,driver=conceal,and,device=pro1000,number=0,driver=pro1000,net=ip,tty=1\",\nconfig.ip = {\n\t.ipaddr = { 192, 168, 0, 2 },\n\t.netmask = { 255, 255, 255, 0 },\n\t.gateway = { 192, 168, 0, 1 },\n}\n```\n\n\u4f7f\u3063\u305f\u74b0\u5883\u306f\u3001PRO1000\u3002PCIe\u306e\u62e1\u5f35\u30dc\u30fc\u30c9\u3092\u4f7f\u3063\u305f\u306e\u3067\u3001\u30eb\u30fc\u30c8\u30d6\u30ea\u30c3\u30b8\u3092\u96a0\u3055\u306a\u3044\u3068panic\u3092\u8d77\u3053\u3059\u3002\u3053\u3053\u306f\u74b0\u5883\u4f9d\u5b58\u306a\u306e\u3067\u5b9f\u6a5f\u3092\u898b\u3066\u8abf\u6574\u3059\u308b\u3002\n\u8a73\u3057\u304f\u306f\u3053\u3053\u2192 http://www.bitvisor.org/archives/bitvisor-devel/2015-December/000071.html\n\n\u3042\u3068\u306fBitVisor\u3092\u30d3\u30eb\u30c9\u3057\u3066\u30c6\u30b9\u30c8\u6a5f\u3067\u8d77\u52d5\u3055\u305b\u3001\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u304b`config.ip.ipaddr`\u3067\u6307\u5b9a\u3057\u305f\u30a2\u30c9\u30ec\u30b9\u306b\u63a5\u7d9a\u3059\u308b\u3060\u3051\u3002\n\n```bash:Client\nnc 192.168.0.2 1234\n```\n\nOS\u3067\u4f55\u304b\u3092\u66f8\u304d\u8fbc\u3081\u3070\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u5074\u306b\u51fa\u3066\u304f\u308b\u306f\u305a\u3002\n\n```bash:GuestOS\necho Hello > /etc/ttyS0\n```\n\n## \u53c2\u8003: \u30c6\u30b9\u30c8\u74b0\u5883\n\n\u8fd1\u5e74\u306f\u30b7\u30ea\u30a2\u30eb\u30dd\u30fc\u30c8\u4ed8\u304d\u306ePC\u304c\u5c11\u306a\u304f\u306a\u3063\u3066\u304d\u305f\u306e\u3067\u3001\u74b0\u5883\u3092\u7528\u610f\u3059\u308b\u306e\u304c\u96e3\u3057\u3044\u3002\u3057\u304b\u3082\u500b\u4eba\u30fb\u8da3\u5473\u3060\u3068\u8cc7\u91d1\u3082\u305d\u3093\u306a\u306b\u7121\u3044\u3002\n\u7d50\u5c40\u8272\u3005\u8a66\u3057\u305f\u7d50\u679c\u3001PC\u30b5\u30fc\u30d0\u3092\u4f7f\u3046\u306e\u65b9\u6cd5\u304c\u5272\u3068\u697d\u3060\u3068\u308f\u304b\u3063\u305f\u3002\u7279\u306bIPMI\u3001KVM over LAN\u304c\u3042\u308b\u306e\u3067\u30ea\u30e2\u30fc\u30c8\u3067\u3067\u304d\u308b\u3068\u3053\u308d\u304cGOOD\u3002\n\n\u8d77\u52d5\u306f\u3001PXE -> iPXE -> BitVisor -> CentOS (Local Disk) \u3068\u3057\u305f\u3002\n\n- \u958b\u767aPC\n    - \u81ea\u4f5cPC\n    - Intel Core-i7 3770K\n    - DDR3 Non-ECC 8GB\n    - CentOS 7.2 x86_64\n    - gcc 4.8.5\n- \u30c6\u30b9\u30c8PC\n    - DELL PowerEdge R610\n    - Intel Xeon X5650 (2 CPUs)\n    - DDR3 Registered-ECC 64GB\n    - Broadcom Corporation NetXtreme II BCM5709 Gigabit Ethernet\uff08\u30b2\u30b9\u30c8\u306eSSH\u3068PXE\u30d6\u30fc\u30c8\u7528\u3002\u3053\u308c\u306fbnx\u3067\u52d5\u304b\u306a\u304b\u3063\u305f\uff09\n    - Intel Corporation 82576 Gigabit Network Connection\uff08PRO1000\u3067\u52d5\u3044\u305f\uff09\n    - GuestOS: CentOS 7.2 x86_64\n\n\u3053\u306e\u74b0\u5883\u3067\u30c6\u30b9\u30c8\u3059\u308b\u6642\u306e\u6b8b\u5ff5\u306a\u3068\u3053\u308d\u306f\u3001**POST\u304c\u9045\u3044**\u3053\u3068\u30021\u8a66\u884c\u306b5\u5206\u304f\u3089\u3044\u304b\u304b\u308b\u3002Supermicro\u3060\u3068POST\u304c\u65e9\u304f\u3001\u4f53\u611f\u306730\u79d2\u672a\u6e80\u306a\u306e\u3067\u8a66\u3059\u3068\u304d\u306f\u3053\u3063\u3061\u304c\u826f\u3044\u304b\u3082\u3057\u308c\u306a\u3044\u3002\n\u3042\u3068\u3001Hyper Threading\u3092ON\u306b\u3057\u3066\u3044\u308b\u3068`mm.c`\u3067panic\u3057\u3066\u8d77\u52d5\u3057\u306a\u3044\u3002\u30b3\u30a2\u591a\u3059\u304e?HTT\u672a\u5bfe\u5fdc?\u3088\u304f\u308f\u304b\u3089\u3093\u3002\n\n# \u3042\u3068\u304c\u304d\n\nBitVisor\u3067TCP/IP\u306f\u306a\u3093\u3068\u306a\u304f\u308f\u304b\u3063\u305f\u6c17\u306b\u306a\u3063\u305f\u3002\u4eca\u56de\u4f5c\u3063\u305f\u306e\u306f\u3001\u9001\u4fe1\u306e\u307f\u3060\u3051\u3060\u304c\u53d7\u4fe1\u3082\u5c11\u3057\u5de5\u592b\u3059\u308c\u3070\u3067\u304d\u308b\u6c17\u304c\u3059\u308b\u3002\n\u3042\u3068\u3001TCP/IP\u7528\u306b\u30b9\u30ec\u30c3\u30c9\u3092\u7acb\u3066\u308b\u5fc5\u8981\u304c\u3042\u308b\u304b\u3068\u601d\u3063\u305f\u304c\u3001`net_main.c`\u306b\u30b9\u30ec\u30c3\u30c9\u304c\u3042\u308b\u3088\u3046\u3067\u4f5c\u3089\u306a\u304f\u3066\u3082\u826f\u3044\u306e\u306f\u975e\u5e38\u306b\u697d\u3002\n\n\u30b7\u30ea\u30a2\u30eb\u30dd\u30fc\u30c8\u306e\u30d5\u30c3\u30af\u306f\u3001\u304b\u306a\u308a\u4e71\u66b4\u306b\u5b9f\u88c5\u3057\u305f\u306e\u3067\u74b0\u5883\u306b\u3088\u3063\u3066\u306f\u52d5\u4f5c\u3057\u306a\u3044\u304b\u3082\u3057\u308c\u306a\u3044\u3002FIFO\u30d0\u30c3\u30d5\u30a1\u304c\u8a70\u307e\u3063\u305f\u3089\u30cf\u30f3\u30b0\u3059\u308b\u6c17\u304c\u3059\u308b\u304c\u3001\u81ea\u5206\u306e\u74b0\u5883\u3067\u306f\u767a\u751f\u3057\u306a\u304b\u3063\u305f\u3002\n\n\u6700\u5f8c\u306b\u300c\u3053\u308c\u306f\u4f55\u306b\u4f7f\u3048\u308b\u306e\u304b\u300d\u3068\u3044\u3046\u58f0\u304c\u805e\u3053\u3048\u305d\u3046\u3060\u304c\u3001\u4eca\u306e\u5b9f\u88c5\u3067\u306f\u4f7f\u3048\u308b\u5834\u9762\u304c\u601d\u3044\u3064\u304b\u306a\u3044\u3002\u3082\u3057\u3001\u5165\u529b\u304c\u3042\u308c\u3070\u4eee\u60f3\u30b3\u30f3\u30bd\u30fc\u30eb (Serial-over-LAN\u307f\u305f\u3044\u306a\u3082\u306e) \u3068\u3057\u3066\u4f7f\u3048\u308b\u304b\u3082\u3057\u308c\u306a\u3044\u304c\u3001\u305d\u308c\u306f\u5185\u90e8\u7684\u306bIRQ\u3092\u767a\u751f\u3055\u305b\u308b\u5fc5\u8981\u304c\u3042\u3063\u3066\u3001PIC\u3084IO APIC\u306e\u51e6\u7406\u306b\u624b\u3092\u52a0\u3048\u308b\u5fc5\u8981\u304c\u3042\u308b\u3068\u601d\u3046\u2190\u9762\u5012\u304f\u3055\u3044\n\n\u307e\u305f\u6687\u3068\u3084\u308b\u6c17\u304c\u3042\u308c\u3070\u904a\u307c\u3046\u3002\n\n***\n12/14 19:00\u8ffd\u8a18\n\u5165\u529b\u3092\u4f5c\u308d\u3046\u3068\u3059\u308b\u3068\u5272\u8fbc\u307f\u3092\u5236\u5fa1\u3057\u306a\u3051\u308c\u3070\u3044\u3051\u306a\u3044\u3068\u66f8\u3044\u305f\u304c\u3001\u3082\u3057\u304b\u3059\u308b\u3068\u30b7\u30ea\u30a2\u30eb\u30dd\u30fc\u30c8\u3092\u7269\u7406\u7684\u306b\u30eb\u30fc\u30d7\u30d0\u30c3\u30af\u63a5\u7d9a\u3057\u3066\u3084\u308b\u3068\u554f\u984c\u304c\u89e3\u6c7a\u3059\u308b\u304b\u3082\u3057\u308c\u306a\u3044\u3002\n\u8003\u3048\u305f\u3084\u308a\u65b9\u306f\u3001BitVisor\u3067\u30b2\u30b9\u30c8\u306e\u51fa\u529b\u3092\u30de\u30b9\u30af\u3057\u3001\u5b9f\u30c7\u30d0\u30a4\u30b9\u3078\u306e\u51e6\u7406\u3092\u59a8\u5bb3\u3055\u305b\u3001\u30b2\u30b9\u30c8\u3078\u306e\u5165\u529b\u3068\u3057\u3066\u4e0e\u3048\u308b\u30c7\u30fc\u30bf\u3092\u5b9f\u30c7\u30d0\u30a4\u30b9\u306b\u6295\u3052\u3064\u3051\u308b\u3002\u305d\u3046\u3059\u308b\u3068\u3001\u30ed\u30fc\u30ab\u30eb\u30a8\u30b3\u30fc\u3068\u306a\u308b\u306e\u3067\u30b2\u30b9\u30c8\u3078\u306e\u5165\u529b\u3068\u3057\u3066\u8a8d\u8b58\u3055\u308c\u308b\u306f\u305a\u3002\n\u305f\u3060\u3057\u3001\u51fa\u529b\u6642\u306b\u4f55\u3082\u3057\u306a\u3044\u6319\u52d5\u3068\u306a\u308b\u306e\u3067\u52d5\u304f\u304b\u306f\u672a\u77e5\u3002\n\u4eca\u3059\u3050\u3084\u3063\u3066\u307f\u305f\u3044\u3068\u3053\u308d\u3060\u304c\u3001\u30c6\u30b9\u30c8PC\u306f\u304b\u306a\u308a\u96e2\u308c\u305f\u5834\u6240\u306b\u8a2d\u7f6e\u3055\u308c\u3066\u3044\u3066\u3059\u3050\u306b\u306f\u691c\u8a3c\u4e0d\u53ef\u80fd\u3002\u307e\u305f\u4eca\u5ea6\u3001\u899a\u3048\u3066\u3044\u305f\u3089\u3084\u3063\u3066\u307f\u308b\u3002\n", "tags": ["BitVisor"]}