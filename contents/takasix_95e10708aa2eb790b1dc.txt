{"context": " More than 1 year has passed since last update.\u3053\u308c\u306ftest-kitchen, serverspec, Docker\u3092\u3064\u304b\u3063\u3066Ansible\u306e\u30c6\u30b9\u30c8\u99c6\u52d5\u958b\u767a\u3092\u884c\u3046\u74b0\u5883\u3092\u69cb\u7bc9\u3059\u308b\u624b\u9806\u3067\u3059\u3002\nUbuntu14,CentOS7\u3067Apache2\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3001\u30b5\u30fc\u30d3\u30b9\u3092\u8d77\u52d5\u3057\u3001\u30d6\u30fc\u30c8\u6642\u306e\u30b5\u30fc\u30d3\u30b9\u81ea\u52d5\u8d77\u52d5\u3092\u8a2d\u5b9a\u3059\u308b\u30d9\u30b9\u30c8\u30d7\u30e9\u30af\u30c6\u30a3\u30b9\u69cb\u62101\u306eAnsible playbook\u3092\u4f8b\u3068\u3057\u3066\u53d6\u308a\u3042\u3052\u307e\u3059\u3002\n\n\u3053\u306e\u8a18\u4e8b\u306e\u76ee\u6a19\nAnsible\u306eTDD\u74b0\u5883\u3068\u3057\u3066\u3001test-kitchen\u3067\u6b21\u306e\u3053\u3068\u304c\u51fa\u6765\u308b\u74b0\u5883\u3092\u4f5c\u308a\u307e\u3059\u3002\n\nDocker\u4e0a\u306bUbuntu14, CentOS7\u306e\u30b3\u30f3\u30c6\u30ca\u3092\u7acb\u3061\u4e0a\u3052\n\u5404\u30b3\u30f3\u30c6\u30ca\u3092Ansible\u3067\u30d7\u30ed\u30d3\u30b8\u30e7\u30cb\u30f3\u30b0\n\u5404\u30b3\u30f3\u30c6\u30ca\u306e\u30d7\u30ed\u30d3\u30b8\u30e7\u30cb\u30f3\u30b0\u7d50\u679c\u3092Serverspec\u3067\u691c\u8a3c\n\n\n\u524d\u63d0\u6761\u4ef6\u7b49\n\u3053\u306e\u8a18\u4e8b\u306e\u524d\u63d0\u6761\u4ef6\u306f\u4ee5\u4e0b\u306e\u3068\u304a\u308a\u3067\u3059\u3002\n\n\u4f5c\u6210\u3059\u308bAnsible playbook\u306e\u69cb\u6210\u306f\u30d9\u30b9\u30c8\u30d7\u30e9\u30af\u30c6\u30a3\u30b9\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u30ec\u30a4\u30a2\u30a6\u30c8\u306b\u5f93\u30461\u3000\n\u4f5c\u696d\u74b0\u5883\u306f\n\n\nCentOS6.7(x86_64)\nRuby\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u6e08\u307f\u306e\u3053\u3068\nbundler\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u6e08\u307f\u306e\u3053\u3068\nDocker\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u6e08\u307f\u306e\u3053\u3068\n\n\n\n\u306a\u304a\u3001\u3053\u306e\u8a18\u4e8b\u306e\u691c\u8a3c\u306b\u4f7f\u7528\u3057\u305f\u74b0\u5883\u306f\u4ee5\u4e0b\u306e\u3068\u304a\u308a\u3067\u3059\u3002\n\n\u3053\u306e\u8a18\u4e8b\u306e\u691c\u8a3c\u306b\u4f7f\u7528\u3057\u305f\u74b0\u5883\n$ cat /etc/redhat-release\nCentOS release 6.7 (Final)\n$ arch\nx86_64\n$ ruby -v\nruby 2.1.5p273 (2014-11-13 revision 48405) [x86_64-linux]\n$ bundler -v\nBundler version 1.9.2\n$ docker -v\nDocker version 1.7.1, build 786b29d\n\n\n(2015-12-04\u8ffd\u8a18)\n\u74b0\u5883\u69cb\u7bc9\u7528\u306eVagrantfile\u3092\u4f5c\u308a\u307e\u3057\u305f\u3002\nhttps://github.com/takasix/vagrant_kitchen_ansible\n(\u5143\u3005\u5225\u306e\u7528\u304c\u3042\u3063\u3066\u4f5c\u3063\u305f\u3082\u306e\u306a\u306e\u3067\u3001\u30d0\u30fc\u30b8\u30e7\u30f3\u6307\u5b9a\u304c\u5165\u3063\u3066\u304a\u3089\u305a\u3001\u3053\u306e\u8a18\u4e8b\u306e\u691c\u8a3c\u306b\u4f7f\u7528\u3057\u305f\u74b0\u5883\u3068\u5168\u304f\u540c\u3058\u74b0\u5883\u306f\u69cb\u7bc9\u3055\u308c\u307e\u305b\u3093\u3002\u8ffd\u8a18\u6642\u70b9\u3067\u306f\u8a18\u4e8b\u306e\u5185\u5bb9\u304c\u5168\u3066\u52d5\u304f\u3053\u3068\u3092\u78ba\u8a8d\u6e08\u307f\u3067\u3059\u3002)\n\n\u672c\u6587\n\n\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u7528\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306e\u4f5c\u6210\n\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u7528\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\u3053\u308c\u4ee5\u964d\u306e\u624b\u9806\u306f\u3053\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u30d9\u30fc\u30b9\u306b\u884c\u3044\u307e\u3059\u3002\n\n\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u7528\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306e\u4f5c\u6210\n$ mkdir ~/ansibletdd\n$ cd ~/ansibletdd\n\n\n\ntest-kitchen\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306bGemfile\u3092\u4f5c\u6210\u3057\u3001bundler\u3092\u4f7f\u3063\u3066test-kitchen\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u307e\u3059\u3002\n\nGemfile\nsource 'https://rubygems.org'\n\ngem 'test-kitchen'\n\n\n\u66f8\u3051\u305f\u3089bundle install\u3057\u307e\u3059\u3002\n\ntest-kitchen\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n$ bundle install\nFetching gem metadata from https://rubygems.org/..........\nFetching version metadata from https://rubygems.org/...\nFetching dependency metadata from https://rubygems.org/..\nResolving dependencies...\nUsing mixlib-shellout 2.2.1\nUsing net-ssh 2.9.2\nUsing net-scp 1.2.1\nUsing safe_yaml 1.0.4\nUsing thor 0.19.1\nUsing test-kitchen 1.4.2\nUsing bundler 1.9.2\nBundle complete! 1 Gemfile dependency, 7 gems now installed.\nUse `bundle show [gemname]` to see where a bundled gem is installed.\n\n\n\ntest-kitchen\u521d\u671f\u5316\nkitchen init\u30b3\u30de\u30f3\u30c9\u3067test-kitchen\u3092\u521d\u671f\u5316\u3057\u307e\u3059\u3002\u3053\u306e\u3068\u304d--driver(\u307e\u305f\u306f-D)\u30aa\u30d7\u30b7\u30e7\u30f3\u3067\u30c9\u30e9\u30a4\u30d0\u3092\u3001--provisioner(\u307e\u305f\u306f-P)\u30aa\u30d7\u30b7\u30e7\u30f3\u3067\u30d7\u30ed\u30d3\u30b8\u30e7\u30ca\u3092\u6307\u5b9a\u3067\u304d\u307e\u3059\u3002\n\u4eca\u56de\u306f\u3001\u30c6\u30b9\u30c8\u3092\u884c\u3046\u74b0\u5883\u306bDocker\u3092\u4f7f\u3046\u306e\u3067\u30c9\u30e9\u30a4\u30d0\u306b\"kitchen-docker\"\u3001\u30d7\u30ed\u30d3\u30b8\u30e7\u30cb\u30f3\u30b0\u306b\u306fAnsible\u3092\u4f7f\u3046\u306e\u3067\u30d7\u30ed\u30d3\u30b8\u30e7\u30ca\u306b\"ansible_playbook\"\u3092\u305d\u308c\u305e\u308c\u6307\u5b9a\u3057\u307e\u3059\u3002\n\ntest-kitchen\u306e\u521d\u671f\u5316\n$ bundle exec kitchen init --driver=kitchen-docker --provisioner=ansible_playbook\n      create  .kitchen.yml\n      create  chefignore\n      create  test/integration/default\n      append  Gemfile\nYou must run `bundle install' to fetch any new gems.\n\n\n\u521d\u671f\u5316\u3092\u884c\u3046\u3068.kitchen.yml\u30d5\u30a1\u30a4\u30eb\u3068\u3044\u304f\u3064\u304b\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u304c\u4f5c\u6210\u3055\u308c\u307e\u3059\u3002\u307e\u305f\u3001Gemfile\u304c\u5909\u66f4\u3055\u308c\u307e\u3059\u3002\n$ cat .kitchen.yml\n---\ndriver:\n  name: docker\n\nprovisioner:\n  name: ansible_playbook\n\nplatforms:\n  - name: ubuntu-14.04\n  - name: centos-7.1\n\nsuites:\n  - name: default\n    run_list:\n    attributes:\n$ \n$ tree\n.\n\u251c\u2500\u2500 Gemfile\n\u251c\u2500\u2500 Gemfile.lock\n\u251c\u2500\u2500 chefignore\n\u2514\u2500\u2500 test\n    \u2514\u2500\u2500 integration\n        \u2514\u2500\u2500 default\n$ \n$ cat Gemfile\nsource 'https://rubygems.org'\n\ngem 'test-kitchen'\ngem \"kitchen-docker\" \n\n\nkitchen-ansible\u3068Serverspec\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\nkitchen init\u306b\u3088\u3063\u3066\u5909\u66f4\u3055\u308c\u305fGemfile\u306bkitchen-ansible\u3068serverspec\u3092\u52a0\u3048\u3001bundler\u3092\u4f7f\u3063\u3066\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u307e\u3059\u3002\n\nGemfile\nsource 'https://rubygems.org'\n\ngem 'test-kitchen'\ngem \"kitchen-docker\"\ngem 'kitchen-ansible'\ngem 'serverspec'\n\n\n\u5909\u66f4\u3057\u305f\u3089\u3001\u3082\u3046\u4e00\u5ea6bundle install\u3057\u307e\u3059\u3002\n\nkitchen-ansible\u3068Serverspec\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n$ bundle install\nResolving dependencies...\nUsing diff-lcs 1.2.5\nUsing multipart-post 2.0.0\nUsing faraday 0.9.2\nUsing highline 1.7.8\nUsing thor 0.19.1\nUsing librarian 0.1.2\nUsing librarian-ansible 1.0.6\nUsing mixlib-shellout 2.2.1\nUsing net-ssh 2.9.2\nUsing net-scp 1.2.1\nUsing safe_yaml 1.0.4\nUsing test-kitchen 1.4.2\nUsing kitchen-ansible 0.0.27\nUsing kitchen-docker 2.3.0\nUsing multi_json 1.11.2\nUsing net-telnet 0.1.1\nUsing rspec-support 3.3.0\nUsing rspec-core 3.3.2\nUsing rspec-expectations 3.3.1\nUsing rspec-mocks 3.3.2\nUsing rspec 3.3.0\nUsing rspec-its 1.2.0\nUsing sfl 2.2\nUsing specinfra 2.43.10\nUsing serverspec 2.24.1\nUsing bundler 1.9.2\nBundle complete! 4 Gemfile dependencies, 26 gems now installed.\nUse `bundle show [gemname]` to see where a bundled gem is installed.\n\n\n\n.kitchen.yml\u306e\u8a2d\u5b9a\nkitchen init\u3067\u4f5c\u6210\u3055\u308c\u305f.kitchen.yml\u3092\u7de8\u96c6\u3057test-kitchen\u306e\u8a2d\u5b9a\u3092\u884c\u3044\u307e\u3059\u3002\n(\u7de8\u96c6\u304c\u7d42\u308f\u3063\u305f.kitchen.yml\u306f\u3053\u306e\u30bb\u30af\u30b7\u30e7\u30f3\u306e\u4e00\u756a\u6700\u5f8c\u306b\u3042\u308a\u307e\u3059\u3002)\n\n\u521d\u671f\u72b6\u614b\u306e.kitchen.yml\n---\ndriver:\n  name: docker\n\nprovisioner:\n  name: ansible_playbook\n\nplatforms:\n  - name: ubuntu-14.04\n  - name: centos-7.1\n\nsuites:\n  - name: default\n    run_list:\n    attributes:\n\n\n\ndriver\ndriver\u306f\u3001\u5909\u66f4\u3059\u308b\u5fc5\u8981\u306f\u3042\u308a\u307e\u305b\u3093\u3002\n\n.kitchen.yml\u306edriver\ndriver:\n  name: docker\n\n\n\nprovisioner\nprovisioner\u306b\u306f\u30d7\u30ed\u30d3\u30b8\u30e7\u30ca\u30fc\u306e\u30aa\u30d7\u30b7\u30e7\u30f3\u3092\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\u306a\u304a\u3001ansible_playbook\u306e\u30aa\u30d7\u30b7\u30e7\u30f3\u306fProvisioner Options\u3082\u53c2\u7167\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\nkitchen.yml\u306eprovisioner\nprovisioner:\n  name: ansible_playbook\n  playbook: site.yml\n  roles_path: ./roles\n  group_vars_path: ./group_vars\n  host_vars_path: ./host_vars\n  filter_plugins: ./filter_plugins\n  additional_copy_path:\n    - webservers.yml\n  hosts: webservers\n  require_ansible_omnibus: true\n  require_ruby_for_busser: true\n\n\n\nplaybook\nmaster playbook(site.yml)\u3092.kitchen.yml\u304b\u3089\u306e\u76f8\u5bfe\u30d1\u30b9\u3067\u8a2d\u5b9a\u3057\u307e\u3059\u3002\nroles_path, group_vars_path, host_vars_path, filter_plugins\n\u305d\u308c\u305e\u308c\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092.kitchen.yml\u304b\u3089\u306e\u76f8\u5bfe\u30d1\u30b9\u3067\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\nadditional_copy_path\n\u4ed6\u306b\u30c6\u30b9\u30c8\u74b0\u5883\u3078\u30b3\u30d4\u30fc\u3059\u308b\u30d5\u30a1\u30a4\u30eb\u30fb\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092.kitchen.yml\u304b\u3089\u306e\u76f8\u5bfe\u30d1\u30b9\u3067\u8a2d\u5b9a\u3057\u307e\u3059\u3002\u3053\u306e\u8a2d\u5b9a\u306f\u914d\u5217\u306a\u306e\u3067\u8907\u6570\u306e\u9805\u76ee\u3092\u8a2d\u5b9a\u3067\u304d\u307e\u3059\u3002\n\u30d9\u30b9\u30c8\u30d7\u30e9\u30af\u30c6\u30a3\u30b9\u69cb\u6210\u3067\u306f\u3001\u30b5\u30fc\u30d0\u30fc\u7fa4(tier)\u3054\u3068\u306ePlay book\u3092\u4f5c\u6210\u3057\u3001site.yml\u3067\u30b5\u30fc\u30d0\u7fa4\u3054\u3068\u306ePlay book\u3092include\u3059\u308b\u3053\u3068\u3067\u3001site.yml\u3092\u30a4\u30f3\u30d5\u30e9\u5168\u4f53\u306e\u5b9a\u7fa9\u3068\u3057\u307e\u3059\u30022 \u3057\u304b\u3057\u3001kitchen-ansible\u306fplaybook\u306b\u8a2d\u5b9a\u3057\u305fyml\u3092\u30c6\u30b9\u30c8\u74b0\u5883\u3078\u30b3\u30d4\u30fc\u3057\u307e\u3059\u304c\u3001\u305d\u306e\u4e2d\u3067include\u3057\u3066\u3044\u308byml\u307e\u3067\u306f\u30b3\u30d4\u30fc\u3057\u3066\u304f\u308c\u307e\u305b\u3093\u3002\u305d\u3053\u3067\u30b5\u30fc\u30d0\u30fc\u7fa4\u5225Play book\u3082\u30c6\u30b9\u30c8\u74b0\u5883\u3078\u30b3\u30d4\u30fc\u3055\u308c\u308b\u3088\u3046additional_copy_path\u306b\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n(roles\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306b\u3042\u308brole\u5225\u306ePlay book\u306froles_path\u306e\u8a2d\u5b9a\u306b\u3088\u3063\u3066\u30b3\u30d4\u30fc\u3055\u308c\u307e\u3059\u3002)\n\u4eca\u56de\u306f\u3001Apache\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u305f\u3044\u306e\u3067\u3001\u30b5\u30fc\u30d0\u30fc\u7fa4Play book\u306fwebservers.yml\u3068\u3044\u3046\u540d\u524d\u3067\u4f5c\u308b\u3053\u3068\u306b\u3057\u3066\u3001\u3068\u308a\u3042\u3048\u305aadditional_copy_path\u306b\u66f8\u3044\u3066\u304a\u304d\u307e\u3059\u3002\n\n\nhosts\nhosts\u30aa\u30d7\u30b7\u30e7\u30f3\u306b\u306f\u30c6\u30b9\u30c8\u74b0\u5883\u304c\u3069\u306e\u30db\u30b9\u30c8\u30b0\u30eb\u30fc\u30d7\u306b\u542b\u307e\u308c\u308b\u30db\u30b9\u30c8\u304b\u3092\u5b9a\u7fa9\u3057\u307e\u3059\u3002\n\u30c6\u30b9\u30c8\u74b0\u5883\u306b\u306fhosts\u306e\u8a2d\u5b9a\u3092\u5143\u306b\u4ee5\u4e0b\u306e\u3088\u3046\u306ainventry\u30d5\u30a1\u30a4\u30eb\u304c\u4f5c\u6210\u3055\u308c\u3001\u30d7\u30ed\u30d3\u30b8\u30e7\u30cb\u30f3\u30b0\u306b\u4f7f\u7528\u3055\u308c\u307e\u3059\u3002\n\n/tmp/kitchen/hosts\nlocalhost ansible_connection=local\n[webservers]  # <= \u3053\u3053\u306bhosts\u30aa\u30d7\u30b7\u30e7\u30f3\u304c\u8a2d\u5b9a\u3055\u308c\u308b\nlocalhost\n\n\n\u4eca\u56de\u306f\u3001\u30db\u30b9\u30c8\u30b0\u30eb\u30fc\u30d7\u3082webservers\u3068\u3044\u3046\u540d\u524d\u3067\u4f5c\u308b\u3053\u3068\u306b\u3057\u3066\u3001\u3068\u308a\u3042\u3048\u305ahosts\u306b\u66f8\u3044\u3066\u304a\u304d\u307e\u3059\u3002\n\n\nrequire_ansible_omnibus\ntrue\u306b\u3059\u308b\u3068\u3001\u30c6\u30b9\u30c8\u74b0\u5883\u3078\u306eAnsible\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3092\u3001ansible_omnibus_url\u30aa\u30d7\u30b7\u30e7\u30f3(\u30c7\u30d5\u30a9\u30eb\u30c8\u306f\u3000https://raw.githubusercontent.com/neillturner/omnibus-ansible/master/ansible_install.sh)\u3067\u5b9a\u7fa9\u3055\u308c\u305f\u30b9\u30af\u30ea\u30d7\u30c8\u3067\u884c\u3044\u307e\u3059\u3002\n(\u3053\u306e\u30aa\u30d7\u30b7\u30e7\u30f3\u306e\u30c7\u30d5\u30a9\u30eb\u30c8\u306ffalse\u3067\u3059\u3002false\u306e\u5834\u5408\u3001\u30c6\u30b9\u30c8\u74b0\u5883\u3078\u306eAnsible\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u306fyum\u307e\u305f\u306fapt\u3067\u884c\u3046\u306e\u3067\u3059\u304c\u3001\u8a18\u4e8b\u57f7\u7b46\u6642\u70b9\u3067\u306fsyntax error\u3068\u306a\u308b\u305f\u3081\u3001\u30aa\u30e0\u30cb\u30d0\u30b9\u30a4\u30f3\u30b9\u30c8\u30fc\u30e9\u30fc\u3092\u4f7f\u7528\u3057\u307e\u3059\u3002)\n\n\nrequire_ruby_for_busser\ntrue\u306e\u5834\u5408\u3001\u30c6\u30b9\u30c8\u74b0\u5883\u3067busser\u306e\u5b9f\u884c\u306b\u4f7f\u7528\u3059\u308bruby\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u307e\u3059\u3002(busser\u306ftest-kitchen\u306e\u30c6\u30b9\u30c8\u30d5\u30ec\u30fc\u30e0\u30ef\u30fc\u30af\u3067\u3059\u3002)\n\u3053\u306e\u30aa\u30d7\u30b7\u30e7\u30f3\u306e\u30c7\u30d5\u30a9\u30eb\u30c8\u306ffalse\u3067\u3001\u305d\u306e\u5834\u5408\u306fChef\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3001\u305d\u308c\u306b\u540c\u68b1\u3055\u308c\u3066\u3044\u308bruby\u3067busser\u3092\u5b9f\u884c\u3057\u307e\u3059\u3002\u4eca\u56de\u306fAnsible\u3092\u4f7f\u3046\u305f\u3081Chef\u306f\u4e0d\u8981\u3001\u305d\u306e\u4e0aruby\u3088\u308a\u3082\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u306b\u6642\u9593\u304c\u304b\u304b\u308b\u306e\u3067true\u306b\u3057\u307e\u3059\u3002\n\n\n\nplatforms\nplatforms\u306b\u306f\u30c6\u30b9\u30c8\u74b0\u5883\u3092\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\n.kitchen.yml\u306eplatforms\nplatforms:\n  - name: ubuntu-14.04\n  - name: centos-7.1\n    driver_config:\n      privileged: true\n      run_command: /sbin/init; sleep 3\n\n\n\u672c\u8a18\u4e8b\u57f7\u7b46\u6642\u70b9\u306ecentos:centos7\u30a4\u30e1\u30fc\u30b8\u3067\u306f\u3001systemctl\u3092\u4f7f\u7528\u3059\u308b\u305f\u3081\u306b\u306f\u7279\u6a29\u30e2\u30fc\u30c9\u304b\u3064\u8d77\u52d5\u30b3\u30de\u30f3\u30c9\u3092/sbin/init\u306b\u3057\u306a\u3051\u308c\u3070\u306a\u3089\u306a\u30443\u306e\u3067\u3001\u305d\u306e\u305f\u3081\u306e\u30aa\u30d7\u30b7\u30e7\u30f3\u3092\u8ffd\u52a0\u3057\u307e\u3059\u3002\n\nverifier\n.kitchen.yml\u306bverifier\u3092\u8ffd\u52a0\u3057\u30c6\u30b9\u30c8\u30c4\u30fc\u30eb\u306e\u30aa\u30d7\u30b7\u30e7\u30f3\u3092\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\n.kitchen.yml\u306everifier\nverifier:\n  ruby_bindir: '/usr/bin'\n\n\nverifier\u306eruby_bindir\u306b\u306f\u30c6\u30b9\u30c8\u30c4\u30fc\u30eb\u306e\u5b9f\u884c\u306b\u4f7f\u7528\u3059\u308bruby\u304c\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3055\u308c\u3066\u3044\u308b\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\u30c7\u30d5\u30a9\u30eb\u30c8\u306f/opt/chef/embedded/bin\u3067\u3001\u3053\u308c\u306fChef\u306b\u540c\u68b1\u3055\u308c\u308bruby\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u6307\u3057\u3066\u3044\u307e\u3059\u3002\n\u4eca\u56de\u306fprovisioner\u8a2d\u5b9a\u3067Chef\u3092\u5165\u308c\u305a\u3001\u4ee3\u308f\u308a\u306bruby\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u305f\u3081\u3001ruby_bindir\u306b\u306f\u305d\u3061\u3089\u306e\u30d1\u30b9\u3092\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\nsuites\nsuites\u306b\u306f\u30c6\u30b9\u30c8\u30b9\u30a4\u30fc\u30c8\u3092\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\nkitchen.yml\u306esuites\nsuites:\n  - name: default\n    attributes:\n\n\nrun_list\u306fkitchen-ansible\u3067\u306f\u4f7f\u7528\u3057\u306a\u3044\u305f\u3081\u6d88\u3057\u3066\u3057\u307e\u3044\u307e\u3059\u3002\nattributes\u306f\u4eca\u56de\u306f\u4f7f\u7528\u3057\u307e\u305b\u3093\u304c\u3001extra_vars\u3084tags\u3092\u8a2d\u5b9a\u3059\u308b\u5834\u5408\u306f\u3053\u3053\u306b\u3076\u3089\u4e0b\u3052\u308b\u306e\u3067\u3001\u6b8b\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\u4ee5\u4e0a\u3067\u3001.kitchen.yml\u306e\u8a2d\u5b9a\u306f\u7d42\u308f\u308a\u3067\u3059\u3002\n\u6700\u7d42\u7684\u306b.kitchen.yml\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\n\n\u7de8\u96c6\u5f8c\u306e.kitchen.yml\n---\ndriver:\n  name: docker\n\nprovisioner:\n  name: ansible_playbook\n  playbook: site.yml\n  roles_path: ./roles\n  group_vars_path: ./group_vars\n  host_vars_path: ./host_vars\n  filter_plugins: ./filter_plugins\n  additional_copy_path:\n    - webservers.yml\n  hosts: webservers\n  require_ansible_omnibus: true\n  require_ruby_for_busser: true\n\nplatforms:\n  - name: ubuntu-14.04\n  - name: centos-7.1\n    driver_config:\n      privileged: true\n      run_command: /sbin/init; sleep 3\n\nverifier:\n  ruby_bindir: '/usr/bin'\n\nsuites:\n  - name: default\n    attributes:\n\n\n.kitchen.yml\u306e\u7de8\u96c6\u304c\u7d42\u308f\u3063\u305f\u3089\u3001kitchen list\u30b3\u30de\u30f3\u30c9\u3092\u53e9\u304f\u3068\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u30c6\u30b9\u30c8\u74b0\u5883\u304c\u8868\u793a\u3055\u308c\u308b\u306f\u305a\u3067\u3059\u3002\n\nkitchen_list\n$ bundle exec kitchen list\nInstance             Driver  Provisioner      Verifier  Transport  Last Action\ndefault-ubuntu-1404  Docker  AnsiblePlaybook  Busser    Ssh        <Not Created>\ndefault-centos-71    Docker  AnsiblePlaybook  Busser    Ssh        <Not Created>\n\n\n\u30c6\u30b9\u30c8\u74b0\u5883\u306f[\u30c6\u30b9\u30c8\u30b9\u30a4\u30fc\u30c8\u540d]-[\u30d7\u30e9\u30c3\u30c8\u30d5\u30a9\u30fc\u30e0\u540d]\u306b\u306a\u308a\u3001platform\u3068suite\u306e\u7d44\u307f\u5408\u308f\u305b\u306b\u306a\u308a\u307e\u3059\u3002\n\nServerspec\u306e\u521d\u671f\u5316\ntest-kitchen\u306e\u30eb\u30fc\u30eb4\u306b\u3057\u305f\u304c\u3063\u3066\u3001test/integration/default\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3078Serverspec\u30d5\u30a1\u30a4\u30eb\u3092\u914d\u7f6e\u3057\u307e\u3059\u3002\n(test/integration/default\u306edefault\u306e\u90e8\u5206\u306f.kitchen.yml\u306esuites\u306ename\u306b\u5bfe\u5fdc\u3057\u307e\u3059\u3002\u30c6\u30b9\u30c8\u30b9\u30a4\u30fc\u30c8\u306e\u540d\u524d\u3092\u5909\u66f4\u3057\u3066\u3044\u308b\u5834\u5408\u306fServerspec\u3092\u914d\u7f6e\u3059\u308b\u30d1\u30b9\u3082\u5909\u66f4\u3057\u306a\u3051\u308c\u3070\u306a\u308a\u307e\u305b\u3093\u3002)\n\nServerspec\u521d\u671f\u5316\n$ cd test/integration/default\n$ bundle exec serverspec-init\nSelect OS type:\n\n  1) UN*X\n  2) Windows\n\nSelect number: 1\n\nSelect a backend type:\n\n  1) SSH\n  2) Exec (local)\n\nSelect number: 2\n\n + spec/\n + spec/localhost/\n + spec/localhost/sample_spec.rb\n + spec/spec_helper.rb\n + Rakefile\n\n\nServerspec\u306e\u521d\u671f\u5316\u306b\u3088\u3063\u3066\u4f5c\u6210\u3055\u308c\u305fspec\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092serverspec\u3078\u30ea\u30cd\u30fc\u30e0\u3057\u307e\u3059\u3002\n\u3053\u308c\u306f\u3001test-kitchen\u304c\u30c6\u30b9\u30c8\u74b0\u5883\u3078\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u30c6\u30b9\u30c8\u30e9\u30f3\u30ca\u30fc(busser)\u306e\u30d7\u30e9\u30b0\u30a4\u30f3\u3092\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u540d\u304b\u3089\u6c7a\u3081\u308b\u305f\u3081\u3067\u3059\u3002\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u540d\u3092\u5909\u66f4\u3057\u306a\u3044\u5834\u5408busser-spec\u3068\u3044\u3046\u5b58\u5728\u3057\u306a\u3044\u30d7\u30e9\u30b0\u30a4\u30f3\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3088\u3046\u3068\u3057\u3066\u30a8\u30e9\u30fc\u306b\u306a\u308a\u307e\u3059\u3002)\n$ mv spec/ serverspec/\n\nServerspec\u306e\u521d\u671f\u5316\u3092\u884c\u3046\u3068\u3001\u30b5\u30f3\u30d7\u30eb\u306espec\u30d5\u30a1\u30a4\u30eb\u304c\u4f5c\u6210\u3055\u308c\u307e\u3059\u3002\n\u4e2d\u8eab\u306f\u4ee5\u4e0b\u306e\u3068\u304a\u308a\u3067\u3001\u4eca\u56de\u4f5c\u6210\u3057\u305f\u3044Ansible play book\u306b\u3061\u3087\u3046\u3069\u826f\u3044\u306e\u3067\u540d\u524d\u3060\u3051\u5909\u66f4\u3057\u3066\u4e2d\u8eab\u306f\u305d\u306e\u307e\u307e\u4f7f\u3044\u307e\u3059\u3002\n\nsample_spec.rb\u306e\u30ea\u30cd\u30fc\u30e0\nmv test/integration/default/serverspec/localhost/sample_spec.rb test/integration/default/serverspec/localhost/webservers_spec.rb\n\n\n\ntest/integration/default/serverspec/localhost/webservers_spec.rb\nrequire 'spec_helper'\n\ndescribe package('httpd'), :if => os[:family] == 'redhat' do\n  it { should be_installed }\nend\n\ndescribe package('apache2'), :if => os[:family] == 'ubuntu' do\n  it { should be_installed }\nend\n\ndescribe service('httpd'), :if => os[:family] == 'redhat' do\n  it { should be_enabled }\n  it { should be_running }\nend\n\ndescribe service('apache2'), :if => os[:family] == 'ubuntu' do\n  it { should be_enabled }\n  it { should be_running }\nend\n\ndescribe service('org.apache.httpd'), :if => os[:family] == 'darwin' do\n  it { should be_enabled }\n  it { should be_running }\nend\n\ndescribe port(80) do\n  it { should be_listening }\nend\n\n\n\u30ea\u30cd\u30fc\u30e0\u3057\u305fserverspec\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306bGemfile\u3092\u8ffd\u52a0\u3057\u307e\u3059\u3002\n\ntest/integration/default/serverspec/Gemfile\nsource 'https://rubygems.org'\n\ngem 'rake'\ngem 'serverspec'\n\n\n\u53c2\u8003:Rake dependency missing for older rubies \u00b7 Issue #28\n\n\u4eee\u306esite.yml\u4f5c\u6210\n\u4ee5\u4e0a\u3067TDD\u306e\u6e96\u5099\u304c\u51fa\u6765\u307e\u3057\u305f\u3002\u3068\u3001\u8a00\u3044\u305f\u3044\u3068\u3053\u308d\u3067\u3059\u304c\u3001\u3053\u306e\u72b6\u614b\u3067kitchen test\u30b3\u30de\u30f3\u30c9\u3092\u53e9\u304f\u3068\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3057\u307e\u3059\u3002\n\nkitche_test\n$ cd ~/ansibletdd\n$ bundle exec kitchen test\n-----> Starting Kitchen (v1.4.2)\n-----> Cleaning up any prior instances of <default-ubuntu-1404>\n\n~~~\u4e2d\u7565~~~\n\nPreparing playbook\n>>>>>> ------Exception-------\n>>>>>> Class: Kitchen::ActionFailed\n>>>>>> Message: Failed to complete #converge action: [unknown file type: site.yml]\n>>>>>> ----------------------\n>>>>>> Please see .kitchen/logs/kitchen.log for more details\n>>>>>> Also try running `kitchen diagnose --all` for configuration\n\n\n\u3068\u308a\u3042\u3048\u305a\u30a8\u30e9\u30fc\u3092\u89e3\u6d88\u3059\u308b\u305f\u3081\u4eee\u306esite.yml\u3068webservers.yml\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\nsite.yml\n---\n- include: webservers.yml\n\n\n\nwebservers.yml\n---\n- hosts: webservers\n  tasks:\n\n\n\u4f5c\u6210\u3057\u305f\u3089\u3082\u3046\u4e00\u5ea6kitchen test\u3092\u884c\u3044\u307e\u3059\u3002\n\nkitchen_test\n$ bundle exec kitchen test\n-----> Starting Kitchen (v1.4.2)\n-----> Cleaning up any prior instances of <default-ubuntu-1404>\n\n~~~ \u4e2d\u7565 ~~~\n\n       Finished in 0.27052 seconds (files took 0.46124 seconds to load)\n       4 examples, 4 failures\n\n       Failed examples:\n\n       rspec /tmp/verifier/suites/serverspec/localhost/webservers_spec.rb:8 # Package \"apache2\" should be installed\n       rspec /tmp/verifier/suites/serverspec/localhost/webservers_spec.rb:17 # Service \"apache2\" should be enabled\n       rspec /tmp/verifier/suites/serverspec/localhost/webservers_spec.rb:18 # Service \"apache2\" should be running\n       rspec /tmp/verifier/suites/serverspec/localhost/webservers_spec.rb:27 # Port \"80\" should be listening\n\n~~~ \u5f8c\u7565 ~~~\n\n\n\u4eca\u5ea6\u306f\u3001default-ubuntu-1404\u3067Serverspec\u306b\u3088\u308b\u691c\u8a3c\u307e\u3067\u884c\u308f\u308c\u3001\u5168\u3066fail\u3057\u307e\u3057\u305f\u3002\n(test-kitchen\u306f\u30c6\u30b9\u30c8\u304c\u5931\u6557\u3059\u308b\u3068\u305d\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3067\u30c6\u30b9\u30c8\u3092\u3084\u3081\u3066\u3057\u307e\u3046\u306e\u3067\u3001\u305d\u308c\u4ee5\u964d\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3067\u30c6\u30b9\u30c8\u3092\u884c\u3044\u305f\u3044\u5834\u5408\u306f\u3001bundle exec kitchen test default-centos-71\u306e\u3088\u3046\u306b\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u540d\u3092\u6307\u5b9a\u3057\u307e\u3059\u3002\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u540d\u306f\u6b63\u898f\u8868\u73fe\u3067\u3082\u6307\u5b9a\u3067\u304d\u308b\u306e\u3067\u3001\u6761\u4ef6\u306b\u5408\u3046\u8907\u6570\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u30c6\u30b9\u30c8\u3059\u308b\u3053\u3068\u3082\u51fa\u6765\u307e\u3059\u3002)\n\u3053\u308c\u3067\u3088\u3046\u3084\u304fTDD\u306e\u6e96\u5099\u304c\u51fa\u6765\u307e\u3057\u305f\u3002\n\u3042\u3068\u306f\u3001\u5168\u3066\u306e\u30c6\u30b9\u30c8\u304c\u6210\u529f\u3059\u308b\u3088\u3046\u3001\u300c\u66f8\u304f -> \u30c6\u30b9\u30c8\u300d\u3092\u7e70\u308a\u8fd4\u3057\u306a\u304c\u3089Ansible playbook\u3092\u66f8\u3044\u3066\u3044\u3051\u3070OK\u3067\u3059\u3002\n\nAnsible playbook\u306e\u5b9f\u88c5\nTDD\u74b0\u5883\u304c\u51fa\u6765\u305f\u306e\u3067\u3001\u3042\u3068\u306fPlay book\u3092\u5b9f\u88c5\u3057\u3066\u3044\u304f\u3060\u3051\u3067\u3059\u3002\n\u66f8\u304d\u65b9\u306e\u8a73\u7d30\u306f\u672c\u8a18\u4e8b\u306e\u8da3\u65e8\u304b\u3089\u5916\u308c\u308b\u306e\u3067Google\u5148\u751f\u306b\u805e\u3044\u3066\u3082\u3089\u3046\u3068\u3057\u3066\u3001\u3068\u308a\u3042\u3048\u305a\u5168\u3066\u306e\u30c6\u30b9\u30c8\u304c\u901a\u308bPlay book\u3092\u7f6e\u3044\u3066\u304a\u304d\u307e\u3059\u3002\n\nsite.yml\n---\n- include: webservers.yml\n\n\n\nwebservers.yml\n---\n- hosts: webservers\n  roles:\n    - apache\n\n\n\nroles/apache/tasks/main.yml\n- apt: pkg=apache2\n  when: \"ansible_os_family == 'Debian'\"\n\n- yum: pkg=httpd\n  when: \"ansible_os_family == 'RedHat'\"\n\n- service: name=apache2 state=started enabled=yes\n  when: \"ansible_os_family == 'Debian'\"\n\n- service: name=httpd state=started enabled=yes\n  when: \"ansible_os_family == 'RedHat'\"\n\n\n\u3053\u308c\u3067\u3001kitchen test\u3059\u308c\u3070\u5168\u3066\u306e\u30c6\u30b9\u30c8\u304c\u6210\u529f\u3059\u308b\u306f\u305a\u3067\u3059\u3002\n\nkitchen_test\n$ bundle exec kitchen test\n-----> Starting Kitchen (v1.4.2)\n-----> Cleaning up any prior instances of <default-ubuntu-1404>\n\n~~~ \u4e2d\u7565 ~~~\n\n       Package \"apache2\"\n         should be installed\n\n       Service \"apache2\"\n         should be enabled\n         should be running\n\n       Port \"80\"\n         should be listening\n\n       Finished in 0.1665 seconds (files took 1.22 seconds to load)\n       4 examples, 0 failures\n\n       Finished verifying <default-ubuntu-1404> (0m28.28s).\n\n~~~ \u4e2d\u7565 ~~~\n\n       Package \"httpd\"\n         should be installed\n\n       Service \"httpd\"\n         should be enabled\n         should be running\n\n       Port \"80\"\n         should be listening\n\n       Finished in 0.16315 seconds (files took 1.07 seconds to load)\n       4 examples, 0 failures\n\n       Finished verifying <default-centos-71> (0m24.25s).\n\n~~~\u3000\u5f8c\u7565 ~~~\n\n\n\n\u307e\u3068\u3081\nAnsible\u3092TDD\u3059\u308b\u305f\u3081\u306e\u74b0\u5883\u69cb\u7bc9\u306e\u4e00\u9023\u306e\u624b\u9806\u3092\u8ffd\u3044\u304b\u3051\u307e\u3057\u305f\u3002\ntest-kitchen\u3092\u4f7f\u3063\u3066\u30c8\u30e9\u30a4&\u30a8\u30e9\u30fc\u3092\u7c21\u5358\u306b\u884c\u3048\u308bTDD\u74b0\u5883\u3092\u7528\u610f\u3059\u308b\u3068Ansible(\u3084Chef)\u306e\u958b\u767a\u3092\u30b5\u30af\u30b5\u30af\u9032\u3081\u3089\u308c\u308b\u7528\u306b\u306a\u308a\u307e\u3059\u304c\u3001\u30c7\u30d5\u30a9\u30eb\u30c8\u8a2d\u5b9a\u3067\u306f\u52d5\u304b\u306a\u3044\u7b87\u6240\u306a\u3069\u30cf\u30de\u308a\u3069\u3053\u308d\u304c\u3044\u304f\u3064\u304b\u3042\u308b\u306e\u3067\u6ce8\u610f\u304c\u5fc5\u8981\u3067\u3059\u3002\u30cf\u30de\u3063\u305f\u5834\u5408\u306f\u30ed\u30b0\u3068\u95a2\u9023\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u3092\u8aad\u3093\u3067\u9811\u5f35\u308a\u307e\u3057\u3087\u3046\u3002\n\nappendix\n\nDocker image\u3092\u6307\u5b9a\u3057\u305f\u3044\u5834\u5408\nkitchen-docer\u306fKitchen::Driver::Docker.default_image\u306b\u3088\u3063\u3066platform.name\u304b\u3089\u30c6\u30b9\u30c8\u74b0\u5883\u306e\u30d9\u30fc\u30b9\u30a4\u30e1\u30fc\u30b8\u306e\u30bf\u30b0\u3092\u751f\u6210\u3057\u307e\u3059\u304c\u3001\u4efb\u610f\u306e\u30bf\u30b0\u3092\u6307\u5b9a\u3059\u308b\u3053\u3068\u3082\u51fa\u6765\u307e\u3059\u3002\n\u305d\u306e\u5834\u5408\u306f\u3001.kitchen.yml\u3092\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u5909\u66f4\u3057\u307e\u3059\u3002\n\nyaml.kitchen.yml\nplatforms:\n  - name: ubuntu-14.04\n    driver_config:         # <= \u8ffd\u52a0\n      image: ubuntu:14.04  # <= \u8ffd\u52a0\n  - name: centos-7\n    driver_config:\n       image: centos:centos7 # <= \u8ffd\u52a0\n       privileged: true\n       run_command: /sbin/init; sleep 3\n\n\n\n\u8907\u6570\u306e\u30db\u30b9\u30c8\u30b0\u30eb\u30fc\u30d7\u306b\u5bfe\u5fdc\u3057\u305f\u3044\u5834\u5408\nPlay book\u306b\u30db\u30b9\u30c8\u30b0\u30eb\u30fc\u30d7(\u4f8b\u3048\u3070\u3001apservers)\u3092\u8ffd\u52a0\u5b9a\u7fa9\u3057\u305f\u3044\u5834\u5408\u306f\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u3057\u307e\u3059\u3002\n\u30c6\u30b9\u30c8\u30b9\u30a4\u30fc\u30c8\u3067\u306fprovisioner\u306e\u30aa\u30d7\u30b7\u30e7\u30f3\u3092\u4e0a\u66f8\u304d\u3067\u304d\u308b\u306e\u3067\u3001\u30c6\u30b9\u30c8\u30b9\u30a4\u30fc\u30c8\u3092\u5897\u3084\u3057\u3001\u30b9\u30a4\u30fc\u30c8\u3054\u3068\u306b\u30db\u30b9\u30c8\u30b0\u30eb\u30fc\u30d7\u30aa\u30d7\u30b7\u30e7\u30f3\u3092\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\nyaml.kitchen.yml\u306esuites\nsuites:\n  - name: webservers    # <= default\u304b\u3089\u5909\u66f4\n    provisioner:        # <= \u8ffd\u52a0\n      hosts: webservers # <= \u8ffd\u52a0\n  - name: apservers     # <= \u8ffd\u52a0\n    provisioner:        # <= \u8ffd\u52a0\n      hosts: apservers  # <= \u8ffd\u52a0\n\n\n\u6b21\u306b\u30b9\u30a4\u30fc\u30c8\u3054\u3068\u306eServerspec\u3092\u7528\u610f\u3057\u307e\u3059\u3002\n\u73fe\u5728\u306etest\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u72b6\u614b\u3067\u3059\u3002\n$ tree\ntest\n\u2514\u2500\u2500 integration\n    \u2514\u2500\u2500 default\n        \u251c\u2500\u2500 Rakefile\n        \u2514\u2500\u2500 serverspec\n            \u251c\u2500\u2500 Gemfile\n            \u251c\u2500\u2500 localhost\n            \u2502\u00a0\u00a0 \u2514\u2500\u2500 webservers_spec.rb\n            \u2514\u2500\u2500 spec_helper.rb\n\n\u3053\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306b\u4ee5\u4e0b\u306e\u64cd\u4f5c\u3092\u884c\u3044\u307e\u3059\u3002\n\ndefault\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306f\u30c6\u30b9\u30c8\u30b9\u30a4\u30fc\u30c8\u540d\u306a\u306e\u3067\u3053\u308c\u306fwebservers\u306b\u5909\u66f4\u3057\u307e\u3059\nRakefile, Gemfile, spec_helper.rb\u306f\u8907\u6570\u306e\u30c6\u30b9\u30c8\u30b9\u30a4\u30fc\u30c8\u3067\u5171\u901a\u306a\u306e\u3067\u3001helpers\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u4f5c\u308a\u305d\u3053\u3078\u79fb\u52d5\u3057\u307e\u3059\nwebservers\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u30b3\u30d4\u30fc\u3057apservers\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3068\u3057\u307e\u3059\n\u30b3\u30d4\u30fc\u3057\u305f\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306ewebservers_spec.rb\u3092apservers_spec.rb\u306b\u30ea\u30cd\u30fc\u30e0\u3057\u307e\u3059\u3002\n\n$ mv test/integration/default/ test/integration/webservers\n$ mkdir -p test/integration/helpers/serverspec\n$ cd test/integration\n$ mv webservers/Rakefile helpers/\n$ mv webservers/serverspec/Gemfile helpers/serverspec/\n$ mv webservers/serverspec/spec_helper.rb helpers/serverspec/\n$ cp -r webservers/ apservers\n$ mv apservers/serverspec/localhost/webservers_spec.rb apservers/serverspec/localhost/apservers_spec.rb\n$ tree test\ntest\n\u2514\u2500\u2500 integration\n    \u251c\u2500\u2500 apservers\n    \u2502\u00a0\u00a0 \u2514\u2500\u2500 serverspec\n    \u2502\u00a0\u00a0     \u2514\u2500\u2500 localhost\n    \u2502\u00a0\u00a0         \u2514\u2500\u2500 apservers_spec.rb\n    \u251c\u2500\u2500 helpers\n    \u2502\u00a0\u00a0 \u251c\u2500\u2500 Rakefile\n    \u2502\u00a0\u00a0 \u2514\u2500\u2500 serverspec\n    \u2502\u00a0\u00a0     \u251c\u2500\u2500 Gemfile\n    \u2502\u00a0\u00a0     \u2514\u2500\u2500 spec_helper.rb\n    \u2514\u2500\u2500 webservers\n        \u2514\u2500\u2500 serverspec\n            \u2514\u2500\u2500 localhost\n                \u2514\u2500\u2500 webservers_spec.rb\n\n\u4ee5\u4e0a\u3067\u5171\u901a\u306e\u30d5\u30a1\u30a4\u30eb\u3092helpers\u3078\u79fb\u52d5\u3057\u3001\u5404\u30c6\u30b9\u30c8\u30b9\u30a4\u30fc\u30c8\u306b\u5fc5\u8981\u306a\u30d5\u30a1\u30a4\u30eb\u30fb\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u7528\u610f\u3067\u304d\u307e\u3057\u305f\u3002\u3042\u3068\u306fapservers_spec.rb\u30d5\u30a1\u30a4\u30eb\u3092apservers\u30b0\u30eb\u30fc\u30d7\u306b\u9069\u3057\u305f\u5f62\u306b\u66f8\u304d\u63db\u3048\u308c\u3070\u5b8c\u4e86\u3067\u3059\u3002\n\n\u53c2\u8003\u8cc7\u6599\n\nAnsible\u306e\u30c6\u30b9\u30c8\u3092test-kitchen\u3068Serverspec\u3001docker\u3067\u884c\u3046 - Qiita\nChef & Test Kitchen+Serverspec & Docker & Packer\u306b\u3088\u308bInfrastructure as Code\u4e8b\u59cb\u3081 - Qiita\ntest-kitchen\u306e\u3064\u304b\u3044\u304b\u305f - Qiita\nIntroduction - KitchenCI\nKitchen \u2014 Chef Docs\nBest Practices \u2014 Ansible Documentation\nneillturner/kitchen-ansible\nportertech/kitchen-docker\ntest-kitchen/busser\ntest-kitchen/busser-serverspec\n\n\n\n\n\nBest Practices \u2014 Ansible Documentation\u00a0\u21a9\n\n\nBest Practices \u2014 Ansible Documentation#top-level-playbooks-are-separated-by-role\u00a0\u21a9\n\n\nChef & Test Kitchen+Serverspec & Docker & Packer\u306b\u3088\u308bInfrastructure as Code\u4e8b\u59cb\u3081 - Qiita\u00a0\u21a9\n\n\nWriting a Test - KitchenCI\u00a0\u21a9\n\n\n\n\u3053\u308c\u306ftest-kitchen, serverspec, Docker\u3092\u3064\u304b\u3063\u3066Ansible\u306e\u30c6\u30b9\u30c8\u99c6\u52d5\u958b\u767a\u3092\u884c\u3046\u74b0\u5883\u3092\u69cb\u7bc9\u3059\u308b\u624b\u9806\u3067\u3059\u3002\nUbuntu14,CentOS7\u3067Apache2\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3001\u30b5\u30fc\u30d3\u30b9\u3092\u8d77\u52d5\u3057\u3001\u30d6\u30fc\u30c8\u6642\u306e\u30b5\u30fc\u30d3\u30b9\u81ea\u52d5\u8d77\u52d5\u3092\u8a2d\u5b9a\u3059\u308b\u30d9\u30b9\u30c8\u30d7\u30e9\u30af\u30c6\u30a3\u30b9\u69cb\u6210[^1]\u306eAnsible playbook\u3092\u4f8b\u3068\u3057\u3066\u53d6\u308a\u3042\u3052\u307e\u3059\u3002\n\n# \u3053\u306e\u8a18\u4e8b\u306e\u76ee\u6a19\n\nAnsible\u306eTDD\u74b0\u5883\u3068\u3057\u3066\u3001test-kitchen\u3067\u6b21\u306e\u3053\u3068\u304c\u51fa\u6765\u308b\u74b0\u5883\u3092\u4f5c\u308a\u307e\u3059\u3002\n\n - Docker\u4e0a\u306bUbuntu14, CentOS7\u306e\u30b3\u30f3\u30c6\u30ca\u3092\u7acb\u3061\u4e0a\u3052\n - \u5404\u30b3\u30f3\u30c6\u30ca\u3092Ansible\u3067\u30d7\u30ed\u30d3\u30b8\u30e7\u30cb\u30f3\u30b0\n - \u5404\u30b3\u30f3\u30c6\u30ca\u306e\u30d7\u30ed\u30d3\u30b8\u30e7\u30cb\u30f3\u30b0\u7d50\u679c\u3092Serverspec\u3067\u691c\u8a3c\n\n# \u524d\u63d0\u6761\u4ef6\u7b49\n\n\u3053\u306e\u8a18\u4e8b\u306e\u524d\u63d0\u6761\u4ef6\u306f\u4ee5\u4e0b\u306e\u3068\u304a\u308a\u3067\u3059\u3002\n\n- \u4f5c\u6210\u3059\u308bAnsible playbook\u306e\u69cb\u6210\u306f\u30d9\u30b9\u30c8\u30d7\u30e9\u30af\u30c6\u30a3\u30b9\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u30ec\u30a4\u30a2\u30a6\u30c8\u306b\u5f93\u3046[^1]\u3000\n- \u4f5c\u696d\u74b0\u5883\u306f\n  - CentOS6.7(x86_64)\n  - Ruby\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u6e08\u307f\u306e\u3053\u3068\n  - bundler\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u6e08\u307f\u306e\u3053\u3068\n  - Docker\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u6e08\u307f\u306e\u3053\u3068\n\n\u306a\u304a\u3001\u3053\u306e\u8a18\u4e8b\u306e\u691c\u8a3c\u306b\u4f7f\u7528\u3057\u305f\u74b0\u5883\u306f\u4ee5\u4e0b\u306e\u3068\u304a\u308a\u3067\u3059\u3002\n\n```bash:\u3053\u306e\u8a18\u4e8b\u306e\u691c\u8a3c\u306b\u4f7f\u7528\u3057\u305f\u74b0\u5883\n$ cat /etc/redhat-release\nCentOS release 6.7 (Final)\n$ arch\nx86_64\n$ ruby -v\nruby 2.1.5p273 (2014-11-13 revision 48405) [x86_64-linux]\n$ bundler -v\nBundler version 1.9.2\n$ docker -v\nDocker version 1.7.1, build 786b29d\n```\n\n(2015-12-04\u8ffd\u8a18)\n\u74b0\u5883\u69cb\u7bc9\u7528\u306eVagrantfile\u3092\u4f5c\u308a\u307e\u3057\u305f\u3002\nhttps://github.com/takasix/vagrant_kitchen_ansible\n\n(\u5143\u3005\u5225\u306e\u7528\u304c\u3042\u3063\u3066\u4f5c\u3063\u305f\u3082\u306e\u306a\u306e\u3067\u3001\u30d0\u30fc\u30b8\u30e7\u30f3\u6307\u5b9a\u304c\u5165\u3063\u3066\u304a\u3089\u305a\u3001\u3053\u306e\u8a18\u4e8b\u306e\u691c\u8a3c\u306b\u4f7f\u7528\u3057\u305f\u74b0\u5883\u3068\u5168\u304f\u540c\u3058\u74b0\u5883\u306f\u69cb\u7bc9\u3055\u308c\u307e\u305b\u3093\u3002\u8ffd\u8a18\u6642\u70b9\u3067\u306f\u8a18\u4e8b\u306e\u5185\u5bb9\u304c\u5168\u3066\u52d5\u304f\u3053\u3068\u3092\u78ba\u8a8d\u6e08\u307f\u3067\u3059\u3002)\n\n\n# \u672c\u6587\n\n## \u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u7528\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306e\u4f5c\u6210\n\n\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u7528\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\u3053\u308c\u4ee5\u964d\u306e\u624b\u9806\u306f\u3053\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u30d9\u30fc\u30b9\u306b\u884c\u3044\u307e\u3059\u3002\n\n```bash:\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u7528\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306e\u4f5c\u6210\n$ mkdir ~/ansibletdd\n$ cd ~/ansibletdd\n```\n\n## test-kitchen\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306bGemfile\u3092\u4f5c\u6210\u3057\u3001bundler\u3092\u4f7f\u3063\u3066test-kitchen\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u307e\u3059\u3002\n\n```rb:Gemfile\nsource 'https://rubygems.org'\n\ngem 'test-kitchen'\n```\n\n\u66f8\u3051\u305f\u3089bundle install\u3057\u307e\u3059\u3002\n\n```bash:test-kitchen\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n$ bundle install\nFetching gem metadata from https://rubygems.org/..........\nFetching version metadata from https://rubygems.org/...\nFetching dependency metadata from https://rubygems.org/..\nResolving dependencies...\nUsing mixlib-shellout 2.2.1\nUsing net-ssh 2.9.2\nUsing net-scp 1.2.1\nUsing safe_yaml 1.0.4\nUsing thor 0.19.1\nUsing test-kitchen 1.4.2\nUsing bundler 1.9.2\nBundle complete! 1 Gemfile dependency, 7 gems now installed.\nUse `bundle show [gemname]` to see where a bundled gem is installed.\n```\n\n## test-kitchen\u521d\u671f\u5316\n\n`kitchen init`\u30b3\u30de\u30f3\u30c9\u3067test-kitchen\u3092\u521d\u671f\u5316\u3057\u307e\u3059\u3002\u3053\u306e\u3068\u304d--driver(\u307e\u305f\u306f-D)\u30aa\u30d7\u30b7\u30e7\u30f3\u3067\u30c9\u30e9\u30a4\u30d0\u3092\u3001--provisioner(\u307e\u305f\u306f-P)\u30aa\u30d7\u30b7\u30e7\u30f3\u3067\u30d7\u30ed\u30d3\u30b8\u30e7\u30ca\u3092\u6307\u5b9a\u3067\u304d\u307e\u3059\u3002\n\u4eca\u56de\u306f\u3001\u30c6\u30b9\u30c8\u3092\u884c\u3046\u74b0\u5883\u306bDocker\u3092\u4f7f\u3046\u306e\u3067\u30c9\u30e9\u30a4\u30d0\u306b\"kitchen-docker\"\u3001\u30d7\u30ed\u30d3\u30b8\u30e7\u30cb\u30f3\u30b0\u306b\u306fAnsible\u3092\u4f7f\u3046\u306e\u3067\u30d7\u30ed\u30d3\u30b8\u30e7\u30ca\u306b\"ansible_playbook\"\u3092\u305d\u308c\u305e\u308c\u6307\u5b9a\u3057\u307e\u3059\u3002\n\n```bash:test-kitchen\u306e\u521d\u671f\u5316\n$ bundle exec kitchen init --driver=kitchen-docker --provisioner=ansible_playbook\n      create  .kitchen.yml\n      create  chefignore\n      create  test/integration/default\n      append  Gemfile\nYou must run `bundle install' to fetch any new gems.\n```\n\n\u521d\u671f\u5316\u3092\u884c\u3046\u3068.kitchen.yml\u30d5\u30a1\u30a4\u30eb\u3068\u3044\u304f\u3064\u304b\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u304c\u4f5c\u6210\u3055\u308c\u307e\u3059\u3002\u307e\u305f\u3001Gemfile\u304c\u5909\u66f4\u3055\u308c\u307e\u3059\u3002\n\n```bash\n$ cat .kitchen.yml\n---\ndriver:\n  name: docker\n\nprovisioner:\n  name: ansible_playbook\n\nplatforms:\n  - name: ubuntu-14.04\n  - name: centos-7.1\n\nsuites:\n  - name: default\n    run_list:\n    attributes:\n$ \n$ tree\n.\n\u251c\u2500\u2500 Gemfile\n\u251c\u2500\u2500 Gemfile.lock\n\u251c\u2500\u2500 chefignore\n\u2514\u2500\u2500 test\n    \u2514\u2500\u2500 integration\n        \u2514\u2500\u2500 default\n$ \n$ cat Gemfile\nsource 'https://rubygems.org'\n\ngem 'test-kitchen'\ngem \"kitchen-docker\" \n```\n\n## kitchen-ansible\u3068Serverspec\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n`kitchen init`\u306b\u3088\u3063\u3066\u5909\u66f4\u3055\u308c\u305fGemfile\u306bkitchen-ansible\u3068serverspec\u3092\u52a0\u3048\u3001bundler\u3092\u4f7f\u3063\u3066\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u307e\u3059\u3002\n\n```rb:Gemfile\nsource 'https://rubygems.org'\n\ngem 'test-kitchen'\ngem \"kitchen-docker\"\ngem 'kitchen-ansible'\ngem 'serverspec'\n```\n\n\u5909\u66f4\u3057\u305f\u3089\u3001\u3082\u3046\u4e00\u5ea6`bundle install`\u3057\u307e\u3059\u3002\n\n```bash:kitchen-ansible\u3068Serverspec\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n$ bundle install\nResolving dependencies...\nUsing diff-lcs 1.2.5\nUsing multipart-post 2.0.0\nUsing faraday 0.9.2\nUsing highline 1.7.8\nUsing thor 0.19.1\nUsing librarian 0.1.2\nUsing librarian-ansible 1.0.6\nUsing mixlib-shellout 2.2.1\nUsing net-ssh 2.9.2\nUsing net-scp 1.2.1\nUsing safe_yaml 1.0.4\nUsing test-kitchen 1.4.2\nUsing kitchen-ansible 0.0.27\nUsing kitchen-docker 2.3.0\nUsing multi_json 1.11.2\nUsing net-telnet 0.1.1\nUsing rspec-support 3.3.0\nUsing rspec-core 3.3.2\nUsing rspec-expectations 3.3.1\nUsing rspec-mocks 3.3.2\nUsing rspec 3.3.0\nUsing rspec-its 1.2.0\nUsing sfl 2.2\nUsing specinfra 2.43.10\nUsing serverspec 2.24.1\nUsing bundler 1.9.2\nBundle complete! 4 Gemfile dependencies, 26 gems now installed.\nUse `bundle show [gemname]` to see where a bundled gem is installed.\n```\n\n## .kitchen.yml\u306e\u8a2d\u5b9a\n\n`kitchen init`\u3067\u4f5c\u6210\u3055\u308c\u305f.kitchen.yml\u3092\u7de8\u96c6\u3057test-kitchen\u306e\u8a2d\u5b9a\u3092\u884c\u3044\u307e\u3059\u3002\n(\u7de8\u96c6\u304c\u7d42\u308f\u3063\u305f.kitchen.yml\u306f\u3053\u306e\u30bb\u30af\u30b7\u30e7\u30f3\u306e\u4e00\u756a\u6700\u5f8c\u306b\u3042\u308a\u307e\u3059\u3002)\n\n```yaml:\u521d\u671f\u72b6\u614b\u306e.kitchen.yml\n---\ndriver:\n  name: docker\n\nprovisioner:\n  name: ansible_playbook\n\nplatforms:\n  - name: ubuntu-14.04\n  - name: centos-7.1\n\nsuites:\n  - name: default\n    run_list:\n    attributes:\n```\n\n### driver\n\ndriver\u306f\u3001\u5909\u66f4\u3059\u308b\u5fc5\u8981\u306f\u3042\u308a\u307e\u305b\u3093\u3002\n\n```yaml:.kitchen.yml\u306edriver\ndriver:\n  name: docker\n```\n\n### provisioner\n\nprovisioner\u306b\u306f\u30d7\u30ed\u30d3\u30b8\u30e7\u30ca\u30fc\u306e\u30aa\u30d7\u30b7\u30e7\u30f3\u3092\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\u306a\u304a\u3001ansible_playbook\u306e\u30aa\u30d7\u30b7\u30e7\u30f3\u306f[Provisioner Options](https://github.com/neillturner/kitchen-ansible/blob/master/provisioner_options.md)\u3082\u53c2\u7167\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n```.kitchen.yml\u306eprovisioner\nprovisioner:\n  name: ansible_playbook\n  playbook: site.yml\n  roles_path: ./roles\n  group_vars_path: ./group_vars\n  host_vars_path: ./host_vars\n  filter_plugins: ./filter_plugins\n  additional_copy_path:\n    - webservers.yml\n  hosts: webservers\n  require_ansible_omnibus: true\n  require_ruby_for_busser: true\n```\n\n1. playbook\n    master playbook(site.yml)\u3092.kitchen.yml\u304b\u3089\u306e\u76f8\u5bfe\u30d1\u30b9\u3067\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\n1. roles_path, group_vars_path, host_vars_path, filter_plugins\n    \u305d\u308c\u305e\u308c\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092.kitchen.yml\u304b\u3089\u306e\u76f8\u5bfe\u30d1\u30b9\u3067\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\n1. additional_copy_path\n    \u4ed6\u306b\u30c6\u30b9\u30c8\u74b0\u5883\u3078\u30b3\u30d4\u30fc\u3059\u308b\u30d5\u30a1\u30a4\u30eb\u30fb\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092.kitchen.yml\u304b\u3089\u306e\u76f8\u5bfe\u30d1\u30b9\u3067\u8a2d\u5b9a\u3057\u307e\u3059\u3002\u3053\u306e\u8a2d\u5b9a\u306f\u914d\u5217\u306a\u306e\u3067\u8907\u6570\u306e\u9805\u76ee\u3092\u8a2d\u5b9a\u3067\u304d\u307e\u3059\u3002\n\n    \u30d9\u30b9\u30c8\u30d7\u30e9\u30af\u30c6\u30a3\u30b9\u69cb\u6210\u3067\u306f\u3001\u30b5\u30fc\u30d0\u30fc\u7fa4(tier)\u3054\u3068\u306ePlay book\u3092\u4f5c\u6210\u3057\u3001site.yml\u3067\u30b5\u30fc\u30d0\u7fa4\u3054\u3068\u306ePlay book\u3092include\u3059\u308b\u3053\u3068\u3067\u3001site.yml\u3092\u30a4\u30f3\u30d5\u30e9\u5168\u4f53\u306e\u5b9a\u7fa9\u3068\u3057\u307e\u3059\u3002[^2] \u3057\u304b\u3057\u3001kitchen-ansible\u306fplaybook\u306b\u8a2d\u5b9a\u3057\u305fyml\u3092\u30c6\u30b9\u30c8\u74b0\u5883\u3078\u30b3\u30d4\u30fc\u3057\u307e\u3059\u304c\u3001\u305d\u306e\u4e2d\u3067include\u3057\u3066\u3044\u308byml\u307e\u3067\u306f\u30b3\u30d4\u30fc\u3057\u3066\u304f\u308c\u307e\u305b\u3093\u3002\u305d\u3053\u3067\u30b5\u30fc\u30d0\u30fc\u7fa4\u5225Play book\u3082\u30c6\u30b9\u30c8\u74b0\u5883\u3078\u30b3\u30d4\u30fc\u3055\u308c\u308b\u3088\u3046additional_copy_path\u306b\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n    (roles\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306b\u3042\u308brole\u5225\u306ePlay book\u306froles_path\u306e\u8a2d\u5b9a\u306b\u3088\u3063\u3066\u30b3\u30d4\u30fc\u3055\u308c\u307e\u3059\u3002)\n\n    \u4eca\u56de\u306f\u3001Apache\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u305f\u3044\u306e\u3067\u3001\u30b5\u30fc\u30d0\u30fc\u7fa4Play book\u306fwebservers.yml\u3068\u3044\u3046\u540d\u524d\u3067\u4f5c\u308b\u3053\u3068\u306b\u3057\u3066\u3001\u3068\u308a\u3042\u3048\u305aadditional_copy_path\u306b\u66f8\u3044\u3066\u304a\u304d\u307e\u3059\u3002\n\n1. hosts\n    hosts\u30aa\u30d7\u30b7\u30e7\u30f3\u306b\u306f\u30c6\u30b9\u30c8\u74b0\u5883\u304c\u3069\u306e\u30db\u30b9\u30c8\u30b0\u30eb\u30fc\u30d7\u306b\u542b\u307e\u308c\u308b\u30db\u30b9\u30c8\u304b\u3092\u5b9a\u7fa9\u3057\u307e\u3059\u3002\n    \u30c6\u30b9\u30c8\u74b0\u5883\u306b\u306fhosts\u306e\u8a2d\u5b9a\u3092\u5143\u306b\u4ee5\u4e0b\u306e\u3088\u3046\u306ainventry\u30d5\u30a1\u30a4\u30eb\u304c\u4f5c\u6210\u3055\u308c\u3001\u30d7\u30ed\u30d3\u30b8\u30e7\u30cb\u30f3\u30b0\u306b\u4f7f\u7528\u3055\u308c\u307e\u3059\u3002\n\n    ```text:/tmp/kitchen/hosts\nlocalhost ansible_connection=local\n[webservers]  # <= \u3053\u3053\u306bhosts\u30aa\u30d7\u30b7\u30e7\u30f3\u304c\u8a2d\u5b9a\u3055\u308c\u308b\nlocalhost\n```\n    \u4eca\u56de\u306f\u3001\u30db\u30b9\u30c8\u30b0\u30eb\u30fc\u30d7\u3082webservers\u3068\u3044\u3046\u540d\u524d\u3067\u4f5c\u308b\u3053\u3068\u306b\u3057\u3066\u3001\u3068\u308a\u3042\u3048\u305ahosts\u306b\u66f8\u3044\u3066\u304a\u304d\u307e\u3059\u3002\n\n1. require_ansible_omnibus\n    true\u306b\u3059\u308b\u3068\u3001\u30c6\u30b9\u30c8\u74b0\u5883\u3078\u306eAnsible\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3092\u3001`ansible_omnibus_url`\u30aa\u30d7\u30b7\u30e7\u30f3(\u30c7\u30d5\u30a9\u30eb\u30c8\u306f\u3000[https://raw.githubusercontent.com/neillturner/omnibus-ansible/master/ansible_install.sh](https://raw.githubusercontent.com/neillturner/omnibus-ansible/master/ansible_install.sh))\u3067\u5b9a\u7fa9\u3055\u308c\u305f\u30b9\u30af\u30ea\u30d7\u30c8\u3067\u884c\u3044\u307e\u3059\u3002\n\n    (\u3053\u306e\u30aa\u30d7\u30b7\u30e7\u30f3\u306e\u30c7\u30d5\u30a9\u30eb\u30c8\u306ffalse\u3067\u3059\u3002false\u306e\u5834\u5408\u3001\u30c6\u30b9\u30c8\u74b0\u5883\u3078\u306eAnsible\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u306fyum\u307e\u305f\u306fapt\u3067\u884c\u3046\u306e\u3067\u3059\u304c\u3001\u8a18\u4e8b\u57f7\u7b46\u6642\u70b9\u3067\u306fsyntax error\u3068\u306a\u308b\u305f\u3081\u3001\u30aa\u30e0\u30cb\u30d0\u30b9\u30a4\u30f3\u30b9\u30c8\u30fc\u30e9\u30fc\u3092\u4f7f\u7528\u3057\u307e\u3059\u3002)\n\n1. require_ruby_for_busser\n    true\u306e\u5834\u5408\u3001\u30c6\u30b9\u30c8\u74b0\u5883\u3067busser\u306e\u5b9f\u884c\u306b\u4f7f\u7528\u3059\u308bruby\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u307e\u3059\u3002(busser\u306ftest-kitchen\u306e\u30c6\u30b9\u30c8\u30d5\u30ec\u30fc\u30e0\u30ef\u30fc\u30af\u3067\u3059\u3002)\n\n    \u3053\u306e\u30aa\u30d7\u30b7\u30e7\u30f3\u306e\u30c7\u30d5\u30a9\u30eb\u30c8\u306ffalse\u3067\u3001\u305d\u306e\u5834\u5408\u306fChef\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3001\u305d\u308c\u306b\u540c\u68b1\u3055\u308c\u3066\u3044\u308bruby\u3067busser\u3092\u5b9f\u884c\u3057\u307e\u3059\u3002\u4eca\u56de\u306fAnsible\u3092\u4f7f\u3046\u305f\u3081Chef\u306f\u4e0d\u8981\u3001\u305d\u306e\u4e0aruby\u3088\u308a\u3082\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u306b\u6642\u9593\u304c\u304b\u304b\u308b\u306e\u3067true\u306b\u3057\u307e\u3059\u3002\n\n### platforms\n\nplatforms\u306b\u306f\u30c6\u30b9\u30c8\u74b0\u5883\u3092\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\n```yaml:.kitchen.yml\u306eplatforms\nplatforms:\n  - name: ubuntu-14.04\n  - name: centos-7.1\n    driver_config:\n      privileged: true\n      run_command: /sbin/init; sleep 3\n```\n\n\u672c\u8a18\u4e8b\u57f7\u7b46\u6642\u70b9\u306ecentos:centos7\u30a4\u30e1\u30fc\u30b8\u3067\u306f\u3001systemctl\u3092\u4f7f\u7528\u3059\u308b\u305f\u3081\u306b\u306f\u7279\u6a29\u30e2\u30fc\u30c9\u304b\u3064\u8d77\u52d5\u30b3\u30de\u30f3\u30c9\u3092/sbin/init\u306b\u3057\u306a\u3051\u308c\u3070\u306a\u3089\u306a\u3044[^3]\u306e\u3067\u3001\u305d\u306e\u305f\u3081\u306e\u30aa\u30d7\u30b7\u30e7\u30f3\u3092\u8ffd\u52a0\u3057\u307e\u3059\u3002\n\n### verifier\n\n.kitchen.yml\u306bverifier\u3092\u8ffd\u52a0\u3057\u30c6\u30b9\u30c8\u30c4\u30fc\u30eb\u306e\u30aa\u30d7\u30b7\u30e7\u30f3\u3092\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\n```yaml:.kitchen.yml\u306everifier\nverifier:\n  ruby_bindir: '/usr/bin'\n```\n\nverifier\u306e`ruby_bindir`\u306b\u306f\u30c6\u30b9\u30c8\u30c4\u30fc\u30eb\u306e\u5b9f\u884c\u306b\u4f7f\u7528\u3059\u308bruby\u304c\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3055\u308c\u3066\u3044\u308b\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\u30c7\u30d5\u30a9\u30eb\u30c8\u306f`/opt/chef/embedded/bin`\u3067\u3001\u3053\u308c\u306fChef\u306b\u540c\u68b1\u3055\u308c\u308bruby\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u6307\u3057\u3066\u3044\u307e\u3059\u3002\n\u4eca\u56de\u306fprovisioner\u8a2d\u5b9a\u3067Chef\u3092\u5165\u308c\u305a\u3001\u4ee3\u308f\u308a\u306bruby\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u305f\u3081\u3001`ruby_bindir`\u306b\u306f\u305d\u3061\u3089\u306e\u30d1\u30b9\u3092\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\n### suites\n\nsuites\u306b\u306f\u30c6\u30b9\u30c8\u30b9\u30a4\u30fc\u30c8\u3092\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\n```.kitchen.yml\u306esuites\nsuites:\n  - name: default\n    attributes:\n```\n\nrun_list\u306fkitchen-ansible\u3067\u306f\u4f7f\u7528\u3057\u306a\u3044\u305f\u3081\u6d88\u3057\u3066\u3057\u307e\u3044\u307e\u3059\u3002\nattributes\u306f\u4eca\u56de\u306f\u4f7f\u7528\u3057\u307e\u305b\u3093\u304c\u3001extra_vars\u3084tags\u3092\u8a2d\u5b9a\u3059\u308b\u5834\u5408\u306f\u3053\u3053\u306b\u3076\u3089\u4e0b\u3052\u308b\u306e\u3067\u3001\u6b8b\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\n\n\n\u4ee5\u4e0a\u3067\u3001.kitchen.yml\u306e\u8a2d\u5b9a\u306f\u7d42\u308f\u308a\u3067\u3059\u3002\n\u6700\u7d42\u7684\u306b.kitchen.yml\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\n\n```yaml:\u7de8\u96c6\u5f8c\u306e.kitchen.yml\n---\ndriver:\n  name: docker\n\nprovisioner:\n  name: ansible_playbook\n  playbook: site.yml\n  roles_path: ./roles\n  group_vars_path: ./group_vars\n  host_vars_path: ./host_vars\n  filter_plugins: ./filter_plugins\n  additional_copy_path:\n    - webservers.yml\n  hosts: webservers\n  require_ansible_omnibus: true\n  require_ruby_for_busser: true\n\nplatforms:\n  - name: ubuntu-14.04\n  - name: centos-7.1\n    driver_config:\n      privileged: true\n      run_command: /sbin/init; sleep 3\n\nverifier:\n  ruby_bindir: '/usr/bin'\n\nsuites:\n  - name: default\n    attributes:\n```\n\n.kitchen.yml\u306e\u7de8\u96c6\u304c\u7d42\u308f\u3063\u305f\u3089\u3001`kitchen list`\u30b3\u30de\u30f3\u30c9\u3092\u53e9\u304f\u3068\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u30c6\u30b9\u30c8\u74b0\u5883\u304c\u8868\u793a\u3055\u308c\u308b\u306f\u305a\u3067\u3059\u3002\n\n```bash:kitchen_list\n$ bundle exec kitchen list\nInstance             Driver  Provisioner      Verifier  Transport  Last Action\ndefault-ubuntu-1404  Docker  AnsiblePlaybook  Busser    Ssh        <Not Created>\ndefault-centos-71    Docker  AnsiblePlaybook  Busser    Ssh        <Not Created>\n```\n\n\u30c6\u30b9\u30c8\u74b0\u5883\u306f[\u30c6\u30b9\u30c8\u30b9\u30a4\u30fc\u30c8\u540d]-[\u30d7\u30e9\u30c3\u30c8\u30d5\u30a9\u30fc\u30e0\u540d]\u306b\u306a\u308a\u3001platform\u3068suite\u306e\u7d44\u307f\u5408\u308f\u305b\u306b\u306a\u308a\u307e\u3059\u3002\n\n## Serverspec\u306e\u521d\u671f\u5316\n\ntest-kitchen\u306e\u30eb\u30fc\u30eb[^4]\u306b\u3057\u305f\u304c\u3063\u3066\u3001`test/integration/default`\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3078Serverspec\u30d5\u30a1\u30a4\u30eb\u3092\u914d\u7f6e\u3057\u307e\u3059\u3002\n(`test/integration/default`\u306edefault\u306e\u90e8\u5206\u306f.kitchen.yml\u306esuites\u306ename\u306b\u5bfe\u5fdc\u3057\u307e\u3059\u3002\u30c6\u30b9\u30c8\u30b9\u30a4\u30fc\u30c8\u306e\u540d\u524d\u3092\u5909\u66f4\u3057\u3066\u3044\u308b\u5834\u5408\u306fServerspec\u3092\u914d\u7f6e\u3059\u308b\u30d1\u30b9\u3082\u5909\u66f4\u3057\u306a\u3051\u308c\u3070\u306a\u308a\u307e\u305b\u3093\u3002)\n\n```bash:Serverspec\u521d\u671f\u5316\n$ cd test/integration/default\n$ bundle exec serverspec-init\nSelect OS type:\n\n  1) UN*X\n  2) Windows\n\nSelect number: 1\n\nSelect a backend type:\n\n  1) SSH\n  2) Exec (local)\n\nSelect number: 2\n\n + spec/\n + spec/localhost/\n + spec/localhost/sample_spec.rb\n + spec/spec_helper.rb\n + Rakefile\n```\n\nServerspec\u306e\u521d\u671f\u5316\u306b\u3088\u3063\u3066\u4f5c\u6210\u3055\u308c\u305fspec\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092serverspec\u3078\u30ea\u30cd\u30fc\u30e0\u3057\u307e\u3059\u3002\n\u3053\u308c\u306f\u3001test-kitchen\u304c\u30c6\u30b9\u30c8\u74b0\u5883\u3078\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u30c6\u30b9\u30c8\u30e9\u30f3\u30ca\u30fc(busser)\u306e\u30d7\u30e9\u30b0\u30a4\u30f3\u3092\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u540d\u304b\u3089\u6c7a\u3081\u308b\u305f\u3081\u3067\u3059\u3002\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u540d\u3092\u5909\u66f4\u3057\u306a\u3044\u5834\u5408busser-spec\u3068\u3044\u3046\u5b58\u5728\u3057\u306a\u3044\u30d7\u30e9\u30b0\u30a4\u30f3\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3088\u3046\u3068\u3057\u3066\u30a8\u30e9\u30fc\u306b\u306a\u308a\u307e\u3059\u3002)\n\n```bash\n$ mv spec/ serverspec/\n```\n\nServerspec\u306e\u521d\u671f\u5316\u3092\u884c\u3046\u3068\u3001\u30b5\u30f3\u30d7\u30eb\u306espec\u30d5\u30a1\u30a4\u30eb\u304c\u4f5c\u6210\u3055\u308c\u307e\u3059\u3002\n\u4e2d\u8eab\u306f\u4ee5\u4e0b\u306e\u3068\u304a\u308a\u3067\u3001\u4eca\u56de\u4f5c\u6210\u3057\u305f\u3044Ansible play book\u306b\u3061\u3087\u3046\u3069\u826f\u3044\u306e\u3067\u540d\u524d\u3060\u3051\u5909\u66f4\u3057\u3066\u4e2d\u8eab\u306f\u305d\u306e\u307e\u307e\u4f7f\u3044\u307e\u3059\u3002\n\n```bash:sample_spec.rb\u306e\u30ea\u30cd\u30fc\u30e0\nmv test/integration/default/serverspec/localhost/sample_spec.rb test/integration/default/serverspec/localhost/webservers_spec.rb\n```\n\n```rb:test/integration/default/serverspec/localhost/webservers_spec.rb\nrequire 'spec_helper'\n\ndescribe package('httpd'), :if => os[:family] == 'redhat' do\n  it { should be_installed }\nend\n\ndescribe package('apache2'), :if => os[:family] == 'ubuntu' do\n  it { should be_installed }\nend\n\ndescribe service('httpd'), :if => os[:family] == 'redhat' do\n  it { should be_enabled }\n  it { should be_running }\nend\n\ndescribe service('apache2'), :if => os[:family] == 'ubuntu' do\n  it { should be_enabled }\n  it { should be_running }\nend\n\ndescribe service('org.apache.httpd'), :if => os[:family] == 'darwin' do\n  it { should be_enabled }\n  it { should be_running }\nend\n\ndescribe port(80) do\n  it { should be_listening }\nend\n```\n\n\u30ea\u30cd\u30fc\u30e0\u3057\u305fserverspec\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306bGemfile\u3092\u8ffd\u52a0\u3057\u307e\u3059\u3002\n\n```rb:test/integration/default/serverspec/Gemfile\nsource 'https://rubygems.org'\n\ngem 'rake'\ngem 'serverspec'\n```\n\n\u53c2\u8003:[Rake dependency missing for older rubies \u00b7 Issue #28](https://github.com/test-kitchen/busser-serverspec/issues/28)\n\n\n## \u4eee\u306esite.yml\u4f5c\u6210\n\n\u4ee5\u4e0a\u3067TDD\u306e\u6e96\u5099\u304c\u51fa\u6765\u307e\u3057\u305f\u3002\u3068\u3001\u8a00\u3044\u305f\u3044\u3068\u3053\u308d\u3067\u3059\u304c\u3001\u3053\u306e\u72b6\u614b\u3067`kitchen test`\u30b3\u30de\u30f3\u30c9\u3092\u53e9\u304f\u3068\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3057\u307e\u3059\u3002\n\n```bash:kitche_test\n$ cd ~/ansibletdd\n$ bundle exec kitchen test\n-----> Starting Kitchen (v1.4.2)\n-----> Cleaning up any prior instances of <default-ubuntu-1404>\n\n~~~\u4e2d\u7565~~~\n\nPreparing playbook\n>>>>>> ------Exception-------\n>>>>>> Class: Kitchen::ActionFailed\n>>>>>> Message: Failed to complete #converge action: [unknown file type: site.yml]\n>>>>>> ----------------------\n>>>>>> Please see .kitchen/logs/kitchen.log for more details\n>>>>>> Also try running `kitchen diagnose --all` for configuration\n```\n\n\u3068\u308a\u3042\u3048\u305a\u30a8\u30e9\u30fc\u3092\u89e3\u6d88\u3059\u308b\u305f\u3081\u4eee\u306esite.yml\u3068webservers.yml\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n```yaml:site.yml\n---\n- include: webservers.yml\n```\n\n```yaml:webservers.yml\n---\n- hosts: webservers\n  tasks:\n```\n\n\u4f5c\u6210\u3057\u305f\u3089\u3082\u3046\u4e00\u5ea6`kitchen test`\u3092\u884c\u3044\u307e\u3059\u3002\n\n```bash:kitchen_test\n$ bundle exec kitchen test\n-----> Starting Kitchen (v1.4.2)\n-----> Cleaning up any prior instances of <default-ubuntu-1404>\n\n~~~ \u4e2d\u7565 ~~~\n\n       Finished in 0.27052 seconds (files took 0.46124 seconds to load)\n       4 examples, 4 failures\n\n       Failed examples:\n\n       rspec /tmp/verifier/suites/serverspec/localhost/webservers_spec.rb:8 # Package \"apache2\" should be installed\n       rspec /tmp/verifier/suites/serverspec/localhost/webservers_spec.rb:17 # Service \"apache2\" should be enabled\n       rspec /tmp/verifier/suites/serverspec/localhost/webservers_spec.rb:18 # Service \"apache2\" should be running\n       rspec /tmp/verifier/suites/serverspec/localhost/webservers_spec.rb:27 # Port \"80\" should be listening\n\n~~~ \u5f8c\u7565 ~~~\n```\n\n\u4eca\u5ea6\u306f\u3001default-ubuntu-1404\u3067Serverspec\u306b\u3088\u308b\u691c\u8a3c\u307e\u3067\u884c\u308f\u308c\u3001\u5168\u3066fail\u3057\u307e\u3057\u305f\u3002\n(test-kitchen\u306f\u30c6\u30b9\u30c8\u304c\u5931\u6557\u3059\u308b\u3068\u305d\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3067\u30c6\u30b9\u30c8\u3092\u3084\u3081\u3066\u3057\u307e\u3046\u306e\u3067\u3001\u305d\u308c\u4ee5\u964d\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3067\u30c6\u30b9\u30c8\u3092\u884c\u3044\u305f\u3044\u5834\u5408\u306f\u3001`bundle exec kitchen test default-centos-71`\u306e\u3088\u3046\u306b\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u540d\u3092\u6307\u5b9a\u3057\u307e\u3059\u3002\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u540d\u306f\u6b63\u898f\u8868\u73fe\u3067\u3082\u6307\u5b9a\u3067\u304d\u308b\u306e\u3067\u3001\u6761\u4ef6\u306b\u5408\u3046\u8907\u6570\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u30c6\u30b9\u30c8\u3059\u308b\u3053\u3068\u3082\u51fa\u6765\u307e\u3059\u3002)\n\n\u3053\u308c\u3067\u3088\u3046\u3084\u304fTDD\u306e\u6e96\u5099\u304c\u51fa\u6765\u307e\u3057\u305f\u3002\n\u3042\u3068\u306f\u3001\u5168\u3066\u306e\u30c6\u30b9\u30c8\u304c\u6210\u529f\u3059\u308b\u3088\u3046\u3001\u300c\u66f8\u304f -> \u30c6\u30b9\u30c8\u300d\u3092\u7e70\u308a\u8fd4\u3057\u306a\u304c\u3089Ansible playbook\u3092\u66f8\u3044\u3066\u3044\u3051\u3070OK\u3067\u3059\u3002\n\n### Ansible playbook\u306e\u5b9f\u88c5\n\nTDD\u74b0\u5883\u304c\u51fa\u6765\u305f\u306e\u3067\u3001\u3042\u3068\u306fPlay book\u3092\u5b9f\u88c5\u3057\u3066\u3044\u304f\u3060\u3051\u3067\u3059\u3002\n\u66f8\u304d\u65b9\u306e\u8a73\u7d30\u306f\u672c\u8a18\u4e8b\u306e\u8da3\u65e8\u304b\u3089\u5916\u308c\u308b\u306e\u3067Google\u5148\u751f\u306b\u805e\u3044\u3066\u3082\u3089\u3046\u3068\u3057\u3066\u3001\u3068\u308a\u3042\u3048\u305a\u5168\u3066\u306e\u30c6\u30b9\u30c8\u304c\u901a\u308bPlay book\u3092\u7f6e\u3044\u3066\u304a\u304d\u307e\u3059\u3002\n\n```YAML:site.yml\n---\n- include: webservers.yml\n```\n\n```YAML:webservers.yml\n---\n- hosts: webservers\n  roles:\n    - apache\n```\n\n```YAML:roles/apache/tasks/main.yml\n- apt: pkg=apache2\n  when: \"ansible_os_family == 'Debian'\"\n\n- yum: pkg=httpd\n  when: \"ansible_os_family == 'RedHat'\"\n\n- service: name=apache2 state=started enabled=yes\n  when: \"ansible_os_family == 'Debian'\"\n\n- service: name=httpd state=started enabled=yes\n  when: \"ansible_os_family == 'RedHat'\"\n```\n\n\u3053\u308c\u3067\u3001`kitchen test`\u3059\u308c\u3070\u5168\u3066\u306e\u30c6\u30b9\u30c8\u304c\u6210\u529f\u3059\u308b\u306f\u305a\u3067\u3059\u3002\n\n```bash:kitchen_test\n$ bundle exec kitchen test\n-----> Starting Kitchen (v1.4.2)\n-----> Cleaning up any prior instances of <default-ubuntu-1404>\n\n~~~ \u4e2d\u7565 ~~~\n\n       Package \"apache2\"\n         should be installed\n\n       Service \"apache2\"\n         should be enabled\n         should be running\n\n       Port \"80\"\n         should be listening\n\n       Finished in 0.1665 seconds (files took 1.22 seconds to load)\n       4 examples, 0 failures\n\n       Finished verifying <default-ubuntu-1404> (0m28.28s).\n\n~~~ \u4e2d\u7565 ~~~\n\n       Package \"httpd\"\n         should be installed\n\n       Service \"httpd\"\n         should be enabled\n         should be running\n\n       Port \"80\"\n         should be listening\n\n       Finished in 0.16315 seconds (files took 1.07 seconds to load)\n       4 examples, 0 failures\n\n       Finished verifying <default-centos-71> (0m24.25s).\n\n~~~\u3000\u5f8c\u7565 ~~~\n```\n\n# \u307e\u3068\u3081\n\nAnsible\u3092TDD\u3059\u308b\u305f\u3081\u306e\u74b0\u5883\u69cb\u7bc9\u306e\u4e00\u9023\u306e\u624b\u9806\u3092\u8ffd\u3044\u304b\u3051\u307e\u3057\u305f\u3002\ntest-kitchen\u3092\u4f7f\u3063\u3066\u30c8\u30e9\u30a4&\u30a8\u30e9\u30fc\u3092\u7c21\u5358\u306b\u884c\u3048\u308bTDD\u74b0\u5883\u3092\u7528\u610f\u3059\u308b\u3068Ansible(\u3084Chef)\u306e\u958b\u767a\u3092\u30b5\u30af\u30b5\u30af\u9032\u3081\u3089\u308c\u308b\u7528\u306b\u306a\u308a\u307e\u3059\u304c\u3001\u30c7\u30d5\u30a9\u30eb\u30c8\u8a2d\u5b9a\u3067\u306f\u52d5\u304b\u306a\u3044\u7b87\u6240\u306a\u3069\u30cf\u30de\u308a\u3069\u3053\u308d\u304c\u3044\u304f\u3064\u304b\u3042\u308b\u306e\u3067\u6ce8\u610f\u304c\u5fc5\u8981\u3067\u3059\u3002\u30cf\u30de\u3063\u305f\u5834\u5408\u306f\u30ed\u30b0\u3068\u95a2\u9023\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u3092\u8aad\u3093\u3067\u9811\u5f35\u308a\u307e\u3057\u3087\u3046\u3002\n\n# appendix\n\n## Docker image\u3092\u6307\u5b9a\u3057\u305f\u3044\u5834\u5408\n\nkitchen-docer\u306f`Kitchen::Driver::Docker.default_image`\u306b\u3088\u3063\u3066platform.name\u304b\u3089\u30c6\u30b9\u30c8\u74b0\u5883\u306e\u30d9\u30fc\u30b9\u30a4\u30e1\u30fc\u30b8\u306e\u30bf\u30b0\u3092\u751f\u6210\u3057\u307e\u3059\u304c\u3001\u4efb\u610f\u306e\u30bf\u30b0\u3092\u6307\u5b9a\u3059\u308b\u3053\u3068\u3082\u51fa\u6765\u307e\u3059\u3002\n\u305d\u306e\u5834\u5408\u306f\u3001.kitchen.yml\u3092\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u5909\u66f4\u3057\u307e\u3059\u3002\n\n```yaml.kitchen.yml\nplatforms:\n  - name: ubuntu-14.04\n    driver_config:         # <= \u8ffd\u52a0\n      image: ubuntu:14.04  # <= \u8ffd\u52a0\n  - name: centos-7\n    driver_config:\n       image: centos:centos7 # <= \u8ffd\u52a0\n       privileged: true\n       run_command: /sbin/init; sleep 3\n```\n\n## \u8907\u6570\u306e\u30db\u30b9\u30c8\u30b0\u30eb\u30fc\u30d7\u306b\u5bfe\u5fdc\u3057\u305f\u3044\u5834\u5408\n\nPlay book\u306b\u30db\u30b9\u30c8\u30b0\u30eb\u30fc\u30d7(\u4f8b\u3048\u3070\u3001apservers)\u3092\u8ffd\u52a0\u5b9a\u7fa9\u3057\u305f\u3044\u5834\u5408\u306f\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u3057\u307e\u3059\u3002\n\n\u30c6\u30b9\u30c8\u30b9\u30a4\u30fc\u30c8\u3067\u306fprovisioner\u306e\u30aa\u30d7\u30b7\u30e7\u30f3\u3092\u4e0a\u66f8\u304d\u3067\u304d\u308b\u306e\u3067\u3001\u30c6\u30b9\u30c8\u30b9\u30a4\u30fc\u30c8\u3092\u5897\u3084\u3057\u3001\u30b9\u30a4\u30fc\u30c8\u3054\u3068\u306b\u30db\u30b9\u30c8\u30b0\u30eb\u30fc\u30d7\u30aa\u30d7\u30b7\u30e7\u30f3\u3092\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\n```yaml.kitchen.yml\u306esuites\nsuites:\n  - name: webservers    # <= default\u304b\u3089\u5909\u66f4\n    provisioner:        # <= \u8ffd\u52a0\n      hosts: webservers # <= \u8ffd\u52a0\n  - name: apservers     # <= \u8ffd\u52a0\n    provisioner:        # <= \u8ffd\u52a0\n      hosts: apservers  # <= \u8ffd\u52a0\n```\n\n\u6b21\u306b\u30b9\u30a4\u30fc\u30c8\u3054\u3068\u306eServerspec\u3092\u7528\u610f\u3057\u307e\u3059\u3002\n\u73fe\u5728\u306etest\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u72b6\u614b\u3067\u3059\u3002\n\n\n```bash:\n$ tree\ntest\n\u2514\u2500\u2500 integration\n    \u2514\u2500\u2500 default\n        \u251c\u2500\u2500 Rakefile\n        \u2514\u2500\u2500 serverspec\n            \u251c\u2500\u2500 Gemfile\n            \u251c\u2500\u2500 localhost\n            \u2502\u00a0\u00a0 \u2514\u2500\u2500 webservers_spec.rb\n            \u2514\u2500\u2500 spec_helper.rb\n```\n\n\u3053\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306b\u4ee5\u4e0b\u306e\u64cd\u4f5c\u3092\u884c\u3044\u307e\u3059\u3002\n\n1. default\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306f\u30c6\u30b9\u30c8\u30b9\u30a4\u30fc\u30c8\u540d\u306a\u306e\u3067\u3053\u308c\u306fwebservers\u306b\u5909\u66f4\u3057\u307e\u3059\n2. Rakefile, Gemfile, spec_helper.rb\u306f\u8907\u6570\u306e\u30c6\u30b9\u30c8\u30b9\u30a4\u30fc\u30c8\u3067\u5171\u901a\u306a\u306e\u3067\u3001helpers\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u4f5c\u308a\u305d\u3053\u3078\u79fb\u52d5\u3057\u307e\u3059\n3. webservers\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u30b3\u30d4\u30fc\u3057apservers\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3068\u3057\u307e\u3059\n4. \u30b3\u30d4\u30fc\u3057\u305f\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306ewebservers_spec.rb\u3092apservers_spec.rb\u306b\u30ea\u30cd\u30fc\u30e0\u3057\u307e\u3059\u3002\n\n```bash\n$ mv test/integration/default/ test/integration/webservers\n$ mkdir -p test/integration/helpers/serverspec\n$ cd test/integration\n$ mv webservers/Rakefile helpers/\n$ mv webservers/serverspec/Gemfile helpers/serverspec/\n$ mv webservers/serverspec/spec_helper.rb helpers/serverspec/\n$ cp -r webservers/ apservers\n$ mv apservers/serverspec/localhost/webservers_spec.rb apservers/serverspec/localhost/apservers_spec.rb\n$ tree test\ntest\n\u2514\u2500\u2500 integration\n    \u251c\u2500\u2500 apservers\n    \u2502\u00a0\u00a0 \u2514\u2500\u2500 serverspec\n    \u2502\u00a0\u00a0     \u2514\u2500\u2500 localhost\n    \u2502\u00a0\u00a0         \u2514\u2500\u2500 apservers_spec.rb\n    \u251c\u2500\u2500 helpers\n    \u2502\u00a0\u00a0 \u251c\u2500\u2500 Rakefile\n    \u2502\u00a0\u00a0 \u2514\u2500\u2500 serverspec\n    \u2502\u00a0\u00a0     \u251c\u2500\u2500 Gemfile\n    \u2502\u00a0\u00a0     \u2514\u2500\u2500 spec_helper.rb\n    \u2514\u2500\u2500 webservers\n        \u2514\u2500\u2500 serverspec\n            \u2514\u2500\u2500 localhost\n                \u2514\u2500\u2500 webservers_spec.rb\n```\n\n\u4ee5\u4e0a\u3067\u5171\u901a\u306e\u30d5\u30a1\u30a4\u30eb\u3092helpers\u3078\u79fb\u52d5\u3057\u3001\u5404\u30c6\u30b9\u30c8\u30b9\u30a4\u30fc\u30c8\u306b\u5fc5\u8981\u306a\u30d5\u30a1\u30a4\u30eb\u30fb\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u7528\u610f\u3067\u304d\u307e\u3057\u305f\u3002\u3042\u3068\u306fapservers_spec.rb\u30d5\u30a1\u30a4\u30eb\u3092apservers\u30b0\u30eb\u30fc\u30d7\u306b\u9069\u3057\u305f\u5f62\u306b\u66f8\u304d\u63db\u3048\u308c\u3070\u5b8c\u4e86\u3067\u3059\u3002\n\n# \u53c2\u8003\u8cc7\u6599\n\n- [Ansible\u306e\u30c6\u30b9\u30c8\u3092test-kitchen\u3068Serverspec\u3001docker\u3067\u884c\u3046 - Qiita](http://qiita.com/r_takaishi/items/f3e68e3f7072b9327c3f)\n- [Chef & Test Kitchen+Serverspec & Docker & Packer\u306b\u3088\u308bInfrastructure as Code\u4e8b\u59cb\u3081 - Qiita](http://qiita.com/nmatsui/items/7a8a3cdd7cc50169627f)\n- [test-kitchen\u306e\u3064\u304b\u3044\u304b\u305f - Qiita](http://qiita.com/sawanoboly/items/9f560bd63ad0712b17ba)\n- [Introduction - KitchenCI](http://kitchen.ci/docs/getting-started/)\n- [Kitchen \u2014 Chef Docs](https://docs.chef.io/kitchen.html)\n- [Best Practices \u2014 Ansible Documentation](http://docs.ansible.com/ansible/playbooks_best_practices.html)\n- [neillturner/kitchen-ansible](https://github.com/neillturner/kitchen-ansible)\n- [portertech/kitchen-docker](https://github.com/portertech/kitchen-docker)\n- [test-kitchen/busser](https://github.com/test-kitchen/busser)\n- [test-kitchen/busser-serverspec](https://github.com/test-kitchen/busser-serverspec)\n\n[^1]: [Best Practices \u2014 Ansible Documentation](http://docs.ansible.com/ansible/playbooks_best_practices.html)\n[^2]: [Best Practices \u2014 Ansible Documentation#top-level-playbooks-are-separated-by-role](http://docs.ansible.com/ansible/playbooks_best_practices.html#top-level-playbooks-are-separated-by-role)\n[^3]: [Chef &amp; Test Kitchen+Serverspec &amp; Docker &amp; Packer\u306b\u3088\u308bInfrastructure as Code\u4e8b\u59cb\u3081 - Qiita](http://qiita.com/nmatsui/items/7a8a3cdd7cc50169627f#test-kitchen%E3%81%AE%E8%A8%AD%E5%AE%9A%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E4%BD%9C%E6%88%90)\n[^4]: [Writing a Test - KitchenCI](http://kitchen.ci/docs/getting-started/writing-test)\n", "tags": ["Ansible", "docker", "test-kitchen", "serverspec"]}