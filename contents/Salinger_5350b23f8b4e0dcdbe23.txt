{"context": " More than 1 year has passed since last update.\n\nUnicorn \u3068\u306f\nRails \u6a19\u6e96\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30b5\u30fc\u30d0\u306f\u91cd\u3044\u306e\u3067\u3001\u52d5\u4f5c\u304c\u8efd\u3044 Unicorn \u3092\u5c0e\u5165\u3057\u3066\u307f\u308b\u3002\n\n\u74b0\u5883\u69cb\u7bc9\nChef-Solo + Berkshelf \u3067 Rails 4 \u306e\u958b\u767a\u74b0\u5883\u3092\u69cb\u7bc9 \u3092\u53c2\u8003\u306b\u3002\n\u4ed6\u306e\u30b5\u30fc\u30d0\u3068\u306f\u5225\u306e\u30d7\u30e9\u30a4\u30d9\u30fc\u30c8IP\u3092\u5272\u308a\u5f53\u3066\u3066\u304a\u304f\u3002\n\n\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u4f5c\u6210\n\u4ee5\u4e0b\u306e\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3057\u3066\u3044\u304f\u3002\n$ mkdir ~/projects/unicorn_sample\n$ cd ~/projects/unicorn_sample\n$ bundle init\n\n\u4f5c\u6210\u3055\u308c\u305fGemfile\u3092\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u66f8\u304d\u63db\u3048\u308b\u3002\n\nGemfile\nsource 'https://rubygems.org'\n\ngem 'rails', '4.2.0'\n\n\n\u4ee5\u4e0b\u306e\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3002\n$ bundle install --path vendor/bundle\n$ bundle exec rails new .\n...\nOverwrite /home/vagrant/projects/unicorn_sample/Gemfile? (enter \"h\" for help) [Ynaqdh] Y\n...\n\nGemfile \u3092\u4e0b\u8a18\u306e\u3088\u3046\u306b\u66f8\u304d\u63db\u3048\u308b\u3002\n\nGemfile\nsource 'https://rubygems.org'\n\ngem 'rails', '4.2.0'\ngem 'sqlite3'\ngem 'sass-rails', '~> 5.0'\ngem 'uglifier', '>= 1.3.0'\ngem 'coffee-rails', '~> 4.1.0'\ngem 'therubyracer', platforms: :ruby\ngem 'jquery-rails'\ngem 'turbolinks'\ngem 'jbuilder', '~> 2.0'\ngem 'sdoc', '~> 0.4.0', group: :doc\ngem 'bcrypt', '~> 3.1.7'\ngem 'unicorn'\n\ngroup :development, :test do\n  gem 'byebug'\n  gem 'web-console', '~> 2.0'\n  gem 'spring'\nend\n\n\n\u4e0b\u8a18\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3002\n$ bundle install --path vendor/bundle\n\n\n\u30c6\u30b9\u30c8\u7528\u30a2\u30d7\u30ea\u4f5c\u6210\n$ bundle exec rails generate scaffold board title:string text:string\n$ rake db:migrate\n\nconfig/routes.rb \u3092\u4e0b\u8a18\u306e\u3088\u3046\u306b\u7de8\u96c6\n\nconfig/routes.rb\nRails.application.routes.draw do\n  resources :boards\n  root \u201cboards#index\"\nend\n\n\n\u4e0b\u8a18\u30b3\u30de\u30f3\u30c9\u3067\u30b5\u30fc\u30d0\u30fc\u3092\u8d77\u52d5\u3057\u3001\u30da\u30fc\u30b8\u304c\u898b\u3048\u308b\u304b\u3069\u3046\u304b\u78ba\u8a8d\u3057\u3066\u304a\u304f\u3002\n$ bundle exec rails server -b 0.0.0.0\n\n\nUnicorn \u306e\u8a2d\u5b9a\nconfig/unicorn.rb \u3092\u4e0b\u8a18\u306e\u5185\u5bb9\u3067\u65b0\u898f\u306b\u4f5c\u6210 (\u53c2\u8003\u8cc7\u6599)\u3002\n\nconfig/unicorn.rb\n# -*- coding: utf-8 -*-\nworker_processes Integer(ENV[\"WEB_CONCURRENCY\"] || 3)\ntimeout 15\npreload_app true  # \u66f4\u65b0\u6642\u30c0\u30a6\u30f3\u30bf\u30a4\u30e0\u7121\u3057\n\nlisten \"/tmp/unicorn.sock\"\npid \"/tmp/unicorn.pid\"\n\nbefore_fork do |server, worker|\n  Signal.trap 'TERM' do\n    puts 'Unicorn master intercepting TERM and sending myself QUIT instead'\n    Process.kill 'QUIT', Process.pid\n  end\n\n  defined?(ActiveRecord::Base) and\n    ActiveRecord::Base.connection.disconnect!\nend\n\nafter_fork do |server, worker|\n  Signal.trap 'TERM' do\n    puts 'Unicorn worker intercepting TERM and doing nothing. Wait for master to send QUIT'\n  end\n\n  defined?(ActiveRecord::Base) and\n    ActiveRecord::Base.establish_connection\nend\n\n# \u30ed\u30b0\u306e\u51fa\u529b\nstderr_path File.expand_path('log/unicorn.log', ENV['RAILS_ROOT'])\nstdout_path File.expand_path('log/unicorn.log', ENV['RAILS_ROOT'])\n\n\n\u4e0b\u8a18\u30b3\u30de\u30f3\u30c9\u3067 unicorn \u8d77\u52d5\u3002\n$ bundle exec unicorn_rails -c config/unicorn.rb -E production -D\n\n\u8d77\u52d5\u3067\u304d\u3066\u3044\u308b\u304b\u3069\u3046\u304b\u306f\u4e0b\u8a18\u30b3\u30de\u30f3\u30c9\u3067\u78ba\u8a8d\u3067\u304d\u308b\u3002\n$ ps -ef | grep unicorn | grep -v grep\n\nUnicorn \u3092\u6b62\u3081\u308b\u306b\u306f\u4e0b\u8a18\u306e\u30b3\u30de\u30f3\u30c9\u3067\u30d7\u30ed\u30bb\u30b9\u3092Kill\u3059\u308b\u3002\n$ kill -9 [Process ID]\n\n\u3053\u306e\u307e\u307e\u3060\u3068\u8d77\u52d5 & \u7d42\u4e86\u304c\u9762\u5012\u306a\u306e\u3067\u3001Rake\u306etask \u306b Unicorn \u306e\u8d77\u52d5 & \u7d42\u4e86\u306e\u8a2d\u5b9a\u3092\u8a18\u8ff0\u3059\u308b\u3002\n\u3053\u306e\u30da\u30fc\u30b8\u3092\u53c2\u8003\u306b\u3057\u305f\u3002\nTask\u306e\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3059\u308b\u3002\n\n$ bundle exec rails generate task unicorn\n\n\u4ee5\u4e0b\u306e\u5185\u5bb9\u306b\u5909\u66f4\u3059\u308b\u3002\n\nlib/tasks/unicorn.rake\nnamespace :unicorn do\n  ##\n  # Tasks\n  ##\n  desc \"Start unicorn for development env.\"\n  task(:start) {\n    config = Rails.root.join('config', 'unicorn.rb')\n    sh \"bundle exec unicorn_rails -c #{config} -E development -D\"\n  }\n\n  desc \"Stop unicorn\"\n  task(:stop) { unicorn_signal :QUIT }\n\n  desc \"Restart unicorn with USR2\"\n  task(:restart) { unicorn_signal :USR2 }\n\n  desc \"Increment number of worker processes\"\n  task(:increment) { unicorn_signal :TTIN }\n\n  desc \"Decrement number of worker processes\"\n  task(:decrement) { unicorn_signal :TTOU }\n\n  desc \"Unicorn pstree (depends on pstree command)\"\n  task(:pstree) do\n    sh \"pstree '#{unicorn_pid}'\"\n  end\n\n  def unicorn_signal signal\n    Process.kill signal, unicorn_pid\n  end\n\n  def unicorn_pid\n    begin\n      File.read(\"/tmp/unicorn.pid\").to_i\n    rescue Errno::ENOENT\n      raise \"Unicorn doesn't seem to be running\"\n    end\n  end\n\nend\n\n\n\u4e0b\u8a18\u306e\u30b3\u30de\u30f3\u30c9\u3067Unicorn\u3092\u8d77\u52d5\u3001\u505c\u6b62\u51fa\u6765\u308b\u3088\u3046\u306b\u306a\u308b\u3002\n$ bundle exec rake unicorn:start\n$ bundle exec rake unicorn:stop\n\n\u3068\u308a\u3042\u3048\u305a\u3001Unicorn\u3092\u8d77\u52d5\u3057\u3066\u304a\u304f\u3002\n\nNginx \u306e\u8a2d\u5b9a\n\u4e0b\u8a18\u30b3\u30de\u30f3\u30c9\u3067\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u306e\u4f5c\u6210\u3092\u884c\u3046\u3002\n$ sudo cp /etc/nginx/conf.d/default.conf /etc/nginx/conf.d/local.conf\n$ sudo mv /etc/nginx/conf.d/default.conf /etc/nginx/conf.d/default.conf.bk\n\n/etc/nginx/conf.d/local.conf \u3092\u4e0b\u8a18\u306e\u3088\u3046\u306b\u66f8\u304d\u63db\u3048\u308b\u3002\nupstream \u306e server \u306e\u90e8\u5206\u306f Unicorn \u5074\u3067\u6307\u5b9a\u3057\u305f sock \u30d5\u30a1\u30eb\u306e\u5834\u6240\u3092\u3001\nroot \u306e\u90e8\u5206\u306f\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u30eb\u30fc\u30c8\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u6307\u5b9a\u3059\u308b\u3002\n\n/etc/nginx/conf.d/local.conf\nupstream unicorn {\n  server unix:/home/vagrant/projects/unicorn_sample/tmp/unicorn.sock;\n}\n\nserver {\n  listen 80 default_server;\n  server_name \u30b5\u30fc\u30d0\u540d;\n\n  access_log /var/log/nginx/sample_access.log;\n  error_log /var/log/nginx/sample_error.log;\n\n  root /home/vagrant/projects/unicorn_sample;\n\n  client_max_body_size 100m;\n  error_page 404 /404.html;\n  error_page 500 502 503 504 /500.html;\n  try_files $uri/index.html $uri @unicorn;\n\n  location @unicorn {\n    proxy_set_header X-Real-IP $remote_addr;\n    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n    proxy_set_header Host $http_host;\n    proxy_pass http://unicorn;\n  }\n}\n\n\nNginx \u3092(\u518d)\u8d77\u52d5\u3059\u308b\u3002\n$ sudo service nginx restart\n\n\n\u52d5\u4f5c\u78ba\u8a8d\nhttp://[\u30c9\u30e1\u30a4\u30f3\u540d]/ \u306b\u30a2\u30af\u30bb\u30b9\u3057\u3066\u3001\n$ bundle exec rails server -b 0.0.0.0\n\u3067\u8d77\u52d5\u3057\u305f\u5834\u5408\u3068\u540c\u3058\u753b\u9762\u304c\u8868\u793a\u3055\u308c\u3066\u3044\u308c\u3070OK\u3002\n\n# Unicorn \u3068\u306f\nRails \u6a19\u6e96\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30b5\u30fc\u30d0\u306f\u91cd\u3044\u306e\u3067\u3001\u52d5\u4f5c\u304c\u8efd\u3044 Unicorn \u3092\u5c0e\u5165\u3057\u3066\u307f\u308b\u3002\n\n# \u74b0\u5883\u69cb\u7bc9\n[Chef-Solo + Berkshelf \u3067 Rails 4 \u306e\u958b\u767a\u74b0\u5883\u3092\u69cb\u7bc9] (http://qiita.com/Salinger/items/267f7ac4720f44eb6bfe) \u3092\u53c2\u8003\u306b\u3002\n\u4ed6\u306e\u30b5\u30fc\u30d0\u3068\u306f\u5225\u306e\u30d7\u30e9\u30a4\u30d9\u30fc\u30c8IP\u3092\u5272\u308a\u5f53\u3066\u3066\u304a\u304f\u3002\n\n# \u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u4f5c\u6210\n\u4ee5\u4e0b\u306e\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3057\u3066\u3044\u304f\u3002\n\n```\n$ mkdir ~/projects/unicorn_sample\n$ cd ~/projects/unicorn_sample\n$ bundle init\n```\n\n\u4f5c\u6210\u3055\u308c\u305fGemfile\u3092\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u66f8\u304d\u63db\u3048\u308b\u3002\n\n```ruby:Gemfile\nsource 'https://rubygems.org'\n\ngem 'rails', '4.2.0'\n```\n\n\u4ee5\u4e0b\u306e\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3002\n\n```\n$ bundle install --path vendor/bundle\n$ bundle exec rails new .\n...\nOverwrite /home/vagrant/projects/unicorn_sample/Gemfile? (enter \"h\" for help) [Ynaqdh] Y\n...\n```\n\nGemfile \u3092\u4e0b\u8a18\u306e\u3088\u3046\u306b\u66f8\u304d\u63db\u3048\u308b\u3002\n\n```ruby:Gemfile\nsource 'https://rubygems.org'\n\ngem 'rails', '4.2.0'\ngem 'sqlite3'\ngem 'sass-rails', '~> 5.0'\ngem 'uglifier', '>= 1.3.0'\ngem 'coffee-rails', '~> 4.1.0'\ngem 'therubyracer', platforms: :ruby\ngem 'jquery-rails'\ngem 'turbolinks'\ngem 'jbuilder', '~> 2.0'\ngem 'sdoc', '~> 0.4.0', group: :doc\ngem 'bcrypt', '~> 3.1.7'\ngem 'unicorn'\n\ngroup :development, :test do\n  gem 'byebug'\n  gem 'web-console', '~> 2.0'\n  gem 'spring'\nend\n```\n\n\u4e0b\u8a18\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3002\n\n```\n$ bundle install --path vendor/bundle\n```\n\n# \u30c6\u30b9\u30c8\u7528\u30a2\u30d7\u30ea\u4f5c\u6210\n\n```\n$ bundle exec rails generate scaffold board title:string text:string\n$ rake db:migrate\n```\n\n`config/routes.rb` \u3092\u4e0b\u8a18\u306e\u3088\u3046\u306b\u7de8\u96c6\n\n```ruby:config/routes.rb\nRails.application.routes.draw do\n  resources :boards\n  root \u201cboards#index\"\nend\n```\n\n\u4e0b\u8a18\u30b3\u30de\u30f3\u30c9\u3067\u30b5\u30fc\u30d0\u30fc\u3092\u8d77\u52d5\u3057\u3001\u30da\u30fc\u30b8\u304c\u898b\u3048\u308b\u304b\u3069\u3046\u304b\u78ba\u8a8d\u3057\u3066\u304a\u304f\u3002\n\n```\n$ bundle exec rails server -b 0.0.0.0\n```\n\n# Unicorn \u306e\u8a2d\u5b9a\n`config/unicorn.rb` \u3092\u4e0b\u8a18\u306e\u5185\u5bb9\u3067\u65b0\u898f\u306b\u4f5c\u6210 ([\u53c2\u8003\u8cc7\u6599](https://github.com/herokaijp/devcenter/wiki/Rails-unicorn))\u3002\n\n```ruby:config/unicorn.rb\n# -*- coding: utf-8 -*-\nworker_processes Integer(ENV[\"WEB_CONCURRENCY\"] || 3)\ntimeout 15\npreload_app true  # \u66f4\u65b0\u6642\u30c0\u30a6\u30f3\u30bf\u30a4\u30e0\u7121\u3057\n\nlisten \"/tmp/unicorn.sock\"\npid \"/tmp/unicorn.pid\"\n\nbefore_fork do |server, worker|\n  Signal.trap 'TERM' do\n    puts 'Unicorn master intercepting TERM and sending myself QUIT instead'\n    Process.kill 'QUIT', Process.pid\n  end\n\n  defined?(ActiveRecord::Base) and\n    ActiveRecord::Base.connection.disconnect!\nend\n\nafter_fork do |server, worker|\n  Signal.trap 'TERM' do\n    puts 'Unicorn worker intercepting TERM and doing nothing. Wait for master to send QUIT'\n  end\n\n  defined?(ActiveRecord::Base) and\n    ActiveRecord::Base.establish_connection\nend\n\n# \u30ed\u30b0\u306e\u51fa\u529b\nstderr_path File.expand_path('log/unicorn.log', ENV['RAILS_ROOT'])\nstdout_path File.expand_path('log/unicorn.log', ENV['RAILS_ROOT'])\n```\n\n\u4e0b\u8a18\u30b3\u30de\u30f3\u30c9\u3067 unicorn \u8d77\u52d5\u3002\n\n```\n$ bundle exec unicorn_rails -c config/unicorn.rb -E production -D\n```\n\n\u8d77\u52d5\u3067\u304d\u3066\u3044\u308b\u304b\u3069\u3046\u304b\u306f\u4e0b\u8a18\u30b3\u30de\u30f3\u30c9\u3067\u78ba\u8a8d\u3067\u304d\u308b\u3002\n\n```\n$ ps -ef | grep unicorn | grep -v grep\n```\n\nUnicorn \u3092\u6b62\u3081\u308b\u306b\u306f\u4e0b\u8a18\u306e\u30b3\u30de\u30f3\u30c9\u3067\u30d7\u30ed\u30bb\u30b9\u3092Kill\u3059\u308b\u3002\n\n```\n$ kill -9 [Process ID]\n```\n\n\u3053\u306e\u307e\u307e\u3060\u3068\u8d77\u52d5 & \u7d42\u4e86\u304c\u9762\u5012\u306a\u306e\u3067\u3001Rake\u306etask \u306b Unicorn \u306e\u8d77\u52d5 & \u7d42\u4e86\u306e\u8a2d\u5b9a\u3092\u8a18\u8ff0\u3059\u308b\u3002\n[\u3053\u306e\u30da\u30fc\u30b8](http://qiita.com/teitei_tk/items/2f997d1b916905da6c80)\u3092\u53c2\u8003\u306b\u3057\u305f\u3002\n\nTask\u306e\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3059\u308b\u3002\n```\n$ bundle exec rails generate task unicorn\n```\n\n\u4ee5\u4e0b\u306e\u5185\u5bb9\u306b\u5909\u66f4\u3059\u308b\u3002\n\n```ruby:lib/tasks/unicorn.rake\nnamespace :unicorn do\n  ##\n  # Tasks\n  ##\n  desc \"Start unicorn for development env.\"\n  task(:start) {\n    config = Rails.root.join('config', 'unicorn.rb')\n    sh \"bundle exec unicorn_rails -c #{config} -E development -D\"\n  }\n\n  desc \"Stop unicorn\"\n  task(:stop) { unicorn_signal :QUIT }\n\n  desc \"Restart unicorn with USR2\"\n  task(:restart) { unicorn_signal :USR2 }\n\n  desc \"Increment number of worker processes\"\n  task(:increment) { unicorn_signal :TTIN }\n\n  desc \"Decrement number of worker processes\"\n  task(:decrement) { unicorn_signal :TTOU }\n\n  desc \"Unicorn pstree (depends on pstree command)\"\n  task(:pstree) do\n    sh \"pstree '#{unicorn_pid}'\"\n  end\n\n  def unicorn_signal signal\n    Process.kill signal, unicorn_pid\n  end\n\n  def unicorn_pid\n    begin\n      File.read(\"/tmp/unicorn.pid\").to_i\n    rescue Errno::ENOENT\n      raise \"Unicorn doesn't seem to be running\"\n    end\n  end\n\nend\n```\n\n\u4e0b\u8a18\u306e\u30b3\u30de\u30f3\u30c9\u3067Unicorn\u3092\u8d77\u52d5\u3001\u505c\u6b62\u51fa\u6765\u308b\u3088\u3046\u306b\u306a\u308b\u3002\n\n```\n$ bundle exec rake unicorn:start\n$ bundle exec rake unicorn:stop\n```\n\n\u3068\u308a\u3042\u3048\u305a\u3001Unicorn\u3092\u8d77\u52d5\u3057\u3066\u304a\u304f\u3002\n\n# Nginx \u306e\u8a2d\u5b9a\n\u4e0b\u8a18\u30b3\u30de\u30f3\u30c9\u3067\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u306e\u4f5c\u6210\u3092\u884c\u3046\u3002\n\n```\n$ sudo cp /etc/nginx/conf.d/default.conf /etc/nginx/conf.d/local.conf\n$ sudo mv /etc/nginx/conf.d/default.conf /etc/nginx/conf.d/default.conf.bk\n```\n\n`/etc/nginx/conf.d/local.conf` \u3092\u4e0b\u8a18\u306e\u3088\u3046\u306b\u66f8\u304d\u63db\u3048\u308b\u3002\nupstream \u306e server \u306e\u90e8\u5206\u306f Unicorn \u5074\u3067\u6307\u5b9a\u3057\u305f sock \u30d5\u30a1\u30eb\u306e\u5834\u6240\u3092\u3001\nroot \u306e\u90e8\u5206\u306f\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u30eb\u30fc\u30c8\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u6307\u5b9a\u3059\u308b\u3002\n\n```ruby:/etc/nginx/conf.d/local.conf\nupstream unicorn {\n  server unix:/home/vagrant/projects/unicorn_sample/tmp/unicorn.sock;\n}\n\nserver {\n  listen 80 default_server;\n  server_name \u30b5\u30fc\u30d0\u540d;\n\n  access_log /var/log/nginx/sample_access.log;\n  error_log /var/log/nginx/sample_error.log;\n\n  root /home/vagrant/projects/unicorn_sample;\n\n  client_max_body_size 100m;\n  error_page 404 /404.html;\n  error_page 500 502 503 504 /500.html;\n  try_files $uri/index.html $uri @unicorn;\n\n  location @unicorn {\n    proxy_set_header X-Real-IP $remote_addr;\n    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n    proxy_set_header Host $http_host;\n    proxy_pass http://unicorn;\n  }\n}\n```\n\nNginx \u3092(\u518d)\u8d77\u52d5\u3059\u308b\u3002\n\n```\n$ sudo service nginx restart\n```\n\n# \u52d5\u4f5c\u78ba\u8a8d\nhttp://[\u30c9\u30e1\u30a4\u30f3\u540d]/ \u306b\u30a2\u30af\u30bb\u30b9\u3057\u3066\u3001\n`$ bundle exec rails server -b 0.0.0.0`\n\u3067\u8d77\u52d5\u3057\u305f\u5834\u5408\u3068\u540c\u3058\u753b\u9762\u304c\u8868\u793a\u3055\u308c\u3066\u3044\u308c\u3070OK\u3002\n\n![D3A692FF-37E8-4124-9F3B-A2A3D87B4ADD.png](https://qiita-image-store.s3.amazonaws.com/0/58390/9604ce6f-5756-79cb-4686-bbb37e08546c.png)\n\n", "tags": ["Rails4.2", "nginx", "unicorn"]}