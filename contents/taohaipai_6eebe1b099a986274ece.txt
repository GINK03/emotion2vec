{"context": "rails\u3058\u3083\u306a\u3044\u30b5\u30fc\u30d3\u30b9\u306e\u7ba1\u7406/\u96c6\u8a08\u753b\u9762\u3092\u4f5c\u308a\u305f\u304f\u306a\u308b\u4e8b\u304c\u3042\u3063\u305f\u306e\u3067\u30e1\u30e2\u3002on AWS\u3002\n\n\u524d\u63d0\n\n\u7ba1\u7406\u5bfe\u8c61\uff1a\u4f8b\u3048\u3070ec2\u306b\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30b5\u30fc\u30d0(java)\u3001rds\u306eDB(mysql)\u3067\u69cb\u7bc9\u3055\u308c\u3066\u3044\u308b\u3002\n\u7ba1\u7406\u753b\u9762\uff1a\u5225\u306eec2\u3068\u5225\u306erds(\u540c\u3058rds\u3067\u3082DB\u5206\u3051\u308c\u3070\u3044\u3044\u3051\u3069)\u306b\u4f5c\u308b\u3002\n\u958b\u767a\u74b0\u5883\u306e\u69cb\u7bc9\u306f\u7701\u7565\u3002\n\n\n\u30c7\u30d7\u30ed\u30a4\u5148\u306e\u30b7\u30b9\u30c6\u30e0\u69cb\u6210\u3068\u4e3b\u306agem\n\ncentOS 6.5\nruby 2.2.2\nrails 4.1.6\nnginx 1.9.11\nunicorn 5.0\nactiveadmin 1.0.0pre2\ndevise 3.5.5\ncancancan 1.13\nwhenever 0.9\n\n\n\u958b\u767a\n\n\u7ba1\u7406\u5bfe\u8c61\u3068\u7ba1\u7406\u753b\u9762\u81ea\u4f53\u306eDB\u304c\u7570\u306a\u308b\u3051\u3069\u3069\u3046\u3059\u308b\u304b\uff1f\n\u30b3\u30fc\u30c9\u3067\u63a5\u7d9a\u5148\u3092\u5206\u3051\u308b\u4e8b\u304c\u5fc5\u8981\u3002\u305d\u308c\u305e\u308c\u306e\u63a5\u7d9a\u5148\u3092\u5b9a\u7fa9\u3057\u305fdatabase.yml\u3092\u4f5c\u3063\u305f\u4e0a\u3067\u3001\u3069\u3061\u3089\u306b\u63a5\u7d9a\u3059\u308b\u304b\u3092Model\u5358\u4f4d\u3067\u5206\u3051\u308b\u30a4\u30e1\u30fc\u30b8\u3002\u5177\u4f53\u7684\u306b\u306f\u3001\n\ndatabase.yml\ndefault: &default\n  adapter: mysql2\n  encoding: utf8\n  pool: 5\n  username: {\u30e6\u30fc\u30b6}\n  password: {\u30d1\u30b9\u30ef\u30fc\u30c9}\n  socket: /tmp/mysql.sock\n\n# \u7ba1\u7406/\u96c6\u8a08\u753b\u9762\u7528DB\u306e\u63a5\u7d9a\u5148\ndevelopment:\n  <<: *default\n  host: {\u7ba1\u7406\u30fb\u96c6\u8a08\u753b\u9762\u7528DB/\u958b\u767a\u74b0\u5883\u306e\u30a8\u30f3\u30c9\u30dd\u30a4\u30f3\u30c8}\n\nproduction:\n  <<: *default\n  host: {\u7ba1\u7406\u30fb\u96c6\u8a08\u753b\u9762\u7528DB/\u672c\u756a\u74b0\u5883\u306e\u30a8\u30f3\u30c9\u30dd\u30a4\u30f3\u30c8}\n  database: {DB\u540d}\n  username: {\u30e6\u30fc\u30b6}\n  password: {\u30d1\u30b9\u30ef\u30fc\u30c9}\n\n\n# \u96c6\u8a08\u5bfe\u8c61DB\u306e\u63a5\u7d9a\u5148\ntarget_development:\n  <<: *default\n  host: {\u96c6\u8a08\u5bfe\u8c61DB/\u958b\u767a\u74b0\u5883\u306e\u30a8\u30f3\u30c9\u30dd\u30a4\u30f3\u30c8}\n\ntarget_production:\n  <<: *default\n  host: {\u96c6\u8a08\u5bfe\u8c61DB/\u672c\u756a\u74b0\u5883\u306e\u30a8\u30f3\u30c9\u30dd\u30a4\u30f3\u30c8}\n  database: {DB\u540d}\n  username: {\u30e6\u30fc\u30b6}\n  password: {\u30d1\u30b9\u30ef\u30fc\u30c9}\n\n\n\u3068\u3057\u305f\u5834\u5408\u3001\u96c6\u8a08\u5bfe\u8c61\u7528\u306eDB\u306eModel\u3092\u6b21\u306e\u30af\u30e9\u30b9\u3092\u7d99\u627f\u3057\u3066\u4f5c\u308b\u3002\n\ntarget.rb\nclass Target < ActiveRecord::Base\n  self.abstract_class = true\n\n  if Rails.env == 'production'\n    establish_connection(:target_production)\n  else\n    establish_connection(:target_development)\n  end\nend\n\n\n\u7ba1\u7406\u30fb\u96c6\u8a08\u7528\u306eDB\u306f\u666e\u901a\u306bActiveRecord::Base\u3092\u7d99\u627f\u3057\u3066\u4f5c\u308c\u3070OK\u3002\n\n\u8a8d\u8a3c\u6a5f\u80fd\u304c\u6b32\u3057\u3044\n\u8a8d\u8a3c\u6a5f\u80fd\u306fdevise\u3067\u7c21\u5358\u306b\u3067\u304d\u308b\u3002\nactiveadmin\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3067\u81ea\u52d5\u751f\u6210\u3055\u308c\u305fadmin_user\u542b\u30803\u3064\u306e\u30e2\u30c7\u30eb\u306b\u3064\u3044\u3066\u3001\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u3068\u30e2\u30c7\u30eb\u3092\u4f5c\u6210\u3059\u308b\u3002admin_user\u306f\u7ba1\u7406/\u96c6\u8a08\u753b\u9762\u306e\u30e6\u30fc\u30b6\u3001admin_role\u306f\u6a29\u9650\u3001admin_user_admin_role\u306f\u4e2d\u9593\u30c6\u30fc\u30d6\u30eb\u3002\n\ndb/migrate/\u301c_devise_create_admin_users.rb\nclass DeviseCreateAdminUsers < ActiveRecord::Migration\n  def change\n    create_table(:admin_users) do |t|\n      ## Database authenticatable\n      t.string :email,              null: false, default: \"\"\n      t.string :encrypted_password, null: false, default: \"\"\n\n      ## Recoverable\n      t.string   :reset_password_token\n      t.datetime :reset_password_sent_at\n\n      ## Rememberable\n      t.datetime :remember_created_at\n\n      ## Trackable\n      t.integer  :sign_in_count, default: 0, null: false\n      t.datetime :current_sign_in_at\n      t.datetime :last_sign_in_at\n      t.string   :current_sign_in_ip\n      t.string   :last_sign_in_ip\n\n      ## Confirmable\n      t.string   :confirmation_token\n      t.datetime :confirmed_at\n      t.datetime :confirmation_sent_at\n      t.string   :unconfirmed_email # Only if using reconfirmable\n\n      ## Lockable\n      t.integer  :failed_attempts, default: 0, null: false # Only if lock strategy is :failed_attempts\n      t.string   :unlock_token # Only if unlock strategy is :email or :both\n      t.datetime :locked_at\n\n\n      t.timestamps null: false\n    end\n\n    add_index :admin_users, :email,                unique: true\n    add_index :admin_users, :reset_password_token, unique: true\n    add_index :admin_users, :confirmation_token,   unique: true\n    add_index :admin_users, :unlock_token,         unique: true\n  end\nend\n\n\n\nmodel/admin_user.rb\nclass AdminUser < ActiveRecord::Base\n  has_many :admin_user_admin_roles\n  has_many :admin_roles, through: :admin_user_admin_roles\n\n  # Include default devise modules. Others available are:\n  # :confirmable, :lockable, :timeoutable and :omniauthable\n  devise :database_authenticatable,\n         :recoverable, :rememberable, :trackable, :validatable,\n         :confirmable, :lockable, :timeoutable\n\n  def has_role?(admin_role_sym)\n    admin_roles.any? { |r| r.name.underscore.downcase.to_sym == admin_role_sym }\n  end\nend\n\n\n\ndb/migrate/\u301ccreate_admin_roles.rb\nclass CreateAdminRoles < ActiveRecord::Migration\n  def change\n    create_table :admin_roles do |t|\n      t.string :name\n\n      t.timestamps\n    end\n    add_index :admin_roles, :name, :unique => true\n  end\nend\n\n\n\nmodel/admin_role.rb\nclass AdminRole < ActiveRecord::Base\n  has_many :admin_user_admin_roles\n  has_many :admin_users, through: :admin_user_admin_roles\nend\n\n\n\ndb/migrate/\u301ccreate_admin_user_admin_roles.rb\nclass CreateAdminUserAdminRoles < ActiveRecord::Migration\n  def change\n    create_table :admin_user_admin_roles do |t|\n      t.integer :admin_role_id\n      t.integer :admin_user_id\n\n      t.timestamps\n    end\n    add_index(:admin_user_admin_roles, :admin_role_id)\n    add_index(:admin_user_admin_roles, :admin_user_id, unique: true)\n  end\nend\n\n\n\nmodel/admin_user_admin_role.rb\nclass AdminUserAdminRole < ActiveRecord::Base\n  belongs_to :admin_user\n  belongs_to :admin_role\nend\n\n\nadmin_user.rb\u306e\u69d8\u3005\u306a\u6a5f\u80fd\u306f\u3001activeadmin\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u6642\u306b\u30b3\u30e1\u30f3\u30c8\u30a2\u30a6\u30c8\u3055\u308c\u3066\u3044\u308b\u5c5e\u6027\u3092\u6709\u52b9\u306b\u3059\u308b\u3068\u4f7f\u3048\u308b\u3088\u3046\u306b\u306a\u308b\u3002confirmable\u3068\u304b\u3002\u5408\u308f\u305b\u3066migration\u3082\u6709\u52b9\u306b\u3057\u3066\u304a\u304f\u3002\n\u307e\u305f\u3001confirmable\u306a\u3069\u3067\u30e1\u30fc\u30eb\u9001\u4fe1\u3067\u304d\u308b\u3088\u3046\u306b\u3057\u3068\u304b\u306a\u3051\u308c\u3070\u3044\u3051\u306a\u3044\u306e\u3067\u305d\u308c\u3082\u3084\u3063\u3066\u304a\u304f\u3002AWS\u306a\u306e\u3067SES\u4f7f\u3063\u3066action_mailer\u3067\u30e1\u30fc\u30eb\u9001\u308b\u3001\u306a\u3069\u3002\n\u4ee5\u4e0a\u3067model\u304c\u51fa\u6765\u4e0a\u304c\u3063\u305f\u306e\u3067\u3001\u30e6\u30fc\u30b6\u306e\u8ffd\u52a0\u7de8\u96c6\u524a\u9664\u304c\u51fa\u6765\u308b\u3088\u3046admin_user.rb\u3092\u597d\u307f\u3067\u30ab\u30b9\u30bf\u30de\u30a4\u30ba\u3057\u3066\u4f7f\u3046\u3002\u4f8b\u3048\u3070\u4e0b\u8a18\u306f\u521d\u671f\u30d1\u30b9\u30ef\u30fc\u30c9\u3092\u81ea\u52d5\u3067\u4f5c\u3063\u3066\u30e1\u30fc\u30eb\u3067\u9001\u4fe1\u3059\u308b\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u308b\u3002\n\nadmin/admin_user.rb\nActiveAdmin.register AdminUser do\n  permit_params :email, :password, :password_confirmation, admin_role_ids: []\n\n  index :download_links => false do\n    selectable_column\n    id_column\n    column :admin_roles do |f|\n      f.admin_roles.size > 0 ? f.admin_roles.map { |r| r.name }.join(\", \") : ''\n    end\n    column :email\n    column :current_sign_in_at\n    column :sign_in_count\n    column :created_at\n    actions\n  end\n\n  filter :email\n  filter :admin_role\n  filter :current_sign_in_at\n  filter :sign_in_count\n  filter :created_at\n\n  form do |f|\n    f.inputs \"Admin Details\" do\n      f.input :email\n      f.input :admin_roles\n    end\n    f.actions\n  end\n\n  controller do\n    def create\n      if params[:admin_user][:password] == params[:admin_user][:email]\n        redirect_to new_admin_admin_user_path, alert: '\u30e1\u30fc\u30eb\u30a2\u30c9\u30ec\u30b9\u3068\u540c\u3058\u6587\u5b57\u5217\u3092\u30d1\u30b9\u30ef\u30fc\u30c9\u306b\u8a2d\u5b9a\u3059\u308b\u4e8b\u306f\u3067\u304d\u307e\u305b\u3093'\n        return\n      end\n      generated_password = Devise.friendly_token.first(9)\n      params[:admin_user][:password] = generated_password\n      params[:admin_user][:password_confirmation] = generated_password\n      InitialPassword.send_generated_password(params[:admin_user][:email], generated_password).deliver\n      super\n    end\n    def update\n      if params[:admin_user][:password] == params[:admin_user][:email]\n        redirect_to edit_admin_admin_user_path, alert: '\u30e1\u30fc\u30eb\u30a2\u30c9\u30ec\u30b9\u3068\u540c\u3058\u6587\u5b57\u5217\u3092\u30d1\u30b9\u30ef\u30fc\u30c9\u306b\u8a2d\u5b9a\u3059\u308b\u4e8b\u306f\u3067\u304d\u307e\u305b\u3093'\n        return\n      end\n      if params[:admin_user][:password].blank?\n        params[:admin_user].delete(\"password\")\n        params[:admin_user].delete(\"password_confirmation\")\n      end\n      super\n    end\n  end\nend\n\n\n\nmailers/admin_user.rb\nclass InitialPassword < ActionMailer::Base\n  default from: 'hogehoge@example.com'\n  default reply_to: 'fugafuga@example.com'\n\n  def send_generated_password(address, generated_password)\n    @generated_password = generated_password\n    mail to: address, subject: '\u521d\u671f\u30d1\u30b9\u30ef\u30fc\u30c9'\n  end\nend\n\n\n\n\u6a29\u9650\u7ba1\u7406\u304c\u3057\u305f\u3044\ncancancan\u3067\u51fa\u6765\u308b\u3002rails g cancancan:ability\u3067\u4f5c\u3063\u305f\u30d5\u30a1\u30a4\u30eb\u3092\u3001super\uff08\u5168\u64cd\u4f5c\u53ef\u80fd\uff09/admin\uff08\u30e6\u30fc\u30b6\u3068\u6a29\u9650\u306e\u8ffd\u52a0\u30fb\u7de8\u96c6\u30fb\u524a\u9664\u3060\u3051NG\uff09/power\uff08general\u3067\u95b2\u89a7\u3067\u304d\u308b\u30da\u30fc\u30b8\u306b\u52a0\u3048\u3066\u79d8\u533f\u6027\u306e\u9ad8\u3044\u30da\u30fc\u30b8\u306e\u95b2\u89a7\u53ef\u80fd\uff09/general\uff08\u30c0\u30c3\u30b7\u30e5\u30dc\u30fc\u30c9\u306a\u3069\u4e00\u90e8\u306e\u30da\u30fc\u30b8\u306e\u95b2\u89a7\u306e\u307f\u53ef\u80fd\uff09\u306e\u6a29\u9650\u3067\u5206\u3051\u308b\u5834\u5408\u306f\u6b21\u306e\u3088\u3046\u306b\u3059\u308b\u3002\n\nmodels/ability.rb\n\nclass Ability\n  include CanCan::Ability\n\n  def initialize(user)\n    user || AdminUser.new\n    send(user.admin_roles.first.name.downcase)\n  end\n\n  def super\n    can :manage, :all\n  end\n\n  def admin\n    can :manage, :all\n    cannot :manage, AdminUser\n    cannot :manage, AdminRole\n  end\n\n  def power\n    general\n    can :manage, ActiveAdmin::Page, name: \"\u79d8\u533f\u6027\u306e\u9ad8\u3044\u30da\u30fc\u30b8\uff11\"\n    can :manage, ActiveAdmin::Page, name: \"\u79d8\u533f\u6027\u306e\u9ad8\u3044\u30da\u30fc\u30b8\uff12\"\n  end\n\n  def general\n    can :manage, ActiveAdmin::Page, name: \"Dashboard\"\n    can :manage, ActiveAdmin::Page, name: \"\u79d8\u533f\u6027\u306e\u4f4e\u3044\u30da\u30fc\u30b8\uff11\"\n    can :manage, ActiveAdmin::Page, name: \"\u79d8\u533f\u6027\u306e\u4f4e\u3044\u30da\u30fc\u30b8\uff12\"\n  end\nend\n\n\n\u3061\u306a\u307f\u306b\u95b2\u89a7\u306e\u307f\u3067\u826f\u3044\u306e\u306bpower/general\u306bmanage\u6a29\u9650\u3092\u3064\u3051\u3066\u3044\u308b\u7406\u7531\u306fcsv\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3092\u8a31\u53ef\u3057\u305f\u304b\u3063\u305f\u304b\u3089\u3002\n\u307e\u305f\u3001\u5404\u6a29\u9650\u306e\u30ec\u30b3\u30fc\u30c9\u3092\u3092admin_roles\u306b\u30a4\u30f3\u30b5\u30fc\u30c8\u3057\u3066\u304a\u304f\u306e\u3092\u5fd8\u308c\u306a\u3044\u4e8b\u3002\n\n\u30d0\u30c3\u30c1\u3067\u5b9a\u671f\u7684\u306b\u96c6\u8a08\u5024\u3092\u4fdd\u5b58\u3057\u305f\u3044\nwhenever\u4f7f\u3063\u305f\u3089\u7c21\u5358\u306b\u3067\u304d\u308b\u3002\u96c6\u8a08\u7528\u30c6\u30fc\u30d6\u30ebaggregations\u3092\u4f5c\u3063\u305f\u4e0a\u3067\u3001\u30c7\u30fc\u30bf\u4f5c\u6210\u3059\u308b\u30b3\u30fc\u30c9\u3068\u3044\u3064\u96c6\u8a08\u3059\u308b\u304b\u3092\u6c7a\u3081\u308b\u30b3\u30fc\u30c9\u3092\u4f5c\u308b\u3002\n\nlib/tasks/aggregation.rake\nnamespace :aggregation do\n  desc 'aggregate basic data'\n  task :basic => :environment do\n    {\u96c6\u8a08\u3057\u3066aggregations\u306b\u30c7\u30fc\u30bf\u3092\u7a81\u3063\u8fbc\u3080\u30b3\u30fc\u30c9}\n  end\nend\n\n\n\nconfig/schedule.rb\nrequire File.expand_path(File.dirname(__FILE__) + \"/environment\")\n\nset :environment, @environment\nset :output, Rails.root.join('log', 'cron.log')\n\nevery 1.day, at: '12pm' do\n  rake 'aggregation:basic'\nend\n\n\n\u3053\u308c\u3067\u6bce\u65e512:00\u306b\u96c6\u8a08\u30c7\u30fc\u30bf\u3092\u4fdd\u5b58\u3059\u308b\u4e8b\u304c\u53ef\u80fd\u3002bundle exec whenever -s 'environment=production' --update-crontab\u3067cron\u306b\u8a2d\u5b9a\u3057\u3066\u7d42\u308f\u308a\u3002\n\u540c\u3058\u3088\u3046\u306b\u3057\u3066\u96c6\u8a08\u7d50\u679c\u3092\u30e1\u30fc\u30eb\u3067\u9001\u4fe1\u3059\u308b\u4e8b\u3082\u53ef\u80fd\u3002\n\n\u88dc\u8db3\uff1a\u30c7\u30d7\u30ed\u30a4\u5148\u306b\u74b0\u5883\u69cb\u7bc9\u3059\u308b\u6642\u53c2\u8003\u306b\u3057\u305f\u30da\u30fc\u30b8\nruby\u3002\nhttp://www.task-notes.com/entry/20150624/1435114800\n\u4f9d\u5b58\u95a2\u4fc2\u3067\u8db3\u308a\u306a\u3044\u3082\u306e\u304c\u3042\u3063\u3066\u6012\u3089\u308c\u305f\u3089\u6307\u793a\u901a\u308a\u5165\u308c\u308b\u3002mysql-devel\u3068\u304b\u3002\nnginx\u3002yum\u3067\u3002\nhttp://qiita.com/nenokido2000/items/3cbb76dac2b9940f339e \nrails\u3058\u3083\u306a\u3044\u30b5\u30fc\u30d3\u30b9\u306e\u7ba1\u7406/\u96c6\u8a08\u753b\u9762\u3092\u4f5c\u308a\u305f\u304f\u306a\u308b\u4e8b\u304c\u3042\u3063\u305f\u306e\u3067\u30e1\u30e2\u3002on AWS\u3002\n## \u524d\u63d0\n- \u7ba1\u7406\u5bfe\u8c61\uff1a\u4f8b\u3048\u3070ec2\u306b\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30b5\u30fc\u30d0(java)\u3001rds\u306eDB(mysql)\u3067\u69cb\u7bc9\u3055\u308c\u3066\u3044\u308b\u3002\n- \u7ba1\u7406\u753b\u9762\uff1a\u5225\u306eec2\u3068\u5225\u306erds(\u540c\u3058rds\u3067\u3082DB\u5206\u3051\u308c\u3070\u3044\u3044\u3051\u3069)\u306b\u4f5c\u308b\u3002\n- \u958b\u767a\u74b0\u5883\u306e\u69cb\u7bc9\u306f\u7701\u7565\u3002\n\n#### \u30c7\u30d7\u30ed\u30a4\u5148\u306e\u30b7\u30b9\u30c6\u30e0\u69cb\u6210\u3068\u4e3b\u306agem\n- centOS 6.5\n- ruby 2.2.2\n- rails 4.1.6\n- nginx 1.9.11\n- unicorn 5.0\n- activeadmin 1.0.0pre2\n- devise 3.5.5\n- cancancan 1.13\n- whenever 0.9\n\n## \u958b\u767a\n### \u7ba1\u7406\u5bfe\u8c61\u3068\u7ba1\u7406\u753b\u9762\u81ea\u4f53\u306eDB\u304c\u7570\u306a\u308b\u3051\u3069\u3069\u3046\u3059\u308b\u304b\uff1f\n\u30b3\u30fc\u30c9\u3067\u63a5\u7d9a\u5148\u3092\u5206\u3051\u308b\u4e8b\u304c\u5fc5\u8981\u3002\u305d\u308c\u305e\u308c\u306e\u63a5\u7d9a\u5148\u3092\u5b9a\u7fa9\u3057\u305fdatabase.yml\u3092\u4f5c\u3063\u305f\u4e0a\u3067\u3001\u3069\u3061\u3089\u306b\u63a5\u7d9a\u3059\u308b\u304b\u3092Model\u5358\u4f4d\u3067\u5206\u3051\u308b\u30a4\u30e1\u30fc\u30b8\u3002\u5177\u4f53\u7684\u306b\u306f\u3001\n\n```yaml:database.yml\ndefault: &default\n  adapter: mysql2\n  encoding: utf8\n  pool: 5\n  username: {\u30e6\u30fc\u30b6}\n  password: {\u30d1\u30b9\u30ef\u30fc\u30c9}\n  socket: /tmp/mysql.sock\n\n# \u7ba1\u7406/\u96c6\u8a08\u753b\u9762\u7528DB\u306e\u63a5\u7d9a\u5148\ndevelopment:\n  <<: *default\n  host: {\u7ba1\u7406\u30fb\u96c6\u8a08\u753b\u9762\u7528DB/\u958b\u767a\u74b0\u5883\u306e\u30a8\u30f3\u30c9\u30dd\u30a4\u30f3\u30c8}\n\nproduction:\n  <<: *default\n  host: {\u7ba1\u7406\u30fb\u96c6\u8a08\u753b\u9762\u7528DB/\u672c\u756a\u74b0\u5883\u306e\u30a8\u30f3\u30c9\u30dd\u30a4\u30f3\u30c8}\n  database: {DB\u540d}\n  username: {\u30e6\u30fc\u30b6}\n  password: {\u30d1\u30b9\u30ef\u30fc\u30c9}\n\n\n# \u96c6\u8a08\u5bfe\u8c61DB\u306e\u63a5\u7d9a\u5148\ntarget_development:\n  <<: *default\n  host: {\u96c6\u8a08\u5bfe\u8c61DB/\u958b\u767a\u74b0\u5883\u306e\u30a8\u30f3\u30c9\u30dd\u30a4\u30f3\u30c8}\n\ntarget_production:\n  <<: *default\n  host: {\u96c6\u8a08\u5bfe\u8c61DB/\u672c\u756a\u74b0\u5883\u306e\u30a8\u30f3\u30c9\u30dd\u30a4\u30f3\u30c8}\n  database: {DB\u540d}\n  username: {\u30e6\u30fc\u30b6}\n  password: {\u30d1\u30b9\u30ef\u30fc\u30c9}\n```\n\n\u3068\u3057\u305f\u5834\u5408\u3001\u96c6\u8a08\u5bfe\u8c61\u7528\u306eDB\u306eModel\u3092\u6b21\u306e\u30af\u30e9\u30b9\u3092\u7d99\u627f\u3057\u3066\u4f5c\u308b\u3002\n\n```ruby:target.rb\nclass Target < ActiveRecord::Base\n  self.abstract_class = true\n\n  if Rails.env == 'production'\n    establish_connection(:target_production)\n  else\n    establish_connection(:target_development)\n  end\nend\n```\n\n\u7ba1\u7406\u30fb\u96c6\u8a08\u7528\u306eDB\u306f\u666e\u901a\u306b`ActiveRecord::Base`\u3092\u7d99\u627f\u3057\u3066\u4f5c\u308c\u3070OK\u3002\n\n\n### \u8a8d\u8a3c\u6a5f\u80fd\u304c\u6b32\u3057\u3044\n\u8a8d\u8a3c\u6a5f\u80fd\u306fdevise\u3067\u7c21\u5358\u306b\u3067\u304d\u308b\u3002\nactiveadmin\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3067\u81ea\u52d5\u751f\u6210\u3055\u308c\u305fadmin_user\u542b\u30803\u3064\u306e\u30e2\u30c7\u30eb\u306b\u3064\u3044\u3066\u3001\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u3068\u30e2\u30c7\u30eb\u3092\u4f5c\u6210\u3059\u308b\u3002admin_user\u306f\u7ba1\u7406/\u96c6\u8a08\u753b\u9762\u306e\u30e6\u30fc\u30b6\u3001admin_role\u306f\u6a29\u9650\u3001admin_user_admin_role\u306f\u4e2d\u9593\u30c6\u30fc\u30d6\u30eb\u3002\n\n```ruby:db/migrate/\u301c_devise_create_admin_users.rb\nclass DeviseCreateAdminUsers < ActiveRecord::Migration\n  def change\n    create_table(:admin_users) do |t|\n      ## Database authenticatable\n      t.string :email,              null: false, default: \"\"\n      t.string :encrypted_password, null: false, default: \"\"\n\n      ## Recoverable\n      t.string   :reset_password_token\n      t.datetime :reset_password_sent_at\n\n      ## Rememberable\n      t.datetime :remember_created_at\n\n      ## Trackable\n      t.integer  :sign_in_count, default: 0, null: false\n      t.datetime :current_sign_in_at\n      t.datetime :last_sign_in_at\n      t.string   :current_sign_in_ip\n      t.string   :last_sign_in_ip\n\n      ## Confirmable\n      t.string   :confirmation_token\n      t.datetime :confirmed_at\n      t.datetime :confirmation_sent_at\n      t.string   :unconfirmed_email # Only if using reconfirmable\n\n      ## Lockable\n      t.integer  :failed_attempts, default: 0, null: false # Only if lock strategy is :failed_attempts\n      t.string   :unlock_token # Only if unlock strategy is :email or :both\n      t.datetime :locked_at\n\n\n      t.timestamps null: false\n    end\n\n    add_index :admin_users, :email,                unique: true\n    add_index :admin_users, :reset_password_token, unique: true\n    add_index :admin_users, :confirmation_token,   unique: true\n    add_index :admin_users, :unlock_token,         unique: true\n  end\nend\n```\n\n```ruby:model/admin_user.rb\nclass AdminUser < ActiveRecord::Base\n  has_many :admin_user_admin_roles\n  has_many :admin_roles, through: :admin_user_admin_roles\n\n  # Include default devise modules. Others available are:\n  # :confirmable, :lockable, :timeoutable and :omniauthable\n  devise :database_authenticatable,\n         :recoverable, :rememberable, :trackable, :validatable,\n         :confirmable, :lockable, :timeoutable\n\n  def has_role?(admin_role_sym)\n    admin_roles.any? { |r| r.name.underscore.downcase.to_sym == admin_role_sym }\n  end\nend\n```\n\n```ruby:db/migrate/\u301ccreate_admin_roles.rb\nclass CreateAdminRoles < ActiveRecord::Migration\n  def change\n    create_table :admin_roles do |t|\n      t.string :name\n\n      t.timestamps\n    end\n    add_index :admin_roles, :name, :unique => true\n  end\nend\n```\n\n```ruby:model/admin_role.rb\nclass AdminRole < ActiveRecord::Base\n  has_many :admin_user_admin_roles\n  has_many :admin_users, through: :admin_user_admin_roles\nend\n```\n\n```ruby:db/migrate/\u301ccreate_admin_user_admin_roles.rb\nclass CreateAdminUserAdminRoles < ActiveRecord::Migration\n  def change\n    create_table :admin_user_admin_roles do |t|\n      t.integer :admin_role_id\n      t.integer :admin_user_id\n\n      t.timestamps\n    end\n    add_index(:admin_user_admin_roles, :admin_role_id)\n    add_index(:admin_user_admin_roles, :admin_user_id, unique: true)\n  end\nend\n```\n\n```ruby:model/admin_user_admin_role.rb\nclass AdminUserAdminRole < ActiveRecord::Base\n  belongs_to :admin_user\n  belongs_to :admin_role\nend\n```\n\nadmin_user.rb\u306e\u69d8\u3005\u306a\u6a5f\u80fd\u306f\u3001activeadmin\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u6642\u306b\u30b3\u30e1\u30f3\u30c8\u30a2\u30a6\u30c8\u3055\u308c\u3066\u3044\u308b\u5c5e\u6027\u3092\u6709\u52b9\u306b\u3059\u308b\u3068\u4f7f\u3048\u308b\u3088\u3046\u306b\u306a\u308b\u3002confirmable\u3068\u304b\u3002\u5408\u308f\u305b\u3066migration\u3082\u6709\u52b9\u306b\u3057\u3066\u304a\u304f\u3002\n\u307e\u305f\u3001confirmable\u306a\u3069\u3067\u30e1\u30fc\u30eb\u9001\u4fe1\u3067\u304d\u308b\u3088\u3046\u306b\u3057\u3068\u304b\u306a\u3051\u308c\u3070\u3044\u3051\u306a\u3044\u306e\u3067\u305d\u308c\u3082\u3084\u3063\u3066\u304a\u304f\u3002AWS\u306a\u306e\u3067SES\u4f7f\u3063\u3066action_mailer\u3067\u30e1\u30fc\u30eb\u9001\u308b\u3001\u306a\u3069\u3002\n\n\u4ee5\u4e0a\u3067model\u304c\u51fa\u6765\u4e0a\u304c\u3063\u305f\u306e\u3067\u3001\u30e6\u30fc\u30b6\u306e\u8ffd\u52a0\u7de8\u96c6\u524a\u9664\u304c\u51fa\u6765\u308b\u3088\u3046admin_user.rb\u3092\u597d\u307f\u3067\u30ab\u30b9\u30bf\u30de\u30a4\u30ba\u3057\u3066\u4f7f\u3046\u3002\u4f8b\u3048\u3070\u4e0b\u8a18\u306f\u521d\u671f\u30d1\u30b9\u30ef\u30fc\u30c9\u3092\u81ea\u52d5\u3067\u4f5c\u3063\u3066\u30e1\u30fc\u30eb\u3067\u9001\u4fe1\u3059\u308b\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u308b\u3002\n\n```ruby:admin/admin_user.rb\nActiveAdmin.register AdminUser do\n  permit_params :email, :password, :password_confirmation, admin_role_ids: []\n\n  index :download_links => false do\n    selectable_column\n    id_column\n    column :admin_roles do |f|\n      f.admin_roles.size > 0 ? f.admin_roles.map { |r| r.name }.join(\", \") : ''\n    end\n    column :email\n    column :current_sign_in_at\n    column :sign_in_count\n    column :created_at\n    actions\n  end\n\n  filter :email\n  filter :admin_role\n  filter :current_sign_in_at\n  filter :sign_in_count\n  filter :created_at\n\n  form do |f|\n    f.inputs \"Admin Details\" do\n      f.input :email\n      f.input :admin_roles\n    end\n    f.actions\n  end\n\n  controller do\n    def create\n      if params[:admin_user][:password] == params[:admin_user][:email]\n        redirect_to new_admin_admin_user_path, alert: '\u30e1\u30fc\u30eb\u30a2\u30c9\u30ec\u30b9\u3068\u540c\u3058\u6587\u5b57\u5217\u3092\u30d1\u30b9\u30ef\u30fc\u30c9\u306b\u8a2d\u5b9a\u3059\u308b\u4e8b\u306f\u3067\u304d\u307e\u305b\u3093'\n        return\n      end\n      generated_password = Devise.friendly_token.first(9)\n      params[:admin_user][:password] = generated_password\n      params[:admin_user][:password_confirmation] = generated_password\n      InitialPassword.send_generated_password(params[:admin_user][:email], generated_password).deliver\n      super\n    end\n    def update\n      if params[:admin_user][:password] == params[:admin_user][:email]\n        redirect_to edit_admin_admin_user_path, alert: '\u30e1\u30fc\u30eb\u30a2\u30c9\u30ec\u30b9\u3068\u540c\u3058\u6587\u5b57\u5217\u3092\u30d1\u30b9\u30ef\u30fc\u30c9\u306b\u8a2d\u5b9a\u3059\u308b\u4e8b\u306f\u3067\u304d\u307e\u305b\u3093'\n        return\n      end\n      if params[:admin_user][:password].blank?\n        params[:admin_user].delete(\"password\")\n        params[:admin_user].delete(\"password_confirmation\")\n      end\n      super\n    end\n  end\nend\n```\n\n```ruby:mailers/admin_user.rb\nclass InitialPassword < ActionMailer::Base\n  default from: 'hogehoge@example.com'\n  default reply_to: 'fugafuga@example.com'\n\n  def send_generated_password(address, generated_password)\n    @generated_password = generated_password\n    mail to: address, subject: '\u521d\u671f\u30d1\u30b9\u30ef\u30fc\u30c9'\n  end\nend\n```\n\n### \u6a29\u9650\u7ba1\u7406\u304c\u3057\u305f\u3044\ncancancan\u3067\u51fa\u6765\u308b\u3002`rails g cancancan:ability`\u3067\u4f5c\u3063\u305f\u30d5\u30a1\u30a4\u30eb\u3092\u3001super\uff08\u5168\u64cd\u4f5c\u53ef\u80fd\uff09/admin\uff08\u30e6\u30fc\u30b6\u3068\u6a29\u9650\u306e\u8ffd\u52a0\u30fb\u7de8\u96c6\u30fb\u524a\u9664\u3060\u3051NG\uff09/power\uff08general\u3067\u95b2\u89a7\u3067\u304d\u308b\u30da\u30fc\u30b8\u306b\u52a0\u3048\u3066\u79d8\u533f\u6027\u306e\u9ad8\u3044\u30da\u30fc\u30b8\u306e\u95b2\u89a7\u53ef\u80fd\uff09/general\uff08\u30c0\u30c3\u30b7\u30e5\u30dc\u30fc\u30c9\u306a\u3069\u4e00\u90e8\u306e\u30da\u30fc\u30b8\u306e\u95b2\u89a7\u306e\u307f\u53ef\u80fd\uff09\u306e\u6a29\u9650\u3067\u5206\u3051\u308b\u5834\u5408\u306f\u6b21\u306e\u3088\u3046\u306b\u3059\u308b\u3002\n\n```ruby:models/ability.rb\n\nclass Ability\n  include CanCan::Ability\n\n  def initialize(user)\n    user || AdminUser.new\n    send(user.admin_roles.first.name.downcase)\n  end\n\n  def super\n    can :manage, :all\n  end\n\n  def admin\n    can :manage, :all\n    cannot :manage, AdminUser\n    cannot :manage, AdminRole\n  end\n\n  def power\n    general\n    can :manage, ActiveAdmin::Page, name: \"\u79d8\u533f\u6027\u306e\u9ad8\u3044\u30da\u30fc\u30b8\uff11\"\n    can :manage, ActiveAdmin::Page, name: \"\u79d8\u533f\u6027\u306e\u9ad8\u3044\u30da\u30fc\u30b8\uff12\"\n  end\n\n  def general\n    can :manage, ActiveAdmin::Page, name: \"Dashboard\"\n    can :manage, ActiveAdmin::Page, name: \"\u79d8\u533f\u6027\u306e\u4f4e\u3044\u30da\u30fc\u30b8\uff11\"\n    can :manage, ActiveAdmin::Page, name: \"\u79d8\u533f\u6027\u306e\u4f4e\u3044\u30da\u30fc\u30b8\uff12\"\n  end\nend\n```\n\n\u3061\u306a\u307f\u306b\u95b2\u89a7\u306e\u307f\u3067\u826f\u3044\u306e\u306bpower/general\u306bmanage\u6a29\u9650\u3092\u3064\u3051\u3066\u3044\u308b\u7406\u7531\u306fcsv\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3092\u8a31\u53ef\u3057\u305f\u304b\u3063\u305f\u304b\u3089\u3002\n\u307e\u305f\u3001\u5404\u6a29\u9650\u306e\u30ec\u30b3\u30fc\u30c9\u3092\u3092admin_roles\u306b\u30a4\u30f3\u30b5\u30fc\u30c8\u3057\u3066\u304a\u304f\u306e\u3092\u5fd8\u308c\u306a\u3044\u4e8b\u3002\n\n\n### \u30d0\u30c3\u30c1\u3067\u5b9a\u671f\u7684\u306b\u96c6\u8a08\u5024\u3092\u4fdd\u5b58\u3057\u305f\u3044\nwhenever\u4f7f\u3063\u305f\u3089\u7c21\u5358\u306b\u3067\u304d\u308b\u3002\u96c6\u8a08\u7528\u30c6\u30fc\u30d6\u30ebaggregations\u3092\u4f5c\u3063\u305f\u4e0a\u3067\u3001\u30c7\u30fc\u30bf\u4f5c\u6210\u3059\u308b\u30b3\u30fc\u30c9\u3068\u3044\u3064\u96c6\u8a08\u3059\u308b\u304b\u3092\u6c7a\u3081\u308b\u30b3\u30fc\u30c9\u3092\u4f5c\u308b\u3002\n\n```ruby:lib/tasks/aggregation.rake\nnamespace :aggregation do\n  desc 'aggregate basic data'\n  task :basic => :environment do\n    {\u96c6\u8a08\u3057\u3066aggregations\u306b\u30c7\u30fc\u30bf\u3092\u7a81\u3063\u8fbc\u3080\u30b3\u30fc\u30c9}\n  end\nend\n```\n\n```ruby:config/schedule.rb\nrequire File.expand_path(File.dirname(__FILE__) + \"/environment\")\n\nset :environment, @environment\nset :output, Rails.root.join('log', 'cron.log')\n\nevery 1.day, at: '12pm' do\n  rake 'aggregation:basic'\nend\n```\n\n\u3053\u308c\u3067\u6bce\u65e512:00\u306b\u96c6\u8a08\u30c7\u30fc\u30bf\u3092\u4fdd\u5b58\u3059\u308b\u4e8b\u304c\u53ef\u80fd\u3002`bundle exec whenever -s 'environment=production' --update-crontab`\u3067cron\u306b\u8a2d\u5b9a\u3057\u3066\u7d42\u308f\u308a\u3002\n\u540c\u3058\u3088\u3046\u306b\u3057\u3066\u96c6\u8a08\u7d50\u679c\u3092\u30e1\u30fc\u30eb\u3067\u9001\u4fe1\u3059\u308b\u4e8b\u3082\u53ef\u80fd\u3002\n\n\n\n### \u88dc\u8db3\uff1a\u30c7\u30d7\u30ed\u30a4\u5148\u306b\u74b0\u5883\u69cb\u7bc9\u3059\u308b\u6642\u53c2\u8003\u306b\u3057\u305f\u30da\u30fc\u30b8\nruby\u3002\nhttp://www.task-notes.com/entry/20150624/1435114800\n\u4f9d\u5b58\u95a2\u4fc2\u3067\u8db3\u308a\u306a\u3044\u3082\u306e\u304c\u3042\u3063\u3066\u6012\u3089\u308c\u305f\u3089\u6307\u793a\u901a\u308a\u5165\u308c\u308b\u3002mysql-devel\u3068\u304b\u3002\n\nnginx\u3002yum\u3067\u3002\nhttp://qiita.com/nenokido2000/items/3cbb76dac2b9940f339e \n\n\n\n\n", "tags": ["Ruby", "Rails4", "activeadmin", "devise", "cancancan"]}