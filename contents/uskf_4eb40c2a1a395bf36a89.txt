{"tags": ["Linux", "MacBook", "UbuntuMATE"], "context": "\n\n\u306f\u3058\u3081\u306b\nSRA Advent Calendar\u306e14\u65e5\u76ee\u3067\u3059\u3002\n\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u30b7\u30b9\u30c6\u30e0\u30b5\u30fc\u30d3\u30b9\u7b2c\uff11\u4e8b\u696d\u90e8\u306e \u3075\u3058\u307e\u304d \u3067\u3059\u3002\nMacBook Early 2016(Model:A1534)\u3067Linux\u3092\u52d5\u304b\u305d\u3046\u3068\u3059\u308b\u3068\u308f\u308a\u3068\u9762\u5012\u3068\u3044\u3046\u60c5\u5831\u3092\u5165\u624b\u3057\u305f\u306e\u3067\u30e8\u30c9\u30d0\u30b7\u3067\u8cb7\u3063\u3066\u304d\u3066Ubuntu MATE\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3066\u307f\u307e\u3057\u305f\u3002\nhttps://wiki.archlinux.org/index.php/MacBook#April_2016_12.22_-_Version_9.2C1\nhttps://wiki.archlinuxjp.org/index.php/MacBook#April_2016_12.22_-_.E3.83.90.E3.83.BC.E3.82.B8.E3.83.A7.E3.83.B3_9.2C1\n\n\u6ce8\u610f\u4e8b\u9805\n\n\u3053\u306e\u30da\u30fc\u30b8\u306e\u60c5\u5831\u306f\u7121\u4fdd\u8a3c\u3067\u3059\u3002\u8a66\u3059\u5834\u5408\u306f\u81ea\u5df1\u8cac\u4efb\u3067\u304a\u9858\u3044\u3057\u307e\u3059\u3002\nMacOS\u306b\u672a\u7df4\u304c\u3042\u308b\u4eba\u306f\u30ea\u30ab\u30d0\u30ea\u624b\u6bb5\u3092\u78ba\u4fdd\u3057\u3066\u304b\u3089\u884c\u3063\u3066\u304f\u3060\u3055\u3044\u3002\n\u30ad\u30fc\u30dc\u30fc\u30c9\u3001\u30c8\u30e9\u30c3\u30af\u30d1\u30c3\u30c9\u306f\u52d5\u4f5c\u3057\u307e\u305b\u3093\u3002USB\u63a5\u7d9a\u306e\u30ad\u30fc\u30dc\u30fc\u30c9\u3001\u30de\u30a6\u30b9\u306f\u5fc5\u9808\u3067\u3059\u3002\n\n\nArch\u306ewiki\u306b\u8a18\u8f09\u306e\u3068\u304a\u308a\u3001Work In Progress\u306a\u30c9\u30e9\u30a4\u30d0\u304c\u5b58\u5728\u3057\u307e\u3059\u304c\u3001\u305d\u308c\u3092\u5165\u308c\u308b\u4f5c\u696d\u306e\u969b\u306b\u30ad\u30fc\u30dc\u30fc\u30c9\u304c\u5fc5\u8981\u3067\u3059\u3002\u306a\u304a\u3001\u3053\u306e\u30c9\u30e9\u30a4\u30d0\u306f2015\u5e74\u7248\u306eMacBook\u3067\u306f\u52d5\u304d\u307e\u305b\u3093(\u4eca\u306e\u3068\u3053\u308d)\n\n\n\u30c7\u30d5\u30a9\u30eb\u30c8\u8a2d\u5b9a\u3067\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u3068\u901a\u5e38\u8d77\u52d5\u306fUbuntu MATE\u306b\u306a\u308a\u307e\u3059\u3002MacOS\u306f(\u81ea\u52d5\u3067\u306f)\u8d77\u52d5\u3057\u306a\u304f\u306a\u308a\u307e\u3059\u3002\n802.11ac\u304c\u4e0d\u5b89\u5b9a\u3067\u3059\u3002(\u30d1\u30b1\u30c3\u30c8\u304c\u6d41\u308c\u306a\u304f\u306a\u308b\u3002\u539f\u56e0\u4e0d\u660e)\u30a2\u30af\u30bb\u30b9\u30dd\u30a4\u30f3\u30c8\u304c802.11ac\u5bfe\u5fdc\u304b\u3064802.11ac\u306e\u307f\u3092\u7121\u52b9\u5316\u3067\u304d\u306a\u3044\u5834\u5408\u3001\u307e\u3068\u3082\u306b\u751f\u6d3b\u51fa\u6765\u307e\u305b\u3093\u3002\n\n\u97f3\u306f\u9cf4\u308a\u307e\u305b\u3093\u3002(\u9332\u97f3\u306f\u51fa\u6765\u308b\u3089\u3057\u3044\u3067\u3059\u304c\u672a\u78ba\u8a8d)\n\u3053\u3053\u3067\u8aac\u660e\u3059\u308b\u624b\u9806\u306f\u30a4\u30f3\u30b9\u30c8\u30fc\u30e9\u30fc\u3092\u30ab\u30b9\u30bf\u30de\u30a4\u30ba\u3057\u3066Macbook\u306bUbuntu MATE\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u307e\u3059\u3002\u306a\u306e\u3067\u3001\u30a4\u30f3\u30b9\u30c8\u30fc\u30e9\u30fc\u4f5c\u6210\u7528\u306e\u30de\u30b7\u30f3\u304c\u5225\u9014\u5fc5\u8981\u3067\u3059\u3002\n2015\u5e74\u7248\u306eMacBook\u306b\u306f\u304a\u305d\u3089\u304f\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3067\u304d\u307e\u3059\u304c\u3001\u30ad\u30fc\u30dc\u30fc\u30c9\u3068\u30c8\u30e9\u30c3\u30af\u30d1\u30c3\u30c9\u3092\u52d5\u304b\u3059\u624b\u6bb5\u304c\u898b\u3064\u304b\u3063\u3066\u3044\u306a\u3044\u306e\u3067\u304a\u52e7\u3081\u3057\u307e\u305b\u3093\u3002\n\n\nMacBook Early 2016\u3078\u306eUbuntu MATE 16.10\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\nArch Linux\u306eWiki\u3092\u898b\u308b\u3068kernel 4.6\u4ee5\u4e0a\u306a\u3089\u30a4\u30f3\u30b9\u30c8\u30fc\u30e9\u30fc\u8d77\u52d5\u5f8c\u3001\u30b3\u30f3\u30bd\u30fc\u30eb\u3067\n# modprobe nvme\n# echo 106b 2003 > /sys/bus/pci/drivers/nvme/new_id\n\n\u3068\u5165\u529b\u3059\u308c\u3070\u5185\u8535NVMe\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u30fc\u304c\u52d5\u4f5c\u3059\u308b\u306f\u305a\u3067\u3059\u304c\u3001Ubuntu MATE 16.10(kernel 4.8)\u306e\u5834\u5408\u3001\"D3 state\u304b\u3089\u5fa9\u5e30\u3067\u304d\u306a\u3044\uff5e\"\u307f\u305f\u3044\u306a\u30a8\u30e9\u30fc\u304c\u51fa\u3066\u5185\u8535SSD\u3092\u8a8d\u8b58\u3067\u304d\u305a\u3002Debian Stretch\u30a4\u30f3\u30b9\u30c8\u30fc\u30e9\u30fcAlpha7(kernel 4.6)\u3060\u3068\u5185\u8535SSD\u3092\u8a8d\u8b58\u3059\u308b\u304c\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u4e2d\u306b\u983b\u7e41\u306b\u30d5\u30ea\u30fc\u30ba\u3057\u3066\u307e\u3068\u3082\u306b\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u304c\u51fa\u6765\u307e\u305b\u3093\u3067\u3057\u305f\u3002(Debian\u306f5,6\u56de\u30ea\u30c8\u30e9\u30a4\u3057\u7d9a\u3051\u3066\u304b\u308d\u3046\u3058\u3066\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u51fa\u6765\u307e\u3057\u305f\u304c)\n\u306a\u306e\u3067Ubuntu MATE 16.10\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30e9\u30fc\u306e\u30ab\u30fc\u30cd\u30eb\u3092\u5dee\u3057\u66ff\u3048\u3066\u3001\u3055\u304f\u3063\u3068\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u51fa\u6765\u308b\u30a4\u30f3\u30b9\u30c8\u30fc\u30e9\u30fc\u3092\u4f5c\u308a\u307e\u3059\u3002\n\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30e9\u30fc\u30ab\u30b9\u30bf\u30de\u30a4\u30ba\u7528\u306e\u4f5c\u696d\u74b0\u5883\u4f5c\u6210\n\u9069\u5f53\u306a\u30de\u30b7\u30f3(\u4eee\u60f3\u3067\u3082OK)\u306bUbuntu MATE 16.10\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u307e\u3059\u3002\u30cf\u30fc\u30c9\u30c7\u30a3\u30b9\u30af\u306e\u5bb9\u91cf\u306f50GB\u304f\u3089\u3044\u3042\u3063\u305f\u65b9\u304c\u3088\u3044\u3067\u3059\u3002(40GB\u3060\u3068\u30ae\u30ea\u30ae\u30ea)\n\u4ee5\u964d\u3001\u3053\u306e\u74b0\u5883\u3092\u300c\u4f5c\u696d\u74b0\u5883\u300d\u3068\u547c\u3073\u307e\u3059\u3002\n\n\u4f5c\u696d\u74b0\u5883\u306e\u30ab\u30fc\u30cd\u30eb\u66f4\u65b0\nssh\u3067\u4f5c\u696d\u3059\u308b\u306e\u3067\u3001openssh-server\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n$ sudo apt-get update\n$ sudo apt-get -y install openssh-server\n\n\u30ab\u30fc\u30cd\u30eb\u30d1\u30c3\u30b1\u30fc\u30b8\u4f5c\u6210\u306b\u5fc5\u8981\u306a\u30d1\u30c3\u30b1\u30fc\u30b8\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n$ sudo apt-get -y install dpkg-dev debhelper dh-systemd kernel-wedge makedumpfile \\\n libelf-dev libnewt-dev libiberty-dev libdw-dev libpci-dev pkg-config \\\n flex bison libunwind8-dev liblzma-dev libssl-dev libaudit-dev \\\n python-dev libudev-dev autoconf automake libtool uuid-dev xmlto \\\n docbook-utils transfig sharutils asciidoc\n\n\u30db\u30fc\u30e0\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306b\u4f5c\u696d\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\"work\"\u3092\u4f5c\u6210\u3057\u3066\u305d\u306e\u4e2d\u306b\u30ab\u30fc\u30cd\u30eb\u30bd\u30fc\u30b9\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3002\n(launchpad.net\u304b\u3089linux_4.8.0.orig.tar.gz\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3059\u308b\u306e\u306f\u6642\u9593\u304c\u304b\u304b\u308b\u306e\u3067\u30df\u30e9\u30fc\u30b5\u30a4\u30c8\u304b\u3089\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u3066\u30b3\u30f3\u30d0\u30fc\u30c8\u3057\u3066\u3044\u307e\u3059)\n$ mkdir ~/work\n$ cd ~/work\n$ wget http://ftp.jaist.ac.jp/pub/Linux/kernel.org/linux/kernel/v4.x/linux-4.8.tar.xz\n$ xz -dc linux-4.8.tar.xz | gzip -9 > linux_4.8.0.orig.tar.gz\n$ rm linux-4.8.tar.xz\n$ wget https://launchpad.net/ubuntu/+archive/primary/+files/linux_4.8.0-27.29.diff.gz\n\n\u30ab\u30fc\u30cd\u30eb\u30bd\u30fc\u30b9\u3092\u5c55\u958b\u3057\u3001\u30d1\u30c3\u30b1\u30fc\u30b8\u306e\u30d1\u30c3\u30c1\u3092\u9069\u7528\n$ tar zxf linux_4.8.0.orig.tar.gz\n$ cd linux-4.8/\n$ gzip -dc ../linux_4.8.0-27.29.diff.gz | patch -p1\n\nLinux4.8\u306eNVMe\u30c9\u30e9\u30a4\u30d0\u306fMacBook Early 2016\u306eNVMe\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u30fc\u306eProduct ID\u304c\u5165\u3063\u3066\u3044\u306a\u3044\u306e\u3067\u8ffd\u52a0\u3057\u307e\u3059\u3002\n$ cp -p drivers/nvme/host/pci.c drivers/nvme/host/pci.c_orig\n$ vi drivers/nvme/host/pci.c\n\n\u4ee5\u4e0b\u306e\u3068\u304a\u308a\u5909\u66f4\n--- drivers/nvme/host/pci.c_orig        2016-10-03 08:24:33.000000000 +0900\n+++ drivers/nvme/host/pci.c     2016-11-20 14:17:53.892000000 +0900\n@@ -1635,7 +1635,7 @@\n         * Temporary fix for the Apple controller found in the MacBook8,1 and\n         * some MacBook7,1 to avoid controller resets and data loss.\n         */\n-       if (pdev->vendor == PCI_VENDOR_ID_APPLE && pdev->device == 0x2001) {\n+       if (pdev->vendor == PCI_VENDOR_ID_APPLE && (pdev->device == 0x2001 || pdev->device == 0x2003)) {\n                dev->q_depth = 2;\n                dev_warn(dev->dev, \"detected Apple NVMe controller, set \"\n                        \"queue depth=%u to work around controller resets\\n\",\n@@ -2121,6 +2121,7 @@\n                .driver_data = NVME_QUIRK_DELAY_BEFORE_CHK_RDY, },\n        { PCI_DEVICE_CLASS(PCI_CLASS_STORAGE_EXPRESS, 0xffffff) },\n        { PCI_DEVICE(PCI_VENDOR_ID_APPLE, 0x2001) },\n+       { PCI_DEVICE(PCI_VENDOR_ID_APPLE, 0x2003) },\n        { 0, }\n };\n MODULE_DEVICE_TABLE(pci, nvme_id_table);\n\n\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u30d5\u30a1\u30a4\u30eb\u524a\u9664\n$ rm drivers/nvme/host/pci.c_orig\n\n\u4e0a\u8a18\u306e\u4fee\u6b63\u306f http://lists.infradead.org/pipermail/linux-nvme/2016-May/004618.html \u3088\u308a\u3002\u524d\u534a\u306e\u90e8\u5206\u306f\u30aa\u30ea\u30b8\u30ca\u30eb\u306e\u30d1\u30c3\u30c1\u3067\u306f\u4e0d\u8981\u3068\u3055\u308c\u3066\u307e\u3057\u305f\u304c\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u4e2d\u306f\u660e\u3089\u304b\u306b\u3042\u3063\u305f\u307b\u3046\u304c\u826f\u3044\u306e\u3067\u8ffd\u52a0\u3002(\u7121\u3044\u3068\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30cb\u30f3\u30b0\u306e\u3068\u3053\u308d\u3067\u9ad8\u78ba\u7387\u3067\u30d5\u30ea\u30fc\u30ba\u3057\u307e\u3059\u3001\u3068\u3044\u3046\u7a81\u7834\u51fa\u6765\u306a\u3044)\n\u30ab\u30fc\u30cd\u30eb\u30d1\u30c3\u30b1\u30fc\u30b8\u30d3\u30eb\u30c9\u3002\u74b0\u5883\u4f9d\u5b58\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u304c\u3001\u624b\u5143\u306e\u74b0\u5883\u3060\u3068ssh\u30ed\u30b0\u30a4\u30f3\u3057\u305f\u72b6\u614b\u3067\u30ab\u30fc\u30cd\u30eb\u30d1\u30c3\u30b1\u30fc\u30b8\u4f5c\u6210\u3092\u884c\u3046\u3068\u9014\u4e2d\u3067\u901a\u4fe1\u304c\u5207\u308c\u308b\u306e\u3067\u3053\u3053\u3060\u3051\u30ed\u30fc\u30ab\u30eb\u3067\u30ed\u30b0\u30a4\u30f3\u3057\u305f\u72b6\u614b\u3067\u5b9f\u884c\u3057\u305f\u65b9\u304c\u3088\u3044\u304b\u3082\u3002\n$ dpkg-buildpackage -rfakeroot -us -uc --build=binary\n\n\u6b63\u5e38\u306b\u5b8c\u4e86\u3059\u308b\u3068\u4e00\u3064\u4e0a\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306b\u30ab\u30fc\u30cd\u30eb\u30d1\u30c3\u30b1\u30fc\u30b8\u304c\u4f5c\u6210\u3055\u308c\u307e\u3059\u3002\n\u79fb\u52d5\u3057\u3066\u30ab\u30fc\u30cd\u30eb\u30d1\u30c3\u30b1\u30fc\u30b8\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n$ cd ~/work/\n$ sudo dpkg -i linux-headers-4.8.0-27_4.8.0-27.29_all.deb \\\n  linux-headers-4.8.0-27-generic_4.8.0-27.29_amd64.deb \\\n  linux-image-4.8.0-27-generic_4.8.0-27.29_amd64.deb \\\n  linux-image-extra-4.8.0-27-generic_4.8.0-27.29_amd64.deb \\\n  linux-tools-4.8.0-27_4.8.0-27.29_amd64.deb \\\n  linux-tools-4.8.0-27-generic_4.8.0-27.29_amd64.deb \\\n  linux-tools-common_4.8.0-27.29_all.deb\n\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u5f8c\u3001\u518d\u8d77\u52d5\n$ sudo reboot\n\n\u518d\u8d77\u52d5\u5f8c\u30ed\u30b0\u30a4\u30f3\u3002\u4fee\u6b63\u3057\u305fNVMe\u30c9\u30e9\u30a4\u30d0\u306bProduct ID\u304c\u8ffd\u52a0\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u3092\u78ba\u8a8d\n$ modinfo nvme\nfilename:       /lib/modules/4.8.0-27-generic/kernel/drivers/nvme/host/nvme.ko\nversion:        1.0\nlicense:        GPL\nauthor:         Matthew Wilcox <willy@linux.intel.com>\nsrcversion:     A270F19E73A377AD815935F\nalias:          pci:v0000106Bd00002003sv*sd*bc*sc*i*   /* d00002003\u304c\u3042\u308c\u3070OK */\nalias:          pci:v0000106Bd00002001sv*sd*bc*sc*i*\n(\u4ee5\u4e0b\u7565)\n\nalias\u306e\u3068\u3053\u308d\u306bDevice-ID==2003\u304c\u3042\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3002\u4f5c\u6210\u3057\u305f\u30ab\u30fc\u30cd\u30eb\u30d1\u30c3\u30b1\u30fc\u30b8\u306f\u3053\u306e\u5f8c\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30e9\u30fc\u306e\u30ab\u30b9\u30bf\u30de\u30a4\u30ba\u3067\u3082\u4f7f\u7528(\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb)\u3057\u307e\u3059\u3002\n\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30e9\u30fc\u306e\u30ab\u30b9\u30bf\u30de\u30a4\u30ba\n\u53c2\u8003\u30b5\u30a4\u30c8\n\nhttps://help.ubuntu.com/community/InstallCDCustomization\nhttps://help.ubuntu.com/community/LiveCDCustomization\n\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30e9\u30fc\u306e\u4e2d\u8eab\u3092\u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0\u4e0a\u306b\u5c55\u958b\u3057\u3066\u3001\u30ab\u30fc\u30cd\u30eb\u3092NVMe\u30c9\u30e9\u30a4\u30d0\u3092\u4fee\u6b63\u3057\u305f\u3082\u306e\u3068\u5dee\u3057\u66ff\u3048\u307e\u3059\u3002\n\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30e9\u30fc\u306e\u5c55\u958b\n\u4f5c\u696d\u74b0\u5883\u3067Ubuntu MATE 16.10\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30e9\u30fc\u3092/mnt/\u306b\u30de\u30a6\u30f3\u30c8\n$ sudo mount /dev/sr0 /mnt/\n\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30e9\u30fc\u306e\u4e2d\u8eab\u3092/opt/cd-image\u306b\u30b3\u30d4\u30fc\n$ sudo mkdir /opt/cd-image\n$ sudo rsync -av /mnt/ /opt/cd-image/\n\n\u4f5c\u696d\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3068\u3057\u3066/opt/work\u3092\u4f5c\u6210\u3057\u3001\u30a4\u30f3\u30b9\u30c8\u30fc\u30e9\u30fc\u306e\u30eb\u30fc\u30c8\u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0(Squashfs)\u3092\u5c55\u958b\u3002\"squashfs-root\"\u3068\u3044\u3046\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u304c\u4f5c\u6210\u3055\u308c\u305d\u306e\u4e2d\u306b\u5c55\u958b\u3055\u308c\u307e\u3059\u3002\n$ sudo mkdir /opt/work\n$ cd /opt/work\n$ sudo unsquashfs /opt/cd-image/casper/filesystem.squashfs\n\n\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30e9\u30fc\u306einitrd\u5909\u66f4\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30e9\u30fc\u306einitrd\u306e\u4e2d\u8eab\u3092\u5c55\u958b\n$ sudo mkdir /opt/work/installer-initrd\n$ cd /opt/work/installer-initrd/\n$ lzma -dc -S .lz /opt/cd-image/casper/initrd.lz | sudo cpio -imvd --no-absolute-filenames\n\nUbuntu MATE 16.10\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30e9\u30fc\u306e\u30ab\u30fc\u30cd\u30eb\u306f\"4.8.0-22\"\u3068\u3044\u3046\u30d0\u30fc\u30b8\u30e7\u30f3\u3067initrd\u306e\u4e2d\u8eab\u30824.8.0-22\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002\u3053\u308c\u3092\u4f5c\u696d\u74b0\u5883\u306b\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u305f\"4.8.0-27\"\u306b\u5dee\u3057\u66ff\u3048\u307e\u3059\u3002\n\u5dee\u3057\u66ff\u3048\u306e\u4e8b\u524d\u6e96\u5099\u3068\u3057\u3066\u4f5c\u696d\u74b0\u5883\u306einitrd\u306baufs\u3092\u8ffd\u52a0\n$ echo aufs | sudo tee -a /etc/initramfs-tools/modules\n$ sudo update-initramfs -c -k all\n\n\u66f4\u65b0\u3057\u305f\u4f5c\u696d\u74b0\u5883\u306einitrd\u3092/opt/work/basesystem-initrd\u306b\u5c55\u958b\n$ sudo mkdir /opt/work/basesystem-initrd\n$ cd /opt/work/basesystem-initrd/\n$ gzip -dc /boot/initrd.img-4.8.0-27-generic | sudo cpio -imvd --no-absolute-filenames\n\n\u3053\u306e\u6642\u70b9\u3067\u30a4\u30f3\u30b9\u30c8\u30fc\u30e9\u30fc\u306einitrd\u3092/opt/work/installer-initrd/ \u3001\u4f5c\u696d\u74b0\u5883\u306einitrd\u3092/opt/work/basesystem-initrd\u306b\u5c55\u958b\u3057\u305f\u72b6\u614b\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002\n/opt/work/installer-initrd/\u304b\u3089\"4.8.0-22\"\u95a2\u9023\u3092\u524a\u9664\n$ sudo rm -rf /opt/work/installer-initrd/lib/modules/4.8.0-22-generic\n$ sudo rm -rf /opt/work/installer-initrd/lib/firmware/4.8.0-22-generic\n$ sudo rm /opt/work/installer-initrd/lib/modprobe.d/blacklist_linux_4.8.0-22-generic.conf\n\n\u4ee3\u308f\u308a\u306bNVMe\u30c9\u30e9\u30a4\u30d0\u3092\u4fee\u6b63\u3057\u305f\u4f5c\u696d\u74b0\u5883\u306e\"4.8.0-27\"\u95a2\u9023\u30d5\u30a1\u30a4\u30eb\u3092/opt/work/installer-initrd/\u3078\u30b3\u30d4\u30fc\n$ sudo cp -a /opt/work/basesystem-initrd/lib/modules/4.8.0-27-generic /opt/work/installer-initrd/lib/modules/\n$ sudo cp -a /opt/work/basesystem-initrd/lib/firmware/4.8.0-27-generic /opt/work/installer-initrd/lib/firmware/\n$ sudo cp -p /opt/work/basesystem-initrd/lib/modprobe.d/blacklist_linux_4.8.0-27-generic.conf /opt/work/installer-initrd/lib/modprobe.d/\n\n\u4fee\u6b63\u3057\u305finitrd\u30a4\u30e1\u30fc\u30b8\u518d\u4f5c\u6210\n$ cd /opt/work/installer-initrd/\n$ sudo find . | sudo cpio --quiet --dereference -o -H newc | lzma -7 | sudo dd of=/opt/cd-image/casper/initrd.lz\n\n\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30e9\u30fc\u306e\u30ab\u30fc\u30cd\u30eb\u66f4\u65b0\n\u30d5\u30a1\u30a4\u30eb\u30921\u500b\u30b3\u30d4\u30fc\u3059\u308b\u3060\u3051\u3002\n$ sudo cp /boot/vmlinuz-4.8.0-27-generic  /opt/cd-image/casper/vmlinuz.efi\n\n\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30e9\u30fc\u306e\u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0\u7de8\u96c6\nSquashfs\u3092\u5c55\u958b\u3057\u305f\u4e2d\u3078chroot\u3057\u3066\u7de8\u96c6\u3057\u307e\u3059\u3002\n\u4e8b\u524d\u6e96\u5099\u3068\u3057\u3066/proc\u7b49\u3092Squashfs\u5c55\u958b\u5148\u306b\u30de\u30a6\u30f3\u30c8\u3002\n$ sudo mount -o bind /proc /opt/work/squashfs-root/proc\n$ sudo mount -o bind /dev /opt/work/squashfs-root/dev\n$ sudo mount -t devpts none /opt/work/squashfs-root/dev/pts/\n$ sudo mount -t sysfs none /opt/work/squashfs-root/sys/\n\n\u4f5c\u696d\u74b0\u5883\u306e\u30ab\u30fc\u30cd\u30eb\u66f4\u65b0\u3067\u30d1\u30c3\u30b1\u30fc\u30b8\u3092\u4f5c\u6210\u3057\u305f\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3082Squashfs\u5c55\u958b\u5148\u306b\u30de\u30a6\u30f3\u30c8\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n$ sudo mkdir /opt/work/squashfs-root/work\n$ sudo mount -o bind ~/work/ /opt/work/squashfs-root/work\n\nSquashfs\u3092\u5c55\u958b\u3057\u305f\u4e2d\u3078chroot\n$ sudo chroot /opt/work/squashfs-root/\n\n\u4ee5\u4e0b\u3001chroot\u5185\u4f5c\u696d(\u30d7\u30ed\u30f3\u30d7\u30c8\u304c\"#\")\n\u4fee\u6b63\u3057\u305f\u30ab\u30fc\u30cd\u30eb\u30d1\u30c3\u30b1\u30fc\u30b8\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n(chroot\u5185\u3067\u306e\u30b3\u30de\u30f3\u30c9\u5b9f\u884c\u3067locale\u95a2\u9023\u306eWarning\u304c\u51fa\u307e\u3059\u304c\u7121\u8996\u3057\u3066OK) \n# cd /work/\n# dpkg -i linux-headers-4.8.0-27_4.8.0-27.29_all.deb \\\n  linux-headers-4.8.0-27-generic_4.8.0-27.29_amd64.deb \\\n  linux-image-4.8.0-27-generic_4.8.0-27.29_amd64.deb \\\n  linux-image-extra-4.8.0-27-generic_4.8.0-27.29_amd64.deb \\\n  linux-tools-4.8.0-27-generic_4.8.0-27.29_amd64.deb \\\n  linux-tools-4.8.0-27_4.8.0-27.29_amd64.deb \\\n  linux-tools-common_4.8.0-27.29_all.deb\n\n\u4e0d\u8981\u30d1\u30c3\u30b1\u30fc\u30b8(\u53e4\u3044\u30ab\u30fc\u30cd\u30eb\u30d1\u30c3\u30b1\u30fc\u30b8)\u3092\u524a\u9664\n# apt-get purge linux-signed-image-4.8.0-22-generic \\\n  linux-signed-image-generic linux-signed-generic \\\n  linux-headers-4.8.0-22-generic linux-headers-4.8.0-22 \\\n  linux-image-4.8.0-22-generic linux-image-extra-4.8.0-22-generic \\\n  linux-tools-4.8.0-22 linux-tools-4.8.0-22-generic\n\ngrub\u306e\u30c7\u30d5\u30a9\u30eb\u30c8\u8a2d\u5b9a\u5909\u66f4\u3002intremap=nosid\u3092\u8ffd\u52a0\u3057\u3066\u66f4\u65b0(\u30ad\u30fc\u30dc\u30fc\u30c9\uff06\u30c8\u30e9\u30c3\u30af\u30d1\u30c3\u30c9\u306e\u30c9\u30e9\u30a4\u30d0\u306e\u52d5\u4f5c\u306b\u5fc5\u8981)\n# sed -i 's/^kopt_params=\"\"/kopt_params=\"intremap=nosid\"/' /usr/share/grub-installer/grub-installer\n# ucf --purge /etc/default/grub\n# sed -i 's/^GRUB_CMDLINE_LINUX=\"\"/GRUB_CMDLINE_LINUX=\"intremap=nosid\"/' /etc/default/grub\n# ucf /etc/default/grub /etc/default/grub\n# update-grub\n\n\u4ee5\u4e0a\u3002chroot\u304b\u3089\u629c\u3051\u308b\n# exit\n\nSquashfs\u5c55\u958b\u5148\u306b\u30de\u30a6\u30f3\u30c8\u3057\u3066\u304a\u3044\u305f\u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0\u3092\u30a2\u30f3\u30de\u30a6\u30f3\u30c8\n$ sudo umount /opt/work/squashfs-root/proc\n$ sudo umount /opt/work/squashfs-root/dev/pts\n$ sudo umount /opt/work/squashfs-root/dev\n$ sudo umount /opt/work/squashfs-root/sys\n$ sudo umount /opt/work/squashfs-root/work\n\n\u4e00\u6642\u7684\u306b\u4f5c\u6210\u3057\u305f\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u524a\u9664\n$ sudo rmdir /opt/work/squashfs-root/work\n\n\u6539\u5909\u3057\u305fSquashfs\u30a4\u30e1\u30fc\u30b8\u518d\u4f5c\u6210\n$ sudo chmod +w /opt/cd-image/casper/filesystem.manifest\n$ sudo chroot /opt/work/squashfs-root  dpkg-query -W  | sudo tee /opt/cd-image/casper/filesystem.manifest\n$ sudo rm /opt/cd-image/casper/filesystem.squashfs\n$ sudo mksquashfs /opt/work/squashfs-root  /opt/cd-image/casper/filesystem.squashfs  -comp xz\n\n\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30e9\u30fc\u30a4\u30e1\u30fc\u30b8\u518d\u4f5c\u6210\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30e9\u30fc\u306e\u30ab\u30fc\u30cd\u30eb\u30aa\u30d7\u30b7\u30e7\u30f3\u5909\u66f4\u3002\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u6642\u306b\u5fc5\u8981\u306anoapic\u3092\u8ffd\u52a0\u3002(isolinux\u3068grub\u306e\u4e21\u65b9\u3092\u5909\u3048\u3066\u3044\u307e\u3059\u304cMacBook\u3067\u4f7f\u308f\u308c\u308b\u306e\u306fgrub)\n$ sudo sed -i 's/initrd.lz quiet/initrd.lz noapic quiet/' /opt/cd-image/isolinux/txt.cfg\n$ sudo sed -i 's/quiet splash/quiet noapic splash/' /opt/cd-image/boot/grub/grub.cfg\n\n\u30d5\u30a1\u30a4\u30eb\u30ea\u30b9\u30c8\u3068MD5\u30c1\u30a7\u30c3\u30af\u30b5\u30e0\u4f5c\u6210\n$ printf $(sudo du -sx --block-size=1 /opt/work/squashfs-root | cut -f1) | sudo tee /opt/cd-image/casper/filesystem.size\n$ sudo rm /opt/cd-image/md5sum.txt\n$ cd /opt/cd-image/\n$ sudo find -type f -print0 | sudo xargs -0 md5sum | grep -v isolinux/boot.cat | sudo tee md5sum.txt\n\nISO\u30a4\u30e1\u30fc\u30b8\u4f5c\u6210\n$ sudo mkdir /opt/newimage\n$ cd /opt/cd-image/\n$ sudo IMAGE=/opt/newimage/custom.iso BUILD=/opt/cd-image/  mkisofs -r -V \"Custom Test\" -cache-inodes -J -l \\\n -b isolinux/isolinux.bin -c isolinux/boot.cat \\\n -no-emul-boot -boot-load-size 4 -boot-info-table \\\n -o /opt/newimage/custom.iso /opt/cd-image/\n\n/opt/newimage/custom.iso \u306b1.4GB\u304f\u3089\u3044\u306e\u30cf\u30a4\u30d6\u30ea\u30c3\u30c9\u30a4\u30e1\u30fc\u30b8\u304c\u51fa\u6765\u308b\u306e\u3067USB\u30e1\u30e2\u30ea\u306b\u66f8\u304d\u51fa\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\n\u30ab\u30b9\u30bf\u30e0\u30a4\u30f3\u30b9\u30c8\u30fc\u30e9\u30fc\u3092\u4f7f\u3063\u305fMacBook Early 2016\u3078\u306eUbuntu MATE 16.10\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\u30ab\u30b9\u30bf\u30de\u30a4\u30ba\u3057\u305f\u30a4\u30f3\u30b9\u30c8\u30fc\u30e9\u30fc\u3067\u8d77\u52d5\u3057Ubuntu MATE\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u307e\u3059\u3002\n\u8aac\u660e\u306f\u7279\u306b\u5fc5\u8981\u306a\u3044\u3068\u601d\u3044\u307e\u3059\u304c\u3001\u6ce8\u610f\u70b9\u3068\u3057\u3066\u306f\n\nMacOS\u3082\u4f7f\u3044\u7d9a\u3051\u305f\u3044\u5834\u5408\u306f\u4e8b\u524d\u306bMacOS\u4e0a\u3067\u7a7a\u304d\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u3092\u4f5c\u3063\u3066\u304a\u3044\u305f\u65b9\u304c\u3088\u3044\u3067\u3057\u3087\u3046\u3002\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u4e2d\u306b\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u306b\u7e4b\u3052\u308b\u3068\u305b\u3063\u304b\u304fNVMe\u30c9\u30e9\u30a4\u30d0\u3092\u4fee\u6b63\u3057\u305f\u30ab\u30fc\u30cd\u30eb\u304c\u4e0a\u66f8\u304d\u3055\u308c\u3066\u3057\u307e\u3046\u6050\u308c\u304c\u3042\u308b\u306e\u3067\u3001\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u4e2d\u306f\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u306b\u7e4b\u3052\u306a\u3044\u65b9\u304c\u78ba\u5b9f\u3067\u3059\u3002\n\n#\u306f\u3058\u3081\u306b\n[SRA Advent Calendar](http://qiita.com/advent-calendar/2016/sra)\u306e14\u65e5\u76ee\u3067\u3059\u3002\n\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u30b7\u30b9\u30c6\u30e0\u30b5\u30fc\u30d3\u30b9\u7b2c\uff11\u4e8b\u696d\u90e8\u306e \u3075\u3058\u307e\u304d \u3067\u3059\u3002\n\nMacBook Early 2016(Model:A1534)\u3067Linux\u3092\u52d5\u304b\u305d\u3046\u3068\u3059\u308b\u3068\u308f\u308a\u3068\u9762\u5012\u3068\u3044\u3046\u60c5\u5831\u3092\u5165\u624b\u3057\u305f\u306e\u3067\u30e8\u30c9\u30d0\u30b7\u3067\u8cb7\u3063\u3066\u304d\u3066Ubuntu MATE\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3066\u307f\u307e\u3057\u305f\u3002\n\nhttps://wiki.archlinux.org/index.php/MacBook#April_2016_12.22_-_Version_9.2C1\nhttps://wiki.archlinuxjp.org/index.php/MacBook#April_2016_12.22_-_.E3.83.90.E3.83.BC.E3.82.B8.E3.83.A7.E3.83.B3_9.2C1\n\n# \u6ce8\u610f\u4e8b\u9805\n- \u3053\u306e\u30da\u30fc\u30b8\u306e\u60c5\u5831\u306f**\u7121\u4fdd\u8a3c**\u3067\u3059\u3002\u8a66\u3059\u5834\u5408\u306f**\u81ea\u5df1\u8cac\u4efb\u3067**\u304a\u9858\u3044\u3057\u307e\u3059\u3002\n- MacOS\u306b\u672a\u7df4\u304c\u3042\u308b\u4eba\u306f**\u30ea\u30ab\u30d0\u30ea\u624b\u6bb5\u3092\u78ba\u4fdd\u3057\u3066\u304b\u3089**\u884c\u3063\u3066\u304f\u3060\u3055\u3044\u3002\n- \u30ad\u30fc\u30dc\u30fc\u30c9\u3001\u30c8\u30e9\u30c3\u30af\u30d1\u30c3\u30c9\u306f**\u52d5\u4f5c\u3057\u307e\u305b\u3093**\u3002USB\u63a5\u7d9a\u306e\u30ad\u30fc\u30dc\u30fc\u30c9\u3001\u30de\u30a6\u30b9\u306f\u5fc5\u9808\u3067\u3059\u3002\n    - Arch\u306ewiki\u306b\u8a18\u8f09\u306e\u3068\u304a\u308a\u3001Work In Progress\u306a[\u30c9\u30e9\u30a4\u30d0](https://github.com/cb22/macbook12-spi-driver)\u304c\u5b58\u5728\u3057\u307e\u3059\u304c\u3001\u305d\u308c\u3092\u5165\u308c\u308b\u4f5c\u696d\u306e\u969b\u306b\u30ad\u30fc\u30dc\u30fc\u30c9\u304c\u5fc5\u8981\u3067\u3059\u3002\u306a\u304a\u3001\u3053\u306e\u30c9\u30e9\u30a4\u30d0\u306f2015\u5e74\u7248\u306eMacBook\u3067\u306f**\u52d5\u304d\u307e\u305b\u3093**(\u4eca\u306e\u3068\u3053\u308d)\n- \u30c7\u30d5\u30a9\u30eb\u30c8\u8a2d\u5b9a\u3067\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u3068\u901a\u5e38\u8d77\u52d5\u306fUbuntu MATE\u306b\u306a\u308a\u307e\u3059\u3002**MacOS\u306f(\u81ea\u52d5\u3067\u306f)\u8d77\u52d5\u3057\u306a\u304f\u306a\u308a\u307e\u3059**\u3002\n- 802.11ac\u304c**\u4e0d\u5b89\u5b9a**\u3067\u3059\u3002(\u30d1\u30b1\u30c3\u30c8\u304c\u6d41\u308c\u306a\u304f\u306a\u308b\u3002\u539f\u56e0\u4e0d\u660e)\u30a2\u30af\u30bb\u30b9\u30dd\u30a4\u30f3\u30c8\u304c802.11ac\u5bfe\u5fdc\u304b\u3064802.11ac\u306e\u307f\u3092\u7121\u52b9\u5316\u3067\u304d\u306a\u3044\u5834\u5408\u3001**\u307e\u3068\u3082\u306b\u751f\u6d3b\u51fa\u6765\u307e\u305b\u3093**\u3002\n- **\u97f3\u306f\u9cf4\u308a\u307e\u305b\u3093**\u3002(\u9332\u97f3\u306f\u51fa\u6765\u308b\u3089\u3057\u3044\u3067\u3059\u304c\u672a\u78ba\u8a8d)\n- \u3053\u3053\u3067\u8aac\u660e\u3059\u308b\u624b\u9806\u306f\u30a4\u30f3\u30b9\u30c8\u30fc\u30e9\u30fc\u3092\u30ab\u30b9\u30bf\u30de\u30a4\u30ba\u3057\u3066Macbook\u306bUbuntu MATE\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u307e\u3059\u3002\u306a\u306e\u3067\u3001**\u30a4\u30f3\u30b9\u30c8\u30fc\u30e9\u30fc\u4f5c\u6210\u7528\u306e\u30de\u30b7\u30f3\u304c\u5225\u9014\u5fc5\u8981**\u3067\u3059\u3002\n- 2015\u5e74\u7248\u306eMacBook\u306b\u306f\u304a\u305d\u3089\u304f\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3067\u304d\u307e\u3059\u304c\u3001\u30ad\u30fc\u30dc\u30fc\u30c9\u3068\u30c8\u30e9\u30c3\u30af\u30d1\u30c3\u30c9\u3092\u52d5\u304b\u3059\u624b\u6bb5\u304c**\u898b\u3064\u304b\u3063\u3066\u3044\u306a\u3044**\u306e\u3067\u304a\u52e7\u3081\u3057\u307e\u305b\u3093\u3002\n\n# MacBook Early 2016\u3078\u306eUbuntu MATE 16.10\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\nArch Linux\u306e[Wiki](https://wiki.archlinux.org/index.php/MacBook#April_2016_12.22_-_Version_9.2C1)\u3092\u898b\u308b\u3068kernel 4.6\u4ee5\u4e0a\u306a\u3089\u30a4\u30f3\u30b9\u30c8\u30fc\u30e9\u30fc\u8d77\u52d5\u5f8c\u3001\u30b3\u30f3\u30bd\u30fc\u30eb\u3067\n\n```\n# modprobe nvme\n# echo 106b 2003 > /sys/bus/pci/drivers/nvme/new_id\n```\n\n\u3068\u5165\u529b\u3059\u308c\u3070\u5185\u8535NVMe\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u30fc\u304c\u52d5\u4f5c\u3059\u308b\u306f\u305a\u3067\u3059\u304c\u3001Ubuntu MATE 16.10(kernel 4.8)\u306e\u5834\u5408\u3001\"D3 state\u304b\u3089\u5fa9\u5e30\u3067\u304d\u306a\u3044\uff5e\"\u307f\u305f\u3044\u306a\u30a8\u30e9\u30fc\u304c\u51fa\u3066\u5185\u8535SSD\u3092\u8a8d\u8b58\u3067\u304d\u305a\u3002Debian Stretch\u30a4\u30f3\u30b9\u30c8\u30fc\u30e9\u30fcAlpha7(kernel 4.6)\u3060\u3068\u5185\u8535SSD\u3092\u8a8d\u8b58\u3059\u308b\u304c\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u4e2d\u306b\u983b\u7e41\u306b\u30d5\u30ea\u30fc\u30ba\u3057\u3066\u307e\u3068\u3082\u306b\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u304c\u51fa\u6765\u307e\u305b\u3093\u3067\u3057\u305f\u3002(Debian\u306f5,6\u56de\u30ea\u30c8\u30e9\u30a4\u3057\u7d9a\u3051\u3066\u304b\u308d\u3046\u3058\u3066\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u51fa\u6765\u307e\u3057\u305f\u304c)\n\n\u306a\u306e\u3067Ubuntu MATE 16.10\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30e9\u30fc\u306e\u30ab\u30fc\u30cd\u30eb\u3092\u5dee\u3057\u66ff\u3048\u3066\u3001\u3055\u304f\u3063\u3068\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u51fa\u6765\u308b\u30a4\u30f3\u30b9\u30c8\u30fc\u30e9\u30fc\u3092\u4f5c\u308a\u307e\u3059\u3002\n\n## \u30a4\u30f3\u30b9\u30c8\u30fc\u30e9\u30fc\u30ab\u30b9\u30bf\u30de\u30a4\u30ba\u7528\u306e\u4f5c\u696d\u74b0\u5883\u4f5c\u6210\n\u9069\u5f53\u306a\u30de\u30b7\u30f3(\u4eee\u60f3\u3067\u3082OK)\u306bUbuntu MATE 16.10\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u307e\u3059\u3002\u30cf\u30fc\u30c9\u30c7\u30a3\u30b9\u30af\u306e\u5bb9\u91cf\u306f50GB\u304f\u3089\u3044\u3042\u3063\u305f\u65b9\u304c\u3088\u3044\u3067\u3059\u3002(40GB\u3060\u3068\u30ae\u30ea\u30ae\u30ea)\n\n\u4ee5\u964d\u3001\u3053\u306e\u74b0\u5883\u3092\u300c\u4f5c\u696d\u74b0\u5883\u300d\u3068\u547c\u3073\u307e\u3059\u3002\n\n### \u4f5c\u696d\u74b0\u5883\u306e\u30ab\u30fc\u30cd\u30eb\u66f4\u65b0\nssh\u3067\u4f5c\u696d\u3059\u308b\u306e\u3067\u3001openssh-server\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n```\n$ sudo apt-get update\n$ sudo apt-get -y install openssh-server\n```\n\n\u30ab\u30fc\u30cd\u30eb\u30d1\u30c3\u30b1\u30fc\u30b8\u4f5c\u6210\u306b\u5fc5\u8981\u306a\u30d1\u30c3\u30b1\u30fc\u30b8\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n```\n$ sudo apt-get -y install dpkg-dev debhelper dh-systemd kernel-wedge makedumpfile \\\n libelf-dev libnewt-dev libiberty-dev libdw-dev libpci-dev pkg-config \\\n flex bison libunwind8-dev liblzma-dev libssl-dev libaudit-dev \\\n python-dev libudev-dev autoconf automake libtool uuid-dev xmlto \\\n docbook-utils transfig sharutils asciidoc\n```\n\n\u30db\u30fc\u30e0\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306b\u4f5c\u696d\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\"work\"\u3092\u4f5c\u6210\u3057\u3066\u305d\u306e\u4e2d\u306b\u30ab\u30fc\u30cd\u30eb\u30bd\u30fc\u30b9\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3002\n(launchpad.net\u304b\u3089linux_4.8.0.orig.tar.gz\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3059\u308b\u306e\u306f\u6642\u9593\u304c\u304b\u304b\u308b\u306e\u3067\u30df\u30e9\u30fc\u30b5\u30a4\u30c8\u304b\u3089\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u3066\u30b3\u30f3\u30d0\u30fc\u30c8\u3057\u3066\u3044\u307e\u3059)\n\n```\n$ mkdir ~/work\n$ cd ~/work\n$ wget http://ftp.jaist.ac.jp/pub/Linux/kernel.org/linux/kernel/v4.x/linux-4.8.tar.xz\n$ xz -dc linux-4.8.tar.xz | gzip -9 > linux_4.8.0.orig.tar.gz\n$ rm linux-4.8.tar.xz\n$ wget https://launchpad.net/ubuntu/+archive/primary/+files/linux_4.8.0-27.29.diff.gz\n```\n\n\u30ab\u30fc\u30cd\u30eb\u30bd\u30fc\u30b9\u3092\u5c55\u958b\u3057\u3001\u30d1\u30c3\u30b1\u30fc\u30b8\u306e\u30d1\u30c3\u30c1\u3092\u9069\u7528\n\n```\n$ tar zxf linux_4.8.0.orig.tar.gz\n$ cd linux-4.8/\n$ gzip -dc ../linux_4.8.0-27.29.diff.gz | patch -p1\n```\n\nLinux4.8\u306eNVMe\u30c9\u30e9\u30a4\u30d0\u306fMacBook Early 2016\u306eNVMe\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u30fc\u306eProduct ID\u304c\u5165\u3063\u3066\u3044\u306a\u3044\u306e\u3067\u8ffd\u52a0\u3057\u307e\u3059\u3002\n\n```\n$ cp -p drivers/nvme/host/pci.c drivers/nvme/host/pci.c_orig\n$ vi drivers/nvme/host/pci.c\n```\n\n\u4ee5\u4e0b\u306e\u3068\u304a\u308a\u5909\u66f4\n\n```diff\n--- drivers/nvme/host/pci.c_orig        2016-10-03 08:24:33.000000000 +0900\n+++ drivers/nvme/host/pci.c     2016-11-20 14:17:53.892000000 +0900\n@@ -1635,7 +1635,7 @@\n         * Temporary fix for the Apple controller found in the MacBook8,1 and\n         * some MacBook7,1 to avoid controller resets and data loss.\n         */\n-       if (pdev->vendor == PCI_VENDOR_ID_APPLE && pdev->device == 0x2001) {\n+       if (pdev->vendor == PCI_VENDOR_ID_APPLE && (pdev->device == 0x2001 || pdev->device == 0x2003)) {\n                dev->q_depth = 2;\n                dev_warn(dev->dev, \"detected Apple NVMe controller, set \"\n                        \"queue depth=%u to work around controller resets\\n\",\n@@ -2121,6 +2121,7 @@\n                .driver_data = NVME_QUIRK_DELAY_BEFORE_CHK_RDY, },\n        { PCI_DEVICE_CLASS(PCI_CLASS_STORAGE_EXPRESS, 0xffffff) },\n        { PCI_DEVICE(PCI_VENDOR_ID_APPLE, 0x2001) },\n+       { PCI_DEVICE(PCI_VENDOR_ID_APPLE, 0x2003) },\n        { 0, }\n };\n MODULE_DEVICE_TABLE(pci, nvme_id_table);\n```\n\n\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u30d5\u30a1\u30a4\u30eb\u524a\u9664\n\n```\n$ rm drivers/nvme/host/pci.c_orig\n```\n\n\u4e0a\u8a18\u306e\u4fee\u6b63\u306f http://lists.infradead.org/pipermail/linux-nvme/2016-May/004618.html \u3088\u308a\u3002\u524d\u534a\u306e\u90e8\u5206\u306f\u30aa\u30ea\u30b8\u30ca\u30eb\u306e\u30d1\u30c3\u30c1\u3067\u306f\u4e0d\u8981\u3068\u3055\u308c\u3066\u307e\u3057\u305f\u304c\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u4e2d\u306f\u660e\u3089\u304b\u306b\u3042\u3063\u305f\u307b\u3046\u304c\u826f\u3044\u306e\u3067\u8ffd\u52a0\u3002(\u7121\u3044\u3068\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30cb\u30f3\u30b0\u306e\u3068\u3053\u308d\u3067\u9ad8\u78ba\u7387\u3067\u30d5\u30ea\u30fc\u30ba\u3057\u307e\u3059\u3001\u3068\u3044\u3046\u7a81\u7834\u51fa\u6765\u306a\u3044)\n\n\u30ab\u30fc\u30cd\u30eb\u30d1\u30c3\u30b1\u30fc\u30b8\u30d3\u30eb\u30c9\u3002\u74b0\u5883\u4f9d\u5b58\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u304c\u3001\u624b\u5143\u306e\u74b0\u5883\u3060\u3068ssh\u30ed\u30b0\u30a4\u30f3\u3057\u305f\u72b6\u614b\u3067\u30ab\u30fc\u30cd\u30eb\u30d1\u30c3\u30b1\u30fc\u30b8\u4f5c\u6210\u3092\u884c\u3046\u3068\u9014\u4e2d\u3067\u901a\u4fe1\u304c\u5207\u308c\u308b\u306e\u3067\u3053\u3053\u3060\u3051\u30ed\u30fc\u30ab\u30eb\u3067\u30ed\u30b0\u30a4\u30f3\u3057\u305f\u72b6\u614b\u3067\u5b9f\u884c\u3057\u305f\u65b9\u304c\u3088\u3044\u304b\u3082\u3002\n\n```\n$ dpkg-buildpackage -rfakeroot -us -uc --build=binary\n```\n\n\u6b63\u5e38\u306b\u5b8c\u4e86\u3059\u308b\u3068\u4e00\u3064\u4e0a\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306b\u30ab\u30fc\u30cd\u30eb\u30d1\u30c3\u30b1\u30fc\u30b8\u304c\u4f5c\u6210\u3055\u308c\u307e\u3059\u3002\n\u79fb\u52d5\u3057\u3066\u30ab\u30fc\u30cd\u30eb\u30d1\u30c3\u30b1\u30fc\u30b8\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n```\n$ cd ~/work/\n$ sudo dpkg -i linux-headers-4.8.0-27_4.8.0-27.29_all.deb \\\n  linux-headers-4.8.0-27-generic_4.8.0-27.29_amd64.deb \\\n  linux-image-4.8.0-27-generic_4.8.0-27.29_amd64.deb \\\n  linux-image-extra-4.8.0-27-generic_4.8.0-27.29_amd64.deb \\\n  linux-tools-4.8.0-27_4.8.0-27.29_amd64.deb \\\n  linux-tools-4.8.0-27-generic_4.8.0-27.29_amd64.deb \\\n  linux-tools-common_4.8.0-27.29_all.deb\n```\n\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u5f8c\u3001\u518d\u8d77\u52d5\n\n```\n$ sudo reboot\n```\n\n\u518d\u8d77\u52d5\u5f8c\u30ed\u30b0\u30a4\u30f3\u3002\u4fee\u6b63\u3057\u305fNVMe\u30c9\u30e9\u30a4\u30d0\u306bProduct ID\u304c\u8ffd\u52a0\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u3092\u78ba\u8a8d\n\n```\n$ modinfo nvme\nfilename:       /lib/modules/4.8.0-27-generic/kernel/drivers/nvme/host/nvme.ko\nversion:        1.0\nlicense:        GPL\nauthor:         Matthew Wilcox <willy@linux.intel.com>\nsrcversion:     A270F19E73A377AD815935F\nalias:          pci:v0000106Bd00002003sv*sd*bc*sc*i*   /* d00002003\u304c\u3042\u308c\u3070OK */\nalias:          pci:v0000106Bd00002001sv*sd*bc*sc*i*\n(\u4ee5\u4e0b\u7565)\n```\n\nalias\u306e\u3068\u3053\u308d\u306bDevice-ID==2003\u304c\u3042\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3002\u4f5c\u6210\u3057\u305f\u30ab\u30fc\u30cd\u30eb\u30d1\u30c3\u30b1\u30fc\u30b8\u306f\u3053\u306e\u5f8c\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30e9\u30fc\u306e\u30ab\u30b9\u30bf\u30de\u30a4\u30ba\u3067\u3082\u4f7f\u7528(\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb)\u3057\u307e\u3059\u3002\n\n## \u30a4\u30f3\u30b9\u30c8\u30fc\u30e9\u30fc\u306e\u30ab\u30b9\u30bf\u30de\u30a4\u30ba\n\n\u53c2\u8003\u30b5\u30a4\u30c8\n\n- https://help.ubuntu.com/community/InstallCDCustomization\n- https://help.ubuntu.com/community/LiveCDCustomization\n\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30e9\u30fc\u306e\u4e2d\u8eab\u3092\u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0\u4e0a\u306b\u5c55\u958b\u3057\u3066\u3001\u30ab\u30fc\u30cd\u30eb\u3092NVMe\u30c9\u30e9\u30a4\u30d0\u3092\u4fee\u6b63\u3057\u305f\u3082\u306e\u3068\u5dee\u3057\u66ff\u3048\u307e\u3059\u3002\n\n### \u30a4\u30f3\u30b9\u30c8\u30fc\u30e9\u30fc\u306e\u5c55\u958b\n\n\u4f5c\u696d\u74b0\u5883\u3067Ubuntu MATE 16.10\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30e9\u30fc\u3092/mnt/\u306b\u30de\u30a6\u30f3\u30c8\n\n```\n$ sudo mount /dev/sr0 /mnt/\n```\n\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30e9\u30fc\u306e\u4e2d\u8eab\u3092/opt/cd-image\u306b\u30b3\u30d4\u30fc\n\n```\n$ sudo mkdir /opt/cd-image\n$ sudo rsync -av /mnt/ /opt/cd-image/\n```\n\n\u4f5c\u696d\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3068\u3057\u3066/opt/work\u3092\u4f5c\u6210\u3057\u3001\u30a4\u30f3\u30b9\u30c8\u30fc\u30e9\u30fc\u306e\u30eb\u30fc\u30c8\u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0(Squashfs)\u3092\u5c55\u958b\u3002\"squashfs-root\"\u3068\u3044\u3046\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u304c\u4f5c\u6210\u3055\u308c\u305d\u306e\u4e2d\u306b\u5c55\u958b\u3055\u308c\u307e\u3059\u3002\n\n```\n$ sudo mkdir /opt/work\n$ cd /opt/work\n$ sudo unsquashfs /opt/cd-image/casper/filesystem.squashfs\n```\n\n### \u30a4\u30f3\u30b9\u30c8\u30fc\u30e9\u30fc\u306einitrd\u5909\u66f4\n\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30e9\u30fc\u306einitrd\u306e\u4e2d\u8eab\u3092\u5c55\u958b\n\n```\n$ sudo mkdir /opt/work/installer-initrd\n$ cd /opt/work/installer-initrd/\n$ lzma -dc -S .lz /opt/cd-image/casper/initrd.lz | sudo cpio -imvd --no-absolute-filenames\n```\n\nUbuntu MATE 16.10\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30e9\u30fc\u306e\u30ab\u30fc\u30cd\u30eb\u306f\"4.8.0-22\"\u3068\u3044\u3046\u30d0\u30fc\u30b8\u30e7\u30f3\u3067initrd\u306e\u4e2d\u8eab\u30824.8.0-22\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002\u3053\u308c\u3092\u4f5c\u696d\u74b0\u5883\u306b\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u305f\"4.8.0-27\"\u306b\u5dee\u3057\u66ff\u3048\u307e\u3059\u3002\n\n\u5dee\u3057\u66ff\u3048\u306e\u4e8b\u524d\u6e96\u5099\u3068\u3057\u3066\u4f5c\u696d\u74b0\u5883\u306einitrd\u306baufs\u3092\u8ffd\u52a0\n\n```\n$ echo aufs | sudo tee -a /etc/initramfs-tools/modules\n$ sudo update-initramfs -c -k all\n```\n\n\u66f4\u65b0\u3057\u305f\u4f5c\u696d\u74b0\u5883\u306einitrd\u3092/opt/work/basesystem-initrd\u306b\u5c55\u958b\n\n```\n$ sudo mkdir /opt/work/basesystem-initrd\n$ cd /opt/work/basesystem-initrd/\n$ gzip -dc /boot/initrd.img-4.8.0-27-generic | sudo cpio -imvd --no-absolute-filenames\n```\n\n\u3053\u306e\u6642\u70b9\u3067\u30a4\u30f3\u30b9\u30c8\u30fc\u30e9\u30fc\u306einitrd\u3092/opt/work/installer-initrd/ \u3001\u4f5c\u696d\u74b0\u5883\u306einitrd\u3092/opt/work/basesystem-initrd\u306b\u5c55\u958b\u3057\u305f\u72b6\u614b\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002\n/opt/work/installer-initrd/\u304b\u3089\"4.8.0-22\"\u95a2\u9023\u3092\u524a\u9664\n\n```\n$ sudo rm -rf /opt/work/installer-initrd/lib/modules/4.8.0-22-generic\n$ sudo rm -rf /opt/work/installer-initrd/lib/firmware/4.8.0-22-generic\n$ sudo rm /opt/work/installer-initrd/lib/modprobe.d/blacklist_linux_4.8.0-22-generic.conf\n```\n\n\u4ee3\u308f\u308a\u306bNVMe\u30c9\u30e9\u30a4\u30d0\u3092\u4fee\u6b63\u3057\u305f\u4f5c\u696d\u74b0\u5883\u306e\"4.8.0-27\"\u95a2\u9023\u30d5\u30a1\u30a4\u30eb\u3092/opt/work/installer-initrd/\u3078\u30b3\u30d4\u30fc\n\n```\n$ sudo cp -a /opt/work/basesystem-initrd/lib/modules/4.8.0-27-generic /opt/work/installer-initrd/lib/modules/\n$ sudo cp -a /opt/work/basesystem-initrd/lib/firmware/4.8.0-27-generic /opt/work/installer-initrd/lib/firmware/\n$ sudo cp -p /opt/work/basesystem-initrd/lib/modprobe.d/blacklist_linux_4.8.0-27-generic.conf /opt/work/installer-initrd/lib/modprobe.d/\n```\n\n\u4fee\u6b63\u3057\u305finitrd\u30a4\u30e1\u30fc\u30b8\u518d\u4f5c\u6210\n\n```\n$ cd /opt/work/installer-initrd/\n$ sudo find . | sudo cpio --quiet --dereference -o -H newc | lzma -7 | sudo dd of=/opt/cd-image/casper/initrd.lz\n```\n\n### \u30a4\u30f3\u30b9\u30c8\u30fc\u30e9\u30fc\u306e\u30ab\u30fc\u30cd\u30eb\u66f4\u65b0\n\u30d5\u30a1\u30a4\u30eb\u30921\u500b\u30b3\u30d4\u30fc\u3059\u308b\u3060\u3051\u3002\n\n```\n$ sudo cp /boot/vmlinuz-4.8.0-27-generic  /opt/cd-image/casper/vmlinuz.efi\n```\n\n### \u30a4\u30f3\u30b9\u30c8\u30fc\u30e9\u30fc\u306e\u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0\u7de8\u96c6\n\nSquashfs\u3092\u5c55\u958b\u3057\u305f\u4e2d\u3078chroot\u3057\u3066\u7de8\u96c6\u3057\u307e\u3059\u3002\n\u4e8b\u524d\u6e96\u5099\u3068\u3057\u3066/proc\u7b49\u3092Squashfs\u5c55\u958b\u5148\u306b\u30de\u30a6\u30f3\u30c8\u3002\n\n```\n$ sudo mount -o bind /proc /opt/work/squashfs-root/proc\n$ sudo mount -o bind /dev /opt/work/squashfs-root/dev\n$ sudo mount -t devpts none /opt/work/squashfs-root/dev/pts/\n$ sudo mount -t sysfs none /opt/work/squashfs-root/sys/\n```\n\n\u4f5c\u696d\u74b0\u5883\u306e\u30ab\u30fc\u30cd\u30eb\u66f4\u65b0\u3067\u30d1\u30c3\u30b1\u30fc\u30b8\u3092\u4f5c\u6210\u3057\u305f\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3082Squashfs\u5c55\u958b\u5148\u306b\u30de\u30a6\u30f3\u30c8\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\n```\n$ sudo mkdir /opt/work/squashfs-root/work\n$ sudo mount -o bind ~/work/ /opt/work/squashfs-root/work\n```\n\nSquashfs\u3092\u5c55\u958b\u3057\u305f\u4e2d\u3078chroot\n\n```\n$ sudo chroot /opt/work/squashfs-root/\n```\n\n\u4ee5\u4e0b\u3001chroot\u5185\u4f5c\u696d(\u30d7\u30ed\u30f3\u30d7\u30c8\u304c\"#\")\n\n\u4fee\u6b63\u3057\u305f\u30ab\u30fc\u30cd\u30eb\u30d1\u30c3\u30b1\u30fc\u30b8\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n(chroot\u5185\u3067\u306e\u30b3\u30de\u30f3\u30c9\u5b9f\u884c\u3067locale\u95a2\u9023\u306eWarning\u304c\u51fa\u307e\u3059\u304c\u7121\u8996\u3057\u3066OK) \n\n```\n# cd /work/\n# dpkg -i linux-headers-4.8.0-27_4.8.0-27.29_all.deb \\\n  linux-headers-4.8.0-27-generic_4.8.0-27.29_amd64.deb \\\n  linux-image-4.8.0-27-generic_4.8.0-27.29_amd64.deb \\\n  linux-image-extra-4.8.0-27-generic_4.8.0-27.29_amd64.deb \\\n  linux-tools-4.8.0-27-generic_4.8.0-27.29_amd64.deb \\\n  linux-tools-4.8.0-27_4.8.0-27.29_amd64.deb \\\n  linux-tools-common_4.8.0-27.29_all.deb\n```\n\n\u4e0d\u8981\u30d1\u30c3\u30b1\u30fc\u30b8(\u53e4\u3044\u30ab\u30fc\u30cd\u30eb\u30d1\u30c3\u30b1\u30fc\u30b8)\u3092\u524a\u9664\n\n```\n# apt-get purge linux-signed-image-4.8.0-22-generic \\\n  linux-signed-image-generic linux-signed-generic \\\n  linux-headers-4.8.0-22-generic linux-headers-4.8.0-22 \\\n  linux-image-4.8.0-22-generic linux-image-extra-4.8.0-22-generic \\\n  linux-tools-4.8.0-22 linux-tools-4.8.0-22-generic\n```\n\ngrub\u306e\u30c7\u30d5\u30a9\u30eb\u30c8\u8a2d\u5b9a\u5909\u66f4\u3002intremap=nosid\u3092\u8ffd\u52a0\u3057\u3066\u66f4\u65b0(\u30ad\u30fc\u30dc\u30fc\u30c9\uff06\u30c8\u30e9\u30c3\u30af\u30d1\u30c3\u30c9\u306e\u30c9\u30e9\u30a4\u30d0\u306e\u52d5\u4f5c\u306b\u5fc5\u8981)\n\n```\n# sed -i 's/^kopt_params=\"\"/kopt_params=\"intremap=nosid\"/' /usr/share/grub-installer/grub-installer\n# ucf --purge /etc/default/grub\n# sed -i 's/^GRUB_CMDLINE_LINUX=\"\"/GRUB_CMDLINE_LINUX=\"intremap=nosid\"/' /etc/default/grub\n# ucf /etc/default/grub /etc/default/grub\n# update-grub\n```\n\n\u4ee5\u4e0a\u3002chroot\u304b\u3089\u629c\u3051\u308b\n\n```\n# exit\n```\n\nSquashfs\u5c55\u958b\u5148\u306b\u30de\u30a6\u30f3\u30c8\u3057\u3066\u304a\u3044\u305f\u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0\u3092\u30a2\u30f3\u30de\u30a6\u30f3\u30c8\n\n```\n$ sudo umount /opt/work/squashfs-root/proc\n$ sudo umount /opt/work/squashfs-root/dev/pts\n$ sudo umount /opt/work/squashfs-root/dev\n$ sudo umount /opt/work/squashfs-root/sys\n$ sudo umount /opt/work/squashfs-root/work\n```\n\n\u4e00\u6642\u7684\u306b\u4f5c\u6210\u3057\u305f\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u524a\u9664\n\n```\n$ sudo rmdir /opt/work/squashfs-root/work\n```\n\n\u6539\u5909\u3057\u305fSquashfs\u30a4\u30e1\u30fc\u30b8\u518d\u4f5c\u6210\n\n```\n$ sudo chmod +w /opt/cd-image/casper/filesystem.manifest\n$ sudo chroot /opt/work/squashfs-root  dpkg-query -W  | sudo tee /opt/cd-image/casper/filesystem.manifest\n$ sudo rm /opt/cd-image/casper/filesystem.squashfs\n$ sudo mksquashfs /opt/work/squashfs-root  /opt/cd-image/casper/filesystem.squashfs  -comp xz\n```\n\n### \u30a4\u30f3\u30b9\u30c8\u30fc\u30e9\u30fc\u30a4\u30e1\u30fc\u30b8\u518d\u4f5c\u6210\n\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30e9\u30fc\u306e\u30ab\u30fc\u30cd\u30eb\u30aa\u30d7\u30b7\u30e7\u30f3\u5909\u66f4\u3002\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u6642\u306b\u5fc5\u8981\u306anoapic\u3092\u8ffd\u52a0\u3002(isolinux\u3068grub\u306e\u4e21\u65b9\u3092\u5909\u3048\u3066\u3044\u307e\u3059\u304cMacBook\u3067\u4f7f\u308f\u308c\u308b\u306e\u306fgrub)\n\n```\n$ sudo sed -i 's/initrd.lz quiet/initrd.lz noapic quiet/' /opt/cd-image/isolinux/txt.cfg\n$ sudo sed -i 's/quiet splash/quiet noapic splash/' /opt/cd-image/boot/grub/grub.cfg\n```\n\n\u30d5\u30a1\u30a4\u30eb\u30ea\u30b9\u30c8\u3068MD5\u30c1\u30a7\u30c3\u30af\u30b5\u30e0\u4f5c\u6210\n\n```\n$ printf $(sudo du -sx --block-size=1 /opt/work/squashfs-root | cut -f1) | sudo tee /opt/cd-image/casper/filesystem.size\n$ sudo rm /opt/cd-image/md5sum.txt\n$ cd /opt/cd-image/\n$ sudo find -type f -print0 | sudo xargs -0 md5sum | grep -v isolinux/boot.cat | sudo tee md5sum.txt\n```\n\nISO\u30a4\u30e1\u30fc\u30b8\u4f5c\u6210\n\n```\n$ sudo mkdir /opt/newimage\n$ cd /opt/cd-image/\n$ sudo IMAGE=/opt/newimage/custom.iso BUILD=/opt/cd-image/  mkisofs -r -V \"Custom Test\" -cache-inodes -J -l \\\n -b isolinux/isolinux.bin -c isolinux/boot.cat \\\n -no-emul-boot -boot-load-size 4 -boot-info-table \\\n -o /opt/newimage/custom.iso /opt/cd-image/\n```\n\n/opt/newimage/custom.iso \u306b1.4GB\u304f\u3089\u3044\u306e\u30cf\u30a4\u30d6\u30ea\u30c3\u30c9\u30a4\u30e1\u30fc\u30b8\u304c\u51fa\u6765\u308b\u306e\u3067USB\u30e1\u30e2\u30ea\u306b\u66f8\u304d\u51fa\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\n## \u30ab\u30b9\u30bf\u30e0\u30a4\u30f3\u30b9\u30c8\u30fc\u30e9\u30fc\u3092\u4f7f\u3063\u305fMacBook Early 2016\u3078\u306eUbuntu MATE 16.10\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n\u30ab\u30b9\u30bf\u30de\u30a4\u30ba\u3057\u305f\u30a4\u30f3\u30b9\u30c8\u30fc\u30e9\u30fc\u3067\u8d77\u52d5\u3057Ubuntu MATE\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u307e\u3059\u3002\n\u8aac\u660e\u306f\u7279\u306b\u5fc5\u8981\u306a\u3044\u3068\u601d\u3044\u307e\u3059\u304c\u3001\u6ce8\u610f\u70b9\u3068\u3057\u3066\u306f\n\n- MacOS\u3082\u4f7f\u3044\u7d9a\u3051\u305f\u3044\u5834\u5408\u306f\u4e8b\u524d\u306bMacOS\u4e0a\u3067\u7a7a\u304d\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u3092\u4f5c\u3063\u3066\u304a\u3044\u305f\u65b9\u304c\u3088\u3044\u3067\u3057\u3087\u3046\u3002\n- \u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u4e2d\u306b\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u306b\u7e4b\u3052\u308b\u3068\u305b\u3063\u304b\u304fNVMe\u30c9\u30e9\u30a4\u30d0\u3092\u4fee\u6b63\u3057\u305f\u30ab\u30fc\u30cd\u30eb\u304c\u4e0a\u66f8\u304d\u3055\u308c\u3066\u3057\u307e\u3046\u6050\u308c\u304c\u3042\u308b\u306e\u3067\u3001\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u4e2d\u306f\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u306b\u7e4b\u3052\u306a\u3044\u65b9\u304c\u78ba\u5b9f\u3067\u3059\u3002\n"}