{"context": " More than 1 year has passed since last update.\n\n\u306f\u3058\u3081\u306b\n\u30c7\u30d7\u30ed\u30a4\u4f5c\u696d\u3092\u30b3\u30de\u30f3\u30c9\u3072\u3068\u3064\u3067\u7c21\u5358\u306b\u51fa\u6765\u308b\u3088\u3046\u306b\u3059\u308b\u305f\u3081\u306b\u3001Ruby\u88fd\u306e\u30c7\u30d7\u30ed\u30a4\u30c4\u30fc\u30eb\u3067\u3042\u308bcapistrano\u3092\u4f7f\u3063\u3066\u307f\u307e\u3059\u3002\n\u4eca\u56de\u306f\u3001AWS\u306b\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u304c\u3068\u308a\u3042\u3048\u305a\u30b5\u30fc\u30d0\u30fc\u69cb\u7bc9\u51fa\u6765\u305f\u72b6\u614b\u304b\u3089Capistrano\u3092\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u3057\u3066\u3044\u304d\u305f\u3044\u3068\u601d\u3044\u307e\u3059\u3002\n\u4ee5\u4e0b\u306e\u30012\u3064\u306e\u8a18\u4e8b\u3067VPC\u3068EC2\u306e\u69cb\u7bc9\u3068\u3001unicorn\u3068nginx\u306e\u5c0e\u5165\u304c\u51fa\u6765\u3066\u3044\u308b\u72b6\u614b\u304b\u3089\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u3057\u3066\u3044\u304d\u307e\u3059\u3002\nAWS VPC\u306b\u3088\u308b\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u69cb\u7bc9\u3068EC2\u306b\u3088\u308b\u30b5\u30fc\u30d0\u30fc\u69cb\u7bc9\nRails\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306eAWS\u306b\u3088\u308b\u516c\u958b\uff5cunicorn + nginx\n\u306a\u304a\u3001\u4e0a\u8a18\u8a18\u4e8b\u3068\u540c\u69d8\u306b\u300cprotospace\u300d\u3068\u3044\u3046\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3092\u30b5\u30fc\u30d0\u30fc\u306b\u300cshizuma\u300d\u3068\u3044\u3046\u30e6\u30fc\u30b6\u30fc\u3067\u4f5c\u6210\u3057\u3066\u3044\u304d\u307e\u3059\u3002\n\u4f5c\u696d\u306f\u3001\u300clocal\u300d\u3068\u300cserver\u300d\u306e\u4f5c\u696d\u3069\u3061\u3089\u304b\u78ba\u304b\u3081\u306a\u304c\u3089\u9032\u3081\u3066\u4e0b\u3055\u3044\u3002\u30b3\u30de\u30f3\u30c9\u3092\u8a18\u8f09\u3057\u305f\u30a8\u30ea\u30a2\u306e\u5de6\u7aef\u306b\u8a18\u8ff0\u3057\u3066\u3044\u307e\u3059\u3002\n\u307e\u305f\u3001\u6539\u5584\u70b9\u304c\u3042\u308a\u307e\u3057\u305f\u3089\u30b3\u30e1\u30f3\u30c8\u9802\u3051\u307e\u3059\u3068\u5e78\u3044\u3067\u3059\u3002\n\nCapistrano\u306e\u5c0e\u5165\n\nlocal\n[protospace] vi Gemfile\n-----------------------------\n# gem\u30d5\u30a1\u30a4\u30eb\u306e\u4e2d\u306bunicorn\u3001capistrano\u95a2\u9023\u306egem\u3092\u8ffd\u8a18\u3057\u3066\u4e0b\u3055\u3044\u3002\ngroup :production, :staging do\n  gem 'unicorn'\n  gem 'capistrano'\n  gem 'capistrano-bundler'\n  gem 'capistrano-rails'\n  gem 'capistrano-rbenv'\n  gem 'capistrano3-unicorn'\nend\n-----------------------------\n[protospace] bundle install\n[protospace] bundle exec cap install\n-----------------------------\n# \u4ee5\u4e0b\u306e\u3088\u3046\u306b\u30d5\u30a1\u30a4\u30eb\u304c\u751f\u6210\u3055\u308c\u307e\u3059\nmkdir -p config/deploy\ncreate config/deploy.rb\ncreate config/deploy/staging.rb\ncreate config/deploy/production.rb\nmkdir -p lib/capistrano/tasks\ncreate Capfile\nCapified\n-----------------------------\n\n\n\n\u5404\u7a2e\u30d5\u30a1\u30a4\u30eb\u306e\u7de8\u96c6\n\nunicorn\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\n\nlocal\n[protospace] vi config/unicorn.conf.rb\n# \u4ee5\u4e0b\u306e\u3088\u3046\u306b\u8a18\u8ff0\n-----------------------------\n  # set lets\n  $worker  = 2\n  $timeout = 30\n  $app_dir = \"/var/www/rails/protospace/current\" #\u81ea\u5206\u306e\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u540d\u3001current\u304c\u3064\u304f\u3053\u3068\u306b\u6ce8\u610f\u3002\n  $listen  = File.expand_path 'tmp/sockets/.unicorn.sock', $app_dir\n  $pid     = File.expand_path 'tmp/pids/unicorn.pid', $app_dir\n  $std_log = File.expand_path 'log/unicorn.log', $app_dir\n  # set config\n  worker_processes  $worker\n  working_directory $app_dir\n  stderr_path $std_log\n  stdout_path $std_log\n  timeout $timeout\n  listen  $listen\n  pid $pid\n  # loading booster\n  preload_app true\n  # before starting processes\n  before_fork do |server, worker|\n    defined?(ActiveRecord::Base) and ActiveRecord::Base.connection.disconnect!\n    old_pid = \"#{server.config[:pid]}.oldbin\"\n    if old_pid != server.pid\n      begin\n        Process.kill \"QUIT\", File.read(old_pid).to_i\n      rescue Errno::ENOENT, Errno::ESRCH\n      end\n    end\n  end\n  # after finishing processes\n  after_fork do |server, worker|\n    defined?(ActiveRecord::Base) and ActiveRecord::Base.establish_connection\n  end\n-----------------------------\n\n\n\nCapfile\u306e\u7de8\u96c6\n\nlocal\n[protospace] vi Capfile\n-----------------------------\n# Load DSL and set up stages\nrequire 'capistrano/setup'\n\n# Include default deployment tasks\nrequire 'capistrano/deploy'\n\n# Include tasks from other gems included in your Gemfile\n#\n# For documentation on these, see for example:\n#\n#   https://github.com/capistrano/rvm\n#   https://github.com/capistrano/rbenv\n#   https://github.com/capistrano/chruby\n#   https://github.com/capistrano/bundler\n#   https://github.com/capistrano/rails\n#   https://github.com/capistrano/passenger\n#\n# require 'capistrano/rvm'\nrequire 'capistrano/rbenv' #\u30b3\u30e1\u30f3\u30c8\u30a2\u30a6\u30c8\u3092\u306f\u305a\u3059\n# require 'capistrano/chruby'\nrequire 'capistrano/bundler' #\u30b3\u30e1\u30f3\u30c8\u30a2\u30a6\u30c8\u3092\u306f\u305a\u3059\nrequire 'capistrano/rails/assets' #\u30b3\u30e1\u30f3\u30c8\u30a2\u30a6\u30c8\u3092\u306f\u305a\u3059\nrequire 'capistrano/rails/migrations' #\u30b3\u30e1\u30f3\u30c8\u30a2\u30a6\u30c8\u3092\u306f\u305a\u3059\n# require 'capistrano/passenger'\nrequire 'capistrano3/unicorn' #\u8ffd\u8a18\n\n# Load custom tasks from `lib/capistrano/tasks` if you have any defined\nDir.glob('lib/capistrano/tasks/*.task').each { |r| import r }\n-----------------------------\n\n\n\ncapistrano/tasks/unicorn.task\u306e\u8a2d\u5b9a\n\nlocal\n[protospace] vi lib/capistrano/tasks/unicorn.task\n# unicorn\u306etask\u306e\u8a18\u8ff0\u3002unicorn\u306e\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u3067\u3059\u3002\n-----------------------------\nnamespace :unicorn do\n  task :environment do\n    set :unicorn_pid,    \"#{current_path}/tmp/pids/unicorn.pid\"\n    set :unicorn_config, \"#{current_path}/config/unicorn.conf.rb\"\n  end\n  def start_unicorn\n    within current_path do\n      execute :bundle, :exec, :unicorn, \"-c #{fetch(:unicorn_config)} -E #{fetch(:rails_env)} -D\"\n    end\n  end\n  def stop_unicorn\n    execute :kill, \"-s QUIT $(< #{fetch(:unicorn_pid)})\"\n  end\n  def reload_unicorn\n    execute :kill, \"-s USR2 $(< #{fetch(:unicorn_pid)})\"\n  end\n  def force_stop_unicorn\n    execute :kill, \"$(< #{fetch(:unicorn_pid)})\"\n  end\n  desc \"Start unicorn server\"\n  task start: :environment do\n    on roles(:app) do\n      start_unicorn\n    end\n  end\n  desc \"Stop unicorn server gracefully\"\n  task stop: :environment do\n    on roles(:app) do\n      stop_unicorn\n    end\n  end\n  desc \"Restart unicorn server gracefully\"\n  task restart: :environment do\n    on roles(:app) do\n      if test(\"[ -f #{fetch(:unicorn_pid)} ]\")\n        reload_unicorn\n      else\n        start_unicorn\n      end\n    end\n  end\n  desc \"Stop unicorn server immediately\"\n  task force_stop: :environment do\n    on roles(:app) do\n      force_stop_unicorn\n    end\n  end\nend\n-----------------------------\n\n\n\nlocal\n[protospace] vi config/deploy/production.rb\n# production\u74b0\u5883\u306e\u30b5\u30fc\u30d0\u30fc\u60c5\u5831\n-----------------------------\n#\u4e0b\u8a18\u3092\u8ffd\u8a18\u3059\u308b\nserver '00.00.000.000', user: 'shizuma', roles: %w{app} #server\u306eip\u3068user\u540d\u306f\u9069\u5b9c\nset :ssh_options, keys: '~/.ssh/first_aws_rsa' #ssh_key\u306e\u540d\u524d\u306f\u9069\u5b9c\n-----------------------------\n\n\n\nlocal\n[protospace] vi config/deploy.rb\n-----------------------------\n# config valid only for current version of Capistrano\nlock '3.4.0'\n\n# \u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u540d\nset :application, 'protospace'\n\n# deploy\u3059\u308b\u30ec\u30dd\u30b8\u30c8\u30ea\nset :repo_url, 'git@github.com:kuboshizuma/protospace.git'\n\n# Default branch is :master\n# deploy\u3059\u308b\u30d6\u30e9\u30f3\u30c1\u3002\u30c7\u30d5\u30a9\u30eb\u30c8\u306fmaster\u306a\u306e\u3067\u306a\u304f\u3066\u3082\u53ef\u3002\nset :branch, 'master'\n# ask :branch, `git rev-parse --abbrev-ref HEAD`.chomp\n\n# Default deploy_to directory is /var/www/my_app_name\n# deploy\u5148\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\nset :deploy_to, '/var/www/rails/protospace'\n\n# Default value for :scm is :git\n# set :scm, :git\n\n# Default value for :format is :pretty\n# set :format, :pretty\n\n# Default value for :log_level is :debug\n# set :log_level, :debug\n\n# Default value for :pty is false\n# set :pty, true\n\n# Default value for :linked_files is []\n# \u30b7\u30f3\u30dc\u30ea\u30c3\u30af\u30ea\u30f3\u30af\u3092\u306f\u308b\u30d5\u30a1\u30a4\u30eb\u3002\u4eca\u56de\u306fgem\u306econfig\u3092\u4f7f\u7528\u3057\u3066\u3001production.yml\u3092\u5171\u901a\u5316\u3002\nset :linked_files, fetch(:linked_files, []).push('config/settings/production.yml')\n\n# Default value for linked_dirs is []\n# \u30b7\u30f3\u30dc\u30ea\u30c3\u30af\u30ea\u30f3\u30af\u3092\u306f\u308b\u30d5\u30a9\u30eb\u30c0\u3002\nset :linked_dirs, fetch(:linked_dirs, []).push('log', 'tmp/pids', 'tmp/cache', 'tmp/sockets', 'vendor/bundle', 'public/system')\n\n# Default value for default_env is {}\n# set :default_env, { path: \"/opt/ruby/bin:$PATH\" }\n\n# Default value for keep_releases is 5\n# \u4fdd\u6301\u3059\u308b\u30d0\u30fc\u30b8\u30e7\u30f3\u306e\u500b\u6570\nset :keep_releases, 5\n\n# ruby\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\nset :rbenv_ruby, '2.1.3'\n\nnamespace :deploy do\n  desc 'Restart application'\n  task :restart do\n    invoke 'unicorn:restart'\n  end\n  desc 'Create database'\n  task :db_create do\n    on roles(:db) do |host|\n      with rails_env: fetch(:rails_env) do\n        within current_path do\n          execute :bundle, :exec, :rake, 'db:create'\n        end\n      end\n    end\n  end\n  desc 'Run seed'\n  task :seed do\n    on roles(:app) do\n      with rails_env: fetch(:rails_env) do\n        within current_path do\n          execute :bundle, :exec, :rake, 'db:seed'\n        end\n      end\n    end\n  end\n  after :publishing, :restart\n  after :restart, :clear_cache do\n    on roles(:web), in: :groups, limit: 3, wait: 10 do\n      # Here we can do anything such as:\n      # within release_path do\n      #   execute :rake, 'cache:clear'\n      # end\n    end\n  end\nend\n-----------------------------\n\n\n\n\u74b0\u5883\u5909\u6570\u306e\u8a2d\u5b9a\n\u4eca\u56de\u306fconfig\u3068\u3044\u3046gem\u3092\u4f7f\u3063\u3066\u3044\u307e\u3059\u3002dotenv\u3068\u304b\u3067\u3082\u3044\u3044\u3068\u601d\u3044\u307e\u3059\u3002\n\u3053\u306e\u8a2d\u5b9a\u306f\u9069\u5b9c\u5fc5\u8981\u306b\u5fdc\u3058\u3066\u8a2d\u5b9a\u3057\u3066\u4e0b\u3055\u3044\u3002(\u305f\u3060\u3057\u3001secret_key_base\u306e\u8a2d\u5b9a\u306f\u5fc5\u8981\u306b\u306a\u308a\u307e\u3059\u3002)\n\nlocal\n[protospace] vi config/database.yml\n-----------------------------\nproduction:\n  <<: *default\n  database: protospace_production\n  username: <%= Settings.database[:user_name] %>\n  password: <%= Settings.database[:password] %>\n-----------------------------\n\n[protospace] vi config/secret.yml\n-----------------------------\nproduction:\n  secret_key_base: <%= Settings.production[:secret] %>\n-----------------------------\n\n[protospace] rake secret RAILS_ENV=production\nerfffer34gfdv19b5ec7523a23tgrege45gertf3d15b94dfgvere23r34g87253a6f6b7b80c6cb47c598e000500b4654143gergfwer3r4cca04d\n\n\n\nserver\n[shizuma|protospace] mkdir -p shared/config/settings/\n[shizuma|protospace] vi shared/config/settings/production.yml\n-----------------------------\ndatabase:\n  user_name: 'root'\n  password:\nproduction:\n  secret: 'erfffer34gfdv19b5ec7523a23tgrege45gertf3d15b94dfgvere23r34g87253a6f6b7b80c6cb47c598e000500b4654143gergfwer3r4cca04d'\n-----------------------------\n\n\n\nnginx\u306e\u8a2d\u5b9a\nrelease\u30d0\u30fc\u30b8\u30e7\u30f3\u306fcurrent\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306a\u306e\u3067\u5fae\u8abf\u6574\u3002\n\nserver\n[shizuma|~] sudo yum install nginx\n[shizuma|~]$ cd /etc/nginx/conf.d/\n[shizuma|conf.d]$ sudo vi protospace.conf \n----------------------------\n  # log directory\n  error_log  /var/www/rails/protospace/current/log/nginx.error.log; #current\u3064\u3051\u308b\n  access_log /var/www/rails/protospace/current/log/nginx.access.log; #current\u3064\u3051\u308b\n  # max body size\n  client_max_body_size 2G;\n  upstream app_server {\n    # for UNIX domain socket setups\n    server unix:/var/www/rails/protospace/current/tmp/sockets/.unicorn.sock fail_timeout=0; #current\u3064\u3051\u308b\n  }\n  server {\n    listen 80;\n    server_name 127.0.0.1;\n    # nginx so increasing this is generally safe...\n    keepalive_timeout 5;\n    # path for static files\n    root /var/www/rails/protospace/current/public; #current\u3064\u3051\u308b\n    # page cache loading\n    try_files $uri/index.html $uri.html $uri @app;\n    location @app {\n      # HTTP headers\n      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n      proxy_set_header Host $http_host;\n      proxy_redirect off;\n      proxy_pass http://app_server;\n    }\n    # Rails error pages\n    error_page 500 502 503 504 /500.html;\n    location = /500.html {\n      root /var/www/rails/protospace/current/public; #current\u3064\u3051\u308b\n    }\n  }\n----------------------------\n[shizuma|protospace]$ sudo nginx -s reload # nginx\u306e\u518d\u8d77\u52d5\n\n\n\ngithub\u3078\u5909\u66f4\u3092push\n\nlocal\n[protospace] git add .\n[protospace] git commit -m \"Add for deploy by capistrano\"\n[protospace] git push origin master\n\n\n\n\u30c7\u30d7\u30ed\u30a4\n\nlocal\n[protospace] bundle exec cap deploy production\n\n\n\u3053\u308c\u3067\u3001\u5b8c\u4e86\uff01\n\n\u30a8\u30e9\u30fc\u5bfe\u5fdc\n\nrails_config\ngem\u3067rails_config\u3092\u4f7f\u3063\u3066\u3044\u305f\u304c\u3001\u30a8\u30e9\u30fc\u304c\u51fa\u305f\u306e\u3067\u3001config\u3068\u3044\u3046gem\u306b\u5909\u66f4\u3002\n\nmysql2\n\u30d0\u30fc\u30b8\u30e7\u30f3\u6307\u5b9a\u3067\u5bfe\u5fdc\u3002\nRails mysql2\u3067rake db:create\u304c\u30a8\u30e9\u30fc\u554f\u984c\n\n/tmp/mysql.sock\u30a8\u30e9\u30fc\n\u30b7\u30f3\u30dc\u30ea\u30c3\u30af\u30ea\u30f3\u30af\u3067\u5bfe\u5fdc\u3002\n$ ln -s /var/lib/mysql/mysql.sock /tmp/mysql.sock\n\n\n\u53c2\u8003\nAWS\u306f\u3053\u308c\u3067\u5927\u4e08\u592b\uff5cunicorn + nginx + capistrano + slackistrano \u306e\u30b3\u30de\u30f3\u30c9\u4e00\u89a7\n# \u306f\u3058\u3081\u306b\n\u30c7\u30d7\u30ed\u30a4\u4f5c\u696d\u3092\u30b3\u30de\u30f3\u30c9\u3072\u3068\u3064\u3067\u7c21\u5358\u306b\u51fa\u6765\u308b\u3088\u3046\u306b\u3059\u308b\u305f\u3081\u306b\u3001Ruby\u88fd\u306e\u30c7\u30d7\u30ed\u30a4\u30c4\u30fc\u30eb\u3067\u3042\u308bcapistrano\u3092\u4f7f\u3063\u3066\u307f\u307e\u3059\u3002\n\n\u4eca\u56de\u306f\u3001AWS\u306b\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u304c\u3068\u308a\u3042\u3048\u305a\u30b5\u30fc\u30d0\u30fc\u69cb\u7bc9\u51fa\u6765\u305f\u72b6\u614b\u304b\u3089Capistrano\u3092\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u3057\u3066\u3044\u304d\u305f\u3044\u3068\u601d\u3044\u307e\u3059\u3002\n\n\u4ee5\u4e0b\u306e\u30012\u3064\u306e\u8a18\u4e8b\u3067VPC\u3068EC2\u306e\u69cb\u7bc9\u3068\u3001unicorn\u3068nginx\u306e\u5c0e\u5165\u304c\u51fa\u6765\u3066\u3044\u308b\u72b6\u614b\u304b\u3089\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u3057\u3066\u3044\u304d\u307e\u3059\u3002\n[AWS VPC\u306b\u3088\u308b\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u69cb\u7bc9\u3068EC2\u306b\u3088\u308b\u30b5\u30fc\u30d0\u30fc\u69cb\u7bc9](http://qiita.com/shizuma/items/396ad15ff574717dfa1d)\n[Rails\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306eAWS\u306b\u3088\u308b\u516c\u958b\uff5cunicorn + nginx](http://qiita.com/shizuma/items/d4ae7d4374aeb90df648)\n\n\u306a\u304a\u3001\u4e0a\u8a18\u8a18\u4e8b\u3068\u540c\u69d8\u306b\u300cprotospace\u300d\u3068\u3044\u3046\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3092\u30b5\u30fc\u30d0\u30fc\u306b\u300cshizuma\u300d\u3068\u3044\u3046\u30e6\u30fc\u30b6\u30fc\u3067\u4f5c\u6210\u3057\u3066\u3044\u304d\u307e\u3059\u3002\n\u4f5c\u696d\u306f\u3001\u300clocal\u300d\u3068\u300cserver\u300d\u306e\u4f5c\u696d\u3069\u3061\u3089\u304b\u78ba\u304b\u3081\u306a\u304c\u3089\u9032\u3081\u3066\u4e0b\u3055\u3044\u3002\u30b3\u30de\u30f3\u30c9\u3092\u8a18\u8f09\u3057\u305f\u30a8\u30ea\u30a2\u306e\u5de6\u7aef\u306b\u8a18\u8ff0\u3057\u3066\u3044\u307e\u3059\u3002\n\n\u307e\u305f\u3001\u6539\u5584\u70b9\u304c\u3042\u308a\u307e\u3057\u305f\u3089\u30b3\u30e1\u30f3\u30c8\u9802\u3051\u307e\u3059\u3068\u5e78\u3044\u3067\u3059\u3002\n\n# Capistrano\u306e\u5c0e\u5165\n\n```rb:local\n[protospace] vi Gemfile\n-----------------------------\n# gem\u30d5\u30a1\u30a4\u30eb\u306e\u4e2d\u306bunicorn\u3001capistrano\u95a2\u9023\u306egem\u3092\u8ffd\u8a18\u3057\u3066\u4e0b\u3055\u3044\u3002\ngroup :production, :staging do\n  gem 'unicorn'\n  gem 'capistrano'\n  gem 'capistrano-bundler'\n  gem 'capistrano-rails'\n  gem 'capistrano-rbenv'\n  gem 'capistrano3-unicorn'\nend\n-----------------------------\n[protospace] bundle install\n[protospace] bundle exec cap install\n-----------------------------\n# \u4ee5\u4e0b\u306e\u3088\u3046\u306b\u30d5\u30a1\u30a4\u30eb\u304c\u751f\u6210\u3055\u308c\u307e\u3059\nmkdir -p config/deploy\ncreate config/deploy.rb\ncreate config/deploy/staging.rb\ncreate config/deploy/production.rb\nmkdir -p lib/capistrano/tasks\ncreate Capfile\nCapified\n-----------------------------\n```\n\n# \u5404\u7a2e\u30d5\u30a1\u30a4\u30eb\u306e\u7de8\u96c6\n\n## unicorn\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\n\n```rb:local\n[protospace] vi config/unicorn.conf.rb\n# \u4ee5\u4e0b\u306e\u3088\u3046\u306b\u8a18\u8ff0\n-----------------------------\n  # set lets\n  $worker  = 2\n  $timeout = 30\n  $app_dir = \"/var/www/rails/protospace/current\" #\u81ea\u5206\u306e\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u540d\u3001current\u304c\u3064\u304f\u3053\u3068\u306b\u6ce8\u610f\u3002\n  $listen  = File.expand_path 'tmp/sockets/.unicorn.sock', $app_dir\n  $pid     = File.expand_path 'tmp/pids/unicorn.pid', $app_dir\n  $std_log = File.expand_path 'log/unicorn.log', $app_dir\n  # set config\n  worker_processes  $worker\n  working_directory $app_dir\n  stderr_path $std_log\n  stdout_path $std_log\n  timeout $timeout\n  listen  $listen\n  pid $pid\n  # loading booster\n  preload_app true\n  # before starting processes\n  before_fork do |server, worker|\n    defined?(ActiveRecord::Base) and ActiveRecord::Base.connection.disconnect!\n    old_pid = \"#{server.config[:pid]}.oldbin\"\n    if old_pid != server.pid\n      begin\n        Process.kill \"QUIT\", File.read(old_pid).to_i\n      rescue Errno::ENOENT, Errno::ESRCH\n      end\n    end\n  end\n  # after finishing processes\n  after_fork do |server, worker|\n    defined?(ActiveRecord::Base) and ActiveRecord::Base.establish_connection\n  end\n-----------------------------\n```\n\n## Capfile\u306e\u7de8\u96c6\n\n```rb:local\n[protospace] vi Capfile\n-----------------------------\n# Load DSL and set up stages\nrequire 'capistrano/setup'\n\n# Include default deployment tasks\nrequire 'capistrano/deploy'\n\n# Include tasks from other gems included in your Gemfile\n#\n# For documentation on these, see for example:\n#\n#   https://github.com/capistrano/rvm\n#   https://github.com/capistrano/rbenv\n#   https://github.com/capistrano/chruby\n#   https://github.com/capistrano/bundler\n#   https://github.com/capistrano/rails\n#   https://github.com/capistrano/passenger\n#\n# require 'capistrano/rvm'\nrequire 'capistrano/rbenv' #\u30b3\u30e1\u30f3\u30c8\u30a2\u30a6\u30c8\u3092\u306f\u305a\u3059\n# require 'capistrano/chruby'\nrequire 'capistrano/bundler' #\u30b3\u30e1\u30f3\u30c8\u30a2\u30a6\u30c8\u3092\u306f\u305a\u3059\nrequire 'capistrano/rails/assets' #\u30b3\u30e1\u30f3\u30c8\u30a2\u30a6\u30c8\u3092\u306f\u305a\u3059\nrequire 'capistrano/rails/migrations' #\u30b3\u30e1\u30f3\u30c8\u30a2\u30a6\u30c8\u3092\u306f\u305a\u3059\n# require 'capistrano/passenger'\nrequire 'capistrano3/unicorn' #\u8ffd\u8a18\n\n# Load custom tasks from `lib/capistrano/tasks` if you have any defined\nDir.glob('lib/capistrano/tasks/*.task').each { |r| import r }\n-----------------------------\n```\n\n## capistrano/tasks/unicorn.task\u306e\u8a2d\u5b9a\n\n```rb:local\n[protospace] vi lib/capistrano/tasks/unicorn.task\n# unicorn\u306etask\u306e\u8a18\u8ff0\u3002unicorn\u306e\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u3067\u3059\u3002\n-----------------------------\nnamespace :unicorn do\n  task :environment do\n    set :unicorn_pid,    \"#{current_path}/tmp/pids/unicorn.pid\"\n    set :unicorn_config, \"#{current_path}/config/unicorn.conf.rb\"\n  end\n  def start_unicorn\n    within current_path do\n      execute :bundle, :exec, :unicorn, \"-c #{fetch(:unicorn_config)} -E #{fetch(:rails_env)} -D\"\n    end\n  end\n  def stop_unicorn\n    execute :kill, \"-s QUIT $(< #{fetch(:unicorn_pid)})\"\n  end\n  def reload_unicorn\n    execute :kill, \"-s USR2 $(< #{fetch(:unicorn_pid)})\"\n  end\n  def force_stop_unicorn\n    execute :kill, \"$(< #{fetch(:unicorn_pid)})\"\n  end\n  desc \"Start unicorn server\"\n  task start: :environment do\n    on roles(:app) do\n      start_unicorn\n    end\n  end\n  desc \"Stop unicorn server gracefully\"\n  task stop: :environment do\n    on roles(:app) do\n      stop_unicorn\n    end\n  end\n  desc \"Restart unicorn server gracefully\"\n  task restart: :environment do\n    on roles(:app) do\n      if test(\"[ -f #{fetch(:unicorn_pid)} ]\")\n        reload_unicorn\n      else\n        start_unicorn\n      end\n    end\n  end\n  desc \"Stop unicorn server immediately\"\n  task force_stop: :environment do\n    on roles(:app) do\n      force_stop_unicorn\n    end\n  end\nend\n-----------------------------\n```\n\n```rb:local\n[protospace] vi config/deploy/production.rb\n# production\u74b0\u5883\u306e\u30b5\u30fc\u30d0\u30fc\u60c5\u5831\n-----------------------------\n#\u4e0b\u8a18\u3092\u8ffd\u8a18\u3059\u308b\nserver '00.00.000.000', user: 'shizuma', roles: %w{app} #server\u306eip\u3068user\u540d\u306f\u9069\u5b9c\nset :ssh_options, keys: '~/.ssh/first_aws_rsa' #ssh_key\u306e\u540d\u524d\u306f\u9069\u5b9c\n-----------------------------\n```\n\n```rb:local\n[protospace] vi config/deploy.rb\n-----------------------------\n# config valid only for current version of Capistrano\nlock '3.4.0'\n\n# \u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u540d\nset :application, 'protospace'\n\n# deploy\u3059\u308b\u30ec\u30dd\u30b8\u30c8\u30ea\nset :repo_url, 'git@github.com:kuboshizuma/protospace.git'\n\n# Default branch is :master\n# deploy\u3059\u308b\u30d6\u30e9\u30f3\u30c1\u3002\u30c7\u30d5\u30a9\u30eb\u30c8\u306fmaster\u306a\u306e\u3067\u306a\u304f\u3066\u3082\u53ef\u3002\nset :branch, 'master'\n# ask :branch, `git rev-parse --abbrev-ref HEAD`.chomp\n\n# Default deploy_to directory is /var/www/my_app_name\n# deploy\u5148\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\nset :deploy_to, '/var/www/rails/protospace'\n\n# Default value for :scm is :git\n# set :scm, :git\n\n# Default value for :format is :pretty\n# set :format, :pretty\n\n# Default value for :log_level is :debug\n# set :log_level, :debug\n\n# Default value for :pty is false\n# set :pty, true\n\n# Default value for :linked_files is []\n# \u30b7\u30f3\u30dc\u30ea\u30c3\u30af\u30ea\u30f3\u30af\u3092\u306f\u308b\u30d5\u30a1\u30a4\u30eb\u3002\u4eca\u56de\u306fgem\u306econfig\u3092\u4f7f\u7528\u3057\u3066\u3001production.yml\u3092\u5171\u901a\u5316\u3002\nset :linked_files, fetch(:linked_files, []).push('config/settings/production.yml')\n\n# Default value for linked_dirs is []\n# \u30b7\u30f3\u30dc\u30ea\u30c3\u30af\u30ea\u30f3\u30af\u3092\u306f\u308b\u30d5\u30a9\u30eb\u30c0\u3002\nset :linked_dirs, fetch(:linked_dirs, []).push('log', 'tmp/pids', 'tmp/cache', 'tmp/sockets', 'vendor/bundle', 'public/system')\n\n# Default value for default_env is {}\n# set :default_env, { path: \"/opt/ruby/bin:$PATH\" }\n\n# Default value for keep_releases is 5\n# \u4fdd\u6301\u3059\u308b\u30d0\u30fc\u30b8\u30e7\u30f3\u306e\u500b\u6570\nset :keep_releases, 5\n\n# ruby\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\nset :rbenv_ruby, '2.1.3'\n\nnamespace :deploy do\n  desc 'Restart application'\n  task :restart do\n    invoke 'unicorn:restart'\n  end\n  desc 'Create database'\n  task :db_create do\n    on roles(:db) do |host|\n      with rails_env: fetch(:rails_env) do\n        within current_path do\n          execute :bundle, :exec, :rake, 'db:create'\n        end\n      end\n    end\n  end\n  desc 'Run seed'\n  task :seed do\n    on roles(:app) do\n      with rails_env: fetch(:rails_env) do\n        within current_path do\n          execute :bundle, :exec, :rake, 'db:seed'\n        end\n      end\n    end\n  end\n  after :publishing, :restart\n  after :restart, :clear_cache do\n    on roles(:web), in: :groups, limit: 3, wait: 10 do\n      # Here we can do anything such as:\n      # within release_path do\n      #   execute :rake, 'cache:clear'\n      # end\n    end\n  end\nend\n-----------------------------\n```\n\n## \u74b0\u5883\u5909\u6570\u306e\u8a2d\u5b9a\n\u4eca\u56de\u306fconfig\u3068\u3044\u3046gem\u3092\u4f7f\u3063\u3066\u3044\u307e\u3059\u3002dotenv\u3068\u304b\u3067\u3082\u3044\u3044\u3068\u601d\u3044\u307e\u3059\u3002\n\u3053\u306e\u8a2d\u5b9a\u306f\u9069\u5b9c\u5fc5\u8981\u306b\u5fdc\u3058\u3066\u8a2d\u5b9a\u3057\u3066\u4e0b\u3055\u3044\u3002(\u305f\u3060\u3057\u3001secret_key_base\u306e\u8a2d\u5b9a\u306f\u5fc5\u8981\u306b\u306a\u308a\u307e\u3059\u3002)\n\n```:local\n[protospace] vi config/database.yml\n-----------------------------\nproduction:\n  <<: *default\n  database: protospace_production\n  username: <%= Settings.database[:user_name] %>\n  password: <%= Settings.database[:password] %>\n-----------------------------\n\n[protospace] vi config/secret.yml\n-----------------------------\nproduction:\n  secret_key_base: <%= Settings.production[:secret] %>\n-----------------------------\n\n[protospace] rake secret RAILS_ENV=production\nerfffer34gfdv19b5ec7523a23tgrege45gertf3d15b94dfgvere23r34g87253a6f6b7b80c6cb47c598e000500b4654143gergfwer3r4cca04d\n```\n\n```rb:server\n[shizuma|protospace] mkdir -p shared/config/settings/\n[shizuma|protospace] vi shared/config/settings/production.yml\n-----------------------------\ndatabase:\n  user_name: 'root'\n  password:\nproduction:\n  secret: 'erfffer34gfdv19b5ec7523a23tgrege45gertf3d15b94dfgvere23r34g87253a6f6b7b80c6cb47c598e000500b4654143gergfwer3r4cca04d'\n-----------------------------\n```\n\n## nginx\u306e\u8a2d\u5b9a\nrelease\u30d0\u30fc\u30b8\u30e7\u30f3\u306fcurrent\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306a\u306e\u3067\u5fae\u8abf\u6574\u3002\n\n```rb:server\n[shizuma|~] sudo yum install nginx\n[shizuma|~]$ cd /etc/nginx/conf.d/\n[shizuma|conf.d]$ sudo vi protospace.conf \n----------------------------\n  # log directory\n  error_log  /var/www/rails/protospace/current/log/nginx.error.log; #current\u3064\u3051\u308b\n  access_log /var/www/rails/protospace/current/log/nginx.access.log; #current\u3064\u3051\u308b\n  # max body size\n  client_max_body_size 2G;\n  upstream app_server {\n    # for UNIX domain socket setups\n    server unix:/var/www/rails/protospace/current/tmp/sockets/.unicorn.sock fail_timeout=0; #current\u3064\u3051\u308b\n  }\n  server {\n    listen 80;\n    server_name 127.0.0.1;\n    # nginx so increasing this is generally safe...\n    keepalive_timeout 5;\n    # path for static files\n    root /var/www/rails/protospace/current/public; #current\u3064\u3051\u308b\n    # page cache loading\n    try_files $uri/index.html $uri.html $uri @app;\n    location @app {\n      # HTTP headers\n      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n      proxy_set_header Host $http_host;\n      proxy_redirect off;\n      proxy_pass http://app_server;\n    }\n    # Rails error pages\n    error_page 500 502 503 504 /500.html;\n    location = /500.html {\n      root /var/www/rails/protospace/current/public; #current\u3064\u3051\u308b\n    }\n  }\n----------------------------\n[shizuma|protospace]$ sudo nginx -s reload # nginx\u306e\u518d\u8d77\u52d5\n```\n\n# github\u3078\u5909\u66f4\u3092push\n```rb:local\n[protospace] git add .\n[protospace] git commit -m \"Add for deploy by capistrano\"\n[protospace] git push origin master\n```\n\n# \u30c7\u30d7\u30ed\u30a4\n```:local\n[protospace] bundle exec cap deploy production\n```\n\n\u3053\u308c\u3067\u3001\u5b8c\u4e86\uff01\n\n# \u30a8\u30e9\u30fc\u5bfe\u5fdc\n## rails_config\ngem\u3067rails_config\u3092\u4f7f\u3063\u3066\u3044\u305f\u304c\u3001\u30a8\u30e9\u30fc\u304c\u51fa\u305f\u306e\u3067\u3001config\u3068\u3044\u3046gem\u306b\u5909\u66f4\u3002\n\n## mysql2\n\u30d0\u30fc\u30b8\u30e7\u30f3\u6307\u5b9a\u3067\u5bfe\u5fdc\u3002\n\n[Rails mysql2\u3067rake db:create\u304c\u30a8\u30e9\u30fc\u554f\u984c](http://qiita.com/shizuma/items/0f9660d5d46a0012eb9e)\n\n## /tmp/mysql.sock\u30a8\u30e9\u30fc\n\u30b7\u30f3\u30dc\u30ea\u30c3\u30af\u30ea\u30f3\u30af\u3067\u5bfe\u5fdc\u3002\n\n```\n$ ln -s /var/lib/mysql/mysql.sock /tmp/mysql.sock\n```\n\n# \u53c2\u8003\n[AWS\u306f\u3053\u308c\u3067\u5927\u4e08\u592b\uff5cunicorn + nginx + capistrano + slackistrano \u306e\u30b3\u30de\u30f3\u30c9\u4e00\u89a7](http://qiita.com/Yama-to/items/1e1d889e6d5f7cc7f281)\n", "tags": ["vpc", "EC2", "AWS", "capistrano", "Rails"]}