{"context": " More than 1 year has passed since last update.PRML\u56f38.51\u306e\u6728\u69cb\u9020\u56e0\u5b50\u30b0\u30e9\u30d5\u306b\u3064\u3044\u3066\u3001max-sum\u30a2\u30eb\u30b4\u30ea\u30ba\u30e0\u306b\u3088\u308a\u3001\u540c\u6642\u78ba\u7387\u306e\u6700\u5927\u5024\u3068\u3001\u305d\u308c\u3092\u4e0e\u3048\u308b\u5909\u6570\u5024\u306e\u7d44\u3092\u6c42\u3081\u307e\u3059\u3002\n\u53c2\u8003\u307e\u3067\u306b\u5404\u30ce\u30fc\u30c9xn\u306e\u5468\u8fba\u5206\u5e03\u3082\u6c42\u3081\u3066\u3044\u307e\u3059\u3002(\u540c\u6642\u78ba\u7387\u3092\u5408\u8a08\u3059\u308b\u7d20\u6734\u306a\u65b9\u6cd5\u3067\u3059)\n\u307e\u305a\u3001\u7d20\u6734\u306b\u5f0f8.89\u306e\u901a\u308a\u3001x\u304c\u3068\u308a\u3046\u308b\u72b6\u614b\u3059\u3079\u3066\u306e\u5834\u5408\u306b\u3064\u3044\u3066\u306e\u540c\u6642\u78ba\u7387\u3092\u6c42\u3081\u3066\u3001\u305d\u306e\u6700\u5927\u5024\u3092\u4e0e\u3048\u308b\u5909\u6570\u5024\u306e\u7d44\u3092\u6c42\u3081\u307e\u3059\u3002\n\u4e00\u65b9\u3001max-sum\u30a2\u30eb\u30b4\u30ea\u30ba\u30e0\u3092\u7528\u3044\u3066\u3001\u6728\u306e\u8449\u304b\u3089\u6839\u65b9\u5411\u306b\u30e1\u30c3\u30bb\u30fc\u30b8\u30d1\u30c3\u30b7\u30f3\u30b0\u3092\u884c\u3046\u3053\u3068\u3067\u3001\u5f0f8.97\u306e\u3088\u3046\u306b\u3001\u6700\u5927\u540c\u6642\u78ba\u7387\u304c\u6c42\u307e\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\u3055\u3089\u306b\u3001\u305d\u306e\u6700\u5927\u540c\u6642\u78ba\u7387\u3092\u4e0e\u3048\u308b\u6839\u30ce\u30fc\u30c9\u306e\u5909\u6570\u5024\u3092\u57fa\u306b\u3001\u6839\u304b\u3089\u8449\u65b9\u5411\u306b\u30d0\u30c3\u30af\u30c8\u30e9\u30c3\u30af\u3092\u884c\u3046\u3053\u3068\u3067\u3001\u5f0f8.102\u306e\u3088\u3046\u306b\u3001\u6839\u30ce\u30fc\u30c9\u306e\u5909\u6570\u5024\u3068\u7d44\u306b\u306a\u308b\u3001\u5404\u5909\u6570\u30ce\u30fc\u30c9\u306e\u5909\u6570\u5024\u304c\u5f97\u3089\u308c\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\uff08\u305f\u3060\u3057\u3001\u6700\u5927\u540c\u6642\u78ba\u7387\u5024\u3092\u7b97\u51fa\u3059\u308b\u969b\u3001\u78ba\u7387\u5024\u306e\u5408\u8a08\u30921\u306b\u3059\u308b\u305f\u3081\u306e\u6b63\u898f\u5316\u4fc2\u6570Z\u306b\u306f\u3001\u4e8b\u524d\u306b\u6c42\u3081\u305f\u5024\u3092\u4f7f\u3063\u3066\u3044\u307e\u3059\u3002\u5b9f\u969b\u306b\u306f\u7a4d\u548c\u30a2\u30eb\u30b4\u30ea\u30ba\u30e0\u306a\u3069\u3067\u6c42\u3081\u308b\u3053\u3068\u306b\u306a\u308b\u3068\u601d\u3044\u307e\u3059\u3002\uff09\n\u306a\u304a\u3001\u5404\u5909\u6570\u30ce\u30fc\u30c9xn\u306f3\u500b\u306e\u72b6\u614b\u3092\u3068\u308b\u3082\u306e\u3068\u3057\u307e\u3059\u3002\u56e0\u5b50\u30ce\u30fc\u30c95,6\u306e\u56e0\u5b50f(x1,x2)\u306f\u3001x1==x2\u306e\u3068\u304d0.8\u3001\u305d\u3046\u3067\u306a\u3044\u3068\u304d0.1\u3068\u3057\u3066\u3044\u307e\u3059\u3002\u56e0\u5b50\u30ce\u30fc\u30c97\u306e\u56e0\u5b50f(x1,x2)\u306f\u3001\u5468\u8fba\u5206\u5e03\u306e\u6700\u5927\u5024\u3092\u4e0e\u3048\u308b\u5909\u6570\u5024\u306e\u7d44\u306b\u3088\u308b\u540c\u6642\u78ba\u7387\u304c\u30010\u3068\u306a\u3063\u3066\u3057\u307e\u3046\u3088\u3046\u306a\u540c\u6642\u5206\u5e03\u3068\u3057\u3066\u3044\u307e\u3059\u3002(\u6f14\u7fd28.27\u3068\u540c\u69d8\u3002\u4e0b\u8868\u53c2\u7167)\n\n\n\np(x1,x2)\nx1=0\nx1=1\nx1=2\np(x2)\n\n\n\n\nx2=0\n0.00\n0.00\n0.16\n0.16\n\n\nx2=1\n0.00\n0.00\n0.34\n0.34\n\n\nx2=2\n0.16\n0.34\n0.00\n0.50\n\n\np(x1)\n0.16\n0.34\n0.50\n1.00\n\n\n\n\u307e\u305f\u3001\u5909\u6570\u30ce\u30fc\u30c9x1\u306b\u50241\u3092\u89b3\u6e2c\u3057\u305f\u3068\u304d\u3001\u304a\u3088\u3073\u5909\u6570\u30ce\u30fc\u30c9x2\u306b\u50241\u3092\u89b3\u6e2c\u3057\u305f\u3068\u304d\u306e\u6700\u5927\u540c\u6642\u78ba\u7387\u3068\u3001\u305d\u308c\u3092\u4e0e\u3048\u308b\u5909\u6570\u5024\u306e\u7d44\u3082\u6c42\u3081\u307e\u3059\u3002\n\nlibrary(igraph)\nlibrary(plotrix)\nframe()\nset.seed(0)\npar(mfrow=c(3, 4))\npar(mar=c(2, 2, 2, 0))\npar(mgp=c(1, 0, 0))\nK <- 3\nN <- 4\nROOT <- 3\ng <- graph(c(1, N+1, N+1, 2, 4, N+2, N+2, 2, 2, N+3, N+3, 3), directed=F)\nV(g)$size <- 40\nV(g)$label.cex <- 1.5\nV(g)$shape <- \"circle\"\nV(g)$shape[(N+1):(N+3)] <- \"square\"\n\npxy <- matrix(c(\n    0.00, 0.00, 0.16,\n    0.00, 0.00, 0.34,\n    0.16, 0.34, 0.00\n    ), 3, byrow=T)\n\npotential1 <- function(n, xparent, xchild) {\n    # \u56e0\u6570\u30ce\u30fc\u30c9n\u306e\u30dd\u30c6\u30f3\u30b7\u30e3\u30eb\u95a2\u6570\n    #   xparent:\u4e0a\u5c64\u5909\u6570\u30ce\u30fc\u30c9\n    #   xchild:\u4e0b\u5c64\u5909\u6570\u30ce\u30fc\u30c9\n\n    if (n == 7) {\n        p <- pxy[xchild + 1, xparent + 1]\n    } else {\n        p <- ifelse(xparent == xchild, 0.8, 0.1)\n    }\n    p\n}\npotential2 <- function(n, xparent, xchild) {\n\n    p <- potential1(n, xparent, xchild)\n    # \u5909\u6570\u30ce\u30fc\u30c91\u306b1\u3092\u89b3\u6e2c\n    OBSERVED <- 1\n    if (n == 5) {\n        p <- p * ifelse(xchild == OBSERVED, 1, 0)\n    }\n    p\n}\npotential3 <- function(n, xparent, xchild) {\n\n    p <- potential1(n, xparent, xchild)\n    # \u5909\u6570\u30ce\u30fc\u30c92\u306b1\u3092\u89b3\u6e2c\n    OBSERVED <- 1\n    if (n == 5 || n == 6) {\n        p <- p * ifelse(xparent == OBSERVED, 1, 0)\n    } else if (n == 7) {\n        p <- p * ifelse(xchild == OBSERVED, 1, 0)\n    }\n    p\n}\n\ndoplot.marginal.joint <- function(potential) {\n\n    # \u540c\u6642\u5206\u5e03\u3092\u6c42\u3081\u308b\n    d <- data.frame()\n    for (i in 0:(K^N - 1)) {  # O(K^N)\n        total.potential <- 1\n        xs <- c()\n        xs <- c(xs, (i) %% K)\n        for (n in 1:(N-1)) {\n            xn1 <- (i %/% K ^ (n - 1)) %% K\n            xn2 <- (i %/% K ^ n) %% K\n            xs <- c(xs, xn2)\n        }\n        total.potential <- (potential(5, xs[2], xs[1]) * potential(6, xs[2], xs[4]) * potential(7, xs[3], xs[2]))\n        d <- rbind(d, c(xs, total.potential))\n    }\n    names(d) <- c(paste0(\"x\", 1:N), \"p\")\n    cat(\"p(x)\\n\");print(rbind(head(d),tail(d)))\n\n    # \u540c\u6642\u5206\u5e03\u306e\u548c\u306b\u3088\u308a\u5468\u8fba\u5206\u5e03\u3092\u6c42\u3081\u308b\n    ps <- matrix(nrow=N, ncol=K)\n    rownames(ps) <- 1:N\n    colnames(ps) <- 0:(K-1)\n    z <- sum(d$p)\n    for (n in 1:N) {\n        for (xn in 0:(K-1)) {\n            ps[n, xn + 1] <- sum(d[d[, n] == xn, ]$p) / z\n        }\n    }\n    cat(\"p(xn)\\n\");print(ps)\n    barplot(t(ps), legend=0:(K-1), xlab=\"xn\", ylab=\"p(xn)\")\n    title(\"marginal prob.\")\n}\n\ndoplot.max.joint <- function(potential) {\n\n    # \u540c\u6642\u5206\u5e03\u3092\u6c42\u3081\u308b\n    d <- data.frame()\n    for (i in 0:(K^N - 1)) {  # O(K^N)\n        total.potential <- 1\n        xs <- c()\n        xs <- c(xs, (i) %% K)\n        for (n in 1:(N-1)) {\n            xn1 <- (i %/% K ^ (n - 1)) %% K\n            xn2 <- (i %/% K ^ n) %% K\n            xs <- c(xs, xn2)\n        }\n        total.potential <- (potential(5, xs[2], xs[1]) * potential(6, xs[2], xs[4]) * potential(7, xs[3], xs[2]))\n        d <- rbind(d, c(xs, total.potential))\n    }\n    names(d) <- c(paste0(\"x\", 1:N), \"p\")\n    cat(\"p(x)\\n\");print(rbind(head(d),tail(d)))\n\n    # \u540c\u6642\u5206\u5e03\u304c\u6700\u5927\u306e\u3082\u306e\u3092\u6c42\u3081\u308b\n    z <- sum(d$p)\n    d$p <- d$p / z\n    pmax <- max(d$p)\n    cat(\"p(xmax)\\n\");print(d[d$p == pmax, ])\n    frame()\n    addtable2plot(0, 0, table=round(d[d$p == pmax, ], 6))\n    title(\"max joint prob.\\nof all\")\n    z\n}\n\ndoplot.max.message <- function(potential, z) {\n\n    mu <- as.data.frame(matrix(c(-1, -1, rep(NA, K)), ncol=2 + K))\n    names(mu) <- c(\"from\", \"to\", 0:(K-1))\n    phi <- as.data.frame(matrix(c(-1, -1, rep(NA, K)), ncol=2 + K))\n    names(phi) <- c(\"from\", \"to\", 0:(K-1))\n\n    mufxUp <- function(from, to) {\n        # \u4e0b\u5c64\u304b\u3089\u306e\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u6c42\u3081\u3001\u305d\u308c\u3092\u57fa\u306b\u3001\u56e0\u5b50\u30ce\u30fc\u30c9from\u304b\u3089\u5909\u6570\u30ce\u30fc\u30c9to\u3078\u306e\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u6c42\u3081\u308b\n\n        # \u4e0b\u5c64\u304b\u3089\u306e\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u5148\u306b\u6c42\u3081\u308b\n        children <- neighbors(g, from)\n        for (child in children) {\n            if (child != to) {\n                muxfUp(child, from)\n            }\n        }\n        # to\u4ee5\u5916\u304b\u3089\u306e\u30e1\u30c3\u30bb\u30fc\u30b8(\u306e\u548c)\u306b\u30dd\u30c6\u30f3\u30b7\u30e3\u30eb\u306e\u5bfe\u6570\u3092\u8db3\u3057\u305f\u3082\u306e\u306e\u3001to\u4ee5\u5916\u306e\u78ba\u7387\u5909\u6570\u5024\u306b\u95a2\u3059\u308b\u6700\u5927\u5024\u3092\u6c42\u3081\u308b\n        p <- rep(NA, K)\n        h <- rep(NA, K)\n        for (x in 0:(K-1)) {  # O(K^\u96a3\u63a5\u30ce\u30fc\u30c9\u6570)\n            m <- as.matrix(mu[mu$from == children[children != to] & mu$to == from, c(-1, -2)])\n            s <- log(potential(from, x, 0:(K-1))) + m\n            # \u6700\u5927\u5024\u3092\u4e0e\u3048\u308bx\u3092\u8a18\u9332\u3059\u308b\n            h[x + 1] <- which.max(s) - 1\n            # \u6700\u5927\u5024\u3092\u8a18\u9332\u3059\u308b\n            p[x + 1] <- max(s[h[x + 1] + 1])\n        }\n        mu <<- rbind(mu, c(from, to, p))\n        phi <<- rbind(phi, c(from, to, h))\n        p\n    }\n    muxfUp <- function(from, to) {\n        # \u4e0b\u5c64\u304b\u3089\u306e\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u6c42\u3081\u3001\u305d\u308c\u3092\u57fa\u306b\u3001\u5909\u6570\u30ce\u30fc\u30c9from\u304b\u3089\u56e0\u5b50\u30ce\u30fc\u30c9to\u3078\u306e\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u6c42\u3081\u308b\n\n        # to\u4ee5\u5916\u306e\u30e1\u30c3\u30bb\u30fc\u30b8(\u306e\u548c)\u3092\u6c42\u3081\u308b\n        p <- rep(0, K)\n        for (child in neighbors(g, from)) {\n            if (child != to) {\n                p <- p + mufxUp(child, from)\n            }\n        }\n        mu <<- rbind(mu, c(from, to, p))\n        p\n    }\n    backtrackFx <- function(from, to, xmax) {\n        # \u56e0\u5b50\u30ce\u30fc\u30c9from\u304b\u3089\u5909\u6570\u30ce\u30fc\u30c9to\u3078\u30d0\u30c3\u30af\u30c8\u30e9\u30c3\u30af\u3059\u308b\n\n        # \u6700\u5927\u540c\u6642\u78ba\u7387\u3092\u4e0e\u3048\u308b\u3088\u3046\u306a\u3001\u5909\u6570\u30ce\u30fc\u30c9to\u306b\u304a\u3051\u308bx\u3092\u8a18\u9332\u3059\u308b\n        dmax[, to] <<- xmax\n\n        # \u4e0b\u5c64\u3078\u30d0\u30c3\u30af\u30c8\u30e9\u30c3\u30af\u3059\u308b\n        for (child in neighbors(g, to)) {\n            if (child != from) {\n                backtrackXf(to, child, xmax)\n            }\n        }\n    }\n    backtrackXf <- function(from, to, xmax) {\n        # \u5909\u6570\u30ce\u30fc\u30c9from\u304b\u3089\u56e0\u5b50\u30ce\u30fc\u30c9to\u3078\u30d0\u30c3\u30af\u30c8\u30e9\u30c3\u30af\u3059\u308b\n\n        # \u5909\u6570\u30ce\u30fc\u30c9from\u3067xmax\u3092\u4e0e\u3048\u305fx\u3092\u6c42\u3081\u308b\n        h <- as.numeric(phi[phi$from == to & phi$to == from, c(-1, -2)])\n        xprevious <- h[xmax + 1]\n\n        # \u4e0b\u5c64\u3078\u30d0\u30c3\u30af\u30c8\u30e9\u30c3\u30af\u3059\u308b\n        for (child in neighbors(g, to)) {\n            if (child != from) {\n                backtrackFx(to, child, xprevious)\n            }\n        }\n    }\n\n    # \u4e0b\u5c64\u304b\u3089\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u9001\u308b\n    mufxUp(neighbors(g, ROOT)[1], ROOT)\n    cat(\"mu\\n\");print(mu)\n    cat(\"phi\\n\");print(phi)\n\n    # \u6839\u30ce\u30fc\u30c9xN\u3078\u306e\u30e1\u30c3\u30bb\u30fc\u30b8\u306e\u5408\u8a08\u306e\u6700\u5927\u5024\u3092\u4e0e\u3048\u308bx\u3092\u8a18\u9332\u3059\u308b\n    m <- as.matrix(mu[mu$to == ROOT, c(-1, -2)])\n    s <- colSums(m)\n    xmax <- which(s == max(s)) - 1\n    # \u305d\u306e\u6700\u5927\u5024\u304c\u3001\u6700\u5927\u540c\u6642\u78ba\u7387\u3068\u306a\u308b\n    pmax <- exp(s[xmax + 1]) / z\n\n    # xmax\u3092\u57fa\u306b\u30d0\u30c3\u30af\u30c8\u30e9\u30c3\u30af\u3057\u3001\u5404xmax\u306e\u8981\u7d20\u306b\u5bfe\u5fdc\u3059\u308bx\u3092\u6c42\u3081\u308b\n    dmax <- data.frame(matrix(NA, ncol=N, nrow=length(xmax)), p = pmax)\n    names(dmax) <- c(paste0(\"x\", 1:N), \"p\")\n    dmax[, ROOT] <- xmax\n    backtrackXf(ROOT, neighbors(g, ROOT)[1], xmax)\n    cat(\"p(xmax)\\n\");print(dmax)\n\n    frame()\n    addtable2plot(0, 0, table=round(dmax, 6))\n    title(\"max joint prob.\\nby max-sum\")\n}\n\nV(g)$color=\"white\"\nplot(g, layout=layout.reingold.tilford(g, root=ROOT))\ndoplot.marginal.joint(potential1)\nz <- doplot.max.joint(potential1)\ndoplot.max.message(potential1, z)\n\nV(g)$color=\"white\"\nV(g)$color[1]=\"gray\"\nplot(g, layout=layout.reingold.tilford(g, root=ROOT))\ndoplot.marginal.joint(potential2)\nz <- doplot.max.joint(potential2)\ndoplot.max.message(potential2, z)\n\nV(g)$color=\"white\"\nV(g)$color[2]=\"gray\"\nplot(g, layout=layout.reingold.tilford(g, root=ROOT))\ndoplot.marginal.joint(potential3)\nz <- doplot.max.joint(potential3)\ndoplot.max.message(potential3, z)\n\nPRML\u56f38.51\u306e\u6728\u69cb\u9020\u56e0\u5b50\u30b0\u30e9\u30d5\u306b\u3064\u3044\u3066\u3001max-sum\u30a2\u30eb\u30b4\u30ea\u30ba\u30e0\u306b\u3088\u308a\u3001\u540c\u6642\u78ba\u7387\u306e\u6700\u5927\u5024\u3068\u3001\u305d\u308c\u3092\u4e0e\u3048\u308b\u5909\u6570\u5024\u306e\u7d44\u3092\u6c42\u3081\u307e\u3059\u3002\n\n\u53c2\u8003\u307e\u3067\u306b\u5404\u30ce\u30fc\u30c9xn\u306e\u5468\u8fba\u5206\u5e03\u3082\u6c42\u3081\u3066\u3044\u307e\u3059\u3002(\u540c\u6642\u78ba\u7387\u3092\u5408\u8a08\u3059\u308b\u7d20\u6734\u306a\u65b9\u6cd5\u3067\u3059)\n\n\u307e\u305a\u3001\u7d20\u6734\u306b\u5f0f8.89\u306e\u901a\u308a\u3001x\u304c\u3068\u308a\u3046\u308b\u72b6\u614b\u3059\u3079\u3066\u306e\u5834\u5408\u306b\u3064\u3044\u3066\u306e\u540c\u6642\u78ba\u7387\u3092\u6c42\u3081\u3066\u3001\u305d\u306e\u6700\u5927\u5024\u3092\u4e0e\u3048\u308b\u5909\u6570\u5024\u306e\u7d44\u3092\u6c42\u3081\u307e\u3059\u3002\n\n\u4e00\u65b9\u3001max-sum\u30a2\u30eb\u30b4\u30ea\u30ba\u30e0\u3092\u7528\u3044\u3066\u3001\u6728\u306e\u8449\u304b\u3089\u6839\u65b9\u5411\u306b\u30e1\u30c3\u30bb\u30fc\u30b8\u30d1\u30c3\u30b7\u30f3\u30b0\u3092\u884c\u3046\u3053\u3068\u3067\u3001\u5f0f8.97\u306e\u3088\u3046\u306b\u3001\u6700\u5927\u540c\u6642\u78ba\u7387\u304c\u6c42\u307e\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\u3055\u3089\u306b\u3001\u305d\u306e\u6700\u5927\u540c\u6642\u78ba\u7387\u3092\u4e0e\u3048\u308b\u6839\u30ce\u30fc\u30c9\u306e\u5909\u6570\u5024\u3092\u57fa\u306b\u3001\u6839\u304b\u3089\u8449\u65b9\u5411\u306b\u30d0\u30c3\u30af\u30c8\u30e9\u30c3\u30af\u3092\u884c\u3046\u3053\u3068\u3067\u3001\u5f0f8.102\u306e\u3088\u3046\u306b\u3001\u6839\u30ce\u30fc\u30c9\u306e\u5909\u6570\u5024\u3068\u7d44\u306b\u306a\u308b\u3001\u5404\u5909\u6570\u30ce\u30fc\u30c9\u306e\u5909\u6570\u5024\u304c\u5f97\u3089\u308c\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\uff08\u305f\u3060\u3057\u3001\u6700\u5927\u540c\u6642\u78ba\u7387\u5024\u3092\u7b97\u51fa\u3059\u308b\u969b\u3001\u78ba\u7387\u5024\u306e\u5408\u8a08\u30921\u306b\u3059\u308b\u305f\u3081\u306e\u6b63\u898f\u5316\u4fc2\u6570Z\u306b\u306f\u3001\u4e8b\u524d\u306b\u6c42\u3081\u305f\u5024\u3092\u4f7f\u3063\u3066\u3044\u307e\u3059\u3002\u5b9f\u969b\u306b\u306f\u7a4d\u548c\u30a2\u30eb\u30b4\u30ea\u30ba\u30e0\u306a\u3069\u3067\u6c42\u3081\u308b\u3053\u3068\u306b\u306a\u308b\u3068\u601d\u3044\u307e\u3059\u3002\uff09\n\n\u306a\u304a\u3001\u5404\u5909\u6570\u30ce\u30fc\u30c9xn\u306f3\u500b\u306e\u72b6\u614b\u3092\u3068\u308b\u3082\u306e\u3068\u3057\u307e\u3059\u3002\u56e0\u5b50\u30ce\u30fc\u30c95,6\u306e\u56e0\u5b50f(x1,x2)\u306f\u3001x1==x2\u306e\u3068\u304d0.8\u3001\u305d\u3046\u3067\u306a\u3044\u3068\u304d0.1\u3068\u3057\u3066\u3044\u307e\u3059\u3002\u56e0\u5b50\u30ce\u30fc\u30c97\u306e\u56e0\u5b50f(x1,x2)\u306f\u3001\u5468\u8fba\u5206\u5e03\u306e\u6700\u5927\u5024\u3092\u4e0e\u3048\u308b\u5909\u6570\u5024\u306e\u7d44\u306b\u3088\u308b\u540c\u6642\u78ba\u7387\u304c\u30010\u3068\u306a\u3063\u3066\u3057\u307e\u3046\u3088\u3046\u306a\u540c\u6642\u5206\u5e03\u3068\u3057\u3066\u3044\u307e\u3059\u3002(\u6f14\u7fd28.27\u3068\u540c\u69d8\u3002\u4e0b\u8868\u53c2\u7167)\n\n|p(x1,x2)|x1=0\t|x1=1\t|x1=2\t|p(x2) |\n|--:|--:|--:|--:|--:|\n|x2=0\t|0.00 \t|0.00 \t|0.16 \t|0.16 |\n|x2=1\t|0.00 \t|0.00 \t|0.34 \t|0.34 |\n|x2=2\t|0.16 \t|0.34 \t|0.00 \t|0.50 |\n|p(x1)\t|0.16 \t|0.34 \t|0.50 \t|1.00 |\n\n\u307e\u305f\u3001\u5909\u6570\u30ce\u30fc\u30c9x1\u306b\u50241\u3092\u89b3\u6e2c\u3057\u305f\u3068\u304d\u3001\u304a\u3088\u3073\u5909\u6570\u30ce\u30fc\u30c9x2\u306b\u50241\u3092\u89b3\u6e2c\u3057\u305f\u3068\u304d\u306e\u6700\u5927\u540c\u6642\u78ba\u7387\u3068\u3001\u305d\u308c\u3092\u4e0e\u3048\u308b\u5909\u6570\u5024\u306e\u7d44\u3082\u6c42\u3081\u307e\u3059\u3002\n\n![](https://dl.dropbox.com/sh/cwfemibvr7gk4cy/4Dy2sRMkjD/20.FactorGraphMaxSum.png)\n\n```r\nlibrary(igraph)\nlibrary(plotrix)\nframe()\nset.seed(0)\npar(mfrow=c(3, 4))\npar(mar=c(2, 2, 2, 0))\npar(mgp=c(1, 0, 0))\nK <- 3\nN <- 4\nROOT <- 3\ng <- graph(c(1, N+1, N+1, 2, 4, N+2, N+2, 2, 2, N+3, N+3, 3), directed=F)\nV(g)$size <- 40\nV(g)$label.cex <- 1.5\nV(g)$shape <- \"circle\"\nV(g)$shape[(N+1):(N+3)] <- \"square\"\n\npxy <- matrix(c(\n\t0.00, 0.00, 0.16,\n\t0.00, 0.00, 0.34,\n\t0.16, 0.34, 0.00\n\t), 3, byrow=T)\n\t\npotential1 <- function(n, xparent, xchild) {\n\t# \u56e0\u6570\u30ce\u30fc\u30c9n\u306e\u30dd\u30c6\u30f3\u30b7\u30e3\u30eb\u95a2\u6570\n\t#\txparent:\u4e0a\u5c64\u5909\u6570\u30ce\u30fc\u30c9\n\t#\txchild:\u4e0b\u5c64\u5909\u6570\u30ce\u30fc\u30c9\n\t\n\tif (n == 7) {\n\t\tp <- pxy[xchild + 1, xparent + 1]\n\t} else {\n\t\tp <- ifelse(xparent == xchild, 0.8, 0.1)\n\t}\n\tp\n}\npotential2 <- function(n, xparent, xchild) {\n\t\n\tp <- potential1(n, xparent, xchild)\n\t# \u5909\u6570\u30ce\u30fc\u30c91\u306b1\u3092\u89b3\u6e2c\n\tOBSERVED <- 1\n\tif (n == 5) {\n\t\tp <- p * ifelse(xchild == OBSERVED, 1, 0)\n\t}\n\tp\n}\npotential3 <- function(n, xparent, xchild) {\n\t\n\tp <- potential1(n, xparent, xchild)\n\t# \u5909\u6570\u30ce\u30fc\u30c92\u306b1\u3092\u89b3\u6e2c\n\tOBSERVED <- 1\n\tif (n == 5 || n == 6) {\n\t\tp <- p * ifelse(xparent == OBSERVED, 1, 0)\n\t} else if (n == 7) {\n\t\tp <- p * ifelse(xchild == OBSERVED, 1, 0)\n\t}\n\tp\n}\n\ndoplot.marginal.joint <- function(potential) {\n\t\n\t# \u540c\u6642\u5206\u5e03\u3092\u6c42\u3081\u308b\n\td <- data.frame()\n\tfor (i in 0:(K^N - 1)) {  # O(K^N)\n\t\ttotal.potential <- 1\n\t\txs <- c()\n\t\txs <- c(xs, (i) %% K)\n\t\tfor (n in 1:(N-1)) {\n\t\t\txn1 <- (i %/% K ^ (n - 1)) %% K\n\t\t\txn2 <- (i %/% K ^ n) %% K\n\t\t\txs <- c(xs, xn2)\n\t\t}\n\t\ttotal.potential <- (potential(5, xs[2], xs[1]) * potential(6, xs[2], xs[4]) * potential(7, xs[3], xs[2]))\n\t\td <- rbind(d, c(xs, total.potential))\n\t}\n\tnames(d) <- c(paste0(\"x\", 1:N), \"p\")\n\tcat(\"p(x)\\n\");print(rbind(head(d),tail(d)))\n\n\t# \u540c\u6642\u5206\u5e03\u306e\u548c\u306b\u3088\u308a\u5468\u8fba\u5206\u5e03\u3092\u6c42\u3081\u308b\n\tps <- matrix(nrow=N, ncol=K)\n\trownames(ps) <- 1:N\n\tcolnames(ps) <- 0:(K-1)\n\tz <- sum(d$p)\n\tfor (n in 1:N) {\n\t\tfor (xn in 0:(K-1)) {\n\t\t\tps[n, xn + 1] <- sum(d[d[, n] == xn, ]$p) / z\n\t\t}\n\t}\n\tcat(\"p(xn)\\n\");print(ps)\n\tbarplot(t(ps), legend=0:(K-1), xlab=\"xn\", ylab=\"p(xn)\")\n\ttitle(\"marginal prob.\")\n}\n\ndoplot.max.joint <- function(potential) {\n\t\n\t# \u540c\u6642\u5206\u5e03\u3092\u6c42\u3081\u308b\n\td <- data.frame()\n\tfor (i in 0:(K^N - 1)) {  # O(K^N)\n\t\ttotal.potential <- 1\n\t\txs <- c()\n\t\txs <- c(xs, (i) %% K)\n\t\tfor (n in 1:(N-1)) {\n\t\t\txn1 <- (i %/% K ^ (n - 1)) %% K\n\t\t\txn2 <- (i %/% K ^ n) %% K\n\t\t\txs <- c(xs, xn2)\n\t\t}\n\t\ttotal.potential <- (potential(5, xs[2], xs[1]) * potential(6, xs[2], xs[4]) * potential(7, xs[3], xs[2]))\n\t\td <- rbind(d, c(xs, total.potential))\n\t}\n\tnames(d) <- c(paste0(\"x\", 1:N), \"p\")\n\tcat(\"p(x)\\n\");print(rbind(head(d),tail(d)))\n\n\t# \u540c\u6642\u5206\u5e03\u304c\u6700\u5927\u306e\u3082\u306e\u3092\u6c42\u3081\u308b\n\tz <- sum(d$p)\n\td$p <- d$p / z\n\tpmax <- max(d$p)\n\tcat(\"p(xmax)\\n\");print(d[d$p == pmax, ])\n\tframe()\n\taddtable2plot(0, 0, table=round(d[d$p == pmax, ], 6))\n\ttitle(\"max joint prob.\\nof all\")\n\tz\n}\n\ndoplot.max.message <- function(potential, z) {\n\t\n\tmu <- as.data.frame(matrix(c(-1, -1, rep(NA, K)), ncol=2 + K))\n\tnames(mu) <- c(\"from\", \"to\", 0:(K-1))\n\tphi <- as.data.frame(matrix(c(-1, -1, rep(NA, K)), ncol=2 + K))\n\tnames(phi) <- c(\"from\", \"to\", 0:(K-1))\n\n\tmufxUp <- function(from, to) {\n\t\t# \u4e0b\u5c64\u304b\u3089\u306e\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u6c42\u3081\u3001\u305d\u308c\u3092\u57fa\u306b\u3001\u56e0\u5b50\u30ce\u30fc\u30c9from\u304b\u3089\u5909\u6570\u30ce\u30fc\u30c9to\u3078\u306e\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u6c42\u3081\u308b\n\t\t\n\t\t# \u4e0b\u5c64\u304b\u3089\u306e\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u5148\u306b\u6c42\u3081\u308b\n\t\tchildren <- neighbors(g, from)\n\t\tfor (child in children) {\n\t\t\tif (child != to) {\n\t\t\t\tmuxfUp(child, from)\n\t\t\t}\n\t\t}\n\t\t# to\u4ee5\u5916\u304b\u3089\u306e\u30e1\u30c3\u30bb\u30fc\u30b8(\u306e\u548c)\u306b\u30dd\u30c6\u30f3\u30b7\u30e3\u30eb\u306e\u5bfe\u6570\u3092\u8db3\u3057\u305f\u3082\u306e\u306e\u3001to\u4ee5\u5916\u306e\u78ba\u7387\u5909\u6570\u5024\u306b\u95a2\u3059\u308b\u6700\u5927\u5024\u3092\u6c42\u3081\u308b\n\t\tp <- rep(NA, K)\n\t\th <- rep(NA, K)\n\t\tfor (x in 0:(K-1)) {  # O(K^\u96a3\u63a5\u30ce\u30fc\u30c9\u6570)\n\t\t\tm <- as.matrix(mu[mu$from == children[children != to] & mu$to == from, c(-1, -2)])\n\t\t\ts <- log(potential(from, x, 0:(K-1))) + m\n\t\t\t# \u6700\u5927\u5024\u3092\u4e0e\u3048\u308bx\u3092\u8a18\u9332\u3059\u308b\n\t\t\th[x + 1] <- which.max(s) - 1\n\t\t\t# \u6700\u5927\u5024\u3092\u8a18\u9332\u3059\u308b\n\t\t\tp[x + 1] <- max(s[h[x + 1] + 1])\n\t\t}\n\t\tmu <<- rbind(mu, c(from, to, p))\n\t\tphi <<- rbind(phi, c(from, to, h))\n\t\tp\n\t}\n\tmuxfUp <- function(from, to) {\n\t\t# \u4e0b\u5c64\u304b\u3089\u306e\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u6c42\u3081\u3001\u305d\u308c\u3092\u57fa\u306b\u3001\u5909\u6570\u30ce\u30fc\u30c9from\u304b\u3089\u56e0\u5b50\u30ce\u30fc\u30c9to\u3078\u306e\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u6c42\u3081\u308b\n\t\t\n\t\t# to\u4ee5\u5916\u306e\u30e1\u30c3\u30bb\u30fc\u30b8(\u306e\u548c)\u3092\u6c42\u3081\u308b\n\t\tp <- rep(0, K)\n\t\tfor (child in neighbors(g, from)) {\n\t\t\tif (child != to) {\n\t\t\t\tp <- p + mufxUp(child, from)\n\t\t\t}\n\t\t}\n\t\tmu <<- rbind(mu, c(from, to, p))\n\t\tp\n\t}\n\tbacktrackFx <- function(from, to, xmax) {\n\t\t# \u56e0\u5b50\u30ce\u30fc\u30c9from\u304b\u3089\u5909\u6570\u30ce\u30fc\u30c9to\u3078\u30d0\u30c3\u30af\u30c8\u30e9\u30c3\u30af\u3059\u308b\n\t\t\n\t\t# \u6700\u5927\u540c\u6642\u78ba\u7387\u3092\u4e0e\u3048\u308b\u3088\u3046\u306a\u3001\u5909\u6570\u30ce\u30fc\u30c9to\u306b\u304a\u3051\u308bx\u3092\u8a18\u9332\u3059\u308b\n\t\tdmax[, to] <<- xmax\n\t\t\n\t\t# \u4e0b\u5c64\u3078\u30d0\u30c3\u30af\u30c8\u30e9\u30c3\u30af\u3059\u308b\n\t\tfor (child in neighbors(g, to)) {\n\t\t\tif (child != from) {\n\t\t\t\tbacktrackXf(to, child, xmax)\n\t\t\t}\n\t\t}\n\t}\n\tbacktrackXf <- function(from, to, xmax) {\n\t\t# \u5909\u6570\u30ce\u30fc\u30c9from\u304b\u3089\u56e0\u5b50\u30ce\u30fc\u30c9to\u3078\u30d0\u30c3\u30af\u30c8\u30e9\u30c3\u30af\u3059\u308b\n\t\t\n\t\t# \u5909\u6570\u30ce\u30fc\u30c9from\u3067xmax\u3092\u4e0e\u3048\u305fx\u3092\u6c42\u3081\u308b\n\t\th <- as.numeric(phi[phi$from == to & phi$to == from, c(-1, -2)])\n\t\txprevious <- h[xmax + 1]\n\t\t\n\t\t# \u4e0b\u5c64\u3078\u30d0\u30c3\u30af\u30c8\u30e9\u30c3\u30af\u3059\u308b\n\t\tfor (child in neighbors(g, to)) {\n\t\t\tif (child != from) {\n\t\t\t\tbacktrackFx(to, child, xprevious)\n\t\t\t}\n\t\t}\n\t}\n\t\n\t# \u4e0b\u5c64\u304b\u3089\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u9001\u308b\n\tmufxUp(neighbors(g, ROOT)[1], ROOT)\n\tcat(\"mu\\n\");print(mu)\n\tcat(\"phi\\n\");print(phi)\n\t\n\t# \u6839\u30ce\u30fc\u30c9xN\u3078\u306e\u30e1\u30c3\u30bb\u30fc\u30b8\u306e\u5408\u8a08\u306e\u6700\u5927\u5024\u3092\u4e0e\u3048\u308bx\u3092\u8a18\u9332\u3059\u308b\n\tm <- as.matrix(mu[mu$to == ROOT, c(-1, -2)])\n\ts <- colSums(m)\n\txmax <- which(s == max(s)) - 1\n\t# \u305d\u306e\u6700\u5927\u5024\u304c\u3001\u6700\u5927\u540c\u6642\u78ba\u7387\u3068\u306a\u308b\n\tpmax <- exp(s[xmax + 1]) / z\n\t\n\t# xmax\u3092\u57fa\u306b\u30d0\u30c3\u30af\u30c8\u30e9\u30c3\u30af\u3057\u3001\u5404xmax\u306e\u8981\u7d20\u306b\u5bfe\u5fdc\u3059\u308bx\u3092\u6c42\u3081\u308b\n\tdmax <- data.frame(matrix(NA, ncol=N, nrow=length(xmax)), p = pmax)\n\tnames(dmax) <- c(paste0(\"x\", 1:N), \"p\")\n\tdmax[, ROOT] <- xmax\n\tbacktrackXf(ROOT, neighbors(g, ROOT)[1], xmax)\n\tcat(\"p(xmax)\\n\");print(dmax)\n\t\n\tframe()\n\taddtable2plot(0, 0, table=round(dmax, 6))\n\ttitle(\"max joint prob.\\nby max-sum\")\n}\n\nV(g)$color=\"white\"\nplot(g, layout=layout.reingold.tilford(g, root=ROOT))\ndoplot.marginal.joint(potential1)\nz <- doplot.max.joint(potential1)\ndoplot.max.message(potential1, z)\n\nV(g)$color=\"white\"\nV(g)$color[1]=\"gray\"\nplot(g, layout=layout.reingold.tilford(g, root=ROOT))\ndoplot.marginal.joint(potential2)\nz <- doplot.max.joint(potential2)\ndoplot.max.message(potential2, z)\n\nV(g)$color=\"white\"\nV(g)$color[2]=\"gray\"\nplot(g, layout=layout.reingold.tilford(g, root=ROOT))\ndoplot.marginal.joint(potential3)\nz <- doplot.max.joint(potential3)\ndoplot.max.message(potential3, z)\n```\n", "tags": ["R", "PRML"]}