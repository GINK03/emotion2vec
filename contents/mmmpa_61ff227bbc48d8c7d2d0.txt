{"context": "\u307e\u3060\u6bd4\u8f03\u7684\u306b\u65b0\u3057\u3044\u6a5f\u80fd\u306a\u306e\u3067\u3050\u3050\u308a\u3093\u3050\u304c\u52b9\u679c\u3092\u767a\u63ee\u305b\u305a\u3001\u7d50\u679c\u3068\u3057\u3066\u3001\u3061\u3083\u3093\u3068\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u3084\u30b3\u30fc\u30c9\u3092\u8aad\u3080\u3053\u3068\u306b\u3088\u308b\u5b66\u3073\u3084\u3001\u5e8a\u677f\u3092\u8e0f\u307f\u306c\u304f\u306a\u3069\u304c\u3042\u3063\u305f\u306e\u3067\u307e\u3068\u3081\u307e\u3059\u3002\nActionCable\u306e\u6a5f\u80fd\u7d39\u4ecb\u3068\u3044\u3063\u305f\u3082\u306e\u3067\u306f\u306a\u304f\u3001\u3053\u3046\u3057\u305f\u304b\u3063\u305f\u304b\u3089\u3053\u306e\u6a5f\u80fd\u3092\u4f7f\u3063\u305f\u3001\u4f7f\u3048\u306a\u304b\u3063\u305f\u3001\u3053\u3046\u3057\u305f\u3089\u5177\u5408\u304c\u826f\u304b\u3063\u305f\u3001\u3068\u3044\u3046\u5099\u5fd8\u9332\u3068\u306a\u3063\u3066\u3044\u307e\u3059\u3002\n\u66f8\u304d\u306a\u304c\u3089\u30b3\u30fc\u30c9\u3082\u5897\u3048\u3066\u3044\u3063\u305f\u306e\u3067\u9577\u3044\u3067\u3059\u3002\n\n\u3069\u306e\u3088\u3046\u306a\u30c1\u30e3\u30c3\u30c8\n\u30de\u30fc\u30de\u30fc\u30c1\u30e3\u30c3\u30c8\u3092\u899a\u3048\u3066\u308b\u4eba\u306f\u3044\u307e\u3059\u304b\uff1f\u3068\u3044\u3046\u304b\u3001\u307e\u3060\u3042\u3063\u305f\u308a\u3059\u308b\u3093\u3067\u3059\u304b\u306d\u3002\n\u3075\u304d\u3060\u3057\u4f4d\u7f6e\u3092\u81ea\u7531\u306b\u6c7a\u3081\u3089\u308c\u308b\u30c1\u30e3\u30c3\u30c8\u3067\u300116\u5e74\u3050\u3089\u3044\u524d\u3001\u30c1\u30e3\u30c3\u30c8\u306b\u306f\u307e\u3063\u3066\u3044\u305f\u6642\u671f\u306b\u5229\u7528\u3057\u3066\u3044\u305f\u306e\u3092\u601d\u3044\u51fa\u3057\u306a\u304c\u3089\u3001\u4f3c\u305f\u611f\u3058\u306e\u3092\u3064\u304f\u308a\u307e\u3057\u305f\u3002\n\n\u305f\u3057\u304bJava\u30a2\u30d7\u30ec\u30c3\u30c8\u3067\u52d5\u3044\u3066\u3044\u3066\u3001\u3042\u308c\u3063\u3066WebSocket\u3058\u3083\u306a\u3044\u306e\u304b\u306a\u30fc\u3068\u30d5\u30f3\u30ef\u30ea\u601d\u3044\u51fa\u3057\u305f\u306e\u304c\u3064\u306a\u304c\u308a\u307f\u305f\u3044\u306a\u3082\u306e\u3067\u3059\u3002\n\n\u30d0\u30fc\u30b8\u30e7\u30f3\n\nRails 5.0.0.rc1\n\n\u3088\u3063\u3066\u4eca\u5f8c\u53c2\u8003\u306b\u306a\u3089\u306a\u304f\u306a\u308b\u53ef\u80fd\u6027\u306f\u5927\u3044\u306b\u3042\u308a\u307e\u3059\u3002\n\n\u30bd\u30fc\u30b9\n mmmpa/cable_chat\nexample\u306a\u3069\u3067\u306fCoffeeScript\u3092\u4f7f\u7528\u3057\u3066\u3044\u307e\u3057\u305f\u304c\u3001ES2015\u3067\u5b9f\u88c5\u3057\u3066\u3044\u307e\u3059\u3002\n(Rails\u3067\u5b8c\u7d50\u3057\u3088\u3046\u3068browserify-rails\u3092\u4f7f\u7528\u3057\u307e\u3057\u305f)\n\nActionCable\u95a2\u4fc2\u306e\u30b3\u30fc\u30c9\u306e\u5834\u6240\n app/channels - Rails\u5074\n app/assets/javascripts/models/chat-cable.js - JavaScript\u5074\n app/assets/javascripts/contexts/chat-context.js - React\u306e\u4e00\u756a\u4e0a\n\n\u304a\u304a\u307e\u304b\u306a\u7406\u89e3\n\nRails\u5074\n\nConnection\n\n\u5b9f\u969b\u306b\u3064\u306a\u3050\u4e00\u672c\u306eWebSocket\u306b\u95a2\u3059\u308b\u5b9f\u88c5\u3092\u3057\u307e\u3059\u3002\u63a5\u7d9a\u3059\u308b\u3057\u306a\u3044\u3092\u30ad\u30e1\u307e\u3059\u3002\u63a5\u7d9a\u3054\u3068\u306b\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u304c\u3064\u304f\u3089\u308c\u307e\u3059\u3002\n\nChannel\n\n\u5b9f\u969b\u306b\u7e4b\u304c\u308c\u305f\u4e00\u672c\u306eConnection\u4e0a\u3067\u884c\u308f\u308c\u308b\u3084\u308a\u3068\u308a\u3092\u5b9f\u88c5\u3057\u307e\u3059\u3002\u63a5\u7d9a\u3054\u3068\u306b\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u304c\u3064\u304f\u3089\u308c\u307e\u3059\u3002\n\nJavaScript\u5074\n\nConsumer\n\nConnection\u306b\u5bfe\u5fdc\u3057\u307e\u3059\u3002\n\nSubscription\n\nChannel\u306b\u5bfe\u5fdc\u3057\u307e\u3059\u3002\n\n\u30c6\u30b9\u30c8\u306b\u3064\u3044\u3066\n\u30c6\u30b9\u30c8\u306f\u30c6\u30b9\u30c8\u3067\u5927\u3044\u306b\u8db3\u3092\u3072\u3063\u304b\u3051\u305f\u306e\u3067\u3001\u5225\u30da\u30fc\u30b8\u306b\u307e\u3068\u3081\u307e\u3057\u305f\u3002\n ActionCable\u306eConnection\u3068Channel\u3092\u5358\u4f53\u30c6\u30b9\u30c8\u3059\u308b\u3002 - Qiita\n Capybara\u3067ActionCable\u306e\u6a5f\u80fd\u30c6\u30b9\u30c8\u3092\u3059\u308b\u3002 - Qiita\n SimpleCov\u3067\u30ab\u30d0\u30ec\u30c3\u30b8\u3092\u3068\u308c\u308b\u306f\u305a\u306a\u306e\u306b\u3068\u308c\u306a\u3044\u30d5\u30a1\u30a4\u30eb\u304c\u3042\u308b\u5834\u5408\u306e\u51e6\u7f6e\u3002 - Qiita\n\n\u6ce8\u610f\u70b9\n\u73fe\u6bb5\u968e\u3067\u306f\u3001\u7279\u306bActionCable\u3092\u5b8c\u5168\u4f53\u3067\u52d5\u304b\u3059\u6a5f\u80fd\u30c6\u30b9\u30c8\u306b\u304a\u3044\u3066\u306f\u3001\u5404\u30c6\u30b9\u30c8\u306e\u958b\u59cb\u7d42\u4e86\u306b\u30d5\u30c3\u30af\u3057\u3066\u884c\u308f\u308c\u308b\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306e\u30ed\u30fc\u30eb\u30d0\u30c3\u30af\u306a\u3069\u304c\u3046\u307e\u304f\u52d5\u304b\u306a\u3044\u3053\u3068\u304c\u3088\u304f\u3042\u308a\u307e\u3059\u3002\nbefore :each\u306a\u3069\u3092\u4f7f\u7528\u3057\u3066\u5bfe\u51e6\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u3002\n\n\u30c6\u30b9\u30c8\u4e2d\u306b\u3073\u3063\u304f\u308a\u3059\u308b\u8a71 (Rails)\nRedis\u3092pubsub\u30b5\u30fc\u30d0\u30fc\u3068\u3057\u3066\u4f7f\u3063\u3066\u3044\u308b\u5834\u5408\u3001\u30c7\u30d5\u30a9\u30eb\u30c8\u3067\u306fRails.env.test?\u3068Rails.env.development?\u3067\u540c\u3058\u30b5\u30fc\u30d0\u30fc\u3001\u540c\u3058subscribe\u7528\u306e\u6587\u5b57\u5217\u3092\u4f7f\u3063\u3066\u3044\u307e\u3059\u3002\n\u6a5f\u80fd\u30c6\u30b9\u30c8\u4e2d\u306b\u3001\u540c\u6642\u306bdevelopment\u3092\u30d6\u30e9\u30a6\u30b6\u3067\u958b\u3044\u3066\u64cd\u4f5c\u3057\u3066\u3044\u308b\u3068\u3001\u30c6\u30b9\u30c8\u5074\u306e\u30e1\u30c3\u30bb\u30fc\u30b8\u304c\u5c4a\u304d\u307e\u304f\u308a\u307e\u3059\uff08\u9006\u3082\u3082\u3061\u308d\u3093\uff09\u3002\n\n\u30c1\u30e3\u30c3\u30c8\u5b9f\u88c5\u306b\u3064\u3044\u3066\n\n Connection\u306e\u8a2d\u5b9a (Rails)\n\u3053\u3053\u3060\u3051ActionCable\u81ea\u4f53\u306e\u8a71\u3067\u3059\u3002\n\u4eca\u56de\u306e\u30c1\u30e3\u30c3\u30c8\u3067\u306f\u3001Cookie\u3092\u5171\u6709\u3059\u308b\u30d6\u30e9\u30a6\u30b6\u3067\u8907\u540c\u6642\u306b\u30a2\u30af\u30bb\u30b9\u3057\u305f\u5834\u5408\u3001\u540c\u3058\u4eba\u9593\u3068\u3057\u3066\u6271\u3044\u307e\u3059\u3002ActionCable\u306fidentified_by\u3092\u7528\u3044\u3066\u3001\u305d\u306e\u7279\u5b9a\u306e\u305f\u3081\u306e\u30d7\u30ed\u30d1\u30c6\u30a3\u3092\u8a2d\u5b9a\u3067\u304d\u307e\u3059\u3002\nmodule ApplicationCable\n  class Connection < ActionCable::Connection::Base\n    identified_by :current_user\n\n    def connect\n      self.current_user = find_user_or_reject # User\u3092\u3055\u304c\u3057\u3066\u8fd4\u3059\u3002\u3044\u306a\u3051\u308c\u3070\u5207\u65ad\n    end\n    # \u7565\n  end\nend\n\n\u3053\u308c\u306b\u3088\u308a\u3001\u540c\u4e00\u306e\u30c7\u30fc\u30bf\u3092\u3082\u3068\u306bidentify\u3055\u308c\u305fConnection\u306f\u540c\u3058internal_channel\u6587\u5b57\u5217\u3092\u6301\u3064\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\n\nMakes it possible for the RemoteConnection to disconnect a specific connection.\n\n\u3068\u3044\u3046\u65e2\u8ff0\u304c\u30bd\u30fc\u30b9\u30b3\u30fc\u30c9\u306b\u3042\u308b\u3068\u304a\u308a\u3001internal_channel\u306f\u76f4\u63a5\u53c2\u7167\u3057\u3066\u4f55\u304b\u3092\u3059\u308b\u305f\u3081\u306e\u3082\u306e\u3067\u306f\u3042\u308a\u307e\u305b\u3093\u304c\u3001\u5185\u90e8\u306b\u624b\u3092\u3064\u3063\u3053\u307f\u305f\u304f\u306a\u3063\u305f\u3089\u3053\u308c\u304c\u4f7f\u3048\u308b\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u3002\n\n \u30b5\u30fc\u30d0\u30fc\u3078\u306e\u63a5\u7d9a\u6210\u5426\u3092\u901a\u77e5\u3057\u305f\u3044 (JS -> Rails -> JS)\n\napp/assets/javascripts/models/chat-cable.js\n  connect() {\n    this.cable = window.ActionCable.createConsumer();\n    this.cable.subscriptions.create('SessionChannel', this.sessionChannelCallback);\n  }\n\n\nJavaScript\u5074\u304b\u3089\u306e\u63a5\u7d9a\u306fActionCable.createConsumer\u3057\u305f\u6642\u3067\u306f\u306a\u304f\u3001\u306f\u3058\u3081\u3066this.cable.subscriptions.create\u3057\u305f\u6642\u306b\u8d77\u3053\u308a\u307e\u3059\u3002\ncreateConsumer\u306f\u5358\u306b\u63a5\u7d9a\u5148\u306e\u8a2d\u5b9a\u3092\u3057\u3001\u5f8c\u306e\u63a5\u7d9a\u3092\u4e00\u5143\u7ba1\u7406\u3059\u308b\u305f\u3081\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\nSessionChannel\u3067Subscription\u306b\u63a5\u7d9a\u62d2\u5426\u3092\u5373\u5ea7\u306b\u901a\u77e5\u3059\u308b\u305f\u3081\u306e\u8155\u529b\n\u63a5\u7d9a\u62d2\u5426\u306b\u7528\u3044\u3089\u308c\u308breject_unauthorized_connection\u306fSubscription\u306b\u306a\u306b\u3082\u901a\u77e5\u3057\u307e\u305b\u3093\u3002\nSubscription\u306f\u5185\u90e8\u3067\u306e\u5b9a\u671f\u7684\u306a\u63a5\u7d9a\u78ba\u8a8d\u51e6\u7406\u3067disconnected\u304c\u767a\u751f\u3057\u3066\u3044\u308b\u306e\u3092\u898b\u3066\u6c17\u3065\u304f\u3057\u304b\u3042\u308a\u307e\u305b\u3093\u3002\u3053\u308c\u3067\u306f\u521d\u56de\u306e\u30bb\u30c3\u30b7\u30e7\u30f3\u304c\u6b8b\u7559\u3057\u3066\u308b\u304b\u5426\u304b\u306e\u78ba\u8a8d\u306b\u3001\u6bce\u56de\u6570\u79d2\u5f85\u3064\u3053\u3068\u306b\u306a\u308a\u307e\u3059\u3002\n\u305d\u308c\u306f\u3044\u3084\u306a\u306e\u3067\u7121\u7406\u3084\u308a\u901a\u77e5\u3057\u307e\u3059\u3002\n\napp/channels/application_cable/connection.rb\n    def transmit_rejection\n      # SessionChannel\u306e\u30e1\u30c3\u30bb\u30fc\u30b8\u3068\u3057\u3066\u9001\u4fe1\n      transmit(\n        identifier: {channel: SessionChannel.to_s}.to_json,\n        type: ActionCable::INTERNAL[:message_types][:rejection]\n      )\n    end\n\n\n\u9053\u304b\u3089\u306f\u305a\u308c\u305f\u4f7f\u3044\u304b\u305f\u306a\u306e\u3067\u3001\u4eca\u5f8c\u52d5\u304b\u306a\u304f\u306a\u308b\u53ef\u80fd\u6027\u304c\u3042\u308a\u307e\u3059\u3002\n\nConsumer\u3067\u660e\u793a\u7684\u306b\u5207\u65ad\u3057\u306a\u3044\u3068\u554f\u3044\u5408\u308f\u305b\u3057\u7d9a\u3051\u308b\nJavaScript\u7684\u306b\u306f\u5ef6\u3005\u3068disconnected\u3092\u767a\u751f\u3059\u308b\u3060\u3051\u306a\u306e\u3067\u3059\u304c\u3001\u305d\u306e\u88cf\u3067\u306f\u6bce\u56deConnection\u306b\u554f\u3044\u3042\u308f\u305b\u3092\u7d9a\u3051\u3066\u3044\u307e\u3059\u3002\u3042\u307e\u308a\u3088\u304f\u3042\u308a\u307e\u305b\u3093\u3002\nthis.consumer.disconnect();\n\nrejected\u304c\u767a\u751f\u3057\u305f\u6642\u70b9\u3067\u3001JavaScript\u5074\u304b\u3089\u3082SessionChannel\u7528\u306eSubscription\u304b\u3089\u660e\u793a\u7684\u306b\u5207\u65ad\u3057\u307e\u3057\u305f\u3002\n\n\u63a5\u7d9a\u6210\u529f\u5f8c\n\u63a5\u7d9a\u6210\u529f\u6642\u306b\u306fconnected\u304c\u767a\u751f\u3059\u308b\u306e\u3067\u3001\u305d\u308c\u3092\u4ee5\u3063\u3066\u5404\u7a2e\u6e96\u5099\u3092\u958b\u59cb\u3057\u307e\u3059\u3002\n\u305d\u306e\u4ed6\u306f\u666e\u901a\u306e\u5b9f\u88c5\u306a\u306e\u3067\u3001example\u306a\u3069\u3068\u7279\u306b\u5909\u308f\u3063\u305f\u30dd\u30a4\u30f3\u30c8\u306f\u3042\u308a\u307e\u305b\u3093\u3002\n\n \u30b5\u30fc\u30d0\u30fc\u304b\u3089\u7279\u5b9a\u306eConnection\u3092\u5207\u65ad\u3059\u308b\u3002 (Rails)\n\u8907\u6570\u306eConnection\u304c\u3059\u3067\u306b\u78ba\u7acb\u3055\u308c\u3066\u3044\u308b\u5834\u5408\u3001Connection\u306eidentify\u306b\u4f7f\u308f\u308c\u3066\u3044\u308bcurrent_user\u306e\u5927\u672c\u3092\u5358\u7d14\u306b\u524a\u9664\u3057\u305f\u3060\u3051\u3067\u306f\u63a5\u7d9a\u3092\u65ad\u3066\u307e\u305b\u3093\u3002\n\u305d\u308c\u3069\u3053\u308d\u304b\u30e6\u30fc\u30b6\u30fc\u30c7\u30fc\u30bf\u304c\u6d88\u3048\u3066\u63a5\u7d9a\u3060\u3051\u304c\u6b8b\u308b\u3001\u6c17\u307e\u305a\u3044\u72b6\u6cc1\u306b\u306a\u308a\u307e\u3059\u3002\nActionCable.server\u306b\u306fidentify\u306b\u4f7f\u7528\u3055\u308c\u3066\u3044\u308b\u30c7\u30fc\u30bf\u3092\u5229\u7528\u3057\u3066\u3001\u305d\u308c\u306b\u3088\u308aidentify\u3055\u308c\u3066\u3044\u308b\u81ea\u5206\u4ee5\u5916\u306eConnection\u3092RemoteConnection\u30af\u30e9\u30b9\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3068\u3057\u3066\u5f97\u308b\u30e1\u30bd\u30c3\u30c9\u3068\u3001\u5207\u65ad\u3059\u308b\u30e1\u30bd\u30c3\u30c9\u304c\u3042\u308a\u307e\u3059\u3002\u3053\u308c\u3067\u4e00\u6c17\u306b\u5207\u65ad\u3057\u307e\u3059\u3002\n\u4eca\u56de\u306f\u81ea\u5206\u95a2\u9023\u306eConnection\u304c\u30bf\u30fc\u30b2\u30c3\u30c8\u306a\u306e\u3067current_user\u3092\u7528\u3044\u307e\u3059\u304c\u3001User.find(n)\u3067\u5f97\u3089\u308c\u308b\u3088\u3046\u306a\u4ed6\u306e\u30e6\u30fc\u30b6\u30fc\u3067\u3082\u3082\u3061\u308d\u3093\u4f7f\u3048\u307e\u3059\u3002Ban\u6a5f\u80fd\u306a\u3069\u304c\u5fc5\u8981\u306b\u306a\u308c\u3070\u3053\u308c\u304c\u4f7f\u3048\u307e\u3059\u306d\u3002\n# RemoteConnections\u3092\u5f97\u308b\nActionCable.server.where({current_user: current_user})\n\n# \u5168\u3066\u5207\u65ad\u3059\u308b\nActionCable.server.disconnect({current_user: current_user})\n\n\u3068\u3053\u308d\u3067\u3053\u308c\u306fConnection\u304c\u6301\u3064websocket\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306eclose\u30e1\u30bd\u30c3\u30c9\u306b\u76f4\u63a5\u4f5c\u7528\u3059\u308b\u306e\u3067\u3001Connection\u306eclose\u30e1\u30bd\u30c3\u30c9\u3092\u30aa\u30fc\u30d0\u30fc\u30e9\u30a4\u30c9\u3057\u3066\u3082\u51e6\u7406\u3092\u88ab\u305b\u3089\u308c\u307e\u305b\u3093\u3002\nclose\u5f8c\u306e\u51e6\u7406\u3092\u3069\u3046\u306b\u304b\u3059\u308b\u30e1\u30bd\u30c3\u30c9\u306f\u3042\u308a\u307e\u3057\u305f\u304c\u3001close\u524d\u306e\u3082\u306e\u306f\u3042\u308a\u307e\u305b\u3093\u3067\u3057\u305f\u3002\u3088\u3063\u3066\u5c11\u3057\u306e\u30bf\u30a4\u30e0\u30e9\u30b0\u304c\u3042\u308a\u307e\u3059\u3002\n\n\u624b\u3092\u7a81\u3063\u3053\u3080\u30d2\u30f3\u30c8\nActionCable.server.disconnect\u306f\u5358\u306a\u308bbroadcast\u3067\u3059\u3002\nserver.broadcast internal_channel, type: 'disconnect'\n\n\n\u5b9f\u969b\u5168\u90e8\u5207\u65ad\u3059\u308b\u969b\u306b\u3069\u3046\u3057\u305f\u304b\n\u540c\u3058current_user\u3067identify\u3055\u308c\u3066\u3044\u308bConnection\u3092\u3072\u3051\u308bUserConnections\u3068\u3044\u3046\u30af\u30e9\u30b9\u3092\u4f5c\u6210\u3057\u3001\u305d\u3053\u304b\u3089\u5168\u3066\u306eConnection\u3092\u3072\u3068\u3064\u305a\u3064close\u3067\u304d\u308b\u3088\u3046\u306b\u3057\u307e\u3057\u305f\u3002\n\u5207\u65ad\u6642\u306e\u901a\u77e5\u3082\u3053\u308c\u3067\u5909\u306a\u30cf\u30c3\u30af\u306a\u3057\u306b\u884c\u3048\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3057\u305f\u3002\n\n \u30c7\u30fc\u30bf\u306e\u53d7\u4fe1\u3068\u914d\u4fe1 (JS -> Rails -> JS)\n\u30c1\u30e3\u30c3\u30c8\u3068\u3044\u3046\u3053\u3068\u3067\u3001\u5404\u7a2e\u60c5\u5831\u3092\u6295\u3052\u3066\u3044\u304f\u3053\u3068\u306b\u306a\u308a\u307e\u3059\u3002\n\u6295\u3052\u3089\u308c\u308b\u306e\u306f\u5358\u7d14\u306aHash\u3067\u3059\u304c\u3001\u5b9f\u969b\u306e\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3067\u306f\u3001Subscription\u304b\u3089\u5c4a\u3044\u305f\u30c7\u30fc\u30bf\u3092\u4e38\u6d41\u3057\u3059\u308b\u306e\u306f\u307b\u307c\u306a\u3044\u3068\u601d\u3044\u307e\u3059\u3002\nJavaScript\u5074\uff08\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u5074\uff09\u304b\u3089\u9001\u4fe1\u3055\u308c\u308b\u4e0d\u6b63\u306a\u30c7\u30fc\u30bf\u306e\u6291\u5236\u306fJavaScript\u5074\u3067\u306f\u3067\u304d\u306a\u3044\u306e\u3067\u3001JavaScript\u5074\u3067\u3042\u308c\u3053\u308c\u8133\u307f\u305d\u3092\u7d5e\u308b\u3088\u308a\u3082\u3001\u30b5\u30fc\u30d0\u30fc\u5074\u3067\u3061\u3083\u3093\u3068\u3084\u308b\u65b9\u304c\u3088\u3055\u305d\u3046\u3067\u3059\u3002\n\u4eca\u56de\u3001\u9001\u4fe1\u914d\u4fe1\u3055\u308c\u308b\u30e1\u30c3\u30bb\u30fc\u30b8\u306b\u306f140\u6587\u5b57\u306e\u5236\u9650\u306b\u304f\u308f\u3048\u3001\u5ea7\u6a19\u60c5\u5831\u304c\u3042\u308a\u307e\u3059\u3002\u3088\u3063\u3066\u6587\u5b57\u6570\u3068\u5ea7\u6a19\u3092\u30d0\u30ea\u30c7\u30fc\u30b7\u30e7\u30f3\u3057\u306a\u3051\u308c\u3070\u306a\u308a\u307e\u305b\u3093\u3002\n\u30d0\u30ea\u30c7\u30fc\u30b7\u30e7\u30f3\u3068Hash\u306b\u30c7\u30fc\u30bf\u3092\u6574\u5f62\u3059\u308b\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u30af\u30e9\u30b9\u3092\u4f5c\u6210\u3057\u307e\u3057\u305f\u3002\n\napp/models/member_message.rb\nclass MemberMessage\n  include ActiveModel::Validations\n\n  attr_accessor :user, :message, :x, :y\n\n  validates! :user, :message, :x, :y,\n             presence: true\n  validates! :message,\n             length: {in: 1..140}\n  validates! :x, :y,\n             numericality: true\n# \u7565\n  def render\n    {\n      name: user.name,\n      user_key: user.key,\n      key: \"#{Time.now.to_i}_#{user.key}\",\n      message: message,\n      x: x,\n      y: y\n    }\n  end\nend\n\n\nHTML\u306b\u95a2\u3059\u308b\u30b5\u30cb\u30bf\u30a4\u30ba\u3092\u3057\u3066\u3044\u307e\u305b\u3093\u304c\u3001\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u3067\u63cf\u753b\u884c\u3046React\u306b\u305d\u306e\u6a5f\u80fd\u304c\u3042\u308b\u306e\u3067\u30d1\u30b9\u3057\u3066\u3044\u307e\u3059\u3002\u3082\u3057\u4eee\u306b\u305d\u306e\u307e\u307e\u63cf\u753b\u3059\u308b\u3088\u3046\u306a\u30b9\u30af\u30ea\u30d7\u30c8\u3084\u30e9\u30a4\u30d6\u30e9\u30ea\u3092\u4f7f\u7528\u3057\u3066\u3044\u308b\u306e\u306a\u3089\u3001\u3082\u3061\u308d\u3093\u884c\u3063\u305f\u65b9\u304c\u826f\u3044\u3067\u3057\u3087\u3046\u3002\n\u30c1\u30e3\u30c3\u30c8\u30e1\u30f3\u30d0\u30fc\u306e\u30c7\u30fc\u30bf\u306b\u95a2\u3057\u3066\u306f\u3055\u3089\u306b\u5358\u7d14\u3067\u3059\u304c\u3001\u540c\u3058\u304f\u30af\u30e9\u30b9\u3092\u4f5c\u6210\u3057\u307e\u3057\u305f\u3002\n\u30c7\u30fc\u30bf\u306e\u7d44\u307f\u7acb\u3066\u306f\u3001Channel\u5185\u3067\u3084\u308b\u3088\u308a\u3082\u3001\u5916\u306b\u8ffd\u3044\u3060\u3057\u305f\u307b\u3046\u304c\u826f\u3044\u306e\u3067\u306f\u3068\u601d\u3044\u307e\u3057\u305f\u3002\n\n React\u3068\u306e\u9023\u643a (JS)\n\u3053\u308c\u306f\u7279\u306b\u554f\u984c\u306b\u306f\u306a\u308a\u307e\u305b\u3093\u3067\u3057\u305f\u3002\nActionCable\u5468\u308a\u3092\u5f15\u304d\u53d7\u3051\u308b\u30af\u30e9\u30b9\u3092\u7528\u610f\u3057\u3001\u305d\u308c\u306bReact\u5074\u304b\u3089\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u3092\u767b\u9332\u3057\u307e\u3059\u3002\u4eca\u56de\u306fChatCable\u3068\u3044\u3046\u30af\u30e9\u30b9\u3092\u4f5c\u6210\u3057\u3001new\u6642\u306b\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u3092\u767b\u9332\u3057\u307e\u3057\u305f\u3002\n\u4f8b\u3048\u3070\u3053\u306e\u3088\u3046\u306a\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u3092\u767b\u9332\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n{\n  messageReceived: (data) => {\n    this.setState({message: data});\n  },\n  memberReceived: (data) => {\n    this.setState({member: data});\n  }\n}\n\nChatCable\u306f\u5404\u7a2eSubscription\u306e\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u5185\u306a\u3069\u304b\u3089\u9069\u5207\u306a\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u3092\u547c\u3076\u3068\u3044\u3046\u5bf8\u6cd5\u3067\u3059\u3002\n\u304a\u4e92\u3044\u306b\u304a\u4e92\u3044\u306e\u30b3\u30fc\u30c9\u304c\u3042\u307e\u308a\u3081\u308a\u3053\u307e\u305a\u3001\u5177\u5408\u304c\u826f\u304b\u3063\u305f\u3067\u3059\u3002\n\n\u5c0f\u30cd\u30bf\n\nJS\u5074\u306e\u30ed\u30b0\u3092\u898b\u3088\u3046 (JS)\nActionCable.startDebugging();\n\n\u3067JavaScript\u306e\u7d30\u304b\u3044\u30ed\u30b0\u304c\u89b3\u5bdf\u3067\u304d\u307e\u3059\u3002\n\nES2015 (JS)\nsubscriptions.create\u3067\u306f\u5404Channel\u7528\u306eSubscription\u3092\u4f5c\u6210\u3057\u307e\u3059\u304c\u3001\u4f5c\u6210\u6642\u306b\u5404\u7a2e\u30a4\u30d9\u30f3\u30c8\u306b\u5bfe\u3057\u3066\u306e\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u3092\u767b\u9332\u3057\u307e\u3059\u3002\nthis.cable.subscriptions.create('SessionChannel', {\n  connected: function() {\n    this.perform('hello'); // Channel\u306e\u30e1\u30bd\u30c3\u30c9\u3092\u53e9\u304f\n  },\n  disconnected: function() {\n    this.clear();\n  },\n  clear() {\n    // clear\u51e6\u7406\n  }\n});\n\n\u3053\u308c\u306f\u5185\u90e8\u3067\n\ngems/2.3.0/gems/actioncable-5.0.0.rc1/lib/assets/compiled/action_cable.js\n    extend = function(object, properties) {\n      var key, value;\n      if (properties != null) {\n        for (key in properties) {\n          value = properties[key];\n          object[key] = value;\n        }\n      }\n      return object;\n    };\n\n\n\u3053\u306e\u3088\u3046\u306a\u30e1\u30bd\u30c3\u30c9\u3092\u4f7f\u3063\u3066Subscription\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306b\u5408\u6210\u3055\u308c\u307e\u3059\u3002\n\u306a\u306e\u3067\u3001this\u3068\u304b\u898b\u3048\u308b\u3057\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u3092\u30af\u30e9\u30b9\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3068\u3057\u3066\u4f5c\u6210\u3055\u308c\u308b\u3088\u3046\u306b\u3057\u305f\u3089\u7dba\u9e97\u306b\u66f8\u3051\u308b\u306e\u3067\u306f\uff1f\u3068\u3084\u3063\u3066\u3057\u307e\u3046\u3068\u3001\u30e1\u30bd\u30c3\u30c9\u304c\u5408\u6210\u3055\u308c\u305a\u52d5\u304b\u306a\u3044\u306e\u3067\u6ce8\u610f\u3057\u307e\u3057\u3087\u3046\u3002\n\u3042\u3068this\u306e\u554f\u984c\u304b\u3089\nconnected: () => {\n  this.perform('hello'); // Channel\u306e\u30e1\u30bd\u30c3\u30c9\u3092\u53e9\u304f\n}\n\n\u3053\u3046\u3057\u3066\u3057\u307e\u3046\u3068\u52d5\u304d\u307e\u305b\u3093\u3001\u304b\u306a\u3057\u3044\u3067\u3059\u306d\u3002\n\n\u5185\u90e8\u306b\u624b\u3092\u7a81\u3063\u3053\u3080 (Rails)\nWebSocket\u306a\u3069\u3067\u3084\u308a\u3068\u308a\u3059\u308b\u30c7\u30fc\u30bf\u306f\u5927\u4f53JSON\u3067\u3001JSON\u306e\u4e2d\u306b\u3055\u3089\u306bJSON\u304c\u3042\u3063\u305f\u308a\u3059\u308b\u306e\u3067\u3001\u305d\u308c\u306b\u6c17\u3092\u3064\u3051\u307e\u3059\u3002\n{\n  string: {\n    message: 'hello.'\n  }.to_json\n}.to_json\n\n\n\u5185\u90e8Channel\u3092\u3064\u304f\u308b (Rails)\n# \u3060\u3081\nDisconnectionChannel.new(connection, identifier)\n\nConnection\u5185\u3067\u5358\u7d14\u306b\u3053\u3046\u3059\u308b\u3068\u3001Channel\u3068\u3057\u3066\u3042\u308b\u7a0b\u5ea6\u52d5\u304d\u307e\u3059\u304c\u3001subscribed\u3084unsubscribed\u3068\u3044\u3063\u305f\u30d5\u30c3\u30af\u3084\u3001Connection\u304c\u7d42\u308f\u3063\u305f\u6642\u306eChannel\u306e\u5f8c\u7247\u4ed8\u3051\u306e\u30ea\u30b9\u30c8\u304b\u3089\u6f0f\u308c\u3066\u3057\u307e\u3044\u307e\u3059\u3002\n\u305d\u3046\u306a\u308b\u3068\u3044\u3064\u307e\u3067\u3082\u6b8b\u3063\u305f\u307e\u307e\u306b\u306a\u308a\u3001\u3088\u304f\u3042\u308a\u307e\u305b\u3093\u3002\n\u305d\u3053\u3067\u3001\u3042\u304f\u307e\u3067Consumer\u304b\u3089\u63a5\u7d9a\u8981\u8acb\u304c\u3042\u308a\u307e\u3057\u305f\u3088\u3068\u3044\u3046\u4f53\u3067\u4f5c\u6210\u3057\u307e\u3059\u3002\nsend_async :dispatch_websocket_message, {\n  command: 'subscribe',\n  identifier: {channel: DisconnectionChannel.to_s}.to_json,\n}.to_json\n\n\n\u3053\u308c\u3067subscribed\u3068unsubscribed\u304c\u3061\u3083\u3093\u3068\u547c\u3070\u308c\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3057\u305f\u3002\n\u305f\u3060\u3001send_async\u306f\u975e\u540c\u671f\u306b\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3059\u308b\u305f\u3081\u306b\u516c\u958b\u3055\u308c\u3066\u3044\u308b\u30e1\u30bd\u30c3\u30c9\u3067\u3059\u304c\u3001dispatch_websocket_message\u5468\u308a\u306f\u516c\u958b\u3055\u308c\u3066\u3044\u308b\u3082\u306e\u3067\u306f\u306a\u3044\u306e\u3067\u3001\u3084\u3081\u3068\u3044\u305f\u65b9\u304c\u826f\u3055\u305d\u3046\u3067\u3059\u3002\n\n\u508d\u53d7\u3057\u3066disconnect\u524d\u306b\u4f55\u304b\u3059\u308b\n\u3053\u308c\u306fUserConnections\u3092\u4f5c\u6210\u3059\u308b\u524d\u306b\u3001\u5207\u65ad\u3059\u308b\u524d\u306b\u4f55\u304b\u901a\u77e5\u3059\u308b\u305f\u3081\u306b\u4f7f\u3063\u3066\u3044\u305f\u624b\u6bb5\u3067\u3059\u3002\n\u9000\u5ba4\u3057\u3066ActionCable.server.disconnect\u3092\u767a\u884c\u3059\u308b\u524d\u306b\u9000\u5ba4\u3059\u308b\u3088\u307f\u305f\u3044\u306a\u306e\u3092\u9023\u7d61\u3057\u307e\u3059\u3002\nActionCable.server.broadcast internal_channel, {disconnection: true}\n\nclass DisconnectionChannel < ApplicationCable::Channel\n  def subscribed\n    stream_from connection.me # internal_channel\u3092\u8fd4\u3059\u30e1\u30bd\u30c3\u30c9\n  end\n\n  def transmit(data, *rest)\n    connection.tell_closing if !!data['disconnection']\n  end\nend\n\nstream_from\u3057\u305f\u307e\u307e\u3060\u3068\u5782\u308c\u6d41\u3057\u30c1\u30e3\u30f3\u30cd\u30eb\u306b\u306a\u3063\u3066\u3057\u307e\u3046\u306e\u3067\u3001transmit\u3067\u508d\u53d7\u3057\u3064\u3064\u3001\u6291\u3048\u3066\u304a\u304d\u307e\u3059\u3002\n\n\u30d0\u30b0\u304b\u3057\u3089\uff1f (Rails)\n\u8ffd\u8a18 \u540c\u30b3\u30fc\u30c9\u306e\u30d7\u30eb\u30ea\u30af\u30a8\u30b9\u30c8\u304c\u30de\u30fc\u30b8\u3055\u308c\u305f\u306e\u3067\u3001\u3053\u308c\u306f\u3082\u3046\u3042\u308a\u307e\u305b\u3093\u3002\nChannel\u306eunsubscribed\u3067ActionCable.server.broadcast\u3092\u884c\u3063\u3066\u3044\u308b\u3068\u3001\u3054\u304f\u307e\u308c\u306b\u4e8c\u5ea6\u3068\u305d\u306estream\u3067\u306fActionCable.server.broadcast\u304c\u6210\u529f\u3057\u306a\u304f\u306a\u308b\u3068\u3044\u3046\u73fe\u8c61\u304c\u3042\u308a\u307e\u3059\u3002\n\uff08\u8a72\u5f53Channel\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u6570\u304c1 -> 0 -> 1\u306e\u6642\u306b\u8d77\u3053\u308a\u3001\u518d\u30730\u306b\u306a\u308b\u307e\u3067\u306a\u304a\u308a\u307e\u305b\u3093\uff09\n\u8272\u3005p\u3057\u3066\u305f\u3069\u308a\u3064\u3044\u3066\u3001\u3068\u308a\u3042\u3048\u305a\u3053\u306e\u30e2\u30f3\u30ad\u30fc\u30d1\u30c3\u30c1\u3067\u73fe\u8c61\u306f\u8d77\u3053\u3089\u306a\u304f\u306a\u308a\u307e\u3057\u305f\u3002\u554f\u3044\u5408\u308f\u305b\u4e2d\u3067\u3059\u3002\nmodule ActionCable\n  module SubscriptionAdapter\n    class SubscriberMap\n      def broadcast(channel, message)\n        list = @sync.synchronize do\n          return if !@subscribers.key?(channel)\n          @subscribers[channel].dup\n        end\n\n        list.each do |subscriber|\n          invoke_callback(subscriber, message)\n        end\n      end\n    end\n  end\nend\n\n\n\u3053\u308c\u306f\u3053\u308c\u3067\u3059\n@subscribers = Hash.new { |h,k| h[k] = [] } # => {}\n@subscribers['channel'].dup                 # => []\n@subscribers                                # => {\"channel\"=>[]}\n\n\n\u304a\u308f\u308a\n\u3068\u3044\u3063\u305f\u3088\u3046\u306b\u3001\u8272\u3005\u3068\u624b\u3092\u7a81\u3063\u8fbc\u3093\u3060\u308a\u3057\u3066\u307f\u307e\u3057\u305f\u3002\n\u81ea\u5206\u304c\u3053\u3046\u3057\u305f\u307b\u3046\u304c\u3044\u3044\u306a\u3001\u3068\u601d\u3063\u305f\u3088\u3046\u306b\u5b9f\u88c5\u3057\u3088\u3046\u3068\u3059\u308b\u3068\u3001example\u306a\u3069\u304b\u3089\u306f\u898b\u3048\u3066\u3053\u306a\u304b\u3063\u305f\u90e8\u5206\u304c\u898b\u3048\u305f\u308a\u3001\u898b\u3048\u306a\u3044\u90e8\u5206\u3092\u3055\u304c\u3057\u305f\u308a\u3057\u3066\u3001\u52c9\u5f37\u306b\u306a\u308b\u306a\u3068\u601d\u3044\u307e\u3059\u3002\n\u3053\u308c\u3092\u66f8\u3044\u3066\u308b\u9014\u4e2d\u306b\u3082\u3001\u3053\u308c\u306f\u3069\u3046\u306a\u306e\uff1f\u307f\u305f\u3044\u306a\u611f\u3058\u3067\u8272\u3005\u3084\u3063\u3066\u307f\u3066\u306a\u308b\u307b\u3069\u301c\u3068\u3044\u3046\u306e\u304c\u3042\u3063\u305f\u306e\u3067\u3088\u304b\u3063\u305f\u3067\u3059\u3002\n\u307e\u3060\u6bd4\u8f03\u7684\u306b\u65b0\u3057\u3044\u6a5f\u80fd\u306a\u306e\u3067\u3050\u3050\u308a\u3093\u3050\u304c\u52b9\u679c\u3092\u767a\u63ee\u305b\u305a\u3001\u7d50\u679c\u3068\u3057\u3066\u3001\u3061\u3083\u3093\u3068\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u3084\u30b3\u30fc\u30c9\u3092\u8aad\u3080\u3053\u3068\u306b\u3088\u308b\u5b66\u3073\u3084\u3001\u5e8a\u677f\u3092\u8e0f\u307f\u306c\u304f\u306a\u3069\u304c\u3042\u3063\u305f\u306e\u3067\u307e\u3068\u3081\u307e\u3059\u3002\n\n`ActionCable`\u306e\u6a5f\u80fd\u7d39\u4ecb\u3068\u3044\u3063\u305f\u3082\u306e\u3067\u306f\u306a\u304f\u3001\u3053\u3046\u3057\u305f\u304b\u3063\u305f\u304b\u3089\u3053\u306e\u6a5f\u80fd\u3092\u4f7f\u3063\u305f\u3001\u4f7f\u3048\u306a\u304b\u3063\u305f\u3001\u3053\u3046\u3057\u305f\u3089\u5177\u5408\u304c\u826f\u304b\u3063\u305f\u3001\u3068\u3044\u3046\u5099\u5fd8\u9332\u3068\u306a\u3063\u3066\u3044\u307e\u3059\u3002\n\n\u66f8\u304d\u306a\u304c\u3089\u30b3\u30fc\u30c9\u3082\u5897\u3048\u3066\u3044\u3063\u305f\u306e\u3067\u9577\u3044\u3067\u3059\u3002\n\n# \u3069\u306e\u3088\u3046\u306a\u30c1\u30e3\u30c3\u30c8\n\n\u30de\u30fc\u30de\u30fc\u30c1\u30e3\u30c3\u30c8\u3092\u899a\u3048\u3066\u308b\u4eba\u306f\u3044\u307e\u3059\u304b\uff1f\u3068\u3044\u3046\u304b\u3001\u307e\u3060\u3042\u3063\u305f\u308a\u3059\u308b\u3093\u3067\u3059\u304b\u306d\u3002\n\n\u3075\u304d\u3060\u3057\u4f4d\u7f6e\u3092\u81ea\u7531\u306b\u6c7a\u3081\u3089\u308c\u308b\u30c1\u30e3\u30c3\u30c8\u3067\u300116\u5e74\u3050\u3089\u3044\u524d\u3001\u30c1\u30e3\u30c3\u30c8\u306b\u306f\u307e\u3063\u3066\u3044\u305f\u6642\u671f\u306b\u5229\u7528\u3057\u3066\u3044\u305f\u306e\u3092\u601d\u3044\u51fa\u3057\u306a\u304c\u3089\u3001\u4f3c\u305f\u611f\u3058\u306e\u3092\u3064\u304f\u308a\u307e\u3057\u305f\u3002\n\n![\u30de\u30fc\u30de\u30fc.png](https://qiita-image-store.s3.amazonaws.com/0/78566/5599ed76-8bf6-b625-6559-77b98625fc80.png)\n\n\u305f\u3057\u304bJava\u30a2\u30d7\u30ec\u30c3\u30c8\u3067\u52d5\u3044\u3066\u3044\u3066\u3001\u3042\u308c\u3063\u3066WebSocket\u3058\u3083\u306a\u3044\u306e\u304b\u306a\u30fc\u3068\u30d5\u30f3\u30ef\u30ea\u601d\u3044\u51fa\u3057\u305f\u306e\u304c\u3064\u306a\u304c\u308a\u307f\u305f\u3044\u306a\u3082\u306e\u3067\u3059\u3002\n\n# \u30d0\u30fc\u30b8\u30e7\u30f3\n\n- Rails 5.0.0.rc1\n\n\u3088\u3063\u3066\u4eca\u5f8c\u53c2\u8003\u306b\u306a\u3089\u306a\u304f\u306a\u308b\u53ef\u80fd\u6027\u306f\u5927\u3044\u306b\u3042\u308a\u307e\u3059\u3002\n\n# \u30bd\u30fc\u30b9\n\n<i class=\"fa fa-chain\"></i> [mmmpa/cable_chat](https://github.com/mmmpa/cable_chat)\n\nexample\u306a\u3069\u3067\u306fCoffeeScript\u3092\u4f7f\u7528\u3057\u3066\u3044\u307e\u3057\u305f\u304c\u3001ES2015\u3067\u5b9f\u88c5\u3057\u3066\u3044\u307e\u3059\u3002\n(Rails\u3067\u5b8c\u7d50\u3057\u3088\u3046\u3068browserify-rails\u3092\u4f7f\u7528\u3057\u307e\u3057\u305f)\n\n## ActionCable\u95a2\u4fc2\u306e\u30b3\u30fc\u30c9\u306e\u5834\u6240\n\n<i class=\"fa fa-chain\"></i> [app/channels - Rails\u5074](https://github.com/mmmpa/cable_chat/tree/master/app/channels)\n\n<i class=\"fa fa-chain\"></i> [app/assets/javascripts/models/chat-cable.js - JavaScript\u5074](https://github.com/mmmpa/cable_chat/tree/master/app/channels)\n<i class=\"fa fa-chain\"></i> [app/assets/javascripts/contexts/chat-context.js - React\u306e\u4e00\u756a\u4e0a](https://github.com/mmmpa/cable_chat/tree/master/app/channels)\n\n# \u304a\u304a\u307e\u304b\u306a\u7406\u89e3\n\n## Rails\u5074\n\n### `Connection`\n\n\u5b9f\u969b\u306b\u3064\u306a\u3050\u4e00\u672c\u306eWebSocket\u306b\u95a2\u3059\u308b\u5b9f\u88c5\u3092\u3057\u307e\u3059\u3002\u63a5\u7d9a\u3059\u308b\u3057\u306a\u3044\u3092\u30ad\u30e1\u307e\u3059\u3002\u63a5\u7d9a\u3054\u3068\u306b\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u304c\u3064\u304f\u3089\u308c\u307e\u3059\u3002\n\n### `Channel`\n\n\u5b9f\u969b\u306b\u7e4b\u304c\u308c\u305f\u4e00\u672c\u306e`Connection`\u4e0a\u3067\u884c\u308f\u308c\u308b\u3084\u308a\u3068\u308a\u3092\u5b9f\u88c5\u3057\u307e\u3059\u3002\u63a5\u7d9a\u3054\u3068\u306b\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u304c\u3064\u304f\u3089\u308c\u307e\u3059\u3002\n\n## JavaScript\u5074\n\n### `Consumer`\n\n`Connection`\u306b\u5bfe\u5fdc\u3057\u307e\u3059\u3002\n\n### `Subscription`\n\n`Channel`\u306b\u5bfe\u5fdc\u3057\u307e\u3059\u3002\n\n# \u30c6\u30b9\u30c8\u306b\u3064\u3044\u3066\n\n\u30c6\u30b9\u30c8\u306f\u30c6\u30b9\u30c8\u3067\u5927\u3044\u306b\u8db3\u3092\u3072\u3063\u304b\u3051\u305f\u306e\u3067\u3001\u5225\u30da\u30fc\u30b8\u306b\u307e\u3068\u3081\u307e\u3057\u305f\u3002\n\n<i class=\"fa fa-chain\"></i>  [ActionCable\u306eConnection\u3068Channel\u3092\u5358\u4f53\u30c6\u30b9\u30c8\u3059\u308b\u3002 - Qiita](http://qiita.com/mmmpa/items/4f2c6864aaa641860dd0)\n<i class=\"fa fa-chain\"></i>  [Capybara\u3067ActionCable\u306e\u6a5f\u80fd\u30c6\u30b9\u30c8\u3092\u3059\u308b\u3002 - Qiita](http://qiita.com/mmmpa/items/afa97d6e74406404d2a6)\n<i class=\"fa fa-chain\"></i> [SimpleCov\u3067\u30ab\u30d0\u30ec\u30c3\u30b8\u3092\u3068\u308c\u308b\u306f\u305a\u306a\u306e\u306b\u3068\u308c\u306a\u3044\u30d5\u30a1\u30a4\u30eb\u304c\u3042\u308b\u5834\u5408\u306e\u51e6\u7f6e\u3002 - Qiita](http://qiita.com/mmmpa/items/a618f69877bb7befa7b5)\n\n## \u6ce8\u610f\u70b9\n\n\u73fe\u6bb5\u968e\u3067\u306f\u3001\u7279\u306b`ActionCable`\u3092\u5b8c\u5168\u4f53\u3067\u52d5\u304b\u3059\u6a5f\u80fd\u30c6\u30b9\u30c8\u306b\u304a\u3044\u3066\u306f\u3001\u5404\u30c6\u30b9\u30c8\u306e\u958b\u59cb\u7d42\u4e86\u306b\u30d5\u30c3\u30af\u3057\u3066\u884c\u308f\u308c\u308b\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306e\u30ed\u30fc\u30eb\u30d0\u30c3\u30af\u306a\u3069\u304c\u3046\u307e\u304f\u52d5\u304b\u306a\u3044\u3053\u3068\u304c\u3088\u304f\u3042\u308a\u307e\u3059\u3002\n\n`before :each`\u306a\u3069\u3092\u4f7f\u7528\u3057\u3066\u5bfe\u51e6\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u3002\n\n## \u30c6\u30b9\u30c8\u4e2d\u306b\u3073\u3063\u304f\u308a\u3059\u308b\u8a71 (Rails)\n\nRedis\u3092pubsub\u30b5\u30fc\u30d0\u30fc\u3068\u3057\u3066\u4f7f\u3063\u3066\u3044\u308b\u5834\u5408\u3001\u30c7\u30d5\u30a9\u30eb\u30c8\u3067\u306f`Rails.env.test?`\u3068`Rails.env.development?`\u3067\u540c\u3058\u30b5\u30fc\u30d0\u30fc\u3001\u540c\u3058`subscribe`\u7528\u306e\u6587\u5b57\u5217\u3092\u4f7f\u3063\u3066\u3044\u307e\u3059\u3002\n\n\u6a5f\u80fd\u30c6\u30b9\u30c8\u4e2d\u306b\u3001\u540c\u6642\u306bdevelopment\u3092\u30d6\u30e9\u30a6\u30b6\u3067\u958b\u3044\u3066\u64cd\u4f5c\u3057\u3066\u3044\u308b\u3068\u3001\u30c6\u30b9\u30c8\u5074\u306e\u30e1\u30c3\u30bb\u30fc\u30b8\u304c\u5c4a\u304d\u307e\u304f\u308a\u307e\u3059\uff08\u9006\u3082\u3082\u3061\u308d\u3093\uff09\u3002\n\n# \u30c1\u30e3\u30c3\u30c8\u5b9f\u88c5\u306b\u3064\u3044\u3066\n\n## <i class=\"fa fa-hand-o-right\"></i> `Connection`\u306e\u8a2d\u5b9a (Rails)\n\n\u3053\u3053\u3060\u3051`ActionCable`\u81ea\u4f53\u306e\u8a71\u3067\u3059\u3002\n\n\u4eca\u56de\u306e\u30c1\u30e3\u30c3\u30c8\u3067\u306f\u3001`Cookie`\u3092\u5171\u6709\u3059\u308b\u30d6\u30e9\u30a6\u30b6\u3067\u8907\u540c\u6642\u306b\u30a2\u30af\u30bb\u30b9\u3057\u305f\u5834\u5408\u3001\u540c\u3058\u4eba\u9593\u3068\u3057\u3066\u6271\u3044\u307e\u3059\u3002`ActionCable`\u306f`identified_by`\u3092\u7528\u3044\u3066\u3001\u305d\u306e\u7279\u5b9a\u306e\u305f\u3081\u306e\u30d7\u30ed\u30d1\u30c6\u30a3\u3092\u8a2d\u5b9a\u3067\u304d\u307e\u3059\u3002\n\n```rb\nmodule ApplicationCable\n  class Connection < ActionCable::Connection::Base\n    identified_by :current_user\n\n    def connect\n      self.current_user = find_user_or_reject # User\u3092\u3055\u304c\u3057\u3066\u8fd4\u3059\u3002\u3044\u306a\u3051\u308c\u3070\u5207\u65ad\n    end\n    # \u7565\n  end\nend\n```\n\n\u3053\u308c\u306b\u3088\u308a\u3001\u540c\u4e00\u306e\u30c7\u30fc\u30bf\u3092\u3082\u3068\u306bidentify\u3055\u308c\u305f`Connection`\u306f\u540c\u3058`internal_channel`\u6587\u5b57\u5217\u3092\u6301\u3064\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\n\n> Makes it possible for the RemoteConnection to disconnect a specific connection.\n\n\u3068\u3044\u3046\u65e2\u8ff0\u304c\u30bd\u30fc\u30b9\u30b3\u30fc\u30c9\u306b\u3042\u308b\u3068\u304a\u308a\u3001`internal_channel`\u306f\u76f4\u63a5\u53c2\u7167\u3057\u3066\u4f55\u304b\u3092\u3059\u308b\u305f\u3081\u306e\u3082\u306e\u3067\u306f\u3042\u308a\u307e\u305b\u3093\u304c\u3001\u5185\u90e8\u306b\u624b\u3092\u3064\u3063\u3053\u307f\u305f\u304f\u306a\u3063\u305f\u3089\u3053\u308c\u304c\u4f7f\u3048\u308b\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u3002\n\n## <i class=\"fa fa-hand-o-right\"></i> \u30b5\u30fc\u30d0\u30fc\u3078\u306e\u63a5\u7d9a\u6210\u5426\u3092\u901a\u77e5\u3057\u305f\u3044 (JS -> Rails -> JS)\n\n```js:app/assets/javascripts/models/chat-cable.js\n  connect() {\n    this.cable = window.ActionCable.createConsumer();\n    this.cable.subscriptions.create('SessionChannel', this.sessionChannelCallback);\n  }\n```\n\nJavaScript\u5074\u304b\u3089\u306e\u63a5\u7d9a\u306f`ActionCable.createConsumer`\u3057\u305f\u6642**\u3067\u306f\u306a\u304f**\u3001\u306f\u3058\u3081\u3066`this.cable.subscriptions.create`\u3057\u305f\u6642\u306b\u8d77\u3053\u308a\u307e\u3059\u3002\n\n`createConsumer`\u306f\u5358\u306b\u63a5\u7d9a\u5148\u306e\u8a2d\u5b9a\u3092\u3057\u3001\u5f8c\u306e\u63a5\u7d9a\u3092\u4e00\u5143\u7ba1\u7406\u3059\u308b\u305f\u3081\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n### `SessionChannel`\u3067`Subscription`\u306b\u63a5\u7d9a\u62d2\u5426\u3092\u5373\u5ea7\u306b\u901a\u77e5\u3059\u308b\u305f\u3081\u306e\u8155\u529b\n\n\u63a5\u7d9a\u62d2\u5426\u306b\u7528\u3044\u3089\u308c\u308b`reject_unauthorized_connection`\u306f`Subscription`\u306b\u306a\u306b\u3082\u901a\u77e5\u3057\u307e\u305b\u3093\u3002\n\n`Subscription`\u306f\u5185\u90e8\u3067\u306e\u5b9a\u671f\u7684\u306a\u63a5\u7d9a\u78ba\u8a8d\u51e6\u7406\u3067`disconnected`\u304c\u767a\u751f\u3057\u3066\u3044\u308b\u306e\u3092\u898b\u3066\u6c17\u3065\u304f\u3057\u304b\u3042\u308a\u307e\u305b\u3093\u3002\u3053\u308c\u3067\u306f\u521d\u56de\u306e\u30bb\u30c3\u30b7\u30e7\u30f3\u304c\u6b8b\u7559\u3057\u3066\u308b\u304b\u5426\u304b\u306e\u78ba\u8a8d\u306b\u3001\u6bce\u56de\u6570\u79d2\u5f85\u3064\u3053\u3068\u306b\u306a\u308a\u307e\u3059\u3002\n\n\u305d\u308c\u306f\u3044\u3084\u306a\u306e\u3067\u7121\u7406\u3084\u308a\u901a\u77e5\u3057\u307e\u3059\u3002\n\n```rb:app/channels/application_cable/connection.rb\n    def transmit_rejection\n      # SessionChannel\u306e\u30e1\u30c3\u30bb\u30fc\u30b8\u3068\u3057\u3066\u9001\u4fe1\n      transmit(\n        identifier: {channel: SessionChannel.to_s}.to_json,\n        type: ActionCable::INTERNAL[:message_types][:rejection]\n      )\n    end\n```\n\n\u9053\u304b\u3089\u306f\u305a\u308c\u305f\u4f7f\u3044\u304b\u305f\u306a\u306e\u3067\u3001\u4eca\u5f8c\u52d5\u304b\u306a\u304f\u306a\u308b\u53ef\u80fd\u6027\u304c\u3042\u308a\u307e\u3059\u3002\n\n### `Consumer`\u3067\u660e\u793a\u7684\u306b\u5207\u65ad\u3057\u306a\u3044\u3068\u554f\u3044\u5408\u308f\u305b\u3057\u7d9a\u3051\u308b\n\nJavaScript\u7684\u306b\u306f\u5ef6\u3005\u3068`disconnected`\u3092\u767a\u751f\u3059\u308b\u3060\u3051\u306a\u306e\u3067\u3059\u304c\u3001\u305d\u306e\u88cf\u3067\u306f\u6bce\u56de`Connection`\u306b\u554f\u3044\u3042\u308f\u305b\u3092\u7d9a\u3051\u3066\u3044\u307e\u3059\u3002\u3042\u307e\u308a\u3088\u304f\u3042\u308a\u307e\u305b\u3093\u3002\n\n```js\nthis.consumer.disconnect();\n```\n\n`rejected`\u304c\u767a\u751f\u3057\u305f\u6642\u70b9\u3067\u3001JavaScript\u5074\u304b\u3089\u3082`SessionChannel`\u7528\u306e`Subscription`\u304b\u3089\u660e\u793a\u7684\u306b\u5207\u65ad\u3057\u307e\u3057\u305f\u3002\n\n### \u63a5\u7d9a\u6210\u529f\u5f8c\n\n\u63a5\u7d9a\u6210\u529f\u6642\u306b\u306f`connected`\u304c\u767a\u751f\u3059\u308b\u306e\u3067\u3001\u305d\u308c\u3092\u4ee5\u3063\u3066\u5404\u7a2e\u6e96\u5099\u3092\u958b\u59cb\u3057\u307e\u3059\u3002\n\n\u305d\u306e\u4ed6\u306f\u666e\u901a\u306e\u5b9f\u88c5\u306a\u306e\u3067\u3001example\u306a\u3069\u3068\u7279\u306b\u5909\u308f\u3063\u305f\u30dd\u30a4\u30f3\u30c8\u306f\u3042\u308a\u307e\u305b\u3093\u3002\n\n## <i class=\"fa fa-hand-o-right\"></i> \u30b5\u30fc\u30d0\u30fc\u304b\u3089\u7279\u5b9a\u306e`Connection`\u3092\u5207\u65ad\u3059\u308b\u3002 (Rails)\n\n\u8907\u6570\u306e`Connection`\u304c\u3059\u3067\u306b\u78ba\u7acb\u3055\u308c\u3066\u3044\u308b\u5834\u5408\u3001`Connection`\u306eidentify\u306b\u4f7f\u308f\u308c\u3066\u3044\u308b`current_user`\u306e\u5927\u672c\u3092\u5358\u7d14\u306b\u524a\u9664\u3057\u305f\u3060\u3051\u3067\u306f\u63a5\u7d9a\u3092\u65ad\u3066\u307e\u305b\u3093\u3002\n\n\u305d\u308c\u3069\u3053\u308d\u304b\u30e6\u30fc\u30b6\u30fc\u30c7\u30fc\u30bf\u304c\u6d88\u3048\u3066\u63a5\u7d9a\u3060\u3051\u304c\u6b8b\u308b\u3001\u6c17\u307e\u305a\u3044\u72b6\u6cc1\u306b\u306a\u308a\u307e\u3059\u3002\n\n`ActionCable.server`\u306b\u306fidentify\u306b\u4f7f\u7528\u3055\u308c\u3066\u3044\u308b\u30c7\u30fc\u30bf\u3092\u5229\u7528\u3057\u3066\u3001\u305d\u308c\u306b\u3088\u308aidentify\u3055\u308c\u3066\u3044\u308b\u81ea\u5206\u4ee5\u5916\u306e`Connection`\u3092`RemoteConnection`\u30af\u30e9\u30b9\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3068\u3057\u3066\u5f97\u308b\u30e1\u30bd\u30c3\u30c9\u3068\u3001\u5207\u65ad\u3059\u308b\u30e1\u30bd\u30c3\u30c9\u304c\u3042\u308a\u307e\u3059\u3002\u3053\u308c\u3067\u4e00\u6c17\u306b\u5207\u65ad\u3057\u307e\u3059\u3002\n\n\u4eca\u56de\u306f\u81ea\u5206\u95a2\u9023\u306e`Connection`\u304c\u30bf\u30fc\u30b2\u30c3\u30c8\u306a\u306e\u3067`current_user`\u3092\u7528\u3044\u307e\u3059\u304c\u3001`User.find(n)`\u3067\u5f97\u3089\u308c\u308b\u3088\u3046\u306a\u4ed6\u306e\u30e6\u30fc\u30b6\u30fc\u3067\u3082\u3082\u3061\u308d\u3093\u4f7f\u3048\u307e\u3059\u3002Ban\u6a5f\u80fd\u306a\u3069\u304c\u5fc5\u8981\u306b\u306a\u308c\u3070\u3053\u308c\u304c\u4f7f\u3048\u307e\u3059\u306d\u3002\n\n```rb\n# RemoteConnections\u3092\u5f97\u308b\nActionCable.server.where({current_user: current_user})\n\n# \u5168\u3066\u5207\u65ad\u3059\u308b\nActionCable.server.disconnect({current_user: current_user})\n```\n\n\u3068\u3053\u308d\u3067\u3053\u308c\u306f`Connection`\u304c\u6301\u3064`websocket`\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e`close`\u30e1\u30bd\u30c3\u30c9\u306b\u76f4\u63a5\u4f5c\u7528\u3059\u308b\u306e\u3067\u3001`Connection`\u306e`close`\u30e1\u30bd\u30c3\u30c9\u3092\u30aa\u30fc\u30d0\u30fc\u30e9\u30a4\u30c9\u3057\u3066\u3082\u51e6\u7406\u3092\u88ab\u305b\u3089\u308c\u307e\u305b\u3093\u3002\n\n`close`\u5f8c\u306e\u51e6\u7406\u3092\u3069\u3046\u306b\u304b\u3059\u308b\u30e1\u30bd\u30c3\u30c9\u306f\u3042\u308a\u307e\u3057\u305f\u304c\u3001`close`\u524d\u306e\u3082\u306e\u306f\u3042\u308a\u307e\u305b\u3093\u3067\u3057\u305f\u3002\u3088\u3063\u3066\u5c11\u3057\u306e\u30bf\u30a4\u30e0\u30e9\u30b0\u304c\u3042\u308a\u307e\u3059\u3002\n\n### \u624b\u3092\u7a81\u3063\u3053\u3080\u30d2\u30f3\u30c8\n\n`ActionCable.server.disconnect`\u306f\u5358\u306a\u308b`broadcast`\u3067\u3059\u3002\n\n```rb\nserver.broadcast internal_channel, type: 'disconnect'\n```\n\n### \u5b9f\u969b\u5168\u90e8\u5207\u65ad\u3059\u308b\u969b\u306b\u3069\u3046\u3057\u305f\u304b\n\n\u540c\u3058`current_user`\u3067identify\u3055\u308c\u3066\u3044\u308b`Connection`\u3092\u3072\u3051\u308b`UserConnections`\u3068\u3044\u3046\u30af\u30e9\u30b9\u3092\u4f5c\u6210\u3057\u3001\u305d\u3053\u304b\u3089\u5168\u3066\u306e`Connection`\u3092\u3072\u3068\u3064\u305a\u3064`close`\u3067\u304d\u308b\u3088\u3046\u306b\u3057\u307e\u3057\u305f\u3002\n\n\u5207\u65ad\u6642\u306e\u901a\u77e5\u3082\u3053\u308c\u3067\u5909\u306a\u30cf\u30c3\u30af\u306a\u3057\u306b\u884c\u3048\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3057\u305f\u3002\n\n## <i class=\"fa fa-hand-o-right\"></i> \u30c7\u30fc\u30bf\u306e\u53d7\u4fe1\u3068\u914d\u4fe1 (JS -> Rails -> JS)\n\n\u30c1\u30e3\u30c3\u30c8\u3068\u3044\u3046\u3053\u3068\u3067\u3001\u5404\u7a2e\u60c5\u5831\u3092\u6295\u3052\u3066\u3044\u304f\u3053\u3068\u306b\u306a\u308a\u307e\u3059\u3002\n\n\u6295\u3052\u3089\u308c\u308b\u306e\u306f\u5358\u7d14\u306a`Hash`\u3067\u3059\u304c\u3001\u5b9f\u969b\u306e\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3067\u306f\u3001`Subscription`\u304b\u3089\u5c4a\u3044\u305f\u30c7\u30fc\u30bf\u3092\u4e38\u6d41\u3057\u3059\u308b\u306e\u306f\u307b\u307c\u306a\u3044\u3068\u601d\u3044\u307e\u3059\u3002\n\nJavaScript\u5074\uff08\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u5074\uff09\u304b\u3089\u9001\u4fe1\u3055\u308c\u308b\u4e0d\u6b63\u306a\u30c7\u30fc\u30bf\u306e\u6291\u5236\u306fJavaScript\u5074\u3067\u306f\u3067\u304d\u306a\u3044\u306e\u3067\u3001JavaScript\u5074\u3067\u3042\u308c\u3053\u308c\u8133\u307f\u305d\u3092\u7d5e\u308b\u3088\u308a\u3082\u3001\u30b5\u30fc\u30d0\u30fc\u5074\u3067\u3061\u3083\u3093\u3068\u3084\u308b\u65b9\u304c\u3088\u3055\u305d\u3046\u3067\u3059\u3002\n\n\u4eca\u56de\u3001\u9001\u4fe1\u914d\u4fe1\u3055\u308c\u308b\u30e1\u30c3\u30bb\u30fc\u30b8\u306b\u306f140\u6587\u5b57\u306e\u5236\u9650\u306b\u304f\u308f\u3048\u3001\u5ea7\u6a19\u60c5\u5831\u304c\u3042\u308a\u307e\u3059\u3002\u3088\u3063\u3066\u6587\u5b57\u6570\u3068\u5ea7\u6a19\u3092\u30d0\u30ea\u30c7\u30fc\u30b7\u30e7\u30f3\u3057\u306a\u3051\u308c\u3070\u306a\u308a\u307e\u305b\u3093\u3002\n\n\n\u30d0\u30ea\u30c7\u30fc\u30b7\u30e7\u30f3\u3068`Hash`\u306b\u30c7\u30fc\u30bf\u3092\u6574\u5f62\u3059\u308b\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u30af\u30e9\u30b9\u3092\u4f5c\u6210\u3057\u307e\u3057\u305f\u3002\n\n```rb:app/models/member_message.rb\nclass MemberMessage\n  include ActiveModel::Validations\n\n  attr_accessor :user, :message, :x, :y\n\n  validates! :user, :message, :x, :y,\n             presence: true\n  validates! :message,\n             length: {in: 1..140}\n  validates! :x, :y,\n             numericality: true\n# \u7565\n  def render\n    {\n      name: user.name,\n      user_key: user.key,\n      key: \"#{Time.now.to_i}_#{user.key}\",\n      message: message,\n      x: x,\n      y: y\n    }\n  end\nend\n```\n\nHTML\u306b\u95a2\u3059\u308b\u30b5\u30cb\u30bf\u30a4\u30ba\u3092\u3057\u3066\u3044\u307e\u305b\u3093\u304c\u3001\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u3067\u63cf\u753b\u884c\u3046`React`\u306b\u305d\u306e\u6a5f\u80fd\u304c\u3042\u308b\u306e\u3067\u30d1\u30b9\u3057\u3066\u3044\u307e\u3059\u3002\u3082\u3057\u4eee\u306b\u305d\u306e\u307e\u307e\u63cf\u753b\u3059\u308b\u3088\u3046\u306a\u30b9\u30af\u30ea\u30d7\u30c8\u3084\u30e9\u30a4\u30d6\u30e9\u30ea\u3092\u4f7f\u7528\u3057\u3066\u3044\u308b\u306e\u306a\u3089\u3001\u3082\u3061\u308d\u3093\u884c\u3063\u305f\u65b9\u304c\u826f\u3044\u3067\u3057\u3087\u3046\u3002\n\n\u30c1\u30e3\u30c3\u30c8\u30e1\u30f3\u30d0\u30fc\u306e\u30c7\u30fc\u30bf\u306b\u95a2\u3057\u3066\u306f\u3055\u3089\u306b\u5358\u7d14\u3067\u3059\u304c\u3001\u540c\u3058\u304f\u30af\u30e9\u30b9\u3092\u4f5c\u6210\u3057\u307e\u3057\u305f\u3002\n\n\n\u30c7\u30fc\u30bf\u306e\u7d44\u307f\u7acb\u3066\u306f\u3001`Channel`\u5185\u3067\u3084\u308b\u3088\u308a\u3082\u3001\u5916\u306b\u8ffd\u3044\u3060\u3057\u305f\u307b\u3046\u304c\u826f\u3044\u306e\u3067\u306f\u3068\u601d\u3044\u307e\u3057\u305f\u3002\n\n## <i class=\"fa fa-hand-o-right\"></i> React\u3068\u306e\u9023\u643a (JS)\n\n\u3053\u308c\u306f\u7279\u306b\u554f\u984c\u306b\u306f\u306a\u308a\u307e\u305b\u3093\u3067\u3057\u305f\u3002\n\n`ActionCable`\u5468\u308a\u3092\u5f15\u304d\u53d7\u3051\u308b\u30af\u30e9\u30b9\u3092\u7528\u610f\u3057\u3001\u305d\u308c\u306b`React`\u5074\u304b\u3089\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u3092\u767b\u9332\u3057\u307e\u3059\u3002\u4eca\u56de\u306f`ChatCable`\u3068\u3044\u3046\u30af\u30e9\u30b9\u3092\u4f5c\u6210\u3057\u3001`new`\u6642\u306b\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u3092\u767b\u9332\u3057\u307e\u3057\u305f\u3002\n\n\u4f8b\u3048\u3070\u3053\u306e\u3088\u3046\u306a\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u3092\u767b\u9332\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\n```js\n{\n  messageReceived: (data) => {\n    this.setState({message: data});\n  },\n  memberReceived: (data) => {\n    this.setState({member: data});\n  }\n}\n```\n\n`ChatCable`\u306f\u5404\u7a2e`Subscription`\u306e\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u5185\u306a\u3069\u304b\u3089\u9069\u5207\u306a\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u3092\u547c\u3076\u3068\u3044\u3046\u5bf8\u6cd5\u3067\u3059\u3002\n\n\u304a\u4e92\u3044\u306b\u304a\u4e92\u3044\u306e\u30b3\u30fc\u30c9\u304c\u3042\u307e\u308a\u3081\u308a\u3053\u307e\u305a\u3001\u5177\u5408\u304c\u826f\u304b\u3063\u305f\u3067\u3059\u3002\n\n# \u5c0f\u30cd\u30bf\n\n## JS\u5074\u306e\u30ed\u30b0\u3092\u898b\u3088\u3046 (JS)\n\n```js\nActionCable.startDebugging();\n```\n\n\u3067JavaScript\u306e\u7d30\u304b\u3044\u30ed\u30b0\u304c\u89b3\u5bdf\u3067\u304d\u307e\u3059\u3002\n\n\n## ES2015 (JS)\n\n`subscriptions.create`\u3067\u306f\u5404`Channel`\u7528\u306e`Subscription`\u3092\u4f5c\u6210\u3057\u307e\u3059\u304c\u3001\u4f5c\u6210\u6642\u306b\u5404\u7a2e\u30a4\u30d9\u30f3\u30c8\u306b\u5bfe\u3057\u3066\u306e\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u3092\u767b\u9332\u3057\u307e\u3059\u3002\n\n```js\nthis.cable.subscriptions.create('SessionChannel', {\n  connected: function() {\n    this.perform('hello'); // Channel\u306e\u30e1\u30bd\u30c3\u30c9\u3092\u53e9\u304f\n  },\n  disconnected: function() {\n    this.clear();\n  },\n  clear() {\n    // clear\u51e6\u7406\n  }\n});\n```\n\n\u3053\u308c\u306f\u5185\u90e8\u3067\n\n```js:gems/2.3.0/gems/actioncable-5.0.0.rc1/lib/assets/compiled/action_cable.js\n    extend = function(object, properties) {\n      var key, value;\n      if (properties != null) {\n        for (key in properties) {\n          value = properties[key];\n          object[key] = value;\n        }\n      }\n      return object;\n    };\n```\n\n\u3053\u306e\u3088\u3046\u306a\u30e1\u30bd\u30c3\u30c9\u3092\u4f7f\u3063\u3066`Subscription`\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306b\u5408\u6210\u3055\u308c\u307e\u3059\u3002\n\n\u306a\u306e\u3067\u3001`this`\u3068\u304b\u898b\u3048\u308b\u3057\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u3092\u30af\u30e9\u30b9\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3068\u3057\u3066\u4f5c\u6210\u3055\u308c\u308b\u3088\u3046\u306b\u3057\u305f\u3089\u7dba\u9e97\u306b\u66f8\u3051\u308b\u306e\u3067\u306f\uff1f\u3068\u3084\u3063\u3066\u3057\u307e\u3046\u3068\u3001\u30e1\u30bd\u30c3\u30c9\u304c\u5408\u6210\u3055\u308c\u305a\u52d5\u304b\u306a\u3044\u306e\u3067\u6ce8\u610f\u3057\u307e\u3057\u3087\u3046\u3002\n\n\u3042\u3068`this`\u306e\u554f\u984c\u304b\u3089\n\n```\nconnected: () => {\n  this.perform('hello'); // Channel\u306e\u30e1\u30bd\u30c3\u30c9\u3092\u53e9\u304f\n}\n```\n\n\u3053\u3046\u3057\u3066\u3057\u307e\u3046\u3068\u52d5\u304d\u307e\u305b\u3093\u3001\u304b\u306a\u3057\u3044\u3067\u3059\u306d\u3002\n\n\n## \u5185\u90e8\u306b\u624b\u3092\u7a81\u3063\u3053\u3080 (Rails)\n\nWebSocket\u306a\u3069\u3067\u3084\u308a\u3068\u308a\u3059\u308b\u30c7\u30fc\u30bf\u306f\u5927\u4f53JSON\u3067\u3001JSON\u306e\u4e2d\u306b\u3055\u3089\u306bJSON\u304c\u3042\u3063\u305f\u308a\u3059\u308b\u306e\u3067\u3001\u305d\u308c\u306b\u6c17\u3092\u3064\u3051\u307e\u3059\u3002\n\n```rb\n{\n  string: {\n    message: 'hello.'\n  }.to_json\n}.to_json\n```\n\n## \u5185\u90e8`Channel`\u3092\u3064\u304f\u308b (Rails)\n\n```rb\n# \u3060\u3081\nDisconnectionChannel.new(connection, identifier)\n```\n\n`Connection`\u5185\u3067\u5358\u7d14\u306b\u3053\u3046\u3059\u308b\u3068\u3001`Channel`\u3068\u3057\u3066\u3042\u308b\u7a0b\u5ea6\u52d5\u304d\u307e\u3059\u304c\u3001`subscribed`\u3084`unsubscribed`\u3068\u3044\u3063\u305f\u30d5\u30c3\u30af\u3084\u3001`Connection`\u304c\u7d42\u308f\u3063\u305f\u6642\u306e`Channel`\u306e\u5f8c\u7247\u4ed8\u3051\u306e\u30ea\u30b9\u30c8\u304b\u3089\u6f0f\u308c\u3066\u3057\u307e\u3044\u307e\u3059\u3002\n\n\u305d\u3046\u306a\u308b\u3068\u3044\u3064\u307e\u3067\u3082\u6b8b\u3063\u305f\u307e\u307e\u306b\u306a\u308a\u3001\u3088\u304f\u3042\u308a\u307e\u305b\u3093\u3002\n\n\u305d\u3053\u3067\u3001\u3042\u304f\u307e\u3067`Consumer`\u304b\u3089\u63a5\u7d9a\u8981\u8acb\u304c\u3042\u308a\u307e\u3057\u305f\u3088\u3068\u3044\u3046\u4f53\u3067\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n```rb\nsend_async :dispatch_websocket_message, {\n  command: 'subscribe',\n  identifier: {channel: DisconnectionChannel.to_s}.to_json,\n}.to_json\n\n```\n\n\u3053\u308c\u3067`subscribed`\u3068`unsubscribed`\u304c\u3061\u3083\u3093\u3068\u547c\u3070\u308c\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3057\u305f\u3002\n\n\u305f\u3060\u3001`send_async`\u306f\u975e\u540c\u671f\u306b\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3059\u308b\u305f\u3081\u306b\u516c\u958b\u3055\u308c\u3066\u3044\u308b\u30e1\u30bd\u30c3\u30c9\u3067\u3059\u304c\u3001`dispatch_websocket_message`\u5468\u308a\u306f\u516c\u958b\u3055\u308c\u3066\u3044\u308b\u3082\u306e\u3067\u306f\u306a\u3044\u306e\u3067\u3001\u3084\u3081\u3068\u3044\u305f\u65b9\u304c\u826f\u3055\u305d\u3046\u3067\u3059\u3002\n\n### \u508d\u53d7\u3057\u3066`disconnect`\u524d\u306b\u4f55\u304b\u3059\u308b\n\n\u3053\u308c\u306f`UserConnections`\u3092\u4f5c\u6210\u3059\u308b\u524d\u306b\u3001\u5207\u65ad\u3059\u308b\u524d\u306b\u4f55\u304b\u901a\u77e5\u3059\u308b\u305f\u3081\u306b\u4f7f\u3063\u3066\u3044\u305f\u624b\u6bb5\u3067\u3059\u3002\n\n\u9000\u5ba4\u3057\u3066`ActionCable.server.disconnect`\u3092\u767a\u884c\u3059\u308b\u524d\u306b\u9000\u5ba4\u3059\u308b\u3088\u307f\u305f\u3044\u306a\u306e\u3092\u9023\u7d61\u3057\u307e\u3059\u3002\n\n```rb\nActionCable.server.broadcast internal_channel, {disconnection: true}\n```\n\n```rb\nclass DisconnectionChannel < ApplicationCable::Channel\n  def subscribed\n    stream_from connection.me # internal_channel\u3092\u8fd4\u3059\u30e1\u30bd\u30c3\u30c9\n  end\n\n  def transmit(data, *rest)\n    connection.tell_closing if !!data['disconnection']\n  end\nend\n```\n\n`stream_from`\u3057\u305f\u307e\u307e\u3060\u3068\u5782\u308c\u6d41\u3057\u30c1\u30e3\u30f3\u30cd\u30eb\u306b\u306a\u3063\u3066\u3057\u307e\u3046\u306e\u3067\u3001`transmit`\u3067\u508d\u53d7\u3057\u3064\u3064\u3001\u6291\u3048\u3066\u304a\u304d\u307e\u3059\u3002\n\n## \u30d0\u30b0\u304b\u3057\u3089\uff1f (Rails)\n\n**\u8ffd\u8a18** \u540c\u30b3\u30fc\u30c9\u306e\u30d7\u30eb\u30ea\u30af\u30a8\u30b9\u30c8\u304c\u30de\u30fc\u30b8\u3055\u308c\u305f\u306e\u3067\u3001\u3053\u308c\u306f\u3082\u3046\u3042\u308a\u307e\u305b\u3093\u3002\n\n`Channel`\u306e`unsubscribed`\u3067`ActionCable.server.broadcast`\u3092\u884c\u3063\u3066\u3044\u308b\u3068\u3001\u3054\u304f\u307e\u308c\u306b\u4e8c\u5ea6\u3068\u305d\u306estream\u3067\u306f`ActionCable.server.broadcast`\u304c\u6210\u529f\u3057\u306a\u304f\u306a\u308b\u3068\u3044\u3046\u73fe\u8c61\u304c\u3042\u308a\u307e\u3059\u3002\n\uff08\u8a72\u5f53`Channel`\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u6570\u304c1 -> 0 -> 1\u306e\u6642\u306b\u8d77\u3053\u308a\u3001\u518d\u30730\u306b\u306a\u308b\u307e\u3067\u306a\u304a\u308a\u307e\u305b\u3093\uff09\n\n\u8272\u3005`p`\u3057\u3066\u305f\u3069\u308a\u3064\u3044\u3066\u3001\u3068\u308a\u3042\u3048\u305a\u3053\u306e\u30e2\u30f3\u30ad\u30fc\u30d1\u30c3\u30c1\u3067\u73fe\u8c61\u306f\u8d77\u3053\u3089\u306a\u304f\u306a\u308a\u307e\u3057\u305f\u3002\u554f\u3044\u5408\u308f\u305b\u4e2d\u3067\u3059\u3002\n\n```rb\nmodule ActionCable\n  module SubscriptionAdapter\n    class SubscriberMap\n      def broadcast(channel, message)\n        list = @sync.synchronize do\n          return if !@subscribers.key?(channel)\n          @subscribers[channel].dup\n        end\n\n        list.each do |subscriber|\n          invoke_callback(subscriber, message)\n        end\n      end\n    end\n  end\nend\n```\n\n### \u3053\u308c\u306f\u3053\u308c\u3067\u3059\n\n```\n@subscribers = Hash.new { |h,k| h[k] = [] } # => {}\n@subscribers['channel'].dup                 # => []\n@subscribers                                # => {\"channel\"=>[]}\n```\n\n\n\n# \u304a\u308f\u308a\n\n\u3068\u3044\u3063\u305f\u3088\u3046\u306b\u3001\u8272\u3005\u3068\u624b\u3092\u7a81\u3063\u8fbc\u3093\u3060\u308a\u3057\u3066\u307f\u307e\u3057\u305f\u3002\n\n\u81ea\u5206\u304c\u3053\u3046\u3057\u305f\u307b\u3046\u304c\u3044\u3044\u306a\u3001\u3068\u601d\u3063\u305f\u3088\u3046\u306b\u5b9f\u88c5\u3057\u3088\u3046\u3068\u3059\u308b\u3068\u3001example\u306a\u3069\u304b\u3089\u306f\u898b\u3048\u3066\u3053\u306a\u304b\u3063\u305f\u90e8\u5206\u304c\u898b\u3048\u305f\u308a\u3001\u898b\u3048\u306a\u3044\u90e8\u5206\u3092\u3055\u304c\u3057\u305f\u308a\u3057\u3066\u3001\u52c9\u5f37\u306b\u306a\u308b\u306a\u3068\u601d\u3044\u307e\u3059\u3002\n\n\u3053\u308c\u3092\u66f8\u3044\u3066\u308b\u9014\u4e2d\u306b\u3082\u3001\u3053\u308c\u306f\u3069\u3046\u306a\u306e\uff1f\u307f\u305f\u3044\u306a\u611f\u3058\u3067\u8272\u3005\u3084\u3063\u3066\u307f\u3066\u306a\u308b\u307b\u3069\u301c\u3068\u3044\u3046\u306e\u304c\u3042\u3063\u305f\u306e\u3067\u3088\u304b\u3063\u305f\u3067\u3059\u3002\n", "tags": ["Rails", "ActionCable", "React", "JavaScript"]}