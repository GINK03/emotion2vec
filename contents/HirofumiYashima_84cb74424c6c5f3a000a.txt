{"context": " More than 1 year has passed since last update.\n\n\u3010 \u53c2\u8003\u30a6\u30a7\u30d6\u30b5\u30a4\u30c8 \u3011\n\n\n \uff08\uff11\uff09Yahoo \u77e5\u6075\u888b\u8cea\u554f\u300cSQL\u306e\u8cea\u554f\u3067\u3059\u3002\u9023\u7d9a\u30ed\u30b0\u30a4\u30f3\u30e6\u30fc\u30b6\u3092\u62bd\u51fa\u3057\u305f\u300d\n\n \uff08\uff12\uff09Hatena Blog 1bit! \u300c\u3010SQL\u3011EXISTS\u53e5\u306e\u4e2d\u306f\"SELECT *\" \u304b\"SELECT 1\"\u304b\u300d\n\n\n\n\u53c2\u8003\u30a6\u30a7\u30d6\u30b5\u30a4\u30c8\uff08\uff11\uff09\u306b\u3042\u308b\u3088\u3046\u306b\u3001\u4ee5\u4e0b\u306e\u30af\u30a8\u30ea\u3067\u30e6\u30fc\u30b6ID\u30ea\u30b9\u30c8\u3092\u53d6\u5f97\u3067\u304d\u308b\u3002\n\n\n\u76f8\u95a2\u30b5\u30d6\u30af\u30a8\u30ea\uff08\u81ea\u5df1\u7d50\u5408\uff09\u3067\u3001\u300c\uff11\u65e5\u5f8c\u30fb\uff12\u65e5\u5f8c \uff5e \uff14\u65e5\u5f8c \u306e\uff08\u30ed\u30b0\u30a4\u30f3\uff09\u30ec\u30b3\u30fc\u30c9 \u304c \u5b58\u5728\u3059\u308b\u3068\u3044\u3046\u6761\u4ef6\u300d\uff08where\u53e5\uff09\u3092\u6e80\u305f\u3059\u30ec\u30b3\u30fc\u30c9 \u306e user_id\u5217 \u3092 \u53d6\u5f97\n\n\u4ee5\u4e0b\u306e\u30af\u30a8\u30ea\u3092\u5b9f\u884c\u3059\u308b\u3068\u3001\u9023\u7d9a\u30ed\u30b0\u30a4\u30f3\u521d\u65e5\u306e\u65e5\u4ed8\u306f\u554f\u308f\u305a\u3001\u904e\u53bb\u3001\uff11\u56de\u3067\u3082\u300c\u9023\u7d9a\uff15\u65e5\u9593 \u30ed\u30b0\u30a4\u30f3\u3057\u305f\u300d\u671f\u9593\uff08\uff15\u65e5\u9593\uff09\u304c\u3042\u308b user_id \u304c\u8fd4\u3063\u3066\u304f\u308b\u3002\n\n\uff08 \u4e3b\u554f\u3044\u5408\u308f\u305b\u6587\u306e SELECT \u53e5\u306b\u3001date\uff08\u30ed\u30b0\u30a4\u30f3\u65e5\uff09\u3092\u8ffd\u52a0\u3059\u308b\u3068\u3001\u540c\u4e00\u306e user_id \u3067\u3001\uff12\u4ef6\u4ee5\u4e0a\u306e\u300c\u9023\u7d9a\uff15\u65e5\u9593\u300d\u65e5\u4ed8\u304c\u8fd4\u3055\u308c\u308b\u30e6\u30fc\u30b6\u304c\u3067\u3066\u304d\u307e\u3059\uff08\uff12\u56de\u4ee5\u4e0a\u3001\u9023\u7d9a\uff15\u65e5\u9593\u30ed\u30b0\u30a4\u30f3\u3057\u305f\u30e6\u30fc\u30b6\u304c\u3044\u308b\u5834\u5408\uff09\uff09\n\n\n\n\nSQL\nSELECT distinct user_id\nFROM tb tb1\nWHERE EXISTS\n( SELECT * \n  FROM tb tb2\n  WHERE tb1.user_id=tb2.user_id\n  and tb1.date = tb2.date + 1 )\nAND EXISTS\n( SELECT * from tb tb3\n  WHERE tb1.user_id = tb3.user_id\n  and tb1.date = tb3.date + 2 )\nAND EXISTS\n( SELECT * from tb tb4\n  WHERE tb1.user_id = tb4.user_id\n  and tb1.date = tb4.date + 3 )\nAND EXISTS\n( SELECT * from tb tb5\n  WHERE tb1.user_id = tb5.user_id\n  and tb1.date = tb5.date + 4 )\n;\n\n\n\n\n\u300c\u30e6\u30fc\u30b6\u65b0\u898f\u6d41\u5165\u65e5\u300d\u306b\u30ed\u30b0\u30a4\u30f3\u3057 \u4e14\u3064 \u300c\u9023\u7d9a\uff15\u65e5\u9593\u30ed\u30b0\u30a4\u30f3\u300d\u3057\u305f\uff35\uff35\u3092\u8abf\u3079\u308b\u5834\u5408\n\n\n\u203b \u300c\u9023\u7d9a\uff15\u65e5\u9593\u30ed\u30b0\u30a4\u30f3\u300d\u306e\u521d\u65e5\u304c\u300c\u65b0\u898f\u6d41\u5165\u65e5\uff08\u5f53\u65e5\uff09\u300d\n\n\n\u3010 Case \uff11 \u3011\n\n\n\u30c6\u30fc\u30d6\u30eb\u306b\u3001create_date\uff1a\u300c\u6d41\u5165\u65e5\u300d \u30ab\u30e9\u30e0\u304c\u3042\u308b\u5834\u5408\n\n\nSQL2\nSELECT distinct user_id\nFROM tb tb1\nWHERE EXISTS\n( SELECT * \n  FROM tb tb2\n  WHERE tb1.user_id = tb2.user_id\n  and tb1.create_date + 1 = tb2.date)\nAND EXISTS\n( SELECT * from tb tb3\n  WHERE tb1.user_id = tb3.user_id\n  and tb1.create_date + 2 = tb3.date)\nAND EXISTS\n( SELECT * from tb tb4\n  WHERE tb1.user_id = tb4.user_id\n  and tb1.create_date + 3 = tb4.date)\nAND EXISTS\n( SELECT * from tb tb5\n  WHERE tb1.user_id = tb5.user_id\n  and tb1.create_date + 4 = tb5.date)\n;\n\n\n\n\n\u3010 Case 2 \u3011\n\n\n\u30c6\u30fc\u30d6\u30eb\u306b\u3001create_date\uff1a\u300c\u6d41\u5165\u65e5\u300d \u30ab\u30e9\u30e0 \u304c \u306a\u3044 \u5834\u5408\n\n\u6d41\u5165\u65e5\u304c\u306a\u3044\u3068\u304d\u306f\u3001\n-1 \uff09With\u53e5\u5185\u3067\u3001\u300cuser_id \u3067 group by \u3057\u3066\u3001min(date) as create_date \u3067 \u521d\u56de\u30ed\u30b0\u30a4\u30f3\u65e5\uff08\uff1d\u65b0\u898f\u6d41\u5165\u65e5\uff09\u5217\u300d\u3092\u751f\u6210\u5f8c\u3001\n-2\uff09 \u5143\u306e\u30c6\u30fc\u30d6\u30eb \u3068 join \u3057\u3066\u3001\n-3\uff09\u300c\u65b0\u898f\u6d41\u5165\u65e5\u300d\u3068\u300c\u5404\u30ed\u30b0\u30a4\u30f3\u65e5\u300d\u30ab\u30e9\u30e0\u306e\u4e21\u65b9\u3092\u3082\u3064\u30c6\u30fc\u30d6\u30eb\u3092\u4f5c\u6210\u3059\u308b\u3002\n\ncreate_table.sql\nWITH temp_1 AS (\nSELECT user_id, min(date) as create_date\nFROM user_event_log \nGROUP BY user_id\n), temp_2 AS (\nSELECT temp_1.create_date, \n       original_tbl.*\nFROM temp_1\njoin\nuser_event_log original_tbl\non temp_1.user_id = original_tbl.user_id and temp_1.create_date = original_tbl.date\n)\nselect *\nfrom temp_2\norder by user_id\n;\n\n\n\u4f5c\u6210\u3057\u305f\u30c6\u30fc\u30d6\u30eb\u306b\u5bfe\u3057\u3066\u3001\u3055\u304d\u307b\u3069\u306e\u30af\u30a8\u30ea\u3092\u5b9f\u884c\u3059\u308c\u3070\u3001\uff2f\uff2b\n\nSQL4\nWITH temp_1 AS (\nSELECT user_id, min(date) as create_date\nFROM user_event_log \nGROUP BY user_id\n), master AS (\nSELECT original_tbl.user_id,\n       temp_1.create_date,\n       original_tbl.date\nFROM temp_1\njoin\nuser_event_log original_tbl\non temp_1.user_id = original_tbl.user_id\n)\nselect distinct user_id\nfrom master\nWHERE EXISTS\n( SELECT * \n  FROM master copy\n  WHERE master.user_id = copy.user_id\n        and master.create_date + 1 = copy.date \n)\nAND EXISTS\n( SELECT * \n  FROM master copy\n  WHERE master.user_id = copy.user_id\n        and master.create_date + 2 = copy.date \n)\nAND EXISTS\n( SELECT * \n  FROM master copy\n  WHERE master.user_id = copy.user_id\n        and master.create_date + 3 = copy.date \n)\nAND EXISTS\n( SELECT * \n  FROM master copy\n  WHERE master.user_id = copy.user_id\n        and master.create_date + 4 = copy.date \n)\norder by user_id, date\n;\n\n\n\n\n\u30ed\u30b0\u30a4\u30f3\u65e5\uff08 date \uff09\u5217 \u304c\u3001\u79d2\u5358\u4f4d\u306e\u30c7\u30fc\u30bf\u5f62\u5f0f \u3067\u3042\u308b \u5834\u5408\uff08\u4f8b\uff1a\u30ab\u30e9\u30e0\u540d datetime\uff09\n\nAWS Redshift\u306e\u5834\u5408\u306f\u3001date_trunc('day', datetime\uff09 \u95a2\u6570\u3067\u3001\u65e5\u6b21\u5358\u4f4d\u306e\u7c92\u5ea6\u306b\u5909\u63db\u3059\u308c\u3070\uff2f\uff2b\n\nSQL4\nWITH temp_1 AS (\nSELECT user_id, min(DATE_TRUNC('day', datetime)) as create_date\nFROM user_event_log \nGROUP BY user_id\n), master AS (\nSELECT original_tbl.user_id,\n       temp_1.create_date, \n       date_trunc('day', original_tbl.datetime) as date       \nFROM temp_1\njoin\nuser_event_log original_tbl\non temp_1.user_id = original_tbl.user_id\n)\nselect distinct user_id\nfrom master\nWHERE EXISTS\n( SELECT * \n  FROM master copy\n  WHERE master.user_id = copy.user_id\n        and master.create_date + 1 = copy.date \n)\nAND EXISTS\n( SELECT * \n  FROM master copy\n  WHERE master.user_id = copy.user_id\n        and master.create_date + 2 = copy.date \n)\nAND EXISTS\n( SELECT * \n  FROM master copy\n  WHERE master.user_id = copy.user_id\n        and master.create_date + 3 = copy.date \n)\nAND EXISTS\n( SELECT * \n  FROM master copy\n  WHERE master.user_id = copy.user_id\n        and master.create_date + 4 = copy.date \n)\norder by user_id, date\n;\n\n\n\n\u3010 \u8ffd\u8a18 \u3011\n\n\u65b0\u898f\u6d41\u5165\u65e5 \u304b\u3089\u3000\uff14\u65e5\u4ee5\u4e0a\u7d4c\u904e\u3057\u3066\u3044\u306a\u3044 UU \u306f\u3001\u6bce\u65e5\u30ed\u30b0\u30a4\u30f3\u3057\u3066\u3044\u3066\u3082 FQ5 \u306b\u306a\u308a\u3048\u306a\u3044\u3002\n\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u3001\u4e3b\u554f\u3044\u5408\u308f\u305b\u6587 \u306e where\u53e5\u306b\u3001\u300c\u4eca\u65e5\u306e\u65e5\u4ed8\u300d\uff0d\u300c\u65b0\u898f\u6d41\u5165\u65e5\u300d>= 4 \u6761\u4ef6\u3092\u8ffd\u52a0\u3057\u305f\u65b9\u304c\u3088\u3044\u3002 \n\nAWS Redshift\u306e\u5834\u5408\u3001date_trunc('day', getdate()) AS present_date \u3067\u3001\u30af\u30a8\u30ea\u767a\u884c\u6642\u70b9\u306e\u4eca\u65e5\u306e\u65e5\u4ed8\u3092\u53d6\u5f97\n\n\nSQL4\nWITH temp_1 AS (\nSELECT user_id, min(DATE_TRUNC('day', datetime)) as create_date\nFROM user_event_log \nGROUP BY user_id\n), master AS (\nSELECT original_tbl.user_id,\n       temp_1.create_date, \n       date_trunc('day', original_tbl.datetime) as date,\n       date_trunc('day', getdate()) as present_date\nFROM temp_1\njoin\nuser_event_log original_tbl\non temp_1.user_id = original_tbl.user_id\n)\nselect distinct user_id\nfrom master\nWHERE (present_date - create_date) >= 4\nAND EXISTS\n( SELECT * \n  FROM master copy\n  WHERE master.user_id = copy.user_id\n        and master.create_date + 1 = copy.date \n)\nAND EXISTS\n( SELECT * \n  FROM master copy\n  WHERE master.user_id = copy.user_id\n        and master.create_date + 2 = copy.date \n)\nAND EXISTS\n( SELECT * \n  FROM master copy\n  WHERE master.user_id = copy.user_id\n        and master.create_date + 3 = copy.date \n)\nAND EXISTS\n( SELECT * \n  FROM master copy\n  WHERE master.user_id = copy.user_id\n        and master.create_date + 4 = copy.date \n)\norder by user_id, date\n;\n\n\n### __\u3010 \u53c2\u8003\u30a6\u30a7\u30d6\u30b5\u30a4\u30c8 \u3011__\n\n*  [\uff08\uff11\uff09Yahoo \u77e5\u6075\u888b\u8cea\u554f\u300cSQL\u306e\u8cea\u554f\u3067\u3059\u3002\u9023\u7d9a\u30ed\u30b0\u30a4\u30f3\u30e6\u30fc\u30b6\u3092\u62bd\u51fa\u3057\u305f\u300d](http://detail.chiebukuro.yahoo.co.jp/qa/question_detail/q14112409454)\n*  [\uff08\uff12\uff09Hatena Blog 1bit! \u300c\u3010SQL\u3011EXISTS\u53e5\u306e\u4e2d\u306f\"SELECT *\" \u304b\"SELECT 1\"\u304b\u300d](http://sakuramochi702.hatenablog.com/entry/2013/09/03/114403)\n\n### __\u53c2\u8003\u30a6\u30a7\u30d6\u30b5\u30a4\u30c8\uff08\uff11\uff09\u306b\u3042\u308b\u3088\u3046\u306b\u3001\u4ee5\u4e0b\u306e\u30af\u30a8\u30ea\u3067\u30e6\u30fc\u30b6ID\u30ea\u30b9\u30c8\u3092\u53d6\u5f97\u3067\u304d\u308b\u3002__\n\n* \u76f8\u95a2\u30b5\u30d6\u30af\u30a8\u30ea\uff08\u81ea\u5df1\u7d50\u5408\uff09\u3067\u3001\u300c\uff11\u65e5\u5f8c\u30fb\uff12\u65e5\u5f8c \uff5e \uff14\u65e5\u5f8c \u306e\uff08\u30ed\u30b0\u30a4\u30f3\uff09\u30ec\u30b3\u30fc\u30c9 \u304c \u5b58\u5728\u3059\u308b\u3068\u3044\u3046\u6761\u4ef6\u300d\uff08_where_\u53e5\uff09\u3092\u6e80\u305f\u3059\u30ec\u30b3\u30fc\u30c9 \u306e **user_id**\u5217 \u3092 \u53d6\u5f97\n* __\u4ee5\u4e0b\u306e\u30af\u30a8\u30ea\u3092\u5b9f\u884c\u3059\u308b\u3068\u3001*\u9023\u7d9a\u30ed\u30b0\u30a4\u30f3\u521d\u65e5\u306e\u65e5\u4ed8\u306f\u554f\u308f\u305a*\u3001\u904e\u53bb\u3001\uff11\u56de\u3067\u3082\u300c\u9023\u7d9a\uff15\u65e5\u9593 \u30ed\u30b0\u30a4\u30f3\u3057\u305f\u300d\u671f\u9593\uff08\uff15\u65e5\u9593\uff09\u304c\u3042\u308b user_id \u304c\u8fd4\u3063\u3066\u304f\u308b\u3002__\n    * \uff08 \u4e3b\u554f\u3044\u5408\u308f\u305b\u6587\u306e SELECT \u53e5\u306b\u3001date\uff08\u30ed\u30b0\u30a4\u30f3\u65e5\uff09\u3092\u8ffd\u52a0\u3059\u308b\u3068\u3001\u540c\u4e00\u306e user_id \u3067\u3001\uff12\u4ef6\u4ee5\u4e0a\u306e\u300c\u9023\u7d9a\uff15\u65e5\u9593\u300d\u65e5\u4ed8\u304c\u8fd4\u3055\u308c\u308b\u30e6\u30fc\u30b6\u304c\u3067\u3066\u304d\u307e\u3059\uff08\uff12\u56de\u4ee5\u4e0a\u3001\u9023\u7d9a\uff15\u65e5\u9593\u30ed\u30b0\u30a4\u30f3\u3057\u305f\u30e6\u30fc\u30b6\u304c\u3044\u308b\u5834\u5408\uff09\uff09\n\n````{SQL:SQL}\nSELECT distinct user_id\nFROM tb tb1\nWHERE EXISTS\n( SELECT * \n  FROM tb tb2\n  WHERE tb1.user_id=tb2.user_id\n  and tb1.date = tb2.date + 1 )\nAND EXISTS\n( SELECT * from tb tb3\n  WHERE tb1.user_id = tb3.user_id\n  and tb1.date = tb3.date + 2 )\nAND EXISTS\n( SELECT * from tb tb4\n  WHERE tb1.user_id = tb4.user_id\n  and tb1.date = tb4.date + 3 )\nAND EXISTS\n( SELECT * from tb tb5\n  WHERE tb1.user_id = tb5.user_id\n  and tb1.date = tb5.date + 4 )\n;\n```\n____\n\n# __\u300c\u30e6\u30fc\u30b6\u65b0\u898f\u6d41\u5165\u65e5\u300d\u306b\u30ed\u30b0\u30a4\u30f3\u3057 \u4e14\u3064 \u300c\u9023\u7d9a\uff15\u65e5\u9593\u30ed\u30b0\u30a4\u30f3\u300d\u3057\u305f\uff35\uff35\u3092\u8abf\u3079\u308b\u5834\u5408__\n### __\u203b \u300c\u9023\u7d9a\uff15\u65e5\u9593\u30ed\u30b0\u30a4\u30f3\u300d\u306e\u521d\u65e5\u304c\u300c\u65b0\u898f\u6d41\u5165\u65e5\uff08\u5f53\u65e5\uff09\u300d__\n\n\n####__\u3010 Case \uff11 \u3011__\n####__\u30c6\u30fc\u30d6\u30eb\u306b\u3001**create_date\uff1a\u300c\u6d41\u5165\u65e5\u300d** \u30ab\u30e9\u30e0\u304c\u3042\u308b\u5834\u5408__\n\n````{SQL:SQL2}\nSELECT distinct user_id\nFROM tb tb1\nWHERE EXISTS\n( SELECT * \n  FROM tb tb2\n  WHERE tb1.user_id = tb2.user_id\n  and tb1.create_date + 1 = tb2.date)\nAND EXISTS\n( SELECT * from tb tb3\n  WHERE tb1.user_id = tb3.user_id\n  and tb1.create_date + 2 = tb3.date)\nAND EXISTS\n( SELECT * from tb tb4\n  WHERE tb1.user_id = tb4.user_id\n  and tb1.create_date + 3 = tb4.date)\nAND EXISTS\n( SELECT * from tb tb5\n  WHERE tb1.user_id = tb5.user_id\n  and tb1.create_date + 4 = tb5.date)\n;\n```\n____\n\n####__\u3010 Case 2 \u3011__\n####__\u30c6\u30fc\u30d6\u30eb\u306b\u3001**create_date\uff1a\u300c\u6d41\u5165\u65e5\u300d** \u30ab\u30e9\u30e0 \u304c \u306a\u3044 \u5834\u5408__\n\n__\u6d41\u5165\u65e5\u304c\u306a\u3044\u3068\u304d\u306f\u3001__\n\n-1 \uff09With\u53e5\u5185\u3067\u3001\u300cuser_id \u3067 group by \u3057\u3066\u3001min(date) as create_date \u3067 \u521d\u56de\u30ed\u30b0\u30a4\u30f3\u65e5\uff08\uff1d\u65b0\u898f\u6d41\u5165\u65e5\uff09\u5217\u300d\u3092\u751f\u6210\u5f8c\u3001\n-2\uff09 \u5143\u306e\u30c6\u30fc\u30d6\u30eb \u3068 join \u3057\u3066\u3001\n-3\uff09\u300c\u65b0\u898f\u6d41\u5165\u65e5\u300d\u3068\u300c\u5404\u30ed\u30b0\u30a4\u30f3\u65e5\u300d\u30ab\u30e9\u30e0\u306e\u4e21\u65b9\u3092\u3082\u3064\u30c6\u30fc\u30d6\u30eb\u3092\u4f5c\u6210\u3059\u308b\u3002\n\n````{SQL:create_table.sql}\nWITH temp_1 AS (\nSELECT user_id, min(date) as create_date\nFROM user_event_log \nGROUP BY user_id\n), temp_2 AS (\nSELECT temp_1.create_date, \n       original_tbl.*\nFROM temp_1\njoin\nuser_event_log original_tbl\non temp_1.user_id = original_tbl.user_id and temp_1.create_date = original_tbl.date\n)\nselect *\nfrom temp_2\norder by user_id\n;\n```\n\n__\u4f5c\u6210\u3057\u305f\u30c6\u30fc\u30d6\u30eb\u306b\u5bfe\u3057\u3066\u3001\u3055\u304d\u307b\u3069\u306e\u30af\u30a8\u30ea\u3092\u5b9f\u884c\u3059\u308c\u3070\u3001\uff2f\uff2b__\n\n````{SQL:SQL4}\nWITH temp_1 AS (\nSELECT user_id, min(date) as create_date\nFROM user_event_log \nGROUP BY user_id\n), master AS (\nSELECT original_tbl.user_id,\n       temp_1.create_date,\n       original_tbl.date\nFROM temp_1\njoin\nuser_event_log original_tbl\non temp_1.user_id = original_tbl.user_id\n)\nselect distinct user_id\nfrom master\nWHERE EXISTS\n( SELECT * \n  FROM master copy\n  WHERE master.user_id = copy.user_id\n        and master.create_date + 1 = copy.date \n)\nAND EXISTS\n( SELECT * \n  FROM master copy\n  WHERE master.user_id = copy.user_id\n        and master.create_date + 2 = copy.date \n)\nAND EXISTS\n( SELECT * \n  FROM master copy\n  WHERE master.user_id = copy.user_id\n        and master.create_date + 3 = copy.date \n)\nAND EXISTS\n( SELECT * \n  FROM master copy\n  WHERE master.user_id = copy.user_id\n        and master.create_date + 4 = copy.date \n)\norder by user_id, date\n;\n```\n\n___\n\n\n#### __\u30ed\u30b0\u30a4\u30f3\u65e5\uff08 **date** \uff09\u5217 \u304c\u3001\u79d2\u5358\u4f4d\u306e\u30c7\u30fc\u30bf\u5f62\u5f0f \u3067\u3042\u308b \u5834\u5408\uff08\u4f8b\uff1a\u30ab\u30e9\u30e0\u540d **datetime**\uff09__\n __AWS Redshift\u306e\u5834\u5408\u306f\u3001**date_trunc('day', datetime\uff09** \u95a2\u6570\u3067\u3001\u65e5\u6b21\u5358\u4f4d\u306e\u7c92\u5ea6\u306b\u5909\u63db\u3059\u308c\u3070\uff2f\uff2b__\n\n````{SQL:SQL4}\nWITH temp_1 AS (\nSELECT user_id, min(DATE_TRUNC('day', datetime)) as create_date\nFROM user_event_log \nGROUP BY user_id\n), master AS (\nSELECT original_tbl.user_id,\n       temp_1.create_date, \n       date_trunc('day', original_tbl.datetime) as date       \nFROM temp_1\njoin\nuser_event_log original_tbl\non temp_1.user_id = original_tbl.user_id\n)\nselect distinct user_id\nfrom master\nWHERE EXISTS\n( SELECT * \n  FROM master copy\n  WHERE master.user_id = copy.user_id\n        and master.create_date + 1 = copy.date \n)\nAND EXISTS\n( SELECT * \n  FROM master copy\n  WHERE master.user_id = copy.user_id\n        and master.create_date + 2 = copy.date \n)\nAND EXISTS\n( SELECT * \n  FROM master copy\n  WHERE master.user_id = copy.user_id\n        and master.create_date + 3 = copy.date \n)\nAND EXISTS\n( SELECT * \n  FROM master copy\n  WHERE master.user_id = copy.user_id\n        and master.create_date + 4 = copy.date \n)\norder by user_id, date\n;\n```\n\n# __\u3010 \u8ffd\u8a18 \u3011__\n\n__\u65b0\u898f\u6d41\u5165\u65e5 \u304b\u3089\u3000\uff14\u65e5\u4ee5\u4e0a\u7d4c\u904e\u3057\u3066\u3044\u306a\u3044 UU \u306f\u3001\u6bce\u65e5\u30ed\u30b0\u30a4\u30f3\u3057\u3066\u3044\u3066\u3082 FQ5 \u306b\u306a\u308a\u3048\u306a\u3044\u3002__\n\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u3001\u4e3b\u554f\u3044\u5408\u308f\u305b\u6587 \u306e **where\u53e5**\u306b\u3001**\u300c\u4eca\u65e5\u306e\u65e5\u4ed8\u300d\uff0d\u300c\u65b0\u898f\u6d41\u5165\u65e5\u300d>= 4** \u6761\u4ef6\u3092\u8ffd\u52a0\u3057\u305f\u65b9\u304c\u3088\u3044\u3002 \n\n* AWS Redshift\u306e\u5834\u5408\u3001date_trunc('day', getdate()) AS present_date \u3067\u3001\u30af\u30a8\u30ea\u767a\u884c\u6642\u70b9\u306e\u4eca\u65e5\u306e\u65e5\u4ed8\u3092\u53d6\u5f97\n\n````{SQL:SQL4}\nWITH temp_1 AS (\nSELECT user_id, min(DATE_TRUNC('day', datetime)) as create_date\nFROM user_event_log \nGROUP BY user_id\n), master AS (\nSELECT original_tbl.user_id,\n       temp_1.create_date, \n       date_trunc('day', original_tbl.datetime) as date,\n       date_trunc('day', getdate()) as present_date\nFROM temp_1\njoin\nuser_event_log original_tbl\non temp_1.user_id = original_tbl.user_id\n)\nselect distinct user_id\nfrom master\nWHERE (present_date - create_date) >= 4\nAND EXISTS\n( SELECT * \n  FROM master copy\n  WHERE master.user_id = copy.user_id\n        and master.create_date + 1 = copy.date \n)\nAND EXISTS\n( SELECT * \n  FROM master copy\n  WHERE master.user_id = copy.user_id\n        and master.create_date + 2 = copy.date \n)\nAND EXISTS\n( SELECT * \n  FROM master copy\n  WHERE master.user_id = copy.user_id\n        and master.create_date + 3 = copy.date \n)\nAND EXISTS\n( SELECT * \n  FROM master copy\n  WHERE master.user_id = copy.user_id\n        and master.create_date + 4 = copy.date \n)\norder by user_id, date\n;\n```\n", "tags": ["SQL", "\u30c7\u30fc\u30bf\u5206\u6790", "\u30de\u30fc\u30b1\u30c6\u30a3\u30f3\u30b0", "\u30a2\u30af\u30bb\u30b9\u89e3\u6790", "\u30b9\u30de\u30db\u30b2\u30fc\u30e0"]}