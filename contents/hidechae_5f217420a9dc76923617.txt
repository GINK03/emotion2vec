{"context": " More than 1 year has passed since last update.\n\n\u306f\u3058\u3081\u306b\nActiveRecord\u3067MySQL\u306eview\u306binsert\u3092\u304b\u3051\u3088\u3046\u3068\u3057\u305f\u6642\u306b\u56f0\u3063\u305f\u306e\u3067\u30e1\u30e2\n\nview\u3092\u4f7f\u3046\u3088\u3046\u306b\u8a2d\u5b9a\u3059\u308b\nusers \u30c6\u30fc\u30d6\u30eb\u304b\u3089 view_users \u3068\u3044\u3046view\u3092\u4f5c\u308a\u3001ActiveRecord\u304b\u3089\u53c2\u7167\u3059\u308b\u3088\u3046\u306b\u8a2d\u5b9a\u3059\u308b\nCREATE VIEW view_users AS SELECT * from users;\n\nclass User < ActiveRecord::Base\n  self.primary_key = :id\n  self.table_name = \"view_users\"\nend\n\n\ncreate\u3057\u305finstance\u306eid\u304c0\u306b\u306a\u308b\npry(main) > User.create(name: 'hoge')\n=> #<User: 0x007fc91201c150\n id: 0,\n name: \"hoge\",\n created_at: Sun, 10 Jan 2016 13:23:03 UTC +00:00,\n updated_at: Sun, 10 Jan 2016 13:23:03 UTC +00:00>\n\n\n\u3069\u3053\u3067id\u3092\u8a2d\u5b9a\u3057\u3066\u3044\u308b\u304b\ndef _create_record(attribute_names = self.attribute_names)\n  attributes_values = arel_attributes_with_values_for_create(attribute_names)\n\n  new_id = self.class.unscoped.insert attributes_values\n  self.id ||= new_id if self.class.primary_key\n\n  @new_record = false\n  id\nend\n\nhttps://github.com/rails/rails/blob/master/activerecord/lib/active_record/persistence.rb#L554\nprimary_key \u304c\u5b58\u5728\u3059\u308b\u3001\u304b\u3064 self.id \u304c\u30bb\u30c3\u30c8\u3055\u308c\u3066\u3044\u306a\u3044\u5834\u5408\u306b id \u304c\u8a2d\u5b9a\u3055\u308c\u308b\n\u3053\u306e id \u306f\u3001 LAST_INSERT_ID() \u304c\u8a2d\u5b9a\u3055\u308c\u308b\n\n\u305d\u3082\u305d\u3082\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u521d\u671f\u5316\u6642\u306b id = 0 \u3068\u306a\u3063\u3066\u3044\u308b\npry(main) > User.new(name: 'hoge')\n=> #<User: 0x007fc90f201db0\n id: 0,\n name: \"hoge\",\n created_at: Sun, 10 Jan 2016 13:23:03 UTC +00:00,\n updated_at: Sun, 10 Jan 2016 13:23:03 UTC +00:00>\n\n\nMySQL\u306e\u30c7\u30d5\u30a9\u30eb\u30c8\u5024\u304c0\u306b\u306a\u3063\u3066\u3044\u308b\n\u30aa\u30ea\u30b8\u30ca\u30eb\u306e\u30c6\u30fc\u30d6\u30eb\u306e id \u306e\u5b9a\u7fa9\u306f default null \u3068\u306a\u3063\u3066\u3044\u308b\u304c\u3001view\u3067\u306f default 0 \u3068\u306a\u3063\u3066\u3044\u308b\nroot@localhost [paynote_development] > desc users;\n+--------------------+--------------+------+-----+---------+----------------+\n| Field              | Type         | Null | Key | Default | Extra          |\n+--------------------+--------------+------+-----+---------+----------------+\n| id                 | int(11)      | NO   | PRI | NULL    | auto_increment |\n| name               | varchar(255) | YES  |     | NULL    |                |\n| created_at         | datetime     | NO   |     | NULL    |                |\n| updated_at         | datetime     | NO   |     | NULL    |                |\n+--------------------+--------------+------+-----+---------+----------------+\n10 rows in set (0.00 sec)\n\nroot@localhost [paynote_development] > desc view_users;\n+--------------------+--------------+------+-----+---------+-------+\n| Field              | Type         | Null | Key | Default | Extra |\n+--------------------+--------------+------+-----+---------+-------+\n| id                 | int(11)      | NO   |     | 0       |       |\n| name               | varchar(255) | YES  |     | NULL    |       |\n| created_at         | datetime     | NO   |     | NULL    |       |\n| updated_at         | datetime     | NO   |     | NULL    |       |\n+--------------------+--------------+------+-----+---------+-------+\n10 rows in set (0.00 sec)\n\n\n\u89e3\u6c7a\u6cd5\n\u7dba\u9e97\u306a\u89e3\u6c7a\u6cd5\u304b\u5206\u304b\u3089\u306a\u3044\u304c\u3001\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u751f\u6210\u6642\u306b id \u3092\u4fee\u6b63\u3059\u308c\u3070\u826f\u3044\nclass User < ActiveRecord::Base\n  self.primary_key = :id\n  self.table_name = \"view_users\"\n  after_initialize :fix_id\n\n  def fix_id\n    self.id = nil if self.id == 0\n  end\nend\n\n# \u306f\u3058\u3081\u306b\nActiveRecord\u3067MySQL\u306eview\u306binsert\u3092\u304b\u3051\u3088\u3046\u3068\u3057\u305f\u6642\u306b\u56f0\u3063\u305f\u306e\u3067\u30e1\u30e2\n\n# view\u3092\u4f7f\u3046\u3088\u3046\u306b\u8a2d\u5b9a\u3059\u308b\n`users` \u30c6\u30fc\u30d6\u30eb\u304b\u3089 `view_users` \u3068\u3044\u3046view\u3092\u4f5c\u308a\u3001ActiveRecord\u304b\u3089\u53c2\u7167\u3059\u308b\u3088\u3046\u306b\u8a2d\u5b9a\u3059\u308b\n\n```sql\nCREATE VIEW view_users AS SELECT * from users;\n```\n\n```rb\nclass User < ActiveRecord::Base\n  self.primary_key = :id\n  self.table_name = \"view_users\"\nend\n```\n\n# create\u3057\u305finstance\u306eid\u304c0\u306b\u306a\u308b\n\n```rb\npry(main) > User.create(name: 'hoge')\n=> #<User: 0x007fc91201c150\n id: 0,\n name: \"hoge\",\n created_at: Sun, 10 Jan 2016 13:23:03 UTC +00:00,\n updated_at: Sun, 10 Jan 2016 13:23:03 UTC +00:00>\n```\n\n# \u3069\u3053\u3067id\u3092\u8a2d\u5b9a\u3057\u3066\u3044\u308b\u304b\n```rb\ndef _create_record(attribute_names = self.attribute_names)\n  attributes_values = arel_attributes_with_values_for_create(attribute_names)\n\n  new_id = self.class.unscoped.insert attributes_values\n  self.id ||= new_id if self.class.primary_key\n\n  @new_record = false\n  id\nend\n```\nhttps://github.com/rails/rails/blob/master/activerecord/lib/active_record/persistence.rb#L554\n\n`primary_key` \u304c\u5b58\u5728\u3059\u308b\u3001\u304b\u3064 `self.id` \u304c\u30bb\u30c3\u30c8\u3055\u308c\u3066\u3044\u306a\u3044\u5834\u5408\u306b `id` \u304c\u8a2d\u5b9a\u3055\u308c\u308b\n\u3053\u306e `id` \u306f\u3001 `LAST_INSERT_ID()` \u304c\u8a2d\u5b9a\u3055\u308c\u308b\n\n# \u305d\u3082\u305d\u3082\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u521d\u671f\u5316\u6642\u306b `id = 0` \u3068\u306a\u3063\u3066\u3044\u308b\n\n```rb\npry(main) > User.new(name: 'hoge')\n=> #<User: 0x007fc90f201db0\n id: 0,\n name: \"hoge\",\n created_at: Sun, 10 Jan 2016 13:23:03 UTC +00:00,\n updated_at: Sun, 10 Jan 2016 13:23:03 UTC +00:00>\n```\n\n# MySQL\u306e\u30c7\u30d5\u30a9\u30eb\u30c8\u5024\u304c0\u306b\u306a\u3063\u3066\u3044\u308b\n\u30aa\u30ea\u30b8\u30ca\u30eb\u306e\u30c6\u30fc\u30d6\u30eb\u306e `id` \u306e\u5b9a\u7fa9\u306f `default null` \u3068\u306a\u3063\u3066\u3044\u308b\u304c\u3001view\u3067\u306f `default 0` \u3068\u306a\u3063\u3066\u3044\u308b\n\n```\nroot@localhost [paynote_development] > desc users;\n+--------------------+--------------+------+-----+---------+----------------+\n| Field              | Type         | Null | Key | Default | Extra          |\n+--------------------+--------------+------+-----+---------+----------------+\n| id                 | int(11)      | NO   | PRI | NULL    | auto_increment |\n| name               | varchar(255) | YES  |     | NULL    |                |\n| created_at         | datetime     | NO   |     | NULL    |                |\n| updated_at         | datetime     | NO   |     | NULL    |                |\n+--------------------+--------------+------+-----+---------+----------------+\n10 rows in set (0.00 sec)\n```\n\n```\nroot@localhost [paynote_development] > desc view_users;\n+--------------------+--------------+------+-----+---------+-------+\n| Field              | Type         | Null | Key | Default | Extra |\n+--------------------+--------------+------+-----+---------+-------+\n| id                 | int(11)      | NO   |     | 0       |       |\n| name               | varchar(255) | YES  |     | NULL    |       |\n| created_at         | datetime     | NO   |     | NULL    |       |\n| updated_at         | datetime     | NO   |     | NULL    |       |\n+--------------------+--------------+------+-----+---------+-------+\n10 rows in set (0.00 sec)\n```\n\n# \u89e3\u6c7a\u6cd5\n\u7dba\u9e97\u306a\u89e3\u6c7a\u6cd5\u304b\u5206\u304b\u3089\u306a\u3044\u304c\u3001\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u751f\u6210\u6642\u306b `id` \u3092\u4fee\u6b63\u3059\u308c\u3070\u826f\u3044\n\n```rb\nclass User < ActiveRecord::Base\n  self.primary_key = :id\n  self.table_name = \"view_users\"\n  after_initialize :fix_id\n\n  def fix_id\n    self.id = nil if self.id == 0\n  end\nend\n```\n", "tags": ["ActiveRecord", "MySQL", "view"]}