{"context": " More than 1 year has passed since last update.BigQuery\u306e\u52c9\u5f37\u304c\u3066\u3089\u3001secure\u30ed\u30b0\uff08ssh\u30d5\u30eb\u958b\u653e\uff09\u3092fluentd\u7d4c\u7531\u3067BigQuery\u306bStream Insert\u3067\u3076\u3061\u8fbc\u3093\u3060\u3002\n\u4ee5\u4e0b\u306e\u69cb\u6210\u3067\u4e38\u4e00\u65e5\u653e\u7f6e\u3057\u305f\n\u203b\u9700\u8981\uff08\u30b9\u30c8\u30c3\u30af\uff09\u304c\u3042\u308c\u3070\u3001\u69cb\u7bc9\u624b\u9806\u3082\u516c\u958b\u3057\u307e\u3059\u3002\n\n\u69cb\u6210\n\nCentOS\nfluentd\nfluent-plugin-bigquery(fluentd\u304b\u3089BigQuery\u306b\u8ee2\u9001\u3059\u308b\u30d7\u30e9\u30b0\u30a4\u30f3)\nsshd_config: PermitRootLogin no\nSQL\u77e5\u8b58\u306f\u307b\u307c\u7121\u3044\n\n\n\u7d50\u8ad6\n\n\u4e00\u65e5\u306b\u7d0410\u4e07\u4ef6\u306e\u30ed\u30b0\u304c\u6b8b\u3063\u305f\nroot\u306b\u5bfe\u3059\u308b\u30a2\u30bf\u30c3\u30af\u304c\u5727\u5012\u7684\u306b\u591a\u3044\n\n\nroot\u306e\u30ed\u30b0\u30a4\u30f3\u306f\u7121\u52b9\u5316\u3057\u307e\u3057\u3087\u3046\nroot\u306f\u30d1\u30b9\u30ef\u30fc\u30c9\u3067\u306f\u306a\u304f\u516c\u958b\u9375\u3092\u4f7f\u3044\u307e\u3057\u3087\u3046\n\n\n\u4ed6\u306e\u30e6\u30fc\u30b6\u306b\u5bfe\u3057\u3066\u3082\u8f9e\u66f8\u653b\u6483\u306f\u3055\u308c\u3066\u3044\u308b\u306e\u3067\u3001\u30d1\u30b9\u30ef\u30fc\u30c9\u306f\u9577\u304f\u3001\u3082\u3057\u304f\u306f\u516c\u958b\u9375\u3092\u4f7f\u3044\u307e\u3057\u3087\u3046\n\u305d\u3082\u305d\u3082SSH\u306e\u30d5\u30eb\u958b\u653e\u306f\u3084\u3081\u307e\u3057\u3087\u3046\n\n\n\u5206\u6790\u7d50\u679c\n\n\u7dcf\u4ef6\u6570\n\nSQL\u6587\nSELECT COUNT(*) FROM [your_dataset.your_table]\n\n\n\n\nroot\u306b\u95a2\u3059\u308b\u30ed\u30b0\u96c6\u8a08\n\nSQL\u6587\nSELECT message,COUNT(*) AS COUNT FROM [your_dataset.your_table] where message like '%root%' GROUP BY message ORDER BY COUNT DESC\n\n\n\n\n\u65bd\u884c\u3057\u305f\u30e6\u30fc\u30b6\u540d\n\nSQL\u6587\nSELECT message,COUNT(*) AS COUNT FROM [your_dataset.your_table] where message like 'input_userauth_request: invalid user%' GROUP BY message ORDER BY COUNT desc\n\n\n\n\n\u5931\u6557\u3057\u305fIP\u3068\u30e6\u30fc\u30b6\u540d\n\nSQL\u6587\nSELECT message,COUNT(*) AS COUNT FROM [your_dataset.your_table] where message like 'pam_unix(sshd:auth): authentication failure;%' GROUP BY message ORDER BY COUNT DESC\n\n\n\n\n\u53c2\u8003\n\nfluentd\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\n\n/etc/td-agent/td-agent.conf\n<source>\n  type tail\n  path /var/log/secure\n  tag syslog.secure\n  format syslog\n</source>\n\n<match syslog.secure>\n  type bigquery\n\n  method insert\n\n  auth_method private_key\n  email your_acount@developer.gserviceaccount.com\n  private_key_path /path/to/your_project-id.p12\n\n  project your_project_id\n  dataset your_dataset\n  table your_talbe\n\n  time_format %s\n  time_field time\n  schema_path /path/to/your_schema.json\n</match>\n\n\n\nsecure\u30d5\u30a1\u30a4\u30eb\u306ftd-agent\u30e6\u30fc\u30b6\u304b\u3089\u8aad\u307f\u8fbc\u3081\u308b\u6a29\u9650\u3092\u4ed8\u4e0e\u3059\u308b\n\n\nBigQuery\u7528schema\u30d5\u30a1\u30a4\u30eb\n\n\u4e8b\u524d\u306b\u3053\u306e\u30d5\u30a1\u30a4\u30eb\u3092\u5143\u306bBigQuery\u306e\u30c6\u30fc\u30d6\u30eb\u3092\u4f5c\u6210\u3057\u3066\u304a\u304f\n\n\n/path/to/your_schema.json\n[\n  {\n    \"name\": \"host\",\n    \"type\": \"STRING\"\n  },\n  {\n    \"name\": \"ident\",\n    \"type\": \"STRING\"\n  },\n  {\n    \"name\": \"pid\",\n    \"type\": \"INTEGER\"\n  },\n  {\n    \"name\": \"message\",\n    \"type\": \"STRING\"\n  }\n]\n\n\nBigQuery\u306e\u52c9\u5f37\u304c\u3066\u3089\u3001secure\u30ed\u30b0\uff08ssh\u30d5\u30eb\u958b\u653e\uff09\u3092fluentd\u7d4c\u7531\u3067BigQuery\u306bStream Insert\u3067\u3076\u3061\u8fbc\u3093\u3060\u3002\n\u4ee5\u4e0b\u306e\u69cb\u6210\u3067\u4e38\u4e00\u65e5\u653e\u7f6e\u3057\u305f\n\u203b\u9700\u8981\uff08\u30b9\u30c8\u30c3\u30af\uff09\u304c\u3042\u308c\u3070\u3001\u69cb\u7bc9\u624b\u9806\u3082\u516c\u958b\u3057\u307e\u3059\u3002\n\n# \u69cb\u6210\n- CentOS\n- fluentd\n- fluent-plugin-bigquery(fluentd\u304b\u3089BigQuery\u306b\u8ee2\u9001\u3059\u308b\u30d7\u30e9\u30b0\u30a4\u30f3)\n- sshd_config: PermitRootLogin no\n- SQL\u77e5\u8b58\u306f\u307b\u307c\u7121\u3044\n\n# \u7d50\u8ad6\n- \u4e00\u65e5\u306b\u7d0410\u4e07\u4ef6\u306e\u30ed\u30b0\u304c\u6b8b\u3063\u305f\n- root\u306b\u5bfe\u3059\u308b\u30a2\u30bf\u30c3\u30af\u304c\u5727\u5012\u7684\u306b\u591a\u3044\n\t- root\u306e\u30ed\u30b0\u30a4\u30f3\u306f\u7121\u52b9\u5316\u3057\u307e\u3057\u3087\u3046\n\t- root\u306f\u30d1\u30b9\u30ef\u30fc\u30c9\u3067\u306f\u306a\u304f\u516c\u958b\u9375\u3092\u4f7f\u3044\u307e\u3057\u3087\u3046\n- \u4ed6\u306e\u30e6\u30fc\u30b6\u306b\u5bfe\u3057\u3066\u3082\u8f9e\u66f8\u653b\u6483\u306f\u3055\u308c\u3066\u3044\u308b\u306e\u3067\u3001\u30d1\u30b9\u30ef\u30fc\u30c9\u306f\u9577\u304f\u3001\u3082\u3057\u304f\u306f\u516c\u958b\u9375\u3092\u4f7f\u3044\u307e\u3057\u3087\u3046\n- \u305d\u3082\u305d\u3082SSH\u306e\u30d5\u30eb\u958b\u653e\u306f\u3084\u3081\u307e\u3057\u3087\u3046\n\n# \u5206\u6790\u7d50\u679c\n\n## \u7dcf\u4ef6\u6570\n```sql:SQL\u6587\nSELECT COUNT(*) FROM [your_dataset.your_table]\n```\n![Google_BigQuery.png](https://qiita-image-store.s3.amazonaws.com/0/75573/d939e86d-039d-5608-2b6d-cb67a1986719.png \"Google_BigQuery.png\")\n\n\n## root\u306b\u95a2\u3059\u308b\u30ed\u30b0\u96c6\u8a08\n```sql:SQL\u6587\nSELECT message,COUNT(*) AS COUNT FROM [your_dataset.your_table] where message like '%root%' GROUP BY message ORDER BY COUNT DESC\n```\n![Google_BigQuery.png](https://qiita-image-store.s3.amazonaws.com/0/75573/621f85f5-06d6-9e3b-3c27-b17fcafa4e09.png \"Google_BigQuery.png\")\n\n## \u65bd\u884c\u3057\u305f\u30e6\u30fc\u30b6\u540d\n```sql:SQL\u6587\nSELECT message,COUNT(*) AS COUNT FROM [your_dataset.your_table] where message like 'input_userauth_request: invalid user%' GROUP BY message ORDER BY COUNT desc\n```\n![Google_BigQuery.png](https://qiita-image-store.s3.amazonaws.com/0/75573/a70e927e-c0bf-53b5-01cd-0b1e0e8931ca.png \"Google_BigQuery.png\")\n\n## \u5931\u6557\u3057\u305fIP\u3068\u30e6\u30fc\u30b6\u540d\n```sql:SQL\u6587\nSELECT message,COUNT(*) AS COUNT FROM [your_dataset.your_table] where message like 'pam_unix(sshd:auth): authentication failure;%' GROUP BY message ORDER BY COUNT DESC\n```\n![Google_BigQuery.png](https://qiita-image-store.s3.amazonaws.com/0/75573/60b31293-6721-bdc8-e45f-d53729c27150.png \"Google_BigQuery.png\")\n\n\n# \u53c2\u8003\n## fluentd\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\n```conf:/etc/td-agent/td-agent.conf\n<source>\n  type tail\n  path /var/log/secure\n  tag syslog.secure\n  format syslog\n</source>\n\n<match syslog.secure>\n  type bigquery\n\n  method insert\n\n  auth_method private_key\n  email your_acount@developer.gserviceaccount.com\n  private_key_path /path/to/your_project-id.p12\n\n  project your_project_id\n  dataset your_dataset\n  table your_talbe\n\n  time_format %s\n  time_field time\n  schema_path /path/to/your_schema.json\n</match>\n```\n- secure\u30d5\u30a1\u30a4\u30eb\u306ftd-agent\u30e6\u30fc\u30b6\u304b\u3089\u8aad\u307f\u8fbc\u3081\u308b\u6a29\u9650\u3092\u4ed8\u4e0e\u3059\u308b\n\n## BigQuery\u7528schema\u30d5\u30a1\u30a4\u30eb\n- \u4e8b\u524d\u306b\u3053\u306e\u30d5\u30a1\u30a4\u30eb\u3092\u5143\u306bBigQuery\u306e\u30c6\u30fc\u30d6\u30eb\u3092\u4f5c\u6210\u3057\u3066\u304a\u304f\n\n```conf:/path/to/your_schema.json\n[\n  {\n    \"name\": \"host\",\n    \"type\": \"STRING\"\n  },\n  {\n    \"name\": \"ident\",\n    \"type\": \"STRING\"\n  },\n  {\n    \"name\": \"pid\",\n    \"type\": \"INTEGER\"\n  },\n  {\n    \"name\": \"message\",\n    \"type\": \"STRING\"\n  }\n]\n```\n\n", "tags": ["Security", "bigquery", "fluentd"]}