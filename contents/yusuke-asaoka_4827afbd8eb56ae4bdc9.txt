{"context": "\n\n\u5185\u5bb9\nInstagram api\u306e\u4ed5\u69d8\u5909\u66f4\u3067Sandbox\u30e2\u30fc\u30c9\u3067\u306f\u4ed6\u30e6\u30fc\u30b6\u30fc\u306e\u60c5\u5831\u306e\u53d6\u5f97\u304c\u3067\u304d\u306a\u304f\u306a\u3063\u3066\u3057\u307e\u3044\u307e\u3057\u305f\u306d\u3002\n\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u30ef\u30fc\u30af\u3067\u5148\u65b9\u306eID\u3001PASS\u3092\u805e\u304f\u3053\u3068\u7121\u304f\u30a2\u30af\u30bb\u30b9\u30c8\u30fc\u30af\u30f3\u3092\u53d6\u5f97\u3059\u308b\u5fc5\u8981\u304c\u3042\u3063\u305f\u306e\u3067\u3053\u3061\u3089\u306e\u30b3\u30fc\u30c9\u3092\u4f5c\u308a\u4f7f\u7528\u3057\u3066\u3082\u3089\u3046\u3053\u3068\u306b\u3057\u307e\u3057\u305f\u3002\n\u3053\u3061\u3089\u3092\u4f7f\u3046\u3053\u3068\u3067Client ID\u3068Client Secret\u304b\u3089\u30ea\u30af\u30a8\u30b9\u30c8\u30c8\u30fc\u30af\u30f3\u306e\u53d6\u5f97\u3001\u30ea\u30af\u30a8\u30b9\u30c8\u30c8\u30fc\u30af\u30f3\u3068\u30a2\u30af\u30bb\u30b9\u30c8\u30fc\u30af\u30f3\u306e\u4ea4\u63db\u307e\u3067\u884c\u308f\u308c\u307e\u3059\u3002\n\u203b\u305f\u3060\u3057\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u767b\u9332\u307e\u3067\u306f\u81ea\u529b\u3067\u884c\u3063\u3066\u3044\u305f\u3060\u304f\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\nhttps://www.instagram.com/developer/clients/register/\n\nheader(\"Content-Type: text/html; charset=UTF-8\");\n\nnew Token;\n\nclass Token{\n\n  private $client_id ;\n  private $client_secret;\n  private $redirect_uri = '[\u8a2d\u7f6e\u3059\u308bURL\uff08\u30ea\u30c0\u30a4\u30ec\u30af\u30c8URL\u3068\u540c\u69d8\uff09]';\n\n    public function __construct(){\n\n      session_start() ;\n\n      if( !empty($_GET['code']) && !empty($_SESSION['state']) && !empty($_GET['state']) && $_SESSION['state'] == $_GET['state']) {\n\n        $this->get_token();\n\n      }elseif($_SERVER[\"REQUEST_METHOD\"] == \"POST\"){\n\n        $this->get_code();\n\n      }else{\n\n        $this->get_code_pre();\n\n      }\n    }\n\n    private function get_code_pre(){\n\n      //CSRF\u5bfe\u7b56\u7528\u30bb\u30c3\u30b7\u30e7\u30f3\u3001state\u30d1\u30e9\u30e1\u30fc\u30bf\u30fc\u306e\u307f\u4f7f\u7528\u53ef\u80fd\n      session_regenerate_id( true ) ;\n      $state = sha1( uniqid( mt_rand() , true ) ) ;\n      $_SESSION['state'] = $state ;\n\n      echo <<< EOM\n      <form method=\"post\" action=\"$this->redirect_uri\">\n      <label for=\"client_id\">CLIENT ID</label>\n      <input type=\"text\" name=\"client_id\" style=\" width: 300px;\"><br />\n      <label for=\"client_secret\">CLIENT SECRET</label>\n      <input type=\"text\" name=\"client_secret\" style=\" width: 300px;\"><br />\n      <input type=\"hidden\" name=\"redirect_uri\" value=\"$this->redirect_uri\">\n      <input type=\"hidden\" name=\"setting\">\n      <input type=\"submit\" value=\"\u9001\u4fe1\u3059\u308b\">\n      </form>\nEOM;\n    }\n\n    private function get_code(){\n\n      $this->client_id = $_POST['client_id'];\n\n      $_SESSION['client_id'] = $_POST['client_id'];\n      $_SESSION['client_secret'] =$_POST['client_secret'];\n\n      header( 'Location: https://api.instagram.com/oauth/authorize/?client_id='.$this->client_id.'&redirect_uri='.$this->redirect_uri. '&response_type=code&state='.$_SESSION['state']);\n\n    }\n\n    private function get_token(){\n\n      $this->client_id = $_SESSION['client_id'];\n      $this->client_secret = $_SESSION['client_secret'];\n\n      $body = http_build_query( \n        array(\n          'client_id' => $this->client_id ,\n          'client_secret' => $this->client_secret ,\n          'grant_type' => 'authorization_code' ,\n          'redirect_uri' => $this->redirect_uri ,\n          'code' => $_GET['code'] ,\n       )\n    );\n\n    $curl = curl_init() ;\n\n    curl_setopt( $curl , CURLOPT_URL , 'https://api.instagram.com/oauth/access_token' ) ;\n    curl_setopt( $curl , CURLOPT_HEADER, true ) ; \n    curl_setopt( $curl , CURLOPT_CUSTOMREQUEST , 'POST' ) ; \n    curl_setopt( $curl , CURLOPT_RETURNTRANSFER , true ) ;          \n    curl_setopt( $curl , CURLOPT_POSTFIELDS , $body ) ;\n    curl_setopt( $curl , CURLOPT_TIMEOUT , 5 ) ;    \n\n    $response1 = curl_exec( $curl ) ;\n    $response2 = curl_getinfo( $curl ) ;    \n\n    curl_close( $curl ) ;\n    $json = substr( $response1, $response2['header_size'] ) ;\n    $obj = json_decode( $json ) ;\n\n    if( !$obj || !isset($obj->user->id) || !isset($obj->user->username) || !isset($obj->user->profile_picture) || !isset($obj->access_token) ){\n      echo <<< EOM\n      <p>\u30a8\u30e9\u30fc\u3067\u3059\uff01</p>\nEOM;\n    }else{\n      $token = $obj->access_token;\n      echo <<< EOM\n      <p>\u30a2\u30af\u30bb\u30b9\u30c8\u30fc\u30af\u30f3\u306f<br/><span style=\"font-weight:bold;\">{$token}</span><br/>\u3067\u3059\uff01</p>\nEOM;\n    }\n\n    $_SESSION = array() ;\n    session_destroy() ;\n  }\n}\n\n# \u5185\u5bb9\n\nInstagram api\u306e\u4ed5\u69d8\u5909\u66f4\u3067Sandbox\u30e2\u30fc\u30c9\u3067\u306f\u4ed6\u30e6\u30fc\u30b6\u30fc\u306e\u60c5\u5831\u306e\u53d6\u5f97\u304c\u3067\u304d\u306a\u304f\u306a\u3063\u3066\u3057\u307e\u3044\u307e\u3057\u305f\u306d\u3002\n\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u30ef\u30fc\u30af\u3067\u5148\u65b9\u306eID\u3001PASS\u3092\u805e\u304f\u3053\u3068\u7121\u304f\u30a2\u30af\u30bb\u30b9\u30c8\u30fc\u30af\u30f3\u3092\u53d6\u5f97\u3059\u308b\u5fc5\u8981\u304c\u3042\u3063\u305f\u306e\u3067\u3053\u3061\u3089\u306e\u30b3\u30fc\u30c9\u3092\u4f5c\u308a\u4f7f\u7528\u3057\u3066\u3082\u3089\u3046\u3053\u3068\u306b\u3057\u307e\u3057\u305f\u3002\n\n\u3053\u3061\u3089\u3092\u4f7f\u3046\u3053\u3068\u3067**Client ID**\u3068**Client Secret**\u304b\u3089\u30ea\u30af\u30a8\u30b9\u30c8\u30c8\u30fc\u30af\u30f3\u306e\u53d6\u5f97\u3001\u30ea\u30af\u30a8\u30b9\u30c8\u30c8\u30fc\u30af\u30f3\u3068\u30a2\u30af\u30bb\u30b9\u30c8\u30fc\u30af\u30f3\u306e\u4ea4\u63db\u307e\u3067\u884c\u308f\u308c\u307e\u3059\u3002\n\n\u203b\u305f\u3060\u3057\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u767b\u9332\u307e\u3067\u306f\u81ea\u529b\u3067\u884c\u3063\u3066\u3044\u305f\u3060\u304f\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\nhttps://www.instagram.com/developer/clients/register/\n\n\n```php\n\nheader(\"Content-Type: text/html; charset=UTF-8\");\n\nnew Token;\n\nclass Token{\n\n  private $client_id ;\n  private $client_secret;\n  private $redirect_uri = '[\u8a2d\u7f6e\u3059\u308bURL\uff08\u30ea\u30c0\u30a4\u30ec\u30af\u30c8URL\u3068\u540c\u69d8\uff09]';\n\t\n    public function __construct(){\n\n      session_start() ;\n\n      if( !empty($_GET['code']) && !empty($_SESSION['state']) && !empty($_GET['state']) && $_SESSION['state'] == $_GET['state']) {\n\n        $this->get_token();\n\n      }elseif($_SERVER[\"REQUEST_METHOD\"] == \"POST\"){\n\t\t\t\n        $this->get_code();\n\n      }else{\n      \n        $this->get_code_pre();\n      \n      }\n    }\n\n    private function get_code_pre(){\n\n      //CSRF\u5bfe\u7b56\u7528\u30bb\u30c3\u30b7\u30e7\u30f3\u3001state\u30d1\u30e9\u30e1\u30fc\u30bf\u30fc\u306e\u307f\u4f7f\u7528\u53ef\u80fd\n      session_regenerate_id( true ) ;\n      $state = sha1( uniqid( mt_rand() , true ) ) ;\n      $_SESSION['state'] = $state ;\n\n      echo <<< EOM\n      <form method=\"post\" action=\"$this->redirect_uri\">\n      <label for=\"client_id\">CLIENT ID</label>\n      <input type=\"text\" name=\"client_id\" style=\" width: 300px;\"><br />\n      <label for=\"client_secret\">CLIENT SECRET</label>\n      <input type=\"text\" name=\"client_secret\" style=\" width: 300px;\"><br />\n      <input type=\"hidden\" name=\"redirect_uri\" value=\"$this->redirect_uri\">\n      <input type=\"hidden\" name=\"setting\">\n      <input type=\"submit\" value=\"\u9001\u4fe1\u3059\u308b\">\n      </form>\nEOM;\n    }\n\n    private function get_code(){\n\t\t\n      $this->client_id = $_POST['client_id'];\n\n      $_SESSION['client_id'] = $_POST['client_id'];\n      $_SESSION['client_secret'] =$_POST['client_secret'];\n\n      header( 'Location: https://api.instagram.com/oauth/authorize/?client_id='.$this->client_id.'&redirect_uri='.$this->redirect_uri. '&response_type=code&state='.$_SESSION['state']);\n\t\n    }\n\n    private function get_token(){\n\t\t\n      $this->client_id = $_SESSION['client_id'];\n      $this->client_secret = $_SESSION['client_secret'];\n\n      $body = http_build_query( \n        array(\n          'client_id' => $this->client_id ,\n          'client_secret' => $this->client_secret ,\n          'grant_type' => 'authorization_code' ,\n          'redirect_uri' => $this->redirect_uri ,\n          'code' => $_GET['code'] ,\n       )\n    );\n\n    $curl = curl_init() ;\n\n    curl_setopt( $curl , CURLOPT_URL , 'https://api.instagram.com/oauth/access_token' ) ;\n    curl_setopt( $curl , CURLOPT_HEADER, true ) ; \n    curl_setopt( $curl , CURLOPT_CUSTOMREQUEST , 'POST' ) ; \n    curl_setopt( $curl , CURLOPT_RETURNTRANSFER , true ) ;          \n    curl_setopt( $curl , CURLOPT_POSTFIELDS , $body ) ;\n    curl_setopt( $curl , CURLOPT_TIMEOUT , 5 ) ;\t\n\n    $response1 = curl_exec( $curl ) ;\n    $response2 = curl_getinfo( $curl ) ;\t\n\n    curl_close( $curl ) ;\n    $json = substr( $response1, $response2['header_size'] ) ;\n    $obj = json_decode( $json ) ;\n    \n    if( !$obj || !isset($obj->user->id) || !isset($obj->user->username) || !isset($obj->user->profile_picture) || !isset($obj->access_token) ){\n      echo <<< EOM\n      <p>\u30a8\u30e9\u30fc\u3067\u3059\uff01</p>\nEOM;\n    }else{\n      $token = $obj->access_token;\n      echo <<< EOM\n      <p>\u30a2\u30af\u30bb\u30b9\u30c8\u30fc\u30af\u30f3\u306f<br/><span style=\"font-weight:bold;\">{$token}</span><br/>\u3067\u3059\uff01</p>\nEOM;\n    }\n\n    $_SESSION = array() ;\n    session_destroy() ;\n  }\n}\n```\n", "tags": ["PHP", "Instagram"]}