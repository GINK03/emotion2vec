{"context": "\n\n\u306f\u3058\u3081\u306b\nProxmox VE\u3067\u30d3\u30c7\u30aa\u30ab\u30fc\u30c9\u3092KVM\u30b2\u30b9\u30c8\u306b\u30d1\u30b9\u30b9\u30eb\u30fc\u3057\u307e\u3059\u3002UEFI\u74b0\u5883\u306b\u7d5e\u3063\u3066\u8aac\u660e\u3059\u308b\u305f\u3081\u3001UEFI\u306b\u5bfe\u5fdc\u3057\u305f\u30d3\u30c7\u30aa\u30ab\u30fc\u30c9\u306e\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\u3053\u306e\u6295\u7a3f\u306f\u4e0b\u8a18\u306e\u30da\u30fc\u30b8\u3092\u4e0b\u6577\u304d\u306b\u3057\u3066\u3044\u307e\u3059\u3002\u3042\u308f\u305b\u3066\u3054\u89a7\u304f\u3060\u3055\u3044\u3002\n\nPci passthrough - Proxmox VE\nOVMF \u306b\u3088\u308b PCI \u30d1\u30b9\u30b9\u30eb\u30fc - ArchWiki\nWindows VirtIO Drivers - Proxmox VE\nCategory:HOWTO - Proxmox VE\n\nCPU\u304cSkylake\u304a\u3088\u3073Haswell\u3001GPU\u304cGeForce GT 710\u304a\u3088\u3073Radeon HD 5450\u306e\u74b0\u5883\u3067\u30c6\u30b9\u30c8\u3057\u307e\u3057\u305f\u304c\u3001\u7d50\u5c40Windows 10\u3067\u306fGeForce\u3060\u3068\u30a8\u30e9\u30fc43\u3092\u56de\u907f\u3067\u304d\u305a\u3001Radeon\u3060\u3068Skylake\u3001Haswell\u3068\u3082\u30c9\u30e9\u30a4\u30d0\u30fc\u3092\u5165\u308c\u308b\u3068\u30af\u30e9\u30c3\u30b7\u30e5\u3002Ubuntu+Skylake\u3067\u306fRadeon\u3001GeForce\u3068\u3082\u306b10\u5206\u307b\u3069\u64cd\u4f5c\u3057\u3066\u3044\u308b\u3068\u753b\u9762\u304c\u4e71\u308c\u308b\u3088\u3046\u306b\u306a\u308b\u306a\u3069\u3001\u5b89\u5b9a\u3055\u305b\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u305b\u3093\u3067\u3057\u305f\u3002\n\nVM\u306e\u6e96\u5099\nOVMF(UEFI)\u306e\u5834\u5408\u3001VirtIO\u306e\u4eee\u60f3HDD\u304b\u3089\u30d6\u30fc\u30c8\u3067\u304d\u307e\u305b\u3093\u3002\u305d\u306e\u305f\u3081\u4eee\u60f3HDD\u306fSCSI\u3068\u3057\u3001SCSI Controller Type\u306bWindows\u3067\u306fVirtIO SCSI\u3092\u3001Linux\u3067\u306fVirtIO SCSI single\u3092\u9078\u3093\u3067\u304f\u3060\u3055\u3044\u3002Windows\u3067VirtIO SCSI single\u306f\u3001VirtIO\u30c9\u30e9\u30a4\u30d0\u30fc\u304c\u5bfe\u5fdc\u3057\u3066\u3044\u306a\u3044\u3088\u3046\u3067\u3059\u3002\n\u4eee\u60f3HDD\u306e\u30ad\u30e3\u30c3\u30b7\u30e5\u306fWrite back\u3068\u3057\u3001Discard\u3092\u30aa\u30f3\u306b\u3057\u307e\u3059\u3002Discard\u306b\u3088\u3063\u3066VM\u3067Trim\u3092\u884c\u3046\u3068\u3001\u4eee\u60f3HDD\u306e\u30b5\u30a4\u30ba\u3092\u7e2e\u5c0f\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\uff08LVM-Thin\u3067\u78ba\u8a8d\uff09\u3002\nWindows\u3067\u306f\u4eee\u60f3CPU\u306bCore 2 Duo\u3092\u9078\u3070\u306a\u3044\u3068\u3001\u518d\u8d77\u52d5\u6642\u306b\u30d6\u30fc\u30c8\u3067\u304d\u306a\u3044\u554f\u984c\u304c\u3042\u308a\u307e\u3059\u3002Core 2 Duo\u3092\u9078\u3093\u3067\u3044\u308b\u308f\u3051\u306b\u3082\u3044\u304b\u306a\u3044\u306e\u3067\u3001\u518d\u8d77\u52d5\u306f\u3057\u306a\u3044\u3067\u3001\u30b7\u30e3\u30c3\u30c8\u30c0\u30a6\u30f3\u30fb\u8d77\u52d5\u3057\u3066\u304f\u3060\u3055\u3044\u3002\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3060\u3051Core 2 Duo\u3067\u884c\u3063\u3066\u3082\u3088\u3044\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u3002\n\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\uff08Windows\u30fb\u30c9\u30e9\u30a4\u30d0\u30fc\u5148\uff09\n\nVirtIO\u30c9\u30e9\u30a4\u30d0\u30fc\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\ncd /var/lib/vz/template/iso &&\nwget https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/latest-virtio/virtio-win.iso\n\n\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3067\u304d\u305f\u3089VM\u306b\u8ffd\u52a0\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\nVM\u306e\u8a2d\u5b9a\n\n\u30cf\u30fc\u30c9\u30a6\u30a7\u30a2\n\n\n\u30cf\u30fc\u30c9\u30c7\u30a3\u30b9\u30af (scsi0): local-lvm:vm-100-disk-1,cache=writeback,discard=on,size=64G\n\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u30c7\u30d0\u30a4\u30b9 (net0): virtio=00:00:00:00:00:00,bridge=vmbr0\n\n\n\u30aa\u30d7\u30b7\u30e7\u30f3\n\n\nSCSI Controller Type: VirtIO SCSI\nBIOS: OVMF(UEFI)\n\n\n\n\nOS\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u306e\u7a2e\u985e\u3092\u9078\u3093\u3067\u304f\u3060\u3055\u3044\u2192\u30ab\u30b9\u30bf\u30e0\nWindows\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u5834\u6240\u3092\u9078\u3093\u3067\u304f\u3060\u3055\u3044\u2192\u30c9\u30e9\u30a4\u30d0\u30fc\u306e\u8aad\u307f\u8fbc\u307f\u2192\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u30c9\u30e9\u30a4\u30d0\u30fc\u306e\u9078\u629e\u2192\u53c2\u7167\u2192Balloon\\w10\\amd64\\balloon.inf\u2192\u6b21\u3078\nWindows\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u5834\u6240\u3092\u9078\u3093\u3067\u304f\u3060\u3055\u3044\u2192\u30c9\u30e9\u30a4\u30d0\u30fc\u306e\u8aad\u307f\u8fbc\u307f\u2192\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u30c9\u30e9\u30a4\u30d0\u30fc\u306e\u9078\u629e\u2192\u53c2\u7167\u2192NetKVM\\w10\\amd64\\netkvm.inf\u2192\u6b21\u3078\nWindows\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u5834\u6240\u3092\u9078\u3093\u3067\u304f\u3060\u3055\u3044\u2192\u30c9\u30e9\u30a4\u30d0\u30fc\u306e\u8aad\u307f\u8fbc\u307f\u2192\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u30c9\u30e9\u30a4\u30d0\u30fc\u306e\u9078\u629e\u2192\u53c2\u7167\u2192vioscsi\\w10\\amd64\\vioscsi.inf\u2192\u6b21\u3078\nWindows\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u5834\u6240\u3092\u9078\u3093\u3067\u304f\u3060\u3055\u3044\u2192\u30c9\u30e9\u30a4\u30d0\u30fc\u306e\u8aad\u307f\u8fbc\u307f\u2192\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u30c9\u30e9\u30a4\u30d0\u30fc\u306e\u9078\u629e\u2192\u53c2\u7167\u2192vioserial\\w10\\amd64\\vioser.inf\u2192\u6b21\u3078\n\n\u52d5\u7684\u306a\u30e1\u30e2\u30ea\u30fc\u304c\u50cd\u3044\u3066\u3044\u306a\u3044\u5834\u5408\u306f\u3001Balloon\\w8.1\u3092Program Files\u306b\u30b3\u30d4\u30fc\u3057\u3066\u3001BLNSVR.exe -i\u3092\u5b9f\u884c\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\uff08Windows\u30fb\u30c9\u30e9\u30a4\u30d0\u30fc\u5f8c\uff09\n\nVM\u306e\u8a2d\u5b9a\n\n\u30cf\u30fc\u30c9\u30a6\u30a7\u30a2\n\n\n\u30cf\u30fc\u30c9\u30c7\u30a3\u30b9\u30af (ide0): local-lvm:vm-100-disk-1,cache=writeback,discard=on,size=64G\n\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u30c7\u30d0\u30a4\u30b9 (net0): e1000=00:00:00:00:00:00,bridge=vmbr0\n\n\n\u30aa\u30d7\u30b7\u30e7\u30f3\n\n\nSCSI Controller Type: \u30c7\u30d5\u30a9\u30eb\u30c8 (LSI 53C895A)\nBIOS: OVMF(UEFI)\n\n\n\n\n\u30c9\u30e9\u30a4\u30d0\u30fc\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\uff08OS\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u5f8c\uff09\nVirtIO\u30c9\u30e9\u30a4\u30d0\u30fc\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3002VM\u306b\u8ffd\u52a0\u3057\u307e\u3059\u3002\u305d\u3057\u3066VM\u3092\u8d77\u52d5\u3057\u3066\u3001\u6b21\u306einf\u30d5\u30a1\u30a4\u30eb\u3092\u305d\u308c\u305e\u308c\u53f3\u30af\u30ea\u30c3\u30af\u3057\u3066\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u307e\u3059\u3002\n\nvioserial\\w10\\amd64\\vioser.inf\nBalloon\\w10\\amd64\\balloon.inf\nNetKVM\\w10\\amd64\\netkvm.inf\nvioscsi\\w10\\amd64\\vioscsi.inf\nvioserial\\w10\\amd64\\vioser.inf\n\n\u52d5\u7684\u306a\u30e1\u30e2\u30ea\u30fc\u304c\u50cd\u3044\u3066\u3044\u306a\u3044\u5834\u5408\u306f\u3001Balloon\\w8.1\u3092Program Files\u306b\u30b3\u30d4\u30fc\u3057\u3066\u3001BLNSVR.exe -i\u3092\u5b9f\u884c\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\uff08Linux\uff09\n\nVM\u306e\u8a2d\u5b9a\n\n\u30cf\u30fc\u30c9\u30a6\u30a7\u30a2\n\n\n\u30cf\u30fc\u30c9\u30c7\u30a3\u30b9\u30af (scsi0): local-lvm:vm-100-disk-1,cache=writeback,discard=on,size=64G\n\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u30c7\u30d0\u30a4\u30b9 (net0): virtio=00:00:00:00:00:00,bridge=vmbr0\n\n\n\u30aa\u30d7\u30b7\u30e7\u30f3\n\n\nSCSI Controller Type: VirtIO SCSI single\nBIOS: OVMF(UEFI)\n\n\n\n\nOS\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\nLinux\u3067\u306f\u30c9\u30e9\u30a4\u30d0\u30fc\u306f\u6700\u521d\u304b\u3089\u5165\u3063\u3066\u3044\u307e\u3059\u304c\u3001UEFI\u3067\u306e\u30d6\u30fc\u30c8\u306b\u82e6\u52b4\u3057\u307e\u3059\u3002\u4ee5\u4e0bUbuntu\u306e\u5834\u5408\u306b\u3064\u3044\u3066\u8a18\u3057\u307e\u3059\u3002\u304a\u304a\u3080\u306dUbuntu 15.10 \u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\uff08UEFI\uff09\u305d\u306e1 - UEFI\u306ePC\u306bUbuntu 15.10\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\uff08\u30e9\u30a4\u30d6\u30e1\u30c7\u30a3\u30a2\u304b\u3089\u8d77\u52d5 \u301c EFI\u30b7\u30b9\u30c6\u30e0\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u306e\u4f5c\u6210\uff09 - kledgeb\u306e\u624b\u9806\u901a\u308a\u3067\u3059\u3002\n\n\u30e9\u30a4\u30d6\u30e1\u30c7\u30a3\u30a2\u304b\u3089\u8d77\u52d5\u3057\u3001GParted\u3067\u4eee\u60f3HDD\u306bGPT\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u30c6\u30fc\u30d6\u30eb\u3092\u4f5c\u6210\u3059\u308b\u3002\nFAT32\u3067512MiB\u306e\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u3092\u4f5c\u6210\u3057\u3001\u4eee\u60f3HDD\u3078\u5b9f\u969b\u306b\u53cd\u6620\u3055\u305b\u308b\u3002\n\n\n\u30cd\u30a4\u30c6\u30a3\u30d6EFI\u30b7\u30b9\u30c6\u30e0\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u306e\u30b5\u30a4\u30ba\u306fEFI \u30b7\u30b9\u30c6\u30e0\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3 - ArchWiki\u3067512MiB\u304c\u63a8\u5968\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n\n\n\u4f5c\u6210\u3057\u305f\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u306bboot\u304a\u3088\u3073esp\u30d5\u30e9\u30b0\u3092\u7acb\u3066\u308b\u3002\n\u3064\u3044\u3067\u306bext4\u306eOS\u672c\u4f53\u7528\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u3068\u30011GiB\u7a0b\u5ea6\u306e\u30b9\u30ef\u30c3\u30d7\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u3092\u4f5c\u308b\u3002\u672b\u5c3e\u306b\u306f1MiB\u7a7a\u304d\u9818\u57df\u3092\u53d6\u3089\u308c\u308b\u304c\u4ed5\u65b9\u306a\u3044\u3002\n\u753b\u9762\u89e3\u50cf\u5ea6\u3092\u7e261024\u30d4\u30af\u30bb\u30eb\u4ee5\u4e0a\u306b\u3059\u308b\u3002\n\u30c7\u30b9\u30af\u30c8\u30c3\u30d7\u4e0a\u306b\u3042\u308b\u30a4\u30f3\u30b9\u30c8\u30fc\u30e9\u30fc\u3092\u8d77\u52d5\u3059\u308b\u3002\n\u300c\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u306e\u7a2e\u985e\u300d\u753b\u9762\u3067\u300c\u305d\u308c\u4ee5\u5916\u300d\u3092\u9078\u3073\u3001\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u3092\u30ab\u30b9\u30bf\u30de\u30a4\u30ba\u3067\u304d\u308b\u30eb\u30fc\u30c8\u306b\u5165\u308b\u3002\n\u3055\u304d\u307b\u3069\u4f5c\u6210\u3057\u305f\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u306b\u3001\u30bf\u30a4\u30d7\u6b04\u3067EFI\u304c\u6307\u5b9a\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3059\u308b\u3002\next4\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u3092\u30eb\u30fc\u30c8(/)\u306e\u30de\u30a6\u30f3\u30c8\u30dd\u30a4\u30f3\u30c8\u3068\u3057\u3066\u6307\u5b9a\u3059\u308b\u3002\n\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u304c\u7d42\u308f\u3063\u305f\u3089\u518d\u8d77\u52d5\u305b\u305a\u306b\u3001\u30e9\u30a4\u30d6OS\u4e0a\u3067\u4f5c\u696d\u3057\u307e\u3059\u3002\u7aef\u672b\u3092\u7acb\u3061\u4e0a\u3052\u6b21\u306e\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3057\u307e\u3059\u3002\nsudo mount /dev/sda1 /mnt\nsudo ls -la /mnt/EFI/ubuntu # grubx64.efi\u3092\u78ba\u8a8d\nsudo mkdir /mnt/EFI/BOOT\nsudo cp /mnt/EFI/ubuntu/grubx64.efi\n/mnt/EFI/BOOT/BOOTX64.EFI\n\n\u3053\u308c\u306fOVMF\u304cgrubx64.efi\u304b\u3089\u30d6\u30fc\u30c8\u3057\u3066\u304f\u308c\u306a\u3044\u305f\u3081\u3001grubx64.efi\u3092BOOTX64.EFI\u306b\u30b3\u30d4\u30fc\u3059\u308b\u30b3\u30de\u30f3\u30c9\u3067\u3059\u3002\u30b3\u30d4\u30fc\u304c\u5b8c\u4e86\u3057\u305f\u3089\u518d\u8d77\u52d5\u3057\u307e\u3059\u3002\u4eee\u60f3HDD\u306b\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u305fUbuntu\u304b\u3089\u30d6\u30fc\u30c8\u3059\u308b\u306f\u305a\u3067\u3059\u3002\n\nIOMMU\u3092\u6709\u52b9\u306b\u3059\u308b\n\n\u6e96\u5099\nBIOS\u3067VT-d\u3092\u6709\u52b9\u306b\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n\u8a2d\u5b9a\n# nano /etc/default/grub\nGRUB_CMDLINE_LINUX_DEFAULT=\"quiet\"\n\u2193\nGRUB_CMDLINE_LINUX_DEFAULT=\"quiet intel_iommu=on\"\n\n# update-grub\n\nAMD\u306eCPU\u306e\u5834\u5408intel_iommu\u306b\u4ee3\u3048\u3066amd_iommu\u3068\u3057\u307e\u3059\u3002update-grub\u3092\u5fd8\u308c\u306a\u3044\u3067\u304f\u3060\u3055\u3044\u3002\n\n\u78ba\u8a8d\uff08\u8981\u518d\u8d77\u52d5\uff09\n# dmesg | grep -e DMAR -e IOMMU\n[    0.000000] DMAR: IOMMU enabled\n\n\nx2APIC\u3092\u6709\u52b9\u306b\u3059\u308b\n\n\u6e96\u5099\nBIOS\u3067x2APIC\u3092\u6709\u52b9\u306b\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n\u78ba\u8a8d\n# dmesg | grep -e DMAR -e IOMMU\n[    0.061698] DMAR-IR: x2apic is disabled because BIOS sets x2apic opt out bit.\n[    0.061699] DMAR-IR: Use 'intremap=no_x2apic_optout' to override the BIOS setting.\n[    0.063089] DMAR-IR: Enabled IRQ remapping in xapic mode\n\nBIOS\u3067\u6709\u52b9\u306b\u3067\u304d\u306a\u304b\u3063\u305f\u5834\u5408\u3001\u3053\u306e\u3088\u3046\u306b\u300cx2apic is disabled\u300d\u3068\u8868\u793a\u3055\u308c\u307e\u3059\u3002\u305d\u306e\u5834\u5408\u3001\u4ee5\u4e0b\u306e\u8a2d\u5b9a\u3092\u884c\u3044\u307e\u3059\u3002\n\n\u8a2d\u5b9a\n# nano /etc/default/grub\nGRUB_CMDLINE_LINUX_DEFAULT=\"quiet intel_iommu=on\"\n\u2193\nGRUB_CMDLINE_LINUX_DEFAULT=\"quiet intel_iommu=on intremap=no_x2apic_optout\"\n\n# update-grub\n\nupdate-grub\u3092\u5fd8\u308c\u306a\u3044\u3067\u304f\u3060\u3055\u3044\u3002\n\n\u78ba\u8a8d\uff08\u8981\u518d\u8d77\u52d5\uff09\n[    0.060882] DMAR-IR: Queued invalidation will be enabled to support x2apic and Intr-remapping.\n[    0.062304] DMAR-IR: Enabled IRQ remapping in x2apic mode\n\n\n\u30ab\u30fc\u30cd\u30eb\u30e2\u30b8\u30e5\u30fc\u30eb\u3092\u7d44\u307f\u8fbc\u3080\n# echo -e \"vfio\\nvfio_iommu_type1\\nvfio_pci\\nvfio_virqfd\" >> /etc/modules\n\n\n\u30d3\u30c7\u30aa\u30ab\u30fc\u30c9\u306ePCI\u30a2\u30c9\u30ec\u30b9\u3092\u78ba\u8a8d\u3059\u308b\n# for iommu_group in $(find /sys/kernel/iommu_groups/ -maxdepth 1 -mindepth 1 -type d); do echo \"IOMMU group $(basename \"$iommu_group\")\"; for device in $(ls -1 \"$iommu_group\"/devices/); do echo -n $'\\t'; lspci -nns \"$device\"; done; done\nIOMMU group 1\n        00:01.0 PCI bridge [0604]: Intel Corporation Sky Lake PCIe Controller (x16) [8086:1901] (rev 07)\n        01:00.0 VGA compatible controller [0300]: NVIDIA Corporation Device [10de:128b] (rev a1)\n        01:00.1 Audio device [0403]: NVIDIA Corporation GK208 HDMI/DP Audio Controller [10de:0e0f] (rev a1)\n\n\n\u30d3\u30c7\u30aa\u30ab\u30fc\u30c9\u3092vfio-pci\u306b\u6e21\u3059\n\n\u8a2d\u5b9a\n# echo options vfio-pci ids=10de:128b,10de:0e0f > /etc/modprobe.d/vfio.conf\n\n\n\u78ba\u8a8d\uff08\u8981\u518d\u8d77\u52d5\uff09\n# dmesg | grep -i vfio\n[    2.013295] VFIO - User Level meta-driver version: 0.3\n[    2.039844] vfio_pci: add [10de:128b[ffff:ffff]] class 0x000000/00000000\n[    2.055799] vfio_pci: add [10de:0e0f[ffff:ffff]] class 0x000000/00000000\n\n\n\u30d3\u30c7\u30aa\u30ab\u30fc\u30c9\u306e\u30c9\u30e9\u30a4\u30d0\u30fc\u3092\u7121\u52b9\u306b\u3059\u308b\n# echo -e \"blacklist radeon\\nblacklist nouveau\\nblacklist nvidia\" >> /etc/modprobe.d/blacklist.conf\n\n\nVM\u306b\u30d1\u30b9\u30b9\u30eb\u30fc\u3092\u8a2d\u5b9a\u3059\u308b\n# nano /etc/pve/nodes/hostname/qemu-server/100.conf\ncpu: host\nhostpci0: 01:00.0,x-vga=on\nhostpci1: 01:00.1\nusb0: host=1-3\nusb1: host=1-4\n\n\u6700\u8fd1\u306f\u30de\u30b7\u30f3\u3092q35\u306b\u3057\u3001pcie=1\u3092\u8a2d\u5b9a\u3059\u308b\u5fc5\u8981\u306f\u306a\u3044\u3088\u3046\u3067\u3059\u3002\nUSB\u306e\u30d1\u30b9\u30b9\u30eb\u30fc\u306fUSB physical port mapping - Proxmox VE\u3092\u53c2\u7167\u3002\n\nVM\u306e\u8d77\u52d5\u30b3\u30de\u30f3\u30c9\u3092\u78ba\u8a8d\u3059\u308b\n# qm showcmd 100\n/usr/bin/kvm -id 100 -chardev socket,id=qmp,path=/var/run/qemu-server/100.qmp,server,nowait -mon chardev=qmp,mode=control -pidfile /var/run/qemu-server/100.pid -daemonize -smbios type=1,uuid=a925fcc5-0805-44ad-8b69-c6981816109a -drive if=pflash,format=raw,readonly,file=/usr/share/kvm/OVMF-pure-efi.fd -drive if=pflash,format=raw,file=/tmp/100-OVMF_VARS-pure-efi.fd -name win10 -smp 2,sockets=1,cores=2,maxcpus=2 -nodefaults -boot menu=on,strict=on,reboot-timeout=1000 -vga none -nographic -no-hpet -cpu host,hv_vendor_id=proxmox,hv_spinlocks=0x1fff,hv_vapic,hv_time,hv_reset,hv_vpindex,hv_runtime,hv_relaxed,+kvm_pv_unhalt,+kvm_pv_eoi,kvm=off -m 16384 -k ja -device pci-bridge,id=pci.2,chassis_nr=2,bus=pci.0,addr=0x1f -device pci-bridge,id=pci.1,chassis_nr=1,bus=pci.0,addr=0x1e -device piix3-usb-uhci,id=uhci,bus=pci.0,addr=0x1.0x2 -readconfig /usr/share/qemu-server/pve-usb.cfg -device usb-tablet,id=tablet,bus=uhci.0,port=1 -device vfio-pci,host=01:00.0,id=hostpci0,bus=pci.0,addr=0x10 -device vfio-pci,host=01:00.1,id=hostpci1,bus=pci.0,addr=0x11 -device usb-host,hostbus=1,hostport=3,id=usb0 -device usb-host,hostbus=1,hostport=4,id=usb1 -device virtio-balloon-pci,id=balloon0,bus=pci.0,addr=0x3 -iscsi initiator-name=iqn.1993-08.org.debian:01:cad28f461da5 -drive file=/dev/pve/vm-100-disk-1,if=none,id=drive-ide0,format=raw,cache=none,aio=native,detect-zeroes=on -device ide-hd,bus=ide.0,unit=0,drive=drive-ide0,id=ide0,bootindex=100 -drive file=/var/lib/vz/template/iso/Windows10.iso,if=none,id=drive-ide2,media=cdrom,aio=threads -device ide-cd,bus=ide.1,unit=0,drive=drive-ide2,id=ide2 -netdev type=tap,id=net0,ifname=tap100i0,script=/var/lib/qemu-server/pve-bridge,downscript=/var/lib/qemu-server/pve-bridgedown -device e1000,mac=1A:01:70:2D:27:49,netdev=net0,bus=pci.0,addr=0x12,id=net0 -rtc driftfix=slew,base=localtime -global kvm-pit.lost_tick_policy=discard\n\nhv_vendor_id=proxmox\u306fNVIDIA\u306e\u30b3\u30fc\u30c943\u5bfe\u7b56\u3002NVIDIA\u306eWindows\u7528\u30c9\u30e9\u30a4\u30d0\u30fc\u306f\u3001\u4eee\u60f3\u30de\u30b7\u30f3\u4e0a\u3067\u3042\u308b\u3053\u3068\u3092\u691c\u77e5\u3059\u308b\u3068\u505c\u6b62\u3059\u308b\u305f\u3081\u3001\u305d\u308c\u3078\u306e\u5bfe\u7b56\u3067\u3059\u3002\u3057\u304b\u3057\u3001\u624b\u5143\u306e\u74b0\u5883\u3067\u306f\u3053\u306e\u5bfe\u7b56\u3092\u3057\u3066\u3044\u3066\u3082\u30b3\u30fc\u30c943\u3092\u56de\u907f\u3067\u304d\u307e\u305b\u3093\u3067\u3057\u305f\u3002\n\nVM\u3092\u8d77\u52d5\u30fb\u505c\u6b62\u3059\u308b\n# qm start 100\n# qm stop 100\n\nWebUI\u304b\u3089\u884c\u3063\u3066\u3082\u69cb\u3044\u307e\u305b\u3093\u3002\u3081\u3067\u305f\u304f\u30d3\u30c7\u30aa\u30ab\u30fc\u30c9\u3092\u30d1\u30b9\u30b9\u30eb\u30fc\u3067\u304d\u308b\u306f\u305a\u3067\u3059\u3002\n\nRadeon\u3067VM\u3092\u518d\u8d77\u52d5\u3067\u304d\u306a\u3044\u554f\u984c\nRadeon\u306b\u306fVM\u3092\u518d\u8d77\u52d5\u3067\u304d\u306a\u3044\u554f\u984c\u304c\u3042\u308b\u3088\u3046\u3067\u3059\u3002\u624b\u5143\u306e\u74b0\u5883\u3067\u306f\u78ba\u8a8d\u3067\u304d\u307e\u305b\u3093\u3067\u3057\u305f\u304c\u3054\u6ce8\u610f\u304f\u3060\u3055\u3044\u3002\n\u53c2\u8003: ESXi 6.0u1 GPU\u30d1\u30b9\u30b9\u30eb\u30fc\u3067VM\u518d\u8d77\u52d5\u3067\u304d\u306a\u3044\u554f\u984c\u306e\u89e3\u6c7a\uff5cHaioH\uff1a\u5909\u9077\u5099\u5fd8\u9332\n## \u306f\u3058\u3081\u306b\nProxmox VE\u3067\u30d3\u30c7\u30aa\u30ab\u30fc\u30c9\u3092KVM\u30b2\u30b9\u30c8\u306b\u30d1\u30b9\u30b9\u30eb\u30fc\u3057\u307e\u3059\u3002UEFI\u74b0\u5883\u306b\u7d5e\u3063\u3066\u8aac\u660e\u3059\u308b\u305f\u3081\u3001UEFI\u306b\u5bfe\u5fdc\u3057\u305f\u30d3\u30c7\u30aa\u30ab\u30fc\u30c9\u306e\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\u3053\u306e\u6295\u7a3f\u306f\u4e0b\u8a18\u306e\u30da\u30fc\u30b8\u3092\u4e0b\u6577\u304d\u306b\u3057\u3066\u3044\u307e\u3059\u3002\u3042\u308f\u305b\u3066\u3054\u89a7\u304f\u3060\u3055\u3044\u3002\n\n- [Pci passthrough \\- Proxmox VE](https://pve.proxmox.com/wiki/Pci_passthrough)\n- [OVMF \u306b\u3088\u308b PCI \u30d1\u30b9\u30b9\u30eb\u30fc \\- ArchWiki](https://wiki.archlinuxjp.org/index.php/OVMF_%E3%81%AB%E3%82%88%E3%82%8B_PCI_%E3%83%91%E3%82%B9%E3%82%B9%E3%83%AB%E3%83%BC)\n- [Windows VirtIO Drivers \\- Proxmox VE](https://pve.proxmox.com/wiki/Windows_VirtIO_Drivers)\n- [Category:HOWTO \\- Proxmox VE](https://pve.proxmox.com/wiki/Category:HOWTO)\n\nCPU\u304cSkylake\u304a\u3088\u3073Haswell\u3001GPU\u304cGeForce GT 710\u304a\u3088\u3073Radeon HD 5450\u306e\u74b0\u5883\u3067\u30c6\u30b9\u30c8\u3057\u307e\u3057\u305f\u304c\u3001\u7d50\u5c40Windows 10\u3067\u306fGeForce\u3060\u3068\u30a8\u30e9\u30fc43\u3092\u56de\u907f\u3067\u304d\u305a\u3001Radeon\u3060\u3068Skylake\u3001Haswell\u3068\u3082\u30c9\u30e9\u30a4\u30d0\u30fc\u3092\u5165\u308c\u308b\u3068\u30af\u30e9\u30c3\u30b7\u30e5\u3002Ubuntu+Skylake\u3067\u306fRadeon\u3001GeForce\u3068\u3082\u306b10\u5206\u307b\u3069\u64cd\u4f5c\u3057\u3066\u3044\u308b\u3068\u753b\u9762\u304c\u4e71\u308c\u308b\u3088\u3046\u306b\u306a\u308b\u306a\u3069\u3001\u5b89\u5b9a\u3055\u305b\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u305b\u3093\u3067\u3057\u305f\u3002\n\n## VM\u306e\u6e96\u5099\nOVMF(UEFI)\u306e\u5834\u5408\u3001VirtIO\u306e\u4eee\u60f3HDD\u304b\u3089\u30d6\u30fc\u30c8\u3067\u304d\u307e\u305b\u3093\u3002\u305d\u306e\u305f\u3081\u4eee\u60f3HDD\u306fSCSI\u3068\u3057\u3001SCSI Controller Type\u306bWindows\u3067\u306fVirtIO SCSI\u3092\u3001Linux\u3067\u306fVirtIO SCSI single\u3092\u9078\u3093\u3067\u304f\u3060\u3055\u3044\u3002Windows\u3067VirtIO SCSI single\u306f\u3001VirtIO\u30c9\u30e9\u30a4\u30d0\u30fc\u304c\u5bfe\u5fdc\u3057\u3066\u3044\u306a\u3044\u3088\u3046\u3067\u3059\u3002\n\n\u4eee\u60f3HDD\u306e\u30ad\u30e3\u30c3\u30b7\u30e5\u306fWrite back\u3068\u3057\u3001Discard\u3092\u30aa\u30f3\u306b\u3057\u307e\u3059\u3002Discard\u306b\u3088\u3063\u3066VM\u3067Trim\u3092\u884c\u3046\u3068\u3001\u4eee\u60f3HDD\u306e\u30b5\u30a4\u30ba\u3092\u7e2e\u5c0f\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\uff08LVM-Thin\u3067\u78ba\u8a8d\uff09\u3002\n\nWindows\u3067\u306f\u4eee\u60f3CPU\u306bCore 2 Duo\u3092\u9078\u3070\u306a\u3044\u3068\u3001\u518d\u8d77\u52d5\u6642\u306b\u30d6\u30fc\u30c8\u3067\u304d\u306a\u3044\u554f\u984c\u304c\u3042\u308a\u307e\u3059\u3002Core 2 Duo\u3092\u9078\u3093\u3067\u3044\u308b\u308f\u3051\u306b\u3082\u3044\u304b\u306a\u3044\u306e\u3067\u3001\u518d\u8d77\u52d5\u306f\u3057\u306a\u3044\u3067\u3001\u30b7\u30e3\u30c3\u30c8\u30c0\u30a6\u30f3\u30fb\u8d77\u52d5\u3057\u3066\u304f\u3060\u3055\u3044\u3002\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3060\u3051Core 2 Duo\u3067\u884c\u3063\u3066\u3082\u3088\u3044\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u3002\n\n### \u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\uff08Windows\u30fb\u30c9\u30e9\u30a4\u30d0\u30fc\u5148\uff09\n#### VirtIO\u30c9\u30e9\u30a4\u30d0\u30fc\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\n```\ncd /var/lib/vz/template/iso &&\nwget https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/latest-virtio/virtio-win.iso\n```\n\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3067\u304d\u305f\u3089VM\u306b\u8ffd\u52a0\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n#### VM\u306e\u8a2d\u5b9a\n- \u30cf\u30fc\u30c9\u30a6\u30a7\u30a2\n    - \u30cf\u30fc\u30c9\u30c7\u30a3\u30b9\u30af (scsi0): local-lvm:vm-100-disk-1,cache=writeback,discard=on,size=64G\n    - \u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u30c7\u30d0\u30a4\u30b9 (net0): virtio=00:00:00:00:00:00,bridge=vmbr0\n- \u30aa\u30d7\u30b7\u30e7\u30f3\n    - SCSI Controller Type: VirtIO SCSI\n    - BIOS: OVMF(UEFI)\n\n#### OS\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n- \u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u306e\u7a2e\u985e\u3092\u9078\u3093\u3067\u304f\u3060\u3055\u3044\u2192\u30ab\u30b9\u30bf\u30e0\n- Windows\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u5834\u6240\u3092\u9078\u3093\u3067\u304f\u3060\u3055\u3044\u2192\u30c9\u30e9\u30a4\u30d0\u30fc\u306e\u8aad\u307f\u8fbc\u307f\u2192\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u30c9\u30e9\u30a4\u30d0\u30fc\u306e\u9078\u629e\u2192\u53c2\u7167\u2192Balloon\\w10\\amd64\\balloon.inf\u2192\u6b21\u3078\n- Windows\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u5834\u6240\u3092\u9078\u3093\u3067\u304f\u3060\u3055\u3044\u2192\u30c9\u30e9\u30a4\u30d0\u30fc\u306e\u8aad\u307f\u8fbc\u307f\u2192\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u30c9\u30e9\u30a4\u30d0\u30fc\u306e\u9078\u629e\u2192\u53c2\u7167\u2192NetKVM\\w10\\amd64\\netkvm.inf\u2192\u6b21\u3078\n- Windows\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u5834\u6240\u3092\u9078\u3093\u3067\u304f\u3060\u3055\u3044\u2192\u30c9\u30e9\u30a4\u30d0\u30fc\u306e\u8aad\u307f\u8fbc\u307f\u2192\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u30c9\u30e9\u30a4\u30d0\u30fc\u306e\u9078\u629e\u2192\u53c2\u7167\u2192vioscsi\\w10\\amd64\\vioscsi.inf\u2192\u6b21\u3078\n- Windows\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u5834\u6240\u3092\u9078\u3093\u3067\u304f\u3060\u3055\u3044\u2192\u30c9\u30e9\u30a4\u30d0\u30fc\u306e\u8aad\u307f\u8fbc\u307f\u2192\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u30c9\u30e9\u30a4\u30d0\u30fc\u306e\u9078\u629e\u2192\u53c2\u7167\u2192vioserial\\w10\\amd64\\vioser.inf\u2192\u6b21\u3078\n\n\u52d5\u7684\u306a\u30e1\u30e2\u30ea\u30fc\u304c\u50cd\u3044\u3066\u3044\u306a\u3044\u5834\u5408\u306f\u3001Balloon\\w8.1\u3092Program Files\u306b\u30b3\u30d4\u30fc\u3057\u3066\u3001BLNSVR.exe -i\u3092\u5b9f\u884c\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n### \u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\uff08Windows\u30fb\u30c9\u30e9\u30a4\u30d0\u30fc\u5f8c\uff09\n#### VM\u306e\u8a2d\u5b9a\n- \u30cf\u30fc\u30c9\u30a6\u30a7\u30a2\n    - \u30cf\u30fc\u30c9\u30c7\u30a3\u30b9\u30af (ide0): local-lvm:vm-100-disk-1,cache=writeback,discard=on,size=64G\n    - \u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u30c7\u30d0\u30a4\u30b9 (net0): e1000=00:00:00:00:00:00,bridge=vmbr0\n- \u30aa\u30d7\u30b7\u30e7\u30f3\n    - SCSI Controller Type: \u30c7\u30d5\u30a9\u30eb\u30c8 (LSI 53C895A)\n    - BIOS: OVMF(UEFI)\n\n#### \u30c9\u30e9\u30a4\u30d0\u30fc\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\uff08OS\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u5f8c\uff09\nVirtIO\u30c9\u30e9\u30a4\u30d0\u30fc\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3002VM\u306b\u8ffd\u52a0\u3057\u307e\u3059\u3002\u305d\u3057\u3066VM\u3092\u8d77\u52d5\u3057\u3066\u3001\u6b21\u306einf\u30d5\u30a1\u30a4\u30eb\u3092\u305d\u308c\u305e\u308c\u53f3\u30af\u30ea\u30c3\u30af\u3057\u3066\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u307e\u3059\u3002\n\n- vioserial\\w10\\amd64\\vioser.inf\n- Balloon\\w10\\amd64\\balloon.inf\n- NetKVM\\w10\\amd64\\netkvm.inf\n- vioscsi\\w10\\amd64\\vioscsi.inf\n- vioserial\\w10\\amd64\\vioser.inf\n\n\u52d5\u7684\u306a\u30e1\u30e2\u30ea\u30fc\u304c\u50cd\u3044\u3066\u3044\u306a\u3044\u5834\u5408\u306f\u3001Balloon\\w8.1\u3092Program Files\u306b\u30b3\u30d4\u30fc\u3057\u3066\u3001BLNSVR.exe -i\u3092\u5b9f\u884c\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n### \u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\uff08Linux\uff09\n#### VM\u306e\u8a2d\u5b9a\n- \u30cf\u30fc\u30c9\u30a6\u30a7\u30a2\n    - \u30cf\u30fc\u30c9\u30c7\u30a3\u30b9\u30af (scsi0): local-lvm:vm-100-disk-1,cache=writeback,discard=on,size=64G\n    - \u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u30c7\u30d0\u30a4\u30b9 (net0): virtio=00:00:00:00:00:00,bridge=vmbr0\n- \u30aa\u30d7\u30b7\u30e7\u30f3\n    - SCSI Controller Type: VirtIO SCSI single\n    - BIOS: OVMF(UEFI)\n\n#### OS\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\nLinux\u3067\u306f\u30c9\u30e9\u30a4\u30d0\u30fc\u306f\u6700\u521d\u304b\u3089\u5165\u3063\u3066\u3044\u307e\u3059\u304c\u3001UEFI\u3067\u306e\u30d6\u30fc\u30c8\u306b\u82e6\u52b4\u3057\u307e\u3059\u3002\u4ee5\u4e0bUbuntu\u306e\u5834\u5408\u306b\u3064\u3044\u3066\u8a18\u3057\u307e\u3059\u3002\u304a\u304a\u3080\u306d[Ubuntu 15\\.10 \u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\uff08UEFI\uff09\u305d\u306e1 \\- UEFI\u306ePC\u306bUbuntu 15\\.10\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\uff08\u30e9\u30a4\u30d6\u30e1\u30c7\u30a3\u30a2\u304b\u3089\u8d77\u52d5 \u301c EFI\u30b7\u30b9\u30c6\u30e0\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u306e\u4f5c\u6210\uff09 \\- kledgeb](http://kledgeb.blogspot.jp/2015/10/ubuntu-1510-uefi1-uefipcubuntu-1510-efi.html)\u306e\u624b\u9806\u901a\u308a\u3067\u3059\u3002\n\n- \u30e9\u30a4\u30d6\u30e1\u30c7\u30a3\u30a2\u304b\u3089\u8d77\u52d5\u3057\u3001GParted\u3067\u4eee\u60f3HDD\u306bGPT\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u30c6\u30fc\u30d6\u30eb\u3092\u4f5c\u6210\u3059\u308b\u3002\n- FAT32\u3067512MiB\u306e\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u3092\u4f5c\u6210\u3057\u3001\u4eee\u60f3HDD\u3078\u5b9f\u969b\u306b\u53cd\u6620\u3055\u305b\u308b\u3002\n    - \u30cd\u30a4\u30c6\u30a3\u30d6EFI\u30b7\u30b9\u30c6\u30e0\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u306e\u30b5\u30a4\u30ba\u306f[EFI \u30b7\u30b9\u30c6\u30e0\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3 \\- ArchWiki](https://wiki.archlinuxjp.org/index.php/EFI_%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E3%83%91%E3%83%BC%E3%83%86%E3%82%A3%E3%82%B7%E3%83%A7%E3%83%B3)\u3067512MiB\u304c\u63a8\u5968\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n- \u4f5c\u6210\u3057\u305f\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u306bboot\u304a\u3088\u3073esp\u30d5\u30e9\u30b0\u3092\u7acb\u3066\u308b\u3002\n- \u3064\u3044\u3067\u306bext4\u306eOS\u672c\u4f53\u7528\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u3068\u30011GiB\u7a0b\u5ea6\u306e\u30b9\u30ef\u30c3\u30d7\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u3092\u4f5c\u308b\u3002\u672b\u5c3e\u306b\u306f1MiB\u7a7a\u304d\u9818\u57df\u3092\u53d6\u3089\u308c\u308b\u304c\u4ed5\u65b9\u306a\u3044\u3002\n- \u753b\u9762\u89e3\u50cf\u5ea6\u3092\u7e261024\u30d4\u30af\u30bb\u30eb\u4ee5\u4e0a\u306b\u3059\u308b\u3002\n- \u30c7\u30b9\u30af\u30c8\u30c3\u30d7\u4e0a\u306b\u3042\u308b\u30a4\u30f3\u30b9\u30c8\u30fc\u30e9\u30fc\u3092\u8d77\u52d5\u3059\u308b\u3002\n- \u300c\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u306e\u7a2e\u985e\u300d\u753b\u9762\u3067\u300c\u305d\u308c\u4ee5\u5916\u300d\u3092\u9078\u3073\u3001\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u3092\u30ab\u30b9\u30bf\u30de\u30a4\u30ba\u3067\u304d\u308b\u30eb\u30fc\u30c8\u306b\u5165\u308b\u3002\n- \u3055\u304d\u307b\u3069\u4f5c\u6210\u3057\u305f\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u306b\u3001\u30bf\u30a4\u30d7\u6b04\u3067EFI\u304c\u6307\u5b9a\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3059\u308b\u3002\n- ext4\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u3092\u30eb\u30fc\u30c8(/)\u306e\u30de\u30a6\u30f3\u30c8\u30dd\u30a4\u30f3\u30c8\u3068\u3057\u3066\u6307\u5b9a\u3059\u308b\u3002\n\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u304c\u7d42\u308f\u3063\u305f\u3089\u518d\u8d77\u52d5\u305b\u305a\u306b\u3001\u30e9\u30a4\u30d6OS\u4e0a\u3067\u4f5c\u696d\u3057\u307e\u3059\u3002\u7aef\u672b\u3092\u7acb\u3061\u4e0a\u3052\u6b21\u306e\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3057\u307e\u3059\u3002\n\n```\nsudo mount /dev/sda1 /mnt\nsudo ls -la /mnt/EFI/ubuntu # grubx64.efi\u3092\u78ba\u8a8d\nsudo mkdir /mnt/EFI/BOOT\nsudo cp /mnt/EFI/ubuntu/grubx64.efi\n/mnt/EFI/BOOT/BOOTX64.EFI\n```\n\n\u3053\u308c\u306fOVMF\u304cgrubx64.efi\u304b\u3089\u30d6\u30fc\u30c8\u3057\u3066\u304f\u308c\u306a\u3044\u305f\u3081\u3001grubx64.efi\u3092BOOTX64.EFI\u306b\u30b3\u30d4\u30fc\u3059\u308b\u30b3\u30de\u30f3\u30c9\u3067\u3059\u3002\u30b3\u30d4\u30fc\u304c\u5b8c\u4e86\u3057\u305f\u3089\u518d\u8d77\u52d5\u3057\u307e\u3059\u3002\u4eee\u60f3HDD\u306b\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u305fUbuntu\u304b\u3089\u30d6\u30fc\u30c8\u3059\u308b\u306f\u305a\u3067\u3059\u3002\n\n## IOMMU\u3092\u6709\u52b9\u306b\u3059\u308b\n### \u6e96\u5099\nBIOS\u3067VT-d\u3092\u6709\u52b9\u306b\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n### \u8a2d\u5b9a\n```\n# nano /etc/default/grub\nGRUB_CMDLINE_LINUX_DEFAULT=\"quiet\"\n\u2193\nGRUB_CMDLINE_LINUX_DEFAULT=\"quiet intel_iommu=on\"\n\n# update-grub\n```\nAMD\u306eCPU\u306e\u5834\u5408intel_iommu\u306b\u4ee3\u3048\u3066amd_iommu\u3068\u3057\u307e\u3059\u3002update-grub\u3092\u5fd8\u308c\u306a\u3044\u3067\u304f\u3060\u3055\u3044\u3002\n\n### \u78ba\u8a8d\uff08\u8981\u518d\u8d77\u52d5\uff09\n```\n# dmesg | grep -e DMAR -e IOMMU\n[    0.000000] DMAR: IOMMU enabled\n```\n\n## x2APIC\u3092\u6709\u52b9\u306b\u3059\u308b\n### \u6e96\u5099\nBIOS\u3067x2APIC\u3092\u6709\u52b9\u306b\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n### \u78ba\u8a8d\n```\n# dmesg | grep -e DMAR -e IOMMU\n[    0.061698] DMAR-IR: x2apic is disabled because BIOS sets x2apic opt out bit.\n[    0.061699] DMAR-IR: Use 'intremap=no_x2apic_optout' to override the BIOS setting.\n[    0.063089] DMAR-IR: Enabled IRQ remapping in xapic mode\n```\nBIOS\u3067\u6709\u52b9\u306b\u3067\u304d\u306a\u304b\u3063\u305f\u5834\u5408\u3001\u3053\u306e\u3088\u3046\u306b\u300cx2apic is disabled\u300d\u3068\u8868\u793a\u3055\u308c\u307e\u3059\u3002\u305d\u306e\u5834\u5408\u3001\u4ee5\u4e0b\u306e\u8a2d\u5b9a\u3092\u884c\u3044\u307e\u3059\u3002\n\n### \u8a2d\u5b9a\n```\n# nano /etc/default/grub\nGRUB_CMDLINE_LINUX_DEFAULT=\"quiet intel_iommu=on\"\n\u2193\nGRUB_CMDLINE_LINUX_DEFAULT=\"quiet intel_iommu=on intremap=no_x2apic_optout\"\n\n# update-grub\n```\nupdate-grub\u3092\u5fd8\u308c\u306a\u3044\u3067\u304f\u3060\u3055\u3044\u3002\n\n### \u78ba\u8a8d\uff08\u8981\u518d\u8d77\u52d5\uff09\n```\n[    0.060882] DMAR-IR: Queued invalidation will be enabled to support x2apic and Intr-remapping.\n[    0.062304] DMAR-IR: Enabled IRQ remapping in x2apic mode\n```\n\n## \u30ab\u30fc\u30cd\u30eb\u30e2\u30b8\u30e5\u30fc\u30eb\u3092\u7d44\u307f\u8fbc\u3080\n```\n# echo -e \"vfio\\nvfio_iommu_type1\\nvfio_pci\\nvfio_virqfd\" >> /etc/modules\n```\n\n## \u30d3\u30c7\u30aa\u30ab\u30fc\u30c9\u306ePCI\u30a2\u30c9\u30ec\u30b9\u3092\u78ba\u8a8d\u3059\u308b\n```\n# for iommu_group in $(find /sys/kernel/iommu_groups/ -maxdepth 1 -mindepth 1 -type d); do echo \"IOMMU group $(basename \"$iommu_group\")\"; for device in $(ls -1 \"$iommu_group\"/devices/); do echo -n $'\\t'; lspci -nns \"$device\"; done; done\nIOMMU group 1\n        00:01.0 PCI bridge [0604]: Intel Corporation Sky Lake PCIe Controller (x16) [8086:1901] (rev 07)\n        01:00.0 VGA compatible controller [0300]: NVIDIA Corporation Device [10de:128b] (rev a1)\n        01:00.1 Audio device [0403]: NVIDIA Corporation GK208 HDMI/DP Audio Controller [10de:0e0f] (rev a1)\n```\n\n## \u30d3\u30c7\u30aa\u30ab\u30fc\u30c9\u3092vfio-pci\u306b\u6e21\u3059\n### \u8a2d\u5b9a\n```\n# echo options vfio-pci ids=10de:128b,10de:0e0f > /etc/modprobe.d/vfio.conf\n```\n\n### \u78ba\u8a8d\uff08\u8981\u518d\u8d77\u52d5\uff09\n```\n# dmesg | grep -i vfio\n[    2.013295] VFIO - User Level meta-driver version: 0.3\n[    2.039844] vfio_pci: add [10de:128b[ffff:ffff]] class 0x000000/00000000\n[    2.055799] vfio_pci: add [10de:0e0f[ffff:ffff]] class 0x000000/00000000\n```\n\n## \u30d3\u30c7\u30aa\u30ab\u30fc\u30c9\u306e\u30c9\u30e9\u30a4\u30d0\u30fc\u3092\u7121\u52b9\u306b\u3059\u308b\n```\n# echo -e \"blacklist radeon\\nblacklist nouveau\\nblacklist nvidia\" >> /etc/modprobe.d/blacklist.conf\n```\n\n## VM\u306b\u30d1\u30b9\u30b9\u30eb\u30fc\u3092\u8a2d\u5b9a\u3059\u308b\n```\n# nano /etc/pve/nodes/hostname/qemu-server/100.conf\ncpu: host\nhostpci0: 01:00.0,x-vga=on\nhostpci1: 01:00.1\nusb0: host=1-3\nusb1: host=1-4\n```\n\u6700\u8fd1\u306f\u30de\u30b7\u30f3\u3092q35\u306b\u3057\u3001pcie=1\u3092\u8a2d\u5b9a\u3059\u308b\u5fc5\u8981\u306f\u306a\u3044\u3088\u3046\u3067\u3059\u3002\n\nUSB\u306e\u30d1\u30b9\u30b9\u30eb\u30fc\u306f[USB physical port mapping \\- Proxmox VE](https://pve.proxmox.com/wiki/USB_physical_port_mapping)\u3092\u53c2\u7167\u3002\n\n## VM\u306e\u8d77\u52d5\u30b3\u30de\u30f3\u30c9\u3092\u78ba\u8a8d\u3059\u308b\n```\n# qm showcmd 100\n/usr/bin/kvm -id 100 -chardev socket,id=qmp,path=/var/run/qemu-server/100.qmp,server,nowait -mon chardev=qmp,mode=control -pidfile /var/run/qemu-server/100.pid -daemonize -smbios type=1,uuid=a925fcc5-0805-44ad-8b69-c6981816109a -drive if=pflash,format=raw,readonly,file=/usr/share/kvm/OVMF-pure-efi.fd -drive if=pflash,format=raw,file=/tmp/100-OVMF_VARS-pure-efi.fd -name win10 -smp 2,sockets=1,cores=2,maxcpus=2 -nodefaults -boot menu=on,strict=on,reboot-timeout=1000 -vga none -nographic -no-hpet -cpu host,hv_vendor_id=proxmox,hv_spinlocks=0x1fff,hv_vapic,hv_time,hv_reset,hv_vpindex,hv_runtime,hv_relaxed,+kvm_pv_unhalt,+kvm_pv_eoi,kvm=off -m 16384 -k ja -device pci-bridge,id=pci.2,chassis_nr=2,bus=pci.0,addr=0x1f -device pci-bridge,id=pci.1,chassis_nr=1,bus=pci.0,addr=0x1e -device piix3-usb-uhci,id=uhci,bus=pci.0,addr=0x1.0x2 -readconfig /usr/share/qemu-server/pve-usb.cfg -device usb-tablet,id=tablet,bus=uhci.0,port=1 -device vfio-pci,host=01:00.0,id=hostpci0,bus=pci.0,addr=0x10 -device vfio-pci,host=01:00.1,id=hostpci1,bus=pci.0,addr=0x11 -device usb-host,hostbus=1,hostport=3,id=usb0 -device usb-host,hostbus=1,hostport=4,id=usb1 -device virtio-balloon-pci,id=balloon0,bus=pci.0,addr=0x3 -iscsi initiator-name=iqn.1993-08.org.debian:01:cad28f461da5 -drive file=/dev/pve/vm-100-disk-1,if=none,id=drive-ide0,format=raw,cache=none,aio=native,detect-zeroes=on -device ide-hd,bus=ide.0,unit=0,drive=drive-ide0,id=ide0,bootindex=100 -drive file=/var/lib/vz/template/iso/Windows10.iso,if=none,id=drive-ide2,media=cdrom,aio=threads -device ide-cd,bus=ide.1,unit=0,drive=drive-ide2,id=ide2 -netdev type=tap,id=net0,ifname=tap100i0,script=/var/lib/qemu-server/pve-bridge,downscript=/var/lib/qemu-server/pve-bridgedown -device e1000,mac=1A:01:70:2D:27:49,netdev=net0,bus=pci.0,addr=0x12,id=net0 -rtc driftfix=slew,base=localtime -global kvm-pit.lost_tick_policy=discard\n```\nhv_vendor_id=proxmox\u306fNVIDIA\u306e\u30b3\u30fc\u30c943\u5bfe\u7b56\u3002NVIDIA\u306eWindows\u7528\u30c9\u30e9\u30a4\u30d0\u30fc\u306f\u3001\u4eee\u60f3\u30de\u30b7\u30f3\u4e0a\u3067\u3042\u308b\u3053\u3068\u3092\u691c\u77e5\u3059\u308b\u3068\u505c\u6b62\u3059\u308b\u305f\u3081\u3001\u305d\u308c\u3078\u306e\u5bfe\u7b56\u3067\u3059\u3002\u3057\u304b\u3057\u3001\u624b\u5143\u306e\u74b0\u5883\u3067\u306f\u3053\u306e\u5bfe\u7b56\u3092\u3057\u3066\u3044\u3066\u3082\u30b3\u30fc\u30c943\u3092\u56de\u907f\u3067\u304d\u307e\u305b\u3093\u3067\u3057\u305f\u3002\n\n## VM\u3092\u8d77\u52d5\u30fb\u505c\u6b62\u3059\u308b\n```\n# qm start 100\n# qm stop 100\n```\nWebUI\u304b\u3089\u884c\u3063\u3066\u3082\u69cb\u3044\u307e\u305b\u3093\u3002\u3081\u3067\u305f\u304f\u30d3\u30c7\u30aa\u30ab\u30fc\u30c9\u3092\u30d1\u30b9\u30b9\u30eb\u30fc\u3067\u304d\u308b\u306f\u305a\u3067\u3059\u3002\n\n## Radeon\u3067VM\u3092\u518d\u8d77\u52d5\u3067\u304d\u306a\u3044\u554f\u984c\nRadeon\u306b\u306fVM\u3092\u518d\u8d77\u52d5\u3067\u304d\u306a\u3044\u554f\u984c\u304c\u3042\u308b\u3088\u3046\u3067\u3059\u3002\u624b\u5143\u306e\u74b0\u5883\u3067\u306f\u78ba\u8a8d\u3067\u304d\u307e\u305b\u3093\u3067\u3057\u305f\u304c\u3054\u6ce8\u610f\u304f\u3060\u3055\u3044\u3002\n\n\u53c2\u8003: [ESXi 6\\.0u1 GPU\u30d1\u30b9\u30b9\u30eb\u30fc\u3067VM\u518d\u8d77\u52d5\u3067\u304d\u306a\u3044\u554f\u984c\u306e\u89e3\u6c7a\uff5cHaioH\uff1a\u5909\u9077\u5099\u5fd8\u9332](http://silver0480.blog80.fc2.com/blog-entry-411.html)\n", "tags": ["proxmox", "KVM"]}