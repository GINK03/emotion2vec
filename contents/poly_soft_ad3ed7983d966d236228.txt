{"context": "Facebook Messenger Platform\u3084LINE BOT\u304c\u8a71\u984c\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u304c\u3001\u4e0b\u8a18\u306e\u8a18\u4e8b\u3067\u3082\u8a00\u53ca\u3055\u308c\u3066\u3044\u308b\u3088\u3046\u306b\u3001BOT\u30b5\u30fc\u30d0\u30fc\u3068\u3057\u3066\u5927\u91cf\u30e1\u30c3\u30bb\u30fc\u30b8\u306b\u5bfe\u5fdc\u3059\u308b\u306b\u306f\u300c\u4e26\u884c\u51e6\u7406\u300d\u304c\u30ad\u30e2\u306b\u306a\u3063\u3066\u304d\u307e\u3059\u3002\n\u5927\u91cf\u30e1\u30c3\u30bb\u30fc\u30b8\u304c\u6765\u3066\u3082\u5b89\u5fc3\u306aLINE BOT\u30b5\u30fc\u30d0\u306e\u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3\n\u305d\u3057\u3066Elixir\u3068\u3044\u3048\u3070\u3084\u3063\u3071\u308a\u300c\u4e26\u884c\u51e6\u7406\u300d\u306a\u308f\u3051\u3067\u3059\u3002\u3068\u3044\u3046\u3053\u3068\u3067\u300cBOT\u30b5\u30fc\u30d0\u30fc\u3092\u52b9\u7387\u3088\u304f\u958b\u767a\u3059\u308b\u306b\u306fElixir/Phoenix\u3063\u3066\u3068\u3066\u3082\u826f\u3044\u9078\u629e\u306a\u306e\u3067\u306f\uff1f\u300d\u3068\u3044\u3046\u4eee\u5b9a\u306e\u3082\u3068\u3001\u8272\u3005\u3068\u691c\u8a3c\u3057\u3066\u307f\u307e\u3057\u305f\u3002\n\n\u4e26\u884c\u51e6\u7406\u306e\u30b3\u30fc\u30c9\nElixir\u3067\u30d7\u30ed\u30bb\u30b9\u3092\u8d77\u52d5\u30fb\u7ba1\u7406\u3059\u308b\u65b9\u6cd5\u306f\u3044\u304f\u3064\u3082\u7528\u610f\u3055\u308c\u3066\u3044\u307e\u3059\u304c\u3001BOT\u30b5\u30fc\u30d0\u30fc\u306e\u8981\u4ef6\u7684\u306b\u300c\u72b6\u614b\u300d\u3092\u7ba1\u7406\u3059\u308b\u5fc5\u8981\u306f\u3042\u308a\u307e\u305b\u3093\u3057\u3001\u30d7\u30ed\u30bb\u30b9\u304b\u3089\u300c\u623b\u308a\u5024\u300d\u3092\u8fd4\u3057\u3066\u3082\u3089\u3046\u5fc5\u8981\u3082\u3042\u308a\u307e\u305b\u3093\u3002\u8981\u3059\u308b\u306b\u30d7\u30ed\u30bb\u30b9\u306f\u300c\u4f7f\u3044\u6368\u3066\u300d\u3068\u3044\u3046\u304b\u3001\u5b9f\u884c\u304c\u7d42\u308f\u3063\u305f\u3089\u52dd\u624b\u306b\u7d42\u4e86\u3057\u3066\u304f\u308c\u308c\u3070\u305d\u308c\u3067\u30aa\u30c3\u30b1\u30fc\u306a\u308f\u3051\u3067\u3059\u3002\n\u3053\u306e\u8981\u4ef6\u306b\u30d4\u30c3\u30bf\u30ea\u306a\u306e\u306fTask\u3068Task.Supervisor\u3060\u3068\u601d\u3044\u307e\u3059\u306e\u3067\u3001\u3053\u308c\u3092\u4f7f\u3063\u3066\u307f\u308b\u3053\u3068\u306b\u3057\u307e\u3059\u3002\n\u307e\u305f\u3001LINE BOT\u306e\u5834\u5408\u30011\u3064\u306e\u30ea\u30af\u30a8\u30b9\u30c8\u306b\u6700\u5927\u3067100\u30e1\u30c3\u30bb\u30fc\u30b8\u304c\u542b\u307e\u308c\u308b\u3068\u306e\u3053\u3068\u306a\u306e\u3067\u3001\u30ab\u30f3\u30de\u533a\u5207\u308a\u3067\u8907\u6570\u306e\u30e1\u30c3\u30bb\u30fc\u30b8\u304c\u6e21\u3055\u308c\u308b\u3053\u3068\u3092\u524d\u63d0\u3068\u3057\u305f\u30a2\u30af\u30b7\u30e7\u30f3\u3092\u5b9a\u7fa9\u3057\u3066\u3001\u305d\u3053\u304b\u3089\u4e26\u884c\u51e6\u7406\u306e\u30b3\u30fc\u30c9\u3092\u547c\u3073\u51fa\u3059\u3088\u3046\u306b\u3057\u3066\u307f\u307e\u3059\u3002\n\u305d\u3093\u306a\u611f\u3058\u3067\u4e0b\u8a18\u306e\u3088\u3046\u306a\u30b3\u30fc\u30c9\u3092\u5b9a\u7fa9\u3057\u3066\u307f\u307e\u3057\u305f\u3002\n\nweb/router.ex\ndefmodule BotSample.Router do\n  ...\n  scope \"/\", BotSample do\n    ...\n    post \"/callback\", PageController, :callback\n  end\nend\n\n\n\nweb/controllers/page_controller.ex\ndefmodule BotSample.PageController do\n  ...\n  def callback(conn, %{\"messages\" => messages} = _params) do\n    Bot.process_messages(messages)\n    json conn, %{ok: \"ok\"}\n  end\nend\n\n\n\nlib/bot_sample.ex\ndefmodule BotSample do\n  use Application\n  def start(_type, _args) do\n    ...\n    children = [\n      ...\n      supervisor(Task.Supervisor, [[name: BotSample.BotTaskSupervisor]]),\n    ]\n  end\nend\n\n\n\nlib/bot_sample/bot.ex\ndefmodule BotSample.Bot do\n  alias BotSample.Repo\n\n  def process_messages(messages) when is_binary(messages) do\n    Task.Supervisor.start_child(BotSample.BotTaskSupervisor, fn -> do_process_messages(messages) end)\n  end\n\n  defp do_process_messages(messages) when is_binary(messages) do\n    Enum.each String.split(messages, \",\"), fn(message) ->\n      Task.Supervisor.start_child(BotSample.BotTaskSupervisor, fn -> process_message(message) end)\n    end\n  end\n\n  defp process_message(message) when is_binary(message) do\n    IO.puts \"message = #{inspect message}\"\n  end\nend\n\n\n\nconfig/dev.exs\nconfig :logger, :console, format: \"[$level] $message\\n\", level: :error\n\n\n\u3042\u304f\u307e\u3067\u691c\u8a3c\u7528\u306a\u306e\u3067\u3054\u304f\u3054\u304f\u7c21\u5358\u306a\u30b3\u30fc\u30c9\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002Elixir\u306eLogger\u306e:sync_threshold\u306e\u4ed5\u69d8\u306b\u3088\u308b\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u3078\u306e\u5f71\u97ff\u3092\u6392\u9664\u3059\u308b\u305f\u3081\u306b\u3001logger\u306e\u51fa\u529b\u30ec\u30d9\u30eb\u306f:info\u3067\u306f\u306a\u304f:error\u306b\u8a2d\u5b9a\u3057\u3066\u3044\u307e\u3059\u3002(\u8a73\u3057\u304f\u306f\u3053\u3061\u3089\u3092\u3054\u53c2\u7167\u304f\u3060\u3055\u3044)\n\n\u30d9\u30f3\u30c1\u30de\u30fc\u30af\u7528\u306e\u30c4\u30fc\u30eb\n\u30d9\u30f3\u30c1\u30de\u30fc\u30af\u3068\u3044\u3046\u304b\u8ca0\u8377\u691c\u8a3c\u7528\u306e\u30c4\u30fc\u30eb\u3068\u3057\u3066\u306f\u3001Phoenix\u3068Rails\u306e\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u6bd4\u8f03\u8a18\u4e8b\u3067\u3082\u7d39\u4ecb\u3055\u308c\u3066\u3044\u305fwrk\u3068\u3044\u3046\u30c4\u30fc\u30eb\u3092\u4f7f\u3063\u3066\u307f\u307e\u3057\u305f\u3002\n\u30d9\u30f3\u30c1\u30de\u30fc\u30af\u30c4\u30fc\u30eb\"wrk\"\u3067\u81ea\u7531\u306b\u30ea\u30af\u30a8\u30b9\u30c8\u3092\u9001\u308b\nPOST\u30e1\u30bd\u30c3\u30c9\u3067JSON\u5f62\u5f0f\u306e\u30ea\u30af\u30a8\u30b9\u30c8\u3092\u9001\u4fe1\u3057\u305f\u3044\u306e\u3067\u3001\u4e0b\u8a18\u306e\u3088\u3046\u306a\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092\u7528\u610f\u3057\u307e\u3059\u3002\n-- wrk.lua\nwrk.method = \"POST\"\nwrk.body = '{\"messages\":\"1,2,3,4,5,6,7,8,9,10\"}'\nwrk.headers[\"Content-Type\"] = \"application/json\"\nwrk.headers[\"Accept\"] = \"application/json\"\n\n\n\u30e2\u30cb\u30bf\u30ea\u30f3\u30b0\u7528\u306e\u30c4\u30fc\u30eb\n\u691c\u8a3c\u30b9\u30af\u30ea\u30d7\u30c8\u5b9f\u884c\u4e2d\u306eCPU\u3084\u30d7\u30ed\u30bb\u30b9\u6570\u7b49\u306e\u72b6\u6cc1\u3092\u78ba\u8a8d\u3059\u308b\u305f\u3081\u306b\u3001\u4e0b\u8a18\u306e\u8a18\u4e8b\u3067\u7d39\u4ecb\u3055\u308c\u3066\u3044\u308bex_top\u3068\u3044\u3046\u30c4\u30fc\u30eb\u3092\u4f7f\u7528\u3057\u307e\u3057\u305f\u3002\nElixir\u3067\u30d7\u30ed\u30bb\u30b920\u4e07\u304f\u3089\u3044\u4f5c\u3063\u3066\u307f\u305f\n\n\u691c\u8a3c\u7528\u306e\u30b5\u30fc\u30d0\u30fc\n\u4e26\u884c\u51e6\u7406\u306b\u95a2\u3059\u308b\u52d5\u4f5c\u3092\u691c\u8a3c\u3059\u308b\u3053\u3068\u304c\u76ee\u7684\u306a\u306e\u3067\u3001CPU\u306e\u30b3\u30a2\u6570\u304c\u591a\u3081\u306e\u30b5\u30fc\u30d0\u30fc\u3092\u4f7f\u7528\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\u307e\u305f\u3001wrk\u306b\u3088\u308b\u30ea\u30af\u30a8\u30b9\u30c8\u3092\u9001\u4fe1\u3059\u308b\u30b5\u30fc\u30d0\u30fc\u3068\u3001Elixir/Phoenix\u3067\u30ea\u30af\u30a8\u30b9\u30c8\u3092\u51e6\u7406\u3059\u308b\u30b5\u30fc\u30d0\u30fc\u306f\u5225\u3005\u306b\u7528\u610f\u3057\u307e\u3059\u3002\n\u3053\u306e\u691c\u8a3c\u4f5c\u696d\u306b\u304a\u3044\u3066\u306f\u3001\u4e0b\u8a18\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u30bf\u30a4\u30d7\u306eEC2\u30922\u53f0\u4f7f\u7528\u3057\u307e\u3057\u305f\u3002\n\n\n\n\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u30bf\u30a4\u30d7\nvCPU\n\u30e1\u30e2\u30ea\n\n\n\n\nc4.2xlarge\n\u30008\n\u300015GiB\u3000\n\n\n\n\n\u691c\u8a3c1\n\u307e\u305a\u3001\u691c\u8a3c\u7528\u306e\u30b5\u30fc\u30d0\u30fc\u3067Phoenix\u3092\u8d77\u52d5\u3057\u307e\u3059\u3002\u30d9\u30f3\u30c1\u30de\u30fc\u30af\u3060\u3051\u306a\u3089\u666e\u901a\u306bmix phoenix.server\u3067\u8d77\u52d5\u3057\u3066\u3082\u826f\u3044\u306e\u3067\u3059\u304c\u3001ex_top\u3092\u4f7f\u7528\u3059\u308b\u5834\u5408\u306f\u30ce\u30fc\u30c9\u540d\u3092\u660e\u793a\u7684\u306b\u6307\u5b9a\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u306e\u3067\u4e0b\u8a18\u306e\u3088\u3046\u306a\u30b3\u30de\u30f3\u30c9\u3067\u8d77\u52d5\u3057\u307e\u3059\u3002\niex --sname bar@localhost -S mix phoenix.server\n\n\u7d9a\u3044\u3066ex_top\u3092\u8d77\u52d5\u3057\u307e\u3059\u3002\u691c\u8a3c\u7528\u30b5\u30fc\u30d0\u30fc\u306eex_top\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u305f\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3067\u4e0b\u8a18\u306e\u3088\u3046\u306a\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3057\u307e\u3059\u3002\n./ex_top bar@localhost\n\nex_top\u3092\u5b9f\u884c\u3059\u308b\u3068\u3001\u74b0\u5883\u306b\u3082\u3088\u308a\u307e\u3059\u304c8\u30b3\u30a2\u306e\u30b5\u30fc\u30d0\u30fc\u3060\u3068\u4e0b\u8a18\u306e\u3088\u3046\u306a\u753b\u9762\u304c\u8868\u793a\u3055\u308c\u308b\u3068\u601d\u3044\u307e\u3059\u3002\n\n\u5de6\u4e0a\u306e\u9818\u57df\u3067CPU\u306e\u5404\u30b3\u30a2\u306e\u4f7f\u7528\u72b6\u6cc1\u3001\u53f3\u4e0a\u306e\u300cStatistics\u300d\u306e\u9818\u57df\u3067\u30d7\u30ed\u30bb\u30b9\u6570\u7b49\u3092\u30e2\u30cb\u30bf\u30ea\u30f3\u30b0\u3059\u308b\u3053\u3068\u304c\u51fa\u6765\u307e\u3059\u3002\n\u6b21\u306b\u3001\u30ea\u30af\u30a8\u30b9\u30c8\u3092\u9001\u4fe1\u3059\u308b\u5074\u306e\u30b5\u30fc\u30d0\u30fc\u3067\u4e0b\u8a18\u306e\u3088\u3046\u306awrk\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3057\u307e\u3059\u3002(\u30db\u30b9\u30c8\u306e\u90e8\u5206\u306fPhoenix\u304c\u5b9f\u884c\u3055\u308c\u3066\u3044\u308b\u30b5\u30fc\u30d0\u30fc\u306eIP\u3092\u6307\u5b9a\u3057\u307e\u3059)\nwrk -c 8 -t 8 -d 30 -s ./wrk.lua http://\u30db\u30b9\u30c8:4000/callback\n\n1\u30ea\u30af\u30a8\u30b9\u30c8\u306b10\u30e1\u30c3\u30bb\u30fc\u30b8\u304c\u542b\u307e\u308c\u308b\u72b6\u614b\u3067\u4e0a\u8a18\u306e\u30b3\u30fc\u30c9\u3092\u5b9f\u884c\u3059\u308b\u3068\u3001\u79c1\u306e\u69cb\u7bc9\u3057\u305f\u74b0\u5883\u3060\u30684800req/sec\u3068\u3044\u3046\u7d50\u679c\u306b\u306a\u308a\u307e\u3057\u305f\u3002\u8981\u3059\u308b\u306b\u3053\u306e\u30b5\u30fc\u30d0\u30fc\u30b9\u30da\u30c3\u30af\u3060\u3068\u3001\u3054\u304f\u77ed\u3044\u51e6\u7406\u3067\u3042\u308c\u3070(1\u30ea\u30af\u30a8\u30b9\u30c8\u306b10\u30e1\u30c3\u30bb\u30fc\u30b8\u304c\u542b\u307e\u308c\u3066\u3044\u308b\u306e\u3067)\u79d2\u959348000\u30e1\u30c3\u30bb\u30fc\u30b8\u306b\u5bfe\u5fdc\u51fa\u6765\u308b\u3068\u3044\u3046\u3053\u3068\u306b\u306a\u308a\u307e\u3059\u3002\n\n\u691c\u8a3c2\n\u3055\u3066\u3001\u4e0a\u8a18\u306eBotSample.Bot.process_message/1\u306e\u51e6\u7406\u5185\u3067\u306f\u3001\u5b9f\u969b\u306b\u306f\u30d7\u30e9\u30c3\u30c8\u30d5\u30a9\u30fc\u30e0\u5074\u306eAPI\u3092\u547c\u3073\u51fa\u3059\u3053\u3068\u306b\u306a\u308a\u307e\u3059\u3002\n\u5916\u90e8API\u306e\u5b9f\u884c\u306b\u95a2\u3057\u3066\u306f\u3001\u3055\u3059\u304c\u306b\u623b\u308a\u5024(\u30b9\u30c6\u30fc\u30bf\u30b9\u30b3\u30fc\u30c9\u3084\u30ec\u30b9\u30dd\u30f3\u30b9\u30dc\u30c7\u30a3)\u3092\u30c1\u30a7\u30c3\u30af\u3057\u306a\u3044\u308f\u3051\u306b\u306f\u3044\u304b\u306a\u3044\u3068\u601d\u3044\u307e\u3059\u306e\u3067\u3001\u30ec\u30b9\u30dd\u30f3\u30b9\u304c\u8fd4\u3055\u308c\u308b\u307e\u3067\u5f85\u3064\u3053\u3068\u306b\u306a\u308a\u307e\u3059\u304c\u3001\u3053\u306e\u623b\u308a\u6642\u9593\u3092\u5c11\u3005\u53b3\u3057\u76ee\u306b\u300c\u5e73\u57472\u79d2\u301c3\u79d2\u300d\u3068\u4eee\u5b9a\u3057\u3066\u3001BotSample.Bot.process_message/1\u95a2\u6570\u306b\u4e0b\u8a18\u306e\u3088\u3046\u306asleep\u51e6\u7406\u3092\u8ffd\u52a0\u3057\u3066\u307f\u307e\u3059\u3002\ndefp process_message(message) when is_binary(message) do\n  :timer.sleep(Enum.random(2000..3000))\n  IO.puts \"message = #{inspect message}\"\nend\n\n\u3053\u306e\u72b6\u614b\u3067\u3001\u5148\u307b\u3069\u3068\u540c\u3058wrk\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3057\u3066\u307f\u308b\u3068\u3001\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u306f750req/sec\u3042\u305f\u308a\u307e\u3067\u60aa\u5316\u3057\u307e\u3057\u305f\u3002\n\u3055\u3089\u306b\u5404CPU\u30b3\u30a2\u306e\u4f7f\u7528\u7387\u3082100%\u306b\u306a\u308a\u3001\u30d7\u30ed\u30bb\u30b9\u6570\u308220000\u7a0b\u5ea6\u306b\u306a\u308a\u307e\u3059\u3002(sleep\u51e6\u7406\u3092\u5165\u308c\u308b\u524d\u306e\u30c6\u30b9\u30c8\u3060\u3068300\u7a0b\u5ea6)\n\u8981\u3059\u308b\u306b\u5916\u90e8API\u547c\u3073\u51fa\u3057\u306b\u5e73\u57472\u301c3\u79d2\u5fc5\u8981\u306b\u306a\u308b\u3068\u60f3\u5b9a\u3059\u308b\u3068\u3001\u3053\u306e\u30b5\u30fc\u30d0\u30fc1\u53f0\u3067\u51e6\u7406\u51fa\u6765\u308b\u79d2\u9593\u30e1\u30c3\u30bb\u30fc\u30b8\u6570\u306f7000\u7a0b\u5ea6\u3001\u3057\u304b\u3082CPU\u306e\u4f7f\u7528\u7387\u304b\u3089\u8003\u3048\u308b\u3068\u3001\u9577\u671f\u9593\u5b89\u5b9a\u3057\u3066\u51e6\u7406\u3092\u884c\u3048\u308b\u79d2\u9593\u30e1\u30c3\u30bb\u30fc\u30b8\u6570\u306f\u3053\u308c\u3088\u308a\u3082\u304b\u306a\u308a\u5c11\u306a\u304f\u306a\u308b\u3001\u3068\u3044\u3046\u3053\u3068\u306b\u306a\u308a\u305d\u3046\u3067\u3059\u3002\n\n\u691c\u8a3c3\n\u6b21\u306b\u3001\u30c7\u30fc\u30bf\u30b9\u30c8\u30a2\u3078\u306e\u30a2\u30af\u30bb\u30b9\u51e6\u7406\u3092\u8ffd\u52a0\u3057\u3066\u691c\u8a3c\u3092\u884c\u3063\u3066\u307f\u305f\u3044\u3068\u601d\u3044\u307e\u3059\u304c\u3001\u4e0a\u8a18\u306e\u5916\u90e8API\u547c\u3073\u51fa\u3057\u306b\u52a0\u3048\u3066\u3001BOT\u30b5\u30fc\u30d0\u30fc\u3067\u4e26\u884c\u51e6\u7406\u3092\u884c\u3046\u969b\u306b\u3082\u3046\u4e00\u3064\u5927\u304d\u306a\u30dc\u30c8\u30eb\u30cd\u30c3\u30af\u306b\u306a\u308b\u3068\u8003\u3048\u3089\u308c\u308b\u306e\u304c\u3001\u30c7\u30fc\u30bf\u30b9\u30c8\u30a2\u7528\u306e\u30b3\u30cd\u30af\u30b7\u30e7\u30f3\u30d7\u30fc\u30eb\u306e\u30d7\u30fc\u30eb\u30b5\u30a4\u30ba\u3067\u3059\u3002\n\u4f8b\u3048\u3070\u30c7\u30fc\u30bf\u30b9\u30c8\u30a2\u306bPostgresql\u3084MySQL\u3092\u4f7f\u7528\u3059\u308b\u5834\u5408\u3001Phoenix/Ecto\u306e\u30c7\u30d5\u30a9\u30eb\u30c8\u3067\u306f\u3001\u30d7\u30fc\u30eb\u30b5\u30a4\u30ba\u306f\u300c10\u300d\u306b\u8a2d\u5b9a\u3055\u308c\u3066\u3044\u307e\u3059\u304c\u3001\u3053\u306e\u30d7\u30fc\u30eb\u30b5\u30a4\u30ba\u3067\u4e26\u884c\u51e6\u7406\u3092\u884c\u304a\u3046\u3068\u3059\u308b\u3068timeout error\u304c\u591a\u767a\u3057\u3066\u3057\u307e\u3046\u306e\u3067\u4f7f\u3044\u3082\u306e\u306b\u306a\u308a\u307e\u305b\u3093\u3002\n\u3068\u3044\u3046\u3053\u3068\u3067\u3001\u5927\u304d\u3081\u306e\u30d7\u30fc\u30eb\u30b5\u30a4\u30ba(\u6570\u5343\u7a0b\u5ea6)\u3092\u8a2d\u5b9a\u3057\u3066\u691c\u8a3c\u3092\u884c\u3048\u308b\u3088\u3046\u306b\u3001\u30e1\u30e2\u30ea\u30b5\u30a4\u30ba\u304c\u5927\u304d\u3081\u306a\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u30b5\u30fc\u30d0\u30fc\u3092\u7528\u610f\u3057\u307e\u3059\u3002\n\u3053\u306e\u691c\u8a3c\u306b\u304a\u3044\u3066\u306f\u3001\u4e0b\u8a18\u306e\u3088\u3046\u306a\u30b9\u30da\u30c3\u30af\u306eRDS(MySQL)\u3092\u4f7f\u7528\u3057\u307e\u3057\u305f\u3002\n\n\n\n\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u30bf\u30a4\u30d7\nvCPU\n\u30e1\u30e2\u30ea\n\n\n\n\ndb.r3.2xlarge\n\u30008\n\u300061GiB\u3000\n\n\n\nRDS\u306eMySQL\u306emax_connections\u306f\u3001\u3053\u3061\u3089\u306e\u8a18\u4e8b\u3067\u89e3\u8aac\u3055\u308c\u3066\u3044\u308b\u3088\u3046\u306b\u300cDBInstanceClassMemory/12582880\u300d\u306b\u8a2d\u5b9a\u3055\u308c\u307e\u3059\u306e\u3067\u3001\u4e0a\u8a18\u30b9\u30da\u30c3\u30af\u306eRDS\u3060\u3068max_connections\u306f5100\u7a0b\u5ea6\u306b\u8a2d\u5b9a\u3055\u308c\u307e\u3059\u3002\nPhoenix\u5074\u3067\u306f\u3001\u4e0a\u8a18\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u3078\u306e\u63a5\u7d9a\u8a2d\u5b9a\u306epool_size\u3092\u4e0b\u8a18\u306e\u3088\u3046\u306b\u8a2d\u5b9a\u3057\u3066\u307f\u307e\u3059\u3002\n\nconfig/dev.exs\nconfig :bot_sample, BotSample.Repo,\n  ...\n  pool_size: 5000\n\n\nBotSample.Bot.process_message/1\u95a2\u6570\u3092\u4e0b\u8a18\u306e\u3088\u3046\u306b\u5909\u66f4\u3057\u307e\u3059\u3002\ndefp process_message(message) when is_binary(message) do\n  :timer.sleep(Enum.random(2000..3000))\n  {:ok, %{rows: rows}} = Ecto.Adapters.SQL.query(Repo, \"SELECT NOW()\", [])\n  IO.puts \"now = #{inspect rows}\"\nend\n\n\u3053\u306e\u72b6\u614b\u3067wrk\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3057\u3066\u307f\u308b\u3068\u3001\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u306f530req/sec\u307b\u3069\u306b\u306a\u308a\u307e\u3057\u305f\u3002\n\u307e\u305f\u3001\u30d7\u30fc\u30eb1\u3064\u3054\u3068\u306b\u30d7\u30ed\u30bb\u30b9\u304c\u8d77\u52d5\u3059\u308b\u3088\u3046\u3067\u3001\u5e73\u5e38\u6642\u3067\u3082\u30d7\u30ed\u30bb\u30b9\u6570\u304c5000\u8d85\u306b\u306a\u3063\u3066\u3057\u307e\u3044\u307e\u3059\u304c\u3001timeout error\u306f\u767a\u751f\u305b\u305a\u3001\u5168\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u6b63\u5e38\u306b\u51e6\u7406\u51fa\u6765\u307e\u3057\u305f\u3002\n\u5927\u304d\u306a\u9045\u5ef6\u3082\u767a\u751f\u3057\u307e\u305b\u3093\u3067\u3057\u305f\u306e\u3067\u3001\u30c7\u30fc\u30bf\u30b9\u30c8\u30a2\u306e\u30d7\u30fc\u30eb\u30b5\u30a4\u30ba\u304a\u3088\u3073\u6700\u5927\u540c\u6642\u63a5\u7d9a\u6570\u3092\u5341\u5206\u306b\u78ba\u4fdd\u3057\u3066\u304a\u3051\u3070\u3001\u4e26\u884c\u51e6\u7406\u306b\u5bfe\u3057\u3066\u5927\u304d\u306a\u5f71\u97ff\u3092\u4e0e\u3048\u305a\u306b\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u51e6\u7406\u51fa\u6765\u308b\u3053\u3068\u304c\u5206\u304b\u308a\u307e\u3057\u305f\u3002\n\n\u307e\u3068\u3081\nElixir/Phoenix\u3067BOT\u30b5\u30fc\u30d0\u30fc\u3092\u958b\u767a\u3059\u308b\u5834\u5408\u3001\u4e26\u884c\u51e6\u7406\u306b\u95a2\u3057\u3066\u306f\u4e0a\u8a18\u306e\u3088\u3046\u306bTask\u3068Task.Supervisor\u3092\u4f7f\u3048\u3070\u975e\u5e38\u306b\u7c21\u5358\u306b\u5b9f\u88c5\u51fa\u6765\u308b\u3053\u3068\u304c\u5206\u304b\u308a\u307e\u3057\u305f\u3002(\u4ed6\u306b\u3082\u8272\u3005\u3068\u3084\u308a\u65b9\u306f\u3042\u308b\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u304c)\n1\u53f0\u306e\u30b5\u30fc\u30d0\u30fc\u3067\u51e6\u7406\u51fa\u6765\u308b\u30e1\u30c3\u30bb\u30fc\u30b8\u6570/seq\u306b\u95a2\u3057\u3066\u306f\u3001\u4e0a\u8a18\u306e\u3088\u3046\u306b\u30dc\u30c8\u30eb\u30cd\u30c3\u30af\u306b\u306a\u308b\u51e6\u7406(\u5916\u90e8API\u30b3\u30fc\u30eb\u3084\u30c7\u30fc\u30bf\u30b9\u30c8\u30a2\u306e\u30d7\u30fc\u30eb\u30b5\u30a4\u30ba)\u306b\u95a2\u3059\u308b\u9069\u5f53\u306a\u30c0\u30df\u30fc\u30b3\u30fc\u30c9\u3092\u8ffd\u52a0\u3057\u3066\u3044\u3063\u3066\u3001wrk\u7b49\u306e\u30d9\u30f3\u30c1\u30de\u30fc\u30af\u30c4\u30fc\u30eb\u3067\u8ca0\u8377\u6e2c\u5b9a\u3092\u884c\u3048\u3070\u3001\u3042\u308b\u30b9\u30da\u30c3\u30af\u306e\u30b5\u30fc\u30d0\u30fc\u3067\u51e6\u7406\u3067\u304d\u308b\u30e1\u30c3\u30bb\u30fc\u30b8\u6570/seq\u3068\u3044\u3046\u306e\u306f\u304a\u304a\u3088\u305d\u7b97\u51fa\u51fa\u6765\u308b\u3068\u601d\u3044\u307e\u3059\u306e\u3067\u3001\u305d\u306e\u6570\u5024\u304a\u3088\u3073\u60f3\u5b9a\u3059\u308b\u30e1\u30c3\u30bb\u30fc\u30b8\u6570/seq\u3092\u5143\u306b\u3057\u3066\u5fc5\u8981\u306a\u30b5\u30fc\u30d0\u30fc\u53f0\u6570\u3092\u6c7a\u3081\u308b\u3001\u3068\u3044\u3046\u611f\u3058\u3067\u826f\u3055\u305d\u3046\u304b\u306a\u3068\u3002\n\n\u8ffd\u8a18\n\u4e26\u884c\u51e6\u7406\u306b\u95a2\u3057\u3066\u306f\u3042\u307e\u308a\u7d4c\u9a13\u304c\u306a\u3044\u305f\u3081\u3001\u8272\u3005\u304a\u304b\u3057\u306a\u70b9\u304c\u3042\u308b\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u3002\u30b3\u30e1\u30f3\u30c8\u6b04\u3067\u3054\u610f\u898b\u3084\u3054\u6307\u6458\u7b49\u9802\u3051\u307e\u3059\u3068\u5927\u5909\u3042\u308a\u304c\u305f\u3044\u3067\u3059\u3002\u3088\u308d\u3057\u304f\u304a\u9858\u3044\u7533\u3057\u4e0a\u3052\u307e\u3059m(__)m\nFacebook Messenger Platform\u3084LINE BOT\u304c\u8a71\u984c\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u304c\u3001\u4e0b\u8a18\u306e\u8a18\u4e8b\u3067\u3082\u8a00\u53ca\u3055\u308c\u3066\u3044\u308b\u3088\u3046\u306b\u3001BOT\u30b5\u30fc\u30d0\u30fc\u3068\u3057\u3066\u5927\u91cf\u30e1\u30c3\u30bb\u30fc\u30b8\u306b\u5bfe\u5fdc\u3059\u308b\u306b\u306f\u300c\u4e26\u884c\u51e6\u7406\u300d\u304c\u30ad\u30e2\u306b\u306a\u3063\u3066\u304d\u307e\u3059\u3002\n\n[\u5927\u91cf\u30e1\u30c3\u30bb\u30fc\u30b8\u304c\u6765\u3066\u3082\u5b89\u5fc3\u306aLINE BOT\u30b5\u30fc\u30d0\u306e\u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3](http://qiita.com/yoichiro@github/items/6d4c7309210af20a5c8f)\n\n\u305d\u3057\u3066Elixir\u3068\u3044\u3048\u3070\u3084\u3063\u3071\u308a\u300c\u4e26\u884c\u51e6\u7406\u300d\u306a\u308f\u3051\u3067\u3059\u3002\u3068\u3044\u3046\u3053\u3068\u3067\u300cBOT\u30b5\u30fc\u30d0\u30fc\u3092\u52b9\u7387\u3088\u304f\u958b\u767a\u3059\u308b\u306b\u306fElixir/Phoenix\u3063\u3066\u3068\u3066\u3082\u826f\u3044\u9078\u629e\u306a\u306e\u3067\u306f\uff1f\u300d\u3068\u3044\u3046\u4eee\u5b9a\u306e\u3082\u3068\u3001\u8272\u3005\u3068\u691c\u8a3c\u3057\u3066\u307f\u307e\u3057\u305f\u3002\n\n# \u4e26\u884c\u51e6\u7406\u306e\u30b3\u30fc\u30c9\n\nElixir\u3067\u30d7\u30ed\u30bb\u30b9\u3092\u8d77\u52d5\u30fb\u7ba1\u7406\u3059\u308b\u65b9\u6cd5\u306f\u3044\u304f\u3064\u3082\u7528\u610f\u3055\u308c\u3066\u3044\u307e\u3059\u304c\u3001BOT\u30b5\u30fc\u30d0\u30fc\u306e\u8981\u4ef6\u7684\u306b\u300c\u72b6\u614b\u300d\u3092\u7ba1\u7406\u3059\u308b\u5fc5\u8981\u306f\u3042\u308a\u307e\u305b\u3093\u3057\u3001\u30d7\u30ed\u30bb\u30b9\u304b\u3089\u300c\u623b\u308a\u5024\u300d\u3092\u8fd4\u3057\u3066\u3082\u3089\u3046\u5fc5\u8981\u3082\u3042\u308a\u307e\u305b\u3093\u3002\u8981\u3059\u308b\u306b\u30d7\u30ed\u30bb\u30b9\u306f\u300c\u4f7f\u3044\u6368\u3066\u300d\u3068\u3044\u3046\u304b\u3001\u5b9f\u884c\u304c\u7d42\u308f\u3063\u305f\u3089\u52dd\u624b\u306b\u7d42\u4e86\u3057\u3066\u304f\u308c\u308c\u3070\u305d\u308c\u3067\u30aa\u30c3\u30b1\u30fc\u306a\u308f\u3051\u3067\u3059\u3002\n\n\u3053\u306e\u8981\u4ef6\u306b\u30d4\u30c3\u30bf\u30ea\u306a\u306e\u306f[Task](http://elixir-lang.org/docs/stable/elixir/Task.html)\u3068[Task.Supervisor](http://elixir-lang.org/docs/stable/elixir/Task.Supervisor.html)\u3060\u3068\u601d\u3044\u307e\u3059\u306e\u3067\u3001\u3053\u308c\u3092\u4f7f\u3063\u3066\u307f\u308b\u3053\u3068\u306b\u3057\u307e\u3059\u3002\n\n\u307e\u305f\u3001LINE BOT\u306e\u5834\u5408\u30011\u3064\u306e\u30ea\u30af\u30a8\u30b9\u30c8\u306b\u6700\u5927\u3067100\u30e1\u30c3\u30bb\u30fc\u30b8\u304c\u542b\u307e\u308c\u308b\u3068\u306e\u3053\u3068\u306a\u306e\u3067\u3001\u30ab\u30f3\u30de\u533a\u5207\u308a\u3067\u8907\u6570\u306e\u30e1\u30c3\u30bb\u30fc\u30b8\u304c\u6e21\u3055\u308c\u308b\u3053\u3068\u3092\u524d\u63d0\u3068\u3057\u305f\u30a2\u30af\u30b7\u30e7\u30f3\u3092\u5b9a\u7fa9\u3057\u3066\u3001\u305d\u3053\u304b\u3089\u4e26\u884c\u51e6\u7406\u306e\u30b3\u30fc\u30c9\u3092\u547c\u3073\u51fa\u3059\u3088\u3046\u306b\u3057\u3066\u307f\u307e\u3059\u3002\n\n\u305d\u3093\u306a\u611f\u3058\u3067\u4e0b\u8a18\u306e\u3088\u3046\u306a\u30b3\u30fc\u30c9\u3092\u5b9a\u7fa9\u3057\u3066\u307f\u307e\u3057\u305f\u3002\n\n```ex:web/router.ex\ndefmodule BotSample.Router do\n  ...\n  scope \"/\", BotSample do\n    ...\n    post \"/callback\", PageController, :callback\n  end\nend\n```\n\n```ex:web/controllers/page_controller.ex\ndefmodule BotSample.PageController do\n  ...\n  def callback(conn, %{\"messages\" => messages} = _params) do\n    Bot.process_messages(messages)\n    json conn, %{ok: \"ok\"}\n  end\nend\n```\n\n```ex:lib/bot_sample.ex\ndefmodule BotSample do\n  use Application\n  def start(_type, _args) do\n    ...\n    children = [\n      ...\n      supervisor(Task.Supervisor, [[name: BotSample.BotTaskSupervisor]]),\n    ]\n  end\nend\n```\n\n```ex:lib/bot_sample/bot.ex\ndefmodule BotSample.Bot do\n  alias BotSample.Repo\n\n  def process_messages(messages) when is_binary(messages) do\n    Task.Supervisor.start_child(BotSample.BotTaskSupervisor, fn -> do_process_messages(messages) end)\n  end\n\n  defp do_process_messages(messages) when is_binary(messages) do\n    Enum.each String.split(messages, \",\"), fn(message) ->\n      Task.Supervisor.start_child(BotSample.BotTaskSupervisor, fn -> process_message(message) end)\n    end\n  end\n\n  defp process_message(message) when is_binary(message) do\n    IO.puts \"message = #{inspect message}\"\n  end\nend\n```\n\n```ex:config/dev.exs\nconfig :logger, :console, format: \"[$level] $message\\n\", level: :error\n```\n\n\u3042\u304f\u307e\u3067\u691c\u8a3c\u7528\u306a\u306e\u3067\u3054\u304f\u3054\u304f\u7c21\u5358\u306a\u30b3\u30fc\u30c9\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u3002Elixir\u306eLogger\u306e`:sync_threshold`\u306e\u4ed5\u69d8\u306b\u3088\u308b\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u3078\u306e\u5f71\u97ff\u3092\u6392\u9664\u3059\u308b\u305f\u3081\u306b\u3001`logger`\u306e\u51fa\u529b\u30ec\u30d9\u30eb\u306f`:info`\u3067\u306f\u306a\u304f`:error`\u306b\u8a2d\u5b9a\u3057\u3066\u3044\u307e\u3059\u3002(\u8a73\u3057\u304f\u306f[\u3053\u3061\u3089](http://elixir-lang.org/docs/stable/logger/Logger.html)\u3092\u3054\u53c2\u7167\u304f\u3060\u3055\u3044)\n\n# \u30d9\u30f3\u30c1\u30de\u30fc\u30af\u7528\u306e\u30c4\u30fc\u30eb\n\n\u30d9\u30f3\u30c1\u30de\u30fc\u30af\u3068\u3044\u3046\u304b\u8ca0\u8377\u691c\u8a3c\u7528\u306e\u30c4\u30fc\u30eb\u3068\u3057\u3066\u306f\u3001[Phoenix\u3068Rails\u306e\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u6bd4\u8f03\u8a18\u4e8b](http://www.littlelines.com/blog/2014/07/08/elixir-vs-ruby-showdown-phoenix-vs-rails/)\u3067\u3082\u7d39\u4ecb\u3055\u308c\u3066\u3044\u305fwrk\u3068\u3044\u3046\u30c4\u30fc\u30eb\u3092\u4f7f\u3063\u3066\u307f\u307e\u3057\u305f\u3002\n\n[\u30d9\u30f3\u30c1\u30de\u30fc\u30af\u30c4\u30fc\u30eb\"wrk\"\u3067\u81ea\u7531\u306b\u30ea\u30af\u30a8\u30b9\u30c8\u3092\u9001\u308b](http://qiita.com/bonon0/items/577b8f03525e99439b6c)\n\nPOST\u30e1\u30bd\u30c3\u30c9\u3067JSON\u5f62\u5f0f\u306e\u30ea\u30af\u30a8\u30b9\u30c8\u3092\u9001\u4fe1\u3057\u305f\u3044\u306e\u3067\u3001\u4e0b\u8a18\u306e\u3088\u3046\u306a\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092\u7528\u610f\u3057\u307e\u3059\u3002\n\n```lua\n-- wrk.lua\nwrk.method = \"POST\"\nwrk.body = '{\"messages\":\"1,2,3,4,5,6,7,8,9,10\"}'\nwrk.headers[\"Content-Type\"] = \"application/json\"\nwrk.headers[\"Accept\"] = \"application/json\"\n```\n\n# \u30e2\u30cb\u30bf\u30ea\u30f3\u30b0\u7528\u306e\u30c4\u30fc\u30eb\n\n\u691c\u8a3c\u30b9\u30af\u30ea\u30d7\u30c8\u5b9f\u884c\u4e2d\u306eCPU\u3084\u30d7\u30ed\u30bb\u30b9\u6570\u7b49\u306e\u72b6\u6cc1\u3092\u78ba\u8a8d\u3059\u308b\u305f\u3081\u306b\u3001\u4e0b\u8a18\u306e\u8a18\u4e8b\u3067\u7d39\u4ecb\u3055\u308c\u3066\u3044\u308b[ex_top](https://github.com/utkarshkukreti/ex_top)\u3068\u3044\u3046\u30c4\u30fc\u30eb\u3092\u4f7f\u7528\u3057\u307e\u3057\u305f\u3002\n\n[Elixir\u3067\u30d7\u30ed\u30bb\u30b920\u4e07\u304f\u3089\u3044\u4f5c\u3063\u3066\u307f\u305f](http://qiita.com/shibacow/items/bd0e852a2bfe75caf437)\n\n# \u691c\u8a3c\u7528\u306e\u30b5\u30fc\u30d0\u30fc\n\n\u4e26\u884c\u51e6\u7406\u306b\u95a2\u3059\u308b\u52d5\u4f5c\u3092\u691c\u8a3c\u3059\u308b\u3053\u3068\u304c\u76ee\u7684\u306a\u306e\u3067\u3001CPU\u306e\u30b3\u30a2\u6570\u304c\u591a\u3081\u306e\u30b5\u30fc\u30d0\u30fc\u3092\u4f7f\u7528\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\u307e\u305f\u3001wrk\u306b\u3088\u308b\u30ea\u30af\u30a8\u30b9\u30c8\u3092\u9001\u4fe1\u3059\u308b\u30b5\u30fc\u30d0\u30fc\u3068\u3001Elixir/Phoenix\u3067\u30ea\u30af\u30a8\u30b9\u30c8\u3092\u51e6\u7406\u3059\u308b\u30b5\u30fc\u30d0\u30fc\u306f\u5225\u3005\u306b\u7528\u610f\u3057\u307e\u3059\u3002\n\n\u3053\u306e\u691c\u8a3c\u4f5c\u696d\u306b\u304a\u3044\u3066\u306f\u3001\u4e0b\u8a18\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u30bf\u30a4\u30d7\u306eEC2\u30922\u53f0\u4f7f\u7528\u3057\u307e\u3057\u305f\u3002\n\n| \u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u30bf\u30a4\u30d7 | vCPU | \u30e1\u30e2\u30ea |\n|:--|--:|:--:|\n| c4.2xlarge |\u30008 |\u300015GiB\u3000|\n\n# \u691c\u8a3c1\n\n\u307e\u305a\u3001\u691c\u8a3c\u7528\u306e\u30b5\u30fc\u30d0\u30fc\u3067Phoenix\u3092\u8d77\u52d5\u3057\u307e\u3059\u3002\u30d9\u30f3\u30c1\u30de\u30fc\u30af\u3060\u3051\u306a\u3089\u666e\u901a\u306b`mix phoenix.server`\u3067\u8d77\u52d5\u3057\u3066\u3082\u826f\u3044\u306e\u3067\u3059\u304c\u3001ex_top\u3092\u4f7f\u7528\u3059\u308b\u5834\u5408\u306f\u30ce\u30fc\u30c9\u540d\u3092\u660e\u793a\u7684\u306b\u6307\u5b9a\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u306e\u3067\u4e0b\u8a18\u306e\u3088\u3046\u306a\u30b3\u30de\u30f3\u30c9\u3067\u8d77\u52d5\u3057\u307e\u3059\u3002\n\n```bash\niex --sname bar@localhost -S mix phoenix.server\n```\n\n\u7d9a\u3044\u3066ex_top\u3092\u8d77\u52d5\u3057\u307e\u3059\u3002\u691c\u8a3c\u7528\u30b5\u30fc\u30d0\u30fc\u306eex_top\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u305f\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3067\u4e0b\u8a18\u306e\u3088\u3046\u306a\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3057\u307e\u3059\u3002\n\n```bash\n./ex_top bar@localhost\n```\n\nex_top\u3092\u5b9f\u884c\u3059\u308b\u3068\u3001\u74b0\u5883\u306b\u3082\u3088\u308a\u307e\u3059\u304c8\u30b3\u30a2\u306e\u30b5\u30fc\u30d0\u30fc\u3060\u3068\u4e0b\u8a18\u306e\u3088\u3046\u306a\u753b\u9762\u304c\u8868\u793a\u3055\u308c\u308b\u3068\u601d\u3044\u307e\u3059\u3002\n\n<img width=\"854\" alt=\"\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2016-04-26 14.40.59.png\" src=\"https://qiita-image-store.s3.amazonaws.com/0/22932/a5b37994-4a81-ede4-bc3b-83f144469665.png\">\n\n\u5de6\u4e0a\u306e\u9818\u57df\u3067CPU\u306e\u5404\u30b3\u30a2\u306e\u4f7f\u7528\u72b6\u6cc1\u3001\u53f3\u4e0a\u306e\u300cStatistics\u300d\u306e\u9818\u57df\u3067\u30d7\u30ed\u30bb\u30b9\u6570\u7b49\u3092\u30e2\u30cb\u30bf\u30ea\u30f3\u30b0\u3059\u308b\u3053\u3068\u304c\u51fa\u6765\u307e\u3059\u3002\n\n\u6b21\u306b\u3001\u30ea\u30af\u30a8\u30b9\u30c8\u3092\u9001\u4fe1\u3059\u308b\u5074\u306e\u30b5\u30fc\u30d0\u30fc\u3067\u4e0b\u8a18\u306e\u3088\u3046\u306awrk\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3057\u307e\u3059\u3002(\u30db\u30b9\u30c8\u306e\u90e8\u5206\u306fPhoenix\u304c\u5b9f\u884c\u3055\u308c\u3066\u3044\u308b\u30b5\u30fc\u30d0\u30fc\u306eIP\u3092\u6307\u5b9a\u3057\u307e\u3059)\n\n```bash\nwrk -c 8 -t 8 -d 30 -s ./wrk.lua http://\u30db\u30b9\u30c8:4000/callback\n```\n\n1\u30ea\u30af\u30a8\u30b9\u30c8\u306b10\u30e1\u30c3\u30bb\u30fc\u30b8\u304c\u542b\u307e\u308c\u308b\u72b6\u614b\u3067\u4e0a\u8a18\u306e\u30b3\u30fc\u30c9\u3092\u5b9f\u884c\u3059\u308b\u3068\u3001\u79c1\u306e\u69cb\u7bc9\u3057\u305f\u74b0\u5883\u3060\u3068`4800req/sec`\u3068\u3044\u3046\u7d50\u679c\u306b\u306a\u308a\u307e\u3057\u305f\u3002\u8981\u3059\u308b\u306b\u3053\u306e\u30b5\u30fc\u30d0\u30fc\u30b9\u30da\u30c3\u30af\u3060\u3068\u3001\u3054\u304f\u77ed\u3044\u51e6\u7406\u3067\u3042\u308c\u3070(1\u30ea\u30af\u30a8\u30b9\u30c8\u306b10\u30e1\u30c3\u30bb\u30fc\u30b8\u304c\u542b\u307e\u308c\u3066\u3044\u308b\u306e\u3067)\u79d2\u959348000\u30e1\u30c3\u30bb\u30fc\u30b8\u306b\u5bfe\u5fdc\u51fa\u6765\u308b\u3068\u3044\u3046\u3053\u3068\u306b\u306a\u308a\u307e\u3059\u3002\n\n# \u691c\u8a3c2\n\n\u3055\u3066\u3001\u4e0a\u8a18\u306e`BotSample.Bot.process_message/1`\u306e\u51e6\u7406\u5185\u3067\u306f\u3001\u5b9f\u969b\u306b\u306f\u30d7\u30e9\u30c3\u30c8\u30d5\u30a9\u30fc\u30e0\u5074\u306eAPI\u3092\u547c\u3073\u51fa\u3059\u3053\u3068\u306b\u306a\u308a\u307e\u3059\u3002\n\n\u5916\u90e8API\u306e\u5b9f\u884c\u306b\u95a2\u3057\u3066\u306f\u3001\u3055\u3059\u304c\u306b\u623b\u308a\u5024(\u30b9\u30c6\u30fc\u30bf\u30b9\u30b3\u30fc\u30c9\u3084\u30ec\u30b9\u30dd\u30f3\u30b9\u30dc\u30c7\u30a3)\u3092\u30c1\u30a7\u30c3\u30af\u3057\u306a\u3044\u308f\u3051\u306b\u306f\u3044\u304b\u306a\u3044\u3068\u601d\u3044\u307e\u3059\u306e\u3067\u3001\u30ec\u30b9\u30dd\u30f3\u30b9\u304c\u8fd4\u3055\u308c\u308b\u307e\u3067\u5f85\u3064\u3053\u3068\u306b\u306a\u308a\u307e\u3059\u304c\u3001\u3053\u306e\u623b\u308a\u6642\u9593\u3092\u5c11\u3005\u53b3\u3057\u76ee\u306b\u300c\u5e73\u57472\u79d2\u301c3\u79d2\u300d\u3068\u4eee\u5b9a\u3057\u3066\u3001`BotSample.Bot.process_message/1`\u95a2\u6570\u306b\u4e0b\u8a18\u306e\u3088\u3046\u306asleep\u51e6\u7406\u3092\u8ffd\u52a0\u3057\u3066\u307f\u307e\u3059\u3002\n\n```ex\ndefp process_message(message) when is_binary(message) do\n  :timer.sleep(Enum.random(2000..3000))\n  IO.puts \"message = #{inspect message}\"\nend\n```\n\n\u3053\u306e\u72b6\u614b\u3067\u3001\u5148\u307b\u3069\u3068\u540c\u3058wrk\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3057\u3066\u307f\u308b\u3068\u3001\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u306f`750req/sec`\u3042\u305f\u308a\u307e\u3067\u60aa\u5316\u3057\u307e\u3057\u305f\u3002\n\n\u3055\u3089\u306b\u5404CPU\u30b3\u30a2\u306e\u4f7f\u7528\u7387\u3082100%\u306b\u306a\u308a\u3001\u30d7\u30ed\u30bb\u30b9\u6570\u308220000\u7a0b\u5ea6\u306b\u306a\u308a\u307e\u3059\u3002(sleep\u51e6\u7406\u3092\u5165\u308c\u308b\u524d\u306e\u30c6\u30b9\u30c8\u3060\u3068300\u7a0b\u5ea6)\n\n\u8981\u3059\u308b\u306b\u5916\u90e8API\u547c\u3073\u51fa\u3057\u306b\u5e73\u57472\u301c3\u79d2\u5fc5\u8981\u306b\u306a\u308b\u3068\u60f3\u5b9a\u3059\u308b\u3068\u3001\u3053\u306e\u30b5\u30fc\u30d0\u30fc1\u53f0\u3067\u51e6\u7406\u51fa\u6765\u308b\u79d2\u9593\u30e1\u30c3\u30bb\u30fc\u30b8\u6570\u306f7000\u7a0b\u5ea6\u3001\u3057\u304b\u3082CPU\u306e\u4f7f\u7528\u7387\u304b\u3089\u8003\u3048\u308b\u3068\u3001\u9577\u671f\u9593\u5b89\u5b9a\u3057\u3066\u51e6\u7406\u3092\u884c\u3048\u308b\u79d2\u9593\u30e1\u30c3\u30bb\u30fc\u30b8\u6570\u306f\u3053\u308c\u3088\u308a\u3082\u304b\u306a\u308a\u5c11\u306a\u304f\u306a\u308b\u3001\u3068\u3044\u3046\u3053\u3068\u306b\u306a\u308a\u305d\u3046\u3067\u3059\u3002\n\n# \u691c\u8a3c3\n\n\u6b21\u306b\u3001\u30c7\u30fc\u30bf\u30b9\u30c8\u30a2\u3078\u306e\u30a2\u30af\u30bb\u30b9\u51e6\u7406\u3092\u8ffd\u52a0\u3057\u3066\u691c\u8a3c\u3092\u884c\u3063\u3066\u307f\u305f\u3044\u3068\u601d\u3044\u307e\u3059\u304c\u3001\u4e0a\u8a18\u306e\u5916\u90e8API\u547c\u3073\u51fa\u3057\u306b\u52a0\u3048\u3066\u3001BOT\u30b5\u30fc\u30d0\u30fc\u3067\u4e26\u884c\u51e6\u7406\u3092\u884c\u3046\u969b\u306b\u3082\u3046\u4e00\u3064\u5927\u304d\u306a\u30dc\u30c8\u30eb\u30cd\u30c3\u30af\u306b\u306a\u308b\u3068\u8003\u3048\u3089\u308c\u308b\u306e\u304c\u3001\u30c7\u30fc\u30bf\u30b9\u30c8\u30a2\u7528\u306e\u30b3\u30cd\u30af\u30b7\u30e7\u30f3\u30d7\u30fc\u30eb\u306e\u30d7\u30fc\u30eb\u30b5\u30a4\u30ba\u3067\u3059\u3002\n\n\u4f8b\u3048\u3070\u30c7\u30fc\u30bf\u30b9\u30c8\u30a2\u306bPostgresql\u3084MySQL\u3092\u4f7f\u7528\u3059\u308b\u5834\u5408\u3001Phoenix/Ecto\u306e\u30c7\u30d5\u30a9\u30eb\u30c8\u3067\u306f\u3001\u30d7\u30fc\u30eb\u30b5\u30a4\u30ba\u306f\u300c10\u300d\u306b\u8a2d\u5b9a\u3055\u308c\u3066\u3044\u307e\u3059\u304c\u3001\u3053\u306e\u30d7\u30fc\u30eb\u30b5\u30a4\u30ba\u3067\u4e26\u884c\u51e6\u7406\u3092\u884c\u304a\u3046\u3068\u3059\u308b\u3068timeout error\u304c\u591a\u767a\u3057\u3066\u3057\u307e\u3046\u306e\u3067\u4f7f\u3044\u3082\u306e\u306b\u306a\u308a\u307e\u305b\u3093\u3002\n\n\u3068\u3044\u3046\u3053\u3068\u3067\u3001\u5927\u304d\u3081\u306e\u30d7\u30fc\u30eb\u30b5\u30a4\u30ba(\u6570\u5343\u7a0b\u5ea6)\u3092\u8a2d\u5b9a\u3057\u3066\u691c\u8a3c\u3092\u884c\u3048\u308b\u3088\u3046\u306b\u3001\u30e1\u30e2\u30ea\u30b5\u30a4\u30ba\u304c\u5927\u304d\u3081\u306a\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u30b5\u30fc\u30d0\u30fc\u3092\u7528\u610f\u3057\u307e\u3059\u3002\n\n\u3053\u306e\u691c\u8a3c\u306b\u304a\u3044\u3066\u306f\u3001\u4e0b\u8a18\u306e\u3088\u3046\u306a\u30b9\u30da\u30c3\u30af\u306eRDS(MySQL)\u3092\u4f7f\u7528\u3057\u307e\u3057\u305f\u3002\n\n| \u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u30bf\u30a4\u30d7 | vCPU | \u30e1\u30e2\u30ea |\n|:--|--:|:--:|\n| db.r3.2xlarge |\u30008 |\u300061GiB\u3000|\n\nRDS\u306eMySQL\u306emax_connections\u306f\u3001[\u3053\u3061\u3089](http://qiita.com/rch850/items/33fd88fe5e69fa7a1f29)\u306e\u8a18\u4e8b\u3067\u89e3\u8aac\u3055\u308c\u3066\u3044\u308b\u3088\u3046\u306b\u300cDBInstanceClassMemory/12582880\u300d\u306b\u8a2d\u5b9a\u3055\u308c\u307e\u3059\u306e\u3067\u3001\u4e0a\u8a18\u30b9\u30da\u30c3\u30af\u306eRDS\u3060\u3068max_connections\u306f5100\u7a0b\u5ea6\u306b\u8a2d\u5b9a\u3055\u308c\u307e\u3059\u3002\n\nPhoenix\u5074\u3067\u306f\u3001\u4e0a\u8a18\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u3078\u306e\u63a5\u7d9a\u8a2d\u5b9a\u306epool_size\u3092\u4e0b\u8a18\u306e\u3088\u3046\u306b\u8a2d\u5b9a\u3057\u3066\u307f\u307e\u3059\u3002\n\n```ex:config/dev.exs\nconfig :bot_sample, BotSample.Repo,\n  ...\n  pool_size: 5000\n```\n\n`BotSample.Bot.process_message/1`\u95a2\u6570\u3092\u4e0b\u8a18\u306e\u3088\u3046\u306b\u5909\u66f4\u3057\u307e\u3059\u3002\n\n```ex\ndefp process_message(message) when is_binary(message) do\n  :timer.sleep(Enum.random(2000..3000))\n  {:ok, %{rows: rows}} = Ecto.Adapters.SQL.query(Repo, \"SELECT NOW()\", [])\n  IO.puts \"now = #{inspect rows}\"\nend\n```\n\n\u3053\u306e\u72b6\u614b\u3067wrk\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3057\u3066\u307f\u308b\u3068\u3001\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u306f`530req/sec`\u307b\u3069\u306b\u306a\u308a\u307e\u3057\u305f\u3002\n\n\u307e\u305f\u3001\u30d7\u30fc\u30eb1\u3064\u3054\u3068\u306b\u30d7\u30ed\u30bb\u30b9\u304c\u8d77\u52d5\u3059\u308b\u3088\u3046\u3067\u3001\u5e73\u5e38\u6642\u3067\u3082\u30d7\u30ed\u30bb\u30b9\u6570\u304c5000\u8d85\u306b\u306a\u3063\u3066\u3057\u307e\u3044\u307e\u3059\u304c\u3001timeout error\u306f\u767a\u751f\u305b\u305a\u3001\u5168\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u6b63\u5e38\u306b\u51e6\u7406\u51fa\u6765\u307e\u3057\u305f\u3002\n\n\u5927\u304d\u306a\u9045\u5ef6\u3082\u767a\u751f\u3057\u307e\u305b\u3093\u3067\u3057\u305f\u306e\u3067\u3001\u30c7\u30fc\u30bf\u30b9\u30c8\u30a2\u306e\u30d7\u30fc\u30eb\u30b5\u30a4\u30ba\u304a\u3088\u3073\u6700\u5927\u540c\u6642\u63a5\u7d9a\u6570\u3092\u5341\u5206\u306b\u78ba\u4fdd\u3057\u3066\u304a\u3051\u3070\u3001\u4e26\u884c\u51e6\u7406\u306b\u5bfe\u3057\u3066\u5927\u304d\u306a\u5f71\u97ff\u3092\u4e0e\u3048\u305a\u306b\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u51e6\u7406\u51fa\u6765\u308b\u3053\u3068\u304c\u5206\u304b\u308a\u307e\u3057\u305f\u3002\n\n# \u307e\u3068\u3081\n\nElixir/Phoenix\u3067BOT\u30b5\u30fc\u30d0\u30fc\u3092\u958b\u767a\u3059\u308b\u5834\u5408\u3001\u4e26\u884c\u51e6\u7406\u306b\u95a2\u3057\u3066\u306f\u4e0a\u8a18\u306e\u3088\u3046\u306b`Task`\u3068`Task.Supervisor`\u3092\u4f7f\u3048\u3070\u975e\u5e38\u306b\u7c21\u5358\u306b\u5b9f\u88c5\u51fa\u6765\u308b\u3053\u3068\u304c\u5206\u304b\u308a\u307e\u3057\u305f\u3002(\u4ed6\u306b\u3082\u8272\u3005\u3068\u3084\u308a\u65b9\u306f\u3042\u308b\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u304c)\n\n1\u53f0\u306e\u30b5\u30fc\u30d0\u30fc\u3067\u51e6\u7406\u51fa\u6765\u308b\u30e1\u30c3\u30bb\u30fc\u30b8\u6570/seq\u306b\u95a2\u3057\u3066\u306f\u3001\u4e0a\u8a18\u306e\u3088\u3046\u306b\u30dc\u30c8\u30eb\u30cd\u30c3\u30af\u306b\u306a\u308b\u51e6\u7406(\u5916\u90e8API\u30b3\u30fc\u30eb\u3084\u30c7\u30fc\u30bf\u30b9\u30c8\u30a2\u306e\u30d7\u30fc\u30eb\u30b5\u30a4\u30ba)\u306b\u95a2\u3059\u308b\u9069\u5f53\u306a\u30c0\u30df\u30fc\u30b3\u30fc\u30c9\u3092\u8ffd\u52a0\u3057\u3066\u3044\u3063\u3066\u3001wrk\u7b49\u306e\u30d9\u30f3\u30c1\u30de\u30fc\u30af\u30c4\u30fc\u30eb\u3067\u8ca0\u8377\u6e2c\u5b9a\u3092\u884c\u3048\u3070\u3001\u3042\u308b\u30b9\u30da\u30c3\u30af\u306e\u30b5\u30fc\u30d0\u30fc\u3067\u51e6\u7406\u3067\u304d\u308b\u30e1\u30c3\u30bb\u30fc\u30b8\u6570/seq\u3068\u3044\u3046\u306e\u306f\u304a\u304a\u3088\u305d\u7b97\u51fa\u51fa\u6765\u308b\u3068\u601d\u3044\u307e\u3059\u306e\u3067\u3001\u305d\u306e\u6570\u5024\u304a\u3088\u3073\u60f3\u5b9a\u3059\u308b\u30e1\u30c3\u30bb\u30fc\u30b8\u6570/seq\u3092\u5143\u306b\u3057\u3066\u5fc5\u8981\u306a\u30b5\u30fc\u30d0\u30fc\u53f0\u6570\u3092\u6c7a\u3081\u308b\u3001\u3068\u3044\u3046\u611f\u3058\u3067\u826f\u3055\u305d\u3046\u304b\u306a\u3068\u3002\n\n# \u8ffd\u8a18\n\n\u4e26\u884c\u51e6\u7406\u306b\u95a2\u3057\u3066\u306f\u3042\u307e\u308a\u7d4c\u9a13\u304c\u306a\u3044\u305f\u3081\u3001\u8272\u3005\u304a\u304b\u3057\u306a\u70b9\u304c\u3042\u308b\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u3002\u30b3\u30e1\u30f3\u30c8\u6b04\u3067\u3054\u610f\u898b\u3084\u3054\u6307\u6458\u7b49\u9802\u3051\u307e\u3059\u3068\u5927\u5909\u3042\u308a\u304c\u305f\u3044\u3067\u3059\u3002\u3088\u308d\u3057\u304f\u304a\u9858\u3044\u7533\u3057\u4e0a\u3052\u307e\u3059m(__)m\n", "tags": ["Elixir", "Phoenix", "bot"]}