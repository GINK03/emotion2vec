{"context": " More than 1 year has passed since last update.\n\n\u306f\u3058\u3081\u306b\nDynamoDB\u306b\u3042\u308b\u7d04150GB\u306eData\u3092Redshift\u306bImport\u3057\u3088\u3046\u3068\u3057\u3066\u30cf\u30de\u3063\u305f\u306e\u3067\u3001\u89e3\u6c7a\u65b9\u6cd5\u3092\u30c1\u30e9\u88cf\u3057\u3066\u304a\u304d\u307e\u3059\u3002  \n\u4ee5\u4e0b\u306e\u9806\u756a\u3067\u8a66\u3057\u305f\u306e\u3067\u3059\u304c\u3001\u7d50\u5c40#3\u304c\u6b63\u89e3\u3067\u3057\u305f\u3002#2\u306e\u65b9\u6cd5\u3067\u30822\u65e5\u639b\u304b\u308a\u3067Import\u81ea\u4f53\u306f\u3067\u304d\u307e\u3057\u305f\u304c\u3001\u304b\u306a\u308a\u529b\u6280\u306a\u611f\u306f\u5426\u3081\u307e\u305b\u3093\u3002\n\n\ncopy redshift-table-name from 'dynamodb://dynamo-table-name'\u3068\u5b9f\u884c\nDynamo\u304b\u3089S3\u306b\u4e00\u65e6Export\u3057\u3001\u305d\u306eFile\u3092Redshift\u306bImport\u3059\u308b\nRedshift Cluster\u309232 node\u3067\u7acb\u3061\u4e0a\u3052\u30011\u3068\u540c\u69d8\u306e\u51e6\u7406\u3092\u5b9f\u884c\u3001Import\u5b8c\u4e86\u5f8c\u306bnode\u6570\u3092\u6e1b\u3089\u3059\n\n\n\u30cf\u30de\u30ea\u306e\u30dd\u30a4\u30f3\u30c8\n\u4eca\u56de\u30cf\u30de\u30c3\u305f\u7406\u7531\u306f\u3001\u5927\u91cf\u306eData\u3092Dynamo\u2192Redshift\u306bImport\u3059\u308b\u5834\u5408\u306b\u3001\u5927\u91cf\u306enode\u306eRedshift cluster\u3092\u7528\u610f\u3057\u3066\u304a\u304b\u306a\u3044\u3068\u3001Copy\u306b\u6642\u9593\u304c\u304b\u304b\u308a\u3001timeout\u3067error\u306b\u306a\u308a\u307e\u3059\u3088\u3001\u3068\u3044\u3046\u4e8b\u3067\u3059\u3002\n\u6700\u521d\u30011 node\u306eRedshift Cluster\u306bcopy\u51e6\u7406\u3092\u5b9f\u884c\u3059\u308b\u3068\u300140\u6642\u9593\u8fd1\u304f\u639b\u304b\u3063\u305f\u3042\u3052\u304f\u6700\u5f8c\u306bCopy\u304cerror\u3067\u5931\u6557\u3068\u306a\u308a\u307e\u3057\u305f\u3002\u9006\u306b32 node\u7b49\u3067Redshift Cluster\u3092\u7acb\u3061\u4e0a\u3052Copy\u51e6\u7406\u3092\u3059\u308b\u3068\u3001(Dynamo Read\u3067\u898b\u308b\u9650\u308a)20-40\u500d\u8fd1\u304f\u306eThroughput\u3067Copy\u304c\u3055\u308c\u30011\u6642\u9593\u5f31\u3067\u5b8c\u4e86\u3057\u307e\u3059\u3002Copy\u5b8c\u4e86\u5f8c\u3001Cluster\u306enode\u6570\u3092\u9069\u5b9c\u6e1b\u3089\u305b\u3070\u7d42\u4e86\u3067\u3059\u3002\n\n1. copy redshift-table-name from 'dynamodb://dynamo-table-name'\u3068\u5b9f\u884c\nDynamo\u306eData\u3092Redshift\u306bImport\u3092\u3057\u305f\u3044\uff01\u3068\u306a\u308b\u3068\u3001\u307e\u305a\u306fAmazon\u306eDocument\u306b\u3042\u308b\u69d8\u306b\u3001Redshift Cluster\u3092\u7acb\u3061\u4e0a\u3052\u3066\u3001Redshift command\u3067copy xx from 'dynamodb://yy'\u3068\u3084\u308b\u306e\u304c\u738b\u9053\u3060\u3068\u601d\u3044\u307e\u3059(Dynamo\u306eData\u91cf\u304c\u5c11\u306a\u3044\u5834\u5408\u306f\u3001\u3053\u308c\u3067\u5341\u5206\u306b\u52d5\u304d\u307e\u3057\u305f)\u3002\n\u306a\u306e\u3067\u3001\u4ee5\u4e0b\u306e\u624b\u9806\u3092\u3068\u308a\u307e\u3057\u305f\u3002\n1.dynamo_test_table\u3068\u3044\u3046Dynamo Table\u306eRead Capacity Unit(RCU)\u309210,000\u306b\u8a2d\u5b9a\n2.1 node\u306eds2.xlarge instance\u3092\u7acb\u3061\u4e0a\u3052\u308b\n3.Redshift\u306bPostgres command\u3067\u5165\u3063\u3066\u3001Redshift\u306etable\u3092\u4f5c\u3063\u3066\u304a\u304f\nCREATE TABLE redshift-table-name(\n  end_user VARCHAR(36) encode raw,\n  created_at VARCHAR(36) encode text255,\n  lang VARCHAR(10) encode raw,\n)\n  distkey(end_user)\n  compound sortkey(created_at);\n\n4.Postgres command\u3067Copy\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\ncopy redshift-table-name from 'dynamodb://dynamo_test_table' credentials 'aws_access_key_id=AKISELIJGISEILIJSGS2;aws_secret_access_key=abcdefghijklmn1234567890ABC' MAXERROR AS 100000 readratio 100\n\n\u6ce8\uff1aAPI/Secret Key\u306f\u9069\u5f53\u3067\u3059\n\u3059\u308b\u3068\u3001Dynamo Read\u306f250 RCU\u3050\u3089\u3044\u3057\u304bThroughput\u304c\u51fa\u305a\u3001\u305d\u306e\u72b6\u614b\u304c30\u6642\u9593\u8fd1\u304f\u7d9a\u304d\u307e\u3059\u3002\u305d\u306e\u5f8c\u300110\u6642\u9593\u3050\u3089\u3044Dynamo Read\u304c\u7121\u3044\u72b6\u614b\u304c\u7d9a\u304d\u3001\u6700\u7d42\u7684\u306bCopy\u304cTerminated\u3067\u5931\u6557\u3057\u307e\u3057\u305f(\u6ce3)\u3002ssh\u306eConnection\u304c\u5207\u308c\u306a\u3044\u3088\u3046\u306b\u3057\u3066\u3082\u3001\u30c0\u30e1\u3067\u3057\u305f\u3002\n\n2. Dynamo\u304b\u3089S3\u306b\u4e00\u65e6Export\u3057\u3001\u305d\u306eFile\u3092Redshift\u306bImport\u3059\u308b\n\u6b21\u306b\u8a66\u3057\u305f\u306e\u304c\u3001Dynamo\u306e150GB\u306eData\u3092\u4e00\u65e6S3\u306bExport\u3057\u3001\u305d\u306eFile\u3092Redshift\u306bImport\u3059\u308b\u3001\u3068\u3044\u3046\u624b\u9806\u3067\u3059\u3002\u3053\u308c\u81ea\u4f53\u306f\u4e0a\u624b\u304f\u884c\u3063\u305f\u306e\u3067\u3059\u304c\u3001Dynamo\u304b\u3089\u306eExport\u3067\u30cf\u30de\u30ea\u6240\u304c1\u7b87\u6240\u3042\u308b\u306e\u3068\u3001Python script\u7b49\u3067Format\u5909\u63db\u3092\u30b4\u30ea\u30b4\u30ea\u66f8\u304f\u5fc5\u8981\u304c\u6709\u308a\u307e\u3059\u3002\n\u624b\u9806\u306f\u4ee5\u4e0b\u306e\u69d8\u306b\u306a\u308a\u307e\u3059\u3002\n\nDynamo\u306eS3 export\u6a5f\u80fd\u3092\u4f7f\u3063\u3066S3 bucket\u306bfile\u3068\u3057\u3066\u66f8\u304d\u51fa\u3059\nS3\u306b\u66f8\u304d\u51fa\u3055\u308c\u305ffile\u3092EC2\u306bCopy\u3059\u308b\nS3\u306b\u66f8\u304d\u51fa\u3055\u308c\u305ffile\u306f(csv\u3084json\u3067\u306f\u306a\u3044)\u7279\u6b8a\u306aformat\u306a\u306e\u3067\u3001csv\u7b49\u306bformat\u5909\u63db\u3059\u308b\n\nds2.xlarge instance\u30921 node\u3067\u7acb\u3061\u4e0a\u3052\u308b\ncsv\u306b\u5909\u63db\u3055\u308c\u305ffile\u3092\u3001gzip\u5727\u7e2e\u3057\u3066\u3001S3\u306b\u518d\u5ea6upload\u3059\u308b\nS3\u306bupload\u3055\u308c\u305fgzip file\u3092\u30d7\u30c1\u30d7\u30c1Redshift cluster\u306bCopy\u3057\u3066\u3044\u304f\n\n\nDynamo\u306eS3 export\u6a5f\u80fd\u3092\u4f7f\u3063\u3066S3 bucket\u306bfile\u3068\u3057\u3066\u66f8\u304d\u51fa\u3059\nAmazon\u6a19\u6e96\u306e\u6a5f\u80fd\u306a\u306e\u3067\u3001\u64cd\u4f5c\u306b\u8ff7\u3046\u4e8b\u306f\u7121\u3044\u3068\u601d\u3044\u307e\u3059\u304c\u3001\u3053\u306e\u8a18\u4e8b\u306b\u3042\u308b\u3088\u3046\u306a\u7f60\u304c\u5b58\u5728\u3059\u308b\u305f\u3081\u3001S3 export\u306e\u70ba\u306eEMR\u306e\u8a2d\u5b9a\u3092\u8272\u3005Tuning\u3059\u308b\u5fc5\u8981\u304c\u6709\u308a\u307e\u3059\u3002150GB\u306eDynamo Data\u309214\u6642\u9593\u304b\u304b\u3063\u3066\u4f55\u3068\u304bExport\u5b8c\u4e86\u3001150GB\u306eData\u306f200MB * 900\u500b\u3050\u3089\u3044\u306efile\u306b\u5206\u5272\u3055\u308c\u3001S3\u306b\u4fdd\u5b58\u3055\u308c\u307e\u3059\u3002\n\nS3\u306b\u66f8\u304d\u51fa\u3055\u308c\u305ffile\u3092EC2\u306bCopy\u3059\u308b\nS3\u306b\u66f8\u304d\u51fa\u3055\u308c\u305fDynamo data\u306f\u3001\u7279\u6b8a\u306aformat\u306a\u306e\u3067\u3001\u3053\u306e\u307e\u307eRedshift\u3078Import\u306f\u51fa\u6765\u307e\u305b\u3093!\u3002\nDynamo 1 record\u304c\u3001created_at.{\"n\":\"123456789012345\"}.end_user.{\"s\":\"12345-67890-112345-67890\"}\u307f\u305f\u3044\u306aformat\u3067\u66f8\u304d\u51fa\u3055\u308c\u307e\u3059\u3002\u3053\u306e\u4ed5\u69d8\u3092\u77e5\u3063\u305f\u6642\u306f\u5272\u3068\u6ce3\u304d\u305d\u3046\u306b\u306a\u308a\u307e\u3057\u305f\u304c\u3001\u3068\u3082\u3042\u308cFormat\u5909\u63db\u304c\u5fc5\u8981\u306a\u306e\u3067\u3001\u4e00\u65e6EC2\u306bfile\u3092\u5168\u3066Copy\u3057\u307e\u3059\u3002\n\nfile\u3092csv\u7b49\u306bformat\u5909\u63db\u3059\u308b\n\u3053\u306e\u7279\u6b8a\u306aFormat\u304c\u4f55\u8005\u306a\u306e\u304b\u306f\u4e0d\u660e\u3067\u3059\u304c\u3001\u3053\u306e\u8a18\u4e8b\u304b\u3089\u3001\u4ee5\u4e0b\u306eshell command\u3067json\u306b\u5909\u63db\u3067\u304d\u307e\u3059\u3002\n\u4ee5\u4e0b\u30011234-5678-abcd-efghij0123456-000000\u3068\u8a00\u3046\u7279\u6b8aformat\u306afile\u3092000000.json\u3068\u3044\u3046json file\u306b\u5909\u63db\u3057\u3066\u304f\u308c\u307e\u3059\u3002\nsed -e 's/$/}/' -e $'s/\\x02/,\"/g' -e $'s/\\x03/\":/g' -e 's/^/{\"/' 1234-5678-abcd-efghij0123456-000000 > 000.json\n\n\u304c\u3001\u7dba\u9e97\u306akey-value\u306ejson\u306b\u6210\u3089\u305a\u3001{\"created_at\":{\"n\":\"12345678901234\"},\"end_user\":{\"s\":\"12345-67890-112345-67890\"}}\u307f\u305f\u3044\u306a\u5909\u306ajson\u306b\u306a\u308a\u307e\u3059\u3002\u3053\u306e\u307e\u307e\u3067\u306fRedshift\u306b\u8aad\u307f\u8fbc\u307e\u305b\u3089\u308c\u306a\u3044\u306e\u3067\u3001Python\u7b49\u3067\u30b4\u30ea\u30b4\u30eacsv\u7b49\u306b\u66f8\u304d\u51fa\u3057\u307e\u3059\u3002\n\ncsv\u306b\u5909\u63db\u3055\u308c\u305ffile\u3092\u3001gzip\u5727\u7e2e\u3057\u3066\u3001S3\u306b\u518d\u5ea6upload\u3059\u308b\ncsv\u5909\u63db\u3055\u308c\u305ffile\u306f\u3001\u3053\u306e\u307e\u307eRedshift\u306b\u8aad\u307f\u8fbc\u307e\u305b\u308b\u4e8b\u304c\u53ef\u80fd\u3067\u3059\u304c\u3001gzip\u5727\u7e2e\u3057\u3066S3\u306b\u7f6e\u3044\u305f\u65b9\u304c\u3001\u8aad\u307f\u8fbc\u307f\u304c\u65e9\u3044\u306e\u3067\u3001gzip\u5727\u7e2e\u3057\u3066S3\u306b\u518d\u5ea6upload\u3057\u307e\u3059\u3002\n\nS3\u306bupload\u3055\u308c\u305fgzip file\u3092\u30d7\u30c1\u30d7\u30c1Redshift cluster\u306bCopy\u3057\u3066\u3044\u304f\n\u3064\u3044\u306b\u3001Redshift\u3078\u306eImport\u3067\u3059\u3002\u3053\u306e\u8a18\u4e8b\u306b\u3042\u308b\u3088\u3046\u306b\u3001\u4ee5\u4e0b\u306ePostgres Copy command\u3092\u5b9f\u884c\u3057\u307e\u3059\u3002\ncopy redshift-table-name from 's3://Bucket-name/folder/000.gz' credentials 'aws_access_key_id=AKISELIJGISEILIJSGS2;aws_secret_access_key=abcdefghijklmn1234567890ABC' MAXERROR AS 100000\n\n\u306a\u304a\u3001s3://Bucket-name/folder/\u4ee5\u4e0b\u306b\u3001000.gz, 001.gz, 002.gz...\u3068\u3042\u308b\u5834\u5408\u306b\u3001s3://Bucket-name/folder/00\u3068\u3057\u3066\u6307\u5b9a\u3057\u3066\u3042\u3052\u308b\u3068000.gz\u304b\u3089009.gz\u3092\u307e\u3068\u3081\u3066Copy\u3057\u3066\u304f\u308c\u307e\u3059\u3002\n\n3. Redshift Cluster\u309232 node\u3067\u7acb\u3061\u4e0a\u3052\u30011\u3068\u540c\u69d8\u306e\u51e6\u7406\u3092\u5b9f\u884c\u3001Import\u5b8c\u4e86\u5f8c\u306bnode\u6570\u3092\u6e1b\u3089\u3059\n\u3053\u3061\u3089\u304c\u305f\u3076\u3093\u6b63\u89e3\u3067\u3059\u3002#2\u306b\u304a\u3044\u3066\u300132 node\u3067Redshift Cluster\u3092\u7acb\u3061\u4e0a\u3052\u308b\u4ee5\u5916\u306f\u3001\u3084\u308b\u4e8b\u306f1\u3068\u540c\u69d8\u3067\u3059\u3002\n\n\ndynamo_test_table\u3068\u3044\u3046Dynamo Table\u306eRead Capacity Unit(RCU)\u309210,000\u306b\u8a2d\u5b9a\n32 node\u306edc1.large instance\u3092\u7acb\u3061\u4e0a\u3052\u308b\nRedshift\u306bPostgres command\u3067\u5165\u3063\u3066\u3001Redshift\u306etable\u3092\u4f5c\u3063\u3066\u304a\u304f\n4.Postgres command\u3067Copy\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\n\nCopy\u3092\u5b9f\u884c\u3059\u308b\u3068\u3001Dynamo\u7684\u306b\u306f8000 RCU\u3050\u3089\u3044\u306eThroughput\u304c\u51fa\u3066\u300150\u5206\u3050\u3089\u3044\u3067Copy\u304c\u5b8c\u4e86\u3057\u307e\u3057\u305f\u3002Copy\u5b8c\u4e86\u5f8c\u3001Redshift Cluster\u306eresize\u3067\u3001node\u6570\u3092\u6e1b\u3089\u305b\u3070OK\u3067\u3059\u3002resize\u81ea\u4f53\u306b\u308230\u5206-1\u6642\u9593\u3050\u3089\u3044\u304b\u304b\u308b\u306e\u3067\u6ce8\u610f\u3067\u3059\u3002\n\n\u304a\u307e\u3051\uff1aRedshift\u64cd\u4f5c\u3092shell\u304b\u3089\u884c\u3046\nRedshift\u306e\u51e6\u7406\u3092\u3001shell\u304b\u3089\u9023\u7d9a\u3057\u3066\u884c\u3044\u305f\u3044\u3001\u3068\u3044\u3046\u5834\u5408\u306b\u306f\u3001\u4ee5\u4e0b\u306e\u624b\u9806\u306b\u5f93\u3048\u3070OK\u3067\u3059\u3002\n\nPostgres command\u306ePassword\u5165\u529b\u3092Bypass\u3059\u308b\n\u5b9f\u884c\u3057\u305f\u3044postgres\u30b3\u30de\u30f3\u30c9\u3092-c\u4ee5\u4e0b\u3067\u6e21\u3059(\u305f\u3060\u3057\u6700\u5f8c\u306e;\u306f\u524a\u9664\u3059\u308b)\u3002\u4f8b\u3048\u3070\u4ee5\u4e0b\u3067Table\u4e00\u89a7\u3092\u8868\u793a\u3057\u307e\u3059\u3002\n\npsql -h redshift-test.c12345abcdefg.ap-northeast-1.redshift.amazonaws.com -U redshift_test -d redshiftest -p 5439 -c \"SELECT DISTINCT tablename  FROM pg_table_def WHERE schemaname = 'public'\"\n\n-U\u306fPassword bypass\u3092\u8a2d\u5b9a\u3055\u308c\u3066\u3044\u308bUsername, -h\u306fRedshift\u306eURL, -d\u306fDatabase Name\u3067\u3059\u3002\npostgres\u30b3\u30de\u30f3\u30c9\u5185\u3067\u3001'(\u30b3\u30f3\u30de)\u3092\u4f7f\u3046\u5834\u5408\u306b\u306f\u3001-c\u3092\"\u3067\u56f2\u3093\u3067\u3042\u3052\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\nnohup\u3068\u7d44\u307f\u5408\u308f\u305b\u308c\u3070\u3001Copy\u30b3\u30de\u30f3\u30c9\u3092shell\u306ebackground\u3067\u5b9f\u884c\u53ef\u80fd\u3067\u3059\u3002\nnohup psql -h redshift-test.c12345abcdefg.ap-northeast-1.redshift.amazonaws.com -U redshift_test -d redshiftest -p 5439 -c \"copy redshift-table-name from 's3://Bucket-name/folder/000.gz' credentials 'aws_access_key_id=AKISELIJGISEILIJSGS2;aws_secret_access_key=abcdefghijklmn1234567890ABC' MAXERROR AS 100000\" > copylog.log &\n\n## \u306f\u3058\u3081\u306b\n\nDynamoDB\u306b\u3042\u308b\u7d04150GB\u306eData\u3092Redshift\u306bImport\u3057\u3088\u3046\u3068\u3057\u3066\u30cf\u30de\u3063\u305f\u306e\u3067\u3001\u89e3\u6c7a\u65b9\u6cd5\u3092\u30c1\u30e9\u88cf\u3057\u3066\u304a\u304d\u307e\u3059\u3002  \n\n\u4ee5\u4e0b\u306e\u9806\u756a\u3067\u8a66\u3057\u305f\u306e\u3067\u3059\u304c\u3001\u7d50\u5c40#3\u304c\u6b63\u89e3\u3067\u3057\u305f\u3002#2\u306e\u65b9\u6cd5\u3067\u30822\u65e5\u639b\u304b\u308a\u3067Import\u81ea\u4f53\u306f\u3067\u304d\u307e\u3057\u305f\u304c\u3001\u304b\u306a\u308a\u529b\u6280\u306a\u611f\u306f\u5426\u3081\u307e\u305b\u3093\u3002\n\n1. `copy redshift-table-name from 'dynamodb://dynamo-table-name'`\u3068\u5b9f\u884c\n1. Dynamo\u304b\u3089S3\u306b\u4e00\u65e6Export\u3057\u3001\u305d\u306eFile\u3092Redshift\u306bImport\u3059\u308b\n1. Redshift Cluster\u309232 node\u3067\u7acb\u3061\u4e0a\u3052\u30011\u3068\u540c\u69d8\u306e\u51e6\u7406\u3092\u5b9f\u884c\u3001Import\u5b8c\u4e86\u5f8c\u306bnode\u6570\u3092\u6e1b\u3089\u3059\n\n\n## \u30cf\u30de\u30ea\u306e\u30dd\u30a4\u30f3\u30c8\n\n\u4eca\u56de\u30cf\u30de\u30c3\u305f\u7406\u7531\u306f\u3001\u5927\u91cf\u306eData\u3092Dynamo\u2192Redshift\u306bImport\u3059\u308b\u5834\u5408\u306b\u3001\u5927\u91cf\u306enode\u306eRedshift cluster\u3092\u7528\u610f\u3057\u3066\u304a\u304b\u306a\u3044\u3068\u3001Copy\u306b\u6642\u9593\u304c\u304b\u304b\u308a\u3001timeout\u3067error\u306b\u306a\u308a\u307e\u3059\u3088\u3001\u3068\u3044\u3046\u4e8b\u3067\u3059\u3002\n\n\u6700\u521d\u30011 node\u306eRedshift Cluster\u306bcopy\u51e6\u7406\u3092\u5b9f\u884c\u3059\u308b\u3068\u300140\u6642\u9593\u8fd1\u304f\u639b\u304b\u3063\u305f\u3042\u3052\u304f\u6700\u5f8c\u306bCopy\u304cerror\u3067\u5931\u6557\u3068\u306a\u308a\u307e\u3057\u305f\u3002\u9006\u306b32 node\u7b49\u3067Redshift Cluster\u3092\u7acb\u3061\u4e0a\u3052Copy\u51e6\u7406\u3092\u3059\u308b\u3068\u3001(Dynamo Read\u3067\u898b\u308b\u9650\u308a)20-40\u500d\u8fd1\u304f\u306eThroughput\u3067Copy\u304c\u3055\u308c\u30011\u6642\u9593\u5f31\u3067\u5b8c\u4e86\u3057\u307e\u3059\u3002Copy\u5b8c\u4e86\u5f8c\u3001Cluster\u306enode\u6570\u3092\u9069\u5b9c\u6e1b\u3089\u305b\u3070\u7d42\u4e86\u3067\u3059\u3002\n\n## 1. `copy redshift-table-name from 'dynamodb://dynamo-table-name'`\u3068\u5b9f\u884c\n\nDynamo\u306eData\u3092Redshift\u306bImport\u3092\u3057\u305f\u3044\uff01\u3068\u306a\u308b\u3068\u3001\u307e\u305a\u306f[Amazon\u306eDocument\u306b\u3042\u308b\u69d8\u306b](http://docs.aws.amazon.com/redshift/latest/dg/r_COPY_command_examples.html#r_COPY_command_examples-load-favoritemovies-from-an-amazon-dynamodb-table)\u3001Redshift Cluster\u3092\u7acb\u3061\u4e0a\u3052\u3066\u3001Redshift command\u3067`copy xx from 'dynamodb://yy'`\u3068\u3084\u308b\u306e\u304c\u738b\u9053\u3060\u3068\u601d\u3044\u307e\u3059(Dynamo\u306eData\u91cf\u304c\u5c11\u306a\u3044\u5834\u5408\u306f\u3001\u3053\u308c\u3067\u5341\u5206\u306b\u52d5\u304d\u307e\u3057\u305f)\u3002\n\n\u306a\u306e\u3067\u3001\u4ee5\u4e0b\u306e\u624b\u9806\u3092\u3068\u308a\u307e\u3057\u305f\u3002\n\n1.`dynamo_test_table`\u3068\u3044\u3046Dynamo Table\u306eRead Capacity Unit(RCU)\u309210,000\u306b\u8a2d\u5b9a\n2.1 node\u306e`ds2.xlarge` instance\u3092\u7acb\u3061\u4e0a\u3052\u308b\n3.Redshift\u306bPostgres command\u3067\u5165\u3063\u3066\u3001Redshift\u306etable\u3092\u4f5c\u3063\u3066\u304a\u304f\n\n```\nCREATE TABLE redshift-table-name(\n  end_user VARCHAR(36) encode raw,\n  created_at VARCHAR(36) encode text255,\n  lang VARCHAR(10) encode raw,\n)\n  distkey(end_user)\n  compound sortkey(created_at);\n```\n\n4.Postgres command\u3067Copy\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\n\n```\ncopy redshift-table-name from 'dynamodb://dynamo_test_table' credentials 'aws_access_key_id=AKISELIJGISEILIJSGS2;aws_secret_access_key=abcdefghijklmn1234567890ABC' MAXERROR AS 100000 readratio 100\n```\n\n\u6ce8\uff1aAPI/Secret Key\u306f\u9069\u5f53\u3067\u3059\n\n\u3059\u308b\u3068\u3001Dynamo Read\u306f250 RCU\u3050\u3089\u3044\u3057\u304bThroughput\u304c\u51fa\u305a\u3001\u305d\u306e\u72b6\u614b\u304c30\u6642\u9593\u8fd1\u304f\u7d9a\u304d\u307e\u3059\u3002\u305d\u306e\u5f8c\u300110\u6642\u9593\u3050\u3089\u3044Dynamo Read\u304c\u7121\u3044\u72b6\u614b\u304c\u7d9a\u304d\u3001\u6700\u7d42\u7684\u306bCopy\u304cTerminated\u3067\u5931\u6557\u3057\u307e\u3057\u305f(\u6ce3)\u3002ssh\u306eConnection\u304c\u5207\u308c\u306a\u3044\u3088\u3046\u306b\u3057\u3066\u3082\u3001\u30c0\u30e1\u3067\u3057\u305f\u3002\n\n## 2. Dynamo\u304b\u3089S3\u306b\u4e00\u65e6Export\u3057\u3001\u305d\u306eFile\u3092Redshift\u306bImport\u3059\u308b\n\n\u6b21\u306b\u8a66\u3057\u305f\u306e\u304c\u3001Dynamo\u306e150GB\u306eData\u3092\u4e00\u65e6S3\u306bExport\u3057\u3001\u305d\u306eFile\u3092Redshift\u306bImport\u3059\u308b\u3001\u3068\u3044\u3046\u624b\u9806\u3067\u3059\u3002\u3053\u308c\u81ea\u4f53\u306f\u4e0a\u624b\u304f\u884c\u3063\u305f\u306e\u3067\u3059\u304c\u3001Dynamo\u304b\u3089\u306eExport\u3067\u30cf\u30de\u30ea\u6240\u304c1\u7b87\u6240\u3042\u308b\u306e\u3068\u3001Python script\u7b49\u3067Format\u5909\u63db\u3092\u30b4\u30ea\u30b4\u30ea\u66f8\u304f\u5fc5\u8981\u304c\u6709\u308a\u307e\u3059\u3002\n\n\u624b\u9806\u306f\u4ee5\u4e0b\u306e\u69d8\u306b\u306a\u308a\u307e\u3059\u3002\n\n1. Dynamo\u306eS3 export\u6a5f\u80fd\u3092\u4f7f\u3063\u3066S3 bucket\u306bfile\u3068\u3057\u3066\u66f8\u304d\u51fa\u3059\n1. S3\u306b\u66f8\u304d\u51fa\u3055\u308c\u305ffile\u3092EC2\u306bCopy\u3059\u308b\n1. S3\u306b\u66f8\u304d\u51fa\u3055\u308c\u305ffile\u306f(csv\u3084json\u3067\u306f\u306a\u3044)\u7279\u6b8a\u306aformat\u306a\u306e\u3067\u3001csv\u7b49\u306bformat\u5909\u63db\u3059\u308b\n1. `ds2.xlarge` instance\u30921 node\u3067\u7acb\u3061\u4e0a\u3052\u308b\n1. csv\u306b\u5909\u63db\u3055\u308c\u305ffile\u3092\u3001gzip\u5727\u7e2e\u3057\u3066\u3001S3\u306b\u518d\u5ea6upload\u3059\u308b\n1. S3\u306bupload\u3055\u308c\u305fgzip file\u3092\u30d7\u30c1\u30d7\u30c1Redshift cluster\u306bCopy\u3057\u3066\u3044\u304f\n\n\n### Dynamo\u306eS3 export\u6a5f\u80fd\u3092\u4f7f\u3063\u3066S3 bucket\u306bfile\u3068\u3057\u3066\u66f8\u304d\u51fa\u3059\n\nAmazon\u6a19\u6e96\u306e\u6a5f\u80fd\u306a\u306e\u3067\u3001\u64cd\u4f5c\u306b\u8ff7\u3046\u4e8b\u306f\u7121\u3044\u3068\u601d\u3044\u307e\u3059\u304c\u3001[\u3053\u306e\u8a18\u4e8b\u306b\u3042\u308b\u3088\u3046\u306a\u7f60](http://ijin.github.io/blog/2015/07/02/dynamodb-export-with-datapipeline/)\u304c\u5b58\u5728\u3059\u308b\u305f\u3081\u3001S3 export\u306e\u70ba\u306eEMR\u306e\u8a2d\u5b9a\u3092\u8272\u3005Tuning\u3059\u308b\u5fc5\u8981\u304c\u6709\u308a\u307e\u3059\u3002150GB\u306eDynamo Data\u309214\u6642\u9593\u304b\u304b\u3063\u3066\u4f55\u3068\u304bExport\u5b8c\u4e86\u3001150GB\u306eData\u306f200MB * 900\u500b\u3050\u3089\u3044\u306efile\u306b\u5206\u5272\u3055\u308c\u3001S3\u306b\u4fdd\u5b58\u3055\u308c\u307e\u3059\u3002\n\n\n### S3\u306b\u66f8\u304d\u51fa\u3055\u308c\u305ffile\u3092EC2\u306bCopy\u3059\u308b\n\nS3\u306b\u66f8\u304d\u51fa\u3055\u308c\u305fDynamo data\u306f\u3001[\u7279\u6b8a\u306aformat\u306a\u306e\u3067\u3001\u3053\u306e\u307e\u307eRedshift\u3078Import\u306f\u51fa\u6765\u307e\u305b\u3093!](http://docs.aws.amazon.com/datapipeline/latest/DeveloperGuide/dp-importexport-ddb-pipelinejson-verifydata2.html)\u3002\n\nDynamo 1 record\u304c\u3001`created_at.{\"n\":\"123456789012345\"}.end_user.{\"s\":\"12345-67890-112345-67890\"}`\u307f\u305f\u3044\u306aformat\u3067\u66f8\u304d\u51fa\u3055\u308c\u307e\u3059\u3002\u3053\u306e\u4ed5\u69d8\u3092\u77e5\u3063\u305f\u6642\u306f\u5272\u3068\u6ce3\u304d\u305d\u3046\u306b\u306a\u308a\u307e\u3057\u305f\u304c\u3001\u3068\u3082\u3042\u308cFormat\u5909\u63db\u304c\u5fc5\u8981\u306a\u306e\u3067\u3001\u4e00\u65e6EC2\u306bfile\u3092\u5168\u3066Copy\u3057\u307e\u3059\u3002\n\n### file\u3092csv\u7b49\u306bformat\u5909\u63db\u3059\u308b\n\n\u3053\u306e\u7279\u6b8a\u306aFormat\u304c\u4f55\u8005\u306a\u306e\u304b\u306f\u4e0d\u660e\u3067\u3059\u304c\u3001[\u3053\u306e\u8a18\u4e8b\u304b\u3089](http://stackoverflow.com/questions/18896329/export-data-from-dynamodb)\u3001\u4ee5\u4e0b\u306eshell command\u3067json\u306b\u5909\u63db\u3067\u304d\u307e\u3059\u3002\n\n\u4ee5\u4e0b\u3001`1234-5678-abcd-efghij0123456-000000`\u3068\u8a00\u3046\u7279\u6b8aformat\u306afile\u3092`000000.json`\u3068\u3044\u3046json file\u306b\u5909\u63db\u3057\u3066\u304f\u308c\u307e\u3059\u3002\n\n```\nsed -e 's/$/}/' -e $'s/\\x02/,\"/g' -e $'s/\\x03/\":/g' -e 's/^/{\"/' 1234-5678-abcd-efghij0123456-000000 > 000.json\n```\n\n\u304c\u3001\u7dba\u9e97\u306akey-value\u306ejson\u306b\u6210\u3089\u305a\u3001`{\"created_at\":{\"n\":\"12345678901234\"},\"end_user\":{\"s\":\"12345-67890-112345-67890\"}}`\u307f\u305f\u3044\u306a\u5909\u306ajson\u306b\u306a\u308a\u307e\u3059\u3002\u3053\u306e\u307e\u307e\u3067\u306fRedshift\u306b\u8aad\u307f\u8fbc\u307e\u305b\u3089\u308c\u306a\u3044\u306e\u3067\u3001Python\u7b49\u3067\u30b4\u30ea\u30b4\u30eacsv\u7b49\u306b\u66f8\u304d\u51fa\u3057\u307e\u3059\u3002\n\n\n### csv\u306b\u5909\u63db\u3055\u308c\u305ffile\u3092\u3001gzip\u5727\u7e2e\u3057\u3066\u3001S3\u306b\u518d\u5ea6upload\u3059\u308b\n\ncsv\u5909\u63db\u3055\u308c\u305ffile\u306f\u3001\u3053\u306e\u307e\u307eRedshift\u306b\u8aad\u307f\u8fbc\u307e\u305b\u308b\u4e8b\u304c\u53ef\u80fd\u3067\u3059\u304c\u3001gzip\u5727\u7e2e\u3057\u3066S3\u306b\u7f6e\u3044\u305f\u65b9\u304c\u3001\u8aad\u307f\u8fbc\u307f\u304c\u65e9\u3044\u306e\u3067\u3001gzip\u5727\u7e2e\u3057\u3066S3\u306b\u518d\u5ea6upload\u3057\u307e\u3059\u3002\n\n\n#### S3\u306bupload\u3055\u308c\u305fgzip file\u3092\u30d7\u30c1\u30d7\u30c1Redshift cluster\u306bCopy\u3057\u3066\u3044\u304f\n\n\u3064\u3044\u306b\u3001Redshift\u3078\u306eImport\u3067\u3059\u3002[\u3053\u306e\u8a18\u4e8b\u306b\u3042\u308b\u3088\u3046\u306b](http://docs.aws.amazon.com/redshift/latest/dg/r_COPY_command_examples.html#r_COPY_command_examples-load-listing-from-an-amazon-s3-bucket)\u3001\u4ee5\u4e0b\u306ePostgres Copy command\u3092\u5b9f\u884c\u3057\u307e\u3059\u3002\n\n```\ncopy redshift-table-name from 's3://Bucket-name/folder/000.gz' credentials 'aws_access_key_id=AKISELIJGISEILIJSGS2;aws_secret_access_key=abcdefghijklmn1234567890ABC' MAXERROR AS 100000\n```\n\n\u306a\u304a\u3001`s3://Bucket-name/folder/`\u4ee5\u4e0b\u306b\u3001`000.gz`, `001.gz`, `002.gz`...\u3068\u3042\u308b\u5834\u5408\u306b\u3001`s3://Bucket-name/folder/00`\u3068\u3057\u3066\u6307\u5b9a\u3057\u3066\u3042\u3052\u308b\u3068`000.gz`\u304b\u3089`009.gz`\u3092\u307e\u3068\u3081\u3066Copy\u3057\u3066\u304f\u308c\u307e\u3059\u3002\n\n## 3. Redshift Cluster\u309232 node\u3067\u7acb\u3061\u4e0a\u3052\u30011\u3068\u540c\u69d8\u306e\u51e6\u7406\u3092\u5b9f\u884c\u3001Import\u5b8c\u4e86\u5f8c\u306bnode\u6570\u3092\u6e1b\u3089\u3059\n\n\u3053\u3061\u3089\u304c\u305f\u3076\u3093\u6b63\u89e3\u3067\u3059\u3002#2\u306b\u304a\u3044\u3066\u300132 node\u3067Redshift Cluster\u3092\u7acb\u3061\u4e0a\u3052\u308b\u4ee5\u5916\u306f\u3001\u3084\u308b\u4e8b\u306f1\u3068\u540c\u69d8\u3067\u3059\u3002\n\n1. `dynamo_test_table`\u3068\u3044\u3046Dynamo Table\u306eRead Capacity Unit(RCU)\u309210,000\u306b\u8a2d\u5b9a\n2. 32 node\u306e`dc1.large` instance\u3092\u7acb\u3061\u4e0a\u3052\u308b\n3. Redshift\u306bPostgres command\u3067\u5165\u3063\u3066\u3001Redshift\u306etable\u3092\u4f5c\u3063\u3066\u304a\u304f\n4.Postgres command\u3067Copy\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\n\nCopy\u3092\u5b9f\u884c\u3059\u308b\u3068\u3001Dynamo\u7684\u306b\u306f8000 RCU\u3050\u3089\u3044\u306eThroughput\u304c\u51fa\u3066\u300150\u5206\u3050\u3089\u3044\u3067Copy\u304c\u5b8c\u4e86\u3057\u307e\u3057\u305f\u3002Copy\u5b8c\u4e86\u5f8c\u3001Redshift Cluster\u306eresize\u3067\u3001node\u6570\u3092\u6e1b\u3089\u305b\u3070OK\u3067\u3059\u3002resize\u81ea\u4f53\u306b\u308230\u5206-1\u6642\u9593\u3050\u3089\u3044\u304b\u304b\u308b\u306e\u3067\u6ce8\u610f\u3067\u3059\u3002\n\n\n\n## \u304a\u307e\u3051\uff1aRedshift\u64cd\u4f5c\u3092shell\u304b\u3089\u884c\u3046\nRedshift\u306e\u51e6\u7406\u3092\u3001shell\u304b\u3089\u9023\u7d9a\u3057\u3066\u884c\u3044\u305f\u3044\u3001\u3068\u3044\u3046\u5834\u5408\u306b\u306f\u3001\u4ee5\u4e0b\u306e\u624b\u9806\u306b\u5f93\u3048\u3070OK\u3067\u3059\u3002\n\n1. [Postgres command\u306ePassword\u5165\u529b\u3092Bypass\u3059\u308b](http://qiita.com/ozash/items/48b7701724f189c48814)\n1. \u5b9f\u884c\u3057\u305f\u3044postgres\u30b3\u30de\u30f3\u30c9\u3092`-c`\u4ee5\u4e0b\u3067\u6e21\u3059(\u305f\u3060\u3057\u6700\u5f8c\u306e`;`\u306f\u524a\u9664\u3059\u308b)\u3002\u4f8b\u3048\u3070\u4ee5\u4e0b\u3067Table\u4e00\u89a7\u3092\u8868\u793a\u3057\u307e\u3059\u3002\n\n```\npsql -h redshift-test.c12345abcdefg.ap-northeast-1.redshift.amazonaws.com -U redshift_test -d redshiftest -p 5439 -c \"SELECT DISTINCT tablename  FROM pg_table_def WHERE schemaname = 'public'\"\n```\n\n`-U`\u306fPassword bypass\u3092\u8a2d\u5b9a\u3055\u308c\u3066\u3044\u308bUsername, `-h`\u306fRedshift\u306eURL, `-d`\u306fDatabase Name\u3067\u3059\u3002\npostgres\u30b3\u30de\u30f3\u30c9\u5185\u3067\u3001`'(\u30b3\u30f3\u30de)`\u3092\u4f7f\u3046\u5834\u5408\u306b\u306f\u3001`-c`\u3092`\"`\u3067\u56f2\u3093\u3067\u3042\u3052\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\n\nnohup\u3068\u7d44\u307f\u5408\u308f\u305b\u308c\u3070\u3001Copy\u30b3\u30de\u30f3\u30c9\u3092shell\u306ebackground\u3067\u5b9f\u884c\u53ef\u80fd\u3067\u3059\u3002\n\n```\nnohup psql -h redshift-test.c12345abcdefg.ap-northeast-1.redshift.amazonaws.com -U redshift_test -d redshiftest -p 5439 -c \"copy redshift-table-name from 's3://Bucket-name/folder/000.gz' credentials 'aws_access_key_id=AKISELIJGISEILIJSGS2;aws_secret_access_key=abcdefghijklmn1234567890ABC' MAXERROR AS 100000\" > copylog.log &\n```\n", "tags": ["DynamoDB", "redshift"]}