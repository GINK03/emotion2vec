{"context": " More than 1 year has passed since last update.merry Xmas!\nAdvent Calendar 2015\u3082\u6700\u7d42\u65e5\u306b\u306a\u308a\u307e\u3057\u305f\u3002\n\u305a\u3063\u3068App Engine\u3070\u304b\u308a\u3060\u3063\u305f\u79c1\u3067\u3059\u304c\u4eca\u5e74\u306f\u3064\u3044\u306bCompute Engine\u306b\u30c7\u30d3\u30e5\u30fc\u3057\u307e\u3057\u305f\uff01\n\uff3c(^o^)\uff0f\nCompute Engine\u306epreemptible\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u6570\u767e\u53f0instance group\u3067\u69cb\u6210\u3057\u3066\u81ea\u52d5\u30b9\u30b1\u30fc\u30eb\u3055\u305b\u3066\u3044\u307e\u3059\u3002\n\u5404\u30b5\u30fc\u30d0\u30fc\u306fTask Queue\u3092\u76e3\u8996\u3057\u3066\u52d5\u304f\u69d8\u306b\u306a\u3063\u3066\u3044\u308b\u306e\u3067\u3001Queue\u306e\u6ede\u7559\u30b5\u30a4\u30ba\u76e3\u8996\u3057\u3066\u95be\u5024\u3092\u8d85\u3048\u305f\u3089slack\u306b\u30a2\u30e9\u30fc\u30c8\u98db\u3070\u3057\u305f\u3044\u306a\u30fc\u3001\u3068\u601d\u3063\u3066\u30c1\u30e3\u30ec\u30f3\u30b8\u3057\u307e\u3057\u305f\u3002\nGoogle Cloud Monitoring\u305d\u306e\u3082\u306e\u306b\u3064\u3044\u3066\u306fGCP Advent Calendar\u3067\u4ed6\u306e\u65b9\u304c\u65e2\u306b\u8a18\u4e8b\u3092\u66f8\u304b\u308c\u3066\u307e\u3057\u305f\u306e\u3067\u3053\u3053\u3067\u306f\u5272\u611b\u3057\u307e\u3059m(_ _)m\nhttp://qiita.com/FumihikoSHIROYAMA/items/6846630b44fbc3f22b8e\n\n\u6ce8\u610f\nGoogle Cloud Monitoring\u306f\u73fe\u6642\u70b9\u3067\u307e\u3060beta\u3067\u3059\u3002\n\u3053\u3053\u306b\u66f8\u304b\u308c\u3066\u3044\u308b\u5185\u5bb9\u306f\u53e4\u304f\u306a\u308b\u53ef\u80fd\u6027\u304c\u9ad8\u3044\u3067\u3059\u3002\n\n\u6e96\u5099\nCompute Engine\u306e\u81ea\u52d5\u30b9\u30b1\u30fc\u30eb\u306fGoogle Cloud Monitoring\u306e\u30e1\u30c8\u30ea\u30af\u30b9\u3092\u5143\u306b\u884c\u3046\u3053\u3068\u304c\u3067\u304d\u308b\u3089\u3057\u3044\u306e\u3067\u3001\u307e\u305a\u306fTask Queue\u306e\u6ede\u7559\u3092\u30ab\u30b9\u30bf\u30e0\u30e1\u30c8\u30ea\u30af\u30b9\u3068\u3057\u3066\u767b\u9332\u3057\u3066\u307f\u307e\u3059\u3002\n\u30ab\u30b9\u30bf\u30e0\u30e1\u30c8\u30ea\u30af\u30b9\u306b\u306f\u8efd\u91cf\u30ab\u30b9\u30bf\u30e0\u30e1\u30c8\u30ea\u30af\u30b9\uff08Lightweight custom metrics\uff09\u3068\u30e9\u30d9\u30eb\u4ed8\u304d\u30ab\u30b9\u30bf\u30e0\u30e1\u30c8\u30ea\u30af\u30b9\uff08Labeled custom metrics\uff09\u304c\u3042\u308a\u307e\u3059\u3002\n\u4eca\u56de\u306f\u30e9\u30d9\u30eb\u4ed8\u304d\u30ab\u30b9\u30bf\u30e0\u30e1\u30c8\u30ea\u30af\u30b9\u3092\u4f7f\u7528\u3057\u307e\u3059\u3002\n\u307e\u305aMetricDescriptor\u306a\u308b\u3082\u306e\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\u3053\u308c\u304c\u30e1\u30c8\u30ea\u30c3\u30af\u306e\u5b9a\u7fa9\u306b\u306a\u308a\u307e\u3059\u3002\n\u203b\u8efd\u91cf\u30ab\u30b9\u30bf\u30e0\u30e1\u30c8\u30ea\u30af\u30b9\u306e\u5834\u5408\u306f\u3053\u306e\u30b9\u30c6\u30c3\u30d7\u3092\u7701\u7565\u51fa\u6765\u307e\u3059\uff08\u30e1\u30c8\u30ea\u30c3\u30af\u3092\u66f8\u304d\u8fbc\u3080\u3068\u88cf\u3067\u52dd\u624b\u306b\u4f5c\u6210\u3055\u308c\u308b\u3089\u3057\u3044\uff09\u3002\n\u73fe\u6642\u70b9\u3067\u7ba1\u7406\u30b3\u30f3\u30bd\u30fc\u30eb\u304b\u3089\u30dd\u30c1\u30dd\u30c1\u3068\u306f\u4f5c\u308c\u306a\u3044\u307f\u305f\u3044\u306a\u306e\u3067\u3001API\u3067\u4f5c\u6210\u3057\u307e\u3059\u3002\nAPI Manager\u304b\u3089Google Cloud Monitoring API\u3092\u6709\u52b9\u306b\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\n\u2191\u753b\u9762\u3067\u300cGoogle cloud monitoring API\u300d\u3092\u691c\u7d22\u3057\u3066\u9078\u629e\u3002\n\n\u300cAPI\u3092\u6709\u52b9\u306b\u3059\u308b\u300d\u30dc\u30bf\u30f3\u3092\u30af\u30ea\u30c3\u30af\u3057\u307e\u3059\u3002\nAPI Explorer\u3092\u4f7f\u3063\u3066\u30d6\u30e9\u30a6\u30b6\u304b\u3089API\u3092\u5b9f\u884c\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\u300c\u3053\u306eAPI\u3092API Exploer\u3067\u8a66\u3059\u300d\u3092\u30af\u30ea\u30c3\u30af\u3059\u308b\u3068API Explorer\u304c\u958b\u304d\u307e\u3059\u3002\n\nAPI\u306e\u4e00\u89a7\u304c\u8868\u793a\u3055\u308c\u308b\u306e\u3067\u300ccloudmonitoring.metricDescriptors.create\u300d\u3092\u9078\u629e\u3057\u307e\u3059\u3002\n\n\u53f3\u4e0a\u306e\u300cAuthorize requests using OAuth 2.0\u300d\u306e\u30b9\u30a4\u30c3\u30c1\u304cOFF\u306b\u306a\u3063\u3066\u3044\u305f\u3089\u30af\u30ea\u30c3\u30af\uff06\u627f\u8a8d\u3057\u3066ON\u306b\u3057\u307e\u3059\u3002\nproject\u30d5\u30a3\u30fc\u30eb\u30c9\u306bGCP\u306eproject ID\u3001Request body\u306b\u767b\u9332\u30ea\u30af\u30a8\u30b9\u30c8JSON\u3092\u5165\u529b\u3057\u307e\u3059\u3002\n{\n \"name\": \"custom.cloudmonitoring.googleapis.com/tasks_in_queue\",\n \"labels\": [\n  {\n   \"key\": \"custom.cloudmonitoring.googleapis.com/queue_name\",\n   \"description\": \"A queue name.\"\n  }\n ],\n \"description\": \"Tasks in queue.\",\n \"typeDescriptor\": {\n  \"metricType\": \"gauge\",\n  \"valueType\": \"int64\"\n },\n \"project\": \"your_project_id\"\n}\n\nAPI\u306e\u8a73\u7d30\u306f\u4e0b\u8a18\u53c2\u7167\nhttps://cloud.google.com/monitoring/v2beta2/metricDescriptors#resource\nname\u306b\u30e1\u30c8\u30ea\u30c3\u30af\u540d\u3001labels\u3067\u30e9\u30d9\u30eb\u3092\u6700\u592710\u500b\u307e\u3067\u6307\u5b9a\u51fa\u6765\u307e\u3059\u3002\nname\u3068label\u306ekey\u306b\u306f\u300ccustom.cloudmonitoring.googleapis.com/\u300d\u3068\u3044\u3046\u30d7\u30ec\u30d5\u30a3\u30c3\u30af\u30b9\u304c\u5fc5\u8981\u306a\u306e\u3067\u8981\u6ce8\u610f\u3067\u3059\u3002\ntypeDescriptor\u306evalueType\u306b\u306fint64\u307e\u305f\u306fdouble\u304c\u6307\u5b9a\u51fa\u6765\u307e\u3059\u3002\n\u4e0a\u8a18\u3067\u306f\u30bf\u30b9\u30af\u6ede\u7559\u3092\u76e3\u8996\u3059\u308b\u30e1\u30c8\u30ea\u30c3\u30af\u300ctasks_in_queue\u300d\u3092\u767b\u9332\u3057\u307e\u3057\u305f\u3002\n\u3064\u3044\u3067\u306b\u76f4\u8fd11\u5206\u9593\u306b\u634c\u3051\u305f\u30bf\u30b9\u30af\u6570\u306e\u30e1\u30c8\u30ea\u30c3\u30af\u300ctasks_executed_min\u300d\u3082\u767b\u9332\u3057\u3066\u304a\u304d\u307e\u3059\u2193\n{\n \"name\": \"custom.cloudmonitoring.googleapis.com/tasks_executed_min\",\n \"labels\": [\n  {\n   \"key\": \"custom.cloudmonitoring.googleapis.com/queue_name\",\n   \"description\": \"A queue name.\"\n  }\n ],\n \"description\": \"Tasks executed in a minute.\",\n \"typeDescriptor\": {\n  \"metricType\": \"gauge\",\n  \"valueType\": \"int64\"\n },\n \"project\": \"your_project_id\"\n}\n\n\n\u30e1\u30c8\u30ea\u30c3\u30af\u53ce\u96c6\n\u6b21\u306b\u30e1\u30c8\u30ea\u30c3\u30af\u306e\u53ce\u96c6\u3067\u3059\u304c\u3001Google App Engine\u306e\u30a2\u30d7\u30ea\u3092cron\u3067\u5b9a\u671f\u8d77\u52d5\u3057\u3066\u3001\u305d\u3053\u304b\u3089Google client library\u3067cloud monitoring API\u3092\u547c\u3073\u51fa\u3057\u3066\u30e1\u30c8\u30ea\u30c3\u30af\u3092\u66f8\u304d\u8fbc\u3080\u3053\u3068\u306b\u3057\u307e\u3059\u3002\n\u30b3\u30fc\u30c9\u4f8b\u306fGo\u3067\u3059\u3002Python\u3084Java\u306a\u3069\u4ed6\u8a00\u8a9e\u306e\u30e9\u30a4\u30d6\u30e9\u30ea\u3082\u7528\u610f\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n\u203b\u8a18\u4e8b\u306e\u672c\u7b4b\u304b\u3089\u306f\u5916\u308c\u308b\u306e\u3067\u629c\u7c8b\u3067\u3059\nfunc MonitorQueues(w http.ResponseWriter, r *http.Request) {\n    ctx := appengine.NewContext(r)\n\n    appID := appengine.AppID(ctx)\n\n    queues := []string{\"assemble\", \"flip\", \"order\", \"render\"}\n\n    qstats, err := taskqueue.QueueStats(ctx, queues)\n    if err != nil {\n        http.Error(w, err.Error(), http.StatusInternalServerError)\n        return\n    }\n\n    hc := &http.Client{\n        Transport: &oauth2.Transport{\n            Source: google.AppEngineTokenSource(ctx, cloudmonitoring.MonitoringScope),\n            Base:   &urlfetch.Transport{Context: ctx},\n        },\n    }\n\n    service, err := cloudmonitoring.New(hc)\n    if err != nil {\n        http.Error(w, err.Error(), http.StatusInternalServerError)\n        return\n    }\n\n    t := time.Now().UTC().Format(time.RFC3339)\n\n    var tpoints []*cloudmonitoring.TimeseriesPoint\n\n    newTpoint := func(metric, queue string, value int64) *cloudmonitoring.TimeseriesPoint {\n        return &cloudmonitoring.TimeseriesPoint{\n            Point: &cloudmonitoring.Point{\n                Start:      t,\n                End:        t,\n                Int64Value: &value,\n            },\n            TimeseriesDesc: &cloudmonitoring.TimeseriesDescriptor{\n                Project: appID,\n                Metric:  \"custom.cloudmonitoring.googleapis.com/\" + metric,\n                Labels: map[string]string{\n                    \"custom.cloudmonitoring.googleapis.com/queue_name\": queue,\n                },\n            },\n        }\n    }\n\n    for i, queue := range queues {\n        tpoints = append(tpoints, newTpoint(\"tasks_in_queue\", queue, int64(qstats[i].Tasks)))\n        tpoints = append(tpoints, newTpoint(\"tasks_executed_min\", queue, int64(qstats[i].Executed1Minute)))\n    }\n\n    req := cloudmonitoring.WriteTimeseriesRequest{Timeseries: tpoints}\n\n    _, err = service.Timeseries.Write(appID, &req).Do()\n    if err != nil {\n        http.Error(w, err.Error(), http.StatusInternalServerError)\n        return\n    }\n\n    return\n}\n\nqueue\u304c4\u7a2e\u985e\u3042\u308b\u306e\u3067\u3059\u304c\u3001\u305d\u308c\u305e\u308c\u306e\u7d71\u8a08\u60c5\u5831\u304b\u3089\u683c\u7d0d\u3055\u308c\u3066\u3044\u308b\u30bf\u30b9\u30af\u6570\u3068\u76f4\u8fd11\u5206\u9593\u306e\u5b9f\u884c\u6570\u3092\u53d6\u5f97\u3057\u3001\u30e1\u30c8\u30ea\u30c3\u30af\u3068\u3057\u3066\u66f8\u304d\u8fbc\u3093\u3067\u3044\u307e\u3059\u3002\n\u30e9\u30d9\u30ebqueue_name\u306b\u306f\u305d\u308c\u305e\u308c\u306equeue\u540d\u3092\u6307\u5b9a\u3057\u3066\u3044\u307e\u3059\u3002\nTimeseriesDescriptor\u306eProject\u30d5\u30a3\u30fc\u30eb\u30c9\u3068\u3001Timeseries.Write\u30e1\u30bd\u30c3\u30c9\u306e\u7b2c\u4e00\u5f15\u6570\u306b\u306fGCP\u306e\u30d7\u30ed\u30b8\u30a7\u30af\u30c8ID\u3092\u6e21\u3059\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002App Engine\u306e\u5834\u5408\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3ID==\u30d7\u30ed\u30b8\u30a7\u30af\u30c8ID\u306b\u306a\u308b\u306e\u3067\u305d\u308c\u3092\u6e21\u3057\u3066\u3044\u307e\u3059\u3002\n\n\u76e3\u8996\n\u66f8\u304d\u8fbc\u3093\u3060\u30ab\u30b9\u30bf\u30e0\u30e1\u30c8\u30ea\u30af\u30b9\u3092Cloud Monitoring\u3067\u30c1\u30e3\u30fc\u30c8\u306b\u8868\u793a\u3057\u307e\u3057\u3087\u3046\u3002\n\u30c7\u30d5\u30a9\u30eb\u30c8\u306e\u30c0\u30c3\u30b7\u30e5\u30dc\u30fc\u30c9\u306e\u753b\u9762\u53f3\u4e0b\u306e\u65b9\u306b\n\n\u3053\u3093\u306a\u30dc\u30bf\u30f3\u304c\u3042\u308a\u307e\u3059\u3002\u3053\u308c\u3092\u30af\u30ea\u30c3\u30af\u3059\u308b\u3068\u30c1\u30e3\u30fc\u30c8\u304c\u8ffd\u52a0\u3055\u308c\u307e\u3059\u3002\n\u30ab\u30b9\u30bf\u30e0\u30c0\u30c3\u30b7\u30e5\u30dc\u30fc\u30c9\u3092\u4f5c\u6210\u3057\u3066\u305d\u3053\u306b\u8ffd\u52a0\u3059\u308b\u3053\u3068\u3082\u51fa\u6765\u307e\u3059\u3002\n\nResource Type\u306b\u300cCustom Metrics V2\u300d\u3001Metric\u306b\u4f5c\u6210\u3057\u305f\u30e1\u30c8\u30ea\u30c3\u30af\u540d\u3001Labels\u306b\u8868\u793a\u3057\u305f\u3044\u30e9\u30d9\u30eb\u3092\u6307\u5b9a\u3057\u307e\u3059\uff08\u3053\u3053\u3067\u306f\u5168queue\u306e\u60c5\u5831\u3092\u4e00\u3064\u306e\u30c1\u30e3\u30fc\u30c8\u306b\u8868\u793a\u3057\u305f\u3044\u306e\u3067Any\u3092\u6307\u5b9a\uff09\u3002\n\u300cSave\u300d\u3092\u30af\u30ea\u30c3\u30af\u3059\u308b\u3068\u30c1\u30e3\u30fc\u30c8\u304c\u8ffd\u52a0\u3055\u308c\u307e\u3059\u3002\n\u540c\u69d8\u306btasks_executed_min\u30e1\u30c8\u30ea\u30c3\u30af\u306e\u30c1\u30e3\u30fc\u30c8\u3082\u8ffd\u52a0\u3057\u307e\u3059\u3002\n\n\u51fa\u305f\uff01  \uff3c(^o^)\uff0f\n\u4fbf\u5229\u3067\u3059\u306d\uff01(^^)\n\n\u30a2\u30e9\u30fc\u30c8\n\u30ab\u30b9\u30bf\u30e0\u30e1\u30c8\u30ea\u30af\u30b9\u3092\u5143\u306b\u30a2\u30e9\u30fc\u30c8\u3092\u98db\u3070\u3059\u3053\u3068\u3082\u51fa\u6765\u307e\u3059(\u30ad\u30e5\u30fc\u306e\u6ede\u7559\u304c1000\u3092\u8d85\u3048\u305f\u3089\u30a2\u30e9\u30fc\u30c8\u3001etc)\u3002\u624b\u9806\u306f\u901a\u5e38\u306e\u30e1\u30c8\u30ea\u30af\u30b9\u306b\u5bfe\u3059\u308b\u8a2d\u5b9a\u3068\u540c\u69d8\u3067\u3059\u3002\n\u3053\u306e\u8fba\u3082\u4e0b\u8a18\u8a18\u4e8b\u3067\u65e2\u306b\u66f8\u304b\u308c\u3066\u307e\u3057\u305f\u306e\u3067\u5272\u611b\u3057\u307e\u3059m(_ _)m\nhttp://qiita.com/FumihikoSHIROYAMA/items/6846630b44fbc3f22b8e\nslack\u3078\u306e\u30a2\u30e9\u30fc\u30c8\u3082\u753b\u9762\u306b\u5f93\u3063\u3066\u30dd\u30c1\u30dd\u30c1\u3084\u3063\u3066\u3044\u304f\u3060\u3051\u3067\u9a5a\u304f\u307b\u3069\u7c21\u5358\u306b\u8a2d\u5b9a\u51fa\u6765\u307e\u3057\u305f\uff3c(^o^)\uff0f\n\n\u6094\u6068\n\u4eca\u56de\u5b9f\u306f\u3001\n\u300cGoogle Cloud Monitoring\u3092\u4f7f\u3063\u3066Task Queue\u306e\u6ede\u7559\u3092\u76e3\u8996\u3057\u3066\u3001\u3055\u3089\u306b\u305d\u308c\u3092\u6307\u6a19\u306b\u3057\u3066\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u81ea\u52d5\u30b9\u30b1\u30fc\u30eb\u3055\u305b\u305f\u3044\u30ba\u30e9\u0e51\u25c9\ufecc\u25c9\u0e51\u300d\n\u3068\u3044\u3046\u30c6\u30fc\u30de\u3067\u8a18\u4e8b\u3092\u66f8\u304f\u4e88\u5b9a\u3060\u3063\u305f\u306e\u3067\u3059\u304c\u3001\u4ed5\u69d8\u3092\u5c11\u3057\u52d8\u9055\u3044\u3057\u3066\u3044\u3066\u5b9f\u73fe\u51fa\u6765\u307e\u305b\u3093\u3067\u3057\u305forz\nhttps://cloud.google.com/compute/docs/autoscaler/scaling-cloud-monitoring-metrics#choose_a_valid_custom_metric\n\u30aa\u30fc\u30c8\u30b9\u30b1\u30fc\u30eb\u7528\u30e1\u30c8\u30ea\u30c3\u30af\u306fVM\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u5358\u4f4d\u3067\u51fa\u529b\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u306e\u3067\u3059\u306d\u3002\n\u305d\u306e\u8fba\u308a\u306f\u307e\u305f\u6b21\u56de\u306e\u8b1b\u91c8\u3067\u30fb\u30fb\n\u826f\u3044\u304a\u5e74\u3092\u301c\uff3c(^o^)\uff0f\n**merry Xmas!**\n\nAdvent Calendar 2015\u3082\u6700\u7d42\u65e5\u306b\u306a\u308a\u307e\u3057\u305f\u3002\n\n\u305a\u3063\u3068App Engine\u3070\u304b\u308a\u3060\u3063\u305f\u79c1\u3067\u3059\u304c\u4eca\u5e74\u306f\u3064\u3044\u306bCompute Engine\u306b\u30c7\u30d3\u30e5\u30fc\u3057\u307e\u3057\u305f\uff01\n\uff3c(^o^)\uff0f\n\nCompute Engine\u306epreemptible\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u6570\u767e\u53f0instance group\u3067\u69cb\u6210\u3057\u3066\u81ea\u52d5\u30b9\u30b1\u30fc\u30eb\u3055\u305b\u3066\u3044\u307e\u3059\u3002\n\n\u5404\u30b5\u30fc\u30d0\u30fc\u306fTask Queue\u3092\u76e3\u8996\u3057\u3066\u52d5\u304f\u69d8\u306b\u306a\u3063\u3066\u3044\u308b\u306e\u3067\u3001Queue\u306e\u6ede\u7559\u30b5\u30a4\u30ba\u76e3\u8996\u3057\u3066\u95be\u5024\u3092\u8d85\u3048\u305f\u3089slack\u306b\u30a2\u30e9\u30fc\u30c8\u98db\u3070\u3057\u305f\u3044\u306a\u30fc\u3001\u3068\u601d\u3063\u3066\u30c1\u30e3\u30ec\u30f3\u30b8\u3057\u307e\u3057\u305f\u3002\n\nGoogle Cloud Monitoring\u305d\u306e\u3082\u306e\u306b\u3064\u3044\u3066\u306fGCP Advent Calendar\u3067\u4ed6\u306e\u65b9\u304c\u65e2\u306b\u8a18\u4e8b\u3092\u66f8\u304b\u308c\u3066\u307e\u3057\u305f\u306e\u3067\u3053\u3053\u3067\u306f\u5272\u611b\u3057\u307e\u3059m(_ _)m\nhttp://qiita.com/FumihikoSHIROYAMA/items/6846630b44fbc3f22b8e\n\n# \u6ce8\u610f\n\nGoogle Cloud Monitoring\u306f\u73fe\u6642\u70b9\u3067\u307e\u3060beta\u3067\u3059\u3002\n\u3053\u3053\u306b\u66f8\u304b\u308c\u3066\u3044\u308b\u5185\u5bb9\u306f\u53e4\u304f\u306a\u308b\u53ef\u80fd\u6027\u304c\u9ad8\u3044\u3067\u3059\u3002\n\n# \u6e96\u5099\n\nCompute Engine\u306e\u81ea\u52d5\u30b9\u30b1\u30fc\u30eb\u306fGoogle Cloud Monitoring\u306e\u30e1\u30c8\u30ea\u30af\u30b9\u3092\u5143\u306b\u884c\u3046\u3053\u3068\u304c\u3067\u304d\u308b\u3089\u3057\u3044\u306e\u3067\u3001\u307e\u305a\u306fTask Queue\u306e\u6ede\u7559\u3092\u30ab\u30b9\u30bf\u30e0\u30e1\u30c8\u30ea\u30af\u30b9\u3068\u3057\u3066\u767b\u9332\u3057\u3066\u307f\u307e\u3059\u3002\n\n\u30ab\u30b9\u30bf\u30e0\u30e1\u30c8\u30ea\u30af\u30b9\u306b\u306f\u8efd\u91cf\u30ab\u30b9\u30bf\u30e0\u30e1\u30c8\u30ea\u30af\u30b9\uff08Lightweight custom metrics\uff09\u3068\u30e9\u30d9\u30eb\u4ed8\u304d\u30ab\u30b9\u30bf\u30e0\u30e1\u30c8\u30ea\u30af\u30b9\uff08Labeled custom metrics\uff09\u304c\u3042\u308a\u307e\u3059\u3002\n\u4eca\u56de\u306f\u30e9\u30d9\u30eb\u4ed8\u304d\u30ab\u30b9\u30bf\u30e0\u30e1\u30c8\u30ea\u30af\u30b9\u3092\u4f7f\u7528\u3057\u307e\u3059\u3002\n\n\u307e\u305aMetricDescriptor\u306a\u308b\u3082\u306e\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\u3053\u308c\u304c\u30e1\u30c8\u30ea\u30c3\u30af\u306e\u5b9a\u7fa9\u306b\u306a\u308a\u307e\u3059\u3002\n\u203b\u8efd\u91cf\u30ab\u30b9\u30bf\u30e0\u30e1\u30c8\u30ea\u30af\u30b9\u306e\u5834\u5408\u306f\u3053\u306e\u30b9\u30c6\u30c3\u30d7\u3092\u7701\u7565\u51fa\u6765\u307e\u3059\uff08\u30e1\u30c8\u30ea\u30c3\u30af\u3092\u66f8\u304d\u8fbc\u3080\u3068\u88cf\u3067\u52dd\u624b\u306b\u4f5c\u6210\u3055\u308c\u308b\u3089\u3057\u3044\uff09\u3002\n\n\u73fe\u6642\u70b9\u3067\u7ba1\u7406\u30b3\u30f3\u30bd\u30fc\u30eb\u304b\u3089\u30dd\u30c1\u30dd\u30c1\u3068\u306f\u4f5c\u308c\u306a\u3044\u307f\u305f\u3044\u306a\u306e\u3067\u3001API\u3067\u4f5c\u6210\u3057\u307e\u3059\u3002\n\nAPI Manager\u304b\u3089Google Cloud Monitoring API\u3092\u6709\u52b9\u306b\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\n![\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2015-12-17 14.16.33.png](https://qiita-image-store.s3.amazonaws.com/0/31437/021bfcc3-497b-902d-c016-4fb6ebc843a4.png \"\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2015-12-17 14.16.33.png\")\n\n\u2191\u753b\u9762\u3067\u300cGoogle cloud monitoring API\u300d\u3092\u691c\u7d22\u3057\u3066\u9078\u629e\u3002\n\n![\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2015-12-17 13.35.43.png](https://qiita-image-store.s3.amazonaws.com/0/31437/90999486-1e16-24f1-9c6a-ee2f37dae26b.png \"\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2015-12-17 13.35.43.png\")\n\n\u300cAPI\u3092\u6709\u52b9\u306b\u3059\u308b\u300d\u30dc\u30bf\u30f3\u3092\u30af\u30ea\u30c3\u30af\u3057\u307e\u3059\u3002\n\nAPI Explorer\u3092\u4f7f\u3063\u3066\u30d6\u30e9\u30a6\u30b6\u304b\u3089API\u3092\u5b9f\u884c\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\u300c\u3053\u306eAPI\u3092API Exploer\u3067\u8a66\u3059\u300d\u3092\u30af\u30ea\u30c3\u30af\u3059\u308b\u3068API Explorer\u304c\u958b\u304d\u307e\u3059\u3002\n\n<img width=\"531\" alt=\"\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2015-12-18 14.03.22.png\" src=\"https://qiita-image-store.s3.amazonaws.com/0/31437/58c434cc-39b7-ea76-7e62-847b631c81e1.png\">\n\n\bAPI\u306e\u4e00\u89a7\u304c\u8868\u793a\u3055\u308c\u308b\u306e\u3067\u300ccloudmonitoring.metricDescriptors.create\u300d\u3092\u9078\u629e\u3057\u307e\u3059\u3002\n\n<img width=\"623\" alt=\"\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2015-12-18 14.15.16.png\" src=\"https://qiita-image-store.s3.amazonaws.com/0/31437/d4187e25-e4d0-08ff-7a55-28cf5f2d9005.png\">\n\n\u53f3\u4e0a\u306e\u300cAuthorize requests using OAuth 2.0\u300d\u306e\u30b9\u30a4\u30c3\u30c1\u304cOFF\u306b\u306a\u3063\u3066\u3044\u305f\u3089\u30af\u30ea\u30c3\u30af\uff06\u627f\u8a8d\u3057\u3066ON\u306b\u3057\u307e\u3059\u3002\n\nproject\u30d5\u30a3\u30fc\u30eb\u30c9\u306bGCP\u306eproject ID\u3001Request body\u306b\u767b\u9332\u30ea\u30af\u30a8\u30b9\u30c8JSON\u3092\u5165\u529b\u3057\u307e\u3059\u3002\n\n```json\n{\n \"name\": \"custom.cloudmonitoring.googleapis.com/tasks_in_queue\",\n \"labels\": [\n  {\n   \"key\": \"custom.cloudmonitoring.googleapis.com/queue_name\",\n   \"description\": \"A queue name.\"\n  }\n ],\n \"description\": \"Tasks in queue.\",\n \"typeDescriptor\": {\n  \"metricType\": \"gauge\",\n  \"valueType\": \"int64\"\n },\n \"project\": \"your_project_id\"\n}\n```\n\nAPI\u306e\u8a73\u7d30\u306f\u4e0b\u8a18\u53c2\u7167\nhttps://cloud.google.com/monitoring/v2beta2/metricDescriptors#resource\n\nname\u306b\u30e1\u30c8\u30ea\u30c3\u30af\u540d\u3001labels\u3067\u30e9\u30d9\u30eb\u3092\u6700\u592710\u500b\u307e\u3067\u6307\u5b9a\u51fa\u6765\u307e\u3059\u3002\nname\u3068label\u306ekey\u306b\u306f\u300ccustom.cloudmonitoring.googleapis.com/\u300d\u3068\u3044\u3046\u30d7\u30ec\u30d5\u30a3\u30c3\u30af\u30b9\u304c\u5fc5\u8981\u306a\u306e\u3067\u8981\u6ce8\u610f\u3067\u3059\u3002\ntypeDescriptor\u306evalueType\u306b\u306f\bint64\u307e\u305f\u306fdouble\u304c\u6307\u5b9a\u51fa\u6765\u307e\u3059\u3002\n\n\u4e0a\u8a18\u3067\u306f\u30bf\u30b9\u30af\u6ede\u7559\u3092\u76e3\u8996\u3059\u308b\u30e1\u30c8\u30ea\u30c3\u30af\u300ctasks_in_queue\u300d\u3092\u767b\u9332\u3057\u307e\u3057\u305f\u3002\n\n\u3064\u3044\u3067\u306b\u76f4\u8fd11\u5206\u9593\u306b\u634c\u3051\u305f\u30bf\u30b9\u30af\b\u6570\u306e\u30e1\u30c8\u30ea\u30c3\u30af\u300ctasks_executed_min\u300d\u3082\u767b\u9332\u3057\u3066\u304a\u304d\u307e\u3059\u2193\n\n```json\n{\n \"name\": \"custom.cloudmonitoring.googleapis.com/tasks_executed_min\",\n \"labels\": [\n  {\n   \"key\": \"custom.cloudmonitoring.googleapis.com/queue_name\",\n   \"description\": \"A queue name.\"\n  }\n ],\n \"description\": \"Tasks executed in a minute.\",\n \"typeDescriptor\": {\n  \"metricType\": \"gauge\",\n  \"valueType\": \"int64\"\n },\n \"project\": \"your_project_id\"\n}\n```\n\n# \u30e1\u30c8\u30ea\u30c3\u30af\u53ce\u96c6\n\n\u6b21\u306b\u30e1\u30c8\u30ea\u30c3\u30af\u306e\u53ce\u96c6\u3067\u3059\u304c\u3001Google App Engine\u306e\u30a2\u30d7\u30ea\u3092cron\u3067\u5b9a\u671f\u8d77\u52d5\u3057\u3066\u3001\u305d\u3053\u304b\u3089Google client library\u3067cloud monitoring API\u3092\u547c\u3073\u51fa\u3057\u3066\u30e1\u30c8\u30ea\u30c3\u30af\u3092\u66f8\u304d\u8fbc\u3080\u3053\u3068\u306b\u3057\u307e\u3059\u3002\n\n\u30b3\u30fc\u30c9\u4f8b\u306fGo\u3067\u3059\u3002Python\u3084Java\u306a\u3069\u4ed6\u8a00\u8a9e\u306e\u30e9\u30a4\u30d6\u30e9\u30ea\u3082\u7528\u610f\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n\n\u203b\u8a18\u4e8b\u306e\u672c\u7b4b\u304b\u3089\u306f\u5916\u308c\u308b\u306e\u3067\u629c\u7c8b\u3067\u3059\n\n```go\nfunc MonitorQueues(w http.ResponseWriter, r *http.Request) {\n\tctx := appengine.NewContext(r)\n\n\tappID := appengine.AppID(ctx)\n\n\tqueues := []string{\"assemble\", \"flip\", \"order\", \"render\"}\n\n\tqstats, err := taskqueue.QueueStats(ctx, queues)\n\tif err != nil {\n\t\thttp.Error(w, err.Error(), http.StatusInternalServerError)\n\t\treturn\n\t}\n\n\thc := &http.Client{\n\t\tTransport: &oauth2.Transport{\n\t\t\tSource: google.AppEngineTokenSource(ctx, cloudmonitoring.MonitoringScope),\n\t\t\tBase:   &urlfetch.Transport{Context: ctx},\n\t\t},\n\t}\n\n\tservice, err := cloudmonitoring.New(hc)\n\tif err != nil {\n\t\thttp.Error(w, err.Error(), http.StatusInternalServerError)\n\t\treturn\n\t}\n\n\tt := time.Now().UTC().Format(time.RFC3339)\n\n\tvar tpoints []*cloudmonitoring.TimeseriesPoint\n\n\tnewTpoint := func(metric, queue string, value int64) *cloudmonitoring.TimeseriesPoint {\n\t\treturn &cloudmonitoring.TimeseriesPoint{\n\t\t\tPoint: &cloudmonitoring.Point{\n\t\t\t\tStart:      t,\n\t\t\t\tEnd:        t,\n\t\t\t\tInt64Value: &value,\n\t\t\t},\n\t\t\tTimeseriesDesc: &cloudmonitoring.TimeseriesDescriptor{\n\t\t\t\tProject: appID,\n\t\t\t\tMetric:  \"custom.cloudmonitoring.googleapis.com/\" + metric,\n\t\t\t\tLabels: map[string]string{\n\t\t\t\t\t\"custom.cloudmonitoring.googleapis.com/queue_name\": queue,\n\t\t\t\t},\n\t\t\t},\n\t\t}\n\t}\n\n\tfor i, queue := range queues {\n\t\ttpoints = append(tpoints, newTpoint(\"tasks_in_queue\", queue, int64(qstats[i].Tasks)))\n\t\ttpoints = append(tpoints, newTpoint(\"tasks_executed_min\", queue, int64(qstats[i].Executed1Minute)))\n\t}\n\n\treq := cloudmonitoring.WriteTimeseriesRequest{Timeseries: tpoints}\n\n\t_, err = service.Timeseries.Write(appID, &req).Do()\n\tif err != nil {\n\t\thttp.Error(w, err.Error(), http.StatusInternalServerError)\n\t\treturn\n\t}\n\n\treturn\n}\n```\n\nqueue\u304c4\u7a2e\u985e\u3042\u308b\u306e\u3067\u3059\u304c\u3001\u305d\u308c\u305e\u308c\u306e\u7d71\u8a08\u60c5\u5831\u304b\u3089\u683c\u7d0d\u3055\u308c\u3066\u3044\u308b\u30bf\u30b9\u30af\u6570\u3068\u76f4\u8fd11\u5206\u9593\u306e\u5b9f\u884c\u6570\u3092\u53d6\u5f97\u3057\u3001\u30e1\u30c8\u30ea\u30c3\u30af\u3068\u3057\u3066\u66f8\u304d\u8fbc\u3093\u3067\u3044\u307e\u3059\u3002\n\n\u30e9\u30d9\u30ebqueue_name\u306b\u306f\u305d\u308c\u305e\u308c\u306equeue\u540d\u3092\u6307\u5b9a\u3057\u3066\u3044\u307e\u3059\u3002\n\nTimeseriesDescriptor\u306eProject\u30d5\u30a3\u30fc\u30eb\u30c9\u3068\u3001Timeseries.Write\u30e1\u30bd\u30c3\u30c9\u306e\u7b2c\u4e00\u5f15\u6570\u306b\u306fGCP\u306e\u30d7\u30ed\u30b8\u30a7\u30af\u30c8ID\u3092\u6e21\u3059\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002App Engine\u306e\u5834\u5408\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3ID==\u30d7\u30ed\u30b8\u30a7\u30af\u30c8ID\u306b\u306a\u308b\u306e\u3067\u305d\u308c\u3092\u6e21\u3057\u3066\u3044\u307e\u3059\u3002\n\n\n# \u76e3\u8996\n\n\u66f8\u304d\u8fbc\u3093\u3060\u30ab\u30b9\u30bf\u30e0\u30e1\u30c8\u30ea\u30af\u30b9\u3092Cloud Monitoring\u3067\u30c1\u30e3\u30fc\u30c8\u306b\u8868\u793a\u3057\u307e\u3057\u3087\u3046\u3002\n\n\u30c7\u30d5\u30a9\u30eb\u30c8\u306e\u30c0\u30c3\u30b7\u30e5\u30dc\u30fc\u30c9\u306e\u753b\u9762\u53f3\u4e0b\u306e\u65b9\u306b\n\n![\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2015-12-25 8.55.00.png](https://qiita-image-store.s3.amazonaws.com/0/31437/08b146e0-d145-fc82-5700-6def2f8ed916.png)\n\n\u3053\u3093\u306a\u30dc\u30bf\u30f3\u304c\u3042\u308a\u307e\u3059\u3002\u3053\u308c\u3092\u30af\u30ea\u30c3\u30af\u3059\u308b\u3068\u30c1\u30e3\u30fc\u30c8\u304c\u8ffd\u52a0\u3055\u308c\u307e\u3059\u3002\n\u30ab\u30b9\u30bf\u30e0\u30c0\u30c3\u30b7\u30e5\u30dc\u30fc\u30c9\u3092\u4f5c\u6210\u3057\u3066\u305d\u3053\u306b\u8ffd\u52a0\u3059\u308b\u3053\u3068\u3082\u51fa\u6765\u307e\u3059\u3002\n\n<img width=\"321\" alt=\"\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2015-12-25 9.02.26.png\" src=\"https://qiita-image-store.s3.amazonaws.com/0/31437/5b0725d4-8243-1a4d-564d-0061bbc4b24e.png\">\n\nResource Type\u306b\u300cCustom Metrics V2\u300d\u3001Metric\u306b\u4f5c\u6210\u3057\u305f\u30e1\u30c8\u30ea\u30c3\u30af\u540d\u3001Labels\u306b\u8868\u793a\u3057\u305f\u3044\u30e9\u30d9\u30eb\u3092\u6307\u5b9a\u3057\u307e\u3059\uff08\u3053\u3053\u3067\u306f\u5168queue\u306e\u60c5\u5831\u3092\u4e00\u3064\u306e\u30c1\u30e3\u30fc\u30c8\u306b\u8868\u793a\u3057\u305f\u3044\u306e\u3067Any\u3092\u6307\u5b9a\uff09\u3002\n\n\u300cSave\u300d\u3092\u30af\u30ea\u30c3\u30af\u3059\u308b\u3068\u30c1\u30e3\u30fc\u30c8\u304c\u8ffd\u52a0\u3055\u308c\u307e\u3059\u3002\n\n\u540c\u69d8\u306btasks_executed_min\u30e1\u30c8\u30ea\u30c3\u30af\u306e\u30c1\u30e3\u30fc\u30c8\u3082\u8ffd\u52a0\u3057\u307e\u3059\u3002\n\n![\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2015-12-25 9.21.01.png](https://qiita-image-store.s3.amazonaws.com/0/31437/7be50f76-fd6a-ea90-da24-d462cc7ab710.png)\n\n**\u51fa\u305f\uff01  \uff3c(^o^)\uff0f**\n\n\u4fbf\u5229\u3067\u3059\u306d\uff01(^^)\n\n# \u30a2\u30e9\u30fc\u30c8\n\n\u30ab\u30b9\u30bf\u30e0\u30e1\u30c8\u30ea\u30af\u30b9\u3092\u5143\u306b\u30a2\u30e9\u30fc\u30c8\u3092\u98db\u3070\u3059\u3053\u3068\u3082\u51fa\u6765\u307e\u3059(\u30ad\u30e5\u30fc\u306e\u6ede\u7559\u304c1000\u3092\u8d85\u3048\u305f\u3089\u30a2\u30e9\u30fc\u30c8\u3001etc)\u3002\u624b\u9806\u306f\u901a\u5e38\u306e\u30e1\u30c8\u30ea\u30af\u30b9\u306b\u5bfe\u3059\u308b\u8a2d\u5b9a\u3068\u540c\u69d8\u3067\u3059\u3002\n\n\u3053\u306e\u8fba\u3082\b\u4e0b\u8a18\u8a18\u4e8b\u3067\u65e2\u306b\u66f8\u304b\u308c\u3066\u307e\u3057\u305f\u306e\u3067\u5272\u611b\u3057\u307e\u3059m(_ _)m\nhttp://qiita.com/FumihikoSHIROYAMA/items/6846630b44fbc3f22b8e\n\nslack\u3078\u306e\u30a2\u30e9\u30fc\u30c8\u3082\u753b\u9762\u306b\u5f93\u3063\u3066\u30dd\u30c1\u30dd\u30c1\u3084\u3063\u3066\u3044\u304f\u3060\u3051\u3067\u9a5a\u304f\u307b\u3069\u7c21\u5358\u306b\u8a2d\u5b9a\u51fa\u6765\u307e\u3057\u305f\uff3c(^o^)\uff0f\n\n# \u6094\u6068\n\n\u4eca\u56de\u5b9f\u306f\u3001\n\u300cGoogle Cloud Monitoring\u0010\u3092\u4f7f\u3063\u3066Task Queue\u306e\u6ede\u7559\u3092\u76e3\u8996\u3057\u3066\u3001\u3055\u3089\u306b\u0010\u305d\u308c\u3092\u6307\u6a19\u306b\u3057\u3066\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u81ea\u52d5\u30b9\u30b1\u30fc\u30eb\u3055\u305b\u305f\u3044\u30ba\u30e9\u0e51\u25c9\ufecc\u25c9\u0e51\u300d\n\u3068\u3044\u3046\u30c6\u30fc\u30de\u3067\u8a18\u4e8b\u3092\u66f8\u304f\u4e88\u5b9a\u3060\u3063\u305f\u306e\u3067\u3059\u304c\u3001\u4ed5\u69d8\u3092\u5c11\u3057\u52d8\u9055\u3044\u3057\u3066\u3044\u3066\u5b9f\u73fe\u51fa\u6765\u307e\u305b\u3093\u3067\u3057\u305forz\n\nhttps://cloud.google.com/compute/docs/autoscaler/scaling-cloud-monitoring-metrics#choose_a_valid_custom_metric\n\n\u30aa\u30fc\u30c8\u30b9\u30b1\u30fc\u30eb\u7528\u30e1\u30c8\u30ea\u30c3\u30af\u306fVM\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u5358\u4f4d\u3067\u51fa\u529b\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u306e\u3067\u3059\u306d\u3002\n\n\u305d\u306e\u8fba\u308a\u306f\u307e\u305f\u6b21\u56de\u306e\u8b1b\u91c8\u3067\u30fb\u30fb\n\n\u826f\u3044\u304a\u5e74\u3092\u301c\uff3c(^o^)\uff0f\n", "tags": ["GoogleCloudPlatform", "GAE", "Go", "golang"]}