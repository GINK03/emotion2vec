{"context": " More than 1 year has passed since last update.Terraform\u3067Amazon Linux\u306eNAT\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u7528AMI\u3092\u53d6\u5f97\u3059\u308b\u305f\u3081\u306e\u30e2\u30b8\u30e5\u30fc\u30eb\u3092\u4f5c\u6210\u3057\u3066\u307f\u307e\u3057\u305f\u3002\nhttps://github.com/atsaki/tf_aws_nat_ami\n\n\u4f7f\u3044\u65b9\n\u30ea\u30fc\u30b8\u30e7\u30f3\u3084\u30d0\u30fc\u30b8\u30e7\u30f3\u7b49\u306e\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u6307\u5b9a\u3057\u3066NAT\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u7528AMI\u306eID\u3092\u53d6\u5f97\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\nmodule \"nat_instance_ami\" {\n  source = \"github.com/atsaki/tf_aws_nat_ami\"\n  region = \"eu-central-1\n  version = \"2015.03.0\"\n  virttype = \"pv\"\n  volumetype = \"ebs\"\n}\n\nregion\u306e\u307f\u5fc5\u9808\u3067\u3001\u4ed6\u306f\u7701\u7565\u53ef\u80fd\u3067\u3059\u3002\n\nregion : \uff08\u4f8b\uff1aeu-central-1\uff09\nversion : \uff08\u4f8b\uff1a2015.03.0\u3001\u30c7\u30d5\u30a9\u30eb\u30c8\uff1a2015.03.0\uff09\nvirttype : hvm or pv \uff08\u30c7\u30d5\u30a9\u30eb\u30c8\uff1ahvm\uff09\nvolumetype : gp2 or ebs (\u30c7\u30d5\u30a9\u30eb\u30c8\uff1agp2\uff09\n\n\u5b9f\u969b\u306etf\u30d5\u30a1\u30a4\u30eb\u3001tfvars\u30d5\u30a1\u30a4\u30eb\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\uff08NAT\u3092\u884c\u3046\u305f\u3081\u306b\u306froute table\u306e\u8a2d\u5b9a\u306a\u3069\u304c\u5fc5\u8981\u3067\u3059\u304c\u4eca\u56de\u306f\u5272\u611b\u3057\u307e\u3059\u3002\uff09\n\nmain.tf\nvariable \"aws_access_key\" {}\nvariable \"aws_secret_key\" {}\nvariable \"region\" {}\n\nprovider \"aws\" {\n  access_key = \"${var.aws_access_key}\"\n  secret_key = \"${var.aws_secret_key}\"\n  region = \"${var.region}\"\n}\n\nmodule \"nat_instance_ami\" {\n  source = \"github.com/atsaki/tf_aws_nat_ami\"\n  region = \"${var.region}\"\n  virttype = \"pv\"\n  volumetype = \"ebs\"\n}\n\nresource \"aws_instance\" \"nat_instance\" {\n  ami = \"${module.nat_instance_ami.ami_id}\"\n  instance_type = \"t1.micro\"\n  tags {\n    Name = \"nat_instance\"\n  }\n}\n\n\n\nterraform.tfvars\naws_access_key = \"YOUR_ACCESS_KEY\"\naws_secret_key = \"YOUR_SECRET_KEY\"\nregion = \"YOUR_REGION\"\n\n\ntf\u30d5\u30a1\u30a4\u30eb\u304c\u3067\u304d\u305f\u3089terraform get \u30b3\u30de\u30f3\u30c9\u3067\u30e2\u30b8\u30e5\u30fc\u30eb\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u307e\u3059\u3002\n$ terraform get\n\n\u3053\u306e\u5f8c\u306f\u3001\u901a\u5e38\u901a\u308aterraform plan \u3084 terraform apply \u3092\u5b9f\u884c\u53ef\u80fd\u3067\u3059\u3002\n\n\u4ed5\u7d44\u307f\n\u3053\u306e\u30e2\u30b8\u30e5\u30fc\u30eb\u306fterraform-community-modules\u306etf_aws_fedora_ami\u3001tf_aws_ubuntu_ami\u3092\u53c2\u8003\u306b\u4f5c\u6210\u3057\u307e\u3057\u305f\u3002\n\u4f55\u308c\u3082\u4ed5\u7d44\u307f\u3068\u3057\u3066\u306f\u540c\u3058\u3067\u524d\u3082\u3063\u3066\u30b9\u30af\u30ea\u30d7\u30c8\u3067AMI\u306e\u30ea\u30b9\u30c8\u3092\u53d6\u5f97\u3057Terraform\u306e\u5909\u6570\u3068\u3057\u3066\u4fdd\u5b58\u3057\u3066\u304a\u304d\u3001\u30e2\u30b8\u30e5\u30fc\u30eb\u306e\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u4f7f\u3063\u3066lookup\u3057\u3066\u3044\u307e\u3059\u3002\n\u4eca\u56de\u4f5c\u6210\u3057\u305f\u30e2\u30b8\u30e5\u30fc\u30eb\u3067\u306fAWS SDK for Ruby\u3092\u4f7f\u3063\u3066\u5404\u30ea\u30fc\u30b8\u30e7\u30f3\u306eAMI\u306e\u30ea\u30b9\u30c8\u3092\u53d6\u5f97\u3057\u3001\u540d\u524d\u304camzn-ami-vpc-nat \u304b\u3089\u59cb\u307e\u308bAMI\u306e\u60c5\u5831\u3092variables.tf.json \u306b\u4fdd\u5b58\u3057\u3066\u3044\u307e\u3059\u3002\n\ngetvariables.rb\n#!/usr/bin/env ruby\n\nrequire 'aws-sdk'\nrequire 'json'\n\nregions = Aws::EC2::Client.new(region: 'us-east-1')\n    .describe_regions.regions.map { |r| r.region_name }\n\ndata = {}\nregions.each do |region|\n    images = Aws::EC2::Client.new(region: region).describe_images(\n        owners: ['amazon'],\n        filters: [{ name: 'image-type', values: ['machine'] }]\n    ).images.select { |image|\n        !image.name.nil? && image.name.start_with?(\"amzn-ami-vpc-nat\")\n    }\n    data.merge!(Hash[images.map {|i| [\"#{region},#{i.name}\", i.image_id]}])\nend\n\nputs JSON.pretty_generate({ \n    variable: {\n        amis: {\n            default: data\n        }\n    }\n})\n\n\nvariables.tf.json \u306e\u4e2d\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u3063\u3066\u304a\u308a\u3001\u30ea\u30fc\u30b8\u30e7\u30f3\u540d\u3068AMI\u540d\u3092\u30ad\u30fc\u3001AMI id\u3092\u30d0\u30ea\u30e5\u30fc\u3068\u3057\u3066AMI\u306e\u30ea\u30b9\u30c8\u304c\u683c\u7d0d\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n\nvariables.tf.json\n{\n  \"variable\": {\n    \"amis\": {\n      \"default\": {\n        \"eu-central-1,amzn-ami-vpc-nat-hvm-2015.03.0.x86_64-ebs\": \"ami-1e073a03\",\n        \"eu-central-1,amzn-ami-vpc-nat-hvm-2014.03.2.x86_64-ebs\": \"ami-204c7a3d\",\n        \"eu-central-1,amzn-ami-vpc-nat-pv-2015.03.0.x86_64-ebs\": \"ami-3604392b\",\n        \"eu-central-1,amzn-ami-vpc-nat-hvm-2015.03.0.x86_64-gp2\": \"ami-46073a5b\",\n      \u301c\u301c\u301c\u7701\u7565\u301c\u301c\u301c\n      }\n    }\n  }\n}\n\n\nmain.tf \u3067\u306flookup \u95a2\u6570\u3092\u4f7f\u3063\u3066\u30e2\u30b8\u30e5\u30fc\u30eb\u306e\u30d1\u30e9\u30e1\u30fc\u30bf\u3067\u6307\u5b9a\u3055\u308c\u305f\u6761\u4ef6\u3068\u5408\u81f4\u3059\u308bAMI\u3092\u62bd\u51fa\u3057ID\u3092\u51fa\u529b\u3057\u3066\u3044\u307e\u3059\u3002\n\uff08lookup \u3084format \u306b\u3064\u3044\u3066\u306fTerraform\u306e\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u3092\u53c2\u7167\uff09\n\nmain.tf\nvariable \"region\" {}\nvariable \"version\" {\n  default = \"2015.03.0\"\n}\nvariable \"virttype\" {\n  default = \"hvm\"\n}\nvariable \"volumetype\" {\n  default = \"gp2\"\n}\n\noutput \"ami_id\" {\n  value = \"${lookup(var.amis, format(\\\"%s,amzn-ami-vpc-nat-%s-%s.x86_64-%s\\\", var.region, var.virttype, var.version, var.volumetype))}\"\n}\n\n\n\n\u53c2\u8003\n\nterraform-community-modules\nNAT \u30a4\u30f3\u30b9\u30bf\u30f3\u30b9 - Amazon Virtual Private Cloud\nModules - Terraform by HashiCorp\n\nTerraform\u3067Amazon Linux\u306eNAT\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u7528AMI\u3092\u53d6\u5f97\u3059\u308b\u305f\u3081\u306e\u30e2\u30b8\u30e5\u30fc\u30eb\u3092\u4f5c\u6210\u3057\u3066\u307f\u307e\u3057\u305f\u3002\n\nhttps://github.com/atsaki/tf_aws_nat_ami\n\n# \u4f7f\u3044\u65b9\n\n\u30ea\u30fc\u30b8\u30e7\u30f3\u3084\u30d0\u30fc\u30b8\u30e7\u30f3\u7b49\u306e\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u6307\u5b9a\u3057\u3066NAT\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u7528AMI\u306eID\u3092\u53d6\u5f97\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\n```\nmodule \"nat_instance_ami\" {\n  source = \"github.com/atsaki/tf_aws_nat_ami\"\n  region = \"eu-central-1\n  version = \"2015.03.0\"\n  virttype = \"pv\"\n  volumetype = \"ebs\"\n}\n```\nregion\u306e\u307f\u5fc5\u9808\u3067\u3001\u4ed6\u306f\u7701\u7565\u53ef\u80fd\u3067\u3059\u3002\n\n* region : \uff08\u4f8b\uff1aeu-central-1\uff09\n* version : \uff08\u4f8b\uff1a2015.03.0\u3001\u30c7\u30d5\u30a9\u30eb\u30c8\uff1a2015.03.0\uff09\n* virttype : hvm or pv \uff08\u30c7\u30d5\u30a9\u30eb\u30c8\uff1ahvm\uff09\n* volumetype : gp2 or ebs (\u30c7\u30d5\u30a9\u30eb\u30c8\uff1agp2\uff09\n\n\u5b9f\u969b\u306etf\u30d5\u30a1\u30a4\u30eb\u3001tfvars\u30d5\u30a1\u30a4\u30eb\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\uff08NAT\u3092\u884c\u3046\u305f\u3081\u306b\u306froute table\u306e\u8a2d\u5b9a\u306a\u3069\u304c\u5fc5\u8981\u3067\u3059\u304c\u4eca\u56de\u306f\u5272\u611b\u3057\u307e\u3059\u3002\uff09\n\n```main.tf\nvariable \"aws_access_key\" {}\nvariable \"aws_secret_key\" {}\nvariable \"region\" {}\n\nprovider \"aws\" {\n  access_key = \"${var.aws_access_key}\"\n  secret_key = \"${var.aws_secret_key}\"\n  region = \"${var.region}\"\n}\n\nmodule \"nat_instance_ami\" {\n  source = \"github.com/atsaki/tf_aws_nat_ami\"\n  region = \"${var.region}\"\n  virttype = \"pv\"\n  volumetype = \"ebs\"\n}\n\nresource \"aws_instance\" \"nat_instance\" {\n  ami = \"${module.nat_instance_ami.ami_id}\"\n  instance_type = \"t1.micro\"\n  tags {\n    Name = \"nat_instance\"\n  }\n}\n```\n\n```terraform.tfvars\naws_access_key = \"YOUR_ACCESS_KEY\"\naws_secret_key = \"YOUR_SECRET_KEY\"\nregion = \"YOUR_REGION\"\n```\n\ntf\u30d5\u30a1\u30a4\u30eb\u304c\u3067\u304d\u305f\u3089```terraform get``` \u30b3\u30de\u30f3\u30c9\u3067\u30e2\u30b8\u30e5\u30fc\u30eb\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u307e\u3059\u3002\n\n```bash\n$ terraform get\n```\n\n\u3053\u306e\u5f8c\u306f\u3001\u901a\u5e38\u901a\u308a```terraform plan``` \u3084 ```terraform apply``` \u3092\u5b9f\u884c\u53ef\u80fd\u3067\u3059\u3002\n\n# \u4ed5\u7d44\u307f\n\n\u3053\u306e\u30e2\u30b8\u30e5\u30fc\u30eb\u306f[terraform-community-modules](https://github.com/terraform-community-modules)\u306e[tf_aws_fedora_ami](https://github.com/terraform-community-modules/tf_aws_fedora_ami)\u3001[tf_aws_ubuntu_ami](https://github.com/terraform-community-modules/tf_aws_ubuntu_ami)\u3092\u53c2\u8003\u306b\u4f5c\u6210\u3057\u307e\u3057\u305f\u3002\n\n\u4f55\u308c\u3082\u4ed5\u7d44\u307f\u3068\u3057\u3066\u306f\u540c\u3058\u3067\u524d\u3082\u3063\u3066\u30b9\u30af\u30ea\u30d7\u30c8\u3067AMI\u306e\u30ea\u30b9\u30c8\u3092\u53d6\u5f97\u3057Terraform\u306e\u5909\u6570\u3068\u3057\u3066\u4fdd\u5b58\u3057\u3066\u304a\u304d\u3001\u30e2\u30b8\u30e5\u30fc\u30eb\u306e\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u4f7f\u3063\u3066lookup\u3057\u3066\u3044\u307e\u3059\u3002\n\n\u4eca\u56de\u4f5c\u6210\u3057\u305f\u30e2\u30b8\u30e5\u30fc\u30eb\u3067\u306f[AWS SDK for Ruby](http://aws.amazon.com/jp/sdk-for-ruby/)\u3092\u4f7f\u3063\u3066\u5404\u30ea\u30fc\u30b8\u30e7\u30f3\u306eAMI\u306e\u30ea\u30b9\u30c8\u3092\u53d6\u5f97\u3057\u3001\u540d\u524d\u304c```amzn-ami-vpc-nat``` \u304b\u3089\u59cb\u307e\u308bAMI\u306e\u60c5\u5831\u3092```variables.tf.json``` \u306b\u4fdd\u5b58\u3057\u3066\u3044\u307e\u3059\u3002\n\n```rb:getvariables.rb\n#!/usr/bin/env ruby\n\nrequire 'aws-sdk'\nrequire 'json'\n\nregions = Aws::EC2::Client.new(region: 'us-east-1')\n    .describe_regions.regions.map { |r| r.region_name }\n\ndata = {}\nregions.each do |region|\n    images = Aws::EC2::Client.new(region: region).describe_images(\n        owners: ['amazon'],\n        filters: [{ name: 'image-type', values: ['machine'] }]\n    ).images.select { |image|\n        !image.name.nil? && image.name.start_with?(\"amzn-ami-vpc-nat\")\n    }\n    data.merge!(Hash[images.map {|i| [\"#{region},#{i.name}\", i.image_id]}])\nend\n\nputs JSON.pretty_generate({ \n    variable: {\n        amis: {\n            default: data\n        }\n    }\n})\n```\n\n```variables.tf.json``` \u306e\u4e2d\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u3063\u3066\u304a\u308a\u3001\u30ea\u30fc\u30b8\u30e7\u30f3\u540d\u3068AMI\u540d\u3092\u30ad\u30fc\u3001AMI id\u3092\u30d0\u30ea\u30e5\u30fc\u3068\u3057\u3066AMI\u306e\u30ea\u30b9\u30c8\u304c\u683c\u7d0d\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n\n```json:variables.tf.json\n{\n  \"variable\": {\n    \"amis\": {\n      \"default\": {\n        \"eu-central-1,amzn-ami-vpc-nat-hvm-2015.03.0.x86_64-ebs\": \"ami-1e073a03\",\n        \"eu-central-1,amzn-ami-vpc-nat-hvm-2014.03.2.x86_64-ebs\": \"ami-204c7a3d\",\n        \"eu-central-1,amzn-ami-vpc-nat-pv-2015.03.0.x86_64-ebs\": \"ami-3604392b\",\n        \"eu-central-1,amzn-ami-vpc-nat-hvm-2015.03.0.x86_64-gp2\": \"ami-46073a5b\",\n      \u301c\u301c\u301c\u7701\u7565\u301c\u301c\u301c\n      }\n    }\n  }\n}\n```\n\n```main.tf``` \u3067\u306f```lookup``` \u95a2\u6570\u3092\u4f7f\u3063\u3066\u30e2\u30b8\u30e5\u30fc\u30eb\u306e\u30d1\u30e9\u30e1\u30fc\u30bf\u3067\u6307\u5b9a\u3055\u308c\u305f\u6761\u4ef6\u3068\u5408\u81f4\u3059\u308bAMI\u3092\u62bd\u51fa\u3057ID\u3092\u51fa\u529b\u3057\u3066\u3044\u307e\u3059\u3002\n\uff08```lookup``` \u3084```format``` \u306b\u3064\u3044\u3066\u306f[Terraform\u306e\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8](https://www.terraform.io/docs/configuration/interpolation.html)\u3092\u53c2\u7167\uff09\n\n\n```main.tf\nvariable \"region\" {}\nvariable \"version\" {\n  default = \"2015.03.0\"\n}\nvariable \"virttype\" {\n  default = \"hvm\"\n}\nvariable \"volumetype\" {\n  default = \"gp2\"\n}\n\noutput \"ami_id\" {\n  value = \"${lookup(var.amis, format(\\\"%s,amzn-ami-vpc-nat-%s-%s.x86_64-%s\\\", var.region, var.virttype, var.version, var.volumetype))}\"\n}\n```\n\n# \u53c2\u8003\n\n* [terraform-community-modules](https://github.com/terraform-community-modules)\n* [NAT \u30a4\u30f3\u30b9\u30bf\u30f3\u30b9 - Amazon Virtual Private Cloud](http://docs.aws.amazon.com/ja_jp/AmazonVPC/latest/UserGuide/VPC_NAT_Instance.html)\n* [Modules - Terraform by HashiCorp](https://www.terraform.io/docs/modules/index.html)\n", "tags": ["Terraform", "AWS", "aws-sdk"]}