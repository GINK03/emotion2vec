{"tags": ["STS", "aws-cli", "AWS"], "context": " More than 1 year has passed since last update.AWS CLI\u3092\u5229\u7528\u3057\u3066\u3001GetFederationToken\u3092\u5229\u7528\u3057\u307e\u3059\u3002\n\n\u524d\u63d0\u6761\u4ef6\n\nS3\u3001STS\u3078\u306e\u6a29\u9650\n\nS3\u3001STS\u306b\u5bfe\u3057\u3066\u30d5\u30eb\u6a29\u9650\u304c\u3042\u308b\u3053\u3068\u3002\n\n\nAWS CLI\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\n\u4ee5\u4e0b\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u3067\u52d5\u4f5c\u78ba\u8a8d\u6e08\n\nAWS CLI 1.7.39\n\n\n\u30b3\u30de\u30f3\u30c9\naws --version\n\n\n\n\u7d50\u679c(\u4f8b)\naws-cli/1.7.39 Python/2.7.6 Darwin/14.4.0\n\n\n\n0. \u6e96\u5099\n\n0.1. \u30ea\u30fc\u30b8\u30e7\u30f3\u306e\u6307\u5b9a\n\u30ea\u30fc\u30b8\u30e7\u30f3\u3092\u6307\u5b9a\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\n\u30b3\u30de\u30f3\u30c9\nexport AWS_DEFAULT_REGION=ap-northeast-1\n\n\n\n0.2. \u5909\u6570\u306e\u78ba\u8a8d\n\u30d7\u30ed\u30d5\u30a1\u30a4\u30eb\u304c\u60f3\u5b9a\u306e\u3082\u306e\u306b\u306a\u3063\u3066\u3044\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002(IAM/STS\u30d5\u30eb\u6a29\u9650\u304c\u5fc5\u8981\u3067\u3059\u3002)\n\n\u30b3\u30de\u30f3\u30c9\naws configure list\n\n\n\n\u7d50\u679c(\u4f8b)\n      Name                    Value             Type    Location\n      ----                    -----             ----    --------\n   profile                  iamFull           manual    --profile\naccess_key     ****************IK5Q shared-credentials-file    \nsecret_key     ****************nA0/ shared-credentials-file    \n    region           ap-northeast-1              env    AWS_DEFAULT_REGION\n\n\n\n0.3. \u4f5c\u696d\u7528\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306e\u78ba\u8a8d\n\u30ab\u30ec\u30f3\u30c8\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306b\u30d5\u30a1\u30a4\u30eb\u3092\u51fa\u529b\u3059\u308b\u70ba\u3001\u4f5c\u696d\u7528\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u3054\u7528\u610f\u304f\u3060\u3055\u3044\u3002\n\n\u30b3\u30de\u30f3\u30c9\npwd\nls -l\n\n\n\n1. GetFederationToken\u5229\u7528\n\n1.1. Federation\u30e6\u30fc\u30b6\u7528\u306e\u30dd\u30ea\u30b7\u30fc\u4f5c\u6210\nFederation\u30e6\u30fc\u30b6\u306bS3\u3078\u306e\u30a2\u30af\u30bb\u30b9\u6a29\u9650\u3092\u4ed8\u4e0e\u3057\u307e\u3059\u3002\n\n\u5909\u6570\u306e\u8a2d\u5b9a\nFEDERATION_USER=feduser\nFILE_FEDERATION_POLICY=${FEDERATION_USER}_POLICY.json \\\n  && echo ${FILE_FEDERATION_POLICY}\n\n\n\n\u30b3\u30de\u30f3\u30c9\ncat << EOF > ${FILE_FEDERATION_POLICY}\n{\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [\n        {\n            \"Effect\": \"Allow\",\n            \"Action\": \"s3:*\",\n            \"Resource\": \"*\"\n        }\n    ]\n}\nEOF\n\ncat ${FILE_FEDERATION_POLICY}\n\n\nJSON\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3057\u305f\u3089\u3001\u30d5\u30a9\u30fc\u30de\u30c3\u30c8\u304c\u58ca\u308c\u3066\u306a\u3044\u304b\u5fc5\u305a\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n\u30b3\u30de\u30f3\u30c9\njsonlint -q ${FILE_FEDERATION_POLICY}\n\n\n\n1.2. \u6709\u52b9\u671f\u9650\u306e\u6307\u5b9a\nToken\u306e\u6709\u52b9\u671f\u9650\u309215\u5206(60*15)\u306b\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\n\u5909\u6570\u306e\u8a2d\u5b9a\nEXPIRATION_SECONDS=`expr 60 \\* 15` \\\n  && echo ${EXPIRATION_SECONDS}\n\n\n\n1.3. FederationToken\u306e\u53d6\u5f97\n\u4fdd\u5b58\u7528\u30d5\u30a1\u30a4\u30eb\u540d\u3092\u6307\u5b9a\u3057\u307e\u3059\u3002\n\n\u5909\u6570\u306e\u8a2d\u5b9a\nFILE_FEDERATION_TOKEN_OUTPUT=federation_token_output.json\n\n\nFederationToken\u3092\u53d6\u5f97\u3057\u307e\u3059\u3002\n\n\u5909\u6570\u306e\u78ba\u8a8d\ncat << ETX\n\n        FEDERATION_USER: ${FEDERATION_USER}\n        FILE_FEDERATION_POLICY: ${FILE_FEDERATION_POLICY}\n        EXPIRATION_SECONDS: ${EXPIRATION_SECONDS}\n        FILE_FEDERATION_TOKEN_OUTPUT: ${FILE_FEDERATION_TOKEN_OUTPUT}\n\nETX\n\n\n\n\u30b3\u30de\u30f3\u30c9\naws sts get-federation-token \\\n  --name ${FEDERATION_USER} \\\n  --policy file://./${FILE_FEDERATION_POLICY} \\\n  --duration-seconds ${EXPIRATION_SECONDS} \\\n  > ${FILE_FEDERATION_TOKEN_OUTPUT} \\\n  && cat ${FILE_FEDERATION_TOKEN_OUTPUT}\n\n\n\n\u7d50\u679c(\u4f8b)\n{\n    \"Credentials\": {\n        \"SecretAccessKey\": \"c53hZ5iIaCfFUkgVlC58jS8xLPpm0Ys8gHj923Al\", \n        \"SessionToken\": \"AQoDYXdzEEQa8AHEsVcD/T/4sTZLGcZyEwxELTcHh1pvq5nzTIz+Xx1NgBtcIHmk57K5xyNp1EIFaQwMgElzygEgnEsp6A+3T2gO204VXG16wOlF84t/8maBv6xNBrShkyCySbUr9iOsB77zL5+9XFvQvCPuXh+nomqyHjKdu3QYWBKH4qzyAEcqkub9vAd3NGpvP2CfHGstSpAiCFDDlCoQ0hp0zQi82vdr06mT5ELvZjbopWIgC88P4OAC41JRavpnv86hLILcqfx38LNiFELfUX+17YwavXpHRow31Jd97rFJpP0vl1SDfY0t67DdQXsTlOpUxFqQh10gi9SorQU=\", \n        \"Expiration\": \"2015-07-18T13:27:23Z\", \n        \"AccessKeyId\": \"ASIAJYC24GWEJ4HK3BLA\"\n    }\n}\n\n\n\n1.4. \u30d7\u30ed\u30d5\u30a1\u30a4\u30eb\u306e\u4f5c\u6210\n\u53d6\u5f97\u3057\u305fFederationToken\u51fa\u529b\u3092\u5229\u7528\u3057\u3066\u30d7\u30ed\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n\u5909\u6570\u306e\u8a2d\u5b9a\nPROFILE_NAME=federation-token\nFILE_PROFILE_CONFIG=${PROFILE_NAME}.config \\\n  && echo ${FILE_PROFILE_CONFIG}\n\n\n\n\u30b3\u30de\u30f3\u30c9\necho \"[profile ${PROFILE_NAME}]\" > ${FILE_PROFILE_CONFIG}\ncat ${FILE_FEDERATION_TOKEN_OUTPUT} | awk '\n  $1 == \"\\\"AccessKeyId\\\":\" {\n    gsub(/\\\"/,\"\"); gsub(/,/,\"\"); print \"aws_access_key_id = \"$2\n  }\n  $1 == \"\\\"SecretAccessKey\\\":\" {\n    gsub(/\\\"/,\"\"); gsub(/,/,\"\"); print \"aws_secret_access_key = \"$2\n  }\n  $1 == \"\\\"SessionToken\\\":\" {\n    gsub(/\\\"/,\"\"); gsub(/,/,\"\"); print \"aws_session_token = \"$2\n  }\n' >> ${FILE_PROFILE_CONFIG} \\\n  && cat ${FILE_PROFILE_CONFIG}\n\n\n\n1.5. FederationToken\u306e\u5229\u7528\n\u4f5c\u6210\u3057\u305f\u30d7\u30ed\u30d5\u30a1\u30a4\u30eb\u3092\u74b0\u5883\u5909\u6570\u306b\u6307\u5b9a\u3057\u307e\u3059\u3002\n\n\u74b0\u5883\u5909\u6570\u6307\u5b9a\nexport AWS_DEFAULT_PROFILE=${PROFILE_NAME}\nexport AWS_CONFIG_FILE=${FILE_PROFILE_CONFIG}\n\n\nFederationToken\u304b\u3089\u4f5c\u6210\u3057\u305f\u30d7\u30ed\u30d5\u30a1\u30a4\u30eb\u306b\u5909\u66f4\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n\u30b3\u30de\u30f3\u30c9\naws configure list\n\n\n\n\u7d50\u679c(\u4f8b)\n      Name                    Value             Type    Location\n      ----                    -----             ----    --------\n   profile            session-token           manual    --profile\naccess_key     ****************3BLA      config-file    \nsecret_key     ****************23Al      config-file    \n    region           ap-northeast-1              env    AWS_DEFAULT_REGION\n\n\nFederation\u30e6\u30fc\u30b6\u7528\u306b\u8a2d\u5b9a\u3057\u305fS3\u3078\u306e\u30a2\u30af\u30bb\u30b9\u6a29\u9650\u3092\u6709\u3057\u3066\u3044\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n\u30b3\u30de\u30f3\u30c9(\u4f8b)\naws s3 ls\n\n\n\n2. FederationToken\u306e\u7121\u52b9\u5316\u78ba\u8a8d\n\u6709\u52b9\u671f\u9593\u3092\u904e\u304e\u305f\u5f8c\u3001\u3053\u306e\u30d7\u30ed\u30d5\u30a1\u30a4\u30eb\u304c\u5229\u7528\u3067\u304d\u306a\u304f\u306a\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\u660e\u793a\u7684\u306b\u524a\u9664\u3059\u308b\u624b\u9806\u306f\u5b58\u5728\u3057\u307e\u305b\u3093\u3002\n\n\u5b8c\u4e86\nAWS CLI\u3092\u5229\u7528\u3057\u3066\u3001GetFederationToken\u3092\u5229\u7528\u3057\u307e\u3059\u3002\n\n#\u524d\u63d0\u6761\u4ef6\n##S3\u3001STS\u3078\u306e\u6a29\u9650\n* S3\u3001STS\u306b\u5bfe\u3057\u3066\u30d5\u30eb\u6a29\u9650\u304c\u3042\u308b\u3053\u3068\u3002\n\n##AWS CLI\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\n\u4ee5\u4e0b\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u3067\u52d5\u4f5c\u78ba\u8a8d\u6e08\n\n* AWS CLI 1.7.39\n\n```bash:\u30b3\u30de\u30f3\u30c9\naws --version\n```\n\n```bash:\u7d50\u679c(\u4f8b)\naws-cli/1.7.39 Python/2.7.6 Darwin/14.4.0\n```\n\n#0. \u6e96\u5099\n##0.1. \u30ea\u30fc\u30b8\u30e7\u30f3\u306e\u6307\u5b9a\n\u30ea\u30fc\u30b8\u30e7\u30f3\u3092\u6307\u5b9a\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\n```bash:\u30b3\u30de\u30f3\u30c9\nexport AWS_DEFAULT_REGION=ap-northeast-1\n```\n\n##0.2. \u5909\u6570\u306e\u78ba\u8a8d\n\u30d7\u30ed\u30d5\u30a1\u30a4\u30eb\u304c\u60f3\u5b9a\u306e\u3082\u306e\u306b\u306a\u3063\u3066\u3044\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002(IAM/STS\u30d5\u30eb\u6a29\u9650\u304c\u5fc5\u8981\u3067\u3059\u3002)\n\n```bash:\u30b3\u30de\u30f3\u30c9\naws configure list\n```\n\n```bash:\u7d50\u679c(\u4f8b)\n      Name                    Value             Type    Location\n      ----                    -----             ----    --------\n   profile                  iamFull           manual    --profile\naccess_key     ****************IK5Q shared-credentials-file    \nsecret_key     ****************nA0/ shared-credentials-file    \n    region           ap-northeast-1              env    AWS_DEFAULT_REGION\n```\n\n##0.3. \u4f5c\u696d\u7528\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306e\u78ba\u8a8d\n\u30ab\u30ec\u30f3\u30c8\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306b\u30d5\u30a1\u30a4\u30eb\u3092\u51fa\u529b\u3059\u308b\u70ba\u3001\u4f5c\u696d\u7528\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u3054\u7528\u610f\u304f\u3060\u3055\u3044\u3002\n\n```bash:\u30b3\u30de\u30f3\u30c9\npwd\nls -l\n```\n\n#1. GetFederationToken\u5229\u7528\n##1.1. Federation\u30e6\u30fc\u30b6\u7528\u306e\u30dd\u30ea\u30b7\u30fc\u4f5c\u6210\nFederation\u30e6\u30fc\u30b6\u306bS3\u3078\u306e\u30a2\u30af\u30bb\u30b9\u6a29\u9650\u3092\u4ed8\u4e0e\u3057\u307e\u3059\u3002\n\n```bash:\u5909\u6570\u306e\u8a2d\u5b9a\nFEDERATION_USER=feduser\nFILE_FEDERATION_POLICY=${FEDERATION_USER}_POLICY.json \\\n  && echo ${FILE_FEDERATION_POLICY}\n```\n\n```bash:\u30b3\u30de\u30f3\u30c9\ncat << EOF > ${FILE_FEDERATION_POLICY}\n{\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [\n        {\n            \"Effect\": \"Allow\",\n            \"Action\": \"s3:*\",\n            \"Resource\": \"*\"\n        }\n    ]\n}\nEOF\n\ncat ${FILE_FEDERATION_POLICY}\n```\n\nJSON\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3057\u305f\u3089\u3001\u30d5\u30a9\u30fc\u30de\u30c3\u30c8\u304c\u58ca\u308c\u3066\u306a\u3044\u304b\u5fc5\u305a\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n```bash:\u30b3\u30de\u30f3\u30c9\njsonlint -q ${FILE_FEDERATION_POLICY}\n```\n\n##1.2. \u6709\u52b9\u671f\u9650\u306e\u6307\u5b9a\n\nToken\u306e\u6709\u52b9\u671f\u9650\u309215\u5206(60*15)\u306b\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\n```bash:\u5909\u6570\u306e\u8a2d\u5b9a\nEXPIRATION_SECONDS=`expr 60 \\* 15` \\\n  && echo ${EXPIRATION_SECONDS}\n```\n\n##1.3. FederationToken\u306e\u53d6\u5f97\n\n\u4fdd\u5b58\u7528\u30d5\u30a1\u30a4\u30eb\u540d\u3092\u6307\u5b9a\u3057\u307e\u3059\u3002\n\n```bash:\u5909\u6570\u306e\u8a2d\u5b9a\nFILE_FEDERATION_TOKEN_OUTPUT=federation_token_output.json\n```\n\nFederationToken\u3092\u53d6\u5f97\u3057\u307e\u3059\u3002\n\n```bash:\u5909\u6570\u306e\u78ba\u8a8d\ncat << ETX\n\n        FEDERATION_USER: ${FEDERATION_USER}\n        FILE_FEDERATION_POLICY: ${FILE_FEDERATION_POLICY}\n        EXPIRATION_SECONDS: ${EXPIRATION_SECONDS}\n        FILE_FEDERATION_TOKEN_OUTPUT: ${FILE_FEDERATION_TOKEN_OUTPUT}\n\nETX\n```\n\n```bash:\u30b3\u30de\u30f3\u30c9\naws sts get-federation-token \\\n  --name ${FEDERATION_USER} \\\n  --policy file://./${FILE_FEDERATION_POLICY} \\\n  --duration-seconds ${EXPIRATION_SECONDS} \\\n  > ${FILE_FEDERATION_TOKEN_OUTPUT} \\\n  && cat ${FILE_FEDERATION_TOKEN_OUTPUT}\n```\n\n```bash:\u7d50\u679c(\u4f8b)\n{\n    \"Credentials\": {\n        \"SecretAccessKey\": \"c53hZ5iIaCfFUkgVlC58jS8xLPpm0Ys8gHj923Al\", \n        \"SessionToken\": \"AQoDYXdzEEQa8AHEsVcD/T/4sTZLGcZyEwxELTcHh1pvq5nzTIz+Xx1NgBtcIHmk57K5xyNp1EIFaQwMgElzygEgnEsp6A+3T2gO204VXG16wOlF84t/8maBv6xNBrShkyCySbUr9iOsB77zL5+9XFvQvCPuXh+nomqyHjKdu3QYWBKH4qzyAEcqkub9vAd3NGpvP2CfHGstSpAiCFDDlCoQ0hp0zQi82vdr06mT5ELvZjbopWIgC88P4OAC41JRavpnv86hLILcqfx38LNiFELfUX+17YwavXpHRow31Jd97rFJpP0vl1SDfY0t67DdQXsTlOpUxFqQh10gi9SorQU=\", \n        \"Expiration\": \"2015-07-18T13:27:23Z\", \n        \"AccessKeyId\": \"ASIAJYC24GWEJ4HK3BLA\"\n    }\n}\n```\n\n##1.4. \u30d7\u30ed\u30d5\u30a1\u30a4\u30eb\u306e\u4f5c\u6210\n\u53d6\u5f97\u3057\u305fFederationToken\u51fa\u529b\u3092\u5229\u7528\u3057\u3066\u30d7\u30ed\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n```bash:\u5909\u6570\u306e\u8a2d\u5b9a\nPROFILE_NAME=federation-token\nFILE_PROFILE_CONFIG=${PROFILE_NAME}.config \\\n  && echo ${FILE_PROFILE_CONFIG}\n```\n\n```bash:\u30b3\u30de\u30f3\u30c9\necho \"[profile ${PROFILE_NAME}]\" > ${FILE_PROFILE_CONFIG}\ncat ${FILE_FEDERATION_TOKEN_OUTPUT} | awk '\n  $1 == \"\\\"AccessKeyId\\\":\" {\n    gsub(/\\\"/,\"\"); gsub(/,/,\"\"); print \"aws_access_key_id = \"$2\n  }\n  $1 == \"\\\"SecretAccessKey\\\":\" {\n    gsub(/\\\"/,\"\"); gsub(/,/,\"\"); print \"aws_secret_access_key = \"$2\n  }\n  $1 == \"\\\"SessionToken\\\":\" {\n    gsub(/\\\"/,\"\"); gsub(/,/,\"\"); print \"aws_session_token = \"$2\n  }\n' >> ${FILE_PROFILE_CONFIG} \\\n  && cat ${FILE_PROFILE_CONFIG}\n```\n\n##1.5. FederationToken\u306e\u5229\u7528\n\u4f5c\u6210\u3057\u305f\u30d7\u30ed\u30d5\u30a1\u30a4\u30eb\u3092\u74b0\u5883\u5909\u6570\u306b\u6307\u5b9a\u3057\u307e\u3059\u3002\n\n```bash:\u74b0\u5883\u5909\u6570\u6307\u5b9a\nexport AWS_DEFAULT_PROFILE=${PROFILE_NAME}\nexport AWS_CONFIG_FILE=${FILE_PROFILE_CONFIG}\n```\n\nFederationToken\u304b\u3089\u4f5c\u6210\u3057\u305f\u30d7\u30ed\u30d5\u30a1\u30a4\u30eb\u306b\u5909\u66f4\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n```bash:\u30b3\u30de\u30f3\u30c9\naws configure list\n```\n\n```bash:\u7d50\u679c(\u4f8b)\n      Name                    Value             Type    Location\n      ----                    -----             ----    --------\n   profile            session-token           manual    --profile\naccess_key     ****************3BLA      config-file    \nsecret_key     ****************23Al      config-file    \n    region           ap-northeast-1              env    AWS_DEFAULT_REGION\n```\n\nFederation\u30e6\u30fc\u30b6\u7528\u306b\u8a2d\u5b9a\u3057\u305fS3\u3078\u306e\u30a2\u30af\u30bb\u30b9\u6a29\u9650\u3092\u6709\u3057\u3066\u3044\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n```bash:\u30b3\u30de\u30f3\u30c9(\u4f8b)\naws s3 ls\n```\n\n#2. FederationToken\u306e\u7121\u52b9\u5316\u78ba\u8a8d\n\u6709\u52b9\u671f\u9593\u3092\u904e\u304e\u305f\u5f8c\u3001\u3053\u306e\u30d7\u30ed\u30d5\u30a1\u30a4\u30eb\u304c\u5229\u7528\u3067\u304d\u306a\u304f\u306a\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\u660e\u793a\u7684\u306b\u524a\u9664\u3059\u308b\u624b\u9806\u306f\u5b58\u5728\u3057\u307e\u305b\u3093\u3002\n\n#\u5b8c\u4e86\n\n\n\n\n\n\n\n"}