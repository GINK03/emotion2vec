{"context": "\n\n\u6982\u8981\nprometheus \u3092\u3064\u304b\u3063\u3066\u500b\u4eba\u30b5\u30fc\u30d0\u3092\u76e3\u8996\u3059\u308b\u306e\u3092\u96d1\u306b\u59cb\u3081\u308b\u3002\n\n\u4f7f\u7528\u3059\u308b\u3082\u306e\n\nprometheus\ndocker\n\nprometheus \u306f\u30c7\u30fc\u30bf\u3092 pull \u578b\u3067\u53ce\u96c6\u3059\u308b\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3067\u3001\u30e1\u30c8\u30ea\u30af\u30b9\u53d6\u5f97\u306e\u305f\u3081\u306b exporter \u3068\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3092\u305d\u308c\u305e\u308c\u5fc5\u8981\u306b\u5fdc\u3058\u3066\u5229\u7528\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u3002prometheus \u304a\u3088\u3073 expoter \u306f\u81ea\u524d\u3067\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u3068\u3044\u308d\u3044\u308d\u9762\u5012\u306a\u306e\u3067 docker \u306e\u30b3\u30f3\u30c6\u30ca\u3092\u4f7f\u3063\u3066\u69cb\u7bc9\u3059\u308b\u3002\u3053\u3053\u3067\u306f grafana \u306f\u6271\u3063\u3066\u3044\u306a\u3044\u3002\n\u4eca\u56de\u81ea\u5206\u304c\u69cb\u7bc9\u3057\u305f\u74b0\u5883\u306f\u4e0b\u8a18\u306e\u3068\u304a\u308a\u3002\n\nUbuntu 16.04.1 LTS\nDocker 1.13.0\nprometheus 1.5.0\n\n\n\u5185\u5bb9\n\u6700\u521d\u306b\u3053\u3053\u3067\u3084\u308b\u5168\u90e8\u306e\u4f5c\u696d\u3068\u3057\u3066\u307e\u3068\u3081\u3092\u8a18\u8f09\u3057\u3066\u3001\u3042\u3068\u3067\u305d\u308c\u305e\u308c\u8a73\u7d30\u3092\u66f8\u304f\u3002\n\n\u307e\u3068\u3081\n\n\u3053\u3053\u3067\u306f\u4e0b\u8a18\u30e1\u30c8\u30ea\u30af\u30b9\u304c\u53d6\u5f97\u3067\u304d\u308b\u3088\u3046\u306b\u3059\u308b\n\n\nCPU \u3084\u30e1\u30e2\u30ea\u306a\u3069\u306e\u57fa\u672c\u7684\u306a\u9805\u76ee\ndocker \u30b3\u30f3\u30c6\u30ca\u305d\u308c\u305e\u308c\u306e\u57fa\u672c\u7684\u306a\u9805\u76ee\n\n\ndocker \u306e\u30b3\u30f3\u30c6\u30ca\u3067\u69cb\u6210\u3059\u308b\n\n\ndocker \u306e User-defined network \u3092\u4f7f\u3046\n\n\n\u76f4\u63a5\u5916\u304b\u3089\u898b\u3089\u308c\u306a\u3044\u3088\u3046\u306b\u3059\u308b\u305f\u3081\n\u30b3\u30f3\u30c6\u30ca\u306e IP \u30a2\u30c9\u30ec\u30b9\u3092\u56fa\u5b9a\u3059\u308b\u305f\u3081\n\n\n\n\nprometheus \u304a\u3088\u3073 alertmanger \u306e UI \u7528\u306b\u30ea\u30d0\u30fc\u30b9\u30d7\u30ed\u30ad\u30b7\u3059\u308b\n\u30a2\u30e9\u30fc\u30c8\u98db\u3070\u305b\u308b\u3088\u3046\u306b\u3059\u308b\n\n\n\u8a2d\u5b9a\u4f8b\u306f gmail\n\n\n\n\u5f53\u305f\u308a\u524d\u3060\u3051\u3069\uff11\u53f0\u306a\u306e\u3067\u81ea\u8eab\u304c\u843d\u3061\u3066\u305f\u3089\u3069\u3046\u3057\u3088\u3046\u3082\u306a\u3044\u3002\n\n\u69cb\u6210\n\n\u30b3\u30f3\u30c6\u30ca\u60c5\u5831\nIP \u30a2\u30c9\u30ec\u30b9\u306f\u7bc4\u56f2\u5185\u306a\u3089\u306a\u3093\u3067\u3082\u3044\u3044\u306e\u3067\u4e0b\u8a18\u306e\u306f\u4f8b\u3002\n\n\n\n\u30b3\u30f3\u30c6\u30ca\u540d\nIP\u30a2\u30c9\u30ec\u30b9\n\u30dd\u30fc\u30c8\n\n\n\n\nprometheus-container\n172.18.0.2\n9090\n\n\nnode-exporter-container\n172.18.0.3\n9100\n\n\nalertmanager-container\n172.18.0.4\n9093\n\n\ncadviser-container\n172.18.0.6\n8080\n\n\n\n\n\u624b\u9806\nDocker \u306e userdefined network \u4f5c\u6210\n$ docker network create --subnet=172.18.0.0/24 prometheus_nw\n\n\u30a4\u30e1\u30fc\u30b8\u306e\u53d6\u5f97\n$ echo \"prom/prometheus prom/alertmanager google/cadvisor prom/node-exporter\" | xargs -n 1 docker pull\n\nprometheus \u304a\u3088\u3073 exporter \u3067\u305d\u308c\u305e\u308c\u5fc5\u8981\u306a\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092\u8a2d\u7f6e\u3002\u3053\u3053\u3067\u306f /home/prometheus \u4ee5\u4e0b\u3068\u3059\u308b\u3002\u5909\u66f4\u3059\u308b\u5834\u5408\u306f\u5f8c\u8ff0\u3059\u308b \u8d77\u52d5\u6642\u306e\u5f15\u304d\u6570\u3082\u5909\u66f4\u3059\u308b\u3002\n$ pwd\n/home/prometheus\n$ tree -L 2\n.\n\u251c\u2500\u2500 alertmanager\n\u2502   \u251c\u2500\u2500 alertmanager.yml\n\u2502   \u2514\u2500\u2500 data\n\u2514\u2500\u2500 prometheus\n    \u251c\u2500\u2500 alerts.rule\n    \u251c\u2500\u2500 data\n    \u2514\u2500\u2500 prometheus.yml\n                                                                                                                                           4 directories, 3 files                                                                                                                                                                                                                                                             \n\n\nprometheus.yml\nglobal:\n  scrape_interval:     15s # By default, scrape targets every 15 seconds.\n\nrule_files:\n  - alerts.rule\n\nscrape_configs:\n- job_name: node\n  static_configs:\n  - targets: ['172.18.0.3:9100']\n- job_name: docker\n  static_configs:\n  - targets: ['172.18.0.6:8080']\n\n\n\nalerts.rule\nALERT InstanceDown\n  IF up == 0\n  FOR 5m\n  LABELS { severity = \"page\" }\n  ANNOTATIONS {\n    summary = \"Instance {{ $labels.instance }} down\",\n    description = \"{{ $labels.instance }} of job {{ $labels.job }} has been down for more than 5 minutes.\"\n  }\n\n\n\u30a2\u30e9\u30fc\u30c8\u98db\u3070\u3059\u5148\u306e\u8a2d\u5b9a\u3002\n\u4e0b\u8a18\u306f Gmail \u3067\u9001\u308b\u5834\u5408\u306e\u4f8b\u3002\n\nSending email with the Alertmanager via Gmail \nhttps://www.robustperception.io/sending-email-with-the-alertmanager-via-gmail/\n\n\u30a2\u30d7\u30ea\u6bce\u306b\u30d1\u30b9\u30ef\u30fc\u30c9\u8a2d\u5b9a\u3059\u308b\u5834\u5408\u306e\u30d8\u30eb\u30d7\n\nSign in using App Passwords\nhttps://support.google.com/accounts/answer/185833?hl=en\n\n\u30d1\u30b9\u30ef\u30fc\u30c9\u306f\u3053\u3053\u3067\u3064\u304f\u308b\nhttps://security.google.com/settings/security/apppasswords\n\nalertmanager.yml\nroute:\n  receiver: hogehoge-mail\nreceivers:\n  - name: hogehoge-mail\n    email_configs:\n    - to: \"hogehoge@example.com\"\n      from: \"hogehoge@example.com\"\n      smarthost: smtp.gmail.com:587\n      auth_username: \"hogehoge@example.com\"\n      auth_identity: \"hogehoge@example.com\"\n      auth_password: \"brabrabrabra\"\n\n\n\u8d77\u52d5\n$ docker run --name=prometheus-container -d --net=prometheus_nw --ip=172.18.0.2 -v /home/prometheus/prometheus:/prometheus prom/prometheus -config.file=/prometheus/prometheus.yml   -alertmanager.url=http://172.18.0.4\n$ docker run --name=node-exporter-container -d --net=prometheus_nw --ip=172.18.0.3 -v \"/proc:/host/proc\"  -v /sys:/host/sys -v /:/rootfs prom/node-exporter -collector.procfs /host/proc -collector.sysfs /host/sys -collector.filesystem.ignored-mount-points \"^/(sys|proc|dev|host|etc)($|/)\"\n$ docker run --name=alertmanager-container -d --net=prometheus_nw --ip=172.18.0.4 -v /home/prometheus/alertmanager:/alertmanager prom/alertmanager -config.file=/alertmanager/alertmanager.yml -web.external-url=http://alertmanager.example.com\n$ docker run --name=cadvisor-container -d --net=prometheus_nw --ip=172.18.0.6 --volume=/:/rootfs:ro --volume=/var/run:/var/run:rw --volume=/sys:/sys:ro --volume=/var/lib/docker/:/var/lib/docker:ro --detach=true  google/cadvisor:latest\n\nnginx \u8a2d\u5b9a\u3057\u3066 UI \u3092\u898b\u3089\u308c\u308b\u3088\u3046\u306b\nupstream prometheus {\n  server 172.18.0.2:9090;\n}\nupstream alertmanager {\n  server 172.18.0.4:9093;\n}\n\nserver {\n  listen 80\n  server_name prometheus.example.com;\n\n  location / {\n    proxy_pass http://prometheus;\n\n    auth_basic \"Prometheus\";\n    auth_basic_user_file \".htpasswd\";\n  }\n}\nserver {\n  listen 80\n  server_name alertmanager.example.com;\n\n  location / {\n    proxy_pass http://alertmanager;\n\n    auth_basic \"AlertManager\";\n    auth_basic_user_file \".htpasswd\";\n  }\n}\n\n\nhtpasswd \u4f5c\u308b\n$ cd /etc/nginx/\n$ sudo htpasswd -c .htpasswd prometheus\n\nnginx \u3092 reload \u3059\u308b\u306a\u308a restart \u3059\u308b\u306a\u308a\u3057\u3066 prometheus.example.com \u304a\u3088\u3073 alertmanager.example.com \u304c\u8868\u793a\u3067\u304d\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3002\n\u4ee5\u4e0a\u3001\u3042\u3068\u306f\u81ea\u5206\u306e\u74b0\u5883\u7528\u306b\u8a2d\u5b9a\u3092\u5909\u66f4\u3057\u305f\u308a\u5fc5\u8981\u306a\u3082\u306e\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u305f\u308a\u3001 grafana \u3092\u4f7f\u3063\u3066\u30c0\u30c3\u30b7\u30e5\u30dc\u30fc\u30c9\u3092\u4f5c\u3063\u305f\u308a\u3059\u308b\u3002\n\n\u96d1\u8a18\n\nprometheus \u306b\u3064\u3044\u3066\n\u30b5\u30fc\u30d0\u76e3\u8996\u3059\u308b\u306b\u306f\u3044\u308d\u3044\u308d\u3042\u308b\u3088\u3046\u3060\u3051\u3069\u3001\u6700\u8fd1\u306f prometheus \u3068\u3044\u3046\u306e\u304c\u30db\u30c3\u30c8\u3089\u3057\u3044\u3002\nprometheus \u306f \u305d\u308c\u81ea\u8eab\u3068 exporter \u3067\u69cb\u6210\u3055\u308c\u308b\n\nexporter \u306e\u4e00\u89a7\nhttps://prometheus.io/docs/instrumenting/exporters/\n\nprometheus \u3092\u52d5\u304b\u3059\u306b\u306f apt \u306a\u3069\u306e\u30d1\u30c3\u30b1\u30fc\u30b8\u7ba1\u7406\u30b7\u30b9\u30c6\u30e0\u3092\u4f7f\u3063\u3066\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u3053\u3068\u3082\u51fa\u6765\u308b\u3051\u3069\u3001\u308f\u308a\u3068\u53e4\u304b\u3063\u305f\u308a\u3059\u308b\u306e\u304c\u9762\u5012\u306a\u306e\u3067\u516c\u5f0f\u3067\u63d0\u4f9b\u3055\u308c\u3066\u3044\u308b docker \u30a4\u30e1\u30fc\u30b8\u3092\u4f7f\u3046\u3053\u3068\u306b\u3059\u308b\u3002\n\u3061\u306a\u307f\u306b \u4e00\u65e6 apt \u3067\u5165\u308b prometheus \u306f\u6700\u65b0\u306e\u3082\u306e\u3068\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u306a\u3069\u304c\u7570\u306a\u308b\u53ef\u80fd\u6027\u304c\u3042\u308b\u306e\u3067 \u65e2\u5b58\u306e\u3082\u306e\u304b\u3089 docker \u30a4\u30e1\u30fc\u30b8\u306e prometheus \u306b\u79fb\u884c\u3059\u308b\u969b\u306f\u6ce8\u610f\u304c\u5fc5\u8981\u3002\n\nprometheus on docker\n\nprometheus \u516c\u5f0f\u306e docker \u30a4\u30e1\u30fc\u30b8\nhttps://hub.docker.com/u/prom/\n\n\u3068\u308a\u3042\u3048\u305a prometheus \u3060\u3051\u8d77\u52d5\u3059\u308b\u5834\u5408\n\nUsing Docker\nhttps://prometheus.io/docs/introduction/install/#using-docker\n\n\u3053\u3053\u306e\u3088\u3046\u306b\u30db\u30b9\u30c8\u5074\u306e\u30dd\u30fc\u30c8\u4f7f\u3063\u3066\u3082\u3044\u3044\u3051\u3069\u3001expoter \u7cfb\u304c\u5916\u90e8\u304b\u3089\u76f4\u63a5\u898b\u3089\u308c\u308b\u306e\u3063\u3066\u6016\u3044\u306a\u30fc\u3068\u3044\u3046\u611f\u3058\u3002 iptables \u306a\u3069\u3067\u8a2d\u5b9a\u3057\u3066\u3082\u826f\u3044\u3093\u3060\u308d\u3046\u3051\u3069\u3001\u4eca\u56de\u306f docker \u306e\u30e6\u30fc\u30b6\u5b9a\u7fa9\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u3092\u4f7f\u3063\u3066\u3044\u308b\u3002\nhttps://docs.docker.com/engine/userguide/networking/\n\u307e\u305f\u3001\u9069\u5f53\u306b\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u306b\u30a2\u30bf\u30c3\u30c1\u3059\u308b\u5834\u5408 IP \u30a2\u30c9\u30ec\u30b9\u304c\u8d77\u52d5\u3059\u308b\u305f\u3073\u306b\u5909\u308f\u3063\u3066\u3057\u307e\u3046\u3002prometheus \u306e\u8a2d\u5b9a\u306b\u76f4\u66f8\u304d\u3060\u3068\u601d\u3046\u306e\u3067\u500b\u3005\u3089\u3078\u3093\u306f\u56fa\u5b9a\u3067\u3084\u308b\u3002 \u3053\u3053\u3089\u3078\u3093\u306f\u30b3\u30f3\u30c6\u30ca\u8d77\u52d5\u6642\u306b\u8a2d\u5b9a\u3059\u308b\u3002\u8d77\u52d5\u3057\u305f\u307e\u307e\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u306b\u30a2\u30bf\u30c3\u30c1\u3059\u308b\u5834\u5408\u306f\u56fa\u5b9a\u306b\u3067\u304d\u306a\u304b\u3063\u305f\u6c17\u304c\u3059\u308b\u3002\nhttp://qiita.com/paihu/items/17aa47906dd2bf935a25\nhttp://qiita.com/takara@github/items/2349fff473474d7fcf47\n\u4e0b\u8a18\u306e\u3088\u3046\u306a\u30b3\u30de\u30f3\u30c9\u3067\u76e3\u8996\u7cfb\u306e\u30b3\u30f3\u30c6\u30ca\u3092\u3076\u3089\u4e0b\u3052\u308b\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u3092\u4f5c\u308b\u3053\u3068\u304c\u3067\u304d\u308b\u3002\u305f\u3076\u3093\u3053\u308c\u3060\u3051\u3002\u3053\u306e\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u3092\u6307\u5b9a\u3057\u3066\u30b3\u30f3\u30c6\u30ca\u3092\u4f5c\u3063\u305f\u308a\u8d77\u52d5\u9014\u4e2d\u3067\u30a2\u30bf\u30c3\u30c1\u3057\u305f\u308a\u3059\u308b\u3068\u3053\u306e\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u306b\u5165\u308b\u3002\u6307\u5b9a\u305b\u305a\u306b\u8d77\u52d5\u3057\u305f\u5834\u5408\u306f\u30c7\u30d5\u30a9\u30eb\u30c8\u306e\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u306e\u65b9\u306b\u5165\u308b\u3002\n$ docker network create --subnet=172.18.0.0/24 prometheus_nw\n\n\ndocker \u30b3\u30f3\u30c6\u30ca\u306b\u3064\u3044\u3066\n\u3056\u3063\u304f\u308a docker pull \u3059\u308b\u3068\u4e0b\u8a18\u306e\u3088\u3046\u306b\u306a\u308b\u3002\uff08\u6a2a\u7740\u3057\u3066 xargs \u3067\u66f8\u3044\u3066\u308b\uff09\n$ echo \"prom/prometheus prom/alertmanager google/cadvisor prom/blackbox_exporter prom/node-exporter\" | xargs -n 1 docker pull\n\n\u8aac\u660e\n\n\n\n\u540d\u524d\n\u96d1\u306a\u8aac\u660e\n\u30ea\u30dd\u30b8\u30c8\u30ea\n\n\n\n\nprometheus\n\u30e1\u30c8\u30ea\u30af\u30b9\u3092 exporter \u304b\u3089 pull \u3057\u3066\u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0\u306b\u4fdd\u5b58\u3059\u308b\nhttps://github.com/prometheus/prometheus\n\n\nnode-expoter\nCPU \u3068\u304b \u30e1\u30e2\u30ea \u3068\u304b\u898b\u3089\u308c\u308b\u304b\u3089\u3068\u308a\u3042\u3048\u305a\u3044\u308c\u3068\u3051\u3063\u3066 exporter\nhttps://github.com/prometheus/node_exporter\n\n\nalertmanager\n\u30a2\u30e9\u30fc\u30c8\u98db\u3070\u3059\u3068\u304d\u306b\u3069\u3053\u306b\u98db\u3070\u3059\u304b\u3068\u304b\u9759\u89b3\u3059\u308b\u304b\u3068\u304b\u8a2d\u5b9a\u3067\u304d\u308b\u3002\u30eb\u30fc\u30eb\u81ea\u4f53\u306f prometheus \u3067\u6307\u5b9a\u3059\u308b\u3051\u3069\u3002\nhttps://github.com/prometheus/alertmanager\n\n\ncadvisor\nDocker \u30b3\u30f3\u30c6\u30ca\u306e\u76e3\u8996\u306b\u4f7f\u3046\u3089\u3057\u3044\u3002 mysql-exporter \u3068\u540c\u3058\u30dd\u30fc\u30c8\u3092\u4f7f\u3046\u306e\u3067\u30db\u30b9\u30c8\u306b\u7d10\u4ed8\u3051\u308b\u5834\u5408\u306f\u6ce8\u610f\u3002\nhttps://github.com/google/cadvisor\n\n\n\n\u4eca\u56de\u306f\u4e0b\u8a18\u306e\u3088\u3046\u306b\u8a2d\u5b9a\u3059\u308b\u3002 container \u3092 suffix \u306b\u3057\u3066\u308b\u306e\u306f\u30b3\u30de\u30f3\u30c9\u306a\u3069\u3068\u6df7\u540c\u3057\u306a\u3044\u3088\u3046\u306b\u3059\u308b\u305f\u3081\u3002\n\n\u8d77\u52d5\u30b3\u30de\u30f3\u30c9\nprometheus\n$ docker run --name=prometheus-container --net=prometheus_nw --ip=172.18.0.2 -d -v /home/prometheus/prometheus:/prometheus prom/prometheus -config.file=/prometheus/prometheus.yml   -alertmanager.url=http://172.18.0.4\n\nnode_exporter\n$ docker run --name node-exporter-container -d --net=prometheus_nw --ip=172.18.0.3 -v \"/proc:/host/proc\"  -v \"/sys:/host/sys\" -v \"/:/rootfs\" prom/node-exporter -collector.procfs /host/proc -collector.sysfs /host/sys -collector.filesystem.ignored-mount-points \"^/(sys|proc|dev|host|etc)($|/)\"\n\n\u53c2\u8003 https://github.com/prometheus/node_exporter\n\u4eca\u56de\u306e\u5834\u5408\u3001 docker \u3092\u52d5\u304b\u3057\u3066\u308b\u306e\u3067 README \u306e\u6700\u5f8c\u306b\u3042\u308b\u3088\u3046\u306b\u8d77\u52d5\u3059\u308b\u3002\nalertmanager\nUI \u306e URL \u306f\u81ea\u5206\u306e\u74b0\u5883\u306b\u5408\u308f\u305b\u3066\u3002\n$ docker run --name alertmanager-container -d --net=prometheus_nw --ip=172.18.0.4 -v /home/prometheus/alertmanager:/alertmanager prom/alertmanager -config.file=/alertmanager/alertmanager.yml -web.external-url=http://alertmanager.example.com\n\ncadvisor\n$ docker run --name=cadvisor-container --net=prometheus_nw --ip=172.18.0.6 --volume=/:/rootfs:ro --volume=/var/run:/var/run:rw --volume=/sys:/sys:ro --volume=/var/lib/docker/:/var/lib/docker:ro --detach=true  google/cadvisor:latest\n\n\nconfiguration for prometheus\n\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u306a\u3069\u306f\u30db\u30b9\u30c8\u5074\u306b\u7f6e\u304f\u3053\u3068\u306b\u306a\u308b\u3002\u7f6e\u304f\u5834\u6240\u306f\u597d\u304d\u306a\u5834\u6240\u3067\u3088\u3044\u3002\u81ea\u5206\u306e\u5834\u5408\u306f\u3082\u3068\u3082\u3068 apt \u3067\u5165\u3063\u305f prometheus \u30e6\u30fc\u30b6\u3067\u52d5\u304b\u3057\u3066\u3044\u305f\u306e\u3067 \u3068\u308a\u3042\u3048\u305a /home \u4ee5\u4e0b\u306b prometheus \u8a2d\u5b9a\u3092\u5165\u308c\u305f\u3002\n$ pwd\n/home/prometheus\n$ tree -L 2\n.\n\u251c\u2500\u2500 alertmanager\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 alertmanager.yml\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 data\n\u2514\u2500\u2500 prometheus\n    \u251c\u2500\u2500 alerts.rule\n    \u251c\u2500\u2500 data\n    \u2514\u2500\u2500 prometheus.yml\n                                                                                                                                           4 directories, 3 files                                                                                                                                                                                                                                                             \n\nprometheus \u81ea\u4f53\u306e\u8a2d\u5b9a\n\u53c2\u8003URL\n\nhttps://prometheus.io/docs/operating/configuration/\nhttps://prometheus.io/docs/introduction/getting_started/\n\n\u4e0b\u8a18\u306e\u3082\u306e\u306f\u3068\u308a\u3042\u3048\u305a node_exporter \u3068 docker \u306e\u3082\u306e\u3092 pull \u3059\u308b\u3088\u3046\u306b\u3059\u308b\u8a2d\u5b9a\u3002exporter \u3092\u5897\u3084\u3057\u305f\u308a\u3057\u305f\u5834\u5408\u306f\u9069\u5b9c\u5909\u66f4\u3059\u308b\u30d5\u30a1\u30a4\u30eb\u3002\n\nprometheus.yml\nglobal:\n  scrape_interval:     15s # By default, scrape targets every 15 seconds.\n\nrule_files:\n  - alerts.rule\n\nscrape_configs:\n- job_name: node\n  static_configs:\n  - targets: ['172.18.0.3:9100']\n- job_name: docker\n  static_configs:\n  - targets: ['172.18.0.6:8080']\n\n\n\u30a2\u30e9\u30fc\u30c8\u30eb\u30fc\u30eb\u306f\u5225\u30d5\u30a1\u30a4\u30eb\u306b\u66f8\u304f\u3002\n\u53c2\u8003URL\n\nhttps://prometheus.io/docs/alerting/rules/\n\n\u3068\u308a\u3042\u3048\u305a node_expoter \u304c\u843d\u3061\u3066\u305f\u3089\u30a2\u30e9\u30fc\u30c8\u98db\u3070\u3059\u4f8b\u3002\u30a2\u30e9\u30fc\u30c8\u30eb\u30fc\u30eb\u306e\u77e5\u898b\u307b\u3057\u3044\u3067\u3059\u306d\u3002\n\nalerts.rule\nALERT InstanceDown\n  IF up == 0\n  FOR 5m\n  LABELS { severity = \"page\" }\n  ANNOTATIONS {\n    summary = \"Instance {{ $labels.instance }} down\",\n    description = \"{{ $labels.instance }} of job {{ $labels.job }} has been down for more than 5 minutes.\"\n  }\n\n\nalertmanager \u5074\u306e\u8a2d\u5b9a\n\u3053\u3053\u3067\u306f\u30a2\u30e9\u30fc\u30c8\u98db\u3070\u3059\u5148\u306e\u8a2d\u5b9a\u3092\u3059\u308b\u3002\n\u4e0b\u8a18\u306f Gmail \u3067\u9001\u308b\u5834\u5408\u306e\u4f8b\u3002\n\nSending email with the Alertmanager via Gmail \nhttps://www.robustperception.io/sending-email-with-the-alertmanager-via-gmail/\n\n\u30a2\u30d7\u30ea\u6bce\u306b\u30d1\u30b9\u30ef\u30fc\u30c9\u8a2d\u5b9a\u3059\u308b\u5834\u5408\u306e\u30d8\u30eb\u30d7\n\nSign in using App Passwords\nhttps://support.google.com/accounts/answer/185833?hl=en\n\n\u30d1\u30b9\u30ef\u30fc\u30c9\u306f\u3053\u3053\u3067\u3064\u304f\u308b\nhttps://security.google.com/settings/security/apppasswords\n\u305d\u306e\u4ed6\u3044\u308d\u3044\u308d\u5bfe\u5fdc\u3057\u3066\u3044\u308b\u306e\u3067\u5fc5\u8981\u306a\u901a\u77e5\u5148\u3092\u8a2d\u5b9a\u3059\u308b\u3002prometheus \u3067\u4ed8\u4e0e\u3057\u305f job \u3084\u30e9\u30d9\u30eb\u306b\u3088\u3063\u3066\u901a\u77e5\u5148\u3084\u901a\u77e5\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u5909\u3048\u305f\u308a\u3067\u304d\u308b\u306e\u3067\u3046\u307e\u3044\u3053\u3068\u3084\u308b\u3002\n\nalertmanager.yml\nroute:\n  receiver: hogehoge-mail\nreceivers:\n  - name: hogehoge-mail\n    email_configs:\n    - to: \"hogehoge@example.com\"\n      from: \"hogehoge@example.com\"\n      smarthost: smtp.gmail.com:587\n      auth_username: \"hogehoge@example.com\"\n      auth_identity: \"hogehoge@example.com\"\n      auth_password: \"brabrabrabra\"\n\n\n\n\u8a2d\u5b9a\u53cd\u6620\u306b\u3064\u3044\u3066\ndocker \u3067\u8d77\u52d5\u3057\u305f prometheus \u3084 exporter \u306e\u8a2d\u5b9a\u3092\u5909\u66f4\u3057\u305f\u5834\u5408\u3001 docker stop && docker start \u3067\u3088\u3044\u3002\n\u307e\u305f\u306f systemd \u304c\u4f7f\u3048\u308b\u5834\u5408\u306f\u4e8b\u9805\u306e\u3088\u3046\u306b\u8a2d\u5b9a\u3057\u3066 systemctl restart \u3067\u884c\u3063\u3066\u3082\u826f\u3055\u305d\u3046\u3002\n\n\u8d77\u52d5\u306e\u7ba1\u7406\u304a\u3088\u3073\u30a2\u30c3\u30d7\u30c7\u30fc\u30c8\nUbuntu 16.04.1 \u3067\u306f systemd \u4f7f\u3063\u3066\u308b\u306e\u3067\u3053\u308c\u3067\u8d77\u52d5\u7ba1\u7406\u3067\u304d\u305f\u3089\u697d\u305d\u3046\n\nStart containers automatically\nhttps://docs.docker.com/engine/admin/host_integration/\n\n\u4e0b\u8a18\u306e\u69d8\u306b\u8a2d\u5b9a\u3059\u308b\u3002run \u306e\u3082\u306e\u306f -d \u307e\u305f\u306f --detach=true \u3092\u524a\u9664\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u3002\n\nMake sure you don\u2019t use \u201c-d\u201d for \u201cdetached mode\u201d. The command run from \u201cExecStart\u201d needs to run in the foreground.\n\n\n/etc/systemd/system/prometheus-container.service\n[Unit]\nDescription=prometheus container\nRequires=docker.service\nAfter=docker.service\n                                                                                                                                                                  [Service]\nRestart=always\nExecStart=\nExecStart=/usr/bin/docker run --name=prometheus-container --net=prometheus_nw --ip=172.18.0.2 -v /home/prometheus/prometheus:/prometheus prom/prometheus -config.file=/prometheus/prometheus.yml -alertmanager.url=http://172.18.0.4\nExecStop=/usr/bin/docker stop -t 2 prometheus-container\nExecStopPost=/usr/bin/docker rm -f prometheus-container\n\n[Install]\nWantedBy=default.target\n\n\n\u3053\u306e\u3088\u3046\u306b\u3057\u3066\u304a\u3051\u3070\u3001 \u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u30a2\u30c3\u30d7\u30c7\u30fc\u30c8\u306f\u4e0b\u8a18\u306e\u3088\u3046\u306b\u3059\u308b\u3060\u3051\u3067\u3088\u3044\u3002\n$ docker pull prom/prometheus \n$ sudo systemctl restart prometheus-container.service\n\n\u4e0b\u8a18\u8a18\u4e8b\u306e\u3088\u3046\u306b ExecStartPre \u3067 pull \u3057\u3066\u3082\u826f\u3044\u304b\u3082\u3057\u308c\u306a\u3044\u304c\u3001 restart \u3059\u308b\u3060\u3051\u3067\u30a2\u30c3\u30d7\u30c7\u30fc\u30c8\u3055\u308c\u308b\u306e\u306f\u500b\u4eba\u7684\u306b\u597d\u307f\u3067\u306f\u306a\u3044\u306e\u3067\u3084\u3063\u3066\u306a\u3044\u3002\n\ndocker\u30b3\u30f3\u30c6\u30ca\u3092systemd\u3067\u7ba1\u7406\u3055\u305b\u308b\nhttp://qiita.com/74th/items/e8dc1ac1295140413dc8\n\n\nUserInterface\nUI \u3092\u898b\u3089\u308c\u308b\u3088\u3046\u306b\u3059\u308b\u305f\u3081\u306b \u9069\u5f53\u306b nginx \u306b\u8a2d\u5b9a\u66f8\u304f\u3002\u4e0b\u8a18\u306f\u3056\u3063\u304f\u308a\u3057\u305f\u4f8b\u3002cadviser \u306b\u3082 UI \u304c\u3042\u308b\u304c cadviser \u306e UI \u3082\u78ba\u8a8d\u3057\u305f\u3051\u308c\u3070\u540c\u69d8\u306b\u8ffd\u52a0\u3059\u308b\u3068\u826f\u3044\u3002\n\u7c21\u5358\u306b\u898b\u3089\u308c\u308b\u3068\u56f0\u308a\u305d\u3046\u306a\u306e\u3067\u96d1\u306b BASIC \u8a8d\u8a3c\u5165\u308c\u3066\u308b\u3002grafana \u3092\u4f7f\u3046\u5834\u5408\u306b\u30c7\u30fc\u30bf\u30bd\u30fc\u30b9\u3068\u3057\u3066 prometheus \u3092\u6307\u5b9a\u3057\u3066\u5229\u7528\u3059\u308b\u3053\u3068\u306b\u306a\u308b\u304c\u3001\u3053\u306e\u5834\u5408\u3067\u3082 grafana \u306e\u8a2d\u5b9a\u3067 BASIC \u8a8d\u8a3c\u66f8\u3051\u308b\u306e\u3067\u554f\u984c\u306a\u3057\u3002\nupstream prometheus {\n  server 172.18.0.2:9090;\n}\nupstream alertmanager {\n  server 172.18.0.4:9093;\n}\n\nserver {\n  listen 80\n  server_name prometheus.example.com;\n\n  location / {\n    proxy_pass http://prometheus;\n\n    auth_basic \"Prometheus\";\n    auth_basic_user_file \".htpasswd\";\n  }\n}\nserver {\n  listen 80\n  server_name alertmanager.example.com;\n\n  location / {\n    proxy_pass http://alertmanager;\n\n    auth_basic \"AlertManager\";\n    auth_basic_user_file \".htpasswd\";\n  }\n}\n\n\n\u3068\u308a\u3042\u3048\u305a .htpasswd \u4f5c\u308b\u4f8b\n$ cd /etc/nginx/\n$ sudo htpasswd -c .htpasswd prometheus\n\n# \u6982\u8981\n\nprometheus \u3092\u3064\u304b\u3063\u3066\u500b\u4eba\u30b5\u30fc\u30d0\u3092\u76e3\u8996\u3059\u308b\u306e\u3092\u96d1\u306b\u59cb\u3081\u308b\u3002\n\n\n# \u4f7f\u7528\u3059\u308b\u3082\u306e\n\n* [prometheus](https://prometheus.io/)\n* [docker](https://www.docker.com/)\n\nprometheus \u306f\u30c7\u30fc\u30bf\u3092 pull \u578b\u3067\u53ce\u96c6\u3059\u308b\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3067\u3001\u30e1\u30c8\u30ea\u30af\u30b9\u53d6\u5f97\u306e\u305f\u3081\u306b exporter \u3068\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3092\u305d\u308c\u305e\u308c\u5fc5\u8981\u306b\u5fdc\u3058\u3066\u5229\u7528\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u3002prometheus \u304a\u3088\u3073 expoter \u306f\u81ea\u524d\u3067\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u3068\u3044\u308d\u3044\u308d\u9762\u5012\u306a\u306e\u3067 docker \u306e\u30b3\u30f3\u30c6\u30ca\u3092\u4f7f\u3063\u3066\u69cb\u7bc9\u3059\u308b\u3002\u3053\u3053\u3067\u306f grafana \u306f\u6271\u3063\u3066\u3044\u306a\u3044\u3002\n\n\u4eca\u56de\u81ea\u5206\u304c\u69cb\u7bc9\u3057\u305f\u74b0\u5883\u306f\u4e0b\u8a18\u306e\u3068\u304a\u308a\u3002\n\n* Ubuntu 16.04.1 LTS\n* Docker 1.13.0\n* prometheus 1.5.0\n\n# \u5185\u5bb9\n\n\u6700\u521d\u306b\u3053\u3053\u3067\u3084\u308b\u5168\u90e8\u306e\u4f5c\u696d\u3068\u3057\u3066\u307e\u3068\u3081\u3092\u8a18\u8f09\u3057\u3066\u3001\u3042\u3068\u3067\u305d\u308c\u305e\u308c\u8a73\u7d30\u3092\u66f8\u304f\u3002\n\n## \u307e\u3068\u3081\n\n* \u3053\u3053\u3067\u306f\u4e0b\u8a18\u30e1\u30c8\u30ea\u30af\u30b9\u304c\u53d6\u5f97\u3067\u304d\u308b\u3088\u3046\u306b\u3059\u308b\n  * CPU \u3084\u30e1\u30e2\u30ea\u306a\u3069\u306e\u57fa\u672c\u7684\u306a\u9805\u76ee\n  * docker \u30b3\u30f3\u30c6\u30ca\u305d\u308c\u305e\u308c\u306e\u57fa\u672c\u7684\u306a\u9805\u76ee\n* docker \u306e\u30b3\u30f3\u30c6\u30ca\u3067\u69cb\u6210\u3059\u308b\n  * docker \u306e User-defined network \u3092\u4f7f\u3046\n     * \u76f4\u63a5\u5916\u304b\u3089\u898b\u3089\u308c\u306a\u3044\u3088\u3046\u306b\u3059\u308b\u305f\u3081\n     * \u30b3\u30f3\u30c6\u30ca\u306e IP \u30a2\u30c9\u30ec\u30b9\u3092\u56fa\u5b9a\u3059\u308b\u305f\u3081\n* prometheus \u304a\u3088\u3073 alertmanger \u306e UI \u7528\u306b\u30ea\u30d0\u30fc\u30b9\u30d7\u30ed\u30ad\u30b7\u3059\u308b\n* \u30a2\u30e9\u30fc\u30c8\u98db\u3070\u305b\u308b\u3088\u3046\u306b\u3059\u308b\n  * \u8a2d\u5b9a\u4f8b\u306f gmail\n\n\u5f53\u305f\u308a\u524d\u3060\u3051\u3069\uff11\u53f0\u306a\u306e\u3067\u81ea\u8eab\u304c\u843d\u3061\u3066\u305f\u3089\u3069\u3046\u3057\u3088\u3046\u3082\u306a\u3044\u3002\n\n### \u69cb\u6210\n\n![d60de4f270285bc85a846ab084fb3a2f.png](https://qiita-image-store.s3.amazonaws.com/0/6975/8e9044bf-87d3-b4f4-51ab-2e7486fda0a9.png)\n\n\n\u30b3\u30f3\u30c6\u30ca\u60c5\u5831\nIP \u30a2\u30c9\u30ec\u30b9\u306f\u7bc4\u56f2\u5185\u306a\u3089\u306a\u3093\u3067\u3082\u3044\u3044\u306e\u3067\u4e0b\u8a18\u306e\u306f\u4f8b\u3002\n\n| \u30b3\u30f3\u30c6\u30ca\u540d                   | IP\u30a2\u30c9\u30ec\u30b9  | \u30dd\u30fc\u30c8|\n|-----------------------------|------------|------|\n| prometheus-container        | 172.18.0.2 | 9090 |\n| node-exporter-container     | 172.18.0.3 | 9100 |\n| alertmanager-container      | 172.18.0.4 | 9093 |\n| cadviser-container          | 172.18.0.6 | 8080 |\n\n\n### \u624b\u9806\n\nDocker \u306e userdefined network \u4f5c\u6210\n\n```console\n$ docker network create --subnet=172.18.0.0/24 prometheus_nw\n```\n\n\u30a4\u30e1\u30fc\u30b8\u306e\u53d6\u5f97\n\n```\n$ echo \"prom/prometheus prom/alertmanager google/cadvisor prom/node-exporter\" | xargs -n 1 docker pull\n```\n\nprometheus \u304a\u3088\u3073 exporter \u3067\u305d\u308c\u305e\u308c\u5fc5\u8981\u306a\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092\u8a2d\u7f6e\u3002\u3053\u3053\u3067\u306f /home/prometheus \u4ee5\u4e0b\u3068\u3059\u308b\u3002\u5909\u66f4\u3059\u308b\u5834\u5408\u306f\u5f8c\u8ff0\u3059\u308b \u8d77\u52d5\u6642\u306e\u5f15\u304d\u6570\u3082\u5909\u66f4\u3059\u308b\u3002\n\n```\n$ pwd\n/home/prometheus\n$ tree -L 2\n.\n\u251c\u2500\u2500 alertmanager\n\u2502   \u251c\u2500\u2500 alertmanager.yml\n\u2502   \u2514\u2500\u2500 data\n\u2514\u2500\u2500 prometheus\n    \u251c\u2500\u2500 alerts.rule\n    \u251c\u2500\u2500 data\n    \u2514\u2500\u2500 prometheus.yml\n                                                                                                                                           4 directories, 3 files                                                                                                                                                                                                                                                             \n```\n\n\n```yaml:prometheus.yml\nglobal:\n  scrape_interval:     15s # By default, scrape targets every 15 seconds.\n\nrule_files:\n  - alerts.rule\n\nscrape_configs:\n- job_name: node\n  static_configs:\n  - targets: ['172.18.0.3:9100']\n- job_name: docker\n  static_configs:\n  - targets: ['172.18.0.6:8080']\n```\n\n```alerts.rule\nALERT InstanceDown\n  IF up == 0\n  FOR 5m\n  LABELS { severity = \"page\" }\n  ANNOTATIONS {\n    summary = \"Instance {{ $labels.instance }} down\",\n    description = \"{{ $labels.instance }} of job {{ $labels.job }} has been down for more than 5 minutes.\"\n  }\n```\n\n\u30a2\u30e9\u30fc\u30c8\u98db\u3070\u3059\u5148\u306e\u8a2d\u5b9a\u3002\n\u4e0b\u8a18\u306f Gmail \u3067\u9001\u308b\u5834\u5408\u306e\u4f8b\u3002\n\n> Sending email with the Alertmanager via Gmail \nhttps://www.robustperception.io/sending-email-with-the-alertmanager-via-gmail/\n\n\u30a2\u30d7\u30ea\u6bce\u306b\u30d1\u30b9\u30ef\u30fc\u30c9\u8a2d\u5b9a\u3059\u308b\u5834\u5408\u306e\u30d8\u30eb\u30d7\n\n> Sign in using App Passwords\nhttps://support.google.com/accounts/answer/185833?hl=en\n\n\u30d1\u30b9\u30ef\u30fc\u30c9\u306f\u3053\u3053\u3067\u3064\u304f\u308b\nhttps://security.google.com/settings/security/apppasswords\n\n```yaml:alertmanager.yml\nroute:\n  receiver: hogehoge-mail\nreceivers:\n  - name: hogehoge-mail\n    email_configs:\n    - to: \"hogehoge@example.com\"\n      from: \"hogehoge@example.com\"\n      smarthost: smtp.gmail.com:587\n      auth_username: \"hogehoge@example.com\"\n      auth_identity: \"hogehoge@example.com\"\n      auth_password: \"brabrabrabra\"\n```\n\n\u8d77\u52d5\n\n```console\n$ docker run --name=prometheus-container -d --net=prometheus_nw --ip=172.18.0.2 -v /home/prometheus/prometheus:/prometheus prom/prometheus -config.file=/prometheus/prometheus.yml   -alertmanager.url=http://172.18.0.4\n$ docker run --name=node-exporter-container -d --net=prometheus_nw --ip=172.18.0.3 -v \"/proc:/host/proc\"  -v /sys:/host/sys -v /:/rootfs prom/node-exporter -collector.procfs /host/proc -collector.sysfs /host/sys -collector.filesystem.ignored-mount-points \"^/(sys|proc|dev|host|etc)($|/)\"\n$ docker run --name=alertmanager-container -d --net=prometheus_nw --ip=172.18.0.4 -v /home/prometheus/alertmanager:/alertmanager prom/alertmanager -config.file=/alertmanager/alertmanager.yml -web.external-url=http://alertmanager.example.com\n$ docker run --name=cadvisor-container -d --net=prometheus_nw --ip=172.18.0.6 --volume=/:/rootfs:ro --volume=/var/run:/var/run:rw --volume=/sys:/sys:ro --volume=/var/lib/docker/:/var/lib/docker:ro --detach=true  google/cadvisor:latest\n```\n\nnginx \u8a2d\u5b9a\u3057\u3066 UI \u3092\u898b\u3089\u308c\u308b\u3088\u3046\u306b\n\n```nginx:\nupstream prometheus {\n  server 172.18.0.2:9090;\n}\nupstream alertmanager {\n  server 172.18.0.4:9093;\n}\n\nserver {\n  listen 80\n  server_name prometheus.example.com;\n  \n  location / {\n    proxy_pass http://prometheus;\n\n    auth_basic \"Prometheus\";\n    auth_basic_user_file \".htpasswd\";\n  }\n}\nserver {\n  listen 80\n  server_name alertmanager.example.com;\n  \n  location / {\n    proxy_pass http://alertmanager;\n\n    auth_basic \"AlertManager\";\n    auth_basic_user_file \".htpasswd\";\n  }\n}\n\n```\n\nhtpasswd \u4f5c\u308b\n\n```\n$ cd /etc/nginx/\n$ sudo htpasswd -c .htpasswd prometheus\n```\nnginx \u3092 reload \u3059\u308b\u306a\u308a restart \u3059\u308b\u306a\u308a\u3057\u3066 prometheus.example.com \u304a\u3088\u3073 alertmanager.example.com \u304c\u8868\u793a\u3067\u304d\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3002\n\n\u4ee5\u4e0a\u3001\u3042\u3068\u306f\u81ea\u5206\u306e\u74b0\u5883\u7528\u306b\u8a2d\u5b9a\u3092\u5909\u66f4\u3057\u305f\u308a\u5fc5\u8981\u306a\u3082\u306e\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u305f\u308a\u3001 grafana \u3092\u4f7f\u3063\u3066\u30c0\u30c3\u30b7\u30e5\u30dc\u30fc\u30c9\u3092\u4f5c\u3063\u305f\u308a\u3059\u308b\u3002\n\n## \u96d1\u8a18\n\n### prometheus \u306b\u3064\u3044\u3066\n\n\u30b5\u30fc\u30d0\u76e3\u8996\u3059\u308b\u306b\u306f\u3044\u308d\u3044\u308d\u3042\u308b\u3088\u3046\u3060\u3051\u3069\u3001\u6700\u8fd1\u306f prometheus \u3068\u3044\u3046\u306e\u304c\u30db\u30c3\u30c8\u3089\u3057\u3044\u3002\nprometheus \u306f \u305d\u308c\u81ea\u8eab\u3068 exporter \u3067\u69cb\u6210\u3055\u308c\u308b\n\n> exporter \u306e\u4e00\u89a7\nhttps://prometheus.io/docs/instrumenting/exporters/\n\nprometheus \u3092\u52d5\u304b\u3059\u306b\u306f apt \u306a\u3069\u306e\u30d1\u30c3\u30b1\u30fc\u30b8\u7ba1\u7406\u30b7\u30b9\u30c6\u30e0\u3092\u4f7f\u3063\u3066\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u3053\u3068\u3082\u51fa\u6765\u308b\u3051\u3069\u3001\u308f\u308a\u3068\u53e4\u304b\u3063\u305f\u308a\u3059\u308b\u306e\u304c\u9762\u5012\u306a\u306e\u3067\u516c\u5f0f\u3067\u63d0\u4f9b\u3055\u308c\u3066\u3044\u308b docker \u30a4\u30e1\u30fc\u30b8\u3092\u4f7f\u3046\u3053\u3068\u306b\u3059\u308b\u3002\n\n\u3061\u306a\u307f\u306b \u4e00\u65e6 apt \u3067\u5165\u308b prometheus \u306f\u6700\u65b0\u306e\u3082\u306e\u3068\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u306a\u3069\u304c\u7570\u306a\u308b\u53ef\u80fd\u6027\u304c\u3042\u308b\u306e\u3067 \u65e2\u5b58\u306e\u3082\u306e\u304b\u3089 docker \u30a4\u30e1\u30fc\u30b8\u306e prometheus \u306b\u79fb\u884c\u3059\u308b\u969b\u306f\u6ce8\u610f\u304c\u5fc5\u8981\u3002\n\n\n### prometheus on docker\n\n> prometheus \u516c\u5f0f\u306e docker \u30a4\u30e1\u30fc\u30b8\nhttps://hub.docker.com/u/prom/\n\n\u3068\u308a\u3042\u3048\u305a prometheus \u3060\u3051\u8d77\u52d5\u3059\u308b\u5834\u5408\n\n> Using Docker\nhttps://prometheus.io/docs/introduction/install/#using-docker\n\n\u3053\u3053\u306e\u3088\u3046\u306b\u30db\u30b9\u30c8\u5074\u306e\u30dd\u30fc\u30c8\u4f7f\u3063\u3066\u3082\u3044\u3044\u3051\u3069\u3001expoter \u7cfb\u304c\u5916\u90e8\u304b\u3089\u76f4\u63a5\u898b\u3089\u308c\u308b\u306e\u3063\u3066\u6016\u3044\u306a\u30fc\u3068\u3044\u3046\u611f\u3058\u3002 iptables \u306a\u3069\u3067\u8a2d\u5b9a\u3057\u3066\u3082\u826f\u3044\u3093\u3060\u308d\u3046\u3051\u3069\u3001\u4eca\u56de\u306f docker \u306e\u30e6\u30fc\u30b6\u5b9a\u7fa9\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u3092\u4f7f\u3063\u3066\u3044\u308b\u3002\n\nhttps://docs.docker.com/engine/userguide/networking/\n\n\u307e\u305f\u3001\u9069\u5f53\u306b\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u306b\u30a2\u30bf\u30c3\u30c1\u3059\u308b\u5834\u5408 IP \u30a2\u30c9\u30ec\u30b9\u304c\u8d77\u52d5\u3059\u308b\u305f\u3073\u306b\u5909\u308f\u3063\u3066\u3057\u307e\u3046\u3002prometheus \u306e\u8a2d\u5b9a\u306b\u76f4\u66f8\u304d\u3060\u3068\u601d\u3046\u306e\u3067\u500b\u3005\u3089\u3078\u3093\u306f\u56fa\u5b9a\u3067\u3084\u308b\u3002 \u3053\u3053\u3089\u3078\u3093\u306f\u30b3\u30f3\u30c6\u30ca\u8d77\u52d5\u6642\u306b\u8a2d\u5b9a\u3059\u308b\u3002\u8d77\u52d5\u3057\u305f\u307e\u307e\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u306b\u30a2\u30bf\u30c3\u30c1\u3059\u308b\u5834\u5408\u306f\u56fa\u5b9a\u306b\u3067\u304d\u306a\u304b\u3063\u305f\u6c17\u304c\u3059\u308b\u3002\n\nhttp://qiita.com/paihu/items/17aa47906dd2bf935a25\nhttp://qiita.com/takara@github/items/2349fff473474d7fcf47\n\n\u4e0b\u8a18\u306e\u3088\u3046\u306a\u30b3\u30de\u30f3\u30c9\u3067\u76e3\u8996\u7cfb\u306e\u30b3\u30f3\u30c6\u30ca\u3092\u3076\u3089\u4e0b\u3052\u308b\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u3092\u4f5c\u308b\u3053\u3068\u304c\u3067\u304d\u308b\u3002\u305f\u3076\u3093\u3053\u308c\u3060\u3051\u3002\u3053\u306e\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u3092\u6307\u5b9a\u3057\u3066\u30b3\u30f3\u30c6\u30ca\u3092\u4f5c\u3063\u305f\u308a\u8d77\u52d5\u9014\u4e2d\u3067\u30a2\u30bf\u30c3\u30c1\u3057\u305f\u308a\u3059\u308b\u3068\u3053\u306e\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u306b\u5165\u308b\u3002\u6307\u5b9a\u305b\u305a\u306b\u8d77\u52d5\u3057\u305f\u5834\u5408\u306f\u30c7\u30d5\u30a9\u30eb\u30c8\u306e\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u306e\u65b9\u306b\u5165\u308b\u3002\n\n```\n$ docker network create --subnet=172.18.0.0/24 prometheus_nw\n```\n\n#### docker \u30b3\u30f3\u30c6\u30ca\u306b\u3064\u3044\u3066\n\n\u3056\u3063\u304f\u308a docker pull \u3059\u308b\u3068\u4e0b\u8a18\u306e\u3088\u3046\u306b\u306a\u308b\u3002\uff08\u6a2a\u7740\u3057\u3066 xargs \u3067\u66f8\u3044\u3066\u308b\uff09\n\n```\n$ echo \"prom/prometheus prom/alertmanager google/cadvisor prom/blackbox_exporter prom/node-exporter\" | xargs -n 1 docker pull\n```\n\u8aac\u660e\n\n| \u540d\u524d                  | \u96d1\u306a\u8aac\u660e  | \u30ea\u30dd\u30b8\u30c8\u30ea |\n|-----------------------------|------------|---| \n| prometheus | \u30e1\u30c8\u30ea\u30af\u30b9\u3092 exporter \u304b\u3089 pull \u3057\u3066\u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0\u306b\u4fdd\u5b58\u3059\u308b | https://github.com/prometheus/prometheus |\n| node-expoter | CPU \u3068\u304b \u30e1\u30e2\u30ea \u3068\u304b\u898b\u3089\u308c\u308b\u304b\u3089\u3068\u308a\u3042\u3048\u305a\u3044\u308c\u3068\u3051\u3063\u3066 exporter |  https://github.com/prometheus/node_exporter | \n| alertmanager | \u30a2\u30e9\u30fc\u30c8\u98db\u3070\u3059\u3068\u304d\u306b\u3069\u3053\u306b\u98db\u3070\u3059\u304b\u3068\u304b\u9759\u89b3\u3059\u308b\u304b\u3068\u304b\u8a2d\u5b9a\u3067\u304d\u308b\u3002\u30eb\u30fc\u30eb\u81ea\u4f53\u306f prometheus \u3067\u6307\u5b9a\u3059\u308b\u3051\u3069\u3002 | https://github.com/prometheus/alertmanager | \n| cadvisor | Docker \u30b3\u30f3\u30c6\u30ca\u306e\u76e3\u8996\u306b\u4f7f\u3046\u3089\u3057\u3044\u3002 mysql-exporter \u3068\u540c\u3058\u30dd\u30fc\u30c8\u3092\u4f7f\u3046\u306e\u3067\u30db\u30b9\u30c8\u306b\u7d10\u4ed8\u3051\u308b\u5834\u5408\u306f\u6ce8\u610f\u3002 | https://github.com/google/cadvisor |\n\n\u4eca\u56de\u306f\u4e0b\u8a18\u306e\u3088\u3046\u306b\u8a2d\u5b9a\u3059\u308b\u3002 container \u3092 suffix \u306b\u3057\u3066\u308b\u306e\u306f\u30b3\u30de\u30f3\u30c9\u306a\u3069\u3068\u6df7\u540c\u3057\u306a\u3044\u3088\u3046\u306b\u3059\u308b\u305f\u3081\u3002\n\n#### \u8d77\u52d5\u30b3\u30de\u30f3\u30c9\n\nprometheus\n\n```console\n$ docker run --name=prometheus-container --net=prometheus_nw --ip=172.18.0.2 -d -v /home/prometheus/prometheus:/prometheus prom/prometheus -config.file=/prometheus/prometheus.yml   -alertmanager.url=http://172.18.0.4\n```\n\nnode_exporter\n\n```console\n$ docker run --name node-exporter-container -d --net=prometheus_nw --ip=172.18.0.3 -v \"/proc:/host/proc\"  -v \"/sys:/host/sys\" -v \"/:/rootfs\" prom/node-exporter -collector.procfs /host/proc -collector.sysfs /host/sys -collector.filesystem.ignored-mount-points \"^/(sys|proc|dev|host|etc)($|/)\"\n```\n\n\u53c2\u8003 https://github.com/prometheus/node_exporter\n\u4eca\u56de\u306e\u5834\u5408\u3001 docker \u3092\u52d5\u304b\u3057\u3066\u308b\u306e\u3067 README \u306e\u6700\u5f8c\u306b\u3042\u308b\u3088\u3046\u306b\u8d77\u52d5\u3059\u308b\u3002\n\nalertmanager\n\nUI \u306e URL \u306f\u81ea\u5206\u306e\u74b0\u5883\u306b\u5408\u308f\u305b\u3066\u3002\n\n```console\n$ docker run --name alertmanager-container -d --net=prometheus_nw --ip=172.18.0.4 -v /home/prometheus/alertmanager:/alertmanager prom/alertmanager -config.file=/alertmanager/alertmanager.yml -web.external-url=http://alertmanager.example.com\n```\n\ncadvisor\n\n```console\n$ docker run --name=cadvisor-container --net=prometheus_nw --ip=172.18.0.6 --volume=/:/rootfs:ro --volume=/var/run:/var/run:rw --volume=/sys:/sys:ro --volume=/var/lib/docker/:/var/lib/docker:ro --detach=true  google/cadvisor:latest\n```\n\n\n### configuration for prometheus\n\n\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u306a\u3069\u306f\u30db\u30b9\u30c8\u5074\u306b\u7f6e\u304f\u3053\u3068\u306b\u306a\u308b\u3002\u7f6e\u304f\u5834\u6240\u306f\u597d\u304d\u306a\u5834\u6240\u3067\u3088\u3044\u3002\u81ea\u5206\u306e\u5834\u5408\u306f\u3082\u3068\u3082\u3068 apt \u3067\u5165\u3063\u305f prometheus \u30e6\u30fc\u30b6\u3067\u52d5\u304b\u3057\u3066\u3044\u305f\u306e\u3067 \u3068\u308a\u3042\u3048\u305a /home \u4ee5\u4e0b\u306b prometheus \u8a2d\u5b9a\u3092\u5165\u308c\u305f\u3002\n\n```console\n$ pwd\n/home/prometheus\n$ tree -L 2\n.\n\u251c\u2500\u2500 alertmanager\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 alertmanager.yml\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 data\n\u2514\u2500\u2500 prometheus\n    \u251c\u2500\u2500 alerts.rule\n    \u251c\u2500\u2500 data\n    \u2514\u2500\u2500 prometheus.yml\n                                                                                                                                           4 directories, 3 files                                                                                                                                                                                                                                                             \n```\n\nprometheus \u81ea\u4f53\u306e\u8a2d\u5b9a\n\n\u53c2\u8003URL\n\n> https://prometheus.io/docs/operating/configuration/\nhttps://prometheus.io/docs/introduction/getting_started/\n\n\u4e0b\u8a18\u306e\u3082\u306e\u306f\u3068\u308a\u3042\u3048\u305a node_exporter \u3068 docker \u306e\u3082\u306e\u3092 pull \u3059\u308b\u3088\u3046\u306b\u3059\u308b\u8a2d\u5b9a\u3002exporter \u3092\u5897\u3084\u3057\u305f\u308a\u3057\u305f\u5834\u5408\u306f\u9069\u5b9c\u5909\u66f4\u3059\u308b\u30d5\u30a1\u30a4\u30eb\u3002\n\n```yaml:prometheus.yml\nglobal:\n  scrape_interval:     15s # By default, scrape targets every 15 seconds.\n\nrule_files:\n  - alerts.rule\n\nscrape_configs:\n- job_name: node\n  static_configs:\n  - targets: ['172.18.0.3:9100']\n- job_name: docker\n  static_configs:\n  - targets: ['172.18.0.6:8080']\n```\n\n\u30a2\u30e9\u30fc\u30c8\u30eb\u30fc\u30eb\u306f\u5225\u30d5\u30a1\u30a4\u30eb\u306b\u66f8\u304f\u3002\n\n\u53c2\u8003URL\n> https://prometheus.io/docs/alerting/rules/\n\n\u3068\u308a\u3042\u3048\u305a node_expoter \u304c\u843d\u3061\u3066\u305f\u3089\u30a2\u30e9\u30fc\u30c8\u98db\u3070\u3059\u4f8b\u3002\u30a2\u30e9\u30fc\u30c8\u30eb\u30fc\u30eb\u306e\u77e5\u898b\u307b\u3057\u3044\u3067\u3059\u306d\u3002\n\n```alerts.rule\nALERT InstanceDown\n  IF up == 0\n  FOR 5m\n  LABELS { severity = \"page\" }\n  ANNOTATIONS {\n    summary = \"Instance {{ $labels.instance }} down\",\n    description = \"{{ $labels.instance }} of job {{ $labels.job }} has been down for more than 5 minutes.\"\n  }\n```\n\nalertmanager \u5074\u306e\u8a2d\u5b9a\n\n\u3053\u3053\u3067\u306f\u30a2\u30e9\u30fc\u30c8\u98db\u3070\u3059\u5148\u306e\u8a2d\u5b9a\u3092\u3059\u308b\u3002\n\n\u4e0b\u8a18\u306f Gmail \u3067\u9001\u308b\u5834\u5408\u306e\u4f8b\u3002\n\n> Sending email with the Alertmanager via Gmail \nhttps://www.robustperception.io/sending-email-with-the-alertmanager-via-gmail/\n\n\u30a2\u30d7\u30ea\u6bce\u306b\u30d1\u30b9\u30ef\u30fc\u30c9\u8a2d\u5b9a\u3059\u308b\u5834\u5408\u306e\u30d8\u30eb\u30d7\n\n> Sign in using App Passwords\nhttps://support.google.com/accounts/answer/185833?hl=en\n\n\u30d1\u30b9\u30ef\u30fc\u30c9\u306f\u3053\u3053\u3067\u3064\u304f\u308b\nhttps://security.google.com/settings/security/apppasswords\n\n\u305d\u306e\u4ed6\u3044\u308d\u3044\u308d\u5bfe\u5fdc\u3057\u3066\u3044\u308b\u306e\u3067\u5fc5\u8981\u306a\u901a\u77e5\u5148\u3092\u8a2d\u5b9a\u3059\u308b\u3002prometheus \u3067\u4ed8\u4e0e\u3057\u305f job \u3084\u30e9\u30d9\u30eb\u306b\u3088\u3063\u3066\u901a\u77e5\u5148\u3084\u901a\u77e5\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u5909\u3048\u305f\u308a\u3067\u304d\u308b\u306e\u3067\u3046\u307e\u3044\u3053\u3068\u3084\u308b\u3002\n\n```yaml:alertmanager.yml\nroute:\n  receiver: hogehoge-mail\nreceivers:\n  - name: hogehoge-mail\n    email_configs:\n    - to: \"hogehoge@example.com\"\n      from: \"hogehoge@example.com\"\n      smarthost: smtp.gmail.com:587\n      auth_username: \"hogehoge@example.com\"\n      auth_identity: \"hogehoge@example.com\"\n      auth_password: \"brabrabrabra\"\n```\n\n#### \u8a2d\u5b9a\u53cd\u6620\u306b\u3064\u3044\u3066\n\ndocker \u3067\u8d77\u52d5\u3057\u305f prometheus \u3084 exporter \u306e\u8a2d\u5b9a\u3092\u5909\u66f4\u3057\u305f\u5834\u5408\u3001 docker stop && docker start \u3067\u3088\u3044\u3002\n\n\u307e\u305f\u306f systemd \u304c\u4f7f\u3048\u308b\u5834\u5408\u306f\u4e8b\u9805\u306e\u3088\u3046\u306b\u8a2d\u5b9a\u3057\u3066 systemctl restart \u3067\u884c\u3063\u3066\u3082\u826f\u3055\u305d\u3046\u3002\n\n#### \u8d77\u52d5\u306e\u7ba1\u7406\u304a\u3088\u3073\u30a2\u30c3\u30d7\u30c7\u30fc\u30c8\n\nUbuntu 16.04.1 \u3067\u306f systemd \u4f7f\u3063\u3066\u308b\u306e\u3067\u3053\u308c\u3067\u8d77\u52d5\u7ba1\u7406\u3067\u304d\u305f\u3089\u697d\u305d\u3046\n\n> Start containers automatically\nhttps://docs.docker.com/engine/admin/host_integration/\n\n\u4e0b\u8a18\u306e\u69d8\u306b\u8a2d\u5b9a\u3059\u308b\u3002run \u306e\u3082\u306e\u306f -d \u307e\u305f\u306f --detach=true \u3092\u524a\u9664\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u3002\n>  Make sure you don\u2019t use \u201c-d\u201d for \u201cdetached mode\u201d. The command run from \u201cExecStart\u201d needs to run in the foreground.\n\n```/etc/systemd/system/prometheus-container.service\n[Unit]\nDescription=prometheus container\nRequires=docker.service\nAfter=docker.service\n                                                                                                                                                                  [Service]\nRestart=always\nExecStart=\nExecStart=/usr/bin/docker run --name=prometheus-container --net=prometheus_nw --ip=172.18.0.2 -v /home/prometheus/prometheus:/prometheus prom/prometheus -config.file=/prometheus/prometheus.yml -alertmanager.url=http://172.18.0.4\nExecStop=/usr/bin/docker stop -t 2 prometheus-container\nExecStopPost=/usr/bin/docker rm -f prometheus-container\n\n[Install]\nWantedBy=default.target\n```\n\n\u3053\u306e\u3088\u3046\u306b\u3057\u3066\u304a\u3051\u3070\u3001 \u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u30a2\u30c3\u30d7\u30c7\u30fc\u30c8\u306f\u4e0b\u8a18\u306e\u3088\u3046\u306b\u3059\u308b\u3060\u3051\u3067\u3088\u3044\u3002\n\n```\n$ docker pull prom/prometheus \n$ sudo systemctl restart prometheus-container.service\n```\n\n\u4e0b\u8a18\u8a18\u4e8b\u306e\u3088\u3046\u306b ExecStartPre \u3067 pull \u3057\u3066\u3082\u826f\u3044\u304b\u3082\u3057\u308c\u306a\u3044\u304c\u3001 restart \u3059\u308b\u3060\u3051\u3067\u30a2\u30c3\u30d7\u30c7\u30fc\u30c8\u3055\u308c\u308b\u306e\u306f\u500b\u4eba\u7684\u306b\u597d\u307f\u3067\u306f\u306a\u3044\u306e\u3067\u3084\u3063\u3066\u306a\u3044\u3002\n\n> docker\u30b3\u30f3\u30c6\u30ca\u3092systemd\u3067\u7ba1\u7406\u3055\u305b\u308b\nhttp://qiita.com/74th/items/e8dc1ac1295140413dc8\n\n\n### UserInterface\n\nUI \u3092\u898b\u3089\u308c\u308b\u3088\u3046\u306b\u3059\u308b\u305f\u3081\u306b \u9069\u5f53\u306b nginx \u306b\u8a2d\u5b9a\u66f8\u304f\u3002\u4e0b\u8a18\u306f\u3056\u3063\u304f\u308a\u3057\u305f\u4f8b\u3002cadviser \u306b\u3082 UI \u304c\u3042\u308b\u304c cadviser \u306e UI \u3082\u78ba\u8a8d\u3057\u305f\u3051\u308c\u3070\u540c\u69d8\u306b\u8ffd\u52a0\u3059\u308b\u3068\u826f\u3044\u3002\n\u7c21\u5358\u306b\u898b\u3089\u308c\u308b\u3068\u56f0\u308a\u305d\u3046\u306a\u306e\u3067\u96d1\u306b BASIC \u8a8d\u8a3c\u5165\u308c\u3066\u308b\u3002grafana \u3092\u4f7f\u3046\u5834\u5408\u306b\u30c7\u30fc\u30bf\u30bd\u30fc\u30b9\u3068\u3057\u3066 prometheus \u3092\u6307\u5b9a\u3057\u3066\u5229\u7528\u3059\u308b\u3053\u3068\u306b\u306a\u308b\u304c\u3001\u3053\u306e\u5834\u5408\u3067\u3082 grafana \u306e\u8a2d\u5b9a\u3067 BASIC \u8a8d\u8a3c\u66f8\u3051\u308b\u306e\u3067\u554f\u984c\u306a\u3057\u3002\n\n```nginx:\nupstream prometheus {\n  server 172.18.0.2:9090;\n}\nupstream alertmanager {\n  server 172.18.0.4:9093;\n}\n\nserver {\n  listen 80\n  server_name prometheus.example.com;\n  \n  location / {\n    proxy_pass http://prometheus;\n\n    auth_basic \"Prometheus\";\n    auth_basic_user_file \".htpasswd\";\n  }\n}\nserver {\n  listen 80\n  server_name alertmanager.example.com;\n  \n  location / {\n    proxy_pass http://alertmanager;\n\n    auth_basic \"AlertManager\";\n    auth_basic_user_file \".htpasswd\";\n  }\n}\n\n```\n\n\u3068\u308a\u3042\u3048\u305a .htpasswd \u4f5c\u308b\u4f8b\n\n```\n$ cd /etc/nginx/\n$ sudo htpasswd -c .htpasswd prometheus\n```\n\n### \n", "tags": ["prometheus1.5.0", "docker1.13.0"]}