{"tags": ["docker1.9.1", "RethinkDB2.2.1", "IDCF\u30af\u30e9\u30a6\u30c9", "DockerSwarm1.0.1", "docker-compose1.5.2"], "context": " More than 1 year has passed since last update.\u3000\u524d\u56de\u307e\u3067\u306b\u4f5c\u6210\u3057\u305fOverlay\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u306eDocker Swarm\u30af\u30e9\u30b9\u30bf\u3078Docker Compose\u3092\u4f7f\u3044RethinkDB\u3092\u30c7\u30d7\u30ed\u30a4\u3057\u3066\u307f\u307e\u3059\u3002 RethinkDB\u306e\u30d6\u30ed\u30b0\u306f\u8aad\u3093\u3067\u3044\u3066\u697d\u3057\u3044\u306e\u3067\u6c17\u306b\u5165\u3063\u3066\u3044\u307e\u3059\u3002ES6 Generator\u306e\u30b5\u30dd\u30fc\u30c8\u3082\u65e9\u304f\u30e2\u30c0\u30f3\u306a\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u3067\u3059\u3002\n\n\u3053\u306e\u30b7\u30ea\u30fc\u30ba\n\nIDCF\u30af\u30e9\u30a6\u30c9\u306eDebian Jessie\u3067Multi-Host Docker Networking - Part 1: Overlay\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u306e\u4f5c\u6210\nIDCF\u30af\u30e9\u30a6\u30c9\u306eDebian Jessie\u3067Multi-Host Docker Networking - Part 2: Docker Swarm\u30af\u30e9\u30b9\u30bf\u306e\u4f5c\u6210\nIDCF\u30af\u30e9\u30a6\u30c9\u306eDebian Jessie\u3067Multi-Host Docker Networking - Part 3: Overlay\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u3068Docker Swarm\u3068Docker Compose\u3067RethinkDB\u3092\u30b9\u30b1\u30fc\u30eb\u3055\u305b\u308b\nIDCF\u30af\u30e9\u30a6\u30c9\u306eDebian Jessie\u3067Multi-Host Docker Networking - Part 4: Couchbase Server\u3092\u30b9\u30b1\u30fc\u30eb\u3057\u3066\u307f\u308b\n\n\n\u53c2\u8003\n\u3000\u4ee5\u4e0b\u306e\u30b5\u30a4\u30c8\u3092\u53c2\u8003\u306b\u3057\u307e\u3057\u305f\u3002\n\nDocker\u3067\u30b5\u30af\u30c3\u3068RethinkDB\u306e\u30af\u30e9\u30b9\u30bf\u3092\u8a66\u3059\nSimplify deployment with the new networking features in Docker 1.9\nFun with Nuxeo Cloud and Docker Tools After DockerCon\n\n\n\u4eee\u60f3\u30de\u30b7\u30f3\n\u3000\u524d\u56de\u3068\u540c\u3058\u4eee\u60f3\u30de\u30b7\u30f3\u3092\u4f7f\u3044\u307e\u3059\u3002\n\n\n\nDocker\u30db\u30b9\u30c8\u306ehostname\nDocker\u30db\u30b9\u30c8\u306eeth0\nDocker Swarm\n\n\n\n\nminion-1\n10.3.0.101\nSwarm Manager/Agent\n\n\nminion-2\n10.3.0.102\nSwarm Agent\n\n\nminion-3\n10.3.0.103\nSwarm Agent\n\n\n\n\nRethinkDB\n\u3000RethinkDB\u306f\u30aa\u30d5\u30a3\u30b7\u30e3\u30eb\u306e\u30a4\u30e1\u30fc\u30b8\u3092\u4f7f\u3044\u307e\u3059\u3002\n\n\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\n\u3000rethink\u306e\u540d\u524d\u3067\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u4f5c\u6210\u3057\u3066docker-compose.yml\u3092\u914d\u7f6e\u3057\u307e\u3059\u3002\u3053\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u540d\u306f\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u540d\u3068\u3057\u3066\u30b3\u30f3\u30c6\u30ca\u306e\u540d\u524d\u3084Overlay\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u540d\u3068\u3057\u3066\u4f7f\u308f\u308c\u307e\u3059\u3002\n$ tree .\n.\n\u2514\u2500\u2500 rethink\n    \u2514\u2500\u2500 docker-compose.yml\n\n\ndocker-compose.yml\n\u3000Docker\u3067\u30b5\u30af\u30c3\u3068RethinkDB\u306e\u30af\u30e9\u30b9\u30bf\u3092\u8a66\u3059\u3092\u53c2\u8003\u306b\u3057\u3066docker-compose.yml\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\ndocker-compose.yml\nseed:\n  image: rethinkdb:2\n  ports:\n    - \"8088:8080\"\n  command: rethinkdb -n seed --bind all\n\nworker:\n  image: rethinkdb:2\n  environment:\n    - \"affinity:container!=rethink_worker_*\"\n  command: rethinkdb --bind all -j rethink_seed_1:29015\n\nproxy:\n  image: rethinkdb:2\n  ports:\n    - \"8080:8080\"\n  environment:\n    - constraint:node==minion-3\n  command: rethinkdb proxy --bind all -j rethink_seed_1:29015\n\n\n\u3000Docker Compose\u306fReleases\u30b5\u30a4\u30c8\u304b\u3089\u6700\u65b0\u30d0\u30fc\u30b8\u30e7\u30f3\u3092\u30ef\u30f3\u30e9\u30a4\u30ca\u30fc\u3067\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u307e\u3059\u3002\n$ curl -L https://github.com/docker/compose/releases/download/1.5.2/docker-compose-`uname -s`-`uname -m` > /usr/local/bin/docker-compose && chmod +x /usr/local/bin/docker-compose\n\n\nlinks\u3092\u4f7f\u308f\u306a\u3044\n\u3000Networking in Compose\u306eLinks\u306b\u3042\u308b\u3088\u3046\u306blibnetwork\u304c\u5c0e\u5165\u3055\u308clinks\u306fdeprecated\u3068\u306a\u308a\u307e\u3057\u305f\u3002docker-compose.yml\u304b\u3089\u524a\u9664\u3057\u3066\u3044\u307e\u3059\u3002\n\u3000\u3053\u308c\u307e\u3067Docker Compose\u306flinks\u3092\u6307\u5b9a\u3059\u308b\u3068\u30b3\u30f3\u30c6\u30ca\u306e/etc/hosts\u306b\u81ea\u52d5\u7684\u306b\u30a8\u30f3\u30c8\u30ea\u30fc\u3055\u308c\u540d\u524d\u89e3\u6c7a\u304c\u3067\u304d\u307e\u3057\u305f\u3002libnetwork\u306b\u5bfe\u5fdc\u3057\u3066Docker Compose\u3067\u306f--x-networking\u30d5\u30e9\u30b0\u3092\u3064\u3051\u3066up\u3059\u308b\u3068\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u540d(\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u540d)\u306e\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u304c\u81ea\u52d5\u7684\u306bdocker network create\u3055\u308c\u307e\u3059\u3002{\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u540d}_{\u30b5\u30fc\u30d3\u30b9\u540d}_N\u306e\u30db\u30b9\u30c8\u540d\u304c\u30b3\u30f3\u30c6\u30ca\u306e/etc/hosts\u306b\u767b\u9332\u3055\u308c\u540d\u524d\u89e3\u6c7a\u304c\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3057\u305f\u3002\n\u3000\u305f\u3060\u3057libnetwork\u304c\u307e\u3060\u30a8\u30a4\u30ea\u30a2\u30b9\u306b\u5bfe\u5fdc\u3057\u3066\u3044\u306a\u304b\u3063\u305f\u308a\u3001/etc/hosts\u3078\u306e\u767b\u9332\u306b\u306f\u3044\u304f\u3064\u304b\u554f\u984c\u304c\u3042\u308aissues\u304c\u4e0a\u304c\u3063\u3066\u3044\u307e\u3059\u3002\n\nAbout links at multi host x-networking\nsimple names in /etc/hosts when using the experimental networking feature\n\n\u3000\u53c2\u8003\u306e\u4f8b\u306elinks\u306f\u30b5\u30fc\u30d3\u30b9\u540d\u3067\u8a18\u8ff0\u3067\u304d\u307e\u3057\u305f\u304c\u3001{\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u540d}_{\u30b5\u30fc\u30d3\u30b9\u540d}_N\u306e\u3088\u3046\u306b\u56fa\u5b9a\u306b\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\nworker:\n  image: rethinkdb:2\n  links:\n    - seed:seed\n  command: rethinkdb --bind all -j seed:29015\nproxy:\n  image: rethinkdb:2\n  ports:\n    - 8080:8080\n  links:\n    - worker:worker\n  command: rethinkdb proxy --bind all -j worker:29015\n\n\nAffinity filter\n\u3000worker\u30b5\u30fc\u30d3\u30b9\u306fAffinity filter\u3092\u4f7f\u3044anti-affinity\u30d5\u30a3\u30eb\u30bf\u30fc\u3092\u4f5c\u308a\u307e\u3059\u3002rethink_worker_*\u306e\u30b3\u30f3\u30c6\u30ca\u304c\u8d77\u52d5\u3057\u3066\u3044\u306a\u3044\u5225\u306e\u30ce\u30fc\u30c9\u3092\u9078\u3073\u307e\u3059\u3002\nworker:\n  image: rethinkdb:2\n  environment:\n    - \"affinity:container!=rethink_worker_*\"\n  command: rethinkdb --bind all -j rethink_seed_1:29015\n\n\nConstraint filter\n\u3000proxy\u30b5\u30fc\u30d3\u30b9\u306fConstraint Filter\u3092\u6307\u5b9a\u3057\u3066minion-3\u306e\u30ce\u30fc\u30c9\u3092\u7279\u5b9a\u3057\u3066\u8d77\u52d5\u3057\u307e\u3059\u3002IDCF\u30af\u30e9\u30a6\u30c9\u306e\u8a2d\u5b9a\u3067\u30d1\u30d6\u30ea\u30c3\u30afIP\u30a2\u30c9\u30ec\u30b9\u3068minion-3\u3092\u30b9\u30bf\u30c6\u30a3\u30c3\u30afNAT\u3057\u3066\u3044\u307e\u3059\u3002\nproxy:\n  image: rethinkdb:2\n  ports:\n    - \"8080:8080\"\n  environment:\n    - constraint:node==minion-3\n  command: rethinkdb proxy --bind all -j rethink_seed_1:29015\n\n\nDocker Swarm\u3068Overlay\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\nDOCKER_HOST\u74b0\u5883\u5909\u6570\u306bSwarm Manager\u3092\u8a2d\u5b9a\u3057\u3066\u304b\u3089up\u3059\u308b\u3068Swarm\u30af\u30e9\u30b9\u30bf\u306b\u30c7\u30d7\u30ed\u30a4\u3057\u307e\u3059\u3002\n$ export DOCKER_HOST=tcp://10.3.0.101:3333\n$ pwd\n/root/rethink\n$ docker-compose \\\n  --x-networking \\\n  --x-network-driver=overlay \\\n  up -d\n\nDocker\u30a4\u30e1\u30fc\u30b8\u304c\u306a\u3044\u30ce\u30fc\u30c9\u3067\u306fdocker pull\u3059\u308b\u306e\u3067\u5c11\u3057\u6642\u9593\u304c\u304b\u304b\u308a\u307e\u3059\u3002docker-compose ps\u3067\u78ba\u8a8d\u3059\u308b\u3068\u30b5\u30fc\u30d3\u30b9\u306e\u30b3\u30f3\u30c6\u30ca\u304c1\u3064\u305a\u3064\u8d77\u52d5\u3057\u307e\u3057\u305f\u3002\n$ docker-compose ps\n         Name                     Command                    State                     Ports\n-----------------------------------------------------------------------------------------------------\nrethink_proxy_1           rethinkdb proxy --bind    Up                        28015/tcp, 29015/tcp, 1\n                          all ...                                             0.3.0.103:8080->8080/tc\n                                                                              p\nrethink_seed_1            rethinkdb -n seed         Up                        28015/tcp, 29015/tcp, 1\n                          --bind all                                          0.3.0.101:8088->8080/tc\n                                                                              p\nrethink_worker_1          rethinkdb --bind all -j   Up                        28015/tcp, 29015/tcp,\n                          re ...                                              8080/tcp\n\n\u3000--x-networking\u30d5\u30e9\u30b0\u3092\u6307\u5b9a\u3059\u308b\u3068\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u540d\u3067Docker\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002rethink\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u304c\u4f5c\u6210\u3055\u308c\u307e\u3057\u305f\u3002\n$ docker network ls\nNETWORK ID          NAME                DRIVER\n3f8bacd30250        rethink             overlay\nf10c0f7978af        dn                  overlay\nb68b118036d2        bridge              bridge\n636664a4f746        docker_gwbridge     bridge\n6e0cf0387184        none                null\nbc09b464b0c5        host                host\n\nSwarm Manager\u3092\u6307\u5b9a\u3057\u3066docker ps\u3067\u78ba\u8a8d\u3059\u308b\u3068NAMES\u5217\u306e\u30b3\u30f3\u30c6\u30ca\u540d\u306f{Docker\u30db\u30b9\u30c8\u540d}/{\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u540d}_{\u30b5\u30fc\u30d3\u30b9\u540d}_N\u306e\u3088\u3046\u306b\u4ed8\u3051\u3089\u308c\u3066\u3044\u307e\u3059\u3002\n$ docker ps\nCONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                                             NAMES\nb9f13b49004a        rethinkdb:2         \"rethinkdb proxy --bi\"   4 seconds ago       Up 2 seconds        28015/tcp, 10.3.0.103:8080->8080/tcp, 29015/tcp   minion-3/rethink_proxy_1\n581d02852c24        rethinkdb:2         \"rethinkdb --bind all\"   5 seconds ago       Up 4 seconds        8080/tcp, 28015/tcp, 29015/tcp                    minion-2/rethink_worker_1\n4ae146ed7671        rethinkdb:2         \"rethinkdb -n seed --\"   6 seconds ago       Up 5 seconds        28015/tcp, 29015/tcp, 10.3.0.101:8088->8080/tcp   minion-1/rethink_seed_1}}}\n\n\u3000--x-network-driver=overlay\u30d5\u30e9\u30b0\u306f\u30b3\u30f3\u30c6\u30ca\u306eeth0\u306bOverlay\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n$ docker exec minion-3/rethink_proxy_1 ip addr show\n1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default\n    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00\n    inet 127.0.0.1/8 scope host lo\n       valid_lft forever preferred_lft forever\n    inet6 ::1/128 scope host\n       valid_lft forever preferred_lft forever\n134: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1450 qdisc noqueue state UP group default\n    link/ether 02:42:0a:00:00:04 brd ff:ff:ff:ff:ff:ff\n    inet 10.0.0.4/24 scope global eth0\n       valid_lft forever preferred_lft forever\n    inet6 fe80::42:aff:fe00:4/64 scope link\n       valid_lft forever preferred_lft forever\n136: eth1: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP group default\n    link/ether 02:42:ac:12:00:03 brd ff:ff:ff:ff:ff:ff\n    inet 172.18.0.3/16 scope global eth1\n       valid_lft forever preferred_lft forever\n    inet6 fe80::42:acff:fe12:3/64 scope link\n       valid_lft forever preferred_lft forever\n\n\u3000/etc/hosts\u306b\u3082Overlay\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u306b\u53c2\u52a0\u3057\u3066\u30db\u30b9\u30c8\u540d\u304c\u767b\u9332\u3055\u308c\u3066\u3044\u308b\u306e\u3067\u3001Docker\u30db\u30b9\u30c8\u3092\u307e\u305f\u3044\u3060\u540d\u524d\u89e3\u6c7a\u304c\u3067\u304d\u307e\u3059\u3002\n$ docker exec minion-3/rethink_proxy_1 cat /etc/hosts\n10.0.0.4        f704478aaadf\n127.0.0.1       localhost\n::1     localhost ip6-localhost ip6-loopback\nfe00::0 ip6-localnet\nff00::0 ip6-mcastprefix\nff02::1 ip6-allnodes\nff02::2 ip6-allrouters\n10.0.0.2        rethink_seed_1\n10.0.0.2        rethink_seed_1.rethink\n10.0.0.3        rethink_worker_1\n10.0.0.3        rethink_worker_1.rethink\n10.0.0.5        rethink_worker_2\n10.0.0.5        rethink_worker_2.rethink\n10.0.0.6        rethink_worker_3\n10.0.0.6        rethink_worker_3.rethink\n\n\nscale\n\u3000up\u3057\u3066\u3044\u308b\u72b6\u614b\u3067worker\u30b5\u30fc\u30d3\u30b9\u306e\u30b3\u30f3\u30c6\u30ca\u30923\u53f0\u306bscale\u3057\u307e\u3059\u3002\n$ docker-compose \\\n  --x-networking \\\n  --x-network-driver=overlay \\\n  scale worker=3\nCreating and starting 2 ... done\nCreating and starting 3 ... done\n\n\u3000anti-affinity\u306e\u30d5\u30a3\u30eb\u30bf\u30fc\u3092\u6307\u5b9a\u3059\u308b\u3068worker\u30b5\u30fc\u30d3\u30b9\u306e\u30b3\u30f3\u30c6\u30ca\u306f\u306a\u308b\u3079\u304f\u540c\u3058Docker\u30db\u30b9\u30c8\u4e0a\u3067\u8d77\u52d5\u3057\u306a\u3044\u3088\u3046\u30b9\u30b1\u30b8\u30e5\u30fc\u30eb\u3055\u308c\u307e\u3059\u3002worker=3\u3068\u3057\u3066Swarm\u30af\u30e9\u30b9\u30bf\u306e\u30ce\u30fc\u30c9\u6570\u3068\u5408\u308f\u305b\u305f\u306e\u30671\u3064\u305a\u3064\u30b3\u30f3\u30c6\u30ca\u304c\u8d77\u52d5\u3057\u307e\u3057\u305f\u3002\n$ docker ps\nCONTAINER ID        IMAGE               COMMAND                  CREATED              STATUS              PORTS                                             NAMES\nd6a1e40685f9        rethinkdb:2         \"rethinkdb --bind all\"   8 seconds ago       Up 7 seconds        8080/tcp, 28015/tcp, 29015/tcp                    minion-3/rethink_worker_3\n4eb7c2959112        rethinkdb:2         \"rethinkdb --bind all\"   8 seconds ago       Up 7 seconds        8080/tcp, 28015/tcp, 29015/tcp                    minion-1/rethink_worker_2\nb9f13b49004a        rethinkdb:2         \"rethinkdb proxy --bi\"   2 minutes ago       Up 2 minutes        28015/tcp, 10.3.0.103:8080->8080/tcp, 29015/tcp   minion-3/rethink_proxy_1\n581d02852c24        rethinkdb:2         \"rethinkdb --bind all\"   2 minutes ago       Up 2 minutes        8080/tcp, 28015/tcp, 29015/tcp                    minion-2/rethink_worker_1\n4ae146ed7671        rethinkdb:2         \"rethinkdb -n seed --\"   2 minutes ago       Up 2 minutes        28015/tcp, 29015/tcp, 10.3.0.101:8088->8080/tcp   minion-1/rethink_seed_1\n\n\n\u30c8\u30e9\u30d6\u30eb\u30b7\u30e5\u30fc\u30c8\n\u3000--x-networking\u3092\u3064\u3051\u306a\u3044\u3067scale\u3057\u305f\u30b3\u30f3\u30c6\u30ca\u306b\u306f/etc/hosts\u304c\u5165\u308a\u307e\u305b\u3093\u3002scale\u3057\u305f\u30b3\u30f3\u30c6\u30ca\u304c\u540c\u3058Docker\u30db\u30b9\u30c8\u306e\u30b3\u30f3\u30c6\u30ca\u3082\u540d\u524d\u89e3\u6c7a\u304c\u3067\u304d\u306a\u304f\u306a\u308a\u3001\u5c11\u3057\u5d4c\u308a\u307e\u3057\u305f\u3002\n$ docker exec minion-3/rethink_worker_3 cat /etc/hosts\n172.17.0.3      8df54f957347\n127.0.0.1       localhost\n::1     localhost ip6-localhost ip6-loopback\nfe00::0 ip6-localnet\nff00::0 ip6-mcastprefix\nff02::1 ip6-allnodes\nff02::2 ip6-allrouters\n\n\u3000[\u524d\u56de](http://qiita.com/masato/items/a047798e48ccc1e56eb8)\u307e\u3067\u306b\u4f5c\u6210\u3057\u305fOverlay\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u306e[Docker Swarm](https://docs.docker.com/swarm/)\u30af\u30e9\u30b9\u30bf\u3078[Docker Compose](https://docs.docker.com/compose/)\u3092\u4f7f\u3044[RethinkDB](https://www.rethinkdb.com/)\u3092\u30c7\u30d7\u30ed\u30a4\u3057\u3066\u307f\u307e\u3059\u3002 RethinkDB\u306e[\u30d6\u30ed\u30b0](http://rethinkdb.com/blog/)\u306f\u8aad\u3093\u3067\u3044\u3066\u697d\u3057\u3044\u306e\u3067\u6c17\u306b\u5165\u3063\u3066\u3044\u307e\u3059\u3002[ES6 Generator](http://rethinkdb.com/blog/rethinkdbdash-iojs/)\u306e\u30b5\u30dd\u30fc\u30c8\u3082\u65e9\u304f\u30e2\u30c0\u30f3\u306a\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u3067\u3059\u3002\n\n\n## \u3053\u306e\u30b7\u30ea\u30fc\u30ba\n\n* [IDCF\u30af\u30e9\u30a6\u30c9\u306eDebian Jessie\u3067Multi-Host Docker Networking - Part 1: Overlay\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u306e\u4f5c\u6210](http://qiita.com/masato/items/6a1fa797b6c25d4c5745)\n* [IDCF\u30af\u30e9\u30a6\u30c9\u306eDebian Jessie\u3067Multi-Host Docker Networking - Part 2: Docker Swarm\u30af\u30e9\u30b9\u30bf\u306e\u4f5c\u6210](http://qiita.com/masato/items/a047798e48ccc1e56eb8)\n* [IDCF\u30af\u30e9\u30a6\u30c9\u306eDebian Jessie\u3067Multi-Host Docker Networking - Part 3: Overlay\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u3068Docker Swarm\u3068Docker Compose\u3067RethinkDB\u3092\u30b9\u30b1\u30fc\u30eb\u3055\u305b\u308b](http://qiita.com/masato/items/bd3d50b31f16a00eac47)\n* [IDCF\u30af\u30e9\u30a6\u30c9\u306eDebian Jessie\u3067Multi-Host Docker Networking - Part 4: Couchbase Server\u3092\u30b9\u30b1\u30fc\u30eb\u3057\u3066\u307f\u308b](http://qiita.com/masato/items/0be8b7da012f1180c281)\n\n## \u53c2\u8003\n\n\u3000\u4ee5\u4e0b\u306e\u30b5\u30a4\u30c8\u3092\u53c2\u8003\u306b\u3057\u307e\u3057\u305f\u3002\n\n* [Docker\u3067\u30b5\u30af\u30c3\u3068RethinkDB\u306e\u30af\u30e9\u30b9\u30bf\u3092\u8a66\u3059](http://qiita.com/lucidfrontier45/items/d006afbb4baea923a0c8)\n* [Simplify deployment with the new networking features in Docker 1.9](https://www.rethinkdb.com/blog/docker-networking/)\n* [Fun with Nuxeo Cloud and Docker Tools After DockerCon](http://www.nuxeo.com/blog/fun-with-nuxeo-cloud-and-docker-tools-after-dockercon/)\n\n\n\n## \u4eee\u60f3\u30de\u30b7\u30f3\n\n\u3000[\u524d\u56de](http://qiita.com/masato/items/a047798e48ccc1e56eb8)\u3068\u540c\u3058\u4eee\u60f3\u30de\u30b7\u30f3\u3092\u4f7f\u3044\u307e\u3059\u3002\n\n|Docker\u30db\u30b9\u30c8\u306ehostname|Docker\u30db\u30b9\u30c8\u306eeth0| Docker Swarm |\n|:--|:--|:--|\n|minion-1|10.3.0.101| Swarm Manager/Agent |\n|minion-2|10.3.0.102| Swarm Agent |\n|minion-3|10.3.0.103| Swarm Agent |\n\n## RethinkDB\n\n\u3000RethinkDB\u306f\u30aa\u30d5\u30a3\u30b7\u30e3\u30eb\u306e[\u30a4\u30e1\u30fc\u30b8](https://hub.docker.com/_/rethinkdb/)\u3092\u4f7f\u3044\u307e\u3059\u3002\n\n### \u30d7\u30ed\u30b8\u30a7\u30af\u30c8\n\n\u3000`rethink`\u306e\u540d\u524d\u3067\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u4f5c\u6210\u3057\u3066`docker-compose.yml`\u3092\u914d\u7f6e\u3057\u307e\u3059\u3002\u3053\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u540d\u306f\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u540d\u3068\u3057\u3066\u30b3\u30f3\u30c6\u30ca\u306e\u540d\u524d\u3084Overlay\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u540d\u3068\u3057\u3066\u4f7f\u308f\u308c\u307e\u3059\u3002\n\n```bash\n$ tree .\n.\n\u2514\u2500\u2500 rethink\n    \u2514\u2500\u2500 docker-compose.yml\n```\n\n\n## docker-compose.yml\n\n\u3000[Docker\u3067\u30b5\u30af\u30c3\u3068RethinkDB\u306e\u30af\u30e9\u30b9\u30bf\u3092\u8a66\u3059](http://qiita.com/lucidfrontier45/items/d006afbb4baea923a0c8)\u3092\u53c2\u8003\u306b\u3057\u3066`docker-compose.yml`\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n```yaml:docker-compose.yml\nseed:\n  image: rethinkdb:2\n  ports:\n    - \"8088:8080\"\n  command: rethinkdb -n seed --bind all\n\nworker:\n  image: rethinkdb:2\n  environment:\n    - \"affinity:container!=rethink_worker_*\"\n  command: rethinkdb --bind all -j rethink_seed_1:29015\n\nproxy:\n  image: rethinkdb:2\n  ports:\n    - \"8080:8080\"\n  environment:\n    - constraint:node==minion-3\n  command: rethinkdb proxy --bind all -j rethink_seed_1:29015\n```\n\n\n\u3000Docker Compose\u306f[Releases](https://github.com/docker/compose/releases)\u30b5\u30a4\u30c8\u304b\u3089\u6700\u65b0\u30d0\u30fc\u30b8\u30e7\u30f3\u3092\u30ef\u30f3\u30e9\u30a4\u30ca\u30fc\u3067\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u307e\u3059\u3002\n\n```bash\n$ curl -L https://github.com/docker/compose/releases/download/1.5.2/docker-compose-`uname -s`-`uname -m` > /usr/local/bin/docker-compose && chmod +x /usr/local/bin/docker-compose\n```\n\n### links\u3092\u4f7f\u308f\u306a\u3044\n\n\u3000[Networking in Compose](https://docs.docker.com/compose/networking/)\u306e[Links](https://docs.docker.com/compose/networking/#links)\u306b\u3042\u308b\u3088\u3046\u306b[libnetwork](https://github.com/docker/libnetwork)\u304c\u5c0e\u5165\u3055\u308c`links`\u306fdeprecated\u3068\u306a\u308a\u307e\u3057\u305f\u3002`docker-compose.yml`\u304b\u3089\u524a\u9664\u3057\u3066\u3044\u307e\u3059\u3002\n\n\u3000\u3053\u308c\u307e\u3067Docker Compose\u306f`links`\u3092\u6307\u5b9a\u3059\u308b\u3068\u30b3\u30f3\u30c6\u30ca\u306e`/etc/hosts`\u306b\u81ea\u52d5\u7684\u306b\u30a8\u30f3\u30c8\u30ea\u30fc\u3055\u308c\u540d\u524d\u89e3\u6c7a\u304c\u3067\u304d\u307e\u3057\u305f\u3002[libnetwork](https://github.com/docker/libnetwork)\u306b\u5bfe\u5fdc\u3057\u3066Docker Compose\u3067\u306f`--x-networking`\u30d5\u30e9\u30b0\u3092\u3064\u3051\u3066`up`\u3059\u308b\u3068\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u540d(\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u540d)\u306e\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u304c\u81ea\u52d5\u7684\u306b[docker network create](https://docs.docker.com/engine/reference/commandline/network_create/\n)\u3055\u308c\u307e\u3059\u3002`{\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u540d}_{\u30b5\u30fc\u30d3\u30b9\u540d}_N`\u306e\u30db\u30b9\u30c8\u540d\u304c\u30b3\u30f3\u30c6\u30ca\u306e`/etc/hosts`\u306b\u767b\u9332\u3055\u308c\u540d\u524d\u89e3\u6c7a\u304c\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3057\u305f\u3002\n\n\n\u3000\u305f\u3060\u3057libnetwork\u304c\u307e\u3060\u30a8\u30a4\u30ea\u30a2\u30b9\u306b\u5bfe\u5fdc\u3057\u3066\u3044\u306a\u304b\u3063\u305f\u308a\u3001`/etc/hosts`\u3078\u306e\u767b\u9332\u306b\u306f\u3044\u304f\u3064\u304b\u554f\u984c\u304c\u3042\u308aissues\u304c\u4e0a\u304c\u3063\u3066\u3044\u307e\u3059\u3002\n\n* [About links at multi host x-networking](https://github.com/docker/compose/issues/2462)\n* [simple names in /etc/hosts when using the experimental networking feature](https://github.com/docker/compose/issues/2312)\n\n\u3000[\u53c2\u8003\u306e\u4f8b](http://qiita.com/lucidfrontier45/items/d006afbb4baea923a0c8)\u306e`links`\u306f\u30b5\u30fc\u30d3\u30b9\u540d\u3067\u8a18\u8ff0\u3067\u304d\u307e\u3057\u305f\u304c\u3001`{\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u540d}_{\u30b5\u30fc\u30d3\u30b9\u540d}_N`\u306e\u3088\u3046\u306b\u56fa\u5b9a\u306b\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\n```yaml\nworker:\n  image: rethinkdb:2\n  links:\n    - seed:seed\n  command: rethinkdb --bind all -j seed:29015\nproxy:\n  image: rethinkdb:2\n  ports:\n    - 8080:8080\n  links:\n    - worker:worker\n  command: rethinkdb proxy --bind all -j worker:29015\n```\n\n### Affinity filter\n\n\u3000`worker`\u30b5\u30fc\u30d3\u30b9\u306f[Affinity filter](https://docs.docker.com/swarm/scheduler/filter/#affinity-filter)\u3092\u4f7f\u3044`anti-affinity`\u30d5\u30a3\u30eb\u30bf\u30fc\u3092\u4f5c\u308a\u307e\u3059\u3002`rethink_worker_*`\u306e\u30b3\u30f3\u30c6\u30ca\u304c\u8d77\u52d5\u3057\u3066\u3044\u306a\u3044\u5225\u306e\u30ce\u30fc\u30c9\u3092\u9078\u3073\u307e\u3059\u3002\n\n```yaml\nworker:\n  image: rethinkdb:2\n  environment:\n    - \"affinity:container!=rethink_worker_*\"\n  command: rethinkdb --bind all -j rethink_seed_1:29015\n```\n\n### Constraint filter\n\n\u3000`proxy`\u30b5\u30fc\u30d3\u30b9\u306f[Constraint Filter](https://docs.docker.com/swarm/scheduler/filter/#constraint-filter)\u3092\u6307\u5b9a\u3057\u3066`minion-3`\u306e\u30ce\u30fc\u30c9\u3092\u7279\u5b9a\u3057\u3066\u8d77\u52d5\u3057\u307e\u3059\u3002IDCF\u30af\u30e9\u30a6\u30c9\u306e\u8a2d\u5b9a\u3067\u30d1\u30d6\u30ea\u30c3\u30afIP\u30a2\u30c9\u30ec\u30b9\u3068`minion-3`\u3092\u30b9\u30bf\u30c6\u30a3\u30c3\u30afNAT\u3057\u3066\u3044\u307e\u3059\u3002\n\n```yaml\nproxy:\n  image: rethinkdb:2\n  ports:\n    - \"8080:8080\"\n  environment:\n    - constraint:node==minion-3\n  command: rethinkdb proxy --bind all -j rethink_seed_1:29015\n```\n\n## Docker Swarm\u3068Overlay\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\n\n `DOCKER_HOST`\u74b0\u5883\u5909\u6570\u306b`Swarm Manager`\u3092\u8a2d\u5b9a\u3057\u3066\u304b\u3089`up`\u3059\u308b\u3068Swarm\u30af\u30e9\u30b9\u30bf\u306b\u30c7\u30d7\u30ed\u30a4\u3057\u307e\u3059\u3002\n\n```basg\n$ export DOCKER_HOST=tcp://10.3.0.101:3333\n$ pwd\n/root/rethink\n$ docker-compose \\\n  --x-networking \\\n  --x-network-driver=overlay \\\n  up -d\n```\n\n Docker\u30a4\u30e1\u30fc\u30b8\u304c\u306a\u3044\u30ce\u30fc\u30c9\u3067\u306f`docker pull`\u3059\u308b\u306e\u3067\u5c11\u3057\u6642\u9593\u304c\u304b\u304b\u308a\u307e\u3059\u3002`docker-compose ps`\u3067\u78ba\u8a8d\u3059\u308b\u3068\u30b5\u30fc\u30d3\u30b9\u306e\u30b3\u30f3\u30c6\u30ca\u304c1\u3064\u305a\u3064\u8d77\u52d5\u3057\u307e\u3057\u305f\u3002\n\n\n```bash\n$ docker-compose ps\n         Name                     Command                    State                     Ports\n-----------------------------------------------------------------------------------------------------\nrethink_proxy_1           rethinkdb proxy --bind    Up                        28015/tcp, 29015/tcp, 1\n                          all ...                                             0.3.0.103:8080->8080/tc\n                                                                              p\nrethink_seed_1            rethinkdb -n seed         Up                        28015/tcp, 29015/tcp, 1\n                          --bind all                                          0.3.0.101:8088->8080/tc\n                                                                              p\nrethink_worker_1          rethinkdb --bind all -j   Up                        28015/tcp, 29015/tcp,\n                          re ...                                              8080/tcp\n```\n\n\u3000`--x-networking`\u30d5\u30e9\u30b0\u3092\u6307\u5b9a\u3059\u308b\u3068\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u540d\u3067Docker\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002`rethink`\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u304c\u4f5c\u6210\u3055\u308c\u307e\u3057\u305f\u3002\n\n```bash\n$ docker network ls\nNETWORK ID          NAME                DRIVER\n3f8bacd30250        rethink             overlay\nf10c0f7978af        dn                  overlay\nb68b118036d2        bridge              bridge\n636664a4f746        docker_gwbridge     bridge\n6e0cf0387184        none                null\nbc09b464b0c5        host                host\n```\n\n Swarm Manager\u3092\u6307\u5b9a\u3057\u3066`docker ps`\u3067\u78ba\u8a8d\u3059\u308b\u3068`NAMES`\u5217\u306e\u30b3\u30f3\u30c6\u30ca\u540d\u306f`{Docker\u30db\u30b9\u30c8\u540d}/{\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u540d}_{\u30b5\u30fc\u30d3\u30b9\u540d}_N`\u306e\u3088\u3046\u306b\u4ed8\u3051\u3089\u308c\u3066\u3044\u307e\u3059\u3002\n\n```bash\n$ docker ps\nCONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                                             NAMES\nb9f13b49004a        rethinkdb:2         \"rethinkdb proxy --bi\"   4 seconds ago       Up 2 seconds        28015/tcp, 10.3.0.103:8080->8080/tcp, 29015/tcp   minion-3/rethink_proxy_1\n581d02852c24        rethinkdb:2         \"rethinkdb --bind all\"   5 seconds ago       Up 4 seconds        8080/tcp, 28015/tcp, 29015/tcp                    minion-2/rethink_worker_1\n4ae146ed7671        rethinkdb:2         \"rethinkdb -n seed --\"   6 seconds ago       Up 5 seconds        28015/tcp, 29015/tcp, 10.3.0.101:8088->8080/tcp   minion-1/rethink_seed_1}}}\n```\n \n\u3000`--x-network-driver=overlay`\u30d5\u30e9\u30b0\u306f\u30b3\u30f3\u30c6\u30ca\u306e`eth0`\u306bOverlay\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n```bash\n$ docker exec minion-3/rethink_proxy_1 ip addr show\n1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default\n    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00\n    inet 127.0.0.1/8 scope host lo\n       valid_lft forever preferred_lft forever\n    inet6 ::1/128 scope host\n       valid_lft forever preferred_lft forever\n134: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1450 qdisc noqueue state UP group default\n    link/ether 02:42:0a:00:00:04 brd ff:ff:ff:ff:ff:ff\n    inet 10.0.0.4/24 scope global eth0\n       valid_lft forever preferred_lft forever\n    inet6 fe80::42:aff:fe00:4/64 scope link\n       valid_lft forever preferred_lft forever\n136: eth1: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP group default\n    link/ether 02:42:ac:12:00:03 brd ff:ff:ff:ff:ff:ff\n    inet 172.18.0.3/16 scope global eth1\n       valid_lft forever preferred_lft forever\n    inet6 fe80::42:acff:fe12:3/64 scope link\n       valid_lft forever preferred_lft forever\n```\n\n\u3000`/etc/hosts`\u306b\u3082Overlay\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u306b\u53c2\u52a0\u3057\u3066\u30db\u30b9\u30c8\u540d\u304c\u767b\u9332\u3055\u308c\u3066\u3044\u308b\u306e\u3067\u3001Docker\u30db\u30b9\u30c8\u3092\u307e\u305f\u3044\u3060\u540d\u524d\u89e3\u6c7a\u304c\u3067\u304d\u307e\u3059\u3002\n\n```bash\n$ docker exec minion-3/rethink_proxy_1 cat /etc/hosts\n10.0.0.4        f704478aaadf\n127.0.0.1       localhost\n::1     localhost ip6-localhost ip6-loopback\nfe00::0 ip6-localnet\nff00::0 ip6-mcastprefix\nff02::1 ip6-allnodes\nff02::2 ip6-allrouters\n10.0.0.2        rethink_seed_1\n10.0.0.2        rethink_seed_1.rethink\n10.0.0.3        rethink_worker_1\n10.0.0.3        rethink_worker_1.rethink\n10.0.0.5        rethink_worker_2\n10.0.0.5        rethink_worker_2.rethink\n10.0.0.6        rethink_worker_3\n10.0.0.6        rethink_worker_3.rethink\n```\n\n\n## scale\n\n\u3000`up`\u3057\u3066\u3044\u308b\u72b6\u614b\u3067`worker`\u30b5\u30fc\u30d3\u30b9\u306e\u30b3\u30f3\u30c6\u30ca\u30923\u53f0\u306bscale\u3057\u307e\u3059\u3002\n\n```bash\n$ docker-compose \\\n  --x-networking \\\n  --x-network-driver=overlay \\\n  scale worker=3\nCreating and starting 2 ... done\nCreating and starting 3 ... done\n```\n\n\u3000`anti-affinity`\u306e\u30d5\u30a3\u30eb\u30bf\u30fc\u3092\u6307\u5b9a\u3059\u308b\u3068`worker`\u30b5\u30fc\u30d3\u30b9\u306e\u30b3\u30f3\u30c6\u30ca\u306f\u306a\u308b\u3079\u304f\u540c\u3058Docker\u30db\u30b9\u30c8\u4e0a\u3067\u8d77\u52d5\u3057\u306a\u3044\u3088\u3046\u30b9\u30b1\u30b8\u30e5\u30fc\u30eb\u3055\u308c\u307e\u3059\u3002`worker=3`\u3068\u3057\u3066Swarm\u30af\u30e9\u30b9\u30bf\u306e\u30ce\u30fc\u30c9\u6570\u3068\u5408\u308f\u305b\u305f\u306e\u30671\u3064\u305a\u3064\u30b3\u30f3\u30c6\u30ca\u304c\u8d77\u52d5\u3057\u307e\u3057\u305f\u3002\n\n```bash\n$ docker ps\nCONTAINER ID        IMAGE               COMMAND                  CREATED              STATUS              PORTS                                             NAMES\nd6a1e40685f9        rethinkdb:2         \"rethinkdb --bind all\"   8 seconds ago       Up 7 seconds        8080/tcp, 28015/tcp, 29015/tcp                    minion-3/rethink_worker_3\n4eb7c2959112        rethinkdb:2         \"rethinkdb --bind all\"   8 seconds ago       Up 7 seconds        8080/tcp, 28015/tcp, 29015/tcp                    minion-1/rethink_worker_2\nb9f13b49004a        rethinkdb:2         \"rethinkdb proxy --bi\"   2 minutes ago       Up 2 minutes        28015/tcp, 10.3.0.103:8080->8080/tcp, 29015/tcp   minion-3/rethink_proxy_1\n581d02852c24        rethinkdb:2         \"rethinkdb --bind all\"   2 minutes ago       Up 2 minutes        8080/tcp, 28015/tcp, 29015/tcp                    minion-2/rethink_worker_1\n4ae146ed7671        rethinkdb:2         \"rethinkdb -n seed --\"   2 minutes ago       Up 2 minutes        28015/tcp, 29015/tcp, 10.3.0.101:8088->8080/tcp   minion-1/rethink_seed_1\n```\n\n### \u30c8\u30e9\u30d6\u30eb\u30b7\u30e5\u30fc\u30c8\n\n\u3000`--x-networking`\u3092\u3064\u3051\u306a\u3044\u3067scale\u3057\u305f\u30b3\u30f3\u30c6\u30ca\u306b\u306f`/etc/hosts`\u304c\u5165\u308a\u307e\u305b\u3093\u3002scale\u3057\u305f\u30b3\u30f3\u30c6\u30ca\u304c\u540c\u3058Docker\u30db\u30b9\u30c8\u306e\u30b3\u30f3\u30c6\u30ca\u3082\u540d\u524d\u89e3\u6c7a\u304c\u3067\u304d\u306a\u304f\u306a\u308a\u3001\u5c11\u3057\u5d4c\u308a\u307e\u3057\u305f\u3002\n\n```bash\n$ docker exec minion-3/rethink_worker_3 cat /etc/hosts\n172.17.0.3      8df54f957347\n127.0.0.1       localhost\n::1     localhost ip6-localhost ip6-loopback\nfe00::0 ip6-localnet\nff00::0 ip6-mcastprefix\nff02::1 ip6-allnodes\nff02::2 ip6-allrouters\n```\n"}