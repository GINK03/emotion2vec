{"tags": ["JavaScript", "reactjs", "react-router", "redux", "Express"], "context": "React\u306e\u30b5\u30fc\u30d0\u30fc\u30b5\u30a4\u30c9\u30ec\u30f3\u30c0\u30ea\u30f3\u30b0(SSR)\u306e\u5b9f\u88c5\u65b9\u6cd5\u306b\u3064\u3044\u3066\u3001React\u5358\u4f53\u306e\u30b7\u30f3\u30d7\u30eb\u306a\u3082\u306e\u304b\u3089\u3001React Router, Redux\u3092\u7d44\u307f\u5408\u308f\u305b\u305f\u3082\u306e\u307e\u3067\u307e\u3068\u3081\u307e\u3059\u3002\n\u30b5\u30fc\u30d0\u30fc\u30b5\u30a4\u30c9\u306fExpress\u3092\u7528\u3044\u307e\u3059\u3002\n\u203b\u4ee5\u4e0b\u306eJavaScript\u306e\u30b3\u30fc\u30c9\u306b\u3064\u3044\u3066\u3001\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u30b5\u30a4\u30c9\u306b\u3064\u3044\u3066\u306e\u307fJSX + ES6\u5f62\u5f0f\u3067\u30b3\u30fc\u30c7\u30a3\u30f3\u30b0\u3057\u3066\u304a\u308a\u3001webpack\u3067compile\u3057\u3066\u5229\u7528\u3057\u3066\u3044\u307e\u3059\n\nReact\u5358\u4f53\u3067SSR\nReact\u5358\u4f53\u3067SSR\u3092\u5b9f\u73fe\u3059\u308b\u5834\u5408\u306f\u3001ReactDOMServer.renderToString\u3092\u4f7f\u7528\u3057\u307e\u3059\u3002\n\n\u53c2\u8003\u306b\u3057\u305f\u30bd\u30fc\u30b9\nReact\u5358\u4f53\u306eSSR\u3092\u5b9f\u88c5\u3059\u308b\u306b\u3042\u305f\u3063\u3066\u306f\u4ee5\u4e0b\u306e\u30bd\u30fc\u30b9\u3092\u53c2\u8003\u306b\u3057\u307e\u3057\u305f\u3002\n\n\nreact-server-example\n\nAPP_PROPS\u3092\u5229\u7528\u3057\u3066fetch\u3057\u305f\u30c7\u30fc\u30bf\u3092\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u5074\u306ejs\u3068\u5171\u6709\u3059\u308b\u70b9\u3092\u53c2\u8003\u306b\u3057\u307e\u3057\u305f\n\n\n\n\n\u9759\u7684\u306a\u60c5\u5831\u3092\u30ec\u30f3\u30c0\u30ea\u30f3\u30b0\u3059\u308b\u30d1\u30bf\u30fc\u30f3\n\u3053\u306e\u30d1\u30bf\u30fc\u30f3\u306e\u307f\u3067\u30b5\u30fc\u30d3\u30b9\u304c\u5b8c\u7d50\u3059\u308b\u3053\u3068\u306f\u306a\u3044\u3068\u601d\u3044\u307e\u3059\u304c\u3001SSR\u306e\u7b2c\u4e00\u6b69\u76ee\u3068\u3057\u3066\u898b\u3066\u3044\u304d\u307e\u3059\u3002\n\u307e\u305a\u306f\u3001\u30b7\u30f3\u30d7\u30eb\u306aReactComponent\u3092\u7528\u610f\u3057\u307e\u3059\u3002\nimport React, { Component } from 'react';\n\nexport default class App extends Component {\n  render() {\n    return (\n      <div>\n        Hello SSR!\n      </div>\n    );\n  }\n}\n\ncurl\u306a\u3069\u3067\u30a2\u30af\u30bb\u30b9\u3057\u305f\u969b\u306b\"Hello SSR!\"\u304c\u8868\u793a\u3055\u308c\u308c\u3070SSR\u306b\u6210\u529f\u3057\u305f\u3053\u3068\u306b\u306a\u308a\u307e\u3059\u3002\nExpress\u30b5\u30fc\u30d0\u30fc\u5074\u306e\u30bd\u30fc\u30b9\u306f\u4ee5\u4e0b\u3067\u3059\u3002\nvar express = require('express');\nvar app = express();\nvar path = require('path');\nvar React = require('../public/assets/app.server');\n\napp.use(express.static(path.join(__dirname, '..', 'public')));\n\n// for server side logic\napp.get('api/items', function (req, res, next) {\n  res.json([\n    {id: 1, text: 'first'},\n    {id: 2, text: 'second'},\n    {id: 3, text: 'third'}\n  ]);\n});\n\n// for server side rendering\napp.get('*', function (req, res, next) {\n  React(req, res);\n});\n\napp.listen(3000, function () {\n  console.log('Example app listening on port 3000!');\n});\n\n\u30c7\u30fc\u30bf\u3092\u8fd4\u3059api\u306e\u30eb\u30fc\u30c8\u30921\u3064\u5b9a\u7fa9\u3057\u3064\u3064\u3001\u305d\u308c\u4ee5\u5916\u306e\u5834\u5408\u306fReact\u5074\u306b\u51e6\u7406\u3092\u59d4\u8b72\u3057\u307e\u3059(\u6700\u521d\u306f\u3053\u306e\"/api/items\"\u306f\u4f7f\u3044\u307e\u305b\u3093)\u3002\u59d4\u8b72\u5148\u306e/assets/app.server\u3068\u3044\u3046\u30e2\u30b8\u30e5\u30fc\u30eb\u306fSSR\u7528\u306eserver.jsx\u3092compile\u3057\u305f\u3082\u306e\u3067\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u5b9f\u88c5\u3057\u3066\u3044\u307e\u3059\u3002\nimport React from 'react';\nimport { renderToString } from 'react-dom/server';\nimport App from 'App';\n\nfunction renderFullPage(renderedContent) {\n  return `\n  <!DOCTYPE html>\n    <html>\n\n    <head>\n        <meta charset=\"utf-8\">\n        <title>React Server Rendering sample</title>\n    </head>\n\n    <div id=\"app\">${renderedContent}</div>\n\n    <script type=\"text/javascript\" charset=\"utf-8\" src=\"/assets/app.js\"></script>\n    </body>\n    </html>\n\n  `;\n}\n\nexport default function render(req, res) {\n  const renderedContent = renderToString(<App />);\n  const renderedPage = renderFullPage(renderedContent);\n  res.status(200).send(renderedPage);\n};\n\n\u3053\u3053\u3067ReactDOMServer.renderToString\u3092\u5229\u7528\u3057\u3066\u30b5\u30fc\u30d0\u30fc\u30b5\u30a4\u30c9\u3067dom\u30c4\u30ea\u30fc\u3092\u751f\u6210\u3057\u3066\u3001html\u306b\u57cb\u3081\u8fbc\u3093\u3067\u8fd4\u3057\u307e\u3059\u3002\n\u307e\u305f\u3001\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u3067\u8aad\u307f\u8fbc\u3080client.jsx(/assets/app.js\u3068\u3057\u3066compile\u3055\u308c\u307e\u3059)\u3092\u7528\u610f\u3057\u307e\u3059\u3002\nimport React from 'react';\nimport ReactDOM from 'react-dom';\nimport App from 'App';\n\nReactDOM.render(<App />, document.getElementById('app'))\n\n\n\u3053\u3053\u307e\u3067\u7528\u610f\u3057\u3066\u30b5\u30fc\u30d0\u30fc\u3092\u8d77\u52d5\u3057\u3066curl\u30b3\u30de\u30f3\u30c9\u3092\u53e9\u3044\u3066\u307f\u308b\u3068\u3001\n<!DOCTYPE html>\n<html>\n\n<head>\n    <meta charset=\"utf-8\">\n    <title>React Server Rendering sample</title>\n</head>\n\n<div id=\"app\"><div data-reactid=\".1c4y3s5msqo\" data-react-checksum=\"-1658580955\">Hello SSR!</div></div>\n\n<script type=\"text/javascript\" charset=\"utf-8\" src=\"/assets/app.js\"></script>\n</body>\n</html>\n\n\u3061\u3083\u3093\u3068\"Hello SSR!\"\u304c\u8868\u793a\u3055\u308c\u308b\u3053\u3068\u304c\u78ba\u8a8d\u3067\u304d\u307e\u3059\u3002\n\n\u975e\u540c\u671f\u3067\u53d6\u5f97\u3057\u305f\u30c7\u30fc\u30bf\u3092\u7528\u3044\u3066\u30ec\u30f3\u30c0\u30ea\u30f3\u30b0\u3059\u308b\u30d1\u30bf\u30fc\u30f3\n\u7d9a\u3044\u3066\u3001\u8868\u793a\u3059\u308b\u30c7\u30fc\u30bf\u3092\u30b5\u30fc\u30d0\u30fc\u30b5\u30a4\u30c9\u3067fetch\u3059\u308b\u5834\u5408\u306b\u3064\u3044\u3066\u8a18\u8f09\u3057\u307e\u3059\u3002\u3053\u306e\u30d1\u30bf\u30fc\u30f3\u3067\u91cd\u8981\u306a\u306e\u304c\u3001fetch\u3057\u305f\u7d50\u679c\u3092\u30d6\u30e9\u30a6\u30b6\u5074\u306b\u3082\u5171\u6709\u3059\u308b\u3053\u3068\u3067\u3059\u3002\u305d\u3046\u3057\u306a\u3044\u3068\u30d6\u30e9\u30a6\u30b6\u5074\u3067js\u304cload\u3055\u308c\u305f\u969b\u306b\u518d\u5ea6fetch\u3092\u8d70\u3089\u305b\u308b\u5fc5\u8981\u304c\u51fa\u3066\u304d\u3066\u3057\u307e\u3044\u307e\u3059\u3002\nserver.jsx\u306erender\u95a2\u6570\u3092\nexport default function render(req, res) {\n  fetch('http://localhost:3000/api/items')\n    .then(apiResult => apiResult.json())\n    .then(items => {\n      const initialProps = { items };\n      const renderedContent = renderToString(<App {...initialProps} />);\n      const renderedPage = renderFullPage(renderedContent, initialProps);\n      res.status(200).send(renderedPage);\n    }).catch(error => {\n      res.status(500).send(error.message);\n    });\n};\n\n\n\u3068\u3057\u3066\u3001\u30c7\u30fc\u30bf\u3092fetch\u3092\u3057\u305f\u4e0a\u3067response\u3092\u8fd4\u3059\u3088\u3046\u306b\u5909\u66f4\u3057\u307e\u3059\u3002\u307e\u305f\u3001\u540c\u3058\u304fserver.jsx\u306erenderFullPage\u95a2\u6570\u3092\u4fee\u6b63\u3057\u3066\u3001\u30b5\u30fc\u30d0\u30fc\u30b5\u30a4\u30c9\u3067fetch\u3057\u305f\u7d50\u679c\u3092APP_PROPS\u3068\u3057\u3066\u4e00\u65e6script\u30bf\u30b0\u5185\u3067global\u5909\u6570\u306b\u683c\u7d0d\u3057\u307e\u3059\u3002\nfunction renderFullPage(renderedContent, initialProps) {\n  const appProps = safeStringify(initialProps);\n  return `\n  <!DOCTYPE html>\n    <html>\n\n    <head>\n        <meta charset=\"utf-8\">\n        <title>React Server Rendering sample</title>\n    </head>\n\n    <div id=\"app\">${renderedContent}</div>\n\n    <script>\n      var APP_PROPS = ${appProps};\n    </script>\n    <script type=\"text/javascript\" charset=\"utf-8\" src=\"/assets/app.js\"></script>\n    </body>\n    </html>\n\n  `;\n}\n\n\u306a\u305cAPP_PROPS\u306b\u30c7\u30fc\u30bf\u3092\u683c\u7d0d\u3057\u3066\u3044\u308b\u304b\u3068\u3044\u3046\u3068\u3001client.jsx\u3067\u5229\u7528\u3059\u308b\u305f\u3081\u3067\u3059\u3002\nimport React from 'react';\nimport ReactDOM from 'react-dom';\nimport App from 'App';\n\nconst props = window.APP_PROPS;\nReactDOM.render(<App { ...props } />, document.getElementById('app'))\n\n\u3053\u306e\u3088\u3046\u306bAPP_PROPS\u3092\u4ecb\u3057\u3066\u3001\u30b5\u30fc\u30d0\u30fc\u30b5\u30a4\u30c9\u3067fetch\u3057\u305f\u7d50\u679c\u3092\u30d6\u30e9\u30a6\u30b6\u5074\u306b\u5171\u6709\u3057\u307e\u3059\u3002\n\u307e\u305f\u3001\u305b\u3063\u304b\u304f\u306a\u306e\u3067App.jsx\u3067fetch\u3057\u305fprops\u3092\u8868\u793a\u3059\u308b\u3088\u3046\u306b\u4fee\u6b63\u3057\u307e\u3059\u3002\nimport React, { Component, PropTypes } from 'react';\n\nexport default class App extends Component {\n  render() {\n    const { items = [] } = this.props;\n    return (\n      <div>\n        <h1>Hello SSR!</h1>\n        <ul>\n          {items.map(item => {\n            return (<li key={item.id}>{item.id}: {item.text}</li>);\n          })}\n        </ul>\n      </div>\n    );\n  }\n}\n\nApp.propTypes = {\n  items: PropTypes.array\n};\n\ncurl\u3092\u53e9\u304f\u3068\u4ee5\u4e0b\u306ehtml\u304c\u8fd4\u3063\u3066\u304d\u307e\u3059\u3002\n<!DOCTYPE html>\n<html>\n\n<head>\n    <meta charset=\"utf-8\">\n    <title>React Server Rendering sample</title>\n</head>\n\n<div id=\"app\">\n    <div data-reactid=\".12o64evkrnk\" data-react-checksum=\"401071875\">\n        <h1 data-reactid=\".12o64evkrnk.0\">Hello SSR!</h1>\n        <ul data-reactid=\".12o64evkrnk.1\">\n            <li data-reactid=\".12o64evkrnk.1.$1\"><span data-reactid=\".12o64evkrnk.1.$1.0\">1</span><span data-reactid=\".12o64evkrnk.1.$1.1\">: </span><span data-reactid=\".12o64evkrnk.1.$1.2\">first</span></li>\n            <li data-reactid=\".12o64evkrnk.1.$2\"><span data-reactid=\".12o64evkrnk.1.$2.0\">2</span><span data-reactid=\".12o64evkrnk.1.$2.1\">: </span><span data-reactid=\".12o64evkrnk.1.$2.2\">second</span></li>\n            <li data-reactid=\".12o64evkrnk.1.$3\"><span data-reactid=\".12o64evkrnk.1.$3.0\">3</span><span data-reactid=\".12o64evkrnk.1.$3.1\">: </span><span data-reactid=\".12o64evkrnk.1.$3.2\">third</span></li>\n        </ul>\n    </div>\n</div>\n\n<script>\n  var APP_PROPS = {\"items\":[{\"id\":1,\"text\":\"first\"},{\"id\":2,\"text\":\"second\"},{\"id\":3,\"text\":\"third\"}]};\n</script>\n<script type=\"text/javascript\" charset=\"utf-8\" src=\"/assets/app.js\"></script>\n</body>\n</html>\n\nfetch\u3057\u305fitems\u306e\u30c7\u30fc\u30bf\u304c\u30ea\u30b9\u30c8\u5f62\u5f0f\u3067\u8868\u793a\u3055\u308c\u3066\u3044\u307e\u3059\u3002\u307e\u305f\u3001script\u30bf\u30b0\u3067fetch\u3057\u305f\u30c7\u30fc\u30bf\u3092APP_PROPS\u306b\u683c\u7d0d\u3057\u3066\u3044\u308b\u3053\u3068\u3082\u78ba\u8a8d\u3067\u304d\u307e\u3059\u3002\n\nReact + React Router\u3067SSR\n\u7d9a\u3044\u3066React Router\u3092\u5229\u7528\u3057\u305f\u5834\u5408\u306b\u3064\u3044\u3066\u307e\u3068\u3081\u307e\u3059\u3002\u30a2\u30af\u30bb\u30b9\u3055\u308c\u305furl\u306b\u5bfe\u3059\u308bReact Component\u306e\u5272\u308a\u51fa\u3057\u3092\u30b5\u30fc\u30d0\u30fc\u30b5\u30a4\u30c9\u3067\u5b9f\u65bd\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u304c\u3001React Router\u3067\u30b5\u30dd\u30fc\u30c8\u3055\u308c\u3066\u3044\u308b\u306e\u3067\u7279\u306b\u554f\u984c\u306f\u3042\u308a\u307e\u305b\u3093\u3002\n\n\u53c2\u8003\u306b\u3057\u305f\u30bd\u30fc\u30b9\n\nReact Router\u306eServer Rendering\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\nreact-server-routing-example\n\nasync-props\n\n\u975e\u540c\u671f\u3067\u53d6\u5f97\u3057\u305f\u30c7\u30fc\u30bf\u3092props\u3068\u3057\u3066\u30bb\u30c3\u30c8\u3057\u3066\u304f\u308c\u308bReact Router\u7528\u306e\u62e1\u5f35\u30e2\u30b8\u30e5\u30fc\u30eb\n\n\n\n\n\u9759\u7684\u306a\u60c5\u5831\u3092\u30ec\u30f3\u30c0\u30ea\u30f3\u30b0\u3059\u308b\u30d1\u30bf\u30fc\u30f3\n\u307e\u305a\u306f\u30c7\u30fc\u30bf\u3092fetch\u305b\u305a\u3001\u5358\u7d14\u306burl\u306b\u5bfe\u5fdc\u3059\u308bReact Component\u3092\u8868\u793a\u3057\u307e\u3059\u3002\n\u8907\u6570\u306eroute\u3092\u7528\u610f\u3059\u308b\u305f\u3081\u306b\u3001App.jsx\u306b\u52a0\u3048\u3066Items.jsx, Users.jsx\u3068\u3044\u3046Component\u3092\u8ffd\u52a0\u3057\u307e\u3059\u3002\u4ee5\u4e0b\u306fItems.jsx\u306e\u30bd\u30fc\u30b9\u3067\u3059(User.jsx\u3082\u307b\u307c\u540c\u69d8\u306e\u30b3\u30fc\u30c9)\u3002\nimport React, { Component, PropTypes } from 'react';\nimport { Link } from 'react-router';\n\nexport default class Items extends Component {\n  render() {\n    const { items = [] } = this.props;\n    return (\n      <div>\n        <h2>item list</h2>\n        <Link to='/users'>users\u3078</Link>\n        <ul>\n          {items.map(item => {\n            return (<li key={item.id}>{item.id}: {item.name}</li>);\n          })}\n        </ul>\n      </div>\n    );\n  }\n}\n\nItems.propTypes = {\n  items: PropTypes.array\n};\n\n\u307e\u305f\u3001App.jsx\u3092Items.jsx\u3068Users.jsx\u306e\u89aaComponent\u3068\u3059\u308b\u305f\u3081\u306b\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u4fee\u6b63\u3057\u307e\u3059\u3002\nimport React, { Component, PropTypes } from 'react';\n\nexport default class App extends Component {\n  render() {\n    return (\n      <div>\n        <h1>Hello SSR!</h1>\n        {this.props.children}\n      </div>\n    );\n  }\n}\n\nApp.propTypes = {\n  children: PropTypes.object\n};\n\n\u305d\u3057\u3066\u3001React Router\u3092\u4f7f\u3063\u305froutes.jsx\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\nimport React from 'react';\nimport { Route } from 'react-router';\n\nimport App from './App';\nimport Items from './Items';\nimport Users from './Users';\n\nexport default (\n  <Route path=\"/\" component={App}>\n    <Route path=\"items\" component={Items} />\n    <Route path=\"users\" component={Users} />\n  </Route>\n);\n\n\u7d9a\u3044\u3066\u3001\u3053\u306eroutes.jsx\u3092server.jsx, client.jsx\u306e\u305d\u308c\u305e\u308c\u3067\u5229\u7528\u3057\u307e\u3059\u3002\u307e\u305a\u306fserver.jsx\u306erender\u95a2\u6570\u3092\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u4fee\u6b63\u3057\u307e\u3059\u3002\nimport { match, RouterContext } from 'react-router'\nimport routes from './routes'\n...\nexport default function render(req, res) {\n  match({ routes, location: req.url }, (error, redirectLocation, renderProps) => {\n    if (error) {\n      res.status(500).send(error.message)\n    } else if (redirectLocation) {\n      res.redirect(302, redirectLocation.pathname + redirectLocation.search)\n    } else if (renderProps) {\n      const renderedContent = renderToString(<RouterContext {...renderProps} />);\n      const renderedPage = renderFullPage(renderedContent);\n      res.status(200).send(renderedPage);\n    } else {\n      res.status(404).send('Not found')\n    }\n  })\n};\n\n\nReact Routerr\u306ematch\u95a2\u6570\u3068RouterContext\u3092\u5229\u7528\u3059\u308b\u3053\u3068\u3067\u3001url\u306b\u5bfe\u5fdc\u3057\u305fComponent\u5272\u308a\u51fa\u3057\u3066dom\u30c4\u30ea\u30fc\u3092\u751f\u6210\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\nclient.jsx\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u4fee\u6b63\u3057\u307e\u3059\u3002\nimport React from 'react';\nimport ReactDOM from 'react-dom';\nimport { Router, browserHistory } from 'react-router'\nimport routes from './routes'\n\nReactDOM.render(\n  <Router history={browserHistory}>\n    {routes}\n  </Router>,\ndocument.getElementById('app'))\n\n\u30b5\u30fc\u30d0\u30fc\u3092\u8d77\u52d5\u3057\u3066curl\u3092\u53e9\u3044\u3066\u30c6\u30b9\u30c8\u3059\u308b\u3068\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\n\n\"/\"\u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3068\"Hello SSR!\"\u304c\u8868\u793a\n\"/items\"\u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3068\"Hello SSR!\"\u306b\u52a0\u3048\u3066\"item list\"\u304c\u8868\u793a(\u307e\u3060items\u30c7\u30fc\u30bf\u306ffetch\u3057\u3066\u3044\u306a\u3044\u306e\u3067\u30bf\u30a4\u30c8\u30eb\u306e\u307f)\n\n\u307e\u305f\u3001Item.jsx\u306b\u4ed5\u8fbc\u3093\u3067\u304a\u3044\u305f\"users\u3078\"\u306eLink\u3092\u30af\u30ea\u30c3\u30af\u3059\u308b\u3068\"/users\"\u3078\u9077\u79fb\u3057\u307e\u3059\u3002\n\n\u975e\u540c\u671f\u3067\u53d6\u5f97\u3057\u305f\u30c7\u30fc\u30bf\u3092\u7528\u3044\u3066\u30ec\u30f3\u30c0\u30ea\u30f3\u30b0\u3059\u308b\u30d1\u30bf\u30fc\u30f3\n\u53c2\u8003\u30bd\u30fc\u30b9\u3067\u306f\u3001\u57fa\u672c\u7684\u306b\u5404Component\u306bstatic\u306a\u30c7\u30fc\u30bf\u53d6\u5f97\u95a2\u6570\u3092\u5b9a\u7fa9\u3057\u3066\u304a\u3044\u3066\u3001match\u95a2\u6570\u306b\u3088\u3063\u3066\u95a2\u4fc2\u3059\u308bComponent\u304c\u5272\u308a\u51fa\u3055\u308c\u305f\u969b\u306b\u30c7\u30fc\u30bf\u53d6\u5f97\u3092\u5b9f\u884c\u3059\u308b\u3001\u3068\u3044\u3046\u65b9\u6cd5\u3092\u53d6\u3063\u3066\u3044\u308b\u3088\u3046\u3067\u3059\u3002\u305f\u3060\u3001Component\u304c\u968e\u5c64\u5316\u3055\u308c\u3066\u3044\u308b\u5834\u5408\u3001\u30c7\u30fc\u30bf\u3092\u53d6\u5f97\u3059\u308b\u3060\u3051\u3067\u306a\u304f\u53d6\u5f97\u3057\u305f\u30c7\u30fc\u30bf\u3092\u9069\u5207\u306aComponent\u306b\u6e21\u3059\u5de5\u592b\u304c\u5fc5\u8981\u306b\u306a\u308a\u307e\u3059\u3002\n\u4f8b\u3048\u3070Items.jsx\u3084Users.jsx\u3060\u3051\u3067\u306a\u304fApp.jsx\u3082\u72ec\u81ea\u306e\u30c7\u30fc\u30bf\u53d6\u5f97\u3092\u3059\u308b\u5834\u5408\u3001\u30b5\u30fc\u30d0\u30fc\u30b5\u30a4\u30c9\u3067\u306fApp.jsx\u3068Items.jsx\u3001\u3082\u3057\u304f\u306fApp.jsx\u3068Users.jsx\u306e\u30c7\u30fc\u30bf\u304c\u30bb\u30c3\u30c8\u3067\u53d6\u5f97\u3055\u308c\u307e\u3059\u3002\u305d\u3057\u3066\u3001App.jsx\u306e\u30c7\u30fc\u30bf\u53d6\u5f97\u95a2\u6570\u306e\u5b9f\u884c\u7d50\u679c\u306fApp.jsx\u306b\u3001Items.jsx/Users.jsx\u306e\u30c7\u30fc\u30bf\u306fItems.jsx/Users.jsx\u306b\u6e21\u3059\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\u3053\u306e\u52d5\u4f5c\u306e\u5b9f\u73fe\u3059\u308b\u305f\u3081\u3001\u4eca\u56de\u306fRouter\u3068App.jsx\u306e\u9593\u306b\u30c7\u30fc\u30bf\u7ba1\u7406\u7528\u306eComponent\u3092\u5dee\u3057\u8fbc\u3080\u65b9\u6cd5\u3092\u3068\u308a\u307e\u3059\u3002\nComponent\u306e\u968e\u5c64\u69cb\u9020\u3092\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u3057\u307e\u3059\u3002\n\u203bApp.jsx/Items.jsx/Users.jsx\u306a\u3069\u306eComponent\u3092[App Components]\u3068\u8a18\u8f09\u3001*\u3092\u3064\u3051\u305f\u3082\u306e\u304c\u5dee\u3057\u8fbc\u3080Component\n\nRouter : React Router\u306e\u30eb\u30fc\u30c8Component\n\n\n*AppContext : [App Components]\u306e\u30c7\u30fc\u30bf\u53d6\u5f97\u95a2\u6570\u306e\u5b9f\u884c\u7d50\u679c\u30c7\u30fc\u30bf\u3092\u4fdd\u6301\u3059\u308bComponent\n\n\nRouterContext : routes.jsx\u3067\u306e\u914d\u4e0b\u306b\u5b9a\u7fa9\u3055\u308c\u305f[App Components]\u3092render\u3059\u308bComponent\n\n\n*PropsContainer : [App Components]\u306bAppContext\u304c\u4fdd\u6301\u3059\u308b\u30c7\u30fc\u30bf\u3092\u6e21\u3059Component\n\n\n[App Component]\n\n\n\n\n\n\n\n\n\n\u3082\u3057\u3001/items\u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3068\u3001\n\n Router\n\n\nAppContext\n\n\nRouteContext\n\n\nPropContainer\n\n\nApp.jsx\n\n\n\n\n\n\n\n\n\n\u3068\u306a\u308a\u3001App.jsx\u4ee5\u4e0b\u306f\n\nApp.jsx\n\n\nPropContainer\n\n\nItem.jsx\n\n\n\n\n\n\u3068\u3044\u3046\u968e\u5c64\u69cb\u9020\u306b\u306a\u308a\u307e\u3059\u3002\n\u3061\u306a\u307f\u306b\u3053\u306e\u65b9\u6cd5\u306f\u3001\u4e0a\u3067\u6319\u3052\u305fasync-props\u3092\u53c2\u8003\u306b\u3057\u3066\u3044\u307e\u3059(\u8aac\u660e\u306b\u5fc5\u8981\u306a\u90e8\u5206\u3060\u3051\u3092\u5207\u308a\u51fa\u3057\u305f\u306e\u3067\u3001\u540c\u3058\u3053\u3068\u304c\u3084\u308a\u305f\u3044\u5834\u5408\u306f\u7d20\u76f4\u306b\u3053\u306e\u30e2\u30b8\u30e5\u30fc\u30eb\u3092\u5229\u7528\u3059\u308b\u65b9\u304c\u826f\u3044\u3067\u3059)\u3002\n\u307e\u305aApp.jsx/Items.jsx/Users.jsx\u306b\u30c7\u30fc\u30bf\u53d6\u5f97\u95a2\u6570\u3092\u5b9a\u7fa9\u3057\u307e\u3059\u3002App.jsx\u306f\u3001\nimport React, { Component, PropTypes } from 'react';\nimport fetch from 'isomorphic-fetch';\n\nexport default class App extends Component {\n\n  static loadProps(callback) {\n    fetch('http://localhost:3000/api/me')\n      .then(res => res.json())\n      .then(json => callback(null, {me: json}))\n      .catch(error => callback(error));\n  }\n\n  render() {\n    const { me } = this.props;\n    return (\n      <div>\n        <h1>Hello {me.name}!</h1>\n        <p>server date {me.date}!</p>\n        {this.props.children}\n      </div>\n    );\n  }\n}\n\nApp.propTypes = {\n  children: PropTypes.object\n};\n\n\n\u3068\u3044\u3046\u3088\u3046\u306b\u3001\u30c7\u30fc\u30bf\u53d6\u5f97\u95a2\u6570(loadProps)\u3092\u8ffd\u52a0\u3057\u3001props\u306e\u30c7\u30fc\u30bf\u3092\u8868\u793a\u3059\u308b\u3088\u3046\u306b\u4fee\u6b63\u3057\u3066\u3044\u307e\u3059\u3002\nloadProps\u306ffetch\u304c\u5b8c\u4e86\u3057\u305f\u3089callback\u3092\u547c\u3073\u307e\u3059\u304c\u3001\u305d\u306e\u969b\u306e\u5f15\u6570\u306f\u81ea\u8eab\u306b\u6e21\u3057\u3066\u6b32\u3057\u3044props\u306e\u5f62\u5f0f\u3068\u3057\u307e\u3059({me: json})\u3002\nItems.jsx/Users.jsx\u306b\u3082\u540c\u69d8\u306bloadProps\u3092\u5b9a\u7fa9\u3057\u3001props\u3092\u63cf\u753b\u3059\u308b\u3088\u3046\u306b\u4fee\u6b63\u3057\u307e\u3059\u3002\n\u7d9a\u3044\u3066server.jsx\u306erender\u95a2\u6570\u3067\u5404Component\u306eloadProps\u3092\u5b9f\u884c\u3057\u307e\u3059\u3002\nexport default function render(req, res) {\n  match({ routes, location: req.url }, (error, redirectLocation, renderProps) => {\n    if (error) {\n      res.status(500).send(error.message)\n    } else if (redirectLocation) {\n      res.redirect(302, redirectLocation.pathname + redirectLocation.search)\n    } else if (renderProps) {\n      const componentsArray = renderProps.components.filter(component => component.loadProps);\n      let propsArray = [];\n      Promise.all(\n        componentsArray.map((component, index) => {\n          return new Promise((resolve, reject) => {\n            component.loadProps((error, fetchResult) => {\n              if (error) {\n                reject(error);\n              } else {\n                propsArray[index] = fetchResult;\n                resolve();\n              }\n            });\n          });\n        })\n      ).then(() => {\n        const propsAndComponents = { componentsArray, propsArray };\n        const renderedContent = renderToString(<AppContext { ...renderProps } { ...propsAndComponents } />);\n        const renderedPage = renderFullPage(renderedContent, propsArray);\n        res.status(200).send(renderedPage);\n      }).catch(error => {\n        res.status(500).send(error.message)\n      });\n    } else {\n      res.status(404).send('Not found')\n    }\n  });\n};\n\nReact Router\u306ematch\u95a2\u6570\u3067\u5272\u308a\u51fa\u3055\u308c\u305fComponent\u306e\u3046\u3061loadProps\u3092\u5b9f\u88c5\u3057\u3066\u3044\u308b\u3082\u306e\u3092filtering\u3057\u305f\u4e0a\u3067\u3001\u305d\u308c\u305e\u308c\u306eloadProps\u3092\u5b9f\u884c\u3057\u3001Promise.all\u3067\u5168\u3066\u306e\u51e6\u7406\u304c\u5b8c\u4e86\u3059\u308b\u306e\u3092\u5f85\u3063\u3066\u3001\u53d6\u5f97\u30c7\u30fc\u30bf\u3092\u30c7\u30fc\u30bf\u7ba1\u7406\u7528Component\u3067\u3042\u308bAppContext\u306b\u6e21\u3057\u3066\u3044\u307e\u3059\u3002\u307e\u305f\u3001\u53d6\u5f97\u30c7\u30fc\u30bf\u3092\u30d6\u30e9\u30a6\u30b6\u306b\u3082\u5171\u6709\u3059\u308b\u305f\u3081\u306brenderFullPage\u95a2\u6570\u306e\u7b2c2\u5f15\u6570\u3068\u3057\u3066\u6e21\u3057\u3066\u3044\u307e\u3059(\u3053\u306e\u30b5\u30fc\u30d0\u30fc\u30b5\u30a4\u30c9\u3067\u53d6\u5f97\u3057\u305f\u30c7\u30fc\u30bf\u3092\u30d6\u30e9\u30a6\u30b6\u306b\u5171\u6709\u3059\u308b\u65b9\u6cd5\u306f\u65e2\u306b\"React\u5358\u4f53\u3067SSR\"\u3067\u8f09\u305b\u3066\u3044\u308b\u306e\u3067\u7701\u7565)\u3002\nclient.jsx\u3067\u3082Router\u76f4\u4e0b\u306bAppContext\u3092\u5dee\u3057\u8fbc\u3080\u3088\u3046\u306bRouter\u306erender\u30d7\u30ed\u30d1\u30c6\u30a3\u30fc\u3092\u4e0a\u66f8\u304d\u3057\u307e\u3059\u3002\nimport React from 'react';\nimport ReactDOM from 'react-dom';\nimport { Router, browserHistory } from 'react-router';\nimport routes from './routes';\nimport AppContext from './AppContext';\n\nReactDOM.render(\n  <Router history={browserHistory} render={(props) => <AppContext {...props}/>}>\n    {routes}\n  </Router>,\ndocument.getElementById('app'))\n\n\u7d9a\u3044\u3066AppContext/PropsContainer\u306e\u5b9f\u88c5\u3067\u3059\u3002\nimport React, { Component, PropTypes } from 'react';\nimport { RouterContext } from 'react-router/lib'\n\n// APP_PROPS\u306b\u683c\u7d0d\u3057\u305f\u30c7\u30fc\u30bf\u3092\u53d6\u5f97\u3057\u3066AppContext\u304c\u6271\u3048\u308b\u5f62\u306b\u3057\u3066\u8fd4\u3059\nfunction hydrate(props) {\n  if (typeof APP_PROPS !== 'undefined')\n    return {\n      propsArray: APP_PROPS,\n      componentsArray: props.components.filter(component => component.loadProps)\n    }\n  else\n    return null\n}\n\n// RouterContext\u306ecreateElement\u30d7\u30ed\u30d1\u30c6\u30a3\u306b\u3053\u306e\u95a2\u6570\u3092\u6307\u5b9a\u3057\u3066\u3001PropsContainer\u3092\u5dee\u3057\u8fbc\u3080\nfunction createElement(Component, props) {\n  if (Component.loadProps)\n    return <PropsContainer Component={Component} routerProps={props}/>\n  else\n    return <Component {...props}/>\n}\n\nexport default class AppContext extends Component {\n\n  static childContextTypes = {\n    asyncProps: PropTypes.object\n  };\n\n  static propTypes = {\n    components: PropTypes.array.isRequired,\n    params: PropTypes.object.isRequired,\n    location: PropTypes.object.isRequired,\n    // server rendering\n    propsArray: PropTypes.array,\n    componentsArray: PropTypes.array\n  };\n\n  constructor(props, context) {\n    super(props, context)\n    const { propsArray, componentsArray } = this.props\n    const isServerRender = propsArray && componentsArray\n    // \u30b5\u30fc\u30d0\u30fc\u30b5\u30a4\u30c9\u3060\u3068props\u3067\u6e21\u3055\u308c\u305f\u3082\u306e\u3092\u5229\u7528\u3057\u3001\u30d6\u30e9\u30a6\u30b6\u3067\u306fhydrate\u95a2\u6570\u3067APP_PROPS\u304b\u3089\u30c7\u30fc\u30bf\u3092\u53d6\u5f97\n    this.state = {\n      propsAndComponents: isServerRender ?\n        { propsArray, componentsArray } :\n        hydrate(props)\n    }\n  }\n\n  // \u7ba1\u7406\u3057\u3066\u3044\u308b\u30c7\u30fc\u30bf\u3092Context\u3092\u5229\u7528\u3057\u3066\u5b50\u306b\u6e21\u3059\n  getChildContext() {\n    const { propsAndComponents } = this.state\n    return {\n      asyncProps: { propsAndComponents }\n    };\n  }\n\n  render() {\n    // createElement\u30d7\u30ed\u30d1\u30c6\u30a3\u3092\u4e0a\u66f8\u304d\n    return <RouterContext {...this.props} createElement={createElement}/>\n  }\n}\n\n// \u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u5074\u306eComponent\u304c\u5fc5\u8981\u3068\u3059\u308b\u30c7\u30fc\u30bf\u3092\u5272\u308a\u51fa\u3059\nfunction lookupPropsForComponent(Component, propsAndComponents) {\n  const { componentsArray, propsArray } = propsAndComponents\n  var index = componentsArray.indexOf(Component)\n  return propsArray[index]\n}\n\nclass PropsContainer extends React.Component {\n\n  static propTypes = {\n    Component: PropTypes.func.isRequired,\n    routerProps: PropTypes.object.isRequired\n  };\n\n  static contextTypes = {\n    asyncProps: PropTypes.object.isRequired\n  };\n\n  render() {\n    const { Component, routerProps, ...props } = this.props\n    const { propsAndComponents } = this.context.asyncProps\n    const asyncProps = lookupPropsForComponent(Component, propsAndComponents)\n    return (\n      <Component\n        {...props}\n        {...routerProps}\n        {...asyncProps} />\n    )\n  }\n\n}\n\n1\u3064\u306e\u30d5\u30a1\u30a4\u30eb\u306bAppContext\u3068PropsContainer\u3092\u5b9a\u7fa9\u3057\u3066\u3044\u307e\u3059\u3002export\u3057\u3066\u3044\u308b\u306e\u306fAppContext\u306e\u307f\u3067\u3059\u3002\nAppContext\u306fconstructor\u3067\u30c7\u30fc\u30bf(loadProps\u306e\u5b9f\u884c\u7d50\u679c)\u3092\u6e21\u3055\u308c\u3001\u305d\u308c\u3092state\u306b\u30bb\u30c3\u30c8\u3057\u307e\u3059\u3002render\u3059\u308b\u306e\u306fRouterContext\u3067\u3059\u304c\u3001createElement\u30d7\u30ed\u30d1\u30c6\u30a3\u3092\u6307\u5b9a\u3057\u3066\u3044\u3066\u3001\u3053\u306e\u95a2\u6570\u306e\u4e2d\u3067PropsContainer\u3092\u5dee\u3057\u8fbc\u307f\u307e\u3059\u3002\u307e\u305fgetChildContext\u3092\u5b9a\u7fa9\u3057\u3066\u304a\u308a\u3001PropsContainer\u306b\u30c7\u30fc\u30bf\u3092\u6e21\u305b\u308b\u3088\u3046\u306b\u3057\u3066\u3044\u307e\u3059\u3002\u307e\u305f\u3001\u30b5\u30fc\u30d0\u30fc\u30b5\u30a4\u30c9\u3067\u30ed\u30fc\u30c9\u3057\u305f\u30c7\u30fc\u30bf\u306fAPP_PROPS\u3068\u3044\u3046\u5909\u6570\u306b\u683c\u7d0d\u3055\u308c\u3066\u304a\u308a\u3001\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u30b5\u30a4\u30c9\u3067\u306f\u305d\u308c\u3092hydrate\u95a2\u6570\u3067\u53d6\u5f97\u3057\u307e\u3059\u3002\nPropsContainer\u306fAppContext\u304c\u4fdd\u6301\u3059\u308b\u30c7\u30fc\u30bf\u304b\u3089\u306e\u4e2d\u304b\u3089\u3001lookupPropsForComponent\u95a2\u6570\u3067\u751f\u6210\u3059\u308bComponent\u306b\u5fc5\u8981\u306a\u3082\u306e\u3060\u3051\u3092\u62bd\u51fa\u3057\u3066\u6e21\u3059\u5f79\u5272\u3092\u62c5\u3063\u3066\u3044\u307e\u3059\u3002\n\u3053\u3053\u307e\u3067\u5b9f\u88c5\u3057\u3066curl\u3067\u30c6\u30b9\u30c8\u3059\u308b\u3068\u3001\n\n\"/\"\u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3068\u3001\"Hello hoge!\"\u3068\"server date 2016-01-27T13:35:16.891Z\"\u304c\u8868\u793a(\"hoge\"\u3068\"2016-01...\"\u304cfetch\u3057\u305f\u7d50\u679c)\n\"/items\"\u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3068\u4e0a\u8a18\u306b\u52a0\u3048\u3066\u3001item\u306e\u30ea\u30b9\u30c8\u304c\u8868\u793a\n\n\u3068\u306a\u308a\u307e\u3059\u3002\n\u305f\u3060\u3001\u3053\u306e\u6642\u70b9\u3067\u306f\u30d0\u30b0\u304c\u3042\u308a\u307e\u3059\u3002\nItems.jsx\u3068Users.jsx\u306b\u5b9a\u7fa9\u3057\u305fLink\u8981\u7d20\u3092\u30af\u30ea\u30c3\u30af\u3057\u3066\u9077\u79fb\u3059\u308b\u3068\u3001\u9077\u79fb\u5148\u306e\u753b\u9762\u306e\u30ea\u30b9\u30c8\u304c\u8868\u793a\u3055\u308c\u307e\u305b\u3093\u3002\n\u3053\u308c\u306f\u5b9a\u7fa9\u3057\u305floadProps\u304c\u30b5\u30fc\u30d0\u30fc\u30b5\u30a4\u30c9\u3067\u3057\u304b\u547c\u3070\u308c\u3066\u3044\u306a\u3044\u305f\u3081\u306b\u767a\u751f\u3057\u307e\u3059\u3002\u305d\u3053\u3067\u305d\u308c\u305e\u308c\u306eComponent\u306ecomponentWillMount\u95a2\u6570\u5185\u3067loadProps\u3092\u547c\u3076\u3088\u3046\u306b\u4fee\u6b63\u3057\u307e\u3059\u3002\nItems.jsx\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\nimport React, { Component, PropTypes } from 'react';\nimport { Link } from 'react-router';\nimport fetch from 'isomorphic-fetch';\n\nexport default class Items extends Component {\n\n  static loadProps(callback) {\n    fetch('http://localhost:3000/api/items')\n      .then(res => res.json())\n      .then(json => callback(null, {items: json}))\n      .catch(error => callback(error));\n  }\n\n  constructor(props, context) {\n    super(props, context);\n    this.state = {\n      items: props.items\n    };\n  }\n\n  componentWillMount() {\n    if (this.context.didMount) {\n      Items.loadProps((ignore, res) => {\n        this.setState({ items: res.items });\n      });\n    }\n  }\n\n  render() {\n    const { items = [] } = this.state;\n    return (\n      <div>\n        <h2>item list</h2>\n        <Link to='/users'>users\u3078</Link>\n        <ul>\n          {items.map(item => {\n            return (<li key={item.id}>{item.id}: {item.text}</li>);\n          })}\n        </ul>\n      </div>\n    );\n  }\n}\n\nItems.propTypes = {\n  items: PropTypes.array\n};\n\nItems.contextTypes = {\n  didMount: PropTypes.bool\n};\n\nItems.jsx\u3084Users.jsx\u306bcomponentWillMount\u3092\u5b9a\u7fa9\u3059\u308b\u306e\u306b\u5408\u308f\u305b\u3066\u3001\u5e7e\u3064\u304b\u4fee\u6b63\u3092\u3057\u3066\u3044\u307e\u3059\u3002\n\nprops\u306e\u60c5\u5831\u3092\u4e00\u65e6state\u306b\u683c\u7d0d\u3057\u305f\u4e0a\u3067\u3001\u8868\u793a\u306b\u5229\u7528\n\n\u3053\u308c\u306f\u3001componentWillMount\u3067\u30c7\u30fc\u30bf\u3092\u8aad\u307f\u8fbc\u3093\u3060\u969b\u306b\u3001\u7c21\u6613\u7684\u306b\u8868\u793a\u3092\u5207\u308a\u66ff\u3048\u3089\u308c\u308b\u3088\u3046\u306b\u3059\u308b\u305f\u3081\u306e\u5bfe\u5fdc\u3067\u3059\u3002\n\u4fee\u6b63\u524d\u306e\u307e\u307e\u3060\u3068\u3001state\u7ba1\u7406\u3057\u3066\u3044\u308b\u89aaComponent(\u4eca\u56de\u306e\u30b1\u30fc\u30b9\u3060\u3068\u4f8b\u3048\u3070AppContext\u306a\u3069)\u306b\u4e00\u65e6\u30ed\u30fc\u30c9\u3057\u305f\u30c7\u30fc\u30bf\u3092\u6e21\u3057\u305f\u4e0a\u3067\u3001\u518d\u5ea6props\u3092\u53d7\u3051\u53d6\u308b\u5fc5\u8981\u304c\u51fa\u3066\u304d\u3066\u3057\u307e\u3046\u305f\u3081\u3067\u3059\u3002\n\nAppContext\u3067componentDidMount\u304c\u547c\u3070\u308c\u305f\u969b\u306bdidMount\u3068\u3044\u3046state\u3092true\u306b\u30bb\u30c3\u30c8\ncontextTypes\u3067AppContext\u306edidMount\u3092\u53d7\u3051\u53d6\u308b\ndidMount\u304ctrue\u306e\u5834\u5408\u306e\u307fcomponentWillMount\u3067loadProps\u3092\u5b9f\u884c\n\n\u3053\u308c\u3089\u306f\u3001\u30b5\u30fc\u30d0\u30fc\u30b5\u30a4\u30c9\u3001\u3082\u3057\u304f\u306f\u30b5\u30fc\u30d0\u30fc\u30b5\u30a4\u30c9\u30ec\u30f3\u30c0\u30ea\u30f3\u30b0\u304c\u5b9f\u65bd\u3055\u308c\u305fhtml\u3092\u8aad\u307f\u8fbc\u3093\u3060\u76f4\u5f8c\u306b\u3001loadProps\u304c\u5b9f\u884c\u3055\u308c\u306a\u3044\u3088\u3046\u306b\u3059\u308b\u305f\u3081\u306e\u5bfe\u5fdc\u3067\u3059\u3002\u3053\u306edidMount\u306fAppContext\u306ecomponentDidMount\u304c\u5b9f\u884c\u3055\u308c\u305f\u30bf\u30a4\u30df\u30f3\u30b0\u3067true\u306b\u306a\u308b\u3088\u3046\u306b\u5b9f\u88c5\u3057\u3066\u3044\u308b\u305f\u3081\u3001\u30b5\u30fc\u30d0\u30fc\u30b5\u30a4\u30c9\u3067\u306ftrue\u306b\u306f\u306a\u308a\u307e\u305b\u3093\u3002\u307e\u305f\u30d6\u30e9\u30a6\u30b6\u3067js\u304c\u30ed\u30fc\u30c9\u3055\u308c\u305f\u76f4\u5f8c\u306e\u30bf\u30a4\u30df\u30f3\u30b0\u3067\u3082\u540c\u69d8\u306btrue\u3067\u306f\u3042\u308a\u307e\u305b\u3093\u3002\u305d\u306e\u305f\u3081\u91cd\u8907\u3057\u3066\u30c7\u30fc\u30bf\u306efetch\u304c\u5b9f\u884c\u3055\u308c\u308b\u3053\u3068\u3092\u9632\u3050\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\n\u3053\u3053\u307e\u3067\u306e\u307e\u3068\u3081\n\u3053\u306e\u3088\u3046\u306b\u3001React Router\u3068\u30b5\u30fc\u30d0\u30fc\u30b5\u30a4\u30c9\u30ec\u30f3\u30c0\u30ea\u30f3\u30b0\u3092\u7d44\u307f\u5408\u308f\u305b\u308b\u3053\u3068\u306f\u3067\u304d\u307e\u3059\u304c\u3001\u30c7\u30fc\u30bf\u306e\u7ba1\u7406\u304c\u7169\u96d1\u306b\u306a\u308a\u307e\u3059\u3002async-props\u306f\u4e0a\u3067\u8aac\u660e\u3057\u305f\u5b9f\u88c5\u3092\u96a0\u853d\u3057\u3066\u3001\u4f7f\u3046\u5074\u304c\u3042\u307e\u308a\u610f\u8b58\u3059\u308b\u5fc5\u8981\u304c\u306a\u3044\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u304c\u3001\u6b63\u76f4\u306a\u611f\u60f3\u3068\u3057\u3066\u306f\u305d\u3053\u307e\u3067\u3084\u308b\u306e\u3060\u3063\u305f\u3089\u7d20\u76f4\u306bFlux\u3092\u5c0e\u5165\u3057\u305f\u65b9\u304c\u826f\u3055\u305d\u3046\u3067\u3059\u3002\n\nReact + React Router + Redux\n\u6700\u5f8c\u306bRedux\u3092\u7d44\u307f\u5408\u308f\u305b\u305f\u5834\u5408\u3067\u3059\u3002\n\n\u53c2\u8003\u306b\u3057\u305f\u30bd\u30fc\u30b9\n\nreact-redux-universal-hot-example\nredux\u306eServer Rendering\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\n\n\n\u975e\u540c\u671f\u3067\u53d6\u5f97\u3057\u305f\u30c7\u30fc\u30bf\u3092\u7528\u3044\u3066\u30ec\u30f3\u30c0\u30ea\u30f3\u30b0\u3059\u308b\u30d1\u30bf\u30fc\u30f3\n\u30c7\u30fc\u30bf\u3092fetch\u3057\u3066\u8868\u793a\u3059\u308b\u30d1\u30bf\u30fc\u30f3\u306e\u307f\u8aac\u660e\u3057\u307e\u3059\u3002\nRedux\u3092\u4f7f\u3046\u3068\u30c7\u30fc\u30bf\u306e\u7ba1\u7406\u306fstore\u306b\u4efb\u305b\u308b\u3053\u3068\u304c\u3067\u304d\u308b\u306e\u3067\u3001\u81ea\u524d\u306eComponent\u304c\u4e0d\u8981\u306b\u306a\u308a\u307e\u3059(\u4e0a\u306e\u4f8b\u3067\u306eAppContext/PropsContainer)\u3002\u521d\u671f\u8868\u793a\u7528\u306e\u30c7\u30fc\u30bf\u3092\u53d6\u5f97\u3059\u308b\u51e6\u7406\u306b\u95a2\u3057\u3066\u306f\u3001React + React Router\u306e\u30d1\u30bf\u30fc\u30f3\u3068\u540c\u69d8\u306b\u5404Component\u306bstatic\u306a\u95a2\u6570\u3068\u3057\u3066\u5b9a\u7fa9\u3059\u308b\u3053\u3068\u306b\u306a\u308a\u307e\u3059\u3002\nApp.jsx\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u5909\u66f4\u3057\u307e\u3059\u3002\nimport React, { Component, PropTypes } from 'react';\nimport { connect } from 'react-redux';\nimport { loadMe, didMount } from './actions';\n\nclass App extends Component {\n\n  // \u30c7\u30fc\u30bf\u53d6\u5f97\u95a2\u6570\n  static fetchData() {\n    return loadMe();\n  }\n\n  static propTypes = {\n    children: PropTypes.object\n  };\n\n  componentWillMount() {\n    const { dispatch } = this.props;\n    if (this.props.didMount) {\n      dispatch(loadMe());\n    }\n  }\n\n  // \u4e0a\u3067\u3082\u5229\u7528\u3057\u3066\u3044\u308bthis.props.didMount\u3092true\u3068\u3059\u308b\u305f\u3081\u306b\u30a2\u30af\u30b7\u30e7\u30f3\u3092dispatch\n  componentDidMount() {\n    const { dispatch } = this.props;\n    dispatch(didMount());\n  }\n\n  render() {\n    const { me } = this.props;\n    return (\n      <div>\n        <h1>Hello {me.name}!</h1>\n        <p>server date {me.date}!</p>\n        {this.props.children}\n      </div>\n    );\n  }\n}\n\nfunction mapStateToProps(state) {\n  return {\n    didMount: state.app.didMount,\n    me: state.app.me\n  };\n}\n\nexport default connect(\n  mapStateToProps\n)(App);\n\n\u3053\u308c\u307e\u3067\u306e\u4f8b\u3068\u7570\u306a\u308b\u70b9\u306f\u3001componentDidMount\u3067DID_MOUNT\u30a2\u30af\u30b7\u30e7\u30f3\u3092dispatch\u3057\u3066\u3044\u308b\u70b9\u3068\u3001redux\u306estore\u306bconnect\u3057\u3066\u3044\u308b\u3053\u3068\u3067\u3059\u3002reducer\u3067\u306fDID_MOUNT\u30a2\u30af\u30b7\u30e7\u30f3\u306b\u3088\u3063\u3066\u3001state.app.didMount\u30d5\u30e9\u30b0\u3092true\u306b\u66f4\u65b0\u3057\u307e\u3059\u3002\nimport { DID_MOUNT, LOADED_ME } from 'actions';\n\nexport default function app(state = {\n  didMount: false,\n  me: {}\n}, action) {\n  switch (action.type) {\n    case DID_MOUNT:\n      return Object.assign({}, state,\n        { didMount: true }\n      );\n    case LOADED_ME:\n      const { me } = action;\n      return Object.assign({}, state,\n        { me }\n      );\n    default:\n      return state;\n  }\n}\n\n\u3053\u306edidMount\u30d5\u30e9\u30b0\u306b\u3088\u3063\u3066\u30011\u3064\u524d\u306e\u30d1\u30bf\u30fc\u30f3\u3067\u8aac\u660e\u3057\u305f\u306e\u3068\u540c\u69d8\u306b\u5404Component\u306b\u304a\u3044\u3066componentWillMount\u3067\u30c7\u30fc\u30bf\u3092\u30ed\u30fc\u30c9\u3059\u308b\u304b\u3092\u5236\u5fa1\u3059\u308b\u3088\u3046\u306b\u3057\u307e\u3059\u3002\nApp.jsx\u306e\u8aac\u660e\u306b\u623b\u308a\u307e\u3059\u304c\u3001\u30c7\u30fc\u30bf\u53d6\u5f97\u306e\u305f\u3081\u306estatic\u306a\u95a2\u6570\u3067\u3042\u308bfetchData\u3067\u306f\u3001\u5225\u306e\u30d5\u30a1\u30a4\u30eb\u306b\u5b9a\u7fa9\u3055\u308c\u305floadMe\u3068\u3044\u3046action creator\u3092\u547c\u3073\u51fa\u3057\u3066\u8fd4\u3057\u3066\u3044\u307e\u3059\u3002loadMe\u95a2\u6570\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u5185\u5bb9\u3067\u3059\u3002\nexport function loadMe() {\n  return dispatch => {\n    // \u30b5\u30f3\u30d7\u30eb\u306e\u305f\u3081\u6c7a\u3081\u6253\u3061\u306eurl\n    return fetch('http://localhost:3000/api/me')\n      .then(res => {\n        if (res.status >= 400) {\n            throw new Error('Bad response from server');\n        }\n        return res.json();\n      }).then(data => {\n        return dispatch({\n          type: LOADED_ME,\n          me: data\n        });\n      });\n  };\n}\n\nfetch\u3057\u305f\u30c7\u30fc\u30bf\u3092action\u306b\u8a70\u3081\u3066dispatch\u3057\u307e\u3059\u3002\u3053\u306eaction\u306freducer\u3067\u88dc\u8db3\u3055\u308c\u30c7\u30fc\u30bf\u306fstore\u306b\u683c\u7d0d\u3055\u308c\u307e\u3059\u3002\nItems.jsx/Users.jsx\u306b\u3064\u3044\u3066\u306f\u3001componentDidMount\u306f\u5b9f\u88c5\u3092\u9664\u3044\u305f\u307b\u307c\u540c\u3058\u3088\u3046\u306a\u30b3\u30fc\u30c9\u3068\u306a\u308a\u307e\u3059\u3002\n\u7d9a\u3044\u3066server.jsx\u306erender\u95a2\u6570\u3092\u4fee\u6b63\u3057\u307e\u3059\u3002\nimport { Provider } from 'react-redux';\nimport configureStore from './configureStore';\n...\nexport default function render(req, res) {\n  match({ routes, location: req.url }, (error, redirectLocation, renderProps) => {\n    if (error) {\n      res.status(500).send(error.message)\n    } else if (redirectLocation) {\n      res.redirect(302, redirectLocation.pathname + redirectLocation.search)\n    } else if (renderProps) {\n      const store = configureStore({});\n      const components = renderProps.components.filter(component => component.fetchData);\n      Promise.all(components.map(component => store.dispatch(component.fetchData())))\n        .then(() => {\n          const renderedContent = renderToString(\n            <Provider store={store}>\n              <RouterContext {...renderProps} />\n            </Provider>\n          );\n          const renderedPage = renderFullPage(renderedContent, store.getState());\n          res.status(200).send(renderedPage);\n        }).catch(error => {\n          res.status(500).send(error.message);\n        });\n    } else {\n      res.status(404).send('Not found')\n    }\n  })\n};\n\n\nRedux\u306estore\u3092\u751f\u6210\u3057\u305f\u4e0a\u3067Component\u306b\u5b9a\u7fa9\u3055\u308c\u305ffetchData\u3092dispatch\u3057\u3066\u3001\u3059\u3079\u3066\u306efetch\u304c\u5b8c\u4e86\u3057\u305f\u6642\u70b9\u3067Redux\u306eProvider Component\u3092\u751f\u6210\u3057\u3066\u3044\u307e\u3059\u3002dispatch\u306fstore\u306b\u5b9a\u7fa9\u3055\u308c\u305f\u95a2\u6570\u3067\u3001\u3053\u306e\u3088\u3046\u306bfetchData\u3092\u547c\u3073\u3053\u3068\u3067\u305d\u306e\u7d50\u679c\u304cstore\u306b\u683c\u7d0d\u3055\u308c\u308b\u3053\u3068\u306b\u306a\u308a\u307e\u3059\u3002\u307e\u305f\u3001fetch\u3057\u305f\u30c7\u30fc\u30bf\u3092store.getState()\u3067\u53d6\u5f97\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u308b\u306e\u3067renderFullPage\u306b\u6e21\u3057\u3066\u3044\u307e\u3059\u3002renderFullPage\u3067\u306f\u3053\u306e\u30c7\u30fc\u30bf\u3092APP_STATE\u5909\u6570\u306b\u683c\u7d0d\u3057\u307e\u3059\u3002\nclient.jsx\u3082\u4fee\u6b63\u3057\u307e\u3059\u3002\nimport React from 'react';\nimport ReactDOM from 'react-dom';\nimport { Provider } from 'react-redux';\nimport { Router, browserHistory } from 'react-router'\nimport configureStore from './configureStore';\nimport routes from './routes'\n\nconst store = configureStore(window.APP_STATE);\n\nReactDOM.render(\n  <Provider store={store}>\n    <Router history={browserHistory}>\n      {routes}\n    </Router>\n  </Provider>,\ndocument.getElementById('app'))\n\nAPP_STATE\u5909\u6570\u306b\u683c\u7d0d\u3055\u308c\u305f\u30c7\u30fc\u30bf\u3092\u30d6\u30e9\u30a6\u30b6\u5074\u3067\u306estore\u521d\u671f\u5316\u306b\u5229\u7528\u3057\u307e\u3059\u3002\n\u4ed6\u306b\u3082items, users\u306e\u305f\u3081\u306eaction\u3084reducer\u306e\u5b9a\u7fa9\u304c\u5fc5\u8981\u3067\u3059\u304c\u7701\u7565\u3057\u307e\u3059\u3002curl\u3068\u30d6\u30e9\u30a6\u30b6\u3067\u30c6\u30b9\u30c8\u3059\u308b\u3068\u3001\u521d\u671f\u8868\u793a\u3068Link\u8981\u7d20\u306b\u3088\u308b\u753b\u9762\u9077\u79fb\u304c\u6b63\u3057\u304f\u52d5\u4f5c\u3059\u308b\u3053\u3068\u304c\u78ba\u8a8d\u3067\u304d\u307e\u3059\u3002\n\n\u307e\u3068\u3081\n\u8aac\u660e\u306b\u7528\u3044\u305f\u30b5\u30f3\u30d7\u30eb\u30b3\u30fc\u30c9\u306fgithub\u306b\u4e0a\u3052\u3066\u3042\u308a\u307e\u3059\u3002\nReact\u306e\u52c9\u5f37\u304c\u3066\u3089\u306b\u307e\u3068\u3081\u3066\u307f\u307e\u3057\u305f\u304c\u3001\u81ea\u5206\u3068\u3057\u3066\u3082\u3057\u3063\u304f\u308a\u304d\u3066\u3044\u306a\u3044\u90e8\u5206\u3082\u3042\u308b\u306e\u3067(\u7279\u306bcomponentWillMount\u3067\u306edidMount\u306b\u3088\u308b\u5236\u5fa1)\u3001\u4ed6\u306b\u826f\u3044\u3084\u308a\u65b9\u304c\u3042\u308a\u307e\u3057\u305f\u3089\u3001\u6559\u3048\u3066\u3082\u3089\u3048\u308b\u3068\u3042\u308a\u304c\u305f\u3044\u3067\u3059\u3002\nReact\u3092\u89e6\u308a\u59cb\u3081\u305f\u5f53\u521d\u306fnode\u30b5\u30fc\u30d0\u30fc\u4f7f\u3048\u3070\u30b5\u30af\u30c3\u3068\u30b5\u30fc\u30d0\u30fc\u30b5\u30a4\u30c9\u30ec\u30f3\u30c0\u30ea\u30f3\u30b0\u3067\u304d\u308b\u3082\u306e\u3068\u3070\u304b\u308a\u601d\u3063\u3066\u3044\u305f\u3093\u3067\u3059\u304c\u3001\u30b5\u30fc\u30d0\u30fc\u30b5\u30a4\u30c9\u3067\u3069\u3053\u307e\u3067\u30c7\u30fc\u30bf\u3092\u7528\u610f\u3059\u308b\u304b\u3068\u3044\u3046\u70b9\u3092\u3057\u3063\u304b\u308a\u8003\u3048\u51fa\u3059\u3068\u3001\u7d50\u69cb\u96e3\u3057\u3044\u554f\u984c\u306b\u306a\u308a\u307e\u3059\u3002\n\u53c2\u8003\u306b\u3057\u305f\u30bd\u30fc\u30b9\u3067\u306fstatic\u306b\u5b9a\u7fa9\u3057\u305f\u30c7\u30fc\u30bf\u53d6\u5f97\u95a2\u6570\u3092\u30b5\u30fc\u30d0\u30fc/\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u30b5\u30a4\u30c9\u3067\u4f7f\u3044\u56de\u3059\u524d\u63d0\u3068\u306a\u3063\u3066\u3044\u308b\u3082\u306e\u304c\u591a\u304b\u3063\u305f\u306e\u3067\u3059\u304c\u3001\u3042\u308b\u7a0b\u5ea6\u306e\u8907\u96d1\u3055\u304c\u3042\u308b\u30b5\u30fc\u30d3\u30b9\u3067\u306f\u3042\u307e\u308a\u73fe\u5b9f\u7684\u3067\u306f\u306a\u3044\u6c17\u3082\u3057\u307e\u3059\u3002\n[React](https://facebook.github.io/react/)\u306e\u30b5\u30fc\u30d0\u30fc\u30b5\u30a4\u30c9\u30ec\u30f3\u30c0\u30ea\u30f3\u30b0(SSR)\u306e\u5b9f\u88c5\u65b9\u6cd5\u306b\u3064\u3044\u3066\u3001React\u5358\u4f53\u306e\u30b7\u30f3\u30d7\u30eb\u306a\u3082\u306e\u304b\u3089\u3001[React Router](https://github.com/rackt/react-router), [Redux](https://github.com/rackt/redux)\u3092\u7d44\u307f\u5408\u308f\u305b\u305f\u3082\u306e\u307e\u3067\u307e\u3068\u3081\u307e\u3059\u3002\n\u30b5\u30fc\u30d0\u30fc\u30b5\u30a4\u30c9\u306f[Express](http://expressjs.com/)\u3092\u7528\u3044\u307e\u3059\u3002\n\n\u203b\u4ee5\u4e0b\u306eJavaScript\u306e\u30b3\u30fc\u30c9\u306b\u3064\u3044\u3066\u3001\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u30b5\u30a4\u30c9\u306b\u3064\u3044\u3066\u306e\u307f[JSX](https://facebook.github.io/jsx/) + [ES6](https://babeljs.io/docs/learn-es2015/)\u5f62\u5f0f\u3067\u30b3\u30fc\u30c7\u30a3\u30f3\u30b0\u3057\u3066\u304a\u308a\u3001webpack\u3067compile\u3057\u3066\u5229\u7528\u3057\u3066\u3044\u307e\u3059\n\n# React\u5358\u4f53\u3067SSR\n\nReact\u5358\u4f53\u3067SSR\u3092\u5b9f\u73fe\u3059\u308b\u5834\u5408\u306f\u3001[ReactDOMServer.renderToString](https://facebook.github.io/react/docs/top-level-api.html#reactdomserver.rendertostring)\u3092\u4f7f\u7528\u3057\u307e\u3059\u3002\n\n## \u53c2\u8003\u306b\u3057\u305f\u30bd\u30fc\u30b9\n\nReact\u5358\u4f53\u306eSSR\u3092\u5b9f\u88c5\u3059\u308b\u306b\u3042\u305f\u3063\u3066\u306f\u4ee5\u4e0b\u306e\u30bd\u30fc\u30b9\u3092\u53c2\u8003\u306b\u3057\u307e\u3057\u305f\u3002\n\n- [react-server-example](https://github.com/mhart/react-server-example)\n    - APP_PROPS\u3092\u5229\u7528\u3057\u3066fetch\u3057\u305f\u30c7\u30fc\u30bf\u3092\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u5074\u306ejs\u3068\u5171\u6709\u3059\u308b\u70b9\u3092\u53c2\u8003\u306b\u3057\u307e\u3057\u305f\n\n## \u9759\u7684\u306a\u60c5\u5831\u3092\u30ec\u30f3\u30c0\u30ea\u30f3\u30b0\u3059\u308b\u30d1\u30bf\u30fc\u30f3\n\n\u3053\u306e\u30d1\u30bf\u30fc\u30f3\u306e\u307f\u3067\u30b5\u30fc\u30d3\u30b9\u304c\u5b8c\u7d50\u3059\u308b\u3053\u3068\u306f\u306a\u3044\u3068\u601d\u3044\u307e\u3059\u304c\u3001SSR\u306e\u7b2c\u4e00\u6b69\u76ee\u3068\u3057\u3066\u898b\u3066\u3044\u304d\u307e\u3059\u3002\n\n\u307e\u305a\u306f\u3001\u30b7\u30f3\u30d7\u30eb\u306aReactComponent\u3092\u7528\u610f\u3057\u307e\u3059\u3002\n\n```js\nimport React, { Component } from 'react';\n\nexport default class App extends Component {\n  render() {\n    return (\n      <div>\n        Hello SSR!\n      </div>\n    );\n  }\n}\n```\n\ncurl\u306a\u3069\u3067\u30a2\u30af\u30bb\u30b9\u3057\u305f\u969b\u306b\"Hello SSR!\"\u304c\u8868\u793a\u3055\u308c\u308c\u3070SSR\u306b\u6210\u529f\u3057\u305f\u3053\u3068\u306b\u306a\u308a\u307e\u3059\u3002\n\nExpress\u30b5\u30fc\u30d0\u30fc\u5074\u306e\u30bd\u30fc\u30b9\u306f\u4ee5\u4e0b\u3067\u3059\u3002\n\n```js\nvar express = require('express');\nvar app = express();\nvar path = require('path');\nvar React = require('../public/assets/app.server');\n\napp.use(express.static(path.join(__dirname, '..', 'public')));\n\n// for server side logic\napp.get('api/items', function (req, res, next) {\n  res.json([\n    {id: 1, text: 'first'},\n    {id: 2, text: 'second'},\n    {id: 3, text: 'third'}\n  ]);\n});\n\n// for server side rendering\napp.get('*', function (req, res, next) {\n  React(req, res);\n});\n\napp.listen(3000, function () {\n  console.log('Example app listening on port 3000!');\n});\n```\n\n\u30c7\u30fc\u30bf\u3092\u8fd4\u3059api\u306e\u30eb\u30fc\u30c8\u30921\u3064\u5b9a\u7fa9\u3057\u3064\u3064\u3001\u305d\u308c\u4ee5\u5916\u306e\u5834\u5408\u306fReact\u5074\u306b\u51e6\u7406\u3092\u59d4\u8b72\u3057\u307e\u3059(\u6700\u521d\u306f\u3053\u306e\"/api/items\"\u306f\u4f7f\u3044\u307e\u305b\u3093)\u3002\u59d4\u8b72\u5148\u306e/assets/app.server\u3068\u3044\u3046\u30e2\u30b8\u30e5\u30fc\u30eb\u306fSSR\u7528\u306eserver.jsx\u3092compile\u3057\u305f\u3082\u306e\u3067\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u5b9f\u88c5\u3057\u3066\u3044\u307e\u3059\u3002\n\n```js\nimport React from 'react';\nimport { renderToString } from 'react-dom/server';\nimport App from 'App';\n\nfunction renderFullPage(renderedContent) {\n  return `\n  <!DOCTYPE html>\n    <html>\n\n    <head>\n        <meta charset=\"utf-8\">\n        <title>React Server Rendering sample</title>\n    </head>\n\n    <div id=\"app\">${renderedContent}</div>\n\n    <script type=\"text/javascript\" charset=\"utf-8\" src=\"/assets/app.js\"></script>\n    </body>\n    </html>\n\n  `;\n}\n\nexport default function render(req, res) {\n  const renderedContent = renderToString(<App />);\n  const renderedPage = renderFullPage(renderedContent);\n  res.status(200).send(renderedPage);\n};\n```\n\n\u3053\u3053\u3067[ReactDOMServer.renderToString](https://facebook.github.io/react/docs/top-level-api.html#reactdomserver.rendertostring)\u3092\u5229\u7528\u3057\u3066\u30b5\u30fc\u30d0\u30fc\u30b5\u30a4\u30c9\u3067dom\u30c4\u30ea\u30fc\u3092\u751f\u6210\u3057\u3066\u3001html\u306b\u57cb\u3081\u8fbc\u3093\u3067\u8fd4\u3057\u307e\u3059\u3002\n\n\u307e\u305f\u3001\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u3067\u8aad\u307f\u8fbc\u3080client.jsx(/assets/app.js\u3068\u3057\u3066compile\u3055\u308c\u307e\u3059)\u3092\u7528\u610f\u3057\u307e\u3059\u3002\n\n```js\nimport React from 'react';\nimport ReactDOM from 'react-dom';\nimport App from 'App';\n\nReactDOM.render(<App />, document.getElementById('app'))\n\n```\n\n\u3053\u3053\u307e\u3067\u7528\u610f\u3057\u3066\u30b5\u30fc\u30d0\u30fc\u3092\u8d77\u52d5\u3057\u3066curl\u30b3\u30de\u30f3\u30c9\u3092\u53e9\u3044\u3066\u307f\u308b\u3068\u3001\n\n```html\n<!DOCTYPE html>\n<html>\n\n<head>\n    <meta charset=\"utf-8\">\n    <title>React Server Rendering sample</title>\n</head>\n\n<div id=\"app\"><div data-reactid=\".1c4y3s5msqo\" data-react-checksum=\"-1658580955\">Hello SSR!</div></div>\n\n<script type=\"text/javascript\" charset=\"utf-8\" src=\"/assets/app.js\"></script>\n</body>\n</html>\n```\n\n\u3061\u3083\u3093\u3068\"Hello SSR!\"\u304c\u8868\u793a\u3055\u308c\u308b\u3053\u3068\u304c\u78ba\u8a8d\u3067\u304d\u307e\u3059\u3002\n\n## \u975e\u540c\u671f\u3067\u53d6\u5f97\u3057\u305f\u30c7\u30fc\u30bf\u3092\u7528\u3044\u3066\u30ec\u30f3\u30c0\u30ea\u30f3\u30b0\u3059\u308b\u30d1\u30bf\u30fc\u30f3\n\n\u7d9a\u3044\u3066\u3001\u8868\u793a\u3059\u308b\u30c7\u30fc\u30bf\u3092\u30b5\u30fc\u30d0\u30fc\u30b5\u30a4\u30c9\u3067fetch\u3059\u308b\u5834\u5408\u306b\u3064\u3044\u3066\u8a18\u8f09\u3057\u307e\u3059\u3002\u3053\u306e\u30d1\u30bf\u30fc\u30f3\u3067\u91cd\u8981\u306a\u306e\u304c\u3001fetch\u3057\u305f\u7d50\u679c\u3092\u30d6\u30e9\u30a6\u30b6\u5074\u306b\u3082\u5171\u6709\u3059\u308b\u3053\u3068\u3067\u3059\u3002\u305d\u3046\u3057\u306a\u3044\u3068\u30d6\u30e9\u30a6\u30b6\u5074\u3067js\u304cload\u3055\u308c\u305f\u969b\u306b\u518d\u5ea6fetch\u3092\u8d70\u3089\u305b\u308b\u5fc5\u8981\u304c\u51fa\u3066\u304d\u3066\u3057\u307e\u3044\u307e\u3059\u3002\n\nserver.jsx\u306erender\u95a2\u6570\u3092\n\n```js\nexport default function render(req, res) {\n  fetch('http://localhost:3000/api/items')\n    .then(apiResult => apiResult.json())\n    .then(items => {\n      const initialProps = { items };\n      const renderedContent = renderToString(<App {...initialProps} />);\n      const renderedPage = renderFullPage(renderedContent, initialProps);\n      res.status(200).send(renderedPage);\n    }).catch(error => {\n      res.status(500).send(error.message);\n    });\n};\n\n```\n\n\u3068\u3057\u3066\u3001\u30c7\u30fc\u30bf\u3092fetch\u3092\u3057\u305f\u4e0a\u3067response\u3092\u8fd4\u3059\u3088\u3046\u306b\u5909\u66f4\u3057\u307e\u3059\u3002\u307e\u305f\u3001\u540c\u3058\u304fserver.jsx\u306erenderFullPage\u95a2\u6570\u3092\u4fee\u6b63\u3057\u3066\u3001\u30b5\u30fc\u30d0\u30fc\u30b5\u30a4\u30c9\u3067fetch\u3057\u305f\u7d50\u679c\u3092```APP_PROPS```\u3068\u3057\u3066\u4e00\u65e6script\u30bf\u30b0\u5185\u3067global\u5909\u6570\u306b\u683c\u7d0d\u3057\u307e\u3059\u3002\n\n```js\nfunction renderFullPage(renderedContent, initialProps) {\n  const appProps = safeStringify(initialProps);\n  return `\n  <!DOCTYPE html>\n    <html>\n\n    <head>\n        <meta charset=\"utf-8\">\n        <title>React Server Rendering sample</title>\n    </head>\n\n    <div id=\"app\">${renderedContent}</div>\n\n    <script>\n      var APP_PROPS = ${appProps};\n    </script>\n    <script type=\"text/javascript\" charset=\"utf-8\" src=\"/assets/app.js\"></script>\n    </body>\n    </html>\n\n  `;\n}\n```\n\n\u306a\u305cAPP_PROPS\u306b\u30c7\u30fc\u30bf\u3092\u683c\u7d0d\u3057\u3066\u3044\u308b\u304b\u3068\u3044\u3046\u3068\u3001client.jsx\u3067\u5229\u7528\u3059\u308b\u305f\u3081\u3067\u3059\u3002\n\n```js\nimport React from 'react';\nimport ReactDOM from 'react-dom';\nimport App from 'App';\n\nconst props = window.APP_PROPS;\nReactDOM.render(<App { ...props } />, document.getElementById('app'))\n```\n\n\u3053\u306e\u3088\u3046\u306bAPP_PROPS\u3092\u4ecb\u3057\u3066\u3001\u30b5\u30fc\u30d0\u30fc\u30b5\u30a4\u30c9\u3067fetch\u3057\u305f\u7d50\u679c\u3092\u30d6\u30e9\u30a6\u30b6\u5074\u306b\u5171\u6709\u3057\u307e\u3059\u3002\n\n\u307e\u305f\u3001\u305b\u3063\u304b\u304f\u306a\u306e\u3067App.jsx\u3067fetch\u3057\u305fprops\u3092\u8868\u793a\u3059\u308b\u3088\u3046\u306b\u4fee\u6b63\u3057\u307e\u3059\u3002\n\n```js\nimport React, { Component, PropTypes } from 'react';\n\nexport default class App extends Component {\n  render() {\n    const { items = [] } = this.props;\n    return (\n      <div>\n        <h1>Hello SSR!</h1>\n        <ul>\n          {items.map(item => {\n            return (<li key={item.id}>{item.id}: {item.text}</li>);\n          })}\n        </ul>\n      </div>\n    );\n  }\n}\n\nApp.propTypes = {\n  items: PropTypes.array\n};\n```\n\ncurl\u3092\u53e9\u304f\u3068\u4ee5\u4e0b\u306ehtml\u304c\u8fd4\u3063\u3066\u304d\u307e\u3059\u3002\n\n```html\n<!DOCTYPE html>\n<html>\n\n<head>\n    <meta charset=\"utf-8\">\n    <title>React Server Rendering sample</title>\n</head>\n\n<div id=\"app\">\n    <div data-reactid=\".12o64evkrnk\" data-react-checksum=\"401071875\">\n        <h1 data-reactid=\".12o64evkrnk.0\">Hello SSR!</h1>\n        <ul data-reactid=\".12o64evkrnk.1\">\n            <li data-reactid=\".12o64evkrnk.1.$1\"><span data-reactid=\".12o64evkrnk.1.$1.0\">1</span><span data-reactid=\".12o64evkrnk.1.$1.1\">: </span><span data-reactid=\".12o64evkrnk.1.$1.2\">first</span></li>\n            <li data-reactid=\".12o64evkrnk.1.$2\"><span data-reactid=\".12o64evkrnk.1.$2.0\">2</span><span data-reactid=\".12o64evkrnk.1.$2.1\">: </span><span data-reactid=\".12o64evkrnk.1.$2.2\">second</span></li>\n            <li data-reactid=\".12o64evkrnk.1.$3\"><span data-reactid=\".12o64evkrnk.1.$3.0\">3</span><span data-reactid=\".12o64evkrnk.1.$3.1\">: </span><span data-reactid=\".12o64evkrnk.1.$3.2\">third</span></li>\n        </ul>\n    </div>\n</div>\n\n<script>\n  var APP_PROPS = {\"items\":[{\"id\":1,\"text\":\"first\"},{\"id\":2,\"text\":\"second\"},{\"id\":3,\"text\":\"third\"}]};\n</script>\n<script type=\"text/javascript\" charset=\"utf-8\" src=\"/assets/app.js\"></script>\n</body>\n</html>\n```\n\nfetch\u3057\u305fitems\u306e\u30c7\u30fc\u30bf\u304c\u30ea\u30b9\u30c8\u5f62\u5f0f\u3067\u8868\u793a\u3055\u308c\u3066\u3044\u307e\u3059\u3002\u307e\u305f\u3001script\u30bf\u30b0\u3067fetch\u3057\u305f\u30c7\u30fc\u30bf\u3092APP_PROPS\u306b\u683c\u7d0d\u3057\u3066\u3044\u308b\u3053\u3068\u3082\u78ba\u8a8d\u3067\u304d\u307e\u3059\u3002\n\n# React + React Router\u3067SSR\n\n\u7d9a\u3044\u3066React Router\u3092\u5229\u7528\u3057\u305f\u5834\u5408\u306b\u3064\u3044\u3066\u307e\u3068\u3081\u307e\u3059\u3002\u30a2\u30af\u30bb\u30b9\u3055\u308c\u305furl\u306b\u5bfe\u3059\u308bReact Component\u306e\u5272\u308a\u51fa\u3057\u3092\u30b5\u30fc\u30d0\u30fc\u30b5\u30a4\u30c9\u3067\u5b9f\u65bd\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u304c\u3001React Router\u3067\u30b5\u30dd\u30fc\u30c8\u3055\u308c\u3066\u3044\u308b\u306e\u3067\u7279\u306b\u554f\u984c\u306f\u3042\u308a\u307e\u305b\u3093\u3002\n\n## \u53c2\u8003\u306b\u3057\u305f\u30bd\u30fc\u30b9\n\n- [React Router\u306eServer Rendering\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8](https://github.com/rackt/react-router/blob/latest/docs/guides/advanced/ServerRendering.md)\n- [react-server-routing-example](https://github.com/mhart/react-server-routing-example)\n- [async-props](https://github.com/rackt/async-props)\n    - \u975e\u540c\u671f\u3067\u53d6\u5f97\u3057\u305f\u30c7\u30fc\u30bf\u3092props\u3068\u3057\u3066\u30bb\u30c3\u30c8\u3057\u3066\u304f\u308c\u308bReact Router\u7528\u306e\u62e1\u5f35\u30e2\u30b8\u30e5\u30fc\u30eb\n\n## \u9759\u7684\u306a\u60c5\u5831\u3092\u30ec\u30f3\u30c0\u30ea\u30f3\u30b0\u3059\u308b\u30d1\u30bf\u30fc\u30f3\n\n\u307e\u305a\u306f\u30c7\u30fc\u30bf\u3092fetch\u305b\u305a\u3001\u5358\u7d14\u306burl\u306b\u5bfe\u5fdc\u3059\u308bReact Component\u3092\u8868\u793a\u3057\u307e\u3059\u3002\n\n\u8907\u6570\u306eroute\u3092\u7528\u610f\u3059\u308b\u305f\u3081\u306b\u3001App.jsx\u306b\u52a0\u3048\u3066Items.jsx, Users.jsx\u3068\u3044\u3046Component\u3092\u8ffd\u52a0\u3057\u307e\u3059\u3002\u4ee5\u4e0b\u306fItems.jsx\u306e\u30bd\u30fc\u30b9\u3067\u3059(User.jsx\u3082\u307b\u307c\u540c\u69d8\u306e\u30b3\u30fc\u30c9)\u3002\n\n```js\nimport React, { Component, PropTypes } from 'react';\nimport { Link } from 'react-router';\n\nexport default class Items extends Component {\n  render() {\n    const { items = [] } = this.props;\n    return (\n      <div>\n        <h2>item list</h2>\n        <Link to='/users'>users\u3078</Link>\n        <ul>\n          {items.map(item => {\n            return (<li key={item.id}>{item.id}: {item.name}</li>);\n          })}\n        </ul>\n      </div>\n    );\n  }\n}\n\nItems.propTypes = {\n  items: PropTypes.array\n};\n```\n\n\u307e\u305f\u3001App.jsx\u3092Items.jsx\u3068Users.jsx\u306e\u89aaComponent\u3068\u3059\u308b\u305f\u3081\u306b\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u4fee\u6b63\u3057\u307e\u3059\u3002\n\n```js\nimport React, { Component, PropTypes } from 'react';\n\nexport default class App extends Component {\n  render() {\n    return (\n      <div>\n        <h1>Hello SSR!</h1>\n        {this.props.children}\n      </div>\n    );\n  }\n}\n\nApp.propTypes = {\n  children: PropTypes.object\n};\n```\n\n\u305d\u3057\u3066\u3001React Router\u3092\u4f7f\u3063\u305froutes.jsx\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n```js\nimport React from 'react';\nimport { Route } from 'react-router';\n\nimport App from './App';\nimport Items from './Items';\nimport Users from './Users';\n\nexport default (\n  <Route path=\"/\" component={App}>\n    <Route path=\"items\" component={Items} />\n    <Route path=\"users\" component={Users} />\n  </Route>\n);\n```\n\n\u7d9a\u3044\u3066\u3001\u3053\u306eroutes.jsx\u3092server.jsx, client.jsx\u306e\u305d\u308c\u305e\u308c\u3067\u5229\u7528\u3057\u307e\u3059\u3002\u307e\u305a\u306fserver.jsx\u306erender\u95a2\u6570\u3092\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u4fee\u6b63\u3057\u307e\u3059\u3002\n\n```js\nimport { match, RouterContext } from 'react-router'\nimport routes from './routes'\n...\nexport default function render(req, res) {\n  match({ routes, location: req.url }, (error, redirectLocation, renderProps) => {\n    if (error) {\n      res.status(500).send(error.message)\n    } else if (redirectLocation) {\n      res.redirect(302, redirectLocation.pathname + redirectLocation.search)\n    } else if (renderProps) {\n      const renderedContent = renderToString(<RouterContext {...renderProps} />);\n      const renderedPage = renderFullPage(renderedContent);\n      res.status(200).send(renderedPage);\n    } else {\n      res.status(404).send('Not found')\n    }\n  })\n};\n\n```\n\nReact Routerr\u306ematch\u95a2\u6570\u3068RouterContext\u3092\u5229\u7528\u3059\u308b\u3053\u3068\u3067\u3001url\u306b\u5bfe\u5fdc\u3057\u305fComponent\u5272\u308a\u51fa\u3057\u3066dom\u30c4\u30ea\u30fc\u3092\u751f\u6210\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\nclient.jsx\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u4fee\u6b63\u3057\u307e\u3059\u3002\n\n```js\nimport React from 'react';\nimport ReactDOM from 'react-dom';\nimport { Router, browserHistory } from 'react-router'\nimport routes from './routes'\n\nReactDOM.render(\n  <Router history={browserHistory}>\n    {routes}\n  </Router>,\ndocument.getElementById('app'))\n```\n\n\u30b5\u30fc\u30d0\u30fc\u3092\u8d77\u52d5\u3057\u3066curl\u3092\u53e9\u3044\u3066\u30c6\u30b9\u30c8\u3059\u308b\u3068\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\n\n- \"/\"\u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3068\"Hello SSR!\"\u304c\u8868\u793a\n- \"/items\"\u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3068\"Hello SSR!\"\u306b\u52a0\u3048\u3066\"item list\"\u304c\u8868\u793a(\u307e\u3060items\u30c7\u30fc\u30bf\u306ffetch\u3057\u3066\u3044\u306a\u3044\u306e\u3067\u30bf\u30a4\u30c8\u30eb\u306e\u307f)\n\n\u307e\u305f\u3001Item.jsx\u306b\u4ed5\u8fbc\u3093\u3067\u304a\u3044\u305f\"users\u3078\"\u306eLink\u3092\u30af\u30ea\u30c3\u30af\u3059\u308b\u3068\"/users\"\u3078\u9077\u79fb\u3057\u307e\u3059\u3002\n\n## \u975e\u540c\u671f\u3067\u53d6\u5f97\u3057\u305f\u30c7\u30fc\u30bf\u3092\u7528\u3044\u3066\u30ec\u30f3\u30c0\u30ea\u30f3\u30b0\u3059\u308b\u30d1\u30bf\u30fc\u30f3\n\n\u53c2\u8003\u30bd\u30fc\u30b9\u3067\u306f\u3001\u57fa\u672c\u7684\u306b\u5404Component\u306bstatic\u306a\u30c7\u30fc\u30bf\u53d6\u5f97\u95a2\u6570\u3092\u5b9a\u7fa9\u3057\u3066\u304a\u3044\u3066\u3001match\u95a2\u6570\u306b\u3088\u3063\u3066\u95a2\u4fc2\u3059\u308bComponent\u304c\u5272\u308a\u51fa\u3055\u308c\u305f\u969b\u306b\u30c7\u30fc\u30bf\u53d6\u5f97\u3092\u5b9f\u884c\u3059\u308b\u3001\u3068\u3044\u3046\u65b9\u6cd5\u3092\u53d6\u3063\u3066\u3044\u308b\u3088\u3046\u3067\u3059\u3002\u305f\u3060\u3001Component\u304c\u968e\u5c64\b\u5316\u3055\u308c\u3066\u3044\u308b\u5834\u5408\u3001\u30c7\u30fc\u30bf\u3092\u53d6\u5f97\u3059\u308b\u3060\u3051\u3067\u306a\u304f\u53d6\u5f97\u3057\u305f\u30c7\u30fc\u30bf\u3092\u9069\u5207\u306aComponent\u306b\u6e21\u3059\u5de5\u592b\u304c\u5fc5\u8981\u306b\u306a\u308a\u307e\u3059\u3002\n\n\u4f8b\u3048\u3070Items.jsx\u3084Users.jsx\u3060\u3051\u3067\u306a\u304fApp.jsx\u3082\u72ec\u81ea\u306e\u30c7\u30fc\u30bf\u53d6\u5f97\u3092\u3059\u308b\u5834\u5408\u3001\u30b5\u30fc\u30d0\u30fc\u30b5\u30a4\u30c9\u3067\u306fApp.jsx\u3068Items.jsx\u3001\u3082\u3057\u304f\u306fApp.jsx\u3068Users.jsx\u306e\u30c7\u30fc\u30bf\u304c\u30bb\u30c3\u30c8\u3067\u53d6\u5f97\u3055\u308c\u307e\u3059\u3002\u305d\u3057\u3066\u3001App.jsx\u306e\u30c7\u30fc\u30bf\u53d6\u5f97\u95a2\u6570\u306e\u5b9f\u884c\u7d50\u679c\u306fApp.jsx\u306b\u3001Items.jsx/Users.jsx\u306e\u30c7\u30fc\u30bf\u306fItems.jsx/Users.jsx\u306b\u6e21\u3059\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\n\u3053\u306e\u52d5\u4f5c\u306e\u5b9f\u73fe\u3059\u308b\u305f\u3081\u3001\u4eca\u56de\u306fRouter\u3068App.jsx\u306e\u9593\u306b\u30c7\u30fc\u30bf\u7ba1\u7406\u7528\u306eComponent\u3092\u5dee\u3057\u8fbc\u3080\u65b9\u6cd5\u3092\u3068\u308a\u307e\u3059\u3002\n\nComponent\u306e\u968e\u5c64\u69cb\u9020\u3092\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u3057\u307e\u3059\u3002\n\n\u203bApp.jsx/Items.jsx/Users.jsx\u306a\u3069\u306eComponent\u3092[App Components]\u3068\u8a18\u8f09\u3001*\u3092\u3064\u3051\u305f\u3082\u306e\u304c\u5dee\u3057\u8fbc\u3080Component\n\n- Router : React Router\u306e\u30eb\u30fc\u30c8Component\n    - *AppContext : [App Components]\u306e\u30c7\u30fc\u30bf\u53d6\u5f97\u95a2\u6570\u306e\u5b9f\u884c\u7d50\u679c\u30c7\u30fc\u30bf\u3092\u4fdd\u6301\u3059\u308bComponent\n        - RouterContext : routes.jsx\u3067<Router>\u306e\u914d\u4e0b\u306b\u5b9a\u7fa9\u3055\u308c\u305f[App Components]\u3092render\u3059\u308bComponent\n            - *PropsContainer : [App Components]\u306bAppContext\u304c\u4fdd\u6301\u3059\u308b\u30c7\u30fc\u30bf\u3092\u6e21\u3059Component\n                - [App Component]\n\n\n\u3082\u3057\u3001```/items```\u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3068\u3001\n\n-  Router\n    - AppContext\n        - RouteContext\n            - PropContainer\n                - App.jsx\n\n\u3068\u306a\u308a\u3001App.jsx\u4ee5\u4e0b\u306f\n\n- App.jsx\n    - PropContainer\n        - Item.jsx\n\n\u3068\u3044\u3046\u968e\u5c64\u69cb\u9020\u306b\u306a\u308a\u307e\u3059\u3002\n\n\u3061\u306a\u307f\u306b\u3053\u306e\u65b9\u6cd5\u306f\u3001\u4e0a\u3067\u6319\u3052\u305f[async-props](https://github.com/rackt/async-props)\u3092\u53c2\u8003\u306b\u3057\u3066\u3044\u307e\u3059(\u8aac\u660e\u306b\u5fc5\u8981\u306a\u90e8\u5206\u3060\u3051\u3092\u5207\u308a\u51fa\u3057\u305f\u306e\u3067\u3001\u540c\u3058\u3053\u3068\u304c\u3084\u308a\u305f\u3044\u5834\u5408\u306f\u7d20\u76f4\u306b\u3053\u306e\u30e2\u30b8\u30e5\u30fc\u30eb\u3092\u5229\u7528\u3059\u308b\u65b9\u304c\u826f\u3044\u3067\u3059)\u3002\n\n\u307e\u305aApp.jsx/Items.jsx/Users.jsx\u306b\u30c7\u30fc\u30bf\u53d6\u5f97\u95a2\u6570\u3092\u5b9a\u7fa9\u3057\u307e\u3059\u3002App.jsx\u306f\u3001\n\n```js\nimport React, { Component, PropTypes } from 'react';\nimport fetch from 'isomorphic-fetch';\n\nexport default class App extends Component {\n\n  static loadProps(callback) {\n    fetch('http://localhost:3000/api/me')\n      .then(res => res.json())\n      .then(json => callback(null, {me: json}))\n      .catch(error => callback(error));\n  }\n\n  render() {\n    const { me } = this.props;\n    return (\n      <div>\n        <h1>Hello {me.name}!</h1>\n        <p>server date {me.date}!</p>\n        {this.props.children}\n      </div>\n    );\n  }\n}\n\nApp.propTypes = {\n  children: PropTypes.object\n};\n\n```\n\n\u3068\u3044\u3046\u3088\u3046\u306b\u3001\u30c7\u30fc\u30bf\u53d6\u5f97\u95a2\u6570(loadProps)\u3092\u8ffd\u52a0\u3057\u3001props\u306e\u30c7\u30fc\u30bf\u3092\u8868\u793a\u3059\u308b\u3088\u3046\u306b\u4fee\u6b63\u3057\u3066\u3044\u307e\u3059\u3002\nloadProps\u306ffetch\u304c\u5b8c\u4e86\u3057\u305f\u3089callback\u3092\u547c\u3073\u307e\u3059\u304c\u3001\u305d\u306e\u969b\u306e\u5f15\u6570\u306f\u81ea\u8eab\u306b\u6e21\u3057\u3066\u6b32\u3057\u3044props\u306e\u5f62\u5f0f\u3068\u3057\u307e\u3059(```{me: json}```)\u3002\nItems.jsx/Users.jsx\u306b\u3082\u540c\u69d8\u306bloadProps\u3092\u5b9a\u7fa9\u3057\u3001props\u3092\u63cf\u753b\u3059\u308b\u3088\u3046\u306b\u4fee\u6b63\u3057\u307e\u3059\u3002\n\n\u7d9a\u3044\u3066server.jsx\u306erender\u95a2\u6570\u3067\u5404Component\u306eloadProps\u3092\u5b9f\u884c\u3057\u307e\u3059\u3002\n\n```js\nexport default function render(req, res) {\n  match({ routes, location: req.url }, (error, redirectLocation, renderProps) => {\n    if (error) {\n      res.status(500).send(error.message)\n    } else if (redirectLocation) {\n      res.redirect(302, redirectLocation.pathname + redirectLocation.search)\n    } else if (renderProps) {\n      const componentsArray = renderProps.components.filter(component => component.loadProps);\n      let propsArray = [];\n      Promise.all(\n        componentsArray.map((component, index) => {\n          return new Promise((resolve, reject) => {\n            component.loadProps((error, fetchResult) => {\n              if (error) {\n                reject(error);\n              } else {\n                propsArray[index] = fetchResult;\n                resolve();\n              }\n            });\n          });\n        })\n      ).then(() => {\n        const propsAndComponents = { componentsArray, propsArray };\n        const renderedContent = renderToString(<AppContext { ...renderProps } { ...propsAndComponents } />);\n        const renderedPage = renderFullPage(renderedContent, propsArray);\n        res.status(200).send(renderedPage);\n      }).catch(error => {\n        res.status(500).send(error.message)\n      });\n    } else {\n      res.status(404).send('Not found')\n    }\n  });\n};\n```\n\nReact Router\u306ematch\u95a2\u6570\u3067\u5272\u308a\u51fa\u3055\u308c\u305fComponent\u306e\u3046\u3061loadProps\u3092\u5b9f\u88c5\u3057\u3066\u3044\u308b\u3082\u306e\u3092filtering\u3057\u305f\u4e0a\u3067\u3001\u305d\u308c\u305e\u308c\u306eloadProps\u3092\u5b9f\u884c\u3057\u3001Promise.all\u3067\u5168\u3066\u306e\u51e6\u7406\u304c\u5b8c\u4e86\u3059\u308b\u306e\u3092\u5f85\u3063\u3066\u3001\u53d6\u5f97\u30c7\u30fc\u30bf\u3092\u30c7\u30fc\u30bf\u7ba1\u7406\u7528Component\u3067\u3042\u308bAppContext\u306b\u6e21\u3057\u3066\u3044\u307e\u3059\u3002\u307e\u305f\u3001\u53d6\u5f97\u30c7\u30fc\u30bf\u3092\u30d6\u30e9\u30a6\u30b6\u306b\u3082\u5171\u6709\u3059\u308b\u305f\u3081\u306brenderFullPage\u95a2\u6570\u306e\u7b2c2\u5f15\u6570\u3068\u3057\u3066\u6e21\u3057\u3066\u3044\u307e\u3059(\u3053\u306e\u30b5\u30fc\u30d0\u30fc\u30b5\u30a4\u30c9\u3067\u53d6\u5f97\u3057\u305f\u30c7\u30fc\u30bf\u3092\u30d6\u30e9\u30a6\u30b6\u306b\u5171\u6709\u3059\u308b\u65b9\u6cd5\u306f\u65e2\u306b\b\"React\u5358\u4f53\u3067SSR\"\u3067\u8f09\u305b\u3066\u3044\u308b\u306e\u3067\u7701\u7565)\u3002\n\nclient.jsx\u3067\u3082Router\u76f4\u4e0b\u306bAppContext\u3092\u5dee\u3057\u8fbc\u3080\u3088\u3046\u306bRouter\u306erender\u30d7\u30ed\u30d1\u30c6\u30a3\u30fc\u3092\u4e0a\u66f8\u304d\u3057\u307e\u3059\u3002\n\n```js\nimport React from 'react';\nimport ReactDOM from 'react-dom';\nimport { Router, browserHistory } from 'react-router';\nimport routes from './routes';\nimport AppContext from './AppContext';\n\nReactDOM.render(\n  <Router history={browserHistory} render={(props) => <AppContext {...props}/>}>\n    {routes}\n  </Router>,\ndocument.getElementById('app'))\n```\n\n\u7d9a\u3044\u3066AppContext/PropsContainer\u306e\u5b9f\u88c5\u3067\u3059\u3002\n\n```js\nimport React, { Component, PropTypes } from 'react';\nimport { RouterContext } from 'react-router/lib'\n\n// APP_PROPS\u306b\u683c\u7d0d\u3057\u305f\u30c7\u30fc\u30bf\u3092\u53d6\u5f97\u3057\u3066AppContext\u304c\u6271\u3048\u308b\u5f62\u306b\u3057\u3066\u8fd4\u3059\nfunction hydrate(props) {\n  if (typeof APP_PROPS !== 'undefined')\n    return {\n      propsArray: APP_PROPS,\n      componentsArray: props.components.filter(component => component.loadProps)\n    }\n  else\n    return null\n}\n\n// RouterContext\u306ecreateElement\u30d7\u30ed\u30d1\u30c6\u30a3\u306b\u3053\u306e\u95a2\u6570\u3092\u6307\u5b9a\u3057\u3066\u3001PropsContainer\u3092\u5dee\u3057\u8fbc\u3080\nfunction createElement(Component, props) {\n  if (Component.loadProps)\n    return <PropsContainer Component={Component} routerProps={props}/>\n  else\n    return <Component {...props}/>\n}\n\nexport default class AppContext extends Component {\n\n  static childContextTypes = {\n    asyncProps: PropTypes.object\n  };\n\n  static propTypes = {\n    components: PropTypes.array.isRequired,\n    params: PropTypes.object.isRequired,\n    location: PropTypes.object.isRequired,\n    // server rendering\n    propsArray: PropTypes.array,\n    componentsArray: PropTypes.array\n  };\n\n  constructor(props, context) {\n    super(props, context)\n    const { propsArray, componentsArray } = this.props\n    const isServerRender = propsArray && componentsArray\n    // \u30b5\u30fc\u30d0\u30fc\u30b5\u30a4\u30c9\u3060\u3068props\u3067\u6e21\u3055\u308c\u305f\u3082\u306e\u3092\u5229\u7528\u3057\u3001\u30d6\u30e9\u30a6\u30b6\u3067\u306fhydrate\u95a2\u6570\u3067APP_PROPS\u304b\u3089\u30c7\u30fc\u30bf\u3092\u53d6\u5f97\n    this.state = {\n      propsAndComponents: isServerRender ?\n        { propsArray, componentsArray } :\n        hydrate(props)\n    }\n  }\n\n  // \u7ba1\u7406\u3057\u3066\u3044\u308b\u30c7\u30fc\u30bf\u3092Context\u3092\u5229\u7528\u3057\u3066\u5b50\u306b\u6e21\u3059\n  getChildContext() {\n    const { propsAndComponents } = this.state\n    return {\n      asyncProps: { propsAndComponents }\n    };\n  }\n\n  render() {\n    // createElement\u30d7\u30ed\u30d1\u30c6\u30a3\u3092\u4e0a\u66f8\u304d\n    return <RouterContext {...this.props} createElement={createElement}/>\n  }\n}\n\n// \u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u5074\u306eComponent\u304c\u5fc5\u8981\u3068\u3059\u308b\u30c7\u30fc\u30bf\u3092\u5272\u308a\u51fa\u3059\nfunction lookupPropsForComponent(Component, propsAndComponents) {\n  const { componentsArray, propsArray } = propsAndComponents\n  var index = componentsArray.indexOf(Component)\n  return propsArray[index]\n}\n\nclass PropsContainer extends React.Component {\n\n  static propTypes = {\n    Component: PropTypes.func.isRequired,\n    routerProps: PropTypes.object.isRequired\n  };\n\n  static contextTypes = {\n    asyncProps: PropTypes.object.isRequired\n  };\n\n  render() {\n    const { Component, routerProps, ...props } = this.props\n    const { propsAndComponents } = this.context.asyncProps\n    const asyncProps = lookupPropsForComponent(Component, propsAndComponents)\n    return (\n      <Component\n        {...props}\n        {...routerProps}\n        {...asyncProps} />\n    )\n  }\n\n}\n```\n\n1\u3064\u306e\u30d5\u30a1\u30a4\u30eb\u306bAppContext\u3068PropsContainer\u3092\u5b9a\u7fa9\u3057\u3066\u3044\u307e\u3059\u3002export\u3057\u3066\u3044\u308b\u306e\u306fAppContext\u306e\u307f\u3067\u3059\u3002\n\nAppContext\u306fconstructor\u3067\u30c7\u30fc\u30bf(loadProps\u306e\u5b9f\u884c\u7d50\u679c)\u3092\u6e21\u3055\u308c\u3001\u305d\u308c\u3092state\u306b\u30bb\u30c3\u30c8\u3057\u307e\u3059\u3002render\u3059\u308b\u306e\u306fRouterContext\u3067\u3059\u304c\u3001createElement\u30d7\u30ed\u30d1\u30c6\u30a3\u3092\u6307\u5b9a\u3057\u3066\u3044\u3066\u3001\u3053\u306e\u95a2\u6570\u306e\u4e2d\u3067PropsContainer\u3092\u5dee\u3057\u8fbc\u307f\u307e\u3059\u3002\u307e\u305fgetChildContext\u3092\u5b9a\u7fa9\u3057\u3066\u304a\u308a\u3001PropsContainer\u306b\u30c7\u30fc\u30bf\u3092\u6e21\u305b\u308b\u3088\u3046\u306b\u3057\u3066\u3044\u307e\u3059\u3002\u307e\u305f\u3001\u30b5\u30fc\u30d0\u30fc\u30b5\u30a4\u30c9\u3067\u30ed\u30fc\u30c9\u3057\u305f\u30c7\u30fc\u30bf\u306fAPP_PROPS\u3068\u3044\u3046\u5909\u6570\u306b\u683c\u7d0d\u3055\u308c\u3066\u304a\u308a\u3001\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u30b5\u30a4\u30c9\u3067\u306f\u305d\u308c\u3092hydrate\u95a2\u6570\u3067\u53d6\u5f97\u3057\u307e\u3059\u3002\n\nPropsContainer\u306fAppContext\u304c\u4fdd\u6301\u3059\u308b\u30c7\u30fc\u30bf\u304b\u3089\u306e\u4e2d\u304b\u3089\u3001lookupPropsForComponent\u95a2\u6570\u3067\u751f\u6210\u3059\u308bComponent\u306b\u5fc5\u8981\u306a\u3082\u306e\u3060\u3051\u3092\u62bd\u51fa\u3057\u3066\u6e21\u3059\u5f79\u5272\u3092\u62c5\u3063\u3066\u3044\u307e\u3059\u3002\n\n\u3053\u3053\u307e\u3067\u5b9f\u88c5\u3057\u3066curl\u3067\u30c6\u30b9\u30c8\u3059\u308b\u3068\u3001\n\n- \"/\"\u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3068\u3001\"Hello hoge!\"\u3068\"server date 2016-01-27T13:35:16.891Z\"\u304c\u8868\u793a(\"hoge\"\u3068\"2016-01...\"\u304cfetch\u3057\u305f\u7d50\u679c)\n- \"/items\"\u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3068\u4e0a\u8a18\u306b\u52a0\u3048\u3066\u3001item\u306e\u30ea\u30b9\u30c8\u304c\u8868\u793a\n\n\u3068\u306a\u308a\u307e\u3059\u3002\n\n\u305f\u3060\u3001\u3053\u306e\u6642\u70b9\u3067\u306f\u30d0\u30b0\u304c\u3042\u308a\u307e\u3059\u3002\nItems.jsx\u3068Users.jsx\u306b\u5b9a\u7fa9\u3057\u305fLink\u8981\u7d20\u3092\u30af\u30ea\u30c3\u30af\u3057\u3066\u9077\u79fb\u3059\u308b\u3068\u3001\u9077\u79fb\u5148\u306e\u753b\u9762\u306e\u30ea\u30b9\u30c8\u304c\u8868\u793a\u3055\u308c\u307e\u305b\u3093\u3002\n\n\u3053\u308c\u306f\u5b9a\u7fa9\u3057\u305floadProps\u304c\u30b5\u30fc\u30d0\u30fc\u30b5\u30a4\u30c9\u3067\u3057\u304b\u547c\u3070\u308c\u3066\u3044\u306a\u3044\u305f\u3081\u306b\u767a\u751f\u3057\u307e\u3059\u3002\u305d\u3053\u3067\u305d\u308c\u305e\u308c\u306eComponent\u306ecomponentWillMount\u95a2\u6570\u5185\u3067loadProps\u3092\u547c\u3076\u3088\u3046\u306b\u4fee\u6b63\u3057\u307e\u3059\u3002\n\nItems.jsx\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\n\n```js\nimport React, { Component, PropTypes } from 'react';\nimport { Link } from 'react-router';\nimport fetch from 'isomorphic-fetch';\n\nexport default class Items extends Component {\n\n  static loadProps(callback) {\n    fetch('http://localhost:3000/api/items')\n      .then(res => res.json())\n      .then(json => callback(null, {items: json}))\n      .catch(error => callback(error));\n  }\n\n  constructor(props, context) {\n    super(props, context);\n    this.state = {\n      items: props.items\n    };\n  }\n\n  componentWillMount() {\n    if (this.context.didMount) {\n      Items.loadProps((ignore, res) => {\n        this.setState({ items: res.items });\n      });\n    }\n  }\n\n  render() {\n    const { items = [] } = this.state;\n    return (\n      <div>\n        <h2>item list</h2>\n        <Link to='/users'>users\u3078</Link>\n        <ul>\n          {items.map(item => {\n            return (<li key={item.id}>{item.id}: {item.text}</li>);\n          })}\n        </ul>\n      </div>\n    );\n  }\n}\n\nItems.propTypes = {\n  items: PropTypes.array\n};\n\nItems.contextTypes = {\n  didMount: PropTypes.bool\n};\n```\n\nItems.jsx\u3084Users.jsx\u306bcomponentWillMount\u3092\u5b9a\u7fa9\u3059\u308b\u306e\u306b\u5408\u308f\u305b\u3066\u3001\u5e7e\u3064\u304b\u4fee\u6b63\u3092\u3057\u3066\u3044\u307e\u3059\u3002\n\n- props\u306e\u60c5\u5831\u3092\u4e00\u65e6state\u306b\u683c\u7d0d\u3057\u305f\u4e0a\u3067\u3001\u8868\u793a\u306b\u5229\u7528\n\n\u3053\u308c\u306f\u3001componentWillMount\u3067\u30c7\u30fc\u30bf\u3092\u8aad\u307f\u8fbc\u3093\u3060\u969b\u306b\u3001\u7c21\u6613\u7684\u306b\u8868\u793a\u3092\u5207\u308a\u66ff\u3048\u3089\u308c\u308b\u3088\u3046\u306b\u3059\u308b\u305f\u3081\u306e\u5bfe\u5fdc\u3067\u3059\u3002\n\u4fee\u6b63\u524d\u306e\u307e\u307e\u3060\u3068\u3001state\u7ba1\u7406\u3057\u3066\u3044\u308b\u89aaComponent(\u4eca\u56de\u306e\u30b1\u30fc\u30b9\u3060\u3068\u4f8b\u3048\u3070AppContext\u306a\u3069)\u306b\u4e00\u65e6\u30ed\u30fc\u30c9\u3057\u305f\u30c7\u30fc\u30bf\u3092\u6e21\u3057\u305f\u4e0a\u3067\u3001\u518d\u5ea6props\u3092\u53d7\u3051\u53d6\u308b\u5fc5\u8981\u304c\u51fa\u3066\u304d\u3066\u3057\u307e\u3046\u305f\u3081\u3067\u3059\u3002\n\n- AppContext\u3067componentDidMount\u304c\u547c\u3070\u308c\u305f\u969b\u306bdidMount\u3068\u3044\u3046state\u3092true\u306b\u30bb\u30c3\u30c8\n- contextTypes\u3067AppContext\u306edidMount\u3092\u53d7\u3051\u53d6\u308b\n- didMount\u304ctrue\u306e\u5834\u5408\u306e\u307fcomponentWillMount\u3067loadProps\u3092\u5b9f\u884c\n\n\u3053\u308c\u3089\u306f\u3001\u30b5\u30fc\u30d0\u30fc\u30b5\u30a4\u30c9\u3001\u3082\u3057\u304f\u306f\u30b5\u30fc\u30d0\u30fc\u30b5\u30a4\u30c9\u30ec\u30f3\u30c0\u30ea\u30f3\u30b0\u304c\u5b9f\u65bd\u3055\u308c\u305fhtml\u3092\u8aad\u307f\u8fbc\u3093\u3060\u76f4\u5f8c\u306b\u3001loadProps\u304c\u5b9f\u884c\u3055\u308c\u306a\u3044\u3088\u3046\u306b\u3059\u308b\u305f\u3081\u306e\u5bfe\u5fdc\u3067\u3059\u3002\u3053\u306edidMount\u306fAppContext\u306ecomponentDidMount\u304c\u5b9f\u884c\u3055\u308c\u305f\u30bf\u30a4\u30df\u30f3\u30b0\u3067true\u306b\u306a\u308b\u3088\u3046\u306b\u5b9f\u88c5\u3057\u3066\u3044\u308b\u305f\u3081\u3001\u30b5\u30fc\u30d0\u30fc\u30b5\u30a4\u30c9\u3067\u306ftrue\u306b\u306f\u306a\u308a\u307e\u305b\u3093\u3002\u307e\u305f\u30d6\u30e9\u30a6\u30b6\u3067js\u304c\u30ed\u30fc\u30c9\u3055\u308c\u305f\u76f4\u5f8c\u306e\u30bf\u30a4\u30df\u30f3\u30b0\u3067\u3082\u540c\u69d8\u306btrue\u3067\u306f\u3042\u308a\u307e\u305b\u3093\u3002\u305d\u306e\u305f\u3081\u91cd\u8907\u3057\u3066\u30c7\u30fc\u30bf\u306efetch\u304c\u5b9f\u884c\u3055\u308c\u308b\u3053\u3068\u3092\u9632\u3050\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\n### \u3053\u3053\u307e\u3067\u306e\u307e\u3068\u3081\n\n\u3053\u306e\u3088\u3046\u306b\u3001React Router\u3068\u30b5\u30fc\u30d0\u30fc\u30b5\u30a4\u30c9\u30ec\u30f3\u30c0\u30ea\u30f3\u30b0\u3092\u7d44\u307f\u5408\u308f\u305b\u308b\u3053\u3068\u306f\u3067\u304d\u307e\u3059\u304c\u3001\u30c7\u30fc\u30bf\u306e\u7ba1\u7406\u304c\u7169\u96d1\u306b\u306a\u308a\u307e\u3059\u3002[async-props](https://github.com/rackt/async-props)\u306f\u4e0a\u3067\u8aac\u660e\u3057\u305f\u5b9f\u88c5\u3092\u96a0\u853d\u3057\u3066\u3001\u4f7f\u3046\u5074\u304c\u3042\u307e\u308a\u610f\u8b58\u3059\u308b\u5fc5\u8981\u304c\u306a\u3044\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u304c\u3001\u6b63\u76f4\u306a\u611f\u60f3\u3068\u3057\u3066\u306f\u305d\u3053\u307e\u3067\u3084\u308b\u306e\u3060\u3063\u305f\u3089\u7d20\u76f4\u306b[Flux](https://facebook.github.io/react/docs/flux-overview.html)\u3092\u5c0e\u5165\u3057\u305f\u65b9\u304c\u826f\u3055\u305d\u3046\u3067\u3059\u3002\n\n# React + React Router + Redux\n\n\u6700\u5f8c\u306b[Redux](https://github.com/rackt/redux)\u3092\u7d44\u307f\u5408\u308f\u305b\u305f\u5834\u5408\u3067\u3059\u3002\n\n## \u53c2\u8003\u306b\u3057\u305f\u30bd\u30fc\u30b9\n\n- [react-redux-universal-hot-example](https://github.com/erikras/react-redux-universal-hot-example)\n- [redux\u306eServer Rendering\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8](https://github.com/rackt/redux/blob/master/docs/recipes/ServerRendering.md)\n\n## \u975e\u540c\u671f\u3067\u53d6\u5f97\u3057\u305f\u30c7\u30fc\u30bf\u3092\u7528\u3044\u3066\u30ec\u30f3\u30c0\u30ea\u30f3\u30b0\u3059\u308b\u30d1\u30bf\u30fc\u30f3\n\n\u30c7\u30fc\u30bf\u3092fetch\u3057\u3066\u8868\u793a\u3059\u308b\u30d1\u30bf\u30fc\u30f3\u306e\u307f\u8aac\u660e\u3057\u307e\u3059\u3002\nRedux\u3092\u4f7f\u3046\u3068\u30c7\u30fc\u30bf\u306e\u7ba1\u7406\u306fstore\u306b\u4efb\u305b\u308b\u3053\u3068\u304c\u3067\u304d\u308b\u306e\u3067\u3001\u81ea\u524d\u306eComponent\u304c\u4e0d\u8981\u306b\u306a\u308a\u307e\u3059(\u4e0a\u306e\u4f8b\u3067\u306eAppContext/PropsContainer)\u3002\u521d\u671f\u8868\u793a\u7528\u306e\u30c7\u30fc\u30bf\u3092\u53d6\u5f97\u3059\u308b\u51e6\u7406\u306b\u95a2\u3057\u3066\u306f\u3001React + React Router\u306e\u30d1\u30bf\u30fc\u30f3\u3068\u540c\u69d8\u306b\u5404Component\u306bstatic\u306a\u95a2\u6570\u3068\u3057\u3066\u5b9a\u7fa9\u3059\u308b\u3053\u3068\u306b\u306a\u308a\u307e\u3059\u3002\n\nApp.jsx\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u5909\u66f4\u3057\u307e\u3059\u3002\n\n```js\nimport React, { Component, PropTypes } from 'react';\nimport { connect } from 'react-redux';\nimport { loadMe, didMount } from './actions';\n\nclass App extends Component {\n\n  // \u30c7\u30fc\u30bf\u53d6\u5f97\u95a2\u6570\n  static fetchData() {\n    return loadMe();\n  }\n\n  static propTypes = {\n    children: PropTypes.object\n  };\n\n  componentWillMount() {\n    const { dispatch } = this.props;\n    if (this.props.didMount) {\n      dispatch(loadMe());\n    }\n  }\n\n  // \u4e0a\u3067\u3082\u5229\u7528\u3057\u3066\u3044\u308bthis.props.didMount\u3092true\u3068\u3059\u308b\u305f\u3081\u306b\u30a2\u30af\u30b7\u30e7\u30f3\u3092dispatch\n  componentDidMount() {\n    const { dispatch } = this.props;\n    dispatch(didMount());\n  }\n\n  render() {\n    const { me } = this.props;\n    return (\n      <div>\n        <h1>Hello {me.name}!</h1>\n        <p>server date {me.date}!</p>\n        {this.props.children}\n      </div>\n    );\n  }\n}\n\nfunction mapStateToProps(state) {\n  return {\n    didMount: state.app.didMount,\n    me: state.app.me\n  };\n}\n\nexport default connect(\n  mapStateToProps\n)(App);\n```\n\n\u3053\u308c\u307e\u3067\u306e\u4f8b\u3068\u7570\u306a\u308b\u70b9\u306f\u3001componentDidMount\u3067DID_MOUNT\u30a2\u30af\u30b7\u30e7\u30f3\u3092dispatch\u3057\u3066\u3044\u308b\u70b9\u3068\u3001redux\u306estore\u306bconnect\u3057\u3066\u3044\u308b\u3053\u3068\u3067\u3059\u3002reducer\u3067\u306fDID_MOUNT\u30a2\u30af\u30b7\u30e7\u30f3\u306b\u3088\u3063\u3066\u3001state.app.didMount\u30d5\u30e9\u30b0\u3092true\u306b\u66f4\u65b0\u3057\u307e\u3059\u3002\n\n```js\nimport { DID_MOUNT, LOADED_ME } from 'actions';\n\nexport default function app(state = {\n  didMount: false,\n  me: {}\n}, action) {\n  switch (action.type) {\n    case DID_MOUNT:\n      return Object.assign({}, state,\n        { didMount: true }\n      );\n    case LOADED_ME:\n      const { me } = action;\n      return Object.assign({}, state,\n        { me }\n      );\n    default:\n      return state;\n  }\n}\n```\n\n\u3053\u306edidMount\u30d5\u30e9\u30b0\u306b\u3088\u3063\u3066\u30011\u3064\u524d\u306e\u30d1\u30bf\u30fc\u30f3\u3067\u8aac\u660e\u3057\u305f\u306e\u3068\u540c\u69d8\u306b\u5404Component\u306b\u304a\u3044\u3066componentWillMount\u3067\u30c7\u30fc\u30bf\u3092\u30ed\u30fc\u30c9\u3059\u308b\u304b\u3092\u5236\u5fa1\u3059\u308b\u3088\u3046\u306b\u3057\u307e\u3059\u3002\n\nApp.jsx\u306e\u8aac\u660e\u306b\u623b\u308a\u307e\u3059\u304c\u3001\u30c7\u30fc\u30bf\u53d6\u5f97\u306e\u305f\u3081\u306estatic\u306a\u95a2\u6570\u3067\u3042\u308bfetchData\u3067\u306f\u3001\u5225\u306e\u30d5\u30a1\u30a4\u30eb\u306b\u5b9a\u7fa9\u3055\u308c\u305floadMe\u3068\u3044\u3046action creator\u3092\u547c\u3073\u51fa\u3057\u3066\u8fd4\u3057\u3066\u3044\u307e\u3059\u3002loadMe\u95a2\u6570\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u5185\u5bb9\u3067\u3059\u3002\n\n```js\nexport function loadMe() {\n  return dispatch => {\n    // \u30b5\u30f3\u30d7\u30eb\u306e\u305f\u3081\u6c7a\u3081\u6253\u3061\u306eurl\n    return fetch('http://localhost:3000/api/me')\n      .then(res => {\n        if (res.status >= 400) {\n            throw new Error('Bad response from server');\n        }\n        return res.json();\n      }).then(data => {\n        return dispatch({\n          type: LOADED_ME,\n          me: data\n        });\n      });\n  };\n}\n```\n\nfetch\u3057\u305f\u30c7\u30fc\u30bf\u3092action\u306b\u8a70\u3081\u3066dispatch\u3057\u307e\u3059\u3002\u3053\u306eaction\u306freducer\u3067\u88dc\u8db3\u3055\u308c\u30c7\u30fc\u30bf\u306fstore\u306b\u683c\u7d0d\u3055\u308c\u307e\u3059\u3002\n\nItems.jsx/Users.jsx\u306b\u3064\u3044\u3066\u306f\u3001componentDidMount\u306f\u5b9f\u88c5\u3092\u9664\u3044\u305f\u307b\u307c\u540c\u3058\u3088\u3046\u306a\u30b3\u30fc\u30c9\u3068\u306a\u308a\u307e\u3059\u3002\n\n\u7d9a\u3044\u3066server.jsx\u306erender\u95a2\u6570\u3092\u4fee\u6b63\u3057\u307e\u3059\u3002\n\n```js\nimport { Provider } from 'react-redux';\nimport configureStore from './configureStore';\n...\nexport default function render(req, res) {\n  match({ routes, location: req.url }, (error, redirectLocation, renderProps) => {\n    if (error) {\n      res.status(500).send(error.message)\n    } else if (redirectLocation) {\n      res.redirect(302, redirectLocation.pathname + redirectLocation.search)\n    } else if (renderProps) {\n      const store = configureStore({});\n      const components = renderProps.components.filter(component => component.fetchData);\n      Promise.all(components.map(component => store.dispatch(component.fetchData())))\n        .then(() => {\n          const renderedContent = renderToString(\n            <Provider store={store}>\n              <RouterContext {...renderProps} />\n            </Provider>\n          );\n          const renderedPage = renderFullPage(renderedContent, store.getState());\n          res.status(200).send(renderedPage);\n        }).catch(error => {\n          res.status(500).send(error.message);\n        });\n    } else {\n      res.status(404).send('Not found')\n    }\n  })\n};\n\n```\n\nRedux\u306estore\u3092\u751f\u6210\u3057\u305f\u4e0a\u3067Component\u306b\u5b9a\u7fa9\u3055\u308c\u305ffetchData\u3092dispatch\u3057\u3066\u3001\u3059\u3079\u3066\u306efetch\u304c\u5b8c\u4e86\u3057\u305f\u6642\u70b9\u3067Redux\u306eProvider Component\u3092\u751f\u6210\u3057\u3066\u3044\u307e\u3059\u3002dispatch\u306fstore\u306b\u5b9a\u7fa9\u3055\u308c\u305f\u95a2\u6570\u3067\u3001\u3053\u306e\u3088\u3046\u306bfetchData\u3092\u547c\u3073\u3053\u3068\u3067\u305d\u306e\u7d50\u679c\u304cstore\u306b\u683c\u7d0d\u3055\u308c\u308b\u3053\u3068\u306b\u306a\u308a\u307e\u3059\u3002\u307e\u305f\u3001fetch\u3057\u305f\u30c7\u30fc\u30bf\u3092store.getState()\u3067\u53d6\u5f97\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u308b\u306e\u3067renderFullPage\u306b\u6e21\u3057\u3066\u3044\u307e\u3059\u3002renderFullPage\u3067\u306f\u3053\u306e\u30c7\u30fc\u30bf\u3092APP_STATE\u5909\u6570\u306b\u683c\u7d0d\u3057\u307e\u3059\u3002\n\nclient.jsx\u3082\u4fee\u6b63\u3057\u307e\u3059\u3002\n\n```js\nimport React from 'react';\nimport ReactDOM from 'react-dom';\nimport { Provider } from 'react-redux';\nimport { Router, browserHistory } from 'react-router'\nimport configureStore from './configureStore';\nimport routes from './routes'\n\nconst store = configureStore(window.APP_STATE);\n\nReactDOM.render(\n  <Provider store={store}>\n    <Router history={browserHistory}>\n      {routes}\n    </Router>\n  </Provider>,\ndocument.getElementById('app'))\n```\n\nAPP_STATE\u5909\u6570\u306b\u683c\u7d0d\u3055\u308c\u305f\u30c7\u30fc\u30bf\u3092\u30d6\u30e9\u30a6\u30b6\u5074\u3067\u306estore\u521d\u671f\u5316\u306b\u5229\u7528\u3057\u307e\u3059\u3002\n\n\u4ed6\u306b\u3082items, users\u306e\u305f\u3081\u306eaction\u3084reducer\u306e\u5b9a\u7fa9\u304c\u5fc5\u8981\u3067\u3059\u304c\u7701\u7565\u3057\u307e\u3059\u3002curl\u3068\u30d6\u30e9\u30a6\u30b6\u3067\u30c6\u30b9\u30c8\u3059\u308b\u3068\u3001\u521d\u671f\u8868\u793a\u3068Link\u8981\u7d20\u306b\u3088\u308b\u753b\u9762\u9077\u79fb\u304c\u6b63\u3057\u304f\u52d5\u4f5c\u3059\u308b\u3053\u3068\u304c\u78ba\u8a8d\u3067\u304d\u307e\u3059\u3002\n\n# \u307e\u3068\u3081\n\n\u8aac\u660e\u306b\u7528\u3044\u305f\u30b5\u30f3\u30d7\u30eb\u30b3\u30fc\u30c9\u306f[github](https://github.com/hmarui66/react-server-rendering-sample)\u306b\u4e0a\u3052\u3066\u3042\u308a\u307e\u3059\u3002\n\nReact\u306e\u52c9\u5f37\u304c\u3066\u3089\u306b\u307e\u3068\u3081\u3066\u307f\u307e\u3057\u305f\u304c\u3001\u81ea\u5206\u3068\u3057\u3066\u3082\u3057\u3063\u304f\u308a\u304d\u3066\u3044\u306a\u3044\u90e8\u5206\u3082\u3042\u308b\u306e\u3067(\u7279\u306bcomponentWillMount\u3067\u306edidMount\u306b\u3088\u308b\u5236\u5fa1)\u3001\u4ed6\u306b\u826f\u3044\u3084\u308a\u65b9\u304c\u3042\u308a\u307e\u3057\u305f\u3089\u3001\u6559\u3048\u3066\u3082\u3089\u3048\u308b\u3068\u3042\u308a\u304c\u305f\u3044\u3067\u3059\u3002\n\nReact\u3092\u89e6\u308a\u59cb\u3081\u305f\u5f53\u521d\u306fnode\u30b5\u30fc\u30d0\u30fc\u4f7f\u3048\u3070\u30b5\u30af\u30c3\u3068\u30b5\u30fc\u30d0\u30fc\u30b5\u30a4\u30c9\u30ec\u30f3\u30c0\u30ea\u30f3\u30b0\u3067\u304d\u308b\u3082\u306e\u3068\u3070\u304b\u308a\u601d\u3063\u3066\u3044\u305f\u3093\u3067\u3059\u304c\u3001\u30b5\u30fc\u30d0\u30fc\u30b5\u30a4\u30c9\u3067\u3069\u3053\u307e\u3067\u30c7\u30fc\u30bf\u3092\u7528\u610f\u3059\u308b\u304b\u3068\u3044\u3046\u70b9\u3092\u3057\u3063\u304b\u308a\u8003\u3048\u51fa\u3059\u3068\u3001\u7d50\u69cb\u96e3\u3057\u3044\u554f\u984c\u306b\u306a\u308a\u307e\u3059\u3002\n\n\u53c2\u8003\u306b\u3057\u305f\u30bd\u30fc\u30b9\u3067\u306fstatic\u306b\u5b9a\u7fa9\u3057\u305f\u30c7\u30fc\u30bf\u53d6\u5f97\u95a2\u6570\u3092\u30b5\u30fc\u30d0\u30fc/\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u30b5\u30a4\u30c9\u3067\u4f7f\u3044\u56de\u3059\u524d\u63d0\u3068\u306a\u3063\u3066\u3044\u308b\u3082\u306e\u304c\u591a\u304b\u3063\u305f\u306e\u3067\u3059\u304c\u3001\u3042\u308b\u7a0b\u5ea6\u306e\u8907\u96d1\u3055\u304c\u3042\u308b\u30b5\u30fc\u30d3\u30b9\u3067\u306f\u3042\u307e\u308a\u73fe\u5b9f\u7684\u3067\u306f\u306a\u3044\u6c17\u3082\u3057\u307e\u3059\u3002\n"}