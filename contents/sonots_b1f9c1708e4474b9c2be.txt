{"context": " More than 1 year has passed since last update.\u3084\u308a\u305f\u3044\u3053\u3068: \u624b\u5143\u3067\u306f\u30c6\u30b9\u30c8\u304c\u901a\u308b\u306e\u306b\u3001drone \u3067\u306f\u30c6\u30b9\u30c8\u304c\u901a\u3089\u306a\u3044\u3068\u306a\u3063\u3066\u3001\u8a66\u3059\u305f\u3081\u306b\u4e00\u304b\u3089CI\u3092\u56de\u3059\u3001\u3068\u306a\u308b\u3068\u3044\u304f\u3089\u6642\u9593\u304c\u3042\u3063\u3066\u3082\u8db3\u308a\u306a\u3044\u306e\u3067\u3001drone.io \u304c\u3084\u3063\u3066\u308b\u306e\u3068\u540c\u7b49\u306e\u64cd\u4f5c\u3092\u884c\u3063\u3066\u3001\u76f4\u63a5\u30b3\u30f3\u30c6\u30ca\u306b\u5165\u3063\u3066\u30c7\u30d0\u30b0\u3057\u305f\u3044\u3002\n\n.drone.yml\n\u3053\u308c\u3092\u518d\u73fe\u3057\u305f\u3044\u3068\u3059\u308b\nimage: \"bradrydzewski/ruby:2.0.0\"\nenv:\n  - RAILS_ENV=test\ngit:\n  depth: 1\nscript:\n  - bundle install\n  - bundle exec rake db:create db:migrate\n  - bundle exec rspec\nservices:\n  - mysql\n  - redis\n\n\n\u30b5\u30fc\u30d3\u30b9(mysql, redis)\u30b3\u30f3\u30c6\u30ca\u306e\u7acb\u3061\u4e0a\u3052\n# docker images\nREPOSITORY            TAG                 IMAGE ID            CREATED             VIRTUAL SIZE\nbradrydzewski/ruby    2.0.0               234bd8089bce        19 months ago       3.535 GB\nbradrydzewski/base    latest              00fb4af118c1        19 months ago       3.535 GB\nbradrydzewski/mysql   5.5                 9add88089b3c        19 months ago       351.3 MB\nbradrydzewski/redis   2.8                 9f0d1136eb85        19 months ago       240.9 MB\n\nmysql, redis \u30b3\u30f3\u30c6\u30ca\u3092\u7acb\u3061\u4e0a\u3052\u308b\u3002\u672c\u6765\u306f\u30db\u30b9\u30c8\u5074\u306e\u30dd\u30fc\u30c8\u30de\u30c3\u30d4\u30f3\u30b0\u306f\u30e9\u30f3\u30c0\u30e0\u306a\u306e\u3060\u304c\u3001mysql, redis \u306e\u30dd\u30fc\u30c8\u756a\u53f7\u306b\u305d\u308c\u305e\u308c 10000 \u8db3\u3057\u305f\u30dd\u30fc\u30c8\u756a\u53f7\u306b\u3057\u3066\u307f\u3066\u3044\u308b\u3002\ndocker run -d -p 13306:3306 bradrydzewski/mysql:5.5\ndocker run -d -p 16379:6379 bradrydzewski/redis:2.8\n\n\u60c5\u5831\n\u3053\u3093\u306a\u304b\u3093\u3058\u306b\u306a\u308b\u306f\u305a\u306a\u306e\u3067\u78ba\u8a8d\u3057\u3066\u307f\u3066\u304f\u3060\u3055\u3044\n\u6ce8\u8a18: 192.268.*.* \u306f\u901a\u5e38\u74b0\u5883\u3067\u306f 172.17.*.* \u306b\u306a\u308b\u306f\u305a\u3002\u81ea\u5206\u306e\u74b0\u5883\u3067\u306f docker0 \u306e\u30b5\u30d6\u30cd\u30c3\u30c8\u3092 172.17.0.0/16 \u304b\u3089 192.168.5.0/24 \u306b\u5909\u3048\u3066\u3044\u308b\u305f\u3081\u3002\n# docker ps\nCONTAINER ID        IMAGE                     COMMAND                CREATED             STATUS              PORTS                     NAMES\nb006383aaeb6        bradrydzewski/redis:2.8   \"/usr/bin/redis-serv   5 seconds ago       Up 4 seconds        0.0.0.0:16379->6379/tcp   nostalgic_mestorf\n3965a5958664        bradrydzewski/mysql:5.5   \"/bin/sh -c \\\"/usr/s   10 seconds ago      Up 9 seconds        0.0.0.0:13306->3306/tcp   adoring_darwin\n\n# ps -ef | grep docker\nroot     19335 32520  0 02:11 ?        00:00:00 docker-proxy -proto tcp -host-ip 0.0.0.0 -host-port 13306 -container-ip 192.168.5.55 -container-port 3306\nroot     19436 32520  0 02:12 ?        00:00:00 docker-proxy -proto tcp -host-ip 0.0.0.0 -host-port 16379 -container-ip 192.168.5.56 -container-port 6379\n\n# iptables-save | grep -v \"^#\"\n*nat\n:PREROUTING ACCEPT [18:1330]\n:INPUT ACCEPT [18:1330]\n:OUTPUT ACCEPT [0:0]\n:POSTROUTING ACCEPT [0:0]\n:DOCKER - [0:0]\n-A PREROUTING -m addrtype --dst-type LOCAL -j DOCKER\n-A OUTPUT ! -d 127.0.0.0/8 -m addrtype --dst-type LOCAL -j DOCKER\n-A POSTROUTING -s 192.168.5.0/24 ! -o docker0 -j MASQUERADE\n-A POSTROUTING -s 192.168.5.55/32 -d 192.168.5.55/32 -p tcp -m tcp --dport 3306 -j MASQUERADE\n-A POSTROUTING -s 192.168.5.56/32 -d 192.168.5.56/32 -p tcp -m tcp --dport 6379 -j MASQUERADE\n-A DOCKER ! -i docker0 -p tcp -m tcp --dport 13306 -j DNAT --to-destination 192.168.5.55:3306\n-A DOCKER ! -i docker0 -p tcp -m tcp --dport 16379 -j DNAT --to-destination 192.168.5.56:6379\nCOMMIT\n*filter\n:INPUT ACCEPT [151:25433]\n:FORWARD ACCEPT [0:0]\n:OUTPUT ACCEPT [162:21546]\n:DOCKER - [0:0]\n-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT\n-A INPUT -p icmp -j ACCEPT\n-A INPUT -i lo -j ACCEPT\n-A INPUT -p tcp -m state --state NEW -m tcp -j ACCEPT\n-A FORWARD -o docker0 -j DOCKER\n-A FORWARD -o docker0 -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT\n-A FORWARD -i docker0 ! -o docker0 -j ACCEPT\n-A FORWARD -i docker0 -o docker0 -j ACCEPT\n-A DOCKER -d 192.168.5.55/32 ! -i docker0 -o docker0 -p tcp -m tcp --dport 3306 -j ACCEPT\n-A DOCKER -d 192.168.5.56/32 ! -i docker0 -o docker0 -p tcp -m tcp --dport 6379 -j ACCEPT\nCOMMIT\n\n\nruby \u30b3\u30f3\u30c6\u30ca\u306e\u7acb\u3061\u4e0a\u3052\u304a\u3088\u3073\u30dd\u30fc\u30c8\u30d5\u30a9\u30ef\u30fc\u30c9\n\u30b3\u30f3\u30c6\u30ca\u3092\u7acb\u3061\u4e0a\u3052\u3064\u3064\u3001bash \u3092\u7acb\u3061\u4e0a\u3052\u3066\u4e2d\u306b\u5165\u308b\u3002\n# docker run -i -t bradrydzewski/ruby:2.0.0 /bin/bash\n\ndrone \u306f socat \u3068\u3044\u3046\u72ec\u81ea\u306e\u30b3\u30de\u30f3\u30c9\u3067\u30b5\u30fc\u30d3\u30b9\u30b3\u30f3\u30c6\u30ca\u306e\u30dd\u30fc\u30c8\u3092 127.0.0.1 \u306b\u30d5\u30a9\u30ef\u30fc\u30c9\u3057\u3066\u3044\u308b\u3088\u3046\u306a\u306e\u3067\u3001\u305d\u308c\u3092\u771f\u4f3c\u3059\u308b(docker \u306e --link \u30aa\u30d7\u30b7\u30e7\u30f3\u306f\u4f7f\u3063\u3066\u3044\u306a\u3044\u3088\u3046\u3060)\u3002IP\u30a2\u30c9\u30ec\u30b9\u306f\u3001\u4e0a\u8ff0\u306e ps -ef | grep docker \u304b\u3089\u308f\u304b\u308b\u3002\nubuntu$ /usr/bin/socat TCP-LISTEN:3306,fork TCP:192.168.5.55:3306 &\nubuntu$ /usr/bin/socat TCP-LISTEN:6379,fork TCP:192.168.5.57:6379 &\n\n\u3053\u308c\u3067\u3001127.0.0.1:3306 \u3092\u6307\u5b9a\u3059\u308b\u3068\u3001docker0 \u3092\u901a\u3063\u3066\u3001iptables \u3092\u901a\u3063\u3066\u3001\u30b5\u30fc\u30d3\u30b9\u30b3\u30f3\u30c6\u30ca\u306b\u30d5\u30a9\u30ef\u30fc\u30c9\u3055\u308c\u308b\u3002cf. Drone - \u30b5\u30fc\u30d3\u30b9\u30b3\u30f3\u30c6\u30ca\u3078\u306e\u30dd\u30fc\u30c8\u30d5\u30a9\u30ef\u30fc\u30c7\u30a3\u30f3\u30b0\u3092\u3069\u3046\u3057\u3066\u3044\u308b\u306e\u304b\u8aad\u3093\u3067\u307f\u305f\n\n\u30c6\u30b9\u30c8\u3092\u6d41\u3059\n\u3042\u3068\u306f ruby \u30b3\u30f3\u30c6\u30ca\u3067\u3001drone \u306e console \u306b\u51fa\u3066\u6765\u308b\u30b3\u30de\u30f3\u30c9\u3092\u771f\u4f3c\u3059\u308c\u3070\u3088\u3044\u3002\nubuntu$ sudo chown ubuntu:ubuntu /var/cache/drone\nubuntu$ git clone --depth=1 --recursive --branch=master https://github.com/sonots/try_rails4 /var/cache/drone/try_rails4\nubuntu$ /var/cache/drone/try_rails4\nubuntu$ bundle install\nubuntu$ bundle exec rake db:create db:migrate\nubuntu$ bundle exec rspec\n\nNOTE: git clone \u3084 bundle install \u306b ssh \u9375\u304c\u5fc5\u8981\u306a\u5834\u5408\u306f\u3001~/.ssh/id_rsa \u306b\u9375\u306e\u767b\u9332\u304c\u5fc5\u8981\u3002drone \u306f Integrating with Github \u00b7 drone.io \u306b\u3042\u308b\u3088\u3046\u306b\u3001drone \u304c\u5185\u90e8\u3067\u79d8\u5bc6\u9375\u3092\u6301\u3061\u3001\u516c\u958b\u9375\u3092 deploy key \u3068\u3057\u3066\u767b\u9332\u3059\u308b\u3053\u3068\u3067\u3001git clone \u3067\u304d\u308b\u3088\u3046\u306b\u3057\u3066\u3044\u308b\u3002\n\n\u304a\u308f\u308a\u306b\n\u4f55\u304b\u9593\u9055\u3048\u3066\u3044\u305f\u308a\u3001\u3053\u306e\u65b9\u304c\u826f\u3044\u3001\u3068\u304b\u3042\u308c\u3070\u3064\u3063\u3053\u307f welcome\u3002private key \u5468\u308a\u306a\u3093\u3068\u304b\u3057\u305f\u3044\u3002\n**\u3084\u308a\u305f\u3044\u3053\u3068:** \u624b\u5143\u3067\u306f\u30c6\u30b9\u30c8\u304c\u901a\u308b\u306e\u306b\u3001drone \u3067\u306f\u30c6\u30b9\u30c8\u304c\u901a\u3089\u306a\u3044\u3068\u306a\u3063\u3066\u3001\u8a66\u3059\u305f\u3081\u306b\u4e00\u304b\u3089CI\u3092\u56de\u3059\u3001\u3068\u306a\u308b\u3068\u3044\u304f\u3089\u6642\u9593\u304c\u3042\u3063\u3066\u3082\u8db3\u308a\u306a\u3044\u306e\u3067\u3001drone.io \u304c\u3084\u3063\u3066\u308b\u306e\u3068\u540c\u7b49\u306e\u64cd\u4f5c\u3092\u884c\u3063\u3066\u3001\u76f4\u63a5\u30b3\u30f3\u30c6\u30ca\u306b\u5165\u3063\u3066\u30c7\u30d0\u30b0\u3057\u305f\u3044\u3002\n\n## .drone.yml\n\n\u3053\u308c\u3092\u518d\u73fe\u3057\u305f\u3044\u3068\u3059\u308b\n\n```yaml\nimage: \"bradrydzewski/ruby:2.0.0\"\nenv:\n  - RAILS_ENV=test\ngit:\n  depth: 1\nscript:\n  - bundle install\n  - bundle exec rake db:create db:migrate\n  - bundle exec rspec\nservices:\n  - mysql\n  - redis\n```\n\n## \u30b5\u30fc\u30d3\u30b9(mysql, redis)\u30b3\u30f3\u30c6\u30ca\u306e\u7acb\u3061\u4e0a\u3052\n\n```\n# docker images\nREPOSITORY            TAG                 IMAGE ID            CREATED             VIRTUAL SIZE\nbradrydzewski/ruby    2.0.0               234bd8089bce        19 months ago       3.535 GB\nbradrydzewski/base    latest              00fb4af118c1        19 months ago       3.535 GB\nbradrydzewski/mysql   5.5                 9add88089b3c        19 months ago       351.3 MB\nbradrydzewski/redis   2.8                 9f0d1136eb85        19 months ago       240.9 MB\n```\n\nmysql, redis \u30b3\u30f3\u30c6\u30ca\u3092\u7acb\u3061\u4e0a\u3052\u308b\u3002\u672c\u6765\u306f\u30db\u30b9\u30c8\u5074\u306e\u30dd\u30fc\u30c8\u30de\u30c3\u30d4\u30f3\u30b0\u306f\u30e9\u30f3\u30c0\u30e0\u306a\u306e\u3060\u304c\u3001mysql, redis \u306e\u30dd\u30fc\u30c8\u756a\u53f7\u306b\u305d\u308c\u305e\u308c 10000 \u8db3\u3057\u305f\u30dd\u30fc\u30c8\u756a\u53f7\u306b\u3057\u3066\u307f\u3066\u3044\u308b\u3002\n\n```\ndocker run -d -p 13306:3306 bradrydzewski/mysql:5.5\ndocker run -d -p 16379:6379 bradrydzewski/redis:2.8\n```\n\n\u60c5\u5831\n\n\u3053\u3093\u306a\u304b\u3093\u3058\u306b\u306a\u308b\u306f\u305a\u306a\u306e\u3067\u78ba\u8a8d\u3057\u3066\u307f\u3066\u304f\u3060\u3055\u3044\n\n\u6ce8\u8a18: `192.268.*.*` \u306f\u901a\u5e38\u74b0\u5883\u3067\u306f `172.17.*.*` \u306b\u306a\u308b\u306f\u305a\u3002\u81ea\u5206\u306e\u74b0\u5883\u3067\u306f docker0 \u306e\u30b5\u30d6\u30cd\u30c3\u30c8\u3092 172.17.0.0/16 \u304b\u3089 192.168.5.0/24 \u306b\u5909\u3048\u3066\u3044\u308b\u305f\u3081\u3002\n\n```\n# docker ps\nCONTAINER ID        IMAGE                     COMMAND                CREATED             STATUS              PORTS                     NAMES\nb006383aaeb6        bradrydzewski/redis:2.8   \"/usr/bin/redis-serv   5 seconds ago       Up 4 seconds        0.0.0.0:16379->6379/tcp   nostalgic_mestorf\n3965a5958664        bradrydzewski/mysql:5.5   \"/bin/sh -c \\\"/usr/s   10 seconds ago      Up 9 seconds        0.0.0.0:13306->3306/tcp   adoring_darwin\n```\n\n```\n# ps -ef | grep docker\nroot     19335 32520  0 02:11 ?        00:00:00 docker-proxy -proto tcp -host-ip 0.0.0.0 -host-port 13306 -container-ip 192.168.5.55 -container-port 3306\nroot     19436 32520  0 02:12 ?        00:00:00 docker-proxy -proto tcp -host-ip 0.0.0.0 -host-port 16379 -container-ip 192.168.5.56 -container-port 6379\n```\n\n```\n# iptables-save | grep -v \"^#\"\n*nat\n:PREROUTING ACCEPT [18:1330]\n:INPUT ACCEPT [18:1330]\n:OUTPUT ACCEPT [0:0]\n:POSTROUTING ACCEPT [0:0]\n:DOCKER - [0:0]\n-A PREROUTING -m addrtype --dst-type LOCAL -j DOCKER\n-A OUTPUT ! -d 127.0.0.0/8 -m addrtype --dst-type LOCAL -j DOCKER\n-A POSTROUTING -s 192.168.5.0/24 ! -o docker0 -j MASQUERADE\n-A POSTROUTING -s 192.168.5.55/32 -d 192.168.5.55/32 -p tcp -m tcp --dport 3306 -j MASQUERADE\n-A POSTROUTING -s 192.168.5.56/32 -d 192.168.5.56/32 -p tcp -m tcp --dport 6379 -j MASQUERADE\n-A DOCKER ! -i docker0 -p tcp -m tcp --dport 13306 -j DNAT --to-destination 192.168.5.55:3306\n-A DOCKER ! -i docker0 -p tcp -m tcp --dport 16379 -j DNAT --to-destination 192.168.5.56:6379\nCOMMIT\n*filter\n:INPUT ACCEPT [151:25433]\n:FORWARD ACCEPT [0:0]\n:OUTPUT ACCEPT [162:21546]\n:DOCKER - [0:0]\n-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT\n-A INPUT -p icmp -j ACCEPT\n-A INPUT -i lo -j ACCEPT\n-A INPUT -p tcp -m state --state NEW -m tcp -j ACCEPT\n-A FORWARD -o docker0 -j DOCKER\n-A FORWARD -o docker0 -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT\n-A FORWARD -i docker0 ! -o docker0 -j ACCEPT\n-A FORWARD -i docker0 -o docker0 -j ACCEPT\n-A DOCKER -d 192.168.5.55/32 ! -i docker0 -o docker0 -p tcp -m tcp --dport 3306 -j ACCEPT\n-A DOCKER -d 192.168.5.56/32 ! -i docker0 -o docker0 -p tcp -m tcp --dport 6379 -j ACCEPT\nCOMMIT\n```\n\n## ruby \u30b3\u30f3\u30c6\u30ca\u306e\u7acb\u3061\u4e0a\u3052\u304a\u3088\u3073\u30dd\u30fc\u30c8\u30d5\u30a9\u30ef\u30fc\u30c9\n\n\u30b3\u30f3\u30c6\u30ca\u3092\u7acb\u3061\u4e0a\u3052\u3064\u3064\u3001bash \u3092\u7acb\u3061\u4e0a\u3052\u3066\u4e2d\u306b\u5165\u308b\u3002\n\n```\n# docker run -i -t bradrydzewski/ruby:2.0.0 /bin/bash\n```\n\ndrone \u306f socat \u3068\u3044\u3046\u72ec\u81ea\u306e\u30b3\u30de\u30f3\u30c9\u3067\u30b5\u30fc\u30d3\u30b9\u30b3\u30f3\u30c6\u30ca\u306e\u30dd\u30fc\u30c8\u3092 127.0.0.1 \u306b\u30d5\u30a9\u30ef\u30fc\u30c9\u3057\u3066\u3044\u308b\u3088\u3046\u306a\u306e\u3067\u3001\u305d\u308c\u3092\u771f\u4f3c\u3059\u308b(docker \u306e --link \u30aa\u30d7\u30b7\u30e7\u30f3\u306f\u4f7f\u3063\u3066\u3044\u306a\u3044\u3088\u3046\u3060)\u3002IP\u30a2\u30c9\u30ec\u30b9\u306f\u3001\u4e0a\u8ff0\u306e `ps -ef | grep docker` \u304b\u3089\u308f\u304b\u308b\u3002\n\n```\nubuntu$ /usr/bin/socat TCP-LISTEN:3306,fork TCP:192.168.5.55:3306 &\nubuntu$ /usr/bin/socat TCP-LISTEN:6379,fork TCP:192.168.5.57:6379 &\n```\n\n\u3053\u308c\u3067\u3001127.0.0.1:3306 \u3092\u6307\u5b9a\u3059\u308b\u3068\u3001docker0 \u3092\u901a\u3063\u3066\u3001iptables \u3092\u901a\u3063\u3066\u3001\u30b5\u30fc\u30d3\u30b9\u30b3\u30f3\u30c6\u30ca\u306b\u30d5\u30a9\u30ef\u30fc\u30c9\u3055\u308c\u308b\u3002cf. [Drone - \u30b5\u30fc\u30d3\u30b9\u30b3\u30f3\u30c6\u30ca\u3078\u306e\u30dd\u30fc\u30c8\u30d5\u30a9\u30ef\u30fc\u30c7\u30a3\u30f3\u30b0\u3092\u3069\u3046\u3057\u3066\u3044\u308b\u306e\u304b\u8aad\u3093\u3067\u307f\u305f](http://qiita.com/udzura/items/221c03e19e5e122a0d54)\n\n## \u30c6\u30b9\u30c8\u3092\u6d41\u3059\n\n\u3042\u3068\u306f ruby \u30b3\u30f3\u30c6\u30ca\u3067\u3001drone \u306e console \u306b\u51fa\u3066\u6765\u308b\u30b3\u30de\u30f3\u30c9\u3092\u771f\u4f3c\u3059\u308c\u3070\u3088\u3044\u3002\n\n```\nubuntu$ sudo chown ubuntu:ubuntu /var/cache/drone\nubuntu$ git clone --depth=1 --recursive --branch=master https://github.com/sonots/try_rails4 /var/cache/drone/try_rails4\nubuntu$ /var/cache/drone/try_rails4\nubuntu$ bundle install\nubuntu$ bundle exec rake db:create db:migrate\nubuntu$ bundle exec rspec\n```\n\nNOTE: git clone \u3084 bundle install \u306b ssh \u9375\u304c\u5fc5\u8981\u306a\u5834\u5408\u306f\u3001~/.ssh/id_rsa \u306b\u9375\u306e\u767b\u9332\u304c\u5fc5\u8981\u3002drone \u306f [Integrating with Github \u00b7 drone.io](http://docs.drone.io/github.html) \u306b\u3042\u308b\u3088\u3046\u306b\u3001drone \u304c\u5185\u90e8\u3067\u79d8\u5bc6\u9375\u3092\u6301\u3061\u3001\u516c\u958b\u9375\u3092 deploy key \u3068\u3057\u3066\u767b\u9332\u3059\u308b\u3053\u3068\u3067\u3001git clone \u3067\u304d\u308b\u3088\u3046\u306b\u3057\u3066\u3044\u308b\u3002\n\n## \u304a\u308f\u308a\u306b\n\n\u4f55\u304b\u9593\u9055\u3048\u3066\u3044\u305f\u308a\u3001\u3053\u306e\u65b9\u304c\u826f\u3044\u3001\u3068\u304b\u3042\u308c\u3070\u3064\u3063\u3053\u307f welcome\u3002private key \u5468\u308a\u306a\u3093\u3068\u304b\u3057\u305f\u3044\u3002\n", "tags": ["drone.io"]}