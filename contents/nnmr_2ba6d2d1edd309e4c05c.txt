{"context": "https://www.varnish-cache.org/docs/trunk/phk/ssl_again.html\n\nNo, Varnish still won't add SSL/TLS support.\n\nvarnish5.0.0\u3067\u3082ssl\u306e\u5bfe\u5fdc\u306f\u3057\u306a\u3044\u3089\u3057\u3044\u306e\u3067\u3059\u304c\u3001\n\nInstead in Varnish 4.1 we have added support for Willys PROXY protocol which makes it possible to communicate the extra details from a SSL-terminating proxy, such as HAProxy, to Varnish.\n\nHAProxy\u3092\u4f7f\u3048\u3070\u305d\u308c\u3063\u307d\u304f\u306f\u306a\u308a\u307e\u3059\u3088\u3068\u306e\u3053\u3068\u3060\u3063\u305f\u306e\u3067\u8a2d\u5b9a\u3057\u3066\u307f\u307e\u3057\u305f\u3002\nvarnish\u3068\u3044\u3048\u3070\u3001\u4ee5\u524d\u304b\u3089ssl\u975e\u5bfe\u5fdc\u3067\u3001ssl\u5bfe\u5fdc\u306e\u305f\u3081\u306bLB\u3068\u3057\u3066nginx\u7b49\u3092\u5165\u308c\u308b\u3068\u3044\u3046\u3084\u308a\u65b9\u304c\u4ee5\u524d\u304b\u3089\u3042\u308a\u307e\u3059\u304c\u3001\u3053\u308c\u306f\u305d\u306enginx\u306e\u5f79\u5272\u3092HAProxy\u3067\u3084\u3063\u3066\u3044\u308b\u3088\u3046\u306a\u3082\u306e\u3067\u3059\u3002\n\n\u5404\u30d0\u30fc\u30b8\u30e7\u30f3\u306e\u60c5\u5831\n\nHA-Proxy 1.5.4\nvarnish 4.1.3\nh2o 2.0.4\n\n\n\u53c2\u8003\u306b\u3057\u305f\u30da\u30fc\u30b8\n\u3053\u3061\u3089\u3092\u53c2\u8003\u306b\u8a2d\u5b9a\u3057\u3066\u307f\u3066\u3001\u3046\u307e\u304f\u3044\u304b\u306a\u304b\u3063\u305f\u3089\u4ee5\u4e0b\u306e\u624b\u9806\u3092\u78ba\u8a8d\u3059\u308b\u65b9\u304c\u826f\u3044\u304b\u3082\u3057\u308c\u306a\u3044\u306e\u3067\u5148\u306b\u8a18\u8f09\u3057\u307e\u3059\u3002\nhttps://blog.feryn.eu/varnish-4-1-haproxy-get-the-real-ip-by-leveraging-proxy-protocol-support/\n\nvarnish\u306e\u8a2d\u5b9a\n\n/etc/varnish/default.vcl\u306e\u7de8\u96c6\n\ndefault.vcl\n# Default backend definition. Set this to point to your content server.\nbackend default {\n    .host = \"127.0.0.1\";\n    .port = \"8080\";\n}\n\nsub vcl_recv {\n    set req.http.x-clientip = client.ip;\n    set req.http.x-serverip = server.ip;\n    set req.http.x-localip = local.ip;\n    set req.http.x-remoteip = remote.ip;\n}\n\n\nbackend default\u306fh2o\u5074\u3067\u5bc4\u305b\u308b\u305f\u3081\u3001\u30c7\u30d5\u30a9\u30eb\u30c8\u306e\u307e\u307e\u306b\u3057\u307e\u3057\u305f\u3002\nvcl_recv\u306f\u4f55\u884c\u304b\u8ffd\u52a0\u3057\u3066\u3044\u307e\u3059\u3002\n\nvarnish\u306e\u518d\u8d77\u52d5\n[test-web01 ~]# /etc/init.d/varnish restart\nStopping Varnish Cache:                                    [  OK  ]\nStarting Varnish Cache:                                    [  OK  ]\nYou have new mail in /var/spool/mail/root\n[test-web01 ~]# \n\n\u7279\u306b\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3057\u306a\u3051\u308c\u3070OK\u3067\u3059\u3002\n\nHAProxy\u306e\u8a2d\u5b9a\n\n/etc/haproxy/haproxy.cfg\u306e\u4fee\u6b63\n\u8a8d\u8a3c\u7528\u306e\u30b5\u30fc\u30d0\u30fc\u8a3c\u660e\u66f8\u306e\u6e96\u5099\u304c\u5fc5\u8981\u3067\u3059\u3002\n\nhaproxy.cfg\nfrontend http-in\n        bind *:80\n\u3000\u3000\u3000\u3000\u3000\u3000\u3000\u3000\u3000\u3000\u3000\u3000\u3000\u3000\u3000\u3000bind *:443 ssl crt /****/****/****/****.pem\n        default_backend servers\n\nbackend servers\n        server server1 127.0.0.1:6081\n\n\n\nHAProxy\u306e\u518d\u8d77\u52d5\n\u7279\u306b\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3057\u306a\u3051\u308c\u3070OK\u3067\u3059\u3002\n\u8a8d\u8a3c\u5468\u308a\u3067warning\u304c\u767a\u751f\u3059\u308b\u3053\u3068\u304c\u3042\u308a\u307e\u3059\u304c\u3001error\u3067\u306a\u3051\u308c\u3070\u4e00\u5148\u305a\u554f\u984c\u306a\u3044\u3067\u3059\u3002\n[test-web01 ~]# /etc/init.d/haproxy restart\nEnter PEM pass phrase:\nStopping haproxy:                                          [  OK  ]\nEnter PEM pass phrase:\nStarting haproxy: Enter PEM pass phrase:\n                                                           [  OK  ]\n[test-web01 ~]# \n\n\nh2o\u306e\u8a2d\u5b9a\n\n/etc/h2o/h2o.conf\u306e\u4fee\u6b63\n\u3082\u3057\u3001\u30c7\u30d5\u30a9\u30eb\u30c8\u306e\u307e\u307e\u3067\u3042\u308c\u3070\u3001localhost:80\u306eport\u30928080\u306b\u5909\u66f4\u3057\u307e\u3059\u3002\nlocalhost:443\u306e\u8a2d\u5b9a\u304c\u3042\u3063\u305f\u304b\u3068\u601d\u3044\u307e\u3059\u304c\u3001varnish\u5074\u304b\u3089h2o\u306b\u5bfe\u3057\u3066443\u3067\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3053\u3068\u306f\u306a\u3044\u306e\u3067\u3001\u305d\u306e\u307e\u307e\u306b\u3059\u308b\u304b\u524a\u9664\u3092\u3057\u3066\u3057\u307e\u3063\u3066\u554f\u984c\u3042\u308a\u307e\u305b\u3093\u3002\n\nh2o.conf\nuser: nobody\nhosts:\n  \"localhost:80\":\n    listen:\n      port: 8080\n      host: 0.0.0.0\n    paths:\n      \"/\":\n        file.dir: /var/www/html\naccess-log: /var/log/h2o/access.log\nerror-log: /var/log/h2o/error.log\npid-file: /var/run/h2o/h2o.pid\n\n\n\nh2o\u306e\u518d\u8d77\u52d5\n\u7279\u306b\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3057\u306a\u3051\u308c\u3070OK\u3067\u3059\u3002\n[test-web01 ~]# /etc/init.d/h2o restart\nStopping h2o:                                              [  OK  ]\nStarting h2o: start_server (pid:9908) starting now...\n                                                           [  OK  ]\n[test-web01 ~]# \n\n\n\u30d6\u30e9\u30a6\u30b6\u3067\u78ba\u8a8d\n\nhttp\u3067\u30a2\u30af\u30bb\u30b9\n\n\nhttps\u3067\u30a2\u30af\u30bb\u30b9\n\nvarnish\u304c\u52d5\u4f5c\u3057\u3001\u304b\u3064http,https\u3069\u3061\u3089\u3067\u3082\u30a2\u30af\u30bb\u30b9\u304c\u3067\u304d\u308b\u3053\u3068\u304c\u78ba\u8a8d\u3067\u304d\u307e\u3057\u305f\u3002\nhttps://www.varnish-cache.org/docs/trunk/phk/ssl_again.html\n\n> No, Varnish still won't add SSL/TLS support.\n\nvarnish5.0.0\u3067\u3082ssl\u306e\u5bfe\u5fdc\u306f\u3057\u306a\u3044\u3089\u3057\u3044\u306e\u3067\u3059\u304c\u3001\n\n> Instead in Varnish 4.1 we have added support for Willys PROXY protocol which makes it possible to communicate the extra details from a SSL-terminating proxy, such as HAProxy, to Varnish.\n\n**HAProxy\u3092\u4f7f\u3048\u3070\u305d\u308c\u3063\u307d\u304f\u306f\u306a\u308a\u307e\u3059\u3088**\u3068\u306e\u3053\u3068\u3060\u3063\u305f\u306e\u3067\u8a2d\u5b9a\u3057\u3066\u307f\u307e\u3057\u305f\u3002\nvarnish\u3068\u3044\u3048\u3070\u3001\u4ee5\u524d\u304b\u3089ssl\u975e\u5bfe\u5fdc\u3067\u3001ssl\u5bfe\u5fdc\u306e\u305f\u3081\u306bLB\u3068\u3057\u3066nginx\u7b49\u3092\u5165\u308c\u308b\u3068\u3044\u3046\u3084\u308a\u65b9\u304c\u4ee5\u524d\u304b\u3089\u3042\u308a\u307e\u3059\u304c\u3001\u3053\u308c\u306f\u305d\u306enginx\u306e\u5f79\u5272\u3092HAProxy\u3067\u3084\u3063\u3066\u3044\u308b\u3088\u3046\u306a\u3082\u306e\u3067\u3059\u3002\n\n# \u5404\u30d0\u30fc\u30b8\u30e7\u30f3\u306e\u60c5\u5831\n\n* HA-Proxy 1.5.4\n* varnish 4.1.3\n* h2o 2.0.4\n\n# \u53c2\u8003\u306b\u3057\u305f\u30da\u30fc\u30b8\n\n\u3053\u3061\u3089\u3092\u53c2\u8003\u306b\u8a2d\u5b9a\u3057\u3066\u307f\u3066\u3001\u3046\u307e\u304f\u3044\u304b\u306a\u304b\u3063\u305f\u3089\u4ee5\u4e0b\u306e\u624b\u9806\u3092\u78ba\u8a8d\u3059\u308b\u65b9\u304c\u826f\u3044\u304b\u3082\u3057\u308c\u306a\u3044\u306e\u3067\u5148\u306b\u8a18\u8f09\u3057\u307e\u3059\u3002\nhttps://blog.feryn.eu/varnish-4-1-haproxy-get-the-real-ip-by-leveraging-proxy-protocol-support/\n\n# varnish\u306e\u8a2d\u5b9a\n\n## `/etc/varnish/default.vcl`\u306e\u7de8\u96c6\n\n```default.vcl\n# Default backend definition. Set this to point to your content server.\nbackend default {\n    .host = \"127.0.0.1\";\n    .port = \"8080\";\n}\n\nsub vcl_recv {\n    set req.http.x-clientip = client.ip;\n    set req.http.x-serverip = server.ip;\n    set req.http.x-localip = local.ip;\n    set req.http.x-remoteip = remote.ip;\n}\n```\n\n`backend default`\u306fh2o\u5074\u3067\u5bc4\u305b\u308b\u305f\u3081\u3001\u30c7\u30d5\u30a9\u30eb\u30c8\u306e\u307e\u307e\u306b\u3057\u307e\u3057\u305f\u3002\n`vcl_recv`\u306f\u4f55\u884c\u304b\u8ffd\u52a0\u3057\u3066\u3044\u307e\u3059\u3002\n\n## varnish\u306e\u518d\u8d77\u52d5\n\n```\n[test-web01 ~]# /etc/init.d/varnish restart\nStopping Varnish Cache:                                    [  OK  ]\nStarting Varnish Cache:                                    [  OK  ]\nYou have new mail in /var/spool/mail/root\n[test-web01 ~]# \n```\n\n\u7279\u306b\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3057\u306a\u3051\u308c\u3070OK\u3067\u3059\u3002\n\n# HAProxy\u306e\u8a2d\u5b9a\n\n## `/etc/haproxy/haproxy.cfg`\u306e\u4fee\u6b63\n\n\u8a8d\u8a3c\u7528\u306e\u30b5\u30fc\u30d0\u30fc\u8a3c\u660e\u66f8\u306e\u6e96\u5099\u304c\u5fc5\u8981\u3067\u3059\u3002\n\n```text:haproxy.cfg\nfrontend http-in\n        bind *:80\n\u3000\u3000\u3000\u3000\u3000\u3000\u3000\u3000\u3000\u3000\u3000\u3000\u3000\u3000\u3000\u3000bind *:443 ssl crt /****/****/****/****.pem\n        default_backend servers\n\nbackend servers\n        server server1 127.0.0.1:6081\n```\n\n## HAProxy\u306e\u518d\u8d77\u52d5\n\n\u7279\u306b\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3057\u306a\u3051\u308c\u3070OK\u3067\u3059\u3002\n\u8a8d\u8a3c\u5468\u308a\u3067warning\u304c\u767a\u751f\u3059\u308b\u3053\u3068\u304c\u3042\u308a\u307e\u3059\u304c\u3001error\u3067\u306a\u3051\u308c\u3070\u4e00\u5148\u305a\u554f\u984c\u306a\u3044\u3067\u3059\u3002\n\n```\n[test-web01 ~]# /etc/init.d/haproxy restart\nEnter PEM pass phrase:\nStopping haproxy:                                          [  OK  ]\nEnter PEM pass phrase:\nStarting haproxy: Enter PEM pass phrase:\n                                                           [  OK  ]\n[test-web01 ~]# \n```\n\n# h2o\u306e\u8a2d\u5b9a\n\n## `/etc/h2o/h2o.conf`\u306e\u4fee\u6b63\n\n\u3082\u3057\u3001\u30c7\u30d5\u30a9\u30eb\u30c8\u306e\u307e\u307e\u3067\u3042\u308c\u3070\u3001`localhost:80`\u306eport\u3092`8080`\u306b\u5909\u66f4\u3057\u307e\u3059\u3002\n`localhost:443`\u306e\u8a2d\u5b9a\u304c\u3042\u3063\u305f\u304b\u3068\u601d\u3044\u307e\u3059\u304c\u3001varnish\u5074\u304b\u3089h2o\u306b\u5bfe\u3057\u3066443\u3067\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3053\u3068\u306f\u306a\u3044\u306e\u3067\u3001\u305d\u306e\u307e\u307e\u306b\u3059\u308b\u304b\u524a\u9664\u3092\u3057\u3066\u3057\u307e\u3063\u3066\u554f\u984c\u3042\u308a\u307e\u305b\u3093\u3002\n\n```h2o.conf\nuser: nobody\nhosts:\n  \"localhost:80\":\n    listen:\n      port: 8080\n      host: 0.0.0.0\n    paths:\n      \"/\":\n        file.dir: /var/www/html\naccess-log: /var/log/h2o/access.log\nerror-log: /var/log/h2o/error.log\npid-file: /var/run/h2o/h2o.pid\n```\n\n## h2o\u306e\u518d\u8d77\u52d5\n\n\u7279\u306b\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3057\u306a\u3051\u308c\u3070OK\u3067\u3059\u3002\n\n```\n[test-web01 ~]# /etc/init.d/h2o restart\nStopping h2o:                                              [  OK  ]\nStarting h2o: start_server (pid:9908) starting now...\n                                                           [  OK  ]\n[test-web01 ~]# \n```\n\n# \u30d6\u30e9\u30a6\u30b6\u3067\u78ba\u8a8d\n\n## http\u3067\u30a2\u30af\u30bb\u30b9\n\n<img width=\"515\" alt=\"http\u3067\u30a2\u30af\u30bb\u30b9\" src=\"https://qiita-image-store.s3.amazonaws.com/0/57635/06acf447-a4a0-2a30-3224-d264bccb1ffa.png\">\n\n## https\u3067\u30a2\u30af\u30bb\u30b9\n\n<img width=\"508\" alt=\"https\u3067\u30a2\u30af\u30bb\u30b9\" src=\"https://qiita-image-store.s3.amazonaws.com/0/57635/3e2c1cc2-47b5-2a26-4a11-8567381f3998.png\">\n\nvarnish\u304c\u52d5\u4f5c\u3057\u3001\u304b\u3064http,https\u3069\u3061\u3089\u3067\u3082\u30a2\u30af\u30bb\u30b9\u304c\u3067\u304d\u308b\u3053\u3068\u304c\u78ba\u8a8d\u3067\u304d\u307e\u3057\u305f\u3002\n", "tags": ["haproxy", "Varnish", "h2o"]}