{"context": "Magento Advent Calender 2016\u306e\u30cd\u30bf\u3092\u63a2\u3057\u3066\u3044\u305f\u3068\u3053\u308dGoogle Cloud Platform\u306e\u30c8\u30e9\u30a4\u30a2\u30eb\u304c60\u65e5\u9593$300\u307e\u3067\u7121\u6599\u304c\u76ee\u306b\u5165\u3063\u305f\u306e\u306811\u6708\u304b\u3089\u6771\u4eac\u30ea\u30fc\u30b8\u30e7\u30f3\u304c\u6b63\u5f0f\u904b\u7528\u3055\u308c\u305f\u3053\u3068\u304c\u6c17\u306b\u306a\u3063\u3066\u3044\u305f\u306e\u3067\u3053\u308c\u5e78\u3044\u3068\u69cb\u7bc9\u3057\u3066\u307f\u307e\u3057\u305f\n\n\u30b4\u30fc\u30eb\n\u30a4\u30f3\u30bf\u30fc\u30cd\u30c3\u30c8 - Load Balancing\uff08\u8ca0\u8377\u5206\u6563\uff09 - [Magento2 - Redis] - Cloud SQL\n\nVM \u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u4f5c\u6210\n\n\u30d9\u30fc\u30b9\u3068\u306a\u308bVM\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u4f5c\u6210\nBitnami\u306eMagento2\u3092Compute Engine\u4e0a\u3067\u8d77\u52d5\u3057\u3066\u30d9\u30fc\u30b9\u3068\u306a\u308b\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n\u69cb\u6210\uff082016/12/15\u6642\u70b9\u30fb\u629c\u7c8b\uff09\n\nDebian (8)\nApache (2.4.23)\nMagento (2.1.2)\nMemcached (1.4.31)\nMySQL (5.7.15)\nPHP (7.0.11)\nVarnish (4.1.0)\n\nZone\u306fasia-northeast1-a,b,c\u306e\u3044\u305a\u308c\u304b\uff08\u6771\u4eac\u30ea\u30fc\u30b8\u30e7\u30f3\uff09\u3092\u9078\u3093\u3067\u304f\u3060\u3055\u3044\u3002Magento2\u306f\u30e1\u30e2\u30ea\u3092\u7d50\u69cb\u6d88\u8cbb\u3059\u308b\u306e\u3067n1-standard-2\u3092\u9078\u629e\u3057\u3066\u3044\u307e\u3059\u3002Cloud SQL\u3092\u4f7f\u3046\u306e\u3067\u30c7\u30a3\u30b9\u30afI/O\u306f\u6c17\u306b\u3057\u306a\u3044\u3068\u3044\u3046\u3053\u3068\u3067Disk type\u306fStandard Persistent Disk\u3092\u9078\u3093\u3067\u3044\u307e\u3059\u3002External IP\u306fEphemeral\uff08\u9759\u7684IP\u3058\u3083\u306a\u3044\u3084\u3064\uff09\u3092\u5272\u308a\u5f53\u3066\u307e\u3059\u3002\n\u8d77\u52d5\u3057\u3066\u308f\u304b\u3063\u305f\u306e\u3067\u3059\u304c\u3001Varnish\u304c80\u756a\u30dd\u30fc\u30c8\u3067\u5f85\u3061\u53d7\u3051\u3066\u3044\u307e\u3057\u305f\u3002apache\u306f81\u756a\u3068443\u756a\u3067\u3059\u306d\u3002\u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b5\u3067SSL Termination\u3057\u306680\u756a\u306b\u6e21\u305b\u3089\u308c\u308c\u3070\u826f\u3044\u3067\u3059\u306d\u3002\n\n\u30c7\u30d7\u30ed\u30a4\u76f4\u5f8c\u306e\u753b\u9762\u3067\u3059\u3002\u7ba1\u7406\u753b\u9762\u306e\u30d1\u30b9\u30ef\u30fc\u30c9\u3082\u81ea\u52d5\u751f\u6210\u3055\u308c\u3066\u3044\u308b\u306e\u3067\u3053\u306e\u307e\u307e\u3067\u3082Site Address\u304b\u3089\u30a2\u30af\u30bb\u30b9\u53ef\u80fd\u3067\u3059\u3002Magento2\u306b\u6700\u9069\u5316\u3055\u308c\u305f\u69cb\u6210\u306b\u306a\u3063\u3066\u3044\u308b\u305f\u3081\u30b9\u30c8\u30ec\u30b9\u306a\u304f\u52d5\u4f5c\u3057\u3066\u3044\u307e\u3059\u304c\u3001\u5c11\u3057\u3065\u3064\u9ad8\u901f\u5316\u3057\u3066\u3044\u304d\u307e\u3059\u3002\n\u4f5c\u6210\u3057\u305fVM\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u8a2d\u5b9a\u3092\u78ba\u8a8d\u3059\u308b\u3068\u3001\u30c7\u30d5\u30a9\u30eb\u30c8\u306e\u30a2\u30af\u30bb\u30b9\u6a29\u304c\u9069\u7528\u3055\u308c\u3066\u3044\u308b\u305f\u3081Cloud API \u30a2\u30af\u30bb\u30b9\u7bc4\u56f2\u304c\u307b\u3068\u3093\u3069\u7121\u52b9\u5316\u3055\u308c\u3066\u3044\u307e\u3057\u305f\u3002\u4eca\u56de\u306e\u624b\u9806\u7684\u306b\u306fCloud SQL\u3068\u30b9\u30c8\u30ec\u30fc\u30b8\u3092\u6709\u52b9\u5316\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002Cloud SQL Proxy\u306e\u30ea\u30d5\u30a1\u30ec\u30f3\u30b9\u306b\u3082\u66f8\u3044\u3066\u3042\u308a\u307e\u3059\u304c\u30a2\u30af\u30bb\u30b9\u7bc4\u56f2\u3092\u5909\u66f4\u3067\u304d\u308b\u306e\u306f\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u4f5c\u6210\u6642\u306a\u306e\u3067\u3001\u5b8c\u5168\u306b\u7121\u99c4\u306a\u4f5c\u696d\u3067\u3059\u304c\u4f5c\u6210\u3057\u305fVM\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u30d9\u30fc\u30b9\u306b\u518d\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n\nVM\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u30b3\u30d4\u30fc\nVM\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u505c\u6b62\u3057\u307e\u3059\u3002\n\u7d9a\u3044\u3066\u30e1\u30cb\u30e5\u30fc\u304b\u3089\u30b9\u30ca\u30c3\u30d7\u30b7\u30e7\u30c3\u30c8\u3092\u9078\u3093\u3067\u300c\u30b9\u30ca\u30c3\u30d7\u30b7\u30e7\u30c3\u30c8\u3092\u4f5c\u6210\u300d\u3057\u307e\u3059\u3002\n\u30bd\u30fc\u30b9\u30c7\u30a3\u30b9\u30af\u306b\u5148\u7a0b\u4f5c\u6210\u3057\u305fVM\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u9078\u3093\u3067\u304f\u3060\u3055\u3044\u3002\n\n\u30b9\u30ca\u30c3\u30d7\u30b7\u30e7\u30c3\u30c8\u304c\u53d6\u5f97\u3067\u304d\u305f\u3089\u3001VM\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u65b0\u3057\u304f\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n\u30d6\u30fc\u30c8\u30c7\u30a3\u30b9\u30af\u3092\u5148\u7a0b\u4f5c\u6210\u3057\u305f\u30b9\u30ca\u30c3\u30d7\u30b7\u30e7\u30c3\u30c8\u306b\u5909\u66f4\u3057\u3066\u304f\u3060\u3055\u3044\u3002ID\u3068API\u3078\u306e\u30a2\u30af\u30bb\u30b9\u306b\u3064\u3044\u3066\u300c\u3059\u3079\u3066\u306e Cloud API \u306b\u5b8c\u5168\u30a2\u30af\u30bb\u30b9\u6a29\u3092\u8a31\u53ef\u300d\u3092\u9078\u629e\u3057\u3066\u304f\u3060\u3055\u3044\u3002\u30d5\u30a1\u30a4\u30a2\u30a6\u30a9\u30fc\u30eb\u306b\u306fHTTP\u3068HTTPS\u306e\u30c8\u30e9\u30d5\u30a3\u30c3\u30af\u3092\u8a31\u53ef\u3057\u3066\u304a\u3044\u3066\u304f\u3060\u3055\u3044\u3002\n\u3053\u308c\u3067\u3088\u3046\u3084\u304fCloud API\u304c\u4f7f\u3048\u308bMagento2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u304c\u624b\u306b\u5165\u308a\u307e\u3057\u305f\u3002\n\nRedis\n\nRedis\u30b5\u30fc\u30d0\u306e\u4f5c\u6210\nBitnami\u306eRedis\u3092Compute Engine\u4e0a\u3067\u8d77\u52d5\u3057\u3066Redis\u30b5\u30fc\u30d0\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\nRedis\u306a\u306e\u3067CPU\u306f1\u30b3\u30a2\u3067\u826f\u3044\u3068\u601d\u3044\u307e\u3059\u3002\u3042\u3068\u306f6379\u756a\u30dd\u30fc\u30c8\u304c\u7a7a\u3044\u3066\u3044\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\nRedis\u3068Magento2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u9023\u643a\n\nRedis\u30b5\u30fc\u30d0\u306e\u30d5\u30a1\u30a4\u30a2\u30a6\u30a9\u30fc\u30eb\u3092\u8a2d\u5b9a\nMagento2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u5185\u90e8IP\u3092\u8abf\u3079\u307e\u3059\u3002\n\n\u4e0a\u306e\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8\u3060\u3068\u5185\u90e8IP\u306b10.146.0.7\u304c\u5272\u308a\u5f53\u3066\u3089\u308c\u3066\u3044\u307e\u3059\u3002\u305d\u306e\u307e\u307e\u30d5\u30a1\u30a4\u30a2\u30a6\u30a9\u30fc\u30eb\u306e\u8a2d\u5b9a\u306b\u79fb\u308b\u305f\u3081\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u306edefault\u3092\u30af\u30ea\u30c3\u30af\u3057\u307e\u3059\u3002\u30d5\u30a1\u30a4\u30a2\u30a6\u30a9\u30fc\u30eb\u30eb\u30fc\u30eb\u4e00\u89a7\u304c\u8868\u793a\u3055\u308c\u308b\u306e\u3067\u30016379\u756a\u30dd\u30fc\u30c8\u306e\u8a2d\u5b9a\uff08Redis\u7528\uff09\u3092\u898b\u3064\u3051\u3066\u7de8\u96c6\u3057\u307e\u3059\u3002\u4eca\u56de\u306fRedis\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u540d-tcp-6379\u3068\u3044\u3046\u540d\u524d\u3067\u751f\u6210\u3055\u308c\u3066\u3044\u307e\u3057\u305f\u3002\n\nMagento2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u5185\u90e8IP\u306e\u307f\u3092\u6307\u5b9a\u3059\u308b\u305f\u3081\u30bd\u30fc\u30b9IP\u306e\u7bc4\u56f2\u3092Magento2\u306e\u5185\u90e8IP/32\u306b\u5909\u66f4\u3057\u3066\u4fdd\u5b58\u3057\u3066\u304f\u3060\u3055\u3044\uff08\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8\u53c2\u8003\uff09\u3002Magento2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u8ffd\u52a0\u3059\u308b\u5ea6\u306b\u7bc4\u56f2\u6307\u5b9a\u3092\u8ffd\u52a0\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\nMagento2\u306e\u8a2d\u5b9a\u3092\u5909\u66f4\nSSH\u3067Magento2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306b\u63a5\u7d9a\u3057\u307e\u3059\u3002\n\nVM\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u8a73\u7d30\u753b\u9762\u304b\u3089SSH\u30dc\u30bf\u30f3\u3092\u30af\u30ea\u30c3\u30af\u3059\u308b\u3068\u30d6\u30e9\u30a6\u30b6\u3067\u30b3\u30f3\u30bd\u30fc\u30eb\u304c\u8d77\u52d5\u3057\u307e\u3059\u3002\n/opt/bitnami/apps/magento/htdocs/\u304cMagento2\u306e\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u30eb\u30fc\u30c8\u306a\u306e\u3067\u3001\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30ebenv.php\u3092\u958b\u3044\u3066session\u306e\u8a2d\u5b9a\u3092\u5909\u66f4\u3001cache\u306e\u8a2d\u5b9a\u3092\u8ffd\u8a18\u3057\u307e\u3059\u3002\n$ sudo vim /opt/bitnami/apps/magento/htdocs/app/etc/env.php \n\n// \u3053\u3053\u304b\u3089\u5909\u66f4.\n  // 'session' =>\n  // array (\n  //   'save' => 'files',\n  // ),\n\n'session' =>\n   array (\n   'save' => 'redis',\n   'redis' =>\n      array (\n        'host' => '10.146.0.8',\n        'port' => '6379',\n        'password' => 'v1TJnCNf',\n        'timeout' => '2.5',\n        'persistent_identifier' => '',\n        'database' => '0',\n        'compression_threshold' => '2048',\n        'compression_library' => 'gzip',\n        'log_level' => '1',\n        'max_concurrency' => '6',\n        'break_after_frontend' => '5',\n        'break_after_adminhtml' => '30',\n        'first_lifetime' => '600',\n        'bot_first_lifetime' => '60',\n        'bot_lifetime' => '7200',\n        'disable_locking' => '0',\n        'min_lifetime' => '60',\n        'max_lifetime' => '2592000'\n    )\n),\n// \u3053\u3053\u307e\u3067\u5909\u66f4.\n\n// (\u7701\u7565)\n\n// \u3053\u3053\u304b\u3089\u8ffd\u8a18.\n'cache' =>\narray(\n   'frontend' =>\n   array(\n      'default' =>\n      array(\n         'backend' => 'Cm_Cache_Backend_Redis',\n         'backend_options' =>\n         array(\n            'server' => '10.146.0.8',\n            'password' => 'v1TJnCNf',\n            'port' => '6379'\n            ),\n    ),\n    'page_cache' =>\n    array(\n      'backend' => 'Cm_Cache_Backend_Redis',\n      'backend_options' =>\n       array(\n         'server' => '10.146.0.8',\n         'port' => '6379',\n         'password' => 'v1TJnCNf',\n         'database' => '1',\n         'compress_data' => '0'\n       )\n    )\n  )\n),\n// \u3053\u3053\u307e\u3067\u8ffd\u8a18.\n\n);\n\n'server(host)'\u3068'password'\u306f\u305d\u308c\u305e\u308c3\u7b87\u6240\u3042\u308a\u307e\u3059\u304c\u3001Redis\u30b5\u30fc\u30d0\u306e\u5185\u90e8IP\u3068\u30d1\u30b9\u30ef\u30fc\u30c9\u3092\u6307\u5b9a\u3057\u3066\u304f\u3060\u3055\u3044\u3002Redis\u30b5\u30fc\u30d0\u69cb\u7bc9\u6642\u306b\u81ea\u52d5\u751f\u6210\u3055\u308c\u305f\u30d1\u30b9\u30ef\u30fc\u30c9\u306f\u3001\u30ab\u30b9\u30bf\u30e0\u30e1\u30bf\u30c7\u30fc\u30bf\u306ebitnami-base-password\u3067\u78ba\u8a8d\u3067\u304d\u307e\u3059\u3002\n\n\u8a2d\u5b9a\u3067\u304d\u305f\u3089\u52d5\u4f5c\u78ba\u8a8d\u306e\u305f\u3081Redis\u30b5\u30fc\u30d0\u306bSSH\u3067\u63a5\u7d9a\u3057\u3066\u30e2\u30cb\u30bf\u3057\u307e\u3059\u3002\n$ redis-cli -a v1TJnCNf monitor\n\n\u30e2\u30cb\u30bf\u3057\u3066\u3044\u308b\u72b6\u614b\u3067Magento2\u306b\u30d6\u30e9\u30a6\u30b6\u304b\u3089\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3068Redis\u304c\u52d5\u4f5c\u3057\u3066\u3044\u308b\u306e\u304c\u78ba\u8a8d\u3067\u304d\u308b\u3068\u601d\u3044\u307e\u3059\u3002\n\n\u53c2\u8003: Redis for session storage Redis for page caching\n\nCloud SQL\n\nGoogle Cloud Storage\nMySQL\u30c0\u30f3\u30d7\u3092Cloud SQL\u306b\u8ee2\u9001\u3059\u308b\u305f\u3081\u306bGoogle Cloud Storage\u3092\u5229\u7528\u3057\u307e\u3059\u3002\nMagento2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u304b\u3089gsutil\u3067Google Cloud Storage\u306b\u30a2\u30af\u30bb\u30b9\u3057\u3066\u30d0\u30b1\u30c3\u30c8\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n$ gsutil mb -l ASIA-NORTHEAST1 gs://magento2-sql-backup-bucket\n\n\u30d0\u30b1\u30c3\u30c8\u540d\u306f\u30b0\u30ed\u30fc\u30d0\u30eb\u306b\u4e00\u610f\u306a\u306e\u3067409\u30a8\u30e9\u30fc\u304c\u8fd4\u5374\u3055\u308c\u305f\u3068\u304d\u306f\u5225\u306e\u540d\u524d\u306b\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\u6210\u529f\u3059\u308b\u3068\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u306e\u306a\u3044\u30d0\u30b1\u30c3\u30c8\u304c\u4f5c\u6210\u3055\u308c\u307e\u3059\u3002\n\n\n\u30c0\u30f3\u30d7\u30d5\u30a1\u30a4\u30eb\u306e\u4f5c\u6210\u30fb\u8ee2\u9001\nMagento2\u304c\u5229\u7528\u3057\u3066\u3044\u308bMySQL\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u30fb\u30e6\u30fc\u30b6\u30fb\u30d1\u30b9\u30ef\u30fc\u30c9\u3092\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb/opt/bitnami/apps/magento/htdocs/app/etc/env.php\u3092\u958b\u3044\u3066\u78ba\u8a8d\u3057\u307e\u3059\u3002\n$ sudo vim /opt/bitnami/apps/magento/htdocs/app/etc/env.php\n\n\n\u516c\u5f0f\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8:mysqldump \u30d5\u30a1\u30a4\u30eb\u306e\u4f5c\u6210\u3092\u53c2\u8003\u306b\u30c0\u30f3\u30d7\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n$ mysqldump --databases bitnami_magento -h localhost -u bn_magento -p --hex-blob --skip-triggers --default-character-set=utf8 > magento_backup\n.sql\n\n\u4f5c\u6210\u3057\u305f\u30c0\u30f3\u30d7\u30d5\u30a1\u30a4\u30eb\u3092\u5148\u7a0b\u4f5c\u6210\u3057\u305fGoogle Cloud Storage\u306e\u30d0\u30b1\u30c3\u30c8\u306b\u8ee2\u9001\u3057\u307e\u3059\u3002\n$ gsutil cp ./magento_backup.sql gs://magento2-sql-backup-bucket\n\nGoogle Cloud Storage\u306b\u30a2\u30af\u30bb\u30b9\u3057\u3066\u8ee2\u9001\u3055\u308c\u305f\u3053\u3068\u3092\u78ba\u8a8d\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n\nCloud SQL\u306e\u8d77\u52d5\nGoogle Cloud SQL\u306b\u30a2\u30af\u30bb\u30b9\u3057\u307e\u3059\u3002\u7b2c2\u4e16\u4ee3\u306fMySQL\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u3067\u3059\u3002\u30b5\u30dd\u30fc\u30c8\u30d0\u30fc\u30b8\u30e7\u30f3\u306f5.6,5.7\u3001\u30a8\u30f3\u30b8\u30f3\u306fInnoDB\u306e\u307f\u306a\u306e\u3067\u3001Magento2\u306b\u306f\u5fc5\u8981\u5341\u5206\u3060\u3068\u601d\u3044\u307e\u3059\u3002\n\n\u30ed\u30b1\u30fc\u30b7\u30e7\u30f3\u306fMagento2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3068\u540c\u3058\u306b\u3057\u3066\u304a\u304f\u3068\u826f\u3044\u3067\u3057\u3087\u3046\u3002\u901a\u5e38\u6642\u3084HA\u306a\u69cb\u6210\u306b\u3057\u305f\u6642\u306e\u6027\u80fd\u306a\u3069\u672a\u691c\u8a3c\u3067\u3059\u304c\u3001\u5b9a\u671f\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u304c\u53d6\u308c\u308b\u3060\u3051\u3067\u3082\u5e78\u305b\u3067\u3059\u306d\u3002\n\n\u4f5c\u6210\u3055\u308c\u305f\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306b\u306fIPv4\u30a2\u30c9\u30ec\u30b9\u304c\u5272\u308a\u5f53\u3066\u3089\u308c\u3066\u3044\u307e\u3059\u3002\u5185\u90e8IP\u3067\u30a2\u30af\u30bb\u30b9\u3067\u304d\u306a\u3044\u306e\uff1f\u3063\u3066\u306a\u3063\u305f\u306e\u3067\u3059\u304c\u3001\u30cd\u30c3\u30c8\u306e\u58f0\u3092\u62fe\u3063\u3066\u307f\u308b\u3068\u307f\u3093\u306a\u601d\u3046\u3068\u3053\u308d\u306f\u540c\u3058\u307f\u305f\u3044\u3067\u3059\u306d\u3002\n\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u63a5\u7d9a\u540d\u306fMagento2\u306e\u8a2d\u5b9a\u306b\u4f7f\u7528\u3059\u308b\u306e\u3067\u899a\u3048\u3066\u304a\u3044\u3066\u304f\u3060\u3055\u3044\u3002\n\nMySQL\u30c0\u30f3\u30d7\u306e\u30a4\u30f3\u30dd\u30fc\u30c8\n\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u8a73\u7d30\u304b\u3089\u300c\u30a4\u30f3\u30dd\u30fc\u30c8\u300d\u3092\u30af\u30ea\u30c3\u30af\u3057\u3066\u3001Cloud Storage\u30d5\u30a1\u30a4\u30eb\u3092\u9078\u629e\u3057\u307e\u3059\u3002\n\n\u521d\u671f\u30c7\u30fc\u30bf\u306e\u307f\u306a\u306e\u3067\u3001\u30a4\u30f3\u30dd\u30fc\u30c8\u306f1\u5206\u3082\u304b\u304b\u3089\u305a\u306b\u7d42\u308f\u308a\u307e\u3059\u3002\n\nMySQL\u30e6\u30fc\u30b6\u306e\u4f5c\u6210\nMagento2\u7528\u306e\u30e6\u30fc\u30b6\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\u30a2\u30af\u30bb\u30b9\u5236\u5fa1/\u30e6\u30fc\u30b6\u30fc/\u30e6\u30fc\u30b6\u30fc\u30a2\u30ab\u30a6\u30f3\u30c8\u3092\u4f5c\u6210\u3092\u30af\u30ea\u30c3\u30af\u3059\u308b\u3068\u30c0\u30a4\u30a2\u30ed\u30b0\u304c\u958b\u304f\u306e\u3067\u30e6\u30fc\u30b6\u30fc\u540d\u30fb\u30d1\u30b9\u30ef\u30fc\u30c9\u3092\u5165\u529b\u3057\u3066\u4f5c\u6210\u3057\u3066\u304f\u3060\u3055\u3044\u3002\u65e2\u5b58\u306e\u8a2d\u5b9a\u304b\u3089\u5909\u3048\u306a\u3044\u5834\u5408\u306f\u3001\u30c0\u30f3\u30d7\u30d5\u30a1\u30a4\u30eb\u4f5c\u6210\u6642\u306b\u78ba\u8a8d\u3057\u305fMagento2\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30ebenv.php\u306e\u30e6\u30fc\u30b6\u30fc\u540d\u3068\u30d1\u30b9\u30ef\u30fc\u30c9\u3092\u6307\u5b9a\u3057\u307e\u3059\u3002\u30db\u30b9\u30c8\u540d\u306f\u300c\u3059\u3079\u3066\u306e\u30db\u30b9\u30c8\u3092\u8a31\u53ef\u3059\u308b\u300d\u3092\u9078\u629e\u3057\u3066\u304f\u3060\u3055\u3044\u3002\u3064\u3044\u3067\u306broot\u306e\u30d1\u30b9\u30ef\u30fc\u30c9\u3082\u5909\u66f4\u3057\u3066\u304a\u304f\u3068\u826f\u3044\u3068\u601d\u3044\u307e\u3059\u3002\n\n\nCloud SQL\u63a5\u7d9a\u7528\u306e\u30bd\u30b1\u30c3\u30c8\u3092\u4f5c\u6210\nCloud SQL Proxy\u3092\u4f7f\u7528\u3057\u3066MySQL\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u306b\u63a5\u7d9a\u3059\u308b\u3092\u53c2\u8003\u306bCloud SQL\u63a5\u7d9a\u7528\u306e\u30bd\u30b1\u30c3\u30c8\u3092\u4f5c\u6210\u3057\u3066\u3044\u304d\u307e\u3059\u3002\nAPI\u3092\u5229\u7528\u3059\u308b\u305f\u3081Cloud SQL Administration API \u3092\u6709\u52b9\u306b\u3057\u307e\u3059\u3002\u8a8d\u8a3c\u60c5\u5831\u306e\u8a2d\u5b9a\u306f\u4e0d\u8981\u3067\u3059\u3002\n\u7d9a\u3044\u3066Magento2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306bSSH\u3067\u63a5\u7d9a\u3057\u307e\u3059\u3002\u307b\u307c\u30c1\u30e5\u30fc\u30c8\u30ea\u30a2\u30eb\u304b\u3089\u306e\u30b3\u30d4\u30da\u3067\u3059\u304c\u3001\u4e0b\u8a18\u30b3\u30de\u30f3\u30c9\u3092\u9806\u306b\u5b9f\u884c\u3057\u3066Cloud SQL Proxy\u3092\u958b\u59cb\u3057\u307e\u3059\u3002\n# 1.\u30d7\u30ed\u30ad\u30b7\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u307e\u3059\u3002\n$ wget https://dl.google.com/cloudsql/cloud_sql_proxy.linux.amd64\n\n# 2.\u30d7\u30ed\u30ad\u30b7\u306e\u540d\u524d\u3092\u5909\u66f4\u3057\u3066\u6a19\u6e96\u306e\u30d5\u30a1\u30a4\u30eb\u540d\u3092\u4f7f\u7528\u3057\u307e\u3059\u3002\n$ mv cloud_sql_proxy.linux.amd64 cloud_sql_proxy\n\n# 3.\u30d7\u30ed\u30ad\u30b7\u3092\u5b9f\u884c\u3067\u304d\u308b\u3088\u3046\u306b\u3057\u307e\u3059\u3002\n$ chmod +x cloud_sql_proxy\n\n# 4.\u30d7\u30ed\u30ad\u30b7 \u30bd\u30b1\u30c3\u30c8\u3092\u683c\u7d0d\u3059\u308b\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n$ sudo mkdir /cloudsql; sudo chmod 777 /cloudsql\n\n# 5.Cloud SDK\u8a8d\u8a3c\u3068\u81ea\u52d5\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u691c\u51fa\u3092\u4f7f\u7528\u3057\u3066\u30d7\u30ed\u30ad\u30b7\u3092\u958b\u59cb\u3057\u307e\u3059\u3002\n$ sudo nohup ./cloud_sql_proxy -dir=/cloudsql &\n\n\nMagento2\u306e\u8a2d\u5b9a\u3092\u5909\u66f4\nCloud SQL\u306b\u30d7\u30ed\u30ad\u30b7\u3092\u5229\u7528\u3057\u3066\u63a5\u7d9a\u3059\u308b\u306b\u306f\u4e0b\u8a18\u306e\u3088\u3046\u306a\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3057\u307e\u3059\u3002\n$ mysql -u root -p -S /cloudsql/\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u63a5\u7d9a\u540d\n\n\u305d\u306e\u305f\u3081Magento2\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30ebenv.php\u3082'db'\u306e'host'\u3092\u30d7\u30ed\u30ad\u30b7\u3092\u5229\u7528\u3059\u308b\u3088\u3046\u306b\u5909\u66f4\u3057\u307e\u3059\u3002\n$ sudo vim ./apps/magento/htdocs/app/etc/env.php\n\n  'db' =>\n  array (\n    'table_prefix' => '',\n    'connection' =>\n    array (\n      'default' =>\n      array (\n        // (\u5909\u66f4\u524d) 'host' => '/opt/bitnami/mysql/tmp/mysql.sock',\n        'host' => '/cloudsql/xxxxxx:asia-northeast1:magento2-cloud-sql',\n        'dbname' => 'bitnami_magento',\n        'username' => 'bn_magento',\n        'password' => '62...\uff08\u7701\u7565\uff09\n\n\u4ee5\u4e0a\u3067Magento2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u4e0a\u306eMySQL\u30b5\u30fc\u30d0\u304b\u3089Cloud SQL\u306b\u63a5\u7d9a\u5148\u304c\u5909\u66f4\u3055\u308c\u307e\u3057\u305f\u3002\n\n\u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b5\uff08\u8ca0\u8377\u5206\u6563\uff09\n\n\u4e8b\u524d\u6e96\u5099\n\nURL\u306e\u5909\u66f4\nMagento2\u306eURL\u3092\u5909\u66f4\u3057\u307e\u3059\u3002Certbot\u306a\u3069\u3067SSL\u5316\u6e08\u307f\u306e\u5834\u5408\u306f\u3053\u306e\u4f5c\u696d\u306f\u4e0d\u8981\u3067\u3059\u3002\u7ba1\u7406\u753b\u9762\u3092\u958b\u3044\u3066\u5909\u66f4\u3059\u308b\u3053\u3068\u3082\u3067\u304d\u307e\u3059\u304c\u3001\u4eca\u56de\u306f\u3053\u306e\u307e\u307e\u30b3\u30f3\u30bd\u30fc\u30eb\u3067\u4f5c\u696d\u3092\u7d9a\u3051\u307e\u3059\u3002\n# \u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u30eb\u30fc\u30c8\u306b\u79fb\u52d5\n$ cd /opt/bitnami/apps/magento/htdocs\n\n# \u30d9\u30fc\u30b9URL\u3092\u5909\u66f4\n$ sudo php bin/magento setup:store-config:set --base-url=\"http://www.example.co.jp/\"\n\n# SSL\u63a5\u7d9aURL\u3092\u5909\u66f4\n$ sudo php bin/magento setup:store-config:set --base-url-secure=\"https://www.example.co.jp/\"\n\n\u78ba\u8a8d\u306e\u305f\u3081Cloud SQL\u306bMySQL\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u3067\u63a5\u7d9a\u3057\u3066\u3001\u8a2d\u5b9a\u30c6\u30fc\u30d6\u30ebcore_config_data\u304c\u66f8\u304d\u63db\u3048\u3089\u308c\u305f\u3053\u3068\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n$ mysql -u bn_magento -p -D bitnami_magento -S /cloudsql/xxxxxx:asia-northeast1:magento2-cloud-sql\n\nmysql> select * from core_config_data;\n\n\n\n\u8a3c\u660e\u66f8\u306e\u53d6\u5f97\nSSL\u5316\u3059\u308b\u305f\u3081\u306e\u30c9\u30e1\u30a4\u30f3\u3068SSL\u30b5\u30fc\u30d0\u8a3c\u660e\u66f8\u3001\u4e2d\u9593CA\u8a3c\u660e\u66f8\u3001\u79d8\u5bc6\u9375\u306e3\u70b9\u30bb\u30c3\u30c8\u3092\u624b\u306b\u5165\u308c\u3066\u304a\u3044\u3066\u304f\u3060\u3055\u3044\u3002\u4f5c\u6210\u3057\u305fMagento2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u4e0a\u3067Certbot\u3092\u5229\u7528\u3057\u3066\u8a3c\u660e\u66f8\u3092\u53d6\u5f97\u3059\u308b\u5834\u5408\u306f\u3001Apache\u3084Varnish\u306a\u3069\u3092\u505c\u6b62\u3057\u3066\u304b\u3089--standalone\u3067Certbot\u3092\u8d77\u52d5\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n$ sudo /opt/bitnami/ctlscript.sh stop\n$ sudo certbot certonly --standalone\n$ sudo /opt/bitnami/ctlscript.sh start\n\n\n\u30d8\u30eb\u30b9\u30c1\u30a7\u30c3\u30af\u5bfe\u7b56\nMagento2\u306eURL\u8a2d\u5b9a\u3092\u5909\u66f4\u3057\u3066\u30c9\u30e1\u30a4\u30f3\u540d\u3067HTTP\u30a2\u30af\u30bb\u30b9\u3067\u304d\u308b\u3088\u3046\u306b\u3059\u308b\u3068\u3001IP\u30a2\u30c9\u30ec\u30b9\u3067\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3068\u30c9\u30e1\u30a4\u30f3\u540d\u306b\u30ea\u30c0\u30a4\u30ec\u30af\u30c8\u3055\u308c\u3066\u3057\u307e\u3046\u306e\u3067\u3001\u30d8\u30eb\u30b9\u30c1\u30a7\u30c3\u30af\u306e\u7d50\u679c\u304c\u30a8\u30e9\u30fc\u306b\u306a\u3063\u3066\u3057\u307e\u3044\u307e\u3059\u3002\u305d\u3053\u3067\u30d8\u30eb\u30b9\u30c1\u30a7\u30c3\u30af\u7528\u306e\u30d5\u30a1\u30a4\u30eb\u3092\u7528\u610f\u3057\u3066\u8a72\u5f53\u30d5\u30a1\u30a4\u30eb\u306b\u30a2\u30af\u30bb\u30b9\u3057\u305f\u3068\u304d\u3060\u3051\u306f200\u756a\u304c\u8fd4\u5374\u3055\u308c\u308b\u3088\u3046\u306b\u3057\u3066\u3044\u304d\u307e\u3059\u3002\n\n\nhttp://104.198.124.255 -> http://www.example.co.jp/ (302 Found)\n\nhttp://104.198.124.255/healthcheck.html -> http://104.198.124.255/healthcheck.html (200 OK)\n\nMagento2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306bSSH\u3067\u63a5\u7d9a\u3057\u307e\u3059\u3002/opt/bitnami/apps/magento/htdocs/\u304cMagento2\u306e\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u30eb\u30fc\u30c8\u306a\u306e\u3067\u76f4\u4e0b\u306bhealthcheck.html\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n$ sudo vim /opt/bitnami/apps/magento/htdocs/healthcheck.html\n\n\u4e2d\u8eab\u306f\u306a\u3093\u3067\u3082\u826f\u3044\u306e\u3067\u9069\u5f53\u306b\u7de8\u96c6\u3057\u3066\u4fdd\u5b58\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n<!doctype html><html><body><h1>instance-1</h1></body></html>\n\n\u53c2\u8003: Redirect HTTP to HTTPS in Wordpress running behind a Google HTTP Load Balancer\n\nHTTPS Termination\u6642\u306e\u30ea\u30c0\u30a4\u30ec\u30af\u30c8\u30eb\u30fc\u30d7\u5bfe\u7b56\n\u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b5\u306e\u30d0\u30c3\u30af\u30a8\u30f3\u30c9\u306bMagento2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u914d\u7f6e\u3059\u308b\u3068SSL\u30a2\u30af\u30bb\u30b9\u3057\u305f\u3068\u304d\u306b\u30ea\u30c0\u30a4\u30ec\u30af\u30c8\u30eb\u30fc\u30d7\u304c\u767a\u751f\u3057\u307e\u3059\u3002\u305d\u306e\u305f\u3081X-Forwarded-Proto\u304chttps\u3060\u3063\u305f\u3068\u304d\u306bHTTPS=on\u306b\u3057\u307e\u3059\u3002\u901a\u5e38.htaccess\u3092\u66f8\u304d\u63db\u3048\u308b\u308f\u3051\u3067\u3059\u304c\u30d5\u30a1\u30a4\u30eb\u3092\u958b\u304f\u3068\u5909\u66f4\u3057\u3066\u3082\u53cd\u6620\u3055\u308c\u306a\u3044\u7684\u306a\u3053\u3068\u304c\u66f8\u3044\u3066\u3042\u3063\u305f\u306e\u3067httpd.conf\u3092\u5909\u3048\u3066\u3057\u307e\u3044\u307e\u3059\u3002\n$ sudo vim /opt/bitnami/apache2/conf/httpd.conf\n\n...\n# \u8ffd\u8a18\nSetEnvIf X-Forwarded-Proto https HTTPS=on\n\nInclude \"/opt/bitnami/apache2/conf/ssi.conf\"\n...\n\nInclude\u3067\u4ed6\u306e\u30b3\u30f3\u30d5\u30a3\u30b0\u30d5\u30a1\u30a4\u30eb\u3092\u8aad\u307f\u8fbc\u3080\u524d\u306b\u8ffd\u8a18\u3057\u3066\u3044\u307e\u3059\u3002\n\u53c2\u8003: Magento SSL Offloading with Amazon ELB\n\n\u30d0\u30c3\u30af\u30a8\u30f3\u30c9\u306e\u6e96\u5099\n\u6e96\u5099\u304c\u7d42\u308f\u3063\u305f\u306e\u3067\u3001\u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b5\u306e\u30d0\u30c3\u30af\u30a8\u30f3\u30c9\u3092\u69cb\u7bc9\u3057\u3066\u3044\u304d\u307e\u3059\u3002\nCompute Engine\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9 \u30b0\u30eb\u30fc\u30d7\u3092\u9078\u629e\u3057\u3066\u3001\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9 \u30b0\u30eb\u30fc\u30d7\u3092\u4f5c\u6210\u3057\u307e\u3057\u3087\u3046\u3002\n\n\u30ed\u30b1\u30fc\u30b7\u30e7\u30f3\u306b\u30b7\u30f3\u30b0\u30eb\u30be\u30fc\u30f3\u3092\u9078\u629e\u3057\u3066\u3001\u65e2\u5b58\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3068\u3057\u3066Magento2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u9078\u3073\u307e\u3059\u3002\n\u7d9a\u3044\u3066\u30d8\u30eb\u30b9\u30c1\u30a7\u30c3\u30af\u306e\u4f5c\u6210\u3067\u3059\u3002\u3055\u304f\u3055\u304f\u884c\u304d\u307e\u3059\u3002\n\n\u30ea\u30af\u30a8\u30b9\u30c8\u30d1\u30b9\u306b\u5148\u7a0b\u4f5c\u6210\u3057\u305fhealthcheck.html\u3092\u6307\u5b9a\u3057\u307e\u3059\u3002\n\n\u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b5\uff08\u8ca0\u8377\u5206\u6563\uff09\n\u30cd\u30c3\u30c8\u30ef\u30fc\u30ad\u30f3\u30b0\u304b\u3089\u8ca0\u8377\u5206\u6563\u3092\u9078\u629e\u3057\u3066\u300c\u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b5\u3092\u4f5c\u6210\u300d\u3057\u307e\u3059\u3002\nHTTP\uff08S\uff09\u8ca0\u8377\u5206\u6563\u306e\u300c\u8a2d\u5b9a\u3092\u958b\u59cb\u300d\u30dc\u30bf\u30f3\u3092\u30af\u30ea\u30c3\u30af\u3059\u308b\u3068\u30c1\u30e5\u30fc\u30c8\u30ea\u30a2\u30eb\u5f62\u5f0f\u3067\u8a2d\u5b9a\u304c\u958b\u59cb\u3055\u308c\u307e\u3059\u3002\n\n\u30d0\u30c3\u30af\u30a8\u30f3\u30c9\u30b5\u30fc\u30d3\u30b9\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u30b0\u30eb\u30fc\u30d7\u3068\u30d8\u30eb\u30b9\u30c1\u30a7\u30c3\u30af\u306b\u5148\u7a0b\u4f5c\u6210\u3057\u305f\u3082\u306e\u3092\u6307\u5b9a\u3057\u307e\u3059\u3002\n\n\u3064\u3044\u3067\u306bCloud CDN\u306b\u3082\u30c1\u30a7\u30c3\u30af\u3092\u5165\u308c\u3066\u304a\u304f\u3068\uff08\u6599\u91d1\u306f\u767a\u751f\u3057\u307e\u3059\u304c\uff09\u3055\u3089\u306a\u308b\u9ad8\u901f\u5316\u304c\u671b\u3081\u3066\u5b09\u3057\u3044\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u3002\n\u30db\u30b9\u30c8\u3068\u30d1\u30b9\u306e\u30eb\u30fc\u30eb\u306f\u30d0\u30c3\u30af\u30a8\u30f3\u30c9\u304c1\u3064\u3057\u304b\u306a\u3044\u306e\u3067\u305d\u306e\u307e\u307e\u3067\u826f\u304f\u3066\u3001\u30d5\u30ed\u30f3\u30c8\u30a8\u30f3\u30c9\u3092\u8a2d\u5b9a\u3057\u3066\u3044\u304d\u307e\u3059\u3002IP\u30a2\u30c9\u30ec\u30b9\u306e\u4f5c\u6210\u3092\u9078\u3093\u3067\u9759\u7684IP\u3092\u7533\u8acb\u3057\u307e\u3059\u3002\u30c8\u30e9\u30a4\u30a2\u30eb\u306e\u67a0\u5185\u3060\u3068\u8cb4\u91cd\u306a1\u500b\u3092\u3053\u3053\u3067\u4f7f\u3044\u307e\u3059\u3002Magento2\u306f\u7ba1\u7406\u753b\u9762\u304b\u3089HSTS\u306e\u8a2d\u5b9a\u306a\u3069\u304c\u3067\u304d\u308b\u306e\u3067\u3059\u304c\u3001\u3044\u3063\u305f\u3093HTTP\u3068HTTPS\u306e\u4e21\u65b9\u306e\u30ea\u30af\u30a8\u30b9\u30c8\u3092\u8a31\u53ef\u3057\u3066\u3044\u307e\u3059\u3002\n\n\u65b0\u3057\u3044\u8a3c\u660e\u66f8\u306e\u4f5c\u6210\u3067\u306f\u3001\u4e8b\u524d\u306b\u6e96\u5099\u3057\u3066\u304a\u3044\u305fSSL\u8a3c\u660e\u66f8\u3068\u4e2d\u9593\u8a3c\u660e\u66f8\u3068\u79d8\u5bc6\u9375\u3092\u9806\u306b\u8cbc\u308a\u4ed8\u3051\u3066or\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u3057\u3066\u3044\u304d\u307e\u3059\u3002\n\n\u5168\u3066\u306e\u8a2d\u5b9a\u304c\u7d42\u308f\u3063\u3066\u300c\u4f5c\u6210\u300d\u3092\u30af\u30ea\u30c3\u30af\u3059\u308b\u3068\u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b5\u304c\u4f5c\u6210\u3055\u308c\u307e\u3059\u3002\n\nDNS\u306e\u8a2d\u5b9a\u3092\u5909\u66f4\n\u6700\u5f8c\u306b\u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b5\u3067\u8a2d\u5b9a\u3057\u305fIP\u30a2\u30c9\u30ec\u30b9\u3092DNS\u306eA\u30ec\u30b3\u30fc\u30c9\u306b\u8a2d\u5b9a\u3057\u3066\u3042\u3052\u308c\u3070OK\u3067\u3059\u3002\n\nHTTP2\u3067\u30a2\u30af\u30bb\u30b9\u3067\u304d\u308b\u3053\u3068\u304c\u78ba\u8a8d\u3067\u304d\u307e\u3057\u305f\uff01\n\n\u3042\u3068\u304c\u304d\nGoogle Cloud Platform\u306b\u521d\u3081\u3066\u89e6\u308c\u305f\u306e\u3067\u7d50\u69cb\u5927\u5909\u3067\u3057\u305f\u3002\u7279\u306bCloud API\u306e\u30a2\u30af\u30bb\u30b9\u7bc4\u56f2\u3092\u6709\u52b9\u5316\u3057\u3066\u304a\u304b\u306a\u3044\u3068API\u304c\u5229\u7528\u3067\u304d\u306a\u304b\u3063\u305f\u308a\u3001\u30d8\u30eb\u30b9\u30c1\u30a7\u30c3\u30af\u7528\u306bIP\u30a2\u30c9\u30ec\u30b9\u3067\u30a2\u30af\u30bb\u30b9\u3057\u305f\u3068\u304d\u306b200\u756a\u3092\u8fd4\u5374\u3059\u308bURL\u3092\u6e96\u5099\u3059\u308b\u5fc5\u8981\u304c\u3042\u3063\u305f\u308a\u3068\u3001Magento2\u3068\u95a2\u4fc2\u306a\u3044\u3068\u3053\u308d\u3067\u82e6\u52b4\u3057\u305f\u611f\u3058\u3067\u3059\u3002\n\u4e00\u65b9\u3067\u8a2d\u5b9a\u3060\u3051\u3067Redis\u3092\u5229\u7528\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u3063\u305f\u3053\u3068\u306b\u306f\u6b63\u76f4\u9a5a\u3044\u3066\u3057\u307e\u3044\u307e\u3057\u305f\u3002\u3057\u304b\u3082Redis\u306e\u8a2d\u5b9a\u3092\u3057\u305f\u6642\u304c\u4e00\u756a\u9ad8\u901f\u5316\u306e\u6069\u6075\u3092\u611f\u3058\u305f\u306e\u3067\u3001\u904b\u7528\u3059\u308b\u3068\u304d\u306f\u8ed2\u4e26\u307f\u8a2d\u5b9a\u3057\u305f\u3044\u3068\u3053\u308d\u3067\u3059\u306d\u3002\u3044\u305f\u308b\u3068\u3053\u308d\u3067\u30ad\u30e3\u30c3\u30b7\u30e5\u3092\u5229\u7528\u3057\u3066\u3044\u308b\u306e\u3067\u4e0d\u5177\u5408\u767a\u751f\u6642\u306e\u5207\u308a\u5206\u3051\u304c\u5927\u5909\u305d\u3046\u306a\u306e\u306f\u30c8\u30ec\u30fc\u30c9\u30aa\u30d5\u3068\u3044\u3046\u3053\u3068\u3067\u3002\n\n[Magento Advent Calender 2016](http://www.adventar.org/calendars/1372)\u306e\u30cd\u30bf\u3092\u63a2\u3057\u3066\u3044\u305f\u3068\u3053\u308dGoogle Cloud Platform\u306e\u30c8\u30e9\u30a4\u30a2\u30eb\u304c[60\u65e5\u9593$300\u307e\u3067\u7121\u6599](https://cloud.google.com/free-trial/)\u304c\u76ee\u306b\u5165\u3063\u305f\u306e\u306811\u6708\u304b\u3089[\u6771\u4eac\u30ea\u30fc\u30b8\u30e7\u30f3](https://cloud.google.com/about/locations/japan/)\u304c\u6b63\u5f0f\u904b\u7528\u3055\u308c\u305f\u3053\u3068\u304c\u6c17\u306b\u306a\u3063\u3066\u3044\u305f\u306e\u3067\u3053\u308c\u5e78\u3044\u3068\u69cb\u7bc9\u3057\u3066\u307f\u307e\u3057\u305f\n\n## \u30b4\u30fc\u30eb\n\n\u30a4\u30f3\u30bf\u30fc\u30cd\u30c3\u30c8 - Load Balancing\uff08\u8ca0\u8377\u5206\u6563\uff09 - [Magento2 - Redis] - Cloud SQL\n\n## VM \u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u4f5c\u6210\n\n### \u30d9\u30fc\u30b9\u3068\u306a\u308bVM\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u4f5c\u6210\n\n[Bitnami\u306eMagento2](https://console.cloud.google.com/launcher/details/bitnami-launchpad/magento)\u3092Compute Engine\u4e0a\u3067\u8d77\u52d5\u3057\u3066\u30d9\u30fc\u30b9\u3068\u306a\u308b\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n![\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2016-12-15 16.09.46.png](https://qiita-image-store.s3.amazonaws.com/0/50629/c5ecf3c9-bc8c-0608-03f5-3a55ada8aeec.png \"\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2016-12-15 16.09.46.png\")\n\n\n\u69cb\u6210\uff082016/12/15\u6642\u70b9\u30fb\u629c\u7c8b\uff09\n\n* Debian (8)\n* Apache (2.4.23)\n* Magento (2.1.2)\n* Memcached (1.4.31)\n* MySQL (5.7.15)\n* PHP (7.0.11)\n* Varnish (4.1.0)\n\nZone\u306fasia-northeast1-a,b,c\u306e\u3044\u305a\u308c\u304b\uff08\u6771\u4eac\u30ea\u30fc\u30b8\u30e7\u30f3\uff09\u3092\u9078\u3093\u3067\u304f\u3060\u3055\u3044\u3002Magento2\u306f\u30e1\u30e2\u30ea\u3092\u7d50\u69cb\u6d88\u8cbb\u3059\u308b\u306e\u3067n1-standard-2\u3092\u9078\u629e\u3057\u3066\u3044\u307e\u3059\u3002Cloud SQL\u3092\u4f7f\u3046\u306e\u3067\u30c7\u30a3\u30b9\u30afI/O\u306f\u6c17\u306b\u3057\u306a\u3044\u3068\u3044\u3046\u3053\u3068\u3067Disk type\u306fStandard Persistent Disk\u3092\u9078\u3093\u3067\u3044\u307e\u3059\u3002External IP\u306fEphemeral\uff08\u9759\u7684IP\u3058\u3083\u306a\u3044\u3084\u3064\uff09\u3092\u5272\u308a\u5f53\u3066\u307e\u3059\u3002\n\n\u8d77\u52d5\u3057\u3066\u308f\u304b\u3063\u305f\u306e\u3067\u3059\u304c\u3001Varnish\u304c80\u756a\u30dd\u30fc\u30c8\u3067\u5f85\u3061\u53d7\u3051\u3066\u3044\u307e\u3057\u305f\u3002apache\u306f81\u756a\u3068443\u756a\u3067\u3059\u306d\u3002\u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b5\u3067SSL Termination\u3057\u306680\u756a\u306b\u6e21\u305b\u3089\u308c\u308c\u3070\u826f\u3044\u3067\u3059\u306d\u3002\n\n![\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2016-12-15 16.12.28.png](https://qiita-image-store.s3.amazonaws.com/0/50629/ca84ea8d-6b8e-aabc-2ce7-b8d2235813ab.png \"\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2016-12-15 16.12.28.png\")\n\n\u30c7\u30d7\u30ed\u30a4\u76f4\u5f8c\u306e\u753b\u9762\u3067\u3059\u3002\u7ba1\u7406\u753b\u9762\u306e\u30d1\u30b9\u30ef\u30fc\u30c9\u3082\u81ea\u52d5\u751f\u6210\u3055\u308c\u3066\u3044\u308b\u306e\u3067\u3053\u306e\u307e\u307e\u3067\u3082Site Address\u304b\u3089\u30a2\u30af\u30bb\u30b9\u53ef\u80fd\u3067\u3059\u3002Magento2\u306b\u6700\u9069\u5316\u3055\u308c\u305f\u69cb\u6210\u306b\u306a\u3063\u3066\u3044\u308b\u305f\u3081\u30b9\u30c8\u30ec\u30b9\u306a\u304f\u52d5\u4f5c\u3057\u3066\u3044\u307e\u3059\u304c\u3001\u5c11\u3057\u3065\u3064\u9ad8\u901f\u5316\u3057\u3066\u3044\u304d\u307e\u3059\u3002\n\n\u4f5c\u6210\u3057\u305fVM\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u8a2d\u5b9a\u3092\u78ba\u8a8d\u3059\u308b\u3068\u3001\u30c7\u30d5\u30a9\u30eb\u30c8\u306e\u30a2\u30af\u30bb\u30b9\u6a29\u304c\u9069\u7528\u3055\u308c\u3066\u3044\u308b\u305f\u3081Cloud API \u30a2\u30af\u30bb\u30b9\u7bc4\u56f2\u304c\u307b\u3068\u3093\u3069\u7121\u52b9\u5316\u3055\u308c\u3066\u3044\u307e\u3057\u305f\u3002\u4eca\u56de\u306e\u624b\u9806\u7684\u306b\u306fCloud SQL\u3068\u30b9\u30c8\u30ec\u30fc\u30b8\u3092\u6709\u52b9\u5316\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002[Cloud SQL Proxy\u306e\u30ea\u30d5\u30a1\u30ec\u30f3\u30b9](https://cloud.google.com/sql/docs/compute-engine-access?hl=ja#gce-connect-proxy)\u306b\u3082\u66f8\u3044\u3066\u3042\u308a\u307e\u3059\u304c\u30a2\u30af\u30bb\u30b9\u7bc4\u56f2\u3092\u5909\u66f4\u3067\u304d\u308b\u306e\u306f\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u4f5c\u6210\u6642\u306a\u306e\u3067\u3001\u5b8c\u5168\u306b\u7121\u99c4\u306a\u4f5c\u696d\u3067\u3059\u304c\u4f5c\u6210\u3057\u305fVM\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u30d9\u30fc\u30b9\u306b\u518d\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n![\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2016-12-16 18.09.56.png](https://qiita-image-store.s3.amazonaws.com/0/50629/95648cbd-2b6a-5846-8200-aa6208fda988.png \"\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2016-12-16 18.09.56.png\")\n\n\n### VM\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u30b3\u30d4\u30fc\n\nVM\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u505c\u6b62\u3057\u307e\u3059\u3002\n\u7d9a\u3044\u3066\u30e1\u30cb\u30e5\u30fc\u304b\u3089\u30b9\u30ca\u30c3\u30d7\u30b7\u30e7\u30c3\u30c8\u3092\u9078\u3093\u3067\u300c\u30b9\u30ca\u30c3\u30d7\u30b7\u30e7\u30c3\u30c8\u3092\u4f5c\u6210\u300d\u3057\u307e\u3059\u3002\n\u30bd\u30fc\u30b9\u30c7\u30a3\u30b9\u30af\u306b\u5148\u7a0b\u4f5c\u6210\u3057\u305fVM\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u9078\u3093\u3067\u304f\u3060\u3055\u3044\u3002\n\n![\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2016-12-15 16.35.18.png](https://qiita-image-store.s3.amazonaws.com/0/50629/5d86b71f-f756-dd8f-5856-81a8a9d21e5f.png \"\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2016-12-15 16.35.18.png\")\n\n\u30b9\u30ca\u30c3\u30d7\u30b7\u30e7\u30c3\u30c8\u304c\u53d6\u5f97\u3067\u304d\u305f\u3089\u3001VM\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u65b0\u3057\u304f\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n![\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2016-12-15 17.02.29.png](https://qiita-image-store.s3.amazonaws.com/0/50629/e51ab1ee-06d9-692c-7e41-d622ddf5b776.png \"\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2016-12-15 17.02.29.png\")\n\n\u30d6\u30fc\u30c8\u30c7\u30a3\u30b9\u30af\u3092\u5148\u7a0b\u4f5c\u6210\u3057\u305f\u30b9\u30ca\u30c3\u30d7\u30b7\u30e7\u30c3\u30c8\u306b\u5909\u66f4\u3057\u3066\u304f\u3060\u3055\u3044\u3002ID\u3068API\u3078\u306e\u30a2\u30af\u30bb\u30b9\u306b\u3064\u3044\u3066\u300c\u3059\u3079\u3066\u306e Cloud API \u306b\u5b8c\u5168\u30a2\u30af\u30bb\u30b9\u6a29\u3092\u8a31\u53ef\u300d\u3092\u9078\u629e\u3057\u3066\u304f\u3060\u3055\u3044\u3002\u30d5\u30a1\u30a4\u30a2\u30a6\u30a9\u30fc\u30eb\u306b\u306fHTTP\u3068HTTPS\u306e\u30c8\u30e9\u30d5\u30a3\u30c3\u30af\u3092\u8a31\u53ef\u3057\u3066\u304a\u3044\u3066\u304f\u3060\u3055\u3044\u3002\n\n\u3053\u308c\u3067\u3088\u3046\u3084\u304fCloud API\u304c\u4f7f\u3048\u308bMagento2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u304c\u624b\u306b\u5165\u308a\u307e\u3057\u305f\u3002\n\n## Redis\n\n### Redis\u30b5\u30fc\u30d0\u306e\u4f5c\u6210\n\n[Bitnami\u306eRedis](https://console.cloud.google.com/launcher/details/bitnami-launchpad/redis)\u3092Compute Engine\u4e0a\u3067\u8d77\u52d5\u3057\u3066Redis\u30b5\u30fc\u30d0\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n![\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2016-12-15 17.12.54.png](https://qiita-image-store.s3.amazonaws.com/0/50629/7febc8c3-c921-0579-e90c-9b7c1152fad8.png \"\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2016-12-15 17.12.54.png\")\n\nRedis\u306a\u306e\u3067CPU\u306f1\u30b3\u30a2\u3067\u826f\u3044\u3068\u601d\u3044\u307e\u3059\u3002\u3042\u3068\u306f6379\u756a\u30dd\u30fc\u30c8\u304c\u7a7a\u3044\u3066\u3044\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n### Redis\u3068Magento2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u9023\u643a\n\n#### Redis\u30b5\u30fc\u30d0\u306e\u30d5\u30a1\u30a4\u30a2\u30a6\u30a9\u30fc\u30eb\u3092\u8a2d\u5b9a\n\nMagento2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u5185\u90e8IP\u3092\u8abf\u3079\u307e\u3059\u3002\n\n![\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2016-12-15 17.22.59.png](https://qiita-image-store.s3.amazonaws.com/0/50629/3b0f694b-acd1-3324-0776-f450f7c0357c.png \"\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2016-12-15 17.22.59.png\")\n\n\u4e0a\u306e\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8\u3060\u3068\u5185\u90e8IP\u306b10.146.0.7\u304c\u5272\u308a\u5f53\u3066\u3089\u308c\u3066\u3044\u307e\u3059\u3002\u305d\u306e\u307e\u307e\u30d5\u30a1\u30a4\u30a2\u30a6\u30a9\u30fc\u30eb\u306e\u8a2d\u5b9a\u306b\u79fb\u308b\u305f\u3081\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u306edefault\u3092\u30af\u30ea\u30c3\u30af\u3057\u307e\u3059\u3002\u30d5\u30a1\u30a4\u30a2\u30a6\u30a9\u30fc\u30eb\u30eb\u30fc\u30eb\u4e00\u89a7\u304c\u8868\u793a\u3055\u308c\u308b\u306e\u3067\u30016379\u756a\u30dd\u30fc\u30c8\u306e\u8a2d\u5b9a\uff08Redis\u7528\uff09\u3092\u898b\u3064\u3051\u3066\u7de8\u96c6\u3057\u307e\u3059\u3002\u4eca\u56de\u306f`Redis\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u540d-tcp-6379`\u3068\u3044\u3046\u540d\u524d\u3067\u751f\u6210\u3055\u308c\u3066\u3044\u307e\u3057\u305f\u3002\n\n![\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2016-12-15 17.26.52.png](https://qiita-image-store.s3.amazonaws.com/0/50629/e511e77c-3e9d-8e68-dfee-e198b3aa2ae0.png \"\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2016-12-15 17.26.52.png\")\n\nMagento2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u5185\u90e8IP\u306e\u307f\u3092\u6307\u5b9a\u3059\u308b\u305f\u3081\u30bd\u30fc\u30b9IP\u306e\u7bc4\u56f2\u3092`Magento2\u306e\u5185\u90e8IP/32`\u306b\u5909\u66f4\u3057\u3066\u4fdd\u5b58\u3057\u3066\u304f\u3060\u3055\u3044\uff08\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8\u53c2\u8003\uff09\u3002Magento2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u8ffd\u52a0\u3059\u308b\u5ea6\u306b\u7bc4\u56f2\u6307\u5b9a\u3092\u8ffd\u52a0\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\n#### Magento2\u306e\u8a2d\u5b9a\u3092\u5909\u66f4\n\nSSH\u3067Magento2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306b\u63a5\u7d9a\u3057\u307e\u3059\u3002\n\n![\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2016-12-15 17.34.44.png](https://qiita-image-store.s3.amazonaws.com/0/50629/224a0ff8-2c11-d061-6ac3-d42629acdd54.png \"\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2016-12-15 17.34.44.png\")\n\nVM\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u8a73\u7d30\u753b\u9762\u304b\u3089SSH\u30dc\u30bf\u30f3\u3092\u30af\u30ea\u30c3\u30af\u3059\u308b\u3068\u30d6\u30e9\u30a6\u30b6\u3067\u30b3\u30f3\u30bd\u30fc\u30eb\u304c\u8d77\u52d5\u3057\u307e\u3059\u3002\n\n`/opt/bitnami/apps/magento/htdocs/`\u304cMagento2\u306e\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u30eb\u30fc\u30c8\u306a\u306e\u3067\u3001\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb`env.php`\u3092\u958b\u3044\u3066`session`\u306e\u8a2d\u5b9a\u3092\u5909\u66f4\u3001`cache`\u306e\u8a2d\u5b9a\u3092\u8ffd\u8a18\u3057\u307e\u3059\u3002\n\n```sh\n$ sudo vim /opt/bitnami/apps/magento/htdocs/app/etc/env.php \n\n// \u3053\u3053\u304b\u3089\u5909\u66f4.\n  // 'session' =>\n  // array (\n  //   'save' => 'files',\n  // ),\n  \n'session' =>\n   array (\n   'save' => 'redis',\n   'redis' =>\n      array (\n        'host' => '10.146.0.8',\n        'port' => '6379',\n        'password' => 'v1TJnCNf',\n        'timeout' => '2.5',\n        'persistent_identifier' => '',\n        'database' => '0',\n        'compression_threshold' => '2048',\n        'compression_library' => 'gzip',\n        'log_level' => '1',\n        'max_concurrency' => '6',\n        'break_after_frontend' => '5',\n        'break_after_adminhtml' => '30',\n        'first_lifetime' => '600',\n        'bot_first_lifetime' => '60',\n        'bot_lifetime' => '7200',\n        'disable_locking' => '0',\n        'min_lifetime' => '60',\n        'max_lifetime' => '2592000'\n    )\n),\n// \u3053\u3053\u307e\u3067\u5909\u66f4.\n\n// (\u7701\u7565)\n\n// \u3053\u3053\u304b\u3089\u8ffd\u8a18.\n'cache' =>\narray(\n   'frontend' =>\n   array(\n      'default' =>\n      array(\n         'backend' => 'Cm_Cache_Backend_Redis',\n         'backend_options' =>\n         array(\n            'server' => '10.146.0.8',\n            'password' => 'v1TJnCNf',\n            'port' => '6379'\n            ),\n    ),\n    'page_cache' =>\n    array(\n      'backend' => 'Cm_Cache_Backend_Redis',\n      'backend_options' =>\n       array(\n         'server' => '10.146.0.8',\n         'port' => '6379',\n         'password' => 'v1TJnCNf',\n         'database' => '1',\n         'compress_data' => '0'\n       )\n    )\n  )\n),\n// \u3053\u3053\u307e\u3067\u8ffd\u8a18.\n\n);\n```\n\n'server(host)'\u3068'password'\u306f\u305d\u308c\u305e\u308c3\u7b87\u6240\u3042\u308a\u307e\u3059\u304c\u3001Redis\u30b5\u30fc\u30d0\u306e\u5185\u90e8IP\u3068\u30d1\u30b9\u30ef\u30fc\u30c9\u3092\u6307\u5b9a\u3057\u3066\u304f\u3060\u3055\u3044\u3002Redis\u30b5\u30fc\u30d0\u69cb\u7bc9\u6642\u306b\u81ea\u52d5\u751f\u6210\u3055\u308c\u305f\u30d1\u30b9\u30ef\u30fc\u30c9\u306f\u3001\u30ab\u30b9\u30bf\u30e0\u30e1\u30bf\u30c7\u30fc\u30bf\u306ebitnami-base-password\u3067\u78ba\u8a8d\u3067\u304d\u307e\u3059\u3002\n\n![\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2016-12-15 17.53.57.png](https://qiita-image-store.s3.amazonaws.com/0/50629/6735f644-22e6-619f-dbbf-32a4dd0cf9ad.png \"\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2016-12-15 17.53.57.png\")\n\n\u8a2d\u5b9a\u3067\u304d\u305f\u3089\u52d5\u4f5c\u78ba\u8a8d\u306e\u305f\u3081Redis\u30b5\u30fc\u30d0\u306bSSH\u3067\u63a5\u7d9a\u3057\u3066\u30e2\u30cb\u30bf\u3057\u307e\u3059\u3002\n\n```sh\n$ redis-cli -a v1TJnCNf monitor\n```\n\n\u30e2\u30cb\u30bf\u3057\u3066\u3044\u308b\u72b6\u614b\u3067Magento2\u306b\u30d6\u30e9\u30a6\u30b6\u304b\u3089\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3068Redis\u304c\u52d5\u4f5c\u3057\u3066\u3044\u308b\u306e\u304c\u78ba\u8a8d\u3067\u304d\u308b\u3068\u601d\u3044\u307e\u3059\u3002\n\n![\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2016-12-15 18.06.55.png](https://qiita-image-store.s3.amazonaws.com/0/50629/ca23fe88-7d22-7d3e-fa31-bdeee717ed7a.png \"\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2016-12-15 18.06.55.png\")\n\n\u53c2\u8003: [Redis for session storage](http://devdocs.magento.com/guides/v2.0/config-guide/redis/redis-session.html) [Redis for page caching](http://devdocs.magento.com/guides/v2.0/config-guide/redis/redis-pg-cache.html)\n\n## Cloud SQL\n\n### Google Cloud Storage\n\nMySQL\u30c0\u30f3\u30d7\u3092Cloud SQL\u306b\u8ee2\u9001\u3059\u308b\u305f\u3081\u306b[Google Cloud Storage](https://console.cloud.google.com/storage)\u3092\u5229\u7528\u3057\u307e\u3059\u3002\n\nMagento2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u304b\u3089[gsutil](https://cloud.google.com/storage/docs/gsutil)\u3067Google Cloud Storage\u306b\u30a2\u30af\u30bb\u30b9\u3057\u3066\u30d0\u30b1\u30c3\u30c8\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n```sh\n$ gsutil mb -l ASIA-NORTHEAST1 gs://magento2-sql-backup-bucket\n```\n\n\u30d0\u30b1\u30c3\u30c8\u540d\u306f\u30b0\u30ed\u30fc\u30d0\u30eb\u306b\u4e00\u610f\u306a\u306e\u3067409\u30a8\u30e9\u30fc\u304c\u8fd4\u5374\u3055\u308c\u305f\u3068\u304d\u306f\u5225\u306e\u540d\u524d\u306b\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\u6210\u529f\u3059\u308b\u3068\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u306e\u306a\u3044\u30d0\u30b1\u30c3\u30c8\u304c\u4f5c\u6210\u3055\u308c\u307e\u3059\u3002\n\n![\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2016-12-15 18.46.34.png](https://qiita-image-store.s3.amazonaws.com/0/50629/f6b3c55e-9bfd-f811-e593-727eb22a3176.png \"\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2016-12-15 18.46.34.png\")\n\n### \u30c0\u30f3\u30d7\u30d5\u30a1\u30a4\u30eb\u306e\u4f5c\u6210\u30fb\u8ee2\u9001\n\nMagento2\u304c\u5229\u7528\u3057\u3066\u3044\u308bMySQL\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u30fb\u30e6\u30fc\u30b6\u30fb\u30d1\u30b9\u30ef\u30fc\u30c9\u3092\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb`/opt/bitnami/apps/magento/htdocs/app/etc/env.php`\u3092\u958b\u3044\u3066\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n```sh\n$ sudo vim /opt/bitnami/apps/magento/htdocs/app/etc/env.php\n```\n\n![\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2016-12-16 18.20.24.png](https://qiita-image-store.s3.amazonaws.com/0/50629/4c09a857-f880-707a-746e-1acf0a38bc68.png \"\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2016-12-16 18.20.24.png\")\n\n\n[\u516c\u5f0f\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8:mysqldump \u30d5\u30a1\u30a4\u30eb\u306e\u4f5c\u6210](https://cloud.google.com/sql/docs/import-export/creating-mysqldump-csv#mysqldump)\u3092\u53c2\u8003\u306b\u30c0\u30f3\u30d7\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n\n```sh\n$ mysqldump --databases bitnami_magento -h localhost -u bn_magento -p --hex-blob --skip-triggers --default-character-set=utf8 > magento_backup\n.sql\n```\n\n\u4f5c\u6210\u3057\u305f\u30c0\u30f3\u30d7\u30d5\u30a1\u30a4\u30eb\u3092\u5148\u7a0b\u4f5c\u6210\u3057\u305fGoogle Cloud Storage\u306e\u30d0\u30b1\u30c3\u30c8\u306b\u8ee2\u9001\u3057\u307e\u3059\u3002\n\n```sh\n$ gsutil cp ./magento_backup.sql gs://magento2-sql-backup-bucket\n```\n\nGoogle Cloud Storage\u306b\u30a2\u30af\u30bb\u30b9\u3057\u3066\u8ee2\u9001\u3055\u308c\u305f\u3053\u3068\u3092\u78ba\u8a8d\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n![\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2016-12-15 18.59.20.png](https://qiita-image-store.s3.amazonaws.com/0/50629/ee0ffeaf-122d-252c-8fcd-1ebda8c6d253.png \"\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2016-12-15 18.59.20.png\")\n\n### Cloud SQL\u306e\u8d77\u52d5\n\n[Google Cloud SQL](https://console.cloud.google.com/sql)\u306b\u30a2\u30af\u30bb\u30b9\u3057\u307e\u3059\u3002\u7b2c2\u4e16\u4ee3\u306fMySQL\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u3067\u3059\u3002\u30b5\u30dd\u30fc\u30c8\u30d0\u30fc\u30b8\u30e7\u30f3\u306f5.6,5.7\u3001\u30a8\u30f3\u30b8\u30f3\u306fInnoDB\u306e\u307f\u306a\u306e\u3067\u3001Magento2\u306b\u306f\u5fc5\u8981\u5341\u5206\u3060\u3068\u601d\u3044\u307e\u3059\u3002\n\n![\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2016-12-16 10.28.48.png](https://qiita-image-store.s3.amazonaws.com/0/50629/31777540-43be-9198-3a48-5b0e2a33782a.png \"\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2016-12-16 10.28.48.png\")\n\n\u30ed\u30b1\u30fc\u30b7\u30e7\u30f3\u306fMagento2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3068\u540c\u3058\u306b\u3057\u3066\u304a\u304f\u3068\u826f\u3044\u3067\u3057\u3087\u3046\u3002\u901a\u5e38\u6642\u3084[HA\u306a\u69cb\u6210](https://cloud.google.com/sql/docs/configure-ha)\u306b\u3057\u305f\u6642\u306e\u6027\u80fd\u306a\u3069\u672a\u691c\u8a3c\u3067\u3059\u304c\u3001\u5b9a\u671f\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u304c\u53d6\u308c\u308b\u3060\u3051\u3067\u3082\u5e78\u305b\u3067\u3059\u306d\u3002\n\n![\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2016-12-16 11.09.07.png](https://qiita-image-store.s3.amazonaws.com/0/50629/dda0a9aa-228f-88ce-b662-e164d7d9ac1e.png \"\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2016-12-16 11.09.07.png\")\n\n\n\u4f5c\u6210\u3055\u308c\u305f\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306b\u306fIPv4\u30a2\u30c9\u30ec\u30b9\u304c\u5272\u308a\u5f53\u3066\u3089\u308c\u3066\u3044\u307e\u3059\u3002\u5185\u90e8IP\u3067\u30a2\u30af\u30bb\u30b9\u3067\u304d\u306a\u3044\u306e\uff1f\u3063\u3066\u306a\u3063\u305f\u306e\u3067\u3059\u304c\u3001\u30cd\u30c3\u30c8\u306e\u58f0\u3092\u62fe\u3063\u3066\u307f\u308b\u3068\u307f\u3093\u306a\u601d\u3046\u3068\u3053\u308d\u306f\u540c\u3058\u307f\u305f\u3044\u3067\u3059\u306d\u3002\n\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u63a5\u7d9a\u540d\u306fMagento2\u306e\u8a2d\u5b9a\u306b\u4f7f\u7528\u3059\u308b\u306e\u3067\u899a\u3048\u3066\u304a\u3044\u3066\u304f\u3060\u3055\u3044\u3002\n\n### MySQL\u30c0\u30f3\u30d7\u306e\u30a4\u30f3\u30dd\u30fc\u30c8\n\n\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u8a73\u7d30\u304b\u3089\u300c\u30a4\u30f3\u30dd\u30fc\u30c8\u300d\u3092\u30af\u30ea\u30c3\u30af\u3057\u3066\u3001Cloud Storage\u30d5\u30a1\u30a4\u30eb\u3092\u9078\u629e\u3057\u307e\u3059\u3002\n\n![\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2016-12-16 11.17.33.png](https://qiita-image-store.s3.amazonaws.com/0/50629/8391bfc7-4f8d-9c35-ff8d-1f6f23d5da65.png \"\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2016-12-16 11.17.33.png\")\n\n\u521d\u671f\u30c7\u30fc\u30bf\u306e\u307f\u306a\u306e\u3067\u3001\u30a4\u30f3\u30dd\u30fc\u30c8\u306f1\u5206\u3082\u304b\u304b\u3089\u305a\u306b\u7d42\u308f\u308a\u307e\u3059\u3002\n\n### MySQL\u30e6\u30fc\u30b6\u306e\u4f5c\u6210\n\nMagento2\u7528\u306e\u30e6\u30fc\u30b6\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\u30a2\u30af\u30bb\u30b9\u5236\u5fa1/\u30e6\u30fc\u30b6\u30fc/\u30e6\u30fc\u30b6\u30fc\u30a2\u30ab\u30a6\u30f3\u30c8\u3092\u4f5c\u6210\u3092\u30af\u30ea\u30c3\u30af\u3059\u308b\u3068\u30c0\u30a4\u30a2\u30ed\u30b0\u304c\u958b\u304f\u306e\u3067\u30e6\u30fc\u30b6\u30fc\u540d\u30fb\u30d1\u30b9\u30ef\u30fc\u30c9\u3092\u5165\u529b\u3057\u3066\u4f5c\u6210\u3057\u3066\u304f\u3060\u3055\u3044\u3002\u65e2\u5b58\u306e\u8a2d\u5b9a\u304b\u3089\u5909\u3048\u306a\u3044\u5834\u5408\u306f\u3001\u30c0\u30f3\u30d7\u30d5\u30a1\u30a4\u30eb\u4f5c\u6210\u6642\u306b\u78ba\u8a8d\u3057\u305fMagento2\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb`env.php`\u306e\u30e6\u30fc\u30b6\u30fc\u540d\u3068\u30d1\u30b9\u30ef\u30fc\u30c9\u3092\u6307\u5b9a\u3057\u307e\u3059\u3002\u30db\u30b9\u30c8\u540d\u306f\u300c\u3059\u3079\u3066\u306e\u30db\u30b9\u30c8\u3092\u8a31\u53ef\u3059\u308b\u300d\u3092\u9078\u629e\u3057\u3066\u304f\u3060\u3055\u3044\u3002\u3064\u3044\u3067\u306broot\u306e\u30d1\u30b9\u30ef\u30fc\u30c9\u3082\u5909\u66f4\u3057\u3066\u304a\u304f\u3068\u826f\u3044\u3068\u601d\u3044\u307e\u3059\u3002\n\n![\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2016-12-16 11.26.25.png](https://qiita-image-store.s3.amazonaws.com/0/50629/82bf8fa3-5c56-8031-ae9a-ccdbeb983d03.png \"\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2016-12-16 11.26.25.png\")\n\n### Cloud SQL\u63a5\u7d9a\u7528\u306e\u30bd\u30b1\u30c3\u30c8\u3092\u4f5c\u6210\n\n[Cloud SQL Proxy\u3092\u4f7f\u7528\u3057\u3066MySQL\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u306b\u63a5\u7d9a\u3059\u308b](https://cloud.google.com/sql/docs/mysql-connect-proxy)\u3092\u53c2\u8003\u306bCloud SQL\u63a5\u7d9a\u7528\u306e\u30bd\u30b1\u30c3\u30c8\u3092\u4f5c\u6210\u3057\u3066\u3044\u304d\u307e\u3059\u3002\n\nAPI\u3092\u5229\u7528\u3059\u308b\u305f\u3081[Cloud SQL Administration API \u3092\u6709\u52b9](https://console.cloud.google.com/flows/enableapi?apiid=sqladmin)\u306b\u3057\u307e\u3059\u3002\u8a8d\u8a3c\u60c5\u5831\u306e\u8a2d\u5b9a\u306f\u4e0d\u8981\u3067\u3059\u3002\n\n\u7d9a\u3044\u3066Magento2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306bSSH\u3067\u63a5\u7d9a\u3057\u307e\u3059\u3002\u307b\u307c\u30c1\u30e5\u30fc\u30c8\u30ea\u30a2\u30eb\u304b\u3089\u306e\u30b3\u30d4\u30da\u3067\u3059\u304c\u3001\u4e0b\u8a18\u30b3\u30de\u30f3\u30c9\u3092\u9806\u306b\u5b9f\u884c\u3057\u3066Cloud SQL Proxy\u3092\u958b\u59cb\u3057\u307e\u3059\u3002\n\n```sh\n# 1.\u30d7\u30ed\u30ad\u30b7\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u307e\u3059\u3002\n$ wget https://dl.google.com/cloudsql/cloud_sql_proxy.linux.amd64\n\n# 2.\u30d7\u30ed\u30ad\u30b7\u306e\u540d\u524d\u3092\u5909\u66f4\u3057\u3066\u6a19\u6e96\u306e\u30d5\u30a1\u30a4\u30eb\u540d\u3092\u4f7f\u7528\u3057\u307e\u3059\u3002\n$ mv cloud_sql_proxy.linux.amd64 cloud_sql_proxy\n\n# 3.\u30d7\u30ed\u30ad\u30b7\u3092\u5b9f\u884c\u3067\u304d\u308b\u3088\u3046\u306b\u3057\u307e\u3059\u3002\n$ chmod +x cloud_sql_proxy\n\n# 4.\u30d7\u30ed\u30ad\u30b7 \u30bd\u30b1\u30c3\u30c8\u3092\u683c\u7d0d\u3059\u308b\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n$ sudo mkdir /cloudsql; sudo chmod 777 /cloudsql\n\n# 5.Cloud SDK\u8a8d\u8a3c\u3068\u81ea\u52d5\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u691c\u51fa\u3092\u4f7f\u7528\u3057\u3066\u30d7\u30ed\u30ad\u30b7\u3092\u958b\u59cb\u3057\u307e\u3059\u3002\n$ sudo nohup ./cloud_sql_proxy -dir=/cloudsql &\n```\n\n### Magento2\u306e\u8a2d\u5b9a\u3092\u5909\u66f4\n\nCloud SQL\u306b\u30d7\u30ed\u30ad\u30b7\u3092\u5229\u7528\u3057\u3066\u63a5\u7d9a\u3059\u308b\u306b\u306f\u4e0b\u8a18\u306e\u3088\u3046\u306a\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3057\u307e\u3059\u3002\n\n```sh\n$ mysql -u root -p -S /cloudsql/\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u63a5\u7d9a\u540d\n```\n\n\u305d\u306e\u305f\u3081Magento2\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb`env.php`\u3082'db'\u306e'host'\u3092\u30d7\u30ed\u30ad\u30b7\u3092\u5229\u7528\u3059\u308b\u3088\u3046\u306b\u5909\u66f4\u3057\u307e\u3059\u3002\n\n```sh\n$ sudo vim ./apps/magento/htdocs/app/etc/env.php\n\n  'db' =>\n  array (\n    'table_prefix' => '',\n    'connection' =>\n    array (\n      'default' =>\n      array (\n        // (\u5909\u66f4\u524d) 'host' => '/opt/bitnami/mysql/tmp/mysql.sock',\n        'host' => '/cloudsql/xxxxxx:asia-northeast1:magento2-cloud-sql',\n        'dbname' => 'bitnami_magento',\n        'username' => 'bn_magento',\n        'password' => '62...\uff08\u7701\u7565\uff09\n```\n\n\u4ee5\u4e0a\u3067Magento2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u4e0a\u306eMySQL\u30b5\u30fc\u30d0\u304b\u3089Cloud SQL\u306b\u63a5\u7d9a\u5148\u304c\u5909\u66f4\u3055\u308c\u307e\u3057\u305f\u3002\n\n## \u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b5\uff08\u8ca0\u8377\u5206\u6563\uff09\n\n### \u4e8b\u524d\u6e96\u5099\n\n#### URL\u306e\u5909\u66f4\n\nMagento2\u306eURL\u3092\u5909\u66f4\u3057\u307e\u3059\u3002Certbot\u306a\u3069\u3067SSL\u5316\u6e08\u307f\u306e\u5834\u5408\u306f\u3053\u306e\u4f5c\u696d\u306f\u4e0d\u8981\u3067\u3059\u3002\u7ba1\u7406\u753b\u9762\u3092\u958b\u3044\u3066\u5909\u66f4\u3059\u308b\u3053\u3068\u3082\u3067\u304d\u307e\u3059\u304c\u3001\u4eca\u56de\u306f\u3053\u306e\u307e\u307e\u30b3\u30f3\u30bd\u30fc\u30eb\u3067\u4f5c\u696d\u3092\u7d9a\u3051\u307e\u3059\u3002\n\n```sh\n# \u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u30eb\u30fc\u30c8\u306b\u79fb\u52d5\n$ cd /opt/bitnami/apps/magento/htdocs\n\n# \u30d9\u30fc\u30b9URL\u3092\u5909\u66f4\n$ sudo php bin/magento setup:store-config:set --base-url=\"http://www.example.co.jp/\"\n\n# SSL\u63a5\u7d9aURL\u3092\u5909\u66f4\n$ sudo php bin/magento setup:store-config:set --base-url-secure=\"https://www.example.co.jp/\"\n```\n\n\u78ba\u8a8d\u306e\u305f\u3081Cloud SQL\u306bMySQL\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u3067\u63a5\u7d9a\u3057\u3066\u3001\u8a2d\u5b9a\u30c6\u30fc\u30d6\u30eb`core_config_data`\u304c\u66f8\u304d\u63db\u3048\u3089\u308c\u305f\u3053\u3068\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n```sh\n$ mysql -u bn_magento -p -D bitnami_magento -S /cloudsql/xxxxxx:asia-northeast1:magento2-cloud-sql\n\nmysql> select * from core_config_data;\n```\n\n![\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2016-12-16 13.23.10.png](https://qiita-image-store.s3.amazonaws.com/0/50629/8aadebde-8623-c645-218c-809b60092f93.png \"\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2016-12-16 13.23.10.png\")\n\n#### \u8a3c\u660e\u66f8\u306e\u53d6\u5f97\n\nSSL\u5316\u3059\u308b\u305f\u3081\u306e\u30c9\u30e1\u30a4\u30f3\u3068SSL\u30b5\u30fc\u30d0\u8a3c\u660e\u66f8\u3001\u4e2d\u9593CA\u8a3c\u660e\u66f8\u3001\u79d8\u5bc6\u9375\u306e3\u70b9\u30bb\u30c3\u30c8\u3092\u624b\u306b\u5165\u308c\u3066\u304a\u3044\u3066\u304f\u3060\u3055\u3044\u3002\u4f5c\u6210\u3057\u305fMagento2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u4e0a\u3067Certbot\u3092\u5229\u7528\u3057\u3066\u8a3c\u660e\u66f8\u3092\u53d6\u5f97\u3059\u308b\u5834\u5408\u306f\u3001Apache\u3084Varnish\u306a\u3069\u3092\u505c\u6b62\u3057\u3066\u304b\u3089`--standalone`\u3067Certbot\u3092\u8d77\u52d5\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n```sh\n$ sudo /opt/bitnami/ctlscript.sh stop\n$ sudo certbot certonly --standalone\n$ sudo /opt/bitnami/ctlscript.sh start\n```\n\n#### \u30d8\u30eb\u30b9\u30c1\u30a7\u30c3\u30af\u5bfe\u7b56\n\nMagento2\u306eURL\u8a2d\u5b9a\u3092\u5909\u66f4\u3057\u3066\u30c9\u30e1\u30a4\u30f3\u540d\u3067HTTP\u30a2\u30af\u30bb\u30b9\u3067\u304d\u308b\u3088\u3046\u306b\u3059\u308b\u3068\u3001IP\u30a2\u30c9\u30ec\u30b9\u3067\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3068\u30c9\u30e1\u30a4\u30f3\u540d\u306b\u30ea\u30c0\u30a4\u30ec\u30af\u30c8\u3055\u308c\u3066\u3057\u307e\u3046\u306e\u3067\u3001\u30d8\u30eb\u30b9\u30c1\u30a7\u30c3\u30af\u306e\u7d50\u679c\u304c\u30a8\u30e9\u30fc\u306b\u306a\u3063\u3066\u3057\u307e\u3044\u307e\u3059\u3002\u305d\u3053\u3067\u30d8\u30eb\u30b9\u30c1\u30a7\u30c3\u30af\u7528\u306e\u30d5\u30a1\u30a4\u30eb\u3092\u7528\u610f\u3057\u3066\u8a72\u5f53\u30d5\u30a1\u30a4\u30eb\u306b\u30a2\u30af\u30bb\u30b9\u3057\u305f\u3068\u304d\u3060\u3051\u306f200\u756a\u304c\u8fd4\u5374\u3055\u308c\u308b\u3088\u3046\u306b\u3057\u3066\u3044\u304d\u307e\u3059\u3002\n\n* http://104.198.124.255 -> http://www.example.co.jp/ (302 Found)\n* http://104.198.124.255/healthcheck.html -> http://104.198.124.255/healthcheck.html (200 OK)\n\nMagento2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306bSSH\u3067\u63a5\u7d9a\u3057\u307e\u3059\u3002`/opt/bitnami/apps/magento/htdocs/`\u304cMagento2\u306e\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u30eb\u30fc\u30c8\u306a\u306e\u3067\u76f4\u4e0b\u306b`healthcheck.html`\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n```sh\n$ sudo vim /opt/bitnami/apps/magento/htdocs/healthcheck.html\n```\n\n\u4e2d\u8eab\u306f\u306a\u3093\u3067\u3082\u826f\u3044\u306e\u3067\u9069\u5f53\u306b\u7de8\u96c6\u3057\u3066\u4fdd\u5b58\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n```html\n<!doctype html><html><body><h1>instance-1</h1></body></html>\n```\n\n\u53c2\u8003: [Redirect HTTP to HTTPS in Wordpress running behind a Google HTTP Load Balancer](http://code.haleby.se/2015/12/11/redirect-http-to-https-in-wordpress-running-behind-a-google-http-load-balancer/)\n\n#### HTTPS Termination\u6642\u306e\u30ea\u30c0\u30a4\u30ec\u30af\u30c8\u30eb\u30fc\u30d7\u5bfe\u7b56\n\n\u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b5\u306e\u30d0\u30c3\u30af\u30a8\u30f3\u30c9\u306bMagento2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u914d\u7f6e\u3059\u308b\u3068SSL\u30a2\u30af\u30bb\u30b9\u3057\u305f\u3068\u304d\u306b\u30ea\u30c0\u30a4\u30ec\u30af\u30c8\u30eb\u30fc\u30d7\u304c\u767a\u751f\u3057\u307e\u3059\u3002\u305d\u306e\u305f\u3081`X-Forwarded-Proto`\u304c`https`\u3060\u3063\u305f\u3068\u304d\u306b`HTTPS=on`\u306b\u3057\u307e\u3059\u3002\u901a\u5e38`.htaccess`\u3092\u66f8\u304d\u63db\u3048\u308b\u308f\u3051\u3067\u3059\u304c\u30d5\u30a1\u30a4\u30eb\u3092\u958b\u304f\u3068\u5909\u66f4\u3057\u3066\u3082\u53cd\u6620\u3055\u308c\u306a\u3044\u7684\u306a\u3053\u3068\u304c\u66f8\u3044\u3066\u3042\u3063\u305f\u306e\u3067`httpd.conf`\u3092\u5909\u3048\u3066\u3057\u307e\u3044\u307e\u3059\u3002\n\n```sh\n$ sudo vim /opt/bitnami/apache2/conf/httpd.conf\n\n...\n# \u8ffd\u8a18\nSetEnvIf X-Forwarded-Proto https HTTPS=on\n\nInclude \"/opt/bitnami/apache2/conf/ssi.conf\"\n...\n```\n\nInclude\u3067\u4ed6\u306e\u30b3\u30f3\u30d5\u30a3\u30b0\u30d5\u30a1\u30a4\u30eb\u3092\u8aad\u307f\u8fbc\u3080\u524d\u306b\u8ffd\u8a18\u3057\u3066\u3044\u307e\u3059\u3002\n\n\u53c2\u8003: [Magento SSL Offloading with Amazon ELB](http://www.aschroder.com/2012/07/magento-ssl-offloading-with-amazon-elb/)\n\n### \u30d0\u30c3\u30af\u30a8\u30f3\u30c9\u306e\u6e96\u5099\n\n\u6e96\u5099\u304c\u7d42\u308f\u3063\u305f\u306e\u3067\u3001\u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b5\u306e\u30d0\u30c3\u30af\u30a8\u30f3\u30c9\u3092\u69cb\u7bc9\u3057\u3066\u3044\u304d\u307e\u3059\u3002\nCompute Engine\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9 \u30b0\u30eb\u30fc\u30d7\u3092\u9078\u629e\u3057\u3066\u3001\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9 \u30b0\u30eb\u30fc\u30d7\u3092\u4f5c\u6210\u3057\u307e\u3057\u3087\u3046\u3002\n\n![\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2016-12-16 14.36.09.png](https://qiita-image-store.s3.amazonaws.com/0/50629/bcc1d169-d914-22c2-a5e9-29e059f9c601.png \"\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2016-12-16 14.36.09.png\")\n\n\u30ed\u30b1\u30fc\u30b7\u30e7\u30f3\u306b\u30b7\u30f3\u30b0\u30eb\u30be\u30fc\u30f3\u3092\u9078\u629e\u3057\u3066\u3001\u65e2\u5b58\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3068\u3057\u3066Magento2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u9078\u3073\u307e\u3059\u3002\n\n\u7d9a\u3044\u3066\u30d8\u30eb\u30b9\u30c1\u30a7\u30c3\u30af\u306e\u4f5c\u6210\u3067\u3059\u3002\u3055\u304f\u3055\u304f\u884c\u304d\u307e\u3059\u3002\n\n![\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2016-12-16 14.39.09.png](https://qiita-image-store.s3.amazonaws.com/0/50629/9994b996-bfde-acef-41f5-b48932e1e2f0.png \"\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2016-12-16 14.39.09.png\")\n\n\u30ea\u30af\u30a8\u30b9\u30c8\u30d1\u30b9\u306b\u5148\u7a0b\u4f5c\u6210\u3057\u305f`healthcheck.html`\u3092\u6307\u5b9a\u3057\u307e\u3059\u3002\n\n### \u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b5\uff08\u8ca0\u8377\u5206\u6563\uff09\n\n\u30cd\u30c3\u30c8\u30ef\u30fc\u30ad\u30f3\u30b0\u304b\u3089\u8ca0\u8377\u5206\u6563\u3092\u9078\u629e\u3057\u3066\u300c\u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b5\u3092\u4f5c\u6210\u300d\u3057\u307e\u3059\u3002\nHTTP\uff08S\uff09\u8ca0\u8377\u5206\u6563\u306e\u300c\u8a2d\u5b9a\u3092\u958b\u59cb\u300d\u30dc\u30bf\u30f3\u3092\u30af\u30ea\u30c3\u30af\u3059\u308b\u3068\u30c1\u30e5\u30fc\u30c8\u30ea\u30a2\u30eb\u5f62\u5f0f\u3067\u8a2d\u5b9a\u304c\u958b\u59cb\u3055\u308c\u307e\u3059\u3002\n\n![\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2016-12-16 14.43.42.png](https://qiita-image-store.s3.amazonaws.com/0/50629/6ee4a525-a04d-26a8-c04f-a920a5a5d724.png \"\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2016-12-16 14.43.42.png\")\n\n\u30d0\u30c3\u30af\u30a8\u30f3\u30c9\u30b5\u30fc\u30d3\u30b9\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n![\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2016-12-16 14.46.33.png](https://qiita-image-store.s3.amazonaws.com/0/50629/06e73b27-7bcf-3a53-eeda-363eed10241f.png \"\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2016-12-16 14.46.33.png\")\n\n\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u30b0\u30eb\u30fc\u30d7\u3068\u30d8\u30eb\u30b9\u30c1\u30a7\u30c3\u30af\u306b\u5148\u7a0b\u4f5c\u6210\u3057\u305f\u3082\u306e\u3092\u6307\u5b9a\u3057\u307e\u3059\u3002\n\n![\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2016-12-16 14.48.12.png](https://qiita-image-store.s3.amazonaws.com/0/50629/9c76457b-d4ac-e8dd-0721-a7f84c9005c6.png \"\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2016-12-16 14.48.12.png\")\n\n\u3064\u3044\u3067\u306b[Cloud CDN](https://cloud.google.com/cdn/docs/overview)\u306b\u3082\u30c1\u30a7\u30c3\u30af\u3092\u5165\u308c\u3066\u304a\u304f\u3068\uff08\u6599\u91d1\u306f\u767a\u751f\u3057\u307e\u3059\u304c\uff09\u3055\u3089\u306a\u308b\u9ad8\u901f\u5316\u304c\u671b\u3081\u3066\u5b09\u3057\u3044\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u3002\n\n\u30db\u30b9\u30c8\u3068\u30d1\u30b9\u306e\u30eb\u30fc\u30eb\u306f\u30d0\u30c3\u30af\u30a8\u30f3\u30c9\u304c1\u3064\u3057\u304b\u306a\u3044\u306e\u3067\u305d\u306e\u307e\u307e\u3067\u826f\u304f\u3066\u3001\u30d5\u30ed\u30f3\u30c8\u30a8\u30f3\u30c9\u3092\u8a2d\u5b9a\u3057\u3066\u3044\u304d\u307e\u3059\u3002IP\u30a2\u30c9\u30ec\u30b9\u306e\u4f5c\u6210\u3092\u9078\u3093\u3067\u9759\u7684IP\u3092\u7533\u8acb\u3057\u307e\u3059\u3002\u30c8\u30e9\u30a4\u30a2\u30eb\u306e\u67a0\u5185\u3060\u3068\u8cb4\u91cd\u306a1\u500b\u3092\u3053\u3053\u3067\u4f7f\u3044\u307e\u3059\u3002Magento2\u306f\u7ba1\u7406\u753b\u9762\u304b\u3089HSTS\u306e\u8a2d\u5b9a\u306a\u3069\u304c\u3067\u304d\u308b\u306e\u3067\u3059\u304c\u3001\u3044\u3063\u305f\u3093HTTP\u3068HTTPS\u306e\u4e21\u65b9\u306e\u30ea\u30af\u30a8\u30b9\u30c8\u3092\u8a31\u53ef\u3057\u3066\u3044\u307e\u3059\u3002\n\n![\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2016-12-16 15.14.44.png](https://qiita-image-store.s3.amazonaws.com/0/50629/181eeccb-8095-906b-2dcc-8189f6f66cb5.png \"\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2016-12-16 15.14.44.png\")\n\n\u65b0\u3057\u3044\u8a3c\u660e\u66f8\u306e\u4f5c\u6210\u3067\u306f\u3001\u4e8b\u524d\u306b\u6e96\u5099\u3057\u3066\u304a\u3044\u305fSSL\u8a3c\u660e\u66f8\u3068\u4e2d\u9593\u8a3c\u660e\u66f8\u3068\u79d8\u5bc6\u9375\u3092\u9806\u306b\u8cbc\u308a\u4ed8\u3051\u3066or\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u3057\u3066\u3044\u304d\u307e\u3059\u3002\n\n![\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2016-12-16 15.02.48.png](https://qiita-image-store.s3.amazonaws.com/0/50629/befe5249-8fed-1c5d-ee57-c20e7de2afa1.png \"\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2016-12-16 15.02.48.png\")\n\n\u5168\u3066\u306e\u8a2d\u5b9a\u304c\u7d42\u308f\u3063\u3066\u300c\u4f5c\u6210\u300d\u3092\u30af\u30ea\u30c3\u30af\u3059\u308b\u3068\u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b5\u304c\u4f5c\u6210\u3055\u308c\u307e\u3059\u3002\n\n### DNS\u306e\u8a2d\u5b9a\u3092\u5909\u66f4\n\n\u6700\u5f8c\u306b\u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b5\u3067\u8a2d\u5b9a\u3057\u305fIP\u30a2\u30c9\u30ec\u30b9\u3092DNS\u306eA\u30ec\u30b3\u30fc\u30c9\u306b\u8a2d\u5b9a\u3057\u3066\u3042\u3052\u308c\u3070OK\u3067\u3059\u3002\n\n![\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2016-12-16 17.56.40.png](https://qiita-image-store.s3.amazonaws.com/0/50629/87a5d17a-acbf-f758-1b10-2af74ad27dad.png \"\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2016-12-16 17.56.40.png\")\n\nHTTP2\u3067\u30a2\u30af\u30bb\u30b9\u3067\u304d\u308b\u3053\u3068\u304c\u78ba\u8a8d\u3067\u304d\u307e\u3057\u305f\uff01\n\n## \u3042\u3068\u304c\u304d\n\nGoogle Cloud Platform\u306b\u521d\u3081\u3066\u89e6\u308c\u305f\u306e\u3067\u7d50\u69cb\u5927\u5909\u3067\u3057\u305f\u3002\u7279\u306bCloud API\u306e\u30a2\u30af\u30bb\u30b9\u7bc4\u56f2\u3092\u6709\u52b9\u5316\u3057\u3066\u304a\u304b\u306a\u3044\u3068API\u304c\u5229\u7528\u3067\u304d\u306a\u304b\u3063\u305f\u308a\u3001\u30d8\u30eb\u30b9\u30c1\u30a7\u30c3\u30af\u7528\u306bIP\u30a2\u30c9\u30ec\u30b9\u3067\u30a2\u30af\u30bb\u30b9\u3057\u305f\u3068\u304d\u306b200\u756a\u3092\u8fd4\u5374\u3059\u308bURL\u3092\u6e96\u5099\u3059\u308b\u5fc5\u8981\u304c\u3042\u3063\u305f\u308a\u3068\u3001Magento2\u3068\u95a2\u4fc2\u306a\u3044\u3068\u3053\u308d\u3067\u82e6\u52b4\u3057\u305f\u611f\u3058\u3067\u3059\u3002\n\n\u4e00\u65b9\u3067\u8a2d\u5b9a\u3060\u3051\u3067Redis\u3092\u5229\u7528\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u3063\u305f\u3053\u3068\u306b\u306f\u6b63\u76f4\u9a5a\u3044\u3066\u3057\u307e\u3044\u307e\u3057\u305f\u3002\u3057\u304b\u3082Redis\u306e\u8a2d\u5b9a\u3092\u3057\u305f\u6642\u304c\u4e00\u756a\u9ad8\u901f\u5316\u306e\u6069\u6075\u3092\u611f\u3058\u305f\u306e\u3067\u3001\u904b\u7528\u3059\u308b\u3068\u304d\u306f\u8ed2\u4e26\u307f\u8a2d\u5b9a\u3057\u305f\u3044\u3068\u3053\u308d\u3067\u3059\u306d\u3002\u3044\u305f\u308b\u3068\u3053\u308d\u3067\u30ad\u30e3\u30c3\u30b7\u30e5\u3092\u5229\u7528\u3057\u3066\u3044\u308b\u306e\u3067\u4e0d\u5177\u5408\u767a\u751f\u6642\u306e\u5207\u308a\u5206\u3051\u304c\u5927\u5909\u305d\u3046\u306a\u306e\u306f\u30c8\u30ec\u30fc\u30c9\u30aa\u30d5\u3068\u3044\u3046\u3053\u3068\u3067\u3002\n", "tags": ["GoogleCloudSQL", "Redis", "GoogleCloudPlatform", "Magento2"]}