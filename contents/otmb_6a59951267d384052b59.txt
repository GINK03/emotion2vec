{"tags": ["gomobile", "golang", "clang", "Unity", "Android"], "context": "\u524d\u56de\u66f8\u3044\u305f\u300cGomobile\u3067\u4f5c\u3063\u305fAAR\u3092\u3070\u3089\u3057\u3066Shared Library\u3060\u3051\u3092Unity\u3067\u52d5\u304b\u3057\u3066\u307f\u305f\u300d\u3067\u306f\u95a2\u6570\u306e\u30b3\u30fc\u30eb\u304c\u9577\u304f\u3066\u6c17\u6301\u3061\u60aa\u304b\u3063\u305f\u3002\n\u300cgolang/mobile/cmd/gomobile/bind_test.go\u300d\u3092\u53c2\u8003\u306b\u30d3\u30eb\u30c9\u30b3\u30de\u30f3\u30c9\u3092\u8abf\u3079\u3066\u307f\u305f\u3002\n\u629c\u7c8b\u3057\u305f\u30d3\u30eb\u30c9\u30b3\u30de\u30f3\u30c9\u306f\u3053\u3093\u306a\u306e\nGOMOBILE=$GOPATH/pkg/gomobile \\\nGOOS=android \\\nGOARCH=arm \\\nNDK=ndk-r12b \\\nCC=$GOMOBILE/android-${NDK}/arm/bin/arm-linux-androideabi-clang \\\nCXX=$GOMOBILE/android-${NDK}/arm/bin/arm-linux-androideabi-clang++ \\\nCGO_CFLAGS=\"-target armv7a-none-linux-androideabi --sysroot $GOMOBILE/android-${NDK}/arm/sysroot\" \\\nCGO_CPPFLAGS=\"-target armv7a-none-linux-androideabi --sysroot $GOMOBILE/android-${NDK}/arm/sysroot\" \\\nCGO_LDFLAGS=\"-target armv7a-none-linux-androideabi --sysroot $GOMOBILE/android-${NDK}/arm/sysroot\" \\\nCGO_ENABLED=1 GOARM=7 go build -pkgdir=$GOMOBILE/pkg_android_arm \\\n-tags=\"\" -x -buildmode=c-shared \\\n-o=./hoge/libhoge.so \\\nhoge.go\n\n\u30b3\u30fc\u30c9\u306fCommand cgo\u306b\u3042\u308b\u3088\u3046\u306bexport\u3064\u3051\u3066\u304a\u3051\u3070\u826f\u3044\u3088\u3046\u3060\u3002\n\nhoge.go\npackage main\n\nimport \"C\"\n\n//export MyFunction\nfunc MyFunction() int {\n  return 10\n}\n\nfunc main() {\n}\n\n\n\u5b9f\u884c\u3059\u308b\u3068./hoge/libhoge.so./hoge/libhoge.h\u304c\u51fa\u529b\u3055\u308c\u308b\nlibhoge.so\u3092Unity\u306e\u74b0\u5883\u306b\u914d\u7f6e\u3057\u3001\u30af\u30ea\u30c3\u30af\u3067\u52a0\u7b97\u3059\u308b\u51e6\u7406\u3067\u5b9f\u884c\u3057\u305f\u3002\n\nButtonTest.cs\nusing UnityEngine;\nusing System.Runtime.InteropServices;\n\npublic class ButtonTest : MonoBehaviour {\n\n    int gnum = 0;\n\n    [DllImport(\"hoge\")]\n    private static extern int MyFunction();\n\n    public void TestClick()\n    {\n        int num = MyFunction();\n        Debug.Log(num);\n        gnum += num;\n    }\n\n    void OnGUI(){\n        GUI.Label (new Rect (0, 0, 100, 30), gnum.ToString());\n    }\n}\n\n\n\u7121\u4e8b\u306b\u3001\u77ed\u3044\u95a2\u6570\u540d\u3067\u30b3\u30fc\u30eb\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3057\u305f\u3002\n\nnm data section\n\u53c2\u8003\u307e\u3067\u306b nm data section\n% nm -D libhoge.so | grep -i MyFunction\n0006d548 T MyFunction\n00012000 T _cgoexp_df1f512bfd60_MyFunction\n\n\n\u305d\u306e\u4ed6\nx86\u306e\u30d3\u30eb\u30c9\u30b3\u30de\u30f3\u30c9\u306f\u3069\u3053\u306b\u3042\u308b\u306e\u3060\u308d\u3046\uff1f\nmobile/cmd/gomobile/env.go\u3092\u53c2\u8003\u306b\u3059\u308b\u3068\u4e0b\u8a18\u304c\u66f8\u3044\u3066\u3042\u308b\u3093\u3060\u304c\u3002\u3002\n\"386\": {\n    arch:       \"x86\",\n    abi:        \"x86\",\n    platform:   \"android-15\",\n    gcc:        \"x86-4.9\",\n    toolPrefix: \"i686-linux-android\",\n    minGoVer:   go1_6,\n},\n\n\u307e\u305f\u4eca\u5ea6\u63a2\u3057\u3066\u307f\u3088\u3046\u3002\n\n\u524d\u56de\u66f8\u3044\u305f\u300c[Gomobile\u3067\u4f5c\u3063\u305fAAR\u3092\u3070\u3089\u3057\u3066Shared Library\u3060\u3051\u3092Unity\u3067\u52d5\u304b\u3057\u3066\u307f\u305f](http://qiita.com/otmb/items/e4bb761e4f75c0730095)\u300d\u3067\u306f\u95a2\u6570\u306e\u30b3\u30fc\u30eb\u304c\u9577\u304f\u3066\u6c17\u6301\u3061\u60aa\u304b\u3063\u305f\u3002\n\u300c[golang/mobile/cmd/gomobile/bind_test.go](https://github.com/golang/mobile/blob/80e11ad07468005aecc250c69e7f8be51675185c/cmd/gomobile/bind_test.go)\u300d\u3092\u53c2\u8003\u306b\u30d3\u30eb\u30c9\u30b3\u30de\u30f3\u30c9\u3092\u8abf\u3079\u3066\u307f\u305f\u3002\n\n\u629c\u7c8b\u3057\u305f\u30d3\u30eb\u30c9\u30b3\u30de\u30f3\u30c9\u306f\u3053\u3093\u306a\u306e\n\n```\nGOMOBILE=$GOPATH/pkg/gomobile \\\nGOOS=android \\\nGOARCH=arm \\\nNDK=ndk-r12b \\\nCC=$GOMOBILE/android-${NDK}/arm/bin/arm-linux-androideabi-clang \\\nCXX=$GOMOBILE/android-${NDK}/arm/bin/arm-linux-androideabi-clang++ \\\nCGO_CFLAGS=\"-target armv7a-none-linux-androideabi --sysroot $GOMOBILE/android-${NDK}/arm/sysroot\" \\\nCGO_CPPFLAGS=\"-target armv7a-none-linux-androideabi --sysroot $GOMOBILE/android-${NDK}/arm/sysroot\" \\\nCGO_LDFLAGS=\"-target armv7a-none-linux-androideabi --sysroot $GOMOBILE/android-${NDK}/arm/sysroot\" \\\nCGO_ENABLED=1 GOARM=7 go build -pkgdir=$GOMOBILE/pkg_android_arm \\\n-tags=\"\" -x -buildmode=c-shared \\\n-o=./hoge/libhoge.so \\\nhoge.go\n```\n\n\n\u30b3\u30fc\u30c9\u306f[Command cgo](https://golang.org/cmd/cgo/)\u306b\u3042\u308b\u3088\u3046\u306bexport\u3064\u3051\u3066\u304a\u3051\u3070\u826f\u3044\u3088\u3046\u3060\u3002\n\n```go:hoge.go\npackage main\n\nimport \"C\"\n\n//export MyFunction\nfunc MyFunction() int {\n  return 10\n}\n\nfunc main() {\n}\n```\n\n\u5b9f\u884c\u3059\u308b\u3068`./hoge/libhoge.so``./hoge/libhoge.h`\u304c\u51fa\u529b\u3055\u308c\u308b\n`libhoge.so`\u3092Unity\u306e\u74b0\u5883\u306b\u914d\u7f6e\u3057\u3001\u30af\u30ea\u30c3\u30af\u3067\u52a0\u7b97\u3059\u308b\u51e6\u7406\u3067\u5b9f\u884c\u3057\u305f\u3002\n\n```csharp:ButtonTest.cs\nusing UnityEngine;\nusing System.Runtime.InteropServices;\n\npublic class ButtonTest : MonoBehaviour {\n\n\tint gnum = 0;\n\n\t[DllImport(\"hoge\")]\n\tprivate static extern int MyFunction();\n\n\tpublic void TestClick()\n\t{\n\t\tint num = MyFunction();\n\t\tDebug.Log(num);\n\t\tgnum += num;\n\t}\n\n\tvoid OnGUI(){\n\t\tGUI.Label (new Rect (0, 0, 100, 30), gnum.ToString());\n\t}\n}\n```\n\n\u7121\u4e8b\u306b\u3001\u77ed\u3044\u95a2\u6570\u540d\u3067\u30b3\u30fc\u30eb\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3057\u305f\u3002\n\n## nm data section\n\n\u53c2\u8003\u307e\u3067\u306b nm data section\n\n```\n% nm -D libhoge.so | grep -i MyFunction\n0006d548 T MyFunction\n00012000 T _cgoexp_df1f512bfd60_MyFunction\n```\n\n## \u305d\u306e\u4ed6\n\nx86\u306e\u30d3\u30eb\u30c9\u30b3\u30de\u30f3\u30c9\u306f\u3069\u3053\u306b\u3042\u308b\u306e\u3060\u308d\u3046\uff1f\n\n[mobile/cmd/gomobile/env.go](https://github.com/golang/mobile/blob/80e11ad07468005aecc250c69e7f8be51675185c/cmd/gomobile/env.go)\u3092\u53c2\u8003\u306b\u3059\u308b\u3068\u4e0b\u8a18\u304c\u66f8\u3044\u3066\u3042\u308b\u3093\u3060\u304c\u3002\u3002\n\n```\n\"386\": {\n\tarch:       \"x86\",\n\tabi:        \"x86\",\n\tplatform:   \"android-15\",\n\tgcc:        \"x86-4.9\",\n\ttoolPrefix: \"i686-linux-android\",\n\tminGoVer:   go1_6,\n},\n```\n\n\u307e\u305f\u4eca\u5ea6\u63a2\u3057\u3066\u307f\u3088\u3046\u3002\n"}