{"tags": ["ServiceWorker", "CommonJS", "JavaScript", "RequireJS", "\u30d6\u30e9\u30a6\u30b6"], "context": "ServiceWorker\u4f7f\u3048\u3070requirejs\u3067commonjs\u98a8\u306erequire\u3092\u5b9f\u73fe\u3057\u3066\u3044\u308b\u65b9\u6cd5\u3092\u53c2\u8003\u306b\u3001\u306a\u3093\u3068\u304b\u3067\u304d\u308b\u306e\u3067\u306f\u306a\u3044\u304b\u3068\u601d\u3063\u3066\u3001\n\u7a81\u8cab\u5de5\u4e8b\u3067\u3061\u3087\u3063\u3068\u3060\u3051\u52d5\u304d\u305d\u3046\u306a\u3082\u306e\u3092\u4f5c\u3063\u3066\u307f\u307e\u3057\u305f\u3002\n\n\u53c2\u8003\n\u30b0\u30b0\u3063\u305f\u3089\u51fa\u3066\u304d\u305f\u3002\nhttps://github.com/spite/service-worker-require/blob/master/service-worker.js\n\u305f\u3060\u3001\u3053\u306e\u4eba\u306e\u30a4\u30e1\u30fc\u30b8\u306fServiceWorker\u3067\u30d0\u30f3\u30c9\u30eb\u3057\u3066\u3044\u308b\u30a4\u30e1\u30fc\u30b8\u306a\u306e\u3067\u3001\u3082\u3046\u5c11\u3057\u9811\u5f35\u308c\u306a\u3044\u304b\u8003\u3048\u3066\u307f\u307e\u3057\u305f\u3002\n\n\u30b3\u30fc\u30c9\n\ncommonjs-wrapper.js\n/*global Promise*/\n(function() {\n    'use strict';\n    navigator.serviceWorker.register('commonjs-wrapper-service-worker.js').then(function(reg) {\n        reg.addEventListener('updatefound', function() {\n            //\u30a2\u30c3\u30d7\u30c7\u30fc\u30c8\u3055\u308c\u305f\u306e\u3067\u518d\u8aad\u307f\u8fbc\u307f\n            location.reload(true);\n        });\n\n        if (!navigator.serviceWorker.controller) {\n            //\u521d\u56de\u767b\u9332\u3055\u308c\u305f\u306e\u3067\u518d\u8aad\u307f\u8fbc\u307f\n            location.reload(true);\n        }\n    });\n\n    function Module() {\n        this.exports = {};\n    }\n\n    var listeners = {};\n\n    var modulesMap = {};\n\n    var scripts = document.getElementsByTagName('script');\n    var getScript = function(url) {\n        for (var i = 0; i < scripts.length; i++) {\n            if (scripts[i].src === url) {\n                return scripts[i];\n            }\n        }\n        return null;\n    };\n    var getBeforeScripts = function(url) {\n        var beforeScripts = [];\n        for (var i = 0; i < scripts.length; i++) {\n            if (scripts[i].src === url) {\n                return beforeScripts;\n            }\n            beforeScripts.push(scripts[i]);\n        }\n        return beforeScripts;\n    };\n    var hasScript = function(url) {\n        return !!getScript(url);\n    };\n\n    //script\u672c\u4f53\u5b9f\u884c\n    var executeScript = function(url, dependenciesMap, fn) {\n        var module = new Module();\n        var require = function(id) {\n            var depUrl = dependenciesMap[id];\n            return modulesMap[depUrl].exports;\n        };\n\n        fn(module.exports, require, module);\n\n        modulesMap[url] = module;\n\n        if (listeners[url]) {\n            listeners[url].forEach(function(listener) {\n                listener();\n            });\n            delete listeners[url];\n        }\n    };\n\n    //commonjs\u30e9\u30c3\u30d1\u30fc\u306e\u30e9\u30c3\u30d1\u30fc\u30e1\u30bd\u30c3\u30c9\n    window.commonjswrapper = function(url, dependenciesMap, fn) {\n        var dependencyUrls = Object.keys(dependenciesMap).map(function(k) {\n            return dependenciesMap[k];\n        });\n        var selfScript = getScript(url);\n\n        if (!selfScript.hasAttribute('data-commonjs-wrapper-dependency')) {\n            //commonjswrapper\u306e\u8ffd\u52a0\u5206\u3067\u306a\u3044\u5834\u5408\u3001\u81ea\u8eab\u3088\u308a\u3082\u524d\u306escript\u3082dependency\u5bfe\u8c61\u3068\u3059\u308b\n            dependencyUrls = dependencyUrls.concat(getBeforeScripts(url).filter(function(script) {\n                return script.hasAttribute('data-commonjs-wrapper-dependency');\n            }).map(function(script) {\n                return script.src;\n            }));\n        }\n        //\u5fc5\u8981\u306aModule\n        var needUrils = dependencyUrls.filter(function(depUrl) {\n            return !modulesMap[depUrl];\n        });\n        //\u8ffd\u52a0\u3067\u5fc5\u8981\u306aModule\u304c\u7121\u3051\u308c\u3070script\u5b9f\u884c\n        if (!needUrils.length) {\n            executeScript(url, dependenciesMap, fn);\n            return;\n        }\n\n        //\u5fc5\u8981\u306aModule\u3092\u8ffd\u52a0\n        Promise.all(needUrils.map(function(url) {\n            if (!hasScript(url)) {\n                var script = document.createElement('script');\n                script.src = url;\n                script.setAttribute('data-commonjs-wrapper-dependency', true);\n                document.head.appendChild(script);\n            }\n\n            return new Promise(function(resolve) {\n                var listenerList = listeners[url] || (listeners[url] = []);\n                listenerList.push(function() {\n                    resolve();\n                });\n            });\n        })).then(function() {\n            //Module\u304c\u3059\u3079\u3066\u8aad\u307f\u8fbc\u307e\u308c\u305f\u3089\u3001\u81ea\u8eab\u306escript\u3092\u5b9f\u884c\n            executeScript(url, dependenciesMap, fn);\n        });\n    };\n\n    //\u81ea\u8eab\u304c\u767b\u9332\u6e08\u3067\u3042\u308b\u3053\u3068\u3092\u6307\u793a\n    if (window.___url___) {\n        modulesMap[window.___url___] = new Module();\n    }\n})();\n\n\n\ncommonjs-wrapper-service-worker.js\n/*global Promise*/\n(function() {\n    'use strict';\n\n    //\u30e2\u30b8\u30e5\u30fc\u30eb\u306eURL\u53d6\u5f97\n    var getModleUrl = function(sourceUrl, module) {\n        //TODO npm\u306eurl\u3067\u53d6\u308c\u308b\u3088\u3046\u306b\u3057\u305f\u3044\u3002\n        //\u76f8\u5bfe\u304b\u3089\u7d76\u5bfePATH\u3078\u5909\u63db\n        return new Request(sourceUrl + '/../modules/' + module + '/index.js').url;\n    };\n\n    //\u30e9\u30c3\u30d7\u3057\u305f\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u8fd4\u3059\n    var createCommonJsWrapper = function(url, dependencies, originalScript) {\n        var res = new Response('(window.commonjswrapper || function(url, dependenciesMap, fn) {window.___url___ = url; fn(); delete window.___url___;} )(\"' +\n            url +\n            '\", {' +\n            dependencies.map(function(s) {\n                return '\"' + s + '\":\"' + getModleUrl(url, s) + '\"';\n            }).join(',') +\n            '}, function (exports, require, module) {' +\n            originalScript +\n            '});'\n        );\n        res.headers.append('Content-Type', 'text/plain;charset=UTF-8');\n        return res;\n    };\n\n    this.addEventListener('fetch', function(event) {\n        var url = event.request.url;\n\n        if (url.indexOf('.js') !== -1) {\n            event.respondWith(new Promise(function(resolve) {\n                fetch(event.request).then(function(res) {\n                    if (!res.ok) {\n                        return resolve(res);\n                    }\n                    return res.text();\n                }).then(function(textScript) {\n                    //\"require\"\u3092\u547c\u3073\u51fa\u3057\u3066\u3044\u308b\u7b87\u6240\u3092\u63a2\u3059\u3002\n                    //\u53c2\u8003\u306b\u3057\u307e\u3057\u305f\u3002 https://github.com/spite/service-worker-require\n                    var dependencies = [];\n                    var re = /require[\\s]*\\([\\s]*'([\\S]+)'[\\s]*\\)/gmi;\n                    var m;\n                    while ((m = re.exec(textScript)) !== null) {\n\n                        if (m.index === re.lastIndex) {\n                            re.lastIndex++;\n                        }\n                        //\u5fc5\u8981\u306a\u30e2\u30b8\u30e5\u30fc\u30eb\u3092\u8ffd\u52a0\n                        dependencies.push(m[1]);\n                    }\n\n                    resolve(createCommonJsWrapper(url, dependencies, textScript));\n                });\n            }));\n\n        } else {\n            event.respondWith(fetch(event.request));\n        }\n\n    });\n}).bind(self)();\n\n\n\n\u4f7f\u3044\u65b9\ncommonjs-wrapper.js\u3068commonjs-wrapper-service-worker.js\u3092html\u3068\u540c\u3058\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306b\u7f6e\u3044\u3066\u3001\nhtml\u3067\u3001commonjs-wrapper.js\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u8aad\u307f\u8fbc\u3080\u3002\n\u305d\u306e\u4ed6\u306escript\u306f\u3001\n\nmain.js\nvar hoge = require('hoge');\n\n\n\u307f\u305f\u3044\u306a\u8a18\u8ff0\u3067\u3001./modules/hoge/index.js \u30e2\u30b8\u30e5\u30fc\u30eb\u304c\u8aad\u307f\u8fbc\u3081\u308b\u3088\u3046\u306b\u306a\u308b\u3002\n\uff08\u7a81\u8cab\u306a\u306e\u3067\u3001./modules/***/index.js \u306f\u56fa\u5b9a\u30fb\u30fb\u30fb\uff09\n\n\u8aac\u660e\n\ncommonjs-wrapper-service-worker.js\n\u8a18\u8f09\u3057\u305f\u9806\u756a\u3068\u306f\u9006\u3067\u3059\u3051\u3069\u3001\u5148\u306bcommonjs-wrapper-service-worker.js\u306e\u8aac\u660e\u3092\u3057\u307e\u3059\u3002\n\u8aad\u307f\u8fbc\u3093\u3060\u3001js\u30d5\u30a1\u30a4\u30eb\u306e\u4e2d\u8eab\u306e\u6700\u521d\u3068\u6700\u5f8c\u306b\u5fc5\u8981\u306ascript\u3092\u8a18\u8ff0\uff08\u30e9\u30c3\u30d7\uff09\u3057\u3066\u8fd4\u3057\u307e\u3059\u3002\n\u3059\u3053\u3057\u7de8\u96c6\u3057\u3066\u3057\u307e\u3044\u307e\u3059\u304c\u884c\u306f\u5909\u308f\u3089\u306a\u3044\u306e\u3067\u3001\u30c7\u30d0\u30c3\u30b0\u3067\u306f\u4fbf\u5229\u306b\u306a\u3063\u3066\u3044\u308b\u3068\u601d\u3044\u305f\u3044\u3067\u3059\u3002  \n\ncommonjs-wrapper.js\n\u30e9\u30c3\u30d7\u30e1\u30bd\u30c3\u30c9\u672c\u4f53\u3092\u6301\u3063\u3066\u3044\u307e\u3059\u3002\nservice-worker\u3092\u767b\u9332\u3057\u305f\u308a\u3057\u3066\u3044\u307e\u3059\u304c\u305d\u3053\u306f\u91cd\u8981\u3058\u3083\u306a\u3044\u306e\u3067\u7aef\u6298\u308a\u307e\u3059\u3002\n    //commonjs\u30e9\u30c3\u30d1\u30fc\u306e\u30e9\u30c3\u30d1\u30fc\u30e1\u30bd\u30c3\u30c9\n    window.commonjswrapper = function(url, dependenciesMap, fn) {\n\n\u3068\u308a\u3042\u3048\u305a\u3001\u5f15\u6570\u306e\u8aac\u660e\u304b\u3089\u3002\n\nurl\nscript\u306eurl\u3067\u3059\u3002\n\ndependenciesMap\nscript\u3067require\u304c\u8a18\u8ff0\u3055\u308c\u305f\u4e2d\u8eab\u3068\u3001url\u306e\u30bb\u30c3\u30c8\u304c\u5165\u308a\u307e\u3059\u3002\n\nfn\nscript\u672c\u4f53\u306ecommonjs\u30e9\u30c3\u30d1\u30fc\u30e1\u30bd\u30c3\u30c9\u3067\u3059\u3002\n\n\nfn\u3092\u5b9f\u884c\u3059\u308b\u524d\u306b\u3001dependenciesMap\u306b\u5165\u3063\u305f\u3001\u30e2\u30b8\u30e5\u30fc\u30eb\u306escript\u304c\u8aad\u307f\u8fbc\u307e\u308c\u308b\u306e\u3092\u5f85\u3061\u3001\n\u6700\u7d42\u7684\u306bfn\u3092\u5b9f\u884c\u3057\u307e\u3059\u3002\u3053\u306e\u3042\u305f\u308a\u306frequirejs\u306e\u4ed5\u7d44\u307f\u3068\u540c\u3058\u3067\u3059\u306d\u3002\n\u3082\u3046\u5c11\u3057\u9811\u5f35\u3063\u3066\u308b\u3053\u3068\u3068\u3057\u3066\u306f\u3001html\u306b\u8a18\u8ff0\u3055\u308c\u305fscript\u306e\u5b9f\u884c\u9806\u5e8f\u3092\u4fdd\u8a3c\u3059\u308b\u305f\u3081\u306b\u3001\n\u81ea\u8eab\u306escript\u3088\u308a\u524d\u306b\u8a18\u8ff0\u3055\u308c\u305fscript\u304c\u8aad\u307f\u8fbc\u307e\u308c\u308b\u306e\u3092\u5f85\u3061\u307e\u3059\u3002\n\u3042\u3068\u306f\u9069\u5f53\u306b\u5f85\u3063\u3066\u5b9f\u884c\u3057\u3066\u308b\u3060\u3051\u3067\u3059\u3002  \n\u672c\u5f53\u306f\u3001package.json\u898b\u305f\u308a\u3001npm\u306eunpkg\u304b\u3089\u53d6\u3063\u3066\u304d\u305f\u308a\u3068\u304b\u3067\u304d\u3066\u304f\u308b\u3068\u3044\u3044\u611f\u3058\u306b\u306a\u308b\u304b\u3082\u3057\u308c\u306a\u3044\u3068\u601d\u3044\u3064\u3064\u3002\n\u6642\u9593\u3068\u308c\u306a\u3044\u306e\u3067\u3068\u308a\u3042\u3048\u305a\u8ae6\u3081\u3066\u6295\u7a3f\u3057\u307e\u3059\u3002\n\n\u307e\u3068\u3081\n\u3075\u3064\u3046\u306bwebpack\u3068\u304b\u4f7f\u3044\u307e\u3059\u306d\u3002\n\u30c7\u30d0\u30c3\u30b0\u3092\u4fbf\u5229\u306b\u3057\u305f\u304b\u3063\u305f\u306e\u3060\u3051\u3069\u3001\u3082\u3063\u3068\u771f\u9762\u76ee\u306b\u4f5c\u3089\u306a\u3044\u3068\u5168\u7136\u4f7f\u3048\u307e\u305b\u3093\u306d\u3002\n\u3068\u308a\u3042\u3048\u305a2016\u5e74\u4e2d\u306b40\u8a18\u4e8b\u9054\u6210\nServiceWorker\u4f7f\u3048\u3070[requirejs\u3067commonjs\u98a8\u306erequire\u3092\u5b9f\u73fe\u3057\u3066\u3044\u308b\u65b9\u6cd5](http://requirejs.org/docs/commonjs.html)\u3092\u53c2\u8003\u306b\u3001\u306a\u3093\u3068\u304b\u3067\u304d\u308b\u306e\u3067\u306f\u306a\u3044\u304b\u3068\u601d\u3063\u3066\u3001\n\u7a81\u8cab\u5de5\u4e8b\u3067\u3061\u3087\u3063\u3068\u3060\u3051\u52d5\u304d\u305d\u3046\u306a\u3082\u306e\u3092\u4f5c\u3063\u3066\u307f\u307e\u3057\u305f\u3002\n\n# \u53c2\u8003\n\u30b0\u30b0\u3063\u305f\u3089\u51fa\u3066\u304d\u305f\u3002\nhttps://github.com/spite/service-worker-require/blob/master/service-worker.js\n\u305f\u3060\u3001\u3053\u306e\u4eba\u306e\u30a4\u30e1\u30fc\u30b8\u306fServiceWorker\u3067\u30d0\u30f3\u30c9\u30eb\u3057\u3066\u3044\u308b\u30a4\u30e1\u30fc\u30b8\u306a\u306e\u3067\u3001\u3082\u3046\u5c11\u3057\u9811\u5f35\u308c\u306a\u3044\u304b\u8003\u3048\u3066\u307f\u307e\u3057\u305f\u3002\n\n# \u30b3\u30fc\u30c9\n\n```js:commonjs-wrapper.js\n/*global Promise*/\n(function() {\n\t'use strict';\n\tnavigator.serviceWorker.register('commonjs-wrapper-service-worker.js').then(function(reg) {\n\t\treg.addEventListener('updatefound', function() {\n\t\t\t//\u30a2\u30c3\u30d7\u30c7\u30fc\u30c8\u3055\u308c\u305f\u306e\u3067\u518d\u8aad\u307f\u8fbc\u307f\n\t\t\tlocation.reload(true);\n\t\t});\n\n\t\tif (!navigator.serviceWorker.controller) {\n\t\t\t//\u521d\u56de\u767b\u9332\u3055\u308c\u305f\u306e\u3067\u518d\u8aad\u307f\u8fbc\u307f\n\t\t\tlocation.reload(true);\n\t\t}\n\t});\n\n\tfunction Module() {\n\t\tthis.exports = {};\n\t}\n\n\tvar listeners = {};\n\n\tvar modulesMap = {};\n\n\tvar scripts = document.getElementsByTagName('script');\n\tvar getScript = function(url) {\n\t\tfor (var i = 0; i < scripts.length; i++) {\n\t\t\tif (scripts[i].src === url) {\n\t\t\t\treturn scripts[i];\n\t\t\t}\n\t\t}\n\t\treturn null;\n\t};\n\tvar getBeforeScripts = function(url) {\n\t\tvar beforeScripts = [];\n\t\tfor (var i = 0; i < scripts.length; i++) {\n\t\t\tif (scripts[i].src === url) {\n\t\t\t\treturn beforeScripts;\n\t\t\t}\n\t\t\tbeforeScripts.push(scripts[i]);\n\t\t}\n\t\treturn beforeScripts;\n\t};\n\tvar hasScript = function(url) {\n\t\treturn !!getScript(url);\n\t};\n\n\t//script\u672c\u4f53\u5b9f\u884c\n\tvar executeScript = function(url, dependenciesMap, fn) {\n\t\tvar module = new Module();\n\t\tvar require = function(id) {\n\t\t\tvar depUrl = dependenciesMap[id];\n\t\t\treturn modulesMap[depUrl].exports;\n\t\t};\n\n\t\tfn(module.exports, require, module);\n\n\t\tmodulesMap[url] = module;\n\n\t\tif (listeners[url]) {\n\t\t\tlisteners[url].forEach(function(listener) {\n\t\t\t\tlistener();\n\t\t\t});\n\t\t\tdelete listeners[url];\n\t\t}\n\t};\n\n\t//commonjs\u30e9\u30c3\u30d1\u30fc\u306e\u30e9\u30c3\u30d1\u30fc\u30e1\u30bd\u30c3\u30c9\n\twindow.commonjswrapper = function(url, dependenciesMap, fn) {\n\t\tvar dependencyUrls = Object.keys(dependenciesMap).map(function(k) {\n\t\t\treturn dependenciesMap[k];\n\t\t});\n\t\tvar selfScript = getScript(url);\n\n\t\tif (!selfScript.hasAttribute('data-commonjs-wrapper-dependency')) {\n\t\t\t//commonjswrapper\u306e\u8ffd\u52a0\u5206\u3067\u306a\u3044\u5834\u5408\u3001\u81ea\u8eab\u3088\u308a\u3082\u524d\u306escript\u3082dependency\u5bfe\u8c61\u3068\u3059\u308b\n\t\t\tdependencyUrls = dependencyUrls.concat(getBeforeScripts(url).filter(function(script) {\n\t\t\t\treturn script.hasAttribute('data-commonjs-wrapper-dependency');\n\t\t\t}).map(function(script) {\n\t\t\t\treturn script.src;\n\t\t\t}));\n\t\t}\n\t\t//\u5fc5\u8981\u306aModule\n\t\tvar needUrils = dependencyUrls.filter(function(depUrl) {\n\t\t\treturn !modulesMap[depUrl];\n\t\t});\n\t\t//\u8ffd\u52a0\u3067\u5fc5\u8981\u306aModule\u304c\u7121\u3051\u308c\u3070script\u5b9f\u884c\n\t\tif (!needUrils.length) {\n\t\t\texecuteScript(url, dependenciesMap, fn);\n\t\t\treturn;\n\t\t}\n\n\t\t//\u5fc5\u8981\u306aModule\u3092\u8ffd\u52a0\n\t\tPromise.all(needUrils.map(function(url) {\n\t\t\tif (!hasScript(url)) {\n\t\t\t\tvar script = document.createElement('script');\n\t\t\t\tscript.src = url;\n\t\t\t\tscript.setAttribute('data-commonjs-wrapper-dependency', true);\n\t\t\t\tdocument.head.appendChild(script);\n\t\t\t}\n\n\t\t\treturn new Promise(function(resolve) {\n\t\t\t\tvar listenerList = listeners[url] || (listeners[url] = []);\n\t\t\t\tlistenerList.push(function() {\n\t\t\t\t\tresolve();\n\t\t\t\t});\n\t\t\t});\n\t\t})).then(function() {\n\t\t\t//Module\u304c\u3059\u3079\u3066\u8aad\u307f\u8fbc\u307e\u308c\u305f\u3089\u3001\u81ea\u8eab\u306escript\u3092\u5b9f\u884c\n\t\t\texecuteScript(url, dependenciesMap, fn);\n\t\t});\n\t};\n\n\t//\u81ea\u8eab\u304c\u767b\u9332\u6e08\u3067\u3042\u308b\u3053\u3068\u3092\u6307\u793a\n\tif (window.___url___) {\n\t\tmodulesMap[window.___url___] = new Module();\n\t}\n})();\n```\n\n```js:commonjs-wrapper-service-worker.js\n/*global Promise*/\n(function() {\n\t'use strict';\n\n\t//\u30e2\u30b8\u30e5\u30fc\u30eb\u306eURL\u53d6\u5f97\n\tvar getModleUrl = function(sourceUrl, module) {\n\t\t//TODO npm\u306eurl\u3067\u53d6\u308c\u308b\u3088\u3046\u306b\u3057\u305f\u3044\u3002\n\t\t//\u76f8\u5bfe\u304b\u3089\u7d76\u5bfePATH\u3078\u5909\u63db\n\t\treturn new Request(sourceUrl + '/../modules/' + module + '/index.js').url;\n\t};\n\n\t//\u30e9\u30c3\u30d7\u3057\u305f\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u8fd4\u3059\n\tvar createCommonJsWrapper = function(url, dependencies, originalScript) {\n\t\tvar res = new Response('(window.commonjswrapper || function(url, dependenciesMap, fn) {window.___url___ = url; fn(); delete window.___url___;} )(\"' +\n\t\t\turl +\n\t\t\t'\", {' +\n\t\t\tdependencies.map(function(s) {\n\t\t\t\treturn '\"' + s + '\":\"' + getModleUrl(url, s) + '\"';\n\t\t\t}).join(',') +\n\t\t\t'}, function (exports, require, module) {' +\n\t\t\toriginalScript +\n\t\t\t'});'\n\t\t);\n\t\tres.headers.append('Content-Type', 'text/plain;charset=UTF-8');\n\t\treturn res;\n\t};\n\n\tthis.addEventListener('fetch', function(event) {\n\t\tvar url = event.request.url;\n\n\t\tif (url.indexOf('.js') !== -1) {\n\t\t\tevent.respondWith(new Promise(function(resolve) {\n\t\t\t\tfetch(event.request).then(function(res) {\n\t\t\t\t\tif (!res.ok) {\n\t\t\t\t\t\treturn resolve(res);\n\t\t\t\t\t}\n\t\t\t\t\treturn res.text();\n\t\t\t\t}).then(function(textScript) {\n\t\t\t\t\t//\"require\"\u3092\u547c\u3073\u51fa\u3057\u3066\u3044\u308b\u7b87\u6240\u3092\u63a2\u3059\u3002\n\t\t\t\t\t//\u53c2\u8003\u306b\u3057\u307e\u3057\u305f\u3002 https://github.com/spite/service-worker-require\n\t\t\t\t\tvar dependencies = [];\n\t\t\t\t\tvar re = /require[\\s]*\\([\\s]*'([\\S]+)'[\\s]*\\)/gmi;\n\t\t\t\t\tvar m;\n\t\t\t\t\twhile ((m = re.exec(textScript)) !== null) {\n\n\t\t\t\t\t\tif (m.index === re.lastIndex) {\n\t\t\t\t\t\t\tre.lastIndex++;\n\t\t\t\t\t\t}\n\t\t\t\t\t\t//\u5fc5\u8981\u306a\u30e2\u30b8\u30e5\u30fc\u30eb\u3092\u8ffd\u52a0\n\t\t\t\t\t\tdependencies.push(m[1]);\n\t\t\t\t\t}\n\n\t\t\t\t\tresolve(createCommonJsWrapper(url, dependencies, textScript));\n\t\t\t\t});\n\t\t\t}));\n\n\t\t} else {\n\t\t\tevent.respondWith(fetch(event.request));\n\t\t}\n\n\t});\n}).bind(self)();\n```\n\n# \u4f7f\u3044\u65b9\ncommonjs-wrapper.js\u3068commonjs-wrapper-service-worker.js\u3092html\u3068\u540c\u3058\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306b\u7f6e\u3044\u3066\u3001\nhtml\u3067\u3001commonjs-wrapper.js\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u8aad\u307f\u8fbc\u3080\u3002\n\n\u305d\u306e\u4ed6\u306escript\u306f\u3001\n\n```js:main.js\nvar hoge = require('hoge');\n```\n\n\u307f\u305f\u3044\u306a\u8a18\u8ff0\u3067\u3001`./modules/hoge/index.js` \u30e2\u30b8\u30e5\u30fc\u30eb\u304c\u8aad\u307f\u8fbc\u3081\u308b\u3088\u3046\u306b\u306a\u308b\u3002\n\uff08\u7a81\u8cab\u306a\u306e\u3067\u3001`./modules/***/index.js` \u306f\u56fa\u5b9a\u30fb\u30fb\u30fb\uff09\n\n# \u8aac\u660e\n\n## commonjs-wrapper-service-worker.js\n\u8a18\u8f09\u3057\u305f\u9806\u756a\u3068\u306f\u9006\u3067\u3059\u3051\u3069\u3001\u5148\u306bcommonjs-wrapper-service-worker.js\u306e\u8aac\u660e\u3092\u3057\u307e\u3059\u3002\n\n\u8aad\u307f\u8fbc\u3093\u3060\u3001js\u30d5\u30a1\u30a4\u30eb\u306e\u4e2d\u8eab\u306e\u6700\u521d\u3068\u6700\u5f8c\u306b\u5fc5\u8981\u306ascript\u3092\u8a18\u8ff0\uff08\u30e9\u30c3\u30d7\uff09\u3057\u3066\u8fd4\u3057\u307e\u3059\u3002\n\u3059\u3053\u3057\u7de8\u96c6\u3057\u3066\u3057\u307e\u3044\u307e\u3059\u304c\u884c\u306f\u5909\u308f\u3089\u306a\u3044\u306e\u3067\u3001\u30c7\u30d0\u30c3\u30b0\u3067\u306f\u4fbf\u5229\u306b\u306a\u3063\u3066\u3044\u308b\u3068\u601d\u3044\u305f\u3044\u3067\u3059\u3002  \n\n## commonjs-wrapper.js\n\u30e9\u30c3\u30d7\u30e1\u30bd\u30c3\u30c9\u672c\u4f53\u3092\u6301\u3063\u3066\u3044\u307e\u3059\u3002  \nservice-worker\u3092\u767b\u9332\u3057\u305f\u308a\u3057\u3066\u3044\u307e\u3059\u304c\u305d\u3053\u306f\u91cd\u8981\u3058\u3083\u306a\u3044\u306e\u3067\u7aef\u6298\u308a\u307e\u3059\u3002\n\n```js\n\t//commonjs\u30e9\u30c3\u30d1\u30fc\u306e\u30e9\u30c3\u30d1\u30fc\u30e1\u30bd\u30c3\u30c9\n\twindow.commonjswrapper = function(url, dependenciesMap, fn) {\n```\n\u3068\u308a\u3042\u3048\u305a\u3001\u5f15\u6570\u306e\u8aac\u660e\u304b\u3089\u3002\n\n* url  \n    script\u306eurl\u3067\u3059\u3002  \n* dependenciesMap  \n    script\u3067require\u304c\u8a18\u8ff0\u3055\u308c\u305f\u4e2d\u8eab\u3068\u3001url\u306e\u30bb\u30c3\u30c8\u304c\u5165\u308a\u307e\u3059\u3002  \n* fn  \n    script\u672c\u4f53\u306ecommonjs\u30e9\u30c3\u30d1\u30fc\u30e1\u30bd\u30c3\u30c9\u3067\u3059\u3002  \n\nfn\u3092\u5b9f\u884c\u3059\u308b\u524d\u306b\u3001dependenciesMap\u306b\u5165\u3063\u305f\u3001\u30e2\u30b8\u30e5\u30fc\u30eb\u306escript\u304c\u8aad\u307f\u8fbc\u307e\u308c\u308b\u306e\u3092\u5f85\u3061\u3001\n\u6700\u7d42\u7684\u306bfn\u3092\u5b9f\u884c\u3057\u307e\u3059\u3002\u3053\u306e\u3042\u305f\u308a\u306frequirejs\u306e\u4ed5\u7d44\u307f\u3068\u540c\u3058\u3067\u3059\u306d\u3002\n\n\u3082\u3046\u5c11\u3057\u9811\u5f35\u3063\u3066\u308b\u3053\u3068\u3068\u3057\u3066\u306f\u3001html\u306b\u8a18\u8ff0\u3055\u308c\u305fscript\u306e\u5b9f\u884c\u9806\u5e8f\u3092\u4fdd\u8a3c\u3059\u308b\u305f\u3081\u306b\u3001\n\u81ea\u8eab\u306escript\u3088\u308a\u524d\u306b\u8a18\u8ff0\u3055\u308c\u305fscript\u304c\u8aad\u307f\u8fbc\u307e\u308c\u308b\u306e\u3092\u5f85\u3061\u307e\u3059\u3002\n\n\u3042\u3068\u306f\u9069\u5f53\u306b\u5f85\u3063\u3066\u5b9f\u884c\u3057\u3066\u308b\u3060\u3051\u3067\u3059\u3002  \n\n\u672c\u5f53\u306f\u3001package.json\u898b\u305f\u308a\u3001npm\u306eunpkg\u304b\u3089\u53d6\u3063\u3066\u304d\u305f\u308a\u3068\u304b\u3067\u304d\u3066\u304f\u308b\u3068\u3044\u3044\u611f\u3058\u306b\u306a\u308b\u304b\u3082\u3057\u308c\u306a\u3044\u3068\u601d\u3044\u3064\u3064\u3002\n\u6642\u9593\u3068\u308c\u306a\u3044\u306e\u3067\u3068\u308a\u3042\u3048\u305a\u8ae6\u3081\u3066\u6295\u7a3f\u3057\u307e\u3059\u3002\n\n# \u307e\u3068\u3081\n\u3075\u3064\u3046\u306bwebpack\u3068\u304b\u4f7f\u3044\u307e\u3059\u306d\u3002\n\n\u30c7\u30d0\u30c3\u30b0\u3092\u4fbf\u5229\u306b\u3057\u305f\u304b\u3063\u305f\u306e\u3060\u3051\u3069\u3001\u3082\u3063\u3068\u771f\u9762\u76ee\u306b\u4f5c\u3089\u306a\u3044\u3068\u5168\u7136\u4f7f\u3048\u307e\u305b\u3093\u306d\u3002\n\n\n\u3068\u308a\u3042\u3048\u305a2016\u5e74\u4e2d\u306b40\u8a18\u4e8b\u9054\u6210:raised_hands:\n\n\n"}