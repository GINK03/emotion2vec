{"context": "\n\n\u524d\u56de\n\u300cENTRY(stext)\u3067proc_info_list\u69cb\u9020\u4f53\u3078\u306e\u30dd\u30a4\u30f3\u30bf\u3092\u53d6\u5f97\u3059\u308b\u307e\u3067\u300d\u3092\u8aac\u660e\u3057\u307e\u3057\u305f\u3002\n\nKernel\u5185\u306eENTRY(stext)\u306e\u7d9a\u304d(PHYS_OFFSET\u53d6\u5f97\u307e\u3067)\n\nlinux-rpi-4.1.y/arch/arm/kernel/head.S\n#ifdef CONFIG_ARM_LPAE\n    mrc p15, 0, r3, c0, c1, 4       @ read ID_MMFR0\n    and r3, r3, #0xf            @ extract VMSA support\n    cmp r3, #5              @ long-descriptor translation table format?\n THUMB( it  lo )                @ force fixup-able long branch encoding\n    blo __error_lpae            @ only classic page table format\n#endif\n\n\n\u307e\u305a\u3001\u4e0a\u8a18\u306e\u51e6\u7406\u3092\u901a\u308b\u306b\u306f\u3001\n\u30b3\u30f3\u30d5\u30a3\u30b0\u3067LPAE(Large Physical Address Extension)\u3092\u6709\u52b9\u306b\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\nLPAE(\u4eee\u60f3\u5316\u62e1\u5f35\u6a5f\u80fd)\u306f\u3001\u30da\u30fc\u30b8\u30c6\u30fc\u30d6\u30eb\u30922\u3064\u7528\u610f\u3059\u308b\u624b\u6cd5\u3067\u3001\n\u30cf\u30a4\u30d1\u30fc\u30d0\u30a4\u30b6\u3092\u4f7f\u7528\u3057\u305f\u969b\u306e\u30b9\u30eb\u30fc\u30d7\u30c3\u30c8\u3092\u7dad\u6301\u3059\u308b\u305f\u3081\u306e\u4ed5\u7d44\u307f\u306e\u3088\u3046\u3067\u3059\u3002\n\u3061\u306a\u307f\u306b\u3001\u524d\u56de\u306e\u8aac\u660e\u3067\u30cf\u30a4\u30d1\u30fc\u30d0\u30a4\u30b6\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u51e6\u7406\u3092\u98db\u3070\u3057\u305f\u306e\u3067\u3001\n\u4e0a\u8a18\u306e\u8aac\u660e\u3082\u5272\u611b\u3044\u305f\u3057\u307e\u3059(\u5f8c\u65e5\u3001\u30cf\u30a4\u30d1\u30fc\u30d0\u30a4\u30b6\u3068\u5171\u306b\u5225\u8a18\u4e8b\u3092\u66f8\u304d\u3001\u30ea\u30f3\u30af\u3092\u8cbc\u308a\u307e\u3059)\u3002\n\u6b21\u306e\u51e6\u7406\u306b\u9032\u307f\u307e\u3059\u3002\n\nlinux-rpi-4.1.y/arch/arm/kernel/head.S\n#ifndef CONFIG_XIP_KERNEL\n    adr r3, 2f\n    ldmia   r3, {r4, r8}\n    sub r4, r3, r4          @ (PHYS_OFFSET - PAGE_OFFSET)\n    add r8, r8, r4          @ PHYS_OFFSET\n#else\n    ldr r8, =PLAT_PHYS_OFFSET       @ always constant in this case\n#endif\n\n\n\u4e0a\u8a18\u306e\u51e6\u7406\u306f\u3001 Kernel Execute-In-Place(XIP)\u304c\u6709\u52b9/\u7121\u52b9\u3067\u5206\u5c90\u3057\u307e\u3059\u3002\n\u3053\u3053\u3067XIP\u3068\u306f\u3001RAM\u306b\u30b3\u30fc\u30c9(.text\u30bb\u30af\u30b7\u30e7\u30f3\u306e\u5185\u5bb9\u3001\u95a2\u6570)\u3092\u5c55\u958b\u3059\u308b\u4e8b\u306a\u304f\u3001\n\u4e0d\u63ee\u767a\u6027\u30d5\u30e9\u30c3\u30b7\u30e5\u30e1\u30e2\u30ea\u4e0a\u306e\u30b3\u30fc\u30c9\u306b\u76f4\u63a5\u30a2\u30af\u30bb\u30b9\u3057\u3066\u5b9f\u884c\u3059\u308b\u5f62\u5f0f\u3067\u3059\u3002\n\u79c1\u306fXIP\u3092\u4f7f\u7528\u3057\u305f\u4e8b\u304c\u306a\u3044\u306e\u3067\u3001\u30a2\u30c9\u30ec\u30b9\u7a7a\u9593\u306e\u554f\u984c\u3068\u304b\u6c17\u306b\u306a\u308a\u307e\u3059\u3002\n\u3053\u3053\u3067\u306e\u51e6\u7406\u306e\u76ee\u7684\u306f\u3001RAM\u306b\u5c55\u958b\u3057\u305f\u30c7\u30fc\u30bf\u304c\u7269\u7406\u30a2\u30c9\u30ec\u30b90x0000_0000\u756a\u5730\u304b\u3089\u59cb\u307e\u3089\u306a\u3044\u5834\u5408(\u958b\u59cb\u30a2\u30c9\u30ec\u30b9\u304c0x0000_0000 + PHYS_OFFSET\u306e\u5834\u5408)\u306b\u5099\u3048\u3066\u3001\nr8\u306bPHYS_OFFSET\u3092\u5165\u308c\u308b\u4e8b\u3067\u3059\u3002\nXIP\u304c\u6709\u52b9\u306e\u5834\u5408\u306f\u3001r8\u306bPLAT_PHYS_OFFSET\u3092\u683c\u7d0d\u3057\u307e\u3059\u3002\nPLAT_PHYS_OFFSET\u306f\u3001\nlinux-rpi-4.1.y/arch/arm/mach-bcm2709/include/mach/memory.h\u5185\u3067\u3001\n#define PLAT_PHYS_OFFSET   UL(CONFIG_PHYS_OFFSET)\u3068\u5b9a\u7fa9\u3055\u308c\u3066\u3044\u307e\u3059\u3002\nCONFIG_PHYS_OFFSET\u306f\u3001\narch/arm/configs/bcm2709_defconfig\u5185\u3067\u3001CONFIG_PHYS_OFFSET=0\u3068\u5b9a\u7fa9\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n\u300c\u5024\u304c0\u306a\u3089\u3001\u3053\u306e\u51e6\u7406\u306f\u4e0d\u8981\u3067\u306f?\u300d\u3068\u601d\u3044\u307e\u3059\u304c\u3001\n\u3053\u306e\u30aa\u30d5\u30bb\u30c3\u30c8\u5024\u306f__virt_to_phys()\u30de\u30af\u30ed\u3067\u4f7f\u7528\u3055\u308c\u308b\u305f\u3081\u3001\u5b9a\u7fa9\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\nXIP\u304c\u7121\u52b9\u306e\u5834\u5408\u3001r3\u306bPAGE_OFFSET\u3078\u306e\u30e9\u30d9\u30eb(\u30a2\u30c9\u30ec\u30b9)\u3092\u683c\u7d0d\u3057\u307e\u3059\u3002\nPAGE_OFFSET\u3078\u306e\u30e9\u30d9\u30eb(2\uff1a)\u306f\u3001head.S\u5185\u306b\u3042\u308a\u307e\u3059\u3002\n\nlinux-rpi-4.1.y/arch/arm/kernel/head.S\n2:  .long   .\n    .long   PAGE_OFFSET\n\n\n\u3053\u3053\u304b\u3089\u304c\u30a2\u30bb\u30f3\u30d6\u30ea\u8a00\u8a9e\u304c\u8aad\u3081\u306a\u304f\u3066\u3001\nldmia\u547d\u4ee4\u306b\u3088\u3063\u3066\u3001r3(\u30e9\u30d9\u30eb\u3078\u306e\u30a2\u30c9\u30ec\u30b9)\u304b\u3089\u3001r4\u3001r8\u306b\u5024\u3092\u30ed\u30fc\u30c9\u3055\u308c\u308b\u7b48\u3002\n\u3069\u306e\u30ec\u30b8\u30b9\u30bf\u306b\u3001\u3069\u306e\u5024\u3092?\n\u6700\u7d42\u7684\u306b\u306f\u3001r8\u306bPHYS_OFFSET\u304c\u683c\u7d0d\u3055\u308c\u307e\u3059\u304c\u3001\u305d\u308c\u307e\u3067\u306e\u52a0\u7b97\u6e1b\u7b97\u3082\u7406\u89e3\u3067\u304d\u3066\u307e\u305b\u3093\u3002\n\u5f8c\u65e5\u3001\u8ffd\u8a18\u3057\u307e\u3059\u3002\n\u3053\u306e\u6642\u70b9\u3067\u306e\u6c4e\u7528\u30ec\u30b8\u30b9\u30bf\u306e\u72b6\u614b\u306f\u3001\u4ee5\u4e0b\u306e\u901a\u308a\u3067\u3059\u3002\n\nr1 = machine number\nr2 = dtb\nr8 = phys_offset\nr9 = cpu_id\nr10 = proc_info\n\n\nKernel\u5185\u306eENTRY(stext)\u306e\u7d9a\u304d(\u30da\u30fc\u30b8\u30c6\u30fc\u30d6\u30eb\u306e\u4f5c\u6210\u307e\u3067)\n\nlinux-rpi-4.1.y/arch/arm/kernel/head.S\n    bl  __vet_atags\n#ifdef CONFIG_SMP_ON_UP\n    bl  __fixup_smp\n#endif\n#ifdef CONFIG_ARM_PATCH_PHYS_VIRT\n    bl  __fixup_pv_table\n#endif\n    bl  __create_page_tables\n\n\n__vet_atags\u306e\u5b9a\u7fa9\u306f\u3001linux-rpi-4.1.y/arch/arm/head-common.S\u5185\u306b\u3042\u308a\u307e\u3059\u3002\n\u3053\u306e\u95a2\u6570\u3067\u306f\u3001r2\u306b\u683c\u7d0d\u3055\u308c\u3066\u3044\u308b\u30dd\u30a4\u30f3\u30bf(ATAGS or DTB)\u306e\u59a5\u5f53\u6027\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\nr2\u306e\u5185\u5bb9\u3068\u59a5\u5f53\u6027\u3092\u78ba\u8a8d\u3059\u308b\u305f\u3081\u306e\u5b9a\u6570\u3068\u3092\u6bd4\u8f03\u3057\u3001\u4e00\u81f4\u3057\u306a\u3044\u5834\u5408\u306fr2\u30920\u306b\u3057\u307e\u3059\u3002\n\u4e00\u81f4\u3057\u3066\u3044\u308b\u5834\u5408\u306f\u3001\u4f55\u3082\u884c\u3044\u307e\u305b\u3093\u3002\n__fixup_smp(linux-rpi-4.1.y/arch/arm/head.S)\u306e\u51e6\u7406\u306f\u3001\nCONFIG_SMP_ON_UP(SMP=Symmetric Multi-Processors)\u304c\u6709\u52b9\u306e\u5834\u5408\u306b\u901a\u308b\u3002\nRaspberry Pi2\u306eCPU\u306f\u8907\u6570\u306e\u30b3\u30a2\u304c\u642d\u8f09\u3055\u308c\u3066\u3044\u308b\u306e\u3067\u3001SMP\u306b\u5bfe\u5fdc\u3057\u3066\u3044\u307e\u3059\u3002\n\u809d\u5fc3\u306e\u51e6\u7406\u3067\u3059\u304c\u3001CPU\u304cSMP\u306b\u5bfe\u5fdc\u3057\u3066\u3044\u308b\u304b\u3069\u3046\u304b\u306e\u78ba\u8a8d\u4ee5\u5916\u3001\n\u8aad\u307f\u53d6\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u305b\u3093\u3067\u3057\u305f(\u5f8c\u65e5\u3001\u8ffd\u8a18\u3057\u307e\u3059)\u3002\n__fixup_pv_table(linux-rpi-4.1.y/arch/arm/head.S)\u306e\u51e6\u7406\u3082\u3001\n CONFIG_ARM_PATCH_PHYS_VIRT\u304c\u6709\u52b9\u306e\u5834\u5408\u306e\u307f\u901a\u308a\u307e\u3059\u3002\n\u3053\u306e\u95a2\u6570\u3067\u306f\u3001arch/arm/include/asm/memory.h\u5185\u306e\u300c\u4eee\u60f3\u30a2\u30c9\u30ec\u30b9-\u7269\u7406\u30a2\u30c9\u30ec\u30b9\u300d\u3092\n\u5909\u63db\u3059\u308b\u95a2\u6570\u3084\u30de\u30af\u30ed\u304c\u4f7f\u7528\u3059\u308b\u5909\u6570\u3092\u6c7a\u5b9a\u3057\u307e\u3059\u3002\n__create_page_tables(linux-rpi-4.1.y/arch/arm/head.S)\u3067\u306f\u3001\nr4\u306b\u30da\u30fc\u30b8\u30c6\u30fc\u30d6\u30eb\u306e\u30a2\u30c9\u30ec\u30b9\u3092\u683c\u7d0d\u3057\u307e\u3059\u3002\u305d\u306e\u5f8c\u306e\u51e6\u7406\u306f\u30da\u30fc\u30b8\u30c6\u30fc\u30d6\u30eb\u306e\u4f5c\u6210\u3067\u3059\u3002\n\nKernel\u5185\u306eENTRY(stext)\u306e\u7d9a\u304d(MMU\u306e\u6709\u52b9\u5316\u307e\u3067)\n    ldr r13, =__mmap_switched       @ address to jump to after\n                        @ mmu has been enabled\n    adr lr, BSYM(1f)            @ return (PIC) address\n    mov r8, r4              @ set TTBR1 to swapper_pg_dir\n    ldr r12, [r10, #PROCINFO_INITFUNC]\n    add r12, r12, r10\n    ret r12\n1:  b   __enable_mmu\nENDPROC(stext)\n\n__mmap_switched(linux-rpi-4.1.y/arch/arm/head-common.S)\u306f\u3001\nMMU\u3092ON\u306b\u3057\u305f\u5f8c\u306b\u5b9f\u884c\u3059\u308bstart_kernel(linux-rpi-4.1.y/init/main.c)\u3092\nr13(SP)\u306b\u683c\u7d0d\u3059\u308b\u3002\n\u3053\u3053\u3067\u306e\u51e6\u7406\u306f\u3001\u3053\u3061\u3089\u306e\u30b5\u30a4\u30c8\u304c\u53c2\u8003\u306b\u306a\u308a\u307e\u3059\u3002\n\u6700\u5f8c\u306b\u3001__enable_mmu\u3067MMU\u304cON\u306b\u306a\u3063\u305f\u5f8c\u3001\nstart_kernel(\u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3\u306b\u4f9d\u5b58\u3057\u306a\u3044\u51e6\u7406\u3001C\u8a00\u8a9e)\u306b\u51e6\u7406\u304c\u79fb\u308a\u307e\u3059\u3002\n\n\u7591\u554f\u70b9\n\u30fbXIP\u304c\u6709\u52b9\u306e\u5834\u5408\u306f\u3001\u4f55\u6545PLAT_PHYS_OFFSET\u304c0\u306a\u306e\u304b\u3002\n\u30fb__fixup_smp\u306e\u51e6\u7406\u5185\u5bb9\n\u30fb\u30a2\u30bb\u30f3\u30d6\u30e9\u3092\u30b9\u30c6\u30c3\u30d7\u5b9f\u884c\u3059\u308b\u65b9\u6cd5\n\n\u6b21\u56de\nstart_kernel()\u306e\u30ab\u30ca\u30ea\u30a2\u30b3\u30fc\u30c9\u3092\u30b9\u30bf\u30c3\u30af\u306b\u57cb\u3081\u8fbc\u3080\u307e\u3067\u3092\u8aac\u660e\u3057\u3066\u3044\u307e\u3059\u3002\n\n\u53c2\u8003\nARM startup code analysis Linux\n##\u524d\u56de\n[\u300cENTRY(stext)\u3067proc_info_list\u69cb\u9020\u4f53\u3078\u306e\u30dd\u30a4\u30f3\u30bf\u3092\u53d6\u5f97\u3059\u308b\u307e\u3067\u300d](http://qiita.com/Mogura1215/items/b8f866b4ede757cdaa73)\u3092\u8aac\u660e\u3057\u307e\u3057\u305f\u3002\n\n##Kernel\u5185\u306eENTRY(stext)\u306e\u7d9a\u304d(PHYS_OFFSET\u53d6\u5f97\u307e\u3067)\n```linux-rpi-4.1.y/arch/arm/kernel/head.S\n#ifdef CONFIG_ARM_LPAE\n\tmrc\tp15, 0, r3, c0, c1, 4\t\t@ read ID_MMFR0\n\tand\tr3, r3, #0xf\t\t\t@ extract VMSA support\n\tcmp\tr3, #5\t\t\t\t@ long-descriptor translation table format?\n THUMB( it\tlo )\t\t\t\t@ force fixup-able long branch encoding\n\tblo\t__error_lpae\t\t\t@ only classic page table format\n#endif\n```\n\n\u307e\u305a\u3001\u4e0a\u8a18\u306e\u51e6\u7406\u3092\u901a\u308b\u306b\u306f\u3001\n\u30b3\u30f3\u30d5\u30a3\u30b0\u3067[LPAE(Large Physical Address Extension)](https://www.arm.com/ja/products/processors/technologies/virtualization-extensions.php)\u3092\u6709\u52b9\u306b\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\nLPAE(\u4eee\u60f3\u5316\u62e1\u5f35\u6a5f\u80fd)\u306f\u3001[\u30da\u30fc\u30b8\u30c6\u30fc\u30d6\u30eb](https://ja.wikipedia.org/wiki/%E3%83%9A%E3%83%BC%E3%82%B8%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB)\u30922\u3064\u7528\u610f\u3059\u308b\u624b\u6cd5\u3067\u3001\n[\u30cf\u30a4\u30d1\u30fc\u30d0\u30a4\u30b6](https://ja.wikipedia.org/wiki/%E3%83%8F%E3%82%A4%E3%83%91%E3%83%BC%E3%83%90%E3%82%A4%E3%82%B6)\u3092\u4f7f\u7528\u3057\u305f\u969b\u306e\u30b9\u30eb\u30fc\u30d7\u30c3\u30c8\u3092\u7dad\u6301\u3059\u308b\u305f\u3081\u306e\u4ed5\u7d44\u307f\u306e\u3088\u3046\u3067\u3059\u3002\n\u3061\u306a\u307f\u306b\u3001\u524d\u56de\u306e\u8aac\u660e\u3067\u30cf\u30a4\u30d1\u30fc\u30d0\u30a4\u30b6\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u51e6\u7406\u3092\u98db\u3070\u3057\u305f\u306e\u3067\u3001\n\u4e0a\u8a18\u306e\u8aac\u660e\u3082\u5272\u611b\u3044\u305f\u3057\u307e\u3059(\u5f8c\u65e5\u3001\u30cf\u30a4\u30d1\u30fc\u30d0\u30a4\u30b6\u3068\u5171\u306b\u5225\u8a18\u4e8b\u3092\u66f8\u304d\u3001\u30ea\u30f3\u30af\u3092\u8cbc\u308a\u307e\u3059)\u3002\n\n\u6b21\u306e\u51e6\u7406\u306b\u9032\u307f\u307e\u3059\u3002\n\n```linux-rpi-4.1.y/arch/arm/kernel/head.S\n#ifndef CONFIG_XIP_KERNEL\n\tadr\tr3, 2f\n\tldmia\tr3, {r4, r8}\n\tsub\tr4, r3, r4\t\t\t@ (PHYS_OFFSET - PAGE_OFFSET)\n\tadd\tr8, r8, r4\t\t\t@ PHYS_OFFSET\n#else\n\tldr\tr8, =PLAT_PHYS_OFFSET\t\t@ always constant in this case\n#endif\n```\n\u4e0a\u8a18\u306e\u51e6\u7406\u306f\u3001 [Kernel Execute-In-Place(XIP)](http://elinux.org/Kernel_XIP)\u304c\u6709\u52b9/\u7121\u52b9\u3067\u5206\u5c90\u3057\u307e\u3059\u3002\n\u3053\u3053\u3067XIP\u3068\u306f\u3001RAM\u306b\u30b3\u30fc\u30c9(.text\u30bb\u30af\u30b7\u30e7\u30f3\u306e\u5185\u5bb9\u3001\u95a2\u6570)\u3092\u5c55\u958b\u3059\u308b\u4e8b\u306a\u304f\u3001\n\u4e0d\u63ee\u767a\u6027\u30d5\u30e9\u30c3\u30b7\u30e5\u30e1\u30e2\u30ea\u4e0a\u306e\u30b3\u30fc\u30c9\u306b\u76f4\u63a5\u30a2\u30af\u30bb\u30b9\u3057\u3066\u5b9f\u884c\u3059\u308b\u5f62\u5f0f\u3067\u3059\u3002\n\u79c1\u306fXIP\u3092\u4f7f\u7528\u3057\u305f\u4e8b\u304c\u306a\u3044\u306e\u3067\u3001\u30a2\u30c9\u30ec\u30b9\u7a7a\u9593\u306e\u554f\u984c\u3068\u304b\u6c17\u306b\u306a\u308a\u307e\u3059\u3002\n\n\u3053\u3053\u3067\u306e\u51e6\u7406\u306e\u76ee\u7684\u306f\u3001RAM\u306b\u5c55\u958b\u3057\u305f\u30c7\u30fc\u30bf\u304c\u7269\u7406\u30a2\u30c9\u30ec\u30b90x0000_0000\u756a\u5730\u304b\u3089\u59cb\u307e\u3089\u306a\u3044\u5834\u5408(\u958b\u59cb\u30a2\u30c9\u30ec\u30b9\u304c0x0000_0000 + PHYS_OFFSET\u306e\u5834\u5408)\u306b\u5099\u3048\u3066\u3001\nr8\u306bPHYS_OFFSET\u3092\u5165\u308c\u308b\u4e8b\u3067\u3059\u3002\n\nXIP\u304c\u6709\u52b9\u306e\u5834\u5408\u306f\u3001r8\u306bPLAT_PHYS_OFFSET\u3092\u683c\u7d0d\u3057\u307e\u3059\u3002\nPLAT_PHYS_OFFSET\u306f\u3001\n`linux-rpi-4.1.y/arch/arm/mach-bcm2709/include/mach/memory.h`\u5185\u3067\u3001\n`#define PLAT_PHYS_OFFSET   UL(CONFIG_PHYS_OFFSET)`\u3068\u5b9a\u7fa9\u3055\u308c\u3066\u3044\u307e\u3059\u3002\nCONFIG_PHYS_OFFSET\u306f\u3001\n`arch/arm/configs/bcm2709_defconfig`\u5185\u3067\u3001`CONFIG_PHYS_OFFSET=0`\u3068\u5b9a\u7fa9\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n\u300c\u5024\u304c0\u306a\u3089\u3001\u3053\u306e\u51e6\u7406\u306f\u4e0d\u8981\u3067\u306f?\u300d\u3068\u601d\u3044\u307e\u3059\u304c\u3001\n\u3053\u306e\u30aa\u30d5\u30bb\u30c3\u30c8\u5024\u306f`__virt_to_phys()`\u30de\u30af\u30ed\u3067\u4f7f\u7528\u3055\u308c\u308b\u305f\u3081\u3001\u5b9a\u7fa9\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\n\nXIP\u304c\u7121\u52b9\u306e\u5834\u5408\u3001r3\u306bPAGE_OFFSET\u3078\u306e\u30e9\u30d9\u30eb(\u30a2\u30c9\u30ec\u30b9)\u3092\u683c\u7d0d\u3057\u307e\u3059\u3002\nPAGE_OFFSET\u3078\u306e\u30e9\u30d9\u30eb(2\uff1a)\u306f\u3001head.S\u5185\u306b\u3042\u308a\u307e\u3059\u3002\n\n```linux-rpi-4.1.y/arch/arm/kernel/head.S\n2:\t.long\t.\n\t.long\tPAGE_OFFSET\n```\n\u3053\u3053\u304b\u3089\u304c\u30a2\u30bb\u30f3\u30d6\u30ea\u8a00\u8a9e\u304c\u8aad\u3081\u306a\u304f\u3066\u3001\nldmia\u547d\u4ee4\u306b\u3088\u3063\u3066\u3001r3(\u30e9\u30d9\u30eb\u3078\u306e\u30a2\u30c9\u30ec\u30b9)\u304b\u3089\u3001r4\u3001r8\u306b\u5024\u3092\u30ed\u30fc\u30c9\u3055\u308c\u308b\u7b48\u3002\n\u3069\u306e\u30ec\u30b8\u30b9\u30bf\u306b\u3001\u3069\u306e\u5024\u3092?\n\u6700\u7d42\u7684\u306b\u306f\u3001r8\u306bPHYS_OFFSET\u304c\u683c\u7d0d\u3055\u308c\u307e\u3059\u304c\u3001\u305d\u308c\u307e\u3067\u306e\u52a0\u7b97\u6e1b\u7b97\u3082\u7406\u89e3\u3067\u304d\u3066\u307e\u305b\u3093\u3002\n\u5f8c\u65e5\u3001\u8ffd\u8a18\u3057\u307e\u3059\u3002\n\n\u3053\u306e\u6642\u70b9\u3067\u306e\u6c4e\u7528\u30ec\u30b8\u30b9\u30bf\u306e\u72b6\u614b\u306f\u3001\u4ee5\u4e0b\u306e\u901a\u308a\u3067\u3059\u3002\n>r1 = machine number\n>r2 = dtb\n>r8 = phys_offset\n>r9 = cpu_id\n>r10 = proc_info\n\n##Kernel\u5185\u306eENTRY(stext)\u306e\u7d9a\u304d(\u30da\u30fc\u30b8\u30c6\u30fc\u30d6\u30eb\u306e\u4f5c\u6210\u307e\u3067)\n```linux-rpi-4.1.y/arch/arm/kernel/head.S\n\tbl\t__vet_atags\n#ifdef CONFIG_SMP_ON_UP\n\tbl\t__fixup_smp\n#endif\n#ifdef CONFIG_ARM_PATCH_PHYS_VIRT\n\tbl\t__fixup_pv_table\n#endif\n\tbl\t__create_page_tables\n```\n__vet_atags\u306e\u5b9a\u7fa9\u306f\u3001`linux-rpi-4.1.y/arch/arm/head-common.S`\u5185\u306b\u3042\u308a\u307e\u3059\u3002\n\u3053\u306e\u95a2\u6570\u3067\u306f\u3001r2\u306b\u683c\u7d0d\u3055\u308c\u3066\u3044\u308b\u30dd\u30a4\u30f3\u30bf(ATAGS or DTB)\u306e\u59a5\u5f53\u6027\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\nr2\u306e\u5185\u5bb9\u3068\u59a5\u5f53\u6027\u3092\u78ba\u8a8d\u3059\u308b\u305f\u3081\u306e\u5b9a\u6570\u3068\u3092\u6bd4\u8f03\u3057\u3001\u4e00\u81f4\u3057\u306a\u3044\u5834\u5408\u306fr2\u30920\u306b\u3057\u307e\u3059\u3002\n\u4e00\u81f4\u3057\u3066\u3044\u308b\u5834\u5408\u306f\u3001\u4f55\u3082\u884c\u3044\u307e\u305b\u3093\u3002\n\n__fixup_smp(`linux-rpi-4.1.y/arch/arm/head.S`)\u306e\u51e6\u7406\u306f\u3001\nCONFIG_SMP_ON_UP([SMP=Symmetric Multi-Processors](http://japan.renesas.com/products/mpumcu/multi_core/child/multicore.jsp))\u304c\u6709\u52b9\u306e\u5834\u5408\u306b\u901a\u308b\u3002\nRaspberry Pi2\u306eCPU\u306f\u8907\u6570\u306e\u30b3\u30a2\u304c\u642d\u8f09\u3055\u308c\u3066\u3044\u308b\u306e\u3067\u3001SMP\u306b\u5bfe\u5fdc\u3057\u3066\u3044\u307e\u3059\u3002\n\u809d\u5fc3\u306e\u51e6\u7406\u3067\u3059\u304c\u3001CPU\u304cSMP\u306b\u5bfe\u5fdc\u3057\u3066\u3044\u308b\u304b\u3069\u3046\u304b\u306e\u78ba\u8a8d\u4ee5\u5916\u3001\n\u8aad\u307f\u53d6\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u305b\u3093\u3067\u3057\u305f(\u5f8c\u65e5\u3001\u8ffd\u8a18\u3057\u307e\u3059)\u3002\n\n__fixup_pv_table(`linux-rpi-4.1.y/arch/arm/head.S`)\u306e\u51e6\u7406\u3082\u3001\n CONFIG_ARM_PATCH_PHYS_VIRT\u304c\u6709\u52b9\u306e\u5834\u5408\u306e\u307f\u901a\u308a\u307e\u3059\u3002\n\u3053\u306e\u95a2\u6570\u3067\u306f\u3001`arch/arm/include/asm/memory.h`\u5185\u306e\u300c\u4eee\u60f3\u30a2\u30c9\u30ec\u30b9-\u7269\u7406\u30a2\u30c9\u30ec\u30b9\u300d\u3092\n\u5909\u63db\u3059\u308b\u95a2\u6570\u3084\u30de\u30af\u30ed\u304c\u4f7f\u7528\u3059\u308b\u5909\u6570\u3092\u6c7a\u5b9a\u3057\u307e\u3059\u3002\n\n__create_page_tables(`linux-rpi-4.1.y/arch/arm/head.S`)\u3067\u306f\u3001\nr4\u306b\u30da\u30fc\u30b8\u30c6\u30fc\u30d6\u30eb\u306e\u30a2\u30c9\u30ec\u30b9\u3092\u683c\u7d0d\u3057\u307e\u3059\u3002\u305d\u306e\u5f8c\u306e\u51e6\u7406\u306f[\u30da\u30fc\u30b8\u30c6\u30fc\u30d6\u30eb](http://softwaretechnique.jp/OS_Development/kernel_development07.html)\u306e\u4f5c\u6210\u3067\u3059\u3002\n\n##Kernel\u5185\u306eENTRY(stext)\u306e\u7d9a\u304d(MMU\u306e\u6709\u52b9\u5316\u307e\u3067)\n```\n\tldr\tr13, =__mmap_switched\t\t@ address to jump to after\n\t\t\t\t\t\t@ mmu has been enabled\n\tadr\tlr, BSYM(1f)\t\t\t@ return (PIC) address\n\tmov\tr8, r4\t\t\t\t@ set TTBR1 to swapper_pg_dir\n\tldr\tr12, [r10, #PROCINFO_INITFUNC]\n\tadd\tr12, r12, r10\n\tret\tr12\n1:\tb\t__enable_mmu\nENDPROC(stext)\n```\n__mmap_switched(`linux-rpi-4.1.y/arch/arm/head-common.S`)\u306f\u3001\nMMU\u3092ON\u306b\u3057\u305f\u5f8c\u306b\u5b9f\u884c\u3059\u308bstart_kernel(`linux-rpi-4.1.y/init/main.c`)\u3092\nr13(SP)\u306b\u683c\u7d0d\u3059\u308b\u3002\n\u3053\u3053\u3067\u306e\u51e6\u7406\u306f\u3001[\u3053\u3061\u3089\u306e\u30b5\u30a4\u30c8](http://masahir0y.blogspot.jp/2012/02/arm-linux-startkernel.html)\u304c\u53c2\u8003\u306b\u306a\u308a\u307e\u3059\u3002\n\n\u6700\u5f8c\u306b\u3001__enable_mmu\u3067MMU\u304cON\u306b\u306a\u3063\u305f\u5f8c\u3001\nstart_kernel(\u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3\u306b\u4f9d\u5b58\u3057\u306a\u3044\u51e6\u7406\u3001C\u8a00\u8a9e)\u306b\u51e6\u7406\u304c\u79fb\u308a\u307e\u3059\u3002\n\n##\u7591\u554f\u70b9\n\u30fbXIP\u304c\u6709\u52b9\u306e\u5834\u5408\u306f\u3001\u4f55\u6545PLAT_PHYS_OFFSET\u304c0\u306a\u306e\u304b\u3002\n\u30fb__fixup_smp\u306e\u51e6\u7406\u5185\u5bb9\n\u30fb\u30a2\u30bb\u30f3\u30d6\u30e9\u3092\u30b9\u30c6\u30c3\u30d7\u5b9f\u884c\u3059\u308b\u65b9\u6cd5\n\n##\u6b21\u56de\n[start_kernel()\u306e\u30ab\u30ca\u30ea\u30a2\u30b3\u30fc\u30c9\u3092\u30b9\u30bf\u30c3\u30af\u306b\u57cb\u3081\u8fbc\u3080\u307e\u3067](http://qiita.com/Mogura1215/items/f2ce8ebbc13bd06c9bb7)\u3092\u8aac\u660e\u3057\u3066\u3044\u307e\u3059\u3002\n\n##\u53c2\u8003\n[ARM startup code analysis Linux](http://qiita.com/drafts/0f29cf4361dce85bfe0f/edit)\n", "tags": ["RaspberryPi", "Linux", "kernel"]}