{"tags": ["Arduino", "ESP8266", "sango", "mqtt"], "context": " More than 1 year has passed since last update.\n\n\u6982\u8981\n\u4f8b\u3048\u308c\u3070\u3001\u96fb\u5b50\u5f0fYES/NO\u6795\u3067\u3059\u3002\n\u592b\u5a66\u9593\u306e\u5fae\u5999\u306a\u554f\u984c\u3092\u30b9\u30d1\u30c3\u3068\u89e3\u6c7a\u3057\u3066\u3001\u5c11\u5b50\u5316\u9632\u6b62\u306b\u3082\u8ca2\u732e\u3059\u308b\u3001\u304a\u52a9\u3051\u30c4\u30fc\u30eb\u3002\nweb\u30b5\u30fc\u30d3\u30b9\u304b\u3089\u3001\u8c9d\u6bbb\u30e9\u30f3\u30d7\u3092\u9060\u9694\u64cd\u4f5c\u3059\u308b\u3002\n\u5973\u6027\u304c\u3001\u30b9\u30de\u30db\u3001PC\u304b\u3089\u64cd\u4f5c\u3059\u308b\u3002\narduino uno\u304b\u3089esp8266\u3067wifi\u306b\u3064\u306a\u304e\u307e\u3059\u3002\nmqtt\u30d6\u30ed\u30fc\u30ab\u30fc\u306f\u3001sango\u3092\u4f7f\u3063\u3066\u307e\u3059\u3002\n\u30b9\u30a4\u30c3\u30c1\u306f\u3001jsdo.it\u306b\u7f6e\u3044\u3066\u307e\u3059\u3002\n\n\u5199\u771f\n\n\n\n\u30e0\u30fc\u30d3\u30fc\nhttps://www.youtube.com/watch?v=kJN0jGaMacw\n\n\u56de\u8def\u56f3\n\n\n\u30b5\u30f3\u30d7\u30eb\u30b3\u30fc\u30c9\n#include <SoftwareSerial.h>\nSoftwareSerial mySerial(10, 11);\nchar buff[256];\nlong int ctime = millis();\nString sendAT(String command, const int timeout)\n{\n    String response = \"\";\n    Serial.print(command);\n    long int time = millis();\n    while ((time + timeout) > millis())\n    {\n        while (Serial.available())\n        {\n            char c = Serial.read();\n            response += c;\n        }\n    }\n    mySerial.print(response);\n    return response;\n}\nString waitAT(const int timeout)\n{\n    String response = \"\";\n    long int time = millis();\n    while ((time + timeout) > millis())\n    {\n        while (Serial.available())\n        {\n            char c = Serial.read();\n            response += c;\n        }\n    }\n    mySerial.print(response);\n    return response;\n}\nvoid setup()\n{\n    pinMode(13, OUTPUT);\n    digitalWrite(13, LOW);\n    mySerial.begin(115200);\n    Serial.begin(115200);\n    sendAT(\"AT+GMR\\r\\n\", 2000);\n    sendAT(\"AT+CWJAP=\\\"free-spot\\\",\\\"\\\"\\r\\n\", 3000);\n    sendAT(\"AT+CIPMUX=0\\r\\n\", 1000);\n    sendAT(\"AT+CIFSR\\r\\n\", 1000);\n    sendAT(\"AT+CIPSTART=\\\"TCP\\\",\\\"lite.mqtt.shiguredo.jp\\\",1883\\r\\n\", 2000);\n    sendAT(\"AT+CIPSEND=52\\r\\n\", 3000);\n    Serial.write(16);\n    Serial.write(50);\n    Serial.write(0);\n    Serial.write(4);\n    Serial.print(\"MQTT\");\n    Serial.write(4);\n    Serial.write(194);\n    Serial.write(0);\n    Serial.write(60);\n    Serial.write(0);\n    Serial.write(4);\n    Serial.print(\"papa\");\n    Serial.write(0);\n    Serial.write(14);\n    Serial.print(\"ohisama@github\");\n    Serial.write(0);\n    Serial.write(16);\n    sendAT(\"pass\", 2000);\n    sendAT(\"AT+CIPSEND=27\\r\\n\", 3000);\n    Serial.write(130);\n    Serial.write(25);\n    Serial.write(0);\n    Serial.write(1);\n    Serial.write(0);\n    Serial.write(20);\n    Serial.print(\"ohisama@github/test0\");\n    Serial.write(0);\n    waitAT(2000);\n    mySerial.print(\" ok\\r\\n\");\n}\nvoid loop()\n{\n    int ch_id, packet_len;\n    char * pb;\n    int i = 0;\n    char c;\n    if ((ctime + 29000) < millis())\n    {\n        String cipSend = \"AT+CIPSEND=2\\r\\n\";\n        sendAT(cipSend, 3000);\n        Serial.write(192);\n        Serial.write(0);\n        ctime = millis();\n    }\n    if (Serial.available())\n    {\n        while (Serial.available() > 0)\n        {\n            c = Serial.read();\n            if (c > ' ' && c < 127)\n            {\n                buff[i++] = c;\n            }\n            if (i > 1 && buff[i - 2] == 'I' && buff[i - 1] == '+')\n            {\n                buff[i] = 0;\n                i = 0;\n                break;\n            }\n        }\n        mySerial.print(buff);\n        if (strncmp(buff, \"+IPD,\", 5) == 0)\n        {\n            mySerial.print(\" ok1\\r\\n\");\n            sscanf(buff + 5, \"%d\", &packet_len);\n            mySerial.print(\"@len: \");\n            mySerial.println(packet_len);\n            if (packet_len > 0)\n            {\n                if (packet_len == 27)\n                {\n                    digitalWrite(13, LOW);\n                    mySerial.print(\"@on@\");\n                }\n                else if (packet_len == 28)\n                {\n                    digitalWrite(13, HIGH);\n                    mySerial.print(\"@off@\");\n                }\n                else\n                {\n                    mySerial.print(\"@?@\");\n                }\n            }\n        }\n        else\n        {\n            mySerial.print(\" ng\\r\\n\");\n        }\n    }\n}\n\n#\u6982\u8981\n\u4f8b\u3048\u308c\u3070\u3001\u96fb\u5b50\u5f0fYES/NO\u6795\u3067\u3059\u3002\n\u592b\u5a66\u9593\u306e\u5fae\u5999\u306a\u554f\u984c\u3092\u30b9\u30d1\u30c3\u3068\u89e3\u6c7a\u3057\u3066\u3001\u5c11\u5b50\u5316\u9632\u6b62\u306b\u3082\u8ca2\u732e\u3059\u308b\u3001\u304a\u52a9\u3051\u30c4\u30fc\u30eb\u3002\nweb\u30b5\u30fc\u30d3\u30b9\u304b\u3089\u3001\u8c9d\u6bbb\u30e9\u30f3\u30d7\u3092\u9060\u9694\u64cd\u4f5c\u3059\u308b\u3002\n\u5973\u6027\u304c\u3001\u30b9\u30de\u30db\u3001PC\u304b\u3089\u64cd\u4f5c\u3059\u308b\u3002\narduino uno\u304b\u3089esp8266\u3067wifi\u306b\u3064\u306a\u304e\u307e\u3059\u3002\nmqtt\u30d6\u30ed\u30fc\u30ab\u30fc\u306f\u3001sango\u3092\u4f7f\u3063\u3066\u307e\u3059\u3002\n\u30b9\u30a4\u30c3\u30c1\u306f\u3001jsdo.it\u306b\u7f6e\u3044\u3066\u307e\u3059\u3002\n#\u5199\u771f\n![MVC-003S.JPG](https://qiita-image-store.s3.amazonaws.com/0/18104/9f1a24c0-1a27-3575-c170-f91d55d861cd.jpeg)\n![iihi4.JPG](https://qiita-image-store.s3.amazonaws.com/0/18104/f864d9d0-3917-56ef-cc03-963c984f1c05.jpeg)\n#\u30e0\u30fc\u30d3\u30fc\nhttps://www.youtube.com/watch?v=kJN0jGaMacw\n#\u56de\u8def\u56f3\n![iihi.JPG](https://qiita-image-store.s3.amazonaws.com/0/18104/9b163986-433d-7684-b36b-82acaf0c9750.jpeg)\n#\u30b5\u30f3\u30d7\u30eb\u30b3\u30fc\u30c9\n```\n#include <SoftwareSerial.h>\nSoftwareSerial mySerial(10, 11);\nchar buff[256];\nlong int ctime = millis();\nString sendAT(String command, const int timeout)\n{\n\tString response = \"\";\n\tSerial.print(command);\n\tlong int time = millis();\n\twhile ((time + timeout) > millis())\n\t{\n\t\twhile (Serial.available())\n\t\t{\n\t\t\tchar c = Serial.read();\n\t\t\tresponse += c;\n\t\t}\n\t}\n\tmySerial.print(response);\n\treturn response;\n}\nString waitAT(const int timeout)\n{\n\tString response = \"\";\n\tlong int time = millis();\n\twhile ((time + timeout) > millis())\n\t{\n\t\twhile (Serial.available())\n\t\t{\n\t\t\tchar c = Serial.read();\n\t\t\tresponse += c;\n\t\t}\n\t}\n\tmySerial.print(response);\n\treturn response;\n}\nvoid setup()\n{\n\tpinMode(13, OUTPUT);\n\tdigitalWrite(13, LOW);\n\tmySerial.begin(115200);\n\tSerial.begin(115200);\n\tsendAT(\"AT+GMR\\r\\n\", 2000);\n\tsendAT(\"AT+CWJAP=\\\"free-spot\\\",\\\"\\\"\\r\\n\", 3000);\n\tsendAT(\"AT+CIPMUX=0\\r\\n\", 1000);\n\tsendAT(\"AT+CIFSR\\r\\n\", 1000);\n\tsendAT(\"AT+CIPSTART=\\\"TCP\\\",\\\"lite.mqtt.shiguredo.jp\\\",1883\\r\\n\", 2000);\n\tsendAT(\"AT+CIPSEND=52\\r\\n\", 3000);\n\tSerial.write(16);\n\tSerial.write(50);\n\tSerial.write(0);\n\tSerial.write(4);\n\tSerial.print(\"MQTT\");\n\tSerial.write(4);\n\tSerial.write(194);\n\tSerial.write(0);\n\tSerial.write(60);\n\tSerial.write(0);\n\tSerial.write(4);\n\tSerial.print(\"papa\");\n\tSerial.write(0);\n\tSerial.write(14);\n\tSerial.print(\"ohisama@github\");\n\tSerial.write(0);\n\tSerial.write(16);\n\tsendAT(\"pass\", 2000);\n\tsendAT(\"AT+CIPSEND=27\\r\\n\", 3000);\n\tSerial.write(130);\n\tSerial.write(25);\n\tSerial.write(0);\n\tSerial.write(1);\n\tSerial.write(0);\n\tSerial.write(20);\n\tSerial.print(\"ohisama@github/test0\");\n\tSerial.write(0);\n\twaitAT(2000);\n\tmySerial.print(\" ok\\r\\n\");\n}\nvoid loop()\n{\n\tint ch_id, packet_len;\n\tchar * pb;\n\tint i = 0;\n\tchar c;\n\tif ((ctime + 29000) < millis())\n\t{\n\t\tString cipSend = \"AT+CIPSEND=2\\r\\n\";\n\t\tsendAT(cipSend, 3000);\n\t\tSerial.write(192);\n\t\tSerial.write(0);\n\t\tctime = millis();\n\t}\n\tif (Serial.available())\n\t{\n\t\twhile (Serial.available() > 0)\n\t\t{\n\t\t\tc = Serial.read();\n\t\t\tif (c > ' ' && c < 127)\n\t\t\t{\n\t\t\t\tbuff[i++] = c;\n\t\t\t}\n\t\t\tif (i > 1 && buff[i - 2] == 'I' && buff[i - 1] == '+')\n\t\t\t{\n\t\t\t\tbuff[i] = 0;\n\t\t\t\ti = 0;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t\tmySerial.print(buff);\n\t\tif (strncmp(buff, \"+IPD,\", 5) == 0)\n\t\t{\n\t\t\tmySerial.print(\" ok1\\r\\n\");\n\t\t\tsscanf(buff + 5, \"%d\", &packet_len);\n\t\t\tmySerial.print(\"@len: \");\n\t\t\tmySerial.println(packet_len);\n\t\t\tif (packet_len > 0)\n\t\t\t{\n\t\t\t\tif (packet_len == 27)\n\t\t\t\t{\n\t\t\t\t\tdigitalWrite(13, LOW);\n\t\t\t\t\tmySerial.print(\"@on@\");\n\t\t\t\t}\n\t\t\t\telse if (packet_len == 28)\n\t\t\t\t{\n\t\t\t\t\tdigitalWrite(13, HIGH);\n\t\t\t\t\tmySerial.print(\"@off@\");\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tmySerial.print(\"@?@\");\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\telse\n\t\t{\n\t\t\tmySerial.print(\" ng\\r\\n\");\n\t\t}\n\t}\n}\n```\n\n"}