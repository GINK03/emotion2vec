{"context": " More than 1 year has passed since last update.\u7a7a\u3044\u3066\u305f\u306e\u3067\u66f8\u304d\u307e\u3057\u305f\uff0e\n\n\u5185\u5bb9\n\n\u30ed\u30b0\u30a4\u30f3\u3057\u3066\u306a\u304b\u3063\u305f\u3089 \u30ed\u30b0\u30a4\u30f3\u30da\u30fc\u30b8\u306b\u30d5\u30a9\u30ef\u30fc\u30c9\u3059\u308b\n\u30ed\u30b0\u30a4\u30f3\u3057\u3066\u306a\u304b\u3063\u305f\u3089 \u30ed\u30b0\u30a4\u30f3\u30da\u30fc\u30b8\u306b\u30d5\u30a9\u30ef\u30fc\u30c9\u3059\u308b\u3088\u304f\u3042\u308b\u6a5f\u80fd\u3092\u8003\u3048\u307e\u3059\uff0e\n\u9069\u5f53\u306b\u4e0b\u8a18\u306e\u3088\u3046\u306a\u30b3\u30fc\u30c9\u3092\u5b9f\u88c5\u3057\u305f\u3068\u3057\u307e\u3057\u3087\u3046\uff0e\n\nAdminController.php\n<?php\n\nuse \\Phalcon\\Mvc\\Controller;\n\nclass AdminController extends Controller\n{\n    public function beforeExecuteRoute()\n    {\n        if ($this->dispatcher->getActionName() !== 'login' && !$this->session->get('is_auth')) {\n            $this->dispatcher->forward([\n                'controller' => 'admin',\n                'action' => 'login',\n            ]);\n            return false;\n        }\n    }\n\n    public function initialize()\n    {\n        $this->view->role = $this->session->get('is_auth') ? 'admin' : 'guest';\n    }\n\n    public function homeAction()\n    {\n    }\n\n    public function loginAction()\n    {\n    }\n} \n\n\n\nlogin.volt\n<!DOCTYPE html>\n<html>\n<head>\n    <meta charset=\"utf-8\">\n    {{ getTitle() }}\n</head>\n<body>\n   Your are {{ role }} !!! \n</body>\n</html>\n\n\n\n\u304b\u3044\u3064\u307e\u3093\u3067\u8aac\u660e\u3059\u308b\u3068 \u300c\u30ed\u30b0\u30a4\u30f3\u3057\u3066\u306a\u3051\u308c\u3070\u30ed\u30b0\u30a4\u30f3\u30da\u30fc\u30b8\u306b\u30d5\u30a9\u30ef\u30fc\u30c9\u3059\u308b\u300d\u3068\u3044\u3046\u3088\u3046\u306a\u30b3\u30fc\u30c9\u3067\u3059\uff0e\n\u30ed\u30b0\u30a4\u30f3\u30da\u30fc\u30b8\u3067\u306f \u300crole\u300d\u304c\u8868\u793a\u3055\u308c\u308b\u306e\u3067\u30ed\u30b0\u30a4\u30f3\u3057\u3066\u3044\u308c\u3070\u300cadmin\u300d\u3057\u3066\u3044\u306a\u3051\u308c\u3070\u300cguest\u300d\u3068\u8868\u793a\u3055\u308c\u308b\u306f\u305a\u3067\u3059\uff0e\n\ninitialize() \u304c\u547c\u3070\u308c\u306a\u3044\uff1f\n\u3055\u3066\u3053\u3053\u3067 http://localhost/admin/home \u306b\u30a2\u30af\u30bb\u30b9\u3057\u3066\u307f\u307e\u3059\uff0e\n\u306a\u306b\u3082\u30ed\u30b0\u30a4\u30f3\u3068\u304b\u305b\u305a\u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u306e\u3067 admin \u3067\u306f\u306a\u3044\u3067\u3057\u3087\u3046\u3057 \u300cYou you guest !!!\u300d\u3068\u8868\u793a\u3055\u308c\u308b\u3068\u601d\u3046\u3067\u3057\u3087\u3046\uff0e\n<!DOCTYPE html>\n<html>\n<head>\n    <meta charset=\"utf-8\">\n    <title>Admin Page</title>\n</head>\n<body>\n   Your are  !!!\n</body>\n</html>\n\nguest \u3069\u3053\u308d\u304b \u4f55\u3082\u8868\u793a\u3055\u308c\u306a\u3044\uff01\uff01\n\u3069\u3046\u3057\u3066\u3053\u3046\u306a\u3063\u305f\uff01\uff01\n\n\u30ed\u30b0\u3092\u5410\u304b\u305b\u3066\u30db\u30f3\u30c8\u306b initialize() \u304c\u547c\u3070\u308c\u3066\u306a\u3044\u304b\u78ba\u8a8d\n\u5143\u306e\u30b3\u30fc\u30c9\u3067\u3042\u308c\u3070 initialize() \u304c\u5b9f\u884c\u3055\u308c\u3066\u3044\u308c\u3070 role \u304c\u30bb\u30c3\u30c8\u3055\u308c\u3066\u3044\u308b\u306f\u305a\u3067\u3059\uff0e\n\u3068\u3044\u3046\u3053\u3068\u306f initialize() \u304c\u306a\u305c\u304b\u5b9f\u884c\u3055\u308c\u306a\u3044\u3088\u3046\u306a\u6c17\u3082\u3057\u307e\u3059\uff1f\n\u30ed\u30b0\u3092\u631f\u3093\u3067\u307f\u307e\u3057\u3087\u3046\uff0e\n\nAdminController.php\n<?php\n\nuse \\Phalcon\\Mvc\\Controller;\n\nclass AdminController extends Controller\n{\n    public function beforeExecuteRoute()\n    {\n        $this->logger->info('admin:beforeExecuteRoute');\n        if ($this->dispatcher->getActionName() !== 'login' && !$this->session->get('is_auth')) {\n            $this->logger->info('forward!!!');\n            $this->dispatcher->forward([\n                'controller' => 'admin',\n                'action' => 'login',\n            ]);\n        }\n    }\n\n    public function initialize()\n    {\n        $this->view->role = $this->session->get('is_auth') ? 'admin' : 'guest';\n\n        $this->logger->info('admin:initialize');\n    }\n\n    public function homeAction()\n    {\n        $this->logger->info('admin:home');\n    }\n\n    public function loginAction()\n    {\n        $this->logger->info('admin:login');\n    }\n} \n\n\n\u30ed\u30b0\u306f\u3069\u3046\u306a\u308b\u304b\uff0e\n\nlog\nadmin:beforeExecuteRoute\nforward!!!\nadmin:beforeExecuteRoute\nadmin:login\n\n\nadmin:initialize \u304c\u306a\u3044\u3067\u3059\u306d\uff0e\n\n\u306a\u306b\u304c\u8d77\u304d\u3066\u308b\u306e\u304b\n\u3069\u3046\u3044\u3046\u52d5\u4f5c\u306b\u306a\u3063\u3066\u308b\u304b\u8a73\u3057\u304f\u898b\u3066\u884c\u304d\u307e\u3057\u3087\u3046\uff0e\n\nPhalcon \u306e DI \u306f \u751f\u6210\u3055\u308c\u305f\u308a Singleton \u306b\u306a\u3063\u305f\u308a\n\u305d\u306e\u8aac\u660e\u306e\u524d\u306b\u4e00\u65e6 Phalcon \u306e DI \u306e\u7279\u6027\u306b\u3064\u3044\u3066\u66f8\u3044\u3066\u304a\u304d\u307e\u3059\uff0e\nPhalcon \u306e DI \u306f shared \u306b\u3057\u3066\u308b\u304b\u3069\u3046\u304b\u3067\u8fd4\u3063\u3066\u304f\u308b\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u304c\u65b0\u898f\u304b\u4f7f\u3044\u56de\u3057\u304b\u5909\u308f\u308a\u307e\u3059\uff0e\n\nDependency Injection/Service Location \u2014 Phalcon 1.3.1 \u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\nhttp://docs.phalconphp.com/ja/latest/reference/di.html#id11\n\nServices can be registered as \u201cshared\u201d services this means that they always will act as singletons. Once the service is resolved for the first time the same instance of it is returned every time a consumer retrieve the service from the container:\n\n\n\u3064\u307e\u308a $di->get('hoge') \u3068\u3057\u3066\u308b\u5834\u5408\u306f \u6bce\u56de\u7570\u306a\u308b\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u304c\u8fd4\u3063\u3066\u304d\u3066\uff0c $di->getShared('hoge') \u3068\u3059\u308b\u3068\u6bce\u56de\u540c\u3058\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u304c\u8fd4\u3063\u3066\u304d\u307e\u3059\uff0e \uff08$di->set() \u6642\u306b shared \u3068\u3057\u3066\u308b\u304b\u3069\u3046\u304b\u306b\u3082\u3088\u308b\u3051\u3069\uff09\n\u305d\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u304c\u751f\u6210\u3055\u308c\u305f\u304b\u65e2\u5b58\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u8fd4\u3057\u3066\u3044\u308b\u304b\u3069\u3046\u304b\u306b\u3064\u3044\u3066\u306f $di->getShared() \u3092\u547c\u3073\u51fa\u3057\u305f\u76f4\u5f8c\u306b $di->wasFreshInstance() \u3092\u547c\u3073\u51fa\u3059\u3053\u3068\u3067\u308f\u304b\u308a\u307e\u3059\uff0e\uff08 \u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\n\nDispatcher \u3067\u4f55\u304c\u884c\u308f\u308c\u3066\u3044\u308b\u304b\n\nDispatcher \u306e dispatch() \u306e\u6982\u8981\n\u3055\u3066\u8a71\u3092\u623b\u3059\u3068 initialize() \u304c\u547c\u3070\u308c\u305d\u3046\u306a\u3093\u3060\u3051\u3069\u547c\u3070\u308c\u3066\u306a\u3044\u3068\u3044\u3046\u611f\u3058\u3067\u3059\uff0e\nDispatcher \u306e dispatch() \u3067\u306f\u4e0b\u8a18\u306e\u3088\u3046\u306a\u30a4\u30d9\u30f3\u30c8\u3084\u30e1\u30bd\u30c3\u30c9\u304c\u547c\u3073\u51fa\u3055\u308c\u307e\u3059\uff0e\n\nPhalcon \u30a2\u30af\u30b7\u30e7\u30f3\u5468\u308a\u306e\u30a4\u30d9\u30f3\u30c8\u3068\u304b\u30e1\u30e2 - Qiita\nhttp://qiita.com/nise_nabe/items/87aac65fffc192c1b0f1\n\n\u203b\uff11 \u8a18\u4e8b\u306b\u306f\u66f8\u3044\u3066\u306a\u3044\u3051\u3069\u7a2e\u985e\u306f\u30c6\u30ad\u30c8\u30fc\u306b\u81ea\u5206\u304c\u52dd\u624b\u306b\u547c\u3073\u540d\u3064\u3051\u3066\u308b\u3060\u3051\u3067\u3059\uff0e\n\u203b\uff12 \u95a2\u4fc2\u306a\u3044\u3051\u3069  dispatch:afterInitialize \u30a4\u30d9\u30f3\u30c8\u629c\u3051\u3066\u305f\uff0e\n\n\n\n\u7a2e\u985e\n\u540d\u524d\u3068\u304b\n\u5b9f\u884c\u56de\u6570\u3068\u304b\n\n\n\n\nEvent\ndispatch:beforeDispatch\n\u30c7\u30a3\u30b9\u30d1\u30c3\u30c1\u30eb\u30fc\u30d7\u304c\u56de\u308b\u3054\u3068\u306b\u4e00\u56de\u3067\u30a2\u30af\u30b7\u30e7\u30f3\u304c\u306a\u304f\u3066\u3082\u5b9f\u884c\n\n\nEvent\ndispatch:beforeExecuteRoute\n\u30c7\u30a3\u30b9\u30d1\u30c3\u30c1\u30eb\u30fc\u30d7\u304c\u56de\u308b\u3054\u3068\u306b\u4e00\u56de\u3067\u30a2\u30af\u30b7\u30e7\u30f3\u304c\u3042\u3063\u305f\u3089\u5b9f\u884c\n\n\nMethod\nController#beforeExecuteRoute()\n\u30c7\u30a3\u30b9\u30d1\u30c3\u30c1\u30eb\u30fc\u30d7\u304c\u56de\u308b\u3054\u3068\u306b\u4e00\u56de\u3067\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u3067\u5b9a\u7fa9\u3067\u304d\u308b\u524d\u51e6\u7406\n\n\nMethod\nController#initialize()\n\u6700\u521d\u306b\u5bfe\u8c61\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u304c\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u5316\u3055\u308c\u305f\u3068\u304d\u3060\u3051\n\n\nMethod\nController#xxxAction()\n<- \u30e1\u30a4\u30f3\n\n\n\n\u3053\u308c\u3092\u898b\u308b\u3068 beforeExecuteRoute \u306e\u3042\u3068\u3067\u30a2\u30af\u30b7\u30e7\u30f3\u304c\u5b9f\u884c\u3055\u308c\u308b\u307e\u3048\u3050\u3089\u3044\u306b\u306f initialize() \u304c\u5b9f\u884c\u3055\u308c\u308b\u3088\u3046\u306b\u898b\u3048\u307e\u3059\uff0e\n\nDispatcher \u306e dispatch() \u306e\u30b3\u30fc\u30c9\n\u3082\u3046\u3061\u3087\u3063\u3068\u8a73\u3057\u304f\u898b\u308b\u305f\u3081\u306b Dispatcher \u306e\u30b3\u30fc\u30c9\u3092\u8ffd\u3063\u3066\u307f\u307e\u3059\uff0e\nhttps://github.com/phalcon/cphalcon/blob/phalcon-v1.3.4/ext/dispatcher.c#L568\n\u8981\u70b9\u3092\u7d5e\u308b\u305f\u3081\u306b\u64ec\u4f3c\u30b3\u30fc\u30c9\u3092\u66f8\u304f\u3068\u4e0b\u8a18\u306e\u3088\u3046\u306b\u306a\u308a\u307e\u3059\uff0e\n\uff08Dispatcher \u5185\uff09\nfunction dispatch()\n{\n  fireEvent(\"dispatch:beforeDispatchLoop\")\n  while(1) {\n    $this->_finish = true;\n    $handlerName = $this->getHandlerName()\n    $actionName = $this->getActionName()\n\n    if (fireEvent(\"dispatch:beforeDispatch\") === false) continue;\n    if ($this->_finish === false) continue;\n\n    $handler = $this->getShared($handlerName)\n    $wasFresh = $this->wasFreshInstance();\n\n    if (method_exist($handler, $actionName) {\n      if (fireEvent(\"dispatch:beforeNotFoundAction\") === false) continue;\n      throw new Phalcon\\Dispatcher\\Exception( \"Action '\", action_name, \"' was not found on handler '\", EXCEPTION_ACTION_NOT_FOUND);\n    }\n\n\n    if (fireEvent(\"dispatch:beforeExecuteRoute\") === false) continue;\n    if ($this->_finish === false) continue;\n\n    if ($handler->beforeExecuteRoute() === false) continue;\n    if ($this->_finish === false) continue;\n\n    if ($wasFresh === true) {\n      $handler->initialize();\n      if (fireEvent(\"dispatch:afterInitialize\") === false) continue;\n      if ($this->_finish === false) continue;\n    }\n\n    $handler->$actionName();\n  }\n}\n\nfunction forward($forward)\n{\n  $this->setHandlerName($forward['controller']);\n  $this->setActionName($forward['action']);\n  $this->_finished = false;\n}\n\nPhalcon \u306e Dispatcher \u3067\u306f forward() \u3068\u306f\u3053\u306e\u30c7\u30a3\u30b9\u30d1\u30c3\u30c1\u30eb\u30fc\u30d7\u3092\u3082\u3046\u4e00\u56de\u56de\u3059\u3053\u3068\u306b\u76f8\u5f53\u3057\u307e\u3059\uff0e\n\nwasFresh \u3067\u306a\u3044\u3068 initialize() \u304c\u547c\u3070\u308c\u306a\u3044\ndispatch() \u306e\u30b3\u30fc\u30c9\u3092\u898b\u308b\u3068\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u306f DI \u306b\u3088\u3063\u3066 Singleton \u3068\u3057\u3066\u53d6\u5f97\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308a\u307e\u3059\uff0e\n\u305d\u3057\u3066 forward() \u304c\u3088\u3070\u308c\u3066\u3044\u308b\u5834\u5408\u306f _finished \u306e\u5024\u304c false \u3068\u306a\u308b\u306e\u3067 while \u30eb\u30fc\u30d7\u304c continue \u306b\u306a\u308a\u307e\u3059\uff0e\n\u305d\u306e\u4e0a\u3067 initialize() \u304c\u3069\u3053\u3067\u547c\u3070\u308c\u3066\u3044\u308b\u304b\uff0ewasFresh \u304c true \u306e\u5834\u5408\u3067\u3059\u306d\uff0e\u305d\u3057\u3066\u3053\u308c\u306f beforeExecuteRoute() \u306e\u3042\u3068\u3067\u3059\uff0e\n\u3067\u306f\u6700\u521d\u306e\u30b3\u30fc\u30c9\u306f\u3069\u3046\u306a\u3063\u3066\u3044\u305f\u3067\u3057\u3087\u3046\u304b\n\nAdminController.php\n<?php\n\nuse \\Phalcon\\Mvc\\Controller;\n\nclass AdminController extends Controller\n{\n    public function beforeExecuteRoute()\n    {\n        if ($this->dispatcher->getActionName() !== 'login' && !$this->session->get('is_auth')) {\n            $this->dispatcher->forward([\n                'controller' => 'admin',\n                'action' => 'login',\n            ]);\n            return false;\n        }\n    }\n\n    public function initialize()\n    {\n        $this->view->role = $this->session->get('is_auth') ? 'admin' : 'guest';\n    }\n\n    public function homeAction()\n    {\n    }\n\n    public function loginAction()\n    {\n    }\n} \n\n\n\ngetShared() \u3067\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u304c\u751f\u6210\u3055\u308c\u308b\uff08\u3053\u3053\u3067\u306f wasFresh \u306f true\uff09\nbeforeExecuteRoute() \u3067 forward() \u3057\u3066\u3044\u308b\u305f\u3081\u30c7\u30a3\u30b9\u30d1\u30c3\u30c1\u30eb\u30fc\u30d7\u306e\u6700\u521d\u306b\u623b\u308b\ngetShared() \u3067\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u304c\u53d6\u5f97\u3055\u308c\u308b\uff08\u3053\u3053\u3067\u306f wasFresh \u306f false\uff09\nwasFresh \u306f false \u3068\u306a\u308b\u305f\u3081 initialize() \u306f\u30b9\u30eb\u30fc\n\u30a2\u30af\u30b7\u30e7\u30f3\u30e1\u30bd\u30c3\u30c9\u304c\u547c\u3070\u308c\u308b\n\n\u3068\u306a\u308a\u307e\u3059\uff0e\n\u306a\u308b\u307b\u3069 initialize() \u304c\u547c\u3070\u308c\u306a\u3044\u3067\u3059\u306d\uff0e\u3053\u308c\u306f\u30d0\u30b0\u306a\u306e\u304b\u3088\u304f\u308f\u304b\u3089\u306a\u3044\u3067\u3059\u3051\u3069\u4ed6\u306e\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u306b forward \u3057\u305f\u5834\u5408\u306f initialize() \u547c\u3070\u308c\u308b\u306e\u306b\u540c\u3058\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\n\u306b fowrward() \u3059\u308b\u3068\u547c\u3070\u308c\u306a\u3044\u306e\u306f\u3061\u3087\u3063\u3068\u610f\u5473\u304c\u308f\u304b\u3089\u306a\u3044\uff0e\n\n\u5bfe\u51e6\u3069\u3046\u3059\u308c\u3070\uff1f\ninitialize() \u306f\u305f\u3076\u3093\u751f\u6210\u3055\u308c\u3066\u4e00\u56de\u3060\u3051\u547c\u3070\u308c\u308b\u60f3\u5b9a\u306e\u306f\u305a\u306a\u306e\u3067\u3058\u3083\u3042 \u4ee3\u308f\u308a\u306b\u30b3\u30f3\u30b9\u30c8\u30e9\u30af\u30bf\u306b\u66f8\u3044\u3066\u3057\u307e\u3048\u3070\u3044\u3044\u306e\u3067\u306f\uff1f\uff1f\uff1f\nhttp://docs.phalconphp.com/ja/latest/api/Phalcon_Mvc_Controller.html#methods\n\nfinal public __construct ()\n\nfinal \u6307\u5b9a\u306a\u3093\u3067\u3059\u306d\uff0e\u30aa\u30fc\u30d0\u30fc\u30e9\u30a4\u30c9\u3067\u304d\u307e\u305b\u3093\uff0e\u30c0\u30e1\u3067\u3057\u305f\uff0e\n\u308f\u308a\u3068\u3069\u3046\u3057\u3088\u3046\u3082\u306a\u3044\u306e\u3067 \u81ea\u5206\u3067 $isFresh \u4f5c\u3063\u3066\u5bfe\u5fdc\u3059\u308b\u3068\u304b\u8907\u6570\u56de\u547c\u3070\u308c\u3066\u3082\u5927\u4e08\u592b\u306a\u3088\u3046\u306a\u30b3\u30fc\u30c9\u306b\u3057\u3066 beforeExexuteRoute() \u306b\u5165\u308c\u308b\u3068\u304b\u3059\u308b\u3057\u304b\u306a\u3044\u3067\u3059\u304b\u306d\uff0e\n\n404 \u30da\u30fc\u30b8\u3092\u5b9f\u88c5\u3057\u305f\u6642\u306b\u3082\u8d77\u304d\u305d\u3046\n\u3053\u3053\u3067\u307e\u3060 dispatch() \u306e\u30b3\u30fc\u30c9\u3092\u307f\u308b\u3068\uff0c getShared() \u3067\u547c\u3073\u51fa\u3057\u305f\u5f8c\u304b\u3089 initialize() \u304c\u547c\u3070\u308c\u308b\u307e\u3067\u306e\u9593\u306b continue \u304c\u884c\u308f\u308c\u308b\u5834\u5408\u3082\u3042\u308a\u307e\u3059\uff0e\n\u30b3\u30fc\u30c9\u90e8\u5206\u3092\u78ba\u8a8d\u3059\u308b\u3068\u4e0b\u8a18\u90e8\u5206\u3082\u8a72\u5f53\u3057\u307e\u3059\uff0e\nhttps://github.com/phalcon/cphalcon/blob/phalcon-v1.3.4/ext/dispatcher.c#L792\n    if (method_exist($handler, $actionName) {\n      if (fireEvent(\"dispatch:beforeNotFoundAction\") === false) continue;\n      throw new Phalcon\\Dispatcher\\Exception( \"Action '\", action_name, \"' was not found on handler '\", EXCEPTION_ACTION_NOT_FOUND);\n    }\n\n\u64ec\u4f3c\u30b3\u30fc\u30c9\u3067\u306f throw \u3068\u8868\u3057\u3066\u3057\u3066\u307e\u3059\u304c\u672c\u5f53\u306f Phalcon\\Dispatcher#_throwdispatchexception() \u304c\u547c\u3070\u308c\u3066\u8fd4\u308a\u5024\u304c false \u306e\u5834\u5408 continue \u3057\u3066\u307e\u3059\uff0e\n\u3042\u308a\u5f97\u308b\u30d1\u30bf\u30fc\u30f3\u306f\u4f8b\u3048\u3070 ErrorController \u30a8\u30e9\u30fc\u30da\u30fc\u30b8\u3092\u96c6\u3081\u305f\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u3092\u4f5c\u3063\u305f\u5834\u5408\u306b\u5b58\u5728\u3057\u306a\u3044\u30a2\u30af\u30b7\u30e7\u30f3\u306e\u30da\u30fc\u30b8\u3092\u958b\u3053\u3046\u3068\u3057\u3066\u4f8b\u5916\u3092\u6295\u3052\u308b\u30d1\u30bf\u30fc\u30f3\u3067\u3059\uff0e\n\u300c\u30a2\u30af\u30b7\u30e7\u30f3\u304c\u306a\u304b\u3063\u305f\u3089\u30a8\u30e9\u30fc\u30da\u30fc\u30b8\u306b\u98db\u3070\u3059\u300d\u3068\u3044\u3046\u611f\u3058\u3067\u3059\u306d\uff0e\n\u5148\u65e5\u306e\u8a18\u4e8b \u306b\u3082\u66f8\u3044\u305f 404 \u30da\u30fc\u30b8\u3078\u306e\u9077\u79fb error \u30a2\u30af\u30b7\u30e7\u30f3\u306b\u98db\u3093\u3067\u307e\u3059\u306d\uff0e\n\u3053\u306e EXCEPTION_ACTION_NOT_FOUND \u304c error/hoge \u306e\u3088\u3046\u306a\u9069\u5f53\u306a\u30da\u30fc\u30b8\u306b\u30a2\u30af\u30bb\u30b9\u3057\u305f\u6642\u306b\u3082\u6295\u3052\u3089\u308c\u307e\u3059\uff0e\n\u3059\u308b\u3068 ErrorController \u306e initialize() \u306f\u5b9f\u884c\u3055\u308c\u307e\u305b\u3093\uff0e\n\nphp - How to setup a 404 page in Phalcon - Stack Overflow\nhttps://stackoverflow.com/questions/14071261/how-to-setup-a-404-page-in-phalcon\n\n       $evManager->attach(\n            \"dispatch:beforeException\",\n            function($event, $dispatcher, $exception)\n            {\n                switch ($exception->getCode()) {\n                    case PhDispatcher::EXCEPTION_HANDLER_NOT_FOUND:\n                    case PhDispatcher::EXCEPTION_ACTION_NOT_FOUND:\n                        $dispatcher->forward(\n                            array(\n                                'controller' => 'error',\n                                'action'     => 'show404',\n                            )\n                        );\n                        return false;\n                }\n            }\n        );\n\n\u3046\u30fc\u3093\uff0e\u3069\u3046\u3059\u308b\u304b\uff0e\n\n\u65e2\u77e5\u306e\u30d0\u30b0\u304b\n\u4e0b\u8a18\u4e8c\u3064\u306e\u30c1\u30b1\u30c3\u30c8\u304c\u3042\u308a\u307e\u3059\uff0e\n\nDispatcher forward doesn't work from initialize in Controller (1.2.3) \u00b7 Issue #1431 \u00b7 phalcon/cphalcon\nhttps://github.com/phalcon/cphalcon/issues/1431\n\n\uff12\u3064\u76ee\n\n[BUG] Controller method beforeExecuteRoute and Initialize problem \u00b7 Issue #2413 \u00b7 phalcon/cphalcon\nhttps://github.com/phalcon/cphalcon/issues/2413\n\n\u307e\u3042\u4f3c\u305f\u3088\u3046\u306a\u554f\u984c\u304c\u5831\u544a\u3055\u308c\u3066\u306f\u3044\u307e\u3059\u304c\u89e3\u6c7a\u306f\u3057\u3066\u306a\u3044\u3088\u3046\u3067\u3059\uff0e\n\u307e\u3042\u8ae6\u3081\u307e\u3057\u3087\u3046\uff0e\n\n\u304a\u308f\u308a\u306b\n\u3053\u3053\u3067\u306f Phalcon \u306e DI \u3068 Dipsatcher \u306e\u52d5\u304d\u304c\u7d44\u307f\u5408\u308f\u3055\u3063\u3066\u767a\u751f\u3057\u305f\u30d0\u30b0\u306b\u3064\u3044\u3066\u66f8\u3044\u3066\u307f\u307e\u3057\u305f\uff0e\n\u3053\u3046\u3044\u3046\u53d6\u3063\u639b\u304b\u308a\u3092\u5f97\u3066\u4e2d\u8eab\u3092\u8aad\u307f\u8fbc\u3080\u306e\u306f\u3044\u3044\u3093\u3058\u3083\u306a\u3044\u3067\u3057\u3087\u3046\u304b\uff01\n2.0 \u3067\u540c\u3058\u30d0\u30b0\u304c\u6709\u308b\u304b\u3069\u3046\u304b\u306f\u78ba\u8a8d\u3057\u3066\u306a\u3044\u3067\u3059\uff0e\n\u81ea\u5206\u306f\u30b3\u30f3\u30c8\u30ea\u30d3\u30e5\u30fc\u30c8\u3059\u308b\u6c17\u3042\u3093\u307e\u308a\u306a\u3044\u3067\u3059\u304c\uff0c\u3060\u308c\u304b\u3044\u3044\u611f\u3058\u306b\u3067\u304d\u308b\u306a\u3089\u76f4\u3057\u305f\u308a\u5831\u544a\u3057\u3066\u307f\u305f\u3089\u3044\u3044\u3093\u3058\u3083\u306a\u3044\u304b\u306a\uff01 \n\u4ee5\u4e0a\u3067\u3059\uff0e\n\u7a7a\u3044\u3066\u305f\u306e\u3067\u66f8\u304d\u307e\u3057\u305f\uff0e\n\n# \u5185\u5bb9\n\n## \u30ed\u30b0\u30a4\u30f3\u3057\u3066\u306a\u304b\u3063\u305f\u3089 \u30ed\u30b0\u30a4\u30f3\u30da\u30fc\u30b8\u306b\u30d5\u30a9\u30ef\u30fc\u30c9\u3059\u308b\n\n\u30ed\u30b0\u30a4\u30f3\u3057\u3066\u306a\u304b\u3063\u305f\u3089 \u30ed\u30b0\u30a4\u30f3\u30da\u30fc\u30b8\u306b\u30d5\u30a9\u30ef\u30fc\u30c9\u3059\u308b\u3088\u304f\u3042\u308b\u6a5f\u80fd\u3092\u8003\u3048\u307e\u3059\uff0e\n\u9069\u5f53\u306b\u4e0b\u8a18\u306e\u3088\u3046\u306a\u30b3\u30fc\u30c9\u3092\u5b9f\u88c5\u3057\u305f\u3068\u3057\u307e\u3057\u3087\u3046\uff0e\n\n```php:AdminController.php\n<?php\n\nuse \\Phalcon\\Mvc\\Controller;\n\nclass AdminController extends Controller\n{\n    public function beforeExecuteRoute()\n    {\n        if ($this->dispatcher->getActionName() !== 'login' && !$this->session->get('is_auth')) {\n            $this->dispatcher->forward([\n                'controller' => 'admin',\n                'action' => 'login',\n            ]);\n            return false;\n        }\n    }\n\n    public function initialize()\n    {\n        $this->view->role = $this->session->get('is_auth') ? 'admin' : 'guest';\n    }\n\n    public function homeAction()\n    {\n    }\n\n    public function loginAction()\n    {\n    }\n} \n```\n\n```twig:login.volt\n<!DOCTYPE html>\n<html>\n<head>\n    <meta charset=\"utf-8\">\n    {{ getTitle() }}\n</head>\n<body>\n   Your are {{ role }} !!! \n</body>\n</html>\n\n```\n\n\u304b\u3044\u3064\u307e\u3093\u3067\u8aac\u660e\u3059\u308b\u3068 \u300c\u30ed\u30b0\u30a4\u30f3\u3057\u3066\u306a\u3051\u308c\u3070\u30ed\u30b0\u30a4\u30f3\u30da\u30fc\u30b8\u306b\u30d5\u30a9\u30ef\u30fc\u30c9\u3059\u308b\u300d\u3068\u3044\u3046\u3088\u3046\u306a\u30b3\u30fc\u30c9\u3067\u3059\uff0e\n\u30ed\u30b0\u30a4\u30f3\u30da\u30fc\u30b8\u3067\u306f \u300crole\u300d\u304c\u8868\u793a\u3055\u308c\u308b\u306e\u3067\u30ed\u30b0\u30a4\u30f3\u3057\u3066\u3044\u308c\u3070\u300cadmin\u300d\u3057\u3066\u3044\u306a\u3051\u308c\u3070\u300cguest\u300d\u3068\u8868\u793a\u3055\u308c\u308b\u306f\u305a\u3067\u3059\uff0e\n\n## initialize() \u304c\u547c\u3070\u308c\u306a\u3044\uff1f\n\n\u3055\u3066\u3053\u3053\u3067 http://localhost/admin/home \u306b\u30a2\u30af\u30bb\u30b9\u3057\u3066\u307f\u307e\u3059\uff0e\n\u306a\u306b\u3082\u30ed\u30b0\u30a4\u30f3\u3068\u304b\u305b\u305a\u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u306e\u3067 admin \u3067\u306f\u306a\u3044\u3067\u3057\u3087\u3046\u3057 \u300cYou you guest !!!\u300d\u3068\u8868\u793a\u3055\u308c\u308b\u3068\u601d\u3046\u3067\u3057\u3087\u3046\uff0e\n\n```html\n<!DOCTYPE html>\n<html>\n<head>\n    <meta charset=\"utf-8\">\n    <title>Admin Page</title>\n</head>\n<body>\n   Your are  !!!\n</body>\n</html>\n```\n\nguest \u3069\u3053\u308d\u304b \u4f55\u3082\u8868\u793a\u3055\u308c\u306a\u3044\uff01\uff01\n\u3069\u3046\u3057\u3066\u3053\u3046\u306a\u3063\u305f\uff01\uff01\n\n### \u30ed\u30b0\u3092\u5410\u304b\u305b\u3066\u30db\u30f3\u30c8\u306b initialize() \u304c\u547c\u3070\u308c\u3066\u306a\u3044\u304b\u78ba\u8a8d\n\n\u5143\u306e\u30b3\u30fc\u30c9\u3067\u3042\u308c\u3070 initialize() \u304c\u5b9f\u884c\u3055\u308c\u3066\u3044\u308c\u3070 role \u304c\u30bb\u30c3\u30c8\u3055\u308c\u3066\u3044\u308b\u306f\u305a\u3067\u3059\uff0e\n\u3068\u3044\u3046\u3053\u3068\u306f initialize() \u304c\u306a\u305c\u304b\u5b9f\u884c\u3055\u308c\u306a\u3044\u3088\u3046\u306a\u6c17\u3082\u3057\u307e\u3059\uff1f\n\u30ed\u30b0\u3092\u631f\u3093\u3067\u307f\u307e\u3057\u3087\u3046\uff0e\n\n```php:AdminController.php\n<?php\n\nuse \\Phalcon\\Mvc\\Controller;\n\nclass AdminController extends Controller\n{\n    public function beforeExecuteRoute()\n    {\n        $this->logger->info('admin:beforeExecuteRoute');\n        if ($this->dispatcher->getActionName() !== 'login' && !$this->session->get('is_auth')) {\n            $this->logger->info('forward!!!');\n            $this->dispatcher->forward([\n                'controller' => 'admin',\n                'action' => 'login',\n            ]);\n        }\n    }\n\n    public function initialize()\n    {\n        $this->view->role = $this->session->get('is_auth') ? 'admin' : 'guest';\n\n        $this->logger->info('admin:initialize');\n    }\n\n    public function homeAction()\n    {\n        $this->logger->info('admin:home');\n    }\n\n    public function loginAction()\n    {\n        $this->logger->info('admin:login');\n    }\n} \n```\n\n\u30ed\u30b0\u306f\u3069\u3046\u306a\u308b\u304b\uff0e\n\n```txt:log\nadmin:beforeExecuteRoute\nforward!!!\nadmin:beforeExecuteRoute\nadmin:login\n```\n\nadmin:initialize \u304c\u306a\u3044\u3067\u3059\u306d\uff0e\n\n##\u306a\u306b\u304c\u8d77\u304d\u3066\u308b\u306e\u304b\n\n\u3069\u3046\u3044\u3046\u52d5\u4f5c\u306b\u306a\u3063\u3066\u308b\u304b\u8a73\u3057\u304f\u898b\u3066\u884c\u304d\u307e\u3057\u3087\u3046\uff0e\n\n### Phalcon \u306e DI \u306f \u751f\u6210\u3055\u308c\u305f\u308a Singleton \u306b\u306a\u3063\u305f\u308a\n\n\u305d\u306e\u8aac\u660e\u306e\u524d\u306b\u4e00\u65e6 Phalcon \u306e DI \u306e\u7279\u6027\u306b\u3064\u3044\u3066\u66f8\u3044\u3066\u304a\u304d\u307e\u3059\uff0e\nPhalcon \u306e DI \u306f shared \u306b\u3057\u3066\u308b\u304b\u3069\u3046\u304b\u3067\u8fd4\u3063\u3066\u304f\u308b\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u304c\u65b0\u898f\u304b\u4f7f\u3044\u56de\u3057\u304b\u5909\u308f\u308a\u307e\u3059\uff0e\n\n> Dependency Injection/Service Location \u2014 Phalcon 1.3.1 \u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\n> http://docs.phalconphp.com/ja/latest/reference/di.html#id11\n>> Services can be registered as \u201cshared\u201d services this means that they always will act as singletons. Once the service is resolved for the first time the same instance of it is returned every time a consumer retrieve the service from the container:\n\n\u3064\u307e\u308a `$di->get('hoge')` \u3068\u3057\u3066\u308b\u5834\u5408\u306f \u6bce\u56de\u7570\u306a\u308b\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u304c\u8fd4\u3063\u3066\u304d\u3066\uff0c `$di->getShared('hoge')` \u3068\u3059\u308b\u3068\u6bce\u56de\u540c\u3058\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u304c\u8fd4\u3063\u3066\u304d\u307e\u3059\uff0e \uff08`$di->set()` \u6642\u306b shared \u3068\u3057\u3066\u308b\u304b\u3069\u3046\u304b\u306b\u3082\u3088\u308b\u3051\u3069\uff09\n\n\u305d\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u304c\u751f\u6210\u3055\u308c\u305f\u304b\u65e2\u5b58\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u8fd4\u3057\u3066\u3044\u308b\u304b\u3069\u3046\u304b\u306b\u3064\u3044\u3066\u306f `$di->getShared()` \u3092\u547c\u3073\u51fa\u3057\u305f\u76f4\u5f8c\u306b `$di->wasFreshInstance()` \u3092\u547c\u3073\u51fa\u3059\u3053\u3068\u3067\u308f\u304b\u308a\u307e\u3059\uff0e\uff08 [\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8](http://docs.phalconphp.com/ja/latest/api/Phalcon_DI.html)\n\n\n### Dispatcher \u3067\u4f55\u304c\u884c\u308f\u308c\u3066\u3044\u308b\u304b\n\n#### Dispatcher \u306e dispatch() \u306e\u6982\u8981\n\n\u3055\u3066\u8a71\u3092\u623b\u3059\u3068 initialize() \u304c\u547c\u3070\u308c\u305d\u3046\u306a\u3093\u3060\u3051\u3069\u547c\u3070\u308c\u3066\u306a\u3044\u3068\u3044\u3046\u611f\u3058\u3067\u3059\uff0e\nDispatcher \u306e dispatch() \u3067\u306f\u4e0b\u8a18\u306e\u3088\u3046\u306a\u30a4\u30d9\u30f3\u30c8\u3084\u30e1\u30bd\u30c3\u30c9\u304c\u547c\u3073\u51fa\u3055\u308c\u307e\u3059\uff0e\n\n> Phalcon \u30a2\u30af\u30b7\u30e7\u30f3\u5468\u308a\u306e\u30a4\u30d9\u30f3\u30c8\u3068\u304b\u30e1\u30e2 - Qiita\n> http://qiita.com/nise_nabe/items/87aac65fffc192c1b0f1\n\n\u203b\uff11 \u8a18\u4e8b\u306b\u306f\u66f8\u3044\u3066\u306a\u3044\u3051\u3069\u7a2e\u985e\u306f\u30c6\u30ad\u30c8\u30fc\u306b\u81ea\u5206\u304c\u52dd\u624b\u306b\u547c\u3073\u540d\u3064\u3051\u3066\u308b\u3060\u3051\u3067\u3059\uff0e\n\u203b\uff12 \u95a2\u4fc2\u306a\u3044\u3051\u3069  dispatch:afterInitialize \u30a4\u30d9\u30f3\u30c8\u629c\u3051\u3066\u305f\uff0e\n\n| \u7a2e\u985e   | \u540d\u524d\u3068\u304b                         | \u5b9f\u884c\u56de\u6570\u3068\u304b |\n|:-------|:---------------------------------|:---------|\n| Event  | dispatch:beforeDispatch          | \u30c7\u30a3\u30b9\u30d1\u30c3\u30c1\u30eb\u30fc\u30d7\u304c\u56de\u308b\u3054\u3068\u306b\u4e00\u56de\u3067\u30a2\u30af\u30b7\u30e7\u30f3\u304c\u306a\u304f\u3066\u3082\u5b9f\u884c  |\n| Event  | dispatch:beforeExecuteRoute      | \u30c7\u30a3\u30b9\u30d1\u30c3\u30c1\u30eb\u30fc\u30d7\u304c\u56de\u308b\u3054\u3068\u306b\u4e00\u56de\u3067\u30a2\u30af\u30b7\u30e7\u30f3\u304c\u3042\u3063\u305f\u3089\u5b9f\u884c |\n| Method | Controller#beforeExecuteRoute()  | \u30c7\u30a3\u30b9\u30d1\u30c3\u30c1\u30eb\u30fc\u30d7\u304c\u56de\u308b\u3054\u3068\u306b\u4e00\u56de\u3067\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u3067\u5b9a\u7fa9\u3067\u304d\u308b\u524d\u51e6\u7406 |\n| Method | Controller#initialize()          | \u6700\u521d\u306b\u5bfe\u8c61\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u304c\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u5316\u3055\u308c\u305f\u3068\u304d\u3060\u3051 |\n| Method | Controller#xxxAction()           | <- \u30e1\u30a4\u30f3 |\n\n\u3053\u308c\u3092\u898b\u308b\u3068 beforeExecuteRoute \u306e\u3042\u3068\u3067\u30a2\u30af\u30b7\u30e7\u30f3\u304c\u5b9f\u884c\u3055\u308c\u308b\u307e\u3048\u3050\u3089\u3044\u306b\u306f initialize() \u304c\u5b9f\u884c\u3055\u308c\u308b\u3088\u3046\u306b\u898b\u3048\u307e\u3059\uff0e\n\n#### Dispatcher \u306e dispatch() \u306e\u30b3\u30fc\u30c9\n\n\u3082\u3046\u3061\u3087\u3063\u3068\u8a73\u3057\u304f\u898b\u308b\u305f\u3081\u306b Dispatcher \u306e\u30b3\u30fc\u30c9\u3092\u8ffd\u3063\u3066\u307f\u307e\u3059\uff0e\n\nhttps://github.com/phalcon/cphalcon/blob/phalcon-v1.3.4/ext/dispatcher.c#L568\n\n\u8981\u70b9\u3092\u7d5e\u308b\u305f\u3081\u306b\u64ec\u4f3c\u30b3\u30fc\u30c9\u3092\u66f8\u304f\u3068\u4e0b\u8a18\u306e\u3088\u3046\u306b\u306a\u308a\u307e\u3059\uff0e\n\n```\u64ec\u4f3c\u30b3\u30fc\u30c9\n\uff08Dispatcher \u5185\uff09\nfunction dispatch()\n{\n  fireEvent(\"dispatch:beforeDispatchLoop\")\n  while(1) {\n    $this->_finish = true;\n    $handlerName = $this->getHandlerName()\n    $actionName = $this->getActionName()\n\n    if (fireEvent(\"dispatch:beforeDispatch\") === false) continue;\n    if ($this->_finish === false) continue;\n\n    $handler = $this->getShared($handlerName)\n    $wasFresh = $this->wasFreshInstance();\n\n    if (method_exist($handler, $actionName) {\n      if (fireEvent(\"dispatch:beforeNotFoundAction\") === false) continue;\n      throw new Phalcon\\Dispatcher\\Exception( \"Action '\", action_name, \"' was not found on handler '\", EXCEPTION_ACTION_NOT_FOUND);\n    }\n\n  \n    if (fireEvent(\"dispatch:beforeExecuteRoute\") === false) continue;\n    if ($this->_finish === false) continue;\n  \n    if ($handler->beforeExecuteRoute() === false) continue;\n    if ($this->_finish === false) continue;\n  \n    if ($wasFresh === true) {\n      $handler->initialize();\n      if (fireEvent(\"dispatch:afterInitialize\") === false) continue;\n      if ($this->_finish === false) continue;\n    }\n  \n    $handler->$actionName();\n  }\n}\n\nfunction forward($forward)\n{\n  $this->setHandlerName($forward['controller']);\n  $this->setActionName($forward['action']);\n  $this->_finished = false;\n}\n```\n\nPhalcon \u306e Dispatcher \u3067\u306f forward() \u3068\u306f\u3053\u306e\u30c7\u30a3\u30b9\u30d1\u30c3\u30c1\u30eb\u30fc\u30d7\u3092\u3082\u3046\u4e00\u56de\u56de\u3059\u3053\u3068\u306b\u76f8\u5f53\u3057\u307e\u3059\uff0e\n\n#### wasFresh \u3067\u306a\u3044\u3068 initialize() \u304c\u547c\u3070\u308c\u306a\u3044\n\ndispatch() \u306e\u30b3\u30fc\u30c9\u3092\u898b\u308b\u3068\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u306f DI \u306b\u3088\u3063\u3066 Singleton \u3068\u3057\u3066\u53d6\u5f97\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308a\u307e\u3059\uff0e\n\u305d\u3057\u3066 forward() \u304c\u3088\u3070\u308c\u3066\u3044\u308b\u5834\u5408\u306f _finished \u306e\u5024\u304c false \u3068\u306a\u308b\u306e\u3067 while \u30eb\u30fc\u30d7\u304c continue \u306b\u306a\u308a\u307e\u3059\uff0e\n\u305d\u306e\u4e0a\u3067 initialize() \u304c\u3069\u3053\u3067\u547c\u3070\u308c\u3066\u3044\u308b\u304b\uff0ewasFresh \u304c true \u306e\u5834\u5408\u3067\u3059\u306d\uff0e\u305d\u3057\u3066\u3053\u308c\u306f beforeExecuteRoute() \u306e\u3042\u3068\u3067\u3059\uff0e\n\n\u3067\u306f\u6700\u521d\u306e\u30b3\u30fc\u30c9\u306f\u3069\u3046\u306a\u3063\u3066\u3044\u305f\u3067\u3057\u3087\u3046\u304b\n\n```php:AdminController.php\n<?php\n\nuse \\Phalcon\\Mvc\\Controller;\n\nclass AdminController extends Controller\n{\n    public function beforeExecuteRoute()\n    {\n        if ($this->dispatcher->getActionName() !== 'login' && !$this->session->get('is_auth')) {\n            $this->dispatcher->forward([\n                'controller' => 'admin',\n                'action' => 'login',\n            ]);\n            return false;\n        }\n    }\n\n    public function initialize()\n    {\n        $this->view->role = $this->session->get('is_auth') ? 'admin' : 'guest';\n    }\n\n    public function homeAction()\n    {\n    }\n\n    public function loginAction()\n    {\n    }\n} \n```\n\n1. getShared() \u3067\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u304c\u751f\u6210\u3055\u308c\u308b\uff08\u3053\u3053\u3067\u306f wasFresh \u306f true\uff09\n2. beforeExecuteRoute() \u3067 forward() \u3057\u3066\u3044\u308b\u305f\u3081\u30c7\u30a3\u30b9\u30d1\u30c3\u30c1\u30eb\u30fc\u30d7\u306e\u6700\u521d\u306b\u623b\u308b\n3. getShared() \u3067\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u304c\u53d6\u5f97\u3055\u308c\u308b\uff08\u3053\u3053\u3067\u306f wasFresh \u306f false\uff09\n4. wasFresh \u306f false \u3068\u306a\u308b\u305f\u3081 initialize() \u306f\u30b9\u30eb\u30fc\n5. \u30a2\u30af\u30b7\u30e7\u30f3\u30e1\u30bd\u30c3\u30c9\u304c\u547c\u3070\u308c\u308b\n\n\u3068\u306a\u308a\u307e\u3059\uff0e\n\n\u306a\u308b\u307b\u3069 initialize() \u304c\u547c\u3070\u308c\u306a\u3044\u3067\u3059\u306d\uff0e\u3053\u308c\u306f\u30d0\u30b0\u306a\u306e\u304b\u3088\u304f\u308f\u304b\u3089\u306a\u3044\u3067\u3059\u3051\u3069\u4ed6\u306e\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u306b forward \u3057\u305f\u5834\u5408\u306f initialize() \u547c\u3070\u308c\u308b\u306e\u306b\u540c\u3058\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\n\u306b fowrward() \u3059\u308b\u3068\u547c\u3070\u308c\u306a\u3044\u306e\u306f\u3061\u3087\u3063\u3068\u610f\u5473\u304c\u308f\u304b\u3089\u306a\u3044\uff0e\n\n###  \u5bfe\u51e6\u3069\u3046\u3059\u308c\u3070\uff1f\n\ninitialize() \u306f\u305f\u3076\u3093\u751f\u6210\u3055\u308c\u3066\u4e00\u56de\u3060\u3051\u547c\u3070\u308c\u308b\u60f3\u5b9a\u306e\u306f\u305a\u306a\u306e\u3067\u3058\u3083\u3042 \u4ee3\u308f\u308a\u306b\u30b3\u30f3\u30b9\u30c8\u30e9\u30af\u30bf\u306b\u66f8\u3044\u3066\u3057\u307e\u3048\u3070\u3044\u3044\u306e\u3067\u306f\uff1f\uff1f\uff1f\n\nhttp://docs.phalconphp.com/ja/latest/api/Phalcon_Mvc_Controller.html#methods\n\n> final public __construct ()\n\nfinal \u6307\u5b9a\u306a\u3093\u3067\u3059\u306d\uff0e\u30aa\u30fc\u30d0\u30fc\u30e9\u30a4\u30c9\u3067\u304d\u307e\u305b\u3093\uff0e\u30c0\u30e1\u3067\u3057\u305f\uff0e\n\n\u308f\u308a\u3068\u3069\u3046\u3057\u3088\u3046\u3082\u306a\u3044\u306e\u3067 \u81ea\u5206\u3067 `$isFresh` \u4f5c\u3063\u3066\u5bfe\u5fdc\u3059\u308b\u3068\u304b\u8907\u6570\u56de\u547c\u3070\u308c\u3066\u3082\u5927\u4e08\u592b\u306a\u3088\u3046\u306a\u30b3\u30fc\u30c9\u306b\u3057\u3066 beforeExexuteRoute() \u306b\u5165\u308c\u308b\u3068\u304b\u3059\u308b\u3057\u304b\u306a\u3044\u3067\u3059\u304b\u306d\uff0e\n\n## 404 \u30da\u30fc\u30b8\u3092\u5b9f\u88c5\u3057\u305f\u6642\u306b\u3082\u8d77\u304d\u305d\u3046\n\n\u3053\u3053\u3067\u307e\u3060 dispatch() \u306e\u30b3\u30fc\u30c9\u3092\u307f\u308b\u3068\uff0c getShared() \u3067\u547c\u3073\u51fa\u3057\u305f\u5f8c\u304b\u3089 initialize() \u304c\u547c\u3070\u308c\u308b\u307e\u3067\u306e\u9593\u306b continue \u304c\u884c\u308f\u308c\u308b\u5834\u5408\u3082\u3042\u308a\u307e\u3059\uff0e\n\u30b3\u30fc\u30c9\u90e8\u5206\u3092\u78ba\u8a8d\u3059\u308b\u3068\u4e0b\u8a18\u90e8\u5206\u3082\u8a72\u5f53\u3057\u307e\u3059\uff0e\n\nhttps://github.com/phalcon/cphalcon/blob/phalcon-v1.3.4/ext/dispatcher.c#L792\n\n```\u64ec\u4f3c\u30b3\u30fc\u30c9\n    if (method_exist($handler, $actionName) {\n      if (fireEvent(\"dispatch:beforeNotFoundAction\") === false) continue;\n      throw new Phalcon\\Dispatcher\\Exception( \"Action '\", action_name, \"' was not found on handler '\", EXCEPTION_ACTION_NOT_FOUND);\n    }\n```\n\n\u64ec\u4f3c\u30b3\u30fc\u30c9\u3067\u306f throw \u3068\u8868\u3057\u3066\u3057\u3066\u307e\u3059\u304c\u672c\u5f53\u306f Phalcon\\Dispatcher#_throwdispatchexception() \u304c\u547c\u3070\u308c\u3066\u8fd4\u308a\u5024\u304c false \u306e\u5834\u5408 continue \u3057\u3066\u307e\u3059\uff0e\n\n\u3042\u308a\u5f97\u308b\u30d1\u30bf\u30fc\u30f3\u306f\u4f8b\u3048\u3070 ErrorController \u30a8\u30e9\u30fc\u30da\u30fc\u30b8\u3092\u96c6\u3081\u305f\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u3092\u4f5c\u3063\u305f\u5834\u5408\u306b\u5b58\u5728\u3057\u306a\u3044\u30a2\u30af\u30b7\u30e7\u30f3\u306e\u30da\u30fc\u30b8\u3092\u958b\u3053\u3046\u3068\u3057\u3066\u4f8b\u5916\u3092\u6295\u3052\u308b\u30d1\u30bf\u30fc\u30f3\u3067\u3059\uff0e\n\u300c\u30a2\u30af\u30b7\u30e7\u30f3\u304c\u306a\u304b\u3063\u305f\u3089\u30a8\u30e9\u30fc\u30da\u30fc\u30b8\u306b\u98db\u3070\u3059\u300d\u3068\u3044\u3046\u611f\u3058\u3067\u3059\u306d\uff0e\n\n[\u5148\u65e5\u306e\u8a18\u4e8b](http://qiita.com/nise_nabe/items/6907792756db2c1b7eb5) \u306b\u3082\u66f8\u3044\u305f 404 \u30da\u30fc\u30b8\u3078\u306e\u9077\u79fb error \u30a2\u30af\u30b7\u30e7\u30f3\u306b\u98db\u3093\u3067\u307e\u3059\u306d\uff0e\n\u3053\u306e EXCEPTION_ACTION_NOT_FOUND \u304c error/hoge \u306e\u3088\u3046\u306a\u9069\u5f53\u306a\u30da\u30fc\u30b8\u306b\u30a2\u30af\u30bb\u30b9\u3057\u305f\u6642\u306b\u3082\u6295\u3052\u3089\u308c\u307e\u3059\uff0e\n\u3059\u308b\u3068 ErrorController \u306e initialize() \u306f\u5b9f\u884c\u3055\u308c\u307e\u305b\u3093\uff0e\n\n> php - How to setup a 404 page in Phalcon - Stack Overflow\n> https://stackoverflow.com/questions/14071261/how-to-setup-a-404-page-in-phalcon\n\n```\n       $evManager->attach(\n            \"dispatch:beforeException\",\n            function($event, $dispatcher, $exception)\n            {\n                switch ($exception->getCode()) {\n                    case PhDispatcher::EXCEPTION_HANDLER_NOT_FOUND:\n                    case PhDispatcher::EXCEPTION_ACTION_NOT_FOUND:\n                        $dispatcher->forward(\n                            array(\n                                'controller' => 'error',\n                                'action'     => 'show404',\n                            )\n                        );\n                        return false;\n                }\n            }\n        );\n```\n\n\u3046\u30fc\u3093\uff0e\u3069\u3046\u3059\u308b\u304b\uff0e\n\n## \u65e2\u77e5\u306e\u30d0\u30b0\u304b\n\n\u4e0b\u8a18\u4e8c\u3064\u306e\u30c1\u30b1\u30c3\u30c8\u304c\u3042\u308a\u307e\u3059\uff0e\n\n> Dispatcher forward doesn't work from initialize in Controller (1.2.3) \u00b7 Issue #1431 \u00b7 phalcon/cphalcon\n> https://github.com/phalcon/cphalcon/issues/1431\n\n\uff12\u3064\u76ee\n\n> [BUG] Controller method beforeExecuteRoute and Initialize problem \u00b7 Issue #2413 \u00b7 phalcon/cphalcon\n> https://github.com/phalcon/cphalcon/issues/2413\n\n\u307e\u3042\u4f3c\u305f\u3088\u3046\u306a\u554f\u984c\u304c\u5831\u544a\u3055\u308c\u3066\u306f\u3044\u307e\u3059\u304c\u89e3\u6c7a\u306f\u3057\u3066\u306a\u3044\u3088\u3046\u3067\u3059\uff0e\n\u307e\u3042\u8ae6\u3081\u307e\u3057\u3087\u3046\uff0e\n\n# \u304a\u308f\u308a\u306b\n\n\u3053\u3053\u3067\u306f Phalcon \u306e DI \u3068 Dipsatcher \u306e\u52d5\u304d\u304c\u7d44\u307f\u5408\u308f\u3055\u3063\u3066\u767a\u751f\u3057\u305f\u30d0\u30b0\u306b\u3064\u3044\u3066\u66f8\u3044\u3066\u307f\u307e\u3057\u305f\uff0e\n\u3053\u3046\u3044\u3046\u53d6\u3063\u639b\u304b\u308a\u3092\u5f97\u3066\u4e2d\u8eab\u3092\u8aad\u307f\u8fbc\u3080\u306e\u306f\u3044\u3044\u3093\u3058\u3083\u306a\u3044\u3067\u3057\u3087\u3046\u304b\uff01\n\n2.0 \u3067\u540c\u3058\u30d0\u30b0\u304c\u6709\u308b\u304b\u3069\u3046\u304b\u306f\u78ba\u8a8d\u3057\u3066\u306a\u3044\u3067\u3059\uff0e\n\u81ea\u5206\u306f\u30b3\u30f3\u30c8\u30ea\u30d3\u30e5\u30fc\u30c8\u3059\u308b\u6c17\u3042\u3093\u307e\u308a\u306a\u3044\u3067\u3059\u304c\uff0c\u3060\u308c\u304b\u3044\u3044\u611f\u3058\u306b\u3067\u304d\u308b\u306a\u3089\u76f4\u3057\u305f\u308a\u5831\u544a\u3057\u3066\u307f\u305f\u3089\u3044\u3044\u3093\u3058\u3083\u306a\u3044\u304b\u306a\uff01 \n\u4ee5\u4e0a\u3067\u3059\uff0e\n", "tags": ["Phalcon1.3.4"]}