{"context": "activeadmin\u306eWiki\u306b\u66f8\u3044\u3066\u3042\u308b\u901a\u308a\u3060\u3068\u3001\u52d5\u4f5c\u3057\u306a\u304b\u3063\u305f\u305f\u3081\u3001Google\u8a8d\u8a3c\u3092\u5c0e\u5165\u3059\u308b\u624b\u9806\u3092\u307e\u3068\u3081\u3066\u307f\u307e\u3057\u305f\u3002\u5229\u7528\u3057\u305fgem\u306f\u3001omniauth-google-oauth2\u3068\u306a\u308a\u307e\u3059\u3002\n\n\u74b0\u5883\n\nRails 4.2.6\nactiveadmin 1.0.0.pre4\ndevise 4.2.0\n\n\n\u5c0e\u5165\u624b\u9806\n\u203b rails new..activeadmin\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u624b\u9806\u7b49\u306f\u7701\u7565\u3057\u307e\u3059\u3002\n\n1. omniauth-google-oauth2 \u3092Gemfile\u306b\u8ffd\u52a0\u3057\u3066 bundle\n\n\n2. AdminUser\u306b :omniauthable \u30e2\u30b8\u30e5\u30fc\u30eb\u3092\u6709\u52b9\u5316\n\napp/models/admin_user.rb\nclass AdminUser < ActiveRecord::Base\n  # \u30d1\u30b9\u30ef\u30fc\u30c9\u3067\u306e\u8a8d\u8a3c\u3092\u5ec3\u6b62\u3059\u308b\u305f\u3081 :recoverable, :rememberable \u306f\u524a\u9664\uff08\u5171\u7528\u3055\u305b\u308b\u5834\u5408\u306f\u6b8b\u3059\uff09\n  devise :database_authenticatable, :omniauthable, :trackable, :validatable\nend\n\n\n\n3. devise \u306b omniauth \u306e\u8a2d\u5b9a\u3092\u8ffd\u52a0\n\nconfig/initializers/devise.rb\nconfig.omniauth :google_oauth2, ENV['GOOGLE_CLIENT_ID'], ENV['GOOGLE_CLIENT_SECRET'], scope: \"email\"\n\n\n\n4. dotenv-rails \u3092Gemfile\u306b\u8ffd\u52a0\u3057\u3066 bundle\n\n\nGemfile\ngem 'dotenv-rails', require: 'dotenv/rails-now'\n\n\n\n5. .env \u306b \u5fc5\u8981\u306a\u74b0\u5883\u5909\u6570\u3092\u8a2d\u5b9a\n\n.env\nGOOGLE_CLIENT_ID=**********YOUR_CLIENT_ID**********\nGOOGLE_CLIENT_SECRET=**********GOOGLE_CLIENT_SECRET**********\n\n\n\u30af\u30e9\u30a4\u30a2\u30f3\u30c8ID\u3068\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u30b7\u30fc\u30af\u30ec\u30c3\u30c8\u306e\u8a2d\u5b9a\u624b\u9806\u306f\u3001\u3053\u3061\u3089\u306b\u66f8\u3044\u3066\u3042\u308b\u901a\u308a\u3067\u3059\u3002\n\u305f\u3060\u3057\u3001\u30ea\u30c0\u30a4\u30ec\u30af\u30c8URI\u306f http://127.0.0.1:3000/admin/auth/google_oauth2/callback\u306b\u8a2d\u5b9a\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\uff08localhost\u3060\u3068\u6b63\u3057\u304f\u30ea\u30c0\u30a4\u30ec\u30af\u30c8\u3055\u308c\u307e\u305b\u3093\u306e\u3067\u3054\u6ce8\u610f\u304f\u3060\u3055\u3044\uff09\n\n6. \u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u306e\u4f5c\u6210\u3068\u5b9f\u884c\n$ bundle exec rails g migration change_columns_in_admin_users\n\n\ndb/migrate/YYYYMMDDHHMMSS_change_columns_in_admin_users.rb\nclass ChangeColumnsInAdminUsers < ActiveRecord::Migration\n  def change\n    add_column :admin_users, :provider, :string\n    add_column :admin_users, :uid,      :string\n\n    add_index :admin_users, [:provider, :uid], unique: true\n\n    # \u30d1\u30b9\u30ef\u30fc\u30c9\u8a8d\u8a3c\u3092\u5ec3\u6b62\u3059\u308b\u305f\u3081\u3001\u4ee5\u4e0b\u306f\u524a\u9664\uff08\u5171\u5b58\u3055\u305b\u308b\u5834\u5408\u306f\u6b8b\u3059\uff09\n    remove_column :admin_users, :reset_password_token,   :string\n    remove_column :admin_users, :reset_password_sent_at, :datetime\n    remove_column :admin_users, :remember_sent_at,       :datetime\n  end\nend\n\n\n$ bundle exec rake db:migrate\n\n\n7. AdminUser\u306bAuthHash\u306b\u5bfe\u5fdc\u3059\u308b\u30e1\u30bd\u30c3\u30c9\u3092\u8ffd\u52a0\n\napp/models/admin_user.rb\nclass AdminUser < ActiveRecord::Base\n\n  devise :database_authenticatable, :omniauthable, :trackable, :validatable\n\n  with_options presence: true do\n    validates :email # whitelist\u3067\u30d5\u30a3\u30eb\u30bf\u3059\u308b\u5834\u5408\u3001inclusion\u3084format\u306evalidation\u3092\u8ffd\u52a0\n    validates :provider\n    validates :uid, uniqueness: { scope: :provider }\n  end\n\n  # \u3053\u3061\u3089\u306f\u3001\u307b\u307c\u516c\u5f0fwiki\u901a\u308a\u306b\u66f8\u3044\u3066\u3044\u308b\u304c\u3001\u30d1\u30b9\u30ef\u30fc\u30c9\u8a8d\u8a3c\u3057\u306a\u3044\u306a\u3089\u3001\u5e38\u6642false\u3067\u3088\u3044\n  # Devise override to ignore the password requirement if the user is authenticated\n  def password_required?\n    return false if provider.present?\n    super\n  end\n\n  class << self\n    def from_omniauth(auth)\n      admin_user = where(email: auth.info.email).first || where(auth.slice(:provider, :uid).to_h).first || new\n      admin_user.tap { |this| this.update_attributes(provider: auth.provider, uid: auth.uid, email: auth.info.email) }\n    end\n  end\nend\n\n\n\n8. \u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u3092\u53d7\u3051\u308b\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u306e\u5b9f\u88c5\n\napp/controllers/admin_users/omniauth_callbacks_controller.rb\nclass AdminUsers::OmniauthCallbacksController < Devise::OmniauthCallbacksController\n\n  def all\n    admin_user = AdminUser.from_omniauth(auth_hash)\n\n    if admin_user.persisted?\n      flash.notice = \"Signed in!\"\n      sign_in_and_redirect admin_user\n    else\n      flash.notice = \"We couldn't sign you in because: \" + admin_user.errors.full_messages.to_sentence\n      redirect_to new_admin_user_session_url\n    end\n  end\n\n  # provider\u3092\u8ffd\u52a0\u3057\u305f\u3089\u3001alias\u3082\u8ffd\u52a0\n  # \u8ffd\u52a0\u4e88\u5b9a\u306a\u3044\u306a\u3089\u3001#all => #google_oauth2 \u306b\u5909\u66f4\u3059\u308b\u611f\u3058\n  alias_method :google_oauth2, :all\n\n  private\n\n  def auth_hash\n    request.env[\"omniauth.auth\"]\n  end\nend\n\n\n\n9. \u30eb\u30fc\u30c6\u30a3\u30f3\u30b0\u3067omniauth_callbacks\u306e\u969b\u306b\u3001\u5229\u7528\u3059\u308b\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u3092assign\n\nconfig/routes.rb\nRails.application.routes.draw do\n  devise_config = ActiveAdmin::Devise.config\n  devise_config[:controllers][:omniauth_callbacks] = 'admin_users/omniauth_callbacks'\n  devise_for :admin_users, devise_config\n  ActiveAdmin.routes(self)\n  #...\n\n\n\n10. \u30ed\u30b0\u30a4\u30f3\u30d5\u30a9\u30fc\u30e0\u304b\u3089\u30d1\u30b9\u30ef\u30fc\u30c9\u30d5\u30a9\u30fc\u30e0\u3092\u64a4\u53bb\n\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u306f\u3001activeadmin\u306e\u5143\u30d5\u30a1\u30a4\u30eb\u304b\u3089\u62dd\u501f\n\napp/views/active_admin/devise/sessions/new.html.erb\n<div id=\"login\">\n  <h2><%= render_or_call_method_or_proc_on(self, active_admin_application.site_title) %> <%= title t('active_admin.devise.login.title') %></h2>\n  <div style=\"text-align: center\">\n    <%- if devise_mapping.omniauthable? %>\n      <%- resource_class.omniauth_providers.each do |provider| %>\n        <%= button_to(\n              t('active_admin.devise.links.sign_in_with_omniauth_provider', provider: provider.to_s.titleize),\n              omniauth_authorize_path(resource_name, provider)) %><br />\n      <% end -%>\n    <% end -%>\n  </div>\n</div>\n\n\n \u304a\u3064\u304b\u308c\u3055\u307e\u3067\u3057\u305f \n\u3053\u308c\u3067\u3001Google\u30a2\u30ab\u30a6\u30f3\u30c8\u3067\u8a8d\u8a3c\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\n\n\u8a8d\u8a3c\u524d\n\n\n\n\u8a8d\u8a3c\u5f8c\n\n\u306a\u304a\u3001\u4ee5\u4e0b\u304c\u5f53\u8a18\u4e8b\u306e\u30b5\u30f3\u30d7\u30eb\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3068\u306a\u308a\u307e\u3059\u3002\n\nyhirano55/activeadmin_omniauth_sample\n\n\n\u53c2\u8003\n\nLog in through OAuth providers \u00b7 activeadmin/activeadmin Wiki\nSalesforce OAuth2 authentication with Active Admin\n\n[activeadmin](https://github.com/activeadmin/activeadmin)\u306e[Wiki](https://github.com/activeadmin/activeadmin/wiki/Log-in-through-OAuth-providers)\u306b\u66f8\u3044\u3066\u3042\u308b\u901a\u308a\u3060\u3068\u3001\u52d5\u4f5c\u3057\u306a\u304b\u3063\u305f\u305f\u3081\u3001**Google\u8a8d\u8a3c\u3092\u5c0e\u5165\u3059\u308b\u624b\u9806**\u3092\u307e\u3068\u3081\u3066\u307f\u307e\u3057\u305f\u3002\u5229\u7528\u3057\u305fgem\u306f\u3001[omniauth-google-oauth2](https://github.com/zquestz/omniauth-google-oauth2)\u3068\u306a\u308a\u307e\u3059\u3002\n\n## \u74b0\u5883\n\n- Rails 4.2.6\n- activeadmin 1.0.0.pre4\n- devise 4.2.0\n\n## \u5c0e\u5165\u624b\u9806\n\n\u203b rails new..activeadmin\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u624b\u9806\u7b49\u306f\u7701\u7565\u3057\u307e\u3059\u3002\n\n### 1. `omniauth-google-oauth2` \u3092Gemfile\u306b\u8ffd\u52a0\u3057\u3066 `bundle`\n\n### 2. AdminUser\u306b `:omniauthable` \u30e2\u30b8\u30e5\u30fc\u30eb\u3092\u6709\u52b9\u5316\n\n```rb:app/models/admin_user.rb\nclass AdminUser < ActiveRecord::Base\n  # \u30d1\u30b9\u30ef\u30fc\u30c9\u3067\u306e\u8a8d\u8a3c\u3092\u5ec3\u6b62\u3059\u308b\u305f\u3081 :recoverable, :rememberable \u306f\u524a\u9664\uff08\u5171\u7528\u3055\u305b\u308b\u5834\u5408\u306f\u6b8b\u3059\uff09\n  devise :database_authenticatable, :omniauthable, :trackable, :validatable\nend\n```\n\n### 3. devise \u306b omniauth \u306e\u8a2d\u5b9a\u3092\u8ffd\u52a0\n\n```rb:config/initializers/devise.rb\nconfig.omniauth :google_oauth2, ENV['GOOGLE_CLIENT_ID'], ENV['GOOGLE_CLIENT_SECRET'], scope: \"email\"\n```\n\n### 4. `dotenv-rails` \u3092Gemfile\u306b\u8ffd\u52a0\u3057\u3066 `bundle`\n\n```rb:Gemfile\ngem 'dotenv-rails', require: 'dotenv/rails-now'\n```\n\n### 5. `.env` \u306b \u5fc5\u8981\u306a\u74b0\u5883\u5909\u6570\u3092\u8a2d\u5b9a\n\n```sh:.env\nGOOGLE_CLIENT_ID=**********YOUR_CLIENT_ID**********\nGOOGLE_CLIENT_SECRET=**********GOOGLE_CLIENT_SECRET**********\n```\n\n\u30af\u30e9\u30a4\u30a2\u30f3\u30c8ID\u3068\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u30b7\u30fc\u30af\u30ec\u30c3\u30c8\u306e\u8a2d\u5b9a\u624b\u9806\u306f\u3001[\u3053\u3061\u3089](https://github.com/zquestz/omniauth-google-oauth2#google-api-setup)\u306b\u66f8\u3044\u3066\u3042\u308b\u901a\u308a\u3067\u3059\u3002\n\n\u305f\u3060\u3057\u3001**\u30ea\u30c0\u30a4\u30ec\u30af\u30c8URI\u306f `http://127.0.0.1:3000/admin/auth/google_oauth2/callback`\u306b\u8a2d\u5b9a\u3059\u308b\u5fc5\u8981**\u304c\u3042\u308a\u307e\u3059\uff08`localhost`\u3060\u3068\u6b63\u3057\u304f\u30ea\u30c0\u30a4\u30ec\u30af\u30c8\u3055\u308c\u307e\u305b\u3093\u306e\u3067\u3054\u6ce8\u610f\u304f\u3060\u3055\u3044\uff09\n\n### 6. \u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u306e\u4f5c\u6210\u3068\u5b9f\u884c\n\n```sh\n$ bundle exec rails g migration change_columns_in_admin_users\n```\n\n```rb:db/migrate/YYYYMMDDHHMMSS_change_columns_in_admin_users.rb\nclass ChangeColumnsInAdminUsers < ActiveRecord::Migration\n  def change\n    add_column :admin_users, :provider, :string\n    add_column :admin_users, :uid,      :string\n\n    add_index :admin_users, [:provider, :uid], unique: true\n\n    # \u30d1\u30b9\u30ef\u30fc\u30c9\u8a8d\u8a3c\u3092\u5ec3\u6b62\u3059\u308b\u305f\u3081\u3001\u4ee5\u4e0b\u306f\u524a\u9664\uff08\u5171\u5b58\u3055\u305b\u308b\u5834\u5408\u306f\u6b8b\u3059\uff09\n    remove_column :admin_users, :reset_password_token,   :string\n    remove_column :admin_users, :reset_password_sent_at, :datetime\n    remove_column :admin_users, :remember_sent_at,       :datetime\n  end\nend\n```\n\n```sh\n$ bundle exec rake db:migrate\n```\n\n### 7. AdminUser\u306bAuthHash\u306b\u5bfe\u5fdc\u3059\u308b\u30e1\u30bd\u30c3\u30c9\u3092\u8ffd\u52a0\n\n```rb:app/models/admin_user.rb\nclass AdminUser < ActiveRecord::Base\n\n  devise :database_authenticatable, :omniauthable, :trackable, :validatable\n\n  with_options presence: true do\n    validates :email # whitelist\u3067\u30d5\u30a3\u30eb\u30bf\u3059\u308b\u5834\u5408\u3001inclusion\u3084format\u306evalidation\u3092\u8ffd\u52a0\n    validates :provider\n    validates :uid, uniqueness: { scope: :provider }\n  end\n\n  # \u3053\u3061\u3089\u306f\u3001\u307b\u307c\u516c\u5f0fwiki\u901a\u308a\u306b\u66f8\u3044\u3066\u3044\u308b\u304c\u3001\u30d1\u30b9\u30ef\u30fc\u30c9\u8a8d\u8a3c\u3057\u306a\u3044\u306a\u3089\u3001\u5e38\u6642false\u3067\u3088\u3044\n  # Devise override to ignore the password requirement if the user is authenticated\n  def password_required?\n    return false if provider.present?\n    super\n  end\n\n  class << self\n    def from_omniauth(auth)\n      admin_user = where(email: auth.info.email).first || where(auth.slice(:provider, :uid).to_h).first || new\n      admin_user.tap { |this| this.update_attributes(provider: auth.provider, uid: auth.uid, email: auth.info.email) }\n    end\n  end\nend\n```\n\n### 8. \u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u3092\u53d7\u3051\u308b\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u306e\u5b9f\u88c5\n\n```rb:app/controllers/admin_users/omniauth_callbacks_controller.rb\nclass AdminUsers::OmniauthCallbacksController < Devise::OmniauthCallbacksController\n\n  def all\n    admin_user = AdminUser.from_omniauth(auth_hash)\n\n    if admin_user.persisted?\n      flash.notice = \"Signed in!\"\n      sign_in_and_redirect admin_user\n    else\n      flash.notice = \"We couldn't sign you in because: \" + admin_user.errors.full_messages.to_sentence\n      redirect_to new_admin_user_session_url\n    end\n  end\n\n  # provider\u3092\u8ffd\u52a0\u3057\u305f\u3089\u3001alias\u3082\u8ffd\u52a0\n  # \u8ffd\u52a0\u4e88\u5b9a\u306a\u3044\u306a\u3089\u3001#all => #google_oauth2 \u306b\u5909\u66f4\u3059\u308b\u611f\u3058\n  alias_method :google_oauth2, :all\n\n  private\n\n  def auth_hash\n    request.env[\"omniauth.auth\"]\n  end\nend\n```\n\n### 9. \u30eb\u30fc\u30c6\u30a3\u30f3\u30b0\u3067omniauth_callbacks\u306e\u969b\u306b\u3001\u5229\u7528\u3059\u308b\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u3092assign\n\n```rb:config/routes.rb\nRails.application.routes.draw do\n  devise_config = ActiveAdmin::Devise.config\n  devise_config[:controllers][:omniauth_callbacks] = 'admin_users/omniauth_callbacks'\n  devise_for :admin_users, devise_config\n  ActiveAdmin.routes(self)\n  #...\n```\n\n### 10. \u30ed\u30b0\u30a4\u30f3\u30d5\u30a9\u30fc\u30e0\u304b\u3089\u30d1\u30b9\u30ef\u30fc\u30c9\u30d5\u30a9\u30fc\u30e0\u3092\u64a4\u53bb\n\n\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u306f\u3001activeadmin\u306e[\u5143\u30d5\u30a1\u30a4\u30eb](https://github.com/activeadmin/activeadmin/blob/master/app/views/active_admin/devise/sessions/new.html.erb)\u304b\u3089\u62dd\u501f\n\n```erb:app/views/active_admin/devise/sessions/new.html.erb\n<div id=\"login\">\n  <h2><%= render_or_call_method_or_proc_on(self, active_admin_application.site_title) %> <%= title t('active_admin.devise.login.title') %></h2>\n  <div style=\"text-align: center\">\n    <%- if devise_mapping.omniauthable? %>\n      <%- resource_class.omniauth_providers.each do |provider| %>\n        <%= button_to(\n              t('active_admin.devise.links.sign_in_with_omniauth_provider', provider: provider.to_s.titleize),\n              omniauth_authorize_path(resource_name, provider)) %><br />\n      <% end -%>\n    <% end -%>\n  </div>\n</div>\n```\n\n:older_man: **\u304a\u3064\u304b\u308c\u3055\u307e\u3067\u3057\u305f** :older_man:\n\n\u3053\u308c\u3067\u3001Google\u30a2\u30ab\u30a6\u30f3\u30c8\u3067\u8a8d\u8a3c\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\n\n#### \u8a8d\u8a3c\u524d\n\n![](https://qiita-image-store.s3.amazonaws.com/0/132049/5f433405-be4f-571a-af46-eb72e40d68cc.png)\n\n![](https://qiita-image-store.s3.amazonaws.com/0/132049/4fada40b-8644-2097-a243-2007dedbd9e4.png)\n\n#### \u8a8d\u8a3c\u5f8c\n\n![](https://qiita-image-store.s3.amazonaws.com/0/132049/70b64df0-eeb0-2e2a-b01b-7427ebebebad.png)\n\n\u306a\u304a\u3001\u4ee5\u4e0b\u304c\u5f53\u8a18\u4e8b\u306e\u30b5\u30f3\u30d7\u30eb\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3068\u306a\u308a\u307e\u3059\u3002\n\n- [yhirano55/activeadmin_omniauth_sample](https://github.com/yhirano55/activeadmin_omniauth_sample)\n\n## \u53c2\u8003\n\n- [Log in through OAuth providers \u00b7 activeadmin/activeadmin Wiki](https://github.com/activeadmin/activeadmin/wiki/Log-in-through-OAuth-providers)\n- [Salesforce OAuth2 authentication with Active Admin](http://ejholmes.io/2012/04/08/active-admin-with-omniauth.html)\n", "tags": ["activeadmin", "Rails4", "devise", "OmniAuth"]}