{"context": " More than 1 year has passed since last update.\u3053\u306e\u8a18\u4e8b\u3068\u3060\u3044\u305f\u3044\u4e00\u7dd2\u3067\u3059\u3002\n\n\u56fd\u571f\u4ea4\u901a\u7701\u306e\u30c7\u30fc\u30bf\u3092\u4f7f\u3063\u3066\u3001\u7def\u5ea6\u7d4c\u5ea6\u304b\u3089\u5e02\u533a\u753a\u6751\u307e\u3067\u3092\u53d6\u308a\u51fa\u3059\n\n\u3053\u3053\u3067\u306f\u3001\u4f4f\u6240\u30b3\u30fc\u30c9\u304b\u3089\u305d\u306e\u5e02\u533a\u753a\u6751\u306e\u5f62\u72b6\u3092\u63cf\u3044\u3066\u307f\u307e\u3059\u3002\u6d41\u308c\u3068\u3057\u3066\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\n\n\n\u56fd\u571f\u6570\u5024\u60c5\u5831\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u30b5\u30fc\u30d3\u30b9\u304b\u3089\u90fd\u9053\u5e9c\u770c\u3054\u3068\u306eZIP\u30d5\u30a1\u30a4\u30eb\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\nZIP\u3092\u5c55\u958b\u3057\u3001Shape\u5f62\u5f0f\u306e\u30c7\u30fc\u30bf\u3092PostGIS\u306b\u767b\u9332\nPostGIS\u3092\u4f7f\u3063\u3066\u5f62\u72b6\u30c7\u30fc\u30bf\u3092\u5e02\u533a\u753a\u6751\u3054\u3068\u306b\u7d50\u5408\nGeoJSON\u3067\u51fa\u529b\u3057\u3066\u63cf\u753b\n\n\u307e\u305a\u306f\u5e73\u621025\u5e74\u5ea6\u306e\u30c7\u30fc\u30bf\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u307e\u3059\u3002\u5e73\u621026\u5e74\u5ea6\u306e\u30c7\u30fc\u30bf\u304c\u516c\u958b\u3055\u308c\u305f\u3089\u305d\u3061\u3089\u3092\u4f7f\u3063\u305f\u65b9\u304c\u826f\u3044\u3067\u3057\u3087\u3046\u3002\u30af\u30ea\u30c3\u30af\u3092\u7e70\u308a\u8fd4\u3059\u3060\u3051\u306e\u5358\u8abf\u4f5c\u696d\u306a\u306e\u3067\u3001\u6642\u9593\u304c\u3042\u308b\u3068\u304d\u306b\u5b9f\u65bd\u3057\u3066\u304a\u304d\u307e\u3059\u300247\u90fd\u9053\u5e9c\u770c\u306eZIP\u30d5\u30a1\u30a4\u30eb\u3092\u3001\u3069\u3053\u304b\u9069\u5f53\u306a\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306b\u307e\u3068\u3081\u3066\u4fdd\u7ba1\u3057\u307e\u3059\u3002\n\nEC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u8d77\u52d5\nAWS \u306e EC2 \u3067\u4f5c\u696d\u3057\u307e\u3059\u3002\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u30a4\u30e1\u30fc\u30b8ID\u306f Amazon Linux AMI \u306e\u30da\u30fc\u30b8\u306b\u8a18\u8f09\u3055\u308c\u3066\u3044\u307e\u3059\u3002\u305d\u306e\u6642\u306e\u4e00\u756a\u65b0\u3057\u3044\u30bf\u30a4\u30d7\u3092\u4f7f\u3046\u3068\u4fbf\u5229\u306a\u3053\u3068\u306f\u591a\u3044\u3067\u3059\u304c\u3001\u30e9\u30a4\u30d6\u30e9\u30ea\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u4f9d\u5b58\u306b\u60a9\u3080\u5834\u5408\u306f\u3001\u3061\u3087\u3063\u3068\u53e4\u3044\u30bf\u30a4\u30d7\u3092\u8a66\u3057\u3066\u307f\u307e\u3057\u3087\u3046\u3002--user-data \u3092\u4f7f\u3063\u3066\u81ea\u52d5\u30a2\u30c3\u30d7\u30c7\u30fc\u30c8\u3092\u6b62\u3081\u308b\u65b9\u6cd5\u306f\u4e0b\u8a18\u306e\u8a18\u4e8b\u304c\u53c2\u8003\u306b\u306a\u308a\u307e\u3059\u3002\n\nAmazon Linux AMI 2014.03 Released! \u65e9\u901f\u30cf\u30de\u3063\u305f\u3053\u3068 (Perl\u30fbglibc\u7de8)\n\nPostGIS \u3092 yum \u3067\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u5834\u5408\u3001EPEL \u306e gdal-libs \u306b\u4f9d\u5b58\u3057\u307e\u3059\u3002\n\u3057\u304b\u3057\u30012014.03 \u306e\u30ec\u30dd\u30b8\u30c8\u30ea\u3060\u3068 EPEL \u306e gdal-libs \u304c\u4f9d\u5b58\u3059\u308b poppler \u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u304c\u5408\u3044\u307e\u305b\u3093\u3002 gdal-libs \u306f poppler-0.12 \u306b\u4f9d\u5b58\u3057\u307e\u3059\u304c\u3001\u6700\u65b0\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306b\u306f poppler-0.22.5 \u304c\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3055\u308c\u3066\u3044\u307e\u3059\u3002\u3072\u3068\u3064\u53e4\u3044 2013.09 \u306f poppler-0.12.4 \u304c\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3055\u308c\u3066\u3044\u307e\u3059\u306e\u3067\u3001\u30bd\u30fc\u30b9\u30b3\u30fc\u30c9\u304b\u3089\u30d3\u30eb\u30c9\u3059\u308b\u306e\u304c\u7169\u96d1\u306a\u5834\u5408\u306f\u3053\u3061\u3089\u3092\u4f7f\u3046\u306e\u304c\u826f\u3044\u3067\u3057\u3087\u3046\u3002\n\u3068\u3044\u3046\u3053\u3068\u3067\u3001\u4ee5\u4e0b\u306e\u69cb\u6210\u3067 awscli \u306e\u30b3\u30de\u30f3\u30c9\u30e9\u30a4\u30f3\u30c4\u30fc\u30eb\u3092\u4f7f\u3063\u3066 EC2 \u3092\u8d77\u52d5\u3057\u307e\u3059\u3002\u30d1\u30c3\u30b1\u30fc\u30b8\u30ec\u30dd\u30b8\u30c8\u30ea\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u3092\u56fa\u5b9a\u3057\u3066\u304a\u304d\u305f\u3044\u306e\u3067\u3001--user-data \u3067\u8d77\u52d5\u6642\u306b\u81ea\u52d5\u30a2\u30c3\u30d7\u30b0\u30ec\u30fc\u30c9\u3057\u306a\u3044\u3088\u3046\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\n\n\n\u7a2e\u5225\n\u5185\u5bb9\n\n\n\n\nAMI\n2013.09 \u306e 64bit\n\n\n\u30ea\u30fc\u30b8\u30e7\u30f3\n\u30a2\u30b8\u30a2\u30d1\u30b7\u30d5\u30a3\u30c3\u30af\u6771\u4eac\n\n\n\u30a4\u30e1\u30fc\u30b8ID\nami-3561fe34\n\n\n\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u30bf\u30a4\u30d7\nt1.micro\n\n\nSSH\u9375\naws-tokyo-sandbox\n\n\n\u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u30b0\u30eb\u30fc\u30d7\nSSHEnabledGroup\n\n\n\n\nEC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u8d77\u52d5\naws ec2 run-instances \\\n    --image-id ami-3561fe34 \\\n    --instance-type t1.micro \\\n    --count 1 \\\n    --key-name ec2-tokyo-sandbox \\\n    --security-groups SSHEnabledGroup \\\n    --user-data `cat << EOF | base64\n#cloud-config\nrepo_upgrade: none\nEOF`\n\n\nSSH \u3067\u30ed\u30b0\u30a4\u30f3\u3057\u305f\u3089\u30ec\u30dd\u30b8\u30c8\u30ea\u306e\u8a2d\u5b9a\u3092\u5909\u66f4\u3057\u307e\u3059\u3002\n\n\u30ec\u30dd\u30b8\u30c8\u30ea\u8a2d\u5b9a\ncurl -O http://yum.postgresql.org/9.3/redhat/rhel-6-x86_64/pgdg-redhat93-9.3-1.noarch.rpm\nsudo rpm -ivh pgdg-redhat93-9.3-1.noarch.rpm\nsudo vim /etc/yum.conf  # releasever=latest \u3092\u30b3\u30e1\u30f3\u30c8\u30a2\u30a6\u30c8\nsudo vim /etc/yum.repos.d/pgdg-93-redhat.repo  # $releasever \u21d2 latest\n\n\n\u6b21\u306b\u3001PostGIS \u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u307e\u3059\u3002\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u304c\u6210\u529f\u3059\u308b\u3068 shp2pgsql \u30b3\u30de\u30f3\u30c9\u304c\u4f7f\u3048\u308b\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u308b\u306f\u305a\u3067\u3059\u3002\n\nPostGIS\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\nsudo yum install postgresql93-server postgresql93-contrib -y\nsudo yum install --enablerepo epel postgis2_93 postgis2_93_devel postgis2_93_utils -y\n\n\nPostGIS \u304c\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3067\u304d\u305f\u3089 PostgreSQL \u3092\u8d77\u52d5\u3057\u307e\u3059\u3002\n\u4f5c\u696d\u3092\u7c21\u5358\u306b\u9032\u3081\u308b\u305f\u3081\u306b\u3001\u30a2\u30af\u30bb\u30b9\u6a29\u9650\u3092\u5909\u66f4\u3057\u3066\u304a\u304d\u307e\u3057\u3087\u3046\u3002SSH\u3067\u30ed\u30b0\u30a4\u30f3\u3057\u3066\u3044\u308b\u5834\u5408\u306f\u30e6\u30fc\u30b6\u30fc\u540d\u3092\u6307\u5b9a\u3059\u308b\u3060\u3051\u306b\u3057\u307e\u3059\u3002\n\n\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u8a2d\u5b9a\nsudo service postgresql-9.3 initdb\nsudo service postgresql-9.3 start\nsudo su - postgres\nvi /var/lib/pgsql/9.3/data/pg_hba.conf    # \u4e0b\u8a18\u53c2\u7167\n\n\n\n/var/lib/pgsql/9.3/data/pg_hba.conf\nlocal        all        all        trust\n\n\n\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092\u5909\u66f4\u3057\u305f\u3089 PostgreSQL \u3092\u518d\u8d77\u52d5\u3057\u307e\u3059\u3002\nsudo service postgresql-9.3 restart\n\n\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u3092\u4f5c\u6210\u3057\u3001PostGIS \u62e1\u5f35\u3092\u6709\u52b9\u306b\u3057\u307e\u3059\u3002\n\n\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u4f5c\u6210\ncreatedb -U postgres geo\ncat << EOF | psql -U postgres -d geo\nCREATE EXTENSION postgis;\nCREATE EXTENSION postgis_topology;\nCREATE EXTENSION fuzzystrmatch;\nCREATE EXTENSION postgis_tiger_geocoder;\nSELECT postgis_full_version();\nEOF\n\n\n\u3053\u308c\u3067\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306e\u8a2d\u5b9a\u304c\u3067\u304d\u307e\u3057\u305f\u3002\n\nZIP\u30d5\u30a1\u30a4\u30eb\u306e\u4e2d\u8eab\u3092PostGIS\u306b\u767b\u9332\n\u56fd\u571f\u6570\u5024\u60c5\u5831\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u30b5\u30fc\u30d3\u30b9\u304b\u3089\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u305fZIP\u30d5\u30a1\u30a4\u30eb\u3092EC2\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306b\u8ee2\u9001\u3057\u307e\u3059\u3002\u8ee2\u9001\u3067\u304d\u305f\u3089\u3001ZIP\u30d5\u30a1\u30a4\u30eb\u3092\u5c55\u958b\u3057\u3066 shp2pgsql \u3067SQL\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3057\u3001PostGIS\u306b\u767b\u9332\u3057\u307e\u3059\u3002\nfor f in N03-*.zip\ndo\n    unzip -d ${f%.zip} $f\ndone\n\nfor f in N03-*/*.shp\ndo\n    t=`basename $f`\n    sql=${t%.shp}.sql\n    shp2pgsql -W \"Shift_JIS\" $f | psql -U postgres -d geo\ndone\n\n\u30d5\u30a1\u30a4\u30eb\u540d\u306b\u5fdc\u3058\u305f\u30c6\u30fc\u30d6\u30eb\u304c\u751f\u6210\u3055\u308c\u307e\u3059\u306e\u3067\u300147\u500b\u306e\u30c6\u30fc\u30d6\u30eb\u304c\u751f\u6210\u3055\u308c\u307e\u3059\u3002\n\u30c7\u30fc\u30bf\u3092\u898b\u3066\u307f\u308b\u3068\u3001\u3044\u304f\u3064\u304b\u306e\u90fd\u9053\u5e9c\u770c\u306e\u30c7\u30fc\u30bf\u306b\u306f\u6ce8\u610f\u304c\u5fc5\u8981\u3067\u3042\u308b\u3053\u3068\u304c\u5206\u304b\u308a\u307e\u3059\u3002 (\u5317\u6d77\u9053\u5730\u65b9\u306e\u652f\u5e81\u30fb\u5730\u65b9\u4e8b\u52d9\u6240\u4e00\u89a7 - Wikipedia)\n\n\u5317\u6d77\u9053\u306e\u652f\u5e81\u3068\u632f\u8208\u5c40\u304c\u6df7\u5728\u3057\u3066\u3044\u308b\nSELECT distinct n03_002\nFROM \"n03-13_01_130401\"\nWHERE n03_002 IS NOT NULL\nORDER BY n03_002;\n\n    n03_002\n----------------\n \u4e0a\u5ddd\u652f\u5e81\n \u5341\u52dd\u652f\u5e81\n \u5b97\u8c37\u652f\u5e81\n \u5f8c\u5fd7\u652f\u5e81\n \u65e5\u9ad8\u652f\u5e81\n \u6839\u5ba4\u632f\u8208\u5c40\n \u6839\u5ba4\u652f\u5e81\n \u6a9c\u5c71\u652f\u5e81\n \u6e21\u5cf6\u652f\u5e81\n \u7559\u840c\u652f\u5e81\n \u77f3\u72e9\u652f\u5e81\n \u7a7a\u77e5\u652f\u5e81\n \u7db2\u8d70\u652f\u5e81\n \u80c6\u632f\u652f\u5e81\n \u91e7\u8def\u652f\u5e81\n \u91e7\u8def\u7dcf\u5408\u632f\u8208\u5c40\n(16 rows)\n\n\n\n\u9999\u5ddd\u770c\u306e\u90e1\u30fb\u653f\u4ee4\u5e02\u540d\u304c\u9999\u5ddd\u770c\u306e\u30ec\u30b3\u30fc\u30c9\u304c\u3042\u308b\n\\x\n\nSELECT n03_001, n03_002, n03_003, n03_004, n03_007\nFROM \"n03-13_37_130401\"\nWHERE n03_001 = n03_003;\n\n-[ RECORD 1 ]---\nn03_001 | \u9999\u5ddd\u770c\nn03_002 |\nn03_003 | \u9999\u5ddd\u770c\nn03_004 | \u4e38\u4e80\u5e02\nn03_007 | 37202\n\n\n\n\u6240\u5c5e\u672a\u5b9a\u5730\u306e\u78ba\u8a8d\nSELECT n03_001, n03_002, n03_003, n03_004, n03_007 FROM \"n03-13_13_130401\" WHERE n03_007 IS NULL;\n\n-- \u7d50\u679c\u306f\u7701\u7565\n\n\n\u305f\u3068\u3048\u3070\u3001\u4f4f\u6240\u30b3\u30fc\u30c9\u3067\u96c6\u7d04\u3057\u305f\u3068\u304d\u306b\u540d\u79f0\u304c\u4e0d\u4e00\u81f4\u306b\u306a\u308b\u30ec\u30b3\u30fc\u30c9\u3092\u62bd\u51fa\u3059\u308b\u3068\u3001\u4ee5\u4e0b\u306e\u30ec\u30b3\u30fc\u30c9\u3092\u30ea\u30b9\u30c8\u30a2\u30c3\u30d7\u3067\u304d\u307e\u3059\u3002\u540d\u5bc4\u305b\u304c\u5fc5\u8981\u306a\u30ec\u30b3\u30fc\u30c9\u306b\u306f UPDATE \u6587\u3092\u767a\u884c\u3057\u3066\u304a\u304d\u307e\u3057\u3087\u3046\u3002\n\n\n\nn03_001\nn03_002\nn03_003\nn03_004\nn03_007\n\u30ec\u30b3\u30fc\u30c9\u6570\n\n\n\n\n\u5317\u6d77\u9053\n\u6839\u5ba4\u632f\u8208\u5c40\n\n\u6839\u5ba4\u5e02\n01223\n76\n\n\n\u5317\u6d77\u9053\n\n\n\u6839\u5ba4\u5e02\n01223\n464\n\n\n\u5317\u6d77\u9053\n\u91e7\u8def\u652f\u5e81\n\u539a\u5cb8\u90e1\n\u6d5c\u4e2d\u753a\n01663\n139\n\n\n\u5317\u6d77\u9053\n\u91e7\u8def\u7dcf\u5408\u632f\u8208\u5c40\n\u539a\u5cb8\u90e1\n\u6d5c\u4e2d\u753a\n01663\n1\n\n\n\u4e09\u91cd\u770c\n\n\u5317\u725f\u5a41\u90e1\n\u7d00\u5317\u753a\n24543\n416\n\n\n\u4e09\u91cd\u770c\n\n\u5317\u725f\u5a41\u90e1\n\u7d00\u5317\u753a\u5165\u4f1a\u5730\n24543\n110\n\n\n\u9999\u5ddd\u770c\n\n\u9999\u5ddd\u770c\n\u4e38\u4e80\u5e02\n37202\n1\n\n\n\u9999\u5ddd\u770c\n\n\n\u4e38\u4e80\u5e02\n37202\n14\n\n\n\n\u5e02\u533a\u753a\u6751\u306b\u306f\u540c\u4e00\u540d\u79f0\u3082\u3042\u308a\u307e\u3059\u306e\u3067\u3001\u96c6\u7d04\u3055\u305b\u308b\u30ad\u30fc\u306b\u306f\u6ce8\u610f\u3057\u307e\u3057\u3087\u3046\u3002\u307e\u305f\u3001\u30c6\u30fc\u30d6\u30eb\u5b9a\u7fa9\u3067 UNIQUE \u5236\u7d04\u3092\u4ed8\u3051\u308b\u5834\u5408\u306f\u614e\u91cd\u306b\u691c\u8a0e\u3057\u307e\u3057\u3087\u3046\u3002\n\n\n\u540c\u4e00\u540d\u79f0\u306e\u5e02\u533a\u753a\u6751\u4e00\u89a7 - Wikipedia\n\n\nPostGIS\u3092\u4f7f\u3063\u3066\u5f62\u72b6\u30c7\u30fc\u30bf\u3092\u5e02\u533a\u753a\u6751\u3054\u3068\u306b\u7d50\u5408\n\u90fd\u9053\u5e9c\u770c\u3054\u3068\u306e\u30c6\u30fc\u30d6\u30eb\u306b\u3042\u308b\u30ec\u30b3\u30fc\u30c9\u3092\u4f4f\u6240\u30b3\u30fc\u30c9\u3067\u96c6\u7d04\u3057\u307e\u3059\u3002PostGIS \u3067\u306f\u8907\u6570\u306e\u5f62\u72b6\u30c7\u30fc\u30bf\u3092 ST_Union \u3067\u7d50\u5408\u3067\u304d\u307e\u3059\u3002\n\u4eca\u56de\u306e\u5834\u5408\u306f\u3001\u4f4f\u6240\u30b3\u30fc\u30c9 (n03_007 \u30d5\u30a3\u30fc\u30eb\u30c9) \u3067 GROUP BY \u3057\u3001 geom \u30d5\u30a3\u30fc\u30eb\u30c9\u3092\u7d50\u5408\u3055\u305b\u307e\u3059\u3002\u5909\u63db\u5148\u306e\u30c6\u30fc\u30d6\u30eb\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u5b9a\u7fa9\u3057\u307e\u3059\u3002\n\n\u5909\u63db\u5148\u306e\u30c6\u30fc\u30d6\u30eb\u5b9a\u7fa9\nCREATE TABLE address (\n    code varchar(5) PRIMARY KEY CHECK (length(code) IN (2, 5)),\n    geom geometry(MULTIPOLYGON, 4326) NOT NULL\n);\n\n\n\u5909\u63db\u30af\u30a8\u30ea\u306fSQL\u30d5\u30a1\u30a4\u30eb\u306b\u4fdd\u5b58\u3057\u3001 psql \u30b3\u30de\u30f3\u30c9\u306e \"-v\" \u30aa\u30d7\u30b7\u30e7\u30f3\u3092\u4f7f\u3063\u3066\u5909\u6570\u3092\u30eb\u30fc\u30d7\u3055\u305b\u307e\u3059\u3002\u90fd\u9053\u5e9c\u770c\u3054\u3068\u306b\u5225\u3005\u306e\u30c6\u30fc\u30d6\u30eb\u306b\u306a\u3063\u3066\u3044\u308b\u305f\u3081\u3067\u3059\u3002\"table\" \u306b\u306f\u30c6\u30fc\u30d6\u30eb\u540d\u3001\"code\" \u306b\u306f\u90fd\u9053\u5e9c\u770c\u30b3\u30fc\u30c9\u3092\u6307\u5b9a\u3057\u307e\u3059\u3002\n\ntransform.sql\nINSERT INTO address\nSELECT n03_007, ST_Union(ST_SetSRID(geom, 4326))\nFROM :\"table\"\nWHERE n03_007 IS NOT NULL\nGROUP BY n03_007;\n\nINSERT INTO address\nSELECT :'code', ST_Union(ST_SetSRID(geom, 4326))\nFROM :\"table\"\nWHERE n03_007 IS NULL\nGROUP BY n03_001;\n\n\n\n\u90fd\u9053\u5e9c\u770c\u3054\u3068\u306b\u30af\u30a8\u30ea\u3092\u5b9f\u884c\nfor i in {01..47}\ndo\n    psql -U postgres -d geo -f transform.sql -v table=\"n03-13_${i}_130401\" -v code=$i\ndone\n\n\n\nGeoJSON\u3067\u51fa\u529b\u3057\u3066\u63cf\u753b\nPostGIS \u306e ST_AsGeoJSON \u3092\u4f7f\u3046\u3068\u5f62\u72b6\u30c7\u30fc\u30bf\u3092 GeoJSON \u3067\u51fa\u529b\u3067\u304d\u307e\u3059\u3002\n\u5e02\u533a\u753a\u6751\u3054\u3068\u306b\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3057\u3066\u307f\u307e\u3057\u3087\u3046\u3002\necho \"SELECT code, ST_AsGeoJSON(geom) FROM address\" | psql -U postgres -d geo -t -A --field-separator=$'\\t' > address.txt\nawk '{ print $2 >> $1\".geojson\" '} address.txt\n\n\u51fa\u6765\u4e0a\u304c\u3063\u305f GeoJSON \u30d5\u30a1\u30a4\u30eb\u3092 geojson.io \u306b\u8cbc\u4ed8\u3051\u3066\u307f\u308b\u3068\u3001\u5e02\u533a\u753a\u6751\u306e\u5f62\u72b6\u3092\u78ba\u8a8d\u3067\u304d\u307e\u3059\u3002\u81ea\u524d\u3067\u63cf\u753b\u3057\u305f\u3044\u5834\u5408\u306f Leaflet \u3084 D3 \u3092\u4f7f\u3063\u3066 JavaScript \u3092\u66f8\u3051\u3070\u826f\u3044\u3067\u3057\u3087\u3046\u3002\n\u4f4f\u6240\u30b3\u30fc\u30c9\u306b\u5bfe\u5fdc\u3059\u308b\u540d\u79f0\u306f\u7dcf\u52d9\u7701\u306e\u5168\u56fd\u5730\u65b9\u516c\u5171\u56e3\u4f53\u30b3\u30fc\u30c9\u3067\u5b9a\u7fa9\u3055\u308c\u3066\u3044\u307e\u3059\u3002\u5229\u7528\u3059\u308b\u4f4f\u6240\u30c7\u30fc\u30bf\u306b\u5bfe\u5fdc\u3059\u308b\u5e74\u5ea6\u306e\u30b3\u30fc\u30c9\u8868\u3092\u4f7f\u3046\u3068\u30de\u30c3\u30d4\u30f3\u30b0\u3067\u304d\u307e\u3059\u3002\u306a\u304a\u3001\u3044\u304f\u3064\u304b\u6ce8\u610f\u70b9\u304c\u3042\u308a\u307e\u3059\u3002\n\n\u5e74\u5ea6\u304c\u7570\u306a\u308b\u5834\u5408\u306f\u5e02\u533a\u753a\u6751\u306e\u5408\u4f75\u306a\u3069\u306b\u9069\u5fdc\u3067\u304d\u306a\u3044\u5834\u5408\u304c\u3042\u308a\u307e\u3059\u3002\n\u7dcf\u52d9\u7701\u306e\u30c7\u30fc\u30bf\u306b\u306f\uff16\u6841\u76ee\u306e\u30c1\u30a7\u30c3\u30af\u30c7\u30a3\u30b8\u30c3\u30c8\u304c\u3042\u308a\u307e\u3059\u3002\n\u7dcf\u52d9\u7701\u306e\u30c7\u30fc\u30bf\u306b\u306f\u300c\u90e1\u300d\u304c\u3042\u308a\u307e\u305b\u3093\u3002\n\u7dcf\u52d9\u7701\u306e\u30c7\u30fc\u30bf\u306f\u90fd\u9053\u5e9c\u770c\u5e02\u533a\u753a\u6751\u540d\u306f\u30ab\u30bf\u30ab\u30ca\u3067\u3059\u304c\u3001\u653f\u4ee4\u6307\u5b9a\u90fd\u5e02\u540d\u306f\u3072\u3089\u304c\u306a\u3067\u4f75\u8a18\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n\nPostgreSQL \u306a\u3069\u306e\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u3067\u30c7\u30fc\u30bf\u3092\u7ba1\u7406\u3057\u3066\u304a\u304f\u3068\u3001JOIN \u3092\u4f7f\u3063\u305f\u7d50\u5408\u51e6\u7406\u3092\u7c21\u5358\u306b\u8a18\u8ff0\u3067\u304d\u308b\u70b9\u306f\u4fbf\u5229\u3060\u3068\u8a00\u3048\u307e\u3059\u3002\u8868\u793a\u3059\u308b\u30e9\u30d9\u30eb\u3092\u5de5\u592b\u3057\u305f\u3044\u5834\u5408\u306f\u30c7\u30fc\u30bf\u3092\u51fa\u529b\u3059\u308b\u30af\u30a8\u30ea\u3092\u9811\u5f35\u3063\u3066\u8a18\u8ff0\u3057\u307e\u3057\u3087\u3046\u3002\n\n\u3053\u306e\u8a18\u4e8b\u3068\u3060\u3044\u305f\u3044\u4e00\u7dd2\u3067\u3059\u3002\n\n* [\u56fd\u571f\u4ea4\u901a\u7701\u306e\u30c7\u30fc\u30bf\u3092\u4f7f\u3063\u3066\u3001\u7def\u5ea6\u7d4c\u5ea6\u304b\u3089\u5e02\u533a\u753a\u6751\u307e\u3067\u3092\u53d6\u308a\u51fa\u3059](http://qiita.com/masuidrive/items/21a282c7bf54fd6a4985)\n\n\u3053\u3053\u3067\u306f\u3001\u4f4f\u6240\u30b3\u30fc\u30c9\u304b\u3089\u305d\u306e\u5e02\u533a\u753a\u6751\u306e\u5f62\u72b6\u3092\u63cf\u3044\u3066\u307f\u307e\u3059\u3002\u6d41\u308c\u3068\u3057\u3066\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\n\n1. [\u56fd\u571f\u6570\u5024\u60c5\u5831\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u30b5\u30fc\u30d3\u30b9](http://nlftp.mlit.go.jp/ksj/gml/datalist/KsjTmplt-N03.html)\u304b\u3089\u90fd\u9053\u5e9c\u770c\u3054\u3068\u306eZIP\u30d5\u30a1\u30a4\u30eb\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\n2. ZIP\u3092\u5c55\u958b\u3057\u3001Shape\u5f62\u5f0f\u306e\u30c7\u30fc\u30bf\u3092PostGIS\u306b\u767b\u9332\n3. PostGIS\u3092\u4f7f\u3063\u3066\u5f62\u72b6\u30c7\u30fc\u30bf\u3092\u5e02\u533a\u753a\u6751\u3054\u3068\u306b\u7d50\u5408\n4. GeoJSON\u3067\u51fa\u529b\u3057\u3066\u63cf\u753b\n\n\u307e\u305a\u306f\u5e73\u621025\u5e74\u5ea6\u306e\u30c7\u30fc\u30bf\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u307e\u3059\u3002\u5e73\u621026\u5e74\u5ea6\u306e\u30c7\u30fc\u30bf\u304c\u516c\u958b\u3055\u308c\u305f\u3089\u305d\u3061\u3089\u3092\u4f7f\u3063\u305f\u65b9\u304c\u826f\u3044\u3067\u3057\u3087\u3046\u3002\u30af\u30ea\u30c3\u30af\u3092\u7e70\u308a\u8fd4\u3059\u3060\u3051\u306e\u5358\u8abf\u4f5c\u696d\u306a\u306e\u3067\u3001\u6642\u9593\u304c\u3042\u308b\u3068\u304d\u306b\u5b9f\u65bd\u3057\u3066\u304a\u304d\u307e\u3059\u300247\u90fd\u9053\u5e9c\u770c\u306eZIP\u30d5\u30a1\u30a4\u30eb\u3092\u3001\u3069\u3053\u304b\u9069\u5f53\u306a\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306b\u307e\u3068\u3081\u3066\u4fdd\u7ba1\u3057\u307e\u3059\u3002\n\n## EC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u8d77\u52d5\n\nAWS \u306e EC2 \u3067\u4f5c\u696d\u3057\u307e\u3059\u3002\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u30a4\u30e1\u30fc\u30b8ID\u306f [Amazon Linux AMI](http://aws.amazon.com/jp/amazon-linux-ami/) \u306e\u30da\u30fc\u30b8\u306b\u8a18\u8f09\u3055\u308c\u3066\u3044\u307e\u3059\u3002\u305d\u306e\u6642\u306e\u4e00\u756a\u65b0\u3057\u3044\u30bf\u30a4\u30d7\u3092\u4f7f\u3046\u3068\u4fbf\u5229\u306a\u3053\u3068\u306f\u591a\u3044\u3067\u3059\u304c\u3001\u30e9\u30a4\u30d6\u30e9\u30ea\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u4f9d\u5b58\u306b\u60a9\u3080\u5834\u5408\u306f\u3001\u3061\u3087\u3063\u3068\u53e4\u3044\u30bf\u30a4\u30d7\u3092\u8a66\u3057\u3066\u307f\u307e\u3057\u3087\u3046\u3002`--user-data` \u3092\u4f7f\u3063\u3066\u81ea\u52d5\u30a2\u30c3\u30d7\u30c7\u30fc\u30c8\u3092\u6b62\u3081\u308b\u65b9\u6cd5\u306f\u4e0b\u8a18\u306e\u8a18\u4e8b\u304c\u53c2\u8003\u306b\u306a\u308a\u307e\u3059\u3002\n\n* [Amazon Linux AMI 2014.03 Released! \u65e9\u901f\u30cf\u30de\u3063\u305f\u3053\u3068 (Perl\u30fbglibc\u7de8)](http://dev.classmethod.jp/cloud/aws/amazon-linux-ami-2014-03-trap/)\n\nPostGIS \u3092 `yum` \u3067\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u5834\u5408\u3001EPEL \u306e *gdal-libs* \u306b\u4f9d\u5b58\u3057\u307e\u3059\u3002\n\u3057\u304b\u3057\u30012014.03 \u306e\u30ec\u30dd\u30b8\u30c8\u30ea\u3060\u3068 EPEL \u306e *gdal-libs* \u304c\u4f9d\u5b58\u3059\u308b *poppler* \u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u304c\u5408\u3044\u307e\u305b\u3093\u3002 *gdal-libs* \u306f *poppler-0.12* \u306b\u4f9d\u5b58\u3057\u307e\u3059\u304c\u3001\u6700\u65b0\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306b\u306f *poppler-0.22.5* \u304c\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3055\u308c\u3066\u3044\u307e\u3059\u3002\u3072\u3068\u3064\u53e4\u3044 2013.09 \u306f *poppler-0.12.4* \u304c\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3055\u308c\u3066\u3044\u307e\u3059\u306e\u3067\u3001\u30bd\u30fc\u30b9\u30b3\u30fc\u30c9\u304b\u3089\u30d3\u30eb\u30c9\u3059\u308b\u306e\u304c\u7169\u96d1\u306a\u5834\u5408\u306f\u3053\u3061\u3089\u3092\u4f7f\u3046\u306e\u304c\u826f\u3044\u3067\u3057\u3087\u3046\u3002\n\n\u3068\u3044\u3046\u3053\u3068\u3067\u3001\u4ee5\u4e0b\u306e\u69cb\u6210\u3067 [awscli](https://pypi.python.org/pypi/awscli) \u306e\u30b3\u30de\u30f3\u30c9\u30e9\u30a4\u30f3\u30c4\u30fc\u30eb\u3092\u4f7f\u3063\u3066 EC2 \u3092\u8d77\u52d5\u3057\u307e\u3059\u3002\u30d1\u30c3\u30b1\u30fc\u30b8\u30ec\u30dd\u30b8\u30c8\u30ea\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u3092\u56fa\u5b9a\u3057\u3066\u304a\u304d\u305f\u3044\u306e\u3067\u3001`--user-data` \u3067\u8d77\u52d5\u6642\u306b\u81ea\u52d5\u30a2\u30c3\u30d7\u30b0\u30ec\u30fc\u30c9\u3057\u306a\u3044\u3088\u3046\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n\n\n| \u7a2e\u5225 | \u5185\u5bb9 |\n|----:|:----|\n| AMI | 2013.09 \u306e 64bit |\n| \u30ea\u30fc\u30b8\u30e7\u30f3 | \u30a2\u30b8\u30a2\u30d1\u30b7\u30d5\u30a3\u30c3\u30af\u6771\u4eac |\n| \u30a4\u30e1\u30fc\u30b8ID | ami-3561fe34 |\n| \u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u30bf\u30a4\u30d7 | t1.micro |\n| SSH\u9375 | aws-tokyo-sandbox |\n| \u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u30b0\u30eb\u30fc\u30d7 | SSHEnabledGroup |\n\n\n```bash:EC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u8d77\u52d5\naws ec2 run-instances \\\n    --image-id ami-3561fe34 \\\n    --instance-type t1.micro \\\n    --count 1 \\\n    --key-name ec2-tokyo-sandbox \\\n    --security-groups SSHEnabledGroup \\\n    --user-data `cat << EOF | base64\n#cloud-config\nrepo_upgrade: none\nEOF`\n```\n\nSSH \u3067\u30ed\u30b0\u30a4\u30f3\u3057\u305f\u3089\u30ec\u30dd\u30b8\u30c8\u30ea\u306e\u8a2d\u5b9a\u3092\u5909\u66f4\u3057\u307e\u3059\u3002\n\n```bash:\u30ec\u30dd\u30b8\u30c8\u30ea\u8a2d\u5b9a\ncurl -O http://yum.postgresql.org/9.3/redhat/rhel-6-x86_64/pgdg-redhat93-9.3-1.noarch.rpm\nsudo rpm -ivh pgdg-redhat93-9.3-1.noarch.rpm\nsudo vim /etc/yum.conf  # releasever=latest \u3092\u30b3\u30e1\u30f3\u30c8\u30a2\u30a6\u30c8\nsudo vim /etc/yum.repos.d/pgdg-93-redhat.repo  # $releasever \u21d2 latest\n```\n\n\u6b21\u306b\u3001PostGIS \u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u307e\u3059\u3002\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u304c\u6210\u529f\u3059\u308b\u3068 `shp2pgsql` \u30b3\u30de\u30f3\u30c9\u304c\u4f7f\u3048\u308b\u3088\u3046\u306b\u306a\u3063\u3066\u3044\u308b\u306f\u305a\u3067\u3059\u3002\n\n```bash:PostGIS\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\nsudo yum install postgresql93-server postgresql93-contrib -y\nsudo yum install --enablerepo epel postgis2_93 postgis2_93_devel postgis2_93_utils -y\n```\n\nPostGIS \u304c\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3067\u304d\u305f\u3089 PostgreSQL \u3092\u8d77\u52d5\u3057\u307e\u3059\u3002\n\u4f5c\u696d\u3092\u7c21\u5358\u306b\u9032\u3081\u308b\u305f\u3081\u306b\u3001\u30a2\u30af\u30bb\u30b9\u6a29\u9650\u3092\u5909\u66f4\u3057\u3066\u304a\u304d\u307e\u3057\u3087\u3046\u3002SSH\u3067\u30ed\u30b0\u30a4\u30f3\u3057\u3066\u3044\u308b\u5834\u5408\u306f\u30e6\u30fc\u30b6\u30fc\u540d\u3092\u6307\u5b9a\u3059\u308b\u3060\u3051\u306b\u3057\u307e\u3059\u3002\n\n\n```bash:\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u8a2d\u5b9a\nsudo service postgresql-9.3 initdb\nsudo service postgresql-9.3 start\nsudo su - postgres\nvi /var/lib/pgsql/9.3/data/pg_hba.conf    # \u4e0b\u8a18\u53c2\u7167\n```\n\n```conf:/var/lib/pgsql/9.3/data/pg_hba.conf\nlocal        all        all        trust\n```\n\n\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092\u5909\u66f4\u3057\u305f\u3089 PostgreSQL \u3092\u518d\u8d77\u52d5\u3057\u307e\u3059\u3002\n\n```bash\nsudo service postgresql-9.3 restart\n```\n\n\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u3092\u4f5c\u6210\u3057\u3001PostGIS \u62e1\u5f35\u3092\u6709\u52b9\u306b\u3057\u307e\u3059\u3002\n\n```bash:\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u4f5c\u6210\ncreatedb -U postgres geo\ncat << EOF | psql -U postgres -d geo\nCREATE EXTENSION postgis;\nCREATE EXTENSION postgis_topology;\nCREATE EXTENSION fuzzystrmatch;\nCREATE EXTENSION postgis_tiger_geocoder;\nSELECT postgis_full_version();\nEOF\n```\n\n\u3053\u308c\u3067\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306e\u8a2d\u5b9a\u304c\u3067\u304d\u307e\u3057\u305f\u3002\n\n## ZIP\u30d5\u30a1\u30a4\u30eb\u306e\u4e2d\u8eab\u3092PostGIS\u306b\u767b\u9332\n\n\u56fd\u571f\u6570\u5024\u60c5\u5831\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u30b5\u30fc\u30d3\u30b9\u304b\u3089\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u305fZIP\u30d5\u30a1\u30a4\u30eb\u3092EC2\u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306b\u8ee2\u9001\u3057\u307e\u3059\u3002\u8ee2\u9001\u3067\u304d\u305f\u3089\u3001ZIP\u30d5\u30a1\u30a4\u30eb\u3092\u5c55\u958b\u3057\u3066 `shp2pgsql` \u3067SQL\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3057\u3001PostGIS\u306b\u767b\u9332\u3057\u307e\u3059\u3002\n\n```bash\nfor f in N03-*.zip\ndo\n    unzip -d ${f%.zip} $f\ndone\n\nfor f in N03-*/*.shp\ndo\n    t=`basename $f`\n    sql=${t%.shp}.sql\n    shp2pgsql -W \"Shift_JIS\" $f | psql -U postgres -d geo\ndone\n```\n\n\u30d5\u30a1\u30a4\u30eb\u540d\u306b\u5fdc\u3058\u305f\u30c6\u30fc\u30d6\u30eb\u304c\u751f\u6210\u3055\u308c\u307e\u3059\u306e\u3067\u300147\u500b\u306e\u30c6\u30fc\u30d6\u30eb\u304c\u751f\u6210\u3055\u308c\u307e\u3059\u3002\n\n\u30c7\u30fc\u30bf\u3092\u898b\u3066\u307f\u308b\u3068\u3001\u3044\u304f\u3064\u304b\u306e\u90fd\u9053\u5e9c\u770c\u306e\u30c7\u30fc\u30bf\u306b\u306f\u6ce8\u610f\u304c\u5fc5\u8981\u3067\u3042\u308b\u3053\u3068\u304c\u5206\u304b\u308a\u307e\u3059\u3002 ([\u5317\u6d77\u9053\u5730\u65b9\u306e\u652f\u5e81\u30fb\u5730\u65b9\u4e8b\u52d9\u6240\u4e00\u89a7](http://ja.wikipedia.org/wiki/%E6%94%AF%E5%BA%81#.E5.8C.97.E6.B5.B7.E9.81.93.E5.9C.B0.E6.96.B9) - Wikipedia)\n\n```sql:\u5317\u6d77\u9053\u306e\u652f\u5e81\u3068\u632f\u8208\u5c40\u304c\u6df7\u5728\u3057\u3066\u3044\u308b\nSELECT distinct n03_002\nFROM \"n03-13_01_130401\"\nWHERE n03_002 IS NOT NULL\nORDER BY n03_002;\n\n    n03_002\n----------------\n \u4e0a\u5ddd\u652f\u5e81\n \u5341\u52dd\u652f\u5e81\n \u5b97\u8c37\u652f\u5e81\n \u5f8c\u5fd7\u652f\u5e81\n \u65e5\u9ad8\u652f\u5e81\n \u6839\u5ba4\u632f\u8208\u5c40\n \u6839\u5ba4\u652f\u5e81\n \u6a9c\u5c71\u652f\u5e81\n \u6e21\u5cf6\u652f\u5e81\n \u7559\u840c\u652f\u5e81\n \u77f3\u72e9\u652f\u5e81\n \u7a7a\u77e5\u652f\u5e81\n \u7db2\u8d70\u652f\u5e81\n \u80c6\u632f\u652f\u5e81\n \u91e7\u8def\u652f\u5e81\n \u91e7\u8def\u7dcf\u5408\u632f\u8208\u5c40\n(16 rows)\n```\n\n```sql:\u9999\u5ddd\u770c\u306e\u90e1\u30fb\u653f\u4ee4\u5e02\u540d\u304c\u9999\u5ddd\u770c\u306e\u30ec\u30b3\u30fc\u30c9\u304c\u3042\u308b\n\\x\n\nSELECT n03_001, n03_002, n03_003, n03_004, n03_007\nFROM \"n03-13_37_130401\"\nWHERE n03_001 = n03_003;\n\n-[ RECORD 1 ]---\nn03_001 | \u9999\u5ddd\u770c\nn03_002 |\nn03_003 | \u9999\u5ddd\u770c\nn03_004 | \u4e38\u4e80\u5e02\nn03_007 | 37202\n```\n\n```sql:\u6240\u5c5e\u672a\u5b9a\u5730\u306e\u78ba\u8a8d\nSELECT n03_001, n03_002, n03_003, n03_004, n03_007 FROM \"n03-13_13_130401\" WHERE n03_007 IS NULL;\n\n-- \u7d50\u679c\u306f\u7701\u7565\n```\n\n\n\u305f\u3068\u3048\u3070\u3001\u4f4f\u6240\u30b3\u30fc\u30c9\u3067\u96c6\u7d04\u3057\u305f\u3068\u304d\u306b\u540d\u79f0\u304c\u4e0d\u4e00\u81f4\u306b\u306a\u308b\u30ec\u30b3\u30fc\u30c9\u3092\u62bd\u51fa\u3059\u308b\u3068\u3001\u4ee5\u4e0b\u306e\u30ec\u30b3\u30fc\u30c9\u3092\u30ea\u30b9\u30c8\u30a2\u30c3\u30d7\u3067\u304d\u307e\u3059\u3002\u540d\u5bc4\u305b\u304c\u5fc5\u8981\u306a\u30ec\u30b3\u30fc\u30c9\u306b\u306f _UPDATE_ \u6587\u3092\u767a\u884c\u3057\u3066\u304a\u304d\u307e\u3057\u3087\u3046\u3002\n\n| n03_001 | n03_002 | n03_003 | n03_004 | n03_007 | \u30ec\u30b3\u30fc\u30c9\u6570 |\n|:--------|:--------|:--------|:--------|:--------|---------:|\n \u5317\u6d77\u9053  | \u6839\u5ba4\u632f\u8208\u5c40     |         | \u6839\u5ba4\u5e02  | 01223   |  76\n \u5317\u6d77\u9053  |                |         | \u6839\u5ba4\u5e02  | 01223   | 464\n \u5317\u6d77\u9053  | \u91e7\u8def\u652f\u5e81       | \u539a\u5cb8\u90e1  | \u6d5c\u4e2d\u753a  | 01663   | 139\n \u5317\u6d77\u9053  | \u91e7\u8def\u7dcf\u5408\u632f\u8208\u5c40 | \u539a\u5cb8\u90e1  | \u6d5c\u4e2d\u753a  | 01663   |   1\n \u4e09\u91cd\u770c  |         | \u5317\u725f\u5a41\u90e1 | \u7d00\u5317\u753a       | 24543   | 416\n \u4e09\u91cd\u770c  |         | \u5317\u725f\u5a41\u90e1 | \u7d00\u5317\u753a\u5165\u4f1a\u5730 | 24543   | 110\n \u9999\u5ddd\u770c  |         | \u9999\u5ddd\u770c  | \u4e38\u4e80\u5e02  | 37202   |   1\n \u9999\u5ddd\u770c  |         |         | \u4e38\u4e80\u5e02  | 37202   |  14\n\n\u5e02\u533a\u753a\u6751\u306b\u306f\u540c\u4e00\u540d\u79f0\u3082\u3042\u308a\u307e\u3059\u306e\u3067\u3001\u96c6\u7d04\u3055\u305b\u308b\u30ad\u30fc\u306b\u306f\u6ce8\u610f\u3057\u307e\u3057\u3087\u3046\u3002\u307e\u305f\u3001\u30c6\u30fc\u30d6\u30eb\u5b9a\u7fa9\u3067 *UNIQUE* \u5236\u7d04\u3092\u4ed8\u3051\u308b\u5834\u5408\u306f\u614e\u91cd\u306b\u691c\u8a0e\u3057\u307e\u3057\u3087\u3046\u3002\n\n* [\u540c\u4e00\u540d\u79f0\u306e\u5e02\u533a\u753a\u6751\u4e00\u89a7](http://ja.wikipedia.org/wiki/%E5%90%8C%E4%B8%80%E5%90%8D%E7%A7%B0%E3%81%AE%E5%B8%82%E5%8C%BA%E7%94%BA%E6%9D%91%E4%B8%80%E8%A6%A7) - Wikipedia\n\n## PostGIS\u3092\u4f7f\u3063\u3066\u5f62\u72b6\u30c7\u30fc\u30bf\u3092\u5e02\u533a\u753a\u6751\u3054\u3068\u306b\u7d50\u5408\n\n\u90fd\u9053\u5e9c\u770c\u3054\u3068\u306e\u30c6\u30fc\u30d6\u30eb\u306b\u3042\u308b\u30ec\u30b3\u30fc\u30c9\u3092\u4f4f\u6240\u30b3\u30fc\u30c9\u3067\u96c6\u7d04\u3057\u307e\u3059\u3002PostGIS \u3067\u306f\u8907\u6570\u306e\u5f62\u72b6\u30c7\u30fc\u30bf\u3092 `ST_Union` \u3067\u7d50\u5408\u3067\u304d\u307e\u3059\u3002\n\u4eca\u56de\u306e\u5834\u5408\u306f\u3001\u4f4f\u6240\u30b3\u30fc\u30c9 (n03_007 \u30d5\u30a3\u30fc\u30eb\u30c9) \u3067 _GROUP BY_ \u3057\u3001 _geom_ \u30d5\u30a3\u30fc\u30eb\u30c9\u3092\u7d50\u5408\u3055\u305b\u307e\u3059\u3002\u5909\u63db\u5148\u306e\u30c6\u30fc\u30d6\u30eb\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u5b9a\u7fa9\u3057\u307e\u3059\u3002\n\n```sql:\u5909\u63db\u5148\u306e\u30c6\u30fc\u30d6\u30eb\u5b9a\u7fa9\nCREATE TABLE address (\n    code varchar(5) PRIMARY KEY CHECK (length(code) IN (2, 5)),\n    geom geometry(MULTIPOLYGON, 4326) NOT NULL\n);\n```\n\n\u5909\u63db\u30af\u30a8\u30ea\u306fSQL\u30d5\u30a1\u30a4\u30eb\u306b\u4fdd\u5b58\u3057\u3001 `psql` \u30b3\u30de\u30f3\u30c9\u306e \"-v\" \u30aa\u30d7\u30b7\u30e7\u30f3\u3092\u4f7f\u3063\u3066\u5909\u6570\u3092\u30eb\u30fc\u30d7\u3055\u305b\u307e\u3059\u3002\u90fd\u9053\u5e9c\u770c\u3054\u3068\u306b\u5225\u3005\u306e\u30c6\u30fc\u30d6\u30eb\u306b\u306a\u3063\u3066\u3044\u308b\u305f\u3081\u3067\u3059\u3002\"table\" \u306b\u306f\u30c6\u30fc\u30d6\u30eb\u540d\u3001\"code\" \u306b\u306f\u90fd\u9053\u5e9c\u770c\u30b3\u30fc\u30c9\u3092\u6307\u5b9a\u3057\u307e\u3059\u3002\n\n```sql:transform.sql\nINSERT INTO address\nSELECT n03_007, ST_Union(ST_SetSRID(geom, 4326))\nFROM :\"table\"\nWHERE n03_007 IS NOT NULL\nGROUP BY n03_007;\n\nINSERT INTO address\nSELECT :'code', ST_Union(ST_SetSRID(geom, 4326))\nFROM :\"table\"\nWHERE n03_007 IS NULL\nGROUP BY n03_001;\n```\n\n```bash:\u90fd\u9053\u5e9c\u770c\u3054\u3068\u306b\u30af\u30a8\u30ea\u3092\u5b9f\u884c\nfor i in {01..47}\ndo\n    psql -U postgres -d geo -f transform.sql -v table=\"n03-13_${i}_130401\" -v code=$i\ndone\n```\n\n## GeoJSON\u3067\u51fa\u529b\u3057\u3066\u63cf\u753b\n\nPostGIS \u306e `ST_AsGeoJSON` \u3092\u4f7f\u3046\u3068\u5f62\u72b6\u30c7\u30fc\u30bf\u3092 GeoJSON \u3067\u51fa\u529b\u3067\u304d\u307e\u3059\u3002\n\u5e02\u533a\u753a\u6751\u3054\u3068\u306b\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3057\u3066\u307f\u307e\u3057\u3087\u3046\u3002\n\n```bash\necho \"SELECT code, ST_AsGeoJSON(geom) FROM address\" | psql -U postgres -d geo -t -A --field-separator=$'\\t' > address.txt\nawk '{ print $2 >> $1\".geojson\" '} address.txt\n```\n\n\u51fa\u6765\u4e0a\u304c\u3063\u305f GeoJSON \u30d5\u30a1\u30a4\u30eb\u3092 [geojson.io](http://geojson.io/) \u306b\u8cbc\u4ed8\u3051\u3066\u307f\u308b\u3068\u3001\u5e02\u533a\u753a\u6751\u306e\u5f62\u72b6\u3092\u78ba\u8a8d\u3067\u304d\u307e\u3059\u3002\u81ea\u524d\u3067\u63cf\u753b\u3057\u305f\u3044\u5834\u5408\u306f Leaflet \u3084 D3 \u3092\u4f7f\u3063\u3066 JavaScript \u3092\u66f8\u3051\u3070\u826f\u3044\u3067\u3057\u3087\u3046\u3002\n\n\u4f4f\u6240\u30b3\u30fc\u30c9\u306b\u5bfe\u5fdc\u3059\u308b\u540d\u79f0\u306f\u7dcf\u52d9\u7701\u306e[\u5168\u56fd\u5730\u65b9\u516c\u5171\u56e3\u4f53\u30b3\u30fc\u30c9](http://www.soumu.go.jp/denshijiti/code.html)\u3067\u5b9a\u7fa9\u3055\u308c\u3066\u3044\u307e\u3059\u3002\u5229\u7528\u3059\u308b\u4f4f\u6240\u30c7\u30fc\u30bf\u306b\u5bfe\u5fdc\u3059\u308b\u5e74\u5ea6\u306e\u30b3\u30fc\u30c9\u8868\u3092\u4f7f\u3046\u3068\u30de\u30c3\u30d4\u30f3\u30b0\u3067\u304d\u307e\u3059\u3002\u306a\u304a\u3001\u3044\u304f\u3064\u304b\u6ce8\u610f\u70b9\u304c\u3042\u308a\u307e\u3059\u3002\n\n* \u5e74\u5ea6\u304c\u7570\u306a\u308b\u5834\u5408\u306f\u5e02\u533a\u753a\u6751\u306e\u5408\u4f75\u306a\u3069\u306b\u9069\u5fdc\u3067\u304d\u306a\u3044\u5834\u5408\u304c\u3042\u308a\u307e\u3059\u3002\n* \u7dcf\u52d9\u7701\u306e\u30c7\u30fc\u30bf\u306b\u306f\uff16\u6841\u76ee\u306e\u30c1\u30a7\u30c3\u30af\u30c7\u30a3\u30b8\u30c3\u30c8\u304c\u3042\u308a\u307e\u3059\u3002\n* \u7dcf\u52d9\u7701\u306e\u30c7\u30fc\u30bf\u306b\u306f\u300c\u90e1\u300d\u304c\u3042\u308a\u307e\u305b\u3093\u3002\n* \u7dcf\u52d9\u7701\u306e\u30c7\u30fc\u30bf\u306f\u90fd\u9053\u5e9c\u770c\u5e02\u533a\u753a\u6751\u540d\u306f\u30ab\u30bf\u30ab\u30ca\u3067\u3059\u304c\u3001\u653f\u4ee4\u6307\u5b9a\u90fd\u5e02\u540d\u306f\u3072\u3089\u304c\u306a\u3067\u4f75\u8a18\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n\nPostgreSQL \u306a\u3069\u306e\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u3067\u30c7\u30fc\u30bf\u3092\u7ba1\u7406\u3057\u3066\u304a\u304f\u3068\u3001JOIN \u3092\u4f7f\u3063\u305f\u7d50\u5408\u51e6\u7406\u3092\u7c21\u5358\u306b\u8a18\u8ff0\u3067\u304d\u308b\u70b9\u306f\u4fbf\u5229\u3060\u3068\u8a00\u3048\u307e\u3059\u3002\u8868\u793a\u3059\u308b\u30e9\u30d9\u30eb\u3092\u5de5\u592b\u3057\u305f\u3044\u5834\u5408\u306f\u30c7\u30fc\u30bf\u3092\u51fa\u529b\u3059\u308b\u30af\u30a8\u30ea\u3092\u9811\u5f35\u3063\u3066\u8a18\u8ff0\u3057\u307e\u3057\u3087\u3046\u3002\n", "tags": ["PostGIS"]}