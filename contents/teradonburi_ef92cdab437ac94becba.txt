{"context": "2016/10/24\u8ffd\u8a18\uff1abatchGetItem\u3001batchWriteItem\u306f\u4e00\u90e8\u306e\u30ec\u30b3\u30fc\u30c9\u66f8\u304d\u8fbc\u307f\u51e6\u7406\u306a\u3069\u304c\u5931\u6557\u3057\u3066\u3082\u6210\u529f\u304c\u8fd4\u3063\u3066\u6765\u307e\u3059\u3002\u7279\u306b\u5384\u4ecb\u306a\u306e\u304cread\u30ad\u30e3\u30d1\u30b7\u30c6\u30a3\u3084write\u30ad\u30e3\u30d1\u30b7\u30c6\u30a3\u3092\u8d85\u3048\u305f\u5834\u5408\u306bProvisionedThroughputExceededException\u304c\u767a\u751f\u3059\u308b\u306e\u3067\u3059\u304c\u4e0a\u8a18\u30e1\u30bd\u30c3\u30c9\u3067\u306f\u53d6\u5f97\u3067\u304d\u307e\u305b\u3093\u3002\u4e00\u4ef6\u305a\u3064\u3057\u304b\u66f8\u304d\u8fbc\u307f\u3067\u304d\u307e\u305b\u3093\u304cputItem\u3001getItem\u306e\u65b9\u304c\u30a8\u30e9\u30fc\u30ec\u30b9\u30dd\u30f3\u30b9\u304c\u8fd4\u3063\u3066\u304f\u308b\u306e\u3067\u78ba\u5b9f\u3067\u3059\u3002\nread\u30ad\u30e3\u30d1\u30b7\u30c6\u30a3\u3068write\u30ad\u30e3\u30d1\u30b7\u30c6\u30a3\u306e\u30aa\u30fc\u30c8\u30b9\u30b1\u30fc\u30eb\u306b\u95a2\u3057\u3066\u306f\u30af\u30e9\u30b9\u30e1\u30bd\u30c3\u30c9\u3055\u3093\u306e\u8a18\u4e8b\u304c\u53c2\u8003\u306b\u306a\u308a\u307e\u3059\u3002\nhttp://dev.classmethod.jp/etc/auto-scaling-dynamodb-by-lambda/\n\n\nDynamoDB\u3068\u306f\n\u3044\u3044\u611f\u3058\u306b\u307e\u3068\u307e\u3063\u3066\u308b\u306e\u304c\u3042\u308b\u306e\u3067\u305d\u3061\u3089\u3092\u53c2\u8003\u306b\u3057\u3066\u304f\u3060\u3055\u3044\nDynamoDB \u306e\u57fa\u790e\u77e5\u8b58\u3068\u307e\u3068\u3081\n\u30e1\u30ea\u30c3\u30c8\u306b\u95a2\u3057\u3066\u3056\u3063\u304f\u308a\u8a00\u3046\u3068\u30b9\u30b1\u30fc\u30eb\u3092\u52dd\u624b\u306b\u3084\u3063\u3066\u304f\u308c\u308b\u306e\u3067\u898f\u6a21\u304c\u5927\u304d\u304f\u306a\u3063\u3066\u3082\u7ba1\u7406\u304c\u697d\u306a\u70b9\u3067\u3059\u3002\n\nDynamoDB\u306e\u4e0d\u6e80\u70b9\n\u7ba1\u7406\u304c\u697d\u3068\u8a00\u3044\u3064\u3064\u3001\u8272\u3005\u4e0d\u6e80\u306a\u70b9\uff08\u81ea\u7531\u5ea6\u304c\u4f4e\u3044\u70b9\uff09\u304c\u3042\u308b\u306e\u304cDynamoDB\u3067\u3059\u3002\n\u4ee5\u4e0b\u306b\u4e0d\u6e80\u70b9\u3092\u3042\u3052\u3066\u307f\u307e\u3057\u305f\u3002\n\n\u691c\u7d22\u304c\u8ca7\u5f31\u3001\u8ca7\u5f31\u30a5\uff08\u30ad\u30fc\u4ee5\u5916\u306e\u6761\u4ef6\u3067\u306f\u5168\u30b9\u30ad\u30e3\u30f3\u3057\u304b\u3067\u304d\u306a\u3044\u4e0a\u3001\u691c\u7d22\u6761\u4ef6\u6307\u5b9a\u304c\u8ca7\u5f31\u3067\u3059\u3002\uff09\nNoSQL\u3068\u304b\u8a00\u3046\u5272\u306b\u306f\u578b\u6307\u5b9a\u3057\u306a\u3044\u3068\u30c7\u30fc\u30bf\u633f\u5165\u3067\u304d\u306a\u3044\u3001\u30c7\u30fc\u30bf\u53d6\u5f97\u6642\u306b\u30c7\u30fc\u30bf\u578b\u304c\u3064\u3044\u3066\u304f\u308b\n\u65e5\u4ed8\u578b\u304c\u306a\u3044\n\u7a7a\u6587\u5b57\u304c\u633f\u5165\u3067\u304d\u306a\u3044\n\n\u4ed6\u306b\u3082\u8272\u3005\u3042\u308b\u306e\u3088\u30fb\u30fb\u30fb\n\u3053\u3053\u306b\u30cf\u30de\u3063\u305f\uff01DynamoDB\n\u7279\u306bNoSQL\u3068\u3044\u3044\u3064\u3064\u3001\u578b\u6307\u5b9a\u3068\u304b\u30a7\u30fb\u30fb\u30fb\n\u3061\u306a\u307f\u306bNoSQL\u306e\u4ee3\u8868\u683c\u3067\u3042\u308bMongoDB\u306a\u3089\u30b5\u30fc\u30d0\u30ec\u30b9\u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3\u306e\u5f31\u70b9\u3067\u3082\u3042\u308b\u6700\u5927\u30b3\u30cd\u30af\u30b7\u30e7\u30f3\u3082\u30c1\u30e5\u30fc\u30cb\u30f3\u30b0\u3059\u308c\u307020000\u307e\u3067\u3044\u304f\u3089\u3057\u3044\u3067\u3059\u3002\u304b\u3064\u3001\u691c\u7d22\u6761\u4ef6\u3082\u67d4\u8edf\u3067\u3059\u3002\n\u306a\u3093\u3067AWS\u306fMongoDB\u30b5\u30dd\u30fc\u30c8\u3057\u3066\u304f\u308c\u3066\u306a\u3044\u3093\u3060\u3088\u3001\u3061\u304f\u305b\u3046\n\nOR\u30de\u30c3\u30d1\u30fc\u7684\u306a\u30d8\u30eb\u30d1\u30fc\u3092\u4f5c\u3063\u3066\u307f\u308b\n\u305d\u3093\u306a\u308f\u3051\u3067JSON\u306e\u30ea\u30af\u30a8\u30b9\u30c8\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u305d\u306e\u307e\u307e\u3076\u3061\u8fbc\u307f\u3001\nJSON\u306e\u30ec\u30b9\u30dd\u30f3\u30b9\u30d1\u30e9\u30e1\u30fc\u30bf\u3068\u3057\u3066\u8fd4\u305b\u308bOR\u30de\u30c3\u30d1\u30fc\u3092\u4f5c\u3063\u3066\u307f\u305f\u306e\u3060\u3002\n\u5404\u7a2eAPI\u53c2\u8003\uff1aDynamoDB for Javascript \u2013 cheatsheet\nLambda\u306eAPI\u3068\u3057\u3066\u4f5c\u6210\u3057\u3066\u307e\u3059\u3002\n\ndynamo.js\n// DynamoDB\nvar AWS = require(\"aws-sdk\");\nAWS.config.update({\n    region: \"us-east-1\"\n});\nvar dynamodb = new AWS.DynamoDB();\nvar code = {\n    ErrorNetWorkUnAvaiable : -2,\n    ErrorRequest : -1,\n    Success : 0,\n    ErrorParamsOrLDAP : 1,\n    ErrorDB : 2,\n    ErrorSoap : 3,\n    ErrorSystem : 4,\n    ErrorLimitFamily : 5,\n    ErrorLoginedOnOther : 6,\n    ErrorFamilyInvalid : 7,\n    ErrorDataSource : 9,\n    ErrorCheckInput : 10,\n    ErrorUnKnown:11\n};\n\n// \u30c7\u30fc\u30bf\u578b\u5224\u5b9a\nvar is = module.exports.is = function (type, obj) {\n    var clas = Object.prototype.toString.call(obj).slice(8, -1);\n    return obj !== undefined && obj !== null && clas === type;\n};\n\n// \u30c7\u30fc\u30bf\u578b\u30d7\u30ec\u30d5\u30a3\u30c3\u30af\u30b9\u53d6\u5f97\nvar prefix = module.exports.prefix = function (data) {\n\n    var dataType = 'S';\n    if (is('String', data)) {\n        dataType = 'S';\n        if (data.length === 0) {\n            dataType = 'NULL'; // \u7a7a\u6587\u5b57\u5165\u3089\u306a\u3044\u306e\u3067NULL\u578b\n        }\n        if (checkDate(data)) {\n            dataType = 'N'; // Date\u578b\u306f\u306a\u3044\u306e\u3067\u6570\u5024\u4fdd\u5b58\n        }\n    }\n    if (is('Number', data)) {\n        dataType = 'N';\n    }\n    if (is('Boolean', data)) {\n        dataType = 'BOOL';\n    }\n    if (is('Date', data)) {\n        dataType = 'N'; // Date\u578b\u306f\u306a\u3044\u306e\u3067\u6570\u5024\u4fdd\u5b58\n    }\n    if (is('Array', data)) {\n        dataType = 'L';\n    }\n    if (is('Object', data)) {\n        dataType = 'M';\n    }\n\n    return dataType;\n};\n\n\n\n/**\n * \u65e5\u4ed8\u3092\u30d5\u30a9\u30fc\u30de\u30c3\u30c8\u3059\u308b\n * @param  {Date}   date     \u65e5\u4ed8\n * @param  {String} [format] \u30d5\u30a9\u30fc\u30de\u30c3\u30c8\n * @return {String}          \u30d5\u30a9\u30fc\u30de\u30c3\u30c8\u6e08\u307f\u65e5\u4ed8\n */\nvar formatDate = function (date, format) {\n    if (!format) format = \"YYYY-MM-DDThh:mm:ss.SSSZ\";\n    format = format.replace(/YYYY/g, date.getFullYear());\n    format = format.replace(/MM/g, ('0' + (date.getMonth() + 1)).slice(-2));\n    format = format.replace(/DD/g, ('0' + date.getDate()).slice(-2));\n    format = format.replace(/hh/g, ('0' + date.getHours()).slice(-2));\n    format = format.replace(/mm/g, ('0' + date.getMinutes()).slice(-2));\n    format = format.replace(/ss/g, ('0' + date.getSeconds()).slice(-2));\n    if (format.match(/S/g)) {\n        var milliSeconds = ('00' + date.getMilliseconds()).slice(-3);\n        var length = format.match(/S/g).length;\n        for (var i = 0; i < length; i++) format = format.replace(/S/, milliSeconds.substring(i, i + 1));\n    }\n    return format;\n};\n\n//\"YYYY-MM-DD'T'hh:mm:ss.SSS'Z'\"\u5f62\u5f0f\u306e\u65e5\u4ed8\u304b\u30c1\u30a7\u30c3\u30af\nvar checkDate = function (strDate) {\n\n    // \u30d5\u30a9\u30fc\u30de\u30c3\u30c8\u30c1\u30a7\u30c3\u30af\n    if (!strDate.match(/^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}\\.\\d{3}Z$/)) {\n        return false;\n    }\n\n    var date = strDate.split(\"T\")[0];\n    var time = strDate.split(\"T\")[1];\n\n    var dateArr = date.split(\"-\");\n    if (dateArr.length < 3) {\n        return false;\n    }\n\n    var year = Number(dateArr[0]);\n    var month = Number(dateArr[1] - 1);\n    var day = Number(dateArr[2]);\n\n    var timeArr = time.split(\":\");\n    if (timeArr.length < 3) {\n        return false;\n    }\n\n    var hour = Number(timeArr[0]);\n    var minute = Number(timeArr[1]);\n    var second = Number(timeArr[2].split(\".\")[0]);\n\n    // \u6b63\u3057\u3044\u65e5\u4ed8\u304b\u30c1\u30a7\u30c3\u30af\n    if (year >= 0 && month >= 0 && month <= 11 && day >= 1 && day <= 31) {\n        var date = new Date(year, month, day);\n        if (isNaN(date)) {\n            return false;\n        } else if (date.getFullYear() == year && date.getMonth() == month && date.getDate() == day) {\n\n            // \u6b63\u3057\u3044\u6642\u9593\u304b\u30c1\u30a7\u30c3\u30af\n            if (hour >= 0 && hour <= 23 && minute >= 0 && minute <= 59 && second >= 0 && second <= 59) {\n                return true;\n            }\n\n        }\n    }\n\n    return false;\n};\n\n// \u30e9\u30f3\u30c0\u30e0\u82f1\u6570\nvar randobet = function (n) {\n    var a = 'abcdefghijklmnopqrstuvwxyz' + 'ABCDEFGHIJKLMNOPQRSTUVWXYZ' + '0123456789';\n    a = a.split('');\n    var s = '';\n    for (var i = 0; i < n; i++) {\n        s += a[Math.floor(Math.random() * a.length)];\n    }\n    return s;\n};\n\n// objectId\u81ea\u52d5\u751f\u6210\uff08\u30ad\u30fc\uff09\nfunction convertNewData(data) {\n    var newdata = data;\n\n    if (data.objectId === void 0) {\n        newdata.objectId = randobet(10);\n    }\n\n    return newdata;\n}\n\nfunction convertNewDatas(datas) {\n    var newdatas = [];\n    for (var j = 0; j < datas.length; ++j) {\n        newdatas.push(convertNewData(datas[j]));\n    }\n\n    return newdatas;\n}\n\nfunction createCondition(param) {\n    var condition = {};\n\n    for (var key in param) {\n        condition.ComparisonOperator = key; // \u691c\u7d22\u6761\u4ef6\n        var p = prefix(param[key]);\n\n        if (p === 'N') {\n            param[key] = param[key].toString();\n        }\n        if (checkDate(param[key])) {\n            param[key] = new Date(param[key]).getTime().toString();\n            console.log(\"param[key]:\", param[key]);\n        }\n\n        var obj = {};\n        obj[p] = param[key];\n        condition.AttributeValueList = [obj]; // \u6bd4\u8f03\u5bfe\u8c61\n    }\n\n    return condition;\n\n}\n\n// \u6761\u4ef6\u6587\u4f5c\u6210\nfunction createConditions(where) {\n    var scanFilters = {};\n\n    for (var key in where) {\n        scanFilters[key] = createCondition(where[key]);\n    }\n\n    return scanFilters;\n}\n\nfunction getData(item){\n\n    for (var dataType in item) {\n        console.log(\"item:\",item,\"dataType:\",dataType);\n\n        if (dataType == \"S\") {\n            return item[dataType];\n        }\n        if (dataType == \"N\") {\n            // \u6570\u5b57\u306b\u5909\u63db\n            return Number(item[dataType]);\n        }\n        if (dataType == \"BOOL\") {\n            if (item[dataType] === true) {\n                return \"1\";\n            } else {\n                return \"0\";\n            }\n        }\n        if (dataType == \"NULL\") {\n            if (item[dataType] === true) {\n                // \u7a7a\u6587\u5b57\u306b\u5909\u63db\n                return \"\";\n            }\n        }\n\n\n        if (dataType == \"M\") {\n            var value = {};\n            for(var key in item[dataType]){\n                value[key] = getData(item[dataType][key]);\n            }\n            return value;\n        }\n        if (dataType == \"L\") {\n            var value = [];\n            for(var i = 0;i < item[dataType].length;++i){\n                value.push(getData(item[dataType][i]));\n            }\n            return value;\n        }\n\n\n    }\n\n    return null;\n}\n\n\nfunction formatData(Item) {\n\n    var data = {};\n    console.log(\"Item:\",Item);\n\n    for (var key in Item) {\n        console.log(\"key:\",key);\n\n        var item = Item[key];                \n        data[key] = getData(item);\n    }\n\n    return data;\n}\n\n// Dynamo\u7d50\u679c\u30c7\u30fc\u30bf\u3092\u30d5\u30a9\u30fc\u30de\u30c3\u30c8\u3059\u308b\nfunction formatDatas(param) {\n\n    var Items = param;\n    var datas = [];\n\n    for (var i = 0; i < Items.length; ++i) {\n        var item = Items[i];\n        var data = formatData(item);\n        //console.log(\"data:\",data);\n\n        datas.push(data);\n    }\n\n    console.log(\"datas:\", JSON.stringify(datas));\n\n    return datas;\n}\n\n\n// \u30c7\u30fc\u30bf\u53d6\u5f97(scan)\nvar select = module.exports.select = function (event, cb) {\n\n    var table = event.table;\n\n    var condition = {};\n    if (event.param.where) {\n        condition.where = event.param.where;\n    }\n    if (event.param.order) {\n        condition.order = event.param.order;\n    }\n\n    var params = {\n        TableName: table,\n        ScanFilter: createConditions(condition.where)\n    };\n\n\n    if (event.lastEvaluatedKey) {\n        console.log(event.lastEvaluatedKey);\n        params.ExclusiveStartKey = event.lastEvaluatedKey; // \u7d9a\u304d\u304c\u3042\u308b\u5834\u5408\u306fnull\u3067\u306a\u3044\u305f\u3081\u3001\u7d9a\u304d\u304b\u3089\u691c\u7d22\u3059\u308b\u30ad\u30fc\u3092\u4ee3\u5165\n    }\n\n    console.log(\"params:\", JSON.stringify(params));\n\n    // \u982d\u304b\u3089\u5168\u6587\u691c\u7d22\uff08query\u691c\u7d22\u3067\u306a\u3044\u5834\u5408\u306f\u3053\u306e\u691c\u7d22\u3057\u304b\u306a\u3044\uff09\n    dynamodb.scan(params, function (err, data) {\n        if (err) {\n            console.error(err);\n\n            return cb(err, {\n                message: 'scan failed',\n                status_cd: code.ErrorDB\n            });\n\n        } else {\n            console.log(data);\n            var formatedData = formatDatas(data.Items);\n\n            // \u53d6\u5f97\u3057\u305f\u30c7\u30fc\u30bf\u3092\u8ffd\u52a0\u3059\u308b\n            if (event.lastEvaluatedData) {\n                formatedData.push(event.lastEvaluatedData);\n            }\n\n            // \u7d9a\u304d\u304c\u3042\u308b\u5834\u5408\u306flastEvaluatedKey\u304c\u53d6\u5f97\u3067\u304d\u308b\n            if (data.lastEvaluatedKey) {\n                event.lastEvaluatedData = formatedData;\n                event.lastEvaluatedKey = data.lastEvaluatedKey;\n                return select(event, cb);\n            }\n\n            return cb(null, {\n                data: formatedData,\n                status_cd: code.Success\n            });\n\n        }\n\n\n\n    });\n};\n\n// \u30c7\u30fc\u30bf\u53d6\u5f97(query)\nvar query = module.exports.query = function (event, cb) {\n\n    var table = event.table;\n    var datas = event.param.data;\n\n    if (!is('Array', datas)) {\n        datas = [datas];\n    }\n\n\n    var Ids = [];\n    for(var i=0;i<datas.length;++i){\n        var p = prefix(datas[i].objectId);\n        var obj = {};\n        obj[p] = datas[i].objectId;\n        var data = {\"objectId\": obj};        \n        Ids.push(data);\n    }\n\n\n\n    var requestItems = {};\n    requestItems[table] = {\n        Keys:Ids\n    };\n\n    var params = {\n        RequestItems: requestItems\n    };\n\n    console.log(\"params:\",JSON.stringify(params));\n\n    // \u53d6\u5f97\u3067\u304d\u308b\u4e0a\u9650\u306f16MB\u307e\u3067\n    dynamodb.batchGetItem(params, function (err, data) {\n\n\n        if (err) {\n            console.error(err);\n            return cb(err, {\n                message: 'query failed',\n                status_cd: code.ErrorDB\n            });\n        } else {\n            console.log(data);            \n            var formatedData = formatDatas(data.Responses[table]);\n\n\n            return cb(null, {\n                data: formatedData,\n                status_cd: code.Success\n            });\n        }\n\n    });\n};\n\nfunction createItem(data) {\n\n    var inputData = \"\";\n    if (is('Array', data)) {\n\n        inputData = [];\n\n        for (var inData in data) {\n            var value = createItem(data[inData]); // \u5165\u308c\u5b50\u306e\u30c7\u30fc\u30bf\u3092\u8fbf\u308b\n            inputData.push(value);\n        }\n    } else if (is('Object', data)) {\n        inputData = {};\n\n        for (var inData in data) {\n            var value = createItem(data[inData]); // \u5165\u308c\u5b50\u306e\u30c7\u30fc\u30bf\u3092\u8fbf\u308b\n            inputData[inData] = value;\n        }\n    } else {\n        inputData = data.toString();\n    }\n\n    if (is('String', data)) {\n        if (checkDate(data)) {\n            inputData = new Date(data).getTime().toString();\n        }\n    }\n\n\n    if (inputData.length === 0) {\n        inputData = true; // \u7a7a\u6587\u5b57\u5165\u3089\u306a\u3044\u306e\u3067NULL\u578b\u306etrue\n    }\n\n    var p = prefix(data);\n    var obj = {};\n    obj[p] = inputData;\n    return obj;\n}\n\n// \u4fdd\u5b58\u30c7\u30fc\u30bf\u4f5c\u6210\nfunction createItems(data) {\n\n    var item = {};\n    item.objectId = {\n        \"S\": data.objectId\n    }; // \u4e3b\u30ad\u30fc\u30d1\u30e9\u30e1\u30fc\u30bf\uff08HASH\u30ad\u30fc\u3001RANGE\u30ad\u30fc\uff09\u306f\u5fc5\u9808\u3001\u304b\u3064AutoIncrement\u6a5f\u80fd\u304c\u306a\u3044\u306e\u3067uuid\u751f\u6210\u3059\u308b\n    //item.range_key:{\"S\": \"somedata\"}, // \u4e3b\u30ad\u30fc\u30d1\u30e9\u30e1\u30fc\u30bf\uff08HASH\u30ad\u30fc\u3001RANGE\u30ad\u30fc\uff09\u306f\u5fc5\u9808\n\n\n    for (var key in data) {\n        if (key === 'objectId') {\n            continue;\n        }\n        if (key === 'delete_flag') {\n            continue;\n        }\n        if (key === 'createdAt') {\n            continue;\n        }\n        if (key === 'updatedAt') {\n            continue;\n        }\n\n\n        item[key] = createItem(data[key]);\n    }\n\n    item.delete_flag = {\n        \"BOOL\": (data.delete_flag == \"1\" || data.delete_flag == \"true\") ? true : false\n    };\n\n    var date = formatDate(new Date());\n    //console.log(\"date:\",date);\n    //console.log(\"date:\",checkDate(date));\n    // UNIX\u6642\u9593\u3067\u4fdd\u5b58\n    item.createdAt = {\n        \"N\": new Date(date).getTime().toString()\n    };\n    item.updatedAt = {\n        \"N\": new Date(date).getTime().toString()\n    };\n\n    return item;\n}\n\n\nfunction writeData(param) {\n    var deferred = Promise.defer();\n\n    // multi upsert(25\u9805\u76ee\u307e\u3067\u3057\u304b\u540c\u6642\u306b\u66f8\u304d\u8fbc\u3081\u306a\u3044)\n    dynamodb.batchWriteItem(param, function (err, data) {\n        if (err) {\n            console.error(err);\n            return deferred.reject(err); // .catch\n        } else {\n            console.log(data);\n        }\n\n        deferred.resolve(data); // then\n    });    \n\n\n    return deferred.promise; \n}\n\n\n\n// \u9805\u76ee\u4f5c\u6210\nvar upsert = module.exports.upsert = function (event, cb) {\n\n    var table = event.table;\n    var datas = event.param.data;\n\n    if (!is('Array', datas)) {\n        datas = [datas];\n    }\n\n    // objectId\u304c\u306a\u3044\u5834\u5408\u306f\u751f\u6210\n    datas = convertNewDatas(datas);\n    //console.log(\"datas:\",datas);\n\n    // 25\u9805\u76ee\u305a\u3064\u3057\u304b\u540c\u6642\u306b\u66f8\u304d\u8fbc\u3081\u306a\u3044\u306e\u3067\u5206\u5272\u3059\u308b\n    var MAX_WRITE = 25;\n    var count = datas.length/MAX_WRITE + 1;\n    var params = [];\n\n    for(var i=0;i<count;++i){\n        var indexStart = i * MAX_WRITE;\n        var indexEnd = ((i + 1) * MAX_WRITE) > datas.length ? datas.length : ((i + 1) * MAX_WRITE);\n\n        var items = [];\n        for (var j = indexStart; j < indexEnd; ++j) {\n\n            var obj = {\n                PutRequest: {\n                    Item: createItems(datas[j])\n                }\n            };\n            //console.log(\"obj:\",JSON.stringify(obj));\n            items.push(obj);\n        }\n\n        if(items.length === 0){\n            break;\n        }\n\n        var requestItems = {};\n        requestItems[table] = items;\n        var param = {\n            RequestItems: requestItems\n        };\n\n        console.log(\"params:\", JSON.stringify(param));\n        console.log(\"--------------------\",i,\"---------------------\");\n\n        params.push(param);\n    }\n\n    return params.reduce(function (promise, param) {\n        return promise.then(function () {\n            return writeData(param);\n        });\n    }, Promise.resolve())\n    .then(function(data){\n        return query(event,cb);\n    })\n    .catch(function(err){\n        console.error(err);\n        return cb(err, {\n            message: 'upsert failed',\n            status_cd: code.ErrorDB\n        });\n    });\n\n\n};\n\n// \u30c7\u30fc\u30bf\u4fdd\u5b58\nmodule.exports.save = function (event, cb) {\n\n    var table = event.table;\n    var datas = event.param.data;\n\n\n    // \u30c6\u30fc\u30d6\u30eb\u4e00\u89a7\u53d6\u5f97\n    dynamodb.listTables(function (err, data) {\n        console.log(data.TableNames);\n\n\n        var params = {\n            TableName: table,\n            // \u4e3b\u30ad\u30fc\u306e\u8a2d\u5b9a\n            KeySchema: [\n                {\n                    AttributeName: \"objectId\",\n                    KeyType: \"HASH\"\n                }, //HASH key\n                //{ AttributeName: \"range_key\", KeyType: \"RANGE\" }  //RANGE key \u5fc5\u8981\u306a\u3044\u5834\u5408\u306f\u8a2d\u5b9a\u3057\u306a\u3044\n            ],\n            AttributeDefinitions: [\n                {\n                    AttributeName: \"objectId\",\n                    AttributeType: \"S\"\n                },\n                //{ AttributeName: \"range_key\", AttributeType: \"S\" }\n            ],\n            // \u8aad\u307f\u8fbc\u307f\u66f8\u304d\u8fbc\u307f\u30ad\u30e3\u30d1\u30b7\u30c6\u30a3\n            ProvisionedThroughput: {\n                ReadCapacityUnits: 1,\n                WriteCapacityUnits: 1\n            }\n        };\n\n\n\n        // \u5b58\u5728\u3057\u3066\u3044\u308b\u304b\u306e\u30d5\u30e9\u30b0\n        var isCreated = false;\n        for (var i = 0; i < data.TableNames.length; ++i) {\n            if (data.TableNames[i] == table) {\n                isCreated = true;\n            }\n        }\n\n        // \u3059\u3067\u306b\u4f5c\u6210\u6e08\u307f\n        if (isCreated) {\n\n            // \u30c7\u30fc\u30bf\u4fdd\u5b58\n            return upsert(event, cb);\n\n        } else {\n            // \u30c6\u30fc\u30d6\u30eb\u4f5c\u6210\n            dynamodb.createTable(params, function (err, data) {\n                if (err) {\n                    console.error(err);\n                    return cb(err, {\n                        message: 'table create failed',\n                        status_cd: code.ErrorDB\n                    });\n\n                } else {\n                    console.log(data);\n\n                    var params = {\n                        TableName: table\n                    };\n                    // \u30c6\u30fc\u30d6\u30eb\u4f5c\u6210\u3092\u5f85\u3064\n                    dynamodb.waitFor('tableExists', params, function (err, data) {\n                        if (err) {\n                            console.error(err);\n                        } else {\n                            console.log(data);\n                        }\n                        // \u30c7\u30fc\u30bf\u4fdd\u5b58\n                        return upsert(event, cb);\n                    });\n\n                }\n            });\n        }\n\n    });\n\n};\n\n\nsave\u95a2\u6570\u3092\u547c\u3073\u51fa\u3059Lambda\u3067\u3059\u3002\n\u30c6\u30fc\u30d6\u30eb\u304c\u306a\u3044\u5834\u5408\u306f\u30c6\u30fc\u30d6\u30eb\u3092\u4f5c\u6210\u3057\u3066\u9805\u76ee\u3092upsert\u3057\u307e\u3059\u3002\nobjectId\u3092\u30ad\u30fc\u3068\u3057\u3066\u4f5c\u6210\u3057\u307e\u3059\u3002\n'use strict';\n\nvar dynamo = require('dynamo');\n\nmodule.exports.handler = function(event, context) {\n    return dynamo.save(event, function(error, response) {\n        return context.done(error, response);\n    });\n};\n\nselect\u95a2\u6570\u3092\u547c\u3073\u51fa\u3059Lambda\u3067\u3059\u3002\n'use strict';\n\nvar dynamo = require('dynamo');\n\nmodule.exports.handler = function(event, context, cb) {\n    return dynamo.select(event, function(error, response) {\n        return context.done(error, response);\n    });\n};\n\n\n\u5b9f\u884c\u4f8b\nsave\u95a2\u6570\u306e\u5165\u529b\u30c7\u30fc\u30bf\u306b\u306f\u6b21\u306e\u3088\u3046\u306a\u30c7\u30fc\u30bf\u3092\u5165\u529b\u3059\u308b\u3068\u3057\u307e\u3059\u3002\n\u65e5\u6642\u306fUnix\u6642\u9593\u3067\u683c\u7d0d\u3057\u307e\u3059\u3002\uff08\u65e5\u4ed8\u578b\u304c\u306a\u3044\u305f\u3081\u3001\u5024\u6bd4\u8f03\u3067\u691c\u7d22\u3059\u308b\u305f\u3081\u306b\uff09\n\u7a7a\u6587\u5b57\u306fNULL\u306b\u5909\u63db\u3057\u307e\u3059\u3002\nObject\u578b\u3084Array\u578b\u306e\u30c7\u30fc\u30bf\u3082\u81ea\u52d5\u7684\u306b\u30c7\u30fc\u30bf\u578b\u3092\u6307\u5b9a\u3057\u3066\u3001\u4fdd\u5b58\u3067\u304d\u308b\u3088\u3046\u306b\u3057\u3066\u3044\u307e\u3059\u3002\n\nevent.json\n{\n    \"table\": \"Test\",\n    \"param\": {\n        \"data\":[ {\n            \"closeDate\": 1482918300000,\n            \"image\": {\n                \"url\": \"http://xxxx\",                \n                \"type\": \"File\",\n                \"inner\":[\"a\",\"b\",{\"test1\":\"l\"}]\n            },\n            \"test\":[\"a\",\"b\",\"c\"],\n            \"objectId\": \"6AaY8G9MUA\",\n            \"startDate\": 1459138980000,\n            \"text\": \"\u30c6\u30b9\u30c8\u3067\u3059\u3042\u3042\u3042\",\n            \"userType\": 1            \n        },{\n            \"closeDate\": 1482918300000,\n            \"image\": {\n                \"url\": \"http://yyyy\",\n                \"type\": \"File\",\n                \"inner\":[\"a\",\"b\",{\"test2\":\"l\"}]\n            },\n            \"test\":[\"a\",\"b\",\"c\"],\n            \"objectId\": \"6AaY8G9MUI\",\n            \"startDate\": 1459138980000,\n            \"text\": \"\u30c6\u30b9\u30c8\u3067\u3059\u3044\u3044\u3044\u3044\u3044\",\n            \"userType\": 0\n        }]\n    }\n\n}\n\n\n\u5b9f\u884c\u7d50\u679c\n$ sls function run\nServerless: Running dynamoSave...  \n[ 'FBbot-ifeel',\n  'LineBot',\n  'Test',\n  'appStartupLog',\n  'appVersion',\n  'authtest-myAuthenticationProject-cache',\n  'ifeel-News',\n  'ifeel-PopUp',\n  'ifeel-Product',\n  'ifeel-Question',\n  'ifeel-SideMenu' ]\nparams: {\"RequestItems\":{\"Test\":[{\"PutRequest\":{\"Item\":{\"objectId\":{\"S\":\"6AaY8G9MUA\"},\"closeDate\":{\"N\":\"1482918300000\"},\"image\":{\"M\":{\"url\":{\"S\":\"http://xxxx\"},\"type\":{\"S\":\"File\"},\"inner\":{\"L\":[{\"S\":\"a\"},{\"S\":\"b\"},{\"M\":{\"test1\":{\"S\":\"l\"}}}]}}},\"test\":{\"L\":[{\"S\":\"a\"},{\"S\":\"b\"},{\"S\":\"c\"}]},\"startDate\":{\"N\":\"1459138980000\"},\"text\":{\"S\":\"\u30c6\u30b9\u30c8\u3067\u3059\u3042\u3042\u3042\"},\"userType\":{\"N\":\"1\"},\"delete_flag\":{\"BOOL\":false},\"createdAt\":{\"N\":\"1470341935400\"},\"updatedAt\":{\"N\":\"1470341935400\"}}}},{\"PutRequest\":{\"Item\":{\"objectId\":{\"S\":\"6AaY8G9MUI\"},\"closeDate\":{\"N\":\"1482918300000\"},\"image\":{\"M\":{\"url\":{\"S\":\"http://yyyy\"},\"type\":{\"S\":\"File\"},\"inner\":{\"L\":[{\"S\":\"a\"},{\"S\":\"b\"},{\"M\":{\"test2\":{\"S\":\"l\"}}}]}}},\"test\":{\"L\":[{\"S\":\"a\"},{\"S\":\"b\"},{\"S\":\"c\"}]},\"startDate\":{\"N\":\"1459138980000\"},\"text\":{\"S\":\"\u30c6\u30b9\u30c8\u3067\u3059\u3044\u3044\u3044\u3044\u3044\"},\"userType\":{\"N\":\"0\"},\"delete_flag\":{\"BOOL\":false},\"createdAt\":{\"N\":\"1470341935401\"},\"updatedAt\":{\"N\":\"1470341935401\"}}}}]}}\n{ UnprocessedItems: {} }\nparams: {\"RequestItems\":{\"Test\":{\"Keys\":[{\"objectId\":{\"S\":\"6AaY8G9MUA\"}},{\"objectId\":{\"S\":\"6AaY8G9MUI\"}}]}}}\n{ Responses: { Test: [ [Object], [Object] ] },\n  UnprocessedKeys: {} }\ndatas: [{\"text\":\"\u30c6\u30b9\u30c8\u3067\u3059\u3044\u3044\u3044\u3044\u3044\",\"startDate\":1459138980000,\"closeDate\":1482918300000,\"test\":[\"a\",\"b\",\"c\"],\"objectId\":\"6AaY8G9MUI\",\"createdAt\":1470341935401,\"delete_flag\":\"0\",\"image\":{\"inner\":[\"a\",\"b\",{\"test2\":\"l\"}],\"type\":\"File\",\"url\":\"http://yyyy\"},\"userType\":0,\"updatedAt\":1470341935401},{\"text\":\"\u30c6\u30b9\u30c8\u3067\u3059\u3042\u3042\u3042\",\"startDate\":1459138980000,\"closeDate\":1482918300000,\"test\":[\"a\",\"b\",\"c\"],\"objectId\":\"6AaY8G9MUA\",\"createdAt\":1470341935400,\"delete_flag\":\"0\",\"image\":{\"inner\":[\"a\",\"b\",{\"test1\":\"l\"}],\"type\":\"File\",\"url\":\"http://xxxx\"},\"userType\":1,\"updatedAt\":1470341935400}]\nServerless: -----------------  \nServerless: Success! - This Response Was Returned:  \nServerless: {\n    \"data\": [\n        {\n            \"text\": \"\u30c6\u30b9\u30c8\u3067\u3059\u3044\u3044\u3044\u3044\u3044\",\n            \"startDate\": 1459138980000,\n            \"closeDate\": 1482918300000,\n            \"test\": [\n                \"a\",\n                \"b\",\n                \"c\"\n            ],\n            \"objectId\": \"6AaY8G9MUI\",\n            \"createdAt\": 1470341935401,\n            \"delete_flag\": \"0\",\n            \"image\": {\n                \"inner\": [\n                    \"a\",\n                    \"b\",\n                    {\n                        \"test2\": \"l\"\n                    }\n                ],\n                \"type\": \"File\",\n                \"url\": \"http://yyyy\"\n            },\n            \"userType\": 0,\n            \"updatedAt\": 1470341935401\n        },\n        {\n            \"text\": \"\u30c6\u30b9\u30c8\u3067\u3059\u3042\u3042\u3042\",\n            \"startDate\": 1459138980000,\n            \"closeDate\": 1482918300000,\n            \"test\": [\n                \"a\",\n                \"b\",\n                \"c\"\n            ],\n            \"objectId\": \"6AaY8G9MUA\",\n            \"createdAt\": 1470341935400,\n            \"delete_flag\": \"0\",\n            \"image\": {\n                \"inner\": [\n                    \"a\",\n                    \"b\",\n                    {\n                        \"test1\": \"l\"\n                    }\n                ],\n                \"type\": \"File\",\n                \"url\": \"http://xxxx\"\n            },\n            \"userType\": 1,\n            \"updatedAt\": 1470341935400\n        }\n    ],\n    \"status_cd\": 0\n}  \n\n\u7dba\u9e97\u306b\u5165\u3063\u3066\u3044\u307e\u3059\u306d\u3002\n\n\u6b21\u306bselect\u95a2\u6570\u3067\u30c7\u30fc\u30bf\u3092\u53d6\u5f97\u3057\u307e\u3059\u3002\nwhere\u306e\u4e2d\u306e\u30c7\u30fc\u30bf\u306fDynamoDB\u306e\u691c\u7d22\u6761\u4ef6\u3067scan\u691c\u7d22\u3057\u3066\u307e\u3059\u3002\n{\n    \"table\": \"Test\",\n    \"param\": {\n        \"where\": {\n            \"startDate\": {\n                \"LT\": 1468391572000\n            },\n            \"closeDate\": {\n                \"GT\": 1468391572000\n            },\n            \"userType\":{\n                \"EQ\":1\n            }\n        }\n\n    }\n}\n\n\u5b9f\u884c\u7d50\u679c\u306f\u3064\u304e\u306e\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\n$ sls function run\nServerless: Running dynamoSelect...  \nparams: {\"TableName\":\"Test\",\"ScanFilter\":{\"startDate\":{\"ComparisonOperator\":\"LT\",\"AttributeValueList\":[{\"N\":\"1468391572000\"}]},\"closeDate\":{\"ComparisonOperator\":\"GT\",\"AttributeValueList\":[{\"N\":\"1468391572000\"}]},\"userType\":{\"ComparisonOperator\":\"EQ\",\"AttributeValueList\":[{\"N\":\"1\"}]}}}\n{\"Items\":[{\"text\":{\"S\":\"\u30c6\u30b9\u30c8\u3067\u3059\u3042\u3042\u3042\"},\"startDate\":{\"N\":\"1459138980000\"},\"closeDate\":{\"N\":\"1482918300000\"},\"test\":{\"L\":[{\"S\":\"a\"},{\"S\":\"b\"},{\"S\":\"c\"}]},\"objectId\":{\"S\":\"6AaY8G9MUA\"},\"createdAt\":{\"N\":\"1468954205204\"},\"delete_flag\":{\"BOOL\":false},\"image\":{\"M\":{\"inner\":{\"L\":[{\"S\":\"a\"},{\"S\":\"b\"},{\"M\":{\"test1\":{\"S\":\"l\"}}}]},\"type\":{\"S\":\"File\"},\"url\":{\"S\":\"http://xxxx\"}}},\"userType\":{\"N\":\"1\"},\"updatedAt\":{\"N\":\"1468954205204\"}}],\"Count\":1,\"ScannedCount\":2}\ndatas: [{\"text\":\"\u30c6\u30b9\u30c8\u3067\u3059\u3042\u3042\u3042\",\"startDate\":1459138980000,\"closeDate\":1482918300000,\"test\":[\"a\",\"b\",\"c\"],\"objectId\":\"6AaY8G9MUA\",\"createdAt\":1468954205204,\"delete_flag\":\"0\",\"image\":{\"inner\":[\"a\",\"b\",{\"test1\":\"l\"}],\"type\":\"File\",\"url\":\"http://xxxx\"},\"userType\":1,\"updatedAt\":1468954205204}]\nServerless: -----------------  \nServerless: Success! - This Response Was Returned:  \nServerless: {\n    \"data\": [\n        {\n            \"text\": \"\u30c6\u30b9\u30c8\u3067\u3059\u3042\u3042\u3042\",\n            \"startDate\": 1459138980000,\n            \"closeDate\": 1482918300000,\n            \"test\": [\n                \"a\",\n                \"b\",\n                \"c\"\n            ],\n            \"objectId\": \"6AaY8G9MUA\",\n            \"createdAt\": 1468954205204,\n            \"delete_flag\": \"0\",\n            \"image\": {\n                \"inner\": [\n                    \"a\",\n                    \"b\",\n                    {\n                        \"test1\": \"l\"\n                    }\n                ],\n                \"type\": \"File\",\n                \"url\": \"http://xxxx\"\n            },\n            \"userType\": 1,\n            \"updatedAt\": 1468954205204\n        }\n    ],\n    \"status_cd\": 0\n}  \n\n\u7d20\u76f4\u306aJSON\u5f62\u5f0f\u3067\u8fd4\u305b\u307e\u3057\u305f\u3002\n\n\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u306f\uff1f\n\u5168\u30b9\u30ad\u30e3\u30f3\u3067\u3082\u4e26\u5217\u51e6\u7406\u3067\u691c\u7d22\u304b\u3051\u308c\u3070\u3001\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u304c\u3067\u308b\u3088\u3046\u3067\u3059\u3002\n\u53c2\u8003\uff1a\u300c\u4e26\u5217\u30b9\u30ad\u30e3\u30f3\u300d\u3067\u30c6\u30fc\u30d6\u30eb\u8aad\u307f\u53d6\u308a\u901f\u5ea6\u3092\u5411\u4e0a\u3055\u305b\u308b\n\u624b\u3063\u53d6\u308a\u65e9\u304f\u901f\u5ea6\u3042\u3052\u305f\u3044\u5834\u5408\u306f\u6599\u91d1\u306f\u3042\u304c\u308a\u307e\u3059\u304c\u3001\u8a2d\u5b9a\u3067\u4e0b\u8a18\u306e\u30c6\u30fc\u30d6\u30eb\u306e\u30e6\u30cb\u30c3\u30c8\u6570\u3092\u5897\u3084\u305b\u3070\u826f\u3044\u3067\u3057\u3087\u3046\u3002\n\n\u8aad\u307f\u8fbc\u307f\u5bb9\u91cf\u30e6\u30cb\u30c3\u30c8\n\u66f8\u304d\u8fbc\u307f\u5bb9\u91cf\u30e6\u30cb\u30c3\u30c8\n\n\n\u8907\u6570\u30c6\u30fc\u30d6\u30eb\u66f8\u304d\u8fbc\u307f\u306e\u30c8\u30e9\u30f3\u30b6\u30af\u30b7\u30e7\u30f3\u306f\uff1f\nDynamo\u30b9\u30c8\u30ea\u30fc\u30e0\u306e\u6a5f\u80fd\u3092\u4f7f\u3048\u3070\u3001\u30c6\u30fc\u30d6\u30eb\u66f8\u304d\u8fbc\u307f\u6642\u306b\u9023\u52d5\u3057\u3066\u3055\u3089\u306bLambda\u95a2\u6570\u3092\u30ad\u30c3\u30af\u3067\u304d\u308b\u3088\u3046\u3067\u3059\u3002\n\u3053\u308c\u3092\u4f7f\u3048\u3070\u8907\u6570\u30c6\u30fc\u30d6\u30eb\u306b\u4e00\u62ec\u51e6\u7406\u3055\u305b\u308b\u3053\u3068\u306f\u53ef\u80fd\u306b\u306a\u308b\u3067\u3057\u3087\u3046\u3002\n\uff08\u4eca\u56de\u306f\u3053\u3053\u307e\u3067\u3084\u3063\u3066\u3044\u307e\u305b\u3093\u3002\u3066\u304b\u30ed\u30fc\u30eb\u30d0\u30c3\u30af\u3068\u304b\u3069\u3046\u306a\u308b\u3093\u3060\u308d\uff1f\uff09\n<font color=\"red\">2016/10/24\u8ffd\u8a18\uff1abatchGetItem\u3001batchWriteItem\u306f\u4e00\u90e8\u306e\u30ec\u30b3\u30fc\u30c9\u66f8\u304d\u8fbc\u307f\u51e6\u7406\u306a\u3069\u304c\u5931\u6557\u3057\u3066\u3082\u6210\u529f\u304c\u8fd4\u3063\u3066\u6765\u307e\u3059\u3002\u7279\u306b\u5384\u4ecb\u306a\u306e\u304cread\u30ad\u30e3\u30d1\u30b7\u30c6\u30a3\u3084write\u30ad\u30e3\u30d1\u30b7\u30c6\u30a3\u3092\u8d85\u3048\u305f\u5834\u5408\u306bProvisionedThroughputExceededException\u304c\u767a\u751f\u3059\u308b\u306e\u3067\u3059\u304c\u4e0a\u8a18\u30e1\u30bd\u30c3\u30c9\u3067\u306f\u53d6\u5f97\u3067\u304d\u307e\u305b\u3093\u3002\u4e00\u4ef6\u305a\u3064\u3057\u304b\u66f8\u304d\u8fbc\u307f\u3067\u304d\u307e\u305b\u3093\u304cputItem\u3001getItem\u306e\u65b9\u304c\u30a8\u30e9\u30fc\u30ec\u30b9\u30dd\u30f3\u30b9\u304c\u8fd4\u3063\u3066\u304f\u308b\u306e\u3067\u78ba\u5b9f\u3067\u3059\u3002\nread\u30ad\u30e3\u30d1\u30b7\u30c6\u30a3\u3068write\u30ad\u30e3\u30d1\u30b7\u30c6\u30a3\u306e\u30aa\u30fc\u30c8\u30b9\u30b1\u30fc\u30eb\u306b\u95a2\u3057\u3066\u306f\u30af\u30e9\u30b9\u30e1\u30bd\u30c3\u30c9\u3055\u3093\u306e\u8a18\u4e8b\u304c\u53c2\u8003\u306b\u306a\u308a\u307e\u3059\u3002\nhttp://dev.classmethod.jp/etc/auto-scaling-dynamodb-by-lambda/\n</font>\n\n# DynamoDB\u3068\u306f\n\u3044\u3044\u611f\u3058\u306b\u307e\u3068\u307e\u3063\u3066\u308b\u306e\u304c\u3042\u308b\u306e\u3067\u305d\u3061\u3089\u3092\u53c2\u8003\u306b\u3057\u3066\u304f\u3060\u3055\u3044\n[DynamoDB \u306e\u57fa\u790e\u77e5\u8b58\u3068\u307e\u3068\u3081](http://qiita.com/hshimo/items/e5ad98b21786d796f1da)\n\n\u30e1\u30ea\u30c3\u30c8\u306b\u95a2\u3057\u3066\u3056\u3063\u304f\u308a\u8a00\u3046\u3068\u30b9\u30b1\u30fc\u30eb\u3092\u52dd\u624b\u306b\u3084\u3063\u3066\u304f\u308c\u308b\u306e\u3067\u898f\u6a21\u304c\u5927\u304d\u304f\u306a\u3063\u3066\u3082\u7ba1\u7406\u304c\u697d\u306a\u70b9\u3067\u3059\u3002\n\n# DynamoDB\u306e\u4e0d\u6e80\u70b9\n\u7ba1\u7406\u304c\u697d\u3068\u8a00\u3044\u3064\u3064\u3001\u8272\u3005\u4e0d\u6e80\u306a\u70b9\uff08\u81ea\u7531\u5ea6\u304c\u4f4e\u3044\u70b9\uff09\u304c\u3042\u308b\u306e\u304cDynamoDB\u3067\u3059\u3002\n\u4ee5\u4e0b\u306b\u4e0d\u6e80\u70b9\u3092\u3042\u3052\u3066\u307f\u307e\u3057\u305f\u3002\n\n* \u691c\u7d22\u304c\u8ca7\u5f31\u3001\u8ca7\u5f31\u30a5\uff08\u30ad\u30fc\u4ee5\u5916\u306e\u6761\u4ef6\u3067\u306f\u5168\u30b9\u30ad\u30e3\u30f3\u3057\u304b\u3067\u304d\u306a\u3044\u4e0a\u3001\u691c\u7d22\u6761\u4ef6\u6307\u5b9a\u304c\u8ca7\u5f31\u3067\u3059\u3002\uff09\n* NoSQL\u3068\u304b\u8a00\u3046\u5272\u306b\u306f\u578b\u6307\u5b9a\u3057\u306a\u3044\u3068\u30c7\u30fc\u30bf\u633f\u5165\u3067\u304d\u306a\u3044\u3001\u30c7\u30fc\u30bf\u53d6\u5f97\u6642\u306b\u30c7\u30fc\u30bf\u578b\u304c\u3064\u3044\u3066\u304f\u308b\n* \u65e5\u4ed8\u578b\u304c\u306a\u3044\n* \u7a7a\u6587\u5b57\u304c\u633f\u5165\u3067\u304d\u306a\u3044\n\n\u4ed6\u306b\u3082\u8272\u3005\u3042\u308b\u306e\u3088\u30fb\u30fb\u30fb\n[\u3053\u3053\u306b\u30cf\u30de\u3063\u305f\uff01DynamoDB](http://blog.brains-tech.co.jp/entry/2015/09/30/222148)\n\n\u7279\u306bNoSQL\u3068\u3044\u3044\u3064\u3064\u3001\u578b\u6307\u5b9a\u3068\u304b\u30a7\u30fb\u30fb\u30fb\n\u3061\u306a\u307f\u306bNoSQL\u306e\u4ee3\u8868\u683c\u3067\u3042\u308bMongoDB\u306a\u3089\u30b5\u30fc\u30d0\u30ec\u30b9\u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3\u306e\u5f31\u70b9\u3067\u3082\u3042\u308b\u6700\u5927\u30b3\u30cd\u30af\u30b7\u30e7\u30f3\u3082\u30c1\u30e5\u30fc\u30cb\u30f3\u30b0\u3059\u308c\u3070[20000](http://tsunokawa.hatenablog.com/entry/20130122/p1)\u307e\u3067\u3044\u304f\u3089\u3057\u3044\u3067\u3059\u3002\u304b\u3064\u3001\u691c\u7d22\u6761\u4ef6\u3082\u67d4\u8edf\u3067\u3059\u3002\n~~\u306a\u3093\u3067AWS\u306fMongoDB\u30b5\u30dd\u30fc\u30c8\u3057\u3066\u304f\u308c\u3066\u306a\u3044\u3093\u3060\u3088\u3001\u3061\u304f\u305b\u3046~~\n\n# OR\u30de\u30c3\u30d1\u30fc\u7684\u306a\u30d8\u30eb\u30d1\u30fc\u3092\u4f5c\u3063\u3066\u307f\u308b\n\u305d\u3093\u306a\u308f\u3051\u3067JSON\u306e\u30ea\u30af\u30a8\u30b9\u30c8\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u305d\u306e\u307e\u307e\u3076\u3061\u8fbc\u307f\u3001\nJSON\u306e\u30ec\u30b9\u30dd\u30f3\u30b9\u30d1\u30e9\u30e1\u30fc\u30bf\u3068\u3057\u3066\u8fd4\u305b\u308bOR\u30de\u30c3\u30d1\u30fc\u3092\u4f5c\u3063\u3066\u307f\u305f\u306e\u3060\u3002\n\n\u5404\u7a2eAPI\u53c2\u8003\uff1a[DynamoDB for Javascript \u2013 cheatsheet](http://www.markomedia.com.au/dynamodb-for-javascript-cheatsheet/)\n\nLambda\u306eAPI\u3068\u3057\u3066\u4f5c\u6210\u3057\u3066\u307e\u3059\u3002\n\n```dynamo.js\n// DynamoDB\nvar AWS = require(\"aws-sdk\");\nAWS.config.update({\n    region: \"us-east-1\"\n});\nvar dynamodb = new AWS.DynamoDB();\nvar code = {\n    ErrorNetWorkUnAvaiable : -2,\n    ErrorRequest : -1,\n    Success : 0,\n    ErrorParamsOrLDAP : 1,\n    ErrorDB : 2,\n    ErrorSoap : 3,\n    ErrorSystem : 4,\n    ErrorLimitFamily : 5,\n    ErrorLoginedOnOther : 6,\n    ErrorFamilyInvalid : 7,\n    ErrorDataSource : 9,\n    ErrorCheckInput : 10,\n    ErrorUnKnown:11\n};\n\n// \u30c7\u30fc\u30bf\u578b\u5224\u5b9a\nvar is = module.exports.is = function (type, obj) {\n    var clas = Object.prototype.toString.call(obj).slice(8, -1);\n    return obj !== undefined && obj !== null && clas === type;\n};\n\n// \u30c7\u30fc\u30bf\u578b\u30d7\u30ec\u30d5\u30a3\u30c3\u30af\u30b9\u53d6\u5f97\nvar prefix = module.exports.prefix = function (data) {\n\n    var dataType = 'S';\n    if (is('String', data)) {\n        dataType = 'S';\n        if (data.length === 0) {\n            dataType = 'NULL'; // \u7a7a\u6587\u5b57\u5165\u3089\u306a\u3044\u306e\u3067NULL\u578b\n        }\n        if (checkDate(data)) {\n            dataType = 'N'; // Date\u578b\u306f\u306a\u3044\u306e\u3067\u6570\u5024\u4fdd\u5b58\n        }\n    }\n    if (is('Number', data)) {\n        dataType = 'N';\n    }\n    if (is('Boolean', data)) {\n        dataType = 'BOOL';\n    }\n    if (is('Date', data)) {\n        dataType = 'N'; // Date\u578b\u306f\u306a\u3044\u306e\u3067\u6570\u5024\u4fdd\u5b58\n    }\n    if (is('Array', data)) {\n        dataType = 'L';\n    }\n    if (is('Object', data)) {\n        dataType = 'M';\n    }\n\n    return dataType;\n};\n\n\n\n/**\n * \u65e5\u4ed8\u3092\u30d5\u30a9\u30fc\u30de\u30c3\u30c8\u3059\u308b\n * @param  {Date}   date     \u65e5\u4ed8\n * @param  {String} [format] \u30d5\u30a9\u30fc\u30de\u30c3\u30c8\n * @return {String}          \u30d5\u30a9\u30fc\u30de\u30c3\u30c8\u6e08\u307f\u65e5\u4ed8\n */\nvar formatDate = function (date, format) {\n    if (!format) format = \"YYYY-MM-DDThh:mm:ss.SSSZ\";\n    format = format.replace(/YYYY/g, date.getFullYear());\n    format = format.replace(/MM/g, ('0' + (date.getMonth() + 1)).slice(-2));\n    format = format.replace(/DD/g, ('0' + date.getDate()).slice(-2));\n    format = format.replace(/hh/g, ('0' + date.getHours()).slice(-2));\n    format = format.replace(/mm/g, ('0' + date.getMinutes()).slice(-2));\n    format = format.replace(/ss/g, ('0' + date.getSeconds()).slice(-2));\n    if (format.match(/S/g)) {\n        var milliSeconds = ('00' + date.getMilliseconds()).slice(-3);\n        var length = format.match(/S/g).length;\n        for (var i = 0; i < length; i++) format = format.replace(/S/, milliSeconds.substring(i, i + 1));\n    }\n    return format;\n};\n\n//\"YYYY-MM-DD'T'hh:mm:ss.SSS'Z'\"\u5f62\u5f0f\u306e\u65e5\u4ed8\u304b\u30c1\u30a7\u30c3\u30af\nvar checkDate = function (strDate) {\n\n    // \u30d5\u30a9\u30fc\u30de\u30c3\u30c8\u30c1\u30a7\u30c3\u30af\n    if (!strDate.match(/^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}\\.\\d{3}Z$/)) {\n        return false;\n    }\n\n    var date = strDate.split(\"T\")[0];\n    var time = strDate.split(\"T\")[1];\n\n    var dateArr = date.split(\"-\");\n    if (dateArr.length < 3) {\n        return false;\n    }\n\n    var year = Number(dateArr[0]);\n    var month = Number(dateArr[1] - 1);\n    var day = Number(dateArr[2]);\n\n    var timeArr = time.split(\":\");\n    if (timeArr.length < 3) {\n        return false;\n    }\n\n    var hour = Number(timeArr[0]);\n    var minute = Number(timeArr[1]);\n    var second = Number(timeArr[2].split(\".\")[0]);\n\n    // \u6b63\u3057\u3044\u65e5\u4ed8\u304b\u30c1\u30a7\u30c3\u30af\n    if (year >= 0 && month >= 0 && month <= 11 && day >= 1 && day <= 31) {\n        var date = new Date(year, month, day);\n        if (isNaN(date)) {\n            return false;\n        } else if (date.getFullYear() == year && date.getMonth() == month && date.getDate() == day) {\n\n            // \u6b63\u3057\u3044\u6642\u9593\u304b\u30c1\u30a7\u30c3\u30af\n            if (hour >= 0 && hour <= 23 && minute >= 0 && minute <= 59 && second >= 0 && second <= 59) {\n                return true;\n            }\n\n        }\n    }\n\n    return false;\n};\n\n// \u30e9\u30f3\u30c0\u30e0\u82f1\u6570\nvar randobet = function (n) {\n    var a = 'abcdefghijklmnopqrstuvwxyz' + 'ABCDEFGHIJKLMNOPQRSTUVWXYZ' + '0123456789';\n    a = a.split('');\n    var s = '';\n    for (var i = 0; i < n; i++) {\n        s += a[Math.floor(Math.random() * a.length)];\n    }\n    return s;\n};\n\n// objectId\u81ea\u52d5\u751f\u6210\uff08\u30ad\u30fc\uff09\nfunction convertNewData(data) {\n    var newdata = data;\n\n    if (data.objectId === void 0) {\n        newdata.objectId = randobet(10);\n    }\n\n    return newdata;\n}\n\nfunction convertNewDatas(datas) {\n    var newdatas = [];\n    for (var j = 0; j < datas.length; ++j) {\n        newdatas.push(convertNewData(datas[j]));\n    }\n\n    return newdatas;\n}\n\nfunction createCondition(param) {\n    var condition = {};\n\n    for (var key in param) {\n        condition.ComparisonOperator = key; // \u691c\u7d22\u6761\u4ef6\n        var p = prefix(param[key]);\n\n        if (p === 'N') {\n            param[key] = param[key].toString();\n        }\n        if (checkDate(param[key])) {\n            param[key] = new Date(param[key]).getTime().toString();\n            console.log(\"param[key]:\", param[key]);\n        }\n\n        var obj = {};\n        obj[p] = param[key];\n        condition.AttributeValueList = [obj]; // \u6bd4\u8f03\u5bfe\u8c61\n    }\n\n    return condition;\n\n}\n\n// \u6761\u4ef6\u6587\u4f5c\u6210\nfunction createConditions(where) {\n    var scanFilters = {};\n\n    for (var key in where) {\n        scanFilters[key] = createCondition(where[key]);\n    }\n\n    return scanFilters;\n}\n\nfunction getData(item){\n\n    for (var dataType in item) {\n        console.log(\"item:\",item,\"dataType:\",dataType);\n\n        if (dataType == \"S\") {\n            return item[dataType];\n        }\n        if (dataType == \"N\") {\n            // \u6570\u5b57\u306b\u5909\u63db\n            return Number(item[dataType]);\n        }\n        if (dataType == \"BOOL\") {\n            if (item[dataType] === true) {\n                return \"1\";\n            } else {\n                return \"0\";\n            }\n        }\n        if (dataType == \"NULL\") {\n            if (item[dataType] === true) {\n                // \u7a7a\u6587\u5b57\u306b\u5909\u63db\n                return \"\";\n            }\n        }\n\n        \n        if (dataType == \"M\") {\n            var value = {};\n            for(var key in item[dataType]){\n                value[key] = getData(item[dataType][key]);\n            }\n            return value;\n        }\n        if (dataType == \"L\") {\n            var value = [];\n            for(var i = 0;i < item[dataType].length;++i){\n                value.push(getData(item[dataType][i]));\n            }\n            return value;\n        }\n        \n\n    }\n    \n    return null;\n}\n\n\nfunction formatData(Item) {\n\n    var data = {};\n    console.log(\"Item:\",Item);\n\n    for (var key in Item) {\n        console.log(\"key:\",key);\n\n        var item = Item[key];                \n        data[key] = getData(item);\n    }\n\n    return data;\n}\n\n// Dynamo\u7d50\u679c\u30c7\u30fc\u30bf\u3092\u30d5\u30a9\u30fc\u30de\u30c3\u30c8\u3059\u308b\nfunction formatDatas(param) {\n\n    var Items = param;\n    var datas = [];\n\n    for (var i = 0; i < Items.length; ++i) {\n        var item = Items[i];\n        var data = formatData(item);\n        //console.log(\"data:\",data);\n\n        datas.push(data);\n    }\n\n    console.log(\"datas:\", JSON.stringify(datas));\n\n    return datas;\n}\n\n\n// \u30c7\u30fc\u30bf\u53d6\u5f97(scan)\nvar select = module.exports.select = function (event, cb) {\n\n    var table = event.table;\n\n    var condition = {};\n    if (event.param.where) {\n        condition.where = event.param.where;\n    }\n    if (event.param.order) {\n        condition.order = event.param.order;\n    }\n\n    var params = {\n        TableName: table,\n        ScanFilter: createConditions(condition.where)\n    };\n\n\n    if (event.lastEvaluatedKey) {\n        console.log(event.lastEvaluatedKey);\n        params.ExclusiveStartKey = event.lastEvaluatedKey; // \u7d9a\u304d\u304c\u3042\u308b\u5834\u5408\u306fnull\u3067\u306a\u3044\u305f\u3081\u3001\u7d9a\u304d\u304b\u3089\u691c\u7d22\u3059\u308b\u30ad\u30fc\u3092\u4ee3\u5165\n    }\n\n    console.log(\"params:\", JSON.stringify(params));\n\n    // \u982d\u304b\u3089\u5168\u6587\u691c\u7d22\uff08query\u691c\u7d22\u3067\u306a\u3044\u5834\u5408\u306f\u3053\u306e\u691c\u7d22\u3057\u304b\u306a\u3044\uff09\n    dynamodb.scan(params, function (err, data) {\n        if (err) {\n            console.error(err);\n            \n            return cb(err, {\n                message: 'scan failed',\n                status_cd: code.ErrorDB\n            });\n            \n        } else {\n            console.log(data);\n            var formatedData = formatDatas(data.Items);\n\n            // \u53d6\u5f97\u3057\u305f\u30c7\u30fc\u30bf\u3092\u8ffd\u52a0\u3059\u308b\n            if (event.lastEvaluatedData) {\n                formatedData.push(event.lastEvaluatedData);\n            }\n\n            // \u7d9a\u304d\u304c\u3042\u308b\u5834\u5408\u306flastEvaluatedKey\u304c\u53d6\u5f97\u3067\u304d\u308b\n            if (data.lastEvaluatedKey) {\n                event.lastEvaluatedData = formatedData;\n                event.lastEvaluatedKey = data.lastEvaluatedKey;\n                return select(event, cb);\n            }\n            \n            return cb(null, {\n                data: formatedData,\n                status_cd: code.Success\n            });\n\n        }\n\n\n\n    });\n};\n\n// \u30c7\u30fc\u30bf\u53d6\u5f97(query)\nvar query = module.exports.query = function (event, cb) {\n\n    var table = event.table;\n    var datas = event.param.data;\n    \n    if (!is('Array', datas)) {\n        datas = [datas];\n    }\n\n\n    var Ids = [];\n    for(var i=0;i<datas.length;++i){\n        var p = prefix(datas[i].objectId);\n        var obj = {};\n        obj[p] = datas[i].objectId;\n        var data = {\"objectId\": obj};        \n        Ids.push(data);\n    }\n\n    \n\n    var requestItems = {};\n    requestItems[table] = {\n        Keys:Ids\n    };\n    \n    var params = {\n        RequestItems: requestItems\n    };\n    \n    console.log(\"params:\",JSON.stringify(params));\n\n    // \u53d6\u5f97\u3067\u304d\u308b\u4e0a\u9650\u306f16MB\u307e\u3067\n    dynamodb.batchGetItem(params, function (err, data) {\n        \n        \n        if (err) {\n            console.error(err);\n            return cb(err, {\n                message: 'query failed',\n                status_cd: code.ErrorDB\n            });\n        } else {\n            console.log(data);            \n            var formatedData = formatDatas(data.Responses[table]);\n            \n            \n            return cb(null, {\n                data: formatedData,\n                status_cd: code.Success\n            });\n        }\n        \n    });\n};\n\nfunction createItem(data) {\n\n    var inputData = \"\";\n    if (is('Array', data)) {\n\n        inputData = [];\n\n        for (var inData in data) {\n            var value = createItem(data[inData]); // \u5165\u308c\u5b50\u306e\u30c7\u30fc\u30bf\u3092\u8fbf\u308b\n            inputData.push(value);\n        }\n    } else if (is('Object', data)) {\n        inputData = {};\n\n        for (var inData in data) {\n            var value = createItem(data[inData]); // \u5165\u308c\u5b50\u306e\u30c7\u30fc\u30bf\u3092\u8fbf\u308b\n            inputData[inData] = value;\n        }\n    } else {\n        inputData = data.toString();\n    }\n\n    if (is('String', data)) {\n        if (checkDate(data)) {\n            inputData = new Date(data).getTime().toString();\n        }\n    }\n\n\n    if (inputData.length === 0) {\n        inputData = true; // \u7a7a\u6587\u5b57\u5165\u3089\u306a\u3044\u306e\u3067NULL\u578b\u306etrue\n    }\n\n    var p = prefix(data);\n    var obj = {};\n    obj[p] = inputData;\n    return obj;\n}\n\n// \u4fdd\u5b58\u30c7\u30fc\u30bf\u4f5c\u6210\nfunction createItems(data) {\n\n    var item = {};\n    item.objectId = {\n        \"S\": data.objectId\n    }; // \u4e3b\u30ad\u30fc\u30d1\u30e9\u30e1\u30fc\u30bf\uff08HASH\u30ad\u30fc\u3001RANGE\u30ad\u30fc\uff09\u306f\u5fc5\u9808\u3001\u304b\u3064AutoIncrement\u6a5f\u80fd\u304c\u306a\u3044\u306e\u3067uuid\u751f\u6210\u3059\u308b\n    //item.range_key:{\"S\": \"somedata\"}, // \u4e3b\u30ad\u30fc\u30d1\u30e9\u30e1\u30fc\u30bf\uff08HASH\u30ad\u30fc\u3001RANGE\u30ad\u30fc\uff09\u306f\u5fc5\u9808\n\n\n    for (var key in data) {\n        if (key === 'objectId') {\n            continue;\n        }\n        if (key === 'delete_flag') {\n            continue;\n        }\n        if (key === 'createdAt') {\n            continue;\n        }\n        if (key === 'updatedAt') {\n            continue;\n        }\n\n\n        item[key] = createItem(data[key]);\n    }\n\n    item.delete_flag = {\n        \"BOOL\": (data.delete_flag == \"1\" || data.delete_flag == \"true\") ? true : false\n    };\n\n    var date = formatDate(new Date());\n    //console.log(\"date:\",date);\n    //console.log(\"date:\",checkDate(date));\n    // UNIX\u6642\u9593\u3067\u4fdd\u5b58\n    item.createdAt = {\n        \"N\": new Date(date).getTime().toString()\n    };\n    item.updatedAt = {\n        \"N\": new Date(date).getTime().toString()\n    };\n\n    return item;\n}\n\n\nfunction writeData(param) {\n    var deferred = Promise.defer();\n\n    // multi upsert(25\u9805\u76ee\u307e\u3067\u3057\u304b\u540c\u6642\u306b\u66f8\u304d\u8fbc\u3081\u306a\u3044)\n    dynamodb.batchWriteItem(param, function (err, data) {\n        if (err) {\n            console.error(err);\n            return deferred.reject(err); // .catch\n        } else {\n            console.log(data);\n        }\n\n        deferred.resolve(data); // then\n    });    \n\n\n    return deferred.promise; \n}\n\n\n\n// \u9805\u76ee\u4f5c\u6210\nvar upsert = module.exports.upsert = function (event, cb) {\n\n    var table = event.table;\n    var datas = event.param.data;\n\n    if (!is('Array', datas)) {\n        datas = [datas];\n    }\n    \n    // objectId\u304c\u306a\u3044\u5834\u5408\u306f\u751f\u6210\n    datas = convertNewDatas(datas);\n    //console.log(\"datas:\",datas);\n    \n    // 25\u9805\u76ee\u305a\u3064\u3057\u304b\u540c\u6642\u306b\u66f8\u304d\u8fbc\u3081\u306a\u3044\u306e\u3067\u5206\u5272\u3059\u308b\n    var MAX_WRITE = 25;\n    var count = datas.length/MAX_WRITE + 1;\n    var params = [];\n    \n    for(var i=0;i<count;++i){\n        var indexStart = i * MAX_WRITE;\n        var indexEnd = ((i + 1) * MAX_WRITE) > datas.length ? datas.length : ((i + 1) * MAX_WRITE);\n\n        var items = [];\n        for (var j = indexStart; j < indexEnd; ++j) {\n\n            var obj = {\n                PutRequest: {\n                    Item: createItems(datas[j])\n                }\n            };\n            //console.log(\"obj:\",JSON.stringify(obj));\n            items.push(obj);\n        }\n        \n        if(items.length === 0){\n            break;\n        }\n        \n        var requestItems = {};\n        requestItems[table] = items;\n        var param = {\n            RequestItems: requestItems\n        };\n\n        console.log(\"params:\", JSON.stringify(param));\n        console.log(\"--------------------\",i,\"---------------------\");\n\n        params.push(param);\n    }\n    \n    return params.reduce(function (promise, param) {\n        return promise.then(function () {\n            return writeData(param);\n        });\n    }, Promise.resolve())\n    .then(function(data){\n        return query(event,cb);\n    })\n    .catch(function(err){\n        console.error(err);\n        return cb(err, {\n            message: 'upsert failed',\n            status_cd: code.ErrorDB\n        });\n    });\n\n\n};\n\n// \u30c7\u30fc\u30bf\u4fdd\u5b58\nmodule.exports.save = function (event, cb) {\n\n    var table = event.table;\n    var datas = event.param.data;\n\n\n    // \u30c6\u30fc\u30d6\u30eb\u4e00\u89a7\u53d6\u5f97\n    dynamodb.listTables(function (err, data) {\n        console.log(data.TableNames);\n\n\n        var params = {\n            TableName: table,\n            // \u4e3b\u30ad\u30fc\u306e\u8a2d\u5b9a\n            KeySchema: [\n                {\n                    AttributeName: \"objectId\",\n                    KeyType: \"HASH\"\n                }, //HASH key\n                //{ AttributeName: \"range_key\", KeyType: \"RANGE\" }  //RANGE key \u5fc5\u8981\u306a\u3044\u5834\u5408\u306f\u8a2d\u5b9a\u3057\u306a\u3044\n            ],\n            AttributeDefinitions: [\n                {\n                    AttributeName: \"objectId\",\n                    AttributeType: \"S\"\n                },\n                //{ AttributeName: \"range_key\", AttributeType: \"S\" }\n            ],\n            // \u8aad\u307f\u8fbc\u307f\u66f8\u304d\u8fbc\u307f\u30ad\u30e3\u30d1\u30b7\u30c6\u30a3\n            ProvisionedThroughput: {\n                ReadCapacityUnits: 1,\n                WriteCapacityUnits: 1\n            }\n        };\n\n\n\n        // \u5b58\u5728\u3057\u3066\u3044\u308b\u304b\u306e\u30d5\u30e9\u30b0\n        var isCreated = false;\n        for (var i = 0; i < data.TableNames.length; ++i) {\n            if (data.TableNames[i] == table) {\n                isCreated = true;\n            }\n        }\n\n        // \u3059\u3067\u306b\u4f5c\u6210\u6e08\u307f\n        if (isCreated) {\n\n            // \u30c7\u30fc\u30bf\u4fdd\u5b58\n            return upsert(event, cb);\n\n        } else {\n            // \u30c6\u30fc\u30d6\u30eb\u4f5c\u6210\n            dynamodb.createTable(params, function (err, data) {\n                if (err) {\n                    console.error(err);\n                    return cb(err, {\n                        message: 'table create failed',\n                        status_cd: code.ErrorDB\n                    });\n\n                } else {\n                    console.log(data);\n\n                    var params = {\n                        TableName: table\n                    };\n                    // \u30c6\u30fc\u30d6\u30eb\u4f5c\u6210\u3092\u5f85\u3064\n                    dynamodb.waitFor('tableExists', params, function (err, data) {\n                        if (err) {\n                            console.error(err);\n                        } else {\n                            console.log(data);\n                        }\n                        // \u30c7\u30fc\u30bf\u4fdd\u5b58\n                        return upsert(event, cb);\n                    });\n\n                }\n            });\n        }\n\n    });\n\n};\n```\n\nsave\u95a2\u6570\u3092\u547c\u3073\u51fa\u3059Lambda\u3067\u3059\u3002\n\u30c6\u30fc\u30d6\u30eb\u304c\u306a\u3044\u5834\u5408\u306f\u30c6\u30fc\u30d6\u30eb\u3092\u4f5c\u6210\u3057\u3066\u9805\u76ee\u3092upsert\u3057\u307e\u3059\u3002\nobjectId\u3092\u30ad\u30fc\u3068\u3057\u3066\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n```\n'use strict';\n\nvar dynamo = require('dynamo');\n\nmodule.exports.handler = function(event, context) {\n    return dynamo.save(event, function(error, response) {\n        return context.done(error, response);\n    });\n};\n```\n\nselect\u95a2\u6570\u3092\u547c\u3073\u51fa\u3059Lambda\u3067\u3059\u3002\n\n```\n'use strict';\n\nvar dynamo = require('dynamo');\n\nmodule.exports.handler = function(event, context, cb) {\n    return dynamo.select(event, function(error, response) {\n        return context.done(error, response);\n    });\n};\n```\n\n\n# \u5b9f\u884c\u4f8b\n\nsave\u95a2\u6570\u306e\u5165\u529b\u30c7\u30fc\u30bf\u306b\u306f\u6b21\u306e\u3088\u3046\u306a\u30c7\u30fc\u30bf\u3092\u5165\u529b\u3059\u308b\u3068\u3057\u307e\u3059\u3002\n\u65e5\u6642\u306fUnix\u6642\u9593\u3067\u683c\u7d0d\u3057\u307e\u3059\u3002\uff08\u65e5\u4ed8\u578b\u304c\u306a\u3044\u305f\u3081\u3001\u5024\u6bd4\u8f03\u3067\u691c\u7d22\u3059\u308b\u305f\u3081\u306b\uff09\n\u7a7a\u6587\u5b57\u306fNULL\u306b\u5909\u63db\u3057\u307e\u3059\u3002\nObject\u578b\u3084Array\u578b\u306e\u30c7\u30fc\u30bf\u3082\u81ea\u52d5\u7684\u306b\u30c7\u30fc\u30bf\u578b\u3092\u6307\u5b9a\u3057\u3066\u3001\u4fdd\u5b58\u3067\u304d\u308b\u3088\u3046\u306b\u3057\u3066\u3044\u307e\u3059\u3002\n\n```event.json\n{\n    \"table\": \"Test\",\n    \"param\": {\n        \"data\":[ {\n            \"closeDate\": 1482918300000,\n            \"image\": {\n                \"url\": \"http://xxxx\",                \n                \"type\": \"File\",\n                \"inner\":[\"a\",\"b\",{\"test1\":\"l\"}]\n            },\n            \"test\":[\"a\",\"b\",\"c\"],\n            \"objectId\": \"6AaY8G9MUA\",\n            \"startDate\": 1459138980000,\n            \"text\": \"\u30c6\u30b9\u30c8\u3067\u3059\u3042\u3042\u3042\",\n            \"userType\": 1            \n        },{\n            \"closeDate\": 1482918300000,\n            \"image\": {\n                \"url\": \"http://yyyy\",\n                \"type\": \"File\",\n                \"inner\":[\"a\",\"b\",{\"test2\":\"l\"}]\n            },\n            \"test\":[\"a\",\"b\",\"c\"],\n            \"objectId\": \"6AaY8G9MUI\",\n            \"startDate\": 1459138980000,\n            \"text\": \"\u30c6\u30b9\u30c8\u3067\u3059\u3044\u3044\u3044\u3044\u3044\",\n            \"userType\": 0\n        }]\n    }\n\n}\n```\n\n\u5b9f\u884c\u7d50\u679c\n\n```\n$ sls function run\nServerless: Running dynamoSave...  \n[ 'FBbot-ifeel',\n  'LineBot',\n  'Test',\n  'appStartupLog',\n  'appVersion',\n  'authtest-myAuthenticationProject-cache',\n  'ifeel-News',\n  'ifeel-PopUp',\n  'ifeel-Product',\n  'ifeel-Question',\n  'ifeel-SideMenu' ]\nparams: {\"RequestItems\":{\"Test\":[{\"PutRequest\":{\"Item\":{\"objectId\":{\"S\":\"6AaY8G9MUA\"},\"closeDate\":{\"N\":\"1482918300000\"},\"image\":{\"M\":{\"url\":{\"S\":\"http://xxxx\"},\"type\":{\"S\":\"File\"},\"inner\":{\"L\":[{\"S\":\"a\"},{\"S\":\"b\"},{\"M\":{\"test1\":{\"S\":\"l\"}}}]}}},\"test\":{\"L\":[{\"S\":\"a\"},{\"S\":\"b\"},{\"S\":\"c\"}]},\"startDate\":{\"N\":\"1459138980000\"},\"text\":{\"S\":\"\u30c6\u30b9\u30c8\u3067\u3059\u3042\u3042\u3042\"},\"userType\":{\"N\":\"1\"},\"delete_flag\":{\"BOOL\":false},\"createdAt\":{\"N\":\"1470341935400\"},\"updatedAt\":{\"N\":\"1470341935400\"}}}},{\"PutRequest\":{\"Item\":{\"objectId\":{\"S\":\"6AaY8G9MUI\"},\"closeDate\":{\"N\":\"1482918300000\"},\"image\":{\"M\":{\"url\":{\"S\":\"http://yyyy\"},\"type\":{\"S\":\"File\"},\"inner\":{\"L\":[{\"S\":\"a\"},{\"S\":\"b\"},{\"M\":{\"test2\":{\"S\":\"l\"}}}]}}},\"test\":{\"L\":[{\"S\":\"a\"},{\"S\":\"b\"},{\"S\":\"c\"}]},\"startDate\":{\"N\":\"1459138980000\"},\"text\":{\"S\":\"\u30c6\u30b9\u30c8\u3067\u3059\u3044\u3044\u3044\u3044\u3044\"},\"userType\":{\"N\":\"0\"},\"delete_flag\":{\"BOOL\":false},\"createdAt\":{\"N\":\"1470341935401\"},\"updatedAt\":{\"N\":\"1470341935401\"}}}}]}}\n{ UnprocessedItems: {} }\nparams: {\"RequestItems\":{\"Test\":{\"Keys\":[{\"objectId\":{\"S\":\"6AaY8G9MUA\"}},{\"objectId\":{\"S\":\"6AaY8G9MUI\"}}]}}}\n{ Responses: { Test: [ [Object], [Object] ] },\n  UnprocessedKeys: {} }\ndatas: [{\"text\":\"\u30c6\u30b9\u30c8\u3067\u3059\u3044\u3044\u3044\u3044\u3044\",\"startDate\":1459138980000,\"closeDate\":1482918300000,\"test\":[\"a\",\"b\",\"c\"],\"objectId\":\"6AaY8G9MUI\",\"createdAt\":1470341935401,\"delete_flag\":\"0\",\"image\":{\"inner\":[\"a\",\"b\",{\"test2\":\"l\"}],\"type\":\"File\",\"url\":\"http://yyyy\"},\"userType\":0,\"updatedAt\":1470341935401},{\"text\":\"\u30c6\u30b9\u30c8\u3067\u3059\u3042\u3042\u3042\",\"startDate\":1459138980000,\"closeDate\":1482918300000,\"test\":[\"a\",\"b\",\"c\"],\"objectId\":\"6AaY8G9MUA\",\"createdAt\":1470341935400,\"delete_flag\":\"0\",\"image\":{\"inner\":[\"a\",\"b\",{\"test1\":\"l\"}],\"type\":\"File\",\"url\":\"http://xxxx\"},\"userType\":1,\"updatedAt\":1470341935400}]\nServerless: -----------------  \nServerless: Success! - This Response Was Returned:  \nServerless: {\n    \"data\": [\n        {\n            \"text\": \"\u30c6\u30b9\u30c8\u3067\u3059\u3044\u3044\u3044\u3044\u3044\",\n            \"startDate\": 1459138980000,\n            \"closeDate\": 1482918300000,\n            \"test\": [\n                \"a\",\n                \"b\",\n                \"c\"\n            ],\n            \"objectId\": \"6AaY8G9MUI\",\n            \"createdAt\": 1470341935401,\n            \"delete_flag\": \"0\",\n            \"image\": {\n                \"inner\": [\n                    \"a\",\n                    \"b\",\n                    {\n                        \"test2\": \"l\"\n                    }\n                ],\n                \"type\": \"File\",\n                \"url\": \"http://yyyy\"\n            },\n            \"userType\": 0,\n            \"updatedAt\": 1470341935401\n        },\n        {\n            \"text\": \"\u30c6\u30b9\u30c8\u3067\u3059\u3042\u3042\u3042\",\n            \"startDate\": 1459138980000,\n            \"closeDate\": 1482918300000,\n            \"test\": [\n                \"a\",\n                \"b\",\n                \"c\"\n            ],\n            \"objectId\": \"6AaY8G9MUA\",\n            \"createdAt\": 1470341935400,\n            \"delete_flag\": \"0\",\n            \"image\": {\n                \"inner\": [\n                    \"a\",\n                    \"b\",\n                    {\n                        \"test1\": \"l\"\n                    }\n                ],\n                \"type\": \"File\",\n                \"url\": \"http://xxxx\"\n            },\n            \"userType\": 1,\n            \"updatedAt\": 1470341935400\n        }\n    ],\n    \"status_cd\": 0\n}  \n```\n\n\u7dba\u9e97\u306b\u5165\u3063\u3066\u3044\u307e\u3059\u306d\u3002\n![\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2016-07-19 19.00.01.png](https://qiita-image-store.s3.amazonaws.com/0/55077/f05b3e98-b88e-3fec-5e1e-caf3d368f916.png)\n\n\n\n\u6b21\u306bselect\u95a2\u6570\u3067\u30c7\u30fc\u30bf\u3092\u53d6\u5f97\u3057\u307e\u3059\u3002\nwhere\u306e\u4e2d\u306e\u30c7\u30fc\u30bf\u306fDynamoDB\u306e\u691c\u7d22\u6761\u4ef6\u3067scan\u691c\u7d22\u3057\u3066\u307e\u3059\u3002\n\n```\n{\n    \"table\": \"Test\",\n    \"param\": {\n        \"where\": {\n            \"startDate\": {\n                \"LT\": 1468391572000\n            },\n            \"closeDate\": {\n                \"GT\": 1468391572000\n            },\n            \"userType\":{\n                \"EQ\":1\n            }\n        }\n        \n    }\n}\n```\n\n\u5b9f\u884c\u7d50\u679c\u306f\u3064\u304e\u306e\u3088\u3046\u306b\u306a\u308a\u307e\u3059\u3002\n\n```\n$ sls function run\nServerless: Running dynamoSelect...  \nparams: {\"TableName\":\"Test\",\"ScanFilter\":{\"startDate\":{\"ComparisonOperator\":\"LT\",\"AttributeValueList\":[{\"N\":\"1468391572000\"}]},\"closeDate\":{\"ComparisonOperator\":\"GT\",\"AttributeValueList\":[{\"N\":\"1468391572000\"}]},\"userType\":{\"ComparisonOperator\":\"EQ\",\"AttributeValueList\":[{\"N\":\"1\"}]}}}\n{\"Items\":[{\"text\":{\"S\":\"\u30c6\u30b9\u30c8\u3067\u3059\u3042\u3042\u3042\"},\"startDate\":{\"N\":\"1459138980000\"},\"closeDate\":{\"N\":\"1482918300000\"},\"test\":{\"L\":[{\"S\":\"a\"},{\"S\":\"b\"},{\"S\":\"c\"}]},\"objectId\":{\"S\":\"6AaY8G9MUA\"},\"createdAt\":{\"N\":\"1468954205204\"},\"delete_flag\":{\"BOOL\":false},\"image\":{\"M\":{\"inner\":{\"L\":[{\"S\":\"a\"},{\"S\":\"b\"},{\"M\":{\"test1\":{\"S\":\"l\"}}}]},\"type\":{\"S\":\"File\"},\"url\":{\"S\":\"http://xxxx\"}}},\"userType\":{\"N\":\"1\"},\"updatedAt\":{\"N\":\"1468954205204\"}}],\"Count\":1,\"ScannedCount\":2}\ndatas: [{\"text\":\"\u30c6\u30b9\u30c8\u3067\u3059\u3042\u3042\u3042\",\"startDate\":1459138980000,\"closeDate\":1482918300000,\"test\":[\"a\",\"b\",\"c\"],\"objectId\":\"6AaY8G9MUA\",\"createdAt\":1468954205204,\"delete_flag\":\"0\",\"image\":{\"inner\":[\"a\",\"b\",{\"test1\":\"l\"}],\"type\":\"File\",\"url\":\"http://xxxx\"},\"userType\":1,\"updatedAt\":1468954205204}]\nServerless: -----------------  \nServerless: Success! - This Response Was Returned:  \nServerless: {\n    \"data\": [\n        {\n            \"text\": \"\u30c6\u30b9\u30c8\u3067\u3059\u3042\u3042\u3042\",\n            \"startDate\": 1459138980000,\n            \"closeDate\": 1482918300000,\n            \"test\": [\n                \"a\",\n                \"b\",\n                \"c\"\n            ],\n            \"objectId\": \"6AaY8G9MUA\",\n            \"createdAt\": 1468954205204,\n            \"delete_flag\": \"0\",\n            \"image\": {\n                \"inner\": [\n                    \"a\",\n                    \"b\",\n                    {\n                        \"test1\": \"l\"\n                    }\n                ],\n                \"type\": \"File\",\n                \"url\": \"http://xxxx\"\n            },\n            \"userType\": 1,\n            \"updatedAt\": 1468954205204\n        }\n    ],\n    \"status_cd\": 0\n}  \n```\n\n\u7d20\u76f4\u306aJSON\u5f62\u5f0f\u3067\u8fd4\u305b\u307e\u3057\u305f\u3002\n\n\n# \u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u306f\uff1f\n\u5168\u30b9\u30ad\u30e3\u30f3\u3067\u3082\u4e26\u5217\u51e6\u7406\u3067\u691c\u7d22\u304b\u3051\u308c\u3070\u3001\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u304c\u3067\u308b\u3088\u3046\u3067\u3059\u3002\n\n\u53c2\u8003\uff1a[\u300c\u4e26\u5217\u30b9\u30ad\u30e3\u30f3\u300d\u3067\u30c6\u30fc\u30d6\u30eb\u8aad\u307f\u53d6\u308a\u901f\u5ea6\u3092\u5411\u4e0a\u3055\u305b\u308b](http://www.atmarkit.co.jp/ait/articles/1501/15/news025_3.html)\n\n\u624b\u3063\u53d6\u308a\u65e9\u304f\u901f\u5ea6\u3042\u3052\u305f\u3044\u5834\u5408\u306f\u6599\u91d1\u306f\u3042\u304c\u308a\u307e\u3059\u304c\u3001\u8a2d\u5b9a\u3067\u4e0b\u8a18\u306e\u30c6\u30fc\u30d6\u30eb\u306e\u30e6\u30cb\u30c3\u30c8\u6570\u3092\u5897\u3084\u305b\u3070\u826f\u3044\u3067\u3057\u3087\u3046\u3002\n\n* \u8aad\u307f\u8fbc\u307f\u5bb9\u91cf\u30e6\u30cb\u30c3\u30c8\n* \u66f8\u304d\u8fbc\u307f\u5bb9\u91cf\u30e6\u30cb\u30c3\u30c8\n\n\n# \u8907\u6570\u30c6\u30fc\u30d6\u30eb\u66f8\u304d\u8fbc\u307f\u306e\u30c8\u30e9\u30f3\u30b6\u30af\u30b7\u30e7\u30f3\u306f\uff1f\nDynamo\u30b9\u30c8\u30ea\u30fc\u30e0\u306e\u6a5f\u80fd\u3092\u4f7f\u3048\u3070\u3001\u30c6\u30fc\u30d6\u30eb\u66f8\u304d\u8fbc\u307f\u6642\u306b\u9023\u52d5\u3057\u3066\u3055\u3089\u306bLambda\u95a2\u6570\u3092\u30ad\u30c3\u30af\u3067\u304d\u308b\u3088\u3046\u3067\u3059\u3002\n\u3053\u308c\u3092\u4f7f\u3048\u3070\u8907\u6570\u30c6\u30fc\u30d6\u30eb\u306b\u4e00\u62ec\u51e6\u7406\u3055\u305b\u308b\u3053\u3068\u306f\u53ef\u80fd\u306b\u306a\u308b\u3067\u3057\u3087\u3046\u3002\n\uff08\u4eca\u56de\u306f\u3053\u3053\u307e\u3067\u3084\u3063\u3066\u3044\u307e\u305b\u3093\u3002\u3066\u304b\u30ed\u30fc\u30eb\u30d0\u30c3\u30af\u3068\u304b\u3069\u3046\u306a\u308b\u3093\u3060\u308d\uff1f\uff09\n", "tags": ["AWS", "DynamoDB", "serverless"]}