{"context": "\n\n1. \u306f\u3058\u3081\u306b\n\nOpsWorks Instances \u3067\u8d77\u52d5\u3057\u305f EC2 \u3092\u30a4\u30e1\u30fc\u30b8\uff08AMI\uff09\u5316\u3057\u3066\u3001\u305d\u308c\u3092 OpsWorks Instances \u306e\u30ab\u30b9\u30bf\u30e0AMI\u3068\u3057\u3066\u5229\u7528\u3059\u308b\u969b\u306e\u6ce8\u610f\u70b9\u3002\nEC2\u306f\u3001\"Amazon Linux 2016.09\", \"Amazon Linux instance Chef 12 stack\", \"Amazon EBS-backed\" \u3067\u4f5c\u6210\u3057\u3066\u3044\u308b\u3002\n\u4e0b\u8a18\u306e\u4f5c\u6cd5\u306e\u901a\u308a\u306b\u4f5c\u6210\u3057\u3066\u3044\u306a\u3044\u30ab\u30b9\u30bf\u30e0AMI\u3092\u5229\u7528\u3057\u3066 OpsWorks Instances \u3067 EC2 \u3092\u8d77\u52d5\u3059\u308b\u3068\u3001Status \u304c \"running_setup\" \u4e2d\u306e\u307e\u307e\u3068\u306a\u308a\u3001\u4f5c\u6210\u304c\u5b8c\u4e86\u3057\u306a\u3044\u3002\n\n\n2. OpsWorks Instances \u3067\u8d77\u52d5\u3057\u305f EC2 \u304b\u3089 \u30ab\u30b9\u30bf\u30e0AMI \u3092\u4f5c\u6210\u3059\u308b\n\uff08\u53c2\u8003\uff1a\u672c\u5bb6\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8 \u2192\u3000\"To create a custom AMI from an AWS OpsWorks instance\"\uff09\n* AMI \u3092\u4f5c\u6210\u3059\u308b EC2 \u3092\u8d77\u52d5\u3057\u305f OpwsWorks Layers \u306e \"Auto healing enabled\" \u3092 \"No\" \u3078\u5909\u66f4\u3059\u308b\n\nAMI \u3092\u4f5c\u6210\u3059\u308b EC2 \u3078 SSH \u30ed\u30b0\u30a4\u30f3\u3057\u3066\u3001\u6b21\u306e\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3059\u308b\n\n$ sudo /etc/init.d/monit stop\n\n$ sudo /etc/init.d/opsworks-agent stop\n\n$ sudo rm -rf /etc/aws/opsworks/\n$ sudo rm -rf /opt/aws/opsworks/\n$ sudo rm -rf /var/log/aws/opsworks/\n$ sudo rm -rf /var/lib/aws/opsworks/\n$ sudo rm -rf /var/lib/cloud/\n$ sudo rm -rf /etc/chef\n$ sudo rm -rf /var/chef\n$ sudo rm -rf /opt/chef\n$ sudo rm -f /etc/monit.d/opsworks-agent.monitrc\n$ sudo rm -f /etc/monit/conf.d/opsworks-agent.monitrc\n\n$ sudo rpm -e opsworks-agent-ruby\n$ sudo rpm -e chef\n\n\nOpsWorks \u306e\u30b3\u30f3\u30d1\u30cd\u304b\u3089\u3001AMI \u3092\u4f5c\u6210\u3059\u308b EC2 \u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u505c\u6b62(Actions:stop)\u3059\u308b\n\u2193\nStatus \u304c stopped \u3068\u306a\u3063\u305f\u3053\u3068\u3092\u78ba\u8a8d\n\u30a4\u30e1\u30fc\u30b8\uff08AMI\uff09\u3092\u4f5c\u6210\u3059\u308b\n\n\n3. OpsWorks Instance \u3067\u30ab\u30b9\u30bf\u30e0AMI \u304b\u3089 EC2 \u3092\u8d77\u52d5\u3059\u308b CloudFormation \u306e\u4f8b\n\"Resources\": {\n    \"OpsWorksStack\": {\n        \"Type\": \"AWS::OpsWorks::Stack\",\n        \"Properties\": {\n            \"Name\": \"example\",\n            \"ConfigurationManager\": {\n                \"Name\": \"Chef\",\n                \"Version\": \"12\"\n            },\n            \"VpcId\": \"vpc-********\",\n            \"DefaultSubnetId\": \"subnet-********\",\n            \"DefaultInstanceProfileArn\": \"arn:aws:iam::************:instance-profile/**********\",\n            \"ServiceRoleArn\": \"arn:aws:iam::************:role/**********\",\n            \"DefaultOs\": \"Custom\",\n            \"DefaultRootDeviceType\": \"ebs\",\n            \"DefaultSshKeyName\": \"aws-tonishy\",\n            \"HostnameTheme\": \"Layer_Dependent\",\n            \"UseOpsworksSecurityGroups\": \"false\"\n        }\n    },\n    \"OpsWorksLayer\": {\n        \"Type\": \"AWS::OpsWorks::Layer\",\n        \"Properties\": {\n            \"Type\": \"custom\",\n            \"Name\": \"example\",\n            \"Shortname\": \"example\",\n            \"StackId\": {\n                \"Ref\": \"OpsWorksStack\"\n            },\n            \"EnableAutoHealing\": \"true\",\n            \"AutoAssignPublicIps\": \"true\",\n            \"AutoAssignElasticIps\": \"false\",\n            \"CustomSecurityGroupIds\": [\n                \"sg-********\"\n            ],\n            \"CustomInstanceProfileArn\": \"arn:aws:iam::************:instance-profile/**********\"\n        }\n    },\n    \"OpsWorksInstance\": {\n        \"Type\": \"AWS::OpsWorks::Instance\",\n        \"Properties\": {\n            \"AmiId\": \"ami-********\",\n            \"Os\": \"Custom\",\n            \"StackId\": {\n                \"Ref\": \"OpsWorksStack\"\n            },\n            \"LayerIds\": [\n                {\n                    \"Ref\": \"OpsWorksLayer\"\n                }\n            ],\n            \"InstanceType\": \"t2.micro\"\n        }\n    }\n}\n\n\u203b AWS::OpsWorks::Instance\u3000\u306e AmiId \u306b\u3001\u30ab\u30b9\u30bf\u30e0AMI\u306e id \u3092\u8a2d\u5b9a\u3059\u308b\n#1. \u306f\u3058\u3081\u306b\n* OpsWorks Instances \u3067\u8d77\u52d5\u3057\u305f EC2 \u3092\u30a4\u30e1\u30fc\u30b8\uff08AMI\uff09\u5316\u3057\u3066\u3001\u305d\u308c\u3092 OpsWorks Instances \u306e\u30ab\u30b9\u30bf\u30e0AMI\u3068\u3057\u3066\u5229\u7528\u3059\u308b\u969b\u306e\u6ce8\u610f\u70b9\u3002\n* EC2\u306f\u3001\"Amazon Linux 2016.09\", \"Amazon Linux instance Chef 12 stack\", \"Amazon EBS-backed\" \u3067\u4f5c\u6210\u3057\u3066\u3044\u308b\u3002\n* \u4e0b\u8a18\u306e\u4f5c\u6cd5\u306e\u901a\u308a\u306b\u4f5c\u6210\u3057\u3066\u3044\u306a\u3044\u30ab\u30b9\u30bf\u30e0AMI\u3092\u5229\u7528\u3057\u3066 OpsWorks Instances \u3067 EC2 \u3092\u8d77\u52d5\u3059\u308b\u3068\u3001Status \u304c \"running_setup\" \u4e2d\u306e\u307e\u307e\u3068\u306a\u308a\u3001\u4f5c\u6210\u304c\u5b8c\u4e86\u3057\u306a\u3044\u3002\n\n#2. OpsWorks Instances \u3067\u8d77\u52d5\u3057\u305f EC2 \u304b\u3089 \u30ab\u30b9\u30bf\u30e0AMI \u3092\u4f5c\u6210\u3059\u308b\n\uff08\u53c2\u8003\uff1a[\u672c\u5bb6\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8](http://docs.aws.amazon.com/opsworks/latest/userguide/workinginstances-custom-ami.html) \u2192\u3000\"To create a custom AMI from an AWS OpsWorks instance\"\uff09\n* AMI \u3092\u4f5c\u6210\u3059\u308b EC2 \u3092\u8d77\u52d5\u3057\u305f OpwsWorks Layers \u306e \"Auto healing enabled\" \u3092 \"No\" \u3078\u5909\u66f4\u3059\u308b\n\n* AMI \u3092\u4f5c\u6210\u3059\u308b EC2 \u3078 SSH \u30ed\u30b0\u30a4\u30f3\u3057\u3066\u3001\u6b21\u306e\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3059\u308b\n\n```\n$ sudo /etc/init.d/monit stop\n\n$ sudo /etc/init.d/opsworks-agent stop\n\n$ sudo rm -rf /etc/aws/opsworks/\n$ sudo rm -rf /opt/aws/opsworks/\n$ sudo rm -rf /var/log/aws/opsworks/\n$ sudo rm -rf /var/lib/aws/opsworks/\n$ sudo rm -rf /var/lib/cloud/\n$ sudo rm -rf /etc/chef\n$ sudo rm -rf /var/chef\n$ sudo rm -rf /opt/chef\n$ sudo rm -f /etc/monit.d/opsworks-agent.monitrc\n$ sudo rm -f /etc/monit/conf.d/opsworks-agent.monitrc\n\n$ sudo rpm -e opsworks-agent-ruby\n$ sudo rpm -e chef\n```\n\n* OpsWorks \u306e\u30b3\u30f3\u30d1\u30cd\u304b\u3089\u3001AMI \u3092\u4f5c\u6210\u3059\u308b EC2 \u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u505c\u6b62(Actions:stop)\u3059\u308b\n\u2193\nStatus \u304c stopped \u3068\u306a\u3063\u305f\u3053\u3068\u3092\u78ba\u8a8d\n\n* \u30a4\u30e1\u30fc\u30b8\uff08AMI\uff09\u3092\u4f5c\u6210\u3059\u308b\n\n#3. OpsWorks Instance \u3067\u30ab\u30b9\u30bf\u30e0AMI \u304b\u3089 EC2 \u3092\u8d77\u52d5\u3059\u308b CloudFormation \u306e\u4f8b\n```\n\"Resources\": {\n    \"OpsWorksStack\": {\n        \"Type\": \"AWS::OpsWorks::Stack\",\n        \"Properties\": {\n            \"Name\": \"example\",\n            \"ConfigurationManager\": {\n                \"Name\": \"Chef\",\n                \"Version\": \"12\"\n            },\n            \"VpcId\": \"vpc-********\",\n            \"DefaultSubnetId\": \"subnet-********\",\n            \"DefaultInstanceProfileArn\": \"arn:aws:iam::************:instance-profile/**********\",\n            \"ServiceRoleArn\": \"arn:aws:iam::************:role/**********\",\n            \"DefaultOs\": \"Custom\",\n            \"DefaultRootDeviceType\": \"ebs\",\n            \"DefaultSshKeyName\": \"aws-tonishy\",\n            \"HostnameTheme\": \"Layer_Dependent\",\n            \"UseOpsworksSecurityGroups\": \"false\"\n        }\n    },\n    \"OpsWorksLayer\": {\n        \"Type\": \"AWS::OpsWorks::Layer\",\n        \"Properties\": {\n            \"Type\": \"custom\",\n            \"Name\": \"example\",\n            \"Shortname\": \"example\",\n            \"StackId\": {\n                \"Ref\": \"OpsWorksStack\"\n            },\n            \"EnableAutoHealing\": \"true\",\n            \"AutoAssignPublicIps\": \"true\",\n            \"AutoAssignElasticIps\": \"false\",\n            \"CustomSecurityGroupIds\": [\n                \"sg-********\"\n            ],\n            \"CustomInstanceProfileArn\": \"arn:aws:iam::************:instance-profile/**********\"\n        }\n    },\n    \"OpsWorksInstance\": {\n        \"Type\": \"AWS::OpsWorks::Instance\",\n        \"Properties\": {\n            \"AmiId\": \"ami-********\",\n            \"Os\": \"Custom\",\n            \"StackId\": {\n                \"Ref\": \"OpsWorksStack\"\n            },\n            \"LayerIds\": [\n                {\n                    \"Ref\": \"OpsWorksLayer\"\n                }\n            ],\n            \"InstanceType\": \"t2.micro\"\n        }\n    }\n}\n```\n\n\u203b AWS::OpsWorks::Instance\u3000\u306e AmiId \u306b\u3001\u30ab\u30b9\u30bf\u30e0AMI\u306e id \u3092\u8a2d\u5b9a\u3059\u308b\n", "tags": ["opsworks", "CloudFormation", "AWS"]}