{"context": "\u8cc7\u7523\u72b6\u6cc1\u3092\u7c21\u5358\u306b\u30b0\u30e9\u30d5\u5316\u51fa\u6765\u306a\u3044\u304b\u3068\u8003\u3048\u3066\u6311\u6226\u3002\u5bb6\u8a08\u7c3f\u30b5\u30fc\u30d3\u30b9\u306e\u4e2d\u3067\u3082Zaim\u306fAPI\u3092\u516c\u958b\u3057\u3066\u304a\u308a\u3001json\u3067\u30c7\u30fc\u30bf\u306e\u53d6\u5f97\u304c\u3067\u304d\u308b\u3002\u3053\u308c\u3092Python\u3092\u4f7f\u3063\u3066\u53d6\u5f97\u3057\u3001\u52c9\u5f37\u3082\u517c\u306d\u3066Amazon Elasticsearch Service\u3078\u6295\u5165\u3059\u308b\u5f62\u3067\u30b0\u30e9\u30d5\u5316\u3092\u5b9f\u73fe\u3057\u3066\u307f\u305f\u3002\u306a\u304a\u3001\u5927\u91cf\u306ejson\u306e\u6295\u5165\u306b\u306f\u305b\u3063\u304b\u304f\u306a\u306e\u3067Elastic\u88fd\u306elogstash\u306b\u6311\u6226\u3057\u3066\u3044\u308b\u3002\n\nAmazon Elasticsearch Service\nAWS\u306e\u63d0\u4f9b\u3059\u308bElasticsearch\u306e\u30de\u30cd\u30fc\u30b8\u30c9\u30b5\u30fc\u30d3\u30b9\u3002\u30d0\u30fc\u30b8\u30e7\u30f3\u304c\u6700\u65b0\u3088\u308a\u82e5\u5e72\u53e4\u3044\u3082\u306e\u3067\u63d0\u4f9b\u3055\u308c\u3066\u3044\u308b\u306e\u304c\u30cd\u30c3\u30af\u3067\u306f\u3042\u308b\u304c\u3001\u6700\u3082\u7c21\u5358\u304b\u3064\u9ad8\u901f\u306bElasticsearch\u3092\u4f7f\u3048\u308b\u624b\u6bb5\u306e\u4e00\u3064\u304b\u3068\u3002Kibana\u3082\u30c7\u30d5\u30a9\u30eb\u30c8\u3067\u63d0\u4f9b\u3055\u308c\u308b\u3002\n\u7279\u306b\u8a2d\u5b9a\u4e0a\u96e3\u3057\u3044\u7b87\u6240\u306f\u306a\u3044\u306e\u3067\u3001Web\u30b3\u30f3\u30bd\u30fc\u30eb\u304b\u3089\u3055\u304f\u3055\u304f\u3068\u4f5c\u6210\u3059\u308b\u3002\u30a2\u30af\u30bb\u30b9\u5236\u5fa1\u306e\u30dd\u30ea\u30b7\u30fc\u306f\u4eca\u56deIP\u306b\u3088\u308b\u8a31\u53ef\u3092\u884c\u306a\u3063\u305f\u3002\u3053\u308c\u306fElasticsearch\u3060\u3051\u3067\u306f\u306a\u304f\u3001Kibana\u306e\u30a2\u30af\u30bb\u30b9\u5236\u5fa1\u3067\u3082\u3042\u308b\u306e\u3067\u3001\u4f8b\u3048\u3070\u30c7\u30fc\u30bf\u6295\u5165\u306f\u30af\u30e9\u30a6\u30c9\u4e0a\u306e\u30b5\u30fc\u30d0\u30fc\u304b\u3089\u884c\u3044\u3001Kibana\u306e\u78ba\u8a8d\u306f\u30ed\u30fc\u30ab\u30ebPC\u3067\u884c\u3046\u3088\u3046\u306a\u5834\u5408\u306b\u306f\u3001\u305d\u308c\u305e\u308cIP\u3092\u6307\u5b9a\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u3002\n{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Sid\": \"\",\n      \"Effect\": \"Allow\",\n      \"Principal\": {\n        \"AWS\": \"*\"\n      },\n      \"Action\": \"es:*\",\n      \"Resource\": \"arn:aws:es:ap-northeast-1:xxxxx:domain/xxxxx/*\",\n      \"Condition\": {\n        \"IpAddress\": {\n          \"aws:SourceIp\": [\n            \"xx.xx.xx.xx\"\n          ]\n        }\n      }\n    }\n  ]\n}\n\n\nZaim API via Python\nZaim API\u3092\u53e9\u304f\u306e\u306b\u306fPython\u306erequests\u3092\u4f7f\u7528\u3057\u305f\u3002\u66f8\u304d\u65b9\u306frequests\u306e\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u3092\u53c2\u8003\u306b\u3057\u3066\u3044\u308b\u3002\n\nOAuth 1 Workflow \u2014 Requests-OAuthlib 0.6.1 documentation\n\n\nget_zaim.py\n# coding: utf-8\nimport requests\nfrom requests_oauthlib import OAuth1Session\nfrom requests_oauthlib import OAuth1\n\nconsumer_key = u\"XXXXX\"\nconsumer_secret = u\"XXXXX\"\n\nrequest_token_url = u\"https://api.zaim.net/v2/auth/request\"\nauthorize_url = u\"https://www.zaim.net/users/auth\"\naccess_token_url = u\"https://api.zaim.net/v2/auth/access\"\ncallback_uri = u\"http://chroju.net/\"\nget_money_url = u\"https://api.zaim.net/v2/home/money\"\n\ndef oauth_requests():\n    auth = OAuth1Session(consumer_key, client_secret=consumer_secret, callback_uri=callback_uri)\n    r = auth.fetch_request_token(request_token_url)\n    resource_owner_key = r.get('oauth_token')\n    resource_owner_secret = r.get('oauth_token_secret')\n\n    authorization_url = auth.authorization_url(authorize_url)\n    print 'Please go here and authorize,', authorization_url\n    redirect_response = raw_input('Paste the full redirect URL here:')\n    oauth_response = auth.parse_authorization_response(redirect_response)\n    verifier = oauth_response.get('oauth_verifier')\n\n    auth = OAuth1Session(client_key=consumer_key, client_secret=consumer_secret, resource_owner_key=resource_owner_key, resource_owner_secret=resource_owner_secret, verifier=verifier)\n    oauth_token = auth.fetch_access_token(access_token_url)\n\n    resource_owner_key = oauth_token.get('oauth_token')\n    resource_owner_secret = oauth_token.get('oauth_token_secret')\n\n    get_json(resource_owner_key, resource_owner_secret)\n\ndef get_json(resource_owner_key, resource_owner_secret):\n    headeroauth = OAuth1(consumer_key, consumer_secret, resource_owner_key, resource_owner_secret, signature_type='auth_header')\n    r = requests.get(get_money_url, auth=headeroauth)\n    print r.content\n\nif __name__ == \"__main__\":\n  oauth_requests()\n\n\n\u3053\u308c\u3092\u5b9f\u884c\u3059\u308b\u3068json\u3067\u611a\u76f4\u306b\u5bb6\u8a08\u7c3f\u30c7\u30fc\u30bf\u304c\u51fa\u529b\u3055\u308c\u308b\u306e\u3067\u3001jq\u3092\u4ecb\u3057\u3066\u6574\u5f62\u3057\u305f\u4e0a\u3067\u30d5\u30a1\u30a4\u30eb\u3078\u4fdd\u5b58\u3057\u3066\u304a\u304f\u3002\n$ python27 get_zaim.py | jq > zaim.json\n\n\nElasticsearch\n\nmapping\n\u4e00\u5ea6Amazon ES\u3092\u7acb\u3061\u4e0a\u3052\u308c\u3070\u3001\u305d\u306e\u5f8c\u306e\u5229\u7528\u65b9\u6cd5\u306f\u901a\u5e38\u306eElasticsearch\u540c\u69d8\u3002\u307e\u305azaim API\u3067\u53d6\u5f97\u3067\u304d\u308bjson\u30d5\u30a1\u30a4\u30eb\u306e\u66f8\u5f0f\u306b\u5408\u308f\u305b\u3001mapping\u3092\u3042\u3089\u304b\u3058\u3081\u884c\u3046\u3002\n$ curl -XPUT \"http://xxx.ap-northeast-1.es.amazonaws.com/lifelog\" -d '\n{\"mappings\" : {\n\"zaim\" : {\n\"properties\" : {\n\"id\" : { \"type\" : \"integer\"},\n\"user_id\" : { \"type\" : \"integer\"},\n\"date\" : { \"type\" : \"date\", \"format\" : \"yyyy-MM-dd\"},\n\"mode\" : { \"type\" : \"string\" },\n\"category_id\" : { \"type\" : \"integer\" },\n\"genre_id\" : { \"type\" : \"integer\" },\n\"from_account_id\" : {\"type\" : \"integer\"},\n\"to_account_id\" : {\"type\" : \"integer\"},\n\"amount\" : {\"type\" : \"integer\"},\n\"comment\" : {\"type\" : \"string\"},\n\"active\" : {\"type\" : \"integer\"},\n\"created\" : {\"type\" : \"date\", \"format\" : \"yyyy-MM-dd HH:mm:ss\"},\n\"currency_code\" : {\"type\" : \"string\"},\n\"name\" : {\"type\" : \"string\"},\n\"receipt_id\" : {\"type\" : \"integer\"},\n\"place_uid\" : {\"type\" : \"integer\"},\n\"place\" : {\"type\" : \"string\"},\n\"path\" : {\"type\":\"string\"}\n}\n}\n}\n}'\n\nmapping\u8a2d\u5b9a\u304c\u554f\u984c\u306a\u3044\u3053\u3068\u3092\u78ba\u8a8d\u3002\n$ curl -XGET \"http://xxx.ap-northeast-1.es.amazonaws.com/lifelog/_mapping\" | jq\n  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current\n                                 Dload  Upload   Total   Spent    Left  Speed\n100   733  100   733    0     0  58050      0 --:--:-- --:--:-- --:--:-- 61083\n{\n  \"lifelog\": {\n    \"mappings\": {\n      \"zaim\": {\n        \"properties\": {\n          \"@timestamp\": {\n            \"type\": \"date\",\n            \"format\": \"dateOptionalTime\"\n...\n\n\nlogstash\nElasticsearch\u306b\u8907\u6570\u306ejson\u3092\u540c\u6642\u306b\u6295\u5165\u3059\u308b\u306b\u306f\u3001\u304a\u305d\u3089\u304fbulk API\u3092\u5229\u7528\u3059\u308b\u306e\u304c\u6700\u3082\u4e00\u822c\u7684\u3067\u3042\u308b\u3002\u3057\u304b\u3057bulk API\u3067\u6295\u5165\u3059\u308bjson\u306f\u3001\u30c7\u30fc\u30bf\u90e8\u5206\u3068index\u3092\u4ea4\u4e92\u306b\u8a18\u8ff0\u3057\u305f\u3082\u306e\u3068\u3057\u306a\u304f\u3066\u306f\u306a\u3089\u306a\u3044\u305f\u3081\u3001\u4eca\u56de\u306e\u3088\u3046\u306bAPI\u3067\u4e00\u62ec\u53d6\u5f97\u3057\u305fjson\u3092\u6d41\u3059\u306b\u306f\u5411\u3044\u3066\u3044\u306a\u3044\u3002\n\u4ee3\u66ff\u624b\u6bb5\u3068\u3057\u3066\u306ffluentd\u306a\u3069\u3092\u5229\u7528\u3059\u308b\u624b\u6cd5\u3082\u3042\u308b\u304c\u3001Elastic\u793e\u304c\u63d0\u4f9b\u3057\u3066\u3044\u308b\u3068\u3044\u3046\u3053\u3068\u3067 logstash \u3092\u6d3b\u7528\u3057\u3066\u307f\u305f\u3002logstash\u306ffluentd\u3068\u4f3c\u305f\u30b9\u30c8\u30ea\u30fc\u30e0\u30c7\u30fc\u30bf\u306e\u89e3\u6790\u3001\u51e6\u7406\u3092\u884c\u3046\u305f\u3081\u306e\u30c4\u30fc\u30eb\u3002\u7279\u306bElasticsearch\u5c02\u7528\u3068\u3044\u3046\u308f\u3051\u3067\u306f\u306a\u304f\u3001\u4f8b\u3048\u3070Datadog\u3084influxDB\u3078\u30c7\u30fc\u30bf\u3092\u6d41\u3057\u3066\u3044\u304f\u3053\u3068\u3082\u3067\u304d\u308b\u3002\n\u4eca\u56de\u306fjson\u3092\u3059\u3067\u306b\u30d5\u30a1\u30a4\u30eb\u3078\u51fa\u529b\u6e08\u307f\u306a\u306e\u3067\u3001\u30d5\u30a1\u30a4\u30eb\u3092cat\u3057\u3066stdin\u306einput plugin\u3067\u6295\u5165\u3057\u3001Elasticsearch\u3092output plugin\u3068\u3057\u3066\u8a2d\u5b9a\u3057\u305f\u3002input\u3068output\u306b\u3069\u3093\u306aplugin\u304c\u7528\u610f\u3055\u308c\u3066\u3044\u308b\u304b\u306f\u3001\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u3092\u773a\u3081\u3066\u307f\u308b\u3068\u611f\u899a\u304c\u3064\u304b\u3081\u308b\u3068\u601d\u3046\u3002\n\nReference [2.3]\n\n\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\nOfficial\u306e\u8a18\u8f09\u306b\u5f93\u3063\u3066yum\u3067\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3002\n$ sudo yum install logstash\n\n\nconf\u30d5\u30a1\u30a4\u30eb\u306e\u4f5c\u6210\nlogstash\u306f\u51e6\u7406\u3057\u305f\u3044\u5185\u5bb9\u3092\u8a18\u8f09\u3057\u305fconf\u30d5\u30a1\u30a4\u30eb\u3092\u5229\u7528\u3057\u3066\u30c7\u30fc\u30bf\u51e6\u7406\u3092\u884c\u308f\u305b\u308b\u3002\u30d5\u30a1\u30a4\u30eb\u306b\u306f\u5927\u304d\u304f\u5206\u3051\u3066\u30c7\u30fc\u30bf\u306e\u53d7\u4fe1\u5143\u3092\u66f8\u3044\u305f\u300cinput\u300d\u3001\u89e3\u6790\u65b9\u6cd5\u3092\u66f8\u3044\u305f\u300cfilter\u300d\u3001\u51fa\u529b\u5148\u3092\u66f8\u3044\u305f\u300coutput\u300d\u306e3\u3064\u306eplugin\u8a2d\u5b9a\u3092\u8a18\u8f09\u3059\u308b\u3002\u4eca\u56de\u5229\u7528\u3057\u305fconf\u30d5\u30a1\u30a4\u30eb\u306f\u4ee5\u4e0b\u306e\u901a\u308a\u3002\n\npipeline.conf\ninput {\n  stdin {\n    codec => json\n  }\n}\nfilter {\n  json {\n    source => \"message\"\n  }\n}\noutput {\n  elasticsearch {\n    hosts => [\"http://xxx.ap-northeast-1.es.amazonaws.com/\"]\n    index => \"lifelog\"\n    document_type => \"zaim\"\n    document_id => \"%{id}\"\n  }\n  stdout {\n    codec => rubydebug\n  }\n}\n\n\n\u300cinput\u300d\u306f\u6a19\u6e96\u5165\u529b\uff08stdin plugin\uff09\u3068\u3057\u3001json\u3068\u3057\u3066\u89e3\u91c8\u3055\u305b\u305f\u3002\n\u30d5\u30a1\u30a4\u30eb\u304c\u5165\u529b\u5143\u306b\u306a\u308b\u306e\u3067\u3001file plugin\u3067\u6307\u5b9a\u3059\u308b\u3053\u3068\u3082\u53ef\u80fd\u3067\u3042\u308b\u304c\u3001\u3053\u306e\u969b\u6ce8\u610f\u3059\u3079\u304d\u306f\u3001\u5f53\u305f\u308a\u524d\u304b\u3082\u3057\u308c\u306a\u3044\u304clogstash\u8d77\u52d5\u4ee5\u964d\u306e\u5165\u529b\u304c\u51e6\u7406\u306e\u5bfe\u8c61\u306b\u306a\u308b\u3001\u3059\u306a\u308f\u3061file plugin\u3092input\u3068\u3057\u3066\u6307\u5b9a\u3057\u305f\u5834\u5408\u306f\u3001\u8ffd\u8a18\u90e8\u5206\u304c\u51e6\u7406\u5bfe\u8c61\u3060\u3068\u3044\u3046\u3053\u3068\u3002\u30d5\u30a1\u30a4\u30eb\u5185\u306b\u5143\u3005\u66f8\u304b\u308c\u305f\u5185\u5bb9\u3092\u982d\u304b\u3089\u51e6\u7406\u3055\u305b\u308b\u306b\u306f\u3001start_position => beginning\u306e\u6307\u5b9a\u304c\u5fc5\u8981\u306b\u306a\u308b\u3002\u307e\u305f\u4e00\u5ea6\u8aad\u307f\u8fbc\u3093\u3060\u30d5\u30a1\u30a4\u30eb\u306f\u8aad\u307f\u8fbc\u307f\u4f4d\u7f6e\u304c~/.sincedb_...\u306b\u8a18\u9332\u3055\u308c\u308b\u306e\u3067\u3001\u3053\u306e\u30d5\u30a1\u30a4\u30eb\u3092\u524a\u9664\u3057\u306a\u3044\u9650\u308astart_position => beginning\u306f\u6a5f\u80fd\u305b\u305a\u3001\u9014\u4e2d\u304b\u3089\u306e\u8aad\u307f\u8fbc\u307f\u306b\u306a\u308b\u3002\n\u300cfilter\u300d\u3067\u306fjson\u306e\u3069\u306e\u90e8\u5206\u3092\u8aad\u307f\u8fbc\u3080\u304b\u8a2d\u5b9a\u3057\u3066\u3044\u308b\u3002codec => json\u3068\u3057\u3066input\u3055\u308c\u305f\u30c7\u30fc\u30bf\u306f\u751f\u3067json\u51e6\u7406\u3055\u308c\u308b\u308f\u3051\u3067\u306f\u306a\u304f\u3001\u30e1\u30bf\u5c5e\u6027\u306a\u3069\u304c\u8ffd\u52a0\u3055\u308c\u308b\u306e\u3067\u3001\u30c7\u30fc\u30bf\u90e8\u5206\u3060\u3051\u3092\u7d14\u7c8b\u306b\u53d6\u308a\u51fa\u3059\u3068\u304d\u306fmessage field\u4ee5\u4e0b\u3092\u660e\u793a\u7684\u306b\u6307\u5b9a\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u3002\n\u300coutput\u300d\u3067\u306felasticsearch plugin\u3068stdout plugin\u3092\u6307\u5b9a\u3002\u524d\u8005\u3067\u306fdocument ID\u306e\u6307\u5b9a\u304c\u3067\u304d\u308b\u306e\u3067\u3001Zaim\u306ejson\u30c7\u30fc\u30bf\u306b\u5143\u3005\u542b\u307e\u308c\u3066\u3044\u308bid field\u3092\u4f7f\u3046\u3088\u3046\u6307\u5b9a\u3057\u3066\u3044\u308b\u3002stdout plugin\u306f\u30c7\u30d0\u30c3\u30b0\u76ee\u7684\u3067\u6307\u5b9a\u3057\u305f\u3002codec\u306frubydebug\u3068\u3059\u308b\u306e\u304c\u3069\u3046\u3082\u901a\u4f8b\u306e\u6a21\u69d8\u3002\n\n\u5b9f\u884c\n\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3057\u305f\u3089\u3001logstash\u3092\u5b9f\u969b\u306b\u5b9f\u884c\u3059\u308b\u3002\n$ cat zaim.json | logstash -f pipeline.conf\n\nElasticsearch\u306b\u30ea\u30af\u30a8\u30b9\u30c8\u3092\u304b\u3051\u3066\u3001\u767b\u9332\u3067\u304d\u305f\u3053\u3068\u3092\u78ba\u8a8d\u3059\u308b\u3002\n$ curl -XGET \"http://xxx.ap-northeast-1.es.amazonaws.com/lifelog/zaim/_count\" | jq\n  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current\n                                 Dload  Upload   Total   Spent    Left  Speed\n100    62  100    62    0     0    384      0 --:--:-- --:--:-- --:--:--   385\n{\n  \"count\": 1976,\n  \"_shards\": {\n    \"total\": 5,\n    \"successful\": 5,\n    \"failed\": 0\n  }\n}\n\n\n\nKibana\nElasticsearch\u3078\u306e\u767b\u9332\u304c\u554f\u984c\u306a\u304f\u5b8c\u4e86\u3057\u3066\u3044\u308c\u3070\u3001\u3059\u3067\u306bKibana\u304b\u3089\u3082\u95b2\u89a7\u304c\u53ef\u80fd\u306b\u306a\u3063\u3066\u3044\u308b\u3002\n\n\u8cc7\u7523\u72b6\u6cc1\u3092\u7c21\u5358\u306b\u30b0\u30e9\u30d5\u5316\u51fa\u6765\u306a\u3044\u304b\u3068\u8003\u3048\u3066\u6311\u6226\u3002\u5bb6\u8a08\u7c3f\u30b5\u30fc\u30d3\u30b9\u306e\u4e2d\u3067\u3082[Zaim](http://zaim.net/)\u306fAPI\u3092\u516c\u958b\u3057\u3066\u304a\u308a\u3001json\u3067\u30c7\u30fc\u30bf\u306e\u53d6\u5f97\u304c\u3067\u304d\u308b\u3002\u3053\u308c\u3092Python\u3092\u4f7f\u3063\u3066\u53d6\u5f97\u3057\u3001\u52c9\u5f37\u3082\u517c\u306d\u3066Amazon Elasticsearch Service\u3078\u6295\u5165\u3059\u308b\u5f62\u3067\u30b0\u30e9\u30d5\u5316\u3092\u5b9f\u73fe\u3057\u3066\u307f\u305f\u3002\u306a\u304a\u3001\u5927\u91cf\u306ejson\u306e\u6295\u5165\u306b\u306f\u305b\u3063\u304b\u304f\u306a\u306e\u3067Elastic\u88fd\u306elogstash\u306b\u6311\u6226\u3057\u3066\u3044\u308b\u3002\n\nAmazon Elasticsearch Service\n========\n\nAWS\u306e\u63d0\u4f9b\u3059\u308bElasticsearch\u306e\u30de\u30cd\u30fc\u30b8\u30c9\u30b5\u30fc\u30d3\u30b9\u3002\u30d0\u30fc\u30b8\u30e7\u30f3\u304c\u6700\u65b0\u3088\u308a\u82e5\u5e72\u53e4\u3044\u3082\u306e\u3067\u63d0\u4f9b\u3055\u308c\u3066\u3044\u308b\u306e\u304c\u30cd\u30c3\u30af\u3067\u306f\u3042\u308b\u304c\u3001\u6700\u3082\u7c21\u5358\u304b\u3064\u9ad8\u901f\u306bElasticsearch\u3092\u4f7f\u3048\u308b\u624b\u6bb5\u306e\u4e00\u3064\u304b\u3068\u3002Kibana\u3082\u30c7\u30d5\u30a9\u30eb\u30c8\u3067\u63d0\u4f9b\u3055\u308c\u308b\u3002\n\n\u7279\u306b\u8a2d\u5b9a\u4e0a\u96e3\u3057\u3044\u7b87\u6240\u306f\u306a\u3044\u306e\u3067\u3001Web\u30b3\u30f3\u30bd\u30fc\u30eb\u304b\u3089\u3055\u304f\u3055\u304f\u3068\u4f5c\u6210\u3059\u308b\u3002\u30a2\u30af\u30bb\u30b9\u5236\u5fa1\u306e\u30dd\u30ea\u30b7\u30fc\u306f\u4eca\u56deIP\u306b\u3088\u308b\u8a31\u53ef\u3092\u884c\u306a\u3063\u305f\u3002\u3053\u308c\u306fElasticsearch\u3060\u3051\u3067\u306f\u306a\u304f\u3001Kibana\u306e\u30a2\u30af\u30bb\u30b9\u5236\u5fa1\u3067\u3082\u3042\u308b\u306e\u3067\u3001\u4f8b\u3048\u3070\u30c7\u30fc\u30bf\u6295\u5165\u306f\u30af\u30e9\u30a6\u30c9\u4e0a\u306e\u30b5\u30fc\u30d0\u30fc\u304b\u3089\u884c\u3044\u3001Kibana\u306e\u78ba\u8a8d\u306f\u30ed\u30fc\u30ab\u30ebPC\u3067\u884c\u3046\u3088\u3046\u306a\u5834\u5408\u306b\u306f\u3001\u305d\u308c\u305e\u308cIP\u3092\u6307\u5b9a\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u3002\n\n```json\n{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Sid\": \"\",\n      \"Effect\": \"Allow\",\n      \"Principal\": {\n        \"AWS\": \"*\"\n      },\n      \"Action\": \"es:*\",\n      \"Resource\": \"arn:aws:es:ap-northeast-1:xxxxx:domain/xxxxx/*\",\n      \"Condition\": {\n        \"IpAddress\": {\n          \"aws:SourceIp\": [\n            \"xx.xx.xx.xx\"\n          ]\n        }\n      }\n    }\n  ]\n}\n```\n\nZaim API via Python\n========\n\nZaim API\u3092\u53e9\u304f\u306e\u306b\u306fPython\u306erequests\u3092\u4f7f\u7528\u3057\u305f\u3002\u66f8\u304d\u65b9\u306frequests\u306e\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u3092\u53c2\u8003\u306b\u3057\u3066\u3044\u308b\u3002\n\n* [OAuth 1 Workflow \u2014 Requests-OAuthlib 0.6.1 documentation](http://requests-oauthlib.readthedocs.org/en/latest/oauth1_workflow.html)\n\n```py:get_zaim.py\n# coding: utf-8\nimport requests\nfrom requests_oauthlib import OAuth1Session\nfrom requests_oauthlib import OAuth1\n\nconsumer_key = u\"XXXXX\"\nconsumer_secret = u\"XXXXX\"\n\nrequest_token_url = u\"https://api.zaim.net/v2/auth/request\"\nauthorize_url = u\"https://www.zaim.net/users/auth\"\naccess_token_url = u\"https://api.zaim.net/v2/auth/access\"\ncallback_uri = u\"http://chroju.net/\"\nget_money_url = u\"https://api.zaim.net/v2/home/money\"\n\ndef oauth_requests():\n    auth = OAuth1Session(consumer_key, client_secret=consumer_secret, callback_uri=callback_uri)\n    r = auth.fetch_request_token(request_token_url)\n    resource_owner_key = r.get('oauth_token')\n    resource_owner_secret = r.get('oauth_token_secret')\n\n    authorization_url = auth.authorization_url(authorize_url)\n    print 'Please go here and authorize,', authorization_url\n    redirect_response = raw_input('Paste the full redirect URL here:')\n    oauth_response = auth.parse_authorization_response(redirect_response)\n    verifier = oauth_response.get('oauth_verifier')\n\n    auth = OAuth1Session(client_key=consumer_key, client_secret=consumer_secret, resource_owner_key=resource_owner_key, resource_owner_secret=resource_owner_secret, verifier=verifier)\n    oauth_token = auth.fetch_access_token(access_token_url)\n\n    resource_owner_key = oauth_token.get('oauth_token')\n    resource_owner_secret = oauth_token.get('oauth_token_secret')\n\n    get_json(resource_owner_key, resource_owner_secret)\n\ndef get_json(resource_owner_key, resource_owner_secret):\n    headeroauth = OAuth1(consumer_key, consumer_secret, resource_owner_key, resource_owner_secret, signature_type='auth_header')\n    r = requests.get(get_money_url, auth=headeroauth)\n    print r.content\n\nif __name__ == \"__main__\":\n  oauth_requests()\n```\n\n\u3053\u308c\u3092\u5b9f\u884c\u3059\u308b\u3068json\u3067\u611a\u76f4\u306b\u5bb6\u8a08\u7c3f\u30c7\u30fc\u30bf\u304c\u51fa\u529b\u3055\u308c\u308b\u306e\u3067\u3001`jq`\u3092\u4ecb\u3057\u3066\u6574\u5f62\u3057\u305f\u4e0a\u3067\u30d5\u30a1\u30a4\u30eb\u3078\u4fdd\u5b58\u3057\u3066\u304a\u304f\u3002\n\n```bash\n$ python27 get_zaim.py | jq > zaim.json\n```\n\nElasticsearch\n========\n\nmapping\n----\n\n\u4e00\u5ea6Amazon ES\u3092\u7acb\u3061\u4e0a\u3052\u308c\u3070\u3001\u305d\u306e\u5f8c\u306e\u5229\u7528\u65b9\u6cd5\u306f\u901a\u5e38\u306eElasticsearch\u540c\u69d8\u3002\u307e\u305azaim API\u3067\u53d6\u5f97\u3067\u304d\u308bjson\u30d5\u30a1\u30a4\u30eb\u306e\u66f8\u5f0f\u306b\u5408\u308f\u305b\u3001mapping\u3092\u3042\u3089\u304b\u3058\u3081\u884c\u3046\u3002\n\n```bash\n$ curl -XPUT \"http://xxx.ap-northeast-1.es.amazonaws.com/lifelog\" -d '\n{\"mappings\" : {\n\"zaim\" : {\n\"properties\" : {\n\"id\" : { \"type\" : \"integer\"},\n\"user_id\" : { \"type\" : \"integer\"},\n\"date\" : { \"type\" : \"date\", \"format\" : \"yyyy-MM-dd\"},\n\"mode\" : { \"type\" : \"string\" },\n\"category_id\" : { \"type\" : \"integer\" },\n\"genre_id\" : { \"type\" : \"integer\" },\n\"from_account_id\" : {\"type\" : \"integer\"},\n\"to_account_id\" : {\"type\" : \"integer\"},\n\"amount\" : {\"type\" : \"integer\"},\n\"comment\" : {\"type\" : \"string\"},\n\"active\" : {\"type\" : \"integer\"},\n\"created\" : {\"type\" : \"date\", \"format\" : \"yyyy-MM-dd HH:mm:ss\"},\n\"currency_code\" : {\"type\" : \"string\"},\n\"name\" : {\"type\" : \"string\"},\n\"receipt_id\" : {\"type\" : \"integer\"},\n\"place_uid\" : {\"type\" : \"integer\"},\n\"place\" : {\"type\" : \"string\"},\n\"path\" : {\"type\":\"string\"}\n}\n}\n}\n}'\n```\n\nmapping\u8a2d\u5b9a\u304c\u554f\u984c\u306a\u3044\u3053\u3068\u3092\u78ba\u8a8d\u3002\n\n```bash\n$ curl -XGET \"http://xxx.ap-northeast-1.es.amazonaws.com/lifelog/_mapping\" | jq\n  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current\n                                 Dload  Upload   Total   Spent    Left  Speed\n100   733  100   733    0     0  58050      0 --:--:-- --:--:-- --:--:-- 61083\n{\n  \"lifelog\": {\n    \"mappings\": {\n      \"zaim\": {\n        \"properties\": {\n          \"@timestamp\": {\n            \"type\": \"date\",\n            \"format\": \"dateOptionalTime\"\n...\n```\n\nlogstash\n========\n\nElasticsearch\u306b\u8907\u6570\u306ejson\u3092\u540c\u6642\u306b\u6295\u5165\u3059\u308b\u306b\u306f\u3001\u304a\u305d\u3089\u304f[bulk API](https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-bulk.html)\u3092\u5229\u7528\u3059\u308b\u306e\u304c\u6700\u3082\u4e00\u822c\u7684\u3067\u3042\u308b\u3002\u3057\u304b\u3057bulk API\u3067\u6295\u5165\u3059\u308bjson\u306f\u3001\u30c7\u30fc\u30bf\u90e8\u5206\u3068index\u3092\u4ea4\u4e92\u306b\u8a18\u8ff0\u3057\u305f\u3082\u306e\u3068\u3057\u306a\u304f\u3066\u306f\u306a\u3089\u306a\u3044\u305f\u3081\u3001\u4eca\u56de\u306e\u3088\u3046\u306bAPI\u3067\u4e00\u62ec\u53d6\u5f97\u3057\u305fjson\u3092\u6d41\u3059\u306b\u306f\u5411\u3044\u3066\u3044\u306a\u3044\u3002\n\n\u4ee3\u66ff\u624b\u6bb5\u3068\u3057\u3066\u306ffluentd\u306a\u3069\u3092\u5229\u7528\u3059\u308b\u624b\u6cd5\u3082\u3042\u308b\u304c\u3001Elastic\u793e\u304c\u63d0\u4f9b\u3057\u3066\u3044\u308b\u3068\u3044\u3046\u3053\u3068\u3067 **logstash** \u3092\u6d3b\u7528\u3057\u3066\u307f\u305f\u3002logstash\u306ffluentd\u3068\u4f3c\u305f\u30b9\u30c8\u30ea\u30fc\u30e0\u30c7\u30fc\u30bf\u306e\u89e3\u6790\u3001\u51e6\u7406\u3092\u884c\u3046\u305f\u3081\u306e\u30c4\u30fc\u30eb\u3002\u7279\u306bElasticsearch\u5c02\u7528\u3068\u3044\u3046\u308f\u3051\u3067\u306f\u306a\u304f\u3001\u4f8b\u3048\u3070Datadog\u3084influxDB\u3078\u30c7\u30fc\u30bf\u3092\u6d41\u3057\u3066\u3044\u304f\u3053\u3068\u3082\u3067\u304d\u308b\u3002\n\n\u4eca\u56de\u306fjson\u3092\u3059\u3067\u306b\u30d5\u30a1\u30a4\u30eb\u3078\u51fa\u529b\u6e08\u307f\u306a\u306e\u3067\u3001\u30d5\u30a1\u30a4\u30eb\u3092`cat`\u3057\u3066stdin\u306einput plugin\u3067\u6295\u5165\u3057\u3001Elasticsearch\u3092output plugin\u3068\u3057\u3066\u8a2d\u5b9a\u3057\u305f\u3002input\u3068output\u306b\u3069\u3093\u306aplugin\u304c\u7528\u610f\u3055\u308c\u3066\u3044\u308b\u304b\u306f\u3001\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u3092\u773a\u3081\u3066\u307f\u308b\u3068\u611f\u899a\u304c\u3064\u304b\u3081\u308b\u3068\u601d\u3046\u3002\n\n* [Reference [2.3]](https://www.elastic.co/guide/en/logstash/current/index.html)\n\n\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n----\n\n[Official](https://www.elastic.co/guide/en/logstash/current/package-repositories.html)\u306e\u8a18\u8f09\u306b\u5f93\u3063\u3066yum\u3067\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3002\n\n```bash\n$ sudo yum install logstash\n```\n\nconf\u30d5\u30a1\u30a4\u30eb\u306e\u4f5c\u6210\n----\n\nlogstash\u306f\u51e6\u7406\u3057\u305f\u3044\u5185\u5bb9\u3092\u8a18\u8f09\u3057\u305fconf\u30d5\u30a1\u30a4\u30eb\u3092\u5229\u7528\u3057\u3066\u30c7\u30fc\u30bf\u51e6\u7406\u3092\u884c\u308f\u305b\u308b\u3002\u30d5\u30a1\u30a4\u30eb\u306b\u306f\u5927\u304d\u304f\u5206\u3051\u3066\u30c7\u30fc\u30bf\u306e\u53d7\u4fe1\u5143\u3092\u66f8\u3044\u305f\u300cinput\u300d\u3001\u89e3\u6790\u65b9\u6cd5\u3092\u66f8\u3044\u305f\u300cfilter\u300d\u3001\u51fa\u529b\u5148\u3092\u66f8\u3044\u305f\u300coutput\u300d\u306e3\u3064\u306eplugin\u8a2d\u5b9a\u3092\u8a18\u8f09\u3059\u308b\u3002\u4eca\u56de\u5229\u7528\u3057\u305fconf\u30d5\u30a1\u30a4\u30eb\u306f\u4ee5\u4e0b\u306e\u901a\u308a\u3002\n\n```pipeline.conf\ninput {\n  stdin {\n    codec => json\n  }\n}\nfilter {\n  json {\n    source => \"message\"\n  }\n}\noutput {\n  elasticsearch {\n    hosts => [\"http://xxx.ap-northeast-1.es.amazonaws.com/\"]\n    index => \"lifelog\"\n    document_type => \"zaim\"\n    document_id => \"%{id}\"\n  }\n  stdout {\n    codec => rubydebug\n  }\n}\n```\n\n\u300cinput\u300d\u306f\u6a19\u6e96\u5165\u529b\uff08stdin plugin\uff09\u3068\u3057\u3001json\u3068\u3057\u3066\u89e3\u91c8\u3055\u305b\u305f\u3002\n\n\u30d5\u30a1\u30a4\u30eb\u304c\u5165\u529b\u5143\u306b\u306a\u308b\u306e\u3067\u3001file plugin\u3067\u6307\u5b9a\u3059\u308b\u3053\u3068\u3082\u53ef\u80fd\u3067\u3042\u308b\u304c\u3001\u3053\u306e\u969b\u6ce8\u610f\u3059\u3079\u304d\u306f\u3001\u5f53\u305f\u308a\u524d\u304b\u3082\u3057\u308c\u306a\u3044\u304clogstash\u8d77\u52d5\u4ee5\u964d\u306e\u5165\u529b\u304c\u51e6\u7406\u306e\u5bfe\u8c61\u306b\u306a\u308b\u3001\u3059\u306a\u308f\u3061file plugin\u3092input\u3068\u3057\u3066\u6307\u5b9a\u3057\u305f\u5834\u5408\u306f\u3001\u8ffd\u8a18\u90e8\u5206\u304c\u51e6\u7406\u5bfe\u8c61\u3060\u3068\u3044\u3046\u3053\u3068\u3002\u30d5\u30a1\u30a4\u30eb\u5185\u306b\u5143\u3005\u66f8\u304b\u308c\u305f\u5185\u5bb9\u3092\u982d\u304b\u3089\u51e6\u7406\u3055\u305b\u308b\u306b\u306f\u3001`start_position => beginning`\u306e\u6307\u5b9a\u304c\u5fc5\u8981\u306b\u306a\u308b\u3002\u307e\u305f\u4e00\u5ea6\u8aad\u307f\u8fbc\u3093\u3060\u30d5\u30a1\u30a4\u30eb\u306f\u8aad\u307f\u8fbc\u307f\u4f4d\u7f6e\u304c`~/.sincedb_...`\u306b\u8a18\u9332\u3055\u308c\u308b\u306e\u3067\u3001\u3053\u306e\u30d5\u30a1\u30a4\u30eb\u3092\u524a\u9664\u3057\u306a\u3044\u9650\u308a`start_position => beginning`\u306f\u6a5f\u80fd\u305b\u305a\u3001\u9014\u4e2d\u304b\u3089\u306e\u8aad\u307f\u8fbc\u307f\u306b\u306a\u308b\u3002\n\n\u300cfilter\u300d\u3067\u306fjson\u306e\u3069\u306e\u90e8\u5206\u3092\u8aad\u307f\u8fbc\u3080\u304b\u8a2d\u5b9a\u3057\u3066\u3044\u308b\u3002`codec => json`\u3068\u3057\u3066input\u3055\u308c\u305f\u30c7\u30fc\u30bf\u306f\u751f\u3067json\u51e6\u7406\u3055\u308c\u308b\u308f\u3051\u3067\u306f\u306a\u304f\u3001\u30e1\u30bf\u5c5e\u6027\u306a\u3069\u304c\u8ffd\u52a0\u3055\u308c\u308b\u306e\u3067\u3001\u30c7\u30fc\u30bf\u90e8\u5206\u3060\u3051\u3092\u7d14\u7c8b\u306b\u53d6\u308a\u51fa\u3059\u3068\u304d\u306f`message` field\u4ee5\u4e0b\u3092\u660e\u793a\u7684\u306b\u6307\u5b9a\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u3002\n\n\u300coutput\u300d\u3067\u306felasticsearch plugin\u3068stdout plugin\u3092\u6307\u5b9a\u3002\u524d\u8005\u3067\u306fdocument ID\u306e\u6307\u5b9a\u304c\u3067\u304d\u308b\u306e\u3067\u3001Zaim\u306ejson\u30c7\u30fc\u30bf\u306b\u5143\u3005\u542b\u307e\u308c\u3066\u3044\u308bid field\u3092\u4f7f\u3046\u3088\u3046\u6307\u5b9a\u3057\u3066\u3044\u308b\u3002stdout plugin\u306f\u30c7\u30d0\u30c3\u30b0\u76ee\u7684\u3067\u6307\u5b9a\u3057\u305f\u3002`codec`\u306f`rubydebug`\u3068\u3059\u308b\u306e\u304c\u3069\u3046\u3082\u901a\u4f8b\u306e\u6a21\u69d8\u3002\n\n\u5b9f\u884c\n----\n\n\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3057\u305f\u3089\u3001logstash\u3092\u5b9f\u969b\u306b\u5b9f\u884c\u3059\u308b\u3002\n\n```bash\n$ cat zaim.json | logstash -f pipeline.conf\n```\n\nElasticsearch\u306b\u30ea\u30af\u30a8\u30b9\u30c8\u3092\u304b\u3051\u3066\u3001\u767b\u9332\u3067\u304d\u305f\u3053\u3068\u3092\u78ba\u8a8d\u3059\u308b\u3002\n\n```bash\n$ curl -XGET \"http://xxx.ap-northeast-1.es.amazonaws.com/lifelog/zaim/_count\" | jq\n  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current\n                                 Dload  Upload   Total   Spent    Left  Speed\n100    62  100    62    0     0    384      0 --:--:-- --:--:-- --:--:--   385\n{\n  \"count\": 1976,\n  \"_shards\": {\n    \"total\": 5,\n    \"successful\": 5,\n    \"failed\": 0\n  }\n}\n\n```\n\nKibana\n========\n\nElasticsearch\u3078\u306e\u767b\u9332\u304c\u554f\u984c\u306a\u304f\u5b8c\u4e86\u3057\u3066\u3044\u308c\u3070\u3001\u3059\u3067\u306bKibana\u304b\u3089\u3082\u95b2\u89a7\u304c\u53ef\u80fd\u306b\u306a\u3063\u3066\u3044\u308b\u3002\n\n![zaim.png](https://qiita-image-store.s3.amazonaws.com/0/19465/1b4d3077-f03c-4f45-c930-c6c8776eca6b.png)\n\n", "tags": ["Python2.7", "AWS", "AmazonElasticsearchService", "Logstash", "Elasticsearch"]}