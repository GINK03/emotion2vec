{"context": " More than 1 year has passed since last update.Heroku Dev Center\u300cDirect to S3 Image Uploads in Rails\u300d\u306e\u899a\u3048\u66f8\u304d\u3067\u3059\u3002\n\u74b0\u5883\n\nRails 4.1.8\nheroku-toolbelt 3.16.0\naws-sdk 1.59.0\nJQuery UI (1.11.2)\njQuery File Upload Plugin (9.8.0)\n\n\u30b5\u30f3\u30d7\u30eb\n\nhttps://github.com/usutani/direct-s3-example\n\n\u53c2\u7167\n\nDirect to S3 Image Uploads in Rails | Heroku Dev Center\nCORS(Cross-Origin Resource Sharing)\u306b\u3064\u3044\u3066\u6574\u7406\u3057\u3066\u307f\u305f \uff5c Developers.IO\n\n\n\u899a\u3048\u66f8\u304d\n\nPhilosophy\n\u3053\u306e\u8a18\u4e8b\u3067\u306f jQuery-File-Upload\u30d7\u30e9\u30b0\u30a4\u30f3\u3068 AWS gem \u3092\u7528\u3044\u307e\u3059\u3002\n\u753b\u50cf\u3092S3\u306b\u76f4\u63a5\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u3067\u304d\u308b CarrierWaveDirect \u306e\u3088\u3046\u306a\u4ed6\u306e\u30e9\u30a4\u30d6\u30e9\u30ea\u3082\u3042\u308a\u307e\u3059\u304c\u3001\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u5074\u306b\u95a2\u3059\u308b\u4f4e\u30ec\u30d9\u30eb\u306e\u77e5\u8b58\u306a\u3057\u3067\u306e\u305d\u308c\u3089\u306e\u5b9f\u88c5\u306f\u56f0\u96e3\u3067\u3059\u3002\njQuery-File-Upload \u30d7\u30e9\u30b0\u30a4\u30f3\u3092\u7528\u3044\u308b\u3068\u3001JavaScript \u306e\u30b3\u30fc\u30c9\u306f\u6bd4\u8f03\u7684\u8aad\u307f\u3084\u3059\u304f\u77ed\u3044\u3082\u306e\u306b\u306a\u308a\u3001\u305d\u306e\u30b3\u30fc\u30c9\u3092\u4efb\u610f\u306e\u753b\u50cf\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u5165\u529b\u30d5\u30a9\u30fc\u30e0\u3068\u3057\u3066\u518d\u5229\u7528\u3059\u308b\u3053\u3068\u3082\u3067\u304d\u307e\u3059\u3002\n\u307e\u305f\u3001\u30e6\u30fc\u30b6\u30a4\u30f3\u30bf\u30d5\u30a7\u30fc\u30b9\u306f\u975e\u5e38\u306b\u30ab\u30b9\u30bf\u30de\u30a4\u30ba\u53ef\u80fd\u3067\u3059\u3002\nRails\u5074\u3067\u306f\u3001AWS\u3067\u4e8b\u524d\u306b\u7f72\u540d\u3057\u305fPOST\u3092\u751f\u6210\u3057\u3001\u753b\u50cf\u306eURL\u3092\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306b\u4fdd\u5b58\u3057\u307e\u3059\u3002\n\nExample app\n\u3053\u306e\u30a2\u30d7\u30ea\u3067\u306f User \u30e2\u30c7\u30eb\u3092\u6301\u3061\u3001\u30a2\u30d0\u30bf\u30fc\u753b\u50cf\u3092\u30e6\u30fc\u30b6\u30fc\u5358\u4f4d\u3067 S3 \u306b\u4fdd\u5b58\u3057\u305f\u3044\u3068\u601d\u3044\u307e\u3059\u3002\nrails new direct-s3-example\ncd direct-s3-example\nrails generate scaffold user name avatar_url\nrake db:migrate\n\n\nS3\n\u30d5\u30a1\u30a4\u30eb\u3092 S3 \u306b\u9001\u308b\u524d\u306b\u3001S3 \u306e\u30a2\u30ab\u30a6\u30f3\u30c8\u3068\u3001\u9069\u5207\u306b\u69cb\u6210\u3055\u308c\u305f\u30d0\u30b1\u30c3\u30c8\u304c\u5fc5\u8981\u306b\u306a\u308a\u307e\u3059\u3002\n\nS3 SDK\n\u6b21\u306b Ruby \u3067 S3 \u3068\u3084\u308a\u3068\u308a\u3059\u308b\u305f\u3081\u306e\u30e9\u30a4\u30d6\u30e9\u30ea\u304c\u5fc5\u8981\u306b\u306a\u308a\u307e\u3059\u3002\naws-sdk \u3092 Gemfile \u306b\u8ffd\u52a0\u3057\u3066 bundle install \u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\nGemfile\ngem 'aws-sdk'\n\n\n\u30ed\u30fc\u30ab\u30eb\u306e\u958b\u767a\u3067\u306f\u3001.env \u30d5\u30a1\u30a4\u30eb\u3068 Foreman \u3092\u4f7f\u3044\u307e\u3059\u3002\n\u6b21\u306e\u3088\u3046\u306b\u74b0\u5883\u5909\u6570\u3092\u8ffd\u52a0\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\u5c1a\u3001\u4e0b\u8a18\u306e\u5024\u306f\u4f8b\u3067\u3059\u306e\u3067\u3001S3 \u3067\u8a2d\u5b9a\uff0f\u53d6\u5f97\u3057\u305f\u3082\u306e\u3092\u66f8\u3044\u3066\u304f\u3060\u3055\u3044\u3002\nS3_BUCKET=my-s3-development\nAWS_ACCESS_KEY_ID=EXAMPLEKVFOOOWWPYA\nAWS_SECRET_ACCESS_KEY=exampleBARZHS3sRew8xw5hiGLfroD/b21p2l\n\n\u78ba\u8a8d\n$ foreman run rails runner \"puts ENV['S3_BUCKET']\"\nmy-s3-development\n\n\u74b0\u5883\u5909\u6570\u3092\u8a2d\u5b9a\u3067\u304d\u305f\u3089\u3001\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u30fc\u304b\u3089\u4f7f\u3048\u308b\u3088\u3046\u306b S3 \u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u7528\u610f\u3057\u307e\u3059\u3002\n\nconfig/initializers/aws.rb\nAWS.config(access_key_id:     ENV['AWS_ACCESS_KEY_ID'],\n           secret_access_key: ENV['AWS_SECRET_ACCESS_KEY'] )\n\nS3_BUCKET = AWS::S3.new.buckets[ENV['S3_BUCKET']]\n\n\n\nCross origin support\n\uff08\u53c2\u8003\uff09CORS(Cross-Origin Resource Sharing)\u306b\u3064\u3044\u3066\u6574\u7406\u3057\u3066\u307f\u305f\n\u74b0\u5883\u306b\u5408\u308f\u305b\u3066\u30d0\u30b1\u30c3\u30c8\u306e CORS \u8a2d\u5b9a\u3092\u5909\u66f4\u3057\u307e\u3059\u3002\n\u9069\u5207\u306a\u30aa\u30ea\u30b8\u30f3\u3092 AllowedOrigin \u306b\u8a2d\u5b9a\u3057\u307e\u3057\u3087\u3046\u3002\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<CORSConfiguration xmlns=\"http://s3.amazonaws.com/doc/2006-03-01/\">\n    <CORSRule>\n        <AllowedOrigin>*</AllowedOrigin>\n        <AllowedMethod>GET</AllowedMethod>\n        <AllowedMethod>POST</AllowedMethod>\n        <AllowedMethod>PUT</AllowedMethod>\n        <AllowedHeader>*</AllowedHeader>\n    </CORSRule>\n</CORSConfiguration>\n\n\nPre-signed post\nAWS ruby gem \u3067\u4e8b\u524d\u306b\u7f72\u540d\u3057\u305f(Pre-signed)POST\u3092\u751f\u6210\u3057\u307e\u3059\u3002\n\u3042\u306a\u305f\u306e\u30e6\u30fc\u30b6\u30fc\u3084\u9867\u5ba2\u304c\u7279\u5b9a\u306e\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u3042\u306a\u305f\u306e\u30d0\u30b1\u30c3\u30c8\u306b\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u3057\u305f\u3044\u5834\u5408\u306b\u3001\u4e8b\u524d\u306b\u7f72\u540d\u3057\u305fURL\u306f\u5f79\u7acb\u3061\u307e\u3059\u3002\u8a73\u3057\u304f\u306f Class: AWS::S3::PresignedPost \u3092\u3054\u89a7\u304f\u3060\u3055\u3044\u3002\nusers_controller.rb \u306b pre-signed post \u3092\u751f\u6210\u3059\u308b\u884c\u3092\u8ffd\u52a0\u3057\u307e\u3059\u3002\n\napp/controllers/users_controller.rb\n  # GET /users/new\n  def new\n    @s3_direct_post = S3_BUCKET.presigned_post(\n      key: \"uploads/#{SecureRandom.uuid}/${filename}\",\n      success_action_status: 201,\n      acl: :public_read)\n    @user = User.new\n  end\n\n\n\nClient side code\n\u4e00\u6642\u7684\u306a\u30ad\u30e3\u30c3\u30b7\u30e5\u3068\u3057\u3066\u30b5\u30fc\u30d0\u30fc\u306b\u983c\u308b\u3053\u3068\u306f\u3067\u304d\u306a\u3044\u306e\u3067\u3001S3 \u306b\u30d5\u30a1\u30a4\u30eb\u3092\u914d\u4fe1\u3059\u308b\u305f\u3081\u306b\u3001\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u5074\u306e\u30b3\u30fc\u30c9\uff08JavaScript\uff09\u3092\u4f7f\u7528\u3057\u306a\u3051\u308c\u3070\u306a\u308a\u307e\u305b\u3093\u3002\nHTML 5\u306f\u30d5\u30a1\u30a4\u30ebAPI\u3092\u5c0e\u5165\u3057\u3066\u3044\u307e\u3059\u304c\u3001IE 10\u307e\u3067\u30b5\u30dd\u30fc\u30c8\u3055\u308c\u307e\u305b\u3093\u3067\u3057\u305f\u3002\u3053\u308c\u3092\u56de\u907f\u3059\u308b\u305f\u3081\u306b\u3001jQuery File Upload \u3092\u4f7f\u3044\u307e\u3059\u3002\u3053\u308c\u3092\u4f7f\u3046\u306b\u306f\u5148\u306b JQuery UI \u304c\u5fc5\u8981\u306b\u306a\u308a\u307e\u3059\u3002\n\nJQuery UI\njQuery File Upload\n\nRails \u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u306b JavaScript \u30d5\u30a1\u30a4\u30eb\u3092\u53d6\u308a\u8fbc\u307f\u307e\u3059\u3002\n$ curl \\\nhttps://raw.githubusercontent.com/jquery/jquery-ui/master/ui/widget.js \\\n>> app/assets/javascripts/jquery.ui.widget.js\n\n$ curl \\\nhttps://raw.githubusercontent.com/blueimp/jQuery-File-Upload/master/js/jquery.fileupload.js \\\n>> app/assets/javascripts/z.jquery.fileupload.js\n\n\napp/assets/javascripts/application.js\n.\n.\n//= require jquery.ui.widget.js\n//= require z.jquery.fileupload\n//= require_tree .\n\n\n\u78ba\u8a8d\nrails s\nopen http://localhost:3000/users/new\n\n\nJavaScript\u30b3\u30f3\u30bd\u30fc\u30eb\n> console.log($().fileupload)\nfunction ( options ) {\n          var isMethodCall = typeof options === \"string\",\n               args = slice.call( arguments, 1 ),\n               returnValue = this;\n//...\n\n\n\nPrepare the view\n\nform_for \u306b directUpload \u30af\u30e9\u30b9\u3092\u8ffd\u52a0\navatar_url \u3092 f.file_field \u306b\u5909\u66f4\n\n\napp/views/users/_form.html.erb\n<%= form_for(@user, html: { class: \"directUpload\" }) do |f| %>\n  <% if @user.errors.any? %>\n.\n.\n<div class=\"field\">\n  <%= f.label :avatar_url %><br>\n  <%= f.file_field :avatar_url %>\n</div>\n\n\n\nDetecting file field on the client side\n\u4ee5\u4e0b\u306e\u3082\u306e\u304c\u7528\u610f\u3067\u304d\u307e\u3057\u305f\u3002\n\nS3 \u30d0\u30b1\u30c3\u30c8\n\u6709\u52b9\u306a pre-signed post \u30aa\u30d6\u30b8\u30a7\u30af\u30c8\nUser \u30e2\u30c7\u30eb\uff08avatar_url\u3001\u30d5\u30a1\u30a4\u30eb\u5165\u529b\uff09\n\n\u30e6\u30fc\u30b6\u30fc\u306e\u753b\u50cf\u3092 S3 \u304b\u3089\u53d6\u5f97\u3057\u305f\u308a\u3001avatar_url \u306b URL \u3092\u4fdd\u5b58\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u304c\u3001\u3053\u308c\u306f\u4e3b\u306b JavaScript \u3067\u306e\u624b\u52d5\u51e6\u7406\u306b\u306a\u308a\u307e\u3059\u3002\n\u30fb\u30fb\u30fb\u7701\u7565\u30fb\u30fb\u30fb\n\u30d7\u30ed\u30b0\u30ec\u30b9\u30d0\u30fc\u306e\u30b9\u30bf\u30a4\u30eb\u3092\u6307\u5b9a\u3057\u307e\u3059\u3002\n\napp/assets/stylesheets/screen.css\n.progress {\n  max-width: 600px;\n  margin:    0.2em 0 0.2em 0;\n}\n\n.progress .bar {\n  height:  1.2em;\n  padding: 0.2em;\n  color:   white;\n  display: none;\n}\n\n\n\nFinished jquery-file-upload code\n\u30fb\u30fb\u30fb\u7701\u7565\u30fb\u30fb\u30fb\n\njQuery-File-Upload callbacks\n\u30bf\u30b0 <script></script> \u3092\u8ffd\u52a0\u3057\u307e\u3059\u3002\n\napp/views/users/new.html.erb\n<h1>New user</h1>\n\n<%= render 'form' %>\n\n<%= link_to 'Back', users_path %>\n\n<script>\n$(function() {\n  $('.directUpload').find(\"input:file\").each(function(i, elem) {\n    var fileInput    = $(elem);\n    var form         = $(fileInput.parents('form:first'));\n    var submitButton = form.find('input[type=\"submit\"]');\n    var progressBar  = $(\"<div class='bar'></div>\");\n    var barContainer = $(\"<div class='progress'></div>\").append(progressBar);\n    fileInput.after(barContainer);\n    fileInput.fileupload({\n      fileInput:       fileInput,\n      url:             '<%= @s3_direct_post.url %>',\n      type:            'POST',\n      autoUpload:       true,\n      formData:         <%= @s3_direct_post.fields.to_json.html_safe %>,\n      paramName:        'file',\n      dataType:         'XML',\n      replaceFileInput: false,\n      progressall: function (e, data) {\n        var progress = parseInt(data.loaded / data.total * 100, 10);\n        progressBar.css('width', progress + '%')\n      },\n      start: function (e) {\n        submitButton.prop('disabled', true);\n\n        progressBar.\n          css('background', 'green').\n          css('display', 'block').\n          css('width', '0%').\n          text(\"Loading...\");\n      },\n      done: function(e, data) {\n        submitButton.prop('disabled', false);\n        progressBar.text(\"Uploading done\");\n\n        // extract key and generate URL from response\n        var key   = $(data.jqXHR.responseXML).find(\"Key\").text();\n        var url   = '//<%= @s3_direct_post.url.host %>/' + key;\n\n        // create hidden field\n        var input = $(\"<input />\", { type:'hidden', name: fileInput.attr('name'), value: url })\n        form.append(input);\n      },\n      fail: function(e, data) {\n        submitButton.prop('disabled', false);\n\n        progressBar.\n          css(\"background\", \"red\").\n          text(\"Failed\");\n      }\n    });\n  });\n});\n</script>\n\n\n\n\u5099\u8003\n# .env\u306e\u74b0\u5883\u5909\u6570\u3092\u53c2\u7167\u3059\u308b\u305f\u3081foreman\u3067\u8d77\u52d5\nforeman run rails server\n\n# \u78ba\u8a8d\naws --profile foo s3 ls s3://aaa-bbb-ccc-1/uploads/\n# \u5168\u3066\u524a\u9664\uff08\u6ce8\u610f\uff01\uff09\naws --profile bar s3 rm s3://aaa-bbb-ccc-1/uploads/ --recursive\n\n\nHeroku Dev Center\u300cDirect to S3 Image Uploads in Rails\u300d\u306e\u899a\u3048\u66f8\u304d\u3067\u3059\u3002\n\n**\u74b0\u5883**\n\n- Rails 4.1.8\n- heroku-toolbelt 3.16.0\n- aws-sdk 1.59.0\n- JQuery UI (1.11.2)\n- jQuery File Upload Plugin (9.8.0)\n\n**\u30b5\u30f3\u30d7\u30eb**\n\n- https://github.com/usutani/direct-s3-example\n\n**\u53c2\u7167**\n\n- [Direct to S3 Image Uploads in Rails | Heroku Dev Center](https://devcenter.heroku.com/articles/direct-to-s3-image-uploads-in-rails)\n- [CORS(Cross-Origin Resource Sharing)\u306b\u3064\u3044\u3066\u6574\u7406\u3057\u3066\u307f\u305f \uff5c Developers.IO](http://dev.classmethod.jp/etc/about-cors/)\n\n# \u899a\u3048\u66f8\u304d\n## Philosophy\n\n\u3053\u306e\u8a18\u4e8b\u3067\u306f [jQuery-File-Upload](https://github.com/blueimp/jQuery-File-Upload)\u30d7\u30e9\u30b0\u30a4\u30f3\u3068 AWS gem \u3092\u7528\u3044\u307e\u3059\u3002\n\u753b\u50cf\u3092S3\u306b\u76f4\u63a5\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u3067\u304d\u308b [CarrierWaveDirect](https://github.com/dwilkie/carrierwave_direct) \u306e\u3088\u3046\u306a\u4ed6\u306e\u30e9\u30a4\u30d6\u30e9\u30ea\u3082\u3042\u308a\u307e\u3059\u304c\u3001\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u5074\u306b\u95a2\u3059\u308b\u4f4e\u30ec\u30d9\u30eb\u306e\u77e5\u8b58\u306a\u3057\u3067\u306e\u305d\u308c\u3089\u306e\u5b9f\u88c5\u306f\u56f0\u96e3\u3067\u3059\u3002\n\njQuery-File-Upload \u30d7\u30e9\u30b0\u30a4\u30f3\u3092\u7528\u3044\u308b\u3068\u3001JavaScript \u306e\u30b3\u30fc\u30c9\u306f\u6bd4\u8f03\u7684\u8aad\u307f\u3084\u3059\u304f\u77ed\u3044\u3082\u306e\u306b\u306a\u308a\u3001\u305d\u306e\u30b3\u30fc\u30c9\u3092\u4efb\u610f\u306e\u753b\u50cf\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u5165\u529b\u30d5\u30a9\u30fc\u30e0\u3068\u3057\u3066\u518d\u5229\u7528\u3059\u308b\u3053\u3068\u3082\u3067\u304d\u307e\u3059\u3002\n\u307e\u305f\u3001\u30e6\u30fc\u30b6\u30a4\u30f3\u30bf\u30d5\u30a7\u30fc\u30b9\u306f\u975e\u5e38\u306b\u30ab\u30b9\u30bf\u30de\u30a4\u30ba\u53ef\u80fd\u3067\u3059\u3002\nRails\u5074\u3067\u306f\u3001AWS\u3067\u4e8b\u524d\u306b\u7f72\u540d\u3057\u305fPOST\u3092\u751f\u6210\u3057\u3001\u753b\u50cf\u306eURL\u3092\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306b\u4fdd\u5b58\u3057\u307e\u3059\u3002\n\n## Example app\n\n\u3053\u306e\u30a2\u30d7\u30ea\u3067\u306f ```User``` \u30e2\u30c7\u30eb\u3092\u6301\u3061\u3001\u30a2\u30d0\u30bf\u30fc\u753b\u50cf\u3092\u30e6\u30fc\u30b6\u30fc\u5358\u4f4d\u3067 S3 \u306b\u4fdd\u5b58\u3057\u305f\u3044\u3068\u601d\u3044\u307e\u3059\u3002\n\n```bash\nrails new direct-s3-example\ncd direct-s3-example\nrails generate scaffold user name avatar_url\nrake db:migrate\n```\n## S3\n\n\u30d5\u30a1\u30a4\u30eb\u3092 S3 \u306b\u9001\u308b\u524d\u306b\u3001[S3 \u306e\u30a2\u30ab\u30a6\u30f3\u30c8](https://devcenter.heroku.com/articles/s3)\u3068\u3001\u9069\u5207\u306b\u69cb\u6210\u3055\u308c\u305f\u30d0\u30b1\u30c3\u30c8\u304c\u5fc5\u8981\u306b\u306a\u308a\u307e\u3059\u3002\n\n## S3 SDK\n\n\u6b21\u306b Ruby \u3067 S3 \u3068\u3084\u308a\u3068\u308a\u3059\u308b\u305f\u3081\u306e\u30e9\u30a4\u30d6\u30e9\u30ea\u304c\u5fc5\u8981\u306b\u306a\u308a\u307e\u3059\u3002\naws-sdk \u3092 Gemfile \u306b\u8ffd\u52a0\u3057\u3066 ```bundle install``` \u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n```ruby:Gemfile\ngem 'aws-sdk'\n```\n\n\u30ed\u30fc\u30ab\u30eb\u306e\u958b\u767a\u3067\u306f\u3001```.env``` \u30d5\u30a1\u30a4\u30eb\u3068 [Foreman](https://github.com/ddollar/foreman) \u3092\u4f7f\u3044\u307e\u3059\u3002\n\u6b21\u306e\u3088\u3046\u306b\u74b0\u5883\u5909\u6570\u3092\u8ffd\u52a0\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\u5c1a\u3001\u4e0b\u8a18\u306e\u5024\u306f\u4f8b\u3067\u3059\u306e\u3067\u3001S3 \u3067\u8a2d\u5b9a\uff0f\u53d6\u5f97\u3057\u305f\u3082\u306e\u3092\u66f8\u3044\u3066\u304f\u3060\u3055\u3044\u3002\n\n```.env\nS3_BUCKET=my-s3-development\nAWS_ACCESS_KEY_ID=EXAMPLEKVFOOOWWPYA\nAWS_SECRET_ACCESS_KEY=exampleBARZHS3sRew8xw5hiGLfroD/b21p2l\n```\n\n\u78ba\u8a8d\n\n```bash\n$ foreman run rails runner \"puts ENV['S3_BUCKET']\"\nmy-s3-development\n```\n\n\u74b0\u5883\u5909\u6570\u3092\u8a2d\u5b9a\u3067\u304d\u305f\u3089\u3001\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u30fc\u304b\u3089\u4f7f\u3048\u308b\u3088\u3046\u306b S3 \u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u7528\u610f\u3057\u307e\u3059\u3002\n\n```ruby:config/initializers/aws.rb\nAWS.config(access_key_id:     ENV['AWS_ACCESS_KEY_ID'],\n           secret_access_key: ENV['AWS_SECRET_ACCESS_KEY'] )\n\nS3_BUCKET = AWS::S3.new.buckets[ENV['S3_BUCKET']]\n```\n\n## Cross origin support\n\n[\uff08\u53c2\u8003\uff09CORS(Cross-Origin Resource Sharing)\u306b\u3064\u3044\u3066\u6574\u7406\u3057\u3066\u307f\u305f](http://dev.classmethod.jp/etc/about-cors/)\n\n\u74b0\u5883\u306b\u5408\u308f\u305b\u3066\u30d0\u30b1\u30c3\u30c8\u306e CORS \u8a2d\u5b9a\u3092\u5909\u66f4\u3057\u307e\u3059\u3002\n\u9069\u5207\u306a\u30aa\u30ea\u30b8\u30f3\u3092 ```AllowedOrigin``` \u306b\u8a2d\u5b9a\u3057\u307e\u3057\u3087\u3046\u3002\n\n```xml\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<CORSConfiguration xmlns=\"http://s3.amazonaws.com/doc/2006-03-01/\">\n    <CORSRule>\n        <AllowedOrigin>*</AllowedOrigin>\n        <AllowedMethod>GET</AllowedMethod>\n        <AllowedMethod>POST</AllowedMethod>\n        <AllowedMethod>PUT</AllowedMethod>\n        <AllowedHeader>*</AllowedHeader>\n    </CORSRule>\n</CORSConfiguration>\n```\n\n## Pre-signed post\n\nAWS ruby gem \u3067\u4e8b\u524d\u306b\u7f72\u540d\u3057\u305f(Pre-signed)POST\u3092\u751f\u6210\u3057\u307e\u3059\u3002\n\n\u3042\u306a\u305f\u306e\u30e6\u30fc\u30b6\u30fc\u3084\u9867\u5ba2\u304c\u7279\u5b9a\u306e\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u3042\u306a\u305f\u306e\u30d0\u30b1\u30c3\u30c8\u306b\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u3057\u305f\u3044\u5834\u5408\u306b\u3001\u4e8b\u524d\u306b\u7f72\u540d\u3057\u305fURL\u306f\u5f79\u7acb\u3061\u307e\u3059\u3002\u8a73\u3057\u304f\u306f [Class: AWS::S3::PresignedPost](http://docs.aws.amazon.com/AWSRubySDK/latest/AWS/S3/PresignedPost.html) \u3092\u3054\u89a7\u304f\u3060\u3055\u3044\u3002\n\nusers_controller.rb \u306b pre-signed post \u3092\u751f\u6210\u3059\u308b\u884c\u3092\u8ffd\u52a0\u3057\u307e\u3059\u3002\n\n```ruby:app/controllers/users_controller.rb\n  # GET /users/new\n  def new\n    @s3_direct_post = S3_BUCKET.presigned_post(\n      key: \"uploads/#{SecureRandom.uuid}/${filename}\",\n      success_action_status: 201,\n      acl: :public_read)\n    @user = User.new\n  end\n```\n\n## Client side code\n\n\u4e00\u6642\u7684\u306a\u30ad\u30e3\u30c3\u30b7\u30e5\u3068\u3057\u3066\u30b5\u30fc\u30d0\u30fc\u306b\u983c\u308b\u3053\u3068\u306f\u3067\u304d\u306a\u3044\u306e\u3067\u3001S3 \u306b\u30d5\u30a1\u30a4\u30eb\u3092\u914d\u4fe1\u3059\u308b\u305f\u3081\u306b\u3001\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u5074\u306e\u30b3\u30fc\u30c9\uff08JavaScript\uff09\u3092\u4f7f\u7528\u3057\u306a\u3051\u308c\u3070\u306a\u308a\u307e\u305b\u3093\u3002\n\nHTML 5\u306f\u30d5\u30a1\u30a4\u30ebAPI\u3092\u5c0e\u5165\u3057\u3066\u3044\u307e\u3059\u304c\u3001IE 10\u307e\u3067\u30b5\u30dd\u30fc\u30c8\u3055\u308c\u307e\u305b\u3093\u3067\u3057\u305f\u3002\u3053\u308c\u3092\u56de\u907f\u3059\u308b\u305f\u3081\u306b\u3001jQuery File Upload \u3092\u4f7f\u3044\u307e\u3059\u3002\u3053\u308c\u3092\u4f7f\u3046\u306b\u306f\u5148\u306b JQuery UI \u304c\u5fc5\u8981\u306b\u306a\u308a\u307e\u3059\u3002\n\n- JQuery UI\n- jQuery File Upload\n\nRails \u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u306b JavaScript \u30d5\u30a1\u30a4\u30eb\u3092\u53d6\u308a\u8fbc\u307f\u307e\u3059\u3002\n\n```bash\n$ curl \\\nhttps://raw.githubusercontent.com/jquery/jquery-ui/master/ui/widget.js \\\n>> app/assets/javascripts/jquery.ui.widget.js\n\n$ curl \\\nhttps://raw.githubusercontent.com/blueimp/jQuery-File-Upload/master/js/jquery.fileupload.js \\\n>> app/assets/javascripts/z.jquery.fileupload.js\n```\n\n```js:app/assets/javascripts/application.js\n.\n.\n//= require jquery.ui.widget.js\n//= require z.jquery.fileupload\n//= require_tree .\n```\n\n\u78ba\u8a8d\n\n```bash\nrails s\nopen http://localhost:3000/users/new\n```\n\n```js:JavaScript\u30b3\u30f3\u30bd\u30fc\u30eb\n> console.log($().fileupload)\nfunction ( options ) {\n          var isMethodCall = typeof options === \"string\",\n               args = slice.call( arguments, 1 ),\n               returnValue = this;\n//...\n```\n\n## Prepare the view\n\n- form_for \u306b directUpload \u30af\u30e9\u30b9\u3092\u8ffd\u52a0\n- avatar_url \u3092 f.file_field \u306b\u5909\u66f4\n\n```erb:app/views/users/_form.html.erb\n<%= form_for(@user, html: { class: \"directUpload\" }) do |f| %>\n  <% if @user.errors.any? %>\n.\n.\n<div class=\"field\">\n  <%= f.label :avatar_url %><br>\n  <%= f.file_field :avatar_url %>\n</div>\n```\n\n## Detecting file field on the client side\n\n\u4ee5\u4e0b\u306e\u3082\u306e\u304c\u7528\u610f\u3067\u304d\u307e\u3057\u305f\u3002\n\n- S3 \u30d0\u30b1\u30c3\u30c8\n- \u6709\u52b9\u306a pre-signed post \u30aa\u30d6\u30b8\u30a7\u30af\u30c8\n- User \u30e2\u30c7\u30eb\uff08avatar_url\u3001\u30d5\u30a1\u30a4\u30eb\u5165\u529b\uff09\n\n\u30e6\u30fc\u30b6\u30fc\u306e\u753b\u50cf\u3092 S3 \u304b\u3089\u53d6\u5f97\u3057\u305f\u308a\u3001avatar_url \u306b URL \u3092\u4fdd\u5b58\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u304c\u3001\u3053\u308c\u306f\u4e3b\u306b JavaScript \u3067\u306e\u624b\u52d5\u51e6\u7406\u306b\u306a\u308a\u307e\u3059\u3002\n\n\u30fb\u30fb\u30fb\u7701\u7565\u30fb\u30fb\u30fb\n\n\u30d7\u30ed\u30b0\u30ec\u30b9\u30d0\u30fc\u306e\u30b9\u30bf\u30a4\u30eb\u3092\u6307\u5b9a\u3057\u307e\u3059\u3002\n\n```css:app/assets/stylesheets/screen.css\n.progress {\n  max-width: 600px;\n  margin:    0.2em 0 0.2em 0;\n}\n\n.progress .bar {\n  height:  1.2em;\n  padding: 0.2em;\n  color:   white;\n  display: none;\n}\n```\n\n## Finished jquery-file-upload code\n\n\u30fb\u30fb\u30fb\u7701\u7565\u30fb\u30fb\u30fb\n\n## jQuery-File-Upload callbacks\n\n\u30bf\u30b0 ```<script></script>``` \u3092\u8ffd\u52a0\u3057\u307e\u3059\u3002\n\n```html:app/views/users/new.html.erb\n<h1>New user</h1>\n\n<%= render 'form' %>\n\n<%= link_to 'Back', users_path %>\n\n<script>\n$(function() {\n  $('.directUpload').find(\"input:file\").each(function(i, elem) {\n    var fileInput    = $(elem);\n    var form         = $(fileInput.parents('form:first'));\n    var submitButton = form.find('input[type=\"submit\"]');\n    var progressBar  = $(\"<div class='bar'></div>\");\n    var barContainer = $(\"<div class='progress'></div>\").append(progressBar);\n    fileInput.after(barContainer);\n    fileInput.fileupload({\n      fileInput:       fileInput,\n      url:             '<%= @s3_direct_post.url %>',\n      type:            'POST',\n      autoUpload:       true,\n      formData:         <%= @s3_direct_post.fields.to_json.html_safe %>,\n      paramName:        'file',\n      dataType:         'XML',\n      replaceFileInput: false,\n      progressall: function (e, data) {\n        var progress = parseInt(data.loaded / data.total * 100, 10);\n        progressBar.css('width', progress + '%')\n      },\n      start: function (e) {\n        submitButton.prop('disabled', true);\n\n        progressBar.\n          css('background', 'green').\n          css('display', 'block').\n          css('width', '0%').\n          text(\"Loading...\");\n      },\n      done: function(e, data) {\n        submitButton.prop('disabled', false);\n        progressBar.text(\"Uploading done\");\n\n        // extract key and generate URL from response\n        var key   = $(data.jqXHR.responseXML).find(\"Key\").text();\n        var url   = '//<%= @s3_direct_post.url.host %>/' + key;\n\n        // create hidden field\n        var input = $(\"<input />\", { type:'hidden', name: fileInput.attr('name'), value: url })\n        form.append(input);\n      },\n      fail: function(e, data) {\n        submitButton.prop('disabled', false);\n\n        progressBar.\n          css(\"background\", \"red\").\n          text(\"Failed\");\n      }\n    });\n  });\n});\n</script>\n```\n\n# \u5099\u8003\n\n```bash\n# .env\u306e\u74b0\u5883\u5909\u6570\u3092\u53c2\u7167\u3059\u308b\u305f\u3081foreman\u3067\u8d77\u52d5\nforeman run rails server\n```\n\n```bash\n# \u78ba\u8a8d\naws --profile foo s3 ls s3://aaa-bbb-ccc-1/uploads/\n# \u5168\u3066\u524a\u9664\uff08\u6ce8\u610f\uff01\uff09\naws --profile bar s3 rm s3://aaa-bbb-ccc-1/uploads/ --recursive\n```\n", "tags": ["Rails", "S3"]}