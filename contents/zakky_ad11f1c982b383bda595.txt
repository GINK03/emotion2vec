{"context": " More than 1 year has passed since last update.\n\nEC2 Run Command\u3068\u306f\nEC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306bssm-agent\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3066\u304a\u304f\u3053\u3068\u3067\u3001\u30b5\u30fc\u30d0\u3078\u30ed\u30b0\u30a4\u30f3\u3059\u308b\u3053\u3068\u306a\u304f\u5916\u90e8\u304b\u3089\u4efb\u610f\u306e\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u51fa\u6765\u307e\u3059\u3002\n\u4ee5\u524d\u306fMS Windows\u306e\u307f\u306e\u5bfe\u5fdc\u3067\u3057\u305f\u304c\u3001Linux\u306b\u3082\u5bfe\u5fdc\u3002\u307f\u3093\u306a\u3053\u308c\u3092\u5f85\u3063\u3066\u3044\u305f\uff01\uff08\u306f\u305a\uff09\n\u5916\u90e8\u304b\u3089\u5185\u90e8\u3078\u306e\u901a\u4fe1\u306f\u7121\u304f\u30a8\u30fc\u30b8\u30a7\u30f3\u30c8\u5074\u304b\u3089AWS\u306e\u7ba1\u7406\u30b5\u30fc\u30d0\u3078\u901a\u4fe1\u3092\u884c\u3046\u306e\u3067\u5185\u90e8\u304b\u3089\u5916\u90e8\u306e\u901a\u4fe1\u3057\u304b\u767a\u751f\u3057\u307e\u305b\u3093\u304b\u3089\u3001\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u304c\u5916\u90e8\u3068\u901a\u4fe1\u53ef\u80fd\u306a\u74b0\u5883\u3067\u3042\u308c\u3070\u52d5\u4f5c\u3057\u307e\u3059\u3002\n\u4eca\u56de\u306f\u30b5\u30f3\u30d7\u30eb\u3068\u3057\u3066\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u305fnginx Web\u30b5\u30fc\u30d0\u3092\u5916\u90e8\u304b\u3089\u505c\u6b62\u3055\u305b\u3001\u30ed\u30b0\u30a4\u30f3\u305b\u305a\u3068\u3082\u30b5\u30fc\u30d0\u4e0a\u3067\u4efb\u610f\u306e\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3067\u304d\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n\u524d\u63d0\u6761\u4ef6\n\n\u30c7\u30d5\u30a9\u30eb\u30c8VPC\u306e\u5b58\u5728\n\u30c7\u30d5\u30a9\u30eb\u30c8VPC\u304c\u5b58\u5728\u3059\u308b\u3053\u3068\u3002\n\u5b58\u5728\u3057\u306a\u304f\u3066\u3082\u52d5\u4f5c\u3057\u307e\u3059\u304c\u3001\u5404\u7a2e\u30b3\u30de\u30f3\u30c9\u5b9f\u884c\u6642\u306e\u30aa\u30d7\u30b7\u30e7\u30f3\u6307\u5b9a\u306f\u9069\u5b9c\u884c\u3063\u3066\u304f\u3060\u3055\u3044\u3002\n\n\u5b9f\u884c\u6a29\u9650\nEC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u8d77\u52d5\u3059\u308b\u6a29\u9650\u304c\u3042\u308b\u3053\u3068\u3002\nIAM\u3092\u4f5c\u6210\u3059\u308b\u6a29\u9650\u304c\u3042\u308b\u3053\u3068\u3002\n\u3053\u308c\u3089\u3092\u6e80\u305f\u3059\u30a2\u30ab\u30a6\u30f3\u30c8\u60c5\u5831\u3092 aws configure \u3067\u767b\u9332\u3057\u3066\u304a\u3044\u3066\u304f\u3060\u3055\u3044\u3002\n\nAWS CLI\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\n\u4ee5\u4e0b\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u3067\u52d5\u4f5c\u78ba\u8a8d\u6e08\n\nAWS CLI 1.9.14\n\n\n\u30b3\u30de\u30f3\u30c9\naws --version\n\n\n\n\u7d50\u679c(\u4f8b)\n      aws-cli/1.9.14 Python/2.6.6 Linux/2.6.32 botocore/1.3.14\n\n\n\n0. \u4e8b\u524d\u4f5c\u696d\n\n0.1. \u30ea\u30fc\u30b8\u30e7\u30f3\u306e\u6c7a\u5b9a\n\u73fe\u5728\u4e00\u90e8\u306e\u30ea\u30fc\u30b8\u30e7\u30f3\u306e\u307f\u5bfe\u5fdc\u3057\u3066\u3044\u3066\u6771\u4eac\u306f\u307e\u3060\u3067\u3059\u3002\n\u4eca\u56de\u306f us-west-2 (\u30aa\u30ec\u30b4\u30f3)\u3067\u5b9f\u884c\u3057\u307e\u3059\u3002\n(\u30ab\u30ec\u30f3\u30c8\u30e6\u30fc\u30b6\u304c\u5229\u7528\u3059\u308b\u30ab\u30ec\u30f3\u30c8\u30ea\u30fc\u30b8\u30e7\u30f3\u3082\u5207\u308a\u5909\u308f\u308a\u307e\u3059\u3002)\n\n\u5909\u6570\u306e\u8a2d\u5b9a\nexport AWS_DEFAULT_REGION='us-west-2'\n\n\n\n0.2. \u5909\u6570\u306e\u78ba\u8a8d\n\u30d7\u30ed\u30d5\u30a1\u30a4\u30eb\u3068\u30ea\u30fc\u30b8\u30e7\u30f3\u304c\u60f3\u5b9a\u306e\u3082\u306e\u306b\u306a\u3063\u3066\u3044\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n\u30b3\u30de\u30f3\u30c9\naws configure list\n\n\n\n\u7d50\u679c(\u4f8b)\n            Name                    Value             Type    Location\n            ----                    -----             ----    --------\n         profile                <not set>             None    None\n      access_key     ****************M73Q shared-credentials-file\n      secret_key     ****************YWg/ shared-credentials-file\n          region                us-west-2              env    AWS_DEFAULT_REGION\n\n\n\n1. IAM\u306e\u6e96\u5099\n\n1.1. IAM\u30ed\u30fc\u30eb\u306e\u4f5c\u6210\n\n\u30b3\u30de\u30f3\u30c9\nROLE_NAME=\"ec2-handson-role\"\naws iam create-role --role-name ${ROLE_NAME} --assume-role-policy-document '{ \"Version\": \"2012-10-17\", \"Statement\": [ { \"Effect\": \"Allow\", \"Principal\": { \"Service\": \"ec2.amazonaws.com\"}, \"Action\": \"sts:AssumeRole\" } ] }'\n\n\n\n\u7d50\u679c(\u4f8b)\n{\n    \"Role\": {\n        \"AssumeRolePolicyDocument\": {\n            \"Version\": \"2012-10-17\",\n            \"Statement\": [\n                {\n                    \"Action\": \"sts:AssumeRole\",\n                    \"Effect\": \"Allow\",\n                    \"Principal\": {\n                        \"Service\": \"ec2.amazonaws.com\"\n                    }\n                }\n            ]\n        },\n        \"RoleId\": \"AROAIXFYSOEMNKZQ6532G\",\n        \"CreateDate\": \"2015-12-21T06:00:03.792Z\",\n        \"RoleName\": \"ec2-handson-role\",\n        \"Path\": \"/\",\n        \"Arn\": \"arn:aws:iam::454200CLI555:role/ec2-handson-role\"\n    }\n}\n\n\n\n1.2. IAM\u30ed\u30fc\u30eb\u3078Policy\u3092\u8ffd\u52a0\nEC2 Run Command\u306b\u5fc5\u8981\u306a\u30dd\u30ea\u30b7\u30fc\u3067\u3042\u308b AmazonEC2RoleforSSM \u3092IAM\u30ed\u30fc\u30eb\u3078\u4ed8\u4e0e\u3057\u307e\u3059\u3002\nPolicy AmazonEC2RoleforSSM\u306eARN\u3092\u53d6\u5f97\u3002\n\n\u30b3\u30de\u30f3\u30c9\naws iam list-policies | grep AmazonEC2RoleforSSM\n\n\n\n\u7d50\u679c\n            \"PolicyName\": \"AmazonEC2RoleforSSM\",\n            \"Arn\": \"arn:aws:iam::aws:policy/service-role/AmazonEC2RoleforSSM\",\n\n\n\"Arn\"\u6b04\u306e arn: \u3067\u59cb\u307e\u308b\u6587\u5b57\u5217\u3092\u30b3\u30d4\u30fc\u3057\u3066\u3001\u6b21\u306e\u30b3\u30de\u30f3\u30c9\uff11\u884c\u76ee POLICY_ARN \u306b\u5165\u308c\u307e\u3059\u3002\uff08\u305f\u3076\u3093jq\u3092\u4f7f\u3046\u3068\u81ea\u52d5\u3067\u5165\u308b\u6c17\u304c\u3059\u308b\u3051\u3069jq\u306f\u308f\u304b\u3089\u306a\u3044\uff09\n\n\u30b3\u30de\u30f3\u30c9\nPOLICY_ARN=\"arn:aws:iam::aws:policy/service-role/AmazonEC2RoleforSSM\"\naws iam attach-role-policy --role-name ${ROLE_NAME} --policy-arn ${POLICY_ARN}\n\n\n\n\u7d50\u679c\n\u8fd4\u308a\u5024\u306a\u3057\n\n\n\n1.3. \u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u30d7\u30ed\u30d5\u30a1\u30a4\u30eb\u306e\u4f5c\u6210\n\n\u30b3\u30de\u30f3\u30c9\nINSTANCE_PROFILE_NAME=\"ec2-handson-profile\"\naws iam create-instance-profile --instance-profile-name ${INSTANCE_PROFILE_NAME}\n\n\n\n\u7d50\u679c(\u4f8b)\n{\n    \"InstanceProfile\": {\n        \"InstanceProfileId\": \"AIPAIWWQNUCXKCYHEZ46O\",\n        \"Roles\": [],\n        \"CreateDate\": \"2015-12-21T05:54:47.445Z\",\n        \"InstanceProfileName\": \"ec2-handson-profile\",\n        \"Path\": \"/\",\n        \"Arn\": \"arn:aws:iam::454200CLI555:instance-profile/ec2-handson-profile\"\n    }\n}\n\n\n\n1.4. \u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u30d7\u30ed\u30d5\u30a1\u30a4\u30eb\u3078IAM\u30ed\u30fc\u30eb\u3092\u8ffd\u52a0\n\n\u30b3\u30de\u30f3\u30c9\naws iam add-role-to-instance-profile --instance-profile-name ${INSTANCE_PROFILE_NAME} --role-name ${ROLE_NAME}\n\n\n\n\u7d50\u679c\n\u8fd4\u308a\u5024\u306a\u3057\n\n\n\n2. EC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u6e96\u5099\n\n2.1. \u9375\u30da\u30a2\u306e\u4f5c\u6210\uff08\u4efb\u610f\uff09\n\u9375\u30da\u30a2\u3092\u65e2\u306b\u4f5c\u6210\u6e08\u307f\u306e\u5834\u5408\u3001\u3053\u306e\u4f5c\u696d\u306f\u4e0d\u8981\u3067\u3059\u3002\n\u9375\u30da\u30a2 oregon \u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\u79d8\u5bc6\u9375\u30d5\u30a1\u30a4\u30eb\u306f ~/.ssh/oregon.pem \u306b\u4fdd\u5b58\u3055\u308c\u307e\u3059\u3002\n\n\u30b3\u30de\u30f3\u30c9\nEC2_KEY_NAME=\"oregon\"\nFILE_SSH_KEY=\"${HOME}/.ssh/${EC2_KEY_NAME}.pem\"\naws ec2 create-key-pair --key-name ${EC2_KEY_NAME} --query 'KeyMaterial' --output text > ${FILE_SSH_KEY} && cat ${FILE_SSH_KEY} && chmod 600 ${FILE_SSH_KEY}\n\n\n\n\u7d50\u679c(\u4f8b)\n-----BEGIN RSA PRIVATE KEY-----\nMIIEowIBAAKCAQEAg4AFnT934UdMmuSADElYSWzOQ/XpXUc0570zKwtDB3RXS9Fi8YP8J5jv6QRl\n\uff08\u672c\u5f53\u306f\u3082\u3063\u3068\u9577\u3044\uff09\nMfRletfQDp2Hbth3SnNu2MaFQs8C+ODyx7XTx/13LW247AGVsSfq63jovntOL7PRuFA=\n-----END RSA PRIVATE KEY-----\n\n\n\n2.2. \u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u30b0\u30eb\u30fc\u30d7\u306e\u4f5c\u6210\uff08\u4efb\u610f\uff09\n\u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u30b0\u30eb\u30fc\u30d7\u3092\u65e2\u306b\u4f5c\u6210\u6e08\u307f\u306e\u5834\u5408\u3001\u3053\u306e\u4f5c\u696d\u306f\u4e0d\u8981\u3067\u3059\u3002\n\u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u30b0\u30eb\u30fc\u30d7 ec2-handson-sg \u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n\u30b3\u30de\u30f3\u30c9\nSG_NAME=\"ec2-handson-sg\"\naws ec2 create-security-group --group-name ${SG_NAME} --description ${SG_NAME}\nSG_ID=`aws ec2 describe-security-groups --filter Name=group-name,Values=${SG_NAME} --query 'SecurityGroups[].GroupId' --output text` && echo ${SG_ID}\n\n\n\n\u7d50\u679c(\u4f8b)\n      {\n          \"GroupId\": \"sg-59c3e63d\"\n      }\n\n      sg-59c3e63d\n\n\n\u5916\u90e8\u304b\u3089\u306eHTTP\u63a5\u7d9a\u3092\u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u30b0\u30eb\u30fc\u30d7\u306b\u8ffd\u52a0\u3002\n\u3042\u3048\u3066SSH\u306f\u8ffd\u52a0\u305b\u305a\u30ed\u30b0\u30a4\u30f3\u4e0d\u80fd\u306a\u72b6\u614b\u306b\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\n\u30b3\u30de\u30f3\u30c9\naws ec2 authorize-security-group-ingress --group-id ${SG_ID} --protocol 'tcp' --port 80 --cidr 0.0.0.0/0\n\n\n\n\u7d50\u679c\n      (\u623b\u308a\u5024\u306a\u3057)\n\n\n\n2.3. Userdata\u30d5\u30a1\u30a4\u30eb\u306e\u4f5c\u6210\nUserdata\u306fEC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u4f5c\u6210\u6642\u306b\u5b9f\u884c\u3055\u308c\u308bShellScript\u3067\u3059\u3002\nyum update\u3092\u884c\u3044\u3001nginx\u3068amazon-ssm-agent\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u307e\u3059\u3002\n\n\u30b3\u30de\u30f3\u30c9\ncat << EOF > ssm.sh\n#!/bin/bash\nyum -y update\ncurl https://amazon-ssm-us-west-2.s3.amazonaws.com/latest/linux_amd64/amazon-ssm-agent.rpm -o amazon-ssm-agent.rpm\nyum install -y amazon-ssm-agent.rpm nginx\nchkconfig nginx on\nservice nginx start\nEOF\nchmod 755 ssm.sh\n\n\n\n\u7d50\u679c\n\u8fd4\u308a\u5024\u306a\u3057\n\n\nUserdata\u306f\u4f5c\u6210\u3057\u305f\u30ed\u30fc\u30ab\u30eb\u30d5\u30a1\u30a4\u30eb\u304c\u8ee2\u9001\u3055\u308c\u3001\u6a29\u9650\u304c\u5f15\u304d\u7d99\u304c\u308c\u307e\u3059\u3002\n\u30d5\u30a1\u30a4\u30eb\u306b\u5b9f\u884c\u6a29\u9650\u304c\u7121\u3044\u3068\u66f8\u3044\u3066\u3082EC2\u4e0a\u3067\u5b9f\u884c\u3055\u308c\u306a\u3044\u306e\u3067\u6ce8\u610f\u304c\u5fc5\u8981\u3067\u3059\u3002\n\u3053\u306e\u305f\u3081\u30d5\u30a1\u30a4\u30eb\u4f5c\u6210\u5f8c chmod \u306b\u3066\u6a29\u9650\u3092\u8a2d\u5b9a\u3057\u3066\u3044\u307e\u3059\u3002\n\n2.4. \u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u8d77\u52d5\nAmazon Linux(2015-09)\u3092\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u30bf\u30a4\u30d7t2.micro\u3067\u8d77\u52d5\u3057\u307e\u3059\u3002\nAMI ID\u306e\u53d6\u5f97:\n\n\u30b3\u30de\u30f3\u30c9\nAMI_NAME='amzn-ami-hvm-2015.09.0.x86_64-gp2'\nAMI_ID=`aws ec2 describe-images --filters Name=name,Values=${AMI_NAME} --query 'Images[].ImageId' --output text` && echo ${AMI_ID}\n\n\n\n\u7d50\u679c\n      ami-9ff7e8af\n\n\n\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u8d77\u52d5\n\n\u30b3\u30de\u30f3\u30c9\naws ec2 run-instances --image-id ${AMI_ID} --associate-public-ip-address --instance-type t2.micro --key-name ${EC2_KEY_NAME} --region ${AWS_DEFAULT_REGION} --security-group-ids ${SG_ID} --user-data file://ssm.sh --iam-instance-profile Name=${INSTANCE_PROFILE_NAME}\n\n\n\n\u7d50\u679c(\u4f8b)\n{\n    \"OwnerId\": \"454200CLI555\",\n    \"ReservationId\": \"r-c38b2806\",\n    \"Groups\": [],\n    \"Instances\": [\n        {\n            \"Monitoring\": {\n                \"State\": \"disabled\"\n            },\n            \"PublicDnsName\": \"\",\n            \"RootDeviceType\": \"ebs\",\n            \"State\": {\n                \"Code\": 0,\n                \"Name\": \"pending\"\n            },\n            \"EbsOptimized\": false,\n            \"LaunchTime\": \"2015-12-21T06:13:03.000Z\",\n            \"PrivateIpAddress\": \"172.31.20.212\",\n            \"ProductCodes\": [],\n            \"VpcId\": \"vpc-77777777\",\n            \"StateTransitionReason\": \"\",\n            \"InstanceId\": \"i-685357ac\",\n            \"ImageId\": \"ami-f0091d91\",\n            \"PrivateDnsName\": \"ip-172-31-20-212.us-west-2.compute.internal\",\n            \"KeyName\": \"oregon\",\n            \"SecurityGroups\": [\n                {\n                    \"GroupName\": \"handson\",\n                    \"GroupId\": \"sg-77777777\"\n                }\n            ],\n            \"ClientToken\": \"\",\n            \"SubnetId\": \"subnet-77777777\",\n            \"InstanceType\": \"t2.micro\",\n            \"NetworkInterfaces\": [\n                {\n                    \"Status\": \"in-use\",\n                    \"MacAddress\": \"02:37:b4:3f:70:a7\",\n                    \"SourceDestCheck\": true,\n                    \"VpcId\": \"vpc-77777777\",\n                    \"Description\": \"\",\n                    \"NetworkInterfaceId\": \"eni-87217bfe\",\n                    \"PrivateIpAddresses\": [\n                        {\n                            \"PrivateDnsName\": \"ip-172-31-20-212.us-west-2.compute.internal\",\n                            \"Primary\": true,\n                            \"PrivateIpAddress\": \"172.31.20.212\"\n                        }\n                    ],\n                    \"PrivateDnsName\": \"ip-172-31-20-212.us-west-2.compute.internal\",\n                    \"Attachment\": {\n                        \"Status\": \"attaching\",\n                        \"DeviceIndex\": 0,\n                        \"DeleteOnTermination\": true,\n                        \"AttachmentId\": \"eni-attach-58f92752\",\n                        \"AttachTime\": \"2015-12-21T06:13:03.000Z\"\n                    },\n                    \"Groups\": [\n                        {\n                            \"GroupName\": \"handson\",\n                            \"GroupId\": \"sg-77777777\"\n                        }\n                    ],\n                    \"SubnetId\": \"subnet-77777777\",\n                    \"OwnerId\": \"454200CLI555\",\n                    \"PrivateIpAddress\": \"172.31.20.212\"\n                }\n            ],\n            \"SourceDestCheck\": true,\n            \"Placement\": {\n                \"Tenancy\": \"default\",\n                \"GroupName\": \"\",\n                \"AvailabilityZone\": \"us-west-2b\"\n            },\n            \"Hypervisor\": \"xen\",\n            \"BlockDeviceMappings\": [],\n            \"Architecture\": \"x86_64\",\n            \"StateReason\": {\n                \"Message\": \"pending\",\n                \"Code\": \"pending\"\n            },\n            \"IamInstanceProfile\": {\n                \"Id\": \"AIPAIVIS7IIM3UPFCZLYM\",\n                \"Arn\": \"arn:aws:iam::454200CLI555:instance-profile/ec2-handson-profile\"\n            },\n            \"RootDeviceName\": \"/dev/xvda\",\n            \"VirtualizationType\": \"hvm\",\n            \"AmiLaunchIndex\": 0\n        }\n    ]\n}\n\n\n\n2.5. \u30a4\u30f3\u30b9\u30bf\u30f3\u30b9ID\u306e\u53d6\u5f97\n\n\u30b3\u30de\u30f3\u30c9\nEC2_INSTANCE_ID=`aws ec2 describe-instances --query 'Reservations[].Instances[].InstanceId' --output text` && echo ${EC2_INSTANCE_ID}\n\n\n\n\u7d50\u679c(\u4f8b)\ni-6be2e6af\n\n\n\u4f5c\u696d\u4e2d\u306e\u30ea\u30fc\u30b8\u30e7\u30f3\u306b\u4ed6\u306eEC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u304c\u5b58\u5728\u3059\u308b\u5834\u5408\u3001\u8907\u6570\u8868\u793a\u3055\u308c\u3046\u307e\u304f\u3044\u304d\u307e\u305b\u3093\u3002\n\u3053\u306e\u5834\u5408\u306f 2.4. \u3067\u306e\u51fa\u529b\u7d50\u679c22\u884c\u76ee\u3042\u305f\u308a\u306b\n\"InstanceId\": \"i-6be2e6af\",\n\u3068\u3044\u3063\u305f\u9805\u76ee\u304c\u3042\u308b\u306e\u3067\u3001\u3053\u306e\u5024\u3092\u624b\u52d5\u3067\nEC2_INSTANCE_ID=\"i-6be2e6af\"\n\u306e\u3088\u3046\u306b\u30b3\u30de\u30f3\u30c9\u3092\u6253\u3061\u74b0\u5883\u5909\u6570\u3078\u683c\u7d0d\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n2.6. \u30d1\u30d6\u30ea\u30c3\u30afIP\u30a2\u30c9\u30ec\u30b9\u306e\u53d6\u5f97\n\n\u30b3\u30de\u30f3\u30c9\nEC2_PUBLIC_IP=`aws ec2 describe-instances --instance-id ${EC2_INSTANCE_ID} --query \"Reservations[].Instances[].PublicIpAddress\" --output text` && echo ${EC2_PUBLIC_IP}\n\n\n\n\u7d50\u679c(\u4f8b)\n      54.77.77.777\n\n\n\n2.7. \u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u304c\u52d5\u4f5c\u3059\u308b\u307e\u3067\u6570\u5206\u5f85\u3061\u307e\u3059\n\u901a\u5e38\u3001\u6570\u5206\u3067\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u304c\u8d77\u52d5\u5b8c\u4e86\u3057\u307e\u3059\u304c\u3001userdata\u3067\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u51e6\u7406\u3092\u3057\u3066\u3044\u308b\u306e\u3067\u901a\u5e38\u3088\u308a\u6642\u9593\u304c\u304b\u304b\u308a\u307e\u3059\u3002\nWeb\u30d6\u30e9\u30a6\u30b6\u3067 2.6. \u3067\u8868\u793a\u3055\u308c\u305fIP\u30a2\u30c9\u30ec\u30b9\u3078\u30a2\u30af\u30bb\u30b9\u3057\u3066nginx\u306e\u753b\u9762\u304c\u8868\u793a\u3055\u308c\u305f\u3089\u5b8c\u4e86\u3067\u3059\u3002\nhttp://54.77.77.777/\n\n\n3. EC2 Run Command\u306e\u5b9f\u884c\n\n3.1. EC2 Run Command\u5b9f\u884c\u306e\u8aac\u660e\n\n\u30b3\u30de\u30f3\u30c9\naws ssm send-command \u306b\u3088\u308a\u5b9f\u884c\u3057\u307e\u3059\u3002\n\n\n\u5fc5\u9808\u30aa\u30d7\u30b7\u30e7\u30f3\n--document-name \u5b9f\u884c\u3059\u308b\u30b3\u30de\u30f3\u30c9\u306e\u7a2e\u985e\u3092\u6307\u5b9a\u3057\u307e\u3059\u3002shell\u5b9f\u884c\u306e\u5834\u5408 \"AWS-RunShellScript\"\u3002\u73fe\u72b6Linux\u3067\u306f\u4ed6\u306b \"AWS-UpdateSSMAgent\"\u306e\u307f\u30b5\u30dd\u30fc\u30c8\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n--instance-ids \u30a4\u30f3\u30b9\u30bf\u30f3\u30b9ID\u3092\u6307\u5b9a\u3057\u307e\u3059\u3002\n\n\u4efb\u610f\u30aa\u30d7\u30b7\u30e7\u30f3\n--parameters\u3000\u5f15\u304d\u6e21\u3059\u30d1\u30e9\u30e1\u30fc\u30bf\u3002ShellScript\u306e\u5834\u5408\u306f\u3053\u308c\u3082\u5fc5\u9808\u3067\u3001\u5b9f\u884c\u3059\u308b\u30b3\u30de\u30f3\u30c9\u305d\u306e\u3082\u306e\u3067\u3059\u3002\n--output-s3-bucket-name\u3000\u5b9f\u884c\u7d50\u679c\u3092\u51fa\u529b\u3059\u308bS3\u30d0\u30b1\u30c3\u30c8\u540d\n--output-s3-key-prefix \u51fa\u529b\u3059\u308b\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u540d(\u6307\u5b9a\u3057\u306a\u3044\u3068\u30d0\u30b1\u30c3\u30c8\u76f4\u4e0b\u306b\u51fa\u529b\u3055\u308c\u307e\u3059)\n--cli-input-json JSON\u3088\u304f\u308f\u304b\u308a\u307e\u305b\u3093\n\n\n3.2. \u7d50\u679c\u51fa\u529b\u7528S3\u30d0\u30b1\u30c3\u30c8\u306e\u4f5c\u6210\uff08\u4efb\u610f\uff09\nAWSCLI\u3067\u3082\u30de\u30cd\u30b8\u30e1\u30f3\u30c8\u30b3\u30f3\u30bd\u30fc\u30eb\u3067\u3082\u51fa\u529b\u7d50\u679c\u3092\u78ba\u8a8d\u3067\u304d\u308b\u306e\u3067\u4efb\u610f\u3067\u3059\u304c\u3001\nS3\u30d0\u30b1\u30c3\u30c8\u3092\u6307\u5b9a\u3059\u308b\u3068\u30b3\u30de\u30f3\u30c9\u306e\u5b9f\u884c\u7d50\u679c(\u6a19\u6e96\u51fa\u529b)\u3092\u4fdd\u5b58\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\u3053\u3053\u3067\u306fS3\u30d0\u30b1\u30c3\u30c8\u540d\u3092 ec2-handson \u3068\u3057\u3066\u3044\u307e\u3059\u304c\u3001\u81ea\u5206\u3067\u540d\u524d\u3092\u8003\u3048\u3066\u304f\u3060\u3055\u3044\u3002\n\u3053\u308c\u306f\u5168\u4e16\u754c\u3067\u4e00\u610f\u3067\u3042\u308b\u5fc5\u8981\u304c\u3042\u308a\u540c\u3058\u30d0\u30b1\u30c3\u30c8\u540d\u304c\u4f7f\u3048\u306a\u3044\u304b\u3089\u3067\u3059\u3002\n\n\u30b3\u30de\u30f3\u30c9\nBUCKET_NAME=\"s3://ec2-handson/\"\naws s3 mb ${BUCKET_NAME}\n\n\n\n\u7d50\u679c(\u4f8b)\nmake_bucket: s3://ec2-handson/\n\n\n\n3.2. \u30b3\u30de\u30f3\u30c9\u306e\u5b9f\u884c\n\u4eca\u56de\u306fnginx\u30b5\u30fc\u30d0\u3092\u505c\u6b62\u3055\u305b\u308b\u3079\u304f service nginx stop \u30b3\u30de\u30f3\u30c9\u3067\u3082\u5b9f\u884c\u3057\u3066\u307f\u307e\u3057\u3087\u3046\u3002\n\u306a\u304a\u3001\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u8907\u6570\u6307\u5b9a\u3057\u3066\u540c\u6642\u5b9f\u884c\u3059\u308b\u3053\u3068\u3082\u3067\u304d\u307e\u3059\u3002\n\n\u30b3\u30de\u30f3\u30c9\naws ssm send-command --document-name \"AWS-RunShellScript\" --instance-ids ${EC2_INSTANCE_ID} --parameters '{\"commands\":[\"service nginx stop\"],\"executionTimeout\":[\"300\"]}' --output-s3-bucket-name ${BUCKET_NAME}\n\n\n\n\u7d50\u679c(\u4f8b)\n    \"Command\": {\n        \"Status\": \"Pending\",\n        \"ExpiresAfter\": 1450856459.898,\n        \"Parameters\": {\n            \"commands\": [\n                \"service nginx stop\"\n            ],\n            \"executionTimeout\": [\n                \"300\"\n            ]\n        },\n        \"DocumentName\": \"AWS-RunShellScript\",\n        \"OutputS3BucketName\": \"ec2-handson\",\n        \"OutputS3KeyPrefix\": \"hoge\",\n        \"InstanceIds\": [\n            \"i-2b191aef\"\n        ],\n        \"CommandId\": \"d6b7ae11-ff52-41e8-9578-e8ada35680b8\",\n        \"RequestedDateTime\": 1450855859.898\n    }\n}\n\n\n\n3.3. \u30b3\u30de\u30f3\u30c9\u304c\u5b9f\u884c\u3055\u308c\u305f\u304b\u78ba\u8a8d\nWeb\u30d6\u30e9\u30a6\u30b6\u3092\u30ea\u30ed\u30fc\u30c9\u3057\u3066\u307f\u307e\u3059\u3002\nhttp://54.77.77.777/\n\n\u30b5\u30fc\u30d0\u3078\u63a5\u7d9a\u3067\u304d\u306a\u304f\u306a\u3063\u3066\u3044\u308c\u3070\u6210\u529f\u3067\u3059\u3002\n\n3.4. \u30b3\u30de\u30f3\u30c9\u304c\u5b9f\u884c\u7d50\u679c\u306e\u8868\u793a\n\n\u30b3\u30de\u30f3\u30c9\naws ssm list-command-invocations --detail\n\n\n\n\u7d50\u679c(\u4f8b)\n{\n    \"CommandInvocations\": [\n        {\n            \"Status\": \"Success\",\n            \"CommandPlugins\": [\n                {\n                    \"Status\": \"Success\",\n                    \"Name\": \"aws:runShellScript\",\n                    \"OutputS3BucketName\": \"ec2-handson\",\n                    \"OutputS3KeyPrefix\": \"d6b7ae11-ff52-41e8-9578-e8ada35680b8/i-2b191aef/awsrunShellScript\",\n                    \"ResponseCode\": 0,\n                    \"Output\": \"Stopping nginx: [  OK  ]\\r\\n\",\n                    \"ResponseFinishDateTime\": 1450855860.194,\n                    \"ResponseStartDateTime\": 1450855860.0880001\n                }\n            ],\n            \"InstanceId\": \"i-2b191aef\",\n            \"DocumentName\": \"AWS-RunShellScript\",\n            \"CommandId\": \"d6b7ae11-ff52-41e8-9578-e8ada35680b8\",\n            \"RequestedDateTime\": 1450855859.898\n        }\n    ]\n}\n\n\nStatus: Success \u3068\u306a\u3063\u3066\u3044\u308c\u3070\u5b9f\u884c\u6210\u529f\u3067\u3059\u3002\nOutput: \u306b\u306f\u6a19\u6e96\u51fa\u529b\u306e\u5185\u5bb9\u304c\u8868\u793a\u3055\u308c\u3066\u3044\u307e\u3059\u3002 \"Stopping nginx: [  OK  ]\\r\\n\" \u3068\u6210\u529f\u3057\u3066\u3044\u307e\u3059\u306d\u3002\nS3\u30d0\u30b1\u30c3\u30c8\u3092\u6307\u5b9a\u3057\u305f\u5834\u5408\ns3://\u30d0\u30b1\u30c3\u30c8\u540d/\u30c7\u30a3\u30ec\u30af\u30c8\u30ea/\u30b3\u30de\u30f3\u30c9ID/\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9ID/\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u540d/x.\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u540d/stdout\n\u30d5\u30a1\u30a4\u30eb\u306b\u6a19\u6e96\u51fa\u529b\u306e\u5185\u5bb9\u304c\u8a18\u9332\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n\n3.5. \u30cf\u30de\u308b\u30b3\u30de\u30f3\u30c9\nreboot \u3092\u5b9f\u884c\u3059\u308b\u3053\u3068\u3082\u3067\u304d\u307e\u3059\u304c\u3001\u5ef6\u3005\u3068\u518d\u8d77\u52d5\u3092\u7e70\u308a\u8fd4\u3057\u3066\u3057\u307e\u3044\u307e\u3059\u3002\n\u3053\u308c\u306fssm-agent\u304c\u30b3\u30de\u30f3\u30c9\u5b9f\u884c\u5b8c\u4e86\u306e\u30b9\u30c6\u30fc\u30bf\u30b9\u3092AWS\u306e\u30b5\u30fc\u30d0\u3078\u9001\u308b\u307e\u3067\u306fPending\u72b6\u614b\u306b\u306a\u3063\u3066\u304a\u308a\u3001\nreboot\u3092\u5b9f\u884c\u3057\u305f\u77ac\u9593\u306b\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306f\u30b7\u30e3\u30c3\u30c8\u30c0\u30a6\u30f3\u3059\u308b\u305f\u3081\u5168\u30d7\u30ed\u30bb\u30b9\u304ckill\u3057\u307e\u3059\u304b\u3089ssm-agent\u3082\u6d88\u6ec5\u3059\u308b\u306e\u3067\u6c38\u9060\u306bPending\u72b6\u614b\u3002\n\u305d\u3057\u3066\u518d\u8d77\u52d5\u5f8c\u306b\u518d\u3073reboot\u304c\u5b9f\u884c\u3055\u308c\u3001executionTimeout\u3067\u6307\u5b9a\u3057\u305f\u6642\u9593\u307e\u3067\u5ef6\u3005\u3068\u518d\u8d77\u52d5\u304c\u7e70\u308a\u8fd4\u3055\u308c\u307e\u3059\u3002\n\u3069\u3046\u3057\u3066\u3082\u5b9f\u884c\u3057\u305f\u3044\u5834\u5408\u306f\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u6642\u9593\u309230\u79d2\u3050\u3089\u3044\u306b\u3057\u307e\u3059\u3002\u3053\u308c\u3067\u4e00\u5ea6\u3060\u3051\u5b9f\u884c\u3055\u308c\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u7d42\u4e86\u3068\u306a\u308a\u307e\u3059\u3002\nhalt \u3084 shutdown \u30b3\u30de\u30f3\u30c9\u3082\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u7d42\u4e86\u3068\u306a\u308a\u307e\u3059\u3002\n\u3053\u308c\u3089\u306f\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u304c\u505c\u6b62\u3059\u308b\u306e\u3067\u4f55\u5ea6\u3082\u7e70\u308a\u8fd4\u3055\u308c\u308b\u3053\u3068\u306f\u3042\u308a\u307e\u305b\u3093\u304c\u3001ssm-agent\u304cAWS\u306e\u30b5\u30fc\u30d0\u3078\u7d50\u679c\u3092\u9001\u51fa\u3067\u304d\u305a Status: TimedOut \u306b\u306a\u308a\u307e\u3059\u3002\n\u3044\u305a\u308c\u3082\u5b9f\u5bb3\u306f\u3042\u308a\u307e\u305b\u3093\u304c\u3001\u30ed\u30b0\u3092\u3068\u3057\u3066\u306f\u30a8\u30e9\u30fc\u306b\u5206\u985e\u3055\u308c\u308b\u306e\u3067\u4f55\u3089\u304b\u306e\u5bfe\u7b56\u304c\u5fc5\u8981\u3067\u3059\u3002\n\n4. \u5f8c\u7247\u4ed8\u3051\n\n4.1. \u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u524a\u9664\n\n\u30b3\u30de\u30f3\u30c9\naws ec2 terminate-instances --instance-ids ${EC2_INSTANCE_ID}\n\n\n\n\u7d50\u679c(\u4f8b)\n{\n    \"TerminatingInstances\": [\n        {\n            \"InstanceId\": \"i-685357ac\",\n            \"CurrentState\": {\n                \"Code\": 48,\n                \"Name\": \"terminated\"\n            },\n            \"PreviousState\": {\n                \"Code\": 80,\n                \"Name\": \"stopped\"\n            }\n        }\n    ]\n}\n\n\n\n4.2. \u30ed\u30fc\u30ab\u30eb\u30d5\u30a1\u30a4\u30eb\u306e\u524a\u9664\n\n\u30b3\u30de\u30f3\u30c9\nrm ssm.sh\n\n\n\n\u7d50\u679c\n\u8fd4\u308a\u5024\u306a\u3057\n\n\n\n4.3. IAM\u306e\u524a\u9664\n\n\u30b3\u30de\u30f3\u30c9\naws iam remove-role-from-instance-profile --instance-profile-name ${INSTANCE_PROFILE_NAME} --role-name ${ROLE_NAME}\naws iam delete-instance-profile --instance-profile-name ${INSTANCE_PROFILE_NAME}\naws iam detach-role-policy --role-name ${ROLE_NAME} --policy-arn ${POLICY_ARN}\naws iam delete-role --role-name ${ROLE_NAME}\n\n\n\n\u7d50\u679c\n\u8fd4\u308a\u5024\u306a\u3057\n\n\n\n5. \u307e\u3068\u3081\n\u3053\u308c\u3092\u3069\u3046\u3084\u3063\u3066\u4f7f\u3046\u306e\u304b\u3044\u307e\u3044\u3061\u308f\u304b\u3089\u306a\u3044\u3067\u3059\u306d\u3002\nEC2 Run Command\u306b\u3088\u308b\u30b3\u30de\u30f3\u30c9\u306froot\u6a29\u9650\u3067\u5b9f\u884c\u3055\u308c\u307e\u3059\u3002\u305d\u3057\u3066\u8ab0\u304c\u3084\u3063\u305f\u306e\u304b\u3068\u3044\u3046\u8a18\u9332\u306f\u6b8b\u308a\u307e\u305b\u3093\u3002\uff08\u672a\u691c\u8a3c\uff09\n\u30a8\u30fc\u30b8\u30a7\u30f3\u30c8\u306e\u30a8\u30f3\u30c9\u30dd\u30a4\u30f3\u30c8\u306f\u30a4\u30f3\u30bf\u30fc\u30cd\u30c3\u30c8\u4e0a\u306a\u306e\u3067VPC\u5185\u3067\u901a\u4fe1\u3092\u5b8c\u7d50\u3055\u305b\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u305b\u3093\u3002\n\u306a\u306e\u3067\uff08\u3046\u3061\u306e\uff09\u696d\u52d9\u3067\u4f7f\u3046\u306e\u306f\u96e3\u3057\u305d\u3046\u3002\n\u4eca\u56de\u3084\u3063\u305fweb\u30b5\u30fc\u30d0\u306e\u505c\u6b62\u30fb\u958b\u59cb\u3084\u3001\u304a\u304b\u3057\u304f\u306a\u3063\u305f\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092halt\u3055\u305b\u30aa\u30fc\u30c8\u30b9\u30b1\u30fc\u30ea\u30f3\u30b0\u306b\u3088\u308a\u65b0\u3057\u3044\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u8d77\u52d5\u3055\u305b\u308b\u3050\u3089\u3044\u3057\u304b\u7528\u9014\u304c\u601d\u3044\u3064\u304d\u307e\u305b\u3093\u3002\n\u3088\u3046\u3059\u308b\u306b\u975e\u5e38\u7528\uff1f\nEC2 Run Command\u3068\u306f\n======\nEC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306bssm-agent\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u3066\u304a\u304f\u3053\u3068\u3067\u3001\u30b5\u30fc\u30d0\u3078\u30ed\u30b0\u30a4\u30f3\u3059\u308b\u3053\u3068\u306a\u304f\u5916\u90e8\u304b\u3089\u4efb\u610f\u306e\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u51fa\u6765\u307e\u3059\u3002\n\u4ee5\u524d\u306fMS Windows\u306e\u307f\u306e\u5bfe\u5fdc\u3067\u3057\u305f\u304c\u3001Linux\u306b\u3082\u5bfe\u5fdc\u3002\u307f\u3093\u306a\u3053\u308c\u3092\u5f85\u3063\u3066\u3044\u305f\uff01\uff08\u306f\u305a\uff09\n\u5916\u90e8\u304b\u3089\u5185\u90e8\u3078\u306e\u901a\u4fe1\u306f\u7121\u304f\u30a8\u30fc\u30b8\u30a7\u30f3\u30c8\u5074\u304b\u3089AWS\u306e\u7ba1\u7406\u30b5\u30fc\u30d0\u3078\u901a\u4fe1\u3092\u884c\u3046\u306e\u3067\u5185\u90e8\u304b\u3089\u5916\u90e8\u306e\u901a\u4fe1\u3057\u304b\u767a\u751f\u3057\u307e\u305b\u3093\u304b\u3089\u3001\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u304c\u5916\u90e8\u3068\u901a\u4fe1\u53ef\u80fd\u306a\u74b0\u5883\u3067\u3042\u308c\u3070\u52d5\u4f5c\u3057\u307e\u3059\u3002\n\u4eca\u56de\u306f\u30b5\u30f3\u30d7\u30eb\u3068\u3057\u3066\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u305fnginx Web\u30b5\u30fc\u30d0\u3092\u5916\u90e8\u304b\u3089\u505c\u6b62\u3055\u305b\u3001\u30ed\u30b0\u30a4\u30f3\u305b\u305a\u3068\u3082\u30b5\u30fc\u30d0\u4e0a\u3067\u4efb\u610f\u306e\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3067\u304d\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n\n\u524d\u63d0\u6761\u4ef6\n========\n\n\u30c7\u30d5\u30a9\u30eb\u30c8VPC\u306e\u5b58\u5728\n--------------\n\n\u30c7\u30d5\u30a9\u30eb\u30c8VPC\u304c\u5b58\u5728\u3059\u308b\u3053\u3068\u3002\n\u5b58\u5728\u3057\u306a\u304f\u3066\u3082\u52d5\u4f5c\u3057\u307e\u3059\u304c\u3001\u5404\u7a2e\u30b3\u30de\u30f3\u30c9\u5b9f\u884c\u6642\u306e\u30aa\u30d7\u30b7\u30e7\u30f3\u6307\u5b9a\u306f\u9069\u5b9c\u884c\u3063\u3066\u304f\u3060\u3055\u3044\u3002\n\n\n\u5b9f\u884c\u6a29\u9650\n--------------\n\nEC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u8d77\u52d5\u3059\u308b\u6a29\u9650\u304c\u3042\u308b\u3053\u3068\u3002\nIAM\u3092\u4f5c\u6210\u3059\u308b\u6a29\u9650\u304c\u3042\u308b\u3053\u3068\u3002\n\u3053\u308c\u3089\u3092\u6e80\u305f\u3059\u30a2\u30ab\u30a6\u30f3\u30c8\u60c5\u5831\u3092 aws configure \u3067\u767b\u9332\u3057\u3066\u304a\u3044\u3066\u304f\u3060\u3055\u3044\u3002\n\n\nAWS CLI\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\n-------------------\n\n\u4ee5\u4e0b\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u3067\u52d5\u4f5c\u78ba\u8a8d\u6e08\n\n* AWS CLI 1.9.14\n\n```bash:\u30b3\u30de\u30f3\u30c9:\naws --version\n```\n```text:\u7d50\u679c(\u4f8b):\n      aws-cli/1.9.14 Python/2.6.6 Linux/2.6.32 botocore/1.3.14\n```\n\n\n0. \u4e8b\u524d\u4f5c\u696d\n===========\n\n\n0.1. \u30ea\u30fc\u30b8\u30e7\u30f3\u306e\u6c7a\u5b9a\n---------------------\n\n\u73fe\u5728\u4e00\u90e8\u306e\u30ea\u30fc\u30b8\u30e7\u30f3\u306e\u307f\u5bfe\u5fdc\u3057\u3066\u3044\u3066\u6771\u4eac\u306f\u307e\u3060\u3067\u3059\u3002\n\u4eca\u56de\u306f us-west-2 (\u30aa\u30ec\u30b4\u30f3)\u3067\u5b9f\u884c\u3057\u307e\u3059\u3002\n(\u30ab\u30ec\u30f3\u30c8\u30e6\u30fc\u30b6\u304c\u5229\u7528\u3059\u308b\u30ab\u30ec\u30f3\u30c8\u30ea\u30fc\u30b8\u30e7\u30f3\u3082\u5207\u308a\u5909\u308f\u308a\u307e\u3059\u3002)\n\n```bash:\u5909\u6570\u306e\u8a2d\u5b9a:\nexport AWS_DEFAULT_REGION='us-west-2'\n```\n\n0.2. \u5909\u6570\u306e\u78ba\u8a8d\n---------------\n\n\u30d7\u30ed\u30d5\u30a1\u30a4\u30eb\u3068\u30ea\u30fc\u30b8\u30e7\u30f3\u304c\u60f3\u5b9a\u306e\u3082\u306e\u306b\u306a\u3063\u3066\u3044\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3057\u307e\u3059\u3002\n\n```bash:\u30b3\u30de\u30f3\u30c9\naws configure list\n```\n```text:\u7d50\u679c(\u4f8b):\n            Name                    Value             Type    Location\n            ----                    -----             ----    --------\n         profile                <not set>             None    None\n      access_key     ****************M73Q shared-credentials-file\n      secret_key     ****************YWg/ shared-credentials-file\n          region                us-west-2              env    AWS_DEFAULT_REGION\n```\n\n\n1. IAM\u306e\u6e96\u5099\n===========\n\n1.1. IAM\u30ed\u30fc\u30eb\u306e\u4f5c\u6210\n-----------------\n\n```bash:\u30b3\u30de\u30f3\u30c9:\nROLE_NAME=\"ec2-handson-role\"\naws iam create-role --role-name ${ROLE_NAME} --assume-role-policy-document '{ \"Version\": \"2012-10-17\", \"Statement\": [ { \"Effect\": \"Allow\", \"Principal\": { \"Service\": \"ec2.amazonaws.com\"}, \"Action\": \"sts:AssumeRole\" } ] }'\n```\n```text:\u7d50\u679c(\u4f8b):\n{\n    \"Role\": {\n        \"AssumeRolePolicyDocument\": {\n            \"Version\": \"2012-10-17\",\n            \"Statement\": [\n                {\n                    \"Action\": \"sts:AssumeRole\",\n                    \"Effect\": \"Allow\",\n                    \"Principal\": {\n                        \"Service\": \"ec2.amazonaws.com\"\n                    }\n                }\n            ]\n        },\n        \"RoleId\": \"AROAIXFYSOEMNKZQ6532G\",\n        \"CreateDate\": \"2015-12-21T06:00:03.792Z\",\n        \"RoleName\": \"ec2-handson-role\",\n        \"Path\": \"/\",\n        \"Arn\": \"arn:aws:iam::454200CLI555:role/ec2-handson-role\"\n    }\n}\n```\n\n1.2. IAM\u30ed\u30fc\u30eb\u3078Policy\u3092\u8ffd\u52a0\n-----------------\n\nEC2 Run Command\u306b\u5fc5\u8981\u306a\u30dd\u30ea\u30b7\u30fc\u3067\u3042\u308b AmazonEC2RoleforSSM \u3092IAM\u30ed\u30fc\u30eb\u3078\u4ed8\u4e0e\u3057\u307e\u3059\u3002\n\nPolicy AmazonEC2RoleforSSM\u306eARN\u3092\u53d6\u5f97\u3002\n\n```bash:\u30b3\u30de\u30f3\u30c9:\naws iam list-policies | grep AmazonEC2RoleforSSM\n```\n```text:\u7d50\u679c:\n            \"PolicyName\": \"AmazonEC2RoleforSSM\",\n            \"Arn\": \"arn:aws:iam::aws:policy/service-role/AmazonEC2RoleforSSM\",\n```\n\n\"Arn\"\u6b04\u306e arn: \u3067\u59cb\u307e\u308b\u6587\u5b57\u5217\u3092\u30b3\u30d4\u30fc\u3057\u3066\u3001\u6b21\u306e\u30b3\u30de\u30f3\u30c9\uff11\u884c\u76ee POLICY_ARN \u306b\u5165\u308c\u307e\u3059\u3002\uff08\u305f\u3076\u3093jq\u3092\u4f7f\u3046\u3068\u81ea\u52d5\u3067\u5165\u308b\u6c17\u304c\u3059\u308b\u3051\u3069jq\u306f\u308f\u304b\u3089\u306a\u3044\uff09\n\n```bash:\u30b3\u30de\u30f3\u30c9:\nPOLICY_ARN=\"arn:aws:iam::aws:policy/service-role/AmazonEC2RoleforSSM\"\naws iam attach-role-policy --role-name ${ROLE_NAME} --policy-arn ${POLICY_ARN}\n```\n```text:\u7d50\u679c:\n\u8fd4\u308a\u5024\u306a\u3057\n```\n\n1.3. \u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u30d7\u30ed\u30d5\u30a1\u30a4\u30eb\u306e\u4f5c\u6210\n-----------------\n\n```bash:\u30b3\u30de\u30f3\u30c9:\nINSTANCE_PROFILE_NAME=\"ec2-handson-profile\"\naws iam create-instance-profile --instance-profile-name ${INSTANCE_PROFILE_NAME}\n```\n```text:\u7d50\u679c(\u4f8b):\n{\n    \"InstanceProfile\": {\n        \"InstanceProfileId\": \"AIPAIWWQNUCXKCYHEZ46O\",\n        \"Roles\": [],\n        \"CreateDate\": \"2015-12-21T05:54:47.445Z\",\n        \"InstanceProfileName\": \"ec2-handson-profile\",\n        \"Path\": \"/\",\n        \"Arn\": \"arn:aws:iam::454200CLI555:instance-profile/ec2-handson-profile\"\n    }\n}\n```\n\n1.4. \u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u30d7\u30ed\u30d5\u30a1\u30a4\u30eb\u3078IAM\u30ed\u30fc\u30eb\u3092\u8ffd\u52a0\n-----------------\n\n```bash:\u30b3\u30de\u30f3\u30c9:\naws iam add-role-to-instance-profile --instance-profile-name ${INSTANCE_PROFILE_NAME} --role-name ${ROLE_NAME}\n```\n```text:\u7d50\u679c:\n\u8fd4\u308a\u5024\u306a\u3057\n```\n\n\n\n2. EC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u6e96\u5099\n===========\n\n2.1. \u9375\u30da\u30a2\u306e\u4f5c\u6210\uff08\u4efb\u610f\uff09\n---------------\n\n\u9375\u30da\u30a2\u3092\u65e2\u306b\u4f5c\u6210\u6e08\u307f\u306e\u5834\u5408\u3001\u3053\u306e\u4f5c\u696d\u306f\u4e0d\u8981\u3067\u3059\u3002\n\u9375\u30da\u30a2 oregon \u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\u79d8\u5bc6\u9375\u30d5\u30a1\u30a4\u30eb\u306f ~/.ssh/oregon.pem \u306b\u4fdd\u5b58\u3055\u308c\u307e\u3059\u3002\n\n```bash:\u30b3\u30de\u30f3\u30c9\nEC2_KEY_NAME=\"oregon\"\nFILE_SSH_KEY=\"${HOME}/.ssh/${EC2_KEY_NAME}.pem\"\naws ec2 create-key-pair --key-name ${EC2_KEY_NAME} --query 'KeyMaterial' --output text > ${FILE_SSH_KEY} && cat ${FILE_SSH_KEY} && chmod 600 ${FILE_SSH_KEY}\n```\n```text:\u7d50\u679c(\u4f8b):\n-----BEGIN RSA PRIVATE KEY-----\nMIIEowIBAAKCAQEAg4AFnT934UdMmuSADElYSWzOQ/XpXUc0570zKwtDB3RXS9Fi8YP8J5jv6QRl\n\uff08\u672c\u5f53\u306f\u3082\u3063\u3068\u9577\u3044\uff09\nMfRletfQDp2Hbth3SnNu2MaFQs8C+ODyx7XTx/13LW247AGVsSfq63jovntOL7PRuFA=\n-----END RSA PRIVATE KEY-----\n```\n\n\n2.2. \u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u30b0\u30eb\u30fc\u30d7\u306e\u4f5c\u6210\uff08\u4efb\u610f\uff09\n-----------------------\n\n\u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u30b0\u30eb\u30fc\u30d7\u3092\u65e2\u306b\u4f5c\u6210\u6e08\u307f\u306e\u5834\u5408\u3001\u3053\u306e\u4f5c\u696d\u306f\u4e0d\u8981\u3067\u3059\u3002\n\u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u30b0\u30eb\u30fc\u30d7 ec2-handson-sg \u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\n\n```bash:\u30b3\u30de\u30f3\u30c9:\nSG_NAME=\"ec2-handson-sg\"\naws ec2 create-security-group --group-name ${SG_NAME} --description ${SG_NAME}\nSG_ID=`aws ec2 describe-security-groups --filter Name=group-name,Values=${SG_NAME} --query 'SecurityGroups[].GroupId' --output text` && echo ${SG_ID}\n```\n```text:\u7d50\u679c(\u4f8b):\n      {\n          \"GroupId\": \"sg-59c3e63d\"\n      }\n\n      sg-59c3e63d\n```\n\n\u5916\u90e8\u304b\u3089\u306eHTTP\u63a5\u7d9a\u3092\u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u30b0\u30eb\u30fc\u30d7\u306b\u8ffd\u52a0\u3002\n\u3042\u3048\u3066SSH\u306f\u8ffd\u52a0\u305b\u305a\u30ed\u30b0\u30a4\u30f3\u4e0d\u80fd\u306a\u72b6\u614b\u306b\u3057\u3066\u304a\u304d\u307e\u3059\u3002\n\n```bash:\u30b3\u30de\u30f3\u30c9:\naws ec2 authorize-security-group-ingress --group-id ${SG_ID} --protocol 'tcp' --port 80 --cidr 0.0.0.0/0\n```\n```text:\u7d50\u679c:\n      (\u623b\u308a\u5024\u306a\u3057)\n```\n\n\n2.3. Userdata\u30d5\u30a1\u30a4\u30eb\u306e\u4f5c\u6210\n-----------------\n\nUserdata\u306fEC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u4f5c\u6210\u6642\u306b\u5b9f\u884c\u3055\u308c\u308bShellScript\u3067\u3059\u3002\nyum update\u3092\u884c\u3044\u3001nginx\u3068amazon-ssm-agent\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u307e\u3059\u3002\n\n```bash:\u30b3\u30de\u30f3\u30c9:\ncat << EOF > ssm.sh\n#!/bin/bash\nyum -y update\ncurl https://amazon-ssm-us-west-2.s3.amazonaws.com/latest/linux_amd64/amazon-ssm-agent.rpm -o amazon-ssm-agent.rpm\nyum install -y amazon-ssm-agent.rpm nginx\nchkconfig nginx on\nservice nginx start\nEOF\nchmod 755 ssm.sh\n```\n```text:\u7d50\u679c:\n\u8fd4\u308a\u5024\u306a\u3057\n```\n\nUserdata\u306f\u4f5c\u6210\u3057\u305f\u30ed\u30fc\u30ab\u30eb\u30d5\u30a1\u30a4\u30eb\u304c\u8ee2\u9001\u3055\u308c\u3001\u6a29\u9650\u304c\u5f15\u304d\u7d99\u304c\u308c\u307e\u3059\u3002\n\u30d5\u30a1\u30a4\u30eb\u306b\u5b9f\u884c\u6a29\u9650\u304c\u7121\u3044\u3068\u66f8\u3044\u3066\u3082EC2\u4e0a\u3067\u5b9f\u884c\u3055\u308c\u306a\u3044\u306e\u3067\u6ce8\u610f\u304c\u5fc5\u8981\u3067\u3059\u3002\n\u3053\u306e\u305f\u3081\u30d5\u30a1\u30a4\u30eb\u4f5c\u6210\u5f8c chmod \u306b\u3066\u6a29\u9650\u3092\u8a2d\u5b9a\u3057\u3066\u3044\u307e\u3059\u3002\n\n\n2.4. \u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u8d77\u52d5\n-----------------\nAmazon Linux(2015-09)\u3092\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u30bf\u30a4\u30d7t2.micro\u3067\u8d77\u52d5\u3057\u307e\u3059\u3002\n\nAMI ID\u306e\u53d6\u5f97:\n\n```bash:\u30b3\u30de\u30f3\u30c9:\nAMI_NAME='amzn-ami-hvm-2015.09.0.x86_64-gp2'\nAMI_ID=`aws ec2 describe-images --filters Name=name,Values=${AMI_NAME} --query 'Images[].ImageId' --output text` && echo ${AMI_ID}\n```\n```text:\u7d50\u679c:\n      ami-9ff7e8af\n```\n\n\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u8d77\u52d5\n\n```bash:\u30b3\u30de\u30f3\u30c9:\naws ec2 run-instances --image-id ${AMI_ID} --associate-public-ip-address --instance-type t2.micro --key-name ${EC2_KEY_NAME} --region ${AWS_DEFAULT_REGION} --security-group-ids ${SG_ID} --user-data file://ssm.sh --iam-instance-profile Name=${INSTANCE_PROFILE_NAME}\n```\n```text:\u7d50\u679c(\u4f8b):\n{\n    \"OwnerId\": \"454200CLI555\",\n    \"ReservationId\": \"r-c38b2806\",\n    \"Groups\": [],\n    \"Instances\": [\n        {\n            \"Monitoring\": {\n                \"State\": \"disabled\"\n            },\n            \"PublicDnsName\": \"\",\n            \"RootDeviceType\": \"ebs\",\n            \"State\": {\n                \"Code\": 0,\n                \"Name\": \"pending\"\n            },\n            \"EbsOptimized\": false,\n            \"LaunchTime\": \"2015-12-21T06:13:03.000Z\",\n            \"PrivateIpAddress\": \"172.31.20.212\",\n            \"ProductCodes\": [],\n            \"VpcId\": \"vpc-77777777\",\n            \"StateTransitionReason\": \"\",\n            \"InstanceId\": \"i-685357ac\",\n            \"ImageId\": \"ami-f0091d91\",\n            \"PrivateDnsName\": \"ip-172-31-20-212.us-west-2.compute.internal\",\n            \"KeyName\": \"oregon\",\n            \"SecurityGroups\": [\n                {\n                    \"GroupName\": \"handson\",\n                    \"GroupId\": \"sg-77777777\"\n                }\n            ],\n            \"ClientToken\": \"\",\n            \"SubnetId\": \"subnet-77777777\",\n            \"InstanceType\": \"t2.micro\",\n            \"NetworkInterfaces\": [\n                {\n                    \"Status\": \"in-use\",\n                    \"MacAddress\": \"02:37:b4:3f:70:a7\",\n                    \"SourceDestCheck\": true,\n                    \"VpcId\": \"vpc-77777777\",\n                    \"Description\": \"\",\n                    \"NetworkInterfaceId\": \"eni-87217bfe\",\n                    \"PrivateIpAddresses\": [\n                        {\n                            \"PrivateDnsName\": \"ip-172-31-20-212.us-west-2.compute.internal\",\n                            \"Primary\": true,\n                            \"PrivateIpAddress\": \"172.31.20.212\"\n                        }\n                    ],\n                    \"PrivateDnsName\": \"ip-172-31-20-212.us-west-2.compute.internal\",\n                    \"Attachment\": {\n                        \"Status\": \"attaching\",\n                        \"DeviceIndex\": 0,\n                        \"DeleteOnTermination\": true,\n                        \"AttachmentId\": \"eni-attach-58f92752\",\n                        \"AttachTime\": \"2015-12-21T06:13:03.000Z\"\n                    },\n                    \"Groups\": [\n                        {\n                            \"GroupName\": \"handson\",\n                            \"GroupId\": \"sg-77777777\"\n                        }\n                    ],\n                    \"SubnetId\": \"subnet-77777777\",\n                    \"OwnerId\": \"454200CLI555\",\n                    \"PrivateIpAddress\": \"172.31.20.212\"\n                }\n            ],\n            \"SourceDestCheck\": true,\n            \"Placement\": {\n                \"Tenancy\": \"default\",\n                \"GroupName\": \"\",\n                \"AvailabilityZone\": \"us-west-2b\"\n            },\n            \"Hypervisor\": \"xen\",\n            \"BlockDeviceMappings\": [],\n            \"Architecture\": \"x86_64\",\n            \"StateReason\": {\n                \"Message\": \"pending\",\n                \"Code\": \"pending\"\n            },\n            \"IamInstanceProfile\": {\n                \"Id\": \"AIPAIVIS7IIM3UPFCZLYM\",\n                \"Arn\": \"arn:aws:iam::454200CLI555:instance-profile/ec2-handson-profile\"\n            },\n            \"RootDeviceName\": \"/dev/xvda\",\n            \"VirtualizationType\": \"hvm\",\n            \"AmiLaunchIndex\": 0\n        }\n    ]\n}\n```\n\n\n2.5. \u30a4\u30f3\u30b9\u30bf\u30f3\u30b9ID\u306e\u53d6\u5f97\n-----------------\n\n```bash:\u30b3\u30de\u30f3\u30c9:\nEC2_INSTANCE_ID=`aws ec2 describe-instances --query 'Reservations[].Instances[].InstanceId' --output text` && echo ${EC2_INSTANCE_ID}\n```\n```text:\u7d50\u679c(\u4f8b):\ni-6be2e6af\n```\n\n\u4f5c\u696d\u4e2d\u306e\u30ea\u30fc\u30b8\u30e7\u30f3\u306b\u4ed6\u306eEC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u304c\u5b58\u5728\u3059\u308b\u5834\u5408\u3001\u8907\u6570\u8868\u793a\u3055\u308c\u3046\u307e\u304f\u3044\u304d\u307e\u305b\u3093\u3002\n\u3053\u306e\u5834\u5408\u306f 2.4. \u3067\u306e\u51fa\u529b\u7d50\u679c22\u884c\u76ee\u3042\u305f\u308a\u306b\n```\"InstanceId\": \"i-6be2e6af\",```\n\u3068\u3044\u3063\u305f\u9805\u76ee\u304c\u3042\u308b\u306e\u3067\u3001\u3053\u306e\u5024\u3092\u624b\u52d5\u3067\n```EC2_INSTANCE_ID=\"i-6be2e6af\"```\n\u306e\u3088\u3046\u306b\u30b3\u30de\u30f3\u30c9\u3092\u6253\u3061\u74b0\u5883\u5909\u6570\u3078\u683c\u7d0d\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\n\n2.6. \u30d1\u30d6\u30ea\u30c3\u30afIP\u30a2\u30c9\u30ec\u30b9\u306e\u53d6\u5f97\n----------------------\n\n```bash:\u30b3\u30de\u30f3\u30c9:\nEC2_PUBLIC_IP=`aws ec2 describe-instances --instance-id ${EC2_INSTANCE_ID} --query \"Reservations[].Instances[].PublicIpAddress\" --output text` && echo ${EC2_PUBLIC_IP}\n```\n```text:\u7d50\u679c(\u4f8b):\n      54.77.77.777\n```\n\n\n2.7. \u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u304c\u52d5\u4f5c\u3059\u308b\u307e\u3067\u6570\u5206\u5f85\u3061\u307e\u3059\n-----------------\n\n\u901a\u5e38\u3001\u6570\u5206\u3067\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u304c\u8d77\u52d5\u5b8c\u4e86\u3057\u307e\u3059\u304c\u3001userdata\u3067\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u51e6\u7406\u3092\u3057\u3066\u3044\u308b\u306e\u3067\u901a\u5e38\u3088\u308a\u6642\u9593\u304c\u304b\u304b\u308a\u307e\u3059\u3002\nWeb\u30d6\u30e9\u30a6\u30b6\u3067 2.6. \u3067\u8868\u793a\u3055\u308c\u305fIP\u30a2\u30c9\u30ec\u30b9\u3078\u30a2\u30af\u30bb\u30b9\u3057\u3066nginx\u306e\u753b\u9762\u304c\u8868\u793a\u3055\u308c\u305f\u3089\u5b8c\u4e86\u3067\u3059\u3002\n```http://54.77.77.777/\n```\n\n\n3. EC2 Run Command\u306e\u5b9f\u884c\n===========\n\n3.1. EC2 Run Command\u5b9f\u884c\u306e\u8aac\u660e\n-----------------\n\n```bash:\u30b3\u30de\u30f3\u30c9:\naws ssm send-command \u306b\u3088\u308a\u5b9f\u884c\u3057\u307e\u3059\u3002\n```\n```\u30aa\u30d7\u30b7\u30e7\u30f3:\n\u5fc5\u9808\u30aa\u30d7\u30b7\u30e7\u30f3\n--document-name \u5b9f\u884c\u3059\u308b\u30b3\u30de\u30f3\u30c9\u306e\u7a2e\u985e\u3092\u6307\u5b9a\u3057\u307e\u3059\u3002shell\u5b9f\u884c\u306e\u5834\u5408 \"AWS-RunShellScript\"\u3002\u73fe\u72b6Linux\u3067\u306f\u4ed6\u306b \"AWS-UpdateSSMAgent\"\u306e\u307f\u30b5\u30dd\u30fc\u30c8\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n--instance-ids \u30a4\u30f3\u30b9\u30bf\u30f3\u30b9ID\u3092\u6307\u5b9a\u3057\u307e\u3059\u3002\n\n\u4efb\u610f\u30aa\u30d7\u30b7\u30e7\u30f3\n--parameters\u3000\u5f15\u304d\u6e21\u3059\u30d1\u30e9\u30e1\u30fc\u30bf\u3002ShellScript\u306e\u5834\u5408\u306f\u3053\u308c\u3082\u5fc5\u9808\u3067\u3001\u5b9f\u884c\u3059\u308b\u30b3\u30de\u30f3\u30c9\u305d\u306e\u3082\u306e\u3067\u3059\u3002\n--output-s3-bucket-name\u3000\u5b9f\u884c\u7d50\u679c\u3092\u51fa\u529b\u3059\u308bS3\u30d0\u30b1\u30c3\u30c8\u540d\n--output-s3-key-prefix \u51fa\u529b\u3059\u308b\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u540d(\u6307\u5b9a\u3057\u306a\u3044\u3068\u30d0\u30b1\u30c3\u30c8\u76f4\u4e0b\u306b\u51fa\u529b\u3055\u308c\u307e\u3059)\n--cli-input-json JSON\u3088\u304f\u308f\u304b\u308a\u307e\u305b\u3093\n```\n\n\n3.2. \u7d50\u679c\u51fa\u529b\u7528S3\u30d0\u30b1\u30c3\u30c8\u306e\u4f5c\u6210\uff08\u4efb\u610f\uff09\n-----------------\nAWSCLI\u3067\u3082\u30de\u30cd\u30b8\u30e1\u30f3\u30c8\u30b3\u30f3\u30bd\u30fc\u30eb\u3067\u3082\u51fa\u529b\u7d50\u679c\u3092\u78ba\u8a8d\u3067\u304d\u308b\u306e\u3067\u4efb\u610f\u3067\u3059\u304c\u3001\nS3\u30d0\u30b1\u30c3\u30c8\u3092\u6307\u5b9a\u3059\u308b\u3068\u30b3\u30de\u30f3\u30c9\u306e\u5b9f\u884c\u7d50\u679c(\u6a19\u6e96\u51fa\u529b)\u3092\u4fdd\u5b58\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\n\u3053\u3053\u3067\u306fS3\u30d0\u30b1\u30c3\u30c8\u540d\u3092 ec2-handson \u3068\u3057\u3066\u3044\u307e\u3059\u304c\u3001\u81ea\u5206\u3067\u540d\u524d\u3092\u8003\u3048\u3066\u304f\u3060\u3055\u3044\u3002\n\u3053\u308c\u306f\u5168\u4e16\u754c\u3067\u4e00\u610f\u3067\u3042\u308b\u5fc5\u8981\u304c\u3042\u308a\u540c\u3058\u30d0\u30b1\u30c3\u30c8\u540d\u304c\u4f7f\u3048\u306a\u3044\u304b\u3089\u3067\u3059\u3002\n\n```bash:\u30b3\u30de\u30f3\u30c9:\nBUCKET_NAME=\"s3://ec2-handson/\"\naws s3 mb ${BUCKET_NAME}\n```\n```text:\u7d50\u679c(\u4f8b):\nmake_bucket: s3://ec2-handson/\n```\n\n\n3.2. \u30b3\u30de\u30f3\u30c9\u306e\u5b9f\u884c\n-----------------\n\u4eca\u56de\u306fnginx\u30b5\u30fc\u30d0\u3092\u505c\u6b62\u3055\u305b\u308b\u3079\u304f service nginx stop \u30b3\u30de\u30f3\u30c9\u3067\u3082\u5b9f\u884c\u3057\u3066\u307f\u307e\u3057\u3087\u3046\u3002\n\u306a\u304a\u3001\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u8907\u6570\u6307\u5b9a\u3057\u3066\u540c\u6642\u5b9f\u884c\u3059\u308b\u3053\u3068\u3082\u3067\u304d\u307e\u3059\u3002\n\n```bash:\u30b3\u30de\u30f3\u30c9:\naws ssm send-command --document-name \"AWS-RunShellScript\" --instance-ids ${EC2_INSTANCE_ID} --parameters '{\"commands\":[\"service nginx stop\"],\"executionTimeout\":[\"300\"]}' --output-s3-bucket-name ${BUCKET_NAME}\n```\n```text:\u7d50\u679c(\u4f8b):\n    \"Command\": {\n        \"Status\": \"Pending\",\n        \"ExpiresAfter\": 1450856459.898,\n        \"Parameters\": {\n            \"commands\": [\n                \"service nginx stop\"\n            ],\n            \"executionTimeout\": [\n                \"300\"\n            ]\n        },\n        \"DocumentName\": \"AWS-RunShellScript\",\n        \"OutputS3BucketName\": \"ec2-handson\",\n        \"OutputS3KeyPrefix\": \"hoge\",\n        \"InstanceIds\": [\n            \"i-2b191aef\"\n        ],\n        \"CommandId\": \"d6b7ae11-ff52-41e8-9578-e8ada35680b8\",\n        \"RequestedDateTime\": 1450855859.898\n    }\n}\n```\n\n\n3.3. \u30b3\u30de\u30f3\u30c9\u304c\u5b9f\u884c\u3055\u308c\u305f\u304b\u78ba\u8a8d\n-----------------\nWeb\u30d6\u30e9\u30a6\u30b6\u3092\u30ea\u30ed\u30fc\u30c9\u3057\u3066\u307f\u307e\u3059\u3002\n```http://54.77.77.777/\n```\n\u30b5\u30fc\u30d0\u3078\u63a5\u7d9a\u3067\u304d\u306a\u304f\u306a\u3063\u3066\u3044\u308c\u3070\u6210\u529f\u3067\u3059\u3002\n\n\n3.4. \u30b3\u30de\u30f3\u30c9\u304c\u5b9f\u884c\u7d50\u679c\u306e\u8868\u793a\n-----------------\n\n```bash:\u30b3\u30de\u30f3\u30c9:\naws ssm list-command-invocations --detail\n```\n```text:\u7d50\u679c(\u4f8b):\n{\n    \"CommandInvocations\": [\n        {\n            \"Status\": \"Success\",\n            \"CommandPlugins\": [\n                {\n                    \"Status\": \"Success\",\n                    \"Name\": \"aws:runShellScript\",\n                    \"OutputS3BucketName\": \"ec2-handson\",\n                    \"OutputS3KeyPrefix\": \"d6b7ae11-ff52-41e8-9578-e8ada35680b8/i-2b191aef/awsrunShellScript\",\n                    \"ResponseCode\": 0,\n                    \"Output\": \"Stopping nginx: [  OK  ]\\r\\n\",\n                    \"ResponseFinishDateTime\": 1450855860.194,\n                    \"ResponseStartDateTime\": 1450855860.0880001\n                }\n            ],\n            \"InstanceId\": \"i-2b191aef\",\n            \"DocumentName\": \"AWS-RunShellScript\",\n            \"CommandId\": \"d6b7ae11-ff52-41e8-9578-e8ada35680b8\",\n            \"RequestedDateTime\": 1450855859.898\n        }\n    ]\n}\n```\n\nStatus: Success \u3068\u306a\u3063\u3066\u3044\u308c\u3070\u5b9f\u884c\u6210\u529f\u3067\u3059\u3002\nOutput: \u306b\u306f\u6a19\u6e96\u51fa\u529b\u306e\u5185\u5bb9\u304c\u8868\u793a\u3055\u308c\u3066\u3044\u307e\u3059\u3002 \"Stopping nginx: [  OK  ]\\r\\n\" \u3068\u6210\u529f\u3057\u3066\u3044\u307e\u3059\u306d\u3002\n\nS3\u30d0\u30b1\u30c3\u30c8\u3092\u6307\u5b9a\u3057\u305f\u5834\u5408\ns3://\u30d0\u30b1\u30c3\u30c8\u540d/\u30c7\u30a3\u30ec\u30af\u30c8\u30ea/\u30b3\u30de\u30f3\u30c9ID/\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9ID/\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u540d/x.\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u540d/stdout\n\u30d5\u30a1\u30a4\u30eb\u306b\u6a19\u6e96\u51fa\u529b\u306e\u5185\u5bb9\u304c\u8a18\u9332\u3055\u308c\u3066\u3044\u307e\u3059\u3002\n\n\n3.5. \u30cf\u30de\u308b\u30b3\u30de\u30f3\u30c9\n-----------------\n\nreboot \u3092\u5b9f\u884c\u3059\u308b\u3053\u3068\u3082\u3067\u304d\u307e\u3059\u304c\u3001\u5ef6\u3005\u3068\u518d\u8d77\u52d5\u3092\u7e70\u308a\u8fd4\u3057\u3066\u3057\u307e\u3044\u307e\u3059\u3002\n\u3053\u308c\u306fssm-agent\u304c\u30b3\u30de\u30f3\u30c9\u5b9f\u884c\u5b8c\u4e86\u306e\u30b9\u30c6\u30fc\u30bf\u30b9\u3092AWS\u306e\u30b5\u30fc\u30d0\u3078\u9001\u308b\u307e\u3067\u306fPending\u72b6\u614b\u306b\u306a\u3063\u3066\u304a\u308a\u3001\nreboot\u3092\u5b9f\u884c\u3057\u305f\u77ac\u9593\u306b\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306f\u30b7\u30e3\u30c3\u30c8\u30c0\u30a6\u30f3\u3059\u308b\u305f\u3081\u5168\u30d7\u30ed\u30bb\u30b9\u304ckill\u3057\u307e\u3059\u304b\u3089ssm-agent\u3082\u6d88\u6ec5\u3059\u308b\u306e\u3067\u6c38\u9060\u306bPending\u72b6\u614b\u3002\n\u305d\u3057\u3066\u518d\u8d77\u52d5\u5f8c\u306b\u518d\u3073reboot\u304c\u5b9f\u884c\u3055\u308c\u3001executionTimeout\u3067\u6307\u5b9a\u3057\u305f\u6642\u9593\u307e\u3067\u5ef6\u3005\u3068\u518d\u8d77\u52d5\u304c\u7e70\u308a\u8fd4\u3055\u308c\u307e\u3059\u3002\n\u3069\u3046\u3057\u3066\u3082\u5b9f\u884c\u3057\u305f\u3044\u5834\u5408\u306f\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u6642\u9593\u309230\u79d2\u3050\u3089\u3044\u306b\u3057\u307e\u3059\u3002\u3053\u308c\u3067\u4e00\u5ea6\u3060\u3051\u5b9f\u884c\u3055\u308c\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u7d42\u4e86\u3068\u306a\u308a\u307e\u3059\u3002\n\nhalt \u3084 shutdown \u30b3\u30de\u30f3\u30c9\u3082\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u7d42\u4e86\u3068\u306a\u308a\u307e\u3059\u3002\n\u3053\u308c\u3089\u306f\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u304c\u505c\u6b62\u3059\u308b\u306e\u3067\u4f55\u5ea6\u3082\u7e70\u308a\u8fd4\u3055\u308c\u308b\u3053\u3068\u306f\u3042\u308a\u307e\u305b\u3093\u304c\u3001ssm-agent\u304cAWS\u306e\u30b5\u30fc\u30d0\u3078\u7d50\u679c\u3092\u9001\u51fa\u3067\u304d\u305a Status: TimedOut \u306b\u306a\u308a\u307e\u3059\u3002\n\u3044\u305a\u308c\u3082\u5b9f\u5bb3\u306f\u3042\u308a\u307e\u305b\u3093\u304c\u3001\u30ed\u30b0\u3092\u3068\u3057\u3066\u306f\u30a8\u30e9\u30fc\u306b\u5206\u985e\u3055\u308c\u308b\u306e\u3067\u4f55\u3089\u304b\u306e\u5bfe\u7b56\u304c\u5fc5\u8981\u3067\u3059\u3002\n\n\n\n4. \u5f8c\u7247\u4ed8\u3051\n===========\n\n4.1. \u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u524a\u9664\n-----------------\n\n```bash:\u30b3\u30de\u30f3\u30c9:\naws ec2 terminate-instances --instance-ids ${EC2_INSTANCE_ID}\n```\n```text:\u7d50\u679c(\u4f8b):\n{\n    \"TerminatingInstances\": [\n        {\n            \"InstanceId\": \"i-685357ac\",\n            \"CurrentState\": {\n                \"Code\": 48,\n                \"Name\": \"terminated\"\n            },\n            \"PreviousState\": {\n                \"Code\": 80,\n                \"Name\": \"stopped\"\n            }\n        }\n    ]\n}\n```\n\n\n4.2. \u30ed\u30fc\u30ab\u30eb\u30d5\u30a1\u30a4\u30eb\u306e\u524a\u9664\n-----------------\n\n```bash:\u30b3\u30de\u30f3\u30c9:\nrm ssm.sh\n```\n```text:\u7d50\u679c:\n\u8fd4\u308a\u5024\u306a\u3057\n```\n\n\n4.3. IAM\u306e\u524a\u9664\n-----------------\n\n```bash:\u30b3\u30de\u30f3\u30c9:\naws iam remove-role-from-instance-profile --instance-profile-name ${INSTANCE_PROFILE_NAME} --role-name ${ROLE_NAME}\naws iam delete-instance-profile --instance-profile-name ${INSTANCE_PROFILE_NAME}\naws iam detach-role-policy --role-name ${ROLE_NAME} --policy-arn ${POLICY_ARN}\naws iam delete-role --role-name ${ROLE_NAME}\n```\n```text:\u7d50\u679c:\n\u8fd4\u308a\u5024\u306a\u3057\n```\n\n\n5. \u307e\u3068\u3081\n===========\n\n\u3053\u308c\u3092\u3069\u3046\u3084\u3063\u3066\u4f7f\u3046\u306e\u304b\u3044\u307e\u3044\u3061\u308f\u304b\u3089\u306a\u3044\u3067\u3059\u306d\u3002\nEC2 Run Command\u306b\u3088\u308b\u30b3\u30de\u30f3\u30c9\u306froot\u6a29\u9650\u3067\u5b9f\u884c\u3055\u308c\u307e\u3059\u3002\u305d\u3057\u3066\u8ab0\u304c\u3084\u3063\u305f\u306e\u304b\u3068\u3044\u3046\u8a18\u9332\u306f\u6b8b\u308a\u307e\u305b\u3093\u3002\uff08\u672a\u691c\u8a3c\uff09\n\u30a8\u30fc\u30b8\u30a7\u30f3\u30c8\u306e\u30a8\u30f3\u30c9\u30dd\u30a4\u30f3\u30c8\u306f\u30a4\u30f3\u30bf\u30fc\u30cd\u30c3\u30c8\u4e0a\u306a\u306e\u3067VPC\u5185\u3067\u901a\u4fe1\u3092\u5b8c\u7d50\u3055\u305b\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u305b\u3093\u3002\n\u306a\u306e\u3067\uff08\u3046\u3061\u306e\uff09\u696d\u52d9\u3067\u4f7f\u3046\u306e\u306f\u96e3\u3057\u305d\u3046\u3002\n\n\u4eca\u56de\u3084\u3063\u305fweb\u30b5\u30fc\u30d0\u306e\u505c\u6b62\u30fb\u958b\u59cb\u3084\u3001\u304a\u304b\u3057\u304f\u306a\u3063\u305f\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092halt\u3055\u305b\u30aa\u30fc\u30c8\u30b9\u30b1\u30fc\u30ea\u30f3\u30b0\u306b\u3088\u308a\u65b0\u3057\u3044\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u8d77\u52d5\u3055\u305b\u308b\u3050\u3089\u3044\u3057\u304b\u7528\u9014\u304c\u601d\u3044\u3064\u304d\u307e\u305b\u3093\u3002\n\u3088\u3046\u3059\u308b\u306b\u975e\u5e38\u7528\uff1f\n", "tags": ["AWS", "aws-cli", "awscli", "EC2", "runcommand"]}