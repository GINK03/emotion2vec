{"context": "\n\nWebPay\u304b\u3089PAY.JP\u3078\u306e\u79fb\u884c\uff08\u30d7\u30ed\u30b0\u30e9\u30e0\u6539\u4fee\uff09\n\u203b WebPay\u3092\u3054\u5b58\u77e5\u3067\u3057\u3087\u3046\u304b\uff1f WebPay\u306f\u65e2\u306b\u30b5\u30fc\u30d3\u30b9\u7d42\u4e86\u4e88\u5b9a\u3068\u306a\u3063\u3066\u3044\u308b\u305f\u3081\u3001\u77e5\u3089\u306a\u3044\u3068\u3044\u3046\u65b9\u306f\u3082\u3046\u4f7f\u3046\u3053\u3068\u304c\u7121\u3044\u304b\u3068\u601d\u3044\u307e\u3059\u306e\u3067\u3053\u306e\u8a18\u4e8b\u306f\u305d\u3063\u3068\u9589\u3058\u3066\u5927\u4e08\u592b\u3067\u3059\u3002\nWebPay\u3092\u521d\u3081\u3066\u89e6\u3063\u305f\u3068\u304d\u306f\u7c21\u5358\u306b\u6c7a\u6e08\u30b7\u30b9\u30c6\u30e0\u304c\u4f5c\u308c\u308b\u3068\u3044\u3046\u3068\u3053\u308d\u306b\u611f\u52d5\u3092\u899a\u3048\u305f\u3082\u306e\u3067\u3059\u3002\u305d\u306eWebPay\u3055\u3093\u3067\u3059\u304c\u30012017\u5e744\u6708\u672b\u3067\u30b5\u30fc\u30d3\u30b9\u7d42\u4e86\u3068\u306a\u308a\u3001\u30af\u30ec\u30b8\u30c3\u30c8\u30ab\u30fc\u30c9\u6c7a\u6e08\u4ee3\u884c\u3068\u3044\u3046\u30af\u30ea\u30c6\u30a3\u30ab\u30eb\u306a\u90e8\u5206\u304c\u7121\u304f\u306a\u3063\u3066\u3057\u307e\u3046\u3068\u30c0\u30e1\u30fc\u30b8\u304c\u5927\u304d\u304f\u3001\u305d\u308d\u305d\u308d\u79fb\u884c\u3092\u672c\u683c\u7684\u306b\u8003\u3048\u306a\u3051\u308c\u3070\u306a\u3089\u306a\u3044\u65b9\u3082\u982d\u3092\u62b1\u3048\u3066\u3044\u308b\u304b\u3068\u601d\u3044\u307e\u3059\u3002\n\u65b0\u5e74\u660e\u3051\u3066\u5c11\u3057\u6642\u9593\u304c\u53d6\u308c\u305f\u306e\u3067\u3001\u52d5\u304d\u51fa\u3057\u305f\u90e8\u5206\u304b\u3089\u968f\u6642\u66f4\u65b0\u3067\u8a18\u8f09\u3057\u3066\u3044\u3053\u3046\u3068\u601d\u3044\u307e\u3059\u3002\n\n\u79fb\u884c\u5148\n\u307e\u305a\u3001\u79fb\u884c\u5148\u306b\u3064\u3044\u3066\u306f PAY.JP \u3092\u9078\u629e\u3057\u307e\u3057\u305f\u3002PAY.JP\u3092\u9078\u629e\u3057\u305f\u6c7a\u5b9a\u7684\u306a\u7406\u7531\u306f\u300cJCB\u304c\u4f7f\u3048\u308b\u304b\u3089\u300d\u3067\u3059\u3002\u5f0a\u793e\u30b5\u30fc\u30d3\u30b9\u3067\u306f\u7d99\u7d9a\u8ab2\u91d1\uff08\u6708\u5ea6\u8ab2\u91d1\uff09\u306e\u3046\u3061JCB\u5229\u7528\u7387\u306f30%\u3082\u3042\u308a\u3001\u3053\u308c\u3092\u7121\u8996\u3059\u308b\u3053\u3068\u306f\u51fa\u6765\u307e\u305b\u3093\u3067\u3057\u305f\u3002\n\u30ea\u30b9\u30af\u5206\u6563\u306e\u305f\u3081\u306bStripe\u3068\u3044\u3046\u672c\u5bb6\u672c\u5143\u3082\u4e26\u884c\u3057\u3066\u7533\u8acb\u30fb\u5b9f\u88c5\u306f\u3057\u3066\u3044\u307e\u3059\u304c2017\u5e741\u6708\u6642\u70b9\u3067\u306f\u65e5\u672c\u5186\u3067\u306eJCB\u53d6\u6271\u306f\u672a\u5b9a\u306e\u307e\u307e\u3067\u9078\u629e\u3057\u3065\u3089\u3044\u3067\u3059\u3002\n(StripeSupport: https://support.stripe.com/questions/which-cards-and-payment-types-can-i-accept-with-stripe)\n\n\u30b3\u30fc\u30c9\u5909\u66f4\u70b9\n\u79fb\u884c\u306e\u305f\u3081\u306b\u30d7\u30ed\u30b0\u30e9\u30e0\u4fee\u6b63\u3092\u884c\u3044\u3001\u4e00\u901a\u308a\u5b8c\u6210\u3057\u305f\u306e\u3067diff\u3092\u53d6\u3063\u3066\u6652\u3057\u3066\u307f\u307e\u3059\u3002\u3056\u3063\u3068\u30bf\u30b9\u30af\u91cf\u3092\u898b\u7a4d\u3082\u3063\u305f\u308a\u30c1\u30a7\u30c3\u30af\u30ea\u30b9\u30c8\u7684\u306a\u610f\u5473\u5408\u3044\u3067\u8aad\u3080\u3053\u3068\u3092\u30aa\u30b9\u30b9\u30e1\u3057\u3001\u5b9f\u88c5\u3059\u308b\u969b\u306b\u306f\u6b63\u5f0f\u306a\u30d7\u30ed\u30b0\u30e9\u30e0\u306f\u516c\u5f0f\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u3092\u8aad\u3093\u3067\u4e0b\u3055\u3044\u3002\n\n\u30b3\u30fc\u30c9\u306e\u8aad\u307f\u65b9.\n\u30b3\u30fc\u30c9\u306fPython3\u3067\u3059\u3002\n\u884c\u5148\u982d\u304c < \u3068\u306a\u3063\u3066\u3044\u308b\u306e\u306fWebPay, \u884c\u5148\u982d\u304c > \u3068\u306a\u3063\u3066\u3044\u308b\u306e\u306fPAY.JP\u3068\u306a\u308a\u307e\u3059\n\n\n\nclient\u306e\u547c\u3073\u51fa\u3057\u65b9\n\npython.\n< self.client = webpay.WebPay(settings.WEBPAY_SECRET)\n----\n> payjp.api_key = settings.PAYJP_SECRET\n> self.client = payjp\n\n\n\n\u9867\u5ba2\u4f5c\u6210\n\n\ncustomer -> Customer\n\n\npython.\n<  customer_api_response = self.client.customer.create(\n----\n>  customer_api_response = self.client.Customer.create(\n\n\n\n\n\u623b\u308a\u5024\u306e\u6271\u3044\u3092\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u5909\u66f4\u3059\u308b\n\n\npython.\n<  self.payment_customer.fingerprint = customer_api_response['active_card']['fingerprint']\n<  self.payment_customer.country = customer_api_response['active_card']['country']\n<  self.payment_customer.last4 = customer_api_response['active_card']['last4']\n<  self.payment_customer.type = customer_api_response['active_card'][\u2018type']\n----\n> _default_card_info = None\n> for c in customer_api_response['cards']['data']:\n>   if c['id'] == customer_api_response['default_card']:\n>      _default_card_info = c\n>\n> self.payment_customer.fingerprint = _default_card_info['fingerprint']\n> self.payment_customer.country = _default_card_info['country']\n> self.payment_customer.last4 = _default_card_info['last4']\n> self.payment_customer.type = _default_card_info['brand']\n\n\n\nWebPay\u3067\u3044\u3046active_card\u3068\u3044\u3046\u30e1\u30a4\u30f3\u306e\u30ab\u30fc\u30c9\u3092\u53d6\u5f97\u3059\u308b\u65b9\u6cd5\u304c\u601d\u3044\u3064\u304b\u306a\u304b\u3063\u305f\u30fb\u30fb\u30fb\u3002response\u306b['default_card']\u304c\u3042\u308b\u304b\u3089\u3053\u308c\u3068\u540c\u3058\u30ab\u30fc\u30c9\u3092\u53d6\u5f97\u3059\u308c\u3070\u826f\u3044\u306e\u304b\u306a\uff1f\n\u826f\u3044\u65b9\u6cd5\u304c\u3042\u308c\u3070\u6559\u3048\u3066\u304f\u3060\u3055\u3044\uff1e\uff1c\n\n\u90fd\u5ea6\u8ab2\u91d1\u4eee\u58f2\u4e0a\n\n\ncharge -> Charge\n\nexpire_days -> expiry_days\n\n\npython.\n< charge_api_response = self.client.charge.create(\n----\n> charge_api_response = self.client.Charge.create(\n\n\n\npython.\n< expire_days=7 # \u4eee\u58f2\u4e0a\u306f7\u65e5\u9593\u6709\u52b9\n----\n> expiry_days=7 # \u4eee\u58f2\u4e0a\u306f7\u65e5\u9593\u6709\u52b9\n\n\n\n\u90fd\u5ea6\u8ab2\u91d1\u672c\u58f2\u4e0a(\u4eee\u58f2\u4e0a\u3092\u672c\u58f2\u4e0a\u306b\u5909\u66f4)\n\npython.\n<  self.client.charge.capture(id=self.charge_api_response['id\u2019])\n----\n>  target_charge = self.client.Charge.retrieve(id=self.charge_api_response['id'])\n>  target_charge.capture()\n\n\n\n\u7d99\u7d9a\u8ab2\u91d1\n\n\nPAY.JP\u306f\u4e88\u3081\u300cplan\u300d\u3068\u3044\u3046\u3082\u306e\u3092WEB\u753b\u9762\u4e0a\u3067\u8a2d\u5b9a\u3057\u3066\u304a\u304f\u5fc5\u8981\u3042\u308a\n\n\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u611f\u3058\u3067\u30b3\u30fc\u30c9\u3092\u5909\u66f4\u3059\u308b\n\n\npython.\n<  charge_api_response = self.client.recursion.create(\n<    amount=self.item_detail.amount,\n<    currency=\"jpy\",\n<    customer=self.payment_customer.customer_id,\n<    period=\"month\",\n<    description=self.item_detail.item.item_name + \"\u6708\u984d\u8ab2\u91d1\",\n<    first_scheduled=int(time.mktime(self.first_scheduled.timetuple()))\n<  )\n----\n>  charge_api_response = self.client.Subscription.create(\n>    plan='premium',\n>    customer=self.payment_customer.customer_id,\n>  )\n\n\n\n\u7d99\u7d9a\u8ab2\u91d1\u524a\u9664\n\npython.\n< self.client.recursion.delete(id=self.cancel_order.order_number)\n----\n> subscription = self.client.Subscription.retrieve(id=self.cancel_order.order_number)\n> subscription.delete()\n\n\n\n\u30a8\u30e9\u30fc\u30cf\u30f3\u30c9\u30ea\u30f3\u30b0\n\npython.\n< except webpay.error_response.ErrorResponseError as e:\n<    caused_by = e.data.error.caused_by\n<    if caused_by == 'buyer':\n<      # \u30ab\u30fc\u30c9\u30a8\u30e9\u30fc\u306a\u3069\u3001\u8cfc\u5165\u8005\u306b\u539f\u56e0\u304c\u3042\u308b\n<      # \u30a8\u30e9\u30fc\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u305d\u306e\u307e\u307e\u8868\u793a\u3059\u308b\u306e\u304c\u308f\u304b\u308a\u3084\u3059\u3044\n<      message = \"\u30af\u30ec\u30b8\u30c3\u30c8\u30ab\u30fc\u30c9\u306e\u8a8d\u8a3c\u304c\u51fa\u6765\u307e\u305b\u3093\u3067\u3057\u305f\u3002\" \\\n<      \"\u4e0a\u9650\u91d1\u984d\u3092\u8d85\u3048\u3066\u3044\u306a\u3044\u304b\u78ba\u8a8d\u3057\u3066\u3044\u305f\u3060\u304f\u304b\u3001\" \\\n<      \"\u5225\u306e\u30af\u30ec\u30b8\u30c3\u30c8\u30ab\u30fc\u30c9\u756a\u53f7\u3092\u5165\u529b\u3057\u3066\u304f\u3060\u3055\u3044\u3002\" \\\n<      \"\u30af\u30ec\u30b8\u30c3\u30c8\u30ab\u30fc\u30c9\u4f1a\u793e\u304b\u3089\u306e\u30e1\u30c3\u30bb\u30fc\u30b8\uff1a\" + str(e)\n<      raise PaymentLogicException(message)\n<    elif caused_by == 'insufficient':\n<      # \u5b9f\u88c5\u30df\u30b9\u306b\u8d77\u56e0\u3059\u308b\n<      message = \"\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3057\u307e\u3057\u305f\u3002\u904b\u55b6\u306b\u554f\u3044\u5408\u308f\u305b\u3066\u304f\u3060\u3055\u3044\u3002\u30e1\u30c3\u30bb\u30fc\u30b8\uff1a\" + str(e)\n<      raise PaymentLogicException(message)\n<    elif caused_by == 'missing':\n<      # \u30ea\u30af\u30a8\u30b9\u30c8\u5bfe\u8c61\u306e\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u304c\u5b58\u5728\u3057\u306a\u3044\n<      message = \"\u30c8\u30fc\u30af\u30f3\u304c\u7121\u52b9\u3067\u3059\u3002\u518d\u5ea6\u3084\u308a\u76f4\u3057\u3066\u304f\u3060\u3055\u3044\u3002\" + str(e)\n<      raise PaymentLogicException(message)\n<    elif caused_by == 'service':\n<      # WebPay\u306b\u8d77\u56e0\u3059\u308b\u30a8\u30e9\u30fc\n<      message = \"\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3057\u307e\u3057\u305f\u3002\u904b\u55b6\u306b\u554f\u3044\u5408\u308f\u305b\u3066\u304f\u3060\u3055\u3044\u3002\u30e1\u30c3\u30bb\u30fc\u30b8\uff1a\" + str(e)\n<      raise PaymentLogicException(message)\n<    else:\n<      # \u672a\u77e5\u306e\u30a8\u30e9\u30fc\n<      message = \"\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3057\u307e\u3057\u305f\u3002\u904b\u55b6\u306b\u554f\u3044\u5408\u308f\u305b\u3066\u304f\u3060\u3055\u3044\u3002\u30e1\u30c3\u30bb\u30fc\u30b8\uff1a\" + str(e)\n<      raise PaymentLogicException(message)\n< except webpay.ApiError as e:\n<    # API\u304b\u3089\u306e\u30ec\u30b9\u30dd\u30f3\u30b9\u304c\u53d7\u3051\u53d6\u308c\u306a\u3044\u5834\u5408\u3002\u63a5\u7d9a\u30a8\u30e9\u30fc\u306a\u3069\n----\n>  except payjp.error.CardError as e:\n>    # Since it's a decline, payjp.error.CardError will be caught\n>    body = e.json_body\n>    err = body['error']\n>    message = \"\u30af\u30ec\u30b8\u30c3\u30c8\u30ab\u30fc\u30c9\u306e\u8a8d\u8a3c\u304c\u51fa\u6765\u307e\u305b\u3093\u3067\u3057\u305f\u3002\" \\\n>    \"\u4e0a\u9650\u91d1\u984d\u3092\u8d85\u3048\u3066\u3044\u306a\u3044\u304b\u78ba\u8a8d\u3057\u3066\u3044\u305f\u3060\u304f\u304b\u3001\" \\\n>    \"\u5225\u306e\u30af\u30ec\u30b8\u30c3\u30c8\u30ab\u30fc\u30c9\u756a\u53f7\u3092\u5165\u529b\u3057\u3066\u304f\u3060\u3055\u3044\u3002\" \\\n>    \"\u30af\u30ec\u30b8\u30c3\u30c8\u30ab\u30fc\u30c9\u4f1a\u793e\u304b\u3089\u306e\u30e1\u30c3\u30bb\u30fc\u30b8\uff1a\" + str(err['message'])\n>    raise PaymentLogicException(message)\n>  except payjp.error.InvalidRequestError as e:\n>    # Invalid parameters were supplied to Payjp's API\n>    message = \"\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3057\u307e\u3057\u305f\u3002\u904b\u55b6\u306b\u554f\u3044\u5408\u308f\u305b\u3066\u304f\u3060\u3055\u3044\u3002\u30e1\u30c3\u30bb\u30fc\u30b8\uff1a\" + str(e)\n>    raise PaymentLogicException(message)\n>  except payjp.error.AuthenticationError as e:\n>    message = \"\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3057\u307e\u3057\u305f\u3002\u904b\u55b6\u306b\u554f\u3044\u5408\u308f\u305b\u3066\u304f\u3060\u3055\u3044\u3002\u30e1\u30c3\u30bb\u30fc\u30b8\uff1a\" + str(e)\n>    raise PaymentLogicException(message)\n>  except payjp.error.APIConnectionError as e:\n\n\n\u203b PaymentLogicException\u306f\u7a7a\u306e\u30af\u30e9\u30b9\u3067\u3059\n\u203b PAY.JP\u306f\u672c\u756a\u7a3c\u50cd\u3055\u305b\u3066\u3044\u306a\u3044\u305f\u3081\u4e0d\u5177\u5408\u3092\u898b\u3064\u3051\u6b21\u7b2c\u4fee\u6b63\u4e88\u5b9a\n\u3000PAY.JP\u306e\u516c\u5f0f\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u306b\u300cpayjp.error.PayjpError\u300d\u304c\u8a18\u8f09\u3055\u308c\u3066\u3044\u305f\u306e\u306b\u3001\u305d\u3093\u306a\u30af\u30e9\u30b9\u7121\u3044\u3068\u8a00\u308f\u308c\u308b\u30a8\u30e9\u30fc\u306b\u306a\u3063\u3066\u56f0\u308a\u307e\u3057\u305f\uff08payjp == 0.0.3\uff09\n\n\u30e6\u30fc\u30b6\u30fc : Customer\u30aa\u30d6\u30b8\u30a7\u30af\u30c8 \uff1a \u30ab\u30fc\u30c9\u60c5\u5831\u306e\u95a2\u4fc2\n\u3000\u30e6\u30fc\u30b6\u30fc 1 : n Customer\u30aa\u30d6\u30b8\u30a7\u30af\u30c8 1 : 1 \u30ab\u30fc\u30c9\n\u3000\u3068\u306a\u308b\u3088\u3046\u306b\u8a2d\u5b9a\u3057\u307e\u3057\u305f\u3002\uff08\u30e6\u30fc\u30b6\u30fc\u306f\u8907\u6570\u306eCustomer\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u6301\u3061\u30011Customer\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u306f1\u30ab\u30fc\u30c9\u3092\u6301\u3064\uff09\n\u3000\u4f5c\u3063\u305f\u5f8c\u306b\u6c17\u3065\u304d\u307e\u3057\u305f\u304c\u3001\u5b9f\u614b\u306b\u5373\u3057\u305f\u7406\u60f3\u5f62\u306f\u6b21\u306e\u3088\u3046\u306a\u5f62\u304b\u3082\u3057\u308c\u307e\u305b\u3093\n\u3000\u30e6\u30fc\u30b6\u30fc 1 : 1 Customer\u30aa\u30d6\u30b8\u30a7\u30af\u30c8 1 : n \u30ab\u30fc\u30c9\n\u3000WebPay\u3082PAY.JP\u3082\u51fa\u6765\u308b\u3088\u3046\u3067\u3059\u304c\u8a66\u3057\u305f\u3053\u3068\u306f\u3042\u308a\u307e\u305b\u3093\u3002\n\n\u79fb\u884c\u7de8\n\u3000\u307e\u3060\u79fb\u884c\u304c\u5b8c\u4e86\u3057\u3066\u3044\u306a\u3044\u305f\u3081\u5f8c\u65e5\u8a18\u8f09\u3057\u307e\u3059\u3002\n\u3000\u7d50\u69cb\u6642\u9593\u304b\u304b\u308b\u305f\u3081\u65e9\u3081\u306e\u958b\u8a2d\u3068\u554f\u3044\u5408\u308f\u305b\u304c\u5fc5\u8981\u305d\u3046\u3067\u3059\u3002\n# WebPay\u304b\u3089PAY.JP\u3078\u306e\u79fb\u884c\uff08\u30d7\u30ed\u30b0\u30e9\u30e0\u6539\u4fee\uff09\n\n\u203b WebPay\u3092\u3054\u5b58\u77e5\u3067\u3057\u3087\u3046\u304b\uff1f WebPay\u306f\u65e2\u306b\u30b5\u30fc\u30d3\u30b9\u7d42\u4e86\u4e88\u5b9a\u3068\u306a\u3063\u3066\u3044\u308b\u305f\u3081\u3001\u77e5\u3089\u306a\u3044\u3068\u3044\u3046\u65b9\u306f\u3082\u3046\u4f7f\u3046\u3053\u3068\u304c\u7121\u3044\u304b\u3068\u601d\u3044\u307e\u3059\u306e\u3067\u3053\u306e\u8a18\u4e8b\u306f\u305d\u3063\u3068\u9589\u3058\u3066\u5927\u4e08\u592b\u3067\u3059\u3002\n\nWebPay\u3092\u521d\u3081\u3066\u89e6\u3063\u305f\u3068\u304d\u306f\u7c21\u5358\u306b\u6c7a\u6e08\u30b7\u30b9\u30c6\u30e0\u304c\u4f5c\u308c\u308b\u3068\u3044\u3046\u3068\u3053\u308d\u306b\u611f\u52d5\u3092\u899a\u3048\u305f\u3082\u306e\u3067\u3059\u3002\u305d\u306eWebPay\u3055\u3093\u3067\u3059\u304c\u30012017\u5e744\u6708\u672b\u3067\u30b5\u30fc\u30d3\u30b9\u7d42\u4e86\u3068\u306a\u308a\u3001\u30af\u30ec\u30b8\u30c3\u30c8\u30ab\u30fc\u30c9\u6c7a\u6e08\u4ee3\u884c\u3068\u3044\u3046\u30af\u30ea\u30c6\u30a3\u30ab\u30eb\u306a\u90e8\u5206\u304c\u7121\u304f\u306a\u3063\u3066\u3057\u307e\u3046\u3068\u30c0\u30e1\u30fc\u30b8\u304c\u5927\u304d\u304f\u3001\u305d\u308d\u305d\u308d\u79fb\u884c\u3092\u672c\u683c\u7684\u306b\u8003\u3048\u306a\u3051\u308c\u3070\u306a\u3089\u306a\u3044\u65b9\u3082\u982d\u3092\u62b1\u3048\u3066\u3044\u308b\u304b\u3068\u601d\u3044\u307e\u3059\u3002\n\n\u65b0\u5e74\u660e\u3051\u3066\u5c11\u3057\u6642\u9593\u304c\u53d6\u308c\u305f\u306e\u3067\u3001\u52d5\u304d\u51fa\u3057\u305f\u90e8\u5206\u304b\u3089\u968f\u6642\u66f4\u65b0\u3067\u8a18\u8f09\u3057\u3066\u3044\u3053\u3046\u3068\u601d\u3044\u307e\u3059\u3002\n\n## \u79fb\u884c\u5148\n\u307e\u305a\u3001\u79fb\u884c\u5148\u306b\u3064\u3044\u3066\u306f PAY.JP \u3092\u9078\u629e\u3057\u307e\u3057\u305f\u3002PAY.JP\u3092\u9078\u629e\u3057\u305f\u6c7a\u5b9a\u7684\u306a\u7406\u7531\u306f\u300cJCB\u304c\u4f7f\u3048\u308b\u304b\u3089\u300d\u3067\u3059\u3002\u5f0a\u793e\u30b5\u30fc\u30d3\u30b9\u3067\u306f\u7d99\u7d9a\u8ab2\u91d1\uff08\u6708\u5ea6\u8ab2\u91d1\uff09\u306e\u3046\u3061JCB\u5229\u7528\u7387\u306f30%\u3082\u3042\u308a\u3001\u3053\u308c\u3092\u7121\u8996\u3059\u308b\u3053\u3068\u306f\u51fa\u6765\u307e\u305b\u3093\u3067\u3057\u305f\u3002\n\n\u30ea\u30b9\u30af\u5206\u6563\u306e\u305f\u3081\u306bStripe\u3068\u3044\u3046\u672c\u5bb6\u672c\u5143\u3082\u4e26\u884c\u3057\u3066\u7533\u8acb\u30fb\u5b9f\u88c5\u306f\u3057\u3066\u3044\u307e\u3059\u304c2017\u5e741\u6708\u6642\u70b9\u3067\u306f\u65e5\u672c\u5186\u3067\u306eJCB\u53d6\u6271\u306f\u672a\u5b9a\u306e\u307e\u307e\u3067\u9078\u629e\u3057\u3065\u3089\u3044\u3067\u3059\u3002\n(StripeSupport: https://support.stripe.com/questions/which-cards-and-payment-types-can-i-accept-with-stripe)\n\n## \u30b3\u30fc\u30c9\u5909\u66f4\u70b9\n\n\u79fb\u884c\u306e\u305f\u3081\u306b\u30d7\u30ed\u30b0\u30e9\u30e0\u4fee\u6b63\u3092\u884c\u3044\u3001\u4e00\u901a\u308a\u5b8c\u6210\u3057\u305f\u306e\u3067diff\u3092\u53d6\u3063\u3066\u6652\u3057\u3066\u307f\u307e\u3059\u3002\u3056\u3063\u3068\u30bf\u30b9\u30af\u91cf\u3092\u898b\u7a4d\u3082\u3063\u305f\u308a\u30c1\u30a7\u30c3\u30af\u30ea\u30b9\u30c8\u7684\u306a\u610f\u5473\u5408\u3044\u3067\u8aad\u3080\u3053\u3068\u3092\u30aa\u30b9\u30b9\u30e1\u3057\u3001\u5b9f\u88c5\u3059\u308b\u969b\u306b\u306f\u6b63\u5f0f\u306a\u30d7\u30ed\u30b0\u30e9\u30e0\u306f\u516c\u5f0f\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u3092\u8aad\u3093\u3067\u4e0b\u3055\u3044\u3002\n\n```\u30b3\u30fc\u30c9\u306e\u8aad\u307f\u65b9.\n\u30b3\u30fc\u30c9\u306fPython3\u3067\u3059\u3002\n\u884c\u5148\u982d\u304c < \u3068\u306a\u3063\u3066\u3044\u308b\u306e\u306fWebPay, \u884c\u5148\u982d\u304c > \u3068\u306a\u3063\u3066\u3044\u308b\u306e\u306fPAY.JP\u3068\u306a\u308a\u307e\u3059\n```\n\n## client\u306e\u547c\u3073\u51fa\u3057\u65b9\n\n```python.\n< self.client = webpay.WebPay(settings.WEBPAY_SECRET)\n----\n> payjp.api_key = settings.PAYJP_SECRET\n> self.client = payjp\n```\n\n## \u9867\u5ba2\u4f5c\u6210\n- [x] customer -> Customer\n\n```python.\n<  customer_api_response = self.client.customer.create(\n----\n>  customer_api_response = self.client.Customer.create(\n```\n\n- [x] \u623b\u308a\u5024\u306e\u6271\u3044\u3092\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u5909\u66f4\u3059\u308b\n\n```python.\n<  self.payment_customer.fingerprint = customer_api_response['active_card']['fingerprint']\n<  self.payment_customer.country = customer_api_response['active_card']['country']\n<  self.payment_customer.last4 = customer_api_response['active_card']['last4']\n<  self.payment_customer.type = customer_api_response['active_card'][\u2018type']\n----\n> _default_card_info = None\n> for c in customer_api_response['cards']['data']:\n>   if c['id'] == customer_api_response['default_card']:\n>      _default_card_info = c\n>\n> self.payment_customer.fingerprint = _default_card_info['fingerprint']\n> self.payment_customer.country = _default_card_info['country']\n> self.payment_customer.last4 = _default_card_info['last4']\n> self.payment_customer.type = _default_card_info['brand']\n\n```\nWebPay\u3067\u3044\u3046active_card\u3068\u3044\u3046\u30e1\u30a4\u30f3\u306e\u30ab\u30fc\u30c9\u3092\u53d6\u5f97\u3059\u308b\u65b9\u6cd5\u304c\u601d\u3044\u3064\u304b\u306a\u304b\u3063\u305f\u30fb\u30fb\u30fb\u3002response\u306b['default_card']\u304c\u3042\u308b\u304b\u3089\u3053\u308c\u3068\u540c\u3058\u30ab\u30fc\u30c9\u3092\u53d6\u5f97\u3059\u308c\u3070\u826f\u3044\u306e\u304b\u306a\uff1f\n\u826f\u3044\u65b9\u6cd5\u304c\u3042\u308c\u3070\u6559\u3048\u3066\u304f\u3060\u3055\u3044\uff1e\uff1c\n\n## \u90fd\u5ea6\u8ab2\u91d1\u4eee\u58f2\u4e0a\n- [x] charge -> Charge\n- [x] expire_days -> expiry_days\n\n```python.\n< charge_api_response = self.client.charge.create(\n----\n> charge_api_response = self.client.Charge.create(\n```\n\n```python.\n< expire_days=7 # \u4eee\u58f2\u4e0a\u306f7\u65e5\u9593\u6709\u52b9\n----\n> expiry_days=7 # \u4eee\u58f2\u4e0a\u306f7\u65e5\u9593\u6709\u52b9\n```\n\n## \u90fd\u5ea6\u8ab2\u91d1\u672c\u58f2\u4e0a(\u4eee\u58f2\u4e0a\u3092\u672c\u58f2\u4e0a\u306b\u5909\u66f4)\n```python.\n<  self.client.charge.capture(id=self.charge_api_response['id\u2019])\n----\n>  target_charge = self.client.Charge.retrieve(id=self.charge_api_response['id'])\n>  target_charge.capture()\n```\n\n## \u7d99\u7d9a\u8ab2\u91d1\n\n- [x] PAY.JP\u306f\u4e88\u3081\u300cplan\u300d\u3068\u3044\u3046\u3082\u306e\u3092WEB\u753b\u9762\u4e0a\u3067\u8a2d\u5b9a\u3057\u3066\u304a\u304f\u5fc5\u8981\u3042\u308a\n- [x] \u4ee5\u4e0b\u306e\u3088\u3046\u306a\u611f\u3058\u3067\u30b3\u30fc\u30c9\u3092\u5909\u66f4\u3059\u308b\n\n```python.\n<  charge_api_response = self.client.recursion.create(\n<    amount=self.item_detail.amount,\n<    currency=\"jpy\",\n<    customer=self.payment_customer.customer_id,\n<    period=\"month\",\n<    description=self.item_detail.item.item_name + \"\u6708\u984d\u8ab2\u91d1\",\n<    first_scheduled=int(time.mktime(self.first_scheduled.timetuple()))\n<  )\n----\n>  charge_api_response = self.client.Subscription.create(\n>    plan='premium',\n>    customer=self.payment_customer.customer_id,\n>  )\n```\n\n## \u7d99\u7d9a\u8ab2\u91d1\u524a\u9664\n```python.\n< self.client.recursion.delete(id=self.cancel_order.order_number)\n----\n> subscription = self.client.Subscription.retrieve(id=self.cancel_order.order_number)\n> subscription.delete()\n```\n\n## \u30a8\u30e9\u30fc\u30cf\u30f3\u30c9\u30ea\u30f3\u30b0\n```python.\n< except webpay.error_response.ErrorResponseError as e:\n<    caused_by = e.data.error.caused_by\n<    if caused_by == 'buyer':\n<      # \u30ab\u30fc\u30c9\u30a8\u30e9\u30fc\u306a\u3069\u3001\u8cfc\u5165\u8005\u306b\u539f\u56e0\u304c\u3042\u308b\n<      # \u30a8\u30e9\u30fc\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u305d\u306e\u307e\u307e\u8868\u793a\u3059\u308b\u306e\u304c\u308f\u304b\u308a\u3084\u3059\u3044\n<      message = \"\u30af\u30ec\u30b8\u30c3\u30c8\u30ab\u30fc\u30c9\u306e\u8a8d\u8a3c\u304c\u51fa\u6765\u307e\u305b\u3093\u3067\u3057\u305f\u3002\" \\\n<      \"\u4e0a\u9650\u91d1\u984d\u3092\u8d85\u3048\u3066\u3044\u306a\u3044\u304b\u78ba\u8a8d\u3057\u3066\u3044\u305f\u3060\u304f\u304b\u3001\" \\\n<      \"\u5225\u306e\u30af\u30ec\u30b8\u30c3\u30c8\u30ab\u30fc\u30c9\u756a\u53f7\u3092\u5165\u529b\u3057\u3066\u304f\u3060\u3055\u3044\u3002\" \\\n<      \"\u30af\u30ec\u30b8\u30c3\u30c8\u30ab\u30fc\u30c9\u4f1a\u793e\u304b\u3089\u306e\u30e1\u30c3\u30bb\u30fc\u30b8\uff1a\" + str(e)\n<      raise PaymentLogicException(message)\n<    elif caused_by == 'insufficient':\n<      # \u5b9f\u88c5\u30df\u30b9\u306b\u8d77\u56e0\u3059\u308b\n<      message = \"\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3057\u307e\u3057\u305f\u3002\u904b\u55b6\u306b\u554f\u3044\u5408\u308f\u305b\u3066\u304f\u3060\u3055\u3044\u3002\u30e1\u30c3\u30bb\u30fc\u30b8\uff1a\" + str(e)\n<      raise PaymentLogicException(message)\n<    elif caused_by == 'missing':\n<      # \u30ea\u30af\u30a8\u30b9\u30c8\u5bfe\u8c61\u306e\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u304c\u5b58\u5728\u3057\u306a\u3044\n<      message = \"\u30c8\u30fc\u30af\u30f3\u304c\u7121\u52b9\u3067\u3059\u3002\u518d\u5ea6\u3084\u308a\u76f4\u3057\u3066\u304f\u3060\u3055\u3044\u3002\" + str(e)\n<      raise PaymentLogicException(message)\n<    elif caused_by == 'service':\n<      # WebPay\u306b\u8d77\u56e0\u3059\u308b\u30a8\u30e9\u30fc\n<      message = \"\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3057\u307e\u3057\u305f\u3002\u904b\u55b6\u306b\u554f\u3044\u5408\u308f\u305b\u3066\u304f\u3060\u3055\u3044\u3002\u30e1\u30c3\u30bb\u30fc\u30b8\uff1a\" + str(e)\n<      raise PaymentLogicException(message)\n<    else:\n<      # \u672a\u77e5\u306e\u30a8\u30e9\u30fc\n<      message = \"\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3057\u307e\u3057\u305f\u3002\u904b\u55b6\u306b\u554f\u3044\u5408\u308f\u305b\u3066\u304f\u3060\u3055\u3044\u3002\u30e1\u30c3\u30bb\u30fc\u30b8\uff1a\" + str(e)\n<      raise PaymentLogicException(message)\n< except webpay.ApiError as e:\n<    # API\u304b\u3089\u306e\u30ec\u30b9\u30dd\u30f3\u30b9\u304c\u53d7\u3051\u53d6\u308c\u306a\u3044\u5834\u5408\u3002\u63a5\u7d9a\u30a8\u30e9\u30fc\u306a\u3069\n----\n>  except payjp.error.CardError as e:\n>    # Since it's a decline, payjp.error.CardError will be caught\n>    body = e.json_body\n>    err = body['error']\n>    message = \"\u30af\u30ec\u30b8\u30c3\u30c8\u30ab\u30fc\u30c9\u306e\u8a8d\u8a3c\u304c\u51fa\u6765\u307e\u305b\u3093\u3067\u3057\u305f\u3002\" \\\n>    \"\u4e0a\u9650\u91d1\u984d\u3092\u8d85\u3048\u3066\u3044\u306a\u3044\u304b\u78ba\u8a8d\u3057\u3066\u3044\u305f\u3060\u304f\u304b\u3001\" \\\n>    \"\u5225\u306e\u30af\u30ec\u30b8\u30c3\u30c8\u30ab\u30fc\u30c9\u756a\u53f7\u3092\u5165\u529b\u3057\u3066\u304f\u3060\u3055\u3044\u3002\" \\\n>    \"\u30af\u30ec\u30b8\u30c3\u30c8\u30ab\u30fc\u30c9\u4f1a\u793e\u304b\u3089\u306e\u30e1\u30c3\u30bb\u30fc\u30b8\uff1a\" + str(err['message'])\n>    raise PaymentLogicException(message)\n>  except payjp.error.InvalidRequestError as e:\n>    # Invalid parameters were supplied to Payjp's API\n>    message = \"\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3057\u307e\u3057\u305f\u3002\u904b\u55b6\u306b\u554f\u3044\u5408\u308f\u305b\u3066\u304f\u3060\u3055\u3044\u3002\u30e1\u30c3\u30bb\u30fc\u30b8\uff1a\" + str(e)\n>    raise PaymentLogicException(message)\n>  except payjp.error.AuthenticationError as e:\n>    message = \"\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3057\u307e\u3057\u305f\u3002\u904b\u55b6\u306b\u554f\u3044\u5408\u308f\u305b\u3066\u304f\u3060\u3055\u3044\u3002\u30e1\u30c3\u30bb\u30fc\u30b8\uff1a\" + str(e)\n>    raise PaymentLogicException(message)\n>  except payjp.error.APIConnectionError as e:\n```\n\u203b PaymentLogicException\u306f\u7a7a\u306e\u30af\u30e9\u30b9\u3067\u3059\n\u203b PAY.JP\u306f\u672c\u756a\u7a3c\u50cd\u3055\u305b\u3066\u3044\u306a\u3044\u305f\u3081\u4e0d\u5177\u5408\u3092\u898b\u3064\u3051\u6b21\u7b2c\u4fee\u6b63\u4e88\u5b9a\n\u3000PAY.JP\u306e\u516c\u5f0f\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u306b\u300cpayjp.error.PayjpError\u300d\u304c\u8a18\u8f09\u3055\u308c\u3066\u3044\u305f\u306e\u306b\u3001\u305d\u3093\u306a\u30af\u30e9\u30b9\u7121\u3044\u3068\u8a00\u308f\u308c\u308b\u30a8\u30e9\u30fc\u306b\u306a\u3063\u3066\u56f0\u308a\u307e\u3057\u305f\uff08payjp == 0.0.3\uff09\n\n## \u30e6\u30fc\u30b6\u30fc : Customer\u30aa\u30d6\u30b8\u30a7\u30af\u30c8 \uff1a \u30ab\u30fc\u30c9\u60c5\u5831\u306e\u95a2\u4fc2\n\u3000\u30e6\u30fc\u30b6\u30fc 1 : n Customer\u30aa\u30d6\u30b8\u30a7\u30af\u30c8 1 : 1 \u30ab\u30fc\u30c9\n\u3000\u3068\u306a\u308b\u3088\u3046\u306b\u8a2d\u5b9a\u3057\u307e\u3057\u305f\u3002\uff08\u30e6\u30fc\u30b6\u30fc\u306f\u8907\u6570\u306eCustomer\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u6301\u3061\u30011Customer\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u306f1\u30ab\u30fc\u30c9\u3092\u6301\u3064\uff09\n\n\u3000\u4f5c\u3063\u305f\u5f8c\u306b\u6c17\u3065\u304d\u307e\u3057\u305f\u304c\u3001\u5b9f\u614b\u306b\u5373\u3057\u305f\u7406\u60f3\u5f62\u306f\u6b21\u306e\u3088\u3046\u306a\u5f62\u304b\u3082\u3057\u308c\u307e\u305b\u3093\n\u3000\u30e6\u30fc\u30b6\u30fc 1 : 1 Customer\u30aa\u30d6\u30b8\u30a7\u30af\u30c8 1 : n \u30ab\u30fc\u30c9\n\n\u3000WebPay\u3082PAY.JP\u3082\u51fa\u6765\u308b\u3088\u3046\u3067\u3059\u304c\u8a66\u3057\u305f\u3053\u3068\u306f\u3042\u308a\u307e\u305b\u3093\u3002\n\n\n# \u79fb\u884c\u7de8\n\u3000\u307e\u3060\u79fb\u884c\u304c\u5b8c\u4e86\u3057\u3066\u3044\u306a\u3044\u305f\u3081\u5f8c\u65e5\u8a18\u8f09\u3057\u307e\u3059\u3002\n\u3000\u7d50\u69cb\u6642\u9593\u304b\u304b\u308b\u305f\u3081\u65e9\u3081\u306e\u958b\u8a2d\u3068\u554f\u3044\u5408\u308f\u305b\u304c\u5fc5\u8981\u305d\u3046\u3067\u3059\u3002\n", "tags": ["webpay", "pay.jp", "\u7d99\u7d9a\u8ab2\u91d1", "python3", "stripe"]}