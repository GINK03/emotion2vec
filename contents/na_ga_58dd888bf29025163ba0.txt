{"context": " More than 1 year has passed since last update.\u5f8c\u534a\u75b2\u308c\u3066\u3001\u9069\u5f53\u306b\u306a\u308a\u307e\u304f\u3063\u305f\u610f\u8a33\u3067\u3059\u30fb\u30fb\u30fb\uff08\u672c\u5f53\u306b\u9177\u3044\nhttp://docs.basho.com/riak/1.3.1/tutorials/choosing-a-backend/LevelDB/\n\nOverview\neLevelDB \u306f LevelDB \u306e Erlang \u30d0\u30a4\u30f3\u30c7\u30a3\u30f3\u30b0\u3067\u3059\nLevelDB \u306f\u76f8\u5bfe\u7684\u306b\u65b0\u3057\u3044 Key-Value \u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306e\u30e9\u30a4\u30d6\u30e9\u30ea\u3067\u3059\nLebelDB \u306e\u30b9\u30c8\u30ec\u30fc\u30b8\u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3\u306f BigTable \u306e memtable/sstable \u306b\u4f3c\u3066\u3044\u307e\u3059\n\u3053\u306e\u8a2d\u8a08\u3068\u5b9f\u88c5\u306f\u3001Bitcask \u306e RAM \u5236\u9650\u3092\u89e3\u6d88\u3057\u305f\u30b9\u30c8\u30ec\u30fc\u30b8\u30a8\u30f3\u30b8\u30f3\u306b\u306a\u308b\u53ef\u80fd\u6027\u304c\u3042\u308a\u307e\u3059\n\nStrengths\nLevelDB \u3068 eLevelDB \u306e\u30e9\u30a4\u30bb\u30f3\u30b9\u306f New BSD License \u3068 the Apache 2.0 License \u3067\u3059\nLevelDB \u306f\u521d\u671f\u8a2d\u5b9a\u3067 Google Snappy \u306b\u3088\u308b\u30c7\u30fc\u30bf\u5727\u7e2e\u3092\u884c\u3044\u307e\u3059\n\u3053\u308c\u306b\u3088\u308a CPU \u306e\u8ca0\u8377\u304c\u9ad8\u304f\u306a\u308b\u304c\u3001\u30b5\u30a4\u30ba\u3092\u5c0f\u3055\u304f\u3067\u304d\u307e\u3059\n\u5727\u7e2e\u52b9\u7387\u306f\u30c6\u30ad\u30b9\u30c8\u30c7\u30fc\u30bf (raw text, Base64, JSON \u2026etc) \u3067\u7279\u306b\u826f\u304f\u306a\u308a\u307e\u3059\n\nWeaknesses\nLevelDB \u306f\u8aad\u307f\u8fbc\u3080\u70ba\u306b\u5c11\u6570\u306e\u30b7\u30fc\u30af\u304c\u884c\u308f\u308c\u308b\u304b\u3082\u3057\u308c\u307e\u305b\u3093\nTODO: \u5f8c\u3067\u8aad\u3080\n\nInstalling eLevelDB\neLevelDB \u306f\u30c7\u30a3\u30b9\u30c8\u30ea\u30d3\u30e5\u30fc\u30b7\u30e7\u30f3\u306b\u542b\u307e\u308c\u3066\u3044\u308b\u70ba\u3001\u500b\u5225\u306b\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u5fc5\u8981\u306f\u3042\u308a\u307e\u305b\u3093\n\u3057\u304b\u3057\u306a\u304c\u3089\u3001Riak \u306e\u521d\u671f\u8a2d\u5b9a\u3067\u306f Bitcask \u30b9\u30c8\u30ec\u30fc\u30b8\u30a8\u30f3\u30b8\u30f3\u304c\u4f7f\u7528\u3055\u308c\u307e\u3059\neLevelDB \u3092\u4f7f\u7528\u3059\u308b\u306b\u306f\u3001\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb app.config \u306e storage_backend variable \u3092 riak_kv_eleveldb_backend \u306b\u5909\u66f4\u3057\u307e\u3059\neLevelDB \u3092\u8a2d\u5b9a\u3059\u308b\u3068\u3001Riak \u306f\u521d\u671f\u72b6\u614b\u3067\u4e0b\u8a18\u306e\u3088\u3046\u306b\u683c\u7d0d\u3057\u307e\u3059\u3002\nerlang %% LevelDB Config {eleveldb, [ {data_root, \"/var/lib/riak/leveldb\"} ]},\n\n\nConfiguring eLevelDB\neLevelDB \u306e\u521d\u671f\u72b6\u614b\u306e\u632f\u308b\u821e\u3044\u306f\u3001app.config \u306e eleveldb \u30bb\u30af\u30b7\u30e7\u30f3\u306e\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u8ffd\u52a0\u307e\u305f\u306f\u5909\u66f4\u3059\u308b\u3053\u3068\u3067\u4fee\u6b63\u3067\u304d\u307e\u3059\neLevelDB \u306e\u53e4\u3044\u821e\u3092\u4fee\u6b63\u3059\u308b\u305f\u3081\u306b\u4f7f\u7528\u3059\u308b\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u3001\u5f8c\u8ff0\u3059\u308b Key Parameters \u30bb\u30af\u30b7\u30e7\u30f3\u306b\u8a18\u8f09\u3057\u307e\u3059\n\u307e\u305f\u3001\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u8981\u4ef6\u306b\u57fa\u3065\u3044\u305f\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u3069\u306e\u3088\u3046\u306b\u8a2d\u5b9a\u3059\u308b\u304b\u3092\u3001\u5f8c\u8ff0\u3059\u308b Parameter Planning \u30bb\u30af\u30b7\u30e7\u30f3\u306b\u8a18\u8f09\u3057\u307e\u3059\n\nKey Parameters\neLevelDB \u306e\u632f\u308b\u821e\u3044\u3092\u4fee\u6b63\u3059\u308b\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u4e0b\u8a18\u306b\u8a18\u8f09\u3057\u307e\u3059\n\nWrite Buffer Size\n\u5168\u3066\u306e v-node \u304c\u540c\u3058\u30b5\u30a4\u30ba\u306e write buffer \u3092\u6301\u3064\u3053\u3068\u306f\u671b\u307e\u3057\u304f\u3042\u308a\u307e\u305b\u3093\n\u540c\u3058\u6642\u9593\u306b write buffer \u306e\u5727\u7e2e\u304c\u8d77\u3053\u308b\u3053\u3068\u306b\u3088\u3063\u3066\u3001\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u306b\u5f71\u97ff\u3092\u4e0e\u3048\u307e\u3059\n\u5f93\u3063\u3066\u3001\u521d\u671f\u72b6\u614b\u3067\u306f\u3001eLevelDB \u306f\u5404 v-node \u306e write buffer \u3092\u30e9\u30f3\u30c0\u30e0\u3067\u751f\u6210\u3057\u307e\u3059\nwrite buffer \u306e\u751f\u6210\u3055\u308c\u308b\u7bc4\u56f2\u306f\u3001the write_buffer_size_min \u3068 write_buffer_size_max \u30d1\u30e9\u30e1\u30fc\u30bf\u3067\u6307\u5b9a\u3057\u307e\u3059\n\u3082\u3057 app.config \u3067\u6307\u5b9a\u3057\u306a\u304b\u3063\u305f\u5834\u5408\u306f\u3001the write_buffer_size_min \u3092 30MB\u3001write_buffer_size_max \u3092 60MB \u3068\u306a\u308a\u307e\u3059\n\u4e0b\u8a18\u306e\u3088\u3046\u306b\u8a2d\u5b9a\u3057\u305f\u5834\u5408 write buffer \u306e\u5e73\u5747\u30b5\u30a4\u30ba\u306f 45MB \u306b\u306a\u308b\u3067\u3057\u3087\u3046\n{eleveldb, [\n        ...,\n\n        {write_buffer_size_min, 31457280 }, %% 30 MB in bytes\n            {write_buffer_size_max, 62914560}, %% 60 MB in bytes\n        ...\n]}\n\nwrite buffers \u3092\u5909\u66f4\u3059\u308b\u5834\u5408\u3001write_buffer_size_min \u306f\u5c11\u306a\u304f\u3066\u3082 30MB \u4ee5\u4e0a\u3067\u3001\nwrite_buffer_size_max \u306e\u304a\u3088\u305d\u534a\u5206\u306e\u30b5\u30a4\u30ba\u304c write_buffer_size_min \u3067\u6307\u5b9a\u3055\u308c\u308b\u3079\u304d\u3067\u3059\n\u3082\u3057 write buffers \u3092\u5168\u3066\u540c\u3058\u30b5\u30a4\u30ba\u306b\u8a2d\u5b9a\u3057\u305f\u3044\u5834\u5408\u306f write_buffer_size \u3092\u4f7f\u7528\u3057\u307e\u3059\nwrite_buffer_size \u3092\u4f7f\u7528\u3059\u308b\u3068 write_buffer_size_min \u3068 write_buffer_size_max \u3092\u7121\u8996\u3057\u307e\u3059\n\u3057\u304b\u3057\u306a\u304c\u3089\u3001\u524d\u8ff0\u3057\u305f\u901a\u308a write buffer \u3092\u5168\u3066\u540c\u3058\u30b5\u30a4\u30ba\u306b\u8a2d\u5b9a\u3059\u308b\u3053\u3068\u306f\u63a8\u5968\u3055\u308c\u307e\u305b\u3093\n\u3088\u308a\u5927\u304d\u306a write buffer \u306f\u3001\u7279\u306b\u30d0\u30eb\u30af\u30ed\u30fc\u30c9\u4e2d\u306e\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u3092\u5897\u3084\u3057\u307e\u3059\nUp to two write buffers may be held in memory at the same time, \nso you may wish to adjust this parameter to control memory usage.\n\nMax Open Files\nDB \u306b\u3088\u3063\u3066\u958b\u304f\u3053\u3068\u304c\u3067\u304d\u308b\u30d5\u30a1\u30a4\u30eb\u6570\u3067\u3059\n\u3082\u3057 DB \u306b\u5927\u304d\u306a warking set \u304c\u3042\u308b\u5834\u5408\u3001\u3053\u306e\u5024\u3092\u5897\u52a0\u3055\u305b\u308b\u5fc5\u8981\u304c\u3042\u308b\u304b\u3082\u3057\u308c\u307e\u305b\u3093\nTODO: budget one open file per 2MB of working set divided by ring_creation_size\nmax_open_files \u306e\u6700\u5c0f\u5024\u306f 20 \u3067\u3001\u521d\u671f\u72b6\u614b\u306f 20 \u3068\u306a\u308a\u307e\u3059\n{eleveldb, [\n        ...,\n            {max_open_files, 20}, %% Maximum number of files open at once per partition\n        ...\n]}\n\n\n\u3082\u3057 Riak 1.2 \u3088\u308a\u524d\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u3067 max_open_files \u3092\u8a2d\u5b9a\u3057\u305f\u5834\u5408\u306f Riak 1.2 \u4ee5\u4e0a\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u3067\u306f\u534a\u5206\u306b\u6e1b\u3089\u3059\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\n\u4f8b\u3048\u3070 Riak 1.1 \u3067 250 \u3092\u8a2d\u5b9a\u3057\u3066\u3044\u305f\u5834\u5408\u306f Riak 1.2 \u306b\u3066 125 \u306b\u8a2d\u5b9a\u3057\u307e\u3059\n\u30b9\u30c8\u30ec\u30fc\u30b8\u30a8\u30f3\u30b8\u30f3\u306b\u5229\u7528\u3055\u308c\u308b open file \u306b\u5927\u304d\u306a\u5024\u3092\u8a2d\u5b9a\u3059\u308b\u70ba\u306b\u306f\u3001\u30b7\u30b9\u30c6\u30e0\u306e open files limits \u306e\u8a2d\u5b9a\u3092\u8abf\u3079\u306a\u3051\u308c\u3070\u3044\u3051\u307e\u305b\u3093\n\u3082\u3057 emfile \u3092\u542b\u3080\u30a8\u30e9\u30fc\u304c\u51fa\u529b\u3055\u308c\u305f\u5834\u5408\u306f\u3001\u30b7\u30b9\u30c6\u30e0\u306e open files limit \u3092\u8d85\u904e\u3057\u3066\u3044\u308b\u3067\u3057\u3087\u3046\n\u3088\u308a\u8a73\u7d30\u306a\u60c5\u5831\u306f Tips & Tricks \u30bb\u30af\u30b7\u30e7\u30f3\u3092\u53c2\u7167\u3057\u3066\u304f\u3060\u3055\u3044\n\nBlock Size\n\u30d6\u30ed\u30c3\u30af\u306f user data packed \u306e\u30b5\u30a4\u30ba\u306b\u8fd1\u3044\u5024\u3092\u8a2d\u5b9a\u3057\u307e\u3059\n\u975e\u5e38\u306b\u5927\u304d\u306a\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u3067\u306f\u3001block size \u3092 256k (\u307e\u305f\u306f\u4ed6\u306e 2 \u306e\u7d2f\u4e57) \u306b\u5897\u3084\u3059\u3088\u3046\u306b\u3001\u3088\u308a\u5927\u304d\u306a block size \u304c\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u3092\u5897\u52a0\u3055\u305b\u308b\u826f\u3044\u65b9\u6cd5\u3067\u3059\nLevelDB \u306e\u521d\u671f\u72b6\u614b\u3067\u306f\u3001internal block cache \u306f 8MB \u3067\u3042\u308b\u3053\u3068\u306b\u6ce8\u610f\u3057\u3066\u304f\u3060\u3055\u3044\n\u5f93\u3063\u3066\u3001block size \u3092\u5897\u3084\u3057\u305f\u5834\u5408\u3001\u540c\u69d8\u306b cache_size \u30b5\u30a4\u30ba\u3092\u5909\u66f4\u3057\u305f\u3044\u3068\u601d\u3044\u3067\u3057\u3087\u3046\nblock size \u306e\u521d\u671f\u72b6\u614b\u3067\u306f 4K \u3067\u3059\n{eleveldb, [\n        ...,\n            {block_size, 4096}, %% 4K blocks\n        ...\n]}\n\nRiak 1.2 \u306b\u304a\u3044\u3066\u306f\u521d\u671f\u72b6\u614b\u306e 4K \u304b\u3089\u5909\u66f4\u3059\u308b\u3053\u3068\u306f\u63a8\u5968\u3055\u308c\u307e\u305b\u3093\nRiak 1.2 \u306b\u304a\u3044\u3066\u306f 4K \u3088\u308a\u5927\u304d\u306a block size \u304c\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u3092\u59a8\u3052\u308b\u5834\u5408\u304c\u3042\u308a\u307e\u3059\n\nBlock Restart Interval\n\u30ad\u30fc\u3092 delta \u30a8\u30f3\u30b3\u30fc\u30c9\u3059\u308b\u70ba\u306e restart points \u9593\u306e\u30ad\u30fc\u306e\u6570\u3063\u3066\u3088\u304f\u308f\u304b\u3093\u306d\u30fc\u3051\u3069\u3001\n\u307b\u3068\u3093\u3069\u306e\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u306f\u3001\u3053\u306e\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u305d\u306e\u307e\u307e\u306b\u3057\u3066\u304a\u304f\u3079\u304d\u3067\u3059\nblock_restart_interval \u306e\u521d\u671f\u5024\u306f 16 \u3067\u3059\n{eleveldb, [\n        ...,\n            {block_restart_interval, 16}, %% # of keys before restarting delta encoding\n        ...\n]}\n\n\nCache Size\ncache_size \u306f\u3069\u308c\u3060\u3051\u306e\u30c7\u30fc\u30bf\u3092 LevelDB \u304c\u30e1\u30e2\u30ea\u30fc\u306b\u683c\u7d0d\u3059\u308b\u304b\u3092\u8a2d\u5b9a\u3057\u307e\u3059\n\u30c7\u30fc\u30bf\u30bb\u30c3\u30c8\u306e\u591a\u304f\u3092\u30e1\u30e2\u30ea\u30fc\u306b\u8f09\u305b\u308b\u3053\u3068\u3067\u3001\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u304c\u5411\u4e0a\u3057\u307e\u3059\nLevelDB \u306e\u30ad\u30e3\u30c3\u30b7\u30e5\u306f\u3001OS \u3068\u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0\u306e\u30ad\u30e3\u30c3\u30b7\u30e5\u3068\u4e00\u7dd2\u306b\u52d5\u4f5c\u3057\u307e\u3059\n\u305d\u308c\u3089\u3092\u7121\u52b9\u307e\u305f\u306f under-size \u306b\u3057\u306a\u3044\u3067\u304f\u3060\u3055\u3044\n\u3082\u3057 64-bit \u306e Erlang VM \u4e0a\u3067\u3042\u308c\u3070\u3001\u4eee\u306b\u5341\u5206\u306a\u5229\u7528\u30e1\u30e2\u30ea\u30fc\u304c\u3042\u308b\u5834\u5408\u306f 2GB \u3092\u8d85\u3048\u305f\u5024\u3092\u8a2d\u5b9a\u3067\u304d\u307e\u3059\nBitcask \u3068\u7570\u306a\u308a\u3001LevelDB \u306f keys \u3068 values \u3092 block cache \u306b\u683c\u7d0d\u3057\u307e\u3059\n\u3053\u308c\u306f\u5229\u7528\u53ef\u80fd\u306a\u30e1\u30e2\u30ea\u30fc\u3088\u308a\u5927\u304d\u306a key space \u306e\u7ba1\u7406\u3092\u8003\u616e\u306b\u5165\u308c\u308b\u305f\u3081\u3067\u3059\neLevelDB \u306f cluster \u306e\u5404\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u3054\u3068\u306b LevelDB \u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u4f5c\u6210\u3057\u307e\u3059\n\u3057\u305f\u304c\u3063\u3066\u3001\u5404\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u306f\u81ea\u5206\u306e\u30ad\u30e3\u30c3\u30b7\u30e5\u3092\u6301\u3064\u3067\u3057\u3087\u3046\n\u5229\u7528\u53ef\u80fd\u306a\u30e1\u30e2\u30ea\u30fc\u306e 20-30% \u3092 cache_size \u306b\u8a2d\u5b9a\u3059\u308b\u3053\u3068\u3092\u63a8\u5968\u3057\u307e\u3059\n\u5229\u7528\u53ef\u80fd\u3068\u306f\u3001\u7269\u7406\u7684\u306b\u642d\u8f09\u3055\u308c\u3066\u3044\u308b\u30e1\u30e2\u30ea\u30fc\u304b\u3089\u3001\u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0\u30ad\u30e3\u30c3\u30b7\u30e5\u306e\u30aa\u30fc\u30d0\u30fc\u30d8\u30c3\u30c9\u3092\u542b\u3093\u3060\u4ed6\u30b5\u30fc\u30d3\u30b9\u3067\u627f\u77e5\u3055\u308c\u308b\u30e1\u30e2\u30ea\u30fc\u3092\u53d6\u308a\u9664\u3044\u305f\u5f8c\u306e\u30e1\u30e2\u30ea\u30fc\u3067\u3059\n\u4f8b\u3048\u3070\u3001\u305d\u308c\u305e\u308c 16GB \u306e\u30d5\u30ea\u30fc\u306a\u30e1\u30e2\u30ea\u30fc\u3092\u5099\u3048\u305f 4 \u53f0\u306e\u7269\u7406\u30ce\u30fc\u30c9\u3067 64 \u500b\u306e\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u3067\u69cb\u7bc9\u3055\u308c\u305f\u30af\u30e9\u30b9\u30bf\u3092\u60f3\u5b9a\u3057\u3066\u304f\u3060\u3055\u3044\n\u6700\u524d\u306e\u30b7\u30ca\u30ea\u30aa\u306f\u3001\u5404\u30ce\u30fc\u30c9\u4e0a\u306e\u4e88\u60f3\u3055\u308c\u308b active \u306a v-node \u6570\u3067\u3001\u5229\u7528\u53ef\u80fd\u306a\u30e1\u30e2\u30ea\u30fc \u306e\u534a\u5206 (8GB) \u3092\u5272\u3063\u305f\u30b5\u30a4\u30ba\u3092\u8a2d\u5b9a\u3057\u307e\u3059\n\u5f93\u3063\u3066\u3001\u4e88\u60f3\u3055\u308c\u308b v-node \u6570\u306f 16 (64 / 4) \u3067\u3001\u5229\u7528\u53ef\u80fd\u306a\u30e1\u30e2\u30ea\u30fc\u306e\u534a\u5206 8GB \u3092\u5272\u3063\u305f\u5024 512MB (8GB / 16) \u3092\u8a2d\u5b9a\u3057\u307e\u3059\n     (Number of free GBs / 2) * (1024 ^ 3)\n    ---------------------------------------- = Cache Size\n    (Number of partitions / Number of nodes)\n\n\n\u3057\u304b\u3057\u3001\u5b9f\u969b\u306b\u306f\u3044\u304f\u3064\u304b\u306e\u30ce\u30fc\u30c9\u304c\u843d\u3061\u308b\u304b\u3082\u3057\u308c\u307e\u305b\u3093\n\u7269\u7406\u30ce\u30fc\u30c9\u304c\u843d\u3061\u305f\u6642\u306b\u3001\u3053\u306e\u30af\u30e9\u30b9\u30bf\u30fc\u3067\u4f55\u304c\u8d77\u3053\u308b\u3067\u3057\u3087\u3046\u304b\n\u305d\u306e\u843d\u3061\u305f\u30ce\u30fc\u30c9\u306b\u3088\u3063\u3066\u7ba1\u7406\u3055\u308c\u3066\u3044\u305f 16 \u53f0\u306e v-node \u306f\u3001\u3053\u306e\u30af\u30e9\u30b9\u30bf\u306e active \u306a\u30ce\u30fc\u30c9 (\u4eca\u56de\u306e\u5834\u5408\u306f 3 node) \u3067\u51e6\u7406\u3055\u308c\u307e\u3059\n16 \u53f0\u306e v-node \u3067\u306f\u306a\u304f\u3001\u5404\u30ce\u30fc\u30c9\u306f\u304a\u304a\u3088\u305d 22 \u53f0\u306e v-node \u3092\u51e6\u7406\u3057\u307e\u3059\n16 \u53f0\u3092\u8d85\u3048\u308b\u30ce\u30fc\u30c9\u306f fallback v-node \u3067\u3001\u843d\u3061\u305f\u30ce\u30fc\u30c9\u306e\u4ee3\u308f\u308a\u3068\u3057\u3066\u7ba1\u7406\u3059\u308b\u70ba\u306b\u52d5\u4f5c\u3057\u307e\u3059\n\u3053\u306e\u30b1\u30fc\u30b9\u306b\u304a\u3051\u308b cache \u30b5\u30a4\u30ba\u306f\u3001\u3055\u304d\u307b\u3069\u4e88\u60f3\u3057\u305f 16 * 512MB = 8GB \u306b\u4ee3\u308f\u3063\u3066\u300122 * 512MB = 11GB \u304c\u30ad\u30e3\u30c3\u30b7\u30e5\u306e\u5408\u8a08\u3068\u306a\u308a\u307e\u3059\nThe total available memory is now too heavily weighted towards cache. \n\u3044\u304f\u3064\u304b\u30ad\u30e3\u30c3\u30b7\u30e5\u306b\u4f59\u88d5\u3092\u6301\u305f\u305b\u305f\u304f\u306a\u308b\u3067\u3057\u3087\u3046\n        (Number of free GBs / 2) * (1024 ^ 3)\n    ---------------------------------------------- = Cache Size\n    (Number of partitions / (Number of nodes - F))\n\n    F = Number of nodes that can fail before impacting cache use of memory on remaining systems\n\n\u3082\u3057 1 \u53f0\u306e\u7269\u7406\u30ce\u30fc\u30c9\u304c\u843d\u3061\u3066\u3082\u30ad\u30e3\u30c3\u30b7\u30e5\u30e1\u30e2\u30ea\u30fc\u306b\u5f71\u97ff\u3092\u4e0e\u3048\u306a\u3044\u3088\u3046\u306b\u3059\u308b\u70ba\u306b\u306f F = 1 \u3092\u4f7f\u7528\u3057\u307e\u3059\n\u5229\u7528\u53ef\u80fd\u306a\u30e1\u30e2\u30ea\u30fc\u306e\u534a\u5206 8GB \u3092 22 (64 / (4-1)) \u3067\u5272\u3063\u305f\u5024  372MB \u3092\u6307\u5b9a\u3057\u307e\u3059\n\u3053\u308c\u306b\u3088\u308a\u5404\u7269\u7406\u30ce\u30fc\u30c9\u306f\u30e1\u30e2\u30ea\u30fc\u3092 50% \u3067 22 \u53f0\u306e v-node \u306b\u30ad\u30e3\u30c3\u30b7\u30e5\u3092\u6709\u52b9\u306b\u5229\u7528\u3067\u304d\u307e\u3059\nIf a second node went down, this cluster would feel that.\n\u3082\u3057\u304b\u3057\u305f\u3089\u3001\u306a\u305c\u5229\u7528\u53ef\u80fd\u306a\u30e1\u30e2\u30ea\u30fc\u306e 50% \u3060\u3051\u306a\u306e\u304b\u7591\u554f\u306b\u601d\u3046\u304b\u3082\u3057\u308c\u307e\u305b\u3093\n\u305d\u308c\u306f\u3001\u4ed6\u306e\u7269\u7406\u30e1\u30e2\u30ea\u30fc\u306f OS \u3084 Erlang VM \u3084 OS \u306e\u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0\u306e\u30ad\u30e3\u30c3\u30b7\u30e5 (linux \u4e0a\u306e buffer pool) \u306b\u3088\u3063\u3066\u4f7f\u7528\u3055\u308c\u308b\u304b\u3089\u3067\u3059\n\u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0\u306e\u30ad\u30e3\u30c3\u30b7\u30e5\u306f\u3001\u30af\u30e9\u30b9\u30bf\u306e read/write \u306b\u304b\u304b\u308b\u6642\u9593\u3092\u901f\u304f\u3059\u308b\u3067\u3057\u3087\u3046\n\u3082\u3046\u4e00\u3064\u306e\u7406\u7531\u3068\u3057\u3066\u306f\u30c7\u30a3\u30b9\u30af\u3078\u306e\u30da\u30fc\u30b8\u30f3\u30b0\u3092\u907f\u3051\u308b\u3053\u3068\u306b\u3042\u308a\u307e\u3059\n\u4eee\u60f3\u30e1\u30e2\u30ea\u30fc\u306f OOM \u3092\u9632\u3050\u306e\u3092\u30b5\u30dd\u30fc\u30c8\u3057\u307e\u3059\n\u3057\u304b\u3057\u3001\u30c7\u30a3\u30b9\u30af\u3092\u30da\u30fc\u30b8\u30f3\u30b0\u3059\u308b\u30b3\u30b9\u30c8\u3092\u9ad8\u304f\u3057\u3001\u30af\u30e9\u30b9\u30bf\u306e\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u306b\u8457\u3057\u3044\u5f71\u97ff\u3092\u4e0e\u3048\u307e\u3059\ncache_size \u306e\u521d\u671f\u5024\u306f 8MB \u3067\u3059\n{eleveldb, [\n        ...,\n            {cache_size, 8388608}, %% 8MB default cache size per-partition\n        ...\n]}\n\n\nSync\ntrue \u306b\u3059\u308b\u3068\u3001\u66f8\u8fbc\u307f\u304c\u5b8c\u4e86\u3059\u308b\u524d\u306b OS \u306e buffer cache \u304b\u3089\u30d5\u30e9\u30c3\u30b7\u30e5\u3055\u308c\u307e\u3059\n\u3053\u308c\u306b\u3088\u308a\u66f8\u8fbc\u307f\u901f\u5ea6\u306f\u9045\u304f\u306a\u308a\u307e\u3059\u304c\u3001\u30c7\u30fc\u30bf\u306e\u6c38\u7d9a\u6027\u3092\u3088\u308a\u6b63\u78ba\u306b\u3067\u304d\u307e\u3059\nfalse \u306b\u3059\u308b\u3068\u3001HW \u304c\u30af\u30e9\u30c3\u30b7\u30e5\u3059\u308b\u3068\u3044\u304f\u3064\u304b\u306e\u6700\u8fd1\u306e\u66f8\u8fbc\u307f\u304c\u5931\u308f\u308c\u308b\u304b\u3082\u3057\u308c\u307e\u305b\u3093\n\u30af\u30e9\u30c3\u30b7\u30e5\u3057\u305f\u306e\u304c\u5358\u306b\u30d7\u30ed\u30bb\u30b9\u3067\u3042\u308c\u3070\u3001sync \u304c false \u3067\u3082\u66f8\u8fbc\u307f\u306f\u5931\u308f\u308c\u307e\u305b\u3093\n\u8a00\u3044\u63db\u3048\u308c\u3070\u3001DB \u304c\u540c\u671f\u3057\u306a\u3044\u66f8\u8fbc\u307f\u306e\u610f\u5473\u5408\u3044\u306f write() \u30b7\u30b9\u30c6\u30e0\u30b3\u30fc\u30eb\u3068\u540c\u3058\u8010\u969c\u5bb3\u6027\u3092\u6301\u3063\u3066\u3044\u307e\u3059\n\u307e\u305f\u3001DB \u304c\u540c\u671f\u3059\u308b\u66f8\u8fbc\u307f\u306e\u610f\u5473\u5408\u3044\u306f fsync() \u306b\u7d9a\u3044\u305f write() \u30b7\u30b9\u30c6\u30e0\u30b3\u30fc\u30eb\u3068\u540c\u3058\u8010\u969c\u5bb3\u6027\u3092\u6301\u3063\u3066\u3044\u307e\u3059\n\u3082\u3046\u4e00\u3064\u306e\u8003\u3048\u306f\u3001\u30cf\u30fc\u30c9\u30c7\u30a3\u30b9\u30af\u306f\u81ea\u8eab\u306e\u30e1\u30e2\u30ea\u30fc\u306b\u66f8\u8fbc\u307f\u3092\u30d0\u30c3\u30d5\u30a1\u3057\u3066\u3044\u308b\u304b\u3082\u3057\u308c\u306a\u3044\u306e\u3067\u3001\u30d7\u30e9\u30c3\u30bf\u306b\u66f8\u304d\u8fbc\u3080\u524d\u306b\u66f8\u304d\u8fbc\u307f\u7d50\u679c\u3092\u8fd4\u3057\u3066\u3044\u308b\u304b\u3082\u3057\u308c\u306a\u3044\u3068\u3044\u3046\u3053\u3068\u3067\u3059\n\u30cf\u30fc\u30c9\u30c7\u30a3\u30b9\u30af\u304c\u505c\u96fb\u306e\u5834\u5408\u306b\u304a\u3044\u3066\u30e1\u30e2\u30ea\u30fc\u4e0a\u306e\u30c7\u30fc\u30bf\u3092\u4fdd\u5b58\u3067\u304d\u308b\u304b\u306a\u306e\u3067\u3001\u5b89\u5168\u304b\u3082\u3057\u308c\u306a\u3044\u304c\u3001\u5168\u7136\u3067\u306a\u3044\u304b\u3082\u3057\u308c\u307e\u305b\u3093\n\u30c7\u30fc\u30bf\u306e\u8010\u4e45\u6027\u304c\u7d76\u5bfe\u306b\u5fc5\u8981\u306a\u5834\u5408\u306f\u3001\u30c7\u30a3\u30b9\u30af\u306e buffer \u3092\u7121\u52b9\u306b\u3059\u308b\u304b\u3001\u30d0\u30c3\u30c6\u30ea\u30fc\u306e\u5197\u9577\u5316\u3092\u884c\u3044\u3001\u9069\u5207\u306b shutdown \u3092\u884c\u3046\u3088\u3046\u306b\u3057\u3066\u304f\u3060\u3055\u3044\nsync \u306e\u521d\u671f\u5024\u306f false \u3067\u3059\n{eleveldb, [\n        ...,\n            {sync, true}, %% do the write()/fsync() every time\n        ...\n]}\n\n\nVerify Checksums\ntrue \u306b\u3059\u308b\u3068\u3001\u57fa\u76e4\u30b9\u30c8\u30ec\u30fc\u30b8\u304b\u3089\u306e\u5168\u3066\u306e\u30c7\u30fc\u30bf\u8aad\u307f\u8fbc\u307f\u306f\u3001checksums \u304c\u4e00\u81f4\u3059\u308b\u304b\u78ba\u8a8d\u3055\u308c\u308b\u3067\u3057\u3087\u3046\nverify_checksums \u306e\u521d\u671f\u5024\u306f false \u3067\u3059\n{eleveldb, [\n        ...,\n            {verify_checksums, true}, %% make sure data is what we expected it to be\n        ...\n]}\n\n\nParameter Planning\n\u6b21\u306e\u30b9\u30c6\u30c3\u30d7\u306f\u3001\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u8a2d\u5b9a\u3059\u308b\u3053\u3068\u306b\u3088\u3063\u3066\u3001LevelDB \u306e\u5b9f\u88c5\u304c\u3069\u308c\u3060\u3051\u30e1\u30e2\u30ea\u30fc\u3092\u5fc5\u8981\u3068\u3059\u308b\u304b\u3092\u8a55\u4fa1\u3057\u307e\u3059\n\nStep 1: Calculate Available Working Memory\n\u73fe\u5728\u306e Unix-like \u306a\u30b7\u30b9\u30c6\u30e0 (Linux / Solaris / SmartOS) \u306f\u3001\u30c7\u30a3\u30b9\u30af\u30aa\u30da\u30ec\u30fc\u30b7\u30e7\u30f3\u306e\u305f\u3081\u306e\u30d0\u30d5\u30a1\u9818\u57df\u306b\u3001\u30d7\u30ed\u30b0\u30e9\u30de\u306b\u3088\u3063\u3066\u5272\u308a\u5f53\u3066\u3089\u308c\u306a\u304b\u3063\u305f\u7269\u7406\u30e1\u30e2\u30ea\u30fc\u3092\u4f7f\u7528\u3057\u307e\u3059\nRiak 1.2 \u3067\u306f\u3001LevelDB \u306f OS \u306e\u30d0\u30c3\u30d5\u30a1\u30ea\u30f3\u30b0\u306b\u4f9d\u5b58\u3059\u308b\u70ba\u306b\u30e2\u30c7\u30eb\u5316\u3055\u308c\u307e\u3059\n\u305d\u306e\u305f\u3081\u3001OS \u306e\u70ba\u306b\u5229\u7528\u53ef\u80fd\u306a\u7269\u7406\u30e1\u30e2\u30ea\u30fc\u3092 25-50% \u6b8b\u3055\u306a\u3051\u308c\u3070\u3044\u3051\u307e\u305b\u3093\n\u30cf\u30fc\u30c9\u30c7\u30a3\u30b9\u30af\u306e\u5834\u5408\u306f 35-50%\u3001SSD \u306e\u5834\u5408\u306f 25-35% \u5fc5\u8981\u3067\u3059\nLevelDB \u306e\u30e1\u30e2\u30ea\u30fc\u306f\u3001OS \u306b\u4e88\u7d04\u3055\u308c\u306a\u3044\u30e1\u30e2\u30ea\u30fc\u3068\u3057\u3066\u8a08\u7b97\u3055\u308c\u307e\u3059\nleveldb_working_memory = server_physical_memory * (1 - percent_reserved_for_os)\n\n\u4f8b\u3048\u3070\u3001\u7269\u7406\u30b5\u30fc\u30d0\u304c 32GB \u306e\u30e1\u30e2\u30ea\u30fc\u3092\u642d\u8f09\u3057\u3001\u305d\u306e\u3046\u3061 50% \u304c\u4e88\u7d04\u3055\u308c\u3066\u3044\u308b\u5834\u5408\u306f\u4e0b\u8a18\u306e\u3088\u3046\u306b\u306a\u308a\u307e\u3059\nleveldb_working_memory = 32G * (1 - .50) = 16G\n\n\nStep 2: Calculate Working Memory per vnode\nRiak 1.2 \u3067\u306f\u3001v-node \u306b\u5272\u308a\u4e0e\u3048\u308b\u30e1\u30e2\u30ea\u30fc\u3092\u8a2d\u5b9a\u3057\u307e\u3059\nv-node \u306e\u4f5c\u696d\u30e1\u30e2\u30ea\u30fc\u3092\u8a08\u7b97\u3059\u308b\u306b\u306f\u3001LevelDB \u306e\u5408\u8a08\u4f5c\u696d\u30e1\u30e2\u30ea\u30fc\u3092 vnode \u306e\u6570\u3067\u5272\u308a\u307e\u3059\nvnode_working_memory = leveldb_working_memory / vnode_count\n\n\u4f8b\u3048\u3070\u30011 \u53f0\u306e\u7269\u7406\u30b5\u30fc\u30d0\u304c 64 \u53f0\u306e vnode \u3092\u542b\u3080\u5834\u5408\u306f\u4e0b\u8a18\u306e\u3088\u3046\u306b\u306a\u308a\u307e\u3059\nbash vnode_working_memory = 16G / 64 = 268,435,456 Bytes per vnode\n\n\nStep 3: Estimate Memory Used by Open Files\n\u958b\u304b\u306a\u3051\u308c\u3070\u3044\u3051\u306a\u3044\u30d5\u30a1\u30a4\u30eb\u3092\u4e0e\u3048\u3089\u308c\u305f\u969b\u306e\u6b63\u78ba\u306a\u30e1\u30e2\u30ea\u30fc\u3092\u6c7a\u3081\u308b\u5909\u6570\u304c\u3042\u308a\u307e\u3059\n\u4e0b\u8a18\u306e\u5b9a\u5f0f\u306f\u3001\u9069\u5ea6\u306b\u5927\u304d\u306a LevelDB \u306e\u5b9f\u88c5\u306b\u304a\u3044\u3066\u3001\u8aa4\u5dee 10% \u4ee5\u5185\u306b\u8fd1\u3044\u5024\u3092\u6c42\u3081\u307e\u3059\nopen_file_memory = (max_open_files-10) * (184 + (average_sst_filesize/2048) * (8 + ((average_key_size+average_value_size)/2048 +1) * 0.6)\n\n\u3082\u3057\u7269\u7406\u30b5\u30fc\u30d0\u304c 64 \u53f0\u306e v-node \u3092\u542b\u307f\u3001\u30c6\u30fc\u30d6\u30eb\u306b\u793a\u3059\u30d1\u30e9\u30e1\u30fc\u30bf\u306e\u5834\u5408\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u308a\u307e\u3059\n\n\n\nParameter\nValue\n\n\n\n\nmax_open_files\n150\n\n\naverage_sst_filesize\n314,572,800 Bytes = 300MB\n\n\naverage_key_size\n28 Bytes\n\n\naverage_value_size\n1,024 Bytes = 1MB\n\n\nTotal\n191,587,760 Bytes = 182MB\n\n\n\nbash open_file_memory = (150-10)* (184 + (314,572,800/2048) * (8+((28+1024)/2048 +1)*0.6 = 191,587,760 Bytes \n\n\nStep 4: Calculate Average Write Buffer\nwrite_buffer_size_min \u3068 write_buffer_size_max \u306e\u5e73\u5747\u3092\u8a08\u7b97\u3057\u3066\u304f\u3060\u3055\u3044\n\u521d\u671f\u72b6\u614b\u306f\u305d\u308c\u305e\u308c 30MB \u304a\u3088\u3073 60MB \u3067\u3059\u3002\n\u3057\u305f\u304c\u3063\u3066\u3001\u521d\u671f\u72b6\u614b\u306e\u5e73\u5747\u306f 45MB \u3067\u3059\u3002\n\nStep 5: Calculate vnode Memory Used\nv-node \u306b\u3088\u3063\u3066\u4f7f\u7528\u3055\u308c\u308b\u30e1\u30e2\u30ea\u30fc\u306e\u61b6\u6e2c\u306e\u91cf\u306f\u3001\u4e0b\u8a18\u306b\u5360\u3081\u308b\u9805\u76ee\u306e\u5408\u8a08\u3067\u3059\n\naverage_write_buffer_size (from Step 4)\ncache_size (from app.config)\nopen_file_memory (from step 3)\n20 MB (for management files)\n\n\u4f8b\u3048\u3070\u3001\u30c6\u30fc\u30d6\u30eb\u306b\u793a\u3059\u30d1\u30e9\u30e1\u30fc\u30bf\u306e\u5834\u5408\u306f\u3001\u4e0b\u8a18\u306e\u3088\u3046\u306b\u306a\u308a\u307e\u3059\n\n\n\nParamater\nByte\n\n\n\n\naverage write buffer size\n47,185,920 = 45MB\n\n\ncache size\n8,388,608 = 8MB\n\n\nopen files\n191,587,760 = 182MB\n\n\nmanagement files\n20,971,520\n\n\nTotal\n268,133,808 (~255 MB)\n\n\n\n\nStep 6: Compare Step 2 and Step 5 and Adjust Variables\n\u4f8b\u3048\u3070\u3001\u30b9\u30c6\u30c3\u30d7 2 \u3067\u30011 \u3064\u306e v-node \u3042\u305f\u308a\u306b 268,435,456 Byte = 256MB \u3092\u4f5c\u696d\u30e1\u30e2\u30ea\u30fc\u306b\u8a2d\u5b9a\u3059\u308b\u3053\u3068\u3092\u8a08\u7b97\u3057\u307e\u3057\u305f\n\u30b9\u30c6\u30c3\u30d7 5 \u3067\u3001v-node \u306f\u7d04 268,133,808 Byte = 255MB \u3092\u6d88\u8cbb\u3059\u308b\u3060\u308d\u3046\u3068\u61b6\u6e2c\u3057\u307e\u3057\u305f\n\u30b9\u30c6\u30c3\u30d7 2 \u3068\u30b9\u30c6\u30c3\u30d7 5 \u306e\u9055\u3044\u306f 301,648 Bytes (~300 kB) \u4ee5\u5185\u306b\u3042\u308a\u307e\u3059\n\u3053\u308c\u306f\u4f8b\u5916\u7684\u306b\u8fd1\u3044\u5024\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u304c\u3001but happens to be more precise than really needed.\n\u3053\u306e\u9593\u306e\u8aa4\u5dee\u304c 5% \u4ee5\u5185\u3067\u3042\u308c\u3070\u3001\u5341\u5206\u306b\u826f\u3044\u72b6\u614b\u3067\u3059\n\u4e0a\u8a18\u306e\u8a08\u7b97\u306f\u3001\u3053\u306e memory model spreadsheet \u306e\u4e2d\u3067\u81ea\u52d5\u5316\u3055\u308c\u307e\u3059\n\nTuning LevelDB\neLevelDB \u306f\u3001\u3069\u306e\u3088\u3046\u306b\u30c1\u30e5\u30fc\u30cb\u30f3\u30b0\u3059\u308b\u304b\u306b\u3088\u3063\u3066\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u306f\u6975\u7aef\u306b\u5909\u52d5\u3057\u307e\u3059\nAll the configuration is exposed via application variables in the eleveldb application scope.\n\nTips & Tricks:\n\nBe aware of file handle limits\neLevelDB \u306f max_open_files \u3092\u4f7f\u7528\u3059\u308b\u3053\u3068\u3067\u30d5\u30a1\u30a4\u30eb\u30c7\u30a3\u30b9\u30af\u30ea\u30d7\u30bf\u306e\u6570\u3092\u5236\u5fa1\u3067\u304d\u307e\u3059\neLevelDB \u306f\u3001\u4e00\u3064\u306e\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u3054\u3068\u306b\u521d\u671f\u72b6\u614b\u306e\u6700\u5c0f\u5024\u3067\u3042\u308b 20 \u304c\u8a2d\u5b9a\u3055\u308c\u307e\u3059\n\u3057\u305f\u304c\u3063\u3066\u300164 \u500b\u306e\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u304c\u3042\u308b\u5834\u5408\u3001\u6700\u5927 1280 (20*64) \u500b\u306e\u30d5\u30a1\u30a4\u30eb\u30c7\u30a3\u30b9\u30af\u30ea\u30d7\u30bf\u3092\u6301\u3064\u3067\u3057\u3087\u3046\n\u3053\u308c\u306f\u3001\u3044\u304f\u3064\u304b\u306e\u30d7\u30e9\u30c3\u30c8\u30d5\u30a9\u30fc\u30e0 (\u4f8b\u3048\u3070 OS X \u306e\u5834\u5408\u521d\u671f\u72b6\u614b\u306e\u4e0a\u9650\u306f 256 \u3067\u3059) \u3067\u554f\u984c\u304c\u767a\u751f\u3057\u307e\u3059\n\u305d\u306e\u89e3\u6c7a\u6cd5\u306f\u3001\u5229\u7528\u3067\u304d\u308b\u30d5\u30a1\u30a4\u30eb\u30c7\u30a3\u30b9\u30af\u30ea\u30d7\u30bf\u6570\u3092\u5897\u3084\u3059\u3053\u3068\u3067\u3059\nopen files limitations \u3084 Open-File-Limits \u306e\u60c5\u5831\u3092\u8abf\u67fb\u3057\u3066\u304f\u3060\u3055\u3044\n\nAvoid extra disk head seeks by turning off noatime\neLevelDB \u306f\u30d5\u30a1\u30a4\u30eb\u306e\u8aad\u307f\u66f8\u304d\u3092\u7a4d\u6975\u7684\u306b\u884c\u3044\u307e\u3059\n\u305d\u306e\u305f\u3081\u3001/etc/fastab \u306e\u30de\u30a6\u30f3\u30c8\u30aa\u30d7\u30b7\u30e7\u30f3\u306b noatime \u3092\u8ffd\u52a0\u3059\u308b\u3053\u3068\u3067\u5927\u5e45\u306a\u901f\u5ea6\u306e\u5411\u4e0a\u3092\u5f97\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\n\u3053\u308c\u306f\u3001\u5168\u3066\u306e\u30d5\u30a1\u30a4\u30eb\u306e\u6700\u7d42\u30a2\u30af\u30bb\u30b9\u6642\u9593\u306b\u8a18\u9332\u3092\u7121\u52b9\u306b\u3057\u307e\u3059\nIf you need last access times but you'd like some of the benefits of this optimization you can try relatime.\n/dev/sda5    /data           ext3    noatime  1 1\n/dev/sdb1    /data/inno-log  ext3    noatime  1 2\n\n\nRecommended Settings\nLinux \u30c7\u30a3\u30b9\u30c8\u30ea\u30d3\u30e5\u30fc\u30b7\u30e7\u30f3\u306b\u304a\u3051\u308b\u63a8\u5968\u3055\u308c\u308b\u4e00\u822c\u7684\u306a\u8a2d\u5b9a\u3092\u4e0b\u8a18\u306b\u793a\u3057\u307e\u3059\n\u672c\u756a\u74b0\u5883\u306b\u304a\u3044\u3066\u306f\u3001/etc/syscfg.conf \u3092\u6b21\u306e\u3088\u3046\u306b\u8a2d\u5b9a\u3059\u308b\u3053\u3068\u3092\u63a8\u5968\u3057\u307e\u3059\nnet.core.wmem_default=8388608\nnet.core.rmem_default=8388608\nnet.core.wmem_max=8388608\nnet.core.rmem_max=8388608\nnet.core.netdev_max_backlog=10000\nnet.core.somaxconn=4000\nnet.ipv4.tcp_max_syn_backlog=40000\nnet.ipv4.tcp_fin_timeout=15\nnet.ipv4.tcp_tw_reuse=1\n\n\nBlock Device Scheduler\n\u30ab\u30fc\u30cd\u30eb 2.6 \u304b\u3089\u3001Linux \u306f 4 \u3064\u306e I/O elevator \u30e2\u30c7\u30eb\u306e\u9078\u629e\u80a2\u3092\u4e0e\u3048\u307e\u3057\u305f\n\u305d\u306e\u3046\u3061\u3001NOOP elevator \u30e2\u30c7\u30eb\u3092\u9078\u629e\u3059\u308b\u3053\u3068\u3092\u63a8\u5968\u3057\u307e\u3059\nLinux \u306e boot line \u306b evevator=noop \u3092\u8a2d\u5b9a\u3059\u308b\u3053\u3068\u3067\u5909\u66f4\u3067\u304d\u307e\u3059\n\next4 Options\next4 \u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0\u306f\u30c7\u30fc\u30bf\u306e\u4fdd\u5168\u6027\u3092\u5897\u52a0\u3055\u305b\u308b\u304c\u3001\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u52a3\u5316\u3092\u5f15\u304d\u8d77\u3053\u3059 2 \u3064\u306e\u30aa\u30d7\u30b7\u30e7\u30f3\u3092\u542b\u3093\u3067\u3044\u307e\u3059\nRiak \u306e\u4fdd\u5168\u6027\u306f\u3001\u540c\u3058\u30c7\u30fc\u30bf\u3092\u8907\u6570\u306e\u30ce\u30fc\u30c9\u3067\u683c\u7d0d\u3059\u308b\u3053\u3068\u306b\u57fa\u3065\u3044\u3066\u3044\u307e\u3059\n\u3053\u308c\u3089\u306e 2 \u3064\u306e\u30aa\u30d7\u30b7\u30e7\u30f3\u306f LevelDB \u306e\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u3092\u5411\u4e0a\u3055\u305b\u308b\u70ba\u306b\u5909\u66f4\u3067\u304d\u307e\u3059\n\u3057\u305f\u304c\u3063\u3066\u3001barrier=0 \u3068 data=writeback \u306b\u8a2d\u5b9a\u3059\u308b\u3053\u3068\u3092\u63a8\u5968\u3057\u307e\u3059\n\nCPU Throttling\nCPU \u306e\u30b9\u30ed\u30c3\u30c8\u30ea\u30f3\u30b0\u304c\u3042\u308b\u5834\u5408\u3001\u7121\u52b9\u306b\u3059\u308b\u3053\u3068\u3067 LevelDB \u306e\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u3092\u5411\u4e0a\u3067\u304d\u308b\u5834\u5408\u304c\u3042\u308a\u307e\u3059\n\nNo Entropy\nHTTP \u30d7\u30ed\u30c8\u30b3\u30eb\u3092\u4f7f\u7528\u3057\u3066\u3044\u308c\u3070\u3001\u30ab\u30fc\u30cd\u30eb 2.6 \u306e SSL entropy bits \u306b\u3088\u3063\u3066\u30d7\u30ed\u30b0\u30e9\u30e0\u304c\u505c\u6b62\u3059\u308b\u3053\u3068\u304c\u3088\u304f\u77e5\u3089\u308c\u3066\u3044\u307e\u3059\nHTTPS \u3092\u4f7f\u7528\u3059\u308b\u5834\u5408\u306f\u3001\u7591\u4f3c\u4e71\u6570\u306e\u751f\u6210\u306e\u70ba\u306b HAVEGE \u30d1\u30c3\u30b1\u30fc\u30b8\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3092\u63a8\u5968\u3057\u307e\u3059\n\nswappiness\n/etc/sysctl.conf \u306b vm.swappiness=0 \u3092\u8a2d\u5b9a\u3059\u308b\u3053\u3068\u3092\u63a8\u5968\u3057\u307e\u3059\nThe vm.swappiness default is 60, which is aimed toward laptop users with application windows.\nThis was a key change for mysql servers and is often referenced on db performance.\n\nFAQ\nRiak 1.0 \u306b\u304a\u3044\u3066\u30bb\u30ab\u30f3\u30c0\u30ea\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u3092\u4f7f\u7528\u3059\u308b\u306b\u306f eLevelDB \u3067\u30d0\u30b1\u30c3\u30c8\u306e\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u304c\u8a2d\u5b9a\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u3092\u5fc5\u8981\u3068\u3057\u307e\u3059\n\nLevelDB Implementation Details\nLevelDB \u306f Google \u306e\u652f\u63f4\u3092\u53d7\u3051\u305f\u30aa\u30fc\u30d7\u30f3\u30bd\u30fc\u30b9\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u3067\u3059\nLevelDB \u306f Erlang \u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306b\u7d44\u307f\u5165\u308c\u3089\u308c\u3001Riak \u3067 key/value \u30c7\u30fc\u30bf\u3092\u30c7\u30a3\u30b9\u30af\u306b\u683c\u7d0d\u3059\u308b\u30b9\u30c8\u30ec\u30fc\u30b8\u3068\u306a\u308a\u307e\u3057\u305f\nLevelDB \u306e\u5b9f\u88c5\u306f\u3001BigTable \u3092\u30a4\u30f3\u30b9\u30d1\u30a4\u30a2\u3057\u3066\u3044\u307e\u3059\n\nHow \u201cLevels\u201d Are Managed\nLevelDB \u306f memtable/sstable \u30c7\u30b6\u30a4\u30f3\u3067\u3059\n\u30bd\u30fc\u30c8\u3055\u308c\u305f\u30c6\u30fc\u30d6\u30eb\u3078\u306e Set \u306f\u3001\u30ec\u30d9\u30eb\u306e\u30b7\u30fc\u30b1\u30f3\u30b9\u306b\u6574\u7406\u3055\u308c\u307e\u3059\n\u5404\u30ec\u30d9\u30eb\u306f\u3001\u524d\u306e\u30ec\u30d9\u30eb\u306e\u304a\u3088\u305d 10 \u500d\u7a0b\u306e\u30c7\u30fc\u30bf\u3092\u683c\u7d0d\u3057\u307e\u3059\n\u30d5\u30e9\u30c3\u30b7\u30e5\u306b\u3088\u3063\u3066\u751f\u6210\u3055\u308c\u305f\u30bd\u30fc\u30c8\u3055\u308c\u305f\u30c6\u30fc\u30d6\u30eb\u306f\u3001\u7279\u306b\u82e5\u3044\u30ec\u30d9\u30eb (level-0 \u3068\u547c\u3070\u308c\u308b) \u306b\u7f6e\u304b\u308c\u307e\u3059\n\u82e5\u3044\u30d5\u30a1\u30a4\u30eb\u6570\u304c\u3042\u308b\u95be\u5024 (\u73fe\u5728 4) \u3092\u8d85\u3048\u305f\u5834\u5408\u3001\u65b0\u3057\u3044 level-1 \u30d5\u30a1\u30a4\u30eb\u306e\u30b7\u30fc\u30b1\u30f3\u30b9\u3092\u4f5c\u6210\u3059\u308b\u70ba\u306b\u3001\u5168\u3066\u306e\u82e5\u3044\u30d5\u30a1\u30a4\u30eb\u306f level-1 \u306e\u30d5\u30a1\u30a4\u30eb\u3068\u30de\u30fc\u30b8\u3055\u308c\u307e\u3059\n\u65b0\u3057\u3044 level-1 \u306e\u30d5\u30a1\u30a4\u30eb\u306f\u30012MB \u3054\u3068\u306e\u30c7\u30fc\u30bf\u306b\u4f5c\u6210\u3055\u308c\u307e\u3059\n\u82e5\u3044 level \u306e\u30d5\u30a1\u30a4\u30eb\u306f\u3001\u91cd\u8907\u3057\u305f\u30ad\u30fc\u3092\u542b\u3093\u3067\u3044\u308b\u304b\u3082\u3057\u308c\u307e\u305b\u3093\n\u3057\u304b\u3057\u306a\u304c\u3089\u3001\u4ed6\u306e levels \u306f\u91cd\u8907\u3057\u306a\u3044 key ranges \u304c\u3042\u308a\u307e\u3059\n1 \u3088\u308a\u3082\u5927\u304d\u3044\u5834\u5408\u306e level \u306e\u6570 'L' \u3092\u8003\u3048\u307e\u3059\nLevel-L \u306e\u30d5\u30a1\u30a4\u30eb\u3092\u7d50\u5408\u3057\u305f\u30b5\u30a4\u30ba\u304c 10^L MB (\u4f8b\u3048\u3070 Level-1 \u306f 10MB, Level-2 \u306f 20\nMB\u2026 \u306e\u3088\u3046\u306b) \u3092\u8d85\u3048\u308b\u5834\u5408\u3001Level-L \u306e\u4e00\u3064\u306e\u30d5\u30a1\u30a4\u30eb\u3068 \u5168\u3066\u306e Level-(L+1) \u306e\u30d5\u30a1\u30a4\u30eb\u3092\u30de\u30fc\u30b8\u3057\u3001\u65b0\u3057\u3044 Level-(L+1) \u306e\u30d5\u30a1\u30a4\u30eb\u30bb\u30c3\u30c8\u3092\u4f5c\u6210\u3057\u307e\u3059\n\u3053\u308c\u3089\u306e\u30de\u30fc\u30b8\u306f\u3001bukl reads \u3068 writes \u3092\u4f7f\u7528\u3059\u308b\u3060\u3051\u3067\u3001\u82e5\u3044 Level \u3092\u6700\u5927\u306e Level \u306b\u5f90\u3005\u306b\u79fb\u884c\u3059\u308b\u52b9\u679c\u304c\u3042\u308a\u307e\u3059\nLevel-L \u306e\u30b5\u30a4\u30ba\u304c\u4e0a\u9650\u3092\u8d85\u3048\u308b\u5ea6\u306b\u3001LevelDB \u306f\u30d0\u30c3\u30af\u30b0\u30e9\u30f3\u30c9\u306e\u30b9\u30ec\u30c3\u30c9\u3067\u305d\u308c\u3089\u3092\u5727\u7e2e\u3059\u308b\u3067\u3057\u3087\u3046\nCompaction \u306f\u3001Level-L \u304b\u3089\u30d5\u30a1\u30a4\u30eb\u3092\u53d6\u308a\u3001\u6b21\u306e Level-L+1 \u304b\u3089\u91cd\u8907\u3059\u308b\u30d5\u30a1\u30a4\u30eb\u3092\u5168\u3066\u53d6\u308a\u9664\u304d\u307e\u3059\nLevel-L \u306e\u30d5\u30a1\u30a4\u30eb\u304c\u3001Lebel-L+1 \u306e\u30d5\u30a1\u30a4\u30eb\u306e\u4e00\u90e8\u3060\u3051\u3092\u91cd\u8907\u3057\u3066\u3044\u308b\u5834\u5408\u306f\u6ce8\u610f\u3057\u3066\u304f\u3060\u3055\u3044\nLevel-L+1 \u306e\u30d5\u30a1\u30a4\u30eb\u5168\u4f53\u304c Compaction \u306e\u5165\u529b\u3068\u3057\u3066\u4f7f\u7528\u3055\u308c\u3001Compaction \u5f8c\u306b\u7834\u68c4\u3055\u308c\u308b\u3067\u3057\u3087\u3046\nLevel-0 \u306f\u7279\u5225 (Level-0 \u306e\u30d5\u30a1\u30a4\u30eb\u306f\u91cd\u8907\u3057\u3066\u3044\u308b\u304b\u3082\u3057\u308c\u306a\u3044) \u306a\u306e\u3067\u3001Level-0 \u304b\u3089 Level-1 \u3078\u306e Compaction \u306f\u7279\u5225\u306b\u6271\u308f\u308c\u307e\u3059\nLevel-0 \u306e\u30d5\u30a1\u30a4\u30eb\u306e\u3046\u3061\u3044\u304f\u3064\u304b\u304c\u4e92\u3044\u306b\u91cd\u8907\u3057\u305f\u5834\u5408\u3001Level-0 \u306e Compaction \u306f\u4e00\u3064\u3088\u308a\u591a\u304f\u306e Level-0 \u306e\u30d5\u30a1\u30a4\u30eb\u3092\u53d6\u308a\u9664\u304f\u304b\u3082\u3057\u308c\u307e\u305b\u3093\nCompaction \u306f\u3001Level-L+1 \u30d5\u30a1\u30a4\u30eb\u306e\u30b7\u30fc\u30b1\u30f3\u30b9\u3092\u751f\u6210\u3059\u308b\u70ba\u306b\u3001\u53d6\u3063\u305f\u30d5\u30a1\u30a4\u30eb\u306e\u5185\u5bb9\u3092\u30de\u30fc\u30b8\u3057\u307e\u3059\nLevelDB \u306f\u3001\u73fe\u5728\u306e output \u30d5\u30a1\u30a4\u30eb\u304c\u5bfe\u8c61\u306e\u30d5\u30a1\u30a4\u30eb\u30b5\u30a4\u30ba (2MB) \u306b\u9054\u3057\u305f\u5f8c\u306b\u3001\u65b0\u3057\u3044 Level-L+1 \u30d5\u30a1\u30a4\u30eb\u3092\u751f\u6210\u3059\u308b\u3088\u3046\u5207\u308a\u66ff\u308f\u308a\u307e\u3059\n\u73fe\u5728\u306e\u51fa\u529b\u30d5\u30a1\u30a4\u30eb\u306e\u30ad\u30fc\u7bc4\u56f2\u304c\u3001ten 'level-(L+2)' \u30d5\u30a1\u30a4\u30eb\u3088\u308a\u5341\u5206\u306b\u5897\u3048\u305f\u5834\u5408\u306b\u3001LevelDB \u306f\u65b0\u3057\u3044\u51fa\u529b\u30d5\u30a1\u30a4\u30eb\u306b\u5207\u308a\u8fd4\u3048\u307e\u3059\n\u3053\u306e\u6700\u5f8c\u306e\u30eb\u30fc\u30eb\u306f\u3001Level-L+1 \u3067\u884c\u3063\u305f Compaction \u306e\u5f8c\u3067\u306f\u3001Level-L+2 \u304b\u3089\u30c7\u30fc\u30bf\u3092\u3042\u307e\u308a\u53d6\u308a\u9664\u304b\u306a\u3044\u3067\u3057\u3087\u3046\n\u5404 Level \u3078\u306e Compaction \u306f\u3001\u30ad\u30fc\u7a7a\u9593\u3092\u901a\u3057\u3066\u56de\u8ee2\u3057\u307e\u3059\n\u3088\u308a\u8a73\u7d30\u3092\u8ff0\u3079\u308b\u3068\u3001\u5404 Level-L \u306b\u304a\u3044\u3066\u3001\u6700\u5f8c\u306b Level-L \u3067\u5b9f\u65bd\u3057\u305f Compaction \u304c\u7d42\u4e86\u3057\u305f\u30ad\u30fc\u3092\u8a18\u9332\u3057\u3066\u3044\u307e\u3059\nLevel-L \u306b\u5bfe\u3059\u308b\u6b21\u306e Compaction \u3067\u306f\u3001\u3053\u306e\u8a18\u9332\u3057\u305f\u30ad\u30fc\u306e\u5f8c\u306b\u6700\u521d\u306b\u306f\u3058\u307e\u308b\u30d5\u30a1\u30a4\u30eb\u3092\u53d6\u308b\u3067\u3057\u3087\u3046\n\u3082\u3057\u30d5\u30a1\u30a4\u30eb\u304c\u7121\u3044\u5834\u5408\u3001\u30ad\u30fc\u7a7a\u9593\u306e\u6700\u521d\u306b\u623b\u308a\u307e\u3059\nLevel-0 \u306e Compaction \u306f\u3001Level-0 \u304b\u3089 4 \u500b\u306e 1MB \u306e\u30d5\u30a1\u30a4\u30eb\u3092\u8aad\u3080\u3067\u3057\u3087\u3046\n\u3055\u3089\u306b\u6700\u60aa\u306e\u30b1\u30fc\u30b9\u3067 Level-1 \u306e\u5168\u3066\u306e\u30d5\u30a1\u30a4\u30eb (10MB) \u3092\u8aad\u307f\u307e\u3059\n\u3064\u307e\u308a\u3001\u3053\u306e\u5834\u5408\u306f LevelDB \u306f 14MB \u8aad\u307f\u8fbc\u307f\u300114MB \u66f8\u304d\u8fbc\u3080\u3067\u3057\u3087\u3046\nLevel-0 \u306e\u7279\u5225\u306a Compaction \u4ee5\u5916\u306b\u304a\u3044\u3066\u306f\u3001LevelDB \u306f Level-L \u304b\u30892MB \u306e\u30d5\u30a1\u30a4\u30eb\u3092 1\u500b\u3068\u308b\u3067\u3057\u3087\u3046\n\u6700\u60aa\u306e\u30b1\u30fc\u30b9\u306b\u304a\u3044\u3066\u306f\u3001Level-L+1 \u304b\u3089\u3001\u304a\u3088\u305d 12 \u500b\u306e\u30d5\u30a1\u30a4\u30eb\u3092\u91cd\u8907\u3057\u3066\u3044\u308b\u3067\u3057\u3087\u3046\n(10 because level-(L+1) is ten times the size of level-L, and another two at the boundaries since the file ranges at level-L will usually not be aligned with the file ranges at level-L+1).\n\u5f93\u3063\u3066\u3001Compaction \u306f 26MB (= 2MB *1 + 2MB * 12) \u8aad\u307f\u8fbc\u307f\u300126MB \u66f8\u304d\u8fbc\u3080\u3067\u3057\u3087\u3046\n\u4eee\u306b 100MB/s \u306e\u30c7\u30a3\u30b9\u30af I/O \u30ec\u30fc\u30c8\u3068\u4eee\u5b9a\u3059\u308b\u3068\u3001\u6700\u60aa\u306e\u30b1\u30fc\u30b9\u306b\u304a\u3051\u308b Compaction \u30b3\u30b9\u30c8\u306f\u304a\u3088\u305d 0.5 \u79d2\u306b\u306a\u308b\u3067\u3057\u3087\u3046\n\u610f\u56f3\u7684\u306b\u9045\u304f\u3057\u305f\u5834\u5408\u306b\u3064\u3044\u3066\u306a\u306e\u3067\u7701\u7565:\nIf we throttle the background writing to a reasonably slow rate, for instance 10% of the full 100MB/s speed, a compaction may take up to 5 seconds. If the user is writing at 10MB/s, LevelDB might build up lots of level-0 files (~50 to hold the 5*10MB). This may significantly increase the cost of reads due to the overhead of merging more files together on every read.\n\nCompaction\nLevels are compacted into ordered data files over time. \nCompaction first computes a score for each level as the ratio of bytes in that level to desired bytes.\nFor level 0, it computes files / desired files instead. \n\u6700\u3082\u9ad8\u3044\u30b9\u30b3\u30a2\u306e\u30ec\u30d9\u30eb\u304c Compaction \u3055\u308c\u307e\u3059\nLevel-0 \u3092 Compaction \u3059\u308b\u5834\u5408\u306b\u8003\u616e\u3059\u308b\u305f\u3060\u4e00\u3064\u306e\u7279\u5225\u306a\u30b1\u30fc\u30b9\u306f\u3001that after picking the primary L0 file to compact, it will check other L0 files to determine the degree to which they overlap. \n\u3053\u308c\u306f\u3001\u3044\u304f\u3064\u304b\u306e I/O \u3092\u56de\u907f\u3059\u308b\u8a66\u307f\u3067\u3001we can expect L0 compactions to usually if not always be \u201call L0 files\u201d.\nSee the PickCompaction routine in 1 for all the details.\n\nComparison of eLevelDB and Bitcask\nLevelDB \u306f\u6301\u7d9a\u7684\u306b\u9806\u5e8f\u3065\u3051\u3089\u308c\u305f Map \u3067\u3059\nBitcask \u306f\u6301\u7d9a\u7684\u306a Hash \u30c6\u30fc\u30d6\u30eb\u3067\u3001\u9806\u5e8f\u3065\u3051\u3089\u308c\u3066\u3044\u307e\u305b\u3093\nBitcask \u306f\u30e1\u30e2\u30ea\u30fc\u306b\u30ad\u30fc\u3092\u683c\u7d0d\u3057\u307e\u3059\n\u5f93\u3063\u3066\u3001\u591a\u6570\u306e\u30ad\u30fc\u304c\u3042\u308b DB \u306b\u304a\u3044\u3066\u306f\u3001\u5229\u7528\u53ef\u80fd\u306a\u30e1\u30e2\u30ea\u30fc\u3092\u4f7f\u3044\u679c\u305f\u3057\u3001\u4eee\u60f3\u30e1\u30e2\u30ea\u3092\u4f7f\u7528\u3059\u308b\u3053\u3068\u3067\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u52a3\u5316\u3092\u5f15\u304d\u8d77\u3053\u3059\u304b\u3082\u3057\u308c\u307e\u305b\u3093\nBitcask \u306f \u4e00\u3064\u306e\u691c\u7d22\u306b\u304b\u304b\u308b\u30c7\u30a3\u30b9\u30af\u30b7\u30fc\u30af\u306f 1 \u56de\u3067\u3042\u308b\u3053\u3068\u3092\u4fdd\u8a3c\u3057\u307e\u3059\nLevelDB \u306f\u5c11\u6570\u306e\u30c7\u30a3\u30b9\u30af\u30b7\u30fc\u30af\u304c\u5fc5\u8981\u3068\u3059\u308b\u304b\u3082\u3057\u308c\u307e\u305b\u3093\n\u4f8b\u3048\u3070\u3001\u8aad\u307f\u8fbc\u307f\u306f\u30ec\u30d9\u30eb\u6bce\u306b\u4e00\u56de\u306e\u30c7\u30a3\u30b9\u30af\u30b7\u30fc\u30af\u304c\u5fc5\u8981\u3068\u306a\u308a\u307e\u3059\n\u3082\u3057\u30e1\u30e2\u30ea\u30fc\u306b\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306e 10% \u304c\u683c\u7d0d\u3055\u308c\u3066\u3044\u308b\u5834\u5408\u3001LevelDB \u306f\u4e00\u56de\u306e\u30c7\u30a3\u30b9\u30af\u30b7\u30fc\u30af\u304c\u5fc5\u8981\u306b\u306a\u308b\u3067\u3057\u3087\u3046\n(for the last level since all of the earlier levels should end up cached in the OS buffer cache)\n\u30e1\u30e2\u30ea\u30fc\u306b\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306e 1% \u304c\u683c\u7d0d\u3055\u308c\u3066\u3044\u308b\u5834\u5408\u3001LevelDB \u306f\u4e8c\u56de\u306e\u30c7\u30a3\u30b9\u30af\u30b7\u30fc\u30af\u304c\u5fc5\u8981\u306b\u306a\u308b\u3067\u3057\u3087\u3046\n\nRecovery\nLevelDB never writes in place: \nLevelDB \u306f\u5e38\u306b\u30ed\u30b0\u30d5\u30a1\u30a4\u30eb\u306b\u8ffd\u8a18\u3059\u308b\u304b\u3001\u307e\u305f\u306f\u65b0\u3057\u3044\u30ed\u30b0\u30d5\u30a1\u30a4\u30eb\u3092\u751f\u6210\u3059\u308b\u70ba\u306b\u65e2\u5b58\u306e\u30d5\u30a1\u30a4\u30eb\u3068\u30de\u30fc\u30b8\u3057\u307e\u3059\n\u3057\u305f\u304c\u3063\u3066 OS \u304c\u30af\u30e9\u30c3\u30b7\u30e5\u3059\u308b\u3068\u3001\u4e0d\u5341\u5206\u306a\u66f8\u8fbc\u307f\u304c\u30ed\u30b0\u306b\u8a18\u9332\u3055\u308c\u308b\u3067\u3057\u3087\u3046\nLevelDB \u306e\u30ea\u30ab\u30d0\u30ea\u30fc\u51e6\u7406\u306f\u3001checksums \u3092\u4f7f\u7528\u3057\u3066\u4e0d\u5b8c\u5168\u306a\u30ec\u30b3\u30fc\u30c9\u3092\u691c\u77e5\u3057\u3001\u305d\u308c\u3092\u30b9\u30ad\u30c3\u30d7\u3059\u308b\u3067\u3057\u3087\u3046\n\neLevelDB Database Files\nBelow there are two directory listings showing what you would expect to find on disk when using eLevelDB. \n\u3053\u306e\u4f8b\u306e\u5834\u5408\u300164 \u500b\u306e\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u30ea\u30f3\u30b0\u3092 64 \u500b\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3067\u8868\u3057\u307e\u3059\nleveldb/\n|-- 0\n|   |-- 000003.log\n|   |-- CURRENT\n|   |-- LOCK\n|   |-- LOG\n|   `-- MANIFEST-000002\n|-- 1004782375664995756265033322492444576013453623296\n|   |-- 000005.log\n|   |-- CURRENT\n|   |-- LOCK\n|   |-- LOG\n|   |-- LOG.old\n|   `-- MANIFEST-000004\n|-- 1027618338748291114361965898003636498195577569280\n|   |-- 000005.log\n|   |-- CURRENT\n|   |-- LOCK\n|   |-- LOG\n|   |-- LOG.old\n|   `-- MANIFEST-000004\n\n... etc ...\n\n`-- 981946412581700398168100746981252653831329677312\n    |-- 000005.log\n    |-- CURRENT\n    |-- LOCK\n    |-- LOG\n    |-- LOG.old\n    `-- MANIFEST-000004\n\n64 directories, 378 files\n\n\u591a\u6570\u306e put (write) \u30aa\u30da\u30ec\u30fc\u30b7\u30e7\u30f3\u3092\u884c\u3046\u3068\u3001eLevelDB \u3067\u52d5\u4f5c\u3057\u3066\u3044\u308b Riak \u30af\u30e9\u30b9\u30bf\u306f\u6b21\u306e\u3088\u3046\u306b\u898b\u3048\u308b\u3067\u3057\u3087\u3046\ngburd@toe:~/Projects/riak/dev/dev1/data$ tree leveldb/\nleveldb/\n|-- 0\n|   |-- 000118.sst\n|   |-- 000119.sst\n|   |-- 000120.sst\n|   |-- 000121.sst\n|   |-- 000123.sst\n|   |-- 000126.sst\n|   |-- 000127.log\n|   |-- CURRENT\n|   |-- LOCK\n|   |-- LOG\n|   |-- LOG.old\n|   `-- MANIFEST-000125\n|-- 1004782375664995756265033322492444576013453623296\n|   |-- 000120.sst\n|   |-- 000121.sst\n|   |-- 000122.sst\n|   |-- 000123.sst\n|   |-- 000125.sst\n|   |-- 000128.sst\n|   |-- 000129.log\n|   |-- CURRENT\n|   |-- LOCK\n|   |-- LOG\n|   |-- LOG.old\n|   `-- MANIFEST-000127\n|-- 1027618338748291114361965898003636498195577569280\n|   |-- 000003.log\n|   |-- CURRENT\n|   |-- LOCK\n|   |-- LOG\n|   `-- MANIFEST-000002\n\n... etc ...\n\n`-- 981946412581700398168100746981252653831329677312\n    |-- 000003.log\n    |-- CURRENT\n    |-- LOCK\n    |-- LOG\n    `-- MANIFEST-000002\n\n64 directories, 433 files\n\n\n\u95a2\u9023\nhttp://dayafterneet.blogspot.jp/2011/05/google-snappy.html\n\u5f8c\u534a\u75b2\u308c\u3066\u3001\u9069\u5f53\u306b\u306a\u308a\u307e\u304f\u3063\u305f\u610f\u8a33\u3067\u3059\u30fb\u30fb\u30fb\uff08\u672c\u5f53\u306b\u9177\u3044\nhttp://docs.basho.com/riak/1.3.1/tutorials/choosing-a-backend/LevelDB/\n\n## Overview\n\neLevelDB \u306f LevelDB \u306e Erlang \u30d0\u30a4\u30f3\u30c7\u30a3\u30f3\u30b0\u3067\u3059\nLevelDB \u306f\u76f8\u5bfe\u7684\u306b\u65b0\u3057\u3044 Key-Value \u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306e\u30e9\u30a4\u30d6\u30e9\u30ea\u3067\u3059\nLebelDB \u306e\u30b9\u30c8\u30ec\u30fc\u30b8\u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3\u306f BigTable \u306e memtable/sstable \u306b\u4f3c\u3066\u3044\u307e\u3059\n\u3053\u306e\u8a2d\u8a08\u3068\u5b9f\u88c5\u306f\u3001Bitcask \u306e RAM \u5236\u9650\u3092\u89e3\u6d88\u3057\u305f\u30b9\u30c8\u30ec\u30fc\u30b8\u30a8\u30f3\u30b8\u30f3\u306b\u306a\u308b\u53ef\u80fd\u6027\u304c\u3042\u308a\u307e\u3059\n\n## Strengths\n\nLevelDB \u3068 eLevelDB \u306e\u30e9\u30a4\u30bb\u30f3\u30b9\u306f New BSD License \u3068 the Apache 2.0 License \u3067\u3059\nLevelDB \u306f\u521d\u671f\u8a2d\u5b9a\u3067 [Google Snappy](http://code.google.com/p/snappy/) \u306b\u3088\u308b\u30c7\u30fc\u30bf\u5727\u7e2e\u3092\u884c\u3044\u307e\u3059\n\u3053\u308c\u306b\u3088\u308a CPU \u306e\u8ca0\u8377\u304c\u9ad8\u304f\u306a\u308b\u304c\u3001\u30b5\u30a4\u30ba\u3092\u5c0f\u3055\u304f\u3067\u304d\u307e\u3059\n\u5727\u7e2e\u52b9\u7387\u306f\u30c6\u30ad\u30b9\u30c8\u30c7\u30fc\u30bf (raw text, Base64, JSON \u2026etc) \u3067\u7279\u306b\u826f\u304f\u306a\u308a\u307e\u3059\n\n## Weaknesses\n\nLevelDB \u306f\u8aad\u307f\u8fbc\u3080\u70ba\u306b\u5c11\u6570\u306e\u30b7\u30fc\u30af\u304c\u884c\u308f\u308c\u308b\u304b\u3082\u3057\u308c\u307e\u305b\u3093\n\nTODO: \u5f8c\u3067\u8aad\u3080\n\n## Installing eLevelDB\n\neLevelDB \u306f\u30c7\u30a3\u30b9\u30c8\u30ea\u30d3\u30e5\u30fc\u30b7\u30e7\u30f3\u306b\u542b\u307e\u308c\u3066\u3044\u308b\u70ba\u3001\u500b\u5225\u306b\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u5fc5\u8981\u306f\u3042\u308a\u307e\u305b\u3093\n\u3057\u304b\u3057\u306a\u304c\u3089\u3001Riak \u306e\u521d\u671f\u8a2d\u5b9a\u3067\u306f Bitcask \u30b9\u30c8\u30ec\u30fc\u30b8\u30a8\u30f3\u30b8\u30f3\u304c\u4f7f\u7528\u3055\u308c\u307e\u3059\neLevelDB \u3092\u4f7f\u7528\u3059\u308b\u306b\u306f\u3001\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb app.config \u306e storage_backend variable \u3092 riak_kv_eleveldb_backend \u306b\u5909\u66f4\u3057\u307e\u3059\neLevelDB \u3092\u8a2d\u5b9a\u3059\u308b\u3068\u3001Riak \u306f\u521d\u671f\u72b6\u614b\u3067\u4e0b\u8a18\u306e\u3088\u3046\u306b\u683c\u7d0d\u3057\u307e\u3059\u3002\n\n```\nerlang %% LevelDB Config {eleveldb, [ {data_root, \"/var/lib/riak/leveldb\"} ]},\n```\n\n## Configuring eLevelDB\n\neLevelDB \u306e\u521d\u671f\u72b6\u614b\u306e\u632f\u308b\u821e\u3044\u306f\u3001app.config \u306e eleveldb \u30bb\u30af\u30b7\u30e7\u30f3\u306e\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u8ffd\u52a0\u307e\u305f\u306f\u5909\u66f4\u3059\u308b\u3053\u3068\u3067\u4fee\u6b63\u3067\u304d\u307e\u3059\neLevelDB \u306e\u53e4\u3044\u821e\u3092\u4fee\u6b63\u3059\u308b\u305f\u3081\u306b\u4f7f\u7528\u3059\u308b\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u3001\u5f8c\u8ff0\u3059\u308b Key Parameters \u30bb\u30af\u30b7\u30e7\u30f3\u306b\u8a18\u8f09\u3057\u307e\u3059\n\u307e\u305f\u3001\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u8981\u4ef6\u306b\u57fa\u3065\u3044\u305f\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u3069\u306e\u3088\u3046\u306b\u8a2d\u5b9a\u3059\u308b\u304b\u3092\u3001\u5f8c\u8ff0\u3059\u308b Parameter Planning \u30bb\u30af\u30b7\u30e7\u30f3\u306b\u8a18\u8f09\u3057\u307e\u3059\n\n## Key Parameters\n\neLevelDB \u306e\u632f\u308b\u821e\u3044\u3092\u4fee\u6b63\u3059\u308b\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u4e0b\u8a18\u306b\u8a18\u8f09\u3057\u307e\u3059\n\n### Write Buffer Size\n\n\u5168\u3066\u306e v-node \u304c\u540c\u3058\u30b5\u30a4\u30ba\u306e write buffer \u3092\u6301\u3064\u3053\u3068\u306f\u671b\u307e\u3057\u304f\u3042\u308a\u307e\u305b\u3093\n\u540c\u3058\u6642\u9593\u306b write buffer \u306e\u5727\u7e2e\u304c\u8d77\u3053\u308b\u3053\u3068\u306b\u3088\u3063\u3066\u3001\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u306b\u5f71\u97ff\u3092\u4e0e\u3048\u307e\u3059\n\u5f93\u3063\u3066\u3001\u521d\u671f\u72b6\u614b\u3067\u306f\u3001eLevelDB \u306f\u5404 v-node \u306e write buffer \u3092\u30e9\u30f3\u30c0\u30e0\u3067\u751f\u6210\u3057\u307e\u3059\n\nwrite buffer \u306e\u751f\u6210\u3055\u308c\u308b\u7bc4\u56f2\u306f\u3001the write_buffer_size_min \u3068 write_buffer_size_max \u30d1\u30e9\u30e1\u30fc\u30bf\u3067\u6307\u5b9a\u3057\u307e\u3059\n\u3082\u3057 app.config \u3067\u6307\u5b9a\u3057\u306a\u304b\u3063\u305f\u5834\u5408\u306f\u3001the write_buffer_size_min \u3092 30MB\u3001write_buffer_size_max \u3092 60MB \u3068\u306a\u308a\u307e\u3059\n\u4e0b\u8a18\u306e\u3088\u3046\u306b\u8a2d\u5b9a\u3057\u305f\u5834\u5408 write buffer \u306e\u5e73\u5747\u30b5\u30a4\u30ba\u306f 45MB \u306b\u306a\u308b\u3067\u3057\u3087\u3046\n\n```\n{eleveldb, [\n        ...,\n\n        {write_buffer_size_min, 31457280 }, %% 30 MB in bytes\n            {write_buffer_size_max, 62914560}, %% 60 MB in bytes\n        ...\n]}\n```\n\nwrite buffers \u3092\u5909\u66f4\u3059\u308b\u5834\u5408\u3001write_buffer_size_min \u306f\u5c11\u306a\u304f\u3066\u3082 30MB \u4ee5\u4e0a\u3067\u3001\nwrite_buffer_size_max \u306e\u304a\u3088\u305d\u534a\u5206\u306e\u30b5\u30a4\u30ba\u304c write_buffer_size_min \u3067\u6307\u5b9a\u3055\u308c\u308b\u3079\u304d\u3067\u3059\n\n\u3082\u3057 write buffers \u3092\u5168\u3066\u540c\u3058\u30b5\u30a4\u30ba\u306b\u8a2d\u5b9a\u3057\u305f\u3044\u5834\u5408\u306f write_buffer_size \u3092\u4f7f\u7528\u3057\u307e\u3059\nwrite_buffer_size \u3092\u4f7f\u7528\u3059\u308b\u3068 write_buffer_size_min \u3068 write_buffer_size_max \u3092\u7121\u8996\u3057\u307e\u3059\n\u3057\u304b\u3057\u306a\u304c\u3089\u3001\u524d\u8ff0\u3057\u305f\u901a\u308a write buffer \u3092\u5168\u3066\u540c\u3058\u30b5\u30a4\u30ba\u306b\u8a2d\u5b9a\u3059\u308b\u3053\u3068\u306f\u63a8\u5968\u3055\u308c\u307e\u305b\u3093\n\n\u3088\u308a\u5927\u304d\u306a write buffer \u306f\u3001\u7279\u306b\u30d0\u30eb\u30af\u30ed\u30fc\u30c9\u4e2d\u306e\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u3092\u5897\u3084\u3057\u307e\u3059\nUp to two write buffers may be held in memory at the same time, \nso you may wish to adjust this parameter to control memory usage.\n\n### Max Open Files\n\nDB \u306b\u3088\u3063\u3066\u958b\u304f\u3053\u3068\u304c\u3067\u304d\u308b\u30d5\u30a1\u30a4\u30eb\u6570\u3067\u3059\n\u3082\u3057 DB \u306b\u5927\u304d\u306a warking set \u304c\u3042\u308b\u5834\u5408\u3001\u3053\u306e\u5024\u3092\u5897\u52a0\u3055\u305b\u308b\u5fc5\u8981\u304c\u3042\u308b\u304b\u3082\u3057\u308c\u307e\u305b\u3093\nTODO: budget one open file per 2MB of working set divided by ring_creation_size\n\nmax_open_files \u306e\u6700\u5c0f\u5024\u306f 20 \u3067\u3001\u521d\u671f\u72b6\u614b\u306f 20 \u3068\u306a\u308a\u307e\u3059\n\n```\n{eleveldb, [\n        ...,\n            {max_open_files, 20}, %% Maximum number of files open at once per partition\n        ...\n]}\n\n```\n\n\u3082\u3057 Riak 1.2 \u3088\u308a\u524d\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u3067 max_open_files \u3092\u8a2d\u5b9a\u3057\u305f\u5834\u5408\u306f Riak 1.2 \u4ee5\u4e0a\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u3067\u306f\u534a\u5206\u306b\u6e1b\u3089\u3059\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\n\u4f8b\u3048\u3070 Riak 1.1 \u3067 250 \u3092\u8a2d\u5b9a\u3057\u3066\u3044\u305f\u5834\u5408\u306f Riak 1.2 \u306b\u3066 125 \u306b\u8a2d\u5b9a\u3057\u307e\u3059\n\n\u30b9\u30c8\u30ec\u30fc\u30b8\u30a8\u30f3\u30b8\u30f3\u306b\u5229\u7528\u3055\u308c\u308b open file \u306b\u5927\u304d\u306a\u5024\u3092\u8a2d\u5b9a\u3059\u308b\u70ba\u306b\u306f\u3001\u30b7\u30b9\u30c6\u30e0\u306e open files limits \u306e\u8a2d\u5b9a\u3092\u8abf\u3079\u306a\u3051\u308c\u3070\u3044\u3051\u307e\u305b\u3093\n\u3082\u3057 emfile \u3092\u542b\u3080\u30a8\u30e9\u30fc\u304c\u51fa\u529b\u3055\u308c\u305f\u5834\u5408\u306f\u3001\u30b7\u30b9\u30c6\u30e0\u306e open files limit \u3092\u8d85\u904e\u3057\u3066\u3044\u308b\u3067\u3057\u3087\u3046\n\u3088\u308a\u8a73\u7d30\u306a\u60c5\u5831\u306f [Tips & Tricks]() \u30bb\u30af\u30b7\u30e7\u30f3\u3092\u53c2\u7167\u3057\u3066\u304f\u3060\u3055\u3044\n\n### Block Size\n\n\u30d6\u30ed\u30c3\u30af\u306f user data packed \u306e\u30b5\u30a4\u30ba\u306b\u8fd1\u3044\u5024\u3092\u8a2d\u5b9a\u3057\u307e\u3059\n\u975e\u5e38\u306b\u5927\u304d\u306a\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u3067\u306f\u3001block size \u3092 256k (\u307e\u305f\u306f\u4ed6\u306e 2 \u306e\u7d2f\u4e57) \u306b\u5897\u3084\u3059\u3088\u3046\u306b\u3001\u3088\u308a\u5927\u304d\u306a block size \u304c\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u3092\u5897\u52a0\u3055\u305b\u308b\u826f\u3044\u65b9\u6cd5\u3067\u3059\n\nLevelDB \u306e\u521d\u671f\u72b6\u614b\u3067\u306f\u3001internal block cache \u306f 8MB \u3067\u3042\u308b\u3053\u3068\u306b\u6ce8\u610f\u3057\u3066\u304f\u3060\u3055\u3044\n\u5f93\u3063\u3066\u3001block size \u3092\u5897\u3084\u3057\u305f\u5834\u5408\u3001\u540c\u69d8\u306b cache_size \u30b5\u30a4\u30ba\u3092\u5909\u66f4\u3057\u305f\u3044\u3068\u601d\u3044\u3067\u3057\u3087\u3046\n\nblock size \u306e\u521d\u671f\u72b6\u614b\u3067\u306f 4K \u3067\u3059\n\n```\n{eleveldb, [\n        ...,\n            {block_size, 4096}, %% 4K blocks\n        ...\n]}\n```\n\nRiak 1.2 \u306b\u304a\u3044\u3066\u306f\u521d\u671f\u72b6\u614b\u306e 4K \u304b\u3089\u5909\u66f4\u3059\u308b\u3053\u3068\u306f\u63a8\u5968\u3055\u308c\u307e\u305b\u3093\nRiak 1.2 \u306b\u304a\u3044\u3066\u306f 4K \u3088\u308a\u5927\u304d\u306a block size \u304c\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u3092\u59a8\u3052\u308b\u5834\u5408\u304c\u3042\u308a\u307e\u3059\n\n### Block Restart Interval\n\n\u30ad\u30fc\u3092 delta \u30a8\u30f3\u30b3\u30fc\u30c9\u3059\u308b\u70ba\u306e restart points \u9593\u306e\u30ad\u30fc\u306e\u6570\u3063\u3066\u3088\u304f\u308f\u304b\u3093\u306d\u30fc\u3051\u3069\u3001\n\u307b\u3068\u3093\u3069\u306e\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u306f\u3001\u3053\u306e\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u305d\u306e\u307e\u307e\u306b\u3057\u3066\u304a\u304f\u3079\u304d\u3067\u3059\nblock_restart_interval \u306e\u521d\u671f\u5024\u306f 16 \u3067\u3059\n\n```\n{eleveldb, [\n        ...,\n            {block_restart_interval, 16}, %% # of keys before restarting delta encoding\n        ...\n]}\n```\n\n### Cache Size\n\ncache_size \u306f\u3069\u308c\u3060\u3051\u306e\u30c7\u30fc\u30bf\u3092 LevelDB \u304c\u30e1\u30e2\u30ea\u30fc\u306b\u683c\u7d0d\u3059\u308b\u304b\u3092\u8a2d\u5b9a\u3057\u307e\u3059\n\u30c7\u30fc\u30bf\u30bb\u30c3\u30c8\u306e\u591a\u304f\u3092\u30e1\u30e2\u30ea\u30fc\u306b\u8f09\u305b\u308b\u3053\u3068\u3067\u3001\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u304c\u5411\u4e0a\u3057\u307e\u3059\nLevelDB \u306e\u30ad\u30e3\u30c3\u30b7\u30e5\u306f\u3001OS \u3068\u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0\u306e\u30ad\u30e3\u30c3\u30b7\u30e5\u3068\u4e00\u7dd2\u306b\u52d5\u4f5c\u3057\u307e\u3059\n\u305d\u308c\u3089\u3092\u7121\u52b9\u307e\u305f\u306f under-size \u306b\u3057\u306a\u3044\u3067\u304f\u3060\u3055\u3044\n\n\u3082\u3057 64-bit \u306e Erlang VM \u4e0a\u3067\u3042\u308c\u3070\u3001\u4eee\u306b\u5341\u5206\u306a\u5229\u7528\u30e1\u30e2\u30ea\u30fc\u304c\u3042\u308b\u5834\u5408\u306f 2GB \u3092\u8d85\u3048\u305f\u5024\u3092\u8a2d\u5b9a\u3067\u304d\u307e\u3059\nBitcask \u3068\u7570\u306a\u308a\u3001LevelDB \u306f keys \u3068 values \u3092 block cache \u306b\u683c\u7d0d\u3057\u307e\u3059\n\u3053\u308c\u306f\u5229\u7528\u53ef\u80fd\u306a\u30e1\u30e2\u30ea\u30fc\u3088\u308a\u5927\u304d\u306a key space \u306e\u7ba1\u7406\u3092\u8003\u616e\u306b\u5165\u308c\u308b\u305f\u3081\u3067\u3059\n\neLevelDB \u306f cluster \u306e\u5404\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u3054\u3068\u306b LevelDB \u306e\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u4f5c\u6210\u3057\u307e\u3059\n\u3057\u305f\u304c\u3063\u3066\u3001\u5404\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u306f\u81ea\u5206\u306e\u30ad\u30e3\u30c3\u30b7\u30e5\u3092\u6301\u3064\u3067\u3057\u3087\u3046\n\n\u5229\u7528\u53ef\u80fd\u306a\u30e1\u30e2\u30ea\u30fc\u306e 20-30% \u3092 cache_size \u306b\u8a2d\u5b9a\u3059\u308b\u3053\u3068\u3092\u63a8\u5968\u3057\u307e\u3059\n\u5229\u7528\u53ef\u80fd\u3068\u306f\u3001\u7269\u7406\u7684\u306b\u642d\u8f09\u3055\u308c\u3066\u3044\u308b\u30e1\u30e2\u30ea\u30fc\u304b\u3089\u3001\u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0\u30ad\u30e3\u30c3\u30b7\u30e5\u306e\u30aa\u30fc\u30d0\u30fc\u30d8\u30c3\u30c9\u3092\u542b\u3093\u3060\u4ed6\u30b5\u30fc\u30d3\u30b9\u3067\u627f\u77e5\u3055\u308c\u308b\u30e1\u30e2\u30ea\u30fc\u3092\u53d6\u308a\u9664\u3044\u305f\u5f8c\u306e\u30e1\u30e2\u30ea\u30fc\u3067\u3059\n\n\u4f8b\u3048\u3070\u3001\u305d\u308c\u305e\u308c 16GB \u306e\u30d5\u30ea\u30fc\u306a\u30e1\u30e2\u30ea\u30fc\u3092\u5099\u3048\u305f 4 \u53f0\u306e\u7269\u7406\u30ce\u30fc\u30c9\u3067 64 \u500b\u306e\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u3067\u69cb\u7bc9\u3055\u308c\u305f\u30af\u30e9\u30b9\u30bf\u3092\u60f3\u5b9a\u3057\u3066\u304f\u3060\u3055\u3044\n\u6700\u524d\u306e\u30b7\u30ca\u30ea\u30aa\u306f\u3001\u5404\u30ce\u30fc\u30c9\u4e0a\u306e\u4e88\u60f3\u3055\u308c\u308b active \u306a v-node \u6570\u3067\u3001\u5229\u7528\u53ef\u80fd\u306a\u30e1\u30e2\u30ea\u30fc \u306e\u534a\u5206 (8GB) \u3092\u5272\u3063\u305f\u30b5\u30a4\u30ba\u3092\u8a2d\u5b9a\u3057\u307e\u3059\n\u5f93\u3063\u3066\u3001\u4e88\u60f3\u3055\u308c\u308b v-node \u6570\u306f 16 (64 / 4) \u3067\u3001\u5229\u7528\u53ef\u80fd\u306a\u30e1\u30e2\u30ea\u30fc\u306e\u534a\u5206 8GB \u3092\u5272\u3063\u305f\u5024 512MB (8GB / 16) \u3092\u8a2d\u5b9a\u3057\u307e\u3059\n\n```\n     (Number of free GBs / 2) * (1024 ^ 3)\n    ---------------------------------------- = Cache Size\n    (Number of partitions / Number of nodes)\n\n```\n\n\u3057\u304b\u3057\u3001\u5b9f\u969b\u306b\u306f\u3044\u304f\u3064\u304b\u306e\u30ce\u30fc\u30c9\u304c\u843d\u3061\u308b\u304b\u3082\u3057\u308c\u307e\u305b\u3093\n\u7269\u7406\u30ce\u30fc\u30c9\u304c\u843d\u3061\u305f\u6642\u306b\u3001\u3053\u306e\u30af\u30e9\u30b9\u30bf\u30fc\u3067\u4f55\u304c\u8d77\u3053\u308b\u3067\u3057\u3087\u3046\u304b\n\u305d\u306e\u843d\u3061\u305f\u30ce\u30fc\u30c9\u306b\u3088\u3063\u3066\u7ba1\u7406\u3055\u308c\u3066\u3044\u305f 16 \u53f0\u306e v-node \u306f\u3001\u3053\u306e\u30af\u30e9\u30b9\u30bf\u306e active \u306a\u30ce\u30fc\u30c9 (\u4eca\u56de\u306e\u5834\u5408\u306f 3 node) \u3067\u51e6\u7406\u3055\u308c\u307e\u3059\n16 \u53f0\u306e v-node \u3067\u306f\u306a\u304f\u3001\u5404\u30ce\u30fc\u30c9\u306f\u304a\u304a\u3088\u305d 22 \u53f0\u306e v-node \u3092\u51e6\u7406\u3057\u307e\u3059\n16 \u53f0\u3092\u8d85\u3048\u308b\u30ce\u30fc\u30c9\u306f fallback v-node \u3067\u3001\u843d\u3061\u305f\u30ce\u30fc\u30c9\u306e\u4ee3\u308f\u308a\u3068\u3057\u3066\u7ba1\u7406\u3059\u308b\u70ba\u306b\u52d5\u4f5c\u3057\u307e\u3059\n\n\u3053\u306e\u30b1\u30fc\u30b9\u306b\u304a\u3051\u308b cache \u30b5\u30a4\u30ba\u306f\u3001\u3055\u304d\u307b\u3069\u4e88\u60f3\u3057\u305f 16 * 512MB = 8GB \u306b\u4ee3\u308f\u3063\u3066\u300122 * 512MB = 11GB \u304c\u30ad\u30e3\u30c3\u30b7\u30e5\u306e\u5408\u8a08\u3068\u306a\u308a\u307e\u3059\nThe total available memory is now too heavily weighted towards cache. \n\u3044\u304f\u3064\u304b\u30ad\u30e3\u30c3\u30b7\u30e5\u306b\u4f59\u88d5\u3092\u6301\u305f\u305b\u305f\u304f\u306a\u308b\u3067\u3057\u3087\u3046\n\n```\n        (Number of free GBs / 2) * (1024 ^ 3)\n    ---------------------------------------------- = Cache Size\n    (Number of partitions / (Number of nodes - F))\n\n    F = Number of nodes that can fail before impacting cache use of memory on remaining systems\n```\n\n\u3082\u3057 1 \u53f0\u306e\u7269\u7406\u30ce\u30fc\u30c9\u304c\u843d\u3061\u3066\u3082\u30ad\u30e3\u30c3\u30b7\u30e5\u30e1\u30e2\u30ea\u30fc\u306b\u5f71\u97ff\u3092\u4e0e\u3048\u306a\u3044\u3088\u3046\u306b\u3059\u308b\u70ba\u306b\u306f F = 1 \u3092\u4f7f\u7528\u3057\u307e\u3059\n\u5229\u7528\u53ef\u80fd\u306a\u30e1\u30e2\u30ea\u30fc\u306e\u534a\u5206 8GB \u3092 22 (64 / (4-1)) \u3067\u5272\u3063\u305f\u5024  372MB \u3092\u6307\u5b9a\u3057\u307e\u3059\n\u3053\u308c\u306b\u3088\u308a\u5404\u7269\u7406\u30ce\u30fc\u30c9\u306f\u30e1\u30e2\u30ea\u30fc\u3092 50% \u3067 22 \u53f0\u306e v-node \u306b\u30ad\u30e3\u30c3\u30b7\u30e5\u3092\u6709\u52b9\u306b\u5229\u7528\u3067\u304d\u307e\u3059\nIf a second node went down, this cluster would feel that.\n\n\n\u3082\u3057\u304b\u3057\u305f\u3089\u3001\u306a\u305c\u5229\u7528\u53ef\u80fd\u306a\u30e1\u30e2\u30ea\u30fc\u306e 50% \u3060\u3051\u306a\u306e\u304b\u7591\u554f\u306b\u601d\u3046\u304b\u3082\u3057\u308c\u307e\u305b\u3093\n\u305d\u308c\u306f\u3001\u4ed6\u306e\u7269\u7406\u30e1\u30e2\u30ea\u30fc\u306f OS \u3084 Erlang VM \u3084 OS \u306e\u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0\u306e\u30ad\u30e3\u30c3\u30b7\u30e5 (linux \u4e0a\u306e buffer pool) \u306b\u3088\u3063\u3066\u4f7f\u7528\u3055\u308c\u308b\u304b\u3089\u3067\u3059\n\u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0\u306e\u30ad\u30e3\u30c3\u30b7\u30e5\u306f\u3001\u30af\u30e9\u30b9\u30bf\u306e read/write \u306b\u304b\u304b\u308b\u6642\u9593\u3092\u901f\u304f\u3059\u308b\u3067\u3057\u3087\u3046\n\u3082\u3046\u4e00\u3064\u306e\u7406\u7531\u3068\u3057\u3066\u306f\u30c7\u30a3\u30b9\u30af\u3078\u306e\u30da\u30fc\u30b8\u30f3\u30b0\u3092\u907f\u3051\u308b\u3053\u3068\u306b\u3042\u308a\u307e\u3059\n\n\u4eee\u60f3\u30e1\u30e2\u30ea\u30fc\u306f OOM \u3092\u9632\u3050\u306e\u3092\u30b5\u30dd\u30fc\u30c8\u3057\u307e\u3059\n\u3057\u304b\u3057\u3001\u30c7\u30a3\u30b9\u30af\u3092\u30da\u30fc\u30b8\u30f3\u30b0\u3059\u308b\u30b3\u30b9\u30c8\u3092\u9ad8\u304f\u3057\u3001\u30af\u30e9\u30b9\u30bf\u306e\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u306b\u8457\u3057\u3044\u5f71\u97ff\u3092\u4e0e\u3048\u307e\u3059\n\ncache_size \u306e\u521d\u671f\u5024\u306f 8MB \u3067\u3059\n\n```\n{eleveldb, [\n        ...,\n            {cache_size, 8388608}, %% 8MB default cache size per-partition\n        ...\n]}\n```\n\n### Sync\n\ntrue \u306b\u3059\u308b\u3068\u3001\u66f8\u8fbc\u307f\u304c\u5b8c\u4e86\u3059\u308b\u524d\u306b OS \u306e buffer cache \u304b\u3089\u30d5\u30e9\u30c3\u30b7\u30e5\u3055\u308c\u307e\u3059\n\u3053\u308c\u306b\u3088\u308a\u66f8\u8fbc\u307f\u901f\u5ea6\u306f\u9045\u304f\u306a\u308a\u307e\u3059\u304c\u3001\u30c7\u30fc\u30bf\u306e\u6c38\u7d9a\u6027\u3092\u3088\u308a\u6b63\u78ba\u306b\u3067\u304d\u307e\u3059\n\nfalse \u306b\u3059\u308b\u3068\u3001HW \u304c\u30af\u30e9\u30c3\u30b7\u30e5\u3059\u308b\u3068\u3044\u304f\u3064\u304b\u306e\u6700\u8fd1\u306e\u66f8\u8fbc\u307f\u304c\u5931\u308f\u308c\u308b\u304b\u3082\u3057\u308c\u307e\u305b\u3093\n\u30af\u30e9\u30c3\u30b7\u30e5\u3057\u305f\u306e\u304c\u5358\u306b\u30d7\u30ed\u30bb\u30b9\u3067\u3042\u308c\u3070\u3001sync \u304c false \u3067\u3082\u66f8\u8fbc\u307f\u306f\u5931\u308f\u308c\u307e\u305b\u3093\n\n\u8a00\u3044\u63db\u3048\u308c\u3070\u3001DB \u304c\u540c\u671f\u3057\u306a\u3044\u66f8\u8fbc\u307f\u306e\u610f\u5473\u5408\u3044\u306f write() \u30b7\u30b9\u30c6\u30e0\u30b3\u30fc\u30eb\u3068\u540c\u3058\u8010\u969c\u5bb3\u6027\u3092\u6301\u3063\u3066\u3044\u307e\u3059\n\u307e\u305f\u3001DB \u304c\u540c\u671f\u3059\u308b\u66f8\u8fbc\u307f\u306e\u610f\u5473\u5408\u3044\u306f fsync() \u306b\u7d9a\u3044\u305f write() \u30b7\u30b9\u30c6\u30e0\u30b3\u30fc\u30eb\u3068\u540c\u3058\u8010\u969c\u5bb3\u6027\u3092\u6301\u3063\u3066\u3044\u307e\u3059\n\n\u3082\u3046\u4e00\u3064\u306e\u8003\u3048\u306f\u3001\u30cf\u30fc\u30c9\u30c7\u30a3\u30b9\u30af\u306f\u81ea\u8eab\u306e\u30e1\u30e2\u30ea\u30fc\u306b\u66f8\u8fbc\u307f\u3092\u30d0\u30c3\u30d5\u30a1\u3057\u3066\u3044\u308b\u304b\u3082\u3057\u308c\u306a\u3044\u306e\u3067\u3001\u30d7\u30e9\u30c3\u30bf\u306b\u66f8\u304d\u8fbc\u3080\u524d\u306b\u66f8\u304d\u8fbc\u307f\u7d50\u679c\u3092\u8fd4\u3057\u3066\u3044\u308b\u304b\u3082\u3057\u308c\u306a\u3044\u3068\u3044\u3046\u3053\u3068\u3067\u3059\n\u30cf\u30fc\u30c9\u30c7\u30a3\u30b9\u30af\u304c\u505c\u96fb\u306e\u5834\u5408\u306b\u304a\u3044\u3066\u30e1\u30e2\u30ea\u30fc\u4e0a\u306e\u30c7\u30fc\u30bf\u3092\u4fdd\u5b58\u3067\u304d\u308b\u304b\u306a\u306e\u3067\u3001\u5b89\u5168\u304b\u3082\u3057\u308c\u306a\u3044\u304c\u3001\u5168\u7136\u3067\u306a\u3044\u304b\u3082\u3057\u308c\u307e\u305b\u3093\n\u30c7\u30fc\u30bf\u306e\u8010\u4e45\u6027\u304c\u7d76\u5bfe\u306b\u5fc5\u8981\u306a\u5834\u5408\u306f\u3001\u30c7\u30a3\u30b9\u30af\u306e buffer \u3092\u7121\u52b9\u306b\u3059\u308b\u304b\u3001\u30d0\u30c3\u30c6\u30ea\u30fc\u306e\u5197\u9577\u5316\u3092\u884c\u3044\u3001\u9069\u5207\u306b shutdown \u3092\u884c\u3046\u3088\u3046\u306b\u3057\u3066\u304f\u3060\u3055\u3044\n\nsync \u306e\u521d\u671f\u5024\u306f false \u3067\u3059\n\n```\n{eleveldb, [\n        ...,\n            {sync, true}, %% do the write()/fsync() every time\n        ...\n]}\n```\n\n### Verify Checksums\n\ntrue \u306b\u3059\u308b\u3068\u3001\u57fa\u76e4\u30b9\u30c8\u30ec\u30fc\u30b8\u304b\u3089\u306e\u5168\u3066\u306e\u30c7\u30fc\u30bf\u8aad\u307f\u8fbc\u307f\u306f\u3001checksums \u304c\u4e00\u81f4\u3059\u308b\u304b\u78ba\u8a8d\u3055\u308c\u308b\u3067\u3057\u3087\u3046\nverify_checksums \u306e\u521d\u671f\u5024\u306f false \u3067\u3059\n\n```\n{eleveldb, [\n        ...,\n            {verify_checksums, true}, %% make sure data is what we expected it to be\n        ...\n]}\n```\n\n## Parameter Planning\n\n\u6b21\u306e\u30b9\u30c6\u30c3\u30d7\u306f\u3001\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u8a2d\u5b9a\u3059\u308b\u3053\u3068\u306b\u3088\u3063\u3066\u3001LevelDB \u306e\u5b9f\u88c5\u304c\u3069\u308c\u3060\u3051\u30e1\u30e2\u30ea\u30fc\u3092\u5fc5\u8981\u3068\u3059\u308b\u304b\u3092\u8a55\u4fa1\u3057\u307e\u3059\n\n### Step 1: Calculate Available Working Memory\n\n\u73fe\u5728\u306e Unix-like \u306a\u30b7\u30b9\u30c6\u30e0 (Linux / Solaris / SmartOS) \u306f\u3001\u30c7\u30a3\u30b9\u30af\u30aa\u30da\u30ec\u30fc\u30b7\u30e7\u30f3\u306e\u305f\u3081\u306e\u30d0\u30d5\u30a1\u9818\u57df\u306b\u3001\u30d7\u30ed\u30b0\u30e9\u30de\u306b\u3088\u3063\u3066\u5272\u308a\u5f53\u3066\u3089\u308c\u306a\u304b\u3063\u305f\u7269\u7406\u30e1\u30e2\u30ea\u30fc\u3092\u4f7f\u7528\u3057\u307e\u3059\nRiak 1.2 \u3067\u306f\u3001LevelDB \u306f OS \u306e\u30d0\u30c3\u30d5\u30a1\u30ea\u30f3\u30b0\u306b\u4f9d\u5b58\u3059\u308b\u70ba\u306b\u30e2\u30c7\u30eb\u5316\u3055\u308c\u307e\u3059\n\u305d\u306e\u305f\u3081\u3001OS \u306e\u70ba\u306b\u5229\u7528\u53ef\u80fd\u306a\u7269\u7406\u30e1\u30e2\u30ea\u30fc\u3092 25-50% \u6b8b\u3055\u306a\u3051\u308c\u3070\u3044\u3051\u307e\u305b\u3093\n\u30cf\u30fc\u30c9\u30c7\u30a3\u30b9\u30af\u306e\u5834\u5408\u306f 35-50%\u3001SSD \u306e\u5834\u5408\u306f 25-35% \u5fc5\u8981\u3067\u3059\n\nLevelDB \u306e\u30e1\u30e2\u30ea\u30fc\u306f\u3001OS \u306b\u4e88\u7d04\u3055\u308c\u306a\u3044\u30e1\u30e2\u30ea\u30fc\u3068\u3057\u3066\u8a08\u7b97\u3055\u308c\u307e\u3059\n\n```\nleveldb_working_memory = server_physical_memory * (1 - percent_reserved_for_os)\n```\n\n\u4f8b\u3048\u3070\u3001\u7269\u7406\u30b5\u30fc\u30d0\u304c 32GB \u306e\u30e1\u30e2\u30ea\u30fc\u3092\u642d\u8f09\u3057\u3001\u305d\u306e\u3046\u3061 50% \u304c\u4e88\u7d04\u3055\u308c\u3066\u3044\u308b\u5834\u5408\u306f\u4e0b\u8a18\u306e\u3088\u3046\u306b\u306a\u308a\u307e\u3059\n\n```\nleveldb_working_memory = 32G * (1 - .50) = 16G\n```\n\n### Step 2: Calculate Working Memory per vnode\n\nRiak 1.2 \u3067\u306f\u3001v-node \u306b\u5272\u308a\u4e0e\u3048\u308b\u30e1\u30e2\u30ea\u30fc\u3092\u8a2d\u5b9a\u3057\u307e\u3059\nv-node \u306e\u4f5c\u696d\u30e1\u30e2\u30ea\u30fc\u3092\u8a08\u7b97\u3059\u308b\u306b\u306f\u3001LevelDB \u306e\u5408\u8a08\u4f5c\u696d\u30e1\u30e2\u30ea\u30fc\u3092 vnode \u306e\u6570\u3067\u5272\u308a\u307e\u3059\n\n```\nvnode_working_memory = leveldb_working_memory / vnode_count\n```\n\n\u4f8b\u3048\u3070\u30011 \u53f0\u306e\u7269\u7406\u30b5\u30fc\u30d0\u304c 64 \u53f0\u306e vnode \u3092\u542b\u3080\u5834\u5408\u306f\u4e0b\u8a18\u306e\u3088\u3046\u306b\u306a\u308a\u307e\u3059\n\n```\nbash vnode_working_memory = 16G / 64 = 268,435,456 Bytes per vnode\n```\n\n### Step 3: Estimate Memory Used by Open Files\n\n\u958b\u304b\u306a\u3051\u308c\u3070\u3044\u3051\u306a\u3044\u30d5\u30a1\u30a4\u30eb\u3092\u4e0e\u3048\u3089\u308c\u305f\u969b\u306e\u6b63\u78ba\u306a\u30e1\u30e2\u30ea\u30fc\u3092\u6c7a\u3081\u308b\u5909\u6570\u304c\u3042\u308a\u307e\u3059\n\u4e0b\u8a18\u306e\u5b9a\u5f0f\u306f\u3001\u9069\u5ea6\u306b\u5927\u304d\u306a LevelDB \u306e\u5b9f\u88c5\u306b\u304a\u3044\u3066\u3001\u8aa4\u5dee 10% \u4ee5\u5185\u306b\u8fd1\u3044\u5024\u3092\u6c42\u3081\u307e\u3059\n\n```\nopen_file_memory = (max_open_files-10) * (184 + (average_sst_filesize/2048) * (8 + ((average_key_size+average_value_size)/2048 +1) * 0.6)\n```\n\n\u3082\u3057\u7269\u7406\u30b5\u30fc\u30d0\u304c 64 \u53f0\u306e v-node \u3092\u542b\u307f\u3001\u30c6\u30fc\u30d6\u30eb\u306b\u793a\u3059\u30d1\u30e9\u30e1\u30fc\u30bf\u306e\u5834\u5408\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u308a\u307e\u3059\n\n|Parameter | Value |\n|:-----------|------------:|\n| max_open_files | 150 |\n| average_sst_filesize | 314,572,800 Bytes = 300MB|\n| average_key_size | 28 Bytes |\n| average_value_size | 1,024 Bytes = 1MB |\n| Total | 191,587,760 Bytes = 182MB|\n\n```\nbash open_file_memory = (150-10)* (184 + (314,572,800/2048) * (8+((28+1024)/2048 +1)*0.6 = 191,587,760 Bytes \n```\n\n### Step 4: Calculate Average Write Buffer\n\nwrite_buffer_size_min \u3068 write_buffer_size_max \u306e\u5e73\u5747\u3092\u8a08\u7b97\u3057\u3066\u304f\u3060\u3055\u3044\n\u521d\u671f\u72b6\u614b\u306f\u305d\u308c\u305e\u308c 30MB \u304a\u3088\u3073 60MB \u3067\u3059\u3002\n\u3057\u305f\u304c\u3063\u3066\u3001\u521d\u671f\u72b6\u614b\u306e\u5e73\u5747\u306f 45MB \u3067\u3059\u3002\n\n### Step 5: Calculate vnode Memory Used\n\nv-node \u306b\u3088\u3063\u3066\u4f7f\u7528\u3055\u308c\u308b\u30e1\u30e2\u30ea\u30fc\u306e\u61b6\u6e2c\u306e\u91cf\u306f\u3001\u4e0b\u8a18\u306b\u5360\u3081\u308b\u9805\u76ee\u306e\u5408\u8a08\u3067\u3059\n\n* average_write_buffer_size (from Step 4)\n* cache_size (from app.config)\n* open_file_memory (from step 3)\n* 20 MB (for management files)\n\n\u4f8b\u3048\u3070\u3001\u30c6\u30fc\u30d6\u30eb\u306b\u793a\u3059\u30d1\u30e9\u30e1\u30fc\u30bf\u306e\u5834\u5408\u306f\u3001\u4e0b\u8a18\u306e\u3088\u3046\u306b\u306a\u308a\u307e\u3059\n\n| Paramater | Byte |\n|:-----------|------------:|\n| average write buffer size | 47,185,920 = 45MB |\n| cache size | 8,388,608 = 8MB |\n| open files | 191,587,760 = 182MB |\n| management files | 20,971,520 |\n| Total | 268,133,808 (~255 MB) |\n\n### Step 6: Compare Step 2 and Step 5 and Adjust Variables\n\n\u4f8b\u3048\u3070\u3001\u30b9\u30c6\u30c3\u30d7 2 \u3067\u30011 \u3064\u306e v-node \u3042\u305f\u308a\u306b 268,435,456 Byte = 256MB \u3092\u4f5c\u696d\u30e1\u30e2\u30ea\u30fc\u306b\u8a2d\u5b9a\u3059\u308b\u3053\u3068\u3092\u8a08\u7b97\u3057\u307e\u3057\u305f\n\u30b9\u30c6\u30c3\u30d7 5 \u3067\u3001v-node \u306f\u7d04 268,133,808 Byte = 255MB \u3092\u6d88\u8cbb\u3059\u308b\u3060\u308d\u3046\u3068\u61b6\u6e2c\u3057\u307e\u3057\u305f\n\u30b9\u30c6\u30c3\u30d7 2 \u3068\u30b9\u30c6\u30c3\u30d7 5 \u306e\u9055\u3044\u306f 301,648 Bytes (~300 kB) \u4ee5\u5185\u306b\u3042\u308a\u307e\u3059\n\u3053\u308c\u306f\u4f8b\u5916\u7684\u306b\u8fd1\u3044\u5024\u306b\u306a\u3063\u3066\u3044\u307e\u3059\u304c\u3001but happens to be more precise than really needed.\n\u3053\u306e\u9593\u306e\u8aa4\u5dee\u304c 5% \u4ee5\u5185\u3067\u3042\u308c\u3070\u3001\u5341\u5206\u306b\u826f\u3044\u72b6\u614b\u3067\u3059\n\n\u4e0a\u8a18\u306e\u8a08\u7b97\u306f\u3001\u3053\u306e memory model spreadsheet \u306e\u4e2d\u3067\u81ea\u52d5\u5316\u3055\u308c\u307e\u3059\n\n## Tuning LevelDB\n\neLevelDB \u306f\u3001\u3069\u306e\u3088\u3046\u306b\u30c1\u30e5\u30fc\u30cb\u30f3\u30b0\u3059\u308b\u304b\u306b\u3088\u3063\u3066\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u306f\u6975\u7aef\u306b\u5909\u52d5\u3057\u307e\u3059\nAll the configuration is exposed via application variables in the eleveldb application scope.\n\n### Tips & Tricks:\n\n#### Be aware of file handle limits\n\neLevelDB \u306f max_open_files \u3092\u4f7f\u7528\u3059\u308b\u3053\u3068\u3067\u30d5\u30a1\u30a4\u30eb\u30c7\u30a3\u30b9\u30af\u30ea\u30d7\u30bf\u306e\u6570\u3092\u5236\u5fa1\u3067\u304d\u307e\u3059\neLevelDB \u306f\u3001\u4e00\u3064\u306e\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u3054\u3068\u306b\u521d\u671f\u72b6\u614b\u306e\u6700\u5c0f\u5024\u3067\u3042\u308b 20 \u304c\u8a2d\u5b9a\u3055\u308c\u307e\u3059\n\u3057\u305f\u304c\u3063\u3066\u300164 \u500b\u306e\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u304c\u3042\u308b\u5834\u5408\u3001\u6700\u5927 1280 (20*64) \u500b\u306e\u30d5\u30a1\u30a4\u30eb\u30c7\u30a3\u30b9\u30af\u30ea\u30d7\u30bf\u3092\u6301\u3064\u3067\u3057\u3087\u3046\n\n\u3053\u308c\u306f\u3001\u3044\u304f\u3064\u304b\u306e\u30d7\u30e9\u30c3\u30c8\u30d5\u30a9\u30fc\u30e0 (\u4f8b\u3048\u3070 OS X \u306e\u5834\u5408\u521d\u671f\u72b6\u614b\u306e\u4e0a\u9650\u306f 256 \u3067\u3059) \u3067\u554f\u984c\u304c\u767a\u751f\u3057\u307e\u3059\n\u305d\u306e\u89e3\u6c7a\u6cd5\u306f\u3001\u5229\u7528\u3067\u304d\u308b\u30d5\u30a1\u30a4\u30eb\u30c7\u30a3\u30b9\u30af\u30ea\u30d7\u30bf\u6570\u3092\u5897\u3084\u3059\u3053\u3068\u3067\u3059\nopen files limitations \u3084 Open-File-Limits \u306e\u60c5\u5831\u3092\u8abf\u67fb\u3057\u3066\u304f\u3060\u3055\u3044\n\n#### Avoid extra disk head seeks by turning off noatime\n\neLevelDB \u306f\u30d5\u30a1\u30a4\u30eb\u306e\u8aad\u307f\u66f8\u304d\u3092\u7a4d\u6975\u7684\u306b\u884c\u3044\u307e\u3059\n\u305d\u306e\u305f\u3081\u3001/etc/fastab \u306e\u30de\u30a6\u30f3\u30c8\u30aa\u30d7\u30b7\u30e7\u30f3\u306b noatime \u3092\u8ffd\u52a0\u3059\u308b\u3053\u3068\u3067\u5927\u5e45\u306a\u901f\u5ea6\u306e\u5411\u4e0a\u3092\u5f97\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\n\u3053\u308c\u306f\u3001\u5168\u3066\u306e\u30d5\u30a1\u30a4\u30eb\u306e\u6700\u7d42\u30a2\u30af\u30bb\u30b9\u6642\u9593\u306b\u8a18\u9332\u3092\u7121\u52b9\u306b\u3057\u307e\u3059\nIf you need last access times but you'd like some of the benefits of this optimization you can try relatime.\n\n```\n/dev/sda5    /data           ext3    noatime  1 1\n/dev/sdb1    /data/inno-log  ext3    noatime  1 2\n```\n\n### Recommended Settings\n\nLinux \u30c7\u30a3\u30b9\u30c8\u30ea\u30d3\u30e5\u30fc\u30b7\u30e7\u30f3\u306b\u304a\u3051\u308b\u63a8\u5968\u3055\u308c\u308b\u4e00\u822c\u7684\u306a\u8a2d\u5b9a\u3092\u4e0b\u8a18\u306b\u793a\u3057\u307e\u3059\n\u672c\u756a\u74b0\u5883\u306b\u304a\u3044\u3066\u306f\u3001/etc/syscfg.conf \u3092\u6b21\u306e\u3088\u3046\u306b\u8a2d\u5b9a\u3059\u308b\u3053\u3068\u3092\u63a8\u5968\u3057\u307e\u3059\n\n```\nnet.core.wmem_default=8388608\nnet.core.rmem_default=8388608\nnet.core.wmem_max=8388608\nnet.core.rmem_max=8388608\nnet.core.netdev_max_backlog=10000\nnet.core.somaxconn=4000\nnet.ipv4.tcp_max_syn_backlog=40000\nnet.ipv4.tcp_fin_timeout=15\nnet.ipv4.tcp_tw_reuse=1\n```\n\n### Block Device Scheduler\n\n\u30ab\u30fc\u30cd\u30eb 2.6 \u304b\u3089\u3001Linux \u306f 4 \u3064\u306e I/O elevator \u30e2\u30c7\u30eb\u306e\u9078\u629e\u80a2\u3092\u4e0e\u3048\u307e\u3057\u305f\n\u305d\u306e\u3046\u3061\u3001NOOP elevator \u30e2\u30c7\u30eb\u3092\u9078\u629e\u3059\u308b\u3053\u3068\u3092\u63a8\u5968\u3057\u307e\u3059\nLinux \u306e boot line \u306b evevator=noop \u3092\u8a2d\u5b9a\u3059\u308b\u3053\u3068\u3067\u5909\u66f4\u3067\u304d\u307e\u3059\n\n### ext4 Options\n\next4 \u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0\u306f\u30c7\u30fc\u30bf\u306e\u4fdd\u5168\u6027\u3092\u5897\u52a0\u3055\u305b\u308b\u304c\u3001\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u52a3\u5316\u3092\u5f15\u304d\u8d77\u3053\u3059 2 \u3064\u306e\u30aa\u30d7\u30b7\u30e7\u30f3\u3092\u542b\u3093\u3067\u3044\u307e\u3059\nRiak \u306e\u4fdd\u5168\u6027\u306f\u3001\u540c\u3058\u30c7\u30fc\u30bf\u3092\u8907\u6570\u306e\u30ce\u30fc\u30c9\u3067\u683c\u7d0d\u3059\u308b\u3053\u3068\u306b\u57fa\u3065\u3044\u3066\u3044\u307e\u3059\n\u3053\u308c\u3089\u306e 2 \u3064\u306e\u30aa\u30d7\u30b7\u30e7\u30f3\u306f LevelDB \u306e\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u3092\u5411\u4e0a\u3055\u305b\u308b\u70ba\u306b\u5909\u66f4\u3067\u304d\u307e\u3059\n\u3057\u305f\u304c\u3063\u3066\u3001barrier=0 \u3068 data=writeback \u306b\u8a2d\u5b9a\u3059\u308b\u3053\u3068\u3092\u63a8\u5968\u3057\u307e\u3059\n\n### CPU Throttling\n\nCPU \u306e\u30b9\u30ed\u30c3\u30c8\u30ea\u30f3\u30b0\u304c\u3042\u308b\u5834\u5408\u3001\u7121\u52b9\u306b\u3059\u308b\u3053\u3068\u3067 LevelDB \u306e\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u3092\u5411\u4e0a\u3067\u304d\u308b\u5834\u5408\u304c\u3042\u308a\u307e\u3059\n\n### No Entropy\n\nHTTP \u30d7\u30ed\u30c8\u30b3\u30eb\u3092\u4f7f\u7528\u3057\u3066\u3044\u308c\u3070\u3001\u30ab\u30fc\u30cd\u30eb 2.6 \u306e SSL entropy bits \u306b\u3088\u3063\u3066\u30d7\u30ed\u30b0\u30e9\u30e0\u304c\u505c\u6b62\u3059\u308b\u3053\u3068\u304c\u3088\u304f\u77e5\u3089\u308c\u3066\u3044\u307e\u3059\nHTTPS \u3092\u4f7f\u7528\u3059\u308b\u5834\u5408\u306f\u3001\u7591\u4f3c\u4e71\u6570\u306e\u751f\u6210\u306e\u70ba\u306b HAVEGE \u30d1\u30c3\u30b1\u30fc\u30b8\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3092\u63a8\u5968\u3057\u307e\u3059\n\n### swappiness\n\n/etc/sysctl.conf \u306b vm.swappiness=0 \u3092\u8a2d\u5b9a\u3059\u308b\u3053\u3068\u3092\u63a8\u5968\u3057\u307e\u3059\nThe vm.swappiness default is 60, which is aimed toward laptop users with application windows.\nThis was a key change for mysql servers and is often referenced on db performance.\n\n## FAQ\n\nRiak 1.0 \u306b\u304a\u3044\u3066\u30bb\u30ab\u30f3\u30c0\u30ea\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u3092\u4f7f\u7528\u3059\u308b\u306b\u306f eLevelDB \u3067\u30d0\u30b1\u30c3\u30c8\u306e\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u304c\u8a2d\u5b9a\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u3092\u5fc5\u8981\u3068\u3057\u307e\u3059\n\n## LevelDB Implementation Details\n\nLevelDB \u306f Google \u306e\u652f\u63f4\u3092\u53d7\u3051\u305f\u30aa\u30fc\u30d7\u30f3\u30bd\u30fc\u30b9\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u3067\u3059\nLevelDB \u306f Erlang \u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306b\u7d44\u307f\u5165\u308c\u3089\u308c\u3001Riak \u3067 key/value \u30c7\u30fc\u30bf\u3092\u30c7\u30a3\u30b9\u30af\u306b\u683c\u7d0d\u3059\u308b\u30b9\u30c8\u30ec\u30fc\u30b8\u3068\u306a\u308a\u307e\u3057\u305f\nLevelDB \u306e\u5b9f\u88c5\u306f\u3001BigTable \u3092\u30a4\u30f3\u30b9\u30d1\u30a4\u30a2\u3057\u3066\u3044\u307e\u3059\n\n### How \u201cLevels\u201d Are Managed\n\nLevelDB \u306f memtable/sstable \u30c7\u30b6\u30a4\u30f3\u3067\u3059\n\u30bd\u30fc\u30c8\u3055\u308c\u305f\u30c6\u30fc\u30d6\u30eb\u3078\u306e Set \u306f\u3001\u30ec\u30d9\u30eb\u306e\u30b7\u30fc\u30b1\u30f3\u30b9\u306b\u6574\u7406\u3055\u308c\u307e\u3059\n\u5404\u30ec\u30d9\u30eb\u306f\u3001\u524d\u306e\u30ec\u30d9\u30eb\u306e\u304a\u3088\u305d 10 \u500d\u7a0b\u306e\u30c7\u30fc\u30bf\u3092\u683c\u7d0d\u3057\u307e\u3059\n\u30d5\u30e9\u30c3\u30b7\u30e5\u306b\u3088\u3063\u3066\u751f\u6210\u3055\u308c\u305f\u30bd\u30fc\u30c8\u3055\u308c\u305f\u30c6\u30fc\u30d6\u30eb\u306f\u3001\u7279\u306b\u82e5\u3044\u30ec\u30d9\u30eb (level-0 \u3068\u547c\u3070\u308c\u308b) \u306b\u7f6e\u304b\u308c\u307e\u3059\n\u82e5\u3044\u30d5\u30a1\u30a4\u30eb\u6570\u304c\u3042\u308b\u95be\u5024 (\u73fe\u5728 4) \u3092\u8d85\u3048\u305f\u5834\u5408\u3001\u65b0\u3057\u3044 level-1 \u30d5\u30a1\u30a4\u30eb\u306e\u30b7\u30fc\u30b1\u30f3\u30b9\u3092\u4f5c\u6210\u3059\u308b\u70ba\u306b\u3001\u5168\u3066\u306e\u82e5\u3044\u30d5\u30a1\u30a4\u30eb\u306f level-1 \u306e\u30d5\u30a1\u30a4\u30eb\u3068\u30de\u30fc\u30b8\u3055\u308c\u307e\u3059\n\u65b0\u3057\u3044 level-1 \u306e\u30d5\u30a1\u30a4\u30eb\u306f\u30012MB \u3054\u3068\u306e\u30c7\u30fc\u30bf\u306b\u4f5c\u6210\u3055\u308c\u307e\u3059\n\n\u82e5\u3044 level \u306e\u30d5\u30a1\u30a4\u30eb\u306f\u3001\u91cd\u8907\u3057\u305f\u30ad\u30fc\u3092\u542b\u3093\u3067\u3044\u308b\u304b\u3082\u3057\u308c\u307e\u305b\u3093\n\u3057\u304b\u3057\u306a\u304c\u3089\u3001\u4ed6\u306e levels \u306f\u91cd\u8907\u3057\u306a\u3044 key ranges \u304c\u3042\u308a\u307e\u3059\n1 \u3088\u308a\u3082\u5927\u304d\u3044\u5834\u5408\u306e level \u306e\u6570 'L' \u3092\u8003\u3048\u307e\u3059\nLevel-L \u306e\u30d5\u30a1\u30a4\u30eb\u3092\u7d50\u5408\u3057\u305f\u30b5\u30a4\u30ba\u304c 10^L MB (\u4f8b\u3048\u3070 Level-1 \u306f 10MB, Level-2 \u306f 20\nMB\u2026 \u306e\u3088\u3046\u306b) \u3092\u8d85\u3048\u308b\u5834\u5408\u3001Level-L \u306e\u4e00\u3064\u306e\u30d5\u30a1\u30a4\u30eb\u3068 \u5168\u3066\u306e Level-(L+1) \u306e\u30d5\u30a1\u30a4\u30eb\u3092\u30de\u30fc\u30b8\u3057\u3001\u65b0\u3057\u3044 Level-(L+1) \u306e\u30d5\u30a1\u30a4\u30eb\u30bb\u30c3\u30c8\u3092\u4f5c\u6210\u3057\u307e\u3059\n\u3053\u308c\u3089\u306e\u30de\u30fc\u30b8\u306f\u3001bukl reads \u3068 writes \u3092\u4f7f\u7528\u3059\u308b\u3060\u3051\u3067\u3001\u82e5\u3044 Level \u3092\u6700\u5927\u306e Level \u306b\u5f90\u3005\u306b\u79fb\u884c\u3059\u308b\u52b9\u679c\u304c\u3042\u308a\u307e\u3059\n\nLevel-L \u306e\u30b5\u30a4\u30ba\u304c\u4e0a\u9650\u3092\u8d85\u3048\u308b\u5ea6\u306b\u3001LevelDB \u306f\u30d0\u30c3\u30af\u30b0\u30e9\u30f3\u30c9\u306e\u30b9\u30ec\u30c3\u30c9\u3067\u305d\u308c\u3089\u3092\u5727\u7e2e\u3059\u308b\u3067\u3057\u3087\u3046\nCompaction \u306f\u3001Level-L \u304b\u3089\u30d5\u30a1\u30a4\u30eb\u3092\u53d6\u308a\u3001\u6b21\u306e Level-L+1 \u304b\u3089\u91cd\u8907\u3059\u308b\u30d5\u30a1\u30a4\u30eb\u3092\u5168\u3066\u53d6\u308a\u9664\u304d\u307e\u3059\nLevel-L \u306e\u30d5\u30a1\u30a4\u30eb\u304c\u3001Lebel-L+1 \u306e\u30d5\u30a1\u30a4\u30eb\u306e\u4e00\u90e8\u3060\u3051\u3092\u91cd\u8907\u3057\u3066\u3044\u308b\u5834\u5408\u306f\u6ce8\u610f\u3057\u3066\u304f\u3060\u3055\u3044\nLevel-L+1 \u306e\u30d5\u30a1\u30a4\u30eb\u5168\u4f53\u304c Compaction \u306e\u5165\u529b\u3068\u3057\u3066\u4f7f\u7528\u3055\u308c\u3001Compaction \u5f8c\u306b\u7834\u68c4\u3055\u308c\u308b\u3067\u3057\u3087\u3046\n\nLevel-0 \u306f\u7279\u5225 (Level-0 \u306e\u30d5\u30a1\u30a4\u30eb\u306f\u91cd\u8907\u3057\u3066\u3044\u308b\u304b\u3082\u3057\u308c\u306a\u3044) \u306a\u306e\u3067\u3001Level-0 \u304b\u3089 Level-1 \u3078\u306e Compaction \u306f\u7279\u5225\u306b\u6271\u308f\u308c\u307e\u3059\nLevel-0 \u306e\u30d5\u30a1\u30a4\u30eb\u306e\u3046\u3061\u3044\u304f\u3064\u304b\u304c\u4e92\u3044\u306b\u91cd\u8907\u3057\u305f\u5834\u5408\u3001Level-0 \u306e Compaction \u306f\u4e00\u3064\u3088\u308a\u591a\u304f\u306e Level-0 \u306e\u30d5\u30a1\u30a4\u30eb\u3092\u53d6\u308a\u9664\u304f\u304b\u3082\u3057\u308c\u307e\u305b\u3093\n\nCompaction \u306f\u3001Level-L+1 \u30d5\u30a1\u30a4\u30eb\u306e\u30b7\u30fc\u30b1\u30f3\u30b9\u3092\u751f\u6210\u3059\u308b\u70ba\u306b\u3001\u53d6\u3063\u305f\u30d5\u30a1\u30a4\u30eb\u306e\u5185\u5bb9\u3092\u30de\u30fc\u30b8\u3057\u307e\u3059\nLevelDB \u306f\u3001\u73fe\u5728\u306e output \u30d5\u30a1\u30a4\u30eb\u304c\u5bfe\u8c61\u306e\u30d5\u30a1\u30a4\u30eb\u30b5\u30a4\u30ba (2MB) \u306b\u9054\u3057\u305f\u5f8c\u306b\u3001\u65b0\u3057\u3044 Level-L+1 \u30d5\u30a1\u30a4\u30eb\u3092\u751f\u6210\u3059\u308b\u3088\u3046\u5207\u308a\u66ff\u308f\u308a\u307e\u3059\n\u73fe\u5728\u306e\u51fa\u529b\u30d5\u30a1\u30a4\u30eb\u306e\u30ad\u30fc\u7bc4\u56f2\u304c\u3001ten 'level-(L+2)' \u30d5\u30a1\u30a4\u30eb\u3088\u308a\u5341\u5206\u306b\u5897\u3048\u305f\u5834\u5408\u306b\u3001LevelDB \u306f\u65b0\u3057\u3044\u51fa\u529b\u30d5\u30a1\u30a4\u30eb\u306b\u5207\u308a\u8fd4\u3048\u307e\u3059\n\u3053\u306e\u6700\u5f8c\u306e\u30eb\u30fc\u30eb\u306f\u3001Level-L+1 \u3067\u884c\u3063\u305f Compaction \u306e\u5f8c\u3067\u306f\u3001Level-L+2 \u304b\u3089\u30c7\u30fc\u30bf\u3092\u3042\u307e\u308a\u53d6\u308a\u9664\u304b\u306a\u3044\u3067\u3057\u3087\u3046\n\n\u5404 Level \u3078\u306e Compaction \u306f\u3001\u30ad\u30fc\u7a7a\u9593\u3092\u901a\u3057\u3066\u56de\u8ee2\u3057\u307e\u3059\n\u3088\u308a\u8a73\u7d30\u3092\u8ff0\u3079\u308b\u3068\u3001\u5404 Level-L \u306b\u304a\u3044\u3066\u3001\u6700\u5f8c\u306b Level-L \u3067\u5b9f\u65bd\u3057\u305f Compaction \u304c\u7d42\u4e86\u3057\u305f\u30ad\u30fc\u3092\u8a18\u9332\u3057\u3066\u3044\u307e\u3059\nLevel-L \u306b\u5bfe\u3059\u308b\u6b21\u306e Compaction \u3067\u306f\u3001\u3053\u306e\u8a18\u9332\u3057\u305f\u30ad\u30fc\u306e\u5f8c\u306b\u6700\u521d\u306b\u306f\u3058\u307e\u308b\u30d5\u30a1\u30a4\u30eb\u3092\u53d6\u308b\u3067\u3057\u3087\u3046\n\u3082\u3057\u30d5\u30a1\u30a4\u30eb\u304c\u7121\u3044\u5834\u5408\u3001\u30ad\u30fc\u7a7a\u9593\u306e\u6700\u521d\u306b\u623b\u308a\u307e\u3059\n\nLevel-0 \u306e Compaction \u306f\u3001Level-0 \u304b\u3089 4 \u500b\u306e 1MB \u306e\u30d5\u30a1\u30a4\u30eb\u3092\u8aad\u3080\u3067\u3057\u3087\u3046\n\u3055\u3089\u306b\u6700\u60aa\u306e\u30b1\u30fc\u30b9\u3067 Level-1 \u306e\u5168\u3066\u306e\u30d5\u30a1\u30a4\u30eb (10MB) \u3092\u8aad\u307f\u307e\u3059\n\u3064\u307e\u308a\u3001\u3053\u306e\u5834\u5408\u306f LevelDB \u306f 14MB \u8aad\u307f\u8fbc\u307f\u300114MB \u66f8\u304d\u8fbc\u3080\u3067\u3057\u3087\u3046\n\nLevel-0 \u306e\u7279\u5225\u306a Compaction \u4ee5\u5916\u306b\u304a\u3044\u3066\u306f\u3001LevelDB \u306f Level-L \u304b\u30892MB \u306e\u30d5\u30a1\u30a4\u30eb\u3092 1\u500b\u3068\u308b\u3067\u3057\u3087\u3046\n\u6700\u60aa\u306e\u30b1\u30fc\u30b9\u306b\u304a\u3044\u3066\u306f\u3001Level-L+1 \u304b\u3089\u3001\u304a\u3088\u305d 12 \u500b\u306e\u30d5\u30a1\u30a4\u30eb\u3092\u91cd\u8907\u3057\u3066\u3044\u308b\u3067\u3057\u3087\u3046\n(10 because level-(L+1) is ten times the size of level-L, and another two at the boundaries since the file ranges at level-L will usually not be aligned with the file ranges at level-L+1).\n\u5f93\u3063\u3066\u3001Compaction \u306f 26MB (= 2MB *1 + 2MB * 12) \u8aad\u307f\u8fbc\u307f\u300126MB \u66f8\u304d\u8fbc\u3080\u3067\u3057\u3087\u3046\n\u4eee\u306b 100MB/s \u306e\u30c7\u30a3\u30b9\u30af I/O \u30ec\u30fc\u30c8\u3068\u4eee\u5b9a\u3059\u308b\u3068\u3001\u6700\u60aa\u306e\u30b1\u30fc\u30b9\u306b\u304a\u3051\u308b Compaction \u30b3\u30b9\u30c8\u306f\u304a\u3088\u305d 0.5 \u79d2\u306b\u306a\u308b\u3067\u3057\u3087\u3046\n\n\u610f\u56f3\u7684\u306b\u9045\u304f\u3057\u305f\u5834\u5408\u306b\u3064\u3044\u3066\u306a\u306e\u3067\u7701\u7565:\nIf we throttle the background writing to a reasonably slow rate, for instance 10% of the full 100MB/s speed, a compaction may take up to 5 seconds. If the user is writing at 10MB/s, LevelDB might build up lots of level-0 files (~50 to hold the 5*10MB). This may significantly increase the cost of reads due to the overhead of merging more files together on every read.\n\n### Compaction\n\nLevels are compacted into ordered data files over time. \nCompaction first computes a score for each level as the ratio of bytes in that level to desired bytes.\nFor level 0, it computes files / desired files instead. \n\u6700\u3082\u9ad8\u3044\u30b9\u30b3\u30a2\u306e\u30ec\u30d9\u30eb\u304c Compaction \u3055\u308c\u307e\u3059\n\nLevel-0 \u3092 Compaction \u3059\u308b\u5834\u5408\u306b\u8003\u616e\u3059\u308b\u305f\u3060\u4e00\u3064\u306e\u7279\u5225\u306a\u30b1\u30fc\u30b9\u306f\u3001that after picking the primary L0 file to compact, it will check other L0 files to determine the degree to which they overlap. \n\u3053\u308c\u306f\u3001\u3044\u304f\u3064\u304b\u306e I/O \u3092\u56de\u907f\u3059\u308b\u8a66\u307f\u3067\u3001we can expect L0 compactions to usually if not always be \u201call L0 files\u201d.\nSee the PickCompaction routine in 1 for all the details.\n\n### Comparison of eLevelDB and Bitcask\n\nLevelDB \u306f\u6301\u7d9a\u7684\u306b\u9806\u5e8f\u3065\u3051\u3089\u308c\u305f Map \u3067\u3059\nBitcask \u306f\u6301\u7d9a\u7684\u306a Hash \u30c6\u30fc\u30d6\u30eb\u3067\u3001\u9806\u5e8f\u3065\u3051\u3089\u308c\u3066\u3044\u307e\u305b\u3093\nBitcask \u306f\u30e1\u30e2\u30ea\u30fc\u306b\u30ad\u30fc\u3092\u683c\u7d0d\u3057\u307e\u3059\n\u5f93\u3063\u3066\u3001\u591a\u6570\u306e\u30ad\u30fc\u304c\u3042\u308b DB \u306b\u304a\u3044\u3066\u306f\u3001\u5229\u7528\u53ef\u80fd\u306a\u30e1\u30e2\u30ea\u30fc\u3092\u4f7f\u3044\u679c\u305f\u3057\u3001\u4eee\u60f3\u30e1\u30e2\u30ea\u3092\u4f7f\u7528\u3059\u308b\u3053\u3068\u3067\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u52a3\u5316\u3092\u5f15\u304d\u8d77\u3053\u3059\u304b\u3082\u3057\u308c\u307e\u305b\u3093\n\nBitcask \u306f \u4e00\u3064\u306e\u691c\u7d22\u306b\u304b\u304b\u308b\u30c7\u30a3\u30b9\u30af\u30b7\u30fc\u30af\u306f 1 \u56de\u3067\u3042\u308b\u3053\u3068\u3092\u4fdd\u8a3c\u3057\u307e\u3059\nLevelDB \u306f\u5c11\u6570\u306e\u30c7\u30a3\u30b9\u30af\u30b7\u30fc\u30af\u304c\u5fc5\u8981\u3068\u3059\u308b\u304b\u3082\u3057\u308c\u307e\u305b\u3093\n\u4f8b\u3048\u3070\u3001\u8aad\u307f\u8fbc\u307f\u306f\u30ec\u30d9\u30eb\u6bce\u306b\u4e00\u56de\u306e\u30c7\u30a3\u30b9\u30af\u30b7\u30fc\u30af\u304c\u5fc5\u8981\u3068\u306a\u308a\u307e\u3059\n\u3082\u3057\u30e1\u30e2\u30ea\u30fc\u306b\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306e 10% \u304c\u683c\u7d0d\u3055\u308c\u3066\u3044\u308b\u5834\u5408\u3001LevelDB \u306f\u4e00\u56de\u306e\u30c7\u30a3\u30b9\u30af\u30b7\u30fc\u30af\u304c\u5fc5\u8981\u306b\u306a\u308b\u3067\u3057\u3087\u3046\n(for the last level since all of the earlier levels should end up cached in the OS buffer cache)\n\u30e1\u30e2\u30ea\u30fc\u306b\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306e 1% \u304c\u683c\u7d0d\u3055\u308c\u3066\u3044\u308b\u5834\u5408\u3001LevelDB \u306f\u4e8c\u56de\u306e\u30c7\u30a3\u30b9\u30af\u30b7\u30fc\u30af\u304c\u5fc5\u8981\u306b\u306a\u308b\u3067\u3057\u3087\u3046\n\n## Recovery\n\nLevelDB never writes in place: \nLevelDB \u306f\u5e38\u306b\u30ed\u30b0\u30d5\u30a1\u30a4\u30eb\u306b\u8ffd\u8a18\u3059\u308b\u304b\u3001\u307e\u305f\u306f\u65b0\u3057\u3044\u30ed\u30b0\u30d5\u30a1\u30a4\u30eb\u3092\u751f\u6210\u3059\u308b\u70ba\u306b\u65e2\u5b58\u306e\u30d5\u30a1\u30a4\u30eb\u3068\u30de\u30fc\u30b8\u3057\u307e\u3059\n\u3057\u305f\u304c\u3063\u3066 OS \u304c\u30af\u30e9\u30c3\u30b7\u30e5\u3059\u308b\u3068\u3001\u4e0d\u5341\u5206\u306a\u66f8\u8fbc\u307f\u304c\u30ed\u30b0\u306b\u8a18\u9332\u3055\u308c\u308b\u3067\u3057\u3087\u3046\nLevelDB \u306e\u30ea\u30ab\u30d0\u30ea\u30fc\u51e6\u7406\u306f\u3001checksums \u3092\u4f7f\u7528\u3057\u3066\u4e0d\u5b8c\u5168\u306a\u30ec\u30b3\u30fc\u30c9\u3092\u691c\u77e5\u3057\u3001\u305d\u308c\u3092\u30b9\u30ad\u30c3\u30d7\u3059\u308b\u3067\u3057\u3087\u3046\n\n### eLevelDB Database Files\n\nBelow there are two directory listings showing what you would expect to find on disk when using eLevelDB. \n\u3053\u306e\u4f8b\u306e\u5834\u5408\u300164 \u500b\u306e\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u30ea\u30f3\u30b0\u3092 64 \u500b\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3067\u8868\u3057\u307e\u3059\n\n```\nleveldb/\n|-- 0\n|   |-- 000003.log\n|   |-- CURRENT\n|   |-- LOCK\n|   |-- LOG\n|   `-- MANIFEST-000002\n|-- 1004782375664995756265033322492444576013453623296\n|   |-- 000005.log\n|   |-- CURRENT\n|   |-- LOCK\n|   |-- LOG\n|   |-- LOG.old\n|   `-- MANIFEST-000004\n|-- 1027618338748291114361965898003636498195577569280\n|   |-- 000005.log\n|   |-- CURRENT\n|   |-- LOCK\n|   |-- LOG\n|   |-- LOG.old\n|   `-- MANIFEST-000004\n\n... etc ...\n\n`-- 981946412581700398168100746981252653831329677312\n    |-- 000005.log\n    |-- CURRENT\n    |-- LOCK\n    |-- LOG\n    |-- LOG.old\n    `-- MANIFEST-000004\n\n64 directories, 378 files\n```\n\n\u591a\u6570\u306e put (write) \u30aa\u30da\u30ec\u30fc\u30b7\u30e7\u30f3\u3092\u884c\u3046\u3068\u3001eLevelDB \u3067\u52d5\u4f5c\u3057\u3066\u3044\u308b Riak \u30af\u30e9\u30b9\u30bf\u306f\u6b21\u306e\u3088\u3046\u306b\u898b\u3048\u308b\u3067\u3057\u3087\u3046\n\n```\ngburd@toe:~/Projects/riak/dev/dev1/data$ tree leveldb/\nleveldb/\n|-- 0\n|   |-- 000118.sst\n|   |-- 000119.sst\n|   |-- 000120.sst\n|   |-- 000121.sst\n|   |-- 000123.sst\n|   |-- 000126.sst\n|   |-- 000127.log\n|   |-- CURRENT\n|   |-- LOCK\n|   |-- LOG\n|   |-- LOG.old\n|   `-- MANIFEST-000125\n|-- 1004782375664995756265033322492444576013453623296\n|   |-- 000120.sst\n|   |-- 000121.sst\n|   |-- 000122.sst\n|   |-- 000123.sst\n|   |-- 000125.sst\n|   |-- 000128.sst\n|   |-- 000129.log\n|   |-- CURRENT\n|   |-- LOCK\n|   |-- LOG\n|   |-- LOG.old\n|   `-- MANIFEST-000127\n|-- 1027618338748291114361965898003636498195577569280\n|   |-- 000003.log\n|   |-- CURRENT\n|   |-- LOCK\n|   |-- LOG\n|   `-- MANIFEST-000002\n\n... etc ...\n\n`-- 981946412581700398168100746981252653831329677312\n    |-- 000003.log\n    |-- CURRENT\n    |-- LOCK\n    |-- LOG\n    `-- MANIFEST-000002\n\n64 directories, 433 files\n```\n\n## \u95a2\u9023\n\nhttp://dayafterneet.blogspot.jp/2011/05/google-snappy.html", "tags": ["riak"]}