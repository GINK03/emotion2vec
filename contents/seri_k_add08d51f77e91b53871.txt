{"context": "\n\n\u3084\u308a\u305f\u304b\u3063\u305f\u3053\u3068\n\nBigQuery\u3067\u3001\u7247\u65b9\u306edataset\u3092\u6b63\u3068\u3057\u3066\n\n\n\u3068\u3042\u308bdataset\u306b\u542b\u307e\u308c\u308b\u5168\u3066\u306e\u30c6\u30fc\u30d6\u30eb\u4e00\u89a7\u3068\u5225\u306edataset\u306e\u30c6\u30fc\u30d6\u30eb\u4e00\u89a7\u3068\u306e\u5dee\u5206\u3092\u307e\u3068\u3081\u3066\u53d6\u308a\u305f\u3044\nfield\u306e\u5b9a\u7fa9\u304c\u7570\u306a\u308b\u3082\u306e\u306b\u3064\u3044\u3066\u3082\u500b\u5225\u306b\u53d6\u308a\u305f\u3044\n\n\n\n\n\u3067\u304d\u3042\u304c\u3063\u305f\u3082\u306e\u304c\u3053\u3061\u3089\u306b\u306a\u308a\u307e\u3059\n#!/usr/bin/env ruby\nrequire 'json'\nrequire 'open3'\n\nbase_dataset_name = 'base_dataset_name'\ncompare_dataset_name = 'compare_dataset_name'\n\nbase_bq_tables = JSON.parse(Open3.capture3(\"bq -n 1000000 ls --format=json #{base_dataset_name}\")[0].gsub(/(^\"|\"$)/, ''))\ncompare_bq_tables = JSON.parse(Open3.capture3(\"bq -n 1000000 ls --format=json #{compare_dataset_name}\")[0].gsub(/(^\"|\"$)/, ''))\n\nnot_existing_tables = []\nnot_equal_fields = {}\n\nbase_bq_tables.each do |base_bq_table|\n  table_exists = compare_bq_tables.any? { |t| t['tableId'] == base_bq_table['tableId'] }\n  if table_exists\n    base_bq_table_schemas = JSON.parse(Open3.capture3(\"bq show --format=json #{base_dataset_name}.#{base_bq_table['tableId']}\")[0].gsub(/(^\"|\"$)/, ''))\n    compare_bq_table_schemas = JSON.parse(Open3.capture3(\"bq show --format=json #{compare_dataset_name}.#{base_bq_table['tableId']}\")[0].gsub(/(^\"|\"$)/, ''))\n\n    base_bq_table_schemas['schema']['fields'].each do |field|\n      field_equals = compare_bq_table_schemas['schema']['fields'].any? { |f| f == field }\n      unless field_equals\n        not_equal_fields[base_bq_table['tableId']] ||= []\n        not_equal_fields[base_bq_table['tableId']] << {\n          'base' => field,\n          'compare' => compare_bq_table_schemas['schema']['fields'].find { |f| f['name'] == field['name'] } || 'nothing'\n        }\n      end\n    end\n  else\n    not_existing_tables << base_bq_table['tableId']\n  end\nend\n\nputs '***not_existing_tables***'\nputs not_existing_tables\nputs '***not_equal_field***'\nputs not_equal_fields\n\n# \u3084\u308a\u305f\u304b\u3063\u305f\u3053\u3068\n- BigQuery\u3067\u3001\u7247\u65b9\u306edataset\u3092\u6b63\u3068\u3057\u3066\n    - \u3068\u3042\u308bdataset\u306b\u542b\u307e\u308c\u308b\u5168\u3066\u306e\u30c6\u30fc\u30d6\u30eb\u4e00\u89a7\u3068\u5225\u306edataset\u306e\u30c6\u30fc\u30d6\u30eb\u4e00\u89a7\u3068\u306e\u5dee\u5206\u3092\u307e\u3068\u3081\u3066\u53d6\u308a\u305f\u3044\n    - field\u306e\u5b9a\u7fa9\u304c\u7570\u306a\u308b\u3082\u306e\u306b\u3064\u3044\u3066\u3082\u500b\u5225\u306b\u53d6\u308a\u305f\u3044\n\n# \u3067\u304d\u3042\u304c\u3063\u305f\u3082\u306e\u304c\u3053\u3061\u3089\u306b\u306a\u308a\u307e\u3059\n\n```rb\n#!/usr/bin/env ruby\nrequire 'json'\nrequire 'open3'\n\nbase_dataset_name = 'base_dataset_name'\ncompare_dataset_name = 'compare_dataset_name'\n\nbase_bq_tables = JSON.parse(Open3.capture3(\"bq -n 1000000 ls --format=json #{base_dataset_name}\")[0].gsub(/(^\"|\"$)/, ''))\ncompare_bq_tables = JSON.parse(Open3.capture3(\"bq -n 1000000 ls --format=json #{compare_dataset_name}\")[0].gsub(/(^\"|\"$)/, ''))\n\nnot_existing_tables = []\nnot_equal_fields = {}\n\nbase_bq_tables.each do |base_bq_table|\n  table_exists = compare_bq_tables.any? { |t| t['tableId'] == base_bq_table['tableId'] }\n  if table_exists\n    base_bq_table_schemas = JSON.parse(Open3.capture3(\"bq show --format=json #{base_dataset_name}.#{base_bq_table['tableId']}\")[0].gsub(/(^\"|\"$)/, ''))\n    compare_bq_table_schemas = JSON.parse(Open3.capture3(\"bq show --format=json #{compare_dataset_name}.#{base_bq_table['tableId']}\")[0].gsub(/(^\"|\"$)/, ''))\n\n    base_bq_table_schemas['schema']['fields'].each do |field|\n      field_equals = compare_bq_table_schemas['schema']['fields'].any? { |f| f == field }\n      unless field_equals\n        not_equal_fields[base_bq_table['tableId']] ||= []\n        not_equal_fields[base_bq_table['tableId']] << {\n\t      'base' => field,\n\t      'compare' => compare_bq_table_schemas['schema']['fields'].find { |f| f['name'] == field['name'] } || 'nothing'\n\t    }\n      end\n    end\n  else\n    not_existing_tables << base_bq_table['tableId']\n  end\nend\n\nputs '***not_existing_tables***'\nputs not_existing_tables\nputs '***not_equal_field***'\nputs not_equal_fields\n```\n", "tags": ["bigquery"]}