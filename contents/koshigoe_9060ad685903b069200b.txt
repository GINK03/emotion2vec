{"context": " More than 1 year has passed since last update.\n\n\u306f\u3058\u3081\u306b\n\u3068\u3042\u308b\u76ee\u7684\u306e\u305f\u3081\u3001\u4eca\u66f4\u306a\u304c\u3089 vsftpd \u306e\u30d0\u30fc\u30c1\u30e3\u30eb\u30e6\u30fc\u30b6\u3092\u8a66\u3057\u307e\u3059\u3002\n\u30b5\u30fc\u30d0\u74b0\u5883\u306f AWS - ELB\u306f\u306a\u3093\u3067\u3082\u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b9\u3067\u304d\u308b\u3068\u805e\u3044\u305f\u306e\u3067FTP\u3057\u3066\u307f\u308b \u306b\u3066\u4f5c\u6210\u3057\u305f\u3082\u306e\u3092\u4f7f\u7528\u3057\u307e\u3059\u3002\n\npam_userdb (Berkeley DB)\n\n\u30e6\u30fc\u30b6\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u3092\u4f5c\u308b\n$ cat <<EOF > vsftpd-virtual-user.txt\nuser1\npassword1\nuser2\npassword2\nEOF\n$ sudo db_load -T -t hash -f vsftpd-virtual-user.txt /etc/vsftpd/vsftpd-virtual-user.db\n\n\nvsftpd \u306e\u8a2d\u5b9a\n$ sudo cp /etc/vsftpd/vsftpd.conf /etc/vsftpd/vsftpd.conf.orig\n$ sudo vi /etc/vsftpd/vsftpd.conf\n$ sudo diff -u /etc/vsftpd/vsftpd.conf.orig /etc/vsftpd/vsftpd.conf\n--- /etc/vsftpd/vsftpd.conf.orig        2015-09-18 15:43:58.131379615 +0000\n+++ /etc/vsftpd/vsftpd.conf     2015-09-19 02:20:40.951605554 +0000\n@@ -114,7 +114,7 @@\n # Make sure, that one of the listen options is commented !!\n #listen_ipv6=YES\n\n-pam_service_name=vsftpd\n+pam_service_name=vsftpd.virtual\n userlist_enable=YES\n tcp_wrappers=NO\n\n@@ -125,3 +125,16 @@\n pasv_max_port=60010\n use_localtime=YES\n force_dot_files=YES\n+\n+guest_enable=YES\n+guest_username=ftp-test\n+user_sub_token=$USER\n+local_root=/home/ftp-test/$USER\n+hide_ids=YES\n+anon_upload_enable=YES\n+anon_mkdir_write_enable=YES\n+anon_other_write_enable=YES\n+anon_world_readable_only=NO\n+anon_umask=022\n+virtual_use_local_privs=YES\n+\n\n\nPAM\n$ cat <<EOF | sudo tee /etc/pam.d/vsftpd.virtual\n#%PAM-1.0\nauth       required     pam_userdb.so db=/etc/vsftpd/vsftpd-virtual-user\naccount    required     pam_userdb.so db=/etc/vsftpd/vsftpd-virtual-user\nsession    required     pam_loginuid.so\nEOF\n\n\nchroot \u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u4f5c\u6210\n$ sudo install -d -o ftp-test -g ftp-test /home/ftp-test/{user1,user2}\n\n\nvsftpd \u3092\u518d\u8d77\u52d5\n$ sudo /sbin/service vsftpd restart\n\n\n\u63a5\u7d9a\u78ba\u8a8d\n$ ftp user1@52.69.XXX.YYY\nConnected to 52.69.XXX.YYY.\n220 (vsFTPd 2.2.2)\n331 Please specify the password.\nPassword:\n230 Login successful.\nRemote system type is UNIX.\nUsing binary mode to transfer files.\nftp> ls\n229 Entering Extended Passive Mode (|||60008|).\n150 Here comes the directory listing.\n226 Directory send OK.\nftp> ls -al\n229 Entering Extended Passive Mode (|||60003|).\n150 Here comes the directory listing.\ndrwxr-xr-x    2 ftp      ftp          4096 Sep 19 02:24 .\ndrwxr-xr-x    2 ftp      ftp          4096 Sep 19 02:24 ..\n226 Directory send OK.\nftp> put ~/test.txt ./test.txt\nlocal: /Users/koshigoe/test.txt remote: ./test.txt\n229 Entering Extended Passive Mode (|||60010|).\n150 Ok to send data.\n100% |****************************************************************************************************************************|     5       53.65 KiB/s    00:00 ETA\n226 Transfer complete.\n5 bytes sent in 00:00 (0.15 KiB/s)\n\n\n\u30e6\u30fc\u30b6\u3092\u8ffd\u52a0\u3059\u308b\n$ cat <<EOF >> vsftpd-virtual-user.txt\nuser3\npassword3\nEOF\n$ sudo install -d -o ftp-test -g ftp-test /home/ftp-test/user3\n$ sudo db_load -T -t hash -f vsftpd-virtual-user.txt /etc/vsftpd/vsftpd-virtual-user.db\n\n$ ftp user3@52.69.XXX.YYY\nConnected to 52.69.XXX.YYY.\n220 (vsFTPd 2.2.2)\n331 Please specify the password.\nPassword:\n230 Login successful.\nRemote system type is UNIX.\nUsing binary mode to transfer files.\nftp> ls -al\n229 Entering Extended Passive Mode (|||60001|).\n150 Here comes the directory listing.\ndrwxr-xr-x    2 ftp      ftp          4096 Sep 19 02:36 .\ndrwxr-xr-x    2 ftp      ftp          4096 Sep 19 02:36 ..\n226 Directory send OK.\nftp> put ~/test.txt ./test.txt\nlocal: /Users/koshigoe/test.txt remote: ./test.txt\n229 Entering Extended Passive Mode (|||60010|).\n150 Ok to send data.\n100% |****************************************************************************************************************************|     5       32.33 KiB/s    00:00 ETA\n226 Transfer complete.\n5 bytes sent in 00:00 (0.15 KiB/s)\n\n\n\u307e\u3068\u3081\n\nchroot \u7528\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306f\u30e6\u30fc\u30b6\u3054\u3068\u306b\u4e8b\u524d\u306b\u4f5c\u6210\u3057\u3066\u304a\u304f\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\nchroot \u7528\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306e\u30d1\u30fc\u30df\u30c3\u30b7\u30e7\u30f3\u306f guest_username \u3067\u6307\u5b9a\u3057\u305f\u30e6\u30fc\u30b6\u306b\u5bfe\u5fdc\u3055\u305b\u307e\u3059\nFTP \u30a2\u30ab\u30a6\u30f3\u30c8\u306e\u8ffd\u52a0\u306f\u30e6\u30fc\u30b6\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u3092\u66f4\u65b0\u3059\u308b\u3060\u3051\u3067\u3088\u304f\u3001vsftpd \u306e\u518d\u8d77\u52d5\u306f\u4e0d\u8981\u3067\u3057\u305f\n\n\n\u6c17\u306b\u306a\u308b\n\n\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u304c\u30ed\u30fc\u30ab\u30eb\u306b\u3042\u308b\u30d5\u30a1\u30a4\u30eb\u306a\u3042\u305f\u308a\n\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u66f4\u65b0\u30bf\u30a4\u30df\u30f3\u30b0\u3067\u77ac\u65ad(\u30a8\u30e9\u30fc)\u304c\u767a\u751f\u3059\u308b\u306e\u304b\n\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u3092 NFS \u306a\u3069\u3067\u5171\u6709\u3067\u304d\u305f\u3068\u3057\u3066\u7af6\u5408\u306a\u3069\u306f\u767a\u751f\u3059\u308b\u306e\u304b\n\n\npam_mysql (MySQL)\n\nMySQL \u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n$ sudo yum install -y mysql mysql-server\n$ sudo chkconfig mysqld on\n$ sudo chkconfig --list mysqld\nmysqld          0:off   1:off   2:on    3:on    4:on    5:on    6:off\n$ sudo /sbin/service mysqld start\n\n\npam_mysql \u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n$ sudo yum install --enablerepo=epel -y pam_mysql\n\n\n\u30e6\u30fc\u30b6\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u4f5c\u6210\nmysql> CREATE DATABASE ftpusers;\nQuery OK, 1 row affected (0.00 sec)\n\nmysql> GRANT SELECT, INSERT, UPDATE, DELETE, CREATE, DROP, INDEX, ALTER on ftpusers.* to ftpuser@localhost identified by '12345';\nQuery OK, 0 rows affected (0.00 sec)\n\nmysql> USE ftpusers;\nDatabase changed\nmysql> CREATE TABLE users(\n    ->     id INT AUTO_INCREMENT NOT NULL,\n    ->     name CHAR(128) binary NOT NULL,\n    ->     passwd CHAR(128) binary NOT NULL,\n    ->     primary KEY(id)\n    -> );\nQuery OK, 0 rows affected (0.01 sec)\n\nmysql> CREATE TABLE logs (\n    ->     msg VARCHAR(255),\n    ->     user CHAR(128),\n    ->     pid INT,\n    ->     host CHAR(128),\n    ->     rhost CHAR(128),\n    ->     logtime TIMESTAMP\n    -> );\nQuery OK, 0 rows affected (0.01 sec)\n\n\nPAM\n$ cat <<EOF | sudo tee /etc/pam.d/vsftpd.mysql\nauth       required     /lib64/security/pam_mysql.so user=ftpuser passwd=12345 host=localhost db=ftpusers table=users usercolumn=name passwdcolumn=passwd crypt=2 use_323_passwd=false sqllog=1 logtable=logs logmsgcolumn=msg logusercolumn=user logpidcolumn=pid loghostcolumn=host logrhostcolumn=rhost logtimecolumn=logtime\naccount    required     /lib64/security/pam_mysql.so user=ftpuser passwd=12345 host=localhost db=ftpusers table=users usercolumn=name passwdcolumn=passwd crypt=2 use_323_passwd=false sqllog=1 logtable=logs logmsgcolumn=msg logusercolumn=user logpidcolumn=pid loghostcolumn=host logrhostcolumn=rhost logtimecolumn=logtime\nEOF\n\n\nvsftpd.conf\n$ sudo cp /etc/vsftpd/vsftpd.conf /etc/vsftpd/vsftpd.conf.userdb\n$ sudo vi /etc/vsftpd/vsftpd.conf\n$ sudo diff -u /etc/vsftpd/vsftpd.conf.userdb /etc/vsftpd/vsftpd.conf\n--- /etc/vsftpd/vsftpd.conf.userdb      2015-09-19 02:56:18.477864224 +0000\n+++ /etc/vsftpd/vsftpd.conf     2015-09-19 03:08:23.835013951 +0000\n@@ -114,7 +114,7 @@\n # Make sure, that one of the listen options is commented !!\n #listen_ipv6=YES\n\n-pam_service_name=vsftpd.virtual\n+pam_service_name=vsftpd.mysql\n userlist_enable=YES\n tcp_wrappers=NO\n\n\n\nFTP \u30a2\u30ab\u30a6\u30f3\u30c8\u8ffd\u52a0\n$ mysql -u ftpuser -p\nmysql> USE ftpusers;\n\nDatabase changed\nmysql> INSERT INTO users (name,passwd) VALUES('user4', PASSWORD('password4'));\nQuery OK, 1 row affected (0.00 sec)\n\n\nchroot \u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u4f5c\u6210\n$ sudo install -d -o ftp-test -g ftp-test /home/ftp-test/user4\n\n\nvsftpd \u3092\u518d\u8d77\u52d5\n$ sudo /sbin/service vsftpd restart\n\n\n\u63a5\u7d9a\u78ba\u8a8d\n$ ftp user4@52.69.XXX.YYY\nConnected to 52.69.XXX.YYY.\n220 (vsFTPd 2.2.2)\n331 Please specify the password.\nPassword:\n230 Login successful.\nRemote system type is UNIX.\nUsing binary mode to transfer files.\nftp> ls -la\n229 Entering Extended Passive Mode (|||60005|).\n150 Here comes the directory listing.\ndrwxr-xr-x    2 ftp      ftp          4096 Sep 19 03:12 .\ndrwxr-xr-x    2 ftp      ftp          4096 Sep 19 03:12 ..\n226 Directory send OK.\nftp> put ~/test.txt ./test.txt\nlocal: /Users/koshigoe/test.txt remote: ./test.txt\n229 Entering Extended Passive Mode (|||60005|).\n150 Ok to send data.\n100% |****************************************************************************************************************************|     5       22.60 KiB/s    00:00 ETA\n226 Transfer complete.\n5 bytes sent in 00:00 (0.14 KiB/s)\n\n\n\u307e\u3068\u3081\n\npam \u7528\u306b\u30e6\u30fc\u30b6\u3068\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u3068\u30c6\u30fc\u30d6\u30eb\u3092\u7528\u610f\u3059\u308c\u3070\u5229\u7528\u3067\u304d\u307e\u3059\n\n\n\u6c17\u306b\u306a\u308b\n\npam_mysql \u304c mysql51-libs \u306b\u4f9d\u5b58\u3057\u3066\u3044\u305f\u70b9\npam_mysql \u306e\u8a2d\u5b9a\u306b MySQL \u3078\u306e\u63a5\u7d9a\u60c5\u5831\u3092\u57cb\u3081\u8fbc\u3080\u3042\u305f\u308a\nchroot \u7528\u306b\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u90fd\u5ea6\u4f5c\u308b\u3042\u305f\u308a\n\n\n\u307e\u3068\u3081\n\n\u30a2\u30ab\u30a6\u30f3\u30c8\u306e\u8ffd\u52a0\u3092\u52d5\u7684\u306b\u884c\u3048\u308b\u3053\u3068\u306f\u5206\u304b\u308a\u307e\u3057\u305f\nchroot \u7528\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u4e8b\u524d\u306b\u7528\u610f\u305b\u305a\u306b\u6e08\u307e\u305b\u3089\u308c\u308b\u306e\u304b\u77e5\u308a\u305f\u3044\u3068\u3053\u308d\u3067\u3059\nLDAP \u307e\u3067\u8e0f\u307f\u8fbc\u3082\u3046\u304b\u8ff7\u3044\u307e\u3057\u305f\u304c\u3001LDAP \u306e\u77e5\u8b58\u304c\u30bc\u30ed\u3067\u3042\u308b\u305f\u3081\u5148\u9001\u308a\u306b\u3057\u307e\u3057\u305f\n\n\n\u53c2\u8003\n\n\u3010linux\u3011vsftpd \u5c0e\u5165\u624b\u9806\uff08\u30d0\u30fc\u30c1\u30e3\u30eb\u30e6\u30fc\u30b6\u30fc\u7248\uff09 at softel\u30e1\u30e2\nVsftpd FTP Server With Virtual Users ( Berkeley DB + PAM )\n[CentOS6.x]vsftpd+MySQL\u3067\u30d0\u30fc\u30c1\u30e3\u30eb\u30e6\u30fc\u30b6\u904b\u7528 | \u3054\u3063\u305f\u716e - tips about programming and building a server\n\n\u306f\u3058\u3081\u306b\n----\n\n\u3068\u3042\u308b\u76ee\u7684\u306e\u305f\u3081\u3001\u4eca\u66f4\u306a\u304c\u3089 vsftpd \u306e\u30d0\u30fc\u30c1\u30e3\u30eb\u30e6\u30fc\u30b6\u3092\u8a66\u3057\u307e\u3059\u3002\n\u30b5\u30fc\u30d0\u74b0\u5883\u306f [AWS - ELB\u306f\u306a\u3093\u3067\u3082\u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b9\u3067\u304d\u308b\u3068\u805e\u3044\u305f\u306e\u3067FTP\u3057\u3066\u307f\u308b](http://qiita.com/koshigoe/items/7e4e9466e821df547192) \u306b\u3066\u4f5c\u6210\u3057\u305f\u3082\u306e\u3092\u4f7f\u7528\u3057\u307e\u3059\u3002\n\n\npam_userdb (Berkeley DB)\n----\n\n### \u30e6\u30fc\u30b6\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u3092\u4f5c\u308b\n\n```\n$ cat <<EOF > vsftpd-virtual-user.txt\nuser1\npassword1\nuser2\npassword2\nEOF\n$ sudo db_load -T -t hash -f vsftpd-virtual-user.txt /etc/vsftpd/vsftpd-virtual-user.db\n```\n\n### vsftpd \u306e\u8a2d\u5b9a\n\n```\n$ sudo cp /etc/vsftpd/vsftpd.conf /etc/vsftpd/vsftpd.conf.orig\n$ sudo vi /etc/vsftpd/vsftpd.conf\n$ sudo diff -u /etc/vsftpd/vsftpd.conf.orig /etc/vsftpd/vsftpd.conf\n--- /etc/vsftpd/vsftpd.conf.orig        2015-09-18 15:43:58.131379615 +0000\n+++ /etc/vsftpd/vsftpd.conf     2015-09-19 02:20:40.951605554 +0000\n@@ -114,7 +114,7 @@\n # Make sure, that one of the listen options is commented !!\n #listen_ipv6=YES\n\n-pam_service_name=vsftpd\n+pam_service_name=vsftpd.virtual\n userlist_enable=YES\n tcp_wrappers=NO\n\n@@ -125,3 +125,16 @@\n pasv_max_port=60010\n use_localtime=YES\n force_dot_files=YES\n+\n+guest_enable=YES\n+guest_username=ftp-test\n+user_sub_token=$USER\n+local_root=/home/ftp-test/$USER\n+hide_ids=YES\n+anon_upload_enable=YES\n+anon_mkdir_write_enable=YES\n+anon_other_write_enable=YES\n+anon_world_readable_only=NO\n+anon_umask=022\n+virtual_use_local_privs=YES\n+\n```\n\n#### PAM\n\n```\n$ cat <<EOF | sudo tee /etc/pam.d/vsftpd.virtual\n#%PAM-1.0\nauth       required     pam_userdb.so db=/etc/vsftpd/vsftpd-virtual-user\naccount    required     pam_userdb.so db=/etc/vsftpd/vsftpd-virtual-user\nsession    required     pam_loginuid.so\nEOF\n```\n\n### chroot \u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u4f5c\u6210\n\n```\n$ sudo install -d -o ftp-test -g ftp-test /home/ftp-test/{user1,user2}\n```\n\n### vsftpd \u3092\u518d\u8d77\u52d5\n\n```\n$ sudo /sbin/service vsftpd restart\n```\n\n### \u63a5\u7d9a\u78ba\u8a8d\n\n```\n$ ftp user1@52.69.XXX.YYY\nConnected to 52.69.XXX.YYY.\n220 (vsFTPd 2.2.2)\n331 Please specify the password.\nPassword:\n230 Login successful.\nRemote system type is UNIX.\nUsing binary mode to transfer files.\nftp> ls\n229 Entering Extended Passive Mode (|||60008|).\n150 Here comes the directory listing.\n226 Directory send OK.\nftp> ls -al\n229 Entering Extended Passive Mode (|||60003|).\n150 Here comes the directory listing.\ndrwxr-xr-x    2 ftp      ftp          4096 Sep 19 02:24 .\ndrwxr-xr-x    2 ftp      ftp          4096 Sep 19 02:24 ..\n226 Directory send OK.\nftp> put ~/test.txt ./test.txt\nlocal: /Users/koshigoe/test.txt remote: ./test.txt\n229 Entering Extended Passive Mode (|||60010|).\n150 Ok to send data.\n100% |****************************************************************************************************************************|     5       53.65 KiB/s    00:00 ETA\n226 Transfer complete.\n5 bytes sent in 00:00 (0.15 KiB/s)\n```\n\n### \u30e6\u30fc\u30b6\u3092\u8ffd\u52a0\u3059\u308b\n\n```\n$ cat <<EOF >> vsftpd-virtual-user.txt\nuser3\npassword3\nEOF\n$ sudo install -d -o ftp-test -g ftp-test /home/ftp-test/user3\n$ sudo db_load -T -t hash -f vsftpd-virtual-user.txt /etc/vsftpd/vsftpd-virtual-user.db\n```\n\n```\n$ ftp user3@52.69.XXX.YYY\nConnected to 52.69.XXX.YYY.\n220 (vsFTPd 2.2.2)\n331 Please specify the password.\nPassword:\n230 Login successful.\nRemote system type is UNIX.\nUsing binary mode to transfer files.\nftp> ls -al\n229 Entering Extended Passive Mode (|||60001|).\n150 Here comes the directory listing.\ndrwxr-xr-x    2 ftp      ftp          4096 Sep 19 02:36 .\ndrwxr-xr-x    2 ftp      ftp          4096 Sep 19 02:36 ..\n226 Directory send OK.\nftp> put ~/test.txt ./test.txt\nlocal: /Users/koshigoe/test.txt remote: ./test.txt\n229 Entering Extended Passive Mode (|||60010|).\n150 Ok to send data.\n100% |****************************************************************************************************************************|     5       32.33 KiB/s    00:00 ETA\n226 Transfer complete.\n5 bytes sent in 00:00 (0.15 KiB/s)\n```\n\n### \u307e\u3068\u3081\n\n- chroot \u7528\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306f\u30e6\u30fc\u30b6\u3054\u3068\u306b\u4e8b\u524d\u306b\u4f5c\u6210\u3057\u3066\u304a\u304f\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\n- chroot \u7528\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306e\u30d1\u30fc\u30df\u30c3\u30b7\u30e7\u30f3\u306f `guest_username` \u3067\u6307\u5b9a\u3057\u305f\u30e6\u30fc\u30b6\u306b\u5bfe\u5fdc\u3055\u305b\u307e\u3059\n- FTP \u30a2\u30ab\u30a6\u30f3\u30c8\u306e\u8ffd\u52a0\u306f\u30e6\u30fc\u30b6\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u3092\u66f4\u65b0\u3059\u308b\u3060\u3051\u3067\u3088\u304f\u3001vsftpd \u306e\u518d\u8d77\u52d5\u306f\u4e0d\u8981\u3067\u3057\u305f\n\n### \u6c17\u306b\u306a\u308b\n\n- \u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u304c\u30ed\u30fc\u30ab\u30eb\u306b\u3042\u308b\u30d5\u30a1\u30a4\u30eb\u306a\u3042\u305f\u308a\n- \u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u66f4\u65b0\u30bf\u30a4\u30df\u30f3\u30b0\u3067\u77ac\u65ad(\u30a8\u30e9\u30fc)\u304c\u767a\u751f\u3059\u308b\u306e\u304b\n- \u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u3092 NFS \u306a\u3069\u3067\u5171\u6709\u3067\u304d\u305f\u3068\u3057\u3066\u7af6\u5408\u306a\u3069\u306f\u767a\u751f\u3059\u308b\u306e\u304b\n\n\npam_mysql (MySQL)\n----\n\n### MySQL \u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n```\n$ sudo yum install -y mysql mysql-server\n$ sudo chkconfig mysqld on\n$ sudo chkconfig --list mysqld\nmysqld          0:off   1:off   2:on    3:on    4:on    5:on    6:off\n$ sudo /sbin/service mysqld start\n```\n\n### pam_mysql \u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n```\n$ sudo yum install --enablerepo=epel -y pam_mysql\n```\n\n### \u30e6\u30fc\u30b6\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u4f5c\u6210\n\n```\nmysql> CREATE DATABASE ftpusers;\nQuery OK, 1 row affected (0.00 sec)\n\nmysql> GRANT SELECT, INSERT, UPDATE, DELETE, CREATE, DROP, INDEX, ALTER on ftpusers.* to ftpuser@localhost identified by '12345';\nQuery OK, 0 rows affected (0.00 sec)\n\nmysql> USE ftpusers;\nDatabase changed\nmysql> CREATE TABLE users(\n    ->     id INT AUTO_INCREMENT NOT NULL,\n    ->     name CHAR(128) binary NOT NULL,\n    ->     passwd CHAR(128) binary NOT NULL,\n    ->     primary KEY(id)\n    -> );\nQuery OK, 0 rows affected (0.01 sec)\n\nmysql> CREATE TABLE logs (\n    ->     msg VARCHAR(255),\n    ->     user CHAR(128),\n    ->     pid INT,\n    ->     host CHAR(128),\n    ->     rhost CHAR(128),\n    ->     logtime TIMESTAMP\n    -> );\nQuery OK, 0 rows affected (0.01 sec)\n```\n\n### PAM\n\n```\n$ cat <<EOF | sudo tee /etc/pam.d/vsftpd.mysql\nauth       required     /lib64/security/pam_mysql.so user=ftpuser passwd=12345 host=localhost db=ftpusers table=users usercolumn=name passwdcolumn=passwd crypt=2 use_323_passwd=false sqllog=1 logtable=logs logmsgcolumn=msg logusercolumn=user logpidcolumn=pid loghostcolumn=host logrhostcolumn=rhost logtimecolumn=logtime\naccount    required     /lib64/security/pam_mysql.so user=ftpuser passwd=12345 host=localhost db=ftpusers table=users usercolumn=name passwdcolumn=passwd crypt=2 use_323_passwd=false sqllog=1 logtable=logs logmsgcolumn=msg logusercolumn=user logpidcolumn=pid loghostcolumn=host logrhostcolumn=rhost logtimecolumn=logtime\nEOF\n```\n\n### vsftpd.conf\n\n```\n$ sudo cp /etc/vsftpd/vsftpd.conf /etc/vsftpd/vsftpd.conf.userdb\n$ sudo vi /etc/vsftpd/vsftpd.conf\n$ sudo diff -u /etc/vsftpd/vsftpd.conf.userdb /etc/vsftpd/vsftpd.conf\n--- /etc/vsftpd/vsftpd.conf.userdb      2015-09-19 02:56:18.477864224 +0000\n+++ /etc/vsftpd/vsftpd.conf     2015-09-19 03:08:23.835013951 +0000\n@@ -114,7 +114,7 @@\n # Make sure, that one of the listen options is commented !!\n #listen_ipv6=YES\n\n-pam_service_name=vsftpd.virtual\n+pam_service_name=vsftpd.mysql\n userlist_enable=YES\n tcp_wrappers=NO\n\n```\n\n### FTP \u30a2\u30ab\u30a6\u30f3\u30c8\u8ffd\u52a0\n\n```\n$ mysql -u ftpuser -p\nmysql> USE ftpusers;\n\nDatabase changed\nmysql> INSERT INTO users (name,passwd) VALUES('user4', PASSWORD('password4'));\nQuery OK, 1 row affected (0.00 sec)\n```\n\n### chroot \u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u4f5c\u6210\n\n```\n$ sudo install -d -o ftp-test -g ftp-test /home/ftp-test/user4\n```\n\n### vsftpd \u3092\u518d\u8d77\u52d5\n\n```\n$ sudo /sbin/service vsftpd restart\n```\n\n### \u63a5\u7d9a\u78ba\u8a8d\n\n```\n$ ftp user4@52.69.XXX.YYY\nConnected to 52.69.XXX.YYY.\n220 (vsFTPd 2.2.2)\n331 Please specify the password.\nPassword:\n230 Login successful.\nRemote system type is UNIX.\nUsing binary mode to transfer files.\nftp> ls -la\n229 Entering Extended Passive Mode (|||60005|).\n150 Here comes the directory listing.\ndrwxr-xr-x    2 ftp      ftp          4096 Sep 19 03:12 .\ndrwxr-xr-x    2 ftp      ftp          4096 Sep 19 03:12 ..\n226 Directory send OK.\nftp> put ~/test.txt ./test.txt\nlocal: /Users/koshigoe/test.txt remote: ./test.txt\n229 Entering Extended Passive Mode (|||60005|).\n150 Ok to send data.\n100% |****************************************************************************************************************************|     5       22.60 KiB/s    00:00 ETA\n226 Transfer complete.\n5 bytes sent in 00:00 (0.14 KiB/s)\n```\n\n### \u307e\u3068\u3081\n\n- pam \u7528\u306b\u30e6\u30fc\u30b6\u3068\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u3068\u30c6\u30fc\u30d6\u30eb\u3092\u7528\u610f\u3059\u308c\u3070\u5229\u7528\u3067\u304d\u307e\u3059\n\n### \u6c17\u306b\u306a\u308b\n\n- pam_mysql \u304c mysql51-libs \u306b\u4f9d\u5b58\u3057\u3066\u3044\u305f\u70b9\n- pam_mysql \u306e\u8a2d\u5b9a\u306b MySQL \u3078\u306e\u63a5\u7d9a\u60c5\u5831\u3092\u57cb\u3081\u8fbc\u3080\u3042\u305f\u308a\n- chroot \u7528\u306b\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u90fd\u5ea6\u4f5c\u308b\u3042\u305f\u308a\n\n\n\u307e\u3068\u3081\n----\n\n- \u30a2\u30ab\u30a6\u30f3\u30c8\u306e\u8ffd\u52a0\u3092\u52d5\u7684\u306b\u884c\u3048\u308b\u3053\u3068\u306f\u5206\u304b\u308a\u307e\u3057\u305f\n- chroot \u7528\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u4e8b\u524d\u306b\u7528\u610f\u305b\u305a\u306b\u6e08\u307e\u305b\u3089\u308c\u308b\u306e\u304b\u77e5\u308a\u305f\u3044\u3068\u3053\u308d\u3067\u3059\n- LDAP \u307e\u3067\u8e0f\u307f\u8fbc\u3082\u3046\u304b\u8ff7\u3044\u307e\u3057\u305f\u304c\u3001LDAP \u306e\u77e5\u8b58\u304c\u30bc\u30ed\u3067\u3042\u308b\u305f\u3081\u5148\u9001\u308a\u306b\u3057\u307e\u3057\u305f\n\n\n\u53c2\u8003\n----\n\n- [\u3010linux\u3011vsftpd \u5c0e\u5165\u624b\u9806\uff08\u30d0\u30fc\u30c1\u30e3\u30eb\u30e6\u30fc\u30b6\u30fc\u7248\uff09 at softel\u30e1\u30e2](https://www.softel.co.jp/blogs/tech/archives/2437)\n- [Vsftpd FTP Server With Virtual Users ( Berkeley DB + PAM )](http://www.cyberciti.biz/tips/centos-redhat-vsftpd-ftp-with-virtual-users.html)\n- [[CentOS6.x]vsftpd+MySQL\u3067\u30d0\u30fc\u30c1\u30e3\u30eb\u30e6\u30fc\u30b6\u904b\u7528 | \u3054\u3063\u305f\u716e - tips about programming and building a server](http://park1.wakwak.com/~ima/centos4_vsftpd0006.html)\n", "tags": ["vsftpd"]}