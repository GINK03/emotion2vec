{"context": "\u30bf\u30a4\u30c8\u30eb\u9577\u3044\u3002\nfluent-plugin-secure-forward \u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u304c\u9001\u308a\u5074\u30fb\u53d7\u3051\u5074\u3067\u9055\u3046\u305b\u3044\u3067 Shared key mismatch \u4e91\u3005\u3068\u3044\u3046\u30a8\u30e9\u30fc\u304c\u51fa\u3066\u3057\u307e\u3063\u305f\u306e\u3067\u3001\u3068\u308a\u3042\u3048\u305a docker-compose \u3067\u518d\u73fe\u3067\u304d\u308b\u74b0\u5883\u3092\u4f5c\u3063\u305f\u30e1\u30e2\u3002\n\u30bd\u30fc\u30b9\u3092\u8ffd\u3063\u305f\u3068\u3053\u308d\u3001Change authentication protocol: fix to send nonce for shared_key check \u00b7 tagomoris/fluent-plugin-secure-forward@6f1c4c1 \u304c\u539f\u56e0\u3063\u307d\u3044\u306e\u3067\u3001\u3053\u306e\u30b3\u30df\u30c3\u30c8\u304c\u5165\u3063\u3066\u3044\u306a\u3044 v0.3.1 (\u9001\u308a\u5074) \u3068\u3001\u3053\u306e\u30b3\u30df\u30c3\u30c8\u304c\u5165\u3063\u305f v0.3.2 (\u53d7\u3051\u5074) \u3068\u3044\u3046\u69cb\u6210\u3067\u8a66\u3057\u3066\u307f\u305f\u3002\n\n\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u4f5c\u6210\n\u4f5c\u696d\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u4f5c\u6210\u3057\u3001\u79fb\u52d5\u3002\n$ mkdir secure-forwards\n$ cd secure-forwards\n\n\u5fc5\u8981\u306a\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u4f5c\u3063\u3066\u304a\u304f\u3002\n$ mkdir -p new/log\n$ mkdir -p new/plugins\n$ mkdir -p old/log\n$ mkdir -p old/plugins\n\n\n\u30d5\u30a1\u30a4\u30eb\u4f5c\u6210\ndocker-compose.yml \u4f5c\u6210\u3002\n$ vi docker-compose.yml\n\nversion: '2'\nservices:\n  new:\n    build: ./new/\n    volumes:\n      - ./new/log:/fluentd/log\n    ports:\n      - 24284\n  old:\n    build: ./old/\n    volumes:\n      - ./old/log:/fluentd/log\n    ports:\n      - 24224\n\n0.3.2 \u3068 0.3.1 \u305d\u308c\u305e\u308c\u306e Dockerfile \u3092\u4f5c\u6210\u3002\nvi new/Dockerfile\n\nFROM fluent/fluentd:latest-onbuild\nMAINTAINER YOUR_NAME <...@...>\nWORKDIR /home/fluent\nENV PATH /home/fluent/.gem/ruby/2.3.0/bin:$PATH\n\nUSER root\nRUN apk --no-cache add sudo build-base ruby-dev && \\\n\n    sudo -u fluent gem install fluent-plugin-secure-forward:0.3.2 && \\\n\n    rm -rf /home/fluent/.gem/ruby/2.3.0/cache/*.gem && sudo -u fluent gem sources -c && \\\n    apk del sudo build-base ruby-dev\n\nEXPOSE 24284\n\nUSER fluent\nCMD exec fluentd -c /fluentd/etc/$FLUENTD_CONF -p /fluentd/plugins $FLUENTD_OPT\n\n$ vi old/Dockerfile\n\nFROM fluent/fluentd:latest-onbuild\nMAINTAINER YOUR_NAME <...@...>\nWORKDIR /home/fluent\nENV PATH /home/fluent/.gem/ruby/2.3.0/bin:$PATH\n\nUSER root\nRUN apk --no-cache add sudo build-base ruby-dev && \\\n\n    sudo -u fluent gem install fluent-plugin-secure-forward:0.3.1 && \\\n\n    rm -rf /home/fluent/.gem/ruby/2.3.0/cache/*.gem && sudo -u fluent gem sources -c && \\\n    apk del sudo build-base ruby-dev\n\nEXPOSE 24224\n\nUSER fluent\nCMD exec fluentd -c /fluentd/etc/$FLUENTD_CONF -p /fluentd/plugins $FLUENTD_OPT\n\n0.3.2 \u3068 0.3.1 \u305d\u308c\u305e\u308c\u306e fluent.conf \u3092\u4f5c\u6210\u3002\n$ vi new/fluent.conf\n\n<source>\n  type secure_forward\n  shared_key tekitou\n  secure no\n  self_hostname new\n  cert_auto_generate yes\n  allow_anonymous_source yes\n  authentication yes\n  bind 0.0.0.0\n  port 24284\n  <user>\n    username tekitou\n    password tekitou\n  </user>\n</source>\n\n<label @mainstream>\n  <match **>\n    @type stdout\n  </match>\n</label>\n\n$ vi old/fluent.conf\n\n<source>\n  @type  forward\n  port  24224\n</source>\n\n<filter **>\n  @type stdout\n</filter>\n\n<match **>\n  @type secure_forward\n  shared_key tekitou\n  secure no\n  self_hostname old\n  <server>\n    host new\n    port 24284\n    username tekitou\n    password tekitou\n  </server>\n</match>\n\n\n\u691c\u8a3c\ndocker-compose up -d \u3067 2 \u3064\u306e\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3002\n$ docker-compose up -d\n(\u7565)\n$ docker-compose ps\n        Name                      Command               State                       Ports                     \n-------------------------------------------------------------------------------------------------------------\nsecureforwards_new_1   /bin/sh -c exec fluentd -c ...   Up      24224/tcp, 0.0.0.0:32816->24284/tcp, 5140/tcp \nsecureforwards_old_1   /bin/sh -c exec fluentd -c ...   Up      0.0.0.0:32815->24224/tcp, 5140/tcp\n\n\u9001\u308a\u5074\u306e 0.3.1 \u306e\u30b3\u30f3\u30c6\u30ca\u306b\u30ed\u30b0\u3092\u6d41\u3059\u3002\n$ docker-compose exec old sh -c \"echo '{\\\"hello\\\":\\\"world\\\"}' | fluent-cat docker\"\n\n\u53d7\u3051\u5074\u306e\u30ed\u30b0\u3092\u898b\u3066\u307f\u308b\u3068\u3001Shared key mismatch \u30a8\u30e9\u30fc\u304c\u51fa\u3066\u3044\u308b\u3053\u3068\u304c\u5206\u304b\u308b\u3002\n$ docker-compose logs new\n(\u7565)\nnew_1  | 2017-02-08 03:59:56 +0000 [warn]: Shared key mismatch from 'old'\n\n\n\u307e\u3068\u3081\nfluent-plugin-secure-forward \u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u304c\u9001\u308a\u5074\u30fb\u53d7\u3051\u5074\u3067\u9055\u3046\u3068\u304d\u306b\u51fa\u308b Shared key mismatch \u30a8\u30e9\u30fc\u3092 docker-compose \u3067\u518d\u73fe\u3055\u305b\u308b\u3053\u3068\u304c\u3067\u304d\u305f\u3002\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3067\u56de\u907f\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u308b\u304b\u78ba\u8a8d\u3067\u304d\u3066\u3044\u306a\u3044\u306e\u3067\u3001\u3082\u3046\u5c11\u3057\u8abf\u3079\u3066\u307f\u3088\u3046\u3002\n\u30bf\u30a4\u30c8\u30eb\u9577\u3044\u3002\n\n\nfluent-plugin-secure-forward \u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u304c\u9001\u308a\u5074\u30fb\u53d7\u3051\u5074\u3067\u9055\u3046\u305b\u3044\u3067 `Shared key mismatch` \u4e91\u3005\u3068\u3044\u3046\u30a8\u30e9\u30fc\u304c\u51fa\u3066\u3057\u307e\u3063\u305f\u306e\u3067\u3001\u3068\u308a\u3042\u3048\u305a docker-compose \u3067\u518d\u73fe\u3067\u304d\u308b\u74b0\u5883\u3092\u4f5c\u3063\u305f\u30e1\u30e2\u3002\n\n\u30bd\u30fc\u30b9\u3092\u8ffd\u3063\u305f\u3068\u3053\u308d\u3001[Change authentication protocol: fix to send nonce for shared\\_key check \u00b7 tagomoris/fluent\\-plugin\\-secure\\-forward@6f1c4c1](https://github.com/tagomoris/fluent-plugin-secure-forward/commit/6f1c4c1d16a4af2d03fdb2b454e4c49017c5bef4) \u304c\u539f\u56e0\u3063\u307d\u3044\u306e\u3067\u3001\u3053\u306e\u30b3\u30df\u30c3\u30c8\u304c\u5165\u3063\u3066\u3044\u306a\u3044 v0.3.1 (\u9001\u308a\u5074) \u3068\u3001\u3053\u306e\u30b3\u30df\u30c3\u30c8\u304c\u5165\u3063\u305f v0.3.2 (\u53d7\u3051\u5074) \u3068\u3044\u3046\u69cb\u6210\u3067\u8a66\u3057\u3066\u307f\u305f\u3002\n\n\n## \u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u4f5c\u6210\n\n\u4f5c\u696d\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u4f5c\u6210\u3057\u3001\u79fb\u52d5\u3002\n\n```\n$ mkdir secure-forwards\n$ cd secure-forwards\n```\n\n\u5fc5\u8981\u306a\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u4f5c\u3063\u3066\u304a\u304f\u3002\n\n```\n$ mkdir -p new/log\n$ mkdir -p new/plugins\n$ mkdir -p old/log\n$ mkdir -p old/plugins\n```\n\n## \u30d5\u30a1\u30a4\u30eb\u4f5c\u6210\n\ndocker-compose.yml \u4f5c\u6210\u3002\n\n```\n$ vi docker-compose.yml\n```\n\n```yaml\nversion: '2'\nservices:\n  new:\n    build: ./new/\n    volumes:\n      - ./new/log:/fluentd/log\n    ports:\n      - 24284\n  old:\n    build: ./old/\n    volumes:\n      - ./old/log:/fluentd/log\n    ports:\n      - 24224\n```\n\n0.3.2 \u3068 0.3.1 \u305d\u308c\u305e\u308c\u306e Dockerfile \u3092\u4f5c\u6210\u3002\n\n```\nvi new/Dockerfile\n```\n\n```\nFROM fluent/fluentd:latest-onbuild\nMAINTAINER YOUR_NAME <...@...>\nWORKDIR /home/fluent\nENV PATH /home/fluent/.gem/ruby/2.3.0/bin:$PATH\n\nUSER root\nRUN apk --no-cache add sudo build-base ruby-dev && \\\n\n    sudo -u fluent gem install fluent-plugin-secure-forward:0.3.2 && \\\n\n    rm -rf /home/fluent/.gem/ruby/2.3.0/cache/*.gem && sudo -u fluent gem sources -c && \\\n    apk del sudo build-base ruby-dev\n\nEXPOSE 24284\n\nUSER fluent\nCMD exec fluentd -c /fluentd/etc/$FLUENTD_CONF -p /fluentd/plugins $FLUENTD_OPT\n```\n\n```\n$ vi old/Dockerfile\n```\n\n```\nFROM fluent/fluentd:latest-onbuild\nMAINTAINER YOUR_NAME <...@...>\nWORKDIR /home/fluent\nENV PATH /home/fluent/.gem/ruby/2.3.0/bin:$PATH\n\nUSER root\nRUN apk --no-cache add sudo build-base ruby-dev && \\\n\n    sudo -u fluent gem install fluent-plugin-secure-forward:0.3.1 && \\\n\n    rm -rf /home/fluent/.gem/ruby/2.3.0/cache/*.gem && sudo -u fluent gem sources -c && \\\n    apk del sudo build-base ruby-dev\n\nEXPOSE 24224\n\nUSER fluent\nCMD exec fluentd -c /fluentd/etc/$FLUENTD_CONF -p /fluentd/plugins $FLUENTD_OPT\n```\n\n0.3.2 \u3068 0.3.1 \u305d\u308c\u305e\u308c\u306e fluent.conf \u3092\u4f5c\u6210\u3002\n\n```\n$ vi new/fluent.conf\n```\n\n```\n<source>\n  type secure_forward\n  shared_key tekitou\n  secure no\n  self_hostname new\n  cert_auto_generate yes\n  allow_anonymous_source yes\n  authentication yes\n  bind 0.0.0.0\n  port 24284\n  <user>\n    username tekitou\n    password tekitou\n  </user>\n</source>\n\n<label @mainstream>\n  <match **>\n    @type stdout\n  </match>\n</label>\n```\n\n```\n$ vi old/fluent.conf\n```\n\n```\n<source>\n  @type  forward\n  port  24224\n</source>\n\n<filter **>\n  @type stdout\n</filter>\n\n<match **>\n  @type secure_forward\n  shared_key tekitou\n  secure no\n  self_hostname old\n  <server>\n    host new\n    port 24284\n    username tekitou\n    password tekitou\n  </server>\n</match>\n```\n\n## \u691c\u8a3c\n\n`docker-compose up -d` \u3067 2 \u3064\u306e\u30b3\u30f3\u30c6\u30ca\u3092\u8d77\u52d5\u3002\n\n```\n$ docker-compose up -d\n(\u7565)\n$ docker-compose ps\n        Name                      Command               State                       Ports                     \n-------------------------------------------------------------------------------------------------------------\nsecureforwards_new_1   /bin/sh -c exec fluentd -c ...   Up      24224/tcp, 0.0.0.0:32816->24284/tcp, 5140/tcp \nsecureforwards_old_1   /bin/sh -c exec fluentd -c ...   Up      0.0.0.0:32815->24224/tcp, 5140/tcp\n```\n\n\u9001\u308a\u5074\u306e 0.3.1 \u306e\u30b3\u30f3\u30c6\u30ca\u306b\u30ed\u30b0\u3092\u6d41\u3059\u3002\n\n```\n$ docker-compose exec old sh -c \"echo '{\\\"hello\\\":\\\"world\\\"}' | fluent-cat docker\"\n```\n\n\u53d7\u3051\u5074\u306e\u30ed\u30b0\u3092\u898b\u3066\u307f\u308b\u3068\u3001Shared key mismatch \u30a8\u30e9\u30fc\u304c\u51fa\u3066\u3044\u308b\u3053\u3068\u304c\u5206\u304b\u308b\u3002\n\n```\n$ docker-compose logs new\n(\u7565)\nnew_1  | 2017-02-08 03:59:56 +0000 [warn]: Shared key mismatch from 'old'\n```\n\n## \u307e\u3068\u3081\n\nfluent-plugin-secure-forward \u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u304c\u9001\u308a\u5074\u30fb\u53d7\u3051\u5074\u3067\u9055\u3046\u3068\u304d\u306b\u51fa\u308b Shared key mismatch \u30a8\u30e9\u30fc\u3092 docker-compose \u3067\u518d\u73fe\u3055\u305b\u308b\u3053\u3068\u304c\u3067\u304d\u305f\u3002\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3067\u56de\u907f\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u308b\u304b\u78ba\u8a8d\u3067\u304d\u3066\u3044\u306a\u3044\u306e\u3067\u3001\u3082\u3046\u5c11\u3057\u8abf\u3079\u3066\u307f\u3088\u3046\u3002\n", "tags": ["fluentd", "docker", "docker-compose"]}