{"tags": ["log", "TreasureData", "fluentd", "Apache"], "context": " \u3053\u306e\u8a18\u4e8b\u306f\u6700\u7d42\u66f4\u65b0\u65e5\u304b\u30891\u5e74\u4ee5\u4e0a\u304c\u7d4c\u904e\u3057\u3066\u3044\u307e\u3059\u3002apache\u306e\u30ed\u30b0\u3092fluentd\u3092\u7528\u3044\u3066TreasureData\u306b\u5165\u308c\u3066\u307f\u305f\u306e\u3067\u30e1\u30e2\u3057\u3066\u304a\u304f\u3002\n\n\u80cc\u666f\nnginx + fluentd + TreasureData\u3067\u306eapache\u7248\u3002\n\u307b\u307c\u4e0a\u8a18\u306e\u30b3\u30d4\u30da\u3060\u3051\u3069\u60aa\u3057\u304b\u3089\u305a\u3002\n\u4ee5\u4e0b\u74b0\u5883\u60c5\u5831\u3002\n\nubuntu: 12.04\nruby: 2.1.1p76\ngem: 2.2.2\napache2: Apache/2.2.22\n\nTreasureData\u306eAPI\u30ad\u30fc\u306f\u53d6\u5f97\u6e08\u307f\u3067\u3042\u308b\u3053\u3068\u3092\u524d\u63d0\u3068\u3059\u308b\u3002\nTreasureData\u3092\u4f7f\u3063\u3066\u307f\u305f\u3092\u53c2\u7167\u3002\n\nfluentd(td-agent)\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\u4ee5\u4e0b\u306e\u30b3\u30de\u30f3\u30c9\u3067fluentd\u306e\u5b89\u5b9a\u7248\u3067\u3042\u308btd-agent\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u307e\u3059\u3002\n\ninstall_td-agent\n$ curl -L http://toolbelt.treasuredata.com/sh/install-ubuntu-precise.sh | sh\n$ sudo td-agent --version\ntd-agent 0.10.45\n\n\n\nDB\u4f5c\u6210\n\u30c7\u30fc\u30bf\u306e\u4fdd\u5b58\u5148\u306eDB\u3092\u4f5c\u6210\u3057\u3066\u304a\u304f\u3002\nTD Tool Belt\u3067TreasureData\u306b\u30ed\u30b0\u30a4\u30f3\u3059\u308b\u3002\n\nlogin_td\n$ td account -f\nEnter your Treasure Data credentials.\nEmail: ${my_addr}\nPassword (typing will be hidden): ${my_passwd} \nAuthenticated successfully.\nUse 'td db:create <db_name>' to create a database.\n$\n\n\nDB\u3092\u4f5c\u6210\u3059\u308b\u3002\n\ncreate_db\n$ td db:create apache\n\n\n\ntd-agent\u306e\u8a2d\u5b9a\ntd-agent\u3067\u306f\u30c7\u30d5\u30a9\u30eb\u30c8\u306eapache\u306e\u30d5\u30a9\u30fc\u30de\u30c3\u30c8\u3092\u30b5\u30dd\u30fc\u30c8\u3057\u3066\u304f\u308c\u3066\u308b\u3063\u307d\u3044\u306e\u3067\u8a2d\u5b9a\u306f\u7c21\u5358\u3002\n\u4ee5\u4e0b\u306e\u3088\u3046\u306b/etc/td-agent/td-agent.conf\u3092\u7de8\u96c6\u3002\n\ntd-agent.conf\n# Tailing the Apache Log\n<source>\n  type tail\n  path /var/log/apache2/access.log\n  pos_file /var/log/td-agent/httpd-access.pos\n  tag td.apache.access\n  format apache2\n</source>\n\n# Treasure Data Input and Output\n<match td.*.*>\n  type tdlog\n  apikey ${my_td_api_key}\n  auto_create_table\n  buffer_type file\n  buffer_path /var/log/td-agent/buffer/td\n  endpoint ${td_endpoint}\n  flush_interval 10s\n  use_ssl true\n</match>\n\n\n\u4e0a\u8a18\u306e\u610f\u5473\u3067\u3059\u304c\u3001source type\u3067tail\u3092\u6307\u5b9a\u3057\u3066\u304a\u308a\u65b0\u898f\u3067\u8ffd\u52a0\u3055\u308c\u305f\u3082\u306e\u3092\u5bfe\u8c61\u3068\u3057\u3066\u3044\u308b\u3002\nsource path\u306f\u76e3\u8996\u5bfe\u8c61\u306e\u30d1\u30b9\u3001source tag\u3067\u30bf\u30b0\u4ed8\u3051\u3092\u3057\u3066\u3044\u307e\u3059\u3002td.apache.access\u306fTreasureData\u4e0a\u306eapache\u3068\u3044\u3046DB\u306eaccess\u3068\u3044\u3046\u30c6\u30fc\u30d6\u30eb\u306b\u30c7\u30fc\u30bf\u3092\u767b\u9332\u3059\u308b\u3053\u3068\u3092\u610f\u5473\u3059\u308b\u3002\nmatch\u306e\u65b9\u3067\u306fendpoint\u3067TreasureData\u306eAPI\u306e\u30a8\u30f3\u30c9\u30dd\u30a4\u30f3\u30c8\u3092\u6307\u5b9a\u3059\u308b\u3002AWS\u306e\u5834\u5408\u3060\u3068https://api.treasuredata.com\u3068\u306a\u308b\u3002\nflush_interval\u3067\u30c7\u30fc\u30bf\u9001\u51fa\u9593\u9694\u3092\u6307\u5b9a\u3057\u307e\u3059\u3002\n\n\u30c7\u30fc\u30bf\u30a4\u30f3\u30dd\u30fc\u30c8\n\u307e\u305a\u306fapache2\u3092\u8d77\u52d5\u3059\u308b\u3002\n\nstart_apache2\n$ sudo rm /var/log/apache2/access.log # \u524a\u9664\u3057\u3066\u304a\u304f\u3002\n$ sudo service apache2 restart\n\n\n\u6b21\u306btd-agent\u306e\u8d77\u52d5\u3002\n\nstart_td-agent\n$ sudo /etc/init.d/td-agent start\n\n\ntd-agent\u306e\u30ed\u30b0\u3092\u898b\u308b\u3068\u4f55\u3084\u3089\u30a8\u30e9\u30fc\u30ed\u30b0\u3092\u306f\u3044\u3066\u308b\u3002\n\n/var/log/td-agent/td-agent.log\n2014-08-20 16:14:22 +0900 [error]: Permission denied - /var/log/apache2/access.log\n  2014-08-20 16:14:22 +0900 [error]: /usr/lib/fluent/ruby/lib/ruby/gems/1.9.1/gems/fluentd-0.10.45/lib/fluent/plugin/in_tail.rb:529:in `initialize'\n  2014-08-20 16:14:22 +0900 [error]: /usr/lib/fluent/ruby/lib/ruby/gems/1.9.1/gems/fluentd-0.10.45/lib/fluent/plugin/in_tail.rb:529:in `open'\n\n\napache\u30ed\u30b0\u306e\u8aad\u307f\u53d6\u308a\u6a29\u9650\u304c\u306a\u3044\u3088\u3046\u306a\u306e\u3067\u4ed8\u4e0e\u3057\u3066\u3084\u308b\u3002\n\nchmod\n$ sudo ls -ld /var/log/apache2/\ndrwxr-x--- 2 root adm 4096 Aug 20 16:11 /var/log/apache2/\n$ sudo chmod 755 /var/log/apache2/\n\n\n\u5ff5\u306e\u305f\u3081td-agent\u306e\u518d\u8d77\u52d5\u3002\n\ntd-agent_restart\n$ /etc/init.d/td-agent restart\n$ tail -f /var/log/td-agent/td-agent.log\n</ROOT>\n2014-08-20 16:19:43 +0900 [info]: adding source type=\"tail\"\n2014-08-20 16:19:43 +0900 [info]: adding source type=\"forward\"\n2014-08-20 16:19:43 +0900 [info]: adding source type=\"http\"\n2014-08-20 16:19:43 +0900 [info]: adding source type=\"debug_agent\"\n2014-08-20 16:19:43 +0900 [info]: adding match pattern=\"td.*.*\" type=\"tdlog\"\n2014-08-20 16:19:43 +0900 [info]: adding match pattern=\"debug.**\" type=\"stdout\"\n2014-08-20 16:19:43 +0900 [info]: following tail of /var/log/apache2/access.log\n2014-08-20 16:19:43 +0900 [info]: listening fluent socket on 0.0.0.0:24224\n2014-08-20 16:19:43 +0900 [info]: listening dRuby uri=\"druby://127.0.0.1:24230\" object=\"Engine\"\n^C\n$ \n\n\n\u3055\u3066\u3053\u308c\u3067\u5927\u4e08\u592b\u306a\u306f\u305a\u3002apache\u306b\u30a2\u30af\u30bb\u30b9\u3057\u3066\u307f\u308b\u3002\n\u5ff5\u306e\u305f\u30815\u56de\u3002\n\ncurl\n$ curl http://localhost\n$ curl http://localhost\n$ curl http://localhost\n$ curl http://localhost\n$ curl http://localhost\n$ sleep 10\n\n\n\ncheck_log\n$ sudo cat /var/log/apache2/access.log\n127.0.0.1 - - [20/Aug/2014:16:22:26 +0900] \"GET / HTTP/1.1\" 200 432 \"-\" \"curl/7.22.0 (x86_64-pc-linux-gnu) libcurl/7.22.0 OpenSSL/1.0.1 zlib/1.2.3.4 libidn/1.23 librtmp/2.3\"\n127.0.0.1 - - [20/Aug/2014:16:22:27 +0900] \"GET / HTTP/1.1\" 200 432 \"-\" \"curl/7.22.0 (x86_64-pc-linux-gnu) libcurl/7.22.0 OpenSSL/1.0.1 zlib/1.2.3.4 libidn/1.23 librtmp/2.3\"\n127.0.0.1 - - [20/Aug/2014:16:22:28 +0900] \"GET / HTTP/1.1\" 200 432 \"-\" \"curl/7.22.0 (x86_64-pc-linux-gnu) libcurl/7.22.0 OpenSSL/1.0.1 zlib/1.2.3.4 libidn/1.23 librtmp/2.3\"\n127.0.0.1 - - [20/Aug/2014:16:22:28 +0900] \"GET / HTTP/1.1\" 200 432 \"-\" \"curl/7.22.0 (x86_64-pc-linux-gnu) libcurl/7.22.0 OpenSSL/1.0.1 zlib/1.2.3.4 libidn/1.23 librtmp/2.3\"\n127.0.0.1 - - [20/Aug/2014:16:22:29 +0900] \"GET / HTTP/1.1\" 200 432 \"-\" \"curl/7.22.0 (x86_64-pc-linux-gnu) libcurl/7.22.0 OpenSSL/1.0.1 zlib/1.2.3.4 libidn/1.23 librtmp/2.3\"\n\n\n\n\u30a4\u30f3\u30dd\u30fc\u30c8\u78ba\u8a8d\n\u30a4\u30f3\u30dd\u30fc\u30c8\u78ba\u8a8d\u3002\n5\u4ef6\u306e\u30c7\u30fc\u30bf\u304c\u30a4\u30f3\u30dd\u30fc\u30c8\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n\ncheck_import_data\n$ td table:list apache\n+----------+--------+------+-------+--------+---------------------------+---------------------------+----------------------------------------------------------------------------------------------------------+\n| Database | Table  | Type | Count | Size   | Last import               | Last log timestamp        | Schema                                                                                                   |\n+----------+--------+------+-------+--------+---------------------------+---------------------------+----------------------------------------------------------------------------------------------------------+\n| apache   | access | log  | 5     | 0.0 GB | 2014-08-20 16:22:30 +0900 | 2014-08-20 16:22:29 +0900 | host:string, path:string, method:string, referer:string, code:long, agent:string, user:string, size:long |\n+----------+--------+------+-------+--------+---------------------------+---------------------------+----------------------------------------------------------------------------------------------------------+\n1 row in set\n\n\n\u5185\u5bb9\u3082\u78ba\u8a8d\u3057\u3066\u307f\u308b\u3002\n\ntd_query\n$ td query -w -t hive -d apache \"SELECT * FROM access\"\n+-----------+------+--------+---------+------+-----------------------------------------------------------------------------------------------------+------+------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------+\n| host      | path | method | referer | code | agent                                                                                               | user | size | v                                                                                                                                                                                                          | time       |\n+-----------+------+--------+---------+------+-----------------------------------------------------------------------------------------------------+------+------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------+\n| 127.0.0.1 | /    | GET    | null    | 200  | curl/7.22.0 (x86_64-pc-linux-gnu) libcurl/7.22.0 OpenSSL/1.0.1 zlib/1.2.3.4 libidn/1.23 librtmp/2.3 | null | 432  | {\"path\":\"/\",\"code\":\"200\",\"size\":\"432\",\"method\":\"GET\",\"host\":\"127.0.0.1\",\"time\":\"1408519346\",\"agent\":\"curl/7.22.0 (x86_64-pc-linux-gnu) libcurl/7.22.0 OpenSSL/1.0.1 zlib/1.2.3.4 libidn/1.23 librtmp/2.3\"} | 1408519346 |\n| 127.0.0.1 | /    | GET    | null    | 200  | curl/7.22.0 (x86_64-pc-linux-gnu) libcurl/7.22.0 OpenSSL/1.0.1 zlib/1.2.3.4 libidn/1.23 librtmp/2.3 | null | 432  | {\"path\":\"/\",\"code\":\"200\",\"size\":\"432\",\"method\":\"GET\",\"host\":\"127.0.0.1\",\"time\":\"1408519347\",\"agent\":\"curl/7.22.0 (x86_64-pc-linux-gnu) libcurl/7.22.0 OpenSSL/1.0.1 zlib/1.2.3.4 libidn/1.23 librtmp/2.3\"} | 1408519347 |\n| 127.0.0.1 | /    | GET    | null    | 200  | curl/7.22.0 (x86_64-pc-linux-gnu) libcurl/7.22.0 OpenSSL/1.0.1 zlib/1.2.3.4 libidn/1.23 librtmp/2.3 | null | 432  | {\"path\":\"/\",\"code\":\"200\",\"size\":\"432\",\"method\":\"GET\",\"host\":\"127.0.0.1\",\"time\":\"1408519348\",\"agent\":\"curl/7.22.0 (x86_64-pc-linux-gnu) libcurl/7.22.0 OpenSSL/1.0.1 zlib/1.2.3.4 libidn/1.23 librtmp/2.3\"} | 1408519348 |\n| 127.0.0.1 | /    | GET    | null    | 200  | curl/7.22.0 (x86_64-pc-linux-gnu) libcurl/7.22.0 OpenSSL/1.0.1 zlib/1.2.3.4 libidn/1.23 librtmp/2.3 | null | 432  | {\"path\":\"/\",\"code\":\"200\",\"size\":\"432\",\"method\":\"GET\",\"host\":\"127.0.0.1\",\"time\":\"1408519348\",\"agent\":\"curl/7.22.0 (x86_64-pc-linux-gnu) libcurl/7.22.0 OpenSSL/1.0.1 zlib/1.2.3.4 libidn/1.23 librtmp/2.3\"} | 1408519348 |\n| 127.0.0.1 | /    | GET    | null    | 200  | curl/7.22.0 (x86_64-pc-linux-gnu) libcurl/7.22.0 OpenSSL/1.0.1 zlib/1.2.3.4 libidn/1.23 librtmp/2.3 | null | 432  | {\"path\":\"/\",\"code\":\"200\",\"size\":\"432\",\"method\":\"GET\",\"time\":\"1408519349\",\"host\":\"127.0.0.1\",\"agent\":\"curl/7.22.0 (x86_64-pc-linux-gnu) libcurl/7.22.0 OpenSSL/1.0.1 zlib/1.2.3.4 libidn/1.23 librtmp/2.3\"} | 1408519349 |\n+-----------+------+--------+---------+------+-----------------------------------------------------------------------------------------------------+------+------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------+\n5 rows in set\n\n\n\u3075\u3080\u3075\u3080\u3001\u3061\u3083\u3093\u3068\u5404\u30ab\u30e9\u30e0\u306b\u30c7\u30fc\u30bf\u304c\u5165\u3063\u3066\u308b\u3063\u307d\u3044\u3002\n\u304a\u3057\u307e\u3044\u3002\n\napache\u306e\u30ed\u30b0\u3092fluentd\u3092\u7528\u3044\u3066TreasureData\u306b\u5165\u308c\u3066\u307f\u305f\u306e\u3067\u30e1\u30e2\u3057\u3066\u304a\u304f\u3002\n\n## \u80cc\u666f\n[nginx + fluentd + TreasureData](http://qiita.com/akito1986/items/a3d77f731f8fb4067c8c)\u3067\u306eapache\u7248\u3002\n\n\u307b\u307c\u4e0a\u8a18\u306e\u30b3\u30d4\u30da\u3060\u3051\u3069\u60aa\u3057\u304b\u3089\u305a\u3002\n\n\u4ee5\u4e0b\u74b0\u5883\u60c5\u5831\u3002\n\n* ubuntu: 12.04\n* ruby: 2.1.1p76\n* gem: 2.2.2\n* apache2: Apache/2.2.22\n\nTreasureData\u306eAPI\u30ad\u30fc\u306f\u53d6\u5f97\u6e08\u307f\u3067\u3042\u308b\u3053\u3068\u3092\u524d\u63d0\u3068\u3059\u308b\u3002\n[TreasureData\u3092\u4f7f\u3063\u3066\u307f\u305f](http://qiita.com/akito1986/items/4c83ff492ed4b390ad50)\u3092\u53c2\u7167\u3002\n\n## fluentd(td-agent)\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\u4ee5\u4e0b\u306e\u30b3\u30de\u30f3\u30c9\u3067fluentd\u306e\u5b89\u5b9a\u7248\u3067\u3042\u308btd-agent\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u307e\u3059\u3002\n\n```cmd:install_td-agent\n$ curl -L http://toolbelt.treasuredata.com/sh/install-ubuntu-precise.sh | sh\n$ sudo td-agent --version\ntd-agent 0.10.45\n```\n\n## DB\u4f5c\u6210\n\u30c7\u30fc\u30bf\u306e\u4fdd\u5b58\u5148\u306eDB\u3092\u4f5c\u6210\u3057\u3066\u304a\u304f\u3002\n\n`TD Tool Belt`\u3067TreasureData\u306b\u30ed\u30b0\u30a4\u30f3\u3059\u308b\u3002\n\n```cmd:login_td\n$ td account -f\nEnter your Treasure Data credentials.\nEmail: ${my_addr}\nPassword (typing will be hidden): ${my_passwd} \nAuthenticated successfully.\nUse 'td db:create <db_name>' to create a database.\n$\n```\n\nDB\u3092\u4f5c\u6210\u3059\u308b\u3002\n\n```cmd:create_db\n$ td db:create apache\n```\n\n\n## td-agent\u306e\u8a2d\u5b9a\ntd-agent\u3067\u306f\u30c7\u30d5\u30a9\u30eb\u30c8\u306eapache\u306e\u30d5\u30a9\u30fc\u30de\u30c3\u30c8\u3092\u30b5\u30dd\u30fc\u30c8\u3057\u3066\u304f\u308c\u3066\u308b\u3063\u307d\u3044\u306e\u3067\u8a2d\u5b9a\u306f\u7c21\u5358\u3002\n\n\u4ee5\u4e0b\u306e\u3088\u3046\u306b`/etc/td-agent/td-agent.conf`\u3092\u7de8\u96c6\u3002\n\n```conf:td-agent.conf\n# Tailing the Apache Log\n<source>\n  type tail\n  path /var/log/apache2/access.log\n  pos_file /var/log/td-agent/httpd-access.pos\n  tag td.apache.access\n  format apache2\n</source>\n\n# Treasure Data Input and Output\n<match td.*.*>\n  type tdlog\n  apikey ${my_td_api_key}\n  auto_create_table\n  buffer_type file\n  buffer_path /var/log/td-agent/buffer/td\n  endpoint ${td_endpoint}\n  flush_interval 10s\n  use_ssl true\n</match>\n```\n\u4e0a\u8a18\u306e\u610f\u5473\u3067\u3059\u304c\u3001`source type`\u3067tail\u3092\u6307\u5b9a\u3057\u3066\u304a\u308a\u65b0\u898f\u3067\u8ffd\u52a0\u3055\u308c\u305f\u3082\u306e\u3092\u5bfe\u8c61\u3068\u3057\u3066\u3044\u308b\u3002\n`source path`\u306f\u76e3\u8996\u5bfe\u8c61\u306e\u30d1\u30b9\u3001`source tag`\u3067\u30bf\u30b0\u4ed8\u3051\u3092\u3057\u3066\u3044\u307e\u3059\u3002`td.apache.access`\u306fTreasureData\u4e0a\u306e`apache`\u3068\u3044\u3046DB\u306e`access`\u3068\u3044\u3046\u30c6\u30fc\u30d6\u30eb\u306b\u30c7\u30fc\u30bf\u3092\u767b\u9332\u3059\u308b\u3053\u3068\u3092\u610f\u5473\u3059\u308b\u3002\n\n`match`\u306e\u65b9\u3067\u306f`endpoint`\u3067TreasureData\u306eAPI\u306e\u30a8\u30f3\u30c9\u30dd\u30a4\u30f3\u30c8\u3092\u6307\u5b9a\u3059\u308b\u3002AWS\u306e\u5834\u5408\u3060\u3068`https://api.treasuredata.com`\u3068\u306a\u308b\u3002\n`flush_interval`\u3067\u30c7\u30fc\u30bf\u9001\u51fa\u9593\u9694\u3092\u6307\u5b9a\u3057\u307e\u3059\u3002\n\n## \u30c7\u30fc\u30bf\u30a4\u30f3\u30dd\u30fc\u30c8\n\u307e\u305a\u306fapache2\u3092\u8d77\u52d5\u3059\u308b\u3002\n\n```cmd:start_apache2\n$ sudo rm /var/log/apache2/access.log # \u524a\u9664\u3057\u3066\u304a\u304f\u3002\n$ sudo service apache2 restart\n```\n\n\u6b21\u306btd-agent\u306e\u8d77\u52d5\u3002\n\n```cmd:start_td-agent\n$ sudo /etc/init.d/td-agent start\n```\n\n`td-agent`\u306e\u30ed\u30b0\u3092\u898b\u308b\u3068\u4f55\u3084\u3089\u30a8\u30e9\u30fc\u30ed\u30b0\u3092\u306f\u3044\u3066\u308b\u3002\n\n```log:/var/log/td-agent/td-agent.log\n2014-08-20 16:14:22 +0900 [error]: Permission denied - /var/log/apache2/access.log\n  2014-08-20 16:14:22 +0900 [error]: /usr/lib/fluent/ruby/lib/ruby/gems/1.9.1/gems/fluentd-0.10.45/lib/fluent/plugin/in_tail.rb:529:in `initialize'\n  2014-08-20 16:14:22 +0900 [error]: /usr/lib/fluent/ruby/lib/ruby/gems/1.9.1/gems/fluentd-0.10.45/lib/fluent/plugin/in_tail.rb:529:in `open'\n```\n\n`apache`\u30ed\u30b0\u306e\u8aad\u307f\u53d6\u308a\u6a29\u9650\u304c\u306a\u3044\u3088\u3046\u306a\u306e\u3067\u4ed8\u4e0e\u3057\u3066\u3084\u308b\u3002\n\n```cmd:chmod\n$ sudo ls -ld /var/log/apache2/\ndrwxr-x--- 2 root adm 4096 Aug 20 16:11 /var/log/apache2/\n$ sudo chmod 755 /var/log/apache2/\n```\n\n\u5ff5\u306e\u305f\u3081`td-agent`\u306e\u518d\u8d77\u52d5\u3002\n\n```cmd:td-agent_restart\n$ /etc/init.d/td-agent restart\n$ tail -f /var/log/td-agent/td-agent.log\n</ROOT>\n2014-08-20 16:19:43 +0900 [info]: adding source type=\"tail\"\n2014-08-20 16:19:43 +0900 [info]: adding source type=\"forward\"\n2014-08-20 16:19:43 +0900 [info]: adding source type=\"http\"\n2014-08-20 16:19:43 +0900 [info]: adding source type=\"debug_agent\"\n2014-08-20 16:19:43 +0900 [info]: adding match pattern=\"td.*.*\" type=\"tdlog\"\n2014-08-20 16:19:43 +0900 [info]: adding match pattern=\"debug.**\" type=\"stdout\"\n2014-08-20 16:19:43 +0900 [info]: following tail of /var/log/apache2/access.log\n2014-08-20 16:19:43 +0900 [info]: listening fluent socket on 0.0.0.0:24224\n2014-08-20 16:19:43 +0900 [info]: listening dRuby uri=\"druby://127.0.0.1:24230\" object=\"Engine\"\n^C\n$ \n```\n\n\u3055\u3066\u3053\u308c\u3067\u5927\u4e08\u592b\u306a\u306f\u305a\u3002apache\u306b\u30a2\u30af\u30bb\u30b9\u3057\u3066\u307f\u308b\u3002\n\u5ff5\u306e\u305f\u30815\u56de\u3002\n\n```cmd:curl\n$ curl http://localhost\n$ curl http://localhost\n$ curl http://localhost\n$ curl http://localhost\n$ curl http://localhost\n$ sleep 10\n```\n\n```cmd:check_log\n$ sudo cat /var/log/apache2/access.log\n127.0.0.1 - - [20/Aug/2014:16:22:26 +0900] \"GET / HTTP/1.1\" 200 432 \"-\" \"curl/7.22.0 (x86_64-pc-linux-gnu) libcurl/7.22.0 OpenSSL/1.0.1 zlib/1.2.3.4 libidn/1.23 librtmp/2.3\"\n127.0.0.1 - - [20/Aug/2014:16:22:27 +0900] \"GET / HTTP/1.1\" 200 432 \"-\" \"curl/7.22.0 (x86_64-pc-linux-gnu) libcurl/7.22.0 OpenSSL/1.0.1 zlib/1.2.3.4 libidn/1.23 librtmp/2.3\"\n127.0.0.1 - - [20/Aug/2014:16:22:28 +0900] \"GET / HTTP/1.1\" 200 432 \"-\" \"curl/7.22.0 (x86_64-pc-linux-gnu) libcurl/7.22.0 OpenSSL/1.0.1 zlib/1.2.3.4 libidn/1.23 librtmp/2.3\"\n127.0.0.1 - - [20/Aug/2014:16:22:28 +0900] \"GET / HTTP/1.1\" 200 432 \"-\" \"curl/7.22.0 (x86_64-pc-linux-gnu) libcurl/7.22.0 OpenSSL/1.0.1 zlib/1.2.3.4 libidn/1.23 librtmp/2.3\"\n127.0.0.1 - - [20/Aug/2014:16:22:29 +0900] \"GET / HTTP/1.1\" 200 432 \"-\" \"curl/7.22.0 (x86_64-pc-linux-gnu) libcurl/7.22.0 OpenSSL/1.0.1 zlib/1.2.3.4 libidn/1.23 librtmp/2.3\"\n```\n\n## \u30a4\u30f3\u30dd\u30fc\u30c8\u78ba\u8a8d\n\n\u30a4\u30f3\u30dd\u30fc\u30c8\u78ba\u8a8d\u3002\n5\u4ef6\u306e\u30c7\u30fc\u30bf\u304c\u30a4\u30f3\u30dd\u30fc\u30c8\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002\n\n```cmd:check_import_data\n$ td table:list apache\n+----------+--------+------+-------+--------+---------------------------+---------------------------+----------------------------------------------------------------------------------------------------------+\n| Database | Table  | Type | Count | Size   | Last import               | Last log timestamp        | Schema                                                                                                   |\n+----------+--------+------+-------+--------+---------------------------+---------------------------+----------------------------------------------------------------------------------------------------------+\n| apache   | access | log  | 5     | 0.0 GB | 2014-08-20 16:22:30 +0900 | 2014-08-20 16:22:29 +0900 | host:string, path:string, method:string, referer:string, code:long, agent:string, user:string, size:long |\n+----------+--------+------+-------+--------+---------------------------+---------------------------+----------------------------------------------------------------------------------------------------------+\n1 row in set\n```\n\n\u5185\u5bb9\u3082\u78ba\u8a8d\u3057\u3066\u307f\u308b\u3002\n\n```cmd:td_query\n$ td query -w -t hive -d apache \"SELECT * FROM access\"\n+-----------+------+--------+---------+------+-----------------------------------------------------------------------------------------------------+------+------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------+\n| host      | path | method | referer | code | agent                                                                                               | user | size | v                                                                                                                                                                                                          | time       |\n+-----------+------+--------+---------+------+-----------------------------------------------------------------------------------------------------+------+------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------+\n| 127.0.0.1 | /    | GET    | null    | 200  | curl/7.22.0 (x86_64-pc-linux-gnu) libcurl/7.22.0 OpenSSL/1.0.1 zlib/1.2.3.4 libidn/1.23 librtmp/2.3 | null | 432  | {\"path\":\"/\",\"code\":\"200\",\"size\":\"432\",\"method\":\"GET\",\"host\":\"127.0.0.1\",\"time\":\"1408519346\",\"agent\":\"curl/7.22.0 (x86_64-pc-linux-gnu) libcurl/7.22.0 OpenSSL/1.0.1 zlib/1.2.3.4 libidn/1.23 librtmp/2.3\"} | 1408519346 |\n| 127.0.0.1 | /    | GET    | null    | 200  | curl/7.22.0 (x86_64-pc-linux-gnu) libcurl/7.22.0 OpenSSL/1.0.1 zlib/1.2.3.4 libidn/1.23 librtmp/2.3 | null | 432  | {\"path\":\"/\",\"code\":\"200\",\"size\":\"432\",\"method\":\"GET\",\"host\":\"127.0.0.1\",\"time\":\"1408519347\",\"agent\":\"curl/7.22.0 (x86_64-pc-linux-gnu) libcurl/7.22.0 OpenSSL/1.0.1 zlib/1.2.3.4 libidn/1.23 librtmp/2.3\"} | 1408519347 |\n| 127.0.0.1 | /    | GET    | null    | 200  | curl/7.22.0 (x86_64-pc-linux-gnu) libcurl/7.22.0 OpenSSL/1.0.1 zlib/1.2.3.4 libidn/1.23 librtmp/2.3 | null | 432  | {\"path\":\"/\",\"code\":\"200\",\"size\":\"432\",\"method\":\"GET\",\"host\":\"127.0.0.1\",\"time\":\"1408519348\",\"agent\":\"curl/7.22.0 (x86_64-pc-linux-gnu) libcurl/7.22.0 OpenSSL/1.0.1 zlib/1.2.3.4 libidn/1.23 librtmp/2.3\"} | 1408519348 |\n| 127.0.0.1 | /    | GET    | null    | 200  | curl/7.22.0 (x86_64-pc-linux-gnu) libcurl/7.22.0 OpenSSL/1.0.1 zlib/1.2.3.4 libidn/1.23 librtmp/2.3 | null | 432  | {\"path\":\"/\",\"code\":\"200\",\"size\":\"432\",\"method\":\"GET\",\"host\":\"127.0.0.1\",\"time\":\"1408519348\",\"agent\":\"curl/7.22.0 (x86_64-pc-linux-gnu) libcurl/7.22.0 OpenSSL/1.0.1 zlib/1.2.3.4 libidn/1.23 librtmp/2.3\"} | 1408519348 |\n| 127.0.0.1 | /    | GET    | null    | 200  | curl/7.22.0 (x86_64-pc-linux-gnu) libcurl/7.22.0 OpenSSL/1.0.1 zlib/1.2.3.4 libidn/1.23 librtmp/2.3 | null | 432  | {\"path\":\"/\",\"code\":\"200\",\"size\":\"432\",\"method\":\"GET\",\"time\":\"1408519349\",\"host\":\"127.0.0.1\",\"agent\":\"curl/7.22.0 (x86_64-pc-linux-gnu) libcurl/7.22.0 OpenSSL/1.0.1 zlib/1.2.3.4 libidn/1.23 librtmp/2.3\"} | 1408519349 |\n+-----------+------+--------+---------+------+-----------------------------------------------------------------------------------------------------+------+------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------+\n5 rows in set\n```\n\u3075\u3080\u3075\u3080\u3001\u3061\u3083\u3093\u3068\u5404\u30ab\u30e9\u30e0\u306b\u30c7\u30fc\u30bf\u304c\u5165\u3063\u3066\u308b\u3063\u307d\u3044\u3002\n\n\u304a\u3057\u307e\u3044\u3002\n"}