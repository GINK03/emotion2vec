{"context": "\u72b6\u614b\u306e\u4fdd\u6301/\u72b6\u614b\u9077\u79fb\u306b\u9577\u3051\u305fFSM\u3068\u3001\u305d\u306e\u72b6\u614b/\u72b6\u614b\u9077\u79fb\u3092\u6c38\u7d9a\u5316\u3059\u308bAkka-Persistent\u306e\u7d44\u307f\u5408\u308f\u305b\u3068\u3057\u3066PersistentFSM\u304c\u3042\u308b\u3002\n\u72b6\u614b\u3092\u6301\u3064Actor\u3067\u30a4\u30d9\u30f3\u30c8\u3092\u6c38\u7d9a\u5316\u3057\u305f\u3044\u30b1\u30fc\u30b9(EventSourcing\u306a\u3069)\u306b\u306f\u5f37\u529b\u306a\u6b66\u5668\u3068\u306a\u308b\u3002\n\u305f\u3060\u3001FSM\u3068\u540c\u69d8\u306b\u666e\u901a\u306eActor(PersistentActor)\u3067\u3082become\u3092\u4f7f\u3048\u3070\u72b6\u614b\u306f\u8868\u73fe\u3067\u304d\u308b\u306e\u3067\u4f7f\u3044\u3069\u3053\u308d\u306f\u96e3\u3057\u3044\u304b\u3082\u3057\u308c\u306a\u3044\u3002\n\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u306b\u3082\u3042\u308b\u3088\u3046\u306bexperimental\u306a\u3082\u306e\u306a\u306e\u3067\u6ce8\u610f(v2.4.9\u6642\u70b9)\n\n\u5b9f\u88c5\u306e\u4ed5\u65b9\nakka.actor.Actor\u306e\u4ee3\u308f\u308a\u306bakka.persistence.fsm.PersistentFSM\u3092extends\u3057\u3066\u3084\u308c\u3070\u3088\u3044\u3002\n\u901a\u5e38\u306eFSM\u306f\u578b\u30d1\u30e9\u30e1\u30fc\u30bf\u3068\u3057\u3066State\u3068Data\u306b\u3042\u305f\u308b\u578b\u30922\u3064\u8981\u6c42\u3057\u305f\u304c\u3001PersistentFSM\u3067\u306f\u578b\u30d1\u30e9\u30e1\u30fc\u30bf\u30923\u3064\u3001State/Data/Event\u306b\u5f53\u305f\u308b\u578b\u3092\u8981\u6c42\u3059\u308b\u3002\n\u307e\u305f\u3001State\u306fPersistentFSM.FSMState\u3092\u7d99\u627f\u3057\u305f\u578b\u3067\u306a\u3051\u308c\u3070\u306a\u3089\u306a\u3044\u3002\ntrait PersistentFSM[S <: FSMState, D, E] extends PersistentActor with PersistentFSMBase[S, D, E] with ActorLogging {\n  ...\n}\n\n\nState, Data, Event\u3092\u7528\u610f\u3059\u308b\n\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u306e\u30b5\u30f3\u30d7\u30eb\u306b\u3042\u308f\u305b\u3066\u30b7\u30e7\u30c3\u30d4\u30f3\u30b0\u30ab\u30fc\u30c8\u3063\u307d\u3044\u306e\u3092\u5b9f\u88c5\u3057\u3066\u307f\u308b\u3002\n\u30b5\u30f3\u30d7\u30eb\u30b3\u30fc\u30c9\u5168\u4f53\u306fGithub\u306b\u3042\u3052\u3066\u3042\u308b\u3002\n\u307e\u305a\u3001\u30b7\u30e7\u30c3\u30d4\u30f3\u30b0\u306e\u5bfe\u8c61\u3068\u306a\u308b\u5546\u54c1\u306b\u3042\u305f\u308b\u30c7\u30fc\u30bf\u578b\u3092\u7528\u610f\u3059\u308b\u3002\ncase class Item(name: String, price: Int)\n\n\nState\nState\u306fFSM\u306e\u72b6\u614b\u3092\u8868\u73fe\u3059\u308b\u578b\u306b\u3042\u305f\u308a\u3001PersistentFSM.FSMState\u3092extends\u3057\u3066\u304a\u304f\u3002\nidentifier: String\u3092override\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u306e\u3067\u9069\u5f53\u306b\u5b9f\u88c5\u3057\u3066\u304a\u304f\u3002\nsealed trait ShoppingState extends PersistentFSM.FSMState {\n  override def identifier: String = s\"my-event: ${getClass.getSimpleName}\"\n}\ncase object Looking extends ShoppingState\ncase object Shopping extends ShoppingState\ncase object Purchased extends ShoppingState\n\n\nData\nFSM\u306e\u5185\u90e8\u306b\u4fdd\u6301\u3059\u308b\u30c7\u30fc\u30bf\u3068\u306a\u308b\u3002\n\u4eca\u56de\u306fSet[Item]\u3068\u3057\u305f\u3002\ncase class ShoppingData private[ShoppingData] (items: Set[Item]) {\n  // \u5408\u8a08price\n  def price: Int = items.map(_.price).sum\n}\nobject ShoppingData {\n  // \u521d\u671f\u72b6\u614b\u3068\u306a\u308b\u3082\u306e\n  val empty = ShoppingData(Set.empty)\n}\n\n\nEvent\nFSM\u306e\u72b6\u614b\u3092\u5909\u5316\u3055\u305b\u308b\u30a4\u30d9\u30f3\u30c8\u3068\u306a\u308b\u3002\n\u72b6\u614b\u3060\u3051\u3067\u306a\u304f\u5185\u90e8\u30c7\u30fc\u30bf\u306b\u3082\u5f71\u97ff\u3092\u53ca\u307c\u3059\u30a4\u30d9\u30f3\u30c8\u3082\u7528\u610f\u3059\u308b\u3002\nsealed trait ShoppingEvent\n// \u5185\u90e8\u30c7\u30fc\u30bf(ShoppingData)\u306b\u5f71\u97ff\u3059\u308b\ncase class AddItem(item: Item) extends ShoppingEvent\ncase class RemoveItem(item: Item) extends ShoppingEvent\n// \u72b6\u614b\u9077\u79fb\u3059\u308b\u3060\u3051\ncase object Purchase extends ShoppingEvent\ncase object Leave extends ShoppingEvent\n\n\nPersistentFSM\u3092\u5b9f\u88c5\u3059\u308b\nState/Data/Event\u306b\u3042\u305f\u308b\u578b\u304c\u7528\u610f\u51fa\u6765\u305f\u306e\u3067\u3001\u3088\u3046\u3084\u304fPersistentFSM\u3092\u5b9f\u88c5\u3067\u304d\u308b\u3002\n\u5b9f\u88c5\u5168\u4f53\u3092\u306e\u305b\u308b\u3002\nclass Customer(implicit val domainEventClassTag: ClassTag[ShoppingEvent])\n  extends PersistentFSM[ShoppingState, ShoppingData, ShoppingEvent] {\n\n  // PersistentActor#persistenceId\u3068\u540c\u3058\u3082\u306e\n  override def persistenceId: String = \"example-persistence-FSM\"\n\n  // \u72b6\u614b\u5909\u5316\u3059\u308b\u969b\u306b\u9069\u7528\u3055\u308c\u308b\u30e1\u30bd\u30c3\u30c9\u3067\u3001\u5185\u90e8\u30c7\u30fc\u30bf\u3092\u5909\u5316\u3055\u305b\u308b\n  // `[stay|goty] applying ???`\u3068\u3057\u305f\u6642\u306b\u547c\u3070\u308c\u308b\n  override def applyEvent(domainEvent: ShoppingEvent, currentData: ShoppingData): ShoppingData = {\n    log.info(s\"\\n***applyEvent: $domainEvent, $currentData, state: $stateName\")\n    domainEvent match {\n      case AddItem(item) =>\n        // \u30ab\u30fc\u30c8\u306bItem\u3092\u8ffd\u52a0\n        currentData.copy(items = currentData.items + item)\n      case RemoveItem(item) =>\n        // \u30ab\u30fc\u30c8\u304b\u3089Item\u3092\u9664\u53bb\n        currentData.copy(items = currentData.items - item)\n      case Purchase =>\n        // \u8cfc\u5165\u3059\u308b\u3002\u30ab\u30fc\u30c8\u306f\u7a7a\u306b\u306a\u308b\u3002\n        println(s\"price => ${currentData.price}\")\n        ShoppingData.empty\n      case Leave =>\n        // \u30b7\u30e7\u30c3\u30d4\u30f3\u30b0\u7d42\u4e86\u3002\n        ShoppingData.empty\n    }\n  }\n\n  // \u521d\u671fState\u3068\u521d\u671fData\n  startWith(Looking, ShoppingData.empty)\n\n  // FSM\u3068\u540c\u69d8\u3002`when(\u73fe\u5728\u306e\u72b6\u614b) { \u30a4\u30d9\u30f3\u30c8\u30cf\u30f3\u30c9\u30e9 }`\u3068\u3044\u3046\u69cb\u9020\n  when(Looking) {\n    case Event(addItem: AddItem, _) =>\n      // Looking\u72b6\u614b\u304b\u3089AddItem\u3067Shopping\u72b6\u614b\u306b\u79fb\u884c\n      gotoLogging(Shopping) applying addItem andThen {\n        // andThen\u3067applyEvent\u5f8c\u306e\u30a4\u30d9\u30f3\u30c8\u30cf\u30f3\u30c9\u30e9\u3092\u8a2d\u5b9a\u3067\u304d\u308b\n        case afterAddItem => log.info(s\"after => $afterAddItem\")\n      }\n  }\n\n  when(Shopping) {\n    case Event(addItem: AddItem, _) =>\n      // Shopping\u72b6\u614b\u3067AddItem\u3057\u3066\u3082\u72b6\u614b\u306f\u5909\u5316\u3057\u306a\u3044\u304c\u3001AddItem\u306f\u9069\u7528\u3059\u308b\n      stay applying addItem\n\n    case Event(removeItem: RemoveItem, _) =>\n      // Shopping\u72b6\u614b\u3067RemoveItem\u3057\u3066\u3082\u72b6\u614b\u306f\u5909\u5316\u3057\u306a\u3044\u304c\u3001RemoveItem\u306f\u9069\u7528\u3059\u308b\n        stay applying removeItem\n\n    case Event(Purchase, _) =>\n      // Shopping\u72b6\u614b\u3067Purchase\u3059\u308b\u3068Purchased\u72b6\u614b\u306b\u79fb\u884c\n      goto(Purchased) applying Purchase\n  }\n\n  when(Purchased) {\n    case Event(Leave, _) =>\n      // Purchased\u72b6\u614b\u304b\u3089Leave\u3059\u308b\u3053\u3068\u3067Looking\u72b6\u614b\u306b\u623b\u308b\n      goto(Looking) applying Leave\n  }\n\n  // \u72b6\u614b\u9077\u79fb\u30cf\u30f3\u30c9\u30e9\n  onTransition {\n    case Purchased -> Looking =>\n      // \u30b7\u30e7\u30c3\u30d4\u30f3\u30b0\u7d42\u4e86\u6642\u306bsnapshot\u3092\u3068\u3063\u3066\u304a\u304f\n      saveStateSnapshot()\n  }\n\n}\n\ndomainEventClassTag\u3092\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u5185\u90e8\u3067\u5b9a\u7fa9\u3057\u3088\u3046\u3068\u3059\u308b\u3068StackOverFlow\u304c\u767a\u751f\u3057\u305f\u306e\u3067\u5916\u304b\u3089\u6e21\u3059\u5f62\u3068\u3057\u305f\u3002\n  ...\n  // StackOverFlow\u304c\u767a\u751f\u3057\u3066\u3057\u307e\u3046\n  implicit val domainEventClassTag: ClassTag[ShoppingEvent] = classTag[ShoppingEvent]\n  ...\n\n\u5b9f\u88c5\u81ea\u4f53\u3092\u898b\u308b\u3068\u3001akka.actor.FSM\u304c\u30d9\u30fc\u30b9\u306b\u306a\u3063\u3066\u3044\u3066\u3001when,onTransition\u3067\u72b6\u614b\u9077\u79fb\u3068\u305d\u306e\u30cf\u30f3\u30c9\u30e9\u3092\u5b9a\u7fa9\u3059\u308c\u3070\u826f\u3044\u3002\n\u305f\u3060\u3057\u3001FSM\u3068\u306fusing\u306e\u4ee3\u308f\u308a\u306bapplying\u3092\u4f7f\u7528\u3059\u308b\u3068\u3044\u3046\u70b9\u304c\u7570\u306a\u308b\n\u307e\u305f\u3001PersistentActor\u306e\u3088\u3046\u306bpersist\u3092\u660e\u793a\u7684\u306b\u547c\u3070\u306a\u304f\u3066\u3082applyEvent\u306b\u6e21\u3063\u3066\u304f\u308bdomainEvent\u306f\u81ea\u52d5\u7684\u306bpersist\u3055\u308c\u3066\u3044\u308b\u6a21\u69d8\u3002\n\u30b5\u30f3\u30d7\u30eb\u3067\u306finitialize\u3092\u5b9f\u884c\u3057\u3066\u3044\u308b\u304c\u3001ver2.4.5\u304b\u3089\u306f\u5185\u90e8API\u3068\u306a\u3063\u305f\u305f\u3081\u4e0d\u8981\u3002\n\nandThen\u306e\u6ce8\u610f\u70b9\n\u30ab\u30fc\u30c8\u5185\u306eItem\u304c1\u3064\u306e\u6642\u306bRemoveItem\u3055\u308c\u305f\u3089Looking\u306b\u623b\u3057\u305f\u3044\u3002\n\u30a4\u30d9\u30f3\u30c8\u9069\u7528\u5f8c\u306e\u30a4\u30d9\u30f3\u30c8\u30cf\u30f3\u30c9\u30e9\u3092\u8a2d\u5b9a\u3059\u308b\u305f\u3081\u306eandThen\u3068\u3044\u3046API\u304c\u3042\u308b\u305f\u3081\u305d\u308c\u304c\u4f7f\u3048\u305d\u3046\u306a\u306e\u3067\u5b9f\u88c5\u3057\u3066\u307f\u308b\u3002\ncase Event(removeItem: RemoveItem, _) =>\n  stay applying removeItem andThen {\n    // currentData\u306b\u5bfe\u3059\u308b\u30a4\u30d9\u30f3\u30c8\u30cf\u30f3\u30c9\u30e9(`afterTransitionDo`)\u3092\u8a2d\u5b9a\n    case ShoppingData.empty => goto(Looking)\n  }\n\n\u3057\u304b\u3057\u3001\u5b9f\u969b\u306b\u306fandThen\u5185\u306egoto\u3084stay\u3067\u306f\u72b6\u614b\u9077\u79fb\u3055\u305b\u308b\u3053\u3068\u304c\u51fa\u6765\u306a\u304b\u3063\u305f...\u3002\n\u89e3\u6c7a\u3059\u308b\u306b\u306fwhen\u306b\u5bfe\u3059\u308b\u30cf\u30f3\u30c9\u30e9\u3068\u3057\u3066\u305d\u308c\u3092\u5b9f\u88c5\u3057\u306a\u3051\u308c\u3070\u306a\u3089\u306a\u3044\u3002\nwhen(Shopping) {\n  ...\n  case Event(removeItem: RemoveItem, ShoppingData.empty) =>\n    // currentData\u304cempty\u306a\u3089\u8a31\u53ef\u3055\u308c\u3066\u3044\u306a\u3044\u51e6\u7406\n    throw new IllegalStateException(\"ShoppingCart is Empty\")\n\n  case Event(removeItem @ RemoveItem(item), ShoppingData(items)) if items.size == 1 && (items contains item) =>\n    // 1\u3064\u3057\u304b\u306a\u3044item\u304cremove\u3055\u308c\u308b\u5834\u5408\n    gotoLogging(Looking) applying removeItem\n\n  case Event(removeItem: RemoveItem, _) =>\n    // \u901a\u5e38\u306e\u52d5\u4f5c\n    stayLogging applying removeItem\n  ...\n}\n\n\u4f55\u306e\u305f\u3081\u306eandThen\u306a\u306e\u304b...\u3068\u8a00\u3044\u305f\u304f\u306a\u308b\u304c\u3001\n\u6050\u3089\u304f\u72b6\u614b\u9077\u79fb\u3092\u4fc3\u3059\u3088\u3046\u306a\u30c9\u30e1\u30a4\u30f3\u30a4\u30d9\u30f3\u30c8\u3092\u30e1\u30c3\u30bb\u30fc\u30b8\u3068\u3057\u3066\u53d7\u3051\u53d6\u3089\u305a\u306b\u5185\u90e8\u7684\u306b\u72b6\u614b\u9077\u79fb\u3059\u308b\u3068\u3001\u6c38\u7d9a\u5316\u3057\u3066\u3042\u308b\u30e1\u30c3\u30bb\u30fc\u30b8\u3092replay\u3057\u3066\u3082\u72b6\u614b\u306e\u5fa9\u5143\u304c\u51fa\u6765\u306a\u304f\u306a\u3063\u3066\u3057\u307e\u3046\u304b\u3089\u3067\u306f\u306a\u3044\u304b\u3068\u601d\u308f\u308c\u308b\u3002  \n\u4eca\u56de\u306e\u3088\u3046\u306a\u30b1\u30fc\u30b9\u3067\u306fwhen\u306e\u30cf\u30f3\u30c9\u30e9\u3067\u4e8b\u524d\u306b\u691c\u67fb\u3059\u308b\u3057\u304b\u306a\u3044(\u306f\u305a)\u3002\nShopping\u304b\u3089Looking\u306b\u623b\u3059\u3088\u3046\u306a\u30a4\u30d9\u30f3\u30c8\u3092\u5b9a\u7fa9\u3057\u3066self\u306b!(tell)\u3059\u308b\u306e\u3082\u8003\u3048\u3089\u308c\u308b\u304c\u3001\u30e1\u30c3\u30bb\u30fc\u30b8\u304c\u76f4\u5f8c\u306b\u51e6\u7406\u3055\u308c\u308b\u3068\u306f\u9650\u3089\u306a\u3044\u305f\u3081\u4e0a\u624b\u304f\u3044\u304b\u306a\u3044\u30b1\u30fc\u30b9\u3082\u591a\u3044\u3002\n\nRecovery\nAkka-Persistence\u3067\u5927\u4e8b\u306a\u72b6\u614b\u306e\u5fa9\u5143\u3002\nPersistentFSM\u306e\u5834\u5408\u3001Actor\u8d77\u52d5\u6642\u306bSnapshot\u3068journal\u304b\u3089\u81ea\u52d5\u3067\u72b6\u614b\u3092recovery\u3057\u3066\u304f\u308c\u308b\u3002\n\u666e\u901a\u306ePersistentActor\u3068\u540c\u69d8\u306b\u3001\u6700\u65b0\u306eSnapshot\u3092\u9069\u7528\u3057\u305f\u5f8c\u306b\u3001\u305d\u306eSnapshot\u63a1\u53d6\u5f8c\u306e\u30a4\u30d9\u30f3\u30c8\u3092journal\u304b\u3089\u8aad\u307f\u3060\u3057\u3066\u305d\u308c\u3082\u9069\u7528\u3057\u3066\u304f\u308c\u308b\u3002\nrecovery\u304c\u5b8c\u4e86\u3057\u305f\u3089\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u3068\u3057\u3066onRecoveryCompleted\u304c\u5b9f\u884c\u3055\u308c\u308b\u3002\n\n\u72b6\u614b\u306e\u4fdd\u6301/\u72b6\u614b\u9077\u79fb\u306b\u9577\u3051\u305f[FSM](http://doc.akka.io/docs/akka/current/scala/fsm.html)\u3068\u3001\u305d\u306e\u72b6\u614b/\u72b6\u614b\u9077\u79fb\u3092\u6c38\u7d9a\u5316\u3059\u308b[Akka-Persistent](http://doc.akka.io/docs/akka/current/scala/persistence.html)\u306e\u7d44\u307f\u5408\u308f\u305b\u3068\u3057\u3066[PersistentFSM](http://doc.akka.io/docs/akka/current/scala/persistence.html#Persistent_FSM)\u304c\u3042\u308b\u3002\n\n\u72b6\u614b\u3092\u6301\u3064Actor\u3067\u30a4\u30d9\u30f3\u30c8\u3092\u6c38\u7d9a\u5316\u3057\u305f\u3044\u30b1\u30fc\u30b9(EventSourcing\u306a\u3069)\u306b\u306f\u5f37\u529b\u306a\u6b66\u5668\u3068\u306a\u308b\u3002\n\u305f\u3060\u3001`FSM`\u3068\u540c\u69d8\u306b\u666e\u901a\u306eActor(PersistentActor)\u3067\u3082`become`\u3092\u4f7f\u3048\u3070\u72b6\u614b\u306f\u8868\u73fe\u3067\u304d\u308b\u306e\u3067\u4f7f\u3044\u3069\u3053\u308d\u306f\u96e3\u3057\u3044\u304b\u3082\u3057\u308c\u306a\u3044\u3002\n\n\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u306b\u3082\u3042\u308b\u3088\u3046\u306bexperimental\u306a\u3082\u306e\u306a\u306e\u3067\u6ce8\u610f(v2.4.9\u6642\u70b9)\n\n# \u5b9f\u88c5\u306e\u4ed5\u65b9\n\n`akka.actor.Actor`\u306e\u4ee3\u308f\u308a\u306b`akka.persistence.fsm.PersistentFSM`\u3092extends\u3057\u3066\u3084\u308c\u3070\u3088\u3044\u3002\n\n\u901a\u5e38\u306eFSM\u306f\u578b\u30d1\u30e9\u30e1\u30fc\u30bf\u3068\u3057\u3066State\u3068Data\u306b\u3042\u305f\u308b\u578b\u30922\u3064\u8981\u6c42\u3057\u305f\u304c\u3001`PersistentFSM`\u3067\u306f\u578b\u30d1\u30e9\u30e1\u30fc\u30bf\u30923\u3064\u3001State/Data/Event\u306b\u5f53\u305f\u308b\u578b\u3092\u8981\u6c42\u3059\u308b\u3002\n\u307e\u305f\u3001State\u306f`PersistentFSM.FSMState`\u3092\u7d99\u627f\u3057\u305f\u578b\u3067\u306a\u3051\u308c\u3070\u306a\u3089\u306a\u3044\u3002\n\n```scala\ntrait PersistentFSM[S <: FSMState, D, E] extends PersistentActor with PersistentFSMBase[S, D, E] with ActorLogging {\n  ...\n}\n```\n\n## State, Data, Event\u3092\u7528\u610f\u3059\u308b\n\n[\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u306e\u30b5\u30f3\u30d7\u30eb](http://doc.akka.io/docs/akka/current/scala/persistence.html#Persistent_FSM)\u306b\u3042\u308f\u305b\u3066\u30b7\u30e7\u30c3\u30d4\u30f3\u30b0\u30ab\u30fc\u30c8\u3063\u307d\u3044\u306e\u3092\u5b9f\u88c5\u3057\u3066\u307f\u308b\u3002\n\u30b5\u30f3\u30d7\u30eb\u30b3\u30fc\u30c9\u5168\u4f53\u306f[Github](https://github.com/petitviolet/akka-persistent-actor-ex/blob/master/src/main/scala/net/petitviolet/ex/persistence/practice/fsm/PersistentFSMSample.scala)\u306b\u3042\u3052\u3066\u3042\u308b\u3002\n\n\u307e\u305a\u3001\u30b7\u30e7\u30c3\u30d4\u30f3\u30b0\u306e\u5bfe\u8c61\u3068\u306a\u308b\u5546\u54c1\u306b\u3042\u305f\u308b\u30c7\u30fc\u30bf\u578b\u3092\u7528\u610f\u3059\u308b\u3002\n\n```scala\ncase class Item(name: String, price: Int)\n```\n\n### State\n\nState\u306fFSM\u306e\u72b6\u614b\u3092\u8868\u73fe\u3059\u308b\u578b\u306b\u3042\u305f\u308a\u3001`PersistentFSM.FSMState`\u3092extends\u3057\u3066\u304a\u304f\u3002\n`identifier: String`\u3092override\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u306e\u3067\u9069\u5f53\u306b\u5b9f\u88c5\u3057\u3066\u304a\u304f\u3002\n\n```scala\nsealed trait ShoppingState extends PersistentFSM.FSMState {\n  override def identifier: String = s\"my-event: ${getClass.getSimpleName}\"\n}\ncase object Looking extends ShoppingState\ncase object Shopping extends ShoppingState\ncase object Purchased extends ShoppingState\n```\n\n### Data\n\nFSM\u306e\u5185\u90e8\u306b\u4fdd\u6301\u3059\u308b\u30c7\u30fc\u30bf\u3068\u306a\u308b\u3002\n\u4eca\u56de\u306f`Set[Item]`\u3068\u3057\u305f\u3002\n\n```scala\ncase class ShoppingData private[ShoppingData] (items: Set[Item]) {\n  // \u5408\u8a08price\n  def price: Int = items.map(_.price).sum\n}\nobject ShoppingData {\n  // \u521d\u671f\u72b6\u614b\u3068\u306a\u308b\u3082\u306e\n  val empty = ShoppingData(Set.empty)\n}\n```\n\n### Event\n\nFSM\u306e\u72b6\u614b\u3092\u5909\u5316\u3055\u305b\u308b\u30a4\u30d9\u30f3\u30c8\u3068\u306a\u308b\u3002\n\u72b6\u614b\u3060\u3051\u3067\u306a\u304f\u5185\u90e8\u30c7\u30fc\u30bf\u306b\u3082\u5f71\u97ff\u3092\u53ca\u307c\u3059\u30a4\u30d9\u30f3\u30c8\u3082\u7528\u610f\u3059\u308b\u3002\n\n```scala\nsealed trait ShoppingEvent\n// \u5185\u90e8\u30c7\u30fc\u30bf(ShoppingData)\u306b\u5f71\u97ff\u3059\u308b\ncase class AddItem(item: Item) extends ShoppingEvent\ncase class RemoveItem(item: Item) extends ShoppingEvent\n// \u72b6\u614b\u9077\u79fb\u3059\u308b\u3060\u3051\ncase object Purchase extends ShoppingEvent\ncase object Leave extends ShoppingEvent\n```\n\n## PersistentFSM\u3092\u5b9f\u88c5\u3059\u308b\n\nState/Data/Event\u306b\u3042\u305f\u308b\u578b\u304c\u7528\u610f\u51fa\u6765\u305f\u306e\u3067\u3001\u3088\u3046\u3084\u304f`PersistentFSM`\u3092\u5b9f\u88c5\u3067\u304d\u308b\u3002\n\u5b9f\u88c5\u5168\u4f53\u3092\u306e\u305b\u308b\u3002\n\n```scala\nclass Customer(implicit val domainEventClassTag: ClassTag[ShoppingEvent])\n  extends PersistentFSM[ShoppingState, ShoppingData, ShoppingEvent] {\n\n  // PersistentActor#persistenceId\u3068\u540c\u3058\u3082\u306e\n  override def persistenceId: String = \"example-persistence-FSM\"\n\n  // \u72b6\u614b\u5909\u5316\u3059\u308b\u969b\u306b\u9069\u7528\u3055\u308c\u308b\u30e1\u30bd\u30c3\u30c9\u3067\u3001\u5185\u90e8\u30c7\u30fc\u30bf\u3092\u5909\u5316\u3055\u305b\u308b\n  // `[stay|goty] applying ???`\u3068\u3057\u305f\u6642\u306b\u547c\u3070\u308c\u308b\n  override def applyEvent(domainEvent: ShoppingEvent, currentData: ShoppingData): ShoppingData = {\n    log.info(s\"\\n***applyEvent: $domainEvent, $currentData, state: $stateName\")\n    domainEvent match {\n      case AddItem(item) =>\n        // \u30ab\u30fc\u30c8\u306bItem\u3092\u8ffd\u52a0\n        currentData.copy(items = currentData.items + item)\n      case RemoveItem(item) =>\n        // \u30ab\u30fc\u30c8\u304b\u3089Item\u3092\u9664\u53bb\n        currentData.copy(items = currentData.items - item)\n      case Purchase =>\n        // \u8cfc\u5165\u3059\u308b\u3002\u30ab\u30fc\u30c8\u306f\u7a7a\u306b\u306a\u308b\u3002\n        println(s\"price => ${currentData.price}\")\n        ShoppingData.empty\n      case Leave =>\n        // \u30b7\u30e7\u30c3\u30d4\u30f3\u30b0\u7d42\u4e86\u3002\n        ShoppingData.empty\n    }\n  }\n\n  // \u521d\u671fState\u3068\u521d\u671fData\n  startWith(Looking, ShoppingData.empty)\n\n  // FSM\u3068\u540c\u69d8\u3002`when(\u73fe\u5728\u306e\u72b6\u614b) { \u30a4\u30d9\u30f3\u30c8\u30cf\u30f3\u30c9\u30e9 }`\u3068\u3044\u3046\u69cb\u9020\n  when(Looking) {\n    case Event(addItem: AddItem, _) =>\n      // Looking\u72b6\u614b\u304b\u3089AddItem\u3067Shopping\u72b6\u614b\u306b\u79fb\u884c\n      gotoLogging(Shopping) applying addItem andThen {\n        // andThen\u3067applyEvent\u5f8c\u306e\u30a4\u30d9\u30f3\u30c8\u30cf\u30f3\u30c9\u30e9\u3092\u8a2d\u5b9a\u3067\u304d\u308b\n        case afterAddItem => log.info(s\"after => $afterAddItem\")\n      }\n  }\n\n  when(Shopping) {\n    case Event(addItem: AddItem, _) =>\n      // Shopping\u72b6\u614b\u3067AddItem\u3057\u3066\u3082\u72b6\u614b\u306f\u5909\u5316\u3057\u306a\u3044\u304c\u3001AddItem\u306f\u9069\u7528\u3059\u308b\n      stay applying addItem\n\n    case Event(removeItem: RemoveItem, _) =>\n      // Shopping\u72b6\u614b\u3067RemoveItem\u3057\u3066\u3082\u72b6\u614b\u306f\u5909\u5316\u3057\u306a\u3044\u304c\u3001RemoveItem\u306f\u9069\u7528\u3059\u308b\n        stay applying removeItem\n\n    case Event(Purchase, _) =>\n      // Shopping\u72b6\u614b\u3067Purchase\u3059\u308b\u3068Purchased\u72b6\u614b\u306b\u79fb\u884c\n      goto(Purchased) applying Purchase\n  }\n\n  when(Purchased) {\n    case Event(Leave, _) =>\n      // Purchased\u72b6\u614b\u304b\u3089Leave\u3059\u308b\u3053\u3068\u3067Looking\u72b6\u614b\u306b\u623b\u308b\n      goto(Looking) applying Leave\n  }\n\n  // \u72b6\u614b\u9077\u79fb\u30cf\u30f3\u30c9\u30e9\n  onTransition {\n    case Purchased -> Looking =>\n      // \u30b7\u30e7\u30c3\u30d4\u30f3\u30b0\u7d42\u4e86\u6642\u306bsnapshot\u3092\u3068\u3063\u3066\u304a\u304f\n      saveStateSnapshot()\n  }\n\n}\n```\n\n`domainEventClassTag`\u3092\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u5185\u90e8\u3067\u5b9a\u7fa9\u3057\u3088\u3046\u3068\u3059\u308b\u3068StackOverFlow\u304c\u767a\u751f\u3057\u305f\u306e\u3067\u5916\u304b\u3089\u6e21\u3059\u5f62\u3068\u3057\u305f\u3002\n\n```scala\n  ...\n  // StackOverFlow\u304c\u767a\u751f\u3057\u3066\u3057\u307e\u3046\n  implicit val domainEventClassTag: ClassTag[ShoppingEvent] = classTag[ShoppingEvent]\n  ...\n```\n\n\u5b9f\u88c5\u81ea\u4f53\u3092\u898b\u308b\u3068\u3001`akka.actor.FSM`\u304c\u30d9\u30fc\u30b9\u306b\u306a\u3063\u3066\u3044\u3066\u3001`when`,`onTransition`\u3067\u72b6\u614b\u9077\u79fb\u3068\u305d\u306e\u30cf\u30f3\u30c9\u30e9\u3092\u5b9a\u7fa9\u3059\u308c\u3070\u826f\u3044\u3002\n\u305f\u3060\u3057\u3001`FSM`\u3068\u306f`using`\u306e\u4ee3\u308f\u308a\u306b`applying`\u3092\u4f7f\u7528\u3059\u308b\u3068\u3044\u3046\u70b9\u304c\u7570\u306a\u308b\n\u307e\u305f\u3001`PersistentActor`\u306e\u3088\u3046\u306b`persist`\u3092\u660e\u793a\u7684\u306b\u547c\u3070\u306a\u304f\u3066\u3082`applyEvent`\u306b\u6e21\u3063\u3066\u304f\u308b`domainEvent`\u306f\u81ea\u52d5\u7684\u306b`persist`\u3055\u308c\u3066\u3044\u308b\u6a21\u69d8\u3002\n\n\u30b5\u30f3\u30d7\u30eb\u3067\u306f[`initialize`\u3092\u5b9f\u884c\u3057\u3066\u3044\u308b](https://github.com/vrcod/akka-sample-persistent-fsm/blob/master/src/main/scala/PersistentFSMExample.scala#L73)\u304c\u3001ver2.4.5\u304b\u3089\u306f\u5185\u90e8API\u3068\u306a\u3063\u305f\u305f\u3081\u4e0d\u8981\u3002\n\n### andThen\u306e\u6ce8\u610f\u70b9\n\n\u30ab\u30fc\u30c8\u5185\u306e`Item`\u304c1\u3064\u306e\u6642\u306b`RemoveItem`\u3055\u308c\u305f\u3089`Looking`\u306b\u623b\u3057\u305f\u3044\u3002\n\n\u30a4\u30d9\u30f3\u30c8\u9069\u7528\u5f8c\u306e\u30a4\u30d9\u30f3\u30c8\u30cf\u30f3\u30c9\u30e9\u3092\u8a2d\u5b9a\u3059\u308b\u305f\u3081\u306e`andThen`\u3068\u3044\u3046API\u304c\u3042\u308b\u305f\u3081\u305d\u308c\u304c\u4f7f\u3048\u305d\u3046\u306a\u306e\u3067\u5b9f\u88c5\u3057\u3066\u307f\u308b\u3002\n\n```scala\ncase Event(removeItem: RemoveItem, _) =>\n  stay applying removeItem andThen {\n    // currentData\u306b\u5bfe\u3059\u308b\u30a4\u30d9\u30f3\u30c8\u30cf\u30f3\u30c9\u30e9(`afterTransitionDo`)\u3092\u8a2d\u5b9a\n    case ShoppingData.empty => goto(Looking)\n  }\n```\n\n\u3057\u304b\u3057\u3001\u5b9f\u969b\u306b\u306f`andThen`\u5185\u306e`goto`\u3084`stay`\u3067\u306f\u72b6\u614b\u9077\u79fb\u3055\u305b\u308b\u3053\u3068\u304c\u51fa\u6765\u306a\u304b\u3063\u305f...\u3002\n\u89e3\u6c7a\u3059\u308b\u306b\u306f`when`\u306b\u5bfe\u3059\u308b\u30cf\u30f3\u30c9\u30e9\u3068\u3057\u3066\u305d\u308c\u3092\u5b9f\u88c5\u3057\u306a\u3051\u308c\u3070\u306a\u3089\u306a\u3044\u3002\n\n```scala\nwhen(Shopping) {\n  ...\n  case Event(removeItem: RemoveItem, ShoppingData.empty) =>\n    // currentData\u304cempty\u306a\u3089\u8a31\u53ef\u3055\u308c\u3066\u3044\u306a\u3044\u51e6\u7406\n    throw new IllegalStateException(\"ShoppingCart is Empty\")\n\n  case Event(removeItem @ RemoveItem(item), ShoppingData(items)) if items.size == 1 && (items contains item) =>\n    // 1\u3064\u3057\u304b\u306a\u3044item\u304cremove\u3055\u308c\u308b\u5834\u5408\n    gotoLogging(Looking) applying removeItem\n\n  case Event(removeItem: RemoveItem, _) =>\n    // \u901a\u5e38\u306e\u52d5\u4f5c\n    stayLogging applying removeItem\n  ...\n}\n```  \n\n\u4f55\u306e\u305f\u3081\u306e`andThen`\u306a\u306e\u304b...\u3068\u8a00\u3044\u305f\u304f\u306a\u308b\u304c\u3001\n\u6050\u3089\u304f\u72b6\u614b\u9077\u79fb\u3092\u4fc3\u3059\u3088\u3046\u306a\u30c9\u30e1\u30a4\u30f3\u30a4\u30d9\u30f3\u30c8\u3092\u30e1\u30c3\u30bb\u30fc\u30b8\u3068\u3057\u3066\u53d7\u3051\u53d6\u3089\u305a\u306b\u5185\u90e8\u7684\u306b\u72b6\u614b\u9077\u79fb\u3059\u308b\u3068\u3001\u6c38\u7d9a\u5316\u3057\u3066\u3042\u308b\u30e1\u30c3\u30bb\u30fc\u30b8\u3092replay\u3057\u3066\u3082\u72b6\u614b\u306e\u5fa9\u5143\u304c\u51fa\u6765\u306a\u304f\u306a\u3063\u3066\u3057\u307e\u3046\u304b\u3089\u3067\u306f\u306a\u3044\u304b\u3068\u601d\u308f\u308c\u308b\u3002  \n\n\u4eca\u56de\u306e\u3088\u3046\u306a\u30b1\u30fc\u30b9\u3067\u306f`when`\u306e\u30cf\u30f3\u30c9\u30e9\u3067\u4e8b\u524d\u306b\u691c\u67fb\u3059\u308b\u3057\u304b\u306a\u3044(\u306f\u305a)\u3002\n`Shopping`\u304b\u3089`Looking`\u306b\u623b\u3059\u3088\u3046\u306a\u30a4\u30d9\u30f3\u30c8\u3092\u5b9a\u7fa9\u3057\u3066`self`\u306b`!`(`tell`)\u3059\u308b\u306e\u3082\u8003\u3048\u3089\u308c\u308b\u304c\u3001\u30e1\u30c3\u30bb\u30fc\u30b8\u304c\u76f4\u5f8c\u306b\u51e6\u7406\u3055\u308c\u308b\u3068\u306f\u9650\u3089\u306a\u3044\u305f\u3081\u4e0a\u624b\u304f\u3044\u304b\u306a\u3044\u30b1\u30fc\u30b9\u3082\u591a\u3044\u3002\n\n# Recovery\n\nAkka-Persistence\u3067\u5927\u4e8b\u306a\u72b6\u614b\u306e\u5fa9\u5143\u3002\n`PersistentFSM`\u306e\u5834\u5408\u3001Actor\u8d77\u52d5\u6642\u306bSnapshot\u3068journal\u304b\u3089\u81ea\u52d5\u3067\u72b6\u614b\u3092recovery\u3057\u3066\u304f\u308c\u308b\u3002\n\u666e\u901a\u306e`PersistentActor`\u3068\u540c\u69d8\u306b\u3001\u6700\u65b0\u306eSnapshot\u3092\u9069\u7528\u3057\u305f\u5f8c\u306b\u3001\u305d\u306eSnapshot\u63a1\u53d6\u5f8c\u306e\u30a4\u30d9\u30f3\u30c8\u3092journal\u304b\u3089\u8aad\u307f\u3060\u3057\u3066\u305d\u308c\u3082\u9069\u7528\u3057\u3066\u304f\u308c\u308b\u3002\nrecovery\u304c\u5b8c\u4e86\u3057\u305f\u3089\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u3068\u3057\u3066`onRecoveryCompleted`\u304c\u5b9f\u884c\u3055\u308c\u308b\u3002\n", "tags": ["actor", "Scala", "Akka"]}