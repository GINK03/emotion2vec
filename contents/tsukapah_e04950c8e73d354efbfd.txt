{"context": "\n\n\u524d\u63d0\nElasticsearch : 5.2.0\nEmbulk : v0.8.16\nELB\u306e\u30ed\u30b0\u306b\u3064\u3044\u3066\u306f\u3053\u3061\u3089\u3092\u53c2\u7167\n\nElasticsearch Mapping\n\nElasticsearch\u306e\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u3092\u5b9a\u7fa9\u3059\u308b\n\u4ee5\u4e0b\u3092elblog.json\u3068\u3057\u3066\u4fdd\u5b58\n\nelblog.json\n{\n  \"template\": \"elblog\",\n  \"mappings\": {\n    \"log\": {\n      \"properties\": {\n        \"timestamp\": {\n          \"type\": \"date\"\n        },\n        \"elb\": {\n          \"type\": \"string\",\n          \"index\": \"not_analyzed\"\n        },\n        \"client_port\": {\n          \"type\": \"string\",\n          \"index\": \"not_analyzed\"\n        },\n        \"backend_port\": {\n          \"type\": \"string\",\n          \"index\": \"not_analyzed\"\n        },\n        \"request_processing_time\": {\n          \"type\": \"float\"\n        },\n        \"backend_processing_time\": {\n          \"type\": \"float\"\n        },\n        \"response_processing_time\": {\n          \"type\": \"float\"\n        },\n        \"elb_status_code\": {\n          \"type\": \"string\",\n          \"index\": \"not_analyzed\"\n        },\n        \"backend_status_code\": {\n          \"type\": \"string\",\n          \"index\": \"not_analyzed\"\n        },\n        \"received_bytes\": {\n          \"type\": \"long\"\n        },\n        \"sent_bytes\": {\n          \"type\": \"long\"\n        },\n        \"request\": {\n          \"type\": \"string\",\n          \"index\": \"not_analyzed\"\n        },\n        \"user_agent\": {\n          \"type\": \"string\",\n          \"index\": \"not_analyzed\"\n        },\n        \"ssl_cipher\": {\n          \"type\": \"string\",\n          \"index\": \"not_analyzed\"\n        },\n        \"ssl_protocol\": {\n          \"type\": \"string\",\n          \"index\": \"not_analyzed\"\n        }\n      }\n    }\n  }\n}\n\n\n\nElasticsearch\u306b\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u3092\u767b\u9332\u3059\u308b\n<es_host>\u306f\u9069\u5b9c\u81ea\u5206\u306e\u74b0\u5883\u306b\u5408\u308f\u305b\u308b\u3053\u3068\n$ curl -XPUT <es_host>:9200/_template/elblog -d \"$(cat elblog.json)\"\n\n\nEmbulk\u3067\u30c7\u30fc\u30bf\u306e\u6295\u5165\n\nEmbulk\u306e\u30d7\u30e9\u30b0\u30a4\u30f3\u5c0e\u5165\n$ embulk gem install embulk-input-s3\n$ embulk gem install embulk-output-elasticsearch_ruby\n\n\nEmbulk\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u4f5c\u6210\n\u4ee5\u4e0b\u3092config.yml\u3068\u3057\u3066\u4fdd\u5b58\n<Bucket_Name>\u306a\u3069\u306f\u9069\u5b9c\u81ea\u5206\u306e\u74b0\u5883\u306b\u5408\u308f\u305b\u308b\u3053\u3068\n\nconfig.yml\nin:\n  type: s3\n  bucket: <Bucket_Name>\n  path_prefix: hogehoge/AWSLogs/123456789012/elasticloadbalancing/ap-northeast-1/2017/02/05/\n  endpoint: s3-ap-northeast-1.amazonaws.com\n  access_key_id: HOGEHOGEHOGEHOGE\n  secret_access_key: HOGEHOGEHOGEHOGE\n  parser:\n    charset: UTF-8\n    newline: LF\n    type: csv\n    delimiter: ' '\n    quote: ''\n    escape: ''\n    trim_if_not_quoted: false\n    skip_header_lines: 0\n    allow_extra_columns: true\n    allow_optional_columns: false\n    columns:\n      - name: timestamp\n        type: string\n      - name: elb\n        type: string\n      - name: client_port\n        type: string\n      - name: backend_port\n        type: string\n      - name: request_processing_time\n        type: double\n      - name: backend_processing_time\n        type: double\n      - name: response_processing_time\n        type: double\n      - name: elb_status_code\n        type: string\n      - name: backend_status_code\n        type: string\n      - name: received_bytes\n        type: double\n      - name: sent_bytes\n        type: double\n      - name: request\n        type: string\n      - name: user_agent\n        type: string\n      - name: ssl_cipher\n        type: string\n      - name: ssl_protocol\n        type: string\nout:\n  type: elasticsearch_ruby\n  cluster_name: elasticsearch\n  mode: normal\n  nodes:\n    - {host: \"<es_host>\", port: 9200}\n  index: elb_log\n  index_type: log\n\n\n\n\u30c7\u30fc\u30bf\u306e\u6295\u5165\n$ embulk run ./config.yml\n\n\n# \u524d\u63d0\n\nElasticsearch : 5.2.0\nEmbulk : v0.8.16\n\nELB\u306e\u30ed\u30b0\u306b\u3064\u3044\u3066\u306f[\u3053\u3061\u3089](http://docs.aws.amazon.com/ja_jp/elasticloadbalancing/latest/classic/access-log-collection.html)\u3092\u53c2\u7167\n\n# Elasticsearch Mapping\n## Elasticsearch\u306e\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u3092\u5b9a\u7fa9\u3059\u308b\n\n\u4ee5\u4e0b\u3092elblog.json\u3068\u3057\u3066\u4fdd\u5b58\n\n```elblog.json\n{\n  \"template\": \"elblog\",\n  \"mappings\": {\n    \"log\": {\n      \"properties\": {\n        \"timestamp\": {\n          \"type\": \"date\"\n        },\n        \"elb\": {\n          \"type\": \"string\",\n          \"index\": \"not_analyzed\"\n        },\n        \"client_port\": {\n          \"type\": \"string\",\n          \"index\": \"not_analyzed\"\n        },\n        \"backend_port\": {\n          \"type\": \"string\",\n          \"index\": \"not_analyzed\"\n        },\n        \"request_processing_time\": {\n          \"type\": \"float\"\n        },\n        \"backend_processing_time\": {\n          \"type\": \"float\"\n        },\n        \"response_processing_time\": {\n          \"type\": \"float\"\n        },\n        \"elb_status_code\": {\n          \"type\": \"string\",\n          \"index\": \"not_analyzed\"\n        },\n        \"backend_status_code\": {\n          \"type\": \"string\",\n          \"index\": \"not_analyzed\"\n        },\n        \"received_bytes\": {\n          \"type\": \"long\"\n        },\n        \"sent_bytes\": {\n          \"type\": \"long\"\n        },\n        \"request\": {\n          \"type\": \"string\",\n          \"index\": \"not_analyzed\"\n        },\n        \"user_agent\": {\n          \"type\": \"string\",\n          \"index\": \"not_analyzed\"\n        },\n        \"ssl_cipher\": {\n          \"type\": \"string\",\n          \"index\": \"not_analyzed\"\n        },\n        \"ssl_protocol\": {\n          \"type\": \"string\",\n          \"index\": \"not_analyzed\"\n        }\n      }\n    }\n  }\n}\n```\n\n## Elasticsearch\u306b\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u3092\u767b\u9332\u3059\u308b\n\\<es_host>\u306f\u9069\u5b9c\u81ea\u5206\u306e\u74b0\u5883\u306b\u5408\u308f\u305b\u308b\u3053\u3068\n\n```bash\n$ curl -XPUT <es_host>:9200/_template/elblog -d \"$(cat elblog.json)\"\n```\n\n# Embulk\u3067\u30c7\u30fc\u30bf\u306e\u6295\u5165\n## Embulk\u306e\u30d7\u30e9\u30b0\u30a4\u30f3\u5c0e\u5165\n\n```bash\n$ embulk gem install embulk-input-s3\n$ embulk gem install embulk-output-elasticsearch_ruby\n```\n\n## Embulk\u306e\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u4f5c\u6210\n\u4ee5\u4e0b\u3092config.yml\u3068\u3057\u3066\u4fdd\u5b58\n\\<Bucket_Name>\u306a\u3069\u306f\u9069\u5b9c\u81ea\u5206\u306e\u74b0\u5883\u306b\u5408\u308f\u305b\u308b\u3053\u3068\n\n```config.yml\nin:\n  type: s3\n  bucket: <Bucket_Name>\n  path_prefix: hogehoge/AWSLogs/123456789012/elasticloadbalancing/ap-northeast-1/2017/02/05/\n  endpoint: s3-ap-northeast-1.amazonaws.com\n  access_key_id: HOGEHOGEHOGEHOGE\n  secret_access_key: HOGEHOGEHOGEHOGE\n  parser:\n    charset: UTF-8\n    newline: LF\n    type: csv\n    delimiter: ' '\n    quote: ''\n    escape: ''\n    trim_if_not_quoted: false\n    skip_header_lines: 0\n    allow_extra_columns: true\n    allow_optional_columns: false\n    columns:\n      - name: timestamp\n        type: string\n      - name: elb\n        type: string\n      - name: client_port\n        type: string\n      - name: backend_port\n        type: string\n      - name: request_processing_time\n        type: double\n      - name: backend_processing_time\n        type: double\n      - name: response_processing_time\n        type: double\n      - name: elb_status_code\n        type: string\n      - name: backend_status_code\n        type: string\n      - name: received_bytes\n        type: double\n      - name: sent_bytes\n        type: double\n      - name: request\n        type: string\n      - name: user_agent\n        type: string\n      - name: ssl_cipher\n        type: string\n      - name: ssl_protocol\n        type: string\nout:\n  type: elasticsearch_ruby\n  cluster_name: elasticsearch\n  mode: normal\n  nodes:\n    - {host: \"<es_host>\", port: 9200}\n  index: elb_log\n  index_type: log\n```\n\n## \u30c7\u30fc\u30bf\u306e\u6295\u5165\n\n```bash\n$ embulk run ./config.yml\n```\n", "tags": ["S3", "Elasticsearch", "AWS", "Embulk", "elb"]}