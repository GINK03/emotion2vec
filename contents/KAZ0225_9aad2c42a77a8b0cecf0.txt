{"context": "ZabbixAPI\u3067\u3059\u304c\u901a\u5e38\u3067\u306f\u30ed\u30b0\u304c\u51fa\u305b\u306a\u304f\u30c7\u30d0\u30c3\u30af\u304c\u8f9b\u3044\u306e\u3067log4php\u3092\u4f7f\u3063\u3066\u306a\u3093\u3068\u304b\u306a\u3089\u306a\u3044\u304b\u3068\u8a66\u3057\u3066\u307f\u307e\u3057\u305f\u3002\n\u53d6\u308a\u6562\u3048\u305a\u3001\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\nyum -y install php-pear\npear channel-discover pear.apache.org/log4php\npear install log4php/Apache_log4php\n\n\u3067\u3001\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u306e\u4f5c\u6210\u3002\nzlog4\u3068\u8a00\u3046\u30ed\u30ac\u30fc\u3092\u4f5c\u308a\u307e\u3057\u305f\u3002\n\u30ed\u30b0\u306f/tmp/ZabbixAPI.log\u306b\u51fa\u529b\u3057\u307e\u3059\u3002\n\n/usr/share/zabbix/log4php.xml\n<configuration xmlns=\"http://logging.apache.org/log4php/\">\n\n    <appender name=\"myConsoleAppender\" class=\"LoggerAppenderConsole\" />\n\n    <appender name=\"myFileAppender\" class=\"LoggerAppenderFile\">\n        <layout class=\"LoggerLayoutPattern\">\n            <param name=\"conversionPattern\" value=\"%date{Y-m-d H:i:s,u} [%logger] %message%newline\" />\n        </layout>\n        <param name=\"file\" value=\"/tmp/ZabbixAPI.log\" />\n    </appender>\n\n    <logger name=\"zlog4\">\n        <appender_ref ref=\"myFileAppender\" />\n    </logger>\n\n    <root>\n        <level value=\"DEBUG\" />\n        <appender_ref ref=\"myConsoleAppender\" />\n    </root>\n</configuration>\n\n\n2016\u5e747\u67084\u65e5api_jsonrpc.php\u306e\u307f\u306blog4php\u306e\u8a2d\u5b9a\u3092\u5165\u308c\u308b\u3068Web\u30a4\u30f3\u30bf\u30d5\u30a7\u30fc\u30b9\u306e\u753b\u9762\u304c\u8868\u793a\u3055\u308c\u306a\u304f\u306a\u308b\u4e8b\u8c61\u304c\u767a\u751f\u3002\n\u5185\u90e8\u3067api_jsonrpc.php\u901a\u3089\u305a\u306bhost.get\u304c\u547c\u3070\u308c\u3066\u3044\u308b\u3088\u3046\u3067\u3059\u3002\n\u3068\u8a00\u3046\u8a33\u3067\u3001\u4e0b\u8a18\u306e\u69d8\u306b\u5909\u66f4\u3057\u307e\u3057\u305f\u3002\nZ.php\u3067\u30ed\u30ac\u30fc\u3092\u8a2d\u5b9a\u3057\u2026\n\n/usr/share/zabbix/include/classes/core/Z.php\n<?php\n/*\n** Zabbix\n** Copyright (C) 2001-2015 Zabbix SIA\n**\n** This program is free software; you can redistribute it and/or modify\n** it under the terms of the GNU General Public License as published by\n** the Free Software Foundation; either version 2 of the License, or\n** (at your option) any later version.\n**\n** This program is distributed in the hope that it will be useful,\n** but WITHOUT ANY WARRANTY; without even the implied warranty of\n** MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n** GNU General Public License for more details.\n**\n** You should have received a copy of the GNU General Public License\n** along with this program; if not, write to the Free Software\n** Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.\n**/\n\n\nrequire_once dirname(__FILE__).'/ZBase.php';\n\nrequire_once('log4php/Logger.php');                   <-- log4php\u306e\u8a2d\u5b9a\nLogger::configure('/usr/share/zabbix/log4php.xml');   <-- log4php\u306e\u8a2d\u5b9a\n$zbxlog4php = Logger::getLogger('zlog4');             <-- log4php\u306e\u8a2d\u5b9a\nglobal $zbxlog4php;                                   <-- log4php\u306e\u8a2d\u5b9a\n\n\n/**\n * A wrapper for the ZBase class.\n *\n * Feel free to modify and extend it to change the functionality of ZBase.\n */\nclass Z extends ZBase {\n\n}\n\n\napi_jsonrpc.php\u306e\u6700\u5f8c\u306e\u4e00\u884c\u306bshutdown\u3092\u8a2d\u5b9a\n\n/usr/share/zabbix/api_jsonrpc.php\n\u2026\u7565\u2026\n        echo CJs::encodeJson($response);\n}\n$zbxlog4php->shutdown();                              <-- log4php\u306e\u8a2d\u5b9a\n\n\n\u3053\u308c\u3067\u6e96\u5099OK\n\u30c6\u30b9\u30c8\u306fhost.get\u3067\u884c\u3044\u307e\u3057\u305f\u3002\n\u958b\u59cb\u76f4\u5f8c\u3068SQL\u5b9f\u884c\u3068\u7d42\u4e86\u76f4\u7dda\u3067\u30ed\u30b0\u3092\u51fa\u529b\u3057\u307e\u3059\u3002\n\n/usr/share/zabbix/api/classes/CHost.php\n\u2026\u7565\u2026\n        public function get($options = array()) {\n                $result = array();\n                $userType = self::$userData['type'];\n                $userid = self::$userData['userid'];\n\nglobal $zbxlog4php;\n$zbxlog4php->info(\"host.get start\");\n\u2026\u7565\u2026\n                $sqlParts = $this->applyQueryOutputOptions($this->tableName(), $this->tableAlias(), $options, $sqlParts);\n                $sqlParts = $this->applyQuerySortOptions($this->tableName(), $this->tableAlias(), $options, $sqlParts);\n                $sqlParts = $this->applyQueryNodeOptions($this->tableName(), $this->tableAlias(), $options, $sqlParts);\n$zbxlog4php->info($sqlParts);\n                $res = DBselect($this->createSelectQueryFromParts($sqlParts), $sqlParts['limit']);\n                while ($host = DBfetch($res)) {\n\u2026\u7565\u2026\n                // removing keys (hash -> array)\n                if (is_null($options['preservekeys'])) {\n                        $result = zbx_cleanHashes($result);\n                }\n\n$zbxlog4php->info(\"host.get end\");\n                return $result;\n        }\n\n        /**\n         * Get Host ID by Host name\n         *\n         * @param array $host_data\n         * @param string $host_data['host']\n         *\n         * @return int|boolean\n         */\n        public function getObjects($hostData) {\n\n\u2026\u7565\u2026\n\n\n\u4e0b\u8a18\u304c\u5b9f\u884c\u7d50\u679c\n]# cat /tmp/ZabbixAPI.log\n2016-07-03 09:34:37,850 [zlog4] host.get start\n2016-07-03 09:34:37,853 [zlog4] Array\n(\n    [select] => Array\n        (\n            [0] => h.*\n        )\n\n    [from] => Array\n        (\n            [hosts] => hosts h\n        )\n\n    [where] => Array\n        (\n            [flags] => h.flags IN (0,4)\n            [status] => h.status IN (0,1)\n            [filter] => h.host='Zabbix server'\n        )\n\n    [group] => Array\n        (\n        )\n\n    [order] => Array\n        (\n        )\n\n    [limit] =>\n)\n\n2016-07-03 09:34:37,853 [zlog4] host.get end\n\n\u3053\u308c\u3067\u753b\u9762\u3082\u8868\u793a\u3067\u304d\u3066\u30c7\u30d0\u30c3\u30af\u60c5\u5831\u51fa\u3059\u3053\u3068\u3067\u7740\u307e\u3057\u305f\u3002\n\u56e0\u307f\u306b\u753b\u9762\u304b\u3089host.get\u547c\u3070\u308c\u308b\u5834\u5408\u3082\u3053\u308c\u3067\u30ed\u30b0\u304c\u51fa\u307e\u3059\u3002\nZabbixAPI\u3067\u3059\u304c\u901a\u5e38\u3067\u306f\u30ed\u30b0\u304c\u51fa\u305b\u306a\u304f\u30c7\u30d0\u30c3\u30af\u304c\u8f9b\u3044\u306e\u3067log4php\u3092\u4f7f\u3063\u3066\u306a\u3093\u3068\u304b\u306a\u3089\u306a\u3044\u304b\u3068\u8a66\u3057\u3066\u307f\u307e\u3057\u305f\u3002\n\n\u53d6\u308a\u6562\u3048\u305a\u3001\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\n\n```\nyum -y install php-pear\npear channel-discover pear.apache.org/log4php\npear install log4php/Apache_log4php\n```\n\n\u3067\u3001\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u306e\u4f5c\u6210\u3002\nzlog4\u3068\u8a00\u3046\u30ed\u30ac\u30fc\u3092\u4f5c\u308a\u307e\u3057\u305f\u3002\n\u30ed\u30b0\u306f/tmp/ZabbixAPI.log\u306b\u51fa\u529b\u3057\u307e\u3059\u3002\n\n```/usr/share/zabbix/log4php.xml\n<configuration xmlns=\"http://logging.apache.org/log4php/\">\n\n    <appender name=\"myConsoleAppender\" class=\"LoggerAppenderConsole\" />\n\n    <appender name=\"myFileAppender\" class=\"LoggerAppenderFile\">\n        <layout class=\"LoggerLayoutPattern\">\n            <param name=\"conversionPattern\" value=\"%date{Y-m-d H:i:s,u} [%logger] %message%newline\" />\n        </layout>\n        <param name=\"file\" value=\"/tmp/ZabbixAPI.log\" />\n    </appender>\n\n    <logger name=\"zlog4\">\n        <appender_ref ref=\"myFileAppender\" />\n    </logger>\n\n    <root>\n        <level value=\"DEBUG\" />\n        <appender_ref ref=\"myConsoleAppender\" />\n    </root>\n</configuration>\n```\n2016\u5e747\u67084\u65e5api_jsonrpc.php\u306e\u307f\u306blog4php\u306e\u8a2d\u5b9a\u3092\u5165\u308c\u308b\u3068Web\u30a4\u30f3\u30bf\u30d5\u30a7\u30fc\u30b9\u306e\u753b\u9762\u304c\u8868\u793a\u3055\u308c\u306a\u304f\u306a\u308b\u4e8b\u8c61\u304c\u767a\u751f\u3002\n\u5185\u90e8\u3067api_jsonrpc.php\u901a\u3089\u305a\u306bhost.get\u304c\u547c\u3070\u308c\u3066\u3044\u308b\u3088\u3046\u3067\u3059\u3002\n\u3068\u8a00\u3046\u8a33\u3067\u3001\u4e0b\u8a18\u306e\u69d8\u306b\u5909\u66f4\u3057\u307e\u3057\u305f\u3002\n\nZ.php\u3067\u30ed\u30ac\u30fc\u3092\u8a2d\u5b9a\u3057\u2026\n\n```/usr/share/zabbix/include/classes/core/Z.php\n<?php\n/*\n** Zabbix\n** Copyright (C) 2001-2015 Zabbix SIA\n**\n** This program is free software; you can redistribute it and/or modify\n** it under the terms of the GNU General Public License as published by\n** the Free Software Foundation; either version 2 of the License, or\n** (at your option) any later version.\n**\n** This program is distributed in the hope that it will be useful,\n** but WITHOUT ANY WARRANTY; without even the implied warranty of\n** MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n** GNU General Public License for more details.\n**\n** You should have received a copy of the GNU General Public License\n** along with this program; if not, write to the Free Software\n** Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.\n**/\n\n\nrequire_once dirname(__FILE__).'/ZBase.php';\n\nrequire_once('log4php/Logger.php');                   <-- log4php\u306e\u8a2d\u5b9a\nLogger::configure('/usr/share/zabbix/log4php.xml');   <-- log4php\u306e\u8a2d\u5b9a\n$zbxlog4php = Logger::getLogger('zlog4');             <-- log4php\u306e\u8a2d\u5b9a\nglobal $zbxlog4php;                                   <-- log4php\u306e\u8a2d\u5b9a\n\n\n/**\n * A wrapper for the ZBase class.\n *\n * Feel free to modify and extend it to change the functionality of ZBase.\n */\nclass Z extends ZBase {\n\n}\n```\n\napi_jsonrpc.php\u306e\u6700\u5f8c\u306e\u4e00\u884c\u306bshutdown\u3092\u8a2d\u5b9a\n\n```/usr/share/zabbix/api_jsonrpc.php\n\u2026\u7565\u2026\n        echo CJs::encodeJson($response);\n}\n$zbxlog4php->shutdown();                              <-- log4php\u306e\u8a2d\u5b9a\n```\n\n\u3053\u308c\u3067\u6e96\u5099OK\n\n\u30c6\u30b9\u30c8\u306fhost.get\u3067\u884c\u3044\u307e\u3057\u305f\u3002\n\u958b\u59cb\u76f4\u5f8c\u3068SQL\u5b9f\u884c\u3068\u7d42\u4e86\u76f4\u7dda\u3067\u30ed\u30b0\u3092\u51fa\u529b\u3057\u307e\u3059\u3002\n\n``` /usr/share/zabbix/api/classes/CHost.php\n\u2026\u7565\u2026\n        public function get($options = array()) {\n                $result = array();\n                $userType = self::$userData['type'];\n                $userid = self::$userData['userid'];\n\nglobal $zbxlog4php;\n$zbxlog4php->info(\"host.get start\");\n\u2026\u7565\u2026\n                $sqlParts = $this->applyQueryOutputOptions($this->tableName(), $this->tableAlias(), $options, $sqlParts);\n                $sqlParts = $this->applyQuerySortOptions($this->tableName(), $this->tableAlias(), $options, $sqlParts);\n                $sqlParts = $this->applyQueryNodeOptions($this->tableName(), $this->tableAlias(), $options, $sqlParts);\n$zbxlog4php->info($sqlParts);\n                $res = DBselect($this->createSelectQueryFromParts($sqlParts), $sqlParts['limit']);\n                while ($host = DBfetch($res)) {\n\u2026\u7565\u2026\n                // removing keys (hash -> array)\n                if (is_null($options['preservekeys'])) {\n                        $result = zbx_cleanHashes($result);\n                }\n\n$zbxlog4php->info(\"host.get end\");\n                return $result;\n        }\n\n        /**\n         * Get Host ID by Host name\n         *\n         * @param array $host_data\n         * @param string $host_data['host']\n         *\n         * @return int|boolean\n         */\n        public function getObjects($hostData) {\n\n\u2026\u7565\u2026\n```\n\n\n\u4e0b\u8a18\u304c\u5b9f\u884c\u7d50\u679c\n\n```\n]# cat /tmp/ZabbixAPI.log\n2016-07-03 09:34:37,850 [zlog4] host.get start\n2016-07-03 09:34:37,853 [zlog4] Array\n(\n    [select] => Array\n        (\n            [0] => h.*\n        )\n\n    [from] => Array\n        (\n            [hosts] => hosts h\n        )\n\n    [where] => Array\n        (\n            [flags] => h.flags IN (0,4)\n            [status] => h.status IN (0,1)\n            [filter] => h.host='Zabbix server'\n        )\n\n    [group] => Array\n        (\n        )\n\n    [order] => Array\n        (\n        )\n\n    [limit] =>\n)\n\n2016-07-03 09:34:37,853 [zlog4] host.get end\n```\n\n\u3053\u308c\u3067\u753b\u9762\u3082\u8868\u793a\u3067\u304d\u3066\u30c7\u30d0\u30c3\u30af\u60c5\u5831\u51fa\u3059\u3053\u3068\u3067\u7740\u307e\u3057\u305f\u3002\n\u56e0\u307f\u306b\u753b\u9762\u304b\u3089host.get\u547c\u3070\u308c\u308b\u5834\u5408\u3082\u3053\u308c\u3067\u30ed\u30b0\u304c\u51fa\u307e\u3059\u3002\n", "tags": ["zabbix"]}