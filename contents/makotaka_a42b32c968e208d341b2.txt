{"context": "\n\n\u80cc\u666f\nAlibaba\u306eIaaS\u3067\u3042\u308bAlibaba Cloud\u306eECS\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\uff08AWS\u3067\u3044\u3046EC2,\u4eee\u60f3\u30b5\u30fc\u30d0\uff09\u306e\u6027\u80fd\u81ea\u4f53\u306f\u60aa\u304f\u306f\u306a\u3055\u305d\u3046\u306a\u306e\u3067\u3001AWS\u306eVPC\u3068\u306e\u9593\u306bIPSec VPN\u306b\u3088\u308b\u9589\u57df\u7db2\u63a5\u7d9a\u3057\u305f\u3046\u3048\u3067\u4f7f\u3044\u305f\u3044\u3002\u3067\u3082IPSec\u3067VPC\u76f4\u7d50\u3057\u3066\u7d4c\u8def\u4ea4\u63db\u306f\u7121\u7406\u305d\u3046\u3002\u305d\u3093\u306a\u308f\u3051\u3067\u3001Linux(Alibaba cloud\u306einstance)\u3092Customer gateway\u3068\u3057\u3066VPC\u3078\u63a5\u7d9a\u3059\u308b\u65b9\u6cd5\u306e\u307e\u3068\u3081\u3002NAT\u914d\u4e0b\u306e\u30aa\u30f3\u30d7\u30ecLinux\u3067\u3082\u307b\u304b\u306eIaaS\u3067\u3082\u540c\u69d8\u306b\u3044\u3051\u308b\u306f\u305a\u3002\n\n\nAWS\u5074\u306e\u6e96\u5099\n\n\u30ab\u30b9\u30bf\u30de\u30fc\u30b2\u30fc\u30c8\u30a6\u30a7\u30a4\u306e\u6e96\u5099\nCPE\u3001\u4eca\u56de\u306fLinux\u306e\u60c5\u5831\u3092\u5b9a\u7fa9\u3002Linux\u306f\u30b5\u30dd\u30fc\u30c8\u5bfe\u8c61\u5916\u3002\u9759\u7684\u30eb\u30fc\u30c6\u30a3\u30f3\u30b0\u3067\u3042\u308c\u3070Wndows Server\u306f\u30b5\u30dd\u30fc\u30c8\u5bfe\u8c61\u3063\u307d\u3044VPC\u306e\u30b3\u30f3\u30bd\u30fc\u30eb\u3067\u64cd\u4f5c\u3002\u3068\u308a\u3042\u3048\u305aBGP\u558b\u308c\u308b\u3088\u3046\u306b\u3001IP\u30a2\u30c9\u30ec\u30b9\u306fNat\u5f8c\u306e\u30b0\u30ed\u30fc\u30d0\u30ebIP\u30a2\u30c9\u30ec\u30b9\u3002\u898b\u305f\u611f\u3058IPSec\u306fNat traversal\u3060\u3051\u3069Main mode\u306e\u307f\u3063\u307d\u3044\u306e\u3067\u30b0\u30ed\u30fc\u30d0\u30eb\u30a2\u30c9\u30ec\u30b9\u304c\u52d5\u7684\u306b\u5909\u308f\u308b\u74b0\u5883\u3060\u3068NG\u3060\u3068\u601d\u308f\u308c\u308b\u3002\n\ncli\u306a\u3089\u3053\u3093\u306a\u611f\u3058\u3002\n\naws-cli\n# cli\naws ec2 create-customer-gateway --type ipsec.1 --public-ip 47.91.xx.xx --bgp-asn 65000\n# response\n{\n    \"CustomerGateway\": {\n        \"CustomerGatewayId\": \"cgw-0b7bxxxx\",\n        \"IpAddress\": \"47.91.xx.xx\",\n        \"State\": \"available\",\n        \"Type\": \"ipsec.1\",\n        \"BgpAsn\": \"65000\"\n    }\n}\n\n\n\n\u4eee\u60f3\u30d7\u30e9\u30a4\u30d9\u30fc\u30c8\u30b2\u30fc\u30c8\u30a6\u30a8\u30a4\n\u6b21\u306bAWS\u5074\u306e\u4eee\u60f3\u30d7\u30e9\u30a4\u30d9\u30fc\u30c8\u30b2\u30fc\u30c8\u30a6\u30a8\u30a4\u3092\u4f5c\u6210\u3002\n\ncli\u306a\u3089\u3053\u3093\u306a\u304b\u3093\u3058\n\naws-cli\n# cli\naws ec2 create-vpn-gateway --type ipsec.1\n# response\n{\n    \"VpnGateway\": {\n        \"State\": \"available\",\n        \"Type\": \"ipsec.1\",\n        \"VpnGatewayId\": \"vgw-328cxxxx\",\n        \"VpcAttachments\": []\n    }\n}\n\n\n\u65e2\u5b58\u306eVPC\u306b\u30a2\u30c3\u30bf\u30c3\u30c1\u3059\u308b\n\n\naws-cli\n# cli\naws ec2 attach-vpn-gateway --vpn-gateway-id vgw-328cxxxx --vpc-id vpc-c9b0xxxx\n# response\n{\n    \"VpcAttachment\": {\n        \"State\": \"attaching\",\n        \"VpcId\": \"vpc-c9b0xxxx\"\n    }\n}\n\n\n\nVPN\u63a5\u7d9a\u3092\u4f5c\u6210\n\u5148\u307b\u3069\u4f5c\u6210\u3057\u305f\u30ab\u30b9\u30bf\u30de\u30fc\u30b2\u30fc\u30c8\u30a6\u30a8\u30a4\u3068\u4eee\u60f3\u30d7\u30e9\u30a4\u30d9\u30fc\u30c8\u30b2\u30fc\u30c8\u30a6\u30a8\u30a4\u3092\u4f7f\u7528\u3057\u3066VPN\u63a5\u7d9a\u3092\u4f5c\u6210\u3002\n\n\naws-cli\n# cli\n aws ec2 create-vpn-connection --type ipsec.1 --customer-gateway-id cgw-0b7bcb0a --\n# output\nvpn-gateway-id vgw-328c3c33\n{\n    \"VpnConnection\": {\n        \"VpnConnectionId\": \"vpn-30a2xxxx\",\n        \"CustomerGatewayConfiguration\": \"<?xml\u30fb\u30fb\u30fb \",\u3000//XML\u6587\u7701\u7565\n\n        \"State\": \"pending\",\n        \"VpnGatewayId\": \"vgw-328cxxxx\",\n        \"CustomerGatewayId\": \"cgw-0b7bxxxx\"\n    }\n}\n\n\nIPSecVPN 2\u672c\u306e\u63a5\u7d9a\u60c5\u5831\u304c\u4e0a\u306eoutput\u306e\u4e2d\u3067XML\u3067\u8a18\u8f09\u3055\u308c\u3066\u3044\u308b\u3002\n\n\u6574\u5f62vpn-connection\n    <vpn_connection id=\\\"vpn-30a2xxxx\\\">\n        <ipsec_tunnel>\n            <customer_gateway>\n                <tunnel_outside_address>\n                    <ip_address>47.91.xx.xx</ip_address>\n                </tunnel_outside_address>\n                <tunnel_inside_address>\n                    <ip_address>169.254.xx.xx</ip_address>\n                    <network_mask>255.255.255.252</network_mask>\n                    <network_cidr>30</network_cidr>\n                </tunnel_inside_address>\n                <bgp>\n                    <asn>65000</asn>\n                    <hold_time>30</hold_time>\n                </bgp>\n            </customer_gateway>\n            <vpn_gateway>\n                <tunnel_outside_address>\n                    <ip_address>52.68.xx.xx</ip_address>\n                </tunnel_outside_address>\n                <tunnel_inside_address>\n                    <ip_address>169.254.xx.xx</ip_address>\n                    <network_mask>255.255.255.252</network_mask>\n                    <network_cidr>30</network_cidr>\n                </tunnel_inside_address>\n                <bgp>\n                    <asn>10124</asn>\n                    <hold_time>30</hold_time>\n                </bgp>\n            </vpn_gateway>\n            <ike>\n                <authentication_protocol>sha1</authentication_protocol>\n                <encryption_protocol>aes-128-cbc</encryption_protocol>\n                <lifetime>28800</lifetime>\n                <perfect_forward_secrecy>group2</perfect_forward_secrecy>\n                <mode>main</mode>\n                <pre_shared_key>xxxxxxxxxx</pre_shared_key>\n            </ike>\n            <ipsec>\n                <protocol>esp</protocol>\n                <authentication_protocol>hmac-sha1-96</authentication_protocol>\n                <encryption_protocol>aes-128-cbc</encryption_protocol>\n                <lifetime>3600</lifetime>\n                <perfect_forward_secrecy>group2</perfect_forward_secrecy>\n                <mode>tunnel</mode>\n                <clear_df_bit>true</clear_df_bit>\n                <fragmentation_before_encryption>true</fragmentation_before_encryption>\n                <tcp_mss_adjustment>1387</tcp_mss_adjustment>\n                <dead_peer_detection>\n                <interval>10</interval>\n                <retries>3</retries>\n                </dead_peer_detection>\n            </ipsec>\n        </ipsec_tunnel>\n        <ipsec_tunnel>\n            <customer_gateway>\n                <tunnel_outside_address>\n                    <ip_address>47.91.xx.xx</ip_address>\n                </tunnel_outside_address>\n                <tunnel_inside_address>\n                    <ip_address>169.254.xx.xx</ip_address>\n                    <network_mask>255.255.255.252</network_mask>\n                    <network_cidr>30</network_cidr>\n                </tunnel_inside_address>\n                <bgp>\n                    <asn>65000</asn>\n                    <hold_time>30</hold_time>\n                </bgp>\n            </customer_gateway>\n            <vpn_gateway>\n                <tunnel_outside_address>\n                    <ip_address>54.64.xx.xx</ip_address>\n                </tunnel_outside_address>\n                <tunnel_inside_address>\n                    <ip_address>169.254.xx.xx</ip_address>\n                    <network_mask>255.255.255.252</network_mask>\n                    <network_cidr>30</network_cidr>\n                </tunnel_inside_address>\n                <bgp>\n                    <asn>10124</asn>\n                <hold_time>30</hold_time>\n                </bgp>\n            </vpn_gateway>\n            <ike>\n                <authentication_protocol>sha1</authentication_protocol>\n                <encryption_protocol>aes-128-cbc</encryption_protocol>\n                <lifetime>28800</lifetime>\n                <perfect_forward_secrecy>group2</perfect_forward_secrecy>\n                <mode>main</mode>\n                <pre_shared_key>xxxxxxxxx</pre_shared_key>\n            </ike>\n            <ipsec>\n                <protocol>esp</protocol>\n                <authentication_protocol>hmac-sha1-96</authentication_protocol>\n                <encryption_protocol>aes-128-cbc</encryption_protocol>\n                <lifetime>3600</lifetime>\n                <perfect_forward_secrecy>group2</perfect_forward_secrecy>\n                <mode>tunnel</mode>\n                <clear_df_bit>true</clear_df_bit>\n                <fragmentation_before_encryption>true</fragmentation_before_encryption>\n                <tcp_mss_adjustment>1387</tcp_mss_adjustment>\n                <dead_peer_detection>\n                    <interval>10</interval>\n                    <retries>3</retries>\n                </dead_peer_detection>\n            </ipsec>\n        </ipsec_tunnel>\n    </vpn_connection>\n\n\n\n\u5c11\u306a\u304f\u3068\u3082\u5909\u52d5\u5024\u306f\u3072\u304b\u3048\u3066\u304a\u304f\u3002\n\n\u30ab\u30b9\u30bf\u30de\u30fc\u30b2\u30fc\u30c8\u30a6\u30a8\u30a4\n\n\nIPsec\u5916\u5074\u306e\u30a2\u30c9\u30ec\u30b9\uff08\u81ea\u5206\u306e\u30d7\u30e9\u30a4\u30d9\u30fc\u30c8\u30a2\u30c9\u30ec\u30b9\uff09\nIPsec\u5185\u5074\u306e\u30a2\u30c9\u30ec\u30b9\uff08VPC\u304b\u3089\u6255\u3044\u51fa\u3057\uff09\nASN\uff08\u81ea\u5206\u3067\u6307\u5b9a\uff09\n\n\n\u4eee\u60f3\u30d7\u30e9\u30a4\u30d9\u30fc\u30c8\u30b2\u30fc\u30c8\u30a6\u30a8\u30a4\n\n\nIPsec\u5916\u5074\u306e\u30a2\u30c9\u30ec\u30b9\uff08VPC\u304b\u3089\u6255\u3044\u51fa\u3057\uff09\nIPsec\u5185\u5074\u306e\u30a2\u30c9\u30ec\u30b9\uff08VPC\u304b\u3089\u6255\u3044\u51fa\u3057\uff09\nASN\uff0810124\u56fa\u5b9a\uff1f\uff09\n\n\nIKE\n\n\npre-shared key\n\n\n\nWebUI\u304b\u3089\u78ba\u8a8d\u3059\u308b\u65b9\u6cd5\u306f\u3001VPN\u63a5\u7d9a\uff1e\u8a2d\u5b9a\u306e\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3067Configuration\u306e\u8aad\u3081\u308b\u30bf\u30a4\u30d7\u306e\u6a5f\u5668\u306e\u8a2d\u5b9a\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u3066\u5206\u6790\u3059\u308b\u4ee5\u5916\u306b\u306a\u3044\u306e\u304b\u306a\uff1f\n\n\u30eb\u30fc\u30c8\u4f1d\u64ad\n\u6700\u5f8c\u306b\u30eb\u30fc\u30c6\u30a3\u30f3\u30b0\u30c6\u30fc\u30d6\u30eb\u3067\u4eee\u60f3\u30d7\u30e9\u30a4\u30d9\u30fc\u30c8\u30b2\u30fc\u30c8\u30a6\u30a8\u30a4\u304b\u3089\u306e\u30eb\u30fc\u30c8\u4f1d\u64ad\u3092\u30aa\u30f3\u306b\u3002\u3053\u308c\u3092\u3057\u306a\u3044\u3068\u53d7\u3051\u53d6\u3063\u305fPrefix\u304cVPC\u5074\u306e\u30eb\u30fc\u30c6\u30a3\u30f3\u30b0\u30c6\u30fc\u30d6\u30eb\u306b\u53cd\u6620\u3055\u308c\u306a\u3044\u3002\n\n\naws-cli\naws ec2 enable-vgw-route-propagation --route-table-id rtb-1836xxxx --gateway-id vgw-328cxxxx\n\n\n\nmemo\n\u696d\u52d9\u7528\u9014\u306a\u3089\u305f\u3044\u3057\u305f\u91d1\u984d\u3067\u306f\u306a\u3044\u3051\u3069\u3001\u500b\u4eba\u7684\u306b\u904a\u3076\u3089\u306aVPN\u63a5\u7d9a\u304c\u6709\u52b9\u306a\u9593\u305a\u3063\u3068\u8ab2\u91d1\u3055\u308c\u7d9a\u3051\u308b\u304b\u3089\u3001\u4f7f\u3046\u6642\u3060\u3051\u4f5c\u6210\u3057\u3066\u5bfe\u5411\u306eIPSec\u63a5\u7d9a\u3092\u629c\u304f\u3088\u3046\u306bScript\u4f5c\u3063\u3066\u304a\u304f\u306e\u304c\u3044\u3044\u304b\u3082\u3002\u305d\u3093\u306a\u308f\u3051\u3067cli\u5927\u4e8b\u3002\n\nubuntu\u5074\u6e96\u5099\n\nIPSec\u8a2d\u5b9a\n\n\u5fc5\u8981\u306a\u30d1\u30c3\u30b1\u30fc\u30b8\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\napt-get install ipsec-tools racoon quagga\n\n\n\u7279\u5b9a\u306e\u30c8\u30e9\u30d5\u30a3\u30c3\u30af\u3092IPsec\u30c8\u30f3\u30cd\u30eb\u306e\u4e2d\u3078\u3002\u30c8\u30f3\u30cd\u30eb\u306fLinux\u306eNAT\u524d\u306e\u30d7\u30e9\u30a4\u30d9\u30fc\u30c8IP\u3068\u63a5\u7d9a\u5148\u306eVPC\u4eee\u60f3\u30d7\u30e9\u30a4\u30d9\u30fc\u30c8\u30b2\u30fc\u30c8\u30a6\u30a8\u30a4\u306e\u30b0\u30ed\u30fc\u30d0\u30ebIP\u30a2\u30c9\u30ec\u30b9\u306e\u30da\u30a2\u3067\u6307\u5b9a\u3002\u5f53\u7136\u4e21\u7aef\u306e\u30d7\u30e9\u30a4\u30d9\u30fc\u30c8\u30a2\u30c9\u30ec\u30b9\u7a7a\u9593\u3060\u3051\u3067\u306a\u304f\u3001IPSec\u306e\u5185\u5074\u306e\u30a2\u30c9\u30ec\u30b9\u3082\u6697\u53f7\u5316\u3059\u308b\u5fc5\u8981\u3042\u308a\u3002\n\n/etc/ipsec-tools.conf\n#!/usr/sbin/setkey -f\nflush;\nspdflush;\n\n# Tunnel1\nspdadd 169.254.xx.xx/30 169.254.xx.xx/30 any -P out ipsec esp/tunnel/172.24.x.x-52.68.xx.xx/require;\nspdadd 169.254.xx.xx/30 169.254.xx.xx/30 any -P in  ipsec esp/tunnel/52.68.xx.xx-172.24.x.x/require;\nspdadd 169.254.xx.xx/30 172.31.0.0/16    any -P out ipsec esp/tunnel/172.24.x.x-52.68.xx.xx/require;\nspdadd 172.31.0.0/16 169.254.xx.xx/30    any -P in  ipsec esp/tunnel/52.68.xx.xx-172.24.0.1/require;\nspdadd 172.24.0.0/16 172.31.0.0/16    any -P out ipsec esp/tunnel/172.24.x.x-52.68.xx.xx/require;\nspdadd 172.31.0.0/16 172.24.0.0/16    any -P in  ipsec esp/tunnel/52.68.xx.xx-172.24.0.1/require;\n\n# Tunnel2 \u6b8b\u5ff5\u306a\u304c\u30892\u672c\u76ee\u306e\u30c8\u30f3\u30cd\u30eb\u306f\u610f\u5473\u304c\u306a\u3044\u3053\u3068\u304c\u5224\u660e\n#spdadd 169.254.xx.xx/30 169.254.xx.xx/30 any -P out ipsec esp/tunnel/172.24.0.1-54.64.xx.xx/require;\n#spdadd 169.254.xx.xx/30 169.254.xx.xx/30 any -P in  ipsec esp/tunnel/54.64.xx.xx-172.24.0.1/require;\n#spdadd 169.254.xx.xx/30 172.31.0.0/16    any -P out ipsec esp/tunnel/172.24.0.1-54.64.xx.xx/require;\n#spdadd 172.31.0.0/16 169.254.xx.xx/30    any -P in  ipsec esp/tunnel/54.64.xx.xx-172.24.0.1/require;\n#spdadd 172.24.0.0/16 172.31.0.0/16     any -P out ipsec esp/tunnel/172.24.0.1-54.64.xx.xx/require;\n#spdadd 172.31.0.0/16 172.24.0.0/16     any -P in  ipsec esp/tunnel/54.64.xx.xx-172.24.0.1/require;\n\n\n\u5bfe\u5411\u306epre-shared key\u3092\u6307\u5b9a\n\n/etc/racoon/psk.txt\n# \u4eee\u60f3\u30d7\u30e9\u30a4\u30d9\u30fc\u30c8\u30b2\u30fc\u30c8\u30a6\u30a8\u30a4\u306e\u5916\u5074\u306e\u30a2\u30c9\u30ec\u30b9\u3068pre-shared key\u306e\u30da\u30a2\n52.68.xxx.xxx sDei_5KCLDC20CMf1tgSAbSEpeO8jVGM\n# 2\u672c\u76ee\u306f\u610f\u5473\u304c\u306a\u3055\u305d\u3046\n#54.64.xxx.xxx r77N2jG.CYnvIIr836.lk2ZBxp5CMH8g\n\n\nIKE\u30d5\u30a7\u30fc\u30ba\uff11\u3001\uff12\u306e\u60c5\u5831\u3002\n\n/etc/racoon/racoon.conf\npath pre_shared_key \"/etc/racoon/psk.txt\";\npath certificate \"/etc/racoon/certs\";\n\nremote 52.68.xx.xx {\n        exchange_mode main;\n        lifetime time 28800 seconds;\n        generate_policy off;\n        nat_traversal force;\n        exchange_mode main;\n        proposal {\n                encryption_algorithm aes128;\n                hash_algorithm sha1;\n                authentication_method pre_shared_key;\n                dh_group 2;\n        }\n}\n\n#remote 54.64.xx.xx {\n#        exchange_mode main;\n#        lifetime time 28800 seconds;\n#        nat_traversal force;\n#        generate_policy off;\n#        exchange_mode main;\n#        proposal {\n#                encryption_algorithm aes128;\n#                hash_algorithm sha1;\n#                authentication_method pre_shared_key;\n#                dh_group 2;\n#       }\n#}\nsainfo address 169.254.xx.xx/30 any address 169.254.xx.xx/30 any {\n        pfs_group 2;\n        lifetime time 3600 seconds;\n        encryption_algorithm aes128;\n        authentication_algorithm hmac_sha1;\n        compression_algorithm deflate;\n}\n\n# sainfo address 169.254.xx.xx/30 any address 169.254.xx.xx/30 any {\n#        pfs_group 2;\n#        lifetime time 3600 seconds;\n#        encryption_algorithm aes128;\n#        authentication_algorithm hmac_sha1;\n#        compression_algorithm deflate;\n#}\n\n\nLinux\u306e\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u8a2d\u5b9a\n# \u7d4c\u8def\u304c\u307b\u3057\u3044\u3060\u3051\u3067\u30a4\u30f3\u30bf\u30fc\u30d5\u30a7\u30fc\u30b9\u306f\u4f55\u3067\u3082\u3088\u3044\u3002\n# \u5b9f\u969b\u306b\u30c8\u30f3\u30cd\u30eb\u30a4\u30f3\u30bf\u30fc\u30d5\u30a7\u30fc\u30b9\u3068\u3057\u3066\u4f7f\u3046\u308f\u3051\u3067\u306f\u306a\u3044\u306e\u3067Remote\u306eIP\u306f\u306a\u3093\u3067\u3082\u3044\u3044\niptunnel add ipsec0 mode ipip remote xx.xx.xx.xx\n# IPSec\u5185\u5074IP\u3092\u6307\u5b9a\nip addr add 169.254.26.190/30  dev ipsec0\nip link set ipsec0 mtu 1427\nip link set ipsec0 up\n# \u30eb\u30fc\u30c6\u30a3\u30f3\u30b0\u6709\u52b9\u53ef\necho 1 > /proc/sys/net/ipv4/ip_forward\n\n\nQuagga\u8a2d\u5b9a\n\n/etc/quagga/daemons\nzebra=yes\nbgpd=yes\n\n\n\n/etc/quagga/zebra.conf\nhostname VR1\npassword zebra\nenable password zebra\n\nlog file /var/log/quagga/zebra.log\n\n\n\n/etc/quagga/bgpd.conf\nhostname VR1\npassword zebra\nrouter bgp 65000\nnetwork 172.24.0.0/16 \n neighbor 169.254.xx.xx remote-as 10124\nlog file /var/log/quagga/bgpd.log\n\n\n\n\u63a5\u7d9a\nservice start setkey\nservice start racoon\nservice start quagga\n\n\u3053\u308c\u3067quagga\u3067peer\u4e0a\u304c\u308c\u3070OK\u3002AWS\u306eVPC\u30eb\u30fc\u30c6\u30a3\u30f3\u30b0\u30c6\u30fc\u30d6\u30eb\u306b\u30ed\u30fc\u30ab\u30eb\u306ePrefix\u3082\u73fe\u308c\u308b\u306f\u305a\u3002\n\n\u554f\u984c\nAWS\u5074\u306b\u3067\u304d\u308b\u4eee\u60f3\u30d7\u30e9\u30a4\u30d9\u30fc\u30c8\u30b2\u30fc\u30c8\u30a6\u30a8\u30a4\u306e2\u3064\u306eIPSec\u63a5\u7d9a\u5148\u30a2\u30c9\u30ec\u30b9\u3092\u5197\u9577\u5316\u76ee\u7684\u3067\u306f\u5229\u7528\u3067\u304d\u306a\u3044\u3002\u52d5\u7684\u306bSA\u3092\u9078\u3079\u306a\u3044\u304b\u3089\u3002BGP\u306ePeer\u306f\u3042\u304c\u308b\u3002\u3067\u3082\u30d1\u30b1\u30c3\u30c8\u9001\u4fe1\u6642\u306b\u7d4c\u8def\u5224\u65ad\u524d\u306bBGP\u306e\u7d4c\u8def\u3068\u95a2\u4fc2\u306a\u304f\u9759\u7684\u306aipsec-tools.conf\u306e\u8a2d\u5b9a\u306b\u3088\u308bSA\u306e\u5224\u5b9a\u3067\u3069\u3061\u3089\u304b\u4e00\u3064\u306eIP\u5b9b\u3066\u306e\u30c8\u30f3\u30cd\u30eb\u306b\u78ba\u5b9a\u3055\u308c\u308b\u3002\u3055\u3089\u306b\u60aa\u3044\u3053\u3068\u306b\u3053\u306e\u5b9b\u5148\u3068BGP\u30d9\u30b9\u30c8\u30d1\u30b9\u304c\u4e0d\u4e00\u81f4\u3060\u3068\u901a\u4fe1\u3067\u304d\u306a\u3044\u3002\nbgpd\u304cVPC\u304b\u3089\u3082\u3089\u3046prefix\u306b\u5bfe\u3057\u3066IPSec\u306e\u30c8\u30f3\u30cd\u30eb\u306b\u4e57\u305b\u308b\u304b\u3069\u3046\u304b\u3092\u5224\u65ad\u3067\u304d\u306a\u3044\u3002\u610f\u5473static route\u3068\u540c\u3058\u3002\u3067\u3082bgpd\u304cprefix\u3092VPC\u3078\u30a2\u30ca\u30a6\u30f3\u30b9\u3067\u304d\u308b\u70b9\u306f\u610f\u5473\u304c\u3042\u308b\u304b\u3082\u3002\n\u30fb\u30fb\u30fb\u30fb\u3068\u3044\u3046\u82e5\u304d\u9803\u901a\u3063\u305f\u884c\u304d\u6b62\u307e\u308a\u306b\u518d\u5ea6\u6c17\u3065\u304b\u305a\u518d\u5ea6\u5230\u9054\u3002\n\u672a\u691c\u8a3c\u3060\u3051\u3069\u8003\u3048\u3089\u308c\u308b\u30bd\u30ea\u30e5\u30fc\u30b7\u30e7\u30f3\u306f\n\n\u540c\u3058\u30b0\u30ed\u30fc\u30d0\u30ebIP\u3067NAT\u3055\u308c\u308bubuntu\u30b5\u30fc\u30d0\u3092\u3082\u3046\uff11\u500b\u7acb\u3066\u308b\u3002\u5197\u9577\u5316\u76ee\u7684\u306a\u3089\u3053\u308c\u304b\u3082\nQUAGGA\u3058\u3083\u306a\u304f\u3066\u30b5\u30dd\u30fc\u30c8\u3055\u308c\u3066\u308bVyatta/vyos\u306a\u3089\u3082\u3046\u5c11\u3057\u4e0a\u624b\u306bIPSec\u3068\u30eb\u30fc\u30c6\u30a3\u30f3\u30b0\u6271\u3048\u308b\u304b\u3082\n\u3061\u3087\u3063\u3068\u8907\u96d1\u306b\u306a\u308b\u3051\u3069AWS\u5074\u306f\u4eee\u60f3\u30d7\u30e9\u30a4\u30d9\u30fc\u30c8\u30b2\u30fc\u30c8\u30a6\u30a8\u30a4\u3058\u3083\u306a\u304f\u3066C\u793e\u4eee\u60f3\u30eb\u30fc\u30bf\u4f7f\u3063\u3066IPsec tunnel mode\u3088\u308a\u67d4\u8edf\u6027\u9ad8\u3044\u30c8\u30f3\u30cd\u30eb\u4f7f\u3046\u3068\u3082\u3046\u5c11\u3057\u30ad\u30ec\u30a4\u306b\u884c\u304f\u304b\u3082\n\n# \u80cc\u666f\nAlibaba\u306eIaaS\u3067\u3042\u308bAlibaba Cloud\u306eECS\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\uff08AWS\u3067\u3044\u3046EC2,\u4eee\u60f3\u30b5\u30fc\u30d0\uff09\u306e\u6027\u80fd\u81ea\u4f53\u306f\u60aa\u304f\u306f\u306a\u3055\u305d\u3046\u306a\u306e\u3067\u3001AWS\u306eVPC\u3068\u306e\u9593\u306bIPSec VPN\u306b\u3088\u308b\u9589\u57df\u7db2\u63a5\u7d9a\u3057\u305f\u3046\u3048\u3067\u4f7f\u3044\u305f\u3044\u3002\u3067\u3082IPSec\u3067VPC\u76f4\u7d50\u3057\u3066\u7d4c\u8def\u4ea4\u63db\u306f\u7121\u7406\u305d\u3046\u3002\u305d\u3093\u306a\u308f\u3051\u3067\u3001Linux(Alibaba cloud\u306einstance)\u3092Customer gateway\u3068\u3057\u3066VPC\u3078\u63a5\u7d9a\u3059\u308b\u65b9\u6cd5\u306e\u307e\u3068\u3081\u3002NAT\u914d\u4e0b\u306e\u30aa\u30f3\u30d7\u30ecLinux\u3067\u3082\u307b\u304b\u306eIaaS\u3067\u3082\u540c\u69d8\u306b\u3044\u3051\u308b\u306f\u305a\u3002\n![image](https://qiita-image-store.s3.amazonaws.com/0/132165/40fc9aa0-1bdb-dfa1-f70e-b7e9764e228a.png)\n\n\n\n# AWS\u5074\u306e\u6e96\u5099\n## \u30ab\u30b9\u30bf\u30de\u30fc\u30b2\u30fc\u30c8\u30a6\u30a7\u30a4\u306e\u6e96\u5099\nCPE\u3001\u4eca\u56de\u306fLinux\u306e\u60c5\u5831\u3092\u5b9a\u7fa9\u3002Linux\u306f\u30b5\u30dd\u30fc\u30c8\u5bfe\u8c61\u5916\u3002\u9759\u7684\u30eb\u30fc\u30c6\u30a3\u30f3\u30b0\u3067\u3042\u308c\u3070Wndows Server\u306f\u30b5\u30dd\u30fc\u30c8\u5bfe\u8c61\u3063\u307d\u3044VPC\u306e\u30b3\u30f3\u30bd\u30fc\u30eb\u3067\u64cd\u4f5c\u3002\u3068\u308a\u3042\u3048\u305aBGP\u558b\u308c\u308b\u3088\u3046\u306b\u3001IP\u30a2\u30c9\u30ec\u30b9\u306fNat\u5f8c\u306e\u30b0\u30ed\u30fc\u30d0\u30ebIP\u30a2\u30c9\u30ec\u30b9\u3002\u898b\u305f\u611f\u3058IPSec\u306fNat traversal\u3060\u3051\u3069Main mode\u306e\u307f\u3063\u307d\u3044\u306e\u3067\u30b0\u30ed\u30fc\u30d0\u30eb\u30a2\u30c9\u30ec\u30b9\u304c\u52d5\u7684\u306b\u5909\u308f\u308b\u74b0\u5883\u3060\u3068NG\u3060\u3068\u601d\u308f\u308c\u308b\u3002\n![image](https://qiita-image-store.s3.amazonaws.com/0/132165/738a7951-3469-058c-1979-f52981a8e899.png)\n\ncli\u306a\u3089\u3053\u3093\u306a\u611f\u3058\u3002\n\n```Bash:aws-cli\n# cli\naws ec2 create-customer-gateway --type ipsec.1 --public-ip 47.91.xx.xx --bgp-asn 65000\n# response\n{\n    \"CustomerGateway\": {\n        \"CustomerGatewayId\": \"cgw-0b7bxxxx\",\n        \"IpAddress\": \"47.91.xx.xx\",\n        \"State\": \"available\",\n        \"Type\": \"ipsec.1\",\n        \"BgpAsn\": \"65000\"\n    }\n}\n```\n\n## \u4eee\u60f3\u30d7\u30e9\u30a4\u30d9\u30fc\u30c8\u30b2\u30fc\u30c8\u30a6\u30a8\u30a4\n\u6b21\u306bAWS\u5074\u306e\u4eee\u60f3\u30d7\u30e9\u30a4\u30d9\u30fc\u30c8\u30b2\u30fc\u30c8\u30a6\u30a8\u30a4\u3092\u4f5c\u6210\u3002\n![image](https://qiita-image-store.s3.amazonaws.com/0/132165/a70cc2b5-8b4a-4675-f33e-e528cddb1285.png)\n\ncli\u306a\u3089\u3053\u3093\u306a\u304b\u3093\u3058\n\n```Bash:aws-cli\n# cli\naws ec2 create-vpn-gateway --type ipsec.1\n# response\n{\n    \"VpnGateway\": {\n        \"State\": \"available\",\n        \"Type\": \"ipsec.1\",\n        \"VpnGatewayId\": \"vgw-328cxxxx\",\n        \"VpcAttachments\": []\n    }\n}\n```\n\n\u65e2\u5b58\u306eVPC\u306b\u30a2\u30c3\u30bf\u30c3\u30c1\u3059\u308b\n![image](https://qiita-image-store.s3.amazonaws.com/0/132165/5d9211cf-1fe4-04f9-f8db-5d498a6fd0bd.png)\n\n```Bash:aws-cli\n# cli\naws ec2 attach-vpn-gateway --vpn-gateway-id vgw-328cxxxx --vpc-id vpc-c9b0xxxx\n# response\n{\n    \"VpcAttachment\": {\n        \"State\": \"attaching\",\n        \"VpcId\": \"vpc-c9b0xxxx\"\n    }\n}\n```\n\n## VPN\u63a5\u7d9a\u3092\u4f5c\u6210\n\u5148\u307b\u3069\u4f5c\u6210\u3057\u305f\u30ab\u30b9\u30bf\u30de\u30fc\u30b2\u30fc\u30c8\u30a6\u30a8\u30a4\u3068\u4eee\u60f3\u30d7\u30e9\u30a4\u30d9\u30fc\u30c8\u30b2\u30fc\u30c8\u30a6\u30a8\u30a4\u3092\u4f7f\u7528\u3057\u3066VPN\u63a5\u7d9a\u3092\u4f5c\u6210\u3002\n![image](https://qiita-image-store.s3.amazonaws.com/0/132165/b824047a-f8c6-173b-f2fa-f9cb50b6a842.png)\n\n```Bash:aws-cli\n# cli\n aws ec2 create-vpn-connection --type ipsec.1 --customer-gateway-id cgw-0b7bcb0a --\n# output\nvpn-gateway-id vgw-328c3c33\n{\n    \"VpnConnection\": {\n        \"VpnConnectionId\": \"vpn-30a2xxxx\",\n        \"CustomerGatewayConfiguration\": \"<?xml\u30fb\u30fb\u30fb \",\u3000//XML\u6587\u7701\u7565\n\n        \"State\": \"pending\",\n        \"VpnGatewayId\": \"vgw-328cxxxx\",\n        \"CustomerGatewayId\": \"cgw-0b7bxxxx\"\n    }\n}\n```\n\nIPSecVPN 2\u672c\u306e\u63a5\u7d9a\u60c5\u5831\u304c\u4e0a\u306eoutput\u306e\u4e2d\u3067XML\u3067\u8a18\u8f09\u3055\u308c\u3066\u3044\u308b\u3002\n\n```XML:\u6574\u5f62vpn-connection\n\t<vpn_connection id=\\\"vpn-30a2xxxx\\\">\n\t\t<ipsec_tunnel>\n\t\t\t<customer_gateway>\n\t\t\t\t<tunnel_outside_address>\n\t\t\t\t\t<ip_address>47.91.xx.xx</ip_address>\n\t\t\t\t</tunnel_outside_address>\n\t\t\t\t<tunnel_inside_address>\n\t\t\t\t\t<ip_address>169.254.xx.xx</ip_address>\n\t\t\t\t\t<network_mask>255.255.255.252</network_mask>\n\t\t\t\t\t<network_cidr>30</network_cidr>\n\t\t\t\t</tunnel_inside_address>\n\t\t\t\t<bgp>\n\t\t\t\t\t<asn>65000</asn>\n\t\t\t\t\t<hold_time>30</hold_time>\n\t\t\t\t</bgp>\n\t\t\t</customer_gateway>\n\t\t\t<vpn_gateway>\n\t\t\t\t<tunnel_outside_address>\n\t\t\t\t\t<ip_address>52.68.xx.xx</ip_address>\n\t\t\t\t</tunnel_outside_address>\n\t\t\t\t<tunnel_inside_address>\n\t\t\t\t\t<ip_address>169.254.xx.xx</ip_address>\n\t\t\t\t\t<network_mask>255.255.255.252</network_mask>\n\t\t\t\t\t<network_cidr>30</network_cidr>\n\t\t\t\t</tunnel_inside_address>\n\t\t\t\t<bgp>\n\t\t\t\t\t<asn>10124</asn>\n\t\t\t\t\t<hold_time>30</hold_time>\n\t\t\t\t</bgp>\n\t\t\t</vpn_gateway>\n\t\t\t<ike>\n\t\t\t\t<authentication_protocol>sha1</authentication_protocol>\n\t\t\t\t<encryption_protocol>aes-128-cbc</encryption_protocol>\n\t\t\t\t<lifetime>28800</lifetime>\n\t\t\t\t<perfect_forward_secrecy>group2</perfect_forward_secrecy>\n\t\t\t\t<mode>main</mode>\n\t\t\t\t<pre_shared_key>xxxxxxxxxx</pre_shared_key>\n\t\t\t</ike>\n\t\t\t<ipsec>\n\t\t\t\t<protocol>esp</protocol>\n\t\t\t\t<authentication_protocol>hmac-sha1-96</authentication_protocol>\n\t\t\t\t<encryption_protocol>aes-128-cbc</encryption_protocol>\n\t\t\t\t<lifetime>3600</lifetime>\n\t\t\t\t<perfect_forward_secrecy>group2</perfect_forward_secrecy>\n\t\t\t\t<mode>tunnel</mode>\n\t\t\t\t<clear_df_bit>true</clear_df_bit>\n\t\t\t\t<fragmentation_before_encryption>true</fragmentation_before_encryption>\n\t\t\t\t<tcp_mss_adjustment>1387</tcp_mss_adjustment>\n\t\t\t\t<dead_peer_detection>\n\t\t\t\t<interval>10</interval>\n\t\t\t\t<retries>3</retries>\n\t\t\t\t</dead_peer_detection>\n\t\t\t</ipsec>\n\t\t</ipsec_tunnel>\n\t\t<ipsec_tunnel>\n\t\t\t<customer_gateway>\n\t\t\t\t<tunnel_outside_address>\n\t\t\t\t\t<ip_address>47.91.xx.xx</ip_address>\n\t\t\t\t</tunnel_outside_address>\n\t\t\t\t<tunnel_inside_address>\n\t\t\t\t\t<ip_address>169.254.xx.xx</ip_address>\n\t\t\t\t\t<network_mask>255.255.255.252</network_mask>\n\t\t\t\t\t<network_cidr>30</network_cidr>\n\t\t\t\t</tunnel_inside_address>\n\t\t\t\t<bgp>\n\t\t\t\t\t<asn>65000</asn>\n\t\t\t\t\t<hold_time>30</hold_time>\n\t\t\t\t</bgp>\n\t\t\t</customer_gateway>\n\t\t\t<vpn_gateway>\n\t\t\t\t<tunnel_outside_address>\n\t\t\t\t\t<ip_address>54.64.xx.xx</ip_address>\n\t\t\t\t</tunnel_outside_address>\n\t\t\t\t<tunnel_inside_address>\n\t\t\t\t\t<ip_address>169.254.xx.xx</ip_address>\n\t\t\t\t\t<network_mask>255.255.255.252</network_mask>\n\t\t\t\t\t<network_cidr>30</network_cidr>\n\t\t\t\t</tunnel_inside_address>\n\t\t\t\t<bgp>\n\t\t\t\t\t<asn>10124</asn>\n\t\t\t\t<hold_time>30</hold_time>\n\t\t\t\t</bgp>\n\t\t\t</vpn_gateway>\n\t\t\t<ike>\n\t\t\t\t<authentication_protocol>sha1</authentication_protocol>\n\t\t\t\t<encryption_protocol>aes-128-cbc</encryption_protocol>\n\t\t\t\t<lifetime>28800</lifetime>\n\t\t\t\t<perfect_forward_secrecy>group2</perfect_forward_secrecy>\n\t\t\t\t<mode>main</mode>\n\t\t\t\t<pre_shared_key>xxxxxxxxx</pre_shared_key>\n\t\t\t</ike>\n\t\t\t<ipsec>\n\t\t\t\t<protocol>esp</protocol>\n\t\t\t\t<authentication_protocol>hmac-sha1-96</authentication_protocol>\n\t\t\t\t<encryption_protocol>aes-128-cbc</encryption_protocol>\n\t\t\t\t<lifetime>3600</lifetime>\n\t\t\t\t<perfect_forward_secrecy>group2</perfect_forward_secrecy>\n\t\t\t\t<mode>tunnel</mode>\n\t\t\t\t<clear_df_bit>true</clear_df_bit>\n\t\t\t\t<fragmentation_before_encryption>true</fragmentation_before_encryption>\n\t\t\t\t<tcp_mss_adjustment>1387</tcp_mss_adjustment>\n\t\t\t\t<dead_peer_detection>\n\t\t\t\t\t<interval>10</interval>\n\t\t\t\t\t<retries>3</retries>\n\t\t\t\t</dead_peer_detection>\n\t\t\t</ipsec>\n\t\t</ipsec_tunnel>\n\t</vpn_connection>\n\n```\n\n\u5c11\u306a\u304f\u3068\u3082\u5909\u52d5\u5024\u306f\u3072\u304b\u3048\u3066\u304a\u304f\u3002\n\n* \u30ab\u30b9\u30bf\u30de\u30fc\u30b2\u30fc\u30c8\u30a6\u30a8\u30a4\n    * IPsec\u5916\u5074\u306e\u30a2\u30c9\u30ec\u30b9\uff08\u81ea\u5206\u306e\u30d7\u30e9\u30a4\u30d9\u30fc\u30c8\u30a2\u30c9\u30ec\u30b9\uff09\n    * IPsec\u5185\u5074\u306e\u30a2\u30c9\u30ec\u30b9\uff08VPC\u304b\u3089\u6255\u3044\u51fa\u3057\uff09\n    * ASN\uff08\u81ea\u5206\u3067\u6307\u5b9a\uff09\n* \u4eee\u60f3\u30d7\u30e9\u30a4\u30d9\u30fc\u30c8\u30b2\u30fc\u30c8\u30a6\u30a8\u30a4\n    * IPsec\u5916\u5074\u306e\u30a2\u30c9\u30ec\u30b9\uff08VPC\u304b\u3089\u6255\u3044\u51fa\u3057\uff09\n    * IPsec\u5185\u5074\u306e\u30a2\u30c9\u30ec\u30b9\uff08VPC\u304b\u3089\u6255\u3044\u51fa\u3057\uff09\n    * ASN\uff0810124\u56fa\u5b9a\uff1f\uff09\n* IKE\n    * pre-shared key\n\nWebUI\u304b\u3089\u78ba\u8a8d\u3059\u308b\u65b9\u6cd5\u306f\u3001VPN\u63a5\u7d9a\uff1e\u8a2d\u5b9a\u306e\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3067Configuration\u306e\u8aad\u3081\u308b\u30bf\u30a4\u30d7\u306e\u6a5f\u5668\u306e\u8a2d\u5b9a\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u3066\u5206\u6790\u3059\u308b\u4ee5\u5916\u306b\u306a\u3044\u306e\u304b\u306a\uff1f\n## \u30eb\u30fc\u30c8\u4f1d\u64ad\n\u6700\u5f8c\u306b\u30eb\u30fc\u30c6\u30a3\u30f3\u30b0\u30c6\u30fc\u30d6\u30eb\u3067\u4eee\u60f3\u30d7\u30e9\u30a4\u30d9\u30fc\u30c8\u30b2\u30fc\u30c8\u30a6\u30a8\u30a4\u304b\u3089\u306e\u30eb\u30fc\u30c8\u4f1d\u64ad\u3092\u30aa\u30f3\u306b\u3002\u3053\u308c\u3092\u3057\u306a\u3044\u3068\u53d7\u3051\u53d6\u3063\u305fPrefix\u304cVPC\u5074\u306e\u30eb\u30fc\u30c6\u30a3\u30f3\u30b0\u30c6\u30fc\u30d6\u30eb\u306b\u53cd\u6620\u3055\u308c\u306a\u3044\u3002\n![image](https://qiita-image-store.s3.amazonaws.com/0/132165/450353e6-7504-1f9e-89fa-2317fbb56bd7.png)\n\n```Bash:aws-cli\naws ec2 enable-vgw-route-propagation --route-table-id rtb-1836xxxx --gateway-id vgw-328cxxxx\n```\n\n## memo\n\u696d\u52d9\u7528\u9014\u306a\u3089\u305f\u3044\u3057\u305f\u91d1\u984d\u3067\u306f\u306a\u3044\u3051\u3069\u3001\u500b\u4eba\u7684\u306b\u904a\u3076\u3089\u306aVPN\u63a5\u7d9a\u304c\u6709\u52b9\u306a\u9593\u305a\u3063\u3068\u8ab2\u91d1\u3055\u308c\u7d9a\u3051\u308b\u304b\u3089\u3001\u4f7f\u3046\u6642\u3060\u3051\u4f5c\u6210\u3057\u3066\u5bfe\u5411\u306eIPSec\u63a5\u7d9a\u3092\u629c\u304f\u3088\u3046\u306bScript\u4f5c\u3063\u3066\u304a\u304f\u306e\u304c\u3044\u3044\u304b\u3082\u3002\u305d\u3093\u306a\u308f\u3051\u3067cli\u5927\u4e8b\u3002\n\n\n# ubuntu\u5074\u6e96\u5099\n## IPSec\u8a2d\u5b9a\n\n```Bash:\u5fc5\u8981\u306a\u30d1\u30c3\u30b1\u30fc\u30b8\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\napt-get install ipsec-tools racoon quagga\n```\n\n\u7279\u5b9a\u306e\u30c8\u30e9\u30d5\u30a3\u30c3\u30af\u3092IPsec\u30c8\u30f3\u30cd\u30eb\u306e\u4e2d\u3078\u3002\u30c8\u30f3\u30cd\u30eb\u306fLinux\u306eNAT\u524d\u306e\u30d7\u30e9\u30a4\u30d9\u30fc\u30c8IP\u3068\u63a5\u7d9a\u5148\u306eVPC\u4eee\u60f3\u30d7\u30e9\u30a4\u30d9\u30fc\u30c8\u30b2\u30fc\u30c8\u30a6\u30a8\u30a4\u306e\u30b0\u30ed\u30fc\u30d0\u30ebIP\u30a2\u30c9\u30ec\u30b9\u306e\u30da\u30a2\u3067\u6307\u5b9a\u3002\u5f53\u7136\u4e21\u7aef\u306e\u30d7\u30e9\u30a4\u30d9\u30fc\u30c8\u30a2\u30c9\u30ec\u30b9\u7a7a\u9593\u3060\u3051\u3067\u306a\u304f\u3001IPSec\u306e\u5185\u5074\u306e\u30a2\u30c9\u30ec\u30b9\u3082\u6697\u53f7\u5316\u3059\u308b\u5fc5\u8981\u3042\u308a\u3002\n\n```Bash:/etc/ipsec-tools.conf\n#!/usr/sbin/setkey -f\nflush;\nspdflush;\n\n# Tunnel1\nspdadd 169.254.xx.xx/30 169.254.xx.xx/30 any -P out ipsec esp/tunnel/172.24.x.x-52.68.xx.xx/require;\nspdadd 169.254.xx.xx/30 169.254.xx.xx/30 any -P in  ipsec esp/tunnel/52.68.xx.xx-172.24.x.x/require;\nspdadd 169.254.xx.xx/30 172.31.0.0/16    any -P out ipsec esp/tunnel/172.24.x.x-52.68.xx.xx/require;\nspdadd 172.31.0.0/16 169.254.xx.xx/30    any -P in  ipsec esp/tunnel/52.68.xx.xx-172.24.0.1/require;\nspdadd 172.24.0.0/16 172.31.0.0/16    any -P out ipsec esp/tunnel/172.24.x.x-52.68.xx.xx/require;\nspdadd 172.31.0.0/16 172.24.0.0/16    any -P in  ipsec esp/tunnel/52.68.xx.xx-172.24.0.1/require;\n\n# Tunnel2 \u6b8b\u5ff5\u306a\u304c\u30892\u672c\u76ee\u306e\u30c8\u30f3\u30cd\u30eb\u306f\u610f\u5473\u304c\u306a\u3044\u3053\u3068\u304c\u5224\u660e\n#spdadd 169.254.xx.xx/30 169.254.xx.xx/30 any -P out ipsec esp/tunnel/172.24.0.1-54.64.xx.xx/require;\n#spdadd 169.254.xx.xx/30 169.254.xx.xx/30 any -P in  ipsec esp/tunnel/54.64.xx.xx-172.24.0.1/require;\n#spdadd 169.254.xx.xx/30 172.31.0.0/16    any -P out ipsec esp/tunnel/172.24.0.1-54.64.xx.xx/require;\n#spdadd 172.31.0.0/16 169.254.xx.xx/30    any -P in  ipsec esp/tunnel/54.64.xx.xx-172.24.0.1/require;\n#spdadd 172.24.0.0/16 172.31.0.0/16     any -P out ipsec esp/tunnel/172.24.0.1-54.64.xx.xx/require;\n#spdadd 172.31.0.0/16 172.24.0.0/16     any -P in  ipsec esp/tunnel/54.64.xx.xx-172.24.0.1/require;\n```\n\n\u5bfe\u5411\u306epre-shared key\u3092\u6307\u5b9a\n\n```Bash:/etc/racoon/psk.txt\n# \u4eee\u60f3\u30d7\u30e9\u30a4\u30d9\u30fc\u30c8\u30b2\u30fc\u30c8\u30a6\u30a8\u30a4\u306e\u5916\u5074\u306e\u30a2\u30c9\u30ec\u30b9\u3068pre-shared key\u306e\u30da\u30a2\n52.68.xxx.xxx sDei_5KCLDC20CMf1tgSAbSEpeO8jVGM\n# 2\u672c\u76ee\u306f\u610f\u5473\u304c\u306a\u3055\u305d\u3046\n#54.64.xxx.xxx r77N2jG.CYnvIIr836.lk2ZBxp5CMH8g\n```\n\nIKE\u30d5\u30a7\u30fc\u30ba\uff11\u3001\uff12\u306e\u60c5\u5831\u3002\n\n```Bash:/etc/racoon/racoon.conf\npath pre_shared_key \"/etc/racoon/psk.txt\";\npath certificate \"/etc/racoon/certs\";\n\nremote 52.68.xx.xx {\n        exchange_mode main;\n        lifetime time 28800 seconds;\n        generate_policy off;\n        nat_traversal force;\n        exchange_mode main;\n        proposal {\n                encryption_algorithm aes128;\n                hash_algorithm sha1;\n                authentication_method pre_shared_key;\n                dh_group 2;\n        }\n}\n\n#remote 54.64.xx.xx {\n#        exchange_mode main;\n#        lifetime time 28800 seconds;\n#        nat_traversal force;\n#        generate_policy off;\n#        exchange_mode main;\n#        proposal {\n#                encryption_algorithm aes128;\n#                hash_algorithm sha1;\n#                authentication_method pre_shared_key;\n#                dh_group 2;\n#       }\n#}\nsainfo address 169.254.xx.xx/30 any address 169.254.xx.xx/30 any {\n        pfs_group 2;\n        lifetime time 3600 seconds;\n        encryption_algorithm aes128;\n        authentication_algorithm hmac_sha1;\n        compression_algorithm deflate;\n}\n\n# sainfo address 169.254.xx.xx/30 any address 169.254.xx.xx/30 any {\n#        pfs_group 2;\n#        lifetime time 3600 seconds;\n#        encryption_algorithm aes128;\n#        authentication_algorithm hmac_sha1;\n#        compression_algorithm deflate;\n#}\n```\n\nLinux\u306e\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u8a2d\u5b9a\n\n```Bash\n# \u7d4c\u8def\u304c\u307b\u3057\u3044\u3060\u3051\u3067\u30a4\u30f3\u30bf\u30fc\u30d5\u30a7\u30fc\u30b9\u306f\u4f55\u3067\u3082\u3088\u3044\u3002\n# \u5b9f\u969b\u306b\u30c8\u30f3\u30cd\u30eb\u30a4\u30f3\u30bf\u30fc\u30d5\u30a7\u30fc\u30b9\u3068\u3057\u3066\u4f7f\u3046\u308f\u3051\u3067\u306f\u306a\u3044\u306e\u3067Remote\u306eIP\u306f\u306a\u3093\u3067\u3082\u3044\u3044\niptunnel add ipsec0 mode ipip remote xx.xx.xx.xx\n# IPSec\u5185\u5074IP\u3092\u6307\u5b9a\nip addr add 169.254.26.190/30  dev ipsec0\nip link set ipsec0 mtu 1427\nip link set ipsec0 up\n# \u30eb\u30fc\u30c6\u30a3\u30f3\u30b0\u6709\u52b9\u53ef\necho 1 > /proc/sys/net/ipv4/ip_forward\n```\n\n## Quagga\u8a2d\u5b9a\n\n```Bash:/etc/quagga/daemons\nzebra=yes\nbgpd=yes\n```\n```Bash:/etc/quagga/zebra.conf\nhostname VR1\npassword zebra\nenable password zebra\n\nlog file /var/log/quagga/zebra.log\n```\n\n```Bash:/etc/quagga/bgpd.conf\nhostname VR1\npassword zebra\nrouter bgp 65000\nnetwork 172.24.0.0/16 \n neighbor 169.254.xx.xx remote-as 10124\nlog file /var/log/quagga/bgpd.log\n```\n\n## \u63a5\u7d9a\n```Bash\nservice start setkey\nservice start racoon\nservice start quagga\n```\n\u3053\u308c\u3067quagga\u3067peer\u4e0a\u304c\u308c\u3070OK\u3002AWS\u306eVPC\u30eb\u30fc\u30c6\u30a3\u30f3\u30b0\u30c6\u30fc\u30d6\u30eb\u306b\u30ed\u30fc\u30ab\u30eb\u306ePrefix\u3082\u73fe\u308c\u308b\u306f\u305a\u3002\n\n## \u554f\u984c\nAWS\u5074\u306b\u3067\u304d\u308b\u4eee\u60f3\u30d7\u30e9\u30a4\u30d9\u30fc\u30c8\u30b2\u30fc\u30c8\u30a6\u30a8\u30a4\u306e2\u3064\u306eIPSec\u63a5\u7d9a\u5148\u30a2\u30c9\u30ec\u30b9\u3092\u5197\u9577\u5316\u76ee\u7684\u3067\u306f\u5229\u7528\u3067\u304d\u306a\u3044\u3002\u52d5\u7684\u306bSA\u3092\u9078\u3079\u306a\u3044\u304b\u3089\u3002BGP\u306ePeer\u306f\u3042\u304c\u308b\u3002\u3067\u3082\u30d1\u30b1\u30c3\u30c8\u9001\u4fe1\u6642\u306b\u7d4c\u8def\u5224\u65ad\u524d\u306bBGP\u306e\u7d4c\u8def\u3068\u95a2\u4fc2\u306a\u304f\u9759\u7684\u306aipsec-tools.conf\u306e\u8a2d\u5b9a\u306b\u3088\u308bSA\u306e\u5224\u5b9a\u3067\u3069\u3061\u3089\u304b\u4e00\u3064\u306eIP\u5b9b\u3066\u306e\u30c8\u30f3\u30cd\u30eb\u306b\u78ba\u5b9a\u3055\u308c\u308b\u3002\u3055\u3089\u306b\u60aa\u3044\u3053\u3068\u306b\u3053\u306e\u5b9b\u5148\u3068BGP\u30d9\u30b9\u30c8\u30d1\u30b9\u304c\u4e0d\u4e00\u81f4\u3060\u3068\u901a\u4fe1\u3067\u304d\u306a\u3044\u3002\nbgpd\u304cVPC\u304b\u3089\u3082\u3089\u3046prefix\u306b\u5bfe\u3057\u3066IPSec\u306e\u30c8\u30f3\u30cd\u30eb\u306b\u4e57\u305b\u308b\u304b\u3069\u3046\u304b\u3092\u5224\u65ad\u3067\u304d\u306a\u3044\u3002\u610f\u5473static route\u3068\u540c\u3058\u3002\u3067\u3082bgpd\u304cprefix\u3092VPC\u3078\u30a2\u30ca\u30a6\u30f3\u30b9\u3067\u304d\u308b\u70b9\u306f\u610f\u5473\u304c\u3042\u308b\u304b\u3082\u3002\n\u30fb\u30fb\u30fb\u30fb\u3068\u3044\u3046\u82e5\u304d\u9803\u901a\u3063\u305f\u884c\u304d\u6b62\u307e\u308a\u306b\u518d\u5ea6\u6c17\u3065\u304b\u305a\u518d\u5ea6\u5230\u9054\u3002\n\n\u672a\u691c\u8a3c\u3060\u3051\u3069\u8003\u3048\u3089\u308c\u308b\u30bd\u30ea\u30e5\u30fc\u30b7\u30e7\u30f3\u306f\n\n* \u540c\u3058\u30b0\u30ed\u30fc\u30d0\u30ebIP\u3067NAT\u3055\u308c\u308bubuntu\u30b5\u30fc\u30d0\u3092\u3082\u3046\uff11\u500b\u7acb\u3066\u308b\u3002\u5197\u9577\u5316\u76ee\u7684\u306a\u3089\u3053\u308c\u304b\u3082\n* QUAGGA\u3058\u3083\u306a\u304f\u3066\u30b5\u30dd\u30fc\u30c8\u3055\u308c\u3066\u308bVyatta/vyos\u306a\u3089\u3082\u3046\u5c11\u3057\u4e0a\u624b\u306bIPSec\u3068\u30eb\u30fc\u30c6\u30a3\u30f3\u30b0\u6271\u3048\u308b\u304b\u3082\n* \u3061\u3087\u3063\u3068\u8907\u96d1\u306b\u306a\u308b\u3051\u3069AWS\u5074\u306f\u4eee\u60f3\u30d7\u30e9\u30a4\u30d9\u30fc\u30c8\u30b2\u30fc\u30c8\u30a6\u30a8\u30a4\u3058\u3083\u306a\u304f\u3066C\u793e\u4eee\u60f3\u30eb\u30fc\u30bf\u4f7f\u3063\u3066IPsec tunnel mode\u3088\u308a\u67d4\u8edf\u6027\u9ad8\u3044\u30c8\u30f3\u30cd\u30eb\u4f7f\u3046\u3068\u3082\u3046\u5c11\u3057\u30ad\u30ec\u30a4\u306b\u884c\u304f\u304b\u3082\n\n\n", "tags": ["AWS", "Linux", "vpc", "ipsec", "quagga"]}