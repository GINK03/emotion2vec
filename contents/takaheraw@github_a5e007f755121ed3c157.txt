{"tags": ["GoogleAppsScript", "spreadsheet", "Twitter"], "context": "VPS\u3092Bot\u306e\u70ba\u3060\u3051\u306b\u5229\u7528\u3057\u3066\u3044\u308b\u304c\u3001Google Apps Script \u306b\u7f6e\u304d\u63db\u3048\u308c\u305d\u3046\u306a\u306e\u3067\u3001\u307e\u305a\u306f\u5168\u30c4\u30a4\u30fc\u30c8\u3092\u30b9\u30d7\u30ec\u30c3\u30c9\u30b7\u30fc\u30c8\u306b\u4fdd\u5b58\u3059\u308b\u307e\u3067\u3084\u3063\u3066\u307f\u305f\u3002\n\n\u30b9\u30d7\u30ec\u30c3\u30c9\u30b7\u30fc\u30c8\n\n\u4fdd\u5b58\u3059\u308b\u30c4\u30a4\u30fc\u30c8\u306e\u9805\u76ee\u3092\u7528\u610f\n\n\nGoogle Apps Script \u3068\u95a2\u9023\u4ed8\u3051\n\n\nGoogle Apps Script\n\nOAuth1 \u306eGoogle Apps Script \u30e9\u30a4\u30d6\u30e9\u30ea\n\n\u300c\u30ea\u30bd\u30fc\u30b9\u300d\u21d2\u300c\u30e9\u30a4\u30d6\u30e9\u30ea\u300d\n\n\nhttps://developers.google.com/apps-script/migration/oauth-config\n\n\n\n\n\nauthorize\n\nTwitter\u306e\u300cApplication Management\u300d\u306e\u300cCallback URL\u300d\u306bGoogle Apps Script\u306e\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u30ad\u30fc(\u300c\u30d5\u30a1\u30a4\u30eb\u300d\u21d2\u300c\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u306e\u30d7\u30ed\u30d1\u30c6\u30a3\u300d)\u3092\u8a2d\u5b9a\u3059\u308b\n\n\n\nauthorize\u51e6\u7406\n\nfunction getTwitterService() {\n  var service = OAuth1.createService(\"twitter\");\n  service.setAccessTokenUrl(\"https://api.twitter.com/oauth/access_token\")\n  service.setRequestTokenUrl(\"https://api.twitter.com/oauth/request_token\")\n  service.setAuthorizationUrl(\"https://api.twitter.com/oauth/authorize\")\n  service.setConsumerKey(CONSUMER_KEY);\n  service.setConsumerSecret(CONSUMER_SECRET);\n  service.setProjectKey(PROJECT_KEY);\n  service.setCallbackFunction(\"authCallback\");\n  service.setPropertyStore(PropertiesService.getScriptProperties());\n  return service;\n}\n\nfunction authCallback(request) {\n  var service      = getTwitterService();\n  var isAuthorized = service.handleCallback(request);\n  if(isAuthorized) {\n    return HtmlService.createHtmlOutput(\"Success! You can close this page.\");\n  } else {\n    return HtmlService.createHtmlOutput(\"Denied. You can close this page\");\n  }\n}\n\n\n\u5168\u4ef6\u30c4\u30a4\u30fc\u30c8\u3092\u30b9\u30d7\u30ec\u30c3\u30c9\u30b7\u30fc\u30c8\u306b\u4fdd\u5b58\n\n\n/users/lookup.json\u3067\u5168\u30c4\u30a4\u30fc\u30c8\u4ef6\u6570\u53d6\u5f97\n\u5168\u30c4\u30a4\u30fc\u30c8\u4ef6\u6570/200\u306e\u56de\u6570\u5206/statuses/user_timeline.json\u3092\u53e9\u304f\n\u30b9\u30d7\u30ec\u30c3\u30c9\u30b7\u30fc\u30c8\u306b\u66f8\u304d\u8fbc\u3080\n\nvar SCREEN_NAME       = \"babymetal_japan\";\nvar CONSUMER_KEY      = \"\";\nvar CONSUMER_SECRET   = \"\";\nvar PROJECT_KEY       = \"\";\nvar API_USER_TIMELINE = \"https://api.twitter.com/1.1/statuses/user_timeline.json\";\nvar API_USER_LOOKUP   = \"https://api.twitter.com/1.1/users/lookup.json\";\nvar LIMIT_COUNT       = 200;\nvar CREATED_AT        = 1;\nvar TEXT              = 2;\nvar RETWEET_COUNT     = 3;\nvar FAVORITE_COUNT    = 4;\nvar ENTITIES_MEDIA    = 5;\nvar URL               = 6;\n\nfunction getAllTweets() {\n  Logger.log(\"[START] getAllTweets()\");\n\n  var service = getTwitterService();\n  if(service.hasAccess()) {\n    try {\n      var as              = SpreadsheetApp.getActiveSpreadsheet();\n      var tws             = as.getSheetByName(\"tweet\");              // tweet\u30b7\u30fc\u30c8\n      var iRow            = 3;                                       // \u66f8\u304d\u8fbc\u3080\u884c\u6570\u306e\u958b\u59cb\u4f4d\u7f6e\n      var lookup          = usersLookup(SCREEN_NAME);                // /users/lookup.json\n      var statusesCount   = Math.floor(lookup.statuses_count);       // \u5168\u30c4\u30a4\u30fc\u30c8\u6570\n      var division        = Math.floor(statusesCount / LIMIT_COUNT); // \u5168\u30c4\u30a4\u30fc\u30c8\u3092200\u3067\u5272\u308b\u9664\u7b97\n      var remain          = Math.floor(statusesCount % LIMIT_COUNT); // \u5168\u30c4\u30a4\u30fc\u30c8\u3092200\u3067\u5272\u308b\u5270\u4f59\u7b97\n      var apiRequestCount = remain == 0 ? division : division + 1;   // API\u306e\u30ea\u30af\u30a8\u30b9\u30c8\u6570\n      var max_id          = \"\";\n      var apiUrl          = API_USER_TIMELINE + \"?screen_name=\" + SCREEN_NAME + \"&count=\" + LIMIT_COUNT;\n\n      Logger.log(\"statusesCount = \" + statusesCount);\n      Logger.log(\"apiRequestCount = \" + apiRequestCount);\n\n      for(var i = 0; i < apiRequestCount; i++) {\n        var url      = max_id != \"\" ? apiUrl + \"&max_id=\" + max_id : apiUrl;\n        var response = service.fetch(url);\n        var tweets   = JSON.parse(response.getContentText());\n        if (tweets.length < 1) {\n          break;\n        }\n        max_id = decStrNum(tweets[tweets.length -1].id_str);\n\n        Logger.log(\"tweets = \" + tweets.length);\n        Logger.log(\"max_id = \" + max_id);\n\n        for(var ii = 0; ii < tweets.length; ii++) {\n\n          var d = new Date(tweets[ii].created_at);\n          tws.getRange(iRow, CREATED_AT    ).setValue(Utilities.formatDate(d, \"JST\", \"yyyy-MM-dd HH:mm:ss\"));\n          tws.getRange(iRow, TEXT          ).setValue(tweets[ii].text);\n          tws.getRange(iRow, RETWEET_COUNT ).setValue(tweets[ii].retweet_count);\n          tws.getRange(iRow, FAVORITE_COUNT).setValue(tweets[ii].favorite_count);\n          var media = tweets[ii].entities.media;\n          if(media instanceof Array) {\n            var media_url = [];\n            for(var iii = 0; iii < media.length; iii++) {\n              media_url.push(media[iii].media_url_https);\n            }\n            tws.getRange(iRow, ENTITIES_MEDIA).setValue(media_url.join('\\n'));\n          }\n          tws.getRange(iRow, URL).setValue(\"https://twitter.com/\" + SCREEN_NAME + \"/status/\" + tweets[ii].id_str);\n          iRow++;\n        }\n      }      \n\n    } catch(e) {\n      Logger.log(\"[ERROR] getAllTweets() : \" + e.message);\n      MailApp.sendEmail(\"hogehoge@example.com\", \"[ERROR] getAllTweets()\", e.message);\n    }\n  } else {\n    var authorizationUrl = service.authorize();\n    Logger.log(\"Please visit the following URL and then re-run the script: \" + authorizationUrl);\n  }\n\n  Logger.log(\"[END] allTweets()\");\n}\n\nfunction usersLookup(screen_name) {\n  var service = getTwitterService();\n  if(service.hasAccess()) {\n    var url      = API_USER_LOOKUP + \"?screen_name=\" + screen_name;\n    var response = service.fetch(url);\n    var tweets   = JSON.parse(response.getContentText());\n    return tweets[0]\n  } else {\n    var authorizationUrl = service.authorize();\n    Logger.log(\"Please visit the following URL and then re-run the script: \" + authorizationUrl);\n  }\n}\n\n/* \n * Decreasing 64-bit Tweet ID\n */\nfunction decStrNum(n) {\n  n          = n.toString(); \n  var result = n; \n  var i      = n.length - 1; \n  while(i > -1) { \n    if(n[i] === \"0\") {\n      result = result.substring(0, i) + \"9\" + result.substring(i + 1); \n      i --; \n    } else { \n      result = result.substring(0, i) + (parseInt(n[i], 10) -1).toString() + result.substring(i + 1); \n      return result; \n    }\n  } \n  return result; \n}\n\nfunction onOpen() {\n  var ss = SpreadsheetApp.getActiveSpreadsheet();\n  var menuEntries = [\n    {name: \"Tweet\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\", functionName: \"getAllTweets\"}\n  ];\n  ss.addMenu(\"\u30b9\u30af\u30ea\u30d7\u30c8\",menuEntries);\n}\n\n\n\u30a2\u30a6\u30c8\u30d7\u30c3\u30c8\n\nVPS\u3092Bot\u306e\u70ba\u3060\u3051\u306b\u5229\u7528\u3057\u3066\u3044\u308b\u304c\u3001Google Apps Script \u306b\u7f6e\u304d\u63db\u3048\u308c\u305d\u3046\u306a\u306e\u3067\u3001\u307e\u305a\u306f\u5168\u30c4\u30a4\u30fc\u30c8\u3092\u30b9\u30d7\u30ec\u30c3\u30c9\u30b7\u30fc\u30c8\u306b\u4fdd\u5b58\u3059\u308b\u307e\u3067\u3084\u3063\u3066\u307f\u305f\u3002\n\n# \u30b9\u30d7\u30ec\u30c3\u30c9\u30b7\u30fc\u30c8\n\n## \u4fdd\u5b58\u3059\u308b\u30c4\u30a4\u30fc\u30c8\u306e\u9805\u76ee\u3092\u7528\u610f\n\n![sp1.png](https://qiita-image-store.s3.amazonaws.com/0/7086/e5ffbee7-0b4e-4a54-2343-eed155e08d83.png)\n\n## Google Apps Script \u3068\u95a2\u9023\u4ed8\u3051\n\n<img width=\"674\" alt=\"\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2016-10-01 17.16.59.png\" src=\"https://qiita-image-store.s3.amazonaws.com/0/7086/79b92353-bff4-46d3-573b-ca9a2d25eb04.png\">\n\n# Google Apps Script\n\n## OAuth1 \u306eGoogle Apps Script \u30e9\u30a4\u30d6\u30e9\u30ea\n\n+ \u300c\u30ea\u30bd\u30fc\u30b9\u300d\u21d2\u300c\u30e9\u30a4\u30d6\u30e9\u30ea\u300d\n    + https://developers.google.com/apps-script/migration/oauth-config\n\n![auth1.png](https://qiita-image-store.s3.amazonaws.com/0/7086/579a090c-95e2-a6d4-3968-5fe9151982b8.png)\n\n## authorize\n\n+ Twitter\u306e\u300cApplication Management\u300d\u306e\u300cCallback URL\u300d\u306bGoogle Apps Script\u306e\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u30ad\u30fc(\u300c\u30d5\u30a1\u30a4\u30eb\u300d\u21d2\u300c\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u306e\u30d7\u30ed\u30d1\u30c6\u30a3\u300d)\u3092\u8a2d\u5b9a\u3059\u308b\n\n![call.png](https://qiita-image-store.s3.amazonaws.com/0/7086/fbe03317-8b3e-444d-76de-4dc6bc46a62f.png)\n\n+ authorize\u51e6\u7406\n\n```java\nfunction getTwitterService() {\n  var service = OAuth1.createService(\"twitter\");\n  service.setAccessTokenUrl(\"https://api.twitter.com/oauth/access_token\")\n  service.setRequestTokenUrl(\"https://api.twitter.com/oauth/request_token\")\n  service.setAuthorizationUrl(\"https://api.twitter.com/oauth/authorize\")\n  service.setConsumerKey(CONSUMER_KEY);\n  service.setConsumerSecret(CONSUMER_SECRET);\n  service.setProjectKey(PROJECT_KEY);\n  service.setCallbackFunction(\"authCallback\");\n  service.setPropertyStore(PropertiesService.getScriptProperties());\n  return service;\n}\n\nfunction authCallback(request) {\n  var service      = getTwitterService();\n  var isAuthorized = service.handleCallback(request);\n  if(isAuthorized) {\n    return HtmlService.createHtmlOutput(\"Success! You can close this page.\");\n  } else {\n    return HtmlService.createHtmlOutput(\"Denied. You can close this page\");\n  }\n}\n```\n\n## \u5168\u4ef6\u30c4\u30a4\u30fc\u30c8\u3092\u30b9\u30d7\u30ec\u30c3\u30c9\u30b7\u30fc\u30c8\u306b\u4fdd\u5b58\n\n1. `/users/lookup.json`\u3067\u5168\u30c4\u30a4\u30fc\u30c8\u4ef6\u6570\u53d6\u5f97\n2. \u5168\u30c4\u30a4\u30fc\u30c8\u4ef6\u6570/200\u306e\u56de\u6570\u5206`/statuses/user_timeline.json`\u3092\u53e9\u304f\n3. \u30b9\u30d7\u30ec\u30c3\u30c9\u30b7\u30fc\u30c8\u306b\u66f8\u304d\u8fbc\u3080\n\n```java\nvar SCREEN_NAME       = \"babymetal_japan\";\nvar CONSUMER_KEY      = \"\";\nvar CONSUMER_SECRET   = \"\";\nvar PROJECT_KEY       = \"\";\nvar API_USER_TIMELINE = \"https://api.twitter.com/1.1/statuses/user_timeline.json\";\nvar API_USER_LOOKUP   = \"https://api.twitter.com/1.1/users/lookup.json\";\nvar LIMIT_COUNT       = 200;\nvar CREATED_AT        = 1;\nvar TEXT              = 2;\nvar RETWEET_COUNT     = 3;\nvar FAVORITE_COUNT    = 4;\nvar ENTITIES_MEDIA    = 5;\nvar URL               = 6;\n\nfunction getAllTweets() {\n  Logger.log(\"[START] getAllTweets()\");\n\n  var service = getTwitterService();\n  if(service.hasAccess()) {\n    try {\n      var as              = SpreadsheetApp.getActiveSpreadsheet();\n      var tws             = as.getSheetByName(\"tweet\");              // tweet\u30b7\u30fc\u30c8\n      var iRow            = 3;                                       // \u66f8\u304d\u8fbc\u3080\u884c\u6570\u306e\u958b\u59cb\u4f4d\u7f6e\n      var lookup          = usersLookup(SCREEN_NAME);                // /users/lookup.json\n      var statusesCount   = Math.floor(lookup.statuses_count);       // \u5168\u30c4\u30a4\u30fc\u30c8\u6570\n      var division        = Math.floor(statusesCount / LIMIT_COUNT); // \u5168\u30c4\u30a4\u30fc\u30c8\u3092200\u3067\u5272\u308b\u9664\u7b97\n      var remain          = Math.floor(statusesCount % LIMIT_COUNT); // \u5168\u30c4\u30a4\u30fc\u30c8\u3092200\u3067\u5272\u308b\u5270\u4f59\u7b97\n      var apiRequestCount = remain == 0 ? division : division + 1;   // API\u306e\u30ea\u30af\u30a8\u30b9\u30c8\u6570\n      var max_id          = \"\";\n      var apiUrl          = API_USER_TIMELINE + \"?screen_name=\" + SCREEN_NAME + \"&count=\" + LIMIT_COUNT;\n    \n      Logger.log(\"statusesCount = \" + statusesCount);\n      Logger.log(\"apiRequestCount = \" + apiRequestCount);\n    \n      for(var i = 0; i < apiRequestCount; i++) {\n        var url      = max_id != \"\" ? apiUrl + \"&max_id=\" + max_id : apiUrl;\n        var response = service.fetch(url);\n        var tweets   = JSON.parse(response.getContentText());\n        if (tweets.length < 1) {\n          break;\n        }\n        max_id = decStrNum(tweets[tweets.length -1].id_str);\n\n        Logger.log(\"tweets = \" + tweets.length);\n        Logger.log(\"max_id = \" + max_id);\n\n        for(var ii = 0; ii < tweets.length; ii++) {\n\n          var d = new Date(tweets[ii].created_at);\n          tws.getRange(iRow, CREATED_AT    ).setValue(Utilities.formatDate(d, \"JST\", \"yyyy-MM-dd HH:mm:ss\"));\n          tws.getRange(iRow, TEXT          ).setValue(tweets[ii].text);\n          tws.getRange(iRow, RETWEET_COUNT ).setValue(tweets[ii].retweet_count);\n          tws.getRange(iRow, FAVORITE_COUNT).setValue(tweets[ii].favorite_count);\n          var media = tweets[ii].entities.media;\n          if(media instanceof Array) {\n            var media_url = [];\n            for(var iii = 0; iii < media.length; iii++) {\n              media_url.push(media[iii].media_url_https);\n            }\n            tws.getRange(iRow, ENTITIES_MEDIA).setValue(media_url.join('\\n'));\n          }\n          tws.getRange(iRow, URL).setValue(\"https://twitter.com/\" + SCREEN_NAME + \"/status/\" + tweets[ii].id_str);\n          iRow++;\n        }\n      }      \n\n    } catch(e) {\n      Logger.log(\"[ERROR] getAllTweets() : \" + e.message);\n      MailApp.sendEmail(\"hogehoge@example.com\", \"[ERROR] getAllTweets()\", e.message);\n    }\n  } else {\n    var authorizationUrl = service.authorize();\n    Logger.log(\"Please visit the following URL and then re-run the script: \" + authorizationUrl);\n  }\n  \n  Logger.log(\"[END] allTweets()\");\n}\n\nfunction usersLookup(screen_name) {\n  var service = getTwitterService();\n  if(service.hasAccess()) {\n    var url      = API_USER_LOOKUP + \"?screen_name=\" + screen_name;\n    var response = service.fetch(url);\n    var tweets   = JSON.parse(response.getContentText());\n    return tweets[0]\n  } else {\n    var authorizationUrl = service.authorize();\n    Logger.log(\"Please visit the following URL and then re-run the script: \" + authorizationUrl);\n  }\n}\n\n/* \n * Decreasing 64-bit Tweet ID\n */\nfunction decStrNum(n) {\n  n          = n.toString(); \n  var result = n; \n  var i      = n.length - 1; \n  while(i > -1) { \n    if(n[i] === \"0\") {\n      result = result.substring(0, i) + \"9\" + result.substring(i + 1); \n      i --; \n    } else { \n      result = result.substring(0, i) + (parseInt(n[i], 10) -1).toString() + result.substring(i + 1); \n      return result; \n    }\n  } \n  return result; \n}\n\nfunction onOpen() {\n  var ss = SpreadsheetApp.getActiveSpreadsheet();\n  var menuEntries = [\n    {name: \"Tweet\u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\", functionName: \"getAllTweets\"}\n  ];\n  ss.addMenu(\"\u30b9\u30af\u30ea\u30d7\u30c8\",menuEntries);\n}\n```\n\n# \u30a2\u30a6\u30c8\u30d7\u30c3\u30c8\n\n<img width=\"1240\" alt=\"\u30b9\u30af\u30ea\u30fc\u30f3\u30b7\u30e7\u30c3\u30c8 2016-10-01 19.38.56.png\" src=\"https://qiita-image-store.s3.amazonaws.com/0/7086/9f998aeb-7e05-e86c-3ed6-d54441de29d5.png\">\n\n"}