{"context": "\n\n\u306f\u3058\u3081\u306b\n\u672c\u8a18\u4e8b\u3067\u306f\u3001AWS-CLI\u306b\u3088\u308bAMI\u4f5c\u6210\u65b9\u6cd5\u3068\u524a\u9664\u65b9\u6cd5\u306b\u3064\u3044\u3066\u8a18\u8ff0\u3057\u307e\u3059\u3002\n\u307e\u305f\u3001Jenkins\u3068Redmine\u3092\u4f7f\u7528\u3057\u305fAMI\u4f5c\u6210\u30fb\u524a\u9664\u306e\u81ea\u52d5\u5316\u306e\u5b9f\u73fe\u4f8b\u3082\u5408\u308f\u305b\u3066\u8a18\u8ff0\u3057\u307e\u3059\u3002\n\n\u5b9f\u73fe\u30a4\u30e1\u30fc\u30b8\n\u30c1\u30b1\u30c3\u30c8\u8d77\u7968\uff08Redmine\uff09\u2192\u30c1\u30b1\u30c3\u30c8\u5185\u5bb9\u53d6\u5f97\uff08Jenkins\uff09\u2192\u53d6\u5f97\u5185\u5bb9\u306b\u5408\u308f\u305b\u3066AWS-CLI\u5b9f\u884c\uff08Jenkins\uff09\u2192\u8d77\u7968\n\u30c1\u30b1\u30c3\u30c8\u66f4\u65b0\uff08Jenkins,Redmine\uff09\u203b\n\u203bAWS-CLI\u5b9f\u884c\u7d50\u679c\u3092\u8d77\u7968\u3055\u308c\u305f\u30c1\u30b1\u30c3\u30c8\u306b\u5bfe\u3057\u3066\u66f4\u65b0\u3057\u307e\u3059\u3002\uff08AMIID\u3084\u30c1\u30b1\u30c3\u30c8\u30b9\u30c6\u30fc\u30bf\u30b9\u3092\u66f4\u65b0\uff09\n\nAMI\u4f5c\u6210\n\n\u30b3\u30de\u30f3\u30c9\n\nAMI\u4f5c\u6210\naws ec2 create-image --instance-id EC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9ID --name \"\u4efb\u610f\u306eAMI\u540d\" --reboot\n\n\n\n\u8aac\u660e\n--instanceid\uff1aAMI\u306e\u5143\u3068\u306a\u308bEC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9ID\u3092\u6307\u5b9a\u3057\u3066\u304f\u3060\u3055\u3044\u3002\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9ID\u306fAWS\u30b3\u30f3\u30bd\u30fc\u30eb\u307e\u305f\u306fAWS-CLI\u3060\u3068describe-instances\u3067\u53c2\u7167\u3067\u304d\u307e\u3059\u3002\n--name\uff1a\u4f5c\u6210\u3059\u308bAMI\u306e\u540d\u524d\u3092\u6307\u5b9a\u3057\u307e\u3059\u3002\u6587\u5b57\u306e\u7bc4\u56f2\u3067\u3059\u304c\u3001ASCII\u30b3\u30fc\u30c9\u307e\u3067\u3057\u304b\u5bfe\u5fdc\u3055\u308c\u3066\u3044\u306a\u304b\u3063\u305f\u6c17\u304c\u3057\u307e\u3059\u3002\u66d6\u6627\u3067\u3059\u307f\u307e\u305b\u3093\u2026\n--reboot/--no reboot\uff1aAMI\u4f5c\u6210\u6642\u306b\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u518d\u8d77\u52d5\u3059\u308b\u304b\u3092\u6307\u5b9a\u3057\u307e\u3059\u3002--no reboot\u3067\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u304c\u7a3c\u50cd\u4e2d\u306bAMI\u3092\u4f5c\u6210\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\u305f\u3060\u3057\u3001\u516c\u5f0f\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u306b\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u8a18\u8f09\u3055\u308c\u3066\u3044\u307e\u3059\u3002\u53ef\u80fd\u306a\u9650\u308a--reboot\u3092\u6307\u5b9a\u3057\u3066\u3001\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3068AMI\u304c\u540c\u3058\u72b6\u614b\u3067\u3042\u308b\u3053\u3068\u3092\u62c5\u4fdd\u3057\u305f\u307b\u3046\u304c\u826f\u3044\u3068\u601d\u3044\u307e\u3059\u3002\n[No reboot] \u3092\u9078\u629e\u3057\u305f\u5834\u5408\u3001Amazon \u3067\u306f\u4f5c\u6210\u3055\u308c\u305f\u30a4\u30e1\u30fc\u30b8\u306e\u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0\u306e\u6574\u5408\u6027\u3092\u4fdd\u8a3c\u3067\u304d\u307e\u305b\u3093\u3002\n\n\nAMI\u524a\u9664\n\n\u30b3\u30de\u30f3\u30c9\n\nAMI\u524a\u9664\naws ec2 deregister-image --image-id \u524a\u9664\u3057\u305f\u3044AMIID\n\n\n\nSnapShot\u524a\u9664\naws ec2 delete-snapshot --snapshot-id AMI\u306b\u7d10\u3065\u304fSnapShotID\u3092\u6307\u5b9a\n\n\n\n\u8aac\u660e\n--image-id\uff1a\u524a\u9664\u3057\u305f\u3044AMIID\u3092\u6307\u5b9a\u3057\u307e\u3059\u3002\nSnapShot\u524a\u9664\uff1aAMI\u306b\u7d10\u3065\u304fSnapShot\u3092\u524a\u9664\u3057\u306a\u3044\u9650\u308a\u3001\u8ab2\u91d1\u3055\u308c\u307e\u3059\u3002\n\n\u5b9f\u88c5\u4f8b\n\nJenkins\u5074\uff08\u30b7\u30a7\u30eb\u306e\u5b9f\u884c\uff09\n#!/bin/bash\n\n#JSON\u5f62\u5f0f\u3067\u30c1\u30b1\u30c3\u30c8\u60c5\u5831\u3092\u53d6\u5f97(\u7d42\u4e86\u30c1\u30b1\u30c3\u30c8\u3092\u542b\u3081\u3066\u53d6\u5f97)\nJSON=$(curl -v -H \"Content-Type: application/json\" -X GET --data-binary \"@issue.json\" -H \"X-Redmine-API-Key: RedmineAPI\u30ad\u30fc\u3092\u3053\u3053\u306b\u6307\u5b9a\" http://RedmineURL\u3092\u3053\u3053\u306b\u6307\u5b9a/issues.json?status_id=%2a)\n\n#\u30c1\u30b1\u30c3\u30c8ID\u53d6\u5f97\nTicketId=$(echo ${JSON} | jq '.issues[].id')\n#\u30c1\u30b1\u30c3\u30c8\u30b9\u30c6\u30fc\u30bf\u30b9\u53d6\u5f97\nTicketStatus=$(echo ${JSON} | jq '.issues[].status | .id')\n#\u30c1\u30b1\u30c3\u30c8\u9032\u6357\u7387\u53d6\u5f97\nTicketDoneRatio=$(echo ${JSON} | jq '.issues[].done_ratio')\n#\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9ID\u53d6\u5f97\nInstanceId=$(echo ${JSON} | jq '.issues[].description' | sed -e 's/\\\\r\\\\n/,/g' | awk -F, '{print $1}' | awk -F: '{print $2}')\n#AMI\u540d\u53d6\u5f97\nAmiName=$(echo ${JSON} | jq '.issues[].subject' | sed -e 's/[\\\" ,]//g')\n\n#\u53d6\u5f97\u3057\u305f\u5024\u3092\u914d\u5217\u5316\nTICKET_ID=(`echo ${TicketId}`)\nTICKET_STATUS=(`echo ${TicketStatus}`)\nTICKET_DONE_RATIO=(`echo ${TicketDoneRatio}`)\nINSTANCE_ID=(`echo ${InstanceId}`)\nAMI_NAME=(`echo ${AmiName}`)\n\n\nCOUNT=0\nfor rec in ${TICKET_ID[@]}\ndo\n    #\u30c1\u30b1\u30c3\u30c8\u30b9\u30c6\u30fc\u30bf\u30b9\u304c\u65b0\u898f\u306e\u30c1\u30b1\u30c3\u30c8\u3092\u5bfe\u8c61\u3068\u3059\u308b\n    if [ ${TICKET_STATUS[$COUNT]} -eq \"1\" ]; then\n    #\u30c1\u30b1\u30c3\u30c8\u30b9\u30c6\u30fc\u30bf\u30b9\u304c\u65b0\u898f\u306e\u307fAMI\u4f5c\u6210\n        #AMI\u4f5c\u6210\n        RET=$(aws ec2 create-image --instance-id ${INSTANCE_ID[$COUNT]} --name \"${AMI_NAME[$COUNT]}\" --reboot)\n\n        #\u4f5c\u6210\u3057\u305fAMIID\u3092\u53d6\u5f97\n        AmiId=$(echo ${RET} | python -m json.tool | grep \"ImageId\" | awk -F: '{print $2}' | sed -e 's/[\\\" ,]//g')\n\n        #AMI\u306e\u5143\u3068\u306a\u308b\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u30bf\u30b0\u60c5\u5831\u53d6\u5f97\n        NameTag=$(aws ec2 describe-instances --instance-ids ${INSTANCE_ID[$COUNT]} | jq '.Reservations[].Instances[] | .Tags[] | select(.Key==\"Name\").Value')\n        ApplicationTag=$(aws ec2 describe-instances --instance-ids ${INSTANCE_ID[$COUNT]} | jq '.Reservations[].Instances[] | .Tags[] | select(.Key==\"Application\").Value')\n        CostcenterTag=$(aws ec2 describe-instances --instance-ids ${INSTANCE_ID[$COUNT]} | jq '.Reservations[].Instances[] | .Tags[] | select(.Key==\"Costcenter\").Value')\n        OwnerTag=$(aws ec2 describe-instances --instance-ids ${INSTANCE_ID[$COUNT]} | jq '.Reservations[].Instances[] | .Tags[] | select(.Key==\"Owner\").Value')\n\n\n        #\u4f5c\u6210\u3057\u305fAMI\u306b\u30bf\u30b0\u3092\u4ed8\u4e0e\n        aws ec2 create-tags --resources ${AmiId} --tags Key=Name,Value=${NameTag}\n        aws ec2 create-tags --resources ${AmiId} --tags Key=Application,Value=${ApplicationTag}\n        aws ec2 create-tags --resources ${AmiId} --tags Key=Costcenter,Value=${CostcenterTag}\n        aws ec2 create-tags --resources ${AmiId} --tags Key=Owner,Value=${OwnerTag}\n        #\u30c1\u30b1\u30c3\u30c8ID\u3092\u30bf\u30b0\u306b\u8ffd\u52a0\n        aws ec2 create-tags --resources ${AmiId} --tags Key=TicketId,Value=${TICKET_ID[$COUNT]}\n\n        #\u4f5c\u6210\u3057\u305fAMIID\u3092\u30c1\u30b1\u30c3\u30c8\u306e\u5c65\u6b74\u306b\u8ffd\u52a0\n        curl -v -H \"Content-Type: application/json\" -H \"X-Redmine-API-Key: RedmineAPI\u30ad\u30fc\u3092\u3053\u3053\u306b\u6307\u5b9a\" -X PUT -d '{\"issue\":{\"notes\":\"AmiId:'$AmiId'\"}}' http://RedmineURL\u3092\u3053\u3053\u306b\u6307\u5b9a/issues/${TICKET_ID[$COUNT]}.json\n\n        #\u30c1\u30b1\u30c3\u30c8\u30b9\u30c6\u30fc\u30bf\u30b9\u3092\"\u9032\u884c\u4e2d\"\u306b\u66f4\u65b0\n        curl --include http://RedmineURL\u3092\u3053\u3053\u306b\u6307\u5b9a/issues/${TICKET_ID[$COUNT]}.xml -X PUT -d '<issue><status_id>2</status_id></issue>' -H \"Content-Type: text/xml\" -H \"X-Redmine-API-Key: RedmineAPI\u30ad\u30fc\u3092\u3053\u3053\u306b\u6307\u5b9a\"\n\n    #\u30c1\u30b1\u30c3\u30c8\u30b9\u30c6\u30fc\u30bf\u30b9\u304c\u9032\u884c\u4e2d\u304b\u3064\u9032\u6357\u7387\u304c0%\u306e\u30c1\u30b1\u30c3\u30c8\u3092\u5bfe\u8c61\u3068\u3059\u308b        \n    elif [ ${TICKET_STATUS[$COUNT]} -eq \"5\" ] && [ ${TICKET_DONE_RATIO[$COUNT]} -eq 0 ]; then\n        #\u30c1\u30b1\u30c3\u30c8\u30b9\u30c6\u30fc\u30bf\u30b9\u304c\"\u7d42\u4e86\"\u304b\u3064\u9032\u6357\u7387\u304c\"0%\"\u306e\u5834\u5408\u3001AMI\u524a\u9664\n\n        #AMI\u60c5\u5831\u53d6\u5f97\n        AmiList=$(aws ec2 describe-tags --filters \"Name=resource-type,Values=image\" \"Name=key,Values=TicketId\" \"Name=value,Values=${TICKET_ID[$COUNT]}\")\n\n        #AMIID\u53d6\u5f97\n        DeleteAmiId=$(echo ${AmiList} | jq '.Tags[].ResourceId' | sed -e 's/[\\\" ,]//g')\n\n        #SnapShot\u60c5\u5831\u53d6\u5f97\n        SnapShotId=$(aws ec2 describe-images --image-ids $DeleteAmiId | jq '.Images[].BlockDeviceMappings[].Ebs | .SnapshotId' | sed -e 's/[\\\" ,]//g')\n        #\u53d6\u5f97\u3057\u305f\u5024\u3092\u914d\u5217\u5316\n        SNAPSHOT_ID=(`echo ${SnapShotId}`)\n\n        #AMI\u524a\u9664\n        aws ec2 deregister-image --image-id $DeleteAmiId\n\n        #\u30b9\u30ca\u30c3\u30d7\u30b7\u30e7\u30c3\u30c8\u524a\u9664\n        #INT=0\n        for item in ${SNAPSHOT_ID[@]}\n        do\n            aws ec2 delete-snapshot --snapshot-id ${SNAPSHOT_ID[$INT]}\n            INT=`expr $INT + 1`\n        done\n\n\n        #\u9032\u6357\u7387\u3092\"100%\"\u306b\u66f4\u65b0\n        curl --include http://RedmineURL\u3092\u3053\u3053\u306b\u6307\u5b9a/issues/${TICKET_ID[$COUNT]}.xml -X PUT -d '<issue><done_ratio>100</done_ratio></issue>' -H \"Content-Type: text/xml\" -H \"X-Redmine-API-Key: RedmineAPI\u30ad\u30fc\u3092\u3053\u3053\u306b\u6307\u5b9a\"\n\n        #\u524a\u9664\u3057\u305f\u65e8\u3092\u30c1\u30b1\u30c3\u30c8\u306e\u5c65\u6b74\u306b\u8ffd\u52a0\n        curl --include http://RedmineURL\u3092\u3053\u3053\u306b\u6307\u5b9a/issues/${TICKET_ID[$COUNT]}.xml -X PUT -d \"<issue><notes>deleted the AMI.</notes></issue>\" -H \"Content-Type: text/xml\" -H \"X-Redmine-API-Key: RedmineAPI\u30ad\u30fc\u3092\u3053\u3053\u306b\u6307\u5b9a\"\n    fi\n\n    COUNT=`expr $COUNT + 1`\ndone\n\n\nRedmine\u5074\n\n\u30c1\u30b1\u30c3\u30c8\u8a18\u8ff0\u30eb\u30fc\u30eb\uff08\u30c1\u30b1\u30c3\u30c8\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u3092\u6d3b\u7528\uff09\n\u984c\u540d\uff1a\u4f5c\u6210\u3057\u305f\u3044AMI\u540d\u3092\u5165\u529b\n\u8aac\u660e\uff1a\nInstanceId:i-XXXXXXXX\uff08\u4f5c\u6210\u3057\u305f\u3044AMI\u306e\u5143\u3068\u306a\u308bEC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9ID\u3092\u5165\u529b\uff09\nDescription:\u958b\u767a\u74b0\u5883\u306eAMI\u3067\u3059\u3002\uff08AMI\u306e\u60c5\u5831\u3092\u5165\u529b\u203b\u5165\u529b\u5185\u5bb9\u306f\u81ea\u7531\u3067\u3059\uff09\n# \u306f\u3058\u3081\u306b\n\u672c\u8a18\u4e8b\u3067\u306f\u3001AWS-CLI\u306b\u3088\u308bAMI\u4f5c\u6210\u65b9\u6cd5\u3068\u524a\u9664\u65b9\u6cd5\u306b\u3064\u3044\u3066\u8a18\u8ff0\u3057\u307e\u3059\u3002\n\u307e\u305f\u3001Jenkins\u3068Redmine\u3092\u4f7f\u7528\u3057\u305fAMI\u4f5c\u6210\u30fb\u524a\u9664\u306e\u81ea\u52d5\u5316\u306e\u5b9f\u73fe\u4f8b\u3082\u5408\u308f\u305b\u3066\u8a18\u8ff0\u3057\u307e\u3059\u3002\n\n# \u5b9f\u73fe\u30a4\u30e1\u30fc\u30b8\n\u30c1\u30b1\u30c3\u30c8\u8d77\u7968\uff08Redmine\uff09\u2192\u30c1\u30b1\u30c3\u30c8\u5185\u5bb9\u53d6\u5f97\uff08Jenkins\uff09\u2192\u53d6\u5f97\u5185\u5bb9\u306b\u5408\u308f\u305b\u3066AWS-CLI\u5b9f\u884c\uff08Jenkins\uff09\u2192\u8d77\u7968\n\u30c1\u30b1\u30c3\u30c8\u66f4\u65b0\uff08Jenkins,Redmine\uff09\u203b\n\n\u203bAWS-CLI\u5b9f\u884c\u7d50\u679c\u3092\u8d77\u7968\u3055\u308c\u305f\u30c1\u30b1\u30c3\u30c8\u306b\u5bfe\u3057\u3066\u66f4\u65b0\u3057\u307e\u3059\u3002\uff08AMIID\u3084\u30c1\u30b1\u30c3\u30c8\u30b9\u30c6\u30fc\u30bf\u30b9\u3092\u66f4\u65b0\uff09\n\n# AMI\u4f5c\u6210\n### \u30b3\u30de\u30f3\u30c9\n```bash:AMI\u4f5c\u6210\naws ec2 create-image --instance-id EC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9ID --name \"\u4efb\u610f\u306eAMI\u540d\" --reboot\n```\n\n### \u8aac\u660e\n*--instanceid*\uff1aAMI\u306e\u5143\u3068\u306a\u308bEC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9ID\u3092\u6307\u5b9a\u3057\u3066\u304f\u3060\u3055\u3044\u3002\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9ID\u306fAWS\u30b3\u30f3\u30bd\u30fc\u30eb\u307e\u305f\u306fAWS-CLI\u3060\u3068describe-instances\u3067\u53c2\u7167\u3067\u304d\u307e\u3059\u3002\n*--name*\uff1a\u4f5c\u6210\u3059\u308bAMI\u306e\u540d\u524d\u3092\u6307\u5b9a\u3057\u307e\u3059\u3002\u6587\u5b57\u306e\u7bc4\u56f2\u3067\u3059\u304c\u3001ASCII\u30b3\u30fc\u30c9\u307e\u3067\u3057\u304b\u5bfe\u5fdc\u3055\u308c\u3066\u3044\u306a\u304b\u3063\u305f\u6c17\u304c\u3057\u307e\u3059\u3002\u66d6\u6627\u3067\u3059\u307f\u307e\u305b\u3093\u2026\n*--reboot/--no reboot*\uff1aAMI\u4f5c\u6210\u6642\u306b\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3092\u518d\u8d77\u52d5\u3059\u308b\u304b\u3092\u6307\u5b9a\u3057\u307e\u3059\u3002--no reboot\u3067\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u304c\u7a3c\u50cd\u4e2d\u306bAMI\u3092\u4f5c\u6210\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\u305f\u3060\u3057\u3001\u516c\u5f0f\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u306b\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u8a18\u8f09\u3055\u308c\u3066\u3044\u307e\u3059\u3002\u53ef\u80fd\u306a\u9650\u308a--reboot\u3092\u6307\u5b9a\u3057\u3066\u3001\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3068AMI\u304c\u540c\u3058\u72b6\u614b\u3067\u3042\u308b\u3053\u3068\u3092\u62c5\u4fdd\u3057\u305f\u307b\u3046\u304c\u826f\u3044\u3068\u601d\u3044\u307e\u3059\u3002\n\n```\n[No reboot] \u3092\u9078\u629e\u3057\u305f\u5834\u5408\u3001Amazon \u3067\u306f\u4f5c\u6210\u3055\u308c\u305f\u30a4\u30e1\u30fc\u30b8\u306e\u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0\u306e\u6574\u5408\u6027\u3092\u4fdd\u8a3c\u3067\u304d\u307e\u305b\u3093\u3002\n```\n\n# AMI\u524a\u9664\n### \u30b3\u30de\u30f3\u30c9\n```bash:AMI\u524a\u9664\naws ec2 deregister-image --image-id \u524a\u9664\u3057\u305f\u3044AMIID\n```\n```bash:SnapShot\u524a\u9664\naws ec2 delete-snapshot --snapshot-id AMI\u306b\u7d10\u3065\u304fSnapShotID\u3092\u6307\u5b9a\n```\n\n### \u8aac\u660e\n*--image-id*\uff1a\u524a\u9664\u3057\u305f\u3044AMIID\u3092\u6307\u5b9a\u3057\u307e\u3059\u3002\n*SnapShot\u524a\u9664*\uff1aAMI\u306b\u7d10\u3065\u304fSnapShot\u3092\u524a\u9664\u3057\u306a\u3044\u9650\u308a\u3001\u8ab2\u91d1\u3055\u308c\u307e\u3059\u3002\n\n# \u5b9f\u88c5\u4f8b\n## Jenkins\u5074\uff08\u30b7\u30a7\u30eb\u306e\u5b9f\u884c\uff09\n```bash\n#!/bin/bash\n\n#JSON\u5f62\u5f0f\u3067\u30c1\u30b1\u30c3\u30c8\u60c5\u5831\u3092\u53d6\u5f97(\u7d42\u4e86\u30c1\u30b1\u30c3\u30c8\u3092\u542b\u3081\u3066\u53d6\u5f97)\nJSON=$(curl -v -H \"Content-Type: application/json\" -X GET --data-binary \"@issue.json\" -H \"X-Redmine-API-Key: RedmineAPI\u30ad\u30fc\u3092\u3053\u3053\u306b\u6307\u5b9a\" http://RedmineURL\u3092\u3053\u3053\u306b\u6307\u5b9a/issues.json?status_id=%2a)\n\n#\u30c1\u30b1\u30c3\u30c8ID\u53d6\u5f97\nTicketId=$(echo ${JSON} | jq '.issues[].id')\n#\u30c1\u30b1\u30c3\u30c8\u30b9\u30c6\u30fc\u30bf\u30b9\u53d6\u5f97\nTicketStatus=$(echo ${JSON} | jq '.issues[].status | .id')\n#\u30c1\u30b1\u30c3\u30c8\u9032\u6357\u7387\u53d6\u5f97\nTicketDoneRatio=$(echo ${JSON} | jq '.issues[].done_ratio')\n#\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9ID\u53d6\u5f97\nInstanceId=$(echo ${JSON} | jq '.issues[].description' | sed -e 's/\\\\r\\\\n/,/g' | awk -F, '{print $1}' | awk -F: '{print $2}')\n#AMI\u540d\u53d6\u5f97\nAmiName=$(echo ${JSON} | jq '.issues[].subject' | sed -e 's/[\\\" ,]//g')\n\n#\u53d6\u5f97\u3057\u305f\u5024\u3092\u914d\u5217\u5316\nTICKET_ID=(`echo ${TicketId}`)\nTICKET_STATUS=(`echo ${TicketStatus}`)\nTICKET_DONE_RATIO=(`echo ${TicketDoneRatio}`)\nINSTANCE_ID=(`echo ${InstanceId}`)\nAMI_NAME=(`echo ${AmiName}`)\n\n\nCOUNT=0\nfor rec in ${TICKET_ID[@]}\ndo\n    #\u30c1\u30b1\u30c3\u30c8\u30b9\u30c6\u30fc\u30bf\u30b9\u304c\u65b0\u898f\u306e\u30c1\u30b1\u30c3\u30c8\u3092\u5bfe\u8c61\u3068\u3059\u308b\n\tif [ ${TICKET_STATUS[$COUNT]} -eq \"1\" ]; then\n    #\u30c1\u30b1\u30c3\u30c8\u30b9\u30c6\u30fc\u30bf\u30b9\u304c\u65b0\u898f\u306e\u307fAMI\u4f5c\u6210\n    \t#AMI\u4f5c\u6210\n    \tRET=$(aws ec2 create-image --instance-id ${INSTANCE_ID[$COUNT]} --name \"${AMI_NAME[$COUNT]}\" --reboot)\n        \n        #\u4f5c\u6210\u3057\u305fAMIID\u3092\u53d6\u5f97\n    \tAmiId=$(echo ${RET} | python -m json.tool | grep \"ImageId\" | awk -F: '{print $2}' | sed -e 's/[\\\" ,]//g')\n        \n        #AMI\u306e\u5143\u3068\u306a\u308b\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306e\u30bf\u30b0\u60c5\u5831\u53d6\u5f97\n        NameTag=$(aws ec2 describe-instances --instance-ids ${INSTANCE_ID[$COUNT]} | jq '.Reservations[].Instances[] | .Tags[] | select(.Key==\"Name\").Value')\n        ApplicationTag=$(aws ec2 describe-instances --instance-ids ${INSTANCE_ID[$COUNT]} | jq '.Reservations[].Instances[] | .Tags[] | select(.Key==\"Application\").Value')\n        CostcenterTag=$(aws ec2 describe-instances --instance-ids ${INSTANCE_ID[$COUNT]} | jq '.Reservations[].Instances[] | .Tags[] | select(.Key==\"Costcenter\").Value')\n        OwnerTag=$(aws ec2 describe-instances --instance-ids ${INSTANCE_ID[$COUNT]} | jq '.Reservations[].Instances[] | .Tags[] | select(.Key==\"Owner\").Value')\n        \n        \n        #\u4f5c\u6210\u3057\u305fAMI\u306b\u30bf\u30b0\u3092\u4ed8\u4e0e\n        aws ec2 create-tags --resources ${AmiId} --tags Key=Name,Value=${NameTag}\n        aws ec2 create-tags --resources ${AmiId} --tags Key=Application,Value=${ApplicationTag}\n        aws ec2 create-tags --resources ${AmiId} --tags Key=Costcenter,Value=${CostcenterTag}\n        aws ec2 create-tags --resources ${AmiId} --tags Key=Owner,Value=${OwnerTag}\n        #\u30c1\u30b1\u30c3\u30c8ID\u3092\u30bf\u30b0\u306b\u8ffd\u52a0\n        aws ec2 create-tags --resources ${AmiId} --tags Key=TicketId,Value=${TICKET_ID[$COUNT]}\n        \n        #\u4f5c\u6210\u3057\u305fAMIID\u3092\u30c1\u30b1\u30c3\u30c8\u306e\u5c65\u6b74\u306b\u8ffd\u52a0\n        curl -v -H \"Content-Type: application/json\" -H \"X-Redmine-API-Key: RedmineAPI\u30ad\u30fc\u3092\u3053\u3053\u306b\u6307\u5b9a\" -X PUT -d '{\"issue\":{\"notes\":\"AmiId:'$AmiId'\"}}' http://RedmineURL\u3092\u3053\u3053\u306b\u6307\u5b9a/issues/${TICKET_ID[$COUNT]}.json\n        \n    \t#\u30c1\u30b1\u30c3\u30c8\u30b9\u30c6\u30fc\u30bf\u30b9\u3092\"\u9032\u884c\u4e2d\"\u306b\u66f4\u65b0\n        curl --include http://RedmineURL\u3092\u3053\u3053\u306b\u6307\u5b9a/issues/${TICKET_ID[$COUNT]}.xml -X PUT -d '<issue><status_id>2</status_id></issue>' -H \"Content-Type: text/xml\" -H \"X-Redmine-API-Key: RedmineAPI\u30ad\u30fc\u3092\u3053\u3053\u306b\u6307\u5b9a\"\n\n    #\u30c1\u30b1\u30c3\u30c8\u30b9\u30c6\u30fc\u30bf\u30b9\u304c\u9032\u884c\u4e2d\u304b\u3064\u9032\u6357\u7387\u304c0%\u306e\u30c1\u30b1\u30c3\u30c8\u3092\u5bfe\u8c61\u3068\u3059\u308b        \n    elif [ ${TICKET_STATUS[$COUNT]} -eq \"5\" ] && [ ${TICKET_DONE_RATIO[$COUNT]} -eq 0 ]; then\n        #\u30c1\u30b1\u30c3\u30c8\u30b9\u30c6\u30fc\u30bf\u30b9\u304c\"\u7d42\u4e86\"\u304b\u3064\u9032\u6357\u7387\u304c\"0%\"\u306e\u5834\u5408\u3001AMI\u524a\u9664\n        \n        #AMI\u60c5\u5831\u53d6\u5f97\n        AmiList=$(aws ec2 describe-tags --filters \"Name=resource-type,Values=image\" \"Name=key,Values=TicketId\" \"Name=value,Values=${TICKET_ID[$COUNT]}\")\n        \n        #AMIID\u53d6\u5f97\n        DeleteAmiId=$(echo ${AmiList} | jq '.Tags[].ResourceId' | sed -e 's/[\\\" ,]//g')\n        \n\t\t#SnapShot\u60c5\u5831\u53d6\u5f97\n        SnapShotId=$(aws ec2 describe-images --image-ids $DeleteAmiId | jq '.Images[].BlockDeviceMappings[].Ebs | .SnapshotId' | sed -e 's/[\\\" ,]//g')\n        #\u53d6\u5f97\u3057\u305f\u5024\u3092\u914d\u5217\u5316\n\t\tSNAPSHOT_ID=(`echo ${SnapShotId}`)\n\n        #AMI\u524a\u9664\n\t\taws ec2 deregister-image --image-id $DeleteAmiId\n        \n        #\u30b9\u30ca\u30c3\u30d7\u30b7\u30e7\u30c3\u30c8\u524a\u9664\n        #INT=0\n        for item in ${SNAPSHOT_ID[@]}\n        do\n        \taws ec2 delete-snapshot --snapshot-id ${SNAPSHOT_ID[$INT]}\n            INT=`expr $INT + 1`\n        done\n        \n        \n        #\u9032\u6357\u7387\u3092\"100%\"\u306b\u66f4\u65b0\n        curl --include http://RedmineURL\u3092\u3053\u3053\u306b\u6307\u5b9a/issues/${TICKET_ID[$COUNT]}.xml -X PUT -d '<issue><done_ratio>100</done_ratio></issue>' -H \"Content-Type: text/xml\" -H \"X-Redmine-API-Key: RedmineAPI\u30ad\u30fc\u3092\u3053\u3053\u306b\u6307\u5b9a\"\n        \n        #\u524a\u9664\u3057\u305f\u65e8\u3092\u30c1\u30b1\u30c3\u30c8\u306e\u5c65\u6b74\u306b\u8ffd\u52a0\n        curl --include http://RedmineURL\u3092\u3053\u3053\u306b\u6307\u5b9a/issues/${TICKET_ID[$COUNT]}.xml -X PUT -d \"<issue><notes>deleted the AMI.</notes></issue>\" -H \"Content-Type: text/xml\" -H \"X-Redmine-API-Key: RedmineAPI\u30ad\u30fc\u3092\u3053\u3053\u306b\u6307\u5b9a\"\n    fi\n    \n    COUNT=`expr $COUNT + 1`\ndone\n```\n\n\n## Redmine\u5074\n###\u30c1\u30b1\u30c3\u30c8\u8a18\u8ff0\u30eb\u30fc\u30eb\uff08\u30c1\u30b1\u30c3\u30c8\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u3092\u6d3b\u7528\uff09\n\u984c\u540d\uff1a\u4f5c\u6210\u3057\u305f\u3044AMI\u540d\u3092\u5165\u529b\n\u8aac\u660e\uff1a\nInstanceId:i-XXXXXXXX\uff08\u4f5c\u6210\u3057\u305f\u3044AMI\u306e\u5143\u3068\u306a\u308bEC2\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9ID\u3092\u5165\u529b\uff09\nDescription:\u958b\u767a\u74b0\u5883\u306eAMI\u3067\u3059\u3002\uff08AMI\u306e\u60c5\u5831\u3092\u5165\u529b\u203b\u5165\u529b\u5185\u5bb9\u306f\u81ea\u7531\u3067\u3059\uff09\n\n\n\n", "tags": ["AWS", "aws-cli", "Redmine", "Jenkins", "JSON"]}